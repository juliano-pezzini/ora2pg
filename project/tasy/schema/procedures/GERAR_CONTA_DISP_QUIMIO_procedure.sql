-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_conta_disp_quimio (nr_seq_ordem_p bigint, nr_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
cd_setor_atendimento_w	integer;
cd_setor_atendimento_ww	integer;
dt_entrada_unidade_w	timestamp;
cd_unidade_medida_w	varchar(30);
cd_estab_w		bigint;
cd_material_w		bigint;
cd_material_ww		bigint;
qt_material_conta_w	dispensacao_quimioterapia.qt_material_conta%type;
nr_seq_atepacu_w	bigint;
cd_local_estoque_w	smallint;
cd_local_estoque_ww	smallint;
nr_seq_cabine_w		bigint;
cd_estabelecimento_w	bigint;
cd_estabelecimento_ww	bigint;
dt_inicio_preparo_w	timestamp;
nr_doc_convenio_w	varchar(20);
cd_convenio_w		integer;
cd_senha_w		varchar(20);
dt_inicio_real_w	timestamp;
ie_tipo_guia_w		varchar(2);
cd_categoria_w		varchar(10);
ie_generico_w		varchar(1);
nr_prescricao_w		bigint;
nr_seq_prescricao_w	bigint;
cd_motivo_baixa_w	smallint;
cd_material_exec_w	integer;
ie_consiste_estab_w	varchar(1);
ie_possui_nota_w	varchar(1);
ds_erro_w			varchar(2000) := null;
qt_atendimento_fechado_w bigint;
ie_baixa_Mat_kit_w	varchar(1);
ds_entrada_w		varchar(4000);
ds_log_w		varchar(4000);
ds_erro_log_w		varchar(4000);
ie_via_aplicacao_w	varchar(5);
ie_lanca_conta_w    varchar(5);
nr_seq_lote_fornec_w bigint;

C01 CURSOR FOR
	SELECT	cd_material,
		qt_material_conta,
		nr_prescricao,
		nr_seq_prescricao,
		cd_material_exec,
		ie_via_aplicacao
	from	dispensacao_quimioterapia
	where	nr_seq_ordem = nr_seq_ordem_p
	and	((coalesce(get_if_patient_medic(nr_seq_ordem_p, cd_material_exec)::text, '') = '') or (get_if_patient_medic(nr_seq_ordem_p, cd_material_exec) <> cd_material_exec))
	
union

	SELECT	a.cd_material,
		a.qt_material qt_material_conta,
		a.nr_prescricao,
		a.nr_sequencia,
		a.cd_material cd_material_exec,
		a.ie_via_aplicacao
	from	material b,
		prescr_material a
	where	a.cd_material = b.cd_material
	and	a.nr_prescricao_original = (select max(c.nr_prescricao)
				from	can_ordem_prod c
				where 	c.nr_sequencia = nr_seq_ordem_p)
	and	a.nr_seq_mat_disp in (select  d.nr_seq_prescricao
				from	can_ordem_item_prescr d
				where  	d.nr_seq_ordem = nr_seq_ordem_p)
	and 	a.ie_agrupador = 2	
	and 	a.cd_motivo_baixa = 0
	
union

	select	a.cd_material,
		a.qt_material qt_material_conta,
		a.nr_prescricao,
		a.nr_sequencia,
		a.cd_material cd_material_exec,
		a.ie_via_aplicacao
	from	material b, 
		prescr_material a
	where	a.cd_material = b.cd_material
	and	a.nr_prescricao = (select max(c.nr_prescricao)
				from	can_ordem_prod c
				where 	c.nr_sequencia = nr_seq_ordem_p)
	and	a.nr_seq_kit  in (select  d.nr_seq_prescricao
				from	can_ordem_item_prescr d
				where  	d.nr_seq_ordem = nr_seq_ordem_p)
	and 	a.ie_agrupador = 2	
	and 	a.cd_motivo_baixa = 0
	and		coalesce(ie_baixa_Mat_kit_w,'S') = 'S'
	order by cd_material;

c02 CURSOR FOR
SELECT	b.cd_material,
	b.cd_estabelecimento
from	prescr_medica c,
	can_ordem_prod_mat b,
	can_ordem_prod a
where	a.nr_sequencia	= nr_seq_ordem_p
and	a.nr_prescricao	= c.nr_prescricao
and	a.nr_sequencia	= b.nr_seq_ordem
and 	coalesce(a.ie_medic_paciente,'N') = 'N';
	

BEGIN
ds_entrada_w := '1';
cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;

ie_baixa_Mat_kit_w := Obter_Param_Usuario(3130, 451, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_baixa_Mat_kit_w);
ie_lanca_conta_w := Obter_Param_Usuario(3130, 172, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_lanca_conta_w);

select	count(*)
into STRICT	qt_atendimento_fechado_w
from	atendimento_paciente
where	nr_atendimento = nr_atendimento_p
and	(dt_fim_conta IS NOT NULL AND dt_fim_conta::text <> '')
and	coalesce(ie_trat_conta_rn::text, '') = '';

If (qt_atendimento_fechado_w > 0) then
	ds_entrada_w := substr(ds_entrada_w || ',2',1,4000);
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(205008);
End if;

ds_entrada_w := substr(ds_entrada_w || ',3',1,4000);
ds_entrada_w := substr(ds_entrada_w || ',4',1,4000);

open C01;
loop
fetch C01 into	
	cd_material_w,
	qt_material_conta_w,
	nr_prescricao_w,
	nr_seq_prescricao_w,
	cd_material_exec_w,
	ie_via_aplicacao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ds_entrada_w := substr(ds_entrada_w || ',5',1,4000);
	ie_generico_w := Obter_Param_Usuario(3130, 149, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_generico_w);
	ie_consiste_estab_w := Obter_Param_Usuario(3130, 305, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_consiste_estab_w);
	
	if (ie_consiste_estab_w = 'S') then
		open C02;
		loop
		fetch C02 into	
			cd_material_ww,
			cd_estabelecimento_ww;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			ds_entrada_w := substr(ds_entrada_w || ',6',1,4000);
			select	coalesce(max('S'),'N')
			into STRICT	ie_possui_nota_w
			from	transf_ordem_prod a,
				nota_fiscal b,
				nota_fiscal_item c
			where	b.nr_sequencia = c.nr_sequencia
			and	a.nr_ordem_compra = b.nr_ordem_compra
			and	a.nr_seq_ordem_prod = nr_seq_ordem_p
			and	substr(obter_se_nota_entrada_saida(b.nr_sequencia),1,1) = 'E'
			and 	cd_material = cd_material_ww;
			
			if (coalesce(ie_possui_nota_w,'N') = 'N') and (cd_estabelecimento_ww <> wheb_usuario_pck.get_cd_estabelecimento) then
				ds_entrada_w := substr(ds_entrada_w || ',7',1,4000);
				CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(175951);
			end if;
			end;
		end loop;
		close C02;
	end if;
	
	ds_entrada_w := substr(ds_entrada_w || ',8',1,4000);
	select	c.cd_local_estoque,
		b.nr_seq_cabine,
		a.cd_estabelecimento,
		a.dt_inicio_preparo
	into STRICT	cd_local_estoque_w,
		nr_seq_cabine_w,
		cd_estabelecimento_w,
		dt_inicio_preparo_w
	from	far_cabine_seg_biol c,
		far_etapa_producao b,
		can_ordem_prod a
	where	a.nr_sequencia	= nr_seq_ordem_p
	and	b.nr_sequencia	= a.nr_seq_etapa_prod
	and	b.nr_seq_cabine	= c.nr_sequencia;
	ds_entrada_w := substr(ds_entrada_w || ',9',1,4000);
	select	coalesce(max(c.cd_local_estoque),cd_local_estoque_w)
	into STRICT	cd_local_estoque_w
	from	transf_ordem_prod a,
		nota_fiscal b,
		nota_fiscal_item c
	where	b.nr_sequencia = c.nr_sequencia
	and	a.nr_ordem_compra = b.nr_ordem_compra
	and	a.nr_seq_ordem_prod = nr_seq_ordem_p
	and	substr(obter_se_nota_entrada_saida(b.nr_sequencia),1,1) = 'E'
	and 	cd_material = cd_material_w;
	ds_entrada_w := substr(ds_entrada_w || ',10',1,4000);
	
	select	obter_setor_atendimento(nr_atendimento_p)
	into STRICT	cd_setor_atendimento_w
	;
	ds_entrada_w := substr(ds_entrada_w || ',11',1,4000);
	SELECT * FROM obter_convenio_execucao(	nr_atendimento_p, clock_timestamp(), cd_convenio_w, cd_categoria_w, nr_doc_convenio_w, ie_tipo_guia_w, cd_senha_w) INTO STRICT cd_convenio_w, cd_categoria_w, nr_doc_convenio_w, ie_tipo_guia_w, cd_senha_w;
	ds_entrada_w := substr(ds_entrada_w || ',12',1,4000);

	select	nextval('material_atend_paciente_seq')
	into STRICT	nr_sequencia_w
	;
	ds_entrada_w := substr(ds_entrada_w || ',13',1,4000);

	select	substr(obter_dados_material_estab(cd_material,cd_estab_w,'UMS'),1,30) cd_unidade_medida_consumo
	into STRICT	cd_unidade_medida_w
	from	material
	where	cd_material = cd_material_w;
	ds_entrada_w := substr(ds_entrada_w || ',14',1,4000);
	select	coalesce(max(nr_seq_interno),0)
	into STRICT	nr_seq_atepacu_w
	from	atend_paciente_unidade
	where	nr_atendimento		= nr_atendimento_p
	and	cd_setor_atendimento	= cd_setor_atendimento_w;
	ds_entrada_w := substr(ds_entrada_w || ',15',1,4000);
	
	select	max(dt_entrada_unidade)
	into STRICT	dt_entrada_unidade_w
	from	atend_paciente_unidade
	where	nr_seq_interno	= nr_seq_atepacu_w;
	ds_entrada_w := substr(ds_entrada_w || ',16',1,4000);
	select	coalesce(max(cd_motivo_baixa),0)
	into STRICT	cd_motivo_baixa_w
	from	prescr_material
	where	nr_prescricao 		= nr_prescricao_w
	and	nr_sequencia		= nr_seq_prescricao_w;
	ds_entrada_w := substr(ds_entrada_w || ',17',1,4000);
	if (cd_motivo_baixa_w <> 0) then
		nr_seq_prescricao_w := null;
	end if;
	ds_entrada_w := substr(ds_entrada_w || ',18',1,4000);
	ds_erro_w := null;
			
	begin
	if (ie_lanca_conta_w = 'S') then

		select 	max(nr_seq_lote_fornec)
		into STRICT	nr_seq_lote_fornec_w
		from 	can_ordem_prod_mat
		where	nr_seq_ordem = nr_seq_ordem_p
		and	(nr_seq_lote_fornec IS NOT NULL AND nr_seq_lote_fornec::text <> '')
		and (cd_material = cd_material_w or cd_material = cd_material_exec_w);

		insert into material_atend_paciente(
			nr_sequencia,
			cd_material,
			dt_atendimento,
			cd_senha,
			cd_convenio,
			nr_doc_convenio,
			ie_tipo_guia,
			cd_categoria,
			cd_setor_atendimento,
			cd_material_exec,
			qt_executada,
			vl_unitario,
			qt_ajuste_conta,
			cd_situacao_glosa,
			ie_valor_informado,
			ie_guia_informada,
			ie_auditoria,
			dt_entrada_unidade,
			qt_material,
			qt_estoque,
			cd_local_estoque,
			dt_Atualizacao,
			nm_usuario,
			nm_usuario_original,
			nr_atendimento,
			cd_unidade_medida,
			cd_acao,
			nr_seq_atepacu,
			nr_seq_ordem_prod,
			ds_observacao,
			nr_prescricao,
			nr_sequencia_prescricao,
			dt_conta,
			ie_via_aplicacao,
			nr_seq_lote_fornec)
		SELECT 	nr_sequencia_w,
			cd_material_w,
			clock_timestamp(),
			cd_senha_w,
			cd_convenio_w,
			nr_doc_convenio_w,
			ie_tipo_guia_w,
			cd_categoria_w,
			cd_setor_atendimento_w,
			cd_material_exec_w,
			qt_material_conta_w,
			0,
			0,
			0,
			'N',
			'N',
			'N',
			dt_entrada_unidade_w,
			qt_material_conta_w,
			qt_material_conta_w,
			null,
			clock_timestamp(),
			nm_usuario_p,
			nm_usuario_p,
			nr_atendimento_p,
			cd_unidade_medida_w,
			'1',
			nr_seq_atepacu_w,
			nr_seq_ordem_p,
			obter_desc_expressao(781466)/*'Referente a ordem:'*/
||nr_seq_ordem_p,
			nr_prescricao_w,
			nr_seq_prescricao_w,
			clock_timestamp(),
			ie_via_aplicacao_w,
			nr_seq_lote_fornec_w
		;
	end if;
	
	UPDATE	prescr_material
	SET		dt_baixa	= clock_timestamp(),
			nm_usuario	= nm_usuario_p,
			cd_motivo_baixa = 1
	WHERE	nr_sequencia    = nr_seq_prescricao_w
	AND		nr_prescricao	= nr_prescricao_w;
	
	ds_entrada_w := substr(ds_entrada_w || ',19',1,4000);
	
	exception
	when others then
		ds_erro_w 	:= substr(SQLERRM(SQLSTATE),1,255);
		ds_erro_log_w := ds_erro_log_w ||  ' - ' || ds_erro_w;
	end;

	if (coalesce(ds_erro_w::text, '') = '') then
		CALL atualiza_preco_material(nr_sequencia_w, nm_usuario_p);
		ds_entrada_w := substr(ds_entrada_w || ',20',1,4000);
		
	end if;
	
	ds_log_w := substr('GERAR_CONTA_DISP_QUIMIO Passagens = (ds_entrada_w) = ' ||	ds_entrada_w				|| chr(10) || chr(13) ||
			'cd_setor_atendimento_w =' || 		cd_setor_atendimento_w			|| chr(10) || chr(13) ||
			'dt_entrada_unidade_w=' ||	       	dt_entrada_unidade_w			|| chr(10) || chr(13) ||
			'cd_setor_atendimento_ww=' ||	       	cd_setor_atendimento_ww			|| chr(10) || chr(13) ||
			'cd_unidade_medida_w=' ||	        cd_unidade_medida_w			|| chr(10) || chr(13) ||
			'cd_estab_w=' ||		       	cd_estab_w				|| chr(10) || chr(13) ||
			'cd_material_w=' ||		       	cd_material_w				|| chr(10) || chr(13) ||
			'cd_material_ww=' ||		       	cd_material_ww				|| chr(10) || chr(13) ||
			'qt_material_conta_w=' ||	       	qt_material_conta_w			|| chr(10) || chr(13) ||
			'nr_seq_atepacu_w=' ||	       		nr_seq_atepacu_w			|| chr(10) || chr(13) ||
			'cd_local_estoque_w=' ||	       	cd_local_estoque_w			|| chr(10) || chr(13) ||
			'cd_local_estoque_ww=' ||	       	cd_local_estoque_ww			|| chr(10) || chr(13) ||
			'nr_seq_cabine_w=' ||		       	nr_seq_cabine_w				|| chr(10) || chr(13) ||
			'cd_estabelecimento_w=' ||	       	cd_estabelecimento_w			|| chr(10) || chr(13) ||
			'cd_estabelecimento_ww=' ||	       	cd_estabelecimento_ww			|| chr(10) || chr(13) ||
			'dt_inicio_preparo_w=' ||	       	dt_inicio_preparo_w			|| chr(10) || chr(13) ||
			'nr_doc_convenio_w=' ||	       		nr_doc_convenio_w			|| chr(10) || chr(13) ||
			'cd_convenio_w=' ||		       	cd_convenio_w				|| chr(10) || chr(13) ||
			'cd_senha_w=' ||		       	cd_senha_w				|| chr(10) || chr(13) ||
			'dt_inicio_real_w=' ||	       		dt_inicio_real_w			|| chr(10) || chr(13) ||
			'ie_tipo_guia_w=' ||		       	ie_tipo_guia_w				|| chr(10) || chr(13) ||
			'cd_categoria_w=' ||		       	cd_categoria_w				|| chr(10) || chr(13) ||
			'ie_generico_w=' ||		       	ie_generico_w				|| chr(10) || chr(13) ||
			'nr_prescricao_w=' ||		       	nr_prescricao_w				|| chr(10) || chr(13) ||
			'nr_seq_prescricao_w=' ||	       	nr_seq_prescricao_w			|| chr(10) || chr(13) ||
			'cd_motivo_baixa_w=' ||	       		cd_motivo_baixa_w			|| chr(10) || chr(13) ||
			'cd_material_exec_w=' ||	       	cd_material_exec_w			|| chr(10) || chr(13) ||
			'ie_consiste_estab_w=' ||	       	ie_consiste_estab_w			|| chr(10) || chr(13) ||
			'ie_possui_nota_w=' ||	       		ie_possui_nota_w			|| chr(10) || chr(13) ||
			'nr_seq_lote_fornec_w=' || 			nr_seq_lote_fornec_w		|| chr(10) || chr(13) ||
			'qt_atendimento_fechado_w=' ||       	qt_atendimento_fechado_w		|| chr(10) || chr(13) ||
			'ie_baixa_Mat_kit_w=' ||		ie_baixa_Mat_kit_w			|| chr(10) || chr(13) ||
			'ERRO = ' || ds_erro_log_w ,1,4000);

	CALL gerar_log_quimio(nr_seq_ordem_p,
			nr_prescricao_w,
			nr_seq_prescricao_w,
			ds_log_w,
			'D',
			nm_usuario_p);
	
	end;
end loop;
close C01;

CALL Baixar_estoque_cmiv(nr_seq_ordem_p,nm_usuario_p,cd_estabelecimento_w);
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_conta_disp_quimio (nr_seq_ordem_p bigint, nr_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

