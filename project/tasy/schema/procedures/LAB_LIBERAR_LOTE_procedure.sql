-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_liberar_lote ( nr_seq_lote_p bigint, cd_medico_resp_p text, ie_exames_sem_result_p text, nm_usuario_p text, ds_mensagem_p INOUT text) AS $body$
DECLARE


qt_lote_w		            bigint;
qt_resultado_w		      bigint;
nr_prescricao_w		      bigint;
nr_seq_prescr_w		      bigint;
nr_seq_resultado_w	    bigint;
ie_exames_sem_result_w  varchar(10);
ie_status_atend_w	      bigint;
qt_nao_liberado_w	      bigint := 0;

C01 CURSOR FOR
	SELECT a.nr_prescricao,	a.nr_seq_prescr, b.ie_status_atend
	  from Lab_Lote_Exame_Item a, prescr_procedimento b
	 where a.nr_seq_lote = nr_seq_lote_p
	   and b.nr_prescricao = a.nr_prescricao
	   and b.nr_sequencia = a.nr_seq_prescr;


BEGIN
  ie_exames_sem_result_w := coalesce(ie_exames_sem_result_p,'N');

  open c01;
    loop
    fetch c01 into nr_prescricao_w, nr_seq_prescr_w, ie_status_atend_w;
    EXIT WHEN NOT FOUND; /* apply on c01 */
      if (ie_exames_sem_result_w = 'N') or (ie_status_atend_w >= 35) then
        select coalesce(max(a.nr_seq_resultado),null)
          into STRICT nr_seq_resultado_w
          from exame_lab_result_item b, exame_lab_resultado a
         where a.nr_seq_resultado	= b.nr_seq_resultado
  	       and a.nr_prescricao = nr_prescricao_w
           and b.nr_seq_prescr = nr_seq_prescr_w
           and (b.nr_seq_material IS NOT NULL AND b.nr_seq_material::text <> '');

        if (coalesce(nr_seq_resultado_w::text, '') = '') then
          --'Faltam resultados para itens da prescrição ' || nr_prescricao_w || ' !');
          CALL wheb_mensagem_pck.exibir_mensagem_abort(186831, 'NR_PRESCRICAO=' || nr_prescricao_w);
        end if;

        update exame_lab_result_item
           set dt_liberacao	        = clock_timestamp(),
               nm_usuario_liberacao	= nm_usuario_p,
               dt_atualizacao       = clock_timestamp(),
               nm_usuario           = nm_usuario_p,
  			       cd_medico_resp	      = cd_medico_resp_p
    	   where nr_seq_resultado	= nr_seq_resultado_w
           and nr_seq_prescr		= nr_seq_prescr_w
           and (nr_seq_material IS NOT NULL AND nr_seq_material::text <> '');

        update prescr_procedimento
           set ie_status_atend = 40,
               nm_usuario = nm_usuario_p
    	   where nr_prescricao = nr_prescricao_w
           and nr_sequencia	 = nr_seq_prescr_w
           and ie_status_atend < 40;
      else
        qt_nao_liberado_w  := qt_nao_liberado_w + 1;
      end if;
    end loop;
  close c01;

  if (qt_nao_liberado_w > 0) then
    --Existem prescrições neste lote que não estão digitadas. Favor verificar.
    ds_mensagem_p := substr(obter_texto_tasy(186832, wheb_usuario_pck.get_nr_seq_idioma),1,255);
  else
    update lab_lote_exame
       set ie_status = 'L'
     where nr_sequencia = nr_seq_lote_p;
  end if;
  commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_liberar_lote ( nr_seq_lote_p bigint, cd_medico_resp_p text, ie_exames_sem_result_p text, nm_usuario_p text, ds_mensagem_p INOUT text) FROM PUBLIC;

