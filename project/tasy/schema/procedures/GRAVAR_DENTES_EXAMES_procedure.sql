-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_dentes_exames (nr_seq_cons_proc_p bigint, lista_dentes_p text, nm_usuario_p text) AS $body$
DECLARE


ds_lista_w	varchar(255);
nr_dente_w	varchar(10);
tam_lista	bigint;
pos_virgula	bigint;

BEGIN

ds_lista_w := substr(lista_dentes_p,1,255) || ',';

--sempre deletar, mesmo que a lista esteja vazia
delete
from	agenda_cons_proc_odont
where	nr_seq_cons_proc = nr_seq_cons_proc_p;
commit;

while(ds_lista_w IS NOT NULL AND ds_lista_w::text <> '') loop
	begin
	tam_lista   := length(ds_lista_w);
	pos_virgula := position(',' in ds_lista_w);


	if (pos_virgula <> 0) then
		nr_dente_w := substr(ds_lista_w,1,pos_virgula -1);
		ds_lista_w := substr(ds_lista_w,pos_virgula+1,tam_lista);
	else
		ds_lista_w	:= null;
	end if;
	if (nr_dente_w IS NOT NULL AND nr_dente_w::text <> '') then
		insert into agenda_cons_proc_odont(nr_sequencia,
					 dt_atualizacao,
					 nm_usuario,
					 dt_atualizacao_nrec,
					 nm_usuario_nrec,
					 nr_dente,
					 nr_seq_cons_proc
					)
		values (nextval('agenda_cons_proc_odont_seq'),
					 clock_timestamp(),
					 nm_usuario_p,
					 clock_timestamp(),
					 nm_usuario_p,
					 nr_dente_w,
					 nr_seq_cons_proc_p
					);
	end if;
	end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_dentes_exames (nr_seq_cons_proc_p bigint, lista_dentes_p text, nm_usuario_p text) FROM PUBLIC;

