-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inserir_item_conta ( cd_item_p bigint, ie_origem_proced_p bigint, dt_item_p timestamp, nr_seq_conta_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_item_p INOUT bigint) AS $body$
DECLARE

 
/*Diego 29/04/2011 
 
Esta rotina por finalidade a inserção de um item, inserido na análise, na conta. 
Neste novo item deve ser realizado a consitência, gerado as glosas/ocorrências. 
Estes items, glosas e ocorrências devem ser levados para o respectivo item da análise. 
 
???????????????????????????? 
???? GRUPOS GERADOS ???? 
??????????????????????????? 
*/
 
 
nr_seq_conta_proc_w		bigint;
nr_seq_conta_mat_w		bigint;
				

BEGIN 
 
if (coalesce(ie_origem_proced_p,0) > 0) then 
	/*Procedimento*/
	 
	select	nextval('pls_conta_proc_seq') 
	into STRICT	nr_seq_conta_proc_w 
	;
	 
	insert into pls_conta_proc(nr_sequencia, cd_procedimento, ie_origem_proced, 
		 nr_seq_conta, dt_procedimento, nm_usuario, 
		 nm_usuario_nrec, dt_atualizacao, dt_atualizacao_nrec, 
		 ie_situacao, ie_status) 
	values (nr_seq_conta_proc_w, cd_item_p, ie_origem_proced_p, 
		 nr_seq_conta_p, dt_item_p, nm_usuario_p, 
		 nm_usuario_p, clock_timestamp(), clock_timestamp(), 
		 'D', 'U');	
		 
	CALL pls_consistir_conta_proc(nr_seq_conta_proc_w, cd_estabelecimento_p,'N', nm_usuario_p);
	 
	update	pls_conta_proc 
	set	ie_status = 'A' 
	where	nr_sequencia = nr_seq_conta_proc_w 
	and	ie_status 	<> 'D';
else 
	/*Material*/
 
	select	nextval('pls_conta_mat_seq') 
	into STRICT	nr_seq_conta_mat_w 
	;
	 
	insert into pls_conta_mat(nr_sequencia, nr_seq_material, nr_seq_conta, 
		 dt_atendimento, nm_usuario, nm_usuario_nrec, 
		 dt_atualizacao, dt_atualizacao_nrec, ie_situacao, 
		 ie_status) 
	values (nr_seq_conta_mat_w, cd_item_p, nr_seq_conta_p, 
		 dt_item_p, nm_usuario_p, nm_usuario_p, 
		 clock_timestamp(), clock_timestamp(), 'D', 
		 'U');	
 
	CALL pls_consistir_conta_mat(nr_seq_conta_mat_w, cd_estabelecimento_p,'N', nm_usuario_p,null);
 
	update	pls_conta_mat 
	set	ie_status = 'A' 
	where	nr_sequencia = nr_seq_conta_mat_w;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inserir_item_conta ( cd_item_p bigint, ie_origem_proced_p bigint, dt_item_p timestamp, nr_seq_conta_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_item_p INOUT bigint) FROM PUBLIC;

