-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_validar_regra_bloq_upload ( nr_seq_prestador_p text, ds_mensagem_retorno INOUT text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


dia_atual_w		varchar(2);
nr_seq_regra_valida_w	bigint;
ie_cad_conta_medica_w	pls_controle_estab.ie_cad_conta_medica%type;



BEGIN

select	to_char(clock_timestamp(), 'dd')
into STRICT	dia_atual_w
;

ds_mensagem_retorno := '';

ie_cad_conta_medica_w := pls_obter_se_controle_estab('CM');

select	max(t.nr_sequencia)
into STRICT	nr_seq_regra_valida_w
from (	-- busca quando não restringe por estabelecimento
	SELECT	a.nr_sequencia
	from	pls_regra_cta_bloq_upload	a
	where (a.nr_seq_prestador		= nr_seq_prestador_p)
	and	(a.nr_dia_bloqueio IS NOT NULL AND a.nr_dia_bloqueio::text <> '' AND a.nr_dia_bloqueio > 0)
	and (a.nr_dia_bloqueio 		<= dia_atual_w)
	and (trunc(a.dt_inicio_vigencia)	<= trunc(clock_timestamp()))
	and	((coalesce(a.dt_fim_vigencia::text, '') = '') 	or (trunc(a.dt_fim_vigencia) > trunc(clock_timestamp())))
	and	ie_cad_conta_medica_w		= 'N'
	-- busca quando restringe por estabelecimento
	
union all

	SELECT	a.nr_sequencia
	from	pls_regra_cta_bloq_upload	a
	where (a.nr_seq_prestador		= nr_seq_prestador_p)
	and	(a.nr_dia_bloqueio IS NOT NULL AND a.nr_dia_bloqueio::text <> '' AND a.nr_dia_bloqueio > 0)
	and (a.nr_dia_bloqueio 		<= dia_atual_w)
	and (trunc(a.dt_inicio_vigencia)	<= trunc(clock_timestamp()))
	and	((coalesce(a.dt_fim_vigencia::text, '') = '') 	or (trunc(a.dt_fim_vigencia) > trunc(clock_timestamp())))
	and	ie_cad_conta_medica_w		= 'S'
	and	a.cd_estabelecimento		= cd_estabelecimento_p) t;


--Caso não encontre regra específica para o prestador
if (coalesce(nr_seq_regra_valida_w::text, '') = '') then
		--Procuro por regra genérica, ou seja, para todos os prestadores (sem prestador informado no cadastro da regra de bloqueio)
		select	max(t.nr_sequencia)
		into STRICT	nr_seq_regra_valida_w
		from (	-- busca quando não restringe por estabelecimento
			SELECT	a.nr_sequencia
			from	pls_regra_cta_bloq_upload	a
			where (coalesce(a.nr_seq_prestador::text, '') = '')
			and	(a.nr_dia_bloqueio IS NOT NULL AND a.nr_dia_bloqueio::text <> '' AND a.nr_dia_bloqueio > 0)
			and (a.nr_dia_bloqueio <= dia_atual_w)
			and (trunc(a.dt_inicio_vigencia) <= trunc(clock_timestamp()))
			and	((coalesce(a.dt_fim_vigencia::text, '') = '') or (trunc(a.dt_fim_vigencia) > trunc(clock_timestamp())))
			and	ie_cad_conta_medica_w		= 'N'
			-- busca quando restringe por estabelecimento
			
union all

			SELECT	a.nr_sequencia
			from	pls_regra_cta_bloq_upload	a
			where (coalesce(a.nr_seq_prestador::text, '') = '')
			and	(a.nr_dia_bloqueio IS NOT NULL AND a.nr_dia_bloqueio::text <> '' AND a.nr_dia_bloqueio > 0)
			and (a.nr_dia_bloqueio <= dia_atual_w)
			and (trunc(a.dt_inicio_vigencia) <= trunc(clock_timestamp()))
			and	((coalesce(a.dt_fim_vigencia::text, '') = '') or (trunc(a.dt_fim_vigencia) > trunc(clock_timestamp())))
			and	ie_cad_conta_medica_w		= 'S'
			and	a.cd_estabelecimento		= cd_estabelecimento_p) t;
end if;

if (nr_seq_regra_valida_w IS NOT NULL AND nr_seq_regra_valida_w::text <> '') then
		select	ds_mensagem
		into STRICT	ds_mensagem_retorno
		from	pls_regra_cta_bloq_upload
		where	nr_sequencia = nr_seq_regra_valida_w;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_validar_regra_bloq_upload ( nr_seq_prestador_p text, ds_mensagem_retorno INOUT text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

