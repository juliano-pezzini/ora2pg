-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inclui_home_care_regra ( nr_atendimento_p bigint, nr_seq_regra_p bigint, nm_usuario_p text, cd_convenio_p bigint, cd_plano_p text, cd_usuario_convenio_p text ) AS $body$
DECLARE

 
ie_classificacao_w	varchar(10);
nr_seq_origem_w		bigint;
nr_seq_entidade_w	bigint;
nr_seq_classificacao_w	bigint;
nr_seq_status_pac_w	bigint;
			
cd_pessoa_fisica_w	varchar(60);
cd_estabelecimento_w	bigint;
cd_doenca_w		varchar(10);
nr_seq_paciente_w	bigint;
cd_medico_resp_w	varchar(10);
cd_medico_referido_w	varchar(10);
			
C01 CURSOR FOR 
	SELECT	cd_doenca 
	from	diagnostico_doenca 
	where	nr_atendimento = nr_atendimento_p 
	order by 1;
			

BEGIN 
 
select	max(ie_classificacao), 
	max(nr_seq_origem), 
	max(nr_seq_entidade), 
	max(nr_seq_classificacao), 
	max(nr_seq_status_pac) 
into STRICT	ie_classificacao_w, 
	nr_seq_origem_w, 
	nr_seq_entidade_w, 
	nr_seq_classificacao_w, 
	nr_seq_status_pac_w 
from	regra_gerar_pac_home_care 
where	nr_sequencia	= nr_seq_regra_p;	
 
 
select	max(cd_estabelecimento), 
	max(cd_pessoa_fisica), 
	max(cd_medico_resp), 
	max(cd_medico_referido) 
into STRICT	cd_estabelecimento_w, 
	cd_pessoa_fisica_w, 
	cd_medico_resp_w, 
	cd_medico_referido_w 
from	atendimento_paciente 
where	nr_atendimento 	= nr_atendimento_p;	
 
select	nextval('paciente_home_care_seq') 
into STRICT	nr_seq_paciente_w
;
 
insert	into paciente_home_care( 
	cd_estabelecimento, 
	cd_medico_indicou, 
	cd_medico_resp, 
	cd_perfil_ativo, 
	cd_pessoa_fisica, 
	dt_atualizacao, 
	dt_atualizacao_nrec, 
	dt_final, 
	dt_inicio, 
	ie_classificacao, 
	ie_situacao, 
	nm_usuario, 
	nm_usuario_nrec, 
	nr_seq_entidade, 
	nr_seq_origem, 
	nr_sequencia, 
	qt_km, 
	qt_min_atend, 
	nr_atendimento_origem, 
	nr_seq_classificacao, 
	nr_seq_status_pac, 
	cd_convenio, 
	cd_plano, 
	cd_usuario_convenio 
	) 
values ( 
	cd_estabelecimento_w, 
	cd_medico_resp_w, 
	cd_medico_referido_w, 
	null, 
	cd_pessoa_fisica_w, 
	clock_timestamp(), 
	clock_timestamp(), 
	null, 
	clock_timestamp(), 
	ie_classificacao_w, 
	'A', 
	nm_usuario_p, 
	nm_usuario_p, 
	nr_seq_entidade_w, 
	nr_seq_origem_w, 
	nr_seq_paciente_w, 
	null, 
	null, 
	nr_atendimento_p, 
	nr_seq_classificacao_w, 
	nr_seq_status_pac_w, 
	cd_convenio_p, 
	cd_plano_p, 
	cd_usuario_convenio_p);
	 
open C01;
loop 
fetch C01 into	 
	cd_doenca_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	insert into paciente_hc_doenca(	 
		nr_sequencia, 
		nr_seq_paciente, 
		dt_atualizacao, 
		nm_usuario, 
		cd_doenca_cid, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec) 
	values (	nextval('paciente_hc_doenca_seq'), 
		nr_seq_paciente_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_doenca_w, 
		clock_timestamp(), 
		nm_usuario_p);
	 
	end;
end loop;
close C01;
	 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inclui_home_care_regra ( nr_atendimento_p bigint, nr_seq_regra_p bigint, nm_usuario_p text, cd_convenio_p bigint, cd_plano_p text, cd_usuario_convenio_p text ) FROM PUBLIC;

