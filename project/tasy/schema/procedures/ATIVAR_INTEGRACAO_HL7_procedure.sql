-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ativar_integracao_hl7 ( nr_seq_sistema_p bigint,--Número de sequencia do Sistema  (9 - Dixtal, 17 - Philips, e 32 - Draeger)
 nm_usuario_p text, -- Nome do usuário
 nr_ip_central_p text, --Informar o IP da central
 nr_porta_central_p text, -- Informar a Porta que será recebida as ADT's na Central
 nr_porta_listener_p text) AS $body$
 -- Informar a Porta Listener, qual porta o Tasy irá receber os SV
DECLARE





C01 CURSOR FOR
	SELECT	a.nr_sequencia,
			1
	from	INFORMACAO_INTEGRACAO a
	where	NR_SEQ_SISTEMA_DESTINO	= nr_seq_sistema_p
	
union

	SELECT	a.nr_sequencia,
			2
	from	INFORMACAO_INTEGRACAO a
	where	NR_SEQ_SISTEMA_ORIGEM	= nr_seq_sistema_p
	order by 2;

nr_sequencia_w	bigint;
nr_seq_servidor_lis_t_w	bigint;
nr_seq_servidor_w	bigint;
ie_origem_w		bigint;
nr_seq_server_w	bigint;



BEGIN


select	nextval('servidor_integracao_seq')
into STRICT	nr_seq_servidor_w
;

insert into SERVIDOR_INTEGRACAO(
			 NR_SEQUENCIA,
			 NR_PORTA,
			 IP_CONEXAO,
			 NR_PORTA_LISTENER,
			 QT_MAX_RETRANSMISSAO,
			 DT_ATUALIZACAO,
			 NM_USUARIO,
			 DT_ATUALIZACAO_NREC,
			 NM_USUARIO_NREC,
			 QT_INTERVALO_RETRANSMISSAO,
			 QT_MAX_RECONEXAO,
			 QT_INTERVALO_RECONEXAO,
			 QT_INTERVALO_MINIMO_ENVIO,
			 DS_INFORMACAO)
		values (
			 nr_seq_servidor_w,
			 nr_porta_central_p,
			 nr_ip_central_p,
			 null,
			 4,
			 clock_timestamp(),
			 nm_usuario_p,
			 clock_timestamp(),
			 nm_usuario_p,
			 60,
			 99999,
			 60,
			 null,
			 'Servidor envio ADT');


select	nextval('servidor_integracao_seq')
into STRICT	nr_seq_servidor_lis_t_w
;

insert into SERVIDOR_INTEGRACAO(
			 NR_SEQUENCIA,
			 NR_PORTA,
			 IP_CONEXAO,
			 NR_PORTA_LISTENER,
			 QT_MAX_RETRANSMISSAO,
			 DT_ATUALIZACAO,
			 NM_USUARIO,
			 DT_ATUALIZACAO_NREC,
			 NM_USUARIO_NREC,
			 QT_INTERVALO_RETRANSMISSAO,
			 QT_MAX_RECONEXAO,
			 QT_INTERVALO_RECONEXAO,
			 QT_INTERVALO_MINIMO_ENVIO,
			 DS_INFORMACAO)
		values (
			 nr_seq_servidor_lis_t_w,
			 null,
			 null,
			 nr_porta_listener_p,
			 4,
			 clock_timestamp(),
			 nm_usuario_p,
			 clock_timestamp(),
			 nm_usuario_p,
			 60,
			 99999,
			 60,
			 null,
			 'Listener SV');


open C01;
loop
fetch C01 into
	nr_sequencia_w,
	ie_origem_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (ie_origem_w	= 2) then
		nr_seq_server_w	:= nr_seq_servidor_lis_t_w;
	else
		nr_seq_server_w	:= nr_seq_servidor_w;
	end if;


	insert into CLIENTE_INTEGRACAO(
				 NR_SEQUENCIA,
				 NR_SEQ_INF_INTEGRACAO,
				 NR_PORTA,
				 IP_CONEXAO,
				 DT_ATUALIZACAO,
				 NM_USUARIO,
				 DT_ATUALIZACAO_NREC,
				 NM_USUARIO_NREC,
				 IE_SITUACAO,
				 QT_DIAS_LOG,
				 QT_MAX_RETRANSMISSAO,
				 QT_INTERVALO_RETRANSMISSAO,
				 QT_MAX_RECONEXAO,
				 QT_INTERVALO_RECONEXAO,
				 QT_INTERVALO_MINIMO_ENVIO,
				 IP_LISTENER,
				 NR_PORTA_LISTENER,
				 NR_SEQ_SERVIDOR,
				 DS_URL_WEBSERVICE,
				 DS_ACTION,
				 DS_FTP,
				 CD_ESTABELECIMENTO_DESTINO,
				 CD_SETOR_ATENDIMENTO)
			values (
				 nextval('cliente_integracao_seq'),
				 nr_sequencia_w,
				 null,
				 null,
				 clock_timestamp(),
				 NM_USUARIO_p,
				 clock_timestamp(),
				 nm_usuario_p,
				 'A',
				 15,
				 null,
				 null,
				 null,
				 null,
				 null,
				 null,
				 null,
				 nr_seq_server_w,
				 null,
				 null,
				 null,
				 null,
				 null);
	end;
end loop;
close C01;



commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ativar_integracao_hl7 ( nr_seq_sistema_p bigint, nm_usuario_p text, nr_ip_central_p text, nr_porta_central_p text, nr_porta_listener_p text) FROM PUBLIC;

