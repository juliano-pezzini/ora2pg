-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE generate_sts_batch_request ( cd_transaction_list_p text, dt_received_from_p timestamp, dt_received_to_p timestamp, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_seq_w 	sts_request.nr_sequencia%type;
to_date_w 		varchar(30);
from_date_w		varchar(30);
request_sts		varchar(500);


BEGIN
	nr_seq_w := insert_sts_request(	0, null, null, null, 'batch', dt_received_from_p, dt_received_to_p, nm_usuario_p, nr_seq_w);

  begin
    select 	to_char(dt_received_from_p, 'YYYY-MM-DD"T"HH:MM:SS') || '.000' || (SELECT DBTIMEZONE )
    into STRICT 	from_date_w
;
    exception
        when others then
          from_date_w	:= null;
  end;

  begin
    select 	to_char(dt_received_to_p, 'YYYY-MM-DD"T"HH:MM:SS') || '.000' || (SELECT DBTIMEZONE )
    into STRICT 	to_date_w
;
    exception
        when others then
          to_date_w	:= null;
  end;

	request_sts := '{' || chr(10) || '"userName":"' || nm_usuario_p || '",'
		|| chr(10) || '"requestId": "'|| nr_seq_w || '",'
		|| chr(10) || '"establishmentCode":"' || cd_estabelecimento_p || '",';

	if (dt_received_to_p IS NOT NULL AND dt_received_to_p::text <> '' AND dt_received_from_p IS NOT NULL AND dt_received_from_p::text <> '') then
		request_sts := request_sts 	|| chr(10) || '"receivedFromDateTime": "'|| from_date_w || '",'
									|| chr(10) || '"receivedToDateTime":"' || to_date_w || '"}';
	elsif (cd_transaction_list_p IS NOT NULL AND cd_transaction_list_p::text <> '') then
		request_sts := request_sts || chr(10) || '"transactionIdList":[' || cd_transaction_list_p || ']}';
	end if;

	
	CALL EXECUTE_BIFROST_INTEGRATION(206, request_sts);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE generate_sts_batch_request ( cd_transaction_list_p text, dt_received_from_p timestamp, dt_received_to_p timestamp, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

