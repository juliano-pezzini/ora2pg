-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mprev_consiste_situacao_part ( nr_seq_participante_p bigint, cd_pessoa_fisica_p text, cd_estabelecimento_p text, ie_tipo_consistencia_p text, ds_mensagem_retorno_p INOUT text, ie_tipo_mensagem_p INOUT text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[ X ]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
/* IE_TIPO_CONSISTENCIA_P
I - Inclusão de novo participante
A - Atendimento a participante
*/
/* IE_TIPO_MENSAGEM_P
A - Alertar
B - Bloquear
*/
ie_inclusao_partic_inativo_w 	mprev_config_geral.ie_inclusao_partic_inativo%type;
ie_inclusao_partic_inad_w	mprev_config_geral.ie_inclusao_partic_inad%type;
ie_atividade_partic_inativo_w	mprev_config_geral.ie_atividade_partic_inativo%type;
ie_atividade_partic_inad_w	mprev_config_geral.ie_atividade_partic_inad%type;
ie_inclusao_partic_repasse_w	mprev_config_geral.ie_inclusao_partic_repasse%type;
ie_atividade_partic_repasse_w	mprev_config_geral.ie_atividade_partic_repasse%type;
ie_inclusao_partic_eventual_w	mprev_config_geral.ie_inclusao_partic_eventual%type;
ie_atividade_partic_eventual_w	mprev_config_geral.ie_atividade_partic_eventual%type;
nr_seq_participante_w		mprev_participante.nr_sequencia%type;
ie_sit_contrato_w		varchar(1);
ie_apto_atendimento_w		varchar(1);
ie_tipo_segurado_w		varchar(1);


BEGIN

begin
select 	coalesce(ie_inclusao_partic_inativo,'N'),
	coalesce(ie_inclusao_partic_inad,'N'),
	coalesce(ie_atividade_partic_inativo,'N'),
	coalesce(ie_atividade_partic_inad,'N'),
	coalesce(ie_inclusao_partic_repasse,'N'),
	coalesce(ie_atividade_partic_repasse,'N'),
	coalesce(ie_inclusao_partic_eventual,'N'),
	coalesce(ie_atividade_partic_eventual,'N')
into STRICT 	ie_inclusao_partic_inativo_w,
	ie_inclusao_partic_inad_w,
	ie_atividade_partic_inativo_w,
	ie_atividade_partic_inad_w,
	ie_inclusao_partic_repasse_w,
	ie_atividade_partic_repasse_w,
	ie_inclusao_partic_eventual_w,
	ie_atividade_partic_eventual_w
from	mprev_config_geral
where 	cd_estabelecimento = cd_estabelecimento_p;
exception
	when no_data_found then
	ie_inclusao_partic_inativo_w	:= 'N';
	ie_inclusao_partic_inad_w	:= 'N';
	ie_atividade_partic_inativo_w	:= 'N';
	ie_atividade_partic_inad_w	:= 'N';
	ie_inclusao_partic_repasse_w	:= 'N';
	ie_atividade_partic_repasse_w	:= 'N';
	ie_inclusao_partic_eventual_w	:= 'N';
	ie_atividade_partic_eventual_w	:= 'N';
end;

if (nr_seq_participante_p IS NOT NULL AND nr_seq_participante_p::text <> '') then
	nr_seq_participante_w	:= nr_seq_participante_p;
else
	select	max(nr_sequencia)
	into STRICT	nr_seq_participante_w
	from	mprev_participante
	where	cd_pessoa_fisica = cd_pessoa_fisica_p;
end if;

/* Consistência para ver se pode incluir benef inativo */

if (ie_inclusao_partic_inativo_w <> 'N' and ie_tipo_consistencia_p = 'I') or (ie_atividade_partic_inativo_w <> 'N' and ie_tipo_consistencia_p = 'A') then

	if (nr_seq_participante_w IS NOT NULL AND nr_seq_participante_w::text <> '') and (nr_seq_participante_w > 0) then
		ie_sit_contrato_w	:= mprev_obter_status_ben_part(nr_seq_participante_w ,null,'C');
	elsif (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
		ie_sit_contrato_w	:= mprev_obter_status_ben_part(null,cd_pessoa_fisica_p,'C');
	end if;

	if (ie_sit_contrato_w = 'I') then
		if (ie_inclusao_partic_inativo_w = 'A') or (ie_atividade_partic_inativo_w = 'A') then
			/*Atenção, a pessoa selecionada não possui contrato ativo com a operadora atualmente, deseja continuar?*/

			ds_mensagem_retorno_p	:= obter_texto_tasy(316926,null);
			ie_tipo_mensagem_p	:= 'A';
		elsif (ie_inclusao_partic_inativo_w = 'S') or (ie_atividade_partic_inativo_w = 'S') then
			/* Processo abortado, a pessoa selecionada não possui contrato ativo com a operadora atualmente. */

			ds_mensagem_retorno_p	:= obter_texto_tasy(316930,null);
			ie_tipo_mensagem_p	:= 'B';
		end if;
	end if;
end if;

/* Consistência para ver se pode incluir benef inadimplente*/

if (ie_inclusao_partic_inad_w <> 'N' and ie_tipo_consistencia_p = 'I') or (ie_atividade_partic_inad_w <> 'N' and ie_tipo_consistencia_p = 'A') then

	if (nr_seq_participante_w IS NOT NULL AND nr_seq_participante_w::text <> '') and (nr_seq_participante_w > 0) then
		ie_apto_atendimento_w	:= mprev_obter_status_ben_part(nr_seq_participante_w ,null,'A');
	elsif (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
		ie_apto_atendimento_w	:= mprev_obter_status_ben_part(null,cd_pessoa_fisica_p,'A');
	end if;

	if (ie_apto_atendimento_w =  'I') then
		if (ie_inclusao_partic_inad_w = 'A') or (ie_atividade_partic_inad_w = 'A') then
			/*Atenção, a pessoa selecionada não está apta para atendimento no momento (possui algum bloqueio, como inadimplência, por exemplo) deseja continuar?*/

			ds_mensagem_retorno_p	:= obter_texto_tasy(316935,null);
			ie_tipo_mensagem_p	:= 'A';
		elsif (ie_inclusao_partic_inad_w = 'S') or (ie_atividade_partic_inad_w = 'S') then
			/*Processo abortado. A pessoa selecionada não está apta para atendimento no momento (possui algum bloqueio, como inadimplência, por exemplo).*/

			ds_mensagem_retorno_p	:= obter_texto_tasy(316939,null);
			ie_tipo_mensagem_p	:= 'B';
		end if;
	end if;
end if;

/*Consistência para ver se pode incluir ou atender beneficiário de intercâmbio e eventual*/

if (coalesce(ie_sit_contrato_w::text, '') = ''	or ie_sit_contrato_w <> 'I') and (coalesce(ie_apto_atendimento_w::text, '') = ''	or ie_apto_atendimento_w <> 'I') then

	if (nr_seq_participante_w IS NOT NULL AND nr_seq_participante_w::text <> '') and (nr_seq_participante_w > 0) then
		ie_tipo_segurado_w	:= mprev_obter_status_ben_part(nr_seq_participante_w ,null,'T');
	elsif (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
		ie_tipo_segurado_w	:= mprev_obter_status_ben_part(null,cd_pessoa_fisica_p,'T');
	end if;

	if (ie_tipo_segurado_w = 'T') then
		/*Consistência para ver se pode incluir beneficiário de intercâmbio*/

		if (ie_inclusao_partic_repasse_w <> 'N' and ie_tipo_consistencia_p = 'I') then
			if (ie_inclusao_partic_repasse_w	= 'A') then
				/*Beneficiário de intercâmbio (Resp. Assumida), confirma inclusão?*/

				ds_mensagem_retorno_p	:= obter_texto_tasy(323115,null);
				ie_tipo_mensagem_p	:= 'A';
			elsif (ie_inclusao_partic_repasse_w	= 'S') then
				/*Não é permitida a inclusão de beneficiário de intercâmbio (Resp. Assumida).*/

				ds_mensagem_retorno_p	:= obter_texto_tasy(323116,null);
				ie_tipo_mensagem_p	:= 'B';
			end if;
		/*Consistência para ver se pode atender beneficiário de intercâmbio*/

		elsif (ie_atividade_partic_repasse_w <> 'N' and ie_tipo_consistencia_p = 'A') then
			if (ie_atividade_partic_repasse_w	= 'A') then
				/*Beneficiário de intercâmbio (Resp. Assumida), confirma atendimento?*/

				ds_mensagem_retorno_p	:= obter_texto_tasy(323117,null);
				ie_tipo_mensagem_p	:= 'A';
			elsif (ie_atividade_partic_repasse_w	= 'S') then
				/*Não é permitido o atendimento a beneficiário de intercâmbio (Resp. Assumida).*/

				ds_mensagem_retorno_p	:= obter_texto_tasy(323122,null);
				ie_tipo_mensagem_p	:= 'B';
			end if;
		end if;
	elsif (ie_tipo_segurado_w = 'I') then
		/*Consistência para ver se pode incluir beneficiário de intercâmbio eventual*/

		if (ie_inclusao_partic_eventual_w <> 'N' and ie_tipo_consistencia_p = 'I') then
			if (ie_inclusao_partic_eventual_w = 'A') then
				/*Usuário de intercâmbio eventual, confirma inclusão?*/

				ds_mensagem_retorno_p	:= obter_texto_tasy(323123,null);
				ie_tipo_mensagem_p	:= 'A';
			elsif (ie_inclusao_partic_eventual_w = 'S') then
				/*Não é permitida inclusão de usuário de intercâmbio eventual.*/

				ds_mensagem_retorno_p	:= obter_texto_tasy(323118,null);
				ie_tipo_mensagem_p	:= 'B';
			end if;
		/*Consistência para ver se pode atender beneficiário de intercâmbio eventual*/

		elsif (ie_atividade_partic_eventual_w <> 'N' and ie_tipo_consistencia_p = 'A') then
			if (ie_atividade_partic_eventual_w = 'A') then
				/*Usuário de intercâmbio eventual, confirma atendimento?*/

				ds_mensagem_retorno_p	:= obter_texto_tasy(323125,null);
				ie_tipo_mensagem_p	:= 'A';
			elsif (ie_atividade_partic_eventual_w = 'S') then
				/*Não é permitido atendimento a usuário de intercâmbio eventual.*/

				ds_mensagem_retorno_p	:= obter_texto_tasy(323126,null);
				ie_tipo_mensagem_p	:= 'B';
			end if;
		end if;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mprev_consiste_situacao_part ( nr_seq_participante_p bigint, cd_pessoa_fisica_p text, cd_estabelecimento_p text, ie_tipo_consistencia_p text, ds_mensagem_retorno_p INOUT text, ie_tipo_mensagem_p INOUT text) FROM PUBLIC;

