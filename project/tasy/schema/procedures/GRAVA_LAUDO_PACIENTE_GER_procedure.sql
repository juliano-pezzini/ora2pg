-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE grava_laudo_paciente_ger ( nr_case_p text, nm_usuario_p text, nr_seq_laudo_p INOUT bigint, nr_controle_ext_p text default null) AS $body$
DECLARE


nr_laudo_w			    			laudo_paciente.nr_laudo%TYPE;
nm_medico_w			    			laudo_paciente.nm_medico_solicitante%TYPE;
cd_medico_resp_w					laudo_paciente.cd_medico_resp%TYPE;
nr_seq_laudo_imagem_w               laudo_paciente.nr_sequencia%TYPE;
nr_atendimento_w    				atendimento_paciente.nr_atendimento%TYPE;
nr_seq_laudo_w 						bigint;
const_cardio_base_w					varchar(40) := 'CARDIOBASE';
const_custo_diagnostic_w 			varchar(40) := 'CUSTODIAGNOSTIC';
const_rad_center_w 					varchar(40) := 'RADCENTRE';
const_clinic_win_data_w 			varchar(40) := 'CWD';
const_xcelera_data_w 	    		varchar(40) := 'XCELERA';
ds_titutlo_w						varchar(100);


BEGIN

SELECT nextval('laudo_paciente_seq')
INTO STRICT nr_seq_laudo_w
;

nr_seq_laudo_p := nr_seq_laudo_w;

SELECT obter_atend_episodio_interg(nr_case_p)
INTO STRICT nr_atendimento_w
;

SELECT	coalesce(MAX(nr_laudo),0) + 1
INTO STRICT	nr_laudo_w
FROM	laudo_paciente
WHERE	nr_atendimento = nr_atendimento_w;

SELECT 	MAX(SUBSTR(obter_nome_pf(cd_medico_resp),1,255)) nm_medico,
	MAX(cd_medico_resp)
INTO STRICT 	nm_medico_w,
	cd_medico_resp_w
FROM 	atendimento_paciente
WHERE 	nr_atendimento = nr_atendimento_w;

if (nm_usuario_p = const_cardio_base_w) then
	ds_titutlo_w := OBTER_DESC_EXPRESSAO(945539); --Herzkatheter-Befund
end if;

if (nm_usuario_p = const_custo_diagnostic_w) then
	ds_titutlo_w := OBTER_DESC_EXPRESSAO(945543); --EKG Befund
end if;

if (nm_usuario_p = const_rad_center_w) then
	ds_titutlo_w := OBTER_DESC_EXPRESSAO(945541); --Radiologiebefund
end if;

if (nm_usuario_p = const_clinic_win_data_w) then
	ds_titutlo_w := OBTER_DESC_EXPRESSAO(948975); --Gastroenterologiebefund
end if;

if (nm_usuario_p = const_xcelera_data_w) then
	ds_titutlo_w := OBTER_DESC_EXPRESSAO(945545); --"Echo Befund"
end if;

INSERT INTO laudo_paciente(nr_sequencia,
			nr_prescricao,
			nr_seq_prescricao,
			nr_seq_proc,
			nm_usuario_digitacao,
			nr_atendimento,
			nr_laudo,
			nm_usuario,
			dt_atualizacao,
			cd_medico_resp,
			qt_imagem,
			ds_titulo_laudo,
			dt_laudo,
			dt_entrada_unidade,
			dt_liberacao,
			dt_exame,
			dt_aprovacao,
			nm_medico_solicitante,
			dt_integracao)
VALUES (
	nr_seq_laudo_w,
	NULL,
	NULL,
	NULL,
	nm_usuario_p,
	nr_atendimento_w,
	nr_laudo_w,
	nm_usuario_p,
	clock_timestamp(),
	cd_medico_resp_w,
	0,
	ds_titutlo_w,
	clock_timestamp(),
	clock_timestamp(),
	clock_timestamp(),
	clock_timestamp(),
	clock_timestamp(),
	nm_medico_w,
	clock_timestamp());

COMMIT;

select  max(nr_sequencia)
into STRICT    nr_seq_laudo_imagem_w
from    laudo_paciente_imagem
where   nr_controle_ext = nr_controle_ext_p;

if (nr_seq_laudo_imagem_w IS NOT NULL AND nr_seq_laudo_imagem_w::text <> '') then

    update  laudo_paciente_imagem
    set     nr_sequencia = nr_seq_laudo_w
    where   nr_sequencia = nr_seq_laudo_imagem_w;

    delete FROM laudo_paciente
    where   nr_sequencia = nr_seq_laudo_imagem_w;

    commit;
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE grava_laudo_paciente_ger ( nr_case_p text, nm_usuario_p text, nr_seq_laudo_p INOUT bigint, nr_controle_ext_p text default null) FROM PUBLIC;

