-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE proj_gerar_fechamento_mes_clt (cd_empresa_p bigint, dt_mes_p timestamp, ie_regime_contr_p text, nm_usuario_p text) AS $body$
DECLARE

 
cd_executor_w				varchar(10);
nr_seq_fechamento_w			bigint;
ie_regime_contr_w			varchar(5);

c01 CURSOR FOR 
SELECT	a.cd_pessoa_fisica 
from	com_canal_consultor_v a 
where	a.cd_empresa		= cd_empresa_p 
and	a.ie_situacao		= 'A' 
and	a.ie_regime_contr	= ie_regime_contr_w 
and	not exists ( SELECT	1 
		  from	proj_rat_mes y 
		  where	trunc(y.dt_mes)		= trunc(dt_mes_p) 
		  and		a.ie_regime_contr	= ie_regime_contr_w 
		  and		y.cd_executor		= a.cd_pessoa_fisica) 
and 	exists ( select	1 
		 from	proj_rat_v h 
		 where	coalesce(h.NR_SEQ_FECH_MES::text, '') = '' 
		 and	(h.dt_aprov_fin IS NOT NULL AND h.dt_aprov_fin::text <> '') 
		 and	h.cd_executor = a.cd_pessoa_fisica);


BEGIN 
 
ie_regime_contr_w	:= upper(ie_regime_contr_p);
open C01;
loop 
fetch C01 into	 
	cd_executor_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	nr_seq_fechamento_w := gerar_proj_rat_mes(dt_mes_p, cd_executor_w, nr_seq_fechamento_w, ie_regime_contr_w, nm_usuario_p);
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proj_gerar_fechamento_mes_clt (cd_empresa_p bigint, dt_mes_p timestamp, ie_regime_contr_p text, nm_usuario_p text) FROM PUBLIC;

