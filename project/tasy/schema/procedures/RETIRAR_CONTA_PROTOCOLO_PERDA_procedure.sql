-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE retirar_conta_protocolo_perda ( nr_interno_conta_p bigint, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE

 
 
ds_nota_conta_w		varchar(100) := null;
ds_titulo_conta_w	varchar(100) := null;
ie_proc_mat_w		smallint;
nr_sequencia_w		bigint;
nr_seq_partic_w		bigint;
nr_seq_proc_w		bigint;
vl_item_w		double precision;
vl_medico_w		double precision;
vl_anestesista_w	double precision;
vl_filme_w		double precision;
vl_auxiliares_w		double precision;
vl_custo_operacional_w	double precision;
nr_seq_protocolo_w	bigint;

C01 CURSOR FOR 
	SELECT	nr_sequencia, 
		ie_proc_mat 
	from	conta_paciente_valor_v 
	where	nr_interno_conta = nr_interno_conta_p 
	order by ie_proc_mat, 
		nr_sequencia;


BEGIN 
 
select	max(substr(obter_nf_conta(nr_interno_conta,2),1,100)) 
into STRICT	ds_nota_conta_w 
from	conta_paciente 
where	nr_interno_conta = nr_interno_conta_p;
 
if (ds_nota_conta_w <> '') then 
	select	max(substr(obter_titulo_conta_protocolo(0, nr_interno_conta),1,100)) 
	into STRICT	ds_titulo_conta_w 
	from	conta_paciente 
	where	nr_interno_conta = nr_interno_conta_p;
end if;
 
 
if (coalesce(ds_nota_conta_w::text, '') = '') and (coalesce(ds_titulo_conta_w::text, '') = '') then 
	ds_erro_p	:= '';
	 
	select	coalesce(max(nr_seq_protocolo),0) 
	into STRICT	nr_seq_protocolo_w 
	from	conta_paciente 
	where	nr_interno_conta = nr_interno_conta_p;
	 
	update	conta_paciente 
	set	nr_seq_protocolo  = NULL, 
		nr_protocolo = '0', 
		nm_usuario = nm_usuario_p, 
		dt_atualizacao = clock_timestamp() 
	where	nr_interno_conta = nr_interno_conta_p;
	 
	open C01;
	loop 
	fetch C01 into	 
		nr_sequencia_w, 
		ie_proc_mat_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		 
		if (ie_proc_mat_w = 1) then 
		 
			select	coalesce(max(vl_procedimento),0), 
				coalesce(max(vl_medico),0), 
				coalesce(max(vl_anestesista),0), 
				coalesce(max(vl_materiais),0), 
				coalesce(max(vl_auxiliares),0), 
				coalesce(max(vl_custo_operacional),0) 
			into STRICT	vl_item_w, 
				vl_medico_w, 
				vl_anestesista_w, 
				vl_filme_w, 
				vl_auxiliares_w, 
				vl_custo_operacional_w 
			from	proc_paciente_valor 
			where	nr_seq_procedimento = nr_sequencia_w 
			and	ie_tipo_valor = 4;
		 
			update	procedimento_paciente 
			set	vl_procedimento		= vl_item_w, 
				vl_medico		= vl_medico_w, 
				vl_anestesista		= vl_anestesista_w, 
				vl_materiais		= vl_filme_w, 
				vl_auxiliares		= vl_auxiliares_w, 
				vl_custo_operacional	= vl_custo_operacional_w, 
				nm_usuario		= nm_usuario_p, 
				dt_atualizacao		= clock_timestamp() 
			where 	nr_sequencia = nr_sequencia_w;
					 
		elsif (ie_proc_mat_w = 2) then 
		 
			update	material_atend_paciente 
			set	vl_material		= vl_tabela_original, 
				nm_usuario		= nm_usuario_p, 
				dt_atualizacao		= clock_timestamp()				 
			where 	nr_sequencia = nr_sequencia_w;
		 
		end if;
		 
		end;
	end loop;
	close C01;
	 
	commit; -- Precisa ter o commit para a atualização do resumo da conta 
	
	CALL Atualizar_resumo_conta(nr_interno_conta_p,2);
	 
	/*insert into logxxxxx_tasy (cd_log, ds_log, dt_atualizacao, nm_usuario) 
				values (105, 'Conta ' || nr_interno_conta_p || 
					' retirada do protocolo ' || nr_seq_protocolo_w || 
					' através da opção Retirar conta protocolo perda.', sysdate, nm_usuario_p);*/
 
else 
	ds_erro_p	:= nr_interno_conta_p || ', ';
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE retirar_conta_protocolo_perda ( nr_interno_conta_p bigint, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

