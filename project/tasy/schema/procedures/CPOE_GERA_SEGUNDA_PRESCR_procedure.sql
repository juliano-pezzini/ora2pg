-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gera_segunda_prescr ( ds_itens_liberar_p text, nr_atendimento_p atendimento_paciente.nr_atendimento%type, dt_referencia_p timestamp, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type, nm_usuario_p usuario.nm_usuario%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, ie_copia_diaria_p char, ie_interv_farmacia_p text, ds_itens_retorno_p INOUT text, ie_adep_p text default 'S', nr_prescricao_out_p INOUT bigint DEFAULT NULL) AS $body$
DECLARE

			
nr_seq_reg_item_w				bigint;
ie_opcao_prescr_ww				varchar(2000);
ie_opcao_prescr_w				varchar(255);
item_w							varchar(255);
ie_adiciona_w					varchar(2);
dt_referencia_w					timestamp := dt_referencia_p;
ds_itens_liberados_w			varchar(4000):=null;
ds_itens_liberados_ww			varchar(4000):=null;
nr_prescricao_ww 				prescr_medica.nr_prescricao%type;
cd_pf_usuario_w					pessoa_fisica.cd_pessoa_fisica%type;
ie_usuario_medico_w				varchar(1):= 'N';
ie_origem_inf_w					prescr_medica.ie_origem_inf%type;
ds_erro_w						varchar(2000);
dt_programada_w					timestamp;



BEGIN

	ie_opcao_prescr_ww := ds_itens_liberar_p;
		
	while(ie_opcao_prescr_ww IS NOT NULL AND ie_opcao_prescr_ww::text <> '') loop
		ie_adiciona_w := 'S';
		dt_referencia_w	:= dt_referencia_p;

		if (position(';' in ie_opcao_prescr_ww) = 0) and (ie_opcao_prescr_ww IS NOT NULL AND ie_opcao_prescr_ww::text <> '') then
			ie_opcao_prescr_ww	:= ie_opcao_prescr_ww||';';
		end if;	
		item_w := substr(ie_opcao_prescr_ww, 1, position(';' in ie_opcao_prescr_ww) - 1);
		ie_opcao_prescr_w := substr(item_w, 1, position(',' in item_w) - 1);
		nr_seq_reg_item_w := (substr(item_w, position(',' in item_w) + 1, length(item_w)))::numeric;
		ie_opcao_prescr_ww := substr(ie_opcao_prescr_ww, position(';' in ie_opcao_prescr_ww) + 1, length(ie_opcao_prescr_ww));
				
		if (ie_opcao_prescr_w = 'H') then
		
			select	max(dt_programada)
			into STRICT	dt_programada_w
			from	cpoe_hemoterapia
			where	nr_sequencia = nr_seq_reg_item_w;
		
			if ((position(ie_opcao_prescr_w in ds_itens_liberados_w) > 0) or (dt_programada_w > dt_referencia_p +1)) then
				ie_adiciona_w := 'N';
				ds_itens_liberados_ww := ie_opcao_prescr_w||','||nr_seq_reg_item_w||';';
				
				if (dt_programada_w > dt_referencia_p + 1) then
					dt_referencia_w := dt_programada_w;
				end if;

				nr_prescricao_ww := cpoe_gerar_prescricao_rep(nr_atendimento_p, dt_referencia_w, cd_estabelecimento_p, cd_perfil_p, cd_setor_atendimento_p, nm_usuario_p, ds_itens_liberados_ww, cd_pessoa_fisica_p, coalesce(ie_copia_diaria_p,'N'), ie_interv_farmacia_p, 'N', null, null, null, null, 'N', null, null, null, null, null, null, 'N', ie_adep_p);

				if (coalesce(ie_copia_diaria_p,'N') = 'N') then
					
					select 	max(a.cd_pessoa_fisica)
					into STRICT	cd_pf_usuario_w
					from	usuario a
					where	a.nm_usuario = nm_usuario_p;		
					
					ie_usuario_medico_w := 'N';
					if (cd_pf_usuario_w IS NOT NULL AND cd_pf_usuario_w::text <> '') then

						select	coalesce(max('1'),'3')
						into STRICT	ie_origem_inf_w
						from	medico
						where	cd_pessoa_fisica	= cd_pf_usuario_w
						and	coalesce(ie_situacao,'A') = 'A';
						
						if (ie_origem_inf_w = '1') then
							ie_usuario_medico_w := 'S';
						end if;
					end if;
					ds_erro_w := Liberar_prescricao(nr_prescricao_ww, nr_atendimento_p, ie_usuario_medico_w, cd_perfil_p, nm_usuario_p, 'S', ds_erro_w);
					nr_prescricao_out_p := nr_prescricao_ww;
				end if;
			end if;
		end if;
		
		if (ie_adiciona_w = 'S') then
			ds_itens_liberados_w :=  ds_itens_liberados_w || ie_opcao_prescr_w||','||nr_seq_reg_item_w||';';
		end if;

	end loop;

	ds_itens_retorno_p := ds_itens_liberados_w;


exception when others then
		CALL gravar_log_cpoe(substr('CPOE_GERA_SEGUNDA_PRESCR EXCEPTION:' || substr(to_char(sqlerrm),1,2000)
			   ||'//ds_itens_liberar_p: '|| ds_itens_liberar_p
			   ||'nr_atendimento_p : '|| nr_atendimento_p	
			   ||'dt_referencia_p : '|| to_char(dt_referencia_p, 'dd/mm/yyyy hh24:mi:ss')
			   ||'cd_estabelecimento_p : '|| cd_estabelecimento_p
			   ||'cd_perfil_p :'|| cd_perfil_p 
			   ||'nm_usuario_p : '|| nm_usuario_p
			   ||'cd_pessoa_fisica_p : '|| cd_pessoa_fisica_p
			   ||'ie_copia_diaria_p : '|| ie_copia_diaria_p
			   ||'ie_interv_farmacia_p : '|| ie_interv_farmacia_p
			   ||'ds_itens_retorno_p :'|| ds_itens_retorno_p,1,2000),
				nr_atendimento_p);
	ds_itens_retorno_p := ds_itens_liberar_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gera_segunda_prescr ( ds_itens_liberar_p text, nr_atendimento_p atendimento_paciente.nr_atendimento%type, dt_referencia_p timestamp, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type, nm_usuario_p usuario.nm_usuario%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, ie_copia_diaria_p char, ie_interv_farmacia_p text, ds_itens_retorno_p INOUT text, ie_adep_p text default 'S', nr_prescricao_out_p INOUT bigint DEFAULT NULL) FROM PUBLIC;

