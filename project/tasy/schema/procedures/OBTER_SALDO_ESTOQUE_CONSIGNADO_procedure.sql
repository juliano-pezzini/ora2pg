-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_saldo_estoque_consignado ( cd_estabelecimento_p bigint, cd_cgc_fornec_p text, cd_material_p bigint, cd_local_estoque_p bigint, dt_mesano_referencia_p timestamp, qt_estoque_p INOUT bigint) AS $body$
DECLARE


cd_estabelecimento_w			smallint;
cd_material_w				integer;
dt_mesano_referencia_w		timestamp;


BEGIN

cd_estabelecimento_w	:= cd_estabelecimento_p;
select 	coalesce(m.cd_material_estoque, m.cd_material)
into STRICT		cd_material_w
from 		material m
where 	m.cd_material	= cd_material_p;

begin
select	max(f.dt_mesano_referencia)
into STRICT	dt_mesano_referencia_w
from 	fornecedor_mat_consignado f
where	f.cd_fornecedor		= cd_cgc_fornec_p
  and 	f.cd_estabelecimento		= cd_estabelecimento_w
  and	f.cd_local_estoque		= coalesce(cd_local_estoque_p,  f.cd_local_estoque)
  and 	f.cd_material			= cd_material_w;
exception
	when others then
		dt_mesano_referencia_w	:= PKG_DATE_UTILS.start_of(clock_timestamp(), 'MONTH', 0);
end;

begin
Select 	f.qt_estoque
into STRICT	qt_estoque_p
from 	fornecedor_mat_consignado f
where 	f.cd_fornecedor		= cd_cgc_fornec_p
  and 	f.cd_estabelecimento		= cd_estabelecimento_w
  and 	f.cd_material			= cd_material_w
  and	f.cd_local_estoque		= coalesce(cd_local_estoque_p, f.cd_local_estoque)
  and 	f.dt_mesano_referencia		= dt_mesano_referencia_w;
exception
	    when others then
		 	qt_estoque_p		:= 0;
end;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_saldo_estoque_consignado ( cd_estabelecimento_p bigint, cd_cgc_fornec_p text, cd_material_p bigint, cd_local_estoque_p bigint, dt_mesano_referencia_p timestamp, qt_estoque_p INOUT bigint) FROM PUBLIC;

