-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_processar_protocolo_imp ( nr_seq_protocolo_p pls_protocolo_conta_imp.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

					 
/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade:  Consistir a conta no complemento de contas médicas e gera resumo de importação do XML. 
---------------------------------------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[ ] Objetos do dicionário [ X] Tasy (Delphi/Java) [ ] Portal [ ] Relatórios [ ] Outros: 
 ---------------------------------------------------------------------------------------------------------------------------------------------------- 
Pontos de atenção:  
 
Alterações: 
*/ 
 
qt_ocor_ativas_w	integer := 0;

c01 CURSOR(nr_seq_protocolo_pc pls_protocolo_conta_imp.nr_sequencia%type) FOR 
	SELECT	a.nr_sequencia nr_seq_mat, 
		b.nr_sequencia nr_seq_conta 
	from	pls_conta_imp b, 
		pls_conta_mat_imp a 
	where	b.nr_seq_protocolo = nr_seq_protocolo_pc 
	and	a.nr_seq_conta	= b.nr_sequencia;
	
c02 CURSOR(nr_seq_protocolo_pc pls_protocolo_conta_imp.nr_sequencia%type) FOR 
	SELECT	a.nr_sequencia nr_seq_proc, 
		b.nr_sequencia nr_seq_conta 
	from	pls_conta_imp b, 
		pls_conta_proc_imp a 
	where	b.nr_seq_protocolo = nr_seq_protocolo_pc 
	and	a.nr_seq_conta	= b.nr_sequencia;
	
c03 CURSOR(nr_seq_protocolo_pc pls_protocolo_conta_imp.nr_sequencia%type) FOR 
	SELECT	b.nr_sequencia nr_seq_conta 
	from	pls_conta_imp b 
	where	b.nr_seq_protocolo = nr_seq_protocolo_pc;


BEGIN 
CALL wheb_usuario_pck.set_nm_usuario(nm_usuario_p);
 
-- se for para usar a nova forma de importação XML chama da package, caso contrário chama a rotina antiga 
if (pls_imp_xml_cta_pck.usar_nova_imp_xml(cd_estabelecimento_p) = 'S') then 
	-- rotinas novas 
	CALL pls_conv_xml_cta_pck.pls_conv_dados_para_tasy(nr_seq_protocolo_p,nm_usuario_p,cd_estabelecimento_p);
	 
	-- Verifica a forma de validação, se for por protocolo ou a origem é webservice, irá gerar as ocorrencias combinadas (forma padrão) 
	-- Se for por lote e não for webservice, o protocolo ficará como "Ev - Em validação", e não será gerada a ocorrencia combinada neste momento, ela 
	-- deverá ser chamada manualmente pelo usuário 
	if	((pls_obter_param_imp_cta(cd_estabelecimento_p, 'FV') = 'L') and (nm_usuario_p != 'WebService')) then 
 
		-- embora as ocorrencias não são geradas neste momento, ainda é necessário geras os dados relacionados as contas do resumo 
		CALL pls_conv_xml_cta_pck.pls_gerar_resumo_prot_imp(nr_seq_protocolo_p,nm_usuario_p);
		--atualiza o status do protocolo para " Em Validação" 
		CALL pls_int_xml_cta_pck.pls_atualiza_lote_prot_em_val(nr_seq_protocolo_p, nm_usuario_p);
		 
	else -- funcionamento "Padrão" 
		--gera as ocorrências combinadas 
		CALL pls_oc_cta_gerar_combinada_imp(	null, nr_seq_protocolo_p, null, 
						null, null, null, 
						null, null, null, 
						null, cd_estabelecimento_p, nm_usuario_p);
		--gera o resumo de ocorrências e contas do protocolo				 
		CALL pls_conv_xml_cta_pck.pls_gerar_resumo_prot_imp(nr_seq_protocolo_p,nm_usuario_p);
		--atualiza o status do protocolo para ACEITO 
		CALL pls_int_xml_cta_pck.pls_atualiza_lote_prot_aceito(nr_seq_protocolo_p, nm_usuario_p);
		 
		if (nm_usuario_p = 'WebService') then 
			CALL pls_int_xml_cta_pck.pls_integra_lote_webservice(nr_seq_protocolo_p, cd_estabelecimento_p, nm_usuario_p);
		end if;
	end if;
else 
	-- rotinas antigas 
	CALL pls_gerar_conta(nr_seq_protocolo_p,nm_usuario_p);
	CALL pls_gerar_resumo_importacao(nr_seq_protocolo_p,nm_usuario_p);
end if;
 
--Após processar geração de contas no caso da nova importação do XML as conversões nevessárias, atualiza situação do prototocolo para rejeitado no caso de existir alguma ocorrência ativa 
--Apenas se for para usar a nova forma de importação XML. Obs: Basta verificar ocorrência por sequência das contas, mesmo que for ocorrência a nível de ítem irá cair no select 
if (pls_imp_xml_cta_pck.usar_nova_imp_xml(cd_estabelecimento_p) = 'S') then 
 
	CALL pls_int_xml_cta_pck.verifica_ocor_ativa_prot(nr_seq_protocolo_p,nm_usuario_p);
 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_processar_protocolo_imp ( nr_seq_protocolo_p pls_protocolo_conta_imp.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

