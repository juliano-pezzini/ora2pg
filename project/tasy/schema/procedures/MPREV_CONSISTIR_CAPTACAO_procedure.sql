-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mprev_consistir_captacao ( nr_seq_demanda_espont_p bigint, nr_seq_indicacao_p bigint, nm_usuario_p text, ds_retorno_p INOUT text, ie_abortar_confirm_p INOUT text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:  Consistir confirmação de espontânea ou captação, para identificar se a mesma está duplicada
ou se a pessoa já está em algum dos programas indicados.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [ X] Tasy (Delphi/Java) [ X] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:

ie_abortar_confirm:
A - Abortar
C - Confirmar
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
nr_seq_programa_w		mprev_programa.nr_sequencia%type;
nr_seq_campanha_w		mprev_campanha.nr_sequencia%type;
nr_seq_programa_partic_w	mprev_programa_partic.nr_seq_programa%type;
nr_seq_campanha_partic_w	mprev_campanha_partic.nr_seq_campanha%type;
nm_programa_w			mprev_programa.nm_programa%type;
nm_campanha_w			mprev_campanha.nm_campanha%type;
qt_registro_w			bigint;
ds_retorno_w			varchar(255)	:= null;
ie_abortar_confirm_w		varchar(1)	:= null;


BEGIN

if (nr_seq_demanda_espont_p IS NOT NULL AND nr_seq_demanda_espont_p::text <> '') then

	/* Codigo Pessoa Fisica  Captacao, demanda espontanea*/

	select	a.cd_pessoa_fisica
	into STRICT	cd_pessoa_fisica_w
	from 	mprev_demanda_espont a
	where 	a.nr_sequencia = nr_seq_demanda_espont_p;

	/* RN01 - Pessoa só pode ter captação pendente uma vez para determinado programa ou campanha */

	select	max(b.nr_seq_programa)
	into STRICT	nr_seq_programa_w
	from	mprev_captacao_destino b,
		mprev_captacao a
	where	a.nr_sequencia = b.nr_seq_captacao
	and	(b.nr_seq_programa IS NOT NULL AND b.nr_seq_programa::text <> '')
	and	a.nr_seq_demanda_espont = nr_seq_demanda_espont_p
	and	exists (SELECT	1
			from	mprev_captacao_destino y,
				mprev_captacao x
			where	x.nr_sequencia = y.nr_seq_captacao
			and	y.nr_seq_programa = b.nr_seq_programa
			and	x.cd_pessoa_fisica = a.cd_pessoa_fisica
			and	coalesce(x.nr_seq_demanda_espont,0) <> nr_seq_demanda_espont_p
			and	x.ie_status in ('P','T'));

	/* RN02 - Pessoa só pode ter captação aceita para participar uma vez para determinado programa ou campanha */

	select	max(b.nr_seq_programa)
	into STRICT 	nr_seq_programa_partic_w
	from  	mprev_captacao_destino b,
		mprev_captacao a
	where 	a.nr_sequencia = b.nr_seq_captacao
	and     (b.nr_seq_programa IS NOT NULL AND b.nr_seq_programa::text <> '')
	and   	a.nr_seq_demanda_espont = nr_seq_demanda_espont_p
	and 	exists (SELECT  1
			from    mprev_programa_partic x,
				mprev_participante y
			where   y.nr_sequencia = x.nr_seq_participante
			and     x.nr_seq_programa = b.nr_seq_programa
			and     y.cd_pessoa_fisica = a.cd_pessoa_fisica
			and     clock_timestamp() between x.dt_inclusao and coalesce(x.dt_exclusao,clock_timestamp()));

	if (nr_seq_programa_w IS NOT NULL AND nr_seq_programa_w::text <> '') then
		select	a.nm_programa
		into STRICT	nm_programa_w
		from	mprev_programa a
		where	a.nr_sequencia = nr_seq_programa_w;

		ds_retorno_w	:= wheb_mensagem_pck.get_texto(318766,'NM_PROGRAMA=' || nm_programa_w || ';'); --'A pessoa já foi indicada para o programa ' || nm_programa_w || ' e está pendente de análise, por favor desmarque esse programa.
		ie_abortar_confirm_w := 'A';

	elsif (nr_seq_programa_partic_w IS NOT NULL AND nr_seq_programa_partic_w::text <> '') then
		select nm_programa
		into STRICT nm_programa_w
		from mprev_programa
		where nr_sequencia = nr_seq_programa_partic_w;

		ds_retorno_w	:= wheb_mensagem_pck.get_texto(318783,'NM_PROGRAMA=' || nm_programa_w || ';'); --'A pessoa já se encontra atualmente no programa ' || nm_programa_w || ', por favor desmarque esse programa.
		ie_abortar_confirm_w := 'A';
	end if;

	select	max(b.nr_seq_campanha)
	into STRICT	nr_seq_campanha_w
	from	mprev_captacao_destino b,
		mprev_captacao a
	where	a.nr_sequencia = b.nr_seq_captacao
	and	(b.nr_seq_campanha IS NOT NULL AND b.nr_seq_campanha::text <> '')
	and	a.nr_seq_demanda_espont = nr_seq_demanda_espont_p
	and	exists (SELECT	1
			from	mprev_captacao_destino y,
				mprev_captacao x
			where	x.nr_sequencia = y.nr_seq_captacao
			and	y.nr_seq_campanha = b.nr_seq_campanha
			and	x.cd_pessoa_fisica = a.cd_pessoa_fisica
			and	coalesce(x.nr_seq_demanda_espont,0) <> nr_seq_demanda_espont_p
			and	x.ie_status in ('P','T'));

	select	max(b.nr_seq_campanha)
	into STRICT	nr_seq_campanha_partic_w
	from  	mprev_captacao_destino b,
		mprev_captacao a
	where 	a.nr_sequencia = b.nr_seq_captacao
	and     (b.nr_seq_campanha IS NOT NULL AND b.nr_seq_campanha::text <> '')
	and   	a.nr_seq_demanda_espont = nr_seq_demanda_espont_p
	and 	exists (SELECT  1
			from    mprev_campanha_partic x,
				mprev_participante y
			where   y.nr_sequencia = x.nr_seq_participante
			and     x.nr_seq_campanha = b.nr_seq_campanha
			and     y.cd_pessoa_fisica = a.cd_pessoa_fisica
			and     clock_timestamp() between x.dt_inclusao and coalesce(x.dt_exclusao,clock_timestamp()));


	if (nr_seq_campanha_w IS NOT NULL AND nr_seq_campanha_w::text <> '') then
		select	a.nm_campanha
		into STRICT	nm_campanha_w
		from	mprev_campanha a
		where	a.nr_sequencia = nr_seq_campanha_w;

		ds_retorno_w	:= wheb_mensagem_pck.get_texto(318769,'NM_CAMPANHA=' || nm_campanha_w || ';'); --'A pessoa já foi indicada para a campanha ' || nm_campanha_w || ' e está pendente de análise, por favor desmarque essa campanha.
		ie_abortar_confirm_w := 'A';

	elsif (nr_seq_campanha_partic_w IS NOT NULL AND nr_seq_campanha_partic_w::text <> '') then
		select nm_campanha
		into STRICT nm_campanha_w
		from mprev_campanha
		where nr_sequencia = nr_seq_campanha_partic_w;

		ds_retorno_w	:= wheb_mensagem_pck.get_texto(318787,'NM_CAMPANHA=' || nm_campanha_w || ';'); --'A pessoa já se encontra atualmente na campanha ' || nm_campanha_w || ', por favor desmarque essa campanha.
		ie_abortar_confirm_w := 'A';
	end if;

elsif (nr_seq_indicacao_p IS NOT NULL AND nr_seq_indicacao_p::text <> '') then
	/* Codigo pessoa fisica captacao, indicação*/

	select 	cd_pessoa_fisica
	into STRICT	cd_pessoa_fisica_w
	from 	mprev_indicacao_paciente
	where 	nr_sequencia = nr_seq_indicacao_p;

	select	max(b.nr_seq_programa)
	into STRICT	nr_seq_programa_w
	from	mprev_captacao_destino b,
		mprev_captacao a
	where	a.nr_sequencia = b.nr_seq_captacao
	and	(b.nr_seq_programa IS NOT NULL AND b.nr_seq_programa::text <> '')
	and	a.nr_seq_indicacao = nr_seq_indicacao_p
	and	exists (SELECT	1
			from	mprev_captacao_destino y,
				mprev_captacao x
			where	x.nr_sequencia = y.nr_seq_captacao
			and	y.nr_seq_programa = b.nr_seq_programa
			and	x.cd_pessoa_fisica = a.cd_pessoa_fisica
			and	coalesce(x.nr_seq_indicacao,0) <> nr_seq_indicacao_p
			and	x.ie_status in ('P','T'));

	select	max(b.nr_seq_programa)
	into STRICT 	nr_seq_programa_partic_w
	from  	mprev_captacao_destino b,
		mprev_captacao a
	where 	a.nr_sequencia = b.nr_seq_captacao
	and     (b.nr_seq_programa IS NOT NULL AND b.nr_seq_programa::text <> '')
	and   	a.nr_seq_indicacao = nr_seq_indicacao_p
	and 	exists (SELECT  1
			from    mprev_programa_partic x,
				mprev_participante y
			where   y.nr_sequencia = x.nr_seq_participante
			and     x.nr_seq_programa = b.nr_seq_programa
			and     y.cd_pessoa_fisica = a.cd_pessoa_fisica
			and     clock_timestamp() between x.dt_inclusao and coalesce(x.dt_exclusao,clock_timestamp()));


	if (nr_seq_programa_w IS NOT NULL AND nr_seq_programa_w::text <> '') then
		select	a.nm_programa
		into STRICT	nm_programa_w
		from	mprev_programa a
		where	a.nr_sequencia = nr_seq_programa_w;

		ds_retorno_w	:= wheb_mensagem_pck.get_texto(318766,'NM_PROGRAMA=' || nm_programa_w || ';'); --'A pessoa já foi indicada para o programa ' || nm_programa_w || ' e está pendente de análise, por favor desmarque esse programa.
		ie_abortar_confirm_w := 'A';

	elsif (nr_seq_programa_partic_w IS NOT NULL AND nr_seq_programa_partic_w::text <> '') then
		select nm_programa
		into STRICT nm_programa_w
		from mprev_programa
		where nr_sequencia = nr_seq_programa_partic_w;

		ds_retorno_w	:= wheb_mensagem_pck.get_texto(318783,'NM_PROGRAMA=' || nm_programa_w || ';'); --'A pessoa já se encontra atualmente no programa ' || nm_programa_w || ', por favor desmarque esse programa.
		ie_abortar_confirm_w := 'A';

	end if;

	select	max(b.nr_seq_campanha)
	into STRICT	nr_seq_campanha_w
	from	mprev_captacao_destino b,
		mprev_captacao a
	where	a.nr_sequencia = b.nr_seq_captacao
	and	(b.nr_seq_campanha IS NOT NULL AND b.nr_seq_campanha::text <> '')
	and	a.nr_seq_indicacao = nr_seq_indicacao_p
	and	exists (SELECT	1
			from	mprev_captacao_destino y,
				mprev_captacao x
			where	x.nr_sequencia = y.nr_seq_captacao
			and	y.nr_seq_campanha = b.nr_seq_campanha
			and	x.cd_pessoa_fisica = a.cd_pessoa_fisica
			and	coalesce(x.nr_seq_indicacao,0) <> nr_seq_indicacao_p
			and	x.ie_status in ('P','T'));

	select	max(b.nr_seq_campanha)
	into STRICT	nr_seq_campanha_partic_w
	from  	mprev_captacao_destino b,
		mprev_captacao a
	where 	a.nr_sequencia = b.nr_seq_captacao
	and     (b.nr_seq_campanha IS NOT NULL AND b.nr_seq_campanha::text <> '')
	and   	a.nr_seq_indicacao = nr_seq_indicacao_p
	and 	exists (SELECT  1
			from    mprev_campanha_partic x,
				mprev_participante y
			where   y.nr_sequencia = x.nr_seq_participante
			and     x.nr_seq_campanha = b.nr_seq_campanha
			and     y.cd_pessoa_fisica = a.cd_pessoa_fisica
			and     clock_timestamp() between x.dt_inclusao and coalesce(x.dt_exclusao,clock_timestamp()));

	if (nr_seq_campanha_w IS NOT NULL AND nr_seq_campanha_w::text <> '') then
		select	a.nm_campanha
		into STRICT	nm_campanha_w
		from	mprev_campanha a
		where	a.nr_sequencia = nr_seq_campanha_w;

		ds_retorno_w	:= wheb_mensagem_pck.get_texto(318769,'NM_CAMPANHA=' || nm_campanha_w || ';'); --'A pessoa já foi indicada para a campanha ' || nm_campanha_w || ' e está pendente de análise, por favor desmarque essa campanha.
		ie_abortar_confirm_w := 'A';

	elsif (nr_seq_campanha_partic_w IS NOT NULL AND nr_seq_campanha_partic_w::text <> '') then
		select nm_campanha
		into STRICT nm_campanha_w
		from mprev_campanha
		where nr_sequencia = nr_seq_campanha_partic_w;

		ds_retorno_w	:= wheb_mensagem_pck.get_texto(318787,'NM_CAMPANHA=' || nm_campanha_w || ';'); --'A pessoa já se encontra atualmente na campanha ' || nm_campanha_w || ', por favor desmarque essa campanha.
		ie_abortar_confirm_w := 'A';

	end if;

end if;

ds_retorno_p		:= ds_retorno_w;
ie_abortar_confirm_p	:= ie_abortar_confirm_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mprev_consistir_captacao ( nr_seq_demanda_espont_p bigint, nr_seq_indicacao_p bigint, nm_usuario_p text, ds_retorno_p INOUT text, ie_abortar_confirm_p INOUT text) FROM PUBLIC;

