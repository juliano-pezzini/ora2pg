-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hcc_int_prescr_tasy_lab_ext ( nr_prescricao_p bigint, dir_p text, nm_arquivo_p text) AS $body$
DECLARE

arq_texto_w						utl_file.file_type;
linha_w							varchar(3);
nr_sequencia_w			varchar(4);
nr_prescricao_w			varchar(15);
nr_prontuario_w			varchar(15);
dt_criacao_w			varchar(8);
hr_criacao_w			varchar(4);
nm_paciente_w			varchar(45);
dt_nascimento_w			varchar(8);
ie_sexo_w			varchar(1);
nr_identidade_w			varchar(15);
cd_orgao_expedidor_w		varchar(15);
ds_endereco_w			varchar(100);
ds_complemento_w		varchar(15);
nm_cidade_w			varchar(20);
ds_bairro_w			varchar(15);
ds_estado_w			varchar(2);
nr_cep_w			varchar(8);
nr_ddd_tel_res_w		varchar(5);
nr_prefix_tel_res_w		varchar(5);
nr_sufix_tel_res_w		varchar(5);
nr_ramal_res_w			varchar(5);
nr_ddd_tel_com_w		varchar(5);
nr_prefix_tel_com_w		varchar(5);
nr_sufix_tel_com_w		varchar(5);
nr_ramal_com_w			varchar(5);
nr_ddd_tel_celular_w		varchar(5);
nr_prefix_telefone_celular_w	varchar(5);
nr_sufix_telefone_celular_w	varchar(5);
ds_email_w			varchar(50);
dt_cadastro_cliente_w		varchar(8);
hr_cadastro_cliente_w		varchar(8);
nr_cartao_nac_sus_w		varchar(15);
nm_pai_w			varchar(60);
nm_mae_w			varchar(60);
hr_prescricao_w			varchar(8);
dt_prescricao_w			varchar(8);
cd_unidade_basica_w		varchar(5);
cd_unidade_compl_w		varchar(10);
dt_mestruacao_w			varchar(8);
qt_altura_w			varchar(3);
qt_peso_w			varchar(6);
ds_observacao_w			varchar(4000);
cd_convenio_w			varchar(4);
cd_usuario_convenio_w		varchar(15);
dt_ultimo_pagto_w		varchar(8);
dt_validade_carteira_w		varchar(8);
ds_empresa_tit_w		varchar(40);
cd_mat_tit_conv_w 		varchar(20);
nm_tit_convenio_w		varchar(40);
ds_dma_w			varchar(9);
ds_suct_w			varchar(18);
ds_grau_parentesco_w		varchar(1);
ds_plano_convenio_w		varchar(15);
nr_Seq_cliente_w		varchar(8);
ds_tipo_cliente_w		varchar(15);
ds_unidade_tit_w		varchar(25);
sg_conselho_w			varchar(4);
nr_crm_w			varchar(6);
uf_crm_w			varchar(2);
nm_pessoa_fisica_w		varchar(40);
ie_sexo_prof_w			varchar(1);
cd_convenio_solic_w		varchar(4);
nm_exame_w			varchar(5);
cd_senha_w			varchar(15);
nr_guia_w			varchar(20);
sg_conselho_solic_w		varchar(4);
nr_crm_solic_w			varchar(6);
uf_crm_solic_w			varchar(2);
ds_cid_w			varchar(2);
ds_grupo_cid_w			varchar(5);
nr_sequencia_solic_w		varchar(2);
nr_guia_tiss_w			varchar(21);
sg_sigla_w			varchar(4);
nr_crm_tiss_w			varchar(7);
uf_crm_tiss_w			varchar(2);
cd_cbo_w			varchar(5);
cd_cbes_w			varchar(7);
cd_cnpj_w			varchar(24);
dt_autorizacao_w		varchar(8);
dt_emissao_w			varchar(8);
dt_solicitacao_w		varchar(8);
hr_solicitacao_w		varchar(8);
nm_solicitante_w		varchar(70);
nr_guia_princ_w			varchar(20);
cd_senha_tiss_w			varchar(20);
dt_validade_senha_w		varchar(8);
ds_indicacao_clinica_w		varchar(4000);
qt_exames_w			bigint;

nm_usuario_cor_const_w		varchar(100) := 'IntLabExt';
ie_setor_prescricao_w		varchar(1);

qt_total_w			bigint;
nr_Sequencia_aux_w		bigint;
c01 CURSOR FOR
	SELECT	'SLC' linha,
		substr(rpad((nr_sequencia_aux_w+(rownum-1)),4,' '),1,4) nr_sequencia,
		substr(rpad(coalesce(to_char(
			obter_conversao_externa(OBTER_CGC_CONVENIO(obter_convenio_atendimento(d.nr_atendimento)), 'CONVENIO','CD_CONVENIO', obter_convenio_atendimento(d.nr_atendimento))
		),' '),4,' '),1,4) cd_convenio_solic,
			substr(rpad(coalesce((SELECT	max(x.cd_exame_integracao)
				from	exame_laboratorio x
				where	a.nr_seq_exame = x.nr_Seq_Exame),' '),5,' '),1,5) nm_exame,
		substR(rpad(coalesce(to_char(a.cd_senha),' '),15,' '),1,15) cd_senha,
		substr(rpad(coalesce(to_char(obter_guia_convenio(d.nr_atendimento)),' '),20,'0'),1,20) nr_guia,
		substr(rpad(coalesce(to_char(OBTER_CONSELHO_PROFISSIONAL((select x.nr_seq_conselho from pessoa_fisica x where x.cd_pessoa_fisica = b.cd_medico_resp), 'S')),' '),4,' '),1,4) sg_conselho_solic,
		substr(rpad(coalesce(to_char(obter_crm_medico(b.cd_medico_resp)),' '),6,' '),1,6) nr_crm_solic,
		substr(rpad(coalesce(to_char((select max(b.uf_crm) from medico b where b.cd_pessoa_fisica = d.cd_medico)),' '),2,' '),1,2) uf_crm_solic,
		substr(rpad(coalesce(
		(select	ELIMINA_CARACTERES_ESPECIAIS(coalesce(max(b.ds_doenca_cid),null))
		from 	cid_doenca b
		where	b.cd_doenca_cid = 	(select	max(c.cd_doenca)
						from	diagnostico_doenca c
						where	c.nr_atendimento = d.nr_atendimento
						and	c.dt_diagnostico = (select max(e.dt_diagnostico)
									from	diagnostico_medico e
									where	e.nr_atendimento	= c.nr_atendimento)))
		,' '),2,' '),1,2) ds_cid,
		substr(lpad(' ',5,' '),1,5) ds_grupo_cid,
		substr(rpad(coalesce(to_char(a.nr_sequencia),' '),2,' '),1,2) nr_Sequencia_solic
	from	prescr_procedimento a,
		prescr_medica d,
		atendimento_paciente b
	where	a.nr_prescricao = d.nr_prescricao
	and	b.nr_atendimento = d.nr_atendimento
	and	(a.nr_Seq_exame IS NOT NULL AND a.nr_Seq_exame::text <> '')
	and	d.nr_prescricao = nr_prescricao_p;


c02 CURSOR FOR
	SELECT	a.linha,
		substr(rpad((nr_sequencia_aux_w+(rownum-1)),4,' '),1,4) nr_sequencia,
		a.nr_guia_tiss,
		a.sg_sigla,
		a.nr_crm_tiss,
		a.uf_crm_tiss,
		a.cd_cbo,
		a.cd_cbes,
		a.cd_cnpj,
		a.dt_autorizacao,
		a.dt_emissao,
		a.dt_solicitacao,
		a.hr_solicitacao,
		a.nm_solicitante,
		a.nr_guia_princ,
		a.cd_senha_tiss,
		a.dt_validade_senha,
		a.ds_indicacao
	from (SELECT	distinct
			'GTI' linha,
			replace(to_char(coalesce(a.nr_interno_conta,'0'),'00000000000000000000'),' ','') nr_guia_tiss,
			substr(rpad(coalesce(to_char(e.sg_conselho),' '),4,' '),1,4) sg_sigla,
			replace(substr(to_char(coalesce(e.nr_crm,'0'),'000000'),1,7),' ','') nr_crm_tiss,
			substr(rpad(coalesce(to_char(e.uf_crm),' '),2,' '),1,2) uf_crm_tiss,
			substr(rpad(coalesce(to_char(e.cd_cbo_saude),' '),5,' '),1,5) cd_cbo,
			substr(rpad(coalesce(to_char(e.cd_cnes),' '),7,' '),1,7) cd_cbes,
			replace(to_char(coalesce(01607538000121, coalesce(e.cd_cgc, coalesce(e.nr_cpf,'0'))),'00000000000000'),' ','') cd_cnpj,
			substr(rpad(coalesce(to_char(a.dt_autorizacao,'ddmmyyyy'),' '),8,' '),1,8) dt_autorizacao,
			substr(rpad(coalesce(to_char(a.dt_emissao_guia,'ddmmyyyy'),' '),8,' '),1,8) dt_emissao,
			substr(rpad(coalesce(to_char(f.dt_solicitacao,'ddmmyyyy'),' '),8,' '),1,8) dt_solicitacao,
			substr(rpad(coalesce(to_char(f.dt_solicitacao,'hh24mi'),' '),4,' '),1,4) hr_solicitacao,
			substr(rpad(coalesce(e.nm_contratado,' '),70,' '),1,70) nm_solicitante,
			replace(to_char(substr(coalesce(a.CD_AUTORIZACAO_PRINC,'0'),1,20),'00000000000000000000'),' ','') nr_guia_princ,
			substr(rpad(coalesce(to_char(a.cd_senha),' '),20,' '),1,20) cd_senha_tiss,
			substr(rpad(coalesce(to_char(a.dt_validade_senha,'ddmmyyyy'),' '),8,' '),1,8)dt_validade_senha,
			replace(f.DS_INDICACAO, chr(13)||chr(10), '&&') ds_indicacao
		FROM w_tiss_beneficiario c, w_tiss_relatorio b, w_tiss_guia a
LEFT OUTER JOIN conta_paciente d ON (a.nr_interno_conta = d.nr_interno_conta)
LEFT OUTER JOIN w_tiss_contratado_solic e ON (a.nr_sequencia = e.nr_seq_guia)
LEFT OUTER JOIN w_tiss_solicitacao f ON (a.nr_sequencia = f.nr_seq_guia)
WHERE a.nm_usuario	= nm_usuario_cor_const_w and a.nm_usuario	= b.nm_usuario AND c.nr_seq_guia	= a.nr_sequencia    ) a;


BEGIN

select 	count(*)
into STRICT	qt_exames_w
from 	prescr_procedimento
where 	nr_prescricao = nr_prescricao_p
and 	(nr_seq_exame IS NOT NULL AND nr_seq_exame::text <> '');

if (qt_exames_w > 0) then

	arq_texto_w		:= utl_file.fopen(dir_p, nm_arquivo_p,'W');
	nr_sequencia_aux_w	:= 1;
	qt_total_w  		:= 0;
	-----Adicionando campos do HED------
	select	'HED' linha,
		substr(rpad(nr_sequencia_aux_w,4,' '),1,4) nr_sequencia,
		substr(rpad(coalesce(to_char(a.nr_prescricao),' '),15,' '),1,15) nr_prescricao,
		substr(rpad(coalesce(to_char(b.nr_prontuario),' '),15,' '),1,15) nr_prontuario,
		substr(rpad(coalesce(to_char(a.dt_prescricao, 'ddmmyyyy'),' '),8,' '),1,8) dt_criacao,
		substr(rpad(coalesce(to_char(a.dt_prescricao, 'hh24mi'),' '),4,' '),1,4) hr_criacao
	into STRICT	linha_w,
		nr_Sequencia_w,
		nr_prescricao_w,
		nr_prontuario_w,
		dt_criacao_w,
		hr_criacao_w
	from	prescr_medica a,
		pessoa_fisica b
	where	a.cd_pessoa_fisica = b.cd_pessoa_fisica
	and	a.nr_prescricao = nr_prescricao_p;

	utl_file.put_line(arq_texto_w,linha_w||nr_sequencia_w||nr_prescricao_w||nr_prontuario_w||dt_criacao_w||hr_criacao_w);
	utl_file.fflush(arq_texto_w);
	nr_sequencia_aux_w := nr_Sequencia_aux_w+1;
	qt_total_w := qt_total_w+1;
	---------Adicionando Campos do Cli----------
	select	'CLI' linha,
		substr(rpad(nr_sequencia_aux_w,4,' '),1,4) nr_sequencia,
		substr(rpad(coalesce(OBTER_NOME_PF(b.CD_PESSOA_FISICA),' '),45,' '),1,45) nm_paciente,
		substr(rpad(coalesce(to_char(b.dt_nascimento, 'ddmmyyyy'),' '),8,' '),1,8) dt_nascimento,
		substr(rpad(coalesce(b.ie_sexo,' '),1,' '),1,1) ie_sexo,
		substr(rpad(coalesce(b.nr_identidade,' '),15,' '),1,15) nr_identidade,
		substr(rpad(coalesce(b.ds_orgao_emissor_ci,' '),15,' '),1,15) cd_orgao_expedidor,
		substr(rpad(coalesce(c.ds_endereco,' '),35,' '),1,35) ds_endereco,
		substr(rpad(coalesce(c.ds_complemento,' '),15,' '),1,15) ds_complemento,
		substr(rpad(coalesce(c.ds_municipio,' '),20,' '),1,20) nm_cidade,
		substr(rpad(coalesce(c.ds_bairro,' '),15,' '),1,15) ds_bairro,
		substr(rpad(coalesce(c.sg_estado,' '),2,' '),1,2) ds_estado,
		substr(rpad(coalesce(to_char(c.cd_Cep),' '),8,' '),1,8) nr_cep,
		replace(to_char(coalesce(substr(c.nr_telefone, 1,2),'0'),'0000'),' ','') nr_ddd_tel_res,
		replace(to_char(coalesce(substr(c.nr_Telefone,3,4),'0'),'0000'),' ','') nr_prefix_tel_res,
		replace(to_char(coalesce(substr(c.nr_Telefone,7,4),'0'),'0000'),' ','') nr_sufix_tel_res,
		replace(to_char(coalesce(substr(c.nr_ramal,1,4),'0'),'0000'),' ','') nr_ramal_res,
		replace(to_char(coalesce(substr(d.nr_telefone,1,2),'0'),'0000'),' ','') nr_ddd_tel_com,
		replace(to_char(coalesce(substr(d.nr_telefone,3,4),'0'),'0000'),' ','') nr_prefix_tel_com,
		replace(to_char(coalesce(substr(d.nr_telefone,7,4),'0'),'0000'),' ','') nr_sufix_tel_com,
		replace(to_char(coalesce(substr(d.nr_ramal,1,4),'0'), '0000'),' ','') nr_ramal_com,
		replace(to_char(coalesce(substr(b.nr_telefone_celular,1,2),'0'),'0000'),' ','') nr_ddd_tel_celular,
		replace(to_char(coalesce(substr(b.nr_telefone_celular,3,4),'0'),'0000'),' ','') nr_prefix_telefone_celular,
		replace(to_char(coalesce(substr(b.nr_telefone_celular,7,4),'0'),'0000'),' ','') nr_sufix_telefone_celular,
		substr(rpad(coalesce(c.ds_email,' '),50,' '),1,50) ds_email,
		substr(rpad(coalesce(to_char(b.dt_atualizacao_nrec,'ddmmyyyy'),' '),8,' '),1,8) dt_cadastro_cliente,
		substr(rpad(coalesce(to_char(b.dt_atualizacao_nrec,'hh24mi'),' '),4,' '),1,4) hr_cadastro_cliente,
		substr(rpad(coalesce(to_char(b.NR_CARTAO_NAC_SUS),' '),15,' '),1,15) nr_cartao_nac_sus,
		substr(rpad(coalesce(e.nm_contato,' '),60,' '),1,60) nm_pai,
		substr(rpad(coalesce(f.nm_contato,' '),60,' '),1,60) nm_mae
	into STRICT	linha_w,
		nr_sequencia_w,
		nm_paciente_w,
		dt_nascimento_w,
		ie_sexo_w,
		nr_identidade_w,
		cd_orgao_expedidor_w,
		ds_endereco_w,
		ds_complemento_w,
		nm_cidade_w,
		ds_bairro_w,
		ds_estado_w,
		nr_cep_w,
		nr_ddd_tel_res_w,
		nr_prefix_tel_res_w,
		nr_sufix_tel_res_w,
		nr_ramal_res_w,
		nr_ddd_tel_com_w,
		nr_prefix_tel_com_w,
		nr_sufix_tel_com_w,
		nr_ramal_com_w,
		nr_ddd_tel_celular_w,
		nr_prefix_telefone_celular_w,
		nr_sufix_telefone_celular_w,
		ds_email_w,
		dt_cadastro_cliente_w,
		hr_cadastro_cliente_w,
		nr_cartao_nac_sus_w,
		nm_pai_w,
		nm_mae_w
	FROM pessoa_fisica b, prescr_medica a
LEFT OUTER JOIN compl_pessoa_fisica c ON (a.cd_pessoa_fisica = c.cd_pessoa_fisica AND 1 = c.ie_tipo_complemento)
LEFT OUTER JOIN compl_pessoa_fisica d ON (a.cd_pessoa_fisica = d.cd_pessoa_fisica AND 2 = d.ie_tipo_complemento)
LEFT OUTER JOIN compl_pessoa_fisica e ON (a.cd_pessoa_fisica = e.cd_pessoa_fisica AND 4 = e.ie_tipo_complemento)
LEFT OUTER JOIN compl_pessoa_fisica f ON (a.cd_pessoa_fisica = f.cd_pessoa_fisica AND 5 = f.ie_tipo_complemento)
WHERE a.cd_pessoa_fisica = b.cd_pessoa_fisica         and a.nr_prescricao = nr_prescricao_p;
		utl_file.put_line(arq_texto_w,
			linha_w||nr_sequencia_w||nm_paciente_w||dt_nascimento_w||ie_sexo_w||nr_identidade_w||
			cd_orgao_expedidor_w||ds_endereco_w||ds_complemento_w||nm_cidade_w||ds_bairro_w||ds_estado_w||
			nr_cep_w||nr_ddd_tel_res_w||nr_prefix_tel_res_w||nr_sufix_tel_res_w||nr_ramal_res_w||
			nr_ddd_tel_com_w||nr_prefix_tel_com_w||nr_sufix_tel_com_w||nr_ramal_com_w||nr_ddd_tel_celular_w||
			nr_prefix_telefone_celular_w||nr_sufix_telefone_celular_w||ds_email_w||dt_cadastro_cliente_w||
			hr_cadastro_cliente_w||nr_cartao_nac_sus_w||nm_mae_w||nm_pai_w);
		utl_file.fflush(arq_texto_w);
	nr_sequencia_aux_w := nr_sequencia_aux_w+1;
	qt_total_w := qt_total_w+1;
	select	'PRT' linha,
		substr(rpad(nr_Sequencia_aux_w,4,' '),1,4) nr_sequencia,
		substr(rpad(coalesce(to_char(a.dt_prescricao,'hh24mi'),' '),4,' '),1,4) hr_prescricao,
		substr(rpad(coalesce(to_char(a.dt_prescricao,'ddmmyyyy'),' '),8,' '),1,8) dt_prescricao,
		substr(rpad(coalesce(to_char(OBTER_CONVERSAO_EXTERNA(null,'SETOR_ATENDIMENTO','CD_SETOR_ATENDIMENTO',cd_setor_atendimento)),' '),5,' '),1,5),
		substr(rpad(coalesce(obter_unidade_atendimento(a.nr_atendimento, 'A', 'UB'),' '),5,' '),1,10) cd_unidade_basica,
		--substr(rpad(nvl(obter_unidade_atendimento(a.nr_atendimento, 'A', 'UC'),' '),10,' '),1,10) cd_unidade_compl,
		substr(rpad(coalesce(to_char(a.dt_mestruacao,'ddmmyyyy'),' '),8,' '),1,8) dt_mestruacao,
		substr(rpad(coalesce(to_char(a.qt_altura_cm),' '),3,' '),1,3) qt_altura,
		substr(rpad(coalesce(to_char(a.qt_peso),' '),6,' '),1,6) qt_peso,
		replace(coalesce(a.ds_observacao,' '), chr(13)||chr(10), '&&')
	into STRICT	linha_w,
		nr_sequencia_w,
		hr_prescricao_w,
		dt_prescricao_w,
		cd_unidade_basica_w,
		cd_unidade_compl_w,
		dt_mestruacao_w,
		qt_altura_W,
		qt_peso_w,
		ds_observacao_w
	from	prescr_medica a
	where	a.nr_prescricao = nr_prescricao_p;
		utl_file.put_line(arq_texto_w,
					linha_w||nr_sequencia_w||hr_prescricao_w||dt_prescricao_w||cd_unidade_basica_w||
					cd_unidade_compl_w||dt_mestruacao_w||qt_altura_W||qt_peso_w||ds_observacao_w);
		utl_file.fflush(arq_texto_w);
	nr_sequencia_aux_w := nr_sequencia_aux_w+1;
	qt_total_w := qt_total_w+1;
	select	'CVT' linha,
		substr(rpad(nr_sequencia_aux_w,4,' '),1,4) nr_sequencia,
		substr(rpad(coalesce(to_char(OBTER_CONVERSAO_EXTERNA(OBTER_CGC_CONVENIO(b.cd_convenio),'CONVENIO','CD_CONVENIO',b.cd_convenio)),' '),4,' '),1,4) cd_convenio,
		substr(rpad(coalesce(to_char(b.cd_usuario_convenio),' '),15,' '),1,15) cd_usuario_convenio,
		substr(rpad(coalesce(to_char(b.dt_ultimo_pagto,'ddmmyyyy'),' '),8,' '),1,8) dt_ultimo_pagto,
		substr(rpad(coalesce(to_char(b.dt_validade_carteira,'ddmmyyyy'),' '),8,' '),1,8) dt_Validade_carteira,
		substr(rpad(coalesce(to_char(obter_empresa_paciente(b.cd_empresa,null)),' '),40,' '),1,40) ds_empresa_tit,
		substr(rpad(coalesce(to_char(b.cd_usuario_convenio),' '),20,' '),1,20) cd_mat_tit_conv,
		substr(rpad(coalesce((select	max(OBTER_NOME_PF(c.CD_PESSOA_FISICA))
				from	PESSOA_TITULAR_CONVENIO P,
					ATENDIMENTO_PACIENTE d,
					pessoa_fisica c
				where	P.CD_PESSOA_FISICA = d.CD_PESSOA_FISICA
				and	p.cd_pessoa_titular = c.cd_pessoa_fisica
				and	d.NR_ATENDIMENTO = a.NR_ATENDIMENTO
				and	P.CD_CONVENIO = b.CD_CONVENIO),' '),40,' '),1,40) nm_tit_convenio,
		substr(lpad(' ', 9, ' '),1,9) ds_DMA,
		substr(lpad(' ', 18, ' '),1,18) ds_SUCT,
		substr(lpad(' ', 1, ' '),1,1) ds_grau_parentesco,
		substr(rpad(coalesce((select	max(c.cd_plano)
				from	convenio_plano c,
					atend_categoria_convenio d
				where	d.cd_convenio		= c.cd_convenio
				and	d.cd_plano_convenio	= c.cd_plano
				and	d.nr_atendimento = a.nr_atendimento
				and	d.nr_seq_interno	= (	select	coalesce(max(e.nr_seq_interno),0)
									from 	Atend_categoria_convenio e
									where 	e.nr_atendimento	= d.nr_atendimento
									and 	e.dt_inicio_vigencia	=
													(select max(f.dt_inicio_vigencia)
													from 	Atend_categoria_convenio f
													where 	f.nr_atendimento	= e.nr_atendimento))),' '),15,' '),1,15) ds_plano_convenio,
		substr(lpad(' ', 8, ' '),1,8) nr_Seq_cliente,
		substr(lpad(' ', 15, ' '),1,15) ds_tipo_cliente,
		substr(lpad(' ', 25, ' '),1,25) ds_unidade_tit
	into STRICT 	linha_w,
		nr_sequencia_w,
		cd_convenio_w,
		cd_usuario_convenio_w,
		dt_ultimo_pagto_w,
		dt_validade_carteira_w,
		ds_empresa_tit_w,
		cd_mat_tit_conv_w,
		nm_tit_convenio_w,
		ds_dma_w,
		ds_suct_w,
		ds_grau_parentesco_w,
		ds_plano_convenio_w,
		nr_Seq_cliente_w,
		ds_tipo_cliente_w,
		ds_unidade_tit_w
	from	prescr_medica a,
		atend_categoria_convenio b
	where	a.nr_atendimento = b.nr_atendimento
	and	b.dt_inicio_vigencia =	(SELECT	max(c.dt_inicio_vigencia)
					from	Atend_categoria_convenio c
					where	c.nr_atendimento = a.nr_atendimento)
	and		a.nr_prescricao = nr_prescricao_p;

	utl_file.put_line(arq_texto_w,linha_w||nr_sequencia_w||cd_convenio_w||cd_usuario_convenio_w||dt_ultimo_pagto_w|| dt_validade_carteira_w||ds_empresa_tit_w||cd_mat_tit_conv_w||nm_tit_convenio_w||ds_dma_w||		ds_suct_w||ds_grau_parentesco_w||ds_plano_convenio_w||nr_Seq_cliente_w||ds_tipo_cliente_w||		ds_unidade_tit_w);
	utl_file.fflush(arq_texto_w);
	nr_sequencia_aux_w := nr_sequencia_aux_w+1;
	qt_total_w := qt_total_w+1;
	select	'PRF' linha,
		substr(rpad(nr_sequencia_aux_w,4,' '),1,4) nr_sequencia,
		substr(rpad(coalesce(to_char(OBTER_CONSELHO_PROFISSIONAL(c.NR_SEQ_CONSELHO, 'S')),' '),4,' '),1,4) sg_conselho,
		substr(rpad(coalesce(to_char(b.nr_crm),' '),6,' '),1,6) nr_crm,
		substr(rpad(coalesce(to_char(b.UF_CRM),' '),2,' '),1,2) uf_crm,
		substr(rpad(coalesce(OBTER_NOME_PF(c.CD_PESSOA_FISICA),' '),40,' '),1,40) nm_pessoa_fisica,
		substr(rpad(coalesce(c.ie_sexo,' '),1,' '),1,1) ie_sexo_prof
	into STRICT	linha_w,
		nr_sequencia_w,
		sg_conselho_w,
		nr_crm_w,
		uf_crm_w,
		nm_pessoa_fisica_w,
		ie_sexo_prof_w
	from	prescr_medica a,
		medico b,
		pessoa_fisica c
	where	a.cd_medico = b.cd_pessoa_fisica
	and	a.cd_medico = c.cd_pessoa_fisica
	and	a.nr_prescricao = nr_prescricao_p;

	utl_file.put_line(arq_texto_w,linha_w||nr_sequencia_w||sg_conselho_w||nr_crm_w||uf_crm_w||nm_pessoa_fisica_w||ie_sexo_prof_w);
	utl_file.fflush(arq_texto_w);
	nr_sequencia_aux_w := nr_sequencia_aux_w+1;
	qt_total_w := qt_total_w+1;
	open c01;
	loop
	fetch c01 into	linha_w,
			nr_sequencia_w,
			cd_convenio_solic_w,
			nm_exame_w,
			cd_senha_w,
			nr_guia_w,
			sg_conselho_solic_w,
			nr_crm_solic_w,
			uf_crm_solic_w,
			ds_cid_w,
			ds_grupo_cid_w,
			nr_sequencia_solic_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
	utl_file.put_line(arq_texto_w,
					linha_w||nr_sequencia_w||cd_convenio_solic_w||nm_exame_w||cd_senha_w||nr_guia_w||
			sg_conselho_solic_w||nr_crm_solic_w||uf_crm_solic_w||ds_cid_w||ds_grupo_cid_w||nr_sequencia_solic_w);
	utl_file.fflush(arq_texto_w);
	nr_Sequencia_aux_w := nr_sequencia_aux_w+1;
	qt_total_w := qt_total_w+1;
	end loop;
	close c01;

	if (obter_setor_prescricao(nr_prescricao_p,'C') = obter_setor_atendimento(obter_atendimento_prescr(nr_prescricao_p))) then
		ie_setor_prescricao_w := 'S';
	else
		ie_setor_prescricao_w := 'N';
	end if;

	--tiss_gerar_w_guia_spsadt(-1,-1,-1,null,-1,-1,-1,obter_atendimento_prescr(nr_prescricao_p), nm_usuario_cor_const_w,ie_setor_prescricao_w,-1,-1,-1,-1,null);
	CALL tiss_gerar_w_guia_spsadt(-1,-1,-1,null,-1,nr_prescricao_p,-1,-1, nm_usuario_cor_const_w,ie_setor_prescricao_w,-1,-1,-1,-1,null,-1,null,null,-1,-1,null,-1);

	open c02;
	loop
	fetch c02 into 	linha_w,
			nr_sequencia_w,
			nr_guia_tiss_w,
			sg_sigla_w,
			nr_crm_tiss_w,
			uf_crm_tiss_w,
			cd_cbo_w,
			cd_cbes_w,
			cd_cnpj_w,
			dt_autorizacao_w,
			dt_emissao_w,
			dt_solicitacao_w,
			hr_solicitacao_w,
			nm_solicitante_w,
			nr_guia_princ_w,
			cd_senha_tiss_w,
			dt_validade_senha_w,
			ds_indicacao_clinica_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
		utl_file.put_line(arq_texto_w,
					linha_w||nr_sequencia_w||nr_guia_tiss_w||sg_sigla_w||nr_crm_tiss_w||
					uf_crm_tiss_w||cd_cbo_w||cd_cbes_w||cd_cnpj_w||dt_autorizacao_w||dt_emissao_w||
					dt_solicitacao_w||hr_solicitacao_w||nm_solicitante_w||nr_guia_princ_w||cd_senha_tiss_w||
					dt_validade_senha_w||ds_indicacao_clinica_w);
		utl_file.fflush(arq_texto_w);
	nr_sequencia_aux_w := nr_sequencia_aux_w+1;
	qt_total_w := qt_total_w+1;
	end loop;
	close c02;

	utl_file.put_line(arq_texto_w, 'TRL'||to_char(nr_sequencia_aux_w,'0000')||qt_total_w);
	utl_file.fflush(arq_texto_w);
	utl_file.fclose(arq_texto_w);
	CALL gravar_log_lab(87,'Gerado arquivo da integração Fanny. Prescrição: '||nr_prescricao_p||' Arquivo: '||nm_arquivo_p,'Fanny',nr_prescricao_p,'Fanny');
	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hcc_int_prescr_tasy_lab_ext ( nr_prescricao_p bigint, dir_p text, nm_arquivo_p text) FROM PUBLIC;

