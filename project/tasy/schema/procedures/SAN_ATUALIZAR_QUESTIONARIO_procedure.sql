-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_atualizar_questionario ( nr_seq_quest_p bigint, ie_resposta_p text, dt_ocorrencia_p timestamp, ds_observacao_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_impedimento_w	bigint;
nr_seq_doador_w		bigint;


BEGIN

if (nr_seq_quest_p IS NOT NULL AND nr_seq_quest_p::text <> '') then

	select 	nr_seq_impedimento,
		nr_seq_doacao
	into STRICT	nr_seq_impedimento_w,
		nr_seq_doador_w
	from	san_questionario
	where	nr_sequencia = nr_seq_quest_p;


	update	san_questionario
	set	ds_observacao		=  substr(ds_observacao_p, 1,255),
		dt_ocorrencia   	=  dt_ocorrencia_p,
		ie_resposta     	=  ie_resposta_p
	where	nr_sequencia		=  nr_seq_quest_p;

	update	san_questionario a
	set	ds_observacao		 = NULL,
		dt_ocorrencia   	 = NULL,
		ie_resposta     	 = NULL
	where	nr_seq_doacao		= nr_seq_doador_w
	and	exists (SELECT 	1
			from	san_impedimento x
			where	x.nr_sequencia 		= a.nr_seq_impedimento
			and	x.nr_seq_imped_pai      = nr_seq_impedimento_w
			/*AND	NVL(a.ie_resposta, 'N') = NVL(x.ie_resposta_correta,'N')*/
)
	and	exists (select	1
			from	san_questionario b,
				san_impedimento c
			where	b.nr_sequencia 		= nr_seq_quest_p
			and	b.nr_seq_impedimento 	= c.nr_sequencia
			and	coalesce(b.ie_resposta, 'N') = coalesce(c.ie_resposta_correta,'N'));

end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_atualizar_questionario ( nr_seq_quest_p bigint, ie_resposta_p text, dt_ocorrencia_p timestamp, ds_observacao_p text, nm_usuario_p text) FROM PUBLIC;

