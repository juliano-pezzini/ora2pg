-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_funcao_tf ( cd_funcao_p bigint, nm_tabela_p text, nm_atributo_p text, nr_seq_trans_financ_p INOUT bigint, ie_acao_p INOUT text, nm_usuario_p text) AS $body$
DECLARE



nr_seq_tf_campo_w	bigint;
qt_rec_w			bigint;
qt_cf_w			bigint;
qt_atrib_w		bigint;
nr_seq_trans_financ_w	bigint	:= null;

nm_atrib_tipo_receb_w	varchar(255);
nm_atrib_conta_financ_w	varchar(255);

ie_acao_w		varchar(255)	:= 'N';

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.ie_acao,
	(select count(*) from funcao_tf_regra_receb x where x.nr_seq_tf_campo = a.nr_sequencia) qt_rec,
	(select count(*) from funcao_tf_regra_cf x where x.nr_seq_tf_campo = a.nr_sequencia) qt_cf,
	(select	count(*)
	from	funcao_tf_regra_atrib x,
		w_funcao_tf_valores y
	where	x.nr_seq_tf_campo = a.nr_sequencia
	and	y.nm_atributo = substr(x.nm_atributo,position('.' in x.nm_atributo)+1,50)
	and	y.nm_tabela = x.nm_tabela
	and	y.nm_usuario = nm_usuario_p
	and	coalesce(y.vl_campo,0) <> 0) qt_atrib
from	funcao_tf_campo a
where	a.cd_funcao	= cd_funcao_p
and	a.nm_tabela	= nm_tabela_p
and	a.nm_atributo	= nm_tabela_p || '.' || nm_atributo_p
and	not exists (	select	1
		from	funcao_tf_regra_atrib x
		where	x.nr_seq_tf_campo = a.nr_sequencia
		and	not exists (	select	1
				from	w_funcao_tf_valores y
				where	y.nm_atributo = substr(x.nm_atributo,position('.' in x.nm_atributo)+1,50)
				and	y.nm_tabela = x.nm_tabela
				and	y.nm_usuario = nm_usuario_p
				and	coalesce(y.vl_campo,0) <> 0))
and (not exists (	select	1
			from	funcao_tf_regra_atrib x
			where	x.nr_seq_tf_campo = a.nr_sequencia) or
	not exists (	select	1
		from	w_funcao_tf_valores y
		where	y.nm_usuario = nm_usuario_p
		and	y.nm_atributo not in (nm_atrib_tipo_receb_w, nm_atrib_conta_financ_w)
		and	coalesce(y.vl_campo,0) <> 0
		and	not exists (	select	1
				from	funcao_tf_regra_atrib x
				where	x.nr_seq_tf_campo = a.nr_sequencia
				and	y.nm_atributo = substr(x.nm_atributo,position('.' in x.nm_atributo)+1,50)
				and	y.nm_tabela = x.nm_tabela)))
and (not exists (select	1
		from	funcao_tf_regra_receb x
		where	x.nr_seq_tf_campo	= a.nr_sequencia) or
	exists (	select	1
		from	funcao_tf_regra_receb x
		where	x.nr_seq_tf_campo	= a.nr_sequencia
		and	exists (	select	1
				from	w_funcao_tf_valores y
				where	y.nm_atributo	= nm_atrib_tipo_receb_w
				and	y.vl_campo	= x.cd_tipo_recebimento
				and	y.nm_usuario	= nm_usuario_p)))
and (not exists (select	1
		from	funcao_tf_regra_cf x
		where	x.nr_seq_tf_campo	= a.nr_sequencia) or
	exists (	select	1
		from	funcao_tf_regra_cf x
		where	x.nr_seq_tf_campo	= a.nr_sequencia
		and	exists (	select	1
				from	w_funcao_tf_valores y
				where	y.nm_atributo	= nm_atrib_conta_financ_w
				and	y.vl_campo	= x.cd_conta_financ
				and	y.nm_usuario	= nm_usuario_p)))
order 	by qt_rec asc,
	qt_cf asc,
	qt_atrib asc;


BEGIN
if (cd_funcao_p = 813) then
	nm_atrib_tipo_receb_w	:= 'CD_TIPO_RECEB_CAIXA';
else
	nm_atrib_tipo_receb_w	:= 'CD_TIPO_RECEBIMENTO';
end if;

nm_atrib_conta_financ_w	:= 'CD_CONTA_FINANC';


open c01;
loop
fetch c01 into
	nr_seq_tf_campo_w,
	ie_acao_w,
	qt_rec_w,
	qt_cf_w,
	qt_atrib_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
end loop;
close c01;

select	max(nr_seq_trans_financ)
into STRICT	nr_seq_trans_financ_w
from	funcao_tf_trans_financ
where	nr_seq_tf_campo	= nr_seq_tf_campo_w;

if (nr_seq_trans_financ_w > 0) then
	ie_acao_w := 'N';
elsif (coalesce(nr_seq_tf_campo_w,0) = 0) then
	select	coalesce(max(a.ie_acao),'N')
	into STRICT	ie_acao_w
	from	funcao_tf_campo a
	where	a.cd_funcao	= cd_funcao_p
	and	a.nm_tabela	= nm_tabela_p
	and	a.nm_atributo	= nm_tabela_p || '.' || nm_atributo_p;
end if;

nr_seq_trans_financ_p	:= nr_seq_trans_financ_w;
ie_acao_p		:= ie_acao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_funcao_tf ( cd_funcao_p bigint, nm_tabela_p text, nm_atributo_p text, nr_seq_trans_financ_p INOUT bigint, ie_acao_p INOUT text, nm_usuario_p text) FROM PUBLIC;

