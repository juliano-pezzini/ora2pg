-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE importar_reg_item_contribuicao () AS $body$
DECLARE


c01 CURSOR FOR
	SELECT	nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_conta_consumidor,
			vl_pago,
			dt_faturamento,
			dt_vencimento,
			dt_pagamento,
			nm_contribuinte
	from	w_item_contribuicao;

nr_seq_contribuinte_w				contribuinte.nr_seq_contribuinte%type;
nr_seq_contribuinte_movto_w			contribuinte_movto.nr_sequencia%type;
count_contribuinte_movto_w			bigint;
c01_w								c01%rowtype;


BEGIN
	--VERIFICA_CONTRIBUINTE_PADRAO
	select	max(nr_seq_contribuinte)
	into STRICT	nr_seq_contribuinte_w
	from	contribuinte
	where	cd_pessoa_fisica = Obter_Valor_Param_Usuario(811,5, Obter_perfil_Ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento);

	if (coalesce(nr_seq_contribuinte_w::text, '') = '') then

		select	coalesce(max(nr_seq_contribuinte)+1, 1)
		into STRICT	nr_seq_contribuinte_w
		from	contribuinte;

		insert into contribuinte(
			nr_seq_contribuinte,
			cd_pessoa_fisica,
			ie_periodicidade,
			dt_atualizacao,
			nm_usuario)
		values (
			nr_seq_contribuinte_w,
			Obter_Valor_Param_Usuario(811,5, Obter_perfil_Ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento),
			'M',
			clock_timestamp(),
			'Tasy');
	end if;

	open c01;
	loop
	fetch c01 into c01_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

			select	coalesce(max(nr_sequencia)+1, 1)
			into STRICT	nr_seq_contribuinte_movto_w
            from	contribuinte_movto;

			if (c01_w.nm_contribuinte IS NOT NULL AND c01_w.nm_contribuinte::text <> '') then
				select	a.nr_seq_contribuinte
				into STRICT	nr_seq_contribuinte_w
				from	contribuinte a
				where	a.cd_ident_arrecadador = to_char(c01_w.cd_conta_consumidor);
			else
				select	a.nr_seq_contribuinte
				into STRICT	nr_seq_contribuinte_w
				from	contribuinte a
				where	a.cd_pessoa_fisica = Obter_Valor_Param_Usuario(811,5, Obter_perfil_Ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento);
			end if;

			select	count(*)
			into STRICT	count_contribuinte_movto_w
			from	contribuinte_movto
			where	nr_seq_contribuinte = nr_seq_contribuinte_w
			and		dt_movimento        = c01_w.dt_pagamento
			and		dt_vencimento       = c01_w.dt_vencimento
			and		vl_movimento        = c01_w.vl_pago;

			if (count_contribuinte_movto_w = 0) then

				insert into contribuinte_movto(
					nr_seq_contribuinte,
					nr_sequencia,
					dt_vencimento,
					dt_movimento,
					ie_tipo_movimento,
					vl_movimento,
					dt_atualizacao,
					nm_usuario)
				values (
					nr_seq_contribuinte_w,
					nr_seq_contribuinte_movto_w,
					c01_w.dt_vencimento,
					c01_w.dt_pagamento,
					'C',
					c01_w.vl_pago,
					clock_timestamp(),
					coalesce(wheb_usuario_pck.get_nm_usuario, 'Tasy')
					);

			end if;

		end;

	end loop;
	close c01;

	delete from w_item_contribuicao;
	commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importar_reg_item_contribuicao () FROM PUBLIC;

