-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--
-- dblink wrapper to call function aghos_atualiza_evolucoes as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE PROCEDURE aghos_atualiza_evolucoes (cd_estabelecimento_p bigint default 1) AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

BEGIN
	v_query := 'CALL aghos_atualiza_evolucoes_atx ( ' || quote_nullable(cd_estabelecimento_p) || ' )';
	PERFORM * FROM dblink(v_conn_str, v_query) AS p (ret boolean);

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE PROCEDURE aghos_atualiza_evolucoes_atx (cd_estabelecimento_p bigint default 1) AS $body$
DECLARE


nr_internacao_w	bigint;
ds_sep_bv_w	varchar(50);
ds_comando_w	varchar(2000);
ie_situacao_w	varchar(2);
ie_integracao_aghos_w	varchar(1);
BEGIN
ie_integracao_aghos_w := obter_dados_param_atend(cd_estabelecimento_p, 'AG');

If (ie_integracao_aghos_w = 'S') then

	nr_internacao_w := 0;
	ds_sep_bv_w  := obter_separador_bv;
	ds_comando_w :=	'declare '||
			' evoluc_sai gsh_i_pkg_integra_sai.evoluc_sai@tasy_aghos; '||
			' ds_erro_ww varchar2(500); '||
			' nr_seq_solicitacao_w	number(10); '||
			'begin '||
			' begin ' ||
			' gsh_i_pkg_integra_sai.gsh_i_prc_evoluc_sai@tasy_aghos(evoluc_sai); '||
			' '||
			' nr_seq_solicitacao_w := :nr_internacao_p; '||
			' '||
			' if (evoluc_sai.first is not null) then '||
			' for i in evoluc_sai.first..evoluc_sai.last loop '||
			' '||
			' begin '||
			' select	nr_sequencia '||
			' into	nr_seq_solicitacao_w '||
			' from	solicitacao_tasy_aghos '||
			' where	nr_internacao = evoluc_sai(i).idf_internacao '||
			' and	rownum = 1; '||
			' exception '||
			' when 	no_data_found then '||
			' 	nr_seq_solicitacao_w := 0; '||
			' end; '||
			' '||
			'	if	(nr_seq_solicitacao_w > 0) then '||
			' '||
			'	insert	into evolucao_tasy_aghos ('||
			'	nr_sequencia, '||
			'	dt_atualizacao, '||
			'	nm_usuario, '||
			'	dt_atualizacao_nrec, '||
			'	nm_usuario_nrec, '||
			'	nr_internacao, '||
			'	ie_tipo_evolucao,  '||
			'	ds_evolucao, '||
			'	ie_origem_evolucao, '||
			'	nr_seq_solicitacao) '||
			'	values (evolucao_tasy_aghos_seq.nextval, '||
			'	evoluc_sai(i).dat_inclusao_evolucao, '||
			'	''AGHOS'', '||
			'	evoluc_sai(i).dat_inclusao_evolucao, '||
			'	''AGHOS'', '||
			'	evoluc_sai(i).idf_internacao, '||
			'	evoluc_sai(i).tip_evolucao, '||
			'	evoluc_sai(i).des_evolucao,'||
			'	1, '||
			'	nr_seq_solicitacao_w); ' ||
			' '||
			'	gsh_i_prc_evoluc_s_u@tasy_aghos(evoluc_sai(i).idf_gsh_i_evoluc_sai,  '||
			'					''P'', '||
			'					ds_erro_ww); '||
			' '||
			'	commit; '||
			' '||
			'	end if; '||
			'	end loop; '||
			'	end if; '||
			' commit; '||
			' DBMS_SESSION.CLOSE_DATABASE_LINK(''tasy_aghos''); ' ||
			'   exception '||
			'   when others then '||
			'      rollback; ' ||
			'      DBMS_SESSION.CLOSE_DATABASE_LINK(''tasy_aghos''); ' ||
			'   end; '||
			'end;';

			CALL exec_sql_dinamico_bv('AGHOS', 	ds_comando_w, 	'nr_internacao_p=' || nr_internacao_w);

	commit;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE aghos_atualiza_evolucoes (cd_estabelecimento_p bigint default 1) FROM PUBLIC; -- REVOKE ALL ON PROCEDURE aghos_atualiza_evolucoes_atx (cd_estabelecimento_p bigint default 1) FROM PUBLIC;

