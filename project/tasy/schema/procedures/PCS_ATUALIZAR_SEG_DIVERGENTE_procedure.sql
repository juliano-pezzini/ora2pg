-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pcs_atualizar_seg_divergente ( nr_sequencia_p bigint, nr_seq_motivo_p bigint, nr_seq_segmento_p bigint, ds_justificativa_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_historico_w		bigint;
ds_historico_w			varchar(4000);
ds_titulo_w				varchar(255);
ds_material_w			varchar(255);
ds_segmento_atual_w 	varchar(255);
ds_segmento_w			varchar(255);
ds_motivo_w				varchar(255);
nr_seq_segmento_ant_w	bigint;
nr_seq_grupamento_atual_w bigint;
ds_grupamento_atual_w	varchar(255);
cd_material_w			bigint;
nr_seq_estrutura_w		bigint;


BEGIN


select  substr(obter_descricao_padrao('PCS_SEGMENTO','DS_SEGMENTO',NR_SEQ_SEGMENTO_P),1,255)
into STRICT	ds_segmento_atual_w
;

if (nr_seq_motivo_p IS NOT NULL AND nr_seq_motivo_p::text <> '') then
	select	ds_motivo
	into STRICT	ds_motivo_w
	from	pcs_motivos
	where	nr_sequencia = nr_seq_motivo_p;
end if;

select	substr(obter_Desc_material(cd_material),1,255),
		substr(obter_descricao_padrao('PCS_SEGMENTO','DS_SEGMENTO',NR_SEQ_SEGMENTO),1,255),
		nr_seq_segmento,
		cd_material
into STRICT	ds_material_w,
		ds_segmento_w,
		nr_seq_segmento_ant_w,
		cd_material_w
from	pcs_reclassif_curva_item
where	nr_sequencia = nr_sequencia_p;

select	a.ds_grupamento,
		b.ds_segmento,
		a.nr_sequencia
into STRICT	ds_grupamento_atual_w,
		ds_segmento_atual_w,
		nr_seq_grupamento_atual_w
from	pcs_grupamentos a,
		pcs_segmento b
where	b.nr_seq_grupamento = a.nr_sequencia
and 	b.nr_sequencia = nr_seq_segmento_p;

select	nextval('pcs_estrutura_segmento_seq')
into STRICT	nr_seq_estrutura_w
;

insert into pcs_estrutura_segmento(
		cd_estabelecimento,
		cd_material,
		ds_grupamento,
		ds_segmento,
		dt_atualizacao,
		dt_atualizacao_nrec,
		ie_curva_pcs,
		ie_situacao,
		nm_usuario,
		nm_usuario_nrec,
		nr_seq_grupamento,
		nr_seq_segmento,
		nr_sequencia,
		qt_maxima,
		qt_minima)
SELECT 	cd_estabelecimento,
		cd_material_w,
		ds_grupamento_atual_w,
		ds_segmento_atual_w,
		clock_timestamp(),
		clock_timestamp(),
		ie_curva_pcs,
		ie_situacao,
		nm_usuario_p,
		nm_usuario_p,
		nr_seq_grupamento_atual_w,
		nr_seq_segmento_p,
		nr_seq_estrutura_w,
		qt_maxima,
		qt_minima
from	pcs_estrutura_segmento
where	cd_material = cd_material_w;

delete from pcs_estrutura_segmento where cd_material = cd_material_w and nr_sequencia <> nr_seq_estrutura_w;
commit;

ds_titulo_w := ds_motivo_w;
ds_historico_w := wheb_mensagem_pck.get_texto(294629) || ' ' || ds_material_w || ' ' || wheb_mensagem_pck.get_texto(294697) || ' ' || ds_segmento_w || ' ' || wheb_mensagem_pck.get_texto(294698) || ' ' || ds_segmento_atual_w;

update	pcs_reclassif_curva_item
set		nr_seq_motivo =	nr_seq_motivo_p,
		nr_seq_segmento = nr_seq_segmento_p,
		nr_seq_seg_ant = nr_seq_segmento_ant_w,
		dt_atualizacao = clock_timestamp(),
		nm_usuario = nm_usuario_p
where	nr_sequencia = nr_sequencia_p;

select	nextval('pcs_reclassif_historico_seq')
into STRICT	nr_seq_historico_w
;

insert into pcs_reclassif_historico(
	ds_historico,
	ds_titulo,
	dt_atualizacao,
	dt_atualizacao_nrec,
	ie_origem,
	nm_usuario,
	nm_usuario_nrec,
	nr_seq_item,
	nr_sequencia,
	nr_seq_seg_ant,
	nr_seq_seg_atual,
	ds_justificativa)
values (
	ds_historico_w,
	ds_titulo_w,
	clock_timestamp(),
	clock_timestamp(),
	'S',
	nm_usuario_p,
	nm_usuario_p,
	nr_sequencia_p,
	nr_seq_historico_w,
	nr_seq_segmento_ant_w,
	nr_seq_segmento_p,
	ds_justificativa_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pcs_atualizar_seg_divergente ( nr_sequencia_p bigint, nr_seq_motivo_p bigint, nr_seq_segmento_p bigint, ds_justificativa_p text, nm_usuario_p text) FROM PUBLIC;

