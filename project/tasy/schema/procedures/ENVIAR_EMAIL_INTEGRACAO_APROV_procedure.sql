-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_email_integracao_aprov ( nr_solic_compra_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

			 
nr_sequencia_w			bigint;
ie_consignado_w			varchar(01);
ie_usuario_w			varchar(3);
ds_email_remetente_w		varchar(255);		
ds_email_w			varchar(255);
ds_email_origem_w		varchar(255);
ds_email_adicional_w		varchar(2000);	
cd_perfil_disparar_w		integer;
ie_momento_envio_w		varchar(1);
ie_envia_pessoa_deleg_w		varchar(1);
nm_pessoa_solicitante_w		varchar(60);
nm_responsavel_compras_w	varchar(100);
nr_documento_externo_w		bigint;
cd_comprador_w			varchar(10);
cd_comprador_padrao_w		varchar(10);
ds_email_comprador_w		varchar(255);
ds_email_solicitante_w		varchar(255);
ds_usuario_comprador_w		varchar(255);
ds_mensagem_padrao_w		varchar(4000);
ds_assunto_w			varchar(255);
nm_usuario_origem_w		varchar(255);
			

BEGIN 
select	max(coalesce(nr_sequencia,0)), 
	max(ie_consignado), 
	coalesce(max(ie_usuario),'U'), 
	coalesce(max(ds_email_remetente),'X'), 
	max(replace(ds_email_adicional,',',';')), 
	max(cd_perfil_disparar), 
	coalesce(max(ie_momento_envio),'I'), 
	coalesce(max(ie_envia_pessoa_deleg),'N') 
into STRICT	nr_sequencia_w, 
	ie_consignado_w, 
	ie_usuario_w, 
	ds_email_remetente_w, 
	ds_email_adicional_w, 
	cd_perfil_disparar_w, 
	ie_momento_envio_w, 
	ie_envia_pessoa_deleg_w 
from	regra_envio_email_compra 
where	cd_estabelecimento = cd_estabelecimento_p 
and	ie_tipo_mensagem = 93 
and	ie_situacao = 'A';
 
if (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') then 
	begin 
	select	substr(max(obter_nome_pf(cd_pessoa_solicitante)),1,100), 
		substr(max(obter_nome_pf(obter_dados_parametro_compras(cd_estabelecimento, 16))),1,100), 
		max(nr_documento_externo), 
		max(cd_comprador_resp), 
		max(obter_email_pessoa(cd_estabelecimento_p,cd_pessoa_solicitante,null,nm_usuario_p)) 
	into STRICT	nm_pessoa_solicitante_w, 
		nm_responsavel_compras_w, 
		nr_documento_externo_w, 
		cd_comprador_w, 
		ds_email_solicitante_w 
	from	solic_compra 
	where	nr_solic_compra = nr_solic_compra_p;	
	 
	if (cd_comprador_w IS NOT NULL AND cd_comprador_w::text <> '') or (cd_comprador_padrao_w IS NOT NULL AND cd_comprador_padrao_w::text <> '') then 
		select	max(ds_email), 
			max(nm_guerra) 
		into STRICT	ds_email_comprador_w, 
			ds_usuario_comprador_w 
		from	comprador 
		where	cd_pessoa_fisica = coalesce(cd_comprador_w,cd_comprador_padrao_w) 
		and	cd_estabelecimento = cd_estabelecimento_p;
	end if;	
	 
	if (ds_email_comprador_w IS NOT NULL AND ds_email_comprador_w::text <> '') then 
	  ds_email_w := ds_email_comprador_w || ';' || ds_email_w;
	end if;
	 
	if (ds_email_solicitante_w IS NOT NULL AND ds_email_solicitante_w::text <> '') then 
	  ds_email_w := ds_email_solicitante_w || ';' || ds_email_w;
	end if;
		 
	select	max(ds_email), 
		nm_usuario 
	into STRICT	ds_email_origem_w, 
		nm_usuario_origem_w 
	from	usuario 
	where	nm_usuario = nm_usuario_p 
	group by nm_usuario;
	 
	if (coalesce(ds_email_remetente_w::text, '') = '') then 
		ds_email_remetente_w := ds_email_origem_w;
	end if;
	 
	select	substr( 
		replace_macro( 
		replace_macro( 
		replace_macro( 
		replace_macro( 
		ds_assunto, 
		'@nr_pdc',nr_documento_externo_w), 
		'@nr_solicitacao',nr_solic_compra_p), 
		'@nm_solicitante',nm_pessoa_solicitante_w), 
		'@nm_comprador',ds_usuario_comprador_w),1,255), 
		substr( 
		replace_macro( 
		replace_macro( 
		replace_macro( 
		replace_macro( 
		ds_mensagem_padrao, 
		'@nr_pdc',nr_documento_externo_w), 
		'@nr_solicitacao',nr_solic_compra_p), 
		'@nm_solicitante',nm_pessoa_solicitante_w), 
		'@nm_comprador',ds_usuario_comprador_w),1,4000) 
	into STRICT	ds_assunto_w, 
		ds_mensagem_padrao_w 
	from	regra_envio_email_compra 
	where	nr_sequencia = nr_sequencia_w;	
 
	 
	if (ie_momento_envio_w = 'A') and (ds_email_w IS NOT NULL AND ds_email_w::text <> '') then 
		begin 
		--insert into mhbarth values(ds_email_w || ds_mensagem_padrao_w); 
		CALL sup_grava_envio_email( 
			'AP', 
			93, 
			nr_solic_compra_p, 
			null, 
			null, 
			ds_email_w, 
			nm_usuario_p, 
			ds_email_remetente_w, 
			ds_assunto_w, 
			ds_mensagem_padrao_w, 
			cd_estabelecimento_p, 
			nm_usuario_p);
		end;
	elsif (ds_email_w IS NOT NULL AND ds_email_w::text <> '') then 
		begin 
		--insert into mhbarth values(ds_email_w || ds_mensagem_padrao_w); 
		CALL enviar_email(ds_assunto_w,ds_mensagem_padrao_w,ds_email_remetente_w,ds_email_w,nm_usuario_origem_w,'M');
		end;
	end if;
	end;	
end if;	
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_email_integracao_aprov ( nr_solic_compra_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

