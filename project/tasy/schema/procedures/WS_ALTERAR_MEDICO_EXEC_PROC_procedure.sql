-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ws_alterar_medico_exec_proc ( nr_prescricao_p prescr_medica.nr_prescricao%type, nr_sequencia_p prescr_procedimento.nr_sequencia%type, cd_medico_exec_p pessoa_fisica.cd_pessoa_fisica%type, nm_usuario_p usuario.nm_usuario%type DEFAULT NULL) AS $body$
DECLARE

  ie_altera_proc_paciente_w varchar(1);
  ie_conta_definitiva_w     varchar(1) := 'N';
  ie_existe_proc_pac_w      varchar(1) := 'N';
  cd_procedimento_w         procedimento.cd_procedimento%type;
  ie_origem_proced_w        procedimento.ie_origem_proced%type;
  cd_cbo_w                  sus_cbo.cd_cbo%type;


BEGIN
  --Ao alterar medico executor, caso o procedimento esteja executado, alterar o medico da conta
  ie_altera_proc_paciente_w := obter_valor_param_usuario(916,826,obter_perfil_ativo,nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);

  BEGIN
    SELECT  cd_procedimento,
            ie_origem_proced
    INTO STRICT    cd_procedimento_w,
            ie_origem_proced_w
    FROM    prescr_procedimento
    WHERE   nr_prescricao = nr_prescricao_p
    AND     nr_sequencia = nr_sequencia_p;

  EXCEPTION
    WHEN no_data_found or too_many_rows THEN
      cd_procedimento_w := null;
      ie_origem_proced_w := null;
  END;

  BEGIN
    SELECT  'S'
    INTO STRICT    ie_existe_proc_pac_w
    FROM    procedimento_paciente b
    WHERE   nr_prescricao           = nr_prescricao_p
    AND     nr_sequencia_prescricao = nr_sequencia_p;
  EXCEPTION
    WHEN no_data_found THEN
      --O exame nao esta na conta do paciente. A alteracao do medico executor nao pode ser realizada
      CALL Wheb_mensagem_pck.exibir_mensagem_abort(1206418);
    WHEN too_many_rows THEN
      null;
    END;

  BEGIN
    SELECT 'S'
    INTO STRICT  ie_conta_definitiva_w
    FROM  conta_paciente a,
          procedimento_paciente b
    WHERE a.nr_interno_conta      = b.nr_interno_conta
    AND   a.ie_status_acerto      = 2
    AND   nr_prescricao           = nr_prescricao_p
    AND   nr_sequencia_prescricao = nr_sequencia_p  LIMIT 1;

  EXCEPTION
    WHEN no_data_found THEN
      ie_conta_definitiva_w := 'N';
    WHEN too_many_rows THEN
      ie_conta_definitiva_w := 'S';
  END;

  IF (coalesce(ie_altera_proc_paciente_w,'N') = 'S'
      OR (ie_altera_proc_paciente_w = 'P'
      AND ie_conta_definitiva_w = 'N')) THEN

  BEGIN
    SELECT    cd_cbo
    INTO STRICT      cd_cbo_w
    FROM (
    SELECT    a.cd_cbo, a.dt_atualizacao
    FROM      sus_cbo b,
              sus_cbo_pessoa_fisica a
    WHERE     sus_obter_secbo_compativel(cd_medico_exec_p, cd_procedimento_w, ie_origem_proced_w, clock_timestamp(), a.cd_cbo, 0) = 'S'
    AND       cd_pessoa_fisica = cd_medico_exec_p
    AND       a.cd_cbo = b.cd_cbo
    ORDER BY  a.dt_atualizacao desc) alias5 LIMIT 1;

    EXCEPTION
    WHEN no_data_found or too_many_rows THEN
      cd_cbo_w := null;
    END;

    UPDATE  procedimento_paciente
    SET     cd_medico_executor        = cd_medico_exec_p,
            nm_usuario                = nm_usuario_p,
            dt_atualizacao            = clock_timestamp(),
            cd_cbo                    = cd_cbo_w
    WHERE   nr_prescricao             = nr_prescricao_p
    AND     nr_sequencia_prescricao   = nr_sequencia_p;

  ELSIF (ie_conta_definitiva_w = 'S') THEN
    --Nao e permitido alterar o medico do procedimento em uma conta definitiva
    CALL Wheb_mensagem_pck.exibir_mensagem_abort(1046560);
  END IF;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ws_alterar_medico_exec_proc ( nr_prescricao_p prescr_medica.nr_prescricao%type, nr_sequencia_p prescr_procedimento.nr_sequencia%type, cd_medico_exec_p pessoa_fisica.cd_pessoa_fisica%type, nm_usuario_p usuario.nm_usuario%type DEFAULT NULL) FROM PUBLIC;

