-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_guia_req_estagio_imp ( nr_seq_execucao_lote_p pls_lote_execucao_req.nr_sequencia%type, nr_seq_requisicao_p pls_requisicao.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_estagio_req_p pls_requisicao.ie_estagio%type, nm_usuario_p text) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  ]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atenção: 
A geração da guia depende do Estagio da Requisição ie_estagio_req_p


++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
	
C01 CURSOR FOR
	SELECT	b.nr_seq_req_mat,
		b.nr_seq_req_proc,		
		b.cd_medico_executor,		
		b.qt_item_exec,		
		b.ie_tipo_item
	from	pls_lote_execucao_req a,
		pls_itens_lote_execucao b
	where	a.nr_sequencia 		= b.nr_seq_lote_exec
	and	a.nr_sequencia		= nr_seq_execucao_lote_p
	and	b.nr_seq_requisicao	= nr_seq_requisicao_p
	and	b.ie_permite_execucao 	= 'S'
	and	b.ie_executar 		= 'S';	
	
nr_seq_req_execucao_w		bigint;	
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;	
nr_seq_prestador_w		pls_prestador.nr_sequencia%type;
nr_seq_guia_plano_w		pls_guia_plano.nr_sequencia%type;

ie_status_guia_w		pls_guia_plano.ie_status%type;
ie_estagio_guia_w		pls_guia_plano.ie_estagio%type;
ie_status_item_guia_w		pls_guia_plano.ie_status%type;
	
BEGIN

select 	nr_seq_prestador,
	nr_seq_segurado
into STRICT	nr_seq_prestador_w,
	nr_seq_segurado_w
from	pls_lote_execucao_req
where 	nr_sequencia = nr_seq_execucao_lote_p;

/* Gerar execução na tabela PLS_EXECUCAO_REQUISICAO */

nr_seq_req_execucao_w := pls_inserir_execusao_req( nr_seq_requisicao_p, nr_seq_prestador_w, nr_seq_execucao_lote_p, null, nm_usuario_p, nr_seq_req_execucao_w, null, null);

for C01_w in C01 loop
	begin	
		--Salvar os itens que serão executados
		CALL pls_inserir_itens_execusao_req(	C01_w.ie_tipo_item, nr_seq_segurado_w, C01_w.qt_item_exec,
						nr_seq_requisicao_p, nr_seq_req_execucao_w, C01_w.cd_medico_executor,
						C01_w.nr_seq_req_proc,C01_w.nr_seq_req_mat, nm_usuario_p, null);		
	end;
end loop;

commit;

--Gera a autorização com os itens da requisição
CALL pls_gerar_guia_requisicao_lote( nr_seq_execucao_lote_p, nr_seq_segurado_w, nr_seq_prestador_w,
				nm_usuario_p,'W', cd_estabelecimento_p,
				null,null,null,	
				null,null);				

select 	max(nr_seq_guia)
into STRICT	nr_seq_guia_plano_w
from 	pls_execucao_requisicao a,
	pls_lote_execucao_req b
where 	b.nr_sequencia = a.nr_seq_lote_exec
and	b.nr_sequencia = nr_seq_execucao_lote_p
and	(a.dt_execucao IS NOT NULL AND a.dt_execucao::text <> '');
					

--Estágio negado a guia só é gerada para retornar no WebService				
if ( ie_estagio_req_p = 7 ) then
	ie_status_guia_w	:= '3';
	ie_estagio_guia_w	:= '4';
	ie_status_item_guia_w	:= 'N';
	
	--Gravar as glosas da requisição na guia
	CALL pls_gravar_glosa_req_guia_imp( nr_seq_requisicao_p, nr_seq_guia_plano_w, nm_usuario_p );
	
--Se a requisição ficou em análise a guia ficará com estágio e status de aguardando liberação
elsif ( ie_estagio_req_p = 4 ) then
	ie_status_guia_w	:= '2';
	ie_estagio_guia_w	:= '1';
	ie_status_item_guia_w	:= 'U';
	
--Requisição autorizada parcialmente
elsif ( ie_estagio_req_p = 6 ) then
	ie_status_guia_w	:= '1';
	ie_estagio_guia_w	:= '10';
	ie_status_item_guia_w	:= 'S';
	
	--Gravar as glosas da requisição na guia
	CALL pls_gravar_glosa_req_guia_imp( nr_seq_requisicao_p, nr_seq_guia_plano_w, nm_usuario_p );
	
elsif ( ie_estagio_req_p = 10 ) then
	ie_status_guia_w	:= '2';
	ie_estagio_guia_w	:= '12';
	ie_status_item_guia_w	:= 'I';
	
end if;


update	pls_guia_plano
set	ie_status 	= ie_status_guia_w,
	ie_estagio	= ie_estagio_guia_w,
	dt_atualizacao	= clock_timestamp(),
	nm_usuario	= nm_usuario_p,
	ie_origem_solic	= 'E',
	ie_tipo_processo = 'E'
where	nr_sequencia	= nr_seq_guia_plano_w;

update	pls_guia_plano_proc
set	ie_status 	= ie_status_item_guia_w,
	dt_atualizacao	= clock_timestamp(),
	nm_usuario	= nm_usuario_p
where	nr_seq_guia	= nr_seq_guia_plano_w;

update	pls_guia_plano_mat
set	ie_status 	= ie_status_item_guia_w,
	dt_atualizacao	= clock_timestamp(),
	nm_usuario	= nm_usuario_p
where	nr_seq_guia	= nr_seq_guia_plano_w;

commit;			

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_guia_req_estagio_imp ( nr_seq_execucao_lote_p pls_lote_execucao_req.nr_sequencia%type, nr_seq_requisicao_p pls_requisicao.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_estagio_req_p pls_requisicao.ie_estagio%type, nm_usuario_p text) FROM PUBLIC;

