-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_movto_estoque_ordem ( nr_seq_ordem_p bigint, ie_acao_p text, nm_usuario_p text) AS $body$
DECLARE


nr_movimento_estoque_w		bigint;
cd_estabelecimento_w		smallint;
cd_local_estoque_w		smallint;
cd_oper_perda_etq_w		integer;
cd_oper_consumo_etq_w		integer;
cd_oper_estoque_w		integer;
cd_material_w			integer;
nr_seq_cabine_w			bigint;
qt_dose_w			double precision;
cd_unidade_medida_real_w	varchar(30);
dt_inicio_preparo_w		timestamp;
cd_setor_atendimento_w		integer;
ie_estoque_w			varchar(10);
ds_material_w			varchar(255);
nr_seq_lote_fornec_w		bigint;
cd_cgc_fornec_w			varchar(14);
ie_consignado_w			varchar(1);

c01 CURSOR FOR
SELECT	cd_material,
	qt_dose_real,
	cd_unidade_medida_real,
	cd_oper_consumo_etq_w,
	substr(obter_desc_material(cd_material),1,255),
	nr_seq_lote_fornec
from	can_ordem_prod_mat
where	nr_seq_ordem	= nr_seq_ordem_p
and	qt_dose_real	> 0

union

select	cd_material,
	qt_perda,
	cd_unidade_medida_real,
	cd_oper_perda_etq_w,
	substr(obter_desc_material(cd_material),1,80),
	nr_seq_lote_fornec
from	can_ordem_prod_mat
where	nr_seq_ordem	= nr_seq_ordem_p
and	qt_perda	> 0;


BEGIN

select	b.nr_seq_cabine,
	a.cd_estabelecimento,
	a.dt_inicio_preparo
into STRICT	nr_seq_cabine_w,
	cd_estabelecimento_w,
	dt_inicio_preparo_w
from	far_etapa_producao b,
	can_ordem_prod a
where	a.nr_sequencia = nr_seq_ordem_p
and	b.nr_sequencia = a.nr_seq_etapa_prod;

select	cd_local_estoque,
	cd_oper_consumo_etq,
	cd_oper_perda_etq,
	cd_setor_atendimento
into STRICT	cd_local_estoque_w,
	cd_oper_consumo_etq_w,
	cd_oper_perda_etq_w,
	cd_setor_atendimento_w
from	far_cabine_seg_biol
where	nr_sequencia = nr_seq_cabine_w;


open c01;
loop
fetch c01 into
	cd_material_w,
	qt_dose_w,
	cd_unidade_medida_real_w,
	cd_oper_estoque_w,
	ds_material_w,
	nr_seq_lote_fornec_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	select 	obter_se_mat_consignado(cd_material_w)
	into STRICT	ie_consignado_w
	;

	if (ie_consignado_w = '1') or (ie_consignado_w = '2') then
		select	max(cd_cgc_fornec)
		into STRICT	cd_cgc_fornec_w
		from	material_lote_fornec
		where	cd_material = cd_material_w
		and	nr_sequencia = nr_seq_lote_fornec_w;
	end if;

	if (ie_consignado_w = '2') then
			begin
			ie_estoque_w := Obter_Disp_estoque(
				cd_material_w, cd_local_estoque_w, cd_estabelecimento_w, 0, qt_dose_w, null, ie_estoque_w);

			if (ie_estoque_w = 'S') then
				cd_cgc_fornec_w := null;
			else
				ie_estoque_w := Obter_Disp_estoque(
					cd_material_w, cd_local_estoque_w, cd_estabelecimento_w, 0, qt_dose_w, cd_cgc_fornec_w, ie_estoque_w);
			end if;
			end;
		else
			ie_estoque_w := Obter_Disp_estoque(
				cd_material_w, cd_local_estoque_w, cd_estabelecimento_w, 0, qt_dose_w, cd_cgc_fornec_w, ie_estoque_w);
		end if;

	if (ie_estoque_w = 'S') or (ie_acao_p = '2') then
		begin

		if (ie_acao_p = '2') then
			begin
			delete	FROM material_atend_paciente
			where	nr_seq_ordem_prod	= nr_seq_ordem_p;

			update	can_ordem_prod
			set	dt_devolucao		= clock_timestamp(),
				nm_usuario_devol	= nm_usuario_p,
				dt_entrega_setor	 = NULL,
				nm_usuario_disp		 = NULL
			where	nr_sequencia		= nr_seq_ordem_p;
			end;
		end if;
		end;
	else
		CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(179642, 'DS_MATERIAL_W='||DS_MATERIAL_W);
	end if;
	end;
end loop;
close c01;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_movto_estoque_ordem ( nr_seq_ordem_p bigint, ie_acao_p text, nm_usuario_p text) FROM PUBLIC;

