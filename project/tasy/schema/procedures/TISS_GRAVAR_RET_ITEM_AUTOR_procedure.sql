-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_gravar_ret_item_autor (nr_sequencia_autor_p bigint, nm_usuario_p text, cd_procedimento_p text, nr_seq_motivo_glosa_p text, ds_observacao_p text) AS $body$
DECLARE


cd_procedimento_w	varchar(20);
nr_sequencia_proc_w	bigint;
nr_sequencia_mat_w	bigint;
nr_seq_motivo_glosa_w	bigint;


BEGIN

nr_seq_motivo_glosa_w	:= somente_numero(nr_seq_motivo_glosa_p);

if (coalesce(nr_sequencia_autor_p,0) > 0) then

	select	ltrim(replace(cd_procedimento_p,'.',''),'0')
	into STRICT	cd_procedimento_w
	;

	select	max(nr_sequencia)
	into STRICT	nr_sequencia_proc_w
	from	procedimento_autorizado
	where	nr_sequencia_autor		= nr_sequencia_autor_p
	and (cd_procedimento		= (cd_procedimento_w)::numeric  or
		cd_procedimento_tuss		= cd_procedimento_w or
		cd_procedimento_convenio	= cd_procedimento_p);

	if (coalesce(nr_sequencia_proc_w::text, '') = '') then
		select	max(nr_sequencia)
		into STRICT	nr_sequencia_mat_w
		from	material_autorizado
		where	nr_sequencia_autor		= nr_sequencia_autor_p
		and	((cd_material		= (cd_procedimento_w)::numeric ) or (cd_material_convenio	= cd_procedimento_p) or (cd_material_tuss       = (cd_procedimento_w)::numeric ));

	end if;

	insert into TISS_RETORNO_AUTORIZACAO(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_autorizacao,
		nr_seq_motivo_glosa,
		nr_seq_proc_autor,
		dt_evento,
		ds_erro_retorno,
		nr_seq_mat_autor)
	values (nextval('tiss_retorno_autorizacao_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_sequencia_autor_p,
		CASE WHEN nr_seq_motivo_glosa_w=0 THEN null  ELSE nr_seq_motivo_glosa_w END ,
		nr_sequencia_proc_w,
		clock_timestamp(),
		ds_observacao_p,
		nr_sequencia_mat_w);

	commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_gravar_ret_item_autor (nr_sequencia_autor_p bigint, nm_usuario_p text, cd_procedimento_p text, nr_seq_motivo_glosa_p text, ds_observacao_p text) FROM PUBLIC;

