-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_ajustar_min_max_tit_notif ( nr_seq_lote_notif_p bigint, qt_min_titulo_p bigint, qt_max_titulo_p bigint, ie_qtd_tit_competencia_p pls_notificacao_regra.ie_qtd_tit_competencia%type) AS $body$
DECLARE


nr_seq_notif_pagador_w		bigint;
qt_titulos_notif_w		bigint;

C01 CURSOR FOR
	SELECT	a.nr_sequencia
	from	pls_notificacao_pagador	a
	where	a.nr_seq_lote	= nr_seq_lote_notif_p;


BEGIN
open C01;
loop
fetch C01 into
	nr_seq_notif_pagador_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (ie_qtd_tit_competencia_p = 'S') then
		select	count(1)
		into STRICT	qt_titulos_notif_w
		from (SELECT coalesce(pls_obter_dados_item_notif(a.nr_sequencia, 'DM'), trunc(b.dt_emissao, 'mm')) qt_tit
			from	pls_notificacao_item	a,
				titulo_receber b
			where	b.nr_titulo = a.nr_titulo
			and	a.nr_seq_notific_pagador = nr_seq_notif_pagador_w
			group by
				coalesce(pls_obter_dados_item_notif(a.nr_sequencia, 'DM'), trunc(b.dt_emissao, 'mm'))
			) alias8;
	else
		select	count(1)
		into STRICT	qt_titulos_notif_w
		from	pls_notificacao_item	a
		where	a.nr_seq_notific_pagador	= nr_seq_notif_pagador_w;
	end if;

	if (qt_titulos_notif_w >= qt_min_titulo_p) and (qt_titulos_notif_w <= qt_max_titulo_p) then
		null;
	else
		delete	from pls_notificacao_item
		where	nr_seq_notific_pagador	= nr_seq_notif_pagador_w;

		delete	from pls_notificacao_pagador
		where	nr_sequencia	= nr_seq_notif_pagador_w;
	end if;
	end;
end loop;
close C01;

--NÃ£o pode commitar!!!!!
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ajustar_min_max_tit_notif ( nr_seq_lote_notif_p bigint, qt_min_titulo_p bigint, qt_max_titulo_p bigint, ie_qtd_tit_competencia_p pls_notificacao_regra.ie_qtd_tit_competencia%type) FROM PUBLIC;

