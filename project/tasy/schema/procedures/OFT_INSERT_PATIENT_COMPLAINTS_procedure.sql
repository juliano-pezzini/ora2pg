-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE oft_insert_patient_complaints ( nr_atendimento_p bigint, nr_seq_consulta_p bigint, nr_seq_consulta_form_p bigint, vListaPatComplaints strRecTypeFormOft) AS $body$
DECLARE

  ds_erro_w varchar(4000);
  ds_reason_consultation_w atend_queixa_paciente.ds_motivo_consulta%type;
  ds_current_illness_w atend_queixa_paciente.ds_doenca_atual%type;
  nr_seq_atend_queixa_paciente_w atend_queixa_paciente.nr_sequencia%type;
  nm_usuario_w atend_queixa_paciente.nm_usuario%type := wheb_usuario_pck.get_nm_usuario;
  cd_pessoa_fisica_w atend_queixa_paciente.cd_pessoa_fisica%type;
BEGIN
  BEGIN
    FOR i IN 1..vListaPatComplaints.COUNT
    LOOP
      BEGIN
        IF (vListaPatComplaints[i](.ds_valor IS NOT NULL AND .ds_valor::text <> '')) OR (vListaPatComplaints[i](.nr_valor IS NOT NULL AND .nr_valor::text <> '')) THEN
          CASE UPPER(vListaPatComplaints[i].nm_campo)
          WHEN 'DS_MOTIVO_CONSULTA' THEN
            ds_reason_consultation_w := vListaPatComplaints[i].ds_valor;
          WHEN 'DS_DOENCA_ATUAL' THEN
            ds_current_illness_w := vListaPatComplaints[i].ds_valor;
          ELSE
            NULL;
          END CASE;
        END IF;
      END;
    END LOOP;
    SELECT nextval('atend_queixa_paciente_seq')
    INTO STRICT nr_seq_atend_queixa_paciente_w
;
    SELECT MAX(cd_pessoa_fisica)
    INTO STRICT cd_pessoa_fisica_w
    FROM atendimento_paciente
    WHERE nr_atendimento = nr_atendimento_p;
    INSERT
    INTO atend_queixa_paciente(
        nr_sequencia,
        dt_atualizacao,
        nm_usuario,
        dt_atualizacao_nrec,
        nm_usuario_nrec,
        ds_doenca_atual,
        ds_motivo_consulta,
        cd_pessoa_fisica,
        nr_atendimento,
        ie_situacao,
        nr_seq_consulta_form
      )
      VALUES (
        nr_seq_atend_queixa_paciente_w,
        clock_timestamp(),
        nm_usuario_w,
        clock_timestamp(),
        nm_usuario_w,
        ds_current_illness_w,
        ds_reason_consultation_w,
        cd_pessoa_fisica_w,
        nr_atendimento_p,
        'A',
        nr_seq_consulta_form_p
      );
    CALL wheb_usuario_pck.set_ie_commit('S');
  EXCEPTION
  WHEN OTHERS THEN
    ds_erro_w := SUBSTR(sqlerrm,1,4000);
    UPDATE OFT_CONSULTA_FORMULARIO
    SET ds_stack = SUBSTR(dbms_utility.format_call_stack
      ||ds_erro_w,1,4000)
    WHERE nr_sequencia = nr_seq_consulta_form_p;
  END;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE oft_insert_patient_complaints ( nr_atendimento_p bigint, nr_seq_consulta_p bigint, nr_seq_consulta_form_p bigint, vListaPatComplaints strRecTypeFormOft) FROM PUBLIC;

