-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reverter_prim_chec_item ( nr_seq_horario_p prescr_mat_hor.nr_sequencia%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nr_seq_solucao_p prescr_solucao_evento.nr_seq_solucao%type, ie_tipo_item_p w_adep_t.ie_tipo_item%type ) AS $body$
DECLARE


ie_dupl_chec_seq_w varchar(1);
ie_evento_anterior_w varchar(1);
nr_prescricao_w prescr_medica.nr_prescricao%type;
nr_seq_material_w prescr_material.nr_sequencia%type;
nr_seq_procedimento_w prescr_procedimento.nr_sequencia%type;
nr_etapa_atual_w prescr_solucao_evento.nr_etapa_evento%type;
ie_tipo_solucao_w prescr_solucao_evento.ie_tipo_solucao%type;


BEGIN

ie_dupl_chec_seq_w := wheb_assist_pck.obterParametroFuncao( cd_funcao_p          => -1113,
                                                            nr_parametro_p       => 72,
                                                            cd_perfil_p          => wheb_usuario_pck.get_cd_perfil,
                                                            nm_usuario_p         => wheb_usuario_pck.get_nm_usuario,
                                                            cd_estabelecimento_p => wheb_usuario_pck.get_cd_estabelecimento );

if (((nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') or (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '' AND nr_seq_solucao_p IS NOT NULL AND nr_seq_solucao_p::text <> '')) and
        (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') and
        ie_dupl_chec_seq_w = 'S') then
    if (ie_tipo_item_p in ('M', 'IAH', 'S', 'IAG', 'IA')) then
        select  max(a.nr_prescricao),
                max(b.nr_sequencia)
        into STRICT    nr_prescricao_w,
                nr_seq_material_w
        from    prescr_medica a,
                prescr_material b,
                prescr_mat_hor c
        where   a.nr_prescricao = b.nr_prescricao
        and     a.nr_prescricao = c.nr_prescricao
        and     b.nr_prescricao = c.nr_prescricao
        and     b.nr_sequencia  = c.nr_seq_material
        and     c.nr_sequencia  = nr_seq_horario_p;

        select  coalesce(max('S'),'N')
        into STRICT    ie_evento_anterior_w
        from    prescr_mat_alteracao a
        where   a.nr_prescricao = coalesce(nr_prescricao_p, nr_prescricao_w)
        and     a.nr_seq_prescricao = nr_seq_material_w
        and     a.nr_seq_horario = nr_seq_horario_p
        and     a.ie_alteracao = 47
        and     coalesce(a.ie_evento_valido,'S') = 'S';

        if (ie_evento_anterior_w = 'S') then
            CALL reverter_primeira_checagem( nr_seq_horario_p    => nr_seq_horario_p,
                                        ds_justificativa_p  => null,
                                        ds_observacao_p     => null,
                                        ie_tipo_item_p      => ie_tipo_item_p,
                                        dt_evento_p         => clock_timestamp(),
                                        nm_usuario_p        => wheb_usuario_pck.get_nm_usuario,
                                        cd_perfil_p         => wheb_usuario_pck.get_cd_perfil );
        end if;
    elsif (ie_tipo_item_p in ('P', 'L', 'C', 'G', 'HM')) then
        select  max(b.nr_sequencia)
        into STRICT    nr_seq_procedimento_w
        from    prescr_procedimento b,
                prescr_proc_hor c
        where   b.nr_prescricao = c.nr_prescricao
        and     b.nr_sequencia  = c.nr_seq_procedimento
        and     c.nr_sequencia  = nr_seq_horario_p;

        select  coalesce(max('S'),'N')
        into STRICT    ie_evento_anterior_w
        from    prescr_mat_alteracao a
        where   a.nr_prescricao = coalesce(nr_prescricao_p, nr_prescricao_w)
        and     a.nr_seq_procedimento = nr_seq_procedimento_w
        and     a.nr_seq_horario_proc = nr_seq_horario_p
        and     a.ie_alteracao = 47
        and     coalesce(a.ie_evento_valido,'S') = 'S';

        if (ie_evento_anterior_w = 'S') then
            CALL reverter_primeira_checagem( nr_seq_horario_p    => nr_seq_horario_p,
                                        ds_justificativa_p  => null,
                                        ds_observacao_p     => null,
                                        ie_tipo_item_p      => ie_tipo_item_p,
                                        dt_evento_p         => clock_timestamp(),
                                        nm_usuario_p        => wheb_usuario_pck.get_nm_usuario,
                                        cd_perfil_p         => wheb_usuario_pck.get_cd_perfil );
        end if;
    elsif (ie_tipo_item_p in ('SOL', 'SNE', 'HM')) then
        if (ie_tipo_item_p = 'SOL') then
            nr_etapa_atual_w := obter_etapa_atual(nr_prescricao_p, nr_seq_solucao_p);
        elsif (ie_tipo_item_p = 'SNE') then
            nr_etapa_atual_w := obter_etapa_atual_sne(nr_prescricao_p, nr_seq_solucao_p);
        elsif (ie_tipo_item_p = 'HM') then
            nr_etapa_atual_w := obter_etapa_atual_proc(nr_prescricao_p, nr_seq_solucao_p);
        end if;

        select  coalesce(max('S'),'N'),
                max(a.ie_tipo_solucao)
        into STRICT    ie_evento_anterior_w,
                ie_tipo_solucao_w
        from    prescr_solucao_evento a
        where   a.nr_prescricao = nr_prescricao_p
        and     a.nr_seq_solucao = nr_seq_solucao_p
        and     a.nr_etapa_evento = nr_etapa_atual_w
        and     a.ie_alteracao = 37
        and     coalesce(a.ie_evento_valido,'S') = 'S';

        if (ie_evento_anterior_w = 'S') then
            CALL reverter_primeira_checagem_sol( nr_prescricao_p     => nr_prescricao_p,
                                            nr_seq_item_p       => nr_seq_solucao_p,
                                            ie_tipo_solucao_p   => ie_tipo_solucao_w,
                                            nr_horario_evento_p => null,
                                            nm_usuario_p        => wheb_usuario_pck.get_nm_usuario );
        end if;
    end if;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reverter_prim_chec_item ( nr_seq_horario_p prescr_mat_hor.nr_sequencia%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nr_seq_solucao_p prescr_solucao_evento.nr_seq_solucao%type, ie_tipo_item_p w_adep_t.ie_tipo_item%type ) FROM PUBLIC;

