-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE registrar_disp_protocolo_cir (nr_seq_dispositivo_p bigint, ie_lado_disp_p text, ie_acao_disp_p text, ie_opcao_p text, nr_cirurgia_p bigint, nm_usuario_p text, nr_seq_pepo_p bigint, dt_inicio_p timestamp) AS $body$
DECLARE

 
nr_atendimento_w	bigint;
nr_sequencia_w		bigint;
nr_seq_disp_proc_w	bigint;
cd_pessoa_fisica_w	varchar(10);
ie_acao_w		varchar(15);


BEGIN 
 
if (nr_cirurgia_p IS NOT NULL AND nr_cirurgia_p::text <> '') then 
	select max(nr_atendimento) 
	into STRICT	nr_atendimento_w 
	from 	cirurgia 
	where 	nr_cirurgia = nr_cirurgia_p;
elsif (nr_seq_pepo_p IS NOT NULL AND nr_seq_pepo_p::text <> '') then 
	select max(nr_atendimento) 
	into STRICT	nr_atendimento_w 
	from 	pepo_cirurgia 
	where  nr_sequencia = nr_seq_pepo_p;
end if;
 
 
select	obter_dados_usuario_opcao(nm_usuario_p,'C') 
into STRICT	cd_pessoa_fisica_w
;
 
 
if (ie_opcao_p = 'N') then 
	begin 
	ie_acao_w	:= obter_acao_procedimento(ie_acao_disp_p, nr_seq_dispositivo_p,'P');
 
	select	nextval('atend_pac_dispositivo_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	insert into atend_pac_dispositivo( 
		nr_sequencia, 
		nr_atendimento, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_seq_dispositivo, 
		dt_instalacao, 
		nr_seq_topografia, 
		ie_lado, 
		ds_titulo, 
		dt_retirada, 
		qt_hora_permanencia, 
		dt_retirada_prev, 
		ds_compl_topografia, 
		nr_cirurgia, 
		dt_retir_prev_curat, 
		qt_hora_perm_curat, 
		qt_tentativas, 
		qt_disp_utilizados, 
		ie_acao, 
		cd_profissional, 
		nr_seq_calibre) 
	values ( 
		nr_sequencia_w, 
		nr_atendimento_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_seq_dispositivo_p, 
		dt_inicio_p, 
		null, 
		ie_lado_disp_p, 
		null, 
		null, 
		null, 
		null, 
		null, 
		nr_cirurgia_p, 
		null, 
		null, 
		null, 
		null, 
		ie_acao_disp_p, 
		cd_pessoa_fisica_w, 
		null);
 
	if (ie_acao_disp_p > 0) then 
		begin 
		select	nextval('atend_pac_disp_proc_seq') 
		into STRICT	nr_seq_disp_proc_w 
		;
 
		insert into atend_pac_disp_proc( 
			nr_sequencia, 
			nr_seq_disp_pac, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			nr_seq_proc_interno, 
			dt_procedimento, 
			cd_pessoa_fisica, 
			cd_setor_atendimento) 
		values ( 
			nr_seq_disp_proc_w, 
			nr_sequencia_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			ie_acao_disp_p, 
			clock_timestamp(), 
			cd_pessoa_fisica_w, 
			campo_numerico(obter_unidade_atendimento(nr_atendimento_w,'A','CS')));
		end;
	end if;
 
	CALL adep_cobranca_dispositivo(nr_atendimento_w,nr_seq_dispositivo_p,nr_seq_disp_proc_w ,nm_usuario_p,'i',ie_acao_disp_p);
 
 
	commit;
 
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE registrar_disp_protocolo_cir (nr_seq_dispositivo_p bigint, ie_lado_disp_p text, ie_acao_disp_p text, ie_opcao_p text, nr_cirurgia_p bigint, nm_usuario_p text, nr_seq_pepo_p bigint, dt_inicio_p timestamp) FROM PUBLIC;

