-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_rpc ( nr_seq_lote_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


ds_conteudo_w			varchar(4000);
ds_razao_social_w		varchar(255);
ds_plano_w			varchar(255);
ds_justificativa_w		varchar(255);
nr_contrato_arquivo_w		pls_rpc_contrato.nr_contrato_arquivo%type;
cd_ans_w			varchar(20);
nr_protocolo_ans_w		varchar(20);
cd_plano_operadora_w		varchar(20);
cd_scpa_w			varchar(20);
cd_scpa_contrato_w		varchar(20);
cd_cgc_outorgante_w		varchar(14);
uf_contrato_w			varchar(2);
ie_caracteristica_w		varchar(2);
ie_participacao_w		varchar(1);
ie_percentual_w			varchar(1);
ie_franquia_copartic_w		varchar(1);
ie_gerar_franquia_w		varchar(1);
vl_copartic_anterior_w		double precision;
vl_copartic_reajustado_w	double precision;
qt_beneficiarios_w		integer;
qt_beneficiarios_aux_w		integer;
nr_seq_contrato_w		bigint;
nr_seq_reajuste_w		bigint;
nr_seq_plano_w			bigint;
qt_linhas_w			bigint;
qt_linhas_c2_w			bigint;
qt_linhas_c3_w			bigint;
qt_linhas_c4_w			bigint;
nr_seq_c1_w			bigint;
nr_seq_c2_w			bigint;
nr_seq_c3_w			bigint;
tx_reajuste_w			double precision;
tx_reajuste_copartic_w		double precision;
dt_reajuste_w			timestamp;
dt_referencia_qt_vidas_w	timestamp;
nr_contrato_w			pls_contrato.nr_contrato%type;
ie_majoritario_w		pls_rpc_arquivo.ie_majoritario%type;
qt_estados_benef_w		integer;
sg_estado_contrato_w		compl_pessoa_fisica.sg_estado%type;
vl_total_conta_w		pls_conta.vl_total%type;
vl_total_conta_ant_w		pls_conta.vl_total%type;
dt_inicio_analise_w		timestamp;
dt_fim_analise_w		timestamp;
dt_contrato_w			pls_contrato.dt_contrato%type;
ie_gerou_franquia_w		varchar(1);
dt_reajuste_contrato_w		pls_prog_reaj_coletivo.dt_reajuste_contrato%type;
dt_inicio_reajuste_w		timestamp;
dt_fim_reajuste_w		timestamp;
qt_copartic_reajuste_w		bigint;
ie_negociacao_w			varchar(1);
ie_regulamentacao_w		pls_plano.ie_regulamentacao%type;
ie_considerar_dt_retro_w	pls_regra_rpc.ie_considerar_dt_retro%type;
qt_regra_cobr_retro_w		bigint;
dt_aplicacao_reajuste_w		timestamp;
dt_inicio_reaj_w		timestamp;
dt_fim_reaj_w			timestamp;
ds_observacao_reaj_copart_w	pls_regra_rpc.ds_observacao_reaj_copart%type;
qt_vidas_w			pls_prog_reaj_coletivo.qt_vidas%type;
dt_reajuste_grupo_contrato_w	pls_grupo_contrato.dt_reajuste%type;
nr_seq_grupo_contrato_w		pls_grupo_contrato.nr_sequencia%type;
ie_tipo_agrupamento_excl_w	pls_reajuste.ie_tipo_agrupamento_exclusivo%type;
ie_data_analise_grupo_w		varchar(1);
dt_inicial_w			timestamp;
dt_final_w			timestamp;
dt_comunicado_w			timestamp;
dt_inicio_analise_reaj_w	timestamp;
dt_fim_analise_reaj_w		timestamp;
qt_beneficiario_alt_plano_w	bigint;
qt_benef_alt_aux_plano_w	bigint;
ie_produto_sem_benef_ativo_w	pls_regra_rpc.ie_produto_sem_benef_ativo%type;
dt_inativacao_produto_w		pls_contrato_plano.dt_inativacao%type;
dt_inicio_reajuste_regra_w	pls_regra_rpc.dt_inicio_reajuste%type;
dt_fim_reajuste_regra_w		pls_regra_rpc.dt_fim_reajuste%type;
tx_reajuste_correto_w		pls_reajuste.tx_reajuste_correto%type;
tx_reajuste_origem_w		pls_reajuste.tx_reajuste%type;

C01 CURSOR FOR
	SELECT	'N' ie_negociacao,
		e.nr_seq_contrato,
		a.dt_reajuste,
		null dt_reajuste_contrato,
		CASE WHEN coalesce(a.tx_reajuste_correto,0)=0 THEN coalesce(a.tx_reajuste,0)  ELSE a.tx_reajuste_correto END  tx_reajuste,
		CASE WHEN a.ie_reajustar_copartic='S' THEN CASE WHEN c.ie_coparticipacao='S' THEN coalesce(a.tx_reajuste_proposto,0)  ELSE 0 END   ELSE 0 END  tx_reajuste_copartic,
		c.nr_protocolo_ans,
		a.nr_sequencia	nr_seq_reajuste,
		substr(coalesce(e.nr_contrato_arquivo,d.nr_contrato),1,20) nr_contrato_arquivo,
		CASE WHEN coalesce(d.ie_participacao, c.ie_participacao)='C' THEN 1 WHEN coalesce(d.ie_participacao, c.ie_participacao)='S' THEN 2  ELSE 2 END  ie_participacao,
		CASE WHEN coalesce(a.tx_deflator::text, '') = '' THEN 'P'  ELSE 'N' END  ie_percentual,
		substr(obter_dados_pf_pj(d.cd_pf_estipulante,d.cd_cgc_estipulante,'UF'),1,2) uf_contrato,
		CASE WHEN a.ie_reajustar_copartic='S' THEN CASE WHEN c.ie_coparticipacao='S' THEN 'S'  ELSE 'N' END   ELSE 'N' END 	ie_franquia_copartic,
		e.ie_caracteristica,
		coalesce(e.ds_justificativa,'Justificado') ds_justificativa,
		e.ie_gerar_franquia,
		c.cd_scpa,
		d.cd_scpa,
		d.nr_contrato,
		d.dt_contrato,
		c.ie_regulamentacao,
		a.dt_aplicacao_reajuste dt_aplicacao_reajuste,
		a.ie_tipo_agrupamento_exclusivo,
		a.dt_inicio_analise,
		a.dt_fim_analise,
		coalesce(a.tx_reajuste_correto,0) tx_reajuste_correto,
		(	SELECT	max(x.tx_reajuste)
			from	pls_reajuste x
			where	x.nr_seq_lote_deflator = a.nr_sequencia) tx_reajuste_origem
	from	pls_reajuste		a,
		pls_contrato_plano	f,
		pls_contrato		d,
		pls_plano		c,
		pls_rpc_contrato	e
	where	d.nr_sequencia	= a.nr_seq_contrato
	and	a.nr_sequencia	= e.nr_seq_reajuste
	and	d.nr_sequencia	= f.nr_seq_contrato
	and	c.nr_sequencia	= f.nr_seq_plano
	and	e.nr_seq_lote	= nr_seq_lote_p
	and	c.ie_tipo_operacao	= 'B'
	and	coalesce(a.ie_reaj_nao_aplicado,'N')	= 'N'
	and 	coalesce(d.ie_contrato_ex_funcionario,'N') = 'N'
	and	coalesce(e.nr_seq_grupo_contrato::text, '') = ''
	group by
		c.nr_protocolo_ans,
		d.nr_contrato,
		c.ie_participacao,
		d.ie_participacao,
		a.dt_reajuste,
		a.tx_deflator,
		a.tx_reajuste,
		a.tx_reajuste_proposto,
		d.cd_pf_estipulante,
		d.cd_cgc_estipulante,
		a.ie_reajustar_copartic,
		c.ie_coparticipacao,
		a.nr_sequencia,
		e.ie_caracteristica,
		e.nr_contrato_arquivo,
		e.nr_seq_contrato,
		e.ds_justificativa,
		e.ie_gerar_franquia,
		c.cd_scpa,
		d.cd_scpa,
		d.dt_contrato,
		a.tx_reajuste_correto,
		c.ie_regulamentacao,
		a.dt_aplicacao_reajuste,
		a.ie_tipo_agrupamento_exclusivo,
		a.dt_inicio_analise,
		a.dt_fim_analise,
		a.nr_sequencia
	
union all
  --Contratos em negociacao
	select	'S' ie_negociacao,
		b.nr_seq_contrato,
		coalesce(a.dt_reajuste, f.dt_mes_reajuste),
		a.dt_reajuste_contrato,
		0,
		0 tx_reajuste_copartic,
		e.nr_protocolo_ans,
		null	nr_seq_reajuste,
		substr(coalesce(b.nr_contrato_arquivo,c.nr_contrato),1,20) nr_contrato_arquivo,
		CASE WHEN coalesce(c.ie_participacao, e.ie_participacao)='C' THEN 1 WHEN coalesce(c.ie_participacao, e.ie_participacao)='S' THEN 2  ELSE 2 END  ie_participacao,
		'P' ie_percentual,
		substr(obter_dados_pf_pj(c.cd_pf_estipulante,c.cd_cgc_estipulante,'UF'),1,2) uf_contrato,
		'N'	ie_franquia_copartic,
		b.ie_caracteristica,
		substr(coalesce(b.ds_justificativa,'Justificado'),1,100) ds_justificativa,
		b.ie_gerar_franquia,
		e.cd_scpa,
		c.cd_scpa,
		c.nr_contrato,
		c.dt_contrato,
		e.ie_regulamentacao,
		null dt_aplicacao_reajuste,
		null ie_tipo_agrupamento_exclusivo,
		null dt_inicio_analise,
		null dt_fim_analise,
		0 tx_reajuste_correto,
		0 tx_reajuste_origem
	from	pls_prog_reaj_coletivo	a,
		pls_rpc_contrato	b,
		pls_contrato		c,
		pls_contrato_plano	d,
		pls_plano		e,
		pls_prog_reaj_colet_lote f
	where	a.nr_sequencia	= b.nr_seq_reajuste_prog
	and	c.nr_sequencia	= b.nr_seq_contrato
	and	c.nr_sequencia	= d.nr_seq_contrato
	and	e.nr_sequencia	= d.nr_seq_plano
	and	f.nr_sequencia	= a.nr_seq_lote
	and	b.nr_seq_lote	= nr_seq_lote_p
	and	e.ie_tipo_operacao = 'B'
	and	coalesce(b.nr_seq_reajuste::text, '') = ''
	and 	coalesce(c.ie_contrato_ex_funcionario,'N') = 'N'
	and	coalesce(b.nr_seq_grupo_contrato::text, '') = ''
	group by
		c.nr_contrato,
		a.dt_reajuste,
		a.dt_reajuste_contrato,
		c.cd_pf_estipulante,
		c.cd_cgc_estipulante,
		b.ie_caracteristica,
		b.nr_contrato_arquivo,
		b.nr_seq_contrato,
		b.ds_justificativa,
		b.ie_gerar_franquia,
		e.nr_protocolo_ans,
		e.ie_participacao,
		c.ie_participacao,
		e.ie_franquia,
		e.ie_coparticipacao,
		f.dt_mes_reajuste,
		e.cd_scpa,
		c.cd_scpa,
		c.dt_contrato,
		e.ie_regulamentacao
	
union all
  --Reajuste nao aplicado
	select	'N' ie_negociacao,
		b.nr_seq_contrato,
		g.dt_reajuste,
		null dt_reajuste_contrato,
		0,
		0 tx_reajuste_copartic,
		e.nr_protocolo_ans,
		g.nr_sequencia	nr_seq_reajuste,
		substr(coalesce(b.nr_contrato_arquivo,c.nr_contrato),1,20) nr_contrato_arquivo,
		CASE WHEN coalesce(c.ie_participacao, e.ie_participacao)='C' THEN 1 WHEN coalesce(c.ie_participacao, e.ie_participacao)='S' THEN 2  ELSE 2 END  ie_participacao,
		'P' ie_percentual,
		substr(obter_dados_pf_pj(c.cd_pf_estipulante,c.cd_cgc_estipulante,'UF'),1,2) uf_contrato,
		'N' ie_franquia_copartic,
		b.ie_caracteristica,
		substr(coalesce(b.ds_justificativa,'Justificado'),1,100) ds_justificativa,
		b.ie_gerar_franquia,
		e.cd_scpa,
		c.cd_scpa,
		c.nr_contrato,
		c.dt_contrato,
		e.ie_regulamentacao,
		g.dt_aplicacao_reajuste dt_aplicacao_reajuste,
		g.ie_tipo_agrupamento_exclusivo,
		g.dt_inicio_analise,
		g.dt_fim_analise,
		0 tx_reajuste_correto,
		0 tx_reajuste_origem
	from	pls_rpc_contrato	b,
		pls_contrato		c,
		pls_contrato_plano	d,
		pls_plano		e,
		pls_reajuste		g
	where	c.nr_sequencia	= b.nr_seq_contrato
	and	c.nr_sequencia	= d.nr_seq_contrato
	and	e.nr_sequencia	= d.nr_seq_plano
	and	b.nr_seq_lote	= nr_seq_lote_p
	and	g.nr_sequencia 	= b.nr_seq_reajuste
	and	e.ie_tipo_operacao = 'B'
	and	coalesce(g.ie_reaj_nao_aplicado,'N')	= 'S'
	and 	coalesce(c.ie_contrato_ex_funcionario,'N') = 'N'
	and	coalesce(b.nr_seq_grupo_contrato::text, '') = ''
	group by
		c.nr_contrato,
		g.dt_reajuste,
		c.cd_pf_estipulante,
		c.cd_cgc_estipulante,
		b.ie_caracteristica,
		b.nr_contrato_arquivo,
		b.nr_seq_contrato,
		b.ds_justificativa,
		b.ie_gerar_franquia,
		e.nr_protocolo_ans,
		e.ie_participacao,
		c.ie_participacao,
		e.ie_franquia,
		e.ie_coparticipacao,
		e.cd_scpa,
		c.cd_scpa,
		c.dt_contrato,
		g.nr_sequencia,
		e.ie_regulamentacao,
		g.dt_aplicacao_reajuste,
		g.ie_tipo_agrupamento_exclusivo,
		g.dt_inicio_analise,
		g.dt_fim_analise
	
union all

	select	'N' ie_negociacao,
		e.nr_seq_contrato,
		a.dt_reajuste,
		null dt_reajuste_contrato,
		CASE WHEN coalesce(a.tx_reajuste_correto,0)=0 THEN coalesce(a.tx_reajuste,0)  ELSE a.tx_reajuste_correto END  tx_reajuste,
		CASE WHEN a.ie_reajustar_copartic='S' THEN CASE WHEN c.ie_coparticipacao='S' THEN coalesce(a.tx_reajuste_proposto,0)  ELSE 0 END   ELSE 0 END  tx_reajuste_copartic,
		c.nr_protocolo_ans,
		a.nr_sequencia	nr_seq_reajuste,
		substr(coalesce(e.nr_contrato_arquivo,d.nr_contrato),1,20) nr_contrato_arquivo,
		CASE WHEN coalesce(d.ie_participacao, c.ie_participacao)='C' THEN 1 WHEN coalesce(d.ie_participacao, c.ie_participacao)='S' THEN 2  ELSE 2 END  ie_participacao,
		CASE WHEN coalesce(a.tx_deflator::text, '') = '' THEN 'P'  ELSE 'N' END  ie_percentual,
		substr(obter_dados_pf_pj(d.cd_pf_estipulante,d.cd_cgc_estipulante,'UF'),1,2) uf_contrato,
		CASE WHEN a.ie_reajustar_copartic='S' THEN CASE WHEN c.ie_coparticipacao='S' THEN 'S'  ELSE 'N' END   ELSE 'N' END 	ie_franquia_copartic,
		e.ie_caracteristica,
		coalesce(e.ds_justificativa,'Justificado') ds_justificativa,
		e.ie_gerar_franquia,
		c.cd_scpa,
		d.cd_scpa,
		d.nr_contrato,
		d.dt_contrato,
		c.ie_regulamentacao,
		a.dt_aplicacao_reajuste dt_aplicacao_reajuste,
		a.ie_tipo_agrupamento_exclusivo,
		a.dt_inicio_analise,
		a.dt_fim_analise,
		coalesce(a.tx_reajuste_correto,0) tx_reajuste_correto,
		(	select	max(x.tx_reajuste)
			from	pls_reajuste x
			where	x.nr_seq_lote_deflator = a.nr_sequencia) tx_reajuste_origem
	FROM pls_contrato_plano f, pls_contrato d, pls_plano c, pls_reajuste a
LEFT OUTER JOIN pls_rpc_contrato e ON (a.nr_sequencia = e.nr_seq_reajuste)
WHERE d.nr_sequencia	= a.nr_seq_contrato  and d.nr_sequencia	= f.nr_seq_contrato and c.nr_sequencia	= f.nr_seq_plano and e.nr_seq_lote	= nr_seq_lote_p and c.ie_tipo_operacao	= 'B' and coalesce(a.ie_reaj_nao_aplicado,'N')	= 'N' and coalesce(d.ie_contrato_ex_funcionario,'N') = 'S' and (d.nr_contrato_principal IS NOT NULL AND d.nr_contrato_principal::text <> '') and not exists (	select	1
				from	pls_reajuste x
				where	x.nr_seq_contrato = d.nr_contrato_principal
				and 	x.dt_reajuste between coalesce(dt_inicial_w,a.dt_reajuste) and coalesce(dt_final_w,a.dt_reajuste)) and coalesce(e.nr_seq_grupo_contrato::text, '') = '' group by
		c.nr_protocolo_ans,
		d.nr_contrato,
		c.ie_participacao,
		d.ie_participacao,
		a.dt_reajuste,
		a.tx_deflator,
		a.tx_reajuste,
		a.tx_reajuste_proposto,
		d.cd_pf_estipulante,
		d.cd_cgc_estipulante,
		a.ie_reajustar_copartic,
		c.ie_coparticipacao,
		a.nr_sequencia,
		e.ie_caracteristica,
		e.nr_contrato_arquivo,
		e.nr_seq_contrato,
		e.ds_justificativa,
		e.ie_gerar_franquia,
		c.cd_scpa,
		d.cd_scpa,
		d.dt_contrato,
		a.tx_reajuste_correto,
		c.ie_regulamentacao,
		a.dt_aplicacao_reajuste,
		a.ie_tipo_agrupamento_exclusivo,
		a.dt_inicio_analise,
		a.dt_fim_analise,
		a.nr_sequencia
	order by 1;

C02 CURSOR(	nr_seq_plano_pc		pls_plano.nr_sequencia%type) FOR
	SELECT 	sum(pls_obter_valor_regra_copartic(a.nr_seq_regra_atual,'A')) vl_copartic_anterior,
		sum(pls_obter_valor_regra_copartic(a.nr_seq_regra_gerada,'R')) vl_copartic_reajustado,
		substr(c.cd_item_cobertura,1,3) cd_item_cobertura,
		count(1) qt_item_cobertura
	from   	pls_reajuste_copartic   a,
		pls_lote_reaj_copartic  b,
		pls_tipo_coparticipacao c
	where  	a.nr_seq_lote           = b.nr_sequencia
	and    	a.nr_seq_regra_copartic = c.nr_sequencia
	and    	b.nr_seq_reajuste       = nr_seq_reajuste_w
	and     exists                  ( SELECT 1
					  from pls_regra_coparticipacao x
					  where x.nr_sequencia = a.nr_seq_regra_atual
					  and   ((x.nr_seq_plano = nr_seq_plano_pc) or (coalesce(x.nr_seq_plano::text, '') = '')))
	and	ie_gerar_franquia_w in ('S','Z')
	group by
		c.cd_item_cobertura;

C03 CURSOR(	dt_inicio_analise_pc		timestamp,
		dt_fim_analise_pc		timestamp,
		ie_grupo_contrato_pc		text,
		nr_seq_contrato_pc		pls_contrato.nr_sequencia%type,
		nr_seq_grupo_contrato_pc	pls_grupo_contrato.nr_sequencia%type,
		nr_seq_plano_pc			pls_plano.nr_sequencia%type,
		cd_scpa_pc			pls_plano.cd_scpa%type,
		nr_protocolo_ans_pc		pls_plano.nr_protocolo_ans%type,
		ie_regulamentacao_pc		pls_plano.ie_regulamentacao%type) FOR
	SELECT  sg_estado
	from 	(	SELECT	a.sg_estado,
				count(1) qt_benef
			from	compl_pessoa_fisica	a,
				pessoa_fisica		b,
				pls_segurado		c
			where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
			and	b.cd_pessoa_fisica	= c.cd_pessoa_fisica
			and	a.ie_tipo_complemento	= '1'
			and	c.nr_seq_contrato	= nr_seq_contrato_pc
			and	c.nr_seq_plano		= nr_seq_plano_pc
			and	(a.sg_estado IS NOT NULL AND a.sg_estado::text <> '')
			and	((coalesce(c.dt_rescisao::text, '') = '') or (c.dt_rescisao > dt_inicio_analise_pc))
			and 	c.dt_contratacao <= dt_fim_analise_pc
			group by a.sg_estado
			order by qt_benef desc) alias7
	where	ie_grupo_contrato_pc = 'N'
	
union all

	select  sg_estado
	from 	(	select	a.sg_estado,
				count(1) qt_benef
			from	compl_pessoa_fisica	a,
				pessoa_fisica		b,
				pls_segurado		c,
				pls_plano		d
			where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
			and	b.cd_pessoa_fisica	= c.cd_pessoa_fisica
			and	d.nr_sequencia		= c.nr_seq_plano
			and	a.ie_tipo_complemento	= '1'
			and	d.nr_protocolo_ans	= nr_protocolo_ans_pc
			and	exists (select	1
					from	pls_rpc_contrato x
					where	x.nr_seq_contrato	= c.nr_seq_contrato
					and	x.nr_seq_grupo_contrato	= nr_seq_grupo_contrato_pc
					and	x.nr_seq_lote		= nr_seq_lote_p)
			and	(a.sg_estado IS NOT NULL AND a.sg_estado::text <> '')
			and	((coalesce(c.dt_rescisao::text, '') = '') or (c.dt_rescisao > dt_inicio_analise_pc))
			and 	c.dt_contratacao <= dt_fim_analise_pc
			group by a.sg_estado
			order by qt_benef desc) alias15
	where	ie_grupo_contrato_pc = 'S'
	and	ie_regulamentacao_pc = 'P'
	
union all

	select  sg_estado
	from 	(	select	a.sg_estado,
				count(1) qt_benef
			from	compl_pessoa_fisica	a,
				pessoa_fisica		b,
				pls_segurado		c,
				pls_plano		d
			where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
			and	b.cd_pessoa_fisica	= c.cd_pessoa_fisica
			and	d.nr_sequencia		= c.nr_seq_plano
			and	a.ie_tipo_complemento	= '1'
			and	d.cd_scpa		= cd_scpa_pc
			and	exists (select	1
					from	pls_rpc_contrato x
					where	x.nr_seq_contrato	= c.nr_seq_contrato
					and	x.nr_seq_grupo_contrato	= nr_seq_grupo_contrato_pc
					and	x.nr_seq_lote		= nr_seq_lote_p)
			and	(a.sg_estado IS NOT NULL AND a.sg_estado::text <> '')
			and	((coalesce(c.dt_rescisao::text, '') = '') or (c.dt_rescisao > dt_inicio_analise_pc))
			and 	c.dt_contratacao <= dt_fim_analise_pc
			group by a.sg_estado
			order by qt_benef desc) alias23
	where	ie_grupo_contrato_pc = 'S'
	and	ie_regulamentacao_pc in ('A', 'R');

C05 CURSOR FOR
	SELECT	'N' ie_negociacao,
		e.nr_seq_grupo_contrato,
		e.nr_contrato_arquivo,
		e.ie_caracteristica,
		e.ie_gerar_franquia,
		substr(coalesce(e.ds_justificativa,'Justificado'),1,100) ds_justificativa,
		trunc(a.dt_reajuste,'month') dt_reajuste,
		CASE WHEN coalesce(a.tx_reajuste_correto,0)=0 THEN coalesce(a.tx_reajuste,0)  ELSE a.tx_reajuste_correto END  tx_reajuste,
		a.tx_deflator,
		CASE WHEN a.ie_reajustar_copartic='S' THEN CASE WHEN c.ie_coparticipacao='S' THEN coalesce(a.tx_reajuste_proposto,0)  ELSE 0 END   ELSE 0 END  tx_reajuste_copartic,
		CASE WHEN coalesce(a.tx_deflator::text, '') = '' THEN 'P'  ELSE 'N' END  ie_percentual,
		c.nr_protocolo_ans,
		c.cd_scpa,
		coalesce(c.ds_plano_rpc, c.ds_plano) ds_plano,
		CASE WHEN c.ie_participacao='C' THEN 1 WHEN c.ie_participacao='S' THEN 2  ELSE 2 END  ie_participacao,
		CASE WHEN a.ie_reajustar_copartic='S' THEN CASE WHEN c.ie_coparticipacao='S' THEN 'S'  ELSE 'N' END   ELSE 'N' END 	ie_franquia_copartic,
		(	SELECT	max(a.sg_estado)
			from	pessoa_juridica a,
				pls_grupo_contrato b
			where	a.cd_cgc = b.cd_cgc
			and	b.nr_sequencia = e.nr_seq_grupo_contrato) uf_contrato,
		c.ie_regulamentacao,
		a.dt_aplicacao_reajuste dt_aplicacao_reajuste,
		a.ie_tipo_agrupamento_exclusivo,
		coalesce(a.tx_reajuste_correto,0) tx_reajuste_correto,
		max(a.nr_sequencia) nr_seq_reajuste
	from	pls_reajuste		a,
		pls_contrato_plano	f,
		pls_contrato		d,
		pls_plano		c,
		pls_rpc_contrato	e
	where	d.nr_sequencia	= a.nr_seq_contrato
	and	a.nr_sequencia	= e.nr_seq_reajuste
	and	d.nr_sequencia	= f.nr_seq_contrato
	and	c.nr_sequencia	= f.nr_seq_plano
	and	e.nr_seq_lote	= nr_seq_lote_p
	and	c.ie_tipo_operacao	= 'B'
	and	f.ie_situacao	= 'A'
	and	coalesce(d.ie_contrato_ex_funcionario,'N') = 'N'
	and	(e.nr_seq_grupo_contrato IS NOT NULL AND e.nr_seq_grupo_contrato::text <> '')
	and	((c.ie_regulamentacao = 'P' AND c.nr_protocolo_ans IS NOT NULL AND c.nr_protocolo_ans::text <> '') or (c.ie_regulamentacao in ('A', 'R')) and (c.cd_scpa IS NOT NULL AND c.cd_scpa::text <> ''))
	group by e.nr_seq_grupo_contrato,
		e.nr_contrato_arquivo,
		e.ie_caracteristica,
		e.ie_gerar_franquia,
		e.ds_justificativa,
		trunc(a.dt_reajuste,'month'),
		a.tx_reajuste,
		a.tx_reajuste_correto,
		a.tx_deflator,
		a.tx_reajuste_proposto,
		CASE WHEN coalesce(a.tx_deflator::text, '') = '' THEN 'P'  ELSE 'N' END ,
		--c.nr_sequencia,
		c.nr_protocolo_ans,
		c.cd_scpa,
		c.ds_plano_rpc,
		c.ds_plano,
		c.ie_participacao,
		c.ie_coparticipacao,
		a.ie_reajustar_copartic,
		c.ie_regulamentacao,
		a.dt_aplicacao_reajuste,
		a.ie_tipo_agrupamento_exclusivo
	
union all

	select	'S' ie_negociacao,
		b.nr_seq_grupo_contrato,
		b.nr_contrato_arquivo,
		b.ie_caracteristica,
		b.ie_gerar_franquia,
		substr(coalesce(b.ds_justificativa,'Justificado'),1,100) ds_justificativa,
		trunc(a.dt_reajuste,'month') dt_reajuste,
		0 tx_reajuste,
		0 tx_deflator,
		0 tx_reajuste_copartic,
		'P' ie_percentual,
		e.nr_protocolo_ans,
		e.cd_scpa,
		coalesce(e.ds_plano_rpc, e.ds_plano) ds_plano,
		CASE WHEN e.ie_participacao='C' THEN 1 WHEN e.ie_participacao='S' THEN 2  ELSE 2 END  ie_participacao,
		'N' ie_franquia_copartic,
		(	select	max(x.sg_estado)
			from	pessoa_juridica x,
				pls_grupo_contrato y
			where	x.cd_cgc = y.cd_cgc
			and	y.nr_sequencia = b.nr_seq_grupo_contrato) uf_contrato,
		e.ie_regulamentacao,
		null dt_aplicacao_reajuste,
		null ie_tipo_agrupamento_exclusivo,
		null tx_reajuste_correto,
		null nr_seq_reajuste
	from	pls_prog_reaj_coletivo	a,
		pls_rpc_contrato	b,
		pls_contrato		c,
		pls_contrato_plano	d,
		pls_plano		e,
		pls_prog_reaj_colet_lote f
	where	a.nr_sequencia	= b.nr_seq_reajuste_prog
	and	c.nr_sequencia	= b.nr_seq_contrato
	and	c.nr_sequencia	= d.nr_seq_contrato
	and	e.nr_sequencia	= d.nr_seq_plano
	and	f.nr_sequencia	= a.nr_seq_lote
	and	b.nr_seq_lote	= nr_seq_lote_p
	and	coalesce(b.nr_seq_reajuste::text, '') = ''
	and	e.ie_tipo_operacao = 'B'
	and	d.ie_situacao	= 'A'
	and	coalesce(c.ie_contrato_ex_funcionario,'N') = 'N'
	and	(b.nr_seq_grupo_contrato IS NOT NULL AND b.nr_seq_grupo_contrato::text <> '')
	and	((e.ie_regulamentacao = 'P' AND e.nr_protocolo_ans IS NOT NULL AND e.nr_protocolo_ans::text <> '') or (e.ie_regulamentacao in ('A', 'R')) and (e.cd_scpa IS NOT NULL AND e.cd_scpa::text <> ''))
	group by b.nr_seq_grupo_contrato,
		b.nr_contrato_arquivo,
		b.ie_caracteristica,
		b.ie_gerar_franquia,
		b.ds_justificativa,
		trunc(a.dt_reajuste,'month'),
		e.nr_protocolo_ans,
		e.cd_scpa,
		e.ds_plano_rpc,
		e.ds_plano,
		e.ie_participacao,
		e.ie_franquia,
		e.ie_regulamentacao;

C06 CURSOR(	ie_gerar_franquia_pc		text,
		nr_seq_grupo_contrato_pc	pls_grupo_contrato.nr_sequencia%type,
		nr_contrato_arquivo_pc		pls_rpc_contrato.nr_contrato_arquivo%type,
		cd_scpa_pc			pls_plano.cd_scpa%type,
		nr_protocolo_ans_pc		pls_plano.nr_protocolo_ans%type) FOR
	SELECT	sum(pls_obter_valor_regra_copartic(a.nr_seq_regra_atual,'A')) vl_copartic_anterior,
		sum(pls_obter_valor_regra_copartic(a.nr_seq_regra_gerada,'R')) vl_copartic_reajustado,
		substr(c.cd_item_cobertura,1,3) cd_item_cobertura,
		pls_obter_desc_item_cobertura(c.cd_item_cobertura) ds_item_cobertura,
		count(1) qt_item_cobertura
	from	pls_reajuste_copartic	a,
		pls_lote_reaj_copartic	b,
		pls_tipo_coparticipacao c
	where	a.nr_seq_lote		= b.nr_sequencia
	and    	a.nr_seq_regra_copartic = c.nr_sequencia
	and	exists (SELECT	1
			from	pls_rpc_contrato x
			where	x.nr_seq_lote	= nr_seq_lote_p
			and	x.nr_seq_grupo_contrato	= nr_seq_grupo_contrato_pc
			and	x.nr_contrato_arquivo	= nr_contrato_arquivo_pc
			and	x.nr_seq_reajuste	= b.nr_seq_reajuste)
	and	ie_gerar_franquia_pc in ('S','Z')
	and     exists                  ( select 1
					  from 	pls_regra_coparticipacao x,
						pls_plano		 y
					  where x.nr_sequencia = a.nr_seq_regra_atual
					  and	y.nr_sequencia = x.nr_seq_plano
					  and   ((coalesce(x.nr_seq_plano::text, '') = '') or
						((y.nr_protocolo_ans IS NOT NULL AND y.nr_protocolo_ans::text <> '' AND y.nr_protocolo_ans = nr_protocolo_ans_pc) or (y.cd_scpa IS NOT NULL AND y.cd_scpa::text <> '' AND y.cd_scpa = cd_scpa_pc))))
	group by
		c.cd_item_cobertura;

BEGIN
delete	from pls_rpc_arquivo
where	nr_seq_lote	= nr_seq_lote_p;

select	max(dt_inicial),
	max(dt_final),
	coalesce(max(dt_comunicado), clock_timestamp())
into STRICT	dt_inicial_w,
	dt_final_w,
	dt_comunicado_w
from	pls_rpc_lote
where	nr_sequencia = nr_seq_lote_p;

begin
select	a.cd_ans,
	a.cd_cgc_outorgante,
	upper(b.ds_razao_social)
into STRICT	cd_ans_w,
	cd_cgc_outorgante_w,
	ds_razao_social_w
from	pls_outorgante	a,
	pessoa_juridica	b
where	a.cd_cgc_outorgante	= b.cd_cgc
and	a.cd_estabelecimento	= cd_estabelecimento_p;
exception
when others then
	cd_ans_w		:= null;
	cd_cgc_outorgante_w	:= null;
	ds_razao_social_w	:= null;
end;

/*		INSERIR REGISTRO C1 		*/

ds_conteudo_w	:= 'C1' || lpad(cd_ans_w,6,0) || lpad(cd_cgc_outorgante_w,14,0) || rpad(ds_razao_social_w,60,' ') || to_char(dt_comunicado_w,'ddmmyyyy');

insert into pls_rpc_arquivo(nr_sequencia,
	nr_seq_lote,
	ie_tipo_registro,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	ds_conteudo,
	cd_ans,
	cd_cgc_outorgante,
	ds_razao_social,
	dt_comunicado)
values (nextval('pls_rpc_arquivo_seq'),
	nr_seq_lote_p,
	'C1',
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	ds_conteudo_w,
	lpad(cd_ans_w,6,0),
	lpad(cd_cgc_outorgante_w,14,0),
	rpad(ds_razao_social_w,60,' '),
	dt_comunicado_w)
	returning nr_sequencia into nr_seq_c1_w;

open C01;
loop
fetch C01 into
	ie_negociacao_w,
	nr_seq_contrato_w,
	dt_reajuste_w,
	dt_reajuste_contrato_w,
	tx_reajuste_w,
	tx_reajuste_copartic_w,
	nr_protocolo_ans_w,
	nr_seq_reajuste_w,
	nr_contrato_arquivo_w,
	ie_participacao_w,
	ie_percentual_w,
	uf_contrato_w,
	ie_franquia_copartic_w,
	ie_caracteristica_w,
	ds_justificativa_w,
	ie_gerar_franquia_w,
	cd_scpa_w,
	cd_scpa_contrato_w,
	nr_contrato_w,
	dt_contrato_w,
	ie_regulamentacao_w,
	dt_aplicacao_reajuste_w,
	ie_tipo_agrupamento_excl_w,
	dt_inicio_analise_reaj_w,
	dt_fim_analise_reaj_w,
	tx_reajuste_correto_w,
	tx_reajuste_origem_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	qt_vidas_w 			:= null;
	ds_conteudo_w			:= null;
	ie_data_analise_grupo_w		:= 'N';

	begin
	select	max(coalesce(a.ie_considerar_dt_retro,'N')),
		max(coalesce(a.ie_produto_sem_benef_ativo,'N')),
		max(a.ds_observacao_reaj_copart),
		max(a.dt_inicio_reajuste),
		max(a.dt_fim_reajuste)
	into STRICT	ie_considerar_dt_retro_w,
		ie_produto_sem_benef_ativo_w,
		ds_observacao_reaj_copart_w,
		dt_inicio_reajuste_regra_w,
		dt_fim_reajuste_regra_w
	from	pls_regra_rpc a
	where	a.cd_estabelecimento	= cd_estabelecimento_p
	and	dt_reajuste_w between coalesce(a.dt_inicio_vigencia,dt_reajuste_w) and coalesce(a.dt_fim_vigencia,dt_reajuste_w)
	and	tx_reajuste_w	between coalesce(a.pr_reajuste_inicial,tx_reajuste_w) and coalesce(a.pr_reajuste_final,tx_reajuste_w)
	and	((a.ie_regulamentacao = ie_regulamentacao_w) or (coalesce(a.ie_regulamentacao::text, '') = ''));
	exception
	when others then
		ie_considerar_dt_retro_w     := 'N';
		ie_produto_sem_benef_ativo_w := 'N';
	end;

	if (coalesce(tx_reajuste_w,0) >= 0) then
		ie_percentual_w := 'P';
	else
		if (tx_reajuste_correto_w = 0 and tx_reajuste_origem_w > 0) then
			tx_reajuste_w	:= tx_reajuste_origem_w;
		else
			tx_reajuste_w	:= abs(tx_reajuste_w);
		end if;
	end if;

	if (coalesce(cd_scpa_w::text, '') = '') and (coalesce(nr_protocolo_ans_w::text, '') = '') and (cd_scpa_contrato_w IS NOT NULL AND cd_scpa_contrato_w::text <> '') then
		cd_scpa_w	:= cd_scpa_contrato_w;
	end if;

	if (coalesce(dt_reajuste_contrato_w::text, '') = '') and (nr_seq_reajuste_w IS NOT NULL AND nr_seq_reajuste_w::text <> '') then
		select	max(dt_reajuste_contrato)
		into STRICT	dt_reajuste_contrato_w
		from	pls_prog_reaj_coletivo
		where	nr_seq_reajuste = nr_seq_reajuste_w;
	end if;

	if (coalesce(dt_reajuste_contrato_w::text, '') = '') then
		dt_reajuste_contrato_w	:= dt_reajuste_w;
	end if;

	dt_inicio_analise_w		:= add_months(dt_reajuste_contrato_w,-12);
	dt_fim_analise_w		:= fim_dia(last_day(add_months(dt_reajuste_contrato_w,-1)));

	qt_regra_cobr_retro_w := 0;

	if (nr_seq_reajuste_w IS NOT NULL AND nr_seq_reajuste_w::text <> '') and (ie_considerar_dt_retro_w = 'S') then
		select	count(1)
		into STRICT	qt_regra_cobr_retro_w
		from	pls_reajuste_cobr_retro
		where	nr_seq_reajuste = nr_seq_reajuste_w;
	end if;

	dt_fim_reajuste_w		:= last_day(coalesce(dt_fim_reajuste_regra_w,add_months(dt_reajuste_contrato_w,11))); --Fim do reajuste e o ultimo dia do mes anterior ao proximo aniversario
	
	if (dt_inicio_reajuste_regra_w IS NOT NULL AND dt_inicio_reajuste_regra_w::text <> '') then
		dt_inicio_reajuste_w	:= dt_inicio_reajuste_regra_w;
	else
		if (ie_negociacao_w = 'S') then
			dt_inicio_reajuste_w		:= trunc(dt_reajuste_contrato_w,'month'); --Inicio do reajuste e quando ele foi aplicado
		elsif (ie_considerar_dt_retro_w = 'N') or (qt_regra_cobr_retro_w > 0) then
			dt_inicio_reajuste_w		:= trunc(dt_reajuste_w,'month'); --Inicio do reajuste e quando ele foi aplicado
		else
			dt_inicio_reajuste_w		:= trunc(coalesce(dt_aplicacao_reajuste_w,dt_reajuste_w),'month'); --Se o parametro estiver como 'S' e nao existir regra de cobranca retroativa  busca a data de aplicacao do reajuste
		end if;
	end if;

	if (nr_seq_reajuste_w IS NOT NULL AND nr_seq_reajuste_w::text <> '') then
		select	coalesce(dt_inicio_analise_reaj_w,coalesce(max(b.dt_inicio_analise),dt_inicio_analise_w)),
			coalesce(dt_fim_analise_reaj_w,coalesce(max(b.dt_fim_analise),dt_fim_analise_w)),
			max(qt_vidas)
		into STRICT	dt_inicio_analise_w,
			dt_fim_analise_w,
			qt_vidas_w
		from	pls_prog_reaj_coletivo		a,
			pls_prog_reaj_colet_lote	b
		where	b.nr_sequencia		= a.nr_seq_lote
		and	a.nr_seq_reajuste	= nr_seq_reajuste_w;
	end if;

	if (ie_tipo_agrupamento_excl_w IS NOT NULL AND ie_tipo_agrupamento_excl_w::text <> '') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_grupo_contrato_w
		from	pls_grupo_contrato
		where	ie_tipo_agrupamento_exclusivo = ie_tipo_agrupamento_excl_w
		and	dt_reajuste_w between dt_inicio_vigencia and dt_fim_vigencia;

		if (nr_seq_grupo_contrato_w IS NOT NULL AND nr_seq_grupo_contrato_w::text <> '') then
			select	coalesce(max(dt_inicio_analise),dt_inicio_analise_w),
				coalesce(max(dt_fim_analise),dt_fim_analise_w)
			into STRICT	dt_inicio_analise_w,
				dt_fim_analise_w
			from	pls_grupo_contrato
			where	nr_sequencia = nr_seq_grupo_contrato_w;
			
			ie_data_analise_grupo_w	:= 'S';
		end if;
	end if;

	if	(dt_inicio_analise_w < dt_contrato_w AND ie_data_analise_grupo_w = 'N') then
		dt_inicio_analise_w	:= dt_contrato_w;
	end if;

	dt_referencia_qt_vidas_w	:= fim_dia(last_day(add_months(dt_reajuste_w,-1)));

	select	count(1)
	into STRICT	qt_beneficiario_alt_plano_w
	from 	(SELECT	x.nr_sequencia
		from 	pls_segurado x,
			pls_plano b, 
			pls_segurado_alt_plano c
		where 	x.nr_sequencia = c.nr_seq_segurado
		and	x.nr_seq_contrato = nr_seq_contrato_w
		and 	b.nr_sequencia = c.nr_seq_plano_ant
		and 	(x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '')
		and 	c.dt_alteracao > dt_reajuste_w
		and	((coalesce(x.dt_rescisao::text, '') = '') or (x.dt_rescisao > dt_referencia_qt_vidas_w))
		and	x.dt_contratacao <= dt_referencia_qt_vidas_w
		and	((b.cd_scpa = cd_scpa_w) or (coalesce(cd_scpa_w::text, '') = ''))
		and	((b.nr_protocolo_ans = nr_protocolo_ans_w) or (coalesce(nr_protocolo_ans_w::text, '') = ''))
		and 	b.ie_regulamentacao = ie_regulamentacao_w
		group by 
			x.nr_sequencia) alias14;
	
	select	count(1)
	into STRICT	qt_beneficiarios_w
	from	pls_segurado	x,
		pls_plano	b
	where	b.nr_sequencia		= x.nr_seq_plano
	and	x.nr_seq_contrato	= nr_seq_contrato_w
	and	(x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '')
	and	((coalesce(x.dt_rescisao::text, '') = '') or (x.dt_rescisao > dt_referencia_qt_vidas_w))
	and	x.dt_contratacao <= dt_referencia_qt_vidas_w
	and 	not exists (	SELECT	1
				from    pls_segurado_alt_plano y
				where   b.nr_sequencia = y.nr_seq_plano_atual
				and     x.nr_sequencia = y.nr_seq_segurado
				and     y.dt_alteracao > dt_reajuste_w)
	and	((b.cd_scpa = cd_scpa_w) or (coalesce(cd_scpa_w::text, '') = ''))
	and	((b.nr_protocolo_ans = nr_protocolo_ans_w) or (coalesce(nr_protocolo_ans_w::text, '') = ''))
	and	b.ie_regulamentacao = ie_regulamentacao_w;

	select	count(1)
	into STRICT	qt_benef_alt_aux_plano_w
	from 	(SELECT	x.nr_sequencia
		from 	pls_segurado x,
			pls_plano b, 
			pls_segurado_alt_plano c,
			pls_contrato y
		where 	x.nr_sequencia = c.nr_seq_segurado
		and	y.nr_sequencia = x.nr_seq_contrato
		and 	b.nr_sequencia = c.nr_seq_plano_ant
		and	y.cd_contrato_principal = nr_contrato_w
		and	coalesce(y.ie_contrato_ex_funcionario,'N') = 'S'
		and 	(x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '')
		and 	c.dt_alteracao > dt_reajuste_w
		and	((coalesce(x.dt_rescisao::text, '') = '') or (x.dt_rescisao > dt_referencia_qt_vidas_w))
		and	x.dt_contratacao <= dt_referencia_qt_vidas_w
		and	((b.cd_scpa = cd_scpa_w) or (coalesce(cd_scpa_w::text, '') = ''))
		and	((b.nr_protocolo_ans = nr_protocolo_ans_w) or (coalesce(nr_protocolo_ans_w::text, '') = ''))
		and 	b.ie_regulamentacao = ie_regulamentacao_w
		group by 
			x.nr_sequencia) alias15;
	
	select	count(1)
	into STRICT	qt_beneficiarios_aux_w
	from	pls_contrato y,
		pls_segurado z,
		pls_plano    b
	where	z.nr_seq_contrato	= y.nr_sequencia
	and	z.nr_seq_plano		= b.nr_sequencia
	and	y.cd_contrato_principal = nr_contrato_w
	and	coalesce(y.ie_contrato_ex_funcionario,'N') = 'S'
	and	(z.dt_liberacao IS NOT NULL AND z.dt_liberacao::text <> '')
	and 	not exists (	SELECT	1
				from    pls_segurado_alt_plano p
				where   b.nr_sequencia = p.nr_seq_plano_atual
				and     z.nr_sequencia = p.nr_seq_segurado
				and     p.dt_alteracao > dt_reajuste_w)
	and	((coalesce(z.dt_rescisao::text, '') = '') or (z.dt_rescisao > dt_referencia_qt_vidas_w))
	and	z.dt_contratacao	<= dt_referencia_qt_vidas_w
	and	((b.cd_scpa = cd_scpa_w) or (coalesce(cd_scpa_w::text, '') = ''))
	and	((b.nr_protocolo_ans = nr_protocolo_ans_w) or (coalesce(nr_protocolo_ans_w::text, '') = ''))
	and	b.ie_regulamentacao = ie_regulamentacao_w;

	qt_beneficiarios_w := qt_beneficiarios_w + qt_beneficiarios_aux_w + qt_beneficiario_alt_plano_w + qt_benef_alt_aux_plano_w;
	
	select	max(b.nr_sequencia),
		max(a.dt_inativacao)
	into STRICT	nr_seq_plano_w,
		dt_inativacao_produto_w
	from	pls_contrato_plano	a,
		pls_plano		b
	where	b.nr_sequencia		= a.nr_seq_plano
	and	a.nr_seq_contrato	= nr_seq_contrato_w
	and	((b.cd_scpa = cd_scpa_w) or (coalesce(cd_scpa_w::text, '') = ''))
	and	((b.nr_protocolo_ans = nr_protocolo_ans_w) or (coalesce(nr_protocolo_ans_w::text, '') = ''));
	
	if (coalesce(nr_seq_plano_w::text, '') = '') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_plano_w
		from	pls_plano	b
		where	((b.cd_scpa = cd_scpa_w) or (coalesce(cd_scpa_w::text, '') = ''))
		and	((b.nr_protocolo_ans = nr_protocolo_ans_w) or (coalesce(nr_protocolo_ans_w::text, '') = ''));
	end if;

	if (nr_seq_plano_w IS NOT NULL AND nr_seq_plano_w::text <> '') then
		select	upper(coalesce(a.ds_plano_rpc,a.ds_plano))
		into STRICT	ds_plano_w
		from	pls_plano	a
		where	a.nr_sequencia	= nr_seq_plano_w;
	else
		ds_plano_w	:= null;
	end if;

	if (qt_beneficiarios_w > 0 or (ie_produto_sem_benef_ativo_w = 'S' and (coalesce(dt_inativacao_produto_w::text, '') = '' or dt_inativacao_produto_w > dt_reajuste_w))) then -- Se existir beneficiario ativo no contrato deve gerar no arquivo de RPC independente se o plano do contrato estiver ativo ou inativo.
		if (cd_scpa_w IS NOT NULL AND cd_scpa_w::text <> '') then
			cd_plano_operadora_w	:= rpad(cd_scpa_w, 20, ' ');
		else
			cd_plano_operadora_w	:= rpad(999999999, 20, ' ');
		end if;

		if (ie_percentual_w = 'N') then
			tx_reajuste_copartic_w	:= 0;
		end if;

		if	((ie_gerar_franquia_w = 'N') or (tx_reajuste_copartic_w <= tx_reajuste_w)) then
			ie_franquia_copartic_w	:= 'N';
			tx_reajuste_copartic_w	:= 0;
		else
			select	count(1)
			into STRICT	qt_copartic_reajuste_w
			from	pls_lote_reaj_copartic a,
				pls_reajuste_copartic b
			where	a.nr_sequencia = b.nr_seq_lote
			and	a.nr_seq_reajuste = nr_seq_reajuste_w
			and	coalesce(a.tx_reajuste,0) > 0
			and (coalesce(b.vl_reajustado,0) > 0 and (coalesce(b.vl_base,0) > 0))
			and     exists	(SELECT 1
					from 	pls_regra_coparticipacao x
					where 	x.nr_sequencia = b.nr_seq_regra_atual
					and	((x.nr_seq_plano = nr_seq_plano_w) or (coalesce(x.nr_seq_plano::text, '') = '')));
					
			if (qt_copartic_reajuste_w = 0) then
				ie_franquia_copartic_w	:= 'N';
				tx_reajuste_copartic_w	:= 0;
			end if;
		end if;

		qt_estados_benef_w	:= 0;
		vl_total_conta_ant_w	:= 0;
		sg_estado_contrato_w	:= null;
		for r_c03_w in C03(	dt_inicio_analise_w, dt_fim_analise_w, 'N',
					nr_seq_contrato_w, null, nr_seq_plano_w, 
					null, null, null) loop
			begin
			if (qt_estados_benef_w = 0) then
				sg_estado_contrato_w	:= r_c03_w.sg_estado;
			end if;
			qt_estados_benef_w	:= qt_estados_benef_w + 1;

			select	sum(d.vl_total)
			into STRICT	vl_total_conta_w
			from	compl_pessoa_fisica	a,
				pessoa_fisica		b,
				pls_segurado		c,
				pls_conta		d,
				pls_protocolo_conta	e
			where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
			and	b.cd_pessoa_fisica	= c.cd_pessoa_fisica
			and	c.nr_sequencia		= d.nr_seq_segurado
			and	e.nr_sequencia		= d.nr_seq_protocolo
			and	a.ie_tipo_complemento	= '1'
			and	c.nr_seq_contrato	= nr_seq_contrato_w
			and	d.nr_seq_plano		= nr_seq_plano_w
			and	a.sg_estado		= r_c03_w.sg_estado
			and	e.dt_mes_competencia between dt_inicio_analise_w and dt_fim_analise_w;

			if (coalesce(vl_total_conta_w,0) > coalesce(vl_total_conta_ant_w,0)) then
				sg_estado_contrato_w	:= r_c03_w.sg_estado;
				vl_total_conta_ant_w	:= coalesce(vl_total_conta_w,0);
			end if;
			end;
		end loop; --C03

		--Dispersao dos Beneficiarios. Preencher o campo com "E" caso todos os beneficiarios de um mesmo contrato e plano tiverem domicilio em uma mesma UF, caso contrario preencher com "M"
		if (qt_estados_benef_w > 1) then
			ie_majoritario_w	:= 'M';
		else
			ie_majoritario_w	:= 'E';
		end if;

		/*		INSERIR REGISTRO C2			*/

		ds_conteudo_w	:= /*1*/
 'C2' ||/*2*/ lpad(coalesce(nr_protocolo_ans_w,9),9,9) ||/*3*/ rpad(ds_plano_w,60,' ') ||/*4*/ rpad(nr_contrato_arquivo_w,20,' ') ||
			/*5*/
 ie_participacao_w || /*6*/
 to_char(dt_inicio_reajuste_w,'mmyyyy') ||/*7*/ to_char(dt_fim_reajuste_w,'mmyyyy') ||
			/*8*/
 to_char(dt_inicio_analise_w,'mmyyyy') ||/*9*/ to_char(dt_fim_analise_w,'mmyyyy') ||
			/*10*/
 lpad(qt_beneficiarios_w,10,0) ||/*11*/
 ie_percentual_w ||/*12*/
 lpad(replace(campo_mascara_virgula(tx_reajuste_w),',',null),6,0) ||
			/*13*/
 coalesce(coalesce(sg_estado_contrato_w,uf_contrato_w),'NA') || /*14*/ coalesce(ie_majoritario_w,'E') ||/*15*/ substr(coalesce(ie_caracteristica_w,1),1,1) ||/*16*/ 'S' || /*17*/
 ie_franquia_copartic_w ||
			/*18*/
 ie_percentual_w || /*19*/
 lpad(replace(campo_mascara_virgula(tx_reajuste_copartic_w),',',null),6,0) ||/*20*/
 cd_plano_operadora_w;

		insert into pls_rpc_arquivo(nr_sequencia,
			nr_seq_lote,
			ie_tipo_registro,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_conteudo,
			nr_seq_plano,
			nr_seq_contrato,
			nr_seq_c1,
			nr_protocolo_ans,
			ds_plano,
			nr_contrato,
			ie_participacao,
			dt_inicio_reajuste,
			dt_fim_reajuste,
			dt_inicio_analise,
			dt_fim_analise,
			qt_beneficiarios,
			ie_percentual,
			tx_percentual,
			uf_contrato,
			ie_majoritario,
			ie_caracteristica,
			ie_reajuste_linear,
			ie_franquia_copartic,
			ie_percentual_copartic,
			tx_percentual_copartic,
			cd_plano_operadora)
		values (nextval('pls_rpc_arquivo_seq'),
			nr_seq_lote_p,
			'C2',
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			ds_conteudo_w,
			nr_seq_plano_w,
			nr_seq_contrato_w,
			nr_seq_c1_w,
			lpad(coalesce(nr_protocolo_ans_w,9),9,9),
			ds_plano_w,
			nr_contrato_arquivo_w,
			ie_participacao_w,
			dt_inicio_reajuste_w,
			dt_fim_reajuste_w,
			dt_inicio_analise_w,
			dt_fim_analise_w,
			qt_beneficiarios_w,
			ie_percentual_w,
			lpad(replace(campo_mascara_virgula(tx_reajuste_w),',',null),6,0),
			coalesce(coalesce(sg_estado_contrato_w,uf_contrato_w),'NA'),
			ie_majoritario_w,
			substr(coalesce(ie_caracteristica_w,1),1,1),
			'S',
			ie_franquia_copartic_w,
			ie_percentual_w,
			lpad(replace(campo_mascara_virgula(tx_reajuste_copartic_w),',',null),6,0),
			cd_plano_operadora_w)
			returning nr_sequencia into nr_seq_c2_w;

		/*		INSERIR REGISTRO C3			*/

		ds_justificativa_w	:= substr(replace_macro(ds_justificativa_w,'@QT_VIDAS',coalesce(qt_vidas_w,qt_beneficiarios_w)),1,100);
		ds_conteudo_w	:= /*1*/
 'C3' ||/*2*/ '001' ||/*3*/ rpad(ds_justificativa_w,100,' ');

		insert into pls_rpc_arquivo(nr_sequencia,
			nr_seq_lote,
			ie_tipo_registro,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_conteudo,
			nr_seq_plano,
			nr_seq_contrato,
			nr_seq_c2,
			ds_justificativa)
		values (nextval('pls_rpc_arquivo_seq'),
			nr_seq_lote_p,
			'C3',
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			ds_conteudo_w,
			nr_seq_plano_w,
			nr_seq_contrato_w,
			nr_seq_c2_w,
			ds_justificativa_w)
			returning nr_sequencia into nr_seq_c3_w;

		/*		INSERIR REGISTRO C4			*/

		if	((ie_gerar_franquia_w = 'S') or (ie_gerar_franquia_w = 'J') or (ie_gerar_franquia_w = 'Z')) then
			ie_gerou_franquia_w	:= 'N';
			
			for c02_w in C02(nr_seq_plano_w) loop
				begin	
				if (c02_w.vl_copartic_anterior > 0) and (c02_w.vl_copartic_reajustado > 0) and (c02_w.vl_copartic_anterior <> c02_w.vl_copartic_reajustado) then
					vl_copartic_anterior_w := c02_w.vl_copartic_anterior / c02_w.qt_item_cobertura;
					vl_copartic_reajustado_w := c02_w.vl_copartic_reajustado / c02_w.qt_item_cobertura;

					ds_conteudo_w	:= /*1*/
 'C4' ||/*2*/
 c02_w.cd_item_cobertura ||
								/*3*/
 lpad(replace(campo_mascara_virgula(coalesce(vl_copartic_anterior_w,0)),',',null),15,0) ||
								/*4*/
 lpad(replace(campo_mascara_virgula(coalesce(vl_copartic_reajustado_w,0)),',',null),15,0) ||
								/*5*/
 '000000' ||/*6*/ '000000' ||/*7*/ rpad(coalesce(ds_observacao_reaj_copart_w,ds_justificativa_w),150,' ');

					insert into pls_rpc_arquivo(nr_sequencia,
						nr_seq_lote,
						ie_tipo_registro,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						ds_conteudo,
						nr_seq_plano,
						nr_seq_contrato,
						nr_seq_c3,
						cd_item_cobertura,
						vl_antes_alteracao_c4,
						vl_apos_alteracao_c4,
						tx_antes_alteracao_c4,
						tx_apos_alteracao_c4,
						ds_observacao_c4)
					values (nextval('pls_rpc_arquivo_seq'),
						nr_seq_lote_p,
						'C4',
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						ds_conteudo_w,
						nr_seq_plano_w,
						nr_seq_contrato_w,
						nr_seq_c3_w,
						c02_w.cd_item_cobertura,
						lpad(replace(campo_mascara_virgula(coalesce(vl_copartic_anterior_w,0)),',',null),15,0),
						lpad(replace(campo_mascara_virgula(coalesce(vl_copartic_reajustado_w,0)),',',null),15,0),
						'000000',
						'000000',
						coalesce(ds_observacao_reaj_copart_w,ds_justificativa_w));
					ie_gerou_franquia_w	:= 'S';
				end if;
				end;
			end loop; --C02
			if	((ie_gerar_franquia_w = 'J') or (ie_gerar_franquia_w = 'Z' and ie_gerou_franquia_w = 'N')) then
				ds_conteudo_w	:= 'C400000000000000000000000';

				insert into pls_rpc_arquivo(nr_sequencia,
					nr_seq_lote,
					ie_tipo_registro,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					ds_conteudo,
					nr_seq_plano,
					nr_seq_contrato,
					nr_seq_c3,
					cd_item_cobertura,
					vl_antes_alteracao_c4,
					vl_apos_alteracao_c4,
					tx_antes_alteracao_c4,
					tx_apos_alteracao_c4)
				values (nextval('pls_rpc_arquivo_seq'),
					nr_seq_lote_p,
					'C4',
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					ds_conteudo_w,
					nr_seq_plano_w,
					nr_seq_contrato_w,
					nr_seq_c3_w,
					'000',
					'0',
					'0',
					'0',
					'0');
			end if;
		end if;
	end if;
	end;
end loop;
close C01;

--Cursor para gerar os grupos de contrato de reajuste
for r_c05_w in C05 loop
	begin
	dt_inicio_analise_w	:= null;
	dt_fim_analise_w	:= null;
	
	select	max(x.tx_reajuste)
	into STRICT	tx_reajuste_origem_w
	from	pls_reajuste x
	where	x.nr_seq_lote_deflator = r_c05_w.nr_seq_reajuste;

	begin
	select	max(coalesce(a.ie_considerar_dt_retro,'N')),
		max(coalesce(a.ie_produto_sem_benef_ativo,'N')),
		max(a.ds_observacao_reaj_copart),
		max(a.dt_inicio_reajuste),
		max(a.dt_fim_reajuste)
	into STRICT	ie_considerar_dt_retro_w,
		ie_produto_sem_benef_ativo_w,
		ds_observacao_reaj_copart_w,
		dt_inicio_reajuste_regra_w,
		dt_fim_reajuste_regra_w
	from	pls_regra_rpc a
	where	a.cd_estabelecimento	= cd_estabelecimento_p
	and	r_c05_w.dt_reajuste between coalesce(a.dt_inicio_vigencia,r_c05_w.dt_reajuste) and coalesce(a.dt_fim_vigencia,r_c05_w.dt_reajuste)
	and	r_c05_w.tx_reajuste between coalesce(a.pr_reajuste_inicial,r_c05_w.tx_reajuste) and coalesce(a.pr_reajuste_final,r_c05_w.tx_reajuste)
	and	((a.ie_regulamentacao = r_c05_w.ie_regulamentacao) or (coalesce(a.ie_regulamentacao::text, '') = ''));
	exception
	when others then
		ie_considerar_dt_retro_w     := 'N';
		ie_produto_sem_benef_ativo_w := 'N';
	end;

	select	max(dt_reajuste)
	into STRICT	dt_reajuste_grupo_contrato_w
	from	pls_grupo_contrato
	where	nr_sequencia = r_c05_w.nr_seq_grupo_contrato;
	
	if (dt_reajuste_grupo_contrato_w IS NOT NULL AND dt_reajuste_grupo_contrato_w::text <> '') then
		dt_reajuste_grupo_contrato_w	:= pls_obter_ultimo_aniversario(trunc(dt_reajuste_grupo_contrato_w, 'mm'), trunc(r_c05_w.dt_reajuste, 'mm'), 'S');
	end if;

	tx_reajuste_w		:= r_c05_w.tx_reajuste;
	ie_franquia_copartic_w	:= r_c05_w.ie_franquia_copartic;
	tx_reajuste_copartic_w	:= r_c05_w.tx_reajuste_copartic;

	if (coalesce(tx_reajuste_w,0) >= 0) then
		ie_percentual_w := 'P';
	else
		ie_percentual_w	:= r_C05_w.ie_percentual;
		
		if (r_c05_w.tx_reajuste_correto = 0 and tx_reajuste_origem_w > 0) then
			tx_reajuste_w	:= tx_reajuste_origem_w;
		else
			tx_reajuste_w	:= abs(tx_reajuste_w);
		end if;
	end if;
	
	if (r_c05_w.ie_tipo_agrupamento_exclusivo IS NOT NULL AND r_c05_w.ie_tipo_agrupamento_exclusivo::text <> '') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_grupo_contrato_w
		from	pls_grupo_contrato
		where	ie_tipo_agrupamento_exclusivo = r_c05_w.ie_tipo_agrupamento_exclusivo
		and	r_c05_w.dt_reajuste between dt_inicio_vigencia and dt_fim_vigencia;
		
		if (nr_seq_grupo_contrato_w IS NOT NULL AND nr_seq_grupo_contrato_w::text <> '') then
			select	max(dt_inicio_analise),
				max(dt_fim_analise)
			into STRICT	dt_inicio_analise_w,
				dt_fim_analise_w
			from	pls_grupo_contrato
			where	nr_sequencia = nr_seq_grupo_contrato_w;
		end if;
	end if;
	
	if	((coalesce(dt_inicio_analise_w::text, '') = '') and (coalesce(dt_fim_analise_w::text, '') = '')) then
		dt_inicio_analise_w	:= add_months(coalesce(dt_reajuste_grupo_contrato_w, r_c05_w.dt_reajuste),-12);
		dt_fim_analise_w	:= fim_dia(last_day(add_months(coalesce(dt_reajuste_grupo_contrato_w, r_c05_w.dt_reajuste),-1)));
		
		--Buscar a data de analise do reajuste do lote de programacao, caso existir
		select	coalesce(max(c.dt_inicio_analise), coalesce(max(b.dt_inicio_analise), dt_inicio_analise_w)),
			coalesce(max(c.dt_fim_analise), coalesce(max(b.dt_fim_analise), dt_fim_analise_w))
		into STRICT	dt_inicio_analise_w,
			dt_fim_analise_w
		from	pls_prog_reaj_coletivo		a,
			pls_prog_reaj_colet_lote	b,
			pls_reajuste			c,
			pls_rpc_contrato		d
		where	b.nr_sequencia		= a.nr_seq_lote
		and	c.nr_sequencia		= a.nr_seq_reajuste
		and	c.nr_sequencia		= d.nr_seq_reajuste
		and	d.nr_seq_lote		= nr_seq_lote_p
		and	d.nr_contrato_arquivo	= r_c05_w.nr_contrato_arquivo;
	end if;

	if (r_c05_w.cd_scpa IS NOT NULL AND r_c05_w.cd_scpa::text <> '') then
		cd_plano_operadora_w	:= rpad(r_c05_w.cd_scpa, 20, ' ');
	else
		cd_plano_operadora_w	:= rpad(999999999, 20, ' ');
	end if;

	qt_estados_benef_w	:= 0;
	vl_total_conta_ant_w	:= 0;
	sg_estado_contrato_w	:= null;
	for r_c03_w in C03(	dt_inicio_analise_w, dt_fim_analise_w, 'S',
				null, r_c05_w.nr_seq_grupo_contrato, null, 
				r_c05_w.cd_scpa, r_c05_w.nr_protocolo_ans, r_c05_w.ie_regulamentacao) loop
		begin
		if (qt_estados_benef_w = 0) then
			sg_estado_contrato_w	:= r_c03_w.sg_estado;
		end if;
		qt_estados_benef_w	:= qt_estados_benef_w + 1;

		if (r_c05_w.ie_regulamentacao = 'P') then
			select	sum(d.vl_total)
			into STRICT	vl_total_conta_w
			from	compl_pessoa_fisica	a,
				pessoa_fisica		b,
				pls_segurado		c,
				pls_conta		d,
				pls_protocolo_conta	e,
				pls_plano		f
			where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
			and	b.cd_pessoa_fisica	= c.cd_pessoa_fisica
			and	c.nr_sequencia		= d.nr_seq_segurado
			and	e.nr_sequencia		= d.nr_seq_protocolo
			and	a.ie_tipo_complemento	= '1'
			and	f.nr_sequencia		= d.nr_seq_plano
			and	f.nr_protocolo_ans 	= r_c05_w.nr_protocolo_ans
			and	a.sg_estado		= r_c03_w.sg_estado
			and	exists (SELECT	1
					from	pls_rpc_contrato x
					where	x.nr_seq_contrato	= c.nr_seq_contrato
					and	x.nr_seq_grupo_contrato	= r_c05_w.nr_seq_grupo_contrato
					and	x.nr_seq_lote		= nr_seq_lote_p)
			and	e.dt_mes_competencia between dt_inicio_analise_w and dt_fim_analise_w;
		elsif	(r_c05_w.ie_regulamentacao = 'A' AND r_c05_w.ie_regulamentacao = 'R') then
			select	sum(d.vl_total)
			into STRICT	vl_total_conta_w
			from	compl_pessoa_fisica	a,
				pessoa_fisica		b,
				pls_segurado		c,
				pls_conta		d,
				pls_protocolo_conta	e,
				pls_plano		f
			where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
			and	b.cd_pessoa_fisica	= c.cd_pessoa_fisica
			and	c.nr_sequencia		= d.nr_seq_segurado
			and	e.nr_sequencia		= d.nr_seq_protocolo
			and	a.ie_tipo_complemento	= '1'
			and	f.nr_sequencia		= d.nr_seq_plano
			and	f.cd_scpa	 	= r_c05_w.cd_scpa
			and	a.sg_estado		= r_c03_w.sg_estado
			and	exists (SELECT	1
					from	pls_rpc_contrato x
					where	x.nr_seq_contrato	= c.nr_seq_contrato
					and	x.nr_seq_grupo_contrato	= r_c05_w.nr_seq_grupo_contrato
					and	x.nr_seq_lote		= nr_seq_lote_p)
			and	e.dt_mes_competencia between dt_inicio_analise_w and dt_fim_analise_w;
		end if;

		if (coalesce(vl_total_conta_w,0) > coalesce(vl_total_conta_ant_w,0)) then
			sg_estado_contrato_w	:= r_c03_w.sg_estado;
			vl_total_conta_ant_w	:= coalesce(vl_total_conta_w,0);
		end if;
		end;
	end loop; --C03

	--Dispersao dos Beneficiarios. Preencher o campo com "E" caso todos os beneficiarios de um mesmo contrato e plano tiverem domicilio em uma mesma UF, caso contrario preencher com "M"
	if (qt_estados_benef_w > 1) then
		ie_majoritario_w	:= 'M';
	else
		ie_majoritario_w	:= 'E';
	end if;

	dt_referencia_qt_vidas_w	:= fim_dia(last_day(add_months(r_c05_w.dt_reajuste,-1)));

	if (r_c05_w.ie_regulamentacao = 'P') then
		select	count(1)
		into STRICT	qt_beneficiario_alt_plano_w
		from 	(SELECT	x.nr_sequencia
			from 	pls_segurado x,
				pls_plano b, 
				pls_segurado_alt_plano c
			where 	x.nr_sequencia = c.nr_seq_segurado
			and 	b.nr_sequencia = c.nr_seq_plano_ant
			and 	(x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '')
			and 	c.dt_alteracao > r_c05_w.dt_reajuste
			and	((coalesce(x.dt_rescisao::text, '') = '') or (x.dt_rescisao > dt_referencia_qt_vidas_w))
			and	x.dt_contratacao <= dt_referencia_qt_vidas_w
			and	b.nr_protocolo_ans = r_c05_w.nr_protocolo_ans
			and 	b.ie_regulamentacao = r_c05_w.ie_regulamentacao
			and	exists	(select	1
					from	pls_rpc_contrato y
					where	y.nr_seq_contrato	= x.nr_seq_contrato
					and	y.nr_seq_grupo_contrato	= r_c05_w.nr_seq_grupo_contrato
					and 	y.nr_contrato_arquivo 	= r_c05_w.nr_contrato_arquivo
					and	((r_c05_w.ie_negociacao = 'S' and coalesce(y.nr_seq_reajuste::text, '') = '') or (r_c05_w.ie_negociacao = 'N' and (y.nr_seq_reajuste IS NOT NULL AND y.nr_seq_reajuste::text <> '')))
					and	y.nr_seq_lote		= nr_seq_lote_p)
			group by 
				x.nr_sequencia) alias13;
	
		select	count(1)
		into STRICT	qt_beneficiarios_w
		from	pls_segurado	a,
			pls_contrato	b,
			pls_plano	c
		where	b.nr_sequencia		= a.nr_seq_contrato
		and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and	((coalesce(a.dt_rescisao::text, '') = '') or (a.dt_rescisao > dt_referencia_qt_vidas_w))
		and	a.dt_contratacao 	<= dt_referencia_qt_vidas_w
		and	c.nr_sequencia		= a.nr_seq_plano
		and 	not exists (	SELECT	1
					from    pls_segurado_alt_plano y
					where   c.nr_sequencia = y.nr_seq_plano_atual
					and     a.nr_sequencia = y.nr_seq_segurado
					and     y.dt_alteracao > r_c05_w.dt_reajuste)
		and	c.nr_protocolo_ans 	= r_c05_w.nr_protocolo_ans
		and	c.ie_regulamentacao 	= r_c05_w.ie_regulamentacao
		and	exists	(select	1
				from	pls_rpc_contrato x
				where	x.nr_seq_contrato	= b.nr_sequencia
				and	x.nr_seq_grupo_contrato	= r_c05_w.nr_seq_grupo_contrato
				and 	x.nr_contrato_arquivo 	= r_c05_w.nr_contrato_arquivo
				and	((r_c05_w.ie_negociacao = 'S' and coalesce(x.nr_seq_reajuste::text, '') = '') or (r_c05_w.ie_negociacao = 'N' and (x.nr_seq_reajuste IS NOT NULL AND x.nr_seq_reajuste::text <> '')))
				and	x.nr_seq_lote		= nr_seq_lote_p);

		select	count(1)
		into STRICT	qt_benef_alt_aux_plano_w
		from 	(SELECT	x.nr_sequencia
			from 	pls_segurado x,
				pls_plano b, 
				pls_segurado_alt_plano c,
				pls_contrato d
			where 	x.nr_sequencia = c.nr_seq_segurado
			and	d.nr_sequencia = x.nr_seq_contrato
			and 	b.nr_sequencia = c.nr_seq_plano_ant
			and	coalesce(d.ie_contrato_ex_funcionario,'N') = 'S'
			and 	(x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '')
			and 	c.dt_alteracao > r_c05_w.dt_reajuste
			and	((coalesce(x.dt_rescisao::text, '') = '') or (x.dt_rescisao > dt_referencia_qt_vidas_w))
			and	x.dt_contratacao <= dt_referencia_qt_vidas_w
			and	b.nr_protocolo_ans = r_c05_w.nr_protocolo_ans
			and 	b.ie_regulamentacao = r_c05_w.ie_regulamentacao
			and	exists	(select	1
					from	pls_rpc_contrato y
					where	y.nr_seq_contrato	= d.nr_contrato_principal
					and	y.nr_seq_grupo_contrato	= r_c05_w.nr_seq_grupo_contrato
					and	((r_c05_w.ie_negociacao = 'S' and coalesce(y.nr_seq_reajuste::text, '') = '') or (r_c05_w.ie_negociacao = 'N' and (y.nr_seq_reajuste IS NOT NULL AND y.nr_seq_reajuste::text <> '')))
					and	y.nr_seq_lote		= nr_seq_lote_p)
			group by 
				x.nr_sequencia) alias13;
				
		select	count(1)
		into STRICT	qt_beneficiarios_aux_w
		from	pls_segurado 	a,
			pls_contrato 	b,
			pls_plano	c
		where	b.nr_sequencia		= a.nr_seq_contrato
		and	coalesce(b.ie_contrato_ex_funcionario,'N') = 'S'
		and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and 	not exists (	SELECT	1
					from    pls_segurado_alt_plano y
					where   c.nr_sequencia = y.nr_seq_plano_atual
					and     a.nr_sequencia = y.nr_seq_segurado
					and     y.dt_alteracao > r_c05_w.dt_reajuste)
		and	((coalesce(a.dt_rescisao::text, '') = '') or (a.dt_rescisao > dt_referencia_qt_vidas_w))
		and	a.dt_contratacao	<= dt_referencia_qt_vidas_w
		and	c.nr_sequencia		= a.nr_seq_plano
		and	c.ie_regulamentacao 	= r_c05_w.ie_regulamentacao
		and	c.nr_protocolo_ans	= r_c05_w.nr_protocolo_ans
		and	exists	(select	1
				from	pls_rpc_contrato x
				where	x.nr_seq_contrato	= b.nr_contrato_principal
				and	x.nr_seq_grupo_contrato	= r_c05_w.nr_seq_grupo_contrato
				and	((r_c05_w.ie_negociacao = 'S' and coalesce(x.nr_seq_reajuste::text, '') = '') or (r_c05_w.ie_negociacao = 'N' and (x.nr_seq_reajuste IS NOT NULL AND x.nr_seq_reajuste::text <> '')))
				and	x.nr_seq_lote		= nr_seq_lote_p);
	elsif	((r_c05_w.ie_regulamentacao = 'R') or (r_c05_w.ie_regulamentacao = 'A')) then
		select	count(1)
		into STRICT	qt_beneficiario_alt_plano_w
		from 	(SELECT	x.nr_sequencia
			from 	pls_segurado x,
				pls_plano b, 
				pls_segurado_alt_plano c
			where 	x.nr_sequencia = c.nr_seq_segurado
			and 	b.nr_sequencia = c.nr_seq_plano_ant
			and 	(x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '')
			and 	c.dt_alteracao > r_c05_w.dt_reajuste
			and	((coalesce(x.dt_rescisao::text, '') = '') or (x.dt_rescisao > dt_referencia_qt_vidas_w))
			and	x.dt_contratacao <= dt_referencia_qt_vidas_w
			and	b.cd_scpa = r_c05_w.cd_scpa
			and 	b.ie_regulamentacao = r_c05_w.ie_regulamentacao
			and	exists	(select	1
					from	pls_rpc_contrato y
					where	y.nr_seq_contrato	= x.nr_seq_contrato
					and	y.nr_seq_grupo_contrato	= r_c05_w.nr_seq_grupo_contrato
					and 	y.nr_contrato_arquivo 	= r_c05_w.nr_contrato_arquivo
					and	((r_c05_w.ie_negociacao = 'S' and coalesce(y.nr_seq_reajuste::text, '') = '') or (r_c05_w.ie_negociacao = 'N' and (y.nr_seq_reajuste IS NOT NULL AND y.nr_seq_reajuste::text <> '')))
					and	y.nr_seq_lote		= nr_seq_lote_p)
			group by 
				x.nr_sequencia) alias15;
	
		select	count(1)
		into STRICT	qt_beneficiarios_w
		from	pls_segurado	a,
			pls_contrato	b,
			pls_plano	c
		where	b.nr_sequencia		= a.nr_seq_contrato
		and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and	((coalesce(a.dt_rescisao::text, '') = '') or (a.dt_rescisao > dt_referencia_qt_vidas_w))
		and	a.dt_contratacao 	<= dt_referencia_qt_vidas_w
		and	c.nr_sequencia		= a.nr_seq_plano
		and	c.cd_scpa 		= r_c05_w.cd_scpa
		and	c.ie_regulamentacao 	= r_c05_w.ie_regulamentacao
		and 	not exists (	SELECT	1
					from    pls_segurado_alt_plano y
					where   c.nr_sequencia = y.nr_seq_plano_atual
					and     a.nr_sequencia = y.nr_seq_segurado
					and     y.dt_alteracao > r_c05_w.dt_reajuste)
		and	exists	(select	1
				from	pls_rpc_contrato x
				where	x.nr_seq_contrato	= b.nr_sequencia
				and	x.nr_seq_grupo_contrato	= r_c05_w.nr_seq_grupo_contrato
				and 	x.nr_contrato_arquivo 	= r_c05_w.nr_contrato_arquivo
				and	((r_c05_w.ie_negociacao = 'S' and coalesce(x.nr_seq_reajuste::text, '') = '') or (r_c05_w.ie_negociacao = 'N' and (x.nr_seq_reajuste IS NOT NULL AND x.nr_seq_reajuste::text <> '')))
				and	x.nr_seq_lote		= nr_seq_lote_p);

		select	count(1)
		into STRICT	qt_benef_alt_aux_plano_w
		from 	(SELECT	x.nr_sequencia
			from 	pls_segurado x,
				pls_plano b, 
				pls_segurado_alt_plano c,
				pls_contrato d
			where 	x.nr_sequencia = c.nr_seq_segurado
			and	d.nr_sequencia = x.nr_seq_contrato
			and 	b.nr_sequencia = c.nr_seq_plano_ant
			and	coalesce(d.ie_contrato_ex_funcionario,'N') = 'S'
			and 	(x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '')
			and 	c.dt_alteracao > r_c05_w.dt_reajuste
			and	((coalesce(x.dt_rescisao::text, '') = '') or (x.dt_rescisao > dt_referencia_qt_vidas_w))
			and	x.dt_contratacao <= dt_referencia_qt_vidas_w
			and	b.cd_scpa = r_c05_w.cd_scpa
			and 	b.ie_regulamentacao = r_c05_w.ie_regulamentacao
			and	exists	(select	1
					from	pls_rpc_contrato y
					where	y.nr_seq_contrato	= d.nr_contrato_principal
					and	y.nr_seq_grupo_contrato	= r_c05_w.nr_seq_grupo_contrato
					and	((r_c05_w.ie_negociacao = 'S' and coalesce(y.nr_seq_reajuste::text, '') = '') or (r_c05_w.ie_negociacao = 'N' and (y.nr_seq_reajuste IS NOT NULL AND y.nr_seq_reajuste::text <> '')))
					and	y.nr_seq_lote		= nr_seq_lote_p)
			group by 
				x.nr_sequencia) alias13;
				
		select	count(1)
		into STRICT	qt_beneficiarios_aux_w
		from	pls_segurado 	a,
			pls_contrato 	b,
			pls_plano	c
		where	b.nr_sequencia		= a.nr_seq_contrato
		and	coalesce(b.ie_contrato_ex_funcionario,'N') = 'S'
		and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and	((coalesce(a.dt_rescisao::text, '') = '') or (a.dt_rescisao > dt_referencia_qt_vidas_w))
		and	a.dt_contratacao	<= dt_referencia_qt_vidas_w
		and	c.nr_sequencia		= a.nr_seq_plano
		and	c.cd_scpa		= r_c05_w.cd_scpa
		and	c.ie_regulamentacao 	= r_c05_w.ie_regulamentacao
		and 	not exists (	SELECT	1
					from    pls_segurado_alt_plano y
					where   c.nr_sequencia = y.nr_seq_plano_atual
					and     a.nr_sequencia = y.nr_seq_segurado
					and     y.dt_alteracao > r_c05_w.dt_reajuste)
		and	exists	(select	1
				from	pls_rpc_contrato x
				where	x.nr_seq_contrato	= b.nr_contrato_principal
				and	x.nr_seq_grupo_contrato	= r_c05_w.nr_seq_grupo_contrato
				and	((r_c05_w.ie_negociacao = 'S' and coalesce(x.nr_seq_reajuste::text, '') = '') or (r_c05_w.ie_negociacao = 'N' and (x.nr_seq_reajuste IS NOT NULL AND x.nr_seq_reajuste::text <> '')))
				and	x.nr_seq_lote		= nr_seq_lote_p);
	end if;

	qt_beneficiarios_w := qt_beneficiarios_w + coalesce(qt_beneficiarios_aux_w,0) + qt_beneficiario_alt_plano_w + qt_benef_alt_aux_plano_w;

	qt_regra_cobr_retro_w := 0;
	if (ie_considerar_dt_retro_w = 'S') then
		select	count(1)
		into STRICT	qt_regra_cobr_retro_w
		from	pls_reajuste_cobr_retro	a,
			pls_reajuste b,
			pls_rpc_contrato c
		where	b.nr_sequencia	= a.nr_seq_reajuste
		and	b.nr_sequencia	= c.nr_seq_reajuste
		and	c.nr_seq_lote	= nr_seq_lote_p
		and	c.nr_contrato_arquivo	= r_c05_w.nr_contrato_arquivo;
	end if;
	
	if (dt_inicio_reajuste_regra_w IS NOT NULL AND dt_inicio_reajuste_regra_w::text <> '') then
		dt_inicio_reaj_w	:= dt_inicio_reajuste_regra_w;
	else
		if (ie_considerar_dt_retro_w = 'S') and (qt_regra_cobr_retro_w = 0) then
			dt_inicio_reaj_w	:= trunc(coalesce(r_c05_w.dt_aplicacao_reajuste,r_c05_w.dt_reajuste),'month');
		else
			dt_inicio_reaj_w	:= r_c05_w.dt_reajuste;
		end if;
	end if;
	
	dt_fim_reaj_w	:= last_day(coalesce(dt_fim_reajuste_regra_w,add_months(coalesce(dt_reajuste_grupo_contrato_w, r_c05_w.dt_reajuste),11)));
	
	if	((r_c05_w.ie_gerar_franquia = 'N') or (tx_reajuste_copartic_w <= tx_reajuste_w)) then
		ie_franquia_copartic_w	:= 'N';
		tx_reajuste_copartic_w	:= 0;
	else
		select	count(1)
		into STRICT	qt_copartic_reajuste_w
		from	pls_reajuste_copartic	a,
			pls_lote_reaj_copartic	b
		where	a.nr_seq_lote = b.nr_sequencia
		and	coalesce(b.tx_reajuste,0) > 0
		and (coalesce(a.vl_reajustado,0) > 0 and (coalesce(a.vl_base,0) > 0))
		and	exists (SELECT	1
				from	pls_rpc_contrato x
				where	x.nr_seq_lote	= nr_seq_lote_p
				and	x.nr_seq_grupo_contrato	= r_c05_w.nr_seq_grupo_contrato
				and	x.nr_contrato_arquivo	= r_c05_w.nr_contrato_arquivo
				and	x.nr_seq_reajuste	= b.nr_seq_reajuste)
		and     exists	(select 1
				from 	pls_regra_coparticipacao x,
					pls_plano		 y
				where 	x.nr_sequencia = a.nr_seq_regra_atual
				and	y.nr_sequencia = x.nr_seq_plano
				and   	((coalesce(x.nr_seq_plano::text, '') = '') or
					((y.nr_protocolo_ans IS NOT NULL AND y.nr_protocolo_ans::text <> '' AND y.nr_protocolo_ans = r_c05_w.nr_protocolo_ans) or (y.cd_scpa IS NOT NULL AND y.cd_scpa::text <> '' AND y.cd_scpa = r_c05_w.cd_scpa))));

		if (qt_copartic_reajuste_w = 0) then
			ie_franquia_copartic_w	:= 'N';
			tx_reajuste_copartic_w	:= 0;
		end if;
	end if;

	/*		INSERIR REGISTRO C2			*/

	ds_conteudo_w	:= /*1*/
 'C2' ||/*2*/ lpad(coalesce(r_c05_w.nr_protocolo_ans,9),9,9) ||/*3*/ rpad(r_c05_w.ds_plano,60,' ') ||/*4*/ rpad(r_c05_w.nr_contrato_arquivo,20,' ') ||
			/*5*/
 r_c05_w.ie_participacao || /*6*/
 to_char(dt_inicio_reaj_w,'mmyyyy') ||/*7*/ to_char(dt_fim_reaj_w,'mmyyyy') ||
			/*8*/
 to_char(dt_inicio_analise_w,'mmyyyy') ||/*9*/ to_char(dt_fim_analise_w,'mmyyyy') ||
			/*10*/
 lpad(qt_beneficiarios_w,10,0) ||/*11*/
 ie_percentual_w ||/*12*/
 lpad(replace(campo_mascara_virgula(tx_reajuste_w),',',null),6,0) ||
			/*13*/
 coalesce(coalesce(sg_estado_contrato_w, r_c05_w.uf_contrato),'NA') || /*14*/ coalesce(ie_majoritario_w,'E') ||/*15*/ substr(coalesce(r_c05_w.ie_caracteristica,1),1,1) ||/*16*/ 'S' || /*17*/
 ie_franquia_copartic_w ||
			/*18*/
 ie_percentual_w || /*19*/
 lpad(replace(campo_mascara_virgula(tx_reajuste_copartic_w),',',null),6,0) ||/*20*/
 cd_plano_operadora_w;

	insert into pls_rpc_arquivo(nr_sequencia,
		nr_seq_lote,
		ie_tipo_registro,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ds_conteudo,
		--nr_seq_plano,
		nr_seq_grupo_contrato,
		nr_seq_c1,
		nr_protocolo_ans,
		ds_plano,
		nr_contrato,
		ie_participacao,
		dt_inicio_reajuste,
		dt_fim_reajuste,
		dt_inicio_analise,
		dt_fim_analise,
		qt_beneficiarios,
		ie_percentual,
		tx_percentual,
		uf_contrato,
		ie_majoritario,
		ie_caracteristica,
		ie_reajuste_linear,
		ie_franquia_copartic,
		ie_percentual_copartic,
		tx_percentual_copartic,
		cd_plano_operadora)
	values (nextval('pls_rpc_arquivo_seq'),
		nr_seq_lote_p,
		'C2',
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		ds_conteudo_w,
		--r_c05_w.nr_seq_plano,
		r_c05_w.nr_seq_grupo_contrato,
		nr_seq_c1_w,
		lpad(coalesce(r_c05_w.nr_protocolo_ans,9),9,9),
		r_c05_w.ds_plano,
		r_c05_w.nr_contrato_arquivo,
		r_c05_w.ie_participacao,
		dt_inicio_reaj_w,
		dt_fim_reaj_w,
		dt_inicio_analise_w,
		dt_fim_analise_w,
		qt_beneficiarios_w,
		ie_percentual_w,
		lpad(replace(campo_mascara_virgula(tx_reajuste_w),',',null),6,0),
		coalesce(coalesce(sg_estado_contrato_w, r_c05_w.uf_contrato),'NA'),
		ie_majoritario_w,
		substr(coalesce(r_c05_w.ie_caracteristica,1),1,1),
		'S',
		ie_franquia_copartic_w,
		ie_percentual_w,
		lpad(replace(campo_mascara_virgula(tx_reajuste_copartic_w),',',null),6,0),
		cd_plano_operadora_w)
		returning nr_sequencia into nr_seq_c2_w;

	/*		INSERIR REGISTRO C3			*/

	ds_conteudo_w	:= /*1*/
 'C3' ||/*2*/ '001' ||/*3*/ rpad(r_c05_w.ds_justificativa,100,' ');

	insert into pls_rpc_arquivo(nr_sequencia,
		nr_seq_lote,
		ie_tipo_registro,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ds_conteudo,
		--nr_seq_plano,
		nr_seq_grupo_contrato,
		nr_seq_c2,
		ds_justificativa)
	values (nextval('pls_rpc_arquivo_seq'),
		nr_seq_lote_p,
		'C3',
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		ds_conteudo_w,
		--r_c05_w.nr_seq_plano,
		r_c05_w.nr_seq_grupo_contrato,
		nr_seq_c2_w,
		r_c05_w.ds_justificativa)
		returning nr_sequencia into nr_seq_c3_w;

	/*		INSERIR REGISTRO C4			*/

	if	((r_c05_w.ie_gerar_franquia = 'S') or (r_c05_w.ie_gerar_franquia = 'J') or (r_c05_w.ie_gerar_franquia = 'Z')) then
		ie_gerou_franquia_w	:= 'N';
		for r_c06_w in C06(r_c05_w.ie_gerar_franquia, r_c05_w.nr_seq_grupo_contrato, r_c05_w.nr_contrato_arquivo, r_c05_w.cd_scpa, r_c05_w.nr_protocolo_ans) loop
			begin
			if (r_c06_w.vl_copartic_anterior > 0) and (r_c06_w.vl_copartic_reajustado > 0) and (r_c06_w.vl_copartic_anterior <> r_c06_w.vl_copartic_reajustado) then
				vl_copartic_anterior_w := r_c06_w.vl_copartic_anterior/r_c06_w.qt_item_cobertura;
				vl_copartic_reajustado_w := r_c06_w.vl_copartic_reajustado/r_c06_w.qt_item_cobertura;

				ds_conteudo_w	:= /*1*/
 'C4' ||/*2*/
 r_c06_w.cd_item_cobertura ||
							/*3*/
 lpad(replace(campo_mascara_virgula(coalesce(vl_copartic_anterior_w,0)),',',null),15,0) ||
							/*4*/
 lpad(replace(campo_mascara_virgula(coalesce(vl_copartic_reajustado_w,0)),',',null),15,0) ||
							/*5*/
 '000000' ||/*6*/ '000000' ||/*7*/ rpad(coalesce(ds_observacao_reaj_copart_w,r_c06_w.ds_item_cobertura),150,' ');

				insert into pls_rpc_arquivo(nr_sequencia,
					nr_seq_lote,
					ie_tipo_registro,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					ds_conteudo,
					--nr_seq_plano,
					nr_seq_grupo_contrato,
					nr_seq_c3,
					cd_item_cobertura,
					vl_antes_alteracao_c4,
					vl_apos_alteracao_c4,
					tx_antes_alteracao_c4,
					tx_apos_alteracao_c4,
					ds_observacao_c4)
				values (nextval('pls_rpc_arquivo_seq'),
					nr_seq_lote_p,
					'C4',
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					ds_conteudo_w,
					--r_c05_w.nr_seq_plano,
					r_c05_w.nr_seq_grupo_contrato,
					nr_seq_c3_w,
					r_c06_w.cd_item_cobertura,
					lpad(replace(campo_mascara_virgula(coalesce(vl_copartic_anterior_w,0)),',',null),15,0),
					lpad(replace(campo_mascara_virgula(coalesce(vl_copartic_reajustado_w,0)),',',null),15,0),
					'000000',
					'000000',
					coalesce(ds_observacao_reaj_copart_w,r_c06_w.ds_item_cobertura));
				ie_gerou_franquia_w	:= 'S';
			end if;
			end;
		end loop; --C06
		if	((r_c05_w.ie_gerar_franquia = 'J') or (r_c05_w.ie_gerar_franquia = 'Z' and ie_gerou_franquia_w = 'N')) then
			ds_conteudo_w	:= 'C400000000000000000000000';

			insert into pls_rpc_arquivo(nr_sequencia,
				nr_seq_lote,
				ie_tipo_registro,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_conteudo,
				--nr_seq_plano,
				nr_seq_grupo_contrato,
				nr_seq_c3,
				cd_item_cobertura,
				vl_antes_alteracao_c4,
				vl_apos_alteracao_c4,
				tx_antes_alteracao_c4,
				tx_apos_alteracao_c4)
			values (nextval('pls_rpc_arquivo_seq'),
				nr_seq_lote_p,
				'C4',
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				ds_conteudo_w,
				--r_c05_w.nr_seq_plano,
				r_c05_w.nr_seq_grupo_contrato,
				nr_seq_c3_w,
				'000',
				'0',
				'0',
				'0',
				'0');
		end if;
	end if;
	end;
end loop;

select	count(1)
into STRICT	qt_linhas_w
from	pls_rpc_arquivo
where	nr_seq_lote	= nr_seq_lote_p;

select	count(1)
into STRICT	qt_linhas_c2_w
from	pls_rpc_arquivo
where	nr_seq_lote		= nr_seq_lote_p
and	ie_tipo_registro	= 'C2';

select	count(1)
into STRICT	qt_linhas_c3_w
from	pls_rpc_arquivo
where	nr_seq_lote		= nr_seq_lote_p
and	ie_tipo_registro	= 'C3';

select	count(1)
into STRICT	qt_linhas_c4_w
from	pls_rpc_arquivo
where	nr_seq_lote		= nr_seq_lote_p
and	ie_tipo_registro	= 'C4';

/*		INSERIR REGISTRO C9 		*/

ds_conteudo_w	:= 'C9' || lpad(qt_linhas_w+1,8,0) || lpad(qt_linhas_c2_w,6,0) || lpad(qt_linhas_c3_w,6,0) || lpad(qt_linhas_c4_w,7,0);

insert into pls_rpc_arquivo(nr_sequencia,
	nr_seq_lote,
	ie_tipo_registro,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	ds_conteudo)
values (nextval('pls_rpc_arquivo_seq'),
	nr_seq_lote_p,
	'C9',
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	ds_conteudo_w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_rpc ( nr_seq_lote_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

