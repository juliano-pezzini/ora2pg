-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_desconto_protocolo (nr_seq_protocolo_p bigint, vl_desconto_p bigint, nm_usuario_p text, ds_observacao_p text, ds_erro_p INOUT text) AS $body$
DECLARE

 
 
ds_erro_w		varchar(2000);
pr_desconto_w		real;
vl_protocolo_w		double precision;
vl_conta_w		double precision;
vl_desconto_w		double precision;
nr_interno_conta_w	bigint;
nr_seq_desconto_w	bigint;
nr_atendimento_w	bigint;
nr_protocolo_w		varchar(40);
pr_conta_w		double precision;
vl_contas_pacote_w	double precision;
vl_desconto_ww		double precision;

c01 CURSOR FOR 
	SELECT	x.nr_interno_conta, 
		x.nr_atendimento, 
		obter_valor_conta(x.nr_interno_conta, 0) 
	from	conta_paciente x 
	where	x.nr_seq_protocolo	= nr_seq_protocolo_p 
	and 	exists (SELECT	1 
			from 	conta_paciente_v a 
			where	a.nr_interno_conta = x.nr_interno_conta 
			and 	coalesce(a.nr_seq_proc_pacote::text, '') = '');	
 

BEGIN 
 
select	obter_total_protocolo(nr_seq_protocolo), 
	nr_protocolo 
into STRICT	vl_protocolo_w, 
	nr_protocolo_w 
from	protocolo_convenio 
where	nr_seq_protocolo	= nr_seq_protocolo_p;
 
select	coalesce(sum(obter_valor_conta(x.nr_interno_conta, 0)),0) 
into STRICT	vl_contas_pacote_w -- todos os itens est√£o empacotados 
from	conta_paciente x 
where	x.nr_seq_protocolo	= nr_seq_protocolo_p 
and 	not exists (	SELECT	1 
			from 	conta_paciente_v a 
			where	a.nr_interno_conta = x.nr_interno_conta 
			and 	coalesce(a.nr_seq_proc_pacote::text, '') = '');
			 
vl_protocolo_w	:= vl_protocolo_w - vl_contas_pacote_w;
vl_desconto_ww	:= vl_desconto_p - vl_contas_pacote_w;
			 
 
open	c01;
loop 
fetch	c01 into 
	nr_interno_conta_w, 
	nr_atendimento_w, 
	vl_conta_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	update protocolo_convenio 
	set	ds_observacao = substr(ds_observacao || ' ' || ds_observacao_p,1,800) 
	where	nr_seq_protocolo = nr_seq_protocolo_p;
 
	select	nextval('conta_paciente_desconto_seq') 
	into STRICT	nr_seq_desconto_w 
	;
 
	if (coalesce(vl_protocolo_w,0) = 0) then 
		pr_conta_w:= 0;
	else 
		pr_conta_w		:= round((vl_conta_w * 100) / vl_protocolo_w,8);
	end if;	
	vl_desconto_w	:= dividir((vl_desconto_ww * pr_conta_w), 100);		
	pr_desconto_w	:= dividir(((vl_conta_w - vl_desconto_w) * 100), vl_conta_w);
 
 
	insert	into conta_paciente_desconto(NR_SEQUENCIA         , 
		NR_INTERNO_CONTA        , 
		IE_TIPO_DESCONTO        , 
		DT_ATUALIZACAO         , 
		NM_USUARIO           , 
		VL_CONTA            , 
		PR_DESCONTO          , 
		VL_DESCONTO          , 
		VL_LIQUIDO           , 
		DT_DESCONTO          , 
		DT_CALCULO           , 
		DT_ATUALIZACAO_NREC      , 
		NM_USUARIO_NREC        , 
		DS_OBSERVACAO         , 
		CD_CENTRO_CUSTO        , 
		NR_SEQ_MOTIVO_DESC       , 
		CD_PESSOA_SOLICITANTE     , 
		CD_CGC_SOLICITANTE       , 
		IE_PACOTE, 
		IE_VALOR_INF) 
	values (nr_seq_desconto_w, 
		nr_interno_conta_w, 
		3, 
		clock_timestamp(), 
		nm_usuario_p, 
		vl_conta_w, 
		pr_desconto_w, 
		vl_conta_w - vl_desconto_w, 
		vl_desconto_w, 
		clock_timestamp(), 
		null, 
		clock_timestamp(), 
		nm_usuario_p,	 
		WHEB_MENSAGEM_PCK.get_texto(280166), 
		null, null, null, null, 
		'F', 
		'A'); --Somente pode ser feito para itens fora do pacote. Pois se existir alguma conta com pacote ao desfazer o desconto do protocolo o rateio fica afetado, pois foi aplicado o desconto sobre o os itens rateados. OS 227631 
		   --Dessa forma garante o processo de desfazer o desconto 
		
	CALL gerar_conpaci_desc_item(nr_seq_desconto_w, nm_usuario_p);
	CALL calcular_conpaci_desc_item(nr_seq_desconto_w, nm_usuario_p);		--Acrescentado OS 227631 (Calcular itens)	 
	CALL calcular_conpaci_desconto(nr_seq_desconto_w, 'I', nm_usuario_p);
	CALL recalcular_conta_paciente(nr_interno_conta_w, nm_usuario_p);
	 
	end;
end loop;
close c01;
 
ds_erro_w	:= ds_erro_p;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_desconto_protocolo (nr_seq_protocolo_p bigint, vl_desconto_p bigint, nm_usuario_p text, ds_observacao_p text, ds_erro_p INOUT text) FROM PUBLIC;

