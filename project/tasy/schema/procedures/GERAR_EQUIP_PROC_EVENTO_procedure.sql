-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_equip_proc_evento (nr_seq_evento_p bigint, nr_atendimento_p bigint, nr_cirurgia_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_estabelecimento_w 	bigint;
cd_convenio_w 			atend_categoria_convenio.cd_convenio%type;
cd_categoria_w			varchar(30);
ie_etapa_cirurgia_w		evento_cirurgia.ie_etapa_cirurgia%type;

c01 CURSOR FOR
	SELECT d.cd_equipamento
	from evento_cirurgia_proc a,
		 proc_interno b, 
		 procedimento c, 
		 procedimento_equip d
	where a.nr_seq_evento = nr_seq_evento_p
	and   a.nr_seq_proc_interno = b.nr_sequencia
	and   obter_info_proc_tab_interno(a.nr_seq_proc_interno, null, nr_atendimento_p, null, null, null, null, 'CD') = c.cd_procedimento 
	and   obter_info_proc_tab_interno(a.nr_seq_proc_interno, null, nr_atendimento_p, null, null, null, null, 'O')  = c.ie_origem_proced
	and   c.cd_procedimento = d.cd_procedimento
	and   c.ie_origem_proced = d.ie_origem_proced;

BEGIN

cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
cd_convenio_w 		 := obter_convenio_atendimento(nr_atendimento_p);
cd_categoria_w		 := obter_categoria_convenio_atend(nr_atendimento_p, cd_convenio_w);


	select 	coalesce(max(ie_etapa_cirurgia), 0)
	into STRICT	ie_etapa_cirurgia_w
	from	evento_cirurgia
	where 	nr_sequencia = nr_seq_evento_p;
	
	if (ie_etapa_cirurgia_w = 7) then

		for c01_w in c01 loop
			begin
				insert into equipamento_cirurgia(nr_sequencia,
												nr_cirurgia,
												cd_equipamento,
												qt_equipamento,
												dt_atualizacao,
												nm_usuario,
												dt_atualizacao_nrec,
												nm_usuario_nrec,
												cd_profissional,
												dt_inicio,
												ie_situacao)
										 values (nextval('equipamento_cirurgia_seq'),
												nr_cirurgia_p,
												c01_w.cd_equipamento,
												1,
												clock_timestamp(),
												nm_usuario_p,
												clock_timestamp(),
												nm_usuario_p,
												obter_pessoa_fisica_usuario(nm_usuario_p, 'C'),
												clock_timestamp(),
												'A');
												
				commit;
			end;
		end loop;
	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_equip_proc_evento (nr_seq_evento_p bigint, nr_atendimento_p bigint, nr_cirurgia_p bigint, nm_usuario_p text) FROM PUBLIC;

