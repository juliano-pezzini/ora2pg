-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_dados_saude_mulher (CD_PESSOA_FISICA_P bigint, QT_GESTACOES_P INOUT bigint, QT_NASC_MORTOS_P INOUT text, IE_IDADE_FERTIL_P INOUT text, IE_PAC_GRAVIDA_P INOUT text, DT_ULT_MENSTRUACAO_P INOUT text, QT_IG_SEM_US_P INOUT bigint, QT_IG_DIA_US_P INOUT bigint) AS $body$
BEGIN
SELECT  max(a.qt_gestacoes),
	max(a.qt_nasc_mortos),
	max(CASE WHEN a.ie_idade_fertil='S' THEN obter_desc_expressao(327113) WHEN a.ie_idade_fertil='M' THEN obter_desc_expressao(293189)  ELSE obter_desc_expressao(327114) END ),
	max(CASE WHEN a.ie_pac_gravida='S' THEN obter_desc_expressao(327113)  ELSE obter_desc_expressao(327114) END ),
	max(PKG_DATE_FORMATERS.to_varchar(dt_ult_menstruacao, 'short', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario )) dt_ult_menstruacao_p,
	max(a.qt_ig_sem_us),
	max(a.qt_ig_dia_us)
INTO STRICT	qt_gestacoes_p,
	qt_nasc_mortos_p,
	ie_idade_fertil_p,
	ie_pac_gravida_p,
	dt_ult_menstruacao_p,
	qt_ig_sem_us_p,
	qt_ig_dia_us_p
FROM   	historico_saude_mulher a
where  	a.cd_pessoa_fisica = cd_pessoa_fisica_p
AND    	a.nr_sequencia 	  = (SELECT MAX(b.nr_sequencia)
								FROM 	historico_saude_mulher b
								WHERE	b.cd_pessoa_fisica = a.cd_pessoa_fisica
								AND	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
								AND	coalesce(b.dt_inativacao::text, '') = ''
								AND    	coalesce(b.dt_fim_gestacao,clock_timestamp()) >= clock_timestamp());

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_dados_saude_mulher (CD_PESSOA_FISICA_P bigint, QT_GESTACOES_P INOUT bigint, QT_NASC_MORTOS_P INOUT text, IE_IDADE_FERTIL_P INOUT text, IE_PAC_GRAVIDA_P INOUT text, DT_ULT_MENSTRUACAO_P INOUT text, QT_IG_SEM_US_P INOUT bigint, QT_IG_DIA_US_P INOUT bigint) FROM PUBLIC;

