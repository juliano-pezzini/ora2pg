-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_fluxo_relat ( cd_estabelecimento_p bigint, cd_empresa_p bigint, ie_restringe_estab_p text, dt_mes_ref_p timestamp, qt_nivel_p bigint, ie_classificacao_p text, vl_saldo_anterior_p bigint, ie_todas_contas_p text, nm_usuario_p text, cd_conta_financ_p text, cd_conta_sintetica_p text, ie_gerar_fluxo_p text, ie_gerar_classif_p text, ie_tipo_integracao_p text) AS $body$
DECLARE

 
cd_conta_financ_w	bigint;
ds_conta_financ_w	varchar(255);
ds_conta_estrut_w	varchar(255);
vl_fluxo_w		double precision;
nr_seq_apres_w		bigint;
cd_conta_apres_w	varchar(20);
nr_seq_fluxo_caixa_w	bigint;
ie_oper_fluxo_w		varchar(1);
ds_lista_conta_financ_w	varchar(4000);
ds_lista_conta_sint_w	varchar(4000);
ie_integracao_w		varchar(4);
dt_referencia_w		timestamp;
ie_periodo_w		varchar(1);

c01 CURSOR FOR 
SELECT	b.cd_conta_financ, 
	b.ds_conta_financ, 
	b.ds_conta_estrut, 
	b.cd_conta_apres cd_conta_apres, 
	b.ie_oper_fluxo, 
	sum(a.vl_fluxo), 
	a.ie_integracao, 
	a.dt_referencia, 
	a.ie_periodo 
from	conta_financeira_v b, 
	fluxo_caixa a 
where	a.cd_conta_financ		= b.cd_conta_financ 
and	trunc(a.dt_referencia,'month')	= trunc(dt_mes_ref_p,'month') 
and	a.ie_periodo			= 'D' 
and	OBTER_EMPRESA_ESTAB(a.cd_estabelecimento)	   = cd_empresa_p 
and (a.cd_estabelecimento = cd_estabelecimento_p or 'N' = ie_restringe_estab_p) 
and	ie_origem			<> 'X' 
and	a.ie_classif_fluxo		= ie_classificacao_p 
and	ie_origem			<> 'S' 
and	((coalesce(cd_conta_financ_p::text, '') = '') or (ds_lista_conta_financ_w like '% ' || b.cd_conta_financ || ' %')) 
and	((coalesce(cd_conta_sintetica_p::text, '') = '') or (ds_lista_conta_sint_w like '% ' || b.cd_conta_superior || ' %')) 
group by 
	b.cd_conta_financ, 
	b.ds_conta_financ, 
	b.ds_conta_estrut, 
	b.cd_conta_apres, 
	b.ie_oper_fluxo, 
	a.ie_origem, 
	a.ie_integracao, 
	a.dt_referencia, 
	a.ie_periodo 

union all
 
SELECT	b.cd_conta_financ, 
	b.ds_conta_financ, 
	b.ds_conta_estrut, 
	b.cd_conta_apres cd_conta_apres, 
	b.ie_oper_fluxo, 
	max(a.vl_fluxo), 
	a.ie_integracao, 
	a.dt_referencia, 
	a.ie_periodo 
from	conta_financeira_v b, 
	fluxo_caixa a 
where	a.cd_conta_financ		= b.cd_conta_financ 
and	trunc(a.dt_referencia,'month')	= trunc(dt_mes_ref_p,'month') 
and	a.ie_periodo			= 'D' 
and	OBTER_EMPRESA_ESTAB(a.cd_estabelecimento)	   = cd_empresa_p 
and (a.cd_estabelecimento = cd_estabelecimento_p or 'N' = ie_restringe_estab_p) 
and	ie_origem			<> 'X' 
and	a.ie_classif_fluxo		= ie_classificacao_p 
and	ie_origem			= 'S' 
and	trunc(a.dt_referencia,'dd')	= trunc(last_day(dt_mes_ref_p),'dd') 
and	((coalesce(cd_conta_financ_p::text, '') = '') or (ds_lista_conta_financ_w like '% ' || b.cd_conta_financ || ' %')) 
and	((coalesce(cd_conta_sintetica_p::text, '') = '') or (ds_lista_conta_sint_w like '% ' || b.cd_conta_superior || ' %')) 
group by 
	b.cd_conta_financ, 
	b.ds_conta_financ, 
	b.ds_conta_estrut, 
	b.cd_conta_apres, 
	b.ie_oper_fluxo, 
	a.ie_origem, 
	a.ie_integracao, 
	a.dt_referencia, 
	a.ie_periodo 
order by 
	cd_conta_apres;


BEGIN 
 
 
ds_lista_conta_financ_w	:= ' ' || replace(replace(replace(cd_conta_financ_p,'(',''),')',''),',',' ') || ' ';
ds_lista_conta_sint_w	:= ' ' || replace(replace(replace(cd_conta_sintetica_p,'(',''),')',''),',',' ') || ' ';
 
delete	from	w_fluxo_drilldown 
where	nm_usuario	= nm_usuario_p;
 
delete	from	w_fluxo_caixa 
where	nm_usuario	= nm_usuario_p;
 
if (coalesce(ie_gerar_fluxo_p,'S') = 'S') then 
	CALL gerar_fluxo_caixa_mensal(cd_estabelecimento_p, 
				cd_empresa_p, 
				ie_restringe_estab_p, 
				dt_mes_ref_p,  
				clock_timestamp(),      
				nm_usuario_p,      
				qt_nivel_p,      
				ie_classificacao_p,   
				vl_saldo_anterior_p,   
				'N',   
				ie_todas_contas_p);
end if;
 
commit;
 
nr_seq_apres_w	:= 0;
 
open c01;
loop 
fetch c01 into 
	cd_conta_financ_w, 
	ds_conta_financ_w, 
	ds_conta_estrut_w, 
	cd_conta_apres_w, 
	ie_oper_fluxo_w, 
	vl_fluxo_w, 
	ie_integracao_w, 
	dt_referencia_w, 
	ie_periodo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	select	nextval('w_fluxo_caixa_seq') 
	into STRICT	nr_seq_fluxo_caixa_w 
	;
 
	insert	into	w_fluxo_caixa(nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		cd_conta_financ, 
		ds_conta_financ, 
		ds_conta_estrut, 
		nr_seq_apres, 
		dt_mes_ref, 
		vl_mes_ref, 
		ie_integracao, 
		ie_periodo) 
	values (nr_seq_fluxo_caixa_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_conta_financ_w, 
		ds_conta_financ_w, 
		ds_conta_estrut_w, 
		nr_seq_apres_w, 
		dt_referencia_w, 
		vl_fluxo_w, 
		ie_integracao_w, 
		ie_periodo_w);
 
	nr_seq_apres_w	:= nr_seq_apres_w + 1;
 
	if (ie_oper_fluxo_w in ('S','D')) and (vl_fluxo_w <> 0) then 
 
		gerar_w_fluxo_drilldown(nr_seq_fluxo_caixa_w, 
					cd_estabelecimento_p, 
					cd_empresa_p, 
					ie_restringe_estab_p, 
					ie_classificacao_p, 
					nm_usuario_p, 
					ie_gerar_classif_p, 
					coalesce(ie_tipo_integracao_p,'T'));
 
	end if;
 
	commit;
				 
end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_fluxo_relat ( cd_estabelecimento_p bigint, cd_empresa_p bigint, ie_restringe_estab_p text, dt_mes_ref_p timestamp, qt_nivel_p bigint, ie_classificacao_p text, vl_saldo_anterior_p bigint, ie_todas_contas_p text, nm_usuario_p text, cd_conta_financ_p text, cd_conta_sintetica_p text, ie_gerar_fluxo_p text, ie_gerar_classif_p text, ie_tipo_integracao_p text) FROM PUBLIC;

