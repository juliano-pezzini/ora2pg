-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_desfazer_susp_segurado ( nr_seq_segurado_p bigint, nm_usuario_p text, nr_titulo_p bigint) AS $body$
DECLARE


nr_seq_pagador_w	bigint;
ds_motivo_fim_susp_w	varchar(2000)	:= '';
dt_rescisao_w		timestamp	:= null;
dt_suspensao_pagador_w	timestamp;


BEGIN

if (nr_seq_segurado_p IS NOT NULL AND nr_seq_segurado_p::text <> '') then
	select	nr_seq_pagador,
		dt_rescisao
	into STRICT	nr_seq_pagador_w,
		dt_rescisao_w
	from	pls_segurado a
	where	a.nr_sequencia	= nr_seq_segurado_p;

	if (nr_titulo_p IS NOT NULL AND nr_titulo_p::text <> '') then
		ds_motivo_fim_susp_w	:= ds_motivo_fim_susp_w || ' Reativação do atendimento de forma automática, ao baixar o título ' ||
							nr_titulo_p || '.';
	end if;

	update	pls_segurado_suspensao
	set	dt_fim_suspensao	= clock_timestamp(),
		dt_atualizacao		= clock_timestamp(),
		nm_usuario		= nm_usuario_p,
		ds_motivo_fim_susp	= ds_motivo_fim_susp_w
	where	nr_seq_segurado		= nr_seq_segurado_p
	and	coalesce(dt_fim_suspensao::text, '') = ''
	and	(dt_inicio_suspensao IS NOT NULL AND dt_inicio_suspensao::text <> '');

	if (coalesce(dt_rescisao_w::text, '') = '' or dt_rescisao_w > clock_timestamp()) then
		update	pls_segurado
		set	ie_situacao_atend	= 'A',
			nr_seq_motivo_susp	 = NULL,
			nr_seq_notific_susp	 = NULL
		where	nr_sequencia	= nr_seq_segurado_p;
	else /* Lepinski - OS 419439 - Caso o beneficiário esteja rescindido, deve desfazer a suspenção do mesmo, porém não pode alterar a situação de atendimento para APTO */
		update	pls_segurado
		set	nr_seq_motivo_susp	 = NULL,
			nr_seq_notific_susp	 = NULL
		where	nr_sequencia	= nr_seq_segurado_p;
	end if;

	select	max(dt_suspensao)
	into STRICT	dt_suspensao_pagador_w
	from	pls_contrato_pagador
	where	nr_sequencia	= nr_seq_pagador_w;

	if (dt_suspensao_pagador_w IS NOT NULL AND dt_suspensao_pagador_w::text <> '') then
		update	pls_contrato_pagador
		set	dt_suspensao	 = NULL
		where	nr_sequencia	= nr_seq_pagador_w;

		insert	into	pls_pagador_historico(	nr_sequencia, nr_seq_pagador, dt_atualizacao, nm_usuario, cd_estabelecimento,
				dt_atualizacao_nrec, nm_usuario_nrec, ds_historico,
				dt_historico, ds_titulo, nm_usuario_historico,
				ie_tipo_historico, ie_origem)
			values (	nextval('pls_pagador_historico_seq'), nr_seq_pagador_w, clock_timestamp(), nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento,
				clock_timestamp(), nm_usuario_p, 'Desfeita a suspensão do pagador após o pagamento do título '||nr_titulo_p,
				clock_timestamp(), 'Alteração no cadastro do pagador', nm_usuario_p,
				'S', 'GC');
	end if;
end if;

/* Nao pode dar commit nesta procedure */

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_desfazer_susp_segurado ( nr_seq_segurado_p bigint, nm_usuario_p text, nr_titulo_p bigint) FROM PUBLIC;

