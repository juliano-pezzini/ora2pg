-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_registrar_ciencia (nr_sequencia_p cpoe_material.nr_sequencia%type, dt_ciencia_medico_p cpoe_procedimento.dt_ciencia_medico%type, ie_tipo_item_p wl_worklist.ie_tipo_item_cpoe%type, nm_usuario_p cpoe_material.nm_usuario%type) AS $body$
DECLARE

												
nr_seq_worklist_w			wl_worklist.nr_sequencia%type;												


BEGIN
    if (ie_tipo_item_p = 'N') then -- Dietas
      begin
        update cpoe_dieta
        set    dt_ciencia_medico = dt_ciencia_medico_p
        where  nr_sequencia      = nr_sequencia_p;
      exception when others then
        CALL gravar_log_tasy(10007,
						substr('CPOE_REGISTRAR_CIENCIA - CPOE_DIETA - Exception Erro:'
							|| substr(to_char(sqlerrm),1,2000),1,2000)
							||' nr_sequencia_p'			|| nr_sequencia_p
							||' dt_ciencia_medico_p ' 	|| pkg_date_formaters_tz.to_varchar(dt_ciencia_medico_p, 'shortDate', establishment_timezone_utils.gettimezone)
							||' ie_tipo_item_p '	    || ie_tipo_item_p
							||' nm_usuario_p:'			|| user,
                               user);
      end;

    elsif (ie_tipo_item_p = 'M' or ie_tipo_item_p = 'MA' or ie_tipo_item_p = 'SOL') then -- Materiais, medicamentos e solucoes
      begin
        update cpoe_material
        set    dt_ciencia_medico = dt_ciencia_medico_p,
              nm_usuario_ciencia = nm_usuario_p
        where  nr_sequencia      = nr_sequencia_p;
      exception when others then
        CALL gravar_log_tasy(10007,
						substr('CPOE_REGISTRAR_CIENCIA - CPOE_MATERIAL - Exception Erro:'
							|| substr(to_char(sqlerrm),1,2000),1,2000)
							||' nr_sequencia_p'	   		|| nr_sequencia_p
							||' dt_ciencia_medico_p ' 	|| pkg_date_formaters_tz.to_varchar(dt_ciencia_medico_p, 'shortDate', establishment_timezone_utils.getTimeZone)
							||' ie_tipo_item_p '	   	|| ie_tipo_item_p
							||' nm_usuario_p:'		   	|| user,
                               user);
      end;

    elsif (ie_tipo_item_p = 'P') then -- Procedimento
      begin
        update cpoe_procedimento
        set    dt_ciencia_medico = dt_ciencia_medico_p,
              nm_usuario_ciencia = nm_usuario_p
        where  nr_sequencia      = nr_sequencia_p;
      exception when others then
        CALL gravar_log_tasy(10007,
						substr('CPOE_REGISTRAR_CIENCIA - CPOE_PROCEDIMENTO - Exception Erro:'
							|| substr(to_char(sqlerrm),1,2000),1,2000)
							||' nr_sequencia_p'	   		|| nr_sequencia_p
							||' dt_ciencia_medico_p ' 	|| pkg_date_formaters_tz.to_varchar(dt_ciencia_medico_p, 'shortDate', establishment_timezone_utils.getTimeZone)
							||' ie_tipo_item_p '	   	|| ie_tipo_item_p
							||' nm_usuario_p:'		   	|| user,
                               user);
      end;

    elsif (ie_tipo_item_p = 'G') then -- Gasoterapia
      begin
        update cpoe_gasoterapia
        set    dt_ciencia_medico = dt_ciencia_medico_p
        where  nr_sequencia      = nr_sequencia_p;
      exception when others then
        CALL gravar_log_tasy(10007,
						substr('CPOE_REGISTRAR_CIENCIA - CPOE_GASOTERAPIA - Exception Erro:'
							|| substr(to_char(sqlerrm),1,2000),1,2000)
							||' nr_sequencia_p'		  || nr_sequencia_p
							||' dt_ciencia_medico_p ' || pkg_date_formaters_tz.to_varchar(dt_ciencia_medico_p, 'shortDate', establishment_timezone_utils.getTimeZone)
							||' ie_tipo_item_p '	  || ie_tipo_item_p
							||' nm_usuario_p:'		  || user,
                               user);
      end;

    elsif (ie_tipo_item_p = 'R') then -- Recomendacao
      begin
        update cpoe_recomendacao
        set    dt_ciencia_medico = dt_ciencia_medico_p
        where  nr_sequencia      = nr_sequencia_p;
      exception when others then
        CALL gravar_log_tasy(10007,
						substr('CPOE_REGISTRAR_CIENCIA - CPOE_RECOMENDACAO - Exception Erro:'
							|| substr(to_char(sqlerrm),1,2000),1,2000)
							||' nr_sequencia_p'	   		|| nr_sequencia_p
							||' dt_ciencia_medico_p ' 	|| pkg_date_formaters_tz.to_varchar(dt_ciencia_medico_p, 'shortDate', establishment_timezone_utils.getTimeZone)
							||' ie_tipo_item_p '	   	|| ie_tipo_item_p
							||' nm_usuario_p:'		   	|| user,
                               user);
      end;

    elsif (ie_tipo_item_p = 'DI' or ie_tipo_item_p = 'DP') then -- Dialise Peritoneal
      begin
        update cpoe_dialise
        set    dt_ciencia_medico = dt_ciencia_medico_p
        where  nr_sequencia      = nr_sequencia_p;
      exception when others then
        CALL gravar_log_tasy(10007,
						substr('CPOE_REGISTRAR_CIENCIA - CPOE_DIALISE - Exception Erro:'
							|| substr(to_char(sqlerrm),1,2000),1,2000)
							||' nr_sequencia_p'			|| nr_sequencia_p
							||' dt_ciencia_medico_p ' 	|| pkg_date_formaters_tz.to_varchar(dt_ciencia_medico_p, 'shortDate', establishment_timezone_utils.getTimeZone)
							||' ie_tipo_item_p '	    || ie_tipo_item_p
							||' nm_usuario_p:'			|| user,
                               user);
      end;

    elsif (ie_tipo_item_p = 'H') then -- Hemoterapia
      begin
        update cpoe_hemoterapia
        set    dt_ciencia_medico = dt_ciencia_medico_p
        where  nr_sequencia      = nr_sequencia_p;
      exception when others then
        CALL gravar_log_tasy(10007,
						substr('CPOE_REGISTRAR_CIENCIA - CPOE_HEMOTERAPIA - Exception Erro:'
							|| substr(to_char(sqlerrm),1,2000),1,2000)
							||' nr_sequencia_p'		  || nr_sequencia_p
							||' dt_ciencia_medico_p ' || pkg_date_formaters_tz.to_varchar(dt_ciencia_medico_p, 'shortDate', establishment_timezone_utils.getTimeZone)
							||' ie_tipo_item_p '	  || ie_tipo_item_p
							||' nm_usuario_p:'		  || user,
                               user);
      end;

    elsif (ie_tipo_item_p = 'AP') then -- Anatomia Patologica
      begin
        update cpoe_anatomia_patologica
        set    dt_ciencia_medico = dt_ciencia_medico_p
        where  nr_sequencia      = nr_sequencia_p;
      exception when others then
        CALL gravar_log_tasy(10007,
						substr('CPOE_REGISTRAR_CIENCIA - CPOE_ANOTOMIA_PATOLOGICA - Exception Erro:'
							|| substr(to_char(sqlerrm),1,2000),1,2000)
							||' nr_sequencia_p'		  || nr_sequencia_p
							||' dt_ciencia_medico_p ' || pkg_date_formaters_tz.to_varchar(dt_ciencia_medico_p, 'shortDate', establishment_timezone_utils.getTimeZone)
							||' ie_tipo_item_p '	  || ie_tipo_item_p
							||' nm_usuario_p:'		  || user,
                               user);
      end;
    end if;
	
	begin
		Select max(nr_sequencia)
		  into STRICT	nr_seq_worklist_w
		from	wl_worklist
		where nr_seq_item_cpoe = nr_sequencia_p
		and	ie_tipo_item_cpoe = ie_tipo_item_p
		and nr_seq_item = obter_se_worklist_lib_cat('C');

		CALL wl_alterar_fim_previsto(nr_seq_worklist_w, clock_timestamp() + interval '1 days', clock_timestamp(), nm_usuario_p, obter_desc_expressao(1079600), null);

	end;

	commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_registrar_ciencia (nr_sequencia_p cpoe_material.nr_sequencia%type, dt_ciencia_medico_p cpoe_procedimento.dt_ciencia_medico%type, ie_tipo_item_p wl_worklist.ie_tipo_item_cpoe%type, nm_usuario_p cpoe_material.nm_usuario%type) FROM PUBLIC;

