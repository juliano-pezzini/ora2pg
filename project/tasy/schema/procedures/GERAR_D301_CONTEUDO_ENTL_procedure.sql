-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_d301_conteudo_entl ( nr_seq_dataset_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_segmento_w		         varchar(32767);
ds_segmento_clob_w	text := '';

/*gerar e armazenar o conte√∫do (com separadores) deste dataset no campo ds_conteudo da tabela d301_dataset_conteudo*/

 c01 CURSOR FOR
--dau
SELECT 	'DAU+'||
	ds_dt_admissao||'+'||
	ds_dt_saida_prevista||'+'||
	cd_cid_acompanhamento||CASE WHEN coalesce(nr_seq_301_local_acomp::text, '') = '' THEN null  ELSE ':' END ||obter_descricao_padrao('C301_16_LOCALIZACAO','IE_LOCALIZACAO',nr_seq_301_local_acomp)||'+'||
	cd_cid_sec_afastamento||'+'||
	ds_dt_cid_afastamento||'+'||
	qt_hota_ventilacao||chr(39) ds_segmento_clob_w
from 	d301_segmento_dau
where	nr_seq_dataset	= nr_seq_dataset_p;

c01_w c01%rowtype;

c02 CURSOR FOR
--etl
SELECT 	'ETL+'||
	ds_dt_alta_transf||'+'||
	ds_hr_alta_transf||'+'||
	obter_descricao_padrao('C301_5_MOT_ALTA_TRANSF','IE_MOTIVO',nr_seq_301_mot_alta_transf)||obter_descricao_padrao('C301_5_MOT_ALTA_TRANSF_TR','IE_APTO_TRABALHO',NR_SEQ_301_MOT_ALTA_TRANSF_TR)||'+'||
	obter_descricao_padrao('C301_6_DEPARTAMENTO','CD_DEPARTAMENTO',nr_seq_301_depart)||'+'||
	cd_cid_princ_1||CASE WHEN coalesce(nr_seq_301_local_1::text, '') = '' THEN null  ELSE ':' END ||obter_descricao_padrao('C301_16_LOCALIZACAO','IE_LOCALIZACAO',nr_seq_301_local_1)||'+'||
	cd_cic_princ_2||'+'||
	nr_ik_destino_transf||chr(39) ds_segmento_clob_w
from 	d301_segmento_etl
where	nr_seq_dataset	= nr_seq_dataset_p;

c02_w c02%rowtype;

c03 CURSOR FOR
SELECT 'FAB+'||
	obter_descricao_padrao('C301_6_DEPARTAMENTO','CD_DEPARTAMENTO',nr_seq_301_depart)||'+'||
	cd_cid_depart_1||CASE WHEN coalesce(nr_seq_301_local_depart_1::text, '') = '' THEN null  ELSE ':' END ||obter_descricao_padrao('C301_16_LOCALIZACAO','IE_LOCALIZACAO',nr_seq_301_local_depart_1)||'+'||
	cd_cid_adic_2||cd_cid_adic_1||'+'||
	ds_dt_operacao||'+'||
	cd_procedimento_ops||CASE WHEN coalesce(nr_seq_301_local_proc::text, '') = '' THEN null  ELSE ':' END ||obter_descricao_padrao('C301_16_LOCALIZACAO','IE_LOCALIZACAO',nr_seq_301_local_proc)||chr(39) ds_segmento_clob_w
from d301_segmento_fab
where	nr_seq_dataset	= nr_seq_dataset_p;

c03_w c03%rowtype;

c04 CURSOR FOR
SELECT 	'NDG+'||
	cd_cid_lateral_1||CASE WHEN coalesce(nr_seq_301_local_1::text, '') = '' THEN null  ELSE ':' END ||obter_descricao_padrao('C301_16_LOCALIZACAO','IE_LOCALIZACAO',nr_seq_301_local_1)||'+'||
	cd_cid_lateral_2||chr(39) ds_segmento_clob_w
from 	d301_segmento_ndg
where	nr_seq_dataset	= nr_seq_dataset_p;

c04_w c04%rowtype;


BEGIN
  --cabecalho
select  'UNH+'||
	lpad(nr_ref_segmento,5,'0')||'+'||
	ie_dataset||':'||
	ie_versao_dataset||':'||
	nr_release_dataset||':'||
	nr_versao_organiz||chr(39)
into STRICT 	ds_segmento_w
from  	d301_segmento_unh
where 	nr_seq_dataset  = nr_seq_dataset_p;

select  concat(ds_segmento_clob_w,ds_segmento_w)
into STRICT  ds_segmento_clob_w
;

  /*
  select  'FKT+'||
    nr_seq_301_ident_processo||'+'||
    nr_transacao||'+'||
    nr_ik_origem||'+'||
    nr_ik_destino||chr(39)
  into  ds_segmento_w
  from  d301_segmento_fkt
  where  nr_seq_dataset  = nr_seq_dataset_p;
  */
ds_segmento_w  := OBTER_CONTEUDO_SEG_FKT_301( nr_seq_dataset_p, ds_segmento_w );

select  concat(ds_segmento_clob_w, ds_segmento_w)
into STRICT  ds_segmento_clob_w
;

select  'INV+'||
	cd_usuario_convenio||'+'||
	obter_descricao_padrao('C301_12_STATUS_SEGURADO','IE_STATUS',nr_seq_301_status_segurado)||'+'||
	obter_descricao_padrao('C301_12_DOENCA_CRONICA','IE_DOENCA',nr_seq_301_doenca_cronica)||'+'||
	obter_descricao_padrao('C301_12_GRUPO_PESSOA','IE_GRUPO',nr_seq_301_grupo_pessoa)||'+'||
	ds_mesano_validade_cart||'+'||
	nr_interno_segurado||'+'||
	nr_episodio_convenio||'+'||
	nr_arquivo_convenio||'+'||
	ds_dt_inicio_cobert_conv||'+'||
	nr_contrato_conv||chr(39)
into STRICT  	ds_segmento_w
from  	d301_segmento_inv
where  	nr_seq_dataset  = nr_seq_dataset_p;

select  concat(ds_segmento_clob_w, ds_segmento_w)
into STRICT  	ds_segmento_clob_w
;

select	'NAD+'||
	nm_sobrenome||'+'||
	ds_nome||'+'||
	obter_descricao_padrao('C301_21_SEXO','IE_SEXO',nr_seq_301_sexo)||'+'||
	ds_dt_nascimento||'+'||
	ds_rua_numero||'+'||
	cd_postal||'+'||
	ds_cidade||'+'||
	ds_titulacao||'+'||
	obter_descricao_padrao('C301_7_PAIS','IE_PAIS',nr_seq_301_pais)||'+'||
	ds_sufixo_nome||'+'||
	ds_prefixo_sobrenome||'+'||
	ds_compl_endereco||chr(39)
into STRICT	ds_segmento_w
from	d301_segmento_nad
where	nr_seq_dataset	= nr_seq_dataset_p;

select	concat(ds_segmento_clob_w, ds_segmento_w)
into STRICT	ds_segmento_clob_w
;

select 	'DPV+'||
	CD_VERSAO_CID||'+'||
	CD_VERSAO_OPS||'+'||chr(39)
into STRICT	ds_segmento_w
FROM 	D301_SEGMENTO_DPV
where	nr_seq_dataset	= nr_seq_dataset_p;

select	concat(ds_segmento_clob_w, ds_segmento_w)
into STRICT	ds_segmento_clob_w
;

  --segmentos.
  --dau
open C01;
loop
fetch C01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

	select	concat(ds_segmento_clob_w, c01_w.ds_segmento_clob_w)
	into STRICT	ds_segmento_clob_w
	;

end loop;
close C01;

  --etl
open C02;
loop
fetch C02 into
	c02_w;
EXIT WHEN NOT FOUND; /* apply on C02 */

	select	concat(ds_segmento_clob_w, c02_w.ds_segmento_clob_w)
	into STRICT	ds_segmento_clob_w
	;

end loop;
close C02;

  --ndg
open C04;
loop
fetch C04 into
	c04_w;
EXIT WHEN NOT FOUND; /* apply on C04 */

	select	concat(ds_segmento_clob_w, c04_w.ds_segmento_clob_w)
	into STRICT	ds_segmento_clob_w
	;

end loop;
close C04;

  --ebg
begin
	select 	'EBG+'||
		ds_dt_parto||chr(39)
	into STRICT	ds_segmento_w
	from 	d301_segmento_ebg
	where	nr_seq_dataset	= nr_seq_dataset_p;
exception
when others then
	ds_segmento_w := null;
end;

select	concat(ds_segmento_clob_w, ds_segmento_w)
into STRICT	ds_segmento_clob_w
;

  --fab
open C03;
loop
fetch C03 into
	c03_w;
EXIT WHEN NOT FOUND; /* apply on C03 */

	select	concat(ds_segmento_clob_w, c03_w.ds_segmento_clob_w)
	into STRICT	ds_segmento_clob_w
	;

end loop;
close C03;

select	concat(ds_segmento_clob_w, ds_segmento_w)
into STRICT	ds_segmento_clob_w
;


begin
	--rbg
	select 'RBG+'||
		nr_seq_301_medida_reab||'+'||
		nr_seq_301_sugest_trat||'+'||
		cd_ik_hosp_sugestao||chr(39)
	into STRICT	ds_segmento_w
	from 	d301_segmento_rbg
	where	nr_seq_dataset	= nr_seq_dataset_p;
exception
when others then
	ds_segmento_w := null;
end;

select	concat(ds_segmento_clob_w, ds_segmento_w)
into STRICT	ds_segmento_clob_w
;

  --rodape
select  'UNT+'||
	qt_segmento||'+'||
	lpad(nr_ref_segmento,5,'0')||chr(39)
into STRICT  	ds_segmento_w
from  	d301_segmento_unt
where  	nr_seq_dataset  = nr_seq_dataset_p;

select  concat(ds_segmento_clob_w, ds_segmento_w)
into STRICT  ds_segmento_clob_w
;

CALL inserir_d301_dataset_conteudo(nm_usuario_p, nr_seq_dataset_p, ds_segmento_clob_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_d301_conteudo_entl ( nr_seq_dataset_p bigint, nm_usuario_p text) FROM PUBLIC;

