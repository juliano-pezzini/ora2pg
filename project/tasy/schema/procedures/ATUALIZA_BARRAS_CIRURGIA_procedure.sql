-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_barras_cirurgia ( nr_prescricao_p bigint, cd_material_p bigint, qt_material_p bigint, cd_convenio_p bigint, cd_categoria_p text, nm_usuario_p text) AS $body$
DECLARE


cd_unidade_medida_w		varchar(30);
nr_receita_w			bigint;
qt_material_w			double precision;
cd_unidade_medida_dose_w	varchar(30);
cd_fornec_consignado_w		varchar(14);
cd_convenio_w			integer;
cd_categoria_w			varchar(10);
ds_observacao_w			varchar(4000);
nr_doc_interno_w		numeric(20);
nr_seq_kit_estoque_w		bigint;
cd_kit_material_w		integer;
cd_motivo_baixa_w		smallint;
nr_sequencia_w			bigint;
ie_origem_inf_w			smallint;
qt_unitaria_w			double precision;
nr_sequencia_ww			integer;
qt_material_ww			double precision;
nr_cirurgia_w			bigint;
nr_atendimento_w		bigint;

C01 CURSOR FOR
	SELECT 	cd_unidade_medida,
		nr_receita,
		qt_material,
		cd_unidade_medida_dose,
		cd_fornec_consignado,
		cd_convenio,
		cd_categoria,
		ds_observacao,
		nr_doc_interno,
		nr_seq_kit_estoque,
		cd_kit_material,
		cd_motivo_baixa,
		ie_origem_inf,
		qt_unitaria,
		nr_sequencia
	from	prescr_material
	where	cd_material = cd_material_p
	and 	nr_prescricao = nr_prescricao_p
	order by CASE WHEN coalesce(cd_convenio::text, '') = '' THEN 999  ELSE obter_tipo_convenio(cd_convenio) END;


BEGIN

qt_material_ww := qt_material_p;

open C01;
loop
fetch C01 into
	cd_unidade_medida_w,
	nr_receita_w,
	qt_material_w,
	cd_unidade_medida_dose_w,
	cd_fornec_consignado_w,
	cd_convenio_w,
	cd_categoria_w,
	ds_observacao_w,
	nr_doc_interno_w,
	nr_seq_kit_estoque_w,
	cd_kit_material_w,
	cd_motivo_baixa_w,
	ie_origem_inf_w,
	qt_unitaria_w,
	nr_sequencia_ww;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select 	max(obter_cirurgia_prescricao(nr_prescricao_p) )
	into STRICT	nr_cirurgia_w
	;

	select	max(nr_atendimento)
	into STRICT	nr_atendimento_w
	from 	cirurgia
	where 	nr_cirurgia = nr_cirurgia_w;

	if (coalesce(cd_categoria_p::text, '') = '') then
		begin

		if (coalesce(cd_categoria_w::text, '') = '') then
			select	max(cd_categoria)
			into STRICT	cd_categoria_w
			from	atend_categoria_convenio
			where 	cd_convenio = cd_convenio_p
			and 	nr_atendimento = nr_atendimento_w;

		end if;

		if (coalesce(cd_categoria_w::text, '') = '') then
			select	max(cd_categoria)
			into STRICT	cd_categoria_w
			from	categoria_convenio
			where	cd_convenio = cd_convenio_p
			and	coalesce(ie_situacao,'A') = 'A';

		end if;

		end;
	else
		cd_categoria_w	:= cd_categoria_p;
	end if;

	if (qt_material_w > qt_material_ww) and (coalesce(qt_material_ww,0) > 0) then

		select	coalesce(max(nr_sequencia),0) + 1
		into STRICT	nr_sequencia_w
		from	prescr_material
		where	nr_prescricao	=	nr_prescricao_p;

		insert into prescr_material(
			nr_sequencia                   ,
			nr_prescricao                  ,
			ie_origem_inf                  ,
			cd_material                    ,
			cd_unidade_medida              ,
			qt_dose                        ,
			qt_unitaria                    ,
			qt_material                    ,
			dt_atualizacao                 ,
			nm_usuario                     ,
			cd_intervalo                   ,
			ds_horarios                    ,
			ds_observacao                  ,
			ie_via_aplicacao               ,
			nr_agrupamento                 ,
			cd_motivo_baixa                ,
			dt_baixa                       ,
			ie_utiliza_kit                 ,
			cd_unidade_medida_dose         ,
			qt_conversao_dose              ,
			ie_urgencia                    ,
			nr_ocorrencia                  ,
			qt_total_dispensar             ,
			cd_fornec_consignado           ,
			nr_sequencia_solucao           ,
			nr_sequencia_proc              ,
			qt_solucao                     ,
			hr_dose_especial               ,
			qt_dose_especial               ,
			ds_dose_diferenciada           ,
			ie_medicacao_paciente          ,
			nr_sequencia_diluicao          ,
			hr_prim_horario                ,
			nr_dia_util                    ,
			nr_sequencia_dieta             ,
			ie_agrupador                   ,
			dt_emissao_setor_atend         ,
			ie_suspenso                    ,
			ds_justificativa               ,
			qt_dias_solicitado             ,
			qt_dias_liberado               ,
			nm_usuario_liberacao           ,
			dt_liberacao                   ,
			ie_se_necessario               ,
			qt_min_aplicacao               ,
			nr_seq_lote_fornec             ,
			ie_status_cirurgia             ,
			ie_bomba_infusao               ,
			ie_aplic_bolus                 ,
			ie_aplic_lenta                 ,
			ie_acm                         ,
			cd_material_baixa              ,
			nr_seq_avaliacao               ,
			nr_seq_ordem_prod              ,
			qt_baixa_especial              ,
			ie_objetivo                    ,
			qt_hora_aplicacao              ,
			ie_erro                        ,
			cd_topografia_cih              ,
			ie_origem_infeccao             ,
			cd_amostra_cih                 ,
			cd_microorganismo_cih          ,
			ie_cultura_cih                 ,
			ie_antibiograma                ,
			ie_uso_antimicrobiano          ,
			cd_kit_material                ,
			cd_local_estoque               ,
			nr_seq_kit                     ,
			dt_suspensao                   ,
			nm_usuario_susp                ,
			qt_vel_infusao                 ,
			cd_protocolo                   ,
			nr_seq_protocolo               ,
			nr_seq_mat_protocolo           ,
			dt_alteracao_local             ,
			nm_usuario_alt_local           ,
			ie_recons_diluente_fixo        ,
			qt_dias_util                   ,
			dt_fim_item                    ,
			nr_seq_atend_medic             ,
			nr_seq_kit_estoque             ,
			cd_convenio                    ,
			cd_categoria                   ,
			ie_sem_aprazamento             ,
			ie_novo_ciclo_ccih             ,
			nr_receita                     ,
			dt_status                      ,
			ie_status                      ,
			qt_volume_adep                 ,
			ie_supera_limite_uso           ,
			ie_cobra_paciente              ,
			ie_forma_infusao               ,
			ie_indicacao                   ,
			ie_dose_espec_agora            ,
			ie_tipo_medic_hd               ,
			cd_setor_exec_inic             ,
			cd_setor_exec_fim              ,
			nr_seq_pe_proc                 ,
			ie_intervalo_dif               ,
			ds_reprov_ccih                 ,
			qt_horas_estabilidade          ,
			dt_proxima_dose                ,
			ie_administrar                 ,
			qt_total_dias_lib              ,
			ie_regra_disp                  ,
			nr_seq_substituto              ,
			ds_observacao_enf              ,
			ds_observacao_ccih             ,
			ie_lado                        ,
			ds_diluicao_edit               ,
			qt_hora_intervalo              ,
			qt_min_intervalo               ,
			dt_inicio_medic                ,
			ds_observacao_far              ,
			ds_cor_erro                    ,
			ie_amanha                      ,
			qt_dia_prim_hor                ,
			qt_min_aplic_dose_esp          ,
			nr_doc_interno                 ,
			nr_seq_motivo_susp             ,
			ds_motivo_susp                 ,
			nm_usuario_consist             ,
			dt_atualizacao_consist         ,
			qt_vol_adic_reconst            ,
			qt_ref_diluente                ,
			nr_seq_atendimento             ,
			nr_seq_material                ,
			cd_mat_sem_apresent            ,
			ie_gerar_diluicao              ,
			nr_seq_via_acesso              ,
			ie_item_superior               ,
			ie_gerar_horario               ,
			nr_seq_origem_medic            ,
			dt_lib_enfermagem              ,
			dt_lib_farmacia                ,
			dt_lib_material                ,
			nr_seq_gasoterapia             ,
			ie_checar_adep                 ,
			nr_seq_mat_diluicao            ,
			cd_unidade_medida_sol          ,
			nr_seq_recomendacao            ,
			ie_glicemia                    ,
			ie_permite_substituir          ,
			cd_perfil_ativo                ,
			nr_seq_sol_prot                ,
			ds_observacao_nut              ,
			ie_baixa_estoque_cir           ,
			ie_adic_manual                 ,
			qt_baixa_nconta                ,
			ie_pre_medicacao               ,
			ds_horarios_medico             ,
			nr_seq_assinatura              ,
			ie_necessita_disp_kit          ,
			nr_seq_justificativa           ,
			ie_permite_alterar             ,
			nr_seq_inconsistencia          ,
			ie_alto_risco                  ,
			nr_seq_interf_farm             ,
			ie_conferencia                 ,
			ie_higienizacao                ,
			ie_preparo                     ,
			ds_lote                        ,
			dt_validade                    ,
			nr_seq_motivo_disp             ,
			ds_motivo_disp                 ,
			ds_diagnostico                 ,
			nr_prescricao_original         ,
			nr_seq_reg_kit                 ,
			nr_seq_anterior                ,
			ie_ciente                      ,
			dt_suspensao_progr             ,
			ie_modificado                  ,
			ie_agrupador_quimio            ,
			dt_prev_prox_etapa             ,
			ie_estendido                   ,
			nr_doc_interno_aux             ,
			qt_volume                      ,
			ie_aplicar                     ,
			dt_extensao                    ,
			nr_seq_produto                 ,
			nr_seq_leite_deriv             ,
			qt_porcentagem                 ,
			ie_tipo_doc_interno            ,
			ie_tipo_doc_interno_aux        ,
			ie_alterar_horario             ,
			nr_motivo_disp                 ,
			dt_impressao                   ,
			nr_seq_assin_prim_hor          ,
			nr_seq_assin_apraza            ,
			nr_seq_assinatura_susp         )
		SELECT  max(nr_sequencia_w                 ),
			max(nr_prescricao                  ),
			max(ie_origem_inf                  ),
			max(cd_material                    ),
			max(cd_unidade_medida              ),
			max(qt_dose                        ),
			max(qt_unitaria                    ),
			max(qt_material_w - qt_material_ww ),
			max(dt_atualizacao                 ),
			max(nm_usuario                     ),
			max(cd_intervalo                   ),
			max(ds_horarios                    ),
			max(ds_observacao                  ),
			max(ie_via_aplicacao               ),
			max(nr_agrupamento                 ),
			max(cd_motivo_baixa                ),
			max(dt_baixa                       ),
			max(ie_utiliza_kit                 ),
			max(cd_unidade_medida_dose         ),
			max(qt_conversao_dose              ),
			max(ie_urgencia                    ),
			max(nr_ocorrencia                  ),
			max(qt_material_w - qt_material_ww ),
			max(cd_fornec_consignado           ),
			max(nr_sequencia_solucao           ),
			max(nr_sequencia_proc              ),
			max(qt_solucao                     ),
			max(hr_dose_especial               ),
			max(qt_dose_especial               ),
			max(ds_dose_diferenciada           ),
			max(ie_medicacao_paciente          ),
			max(nr_sequencia_diluicao          ),
			max(hr_prim_horario                ),
			max(nr_dia_util                    ),
			max(nr_sequencia_dieta             ),
			max(ie_agrupador                   ),
			max(dt_emissao_setor_atend         ),
			max(ie_suspenso                    ),
			max(ds_justificativa               ),
			max(qt_dias_solicitado             ),
			max(qt_dias_liberado               ),
			max(nm_usuario_liberacao           ),
			max(dt_liberacao                   ),
			max(ie_se_necessario               ),
			max(qt_min_aplicacao               ),
			max(nr_seq_lote_fornec             ),
			max(ie_status_cirurgia             ),
			max(ie_bomba_infusao               ),
			max(ie_aplic_bolus                 ),
			max(ie_aplic_lenta                 ),
			max(ie_acm                         ),
			max(cd_material_baixa              ),
			max(nr_seq_avaliacao               ),
			max(nr_seq_ordem_prod              ),
			max(qt_baixa_especial              ),
			max(ie_objetivo                    ),
			max(qt_hora_aplicacao              ),
			max(ie_erro                        ),
			max(cd_topografia_cih              ),
			max(ie_origem_infeccao             ),
			max(cd_amostra_cih                 ),
			max(cd_microorganismo_cih          ),
			max(ie_cultura_cih                 ),
			max(ie_antibiograma                ),
			max(ie_uso_antimicrobiano          ),
			max(cd_kit_material                ),
			max(cd_local_estoque               ),
			max(nr_seq_kit                     ),
			max(dt_suspensao                   ),
			max(nm_usuario_susp                ),
			max(qt_vel_infusao                 ),
			max(cd_protocolo                   ),
			max(nr_seq_protocolo               ),
			max(nr_seq_mat_protocolo           ),
			max(dt_alteracao_local             ),
			max(nm_usuario_alt_local           ),
			max(ie_recons_diluente_fixo        ),
			max(qt_dias_util                   ),
			max(dt_fim_item                    ),
			max(nr_seq_atend_medic             ),
			max(nr_seq_kit_estoque             ),
			max(cd_convenio                    ),
			max(cd_categoria_w                  ),
			max(ie_sem_aprazamento             ),
			max(ie_novo_ciclo_ccih             ),
			max(nr_receita                     ),
			max(dt_status                      ),
			max(ie_status                      ),
			max(qt_volume_adep                 ),
			max(ie_supera_limite_uso           ),
			max(ie_cobra_paciente              ),
			max(ie_forma_infusao               ),
			max(ie_indicacao                   ),
			max(ie_dose_espec_agora            ),
			max(ie_tipo_medic_hd               ),
			max(cd_setor_exec_inic             ),
			max(cd_setor_exec_fim              ),
			max(nr_seq_pe_proc                 ),
			max(ie_intervalo_dif               ),
			max(ds_reprov_ccih                 ),
			max(qt_horas_estabilidade          ),
			max(dt_proxima_dose                ),
			max(ie_administrar                 ),
			max(qt_total_dias_lib              ),
			max(ie_regra_disp                  ),
			max(nr_seq_substituto              ),
			max(ds_observacao_enf              ),
			max(ds_observacao_ccih             ),
			max(ie_lado                        ),
			max(ds_diluicao_edit               ),
			max(qt_hora_intervalo              ),
			max(qt_min_intervalo               ),
			max(dt_inicio_medic                ),
			max(ds_observacao_far              ),
			max(ds_cor_erro                    ),
			max(ie_amanha                      ),
			max(qt_dia_prim_hor                ),
			max(qt_min_aplic_dose_esp          ),
			max(nr_doc_interno                 ),
			max(nr_seq_motivo_susp             ),
			max(ds_motivo_susp                 ),
			max(nm_usuario_consist             ),
			max(dt_atualizacao_consist         ),
			max(qt_vol_adic_reconst            ),
			max(qt_ref_diluente                ),
			max(nr_seq_atendimento             ),
			max(nr_seq_material                ),
			max(cd_mat_sem_apresent            ),
			max(ie_gerar_diluicao              ),
			max(nr_seq_via_acesso              ),
			max(ie_item_superior               ),
			max(ie_gerar_horario               ),
			max(nr_seq_origem_medic            ),
			max(dt_lib_enfermagem              ),
			max(dt_lib_farmacia                ),
			max(dt_lib_material                ),
			max(nr_seq_gasoterapia             ),
			max(ie_checar_adep                 ),
			max(nr_seq_mat_diluicao            ),
			max(cd_unidade_medida_sol          ),
			max(nr_seq_recomendacao            ),
			max(ie_glicemia                    ),
			max(ie_permite_substituir          ),
			max(cd_perfil_ativo                ),
			max(nr_seq_sol_prot                ),
			max(ds_observacao_nut              ),
			max(ie_baixa_estoque_cir           ),
			max(ie_adic_manual                 ),
			max(qt_baixa_nconta                ),
			max(ie_pre_medicacao               ),
			max(ds_horarios_medico             ),
			max(nr_seq_assinatura              ),
			max(ie_necessita_disp_kit          ),
			max(nr_seq_justificativa           ),
			max(ie_permite_alterar             ),
			max(nr_seq_inconsistencia          ),
			max(ie_alto_risco                  ),
			max(nr_seq_interf_farm             ),
			max(ie_conferencia                 ),
			max(ie_higienizacao                ),
			max(ie_preparo                     ),
			max(ds_lote                        ),
			max(dt_validade                    ),
			max(nr_seq_motivo_disp             ),
			max(ds_motivo_disp                 ),
			max(ds_diagnostico                 ),
			max(nr_prescricao_original         ),
			max(nr_seq_reg_kit                 ),
			max(nr_seq_anterior                ),
			max(ie_ciente                      ),
			max(dt_suspensao_progr             ),
			max(ie_modificado                  ),
			max(ie_agrupador_quimio            ),
			max(dt_prev_prox_etapa             ),
			max(ie_estendido                   ),
			max(nr_doc_interno_aux             ),
			max(qt_volume                      ),
			max(ie_aplicar                     ),
			max(dt_extensao                    ),
			max(nr_seq_produto                 ),
			max(nr_seq_leite_deriv             ),
			max(qt_porcentagem                 ),
			max(ie_tipo_doc_interno            ),
			max(ie_tipo_doc_interno_aux        ),
			max(ie_alterar_horario             ),
			max(nr_motivo_disp                 ),
			max(dt_impressao                   ),
			max(nr_seq_assin_prim_hor          ),
			max(nr_seq_assin_apraza            ),
			max(nr_seq_assinatura_susp         )
		from	prescr_material
		where	cd_material = cd_material_p
		and 	nr_prescricao = nr_prescricao_p
		and	nr_sequencia = nr_sequencia_ww;

		commit;

		update 	prescr_material
		set 	qt_material = qt_material_ww,
			qt_total_dispensar = qt_material_ww,
			cd_convenio = cd_convenio_p,
			cd_categoria = cd_categoria_w
		where	cd_material = cd_material_p
		and 	nr_prescricao = nr_prescricao_p
		and 	nr_sequencia = nr_sequencia_ww;

		qt_material_ww := qt_material_ww - qt_material_w;

		commit;
	elsif (coalesce(qt_material_ww,0) > 0) then
		qt_material_ww := qt_material_ww - qt_material_w;

		update 	prescr_material
		set 	cd_convenio = cd_convenio_p,
			cd_categoria = cd_categoria_w
		where	cd_material = cd_material_p
		and 	nr_prescricao = nr_prescricao_p
		and 	nr_sequencia = nr_sequencia_ww;

		commit;
	end if;

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_barras_cirurgia ( nr_prescricao_p bigint, cd_material_p bigint, qt_material_p bigint, cd_convenio_p bigint, cd_categoria_p text, nm_usuario_p text) FROM PUBLIC;

