-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_regra_resumo_meta ( dt_referencia_p timestamp) AS $body$
DECLARE

 
 
/*Procedure de controle WHEB*/
 
 
dt_referencia_w		timestamp;
nm_usuario_w		varchar(15);
nm_usuario_exec_w	varchar(15);
qt_ordem_w		integer;
nr_seq_grupo_des_w	bigint;

c00 CURSOR FOR 
	SELECT	nm_usuario 
	from	usuario 
	where	cd_setor_atendimento in (2,7);/*Busca fixo - Desenvolvimento e tecnologia*/
 
 
/*	Estágios						Grupo Trabalho 
	4	Desenvolvimento pendente para análise	1 	Desenvolvimento 
	261	Aguardando Conexão - Desenvolvimento	2 	Suporte 
	131	Tecnologia				72 	Tecnologia 
	331	Planejamento				92 	Planejamento 
	731	Desenvolvimento em análise			122 	Certificação SBIS 
	732	Desenvolvimento em programação		132 	Teste de Software 
	741	Aguardando reunião interna - desenv		 
	891	Desenvolvimento em projeto 
*/
c01 CURSOR FOR 
	SELECT	nm_usuario_exec_prev, 
		x.nr_seq_grupo_des, 
		count(*) 
	from	man_ordem_servico_v x, 
		man_ordem_servico a 
	where	a.nr_sequencia = x.nr_sequencia 
	and   x.nr_seq_trab in (1,2,92,122,132,72) 
	and	coalesce(a.nr_seq_meta_pe::text, '') = '' 
	and	coalesce(a.nr_seq_obj_bsc::text, '') = '' 
	and   a.nr_seq_estagio in (4,261,131,331,731,732,741,891) 
	and	a.ie_status_ordem in ('1','2') 
	group by 
		x.nr_seq_grupo_des, 
		nm_usuario_exec_prev;


BEGIN 
 
dt_referencia_w		:= trunc(dt_referencia_p, 'dd');
 
delete 
from	man_regra_resumo_meta 
where	dt_referencia = trunc(dt_referencia_w);
 
commit;
 
/*open c00; 
loop fetch c00 into 
	nm_usuario_w; 
exit when c00%notfound; 
	begin */
 
 
	open c01;
	loop fetch c01 into 
		nm_usuario_exec_w, 
		nr_seq_grupo_des_w, 
		qt_ordem_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin 
		insert into man_regra_resumo_meta( 
			nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_referencia, 
			nm_usuario_exec, 
			qt_ordem_servico, 
			nr_seq_grupo_des) 
		values ( nextval('man_regra_resumo_meta_seq'), 
			clock_timestamp(), 
			'Baca', 
			dt_referencia_w, 
			nm_usuario_exec_w, 
			qt_ordem_w, 
			nr_seq_grupo_des_w);
		end;
	end loop;
	close 	c01;
 
	/*end; 
end loop; 
close c00; 
 
*/
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_regra_resumo_meta ( dt_referencia_p timestamp) FROM PUBLIC;

