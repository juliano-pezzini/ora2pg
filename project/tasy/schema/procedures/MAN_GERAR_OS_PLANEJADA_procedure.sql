-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_os_planejada ( nr_seq_equip_p bigint, nr_seq_planej_p bigint, dt_ordem_p timestamp, nm_usuario_p text, nr_seq_ordem_p INOUT bigint, ie_regra_dia_p text default 'S') AS $body$
DECLARE


cd_perfil_w		integer;
cd_pessoa_solic_w		varchar(10);
cd_pessoa_resp_w		varchar(10);
cd_setor_atendimento_w	integer;
ds_arquivo_w		varchar(255);
ds_perfil_adicional_w	varchar(4000);
ds_atividade_w		varchar(2000);
ds_comunicado_w		varchar(4000);
ds_dano_w		varchar(2000);
ds_dano_breve_w		varchar(80);
dt_ultima_ordem_w		timestamp;
dt_prevista_w		timestamp;
dt_emissao_prev_w		timestamp;
ie_anexar_email_w		varchar(1);
ie_comunicacao_w		varchar(1);
ie_prioridade_w		varchar(1);
ie_solicitante_w		varchar(1);
nm_usuario_exec_w	varchar(15);
nm_usuario_destino_w	varchar(255);
nr_seq_anexo_w		bigint;
nr_seq_equip_w		bigint;
nr_seq_local_w		bigint;
nr_seq_planej_w		bigint;
nr_seq_tipo_cont_w	bigint;
nr_seq_planej_ww		bigint;
nr_seq_trab_w		bigint;
nr_seq_ordem_w		bigint := 0;
nr_max_seq_ordem_w	bigint;
nr_seq_ativ_w		bigint;
qt_dia_freq_w		smallint;
qt_dia_ordem_w		smallint;
qt_dia_prev_w		smallint;
qt_min_prev_w		bigint;
dt_atual_w		timestamp	:= clock_timestamp();
dt_ordem_w		timestamp	:= dt_ordem_p;
dt_ordem_servico_w	timestamp;
ie_grau_satisfacao_w	varchar(03);
nr_seq_estagio_w		bigint;
nr_seq_tipo_os_w		bigint;
nr_seq_grupo_sup_w	bigint;
nr_seq_tipo_aval_w		bigint;
nr_seq_aval_w		bigint;
ie_dia_nao_util_w		varchar(15);
ie_dia_util_w		varchar(15);
cd_estabelecimento_w	smallint;
ie_feriado_w		smallint;
ie_forma_receb_w		varchar(15);
nr_seq_apres_w		integer;
qt_existe_w		bigint;
ds_historico_w		text;
ds_contato_solic_w		varchar(255);
ie_situacao_os_w		varchar(5);
ie_status_w		varchar(5);
ie_status_os_estagio_w	varchar(15);
nr_seq_origem_dano_w	bigint;
nr_seq_causa_dano_w	bigint;
nr_seq_tipo_solucao_w	bigint;
nr_seq_complex_w		bigint;
nr_seq_cs_w		bigint;
cd_funcao_w		integer;
ie_gerar_w		varchar(01) := 'S';
ie_equip_regra_excl_w		varchar(1) := 'N';
qt_reg_w			integer;
ie_gerar_inicio_exec_os_w	varchar(1) := 'N';
ds_titulo_comunic_w	varchar(255);

C02 CURSOR FOR
SELECT	ds_atividade,
	qt_min_prev,
	nr_seq_apres
from	man_planej_atividade
where	nr_seq_planej_prev	= nr_seq_planej_p;

c03 CURSOR FOR
SELECT	ds_arquivo,
	ie_anexar_email
from	man_planej_prev_arq
where	nr_seq_planej_Prev	= nr_seq_planej_p;

c04 CURSOR FOR
SELECT	nr_seq_tipo_avaliacao
from	man_planej_prev_aval
where	nr_seq_planej		= nr_seq_planej_p;

c05 CURSOR FOR
SELECT	distinct nm_usuario_exec
from	man_equip_usuario_exec
where	nr_seq_equipamento = nr_seq_equip_w
and	coalesce(nr_seq_grupo_trabalho,coalesce(nr_seq_trab_w,0)) = coalesce(nr_seq_trab_w,0)
and	coalesce(nr_seq_grupo_planej,coalesce(nr_seq_planej_ww,0)) = coalesce(nr_seq_planej_ww,0)
and	(nm_usuario_exec IS NOT NULL AND nm_usuario_exec::text <> '');

c06 CURSOR FOR
SELECT	ds_historico
from	man_planej_prev_hist
where	nr_seq_planej = nr_seq_planej_p
order by dt_historico;


BEGIN

select	coalesce(max(vl_parametro),'N')
into STRICT	ie_status_os_estagio_w
from	funcao_parametro
where	cd_funcao	= 298
and	nr_sequencia	= 73;

select	a.nr_sequencia,
	a.qt_dia_previsto,
	a.qt_dia_gerar_ordem,
	a.ie_prioridade,
	a.cd_pessoa_solicitante,
	CASE WHEN a.ie_solicitante='L' THEN d.cd_setor  ELSE a.cd_setor_atendimento END ,
	a.ds_dano,
	a.ds_planejamento,
	a.nr_seq_tipo_contador,
	a.nm_usuario_exec,
	a.ie_comunicacao,
	a.ie_solicitante,
	coalesce(a.cd_perfil,0),
	b.nr_sequencia,
	b.nr_seq_local,
	coalesce(a.nr_seq_grupo_planej, b.nr_seq_planej),
	coalesce(a.nr_seq_grupo_trabalho, b.nr_seq_trab),
	a.ie_grau_satisfacao,
	a.nr_seq_estagio,
	a.nr_seq_tipo_os,
	a.nr_seq_grupo_sup,
	a.ie_dia_nao_util,
	a.ie_dia_util,
	coalesce(a.cd_estabelecimento, wheb_usuario_pck.get_cd_estabelecimento),
	ie_forma_receb,
	a.nr_seq_origem_dano,
	a.cd_funcao,
	a.nr_seq_causa_dano,
	a.nr_seq_tipo_solucao,
	a.nr_seq_complex,
	a.nr_seq_cs,
	a.ie_gerar_inicio_exec_os
into STRICT	nr_seq_planej_w,
	qt_dia_prev_w,
	qt_dia_ordem_w,
	ie_prioridade_w,
	cd_pessoa_solic_w,
	cd_setor_atendimento_w,
	ds_dano_w,
	ds_dano_breve_w,
	nr_seq_tipo_cont_w,
	nm_usuario_exec_w,
	ie_comunicacao_w,
	ie_solicitante_w,
	cd_perfil_w,
	nr_seq_equip_w,
	nr_seq_local_w,
	nr_seq_planej_ww,
	nr_seq_trab_w,
	ie_grau_satisfacao_w,
	nr_seq_estagio_w,
	nr_seq_tipo_os_w,
	nr_seq_grupo_sup_w,
	ie_dia_nao_util_w,
	ie_dia_util_w,
	cd_estabelecimento_w,
	ie_forma_receb_w,
	nr_seq_origem_dano_w,
	cd_funcao_w,
	nr_seq_causa_dano_w,
	nr_seq_tipo_solucao_w,
	nr_seq_complex_w,
	nr_seq_cs_w,
	ie_gerar_inicio_exec_os_w
from	man_localizacao d,
	man_planej_prev a,
	man_equipamento b
where	a.nr_sequencia		= nr_seq_planej_p
and	b.nr_sequencia		= nr_seq_equip_p
and	b.nr_seq_local		= d.nr_sequencia
and	coalesce(a.cd_setor_atendimento, d.cd_setor)	= d.cd_setor;

select	count(nr_sequencia)
into STRICT	qt_reg_w
from	man_planej_prev_equip_excl
where	nr_seq_equipamento = nr_seq_equip_w
and	nr_seq_planej_prev = nr_seq_planej_w;

ie_equip_regra_excl_w := 'N';
if (qt_reg_w > 0) then
	ie_equip_regra_excl_w := 'S';
end if;


if (ie_equip_regra_excl_w = 'N') then
	if (ie_solicitante_w <> 'S') and (cd_setor_atendimento_w IS NOT NULL AND cd_setor_atendimento_w::text <> '') then /* Matheus OS 55553 07/05/07*/
		select	coalesce(max(cd_pessoa_resp),cd_pessoa_solic_w)
		into STRICT	cd_pessoa_solic_w
		from	setor_atendimento
		where	cd_setor_atendimento = cd_setor_atendimento_w;

	end if;

	select	nextval('man_ordem_servico_seq')
	into STRICT	nr_seq_ordem_w
	;

	ie_gerar_w := 'S';

	if (coalesce(ie_regra_dia_p,'S') = 'S') and (coalesce(ie_dia_nao_util_w,'M') <> 'M') then
		select	coalesce(substr(obter_se_feriado(cd_estabelecimento_w, dt_ordem_w),1,1),'0')
		into STRICT	ie_feriado_w
		;

		if (ie_feriado_w > 0) or (pkg_date_utils.IS_BUSINESS_DAY(dt_ordem_w) = 0) then
			begin
			if (ie_dia_nao_util_w = 'A') then /*antecipar*/
				dt_ordem_w := obter_dia_anterior_util(cd_estabelecimento_w, dt_ordem_w);
				dt_atual_w := dt_ordem_w;
			elsif (ie_dia_nao_util_w = 'P') then /*postergar*/
				dt_ordem_w := obter_proximo_dia_util(cd_estabelecimento_w, dt_ordem_w);
				dt_atual_w := dt_ordem_w;
			elsif (ie_dia_nao_util_w = 'N') then /*não gerar*/
				ie_gerar_w := 'N';
			end if;
			end;
		end if;
	end if;

	if (coalesce(ie_regra_dia_p,'S') = 'S') and (coalesce(ie_dia_util_w,'M') <> 'M') then
		select	coalesce(substr(obter_se_feriado(cd_estabelecimento_w, dt_ordem_w),1,1),'0')
		into STRICT	ie_feriado_w
		;

		if (ie_feriado_w = 0) and (pkg_date_utils.IS_BUSINESS_DAY(dt_ordem_w) = 1) then
			begin
			if (ie_dia_util_w = 'A') then /*antecipar*/
				dt_ordem_w := obter_dia_anterior_util(cd_estabelecimento_w, dt_ordem_w);
				dt_atual_w := dt_ordem_w;
			elsif (ie_dia_util_w = 'P') then /*postergar*/
				dt_ordem_w := obter_dia_anterior_nao_util(cd_estabelecimento_w, dt_ordem_w);
				dt_atual_w := dt_ordem_w;
			elsif (ie_dia_util_w = 'N') then /*não gerar*/
				ie_gerar_w := 'N';
			end if;
			end;
		end if;
	end if;

	if (coalesce(ie_gerar_w,'S') = 'S') then
		begin
		if (nm_usuario_p = 'PlanejFixo') then
			dt_ordem_servico_w := dt_ordem_w;
		else
			dt_ordem_servico_w := dt_atual_w;
		end if;

		if (cd_pessoa_solic_w IS NOT NULL AND cd_pessoa_solic_w::text <> '') then
			begin
			select  max(substr(wheb_mensagem_pck.get_texto(305700) || ' ' || coalesce(nr_ramal,substr(obter_compl_pf(cd_pessoa_fisica,2,'RAM'),1,20)) || ' - ' || wheb_mensagem_pck.get_texto(305701) || ' ' || substr(obter_nome_setor(obter_setor_usuario(nm_usuario)),1,80),1,255))
			into STRICT	ds_contato_solic_w
			from 	usuario
			where 	cd_pessoa_fisica = cd_pessoa_solic_w;
			end;
		end if;

		if (nr_seq_estagio_w IS NOT NULL AND nr_seq_estagio_w::text <> '')and (ie_status_os_estagio_w = 'S') then

			begin
			select	ie_situacao_os
			into STRICT	ie_situacao_os_w
			from	man_estagio_processo
			where	nr_sequencia = nr_seq_estagio_w;
			exception
			when others then
				ie_situacao_os_w := null;
			end;

			if (ie_situacao_os_w IS NOT NULL AND ie_situacao_os_w::text <> '')and (ie_situacao_os_w <> '3')then
				ie_status_w := ie_situacao_os_w;
			end if;
		end if;

		insert into man_ordem_servico(
			nr_sequencia,
			nr_seq_localizacao,
			nr_seq_equipamento,
			cd_pessoa_solicitante,
			dt_ordem_servico,
			ie_prioridade,
			ie_parado,
			ds_dano_breve,
			dt_atualizacao,
			nm_usuario,
			dt_inicio_desejado,
			dt_conclusao_desejada,
			ds_dano,
			dt_inicio_previsto,
			dt_fim_previsto,
			dt_inicio_real,
			dt_fim_real,
			ie_tipo_ordem,
			ie_status_ordem,
			nr_grupo_planej,
			nr_grupo_trabalho,
			nr_seq_tipo_solucao,
			ds_solucao,
			nm_usuario_exec,
			qt_contador,
			nr_seq_planej,
			nr_seq_tipo_contador,
			ie_classificacao,
			ie_grau_satisfacao,
			nr_seq_estagio,
			ie_origem_os,
			nr_seq_tipo_ordem,
			nr_seq_grupo_sup,
			ie_forma_receb,
			ds_contato_solicitante,
			nr_seq_origem_dano,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			cd_funcao,
			nr_seq_causa_dano,
			nr_seq_complex,
			nr_seq_cs)
		values (	nr_seq_ordem_w,
			nr_seq_local_w,
			nr_seq_equip_w,
			cd_pessoa_solic_w,
			dt_ordem_servico_w,
			ie_prioridade_w,
			'N',
			ds_dano_breve_w,
			dt_atual_w,
			nm_usuario_p,
			dt_ordem_servico_w + qt_dia_ordem_w,
			dt_ordem_servico_w + qt_dia_prev_w + qt_dia_ordem_w,
			ds_dano_w,
			CASE WHEN ie_status_w=2 THEN dt_ordem_servico_w + qt_dia_ordem_w  ELSE null END ,
			CASE WHEN ie_status_w=2 THEN dt_ordem_servico_w + qt_dia_prev_w + qt_dia_ordem_w  ELSE null END ,
			null,
			null,
			2,
			coalesce(ie_status_w,1),
			nr_seq_planej_ww,
			nr_seq_trab_w,
			nr_seq_tipo_solucao_w,
			null,
			CASE WHEN ie_gerar_inicio_exec_os_w='S' THEN nm_usuario_exec_w  ELSE '' END ,
			null,
			nr_seq_planej_w,
			nr_seq_tipo_cont_w,
			'S',
			ie_grau_satisfacao_w,
			nr_seq_estagio_w,
			'4',
			nr_seq_tipo_os_w,
			nr_seq_grupo_sup_w,
			ie_forma_receb_w,
			ds_contato_solic_w,
			nr_seq_origem_dano_w,
			coalesce(wheb_usuario_pck.get_nm_usuario,CASE WHEN nm_usuario_p='PlanejFixo' THEN 'JOB_FIXO'  ELSE 'JOB' END ),
			clock_timestamp(),
			cd_funcao_w,
			nr_seq_causa_dano_w,
			nr_seq_complex_w,
			nr_seq_cs_w);

		open C02;
		loop
		fetch C02 into
			ds_atividade_w,
			qt_min_prev_w,
			nr_seq_apres_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			select	nextval('man_ordem_ativ_prev_seq')
			into STRICT	nr_seq_ativ_w
			;
			insert into man_ordem_ativ_prev(
				nr_sequencia,
				nr_seq_ordem_serv,
				dt_atualizacao,
				nm_usuario,
				ds_atividade,
				qt_min_prev,
				nr_seq_apres)
			values (	nr_seq_ativ_w,
				nr_seq_ordem_w,
				dt_atual_w,
				nm_usuario_p,
				ds_atividade_w,
				qt_min_prev_w,
				nr_seq_apres_w);
		end loop;
		close C02;

		open c03;
		loop
		fetch C03 into
			ds_arquivo_w,
			ie_anexar_email_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			select	nextval('man_ordem_serv_arq_seq')
			into STRICT	nr_seq_anexo_w
			;
			insert into man_ordem_serv_arq(
				nr_sequencia,
				nr_seq_ordem,
				ds_arquivo,
				ie_anexar_email,
				dt_atualizacao,
				nm_usuario)
			values (	nr_seq_anexo_w,
				nr_seq_ordem_w,
				ds_arquivo_w,
				ie_anexar_email_w,
				dt_atual_w,
				nm_usuario_p);
		end loop;
		close c03;

		open c04;
		loop
		fetch C04 into
			nr_seq_tipo_aval_w;
		EXIT WHEN NOT FOUND; /* apply on C04 */
			select	nextval('man_ordem_serv_avaliacao_seq')
			into STRICT	nr_seq_aval_w
			;
			insert into man_ordem_serv_avaliacao(
				nr_sequencia,
				nr_seq_tipo_avaliacao,
				nr_seq_ordem_servico,
				dt_avaliacao,
				dt_atualizacao,
				nm_usuario)
			values (	nr_seq_aval_w,
				nr_seq_tipo_aval_w,
				nr_seq_ordem_w,
				dt_atual_w,
				dt_atual_w,
				nm_usuario_p);
		end loop;
		close c04;

		if (nm_usuario_exec_w IS NOT NULL AND nm_usuario_exec_w::text <> '') then
			insert into man_ordem_servico_exec(
				nr_sequencia,
				nr_seq_ordem,
				dt_atualizacao,
				nm_usuario,
				nm_usuario_exec,
				qt_min_prev,
				dt_recebimento)
			values (	nextval('man_ordem_servico_exec_seq'),
				nr_seq_ordem_w,
				dt_atual_w,
				nm_usuario_p,
				nm_usuario_exec_w,
				0,
				dt_atual_w);
		end if;

		open C05;
		loop
		fetch C05 into
			nm_usuario_exec_w;
		EXIT WHEN NOT FOUND; /* apply on C05 */
			begin
			select 	count(*)
			into STRICT	qt_existe_w
			from 	man_ordem_servico_exec
			where	nr_seq_ordem 	= nr_seq_ordem_w
			and	nm_usuario_exec = nm_usuario_exec_w;

			if (qt_existe_w = 0) then
				insert into  man_ordem_servico_exec(
					nr_sequencia,
					nr_seq_ordem,
					dt_atualizacao,
					nm_usuario,
					nm_usuario_exec)
				values ( nextval('man_ordem_servico_exec_seq'),
					nr_seq_ordem_w,
					clock_timestamp(),
					nm_usuario_p,
					nm_usuario_exec_w);
			end if;
			end;
		end loop;
		close C05;

		open c06;
		loop
		fetch C06 into
			ds_historico_w;
		EXIT WHEN NOT FOUND; /* apply on C06 */
			insert into man_ordem_serv_tecnico(
				nr_sequencia,
				nr_seq_ordem_serv,
				nm_usuario,
				dt_atualizacao,
				ds_relat_tecnico,
				dt_historico,
				dt_liberacao,
				nm_usuario_lib)
			values (	nextval('man_ordem_serv_tecnico_seq'),
				nr_seq_ordem_w,
				nm_usuario_p,
				clock_timestamp(),
				ds_historico_w,
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_p);
		end loop;
		close c06;

		if (ie_comunicacao_w = 'S') then /* Matheus OS 55553 07/05/07*/
			select	coalesce(obter_usuario_pessoa(cd_pessoa_solic_w),'X')
			into STRICT	nm_usuario_destino_w
			;

			if (cd_setor_atendimento_w IS NOT NULL AND cd_setor_atendimento_w::text <> '') then
				select	coalesce(max(cd_pessoa_resp), 'X')
				into STRICT	cd_pessoa_resp_w
				from	setor_atendimento
				where	cd_setor_atendimento = cd_setor_atendimento_w;
				if (cd_pessoa_resp_w <> 'X') then
					nm_usuario_destino_w	:= nm_usuario_destino_w || ',' || obter_usuario_pessoa(cd_pessoa_resp_w);
				end if;
			end if;


			if (coalesce(cd_perfil_w,0) <> 0) then
				ds_perfil_adicional_w	:= to_char(cd_perfil_w) || ',';
			end if;

			if (nm_usuario_destino_w <> 'X') then
				ds_comunicado_w	:= substr(wheb_mensagem_pck.get_texto(305706,'DS_DANO=' || ds_dano_breve_w) || chr(13) || chr(10),1,4000);

				ds_comunicado_w	:= substr(ds_comunicado_w || ds_dano_w,1,4000);

				ds_titulo_comunic_w	:= substr(wheb_mensagem_pck.get_texto(305711,'NR_SEQ_ORDEM=' || nr_seq_ordem_w),1,255);

				CALL gerar_comunic_padrao(	dt_atual_w,
							ds_titulo_comunic_w,
							ds_comunicado_w,
							nm_usuario_p,
							'N',
							nm_usuario_destino_w,
							'N',
							null,
							ds_perfil_adicional_w,
							null,
							null,
							dt_atual_w,
							null,
							null);
			end if;
		end if;
		end;
	end if;
end if;

nr_seq_ordem_p	:= nr_seq_ordem_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_os_planejada ( nr_seq_equip_p bigint, nr_seq_planej_p bigint, dt_ordem_p timestamp, nm_usuario_p text, nr_seq_ordem_p INOUT bigint, ie_regra_dia_p text default 'S') FROM PUBLIC;

