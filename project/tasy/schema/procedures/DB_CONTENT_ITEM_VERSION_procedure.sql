-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE db_content_item_version ( nr_seq_content_item_p bigint, nm_usuario_p text, nr_seq_new_version_p INOUT bigint) AS $body$
DECLARE

  nr_seq_w db_content_item.nr_sequencia%type;
  nr_version_w db_content_item.nr_version%type;

BEGIN

  SELECT nr_seq_source
  INTO STRICT nr_seq_w
  FROM db_content_item a
  WHERE nr_sequencia = nr_seq_content_item_p;

  --children record
  IF (nr_seq_w IS NOT NULL AND nr_seq_w::text <> '') THEN
    SELECT MAX(nr_version)
    INTO STRICT nr_version_w
    FROM db_content_item a
    WHERE nr_seq_source = nr_seq_w;
  ELSE
    SELECT MAX(nr_version)
    INTO STRICT nr_version_w
    FROM db_content_item a
    WHERE nr_seq_source = nr_seq_content_item_p;

    IF coalesce(nr_version_w::text, '') = '' THEN
      SELECT nr_version
      INTO STRICT nr_version_w
      FROM db_content_item a
      WHERE nr_sequencia = nr_seq_content_item_p;
    END IF;
  END IF;

  SELECT nextval('db_content_item_seq') INTO STRICT nr_seq_w;

  INSERT
  INTO db_content_item(
      nr_sequencia,
      nm_usuario_nrec,
      dt_atualizacao_nrec,
      nm_usuario,
      dt_atualizacao,
      ds_name,
      ie_content_type,
      ds_detail,
      ds_value,
      ds_content_value,
      nr_seq_source,
      nr_version
    )
  SELECT nr_seq_w,
    nm_usuario_p,
    clock_timestamp(),
    nm_usuario_p,
    clock_timestamp(),
    ds_name,
    ie_content_type,
    ds_detail,
    ds_value,
    ds_content_value,
    coalesce(nr_seq_source, nr_seq_content_item_p),
    nr_version_w + 1
  FROM db_content_item a
  WHERE nr_sequencia = nr_seq_content_item_p;

  COMMIT;
  nr_seq_new_version_p := nr_seq_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE db_content_item_version ( nr_seq_content_item_p bigint, nm_usuario_p text, nr_seq_new_version_p INOUT bigint) FROM PUBLIC;

