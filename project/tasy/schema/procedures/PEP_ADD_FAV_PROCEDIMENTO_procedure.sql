-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pep_add_fav_procedimento ( nr_atendimento_p proc_pac_descricao.nr_atendimento%type, nr_sequencia_p proc_pac_descricao.nr_sequencia%type) AS $body$
DECLARE


nr_sequencia_w	pep_fav_procedimento.nr_sequencia%type;
nm_usuario_w	pep_fav_procedimento.nm_usuario%type;

qt_reg_w	smallint;

nr_seq_proc_interno_w	pep_fav_procedimento.nr_seq_proc_interno%type;
cd_doenca_w		pep_fav_procedimento.cd_doenca%type;
cd_procedimento_w	pep_fav_procedimento.cd_procedimento%type;
ie_origem_proced_w	pep_fav_procedimento.ie_origem_proced%type;
ds_proc_exame_w		proc_interno.ds_proc_exame%type;
ds_descricao_w		pep_fav_procedimento.ds_descricao%type;


BEGIN

select	coalesce(max(nr_sequencia),0)
into STRICT	nr_sequencia_w
from	pep_fav_procedimento;

nm_usuario_w := wheb_usuario_pck.get_nm_usuario;

select	a.nr_seq_proc_interno,
	a.cd_doenca,
	a.cd_procedimento,
	a.ie_origem_proced,
	(select b.ds_proc_exame from proc_interno b where b.nr_sequencia = a.nr_seq_proc_interno),
	ds_descricao
into STRICT	nr_seq_proc_interno_w,
	cd_doenca_w,
	cd_procedimento_w,
	ie_origem_proced_w,
	ds_proc_exame_w,
	ds_descricao_w
from	proc_pac_descricao a
where	a.nr_atendimento = nr_atendimento_p
and	a.nr_sequencia = nr_sequencia_p;

select	count(1)
into STRICT	qt_reg_w
from	pep_fav_procedimento
where	nm_usuario = nm_usuario_w
and	nr_seq_proc_interno = nr_seq_proc_interno_w
and	cd_doenca = cd_doenca_w
and	cd_procedimento = cd_procedimento_w
and	ie_origem_proced = ie_origem_proced_w;

if (coalesce(qt_reg_w,0) = 0) then
	insert into pep_fav_procedimento(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_proc_interno,
					cd_doenca,
					cd_procedimento,
					ie_origem_proced,
					ds_proced_favlist,
					nr_seq_apresentacao,
					ds_descricao
					)
				values (	nr_sequencia_w + 1,
					clock_timestamp(),
					nm_usuario_w,
					clock_timestamp(),
					nm_usuario_w,
					nr_seq_proc_interno_w,
					cd_doenca_w,
					cd_procedimento_w,
					ie_origem_proced_w,
					substr(ds_proc_exame_w,1,120),
					99,
					ds_descricao_w);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pep_add_fav_procedimento ( nr_atendimento_p proc_pac_descricao.nr_atendimento%type, nr_sequencia_p proc_pac_descricao.nr_sequencia%type) FROM PUBLIC;

