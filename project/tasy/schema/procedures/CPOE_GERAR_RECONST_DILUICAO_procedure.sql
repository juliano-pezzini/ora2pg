-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_reconst_diluicao ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_material_p material.cd_material%type, ie_via_aplicacao_p via_aplicacao.ie_via_aplicacao%type, qt_dose_medic_p bigint, cd_unidade_medida_dose_p unidade_medida.cd_unidade_medida%type, ie_opcao_p bigint, ie_alterou_dose_p text, nm_usuario_p usuario.nm_usuario%type, nr_seq_dil_p INOUT bigint, cd_mat_dil_p INOUT material.cd_material%type, qt_dose_dil_p INOUT bigint, cd_unid_med_dose_dil_p INOUT unidade_medida.cd_unidade_medida%type, qt_solucao_dil_p INOUT bigint, ds_dose_diferenciada_dil_p INOUT text, nr_seq_red_p INOUT bigint, cd_mat_red_p INOUT material.cd_material%type, qt_dose_red_p INOUT bigint, cd_unid_med_dose_red_p INOUT unidade_medida.cd_unidade_medida%type, qt_solucao_red_p INOUT bigint, ds_dose_diferenciada_red_p INOUT text, nr_seq_recons_p INOUT bigint, cd_mat_recons_p INOUT material.cd_material%type, qt_dose_recons_p INOUT bigint, cd_unid_med_dose_recons_p INOUT unidade_medida.cd_unidade_medida%type, qt_solucao_recons_p INOUT bigint, ds_dose_diferenciada_rec_p INOUT text, ie_regra_diluicao_p INOUT text, ds_dose_diferenciada_p text default null, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type default null, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type DEFAULT NULL, qt_dose_dif_p bigint default 0, cd_intervalo_p text default '', ds_solucao_p INOUT text DEFAULT NULL, ie_possui_dil_p INOUT text DEFAULT NULL, ie_possui_red_p INOUT text DEFAULT NULL, ie_possui_dil_cad_mat_p INOUT text DEFAULT NULL, qt_hora_aplic_p INOUT cpoe_material.qt_hora_aplicacao%type DEFAULT NULL, qt_min_aplic_p INOUT cpoe_material.qt_min_aplicacao%type DEFAULT NULL, ie_substitui_tempo_aplic_p INOUT text DEFAULT NULL, qt_retorno_sem_ml_p INOUT bigint  DEFAULT NULL) AS $body$
DECLARE


/*
ie_opcao_p
	0 Todos
	1 Diluicao
	2 Reconstituicao
	3 Rediluente
*/
ie_gera_diluicao_w				varchar(1) := 'S';
ie_diluente_w					varchar(1) := 'N';
ie_regra_diluicao_w				varchar(1) := 'N';
ie_alterou_dose_w				varchar(1) := 'N';
ie_gerar_diluicao_w				varchar(1);
ie_dilui_vol_medic_w			varchar(1);
ie_gerar_reconstituicao_w		varchar(15);
nm_usuario_original_w			varchar(15);
cd_unidade_medida_dose_w		varchar(30);
cd_unidade_medida_w				varchar(30);
cd_unid_med_dose_mat_w			varchar(30);
cd_unid_med_cons_w				varchar(30);
ds_lista_restricao_w			varchar(255);
qt_registro_material_w			bigint;
ie_prioridade_regra_w			smallint;
qt_registro_mat_generico_w		bigint;
qt_peso_w						real;
qt_idade_w						double precision;
qt_conc_medic_w					double precision;
qt_medic_diluido_w				double precision;
qt_unitaria_medic_w				double precision;
qt_dose_medic_w					double precision;
qt_dose_medic_ml_w				double precision;
qt_conversao_ml_w				double precision;
qt_conversao_w					double precision;
qt_unitaria_w					double precision;
qt_conversao_dose_w				double precision;
qt_conversao_ml_dil_w			double precision;
qt_dose_ref_w					double precision;
qt_dose_unid_med_cons_w			double precision;
qt_dose_mat_w					double precision;
qt_conv_ml_w					double precision;
qt_diluente_w					double precision;
qt_ml_total_item_w				double precision;
qt_dose_ml_item_w				double precision;
qt_volume_medic_convertido_w	double precision;
qt_dose_diluicao_w				double precision;
qt_referencia_w					double precision;
qt_ref_diluente_aux_w			double precision;
qt_ref_ml_dil_w					double precision;
qt_dose_dil_w					double precision := 0;
qt_conversao_ml_ret_w			double precision := 0;
qt_volume_dil_w					double precision;
qt_resultado_sem_ml_w			double precision;

qt_peso_min_w					material_diluicao.qt_peso_min%type;
qt_peso_max_w					material_diluicao.qt_peso_max%type;

cd_pessoa_fisica_w				pessoa_fisica.cd_pessoa_fisica%type;
cd_estabelecimento_w			estabelecimento.cd_estabelecimento%type;
nr_seq_agrupamento_w			setor_atendimento.nr_seq_agrupamento%type;
ie_gerar_diluicao_ww			setor_atendimento.ie_gerar_diluicao%type;
cd_setor_atendimento_w			setor_atendimento.cd_setor_atendimento%type;
cd_setor_atendimento_ww			setor_atendimento.cd_setor_atendimento%type;
cd_setor_atendimento_aux_w		setor_atendimento.cd_setor_atendimento%type;
cd_material_w					material.cd_material%type;
cd_material_generico_w			material.cd_material_generico%type;
cd_diluente_w					material_diluicao.cd_diluente%type;	
cd_diluente_red_w				material_diluicao.cd_diluente%type;	
cd_material_dil_w				material_diluicao.cd_diluente%type;	
qt_solucao_red_w				material_diluicao.qt_volume%type;
cd_unid_med_dil_red_w			material_diluicao.cd_unid_med_diluente%type;
qt_diluicao_w					material_diluicao.qt_diluicao%type;	
qt_diluicao_orig_w				material_diluicao.qt_diluicao%type;	
cd_unid_med_diluente_w			material_diluicao.cd_unid_med_diluente%type;
qt_solucao_w					material_diluicao.qt_volume%type;
qt_idade_min_w					material_diluicao.qt_idade_min%type;
qt_idade_max_w					material_diluicao.qt_idade_max%type;
ie_via_aplicacao_w				material_diluicao.ie_via_aplicacao%type;
nr_seq_item_w					material_diluicao.nr_seq_interno%type;
nr_seq_prioridade_w				material_diluicao.nr_seq_prioridade%type;
nr_seq_restricao_w				material_diluicao.nr_seq_restricao%type;
ie_subtrair_volume_medic_w		material_diluicao.ie_subtrair_volume_medic%type;
ie_ConsisteDoseConsumoMedic_w	material_diluicao.ie_diluir_inteiro%type;
ie_proporcao_w					material_diluicao.ie_proporcao%type;
ie_proporcao_dil_w				material_diluicao.ie_proporcao%type;
qt_volume_medic_w				material_diluicao.qt_volume_medic%type;
qt_volume_medic_cad_w			material_diluicao.qt_volume_medic%type;
qt_ref_diluente_w				material_diluicao.qt_referencia%type;
qt_vol_adic_reconst_w			material_diluicao.qt_volume_adic%type;
ie_substitui_tempo_atual_w		material_diluicao.ie_atualizar_tempo%type;
cd_unidade_medida_consumo_w		material.cd_unidade_medida_consumo%type;
ds_dose_diferenciada_dil_w		cpoe_material.ds_dose_diferenciada_dil%type;
ds_dose_diferenciada_red_w              cpoe_material.ds_dose_diferenciada_red%type;
ds_dose_diferenciada_rec_w              cpoe_material.ds_dose_diferenciada_rec%type;
ds_dose_diferenciada_w			cpoe_material.ds_dose_diferenciada%type;
qt_hora_aplicacao_w				cpoe_material.qt_hora_aplicacao%type;
qt_minuto_aplicacao_w			cpoe_material.qt_min_aplicacao%type;
qt_dose_aux_w					cpoe_material.qt_dose%type;
ds_solucao_dil_w			varchar(255);
ds_solucao_red_w			varchar(255);
ie_param_REP_42_w			varchar(1) := 'P';
ie_param_REP_136_w			varchar(1) := 'N';
ie_possui_conv_ml_w			material_conversao_unidade.ie_permite_prescr%type;


c01 CURSOR FOR
SELECT	coalesce(cd_diluente,0),
		coalesce(qt_diluicao,0),
		coalesce(cd_unid_med_diluente, obter_unid_med_usua('ml')),
		nr_seq_interno,
		qt_volume,
		coalesce(ie_subtrair_volume_medic,'N'),
		ie_via_aplicacao,
		cd_setor_atendimento,
		qt_idade_min,
		qt_idade_max,
		qt_peso_min,
		qt_peso_max,		
		nr_seq_prioridade,
		nr_seq_restricao,
		coalesce(ie_diluir_inteiro,'N'),
		qt_referencia,
		coalesce(qt_volume_medic,null),
		ie_proporcao,
		1 prioridade_regra,
		coalesce(qt_minuto_aplicacao,0),
		ie_atualizar_tempo
from	material_diluicao
where	1 = 1
and	obter_se_regra_diluicao_setor(nr_seq_interno, cd_setor_atendimento_w) = 'S'
and	coalesce(obter_conversao_unid_med_cons(cd_material_p,cd_unidade_medida_dose_p,qt_dose_medic_w),0)
	between	coalesce(obter_conversao_unid_med_cons(cd_material_p,cd_unidade_medida,qt_dose_min),0)
	and	coalesce(obter_conversao_unid_med_cons(cd_material_p,cd_unidade_medida,qt_dose_max),9999999)
and	qt_idade_w	between obter_idade_diluicao(cd_material,nr_sequencia,'MIN') and obter_idade_diluicao(cd_material,nr_sequencia,'MAX')
and	qt_peso_w	between coalesce(qt_peso_min,0) and coalesce(qt_peso_max,999999)
and	((cd_setor_excluir <> cd_setor_atendimento_w)	or (coalesce(cd_setor_excluir::text, '') = ''))
and	((ie_via_excluir <> ie_via_aplicacao_p)	or (coalesce(ie_via_excluir::text, '') = ''))
and	((obter_se_contido(nr_seq_restricao, ds_lista_restricao_w) = 'S')	or (coalesce(nr_seq_restricao::text, '') = ''))
and	((nr_seq_agrupamento	= nr_seq_agrupamento_w)	or (coalesce(nr_seq_agrupamento::text, '') = ''))
and	((cd_setor_atendimento	= cd_setor_atendimento_w)	or (coalesce(cd_setor_atendimento::text, '') = ''))
and	((ie_via_aplicacao	= ie_via_aplicacao_p)	or (coalesce(ie_via_aplicacao::text, '') = ''))
and	((cd_unidade_medida	= cd_unidade_medida_dose_p)	or (coalesce(cd_unidade_medida::text, '') = ''))
and	coalesce(cd_perfil,coalesce(obter_perfil_ativo,0))	= coalesce(obter_perfil_ativo,0)
and	cd_material	= cd_material_p
and		((cd_estabelecimento = cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
and	obter_se_material_ativo(cd_diluente)	= 'A'
and	ie_reconstituicao	= 'N'
and	((ie_opcao_p = 1)	or (ie_opcao_p = 0))
and	ie_gera_diluicao_w	= 'S'

union

SELECT	coalesce(cd_diluente,0),
		coalesce(qt_diluicao,0),
		coalesce(cd_unid_med_diluente,obter_unid_med_usua('ml')),
		nr_seq_interno,
		qt_volume,
		ie_subtrair_volume_medic,
		ie_via_aplicacao, 
		cd_setor_atendimento,
		qt_idade_min,
		qt_idade_max,
		qt_peso_min,
		qt_peso_max,
		nr_seq_prioridade,
		nr_seq_restricao,
		coalesce(ie_diluir_inteiro,'N'),
		qt_referencia,
		coalesce(qt_volume_medic,0),
		ie_proporcao,
		2 prioridade_regra,
		coalesce(qt_minuto_aplicacao,0),
		ie_atualizar_tempo
from	material_diluicao
where	1 = 1
and	coalesce(obter_conversao_unid_med_cons(cd_material_p,cd_unidade_medida_dose_p,qt_dose_medic_w),0)
	between coalesce(obter_conversao_unid_med_cons(cd_material_p,cd_unidade_medida,qt_dose_min),0)
	and	coalesce(obter_conversao_unid_med_cons(cd_material_p,cd_unidade_medida,qt_dose_max),9999999)
and	obter_se_regra_diluicao_setor(nr_seq_interno, cd_setor_atendimento_w) = 'S'
and	((obter_se_contido(nr_seq_restricao, ds_lista_restricao_w) = 'S') or (coalesce(nr_seq_restricao::text, '') = ''))
and	qt_idade_w	between obter_idade_diluicao(cd_material,nr_sequencia,'MIN') and obter_idade_diluicao(cd_material,nr_sequencia,'MAX')
and	qt_peso_w	between coalesce(qt_peso_min,0)	and coalesce(qt_peso_max,999999)
and	((ie_via_excluir <> ie_via_aplicacao_p)	or (coalesce(ie_via_excluir::text, '') = ''))
and	((cd_setor_excluir <> cd_setor_atendimento_w)	or (coalesce(cd_setor_excluir::text, '') = ''))
and	((cd_setor_atendimento = cd_setor_atendimento_W)	or (coalesce(cd_setor_atendimento::text, '') = ''))
and	((nr_seq_agrupamento = nr_seq_agrupamento_w)	or (coalesce(nr_seq_agrupamento::text, '') = ''))
and	((ie_via_aplicacao	= ie_via_aplicacao_p)	or (coalesce(ie_via_aplicacao::text, '') = ''))
and	((cd_unidade_medida	= cd_unidade_medida_dose_p)	or (coalesce(cd_unidade_medida::text, '') = ''))
and	coalesce(cd_perfil,coalesce(obter_perfil_ativo,0))	= coalesce(obter_perfil_ativo,0)
and	cd_material	= cd_material_generico_w
and		((cd_estabelecimento = cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
and	((ie_opcao_p = 1)	or (ie_opcao_p = 0))
and	obter_se_material_ativo(cd_diluente)	= 'A'
and	ie_reconstituicao	= 'N'
and	ie_gera_diluicao_w	= 'S'
order by   prioridade_regra desc,
		ie_via_aplicacao desc,
		qt_idade_min desc,
		qt_idade_max desc, 
		qt_peso_min desc,
		qt_idade_max desc,   
		cd_setor_atendimento desc,
		nr_seq_prioridade desc,
		nr_seq_restricao desc;
		
C02 CURSOR FOR
SELECT	coalesce(cd_diluente,0),
		coalesce(qt_diluicao,0),
		coalesce(cd_unid_med_diluente, obter_unid_med_usua('ml')),
		qt_volume,
		nr_seq_interno,
		ie_via_aplicacao,
		qt_idade_min,
		qt_idade_max,
		qt_peso_min,
		qt_peso_max,
		nr_seq_prioridade,
		nr_seq_restricao
from	material_diluicao
where	coalesce(obter_conversao_unid_med_cons(cd_material_p,cd_unidade_medida_dose_p, qt_dose_medic_w ),0) 
	between	coalesce(obter_conversao_unid_med_cons(cd_material_p,cd_unidade_medida,qt_dose_min),0)
and	coalesce(obter_conversao_unid_med_cons(cd_material_p,cd_unidade_medida,qt_dose_max),9999999)
and	obter_se_regra_diluicao_setor(nr_seq_interno, cd_setor_atendimento_w) = 'S'
and	((obter_se_contido(nr_seq_restricao, ds_lista_restricao_w) = 'S') or (coalesce(nr_seq_restricao::text, '') = ''))
and	qt_idade_w between obter_idade_diluicao(cd_material,nr_sequencia,'MIN') and obter_idade_diluicao(cd_material,nr_sequencia,'MAX')
and	qt_peso_w  between coalesce(qt_peso_min,0) and coalesce(qt_peso_max,999999)
and	((cd_setor_excluir <> cd_setor_atendimento_w) or (coalesce(cd_setor_excluir::text, '') = ''))
and	((ie_via_excluir <> ie_via_aplicacao_p) or (coalesce(ie_via_excluir::text, '') = ''))
and	((cd_setor_atendimento = cd_setor_atendimento_W) or (coalesce(cd_setor_atendimento::text, '') = ''))
and	((nr_seq_agrupamento = nr_seq_agrupamento_w) or (coalesce(nr_seq_agrupamento::text, '') = ''))
and	((ie_via_aplicacao = ie_via_aplicacao_p) or (coalesce(ie_via_aplicacao::text, '') = ''))
and	((cd_unidade_medida	= cd_unidade_medida_dose_p) or (coalesce(cd_unidade_medida::text, '') = ''))
and	coalesce(cd_perfil,coalesce(obter_perfil_ativo,0)) = coalesce(obter_perfil_ativo,0)
and		((cd_estabelecimento = cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
and	obter_se_material_ativo(cd_diluente) = 'A'
and	ie_reconstituicao 	= 'S'
and	cd_material		= cd_material_p
and	((ie_opcao_p = 2) or (ie_opcao_p = 0))
and	ie_gerar_reconstituicao_w	= 'S'
order by	ie_via_aplicacao desc, 
		qt_idade_min desc,
		qt_idade_max desc, 
		qt_peso_min desc,
		qt_idade_max desc, 
		cd_setor_atendimento desc,
		nr_seq_prioridade desc,
		nr_seq_restricao desc;
			
C05 CURSOR FOR
SELECT	coalesce(cd_diluente,0),
		coalesce(qt_diluicao,0),
		coalesce(cd_unid_med_diluente, obter_unid_med_usua('ml')),
		qt_volume,
		nr_seq_interno,
		ie_via_aplicacao,
		qt_idade_min,
		qt_idade_max,
		qt_peso_min,
		qt_peso_max,
		nr_seq_prioridade,
		nr_seq_restricao
from	material_diluicao
where	coalesce(obter_conversao_unid_med_cons(cd_material_p,cd_unidade_medida_dose_p,qt_dose_medic_w),0)
	between	coalesce(obter_conversao_unid_med_cons(cd_material_p,cd_unidade_medida,qt_dose_min),0)
and	coalesce(obter_conversao_unid_med_cons(cd_material_p,cd_unidade_medida,qt_dose_max),9999999)
and	obter_se_regra_diluicao_setor(nr_seq_interno, cd_setor_atendimento_w) = 'S'
and	qt_idade_w between obter_idade_diluicao(cd_material,nr_sequencia,'MIN') and obter_idade_diluicao(cd_material,nr_sequencia,'MAX')
and	qt_peso_w between coalesce(qt_peso_min,0) and coalesce(qt_peso_max,999999)
and	((obter_se_contido(nr_seq_restricao, ds_lista_restricao_w) = 'S') or (coalesce(nr_seq_restricao::text, '') = ''))
and	((ie_via_excluir <> ie_via_aplicacao_p) or (coalesce(ie_via_excluir::text, '') = ''))
and	((cd_setor_excluir <> cd_setor_atendimento_w) or (coalesce(cd_setor_excluir::text, '') = ''))
and	((cd_setor_atendimento = cd_setor_atendimento_W) or (coalesce(cd_setor_atendimento::text, '') = ''))
and	((nr_seq_agrupamento = nr_seq_agrupamento_w) or (coalesce(nr_seq_agrupamento::text, '') = ''))
and	((ie_via_aplicacao	= ie_via_aplicacao_p) or (coalesce(ie_via_aplicacao::text, '') = ''))
and	((cd_unidade_medida	= cd_unidade_medida_dose_p) or (coalesce(cd_unidade_medida::text, '') = ''))
and	coalesce(cd_perfil,coalesce(obter_perfil_ativo,0)) = coalesce(obter_perfil_ativo,0)
and		((cd_estabelecimento = cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
and	obter_se_material_ativo(cd_diluente) = 'A'
and	ie_reconstituicao = 'S'
and	cd_material = cd_material_generico_w
and	((ie_opcao_p = 2) or (ie_opcao_p = 0))
and	ie_gerar_reconstituicao_w = 'S'
order by	ie_via_aplicacao desc, 
		qt_idade_min desc,
		qt_idade_max desc, 
		qt_peso_min desc,
		qt_idade_max desc,
		cd_setor_atendimento desc,
		nr_seq_prioridade desc,
		nr_seq_restricao desc;
			
C03 CURSOR FOR
SELECT	nr_seq_restricao
from	paciente_rep_prescricao a
where	1 = 1
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	coalesce(dt_inativacao::text, '') = ''
and	((coalesce(a.dt_fim::text, '') = '') or (clock_timestamp() between coalesce(a.dt_inicio,clock_timestamp() - interval '1 days') and a.dt_fim + 86399/86400))
and	cd_pessoa_fisica = cd_pessoa_fisica_w;
	
c04 CURSOR FOR
SELECT	coalesce(cd_diluente,0),
		coalesce(qt_diluicao,0),
		coalesce(cd_unid_med_diluente, obter_unid_med_usua('ml')),
		qt_volume,
		nr_seq_interno,
		coalesce(qt_volume_adic,0),
		qt_referencia,
		coalesce(ie_proporcao, 'F' )
from	material_diluicao
where	1 = 1
and	qt_idade_w	between obter_idade_diluicao(cd_material,nr_sequencia,'MIN') and obter_idade_diluicao(cd_material,nr_sequencia,'MAX')
and	qt_peso_w	between coalesce(qt_peso_min,0)	and coalesce(qt_peso_max,999)
and	((ie_via_excluir <> ie_via_aplicacao_p)	or (coalesce(ie_via_excluir::text, '') = ''))
and	((nr_seq_agrupamento = nr_seq_agrupamento_w)	or (coalesce(nr_seq_agrupamento::text, '') = ''))
and	((ie_via_aplicacao = ie_via_aplicacao_p)	or (coalesce(ie_via_aplicacao::text, '') = ''))
and	coalesce(cd_perfil,coalesce(obter_perfil_ativo,0))	= coalesce(obter_perfil_ativo,0)
and		((cd_estabelecimento = cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
and	obter_se_material_ativo(cd_diluente)	= 'A'
and	(qt_volume IS NOT NULL AND qt_volume::text <> '')
and	((ie_opcao_p = 3)	or (ie_opcao_p = 0))
and	ie_reconstituicao	= 'R'
and	ie_gerar_rediluente	= 'S'
and	cd_material	= cd_material_p;

BEGIN
ie_possui_dil_cad_mat_p		:= 'N';
cd_material_w               := cd_material_p;
ie_via_aplicacao_w          := ie_via_aplicacao_p;
ie_gerar_diluicao_w         := 'S';
qt_dose_medic_w             := qt_dose_medic_p;
ds_dose_diferenciada_w		:= ds_dose_diferenciada_p;
if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then
	ds_dose_diferenciada_w	:= replace(ds_dose_diferenciada_w || '-',' ','');
	qt_dose_medic_w			:= 0;
  	
	for i in 1.. qt_dose_dif_p loop
		begin
		qt_dose_medic_w			:= qt_dose_medic_w + (coalesce(substr(ds_dose_diferenciada_w,1,position('-' in ds_dose_diferenciada_w)-1),'0'))::numeric;
		ds_dose_diferenciada_w	:= substr(ds_dose_diferenciada_w,position('-' in ds_dose_diferenciada_w)+1);
		end;
	end loop;
end if;

cd_unidade_medida_dose_w    := cd_unidade_medida_dose_p;
nm_usuario_original_w	    := nm_usuario_p;
ie_alterou_dose_w	    := ie_alterou_dose_p;

select	coalesce(max(qt_conversao),1)
into STRICT	qt_conversao_w
from	material_conversao_unidade
where	1 = 1
and		cd_unidade_medida = cd_unidade_medida_dose_w
and		cd_material = cd_material_w;

qt_unitaria_medic_w := dividir_sem_round(qt_dose_medic_w, qt_conversao_w);

cd_pessoa_fisica_w		:= cd_pessoa_fisica_p;	
qt_peso_w			:= coalesce(obter_ultimo_sinal_vital_pf(cd_pessoa_fisica_w,'PESO'),coalesce(obter_peso_pf(cd_pessoa_fisica_w),0));

if (coalesce(nr_atendimento_p::text, '') = '') then
	
	qt_idade_w				:= obter_idade_pf(cd_pessoa_fisica_w, clock_timestamp(), 'DIA');	
	cd_setor_atendimento_w	:= null;
	cd_estabelecimento_w	:= cd_estabelecimento_p;
else
	select	max(obter_setor_atendimento(c.nr_atendimento)),
			max(c.cd_estabelecimento),
			max(substr(obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'DIA'),1,5)),
			max(b.cd_pessoa_fisica)
	into STRICT	cd_setor_atendimento_ww,
			cd_estabelecimento_w,
			qt_idade_w,
			cd_pessoa_fisica_w
	from	pessoa_fisica b,
			atendimento_paciente c
	where	c.cd_pessoa_fisica	= b.cd_pessoa_fisica
	and		c.nr_atendimento = nr_atendimento_p;

	ie_param_REP_42_w := obter_param_usuario(924, 42, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_param_REP_42_w);
	ie_param_REP_136_w := obter_param_usuario(924, 136, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_param_REP_136_w);
    cd_setor_atendimento_w := cpoe_obter_setor_prescricao(ie_param_REP_42_w, ie_param_REP_136_w, wheb_usuario_pck.get_cd_setor_atendimento, nr_atendimento_p, obter_perfil_ativo, nm_usuario_p, cd_setor_atendimento_w);

	if (coalesce(cd_setor_atendimento_w::text, '') = '') then
		cd_setor_atendimento_w := cd_setor_atendimento_ww;
	end if;
end if;

select	coalesce(max(ie_gerar_diluicao),'S'),
		coalesce(max(ie_gerar_reconstituicao),'S'),
		max(nr_seq_agrupamento)
into STRICT	ie_gerar_diluicao_ww,
		ie_gerar_reconstituicao_w,
		nr_seq_agrupamento_w
from	setor_atendimento
where	cd_setor_atendimento	= cd_setor_atendimento_w;

if	((nr_atendimento_p > 0) or (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')) and (cd_material_p > 0) and
	((ie_gerar_diluicao_ww = 'S') or (ie_gerar_reconstituicao_w = 'S')) then
	
	open c03;
	loop
	fetch c03 into	
		nr_seq_restricao_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		ds_lista_restricao_w	:= nr_seq_restricao_w  || ',' || ds_lista_restricao_w;
	end loop;
	close c03;	
		
	select	coalesce(max(cd_material_generico),cd_material_w)
	into STRICT	cd_material_generico_w
	from	material
	where	cd_material	= cd_material_w;
	
		if (ie_opcao_p = 2) or
		(ie_opcao_p = 0 AND ie_gerar_reconstituicao_w = 'S') then /* Inserir o reconstituinte */
		begin
		
		--Verificar se possui cadastro material prescrito
		select	coalesce(max(cd_diluente),0)
		into STRICT	qt_registro_material_w
		from	material_diluicao
		where	cd_material  = cd_material_w
		and		((cd_estabelecimento = cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
		and 	ie_reconstituicao = 'S';
		
		if ( qt_registro_material_w > 0) then
		
			open C02;
			loop
			fetch c02 into
				cd_diluente_w,
				qt_diluicao_w,
				cd_unid_med_diluente_w,
				qt_solucao_w,
				nr_seq_item_w,
				ie_via_aplicacao_w,
				qt_idade_min_w,
				qt_idade_max_w,
				qt_peso_min_w,
				qt_peso_max_w,
				nr_seq_prioridade_w,
				nr_seq_restricao_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				ie_diluente_w	:= 'S';				
			end loop;	
			close C02;
		else
			--Verificar se possui cadastro generico
			select	coalesce(max(cd_diluente),0)
			into STRICT	qt_registro_mat_generico_w
			from	material_diluicao
			where	cd_material  = cd_material_generico_w
			and		((cd_estabelecimento = cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
			and 	ie_reconstituicao = 'S';
					
			if ( qt_registro_mat_generico_w > 0 ) then
				
				open C05;
				loop
				fetch c05 into
					cd_diluente_w,
					qt_diluicao_w,
					cd_unid_med_diluente_w,
					qt_solucao_w,
					nr_seq_item_w,
					ie_via_aplicacao_w,
					qt_idade_min_w,
					qt_idade_max_w,
					qt_peso_min_w,
					qt_peso_max_w,
					nr_seq_prioridade_w,
					nr_seq_restricao_w;
				EXIT WHEN NOT FOUND; /* apply on C05 */
					ie_diluente_w	:= 'S';
					
				end loop;
				close C05;
			
			end if;				
		end if;
			
		if (ie_diluente_w = 'S') and (coalesce(cd_diluente_w,0) > 0) then
			
			
			select	max(substr(obter_dados_material_estab(cd_material,cd_estabelecimento_w,'UMS'),1,30))
			into STRICT	cd_unidade_medida_w
			from	material
			where	cd_material	= cd_diluente_w;			
			
			nr_seq_recons_p				:= nr_seq_item_w;
			cd_mat_recons_p				:= cd_diluente_w;
			qt_dose_recons_p			:= qt_diluicao_w;
			cd_unid_med_dose_recons_p	:= cd_unid_med_diluente_w;
			qt_solucao_recons_p			:= qt_solucao_w;
				
		end if;
		end;
	end if;

		
	if (ie_opcao_p = 1) or (ie_opcao_p = 0) then /* Inserir o Diluente */
		begin
		
			if (ie_gerar_diluicao_ww = 'S') then
							
				ie_regra_diluicao_p := cpoe_obter_padrao_param_prescr(nr_atendimento_p, cd_material_p, ie_via_aplicacao_p, 'N', 'L',cd_intervalo_p, cd_estabelecimento_p, obter_perfil_ativo, nm_usuario_p, cd_pessoa_fisica_p);
				
				ie_diluente_w		:= 'N';				

				if (ie_via_aplicacao_p IS NOT NULL AND ie_via_aplicacao_p::text <> '') then
					select	max(ie_gera_diluicao)
					into STRICT	ie_gera_diluicao_w
					from	via_aplicacao
					where	ie_via_aplicacao = ie_via_aplicacao_p;
				end if;					
				
				open C01;
				loop
				fetch C01 into
					cd_material_dil_w,
					qt_diluente_w,
					cd_unid_med_diluente_w,
					nr_seq_item_w,
					qt_solucao_w,
					ie_subtrair_volume_medic_w,
					ie_via_aplicacao_w,
					cd_setor_atendimento_aux_w,
					qt_idade_min_w,
					qt_idade_max_w,
					qt_peso_min_w,
					qt_peso_max_w,
					nr_seq_prioridade_w,
					nr_seq_restricao_w,
					ie_ConsisteDoseConsumoMedic_w,
					qt_ref_diluente_w,
					qt_volume_medic_w,
					ie_proporcao_dil_w,
					ie_prioridade_regra_w,
					qt_minuto_aplicacao_w,
					ie_substitui_tempo_atual_w;
				EXIT WHEN NOT FOUND; /* apply on C01 */
					ie_diluente_w	:= 'S';
				end loop;	
				close C01;
				
				if (ie_diluente_w = 'N') then

					select 	coalesce(max('S'),'N')
					into STRICT	ie_possui_dil_p
					from 	material_diluicao
					where	coalesce(cd_perfil,coalesce(obter_perfil_ativo,0)) = coalesce(obter_perfil_ativo,0)
					and		((cd_estabelecimento = cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
					and		ie_reconstituicao	= 'N';
				else
					ie_possui_dil_p := 'X';
				end if;
				
				if (ie_diluente_w = 'S') and (coalesce(cd_material_dil_w,0) > 0) then		
					
					qt_volume_medic_cad_w := qt_volume_medic_w;
					qt_diluicao_orig_w 	  := qt_diluente_w;
					ie_dilui_vol_medic_w  := 'N';
				
					if (ie_proporcao_dil_w = 'F') then
						
						if (ie_ConsisteDoseConsumoMedic_w = 'S') then
							qt_dose_mat_w		 := obter_dose_convertida(cd_material_p, ceil(qt_unitaria_medic_w), coalesce(cd_unidade_medida_w, obter_unid_med_usua('ML')), cd_unidade_medida_dose_w);

 							qt_conv_ml_w 		 := obter_conversao_ml(cd_material_p, qt_dose_mat_w, cd_unidade_medida_dose_w);		
							
							qt_conc_medic_w 	 := obter_dose_convertida(cd_material_w, qt_conv_ml_w, obter_unid_med_usua('ML'), cd_unidade_medida_dose_w);							
							
							ie_dilui_vol_medic_w := 'S';
							
							qt_medic_diluido_w   := qt_diluicao_orig_w + qt_conv_ml_w;
							qt_volume_medic_w  	 := qt_conv_ml_w;
							
						elsif (ie_ConsisteDoseConsumoMedic_w = 'N') and (coalesce(qt_volume_medic_w,0)	> 0) then
								
								qt_diluicao_w		:= obter_conversao_unid_med_cons(cd_material_w,obter_unid_med_usua('ML'),qt_volume_medic_w);
								qt_conc_medic_w 	 := obter_dose_convertida(cd_material_p, qt_volume_medic_w, obter_unid_med_usua('ml'), cd_unidade_medida_dose_w);						
								
								ie_dilui_vol_medic_w := 'S';
								qt_medic_diluido_w 	 := qt_volume_medic_w + qt_diluicao_orig_w;															
							
						end if;
					end if;
			
					
					if (coalesce(ie_alterou_dose_w,'N') = 'S' ) and ( cd_unidade_medida_dose_w <> obter_unid_med_usua('ml')) then
						qt_dose_ml_item_w	:= coalesce(cpoe_obter_conversao_ml(cd_material_w, qt_dose_medic_w, cd_unidade_medida_dose_w, ie_via_aplicacao_p, cd_pessoa_fisica_p, nr_atendimento_p),0);
					end if;
					
					if ( ie_proporcao_dil_w = 'F' ) then
						qt_diluente_w	:= coalesce(obter_conversao_ml(cd_material_dil_w, qt_diluente_w, cd_unid_med_diluente_w),0);
						
					elsif (ie_proporcao_dil_w = 'SC' ) or (ie_proporcao_dil_w = 'ST' ) and (coalesce(qt_ref_diluente_w,0) > 0) then

						    qt_ref_diluente_aux_w := qt_ref_diluente_w;
							qt_dose_medic_ml_w	  := qt_dose_medic_w;
							
							--20
                            qt_dose_ml_item_w	:= coalesce(cpoe_obter_conversao_ml(cd_material_w, qt_dose_medic_ml_w, cd_unidade_medida_dose_w, ie_via_aplicacao_p, cd_pessoa_fisica_p, nr_atendimento_p),0);
														
							--Converte a quantidade de referencia para ml
							if (upper(cd_unid_med_diluente_w) <> upper(obter_unid_med_usua('ml'))) then
								qt_ref_ml_dil_w	:= coalesce(obter_conversao_ml(cd_material_dil_w, qt_ref_diluente_aux_w, cd_unid_med_diluente_w),0);
							else
								qt_ref_ml_dil_w := qt_ref_diluente_aux_w;
							end if;
							
							/*regra de 3 - pegar o % que a dose do medicamento representa em relacao a dose total somada com o diluente*/
							
							qt_ml_total_item_w := (qt_unitaria_medic_w * qt_ref_ml_dil_w);

							if	(( qt_ml_total_item_w - qt_dose_ml_item_w) > 0) and (coalesce(ie_subtrair_volume_medic_w,'N') = 'S') then
								qt_diluente_w := qt_ml_total_item_w - qt_dose_ml_item_w;	
							elsif	(( qt_ml_total_item_w - qt_dose_ml_item_w) > 0) then
								qt_diluente_w := qt_ml_total_item_w;
							else
								if (ie_proporcao_dil_w = 'SC') then
									if (ie_ConsisteDoseConsumoMedic_w = 'S') then
										qt_diluente_w	:= ceil(qt_dose_medic_ml_w) * qt_ref_ml_dil_w;
									else
										qt_diluente_w	:= qt_dose_medic_ml_w * qt_ref_ml_dil_w;
									end if;
								elsif (ie_proporcao_dil_w = 'ST') then
									if (ie_ConsisteDoseConsumoMedic_w = 'S') then
										qt_diluente_w		:= ceil(qt_dose_medic_ml_w) * qt_ref_ml_dil_w;
									else
										qt_diluente_w		:= qt_dose_medic_ml_w * qt_ref_ml_dil_w;
									end if;
									
									qt_dose_aux_w			:= obter_conversao_unid_med_cons(cd_material_w, cd_unidade_medida_dose_w, qt_dose_medic_w);
									qt_minuto_aplicacao_w	:= trunc(qt_minuto_aplicacao_w * qt_dose_aux_w);
								end if;
							end if;
					end if;
					
					if (qt_minuto_aplicacao_w > 0) then
						if (qt_minuto_aplicacao_w < 60) then
							qt_hora_aplicacao_w	:= null;
						elsif (qt_minuto_aplicacao_w = 60) then
							qt_hora_aplicacao_w	:= 1;
							qt_minuto_aplicacao_w := null;
						else
							qt_hora_aplicacao_w	:= trunc(dividir(qt_minuto_aplicacao_w,60));
							qt_minuto_aplicacao_w := (qt_minuto_aplicacao_w - (qt_hora_aplicacao_w * 60));
						end if;
					end if;

					if (qt_minuto_aplicacao_w = 0) then
						qt_minuto_aplicacao_w := null;
					end if;

					qt_min_aplic_p := qt_minuto_aplicacao_w;
					qt_hora_aplic_p := qt_hora_aplicacao_w;

					if	((coalesce(ie_substitui_tempo_atual_w,'N') = 'S') and (ie_proporcao_dil_w <> 'ST')) or
						((coalesce(qt_referencia_w,0) > 0) and (ie_proporcao_dil_w = 'ST')) then
						ie_substitui_tempo_aplic_p := 'S';
					else
						ie_substitui_tempo_aplic_p := 'N';
					end if;
					
					nr_seq_dil_p		:= nr_seq_item_w;
					cd_mat_dil_p		:= cd_material_dil_w;
					--qt_dose_dil_p		:= qt_diluicao_w ;  Calculo da dose esta no final da rotina
					cd_unid_med_dose_dil_p	:= obter_unid_med_usua('ml');  	--Definido que ira trazer fixo esta informacao.
					qt_solucao_dil_p	:= qt_solucao_w;
					ie_possui_dil_cad_mat_p := 'S';
				end if;
			end if;
		end;	
	end if;
	
	if (ie_opcao_p = 3) or (ie_opcao_p = 0)  then
		begin
			/* inserir o rediluente*/
	
			if (ie_gerar_diluicao_ww = 'S') then
				ie_diluente_w	:= 'N';
			
				open C04;
				loop
				fetch C04 into
					cd_diluente_red_w,
					qt_diluicao_w,
					cd_unid_med_diluente_w,
					qt_solucao_w,
					nr_seq_item_w,
					qt_vol_adic_reconst_w,
					qt_referencia_w,
					ie_proporcao_w;
				EXIT WHEN NOT FOUND; /* apply on C04 */
					ie_diluente_w	:= 'S';
				end loop;	
				close C04;
				
				if (ie_diluente_w = 'N') then
				
					select 	coalesce(max('S'),'N')
					into STRICT	ie_possui_red_p
					from 	material_diluicao
					where	coalesce(cd_perfil,coalesce(obter_perfil_ativo,0))	= coalesce(obter_perfil_ativo,0)
					and		((cd_estabelecimento = cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
					and		ie_reconstituicao	= 'R';
				else
					ie_possui_red_p := 'X';
				end if;
				
				if (ie_diluente_w = 'S')  and (coalesce(cd_diluente_red_w,0) > 0) then	

					if (ie_subtrair_volume_medic_w = 'S') and (qt_volume_medic_w > 0) then
						qt_medic_diluido_w		:= qt_medic_diluido_w - qt_volume_medic_w;
					end if;
					
					if (coalesce(qt_conc_medic_w,0) > 0) then
						qt_conv_ml_w		:= qt_medic_diluido_w;
						qt_solucao_w 		:= dividir_sem_round(qt_dose_medic_w, dividir_sem_round(qt_conc_medic_w,qt_conv_ml_w));
					end if;
					
					qt_dose_diluicao_w	:= qt_diluicao_w;
					
					if (coalesce(qt_referencia_w,0) > 0) and (coalesce(ie_dilui_vol_medic_w,'N') = 'N')then
						qt_referencia_w	:= obter_conversao_unid_med_cons(cd_diluente_red_w,cd_unid_med_diluente_w,qt_referencia_w);
					end if;					

					if (coalesce(qt_referencia_w,0) > 0) then
						
						if (ie_proporcao_w = 'SC') then
							qt_diluicao_w	:= qt_unitaria_medic_w * qt_referencia_w;						
							
							if (coalesce(ie_dilui_vol_medic_w,'N') = 'S') then
								
								if (qt_conc_medic_w > 0) and (qt_medic_diluido_w > 0) then
									qt_solucao_w 		:= dividir_sem_round(qt_dose_medic_w, dividir_sem_round(qt_conc_medic_w, qt_medic_diluido_w));
									qt_dose_diluicao_w	:= qt_diluicao_w - qt_solucao_w;
									qt_referencia_w		:= obter_conversao_unid_med_cons(cd_diluente_red_w,cd_unid_med_diluente_w,qt_referencia_w);
									qt_diluicao_w	:= qt_unitaria_medic_w * qt_referencia_w;						
								end if;
							end if;	
						elsif (ie_proporcao_w = 'ST') then
							qt_diluicao_w		:= qt_unitaria_medic_w * qt_referencia_w;
							--qt_minuto_aplicacao_w	:= qt_minuto_aplicacao_w * qt_referencia_w;
						end if;						
					end if;						
					
					qt_solucao_red_w		:= qt_solucao_w;
					cd_unid_med_dil_red_w 	:= cd_unid_med_diluente_w;							
					nr_seq_red_p			:= nr_seq_item_w;
					
					cd_mat_red_p			:= cd_diluente_red_w;
					qt_dose_red_p			:= qt_dose_diluicao_w;
					cd_unid_med_dose_red_p	:= cd_unid_med_diluente_w;
					qt_solucao_red_p		:= qt_solucao_w;
					
				end if;
			end if;
		end;		
	end if;

	select	max(cd_unidade_medida_consumo)
	into STRICT	cd_unidade_medida_consumo_w
	from	material
	where	cd_material = cd_material_w;

	--Deve se aplicar somente para a regra de diluicao Fixa.
	if ( ie_subtrair_volume_medic_w = 'S') and ( ie_proporcao_dil_w = 'F')	then
				
		qt_dose_ref_w 		:= obter_dose_convertida(cd_material_w,qt_dose_medic_w, cd_unidade_medida_dose_w, cd_unidade_medida_consumo_w);
		qt_conv_ml_w 		:= obter_conversao_ml(cd_diluente_red_w, qt_solucao_red_w, cd_unid_med_dil_red_w) + qt_vol_adic_reconst_w;
		qt_conversao_ml_w := 0;
		
		if ( ie_consistedoseconsumomedic_w = 'N') then
			
			if (qt_volume_medic_w IS NOT NULL AND qt_volume_medic_w::text <> '') and (qt_volume_medic_w > 0) then
				qt_conversao_ml_w := qt_volume_medic_w;
			else
				qt_conversao_ml_w := obter_conversao_ml(cd_material_w,qt_dose_medic_w,cd_unidade_medida_dose_w);
			end if;

			cd_unid_med_dose_mat_w  := cd_unidade_medida_dose_w;
			qt_dose_mat_w			:= qt_dose_medic_w;
		else
			qt_conversao_ml_w 		:= obter_conversao_ml(cd_material_p,qt_dose_medic_w, cd_unidade_medida_dose_w);
			cd_unid_med_dose_mat_w 	:= substr(obter_dados_material_estab(cd_material_p, cd_estabelecimento_w ,'UMS'),1,30);	
			qt_dose_mat_w			:= ceil(qt_unitaria_medic_w);
		end if;

		if (cd_mat_recons_p IS NOT NULL AND cd_mat_recons_p::text <> '') and (qt_dose_recons_p IS NOT NULL AND qt_dose_recons_p::text <> '') and (cd_unid_med_dose_recons_p IS NOT NULL AND cd_unid_med_dose_recons_p::text <> '') then

			if (upper(cd_unid_med_dose_mat_w) <> upper(obter_unid_med_usua('ml'))) then												
				qt_conv_ml_w := coalesce(cpoe_obter_conversao_ml(cd_material_w, qt_dose_medic_w, cd_unidade_medida_dose_w, ie_via_aplicacao_p, cd_pessoa_fisica_p, nr_atendimento_p),0);
			else
				qt_conv_ml_w			:= qt_conversao_ml_w;
			end if;
		else
			qt_conv_ml_w := qt_conversao_ml_w;
		end if;
		
		qt_conversao_ml_ret_w := qt_conv_ml_w;

		select	coalesce(obter_dose_convertida(cd_diluente_w, CASE WHEN coalesce(ie_proporcao_dil_w,'F')='F' THEN  qt_diluente_w  ELSE qt_dose_ref_w * qt_ref_diluente_w END ,cd_unidade_medida_dose_w, cd_unidade_medida_dose_w),0)
		into STRICT	qt_volume_medic_convertido_w
		;

		select	coalesce(obter_conversao_ml(cd_material_dil_w, CASE WHEN coalesce(qt_volume_medic_convertido_w,0)=0 THEN qt_diluente_w  ELSE qt_volume_medic_convertido_w END , upper(obter_unid_med_usua('ml'))),0)
		into STRICT	qt_conversao_ml_dil_w
		;

		if (coalesce(ie_alterou_dose_w,'N') = 'S') and (qt_dose_ml_item_w > 0 )then			
			qt_conversao_ml_ret_w := qt_dose_ml_item_w;
		end if;
		
		if	((qt_conversao_ml_dil_w - qt_conversao_ml_ret_w) > 0) then							
			qt_dose_dil_w	:= qt_conversao_ml_dil_w - qt_conversao_ml_ret_w;
		end if;	
	end if;

	if (qt_dose_dil_w IS NOT NULL AND qt_dose_dil_w::text <> '') and ( qt_dose_dil_w > 0) then
		qt_dose_dil_p	:= qt_dose_dil_w;
	else
		qt_dose_dil_p	:= qt_diluente_w;
	end if;

	select	coalesce(max('S'),'N')
	into STRICT	ie_possui_conv_ml_w
	from	material_conversao_unidade
	where	cd_material = cd_material_w
	and		cd_unidade_medida = obter_unid_med_usua('ml');

	if (ie_possui_conv_ml_w = 'N' and cd_unidade_medida_dose_w <> cd_unidade_medida_consumo_w and coalesce(qt_volume_medic_cad_w, 0) > 0) then
		qt_volume_dil_w := qt_dose_dil_p / qt_volume_medic_cad_w;
		qt_resultado_sem_ml_w := dividir_sem_round(qt_conversao_w, qt_volume_dil_w);
		qt_retorno_sem_ml_p := dividir_sem_round(qt_dose_medic_w, qt_resultado_sem_ml_w);
	end if;

	cd_unid_med_dose_dil_p	:= obter_unid_med_usua('ml');  	--Definido que ira trazer fixo esta informacao.
	
	
	if (ie_alterou_dose_p = 'S') then
		if (ie_possui_dil_p = 'S' or ie_possui_dil_p = 'X') then
		    ds_solucao_p := ds_solucao_dil_w;
		end if;
		
		if ((ie_possui_red_p = 'S' or ie_possui_red_p = 'X') AND ie_possui_dil_p = 'N') then
		    ds_solucao_p := ds_solucao_red_w;
		elsif (ie_possui_red_p = 'S' or ie_possui_red_p = 'X') then
		    ds_solucao_p := ds_solucao_p || chr(13) || chr(10) || ds_solucao_red_w;
		end if;
	end if;
	
	if (qt_dose_dif_p > 0) then
		begin
		for i in 1.. qt_dose_dif_p loop
			begin
			if (coalesce(qt_dose_dil_p,0) > 0) then
				if (i = 1) then
					ds_dose_diferenciada_dil_w := ds_dose_diferenciada_dil_w || qt_dose_dil_p || '-';
				else
					ds_dose_diferenciada_dil_w := ds_dose_diferenciada_dil_w || '...' || '-';
				end if;
			end if;
			if (coalesce(qt_dose_red_p,0) > 0) then
				if (i = 1) then
					ds_dose_diferenciada_red_w := ds_dose_diferenciada_red_w || qt_dose_red_p || '-';
				else
					ds_dose_diferenciada_red_w := ds_dose_diferenciada_red_w || '...' || '-';
				end if;
			end if;
			if (coalesce(qt_dose_recons_p,0) > 0) then
				ds_dose_diferenciada_rec_w := ds_dose_diferenciada_rec_w || qt_dose_recons_p || '-';
			end if;
			end;
		end loop;
		
		ds_dose_diferenciada_dil_p := ds_dose_diferenciada_dil_w;
		ds_dose_diferenciada_red_p := ds_dose_diferenciada_red_w;
		ds_dose_diferenciada_rec_p := ds_dose_diferenciada_rec_w;	
		end;
	end if;
	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_reconst_diluicao ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_material_p material.cd_material%type, ie_via_aplicacao_p via_aplicacao.ie_via_aplicacao%type, qt_dose_medic_p bigint, cd_unidade_medida_dose_p unidade_medida.cd_unidade_medida%type, ie_opcao_p bigint, ie_alterou_dose_p text, nm_usuario_p usuario.nm_usuario%type, nr_seq_dil_p INOUT bigint, cd_mat_dil_p INOUT material.cd_material%type, qt_dose_dil_p INOUT bigint, cd_unid_med_dose_dil_p INOUT unidade_medida.cd_unidade_medida%type, qt_solucao_dil_p INOUT bigint, ds_dose_diferenciada_dil_p INOUT text, nr_seq_red_p INOUT bigint, cd_mat_red_p INOUT material.cd_material%type, qt_dose_red_p INOUT bigint, cd_unid_med_dose_red_p INOUT unidade_medida.cd_unidade_medida%type, qt_solucao_red_p INOUT bigint, ds_dose_diferenciada_red_p INOUT text, nr_seq_recons_p INOUT bigint, cd_mat_recons_p INOUT material.cd_material%type, qt_dose_recons_p INOUT bigint, cd_unid_med_dose_recons_p INOUT unidade_medida.cd_unidade_medida%type, qt_solucao_recons_p INOUT bigint, ds_dose_diferenciada_rec_p INOUT text, ie_regra_diluicao_p INOUT text, ds_dose_diferenciada_p text default null, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type default null, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type DEFAULT NULL, qt_dose_dif_p bigint default 0, cd_intervalo_p text default '', ds_solucao_p INOUT text DEFAULT NULL, ie_possui_dil_p INOUT text DEFAULT NULL, ie_possui_red_p INOUT text DEFAULT NULL, ie_possui_dil_cad_mat_p INOUT text DEFAULT NULL, qt_hora_aplic_p INOUT cpoe_material.qt_hora_aplicacao%type DEFAULT NULL, qt_min_aplic_p INOUT cpoe_material.qt_min_aplicacao%type DEFAULT NULL, ie_substitui_tempo_aplic_p INOUT text DEFAULT NULL, qt_retorno_sem_ml_p INOUT bigint  DEFAULT NULL) FROM PUBLIC;

