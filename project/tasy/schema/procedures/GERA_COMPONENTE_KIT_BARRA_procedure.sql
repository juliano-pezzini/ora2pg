-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gera_componente_kit_barra ( cd_material_p bigint, nr_seq_kit_estoque_p bigint, qt_material_p bigint, nm_usuario_p text, ie_consiste_quant_p text, ie_consiste_material_p text, nr_seq_lote_fornec_p bigint, nr_seq_item_kit_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE



nr_sequencia_w		bigint;
cd_kit_material_w		integer;
qt_material_kit_w		double precision;
ie_baixa_estoque_w	varchar(1);
qt_existe_w		integer;
qt_estoque_w		double precision;
ds_material_w		varchar(255);
ds_erro_w		varchar(255);
ie_disp_comp_kit_estoque_w	varchar(1);
ie_disp_reg_kit_estoque_w	varchar(1);
ie_consistir_w		varchar(1);
cd_material_troca_w	componente_kit_opcao.cd_material%type;
nr_seq_item_kit_w   componente_kit_opcao.nr_seq_componente%type;
ie_consignado_w		material.ie_consignado%type;
cd_fornec_consignado_w	kit_estoque_comp.cd_fornec_consignado%type;
cd_estabelecimento_w	kit_estoque.cd_estabelecimento%type;
cd_local_estoque_w	kit_estoque.cd_local_estoque%type;
ie_tipo_saldo_w		varchar(15);


BEGIN

if (cd_material_p > 0) then
	begin
	select	cd_kit_material,
		cd_local_estoque,
		cd_estabelecimento
	into STRICT	cd_kit_material_w,
		cd_local_estoque_w,
		cd_estabelecimento_w
	from	kit_estoque
	where	nr_sequencia = nr_seq_kit_estoque_p;
	
	select	count(*)
	into STRICT	qt_existe_w
	from	componente_kit
	where	cd_kit_material = cd_kit_material_w
	and (cd_material 	= cd_material_p or obter_material_generico(cd_material) = obter_material_generico(cd_material_p));
	
	nr_seq_item_kit_w := nr_seq_item_kit_p;
	
	if (qt_existe_w = 0) then
		begin
		if (coalesce(nr_seq_item_kit_w,0) > 0) then
			begin

			select	max(cd_material)
			into STRICT	cd_material_troca_w
			from	componente_kit a
			where	a.cd_kit_material = cd_kit_material_w
			and	a.nr_sequencia = nr_seq_item_kit_w
			and	exists (SELECT	1
					from	componente_kit_opcao x
					where	a.cd_kit_material = x.cd_kit_material
					and	a.nr_sequencia = x.nr_seq_componente
					and	x.cd_material = cd_material_p);
			end;
        else
            begin
                select max(cd_material),
                       max(nr_seq_componente)
                into STRICT   cd_material_troca_w,
                       nr_seq_item_kit_w
                from componente_kit_opcao
                where cd_kit_material = cd_kit_material_w
                and cd_material = cd_material_p;
                exception when no_data_found then
                    cd_material_troca_w := null;
                    nr_seq_item_kit_w := null;
            end;
		end if;
		end;
	end if;
	
	select	max(ie_consignado)
	into STRICT	ie_consignado_w
	from	material
	where	cd_material = cd_material_p;
	
	if (ie_consignado_w = '1') and (nr_seq_lote_fornec_p IS NOT NULL AND nr_seq_lote_fornec_p::text <> '') then
		select	max(cd_cgc_fornec)
		into STRICT	cd_fornec_consignado_w
		from	material_lote_fornec
		where	nr_sequencia = nr_seq_lote_fornec_p;
	elsif (ie_consignado_w = '2') and (nr_seq_lote_fornec_p IS NOT NULL AND nr_seq_lote_fornec_p::text <> '') then
		SELECT * FROM obter_fornec_consig_ambos(cd_estabelecimento_w, cd_material_p, nr_seq_lote_fornec_p, cd_local_estoque_w, ie_tipo_saldo_w, cd_fornec_consignado_w) INTO STRICT ie_tipo_saldo_w, cd_fornec_consignado_w;
	end if;
	
	select	coalesce(max(nr_sequencia),0) + 1
	into STRICT	nr_sequencia_w
	from	kit_estoque_comp
	where	nr_seq_kit_estoque = nr_seq_kit_estoque_p;

	insert into kit_estoque_comp(
		nr_seq_kit_estoque,
		nr_sequencia,
		cd_material,
		dt_atualizacao,
		nm_usuario,
		qt_material,
		ie_gerado_barras,
		nr_seq_lote_fornec,
		nr_seq_item_kit,
		cd_material_troca,
		cd_fornec_consignado)
	values (	nr_seq_kit_estoque_p,
		nr_sequencia_w,
		cd_material_p,
		clock_timestamp(),
		nm_usuario_p,
		qt_material_p,
		'S',
		CASE WHEN coalesce(nr_seq_lote_fornec_p,'0')='0' THEN  null  ELSE nr_seq_lote_fornec_p END ,
		nr_seq_item_kit_w,
		cd_material_troca_w,
		cd_fornec_consignado_w);
	commit;
	end;
end if;

ds_erro_p	:= substr(ds_erro_w,1,255);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gera_componente_kit_barra ( cd_material_p bigint, nr_seq_kit_estoque_p bigint, qt_material_p bigint, nm_usuario_p text, ie_consiste_quant_p text, ie_consiste_material_p text, nr_seq_lote_fornec_p bigint, nr_seq_item_kit_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

