-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_ajusta_devolucao ( dt_mesano_referencia_p timestamp) AS $body$
DECLARE


cd_material_w				integer;
cd_material_estoque_w		integer;
dt_mes_ref_w				timestamp;
nr_atendimento_w			bigint;
nr_movimento_estoque_w		bigint;
nr_seq_tab_orig_w			bigint;
qt_estoque_w				double precision;
qt_material_w				double precision;
qt_material_estoque_w		double precision;
ds_parametros_w			varchar(2000);
qt_registro_w				bigint;
qt_tabela_w				integer;

c01 CURSOR FOR
SELECT	a.nr_movimento_estoque,
	a.nr_atendimento,
	a.cd_material,
	a.cd_material_estoque,
	a.nr_seq_tab_orig,
	a.qt_estoque,
	b.qt_material,
	b.qt_material_estoque
from	devolucao_material_pac c,
	item_devolucao_material_pac b,
	movimento_estoque a
where	a.nr_seq_tab_orig			= b.nr_devolucao
and	c.nr_devolucao			= b.nr_devolucao
and	a.cd_material				= b.cd_material
and	c.nr_atendimento			= a.nr_atendimento
and	coalesce(b.qt_material_estoque,0)	> b.qt_material
and (b.qt_material - b.qt_material_estoque) = a.qt_estoque
and	a.qt_estoque < 0
and	a.ie_origem_documento 		= '3'
and	a.dt_mesano_referencia		= dt_mes_ref_w;


BEGIN

dt_mes_ref_w	:= trunc(dt_mesano_referencia_p,'month');

select	count(*)
into STRICT	qt_tabela_w
from	user_tables
where	table_name = 'W_DEV_MATERIAL';

if (qt_tabela_w = 0) then
	CALL exec_sql_dinamico('Tasy','create table w_dev_material(nr_movimento number(10), nr_devolucao number(10), qt_estoque number(13,4), qt_material number(13,4), qt_material_estoque number(13,4), cd_material number(6), qt_registro number(5))');
else
	CALL exec_sql_dinamico('Tasy','delete from w_dev_material');
	commit;
end if;

open c01;
loop
fetch c01 into
	nr_movimento_estoque_w,
	nr_atendimento_w,
	cd_material_w,
	cd_material_estoque_w,
	nr_seq_tab_orig_w,
	qt_estoque_w,
	qt_material_w,
	qt_material_estoque_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	select	count(*)
	into STRICT	qt_registro_w
	from	item_devolucao_material_pac b,
		devolucao_material_pac a
	where	a.nr_devolucao	= b.nr_devolucao
	and	a.nr_devolucao	= nr_seq_tab_orig_w
	and	a.nr_atendimento	= nr_atendimento_w
	and	b.cd_material		= cd_material_w
	and	coalesce(b.qt_material_estoque,0) > b.qt_material;



	if (qt_registro_w > 0) then
		ds_parametros_w:= 'nr_movto=' || nr_movimento_estoque_w || ';' || 'dev=' || nr_seq_tab_orig_w || ';' || 'qt='|| replace(qt_estoque_w,',','.') 	|| ';' || 'cd_mat=' || cd_material_estoque_w || ';' || 'qt_registro=' || qt_registro_w || ';' || 'qt_material=' || qt_material_w || ';qt_material_estoque=' || qt_material_estoque_w;

		CALL exec_sql_dinamico_bv('Tasy','insert into w_dev_material(nr_movimento, nr_devolucao, qt_estoque, cd_material, qt_registro, qt_material, qt_material_estoque) values (:nr_movto, :dev, :qt, :cd_mat, :qt_registro, :qt_material, :qt_material_estoque)',	ds_parametros_w);
	/*update	movimento_estoque
	set	qt_movimento		= qt_material_w,
		qt_estoque		= qt_material_w,
		nm_usuario		= 'BacaDev'
	where	nr_movimento_estoque	= nr_movimento_estoque_w;*/
	end if;

end loop;
close c01;

commit;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_ajusta_devolucao ( dt_mesano_referencia_p timestamp) FROM PUBLIC;

