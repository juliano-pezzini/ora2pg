-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE transferir_item_pacote_conta ( nr_sequencia_p bigint, nr_seq_proc_pacote_p bigint, nm_usuario_p text) AS $body$
DECLARE

					 
nr_interno_conta_origem_w	bigint;
nr_interno_conta_pacote_w	bigint;
nr_atendimento_w		bigint;
cd_convenio_w			bigint;
cd_categoria_w			varchar(10);
nr_seq_pacote_w			bigint;
nr_seq_proc_interno_w		bigint;
cd_procedimento_w		bigint;
vl_negociado_w			double precision;
ie_ratear_item_w		varchar(1);

C01 CURSOR FOR 
	SELECT	vl_negociado, 
		coalesce(ie_ratear_item,'S') 
	from	pacote_procedimento 
	where	nr_seq_pacote = nr_seq_pacote_w 
	and 	coalesce(cd_procedimento, coalesce(cd_procedimento_w,0)) = coalesce(cd_procedimento_w,0) 
	and 	coalesce(nr_seq_proc_interno, coalesce(nr_seq_proc_interno_w,0)) = coalesce(nr_seq_proc_interno_w,0) 
	and 	((nr_seq_proc_interno IS NOT NULL AND nr_seq_proc_interno::text <> '') or (cd_procedimento IS NOT NULL AND cd_procedimento::text <> '')) 
	and 	coalesce(IE_INCLUI_EXCLUI,'I') = 'I' 
	order by 1;
					

BEGIN 
 
select 	max(nr_atendimento), 
	max(nr_interno_conta), 
	max(cd_procedimento), 
	max(nr_seq_proc_interno) 
into STRICT	nr_atendimento_w, 
	nr_interno_conta_origem_w, 
	cd_procedimento_w, 
	nr_seq_proc_interno_w 
from 	procedimento_paciente 
where 	nr_sequencia = nr_sequencia_p;
 
select 	max(nr_seq_pacote) 
into STRICT	nr_seq_pacote_w 
from 	atendimento_pacote 
where 	nr_atendimento = nr_atendimento_w 
and 	nr_seq_procedimento = nr_seq_proc_pacote_p;
 
select max(nr_interno_conta) 
into STRICT	nr_interno_conta_pacote_w 
from  procedimento_paciente 
where  nr_atendimento = nr_atendimento_w 
and 	nr_sequencia 	= nr_seq_proc_pacote_p;
 
select	max(cd_convenio_parametro), 
	max(cd_categoria_parametro) 
into STRICT	cd_convenio_w, 
	cd_categoria_w 
from 	conta_paciente 
where 	nr_interno_conta = nr_interno_conta_pacote_w;
 
vl_negociado_w:= 0;
 
open C01;
loop 
fetch C01 into	 
	vl_negociado_w, 
	ie_ratear_item_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	vl_negociado_w:= vl_negociado_w;
	end;
end loop;
close C01;
 
update procedimento_paciente 
set	cd_convenio   	= cd_convenio_w, 
   	cd_categoria  	= cd_categoria_w, 
	nr_interno_conta	= nr_interno_conta_pacote_w, 
   	vl_procedimento 	= vl_negociado_w, 
	vl_medico    	= 0, 
	vl_anestesista 	= 0, 
	vl_materiais  	= 0, 
	vl_auxiliares  	= 0, 
	vl_custo_operacional 	= 0, 
	ie_valor_informado 	= 'S', 
	nr_seq_proc_pacote	= nr_seq_proc_pacote_p, 
	ie_ratear_item		= ie_ratear_item_w 
where 	nr_sequencia 		= nr_sequencia_p;
 
if (philips_param_pck.get_cd_pais = 2) then 
	delete	from propaci_imposto 
	where	nr_seq_propaci = nr_sequencia_p;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE transferir_item_pacote_conta ( nr_sequencia_p bigint, nr_seq_proc_pacote_p bigint, nm_usuario_p text) FROM PUBLIC;

