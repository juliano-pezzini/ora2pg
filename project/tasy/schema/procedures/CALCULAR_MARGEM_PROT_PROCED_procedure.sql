-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_margem_prot_proced ( cd_protocolo_p bigint, nr_sequencia_p bigint, cd_estabelecimento_p bigint, nr_atendimento_p bigint, nr_seq_paciente_p bigint, vl_margem_p INOUT bigint) AS $body$
DECLARE

 
vl_material_w		bigint;
vl_procedimento_w	bigint;
vl_margem_w		bigint;


BEGIN 
if (cd_protocolo_p IS NOT NULL AND cd_protocolo_p::text <> '') and (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') and (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_seq_paciente_p IS NOT NULL AND nr_seq_paciente_p::text <> '') then 
	begin 
	 
	select	sum(coalesce(qt_dose_prescr,qt_dose)) 
	into STRICT	vl_material_w 
	from	paciente_protocolo_medic 
	where	nr_seq_paciente	= nr_seq_paciente_p;
	 
	select	sum(coalesce(vl_procedimento,0)) 
	into STRICT	vl_procedimento_w 
	from ( 
		SELECT	sus_obter_preco_proced(cd_estabelecimento_p,clock_timestamp(),7,a.cd_procedimento,a.ie_origem_proced,2) vl_procedimento, 
			substr(obter_descricao_procedimento(a.cd_procedimento, 
			a.ie_origem_proced),1,200) ds_procedimento, 
			a.cd_procedimento 
		from	protocolo_medic_proc a 
		where	a.cd_protocolo	= cd_protocolo_p 
		and	a.nr_sequencia	= nr_sequencia_p 
		and	exists (	SELECT	1 
					from	sus_laudo_paciente x 
					where	x.cd_procedimento_solic	= a.cd_procedimento 
					and	x.ie_origem_proced	= a.ie_origem_proced 
					and	x.nr_Atendimento	= nr_atendimento_p) 
		
union
 
		select	sus_obter_preco_proced(cd_estabelecimento_p,clock_timestamp(),7,a.cd_procedimento,a.ie_origem_proced,2) 	vl_procedimento, 
			substr(obter_descricao_procedimento(a.cd_procedimento, 
			a.ie_origem_proced),1,200) ds_procedimento, 
			a.cd_procedimento 
		from	protocolo_procedimento a 
		where	a.cd_protocolo	= cd_protocolo_p 
		and	exists (	select	1 
					from	sus_laudo_paciente x 
					where	x.cd_procedimento_solic	= a.cd_procedimento 
					and	x.ie_origem_proced	= a.ie_origem_proced 
					and	x.nr_Atendimento	= nr_atendimento_p) 
		order by ds_procedimento) alias12;
	 
	vl_margem_w := ((vl_material_w * 100) / vl_procedimento_w);
	end;
end if;
vl_margem_p	:= vl_margem_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_margem_prot_proced ( cd_protocolo_p bigint, nr_sequencia_p bigint, cd_estabelecimento_p bigint, nr_atendimento_p bigint, nr_seq_paciente_p bigint, vl_margem_p INOUT bigint) FROM PUBLIC;

