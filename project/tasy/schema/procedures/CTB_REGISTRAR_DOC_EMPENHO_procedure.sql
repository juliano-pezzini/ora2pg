-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_registrar_doc_empenho ( cd_estabelecimento_p bigint, dt_referencia_p timestamp, nr_seq_nota_fiscal_p bigint, nr_solic_compra_p bigint, nr_ordem_compra_p bigint, nr_titulo_pagar_p bigint, nr_requisicao_p bigint, cd_centro_custo_p bigint, cd_conta_contabil_p text, vl_empenho_p bigint, ie_commit_p text, ie_acao_p text, nm_usuario_p text) AS $body$
DECLARE


cd_empresa_w				bigint;
dt_referencia_w				timestamp;
ie_empenho_orcamento_w			varchar(15);
nr_seq_mes_ref_w			bigint;
nr_seq_orcamento_w			bigint;
qt_registro_w				bigint;
vl_empenho_w				double precision;


BEGIN

select	coalesce(max(ie_empenho_orcamento),'N')
into STRICT	ie_empenho_orcamento_w
from	parametro_estoque
where	cd_estabelecimento	= cd_estabelecimento_p;

if (ie_empenho_orcamento_w = 'S') then
	begin

	cd_empresa_w	:= obter_empresa_estab(cd_estabelecimento_p);
	dt_referencia_w	:= PKG_DATE_UTILS.start_of(dt_referencia_p, 'month', 0);
	vl_empenho_w	:= coalesce(vl_empenho_p,0);

	select	max(nr_sequencia)
	into STRICT	nr_seq_mes_ref_w
	from	ctb_mes_ref
	where	cd_empresa	= cd_empresa_w
	and	dt_referencia	= dt_referencia_w;

	if (coalesce(nr_seq_mes_ref_w,0) = 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(233129,'DT_REFERENCIA_W=' || dt_referencia_w);
	end if;

	select	max(nr_sequencia)
	into STRICT	nr_seq_orcamento_w
	from	ctb_orcamento
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	nr_seq_mes_ref		= nr_seq_mes_ref_w
	and	cd_centro_custo		= cd_centro_custo_p
	and	cd_conta_contabil	= cd_conta_contabil_p;

	if (coalesce(nr_seq_orcamento_w::text, '') = '') then

		select	nextval('ctb_orcamento_seq')
		into STRICT	nr_seq_orcamento_w
		;
		begin
		CALL wheb_usuario_pck.set_ie_executar_trigger('N');
		insert into ctb_orcamento(
			nr_sequencia,
			nr_seq_mes_ref,
			dt_atualizacao,
			nm_usuario,
			cd_estabelecimento,
			cd_conta_contabil,
			cd_centro_custo,
			vl_original,
			vl_orcado,
			vl_realizado,
			vl_empenho,
			ie_cenario,
			ie_origem_orc)
		values (	nr_seq_orcamento_w,
			nr_seq_mes_ref_w,
			clock_timestamp(),
			nm_usuario_p,
			cd_estabelecimento_p,
			cd_conta_contabil_p,
			cd_centro_custo_p,
			0,
			0,
			0,
			0,
			'N',
			'SIS');
			CALL wheb_usuario_pck.set_ie_executar_trigger('S');
			exception when others then
				CALL wheb_usuario_pck.set_ie_executar_trigger('S');
			end;
	end if;

	if (vl_empenho_w <> 0) and (nr_seq_orcamento_w IS NOT NULL AND nr_seq_orcamento_w::text <> '') and (ie_acao_p = 'I') then
		insert into ctb_orc_doc_empenho(
			nr_sequencia,
			nr_seq_orcamento,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_estabelecimento,
			dt_referencia,
			cd_conta_contabil,
			cd_centro_custo,
			nr_seq_nota_fiscal,
			nr_solic_compra,
			nr_ordem_compra,
			nr_requisicao,
			nr_titulo,
			vl_empenho)
		values (	nextval('ctb_orc_doc_empenho_seq'),
			nr_seq_orcamento_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_estabelecimento_p,
			dt_referencia_w,
			cd_conta_contabil_p,
			cd_centro_custo_p,
			nr_seq_nota_fiscal_p,
			nr_solic_compra_p,
			nr_ordem_compra_p,
			nr_requisicao_p,
			nr_titulo_pagar_p,
			vl_empenho_w);

	CALL ctb_atualizar_saldo_empenho(	cd_estabelecimento_p,
					dt_referencia_w,
					cd_centro_custo_p,
					cd_conta_contabil_p,
					nm_usuario_p);

	end if;


	end;
end if;

if (ie_commit_p = 'S') then
	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_registrar_doc_empenho ( cd_estabelecimento_p bigint, dt_referencia_p timestamp, nr_seq_nota_fiscal_p bigint, nr_solic_compra_p bigint, nr_ordem_compra_p bigint, nr_titulo_pagar_p bigint, nr_requisicao_p bigint, cd_centro_custo_p bigint, cd_conta_contabil_p text, vl_empenho_p bigint, ie_commit_p text, ie_acao_p text, nm_usuario_p text) FROM PUBLIC;

