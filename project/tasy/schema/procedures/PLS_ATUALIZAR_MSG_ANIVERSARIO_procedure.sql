-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_msg_aniversario ( nm_usuario_p text) AS $body$
DECLARE

 
c01 CURSOR FOR 
	SELECT	nr_seq_evento_mens 
	from	pls_regra_geracao_evento 
	where	ie_evento_disparo	= 10 
	and	ie_situacao		= 'A';

c02 CURSOR FOR 
 	SELECT	a.nr_sequencia nr_seq_segurado, 
		a.cd_pessoa_fisica, 
		a.nr_seq_contrato, 
		a.cd_estabelecimento 
	from	pls_segurado a, 
		pessoa_fisica b 
	where	a.cd_pessoa_fisica = b.cd_pessoa_fisica 
	and	coalesce(a.dt_rescisao::text, '') = '' 
	and	a.ie_situacao_atend	= 'A' 
	and	to_char(b.dt_nascimento,'DD/MM') = to_char(clock_timestamp(),'DD/MM') 
	and	(a.nr_seq_contrato IS NOT NULL AND a.nr_seq_contrato::text <> '');

C03 CURSOR(	nr_seq_evento_mens_pc		pls_regra_geracao_evento.nr_seq_evento_mens%type) FOR 
	SELECT	ie_forma_envio, 
		ie_tipo_pessoa_dest 
	from	pls_alerta_evento_destino a  
	where	nr_seq_evento_mens = nr_seq_evento_mens_pc 
	and	ie_situacao = 'A';

nr_seq_evento_controle_w	pls_alerta_evento_controle.nr_sequencia%type;
nr_seq_tipo_evento_w		pls_tipo_alerta_evento.nr_sequencia%type;
ds_mensagem_w			pls_alerta_evento_mensagem.ds_mensagem%type;
ds_mensagem_padrao_w		pls_alerta_evento_mensagem.ds_mensagem%type;
ds_titulo_w			pls_alerta_evento_mensagem.ds_titulo%type;
ie_tipo_envio_w			pls_alerta_evento_mensagem.ie_tipo_envio%type;
ds_remetente_email_w		pls_alerta_evento_mensagem.ds_remetente_email%type;
ds_remetente_sms_w		pls_alerta_evento_mensagem.ds_remetente_sms%type;
nm_beneficiario_w		pessoa_fisica.nm_pessoa_fisica%type;
ds_email_dest_w			usuario.ds_email%type;
ds_sms_dest_w			varchar(15);
qt_macro_w			bigint;
cd_operadora_empresa_w		pls_contrato.cd_operadora_empresa%type;
nr_contrato_w			pls_contrato.nr_contrato%type;
cd_usuario_plano_w		pls_segurado_carteira.cd_usuario_plano%type;
id_sms_w			pls_alerta_evento_cont_des.id_sms%type;

BEGIN 
for r_C01_w in C01 loop 
	begin 
	select	max(b.nr_sequencia), 
		max(a.ds_mensagem), 
		max(a.ds_titulo), 
		max(a.ie_tipo_envio), 
		max(a.ds_remetente_email), 
		max(a.ds_remetente_sms) 
	into STRICT	nr_seq_tipo_evento_w, 
		ds_mensagem_padrao_w, 
		ds_titulo_w, 
		ie_tipo_envio_w, 
		ds_remetente_email_w, 
		ds_remetente_sms_w 
	from	pls_alerta_evento_mensagem a, 
		pls_tipo_alerta_evento b 
	where	b.nr_sequencia	= a.nr_seq_tipo_evento 
	and	a.ie_situacao	= 'A' 
	and	b.ie_situacao	= 'A' 
	and	a.nr_sequencia	= r_C01_w.nr_seq_evento_mens;
	 
	for r_C02_w in C02 loop 
		begin 
		ds_mensagem_w		:= ds_mensagem_padrao_w;
		nm_beneficiario_w	:= pls_obter_dados_segurado(r_C02_w.nr_seq_segurado,'N');
		nr_contrato_w		:= pls_obter_nr_contrato(r_c02_w.nr_seq_contrato);
		 
		begin 
		select	pls_convert_masc_cart_usuario(cd_usuario_plano, r_C02_w.cd_estabelecimento) 
		into STRICT	cd_usuario_plano_w 
		from	pls_segurado_carteira 
		where	nr_seq_segurado	= r_c02_w.nr_seq_segurado;
		exception 
		when others then 
			cd_usuario_plano_w	:= '';
		end;
		 
		select	count(1) 
		into STRICT	qt_macro_w 
		 
		where	ds_mensagem_w like '%@%';
		 
		if (qt_macro_w > 0) then 
			ds_mensagem_w	:= replace_macro(ds_mensagem_w, '@NR_CONTRATO', nr_contrato_w);
			ds_mensagem_w	:= replace_macro(ds_mensagem_w, '@BENEFICIARIO', nm_beneficiario_w);
			ds_mensagem_w	:= replace_macro(ds_mensagem_w, '@CARTEIRA_BENEFICIARIO', cd_usuario_plano_w);
		end if;
		 
		select	nextval('pls_alerta_evento_controle_seq') 
		into STRICT	nr_seq_evento_controle_w 
		;
		 
		insert	into pls_alerta_evento_controle(nr_sequencia, 
			dt_geracao_evento, 
			ie_evento_disparo, 
			nr_seq_tipo_evento, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			ds_mensagem, 
			ds_titulo, 
			ie_tipo_envio) 
		values (nr_seq_evento_controle_w, 
			clock_timestamp(), 
			10, 
			nr_seq_tipo_evento_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			ds_mensagem_w, 
			ds_titulo_w, 
			ie_tipo_envio_w);
		 
		for r_C03_w in C03(r_C01_w.nr_seq_evento_mens) loop 
			begin 
			if (r_C03_w.ie_forma_envio = 'EM') and (coalesce(ds_remetente_email_w,'X') <> 'X') then 
				if (r_C03_w.ie_tipo_pessoa_dest = 'BE') then 
					ds_email_dest_w := pls_obter_dados_segurado(r_C02_w.nr_seq_segurado,'E');
					if (coalesce(ds_email_dest_w,'X') <> 'X') then 
						CALL enviar_email(	ds_titulo_w, ds_mensagem_w, ds_remetente_email_w, 
								ds_email_dest_w, nm_usuario_p, 'M');
					end if;
				end if;
			end if;
			 
			if (r_C03_w.ie_forma_envio = 'SMS') and (coalesce(ds_remetente_sms_w,'X') <> 'X') then 
				if (r_C03_w.ie_tipo_pessoa_dest = 'BE') then 
					ds_sms_dest_w		:= pls_obter_dados_segurado(r_C02_w.nr_seq_segurado,'TCD');
					if (coalesce(ds_sms_dest_w,'X') <> 'X') then 
						id_sms_w := pls_enviar_sms_alerta_evento(	ds_remetente_sms_w, ds_sms_dest_w, substr(ds_mensagem_w,1,150), nr_seq_tipo_evento_w, nm_usuario_p, id_sms_w);
						CALL pls_gerar_destino_evento(	nr_seq_evento_controle_w, 'E', r_C03_w.ie_forma_envio, 
										nm_usuario_p, r_C02_w.cd_pessoa_fisica, null, 
										ds_mensagem_w, id_sms_w, ds_sms_dest_w);
					end if;
				end if;
			end if;
			 
			end;
		end loop; --C03 
		end;
	end loop; --C02 
	
	commit;	
	end;
end loop; --C01 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_msg_aniversario ( nm_usuario_p text) FROM PUBLIC;

