-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lic_gerar_registro_compras ( nr_sequencia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE


nr_seq_licitacao_w			bigint;
nr_seq_lic_item_w			bigint;
nr_seq_fornec_w			bigint;
nr_seq_lic_item_fornec_w		bigint;
cd_material_w			integer;
qt_existe_w			bigint;
ds_erro_w			varchar(255);
vl_item_w				double precision;
qt_item_w			double precision;
ds_marca_w			varchar(255);
ds_marca_item_lote_w		varchar(255);
nr_seq_marca_w			bigint;
ie_lote_w				varchar(1);
cd_pessoa_solicitante_w		varchar(10);
qt_dias_venc_w			bigint;

c01 CURSOR FOR
SELECT	'N' ie_lote,
	a.nr_seq_lic_item,
	b.nr_sequencia nr_seq_fornec,
	c.nr_sequencia nr_seq_lic_item_fornec,
	a.cd_material,
	c.ds_marca
from	reg_lic_vencedor a,
	reg_lic_fornec b,
	reg_lic_item_fornec c
where	a.nr_seq_fornec		= b.nr_sequencia
and	c.nr_seq_fornec		= b.nr_sequencia
and	c.nr_seq_lic_item		= a.nr_seq_lic_item
and	a.nr_seq_licitacao		= nr_seq_licitacao_w
and	lic_obter_se_aceito_recurso(b.nr_seq_licitacao,c.nr_seq_lic_item) 	= 'S'
and	lic_obter_se_item_homologado(a.nr_seq_licitacao,c.nr_seq_lic_item)	= 'S'
and	lic_obter_se_item_lote(c.nr_seq_licitacao, c.nr_seq_lic_item)		= 'N'
and	coalesce(b.ie_situacao, 'A')	= 'A'
and not exists (
	SELECT	1
	from	reg_compra_item x
	where	x.nr_seq_licitacao	= a.nr_seq_licitacao
	and	x.nr_seq_lic_item	= a.nr_seq_lic_item
	and	coalesce(x.dt_cancelamento::text, '') = '')

union all

select	'S' ie_lote,
	d.nr_seq_lic_item,
	b.nr_sequencia nr_seq_fornec,
	c.nr_sequencia nr_seq_lic_item_fornec,
	d.cd_material,
	c.ds_marca
from	reg_lic_vencedor a,
	reg_lic_fornec b,
	reg_lic_item_fornec c,
	reg_lic_item d
where	a.nr_seq_fornec		= b.nr_sequencia
and	c.nr_seq_fornec		= b.nr_sequencia
and	c.nr_seq_lic_item		= a.nr_seq_lic_item
and	d.nr_seq_licitacao		= c.nr_seq_licitacao
and	d.nr_seq_lote		= c.nr_seq_lic_item
and	a.nr_seq_licitacao	= nr_seq_licitacao_w
and	lic_obter_se_aceito_recurso(b.nr_seq_licitacao,d.nr_seq_lote) 	= 'S'
and	lic_obter_se_item_homologado(a.nr_seq_licitacao,d.nr_seq_lote)	= 'S'
and	coalesce(b.ie_situacao, 'A')	= 'A'
and	(d.nr_seq_lote IS NOT NULL AND d.nr_seq_lote::text <> '')
and not exists (
	select	1
	from	reg_compra_item x
	where	x.nr_seq_licitacao	= a.nr_seq_licitacao
	and	x.nr_seq_lic_item	= d.nr_seq_lic_item
	and	coalesce(x.dt_cancelamento::text, '') = '');

c02 CURSOR FOR
SELECT	distinct
	cd_material,
	ds_marca
from	reg_lic_item_fornec
where	nr_seq_licitacao = nr_seq_licitacao_w
and	(ds_marca IS NOT NULL AND ds_marca::text <> '')
and	(cd_material IS NOT NULL AND cd_material::text <> '')

union

select	distinct
	b.cd_material,
	coalesce(b.ds_marca, a.ds_marca)
from	reg_lic_item_fornec a,
	reg_lic_item_fornec_lote b
where	a.nr_sequencia = b.nr_seq_lic_item_fornec
and	a.nr_seq_licitacao = nr_seq_licitacao_w
and	(a.ds_marca IS NOT NULL AND a.ds_marca::text <> '');

c03 CURSOR FOR
SELECT	distinct a.cd_pessoa_solicitante
from	solic_compra a,
	reg_lic_solic_item b
where	a.nr_solic_compra = b.nr_solic_compra
and	b.nr_seq_licitacao = nr_seq_licitacao_w
and	b.nr_seq_lic_item = nr_seq_lic_item_w
and not exists (
		SELECT	1
		from	reg_compra_responsaveis x
		where	x.nr_seq_reg_compra = nr_sequencia_p
		and	x.cd_pessoa_resp = a.cd_pessoa_solicitante);


BEGIN

select (max(obter_valor_param_usuario(953, 24, obter_perfil_ativo,nm_usuario_p, cd_estabelecimento_p)))
into STRICT	qt_dias_venc_w
;

select	nr_seq_licitacao
into STRICT	nr_seq_licitacao_w
from	reg_compra
where	nr_sequencia	= nr_sequencia_p;

select	count(*)
into STRICT	qt_existe_w
from (
	SELECT	1
	from	reg_lic_vencedor a,
		reg_lic_fornec b,
		reg_lic_item_fornec c
	where	a.nr_seq_fornec		= b.nr_sequencia
	and	c.nr_seq_fornec		= b.nr_sequencia
	and	c.nr_seq_lic_item		= a.nr_seq_lic_item
	and	a.nr_seq_licitacao		= nr_seq_licitacao_w
	and	lic_obter_se_aceito_recurso(b.nr_seq_licitacao,c.nr_seq_lic_item)	= 'S'
	and	lic_obter_se_item_homologado(a.nr_seq_licitacao,c.nr_seq_lic_item)	= 'S'
	and	lic_obter_se_item_lote(c.nr_seq_licitacao, c.nr_seq_lic_item)		= 'N'
	and	coalesce(b.ie_situacao, 'A')	= 'A'
	and not exists (
		SELECT	1
		from	reg_compra_item x
		where	x.nr_seq_licitacao	= a.nr_seq_licitacao
		and	x.nr_seq_lic_item	= a.nr_seq_lic_item
		and	coalesce(x.dt_cancelamento::text, '') = '')
	
union all

	select	1
	from	reg_lic_vencedor a,
		reg_lic_fornec b,
		reg_lic_item_fornec c,
		reg_lic_item d
	where	a.nr_seq_fornec		= b.nr_sequencia
	and	c.nr_seq_fornec		= b.nr_sequencia
	and	c.nr_seq_lic_item		= a.nr_seq_lic_item
	and	d.nr_seq_licitacao		= c.nr_seq_licitacao
	and	d.nr_seq_lote		= c.nr_seq_lic_item
	and	a.nr_seq_licitacao		= nr_seq_licitacao_w
	and	lic_obter_se_aceito_recurso(b.nr_seq_licitacao,d.nr_seq_lote) 	= 'S'
	and	lic_obter_se_item_homologado(a.nr_seq_licitacao,d.nr_seq_lote)	= 'S'
	and	coalesce(b.ie_situacao, 'A')	= 'A'
	and	(d.nr_seq_lote IS NOT NULL AND d.nr_seq_lote::text <> '')
	and not exists (
		select	1
		from	reg_compra_item x
		where	x.nr_seq_licitacao	= a.nr_seq_licitacao
		and	x.nr_seq_lic_item	= d.nr_seq_lic_item
		and	coalesce(x.dt_cancelamento::text, '') = '')) alias13;

if (qt_existe_w > 0) then
	begin

	open C01;
	loop
	fetch C01 into
		ie_lote_w,
		nr_seq_lic_item_w,
		nr_seq_fornec_w,
		nr_seq_lic_item_fornec_w,
		cd_material_w,
		ds_marca_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin


		qt_item_w	:= lic_obter_qt_item(nr_seq_licitacao_w, nr_seq_lic_item_w);

		if (ie_lote_w = 'N') then
			vl_item_w	:= lic_obter_valor_vencedor_item(nr_seq_licitacao_w, nr_seq_lic_item_w);
		else
			vl_item_w	:= dividir(lic_obter_vl_fim_item_lote(nr_seq_licitacao_w, nr_seq_lic_item_w, nr_seq_fornec_w),qt_item_w);

			select	coalesce(max(ds_marca),'')
			into STRICT	ds_marca_item_lote_w
			from	reg_lic_item_fornec_lote
			where	nr_seq_licitacao	= nr_seq_licitacao_w
			and	nr_seq_lic_item_fornec	= nr_seq_lic_item_fornec_w
			and	cd_material		= cd_material_w;

			if (ds_marca_item_lote_w IS NOT NULL AND ds_marca_item_lote_w::text <> '') then
				ds_marca_w := ds_marca_item_lote_w;
			end if;

		end if;

		insert into reg_compra_item(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_licitacao,
			nr_seq_reg_compra,
			nr_seq_lic_item,
			nr_seq_fornec,
			nr_seq_fornec_original,
			nr_seq_lic_item_fornec,
			cd_material,
			qt_item,
			qt_item_original,
			vl_item,
			vl_item_original,
			ds_marca,
			ds_marca_original)
		values (	nextval('reg_compra_item_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_licitacao_w,
			nr_sequencia_p,
			nr_seq_lic_item_w,
			nr_seq_fornec_w,
			nr_seq_fornec_w,
			nr_seq_lic_item_fornec_w,
			cd_material_w,
			qt_item_w,
			qt_item_w,
			vl_item_w,
			vl_item_w,
			ds_marca_w,
			ds_marca_w);

		open C03;
		loop
		fetch C03 into
			cd_pessoa_solicitante_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			insert into reg_compra_responsaveis(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_reg_compra,
				cd_pessoa_resp,
				qt_dias_aviso,
				ie_email,
				ie_comunic_interna)
			values (	nextval('reg_compra_responsaveis_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_sequencia_p,
				cd_pessoa_solicitante_w,
				qt_dias_venc_w,
				'S',
				'S');
			end;
		end loop;
		close C03;
		end;
	end loop;
	close C01;

	insert into reg_lic_historico(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		ie_tipo_historico,
		ds_observacao,
		nr_seq_licitacao)
	values (	nextval('reg_lic_historico_seq'),
		clock_timestamp(),
		nm_usuario_p,
		'RP',
		WHEB_MENSAGEM_PCK.get_texto(277579),
		nr_seq_licitacao_w);
	end;
else
	ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(277580),1,255);
end if;

open C02;
loop
fetch C02 into
	cd_material_w,
	ds_marca_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_seq_marca_w
	from	marca
	where	elimina_acentuacao(upper(ds_marca)) = elimina_acentuacao(upper(ds_marca_w));

	if (nr_seq_marca_w > 0) then

		select	count(*)
		into STRICT	qt_existe_w
		from	material_marca
		where	cd_material = cd_material_w
		and	nr_sequencia = nr_seq_marca_w;

		if (qt_existe_w = 0) then

			insert into material_marca(
				cd_material,
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				qt_prioridade,
				ie_situacao)
			values (	cd_material_w,
				nr_seq_marca_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				1,
				'A');
		end if;
	end if;
	end;
end loop;
close C02;

commit;

ds_erro_p := ds_erro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lic_gerar_registro_compras ( nr_sequencia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

