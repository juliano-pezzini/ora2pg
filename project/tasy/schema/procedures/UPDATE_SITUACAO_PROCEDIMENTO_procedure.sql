-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE update_situacao_procedimento (nr_prescricao_p bigint, nr_sequencia_p bigint, nr_seq_situacao_proc_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_proc_compl_w     bigint;
nr_seq_situacao_proc_w  bigint;
nm_usuario_w            varchar(15);


BEGIN
  select max(nr_seq_proc_compl)
  into STRICT   nr_seq_proc_compl_w
  from   prescr_procedimento
  where  nr_prescricao	= nr_prescricao_p
  and    nr_sequencia	= nr_sequencia_p;

  if (coalesce(nr_seq_proc_compl_w::text, '') = '') then
    CALL gerar_prescr_proc_compl(nr_prescricao_p, nr_sequencia_p, nm_usuario_p, null);

    select max(nr_seq_proc_compl)
    into STRICT   nr_seq_proc_compl_w
    from   prescr_procedimento
    where  nr_prescricao	= nr_prescricao_p
    and    nr_sequencia	= nr_sequencia_p;
  end if;

  if (nr_seq_situacao_proc_p <> -1) then
    nr_seq_situacao_proc_w := nr_seq_situacao_proc_p;
    nm_usuario_w := nm_usuario_p;
  end if;

  update prescr_procedimento_compl
  set nr_seq_situacao_proc = nr_seq_situacao_proc_w,
      nm_usuario_situacao = nm_usuario_w
  where nr_sequencia = nr_seq_proc_compl_w;
  commit;

  CALL GRAVA_AUDITORIA_SITUACAO(nr_prescricao_p,nr_sequencia_p,nm_usuario_p,nr_seq_situacao_proc_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE update_situacao_procedimento (nr_prescricao_p bigint, nr_sequencia_p bigint, nr_seq_situacao_proc_p bigint, nm_usuario_p text) FROM PUBLIC;

