-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hd_registrar_evolucao (nr_seq_dialise_p bigint, dt_evolucao_p timestamp, cd_pessoa_evolucao_p text, ie_tipo_evolucao_p text, ie_evolucao_clinica_p text, ie_especialidade_p text, ds_evolucao_p text, nr_atendimento_p bigint, ds_tratamento_p text, nr_seq_dialise_perit_p bigint, nm_usuario_p text, ie_liberar_p text default 'S', ie_plataforma_p text default 'D') AS $body$
DECLARE


cd_setor_atendimento_w		integer;
cd_pessoa_fisica_w		varchar(10);
ie_contador_w			bigint	:= 0;
tam_lista_w			bigint;
ie_pos_virgula_w		smallint;
nr_tipo_evento_w		bigint;
lista_informacao_w		varchar(2000);
ds_tipo_evento_w		varchar(255);
ds_eventos_w			varchar(2000);
ds_evolucao_w			text;


BEGIN

CALL HD_Inserir_Evento_Dialise(nr_seq_dialise_p,nr_seq_dialise_perit_p,ds_tratamento_p,nm_usuario_p);

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
	/* Obter o setor do atendimento */

	select	obter_setor_atendimento(nr_atendimento_p)
	into STRICT	cd_setor_atendimento_w
	;
end if;

if (coalesce(nr_seq_dialise_perit_p::text, '') = '') and (nr_seq_dialise_p IS NOT NULL AND nr_seq_dialise_p::text <> '') then
	/* Obter o paciente */

	select	cd_pessoa_fisica
	into STRICT	cd_pessoa_fisica_w
	from	hd_dialise
	where	nr_sequencia	= nr_seq_dialise_p;
elsif (nr_seq_dialise_perit_p IS NOT NULL AND nr_seq_dialise_perit_p::text <> '') then
	/* Obter o paciente */

	select	cd_pessoa_fisica
	into STRICT	cd_pessoa_fisica_w
	from	hd_dialise_peritonial
	where	nr_sequencia	= nr_seq_dialise_perit_p;
end if;

/*Inserir os tratamento na evolucao*/

ds_eventos_w	:= null;
ds_evolucao_w	:= ds_evolucao_p;

/* ie_plataforma_p (D - Delphi, J- Java). Quando procedure chamada pelo Tasy Java nao entra para concatenar os eventos, e feito no codigo fonte do Java.*/

if (ds_tratamento_p IS NOT NULL AND ds_tratamento_p::text <> '') and (ie_plataforma_p = 'D' or coalesce(ie_plataforma_p::text, '') = '') then

	lista_informacao_w	:= ds_tratamento_p;

	while	(lista_informacao_w IS NOT NULL AND lista_informacao_w::text <> '') or
		ie_contador_w > 200 loop
		begin
		tam_lista_w		:= length(lista_informacao_w);
		ie_pos_virgula_w	:= position(',' in lista_informacao_w);

		if (ie_pos_virgula_w <> 0) then
			nr_tipo_evento_w	:= substr(lista_informacao_w,1,(ie_pos_virgula_w - 1));
			lista_informacao_w	:= substr(lista_informacao_w,(ie_pos_virgula_w + 1),tam_lista_w);
		end if;

		select 	max(ds_tipo_evento)
		into STRICT	ds_tipo_evento_w
		from	hd_tipo_evento
		where	nr_sequencia = nr_tipo_evento_w;

		if (ds_tipo_evento_w IS NOT NULL AND ds_tipo_evento_w::text <> '') then
			
			ds_eventos_w	:= ds_eventos_w || chr(10) || ds_tipo_evento_w;
		
		end if;

		ie_contador_w	:= ie_contador_w + 1;
	
		end;
	end loop;
	
	if (ds_eventos_w IS NOT NULL AND ds_eventos_w::text <> '') then
		ds_eventos_w	:= wheb_mensagem_pck.get_texto(309086) || ':' || ds_eventos_w;
		ds_evolucao_w	:= ds_evolucao_w || chr(10) || chr(10)|| ds_eventos_w;
	end if;
	
end if;

/* Inserir a evolucao */

insert into evolucao_paciente(
	cd_evolucao,
	dt_evolucao,
	ie_tipo_evolucao,
	cd_pessoa_fisica,
	cd_medico,
	dt_atualizacao,
	nm_usuario,
	nr_atendimento,
	ds_evolucao,
	dt_liberacao,
	ie_evolucao_clinica,
	cd_setor_atendimento,
	ie_recem_nato,
	cd_especialidade_medico,
	ie_situacao
) values (
	nextval('evolucao_paciente_seq'),
	dt_evolucao_p,
	ie_tipo_evolucao_p,
	cd_pessoa_fisica_w,
	cd_pessoa_evolucao_p,
	clock_timestamp(),
	nm_usuario_p,
	CASE WHEN nr_atendimento_p=0 THEN null  ELSE nr_atendimento_p END ,
	ds_evolucao_w,
	CASE WHEN coalesce(ie_liberar_p,'S')='S' THEN  dt_evolucao_p   ELSE null END ,
	ie_evolucao_clinica_p,
	cd_setor_atendimento_w,
	'N',
	ie_especialidade_p,
	'A'
);	

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hd_registrar_evolucao (nr_seq_dialise_p bigint, dt_evolucao_p timestamp, cd_pessoa_evolucao_p text, ie_tipo_evolucao_p text, ie_evolucao_clinica_p text, ie_especialidade_p text, ds_evolucao_p text, nr_atendimento_p bigint, ds_tratamento_p text, nr_seq_dialise_perit_p bigint, nm_usuario_p text, ie_liberar_p text default 'S', ie_plataforma_p text default 'D') FROM PUBLIC;

