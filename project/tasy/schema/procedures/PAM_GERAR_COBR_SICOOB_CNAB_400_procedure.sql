-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pam_gerar_cobr_sicoob_cnab_400 (nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_conteudo_w		varchar(400) := null;
nr_seq_reg_arquivo_w	bigint := 1;
cd_conta_cobr_w		varchar(8);
cd_agencia_cobr_w	varchar(4);
ie_digito_conta_w		varchar(2);
nm_empresa_w		varchar(30);
dt_geracao_w		varchar(6);
cd_convenio_banco_w	varchar(6);
ie_digito_conta_cobr_w	varchar(1);
nr_remessa_w		bigint;
cd_cedente_w		varchar(9);

-- Detalhe
nr_inscricao_empresa_w	varchar(14);
cd_agencia_bancaria_w	varchar(4);
cd_conta_w		varchar(5);
ie_digito_conta_ww		varchar(1);
nr_titulo_w		varchar(10);
nr_nosso_numero_w	varchar(12);
dt_vencimento_w		varchar(6);
vl_titulo_w		varchar(13);
dt_emissao_w		varchar(6);
tx_mora_w		varchar(6);
tx_juros_w		varchar(6);
vl_desconto_w		varchar(13);
ie_tipo_inscricao_w		varchar(2);
nr_inscricao_w		varchar(14);
nm_pagador_w		varchar(40);
ds_endereco_w		varchar(37);
ds_bairro_w		varchar(15);
cd_cep_w		varchar(8);
ds_municipio_w		varchar(15);
sg_estado_w		varchar(15);
ie_dig_nosso_numero_w 	varchar(1);
cd_carteira_w		cobranca_escritural.nr_seq_carteira_cobr%type;
cd_ocorrencia_w varchar(2);

-- Brancos
ds_brancos_294_w		varchar(294);
ds_brancos_393_w		varchar(393);
ds_brancos_40_w		varchar(40);

C01 CURSOR FOR
	SELECT	lpad(substr(obter_cgc_estabelecimento(cd_estabelecimento_p),1,14),14,'0') nr_inscricao_empresa,
		lpad(coalesce(c.cd_agencia_bancaria,'0'),4,'0'),
		lpad(coalesce(e.cd_conta,'0'),5,'0'),
		coalesce(c.ie_digito_conta,'0'),
		lpad(coalesce(c.nr_titulo,'0'),10,'0') nr_titulo,
		lpad(somente_numero(coalesce(substr(coalesce(b.nr_nosso_numero, obter_nosso_numero_banco(c.cd_banco,c.nr_titulo)),1,12),'0')),12,'0') nr_nosso_numero,
		substr(b.ie_dig_nosso_numero,1,1) ie_dig_nosso_numero,
		to_char(coalesce(b.dt_pagamento_previsto,clock_timestamp()),'ddmmyy'),
		lpad(replace(to_char(b.vl_saldo_titulo, 'fm00000000000.00'),'.',''),13,'0'),
		to_char(coalesce(b.dt_emissao,clock_timestamp()),'ddmmyy'),
		lpad(replace(to_char(b.tx_multa, 'fm00.0000'),'.',''),6,'0'),
		lpad(replace(to_char(b.tx_juros, 'fm00.0000'),'.',''),6,'0'),
		lpad('0',13,'0') vl_desconto,
		CASE WHEN coalesce(b.cd_cgc::text, '') = '' THEN '01'  ELSE '02' END  ie_tipo_inscricao,
		lpad(coalesce(b.cd_cgc_cpf,'0'),14, '0') nr_inscricao,
		rpad(substr(coalesce(obter_nome_pf_pj(b.cd_pessoa_fisica,b.cd_cgc),' '),1,40),40,' ') nm_pagador,
		rpad(substr(upper(coalesce(coalesce(pls_obter_end_pagador(d.nr_seq_pagador,'EN'),obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'R')),' ')),1,37),37,' ') ds_endereco,
		rpad(substr(upper(coalesce(coalesce(pls_obter_end_pagador(d.nr_seq_pagador,'B'),obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'B')),' ')),1,15),15,' ') ds_bairro,
		rpad(substr(upper(coalesce(elimina_caractere_especial(coalesce(pls_obter_end_pagador(d.nr_seq_pagador,'CEP'),obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'CEP'))),' ')),1,8),8,' ') cd_cep,
		rpad(substr(upper(coalesce(coalesce(pls_obter_end_pagador(d.nr_seq_pagador,'CI'),obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'CI')),' ')),1,15),15,' ') ds_cidade,
		rpad(substr(upper(coalesce(coalesce(pls_obter_end_pagador(d.nr_seq_pagador,'UF'),obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'UF')),' ')),1,2),2,' ') ds_uf,
		CASE WHEN coalesce(c.cd_ocorrencia::text, '') = '' THEN '01'  ELSE c.cd_ocorrencia END  cd_ocorrencia,
		substr(coalesce(cd_carteira_w,'01'),1,2)
	FROM banco_estabelecimento e, titulo_receber_cobr c, titulo_receber_v b, cobranca_escritural a, titulo_receber x
LEFT OUTER JOIN pls_mensalidade d ON (x.nr_seq_mensalidade = d.nr_sequencia)
WHERE x.nr_titulo            	 	= b.nr_titulo and c.nr_titulo            	 	= b.nr_titulo and a.nr_sequencia       	 	= c.nr_seq_cobranca and a.nr_seq_conta_banco 	= e.nr_sequencia and a.nr_sequencia         	 	= nr_seq_cobr_escrit_p;


BEGIN
delete	FROM w_envio_banco
where	nm_usuario = nm_usuario_p;

--Brancos
select	lpad(' ',294,' '),
	lpad(' ',393,' '),
	lpad(' ',40,' ')
into STRICT	ds_brancos_294_w,
	ds_brancos_393_w,
	ds_brancos_40_w
;

--Header
select	lpad(coalesce(b.cd_conta,'0'),8,'0'),
	lpad(coalesce(b.cd_agencia_bancaria,'0'),4,'0'),
	coalesce(substr(b.ie_digito_conta,1,1),'0'),
	rpad(obter_nome_estabelecimento(cd_estabelecimento_p),30,' ') nm_empresa,
	to_char(clock_timestamp(), 'DDMMYY'),
	lpad(coalesce(substr(b.cd_convenio_banco,1,6),'0'),6,'0'),
	coalesce(a.nr_remessa,a.nr_sequencia),
	lpad(coalesce(b.cd_cedente,b.cd_conta || coalesce(b.ie_digito_conta,'0')),9,'0') cd_cedente
into STRICT	cd_conta_cobr_w,
	cd_agencia_cobr_w,
	ie_digito_conta_cobr_w,
	nm_empresa_w,
	dt_geracao_w,
	cd_convenio_banco_w,
	nr_remessa_w,
	cd_cedente_w
from	banco_estabelecimento b,
	cobranca_escritural a
where	a.nr_seq_conta_banco	= b.nr_sequencia
and	a.nr_sequencia		= nr_seq_cobr_escrit_p;

ds_conteudo_w	:= 	'01REMESSA01COBRANÃ‡A       ' || -- 1 - 26
			cd_agencia_cobr_w || -- 27 - 30
			'3' || -- 31 - 31
			cd_cedente_w || -- 32 - 40
			rpad(' ',6,' ') || -- 41 - 46
			nm_empresa_w ||	-- 47 - 76
			rpad('756BANCOOBCED',18,' ') ||	-- 77 - 94
			dt_geracao_w || -- 95 - 100
			lpad(nr_remessa_w,7,'0') || -- 101 - 107
			rpad(' ',287,' ') || -- 108 - 394
			lpad(nr_seq_reg_arquivo_w,6,'0'); -- 395 - 400
insert into w_envio_banco(	nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_estabelecimento,
		ds_conteudo,
		nr_seq_apres)
values (	nextval('w_envio_banco_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_p,
		ds_conteudo_w,
		nr_seq_reg_arquivo_w);
--Fim Header
--Detalhe
open C01;
loop
fetch C01 into
	nr_inscricao_empresa_w,
	cd_agencia_bancaria_w,
	cd_conta_w,
	ie_digito_conta_ww,
	nr_titulo_w,
	nr_nosso_numero_w,
	ie_dig_nosso_numero_w,
	dt_vencimento_w,
	vl_titulo_w ,
	dt_emissao_w,
	tx_mora_w,
	tx_juros_w,
	vl_desconto_w,
	ie_tipo_inscricao_w,
	nr_inscricao_w,
	nm_pagador_w,
	ds_endereco_w,
	ds_bairro_w,
	cd_cep_w,
	ds_municipio_w,
	sg_estado_w,
	cd_ocorrencia_w,
	cd_carteira_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;

	ds_conteudo_w	:=	'1' || -- 1 - 1
				'02' || -- 2 - 3
				nr_inscricao_empresa_w || -- 4 - 17
				cd_agencia_cobr_w || -- 18 - 21
				'3' || -- 22 - 22
				substr(cd_conta_cobr_w,1,8) || -- 23 - 30
				ie_digito_conta_cobr_w || -- 31 - 31
				'000000' || -- 32 - 37
				lpad(' ',25,' ') || -- 38 - 62
				lpad(coalesce(nr_nosso_numero_w,'0'),12,'0') || -- 63 - 74
				'01' || -- 75 - 76
				'00' || -- 77 - 78
				'   ' || -- 79 - 81
				' ' || -- 79 - 81
				'   ' || -- 82 - 85
				'000' || -- 86 - 88
				'0' || -- 89 - 89
				'00000' || -- 90 - 94
				'0' || -- 94 - 95
				lpad('0',6,'0') || -- 96 - 101
				'    ' || -- 102 - 105
				'2' || -- 106 - 106
				lpad(cd_carteira_w,2,'0') || -- 107 - 108
				lpad(cd_ocorrencia_w,2,'0') || -- 109 - 110
				lpad(coalesce(nr_titulo_w,'0'),10,'0') || -- 111 - 120
				dt_vencimento_w || -- 121 - 126
				vl_titulo_w || -- 127 - 139
				'756' || -- 140 - 142
				substr(lpad(cd_agencia_bancaria_w,4,'0'),1,4) || -- 143 - 146
				'0' || -- 147 - 147
				'99' || -- 148 - 149
				'0' || -- 150 - 150
				dt_emissao_w || -- 151 - 156
				'00' || -- 157 - 158
				'00' || -- 159 - 160
				tx_mora_w || -- 161 - 166
				tx_juros_w || -- 167 - 172
				'2' || -- 173 - 173
				'000000' || -- 174 - 179
				vl_desconto_w || -- 180 - 192
				'9000000000000' || -- 193 - 205
				'0000000000000' || -- 206 - 218
				ie_tipo_inscricao_w || -- 219 - 220
				nr_inscricao_w || -- 221 - 234
				nm_pagador_w || -- 235 - 274
				ds_endereco_w || -- 275 - 311
				ds_bairro_w || -- 312 - 326
				cd_cep_w || -- 327 - 334
				ds_municipio_w || -- 335 - 349
				substr(sg_estado_w,1,2) || -- 350 - 351
				ds_brancos_40_w || -- 352 - 391
				'00' || -- 392 - 393
				' ' || -- 394 - 394
				lpad(nr_seq_reg_arquivo_w,6,'0'); -- 395 - 400
	insert into w_envio_banco(	nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_estabelecimento,
			ds_conteudo,
			nr_seq_apres)
	values (	nextval('w_envio_banco_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_estabelecimento_p,
			ds_conteudo_w,
			nr_seq_reg_arquivo_w);

	end;

end loop;
close C01;
--Fim Detalhe
--Trailer
nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;

ds_conteudo_w	:= 	'9' ||
			ds_brancos_393_w ||
			lpad(nr_seq_reg_arquivo_w,6,'0');

insert	into w_envio_banco(	nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_estabelecimento,
		ds_conteudo,
		nr_seq_apres)
values (	nextval('w_envio_banco_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_p,
		ds_conteudo_w,
		nr_seq_reg_arquivo_w);

--Fim Trailer
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pam_gerar_cobr_sicoob_cnab_400 (nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

