-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_obter_dados_aud_analise ( nr_seq_conta_p pls_conta.nr_sequencia%type, nr_crm_auditor_p INOUT medico.nr_crm%type, nm_medico_auditor_p INOUT pessoa_fisica.nm_pessoa_fisica%type, cd_uf_crm_p INOUT medico.uf_crm%type, nr_coren_auditor_p INOUT medico.nr_crm%type, nm_enfer_auditor_p INOUT pessoa_fisica.nm_pessoa_fisica%type, cd_uf_coren_p INOUT medico.uf_crm%type) AS $body$
DECLARE

					

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[ ]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_analise_w		pls_analise_conta.nr_sequencia%type;
nr_seq_grupo_membro_med_w	pls_membro_grupo_aud.nr_sequencia%type;
nr_seq_grupo_membro_enf_w	pls_membro_grupo_aud.nr_sequencia%type;
qt_registro_w			integer;
nr_seq_w_pls_analise_w		w_pls_analise_rel_aud_int.nr_sequencia%type;

nr_crm_auditor_w		medico.nr_crm%type;
nm_medico_auditor_w		pessoa_fisica.nm_pessoa_fisica%type;
cd_uf_crm_w			medico.uf_crm%type;


BEGIN
nr_crm_auditor_p		:= null;
nm_medico_auditor_p		:= null;
cd_uf_crm_p			:= null;
nr_coren_auditor_p		:= null;
nm_enfer_auditor_p		:= null;
cd_uf_coren_p			:= null;
nr_seq_grupo_membro_med_w	:= null;
nr_seq_grupo_membro_enf_w	:= null;

select	count(1)
into STRICT	qt_registro_w
from	pls_conta_auditor
where	nr_seq_conta	= nr_seq_conta_p;

-- OPS - GESTAO DE CONTAS MEDICAS
if (qt_registro_w > 0) then
	select	max(nr_seq_grupo_membro_med),
		max(nr_seq_grupo_membro_enf)
	into STRICT	nr_seq_grupo_membro_med_w,
		nr_seq_grupo_membro_enf_w
	from	pls_conta_auditor
	where	nr_seq_conta	= nr_seq_conta_p;
	
	-- MEDICO
	if (nr_seq_grupo_membro_med_w IS NOT NULL AND nr_seq_grupo_membro_med_w::text <> '') then		
		begin
		select	substr(k.nr_crm,1,15) nr_crm,
			substr(e.nm_pessoa_fisica,1,40) nm_pessoa,
			k.uf_crm
		into STRICT	nr_crm_auditor_w,
			nm_medico_auditor_w,
			cd_uf_crm_w
		from	medico k,
			conselho_profissional c,
			pessoa_fisica e,
			usuario w,
			pls_membro_grupo_aud x
		where	w.nm_usuario		= x.nm_usuario_exec
		and	w.cd_pessoa_fisica	= e.cd_pessoa_fisica
		and	c.nr_sequencia		= e.nr_seq_conselho
		and	e.cd_pessoa_fisica	= k.cd_pessoa_fisica
		and	c.ie_conselho_prof_tiss	= 'CRM'
		and	x.ie_auditor_ptu	= 'S'
		and	x.nr_sequencia		= nr_seq_grupo_membro_med_w;
		exception
		when others then
			nr_crm_auditor_w := null;
			nm_medico_auditor_w := null;
			cd_uf_crm_w := null;
		end;
		
	end if;
	
	-- ENFERMEIRO
	if (nr_seq_grupo_membro_enf_w IS NOT NULL AND nr_seq_grupo_membro_enf_w::text <> '') then		
		begin
		select	substr(coalesce(k.nr_crm,e.ds_codigo_prof),1,15) nr_crm,
			substr(e.nm_pessoa_fisica,1,40) nm_pessoa,
			coalesce(k.uf_crm,e.uf_conselho) uf_crm
		into STRICT	nr_coren_auditor_p,
			nm_enfer_auditor_p,
			cd_uf_coren_p
		FROM pls_membro_grupo_aud x, usuario w, conselho_profissional c, pessoa_fisica e
LEFT OUTER JOIN medico k ON (e.cd_pessoa_fisica = k.cd_pessoa_fisica)
WHERE w.nm_usuario		= x.nm_usuario_exec and w.cd_pessoa_fisica	= e.cd_pessoa_fisica and c.nr_sequencia		= e.nr_seq_conselho  and c.ie_conselho_prof_tiss	= 'COREN' and x.ie_auditor_ptu	= 'S' and x.nr_sequencia		= nr_seq_grupo_membro_enf_w;	
		exception
		when others then
			nr_coren_auditor_p := null;
			nm_enfer_auditor_p := null;
			cd_uf_coren_p := null;
		end;
	end if;
end if;

-- SEMPRE DEVERA PROCURAR O MEDICO NA ANALISE POIS E MAIS PRIORITARIO DO QUE O MEDICO AUDITOR PTU
if (qt_registro_w = 0) or (coalesce(nm_medico_auditor_p::text, '') = '') then
	select	max(nr_seq_analise)
	into STRICT	nr_seq_analise_w
	from	pls_conta
	where	nr_sequencia	= nr_seq_conta_p;
	
	select	max(nr_sequencia)
	into STRICT	nr_seq_w_pls_analise_w
	from	w_pls_analise_rel_aud_int
	where	nr_seq_analise	= nr_seq_analise_w
	and	(nr_seq_grupo_membro_med IS NOT NULL AND nr_seq_grupo_membro_med::text <> '')
	and	(nr_seq_grupo_membro_enf IS NOT NULL AND nr_seq_grupo_membro_enf::text <> '');
	
	-- RELATORIO DE ANALISE
	if (nr_seq_w_pls_analise_w IS NOT NULL AND nr_seq_w_pls_analise_w::text <> '') then
		select	max(nr_seq_grupo_membro_med),
			max(nr_seq_grupo_membro_enf)
		into STRICT	nr_seq_grupo_membro_med_w,
			nr_seq_grupo_membro_enf_w
		from	w_pls_analise_rel_aud_int
		where	nr_sequencia	= nr_seq_w_pls_analise_w;
		
		-- MEDICO
		if (nr_seq_grupo_membro_med_w IS NOT NULL AND nr_seq_grupo_membro_med_w::text <> '') then		
			begin
			select	substr(k.nr_crm,1,15) nr_crm,
				substr(e.nm_pessoa_fisica,1,40) nm_pessoa,
				k.uf_crm
			into STRICT	nr_crm_auditor_p,
				nm_medico_auditor_p,
				cd_uf_crm_p
			from	medico k,
				conselho_profissional c,
				pessoa_fisica e,
				usuario w,
				pls_membro_grupo_aud x
			where	w.nm_usuario		= x.nm_usuario_exec
			and	w.cd_pessoa_fisica	= e.cd_pessoa_fisica
			and	c.nr_sequencia		= e.nr_seq_conselho
			and	e.cd_pessoa_fisica	= k.cd_pessoa_fisica
			and	c.ie_conselho_prof_tiss	= 'CRM'
			and	x.ie_auditor_ptu	= 'S'
			and	x.nr_sequencia		= nr_seq_grupo_membro_med_w;
			exception
			when others then
				nr_crm_auditor_p := null;
				nm_medico_auditor_p := null;
				cd_uf_crm_p := null;
			end;
			
		end if;
		
		-- se for enfermeiro e nao estiver como auditor PTU
		if ((nr_seq_grupo_membro_enf_w IS NOT NULL AND nr_seq_grupo_membro_enf_w::text <> '') and coalesce(nm_enfer_auditor_p::text, '') = '' and coalesce(nr_coren_auditor_p::text, '') = '') then		
			begin
			select	substr(coalesce(k.nr_crm,e.ds_codigo_prof),1,15) nr_crm,
				substr(e.nm_pessoa_fisica,1,40) nm_pessoa,
				coalesce(k.uf_crm,e.uf_conselho) uf_crm
			into STRICT	nr_coren_auditor_p,
				nm_enfer_auditor_p,
				cd_uf_coren_p
			FROM pls_membro_grupo_aud x, usuario w, conselho_profissional c, pessoa_fisica e
LEFT OUTER JOIN medico k ON (e.cd_pessoa_fisica = k.cd_pessoa_fisica)
WHERE w.nm_usuario		= x.nm_usuario_exec and w.cd_pessoa_fisica	= e.cd_pessoa_fisica and c.nr_sequencia		= e.nr_seq_conselho  and c.ie_conselho_prof_tiss	= 'COREN' and x.ie_auditor_ptu	= 'S' and x.nr_sequencia		= nr_seq_grupo_membro_enf_w;	
			exception
			when others then
				nr_coren_auditor_p := null;
				nm_enfer_auditor_p := null;
				cd_uf_coren_p := null;
			end;
		end if;

	-- OPS - GESTAO DE ANALISE DE PRODUCAO MEDICA
	elsif (nr_seq_analise_w IS NOT NULL AND nr_seq_analise_w::text <> '') then
		-- Ultimo Medico auditor
		begin
		select	max(nr_crm),
			max(nm_pessoa),
			max(uf_crm)
		into STRICT	nr_crm_auditor_p,
			nm_medico_auditor_p,
			cd_uf_crm_p
		from (SELECT	substr(k.nr_crm,1,15) nr_crm,
				substr(e.nm_pessoa_fisica,1,40) nm_pessoa,
				k.uf_crm
			from	medico k,
				conselho_profissional c,
				pessoa_fisica e,
				usuario w,
				pls_membro_grupo_aud x,
				pls_auditoria_conta_grupo s
			where	x.nr_sequencia		= s.nr_seq_grupo_membro
			and	w.nm_usuario		= x.nm_usuario_exec
			and	w.cd_pessoa_fisica	= e.cd_pessoa_fisica
			and	c.nr_sequencia		= e.nr_seq_conselho
			and	e.cd_pessoa_fisica	= k.cd_pessoa_fisica
			and	s.nr_seq_analise	= nr_seq_analise_w
			and	c.ie_conselho_prof_tiss	= 'CRM'
			and	x.ie_auditor_ptu	= 'S'
			order by
				s.nr_seq_ordem desc) alias6 LIMIT 1;
		exception
		when others then
			nr_crm_auditor_p	:= null;
			nm_medico_auditor_p	:= null;
			cd_uf_crm_p		:= null;
		end;
		
		if (coalesce(nr_crm_auditor_p::text, '') = '') and (coalesce(nm_medico_auditor_p::text, '') = '') then
			begin
			select	max(nr_crm),
				max(nm_pessoa),
				max(uf_crm)
			into STRICT	nr_crm_auditor_p,
				nm_medico_auditor_p,
				cd_uf_crm_p
			from (SELECT	substr(k.nr_crm,1,15) nr_crm,
					substr(e.nm_pessoa_fisica,1,40) nm_pessoa,
					k.uf_crm
				from	medico k,
					conselho_profissional c,
					pessoa_fisica e,
					usuario w,
					pls_membro_grupo_aud x,
					pls_auditoria_conta_grupo s
				where	x.nm_usuario_exec	= s.nm_auditor_atual
				and	x.nr_seq_grupo		= s.nr_seq_grupo
				and	w.nm_usuario		= x.nm_usuario_exec
				and	w.cd_pessoa_fisica	= e.cd_pessoa_fisica
				and	c.nr_sequencia		= e.nr_seq_conselho
				and	e.cd_pessoa_fisica	= k.cd_pessoa_fisica
				and	s.nr_seq_analise	= nr_seq_analise_w
				and	c.ie_conselho_prof_tiss	= 'CRM'
				and	x.ie_auditor_ptu	= 'S'
				order by
					s.nr_seq_ordem desc) alias9 LIMIT 1;
			exception
			when others then
				nr_crm_auditor_p	:= null;
				nm_medico_auditor_p	:= null;
				cd_uf_crm_p		:= null;
			end;
		end if;
		
		-- Ultimo Enfermeiro auditor
		if (coalesce(nr_coren_auditor_p::text, '') = '') and (coalesce(nm_enfer_auditor_p::text, '') = '') then
			begin
			select	max(nr_crm),
				max(nm_pessoa),
				max(uf_crm)
			into STRICT	nr_coren_auditor_p,
				nm_enfer_auditor_p,
				cd_uf_coren_p
			from (SELECT	substr(coalesce(k.nr_crm,e.ds_codigo_prof),1,15) nr_crm,
					substr(e.nm_pessoa_fisica,1,40) nm_pessoa,
					coalesce(k.uf_crm,e.uf_conselho) uf_crm
				FROM pls_membro_grupo_aud x, usuario w, pls_auditoria_conta_grupo s, conselho_profissional c, pessoa_fisica e
LEFT OUTER JOIN medico k ON (e.cd_pessoa_fisica = k.cd_pessoa_fisica)
WHERE x.nr_sequencia		= s.nr_seq_grupo_membro and w.nm_usuario		= x.nm_usuario_exec and w.cd_pessoa_fisica	= e.cd_pessoa_fisica and c.nr_sequencia		= e.nr_seq_conselho  and s.nr_seq_analise	= nr_seq_analise_w and c.ie_conselho_prof_tiss	= 'COREN' and x.ie_auditor_ptu	= 'S' order by
					s.nr_seq_ordem desc) alias11 LIMIT 1;
			exception
			when others then
				nr_coren_auditor_p	:= null;
				nm_enfer_auditor_p	:= null;
				cd_uf_coren_p		:= null;
			end;
		end if;
		
		if (coalesce(nr_coren_auditor_p::text, '') = '') and (coalesce(nm_enfer_auditor_p::text, '') = '') then
			begin
			select	max(nr_crm),
				max(nm_pessoa),
				max(uf_crm)
			into STRICT	nr_coren_auditor_p,
				nm_enfer_auditor_p,
				cd_uf_coren_p
			from (SELECT	substr(coalesce(k.nr_crm,e.ds_codigo_prof),1,15) nr_crm,
					substr(e.nm_pessoa_fisica,1,40) nm_pessoa,
					coalesce(k.uf_crm,e.uf_conselho) uf_crm
				FROM pls_membro_grupo_aud x, usuario w, pls_auditoria_conta_grupo s, conselho_profissional c, pessoa_fisica e
LEFT OUTER JOIN medico k ON (e.cd_pessoa_fisica = k.cd_pessoa_fisica)
WHERE x.nm_usuario_exec	= s.nm_auditor_atual and x.nr_seq_grupo		= s.nr_seq_grupo and w.nm_usuario		= x.nm_usuario_exec and w.cd_pessoa_fisica	= e.cd_pessoa_fisica and c.nr_sequencia		= e.nr_seq_conselho  and s.nr_seq_analise	= nr_seq_analise_w and c.ie_conselho_prof_tiss	= 'COREN' and x.ie_auditor_ptu	= 'S' order by
					s.nr_seq_ordem desc) alias11 LIMIT 1;
			exception
			when others then
				nr_coren_auditor_p	:= null;
				nm_enfer_auditor_p	:= null;
				cd_uf_coren_p		:= null;
			end;
		end if;

	-- OPS - PRODUCAO - RECURSO DE GLOSA
	elsif (coalesce(nr_seq_analise_w::text, '') = '') then
		select	max(nr_seq_grupo_membro_med),
			max(nr_seq_grupo_membro_enf)
		into STRICT	nr_seq_grupo_membro_med_w,
			nr_seq_grupo_membro_enf_w
		from	pls_rec_glosa_conta b,
			pls_rec_glosa_conta_aud a
		where	b.nr_sequencia	= a.nr_seq_conta_rec
		and	b.nr_seq_conta	= nr_seq_conta_p;
		
		-- MEDICO
		if (nr_seq_grupo_membro_med_w IS NOT NULL AND nr_seq_grupo_membro_med_w::text <> '') then			
			begin
			select	substr(k.nr_crm,1,15) nr_crm,
				substr(e.nm_pessoa_fisica,1,40) nm_pessoa,
				k.uf_crm
			into STRICT	nr_crm_auditor_p,
				nm_medico_auditor_p,
				cd_uf_crm_p
			from	medico k,
				conselho_profissional c,
				pessoa_fisica e,
				usuario w,
				pls_membro_grupo_aud x
			where	w.nm_usuario		= x.nm_usuario_exec
			and	w.cd_pessoa_fisica	= e.cd_pessoa_fisica
			and	c.nr_sequencia		= e.nr_seq_conselho
			and	e.cd_pessoa_fisica	= k.cd_pessoa_fisica
			and	c.ie_conselho_prof_tiss	= 'CRM'
			and	x.ie_auditor_ptu	= 'S'
			and	x.nr_sequencia		= nr_seq_grupo_membro_med_w;
			exception
			when others then
				nr_crm_auditor_p := null;
				nm_medico_auditor_p := null;
				cd_uf_crm_p := null;
			end;
		end if;
		
		-- ENFERMEIRO
		if ((nr_seq_grupo_membro_enf_w IS NOT NULL AND nr_seq_grupo_membro_enf_w::text <> '') and coalesce(nm_enfer_auditor_p::text, '') = '' and coalesce(nr_coren_auditor_p::text, '') = '') then		
			begin
			select	substr(coalesce(k.nr_crm,e.ds_codigo_prof),1,15) nr_crm,
				substr(e.nm_pessoa_fisica,1,40) nm_pessoa,
				coalesce(k.uf_crm,e.uf_conselho) uf_crm
			into STRICT	nr_coren_auditor_p,
				nm_enfer_auditor_p,
				cd_uf_coren_p
			FROM pls_membro_grupo_aud x, usuario w, conselho_profissional c, pessoa_fisica e
LEFT OUTER JOIN medico k ON (e.cd_pessoa_fisica = k.cd_pessoa_fisica)
WHERE w.nm_usuario		= x.nm_usuario_exec and w.cd_pessoa_fisica	= e.cd_pessoa_fisica and c.nr_sequencia		= e.nr_seq_conselho  and c.ie_conselho_prof_tiss	= 'COREN' and x.ie_auditor_ptu	= 'S' and x.nr_sequencia		= nr_seq_grupo_membro_enf_w;
			exception
			when others then
				nr_coren_auditor_p := null;
				nm_enfer_auditor_p := null;
				cd_uf_coren_p := null;
			end;
		end if;	
	end if;
end if;


-- se nao encontrou na analise, conta ou recurso de glosa, pega do auditor PTU
if (coalesce(nr_crm_auditor_p::text, '') = '') and (coalesce(nm_medico_auditor_p::text, '') = '') and (coalesce(cd_uf_crm_p::text, '') = '') and (nr_seq_grupo_membro_med_w IS NOT NULL AND nr_seq_grupo_membro_med_w::text <> '') then		
	
	nr_crm_auditor_p 	:= nr_crm_auditor_w;
	nm_medico_auditor_p 	:= nm_medico_auditor_w;
	cd_uf_crm_p		:= cd_uf_crm_w;	
end if;


nr_seq_grupo_membro_med_w := null;
nr_seq_grupo_membro_enf_w := null;

-- Regra de auditor do PTU - OPS - Faturamento
SELECT * FROM ptu_obter_regra_auditor_fat( nr_seq_conta_p, nr_seq_grupo_membro_med_w, nr_seq_grupo_membro_enf_w) INTO STRICT nr_seq_grupo_membro_med_w, nr_seq_grupo_membro_enf_w;

-- MEDICO
if (coalesce(nr_crm_auditor_p::text, '') = '') and (coalesce(nm_medico_auditor_p::text, '') = '') and (coalesce(cd_uf_crm_p::text, '') = '') and (nr_seq_grupo_membro_med_w IS NOT NULL AND nr_seq_grupo_membro_med_w::text <> '') then		
	begin
	select	substr(k.nr_crm,1,15) nr_crm,
		substr(e.nm_pessoa_fisica,1,40) nm_pessoa,
		k.uf_crm
	into STRICT	nr_crm_auditor_p,
		nm_medico_auditor_p,
		cd_uf_crm_p
	from	medico k,
		conselho_profissional c,
		pessoa_fisica e,
		usuario w,
		pls_membro_grupo_aud x
	where	w.nm_usuario		= x.nm_usuario_exec
	and	w.cd_pessoa_fisica	= e.cd_pessoa_fisica
	and	c.nr_sequencia		= e.nr_seq_conselho
	and	e.cd_pessoa_fisica	= k.cd_pessoa_fisica
	and	c.ie_conselho_prof_tiss	= 'CRM'
	and	x.ie_auditor_ptu	= 'S'
	and	x.nr_sequencia		= nr_seq_grupo_membro_med_w;
	exception
	when others then
		nr_crm_auditor_p := null;
		nm_medico_auditor_p := null;
		cd_uf_crm_p := null;
	end;
	
end if;

-- ENFERMEIRO
if (coalesce(nr_coren_auditor_p::text, '') = '') and (coalesce(nm_enfer_auditor_p::text, '') = '') and (coalesce(cd_uf_coren_p::text, '') = '') and (nr_seq_grupo_membro_enf_w IS NOT NULL AND nr_seq_grupo_membro_enf_w::text <> '') then		
	begin
	select	substr(coalesce(k.nr_crm,e.ds_codigo_prof),1,15) nr_crm,
		substr(e.nm_pessoa_fisica,1,40) nm_pessoa,
		coalesce(k.uf_crm,e.uf_conselho) uf_crm
	into STRICT	nr_coren_auditor_p,
		nm_enfer_auditor_p,
		cd_uf_coren_p
	FROM pls_membro_grupo_aud x, usuario w, conselho_profissional c, pessoa_fisica e
LEFT OUTER JOIN medico k ON (e.cd_pessoa_fisica = k.cd_pessoa_fisica)
WHERE w.nm_usuario		= x.nm_usuario_exec and w.cd_pessoa_fisica	= e.cd_pessoa_fisica and c.nr_sequencia		= e.nr_seq_conselho  and c.ie_conselho_prof_tiss	= 'COREN' and x.ie_auditor_ptu	= 'S' and x.nr_sequencia		= nr_seq_grupo_membro_enf_w;	
	exception
	when others then
		nr_coren_auditor_p := null;
		nm_enfer_auditor_p := null;
		cd_uf_coren_p := null;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_obter_dados_aud_analise ( nr_seq_conta_p pls_conta.nr_sequencia%type, nr_crm_auditor_p INOUT medico.nr_crm%type, nm_medico_auditor_p INOUT pessoa_fisica.nm_pessoa_fisica%type, cd_uf_crm_p INOUT medico.uf_crm%type, nr_coren_auditor_p INOUT medico.nr_crm%type, nm_enfer_auditor_p INOUT pessoa_fisica.nm_pessoa_fisica%type, cd_uf_coren_p INOUT medico.uf_crm%type) FROM PUBLIC;

