-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_evento_consist_req ( ie_tipo_evento_p pls_regra_geracao_evento.ie_evento_disparo%type, nr_seq_requisicao_p pls_requisicao.nr_sequencia%type, nm_usuario_p text) AS $body$
DECLARE

 
ie_tipo_guia_w			pls_requisicao.ie_tipo_guia%type;
ie_tipo_processo_w		pls_requisicao.ie_tipo_processo%type;
ie_estagio_req_w		pls_requisicao.ie_estagio%type;
dt_validade_senha_w		pls_requisicao.dt_validade_senha%type;
ie_tipo_intercambio_w		pls_requisicao.ie_tipo_intercambio%type;
nr_seq_prestador_w		pls_prestador.nr_sequencia%type;
nr_seq_regra_w			pls_regra_geracao_evento.nr_sequencia%type;
nr_seq_ocorr_benef_w		pls_ocorrencia_benef.nr_sequencia%type;
nr_seq_evento_mens_w		pls_alerta_evento_mensagem.nr_sequencia%type;
ds_mensagem_regra_w		pls_alerta_evento_mensagem.ds_mensagem%type;
ie_tipo_envio_w			pls_alerta_evento_mensagem.ie_tipo_envio%type;
ds_titulo_w			pls_alerta_evento_mensagem.ds_titulo%type;
ds_remetente_w			pls_alerta_evento_mensagem.ds_remetente_sms%type;
ds_email_remetente_w		pls_alerta_evento_mensagem.ds_remetente_email%type;
nr_seq_tipo_evento_w		pls_tipo_alerta_evento.nr_sequencia%type;
nr_seq_evento_controle_w	pls_alerta_evento_controle.nr_sequencia%type;
nr_seq_evento_dest_w		pls_alerta_evento_destino.nr_sequencia%type;
ie_forma_envio_w		pls_alerta_evento_destino.ie_forma_envio%type;
ds_email_dest_w			compl_pessoa_fisica.ds_email%type;
nm_beneficiario_w		pessoa_fisica.nm_pessoa_fisica%type;
nr_tel_celular_benef_w		pessoa_fisica.nr_telefone_celular%type;
cd_usuario_plano_w		pls_segurado_carteira.cd_usuario_plano%type;
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
cd_pessoa_fisica_w		pls_segurado.cd_pessoa_fisica%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
qt_macro_regra_w		integer := 0;
id_sms_w			bigint := null;
ie_ocorrencias_w		varchar(1) := 'S';
nr_pos_virgula_w		integer;
nm_usuario_destino_w		varchar(15);
nm_usuarios_lista_w		varchar(4000);
ie_carater_internacao_w	varchar(1);
ie_tipo_segurado_w		varchar(1);

c_regras_req CURSOR FOR 
	SELECT	nr_sequencia, 
		nr_seq_evento_mens 
	from	pls_regra_geracao_evento 
	where	ie_situacao			= 'A' 
	and	ie_evento_disparo		= ie_tipo_evento_p 
	and	((coalesce(ie_tipo_guia, 'X') 	= 'X') 	or (ie_tipo_guia = ie_tipo_guia_w)) 
	and	((coalesce(ie_tipo_processo, 'X') 	= 'X') 	or (ie_tipo_processo = ie_tipo_processo_w)) 
	and	((coalesce(ie_estagio_requisicao, 0) = 0) 	or (ie_estagio_requisicao = ie_estagio_req_w)) 
	and	((coalesce(ie_carater_internacao, 'X') = 'X') 	or (ie_carater_internacao = ie_carater_internacao_w)) 
	and	((coalesce(ie_tipo_segurado, 'X') = 'X') 	or (ie_tipo_segurado = ie_tipo_segurado_w)) 
	and	((coalesce(ie_tipo_intercambio::text, '') = '') 		or (ie_tipo_intercambio = ie_tipo_intercambio_w));

c_regra_ocorr_req CURSOR FOR 
	SELECT	nr_seq_ocorrencia 
	from	pls_regra_evento_ocor 
	where	nr_seq_regra_evento 	= nr_seq_regra_w 
	and	ie_situacao 		= 'A';

c_destino_mensagem CURSOR FOR 
	SELECT	nr_sequencia, 
		ie_forma_envio, 
		ie_tipo_pessoa_dest 
	from	pls_alerta_evento_destino 
	where	nr_seq_evento_mens	= nr_seq_evento_mens_w 
	and	ie_situacao 		= 'A';

c_alert_event_dest_fixo CURSOR FOR 
	SELECT	nm_usuario_destino 
	from	pls_alerta_event_dest_fixo 
	where	nr_seq_alerta_event_dest	= nr_seq_evento_dest_w;

BEGIN 
 
select	r.ie_tipo_guia, 
	r.ie_tipo_processo, 
	r.ie_estagio, 
	r.nr_seq_segurado, 
	r.dt_validade_senha, 
	r.nr_seq_prestador, 
	r.cd_estabelecimento, 
	r.ie_tipo_intercambio, 
	ie_carater_atendimento 
into STRICT	ie_tipo_guia_w, 
	ie_tipo_processo_w, 
	ie_estagio_req_w, 
	nr_seq_segurado_w, 
	dt_validade_senha_w, 
	nr_seq_prestador_w, 
	cd_estabelecimento_w, 
	ie_tipo_intercambio_w, 
	ie_carater_internacao_w 
from	pls_requisicao r 
where	r.nr_sequencia	= nr_seq_requisicao_p;
 
select 	ie_tipo_segurado 
into STRICT	ie_tipo_segurado_w 
from 	pls_segurado 
where	nr_sequencia = nr_seq_segurado_w;
 
begin 
	nm_beneficiario_w := substr(pls_obter_dados_segurado(nr_seq_segurado_w, 'N'),1,70);
exception 
when others then 
	nm_beneficiario_w := null;
end;
 
begin 
	cd_usuario_plano_w := substr(pls_obter_dados_segurado(nr_seq_segurado_w,'CR'),1,20);
exception 
when others then 
	cd_usuario_plano_w := null;
end;
 
begin 
	nr_tel_celular_benef_w := pls_obter_dados_segurado(nr_seq_segurado_w, 'TCD');
exception 
when others then 
	nr_tel_celular_benef_w := null;
end;
 
begin 
	cd_pessoa_fisica_w := pls_obter_dados_segurado(nr_seq_segurado_w, 'PF');
exception 
when others then 
	cd_pessoa_fisica_w := null;
end;
 
for regra_r in c_regras_req loop 
 
	nr_seq_regra_w := regra_r.nr_sequencia;
	nr_seq_evento_mens_w := regra_r.nr_seq_evento_mens;
 
	begin 
		select	ds_mensagem, 
			ie_tipo_envio, 
			ds_titulo, 
			nr_seq_tipo_evento, 
			ds_remetente_sms, 
			ds_remetente_email 
		into STRICT	ds_mensagem_regra_w, 
			ie_tipo_envio_w, 
			ds_titulo_w, 
			nr_seq_tipo_evento_w, 
			ds_remetente_w, 
			ds_email_remetente_w 
		from	pls_alerta_evento_mensagem 
		where 	nr_sequencia	= nr_seq_evento_mens_w 
		and	ie_situacao	= 'A';
	exception 
	when no_data_found then 
		ds_mensagem_regra_w	:= '';
		ie_tipo_envio_w		:= '';
		ds_titulo_w		:= '';
		nr_seq_tipo_evento_w	:= null;
		ds_remetente_w		:= '';
		ds_email_remetente_w	:= '';
	end;
 
	 
	if (nr_seq_tipo_evento_w IS NOT NULL AND nr_seq_tipo_evento_w::text <> '') then 
 
		for ocorrencia_r in c_regra_ocorr_req loop 
			begin 
				select	coalesce(nr_sequencia, 0) 
				into STRICT	nr_seq_ocorr_benef_w 
				from	pls_ocorrencia_benef 
				where	nr_seq_requisicao = nr_seq_requisicao_p 
				and	nr_seq_ocorrencia = ocorrencia_r.nr_seq_ocorrencia;
			exception 
			when no_data_found then 
				nr_seq_ocorr_benef_w := 0;
			end;
			 
			if (nr_seq_ocorr_benef_w = 0) then 
				ie_ocorrencias_w := 'N';
			end if;
		end loop; -- c_regra_ocorr_req 
		 
		if (ie_ocorrencias_w = 'S') then 
 
			for destino_mensagem_r in c_destino_mensagem loop 
 
				nr_seq_evento_dest_w := destino_mensagem_r.nr_sequencia;
 
				 
				if (destino_mensagem_r.ie_forma_envio = 'SMS') then 
					ds_remetente_w		:= substr(ds_remetente_w,0,40);
					nr_tel_celular_benef_w	:= substr(nr_tel_celular_benef_w,0,40);
 
					if (ds_remetente_w IS NOT NULL AND ds_remetente_w::text <> '') and (nr_tel_celular_benef_w IS NOT NULL AND nr_tel_celular_benef_w::text <> '') and (ds_mensagem_regra_w IS NOT NULL AND ds_mensagem_regra_w::text <> '') then 
 
						if (coalesce(nr_seq_evento_controle_w::text, '') = '') then 
 
							select	nextval('pls_alerta_evento_controle_seq') 
							into STRICT	nr_seq_evento_controle_w 
							;
 
							insert into pls_alerta_evento_controle(nr_sequencia, 
								dt_geracao_evento, 
								ie_evento_disparo, 
								nr_seq_tipo_evento, 
								dt_atualizacao, 
								nm_usuario, 
								dt_atualizacao_nrec, 
								nm_usuario_nrec, 
								ds_mensagem, 
								ds_titulo, 
								ie_tipo_envio) 
							values (nr_seq_evento_controle_w, 
								clock_timestamp(), 
								ie_tipo_evento_p, 
								nr_seq_tipo_evento_w, 
								clock_timestamp(), 
								nm_usuario_p, 
								clock_timestamp(), 
								nm_usuario_p, 
								ds_mensagem_regra_w, 
								ds_titulo_w, 
								ie_tipo_envio_w);
						end if;
 
						select	count(1) 
						into STRICT	qt_macro_regra_w 
						 
						where	ds_mensagem_regra_w like '%@%';
 
						if (qt_macro_regra_w > 0) then 
 
 
 
 
 
 
 
 
						 
							ds_mensagem_regra_w := pls_substituir_macros(ds_mensagem_regra_w, nr_seq_requisicao_p, null, null, null, null);
 
 
 
 
						end if;
 
						nr_tel_celular_benef_w	:= replace(nr_tel_celular_benef_w,'(','');
						nr_tel_celular_benef_w	:= replace(nr_tel_celular_benef_w,')','');
						nr_tel_celular_benef_w	:= replace(nr_tel_celular_benef_w,'-','');
 
						/* 
						IE_STATUS_ENVIO_P 
						E - Mensagem enviada 
						A - Aguardando envio 
						 
						IE_FORMA_ENVIO_P 
						EM - Email 
						CI - Comunicação interna 
						SMS - SMS 
						*/
 
 
						id_sms_w := pls_enviar_sms_alerta_evento(	ds_remetente_w, nr_tel_celular_benef_w, substr(ds_mensagem_regra_w,1,150), nr_seq_tipo_evento_w, nm_usuario_p, id_sms_w);
										 
						CALL pls_gerar_destino_evento(nr_seq_evento_controle_w, 
									'E', 
									destino_mensagem_r.ie_forma_envio, 
									nm_usuario_p, 
									cd_pessoa_fisica_w, 
									nm_usuario_destino_w, 
									ds_mensagem_regra_w, 
									id_sms_w, 
									nr_tel_celular_benef_w);
 
						if (nr_seq_requisicao_p IS NOT NULL AND nr_seq_requisicao_p::text <> '') then 
 
							CALL pls_requisicao_gravar_hist(	nr_seq_requisicao_p, 
											'AG', 
											'Remetente: ' || ds_remetente_w || chr(13) || chr(10) || 
											'Destino: ' || nr_tel_celular_benef_w || chr(13) || chr(10) || 
											'Mensagem: ' || chr(13) || chr(10) || 
											substr(ds_mensagem_regra_w,1,150), 
											null, 
											nm_usuario_p);
						end if;
					end if;
				end if;
 
				if (destino_mensagem_r.ie_forma_envio = 'EM') and (coalesce(ds_email_remetente_w,'X') <> 'X') then 
 
					select	count(1) 
					into STRICT	qt_macro_regra_w 
					 
					where	ds_mensagem_regra_w like '%@%';
 
					if (qt_macro_regra_w > 0) then 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
						ds_mensagem_regra_w := pls_substituir_macros(ds_mensagem_regra_w, nr_seq_requisicao_p, null, null, null, null);
					 
					end if;
 
					if (destino_mensagem_r.ie_tipo_pessoa_dest = 'BE') then 
 
						ds_email_dest_w := substr(pls_obter_dados_segurado(nr_seq_segurado_w,'E'), 0, 255);
 
						if (coalesce(ds_email_dest_w,'X') <> 'X') then 
								CALL enviar_email(	ds_titulo_w, ds_mensagem_regra_w, ds_email_remetente_w, 
										ds_email_dest_w, nm_usuario_p, 'M');
						end if;
 
					elsif (destino_mensagem_r.ie_tipo_pessoa_dest = 'PR') then 
 
						ds_email_dest_w := substr(pls_obter_dados_prestador(nr_seq_prestador_w,'M'), 0, 255);
 
						if (coalesce(ds_email_dest_w,'X') <> 'X') then 
							CALL enviar_email(	ds_titulo_w, ds_mensagem_regra_w, ds_email_remetente_w, 
									ds_email_dest_w, nm_usuario_p, 'M');
						end if;
					end if;
				end if;
 
				if (destino_mensagem_r.ie_forma_envio = 'CI') then 
 
					if (coalesce(nr_seq_evento_controle_w::text, '') = '') then 
 
						select	nextval('pls_alerta_evento_controle_seq') 
						into STRICT	nr_seq_evento_controle_w 
						;
 
						insert into pls_alerta_evento_controle(nr_sequencia, 
							dt_geracao_evento, 
							ie_evento_disparo, 
							nr_seq_tipo_evento, 
							dt_atualizacao, 
							nm_usuario, 
							dt_atualizacao_nrec, 
							nm_usuario_nrec, 
							ds_mensagem, 
							ds_titulo, 
							ie_tipo_envio) 
						values (nr_seq_evento_controle_w, 
							clock_timestamp(), 
							ie_tipo_evento_p, 
							nr_seq_tipo_evento_w, 
							clock_timestamp(), 
							nm_usuario_p, 
							clock_timestamp(), 
							nm_usuario_p, 
							ds_mensagem_regra_w, 
							ds_titulo_w, 
							ie_tipo_envio_w);
					end if;
 
					select	count(1) 
					into STRICT	qt_macro_regra_w 
					 
					where	ds_mensagem_regra_w like '%@%';
 
					 
					 
					if (qt_macro_regra_w > 0) then 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
					 
						ds_mensagem_regra_w := pls_substituir_macros(ds_mensagem_regra_w, nr_seq_requisicao_p, null, null, null, null);
						 
					end if;
					 
					 
 
					for evento_r in c_alert_event_dest_fixo loop 
						begin 
						if (evento_r.nm_usuario_destino IS NOT NULL AND evento_r.nm_usuario_destino::text <> '') and (ds_mensagem_regra_w IS NOT NULL AND ds_mensagem_regra_w::text <> '') then	 
 
							CALL gerar_comunic_padrao(	clock_timestamp(), 
										ds_titulo_w, 
										ds_mensagem_regra_w, 
										nm_usuario_p, 
										'N', 
										evento_r.nm_usuario_destino, 
										'N', 
										null, 
										null, 
										cd_estabelecimento_w, 
										null, 
										clock_timestamp(), 
										null, 
										null);
						end if;
 
						nm_usuarios_lista_w	:= evento_r.nm_usuario_destino || ',';
						 
 
						while(nm_usuarios_lista_w IS NOT NULL AND nm_usuarios_lista_w::text <> '') loop 
							begin 
							 
							nr_pos_virgula_w	:= position(',' in nm_usuarios_lista_w);
 
							if (nr_pos_virgula_w > 0) then 
 
								nm_usuario_destino_w	:= substr(nm_usuarios_lista_w,1,nr_pos_virgula_w-1);
								nm_usuarios_lista_w	:= substr(nm_usuarios_lista_w,nr_pos_virgula_w+1,length(nm_usuarios_lista_w));
 
								if (nm_usuario_destino_w IS NOT NULL AND nm_usuario_destino_w::text <> '') and (ds_mensagem_regra_w IS NOT NULL AND ds_mensagem_regra_w::text <> '') and (coalesce(nr_seq_evento_controle_w, 0) > 0) then 
 
									CALL pls_gerar_destino_evento(nr_seq_evento_controle_w, 
												'E', 
												destino_mensagem_r.ie_forma_envio, 
												nm_usuario_p, 
												cd_pessoa_fisica_w, 
												nm_usuario_destino_w, 
												ds_mensagem_regra_w, 
												null, 
												null);
								end if;
							end if;
							end;
						end loop;
						end;
					end loop; -- c_alert_event_dest_fixo 
				end if;
			end loop; -- c_destino_mensagem 
		end if;
	end if;
end loop; -- c_regras_req 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_evento_consist_req ( ie_tipo_evento_p pls_regra_geracao_evento.ie_evento_disparo%type, nr_seq_requisicao_p pls_requisicao.nr_sequencia%type, nm_usuario_p text) FROM PUBLIC;

