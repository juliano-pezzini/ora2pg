-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_cancelar_recurso_glosa ( nr_seq_ref_p pls_rec_glosa_protocolo.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


tb_nr_sequencia_w	pls_util_cta_pck.t_number_table;

C01 CURSOR FOR
	SELECT	a.nr_sequencia nr_seq_conta_rec,
		a.nr_seq_analise
	from	pls_rec_glosa_conta a
	where	a.nr_seq_protocolo = nr_seq_ref_p;

C02 CURSOR(nr_seq_conta_rec_pc		pls_rec_glosa_conta.nr_sequencia%type) FOR
	SELECT	nr_sequencia
	from	pls_rec_glosa_proc
	where	nr_seq_conta_rec = nr_seq_conta_rec_pc;

C03 CURSOR(nr_seq_conta_rec_pc		pls_rec_glosa_conta.nr_sequencia%type) FOR
	SELECT	nr_sequencia
	from	pls_rec_glosa_mat
	where	nr_seq_conta_rec = nr_seq_conta_rec_pc;

BEGIN

update 	pls_rec_glosa_protocolo
set	ie_status	= '10'
where	nr_sequencia	= nr_seq_ref_p;

for r_C01_w in C01 loop
	update	pls_rec_glosa_conta
	set	ie_status	= '3',
		dt_cancelamento	= clock_timestamp()
	where	nr_sequencia	= r_c01_w.nr_seq_conta_rec;

	if (r_C01_w.nr_seq_analise IS NOT NULL AND r_C01_w.nr_seq_analise::text <> '') then
		CALL pls_alterar_status_analise_cta(	r_c01_w.nr_seq_analise, 'C', 'PLS_CANCELAR_RECURSO_GLOSA',
						nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);
	end if;

	Open C02(r_c01_w.nr_seq_conta_rec);
	loop
		tb_nr_sequencia_w.delete;

		fetch C02 bulk collect into tb_nr_sequencia_w
		limit pls_util_pck.qt_registro_transacao_w;

		exit when tb_nr_sequencia_w.count = 0;

		forall i in tb_nr_sequencia_w.first .. tb_nr_sequencia_w.last
			update	pls_rec_glosa_proc
			set	ie_status = '5'
			where	nr_sequencia = tb_nr_sequencia_w(i);
		commit;
	end loop;
	close C02;

	Open C03(r_c01_w.nr_seq_conta_rec);
	loop
		tb_nr_sequencia_w.delete;

		fetch C03 bulk collect into tb_nr_sequencia_w
		limit pls_util_pck.qt_registro_transacao_w;

		exit when tb_nr_sequencia_w.count = 0;

		forall i in tb_nr_sequencia_w.first .. tb_nr_sequencia_w.last
			update	pls_rec_glosa_mat
			set	ie_status = '5'
			where	nr_sequencia = tb_nr_sequencia_w(i);
		commit;
	end loop;
	close C03;

	CALL pls_gerar_log_rec_glosa('C', null, r_C01_w.nr_seq_conta_rec, nm_usuario_p, 'C', null, null);
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cancelar_recurso_glosa ( nr_seq_ref_p pls_rec_glosa_protocolo.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

