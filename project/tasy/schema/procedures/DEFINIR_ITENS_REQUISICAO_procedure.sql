-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE definir_itens_requisicao ( nr_requisicao_p bigint, nm_usuario_p text, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, ie_saldo_zero_p text) AS $body$
DECLARE



cd_estabelecimento_w		integer;
cd_local_estoque_w		integer;
cd_centro_custo_w			integer;
cd_operacao_estoque_w		smallint;
ie_tipo_requisicao_w		varchar(3);
ie_consignado_w			varchar(1);
cd_setor_atendimento_w		integer;
dt_solicitacao_requisicao_w		timestamp;
cd_material_estoque_w		integer;
qt_estoque_w			double precision;
nr_sequencia_w			integer;
cd_unidade_medida_consumo_w	varchar(30);
cd_unidade_medida_estoque_w	varchar(30);
qt_conv_estoque_consumo_w	double precision;
ie_tipo_conta_w			varchar(1);
cd_conta_contabil_w		varchar(20);
cd_fornecedor_w			varchar(14);
qt_existe_w			integer;
ie_carregar_itens_saldo_w		varchar(1);

c01 CURSOR FOR
	SELECT	s.cd_material,
		s.qt_estoque,
		substr(obter_dados_material_estab(b.cd_material,cd_estabelecimento_w,'UMS'),1,30) cd_unidade_medida_consumo,
		substr(obter_dados_material_estab(b.cd_material,cd_estabelecimento_w,'UME'),1,30) cd_unidade_medida_estoque,
		b.qt_conv_estoque_consumo
	from	estrutura_material_v a,
		material b,
		saldo_estoque s
	where	s.dt_mesano_referencia	= trunc(clock_timestamp(),'mm')
	and	s.cd_local_estoque	= cd_local_estoque_w
	and	s.cd_estabelecimento	= cd_estabelecimento_w
	and	s.cd_material		= a.cd_material
	and	a.cd_material		= b.cd_material
	and	a.cd_grupo_material	= coalesce(cd_grupo_material_p, a.cd_grupo_material)
	and	a.cd_subgrupo_material	= coalesce(cd_subgrupo_material_p, a.cd_subgrupo_material)
	and	a.cd_classe_material	= coalesce(cd_classe_material_p, a.cd_classe_material)
	and	b.ie_situacao		= 'A'
	and	ie_consignado_w		= 'N'
	and	((ie_saldo_zero_p = 'N' and s.qt_estoque > 0) or (ie_saldo_zero_p = 'S'));


c02 CURSOR FOR
	SELECT	s.cd_material,
		s.qt_estoque,
		substr(obter_dados_material_estab(b.cd_material,cd_estabelecimento_w,'UMS'),1,30) cd_unidade_medida_consumo,
		substr(obter_dados_material_estab(b.cd_material,cd_estabelecimento_w,'UME'),1,30) cd_unidade_medida_estoque,
		b.qt_conv_estoque_consumo,
		s.cd_fornecedor
	from	estrutura_material_v a,
		material b,
		fornecedor_mat_consignado s
	where	s.dt_mesano_referencia	= trunc(clock_timestamp(),'mm')
	and	s.cd_local_estoque	= cd_local_estoque_w
	and	s.cd_estabelecimento	= cd_estabelecimento_w
	and	s.cd_material		= a.cd_material
	and	a.cd_material		= b.cd_material
	and	a.cd_grupo_material	= coalesce(cd_grupo_material_p, a.cd_grupo_material)
	and	a.cd_subgrupo_material	= coalesce(cd_subgrupo_material_p, a.cd_subgrupo_material)
	and	a.cd_classe_material	= coalesce(cd_classe_material_p, a.cd_classe_material)
	and	b.ie_situacao		= 'A'
	and	ie_consignado_w		= 'S'
	and	((ie_saldo_zero_p = 'N' and s.qt_estoque > 0) or (ie_saldo_zero_p = 'S'));



BEGIN

select	cd_estabelecimento,
	cd_local_estoque,
	cd_centro_custo,
	cd_operacao_estoque,
	Obter_se_requisicao_consignada(nr_requisicao_p),
	cd_setor_atendimento,
	dt_solicitacao_requisicao
into STRICT	cd_estabelecimento_w,
	cd_local_estoque_w,
	cd_centro_custo_w,
	cd_operacao_estoque_w,
	ie_consignado_w,
	cd_setor_atendimento_w,
	dt_solicitacao_requisicao_w
from	requisicao_material
where	nr_requisicao = nr_requisicao_p;

select	ie_tipo_requisicao
into STRICT	ie_tipo_requisicao_w
from	operacao_estoque
where	cd_operacao_estoque = cd_operacao_estoque_w;

ie_carregar_itens_saldo_w := substr(coalesce(obter_valor_param_usuario(919, 79, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w),'N'),1,1);

if (ie_carregar_itens_saldo_w <> 'T') and (ie_tipo_requisicao_w not in ('2','21')) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(182375);
	/*r.aise_application_error(-20011, 'Esta opção pode ser utilizada somente em requisições de transferência');*/

end if;

if (coalesce(ie_consignado_w,'N') = 'N') then
	begin
	open c01;
	loop
	fetch c01 into
		cd_material_estoque_w,
		qt_estoque_w,
		cd_unidade_medida_consumo_w,
		cd_unidade_medida_estoque_w,
		qt_conv_estoque_consumo_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		select	count(*)
		into STRICT	qt_existe_w
		from	item_requisicao_material
		where	nr_requisicao	= nr_requisicao_p
		and	cd_material	= cd_material_estoque_w;

		if (qt_existe_w = 0) then
			begin
			select	coalesce(max(nr_sequencia), 0) + 1
			into STRICT	nr_sequencia_w
			from	item_requisicao_material
			where	nr_requisicao	= nr_requisicao_p;

			ie_tipo_conta_w	:= '2';

			SELECT * FROM define_conta_material(
				cd_estabelecimento_w, cd_material_estoque_w, ie_tipo_conta_w, 0, cd_setor_atendimento_w, '0', 0, 0, 0, '', cd_local_estoque_w, cd_operacao_estoque_w, dt_solicitacao_requisicao_w, cd_conta_contabil_w, cd_centro_custo_w, '') INTO STRICT cd_conta_contabil_w, cd_centro_custo_w;

			insert into item_requisicao_material(
				nr_requisicao,
				nr_sequencia,
				cd_estabelecimento,
				cd_material,
				qt_material_requisitada,
				vl_material,
				dt_atualizacao,
				nm_usuario,
				cd_unidade_medida,
				cd_motivo_baixa,
				qt_estoque,
				cd_unidade_medida_estoque,
				cd_conta_contabil,
				cd_material_req,
				ie_geracao)
			values (	nr_requisicao_p,
				nr_sequencia_w,
				cd_estabelecimento_w,
				cd_material_estoque_w,
				qt_estoque_w,
				0,
				clock_timestamp(),
				nm_usuario_p,
				cd_unidade_medida_consumo_w,
				0,
				(qt_estoque_w * qt_conv_estoque_consumo_w),
				cd_unidade_medida_estoque_w,
				cd_conta_contabil_w,
				cd_material_estoque_w,
				'U');
			end;
		end if;
		end;
	end loop;
	close c01;
	end;

else
	begin
	open c02;
	loop
	fetch c02 into
		cd_material_estoque_w,
		qt_estoque_w,
		cd_unidade_medida_consumo_w,
		cd_unidade_medida_estoque_w,
		qt_conv_estoque_consumo_w,
		cd_fornecedor_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin

		select	count(*)
		into STRICT	qt_existe_w
		from	item_requisicao_material
		where	nr_requisicao	= nr_requisicao_p
		and	cd_material	= cd_material_estoque_w;

		if (qt_existe_w = 0) then
			begin

			select	coalesce(max(nr_sequencia), 0) + 1
			into STRICT	nr_sequencia_w
			from	item_requisicao_material
			where	nr_requisicao	= nr_requisicao_p;

			ie_tipo_conta_w	:= '2';

			SELECT * FROM define_conta_material(
				cd_estabelecimento_w, cd_material_estoque_w, ie_tipo_conta_w, 0, cd_setor_atendimento_w, '0', 0, 0, 0, '', cd_local_estoque_w, cd_operacao_estoque_w, dt_solicitacao_requisicao_w, cd_conta_contabil_w, cd_centro_custo_w, '') INTO STRICT cd_conta_contabil_w, cd_centro_custo_w;

			insert into item_requisicao_material(
				nr_requisicao,
				nr_sequencia,
				cd_estabelecimento,
				cd_material,
				qt_material_requisitada,
				vl_material,
				dt_atualizacao,
				nm_usuario,
				cd_cgc_fornecedor,
				cd_unidade_medida,
				cd_motivo_baixa,
				qt_estoque,
				cd_unidade_medida_estoque,
				cd_conta_contabil,
				cd_material_req,
				ie_geracao)
			values (	nr_requisicao_p,
				nr_sequencia_w,
				cd_estabelecimento_w,
				cd_material_estoque_w,
				qt_estoque_w,
				0,
				clock_timestamp(),
				nm_usuario_p,
				cd_fornecedor_w,
				cd_unidade_medida_consumo_w,
				0,
				(qt_estoque_w * qt_conv_estoque_consumo_w),
				cd_unidade_medida_estoque_w,
				cd_conta_contabil_w,
				cd_material_estoque_w,
				'U');
			end;
		end if;
		end;
	end loop;
	close c02;
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE definir_itens_requisicao ( nr_requisicao_p bigint, nm_usuario_p text, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, ie_saldo_zero_p text) FROM PUBLIC;

