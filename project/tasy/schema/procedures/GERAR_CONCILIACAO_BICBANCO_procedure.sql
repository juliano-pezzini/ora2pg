-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_conciliacao_bicbanco (nr_seq_extrato_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_agencia_w    	varchar(15);
cd_historico_w    	varchar(10);
ds_historico_w    	varchar(255);
nr_documento_w    	varchar(50);
dt_movto_w    		timestamp;
vl_extrato_w    	double precision;
ie_deb_cred_w    	varchar(5);
vl_saldo_inicial_w  	double precision;
vl_saldo_final_w  	double precision;
dt_saldo_inicial_w  	timestamp;
dt_saldo_final_w  	timestamp;
cd_conta_w    		banco_estabelecimento.cd_conta%type;
ie_digito_conta_w  	varchar(1);
nr_seq_conta_w    	bigint;
cd_agencia_bancaria_w  	varchar(5);
cd_banco_w		smallint;

c01 CURSOR FOR

SELECT	CASE WHEN substr(ds_conteudo,43,3)=100 THEN 'C'  ELSE 'D' END ,
	substr(ds_conteudo,46,4),
	substr(ds_conteudo,50,25),
	substr(ds_conteudo,75,6),
	substr(ds_conteudo,81,6),
	substr(ds_conteudo,87,18)
from	w_interf_concil
where	substr(ds_conteudo,1,1)				= '1'
and	substr(ds_conteudo,42,1)			= '1'
and  	substr(ds_conteudo,192,3)			= cd_banco_w
and  	substr(ds_conteudo,18,4)     			= cd_agencia_bancaria_w
and  	somente_numero(substr(ds_conteudo,22,19))	= somente_numero(cd_conta_w)
and  	substr(ds_conteudo,41,1)			= ie_digito_conta_w
and  	nr_seq_conta					= nr_seq_conta_w;


BEGIN

select	e.nr_seq_conta,
  	lpad(b.cd_agencia_bancaria,4,'0'),
  	b.cd_conta,
  	b.ie_digito_conta,
  	b.cd_banco
into STRICT  	nr_seq_conta_w,
  	cd_agencia_bancaria_w,
  	cd_conta_w,
  	ie_digito_conta_w,
  	cd_banco_w
from  	banco_extrato e,
  	banco_estabelecimento b
where  	e.nr_sequencia    = nr_seq_extrato_p
and  	e.nr_seq_conta    = b.nr_sequencia;

begin
select	substr(ds_conteudo,18,4),
	substr(ds_conteudo,22,19),
	substr(ds_conteudo,81,6),
	substr(ds_conteudo,87,18)
into STRICT	cd_agencia_w,
	cd_conta_w,
	dt_saldo_inicial_w,
	vl_saldo_inicial_w
from	w_interf_concil
where	substr(ds_conteudo,1,1) 	= '1'
and	substr(ds_conteudo,42,1) 	= '0'
and	substr(ds_conteudo,192,3) 	= cd_banco_w
and	substr(ds_conteudo,18,4) 	= cd_agencia_bancaria_w
and	somente_numero(substr(ds_conteudo,22,19)) 	= somente_numero(cd_conta_w)
and	substr(ds_conteudo,41,1) 	= ie_digito_conta_w
and	nr_seq_conta			= nr_seq_conta_w;

select	substr(ds_conteudo,18,4),
	substr(ds_conteudo,22,19),
	substr(ds_conteudo,81,6),
	substr(ds_conteudo,87,18)
into STRICT	cd_agencia_w,
	cd_conta_w,
	dt_saldo_final_w,
	vl_saldo_final_w
from	w_interf_concil
where	substr(ds_conteudo,1,1) 	= '1'
and	substr(ds_conteudo,42,1) 	= '2'
and	substr(ds_conteudo,192,3) 	= cd_banco_w
and	substr(ds_conteudo,18,4) 	= cd_agencia_bancaria_w
and	somente_numero(substr(ds_conteudo,22,19)) 	= somente_numero(cd_conta_w)
and	substr(ds_conteudo,41,1) 	= ie_digito_conta_w
and	nr_seq_conta			= nr_seq_conta_w;

exception
	when others then
	select	substr(ds_conteudo,192,3),
		substr(ds_conteudo,18,4),
		somente_numero(substr(ds_conteudo,22,19)),
		substr(ds_conteudo,41,1)
	into STRICT	cd_banco_w,
		cd_agencia_w,
		cd_conta_w,
		ie_digito_conta_w
	from	w_interf_concil
	where	substr(ds_conteudo,1,1) 	= '1'
	and	substr(ds_conteudo,42,1) 	= '2'
	and	nr_seq_conta			= nr_seq_conta_w;

	/*r.aise_application_error(-20011,'Os dados da conta não conferem com os dados do arquivo, favor verificar!' || chr(13) ||
				'Código do banco: ' || cd_banco_w || chr(13) ||
				'Número da agencia: ' || cd_agencia_bancaria_w || chr(13) ||
				'Número da conta: ' || cd_conta_w || chr(13) ||
				'Dígito da conta: ' || ie_digito_conta_w);*/
	CALL wheb_mensagem_pck.exibir_mensagem_abort(267410,	'cd_banco_w=' || cd_banco_w || ';' ||
								'cd_agencia_w=' || cd_agencia_w || ';' ||
								'cd_conta_w=' || cd_conta_w || ';' ||
								'ie_digito_conta_w=' || ie_digito_conta_w);
end;

open 	c01;
loop
fetch 	c01 into
	ie_deb_cred_w,
	cd_historico_w,
	ds_historico_w,
	nr_documento_w,
	dt_movto_w,
	vl_extrato_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

insert 	into banco_extrato_lanc(cd_agencia_origem,
	cd_historico,
	ds_historico,
	dt_atualizacao,
	dt_atualizacao_nrec,
	dt_movimento,
	ie_conciliacao,
	ie_deb_cred,
	nm_usuario,
	nm_usuario_nrec,
	nr_documento,
	nr_seq_extrato,
	nr_sequencia,
	vl_lancamento)
values (cd_agencia_w,
	cd_historico_w,
	ds_historico_w,
	clock_timestamp(),
	clock_timestamp(),
	dt_movto_w,
	'N',
	ie_deb_cred_w,
	nm_usuario_p,
	nm_usuario_p,
	nr_documento_w,
	nr_seq_extrato_p,
	nextval('banco_extrato_lanc_seq'),
	vl_extrato_w);
end	loop;
close 	c01;

update  banco_extrato
set	vl_saldo_inicial   	= vl_saldo_inicial_w,
  	vl_saldo_final    	= vl_saldo_final_w,
  	dt_inicio    		= dt_saldo_inicial_w,
  	dt_final    		= dt_saldo_final_w
where  	nr_sequencia    	= nr_seq_extrato_p;

end 	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_conciliacao_bicbanco (nr_seq_extrato_p bigint, nm_usuario_p text) FROM PUBLIC;

