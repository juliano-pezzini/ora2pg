-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE integra_operacao_protheus ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_cadastro_w		varchar(20);
ds_cadastro_w		varchar(80);
qt_registros_w		bigint;
cd_operacao_nf_w		smallint;
ie_operacao_w			varchar(15);
ie_erro_w			varchar(1) := 'N';


BEGIN

select	cd_cadastro,
	ds_cadastro,
	ie_operacao
into STRICT	cd_cadastro_w,
	ds_cadastro_w,
	ie_operacao_w
from	w_protheus_cadastro
where	nr_sequencia = nr_sequencia_p
and	tp_cadastro = 'OP';

if (coalesce(cd_cadastro_w::text, '') = '') then
	CALL gravar_log_protheus('ERRO', 'OP', WHEB_MENSAGEM_PCK.get_texto(309920) , nm_usuario_p); --O código da operação recebida do Protheus está vazia.
	ie_erro_w := 'S';
end if;

if (coalesce(ds_cadastro_w::text, '') = '') then
	CALL gravar_log_protheus('ERRO', 'OP', WHEB_MENSAGEM_PCK.get_texto(309921) , nm_usuario_p); --A descrição da operação recebida do Protheus está vazia.
	ie_erro_w := 'S';
end if;

if (ie_erro_w = 'N') and (cd_cadastro_w IS NOT NULL AND cd_cadastro_w::text <> '') and (ds_cadastro_w IS NOT NULL AND ds_cadastro_w::text <> '') then
	begin

	if (ie_operacao_w in ('I','A')) then

		select	count(*)
		into STRICT	qt_registros_w
		from	operacao_nota
		where	nr_documento_ext = cd_cadastro_w;

		if (qt_registros_w = 0) and (ie_operacao_w = 'I') then

			select	coalesce(max(cd_operacao_nf),0) + 1
			into STRICT	cd_operacao_nf_w
			from	operacao_nota;

			insert into operacao_nota(
				cd_operacao_nf,
				ds_operacao_nf,
				ie_contas_pagar,
				ie_contas_receber,
				ie_tipo_operacao,
				ie_devolucao,
				ie_servico,
				ie_bonificacao,
				ie_recusa,
				ie_transferencia_estab,
				ie_situacao,
				ie_numero_nota,
				ie_retem_iss,
				ie_nf_eletronica,
				ie_exige_ordem_compra,
				ie_exige_centro_loc_direto,
				ie_exige_contrato,
				ie_exige_atendimento_consig,
				ie_exige_consumo_consig,
				ie_exige_inspecao_receb,
				ie_exige_tipo_servico,
				ie_exige_anexo,
				ie_regra_lote_nf,
				ie_ultima_compra,
				ie_consistir_trib,
				ie_pergunta_nf_eletronica,
				ie_somente_provisao,
				ie_atualiza_tab_preco,
				nr_documento_ext,
				dt_atualizacao,
				nm_usuario,
				ie_exige_aval_dinamica,
				ie_ratear_ipi_nf_devol)
			values (
				cd_operacao_nf_w,
				substr(cd_cadastro_w || ' - ' || ds_cadastro_w,1,255),
				'S',
				'S',
				1,
				'N',
				'N',
				'N',
				'N',
				'S',
				'A',
				'S',
				'N',
				'N',
				'S',
				'S',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'S',
				'N',
				'N',
				'N',
				'S',
				cd_cadastro_w,
				clock_timestamp(),
				nm_usuario_p,
				'N',
				'N');
		end if;

		if (qt_registros_w > 0) and (ie_operacao_w = 'A') then

			update	operacao_nota
			set	ds_operacao_nf	= substr(cd_cadastro_w || ' - ' || ds_cadastro_w,1,255),
				ie_situacao	= 'A',
				dt_atualizacao	= clock_timestamp(),
				nm_usuario	= nm_usuario_p
			where	nr_documento_ext = cd_cadastro_w;

		end if;

	elsif (ie_operacao_w = 'E') then

		update	operacao_nota
		set	ie_situacao = 'I',
			dt_atualizacao = clock_timestamp(),
			nm_usuario = nm_usuario_p
		where	nr_documento_ext = cd_cadastro_w;

	end if;

	end;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE integra_operacao_protheus ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

