-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE carregar_fluxo_caixa_docto (cd_estabelecimento_p bigint, vl_saldo_anterior_p bigint, Dt_inicio_p timestamp, dt_final_p timestamp, nm_usuario_p text, cd_empresa_p bigint, ie_restringe_estab_p text, ie_periodo_p text, ie_todas_contas_p text, ie_tit_rec_p text, ie_tit_pagar_p text, ie_cheque_p text, ie_cartao_p text, ie_conv_receb_p text, ie_protocolo_p text, ie_ordem_compra_p text, ie_contrato_p text, ie_fluxo_especial_p text, ie_agenda_p text, ie_bordero_pagar_p text, ie_pagto_escrit_p text, ie_operacao_p text, ie_somente_ativa_p text, ie_tipo_fluxo_p text, ie_fluxo_vencido_p text, nr_seq_regra_p bigint default null, cd_moeda_p bigint default null, cd_estab_grupo_p text default null, cd_empresa_grupo_p text default null) AS $body$
DECLARE


/* Procedure para realizar o carregamento das informações do fluxo de caixa para apresentação no sistema. 
A mesma procedure será utilizada para todas as formas do fluxo, diferenciando qual rotina será chamada durante o processo. */


/* Tipos de Fluxo de Caixa 
R - Realizado
A - Realizar
O - Orçado
V - Vencido
RR - Realizado/Realizar
P - Previsto
PO - Passado/Orçado 
*/
ie_passado_real_w		parametro_fluxo_caixa.ie_passado_real%type;
ie_permite_fluxo_venc_w		varchar(1);
dt_referencia_w			timestamp;
cd_estabelecimentos_w varchar(1000);
ie_param_45		varchar(2) := 'DA';
data_vencido_w			timestamp;

c_grupo_empresas CURSOR FOR
    SELECT b.cd_empresa, b.cd_estabelecimento
        from estabelecimento b
        where obter_se_contido(b.cd_estabelecimento, cd_estabelecimentos_w) = 'S';

  r1 RECORD;
BEGIN


 if (ie_fluxo_vencido_p = 'S') then
	ie_param_45 := obter_param_usuario(830, 45, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_param_45);

	if (ie_param_45 = 'DI') then
		data_vencido_w := Dt_inicio_p;
	elsif (ie_param_45 = 'DA') then
		data_vencido_w := clock_timestamp() - interval '1 days';
	elsif (ie_param_45 = 'DF') then
		data_vencido_w := dt_final_p;
	end if;
end if;	

if (ie_periodo_p	= 'D') and
	((dt_final_p - dt_inicio_p) > 366) then
	/*Periodo Superior a 366 dias*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(235399);
end if;

    if (coalesce(cd_empresa_grupo_p::text, '') = '' and coalesce(cd_estab_grupo_p::text, '') = '')
        then
            select	coalesce(max(ie_passado_real), 'N')
            into STRICT	ie_passado_real_w
            from	parametro_fluxo_caixa
            where	cd_estabelecimento	= cd_estabelecimento_p;

            if (ie_tipo_fluxo_p = 'R') then
                CALL gerar_fluxo_caixa_doc_passado(cd_estabelecimento_p,
                            dt_inicio_p,
                            dt_final_p,
                            nm_usuario_p,
                            cd_empresa_p,
                            ie_restringe_estab_p,
                            vl_saldo_anterior_p,
                            ie_periodo_p,
                            'N',
                            ie_todas_contas_p,
                            ie_operacao_p,
                            ie_somente_ativa_p,
                            nr_seq_regra_p,
                            cd_moeda_p);
                if (ie_fluxo_vencido_p = 'S') then
                    CALL gerar_fluxo_caixa_vencido(cd_estabelecimento_p,
                                pkg_date_utils.get_date(1900,1,1,0),
                                nm_usuario_p,
                                cd_empresa_p,
                                ie_restringe_estab_p,
                                data_vencido_w,
                                ie_somente_ativa_p);
                end if;
            end if;

            if (ie_tipo_fluxo_p = 'A') then
                CALL gerar_fluxo_caixa_doc_real(cd_estabelecimento_p,
                            dt_inicio_p,
                                        dt_final_p,
                            nm_usuario_p,
                            cd_empresa_p,
                            ie_restringe_estab_p,
                            vl_saldo_anterior_p,
                            ie_periodo_p,
                            ie_todas_contas_p,
                            ie_passado_real_w,
                            ie_operacao_p,
                            ie_somente_ativa_p,
                            ie_tit_rec_p,
                            ie_tit_pagar_p,
                            ie_cheque_p,
                            ie_cartao_p,
                            ie_conv_receb_p,
                            ie_protocolo_p,
                            ie_ordem_compra_p,
                            ie_contrato_p,
                            ie_fluxo_especial_p,
                            ie_agenda_p,
                            ie_bordero_pagar_p,
                            ie_pagto_escrit_p,
                            'R',
                            nr_seq_regra_p);

                if (ie_fluxo_vencido_p = 'S') then
                    CALL gerar_fluxo_caixa_vencido(cd_estabelecimento_p,
                                pkg_date_utils.get_date(1900,1,1,0),
                                nm_usuario_p,
                                cd_empresa_p,
                                ie_restringe_estab_p,
                                data_vencido_w,
                                ie_somente_ativa_p);
                end if;
            end if;

            if (ie_tipo_fluxo_p = 'O') then
                CALL gerar_fluxo_caixa_orcado(cd_estabelecimento_p,
                            vl_saldo_anterior_p,
                            dt_inicio_p,
                            dt_final_p,
                            ie_periodo_p,
                            'O',
                            nm_usuario_p,
                            cd_empresa_p,
                            ie_restringe_estab_p,
                            ie_passado_real_w,
                            ie_todas_contas_p,
                            ie_somente_ativa_p);
            end if;

            if (ie_tipo_fluxo_p = 'V') then
                ie_permite_fluxo_venc_w := obter_param_usuario(830, 6, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_permite_fluxo_venc_w);
                if (ie_permite_fluxo_venc_w = 'N') then
                    CALL wheb_mensagem_pck.exibir_mensagem_abort(711141);
                end if;
                CALL gerar_fluxo_caixa_vencido(cd_estabelecimento_p,
                            dt_inicio_p,
                            nm_usuario_p,
                            cd_empresa_p,
                            ie_restringe_estab_p,
                            data_vencido_w,
                            ie_somente_ativa_p);
            end if;

            if (ie_tipo_fluxo_p = 'RR') then
                if (ie_passado_real_w = 'S') then
                    dt_referencia_w := clock_timestamp();
                else
                    dt_referencia_w := clock_timestamp() - interval '1 days';
                end if;
                if (ie_periodo_p = 'M') then
                    dt_referencia_w := fim_mes(dt_referencia_w);
                end if;

                CALL gerar_fluxo_caixa_doc_passado(cd_estabelecimento_p,
                            dt_inicio_p,
                            dt_referencia_w,
                            nm_usuario_p,
                            cd_empresa_p,
                            ie_restringe_estab_p,
                            vl_saldo_anterior_p,
                            ie_periodo_p,
                            'N',
                            ie_todas_contas_p,
                            ie_operacao_p,
                            ie_somente_ativa_p,
                            nr_seq_regra_p,
                            cd_moeda_p);

                CALL gerar_fluxo_caixa_doc_real(cd_estabelecimento_p,
                            dt_inicio_p,
                                        dt_final_p,
                            nm_usuario_p,
                            cd_empresa_p,
                            ie_restringe_estab_p,
                            vl_saldo_anterior_p,
                            ie_periodo_p,
                            ie_todas_contas_p,
                            ie_passado_real_w,
                            ie_operacao_p,
                            ie_somente_ativa_p,
                            ie_tit_rec_p,
                            ie_tit_pagar_p,
                            ie_cheque_p,
                            ie_cartao_p,
                            ie_conv_receb_p,
                            ie_protocolo_p,
                            ie_ordem_compra_p,
                            ie_contrato_p,
                            ie_fluxo_especial_p,
                            ie_agenda_p,
                            ie_bordero_pagar_p,
                            ie_pagto_escrit_p,
                            'R',
                            nr_seq_regra_p);
                if (ie_fluxo_vencido_p = 'S') then
                    CALL gerar_fluxo_caixa_vencido(cd_estabelecimento_p,
                                pkg_date_utils.get_date(1900,1,1,0),
                                nm_usuario_p,
                                cd_empresa_p,
                                ie_restringe_estab_p,
                                data_vencido_w,
                                ie_somente_ativa_p);
                end if;
            end if;

            if (ie_tipo_fluxo_p = 'P') then
                CALL gerar_fluxo_caixa_doc_real(cd_estabelecimento_p,
                            dt_inicio_p,
                                        dt_final_p,
                            nm_usuario_p,
                            cd_empresa_p,
                            ie_restringe_estab_p,
                            vl_saldo_anterior_p,
                            ie_periodo_p,
                            ie_todas_contas_p,
                            ie_passado_real_w,
                            ie_operacao_p,
                            ie_somente_ativa_p,
                            ie_tit_rec_p,
                            ie_tit_pagar_p,
                            ie_cheque_p,
                            ie_cartao_p,
                            ie_conv_receb_p,
                            ie_protocolo_p,
                            ie_ordem_compra_p,
                            ie_contrato_p,
                            ie_fluxo_especial_p,
                            ie_agenda_p,
                            ie_bordero_pagar_p,
                            ie_pagto_escrit_p,
                            'V',
                            nr_seq_regra_p);
                if (ie_fluxo_vencido_p = 'S') then
                    CALL gerar_fluxo_caixa_vencido(cd_estabelecimento_p,
                                pkg_date_utils.get_date(1900,1,1,0),
                                nm_usuario_p,
                                cd_empresa_p,
                                ie_restringe_estab_p,
                                data_vencido_w,
                                ie_somente_ativa_p);
                end if;
            end if;

            if (ie_tipo_fluxo_p = 'PO') then
                CALL gerar_fluxo_caixa_doc_passado(cd_estabelecimento_p,
                            dt_inicio_p,
                            dt_final_p,
                            nm_usuario_p,
                            cd_empresa_p,
                            ie_restringe_estab_p,
                            vl_saldo_anterior_p,
                            ie_periodo_p,
                            'N',
                            ie_todas_contas_p,
                            ie_operacao_p,
                            ie_somente_ativa_p,
                            nr_seq_regra_p,
                            cd_moeda_p);
            end if;
        else

            if (coalesce(cd_estab_grupo_p, '0') = '0') then
                if (coalesce(cd_empresa_grupo_p, '0') <> '0') then

                    for r1 in ( SELECT cd_estabelecimento
                                    from estabelecimento
                                    where  1=1
                                    and obter_se_contido(cd_empresa, cd_empresa_grupo_p) = 'S')
                        loop 

                            if (coalesce(cd_estabelecimentos_w::text, '') = '') then 
                                cd_estabelecimentos_w := r1.cd_estabelecimento;	
                            else
                                cd_estabelecimentos_w := cd_estabelecimentos_w || ',' || r1.cd_estabelecimento;	
                            end if;

                        end loop;

                end if;

            else
                cd_estabelecimentos_w:= cd_estab_grupo_p;
            end if;

            for r_grupo_empresas in c_grupo_empresas
                loop

            select	coalesce(max(ie_passado_real), 'N')
            into STRICT	ie_passado_real_w
            from	parametro_fluxo_caixa
            where	cd_estabelecimento	= cd_estabelecimento_p;

            if (ie_tipo_fluxo_p = 'R') then
                CALL gerar_fluxo_caixa_doc_passado(r_grupo_empresas.cd_estabelecimento,
                            dt_inicio_p,
                            dt_final_p,
                            nm_usuario_p,
                            r_grupo_empresas.cd_empresa,
                            ie_restringe_estab_p,
                            vl_saldo_anterior_p,
                            ie_periodo_p,
                            'N',
                            ie_todas_contas_p,
                            ie_operacao_p,
                            ie_somente_ativa_p,
                            nr_seq_regra_p,
                            cd_moeda_p);
                if (ie_fluxo_vencido_p = 'S') then
                    CALL gerar_fluxo_caixa_vencido(r_grupo_empresas.cd_estabelecimento,
                                pkg_date_utils.get_date(1900,1,1,0),
                                nm_usuario_p,
                                r_grupo_empresas.cd_empresa,
                                ie_restringe_estab_p,
                                data_vencido_w,
                                ie_somente_ativa_p);
                end if;
            end if;

            if (ie_tipo_fluxo_p = 'A') then
                CALL gerar_fluxo_caixa_doc_real(r_grupo_empresas.cd_estabelecimento,
                            dt_inicio_p,
                                        dt_final_p,
                            nm_usuario_p,
                            r_grupo_empresas.cd_empresa,
                            ie_restringe_estab_p,
                            vl_saldo_anterior_p,
                            ie_periodo_p,
                            ie_todas_contas_p,
                            ie_passado_real_w,
                            ie_operacao_p,
                            ie_somente_ativa_p,
                            ie_tit_rec_p,
                            ie_tit_pagar_p,
                            ie_cheque_p,
                            ie_cartao_p,
                            ie_conv_receb_p,
                            ie_protocolo_p,
                            ie_ordem_compra_p,
                            ie_contrato_p,
                            ie_fluxo_especial_p,
                            ie_agenda_p,
                            ie_bordero_pagar_p,
                            ie_pagto_escrit_p,
                            'R',
                            nr_seq_regra_p);

                if (ie_fluxo_vencido_p = 'S') then
                    CALL gerar_fluxo_caixa_vencido(r_grupo_empresas.cd_estabelecimento,
                                pkg_date_utils.get_date(1900,1,1,0),
                                nm_usuario_p,
                                r_grupo_empresas.cd_empresa,
                                ie_restringe_estab_p,
                                data_vencido_w,
                                ie_somente_ativa_p);
                end if;
            end if;

            if (ie_tipo_fluxo_p = 'O') then
                CALL gerar_fluxo_caixa_orcado(r_grupo_empresas.cd_estabelecimento,
                            vl_saldo_anterior_p,
                            dt_inicio_p,
                            dt_final_p,
                            ie_periodo_p,
                            'O',
                            nm_usuario_p,
                            r_grupo_empresas.cd_empresa,
                            ie_restringe_estab_p,
                            ie_passado_real_w,
                            ie_todas_contas_p,
                            ie_somente_ativa_p);
            end if;

            if (ie_tipo_fluxo_p = 'V') then
                ie_permite_fluxo_venc_w := obter_param_usuario(830, 6, obter_perfil_ativo, nm_usuario_p, r_grupo_empresas.cd_estabelecimento, ie_permite_fluxo_venc_w);
                if (ie_permite_fluxo_venc_w = 'N') then
                    CALL wheb_mensagem_pck.exibir_mensagem_abort(711141);
                end if;
                CALL gerar_fluxo_caixa_vencido(r_grupo_empresas.cd_estabelecimento,
                            dt_inicio_p,
                            nm_usuario_p,
                            r_grupo_empresas.cd_empresa,
                            ie_restringe_estab_p,
                            dt_final_p,
                            ie_somente_ativa_p);
            end if;

            if (ie_tipo_fluxo_p = 'RR') then
                if (ie_passado_real_w = 'S') then
                    dt_referencia_w := clock_timestamp();
                else
                    dt_referencia_w := clock_timestamp() - interval '1 days';
                end if;
                if (ie_periodo_p = 'M') then
                    dt_referencia_w := fim_mes(dt_referencia_w);
                end if;

                CALL gerar_fluxo_caixa_doc_passado(r_grupo_empresas.cd_estabelecimento,
                            dt_inicio_p,
                            dt_referencia_w,
                            nm_usuario_p,
                            r_grupo_empresas.cd_empresa,
                            ie_restringe_estab_p,
                            vl_saldo_anterior_p,
                            ie_periodo_p,
                            'N',
                            ie_todas_contas_p,
                            ie_operacao_p,
                            ie_somente_ativa_p,
                            nr_seq_regra_p,
                            cd_moeda_p);

                CALL gerar_fluxo_caixa_doc_real(r_grupo_empresas.cd_estabelecimento,
                            dt_inicio_p,
                                        dt_final_p,
                            nm_usuario_p,
                            r_grupo_empresas.cd_empresa,
                            ie_restringe_estab_p,
                            vl_saldo_anterior_p,
                            ie_periodo_p,
                            ie_todas_contas_p,
                            ie_passado_real_w,
                            ie_operacao_p,
                            ie_somente_ativa_p,
                            ie_tit_rec_p,
                            ie_tit_pagar_p,
                            ie_cheque_p,
                            ie_cartao_p,
                            ie_conv_receb_p,
                            ie_protocolo_p,
                            ie_ordem_compra_p,
                            ie_contrato_p,
                            ie_fluxo_especial_p,
                            ie_agenda_p,
                            ie_bordero_pagar_p,
                            ie_pagto_escrit_p,
                            'R',
                            nr_seq_regra_p);
                if (ie_fluxo_vencido_p = 'S') then
                    CALL gerar_fluxo_caixa_vencido(r_grupo_empresas.cd_estabelecimento,
                                pkg_date_utils.get_date(1900,1,1,0),
                                nm_usuario_p,
                                r_grupo_empresas.cd_empresa,
                                ie_restringe_estab_p,
                                data_vencido_w,
                                ie_somente_ativa_p);
                end if;
            end if;

            if (ie_tipo_fluxo_p = 'P') then
                CALL gerar_fluxo_caixa_doc_real(r_grupo_empresas.cd_estabelecimento,
                            dt_inicio_p,
                                        dt_final_p,
                            nm_usuario_p,
                            r_grupo_empresas.cd_empresa,
                            ie_restringe_estab_p,
                            vl_saldo_anterior_p,
                            ie_periodo_p,
                            ie_todas_contas_p,
                            ie_passado_real_w,
                            ie_operacao_p,
                            ie_somente_ativa_p,
                            ie_tit_rec_p,
                            ie_tit_pagar_p,
                            ie_cheque_p,
                            ie_cartao_p,
                            ie_conv_receb_p,
                            ie_protocolo_p,
                            ie_ordem_compra_p,
                            ie_contrato_p,
                            ie_fluxo_especial_p,
                            ie_agenda_p,
                            ie_bordero_pagar_p,
                            ie_pagto_escrit_p,
                            'V',
                            nr_seq_regra_p);
                if (ie_fluxo_vencido_p = 'S') then
                    CALL gerar_fluxo_caixa_vencido(r_grupo_empresas.cd_estabelecimento,
                                pkg_date_utils.get_date(1900,1,1,0),
                                nm_usuario_p,
                                r_grupo_empresas.cd_empresa,
                                ie_restringe_estab_p,
                                data_vencido_w,
                                ie_somente_ativa_p);
                end if;
            end if;

            if (ie_tipo_fluxo_p = 'PO') then
                CALL gerar_fluxo_caixa_doc_passado(r_grupo_empresas.cd_estabelecimento,
                            dt_inicio_p,
                            dt_final_p,
                            nm_usuario_p,
                            r_grupo_empresas.cd_empresa,
                            ie_restringe_estab_p,
                            vl_saldo_anterior_p,
                            ie_periodo_p,
                            'N',
                            ie_todas_contas_p,
                            ie_operacao_p,
                            ie_somente_ativa_p,
                            nr_seq_regra_p,
                            cd_moeda_p);
            end if;

        end loop;
	end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE carregar_fluxo_caixa_docto (cd_estabelecimento_p bigint, vl_saldo_anterior_p bigint, Dt_inicio_p timestamp, dt_final_p timestamp, nm_usuario_p text, cd_empresa_p bigint, ie_restringe_estab_p text, ie_periodo_p text, ie_todas_contas_p text, ie_tit_rec_p text, ie_tit_pagar_p text, ie_cheque_p text, ie_cartao_p text, ie_conv_receb_p text, ie_protocolo_p text, ie_ordem_compra_p text, ie_contrato_p text, ie_fluxo_especial_p text, ie_agenda_p text, ie_bordero_pagar_p text, ie_pagto_escrit_p text, ie_operacao_p text, ie_somente_ativa_p text, ie_tipo_fluxo_p text, ie_fluxo_vencido_p text, nr_seq_regra_p bigint default null, cd_moeda_p bigint default null, cd_estab_grupo_p text default null, cd_empresa_grupo_p text default null) FROM PUBLIC;

