-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_balancete_ecd ( cd_empresa_p bigint, cd_estab_p bigint, nr_seq_mes_ref_p bigint, cd_grupo_p bigint, nm_usuario_p text, ie_informacao_p text default 'A', ie_normal_encerramento_p text DEFAULT NULL) AS $body$
DECLARE



cd_classif_ecd_w			varchar(40);
cd_conta_contabil_w 			varchar(20);
cd_grupo_w				bigint;
ds_conta_referencial_w			varchar(255);
nr_nivel_w				bigint;
vl_movimento_w 				double precision;
vl_debito_w				double precision;
vl_credito_w				double precision;
vl_saldo_ant_w				double precision;
vl_saldo_w				double precision;
ie_normal_encerramento_w		varchar(2) := coalesce(ie_normal_encerramento_p, 'N');



c01 CURSOR FOR

SELECT	c.cd_classificacao,
	c.ds_conta_referencial,
	a.cd_conta_contabil,
	sum(CASE WHEN ie_normal_encerramento_w='N' THEN a.vl_movimento WHEN ie_normal_encerramento_w='E' THEN  a.vl_movimento - a.vl_encerramento END ),
	sum(a.vl_debito),
	sum(a.vl_credito),
	sum(CASE WHEN ie_normal_encerramento_w='N' THEN a.vl_saldo WHEN ie_normal_encerramento_w='E' THEN  a.vl_saldo - a.vl_encerramento END )
from	conta_contabil d,
	conta_contabil_referencial c,
	conta_contabil_classif_ecd b,
	ctb_saldo a
where	a.cd_conta_contabil		= b.cd_conta_contabil
and	c.cd_classificacao		= b.cd_classif_ecd
and	d.cd_conta_contabil		= a.cd_conta_contabil
and	d.cd_conta_contabil		= b.cd_conta_contabil
and (d.cd_grupo			= cd_grupo_w or cd_grupo_w = 0)
and	((a.cd_estabelecimento		= coalesce(cd_estab_p,0))
or (coalesce(cd_estab_p,0) = 0))
and	a.nr_seq_mes_ref		= nr_seq_mes_ref_p
and 	ie_informacao_p			= 'A'
group by c.cd_classificacao, c.ds_conta_referencial, a.cd_conta_contabil

union all

SELECT	c.cd_classificacao,
	c.ds_conta_referencial,
	'' cd_conta_contabil,
	sum(CASE WHEN ie_normal_encerramento_w='N' THEN a.vl_movimento WHEN ie_normal_encerramento_w='E' THEN  a.vl_movimento - a.vl_encerramento END ),
	sum(a.vl_debito),
	sum(a.vl_credito),
	sum(CASE WHEN ie_normal_encerramento_w='N' THEN a.vl_saldo WHEN ie_normal_encerramento_w='E' THEN  a.vl_saldo - a.vl_encerramento END )
from	conta_contabil d,
	conta_contabil_referencial c,
	conta_contabil_classif_ecd b,
	ctb_saldo a
where	a.cd_conta_contabil		= b.cd_conta_contabil
and	c.cd_classificacao		= b.cd_classif_ecd
and	d.cd_conta_contabil		= a.cd_conta_contabil
and	d.cd_conta_contabil		= b.cd_conta_contabil
and (d.cd_grupo			= cd_grupo_w or cd_grupo_w = 0)
and	((a.cd_estabelecimento		= coalesce(cd_estab_p,0))
or (coalesce(cd_estab_p,0) = 0))
and	a.nr_seq_mes_ref		= nr_seq_mes_ref_p
and 	ie_informacao_p			= 'S'
group by c.cd_classificacao, c.ds_conta_referencial;


BEGIN

cd_grupo_w	:= coalesce(cd_grupo_p,0);
vl_saldo_ant_w	:= 0;

delete 	FROM w_ctb_balancete
where	nm_usuario	= nm_usuario_p;


open c01;

loop
fetch c01 into
	cd_classif_ecd_w,
	ds_conta_referencial_w,
	cd_conta_contabil_w,
	vl_movimento_w,
	vl_debito_w,
	vl_credito_w,
	vl_saldo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	nr_nivel_w		:= CTB_OBTER_NIVEL_CLASSIF_CONTA(cd_classif_ecd_w);
	ds_conta_referencial_w	:= substr(lpad(' ', 2 * nr_nivel_w) || ds_conta_referencial_w,1,254);

	vl_saldo_ant_w	:= vl_saldo_w - vl_movimento_w;

	insert into w_ctb_balancete(
		cd_empresa,
		cd_estabelecimento,
		cd_conta_contabil,
		cd_classificacao,
		ds_conta_apres,
		vl_saldo_ant,
		vl_debito,
		vl_credito,
		vl_saldo,
		vl_movimento,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		dt_atualizacao,
		nm_usuario)
	values (cd_empresa_p,
		cd_estab_p,
		cd_conta_contabil_w,
		cd_classif_ecd_w,
		ds_conta_referencial_w,
		coalesce(vl_saldo_ant_w,0),
		coalesce(vl_debito_w,0),
		coalesce(vl_credito_w,0),
		coalesce(vl_saldo_w,0),
		coalesce(vl_movimento_w,0),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p);
	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_balancete_ecd ( cd_empresa_p bigint, cd_estab_p bigint, nr_seq_mes_ref_p bigint, cd_grupo_p bigint, nm_usuario_p text, ie_informacao_p text default 'A', ie_normal_encerramento_p text DEFAULT NULL) FROM PUBLIC;

