-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--
-- dblink wrapper to call function gerar_igc_rn as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE PROCEDURE gerar_igc_rn ( nr_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

BEGIN
	v_query := 'CALL gerar_igc_rn_atx ( ' || quote_nullable(nr_atendimento_p) || ',' || quote_nullable(nm_usuario_p) || ' )';
	PERFORM * FROM dblink(v_conn_str, v_query) AS p (ret boolean);

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE PROCEDURE gerar_igc_rn_atx ( nr_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
		 
ie_regra_w		varchar(10);
qt_dias_w		bigint;
qt_semanas_w	bigint;
cd_pessoa_fisica_w	varchar(10);
dt_correta_w		timestamp;		
qt_diferenca_w		bigint;
dt_nascimento_w		timestamp;
		
C01 CURSOR FOR 
	SELECT	ie_regra 
	from	REGRA_IGC 
	order by coalesce(NR_SEQ_PRIOR,99999);
BEGIN
begin 
open C01;
loop 
fetch C01 into	 
	ie_regra_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	 
	if (ie_regra_w	= 'NBS') then 
		select	max(qt_dias), 
				max(qt_semanas) 
		into STRICT	qt_dias_w, 
				qt_semanas_w 
		from	escala_nbs a 
		where	a.nr_sequencia	= (	SELECT	max(x.nr_sequencia) 
									from	escala_nbs x 
									where	x.nr_atendimento	= nr_atendimento_p 
									and	coalesce(x.dt_inativacao::text, '') = '');
									 
									 
 
	 
	elsif (ie_regra_w	= 'DUM') then 
	 
		select	max(QT_SEM_IG_TOTAL), 
				max(QT_DIA_IG_TOTAL) 
		into STRICT	qt_semanas_w, 
				qt_dias_w 
		from	nascimento 
		where	nr_atend_rn = nr_atendimento_p;
			 
	elsif (ie_regra_w	= 'CAP') then 
		select	max(QT_SEM_IG), 
				max(QT_DIA_IG) 
		into STRICT	qt_semanas_w, 
				qt_dias_w 
		from	nascimento 
		where	nr_atend_rn = nr_atendimento_p;
		 
	elsif (ie_regra_w	= 'US') then 
		select	max(b.QT_SEM_IG_ECOGRAFICA), 
        max(b.QT_IG_DIA_US) 
		into STRICT	qt_semanas_w, 
        qt_dias_w 
		from	nascimento a, 
				parto   b 
		where	a.nr_atendimento = b.nr_atendimento 
		and	  a.nr_atend_rn  = nr_atendimento_p;
	end if;
	 
	 
	if (qt_dias_w IS NOT NULL AND qt_dias_w::text <> '') or (qt_semanas_w IS NOT NULL AND qt_semanas_w::text <> '') then 
		exit;
	end if;
	 
	 
	end;
end loop;
close C01;
 
qt_semanas_w := coalesce(qt_semanas_w, 0);
qt_dias_w  := coalesce(qt_dias_w, 0);
 
if (ie_regra_w IS NOT NULL AND ie_regra_w::text <> '') and 
	((qt_dias_w IS NOT NULL AND qt_dias_w::text <> '') or (qt_semanas_w IS NOT NULL AND qt_semanas_w::text <> '')) and (coalesce(qt_semanas_w,0)	<= 36) and (coalesce(qt_dias_w,0)	<=6)then 
	select	max(cd_pessoa_fisica) 
	into STRICT	cd_pessoa_fisica_w 
	from	atendimento_paciente 
	where	nr_atendimento	= nr_atendimento_p;
	 
	if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then 
		 
		select	max(dt_nascimento) 
		into STRICT	dt_nascimento_w 
		from	pessoa_fisica 
		where	cd_pessoa_fisica = cd_pessoa_fisica_w;
		 
		 
		qt_diferenca_w	:= 280 - ((qt_semanas_w * 7) + qt_dias_w);
	 
		dt_correta_w	:= (dt_nascimento_w	+ qt_diferenca_w);
		update	pessoa_fisica 
		set		QT_DIAS_IG	= coalesce(qt_dias_w,0), 
				QT_SEMANAS_IG = coalesce(qt_semanas_w,0), 
				ie_regra_ig = ie_regra_w, 
				DT_NASCIMENTO_IG = dt_correta_w 
		where	cd_pessoa_fisica = cd_pessoa_fisica_w;
		 
 
		 
		 
	end if;
	 
end if;
commit;
exception 
when others then 
null;
end;
 
 
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_igc_rn ( nr_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC; -- REVOKE ALL ON PROCEDURE gerar_igc_rn_atx ( nr_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

