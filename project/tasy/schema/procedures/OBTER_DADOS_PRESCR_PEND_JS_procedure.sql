-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_dados_prescr_pend_js ( cd_estabelecimento_p bigint, ie_status_p bigint, ie_status_amostra_p text, ie_status_lista_seq_in_p text, ie_laudo_texto_p INOUT text, ie_status_baixa_p INOUT bigint, ie_gerar_result_prescr_p INOUT text, ie_padrao_amostra_p INOUT text, ie_ret_exame_lote_p INOUT text, ie_exame_amostra_p INOUT text, ie_forma_ordenacao_ms_p INOUT text, ie_ordem_antib_p INOUT text, ie_status_recoleta_p INOUT bigint, ie_nova_forma_em_recoleta_p INOUT text, ie_status_lista_seq_p INOUT bigint, qt_exame_etapa_amostra_p INOUT bigint, ie_possui_regra_estab_p INOUT text, ie_agrupa_ficha_fleury_p INOUT text, ie_gera_amostra_coleta_p INOUT text, ie_gera_sequencia_p INOUT text, ie_utiliza_richedit_result_p INOUT text, ie_integ_curva_amostra_p INOUT text, ie_restringe_estab_inter_p INOUT text, ds_obs_coleta_ext_p INOUT text, ie_atual_result_aprov_p INOUT text, ie_status_repeticao_p INOUT bigint, ie_etiqueta_uni_fleury_p INOUT lab_parametro.ie_etiqueta_uni_fleury%TYPE ) AS $body$
DECLARE

    ie_laudo_texto_w                varchar(1);
    ie_status_baixa_w               smallint;
    ie_gerar_result_prescr_w        varchar(1);
    ie_padrao_amostra_w             varchar(5);
    ie_ret_exame_lote_w             varchar(1);
    ie_exame_amostra_w              varchar(1);
    ie_forma_ordenacao_ms_w         varchar(1);
    ie_ordem_antib_w                varchar(5);
    ie_status_recoleta_w            smallint;
    ie_nova_forma_em_recoleta_w     varchar(1);
    ie_status_lista_seq_w           smallint := 0;
    qt_exame_etapa_amostra_w        smallint := 0;
    ie_possui_regra_estab_w         varchar(1);
    ie_agrupa_ficha_fleury_w        varchar(1);
    ie_etiqueta_uni_fleury_w        lab_parametro.ie_etiqueta_uni_fleury%TYPE;
    ie_gera_amostra_coleta_w        varchar(1);
    ie_gera_sequencia_w             varchar(1);
    ie_utiliza_richedit_result_w    varchar(1);
    ie_integ_curva_amostra_w        lab_parametro.ie_integ_curva_amostra%type;
    ie_restringe_estab_inter_w      lab_parametro.ie_restringe_estab_novo_inter%type;
    nm_fantasia_estab_w             estabelecimento.nm_fantasia_estab%type;
    ds_obs_coleta_ext_w             lab_parametro.ds_obs_coleta_ext%type;
    ie_atual_result_aprov_w         lab_parametro.ie_atual_result_aprov%type;
    ie_status_repeticao_w           lab_parametro.ie_status_repeticao%type;

BEGIN
    begin
        select  ie_laudo_texto,
            ie_status_baixa,
            ie_gerar_result_prescr,
            ie_padrao_amostra,
            ie_ret_exame_lote, 
            coalesce(ie_exame_amostra, 'N'),
            coalesce(ie_forma_ordenacao_ms, 'N'),
            coalesce(ie_ordem_antib || 'D', 'SRID'),
            coalesce(ie_status_recoleta,0), 
            coalesce(ie_nova_forma_em_recoleta,'N'),
            coalesce(ie_agrupa_ficha_fleury,'N'),
            coalesce(ie_etiqueta_uni_fleury,'N'),
            coalesce(IE_GERA_AMOSTRA_COLETA,'N'),
            coalesce(IE_GERAR_SEQUENCIA,'N'),
            coalesce(IE_UTILIZA_RICHEDIT_RESULT, 'N'),
            coalesce(ie_integ_curva_amostra,'N'),
            coalesce(ie_restringe_estab_novo_inter, 'N'),
            ds_obs_coleta_ext,
            coalesce(ie_atual_result_aprov, 'N'),
            coalesce(ie_status_repeticao,0)
        into STRICT
            ie_laudo_texto_w,
            ie_status_baixa_w,
            ie_gerar_result_prescr_w,
            ie_padrao_amostra_w,
            ie_ret_exame_lote_w,
            ie_exame_amostra_w,
            ie_forma_ordenacao_ms_w,
            ie_ordem_antib_w,
            ie_status_recoleta_w,
            ie_nova_forma_em_recoleta_w,
            ie_agrupa_ficha_fleury_w,
            ie_etiqueta_uni_fleury_w,
            ie_gera_amostra_coleta_w,
            ie_gera_sequencia_w,
            ie_utiliza_richedit_result_w,
            ie_integ_curva_amostra_w,
            ie_restringe_estab_inter_w,
            ds_obs_coleta_ext_w,
            ie_atual_result_aprov_w,
            ie_status_repeticao_w
        from lab_parametro 
        where cd_estabelecimento = cd_estabelecimento_p;

    exception
        when no_data_found then
            select MAX(nm_fantasia_estab)
            into STRICT nm_fantasia_estab_w
            from estabelecimento
            where cd_estabelecimento = cd_estabelecimento_p;

            CALL wheb_mensagem_pck.exibir_mensagem_abort(318592,'DS_ESTABELECIMENTO='||nm_fantasia_estab_w);
    end;

    ie_laudo_texto_p             := ie_laudo_texto_w;
    ie_status_baixa_p            := ie_status_baixa_w;
    ie_gerar_result_prescr_p     := ie_gerar_result_prescr_w;
    ie_padrao_amostra_p          := ie_padrao_amostra_w;
    ie_ret_exame_lote_p          := ie_ret_exame_lote_w;
    ie_exame_amostra_p           := ie_exame_amostra_w;
    ie_forma_ordenacao_ms_p      := ie_forma_ordenacao_ms_w;
    ie_ordem_antib_p             := ie_ordem_antib_w;
    ie_status_recoleta_p         := ie_status_recoleta_w;
    ie_nova_forma_em_recoleta_p  := ie_nova_forma_em_recoleta_w;
    ie_agrupa_ficha_fleury_p     := ie_agrupa_ficha_fleury_w;
    ie_etiqueta_uni_fleury_p     := ie_etiqueta_uni_fleury_w;
    ie_gera_amostra_coleta_p     := ie_gera_amostra_coleta_w;
    ie_gera_sequencia_p          := ie_gera_sequencia_w;
    ie_utiliza_richedit_result_p := ie_utiliza_richedit_result_w;
    ie_integ_curva_amostra_p     := ie_integ_curva_amostra_w;
    ie_restringe_estab_inter_p   := ie_restringe_estab_inter_w;
    ds_obs_coleta_ext_p          := ds_obs_coleta_ext_w;
    ie_atual_result_aprov_p      := ie_atual_result_aprov_w;
    ie_status_repeticao_p        := ie_status_repeticao_w;

    if (ie_status_lista_seq_in_p IS NOT NULL AND ie_status_lista_seq_in_p::text <> '') and (Obter_Se_Contido_char(to_char(ie_status_p),ie_status_lista_seq_in_p) = 'N') then
        ie_status_lista_seq_w := 1;
    end if;

    if (ie_padrao_amostra_p = 'AMO9') or (ie_padrao_amostra_p = 'AMO11') or (ie_padrao_amostra_p = 'AMO13') or (ie_padrao_amostra_p = 'AM11F') or (ie_padrao_amostra_p = 'AM10F') or (ie_padrao_amostra_p = 'AMO10') or (ie_padrao_amostra_p = 'EAM10') or (ie_padrao_amostra_p = 'WEB') then
        if (Obter_Se_Contido_char(to_char(ie_status_p),ie_status_amostra_p) = 'S') then --VarIe_Status_Amostra prametro[53]
            qt_exame_etapa_amostra_w := 1;
        end if;

        qt_exame_etapa_amostra_p := qt_exame_etapa_amostra_w;
    end if;

    select coalesce(max('S'),'N')
    into STRICT ie_possui_regra_estab_w
    from regra_exame_lab_estab
    where cd_estabelecimento = cd_estabelecimento_p;

    ie_possui_regra_estab_p   := ie_possui_regra_estab_w;
    ie_status_lista_seq_p     := ie_status_lista_seq_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_dados_prescr_pend_js ( cd_estabelecimento_p bigint, ie_status_p bigint, ie_status_amostra_p text, ie_status_lista_seq_in_p text, ie_laudo_texto_p INOUT text, ie_status_baixa_p INOUT bigint, ie_gerar_result_prescr_p INOUT text, ie_padrao_amostra_p INOUT text, ie_ret_exame_lote_p INOUT text, ie_exame_amostra_p INOUT text, ie_forma_ordenacao_ms_p INOUT text, ie_ordem_antib_p INOUT text, ie_status_recoleta_p INOUT bigint, ie_nova_forma_em_recoleta_p INOUT text, ie_status_lista_seq_p INOUT bigint, qt_exame_etapa_amostra_p INOUT bigint, ie_possui_regra_estab_p INOUT text, ie_agrupa_ficha_fleury_p INOUT text, ie_gera_amostra_coleta_p INOUT text, ie_gera_sequencia_p INOUT text, ie_utiliza_richedit_result_p INOUT text, ie_integ_curva_amostra_p INOUT text, ie_restringe_estab_inter_p INOUT text, ds_obs_coleta_ext_p INOUT text, ie_atual_result_aprov_p INOUT text, ie_status_repeticao_p INOUT bigint, ie_etiqueta_uni_fleury_p INOUT lab_parametro.ie_etiqueta_uni_fleury%TYPE ) FROM PUBLIC;

