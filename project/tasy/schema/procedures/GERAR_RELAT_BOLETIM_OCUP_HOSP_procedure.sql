-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_relat_boletim_ocup_hosp (cd_estabelecimento_p bigint, nr_ano_p text, cd_setor_atendimento_p text) AS $body$
DECLARE


cd_setor_w			integer;
nr_leitos_w			bigint;
nr_leitos_ocup_w		bigint;
qt_perc_ocup_w		smallint;
nr_leitos_tot_jan_w		bigint 	:= 0;
nr_leitos_ocup_tot_jan_w	bigint 	:= 0;
nr_leitos_tot_fev_w		bigint 	:= 0;
nr_leitos_ocup_tot_fev_w	bigint 	:= 0;
nr_leitos_tot_mar_w		bigint 	:= 0;
nr_leitos_ocup_tot_mar_w	bigint 	:= 0;
nr_leitos_tot_abr_w		bigint 	:= 0;
nr_leitos_ocup_tot_abr_w	bigint 	:= 0;
nr_leitos_tot_mai_w		bigint 	:= 0;
nr_leitos_ocup_tot_mai_w	bigint 	:= 0;
nr_leitos_tot_jun_w		bigint 	:= 0;
nr_leitos_ocup_tot_jun_w	bigint 	:= 0;
nr_leitos_tot_jul_w		bigint 	:= 0;
nr_leitos_ocup_tot_jul_w	bigint 	:= 0;
nr_leitos_tot_ago_w		bigint 	:= 0;
nr_leitos_ocup_tot_ago_w	bigint 	:= 0;
nr_leitos_tot_set_w		bigint 	:= 0;
nr_leitos_ocup_tot_set_w	bigint 	:= 0;
nr_leitos_tot_out_w		bigint 	:= 0;
nr_leitos_ocup_tot_out_w	bigint 	:= 0;
nr_leitos_tot_nov_w		bigint 	:= 0;
nr_leitos_ocup_tot_nov_w	bigint 	:= 0;
nr_leitos_tot_dez_w		bigint 	:= 0;
nr_leitos_ocup_tot_dez_w	bigint 	:= 0;
qt_setor_w			bigint;
nr_mes_w			smallint	:= 1;
dt_inicial_w			timestamp;
dt_final_w			timestamp;

c01 CURSOR FOR
SELECT	a.cd_setor_atendimento cd_setor,
	coalesce(sum(CASE WHEN a.ie_temp='S' THEN  a.nr_leitos_ocupados  ELSE a.nr_unidades_setor END ),0) nr_leitos,
	coalesce(sum(a.nr_leitos_ocupados),0) nr_leitos_ocup,
	coalesce(dividir(sum(a.nr_leitos_ocupados)*100, sum(CASE WHEN a.ie_temp='S' THEN  a.nr_leitos_ocupados  ELSE a.nr_unidades_setor END )),0) qt_perc_ocup
from 	setor_atendimento b,
	eis_ocupacao_setor_v a
where	b.cd_setor_atendimento	= a.cd_setor_atendimento
and	b.ie_situacao			= 'A'
and	a.ie_ocup_hospitalar		= 'S'
and	a.ie_periodo			= 'D'
and	((coalesce(cd_setor_atendimento_p::text, '') = '') or (obter_se_contido(a.cd_setor_atendimento, cd_setor_atendimento_p) = 'S'))
and	a.dt_referencia		between dt_inicial_w and dt_final_w
and	a.cd_estabelecimento 		= cd_estabelecimento_p
and	a.ie_situacao			<> 'I'
group by
	a.cd_setor_atendimento
order by
	a.cd_setor_atendimento;


BEGIN
if (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') and (nr_ano_p IS NOT NULL AND nr_ano_p::text <> '') then
	/* limpar tabela */

	delete from w_relat_boletim_ocup_hosp; commit;

	while	nr_mes_w < 13 loop
		begin
		dt_inicial_w	:= to_date('01/' || to_char(nr_mes_w) || '/' || nr_ano_p,'dd/mm/yyyy');
		dt_final_w	:= last_day(to_date('01/' || to_char(nr_mes_w) || '/' || nr_ano_p,'dd/mm/yyyy'));
		open c01;
		loop
		fetch c01 into	cd_setor_w,
					nr_leitos_w,
					nr_leitos_ocup_w,
					qt_perc_ocup_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
			begin
			/* verificar setor tabela temporária */

			select	coalesce(count(*),0)
			into STRICT	qt_setor_w
			from	w_relat_boletim_ocup_hosp
			where	cd_setor_atendimento	= cd_setor_w;

			/* gerar primeiro registro na tabela temporária */

			if (qt_setor_w = 0) then
				insert into w_relat_boletim_ocup_hosp(
										cd_setor_atendimento,
										ds_setor_atendimento,
										nr_leitos_jan,
										nr_leitos_ocup_jan,
										qt_perc_ocup_jan,
										nr_leitos_tot_jan,
										nr_leitos_ocup_tot_jan,
										nr_leitos_fev,
										nr_leitos_ocup_fev,
										qt_perc_ocup_fev,
										nr_leitos_tot_fev,
										nr_leitos_ocup_tot_fev,
										nr_leitos_mar,
										nr_leitos_ocup_mar,
										qt_perc_ocup_mar,
										nr_leitos_tot_mar,
										nr_leitos_ocup_tot_mar,
										nr_leitos_abr,
										nr_leitos_ocup_abr,
										qt_perc_ocup_abr,
										nr_leitos_tot_abr,
										nr_leitos_ocup_tot_abr,
										nr_leitos_mai,
										nr_leitos_ocup_mai,
										qt_perc_ocup_mai,
										nr_leitos_tot_mai,
										nr_leitos_ocup_tot_mai,
										nr_leitos_jun,
										nr_leitos_ocup_jun,
										qt_perc_ocup_jun,
										nr_leitos_tot_jun,
										nr_leitos_ocup_tot_jun,
										nr_leitos_jul,
										nr_leitos_ocup_jul,
										qt_perc_ocup_jul,
										nr_leitos_tot_jul,
										nr_leitos_ocup_tot_jul,
										nr_leitos_ago,
										nr_leitos_ocup_ago,
										qt_perc_ocup_ago,
										nr_leitos_tot_ago,
										nr_leitos_ocup_tot_ago,
										nr_leitos_set,
										nr_leitos_ocup_set,
										qt_perc_ocup_set,
										nr_leitos_tot_set,
										nr_leitos_ocup_tot_set,
										nr_leitos_out,
										nr_leitos_ocup_out,
										qt_perc_ocup_out,
										nr_leitos_tot_out,
										nr_leitos_ocup_tot_out,
										nr_leitos_nov,
										nr_leitos_ocup_nov,
										qt_perc_ocup_nov,
										nr_leitos_tot_nov,
										nr_leitos_ocup_tot_nov,
										nr_leitos_dez,
										nr_leitos_ocup_dez,
										qt_perc_ocup_dez,
										nr_leitos_tot_dez,
										nr_leitos_ocup_tot_dez
										)
									values (
										cd_setor_w,
										substr(obter_nome_setor(cd_setor_w),1,100),
										0, 0, 0, 0, 0,
										0, 0, 0, 0, 0,
										0, 0, 0, 0, 0,
										0, 0, 0, 0, 0,
										0, 0, 0, 0, 0,
										0, 0, 0, 0, 0,
										0, 0, 0, 0, 0,
										0, 0, 0, 0, 0,
										0, 0, 0, 0, 0,
										0, 0, 0, 0, 0,
										0, 0, 0, 0, 0,
										0, 0, 0, 0, 0
										);
			end if;

			/* atualizar valores mensais */

			if (nr_mes_w = 1) then
				update	w_relat_boletim_ocup_hosp
				set	nr_leitos_jan		= coalesce(nr_leitos_w,0),
					nr_leitos_ocup_jan	= coalesce(nr_leitos_ocup_w,0),
					qt_perc_ocup_jan	= coalesce(qt_perc_ocup_w,0)
				where	cd_setor_atendimento	= cd_setor_w;
				nr_leitos_tot_jan_w		:= coalesce(nr_leitos_tot_jan_w,0) + coalesce(nr_leitos_w,0);
				nr_leitos_ocup_tot_jan_w	:= coalesce(nr_leitos_ocup_tot_jan_w,0) + coalesce(nr_leitos_ocup_w,0);

			elsif (nr_mes_w = 2) then
				update	w_relat_boletim_ocup_hosp
				set	nr_leitos_fev		= coalesce(nr_leitos_w,0),
					nr_leitos_ocup_fev	= coalesce(nr_leitos_ocup_w,0),
					qt_perc_ocup_fev	= coalesce(qt_perc_ocup_w,0)
				where	cd_setor_atendimento	= cd_setor_w;
				nr_leitos_tot_fev_w		:= coalesce(nr_leitos_tot_fev_w,0) + coalesce(nr_leitos_w,0);
				nr_leitos_ocup_tot_fev_w	:= coalesce(nr_leitos_ocup_tot_fev_w,0) + coalesce(nr_leitos_ocup_w,0);

			elsif (nr_mes_w = 3) then
				update	w_relat_boletim_ocup_hosp
				set	nr_leitos_mar		= coalesce(nr_leitos_w,0),
					nr_leitos_ocup_mar	= coalesce(nr_leitos_ocup_w,0),
					qt_perc_ocup_mar	= coalesce(qt_perc_ocup_w,0)
				where	cd_setor_atendimento	= cd_setor_w;
				nr_leitos_tot_mar_w		:= coalesce(nr_leitos_tot_mar_w,0) + coalesce(nr_leitos_w,0);
				nr_leitos_ocup_tot_mar_w	:= coalesce(nr_leitos_ocup_tot_mar_w,0) + coalesce(nr_leitos_ocup_w,0);

			elsif (nr_mes_w = 4) then
				update	w_relat_boletim_ocup_hosp
				set	nr_leitos_abr		= coalesce(nr_leitos_w,0),
					nr_leitos_ocup_abr	= coalesce(nr_leitos_ocup_w,0),
					qt_perc_ocup_abr	= coalesce(qt_perc_ocup_w,0)
				where	cd_setor_atendimento	= cd_setor_w;
				nr_leitos_tot_abr_w		:= coalesce(nr_leitos_tot_abr_w,0) + coalesce(nr_leitos_w,0);
				nr_leitos_ocup_tot_abr_w	:= coalesce(nr_leitos_ocup_tot_abr_w,0) + coalesce(nr_leitos_ocup_w,0);

			elsif (nr_mes_w = 5) then
				update	w_relat_boletim_ocup_hosp
				set	nr_leitos_mai		= coalesce(nr_leitos_w,0),
					nr_leitos_ocup_mai	= coalesce(nr_leitos_ocup_w,0),
					qt_perc_ocup_mai	= coalesce(qt_perc_ocup_w,0)
				where	cd_setor_atendimento	= cd_setor_w;
				nr_leitos_tot_mai_w		:= coalesce(nr_leitos_tot_mai_w,0) + coalesce(nr_leitos_w,0);
				nr_leitos_ocup_tot_mai_w	:= coalesce(nr_leitos_ocup_tot_mai_w,0) + coalesce(nr_leitos_ocup_w,0);

			elsif (nr_mes_w = 6) then
				update	w_relat_boletim_ocup_hosp
				set	nr_leitos_jun		= coalesce(nr_leitos_w,0),
					nr_leitos_ocup_jun	= coalesce(nr_leitos_ocup_w,0),
					qt_perc_ocup_jun	= coalesce(qt_perc_ocup_w,0)
				where	cd_setor_atendimento	= cd_setor_w;
				nr_leitos_tot_jun_w		:= coalesce(nr_leitos_tot_jun_w,0) + coalesce(nr_leitos_w,0);
				nr_leitos_ocup_tot_jun_w	:= coalesce(nr_leitos_ocup_tot_jun_w,0) + coalesce(nr_leitos_ocup_w,0);

			elsif (nr_mes_w = 7) then
				update	w_relat_boletim_ocup_hosp
				set	nr_leitos_jul		= coalesce(nr_leitos_w,0),
					nr_leitos_ocup_jul	= coalesce(nr_leitos_ocup_w,0),
					qt_perc_ocup_jul	= coalesce(qt_perc_ocup_w,0)
				where	cd_setor_atendimento	= cd_setor_w;
				nr_leitos_tot_jul_w		:= coalesce(nr_leitos_tot_jul_w,0) + coalesce(nr_leitos_w,0);
				nr_leitos_ocup_tot_jul_w	:= coalesce(nr_leitos_ocup_tot_jul_w,0) + coalesce(nr_leitos_ocup_w,0);

			elsif (nr_mes_w = 8) then
				update	w_relat_boletim_ocup_hosp
				set	nr_leitos_ago		= coalesce(nr_leitos_w,0),
					nr_leitos_ocup_ago	= coalesce(nr_leitos_ocup_w,0),
					qt_perc_ocup_ago	= coalesce(qt_perc_ocup_w,0)
				where	cd_setor_atendimento	= cd_setor_w;
				nr_leitos_tot_ago_w		:= coalesce(nr_leitos_tot_ago_w,0) + coalesce(nr_leitos_w,0);
				nr_leitos_ocup_tot_ago_w	:= coalesce(nr_leitos_ocup_tot_ago_w,0) + coalesce(nr_leitos_ocup_w,0);

			elsif (nr_mes_w = 9) then
				update	w_relat_boletim_ocup_hosp
				set	nr_leitos_set		= coalesce(nr_leitos_w,0),
					nr_leitos_ocup_set	= coalesce(nr_leitos_ocup_w,0),
					qt_perc_ocup_set	= coalesce(qt_perc_ocup_w,0)
				where	cd_setor_atendimento	= cd_setor_w;
				nr_leitos_tot_set_w		:= coalesce(nr_leitos_tot_set_w,0) + coalesce(nr_leitos_w,0);
				nr_leitos_ocup_tot_set_w	:= coalesce(nr_leitos_ocup_tot_set_w,0) + coalesce(nr_leitos_ocup_w,0);

			elsif (nr_mes_w = 10) then
				update	w_relat_boletim_ocup_hosp
				set	nr_leitos_out		= coalesce(nr_leitos_w,0),
					nr_leitos_ocup_out	= coalesce(nr_leitos_ocup_w,0),
					qt_perc_ocup_out	= coalesce(qt_perc_ocup_w,0)
				where	cd_setor_atendimento	= cd_setor_w;
				nr_leitos_tot_out_w		:= coalesce(nr_leitos_tot_out_w,0) + coalesce(nr_leitos_w,0);
				nr_leitos_ocup_tot_out_w	:= coalesce(nr_leitos_ocup_tot_out_w,0) + coalesce(nr_leitos_ocup_w,0);

			elsif (nr_mes_w = 11) then
				update	w_relat_boletim_ocup_hosp
				set	nr_leitos_nov		= coalesce(nr_leitos_w,0),
					nr_leitos_ocup_nov	= coalesce(nr_leitos_ocup_w,0),
					qt_perc_ocup_nov	= coalesce(qt_perc_ocup_w,0)
				where	cd_setor_atendimento	= cd_setor_w;
				nr_leitos_tot_nov_w		:= coalesce(nr_leitos_tot_nov_w,0) + coalesce(nr_leitos_w,0);
				nr_leitos_ocup_tot_nov_w	:= coalesce(nr_leitos_ocup_tot_nov_w,0) + coalesce(nr_leitos_ocup_w,0);

			elsif (nr_mes_w = 12) then
				update	w_relat_boletim_ocup_hosp
				set	nr_leitos_dez		= coalesce(nr_leitos_w,0),
					nr_leitos_ocup_dez	= coalesce(nr_leitos_ocup_w,0),
					qt_perc_ocup_dez	= coalesce(qt_perc_ocup_w,0)
				where	cd_setor_atendimento	= cd_setor_w;
				nr_leitos_tot_dez_w		:= coalesce(nr_leitos_tot_dez_w,0) + coalesce(nr_leitos_w,0);
				nr_leitos_ocup_tot_dez_w	:= coalesce(nr_leitos_ocup_tot_dez_w,0) + coalesce(nr_leitos_ocup_w,0);
			end if;
			end;
		end loop;
		close c01;
		nr_mes_w	:= nr_mes_w + 1;
		end;
	end loop;

	/* atualizar valores totais */

	update	w_relat_boletim_ocup_hosp
	set	nr_leitos_tot_jan		= coalesce(nr_leitos_tot_jan_w,0),
		nr_leitos_ocup_tot_jan	= coalesce(nr_leitos_ocup_tot_jan_w,0),
		nr_leitos_tot_fev		= coalesce(nr_leitos_tot_fev_w,0),
		nr_leitos_ocup_tot_fev	= coalesce(nr_leitos_ocup_tot_fev_w,0),
		nr_leitos_tot_mar		= coalesce(nr_leitos_tot_mar_w,0),
		nr_leitos_ocup_tot_mar	= coalesce(nr_leitos_ocup_tot_mar_w,0),
		nr_leitos_tot_abr		= coalesce(nr_leitos_tot_abr_w,0),
		nr_leitos_ocup_tot_abr	= coalesce(nr_leitos_ocup_tot_abr_w,0),
		nr_leitos_tot_mai		= coalesce(nr_leitos_tot_mai_w,0),
		nr_leitos_ocup_tot_mai	= coalesce(nr_leitos_ocup_tot_mai_w,0),
		nr_leitos_tot_jun		= coalesce(nr_leitos_tot_jun_w,0),
		nr_leitos_ocup_tot_jun	= coalesce(nr_leitos_ocup_tot_jun_w,0),
		nr_leitos_tot_jul		= coalesce(nr_leitos_tot_jul_w,0),
		nr_leitos_ocup_tot_jul	= coalesce(nr_leitos_ocup_tot_jul_w,0),
		nr_leitos_tot_ago		= coalesce(nr_leitos_tot_ago_w,0),
		nr_leitos_ocup_tot_ago	= coalesce(nr_leitos_ocup_tot_ago_w,0),
		nr_leitos_tot_set		= coalesce(nr_leitos_tot_set_w,0),
		nr_leitos_ocup_tot_set	= coalesce(nr_leitos_ocup_tot_set_w,0),
		nr_leitos_tot_out		= coalesce(nr_leitos_tot_out_w,0),
		nr_leitos_ocup_tot_out	= coalesce(nr_leitos_ocup_tot_out_w,0),
		nr_leitos_tot_nov		= coalesce(nr_leitos_tot_nov_w,0),
		nr_leitos_ocup_tot_nov	= coalesce(nr_leitos_ocup_tot_nov_w,0),
		nr_leitos_tot_dez		= coalesce(nr_leitos_tot_dez_w,0),
		nr_leitos_ocup_tot_dez	= coalesce(nr_leitos_ocup_tot_dez_w,0)
	where	(cd_setor_atendimento IS NOT NULL AND cd_setor_atendimento::text <> '');
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_relat_boletim_ocup_hosp (cd_estabelecimento_p bigint, nr_ano_p text, cd_setor_atendimento_p text) FROM PUBLIC;

