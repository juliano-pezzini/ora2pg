-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE importar_exame_lab_result_item (NR_SEQ_INTERNO_P prescr_procedimento.nr_seq_interno%type, NM_USUARIO_P exame_lab_result_item.nm_usuario%type, DS_RESULTADO_P exame_lab_result_item.ds_resultado%type, QT_RESULTADO_P exame_lab_result_item.qt_resultado%type) AS $body$
DECLARE


nr_seq_resultado_w exame_lab_resultado.nr_seq_resultado%type;
nr_prescricao_w prescr_medica.nr_prescricao%type;
nr_seq_exame_w exame_laboratorio.nr_seq_exame%type;
nr_seq_resultado_item_w exame_lab_result_item.nr_sequencia%type;
nr_sequencia_w prescr_procedimento.nr_sequencia%type;


BEGIN
    select  pm.nr_prescricao, pp.nr_seq_exame, pp.nr_sequencia
    into STRICT	nr_prescricao_w, nr_seq_exame_w, nr_sequencia_w
    from    prescr_procedimento pp,
            prescr_medica pm
    where   pm.nr_prescricao = pp.nr_prescricao
    and 	pp.nr_seq_interno = NR_SEQ_INTERNO_P;

    select	max(elr.nr_seq_resultado)
    into STRICT	nr_seq_resultado_w
    from	exame_lab_resultado elr
    where	elr.nr_prescricao = nr_prescricao_w;

    select max(coalesce(elri.nr_sequencia, null))
    into STRICT nr_seq_resultado_item_w
    from exame_lab_result_item elri
    where elri.nr_seq_resultado = nr_seq_resultado_w
    and   elri.nr_seq_exame = nr_seq_exame_w;

    if (coalesce(nr_seq_resultado_item_w::text, '') = '') then
        begin
            select	coalesce(max(elri.nr_sequencia),0) + 1
            into STRICT	nr_seq_resultado_item_w
            from	exame_lab_resultado elr,
                    exame_lab_result_item elri
            where	elr.nr_prescricao = nr_prescricao_w
            and		elri.nr_seq_resultado = nr_seq_resultado_w;

            insert into exame_lab_result_item(nr_sequencia, nr_seq_resultado, nr_seq_exame, nm_usuario, qt_resultado, ds_resultado, dt_atualizacao, nr_seq_prescr)
            values (nr_seq_resultado_item_w, nr_seq_resultado_w, nr_seq_exame_w, NM_USUARIO_P, QT_RESULTADO_P, DS_RESULTADO_P, clock_timestamp(), nr_sequencia_w);
            commit;
        end;
    else
        begin
            select elri.nr_sequencia
            into STRICT nr_seq_resultado_item_w
            from exame_lab_result_item elri
            where elri.nr_seq_resultado = nr_seq_resultado_w
            and   elri.nr_seq_exame = nr_seq_exame_w;

            UPDATE exame_lab_result_item elri
            SET     elri.nm_usuario = NM_USUARIO_P,
                    elri.qt_resultado = QT_RESULTADO_P,
                    elri.ds_resultado = DS_RESULTADO_P,
                    elri.dt_atualizacao = clock_timestamp(),
                    elri.nr_seq_prescr = nr_sequencia_w
            WHERE   elri.nr_seq_resultado = nr_seq_resultado_w
            and     elri.nr_sequencia = nr_seq_resultado_item_w
            and     elri.nr_seq_exame = nr_seq_exame_w;
            commit;
        end;
    end if;

     UPDATE prescr_procedimento pp
     SET     pp.ie_status_atend = 35
     WHERE   pp.nr_prescricao = nr_prescricao_w
     and     pp.nr_seq_interno = NR_SEQ_INTERNO_P;
     commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importar_exame_lab_result_item (NR_SEQ_INTERNO_P prescr_procedimento.nr_seq_interno%type, NM_USUARIO_P exame_lab_result_item.nm_usuario%type, DS_RESULTADO_P exame_lab_result_item.ds_resultado%type, QT_RESULTADO_P exame_lab_result_item.qt_resultado%type) FROM PUBLIC;

