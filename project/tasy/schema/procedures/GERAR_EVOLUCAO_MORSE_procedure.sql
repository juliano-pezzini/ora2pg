-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_evolucao_morse ( nm_usuario_p text, nr_sequencia_p bigint) AS $body$
DECLARE

 
ie_tipo_evolucao_w	  varchar(3);
ie_situacao_w			varchar(1);
ie_relev_resumo_alta_w varchar(1);
ds_evolucao_w			varchar(4000);
cd_especial_medico_w	integer;
cd_medico_w				varchar(10);
ie_evolucao_cliente_w	varchar(1);

-- Dados Escala Morse 
nr_atendimento_w 		bigint;
cd_profissional_w 		varchar(10);
dt_avaliacao_w 			timestamp;
ie_hist_queda_w 		varchar(1);
ie_diag_secundario_w 	varchar(1);
ie_ajuda_deambular_w 	smallint;
ie_uso_heparina_w 		varchar(1);
ie_modo_andar_w 		smallint;
ie_estado_mental_w 		smallint;
qt_pontuacao_w 		bigint;
cd_pessoa_fisica_w		varchar(10);


BEGIN 
 
select	coalesce(max(ie_situacao),'I'), 
		coalesce(max(ie_evolucao_cliente),'N') 
into STRICT	ie_situacao_w, 
		ie_evolucao_cliente_w 
from 	tipo_evolucao 
where  cd_tipo_evolucao = 'EEM';
 
if (ie_evolucao_cliente_w = 'S') and (ie_situacao_w = 'A') then 
 
 
	ie_tipo_evolucao_w 	:= Obter_Dados_Usuario_Opcao(nm_usuario_p,'F');
	 
	select 	max(nr_atendimento), 
			max(cd_profissional), 
			max(dt_avaliacao), 
			max(ie_hist_queda), 
			max(ie_diag_secundario), 
			max(ie_ajuda_deambular), 
			max(ie_uso_heparina), 
			max(ie_modo_andar), 
			max(ie_estado_mental), 
			max(qt_pontuacao), 
			max(OBTER_PESSOA_ATENDIMENTO(NR_ATENDIMENTO,'C')) 
	into STRICT	nr_atendimento_w, 
			cd_profissional_w, 
			dt_avaliacao_w, 
			ie_hist_queda_w, 
			ie_diag_secundario_w, 
			ie_ajuda_deambular_w, 
			ie_uso_heparina_w, 
			ie_modo_andar_w, 
			ie_estado_mental_w, 
			qt_pontuacao_w, 
			cd_pessoa_fisica_w 
	from	ESCALA_MORSE 
	where 	nr_sequencia = nr_sequencia_p;
	 
	if (obter_se_medico(cd_profissional_w,'M') = 'S') then 
		cd_medico_w := cd_profissional_w;
	end if;
	 
	ds_evolucao_w := obter_desc_expressao(631158);
	 
	ds_evolucao_w := ds_evolucao_w || chr(13) || obter_desc_expressao(286576) || ' ' || dt_avaliacao_w;
	 
	if (ie_hist_queda_w = 'S') then 
		ds_evolucao_w := ds_evolucao_w || chr(13) || obter_desc_expressao(643963);
	end if;
	if (ie_diag_secundario_w = 'S') then 
		ds_evolucao_w := ds_evolucao_w || chr(13) || obter_desc_expressao(614297);
	end if;
	 
	ds_evolucao_w := ds_evolucao_w || chr(13) || obter_desc_expressao(614295) || ': ';
	if (ie_ajuda_deambular_w = 0) then 
		ds_evolucao_w := ds_evolucao_w || 'Nenhuma; profissional da saúde; cadeira de rodas; acamado';
	elsif (ie_ajuda_deambular_w = 15) then 
		ds_evolucao_w := ds_evolucao_w || 'Muleta; bengala; andador';
	elsif (ie_ajuda_deambular_w = 30) then 
		ds_evolucao_w := ds_evolucao_w || 'Deambula apoiado junto a mobília';
	end if;
	 
	if (ie_uso_heparina_w = 'S') then 
		ds_evolucao_w := ds_evolucao_w || chr(13) || obter_desc_expressao(644029);
	end if;
 
	ds_evolucao_w := ds_evolucao_w || chr(13) || obter_desc_expressao(284569) || ': ';
	if (ie_modo_andar_w = 0) then 
		ds_evolucao_w := ds_evolucao_w || 'Normal; sem deambulação; cadeira de rodas; acamado';
	elsif (ie_modo_andar_w = 10) then 
		ds_evolucao_w := ds_evolucao_w || obter_desc_expressao(487812);
	elsif (ie_modo_andar_w = 20) then 
		ds_evolucao_w := ds_evolucao_w || 'Comprometida';
	end if;
 
	if (ie_estado_mental_w = 0) then 
		ds_evolucao_w := ds_evolucao_w || chr(13) || obter_desc_expressao(289541) || ': Ciente das próprias capacidades e limitações';
	elsif (ie_estado_mental_w = 15) then 
		ds_evolucao_w := ds_evolucao_w || chr(13) || obter_desc_expressao(289541) || ': Superestima capacidade; esquece as limitações';
	end if;
	 
	ds_evolucao_w := ds_evolucao_w || chr(13) || obter_desc_expressao(328217) || ' ' || qt_pontuacao_w || ' ' || Obter_desc_escala_morse(qt_pontuacao_w);
	 
	select	coalesce(max(ie_relev_resumo_alta),'N') 
	into STRICT	ie_relev_resumo_alta_w 
	from	tipo_evolucao 
	where  cd_tipo_evolucao = 'EEM';
	 
	cd_especial_medico_w := obter_especialidade_pf(cd_profissional_w);
 
	insert into 	evolucao_paciente(cd_evolucao, 
			 dt_evolucao, 
			 ie_tipo_evolucao,		 
			 cd_pessoa_fisica, 
			 nr_atendimento,				 
			 ie_situacao, 
			 dt_atualizacao, 
			 nm_usuario, 
			 ds_evolucao, 
			 cd_medico, 
			 cd_especialidade_medico, 
			 dt_liberacao, 
			 ie_evolucao_clinica, 
			 ie_relev_resumo_alta) 
	values ( 
			 nextval('evolucao_paciente_seq'), 
			 clock_timestamp(), 
			 ie_tipo_evolucao_w,		 
			 cd_pessoa_fisica_w, 
 
			 nr_atendimento_w,		 
			 'A', 
			 clock_timestamp(), 
			 nm_usuario_p, 
			 ds_evolucao_w, 
			 coalesce(cd_medico_w,cd_profissional_w), 
 
			 cd_especial_medico_w, 
			 clock_timestamp(), 
			 'EEM', 
			 ie_relev_resumo_alta_w);
 
	commit;
	 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_evolucao_morse ( nm_usuario_p text, nr_sequencia_p bigint) FROM PUBLIC;

