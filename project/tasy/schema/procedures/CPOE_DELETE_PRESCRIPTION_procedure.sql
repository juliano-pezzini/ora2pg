-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_delete_prescription ( nr_prescricao_p bigint, ds_log_p text, ie_apagar_somente_itens_p text default 'N') AS $body$
DECLARE


nr_seq_cpoe_w				numeric(20);
dt_liberacao_w				timestamp;
ds_log_w					varchar(4000) := nr_prescricao_p;
ie_tipo_proced_w			prescr_procedimento.ie_tipo_proced%type;
nr_atendimento_w			atendimento_paciente.nr_atendimento%type;
nm_usuario_w				usuario.nm_usuario%type;
nr_seq_cpoe_anterior_w		cpoe_dieta.nr_seq_cpoe_anterior%type;

c01 CURSOR FOR
SELECT	nr_seq_dieta_cpoe
from	prescr_material
where	nr_prescricao	= nr_prescricao_p

union

SELECT	nr_seq_dieta_cpoe
from	prescr_dieta
where	nr_prescricao	= nr_prescricao_p

union

select	nr_seq_dieta_cpoe
from	rep_jejum
where	nr_prescricao	= nr_prescricao_p

union

select	nr_seq_npt_cpoe
from	nut_pac
where	nr_prescricao	= nr_prescricao_p;

c02 CURSOR FOR
SELECT	nr_Seq_mat_cpoe
from	prescr_material
where	nr_prescricao	= nr_prescricao_p;
	
c03 CURSOR FOR
SELECT	nr_seq_proc_cpoe,
		coalesce(ie_tipo_proced,'XPTO')
from	prescr_procedimento
where	nr_prescricao = nr_prescricao_p;

c04 CURSOR FOR
SELECT	nr_Seq_gas_cpoe
from	prescr_gasoterapia
where	nr_prescricao	= nr_prescricao_p;

c05 CURSOR FOR
SELECT	nr_Seq_rec_cpoe
from	prescr_recomendacao
where	nr_prescricao = nr_prescricao_p;

c06 CURSOR FOR
SELECT	nr_Seq_hemo_cpoe
from	prescr_solic_bco_sangue
where	nr_prescricao = nr_prescricao_p;

c07 CURSOR FOR
SELECT	nr_seq_dialise_cpoe
from	hd_prescricao
where	nr_prescricao = nr_prescricao_p;


BEGIN

select	coalesce(max(dt_liberacao_medico),max(dt_liberacao)),
	max(nr_atendimento),
	max(nm_usuario)
into STRICT	dt_liberacao_w,
	nr_atendimento_w,
	nm_usuario_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

if (coalesce(dt_liberacao_w::text, '') = '') then

	open C01;
	loop
	fetch C01 into	
		nr_Seq_cpoe_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		select  coalesce(max(nr_seq_cpoe_anterior),0)
		into STRICT    nr_seq_cpoe_anterior_w
		from    cpoe_dieta
		where   nr_sequencia = nr_seq_cpoe_w;
		
		if (nr_seq_cpoe_anterior_w > 0) then		
			update	cpoe_dieta
			set	dt_lib_suspensao  = NULL,
				dt_suspensao  = NULL,
				nm_usuario_susp  = NULL
			where nr_sequencia = nr_seq_cpoe_anterior_w;
		end if;
		
		update	cpoe_dieta
		set	dt_liberacao  = NULL
		where	nr_sequencia = nr_seq_cpoe_w;		
		
		ds_log_w := substr(ds_log_w||';D'||nr_seq_cpoe_w,1,4000);
		
		end;
	end loop;
	close C01;

	open C02;
	loop
	fetch C02 into	
		nr_Seq_cpoe_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		
		select  coalesce(max(nr_seq_cpoe_anterior),0)
		into STRICT    nr_seq_cpoe_anterior_w
		from    cpoe_material
		where   nr_sequencia = nr_seq_cpoe_w;
		
		if (nr_seq_cpoe_anterior_w > 0) then		
			update	cpoe_material
			set	dt_lib_suspensao  = NULL,
				dt_suspensao  = NULL,
				nm_usuario_susp  = NULL
			where nr_sequencia = nr_seq_cpoe_anterior_w;
		end if;		
		
		update	cpoe_material
		set	dt_liberacao	 = NULL
		where	nr_sequencia	= nr_Seq_cpoe_w;
		
		update	med_avaliacao_paciente
		set 		nr_prescricao  = NULL
		where	nr_seq_mat_cpoe = nr_Seq_cpoe_w
		and	    nr_prescricao = nr_prescricao_p;
		
		ds_log_w := substr(ds_log_w||';M'||nr_seq_cpoe_w,1,4000);
		
		end;
	end loop;
	close C02;
	
	open C03;
	loop
	fetch C03 into	
		nr_Seq_cpoe_w,
		ie_tipo_proced_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin
		
		if (ie_tipo_proced_w in ('AP','APH','APC')) then
			
			select  coalesce(max(nr_seq_cpoe_anterior),0)
			into STRICT    nr_seq_cpoe_anterior_w
			from    cpoe_anatomia_patologica
			where   nr_sequencia = nr_seq_cpoe_w;
			
			if (nr_seq_cpoe_anterior_w > 0) then		
				update	cpoe_anatomia_patologica
				set	dt_lib_suspensao  = NULL,
					dt_suspensao  = NULL,
					nm_usuario_susp  = NULL
				where nr_sequencia = nr_seq_cpoe_anterior_w;
			end if;			
			
			update	cpoe_anatomia_patologica
			set	dt_liberacao  = NULL
			where	nr_sequencia = nr_seq_cpoe_w;

			ds_log_w := substr(ds_log_w||';AP'||nr_seq_cpoe_w,1,4000);
		else
			select  coalesce(max(nr_seq_cpoe_anterior),0)
			into STRICT    nr_seq_cpoe_anterior_w
			from    cpoe_procedimento
			where   nr_sequencia = nr_seq_cpoe_w;
			
			if (nr_seq_cpoe_anterior_w > 0) then		
				update	cpoe_procedimento
				set	dt_lib_suspensao  = NULL,
					dt_suspensao  = NULL,
					nm_usuario_susp  = NULL
				where nr_sequencia = nr_seq_cpoe_anterior_w;
			end if;			
			
			update	cpoe_procedimento
			set	dt_liberacao  = NULL
			where	nr_sequencia = nr_seq_cpoe_w;
			
			delete	FROM cpoe_material
			where	nr_seq_procedimento	= nr_seq_cpoe_w
			and	nr_atendimento		= nr_atendimento_w;

			ds_log_w := substr(ds_log_w||';P'||nr_seq_cpoe_w,1,4000);
		end if;
		
		end;
	end loop;
	close C03;
	
	open C04;
	loop
	fetch C04 into	
		nr_seq_cpoe_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
		begin
		
		select  coalesce(max(nr_seq_cpoe_anterior),0)
		into STRICT    nr_seq_cpoe_anterior_w
		from    cpoe_gasoterapia
		where   nr_sequencia = nr_seq_cpoe_w;
		
		if (nr_seq_cpoe_anterior_w > 0) then		
			update	cpoe_gasoterapia
			set	dt_lib_suspensao  = NULL,
				dt_suspensao  = NULL,
				nm_usuario_susp  = NULL
			where nr_sequencia = nr_seq_cpoe_anterior_w;
		end if;			
		
		update	cpoe_gasoterapia
		set	dt_liberacao	 = NULL
		where	nr_sequencia	= nr_Seq_cpoe_w;
		
		ds_log_w := substr(ds_log_w||';G'||nr_seq_cpoe_w,1,4000);
		
		end;
	end loop;
	close C04;
	
	open C05;
	loop
	fetch C05 into	
		nr_seq_cpoe_w;
	EXIT WHEN NOT FOUND; /* apply on C05 */
		begin
		
		select  coalesce(max(nr_seq_cpoe_anterior),0)
		into STRICT    nr_seq_cpoe_anterior_w
		from    cpoe_recomendacao
		where   nr_sequencia = nr_seq_cpoe_w;
		
		if (nr_seq_cpoe_anterior_w > 0) then		
			update	cpoe_recomendacao
			set	dt_lib_suspensao  = NULL,
				dt_suspensao  = NULL,
				nm_usuario_susp  = NULL
			where nr_sequencia = nr_seq_cpoe_anterior_w;
		end if;			
		
		update	cpoe_recomendacao
		set	dt_liberacao  = NULL
		where	nr_sequencia	= nr_seq_cpoe_w;
		
		ds_log_w := substr(ds_log_w||';R'||nr_seq_cpoe_w,1,4000);
		
		end;
	end loop;
	close C05;
	
	open C06;
	loop
	fetch C06 into	
		nr_seq_cpoe_w;
	EXIT WHEN NOT FOUND; /* apply on C06 */
		begin

		select  coalesce(max(nr_seq_cpoe_anterior),0)
		into STRICT    nr_seq_cpoe_anterior_w
		from    cpoe_hemoterapia
		where   nr_sequencia = nr_seq_cpoe_w;
		
		if (nr_seq_cpoe_anterior_w > 0) then		
			update	cpoe_hemoterapia
			set	dt_lib_suspensao  = NULL,
				dt_suspensao  = NULL,
				nm_usuario_susp  = NULL
			where nr_sequencia = nr_seq_cpoe_anterior_w;
		end if;			
		
		update	cpoe_hemoterapia
		set	dt_liberacao  = NULL
		where	nr_sequencia = nr_seq_cpoe_w;
		
		ds_log_w := substr(ds_log_w||';H'||nr_seq_cpoe_w,1,4000);
		
		end;
	end loop;
	close C06;
	
	open C07;
	loop
	fetch C07 into	
		nr_Seq_cpoe_w;
	EXIT WHEN NOT FOUND; /* apply on C07 */
		begin
		
		select  coalesce(max(nr_seq_cpoe_anterior),0)
		into STRICT    nr_seq_cpoe_anterior_w
		from    cpoe_dialise
		where   nr_sequencia = nr_seq_cpoe_w;
		
		if (nr_seq_cpoe_anterior_w > 0) then		
			update	cpoe_dialise
			set	dt_lib_suspensao  = NULL,
				dt_suspensao  = NULL,
				nm_usuario_susp  = NULL
			where nr_sequencia = nr_seq_cpoe_anterior_w;
		end if;			
		
		update	cpoe_dialise
		set	dt_liberacao  = NULL
		where	nr_sequencia = nr_seq_cpoe_w;
		
		ds_log_w := substr(ds_log_w||';DI'||nr_seq_cpoe_w,1,4000);
		
		end;
	end loop;
	close C07;
	
	begin
	
	delete	FROM agenda_hc_paciente
	where	nr_prescricao = nr_prescricao_p;
	
	delete	FROM nut_prescr_dieta
	where	nr_prescricao = nr_prescricao_p;
	
	delete	FROM prescr_material
	where	nr_prescricao = nr_prescricao_p;

	delete	FROM prescr_dieta
	where	nr_prescricao = nr_prescricao_p;

	delete	FROM rep_jejum
	where	nr_prescricao = nr_prescricao_p;

	delete	FROM nut_paciente
	where	nr_prescricao = nr_prescricao_p;

	delete	FROM nut_pac
	where	nr_prescricao = nr_prescricao_p;

	delete	FROM prescr_solucao
	where	nr_prescricao = nr_prescricao_p;

	delete	FROM prescr_material_cid
	where	nr_prescricao = nr_prescricao_p;

	delete	FROM prescr_medica_albumina
	where	nr_prescricao = nr_prescricao_p;

	delete	FROM prescr_procedimento
	where	nr_prescricao = nr_prescricao_p;

	delete	FROM prescr_gasoterapia
	where	nr_prescricao = nr_prescricao_p;

	delete	FROM prescr_solic_bco_sangue
	where	nr_prescricao = nr_prescricao_p;

	delete	FROM prescr_recomendacao
	where	nr_prescricao = nr_prescricao_p;

	delete	FROM hd_prescricao
	where	nr_prescricao = nr_prescricao_p;

	delete	FROM prescr_leite_deriv
	where	nr_prescricao = nr_prescricao_p;
	
	if (coalesce(ie_apagar_somente_itens_p,'N') = 'N' ) then
		delete	FROM prescr_medica
		where	nr_prescricao = nr_prescricao_p;	
	end if;

	ds_log_w := 'Excluir_prescricao '||ds_log_p||' nr_prescricao='||ds_log_w;
	
	CALL gravar_log_tasy(10007,ds_log_w,nm_usuario_w);

	commit;
	
	exception
	when others then
		ds_log_w := substr(obter_desc_expressao(782496)/*'ERRO ao excluir prescricao='*/
||nr_prescricao_p||' '||SQLERRM,1,4000);
		CALL gravar_log_tasy(10007,ds_log_w,nm_usuario_w);	
		commit;
	end;	

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_delete_prescription ( nr_prescricao_p bigint, ds_log_p text, ie_apagar_somente_itens_p text default 'N') FROM PUBLIC;

