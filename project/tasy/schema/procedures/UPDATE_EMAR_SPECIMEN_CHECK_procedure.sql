-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE update_emar_specimen_check ( NM_USUARIO_P text, ACTION_P text ) AS $body$
DECLARE

	
	nr_atendimento_w	bigint;
	QTD_ITENS_W	smallint;
	index_loop_w	smallint;
	nr_prescricao_w	bigint;
	nr_item_w	smallint;
	nr_seq_cpoe_w	bigint;
	cd_evolucao_w	evolucao_paciente.cd_evolucao%TYPE;
	
BEGIN

	IF (ACTION_P = 1191211) THEN
	
		
		SELECT count(*) INTO STRICT QTD_ITENS_W FROM EMAR_SPECIMEN_CHECK b
		WHERE 
		TRUNC(b.DT_ATUALIZACAO) = TRUNC(clock_timestamp())
		AND b.NM_USUARIO = NM_USUARIO_P 
		AND coalesce(b.DT_AMOSTRA_COLLECT::text, '') = '';
		
		FOR i IN 1..QTD_ITENS_W LOOP
		
			SELECT max(c.NR_PRESCRICAO), max(c.NR_ITEM_PRESCR)
			INTO STRICT nr_prescricao_w, nr_item_w 
			FROM EMAR_SPECIMEN_CHECK c 
			WHERE 
			TRUNC(c.DT_ATUALIZACAO) = TRUNC(clock_timestamp())
			AND c.NM_USUARIO = NM_USUARIO_P 
			AND coalesce(c.DT_AMOSTRA_COLLECT::text, '') = ''
			AND c.NR_ITEM_PRESCR = i;
			
			nr_atendimento_w := OBTER_ATENDIMENTO_PRESCR(nr_prescricao_w);
			
			SELECT max(c.NR_SEQ_PROC_CPOE)
			INTO STRICT nr_seq_cpoe_w
			FROM prescr_procedimento c 
			WHERE c.NR_PRESCRICAO = nr_prescricao_w 
			AND c.NR_SEQUENCIA = nr_item_w;
			
			cd_evolucao_w := clinical_notes_pck.gerar_soap(nr_atendimento_w, nr_seq_cpoe_w, 'CPOE_ITEMS', 2, 'P', 2, cd_evolucao_w);
		
		
		END LOOP;
		
	
		UPDATE EMAR_SPECIMEN_CHECK SET
		DT_AMOSTRA_COLLECT = clock_timestamp() 
		WHERE 
		TRUNC(DT_ATUALIZACAO) = TRUNC(clock_timestamp())
		AND NM_USUARIO = NM_USUARIO_P 
		AND coalesce(DT_AMOSTRA_COLLECT::text, '') = '';
		
	END IF;
	
	IF (ACTION_P = 1191210 ) THEN
	
		DELETE FROM EMAR_SPECIMEN_CHECK
		WHERE 
		TRUNC(DT_ATUALIZACAO) = TRUNC(clock_timestamp()) 
		AND NM_USUARIO = NM_USUARIO_P 
		AND coalesce(DT_AMOSTRA_COLLECT::text, '') = '';
	
	END IF;
	
	commit;
	
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE update_emar_specimen_check ( NM_USUARIO_P text, ACTION_P text ) FROM PUBLIC;

