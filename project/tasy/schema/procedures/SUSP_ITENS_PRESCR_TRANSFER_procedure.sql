-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE susp_itens_prescr_transfer ( nr_seq_interno_p bigint, nm_usuario_p text) is ie_susp_rep_transf_w varchar(1) RETURNS bigint AS $body$
DECLARE

	cd_setor_atend_regra_w	bigint;
	
BEGIN
	if (pkg_i18n.get_user_locale() = 'en_AU') then
		select 	max(nr_atendimento),
			max(a.cd_setor_atendimento)
		into STRICT	nr_atendimento_w,
			cd_setor_atend_regra_w
		from	setor_atendimento b,
			atend_paciente_unidade a
		where	a.cd_setor_atendimento 	= b.cd_setor_atendimento
		and	a.nr_seq_interno	= nr_seq_pac_unid_p;
	else
		select 	max(nr_atendimento)
		into STRICT	nr_atendimento_w
		from	atend_paciente_unidade
		where	nr_seq_interno	= nr_seq_pac_unid_p;

		select	coalesce(max(nr_seq_interno),0)
		into STRICT	nr_seq_interno_w
		from 	atend_paciente_unidade a,
			setor_atendimento b
		where	a.cd_setor_atendimento	= b.cd_setor_atendimento
		and 	a.nr_atendimento 	= nr_atendimento_w
		and 	a.nr_seq_interno	<> nr_seq_pac_unid_p
		and	b.cd_classif_setor	in ('2','3','4','12')
		and 	coalesce(a.dt_saida_unidade, a.dt_entrada_unidade + 9999) = 	(	SELECT max(coalesce(x.dt_saida_unidade, x.dt_entrada_unidade + 9999))
											from atend_paciente_unidade x
											where x.nr_atendimento 	= nr_atendimento_w
										);

		select 	max(a.cd_setor_atendimento)
		into STRICT	cd_setor_atend_regra_w
		from	setor_atendimento b,
			atend_paciente_unidade a
		where	a.cd_setor_atendimento 	= b.cd_setor_atendimento
		and	a.nr_seq_interno	= nr_seq_interno_w;
	end if;
	return cd_setor_atend_regra_w;
	end;

begin

if (nr_seq_interno_p IS NOT NULL AND nr_seq_interno_p::text <> '') then
	ie_susp_prescr_dieta_pend_w := obter_param_usuario(3111, 255, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_susp_prescr_dieta_pend_w);
	ie_susp_prescr_pend_w := obter_param_usuario(3111, 169, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_susp_prescr_pend_w);

	cd_setor_atendimento_w 	:= get_cd_setor_atend_regra(nr_seq_interno_p);
	ie_susp_rep_transf_w	:= Obter_se_suspen_presc_set(cd_setor_atendimento_w);

	if	((ie_susp_prescr_pend_w = 'S')  or
		 ((ie_susp_prescr_pend_w = 'C') and (ie_susp_rep_transf_w in ('S','B')))) then
		
		open C01;
		loop
		fetch C01 into	
			nr_prescricao_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			CALL Suspender_Prescricao(nr_prescricao_w, 0, null, nm_usuario_p, 'N');
		end loop;
		close C01;
		CALL cpoe_susp_atend_sem_rep(nr_atendimento_w, nm_usuario_p);
		
	elsif   ((ie_susp_prescr_pend_w = 'C') and (ie_susp_rep_transf_w in ('M','I','R'))) then
		
		  open C02;
		  loop
		  fetch C02 into	
		  	nr_prescricao_w,
			nr_seq_item_w,
			nm_tabela_w;
		  EXIT WHEN NOT FOUND; /* apply on C02 */
		  	begin	

			CALL Suspender_item_Prescricao(nr_prescricao_w,nr_seq_item_w,null, WHEB_MENSAGEM_PCK.get_texto(297924),nm_tabela_w,nm_usuario_p,'S',null,null);
		  	end;
		  end loop;
		  close C02;
		
		  CALL cpoe_susp_atend_sem_rep(nr_atendimento_w, nm_usuario_p);
	end if;

end if;	

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE susp_itens_prescr_transfer ( nr_seq_interno_p bigint, nm_usuario_p text) is ie_susp_rep_transf_w varchar(1) FROM PUBLIC;

