-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vincular_cheque_bordero (nr_seq_bordero_p bigint, nr_seq_cheque_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
/* Projeto Multimoeda - Variáveis */

cd_moeda_bordero_w	integer;
cd_moeda_cheque_w	integer;
nr_seq_bordero_w		cheque_bordero.nr_seq_bordero%type;


BEGIN

/* Projeto Multimoeda - Busca a moeda do borderô e verifica se a moeda do cheque e do borderô são diferentes,
			caso positivo não deixa vincular o cheque ao borderô.*/
select max(cd_moeda)
into STRICT cd_moeda_cheque_w
from cheque_cr
where nr_seq_cheque = nr_seq_cheque_p;

select max(cd_moeda)
into STRICT cd_moeda_bordero_w
from bordero_cheque
where nr_sequencia = nr_seq_bordero_p;

if (cd_moeda_cheque_w IS NOT NULL AND cd_moeda_cheque_w::text <> '') and (cd_moeda_bordero_w IS NOT NULL AND cd_moeda_bordero_w::text <> '')
	and (cd_moeda_cheque_w <> cd_moeda_bordero_w) then
	-- A moeda do cheque deve ser a mesma do borderô.
	CALL wheb_mensagem_pck.exibir_mensagem_abort(343694);
end if;

select 	max(nr_seq_bordero)
into STRICT	nr_seq_bordero_w
from 	cheque_bordero
where	nr_seq_cheque = nr_seq_cheque_p
and		nr_seq_bordero = nr_seq_bordero_p;

if (nr_seq_bordero_w IS NOT NULL AND nr_seq_bordero_w::text <> '') then
	-- Este cheque já está vinculado ao borderô #@NR_BORDERO#@ e não pode ser vinculado novamente!
	CALL wheb_mensagem_pck.exibir_mensagem_abort(353602, 'NR_BORDERO=' || nr_seq_bordero_w);
end if;

select	nextval('cheque_bordero_seq')
into STRICT	nr_sequencia_w
;


insert	into cheque_bordero(nr_sequencia,
	nr_seq_bordero,
	dt_atualizacao,
	nm_usuario,
	nr_seq_cheque)
values (nr_sequencia_w,
	nr_seq_bordero_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_cheque_p);

commit;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vincular_cheque_bordero (nr_seq_bordero_p bigint, nr_seq_cheque_p bigint, nm_usuario_p text) FROM PUBLIC;

