-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_setor_atend_prescr (nr_prescricao_p bigint, ds_consistencia_p INOUT text) AS $body$
DECLARE

 
ds_consistencia_w		varchar(255)	:= '';
nr_atendimento_w		bigint;
cd_setor_atendimento_w	bigint;
cd_setor_prescr_w		bigint;
ds_setor_atendimento_w	varchar(100);
ds_setor_prescr_w		varchar(100);
cd_classif_setor_w		bigint;


BEGIN 
 
select	coalesce(max(nr_atendimento),0) 
into STRICT	nr_atendimento_w 
from	prescr_medica 
where	nr_prescricao	= nr_prescricao_p;
 
if (nr_atendimento_w > 0) then 
	begin 
 
	select	obter_unidade_atendimento(nr_atendimento_w, 'IA', 'CS') 
	into STRICT	cd_setor_atendimento_w 
	;
 
	select	cd_setor_atendimento 
	into STRICT	cd_setor_prescr_w 
	from	prescr_medica 
	where	nr_prescricao	= nr_prescricao_p;	
 
	select	max(cd_classif_setor) 
	into STRICT	cd_classif_setor_w 
	from	setor_atendimento 
	where	cd_setor_atendimento	= cd_setor_prescr_w;
 
	if (cd_setor_atendimento_w <> cd_setor_prescr_w) then 
		/*(cd_classif_setor_w <> 2) then retirado por Jonas, pois o parâmetro 136 não informa em nenhum momento que é para consistir a classificação de centro cirurgico */
 
		begin	 
 
		select	obter_nome_setor(cd_setor_atendimento_w), 
			obter_nome_setor(cd_setor_prescr_w) 
		into STRICT	ds_setor_atendimento_w, 
			ds_setor_prescr_w 
		;
		 
 
		ds_consistencia_w	:= 	'O setor da prescrição ' || ds_setor_prescr_w || 
						', é diferente do setor do paciente ' || ds_setor_atendimento_w || '.';
 
 
		end;
	end if;
 
	end;
end if;
 
 
ds_consistencia_p	:= ds_consistencia_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_setor_atend_prescr (nr_prescricao_p bigint, ds_consistencia_p INOUT text) FROM PUBLIC;

