-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_laudo_protocolo_ext ( nr_Seq_pac_protocolo_p bigint, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE


nr_Seq_laudo_w			bigint;
nr_atendimento_w		bigint;
dt_exame_w			timestamp;
nr_seq_imagem_prot_ext_w	bigint;
cd_medico_w			varchar(10);
nr_laudo_w			bigint;

nr_seq_grupo_exame_nao_lab_w  PROC_INTERNO.NR_SEQUENCIA%TYPE;
nr_seq_classif_w  PROC_INTERNO_CLASSIF.NR_SEQUENCIA%TYPE;
cd_pessoa_fisica_w  PESSOA_FISICA.CD_PESSOA_FISICA%TYPE;

/*
P - Protocolo
L - Laudo
*/
c01 CURSOR FOR
	SELECT 	nr_sequencia, cd_pessoa_fisica
	from	laudo_paciente
	where	nr_seq_pac_prot_ext = nr_Seq_pac_protocolo_p;


BEGIN

if (ie_opcao_p = 'P') then

	select 	max(nr_atendimento),
		max(dt_exame),
		max(cd_medico)
	into STRICT	nr_atendimento_w,
		dt_exame_w,
		cd_medico_w
	from	imagem_pac_prot_externo
	where 	nr_sequencia = nr_Seq_pac_protocolo_p;

	open c01;
	loop
	fetch c01 into 	nr_seq_laudo_w, cd_pessoa_fisica_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	
		update	laudo_paciente
		set 	dt_aprovacao = clock_timestamp(),
			dt_liberacao = clock_timestamp()
		where	nr_sequencia = nr_seq_laudo_w;

    select coalesce(max(c.nr_sequencia), 0) NR_SEQ_GRUPO_EXAME_NAO_LAB, coalesce(max(d.nr_sequencia), 0) NR_SEQ_CLASSIF
    into STRICT nr_seq_grupo_exame_nao_lab_w, nr_seq_classif_w
    from laudo_paciente a,
      PROCEDIMENTO_PACIENTE b,
      PROC_INTERNO c,
      PROC_INTERNO_CLASSIF d
    where b.nr_sequencia = a.nr_seq_proc
      and b.NR_SEQ_PROC_INTERNO = c.nr_sequencia
      and c.NR_SEQ_CLASSIF = d.nr_sequencia
      and a.nr_Sequencia = nr_seq_laudo_w;

    CALL ATUALIZAR_EV_LINHA_CUIDADO('EN', 'LAUDO_PACIENTE', nr_seq_laudo_w,
          'nr_seq_grupo_exame_nao_lab_w='||nr_seq_grupo_exame_nao_lab_w||';nr_seq_classif_w='||nr_seq_classif_w||';', coalesce(cd_pessoa_fisica_w, 0), nm_usuario_p);

	end loop;
	close c01;

	update imagem_pac_prot_externo
	set dt_liberacao = clock_timestamp()
	where nr_sequencia = nr_Seq_pac_protocolo_p;
end if;

if (ie_opcao_p = 'L') then

	update	laudo_paciente
	set 	dt_aprovacao = clock_timestamp(),
		dt_liberacao = clock_timestamp()
	where	nr_sequencia = nr_Seq_pac_protocolo_p;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_laudo_protocolo_ext ( nr_Seq_pac_protocolo_p bigint, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

