-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_sjrp_arq_copartic ( nr_sequencia_p bigint, ds_local_p text, nm_arquivo_p text) AS $body$
DECLARE

 
ds_erro_w			varchar(255);
ds_conteudo_w			varchar(4000);
arq_texto_w			utl_file.file_type;

C01 CURSOR FOR 
	SELECT	CASE WHEN coalesce(f.nr_seq_titular::text, '') = '' THEN g.nm_pessoa_fisica  ELSE substr(pls_obter_dados_segurado(f.nr_sequencia,'NT'),1,255) END  nm_titular, 
		g.nm_pessoa_fisica nm_pessoa_fisica, 
		coalesce(substr(pls_obter_dados_conta_proc(h.nr_seq_conta_proc,'C'),1,255),substr(pls_obter_dados_conta_mat(h.nr_seq_conta_mat,'C'),1,255)) cd_procedimento, 
		coalesce(substr(pls_obter_dados_conta_proc(h.nr_seq_conta_proc,'D'),1,255),substr(pls_obter_dados_conta_mat(h.nr_seq_conta_mat,'D'),1,255)) ds_procedimento, 
		h.qt_liberada_copartic qt_liberada_copartic, 
		replace(campo_mascara(h.vl_coparticipacao,2),'.',',') vl_coparticipacao, 
		substr(pls_obter_dados_prestador(i.nr_seq_prestador_exec,'N'),1,255) nm_prestador, 
		CASE WHEN coalesce(f.nr_seq_titular::text, '') = '' THEN g.nr_cpf  ELSE substr(pls_obter_dados_segurado(f.nr_seq_titular,'CPF'),1,255) END  nr_cpf, 
		substr(j.cd_usuario_plano,5,10) cd_usuario_plano_1, 
		to_char(i.dt_emissao,'DD/MM/YYYY') dt_emissao, 
		j.cd_usuario_plano cd_usuario_plano_2 
	from	pls_ame_lote_rem_valor		a, 
		pls_ame_lote_rem_arquivo	b, 
		pls_ame_lote_rem_destino	c, 
		pls_ame_lote_remessa		d, 
		pls_ame_lote_rem_valor_det	e, 
		pls_segurado			f, 
		pessoa_fisica			g, 
		pls_conta_coparticipacao	h, 
		pls_conta			i, 
		pls_segurado_carteira		j, 
		pls_ame_lote_rem_valor_cop	m 
	where	c.nr_seq_lote_rem		= d.nr_sequencia 
	and	c.nr_sequencia			= b.nr_seq_lote_rem_dest 
	and	b.nr_sequencia			= a.nr_seq_lote_rem_arq 
	and	a.nr_sequencia			= e.nr_seq_lote_rem_valor 
	and	f.nr_sequencia			= a.nr_seq_segurado 
	and 	e.nr_sequencia   		= m.nr_seq_rem_valor_detalhe 
	and 	m.nr_seq_conta_coparticipacao  = h.nr_sequencia 
	and	g.cd_pessoa_fisica		= f.cd_pessoa_fisica 
	and	a.nr_seq_mensalidade_seg	= h.nr_seq_mensalidade_seg 
	and	i.nr_sequencia			= h.nr_seq_conta 
	and	f.nr_sequencia			= j.nr_seq_segurado 
	and	a.nr_seq_lote_rem_arq		= nr_sequencia_p;
	
BEGIN 
 
begin 
arq_texto_w := utl_file.fopen(ds_local_p,nm_arquivo_p,'W');
exception 
when others then 
	if (SQLSTATE = -29289) then 
		ds_erro_w := 'O acesso ao arquivo foi negado pelo sistema operacional (access_denied).';
	elsif (SQLSTATE = -29298) then 
		ds_erro_w := 'O arquivo foi aberto usando FOPEN_NCHAR, mas efetuaram-se operações de I/O usando funções nonchar comos PUTF ou GET_LINE (charsetmismatch).';
	elsif (SQLSTATE = -29291) then 
		ds_erro_w := 'Não foi possível apagar o arquivo (delete_failed).';
	elsif (SQLSTATE = -29286) then 
		ds_erro_w := 'Erro interno desconhecido no package UTL_FILE (internal_error).';
	elsif (SQLSTATE = -29282) then 
		ds_erro_w := 'O handle do arquivo não existe (invalid_filehandle).';
	elsif (SQLSTATE = -29288) then 
		ds_erro_w := 'O arquivo com o nome especificado não foi encontrado neste local (invalid_filename).';
	elsif (SQLSTATE = -29287) then 
		ds_erro_w := 'O valor de MAX_LINESIZE para FOPEN() é inválido; deveria estar na faixa de 1 a 32767 (invalid_maxlinesize).';
	elsif (SQLSTATE = -29281) then 
		ds_erro_w := 'O parâmetro open_mode na chamda FOPEN é inválido (invalid_mode).';
	elsif (SQLSTATE = -29290) then 
		ds_erro_w := 'O parâmetro ABSOLUTE_OFFSET para a chamada FSEEK() é inválido; deveria ser maior do que 0 e menor do que o número total de bytes do arquivo (invalid_offset).';
	elsif (SQLSTATE = -29283) then 
		ds_erro_w := 'O arquivo não pôde ser aberto ou operado da forma desejada - ou o caminho não foi encontrado (invalid_operation).';
	elsif (SQLSTATE = -29280) then 
		ds_erro_w := 'O caminho especificado não existe ou não está visível ao Oracle (invalid_path).';
	elsif (SQLSTATE = -29284) then 
		ds_erro_w := 'Não é possível efetuar a leitura do arquivo (read_error).';
	elsif (SQLSTATE = -29292) then 
		ds_erro_w := 'Não é possível renomear o arquivo.';
	elsif (SQLSTATE = -29285) then 
		ds_erro_w := 'Não foi possível gravar no arquivo (write_error).';
	else 
		ds_erro_w := 'Erro desconhecido no package UTL_FILE.';
	end if;
end;
 
if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_erro_w);
end if;
 
for r_c01_w in C01 loop 
	begin		 
	ds_conteudo_w	:= 	substr(r_c01_w.nm_titular,1,50) ||';'|| substr(r_c01_w.nm_pessoa_fisica,1,50) ||';'|| substr(r_c01_w.cd_procedimento,1,10) ||';'|| substr(r_c01_w.ds_procedimento,1,100) ||';'|| 
				substr(r_c01_w.qt_liberada_copartic,1,3) ||';'|| r_c01_w.vl_coparticipacao ||';'|| substr(r_c01_w.nm_prestador,1,150) ||';'|| 'UNIMED SÃO JOSÉ DO RIO PRETO' ||';'|| 
				r_c01_w.vl_coparticipacao ||';'|| 'REAL' ||';'|| r_c01_w.nr_cpf ||';'|| ';'|| 
				r_c01_w.cd_usuario_plano_1 ||';'|| r_c01_w.dt_emissao ||';'|| r_c01_w.cd_usuario_plano_2 ||';'|| ';';
 
	utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
	utl_file.fflush(arq_texto_w);
	end;
end loop;
 
utl_file.fclose(arq_texto_w);
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_sjrp_arq_copartic ( nr_sequencia_p bigint, ds_local_p text, nm_arquivo_p text) FROM PUBLIC;

