-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_relat_referencia_fat ( nr_seq_lote_p pls_lote_faturamento.nr_sequencia%type, nr_seq_fatura_p pls_fatura.nr_sequencia%type, dt_inicio_ref_p text, dt_final_ref_p text, nm_usuario_p usuario.nm_usuario%type, cd_tipo_atendimento_p pls_tipo_atendimento.cd_tipo_atendimento%type, cd_cooperativa_p pls_congenere.cd_cooperativa%type, cd_operadora_empresa_p pls_intercambio.cd_operadora_empresa%type, ie_status_analise_p text, nr_seq_regra_fat_p bigint, ie_faturado_p text) AS $body$
DECLARE


qt_registro_w			integer;
ds_tipo_guia_w			w_pls_relat_ref_fat.ds_tipo_guia%type;
ds_tipo_atendimento_w		w_pls_relat_ref_fat.ds_tipo_atendimento%type;
nr_seq_congenere_ant_w		pls_congenere.nr_sequencia%type := null;
dt_inicio_ref_w			timestamp;
nr_seq_tipo_atendimento_w	pls_tipo_atendimento.nr_sequencia%type;
ds_status_w			w_pls_relat_ref_fat.nm_referencia%type;
ds_referencia_w			w_pls_relat_ref_fat.ds_referencia%type;
ie_pcmso_w			pls_segurado.ie_pcmso%type;
ie_tipo_segurado_w		pls_segurado.ie_tipo_segurado%type;
nr_seq_evento_w			pls_fatura_evento.nr_seq_evento%type;
nr_seq_relatorio_w		w_pls_relat_ref_fat.nr_sequencia%type;

C01 CURSOR FOR
	SELECT	f.nr_seq_congenere,
		count(distinct c.cd_guia_ok) qt_guia,
		c.ie_tipo_guia,
		c.nr_seq_tipo_atendimento,
		b.nm_fantasia,
		a.cd_cooperativa,
		j.ie_status,
		c.nr_seq_segurado,
		e.nr_seq_evento,
		p.ie_origem_protocolo
	FROM pls_lote_faturamento z, pls_conta_pos_estabelecido x, pls_fatura_conta t, pls_protocolo_conta p, pls_analise_conta j, pls_fatura f, pls_fatura_evento e, pls_conta c, pessoa_juridica b, pls_congenere a, pls_contrato_pagador k
LEFT OUTER JOIN pls_intercambio y ON (k.nr_seq_pagador_intercambio = y.nr_sequencia)
WHERE z.nr_sequencia			= x.nr_seq_lote_fat and c.nr_sequencia			= x.nr_seq_conta and z.nr_sequencia			= f.nr_seq_lote and f.nr_sequencia			= e.nr_seq_fatura and e.nr_sequencia			= t.nr_seq_fatura_evento and c.nr_sequencia			= t.nr_seq_conta and p.nr_sequencia			= c.nr_seq_protocolo and a.nr_sequencia 			= f.nr_seq_congenere and a.cd_cgc			= b.cd_cgc and k.nr_sequencia			= f.nr_seq_pagador  and j.nr_sequencia			= c.nr_seq_analise and ((x.ie_situacao	= 'A') or (coalesce(x.ie_situacao::text, '') = '')) and (f.nr_seq_congenere IS NOT NULL AND f.nr_seq_congenere::text <> '') and (c.cd_guia_ok IS NOT NULL AND c.cd_guia_ok::text <> '') and to_char(z.dt_mesano_referencia,'mm/yyyy') = to_char(coalesce(dt_inicio_ref_w,z.dt_mesano_referencia),'mm/yyyy') and ((c.nr_seq_tipo_atendimento = coalesce(nr_seq_tipo_atendimento_w,c.nr_seq_tipo_atendimento)) or
		coalesce(coalesce(c.nr_seq_tipo_atendimento,nr_seq_tipo_atendimento_w)::text, '') = '') and ((a.cd_cooperativa = coalesce(cd_cooperativa_p,a.cd_cooperativa)) or
		coalesce(coalesce(a.cd_cooperativa,cd_cooperativa_p)::text, '') = '') and ((y.cd_operadora_empresa = coalesce(cd_operadora_empresa_p,y.cd_operadora_empresa)) or
		coalesce(coalesce(y.cd_operadora_empresa,cd_operadora_empresa_p)::text, '') = '') and e.nr_seq_evento = coalesce(nr_seq_regra_fat_p,e.nr_seq_evento) and (((ie_status_analise_p = 'A') and (j.ie_status in ('G','A','S'))) or
		((ie_status_analise_p = 'E') and (j.ie_status in ('C','T','L'))) or (ie_status_analise_p = 'T')) and (((ie_faturado_p = 'S') and ((f.nr_titulo IS NOT NULL AND f.nr_titulo::text <> '') or (f.nr_titulo_ndc IS NOT NULL AND f.nr_titulo_ndc::text <> ''))) or
		((ie_faturado_p = 'N') and (coalesce(f.nr_titulo::text, '') = '') and (coalesce(f.nr_titulo_ndc::text, '') = '')) or (ie_faturado_p = 'A')) group by f.nr_seq_congenere,
		c.ie_tipo_guia,
		c.nr_seq_tipo_atendimento,
		b.nm_fantasia,
		a.cd_cooperativa,
		j.ie_status,
		c.nr_seq_segurado,
		e.nr_seq_evento,
		p.ie_origem_protocolo
	order by a.cd_cooperativa,
		c.ie_tipo_guia,
		f.nr_seq_congenere;

BEGIN
delete	FROM w_pls_relat_ref_fat
where	nm_usuario	= nm_usuario_p
or	dt_atualizacao	< clock_timestamp() - interval '2 days';

begin
select	max(nr_sequencia)
into STRICT	nr_seq_tipo_atendimento_w
from	pls_tipo_atendimento
where	cd_tipo_atendimento = cd_tipo_atendimento_p;
exception
when others then
	nr_seq_tipo_atendimento_w	:= null;
end;

if (dt_inicio_ref_p = '  /    ') then
	dt_inicio_ref_w	:= null;
else
	dt_inicio_ref_w	:= to_date('01/' || dt_inicio_ref_p);
end if;

for r_c01_w in c01 loop
	select	count(1)
	into STRICT	qt_registro_w
	from	w_pls_relat_ref_fat
	where	nr_seq_congenere = r_c01_w.nr_seq_congenere
	and	nm_usuario	= nm_usuario_p;

	if (qt_registro_w = 0) then
		if (nr_seq_congenere_ant_w IS NOT NULL AND nr_seq_congenere_ant_w::text <> '') then
			select	count(1)
			into STRICT	qt_registro_w
			from	w_pls_relat_ref_fat
			where	nr_seq_congenere	= nr_seq_congenere_ant_w
			and	nm_usuario		= nm_usuario_p
			and	ie_banda		= '4';

			if (qt_registro_w = 0) then
				select	coalesce(sum(coalesce((qt_guia)::numeric ,0)),0)
				into STRICT	qt_registro_w
				from	w_pls_relat_ref_fat
				where	nr_seq_congenere	= nr_seq_congenere_ant_w
				and	nm_usuario		= nm_usuario_p
				and	ie_banda		= '3';

				insert	into w_pls_relat_ref_fat(nr_sequencia,
					nm_usuario,
					dt_atualizacao,
					nm_usuario_nrec,
					dt_atualizacao_nrec,
					nr_seq_congenere,
					ie_banda,
					qt_total_guia)
				values (nextval('w_pls_relat_ref_fat_seq'),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nr_seq_congenere_ant_w,
					'4',
					'TOTAL DE GUIAS: '||qt_registro_w);
			end if;

			nr_seq_congenere_ant_w := null;
		end if;

		insert	into w_pls_relat_ref_fat(nr_sequencia,
			nm_usuario,
			dt_atualizacao,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			nm_fantasia,
			nr_seq_congenere,
			ie_banda)
		values (nextval('w_pls_relat_ref_fat_seq'),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			'Área de ação: '||lpad(r_c01_w.cd_cooperativa,4,'0')||'  '||upper(r_c01_w.nm_fantasia),
			r_c01_w.nr_seq_congenere,
			'1');

		insert	into w_pls_relat_ref_fat(nr_sequencia,
			nm_usuario,
			dt_atualizacao,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			nm_fantasia,
			nr_seq_congenere,
			ds_tipo_guia,
			ds_consulta,
			ds_tipo_atendimento,
			ds_referencia,
			nm_referencia,
			qt_guia,
			ie_banda)
		values (nextval('w_pls_relat_ref_fat_seq'),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			null,
			r_c01_w.nr_seq_congenere,
			'Tipo de guia',
			'Só consulta',
			'Tipo atendimento',
			'Referência',
			'Status Análise',
			'Qtd guias',
			'2');

		qt_registro_w := 1;
	end if;

	nr_seq_congenere_ant_w := r_c01_w.nr_seq_congenere;

	if (qt_registro_w > 0) then
		select	max(ds_expressao)
		into STRICT	ds_tipo_guia_w
		from	valor_dominio_v
		where	cd_dominio = 1746
		and 	vl_dominio = r_c01_w.ie_tipo_guia;

		select	max(ds_tipo_atendimento)
		into STRICT	ds_tipo_atendimento_w
		from	pls_tipo_atendimento
		where	nr_sequencia	= r_c01_w.nr_seq_tipo_atendimento;

		if (r_c01_w.ie_status in ('C','T','L')) then -- Cancelada - Fechada - A700 finalizado
			ds_status_w	:= 'Conta Encerrada';

		elsif (r_c01_w.ie_status in ('G','A','S')) then -- Em análise - Liberado para Fechamento - Pendente de Liberação - Usuário (aguardando ação)
			ds_status_w	:= 'Conta Análise';
		end if;

		select	max(coalesce(ie_pcmso,'N')),
			max(coalesce(ie_tipo_segurado,'X'))
		into STRICT	ie_pcmso_w,
			ie_tipo_segurado_w
		from	pls_segurado
		where	nr_sequencia	= r_c01_w.nr_seq_segurado;

		if (ie_pcmso_w = 'S') then
			ds_referencia_w	:= 'PCMSO';

		elsif (r_c01_w.nr_seq_evento = 94) then
			ds_referencia_w	:= 'Projeto Coração';

		elsif (r_c01_w.ie_origem_protocolo = 'A') then
			ds_referencia_w	:= 'A500';

		elsif (r_c01_w.ie_origem_protocolo = 'T') then
			ds_referencia_w	:= 'On-Line';

		elsif (ie_tipo_segurado_w = 'I') then
			ds_referencia_w	:= 'Usuário Eventual';

		elsif (ie_tipo_segurado_w = 'H') then
			ds_referencia_w	:= 'Usuário Habitual';

		else
			ds_referencia_w	:= 'Usuário 030';
		end if;

		select	max(nr_sequencia)
		into STRICT	nr_seq_relatorio_w
		from	w_pls_relat_ref_fat
		where	nr_seq_congenere	= r_c01_w.nr_seq_congenere
		and	ds_tipo_guia		= ds_tipo_guia_w
		and (ds_tipo_atendimento	= ds_tipo_atendimento_w or (coalesce(ds_tipo_atendimento::text, '') = '' and coalesce(ds_tipo_atendimento_w::text, '') = ''))
		and	ds_referencia		= ds_referencia_w
		and	nm_referencia		= ds_status_w
		and	ie_banda		= '3';

		if (coalesce(nr_seq_relatorio_w::text, '') = '') then
			insert	into w_pls_relat_ref_fat(nr_sequencia,
				nm_usuario,
				dt_atualizacao,
				nm_usuario_nrec,
				dt_atualizacao_nrec,
				nm_fantasia,
				nr_seq_congenere,
				ds_tipo_guia,
				ds_consulta,
				ds_tipo_atendimento,
				ds_referencia,
				nm_referencia,
				qt_guia,
				ie_banda)
			values (nextval('w_pls_relat_ref_fat_seq'),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				null,
				r_c01_w.nr_seq_congenere,
				ds_tipo_guia_w,
				'-',
				ds_tipo_atendimento_w,
				ds_referencia_w, --'Intercâmbio Eventual',
				ds_status_w,
				r_c01_w.qt_guia,
				'3');
		else
			update	w_pls_relat_ref_fat
			set	qt_guia		= coalesce(qt_guia,0) + coalesce(r_c01_w.qt_guia,0)
			where	nr_sequencia	= nr_seq_relatorio_w;
		end if;
	end if;
end loop;

if (nr_seq_congenere_ant_w IS NOT NULL AND nr_seq_congenere_ant_w::text <> '') then
	select	count(1)
	into STRICT	qt_registro_w
	from	w_pls_relat_ref_fat
	where	nr_seq_congenere	= nr_seq_congenere_ant_w
	and	nm_usuario		= nm_usuario_p
	and	ie_banda		= '4';

	if (qt_registro_w = 0) then
		select	coalesce(sum(coalesce((qt_guia)::numeric ,0)),0)
		into STRICT	qt_registro_w
		from	w_pls_relat_ref_fat
		where	nr_seq_congenere	= nr_seq_congenere_ant_w
		and	nm_usuario		= nm_usuario_p
		and	ie_banda		= '3';

		insert	into w_pls_relat_ref_fat(nr_sequencia,
			nm_usuario,
			dt_atualizacao,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			nr_seq_congenere,
			ie_banda,
			qt_total_guia)
		values (nextval('w_pls_relat_ref_fat_seq'),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nr_seq_congenere_ant_w,
			'4',
			'TOTAL DE GUIAS: '||qt_registro_w);
	end if;

	nr_seq_congenere_ant_w := null;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_relat_referencia_fat ( nr_seq_lote_p pls_lote_faturamento.nr_sequencia%type, nr_seq_fatura_p pls_fatura.nr_sequencia%type, dt_inicio_ref_p text, dt_final_ref_p text, nm_usuario_p usuario.nm_usuario%type, cd_tipo_atendimento_p pls_tipo_atendimento.cd_tipo_atendimento%type, cd_cooperativa_p pls_congenere.cd_cooperativa%type, cd_operadora_empresa_p pls_intercambio.cd_operadora_empresa%type, ie_status_analise_p text, nr_seq_regra_fat_p bigint, ie_faturado_p text) FROM PUBLIC;

