-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_pre_fat_f700_efd ( nr_seq_controle_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, cd_empresa_p bigint, ds_separador_p text, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) AS $body$
DECLARE

 
pr_imposto_cofins_w		double precision;
pr_imposto_pis_w		double precision;
aliquota_iss_w			double precision;
cd_tributo_pis_w		smallint;
cd_tributo_cofins_w		smallint;
cd_tributo_iss_w		smallint;
nr_seq_regra_efd_w		bigint;
nr_versao_efd_w			varchar(5);
tp_registro_w			varchar(4);
nr_linha_w				bigint := qt_linha_p;
nr_seq_registro_w		bigint := nr_sequencia_p;
ds_arquivo_w			varchar(4000);
ds_arquivo_compl_w		varchar(4000);
ds_linha_w				varchar(8000);
sep_w					varchar(1) := ds_separador_p;
nr_sequencia_w			bigint;
vl_material_incentivo_w		double precision;
vl_base_calculo_tributo_w	double precision;
vl_pis_w				double precision;
vl_cofins_w				double precision;
vl_iss_retido_w			double precision;
vl_pis_retido_w			double precision;
vl_cofins_retido_w		double precision;
ie_local_gerar_sped_w		varchar(1);
ie_consistir_cpf_cnpj_w		varchar(1);
vl_deduzir_pis_w		double precision := 0;
vl_deduzir_cofins_w		double precision := 0;
vl_base_deducao_w		double precision := 0;
qt_registros_w			bigint;
nr_seq_data_w			bigint;
vl_glosa_w			double precision;
vl_monofasico_w		double precision;
ds_convenio_w		varchar(255);

c01 CURSOR FOR 
	SELECT	distinct 'F700'		tp_registro, 
			'99'		ie_origem_deducao, -- outras deduções 
			'1'		ie_natureza_deducao, -- cumulativo 
			CASE WHEN c.ie_tipo_convenio=1 THEN a.cd_pessoa_fisica  ELSE c.cd_cgc END 	cd_participante, 
			''		ds_informacoes 
	FROM convenio c, pre_faturamento f
LEFT OUTER JOIN conta_paciente p ON (f.nr_interno_conta = p.nr_interno_conta)
LEFT OUTER JOIN atendimento_paciente a ON (p.nr_atendimento = a.nr_atendimento)
WHERE f.cd_convenio = c.cd_convenio   and trunc(f.dt_referencia,'mm') = trunc(dt_inicio_p,'mm') and f.cd_estabelecimento = cd_estabelecimento_p;

vet01	C01%RowType;


BEGIN 
 
select	nr_seq_regra_efd 
into STRICT	nr_seq_regra_efd_w 
from	fis_efd_controle 
where	nr_sequencia = nr_seq_controle_p;
 
select	cd_tributo_pis, 
	cd_tributo_cofins, 
	cd_tributo_iss 
into STRICT	cd_tributo_pis_w, 
	cd_tributo_cofins_w, 
	cd_tributo_iss_w 
from	fis_regra_efd 
where	nr_sequencia = nr_seq_regra_efd_w;
 
pr_imposto_pis_w 	:= obter_pr_imposto(cd_tributo_pis_w);
pr_imposto_cofins_w 	:= obter_pr_imposto(cd_tributo_cofins_w);
 
open C01;
loop 
fetch C01 into 
	vet01;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
 
	select	count(*) 
	into STRICT	qt_registros_w 
	from	titulo_receber r, 
		titulo_receber_liq l 
	where	r.nr_titulo = l.nr_titulo 
	and	dt_recebimento between dt_inicio_p and dt_fim_p 
	and	r.cd_cgc = vet01.cd_participante;
 
	if (qt_registros_w > 0) then 
		select	coalesce(sum(vl_glosa),0) vl_glosa 
		into STRICT	vl_glosa_w 
		from	titulo_receber r, 
			titulo_receber_liq l 
		where	r.nr_titulo = l.nr_titulo 
		and	dt_recebimento between dt_inicio_p and dt_fim_p 
		and	r.cd_cgc = vet01.cd_participante;
	else 
		vl_glosa_w := 0;
	end if;
 
	select	count(*) 
	into STRICT	qt_registros_w 
	from	efd_monofasico m 
	where	m.cd_pessoa_fisica = vet01.cd_participante;
 
	if (qt_registros_w > 0) then 
		select	coalesce(sum(vl_material),0) 
		into STRICT	vl_monofasico_w 
		from	efd_monofasico m 
		where	m.cd_pessoa_fisica = vet01.cd_participante;
	else 
		vl_monofasico_w := 0;
	end if;
 
	select	'F700 - ' || obter_nome_pf_pj('',vet01.cd_participante) 
	into STRICT 	ds_convenio_w 
	;
	 
	vl_base_deducao_w 	:= vl_monofasico_w + vl_glosa_w;
	vl_deduzir_pis_w	:= vl_base_deducao_w * pr_imposto_pis_w/100;
	vl_deduzir_cofins_w	:= vl_base_deducao_w * pr_imposto_cofins_w/100;
 
	ds_linha_w	:= substr(	sep_w || vet01.tp_registro	 				|| 
					sep_w || vet01.ie_origem_deducao				|| 
					sep_w || vet01.ie_natureza_deducao				|| 
					sep_w || replace(campo_mascara(vl_deduzir_pis_w,2),'.',',')	|| 
					sep_w || replace(campo_mascara(vl_deduzir_cofins_w,2),'.',',')	|| 
					sep_w || replace(campo_mascara(vl_base_deducao_w,2),'.',',')	|| 
					sep_w || vet01.cd_participante					|| 
					sep_w || vet01.ds_informacoes					|| sep_w,1,8000);
 
	ds_arquivo_w := substr(ds_linha_w,1,4000);
	ds_arquivo_compl_w := substr(ds_linha_w,4001,4000);
	nr_seq_registro_w := nr_seq_registro_w + 1;
	nr_linha_w := nr_linha_w + 1;
 
	insert into fis_efd_arquivo( 
					nr_sequencia, 
					nm_usuario, 
					dt_atualizacao, 
					nm_usuario_nrec, 
					dt_atualizacao_nrec, 
					nr_seq_controle_efd, 
					nr_linha, 
					cd_registro, 
					ds_arquivo, 
					ds_arquivo_compl) 
			values ( 
					nr_seq_registro_w, 
					nm_usuario_p, 
					clock_timestamp(), 
					nm_usuario_p, 
					clock_timestamp(), 
					nr_seq_controle_p, 
					nr_linha_w, 
					vet01.tp_registro, 
					ds_arquivo_w, 
					ds_arquivo_compl_w);
 
	end;
end loop;
close C01;
 
qt_linha_p := nr_linha_w;
nr_sequencia_p := nr_seq_registro_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_pre_fat_f700_efd ( nr_seq_controle_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, cd_empresa_p bigint, ds_separador_p text, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) FROM PUBLIC;

