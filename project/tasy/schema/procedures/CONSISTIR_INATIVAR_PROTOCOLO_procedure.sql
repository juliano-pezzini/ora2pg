-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_inativar_protocolo ( cd_pessoa_fisica_p text, nr_seq_paciente_p bigint, ie_opcao_p text, ds_mensagem_p INOUT text) AS $body$
DECLARE

 
/* 
Descrição			Opção	 
Verificar Registros		VR 
Caso tenha registro, abortar	AB 
Inativar todos registros		I 
*/
				 
					 
ie_suspender_w			varchar(2);
nr_seq_paciente_w		bigint;
nr_prescricao_susp_w		bigint;
nr_seq_atendimento_w		bigint;
nr_prescricao_w			bigint;
nm_usuario_w			varchar(15);
qt_reg_w			smallint;
ds_mensagem_w			varchar(32000);
nr_ciclo_ant_w			smallint := 0;
nr_ciclo_w			smallint;
ds_dia_ciclo_w			varchar(5);
dt_ciclo_w			timestamp;
dt_cancelamento_w		timestamp;
ds_protocolo_w			varchar(350);
cd_protocolo_w			bigint;
nr_seq_medicacao_w		integer;
cd_protocolo_ant_w		bigint := 0;
ie_inativar_ant_w		varchar(3);
cd_pessoa_fisica_w		varchar(10);
	
					 
c01 CURSOR FOR 
	SELECT	a.nr_seq_paciente, 
		b.nr_seq_atendimento, 
		a.cd_protocolo, 
		a.nr_seq_medicacao, 
		b.nr_prescricao, 
		b.nr_ciclo, 
		b.ds_dia_ciclo		 
	from	paciente_setor a, 
		paciente_atendimento b 
	where	a.cd_pessoa_fisica	= cd_pessoa_fisica_p 
	and	a.nr_seq_paciente 	<> nr_seq_paciente_p 
	and	coalesce(trunc(b.dt_real),trunc(b.dt_prevista)) >= trunc(clock_timestamp()) 
	and 	substr(Obter_status_Paciente_qt(b.nr_seq_atendimento,b.dt_inicio_adm,b.dt_fim_adm,b.nr_seq_local,'S',b.dt_chegada,'C'),1,60) <> 83 
	and	a.nr_seq_paciente = b.nr_seq_paciente 
	and	a.ie_status = 'A' 
	and	coalesce(b.dt_cancelamento::text, '') = ''	 
	order by b.nr_seq_atendimento;
		
c02 CURSOR FOR 
	SELECT	a.nr_seq_paciente, 
		b.nr_seq_atendimento, 
		b.nr_prescricao 
	from	paciente_setor a, 
		paciente_atendimento b 
	where	a.cd_pessoa_fisica	= cd_pessoa_fisica_p 
	and	a.nr_seq_paciente 	<> nr_seq_paciente_p 
	and	coalesce(trunc(b.dt_real),trunc(b.dt_prevista)) >= trunc(clock_timestamp()) 
	and	a.nr_seq_paciente = b.nr_seq_paciente 
	and 	substr(Obter_status_Paciente_qt(b.nr_seq_atendimento,b.dt_inicio_adm,b.dt_fim_adm,b.nr_seq_local,'S',b.dt_chegada,'C'),1,60) <> 83 
	and	coalesce(b.dt_cancelamento::text, '') = '' 
	and	a.ie_status = 'A' 
	order by b.nr_seq_atendimento;
	

BEGIN 
 
nm_usuario_w := wheb_usuario_pck.get_nm_usuario;
 
ie_inativar_ant_w := obter_param_usuario(281, 115, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_inativar_ant_w);
 
If (ie_opcao_p = 'VR') or (ie_opcao_p = 'AB')then 
	open C01;
	loop 
	fetch C01 into	 
		nr_seq_paciente_w, 
		nr_seq_atendimento_w, 
		cd_protocolo_w, 
		nr_seq_medicacao_w, 
		nr_prescricao_w, 
		nr_ciclo_w, 
		ds_dia_ciclo_w;		
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		ds_protocolo_w := null;		
		 
		if (cd_protocolo_w <> cd_protocolo_ant_w) then 
			 
			cd_protocolo_ant_w := cd_protocolo_w;
			ds_protocolo_w	:= substr(obter_desc_protocolo(cd_protocolo_w),1,255);
			 
			if (nr_seq_medicacao_w IS NOT NULL AND nr_seq_medicacao_w::text <> '') then 
				ds_protocolo_w	:= ds_protocolo_w || ' - ' || substr(obter_desc_protocolo_medic(nr_seq_medicacao_w,cd_protocolo_w),1,50) ||':';
			end if;	
			 
			ds_protocolo_w	:= chr(10)||ds_protocolo_w||chr(10)||chr(9);
			nr_ciclo_ant_w	:= 0;
					 
		end if;		
		 
		 
		if (coalesce(ds_mensagem_w::text, '') = '') then 
			ds_mensagem_w	:= substr(obter_texto_tasy(190541, wheb_usuario_pck.get_nr_seq_idioma),1,2000);
		end if;
		 
		 
		ds_mensagem_w := substr( ds_mensagem_w ||ds_protocolo_w,1,2000);		
		 
		if (nr_ciclo_w <> nr_ciclo_ant_w) then 
			 
			ds_mensagem_w := substr( ds_mensagem_w || obter_desc_expressao(284890)||' '||nr_ciclo_w||': '||ds_dia_ciclo_w,1,2000); --ciclo 
			nr_ciclo_ant_w := nr_ciclo_w;
		 
		else 
			ds_mensagem_w := substr( ds_mensagem_w ||', '||ds_dia_ciclo_w,1,2000);		
		 
		end if;
		 
		if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then 
			ds_mensagem_w := substr( ds_mensagem_w || '( '|| obter_desc_expressao(346473) ||nr_prescricao_w||' )',1,2000);--Prescr 
		end if;
				 
		end;
	end loop;
	close C01;	
	 
	ds_mensagem_p := substr(ds_mensagem_w,1,225);
	 
else	 
	 
	 
	open C02;
	loop 
	fetch C02 into	 
		nr_seq_paciente_w, 
		nr_seq_atendimento_w, 
		nr_prescricao_susp_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin	 
			CALL suspender_dia_tratamento_onco(nr_prescricao_susp_w, nr_seq_atendimento_w, nm_usuario_w);	
			commit;	
		end;
	end loop;
	close C02;
	 
	if (ie_inativar_ant_w <> 'Q') and (ie_inativar_ant_w <> 'M') and (ie_inativar_ant_w <> 'N')then 
	 
		update 	paciente_setor 
		set 	ie_status = 'I' 
		where 	cd_pessoa_fisica = cd_pessoa_fisica_p 
		and	ie_status <> 'F' 
		and	nr_seq_paciente	<> nr_seq_paciente_p;
		 
		commit;
		 
	end if;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_inativar_protocolo ( cd_pessoa_fisica_p text, nr_seq_paciente_p bigint, ie_opcao_p text, ds_mensagem_p INOUT text) FROM PUBLIC;

