-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_gera_ciclo_oncologia ( cd_pessoa_fisica_p text, nr_seq_paciente_p bigint, nr_ciclo_inicial_p bigint, nr_ciclo_final_p bigint, dt_inicio_p timestamp, nr_seq_protoclo_p bigint, nr_dia_inicial_p bigint, nr_atendimento_p bigint, ie_gera_data_real_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_consiste_dia_util_p text default 'N', ds_msg_p INOUT text DEFAULT NULL, ds_erro_p INOUT text DEFAULT NULL) AS $body$
DECLARE


ie_consiste_lib_ciclo_w	varchar(1);
qt_peso_w			real;
qt_altura_w		smallint;
qt_auc_w			real;
qt_creatinina_w		real;
ie_l_dl_creatinina_w	smallint;
qt_redutor_sc_w		double precision;
qt_clearance_w		double precision;
qt_carboplatina_w		double precision;
ie_gerado_w				varchar(10);
ds_Retorno_quimio_w	varchar(255);


BEGIN

select	max(qt_peso),
	max(qt_altura),
	max(qt_auc),
	max(qt_creatinina),
	max(ie_l_dl_creatinina),
	max(qt_redutor_sc)
into STRICT	qt_peso_w,
	qt_altura_w,
	qt_auc_w,
	qt_creatinina_w,
	ie_l_dl_creatinina_w,
	qt_redutor_sc_w
from	can_loco_regional
where	nr_sequencia =
	(SELECT	max(b.nr_sequencia)
	from	can_loco_regional b
	where	b.cd_estabelecimento	= cd_estabelecimento_p
	and	b.cd_pessoa_fisica		= cd_pessoa_fisica_p);

if (coalesce(qt_peso_w::text, '') = '') then
	ds_erro_p	:= substr(obter_texto_tasy(60000, wheb_usuario_pck.get_nr_seq_idioma),1,255);

elsif (coalesce(qt_altura_w::text, '') = '') then
	ds_erro_p	:= substr(obter_texto_tasy(60002, wheb_usuario_pck.get_nr_seq_idioma),1,255);

else
	begin
	/* Quimioterapia - Parâmetro [17] - Permite gerar ciclo sem liberação prévia do médico */

	ie_consiste_lib_ciclo_w := obter_param_usuario(3130, 17, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_consiste_lib_ciclo_w);

	if (ie_consiste_lib_ciclo_w = 'N') then
		CALL consiste_ciclo_lib(nr_seq_paciente_p, coalesce(nr_ciclo_inicial_p, 0), coalesce(nr_ciclo_final_p, 0));
	end if;

	SELECT * FROM gerar_ciclo_oncologia(
		nr_seq_paciente_p, dt_inicio_p, nr_seq_protoclo_p, coalesce(nr_ciclo_inicial_p, 1), coalesce(nr_ciclo_final_p, 1), nr_dia_inicial_p, null, nr_atendimento_p, qt_peso_w, nm_usuario_p, ie_gera_data_real_p, ie_consiste_dia_util_p, ie_gerado_w, ds_Retorno_quimio_w) INTO STRICT ie_gerado_w, ds_Retorno_quimio_w;

	SELECT * FROM calcular_caboplanina(
		nr_seq_paciente_p, qt_peso_w, qt_altura_w, qt_redutor_sc_w, qt_creatinina_w, ie_l_dl_creatinina_w, qt_auc_w, qt_clearance_w, qt_carboplatina_w) INTO STRICT qt_clearance_w, qt_carboplatina_w;

	ds_msg_p	:= substr(obter_texto_tasy(60006, wheb_usuario_pck.get_nr_seq_idioma),1,255);
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_gera_ciclo_oncologia ( cd_pessoa_fisica_p text, nr_seq_paciente_p bigint, nr_ciclo_inicial_p bigint, nr_ciclo_final_p bigint, dt_inicio_p timestamp, nr_seq_protoclo_p bigint, nr_dia_inicial_p bigint, nr_atendimento_p bigint, ie_gera_data_real_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_consiste_dia_util_p text default 'N', ds_msg_p INOUT text DEFAULT NULL, ds_erro_p INOUT text DEFAULT NULL) FROM PUBLIC;

