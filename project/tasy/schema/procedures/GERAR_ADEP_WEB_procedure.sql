-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_adep_web ( nr_atendimento_p bigint, id_sessao_p text, nm_usuario_p text, dt_filtro_p timestamp default clock_timestamp(), qt_horas_adicionais_p bigint default 0, ie_exibir_dt_fim_p text default 'N', IE_PRESCRICAO_FUTURA_P text default 'N') AS $body$
DECLARE


ds_material_w			varchar(4000);
ds_material_ww			varchar(4000);
ie_exibe_dil_medic_w	varchar(1);
ie_necessita_aprezar_w varchar(1);
ie_verify_ie_science_w	varchar(1);	
ie_nursing_science_w	varchar(1);	
ie_nursing_science_ww	varchar(1);	
ie_suspended_w			varchar(1);
ie_existe_refeicao_w    varchar(1);
ie_show_future_items_w  varchar(1);
rule_quantity_w       	integer;
ie_origem_inf_w         prescr_material.nr_sequencia%type;
dt_suspensao_w          cpoe_material.dt_suspensao%type;
dt_lib_suspensao_w      cpoe_material.dt_lib_suspensao%type;
							
C01 CURSOR FOR
	SELECT *
	from	W_ADEP_T_V
	where	(nr_sequencia IS NOT NULL AND nr_sequencia::text <> '');
	
C02 CURSOR FOR
	SELECT	*
	from	W_ADEP_T
	where	(nr_sequencia IS NOT NULL AND nr_sequencia::text <> '')
	and 	nm_usuario = nm_usuario_p
	and 	ie_tipo_item = 'XH'  LIMIT 1;
  cpoe_mat RECORD;
BEGIN


delete from adep_horarios_web
where id_sessao_web = id_sessao_p
and nm_usuario = nm_usuario_p;

delete from adep_horarios_web
where 	dt_atualizacao_nrec < (clock_timestamp() - interval '4 days'/60)  LIMIT 500;

ie_exibe_dil_medic_w := Obter_Param_Usuario(1113, 41, Obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_exibe_dil_medic_w);
ie_verify_ie_science_w := Obter_Param_Usuario(1113, 716, Obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_verify_ie_science_w);
ie_show_future_items_w := Obter_Param_Usuario(1113, 737, Obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_show_future_items_w);
	
for r_c01 in c01 loop
	begin
	ie_suspended_w := 'N';
	ds_material_w := r_c01.DS_PRESCRITO;	
	ie_nursing_science_w := r_c01.IE_CIENCIA;
	ie_existe_refeicao_w    := 'N';
	ds_material_ww			:= null;						
	
	if (r_c01.IE_TIPO_ITEM in ('M','MAT','SOL','P','C','G','L','I','D','SNE','S','LD','J','NAN','NPP','DI','O','HM','E','R', 'IA') and coalesce(r_c01.NR_SEQ_CPOE,0) > 0) then
		
		if (r_c01.IE_TIPO_ITEM = 'D') then
		    select coalesce(max('S'),'N')
		    into STRICT   ie_existe_refeicao_w
		    from   prescr_dieta_hor    a,
			    prescr_dieta    b
		    where   b.nr_sequencia = a.nr_seq_dieta
		    and     b.nr_prescricao = a.nr_prescricao
		    and     b.nr_seq_dieta_cpoe = r_c01.nr_seq_cpoe
		    and     (a.cd_refeicao IS NOT NULL AND a.cd_refeicao::text <> '');
		end if;
    
        	if (r_c01.IE_TIPO_ITEM <> 'D' or ie_existe_refeicao_w = 'N') then
			ds_material_ww := adep_obter_desc_info_material(r_c01.NR_SEQ_CPOE,r_c01.IE_TIPO_ITEM, dt_filtro_p, qt_horas_adicionais_p, ie_exibir_dt_fim_p);
		end if;
		
		if (ds_material_ww IS NOT NULL AND ds_material_ww::text <> '') then
			ds_material_w := ds_material_ww;
		end if;
	end if;
	
	dt_suspensao_w := cpoe_obter_dt_suspensao(r_c01.NR_SEQ_CPOE, get_item_type_cpoe_ack(r_c01.IE_TIPO_ITEM));
	dt_lib_suspensao_w := cpoe_obter_dt_lib_suspensao(r_c01.NR_SEQ_CPOE, get_item_type_cpoe_ack(r_c01.IE_TIPO_ITEM));
	if (dt_suspensao_w IS NOT NULL AND dt_suspensao_w::text <> '' AND dt_lib_suspensao_w IS NOT NULL AND dt_lib_suspensao_w::text <> '') then
		ie_suspended_w := 'S';	
	end if;
	
	if (ie_verify_ie_science_w in ('S', 'T') and coalesce(r_c01.NR_SEQ_CPOE,0) > 0) then	
		if (ie_suspended_w = 'N') then	
			ie_nursing_science_ww :=  obtain_cpoe_item_less_lib_nur(nr_atendimento_p, r_c01.NR_SEQ_CPOE,'N');	
		else	
			if (ie_verify_ie_science_w = 'T') then	
				ie_nursing_science_ww := obtain_cpoe_item_less_lib_nur(nr_atendimento_p, r_c01.NR_SEQ_CPOE,'S');	
			else	
				ie_nursing_science_ww := 'S';	
			end if;	
		end if;		
	end if;	
		
	if ((ie_nursing_science_ww IS NOT NULL AND ie_nursing_science_ww::text <> '') and ie_verify_ie_science_w <> 'N') then	
		ie_nursing_science_w := ie_nursing_science_ww;	
	end if;

    if (ie_verify_ie_science_w in ('S', 'T') AND r_c01.IE_TIPO_ITEM = 'MAT' AND ie_nursing_science_w = 'N') then

        select count(nr_sequencia)
        into STRICT ie_origem_inf_w
        from prescr_material a, prescr_medica b
        where a.nr_prescricao = obter_max_prescr_adep(r_c01.NR_PRESCRICOES)
            and a.cd_material = r_c01.CD_ITEM
            and b.nr_prescricao = a.nr_prescricao
            and b.nr_atendimento = nr_atendimento_p
            and a.ie_origem_inf = 'K'
            and (nr_seq_kit IS NOT NULL AND nr_seq_kit::text <> '');

        if (ie_origem_inf_w > 0) then 
            ie_nursing_science_w := 'S';
        end if;
    end if;

	ie_necessita_aprezar_w := 'N';

	for cpoe_mat in (SELECT DS_HORARIOS, IE_SEM_APRAZAMENTO from cpoe_material where nr_sequencia = r_c01.NR_SEQ_CPOE) loop
		if (coalesce(cpoe_mat.DS_HORARIOS::text, '') = '' and cpoe_mat.IE_SEM_APRAZAMENTO = 'S') then
		  ie_necessita_aprezar_w := 'S';
		end if;
	end loop;  	

insert into ADEP_HORARIOS_WEB(
			 ID_SESSAO_WEB,
			 NM_USUARIO,
			 DT_ATUALIZACAO_NREC,
			 IE_SAEGRUPO,
			 IE_ORDEM,
			 NR_SEQ_ORDEM,
			 NR_SEQUENCIA,
			 IE_TIPO_ITEM,
			 NR_PRESCRICAO,
			 NR_SEQ_ITEM,
			 CD_ITEM,
			 CD_INTERVALO,
			 QT_ITEM,
			 IE_ACM_SN,
			 IE_STATUS_ITEM,
			 DS_PRESCRITO,
			 DS_PRESCRITO_CPOE,
			 DS_PRESCRICAO,
			 NR_PRESCRICOES,
			 DS_DILUICAO,
			 DS_INF_DIL,
			 NR_DIA_UTIL,
			 IE_DIFERENCIADO,
			 NR_SEQ_PROC_INTERNO,
			 DT_PREV_TERM,
			 IE_PENDENTE_LIBERACAO,
			 IE_MEDIC_CONTROLADO,
			 IE_MEDICACAO_PACIENTE,
			 NR_AGRUPAMENTO,
			 IE_PRESCRICAO_ALTA,
			 NR_SEQ_PROT_GLIC,
			 IE_HORARIO,
			 IE_VIA_APLICACAO,
			 NR_SEQ_APRES_INF,
			 NR_ETAPA_SOL,
			 DS_OBSERVACAO_PROC,
			 IE_OBS_MEDICO,
			 IE_DILUIDO,
			 CD_MOTIVO_BAIXA,
			 IE_COMPOSTO,
			 NR_SEQ_REGISTRO,
			 IE_ALTO_RISCO,
			 DS_COMPONENTES,
			 IE_CIENCIA,
			 IE_QUIMIO,
			 NR_SEQ_GRUPO_INTERV,
			 IE_PADRONIZADO,
			 IE_UTIL_HEMOCOMPONENTE,
			 IE_VENCIDA,
			 NR_AGRUP_PROT,
			 CD_UNIDADE_MEDIDA,
			 HORA1,
			 HORA2,
			 HORA3,
			 HORA4,
			 HORA5,
			 HORA6,
			 HORA7,
			 HORA8,
			 HORA9,
			 HORA10,
			 HORA11,
			 HORA12,
			 HORA13,
			 HORA14,
			 HORA15,
			 HORA16,
			 HORA17,
			 HORA18,
			 HORA19,
			 HORA20,
			 HORA21,
			 HORA22,
			 HORA23,
			 HORA24,
			 HORA25,
			 HORA26,
			 HORA27,
			 HORA28,
			 HORA29,
			 HORA30,
			 HORA31,
			 HORA32,
			 HORA33,
			 HORA34,
			 HORA35,
			 HORA36,
			 HORA37,
			 HORA38,
			 HORA39,
			 HORA40,
			 IE_SOL_CUSTO,
			 IE_HEMODIALISE,
			 IE_ITEM_ORDEM,
			 IE_ATRASADO,
			 IE_REGRA_DISP,
			 NR_SEQ_CPOE,
			 NR_ATENDIMENTO,
			 IE_CLASSIF_ADEP,
			 IE_RISCO_QUEDA,
			 IE_NECESSITA_APRAZAR,
			 IE_PRESCRICAO_ANESTESIA)
		values (
			 id_sessao_p,
			 nm_usuario_p,
			 clock_timestamp(),
			 r_c01.IE_SAEGRUPO,
			 r_c01.IE_ORDEM,
			 r_c01.NR_SEQ_ORDEM,
			 r_c01.NR_SEQUENCIA,
			 r_c01.IE_TIPO_ITEM,
			 r_c01.NR_PRESCRICAO,
			 r_c01.NR_SEQ_ITEM,
			 r_c01.CD_ITEM,
			 r_c01.CD_INTERVALO,
			 r_c01.QT_ITEM,
			 r_c01.IE_ACM_SN,
			 r_c01.IE_STATUS_ITEM,
			 r_c01.DS_PRESCRITO,
			 ds_material_w,
			 r_c01.DS_PRESCRICAO,
			 r_c01.NR_PRESCRICOES,
			 r_c01.DS_DILUICAO,
			 r_c01.DS_INF_DIL,
			 r_c01.NR_DIA_UTIL,
			 r_c01.IE_DIFERENCIADO,
			 r_c01.NR_SEQ_PROC_INTERNO,
			 r_c01.DT_PREV_TERM,
			 r_c01.IE_PENDENTE_LIBERACAO,
			 r_c01.IE_MEDIC_CONTROLADO,
			 r_c01.IE_MEDICACAO_PACIENTE,
			 r_c01.NR_AGRUPAMENTO,
			 r_c01.IE_PRESCRICAO_ALTA,
			 r_c01.NR_SEQ_PROT_GLIC,
			 r_c01.IE_HORARIO,
			 r_c01.IE_VIA_APLICACAO,
			 r_c01.NR_SEQ_APRES_INF,
			 r_c01.NR_ETAPA_SOL,
			 r_c01.DS_OBSERVACAO_PROC,
			 r_c01.IE_OBS_MEDICO,
			 r_c01.IE_DILUIDO,
			 r_c01.CD_MOTIVO_BAIXA,
			 r_c01.IE_COMPOSTO,
			 r_c01.NR_SEQ_REGISTRO,
			 r_c01.IE_ALTO_RISCO,
			 r_c01.DS_COMPONENTES,
			 ie_nursing_science_w,
			 r_c01.IE_QUIMIO,
			 r_c01.NR_SEQ_GRUPO_INTERV,
			 r_c01.IE_PADRONIZADO,
			 r_c01.IE_UTIL_HEMOCOMPONENTE,
			 r_c01.IE_VENCIDA,
			 r_c01.NR_AGRUP_PROT,
			 r_c01.CD_UNIDADE_MEDIDA,
			 r_c01.HORA1,
			 r_c01.HORA2,
			 r_c01.HORA3,
			 r_c01.HORA4,
			 r_c01.HORA5,
			 r_c01.HORA6,
			 r_c01.HORA7,
			 r_c01.HORA8,
			 r_c01.HORA9,
			 r_c01.HORA10,
			 r_c01.HORA11,
			 r_c01.HORA12,
			 r_c01.HORA13,
			 r_c01.HORA14,
			 r_c01.HORA15,
			 r_c01.HORA16,
			 r_c01.HORA17,
			 r_c01.HORA18,
			 r_c01.HORA19,
			 r_c01.HORA20,
			 r_c01.HORA21,
			 r_c01.HORA22,
			 r_c01.HORA23,
			 r_c01.HORA24,
			 r_c01.HORA25,
			 r_c01.HORA26,
			 r_c01.HORA27,
			 r_c01.HORA28,
			 r_c01.HORA29,
			 r_c01.HORA30,
			 r_c01.HORA31,
			 r_c01.HORA32,
			 r_c01.HORA33,
			 r_c01.HORA34,
			 r_c01.HORA35,
			 r_c01.HORA36,
			 r_c01.HORA37,
			 r_c01.HORA38,
			 r_c01.HORA39,
			 r_c01.HORA40,
			 r_c01.IE_SOL_CUSTO,
			 r_c01.IE_HEMODIALISE,
			 r_c01.IE_ITEM_ORDEM,
			 r_c01.IE_ATRASADO,
			 r_c01.IE_REGRA_DISP,
			 r_c01.NR_SEQ_CPOE,
			 nr_atendimento_p,
			 r_c01.IE_CLASSIF_ADEP,
			 r_c01.IE_RISCO_QUEDA,
			 ie_necessita_aprezar_w,
			 r_c01.IE_PRESCRICAO_ANESTESICA);
	
	end;
end loop;

for r_c02 in c02 loop
	begin
		insert into ADEP_HORARIOS_WEB(
					 ID_SESSAO_WEB,
					 NM_USUARIO,
					 DT_ATUALIZACAO_NREC,
					 IE_SAEGRUPO,
					 IE_ORDEM,
					 NR_SEQ_ORDEM,
					 NR_SEQUENCIA,
					 IE_TIPO_ITEM,
					 NR_PRESCRICAO,
					 NR_SEQ_ITEM,
					 CD_ITEM,
					 CD_INTERVALO,
					 QT_ITEM,
					 IE_ACM_SN,
					 IE_STATUS_ITEM,
					 DS_PRESCRITO,
					 DS_PRESCRICAO,
					 NR_PRESCRICOES,
					 DS_DILUICAO,
					 DS_INF_DIL,
					 NR_DIA_UTIL,
					 IE_DIFERENCIADO,
					 NR_SEQ_PROC_INTERNO,
					 DT_PREV_TERM,
					 IE_PENDENTE_LIBERACAO,
					 IE_MEDIC_CONTROLADO,
					 IE_MEDICACAO_PACIENTE,
					 NR_AGRUPAMENTO,
					 IE_PRESCRICAO_ALTA,
					 NR_SEQ_PROT_GLIC,
					 IE_HORARIO,
					 IE_VIA_APLICACAO,
					 NR_SEQ_APRES_INF,
					 NR_ETAPA_SOL,
					 DS_OBSERVACAO_PROC,
					 IE_OBS_MEDICO,
					 IE_DILUIDO,
					 CD_MOTIVO_BAIXA,
					 IE_COMPOSTO,
					 NR_SEQ_REGISTRO,
					 IE_ALTO_RISCO,
					 DS_COMPONENTES,
					 IE_CIENCIA,
					 IE_QUIMIO,
					 NR_SEQ_GRUPO_INTERV,
					 IE_PADRONIZADO,
					 IE_UTIL_HEMOCOMPONENTE,
					 IE_VENCIDA,
					 NR_AGRUP_PROT,
					 CD_UNIDADE_MEDIDA,
					 HORA1,
					 HORA2,
					 HORA3,
					 HORA4,
					 HORA5,
					 HORA6,
					 HORA7,
					 HORA8,
					 HORA9,
					 HORA10,
					 HORA11,
					 HORA12,
					 HORA13,
					 HORA14,
					 HORA15,
					 HORA16,
					 HORA17,
					 HORA18,
					 HORA19,
					 HORA20,
					 HORA21,
					 HORA22,
					 HORA23,
					 HORA24,
					 HORA25,
					 HORA26,
					 HORA27,
					 HORA28,
					 HORA29,
					 HORA30,
					 HORA31,
					 HORA32,
					 HORA33,
					 HORA34,
					 HORA35,
					 HORA36,
					 HORA37,
					 HORA38,
					 HORA39,
					 HORA40,
					 IE_SOL_CUSTO,
					 IE_HEMODIALISE,
					 IE_ITEM_ORDEM,
					 IE_ATRASADO,
					 IE_REGRA_DISP,
					 NR_SEQ_CPOE,
					 NR_ATENDIMENTO,
					 IE_CLASSIF_ADEP,
					 IE_RISCO_QUEDA,
					 IE_PRESCRICAO_ANESTESIA)
				values (
					 id_sessao_p,
					 nm_usuario_p,
					 clock_timestamp(),
					 'N',
					 null,
					 null,
					 null,
					 r_c02.IE_TIPO_ITEM,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
				 	 r_c02.HORA1,
					 r_c02.HORA2,
 					 r_c02.HORA3,
					 r_c02.HORA4,
					 r_c02.HORA5,
					 r_c02.HORA6,
					 r_c02.HORA7,
					 r_c02.HORA8,
					 r_c02.HORA9,
					 r_c02.HORA10,
					 r_c02.HORA11,
					 r_c02.HORA12,
					 r_c02.HORA13,
					 r_c02.HORA14,
					 r_c02.HORA15,
					 r_c02.HORA16,
					 r_c02.HORA17,
					 r_c02.HORA18,
					 r_c02.HORA19,
					 r_c02.HORA20,
					 r_c02.HORA21,
					 r_c02.HORA22,
					 r_c02.HORA23,
					 r_c02.HORA24,
					 r_c02.HORA25,
					 r_c02.HORA26,
					 r_c02.HORA27,
					 r_c02.HORA28,
					 r_c02.HORA29,
					 r_c02.HORA30,
					 r_c02.HORA31,
					 r_c02.HORA32,
					 r_c02.HORA33,
					 r_c02.HORA34,
					 r_c02.HORA35,
					 r_c02.HORA36,
					 r_c02.HORA37,
					 r_c02.HORA38,
					 r_c02.HORA39,
					 r_c02.HORA40,
					 null,
					 null,
					 null,
					 null,
					 null,
					 null,
					 nr_atendimento_p,
					 null,
					 r_c02.IE_RISCO_QUEDA,
					 r_c02.IE_PRESCRICAO_ANESTESICA);		
	
	end;
end loop;

if (ie_prescricao_futura_P = 'S' and ie_show_future_items_w = 'S')then
	CALL GERAR_ADEP_WEB_FUTURO(nr_atendimento_p, id_sessao_p, nm_usuario_p);
end if;

select	count(*)
into STRICT	  rule_quantity_w
from	  cpoe_regra_ator LIMIT 1;

if (rule_quantity_w > 0) then
  CALL gerar_adep_order_interface(nr_atendimento_p, id_sessao_p, nm_usuario_p);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_adep_web ( nr_atendimento_p bigint, id_sessao_p text, nm_usuario_p text, dt_filtro_p timestamp default clock_timestamp(), qt_horas_adicionais_p bigint default 0, ie_exibir_dt_fim_p text default 'N', IE_PRESCRICAO_FUTURA_P text default 'N') FROM PUBLIC;

