-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_atualiza_empresa_rubrica () AS $body$
DECLARE



cd_empresa_inicial_w		smallint;
cd_empresa_w			smallint;
nr_seq_modelo_w		bigint;
nr_seq_modelo_inic_w		bigint;
ds_modelo_w			varchar(80);
nr_seq_apres_w		smallint;
ds_rubrica_w			varchar(80);
qt_desl_esq_w			smallint;
ie_origem_valor_w		varchar(03);
ds_origem_w			varchar(2000);
nr_seq_somat_w		smallint;
ie_situacao_w			varchar(01);
ie_informacao_w		varchar(02);
qt_registro_w			bigint;


c01 CURSOR FOR
SELECT	distinct(cd_empresa)
from	empresa
where	cd_empresa not in (cd_empresa_inicial_w);

c02 CURSOR FOR
SELECT	nr_sequencia,
	ds_modelo
from	ctb_modelo_relat
where	cd_empresa = cd_empresa_inicial_w
order by 1;

c03 CURSOR FOR
SELECT	nr_seq_apres,
	ds_rubrica,
	qt_desl_esq,
	ie_origem_valor,
	ds_origem,
	nr_seq_somat,
	ie_situacao,
	ie_informacao
from	ctb_modelo_rubrica
where	nr_seq_modelo = nr_seq_modelo_inic_w
order by 2;



BEGIN

select	count(*)
into STRICT	qt_registro_w
from	ctb_modelo_relat
where	(cd_empresa IS NOT NULL AND cd_empresa::text <> '');

if (qt_registro_w = 0) then
	select	min(cd_empresa)
	into STRICT	cd_empresa_inicial_w
	from	empresa;

	update	ctb_modelo_relat
	set	cd_empresa		= cd_empresa_inicial_w,
		dt_atualizacao	= clock_timestamp();

	open c01;
	loop
		fetch c01 into
			cd_empresa_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */

		open c02;
		loop
			fetch c02 into
				nr_seq_modelo_inic_w,
				ds_modelo_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */

			begin
			select	nextval('ctb_modelo_relat_seq')
			into STRICT	nr_seq_modelo_w
			;

			insert into ctb_modelo_relat(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					ds_modelo,
					cd_empresa)
				SELECT	nr_seq_modelo_w,
					clock_timestamp(),
					'Baca_Rubrica',
					ds_modelo_w,
					cd_empresa_w
				;

			open c03;
			loop
				fetch c03 into
					nr_seq_apres_w,
					ds_rubrica_w,
					qt_desl_esq_w,
					ie_origem_valor_w,
					ds_origem_w,
					nr_seq_somat_w,
					ie_situacao_w,
					ie_informacao_w;
				EXIT WHEN NOT FOUND; /* apply on c03 */

				begin

				insert into ctb_modelo_rubrica(
						nr_sequencia,
						nr_seq_modelo,
						dt_atualizacao,
						nm_usuario,
						nr_seq_apres,
						ds_rubrica,
						qt_desl_esq,
						ie_origem_valor,
						ds_origem,
						nr_seq_somat,
						ie_situacao,
						ie_informacao)
					SELECT	nextval('ctb_modelo_rubrica_seq'),
						nr_seq_modelo_w,
						clock_timestamp(),
						'Baca_Rubrica',
						nr_seq_apres_w,
						ds_rubrica_w,
						qt_desl_esq_w,
						ie_origem_valor_w,
						ds_origem_w,
						nr_seq_somat_w,
						ie_situacao_w,
						ie_informacao_w
					;
				end;
			end loop;
			close c03;
			end;
		end loop;
		close c02;
	end loop;
	close c01;
commit;

end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_atualiza_empresa_rubrica () FROM PUBLIC;

