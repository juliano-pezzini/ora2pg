-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_obter_complex_financ_aih ( nr_interno_conta_p bigint, ie_complexidade_p INOUT text, ie_tipo_financ_p INOUT text) AS $body$
DECLARE


cd_procedimento_real_w		bigint;
ie_complexidade_w		sus_procedimento.ie_complexidade%TYPE;
ie_tipo_financiamento_w		sus_procedimento.ie_tipo_financiamento%TYPE;
ie_ordem_w			bigint;
dt_inicial_w		sus_aih_unif.dt_inicial%TYPE;

C01 CURSOR FOR
SELECT	a.ie_complexidade,
	a.ie_tipo_financiamento,
	sus_obter_seq_ordem(b.nr_sequencia)
FROM	sus_procedimento a,
	procedimento_paciente b
WHERE	a.cd_procedimento	= b.cd_procedimento
AND	a.ie_origem_proced	= b.ie_origem_proced
AND	b.nr_interno_conta	= nr_interno_conta_p
AND	sus_obter_tiporeg_proc(b.cd_procedimento,b.ie_origem_proced,'C',2) = 3
ORDER BY 2;


BEGIN

SELECT	MAX(cd_procedimento_real),
		MAX(dt_inicial)
INTO STRICT	cd_procedimento_real_w,
		dt_inicial_w
FROM	sus_aih_unif
WHERE	nr_interno_conta	= nr_interno_conta_p;

IF (cd_procedimento_real_w IS NOT NULL AND cd_procedimento_real_w::text <> '') AND (sus_validar_regra(11,cd_procedimento_real_w,7,dt_inicial_w) = 0) THEN
		SELECT	MAX(ie_complexidade),
			MAX(ie_tipo_financiamento)
		INTO STRICT	ie_complexidade_w,
			ie_tipo_financiamento_w
		FROM	sus_procedimento
		WHERE	cd_procedimento	= cd_procedimento_real_w
		AND	ie_origem_proced	= 7;
ELSE
	OPEN C01;
	LOOP
	FETCH C01 INTO
		ie_complexidade_w,
		ie_tipo_financiamento_w,
		ie_ordem_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	END LOOP;
	CLOSE C01;
END IF;

ie_complexidade_p := ie_complexidade_w;
ie_tipo_financ_p  := ie_tipo_financiamento_w;


END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_obter_complex_financ_aih ( nr_interno_conta_p bigint, ie_complexidade_p INOUT text, ie_tipo_financ_p INOUT text) FROM PUBLIC;

