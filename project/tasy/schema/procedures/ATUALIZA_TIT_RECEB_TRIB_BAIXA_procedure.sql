-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_tit_receb_trib_baixa ( dt_recebimento_p titulo_receber_liq.dt_recebimento%type, cd_estabelecimento_p titulo_receber.cd_estabelecimento%type, nr_seq_trib_baixa_p titulo_receber_trib_baixa.nr_sequencia%type, vl_baixa_p titulo_receber_trib_baixa.vl_baixa%type, nr_titulo_p titulo_receber_trib.nr_titulo%type, nr_seq_trans_financ_p titulo_receber_trib.nr_seq_trans_financ%type, nr_seq_baixa_p titulo_receber_trib.nr_sequencia%type, nm_usuario_p titulo_receber_trib_baixa.nm_usuario%type) AS $body$
DECLARE



dt_recebimento_w        titulo_receber_liq.dt_recebimento%type              := dt_recebimento_p;
cd_estabelecimento_w    titulo_receber.cd_estabelecimento%type              := cd_estabelecimento_p;
nr_seq_trans_financ_w   titulo_receber_trib_baixa.nr_seq_trans_financ%type  := nr_seq_trans_financ_p;
vl_baixa_w              titulo_receber_trib_baixa.vl_baixa%type             := vl_baixa_p;
nr_titulo_w             titulo_receber_trib_baixa.nr_titulo%type            := nr_titulo_p;
ie_lib_caixa_w          titulo_receber_liq.ie_lib_caixa%type;
nr_seq_proj_rec_w       titulo_receber.nr_seq_proj_rec%type;

c01 CURSOR FOR
    SELECT  a.nm_atributo,
            10 cd_tipo_lote_contab
    from    atributo_contab a
    where   a.cd_tipo_lote_contab = 39
    and     a.nm_atributo in ( 'VL_TRIB_TIT_REC')

union all

    SELECT  a.nm_atributo,
            5 cd_tipo_lote_contab
    from    atributo_contab a
    where   a.cd_tipo_lote_contab = 5
    and     a.nm_atributo in ( 'VL_TRIB_TIT_REC');

c01_w   c01%rowtype;


BEGIN

cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;

ie_lib_caixa_w := philips_contabil_pck.get_ie_baixa();
dt_recebimento_w := coalesce(philips_contabil_pck.get_dt_recebimento(), dt_recebimento_p);

if (coalesce(vl_baixa_w, 0) <> 0) and (coalesce(ie_lib_caixa_w,'S') = 'S') and (dt_recebimento_w IS NOT NULL AND dt_recebimento_w::text <> '') then

    open c01;
    loop
    fetch c01 into
        c01_w;
    EXIT WHEN NOT FOUND; /* apply on c01 */
        begin

        begin

        select  a.nr_seq_proj_rec
        into STRICT    nr_seq_proj_rec_w
        from    titulo_receber a
        where   a.nr_titulo = nr_titulo_w;
        exception
            when no_data_found then
                nr_seq_proj_rec_w := null;
            when too_many_rows then
                nr_seq_proj_rec_w := null;
            when others then
                nr_seq_proj_rec_w := null;
        end;

            CALL ctb_concil_financeira_pck.ctb_gravar_documento(   cd_estabelecimento_w,
                                        trunc(dt_recebimento_w),
                                        c01_w.cd_tipo_lote_contab,
                                        nr_seq_trans_financ_w,
                                        55,
                                        nr_titulo_w,
                                        nr_seq_trib_baixa_p,
                                        null,
                                        vl_baixa_w,
                                        'TITULO_RECEBER_TRIB_BAIXA',
                                        c01_w.nm_atributo,
                                        nm_usuario_p,
                                        'P',
                                        null,
                                        nr_seq_proj_rec_w);
        end;
    end loop;
    close c01;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_tit_receb_trib_baixa ( dt_recebimento_p titulo_receber_liq.dt_recebimento%type, cd_estabelecimento_p titulo_receber.cd_estabelecimento%type, nr_seq_trib_baixa_p titulo_receber_trib_baixa.nr_sequencia%type, vl_baixa_p titulo_receber_trib_baixa.vl_baixa%type, nr_titulo_p titulo_receber_trib.nr_titulo%type, nr_seq_trans_financ_p titulo_receber_trib.nr_seq_trans_financ%type, nr_seq_baixa_p titulo_receber_trib.nr_sequencia%type, nm_usuario_p titulo_receber_trib_baixa.nm_usuario%type) FROM PUBLIC;

