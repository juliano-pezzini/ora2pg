-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_reg_ecf_0020 ( nr_seq_controle_p text, ds_separador_p text, cd_estabelecimento_p text, nm_usuario_p text, cd_empresa_p text, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint, ie_scp_p text) AS $body$
DECLARE


				
nr_seq_registro_w		bigint := nr_sequencia_p;	
nr_linha_w		bigint := qt_linha_p;
ds_arquivo_w		varchar(4000);	
ds_arquivo_compl_w	varchar(4000);	
ds_linha_w		varchar(4000);
sep_w			varchar(2) := ds_separador_p;

tp_registro_w		varchar(5);
ie_pj_aliquota_w		fis_regra_ecf_0020.ie_pj_aliquota%type;
ie_adm_fundos_w		fis_regra_ecf_0020.ie_adm_fundos%type;
ie_operacoes_exterior_w	fis_regra_ecf_0020.ie_operacoes_exterior%type;
ie_oper_pj_vinculada_w	fis_regra_ecf_0020.ie_oper_pj_vinculada%type;
ie_enquadramento_w	fis_regra_ecf_0020.ie_enquadramento%type;
ie_particip_exterior_w	fis_regra_ecf_0020.ie_particip_exterior%type;
ie_lucro_exploracao_w	fis_regra_ecf_0020.ie_lucro_exploracao%type;
ie_isento_presumido_w	fis_regra_ecf_0020.ie_isento_presumido%type;
ie_finan_w		fis_regra_ecf_0020.ie_finan%type;
ie_participacoes_w		fis_regra_ecf_0020.ie_participacoes%type;
ie_receb_exterior_w		fis_regra_ecf_0020.ie_receb_exterior%type;
ie_ativos_exterior_w	fis_regra_ecf_0020.ie_ativos_exterior%type;
ie_pagamentos_exterior_w	fis_regra_ecf_0020.ie_pagamentos_exterior%type;
ie_royalties_w		fis_regra_ecf_0020.ie_royalties%type;
ie_royalties_beneficiario_w	fis_regra_ecf_0020.ie_royalties_beneficiario%type;
ie_rend_serv_w		fis_regra_ecf_0020.ie_rend_serv%type;
ie_titulo_beneficiario_w	fis_regra_ecf_0020.ie_titulo_beneficiario%type;
ie_polo_manaus_w		fis_regra_ecf_0020.ie_polo_manaus%type;
ie_area_comercio_w	fis_regra_ecf_0020.ie_area_comercio%type;
qt_scp_pj_w		fis_regra_ecf_0020.qt_scp_pj%type;
ie_participa_empresa_w	fis_regra_ecf_0020.ie_participa_empresa%type;
ie_comercio_eletronico_w 	fis_regra_ecf_0020.ie_comercio_eletronico%type;
ie_inov_tecnologica_w 	fis_regra_ecf_0020.ie_inov_tecnologica%type;
ie_capac_informatica_w	fis_regra_ecf_0020.ie_capac_informatica%type;
dt_fim_apuracao_w	fis_controle_ecf.dt_fim_apuracao%type;
ie_doacoes_eleitorais_w	varchar(10);
ie_efetuou_vendas_export_w varchar(10);
ie_pf_exportadora_w varchar(10);


BEGIN

select	max('0020') tp_registro,
	max(a.ie_pj_aliquota),
	max(a.ie_adm_fundos),
	max(a.ie_operacoes_exterior),
	max(a.ie_oper_pj_vinculada),
	max(a.ie_enquadramento),
	max(a.ie_lucro_exploracao),
	max(a.ie_particip_exterior),
	max(a.ie_isento_presumido),
	max(a.ie_finan),
	max(a.ie_doacoes_eleitorais),
	max(a.ie_participacoes),
	max(a.ie_receb_exterior),
	max(a.ie_ativos_exterior),
	max(a.ie_pagamentos_exterior),
	max(a.ie_royalties),
	max(a.ie_royalties_beneficiario),
	max(a.ie_rend_serv),
	max(a.ie_titulo_beneficiario),
	max(a.ie_polo_manaus),
	max(a.ie_area_comercio),
	max(a.qt_scp_pj),
	max(a.ie_participa_empresa),
	max(a.ie_comercio_eletronico),
	max(a.ie_inov_tecnologica),
	max(a.ie_capac_informatica),
  max('N'),
  max('N')
into STRICT	tp_registro_w,
	ie_pj_aliquota_w,
	ie_adm_fundos_w,
	ie_operacoes_exterior_w,
	ie_oper_pj_vinculada_w,
	ie_enquadramento_w,
	ie_lucro_exploracao_w,
	ie_particip_exterior_w,	
	ie_isento_presumido_w,
	ie_finan_w,
	ie_doacoes_eleitorais_w,
	ie_participacoes_w,
	ie_receb_exterior_w,
	ie_ativos_exterior_w,
	ie_pagamentos_exterior_w,
	ie_royalties_w,
	ie_royalties_beneficiario_w,
	ie_rend_serv_w,
	ie_titulo_beneficiario_w,
	ie_polo_manaus_w,
	ie_area_comercio_w,
	qt_scp_pj_w,
	ie_participa_empresa_w,
	ie_comercio_eletronico_w,
	ie_inov_tecnologica_w,
	ie_capac_informatica_w,
  ie_efetuou_vendas_export_w,
  ie_pf_exportadora_w
from	fis_regra_ecf_0020	a,
	fis_controle_ecf	b
where	a.nr_seq_lote	= b.nr_seq_lote
and 	b.nr_sequencia	= nr_seq_controle_p
and 	a.cd_empresa	= cd_empresa_p;

select  max(dt_fim_apuracao)
into STRICT	dt_fim_apuracao_w
from	fis_controle_ecf
where	nr_sequencia = nr_seq_controle_p;

if  to_char(dt_fim_apuracao_w, 'yyyy') = '2014' then
	ie_pj_aliquota_w := 'N';
end if;

if to_char(dt_fim_apuracao_w, 'yyyy') >= '2020' then
  ie_doacoes_eleitorais_w := ''; -- 14
  ie_efetuou_vendas_export_w := ''; -- 16
  ie_pf_exportadora_w := ''; -- 19
else
  ie_doacoes_eleitorais_w := sep_w || ie_doacoes_eleitorais_w; -- 14
  ie_efetuou_vendas_export_w := sep_w || ie_efetuou_vendas_export_w; -- 16
  ie_pf_exportadora_w := sep_w || ie_pf_exportadora_w; -- 19
end if;

ds_linha_w :=   substr(sep_w || tp_registro_w	 		|| -- Registro (1)
		       sep_w || ie_pj_aliquota_w			|| -- PJ Sujeita  Alquota da CSLL de 15% (2)
		       sep_w || qt_scp_pj_w			|| -- Quantidade de SCP da PJ - Scio Ostensivo de SCP - Total de SCP (3)
		       sep_w || ie_adm_fundos_w		|| -- Administradora de Fundos e Clubes de Investimento (4)
		       sep_w || ie_participa_empresa_w		|| -- Participaes em Consrcios de Empresas (5)
		       sep_w || ie_operacoes_exterior_w		|| -- Operaes com o Exterior (6)
		       sep_w || ie_oper_pj_vinculada_w		|| -- Operaes com Pessoa Vinculada/Interposta Pessoa / Pas com Tributao Favorecida (7)
		       sep_w || ie_enquadramento_w		|| -- PJ Enquadrada nos artigos 48 ou 49 da IN RFB no 1.312/2012 (8)
		       sep_w || ie_particip_exterior_w		|| -- Participaes no Exterior (9)
		       sep_w || 'N'				|| -- Atividade Rural (10)
		       sep_w || 'N'				|| -- Existncia de Lucro da Explorao (11)
		       sep_w || ie_isento_presumido_w		|| -- Iseno e Reduo do Imposto para Lucro Presumido (12)
		       sep_w || 'N'				|| -- Indicativo da Existncia de FINOR/FINAM/FUNRES (13)
		       ie_doacoes_eleitorais_w		|| -- Doaes a Campanhas Eleitorais (14)
		       sep_w || ie_participacoes_w		|| -- Participao Avaliada pelo Mtodo de Equivalncia Patrimonial (15)
		       ie_efetuou_vendas_export_w				|| -- PJ Efetuou Vendas a Empresa Comercial Exportadora com Fim Especfico de Exportao (16)
		       sep_w || ie_receb_exterior_w		|| -- Recebimentos do Exterior ou de No Residentes (17)
		       sep_w || ie_ativos_exterior_w		|| -- Ativos no Exterior (18)
		       ie_pf_exportadora_w				|| -- PJ Comercial Exportadora (19)
		       sep_w || ie_pagamentos_exterior_w		|| -- Pagamentos ao Exterior ou a No Residentes (20)
		       sep_w || ie_comercio_eletronico_w		|| -- Comrcio Eletrnico e Tecnologia da Informao (21)
		       sep_w || ie_royalties_w			|| -- Royalties Recebidos do Brasil e do Exterior (22)
		       sep_w || ie_royalties_beneficiario_w		|| -- Royalties Pagos a Beneficirios do Brasil e do Exterior (23)
		       sep_w || ie_rend_serv_w			|| -- Rendimentos Relativos a Servios, Juros e Dividendos Recebidos do Brasil e do Exterior (24)
		       sep_w || ie_titulo_beneficiario_w		|| -- Pagamentos ou Remessas a Ttulo de Servios, Juros e Dividendos a Beneficirios do Brasil e do Exterior (25)
		       sep_w || ie_inov_tecnologica_w		|| -- Inovao Tecnolgica e Desenvolvimento Tecnolgico (26)
		       sep_w || ie_capac_informatica_w		|| -- Capacitao de Informtica e Incluso Digital (27)
		       sep_w || 'N'				|| -- PJ Habilitada no Repes, Recap, Padis, PATVD, Reidi, Repenec, Reicomp, Retaero, Recine, Resduos Slidos, Recopa, Copa do Mundo, Retid, REPNBL-Redes, Reif e Olimpadas (28)
		       sep_w || ie_polo_manaus_w		|| -- Plo Industrial de Manaus e Amaznia Ocidental (29)
		       sep_w || 'N'				|| -- Zonas de Processamento de Exportao (30)
		       sep_w || ie_area_comercio_w		|| sep_w,1,8000); -- reas de Livre Comrcio (31)
		
if to_char(dt_fim_apuracao_w, 'yyyy') >= '2016' then
	ds_linha_w := substr(ds_linha_w || 'N'			|| sep_w,1,8000); -- A pessoa jurdica  entidade de grupo multinacional, nos termos a Instruo Normativa RFB n 1.681/2016 (32)
end if;

if to_char(dt_fim_apuracao_w, 'yyyy') >= '2017' then
	ds_linha_w := substr(ds_linha_w || 'N'			|| sep_w,1,8000); -- Declarao sobre utilizao dos recursos em moeda estrangeira decorrentes do recebimento de exportaes (DEREX)
end if;

ds_arquivo_w		:= substr(ds_linha_w,1,4000);
ds_arquivo_compl_w	:= substr(ds_linha_w,4001,4000);
nr_seq_registro_w	:= nr_seq_registro_w + 1;
nr_linha_w		:= nr_linha_w + 1;

insert into fis_ecf_arquivo(
	nr_sequencia,
	nm_usuario,
	dt_atualizacao,
	nm_usuario_nrec,
	dt_atualizacao_nrec,
	nr_seq_controle_ecf,
	nr_linha,
	cd_registro,
	ds_arquivo,
	ds_arquivo_compl)
values (	nr_seq_registro_w,
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nr_seq_controle_p,
	nr_linha_w,
	tp_registro_w,
	ds_arquivo_w,
	ds_arquivo_compl_w);

commit;

qt_linha_p	:= nr_linha_w;
nr_sequencia_p	:= nr_seq_registro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_reg_ecf_0020 ( nr_seq_controle_p text, ds_separador_p text, cd_estabelecimento_p text, nm_usuario_p text, cd_empresa_p text, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint, ie_scp_p text) FROM PUBLIC;

