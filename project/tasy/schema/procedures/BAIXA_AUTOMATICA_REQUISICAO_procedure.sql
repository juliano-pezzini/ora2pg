-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baixa_automatica_requisicao ( ie_tipo_requisicao_p text, cd_local_estoque_p bigint, nr_requisicao_p bigint, cd_operacao_estoque_p bigint, ie_baixa_sem_saldo_p text, nm_usuario_p text, cd_setor_atendimento_p bigint, ds_erro INOUT text) AS $body$
DECLARE


cd_local_estoque_w	smallint;
nr_item_w		integer;
ds_erro_liberacao_w	varchar(2000);
qt_material_w		double precision;
dt_atendimento_w		timestamp;
cd_cgc_fornecedor_w	varchar(14);
ds_erro_w		varchar(4000);
ie_falta_baixar_w		integer;
ie_local_liberado_w		varchar(1)	:= 'N';
ie_permite_local_adic_w	varchar(1);
qt_existe_w		bigint;
cd_estabelecimento_w	integer;
ie_tipo_req_baixa_auto_w	varchar(1);
ie_origem_requisicao_w	requisicao_material.ie_origem_requisicao%type;

c01 CURSOR FOR
SELECT	nr_sequencia,
	qt_material_requisitada,
	cd_cgc_fornecedor
from	item_requisicao_material
where	nr_requisicao = nr_requisicao_p
and	obter_tipo_motivo_baixa_req(cd_motivo_baixa) = 0;


BEGIN

delete	FROM requisicao_mat_consist
where	nr_requisicao = nr_requisicao_p;

select	cd_local_estoque
into STRICT	cd_local_estoque_w
from	setor_atendimento
where	cd_setor_atendimento = cd_setor_atendimento_p;

select	cd_estabelecimento,
	coalesce(ie_origem_requisicao,'X')
into STRICT	cd_estabelecimento_w,
	ie_origem_requisicao_w
from	requisicao_material
where	nr_requisicao = nr_requisicao_p;

ie_tipo_req_baixa_auto_w	:=	coalesce(substr(obter_valor_param_usuario(919,6,obter_perfil_ativo,nm_usuario_p,cd_estabelecimento_w),1,1),'S');
ie_permite_local_adic_w		:=	coalesce(substr(obter_valor_param_usuario(919,88,obter_perfil_ativo,nm_usuario_p,cd_estabelecimento_w),1,1),'N');

if (cd_local_estoque_p = cd_local_estoque_w) then
	ie_local_liberado_w		:= 'S';
elsif (ie_permite_local_adic_w = 'S') then
	begin

	select	count(*)
	into STRICT	qt_existe_w
	from	setor_local
	where	cd_setor_atendimento = cd_setor_atendimento_p
	and	cd_local_estoque = cd_local_estoque_p;

	if (qt_existe_w > 0) then
		ie_local_liberado_w		:= 'S';
	end if;

	end;
end if;

if (ie_tipo_req_baixa_auto_w = 'S') and (ie_tipo_requisicao_p <> '1')  then
	CALL gravar_consistencia_requisicao(
		nr_requisicao_p, null,'0',
		Wheb_mensagem_pck.get_Texto(297824),
		'C',Wheb_mensagem_pck.get_Texto(297825), nm_usuario_p);
elsif (ie_tipo_req_baixa_auto_w = 'T') and (ie_tipo_requisicao_p not in (2,21)) then
	CALL gravar_consistencia_requisicao(
		nr_requisicao_p, null,'0',
		Wheb_mensagem_pck.get_Texto(297826),
		'C',Wheb_mensagem_pck.get_Texto(297825), nm_usuario_p);
elsif (ie_local_liberado_w <> 'S') and (ie_origem_requisicao_w <> 'DKT') then
	CALL gravar_consistencia_requisicao(
		nr_requisicao_p, null,'0',
		Wheb_mensagem_pck.get_Texto(297827),
		'C',null, nm_usuario_p);
else

	open c01;
	loop
	fetch c01 into
		nr_item_w,
		qt_material_w,
		cd_cgc_fornecedor_w;
        	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ds_erro_w := gerar_movto_estoque_req(nr_requisicao_p, nr_item_w, cd_operacao_estoque_p, qt_material_w, clock_timestamp(), 1, '1', ie_baixa_sem_saldo_p, nm_usuario_p, null, ds_erro_w);

		if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
			CALL gravar_consistencia_requisicao(
				nr_requisicao_p, null,'0',
				Wheb_mensagem_pck.get_Texto(297829),
				'C',Wheb_mensagem_pck.get_Texto(297832,'DS_ERRO_W='||DS_ERRO_W), nm_usuario_p);
		end if;
		end;
	end loop;
	close c01;

	select	count(*)
	into STRICT	ie_falta_baixar_w
	from	item_requisicao_material
	where	nr_requisicao = nr_requisicao_p
	and	obter_tipo_motivo_baixa_req(cd_motivo_baixa) = 0;

	if (ie_falta_baixar_w = 0) then
		update	requisicao_material
		set	dt_baixa = clock_timestamp()
		where	nr_requisicao =	nr_requisicao_p;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baixa_automatica_requisicao ( ie_tipo_requisicao_p text, cd_local_estoque_p bigint, nr_requisicao_p bigint, cd_operacao_estoque_p bigint, ie_baixa_sem_saldo_p text, nm_usuario_p text, cd_setor_atendimento_p bigint, ds_erro INOUT text) FROM PUBLIC;

