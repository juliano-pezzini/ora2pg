-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_contab_onl_contas_receber (doc_p INOUT ctb_documento, nm_usuario_p text) AS $body$
DECLARE

/*
===============================================================================
Purpose: Indentacao

Remarks: n/a

Who         When            What
----------  -----------     --------------------------------------------------

chjreinert  13/mai/2021     OS 2444975 - Indentacao

===============================================================================
*/
cd_conta_codificacao_w       pls_contab_codific_item.cd_conta_contabil%type;
cd_conta_transitoria_w       ctb_regra_estab_dif.cd_conta_contabil%type;
cd_empresa_w                 empresa.cd_empresa%type;
cd_estab_movimento_w         estabelecimento.cd_estabelecimento%type;
cd_estab_titulo_w            titulo_receber.cd_estabelecimento%type;
cd_estab_contabil_w          titulo_receber.cd_estabelecimento%type;
cd_historico_pls_w           titulo_rec_liq_cc.cd_historico_pls%type;
ctb_movimento_w              ctb_movimento%rowtype;
ctb_param_lote_contas_rec_w  ctb_param_lote_contas_rec%rowtype;
dados_contab_w               ctb_contab_onl_lote_fin_pck.dados_contab_tf;
ds_ano_conta_paciente_w      varchar(20);
ds_atributos_w               varchar(4000);
ds_bandeira_cartao_w         bandeira_cartao_cr.ds_bandeira%type;
ds_comprovante_cartao_w      movto_cartao_cr.ds_comprovante%type;
ds_comprovante_w             movto_cartao_cr.ds_comprovante%type := '';
ds_convenio_w                convenio.ds_convenio%type := '';
ds_devedor_pj_w              pessoa_juridica.ds_razao_social%type;
ds_devedor_w                 pessoa_juridica.ds_razao_social%type;
ds_estorno_w                 varchar(255);
ds_mesano_referencia_abrev_w varchar(20);
ds_mesano_referencia_prot_w  varchar(20);
ds_motivo_glosa_w            motivo_glosa.ds_motivo_glosa%type;
ds_nota_credito_w            varchar(255) := '';
ds_obs_adiantamento_w        adiantamento.ds_observacao%type;
ds_obs_convenio_receb_w      convenio_receb.ds_observacao%type;
ds_obs_movto_cartao_baixa_w  movto_cartao_cr_baixa.ds_observacao%type;
ds_observacao_liq_w          titulo_receber_liq.ds_observacao%type;
ds_observacao_titulo_w       titulo_receber.ds_observacao_titulo%type := '';
ds_pessoa_rec_cartao_w       pessoa_juridica.ds_razao_social%type;
ds_recebimentos_w            varchar(100) := '';
dt_contabil_tit_w            alteracao_valor.dt_alteracao%type;
dt_mesano_referencia_prot_w  protocolo_convenio.dt_mesano_referencia%type;
dt_perda_w                   titulo_receber.dt_pagamento_previsto%type;
dt_referencia_mesano_w       bigint;
ie_acao_w                    titulo_receber_liq.ie_acao%type;
ie_contab_pj_convenio_w      varchar(1);
ie_conta_transitoria_w       convenio_estabelecimento.ie_conta_transitoria%type;
ie_estorno_w                 varchar(1) := 'N';
ie_permite_estab_dif_w       ctb_regra_estab_dif.ie_permite%type;
ie_regra_w                   varchar(1);
ie_segmentacao_w             pls_plano.ie_segmentacao%type;
ie_union_w                   bigint;
nm_agrupador_w               agrupador_contabil.nm_atributo%type;
nm_fantasia_estab_tit_w      estabelecimento.nm_fantasia_estab%type;
nm_paciente_adiant_w         pessoa_juridica.ds_razao_social%type;
nm_pessoa_caixa_rec_w        pessoa_juridica.ds_razao_social%type;
nr_adiantamento_w            titulo_receber_liq.nr_adiantamento%type;
nr_atendimento_w             conta_paciente.nr_atendimento%type;
nr_autorizacao_w             movto_cartao_cr.nr_autorizacao%type := '';
nr_bordero_rec_w             titulo_receber_liq.nr_bordero%type;
nr_doc_titulo_w              titulo_receber.nr_documento%type;
nr_interno_conta_w           titulo_receber.nr_interno_conta%type;
nr_negociacao_w              varchar(20);
nr_nfe_imp_w                 nota_fiscal.nr_nfe_imp%type;
nr_nota_conta_w              varchar(20);
nr_nota_fiscal_w             nota_fiscal.nr_nota_fiscal%type;
nr_nota_protocolo_w          varchar(20);
nr_nota_tit_abatimento_w     varchar(255);
nr_nota_tit_receber_abat_w   titulo_receber.nr_nota_fiscal%type;
nr_recibo_adiant_w           adiantamento.nr_recibo%type;
nr_seq_baixa_w               titulo_receber_liq.nr_sequencia%type;
nr_seq_cob_escritural_w      titulo_receber_liq.nr_seq_cobranca%type;
nr_seq_extrato_w             banco_extrato_lanc.nr_seq_extrato%type;
nr_seq_movto_bco_pend_w      movto_banco_pend_baixa.nr_seq_movto_pend%type;
nr_seq_movto_cartao_cr_w     movto_cartao_cr.nr_sequencia%type;
nr_seq_movto_pend_w          movto_banco_pend.nr_sequencia%type;
nr_seq_movto_trans_fin_w     titulo_receber_liq.nr_seq_movto_trans_fin%type := 0;
nr_seq_trans_financ_w        movto_trans_financ.nr_sequencia%type;
nr_seq_nf_saida_w            titulo_receber.nr_seq_nf_saida%type;
nr_seq_nota_credito_w        titulo_receber_nc.nr_seq_nota_credito%type;
nr_seq_perda_conta_rec_w     perda_contas_receber.nr_sequencia%type;
nr_seq_propaci_partic_w      convenio_retorno_glosa.nr_seq_propaci_partic%type;
nr_seq_protocolo_w           titulo_receber.nr_seq_protocolo%type;
nr_seq_receb_w               convenio_ret_receb.nr_seq_receb%type;
nr_seq_ret_item_w            titulo_receber_liq.nr_seq_ret_item%type;
nr_seq_retorno_w             titulo_receber_liq.nr_seq_retorno%type := 0;
nr_seq_titulo_rec_liq_w      titulo_receber_liq.nr_sequencia%type;
qt_conta_contabil_w          bigint;
qt_registros_w               bigint;
cd_interno_intercompany_ori_w   estabelecimento.cd_interno%type;
cd_interno_intercompany_des_w   estabelecimento.cd_interno%type;
ie_intercompany_w               varchar(1)     := 'N';
nr_seq_nota_orig_w           nota_fiscal.nr_sequencia%type;
nr_nota_orig_w               nota_fiscal.nr_nota_fiscal%type;
cd_serie_nf_orig_w           nota_fiscal.cd_serie_nf%type;
nr_nfe_imp_orig_w            nota_fiscal.nr_nfe_imp%type;
nr_seq_nota_comp_w           nota_fiscal.nr_sequencia%type;
nr_nota_comp_w               nota_fiscal.nr_nota_fiscal%type;
cd_serie_nf_comp_w           nota_fiscal.cd_serie_nf%type;
nr_nfe_imp_comp_w            nota_fiscal.nr_nfe_imp%type;
nr_seq_nota_no_w             nota_fiscal.nr_sequencia%type;
nr_nota_no_w                 nota_fiscal.nr_nota_fiscal%type;
cd_serie_nf_no_w             nota_fiscal.cd_serie_nf%type;
nr_nfe_imp_no_w              nota_fiscal.nr_nfe_imp%type;



BEGIN
dados_contab_w  := null;
ctb_movimento_w := null;
cd_empresa_w    := obter_empresa_estab(doc_p.cd_estabelecimento);

select x.*
into STRICT   ctb_param_lote_contas_rec_w
from (SELECT a.*
        from   ctb_param_lote_contas_rec a
        where  a.cd_empresa = cd_empresa_w
        and    coalesce(a.cd_estab_exclusivo,doc_p.cd_estabelecimento) = doc_p.cd_estabelecimento
        order  by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1;

select  coalesce(ie_contab_pj_convenio,'S')
into STRICT    ie_contab_pj_convenio_w
from    parametro_contas_receber
where   cd_estabelecimento  = doc_p.cd_estabelecimento;

CALL ctb_online_pck.definir_regra_lote_esta_dif(doc_p.cd_tipo_lote_contabil,doc_p.cd_estabelecimento);

ie_permite_estab_dif_w := ctb_online_pck.get_permite_estab_dif(doc_p.cd_tipo_lote_contabil,doc_p.cd_estabelecimento);
cd_conta_transitoria_w := ctb_online_pck.get_conta_transitoria_estab(doc_p.cd_tipo_lote_contabil,doc_p.cd_estabelecimento);
cd_estab_contabil_w    := ctb_online_pck.get_estab_contabil(doc_p.cd_tipo_lote_contabil,doc_p.cd_estabelecimento);

if (ie_permite_estab_dif_w <> 'N') and (cd_estab_contabil_w IS NOT NULL AND cd_estab_contabil_w::text <> '') and (doc_p.cd_estabelecimento != cd_estab_contabil_w) then
    doc_p.cd_estab_contabil := cd_estab_contabil_w;
end if;

nm_agrupador_w         := coalesce(trim(both obter_agrupador_contabil(doc_p.cd_tipo_lote_contabil)),'NR_TITULO');
dt_referencia_mesano_w := somente_numero(to_char(doc_p.dt_competencia,'MMYYYY'));

if (coalesce(doc_p.nr_seq_info, 0) = 44 ) then
    dados_contab_w.nr_titulo_receber := null;

else
    dados_contab_w.nr_titulo_receber := doc_p.nr_documento;

end if;

dados_contab_w.nr_seq_trans_fin  := doc_p.nr_seq_trans_financ;
dados_contab_w.dt_transacao      := doc_p.dt_competencia;

if (doc_p.nm_tabela = 'TITULO_RECEBER_LIQ') then
    if (doc_p.nm_atributo = 'VL_RECEBIDO' and ctb_param_lote_contas_rec_w.ie_contab_rec_classif = 'N') then
        begin
        ie_union_w := 1;
        select a.nr_seq_conta_banco, --5
               a.dt_recebimento, --8
               a.nr_seq_retorno, --10
               a.nr_seq_ret_item, --11
               a.nr_seq_movto_trans_fin, --15
               b.ds_observacao_titulo, --16
               CASE WHEN ctb_param_lote_contas_rec_w.ie_prod_classif_baixa='S' THEN                      (obter_prod_financ_tit_liq_cc(a.nr_titulo,a.nr_sequencia))::numeric   ELSE (null)::numeric  END  nr_seq_produto, --19
               a.ds_observacao, --20
               a.ie_acao, --21
               a.nr_adiantamento, --22
               a.nr_sequencia nr_seq_baixa, --27
               b.ie_origem_titulo, --32
               a.nr_sequencia nr_seq_titulo_rec_liq, --35
               a.nr_seq_cobranca, --36
               b.cd_estabelecimento, --41
               CASE WHEN coalesce(a.nr_seq_liq_origem::text, '') = '' THEN 'N'  ELSE 'S' END  ie_estorno, --42
               b.nr_seq_proj_rec --43
        into STRICT   dados_contab_w.nr_seq_conta_banco, --5
               dt_contabil_tit_w, --8
               nr_seq_retorno_w, --10
               nr_seq_ret_item_w, --11
               nr_seq_movto_trans_fin_w, --15
               ds_observacao_titulo_w, --16
               dados_contab_w.nr_seq_produto, --19
               ds_observacao_liq_w, --20
               ie_acao_w, --21
               nr_adiantamento_w, --22
               nr_seq_baixa_w, --27
               dados_contab_w.ie_origem_tit_rec, --32
               nr_seq_titulo_rec_liq_w, --35
               nr_seq_cob_escritural_w, --36
               cd_estab_movimento_w, --41
               ie_estorno_w, --42
               dados_contab_w.nr_seq_proj_rec --43
        from   titulo_receber     b,
               titulo_receber_liq a
        where  a.nr_titulo = doc_p.nr_documento
        and    a.nr_sequencia = doc_p.nr_seq_doc_compl
        and    a.nr_titulo = b.nr_titulo
        and    a.vl_recebido <> 0
        and    (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
        and    ((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento))
        and    coalesce(ie_lib_caixa,'S') = 'S';
        end;

    elsif (doc_p.nm_atributo = 'VL_DESPESA_BANCARIA') then
        begin
        ie_union_w := 6;
        select a.nr_seq_conta_banco, --5
               a.dt_recebimento, --8
               a.nr_seq_retorno, --10
               a.nr_seq_ret_item, --11
               a.nr_seq_movto_trans_fin, --15
               b.ds_observacao_titulo, --16
               a.ds_observacao, --20
               a.ie_acao, --21
               a.nr_adiantamento, --22
               a.nr_sequencia nr_seq_baixa, --27
               b.ie_origem_titulo, --32
               a.nr_sequencia nr_seq_titulo_rec_liq, --35
               a.nr_seq_cobranca, --36
               b.cd_estabelecimento, --41
               CASE WHEN coalesce(a.nr_seq_liq_origem::text, '') = '' THEN 'N'  ELSE 'S' END  ie_estorno, --42
               b.nr_seq_proj_rec --43
        into STRICT   dados_contab_w.nr_seq_conta_banco, --5
               dt_contabil_tit_w, --8
               nr_seq_retorno_w, --10
               nr_seq_ret_item_w, --11
               nr_seq_movto_trans_fin_w, --15
               ds_observacao_titulo_w, --16
               ds_observacao_liq_w, --20
               ie_acao_w, --21
               nr_adiantamento_w, --22
               nr_seq_baixa_w, --27
               dados_contab_w.ie_origem_tit_rec, --32
               nr_seq_titulo_rec_liq_w, --35
               nr_seq_cob_escritural_w, --36
               cd_estab_movimento_w, --41
               ie_estorno_w, --42
               dados_contab_w.nr_seq_proj_rec --43
        from   titulo_receber     b,
               titulo_receber_liq a
        where  a.nr_titulo = doc_p.nr_documento
        and    a.nr_sequencia = doc_p.nr_seq_doc_compl
        and    a.nr_titulo = b.nr_titulo
        and    a.vl_despesa_bancaria <> 0
        and    (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
        and    ((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento))
        and    coalesce(ie_lib_caixa,'S') = 'S';
        end;

    elsif (doc_p.nm_atributo = 'VL_GLOSA' and ctb_param_lote_contas_rec_w.ie_cc_glosa = 'N') then
        begin
        ie_union_w := 8;
        select a.nr_seq_conta_banco, --5
               a.dt_recebimento, --8
               a.nr_seq_retorno, --10
               a.nr_seq_ret_item, --11
               a.NR_SEQ_MOVTO_TRANS_FIN, --15
               b.ds_observacao_titulo, --16
               a.ds_observacao, --20
               a.ie_acao, --21
               a.nr_adiantamento, --22
               a.nr_sequencia nr_seq_baixa, --27
               b.ie_origem_titulo, --32
               a.nr_sequencia nr_seq_titulo_rec_liq, --35
               a.nr_seq_cobranca, --36
               b.cd_estabelecimento, --41
               CASE WHEN coalesce(a.nr_seq_liq_origem::text, '') = '' THEN 'N'  ELSE 'S' END  ie_estorno, --42
               b.nr_seq_proj_rec --43
        into STRICT   dados_contab_w.nr_seq_conta_banco, --5
               dt_contabil_tit_w, --8
               nr_seq_retorno_w, --10
               nr_seq_ret_item_w, --11
               nr_seq_movto_trans_fin_w, --15
               ds_observacao_titulo_w, --16
               ds_observacao_liq_w, --20
               ie_acao_w, --21
               nr_adiantamento_w, --22
               nr_seq_baixa_w, --27
               dados_contab_w.ie_origem_tit_rec, --32
               nr_seq_titulo_rec_liq_w, --35
               nr_seq_cob_escritural_w, --36
               cd_estab_movimento_w, --41
               ie_estorno_w, --42
               dados_contab_w.nr_seq_proj_rec --43
        from   titulo_receber     b,
               titulo_receber_liq a
        where  a.nr_titulo = doc_p.nr_documento
        and    a.nr_sequencia = doc_p.nr_seq_doc_compl
        and    a.vl_Glosa <> 0
        and    a.nr_titulo = b.nr_titulo
        and    coalesce(ie_lib_caixa,'S') = 'S'
        and    ((ie_permite_estab_dif_w <> 'N') OR (b.cd_estabelecimento = doc_p.cd_estabelecimento))
        and    (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
        and    coalesce(b.nr_seq_mensalidade::text, '') = '';
        end;

    elsif (doc_p.nm_atributo = 'VL_REC_MAIOR') then
        begin
        ie_union_w := 11;
        select a.nr_seq_conta_banco, --5
               a.dt_recebimento, --8
               a.nr_seq_retorno, --10
               a.nr_seq_ret_item, --11
               a.NR_SEQ_MOVTO_TRANS_FIN, --15
               b.ds_observacao_titulo, --16
               a.ds_observacao, --20
               a.ie_acao, --21
               a.nr_adiantamento, --22
               a.nr_sequencia nr_seq_baixa, --27
               b.ie_origem_titulo, --32
               a.nr_sequencia nr_seq_titulo_rec_liq, --35
               a.nr_seq_cobranca, --36
               b.cd_estabelecimento, --41
               CASE WHEN coalesce(a.nr_seq_liq_origem::text, '') = '' THEN 'N'  ELSE 'S' END  ie_estorno, --42
               b.nr_seq_proj_rec --43
        into STRICT   dados_contab_w.nr_seq_conta_banco, --5
               dt_contabil_tit_w, --8
               nr_seq_retorno_w, --10
               nr_seq_ret_item_w, --11
               nr_seq_movto_trans_fin_w, --15
               ds_observacao_titulo_w, --16
               ds_observacao_liq_w, --20
               ie_acao_w, --21
               nr_adiantamento_w, --22
               nr_seq_baixa_w, --27
               dados_contab_w.ie_origem_tit_rec, --32
               nr_seq_titulo_rec_liq_w, --35
               nr_seq_cob_escritural_w, --36
               cd_estab_movimento_w, --41
               ie_estorno_w, --42
               dados_contab_w.nr_seq_proj_rec --43
        from   titulo_receber     b,
               titulo_receber_liq a
        Where  a.nr_titulo = doc_p.nr_documento
        and    a.nr_sequencia = doc_p.nr_seq_doc_compl
        and    a.vl_Rec_Maior <> 0
        and    a.nr_titulo = b.nr_titulo
        and    coalesce(ie_lib_caixa,'S') = 'S'
        and    (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
        and (ctb_param_lote_contas_rec_w.ie_cc_glosa = 'N' OR b.ie_origem_titulo = 3)
        and    ((ie_permite_estab_dif_w <> 'N') OR (b.cd_estabelecimento = doc_p.cd_estabelecimento));
        end;

    elsif (doc_p.nm_atributo = 'VL_PERDAS') then
        begin
        ie_union_w := 16;
        select a.nr_seq_conta_banco, --5
               a.dt_recebimento, --8
               a.nr_seq_retorno, --10
               a.nr_seq_ret_item, --11
               a.nr_seq_movto_trans_fin, --15
               b.ds_observacao_titulo, --16
               a.ds_observacao, --20
               a.ie_acao, --21
               a.nr_adiantamento, --22
               a.nr_sequencia nr_seq_baixa, --27
               b.ie_origem_titulo, --32
               a.nr_sequencia nr_seq_titulo_rec_liq, --35
               a.nr_seq_cobranca, --36
               b.cd_estabelecimento cd_estabelecimento, --41
               CASE WHEN coalesce(a.nr_seq_liq_origem::text, '') = '' THEN 'N'  ELSE 'S' END  ie_estorno, --42
               b.nr_seq_proj_rec --43
        into STRICT   dados_contab_w.nr_seq_conta_banco, --5
               dt_contabil_tit_w, --8
               nr_seq_retorno_w, --10
               nr_seq_ret_item_w, --11
               nr_seq_movto_trans_fin_w, --15
               ds_observacao_titulo_w, --16
               ds_observacao_liq_w, --20
               ie_acao_w, --21
               nr_adiantamento_w, --22
               nr_seq_baixa_w, --27
               dados_contab_w.ie_origem_tit_rec, --32
               nr_seq_titulo_rec_liq_w, --35
               nr_seq_cob_escritural_w, --36
               cd_estab_movimento_w, --41
               ie_estorno_w, --42
               dados_contab_w.nr_seq_proj_rec --43
        from   titulo_receber     b,
               titulo_receber_liq a
        where  a.nr_titulo = doc_p.nr_documento
        and    a.nr_sequencia = doc_p.nr_seq_doc_compl
        and    a.nr_titulo = b.nr_titulo
        and    (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
        and    coalesce(a.vl_perdas,0) <> 0
        and    coalesce(ie_lib_caixa,'S') = 'S'
        and    ((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento))
        and    not exists (SELECT 1
                from   titulo_rec_liq_cc x
                where  x.nr_titulo = a.nr_titulo
                and    x.nr_seq_baixa = a.nr_sequencia
                and    coalesce(x.vl_perdas,0) <> 0);
        end;

    elsif (doc_p.nm_atributo = 'VL_NOTA_CREDITO') then
        begin
        ie_union_w := 17;
        select a.nr_seq_conta_banco, --5
               a.dt_recebimento, --8
               a.nr_seq_retorno, --10
               a.nr_seq_ret_item, --11
               a.nr_seq_movto_trans_fin, --15
               b.ds_observacao_titulo, --16
               a.ds_observacao, --20
               a.ie_acao, --21
               a.nr_adiantamento, --22
               a.nr_sequencia nr_seq_baixa, --27
               c.nr_seq_nota_credito, --28
               b.ie_origem_titulo, --32
               a.nr_sequencia nr_seq_titulo_rec_liq, --35
               a.nr_seq_cobranca, --36
               CASE WHEN coalesce(a.nr_seq_liq_origem::text, '') = '' THEN 'N'  ELSE 'S' END  ie_estorno, --42
               b.nr_seq_proj_rec --43
        into STRICT   dados_contab_w.nr_seq_conta_banco, --5
               dt_contabil_tit_w, --8
               nr_seq_retorno_w, --10
               nr_seq_ret_item_w, --11
               nr_seq_movto_trans_fin_w, --15
               ds_observacao_titulo_w, --16
               ds_observacao_liq_w, --20
               ie_acao_w, --21
               nr_adiantamento_w, --22
               nr_seq_baixa_w, --27
               nr_seq_nota_credito_w, --28
               dados_contab_w.ie_origem_tit_rec, --32
               nr_seq_titulo_rec_liq_w, --35
               nr_seq_cob_escritural_w, --36
               ie_estorno_w, --42
               dados_contab_w.nr_seq_proj_rec --43
        from   titulo_receber     b,
               titulo_receber_liq a,
               titulo_receber_nc  c
        where  a.nr_titulo = doc_p.nr_documento
        and    a.nr_sequencia = doc_p.nr_seq_doc_compl
        and    c.nr_sequencia = doc_p.nr_doc_analitico
        and    a.nr_titulo = c.nr_titulo_rec
        and    a.nr_sequencia = c.nr_seq_liq
        and    a.nr_titulo = b.nr_titulo
        and    a.vl_nota_credito <> 0
        and    coalesce(ie_lib_caixa,'S') = 'S'
        and    (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
        and    ((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento));
        end;

    elsif (doc_p.nm_atributo = 'VL_OUTROS_ACRESCIMOS') then
        begin
        ie_union_w := 29;
        select a.nr_seq_conta_banco, --5
               a.dt_recebimento, --8
               a.nr_seq_retorno, --10
               a.nr_seq_ret_item, --11
               a.nr_seq_movto_trans_fin, --15
               b.ds_observacao_titulo, --16
               a.ds_observacao, --20
               a.ie_acao, --21
               a.nr_adiantamento, --22
               a.nr_sequencia nr_seq_baixa, --27
               b.ie_origem_titulo, --32
               a.nr_sequencia nr_seq_titulo_rec_liq, --35
               a.nr_seq_cobranca, --36
               b.cd_estabelecimento, --41
               CASE WHEN coalesce(a.nr_seq_liq_origem::text, '') = '' THEN 'N'  ELSE 'S' END  ie_estorno, --42
               b.nr_seq_proj_rec --43
        into STRICT   dados_contab_w.nr_seq_conta_banco, --5
               dt_contabil_tit_w, --8
               nr_seq_retorno_w, --10
               nr_seq_ret_item_w, --11
               nr_seq_movto_trans_fin_w, --15
               ds_observacao_titulo_w, --16
               ds_observacao_liq_w, --20
               ie_acao_w, --21
               nr_adiantamento_w, --22
               nr_seq_baixa_w, --27
               dados_contab_w.ie_origem_tit_rec, --32
               nr_seq_titulo_rec_liq_w, --35
               nr_seq_cob_escritural_w, --36
               cd_estab_movimento_w, --41
               ie_estorno_w, --42
               dados_contab_w.nr_seq_proj_rec --43
        from   titulo_receber     b,
               titulo_receber_liq a
        where  a.nr_titulo = b.nr_titulo
        and    a.nr_titulo = doc_p.nr_documento
        and    a.nr_sequencia = doc_p.nr_seq_doc_compl
        and    a.vl_outros_acrescimos <> 0
        and    coalesce(ie_lib_caixa,'S') = 'S'
        and    (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
        and    ((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento));
        end;

    elsif (doc_p.nm_atributo = 'VL_RECURSADO') then
        begin
        ie_union_w := 35;
        select a.nr_seq_conta_banco, --5
               a.dt_recebimento, --8
               a.nr_seq_retorno, --10
               a.nr_seq_ret_item, --11
               a.NR_SEQ_MOVTO_TRANS_FIN, --15
               b.ds_observacao_titulo, --16
               a.ds_observacao, --20
               a.ie_acao, --21
               a.nr_adiantamento, --22
               a.nr_sequencia nr_seq_baixa, --27
               b.ie_origem_titulo, --32
               a.nr_sequencia nr_seq_titulo_rec_liq, --35
               a.nr_seq_cobranca, --36
               b.cd_estabelecimento, --41
               CASE WHEN coalesce(a.nr_seq_liq_origem::text, '') = '' THEN 'N'  ELSE 'S' END  ie_estorno, --42
               b.nr_seq_proj_rec --43
        into STRICT   dados_contab_w.nr_seq_conta_banco, --5
               dt_contabil_tit_w, --8
               nr_seq_retorno_w, --10
               nr_seq_ret_item_w, --11
               nr_seq_movto_trans_fin_w, --15
               ds_observacao_titulo_w, --16
               ds_observacao_liq_w, --20
               ie_acao_w, --21
               nr_adiantamento_w, --22
               nr_seq_baixa_w, --27
               dados_contab_w.ie_origem_tit_rec, --32
               nr_seq_titulo_rec_liq_w, --35
               nr_seq_cob_escritural_w, --36
               cd_estab_movimento_w, --41
               ie_estorno_w, --42
               dados_contab_w.nr_seq_proj_rec --43
        from   titulo_receber     b,
               titulo_receber_liq a
        where  a.nr_titulo = doc_p.nr_documento
        and    a.nr_sequencia = doc_p.nr_seq_doc_compl
        and    a.vl_recurso <> 0
        and    coalesce(ie_lib_caixa,'S') = 'S'
        and    (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
        and    a.nr_titulo = b.nr_titulo
        and    ((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento));
        end;

    elsif (doc_p.nm_atributo = 'VL_BAIXA_SEM_TRIB') then
        begin
        ie_union_w := 37;
        select a.dt_contabil, --8
               a.ds_observacao_titulo, --16
               a.ie_origem_titulo, --32
               b.nr_seq_cobranca, --36
               a.cd_estabelecimento, --41
               CASE WHEN coalesce(b.nr_seq_liq_origem::text, '') = '' THEN 'N'  ELSE 'S' END  ie_estorno, --42
               a.nr_seq_proj_rec --43
        into STRICT   dt_contabil_tit_w, --8
               ds_observacao_titulo_w, --16
               dados_contab_w.ie_origem_tit_rec, --32
               nr_seq_cob_escritural_w, --36
               cd_estab_movimento_w, --41
               ie_estorno_w, --42
               dados_contab_w.nr_seq_proj_rec --43
        from   Titulo_receber     a,
               titulo_receber_liq b
        where  b.nr_titulo = doc_p.nr_documento
        and    b.nr_sequencia = doc_p.nr_seq_doc_compl
        and    b.nr_titulo = a.nr_titulo
        and    a.cd_estabelecimento = doc_p.cd_estabelecimento
        and    (cr_obter_valor_liquido_tit(a.nr_titulo,a.vl_titulo) IS NOT NULL AND (cr_obter_valor_liquido_tit(a.nr_titulo,a.vl_titulo))::text <> '');
        end;

    elsif (doc_p.nm_atributo = 'VL_GLOSA_CRIT_REPASSE') then
        /* Atributo nao implementado na contabilidade online */


        --ie_uniow := 38;

        --ie_uniow := 39;
        null;
    elsif (doc_p.nm_atributo = 'VL_GLOSA_CRIT_HOSP') then
        /* Atributo nao implementado na contabilidade online */


        --ie_uniow := 40;

        --ie_uniow := 41;
        null;
    elsif (doc_p.nm_atributo = 'VL_RECEBIDO_TOTAL' and ctb_param_lote_contas_rec_w.ie_contab_rec_classif = 'N') then
        begin
        ie_union_w := 42;
        select a.nr_seq_conta_banco, --5
               a.dt_recebimento, --8
               a.nr_seq_retorno, --10
               a.nr_seq_ret_item, --11
               a.nr_seq_movto_trans_fin, --15
               b.ds_observacao_titulo, --16
               CASE WHEN ctb_param_lote_contas_rec_w.ie_prod_classif_baixa='S' THEN                      (obter_prod_financ_tit_liq_cc(a.nr_titulo,a.nr_sequencia))::numeric   ELSE (null)::numeric  END  nr_seq_produto, --19
               a.ds_observacao, --20
               a.ie_acao, --21
               a.nr_adiantamento, --22
               a.nr_sequencia nr_seq_baixa, --27
               b.ie_origem_titulo, --32
               a.nr_sequencia nr_seq_titulo_rec_liq, --35
               a.nr_seq_cobranca, --36
               CASE WHEN coalesce(a.nr_seq_liq_origem::text, '') = '' THEN 'N'  ELSE 'S' END  ie_estorno, --42
               b.nr_seq_proj_rec --43
        into STRICT   dados_contab_w.nr_seq_conta_banco, --5
               dt_contabil_tit_w, --8
               nr_seq_retorno_w, --10
               nr_seq_ret_item_w, --11
               nr_seq_movto_trans_fin_w, --15
               ds_observacao_titulo_w, --16
               dados_contab_w.nr_seq_produto, --19
               ds_observacao_liq_w, --20
               ie_acao_w, --21
               nr_adiantamento_w, --22
               nr_seq_baixa_w, --27
               dados_contab_w.ie_origem_tit_rec, --32
               nr_seq_titulo_rec_liq_w, --35
               nr_seq_cob_escritural_w, --36
               ie_estorno_w, --42
               dados_contab_w.nr_seq_proj_rec --43
        from   titulo_receber     b,
               titulo_receber_liq a
        where  a.nr_titulo = doc_p.nr_documento
        and    a.nr_sequencia = doc_p.nr_seq_doc_compl
        and    a.vl_recebido <> 0
        and    a.nr_titulo = b.nr_titulo
        and    (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
        and    coalesce(ie_lib_caixa,'S') = 'S'
        and    ((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento));
        end;
    end if;

elsif (doc_p.nm_tabela = 'TITULO_REC_LIQ_CC') then

    if (doc_p.nm_atributo = 'VL_RECEBIDO' and ctb_param_lote_contas_rec_w.ie_contab_rec_classif = 'S') then
        begin
        ie_union_w := 2;
        select a.nr_seq_conta_banco,
               coalesce(c.cd_centro_custo,0),
               a.dt_recebimento,
               coalesce(c.cd_conta_contabil,''),
               a.nr_seq_retorno,
               a.nr_seq_ret_item,
               a.NR_SEQ_MOVTO_TRANS_FIN,
               b.ds_observacao_titulo,
               c.nr_seq_produto,
               a.ds_observacao,
               a.ie_acao,
               a.nr_adiantamento,
               a.nr_sequencia nr_seq_baixa,
               b.ie_origem_titulo,
               a.nr_sequencia nr_seq_titulo_rec_liq,
               a.nr_seq_cobranca,
               coalesce(c.cd_estab_centro_custo,null) cd_estabelecimento,
               CASE WHEN coalesce(a.nr_seq_liq_origem::text, '') = '' THEN 'N'  ELSE 'S' END  ie_estorno,
               b.nr_seq_proj_rec
        into STRICT   dados_contab_w.nr_seq_conta_banco, --5
               dados_contab_w.cd_centro_custo, --7
               dt_contabil_tit_w, --8
               dados_contab_w.cd_conta_contabil, --9
               nr_seq_retorno_w, --10
               nr_seq_ret_item_w, --11
               nr_seq_movto_trans_fin_w, --15
               ds_observacao_titulo_w, --16
               dados_contab_w.nr_seq_produto, --19
               ds_observacao_liq_w, --20
               ie_acao_w, --21
               nr_adiantamento_w, --22
               nr_seq_baixa_w, --27
               dados_contab_w.ie_origem_tit_rec, --32
               nr_seq_titulo_rec_liq_w, --35
               nr_seq_cob_escritural_w, --36
               cd_estab_movimento_w, --41
               ie_estorno_w, --42
               dados_contab_w.nr_seq_proj_rec --43
        from   titulo_rec_liq_cc  c,
               titulo_receber     b,
               titulo_receber_liq a
        where  c.nr_titulo = doc_p.nr_documento
        and    c.nr_seq_baixa = doc_p.nr_seq_doc_compl
        and    c.nr_sequencia = doc_p.nr_doc_analitico
        and    a.vl_Recebido <> 0
        and    (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
        and    a.nr_titulo = b.nr_titulo
        and    ((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento))
        and    a.nr_titulo = c.nr_titulo
        and    a.nr_sequencia = c.nr_seq_baixa
        and    coalesce(ie_lib_caixa,'S') = 'S'
        and    ((coalesce(ie_lote_pro_rata::text, '') = '') or (not exists (SELECT 1
                                                           from   titulo_rec_liq_cc x
                                                           where  x.nr_seq_baixa = a.nr_sequencia
                                                           and    x.nr_titulo = a.nr_titulo
                                                           and    coalesce(x.ie_lote_pro_rata::text, '') = '')));
        end;

    elsif (doc_p.nm_atributo = 'VL_GLOSA' and ctb_param_lote_contas_rec_w.ie_cc_glosa <> 'N') then
        begin
        ie_union_w := 9;
        select a.nr_seq_conta_banco, --5
               x.cd_centro_custo, --7
               a.dt_recebimento, --8
               x.cd_conta_contabil, --9
               a.nr_seq_retorno, --10
               a.nr_seq_ret_item, --11
               a.nr_seq_movto_trans_fin, --15
               b.ds_observacao_titulo, --16
               x.nr_seq_produto, --19
               a.ds_observacao, --20
               a.ie_acao, --21
               a.nr_adiantamento, --22
               a.nr_sequencia nr_seq_baixa, --27
               b.ie_origem_titulo, --32
               a.nr_sequencia nr_seq_titulo_rec_liq, --35
               a.nr_seq_cobranca, --36
               b.cd_estabelecimento cd_estabelecimento, --41
               CASE WHEN coalesce(a.nr_seq_liq_origem::text, '') = '' THEN 'N'  ELSE 'S' END  ie_estorno, --42
               b.nr_seq_proj_rec --43
        into STRICT   dados_contab_w.nr_seq_conta_banco, --5
               dados_contab_w.cd_centro_custo, --7
               dt_contabil_tit_w, --8
               dados_contab_w.cd_conta_contabil, --9
               nr_seq_retorno_w, --10
               nr_seq_ret_item_w, --11
               nr_seq_movto_trans_fin_w, --15
               ds_observacao_titulo_w, --16
               dados_contab_w.nr_seq_produto, --19
               ds_observacao_liq_w, --20
               ie_acao_w, --21
               nr_adiantamento_w, --22
               nr_seq_baixa_w, --27
               dados_contab_w.ie_origem_tit_rec, --32
               nr_seq_titulo_rec_liq_w, --35
               nr_seq_cob_escritural_w, --36
               cd_estab_movimento_w, --41
               ie_estorno_w, --42
               dados_contab_w.nr_seq_proj_rec --43
        from   Titulo_rec_liq_cc  x,
               titulo_receber     b,
               titulo_receber_liq a
        where  x.nr_titulo = doc_p.nr_documento
        and    x.nr_seq_baixa = doc_p.nr_seq_doc_compl
        and    x.nr_sequencia = doc_p.nr_doc_analitico
        and    a.nr_titulo = x.nr_titulo
        and    a.nr_sequencia = x.nr_seq_baixa
        and    a.nr_titulo = b.nr_titulo
        and    a.vl_Glosa <> 0
        and    coalesce(ie_lib_caixa,'S') = 'S'
        and    (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
        and    ((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento))
        and    coalesce(b.nr_seq_mensalidade::text, '') = '';
        end;

    elsif (doc_p.nm_atributo = 'VL_PERDAS') then
        begin
        ie_union_w := 44;
        select a.nr_seq_conta_banco, --5
               coalesce(c.cd_centro_custo,0), --7
               a.dt_recebimento,
               coalesce(c.cd_conta_contabil,''), --9
               a.nr_seq_retorno, --10
               a.nr_seq_ret_item, --11
               a.nr_seq_movto_trans_fin, --15
               b.ds_observacao_titulo, --16
               coalesce(c.nr_seq_produto,(null)::numeric ), --19
               a.ds_observacao, --20
               a.ie_acao, --21
               a.nr_adiantamento, --22
               a.nr_sequencia nr_seq_baixa, --27
               b.ie_origem_titulo, --32
               a.nr_sequencia nr_seq_titulo_rec_liq, --35
               a.nr_seq_cobranca, --36
               b.cd_estabelecimento cd_estabelecimento, --41
               CASE WHEN coalesce(a.nr_seq_liq_origem::text, '') = '' THEN 'N'  ELSE 'S' END  ie_estorno, --42
               b.nr_seq_proj_rec --43
        into STRICT   dados_contab_w.nr_seq_conta_banco, --5
               dados_contab_w.cd_centro_custo, --7
               dt_contabil_tit_w, --8
               dados_contab_w.cd_conta_contabil, --9
               nr_seq_retorno_w, --10
               nr_seq_ret_item_w, --11
               nr_seq_movto_trans_fin_w, --15
               ds_observacao_titulo_w, --16
               dados_contab_w.nr_seq_produto, --19
               ds_observacao_liq_w, --20
               ie_acao_w, --21
               nr_adiantamento_w, --22
               nr_seq_baixa_w, --27
               dados_contab_w.ie_origem_tit_rec, --32
               nr_seq_titulo_rec_liq_w, --35
               nr_seq_cob_escritural_w, --36
               cd_estab_movimento_w, --41
               ie_estorno_w, --42
               dados_contab_w.nr_seq_proj_rec --43
        from   titulo_rec_liq_cc  c,
               titulo_receber     b,
               titulo_receber_liq a
        where  c.nr_titulo = doc_p.nr_documento
        and    a.nr_sequencia = doc_p.nr_seq_doc_compl
        and    c.nr_sequencia = doc_p.nr_doc_analitico
        and    a.nr_titulo = b.nr_titulo
        and    a.nr_titulo = c.nr_titulo
        and    a.nr_sequencia = c.nr_seq_baixa
        and    (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
        and    coalesce(c.vl_perdas,0) <> 0
        and    coalesce(ie_lib_caixa,'S') = 'S'
        and    ((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento));
        end;

    elsif (doc_p.nm_atributo = 'VL_RECEBIDO_ESTRANG') then
        begin
        ie_union_w := 45;
        select a.nr_seq_conta_banco, --5
               x.cd_centro_custo, --7
               a.dt_recebimento, --8
               x.cd_conta_rec_antecip cd_conta_contabil, --9
               a.nr_seq_retorno, --10
               a.nr_seq_ret_item, --11
               x.cd_historico_pls, --14
               a.nr_seq_movto_trans_fin, --15
               b.ds_observacao_titulo, --16
               x.nr_seq_produto, --19
               a.ds_observacao, --20
               a.ie_acao, --21
               a.nr_adiantamento, --22
               a.nr_sequencia, --27
               b.ie_origem_titulo, --32
               a.nr_sequencia nr_seq_titulo_rec_liq, --35
               a.nr_seq_cobranca, --36
               b.cd_estabelecimento cd_estabelecimento, --41
               CASE WHEN coalesce(a.nr_seq_liq_origem::text, '') = '' THEN 'N'  ELSE 'S' END  ie_estorno, --42
               b.nr_seq_proj_rec --43
        into STRICT   dados_contab_w.nr_seq_conta_banco, --5
               dados_contab_w.cd_centro_custo, --7
               dt_contabil_tit_w, --8
               dados_contab_w.cd_conta_contabil, --9
               nr_seq_retorno_w, --10
               nr_seq_ret_item_w, --11
               cd_historico_pls_w, --14
               nr_seq_movto_trans_fin_w, --15
               ds_observacao_titulo_w, --16
               dados_contab_w.nr_seq_produto, --19
               ds_observacao_liq_w, --20
               ie_acao_w, --21
               nr_adiantamento_w, --22
               nr_seq_baixa_w, --27
               dados_contab_w.ie_origem_tit_rec, --32
               nr_seq_titulo_rec_liq_w, --35
               nr_seq_cob_escritural_w, --36
               cd_estab_movimento_w, --41
               ie_estorno_w, --42
               dados_contab_w.nr_seq_proj_rec --43
        from   titulo_rec_liq_cc  x,
               titulo_receber     b,
               titulo_receber_liq a
        where  x.nr_titulo = doc_p.nr_documento
        and    x.nr_seq_baixa = doc_p.nr_seq_doc_compl
        and    x.nr_sequencia = doc_p.nr_doc_analitico
        and    a.nr_titulo = b.nr_titulo
        and    a.nr_titulo = x.nr_titulo
        and    a.nr_sequencia = x.nr_seq_baixa
        and    coalesce(coalesce(x.vl_recebido_estrang,a.vl_recebido_estrang),0) <> 0;
        end;

    elsif (doc_p.nm_atributo = 'VL_MOEDA_COMPLEMENTAR') then
        begin
        ie_union_w := 46;
        select a.nr_seq_conta_banco, --5
               x.cd_centro_custo, --7
               a.dt_recebimento, --8
               x.cd_conta_rec_antecip cd_conta_contabil, --9
               a.nr_seq_retorno, --10
               a.nr_seq_ret_item, --11
               x.cd_historico_pls, --14
               a.nr_seq_movto_trans_fin, --15
               b.ds_observacao_titulo, --16
               x.nr_seq_produto, --19
               a.ds_observacao, --20
               a.ie_acao, --21
               a.nr_adiantamento, --22
               a.nr_sequencia, --27
               b.ie_origem_titulo, --32
               a.nr_sequencia nr_seq_titulo_rec_liq, --35
               a.nr_seq_cobranca, --36
               b.cd_estabelecimento cd_estabelecimento, --41
               CASE WHEN coalesce(a.nr_seq_liq_origem::text, '') = '' THEN 'N'  ELSE 'S' END  ie_estorno, --42
               b.nr_seq_proj_rec --43
        into STRICT   dados_contab_w.nr_seq_conta_banco, --5
               dados_contab_w.cd_centro_custo, --7
               dt_contabil_tit_w, --8
               dados_contab_w.cd_conta_contabil, --9
               nr_seq_retorno_w, --10
               nr_seq_ret_item_w, --11
               cd_historico_pls_w, --14
               nr_seq_movto_trans_fin_w, --15
               ds_observacao_titulo_w, --16
               dados_contab_w.nr_seq_produto, --19
               ds_observacao_liq_w, --20
               ie_acao_w, --21
               nr_adiantamento_w, --22
               nr_seq_baixa_w, --27
               dados_contab_w.ie_origem_tit_rec, --32
               nr_seq_titulo_rec_liq_w, --35
               nr_seq_cob_escritural_w, --36
               cd_estab_movimento_w, --41
               ie_estorno_w, --42
               dados_contab_w.nr_seq_proj_rec --43
        from   titulo_rec_liq_cc  x,
               titulo_receber     b,
               titulo_receber_liq a
        where  x.nr_titulo = doc_p.nr_documento
        and    x.nr_seq_baixa = doc_p.nr_seq_doc_compl
        and    x.nr_sequencia = doc_p.nr_doc_analitico
        and    a.nr_titulo = b.nr_titulo
        and    a.nr_titulo = x.nr_titulo
        and    a.nr_sequencia = x.nr_seq_baixa
        and    coalesce(coalesce(x.vl_complemento,a.vl_complemento),0) <> 0;
        end;
    end if;

elsif (doc_p.nm_tabela = 'TITULO_RECEBER') then
    begin
    if (doc_p.nm_atributo = 'VL_TITULO_RECEBER') then
        begin
        ie_union_w := 14;
        select coalesce(a.dt_contabil,dados_contab_w.dt_transacao),
               a.ds_observacao_titulo,
               a.ie_origem_titulo,
               a.cd_estabelecimento,
               a.nr_seq_proj_rec
        into STRICT   dt_contabil_tit_w,
               ds_observacao_titulo_w,
               dados_contab_w.ie_origem_tit_rec,
               cd_estab_movimento_w,
               dados_contab_w.nr_seq_proj_rec
        from   titulo_receber a
        where  a.nr_titulo = doc_p.nr_documento
        and    a.cd_estabelecimento = doc_p.cd_estabelecimento
        and    (a.nr_seq_trans_fin_contab IS NOT NULL AND a.nr_seq_trans_fin_contab::text <> '')
        and    ((ctb_param_lote_contas_rec_w.ie_contab_classif_tit_rec = 'N') or (not exists (SELECT 1
                                                                                              from   titulo_receber_classif x
                                                                                              where  a.nr_titulo = x.nr_titulo)));
        end;

    elsif (doc_p.nm_atributo = 'VL_LIQUIDO_TIT') then
        begin
        ie_union_w := 27;
        select coalesce(a.dt_contabil,dados_contab_w.dt_transacao),
               a.ds_observacao_titulo,
               a.ie_origem_titulo,
               a.cd_estabelecimento,
               a.nr_seq_proj_rec
        into STRICT   dt_contabil_tit_w, --8
               ds_observacao_titulo_w, --16
               dados_contab_w.ie_origem_tit_rec, --32
               cd_estab_movimento_w, --41
               dados_contab_w.nr_seq_proj_rec --43
        from   titulo_receber a
        where  a.nr_titulo = doc_p.nr_documento
        and    a.cd_estabelecimento = doc_p.cd_estabelecimento
        and    (a.nr_seq_trans_fin_contab IS NOT NULL AND a.nr_seq_trans_fin_contab::text <> '');
        end;

    elsif (doc_p.nm_atributo = 'VL_CURTO_PRAZO' and ctb_param_lote_contas_rec_w.ie_contab_curto_prazo = 'S') then
        begin
        ie_union_w := 33;
        select pkg_date_utils.add_month(a.dt_vencimento,-12,0), --8
               a.ds_observacao_titulo, --16
               a.ie_origem_titulo, --32
               a.cd_estabelecimento, --41
               a.nr_seq_proj_rec --43
        into STRICT   dt_contabil_tit_w, --8
               ds_observacao_titulo_w, --16
               dados_contab_w.ie_origem_tit_rec, --32
               cd_estab_movimento_w, --41
               dados_contab_w.nr_seq_proj_rec --43
        from   titulo_receber a
        where  a.nr_titulo = doc_p.nr_documento
        and    a.nr_lote_contabil <> a.nr_lote_contabil_curto_prazo
        and    a.nr_lote_contabil <> 0
        and    (a.nr_seq_tf_curto_prazo IS NOT NULL AND a.nr_seq_tf_curto_prazo::text <> '');
        end;

    elsif (doc_p.nm_atributo = 'VL_LONGO_PRAZO' and ctb_param_lote_contas_rec_w.ie_contab_curto_prazo = 'S') then
        begin
        ie_union_w := 34;
        select a.dt_contabil, --8
               a.ds_observacao_titulo, --16
               a.ie_origem_titulo, --32
               a.cd_estabelecimento, --41
               a.nr_seq_proj_rec --43
        into STRICT   dt_contabil_tit_w, --8
               ds_observacao_titulo_w, --16
               dados_contab_w.ie_origem_tit_rec, --32
               cd_estab_movimento_w, --41
               dados_contab_w.nr_seq_proj_rec --43
        from   Titulo_receber a
        where  a.nr_titulo = doc_p.nr_documento
        and    a.dt_vencimento > pkg_date_utils.add_month(a.dt_contabil,12,0)
        and    (a.nr_seq_tf_curto_prazo IS NOT NULL AND a.nr_seq_tf_curto_prazo::text <> '');
        end;
    end if;
    end;
elsif (doc_p.nm_tabela = 'TITULO_RECEBER_LIQ_CC' and ctb_param_lote_contas_rec_w.ie_cc_glosa <> 'N') then

    if (doc_p.nm_atributo = 'VL_GLOSA_DETALHE' and ctb_param_lote_contas_rec_w.ie_contab_glosa_detalhe = 'S') then
        begin
        ie_union_w := 10;
        select a.nr_seq_conta_banco, --5
               x.cd_centro_custo, --7
               a.dt_recebimento, --8
               x.cd_conta_contabil, --9
               a.nr_seq_retorno, --10
               a.nr_seq_ret_item, --11
               a.nr_seq_movto_trans_fin, --15
               b.ds_observacao_titulo, --16
               x.nr_seq_produto, --19
               a.ds_observacao, --20
               a.ie_acao, --21
               a.nr_adiantamento, --22
               a.nr_sequencia nr_seq_baixa, --27
               b.ie_origem_titulo, --32
               d.nr_seq_propaci_partic, --34
               a.nr_sequencia nr_seq_titulo_rec_liq, --35
               a.nr_seq_cobranca, --36
               b.cd_estabelecimento cd_estabelecimento, --41
               CASE WHEN coalesce(a.nr_seq_liq_origem::text, '') = '' THEN 'N'  ELSE 'S' END  ie_estorno, --42
               b.nr_seq_proj_rec --43
        into STRICT   dados_contab_w.nr_seq_conta_banco, --5
               dados_contab_w.cd_centro_custo, --7
               dt_contabil_tit_w, --8
               dados_contab_w.cd_conta_contabil, --9
               nr_seq_retorno_w, --10
               nr_seq_ret_item_w, --11
               nr_seq_movto_trans_fin_w, --15
               ds_observacao_titulo_w, --16
               dados_contab_w.nr_seq_produto, --19
               ds_observacao_liq_w, --20
               ie_acao_w, --21
               nr_adiantamento_w, --22
               nr_seq_baixa_w, --27
               dados_contab_w.ie_origem_tit_rec, --32
               nr_seq_propaci_partic_w, --34
               nr_seq_titulo_rec_liq_w, --35
               nr_seq_cob_escritural_w, --36
               cd_estab_movimento_w, --41
               ie_estorno_w, --42
               dados_contab_w.nr_seq_proj_rec --43
        from   convenio_retorno_glosa d,
               titulo_rec_liq_cc      x,
               titulo_receber         b,
               titulo_receber_liq     a
        where  x.nr_titulo = doc_p.nr_documento
        and    x.nr_seq_baixa = doc_p.nr_seq_doc_compl
        and    x.nr_sequencia = doc_p.nr_doc_analitico
        and    d.nr_seq_ret_item = a.nr_seq_ret_item
        and    a.nr_titulo = b.nr_titulo
        and    a.nr_titulo = x.nr_titulo
        and    a.nr_sequencia = x.nr_seq_baixa
        and    (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
        and    (d.nr_seq_trans_financ IS NOT NULL AND d.nr_seq_trans_financ::text <> '')
        and    coalesce(b.nr_seq_mensalidade::text, '') = ''
        and    a.vl_glosa <> 0
        and    x.vl_baixa <> 0
        and    coalesce(ie_lib_caixa,'S') = 'S'
        and    ((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento));
        end;

    elsif (doc_p.nm_atributo = 'VL_REC_MAIOR') then
        begin
        ie_union_w := 12;
        select a.nr_seq_conta_banco, --5
               x.cd_centro_custo, --7
               a.dt_recebimento, --8
               x.cd_conta_contabil, --9
               a.nr_seq_retorno, --10
               a.nr_seq_ret_item, --11
               a.nr_seq_movto_trans_fin, --15
               b.ds_observacao_titulo, --16
               x.nr_seq_produto, --19
               a.ds_observacao, --20
               a.ie_acao, --21
               a.nr_adiantamento, --22
               a.nr_sequencia nr_seq_baixa, --27
               b.ie_origem_titulo, --32
               a.nr_sequencia nr_seq_titulo_rec_liq, --35
               a.nr_seq_cobranca, --36
               coalesce(x.cd_estab_centro_custo,null) cd_estabelecimento, --41
               CASE WHEN coalesce(a.nr_seq_liq_origem::text, '') = '' THEN 'N'  ELSE 'S' END  ie_estorno, --42
               b.nr_seq_proj_rec --43
        into STRICT   dados_contab_w.nr_seq_conta_banco, --5
               dados_contab_w.cd_centro_custo, --7
               dt_contabil_tit_w, --8
               dados_contab_w.cd_conta_contabil, --9
               nr_seq_retorno_w, --10
               nr_seq_ret_item_w, --11
               nr_seq_movto_trans_fin_w, --15
               ds_observacao_titulo_w, --16
               dados_contab_w.nr_seq_produto, --19
               ds_observacao_liq_w, --20
               ie_acao_w, --21
               nr_adiantamento_w, --22
               nr_seq_baixa_w, --27
               dados_contab_w.ie_origem_tit_rec, --32
               nr_seq_titulo_rec_liq_w, --35
               nr_seq_cob_escritural_w, --36
               cd_estab_movimento_w, --41
               ie_estorno_w, --42
               dados_contab_w.nr_seq_proj_rec --43
        from   Titulo_rec_liq_cc  x,
               titulo_receber     b,
               titulo_receber_liq a
        where  x.nr_titulo = doc_p.nr_documento
        and    x.nr_seq_baixa = doc_p.nr_seq_doc_compl
        and    x.nr_sequencia = doc_p.nr_doc_analitico
        and    a.nr_titulo = b.nr_titulo
        and    a.nr_titulo = x.nr_titulo
        and    a.nr_sequencia = x.nr_seq_baixa
        and    a.vl_rec_maior <> 0
        and    coalesce(ie_lib_caixa,'S') = 'S'
        and    (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
        and    coalesce(b.nr_seq_mensalidade::text, '') = ''
        and    ((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento));
        end;
    end if;

elsif (doc_p.nm_tabela = 'MOVTO_CARTAO_CR_BAIXA' and ctb_param_lote_contas_rec_w.ie_contab_cartao_cr = 'CR') then

    if (doc_p.nm_atributo = 'VL_BAIXA_CARTAO_CR') then
        begin
        ie_union_w := 24;
        select a.nr_seq_conta_banco, --5
               a.dt_baixa, --8
               b.ds_comprovante, --17
               b.nr_autorizacao, --18
               b.nr_sequencia nr_seq_movto_cartao_cr, --23
               substr(a.ds_observacao,1,255) ds_obs_movto_cartao_baixa --33
        into STRICT   dados_contab_w.nr_seq_conta_banco, --5
               dt_contabil_tit_w, --8
               ds_comprovante_w, --17
               nr_autorizacao_w, --18
               nr_seq_movto_cartao_cr_w, --23
               ds_obs_movto_cartao_baixa_w --33
        from   movto_cartao_cr       b,
               movto_cartao_cr_baixa a
        where  a.nr_seq_movto = doc_p.nr_documento
        and    a.nr_sequencia = doc_p.nr_seq_doc_compl
        and    a.nr_seq_movto = b.nr_sequencia
        and    ((b.cd_estabelecimento = doc_p.cd_estabelecimento) or (ctb_param_lote_contas_rec_w.ie_movto_cartao_estab = 'S'))
        and    (a.nr_seq_trans_financ IS NOT NULL AND a.nr_seq_trans_financ::text <> '');
        end;

    elsif (doc_p.nm_atributo = 'VL_DESP_EQUIP_CARTAO_CR') then
        begin
        ie_union_w := 25;
        select a.nr_seq_conta_banco, --5
               a.dt_baixa, --8
               b.ds_comprovante, --17
               b.nr_autorizacao, --18
               b.nr_sequencia nr_seq_movto_cartao_cr, --23
               substr(a.ds_observacao,1,255) ds_obs_movto_cartao_baixa --33
        into STRICT   dados_contab_w.nr_seq_conta_banco, --5
               dt_contabil_tit_w, --8
               ds_comprovante_w, --17
               nr_autorizacao_w, --18
               nr_seq_movto_cartao_cr_w, --23
               ds_obs_movto_cartao_baixa_w --33
        from   movto_cartao_cr       b,
               movto_cartao_cr_baixa a
        where  a.nr_seq_movto = doc_p.nr_documento
        and    a.nr_sequencia = doc_p.nr_seq_doc_compl
        and    a.nr_seq_movto = b.nr_sequencia
        and    b.cd_estabelecimento = doc_p.cd_estabelecimento
        and    (a.nr_seq_trans_financ IS NOT NULL AND a.nr_seq_trans_financ::text <> '');
        end;

    elsif (doc_p.nm_atributo = 'VL_DESPESA_CARTAO_CR') then
        begin
        ie_union_w := 26;
        select a.nr_seq_conta_banco, --5
               a.dt_baixa, --8
               b.ds_comprovante, --17
               b.nr_autorizacao, --18
               b.nr_sequencia nr_seq_movto_cartao_cr, --23
               substr(a.ds_observacao,1,255) ds_obs_movto_cartao_baixa --33
        into STRICT   dados_contab_w.nr_seq_conta_banco, --5
               dt_contabil_tit_w, --8
               ds_comprovante_w, --17
               nr_autorizacao_w, --18
               nr_seq_movto_cartao_cr_w, --23
               ds_obs_movto_cartao_baixa_w --33
        from   movto_cartao_cr       b,
               movto_cartao_cr_baixa a
        where  a.nr_seq_movto = doc_p.nr_documento
        and    a.nr_sequencia = doc_p.nr_seq_doc_compl
        and    a.nr_seq_movto = b.nr_sequencia
        and    b.cd_estabelecimento = doc_p.cd_estabelecimento
        and    (a.nr_seq_trans_financ IS NOT NULL AND a.nr_seq_trans_financ::text <> '');
        end;
    end if;

elsif (doc_p.nm_tabela = 'MOVTO_BANCO_PEND_BX_CONTAB_V' and doc_p.nm_atributo in ('VL_BAIXA_CNI','VL_JUROS_CNI','VL_MULTA_CNI')) then
    begin
    ie_union_w := 30;
    select a.nr_seq_trans_contab_cheque, --3
           a.dt_recebimento, --8
           a.nr_seq_movto_trans_fin, --15
           a.ds_observacao, --20
           a.nr_adiantamento --22
    into STRICT   dados_contab_w.nr_seq_trans_fin, --3
           dt_contabil_tit_w, --8
           nr_seq_movto_trans_fin_w, --15
           ds_observacao_liq_w, --20
           nr_adiantamento_w --22
    from   movto_banco_pend_bx_contab_v a
    where  a.nr_titulo = doc_p.nr_documento
    and    a.nr_seq_movto_pend_baixa = doc_p.nr_seq_doc_compl
    and    a.nm_atributo = doc_p.nm_atributo;
    end;

elsif (doc_p.nm_tabela = 'TITULO_RECEBER_LIQ_CONTAB_V2' and doc_p.nm_atributo in ('VL_DESCONTOS','VL_JUROS','VL_MULTA')) then
    begin
    ie_union_w := 3;
    select a.nr_seq_conta_banco, --5
           a.cd_centro_custo, --7
           a.dt_recebimento, --8
           a.cd_conta_contabil, --9
           a.nr_seq_retorno, --10
           a.nr_seq_ret_item, --11
           a.nr_seq_movto_trans_fin, --15
           b.ds_observacao_titulo, --16
           a.ds_observacao, --20
           a.ie_acao, --21
           a.nr_adiantamento, --22
           a.nr_seq_baixa, --27
           b.ie_origem_titulo, --32
           a.nr_seq_baixa nr_seq_titulo_rec_liq, --35
           a.nr_seq_cobranca, --36
           b.cd_estabelecimento, --41
           CASE WHEN coalesce(a.nr_seq_liq_origem::text, '') = '' THEN 'N'  ELSE 'S' END  ie_estorno, --42
           b.nr_seq_proj_rec --43
    into STRICT   dados_contab_w.nr_seq_conta_banco, --5
           dados_contab_w.cd_centro_custo, --7
           dt_contabil_tit_w, --8
           dados_contab_w.cd_conta_contabil, --9
           nr_seq_retorno_w, --10
           nr_seq_ret_item_w, --11
           nr_seq_movto_trans_fin_w, --15
           ds_observacao_titulo_w, --16
           ds_observacao_liq_w, --20
           ie_acao_w, --21
           nr_adiantamento_w, --22
           nr_seq_baixa_w, --27
           dados_contab_w.ie_origem_tit_rec, --32
           nr_seq_titulo_rec_liq_w, --35
           nr_seq_cob_escritural_w, --36
           cd_estab_movimento_w, --41
           ie_estorno_w, --42
           dados_contab_w.nr_seq_proj_rec --43
    from   titulo_receber               b,
           titulo_receber_liq_contab_v2 a
    where  a.nr_titulo = doc_p.nr_documento
    and    a.nr_seq_baixa = doc_p.nr_seq_doc_compl
    and    coalesce(a.nr_seq_baixa_cc,0) = coalesce(doc_p.nr_doc_analitico,0)
    and    a.nr_titulo = b.nr_titulo
    and    a.ds_atributo = doc_p.nm_atributo
    and    ((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento));
    end;

elsif (doc_p.nm_tabela = 'ALTERACAO_PORTADOR') then
    if (doc_p.nm_atributo = 'VL_ALTERACAO_PORTADOR') then
        begin
        ie_union_w := 19;
        select a.dt_alteracao --8
        into STRICT   dt_contabil_tit_w --8
        from   alteracao_portador a
        where  a.nr_titulo = doc_p.nr_documento
        and    a.nr_sequencia = doc_p.nr_seq_doc_compl
        and    (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '');
        end;

    elsif (doc_p.nm_atributo = 'VL_TIT_ALT_PORTADOR') then
        begin
        ie_union_w := 20;
        select a.dt_alteracao --8
        into STRICT   dt_contabil_tit_w --8
        from   alteracao_portador a
        where  a.nr_titulo = doc_p.nr_documento
        and    a.nr_sequencia = doc_p.nr_seq_doc_compl
        and    (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '');
        end;
    end if;

elsif (doc_p.nm_tabela = 'TITULO_RECEBER_LIQ_CTB_CAMB_V' and doc_p.nm_atributo in ('VL_CAMBIAL_ATIVO','VL_CAMBIAL_PASSIVO')) then
    begin
    ie_union_w := 7;
    select a.nr_seq_conta_banco, --5
           a.dt_recebimento, --8
           a.nr_seq_retorno, --10
           a.nr_seq_ret_item, --11
           a.nr_seq_movto_trans_fin, --15
           b.ds_observacao_titulo, --16
           a.ds_observacao, --20
           a.ie_acao, --21
           a.nr_adiantamento, --22
           b.ie_origem_titulo, --32
           b.cd_estabelecimento, --41
           b.nr_seq_proj_rec --43
    into STRICT   dados_contab_w.nr_seq_conta_banco, --5
           dt_contabil_tit_w, --8
           nr_seq_retorno_w, --10
           nr_seq_ret_item_w, --11
           nr_seq_movto_trans_fin_w, --15
           ds_observacao_titulo_w, --16
           ds_observacao_liq_w, --20
           ie_acao_w, --21
           nr_adiantamento_w, --22
           dados_contab_w.ie_origem_tit_rec, --32
           cd_estab_movimento_w, --41
           dados_contab_w.nr_seq_proj_rec --43
    from   titulo_receber                b,
           titulo_receber_liq_ctb_camb_v a
    where  a.nr_titulo = doc_p.nr_documento
    and    a.nr_seq_baixa = doc_p.nr_seq_doc_compl
    and    a.nr_titulo = b.nr_titulo
    and    a.vl_transacao <> 0
    and    (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
    and    ((ie_permite_estab_dif_w <> 'n') or (b.cd_estabelecimento = doc_p.cd_estabelecimento))
    and    a.ds_atributo = doc_p.nm_atributo;
    end;

elsif (doc_p.nm_tabela = 'ALTERACAO_VALOR' and doc_p.nm_atributo = 'VL_ALTERACAO') then
    begin
    ie_union_w := 13;
    select a.dt_alteracao, --8
           b.ie_origem_titulo, --32
           b.nr_seq_proj_rec --43
    into STRICT   dt_contabil_tit_w, --8
           dados_contab_w.ie_origem_tit_rec, --32
           dados_contab_w.nr_seq_proj_rec --43
    from   alteracao_valor a,
           titulo_receber  b
    where  a.nr_titulo = doc_p.nr_documento
    and    a.nr_sequencia = doc_p.nr_seq_doc_compl
    and    a.nr_titulo = b.nr_titulo
    and    (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '');
    end;

elsif (doc_p.nm_tabela = 'TITULO_RECEBER_CLASSIF' and doc_p.nm_atributo = 'VL_TITULO_RECEBER' and ctb_param_lote_contas_rec_w.ie_contab_classif_tit_rec = 'S') then
    begin
    ie_union_w := 15;
    select coalesce(b.cd_centro_custo,0) cd_centro_custo,
           coalesce(a.dt_contabil,dados_contab_w.dt_transacao),
           b.cd_conta_contabil,
           a.ds_observacao_titulo,
           b.nr_seq_produto,
           a.ie_origem_titulo,
           a.cd_estabelecimento,
           a.nr_seq_proj_rec
    into STRICT   dados_contab_w.cd_centro_custo,
           dt_contabil_tit_w,
           dados_contab_w.cd_conta_contabil,
           ds_observacao_titulo_w,
           dados_contab_w.nr_seq_produto,
           dados_contab_w.ie_origem_tit_rec,
           cd_estab_movimento_w,
           dados_contab_w.nr_seq_proj_rec
    from   titulo_receber_classif b,
           titulo_receber         a
    where  b.nr_titulo = doc_p.nr_documento
    and    b.nr_sequencia = doc_p.nr_seq_doc_compl
    and    a.nr_titulo = b.nr_titulo
    and    (a.nr_seq_trans_fin_contab IS NOT NULL AND a.nr_seq_trans_fin_contab::text <> '');
    end;

elsif (doc_p.nm_tabela = 'TITULO_RECEBER_TRIB_BAIXA' and doc_p.nm_atributo = 'VL_TRIB_TIT_REC') then
    begin
    ie_union_w := 18;
    select a.nr_seq_conta_banco, --5
           a.dt_recebimento, --8
           a.nr_seq_retorno, --10
           a.nr_seq_ret_item, --11
           a.nr_seq_movto_trans_fin, --15
           b.ds_observacao_titulo, --16
           a.ds_observacao, --20
           a.ie_acao, --21
           a.nr_adiantamento, --22
           a.nr_sequencia nr_seq_baixa, --27
           coalesce(d.cd_tributo,0) cd_tributo, --31
           b.ie_origem_titulo, --32
           a.nr_sequencia nr_seq_titulo_rec_liq, --35
           a.nr_seq_cobranca, --36
           b.cd_estabelecimento, --41
           CASE WHEN coalesce(a.nr_seq_liq_origem::text, '') = '' THEN 'N'  ELSE 'S' END  ie_estorno, --42
           b.nr_seq_proj_rec --43
    into STRICT   dados_contab_w.nr_seq_conta_banco, --5
           dt_contabil_tit_w, --8
           nr_seq_retorno_w, --10
           nr_seq_ret_item_w, --11
           nr_seq_movto_trans_fin_w, --15
           ds_observacao_titulo_w, --16
           ds_observacao_liq_w, --20
           ie_acao_w, --21
           nr_adiantamento_w, --22
           nr_seq_baixa_w, --27
           dados_contab_w.cd_tributo_regra, --31
           dados_contab_w.ie_origem_tit_rec, --32
           nr_seq_titulo_rec_liq_w, --35
           nr_seq_cob_escritural_w, --36
           cd_estab_movimento_w, --41
           ie_estorno_w, --42
           dados_contab_w.nr_seq_proj_rec --43
    from   titulo_receber_trib d,
           titulo_receber_trib_baixa c,
           titulo_receber            b,
           titulo_receber_liq        a
    where  c.nr_titulo = doc_p.nr_documento
    and    c.nr_sequencia = doc_p.nr_seq_doc_compl
    --and    c.nr_seq_tit_trib = doc_p.nr_doc_analitico
    and    a.nr_titulo = b.nr_titulo
    and    a.nr_titulo = c.nr_titulo
    and    a.nr_titulo = d.nr_titulo
    and    c.nr_seq_tit_trib = d.nr_sequencia
    and    a.nr_sequencia = c.nr_seq_tit_liq
    and    coalesce(a.ie_lib_caixa,'S') = 'S'
    and    (c.nr_seq_trans_financ IS NOT NULL AND c.nr_seq_trans_financ::text <> '')
    and    ((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento));
    end;

elsif (doc_p.nm_tabela = 'TITULO_RECEBER_TRIB' and doc_p.nm_atributo = 'VL_TRIB_RETIDO') then
    begin
    ie_union_w := 28;
    select coalesce(c.dt_tributo,c.dt_contabil), --8
           b.ds_observacao_titulo, --16
           c.cd_tributo, --31
           b.ie_origem_titulo, --32
           b.cd_estabelecimento, --41
           b.nr_seq_proj_rec --43
    into STRICT   dt_contabil_tit_w, --8
           ds_observacao_titulo_w, --16
           dados_contab_w.cd_tributo_regra, --31
           dados_contab_w.ie_origem_tit_rec, --32
           cd_estab_movimento_w, --41
           dados_contab_w.nr_seq_proj_rec --43
    from   titulo_receber_trib c,
           titulo_receber      b
    where  c.nr_titulo = doc_p.nr_documento
    and    c.nr_sequencia = doc_p.nr_seq_doc_compl
    and    b.nr_titulo = c.nr_titulo
    and    coalesce(c.nr_seq_nota_fiscal::text, '') = ''
    and    ((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento));
    end;
end if;

ds_estorno_w := '';

if (coalesce(ie_estorno_w,'S') = 'S') then
    begin
    ds_estorno_w := wheb_mensagem_pck.get_texto(728461);
    end;
end if;

dados_contab_w.ie_tipo_conta_glosa := 'G';
nm_paciente_adiant_w               := null;
ds_obs_adiantamento_w              := null;
nr_recibo_adiant_w                 := null;
ds_obs_convenio_receb_w            := null;

if (coalesce(nr_seq_movto_trans_fin_w,0) <> 0) then
    begin
    select nr_seq_caixa,
           nr_seq_caixa_od,
           nr_sequencia
    into STRICT   dados_contab_w.nr_seq_caixa,
           dados_contab_w.nr_seq_caixa_od,
           nr_seq_trans_financ_w
    from   movto_trans_financ
    where  nr_sequencia = nr_seq_movto_trans_fin_w;
    exception
        when others then
        dados_contab_w.nr_seq_caixa    := null;
        dados_contab_w.nr_seq_caixa_od := null;
        nr_seq_trans_financ_w          := null;
    end;
end if;

/* Francisco - OS 51027 - 22/02/07 - Gerar movimentos com a data real */

if (coalesce(ctb_param_lote_contas_rec_w.ie_dt_contab_cr,'L') = 'T') then
    dados_contab_w.dt_transacao := dt_contabil_tit_w;
end if;

nr_negociacao_w := '';
if (coalesce(nr_seq_baixa_w,0) <> 0) and (dados_contab_w.nr_titulo_receber <> 0) then
    nr_negociacao_w := substr(obter_numero_negociacao_hist(dados_contab_w.nr_titulo_receber,nr_seq_baixa_w,null),1,20);
end if;

if (doc_p.nm_atributo = 'VL_GLOSA' and ctb_param_lote_contas_rec_w.ie_dt_contab_glosa = 'F') then
    begin
    select  dt_fechamento
    into STRICT    dados_contab_w.dt_transacao
    from    convenio_retorno
    where   nr_sequencia = nr_seq_retorno_w;
    exception
        when others then
            null;
    end;
end if;

dados_contab_w.cd_cnpj     := '';
dados_contab_w.cd_convenio := 0;

begin
select a.cd_cgc,
       nr_interno_conta,
       nr_seq_protocolo,
       substr(obter_nome_pf_pj(cd_pessoa_fisica,cd_cgc),1,80),
       a.nr_nota_fiscal,
       a.nr_documento,
       substr(obter_nota_conta_protocolo(a.nr_seq_protocolo,0),1,20),
       substr(obter_nota_conta_protocolo(0,a.nr_interno_conta),1,20),
       a.cd_pessoa_fisica,
       obter_dados_titulo_receber(a.nr_titulo,'NE'),
       substr(obter_nome_pf_pj(null,cd_cgc),1,80),
       a.cd_estabelecimento,
       a.nr_seq_nf_saida,
       a.nr_seq_proj_rec		
into STRICT   dados_contab_w.cd_cnpj,
       nr_interno_conta_w,
       nr_seq_protocolo_w,
       ds_devedor_w,
       dados_contab_w.nr_seq_nota_fiscal,
       nr_doc_titulo_w,
       nr_nota_protocolo_w,
       nr_nota_conta_w,
       dados_contab_w.cd_pessoa_fisica,
       nr_nfe_imp_w,
       ds_devedor_pj_w,
       cd_estab_titulo_w,
       nr_seq_nf_saida_w,
       dados_contab_w.nr_seq_proj_rec						
from   titulo_Receber a
where  nr_titulo = dados_contab_w.nr_titulo_receber;
exception
    when others then
        null;
end;

begin
select nr_bordero
into STRICT   nr_bordero_rec_w
from   titulo_receber_liq
where  nr_titulo = dados_contab_w.nr_titulo_receber
and    nr_sequencia = nr_seq_baixa_w;
exception
    when others then
    nr_bordero_rec_w := 0;
end;

begin
select initCap(substr(Obter_desc_mes_ano(dt_mesano_referencia,'A'),1,20)), --Anderson 28/05/2007 - OS58297
       substr(obter_desc_mes_ano(dt_mesano_referencia,'AB'),1,20),
       dt_mesano_referencia
into STRICT   ds_mesano_referencia_prot_w,
       ds_mesano_referencia_abrev_w,
       dt_mesano_referencia_prot_w
from   protocolo_convenio
where  nr_seq_protocolo = nr_seq_protocolo_w
and    cd_estabelecimento = doc_p.cd_estabelecimento;
exception
    when others then
    ds_mesano_referencia_prot_w  := null;
    ds_mesano_referencia_abrev_w := null;
    dt_mesano_referencia_prot_w  := null;
end;

nr_atendimento_w := null;

if (coalesce(nr_interno_conta_w,0) > 0) then
    begin
    select CASE WHEN ctb_param_lote_contas_rec_w.ie_contab_pj_convenio='N' THEN dados_contab_w.cd_cnpj  ELSE cd_cgc END ,
           b.cd_convenio,
           nr_atendimento,
           substr(Obter_desc_mes_ano(dt_mesano_referencia,'ANO'),1,20)
    into STRICT   dados_contab_w.cd_cnpj,
           dados_contab_w.cd_convenio,
           nr_atendimento_w,
           ds_ano_conta_paciente_w
    from   convenio       b,
           conta_paciente a
    where  a.nr_interno_conta = nr_interno_conta_w
    and    a.cd_convenio_parametro = b.cd_convenio;
    end;
elsif (coalesce(nr_seq_protocolo_w,0) > 0) then
    begin
    select CASE WHEN ctb_param_lote_contas_rec_w.ie_contab_pj_convenio='N' THEN dados_contab_w.cd_cnpj  ELSE cd_cgc END ,
           b.cd_convenio
    into STRICT   dados_contab_w.cd_cnpj,
           dados_contab_w.cd_convenio
    from   convenio           b,
           protocolo_convenio a
    where  a.nr_seq_protocolo = nr_seq_protocolo_w
    and    a.cd_convenio = b.cd_convenio;
    end;
end if;

if (coalesce(dados_contab_w.cd_convenio,0) = 0 and coalesce(nr_seq_retorno_w,0) <> 0) then
    begin
    select cd_convenio
    into STRICT   dados_contab_w.cd_convenio
    from   convenio_retorno
    where  nr_sequencia = nr_seq_retorno_w;
    exception
        when others then
        dados_contab_w.cd_convenio := 0;
    end;
end if;

if (coalesce(dados_contab_w.cd_convenio,0) <> 0) then
    begin
        select ds_convenio
        into STRICT   ds_convenio_w
        from   convenio
        where  cd_convenio = dados_contab_w.cd_convenio;
    exception
        when others then
            ds_convenio_w := '';
    end;
end if;

if (ie_union_w in (24,25,26)) then
    dados_contab_w.nr_seq_agrupamento := nr_seq_movto_cartao_cr_w;

    if (nm_agrupador_w = 'DS_MESANO') then
        dados_contab_w.nr_seq_agrupamento := dt_referencia_mesano_w;
    end if;
else
    if (nm_agrupador_w = 'NR_SEQ_MOVTO_TRANS_FIN') then
        dados_contab_w.nr_seq_agrupamento := nr_seq_movto_trans_fin_w;
    elsif (nm_agrupador_w = 'NR_TITULO') then
        dados_contab_w.nr_seq_agrupamento := dados_contab_w.nr_titulo_receber;
    elsif (nm_agrupador_w = 'NR_BORDERO') then
        dados_contab_w.nr_seq_agrupamento := nr_bordero_rec_w;
    elsif (nm_agrupador_w = 'DS_MESANO') then
        dados_contab_w.nr_seq_agrupamento := dt_referencia_mesano_w;
    elsif (nm_agrupador_w = 'NR_AUTORIZACAO') then
        dados_contab_w.nr_seq_agrupamento := somente_numero(nr_autorizacao_w);
    end if;
end if;

if (coalesce(dados_contab_w.nr_seq_agrupamento,0) = 0) and (ie_union_w not in (24,25,26)) then
    dados_contab_w.nr_seq_agrupamento := dados_contab_w.nr_titulo_receber;
elsif (coalesce(dados_contab_w.nr_seq_agrupamento,0) = 0) and (ie_union_w in (24,25,26)) then
    dados_contab_w.nr_seq_agrupamento := nr_seq_movto_cartao_cr_w;
end if;

if (coalesce(nr_seq_ret_item_w,0) <> 0) then
    select max(nr_seq_receb)
    into STRICT   nr_seq_receb_w
    from   convenio_ret_receb
    where  nr_seq_retorno = nr_seq_retorno_w;

    ds_recebimentos_w := substr(obter_retorno_receb_dados(nr_seq_retorno_w,1),1,100);

    select max(ds_observacao)
    into STRICT   ds_obs_convenio_receb_w
    from   convenio_receb
    where  nr_sequencia = nr_seq_receb_w;

    select max(ds_motivo_glosa)
    into STRICT   ds_motivo_glosa_w
    from   motivo_glosa          m,
           convenio_retorno_item c
    where  m.cd_motivo_glosa = c.cd_motivo_glosa
    and    c.nr_sequencia = nr_seq_ret_item_w;
end if;

if (nr_adiantamento_w = 0) then
    nr_adiantamento_w := null;
end if;

select max(a.nr_seq_movto_pend)
into STRICT   nr_seq_movto_bco_pend_w
from   movto_banco_pend_baixa a
where  a.nr_titulo = dados_contab_w.nr_titulo_receber
and    a.nr_seq_baixa = nr_seq_baixa_w;

if (coalesce(nr_seq_movto_bco_pend_w::text, '') = '') then
    begin
    if (coalesce(nr_bordero_rec_w,
            0) <> 0) then
        select max(a.nr_seq_movto_pend)
        into STRICT   nr_seq_movto_bco_pend_w
        from   movto_banco_pend_baixa a
        where  a.nr_bordero_rec = nr_bordero_rec_w;
    end if;

        if (coalesce(nr_seq_movto_bco_pend_w::text, '') = '') then
            begin
            select max(a.nr_seq_movto_pend)
            into STRICT   nr_seq_movto_bco_pend_w
            from   movto_banco_pend_baixa a
            where  a.nr_seq_conv_receb = nr_seq_receb_w;
            end;
        end if;
    end;
end if;

if (coalesce(nr_seq_movto_cartao_cr_w,0) <> 0) then
    select substr(obter_desc_bandeira_cartao(a.nr_seq_bandeira),1,200) ds_bandeira,
           substr(obter_nome_pf_pj(a.cd_pessoa_fisica,a.cd_cgc),1,80) ds_pessoa_rec,
           a.ds_comprovante,
           a.nr_seq_bandeira,
           a.cd_estabelecimento
    into STRICT   ds_bandeira_cartao_w,
           ds_pessoa_rec_cartao_w,
           ds_comprovante_cartao_w,
           dados_contab_w.nr_seq_bandeira,
           dados_contab_w.cd_estab_inf_movto
    from   movto_cartao_cr a
    where  a.nr_sequencia = nr_seq_movto_cartao_cr_w;

    nm_pessoa_caixa_rec_w := substr(obter_dados_cartao_cr(nr_seq_movto_cartao_cr_w,'PR'),1,255);
end if;

if (doc_p.nm_atributo = 'VL_NOTA_CREDITO') then
    ds_nota_credito_w := substr(obter_nota_credito_tit_rec(dados_contab_w.nr_titulo_receber),1,255);
end if;

begin
    select nm_fantasia_estab
    into STRICT   nm_fantasia_estab_tit_w
    from   estabelecimento
    where  cd_estabelecimento = cd_estab_titulo_w;
exception
    when others then
        nm_fantasia_estab_tit_w := null;
end;

if (doc_p.nm_atributo = 'VL_GLOSA_DETALHE') and (coalesce(nr_seq_propaci_partic_w,0) <> 0) then
    begin
        select a.cd_cgc,
               a.cd_pessoa_fisica
        into STRICT   dados_contab_w.cd_cnpj,
               dados_contab_w.cd_pessoa_fisica
        from   procedimento_participante a
        where  nr_sequencia = nr_seq_propaci_partic_w;
    exception
        when others then
            dados_contab_w.cd_cnpj          := null;
            dados_contab_w.cd_pessoa_fisica := null;
    end;
end if;

if (coalesce(nr_seq_trans_financ_w,0) > 0) then
    select max(nr_sequencia)
    into STRICT   nr_seq_movto_pend_w
    from   movto_banco_pend
    where  nr_seq_movto_trans_fin = nr_seq_trans_financ_w;
end if;

if (coalesce(dados_contab_w.nr_seq_conta_banco,0) > 0) and (coalesce(nr_seq_cob_escritural_w::text, '') = '') then
    select max(nr_sequencia)
    into STRICT   nr_seq_cob_escritural_w
    from   cobranca_escritural
    where  nr_seq_conta_banco = dados_contab_w.nr_seq_conta_banco
    and    nr_titulo = dados_contab_w.nr_titulo_receber;
end if;

select coalesce(max(nr_sequencia),0)
into STRICT   nr_seq_perda_conta_rec_w
from   perda_contas_receber
where  nr_titulo = dados_contab_w.nr_titulo_receber
and    nr_seq_baixa = nr_seq_titulo_rec_liq_w;

select coalesce(max(b.nr_seq_nota_fiscal),null)
into STRICT   dados_contab_w.nr_seq_nota_fiscal
from   titulo_pagar_baixa a,
       titulo_pagar       b
where  a.nr_titulo = b.nr_titulo
and    a.nr_tit_receber = dados_contab_w.nr_titulo_receber;

if (coalesce(dados_contab_w.nr_seq_nota_fiscal,0) <> 0) then
    nr_nota_tit_abatimento_w := substr(obter_dados_nota_fiscal(dados_contab_w.nr_seq_nota_fiscal,0),1,255);
end if;

if (dados_contab_w.nr_titulo_receber IS NOT NULL AND dados_contab_w.nr_titulo_receber::text <> '') and (nr_seq_titulo_rec_liq_w IS NOT NULL AND nr_seq_titulo_rec_liq_w::text <> '') then
    nr_seq_extrato_w := substr(obter_extrato_tit_rec(dados_contab_w.nr_titulo_receber,nr_seq_titulo_rec_liq_w),1,255);
end if;

---------------Abatimento titulo pagar - titulo receber
begin
    select coalesce(max(b.nr_nota_fiscal),null)
    into STRICT   nr_nota_tit_receber_abat_w
    from   titulo_receber_liq a,
           titulo_receber     b
    where  a.nr_titulo = b.nr_titulo
    and    a.nr_titulo = dados_contab_w.nr_titulo_receber;
exception
    when others then
        nr_nota_tit_receber_abat_w := '';
end;

if (coalesce(nr_adiantamento_w,0) <> 0) then
    begin
        select substr(obter_nome_pf_pj(cd_pessoa_fisica,cd_cgc),1,255),
               substr(ds_observacao,1,255),
               nr_recibo
        into STRICT   nm_paciente_adiant_w,
               ds_obs_adiantamento_w,
               nr_recibo_adiant_w
        from   adiantamento
        where  nr_adiantamento = nr_adiantamento_w;
    exception
        when others then
            nm_paciente_adiant_w  := null;
            ds_obs_adiantamento_w := null;
            nr_recibo_adiant_w    := null;
    end;
end if;

begin
       select a.nr_sequencia,
              a.nr_nota_fiscal,
              a.cd_serie_nf,
              a.nr_nfe_imp
       into STRICT nr_seq_nota_orig_w,
              nr_nota_orig_w,
              cd_serie_nf_orig_w,
              nr_nfe_imp_orig_w
       from nota_fiscal a,
              nf_credito b,
              titulo_receber c
       where a.nr_sequencia = b.nr_seq_nf_orig
       and b.nr_seq_nf_gerada = c.nr_seq_nf_saida
       and c.nr_seq_nf_saida = nr_seq_nf_saida_w;
exception
       when no_data_found then
              nr_seq_nota_orig_w := null;
              nr_nfe_imp_orig_w := null;
              cd_serie_nf_orig_w := null;
              nr_nota_orig_w := null;
       when too_many_rows then
              nr_seq_nota_orig_w := null;
              nr_nfe_imp_orig_w := null;
              cd_serie_nf_orig_w := null;
              nr_nota_orig_w := null;
end;

-- complemento de pago --
begin
        select coalesce((select max(nr_sequencia) from nota_fiscal_item where nr_titulo = dados_contab_w.nr_titulo_receber),null) nr_sequencia,
                coalesce((select max(nr_nota_fiscal) from nota_fiscal_item where nr_titulo = dados_contab_w.nr_titulo_receber),null) nr_nota_fiscal,
                coalesce((select max(cd_serie_nf) from nota_fiscal_item where nr_titulo = dados_contab_w.nr_titulo_receber),null) cd_serie_nf, 
                coalesce((select max(nr_nfe_imp) from nota_fiscal_item where nr_titulo = dados_contab_w.nr_titulo_receber),null) nr_nfe_imp,
                a.nr_sequencia,
                a.nr_nota_fiscal,
                a.cd_serie_nf,
                a.nr_nfe_imp
        into STRICT nr_seq_nota_comp_w,
                nr_nota_comp_w,
                cd_serie_nf_comp_w,
                nr_nfe_imp_comp_w,
                nr_seq_nota_no_w,
                nr_nota_no_w,
                cd_serie_nf_no_w,
                nr_nfe_imp_no_w                        
        from nota_fiscal          a, 
                titulo_receber       b
        where a.nr_sequencia = b.nr_seq_nf_saida
        and (b.nr_seq_nf_saida IS NOT NULL AND b.nr_seq_nf_saida::text <> '')
        and b.nr_titulo = dados_contab_w.nr_titulo_receber;
exception
       when no_data_found then
              nr_seq_nota_comp_w := null;
              nr_nota_comp_w     := null;
              cd_serie_nf_comp_w := null;
              nr_nfe_imp_comp_w  := null;
              nr_seq_nota_no_w   := null;
              nr_nota_no_w       := null;
              cd_serie_nf_no_w   := null;
              nr_nfe_imp_no_w    := null;
       when too_many_rows then
              nr_seq_nota_comp_w := null;
              nr_nota_comp_w     := null;
              cd_serie_nf_comp_w := null;
              nr_nfe_imp_comp_w  := null;
              nr_seq_nota_no_w   := null;
              nr_nota_no_w       := null;
              cd_serie_nf_no_w   := null;
              nr_nfe_imp_no_w    := null;
end;

CALL ctb_online_pck.definir_atrib_compl(doc_p.cd_tipo_lote_contabil);
CALL ctb_online_pck.set_value_compl_hist('CD_CGC',dados_contab_w.cd_cnpj);
CALL ctb_online_pck.set_value_compl_hist('NR_DOCUMENTO',nr_doc_titulo_w);
CALL ctb_online_pck.set_value_compl_hist('NR_INTERNO_CONTA',nr_interno_conta_w);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_PROTOCOLO',nr_seq_protocolo_w);
CALL ctb_online_pck.set_value_compl_hist('DS_DEVEDOR',ds_devedor_w);
CALL ctb_online_pck.set_value_compl_hist('NR_NOTA_FISCAL',nr_nota_fiscal_w);
CALL ctb_online_pck.set_value_compl_hist('CD_CONVENIO',dados_contab_w.cd_convenio);
CALL ctb_online_pck.set_value_compl_hist('NR_ATENDIMENTO',nr_atendimento_w);
CALL ctb_online_pck.set_value_compl_hist('NR_NF_CONTA',nr_nota_conta_w);
CALL ctb_online_pck.set_value_compl_hist('NR_NF_PROTOCOLO',nr_nota_protocolo_w);
CALL ctb_online_pck.set_value_compl_hist('NR_TITULO',dados_contab_w.nr_titulo_receber);
CALL ctb_online_pck.set_value_compl_hist('DS_MESANO_REFERENCIA_PROT',ds_mesano_referencia_prot_w);
CALL ctb_online_pck.set_value_compl_hist('DS_MESANO_REFERENCIA_ABREV',ds_mesano_referencia_abrev_w);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_RETORNO',nr_seq_retorno_w);
CALL ctb_online_pck.set_value_compl_hist('NR_NFE',nr_nfe_imp_w);
CALL ctb_online_pck.set_value_compl_hist('DS_DEVEDOR_PJ',ds_devedor_pj_w);
CALL ctb_online_pck.set_value_compl_hist('DS_OBSERVACAO_TITULO',ds_observacao_titulo_w);
CALL ctb_online_pck.set_value_compl_hist('DT_RECEBIMENTO',to_char(doc_p.dt_competencia,'dd/mm/yyyy'));
CALL ctb_online_pck.set_value_compl_hist('DS_COMPROVANTE',ds_comprovante_w);
CALL ctb_online_pck.set_value_compl_hist('NR_AUTORIZACAO',nr_autorizacao_w);
CALL ctb_online_pck.set_value_compl_hist('DS_OBS_CONVENIO_RECEB',ds_obs_convenio_receb_w);
CALL ctb_online_pck.set_value_compl_hist('DS_CONVENIO',ds_convenio_w);
CALL ctb_online_pck.set_value_compl_hist('DT_MESANO_REFERENCIA_PROT',dt_mesano_referencia_prot_w);
CALL ctb_online_pck.set_value_compl_hist('DS_OBSERVACAO_LIQ',ds_observacao_liq_w);
CALL ctb_online_pck.set_value_compl_hist('NR_ADIANTAMENTO',nr_adiantamento_w);
CALL ctb_online_pck.set_value_compl_hist('DS_BANDEIRA_CARTAO',ds_bandeira_cartao_w);
CALL ctb_online_pck.set_value_compl_hist('DS_PESSOA_REC_CARTAO',ds_pessoa_rec_cartao_w);
CALL ctb_online_pck.set_value_compl_hist('DS_COMPROVANTE_CARTAO',ds_comprovante_cartao_w);
CALL ctb_online_pck.set_value_compl_hist('DS_NOTA_CREDITO',ds_nota_credito_w);
CALL ctb_online_pck.set_value_compl_hist('NR_BORDERO_REC',nr_bordero_rec_w);
CALL ctb_online_pck.set_value_compl_hist('NM_PESSOA_CAIXA_REC',nm_pessoa_caixa_rec_w);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_RECEB',nr_seq_receb_w);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_NOTA_CREDITO',nr_seq_nota_credito_w);
CALL ctb_online_pck.set_value_compl_hist('DS_RECEBIMENTOS',ds_recebimentos_w);
CALL ctb_online_pck.set_value_compl_hist('CD_ESTABELECIMENTO',cd_estab_titulo_w);
CALL ctb_online_pck.set_value_compl_hist('NM_FANTASIA_ESTAB',nm_fantasia_estab_tit_w);
CALL ctb_online_pck.set_value_compl_hist('DS_MOTIVO_GLOSA',ds_motivo_glosa_w);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_MOVTO_BCO_PEND',nr_seq_movto_bco_pend_w);
CALL ctb_online_pck.set_value_compl_hist('DS_OBS_MOVTO_CARTAO_BAIXA',ds_obs_movto_cartao_baixa_w);
CALL ctb_online_pck.set_value_compl_hist('DS_ANO_CONTA_PACIENTE',ds_ano_conta_paciente_w);
CALL ctb_online_pck.set_value_compl_hist('NR_NEGOCIACAO',nr_negociacao_w);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_MOVTO_PEND',nr_seq_movto_pend_w);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_COB_ESCRITURAL',nr_seq_cob_escritural_w);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_PERDA',nr_seq_perda_conta_rec_w);
CALL ctb_online_pck.set_value_compl_hist('NR_NOTA_TIT_ABATIMENTO',nr_nota_tit_abatimento_w);
CALL ctb_online_pck.set_value_compl_hist('NR_NOTA_TIT_RECEBER_ABAT',nr_nota_tit_receber_abat_w);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_EXTRATO',nr_seq_extrato_w);
CALL ctb_online_pck.set_value_compl_hist('NM_PACIENTE_ADIANT',nm_paciente_adiant_w);
CALL ctb_online_pck.set_value_compl_hist('DS_OBS_ADIANTAMENTO',ds_obs_adiantamento_w);
CALL ctb_online_pck.set_value_compl_hist('NR_RECIBO_ADIANT',nr_recibo_adiant_w);
CALL ctb_online_pck.set_value_compl_hist('DS_ESTORNO',ds_estorno_w);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_NOTA_ORIG',nr_seq_nota_orig_w);
CALL ctb_online_pck.set_value_compl_hist('NR_NOTA_ORIG',nr_nota_orig_w);
CALL ctb_online_pck.set_value_compl_hist('CD_SERIE_NF_ORIG',cd_serie_nf_orig_w);
CALL ctb_online_pck.set_value_compl_hist('NR_NFE_IMP_ORIG',nr_nfe_imp_orig_w);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_NOTA_COMP',nr_seq_nota_comp_w);
CALL ctb_online_pck.set_value_compl_hist('NR_NOTA_COMP',nr_nota_comp_w);
CALL ctb_online_pck.set_value_compl_hist('CD_SERIE_NF_COMP',cd_serie_nf_comp_w);
CALL ctb_online_pck.set_value_compl_hist('NR_NFE_IMP_COMP',nr_nfe_imp_comp_w);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_NOTA_NO',nr_seq_nota_no_w);
CALL ctb_online_pck.set_value_compl_hist('NR_NOTA_NO',nr_nota_no_w);
CALL ctb_online_pck.set_value_compl_hist('CD_SERIE_NF_NO',cd_serie_nf_no_w);
CALL ctb_online_pck.set_value_compl_hist('NR_NFE_IMP_NO',nr_nfe_imp_no_w);

if (coalesce(dados_contab_w.cd_cnpj, '0') <> '0') then
    ie_intercompany_w := holding_pck.get_se_intercompany_cnpj(
        cd_estabelecimento_p => doc_p.cd_estabelecimento, cd_cgc_emitente_p => dados_contab_w.cd_cnpj);
end if;

if (ie_intercompany_w = 'S') then
    CALL ctb_online_pck.set_value_compl_hist(
        nm_atributo_p => 'CD_ESTAB_INTERCOMPANY_ORI', ds_valor_p => cd_estab_titulo_w);
    CALL ctb_online_pck.set_value_compl_hist(
        nm_atributo_p => 'DS_ESTAB_INTERCOMPANY_ORI', ds_valor_p => nm_fantasia_estab_tit_w);
    CALL ctb_online_pck.set_value_compl_hist(
        nm_atributo_p => 'CD_ESTAB_INTERCOMPANY_DES', ds_valor_p => doc_p.cd_estabelecimento);
    CALL ctb_online_pck.set_value_compl_hist(
        nm_atributo_p => 'DS_ESTAB_INTERCOMPANY_DES',
        ds_valor_p => substr(obter_nome_estabelecimento(doc_p.cd_estabelecimento),1,80));

    begin
        select cd_interno
        into STRICT cd_interno_intercompany_ori_w
        from estabelecimento
        where cd_estabelecimento = cd_estab_titulo_w
        and cd_empresa = obter_empresa_estab(cd_estab_titulo_w);
    exception
        when no_data_found then
            cd_interno_intercompany_ori_w := null;
        when too_many_rows then
            cd_interno_intercompany_ori_w := null;
        when others then
            cd_interno_intercompany_ori_w := null;
    end;

    begin
        select cd_interno
        into STRICT cd_interno_intercompany_des_w
        from estabelecimento
        where cd_estabelecimento = doc_p.cd_estabelecimento
        and cd_empresa = obter_empresa_estab(doc_p.cd_estabelecimento);
    exception
        when no_data_found then
            cd_interno_intercompany_des_w := null;
        when too_many_rows then
            cd_interno_intercompany_des_w := null;
        when others then
            cd_interno_intercompany_des_w := null;
    end;

    CALL ctb_online_pck.set_value_compl_hist(
        nm_atributo_p => 'CD_INTERNO_INTERCOMPANY_ORI', ds_valor_p => cd_interno_intercompany_ori_w);
    CALL ctb_online_pck.set_value_compl_hist(
        nm_atributo_p => 'CD_INTERNO_INTERCOMPANY_DES', ds_valor_p => cd_interno_intercompany_des_w);
else
    CALL ctb_online_pck.set_value_compl_hist(
        nm_atributo_p => 'CD_ESTAB_INTERCOMPANY_ORI', ds_valor_p => null);
    CALL ctb_online_pck.set_value_compl_hist(
        nm_atributo_p => 'DS_ESTAB_INTERCOMPANY_ORI', ds_valor_p => null);
    CALL ctb_online_pck.set_value_compl_hist(
        nm_atributo_p => 'CD_ESTAB_INTERCOMPANY_DES', ds_valor_p => null);
    CALL ctb_online_pck.set_value_compl_hist(
        nm_atributo_p => 'DS_ESTAB_INTERCOMPANY_DES', ds_valor_p => null);
    CALL ctb_online_pck.set_value_compl_hist(
        nm_atributo_p => 'CD_INTERNO_INTERCOMPANY_ORI', ds_valor_p => null);
    CALL ctb_online_pck.set_value_compl_hist(
        nm_atributo_p => 'CD_INTERNO_INTERCOMPANY_DES', ds_valor_p => null);
end if;

if (dados_contab_w.nr_seq_nota_fiscal = '0') then
    dados_contab_w.nr_seq_nota_fiscal := null;
end if;

ds_atributos_w := 'NR_SEQ_NOTA_FISCAL=' || nr_seq_nf_saida_w || ';' ||
                  'NR_NOTA_FISCAL=' || dados_contab_w.nr_seq_nota_fiscal || ';' ||
                  'NR_TITULO_RECEBER=' || dados_contab_w.nr_titulo_receber || ';' ||
                  'NR_NFE_IMP=' || nr_nfe_imp_w;

ctb_obter_doc_movto(doc_p.cd_tipo_lote_contabil,
                    doc_p.nm_atributo,
                    'VR',
                    doc_p.dt_competencia,
                    null,
                    null,
                    ds_atributos_w,
                    nm_usuario_p,
                    ie_regra_w,
                    dados_contab_w.nr_doc_movto,
                    dados_contab_w.ie_origem_documento);

if (ie_permite_estab_dif_w <> 'PCCT') then
    cd_estab_titulo_w    := null;
    cd_estab_movimento_w := null;
end if;

if (coalesce(nr_seq_baixa_w,0) <> 0) and (coalesce(dados_contab_w.nr_titulo_receber,0) <> 0) then
    begin
    select count(*),
           coalesce(max(r.dt_pagamento_previsto),clock_timestamp())
    into STRICT   qt_registros_w,
           dt_perda_w
    from   titulo_receber_liq l,
           titulo_receber     r,
           tipo_recebimento   t
    where  r.nr_titulo = l.nr_titulo
    and    l.cd_tipo_recebimento = t.cd_tipo_recebimento
    and    l.nr_sequencia = nr_seq_baixa_w
    and    l.nr_titulo = dados_contab_w.nr_titulo_receber
    and    t.ie_tipo_consistencia = 9;
    exception
        when others then
        qt_registros_w := 0;
        dt_perda_w     := null;
    end;

    if (qt_registros_w > 0) then
        dados_contab_w.cd_conta_contabil := coalesce(obter_conta_contab_tempo_perda(dados_contab_w.dt_transacao,dados_contab_w.dt_transacao - dt_perda_w),dados_contab_w.cd_conta_contabil);
    end if;
end if;

if (dados_contab_w.nr_titulo_receber <> 0 AND nr_seq_baixa_w <> 0) then
    select cd_tipo_recebimento
    into STRICT   dados_contab_w.cd_tipo_recebimento
    from   titulo_receber_liq
    where  nr_titulo = dados_contab_w.nr_titulo_receber
    and    nr_sequencia = nr_seq_baixa_w;
end if;

if (doc_p.nm_atributo = 'VL_GLOSA_CRIT_REPASSE') then
    select max(q.cd_cgc),
           null
    into STRICT   dados_contab_w.cd_cnpj,
           dados_contab_w.cd_pessoa_fisica
    from   convenio_retorno_glosa g,
           convenio_retorno_item  i,
           procedimento_repasse   pr,
           terceiro               q
    where  i.nr_sequencia = g.nr_seq_ret_item
    and    g.nr_seq_propaci = pr.nr_seq_procedimento
    and    q.nr_sequencia = pr.nr_seq_terceiro
    and    i.nr_titulo = dados_contab_w.nr_titulo_receber;

    if (coalesce(dados_contab_w.cd_cnpj::text, '') = '') then
        select null,
               max(q.cd_pessoa_fisica)
        into STRICT   dados_contab_w.cd_cnpj,
               dados_contab_w.cd_pessoa_fisica
        from   convenio_retorno_glosa g,
               convenio_retorno_item  i,
               procedimento_repasse   pr,
               terceiro               q
        where  i.nr_sequencia = g.nr_seq_ret_item
        and    g.nr_seq_propaci = pr.nr_seq_procedimento
        and    q.nr_sequencia = pr.nr_seq_terceiro
        and    i.nr_titulo = dados_contab_w.nr_titulo_receber;
    end if;
elsif (doc_p.nm_atributo = 'VL_DESCONTOS') and (dados_contab_w.ie_origem_tit_rec = 3) then

    select max(a.ie_segmentacao)
    into STRICT   ie_segmentacao_w
    from   pls_plano                a,
           pls_segurado             b,
           pls_mensalidade_segurado c,
           pls_mensalidade          d,
           titulo_receber           e
    where  a.nr_sequencia = b.nr_seq_plano
    and    b.nr_sequencia = c.nr_seq_segurado
    and    d.nr_sequencia = c.nr_seq_mensalidade
    and    d.nr_sequencia = e.nr_seq_mensalidade
    and    e.nr_titulo = dados_contab_w.nr_titulo_receber;

    select max(c.cd_conta_contabil)
    into STRICT   cd_conta_codificacao_w
    from   pls_contab_versao       a,
           pls_contab_codificacao  b,
           pls_contab_codific_item c
    where  a.nr_sequencia = b.nr_seq_versao_contab
    and    b.nr_sequencia = c.nr_seq_codificacao
    and    b.ie_codificacao = 'PO'
    and    c.ie_tipo_produto = CASE WHEN ie_segmentacao_w='4' THEN 'OD'  ELSE 'PS' END
    and    dados_contab_w.dt_transacao between a.dt_inicio_vigencia and coalesce(a.dt_fim_vigencia,dados_contab_w.dt_transacao);

    select count(*)
    into STRICT   qt_conta_contabil_w
    from   conta_contabil
    where  cd_conta_contabil = cd_conta_codificacao_w;

    if (qt_conta_contabil_w > 0) then
        dados_contab_w.cd_conta_contabil := cd_conta_codificacao_w;
    end if;
end if;

dados_contab_w.cd_estab_movto  := coalesce(cd_estab_movimento_w,cd_estab_titulo_w);
dados_contab_w.nm_tabela       := doc_p.nm_tabela;
dados_contab_w.nm_atributo     := doc_p.nm_atributo;
dados_contab_w.nr_seq_tab_orig := doc_p.nr_documento;
dados_contab_w.doc             := doc_p;

-- CONTABILIZA TRANSACAO FINANCEIRA
ctb_contab_onl_lote_fin_pck.contabiliza_trans_financ(dados_contab_w,nm_usuario_p);

if (coalesce(dados_contab_w.doc.nr_Lote_contabil,0) <> 0) then
        begin
            if (doc_p.nm_atributo in ('VL_RECEBIDO', 'VL_DESPESA_BANCARIA', 'VL_GLOSA', 'VL_REC_MAIOR', 'VL_GLOSA_DETALHE', 'VL_PERDAS',
                'VL_NOTA_CREDITO', 'VL_TRIB_TIT_REC', 'VL_REC_PLS', 'VL_OUTROS_ACRESCIMOS', 'VL_REC_ANTECIP', 'VL_DEB_ANTECIP', 'VL_RECURSADO', 
                'VL_BAIXA_SEM_TRIB', 'VL_GLOSA_CRIT_REPASSE', 'VL_GLOSA_CRIT_HOSP', 'VL_RECEBIDO_TOTAL', 'VL_FATURAMENTO_OPS', 'VL_RECEBIDO_ESTRANG',
                'VL_MOEDA_COMPLEMENTAR', 'VL_DESCONTOS', 'VL_JUROS', 'VL_MULTA')) then
                begin
                    update TITULO_RECEBER_LIQ a
                    set a.nr_lote_contabil = dados_contab_w.doc.nr_Lote_contabil
                    where (a.nr_lote_contabil = 0 OR coalesce(a.nr_lote_contabil::text, '') = '')
                    and a.nr_titulo = doc_p.nr_documento
                    and a.nr_sequencia = doc_p.nr_seq_doc_compl;
                end;
            elsif (doc_p.nm_atributo in ('VL_ALTERACAO')) then
                begin
                    update ALTERACAO_VALOR a
                    set a.nr_lote_contabil = dados_contab_w.doc.nr_Lote_contabil
                    where (a.nr_lote_contabil = 0 OR coalesce(a.nr_lote_contabil::text, '') = '')
                    and a.nr_titulo = doc_p.nr_documento
                    and a.nr_sequencia = doc_p.nr_seq_doc_compl;
                end;
            elsif (doc_p.nm_atributo in ('VL_TITULO_RECEBER', 'VL_LIQUIDO_TIT', 'VL_CURTO_PRAZO', 'VL_LONGO_PRAZO')) then
                begin
                    update TITULO_RECEBER a
                    set a.nr_lote_contabil = dados_contab_w.doc.nr_Lote_contabil
                    where (a.nr_lote_contabil = 0 OR coalesce(a.nr_lote_contabil::text, '') = '')
                    and  a.nr_titulo = doc_p.nr_documento;
                end;
            elsif (doc_p.nm_atributo in ('VL_ALTERACAO_PORTADOR', 'VL_TIT_ALT_PORTADOR')) then
                begin
                    update ALTERACAO_PORTADOR a
                    set a.nr_lote_contabil = dados_contab_w.doc.nr_Lote_contabil
                    where (a.nr_lote_contabil = 0 OR coalesce(a.nr_lote_contabil::text, '') = '')
                    and  a.nr_titulo = doc_p.nr_documento
                    and a.nr_sequencia = doc_p.nr_seq_doc_compl;
                end;
            elsif (doc_p.nm_atributo in ('MOVTO_CARTAO_CR_BAIXA', 'VL_DESP_EQUIP_CARTAO_CR', 'VL_DESPESA_CARTAO_CR')) then
                begin
                    update MOVTO_CARTAO_CR_BAIXA a
                    set a.nr_lote_contabil = dados_contab_w.doc.nr_Lote_contabil
                    where (a.nr_lote_contabil = 0 OR coalesce(a.nr_lote_contabil::text, '') = '')
                    and a.nr_sequencia = doc_p.nr_seq_doc_compl;
                end;
            elsif (doc_p.nm_atributo in ('VL_TRIB_RETIDO')) then
                begin
                    update TITULO_RECEBER_TRIB a
                    set a.nr_lote_contabil = dados_contab_w.doc.nr_Lote_contabil
                    where (a.nr_lote_contabil = 0 OR coalesce(a.nr_lote_contabil::text, '') = '')
                    and  a.nr_titulo = doc_p.nr_documento
                    and a.nr_sequencia = doc_p.nr_seq_doc_compl;
                end;
            elsif (doc_p.nm_atributo in ('VL_REC_PLS_MENS')) then
                begin
                    update PLS_TITULO_REC_LIQ_MENS a
                    set a.nr_lote_contabil = dados_contab_w.doc.nr_Lote_contabil
                    where (a.nr_lote_contabil = 0 OR coalesce(a.nr_lote_contabil::text, '') = '')
                    and  a.nr_titulo = doc_p.nr_documento
                    and a.nr_sequencia = doc_p.nr_seq_doc_compl;
                end;
            end if;
        end;
    end if;

if (ie_permite_estab_dif_w = 'PCCT') and (coalesce(cd_estab_titulo_w,0) <> 0) and (dados_contab_w.nr_titulo_receber IS NOT NULL AND dados_contab_w.nr_titulo_receber::text <> '') and (cd_conta_transitoria_w IS NOT NULL AND cd_conta_transitoria_w::text <> '') and (cd_estab_titulo_w <> doc_p.cd_estab_contabil) and (coalesce(dados_contab_w.nr_lote_contabil,0) <> 0) then

    begin
    ctb_movimento_w.nr_lote_contabil    := dados_contab_w.nr_lote_contabil;
    ctb_movimento_w.dt_movimento        := dados_contab_w.dt_transacao;
    ctb_movimento_w.ie_origem_documento := dados_contab_w.ie_origem_documento;
    ctb_movimento_w.nr_seq_agrupamento  := dados_contab_w.nr_seq_agrupamento;
    ctb_movimento_w.vl_movimento        := doc_p.vl_movimento;
    ctb_movimento_w.cd_historico        := ctb_online_pck.get_historico_transit_estab(doc_p.cd_tipo_lote_contabil,doc_p.cd_estabelecimento);
    ctb_movimento_w.nr_documento        := dados_contab_w.nr_doc_movto;
    ctb_movimento_w.nr_seq_proj_rec     := dados_contab_w.nr_seq_proj_rec;
    /*MOVIMENTO TRANSITORIO DEBITO*/

    ctb_movimento_w.cd_estabelecimento := doc_p.cd_estab_contabil;
    ctb_movimento_w.cd_conta_debito    := cd_conta_transitoria_w;
    ctb_movimento_w.cd_conta_credito   := null;
    ctb_movimento_w := ctb_online_pck.ctb_gerar_movto_conta_transit(ctb_movimento_w, nm_usuario_p);

    /*MOVIMENTO TRANSITORIO CREDITO*/

    ctb_movimento_w.cd_estabelecimento := cd_estab_titulo_w;
    ctb_movimento_w.cd_conta_credito   := cd_conta_transitoria_w;
    ctb_movimento_w.cd_conta_debito    := null;
    ctb_movimento_w := ctb_online_pck.ctb_gerar_movto_conta_transit(ctb_movimento_w, nm_usuario_p);
    end;
end if;

doc_p := dados_contab_w.doc;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_contab_onl_contas_receber (doc_p INOUT ctb_documento, nm_usuario_p text) FROM PUBLIC;

