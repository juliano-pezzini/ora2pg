-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_ajuste_desp_baixa_cartao () AS $body$
DECLARE


nr_sequencia_w		bigint;
nr_seq_movto_w		bigint;
vl_despesa_w		double precision;
vl_baixa_w		double precision;

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.nr_seq_movto,
	a.vl_baixa,
	b.vl_despesa
from	movto_cartao_cr_parcela b,
	movto_cartao_cr_baixa a
where	a.nr_seq_parcela	= b.nr_sequencia
and	abs(a.vl_baixa)		= abs(b.vl_liquido)
and	coalesce(a.vl_despesa,0)	= 0;



BEGIN

CALL exec_sql_dinamico('Tasy','create table bkp_movto_cartao_cr_baixa as (select * from movto_cartao_cr_baixa)');

open c01;
loop
fetch c01 into
	nr_sequencia_w,
	nr_seq_movto_w,
	vl_baixa_w,
	vl_despesa_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
		if (vl_baixa_w < 0) then
			vl_despesa_w	:= coalesce(vl_despesa_w,0) * -1;
		end if;

		update	movto_cartao_cr_baixa
		set	vl_despesa	= vl_despesa_w,
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= 'Tasy'
		where	nr_sequencia	= nr_sequencia_w;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_ajuste_desp_baixa_cartao () FROM PUBLIC;

