-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gera_sinal_vital ( nr_atendimento_w text, nm_usuario_p text, dt_sinal_vital_p text, qt_medicao_p text, nr_recem_nato_p bigint default null, ie_integrado_p INOUT text DEFAULT NULL, qt_cetona_p bigint default null, ds_serial_abbott_p text default null, ie_tipo_reagente_p text default 'GLU') AS $body$
DECLARE

 
nr_sequencia_w		bigint;
dt_sinal_vital_w 	timestamp;
cd_pessoa_fisica_w	varchar(50);
ie_utiliza_pressao_inv_w varchar(1) := 'S';
qt_glicemia_w		double precision;
qt_cetona_w			double precision;
IE_GLIC_EXTRAPOL_w	varchar(10);
ie_rn_w			varchar(1)	 := 'N';
nr_recem_nato_w		smallint	:= null;
ie_integrado_w		varchar(2) := 'N';
nm_usuario_w		varchar(255);
qt_user_w			bigint;
cd_profissional_w	varchar(15);


BEGIN 
 
begin 
CALL Alterar_nls_sessao();
 
dt_sinal_vital_w := to_date(dt_sinal_vital_p, 'yyyymmddhh24miss');
 
 
 
if (position('>' in qt_medicao_p)>0) then 
	IE_GLIC_EXTRAPOL_w	:= 'S';
elsif (position('<' in qt_medicao_p)>0) then 
	IE_GLIC_EXTRAPOL_w	:= 'E';
end if;
 
qt_glicemia_w	:= replace(qt_glicemia_w,'.',',');
qt_glicemia_w	:= REPLACE(replace(replace(qt_medicao_p,'<',''),'>',''),'.',',');
qt_cetona_w		:= replace(replace(qt_cetona_p,'<',''),'>','');
 
exception 
	when others then 
	null;
end;
 
 
If (ie_tipo_reagente_p = 'Ketone') then 
 
	if (coalesce(qt_cetona_p::text, '') = '') then 
 
		qt_cetona_w	:= qt_glicemia_w;
 
	end if;
 
	qt_glicemia_w := null;
	IE_GLIC_EXTRAPOL_w := null;
 
 
end if;
 
select	max(cd_pessoa_fisica) 
into STRICT	cd_pessoa_fisica_w 
from	atendimento_paciente 
where	nr_atendimento	= nr_atendimento_w 
and	coalesce(dt_alta::text, '') = '';
 
if (nr_recem_nato_p > 0) and (nr_recem_nato_p IS NOT NULL AND nr_recem_nato_p::text <> '') then 
	ie_rn_w			:= 'S';
	nr_recem_nato_w := nr_recem_nato_p;
end if;
 
 
 
if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then 
 
	nm_usuario_w	:= nm_usuario_p;
	select count(*) 
	into STRICT	qt_user_w 
	from	usuario 
	where	nm_usuario	= nm_usuario_w;
 
	if (qt_user_w = 0) then 
		select	coalesce(max(nm_usuario),nm_usuario_p), 
				max(cd_pessoa_fisica) 
		into STRICT	nm_usuario_w, 
				cd_profissional_w 
		from	usuario 
		where	cd_barras = nm_usuario_p;
	end if;
 
	select	max(nr_sequencia) 
	into STRICT	nr_sequencia_w 
	from	atendimento_sinal_vital 
	where	cd_paciente = cd_pessoa_fisica_w 
	and		nm_usuario	= nm_usuario_w 
	and		dt_sinal_vital	= dt_sinal_vital_w 
	and		nr_atendimento	= nr_atendimento_w 
	and  (((coalesce(nr_recem_nato_w::text, '') = '') and (coalesce(nr_recem_nato::text, '') = '')) or (nr_recem_nato = nr_recem_nato_w));
 
	if (coalesce(nr_sequencia_w::text, '') = '') then 
 
 
 
		select	nextval('atendimento_sinal_vital_seq') 
		into STRICT	nr_sequencia_w 
		;
 
		insert into atendimento_sinal_vital(nr_sequencia, 
			cd_paciente, 
			nr_atendimento, 
			dt_liberacao, 
			dt_sinal_vital, 
			dt_atualizacao, 
			nm_usuario, 
			qt_glicemia_capilar, 
			IE_GLIC_EXTRAPOL, 
			ie_rn, 
			nr_recem_nato, 
			ie_situacao, 
			ie_integracao, 
			cd_pessoa_fisica, 
			qt_cetona, 
			ds_serial_abbott) 
		values (nr_sequencia_w, 
			cd_pessoa_fisica_w, 
			nr_atendimento_w, 
			null, 
			dt_sinal_vital_w, 
			clock_timestamp(), 
			nm_usuario_w, 
			qt_glicemia_w, 
			IE_GLIC_EXTRAPOL_w, 
			ie_rn_w, 
			nr_recem_nato_p, 
			'A', 
			'S', 
			cd_profissional_w, 
			qt_cetona_w, 
			ds_serial_abbott_p);
		CALL Liberar_Sinal_Vital(nr_sequencia_w, 'ATENDIMENTO_SINAL_VITAL', nm_usuario_w);
		ie_integrado_w := 'S';
	else 
		update	atendimento_sinal_vital 
		set		dt_atualizacao = clock_timestamp(), 
				nm_usuario	= nm_usuario_w, 
				qt_glicemia_capilar = qt_glicemia_w, 
				IE_GLIC_EXTRAPOL = IE_GLIC_EXTRAPOL_w, 
				ds_observacao	= 'Reenvio de resultado', 
				qt_cetona = qt_cetona_w, 
				ds_serial_abbott = ds_serial_abbott_p 
		where	nr_sequencia	= nr_sequencia_w;
		ie_integrado_w := 'S';
	end if;
 
	commit;
 
 
else 
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(209916);
end if;
ie_integrado_p 	:= ie_integrado_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gera_sinal_vital ( nr_atendimento_w text, nm_usuario_p text, dt_sinal_vital_p text, qt_medicao_p text, nr_recem_nato_p bigint default null, ie_integrado_p INOUT text DEFAULT NULL, qt_cetona_p bigint default null, ds_serial_abbott_p text default null, ie_tipo_reagente_p text default 'GLU') FROM PUBLIC;

