-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_lib_protocolo_rec_web ( nr_seq_protocolo_rec_p bigint, nm_usuario_p text, ds_retorno_p INOUT text) AS $body$
DECLARE

									 
ds_retorno_w				varchar(4000) := 'OK';
qt_registros_w				bigint;
qt_rec_glosa_tiss_w			bigint;
cd_estabelecimento_w			estabelecimento.cd_estabelecimento%type := wheb_usuario_pck.get_cd_estabelecimento;
ie_processo_analise_recurso_w		pls_parametros_rec_glosa.ie_processo_analise_recurso%type;
nr_seq_prestador_w			pls_rec_glosa_protocolo.nr_seq_prestador%type;

 
C01 CURSOR FOR 
	SELECT	nr_sequencia, 
		nr_seq_conta 
	from	pls_rec_glosa_conta 
	where	nr_seq_protocolo = nr_seq_protocolo_rec_p;
									
BEGIN 
select	count(1) 
into STRICT	qt_registros_w 
from	pls_rec_glosa_conta 
where	nr_seq_protocolo = nr_seq_protocolo_rec_p;
 
 
if (qt_registros_w > 0) then 
 
	select	max(nr_seq_prestador) 
	into STRICT	nr_seq_prestador_w 
	from	pls_rec_glosa_protocolo 
	where	nr_sequencia	= nr_seq_protocolo_rec_p;
	 
	-- Verifica se não tem nenhuma regra de bloqueio para o recurso 
	ds_retorno_w	:= substr(	pls_obter_dados_regra_bloq_in(	nr_seq_prestador_w, 
									null, -- atualmente o evento é um dominio da origem da cta e não possui recurso de glosa 
									'DS', 
									'R', 
									null, 
									nr_seq_protocolo_rec_p, 
									'N', 
									cd_estabelecimento_w), 1, 4000);
	-- se não teve nenhuma mensagem, então não encontrou nenhuma regra 
	if (coalesce(ds_retorno_w::text, '') = '') then 
	 
		-- se não teve regra de bloqueio, volta com o valor padrão "OK" 
		ds_retorno_w := 'OK';
 
		select	coalesce(max(ie_processo_analise_recurso),'PRG') 
		into STRICT	ie_processo_analise_recurso_w 
		from	pls_parametros_rec_glosa 
		where	cd_estabelecimento	= cd_estabelecimento_w;
 
		update	pls_rec_glosa_protocolo 
		set	ie_status		= '2', 
			nm_usuario		= nm_usuario_p, 
			dt_atualizacao		= clock_timestamp(), 
			dt_apresentacao_lote	= clock_timestamp(), 
			dt_competencia_lote	= clock_timestamp(), 
			dt_liberacao_prest	= clock_timestamp() 
		where	nr_sequencia		= nr_seq_protocolo_rec_p;
		 
		-- Gerar análise do recurso de glosa, OPS - Análise de Discussão da Contestação e Recurso de Glosa 
		if (ie_processo_analise_recurso_w = 'ARG') then 
			CALL pls_gerar_lote_analise_rec( nr_seq_protocolo_rec_p, null, cd_estabelecimento_w, nm_usuario_p);
		end if;
		 
		for r_C01_w in C01 loop 
			CALL pls_inserir_item_pag_rec_glosa(r_C01_w.nr_sequencia,nm_usuario_p);
			 
			--Verifica se já existe informação da conta de recurso no monitoramento. 
			select	count(1) 
			into STRICT	qt_rec_glosa_tiss_w 
			from	pls_monitor_tiss_alt 
			where	nr_seq_conta_rec = r_C01_w.nr_sequencia 
			and	ie_tipo_evento = 'FR';
			 
			if (coalesce(qt_rec_glosa_tiss_w,0) = 0) then 
				CALL pls_tiss_gravar_log_monitor(	'FR', r_C01_w.nr_seq_conta, null, 
								null, r_C01_w.nr_sequencia, null, 
								null, null, null, 
								null, null, nm_usuario_p, 
								clock_timestamp());
			end if;	
		end loop;
	end if; -- Fim se não possui regra de bloqueio 
	
else 
	ds_retorno_w := 'SM';
end if;
 
ds_retorno_p := ds_retorno_w;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_lib_protocolo_rec_web ( nr_seq_protocolo_rec_p bigint, nm_usuario_p text, ds_retorno_p INOUT text) FROM PUBLIC;

