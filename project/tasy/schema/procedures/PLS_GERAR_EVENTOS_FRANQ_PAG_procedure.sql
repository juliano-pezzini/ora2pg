-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_eventos_franq_pag ( nr_seq_lote_p pls_lote_pagamento.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


cd_estabelecimento_w	pls_lote_pagamento.cd_estabelecimento%type;
dt_mes_competencia_w	pls_lote_pagamento.dt_mes_competencia%type;
nr_seq_pag_prest_w	pls_pagamento_prestador.nr_sequencia%type;
nr_seq_pag_item_w	pls_pagamento_item.nr_sequencia%type;
vl_pagamento_w		pls_lote_pagamento.vl_lote%type;

c01 CURSOR(	cd_estabelecimento_pc	pls_franq_pag.cd_estabelecimento%type,
		dt_mes_competencia_pc	pls_lote_pagamento.dt_mes_competencia%type) FOR
	SELECT	nr_sequencia
	from	pls_franq_pag
	where	cd_estabelecimento = cd_estabelecimento_pc
	and	trunc(dt_referencia, 'month') = dt_mes_competencia_pc
	and	(dt_fechamento_lote IS NOT NULL AND dt_fechamento_lote::text <> '');

c02 CURSOR(	nr_seq_franq_pag_pc	pls_franq_pag_prest.nr_seq_franq_pag%type) FOR
	SELECT	a.vl_ajuste,
		a.nr_seq_evento_movto,
		b.nr_seq_evento,
		a.nr_sequencia,
		a.nr_seq_prestador
	from	pls_evento_movimento b,
		pls_franq_pag_prest a
	where	a.nr_seq_franq_pag = nr_seq_franq_pag_pc
	and	a.nr_seq_evento_movto = b.nr_sequencia
	and	coalesce(a.nr_seq_pag_item::text, '') = ''
	and	coalesce(b.ie_cancelamento::text, '') = '';
BEGIN

select	max(cd_estabelecimento),
	max(dt_mes_competencia)
into STRICT	cd_estabelecimento_w,
	dt_mes_competencia_w
from	pls_lote_pagamento
where	nr_sequencia = nr_seq_lote_p;

for	r_c01_w in c01(cd_estabelecimento_w, trunc(dt_mes_competencia_w, 'month')) loop

	for	r_c02_w in c02(r_c01_w.nr_sequencia) loop

		select	max(nr_sequencia)
		into STRICT	nr_seq_pag_prest_w
		from	pls_pagamento_prestador
		where	nr_seq_lote = nr_seq_lote_p
		and	nr_seq_prestador = r_c02_w.nr_seq_prestador;

		--não tem produção para este prestador, e dai não vai gerar o lote por causa da franquia
		if (coalesce(nr_seq_pag_prest_w::text, '') = '') then

			insert into pls_pagamento_prestador(
				nr_sequencia,
				nr_seq_prestador,
				vl_pagamento,
				nr_seq_lote,
				dt_atualizacao,
				nm_usuario
			) values (
				nextval('pls_pagamento_prestador_seq'),
				r_c02_w.nr_seq_prestador,
				0,
				nr_seq_lote_p,
				clock_timestamp(),
				nm_usuario_p
			) returning nr_sequencia into nr_seq_pag_prest_w;
		end if;

		insert into pls_pagamento_item(
			nr_sequencia,
			nr_seq_pagamento,
			nr_seq_evento,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			vl_item,
			ie_tipo_contratacao,
			nr_tit_pagar_origem,
			nr_tit_receber_origem,
			nr_adiant_pago_origem,
			nr_seq_regra_fixo_calc,
			vl_glosa,
			nr_prior_desc,
			nr_seq_lote_pgto_orig,
			dt_mes_comp_lote,
			ie_apropriar_total
		) values (
			nextval('pls_pagamento_item_seq'),
			nr_seq_pag_prest_w,
			r_c02_w.nr_seq_evento,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			r_c02_w.vl_ajuste,
			null,
			null,
			null,
			null,
			null,
			0,
			null,
			null,
			null,
			'N'
		) returning nr_sequencia into nr_seq_pag_item_w;

		update	pls_pagamento_prestador
		set	vl_pagamento = vl_pagamento + r_c02_w.vl_ajuste
		where	nr_sequencia = nr_seq_pag_prest_w;

		update	pls_franq_pag_prest
		set	nr_seq_pag_item = nr_seq_pag_item_w
		where	nr_sequencia = r_c02_w.nr_sequencia;

		update	pls_evento_movimento
		set	nr_seq_lote_pgto = nr_seq_lote_p,
			nr_seq_pagamento_item = nr_seq_pag_item_w
		where	nr_sequencia = r_c02_w.nr_seq_evento_movto;
	end loop;
end loop;

select	coalesce(sum(vl_pagamento),0)
into STRICT	vl_pagamento_w
from	pls_pagamento_prestador
where	nr_seq_lote	= nr_seq_lote_p;

update	pls_lote_pagamento
set	vl_lote		= vl_pagamento_w,
	nm_usuario	= nm_usuario_p,
	dt_atualizacao	= clock_timestamp()
where	nr_sequencia	= nr_seq_lote_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_eventos_franq_pag ( nr_seq_lote_p pls_lote_pagamento.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

