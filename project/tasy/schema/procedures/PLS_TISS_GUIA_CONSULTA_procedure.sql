-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_tiss_guia_consulta ( nr_seq_guia_p pls_guia_plano.nr_sequencia%type, nr_seq_requisicao_p pls_requisicao.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Converter as guias de SP/SADT recebidas pelo WebService TISS que tenham
	ao menos um procedimento do tipo consulta, para uma 'Guia de consulta'.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[X] Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [  ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ie_ident_proc_solic_w		pls_param_importacao_guia.ie_ident_proc_solic%type;
qt_proc_consulta_w		integer := 0;
cd_especialidade_w		pls_requisicao.cd_especialidade%type;


BEGIN

--Obtem o parâmetro 'Identificar guia de consulta pelo procedimento solicitado.' em OPS - Gestão de Operadoras > Parâmetros da OPS > Importação XML guia
select	coalesce(max(ie_ident_proc_solic), 'N')
into STRICT	ie_ident_proc_solic_w
from	pls_param_importacao_guia;

if (ie_ident_proc_solic_w = 'S') then
	if (nr_seq_requisicao_p IS NOT NULL AND nr_seq_requisicao_p::text <> '') then
		select	count(1)
		into STRICT	qt_proc_consulta_w
		from	pls_requisicao_proc a
		where	a.nr_seq_requisicao = nr_seq_requisicao_p
		and	exists (	SELECT	1
					from	procedimento b
					where	a.cd_procedimento	= b.cd_procedimento
					and	a.ie_origem_proced	= b.ie_origem_proced
					and	b.cd_tipo_procedimento	= 71);

		if (qt_proc_consulta_w > 0) then
			select	pls_obter_se_espec_med_unica(nr_seq_prestador, cd_medico_solicitante)
			into STRICT	cd_especialidade_w
			from	pls_requisicao
			where	nr_sequencia = nr_seq_requisicao_p;

			update	pls_requisicao
			set	ie_tipo_guia		= '3',	--Consulta
				ie_tipo_consulta	= 1,	--Primeira consulta
				ds_indicacao_clinica	 = NULL,
				ie_carater_atendimento	 = NULL,
				cd_especialidade	= CASE WHEN cd_especialidade_w=0 THEN  null  ELSE cd_especialidade_w END
			where	nr_sequencia		= nr_seq_requisicao_p;

			insert into pls_requisicao_diagnostico(
				nr_sequencia, dt_atualizacao, ie_classificacao,
				nm_usuario, ie_indicacao_acidente, cd_doenca,
				dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_requisicao)
			values (nextval('pls_requisicao_diagnostico_seq'), clock_timestamp(), 'P',
				nm_usuario_p, '2', null,
				clock_timestamp(), nm_usuario_p, nr_seq_requisicao_p);
		end if;
	elsif (nr_seq_guia_p IS NOT NULL AND nr_seq_guia_p::text <> '') then
		select	count(1)
		into STRICT	qt_proc_consulta_w
		from	pls_guia_plano_proc a
		where	a.nr_seq_guia = nr_seq_guia_p
		and	exists (	SELECT	1
					from	procedimento b
					where	a.cd_procedimento	= b.cd_procedimento
					and	a.ie_origem_proced	= b.ie_origem_proced
					and	b.cd_tipo_procedimento	= 71);

		if (qt_proc_consulta_w > 0) then
			update	pls_guia_plano
			set	ie_tipo_guia		= '3',	--Consulta
				ie_tipo_consulta	= 1,	--Primeira consulta
				ds_indicacao_clinica	 = NULL,
				ie_carater_internacao	 = NULL
			where	nr_sequencia		= nr_seq_guia_p;

			insert into pls_diagnostico(
				nr_sequencia, dt_atualizacao, ie_classificacao,
				nm_usuario, ie_indicacao_acidente, cd_doenca,
				dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_guia)
			values (nextval('pls_diagnostico_seq'), clock_timestamp(), 'P',
				nm_usuario_p, '2', null,
				clock_timestamp(), nm_usuario_p, nr_seq_guia_p);
		end if;
	end if;

	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_tiss_guia_consulta ( nr_seq_guia_p pls_guia_plano.nr_sequencia%type, nr_seq_requisicao_p pls_requisicao.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

