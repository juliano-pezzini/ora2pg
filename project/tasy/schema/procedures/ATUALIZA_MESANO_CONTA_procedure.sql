-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_mesano_conta () AS $body$
DECLARE

dt_dia_vencimento_w	numeric(2);
nr_interno_conta_w	numeric(10);
dt_periodo_final_w   timestamp;
dt_final_w   	timestamp;
				
c01 CURSOR FOR 
	SELECT 	a.dt_periodo_final, 
		a.nr_interno_conta, 
		b.dt_dia_vencimento 
    from 	conta_paciente a, 
		convenio b 
	where 	a.cd_convenio_parametro = b.cd_convenio 
    and 	coalesce(a.dt_mesano_referencia::text, '') = '';

BEGIN
open c01;
loop 
  fetch c01 into 
     dt_periodo_final_w, 
     nr_interno_conta_w, 
     dt_dia_vencimento_w;
  if c01%found then 
	begin 
	 
	if  pkg_date_utils.extract_field('DAY', dt_periodo_final_w) > dt_dia_vencimento_w then 
       dt_periodo_final_w := pkg_date_utils.add_month(dt_periodo_final_w, 1, 0);
    end if;
	 
    if (pkg_date_utils.extract_field('MONTH', dt_periodo_final_w) = 2) and (dt_dia_vencimento_w > 28)        then 
       dt_dia_vencimento_w := 28;
    end if;
	 
    if (pkg_date_utils.extract_field('MONTH', dt_periodo_final_w) = 4) or (pkg_date_utils.extract_field('MONTH', dt_periodo_final_w) = 6) or (pkg_date_utils.extract_field('MONTH', dt_periodo_final_w) = 9) or (pkg_date_utils.extract_field('MONTH', dt_periodo_final_w) = 11) then 
       if  dt_dia_vencimento_w > 30 then  
         dt_dia_vencimento_w := 30;
       end if;
    end if;
 
	dt_final_w := 	to_date(to_char(dt_dia_vencimento_w)||'/'||to_char(dt_periodo_final_w,'mm/yyyyHH24:mi:ss'),'DD/MM/YYYYHH24:MI:SS');
 
    update conta_paciente 
    set dt_mesano_referencia = dt_final_w 
    where nr_interno_conta = nr_interno_conta_w;
	 
    end;
  else 
    exit;
  end if;
end loop;
close c01;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_mesano_conta () FROM PUBLIC;

