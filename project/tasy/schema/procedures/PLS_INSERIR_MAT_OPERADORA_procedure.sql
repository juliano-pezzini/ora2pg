-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inserir_mat_operadora ( cd_material_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ds_material_w			varchar(255);
cd_unidade_medida_consumo_w	varchar(30);
ie_tipo_despesa_w		varchar(2);
nr_seq_estrut_mat_w		bigint;
qt_registro_w			bigint;
nr_seq_material_w		bigint;					
 

BEGIN 
if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then 
	select	count(1) 
	into STRICT	qt_registro_w 
	from	pls_material a 
	where	a.cd_material	= cd_material_p  LIMIT 1;
	 
	if (qt_registro_w = 0) then 
 
		select	substr(obter_dados_material_estab(a.cd_material,cd_estabelecimento_p,'UMS'),1,30) cd_unidade_medida_consumo, 
			CASE WHEN a.ie_tipo_material=1 THEN CASE WHEN b.ie_tipo_classe='G' THEN 1 WHEN coalesce(b.ie_tipo_classe::text, '') = '' THEN 3  ELSE 7 END  WHEN a.ie_tipo_material=5 THEN 3 WHEN a.ie_tipo_material=2 THEN 2 WHEN a.ie_tipo_material=3 THEN 2 WHEN a.ie_tipo_material=6 THEN 2 WHEN a.ie_tipo_material=4 THEN 1 END , 
			a.ds_material 
		into STRICT	cd_unidade_medida_consumo_w, 
			ie_tipo_despesa_w, 
			ds_material_w 
		from	classe_material b, 
			material a 
		where	a.cd_classe_material	= b.cd_classe_material 
		and	a.cd_material	= cd_material_p;
		 
		select	max(a.nr_seq_estrut_mat_rev) 
		into STRICT	nr_seq_estrut_mat_w 
		from	pls_parametros a 
		where	a.cd_estabelecimento	= cd_estabelecimento_p;
		 
		if (coalesce(nr_seq_estrut_mat_w::text, '') = '') then 
			/* Não foi possível gerar o material na operadora. 
			Verifique o campo "Estrutura padrão" nos parâmetros da operadora. */
 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(266875);
		end if;
		 
		select	nextval('pls_material_seq') 
		into STRICT	nr_seq_material_w 
		;
		 
		insert into pls_material(nr_sequencia, 
			nm_usuario, 
			dt_atualizacao, 
			nm_usuario_nrec, 
			dt_atualizacao_nrec, 
			cd_material, 
			ds_material, 
			ie_situacao, 
			cd_unidade_medida, 
			ie_tipo_despesa, 
			nr_seq_estrut_mat, 
			cd_estabelecimento, 
			dt_inclusao, 
			ie_revisar) 
		values (nr_seq_material_w, 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			cd_material_p, 
			ds_material_w, 
			'A', 
			cd_unidade_medida_consumo_w, 
			ie_tipo_despesa_w, 
			nr_seq_estrut_mat_w, 
			cd_estabelecimento_p, 
			trunc(clock_timestamp(),'dd'), 
			'R');
			 
		CALL pls_gerar_cod_material(nr_seq_material_w,nm_usuario_p);	
	end if;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inserir_mat_operadora ( cd_material_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

