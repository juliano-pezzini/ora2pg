-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE plt_copia_hemodialise (nr_prescricao_p bigint, nr_prescricao_orig_p bigint, nr_seq_material_p bigint, nr_seq_regra_p bigint, dt_prescricao_p timestamp, nm_usuario_p text, ie_modificar_p text) AS $body$
DECLARE

 
nr_agrup_acum_w		bigint;
nr_seq_solucao_w	bigint;
ie_copia_valid_igual_w	varchar(1);
dt_validade_origem_w	timestamp;
dt_validade_nova_w	timestamp;
dt_prescricao_www	timestamp;
dt_inicio_prescr_w	timestamp;
dt_primeiro_horario_w	timestamp;
nr_horas_validade_w	integer;
ie_prim_horario_setor_w	varchar(10);
hr_setor_w		varchar(10);
cd_setor_atendimento_w	bigint;
cd_estabelecimento_w	smallint;
nr_atendimento_w	bigint;
nr_seq_dialise_w	bigint;
nr_prescr_dial_w 	bigint := 0;
ie_copiar_hemodialise_w varchar(1);
cd_perfil_w				 integer;
qt_inconsistencia_w 	 bigint;

qt_zero_um_bic_w  			bigint;
qt_um_dois_bic_w  			bigint;
qt_dois_tres_bic_w 			bigint;
qt_tres_quatro_w  			bigint;
qt_quatro_cinco_bic_w		bigint;
qt_cinco_seis_bic_w			bigint;
nr_seq_perfil_bic_w			bigint;

c01 CURSOR FOR 
SELECT	qt_fluxo_sangue, 
		qt_sessao_sem, 
		qt_hora_sessao, 
		qt_min_sessao, 
		nr_seq_mod_dialisador, 
		ie_ultrafiltracao, 
		qt_ultrafiltracao, 
		CASE WHEN ie_tipo_dialise='P' THEN null  ELSE ie_tipo_hemodialise END  ie_tipo_hemodialise, 
		ie_tipo_dialise, 
		ie_tipo_peritoneal, 
		nr_seq_maq_cicladora, 
		qt_volume_total, 
		dt_status, 
		ie_status, 
		cd_perfil_ativo, 
		nr_seq_assinatura, 
		nr_seq_diametro_agulha, 
		nr_seq_tipo_agulha, 
		ie_continuo, 
		nr_seq_tipo_agulha_art, 
		nr_seq_perfil_sodio, 
		qt_zero_um, 
		qt_um_dois, 
		qt_dois_tres, 
		qt_tres_quatro, 
		ie_ligar_prime, 
		qt_peso_seco, 
		ds_observacao, 
		qt_peso_ideal, 
		dt_inicio_dialise, 
		dt_fim_dialise, 
		nr_ciclos, 
		qt_hora_duracao, 
		qt_min_duracao, 
		qt_volume_ciclo, 
		qt_cinco_seis, 
		qt_seto_oito, 
		ie_cateter, 
		nr_serie, 
		ie_perm_inteligente, 
		ie_apagar_visor, 
		ie_volume_alarme, 
		qt_minimo_volume, 
		ie_modo_dialise, 
		qt_tempo_min_drenagem, 
		qt_limite_uf_negativo,  
		qt_limite_uf_positivo,  
		ie_ausente, 
		ie_categoria, 
		qt_peso_atual, 
		nr_seq_ultra, 
		qt_sodio, 
		qt_bicarbonato, 
		qt_calcio, 
		qt_peso_pos, 
		qt_volume_prime, 
		nr_sequencia, 
		qt_zero_um_bic, 
		qt_um_dois_bic, 
		qt_dois_tres_bic, 
		qt_tres_quatro_bic, 
		qt_quatro_cinco_bic, 
		qt_cinco_seis_bic, 
		nr_seq_perfil_bic 
from	hd_prescricao 
where	nr_prescricao	= nr_prescricao_orig_p;

c01_w	c01%rowtype;


BEGIN 
 
select max(dt_inicio_prescr), 
	  max(dt_validade_prescr),	  
	  max(cd_estabelecimento), 
	  max(cd_perfil_ativo) 
into STRICT  dt_inicio_prescr_w, 
	  dt_validade_origem_w, 
    cd_estabelecimento_w, 
	  cd_perfil_w  
from  prescr_medica 
where nr_prescricao = nr_prescricao_orig_p;
 
CALL PLT_consiste_extensao_item(dt_inicio_prescr_w, dt_validade_origem_w, nr_prescricao_orig_p, nr_seq_material_p, 'DI', nr_seq_regra_p, nm_usuario_p, cd_perfil_w, cd_estabelecimento_w);
 
select	count(nr_sequencia) 
into STRICT	qt_inconsistencia_w 
from	w_copia_plano 
where	nr_prescricao	= nr_prescricao_orig_p 
and		nr_seq_item		= nr_seq_material_p 
and		ie_tipo_item	= 'DI' 
and		nm_usuario		= nm_usuario_p 
and (ie_permite	= 'N')  LIMIT 1;
 
	if (qt_inconsistencia_w = 0) then 
	 
		select 	count(*) 
		into STRICT 	nr_prescr_dial_w 
		from 	hd_prescricao 
		where 	nr_prescricao = nr_prescricao_p;
		 
		if (nr_prescr_dial_w = 0) then 
			begin 
			 
			open C01;
			loop 
			fetch C01 into	 
				C01_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
		 
				select	nextval('hd_prescricao_seq') 
				into STRICT	nr_seq_dialise_w 
				;
		 
				insert into hd_prescricao( 
					nr_sequencia, 
					dt_atualizacao, 
					nm_usuario, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec, 
					nr_prescricao, 
					qt_fluxo_sangue, 
					qt_sessao_sem, 
					qt_hora_sessao, 
					qt_min_sessao, 
					nr_seq_mod_dialisador, 
					ie_ultrafiltracao, 
					qt_ultrafiltracao, 
					ie_tipo_hemodialise, 
					ie_tipo_dialise, 
					ie_tipo_peritoneal, 
					nr_seq_maq_cicladora, 
					qt_volume_total, 
					dt_status, 
					ie_status, 
					cd_perfil_ativo, 
					nr_seq_assinatura, 
					nr_seq_diametro_agulha, 
					nr_seq_tipo_agulha, 
					ie_continuo, 
					nr_seq_tipo_agulha_art, 
					nr_seq_perfil_sodio, 
					qt_zero_um, 
					qt_um_dois, 
					qt_dois_tres, 
					qt_tres_quatro, 
					ie_ligar_prime, 
					qt_peso_seco, 
					ds_observacao, 
					qt_peso_ideal, 
					dt_inicio_dialise, 
					dt_fim_dialise, 
					nr_ciclos, 
					qt_hora_duracao, 
					qt_min_duracao, 
					qt_volume_ciclo, 
					qt_cinco_seis, 
					qt_seto_oito, 
					ie_cateter, 
					nr_prescricao_original, 
					nr_serie, 
					ie_perm_inteligente, 
					ie_apagar_visor, 
					ie_volume_alarme, 
					qt_minimo_volume, 
					ie_modo_dialise, 
					qt_tempo_min_drenagem, 
					qt_limite_uf_negativo,  
					qt_limite_uf_positivo,  
					ie_ausente, 
					ie_categoria, 
					qt_peso_atual, 
					nr_seq_ultra, 
					qt_sodio, 
					qt_bicarbonato, 
					qt_calcio, 
					qt_peso_pos, 
					qt_volume_prime, 
					qt_zero_um_bic, 
					qt_um_dois_bic, 
					qt_dois_tres_bic, 
					qt_tres_quatro_bic, 
					qt_quatro_cinco_bic, 
					qt_cinco_seis_bic, 
					nr_seq_perfil_bic) 
				values (nr_seq_dialise_w, 
						clock_timestamp(), 
						nm_usuario_p, 
						clock_timestamp(), 
						nm_usuario_p, 
						nr_prescricao_p, 
						c01_w.qt_fluxo_sangue, 
						c01_w.qt_sessao_sem, 
						c01_w.qt_hora_sessao, 
						c01_w.qt_min_sessao, 
						c01_w.nr_seq_mod_dialisador, 
						c01_w.ie_ultrafiltracao, 
						c01_w.qt_ultrafiltracao, 
						c01_w.ie_tipo_hemodialise, 
						c01_w.ie_tipo_dialise, 
						c01_w.ie_tipo_peritoneal, 
						c01_w.nr_seq_maq_cicladora, 
						c01_w.qt_volume_total, 
						c01_w.dt_status, 
						c01_w.ie_status, 
						c01_w.cd_perfil_ativo, 
						c01_w.nr_seq_assinatura, 
						c01_w.nr_seq_diametro_agulha, 
						c01_w.nr_seq_tipo_agulha, 
						c01_w.ie_continuo, 
						c01_w.nr_seq_tipo_agulha_art, 
						c01_w.nr_seq_perfil_sodio, 
						c01_w.qt_zero_um, 
						c01_w.qt_um_dois, 
						c01_w.qt_dois_tres, 
						c01_w.qt_tres_quatro, 
						c01_w.ie_ligar_prime, 
						c01_w.qt_peso_seco, 
						c01_w.ds_observacao, 
						c01_w.qt_peso_ideal, 
						c01_w.dt_inicio_dialise, 
						c01_w.dt_fim_dialise, 
						c01_w.nr_ciclos, 
						c01_w.qt_hora_duracao, 
						c01_w.qt_min_duracao, 
						c01_w.qt_volume_ciclo, 
						c01_w.qt_cinco_seis, 
						c01_w.qt_seto_oito, 
						c01_w.ie_cateter, 
						nr_prescricao_orig_p, 
						c01_w.nr_serie, 
						c01_w.ie_perm_inteligente, 
						c01_w.ie_apagar_visor, 
						c01_w.ie_volume_alarme, 
						c01_w.qt_minimo_volume, 
						c01_w.ie_modo_dialise, 
						c01_w.qt_tempo_min_drenagem, 
						c01_w.qt_limite_uf_negativo,  
						c01_w.qt_limite_uf_positivo,  
						c01_w.ie_ausente, 
						c01_w.ie_categoria, 
						c01_w.qt_peso_atual, 
						c01_w.nr_seq_ultra, 
						c01_w.qt_sodio, 
						c01_w.qt_bicarbonato, 
						c01_w.qt_calcio, 
						c01_w.qt_peso_pos, 
						c01_w.qt_volume_prime, 
						c01_w.qt_zero_um_bic, 
						c01_w.qt_um_dois_bic, 
						c01_w.qt_dois_tres_bic, 
						c01_w.qt_tres_quatro_bic, 
						c01_w.qt_quatro_cinco_bic, 
						c01_w.qt_cinco_seis_bic, 
						c01_w.nr_seq_perfil_bic);
		 
				CALL REP_copia_solucao_dialise(nr_prescricao_orig_p, nr_prescricao_p, nr_seq_regra_p,'S', dt_prescricao_p,nm_usuario_p, nr_seq_dialise_w, nr_seq_material_p,c01_w.nr_sequencia,ie_modificar_p);
		 
			end loop;
			close C01;
			 
			select	max(nr_seq_solucao) 
			into STRICT	nr_seq_solucao_w 
			from	prescr_solucao 
			where	nr_prescricao	= nr_prescricao_p 
			and		ie_hemodialise	in ('S','P');
		 
			if (nr_seq_solucao_w > 0) then 
				--Elementos da Solução de Hemodiálise 
				insert into hd_prescr_sol_elem( 
					nr_sequencia, 
					dt_atualizacao, 
					nm_usuario, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec, 
					nr_prescricao, 
					nr_seq_solucao, 
					nr_seq_elemento, 
					cd_unidade_medida, 
					qt_elemento, 
					nr_prescricao_original) 
				SELECT	nextval('hd_prescr_sol_elem_seq'), 
					clock_timestamp(), 
					nm_usuario_p, 
					clock_timestamp(), 
					nm_usuario_p, 
					nr_prescricao_p, 
					nr_seq_solucao_w, 
					nr_seq_elemento, 
					cd_unidade_medida, 
					qt_elemento, 
					nr_prescricao_orig_p 
				from	hd_prescr_sol_elem 
				where	nr_prescricao	= nr_prescricao_orig_p;
		 
			end if;
		 
		end;
		end if;
		 
		commit;
	end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE plt_copia_hemodialise (nr_prescricao_p bigint, nr_prescricao_orig_p bigint, nr_seq_material_p bigint, nr_seq_regra_p bigint, dt_prescricao_p timestamp, nm_usuario_p text, ie_modificar_p text) FROM PUBLIC;

