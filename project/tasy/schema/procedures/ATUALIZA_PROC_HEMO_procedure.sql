-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_proc_hemo ( nr_prescricao_p bigint, nr_sequencia_p bigint) AS $body$
DECLARE

										 
dt_programada_w timestamp;
cd_intervalo_proc_w		varchar(50);
dt_inicio_prescr_w		timestamp;
nr_horas_validade_w		bigint;
cd_procedimento_w		bigint;
qt_hora_intervalo_w		bigint;
qt_min_intervalo_w		bigint;
nr_sequencia_w			bigint;
nr_ocorrencia_w			bigint;
ds_horarios_w			varchar(4000);
ds_horarios2_w			varchar(4000);
ds_horarios3_w			varchar(4000);
dt_prev_execucao_w		timestamp;
IE_OPERACAO_W			varchar(50) := 'X';
ie_origem_proced_w		integer;
ie_situacao_w			varchar(4);
nr_seq_exame_w			bigint;

c01 CURSOR FOR 
SELECT	a.nr_sequencia, 
	  a.cd_intervalo, 
	  c.dt_programada, 
	  a.cd_procedimento, 
	  a.ie_origem_proced, 
		to_char(c.dt_programada,'hh24:mi'), 
		a.ds_horarios, 
		coalesce(b.ie_situacao,'A'), 
		a.nr_seq_exame, 
		a.qt_hora_intervalo, 
		a.qt_min_intervalo 
FROM prescr_solic_bco_sangue c, prescr_procedimento a
LEFT OUTER JOIN intervalo_prescricao b ON (a.cd_intervalo = b.cd_intervalo)
WHERE c.nr_prescricao	= nr_prescricao_p AND c.nr_sequencia	= a.nr_seq_solic_sangue and c.nr_sequencia = nr_sequencia_p  AND Obter_se_exibe_proced(a.nr_prescricao,a.nr_sequencia,a.ie_tipo_proced,'BSHE') = 'S';


BEGIN 
 
open c01;
	loop 
	fetch c01 into 
		nr_sequencia_w, 
		cd_intervalo_proc_w, 
		dt_prev_execucao_w, 
		cd_procedimento_w, 
		ie_origem_proced_w, 
		ds_horarios_w, 
		ds_horarios3_w, 
		ie_situacao_w, 
		nr_seq_exame_w, 
		qt_hora_intervalo_w, 
		qt_min_intervalo_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin 
		nr_ocorrencia_w		:= 0;
		select max(dt_programada)  
		into STRICT dt_inicio_prescr_w 
		from prescr_solic_bco_sangue 
		where nr_sequencia = nr_sequencia_p 
		and  nr_prescricao = nr_prescricao_p;
		 
		select	coalesce(max(ie_operacao),'XPTO') 
		into STRICT	ie_operacao_w 
		from	intervalo_prescricao 
		where	cd_intervalo = cd_intervalo_proc_w;
		 
		if (ie_operacao_w <> 'F') then 
			SELECT * FROM Calcular_Horario_Prescricao( nr_prescricao_p, cd_intervalo_proc_w, dt_inicio_prescr_w, dt_inicio_prescr_w, nr_horas_validade_w, cd_procedimento_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w, 'N', null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w;
		else 
		  ds_horarios_w := ds_horarios3_w;
		end if;
 
		dt_prev_execucao_w	:= dt_inicio_prescr_w;
		update	prescr_procedimento 
		set	  ds_horarios	= substr(ds_horarios_w ||ds_horarios2_w,1,2000), 
				cd_intervalo	= cd_intervalo_proc_w, 
				dt_prev_execucao= dt_prev_execucao_w, 
				nr_ocorrencia	= nr_ocorrencia_w 
		where	nr_prescricao	= nr_prescricao_p 
		and	nr_sequencia	= nr_sequencia_w;
		 
		end;
	end loop;
	close c01;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_proc_hemo ( nr_prescricao_p bigint, nr_sequencia_p bigint) FROM PUBLIC;

