-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_dados_copia_rep (nr_prescricao_p bigint, cd_perfil_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ie_tipo_item_w		varchar(5);
ds_item_w		varchar(255);
qt_item_w		double precision;
nr_seq_item_w		bigint;
nr_sequencia_w		bigint;
cd_item_w		bigint;
nr_regra_ordem_w	bigint;
nr_agrupamento_w	bigint;
cont_w			bigint;
nr_seq_menor_w		bigint;
cd_unidade_medida_w	varchar(50);
ds_intervalo_sol_w	varchar(255);
cd_intervalo_w		varchar(2000);
ds_horarios_w		varchar(2000);
ie_via_aplicacao_w	varchar(50);
hr_prim_horario_w	varchar(5);
ie_acm_sn_w		varchar(5);
ie_superior_composto_w	varchar(1);
ie_copia_w		varchar(1);
ie_mesma_vigencia_w	varchar(1);
ie_copia_valid_igual_w	varchar(1);
nr_prescricao_orig_w	bigint;
dt_inicio_prescr_w	timestamp;
nr_horas_validade_w	integer;
dt_prescricao_w		timestamp;
cd_setor_atendimento_w	bigint;
ie_prim_horario_setor_w	varchar(1);
hr_setor_w		varchar(50);
dt_primeiro_horario_w	timestamp;
dt_validade_nova_w	timestamp;
dt_validade_origem_w	timestamp;
nr_atendimento_w	bigint;
ds_dose_diferenciada_w	varchar(50);

c01 CURSOR FOR 
SELECT	'J' ie_tipo_item,	-- Jejum 
	substr(obter_desc_tipo_jejum(nr_seq_tipo),1,80) ds_item, 
	(null)::numeric  qt_item, 
	null cd_unidade_medida, 
	null cd_intervalo, 
	null ie_via_aplicacao, 
	nr_sequencia, 
	(null)::numeric  cd_item, 
	null hr_prim_horario, 
	null ds_intervalo_sol, 
	'N' ie_acm_sn, 
	'S' ie_superior_composto, 
	(null)::numeric  nr_agrupamento, 
	null ds_horarios, 
	nr_prescricao_original nr_prescricao_orig, 
	null ds_dose_diferenciada 
from	rep_jejum 
where	nr_prescricao	= nr_prescricao_p 

union all
 
SELECT	'D' ie_tipo_item, --Dieta oral 
	substr(obter_nome_dieta(cd_dieta),1,80) ds_item, 
	qt_parametro, 
	null cd_unidade_medida, 
	cd_intervalo, 
	null ie_via_aplicacao, 
	nr_sequencia, 
	a.cd_dieta, 
	null hr_prim_horario, 
	null ds_intervalo_sol, 
	'N' ie_acm_sn, 
	'S' ie_superior_composto, 
	(null)::numeric  nr_agrupamento, 
	ds_horarios, 
	nr_prescricao_original nr_prescricao_orig, 
	null ds_dose_diferenciada 
from	prescr_dieta a 
where	nr_prescricao	= nr_prescricao_p 

union all
 
select	'S' ie_tipo_item, -- Suplemento oral 
	substr(obter_desc_material(cd_material),1,80) ds_item, 
	qt_dose, 
	cd_unidade_medida_dose, 
	cd_intervalo, 
	ie_via_aplicacao, 
	nr_sequencia, 
	a.cd_material, 
	a.hr_prim_horario, 
	null ds_intervalo_sol, 
	CASE WHEN ie_se_necessario='N' THEN CASE WHEN ie_acm='S' THEN 'S'  ELSE 'N' END   ELSE 'S' END  ie_acm_sn, 
	'S' ie_superior_composto, 
	(null)::numeric  nr_agrupamento, 
	ds_horarios, 
	coalesce(nr_prescricao_anterior,nr_prescricao_original) nr_prescricao_orig, 
	null ds_dose_diferenciada 
from	prescr_material a 
where	nr_prescricao	= nr_prescricao_p 
and	ie_agrupador	= 12 

union all
 
select	'SOL' ie_tipo_item, -- Soluções 
	substr(coalesce(ds_solucao,obter_prim_comp_sol(nr_prescricao,nr_seq_solucao)),1,240) ds_item, 
	qt_solucao_total, 
	ie_tipo_dosagem, 
	null cd_intervalo, 
	ie_via_aplicacao, 
	nr_seq_solucao, 
	(null)::numeric , 
	CASE WHEN ie_acm='S' THEN null  ELSE hr_prim_horario END  hr_prim_horario, 
	substr(obter_interv_solucao_vipe(x.ie_acm,x.ie_se_necessario,x.ie_urgencia,x.nr_etapas,x.qt_hora_fase) || CASE WHEN coalesce(x.ie_classif_agora::text, '') = '' THEN ''  ELSE ' - ' END  || obter_desc_intervalo(x.ie_classif_agora),1,240) ds_intervalo_sol, 
	CASE WHEN ie_se_necessario='N' THEN CASE WHEN ie_acm='S' THEN 'S'  ELSE 'N' END   ELSE 'S' END  ie_acm_sn, 
	'S' ie_superior_composto, 
	(null)::numeric  nr_agrupamento, 
	ds_horarios, 
	x.nr_prescricao_original nr_prescricao_orig, 
	null ds_dose_diferenciada 
from	prescr_solucao x 
where	nr_prescricao	= nr_prescricao_p 
and	coalesce(ds_solucao,obter_prim_comp_sol(nr_prescricao,nr_seq_solucao)) is not null 

union all
 
select	'SNE' ie_tipo_item,-- SUPORTE NUTRICIONAL ENTERAL 
	substr(obter_desc_material(cd_material),1,80) ds_item, 
	qt_dose, 
	cd_unidade_medida_dose, 
	cd_intervalo, 
	ie_via_aplicacao, 
	nr_sequencia, 
	a.cd_material, 
	a.hr_prim_horario, 
	null ds_intervalo_sol, 
	CASE WHEN ie_se_necessario='N' THEN CASE WHEN ie_acm='S' THEN 'S'  ELSE 'N' END   ELSE 'S' END  ie_acm_sn, 
	'S' ie_superior_composto, 
	(null)::numeric  nr_agrupamento, 
	ds_horarios, 
	coalesce(nr_prescricao_anterior,nr_prescricao_original) nr_prescricao_orig, 
	null ds_dose_diferenciada 
from	prescr_material a 
where	nr_prescricao	= nr_prescricao_p 
and	ie_agrupador	= 8 

union all
 
select	'HM' ie_tipo_item, -- Hemoterapia 
	substr(Obter_desc_san_derivado(NR_SEQ_DERIVADO),1,50) ds_item, 
	QT_PROCEDIMENTO, 
	IE_UNID_MED_HEMO, 
	CD_INTERVALO, 
	null ie_via_aplicacao, 
	nr_sequencia, 
	cd_procedimento, 
	null hr_prim_horario, 
	null ds_intervalo_sol, 
	CASE WHEN ie_se_necessario='N' THEN CASE WHEN ie_acm='S' THEN 'S'  ELSE 'N' END   ELSE 'S' END  ie_acm_sn, 
	'S' ie_superior_composto, 
	(null)::numeric  nr_agrupamento, 
	ds_horarios, 
	nr_prescricao_original nr_prescricao_orig, 
	null ds_dose_diferenciada 
from	prescr_procedimento 
where	nr_prescricao	= nr_prescricao_p 
and	(nr_seq_solic_sangue IS NOT NULL AND nr_seq_solic_sangue::text <> '') 
and	(nr_seq_derivado IS NOT NULL AND nr_seq_derivado::text <> '') 
and	Obter_se_exibe_proced(nr_prescricao,nr_sequencia,ie_tipo_proced,'BSHE') = 'S' 

union all
 
select	'M' ie_tipo_item, --Medicamentos 
	substr(obter_desc_material(cd_material),1,80) ds_item, 
	qt_dose, 
	cd_unidade_medida_dose, 
	CASE WHEN a.ie_acm='S' THEN 'ACM - ' || cd_intervalo  ELSE cd_intervalo END  cd_intervalo, 
	ie_via_aplicacao, 
	nr_sequencia, 
	a.cd_material, 
	CASE WHEN ie_acm='S' THEN null  ELSE a.hr_prim_horario END , 
	null ds_intervalo_sol, 
	CASE WHEN ie_se_necessario='N' THEN CASE WHEN ie_acm='S' THEN 'S'  ELSE 'N' END   ELSE 'S' END  ie_acm_sn, 
	obter_se_gerar_item_vipe('M',a.nr_prescricao,a.nr_sequencia,a.nr_agrupamento) ie_superior_composto, 
	a.nr_agrupamento, 
	ds_horarios, 
	coalesce(nr_prescricao_anterior,nr_prescricao_original) nr_prescricao_orig, 
	a.ds_dose_diferenciada 
from	prescr_material a 
where	nr_prescricao		= nr_prescricao_p 
and	coalesce(nr_sequencia_solucao::text, '') = '' 
and	coalesce(nr_sequencia_proc::text, '') = '' 
and	coalesce(nr_sequencia_dieta::text, '') = '' 
and	coalesce(nr_sequencia_diluicao::text, '') = '' 
and	coalesce(cd_kit_material::text, '') = '' 
--and	obter_se_gerar_item_vipe('M',a.nr_prescricao,a.nr_sequencia,a.nr_agrupamento) = 'S' 
and	ie_agrupador = 1 

union all
 
select	'MAT' ie_tipo_item, --Materiais 
	substr(obter_desc_material(cd_material),1,80) ds_item, 
	qt_dose, 
	cd_unidade_medida_dose, 
	CASE WHEN a.ie_acm='S' THEN 'ACM - ' || cd_intervalo  ELSE cd_intervalo END  cd_intervalo, 
	ie_via_aplicacao, 
	nr_sequencia, 
	a.cd_material, 
	a.hr_prim_horario, 
	null ds_intervalo_sol, 
	CASE WHEN ie_se_necessario='N' THEN CASE WHEN ie_acm='S' THEN 'S'  ELSE 'N' END   ELSE 'S' END  ie_acm_sn, 
	'S' ie_superior_composto, 
	(null)::numeric  nr_agrupamento, 
	ds_horarios, 
	coalesce(nr_prescricao_anterior,nr_prescricao_original) nr_prescricao_orig, 
	null ds_dose_diferenciada 
from	prescr_material a 
where	nr_prescricao		= nr_prescricao_p 
and	coalesce(nr_sequencia_solucao::text, '') = '' 
and	coalesce(nr_sequencia_proc::text, '') = '' 
and	coalesce(nr_sequencia_dieta::text, '') = '' 
and	coalesce(nr_sequencia_diluicao::text, '') = '' 
and	coalesce(cd_kit_material::text, '') = '' 
and	ie_agrupador		= 2 

union all
 
select	'P' ie_tipo_item, --Procedimentos 
	substr(Obter_desc_prescr_proc(cd_procedimento,ie_origem_proced, nr_seq_proc_interno),1,240) ds_item, 
	qt_procedimento, 
	null, 
	cd_intervalo, 
	null, 
	nr_sequencia, 
	cd_procedimento, 
	null hr_prim_horario, 
	null ds_intervalo_sol, 
	CASE WHEN ie_se_necessario='N' THEN CASE WHEN ie_acm='S' THEN 'S'  ELSE 'N' END   ELSE 'S' END  ie_acm_sn, 
	'S' ie_superior_composto, 
	(null)::numeric  nr_agrupamento, 
	ds_horarios, 
	nr_prescricao_original nr_prescricao_orig, 
	null ds_dose_diferenciada 
from	prescr_procedimento 
where	nr_prescricao		= nr_prescricao_p 
and	coalesce(nr_seq_origem::text, '') = '' 
and	coalesce(nr_seq_exame::text, '') = '' 
and	coalesce(nr_seq_prot_glic::text, '') = '' 
and	coalesce(nr_seq_solic_sangue::text, '') = '' 
and	coalesce(nr_seq_derivado::text, '') = '' 
and	Obter_se_exibe_proced(nr_prescricao,nr_sequencia,ie_tipo_proced,'O') = 'S' 

union all
 
select	'CG' ie_tipo_item, --Controle de glicemia 
	substr(Obter_desc_prescr_proc(x.cd_procedimento,x.ie_origem_proced, x.nr_seq_proc_interno),1,240) ds_item, 
	x.qt_procedimento, 
	null, 
	x.cd_intervalo, 
	null, 
	x.nr_sequencia, 
	x.cd_procedimento, 
	null hr_prim_horario, 
	null ds_intervalo_sol, 
	CASE WHEN x.ie_se_necessario='N' THEN CASE WHEN x.ie_acm='S' THEN 'S'  ELSE 'N' END   ELSE 'S' END  ie_acm_sn, 
	'S' ie_superior_composto, 
	(null)::numeric  nr_agrupamento, 
	x.ds_horarios, 
	x.nr_prescricao_original nr_prescricao_orig, 
	null ds_dose_diferenciada 
from	proc_interno w, 
	prescr_procedimento x 
where	w.nr_sequencia = x.nr_seq_proc_interno 
and	nr_prescricao		= nr_prescricao_p 
and	w.ie_tipo 	<> 'G' 
and	w.ie_tipo 	<> 'BS' 
and	coalesce(w.ie_ivc,'N') <> 'S' 
and	w.ie_ctrl_glic in ('CCG','CIG') 
and	(x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '') 
and	(x.nr_seq_prot_glic IS NOT NULL AND x.nr_seq_prot_glic::text <> '') 
and	coalesce(x.nr_seq_exame::text, '') = '' 
and	coalesce(x.nr_seq_solic_sangue::text, '') = '' 
and	coalesce(x.nr_seq_derivado::text, '') = '' 
and	coalesce(x.nr_seq_exame_sangue::text, '') = '' 

union all
 
select	'I' ie_tipo_item, -- IRRIGAÇÃO VESICAL CONTÍNUA 
	coalesce(w.ds_proc_exame,y.ds_procedimento) ds_procedimento, 
	x.qt_procedimento, 
	null, 
	x.cd_intervalo, 
	null, 
	x.nr_sequencia, 
	x.cd_procedimento, 
	null hr_prim_horario, 
	null ds_intervalo_sol, 
	CASE WHEN x.ie_se_necessario='N' THEN CASE WHEN x.ie_acm='S' THEN 'S'  ELSE 'N' END   ELSE 'S' END  ie_acm_sn, 
	'S' ie_superior_composto, 
	(null)::numeric  nr_agrupamento, 
	x.ds_horarios, 
	x.nr_prescricao_original nr_prescricao_orig, 
	null ds_dose_diferenciada 
from	proc_interno w, 
	procedimento y, 
	prescr_procedimento x 
where	w.nr_sequencia = x.nr_seq_proc_interno 
and	y.cd_procedimento = x.cd_procedimento 
and	y.ie_origem_proced = x.ie_origem_proced 
and	x.nr_prescricao = nr_prescricao_p 
and	w.ie_tipo	<> 'G' 
and	w.ie_tipo	<> 'BS' 
and	w.ie_ivc	= 'S' 
and	(x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '') 
and	coalesce(x.nr_seq_prot_glic::text, '') = '' 
and	coalesce(x.nr_seq_exame::text, '') = '' 
and	coalesce(x.nr_seq_solic_sangue::text, '') = '' 
and	coalesce(x.nr_seq_derivado::text, '') = '' 
and	coalesce(x.nr_seq_exame_sangue::text, '') = '' 

union all
 
select	'L' ie_tipo_item, --Coletas 
	substr(adep_obter_desc_exame_lab(x.ie_acm,x.ie_se_necessario,z.nm_exame),1,255) ds_procedimento, 
	qt_procedimento, 
	null, 
	cd_intervalo, 
	null, 
	nr_sequencia, 
	x.cd_procedimento, 
	null hr_prim_horario, 
	null ds_intervalo_sol, 
	CASE WHEN x.ie_se_necessario='N' THEN CASE WHEN x.ie_acm='S' THEN 'S'  ELSE 'N' END   ELSE 'S' END  ie_acm_sn, 
	'S' ie_superior_composto, 
	(null)::numeric  nr_agrupamento, 
	x.ds_horarios, 
	x.nr_prescricao_original nr_prescricao_orig, 
	null ds_dose_diferenciada 
from	exame_laboratorio z, 
	prescr_procedimento x 
where	x.nr_prescricao = nr_prescricao_p 
and	x.nr_seq_exame	= z.nr_seq_exame 
and	(x.nr_seq_exame IS NOT NULL AND x.nr_seq_exame::text <> '') 

union all
 
select	'O' ie_tipo_item, -- Gasoterapia 
	substr(coalesce(Obter_nome_rotina_gas(nr_seq_item_rotina), obter_descricao_padrao('GAS', 'DS_GAS', nr_seq_gas)),1,254) ds_item, 
	QT_GASOTERAPIA, 
	IE_UNIDADE_MEDIDA, 
	null cd_intervalo, 
	null ie_via, 
	nr_sequencia, 
	(null)::numeric , 
	null hr_prim_horario, 
	null ds_intervalo_sol, 
	'N' ie_acm_sn, 
	'S' ie_superior_composto, 
	(null)::numeric  nr_agrupamento, 
	null ds_horarios, 
	nr_prescricao_original nr_prescricao_orig, 
	null ds_dose_diferenciada 
from	prescr_gasoterapia 
where	nr_prescricao = nr_prescricao_p 

union all
 
select	'R' ie_tipo_item, --recomendações 
	substr(obter_rec_prescricao(NR_SEQUENCIA, NR_PRESCRICAO),1,255) ds_item, 
	(null)::numeric , 
	null cd_unidade_medida, 
	CD_INTERVALO, 
	null ie_via_aplicacao, 
	nr_sequencia, 
	(null)::numeric , 
	hr_prim_horario, 
	null ds_intervalo_sol, 
	'N', 
	'S' ie_superior_composto, 
	(null)::numeric  nr_agrupamento, 
	ds_horarios, 
	nr_prescricao_original nr_prescricao_orig, 
	null ds_dose_diferenciada 
from	prescr_recomendacao 
where	nr_prescricao = nr_prescricao_p 
and	(obter_rec_prescricao(NR_SEQUENCIA, NR_PRESCRICAO) IS NOT NULL AND (obter_rec_prescricao(NR_SEQUENCIA, NR_PRESCRICAO))::text <> '') 

union all
 
select	'B' ie_tipo_item, -- ORDENS MÉDICAS 
	x.ds_ordem, 
	(null)::numeric , 
	null cd_unidade_medida, 
	null CD_INTERVALO, 
	null ie_via_aplicacao, 
	b.nr_sequencia, 
	(null)::numeric , 
	null hr_prim_horario, 
	null ds_intervalo_sol, 
	'N', 
	'S' ie_superior_composto, 
	(null)::numeric  nr_agrupamento, 
	null ds_horarios, 
	null nr_prescricao_orig, 
	null ds_dose_diferenciada 
from	ordem_medica x, 
	prescr_medica_ordem b 
where	x.nr_sequencia = b.nr_seq_ordem 
and	b.nr_prescricao = nr_prescricao_p 

union all
 
select	'NAN' ie_tipo_item, -- NPT ADULTA 
	CASE WHEN x.ie_forma='P' THEN  obter_desc_expressao(718006) || y.ds_npt  ELSE obter_valor_dominio(1988,x.ie_forma) END  ds_item, 
	x.QT_VOLUME_DIARIO, 
	obter_unid_med_usua('ml') cd_unidade_medida, 
	null CD_INTERVALO, 
	null ie_via_aplicacao, 
	x.nr_sequencia, 
	(null)::numeric , 
	x.hr_prim_horario, 
	null ds_intervalo_sol, 
	coalesce(x.ie_acm,'N') ie_acm_sn, 
	'S' ie_superior_composto, 
	(null)::numeric  nr_agrupamento, 
	null ds_horarios, 
	nr_prescricao_original nr_prescricao_orig, 
	null ds_dose_diferenciada 
FROM nut_pac x
LEFT OUTER JOIN protocolo_npt y ON (x.nr_seq_protocolo = y.nr_sequencia)
WHERE x.nr_prescricao = nr_prescricao_p and x.ie_npt_adulta = 'S';

c02 CURSOR FOR 
SELECT	ie_tipo_item, 
	qt_item, 
	cd_unidade_medida, 
	cd_intervalo, 
	ie_via_aplicacao, 
	nr_seq_item, 
	cd_item, 
	hr_prim_horario, 
	nr_sequencia 
from	w_copia_rep 
where	nm_usuario = nm_usuario_p;


BEGIN 
 
delete from w_copia_rep 
where	nm_usuario = nm_usuario_p;
 
delete from w_copia_rep 
where	nr_prescricao = nr_prescricao_p;
 
commit;
 
ie_copia_w := obter_param_usuario(-2170, 1, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_copia_w);
nr_regra_ordem_w := obter_param_usuario(8030, 6, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, nr_regra_ordem_w);
ie_prim_horario_setor_w := obter_param_usuario(8030, 44, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_prim_horario_setor_w);
ie_copia_valid_igual_w := obter_param_usuario(8030, 73, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_copia_valid_igual_w);
 
open C01;
loop 
fetch C01 into	 
	ie_tipo_item_w, 
	ds_item_w, 
	qt_item_w, 
	cd_unidade_medida_w, 
	cd_intervalo_w, 
	ie_via_aplicacao_w, 
	nr_seq_item_w, 
	cd_item_w, 
	hr_prim_horario_w, 
	ds_intervalo_sol_w, 
	ie_acm_sn_w, 
	ie_superior_composto_w, 
	nr_agrupamento_w, 
	ds_horarios_w, 
	nr_prescricao_orig_w, 
	ds_dose_diferenciada_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
 
	select	max(dt_inicio_prescr), 
		max(nr_horas_validade), 
		max(dt_prescricao), 
		max(cd_setor_atendimento)--, 
	--	nvl(nr_prescricao_orig_w,max(nr_prescricao_anterior)), 
	--	max(dt_validade_prescr) 
	into STRICT	dt_inicio_prescr_w, 
		nr_horas_validade_w, 
		dt_prescricao_w, 
		cd_setor_atendimento_w--, 
	--	nr_prescricao_orig_w, 
	--	dt_validade_nova_w--dt_validade_origem_w-- 
	from	prescr_medica 
	where	nr_prescricao = nr_prescricao_p;
	 
	select	max(dt_validade_prescr) 
	into STRICT	dt_validade_origem_w 
	from	prescr_medica 
	where	nr_prescricao = nr_prescricao_orig_w;
 
	if (ie_prim_horario_setor_w = 'S') then 
		select  to_char(coalesce(max(hr_inicio_prescricao),clock_timestamp()),'hh24:mi') 
		into STRICT	hr_setor_w 
		from	setor_atendimento 
		where	cd_setor_atendimento = cd_setor_atendimento_w;
	else 
		Select Obter_Prim_Horario_Prescricao(nr_atendimento_w,cd_setor_atendimento_w,clock_timestamp(),nm_usuario_p,'R') 
		into STRICT	hr_setor_w 
		;
	end if;
 
	if (length(hr_setor_w) = 5) then 
		dt_primeiro_horario_w	:= to_date('30/12/1899' || substr(hr_setor_w,1,5),'dd/mm/yyyy hh24:mi');
	end if;
 
	if (to_char(dt_primeiro_horario_w,'hh24:mi:ss') < to_char(clock_timestamp(),'hh24:mi:ss')) then 
		dt_inicio_prescr_w	:= to_date(to_char(clock_timestamp() + interval '1 days','dd/mm/yyyy') || ' ' || to_char(dt_primeiro_horario_w,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
	else 
		dt_inicio_prescr_w	:= to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || to_char(dt_primeiro_horario_w,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
	end if;
 
	if (to_char(dt_inicio_prescr_w,'hh24:mi') = hr_setor_w) then 
		nr_horas_validade_w	:= 24;
	end if;
 
	dt_validade_nova_w	:= dt_inicio_prescr_w + coalesce(nr_horas_validade_w,24) / 24;
	dt_validade_nova_w	:= trunc(dt_validade_nova_w,'hh24') - 1/86400;
 
	ie_mesma_vigencia_w := 'N';
	 
	if	(ie_copia_valid_igual_w = 'N' AND dt_validade_origem_w >= dt_validade_nova_w) then 
		ie_mesma_vigencia_w := 'S';
	end if;
	 
	select	nextval('w_copia_rep_seq') 
	into STRICT	nr_sequencia_w 
	;
	 
	insert into w_copia_rep(nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_prescricao, 
		ie_tipo_item, 
		ds_item, 
		qt_item, 
		cd_unidade_medida, 
		cd_intervalo, 
		ie_via_aplicacao, 
		nr_seq_item, 
		cd_item, 
		ie_copiar, 
		hr_prim_horario, 
		ds_intervalo_sol, 
		ie_acm_sn, 
		ie_superior_composto, 
		nr_agrupamento, 
		ds_horarios, 
		ie_mesma_vigencia, 
		ds_dose_diferenciada) 
	values (nr_sequencia_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_prescricao_p, 
		ie_tipo_item_w, 
		ds_item_w, 
		qt_item_w, 
		cd_unidade_medida_w, 
		cd_intervalo_w, 
		ie_via_aplicacao_w, 
		nr_seq_item_w, 
		cd_item_w, 
		ie_copia_w, 
		hr_prim_horario_w, 
		ds_intervalo_sol_w, 
		ie_acm_sn_w, 
		ie_superior_composto_w, 
		nr_agrupamento_w, 
		ds_horarios_w, 
		ie_mesma_vigencia_w, 
		ds_dose_diferenciada_w);
	 
end loop;
close C01;
 
commit;
 
open C02;
loop 
fetch C02 into	 
	ie_tipo_item_w, 
	qt_item_w, 
	cd_unidade_medida_w, 
	cd_intervalo_w, 
	ie_via_aplicacao_w, 
	nr_seq_item_w, 
	cd_item_w, 
	hr_prim_horario_w, 
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
 
	select	count(*) 
	into STRICT	cont_w 
	from	w_copia_rep 
	where	nr_sequencia			<> nr_sequencia_w 
	/*and	nvl(qt_item,0)			= nvl(qt_item_w,0)		Adriana solicitou na OS 227802 
	and	nm_usuario			= nm_usuario_p 
	and	nvl(cd_unidade_medida,'XPTO')	= nvl(cd_unidade_medida_w,'XPTO') 
	and	nvl(cd_intervalo,'XPTO')	= nvl(cd_intervalo_w,'XPTO') 
	and	nvl(ie_via_aplicacao,'XPTO')	= nvl(ie_via_aplicacao_w,'XPTO')*/
 
	and	cd_item				= cd_item_w 
	and	nm_usuario			= nm_usuario_p 
	and	ie_tipo_item			= ie_tipo_item_w;
	 
	if (cont_w	> 0) then 
	 
		select	min(nr_sequencia) 
		into STRICT	nr_seq_menor_w 
		from	w_copia_rep 
		where	/*nvl(qt_item,0)			= nvl(qt_item_w,0)	Adriana solicitou na OS 227802 
		and	nvl(cd_unidade_medida,'XPTO')	= nvl(cd_unidade_medida_w,'XPTO') 
		and	nvl(cd_intervalo,'XPTO')	= nvl(cd_intervalo_w,'XPTO') 
		and	nvl(ie_via_aplicacao,'XPTO')	= nvl(ie_via_aplicacao_w,'XPTO')*/
 
			cd_item				= cd_item_w 
		and	nm_usuario			= nm_usuario_p 
		and	ie_tipo_item			= ie_tipo_item_w;
	 
		if (nr_sequencia_w	<> nr_seq_menor_w) then 
			update	w_copia_rep 
			set	ie_duplicado	= 'S' 
			where	nr_sequencia	= nr_sequencia_w;		
		end if;
	end if;		
	 
end loop;
close C02;
 
--rep_gerar_ordem_apresent(nr_regra_ordem_w); 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_dados_copia_rep (nr_prescricao_p bigint, cd_perfil_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

