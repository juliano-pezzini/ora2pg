-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_estornar_apropriacao_rec ( nr_seq_conta_rec_p pls_rec_glosa_conta.nr_sequencia%type, nr_seq_proc_p pls_rec_glosa_proc.nr_sequencia%type, nr_seq_mat_p pls_rec_glosa_mat.nr_sequencia%type, ds_motivo_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, ie_estorno_p INOUT text) AS $body$
DECLARE

 
ie_estorno_w		varchar(1) := 'N';
qt_aprop_est_w		integer := 0;
qt_copart_w		integer := 0;
qt_pos_w		integer := 0;
					
C00 CURSOR(nr_seq_conta_rec_pc		pls_rec_glosa_conta.nr_sequencia%type) FOR 
	SELECT	'P' ie_tipo_item, 
		a.nr_sequencia nr_seq_item_rec, 
		(SELECT	count(1) 
		 from	pls_conta_coparticipacao c 
		 where	c.nr_seq_proc_rec = a.nr_sequencia) qt_copart, 
		(select	count(1) 
		 from	pls_conta_pos_estabelecido c 
		 where	c.nr_seq_proc_rec = a.nr_sequencia) qt_pos, 
		(select	count(1) 
		 from	pls_conta_proc_aprop c 
		 where	c.nr_seq_proc_rec = a.nr_sequencia 
		 and	c.vl_apropriado < 0) qt_aprop_est 
	from	pls_rec_glosa_proc a 
	where	a.nr_seq_conta_rec = nr_seq_conta_rec_pc 
	
union all
 
	select	'M' ie_tipo_item, 
		a.nr_sequencia nr_seq_item_rec, 
		(select	count(1) 
		 from	pls_conta_coparticipacao c 
		 where	c.nr_seq_mat_rec = a.nr_sequencia) qt_copart, 
		(select	count(1) 
		 from	pls_conta_pos_estabelecido c 
		 where	c.nr_seq_mat_rec = a.nr_sequencia) qt_pos, 
		(select	count(1) 
		 from	pls_conta_mat_aprop c 
		 where	c.nr_seq_mat_rec = a.nr_sequencia 
		 and	c.vl_apropriado < 0) qt_aprop_est 
	from	pls_rec_glosa_mat a 
	where	a.nr_seq_conta_rec = nr_seq_conta_rec_pc 
	order by ie_tipo_item;
	
C01 CURSOR(	nr_seq_proc_rec_pc		pls_rec_glosa_proc.nr_sequencia%type) FOR 
	SELECT	b.nr_sequencia nr_seq_aprop 
	from	pls_conta_proc_aprop b 
	where	b.nr_seq_proc_rec = nr_seq_proc_rec_pc;
	
C04 CURSOR(	nr_seq_mat_rec_pc		pls_rec_glosa_mat.nr_sequencia%type)FOR 
	SELECT	b.nr_sequencia nr_seq_aprop 
	from	pls_conta_mat_aprop b 
	where	b.nr_seq_mat_rec = nr_seq_mat_rec_pc;
		
C02 CURSOR(	nr_seq_item_rec_pc		pls_rec_glosa_proc.nr_sequencia%type, 
		ie_opcao_pc			text) FOR 
	SELECT	a.nr_sequencia 
	from	pls_conta_coparticipacao a 
	where	a.nr_seq_proc_rec = nr_seq_item_rec_pc 
	and	ie_opcao_pc = 'P' 
	
union all
 
	SELECT	a.nr_sequencia 
	from	pls_conta_coparticipacao a 
	where	a.nr_seq_mat_rec = nr_seq_item_rec_pc 
	and	ie_opcao_pc = 'M';
	
C03 CURSOR(	nr_seq_item_rec_pc		pls_rec_glosa_proc.nr_sequencia%type, 
		ie_opcao_pc			text) FOR 
	SELECT	a.nr_sequencia 
	from	pls_conta_pos_estabelecido a 
	where	a.nr_seq_proc_rec = nr_seq_item_rec_pc 
	and	ie_opcao_pc = 'P' 
	
union all
 
	SELECT	a.nr_sequencia 
	from	pls_conta_pos_estabelecido a 
	where	a.nr_seq_mat_rec = nr_seq_item_rec_pc 
	and	ie_opcao_pc = 'M';
	
BEGIN 
 
if (nr_seq_conta_rec_p IS NOT NULL AND nr_seq_conta_rec_p::text <> '') and (coalesce(nr_seq_proc_p::text, '') = '') and (coalesce(nr_seq_mat_p::text, '') = '') then 
	 
	for r_C00_w in C00(nr_seq_conta_rec_p) loop 
		 
		if (r_C00_w.qt_aprop_est = 0) then 
		 
			ie_estorno_w := 'S';
			 
			if (r_C00_w.qt_copart > 0) then 
			 
				for r_C02_w in C02(r_C00_w.nr_seq_item_rec, r_C00_w.ie_tipo_item) loop 
					 
					CALL pls_estornar_custo_copartic(r_C02_w.nr_sequencia, ds_motivo_p, 'A', nm_usuario_p, 'R');
				end loop;
			elsif (r_C00_w.qt_pos > 0) then 
				 
				for r_C03_w in C03(r_C00_w.nr_seq_item_rec, r_C00_w.ie_tipo_item) loop 
					 
					CALL pls_estornar_custo_pos_estab(r_C03_w.nr_sequencia, nm_usuario_p, ds_motivo_p, 'A');
				end loop;
			end if;
			 
			if (r_C00_w.ie_tipo_item = 'P') then 
				for r_C01_w in C01(r_C00_w.nr_seq_item_rec) loop 
					insert	into	pls_conta_proc_aprop(	nr_sequencia, dt_atualizacao_nrec, dt_atualizacao, 
							nm_usuario_nrec, nm_usuario, cd_conta_financ_pag, 
							cd_conta_financ_rec, ie_coparticipacao, ie_recuperar, 
							nr_seq_centro_aprop, nr_seq_conta_proc, nr_seq_proc_rec, 
							nr_seq_regra_aprop, nr_seq_regra_copart_aprop, nr_seq_regra_copartic, 
							qt_apropriada, vl_apropriado, vl_beneficiario) 
					(	SELECT	nextval('pls_conta_proc_aprop_seq'), clock_timestamp(), clock_timestamp(), 
							nm_usuario_p, nm_usuario_p, cd_conta_financ_pag, 
							cd_conta_financ_rec, ie_coparticipacao, ie_recuperar, 
							nr_seq_centro_aprop, nr_seq_conta_proc, nr_seq_proc_rec, 
							nr_seq_regra_aprop, nr_seq_regra_copart_aprop, nr_seq_regra_copartic, 
							qt_apropriada, -1*vl_apropriado, -1*vl_beneficiario 
						from	pls_conta_proc_aprop 
						where	nr_sequencia = r_C01_w.nr_seq_aprop);
				end loop;
			else 
				for r_C04_w in C04(r_C00_w.nr_seq_item_rec) loop 
					insert	into	pls_conta_mat_aprop(	nr_sequencia, dt_atualizacao_nrec, dt_atualizacao, 
						nm_usuario_nrec, nm_usuario, cd_conta_financ_pag, 
						cd_conta_financ_rec, ie_coparticipacao, ie_recuperar, 
						nr_seq_centro_aprop, nr_seq_conta_mat, nr_seq_mat_rec, 
						nr_seq_regra_aprop, nr_seq_regra_copart_aprop, nr_seq_regra_copartic, 
						qt_apropriada, vl_apropriado, vl_beneficiario) 
				(	SELECT	nextval('pls_conta_mat_aprop_seq'), clock_timestamp(), clock_timestamp(), 
						nm_usuario_p, nm_usuario_p, cd_conta_financ_pag, 
						cd_conta_financ_rec, ie_coparticipacao, ie_recuperar, 
						nr_seq_centro_aprop, nr_seq_conta_mat, nr_seq_mat_rec, 
						nr_seq_regra_aprop, nr_seq_regra_copart_aprop, nr_seq_regra_copartic, 
						qt_apropriada, -1*vl_apropriado, -1*vl_beneficiario 
					from	pls_conta_mat_aprop 
					where	nr_sequencia = r_C04_w.nr_seq_aprop);					
				end loop;			
			end if;
		end if;
	end loop;
elsif (nr_seq_proc_p IS NOT NULL AND nr_seq_proc_p::text <> '') then	 
 
	select	count(1) 
	into STRICT	qt_aprop_est_w 
	from	pls_conta_proc_aprop c 
	where	c.nr_seq_proc_rec = nr_seq_proc_p 
	and	c.vl_apropriado < 0;
 
	if (qt_aprop_est_w = 0) then 
	 
		ie_estorno_w := 'S';
		 
		select	count(1) 
		into STRICT	qt_copart_w 
		from	pls_conta_coparticipacao c 
		where	c.nr_seq_proc_rec = nr_seq_proc_p;
		 
		if (qt_copart_w > 0) then 
			 
			for r_C02_w in C02(nr_seq_proc_p, 'P') loop 
						 
				CALL pls_estornar_custo_copartic(r_C02_w.nr_sequencia, ds_motivo_p, 'A', nm_usuario_p, 'R');
			end loop;
		else 
			select	count(1) 
			into STRICT	qt_pos_w 
			from	pls_conta_pos_estabelecido c 
			where	c.nr_seq_proc_rec = nr_seq_proc_p;
			 
			if (qt_pos_w > 0) then 
			 
				for r_C03_w in C03(nr_seq_proc_p, 'P') loop 
						 
					CALL pls_estornar_custo_pos_estab(r_C03_w.nr_sequencia, nm_usuario_p, ds_motivo_p, 'A');
				end loop;
			end if;
		end if;	
		 
		insert	into	pls_conta_proc_aprop(	nr_sequencia, dt_atualizacao_nrec, dt_atualizacao, 
				nm_usuario_nrec, nm_usuario, cd_conta_financ_pag, 
				cd_conta_financ_rec, ie_coparticipacao, ie_recuperar, 
				nr_seq_centro_aprop, nr_seq_conta_proc, nr_seq_proc_rec, 
				nr_seq_regra_aprop, nr_seq_regra_copart_aprop, nr_seq_regra_copartic, 
				qt_apropriada, vl_apropriado, vl_beneficiario) 
		(	SELECT	nextval('pls_conta_proc_aprop_seq'), clock_timestamp(), clock_timestamp(), 
				nm_usuario_p, nm_usuario_p, cd_conta_financ_pag, 
				cd_conta_financ_rec, ie_coparticipacao, ie_recuperar, 
				nr_seq_centro_aprop, nr_seq_conta_proc, nr_seq_proc_rec, 
				nr_seq_regra_aprop, nr_seq_regra_copart_aprop, nr_seq_regra_copartic, 
				qt_apropriada, -1*vl_apropriado, -1*vl_beneficiario 
			from	pls_conta_proc_aprop 
			where	nr_sequencia = nr_seq_proc_p);
	end if;
elsif (nr_seq_mat_p IS NOT NULL AND nr_seq_mat_p::text <> '') then 
 
	select	count(1) 
	into STRICT	qt_aprop_est_w 
	from	pls_conta_mat_aprop c 
	where	c.nr_seq_mat_rec = nr_seq_mat_p 
	and	c.vl_apropriado < 0;
 
	if (qt_aprop_est_w = 0) then 
	 
		ie_estorno_w := 'S';
		 
		select	count(1) 
		into STRICT	qt_copart_w 
		from	pls_conta_coparticipacao c 
		where	c.nr_seq_mat_rec = nr_seq_mat_p;
		 
		if (qt_copart_w > 0) then 
			 
			for r_C02_w in C02(nr_seq_mat_p, 'M') loop 
						 
				CALL pls_estornar_custo_copartic(r_C02_w.nr_sequencia, ds_motivo_p, 'A', nm_usuario_p, 'R');
			end loop;
		else 
			select	count(1) 
			into STRICT	qt_pos_w 
			from	pls_conta_pos_estabelecido c 
			where	c.nr_seq_mat_rec = nr_seq_mat_p;
			 
			if (qt_pos_w > 0) then 
			 
				for r_C03_w in C03(nr_seq_mat_p, 'M') loop 
						 
					CALL pls_estornar_custo_pos_estab(r_C03_w.nr_sequencia, nm_usuario_p, ds_motivo_p, 'A');
				end loop;
			end if;
		end if;	
		 
		insert	into	pls_conta_mat_aprop(	nr_sequencia, dt_atualizacao_nrec, dt_atualizacao, 
				nm_usuario_nrec, nm_usuario, cd_conta_financ_pag, 
				cd_conta_financ_rec, ie_coparticipacao, ie_recuperar, 
				nr_seq_centro_aprop, nr_seq_conta_mat, nr_seq_mat_rec, 
				nr_seq_regra_aprop, nr_seq_regra_copart_aprop, nr_seq_regra_copartic, 
				qt_apropriada, vl_apropriado, vl_beneficiario) 
		(	SELECT	nextval('pls_conta_mat_aprop_seq'), clock_timestamp(), clock_timestamp(), 
				nm_usuario_p, nm_usuario_p, cd_conta_financ_pag, 
				cd_conta_financ_rec, ie_coparticipacao, ie_recuperar, 
				nr_seq_centro_aprop, nr_seq_conta_mat, nr_seq_mat_rec, 
				nr_seq_regra_aprop, nr_seq_regra_copart_aprop, nr_seq_regra_copartic, 
				qt_apropriada, -1*vl_apropriado, -1*vl_beneficiario 
			from	pls_conta_mat_aprop 
			where	nr_sequencia = nr_seq_mat_p);
	end if;
end if;
 
ie_estorno_p := ie_estorno_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_estornar_apropriacao_rec ( nr_seq_conta_rec_p pls_rec_glosa_conta.nr_sequencia%type, nr_seq_proc_p pls_rec_glosa_proc.nr_sequencia%type, nr_seq_mat_p pls_rec_glosa_mat.nr_sequencia%type, ds_motivo_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, ie_estorno_p INOUT text) FROM PUBLIC;

