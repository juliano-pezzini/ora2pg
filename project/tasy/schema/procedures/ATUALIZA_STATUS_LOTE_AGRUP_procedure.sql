-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_status_lote_agrup ( nr_seq_lote_p bigint, ie_opcao_p text, nm_usuario_p text, ds_maquina_p text default null, cd_perfil_ativo_p bigint default null, nr_seq_embalagem_p bigint default null) AS $body$
DECLARE


nr_lote_agrupamento_w 	ap_lote.nr_lote_agrupamento%type;
qt_lotes_susp_w			bigint;


BEGIN

/*
C 	- Cancelamento
D 	- Dispensar
E 	- Entrege
A 	- Atendido
CA 	- Cancelado na alta
R 	- Confirmacao do recebimento
S 	- Suspenso
*/
select	coalesce(max(nr_lote_agrupamento),0)
into STRICT	nr_lote_agrupamento_w
from	ap_lote
where 	nr_sequencia = nr_seq_lote_p;

if (nr_lote_agrupamento_w > 0) then
	
	select	count(*)
	into STRICT	qt_lotes_susp_w
	from 	ap_lote
	where 	nr_lote_agrupamento = nr_lote_agrupamento_w
	and 	nr_sequencia <> nr_seq_lote_p
	and 	coalesce(ie_status_lote,'G') <> ie_opcao_p;
	
	if (qt_lotes_susp_w = 0) then
		
		case ie_opcao_p
			when 'A' then
				update	ap_lote	
				set		dt_atend_farmacia = clock_timestamp(),
						nm_usuario_atend = nm_usuario_p,
						ie_status_lote   = ie_opcao_p
				where 	nr_sequencia = nr_lote_agrupamento_w;
			
			/*when 'D' then
				update	ap_lote
				set		dt_disp_farmacia	= sysdate,
						nm_usuario_disp		= nm_usuario_p,
						ds_maquina_disp		= ds_maquina_p,
						cd_perfil_disp		= cd_perfil_ativo_p,
						ie_status_lote		= ie_opcao_p,
						nr_seq_embalagem	= nr_seq_embalagem_p
				where	nr_sequencia		= nr_lote_agrupamento_w;
			
			when 'E' then
				update	ap_lote
				set		dt_entrega_setor	= sysdate,
						nm_usuario_entrega	= nm_usuario_p,
						ds_maquina_entrega	= ds_maquina_p,
						cd_perfil_entrega	= cd_perfil_ativo_p,
						ie_status_lote		= ie_opcao_p
				where	nr_sequencia		= nr_lote_agrupamento_w;
			
			when 'R' then
				update	ap_lote
				set		dt_recebimento_setor= sysdate,
						nm_usuario_receb	= nm_usuario_p,
						ds_maquina_receb	= ds_maquina_p,
						cd_perfil_receb		= cd_perfil_ativo_p,
						ie_status_lote		= ie_opcao_p
				where	nr_sequencia		= nr_lote_agrupamento_w;*/
		end case;
	end if;
end if;

commit;

exception
when others then
	CALL grava_log_tasy(1744,'Error updating grouped batch',nr_seq_lote_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_status_lote_agrup ( nr_seq_lote_p bigint, ie_opcao_p text, nm_usuario_p text, ds_maquina_p text default null, cd_perfil_ativo_p bigint default null, nr_seq_embalagem_p bigint default null) FROM PUBLIC;

