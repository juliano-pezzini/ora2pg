-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_regra_atrib_prot ( ie_origem_p text, ie_tipo_guia_p text, nr_seq_segurado_p bigint, nm_usuario_p text, cd_condicao_pagamento_p INOUT bigint, ie_tipo_resp_credito_p INOUT text, ie_forma_pagamento_p INOUT text) AS $body$
DECLARE

				 
/* ie_origem_p 
	C - Conta m√©dica 
	R - Reembolso 
*/
 
 
qt_idade_w			varchar(10);
nr_seq_regra_w			pls_regra_atrib_protocolo.nr_sequencia%type;
cd_condicao_pagamento_w		pls_regra_atrib_protocolo.cd_condicao_pagamento%type;
ie_tipo_resp_credito_w		pls_regra_atrib_protocolo.ie_tipo_resp_credito%type;
ie_forma_pagamento_w		pls_regra_atrib_protocolo.ie_forma_pagamento%type;
ie_tipo_contratacao_w		pls_plano.ie_tipo_contratacao%type;
nr_seq_plano_w			pls_plano.nr_sequencia%type;

C01 CURSOR FOR 
	SELECT	a.nr_sequencia, 
		a.cd_condicao_pagamento, 
		a.ie_tipo_resp_credito, 
		a.ie_forma_pagamento 
	from	pls_regra_atrib_protocolo	a 
	where	a.ie_situacao	= 'A' 
	and	((a.ie_conta_medica = 'S') and (ie_origem_p = 'C') or (a.ie_reembolso = 'S' AND ie_origem_p = 'R')) 
	and	((a.ie_tipo_guia = ie_tipo_guia_p) or (coalesce(a.ie_tipo_guia::text, '') = '')) 
	and	qt_idade_w between coalesce(a.qt_idade_inicial,qt_idade_w) and coalesce(a.qt_idade_final,qt_idade_w) 
	and	((ie_tipo_contratacao = ie_tipo_contratacao_w) or (coalesce(ie_tipo_contratacao::text, '') = '')) 
	order by a.ie_tipo_guia desc;


BEGIN 
 
/* Obter a idade do beneficiario */
 
qt_idade_w	:= pls_obter_dados_segurado(nr_seq_segurado_p, 'ID');
 
select 	max(nr_seq_plano) 
into STRICT	nr_seq_plano_w 
from	pls_segurado 
where	nr_sequencia = nr_seq_segurado_p;
 
select	max(ie_tipo_contratacao) 
into STRICT	ie_tipo_contratacao_w 
from	pls_plano 
where	nr_sequencia = nr_seq_plano_w;
 
open C01;
loop 
fetch C01 into	 
	nr_seq_regra_w, 
	cd_condicao_pagamento_w, 
	ie_tipo_resp_credito_w, 
	ie_forma_pagamento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
end loop;
close C01;
 
if (coalesce(nr_seq_regra_w,0) <> 0) then 
	cd_condicao_pagamento_p	:= cd_condicao_pagamento_w;
	ie_tipo_resp_credito_p	:= ie_tipo_resp_credito_w;
	ie_forma_pagamento_p	:= ie_forma_pagamento_w;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_regra_atrib_prot ( ie_origem_p text, ie_tipo_guia_p text, nr_seq_segurado_p bigint, nm_usuario_p text, cd_condicao_pagamento_p INOUT bigint, ie_tipo_resp_credito_p INOUT text, ie_forma_pagamento_p INOUT text) FROM PUBLIC;

