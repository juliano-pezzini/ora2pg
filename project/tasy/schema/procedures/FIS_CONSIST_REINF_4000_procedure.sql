-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_consist_reinf_4000 ( nr_sequencia_p bigint, ie_utilizacao_p text, nm_tabela_p text, cd_evento_reinf_p bigint, nr_seq_evento_p bigint, nr_seq_lote_p bigint, nm_usuario_p text, ie_tipo_dados_p bigint default 0) AS $body$
DECLARE



ds_acao_w   	varchar(2000);
nm_atributo_w	varchar(255);
count_w		integer;
ds_exp_desc_w	varchar(2000);
ds_exp_label_w	varchar(2000);
ds_obs_tabela_w	varchar(2000);
ie_tipo_dados_w	varchar(10);

c01 CURSOR FOR
	SELECT 	a.nm_atributo,			
		substr(obter_desc_expressao(a.cd_exp_desc),1,254),
		substr(obter_desc_expressao(a.cd_exp_label),1,254)
	from	tabela_visao_atributo a,
		tabela_visao t
	where	t.nr_sequencia = a.nr_sequencia
	and	t.ie_utilizacao = ie_utilizacao_p
	and	upper(t.nm_tabela) = upper(nm_tabela_p)
	and 	ie_obrigatorio = 'S';

procedure grava_consist_evt_reinf_4000(
	cd_evento_p	in bigint,
    	cd_registro_p 	in bigint,
	cd_erro_p   	in bigint,
	ds_acao_p 	in text,
	ds_consistencia_p 	in text,
	nr_seq_lote_p 	in bigint) is
;
BEGIN
    insert into fis_reinf_consist(
        	nr_sequencia,
        	dt_atualizacao, 
        	nm_usuario, 
        	dt_atualizacao_nrec, 
        	nm_usuario_nrec, 
        	cd_evento, 
        	cd_erro, 
	ds_consistencia, 
        	ds_acao, 
        	cd_registro,
	nr_seq_lote
    ) values (
        	nextval('fis_reinf_consist_seq'), 
	clock_timestamp(), 
	nm_usuario_p, 
        	clock_timestamp(), 
        	nm_usuario_p, 
        	cd_evento_p, 
        	cd_erro_p, 
        	ds_consistencia_p, 
        	ds_acao_p, 
        	cd_registro_p,
	nr_seq_lote_p
    );
end;

begin
    open C01;
	loop
	fetch c01 into
		nm_atributo_w,
		ds_exp_desc_w,
		ds_exp_label_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
	
			EXECUTE 'select count(*) from ' || nm_tabela_p || ' where	nr_sequencia = ' || nr_sequencia_p || ' and ' || nm_atributo_w ||  ' is null'
			into STRICT count_w;
		
			if (count_w > 0) then
				select 	substr(t.ds_cadastro,1,2000),
					CASE WHEN ie_tipo_dados_p=1 THEN  'Dados'  ELSE 'Evento' END
				into STRICT	ds_obs_tabela_w,
					ie_tipo_dados_w
				from 	tabela_sistema t
				where	upper(nm_tabela) = upper(nm_tabela_p);
			
			
				ds_acao_w := wheb_mensagem_pck.get_texto(1088688, 'IE_TIPO_DADOS_P=' || ie_tipo_dados_w ||
				';DS_CAMPO_P=' || ds_exp_desc_w || 
				';DS_OBS_TABELA_P=' || ds_obs_tabela_w);
			
				grava_consist_evt_reinf_4000(nr_seq_evento_p, cd_evento_reinf_p, 1, ds_acao_w, ds_exp_desc_w, nr_seq_lote_p);					
			end if;
		end;						
	end loop;
	close c01;
									
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_consist_reinf_4000 ( nr_sequencia_p bigint, ie_utilizacao_p text, nm_tabela_p text, cd_evento_reinf_p bigint, nr_seq_evento_p bigint, nr_seq_lote_p bigint, nm_usuario_p text, ie_tipo_dados_p bigint default 0) FROM PUBLIC;

