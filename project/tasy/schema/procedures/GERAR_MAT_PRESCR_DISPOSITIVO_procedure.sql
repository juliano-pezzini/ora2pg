-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_mat_prescr_dispositivo ( nr_prescricao_p bigint, cd_protocolo_p bigint, nr_seq_protocolo_p bigint, nr_seq_prot_med_p bigint, nr_seq_proc_p bigint, nr_seq_procedimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_material_w				integer;
cd_material_w					integer;
qt_dose_w						double precision;
cd_unidade_medida_w				varchar(30);
nr_agrupamento_w				double precision;
cd_intervalo_w					varchar(7);
qt_dose_peso_w					double precision;
ie_multiplicar_dose_w			varchar(1);
ds_recomendacao_w				varchar(2000);
nr_seq_material_ww				integer;
ie_via_aplicacao_w				prescr_material.ie_via_aplicacao%type;
dt_horario_w					timestamp;
cd_estabelecimento_w			prescr_medica.cd_estabelecimento%type;
cd_unidade_medida_consumo_w		prescr_material.cd_unidade_medida%type;
qt_material_ww					prescr_material.qt_material%type;
qt_total_dispensar_w			prescr_material.qt_total_dispensar%type;
ie_regra_disp_w					prescr_material.ie_regra_disp%type;
ds_erro_w						varchar(255);
qt_unitaria_w					prescr_material.qt_unitaria%type;
qt_conversao_w					double precision;

c01 CURSOR FOR
	SELECT	nr_seq_material,
			cd_material,
			qt_dose,
			cd_unidade_medida,
			nr_agrupamento,
			cd_intervalo,
			qt_dose_peso,
			ie_multiplicar_dose,
			ds_recomendacao,
			ie_via_aplicacao
	from	protocolo_medic_material
	where	cd_protocolo	= cd_protocolo_p
	and		nr_sequencia	= nr_seq_prot_med_p
	and		nr_seq_proc	= nr_seq_proc_p
	and		coalesce(nr_seq_diluicao::text, '') = ''
	and		ie_agrupador	= 5;


BEGIN

select	coalesce(max(dt_inicio_prescr),clock_timestamp())
into STRICT	dt_horario_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

open c01;
loop
fetch c01 into
	nr_seq_material_ww,
	cd_material_w,
	qt_dose_w,
	cd_unidade_medida_w,
	nr_agrupamento_w,
	cd_intervalo_w,
	qt_dose_peso_w,
	ie_multiplicar_dose_w,
	ds_recomendacao_w,
	ie_via_aplicacao_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	select	coalesce(max(nr_sequencia),0) + 1
	into STRICT	nr_seq_material_w
	from	prescr_material
	where	nr_prescricao	= nr_prescricao_p;

	select	coalesce(max(qt_conversao),1)
	into STRICT	qt_conversao_w
	from	material_conversao_unidade
	where	cd_material		= cd_material_w
	and	cd_unidade_medida	= cd_unidade_medida_w;

	qt_material_ww := qt_dose_w;

	SELECT * FROM obter_quant_dispensar(	cd_estabelecimento_w, cd_material_w, nr_prescricao_p, 0, cd_intervalo_w, ie_via_aplicacao_w, dividir(qt_dose_w,qt_conversao_w), null, 1, null, 1, cd_unidade_medida_w, null, qt_material_ww, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w, 'N', 'N') INTO STRICT qt_material_ww, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w;


	insert into prescr_material(
		nr_prescricao,
		nr_sequencia,
		ie_origem_inf,
		cd_material,
		qt_dose,
		cd_unidade_medida,
		cd_unidade_medida_dose,
		dt_atualizacao,
		nm_usuario,
		cd_intervalo,
		ds_observacao,
		nr_agrupamento,
		ie_agrupador,
		cd_protocolo,
		nr_seq_protocolo,
		nr_sequencia_proc,
		nr_seq_mat_protocolo,
		ds_horarios,
		hr_prim_horario,
		ie_via_aplicacao,
		nr_ocorrencia,
		qt_total_dispensar,
		qt_material,
		qt_unitaria,
		qt_conversao_dose)
	values (
		nr_prescricao_p,
     	nr_seq_material_w,
	 	'S',
	 	cd_material_w,
	 	qt_dose_w,
		cd_unidade_medida_w,
		cd_unidade_medida_w,
	 	clock_timestamp(),
		nm_usuario_p,
		cd_intervalo_w,
		ds_recomendacao_w,
		nr_agrupamento_w,
		5,
		cd_protocolo_p,
		nr_seq_protocolo_p,
		nr_seq_procedimento_p,
		nr_seq_material_ww,
		to_char(dt_horario_w,'hh24:mi'),
		to_char(dt_horario_w,'hh24:mi'),
		ie_via_aplicacao_w,
		1,
		qt_total_dispensar_w,
		qt_material_ww,
		dividir(qt_dose_w,qt_conversao_w),
		qt_conversao_w
		);

	end;
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_mat_prescr_dispositivo ( nr_prescricao_p bigint, cd_protocolo_p bigint, nr_seq_protocolo_p bigint, nr_seq_prot_med_p bigint, nr_seq_proc_p bigint, nr_seq_procedimento_p bigint, nm_usuario_p text) FROM PUBLIC;

