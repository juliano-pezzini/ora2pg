-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_valor_componente ( cd_estabelecimento_p bigint, nr_seq_componente_p bigint, cd_componente_p bigint, cd_tabela_custo_p bigint, cd_centro_controle_p bigint, cd_material_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, dt_referencia_p timestamp, qt_componente_p INOUT bigint, ie_dvv_p INOUT text, ie_tipo_componente_p INOUT text, ds_resultado_p INOUT text, nr_seq_proc_interno_p bigint) AS $body$
DECLARE


ie_criterio_atual_w		varchar(2);
ie_forma_atrib_valor_w		varchar(2);
cd_classe_material_w		integer;
cd_subgrupo_material_w		integer;
cd_grupo_material_w		integer;
cd_grupo_proc_w			bigint;
cd_especialidade_w		bigint;
cd_area_procedimento_w		bigint;
cd_empresa_w			bigint;

c010 CURSOR FOR
	SELECT	qt_componente
	from	componente_tabela
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	nr_seq_comp_custo	= nr_seq_componente_p
	and	cd_tabela_custo		= cd_tabela_custo_p
	and	cd_material		= cd_material_p
	
union

	SELECT	qt_componente
	from	componente_tabela
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	nr_seq_comp_custo	= nr_seq_componente_p
	and	cd_tabela_custo		= cd_tabela_custo_p
	and	cd_classe_material	= cd_classe_material_w
	
union

	select	qt_componente
	from	componente_tabela
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	nr_seq_comp_custo	= nr_seq_componente_p
	and	cd_tabela_custo		= cd_tabela_custo_p
	and	cd_subgrupo_material	= cd_subgrupo_material_w
	
union

	select	qt_componente
	from	componente_tabela
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	nr_seq_comp_custo	= nr_seq_componente_p
	and	cd_tabela_custo		= cd_tabela_custo_p
	and	cd_grupo_material	= cd_grupo_material_w;

c020 CURSOR FOR
	SELECT	qt_componente
	from	componente_tabela
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	nr_seq_comp_custo	= nr_seq_componente_p
	and	cd_tabela_custo		= cd_tabela_custo_p
	and	cd_procedimento		= cd_procedimento_p
	and	ie_origem_proced	= ie_origem_proced_p
	
union

	SELECT	qt_componente
	from	componente_tabela
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	nr_seq_comp_custo	= nr_seq_componente_p
	and	cd_tabela_custo		= cd_tabela_custo_p
	and	cd_grupo_proced		= cd_grupo_proc_w
	
union

	select	qt_componente
		from componente_tabela
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	nr_seq_comp_custo	= nr_seq_componente_p
	and	cd_tabela_custo		= cd_tabela_custo_p
	and	cd_especial_proced	= cd_especialidade_w
	
union

	select	qt_componente
	from	componente_tabela
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	nr_seq_comp_custo	= nr_seq_componente_p
	and	cd_tabela_custo		= cd_tabela_custo_p
	and	cd_area_proced		= cd_area_procedimento_w
	
union

	select	qt_componente
	from	componente_tabela
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	nr_seq_comp_custo	= nr_seq_componente_p
	and	cd_tabela_custo		= cd_tabela_custo_p
	and	nr_seq_proc_interno	= nr_seq_proc_interno_p;


BEGIN

ds_resultado_p	:= '';
qt_componente_p	:= 0;

begin

cd_empresa_w	:= obter_empresa_estab(cd_estabelecimento_p);

select	ie_dvv,
	ie_forma_atrib_valor,
	ie_criterio_atual,
	ie_tipo_componente
into STRICT	ie_dvv_p,
	ie_forma_atrib_valor_w,
	ie_criterio_atual_w,
	ie_tipo_componente_p
from	componente_custo
where	nr_sequencia		= nr_seq_componente_p
and	coalesce(cd_estabelecimento, cd_estabelecimento_p)	= cd_estabelecimento_p
and	cd_empresa		= cd_empresa_w;
exception when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(266629,
					'COMP='		|| nr_seq_componente_p 	|| ';' ||
					'CD_TABELA='	|| cd_tabela_custo_p	|| ';' ||
					'CD_ESTAB=' 	|| cd_estabelecimento_p || ';' ||
					'DATA_REF='	|| to_char(dt_referencia_p,'dd/mm/yyyy'));
end;

------- consistencia dos parametros -----------------
if (ie_criterio_atual_w = 'D')  and (coalesce(dt_referencia_p::text, '') = '') then
     	ds_resultado_p       := obter_dic_objeto_idioma(266631,wheb_usuario_pck.get_nr_seq_idioma);
	/*'Data de Referência Inválida';*/

end if;

if (ie_criterio_atual_w = 'T')  then
	begin

	if (ie_forma_atrib_valor_w = '2') and (coalesce(cd_centro_controle_p::text, '') = '') then
		ds_resultado_p   := obter_dic_objeto_idioma(266633,wheb_usuario_pck.get_nr_seq_idioma);
     	end if;

	if (ie_forma_atrib_valor_w = '3') and
		(((coalesce(cd_material_p::text, '') = '') and (coalesce(cd_procedimento_p::text, '') = '')) and (coalesce(nr_seq_proc_interno_p::text, '') = '')) then
		ds_resultado_p   := obter_dic_objeto_idioma(266634,wheb_usuario_pck.get_nr_seq_idioma);
     	end if;
     	end;
end if;

------- obter os valores -----------------------------------
if (coalesce(ds_resultado_p::text, '') = '') and (ie_criterio_atual_w = 'D')  then

	select	coalesce(max(qt_componente),0)
	into STRICT	qt_componente_p
	from	componente_data
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	nr_seq_comp_custo	= nr_seq_componente_p
	and	dt_componente		= (SELECT	max(dt_componente)
					from	componente_data
					where	cd_estabelecimento	= cd_estabelecimento_p
					and	nr_seq_comp_custo	= nr_seq_componente_p
					and	dt_componente	<= dt_referencia_p);

end if;

if (coalesce(ds_resultado_p::text, '') = '') and (ie_criterio_atual_w = 'T')  then
	begin

	if (ie_forma_atrib_valor_w = '1') then

		select	coalesce(max(qt_componente),0)
		into STRICT	qt_componente_p
		from	componente_tabela
		where	cd_estabelecimento	= cd_estabelecimento_p
		and	nr_seq_comp_custo	= nr_seq_componente_p
		and	cd_tabela_custo		= cd_tabela_custo_p;

	end if;

	if (ie_forma_atrib_valor_w = '2') then

		select	coalesce(max(qt_componente),0)
		into STRICT	qt_componente_p
		from	componente_tabela
		where	cd_estabelecimento	= cd_estabelecimento_p
		and	nr_seq_comp_custo	= nr_seq_componente_p
		and	cd_tabela_custo		= cd_tabela_custo_p
		and	cd_centro_controle	= cd_centro_controle_p;

	end if;

	/* POR MATERIAL/PROCEDIMENTO */

	if (ie_forma_atrib_valor_w = '3') then
		begin
		if (cd_material_p <> 0) then
			begin
			select 	coalesce(max(cd_grupo_material),0),
				coalesce(max(cd_subgrupo_material),0),
				coalesce(max(cd_classe_material),0)
			into STRICT	cd_grupo_material_w,
				cd_subgrupo_material_w,
				cd_classe_material_w
			from	estrutura_material_v
			where 	cd_material = cd_material_p;

			open c010;
			loop
			fetch c010 into
				qt_componente_p;
			EXIT WHEN NOT FOUND; /* apply on c010 */
			end loop;
			close c010;
			end;
		else
			begin
			select 	coalesce(max(cd_grupo_proc),0),
				coalesce(max(cd_especialidade),0),
				coalesce(max(cd_area_procedimento),0)
			into STRICT	cd_grupo_proc_w,
				cd_especialidade_w,
				cd_area_procedimento_w
			from	estrutura_procedimento_v
			where 	cd_procedimento = cd_procedimento_p
			and	ie_origem_proced = ie_origem_proced_p;

			open c020;
			loop
	    		fetch c020 into
				qt_componente_p;
	    		EXIT WHEN NOT FOUND; /* apply on c020 */
			end loop;
			close c020;

			end;
		end if;
		end;
	end if;
	end;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_valor_componente ( cd_estabelecimento_p bigint, nr_seq_componente_p bigint, cd_componente_p bigint, cd_tabela_custo_p bigint, cd_centro_controle_p bigint, cd_material_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, dt_referencia_p timestamp, qt_componente_p INOUT bigint, ie_dvv_p INOUT text, ie_tipo_componente_p INOUT text, ds_resultado_p INOUT text, nr_seq_proc_interno_p bigint) FROM PUBLIC;

