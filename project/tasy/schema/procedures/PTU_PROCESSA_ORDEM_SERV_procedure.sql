-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_processa_ordem_serv ( nr_seq_ordem_serv_p ptu_requisicao_ordem_serv.nr_sequencia%type, ie_possui_pedido_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_ret_ordem_serv_p INOUT ptu_resposta_req_ord_serv.nr_sequencia%type) AS $body$
DECLARE

 
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade: Rotina utilizada para validação da transação 00806 - Ordem de serviço do PTU 
------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[ X] Objetos do dicionário [ ] Tasy (Delphi/Java) [ ] Portal [ ] Relatórios [ ] Outros: 
 ------------------------------------------------------------------------------------------------------------------ 
Pontos de atenção: 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 
 
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;


BEGIN 
 
cd_estabelecimento_w := cd_estabelecimento_p;
 
--Quando as transações são geradas pelo WebService, não existe estabelecimento definido, então é verificado o estabeleicmento do parâmetro 
if ( coalesce(cd_estabelecimento_w::text, '') = ''	) then 
	cd_estabelecimento_w := ptu_obter_estab_padrao;
end if;
 
if (ie_possui_pedido_p = 'N') then 
 
	nr_seq_ret_ordem_serv_p := ptu_gerar_ord_serv(nr_seq_ordem_serv_p, nm_usuario_p, cd_estabelecimento_w, nr_seq_ret_ordem_serv_p);
 
	CALL ptu_gerar_itens_ord_serv(nr_seq_ordem_serv_p, nr_seq_ret_ordem_serv_p, nm_usuario_p, cd_estabelecimento_w);
 
end if;
 
--Retorna a sequencia da resposta do 00806 - Ordem de serviço do PTU, esta sequência é utilizada para gerar o XML de resposta pelo Webservice 
select (	select	max(nr_sequencia) 
	from	ptu_resposta_req_ord_serv c 
	where	c.nr_seq_execucao	= a.nr_sequencia 
	and	c.cd_unimed_executora	= a.cd_unimed_executora) nr_seq_ret_ordem_serv 
into STRICT	nr_seq_ret_ordem_serv_p 
from	ptu_requisicao_ordem_serv a 
where	a.nr_sequencia = nr_seq_ordem_serv_p;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_processa_ordem_serv ( nr_seq_ordem_serv_p ptu_requisicao_ordem_serv.nr_sequencia%type, ie_possui_pedido_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_ret_ordem_serv_p INOUT ptu_resposta_req_ord_serv.nr_sequencia%type) FROM PUBLIC;

