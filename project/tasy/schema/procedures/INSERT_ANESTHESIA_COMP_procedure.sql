-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_anesthesia_comp ( nr_sequencia_p bigint, nr_cirurgia_p bigint, nr_seq_pepo_p bigint, nm_usuario_p text, DS_LISTA_NR_SEQUENCIA_P text) AS $body$
DECLARE


ds_lista_w 		varchar(10000) := '';
posicao_virgula_w 	integer := 0;
nr_max_loop_w 		integer := 10000;
nr_sequencia_w 		bigint := 0;
tamanho_lista_w		bigint;
ds_observacao_w     varchar(2000);
cd_complicacao_w    bigint;
cd_pessoa_fisica_w  varchar(10) := obter_pessoa_fisica_usuario(wheb_usuario_pck.get_nm_usuario,'C');
			

BEGIN
ds_lista_w := DS_LISTA_NR_SEQUENCIA_P;

while 	(ds_lista_w IS NOT NULL AND ds_lista_w::text <> '') and
	nr_max_loop_w > 0 loop
	begin
	tamanho_lista_w := length(ds_lista_w);
	posicao_virgula_w := position(',' in ds_lista_w);
	
	if (posicao_virgula_w > 1) and ((substr(ds_lista_w, 1, posicao_virgula_w - 1) IS NOT NULL AND (substr(ds_lista_w, 1, posicao_virgula_w - 1))::text <> '')) then
		begin
		nr_sequencia_w := (substr(ds_lista_w, 1, posicao_virgula_w -1))::numeric;
		ds_lista_w := substr(ds_lista_w, (posicao_virgula_w +1), tamanho_lista_w);
		end;
	elsif (ds_lista_w IS NOT NULL AND ds_lista_w::text <> '') then
		nr_sequencia_w := (replace(ds_lista_w, ',', ''))::numeric;
		ds_lista_w := '';
	end if;
	
	if (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') and (nr_sequencia_w > 0) then
		begin
			Select cd_complicacao,ds_observacao
			into STRICT cd_complicacao_w,ds_observacao_w
			from COMPLICACOES_ANEST_ROTINA where coalesce(ie_situacao, 'A')  = 'A'
			and  nr_sequencia  =  nr_sequencia_w;
			
			INSERT INTO ANESTESIA_COMPLICACOES(NR_SEQUENCIA,DT_ATUALIZACAO,NM_USUARIO,DT_ATUALIZACAO_NREC,NM_USUARIO_NREC,CD_COMPLICACAO,
			DS_OBSERVACAO,IE_SITUACAO,NR_CIRURGIA,NR_SEQ_PEPO,CD_PROFISSIONAL)			
			VALUES (nextval('anestesia_complicacoes_seq'),clock_timestamp(),nm_usuario_p,
			clock_timestamp(),nm_usuario_p,cd_complicacao_w,ds_observacao_w,'A',nr_cirurgia_p,nr_seq_pepo_p,cd_pessoa_fisica_w);
			commit;
		end;
	end if;
	nr_max_loop_w := nr_max_loop_w -1;
	end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_anesthesia_comp ( nr_sequencia_p bigint, nr_cirurgia_p bigint, nr_seq_pepo_p bigint, nm_usuario_p text, DS_LISTA_NR_SEQUENCIA_P text) FROM PUBLIC;

