-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_atualiza_obs_tit_mens ( nr_seq_nf_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ds_observacao_w			pls_mensalidade.ds_observacao%type;	
nr_seq_mensalidade_w		nota_fiscal.nr_seq_mensalidade%type;
nr_titulo_w			titulo_receber_liq.nr_titulo%type;
nr_seq_baixa_w			titulo_receber_liq.nr_sequencia%type;


BEGIN 
 
if (nr_seq_nf_p IS NOT NULL AND nr_seq_nf_p::text <> '') then 
 
	select 	max(nr_seq_mensalidade) 
	into STRICT	nr_seq_mensalidade_w 
	from	nota_fiscal 
	where	nr_sequencia = nr_seq_nf_p;
	 
	if (nr_seq_mensalidade_w IS NOT NULL AND nr_seq_mensalidade_w::text <> '') then 
		begin 
		select 	b.ds_motivo || ' - ' || a.ds_obs_cancelamento 
		into STRICT	ds_observacao_w 
		from 	pls_mensalidade a, 
			pls_motivo_canc_mens b 
		where	a.nr_seq_motivo_canc 	= b.nr_sequencia 
		and	a.nr_sequencia		= nr_seq_mensalidade_w;
		exception 
			when others then 
				ds_observacao_w := null;
		end;
		 
		if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then 
 
			select	max(nr_titulo) 
			into STRICT	nr_titulo_w 
			from	titulo_receber 
			where	nr_seq_nf_saida = nr_seq_nf_p;
			 
			if (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then 
 
				select	max(nr_sequencia) 
				into STRICT	nr_seq_baixa_w 
				from	titulo_receber_liq 
				where	nr_titulo = nr_titulo_w;
				 
				if (nr_seq_baixa_w IS NOT NULL AND nr_seq_baixa_w::text <> '') then	 
				 
					update	titulo_receber_liq 
					set	ds_observacao	= ds_observacao_w, 
						nm_usuario 	= nm_usuario_p, 
						dt_atualizacao 	= clock_timestamp()				 
					where	nr_titulo		= nr_titulo_w 
					and	nr_sequencia	= nr_seq_baixa_w;
				 
				end if;
			 
			end if;
 
		end if;				
		 
	end if;
 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_atualiza_obs_tit_mens ( nr_seq_nf_p bigint, nm_usuario_p text) FROM PUBLIC;

