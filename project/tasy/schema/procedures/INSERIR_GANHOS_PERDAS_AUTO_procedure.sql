-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_ganhos_perdas_auto ( nr_atendimento_p bigint, nr_cirurgia_p bigint, cd_setor_atendimento_p bigint, dt_ocorrencia_p timestamp, qt_volume_p bigint, ie_liberado_p text, nr_hora_p bigint, ds_observacao_p text, nm_usuario_p text, qt_ocorrencia_p bigint, nr_seq_pepo_p bigint, nr_sequencia_p bigint, cd_estabelecimento_p bigint, ie_tipo_p bigint, nr_seq_cir_agente_ocor_p bigint) AS $body$
DECLARE

										
										
ie_param_543_w 			varchar(2);
nr_sequencia_w			cirurgia_agente_anestesico.nr_sequencia%type;
cd_material_w			cirurgia_agente_anestesico.cd_material%type;
ie_via_aplicacao_w		cirurgia_agente_anestesico.ie_via_aplicacao%type;
ie_modo_adm_w			cirurgia_agente_anestesico.ie_modo_adm%type;
cd_grupo_material_w		bigint;
cd_classe_material_w	bigint;
cd_subgrupo_material_w	bigint;
nr_seq_tipo_w			prescr_mat_perda_ganho.nr_seq_tipo%type;
ie_permite_w			prescr_mat_perda_ganho_reg.ie_permite%type;
cd_perfil_w				prescr_sol_perda_ganho.cd_perfil%type;
qt_dose_w				double precision;
qt_dose_infusao_w		double precision;
nr_seq_ficha_tecnica_w		medic_ficha_tecnica.nr_sequencia%type;
nr_seq_derivado_w bigint;

c01 CURSOR FOR
SELECT coalesce(b.CD_UNID_MED, a.CD_UNID_MEDIDA_ADM) unidade_medida,  b.*, CASE WHEN a.ie_modo_adm='CO' THEN  'N'  ELSE 'S' END  ie_medicamento
from 	cirurgia_agente_anestesico a,
	cirurgia_agente_anest_ocor b
where	a.nr_sequencia = nr_sequencia_p
and	a.nr_sequencia = b.nr_seq_cirur_agente
order by b.dt_inicio_adm;

BEGIN

cd_perfil_w := obter_perfil_ativo;

select	x.nr_sequencia,
		x.cd_material,
		x.ie_via_aplicacao,
		x.ie_modo_adm
into STRICT	nr_sequencia_w,
		cd_material_w,
		ie_via_aplicacao_w,
		ie_modo_adm_w
from	cirurgia_agente_anestesico x
where	nr_sequencia = nr_sequencia_p;

for c01_w in c01 loop

    if (ie_tipo_p = 2 or (ie_tipo_p in (1, 3) and c01_w.ie_medicamento = 'N')) then
        qt_dose_w := coalesce(c01_w.qt_utilizada, c01_w.qt_dose_ataque);
		if (coalesce(qt_dose_w::text, '') = '') then
			CALL gerar_resumo_agente(nr_cirurgia_p, nm_usuario_p, cd_estabelecimento_p, nr_seq_pepo_p);
			select 	sum(qt_dose)
			into STRICT	qt_dose_w
			from	w_agente_adm
			where	nr_cirurgia = nr_cirurgia_p
			and		nr_seq_cir_agente_ocor = nr_seq_cir_agente_ocor_p;
            if (ie_tipo_p = 2 and (coalesce(qt_dose_w::text, '') = '' or qt_dose_w = 0) and (c01_w.dt_final_adm IS NOT NULL AND c01_w.dt_final_adm::text <> '')) then
                if ( ((c01_w.dt_final_adm - c01_w.dt_inicio_adm)*24) >= 24) then
                    qt_dose_w := c01_w.qt_dose * 24;
                else
                    qt_dose_w := (24*60*(c01_w.dt_final_adm - c01_w.dt_inicio_adm)) * (c01_w.qt_dose / 60);
                end if;
            end if;
		end if;
    else
        if (ie_tipo_p in (3, 1) ) then
            if (c01_w.ie_medicamento = 'S') then
                qt_dose_w := coalesce(c01_w.qt_dose, coalesce(c01_w.qt_dose_total, coalesce(c01_w.qt_utilizada, c01_w.qt_dose_ataque)));
                qt_dose_w := Obter_dose_convertida(cd_material_w,qt_dose_w,c01_w.unidade_medida,'ml');
            end if;
        end if;
	end if;
end loop;

if (ie_tipo_p = 5 or ie_tipo_p = 3 or ie_tipo_p = 2 or ie_tipo_p = 1 ) then


	if (ie_tipo_p = 3 or (ie_tipo_p = 1 and ie_modo_adm_w <> 'CO')) then

        select	max(e.cd_grupo_material),
                max(e.cd_classe_material),
                max(e.cd_subgrupo_material),
                coalesce(max(e.nr_seq_ficha_tecnica),0)
        into STRICT	cd_grupo_material_w,
                cd_classe_material_w,
                cd_subgrupo_material_w,
                nr_seq_ficha_tecnica_w
        from	estrutura_material_v e
        where	cd_material	= cd_material_w;

		select	nr_seq_tipo,
				ie_permite
		into STRICT	nr_seq_tipo_w,
				ie_permite_w
		from (
				SELECT	a.nr_seq_tipo,
						coalesce(b.ie_permite,'S') ie_permite
				from	prescr_mat_perda_ganho a,
						prescr_mat_perda_ganho_reg b
				where	a.nr_sequencia	= b.nr_seq_regra
				and	coalesce(cd_material,cd_material_w)			= cd_material_w
				and	coalesce(cd_grupo_material,cd_grupo_material_w)	= cd_grupo_material_w
				and	coalesce(cd_subgrupo_material,cd_subgrupo_material_w)= cd_subgrupo_material_w
				and	coalesce(cd_classe_material,cd_classe_material_w)	= cd_classe_material_w
				and	coalesce(b.nr_seq_ficha_tecnica,nr_seq_ficha_tecnica_w) = nr_seq_ficha_tecnica_w
				and	coalesce(cd_setor_atendimento,cd_setor_atendimento_p)	= cd_setor_atendimento_p
				and (coalesce(ie_via_aplicacao,ie_via_aplicacao_w) = ie_via_aplicacao_w or (coalesce(ie_via_aplicacao::text, '') = '' and coalesce(ie_via_aplicacao_w::text, '') = ''))
				order by coalesce(cd_material,0) desc,
					coalesce(nr_seq_ficha_tecnica,0) desc,
					coalesce(cd_classe_material,0) desc,
					coalesce(cd_subgrupo_material,0) desc,
					coalesce(cd_grupo_material,0) desc,
					coalesce(cd_setor_atendimento,0) desc,
					coalesce(ie_via_aplicacao,'AAA') desc) alias19 LIMIT 1;

	elsif ((ie_tipo_p = 2 or (ie_tipo_p = 1 and ie_modo_adm_w = 'CO')) and (cd_material_w IS NOT NULL AND cd_material_w::text <> '')) then

		select	nr_seq_tipo,
				ie_permite
		into STRICT	nr_seq_tipo_w,
				ie_permite_w
		from (
				SELECT	nr_seq_tipo,
						coalesce(ie_gerar_evento_solucao,'S') ie_permite
				from	prescr_sol_perda_ganho
				where	coalesce(cd_material,cd_material_w)			= cd_material_w			
				and		coalesce(cd_setor_atendimento,cd_setor_atendimento_p)	= cd_setor_atendimento_p
				and		coalesce(cd_perfil, cd_perfil_w)		= cd_perfil_w
				and     ie_evento = 4
		                and     ie_tipo_solucao = 1
				order by 	coalesce(cd_material,0) desc,
					coalesce(cd_setor_atendimento, 0) desc,
					coalesce(cd_perfil,0) desc) alias11 LIMIT 1;

  elsif (ie_tipo_p = 2 and coalesce(cd_material_w::text, '') = '') then
    ie_permite_w := 'S';
    select max(nr_seq_tipo)
    into STRICT nr_seq_tipo_w 
    from PRESCR_DIETA_PERDA_GANHO LIMIT 1;
  elsif (ie_tipo_p = 5) then

    select b.qt_dose, c.nr_seq_tipo_pg, a.nr_seq_derivado
    into STRICT qt_dose_w, nr_seq_tipo_w, nr_seq_derivado_w
    from cirurgia_agente_anestesico a,
          cirurgia_agente_anest_ocor b,
          san_derivado c
    where b.nr_sequencia = nr_seq_cir_agente_ocor_p
    and a.nr_seq_derivado = c.nr_sequencia
    and a.nr_sequencia = b.nr_seq_cirur_agente;

    select coalesce(nr_seq_tipo, nr_seq_tipo_w),
            ie_permite
    into STRICT nr_seq_tipo_w,
          ie_permite_w
    from (
      SELECT  nr_seq_tipo,
              coalesce(ie_gerar_evento_solucao,'S') ie_permite
      from prescr_sol_perda_ganho
      where  coalesce(nr_seq_derivado,nr_seq_derivado_w) = nr_seq_derivado_w
      and    coalesce(cd_setor_atendimento,cd_setor_atendimento_p) = cd_setor_atendimento_p
      and    coalesce(cd_perfil, cd_perfil_w) = cd_perfil_w
      and    ie_evento = 4
      and    ie_tipo_solucao = 3
      order by 	coalesce(cd_material,0) desc,
        coalesce(cd_setor_atendimento, 0) desc,
        coalesce(cd_perfil,0) desc) alias8 LIMIT 1;

    if ((qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (nr_seq_tipo_w IS NOT NULL AND nr_seq_tipo_w::text <> '') and coalesce(ie_permite_w, 'S') = 'S') then
      ie_permite_w := 'S';
    end if;
  end if;

	if (ie_permite_w = 'S') then		
		CALL inserir_ganho_perda_grafico(nr_atendimento_p,
			nr_cirurgia_p,
			nr_seq_tipo_w,
			cd_setor_atendimento_p,
			dt_ocorrencia_p,
			qt_dose_w,
			'S',
			nr_hora_p,
			ds_observacao_p,
			nm_usuario_p,
			qt_ocorrencia_p,
			nr_seq_pepo_p);			
	end if;		

end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_ganhos_perdas_auto ( nr_atendimento_p bigint, nr_cirurgia_p bigint, cd_setor_atendimento_p bigint, dt_ocorrencia_p timestamp, qt_volume_p bigint, ie_liberado_p text, nr_hora_p bigint, ds_observacao_p text, nm_usuario_p text, qt_ocorrencia_p bigint, nr_seq_pepo_p bigint, nr_sequencia_p bigint, cd_estabelecimento_p bigint, ie_tipo_p bigint, nr_seq_cir_agente_ocor_p bigint) FROM PUBLIC;

