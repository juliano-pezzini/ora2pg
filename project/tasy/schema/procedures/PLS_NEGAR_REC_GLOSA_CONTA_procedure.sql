-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_negar_rec_glosa_conta ( nr_seq_rec_glosa_conta_p pls_rec_glosa_conta.nr_sequencia%type, nr_seq_protocolo_p pls_rec_glosa_protocolo.nr_sequencia%type, ds_justificativa_p pls_rec_glosa_conta.ds_justificativa_oper%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_mot_lib_glosa_p pls_mot_rec_glosa.nr_sequencia%type) AS $body$
DECLARE


vl_ref_w		pls_rec_glosa_conta.vl_total_acatado%type;
qt_glosa_w		integer;
ds_justificativa_w	pls_rec_glosa_conta.ds_justificativa_oper%type;
ie_acao_total_w		pls_rec_glosa_proc.ie_acao_total%type;

C01 CURSOR(nr_seq_protocolo_pc		pls_rec_glosa_protocolo.nr_sequencia%type)FOR
	SELECT	a.nr_sequencia nr_seq_conta_rec,
		(SELECT	count(1)
		 from	pls_rec_glosa_glosas b
		 where	b.nr_seq_conta_rec = a.nr_sequencia
		 and	coalesce(b.nr_seq_proc_rec::text, '') = ''
		 and	coalesce(b.nr_seq_mat_rec::text, '') = '') qt_glosas
	from	pls_rec_glosa_conta a
	where	a.nr_seq_protocolo = nr_seq_protocolo_pc
	group by a.nr_sequencia;

BEGIN
if (nr_seq_rec_glosa_conta_p IS NOT NULL AND nr_seq_rec_glosa_conta_p::text <> '') then

	select	coalesce(ie_acao_total,'N')
	into STRICT	ie_acao_total_w
	from	pls_rec_glosa_conta
	where	nr_sequencia = nr_seq_rec_glosa_conta_p;

	if (ie_acao_total_w = 'S') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(710361); -- Já foi dado um parecer ao atendimento deste recurso. Ação abortada.
	end if;

	select	count(1)
	into STRICT	qt_glosa_w
	from	pls_rec_glosa_glosas
	where	nr_seq_conta_rec = nr_seq_rec_glosa_conta_p
	and	coalesce(nr_seq_proc_rec::text, '') = ''
	and	coalesce(nr_seq_mat_rec::text, '') = '';

	ds_justificativa_w := ds_justificativa_p;

	if (qt_glosa_w = 0) then
		ds_justificativa_w := null;
	end if;

	update	pls_rec_glosa_conta
	set	nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp(),
		ds_justificativa_oper	= ds_justificativa_w,
		vl_total_acatado	= 0
	where	nr_sequencia		= nr_seq_rec_glosa_conta_p;

	update	pls_rec_glosa_proc a
	set	a.vl_acatado		= 0,
		a.ds_justificativa_oper	= ds_justificativa_p,
		a.ie_status		= '4'
	where	a.nr_seq_conta_rec	= nr_seq_rec_glosa_conta_p;

	update	pls_rec_glosa_mat a
	set	a.vl_acatado		= 0,
		a.ds_justificativa_oper	= ds_justificativa_p,
		a.ie_status		= '4'
	where	a.nr_seq_conta_rec	= nr_seq_rec_glosa_conta_p;

	CALL pls_atualizar_valor_recurso(nr_seq_rec_glosa_conta_p,'C',nm_usuario_p);

	select	vl_total_recursado
	into STRICT	vl_ref_w
	from	pls_rec_glosa_conta
	where	nr_sequencia = nr_seq_rec_glosa_conta_p;

	CALL pls_gerar_log_rec_glosa( 'N', vl_ref_w, nr_seq_rec_glosa_conta_p, nm_usuario_p, 'C', null, nr_seq_mot_lib_glosa_p);

elsif (nr_seq_protocolo_p IS NOT NULL AND nr_seq_protocolo_p::text <> '') then
	for r_C01_w in C01(nr_seq_protocolo_p) loop

		ds_justificativa_w := ds_justificativa_p;

		if (r_C01_w.qt_glosas = 0) then
			ds_justificativa_w := null;
		end if;

		update	pls_rec_glosa_conta
		set	nm_usuario		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp(),
			ds_justificativa_oper	= ds_justificativa_w,
			vl_total_acatado	= 0
		where	nr_sequencia		= r_C01_w.nr_seq_conta_rec;

		update	pls_rec_glosa_proc a
		set	a.vl_acatado		= 0,
			a.ds_justificativa_oper	= ds_justificativa_p,
			a.ie_status		= '4'
		where	a.nr_seq_conta_rec	= r_C01_w.nr_seq_conta_rec;

		update	pls_rec_glosa_mat a
		set	a.vl_acatado		= 0,
			a.ds_justificativa_oper	= ds_justificativa_p,
			a.ie_status		= '4'
		where	a.nr_seq_conta_rec	= r_C01_w.nr_seq_conta_rec;

		CALL pls_atualizar_valor_recurso(r_C01_w.nr_seq_conta_rec,'C',nm_usuario_p);

		select	vl_total_recursado
		into STRICT	vl_ref_w
		from	pls_rec_glosa_conta
		where	nr_sequencia = r_C01_w.nr_seq_conta_rec;

		CALL pls_gerar_log_rec_glosa( 'N', vl_ref_w, r_C01_w.nr_seq_conta_rec, nm_usuario_p, 'C', null, nr_seq_mot_lib_glosa_p);
	end loop;

	-- Atualiza a justificativa do protocolo, somente deve ser atualizado a
	-- justificativa do protocolo quando a ação for a nível de protocolo
	update	pls_rec_glosa_protocolo
	set	ds_justificativa_oper	= ds_justificativa_p,
		nm_usuario 		= nm_usuario_p,
		dt_atualizacao 		= clock_timestamp()
	where	nr_sequencia 		= nr_seq_protocolo_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_negar_rec_glosa_conta ( nr_seq_rec_glosa_conta_p pls_rec_glosa_conta.nr_sequencia%type, nr_seq_protocolo_p pls_rec_glosa_protocolo.nr_sequencia%type, ds_justificativa_p pls_rec_glosa_conta.ds_justificativa_oper%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_mot_lib_glosa_p pls_mot_rec_glosa.nr_sequencia%type) FROM PUBLIC;

