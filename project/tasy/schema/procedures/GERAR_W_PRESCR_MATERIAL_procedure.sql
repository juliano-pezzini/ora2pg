-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_prescr_material (nr_prescricao_p bigint, cd_estabelecimento_p bigint, cd_local_estoque_p bigint, nm_usuario_p text) AS $body$
DECLARE


varQuimio_w			varchar(1);/*Parâmetro 24 */
varFiltraLocalEstoque_w		varchar(1);/*Parâmetro 22 */
var_ACM_SN_Pend_w		varchar(1);/*Parâmetro 25 */
varIe_Baixa_Compl_w		varchar(1);/*Parâmetro 26 */
VarGenerico_w			varchar(1);/*Parâmetro 8  */
VarManterPendentes_w		varchar(1);/*Parâmetro 27 */
VarNPT_w			varchar(1);/*Parâmetro 29 */
nr_agrupamento_w		integer;
nr_sequencia_w			integer;
ie_agrupador_w			smallint;
qt_unitaria_w			double precision;
cd_material_w			integer;
ds_material_w			varchar(100);
qt_material_w			double precision;
qt_dose_w			double precision;
cd_unidade_medida_dose_w	varchar(30);
ie_via_aplicacao_w		varchar(5);
qt_total_dispensar_w		double precision;
cd_intervalo_w			varchar(7);
nm_usuario_w			varchar(15);
cd_unidade_medida_w		varchar(30);
ds_horarios_w			varchar(254);
hr_prim_horario_w		varchar(5);
ds_observacao_w			varchar(254);
ds_justificativa_w		varchar(254);
cd_fornec_consignado_w		varchar(14);
nr_ocorrencia_w			bigint;
ie_urgencia_w			varchar(1);
ie_utiliza_kit_w		varchar(1);
ie_suspenso_w			varchar(1);
ie_origem_inf_w			varchar(1);
ie_baixa_inteira_w		varchar(1);
cd_grupo_mat_w			bigint;
ie_consignado_w			varchar(1);
ds_fornecedor_w			varchar(60);
ds_via_w			varchar(40);
ds_origem_w			varchar(100);
nr_seq_item_origem_w		integer;
cd_item_origem_w		bigint;
cd_kit_mat_w			integer;
ds_kit_mat_w			varchar(100);
qt_atendido_w			double precision;
ie_saldo_atend_w		varchar(1);
qt_devolvido_w			double precision;
qt_dias_solicitado_w		smallint;
qt_dias_liberado_w		smallint;

C01 CURSOR FOR
	SELECT 	a.nr_agrupamento,
		a.nr_sequencia,
		a.ie_agrupador,
		a.qt_unitaria,
		a.cd_material,
		a.qt_dose,
		a.cd_unidade_medida_dose,
		a.ie_via_aplicacao,
		a.cd_intervalo,
		a.nm_usuario,
		a.cd_unidade_medida,
		a.hr_prim_horario,
		substr(a.ds_observacao,1,254) ds_observacao,
		substr(a.ds_justificativa,1,254) ds_justificativa,
		a.cd_fornec_consignado,
		a.nr_ocorrencia,
		coalesce(a.ie_urgencia,'N') ie_urgencia,
		coalesce(a.ie_utiliza_kit,'N') ie_utiliza_kit,
		coalesce(a.ie_suspenso,'N') ie_suspenso,
		a.ie_origem_inf,
		CASE WHEN varIe_Baixa_Compl_w='N' THEN  a.qt_material  ELSE a.qt_material - Obter_qt_mat_atend_pac(a.nr_prescricao,a.nr_sequencia) END  qt_material,
		CASE WHEN varIe_Baixa_Compl_w='N' THEN  coalesce(a.qt_total_dispensar,0)  ELSE coalesce(a.qt_total_dispensar,0) - Obter_qt_mat_atend_pac(a.nr_prescricao,a.nr_sequencia) END  qt_total_dispensar,
		substr(CASE WHEN VarGenerico_w='N' THEN b.ds_material  ELSE substr(obter_desc_material(obter_material_generico(a.cd_material)),1,100) END ,1,100) ds_material,
		b.ie_baixa_inteira,
		obter_estrutura_material(a.cd_material, 'G') cd_grupo_mat,
		substr(a.ds_horarios,1,254) ds_horarios,
		b.ie_consignado,
		substr(obter_razao_social(cd_fornec_consignado),1,60) ds_fornecedor,
		substr(obter_valor_dominio(14, a.ie_via_aplicacao),1,40) ds_via,
		CASE WHEN coalesce(a.nr_seq_kit::text, '') = '' THEN  substr(obter_valor_dominio(1131, a.ie_agrupador),1,100)  ELSE obter_desc_expressao(350335)/*'kit material'*/
 END  ds_origem,
		coalesce(a.nr_sequencia_diluicao, a.nr_seq_kit) nr_seq_item_origem,
		obter_material_origem_item(a.nr_prescricao, coalesce(a.nr_sequencia_diluicao, a.nr_seq_kit)) cd_item_origem,
		CASE WHEN coalesce(a.cd_kit_material::text, '') = '' THEN  ''  ELSE a.cd_kit_material END  cd_kit_mat,
		CASE WHEN coalesce(a.cd_kit_material::text, '') = '' THEN  ''  ELSE substr(obter_desc_kit(a.cd_kit_material),1,100) END  ds_kit_mat,
		Obter_qt_mat_atend_pac(a.nr_prescricao,a.nr_sequencia) qt_atendido,
		Obter_Saldo_Prescr_Atend(a.cd_material, a.nr_prescricao, a.nr_sequencia) ie_saldo_atend,
		Obter_qt_mat_devol_pac(a.nr_prescricao,a.nr_sequencia) qt_devolvido,
		qt_dias_solicitado,
		qt_dias_liberado
	from  	material b,
		prescr_material  a
	where 	a.cd_material       = b.cd_material
	and 	a.nr_prescricao     = nr_prescricao_p
	and 	coalesce(a.ie_medicacao_paciente,'N') <> 'S'
	and 	coalesce(a.ie_suspenso,'N') <> 'S'
	and 	((varQuimio_w = 'N' and b.ie_mistura = 'N') or (varQuimio_w = 'S'))
	and 	((varFiltraLocalEstoque_w = 'S' and cd_local_estoque_p <> 0 and (coalesce(a.cd_local_estoque::text, '') = '' or a.cd_local_estoque = cd_local_estoque_p)) or
		((varFiltraLocalEstoque_w = 'N') or (cd_local_estoque_p = 0)))
	and 	((var_ACM_SN_Pend_w = 'S' and ((A.cd_motivo_baixa = 0) or (a.ie_acm = 'S') or (a.ie_se_necessario = 'S'))) or (var_ACM_SN_Pend_w = 'N'))
	and 	((VarManterPendentes_w = 'N' and var_ACM_SN_Pend_w = 'N' and  a.cd_motivo_baixa = 0) or
		((VarManterPendentes_w = 'S') or (var_ACM_SN_Pend_w = 'S')))
	and 	((VarNPT_w = 'N' and a.ie_agrupador not in (10,11)) or (VarNPT_w = 'S'))
	order by a.ie_urgencia desc, a.nr_prescricao desc;


BEGIN

varQuimio_w := obter_param_usuario(7025, 24, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, varQuimio_w);
varFiltraLocalEstoque_w := obter_param_usuario(7025, 22, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, varFiltraLocalEstoque_w);
var_ACM_SN_Pend_w := obter_param_usuario(7025, 25, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, var_ACM_SN_Pend_w);
varIe_Baixa_Compl_w := obter_param_usuario(7025, 26, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, varIe_Baixa_Compl_w);
VarGenerico_w := obter_param_usuario(7025, 8, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, VarGenerico_w);
VarManterPendentes_w := obter_param_usuario(7025, 27, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, VarManterPendentes_w);
VarNPT_w := obter_param_usuario(7025, 29, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, VarNPT_w);

delete	from w_prescr_material
where	nr_prescricao = nr_prescricao_p;

open C01;
loop
fetch C01 into
	nr_agrupamento_w,
	nr_sequencia_w,
	ie_agrupador_w,
	qt_unitaria_w,
	cd_material_w,
	qt_dose_w,
	cd_unidade_medida_dose_w,
	ie_via_aplicacao_w,
	cd_intervalo_w,
	nm_usuario_w,
	cd_unidade_medida_w,
	hr_prim_horario_w,
	ds_observacao_w,
	ds_justificativa_w,
	cd_fornec_consignado_w,
	nr_ocorrencia_w,
	ie_urgencia_w,
	ie_utiliza_kit_w,
	ie_suspenso_w,
	ie_origem_inf_w,
	qt_material_w,
	qt_total_dispensar_w,
	ds_material_w,
	ie_baixa_inteira_w,
	cd_grupo_mat_w,
	ds_horarios_w,
	ie_consignado_w,
	ds_fornecedor_w,
	ds_via_w,
	ds_origem_w,
	nr_seq_item_origem_w,
	cd_item_origem_w,
	cd_kit_mat_w,
	ds_kit_mat_w,
	qt_atendido_w,
	ie_saldo_atend_w,
	qt_devolvido_w,
	qt_dias_solicitado_w,
	qt_dias_liberado_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	insert into w_prescr_material(
			nr_sequencia,
			nr_prescricao,
			nr_agrupamento,
			nr_sequencia_prescricao,
			ie_agrupador,
			qt_unitaria,
			cd_material,
			qt_dose,
			cd_unidade_medida_dose,
			ie_via_aplicacao,
			cd_intervalo,
			nm_usuario,
			cd_unidade_medida,
			hr_prim_horario,
			ds_observacao,
			ds_justificativa,
			cd_fornec_consignado,
			nr_ocorrencia,
			ie_urgencia,
			ie_utiliza_kit,
			ie_suspenso,
			ie_origem_inf,
			qt_material,
			qt_total_dispensar,
			ds_material,
			ie_baixa_inteira,
			cd_grupo_mat,
			ds_horarios,
			ie_consignado,
			ds_fornecedor,
			ds_via,
			ds_origem,
			nr_seq_item_origem,
			cd_item_origem,
			cd_kit_mat,
			ds_kit_mat,
			qt_atendido,
			ie_saldo_atend,
			qt_devolvido,
			qt_dias_solicitado,
			qt_dias_liberado)
		values (nextval('w_prescr_material_seq'),
			nr_prescricao_p,
			nr_agrupamento_w,
			nr_sequencia_w,
			ie_agrupador_w,
			qt_unitaria_w,
			cd_material_w,
			qt_dose_w,
			cd_unidade_medida_dose_w,
			ie_via_aplicacao_w,
			cd_intervalo_w,
			nm_usuario_w,
			cd_unidade_medida_w,
			hr_prim_horario_w,
			ds_observacao_w,
			ds_justificativa_w,
			cd_fornec_consignado_w,
			nr_ocorrencia_w,
			ie_urgencia_w,
			ie_utiliza_kit_w,
			ie_suspenso_w,
			ie_origem_inf_w,
			qt_material_w,
			qt_total_dispensar_w,
			ds_material_w,
			ie_baixa_inteira_w,
			cd_grupo_mat_w,
			ds_horarios_w,
			ie_consignado_w,
			ds_fornecedor_w,
			ds_via_w,
			ds_origem_w,
			nr_seq_item_origem_w,
			cd_item_origem_w,
			cd_kit_mat_w,
			ds_kit_mat_w,
			qt_atendido_w,
			ie_saldo_atend_w,
			qt_devolvido_w,
			qt_dias_solicitado_w,
			qt_dias_liberado_w);
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_prescr_material (nr_prescricao_p bigint, cd_estabelecimento_p bigint, cd_local_estoque_p bigint, nm_usuario_p text) FROM PUBLIC;

