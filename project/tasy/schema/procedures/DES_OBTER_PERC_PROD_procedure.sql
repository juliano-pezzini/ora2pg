-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE des_obter_perc_prod ( dt_referencia_p timestamp, nm_usuario_p text, pr_dia_p INOUT bigint, pr_ativ_regist_p INOUT bigint, pr_os_feitas_p INOUT bigint) AS $body$
DECLARE

 
qt_desconto_w	bigint	:= 0;
qt_minutos_w	bigint	:= 0;


BEGIN 
 
 
 
IF (dt_referencia_p	> TO_DATE(TO_CHAR(dt_referencia_p,'dd/mm/yyyy') || '12:00:00','dd/mm/yyyy hh24:mi:ss')) THEN 
	qt_desconto_w	:= 60;
END IF;
 
IF (dt_referencia_p	> TO_DATE(TO_CHAR(dt_referencia_p,'dd/mm/yyyy') || '09:00:00','dd/mm/yyyy hh24:mi:ss')) THEN 
	qt_desconto_w	:= qt_desconto_w + 15;
END IF;
 
IF (dt_referencia_p	> TO_DATE(TO_CHAR(dt_referencia_p,'dd/mm/yyyy') || '15:00:00','dd/mm/yyyy hh24:mi:ss')) THEN 
	qt_desconto_w	:= qt_desconto_w + 15;
END IF;
 
qt_minutos_w	:= TRUNC(((TO_DATE(TO_CHAR(dt_referencia_p,'dd/mm/yyyy') || '18:00:00','dd/mm/yyyy hh24:mi:ss') - dt_referencia_p)*1440) - 90);
 
IF (dt_referencia_p	< TO_DATE(TO_CHAR(dt_referencia_p,'dd/mm/yyyy') || '08:00:00','dd/mm/yyyy hh24:mi:ss')) THEN 
	qt_minutos_w	:= 510;
ELSIF (qt_minutos_w < 0) THEN 
	qt_minutos_w	:= 0;
ELSE 
	qt_minutos_w	:= 510 - qt_minutos_w;
END IF;
 
IF (qt_minutos_w = 0) THEN 
	pr_dia_p	:= 100;
ELSE 
	pr_dia_p	:= TRUNC((qt_minutos_w * 100) / 510);
 
END IF;
 
 
--SELECT	nvl(TRUNC(SUM(man_obter_min_ordem_real_usu(y.nr_seq_ordem_serv,y.nm_usuario_prev, y.dt_prevista)) / SUM(y.qt_min_prev) * 100),0) pr_min_exec_prev_p 
SELECT	coalesce(TRUNC(SUM(man_obter_min_ordem_real_usu(y.nr_seq_ordem_serv,y.nm_usuario_prev, y.dt_prevista)) / 510 * 100),0) pr_min_exec_prev_p 
INTO STRICT	pr_ativ_regist_p 
FROM	man_ordem_ativ_prev	y, 
	man_estagio_processo	b, 
	man_ordem_servico_v	a 
WHERE	a.nr_seq_estagio		= b.nr_sequencia 
AND	a.nr_sequencia		= y.nr_seq_ordem_serv 
AND	y.nm_usuario_prev		= nm_usuario_p 
AND	y.dt_prevista BETWEEN TRUNC(TO_DATE(dt_referencia_p),'dd') AND fim_dia(TO_DATE(dt_referencia_p)) 
AND (coalesce(b.ie_situacao_os,'0') <> '3' OR EXISTS (SELECT	1 
					FROM	man_ordem_serv_ativ x 
					WHERE	x.nr_seq_ordem_serv = a.nr_sequencia 
					AND	x.nm_usuario_exec = y.nm_usuario_prev 
					AND	TRUNC(x.dt_atividade,'dd') = TRUNC(y.dt_prevista,'dd')));
 
 
SELECT	TRUNC(coalesce(SUM(CASE WHEN coalesce(dt_real::text, '') = '' THEN dividir(man_obter_min_ordem_real_usu(y.nr_seq_ordem_serv,y.nm_usuario_prev, y.dt_prevista),y.qt_min_prev)  ELSE 1 END *100) / COUNT(*),0)) 
INTO STRICT	pr_os_feitas_p 
FROM	man_ordem_ativ_prev	y, 
	man_estagio_processo	b, 
	man_ordem_servico_v	a 
WHERE	a.nr_seq_estagio		= b.nr_sequencia 
AND	a.nr_sequencia		= y.nr_seq_ordem_serv 
AND	y.nm_usuario_prev		= nm_usuario_p 
AND	y.dt_prevista BETWEEN TRUNC(TO_DATE(dt_referencia_p),'dd') AND fim_dia(TO_DATE(dt_referencia_p)) 
AND (coalesce(b.ie_situacao_os,'0') <> '3' OR EXISTS (SELECT	1 
					FROM	man_ordem_serv_ativ x 
					WHERE	x.nr_seq_ordem_serv = a.nr_sequencia 
					AND	x.nm_usuario_exec = y.nm_usuario_prev 
					AND	TRUNC(x.dt_atividade,'dd') = TRUNC(y.dt_prevista,'dd')));
 
 
 
COMMIT;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE des_obter_perc_prod ( dt_referencia_p timestamp, nm_usuario_p text, pr_dia_p INOUT bigint, pr_ativ_regist_p INOUT bigint, pr_os_feitas_p INOUT bigint) FROM PUBLIC;

