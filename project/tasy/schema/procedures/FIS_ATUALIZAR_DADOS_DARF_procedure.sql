-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_atualizar_dados_darf (nr_sequencia_p bigint, nr_titulo_p bigint, nm_usuario_p text, ie_tipo_p text default 'S') AS $body$
DECLARE


/*
S - Soma o valor
D- Dimiui o valor
*/
vl_juros_titulo_w	titulo_pagar.vl_saldo_juros%type;
vl_multa_titulo_w	titulo_pagar.vl_saldo_multa%type;
ie_permite_juros_multas_tit_w	varchar(1);


BEGIN

ie_permite_juros_multas_tit_w := obter_param_usuario(5500, 23, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_permite_juros_multas_tit_w);

if (nr_sequencia_p > 0) and (nr_titulo_p > 0) and (ie_permite_juros_multas_tit_w = 'S') then
	begin

	select	CASE WHEN ie_tipo_p='D' THEN (sum(coalesce(vl_saldo_juros,0)) * -1)  ELSE sum(coalesce(vl_saldo_juros,0)) END ,
		CASE WHEN ie_tipo_p='D' THEN (sum(coalesce(vl_saldo_multa,0)) * -1)  ELSE sum(coalesce(vl_saldo_multa,0)) END
	into STRICT	vl_juros_titulo_w,
		vl_multa_titulo_w
	from	titulo_pagar p
	where	nr_titulo = nr_titulo_p;

	update	darf
	set	vl_juros	= CASE WHEN(coalesce(vl_juros,0) + vl_juros_titulo_w)=abs(coalesce(vl_juros,0) + vl_juros_titulo_w) THEN (coalesce(vl_juros,0) + vl_juros_titulo_w)  ELSE 0 END ,
		vl_multa	= CASE WHEN(coalesce(vl_multa,0) + vl_multa_titulo_w)=abs(coalesce(vl_multa,0) + vl_multa_titulo_w) THEN (coalesce(vl_multa,0) + vl_multa_titulo_w)  ELSE 0 END ,
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_sequencia_p;

	commit;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_atualizar_dados_darf (nr_sequencia_p bigint, nr_titulo_p bigint, nm_usuario_p text, ie_tipo_p text default 'S') FROM PUBLIC;

