-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE importar_cid_tasymed_tasy (cd_pessoa_fisica_p text, cd_medico_p text, nr_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_cliente_w	bigint;
qt_cid_w		bigint;
dt_diagnostico_w	timestamp;



BEGIN

select	max(nr_sequencia)
into STRICT	nr_seq_cliente_w
from	med_cliente
where	cd_medico		= cd_medico_p
and	cd_pessoa_fisica	= cd_pessoa_fisica_p;

select	count(a.nr_seq_cliente)
into STRICT	qt_cid_w
from	med_pac_cid a
where	a.nr_seq_cliente	= nr_seq_cliente_w
and	not exists (SELECT	1
			from	diagnostico_doenca b,
				diagnostico_medico c
			where	b.nr_atendimento	= c.nr_atendimento
			and	b.dt_diagnostico	= c.dt_diagnostico
			and	c.nr_atendimento	= nr_atendimento_p
			and	b.cd_doenca		= a.cd_doenca_cid);

if (qt_cid_w > 0) then
	dt_diagnostico_w	:= clock_timestamp();
	insert into diagnostico_medico(
		nr_atendimento,
		dt_diagnostico,
		ie_tipo_diagnostico,
		cd_medico,
		dt_atualizacao,
		nm_usuario)
	Values (	nr_atendimento_p,
		dt_diagnostico_w,
		1,
		cd_medico_p,
		clock_timestamp(),
		nm_usuario_p);

	insert into diagnostico_doenca(
		nr_atendimento,
		dt_diagnostico,
		cd_doenca,
		dt_atualizacao,
		nm_usuario,
		ds_diagnostico,
		ie_classificacao_doenca)
	SELECT	nr_atendimento_p,
		dt_diagnostico_w,
		a.cd_doenca_cid,
		clock_timestamp(),
		nm_usuario_p,
		a.ds_observacao,
		'S'
	from	med_pac_cid a
	where	a.nr_seq_cliente	= nr_seq_cliente_w
	and	not exists (SELECT	1
				from	diagnostico_doenca b,
					diagnostico_medico c
				where	b.nr_atendimento	= c.nr_atendimento
				and	b.dt_diagnostico	= c.dt_diagnostico
				and	c.nr_atendimento	= nr_atendimento_p
				and	b.cd_doenca		= a.cd_doenca_cid);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importar_cid_tasymed_tasy (cd_pessoa_fisica_p text, cd_medico_p text, nr_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

