-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_regra_lib_estipu ( nr_seq_guia_p bigint, nr_seq_requisicao_p bigint, nr_seq_regra_p INOUT bigint) AS $body$
DECLARE

 
nr_seq_contrato_w		pls_contrato.nr_sequencia%type;
nr_seq_plano_w			pls_plano.nr_sequencia%type;
qt_regra_pos_estab_w		bigint;
cd_area_w			bigint;
cd_especialidade_w		bigint;
cd_grupo_w			bigint;
cd_procedimento_w		procedimento.cd_procedimento%type;
ie_origem_proced_w		bigint;
nr_seq_regra_pos_estab_w	bigint;
ie_liberado_w			varchar(1);
vl_procedimento_w		double precision;
vl_material_w			double precision;
nr_seq_regra_w			bigint;
nr_seq_regra_ww			bigint;
nr_seq_intercambio_w		pls_intercambio.nr_sequencia%type;
nr_seq_material_w		pls_material.nr_sequencia%type;
nr_seq_grupo_servico_w		pls_preco_grupo_servico.nr_sequencia%type;
ie_grupo_w			varchar(1) := 'N';
nr_seq_grupo_material_w		pls_preco_grupo_material.nr_sequencia%type;

C01 CURSOR FOR 
	SELECT	cd_procedimento, 
		ie_origem_proced, 
		vl_procedimento 
	from	pls_guia_plano_proc 
	where	nr_seq_guia = nr_seq_guia_p 
	order by 1;

C02 CURSOR FOR 
	SELECT	cd_procedimento, 
		ie_origem_proced 
	from	pls_requisicao_proc 
	where	nr_seq_requisicao = nr_seq_requisicao_p 
	and	ie_status in ('P','S') 
	order by 1;

C03 CURSOR FOR 
	SELECT 	nr_sequencia, 
			ie_liberado, 
			nr_sequencia_b, 
			nr_seq_grupo_servico 
	from ( 
		SELECT	a.nr_sequencia nr_sequencia, 
			c.ie_liberado ie_liberado, 
			b.nr_sequencia nr_sequencia_b, 
			c.nr_seq_grupo_servico nr_seq_grupo_servico, 
			c.cd_area_procedimento cd_area_procedimento, 
			c.cd_especialidade cd_especialidade, 
			c.cd_grupo_proc cd_grupo_proc, 
			c.cd_procedimento cd_procedimento 
		from	pls_tipo_pos_estab_proc		c, 
			pls_pos_estab_aut_previa	b, 
			pls_tipo_pos_estabelecido	a 
		where	c.nr_seq_tipo_pos_estab = a.nr_sequencia 
		and	b.nr_seq_tipo_pos_estab	= a.nr_sequencia 
		and	coalesce(c.cd_procedimento,cd_procedimento_w)	= cd_procedimento_w 
		and	coalesce(c.ie_origem_proced,ie_origem_proced_w)	= ie_origem_proced_w 
		and   coalesce(c.cd_grupo_proc,cd_grupo_w)         = cd_grupo_w 
		and   coalesce(c.cd_especialidade, cd_especialidade_w)   = cd_especialidade_w 
		and   coalesce(c.cd_area_procedimento, cd_area_w)     = cd_area_w 
		and	coalesce(c.vl_liberado,0) <= coalesce(vl_procedimento_w,0) 
		and	coalesce(c.nr_seq_grupo_material::text, '') = '' 
		and	b.ie_situacao = 'A' 
		and	a.ie_situacao = 'A' 
		and (b.nr_seq_contrato = coalesce(nr_seq_contrato_w,0) 
		or	b.nr_seq_intercambio = coalesce(nr_seq_intercambio_w,0)) 
		and (a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento and pls_obter_se_controle_estab('RE') = 'S') 
		
union all
 
		select	a.nr_sequencia nr_sequencia, 
			c.ie_liberado ie_liberado, 
			b.nr_sequencia nr_sequencia_b, 
			c.nr_seq_grupo_servico nr_seq_grupo_servico, 
			c.cd_area_procedimento cd_area_procedimento, 
			c.cd_especialidade cd_especialidade, 
			c.cd_grupo_proc cd_grupo_proc, 
			c.cd_procedimento cd_procedimento 
		from	pls_tipo_pos_estab_proc		c, 
			pls_pos_estab_aut_previa	b, 
			pls_tipo_pos_estabelecido	a 
		where	c.nr_seq_tipo_pos_estab = a.nr_sequencia 
		and	b.nr_seq_tipo_pos_estab	= a.nr_sequencia 
		and	coalesce(c.cd_procedimento,cd_procedimento_w)	= cd_procedimento_w 
		and	coalesce(c.ie_origem_proced,ie_origem_proced_w)	= ie_origem_proced_w 
		and   coalesce(c.cd_grupo_proc,cd_grupo_w)         = cd_grupo_w 
		and   coalesce(c.cd_especialidade, cd_especialidade_w)   = cd_especialidade_w 
		and   coalesce(c.cd_area_procedimento, cd_area_w)     = cd_area_w 
		and	coalesce(c.vl_liberado,0) <= coalesce(vl_procedimento_w,0) 
		and	coalesce(c.nr_seq_grupo_material::text, '') = '' 
		and	b.ie_situacao = 'A' 
		and	a.ie_situacao = 'A' 
		and (b.nr_seq_contrato = coalesce(nr_seq_contrato_w,0) 
		or	b.nr_seq_intercambio = coalesce(nr_seq_intercambio_w,0)) 
		and 	pls_obter_se_controle_estab('RE') = 'N') alias25 
	order by 	coalesce(cd_area_procedimento,-1), 
        coalesce(cd_especialidade,-1), 
        coalesce(cd_grupo_proc,-1), 
        coalesce(cd_procedimento,-1);

C04 CURSOR FOR 
	SELECT	nr_seq_material, 
		vl_material 
	from	pls_guia_plano_mat 
	where	nr_seq_guia = nr_seq_guia_p 
	order by 1;

C05 CURSOR FOR 
	SELECT	nr_seq_material 
	from	pls_requisicao_mat 
	where	nr_seq_requisicao = nr_seq_requisicao_p 
	and	ie_status in ('P','S') 
	order by 1;

C06 CURSOR FOR 
	SELECT 	nr_sequencia, 
			ie_liberado, 
			nr_seq_grupo_material 
	from ( 
		SELECT	a.nr_sequencia nr_sequencia, 
			c.ie_liberado ie_liberado, 
			c.nr_seq_grupo_material nr_seq_grupo_material, 
			c.cd_area_procedimento cd_area_procedimento, 
			c.cd_especialidade cd_especialidade, 
			c.cd_grupo_proc cd_grupo_proc, 
			c.cd_procedimento cd_procedimento 
		from	pls_tipo_pos_estab_proc		c, 
				pls_pos_estab_aut_previa	b, 
				pls_tipo_pos_estabelecido	a 
		where	c.nr_seq_tipo_pos_estab = a.nr_sequencia 
		and	b.nr_seq_tipo_pos_estab	= a.nr_sequencia 
		and	coalesce(c.vl_liberado,0) <= coalesce(vl_material_w,0) 
		and	coalesce(c.cd_procedimento::text, '') = '' 
		and 	coalesce(c.cd_grupo_proc::text, '') = '' 
		and 	coalesce(c.cd_especialidade::text, '') = '' 
		and 	coalesce(c.cd_area_procedimento::text, '') = '' 
		and	coalesce(c.nr_seq_grupo_servico::text, '') = '' 
		and	b.ie_situacao = 'A' 
		and	a.ie_situacao = 'A' 
		and (b.nr_seq_contrato = coalesce(nr_seq_contrato_w,0) 
		or	b.nr_seq_intercambio = coalesce(nr_seq_intercambio_w,0)) 
		and (a.cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento and pls_obter_se_controle_estab('RE') = 'S') 
		
union all
 
		select	a.nr_sequencia nr_sequencia, 
			c.ie_liberado ie_liberado, 
			c.nr_seq_grupo_material nr_seq_grupo_material, 
			c.cd_area_procedimento cd_area_procedimento, 
			c.cd_especialidade cd_especialidade, 
			c.cd_grupo_proc cd_grupo_proc, 
			c.cd_procedimento cd_procedimento 
		from	pls_tipo_pos_estab_proc		c, 
			pls_pos_estab_aut_previa	b, 
			pls_tipo_pos_estabelecido	a 
		where	c.nr_seq_tipo_pos_estab = a.nr_sequencia 
		and	b.nr_seq_tipo_pos_estab	= a.nr_sequencia 
		and	coalesce(c.vl_liberado,0) <= coalesce(vl_material_w,0) 
		and	coalesce(c.cd_procedimento::text, '') = '' 
		and 	coalesce(c.cd_grupo_proc::text, '') = '' 
		and 	coalesce(c.cd_especialidade::text, '') = '' 
		and 	coalesce(c.cd_area_procedimento::text, '') = '' 
		and	coalesce(c.nr_seq_grupo_servico::text, '') = '' 
		and	b.ie_situacao = 'A' 
		and	a.ie_situacao = 'A' 
		and (b.nr_seq_contrato = coalesce(nr_seq_contrato_w,0) 
		or	b.nr_seq_intercambio = coalesce(nr_seq_intercambio_w,0)) 
		and 	pls_obter_se_controle_estab('RE') = 'N') alias23 
	order by cd_area_procedimento, 
        cd_especialidade, 
        cd_grupo_proc, 
        cd_procedimento;


BEGIN 
 
if (coalesce(nr_seq_guia_p,0) <> 0) then 
	select	b.nr_seq_contrato, 
		b.nr_seq_intercambio, 
		b.nr_seq_plano 
	into STRICT	nr_seq_contrato_w, 
		nr_seq_intercambio_w, 
		nr_seq_plano_w 
	from	pls_segurado	b, 
		pls_guia_plano	a 
	where	a.nr_seq_segurado	= b.nr_sequencia 
	and	a.nr_sequencia		= nr_seq_guia_p;
 
	open C01;
	loop 
	fetch C01 into 
		cd_procedimento_w, 
		ie_origem_proced_w, 
		vl_procedimento_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		SELECT * FROM pls_obter_estrut_proc(cd_procedimento_w, ie_origem_proced_w, cd_area_w, cd_especialidade_w, cd_grupo_w, ie_origem_proced_w) INTO STRICT cd_area_w, cd_especialidade_w, cd_grupo_w, ie_origem_proced_w;
		open C03;
		loop 
		fetch C03 into 
			nr_seq_regra_ww, 
			ie_liberado_w, 
			nr_seq_regra_pos_estab_w, 
			nr_seq_grupo_servico_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin 
			ie_grupo_w	:= 'S';
			if (coalesce(nr_seq_grupo_servico_w,0) > 0) then 
				ie_grupo_w	:= pls_se_grupo_preco_servico(nr_seq_grupo_servico_w, cd_procedimento_w, ie_origem_proced_w);
			end if;
 
			if (coalesce(ie_grupo_w,'S') = 'S') and (ie_liberado_w = 'N') then 
				nr_seq_regra_w	:= nr_seq_regra_ww;
			else 
				nr_seq_regra_w	:= 0;
			end if;
			end;
		end loop;
		close C03;
		end;
	end loop;
	close C01;
 
	/*Se não entrou em nehuma regra dos procdimentos , então é verificado se entra em alguma regra do grupo de materiais */
 
	if (coalesce(nr_seq_regra_w,0) = 0) then 
		open C04;
		loop 
		fetch C04 into 
			nr_seq_material_w, 
			vl_material_w;
		EXIT WHEN NOT FOUND; /* apply on C04 */
			begin 
			open C06;
			loop 
			fetch C06 into 
				nr_seq_regra_ww, 
				ie_liberado_w, 
				nr_seq_grupo_material_w;
			EXIT WHEN NOT FOUND; /* apply on C06 */
				begin 
				ie_grupo_w	:= 'S';
				if (coalesce(nr_seq_grupo_material_w,0) > 0) then 
					ie_grupo_w	:= pls_se_grupo_preco_material(nr_seq_grupo_material_w, nr_seq_material_w);
				end if;
 
				if (coalesce(ie_grupo_w,'S') = 'S') and (ie_liberado_w = 'N') then 
					nr_seq_regra_w	:= nr_seq_regra_ww;
				else 
					nr_seq_regra_w	:= 0;
				end if;
				end;
			end loop;
			close C06;
			end;
		end loop;
		close C04;
	end if;
 
 
elsif (coalesce(nr_seq_requisicao_p,0) <> 0) then 
	select	b.nr_seq_contrato, 
		b.nr_seq_intercambio, 
		b.nr_seq_plano 
	into STRICT	nr_seq_contrato_w, 
		nr_seq_intercambio_w, 
		nr_seq_plano_w 
	from	pls_segurado	b, 
		pls_requisicao	a 
	where	a.nr_seq_segurado	= b.nr_sequencia 
	and	a.nr_sequencia		= nr_seq_requisicao_p;
 
	open C02;
	loop 
	fetch C02 into 
		cd_procedimento_w, 
		ie_origem_proced_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		SELECT * FROM pls_obter_estrut_proc(cd_procedimento_w, ie_origem_proced_w, cd_area_w, cd_especialidade_w, cd_grupo_w, ie_origem_proced_w) INTO STRICT cd_area_w, cd_especialidade_w, cd_grupo_w, ie_origem_proced_w;
		vl_procedimento_w := 0;
		open C03;
		loop 
		fetch C03 into 
			nr_seq_regra_ww, 
			ie_liberado_w, 
			nr_seq_regra_pos_estab_w, 
			nr_seq_grupo_servico_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin 
			ie_grupo_w	:= 'S';
			if (coalesce(nr_seq_grupo_servico_w,0) > 0) then 
				ie_grupo_w	:= pls_se_grupo_preco_servico(nr_seq_grupo_servico_w, cd_procedimento_w, ie_origem_proced_w);
			end if;
 
			if (coalesce(ie_grupo_w,'S') = 'S') and (ie_liberado_w = 'N') then 
				nr_seq_regra_w	:= nr_seq_regra_ww;
			end if;
			end;
		end loop;
		close C03;
		end;
	end loop;
	close C02;
 
	/*Se não entrou em nehuma regra dos procdimentos , então é verificado se entra em alguma regra do grupo de materiais */
 
	if (coalesce(nr_seq_regra_w,0) = 0) then 
		vl_material_w := 0;
		open C05;
		loop 
		fetch C05 into 
			nr_seq_material_w;
		EXIT WHEN NOT FOUND; /* apply on C05 */
			begin 
			open C06;
			loop 
			fetch C06 into 
				nr_seq_regra_ww, 
				ie_liberado_w, 
				nr_seq_grupo_material_w;
			EXIT WHEN NOT FOUND; /* apply on C06 */
				begin 
				ie_grupo_w	:= 'S';
				if (coalesce(nr_seq_grupo_material_w,0) > 0) then 
					ie_grupo_w	:= pls_se_grupo_preco_material(nr_seq_grupo_material_w, nr_seq_material_w);
				end if;
 
				if (coalesce(ie_grupo_w,'S') = 'S') and (ie_liberado_w = 'N') then 
					nr_seq_regra_w	:= nr_seq_regra_ww;
				end if;
				end;
			end loop;
			close C06;
			end;
		end loop;
		close C05;
	end if;
end if;
 
nr_seq_regra_p	:= nr_seq_regra_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_regra_lib_estipu ( nr_seq_guia_p bigint, nr_seq_requisicao_p bigint, nr_seq_regra_p INOUT bigint) FROM PUBLIC;

