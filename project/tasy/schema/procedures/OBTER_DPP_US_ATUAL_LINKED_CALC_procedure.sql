-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_dpp_us_atual_linked_calc (dt_us_p timestamp, qt_ig_sem_us_p bigint, qt_ig_dia_us_p bigint, ie_opcao_p text, nr_atendimento_p bigint, qt_resultado_p INOUT bigint) AS $body$
DECLARE


qt_semanas_w bigint;
qt_dias_w bigint;
dt_atual_w timestamp;
Dt_dpp_us_w timestamp;
qt_semana_us_w bigint;
qt_dia_us_w bigint;
qt_total_dia_w bigint;


BEGIN

dt_dpp_us_w := dt_us_p;
qt_semana_us_w := qt_ig_sem_us_p;
qt_dia_us_w := qt_ig_dia_us_p;

select trunc(coalesce(max(dt_nascimento),clock_timestamp()))
into STRICT   dt_atual_w
from   nascimento
where  nr_atendimento = nr_atendimento_p 
and    pep_consiste_qt_nasc(nr_atendimento_p) <> ' ';

if (dt_dpp_us_w IS NOT NULL AND dt_dpp_us_w::text <> '') and (qt_semana_us_w IS NOT NULL AND qt_semana_us_w::text <> '') and (qt_dia_us_w IS NOT NULL AND qt_dia_us_w::text <> '') then	
    qt_total_dia_w	:= (coalesce(qt_semana_us_w,0) * 7) + coalesce(qt_dia_us_w,0);
	
    if (trunc(dt_dpp_us_w) <> dt_atual_w) then
       qt_total_dia_w	:= qt_total_dia_w + (dt_atual_w - trunc(dt_dpp_us_w));
    end if;

	qt_semanas_w	:= trunc(dividir(qt_total_dia_w,7));
    qt_dias_w	    := qt_total_dia_w - (qt_semanas_w * 7);				

    if (ie_opcao_p = 'S') then
        qt_resultado_p:= qt_semanas_w;
    elsif (ie_opcao_p = 'D') then
        qt_resultado_p:= qt_dias_w;
    end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_dpp_us_atual_linked_calc (dt_us_p timestamp, qt_ig_sem_us_p bigint, qt_ig_dia_us_p bigint, ie_opcao_p text, nr_atendimento_p bigint, qt_resultado_p INOUT bigint) FROM PUBLIC;

