-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_encaixe_atendimento ( cd_agenda_p bigint, dt_agenda_p timestamp, hr_inicio_p timestamp, nr_minuto_duracao_p bigint, cd_medico_p text, cd_pessoa_fisica_p text, ie_opcao_p text, ds_questiona_hor_med_p INOUT text) AS $body$
DECLARE

 
cd_estabelecimento_w			integer;
cd_perfil_w						integer;
nm_usuario_w					varchar(15);
ie_permissao_w					varchar(15);
ie_regra_dia_encaixe_w		varchar(15);
ie_agenda_encaixe_atend_w	varchar(15);
ds_erro_w					varchar(255);
ie_medico_disp_w			varchar(15);


BEGIN 
 
cd_estabelecimento_w	:= wheb_usuario_pck.get_cd_estabelecimento;
cd_perfil_w				:= wheb_usuario_pck.get_cd_perfil;
nm_usuario_w			:= wheb_usuario_pck.get_nm_usuario;
 
ie_permissao_w := Obter_Param_Usuario(871, 158, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_permissao_w);
 
if (ie_opcao_p = 'A') then 
 
	ie_medico_disp_w := obter_se_medico_disp_encaixe(dt_agenda_p, cd_medico_p, ie_medico_disp_w);
	if (coalesce(ie_medico_disp_w,'S') = 'N') then 
		CALL exibir_erro_abortar(Wheb_mensagem_pck.get_texto(282267),null);
	end if;	
 
	select	max(substr(obter_se_agenda_regra_dia(cd_agenda_p,dt_agenda_p,nm_usuario_w),1,1)) 
	into STRICT	ie_regra_dia_encaixe_w 
	;
 
	if (ie_regra_dia_encaixe_w = 'S') then 
		CALL exibir_erro_abortar(Wheb_mensagem_pck.get_texto(218813),null);
	end if;
 
	if (ie_permissao_w = 'S') then 
		select	max(substr(Obter_Se_Perm_AgeCirur(cd_pessoa_fisica, cd_pessoa_fisica_p, cd_perfil_w, cd_agenda),1,1)) 
		into STRICT	ie_agenda_encaixe_atend_w 
		from 	agenda 
		where 	cd_agenda = cd_agenda_p;
	 
		if (ie_agenda_encaixe_atend_w <> 'T') then 
			CALL exibir_erro_abortar(Wheb_mensagem_pck.get_texto(218819),null);
		end if;
	end if;
 
	CALL Consiste_se_agenda_unica(0,cd_agenda_p,dt_agenda_p,hr_inicio_p,'N',nm_usuario_w,cd_estabelecimento_w);
	 
	ds_erro_w := consistir_hor_med_encaixe(cd_medico_p, nr_minuto_duracao_p, dt_agenda_p, cd_agenda_p, ds_erro_w);
	if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then 
		ds_questiona_hor_med_p	:= substr(ds_erro_w,1,255);
	end if;	
 
	 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_encaixe_atendimento ( cd_agenda_p bigint, dt_agenda_p timestamp, hr_inicio_p timestamp, nr_minuto_duracao_p bigint, cd_medico_p text, cd_pessoa_fisica_p text, ie_opcao_p text, ds_questiona_hor_med_p INOUT text) FROM PUBLIC;

