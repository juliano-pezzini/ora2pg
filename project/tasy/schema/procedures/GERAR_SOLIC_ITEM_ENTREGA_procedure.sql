-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_solic_item_entrega ( nr_solic_compra_p bigint, nr_item_solic_compra_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_existe_w		smallint;
nr_seq_item_entrega_w	integer;
qt_material_w		double precision;
dt_solic_item_w		timestamp;


BEGIN


select	count(*)
into STRICT	qt_existe_w
from	solic_compra_item
where	(dt_solic_item IS NOT NULL AND dt_solic_item::text <> '')
and	nr_solic_compra		= nr_solic_compra_p
and	nr_item_solic_compra	= nr_item_solic_compra_p;
if (qt_existe_w > 0) then
	begin

	select	qt_material,
		dt_solic_item
	into STRICT	qt_material_w,
		dt_solic_item_w
	from	solic_compra_item
	where	nr_solic_compra		= nr_solic_compra_p
	and	nr_item_solic_compra	= nr_item_solic_compra_p;

	select	count(*)
	into STRICT	qt_existe_w
	from	solic_compra_item_entrega
	where	nr_solic_compra		= nr_solic_compra_p
	and	nr_item_solic_compra	= nr_item_solic_compra_p;

	if (qt_existe_w = 0) then
		select	coalesce(max(nr_item_solic_compra_entr),0) + 1
		into STRICT	nr_seq_item_entrega_w
		from	solic_compra_item_entrega
		where	nr_solic_compra		= nr_solic_compra_p
		and	nr_item_solic_compra	= nr_item_solic_compra_p;

		insert into solic_compra_item_entrega(
			nr_solic_compra,
			nr_item_solic_compra,
			nr_item_solic_compra_entr,
			qt_entrega_solicitada,
			dt_entrega_solicitada,
			dt_atualizacao,
			nm_usuario)
		values (nr_solic_compra_p,
			nr_item_solic_compra_p,
			nr_seq_item_entrega_w,
			qt_material_w,
			dt_solic_item_w,
			clock_timestamp(),
			nm_usuario_p);
	elsif (qt_existe_w = 1) then
		update	solic_compra_item_entrega
		set	qt_entrega_solicitada	= qt_material_w,
			dt_entrega_solicitada	= dt_solic_item_w
		where	nr_solic_compra		= nr_solic_compra_p
		and	nr_item_solic_compra	= nr_item_solic_compra_p;
	end if;

	commit;

	end;
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_solic_item_entrega ( nr_solic_compra_p bigint, nr_item_solic_compra_p bigint, nm_usuario_p text) FROM PUBLIC;

