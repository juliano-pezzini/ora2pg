-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_arquivo_dmed_anual ( nr_sequencia_p text, nm_usuario_p text) AS $body$
DECLARE

 
cd_cnpj_declarante_w		varchar(20);
dt_ano_referencia_w		varchar(4);
dt_ano_calendario_w		varchar(4);
ds_arquivo_w			varchar(2000)	:= '';
ds_arquivo_aux_w		varchar(2000)	:= '';
ie_indicador_retificadora_w	varchar(1);
ie_prestador_ops_w		varchar(1);
nr_recibo_w			varchar(20);
nr_linha_w			bigint	:= 0;
ds_identificador_w	dmed.ds_identificador%type;
					

BEGIN 
 
-- Limpar a tabela 
delete 
from	w_dacon 
where	nm_usuario = nm_usuario_p;
 
-- Cabeçalho 
select	dt_ano_referencia, 
		dt_ano_calendario, 
		ie_indicador_retificadora, 
		nr_recibo, 
		ds_identificador 
into STRICT	dt_ano_referencia_w, 
		dt_ano_calendario_w, 
		ie_indicador_retificadora_w, 
		nr_recibo_w, 
		ds_identificador_w 
from	dmed 
where	nr_sequencia	= nr_sequencia_p;
 
ds_arquivo_w	:= gerar_arquivo_dmed_cab(dt_ano_referencia_w, dt_ano_calendario_w, ie_indicador_retificadora_w, nr_recibo_w, ds_identificador_w);
 
nr_linha_w	:= nr_linha_w + 1;
 
insert into w_dacon(nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	ds_arquivo, 
	nr_linha, 
	ie_tipo_registro) 
values (nextval('w_dacon_seq'), 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	ds_arquivo_w, 
	nr_linha_w, 
	1);
	 
commit;
 
ds_arquivo_w	:= '';
 
-- Responsável técnico 
 
begin 
ds_arquivo_w	:= gerar_arquivo_dmed_resp(nm_usuario_p, nr_sequencia_p);
exception 
	when others then 
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(779886);
end;
 
nr_linha_w	:= nr_linha_w + 1;
 
insert into w_dacon(nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	ds_arquivo, 
	nr_linha, 
	ie_tipo_registro) 
values (nextval('w_dacon_seq'), 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	ds_arquivo_w, 
	nr_linha_w, 
	2);
 
commit;
 
ds_arquivo_w 	:= '';
 
-- Estabelecimento 
select	cd_cnpj_declarante 
into STRICT	cd_cnpj_declarante_w 
from	dmed 
where	nr_sequencia	= nr_sequencia_p;
 
ds_arquivo_w	:= gerar_arquivo_dmed_estab(cd_cnpj_declarante_w, nr_sequencia_p);
 
nr_linha_w	:= nr_linha_w + 1;
 
insert into w_dacon(nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	ds_arquivo, 
	nr_linha, 
	ie_tipo_registro) 
values (nextval('w_dacon_seq'), 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	ds_arquivo_w, 
	nr_linha_w, 
	3);
 
commit;
 
ds_arquivo_w	:= '';
 
-- Operadora e Prestador 
select	CASE WHEN t.ie_comercial_ops='H' THEN '1' WHEN t.ie_comercial_ops='O' THEN '2'  ELSE '3' END  
into STRICT	ie_prestador_ops_w 
from	pessoa_juridica		p, 
	tipo_pessoa_juridica	t 
where 	p.cd_tipo_pessoa	= t.cd_tipo_pessoa 
and	p.cd_cgc		= cd_cnpj_declarante_w;
 
if	((ie_prestador_ops_w = 2) or (ie_prestador_ops_w = 3)) then 
	nr_linha_w := dmed_anual_arquivo_top(	nr_sequencia_p, nm_usuario_p, nr_linha_w);
end if;
 
if	((ie_prestador_ops_w = 1) or (ie_prestador_ops_w = 3)) then 
	nr_linha_w := dmed_anual_arquivo_rppss(	nr_sequencia_p, nm_usuario_p, nr_linha_w);
end if;
 
nr_linha_w	:= nr_linha_w + 1;
 
-- Registro final 
ds_arquivo_w := 'FIMDmed' || '|';
 
insert into w_dacon(nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	ds_arquivo, 
	nr_linha, 
	ie_tipo_registro) 
values (nextval('w_dacon_seq'), 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	ds_arquivo_w, 
	nr_linha_w, 
	10 
	);
	 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_arquivo_dmed_anual ( nr_sequencia_p text, nm_usuario_p text) FROM PUBLIC;

