-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_atualiza_fim_ativ_exec ( nr_seq_ordem_p bigint, nr_seq_atividade_p bigint, dt_inicio_atividade_p timestamp, ie_permite_cobr_p text, nm_usuario_p text) AS $body$
DECLARE


dt_fim_atividade_w		timestamp;
qt_minuto_w		bigint;
vl_parametro_w		varchar(1);


BEGIN

dt_fim_atividade_w	:= clock_timestamp();
vl_parametro_w := Obter_Param_Usuario(299, 470, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, vl_parametro_w);

if (vl_parametro_w = 'N') and (trunc(dt_inicio_atividade_p) <> trunc(clock_timestamp())) then

	CALL Wheb_mensagem_pck.exibir_mensagem_abort(229783);

end if;

if (coalesce(nr_seq_atividade_p,0) > 0) then
	begin

	select	obter_min_entre_datas(dt_inicio_atividade_p,dt_fim_atividade_w,1)
	into STRICT	qt_minuto_w
	;

	update	man_ordem_serv_ativ
	set	dt_fim_atividade = dt_fim_atividade_w,
		qt_minuto = qt_minuto_w,
		qt_minuto_cobr = CASE WHEN ie_permite_cobr_p='S' THEN qt_minuto_w  ELSE qt_minuto_cobr END
	where	nr_sequencia = nr_seq_atividade_p;

	end;
else
	begin

	update	man_ordem_serv_ativ
	set	dt_fim_atividade = dt_fim_atividade_w,
		qt_minuto = coalesce(obter_min_entre_datas(dt_atividade,dt_fim_atividade_w,1),0)
	where	coalesce(dt_fim_atividade::text, '') = ''
	and	nr_seq_ordem_serv = nr_seq_ordem_p
	and	nm_usuario_exec = nm_usuario_p;

	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_atualiza_fim_ativ_exec ( nr_seq_ordem_p bigint, nr_seq_atividade_p bigint, dt_inicio_atividade_p timestamp, ie_permite_cobr_p text, nm_usuario_p text) FROM PUBLIC;

