-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_cotacao_item_coluna ( nr_cot_compra_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_cot_item_w		bigint;
nr_seq_cot_col_w		bigint;
nr_item_cot_compra_w		integer;
cd_material_w			integer;
cd_fornecedor_w			varchar(14);
qt_material_w			double precision;
vl_unitario_material_w		double precision;
nr_seq_coluna_w			integer;
ds_marca_w			w_cotacao_item_coluna.ds_marca%type;
vl_ipi_w			double precision;
cd_condicao_pagamento_w		bigint;
vl_frete_w			double precision;
qt_dias_entrega_w		integer;
vl_unitario_inicial_w		double precision;
vl_liquido_w			double precision;
ie_vencedor_w			varchar(1);
nr_seq_cot_item_forn_w		bigint;
ds_observacao_w			w_cotacao_item_coluna.ds_observacao%type;
ds_observacao_item_w		varchar(255);
ds_motivo_venc_alt_w		varchar(4000);
ie_motivo_alter_venc_w		varchar(15);
ds_cond_pagto_w			varchar(255);
vl_minimo_nf_w			double precision;
cd_estabelecimento_w		bigint;
vl_total_w			double precision;
ds_marca_fornec_w		w_cotacao_item_coluna.ds_marca_fornec%type;
cd_pessoa_fisica_w		w_cotacao_item_coluna.cd_pessoa_fisica%type;

c01 CURSOR FOR
	SELECT	nr_item_cot_compra,
		cd_material,
		ds_motivo_venc_alt,
		ie_motivo_alter_venc
	from	cot_compra_item
	where	nr_cot_compra = nr_cot_compra_p;

c02 CURSOR FOR
	SELECT	a.nr_sequencia,
		f.cd_cgc_fornecedor,
		f.cd_condicao_pagamento,
		f.vl_previsto_frete,
		f.qt_dias_entrega,
		a.qt_material,
		a.vl_unitario_material,
		a.vl_unitario_liquido,
		a.vl_unitario_inicial,
		a.ds_marca,
		a.ds_marca_fornec,
		substr(coalesce(obter_se_fornec_venc_cotacao(nr_cot_compra_p,a.nr_item_cot_compra,f.nr_sequencia),'N'),1,1) ie_vencedor,
		substr(f.ds_observacao,1,255),
		substr(a.ds_observacao,1,255),
		substr(obter_desc_cond_pagto(f.cd_condicao_pagamento),1,100),
		obter_dados_pf_pj_estab(cd_estabelecimento_w,null,f.cd_cgc_fornecedor,'EVM'),
		f.cd_pessoa_fisica
	from	cot_compra_forn_item a,
		cot_compra_forn f,
		cot_compra_item c
	where	f.nr_sequencia	= a.nr_seq_cot_forn
	and	a.nr_cot_compra = nr_cot_compra_p
	and 	c.nr_cot_compra = a.nr_cot_compra
	and	a.nr_item_cot_compra = c.nr_item_cot_compra
	and	a.nr_item_cot_compra = nr_item_cot_compra_w
	order by coalesce(substr(obter_dados_pf_pj(null, f.cd_cgc_fornecedor,'N'),1,200), substr(obter_nome_pf(f.cd_pessoa_fisica),1,200));


BEGIN

delete from w_cotacao_item_coluna
where	nm_usuario = nm_usuario_p
and	nr_cot_compra = nr_cot_compra_p;

delete from w_cotacao_item
where	nm_usuario = nm_usuario_p
and	nr_cot_compra = nr_cot_compra_p;

select	cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	cot_compra
where	nr_cot_compra = nr_cot_compra_p;

open c01;
loop
	fetch c01 into
		nr_item_cot_compra_w,
		cd_material_w,
		ds_motivo_venc_alt_w,
		ie_motivo_alter_venc_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

	select	nextval('w_cotacao_item_seq')
	into STRICT	nr_seq_cot_item_w
	;

	insert into w_cotacao_item(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		cd_material,
		ds_motivo_venc_alt,
		ie_motivo_alter_venc,
		nr_cot_compra)
	values (	nr_seq_cot_item_w,
		clock_timestamp(),
		nm_usuario_p,
		cd_material_w,
		ds_motivo_venc_alt_w,
		ie_motivo_alter_venc_w,
		nr_cot_compra_p);
	commit;

	open c02;
	loop
		fetch c02 into
			nr_seq_cot_item_forn_w,
			cd_fornecedor_w,
			cd_condicao_pagamento_w,
			vl_frete_w,
			qt_dias_entrega_w,
			qt_material_w,
			vl_unitario_material_w,
			vl_liquido_w,
			vl_unitario_inicial_w,
			ds_marca_w,
			ds_marca_fornec_w,
			ie_vencedor_w,
			ds_observacao_w,
			ds_observacao_item_w,
			ds_cond_pagto_w,
			vl_minimo_nf_w,
			cd_pessoa_fisica_w;	
		EXIT WHEN NOT FOUND; /* apply on c02 */

			select	nextval('w_cotacao_item_coluna_seq')
			into STRICT	nr_seq_cot_col_w
			;

			select	coalesce(max(nr_seq_coluna),0)
			into STRICT	nr_seq_coluna_w
			from	w_cotacao_item_coluna
			where	cd_fornecedor = cd_fornecedor_w
			and	nm_usuario = nm_usuario_p
			and	nr_cot_compra = nr_cot_compra_p;
		
			if (nr_seq_coluna_w = 0) then
				select	coalesce(max(nr_seq_coluna),0) + 1
				into STRICT	nr_seq_coluna_w
				from	w_cotacao_item_coluna
				where	nm_usuario = nm_usuario_p
				and	nr_cot_compra = nr_cot_compra_p;
			end if;
			
			select	coalesce(sum(b.vl_tributo),0)
			into STRICT	vl_ipi_w
			from	cot_compra_forn_item_tr b,
				tributo c
			where	b.cd_tributo = c.cd_tributo
			and	c.ie_tipo_tributo = 'IPI'
			and	b.nr_seq_cot_item_forn = nr_seq_cot_item_forn_w;
			
			vl_total_w := 0;
			if (ie_vencedor_w = 'S') then
				vl_total_w := vl_unitario_material_w * qt_material_w;
			end if;

			insert into w_cotacao_item_coluna(
				nr_sequencia,
				nr_seq_coluna,
				dt_atualizacao,
				nm_usuario,
				nr_seq_cotacao_item,
				cd_fornecedor,
				qt_fornecedor,
				vl_fornecedor,
				vl_liquido,
				vl_unitario_inicial,
				ds_marca,
				ds_marca_fornec,
				vl_ipi,
				cd_condicao_pagamento,
				vl_frete,
				qt_dias_entrega,
				ie_vencedor,
				ds_observacao,
				ds_observacao_item,
				ds_motivo_venc_alt,
				nr_cot_compra,
				ds_cond_pagto,
				vl_minimo_nf,
				vl_total,
				cd_pessoa_fisica)
			values (	nr_seq_cot_col_w,
				nr_seq_coluna_w,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_cot_item_w,
				cd_fornecedor_w,
				qt_material_w,
				vl_unitario_material_w,
				vl_liquido_w,
				vl_unitario_inicial_w,
				ds_marca_w,
				ds_marca_fornec_w,
				vl_ipi_w,
				cd_condicao_pagamento_w,
				vl_frete_w,
				qt_dias_entrega_w,
				ie_vencedor_w,
				ds_observacao_w,
				ds_observacao_item_w,
				substr(ds_motivo_venc_alt_w,1,255),
				nr_cot_compra_p,
				ds_cond_pagto_w,
				vl_minimo_nf_w,
				vl_total_w,
				cd_pessoa_fisica_w);
			commit;
	end loop;
	close c02;
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_cotacao_item_coluna ( nr_cot_compra_p bigint, nm_usuario_p text) FROM PUBLIC;

