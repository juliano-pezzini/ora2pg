-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_imposto_convenio_receb (nr_seq_receb_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_estabelecimento_w		smallint;
cd_convenio_w			bigint;
nr_ccm_w			bigint	:= null;
dt_emissao_w			timestamp;
pr_imposto_w			double precision;
cd_tributo_w			smallint;
ie_soma_diminui_w		varchar(1);
vl_minimo_tributo_w		double precision;
vl_minimo_base_calculo_w	double precision;
nr_seq_sit_trib_w		bigint;
nr_seq_trans_financ_w		bigint;
vl_tributo_w			double precision;
vl_recebimento_w		double precision;
qt_existe_w			bigint;

c01 CURSOR FOR
SELECT	a.pr_imposto,
	a.cd_tributo,
	b.ie_soma_diminui,
	a.vl_minimo_tributo,
	a.vl_minimo_base_calculo,
	a.nr_seq_sit_trib,
	b.nr_seq_trans_conv_rec
from	regra_calculo_imposto	a,
	tributo			b
where	a.cd_tributo			= b.cd_tributo
and	b.ie_situacao			= 'A'
and	coalesce(a.ie_receb_convenio,'N')	= 'S'
and (coalesce(a.cd_estabelecimento, cd_estabelecimento_w)	= cd_estabelecimento_w)
and	coalesce(a.cd_convenio,cd_convenio_w)			= cd_convenio_w
and (coalesce(nr_ccm_w::text, '') = '' or coalesce(b.ie_ccm,'S') = 'S')
and	a.dt_vigencia	=	(select max(x.dt_vigencia)
				from	regra_calculo_imposto x
				where	x.cd_tributo		= a.cd_tributo
				and	coalesce(x.cd_convenio,cd_convenio_w)		= cd_convenio_w
				and (coalesce(x.cd_estabelecimento, cd_estabelecimento_w)	= cd_estabelecimento_w)
				and	x.dt_vigencia		<= dt_emissao_w)
and	fim_dia(coalesce(a.dt_fim_vigencia, dt_emissao_w)) >= dt_emissao_w
and	(b.nr_seq_trans_conv_rec IS NOT NULL AND b.nr_seq_trans_conv_rec::text <> '')
order 	by coalesce(a.cd_convenio, 0);



BEGIN

select	max(a.cd_estabelecimento),
	max(a.cd_convenio),
	max(a.dt_recebimento),
	max(a.vl_recebimento)
into STRICT	cd_estabelecimento_w,
	cd_convenio_w,
	dt_emissao_w,
	vl_recebimento_w
from	convenio_receb a
where	a.nr_sequencia	= nr_seq_receb_p;

open	c01;
loop
fetch	c01 into
	pr_imposto_w,
	cd_tributo_w,
	ie_soma_diminui_w,
	vl_minimo_tributo_w,
	vl_minimo_base_calculo_w,
	nr_seq_sit_trib_w,
	nr_seq_trans_financ_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	vl_tributo_w	:= (vl_recebimento_w * pr_imposto_w) / 100;

	if (vl_tributo_w		>= coalesce(vl_minimo_tributo_w, 0)) and (vl_recebimento_w	>= vl_minimo_base_calculo_w) then

		select	count(*)
		into STRICT	qt_existe_w
		from	convenio_receb_adic
		where	nr_seq_receb	= nr_seq_receb_p
		and	cd_tributo 	= cd_tributo_w;

		if (qt_existe_w = 0) then

			insert into convenio_receb_adic(cd_tributo,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nm_usuario,
				nm_usuario_nrec,
				nr_lote_contabil,
				nr_seq_receb,
				nr_seq_trans_financ,
				nr_sequencia,
				nr_titulo,
				vl_adicional,
				vl_cambial_ativo,
				vl_cambial_passivo)
			values (cd_tributo_w,
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_p,
				nm_usuario_p,
				0,
				nr_seq_receb_p,
				nr_seq_trans_financ_w,
				nextval('convenio_receb_adic_seq'),
				null,
				vl_tributo_w,
				0,
				0);
		end if;

	end if;

end 	loop;
close	c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_imposto_convenio_receb (nr_seq_receb_p bigint, nm_usuario_p text) FROM PUBLIC;

