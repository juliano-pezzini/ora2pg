-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cancelar_entrega_item ( nr_ordem_compra_p bigint, nr_item_oci_p bigint, nr_sequencia_p bigint, ie_nova_solic_p text, ie_nova_cotacao_p text, ie_mantem_forn_cot_p text, nm_usuario_p text, ds_observacao_p text, nr_seq_motivo_cancel_p bigint, ie_cancela_ordem_p text, ie_cancela_processo_p text, cd_material_p integer, ie_cancela_item_solic_p text, nr_cot_compra_p INOUT bigint, nr_solic_compra_p INOUT bigint) AS $body$
DECLARE


qt_prevista_entrega_w			double precision;
qt_real_entrega_w			double precision;
qt_prevista_entrega_ww			double precision;
qt_registro_w				bigint;
dt_prevista_entrega_w			timestamp;
nr_solic_compra_w			solic_compra.nr_solic_compra%type;
nr_item_solic_compra_w			solic_compra_item.nr_item_solic_compra%type;
ie_solic_exportada_w			integer;
nr_solic_compra_ww			bigint;
nr_item_solic_compra_www		integer;
nr_item_solic_compra_ww			integer;
nr_item_encontrado_w			integer;
nr_item_solic_compra_entr_w			integer;
nr_documento_externo_w			ordem_compra.nr_documento_externo%type;
cd_estabelecimento_w			smallint;
nr_seq_regra_w				bigint;
cd_material_w				integer;
cd_material_ww				integer;
ds_material_w				varchar(255);
ds_assunto_w				varchar(80);
ds_mensagem_w				varchar(2000);
ie_usuario_w				varchar(3);
ds_email_comprador_w			varchar(255);
ds_usuario_comprador_w			varchar(255);
ds_email_origem_w				varchar(255);
ds_usuario_origem_w			varchar(255);
cd_comprador_w				varchar(10);
nm_comprador_w				varchar(100);
ds_razao_social_w				varchar(100);
nm_fantasia_w				varchar(100);
nm_usuario_w				varchar(15);
ds_email_adicional_w			varchar(2000);
nr_cot_compra_w				bigint;
cd_perfil_disparar_w			integer;
ds_motivo_w				varchar(100);
ds_observacao_w				ordem_compra_item_entrega.ds_observacao%type;
ie_tipo_ordem_w				varchar(1);
cd_local_estoque_w			bigint;
cd_setor_atendimento_w			integer;
cd_setor_solicitante_w			integer;
qt_regra_usuario_w				bigint;
nm_usuario_solicitante_w			varchar(15);
dt_inicio_pendencia_w			timestamp;
cd_perfil_dispara_w			integer;
ds_email_destino_w			varchar(255);
ds_motivo_pend_w			varchar(255);
cd_unidade_medida_compra_w		varchar(30);
qt_existe_w				bigint;
ie_manter_sc_pend_lib_w			varchar(1);
nr_solic_compra_www			bigint;
nr_item_solic_compra_wwww		integer;
dt_baixa_w				timestamp;
ds_email_remetente_w			varchar(255);

/* Campos da regra de email  ( Ordem - Ao cancelar entrega item ) */

nr_seq_regra_ci_w				bigint;
ie_ci_lida_w				varchar(1);
nr_seq_comunic_w				bigint;
nr_seq_classif_w				bigint;
ds_titulo_w				varchar(80);
ds_comunic_w				varchar(4000);
nm_usuario_destino_w			varchar(255);
cd_perfil_ww				varchar(10);
ie_momento_envio_w			varchar(1);
qt_usuario_tasy_w		    bigint;

/* Campos da regra Usuario da Regra */

cd_setor_regra_usuario_w			integer;
ie_usuario_regra_ci_w			varchar(03);

/* Se tiver setor na regra, envia CI para os setores */

ds_setor_adicional_w                    		varchar(2000) := '';

ds_titulo_baixa_oc_w			varchar(80);
ds_historico_w				varchar(4000);
nr_seq_proj_rec_w			projeto_recurso.nr_sequencia%type;

qt_material_cancelado_w			solic_compra_item.qt_material_cancelado%type;

nr_solic_compra_wwww			solic_compra.nr_solic_compra%type;
nr_item_solic_compra_wwwww		solic_compra_item.nr_item_solic_compra%type;
cd_pessoa_fisica_w				comprador.cd_pessoa_fisica%type;

c04 CURSOR FOR	
SELECT	b.nr_sequencia,
	b.cd_perfil
from	regra_envio_comunic_compra a,
	regra_envio_comunic_evento b
where	a.nr_sequencia = b.nr_seq_regra
and	a.cd_funcao = 917
and	b.cd_evento = 49
and	b.ie_situacao = 'A'
and	a.cd_estabelecimento = cd_estabelecimento_w
and	((cd_setor_atendimento_w IS NOT NULL AND cd_setor_atendimento_w::text <> '' AND b.cd_setor_destino = cd_setor_atendimento_w) or
	((coalesce(cd_setor_atendimento_w::text, '') = '') and (coalesce(b.cd_setor_destino::text, '') = '')) or (coalesce(b.cd_setor_destino::text, '') = ''))
and	substr(obter_se_envia_ci_regra_compra(b.nr_sequencia,nr_ordem_compra_p,'OC',obter_perfil_ativo,nm_usuario_p,null),1,1) = 'S';

c05 CURSOR FOR
SELECT	coalesce(a.cd_setor_atendimento,0) cd_setor_atendimento,
	a.ie_usuario
from	regra_envio_comunic_usu a
where	a.nr_seq_evento = nr_seq_regra_ci_w;


BEGIN

nr_cot_compra_w 	:= nr_cot_compra_p;
nr_solic_compra_w	:= coalesce(nr_solic_compra_p,0);
cd_material_ww		:= cd_material_p;

select	coalesce(qt_prevista_entrega,0),
	coalesce(qt_real_entrega,0),
	dt_prevista_entrega,
	dt_inicio_pendencia,
	substr(obter_desc_motivo_pend_entr(nr_seq_motivo_pend),1,255) ds_motivo_pend
into STRICT	qt_prevista_entrega_w,
	qt_real_entrega_w,
	dt_prevista_entrega_w,
	dt_inicio_pendencia_w,
	ds_motivo_pend_w
from	ordem_compra_item_entrega
where	nr_ordem_compra = nr_ordem_compra_p
and	nr_item_oci = nr_item_oci_p
and	nr_sequencia = nr_sequencia_p;

if (qt_real_entrega_w >= qt_prevista_entrega_w) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(173365);
end if;

qt_prevista_entrega_ww := (qt_prevista_entrega_w - qt_real_entrega_w);

select	max(cd_estabelecimento),
	max(substr(obter_nome_pf_pj(cd_comprador,null),1,100)) nm_comprador,
	max(substr(obter_nome_pf_pj(null,cd_cgc_fornecedor),1,100)) ds_razao_social,
	max(substr(obter_dados_pf_pj(null,cd_cgc_fornecedor,'F'),1,100)) nm_fantasia,
	max(cd_comprador),
	max(ie_tipo_ordem),
	max(cd_setor_atendimento) cd_setor_atendimento,
	max(coalesce(substr(obter_usuario_pessoa(cd_pessoa_solicitante),1,15),'X')) usuario_solicitante,
	max(substr(obter_dados_pf_pj_estab(cd_estabelecimento, cd_pessoa_fisica, cd_cgc_fornecedor, 'M'),1,255))
into STRICT	cd_estabelecimento_w,
	nm_comprador_w,
	ds_razao_social_w,
	nm_fantasia_w,
	cd_comprador_w,
	ie_tipo_ordem_w,
	cd_setor_atendimento_w,
	nm_usuario_solicitante_w,
	ds_email_destino_w
from	ordem_compra
where	nr_ordem_compra = nr_ordem_compra_p;


select	coalesce(ie_manter_sc_pend_lib,'N')
into STRICT	ie_manter_sc_pend_lib_w
from	parametro_compras
where	cd_estabelecimento = cd_estabelecimento_w;

select	coalesce(max(nr_documento_externo),'X')
into STRICT	nr_documento_externo_w
from	ordem_compra
where	nr_ordem_compra = nr_ordem_compra_p
and	coalesce(nr_seq_agenda_pac::text, '') = '';

select	max(ds_email),
	max(cd_pessoa_fisica)
into STRICT	ds_email_comprador_w,
		cd_pessoa_fisica_w
from	comprador
where	cd_pessoa_fisica = cd_comprador_w
and	cd_estabelecimento = cd_estabelecimento_w;

select	max(nm_usuario)
into STRICT	ds_usuario_comprador_w
from	usuario
where	cd_pessoa_fisica = cd_pessoa_fisica_w;

select	cd_material,
	substr(obter_desc_material(cd_material),1,255),
	nm_usuario,
	cd_unidade_medida_compra,
	nr_solic_compra,
	nr_item_solic_compra,
	nr_seq_proj_rec
into STRICT	cd_material_w,
	ds_material_w,
	nm_usuario_w,
	cd_unidade_medida_compra_w,
	nr_solic_compra_www,
	nr_item_solic_compra_wwww,
	nr_seq_proj_rec_w
from	ordem_compra_item
where	nr_ordem_compra = nr_ordem_compra_p
and	nr_item_oci = nr_item_oci_p;

if (coalesce(ie_tipo_ordem_w,'N') = 'T') then
	begin
	CALL inserir_historico_ordem_compra(
		nr_ordem_compra_p,
		'S',
		Wheb_mensagem_pck.get_Texto(298624),
		substr(WHEB_MENSAGEM_PCK.get_texto(298626,
			'NR_ITEM_OCI_P='||NR_ITEM_OCI_P||
			';CD_MATERIAL_W='||CD_MATERIAL_W||
			';DS_MATERIAL_W='||DS_MATERIAL_W),1,4000), /*Foi cancelada a entrega do item [#@NR_ITEM_OCI_P#@] (#@CD_MATERIAL_W#@) - #@DS_MATERIAL_W#@.*/
		nm_usuario_p);
		
	CALL gerar_comunic_solic_transf(nr_ordem_compra_p,nr_item_oci_p,32,nm_usuario_p);
	CALL gerar_email_solic_transf(nr_ordem_compra_p,nr_item_oci_p,42,nm_usuario_p);
	end;
end if;

if (coalesce(nr_documento_externo_w,'X') <> 'X') then

	/*Faz o cancelamento de cada entrega*/

	update	ordem_compra_item_entrega
	set	ie_status_exportar = '0'
	where	nr_sequencia = nr_sequencia_p;

	if (ie_nova_solic_p = 'N') then
		update	ordem_compra_item_entrega
		set	ds_observacao	= substr(Wheb_mensagem_pck.get_Texto(298632, 'DS_OBSERVACAO_W='||ds_observacao),1,255) /*Nao foi gerado nova solicitacao. #@DS_OBSERVACAO_W#@*/
		where	nr_sequencia = nr_sequencia_p;
	end if;
end if;

if (nr_seq_motivo_cancel_p > 0) then
	select	ds_motivo
	into STRICT	ds_motivo_w
	from	motivo_cancel_sc_oc
	where	nr_sequencia = nr_seq_motivo_cancel_p;
end if;

ds_observacao_w := substr(WHEB_MENSAGEM_PCK.get_texto(298633,
			'DS_MOTIVO_W='||DS_MOTIVO_W||
			';DS_OBSERVACAO_P='||DS_OBSERVACAO_P),1,255);
			/*Entrega cancelada pelo motivo: #@DS_MOTIVO_W#@.
			Observacao: #@DS_OBSERVACAO_P#@.*/
if (coalesce(ie_cancela_processo_p,'N') = 'S') then

	select	qt_prevista_entrega - coalesce(qt_real_entrega,0)
	into STRICT	qt_material_cancelado_w
	from	ordem_compra_item_entrega
	where	nr_ordem_compra = nr_ordem_compra_p
	and	nr_item_oci = nr_item_oci_p
	and	nr_sequencia = nr_sequencia_p;

	CALL cancelar_item_processo_compra(nr_ordem_compra_p,nr_item_oci_p,ds_observacao_p,nm_usuario_p, qt_material_cancelado_w);
	
    update solic_compra
    set dt_baixa = clock_timestamp()
    where nr_solic_compra = nr_solic_compra_www
    and not exists (
        SELECT 1
        from solic_compra_item
        where nr_solic_compra = nr_solic_compra_www
        and coalesce(dt_baixa::text, '') = '');

	update	cot_compra
	set	nr_seq_motivo_cancel = nr_seq_motivo_cancel_p
	where	nr_cot_compra = (SELECT max(nr_cot_compra) from ordem_compra_item where nr_ordem_compra = nr_ordem_compra_p and nr_item_oci = nr_item_oci_p);
end if;			
			
if (qt_real_entrega_w = 0) then
	update	ordem_compra_item_entrega
	set	dt_cancelamento = clock_timestamp(),
		ds_observacao = substr(CASE WHEN ds_observacao = NULL THEN ds_observacao_w  ELSE ds_observacao || chr(13) || chr(10) || ds_observacao_w END ,1,255)
	/*where	nr_ordem_compra = nr_ordem_compra_p
	and	nr_item_oci = nr_item_oci_p*/
	where	nr_sequencia = nr_sequencia_p;
	
	if (dt_inicio_pendencia_w IS NOT NULL AND dt_inicio_pendencia_w::text <> '') then
		update	ordem_compra_item_entrega
		set	dt_fim_pendencia	= clock_timestamp(),
			nm_usuario_fim_pend	= nm_usuario_p
		where	nr_ordem_compra		= nr_ordem_compra_p
		and	nr_item_oci		= nr_item_oci_p
		and	nr_sequencia		= nr_sequencia_p;
	end if;

else
	begin
	
	update	ordem_compra_item_entrega
	set	qt_prevista_entrega	= qt_real_entrega_w
	where	nr_ordem_compra		= nr_ordem_compra_p
	and	nr_item_oci		= nr_item_oci_p
	and	nr_sequencia		= nr_sequencia_p;
	
	if (dt_inicio_pendencia_w IS NOT NULL AND dt_inicio_pendencia_w::text <> '') then
		update	ordem_compra_item_entrega
		set	dt_fim_pendencia	= clock_timestamp(),
			nm_usuario_fim_pend	= nm_usuario_p
		where	nr_ordem_compra		= nr_ordem_compra_p
		and	nr_item_oci		= nr_item_oci_p
		and	nr_sequencia		= nr_sequencia_p;
	end if;

	insert into ordem_compra_item_entrega(	
			nr_sequencia,
			nr_ordem_compra,
			nr_item_oci,
			dt_prevista_entrega,
			dt_real_entrega,
			dt_entrega_original,
			dt_entrega_limite,
			qt_prevista_entrega,
			qt_real_entrega,
			dt_atualizacao,
			nm_usuario,
			ds_observacao,
			dt_cancelamento)
		values (	nextval('ordem_compra_item_entrega_seq'),
			nr_ordem_compra_p,
			nr_item_oci_p,
			dt_prevista_entrega_w,
			null,
			dt_prevista_entrega_w,
			dt_prevista_entrega_w,
			qt_prevista_entrega_ww,
			null,
			clock_timestamp(),
			nm_usuario_p,
			substr(ds_observacao_w,1,255),
			clock_timestamp());	

	end;
end if;

if (ie_cancela_item_solic_p = 'S') and (nr_solic_compra_www IS NOT NULL AND nr_solic_compra_www::text <> '') and (nr_item_solic_compra_wwww IS NOT NULL AND nr_item_solic_compra_wwww::text <> '') then
	select	dt_baixa
	into STRICT	dt_baixa_w
	from	solic_compra_item
	where	nr_solic_compra = nr_solic_compra_www
	and	nr_item_solic_compra = nr_item_solic_compra_wwww;

	if (coalesce(dt_baixa_w::text, '') = '') then
		CALL baixar_solic_compra_item(nr_solic_compra_www,nr_item_solic_compra_wwww,nm_usuario_p,'2','');
	end if;
end if;

/* Se tiver solicitacao, e o parametro tiver 'S'. O sistema gera nova solicitacao para os itens cancelados */

if (ie_nova_solic_p = 'S') then
	begin

	select	coalesce(max(a.nr_solic_compra),0),
		coalesce(max(a.nr_item_solic_compra),0)
	into STRICT	nr_solic_compra_ww,
		nr_item_solic_compra_ww
	from	ordem_compra_item_entrega b,
		ordem_compra_item a
	where	a.nr_ordem_compra = b.nr_ordem_compra
	and	a.nr_item_oci = b.nr_item_oci
	and	b.nr_sequencia = nr_sequencia_p;

	if (nr_solic_compra_ww > 0) then
		begin
		if (nr_solic_compra_w = 0) then
			
			select	nextval('solic_compra_seq')
			into STRICT	nr_solic_compra_w
			;			

			insert into solic_compra(
				nr_solic_compra,						cd_estabelecimento,
				dt_solicitacao_compra,						dt_atualizacao,
				nm_usuario,							ie_situacao,
				cd_pessoa_solicitante,						cd_local_estoque,
				cd_centro_custo,						cd_conta_contabil,
				cd_setor_atendimento,						ds_observacao,
				dt_liberacao,							cd_pessoa_autoriza,
				dt_autorizacao,							dt_impressao,
				ie_aviso_chegada,						nr_seq_ordem_serv,
				nr_seq_motivo_cancel,						ie_aviso_aprov_oc,
				ie_urgente,							ie_tipo_solicitacao,
				ie_comodato,							ie_semanal,
				nm_usuario_nrec,						dt_atualizacao_nrec,
				cd_comprador_resp)
			SELECT	nr_solic_compra_w,						cd_estabelecimento,
				dt_solicitacao_compra,						clock_timestamp(),
				nm_usuario_p,							ie_situacao,
				cd_pessoa_solicitante,						cd_local_estoque,
				cd_centro_custo,						cd_conta_contabil,
				cd_setor_atendimento,						substr(WHEB_MENSAGEM_PCK.get_texto(298636,'DS_OBSERVACAO_W='||DS_OBSERVACAO||';NR_ORDEM_COMPRA_P='||NR_ORDEM_COMPRA_P),1,255), /*#@DS_OBSERVACAO_W#@ Gerada no cancelamento da Ordem de compra numero #@NR_ORDEM_COMPRA_P#@.*/
				CASE WHEN ie_manter_sc_pend_lib_w='N' THEN dt_liberacao  ELSE null END ,		CASE WHEN ie_manter_sc_pend_lib_w='N' THEN cd_pessoa_autoriza  ELSE null END ,
				CASE WHEN ie_manter_sc_pend_lib_w='N' THEN dt_autorizacao  ELSE null END ,	dt_impressao,
				ie_aviso_chegada,						nr_seq_ordem_serv,
				nr_seq_motivo_cancel,						ie_aviso_aprov_oc,
				ie_urgente,							0,
				ie_comodato,							ie_semanal,
				nm_usuario_p,							clock_timestamp(),
				cd_comprador_resp
			from	solic_compra
			where	nr_solic_compra 	= nr_solic_compra_ww;
			
		
		end if;
		
		select	coalesce(max(cd_local_estoque),0)
		into STRICT	cd_local_estoque_w
		from	solic_compra
		where	nr_solic_compra = nr_solic_compra_w;
		
		select	count(*)
		into STRICT	qt_existe_w
		from	solic_compra_item
		where	nr_solic_compra = nr_solic_compra_ww
		and	nr_item_solic_compra = nr_item_solic_compra_ww
		and	cd_material = cd_material_ww;
		
		if (qt_existe_w = 0) then
			select	cd_material
			into STRICT	cd_material_ww
			from	solic_compra_item
			where	nr_solic_compra = nr_solic_compra_ww
			and	nr_item_solic_compra = nr_item_solic_compra_ww;
		end if;
		
		select  coalesce(max(nr_item_solic_compra),0)+1
		into STRICT 	nr_item_solic_compra_www
		from 	solic_compra_item
		where	nr_solic_compra = nr_solic_compra_w;
		
		select	coalesce(max(nr_item_solic_compra),0)
		into STRICT	nr_item_encontrado_w
		from	solic_compra_item
		where	nr_solic_compra = nr_solic_compra_w
		and	cd_material = cd_material_ww;
		
		if (nr_item_encontrado_w = 0) then			
		
			insert into solic_compra_item(
				nr_solic_compra,							nr_item_solic_compra,
				cd_material,								cd_unidade_medida_compra,
				qt_material,								dt_atualizacao,
				nm_usuario,								ie_situacao,
				ds_material_direto,							ds_observacao,
				nr_cot_compra,								nr_item_cot_compra,
				dt_solic_item,								nr_seq_aprovacao,
				dt_autorizacao,								vl_unit_previsto,
				ie_geracao,								nr_seq_proj_rec,
				dt_reprovacao,								qt_conv_compra_est_orig,
				qt_saldo_disp_estoque,
				nr_ordem_compra_orig)
			SELECT	nr_solic_compra_w,							nr_item_solic_compra_www,
				cd_material_ww,								cd_unidade_medida_compra,
				qt_prevista_entrega_ww,							clock_timestamp(),
				nm_usuario_p,								ie_situacao,
				ds_material_direto,							substr(WHEB_MENSAGEM_PCK.get_texto(298636,'DS_OBSERVACAO_W='||DS_OBSERVACAO||';NR_ORDEM_COMPRA_P='||NR_ORDEM_COMPRA_P),1,255), /*#@DS_OBSERVACAO_W#@ Gerada no cancelamento da Ordem de compra numero #@NR_ORDEM_COMPRA_P#@.*/
				null,									null,
				dt_prevista_entrega_w,							CASE WHEN ie_manter_sc_pend_lib_w='N' THEN nr_seq_aprovacao  ELSE null END ,
				CASE WHEN ie_manter_sc_pend_lib_w='N' THEN dt_autorizacao  ELSE null END ,		vl_unit_previsto,
				ie_geracao,								nr_seq_proj_rec_w,
				CASE WHEN ie_manter_sc_pend_lib_w='N' THEN dt_reprovacao  ELSE null END ,			obter_dados_material(cd_material,'QCE'),
				obter_saldo_disp_estoque(cd_estabelecimento_w, cd_material, cd_local_estoque_w, trunc(clock_timestamp(),'mm')),
				nr_ordem_compra_p
			from	solic_compra_item
			where	nr_solic_compra = nr_solic_compra_ww
			and	nr_item_solic_compra = nr_item_solic_compra_ww;
			
		else
			nr_item_solic_compra_www := nr_item_encontrado_w;
			
			update	solic_compra_item
			set	qt_material		= qt_material + qt_prevista_entrega_ww
			where	nr_solic_compra 	= nr_solic_compra_w
			and	nr_item_solic_compra	= nr_item_solic_compra_www;
			
		end if;		
		
		
		select	coalesce(max(nr_item_solic_compra_entr), 0) + 1
		into STRICT	nr_item_solic_compra_entr_w
		from	solic_compra_item_entrega
		where	nr_solic_compra = nr_solic_compra_w
		and	nr_item_solic_compra = nr_item_solic_compra_www;

		insert into solic_compra_item_entrega(
			nr_solic_compra,
			nr_item_solic_compra,
			nr_item_solic_compra_entr,
			qt_entrega_solicitada,
			dt_entrega_solicitada,
			dt_atualizacao,
			nm_usuario)
		values (	nr_solic_compra_w,
			nr_item_solic_compra_www,
			nr_item_solic_compra_entr_w,
			qt_prevista_entrega_ww,
			dt_prevista_entrega_w,
			clock_timestamp(),
			nm_usuario_p);

		/*Faz o update somente no fim, para poder gravar os itens antes da exportacao*/

		update	solic_compra
		set	ie_forma_exportar = '0'
		where	nr_solic_compra = nr_solic_compra_w;

		/*Faz o update no item da ordem, identificando a nova solicitacao gerada*/

		update	ordem_compra_item
		set	nr_solic_compra_cancel = nr_solic_compra_w
		where	nr_ordem_compra	= nr_ordem_compra_p
		and	nr_item_oci		= nr_item_oci_p
		and	coalesce(nr_solic_compra_cancel::text, '') = '';

		update	ordem_compra_item_entrega
		set	ds_observacao = WHEB_MENSAGEM_PCK.get_texto(298641,'NR_SOLIC_COMPRA_W='||NR_SOLIC_COMPRA_W||';DS_OBSERVACAO_W='||DS_OBSERVACAO) /*Solicitacao gerada = #@NR_SOLIC_COMPRA_W#@ #@DS_OBSERVACAO_W#@*/
		where	nr_sequencia = nr_sequencia_p;
		
		CALL ajusta_entrega_atrasadas_solic(nr_solic_compra_w, 'C', nm_usuario_p);

		end;
	end if;
	end;
end if;

select	count(*)
into STRICT	qt_registro_w
from	ordem_compra_item_entrega
where	coalesce(dt_cancelamento::text, '') = ''
and	coalesce(qt_prevista_entrega,0) > coalesce(qt_real_entrega,0)
and	nr_ordem_compra = nr_ordem_compra_p
and	nr_item_oci = coalesce(nr_item_oci_p,nr_item_oci);

if (qt_registro_w = 0) then
	begin
	select	count(*)
	into STRICT	qt_registro_w
	from	ordem_compra_item_entrega
	where	coalesce(dt_cancelamento::text, '') = ''
	and	coalesce(qt_prevista_entrega,0) > coalesce(qt_real_entrega,0)
	and	nr_ordem_compra = nr_ordem_compra_p;
	
	if (qt_registro_w = 0) and (ie_cancela_ordem_p = 'S') then
		CALL BAIXAR_ORDEM_COMPRA(nr_ordem_compra_p, null, null, nm_usuario_p);
	end if;
	end;
end if;

if (ie_cancela_ordem_p = 'S') then
	ds_titulo_baixa_oc_w	:= Wheb_mensagem_pck.get_Texto(298646); /*Ordem de compra baixada.*/
	ds_historico_w		:= Wheb_mensagem_pck.get_Texto(298648); /*'Resposta do usuario para a pergunta "Nao existe mais itens pendentes para esta ordem de compra. Deseja baixar a mesma? (SIM)"');*/
elsif (ie_cancela_ordem_p = 'N') then
	ds_titulo_baixa_oc_w	:= Wheb_mensagem_pck.get_Texto(298650); /*Ordem de compra nao baixada.*/
	ds_historico_w		:= Wheb_mensagem_pck.get_Texto(298652); /*Resposta do usuario para a pergunta "Nao existe mais itens pendentes para esta ordem de compra. Deseja baixar a mesma? (NAO)"'*/
end if;

if (ds_titulo_baixa_oc_w IS NOT NULL AND ds_titulo_baixa_oc_w::text <> '') and (ds_historico_w IS NOT NULL AND ds_historico_w::text <> '') then

	CALL inserir_historico_ordem_compra(
			nr_ordem_compra_p,
			'S',
			ds_titulo_baixa_oc_w,
			substr(ds_historico_w,1,400),
			nm_usuario_p);

end if;

if (ie_nova_cotacao_p = 'S') then

	/* OS 1630300 - Se o item for totalmente cancelado, com geracao de nova cotacao, mas sem cancelamento de processo, estorna baixa do item na solicitacao de compra */

	if (coalesce(ie_cancela_processo_p,'N') = 'N' and coalesce(ie_cancela_item_solic_p, 'N') = 'N') then
		begin
		select	count(*)
		into STRICT	qt_existe_w
		from	ordem_compra_item_entrega
		where	nr_ordem_compra = nr_ordem_compra_p
		and	nr_item_oci = nr_item_oci_p
		and	coalesce(dt_cancelamento::text, '') = '';

		if (qt_existe_w = 0) then
			select	max(coalesce(nr_solic_compra, 0)),
				max(coalesce(nr_item_solic_compra, 0))
			into STRICT	nr_solic_compra_wwww,
				nr_item_solic_compra_wwwww
			from	ordem_compra_item
			where	nr_ordem_compra = nr_ordem_compra_p
			and	nr_item_oci = nr_item_oci_p;
			
			select	count(*)
			into STRICT	qt_existe_w
			from	solic_compra_item
			where	nr_solic_compra = nr_solic_compra_wwww
			and	nr_item_solic_compra = nr_item_solic_compra_wwwww
			and ((dt_baixa IS NOT NULL AND dt_baixa::text <> '') or (cd_motivo_baixa IS NOT NULL AND cd_motivo_baixa::text <> ''));
			
			if (qt_existe_w > 0)then
			begin
			
				update	solic_compra_item
				set	cd_motivo_baixa	 = NULL,
					dt_baixa	 = NULL
				where	nr_solic_compra	= nr_solic_compra_wwww
				and nr_item_solic_compra = nr_item_solic_compra_wwwww;
				
				/* Estorno da baixa do item da solicitacao de compras */


				/* Foi estornada a baixa do item #@NR_ITEM_SOLIC_COMPRA_P#@ ao cancelar o item #@NR_ITEM_OCI_P#@ na ordem de compra #@NR_ORDEM_COMPRA_P#@.  */

				CALL gerar_historico_solic_compra(nr_solic_compra_wwww,
				WHEB_MENSAGEM_PCK.get_texto(300823),
				WHEB_MENSAGEM_PCK.get_texto(1033448, 'NR_ITEM_SOLIC_COMPRA_P=' || nr_item_solic_compra_wwwww 
					|| ';NR_ITEM_OCI_P=' || nr_item_oci_p
					|| ';NR_ORDEM_COMPRA_P=' || nr_ordem_compra_p), 
				'T', /* estorno baixa */
				nm_usuario_p);
				
				select	count(*)
				into STRICT	qt_existe_w
				from	solic_compra
				where	nr_solic_compra = nr_solic_compra_wwww
				and ((dt_baixa IS NOT NULL AND dt_baixa::text <> '') or (cd_motivo_baixa IS NOT NULL AND cd_motivo_baixa::text <> ''));
				
				if (qt_existe_w > 0)then
				begin
												
					update	solic_compra
					set	cd_motivo_baixa	 = NULL,
						dt_baixa	 = NULL
					where	nr_solic_compra	= nr_solic_compra_wwww;		

					/* Estorno da baixa da solicitacao de compras. */


					/* Foi estornada a baixa da solicitacao, ao estornar a baixa do item #@NR_ITEM_SOLIC_COMPRA_P#@ 
					no cancelamento do item #@NR_ITEM_OCI_P#@ na ordem de compra #@NR_ORDEM_COMPRA_P#@. */
					CALL gerar_historico_solic_compra(nr_solic_compra_wwww,
					WHEB_MENSAGEM_PCK.get_texto(300287),
					WHEB_MENSAGEM_PCK.get_texto(1033449, 'NR_ITEM_SOLIC_COMPRA_P=' || nr_item_solic_compra_wwwww 
					|| ';NR_ITEM_OCI_P=' || nr_item_oci_p
					|| ';NR_ORDEM_COMPRA_P=' || nr_ordem_compra_p), 
					'T', /* estorno baixa */
					nm_usuario_p);
				
				end;
				end if;
			
			end;
			end if;					
			
		end if;		
		end;
	end if;	
	gerar_nova_cotacao_OC(	nr_ordem_compra_p, nr_item_oci_p, nr_Sequencia_p, ie_mantem_forn_cot_p, nm_usuario_p, nr_cot_compra_w);	
	
	if (nr_cot_compra_w > 0) and (nr_sequencia_p > 0) then
		
		update	ordem_compra_item_entrega
		set	ds_observacao = SUBSTR(ds_observacao || ' ' || wheb_mensagem_pck.get_Texto(355843, 'NR_COT_COMPRA_W='|| nr_cot_compra_w),1,255) /*Gerada a nova cotacao #@NR_COT_COMPRA_W#@.*/
		where	nr_sequencia = nr_sequencia_p;
	end if;
end if;

if (nr_solic_compra_w = 0) then
	select	max(coalesce(nr_solic_compra, 0)),
		max(coalesce(nr_item_solic_compra, 0))
	into STRICT	nr_solic_compra_w,
		nr_item_solic_compra_w
	from	ordem_compra_item
	where	nr_ordem_compra = nr_ordem_compra_p
	and	nr_item_oci = nr_item_oci_p;
end if;

if (nr_solic_compra_w > 0) and (nr_item_solic_compra_w > 0) then
	select	count(*)
	into STRICT	ie_solic_exportada_w
	from	solic_compra
	where	nr_solic_compra = nr_solic_compra_w
	and	ie_forma_exportar = '1';
	if (ie_solic_exportada_w > 0) then
		update	ordem_compra_item_entrega
		set	ie_status_exportar = '0'
		where	nr_sequencia = nr_sequencia_p;
	end if;
end if;
/* Envia Comunicacao Interna conforme regra de envio SHIFT + F11 */

select	obter_classif_comunic('F')
into STRICT	nr_seq_classif_w
;

open C04;
loop
fetch C04 into	
	nr_seq_regra_ci_w,
	cd_perfil_ww;
EXIT WHEN NOT FOUND; /* apply on C04 */
	begin
	
	select	count(*)
	into STRICT	qt_regra_usuario_w
	from	regra_envio_comunic_compra a,
		regra_envio_comunic_evento b,
		regra_envio_comunic_usu c
	where	a.nr_sequencia = b.nr_seq_regra
	and	b.nr_sequencia = c.nr_seq_evento
	and	b.nr_sequencia = nr_seq_regra_ci_w;

	select	coalesce(ie_ci_lida,'N')
	into STRICT	ie_ci_lida_w
	from 	regra_envio_comunic_evento
	where 	nr_sequencia = nr_seq_regra_ci_w;

	if (qt_regra_usuario_w > 0) then

		/* Pega o setor do usuario solicitante da ordem de compra */

		if (nm_usuario_solicitante_w <> 'X') then
			select	coalesce(cd_setor_atendimento,0)
			into STRICT	cd_setor_solicitante_w
			from    	usuario
			where   	nm_usuario = nm_usuario_solicitante_w;
		end if;

		open C05;
		loop
		fetch C05 into	
			cd_setor_regra_usuario_w,
			ie_usuario_regra_ci_w;
		EXIT WHEN NOT FOUND; /* apply on C05 */
			begin
			if (cd_setor_regra_usuario_w <> 0) and (obter_se_contido_char(cd_setor_regra_usuario_w, ds_setor_adicional_w) = 'N') then
				ds_setor_adicional_w := substr(ds_setor_adicional_w || cd_setor_regra_usuario_w || ',',1,2000);
			end if;

			if (ie_usuario_regra_ci_w = 'SSO') and (obter_se_contido_char(cd_setor_solicitante_w, ds_setor_adicional_w) = 'N') then
				ds_setor_adicional_w := substr(ds_setor_adicional_w || cd_setor_solicitante_w || ',',1,2000);
			end if;
			end;
		end loop;
		close C05;

		nm_usuario_destino_w	:= '';
		nm_usuario_destino_w	:= obter_usuarios_comunic_compras(nr_ordem_compra_p,null,49,nr_seq_regra_ci_w,'');
		ds_titulo_w		:= '';
		ds_comunic_w		:= '';
		
		select	ds_titulo,
			ds_comunicacao
		into STRICT	ds_titulo_w,
			ds_comunic_w
		from	regra_envio_comunic_evento
		where	nr_sequencia = nr_seq_regra_ci_w;
		
		ds_titulo_w := substr(replace_macro(ds_titulo_w,'@ordem',nr_ordem_compra_p),1,80);
		ds_titulo_w := substr(replace_macro(ds_titulo_w,'@nr_item',nr_item_oci_p),1,80);
		ds_titulo_w := substr(replace_macro(ds_titulo_w,'@material',cd_material_w),1,80);
		ds_titulo_w := substr(replace_macro(ds_titulo_w,'@descricao',ds_material_w),1,80);
		ds_titulo_w := substr(replace_macro(ds_titulo_w,'@dt_prevista_entrega', dt_prevista_entrega_w),1,80);
		ds_titulo_w := substr(replace_macro(ds_titulo_w,'@qt_prevista_entrega', qt_prevista_entrega_ww),1,80);
		ds_titulo_w := substr(replace_macro(ds_titulo_w,'@observacao', ds_observacao_p),1,80);
		ds_titulo_w := substr(replace_macro(ds_titulo_w,'@motivo',ds_motivo_w),1,80);
		ds_titulo_w := ds_titulo_w;
		
		ds_comunic_w := substr(replace_macro(ds_comunic_w,'@ordem',nr_ordem_compra_p),1,4000);
		ds_comunic_w := substr(replace_macro(ds_comunic_w,'@nr_item',nr_item_oci_p),1,4000);
		ds_comunic_w := substr(replace_macro(ds_comunic_w,'@material',cd_material_w),1,4000);
		ds_comunic_w := substr(replace_macro(ds_comunic_w,'@descricao',ds_material_w),1,4000);
		ds_comunic_w := substr(replace_macro(ds_comunic_w,'@dt_prevista_entrega', dt_prevista_entrega_w),1,4000);
		ds_comunic_w := substr(replace_macro(ds_comunic_w,'@qt_prevista_entrega', qt_prevista_entrega_ww),1,4000);
		ds_comunic_w := substr(replace_macro(ds_comunic_w,'@observacao', ds_observacao_p),1,4000);
		ds_comunic_w := substr(replace_macro(ds_comunic_w,'@motivo',ds_motivo_w),1,4000);
		ds_comunic_w := ds_comunic_w;
		
		if (nm_usuario_destino_w IS NOT NULL AND nm_usuario_destino_w::text <> '') then

			select	nextval('comunic_interna_seq')
			into STRICT	nr_seq_comunic_w
			;

			if (cd_perfil_ww IS NOT NULL AND cd_perfil_ww::text <> '') then
				cd_perfil_ww := cd_perfil_ww ||',';
			end if;

			insert	into comunic_interna(
				cd_estab_destino,				dt_comunicado,				ds_titulo,
				ds_comunicado,				nm_usuario,				dt_atualizacao,
				ie_geral,					nm_usuario_destino,			nr_sequencia,
				ie_gerencial,				nr_seq_classif,				dt_liberacao,
				ds_perfil_adicional,				ds_setor_adicional)
			values (	cd_estabelecimento_w,			clock_timestamp(),					ds_titulo_w,
				ds_comunic_w,				nm_usuario_p,				clock_timestamp(),
				'N',					nm_usuario_destino_w,			nr_seq_comunic_w,
				'N',					nr_seq_classif_w,				clock_timestamp(),
				cd_perfil_ww,				ds_setor_adicional_w);

			/*Para que a comunicacao seja gerada como lida ao proprio usuario */

			if (ie_ci_lida_w = 'S') then
				insert into comunic_interna_lida(nr_sequencia,nm_usuario,dt_atualizacao)values (nr_seq_comunic_w,nm_usuario_p,clock_timestamp());
			end if;
		end if;
	end if;	
	end;
end loop;
close C04;

/* Condicao criada para enviar e-mail da regra 24 somente se disparado de um usuario do portal de compras
   pois a regra indica: "Ordem - Ao cancelar um item da ordem de compra no portal (envia para comprador)
   OS: 1838570"
 */
select count(nm_usuario)
into STRICT qt_usuario_tasy_w
from usuario
where nm_usuario = nm_usuario_p;

select	coalesce(max(nr_sequencia),0),
	max(replace(ds_email_adicional,',',';')),
	coalesce(max(ds_email_remetente),'X'),
	coalesce(max(ie_momento_envio),'I')
into STRICT	nr_seq_regra_w,
	ds_email_adicional_w,
	ds_email_remetente_w,
	ie_momento_envio_w
from	regra_envio_email_compra
where	ie_tipo_mensagem = 24
and	ie_situacao = 'A'
and	cd_estabelecimento = cd_estabelecimento_w
and	obter_se_envia_email_regra(nr_ordem_compra_p, 'OC', 24, cd_estabelecimento_w) = 'S';

if (nr_seq_regra_w > 0 and qt_usuario_tasy_w = 0) then
	begin		
	select	substr(ds_assunto, 1, 80),
		substr(ds_mensagem_padrao, 1, 2000)
	into STRICT	ds_assunto_w,
		ds_mensagem_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_seq_regra_w;

	ds_assunto_w := substr(replace_macro(ds_assunto_w,'@ordem',nr_ordem_compra_p),1,80);
	ds_assunto_w := substr(replace_macro(ds_assunto_w,'@nr_item',nr_item_oci_p),1,80);
	ds_assunto_w := substr(replace_macro(ds_assunto_w,'@material',cd_material_w),1,80);
	ds_assunto_w := substr(replace_macro(ds_assunto_w,'@descricao',ds_material_w),1,80);
	ds_assunto_w := substr(replace_macro(ds_assunto_w,'@comprador', nm_comprador_w),1,80);
	ds_assunto_w := substr(replace_macro(ds_assunto_w,'@motivo',ds_observacao_p),1,80);
	ds_assunto_w := substr(replace_macro(ds_assunto_w,'@fantasia_pj',nm_fantasia_w),1,80);
	ds_assunto_w := substr(replace_macro(ds_assunto_w,'@razao_pj',ds_razao_social_w),1,80);
	ds_assunto_w := substr(ds_assunto_w,1,80);

	ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@ordem',nr_ordem_compra_p),1,4000);
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@nr_item',nr_item_oci_p),1,4000);
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@material',cd_material_w),1,4000);
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@descricao',ds_material_w),1,4000);
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@comprador', nm_comprador_w),1,4000);
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@motivo',ds_observacao_p),1,4000);
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@fantasia_pj',nm_fantasia_w),1,4000);
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@razao_pj',ds_razao_social_w),1,4000);
	ds_mensagem_w := substr(ds_mensagem_w,1,4000);

	select	coalesce(max(ie_usuario),'U'),
		max(cd_perfil_disparar)
	into STRICT	ie_usuario_w,
		cd_perfil_disparar_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_seq_regra_w;

	if (ie_usuario_w = 'U') then --Usuario
		select	ds_email,
			nm_usuario
		into STRICT	ds_email_origem_w,
			ds_usuario_origem_w
		from	usuario
		where	nm_usuario = nm_usuario_w;
	elsif (ie_usuario_w = 'C') then --Setor compras
		select	ds_email
		into STRICT	ds_email_origem_w
		from	parametro_compras
		where	cd_estabelecimento = cd_estabelecimento_w;
		
		select	coalesce(ds_fantasia,ds_razao_social)
		into STRICT	ds_usuario_origem_w
		from	estabelecimento_v
		where	cd_estabelecimento = cd_estabelecimento_w;
	elsif (ie_usuario_w = 'O') then --Comprador
		ds_email_origem_w	:= ds_email_comprador_w;
		ds_usuario_origem_w	:= ds_usuario_comprador_w;
	end if;
	
	if (ds_email_adicional_w IS NOT NULL AND ds_email_adicional_w::text <> '') and
		((coalesce(cd_perfil_disparar_w::text, '') = '') or
		(cd_perfil_disparar_w IS NOT NULL AND cd_perfil_disparar_w::text <> '' AND cd_perfil_disparar_w = obter_perfil_ativo)) then
		ds_email_comprador_w := ds_email_comprador_w || ';' || ds_email_adicional_w;
	end if;

	if (ds_email_remetente_w <> 'X') then
		ds_email_origem_w	:= ds_email_remetente_w;
	end if;

	if (ie_momento_envio_w = 'A') then
		begin

		CALL sup_grava_envio_email(
			'OC',
			'24',
			null,
			null,
			nr_ordem_compra_p,
			ds_email_comprador_w,
			ds_usuario_origem_w,
			ds_email_origem_w,
			ds_assunto_w,
			ds_mensagem_w,
			cd_estabelecimento_w,
			nm_usuario_p);

		end;
	else
		begin
		CALL enviar_email(ds_assunto_w,ds_mensagem_w,ds_email_origem_w,ds_email_comprador_w,ds_usuario_origem_w,'M');
		exception when others then
			ds_assunto_w := '';	
		end;
	end if;

	end;
end if;

--if	(dt_inicio_pendencia_w is not null) then
	select	coalesce(max(nr_sequencia),0),
		max(replace(ds_email_adicional,',',';')),
		max(cd_perfil_disparar),
		coalesce(max(ie_momento_envio),'I')
	into STRICT	nr_seq_regra_w,
		ds_email_adicional_w,
		cd_perfil_dispara_w,
		ie_momento_envio_w
	from	regra_envio_email_compra
	where	ie_tipo_mensagem = 53
	and	ie_situacao = 'A'
	and	cd_estabelecimento = cd_estabelecimento_w
	and	obter_se_envia_email_regra(nr_ordem_compra_p, 'OC', 53, cd_estabelecimento_w) = 'S';
	
	if (ds_email_destino_w IS NOT NULL AND ds_email_destino_w::text <> '') and (nr_seq_regra_w > 0) and
		((coalesce(cd_perfil_dispara_w::text, '') = '') or
		(cd_perfil_dispara_w IS NOT NULL AND cd_perfil_dispara_w::text <> '' AND cd_perfil_dispara_w = obter_perfil_ativo)) then
		begin	

		select	substr(ds_assunto, 1, 80),
			substr(ds_mensagem_padrao, 1, 2000)
		into STRICT	ds_assunto_w,
			ds_mensagem_w
		from	regra_envio_email_compra
		where	nr_sequencia = nr_seq_regra_w;
		
		ds_assunto_w := substr(replace_macro(ds_assunto_w,'@ordem',nr_ordem_compra_p),1,80);
		ds_assunto_w := substr(replace_macro(ds_assunto_w,'@nr_item', nr_item_oci_p),1,80);
		ds_assunto_w := substr(replace_macro(ds_assunto_w,'@dt_prev_entrega',dt_prevista_entrega_w),1,80);
		ds_assunto_w := substr(replace_macro(ds_assunto_w,'@qt_prev_entrega',qt_prevista_entrega_w),1,80);
		ds_assunto_w := substr(replace_macro(ds_assunto_w,'@material',cd_material_w),1,80);
		ds_assunto_w := substr(replace_macro(ds_assunto_w,'@descricao',ds_material_w),1,80);
		ds_assunto_w := substr(replace_macro(ds_assunto_w,'@cd_unid_medida',cd_unidade_medida_compra_w),1,80);
		ds_assunto_w := substr(replace_macro(ds_assunto_w,'@ds_fornecedor',ds_razao_social_w),1,80);
		ds_assunto_w := substr(replace_macro(ds_assunto_w,'@ds_motivo_cancel',ds_motivo_w),1,80);
		ds_assunto_w := substr(replace_macro(ds_assunto_w,'@ds_observacao',ds_observacao_p),1,80);
		ds_assunto_w := substr(replace_macro(ds_assunto_w,'@ds_motivo',ds_motivo_pend_w),1,80);
		ds_assunto_w := ds_assunto_w;
			
		ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@ordem',nr_ordem_compra_p),1,4000);
		ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@nr_item', nr_item_oci_p),1,4000);
		ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@dt_prev_entrega',dt_prevista_entrega_w),1,4000);
		ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@qt_prev_entrega',qt_prevista_entrega_w),1,4000);
		ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@material',cd_material_w),1,4000);
		ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@descricao',ds_material_w),1,4000);
		ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@cd_unid_medida',cd_unidade_medida_compra_w),1,4000);
		ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@ds_fornecedor',ds_razao_social_w),1,4000);
		ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@ds_motivo_cancel',ds_motivo_w),1,4000);
		ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@ds_observacao',ds_observacao_p),1,4000);
		ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@ds_motivo',ds_motivo_pend_w),1,4000);
		ds_mensagem_w := ds_mensagem_w;

		select	coalesce(max(ie_usuario),'U')
		into STRICT	ie_usuario_w
		from	regra_envio_email_compra
		where	nr_sequencia = nr_seq_regra_w;
	
		if (ie_usuario_w = 'U') then --Usuario
			select	ds_email,
				nm_usuario
			into STRICT	ds_email_origem_w,
				ds_usuario_origem_w
			from	usuario
			where	nm_usuario = nm_usuario_p;
		elsif (ie_usuario_w = 'C') then --Setor compras
			select	ds_email
			into STRICT	ds_email_origem_w
			from	parametro_compras
			where	cd_estabelecimento = cd_estabelecimento_w;
			
			select	coalesce(ds_fantasia,ds_razao_social)
			into STRICT	ds_usuario_origem_w
			from	estabelecimento_v
			where	cd_estabelecimento = cd_estabelecimento_w;
		elsif (ie_usuario_w = 'O') then --Comprador
			ds_email_origem_w	:= ds_email_comprador_w;
			ds_usuario_origem_w	:= ds_usuario_comprador_w;
		end if;

		if (ds_email_adicional_w IS NOT NULL AND ds_email_adicional_w::text <> '') then
			ds_email_destino_w := ds_email_destino_w || ';' || ds_email_adicional_w;
		end if;
	
		select	count(*)
		into STRICT	qt_existe_w
		
		where 	obter_se_envia_email_internet(53,null,cd_estabelecimento_w, nr_ordem_compra_p) = 'S'
		and	obter_se_envia_email_ordem(53,nr_ordem_compra_p, cd_estabelecimento_w) = 'S';
		
		if (qt_existe_w > 0) then
			begin
			if (ie_momento_envio_w = 'A') then
				begin

				CALL sup_grava_envio_email(
					'OC',
					'53',
					nr_ordem_compra_p,
					null,
					null,
					ds_email_destino_w,
					ds_usuario_origem_w,
					ds_email_origem_w,
					ds_assunto_w,
					ds_mensagem_w,
					cd_estabelecimento_w,
					nm_usuario_p);

				end;
			else
				begin
				CALL enviar_email(ds_assunto_w, ds_mensagem_w, ds_email_origem_w, ds_email_destino_w, ds_usuario_origem_w, 'M');
				exception when others then
					ds_assunto_w := '';
				end;
			end if;

			end;
		end if;
		end;
	end if;
--end if;
nr_cot_compra_p   := nr_cot_compra_w;
nr_solic_compra_p := nr_solic_compra_w;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cancelar_entrega_item ( nr_ordem_compra_p bigint, nr_item_oci_p bigint, nr_sequencia_p bigint, ie_nova_solic_p text, ie_nova_cotacao_p text, ie_mantem_forn_cot_p text, nm_usuario_p text, ds_observacao_p text, nr_seq_motivo_cancel_p bigint, ie_cancela_ordem_p text, ie_cancela_processo_p text, cd_material_p integer, ie_cancela_item_solic_p text, nr_cot_compra_p INOUT bigint, nr_solic_compra_p INOUT bigint) FROM PUBLIC;

