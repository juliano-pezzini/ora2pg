-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_envio_comunic_sug ( nm_usuario_p text, nr_seq_sugestao_p bigint, dt_inicial_p timestamp, dt_final_p timestamp) AS $body$
DECLARE


ds_destinos_w					varchar(255) := '';

C01 CURSOR FOR
	SELECT	substr(
		wheb_mensagem_pck.get_texto(305928) || chr(13) || chr(10) ||
		CASE WHEN a.nm_usuario_destino='' THEN  ''  ELSE wheb_mensagem_pck.get_texto(305921,'nm_usuario_destino=' || a.nm_usuario_destino ) END || chr(13) || chr(10) ||
		CASE WHEN a.ds_perfil_adicional='' THEN ''   ELSE wheb_mensagem_pck.get_texto(305924,';ds_perfil_adicional=' || obter_desc_perfil_adicional(a.ds_perfil_adicional)) END  || chr(13) || chr(10) ||
		CASE WHEN a.ds_setor_adicional='' THEN ''   ELSE wheb_mensagem_pck.get_texto(305925,';ds_setor_adicional=' || obter_desc_setor_adicional(a.ds_setor_adicional)) END  || chr(13) || chr(10) ||
		CASE WHEN a.ds_grupo='' THEN ''   ELSE wheb_mensagem_pck.get_texto(305926,';ds_grupo=' || obter_desc_grupo_adicional(a.ds_grupo)) END  || chr(13) || chr(10) ||
		CASE WHEN a.ds_grupo_perfil='' THEN ''   ELSE wheb_mensagem_pck.get_texto(305927,';ds_grupo_perfil=' || obter_desc_grupo_perfil(a.ds_grupo_perfil)) END
		,1,255)
	from	comunic_interna a
	where	dt_comunicado between
		dt_inicial_p and
		dt_final_p
	and	a.nm_usuario = nm_usuario_p
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '');


BEGIN
open C01;
loop
fetch C01 into
	ds_destinos_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') and (coalesce(ds_destinos_w,'X') <> 'X') then

		insert	into sug_sugestao_envio(nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						nr_seq_sugestao,
						ds_destino,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						dt_envio)
			values (nextval('sug_sugestao_envio_seq'),
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_sugestao_p,
						ds_destinos_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp());

		end if;
	end;
end loop;
close C01;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_envio_comunic_sug ( nm_usuario_p text, nr_seq_sugestao_p bigint, dt_inicial_p timestamp, dt_final_p timestamp) FROM PUBLIC;

