-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vinc_atendimento_cirurgia ( nr_seq_agenda_p bigint, nr_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_pessoa_fisica_w	varchar(10);
nr_cirurgia_w		bigint;
cd_estabelecimento_w	smallint;
ie_atendimento_w	varchar(15);
nr_atendimento_w	bigint := null;

BEGIN
 
if (coalesce(nr_seq_agenda_p,0) > 0) then 
 
	select	max(nr_atendimento) 
	into STRICT	nr_atendimento_w 
	from	agenda_paciente 
	where	nr_sequencia = nr_seq_agenda_p;
 
	if (coalesce(nr_atendimento_w,0) > 0) then 
 
		select	coalesce(max(cd_estabelecimento),0) 
		into STRICT	cd_estabelecimento_w 
		from	atendimento_paciente	 
		where	nr_atendimento	=	nr_atendimento_w;
 
		select	coalesce(nr_cirurgia,0) 
		into STRICT	nr_cirurgia_w 
		from	agenda_paciente 
		where	nr_sequencia	=	nr_seq_agenda_p;
 
		ie_atendimento_w := obter_param_usuario(871, 84, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_atendimento_w);
 
		if (nr_cirurgia_w > 0) then 
 
			select	cd_pessoa_fisica 
			into STRICT	cd_pessoa_fisica_w 
			from	atendimento_paciente 
			where	nr_atendimento	=	nr_atendimento_w;
 
			update	cirurgia 
			set	cd_pessoa_fisica	=	cd_pessoa_fisica_w, 
				nr_atendimento		=	CASE WHEN ie_atendimento_w='S' THEN coalesce(nr_atendimento,nr_atendimento_w)  ELSE nr_atendimento END , 
				nm_usuario		=	nm_usuario_p, 
				dt_atualizacao		=	clock_timestamp() 
			where	nr_cirurgia		=	nr_cirurgia_w 
			AND	coalesce(nr_atendimento::text, '') = '';
			commit;
			 
			if (ie_atendimento_w = 'S') then 
				update	prescr_medica 
				set	nr_atendimento	= coalesce(nr_atendimento,nr_atendimento_w) 
				where	nr_cirurgia	= nr_cirurgia_w 
				and 	coalesce(ie_tipo_prescr_cirur,0) <> 2;
			end if;	
		end if;
	end if;	
end if;	
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vinc_atendimento_cirurgia ( nr_seq_agenda_p bigint, nr_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

