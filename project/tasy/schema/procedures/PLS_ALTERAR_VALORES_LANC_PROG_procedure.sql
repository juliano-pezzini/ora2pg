-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alterar_valores_lanc_prog ( nr_seq_lancamento_p bigint, vl_lancamento_p bigint, tx_lancamento_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_alteracao_w	varchar(255);
vl_item_w	double precision;
tx_desconto_w	double precision;


BEGIN

begin
select	vl_item,
	tx_desconto
into STRICT	vl_item_w,
	tx_desconto_w
from	pls_segurado_mensalidade
where	nr_sequencia	= nr_seq_lancamento_p;
exception
when others then
	vl_item_w	:= 0;
	tx_desconto_w	:= 0;
end;

begin
update	pls_segurado_mensalidade
set	vl_item		= vl_lancamento_p,
	tx_desconto	= tx_lancamento_p
where	nr_sequencia	= nr_seq_lancamento_p;
exception
when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(265884,'');
	--Ocorreu um problema ao alterar o valor/taxa do lançamento programado!
end;

ds_alteracao_w	:= 'Alteração no valor do lançamento: ';

if (coalesce(vl_item_w,0) <> coalesce(vl_lancamento_p,0)) then
	ds_alteracao_w	:= ds_alteracao_w || 'Valor anterior: '||vl_item_w||' - Valor atualizado: '||vl_lancamento_p||'; ';
end if;

if (coalesce(tx_desconto_w,0) <> coalesce(tx_lancamento_p,0)) then
	ds_alteracao_w	:= ds_alteracao_w || 'Taxa anterior: '||tx_desconto_w||' - Taxa atualizada: '||tx_lancamento_p||'; ';
end if;

begin
insert	into	pls_mensalidade_prog_log(	nr_sequencia, nr_seq_lanc_prog, nm_usuario_alteracao,
		dt_alteracao, dt_atualizacao, nm_usuario,
		dt_atualizacao_nrec, nm_usuario_nrec, ds_alteracao)
	values (	nextval('pls_mensalidade_prog_log_seq'), nr_seq_lancamento_p, nm_usuario_p,
		clock_timestamp(), clock_timestamp(), nm_usuario_p,
		clock_timestamp(), nm_usuario_p, ds_alteracao_w);
exception
when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(265884,'');
	--Ocorreu um problema ao gravar o histórico da alteração do lançamento programado!
end;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alterar_valores_lanc_prog ( nr_seq_lancamento_p bigint, vl_lancamento_p bigint, tx_lancamento_p bigint, nm_usuario_p text) FROM PUBLIC;

