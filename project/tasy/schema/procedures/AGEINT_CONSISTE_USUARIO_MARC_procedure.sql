-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ageint_consiste_usuario_marc ( cd_agenda_p bigint, dt_agenda_p timestamp, nr_minuto_duracao_p bigint, nm_usuario_p text, ds_mensagem_p INOUT text) AS $body$
DECLARE


qt_marc_cons_w		bigint;
qt_marc_exame_w		bigint;
ds_retorno_w		varchar(1)	:= 'N';
cd_tipo_agenda_w	bigint;
nr_seq_grupo_agecons_w	bigint;
nm_usuario_marc_w	varchar(15);
nm_pac_marc_w		varchar(60);
nm_pf_usuario_w		varchar(60);	
nr_seq_Ageint_w		bigint;
ie_sobreposicao_encaixe_w	varchar(1) := 'S';			
			

BEGIN


select	coalesce(max(ie_sobreposicao_encaixe),'S')
into STRICT	ie_sobreposicao_encaixe_w
from	parametro_agenda
where	cd_estabelecimento = obter_estabelecimento_ativo;

select	cd_tipo_agenda,
	Ageint_Obter_Grupo_Agenda_Cons(cd_agenda)
into STRICT	cd_tipo_agenda_w,
	nr_seq_grupo_agecons_w
from	agenda
where	cd_agenda	= cd_agenda_p;

if (cd_tipo_agenda_w	= 2) then
	select	max(a.nm_usuario),
		max(d.nm_paciente),
		max(d.nr_sequencia)
	into STRICT	nm_usuario_marc_w,
		nm_pac_marc_w,
		nr_seq_Ageint_w
	FROM agenda_integrada d, agenda_integrada_item c, ageint_marcacao_usuario a
LEFT OUTER JOIN agenda_paciente b ON (a.nr_seq_agenda = b.nr_sequencia)
WHERE a.cd_agenda = cd_agenda_p and c.nr_seq_Agenda_int	= d.nr_sequencia and a.nr_seq_Ageint_item	= c.nr_sequencia and c.ie_tipo_agendamento	= 'E'  and coalesce(b.ie_status_agenda,'L') <> 'C' and a.nm_usuario <> nm_usuario_p and ((ie_sobreposicao_encaixe_w = 'N' and b.ie_encaixe <> 'S' ) or ie_sobreposicao_encaixe_w = 'S') and (a.hr_agenda between dt_agenda_p and dt_agenda_p + (nr_minuto_duracao_p - 1) / 1440);
elsif (cd_tipo_agenda_w <> 5) then -- Esta rotina nunca tratou Agendamentos de servico, Correcao para nao bloquear os agendamentos de servico.
	select	max(a.nm_usuario),
		max(d.nm_paciente),
		max(d.nr_sequencia)
	into STRICT	nm_usuario_marc_w,
		nm_pac_marc_w,
		nr_seq_Ageint_w
	FROM agenda_integrada d, agenda_integrada_item c, ageint_marcacao_usuario a
LEFT OUTER JOIN agenda_consulta b ON (a.nr_seq_agenda = b.nr_sequencia)
WHERE a.cd_agenda = cd_agenda_p and c.nr_seq_Agenda_int	= d.nr_sequencia and a.nr_seq_Ageint_item	= c.nr_sequencia and c.ie_tipo_agendamento	<> 'E'  and coalesce(b.ie_status_agenda,'L') <> 'C' and a.nm_usuario <> nm_usuario_p and ((ie_sobreposicao_encaixe_w = 'N' and b.ie_encaixe <> 'S' ) or ie_sobreposicao_encaixe_w = 'S') and (a.hr_agenda between dt_agenda_p and dt_agenda_p + (nr_minuto_duracao_p - 1) / 1440);
	
	if (coalesce(nm_usuario_marc_w::text, '') = '') and (nr_seq_grupo_agecons_w > 0) then
		select	max(a.nm_usuario),
			max(d.nm_paciente),
			max(d.nr_sequencia)
		into STRICT	nm_usuario_marc_w,
			nm_pac_marc_w,
			nr_seq_Ageint_w
		FROM ageint_agendas_grupo e, agenda_integrada d, agenda_integrada_item c, ageint_marcacao_usuario a
LEFT OUTER JOIN agenda_consulta b ON (a.nr_seq_agenda = b.nr_sequencia)
WHERE c.nr_seq_Agenda_int	= d.nr_sequencia and a.nr_seq_Ageint_item	= c.nr_sequencia and e.cd_agenda		= a.cd_agenda and e.nr_seq_grupo		= nr_seq_grupo_agecons_w and c.ie_tipo_agendamento	<> 'E'  and coalesce(b.ie_status_agenda,'L') <> 'C' and a.nm_usuario <> nm_usuario_p and (a.hr_agenda between dt_agenda_p and dt_agenda_p + (nr_minuto_duracao_p - 1) / 1440);
	end if;
	
end if;

if (nm_usuario_marc_w IS NOT NULL AND nm_usuario_marc_w::text <> '') then
	select	SUBSTR(coalesce(OBTER_NOME_PF(max(b.cd_pessoa_fisica)),nm_usuario_marc_w), 0, 60)
	into STRICT	nm_pf_usuario_w
	from	usuario a,
		pessoa_fisica b
	where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
	and	a.nm_usuario		= nm_usuario_marc_w;
	
	ds_mensagem_p	:= wheb_mensagem_pck.get_texto(306822,	'NM_PF_USUARIO_W=' || nm_pf_usuario_w || ';' ||
															'NR_SEQ_AGEINT_W=' || nr_seq_ageint_w || ';' ||
															'NM_PAC_MARC_W=' || nm_pac_marc_w);
					-- O horario esta reservado pelo usuario #@NM_PF_USUARIO_W#@, para o agendamento #@NR_SEQ_AGEINT_W#@ #@NM_PAC_MARC_W#@
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageint_consiste_usuario_marc ( cd_agenda_p bigint, dt_agenda_p timestamp, nr_minuto_duracao_p bigint, nm_usuario_p text, ds_mensagem_p INOUT text) FROM PUBLIC;

