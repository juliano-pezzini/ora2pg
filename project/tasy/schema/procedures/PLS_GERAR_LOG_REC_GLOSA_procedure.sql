-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_log_rec_glosa ( ie_acao_p text, valor_ref_p pls_rec_glosa_conta.vl_total_acatado%type, nr_seq_rec_ref_p pls_rec_glosa_conta.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, ie_tipo_log_p text, nr_seq_protocolo_p pls_rec_glosa_protocolo.nr_sequencia%type default null, nr_seq_mot_lib_glosa_p pls_mot_rec_glosa.nr_sequencia%type default null) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Gerar histórico de ações tomadas sobre recursos de glosa
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[ ]  Objetos do dicionário [x] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
IE_ACAO_P-----IE_ACAO_P-----IE_ACAO_P-----IE_ACAO_P-----IE_ACAO_P-----IE_ACAO_P
'F' - Fechar recurso glosa
'R' - Reabrir recurso glosa
'A' - Acatar recurso glosa
'N' - Negar recurso glosa
'C' - Cancelar recurso glosa
'DFA' - Desfazer fechamento da análise de recurso de glosa
'DANP' - Desfazer acatar/negar recurso de glosa (procedimento)
'AIP' - Acatar item de recurso glosa (procedimento)
'NIP' - Negar item de recurso glosa (procedimento)
'APIP' - Acatar parcialmente item de recurso glosa (procedimento)
'DANM' - Desfazer acatar/negar recurso de glosa (material)
'AIM' - Acatar item de recurso glosa (material)
'NIM' - Negar item de recurso glosa (material)
'APIM' - Acatar parcialmente item de recurso glosa (material)
'LP' - Liberar para pagamento (protocolo)
'DLP' - Desfazer liberar para pagamento (protoclo)
IE_ACAO_P-----IE_ACAO_P-----IE_ACAO_P-----IE_ACAO_P-----IE_ACAO_P-----IE_ACAO_P
Alterações:
-------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ds_log_w		varchar(255);
nr_seq_conta_rec_w	pls_rec_glosa_conta.nr_sequencia%type;
ds_log_call_w 		varchar(4000) := '';
nr_seq_proc_rec_w	pls_rec_glosa_proc.nr_sequencia%type;
nr_seq_mat_rec_w	pls_rec_glosa_mat.nr_sequencia%type;

C01 CURSOR(nr_seq_conta_rec_pc		pls_rec_glosa_conta.nr_sequencia%type) FOR
	SELECT	nr_sequencia nr_seq_proc_rec,
		null nr_seq_mat_rec
	from	pls_rec_glosa_proc
	where	nr_seq_conta_rec = nr_seq_conta_rec_pc
	
union all

	SELECT	null nr_seq_proc_rec,
		nr_sequencia nr_seq_mat_rec
	from	pls_rec_glosa_mat
	where	nr_seq_conta_rec = nr_seq_conta_rec_pc;

BEGIN

ds_log_call_w := substr( ' Função ativa : '|| obter_funcao_ativa || chr(13) ||chr(10)||
' CallStack: '|| chr(13) || chr(10)|| dbms_utility.format_call_stack,1,1500);

if (ie_tipo_log_p = 'C') then
	nr_seq_conta_rec_w := nr_seq_rec_ref_p;

elsif (ie_tipo_log_p = 'P') then
	nr_seq_proc_rec_w := nr_seq_rec_ref_p;

	select	nr_seq_conta_rec
	into STRICT	nr_seq_conta_rec_w
	from	pls_rec_glosa_proc
	where	nr_sequencia = nr_seq_proc_rec_w;

elsif (ie_tipo_log_p = 'M') then
	nr_seq_mat_rec_w := nr_seq_rec_ref_p;

	select	nr_seq_conta_rec
	into STRICT	nr_seq_conta_rec_w
	from	pls_rec_glosa_mat
	where	nr_sequencia = nr_seq_rec_ref_p;
end if;

--Nível de conta
if (ie_acao_p = 'F') then --Fechar recurso glosa
	ds_log_w := 'Ação: Fechar recurso de glosa';

elsif (ie_acao_p = 'R') then --Reabrir recurso glosa
	ds_log_w := 'Ação: Reabrir recurso de glosa';

elsif (ie_acao_p = 'C') then --Cancelar recurso glosa
	ds_log_w := 'Ação: Cancelar recurso de glosa';

elsif (ie_acao_p = 'A') then --Acatar recurso glosa
	ds_log_w := 'Ação: Acatar recurso de glosa' || ' - ' || 'Valor acatado: ' || to_char(valor_ref_p, '999,999,999,999.00');

elsif (ie_acao_p = 'N') then --Negar recurso glosa
	ds_log_w := 'Ação: Negar recurso de glosa' || ' - ' || 'Valor recursado: ' || to_char(valor_ref_p, '999,999,999,999.00');

elsif (ie_acao_p = 'DFA') then -- Desfazer fechamento da conta (análise)
	ds_log_w := 'Ação: Desfazer fechamento da análise de recurso de glosa.';

elsif (ie_acao_p = 'DANP') then --Desfazer acatar/negar recurso de glosa
	ds_log_w := 'Ação: Desfazer acatar/negar recurso de glosa';

elsif (ie_acao_p = 'AIP') then --Acatar item de recurso glosa (procedimento)
	ds_log_w := 'Ação: Acatar item de recurso glosa' || ' - ' || 'Valor acatado: ' || to_char(valor_ref_p, '999,999,999,999.00');

elsif (ie_acao_p = 'NIP') then --Negar item de recurso glosa (procedimento)
	ds_log_w := 'Ação: Negar item de recurso glosa' || ' - ' || 'Valor recursado: ' || to_char(valor_ref_p, '999,999,999,999.00');

elsif (ie_acao_p = 'APIP') then --Acatar parcialmente item de recurso glosa (procedimento)
	ds_log_w := 'Ação: Acatar parcialmente item de recurso glosa' || ' - ' || 'Valor acatado: ' || to_char(valor_ref_p, '999,999,999,999.00');

elsif (ie_acao_p = 'DANM') then --Desfazer acatar/negar recurso de glosa
	ds_log_w := 'Ação: Desfazer acatar/negar recurso de glosa';

elsif (ie_acao_p = 'AIM') then --Acatar item de recurso glosa (material)
	ds_log_w := 'Ação: Acatar item de recurso glosa' || ' - ' || 'Valor acatado: ' || to_char(valor_ref_p, '999,999,999,999.00');

elsif (ie_acao_p = 'NIM') then --Negar item de recurso glosa (material)
	ds_log_w := 'Ação: Negar item de recurso glosa' || ' - ' || 'Valor recursado: ' || to_char(valor_ref_p, '999,999,999,999.00');

elsif (ie_acao_p = 'APIM') then --Acatar parcialmente item de recurso glosa (material)
	ds_log_w := 'Ação: Acatar parcialmente item de recurso glosa' || ' - ' || 'Valor acatado: ' || to_char(valor_ref_p, '999,999,999,999.00');

elsif (ie_acao_p = 'LP') then -- Liberar para pagamento (protocolo)
	ds_log_w := 'Ação: Liberar protocolo para pagamento';

elsif (ie_acao_p = 'DLP') then -- Desfazer liberar para pagamento (protoclo)
	ds_log_w := 'Ação: Desfazer liberaçã do protocolo para pagamento';
end if;

insert	into	pls_hist_rec_glosa( 	nr_sequencia, ds_log, dt_atualizacao,
		nm_usuario, ds_call_stack, nr_seq_protocolo,
		nr_seq_conta_rec, nr_seq_mat_rec, nr_seq_proc_rec,
		nr_seq_mot_lib_glosa)
values (	nextval('pls_hist_rec_glosa_seq'), ds_log_w, clock_timestamp(),
		nm_usuario_p, ds_log_call_w, nr_seq_protocolo_p,
		nr_seq_conta_rec_w, nr_seq_mat_rec_w, nr_seq_proc_rec_w,
		nr_seq_mot_lib_glosa_p);

if (ie_acao_p = 'C') then
	for r_C01_w in C01(nr_seq_conta_rec_w) loop
		insert	into	pls_hist_rec_glosa( 	nr_sequencia, ds_log, dt_atualizacao,
				nm_usuario, ds_call_stack, nr_seq_protocolo,
				nr_seq_conta_rec, nr_seq_mat_rec, nr_seq_proc_rec,
				nr_seq_mot_lib_glosa)
		values (	nextval('pls_hist_rec_glosa_seq'), ds_log_w, clock_timestamp(),
				nm_usuario_p, ds_log_call_w, nr_seq_protocolo_p,
				nr_seq_conta_rec_w, r_C01_w.nr_seq_mat_rec, r_C01_w.nr_seq_proc_rec,
				nr_seq_mot_lib_glosa_p);
	end loop;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_log_rec_glosa ( ie_acao_p text, valor_ref_p pls_rec_glosa_conta.vl_total_acatado%type, nr_seq_rec_ref_p pls_rec_glosa_conta.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, ie_tipo_log_p text, nr_seq_protocolo_p pls_rec_glosa_protocolo.nr_sequencia%type default null, nr_seq_mot_lib_glosa_p pls_mot_rec_glosa.nr_sequencia%type default null) FROM PUBLIC;

