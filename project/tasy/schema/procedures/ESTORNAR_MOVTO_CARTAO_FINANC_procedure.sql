-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE estornar_movto_cartao_financ ( nr_seq_extrato_arq_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w			bigint;
nr_seq_extrato_w 		extrato_cartao_cr_movto.nr_seq_extrato%type;
nr_seq_extrato_res_w 	extrato_cartao_cr_movto.nr_seq_extrato_res%type;
vl_parcela_w			extrato_cartao_cr_movto.vl_parcela%type;
qt_parcelas_w			extrato_cartao_cr_movto.qt_parcelas%type;
nr_cartao_w				extrato_cartao_cr_movto.nr_cartao%type;
nr_autorizacao_w		extrato_cartao_cr_movto.nr_autorizacao%type;
ds_comprovante_w		extrato_cartao_cr_movto.ds_comprovante%type;
ds_rejeicao_w			extrato_cartao_cr_movto.ds_rejeicao%type;
dt_compra_w				extrato_cartao_cr_movto.dt_compra%type;
nr_parcela_w			extrato_cartao_cr_movto.nr_parcela%type;
ie_pagto_indevido_w		extrato_cartao_cr_movto.ie_pagto_indevido%type;
vl_liquido_w			extrato_cartao_cr_movto.vl_liquido%type;
vl_saldo_concil_cred_w	extrato_cartao_cr_movto.vl_saldo_concil_cred%type;


C01 CURSOR FOR
	SELECT nr_seq_extrato,
			nr_seq_extrato_res,
			(vl_parcela * -1),
			qt_parcelas,
			nr_cartao,
			nr_autorizacao,
			ds_comprovante,
			ds_rejeicao,
			dt_compra,
			nr_parcela,
			ie_pagto_indevido, -- verificar se deve ser em branco
			(vl_liquido * -1),
			(vl_saldo_concil_cred* -1)
			from	extrato_cartao_cr_movto
			where	nr_seq_extrato_arq	= nr_seq_extrato_arq_p;


BEGIN

select	nextval('movto_cartao_cr_baixa_seq')
into STRICT	nr_sequencia_w
;

open	c01;
loop
fetch	c01 into
		nr_seq_extrato_w,
		nr_seq_extrato_res_w,
		vl_parcela_w,
		qt_parcelas_w,
		nr_cartao_w,
		nr_autorizacao_w,
		ds_comprovante_w,
		ds_rejeicao_w,
		dt_compra_w,
		nr_parcela_w,
		ie_pagto_indevido_w,
		vl_liquido_w,
		vl_saldo_concil_cred_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

insert	into	extrato_cartao_cr_movto(nr_sequencia,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_atualizacao,
			nm_usuario,
			nr_seq_extrato,
			nr_seq_extrato_res,
			vl_parcela,
			qt_parcelas,
			nr_cartao,
			nr_autorizacao,
			ds_comprovante,
			ds_rejeicao,
			dt_compra,
			nr_parcela,
			ie_pagto_indevido,
			vl_liquido,
			vl_saldo_concil_cred)
	values	(nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_extrato_w,
			nr_seq_extrato_res_w,
			(vl_parcela_w * -1),
			qt_parcelas_w,
			nr_cartao_w,
			nr_autorizacao_w,
			ds_comprovante_w,
			ds_rejeicao_w,
			dt_compra_w,
			nr_parcela_w,
			ie_pagto_indevido_w, -- verificar se deve ser em branco
			(vl_liquido_w * -1),
			(vl_saldo_concil_cred_w* -1));
end loop;
close c01;

update	extrato_cartao_cr_arq
set	dt_baixa  = NULL
where	nr_sequencia	= nr_seq_extrato_arq_p;

commit;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE estornar_movto_cartao_financ ( nr_seq_extrato_arq_p bigint, nm_usuario_p text) FROM PUBLIC;

