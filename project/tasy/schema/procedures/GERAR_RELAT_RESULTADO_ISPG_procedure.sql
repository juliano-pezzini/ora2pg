-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_relat_resultado_ispg (nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ds_pedido_w			varchar(255);
nm_paciente_w		varchar(255);
ds_idade_w			varchar(255);
ds_origem_w			varchar(255);
ds_convenio_w		varchar(255);
nm_medico_w			varchar(255);
dt_entrada_w		varchar(255);
ds_destino_w		varchar(255);
dt_coleta_w			varchar(255);
dt_entrega_w		varchar(255);
ds_sexo_w			varchar(255);
ds_contato_w		varchar(255);
nr_atendimento_w	varchar(255);
cd_exames_prescr_w	varchar(255);
ds_obs_w			varchar(255);
ds_grupo_w			varchar(255);
ds_prescr_w			varchar(255);
nr_prescr_w			bigint;
nr_seq_grupo_par_w	bigint;
nm_exame1_w			varchar(255);
qt_result_w			varchar(255);
ds_result_w			varchar(255);
pr_result_w			varchar(255);
ds_referencia_w		varchar(255);
nm_usuario_w		varchar(255);
nr_seq_apresent_w	varchar(255);
nr_seq_exame_w		varchar(255);
nr_seq_prescr_w		varchar(255);
ie_ordem_w			varchar(255);

nr_linha_w			bigint;
cont_w				bigint;
nr_sequencia_w		bigint;
nr_pagina_w			bigint;
nr_total_w			bigint;

c01 CURSOR FOR 
SELECT	distinct(obter_desc_expressao(295394)/*'Pedido: '*/
	||': ' || b.nr_prescricao) ds_pedido, 
	('Nome: ' || c.nm_paciente) nm_paciente, 
	(obter_desc_expressao(326096)/*'Idade: '*/
 || c.ds_idade) ds_idade, 
	(obter_desc_expressao(327633)/*'Origem.: '*/
 || obter_desc_procedencia(c.cd_procedencia)) ds_origem, 
	(obter_desc_expressao(326148)/*'Convênio: '*/
 || c.cd_convenio || ' - ' || c.ds_convenio) ds_convenio, 
	('Dr.(a): ' || SUBSTR(OBTER_NOME_PF(g.CD_PESSOA_FISICA), 0, 255)) nm_medico, 
	(obter_desc_expressao(289269)/*'Entrada: '*/
	||': ' || c.dt_entrada) dt_entrada, 
	(obter_desc_expressao(329684)/*'Destino: '*/
 || obter_nome_setor(b.cd_setor_entrega)) ds_destino, 
	(obter_desc_expressao(285474)/*'Coleta: '*/
	||': ' || to_char(a.dt_coleta, 'dd/mm/yyyy')) dt_coleta, 
	(obter_desc_expressao(289280)/*'Entrega: '*/
	||': ' || to_char(b.dt_entrega,'dd/mm/yyyy')) dt_entrega, 
	('Sexo: ' || c.ds_sexo) ds_sexo, 
	(obter_desc_expressao(629938)/*'Contato: '*/
 || c.nr_telefone_celular) ds_contato, 
	(obter_desc_expressao(344885)/*'Atend.: '*/
 || c.nr_atendimento) nr_atendimento, 
	('Exa.: ' || obter_select_concatenado_bv('select	a.cd_exame 
											 from	exame_laboratorio a, 
													prescr_procedimento b 
											 where	a.nr_seq_exame = b.nr_seq_exame 
											 and	b.nr_prescricao  = :nr_prescr', 'nr_prescr='+b.nr_prescricao,',')) cd_exames_prescr, 
	('Obs.: ' || b.ds_observacao) ds_obs, 
	(obter_desc_expressao(330233)/*'Grupo: '*/
 || ds_grupo_exame_lab) ds_grupo, 
	(obter_desc_expressao(346473)/*'Prescr.: '*/
 || b.nr_prescricao) ds_prescr, 
	b.nr_prescricao nr_prescr, 
	d.nr_seq_grupo nr_seq_grupo_par 
from	pessoa_fisica g, 
	exame_laboratorio d, 
	grupo_exame_lab j, 
	prescr_medica b, 
	prescr_procedimento a, 
	atendimento_paciente_v c 
where	c.nr_atendimento	= b.nr_atendimento 
and	b.nr_prescricao		= a.nr_prescricao 
and	a.nr_seq_exame		= d.nr_seq_exame 
and	d.nr_seq_grupo		= j.nr_sequencia 
and	b.cd_medico		= g.cd_pessoa_fisica 
and	b.nr_prescricao		= nr_prescricao_p 
and (0 = coalesce(nr_seq_prescr_p, 0) or a.nr_sequencia = nr_seq_prescr_p);

c02 CURSOR FOR 
SELECT	distinct 
	coalesce((obter_desc_expressao(621805)/*'Exame: '*/
 || d.nm_exame),'') nm_exame1, 
	coalesce(('Qt result.: ' || c.qt_resultado),'') qt_result, 
	coalesce((obter_desc_expressao(722599)/*'Resultado: '*/
 || c.ds_resultado),'') ds_result, 
	coalesce(('% result.: ' || c.pr_resultado),'') pr_result, 
	(obter_desc_expressao(297388)/*'Refer.: '*/
	||': ' || c.ds_referencia) ds_referencia, 
	('Resp. aprov.: ' || obter_nome_usuario(c.nm_usuario_aprovacao)) nm_usuario, 
	coalesce(nr_seq_apresent,'') nr_seq_apresent, 
	coalesce(d.nr_seq_exame,'') nr_seq_exame, 
	coalesce(a.nr_prescricao,'') nr_prescr, 
	coalesce(c.nr_seq_prescr,'') nr_seq_prescr, 
	coalesce(d.nr_seq_grupo,'') nr_seq_grupo_par, 
	2 ie_ordem 
from	exame_laboratorio d, 
	exame_lab_result_item c, 
	prescr_procedimento a, 
	exame_lab_resultado b 
where	d.nr_seq_exame		= c.nr_seq_exame 
and	b.nr_seq_resultado	= c.nr_seq_resultado 
and	a.nr_sequencia		= c.nr_seq_prescr 
and	a.nr_prescricao		= b.nr_prescricao 
and 	a.nr_prescricao		= nr_prescr_w 
and	d.nr_seq_grupo		= nr_seq_grupo_par_w 
and (0 = coalesce(nr_seq_prescr_p, 0) or a.nr_sequencia = nr_seq_prescr_p) 

union all
 
SELECT	distinct 
	coalesce(d.nm_exame,'') nm_exame1, 
	'' qt_result, 
	'' ds_result, 
	'' pr_result, 
	(obter_desc_expressao(297388)/*'Refer.: '*/
	||': ' || c.ds_referencia) ds_referencia, 
	('Resp. aprov.: ' || obter_nome_usuario(c.nm_usuario_aprovacao)) nm_usuario, 
	coalesce(nr_seq_apresent,'') nr_seq_apresent, 
	coalesce(d.nr_seq_exame,'') nr_seq_exame, 
	coalesce(a.nr_prescricao,'') nr_prescr, 
	coalesce(c.nr_seq_prescr,'') nr_seq_prescr, 
	coalesce(d.nr_seq_grupo,'') nr_seq_grupo_par, 
	1 ie_ordem 
from	exame_laboratorio d, 
		exame_lab_result_item c, 
		prescr_procedimento a, 
		exame_lab_resultado b 
where	d.nr_seq_exame		= c.nr_seq_exame 
and	b.nr_seq_resultado	= c.nr_seq_resultado 
and	a.nr_sequencia		= c.nr_seq_prescr 
and	a.nr_prescricao		= b.nr_prescricao 
and	a.nr_prescricao		= nr_prescr_w 
and	d.nr_seq_grupo		= nr_seq_grupo_par_w 
and	(nr_seq_material IS NOT NULL AND nr_seq_material::text <> '') 
and (0 = coalesce(nr_seq_prescr_p, 0) or a.nr_sequencia = nr_seq_prescr_p) 
order by nr_seq_prescr, 
	 ie_ordem, 
	 nr_seq_prescr;


BEGIN 
 
delete	from w_mapa_lab_ispg 
where	nm_usuario	= nm_usuario_p;
 
commit;
 
nr_linha_w	:= 0;
nr_pagina_w	:= 0;
 
open c01;
loop 
fetch c01 into 
	ds_pedido_w, 
	nm_paciente_w, 
	ds_idade_w, 
	ds_origem_w, 
	ds_convenio_w, 
	nm_medico_w, 
	dt_entrada_w, 
	ds_destino_w, 
	dt_coleta_w, 
	dt_entrega_w, 
	ds_sexo_w, 
	ds_contato_w, 
	nr_atendimento_w, 
	cd_exames_prescr_w, 
	ds_obs_w, 
	ds_grupo_w, 
	ds_prescr_w, 
	nr_prescr_w, 
	nr_seq_grupo_par_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	select	nextval('w_mapa_lab_ispg_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	nr_linha_w	:= nr_linha_w + 1;
	insert into w_mapa_lab_ispg(nr_sequencia, 
		 dt_atualizacao, 
		 nm_usuario, 
		 nr_linha, 
		 ds_linha, 
		 ds_coluna) 
	values (nr_sequencia_w, 
		 clock_timestamp(), 
		 nm_usuario_p, 
		 nr_linha_w, 
		 ds_pedido_w, 
		 ds_origem_w);
 
	select	nextval('w_mapa_lab_ispg_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	nr_linha_w	:= nr_linha_w + 1;
	insert into w_mapa_lab_ispg(nr_sequencia, 
		 dt_atualizacao, 
		 nm_usuario, 
		 nr_linha, 
		 ds_linha, 
		 ds_coluna) 
	values (nr_sequencia_w, 
		 clock_timestamp(), 
		 nm_usuario_p, 
		 nr_linha_w, 
		 nm_paciente_w, 
		 ds_sexo_w || '  ' || ds_idade_w);
 
	select	nextval('w_mapa_lab_ispg_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	nr_linha_w	:= nr_linha_w + 1;
	insert into w_mapa_lab_ispg(nr_sequencia, 
		 dt_atualizacao, 
		 nm_usuario, 
		 nr_linha, 
		 ds_linha, 
		 ds_coluna) 
	values (nr_sequencia_w, 
		 clock_timestamp(), 
		 nm_usuario_p, 
		 nr_linha_w, 
		 ds_grupo_w, 
		 ds_destino_w);
 
	select	nextval('w_mapa_lab_ispg_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	nr_linha_w	:= nr_linha_w + 1;
	insert into w_mapa_lab_ispg(nr_sequencia, 
		 dt_atualizacao, 
		 nm_usuario, 
		 nr_linha, 
		 ds_linha, 
		 ds_coluna) 
	values (nr_sequencia_w, 
		 clock_timestamp(), 
		 nm_usuario_p, 
		 nr_linha_w, 
		 nm_medico_w, 
		 nr_atendimento_w || '  ' || ds_contato_w);
 
	select	nextval('w_mapa_lab_ispg_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	nr_linha_w	:= nr_linha_w + 1;
	insert into w_mapa_lab_ispg(nr_sequencia, 
		 dt_atualizacao, 
		 nm_usuario, 
		 nr_linha, 
		 ds_linha, 
		 ds_coluna) 
	values (nr_sequencia_w, 
		 clock_timestamp(), 
		 nm_usuario_p, 
		 nr_linha_w, 
		 dt_coleta_w, 
		 dt_entrega_w || '  ' || ds_prescr_w);
 
	select	nextval('w_mapa_lab_ispg_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	nr_linha_w	:= nr_linha_w + 1;
	insert into w_mapa_lab_ispg(nr_sequencia, 
		 dt_atualizacao, 
		 nm_usuario, 
		 nr_linha, 
		 ds_linha) 
	values (nr_sequencia_w, 
		 clock_timestamp(), 
		 nm_usuario_p, 
		 nr_linha_w, 
		 ds_obs_w);
 
	select	nextval('w_mapa_lab_ispg_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	nr_linha_w	:= nr_linha_w + 1;
	nr_pagina_w	:= nr_pagina_w + 1;
	insert into w_mapa_lab_ispg(nr_sequencia, 
		 dt_atualizacao, 
		 nm_usuario, 
		 nr_linha, 
		 ds_linha) 
	values (nr_sequencia_w, 
		 clock_timestamp(), 
		 nm_usuario_p, 
		 nr_linha_w, 
		 '-------------------------- Pág.: ' || nr_pagina_w);
 
	cont_w	:= 0;
 
	open c02;
	loop 
	fetch c02 into 
		nm_exame1_w, 
		qt_result_w, 
		ds_result_w, 
		pr_result_w, 
		ds_referencia_w, 
		nm_usuario_w, 
		nr_seq_apresent_w, 
		nr_seq_exame_w, 
		nr_prescr_w, 
		nr_seq_prescr_w, 
		nr_seq_grupo_par_w, 
		ie_ordem_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
 
		if (cont_w	< 3) then 
 
			if (ie_ordem_w	= 1) then 
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
	 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nm_usuario, 
					 nr_linha, 
					 ds_linha) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nm_usuario_p, 
					 nr_linha_w, 
					 nm_exame1_w);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nm_usuario, 
					 nr_linha, 
					 ds_linha) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nm_usuario_p, 
					 nr_linha_w, 
					 ds_referencia_w);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nm_usuario, 
					 nr_linha, 
					 ds_linha) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nm_usuario_p, 
					 nr_linha_w, 
					 '');
			else 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nm_usuario, 
					 nr_linha, 
					 ds_linha) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nm_usuario_p, 
					 nr_linha_w, 
					 nm_exame1_w);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nm_usuario, 
					 nr_linha, 
					 ds_linha, 
					 ds_coluna) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nm_usuario_p, 
					 nr_linha_w, 
					 pr_result_w, 
					 qt_result_w);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nm_usuario, 
					 nr_linha, 
					 ds_linha, 
					 ds_coluna) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nm_usuario_p, 
					 nr_linha_w, 
					 ds_referencia_w, 
					 nm_usuario_w);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nm_usuario, 
					 nr_linha, 
					 ds_linha) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nm_usuario_p, 
					 nr_linha_w, 
					 ds_result_w);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nm_usuario, 
					 nr_linha, 
					 ds_linha) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nm_usuario_p, 
					 nr_linha_w, 
					 '');
				cont_w	:= cont_w + 1;
			end if;
		else 
			select	max(nr_linha) 
			into STRICT	nr_total_w 
			from	w_mapa_lab_ispg 
			where	nm_usuario	= nm_usuario_p;
 
			if (mod(nr_total_w, 33) <> 1) then 
				while(mod(nr_total_w, 33) <> 1) loop 
 
					select	nextval('w_mapa_lab_ispg_seq') 
					into STRICT	nr_sequencia_w 
					;
 
					nr_linha_w	:= nr_linha_w + 1;
					insert into w_mapa_lab_ispg(nr_sequencia, 
						 dt_atualizacao, 
						 nr_linha, 
						 ds_linha, 
						 nm_usuario) 
					values (nr_sequencia_w, 
						 clock_timestamp(), 
						 nr_linha_w, 
						 '', 
						 nm_usuario_p);
					nr_total_w	:= nr_total_w + 1;
				end loop;
			end if;
 
			select	nextval('w_mapa_lab_ispg_seq') 
			into STRICT	nr_sequencia_w 
			;
 
			nr_linha_w	:= nr_linha_w + 1;
			insert into w_mapa_lab_ispg(nr_sequencia, 
				 dt_atualizacao, 
				 nm_usuario, 
				 nr_linha, 
				 ds_linha, 
				 ds_coluna) 
			values (nr_sequencia_w, 
				 clock_timestamp(), 
				 nm_usuario_p, 
				 nr_linha_w, 
				 ds_pedido_w, 
				 ds_origem_w);
 
			select	nextval('w_mapa_lab_ispg_seq') 
			into STRICT	nr_sequencia_w 
			;
 
			nr_linha_w	:= nr_linha_w + 1;
			insert into w_mapa_lab_ispg(nr_sequencia, 
				 dt_atualizacao, 
				 nm_usuario, 
				 nr_linha, 
				 ds_linha, 
				 ds_coluna) 
			values (nr_sequencia_w, 
				 clock_timestamp(), 
				 nm_usuario_p, 
				 nr_linha_w, 
				 nm_paciente_w, 
				 ds_sexo_w || '  ' || ds_idade_w);
 
			select	nextval('w_mapa_lab_ispg_seq') 
			into STRICT	nr_sequencia_w 
			;
 
			nr_linha_w	:= nr_linha_w + 1;
			insert into w_mapa_lab_ispg(nr_sequencia, 
				 dt_atualizacao, 
				 nm_usuario, 
				 nr_linha, 
				 ds_linha, 
				 ds_coluna) 
			values (nr_sequencia_w, 
				 clock_timestamp(), 
				 nm_usuario_p, 
				 nr_linha_w, 
				 ds_grupo_w, 
				 ds_destino_w);
 
			select	nextval('w_mapa_lab_ispg_seq') 
			into STRICT	nr_sequencia_w 
			;
 
			nr_linha_w	:= nr_linha_w + 1;
			insert into w_mapa_lab_ispg(nr_sequencia, 
				 dt_atualizacao, 
				 nm_usuario, 
				 nr_linha, 
				 ds_linha, 
				 ds_coluna) 
			values (nr_sequencia_w, 
				 clock_timestamp(), 
				 nm_usuario_p, 
				 nr_linha_w, 
				 nm_medico_w, 
				 nr_atendimento_w || '  ' || ds_contato_w);
 
			select	nextval('w_mapa_lab_ispg_seq') 
			into STRICT	nr_sequencia_w 
			;
 
			nr_linha_w	:= nr_linha_w + 1;
			insert into w_mapa_lab_ispg(nr_sequencia, 
				 dt_atualizacao, 
				 nm_usuario, 
				 nr_linha, 
				 ds_linha, 
				 ds_coluna) 
			values (nr_sequencia_w, 
				 clock_timestamp(), 
				 nm_usuario_p, 
				 nr_linha_w, 
				 dt_coleta_w, 
				 dt_entrega_w || '  ' || ds_prescr_w);
 
			select	nextval('w_mapa_lab_ispg_seq') 
			into STRICT	nr_sequencia_w 
			;
 
			nr_linha_w	:= nr_linha_w + 1;
			insert into w_mapa_lab_ispg(nr_sequencia, 
				 dt_atualizacao, 
				 nm_usuario, 
				 nr_linha, 
				 ds_linha) 
			values (nr_sequencia_w, 
				 clock_timestamp(), 
				 nm_usuario_p, 
				 nr_linha_w, 
				 ds_obs_w);
 
			select	nextval('w_mapa_lab_ispg_seq') 
			into STRICT	nr_sequencia_w 
			;
 
			nr_linha_w	:= nr_linha_w + 1;
			nr_pagina_w	:= nr_pagina_w + 1;
			insert into w_mapa_lab_ispg(nr_sequencia, 
				 dt_atualizacao, 
				 nm_usuario, 
				 nr_linha, 
				 ds_linha) 
			values (nr_sequencia_w, 
				 clock_timestamp(), 
				 nm_usuario_p, 
				 nr_linha_w, 
				 '-------------------------- Pág.: ' || nr_pagina_w);
 
			cont_w	:= 0;
 
			if (ie_ordem_w	= 1) then 
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
	 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nm_usuario, 
					 nr_linha, 
					 ds_linha) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nm_usuario_p, 
					 nr_linha_w, 
					 nm_exame1_w);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nm_usuario, 
					 nr_linha, 
					 ds_linha) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nm_usuario_p, 
					 nr_linha_w, 
					 ds_referencia_w);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nm_usuario, 
					 nr_linha, 
					 ds_linha) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nm_usuario_p, 
					 nr_linha_w, 
					 '');
			else 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nm_usuario, 
					 nr_linha, 
					 ds_linha) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nm_usuario_p, 
					 nr_linha_w, 
					 nm_exame1_w);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nm_usuario, 
					 nr_linha, 
					 ds_linha, 
					 ds_coluna) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nm_usuario_p, 
					 nr_linha_w, 
					 pr_result_w, 
					 qt_result_w);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nm_usuario, 
					 nr_linha, 
					 ds_linha, 
					 ds_coluna) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nm_usuario_p, 
					 nr_linha_w, 
					 ds_referencia_w, 
					 nm_usuario_w);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nm_usuario, 
					 nr_linha, 
					 ds_linha) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nm_usuario_p, 
					 nr_linha_w, 
					 ds_result_w);
 
				select	nextval('w_mapa_lab_ispg_seq') 
				into STRICT	nr_sequencia_w 
				;
 
				nr_linha_w	:= nr_linha_w + 1;
				insert into w_mapa_lab_ispg(nr_sequencia, 
					 dt_atualizacao, 
					 nm_usuario, 
					 nr_linha, 
					 ds_linha) 
				values (nr_sequencia_w, 
					 clock_timestamp(), 
					 nm_usuario_p, 
					 nr_linha_w, 
					 '');
				cont_w	:= cont_w + 1;
			end if;
 
		end if;
 
	end loop;
	close c02;
 
	select	max(nr_linha) 
	into STRICT	nr_total_w 
	from	w_mapa_lab_ispg 
	where	nm_usuario	= nm_usuario_p;
 
	if (mod(nr_total_w, 33) <> 1) then 
		while(mod(nr_total_w, 33) <> 1) loop 
 
			select	nextval('w_mapa_lab_ispg_seq') 
			into STRICT	nr_sequencia_w 
			;
 
			nr_linha_w	:= nr_linha_w + 1;
			insert into w_mapa_lab_ispg(nr_sequencia, 
				 dt_atualizacao, 
				 nr_linha, 
				 ds_linha, 
				 nm_usuario) 
			values (nr_sequencia_w, 
				 clock_timestamp(), 
				 nr_linha_w, 
				 '', 
				 nm_usuario_p);
 
			nr_total_w	:= nr_total_w + 1;
		end loop;
	end if;
 
commit;	
 
end loop;
close c01;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_relat_resultado_ispg (nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text) FROM PUBLIC;

