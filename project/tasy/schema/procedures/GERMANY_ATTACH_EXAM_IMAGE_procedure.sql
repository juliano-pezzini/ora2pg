-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE germany_attach_exam_image ( nr_atendimento_p text, nr_prescricao_p text, ds_arquivo_imagem_p text, cd_exame_p text, nr_seq_empresa_p bigint, nm_usuario_p text, ds_path_p INOUT text) AS $body$
DECLARE


nr_seq_result_lab_w	bigint;
ds_pasta_exp_xml_w	varchar(2000);
nr_seq_prescr_w		bigint;
nr_prescr_w		bigint;
nr_seq_result_w		bigint;
nr_seq_resultado_w	bigint;
nr_seq_result_imagem_w	bigint;
nr_seq_lab_resultado_w	bigint;
nr_prescricao_w		prescr_medica.nr_prescricao%type;
nm_repository_w varchar(50);
ie_exame_imagem_w varchar(1);

c01 CURSOR FOR
	SELECT	a.nr_sequencia,
      	  a.nr_seq_resultado,
          a.nr_seq_prescr
  from	exame_lab_result_item	a
  where	a.nr_seq_resultado	= nr_seq_lab_resultado_w
  and (nr_seq_material IS NOT NULL AND nr_seq_material::text <> '');


BEGIN

begin

SELECT MAX(NM_PATH),
       MAX(NM_REPOSITORY)
INTO STRICT ds_pasta_exp_xml_w,
     nm_repository_w
FROM FILE_REPOSITORY
WHERE NM_REPOSITORY = 'SWISSLAB';

select 	max(nr_prescricao)
into STRICT	nr_prescricao_w
from	prescr_medica
where	nr_controle_int_lab	= (nr_prescricao_p)::numeric
and	nr_atendimento		= (nr_atendimento_p)::numeric 
and	coalesce(dt_suspensao::text, '') = '';

select	max(a.NR_SEQ_RESULTADO)
into STRICT	nr_seq_lab_resultado_w
from	exame_lab_resultado	a
where	a.nr_atendimento	= (nr_atendimento_p)::numeric
and	a.nr_prescricao		= nr_prescricao_w;


open c01;
		loop
		fetch c01 into
			nr_seq_result_w,
			nr_seq_resultado_w,
			nr_seq_prescr_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
				begin

    select coalesce(max('S'),'N')
    into STRICT   	ie_exame_imagem_w
    from   	exame_lab_result_imagem
    where  	nr_seq_resultado = nr_seq_resultado_w;

    if (ie_exame_imagem_w = 'N') then

		insert into exame_lab_result_imagem(ds_imagem,
					dt_atualizacao,
					dt_atualizacao_nrec,
					nm_usuario,
					nm_usuario_nrec,
					nr_seq_prescr,
					nr_seq_result,
					nr_seq_resultado,
					nr_sequencia)
		values ('tasy-file://'||nm_repository_w||'/'||ds_arquivo_imagem_p,
					clock_timestamp(),
					clock_timestamp(),
					nm_usuario_p,
					nm_usuario_p,
					nr_seq_prescr_w,
					nr_seq_result_w,
					nr_seq_resultado_w,
					nextval('exame_lab_result_imagem_seq'));
    end if;
			end;
		end loop;
close c01;

commit;

ds_path_p	:= ds_pasta_exp_xml_w||ds_arquivo_imagem_p;

exception

when others then

	CALL gravar_log_cdi(7000,
			dbms_utility.format_error_backtrace || ' / ' || ds_pasta_exp_xml_w||ds_arquivo_imagem_p||' / '||nm_usuario_p||' / '||nr_seq_prescr_w || ' / '
      || nr_seq_resultado_w || ' / ' || nr_seq_result_imagem_w || ' / ' || nr_seq_lab_resultado_w || ' / ' || nr_atendimento_p || ' / ' || nr_prescricao_w,
			'GERMANY');
end;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE germany_attach_exam_image ( nr_atendimento_p text, nr_prescricao_p text, ds_arquivo_imagem_p text, cd_exame_p text, nr_seq_empresa_p bigint, nm_usuario_p text, ds_path_p INOUT text) FROM PUBLIC;

