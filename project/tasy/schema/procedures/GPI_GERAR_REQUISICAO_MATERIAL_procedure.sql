-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gpi_gerar_requisicao_material (nr_seq_orcamento_p gpi_orcamento.nr_sequencia%type, cd_operacao_estoque_p operacao_estoque.cd_operacao_estoque%type, cd_local_estoque_p local_estoque.cd_local_estoque%type, cd_centro_custo_p centro_custo.cd_centro_custo%type, ds_item_orc_p text, nr_requisicao_p INOUT requisicao_material.nr_requisicao%type, nm_usuario_p text) AS $body$
DECLARE


gpi_orc_itens_w             dbms_sql.number_table;
gpi_orc_item_w              gpi_orc_item%rowtype;
item_requisicao_material_w  item_requisicao_material%rowtype;
qt_conv_estoque_consumo_w   material.qt_conv_estoque_consumo%type;
cd_estabelecimento_w        estabelecimento.cd_estabelecimento%type;
nr_seq_proj_gpi_w           gpi_projeto.nr_sequencia%type;
nr_requisicao_w             requisicao_material.nr_requisicao%type;
ds_erro_w                   varchar(2000);
qt_itens_w                  bigint := 0;

BEGIN

begin
select  a.nr_sequencia,
        a.cd_estabelecimento
into STRICT    nr_seq_proj_gpi_w,
        cd_estabelecimento_w
from    gpi_projeto a,
        gpi_orcamento b
where   a.nr_sequencia = b.nr_seq_projeto
and     b.nr_sequencia = nr_seq_orcamento_p;
exception
    when others then
        cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
end;

gpi_orc_itens_w := string_to_table_number(ds_item_orc_p,',');

if (gpi_orc_itens_w.count > 0) then

    select  nextval('requisicao_seq')
    into STRICT    nr_requisicao_w
;

    insert into requisicao_material(
        nr_requisicao,
        cd_estabelecimento,
        cd_local_estoque,
        dt_solicitacao_requisicao,
        dt_atualizacao,
        nm_usuario,
        cd_operacao_estoque,
        cd_pessoa_requisitante,
        ie_urgente,
        ie_geracao,
        cd_centro_custo,
        nr_seq_proj_gpi
    ) values (
        nr_requisicao_w,
        cd_estabelecimento_w,
        cd_local_estoque_p,
        clock_timestamp(),
        clock_timestamp(),
        nm_usuario_p,
        cd_operacao_estoque_p,
        substr(obter_pessoa_fisica_usuario(nm_usuario_p,'C'),1,10),
        'N',
        'I',
        cd_centro_custo_p,
        nr_seq_proj_gpi_w
    );

    for i in 1..gpi_orc_itens_w.count loop

        begin
        select  *
        into STRICT    gpi_orc_item_w
        from    gpi_orc_item a
        where   a.nr_sequencia = gpi_orc_itens_w(i)
        and     a.nr_seq_orcamento = nr_seq_orcamento_p
        and     (a.cd_material IS NOT NULL AND a.cd_material::text <> '')
        and     a.qt_item > 0;
        exception
            when others then
                gpi_orc_item_w := null;
        end;

        if (gpi_orc_item_w.nr_sequencia IS NOT NULL AND gpi_orc_item_w.nr_sequencia::text <> '') then
            begin

            qt_itens_w := qt_itens_w + 1;

            select  coalesce(max(nr_sequencia),0) +1
            into STRICT    item_requisicao_material_w.nr_sequencia
            from    item_requisicao_material
            where   nr_requisicao = nr_requisicao_w;

            select  qt_conv_estoque_consumo,
                    substr(obter_dados_material_estab(cd_material,cd_estabelecimento_w,'UME'),1,30) cd_unidade_medida_estoque,
                    substr(obter_dados_material_estab(cd_material,cd_estabelecimento_w,'UMS'),1,30) cd_unidade_medida_consumo
            into STRICT    qt_conv_estoque_consumo_w,
                    item_requisicao_material_w.cd_unidade_medida_estoque,
                    item_requisicao_material_w.cd_unidade_medida
            from    material
            where   cd_material = gpi_orc_item_w.cd_material;

            item_requisicao_material_w.qt_estoque := dividir(gpi_orc_item_w.qt_item,qt_conv_estoque_consumo_w);

            insert into item_requisicao_material(
                nr_requisicao,
                nr_sequencia,
                cd_estabelecimento,
                cd_material,
                qt_material_requisitada,
                qt_material_atendida,
                vl_material,
                dt_atualizacao,
                nm_usuario,
                cd_unidade_medida,
                ie_acao,
                cd_motivo_baixa,
                qt_estoque,
                cd_unidade_medida_estoque,
                ie_geracao,
                nr_seq_orc_item_gpi,
                nr_seq_etapa_gpi
                )
            values (
                nr_requisicao_w,
                item_requisicao_material_w.nr_sequencia,
                cd_estabelecimento_w,
                gpi_orc_item_w.cd_material,
                gpi_orc_item_w.qt_item,
                0,
                0,
                clock_timestamp(),
                nm_usuario_p,
                item_requisicao_material_w.cd_unidade_medida,
                'I',
                0,
                item_requisicao_material_w.qt_estoque,
                item_requisicao_material_w.cd_unidade_medida_estoque,
                'I',
                gpi_orc_item_w.nr_sequencia,
                gpi_orc_item_w.nr_seq_etapa
            );
            end;
        end if;

    end loop;

    if (qt_itens_w > 0) then
        nr_requisicao_p := nr_requisicao_w;
        commit;
    else
        nr_requisicao_p := 0;
        -- Nao foi possivel gerar a requisicao. Verificar a quantidade de materiais dos itens selecionados
        CALL wheb_mensagem_pck.exibir_mensagem_abort(1115856);
    end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gpi_gerar_requisicao_material (nr_seq_orcamento_p gpi_orcamento.nr_sequencia%type, cd_operacao_estoque_p operacao_estoque.cd_operacao_estoque%type, cd_local_estoque_p local_estoque.cd_local_estoque%type, cd_centro_custo_p centro_custo.cd_centro_custo%type, ds_item_orc_p text, nr_requisicao_p INOUT requisicao_material.nr_requisicao%type, nm_usuario_p text) FROM PUBLIC;

