-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reservar_leito_unidade_atend ( ie_consiste_idade_p text, cd_paciente_reserva_p text, nr_seq_interno_p bigint, cd_convenio_reserva_p text, nr_seq_motivo_reserva_p text, ie_tipo_reserva_p text, ie_status_unidade_p text, ds_observacao_p text, cd_unidade_basica_p text, cd_unidade_compl_p text, cd_setor_atendimento_p bigint, ie_necessita_isol_reserva_p text, ds_retorno_p INOUT text, ds_consistencia_p INOUT text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

		
ds_retorno_w		varchar(255);
ds_consistencia_w	varchar(255);

ie_consiste_sexo_unid_w varchar(1) := '';


BEGIN

ie_consiste_sexo_unid_w := obter_param_usuario(44, 188, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_consiste_sexo_unid_w);

if (cd_paciente_reserva_p IS NOT NULL AND cd_paciente_reserva_p::text <> '') and (nr_seq_interno_p IS NOT NULL AND nr_seq_interno_p::text <> '') and (cd_convenio_reserva_p IS NOT NULL AND cd_convenio_reserva_p::text <> '') and (nr_seq_motivo_reserva_p IS NOT NULL AND nr_seq_motivo_reserva_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') and (ie_tipo_reserva_p IS NOT NULL AND ie_tipo_reserva_p::text <> '') and (ie_status_unidade_p IS NOT NULL AND ie_status_unidade_p::text <> '') and (cd_unidade_basica_p IS NOT NULL AND cd_unidade_basica_p::text <> '') and (cd_unidade_compl_p IS NOT NULL AND cd_unidade_compl_p::text <> '') and (cd_setor_atendimento_p IS NOT NULL AND cd_setor_atendimento_p::text <> '') and (ie_necessita_isol_reserva_p IS NOT NULL AND ie_necessita_isol_reserva_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin
	if (ie_consiste_idade_p = 'S') or (ie_consiste_idade_p = 'A') then
		begin	
		ds_retorno_w := consistir_idade_unidade(cd_paciente_reserva_p, nr_seq_interno_p, ds_retorno_w);
	
		if (ie_consiste_idade_p = 'S') and (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
			begin		
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(264607, 'DS_RETORNO_W=' || ds_retorno_w);
			end;
		end if;
		end;
	end if;
	
	if (ie_consiste_sexo_unid_w <> 'N') then
		begin
		
		ds_consistencia_w := consistir_sexo_unid_reserva(nr_seq_interno_p, cd_paciente_reserva_p, ds_consistencia_w);
		
		if (ie_consiste_sexo_unid_w = 'S') and (ds_consistencia_w IS NOT NULL AND ds_consistencia_w::text <> '') and (obter_se_quarto_familiar(cd_setor_atendimento_p,cd_unidade_basica_p,cd_unidade_compl_p,cd_paciente_reserva_p) = 'N')then
			begin
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(279278, 'DS_CONSISTENCIA_P=' || ds_consistencia_w);		
			end;
		end if;
		
		end;
	end if;
	
	
	if (ie_consiste_sexo_unid_w <> 'J') then
		begin
		update	unidade_atendimento
		set	cd_convenio_reserva 		= cd_convenio_reserva_p,
			nr_seq_motivo_reserva 		= nr_seq_motivo_reserva_p,
			cd_paciente_reserva		= cd_paciente_reserva_p,
			nr_seq_interno			= nr_seq_interno_p,
			nm_usuario_reserva		= nm_usuario_p,
			ie_tipo_reserva			= ie_tipo_reserva_p,
			ie_status_unidade		= ie_status_unidade_p,
			ds_observacao			= ds_observacao_p || wheb_mensagem_pck.get_texto(279279, 'NM_USUARIO_P=' || nm_usuario_p || ';DATA_P=' || to_char(clock_timestamp(),'dd/MM/yyyy hh24:mi:ss')),
			ie_necessita_isol_reserva	= ie_necessita_isol_reserva_p,
			dt_atualizacao			= clock_timestamp(),
			nm_usuario			= nm_usuario_p
		where	cd_unidade_basica		= cd_unidade_basica_p
		and	cd_unidade_compl		= cd_unidade_compl_p
		and	cd_setor_atendimento		= cd_setor_atendimento_p;
			end;
	end if;

	
	end;
end if;
ds_retorno_p		:= ds_retorno_w;
ds_consistencia_p	:= ds_consistencia_w;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reservar_leito_unidade_atend ( ie_consiste_idade_p text, cd_paciente_reserva_p text, nr_seq_interno_p bigint, cd_convenio_reserva_p text, nr_seq_motivo_reserva_p text, ie_tipo_reserva_p text, ie_status_unidade_p text, ds_observacao_p text, cd_unidade_basica_p text, cd_unidade_compl_p text, cd_setor_atendimento_p bigint, ie_necessita_isol_reserva_p text, ds_retorno_p INOUT text, ds_consistencia_p INOUT text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

