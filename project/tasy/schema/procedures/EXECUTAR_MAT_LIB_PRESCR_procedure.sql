-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE executar_mat_lib_prescr ( nr_prescricao_p bigint, nr_seq_proced_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_grupo_material_w		bigint;
cd_subgrupo_material_w		bigint;
cd_classe_material_w		bigint;
cd_material_w			bigint;
cd_setor_atendimento_w		bigint;
cd_estabelecimento_w		smallint;
ie_liberar_w			bigint;
nr_seq_mat_atend_w		bigint;
nr_seq_atepacu_w			bigint;
nr_atendimento_w			bigint;
cd_unidade_medida_w		varchar(30);
qt_material_w			double precision;
dt_prescricao_w			timestamp;
cd_local_estoque_w		smallint;
nr_sequencia_w			integer;
dt_entrada_unidade_w		timestamp;
cd_convenio_w			integer;
cd_categoria_w			varchar(10);
nr_doc_convenio_w		varchar(20);
ie_tipo_guia_w			varchar(2);
nr_seq_motivo_baixa_w		bigint;
nr_seq_motivo_baixa_ww		bigint;
cd_tipo_baixa_w			bigint;
dt_lib_w			timestamp;
ie_atualiza_estoque_w		varchar(1);
ie_conta_paciente_w		varchar(1);
cd_senha_w			varchar(20);
nr_seq_proc_w			integer;
cd_unidade_medida_dose_w		varchar(30);
ie_acm_w			varchar(1);
ie_sn_w				varchar(1);
cd_kit_material_w			integer;
nr_sequencia_solucao_w		integer;
nr_seq_kit_w			integer;
ie_considera_setor_proc_w	varchar(1);
ie_cobrar_diluicao_w		varchar(1);
cd_perfil_w			integer;
ie_agrupador_w			integer;
ie_prescr_emergencia_w		varchar(1);
dt_item_w			timestamp;
ie_data_prescricao_w		varchar(1);

C01 CURSOR FOR
SELECT	a.nr_atendimento,
	b.cd_material,
	b.cd_unidade_medida,
	b.qt_total_dispensar,
	a.dt_prescricao,
	b.nr_sequencia,
	c.cd_local_estoque,
	a.cd_setor_atendimento,
	coalesce(a.CD_ESTABELECIMENTO,1),
	obter_convenio_atendimento(a.nr_atendimento),
	b.nr_sequencia_proc,
	coalesce(b.cd_unidade_medida_dose,'0'),
	b.ie_acm,
	b.ie_se_necessario,
	b.cd_kit_material,
	b.nr_sequencia_solucao,
	b.nr_seq_kit,
	b.ie_agrupador,
	coalesce(a.ie_prescr_emergencia,'N'),
	b.dt_liberacao
from	setor_atendimento c,
	prescr_material b,
	prescr_medica a
where	a.nr_prescricao		= b.nr_prescricao
and	a.cd_setor_atendimento	= c.cd_setor_atendimento
and	a.nr_prescricao 	= nr_prescricao_p
and	b.nr_sequencia_proc	= nr_seq_proced_p
and	b.cd_motivo_baixa	= 0;


c03 CURSOR FOR
SELECT	dt_entrada_unidade,
	nr_seq_interno
from 	atend_paciente_unidade
where 	nr_atendimento		= nr_atendimento_w
and	cd_setor_atendimento	= cd_setor_atendimento_w
order by dt_entrada_unidade;


BEGIN
ie_considera_setor_proc_w := Obter_Param_Usuario(924, 624, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_considera_setor_proc_w);
nr_seq_motivo_baixa_ww := Obter_Param_Usuario(924, 838, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, nr_seq_motivo_baixa_ww);
ie_data_prescricao_w:=  coalesce(Obter_valor_param_usuario(924, 759, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento),'N');

OPEN	C01;
LOOP
FETCH	C01 into
	nr_atendimento_w,
	cd_material_w,
	cd_unidade_medida_w,
	qt_material_w,
	dt_prescricao_w,
	nr_sequencia_w,
	cd_local_estoque_w,
	cd_setor_atendimento_w,
	cd_estabelecimento_w,
	cd_convenio_w,
	nr_seq_proc_w,
	cd_unidade_medida_dose_w,
	ie_acm_w,
	ie_sn_w,
	cd_kit_material_w,
	nr_sequencia_solucao_w,
	nr_seq_kit_w,
	ie_agrupador_w,
	ie_prescr_emergencia_w,
	dt_lib_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (nr_seq_kit_w IS NOT NULL AND nr_seq_kit_w::text <> '') then
		select	nr_sequencia_solucao,
			coalesce(ie_acm, 'N'),
			coalesce(ie_se_necessario, 'N')
		into STRICT	nr_sequencia_solucao_w,
			ie_acm_w,
			ie_sn_w
		from	prescr_material
		where	nr_sequencia	= nr_seq_kit_w
		and	nr_prescricao	= nr_prescricao_p;
	end if;

	if (nr_sequencia_solucao_w IS NOT NULL AND nr_sequencia_solucao_w::text <> '') then
		select 	coalesce(ie_acm, 'N'),
			coalesce(ie_se_necessario, 'N')
		into STRICT 	ie_acm_w,
			ie_sn_w
		from	prescr_solucao
		where	nr_seq_solucao 	= nr_sequencia_solucao_w
		and	nr_prescricao	=	nr_prescricao_p;
	end if;

	select	cd_grupo_material,
		cd_subgrupo_material,
		cd_classe_material
	into STRICT	cd_grupo_material_W,
		cd_subgrupo_material_W,
		cd_classe_material_W
	from	estrutura_MATERIAL_v
	where	cd_material	= cd_material_w;

	if (nr_seq_proc_w IS NOT NULL AND nr_seq_proc_w::text <> '') and (ie_considera_setor_proc_w = 'S') then
		Select	coalesce(max(cd_setor_atendimento), cd_setor_atendimento_w)
		into STRICT	cd_setor_atendimento_w
		from	prescr_procedimento
		where	nr_prescricao = nr_prescricao_p
		and	nr_sequencia = nr_seq_proc_w;
	end if;

	select	obter_perfil_ativo
	into STRICT	cd_perfil_w
	;

	if (ie_cobrar_diluicao_w = 'N') and (ie_agrupador_w in (3,7,9)) then
		nr_seq_motivo_baixa_w	:= 0;
	else
		nr_seq_motivo_baixa_w	:= nr_seq_motivo_baixa_ww;
	end if;

	if (nr_seq_motivo_baixa_w > 0) then
		begin

		select	nextval('material_atend_paciente_seq')
		into STRICT	nr_seq_mat_atend_w
		;

		open C03;
		loop
		fetch C03 into
			dt_entrada_unidade_w,
			nr_seq_atepacu_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			dt_entrada_unidade_w	:= dt_entrada_unidade_w;
			nr_seq_atepacu_w	:= nr_seq_atepacu_w;
			end;
		end loop;
		close C03;

		if (coalesce(nr_seq_atepacu_w,0) = 0) then
			begin
			select	Obter_Atepacu_paciente(nr_atendimento_w,'IAA')
			into STRICT	nr_seq_atepacu_w
			;

			select	dt_entrada_unidade
			into STRICT	dt_entrada_unidade_w
			from 	atend_paciente_unidade
			where 	nr_seq_interno = nr_seq_atepacu_w;
			end;
		end if;

		SELECT * FROM obter_convenio_execucao(nr_atendimento_w, clock_timestamp(), cd_convenio_w, cd_categoria_w, nr_doc_convenio_w, ie_tipo_guia_w, cd_senha_w) INTO STRICT cd_convenio_w, cd_categoria_w, nr_doc_convenio_w, ie_tipo_guia_w, cd_senha_w;

		select	cd_tipo_baixa,
			ie_atualiza_estoque,
			ie_conta_paciente
		into STRICT	cd_tipo_baixa_w,
			ie_atualiza_estoque_w,
			ie_conta_paciente_w
		from	tipo_baixa_prescricao
		where	nr_sequencia	= nr_seq_motivo_baixa_w;

		if (ie_atualiza_estoque_w = 'N') then
			cd_local_estoque_w	:= null;
		end if;

		if (ie_conta_paciente_w	= 'S') then

			dt_item_w := coalesce(dt_lib_w,clock_timestamp());
			if (ie_prescr_emergencia_w = 'S') and (ie_data_prescricao_w = 'S') then
				dt_item_w:= dt_prescricao_w;
			elsif (ie_data_prescricao_w = 'P') then
				dt_item_w:= dt_prescricao_w;
			end if;

			insert	into material_atend_paciente(nr_sequencia,
				nr_atendimento,
				dt_entrada_unidade,
				cd_material,
				dt_atendimento,
				dt_conta,
				cd_unidade_medida,
				qt_material,
				dt_atualizacao,
				nm_usuario,
				cd_convenio,
				cd_categoria,
				nr_doc_convenio,
				ie_tipo_guia,
				dt_prescricao,
				cd_material_prescricao,
				cd_material_exec,
				nr_prescricao,
				nr_sequencia_prescricao,
				cd_acao,
				cd_setor_atendimento,
				qt_executada,
				vl_unitario,
				qt_ajuste_conta,
				ie_valor_informado,
				ie_guia_informada,
				ie_auditoria,
				nm_usuario_original,
				cd_situacao_glosa,
				nr_seq_atepacu,
				nr_seq_cor_exec,
				cd_local_estoque,
				NR_SEQ_TIPO_BAIXA,
				cd_senha)
			values (nr_seq_mat_atend_w,
				nr_atendimento_w,
				dt_entrada_unidade_w,
				cd_material_w,
				dt_item_w,
				dt_item_w,
				cd_unidade_medida_w,
				qt_material_w,
				clock_timestamp(),
				nm_usuario_p,
				cd_convenio_w,
				cd_categoria_w,
				nr_doc_convenio_w,
				ie_tipo_guia_w,
				dt_prescricao_w,
				cd_material_w,
				cd_material_w,
				nr_prescricao_p,
				nr_sequencia_w,
				'1',
				cd_setor_atendimento_w,
				qt_material_w,
				0,
				0,
				'N',
				'N',
				'N',
				nm_usuario_p,
				0,
				nr_seq_atepacu_w,
				231,
				cd_local_estoque_w,
				nr_seq_motivo_baixa_w,
				cd_senha_w);

			CALL Atualiza_Preco_Material(nr_seq_mat_atend_w,nm_usuario_p);

			update	material_atend_paciente
			set 	cd_kit_material = cd_kit_material_w
			where 	nr_sequencia = nr_seq_mat_atend_w;

		elsif (ie_atualiza_estoque_w = 'S') then

			CALL Gerar_Prescricao_estoque(
				cd_estabelecimento_w,
				nr_atendimento_w,
				dt_prescricao_w,
				cd_material_w,
				dt_prescricao_w,
				1,
				cd_local_estoque_w,
				qt_material_w,
				cd_setor_atendimento_w,
				cd_unidade_medida_w,
				nm_usuario_p, 'I',
				nr_prescricao_p,
       		           	nr_sequencia_w,
				null,
				nr_sequencia_w,
				null,
				null,
				null,
				null,
				null,
				null, '','','');

		end if;


		update	prescr_material
		set	dt_baixa	= clock_timestamp(),
			nm_usuario	= nm_usuario_p,
			cd_motivo_baixa	= cd_tipo_baixa_w
		where	nr_prescricao	= nr_prescricao_p
		and	nr_sequencia	= nr_sequencia_w
		and	cd_material	= cd_material_w;

		end;
	end if;

end;
END LOOP;
CLOSE C01;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE executar_mat_lib_prescr ( nr_prescricao_p bigint, nr_seq_proced_p bigint, nm_usuario_p text) FROM PUBLIC;

