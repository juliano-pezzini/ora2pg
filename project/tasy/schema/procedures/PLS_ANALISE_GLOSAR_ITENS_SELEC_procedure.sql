-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_analise_glosar_itens_selec ( nr_seq_analise_p bigint, nr_seq_mot_liberacao_p bigint, ds_parecer_p text, nr_seq_grupo_atual_p bigint, cd_estabelecimento_p bigint, ie_obriga_parecer_p text, ie_obriga_ocorrencia_p text, nm_usuario_p text, ie_glosa_pos_estab_p text, ie_obriga_ocor_parcial_p text default 'S', nr_id_transacao_p bigint DEFAULT NULL) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  ]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ie_status_analise_w		varchar(5);
ie_tipo_linha_w			varchar(3);
qt_liberar_w			double precision;
nr_sequencia_w			bigint;
nr_seq_conta_w			bigint;
nr_seq_conta_proc_w		bigint;
nr_seq_conta_mat_w		bigint;
nr_seq_proc_partic_w		bigint;
nr_seq_ocor_benef_w		bigint;
nr_seq_conta_glosa_w		bigint;
nr_seq_conta_pos_estab_w	bigint;
ie_tipo_guia_w			pls_conta.ie_tipo_guia%type;
ie_expandido_w			w_pls_analise_item.ie_expandido%type;
ie_obriga_ocor_parcial_w	varchar(1);
ie_origem_analise_w		pls_analise_conta.ie_origem_analise%type;
nr_seq_conta_pos_proc_w		w_pls_analise_item.nr_seq_conta_pos_proc%type;
nr_seq_conta_pos_mat_w		w_pls_analise_item.nr_seq_conta_pos_mat%type;
ie_novo_pos_estab_w		pls_visible_false.ie_novo_pos_estab%type;
nr_id_transacao_w		w_pls_analise_item.nr_id_transacao%type;

ie_origem_conta_w		pls_conta.ie_origem_conta%type;
ie_a520_w			w_pls_analise_item.ie_a520%type;
vl_apresentado_w		w_pls_analise_item.vl_apresentado%type;
ie_processa_w			varchar(1);

/* Itens selecionados */

C01 CURSOR FOR
	SELECT	a.nr_seq_w_item,
		a.qt_liberar
	from	w_pls_analise_selecao_item a
	where	a.nr_seq_analise	= nr_seq_analise_p
	and	a.nm_usuario		= nm_usuario_p
	order by coalesce(a.qt_liberar,0), a.nr_seq_w_item;

C02 CURSOR(nr_seq_analise_pc	pls_analise_conta.nr_sequencia%type,
		 ie_tipo_guia_pc	pls_analise_conta.ie_tipo_guia%type)FOR
	SELECT	nr_sequencia nr_seq_conta
	from	pls_conta
	where	nr_seq_analise 	= nr_seq_analise_pc
	and	ie_tipo_guia	= ie_tipo_guia_pc;
BEGIN


if (coalesce(nr_id_transacao_p::text, '') = '') then
	select 	max(nr_id_transacao)
	into STRICT	nr_id_transacao_w
	from	w_pls_analise_item
	where	nr_seq_analise = nr_seq_analise_p;
else
	nr_id_transacao_w := nr_id_transacao_p;
end if;

ie_obriga_ocor_parcial_w	:= coalesce(ie_obriga_ocor_parcial_p, 'S');

select	coalesce(max(ie_novo_pos_estab),'N')
into STRICT	ie_novo_pos_estab_w
from	pls_visible_false;

select 	max(ie_origem_analise)
into STRICT	ie_origem_analise_w
from	pls_analise_conta
where	nr_sequencia 	= nr_seq_analise_p;

open C01;
loop
fetch C01 into	
	nr_sequencia_w,
	qt_liberar_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	begin
		select	a.nr_seq_conta,
			a.nr_seq_conta_proc,
			a.nr_seq_conta_mat,
			a.nr_seq_proc_partic,
			a.ie_status_analise,
			a.ie_tipo_linha,
			a.nr_seq_conta_pos_estab,
			a.nr_seq_conta_pos_proc,
			a.nr_seq_conta_pos_mat,
			a.ie_tipo_guia,
			a.ie_expandido,
			(	select	max(x.ie_origem_conta)
				from	pls_conta	x
				where	x.nr_sequencia	= a.nr_seq_conta) ie_origem_conta,
			a.ie_a520,
			a.vl_apresentado
		into STRICT	nr_seq_conta_w,
			nr_seq_conta_proc_w,
			nr_seq_conta_mat_w,
			nr_seq_proc_partic_w,
			ie_status_analise_w,
			ie_tipo_linha_w,
			nr_seq_conta_pos_estab_w,
			nr_seq_conta_pos_proc_w,	
			nr_seq_conta_pos_mat_w,	
			ie_tipo_guia_w,
			ie_expandido_w,
			ie_origem_conta_w,
			ie_a520_w,
			vl_apresentado_w
		from	w_pls_analise_item a
		where	a.nr_sequencia	= nr_sequencia_w
		and	nr_id_transacao = nr_id_transacao_w;
	exception
		when others then
		nr_seq_conta_w		:= null;
		nr_seq_conta_proc_w	:= null;
		nr_seq_conta_mat_w	:= null;
		nr_seq_proc_partic_w	:= null;
		ie_a520_w		:= null;		
	end;

	ie_processa_w := 'S';
	
	-- verifica se o item não é completamente glosado no A500
	if (pls_obter_se_a504_glosado(ie_a520_w, ie_origem_conta_w, vl_apresentado_w) = 'S') then
	
		ie_processa_w := 'N';
	end if;
	
	-- se estiver marcado para processar
	if (ie_processa_w = 'S') then
	
		/* Não considerar títulos e linhas informativas ou canceladas */

		if (coalesce(ie_tipo_linha_w,'X') <> 'T') and (coalesce(ie_status_analise_w,'X') not in ('I', 'C')) then
			if (nr_seq_conta_w IS NOT NULL AND nr_seq_conta_w::text <> '') or (nr_seq_conta_proc_w IS NOT NULL AND nr_seq_conta_proc_w::text <> '') or (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') or (nr_seq_proc_partic_w IS NOT NULL AND nr_seq_proc_partic_w::text <> '') then
				
				if (ie_origem_analise_w in ('7','8','2')) then
							
					--Chamada da rotina Para nova geração de pós-estabelecido.
					if (ie_novo_pos_estab_w = 'S') then
					
						nr_seq_conta_pos_estab_w := coalesce(nr_seq_conta_pos_proc_w, nr_seq_conta_pos_mat_w);
						
						CALL pls_analise_glosa_it_novo_pos(	nr_seq_analise_p,
										nr_seq_conta_w,
										nr_seq_conta_proc_w,
										nr_seq_conta_mat_w,
										nr_seq_conta_pos_estab_w,
										qt_liberar_w,
										nr_seq_mot_liberacao_p,
										ds_parecer_p,
										cd_estabelecimento_p,
										nr_seq_grupo_atual_p,
										ie_obriga_parecer_p,
										ie_obriga_ocorrencia_p,
										nm_usuario_p,
										'S');
					else
					
						CALL pls_analise_glosar_item_pos(nr_seq_analise_p,
								nr_seq_conta_w,
								nr_seq_conta_proc_w,
								nr_seq_conta_mat_w,
								nr_seq_conta_pos_estab_w,
								qt_liberar_w,
								nr_seq_mot_liberacao_p,
								ds_parecer_p,
								cd_estabelecimento_p,
								nr_seq_grupo_atual_p,
								ie_obriga_parecer_p,
								ie_obriga_ocorrencia_p,
								nm_usuario_p,
								'S');
					
					end if;
				else
					CALL pls_gerar_w_analise_glosa_ocor(nr_seq_analise_p,
								nr_seq_conta_w,
								nr_seq_grupo_atual_p,
								nr_seq_conta_proc_w,
								nr_seq_conta_mat_w,
								nr_seq_proc_partic_w,
								'S',
								nm_usuario_p);
								
					CALL pls_analise_glosar_item(nr_seq_analise_p,
								nr_seq_conta_w,
								nr_seq_conta_proc_w,
								nr_seq_conta_mat_w,
								nr_seq_proc_partic_w,
								qt_liberar_w,
								nr_seq_mot_liberacao_p,
								ds_parecer_p,
								cd_estabelecimento_p,
								nr_seq_grupo_atual_p,
								ie_obriga_parecer_p,
								ie_obriga_ocorrencia_p,
								'N',
								'N',
								nm_usuario_p,
								ie_glosa_pos_estab_p,
								ie_obriga_ocor_parcial_w);
				end if;
			elsif (ie_tipo_linha_w	= 'C') and (ie_expandido_w		= 'N') and (ie_origem_analise_w	!= '2')then
				for r_c02_w in C02(nr_seq_analise_p, ie_tipo_guia_w) loop
					begin
					CALL pls_gerar_w_analise_glosa_ocor(	nr_seq_analise_p,
									r_c02_w.nr_seq_conta,
									nr_seq_grupo_atual_p,
									null,
									null,
									null,
									'S',
									nm_usuario_p);
								
					CALL pls_analise_glosar_item(nr_seq_analise_p,
								r_c02_w.nr_seq_conta,
								null,
								null,
								null,
								null,
								nr_seq_mot_liberacao_p,
								ds_parecer_p,
								cd_estabelecimento_p,
								nr_seq_grupo_atual_p,
								ie_obriga_parecer_p,
								ie_obriga_ocorrencia_p,
								'N',
								'N',
								nm_usuario_p,
								ie_glosa_pos_estab_p,
								ie_obriga_ocor_parcial_w);
					end;
				end loop;
			end if;
		end if;
	end if; -- fim se processa = S
	
	CALL pls_gerar_w_analise_selec_item(nr_seq_analise_p, nr_sequencia_w, null, 'D', nm_usuario_p, 'N', nr_id_transacao_w);
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_analise_glosar_itens_selec ( nr_seq_analise_p bigint, nr_seq_mot_liberacao_p bigint, ds_parecer_p text, nr_seq_grupo_atual_p bigint, cd_estabelecimento_p bigint, ie_obriga_parecer_p text, ie_obriga_ocorrencia_p text, nm_usuario_p text, ie_glosa_pos_estab_p text, ie_obriga_ocor_parcial_p text default 'S', nr_id_transacao_p bigint DEFAULT NULL) FROM PUBLIC;

