-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_nut_elemento_pac_he ( NR_SEQUENCIA_P bigint, NM_USUARIO_P text) AS $body$
DECLARE


qt_peso_w		double precision;
qt_be_w			double precision;
nr_sequencia_w		bigint;
nr_seq_elemento_w		bigint;
qt_elem_kg_dia_w		double precision;
qt_diaria_w		double precision;
ie_tipo_elemento_w		varchar(3);
qt_conversao_ml_w		double precision;
qt_volume_w		double precision;
qt_vol_tot_w		double precision;
nr_seq_elem_mat_w	bigint;

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.qt_elem_kg_dia,
	b.ie_tipo_elemento
from	Nut_elemento b,
	Prescr_Rep_He_Elem a
where	nr_seq_rep_he	= nr_sequencia_p
and	a.nr_seq_elemento	= b.nr_sequencia;

c02 CURSOR FOR
SELECT	a.nr_sequencia,
	qt_conversao_ml
from	nut_elem_material b,
	Prescr_Rep_He_Elem_mat a
where	a.nr_seq_ele_Rep	= nr_sequencia_w
and	a.nr_seq_elem_mat	= b.nr_sequencia
and	coalesce(b.ie_tipo,'NPT')	= 'NPT';



BEGIN

Select	coalesce(max(qt_peso),0),
	coalesce(max(qt_be),0)
into STRICT	qt_peso_w,
	qt_be_w
from	Prescr_Rep_HE
where	nr_sequencia	= nr_sequencia_p;

open c01;
loop
	fetch c01	into
		nr_sequencia_w,
      		qt_elem_kg_dia_w,
		ie_tipo_elemento_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	qt_vol_tot_w		:= 0;
	if (ie_tipo_elemento_w = 'B') then
		qt_diaria_w		:= qt_elem_kg_dia_w * qt_BE_w;
	else
		qt_diaria_w		:= qt_elem_kg_dia_w * qt_peso_w;
	end if;
	open c02;
	loop
	fetch c02	into
		nr_seq_elem_mat_w,
      		qt_conversao_ml_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		qt_volume_w	:= qt_diaria_w * qt_conversao_ml_w;
		qt_vol_tot_w	:= qt_vol_tot_w + qt_volume_w;
		update	Prescr_Rep_He_Elem_mat
		set	qt_volume	= qt_volume_w,
			qt_vol_cor	= 0
		where	nr_sequencia	= nr_seq_elem_mat_w;
	end loop;
	close c02;
      	update	Prescr_Rep_He_Elem
	set	qt_diaria		= qt_diaria_w,
		qt_volume	= qt_vol_tot_w,
		qt_volume_corrigido	= 0
	where	nr_sequencia	= nr_sequencia_w;
end loop;
close c01;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_nut_elemento_pac_he ( NR_SEQUENCIA_P bigint, NM_USUARIO_P text) FROM PUBLIC;

