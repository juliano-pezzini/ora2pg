-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_tributos_posteriores ( nr_seq_tit_imposto_p bigint, nr_seq_nota_fiscal_p bigint, nr_seq_repasse_trib_p bigint, nr_seq_pag_prest_venc_trib_p bigint, cd_tributo_p tributo.cd_tributo%type, ds_lista_titulos_p INOUT text, ds_lista_repasses_p INOUT text, ds_lista_notas_p INOUT text, ds_lista_pag_prest_p INOUT text, ie_commit_p text default 'S') AS $body$
DECLARE


nr_titulo_w			bigint;
nr_seq_nota_fiscal_w		bigint;
nr_repasse_terceiro_w		bigint;
cd_tributo_w			smallint;
ds_lista_titulos_w		varchar(255) := ',';
ds_lista_repasses_w		varchar(255) := ',';
ds_lista_notas_w		varchar(255) := ',';
ds_lista_pag_prest_w		varchar(255) := ',';
cd_pessoa_fisica_w		varchar(10);
cd_cgc_w			varchar(14);
cd_cgc_emitente_w		varchar(14);
dt_vencimento_atual_w		timestamp := null;
cd_estabelecimento_w		smallint;
dt_criacao_w			timestamp;
dt_emissao_w			timestamp := null;
dt_vencimento_w			timestamp := null;
dt_mesano_referencia_w		timestamp := null;
dt_vencto_param_w		timestamp := null;
dt_trib_repasse_w		timestamp := null;
ie_acumulativo_w		varchar(100);
ds_irrelevante_w		varchar(255);
cd_cnpj_raiz_w			varchar(255);
ie_cnpj_w			varchar(255);
cd_cnpj_emitente_raiz_w		varchar(255);
cd_tipo_servico_w		varchar(100) := '';
vl_base_calculo_w		double precision;
nr_seq_classe_w			bigint;
cd_empresa_w			smallint;
nr_seq_pag_prest_w		pls_pagamento_prestador.nr_sequencia %type;
nr_seq_lote_pagamento_w		bigint;
ie_considera_item_w		varchar(1);
ie_apuracao_piso_w		tributo.ie_apuracao_piso%type;
qt_tributo_w			integer;

c01 CURSOR FOR
	SELECT	a.nr_titulo,
		a.nr_repasse_terceiro,
		a.nr_seq_nota_fiscal
	from	tributo d,
		valores_tributo_v a
	where	coalesce(a.cd_empresa,coalesce(cd_empresa_w,0)) = coalesce(cd_empresa_w,0)
	and	a.cd_tributo = d.cd_tributo
	and	a.cd_tributo = cd_tributo_w
	and	(((a.cd_cgc = cd_cgc_w) or
		(ie_cnpj_w = 'Empresa' AND a.cd_cnpj_raiz = cd_cnpj_raiz_w)) or (a.cd_pessoa_fisica = cd_pessoa_fisica_w))
	and	trunc(a.dt_tributo, 'month') = trunc(dt_vencimento_atual_w, 'month')
	and (a.ie_origem_valores = 'TP' or d.ie_apuracao_piso = 'S')
	and	((d.ie_restringe_estab = 'N') or (a.cd_estabelecimento = cd_estabelecimento_w) or (a.cd_estab_financeiro = cd_estabelecimento_w))
	and (d.ie_apuracao_piso = 'N' or
		d.ie_apuracao_piso = a.ie_base_calculo)
	and	a.dt_criacao > dt_criacao_w;

c02 CURSOR FOR
	SELECT	a.nr_titulo,
		a.nr_repasse_terceiro,
		a.nr_seq_nota_fiscal
	from	tributo d,
		valores_tributo_v a
	where	coalesce(a.cd_empresa,coalesce(cd_empresa_w,0)) = coalesce(cd_empresa_w,0)
	and	a.cd_tributo = d.cd_tributo
	and	a.cd_tributo = cd_tributo_w
	and	trunc(a.dt_tributo, 'month') = trunc(dt_emissao_w, 'month')
	and	(((a.cd_cgc_emitente = cd_cgc_emitente_w) or
		(ie_cnpj_w = 'Empresa' AND a.cd_cnpj_emitente_raiz = cd_cnpj_emitente_raiz_w)) or
		((coalesce(a.cd_cgc_emitente::text, '') = '') and (a.ie_origem_valores <> 'NFE')))
	and	(((cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and a.cd_pessoa_fisica = cd_pessoa_fisica_w) or
		((coalesce(cd_pessoa_fisica_w::text, '') = '') and (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') and (coalesce(a.cd_pessoa_fisica::text, '') = '') and
		((a.cd_cgc = cd_cgc_w) or
		(ie_cnpj_w = 'Empresa' AND a.cd_cnpj_raiz = cd_cnpj_raiz_w))))
	and (a.ie_origem_valores = 'NFE' or d.ie_apuracao_piso = 'S')
	and	((d.ie_restringe_estab = 'N') or (a.cd_estabelecimento = cd_estabelecimento_w) or (a.cd_estab_financeiro = cd_estabelecimento_w))
	and (d.ie_apuracao_piso = 'N' or
		d.ie_apuracao_piso = a.ie_base_calculo)
	and	a.dt_criacao > dt_criacao_w;

c03 CURSOR FOR
	SELECT	a.nr_titulo,
		a.nr_repasse_terceiro,
		a.nr_seq_nota_fiscal
	from	tributo f,
		valores_tributo_v a
	where (coalesce(ie_restringe_empresa,'N') = 'N' or coalesce(a.cd_empresa,coalesce(cd_empresa_w,0)) = coalesce(cd_empresa_w,0))
	and	a.cd_tributo			= f.cd_tributo
	and	a.cd_tributo			= cd_tributo_w
	and (a.ie_origem_valores		= 'RT'  or f.ie_apuracao_piso = 'S')
	and	coalesce(cd_pessoa_fisica, CASE WHEN ie_cnpj_w='Estab' THEN  cd_cgc  ELSE cd_cnpj_raiz END )	=
				coalesce(cd_pessoa_fisica_w, CASE WHEN ie_cnpj_w='Estab' THEN  cd_cgc_w  ELSE cd_cnpj_raiz_w END )
	and	trunc(dt_tributo, 'month')	= trunc(CASE WHEN f.ie_vencimento='V' THEN dt_vencimento_w WHEN f.ie_vencimento='C' THEN dt_vencto_param_w  ELSE dt_mesano_referencia_w END , 'month')
	and	((f.ie_restringe_estab		= 'N') or (a.cd_estabelecimento		= cd_estabelecimento_w) or (a.cd_estab_financeiro		= cd_estabelecimento_w))
	and (f.ie_apuracao_piso		= 'N' or
		f.ie_apuracao_piso		= a.ie_base_calculo)
	and	a.dt_criacao 			> dt_criacao_w;

c04 CURSOR FOR
	SELECT	x.nr_titulo,
		x.nr_repasse_terceiro,
		x.nr_seq_nota_fiscal,
		x.nr_seq_pag_prest,
		d.ie_restringe_estab,
		x.cd_estabelecimento,
		x.cd_estab_financeiro
	from 	valores_tributo_pag_v x,
		tributo d
	where	coalesce(x.cd_empresa,coalesce(cd_empresa_w,0)) = coalesce(cd_empresa_w,0)
	and	x.cd_tributo			= d.cd_tributo
	and	x.cd_tributo			= cd_tributo_w
	and	x.dt_tributo_mes		= trunc(dt_vencimento_atual_w, 'month')
	and	x.ie_origem_valores		= 'PP'
	and	d.ie_apuracao_piso 		= 'N'
	and	not exists (	SELECT	1
					from	pls_pagamento_prestador	y
					where	y.nr_sequencia = x.nr_seq_pag_prest
					and	y.nr_seq_lote = nr_seq_lote_pagamento_w)
	and	x.dt_criacao 			> dt_criacao_w
	and	x.cd_cgc = cd_cgc_w
	
union all

	select	x.nr_titulo,
		x.nr_repasse_terceiro,
		x.nr_seq_nota_fiscal,
		x.nr_seq_pag_prest,
		d.ie_restringe_estab,
		x.cd_estabelecimento,
		x.cd_estab_financeiro
	from 	valores_tributo_pag_v x,
		tributo d
	where	coalesce(x.cd_empresa,coalesce(cd_empresa_w,0)) = coalesce(cd_empresa_w,0)
	and	x.cd_tributo			= d.cd_tributo
	and	x.cd_tributo			= cd_tributo_w
	and	x.dt_tributo_mes		= trunc(dt_vencimento_atual_w, 'month')
	and	x.ie_origem_valores		= 'PP'
	and	d.ie_apuracao_piso 		= 'N'
	and	not exists (	select	1
					from	pls_pagamento_prestador	y
					where	y.nr_sequencia = x.nr_seq_pag_prest
					and	y.nr_seq_lote = nr_seq_lote_pagamento_w)
	and	x.dt_criacao 			> dt_criacao_w
	and	x.cd_pessoa_fisica = cd_pessoa_fisica_w
	
union all

	select	x.nr_titulo,
		x.nr_repasse_terceiro,
		x.nr_seq_nota_fiscal,
		x.nr_seq_pag_prest,
		d.ie_restringe_estab,
		x.cd_estabelecimento,
		x.cd_estab_financeiro
	from 	valores_tributo_pag_v x,
		tributo d
	where	coalesce(x.cd_empresa,coalesce(cd_empresa_w,0)) = coalesce(cd_empresa_w,0)
	and	x.cd_tributo = d.cd_tributo
	and	x.cd_tributo = cd_tributo_w
	and	x.dt_tributo_mes = trunc(dt_vencimento_atual_w, 'month')
	and	x.ie_origem_valores = 'PP'
	and	d.ie_apuracao_piso = 'N'
	and not exists (	select	1
			from	pls_pagamento_prestador	y
			where	y.nr_sequencia = x.nr_seq_pag_prest
			and	y.nr_seq_lote = nr_seq_lote_pagamento_w)
	and	x.dt_criacao > dt_criacao_w
	and	ie_cnpj_w = 'Empresa'
	and 	cd_cnpj_raiz = cd_cnpj_raiz_w;

c05 CURSOR FOR
	SELECT	a.nr_titulo,
		a.nr_repasse_terceiro,
		a.nr_seq_nota_fiscal,
		a.nr_seq_pag_prest,
		d.ie_restringe_estab,
		a.cd_estabelecimento,
		a.cd_estab_financeiro,
		a.cd_cgc,
		a.cd_cnpj_raiz,
		a.cd_pessoa_fisica
	from	tributo d,
		valores_tributo_v a
	where	coalesce(a.cd_empresa,coalesce(cd_empresa_w,0)) = coalesce(cd_empresa_w,0)
	and	a.cd_tributo			= d.cd_tributo
	and	a.cd_tributo			= cd_tributo_w
	and	a.cd_pessoa_fisica 		= cd_pessoa_fisica_w
	and	a.dt_tributo_mes		= trunc(dt_vencimento_atual_w, 'month')
	and	d.ie_apuracao_piso 		= 'S'
	and	d.ie_apuracao_piso		= a.ie_base_calculo
	and	not exists (	SELECT	1
				from	pls_pagamento_prestador	y
				where	y.nr_sequencia		= a.nr_seq_pag_prest
				and	y.nr_seq_lote		= nr_seq_lote_pagamento_w)
	and	a.dt_criacao > dt_criacao_w
	
union all

	select	a.nr_titulo,
		a.nr_repasse_terceiro,
		a.nr_seq_nota_fiscal,
		a.nr_seq_pag_prest,
		d.ie_restringe_estab,
		a.cd_estabelecimento,
		a.cd_estab_financeiro,
		a.cd_cgc,
		a.cd_cnpj_raiz,
		a.cd_pessoa_fisica
	from	tributo d,
		valores_tributo_v a
	where	coalesce(a.cd_empresa,coalesce(cd_empresa_w,0)) = coalesce(cd_empresa_w,0)
	and	a.cd_tributo			= d.cd_tributo
	and	a.cd_tributo			= cd_tributo_w
	and	a.cd_cgc 			= cd_cgc_w
	and	a.dt_tributo_mes		= trunc(dt_vencimento_atual_w, 'month')
	and	d.ie_apuracao_piso 		= 'S'
	and	d.ie_apuracao_piso		= a.ie_base_calculo
	and	not exists (	select	1
				from	pls_pagamento_prestador	y
				where	y.nr_sequencia		= a.nr_seq_pag_prest
				and	y.nr_seq_lote		= nr_seq_lote_pagamento_w)
	and	a.dt_criacao > dt_criacao_w
	
union all

	select	a.nr_titulo,
		a.nr_repasse_terceiro,
		a.nr_seq_nota_fiscal,
		a.nr_seq_pag_prest,
		d.ie_restringe_estab,
		a.cd_estabelecimento,
		a.cd_estab_financeiro,
		a.cd_cgc,
		a.cd_cnpj_raiz,
		a.cd_pessoa_fisica
	from	tributo d,
		valores_tributo_v a
	where	coalesce(a.cd_empresa,coalesce(cd_empresa_w,0)) = coalesce(cd_empresa_w,0)
	and	a.cd_tributo			= d.cd_tributo
	and	a.cd_tributo			= cd_tributo_w
	and	ie_cnpj_w 			= 'Empresa'
	and 	a.cd_cnpj_raiz 			= cd_cnpj_raiz_w
	and	a.dt_tributo_mes		= trunc(dt_vencimento_atual_w, 'month')
	and	d.ie_apuracao_piso 		= 'S'
	and	d.ie_apuracao_piso		= a.ie_base_calculo
	and	not exists (	select	1
				from	pls_pagamento_prestador	y
				where	y.nr_sequencia		= a.nr_seq_pag_prest
				and	y.nr_seq_lote		= nr_seq_lote_pagamento_w)
	and	a.dt_criacao > dt_criacao_w;
	

BEGIN

if (coalesce(nr_seq_tit_imposto_p,0) > 0) then

	select	a.cd_tributo,
		b.cd_pessoa_fisica,
		b.cd_cgc,
		b.dt_vencimento_atual,
		b.cd_estabelecimento,
		coalesce(a.dt_atualizacao_nrec,a.dt_atualizacao),
		obter_cnpj_raiz(b.cd_cgc),
		a.vl_base_calculo,
		b.nr_seq_classe,
		c.cd_empresa
	into STRICT	cd_tributo_w,
		cd_pessoa_fisica_w,
		cd_cgc_w,
		dt_vencimento_atual_w,
		cd_estabelecimento_w,
		dt_criacao_w,
		cd_cnpj_raiz_w,
		vl_base_calculo_w,
		nr_seq_classe_w,
		cd_empresa_w
	from	estabelecimento c,
		titulo_pagar b,
		titulo_pagar_imposto a
	where	b.cd_estabelecimento	= c.cd_estabelecimento
	and	a.nr_titulo		= b.nr_titulo
	and	a.nr_sequencia		= nr_seq_tit_imposto_p;

	select	ie_cnpj
	into STRICT	ie_cnpj_w
	from	tributo
	where	cd_tributo	= cd_tributo_w;

	open c01;
	loop
	fetch c01 into
		nr_titulo_w,
		nr_repasse_terceiro_w,
		nr_seq_nota_fiscal_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		if (coalesce(nr_titulo_w,0) > 0) then
			ds_lista_titulos_w	:= substr(ds_lista_titulos_w || nr_titulo_w || ',', 1, 255);
		elsif (coalesce(nr_repasse_terceiro_w,0) > 0) then
			ds_lista_repasses_w	:= substr(ds_lista_repasses_w || nr_repasse_terceiro_w || ',', 1, 255);
		elsif (coalesce(nr_seq_nota_fiscal_w,0) > 0) then
			ds_lista_notas_w	:= substr(ds_lista_notas_w || nr_seq_nota_fiscal_w || ',', 1, 255);
		end if;
	end loop;
	close c01;

elsif (coalesce(nr_seq_nota_fiscal_p,0) > 0) and (coalesce(cd_tributo_p,0) > 0) then

	select	max(a.cd_tributo),
		max(b.cd_pessoa_fisica),
		max(b.cd_cgc),
		max(b.cd_cgc_emitente),
		max(b.dt_emissao),
		max(b.cd_estabelecimento),
		max(coalesce(a.dt_atualizacao_nrec,a.dt_atualizacao)),
		max(obter_cnpj_raiz(b.cd_cgc)),
		max(obter_cnpj_raiz(b.cd_cgc_emitente)),
		max(b.cd_tipo_servico),
		max(a.vl_base_calculo),
		max(c.cd_empresa)
	into STRICT	cd_tributo_w,
		cd_pessoa_fisica_w,
		cd_cgc_w,
		cd_cgc_emitente_w,
		dt_emissao_w,
		cd_estabelecimento_w,
		dt_criacao_w,
		cd_cnpj_raiz_w,
		cd_cnpj_emitente_raiz_w,
		cd_tipo_servico_w,
		vl_base_calculo_w,
		cd_empresa_w
	from	estabelecimento c,
		nota_fiscal b,
		nota_fiscal_trib a
	where	b.cd_estabelecimento	= c.cd_estabelecimento
	and	a.nr_sequencia		= b.nr_sequencia
	and	b.nr_sequencia		= nr_seq_nota_fiscal_p
	and	a.cd_tributo		= cd_tributo_p
	and (coalesce(a.ie_pago_prev, 'V') = 'V');

	select	max(ie_cnpj)
	into STRICT	ie_cnpj_w
	from	tributo
	where	cd_tributo	= cd_tributo_w;

	open c02;
	loop
	fetch c02 into
		nr_titulo_w,
		nr_repasse_terceiro_w,
		nr_seq_nota_fiscal_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		if (coalesce(nr_titulo_w,0) > 0) then
			ds_lista_titulos_w	:= substr(ds_lista_titulos_w || nr_titulo_w || ',', 1, 255);
		elsif (coalesce(nr_repasse_terceiro_w,0) > 0) then
			ds_lista_repasses_w	:= substr(ds_lista_repasses_w || nr_repasse_terceiro_w || ',', 1, 255);
		elsif (coalesce(nr_seq_nota_fiscal_w,0) > 0) then
			ds_lista_notas_w	:= substr(ds_lista_notas_w || nr_seq_nota_fiscal_w || ',', 1, 255);
		end if;
	end loop;
	close c02;

elsif (coalesce(nr_seq_repasse_trib_p,0) > 0) then

	select	a.cd_tributo,
		c.cd_estabelecimento,
		b.dt_vencimento,
		c.dt_mesano_referencia,
		coalesce(b.dt_vencimento, c.dt_mesano_referencia) dt_vencto_param,
		d.cd_pessoa_fisica,
		d.cd_cgc,
		coalesce(a.dt_atualizacao_nrec,a.dt_atualizacao),
		trunc(CASE WHEN e.ie_vencimento='V' THEN  b.dt_vencimento WHEN e.ie_vencimento='C' THEN  coalesce(b.dt_vencimento, c.dt_mesano_referencia)  ELSE c.dt_mesano_referencia END , 'month'),
		obter_cnpj_raiz(d.cd_cgc),
		a.vl_base_calculo,
		f.cd_empresa
	into STRICT	cd_tributo_w,
		cd_estabelecimento_w,
		dt_vencimento_w,
		dt_mesano_referencia_w,
		dt_vencto_param_w,
		cd_pessoa_fisica_w,
		cd_cgc_w,
		dt_criacao_w,
		dt_trib_repasse_w,
		cd_cnpj_raiz_w,
		vl_base_calculo_w,
		cd_empresa_w
	from	estabelecimento 	f,
		tributo 		e,
		terceiro 		d,
		repasse_terceiro	c,
		repasse_terceiro_venc 	b,
		repasse_terc_venc_trib	a
	where	c.cd_estabelecimento	= f.cd_estabelecimento
	and	a.nr_seq_rep_venc	= b.nr_sequencia
	and	b.nr_repasse_terceiro	= c.nr_repasse_terceiro
	and	c.nr_seq_terceiro	= d.nr_sequencia
	and	a.cd_tributo		= e.cd_tributo
	and	a.nr_sequencia		= nr_seq_repasse_trib_p;

	select	ie_cnpj
	into STRICT	ie_cnpj_w
	from	tributo
	where	cd_tributo	= cd_tributo_w;

	open c03;
	loop
	fetch c03 into
		nr_titulo_w,
		nr_repasse_terceiro_w,
		nr_seq_nota_fiscal_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		if (coalesce(nr_titulo_w,0) > 0) then
			ds_lista_titulos_w	:= substr(ds_lista_titulos_w || nr_titulo_w || ',', 1, 255);
		elsif (coalesce(nr_repasse_terceiro_w,0) > 0) then
			ds_lista_repasses_w	:= substr(ds_lista_repasses_w || nr_repasse_terceiro_w || ',', 1, 255);
		elsif (coalesce(nr_seq_nota_fiscal_w,0) > 0) then
			ds_lista_notas_w	:= substr(ds_lista_notas_w || nr_seq_nota_fiscal_w || ',', 1, 255);
		end if;
	end loop;
	close c03;
elsif (coalesce(nr_seq_pag_prest_venc_trib_p,0) > 0) then

	select	a.cd_tributo,
		e.cd_estabelecimento,
		CASE WHEN f.ie_tipo_tributo='IR' THEN  e.dt_mes_competencia WHEN f.ie_tipo_tributo='ISRDOM' THEN  e.dt_mes_competencia  ELSE CASE WHEN f.ie_vencimento='V' THEN  b.dt_vencimento WHEN f.ie_vencimento='C' THEN  coalesce(b.dt_vencimento, e.dt_mes_competencia)  ELSE e.dt_mes_competencia END  END ,
		e.dt_mes_competencia,
		coalesce(b.dt_vencimento, e.dt_mes_competencia) dt_vencto_param,
		h.cd_pessoa_fisica,
		h.cd_cgc,
		coalesce(a.dt_atualizacao_nrec,a.dt_atualizacao),
		trunc(CASE WHEN f.ie_vencimento='V' THEN  b.dt_vencimento WHEN f.ie_vencimento='C' THEN  coalesce(b.dt_vencimento, e.dt_mes_competencia)  ELSE e.dt_mes_competencia END , 'month'),
		obter_cnpj_raiz(h.cd_cgc),
		a.vl_base_calculo,
		g.cd_empresa,
		e.nr_sequencia,
		f.ie_apuracao_piso
	into STRICT	cd_tributo_w,
		cd_estabelecimento_w,
		dt_vencimento_atual_w,
		dt_mesano_referencia_w,
		dt_vencto_param_w,
		cd_pessoa_fisica_w,
		cd_cgc_w,
		dt_criacao_w,
		dt_trib_repasse_w,
		cd_cnpj_raiz_w,
		vl_base_calculo_w,
		cd_empresa_w,
		nr_seq_lote_pagamento_w,
		ie_apuracao_piso_w
	from	pls_prestador			h,
		estabelecimento 		g,
		tributo 			f,
		pls_lote_pagamento		e,
		pls_pagamento_prestador 	d,
		pls_pag_prest_vencimento	b,
		pls_pag_prest_venc_trib 	a
	where	e.cd_estabelecimento		= g.cd_estabelecimento
	and	d.nr_seq_lote			= e.nr_sequencia
	and	b.nr_seq_pag_prestador		= d.nr_sequencia
	and	a.nr_seq_vencimento		= b.nr_sequencia
	and	d.nr_seq_prestador		= h.nr_sequencia
	and	a.cd_tributo			= f.cd_tributo
	and	a.nr_sequencia			= nr_seq_pag_prest_venc_trib_p;

	qt_tributo_w := 0;
	if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
		select	count(1)
		into STRICT	qt_tributo_w
		from	tributo d,
			valores_tributo_v a
		where	coalesce(a.cd_empresa,coalesce(cd_empresa_w,0)) = coalesce(cd_empresa_w,0)
		and	a.cd_tributo = d.cd_tributo
		and	a.cd_tributo = cd_tributo_w
		and	a.cd_pessoa_fisica = cd_pessoa_fisica_w
		and	a.dt_tributo_mes = trunc(dt_vencimento_atual_w, 'month')
		and	((a.ie_origem_valores = 'PP') or (d.ie_apuracao_piso = 'S'))
		and	((d.ie_restringe_estab = 'N') or (a.cd_estabelecimento = cd_estabelecimento_w) or (a.cd_estab_financeiro = cd_estabelecimento_w))
		and	((d.ie_apuracao_piso = 'N') or (d.ie_apuracao_piso = a.ie_base_calculo))
		and	not exists (	SELECT	1
					from	pls_pagamento_prestador	y
					where	y.nr_sequencia = a.nr_seq_pag_prest
					and	y.nr_seq_lote = nr_seq_lote_pagamento_w)
		and	a.dt_criacao > dt_criacao_w;
	end if;
	
	if (qt_tributo_w = 0) and (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') then
		select	count(1)
		into STRICT	qt_tributo_w
		from	tributo d,
			valores_tributo_v a
		where	coalesce(a.cd_empresa,coalesce(cd_empresa_w,0)) = coalesce(cd_empresa_w,0)
		and	a.cd_tributo = d.cd_tributo
		and	a.cd_tributo = cd_tributo_w
		and	a.cd_cgc = cd_cgc_w
		and	a.dt_tributo_mes = trunc(dt_vencimento_atual_w, 'month')
		and	((a.ie_origem_valores = 'PP') or (d.ie_apuracao_piso = 'S'))
		and	((d.ie_restringe_estab = 'N') or (a.cd_estabelecimento = cd_estabelecimento_w) or (a.cd_estab_financeiro = cd_estabelecimento_w))
		and	((d.ie_apuracao_piso = 'N') or (d.ie_apuracao_piso = a.ie_base_calculo))
		and	not exists (	SELECT	1
					from	pls_pagamento_prestador	y
					where	y.nr_sequencia = a.nr_seq_pag_prest
					and	y.nr_seq_lote = nr_seq_lote_pagamento_w)
		and	a.dt_criacao > dt_criacao_w;
	end if;
	
	if (qt_tributo_w = 0) and (cd_cnpj_raiz_w IS NOT NULL AND cd_cnpj_raiz_w::text <> '') and (ie_cnpj_w = 'Empresa') then
		select	count(1)
		into STRICT	qt_tributo_w
		from	tributo d,
			valores_tributo_v a
		where	coalesce(a.cd_empresa,coalesce(cd_empresa_w,0)) = coalesce(cd_empresa_w,0)
		and	a.cd_tributo = d.cd_tributo
		and	a.cd_tributo = cd_tributo_w
		and	ie_cnpj_w = 'Empresa'
		and 	a.cd_cnpj_raiz = cd_cnpj_raiz_w
		and	a.dt_tributo_mes = trunc(dt_vencimento_atual_w, 'month')
		and	((a.ie_origem_valores = 'PP') or (d.ie_apuracao_piso = 'S'))
		and	((d.ie_restringe_estab = 'N') or (a.cd_estabelecimento = cd_estabelecimento_w) or (a.cd_estab_financeiro = cd_estabelecimento_w))
		and	((d.ie_apuracao_piso = 'N') or (d.ie_apuracao_piso = a.ie_base_calculo))
		and	not exists (	SELECT	1
					from	pls_pagamento_prestador	y
					where	y.nr_sequencia = a.nr_seq_pag_prest
					and	y.nr_seq_lote = nr_seq_lote_pagamento_w)
		and	a.dt_criacao > dt_criacao_w;
	end if;
	
	if (qt_tributo_w > 0) then
		-- O cursor 4 estava com problemas de performance, portanto quebramos o mesmo no cursor 4 e 5

		-- Quando o tributo não está com o campo 'ie_apuracao_piso' marcado trabalhamos com o cursor 4, caso contrério trabalhamos com o cursor 5
		if (ie_apuracao_piso_w = 'N') then
			for r_C04_w in c04 loop
				-- o campo 'ie_considera_item_w' foi criado para eliminar uma quantidade grande de 'or' que estava no cursor 4, ao invés de 'or' verificamos os campo com o uso de 'if' como logo abaixo
				ie_considera_item_w := 'S';
				if (r_C04_w.ie_restringe_estab = 'S') then
					if (r_C04_w.cd_estabelecimento <> cd_estabelecimento_w) and (r_C04_w.cd_estab_financeiro	<> cd_estabelecimento_w) then
						ie_considera_item_w := 'N';
					end if;
				end if;

				-- se o 'ie_considera_item_w' está como 'S' significa que este item seria retornado no cursor 4, caso contrário será barrado neste momento
				if (ie_considera_item_w = 'S') then
					if (coalesce(r_C04_w.nr_titulo,0) > 0) then
						ds_lista_titulos_w	:= substr(ds_lista_titulos_w || r_C04_w.nr_titulo || ',', 1, 255);
					elsif (coalesce(r_C04_w.nr_repasse_terceiro,0) > 0) then
						ds_lista_repasses_w	:= substr(ds_lista_repasses_w || r_C04_w.nr_repasse_terceiro || ',', 1, 255);
					elsif (coalesce(r_C04_w.nr_seq_nota_fiscal,0) > 0) then
						ds_lista_notas_w	:= substr(ds_lista_notas_w || r_C04_w.nr_seq_nota_fiscal || ',', 1, 255);
					elsif (coalesce(r_C04_w.nr_seq_pag_prest,0) > 0) then
						ds_lista_pag_prest_w	:= substr(ds_lista_pag_prest_w || r_C04_w.nr_seq_pag_prest ||',', 1, 255);
					end if;
				end if;
			end loop;
		elsif (ie_apuracao_piso_w = 'S') then
		
			for r_C05_w in c05 loop
				-- o campo 'ie_considera_item_w' foi criado para eliminar uma quantidade grande de 'or' que estava no cursor 4, ao invés de 'or' verificamos os campo com o uso de 'if' como logo abaixo
				ie_considera_item_w := 'S';
				if (r_C05_w.ie_restringe_estab = 'S') then
					if (r_C05_w.cd_estabelecimento <> cd_estabelecimento_w) and (r_C05_w.cd_estab_financeiro	<> cd_estabelecimento_w) then
						ie_considera_item_w := 'N';
					end if;
				end if;

				if (r_C05_w.cd_cgc <> cd_cgc_w) then
					if (r_C05_w.cd_pessoa_fisica <> cd_pessoa_fisica_w) then
						if	(ie_cnpj_w = 'Empresa' AND r_C05_w.cd_cnpj_raiz = cd_cnpj_raiz_w) then
							ie_considera_item_w := 'N';
						end if;
					end if;
				end if;

				--- se o 'ie_considera_item_w' está como 'S' significa que este item seria retornado no cursor 4, caso contrário será barrado neste momento
				if (ie_considera_item_w = 'S') then
					if (coalesce(r_C05_w.nr_titulo,0) > 0) then
						ds_lista_titulos_w	:= substr(ds_lista_titulos_w || r_C05_w.nr_titulo || ',', 1, 255);
					elsif (coalesce(r_C05_w.nr_repasse_terceiro,0) > 0) then
						ds_lista_repasses_w	:= substr(ds_lista_repasses_w || r_C05_w.nr_repasse_terceiro || ',', 1, 255);
					elsif (coalesce(r_C05_w.nr_seq_nota_fiscal,0) > 0) then
						ds_lista_notas_w	:= substr(ds_lista_notas_w || r_C05_w.nr_seq_nota_fiscal || ',', 1, 255);
					elsif (coalesce(r_C05_w.nr_seq_pag_prest,0) > 0) then
						ds_lista_pag_prest_w	:= substr(ds_lista_pag_prest_w || r_C05_w.nr_seq_pag_prest ||',', 1, 255);
					end if;
				end if;
			end loop;
		end if;
	end if;
end if;

if (ds_lista_titulos_w = ',') then
	ds_lista_titulos_w	:= '';
end if;

if (ds_lista_repasses_w = ',') then
	ds_lista_repasses_w	:= '';
end if;

if (ds_lista_notas_w = ',') then
	ds_lista_notas_w	:= '';
end if;

if (ds_lista_pag_prest_w = ',') then
	ds_lista_pag_prest_w	:= '';
end if;

SELECT * FROM obter_dados_trib_tit_pagar(	cd_tributo_w, cd_estabelecimento_w, cd_cgc_w, cd_pessoa_fisica_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ie_acumulativo_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, coalesce(coalesce(dt_vencimento_atual_w, dt_emissao_w),dt_trib_repasse_w), ds_irrelevante_w, ds_irrelevante_w, null, null, cd_tipo_servico_w, null, null, null, ds_irrelevante_w, null, 0, ds_irrelevante_w, ds_irrelevante_w, vl_base_calculo_w, 'N', nr_seq_classe_w, null, null, null) INTO STRICT ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ie_acumulativo_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w;

CALL gravar_Log_tasy(89741, ' cd_tributo_w : ' || cd_tributo_w || ' ie_acumulativo_w : ' || ie_acumulativo_w, 'Tasy');

if (ie_commit_p = 'S') then
	commit;
end if;

if (coalesce(ie_acumulativo_w, 'N') = 'S') then
	ds_lista_titulos_p	:= substr(ds_lista_titulos_w, 1, 255);
	ds_lista_repasses_p	:= substr(ds_lista_repasses_w, 1, 255);
	ds_lista_notas_p	:= substr(ds_lista_notas_w, 1, 255);
	ds_lista_pag_prest_p	:= substr(ds_lista_pag_prest_w, 1, 255);
else
	ds_lista_titulos_p	:= null;
	ds_lista_repasses_p	:= null;
	ds_lista_notas_p	:= null;
	ds_lista_pag_prest_w	:= null;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_tributos_posteriores ( nr_seq_tit_imposto_p bigint, nr_seq_nota_fiscal_p bigint, nr_seq_repasse_trib_p bigint, nr_seq_pag_prest_venc_trib_p bigint, cd_tributo_p tributo.cd_tributo%type, ds_lista_titulos_p INOUT text, ds_lista_repasses_p INOUT text, ds_lista_notas_p INOUT text, ds_lista_pag_prest_p INOUT text, ie_commit_p text default 'S') FROM PUBLIC;

