-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rp_finalizar_modelo_agend (nr_seq_modelo_p text, nr_seq_motivo_p text, nm_usuario_p text, ie_opcao_p text, dt_fim_tratamento_p timestamp) AS $body$
DECLARE


nr_seq_modelo_pac_w	bigint;
ie_existe_sem_fim_w	varchar(1);
nr_seq_hora_w		agenda_consulta.nr_seq_hora%type;		
				    
/*
Opcoes
	M - Finalizar Modelo
	I -  Finalizar Item do Modelo
*/
	
C01 CURSOR FOR
	SELECT	nr_sequencia,
				cd_agenda,
				dt_agenda
	from	agenda_consulta
	where	((ie_opcao_p = 'M' and nr_seq_rp_mod_item(	SELECT	nr_sequencia 
																			from 	rp_pac_modelo_agend_item 
																			where 	nr_seq_modelo_pac = nr_seq_modelo_p))
			or (ie_opcao_p = 'I' and nr_seq_rp_mod_item 	= nr_seq_modelo_p))
	and	ie_status_agenda not in ('C','B','E','F', 'I', 'S', 'AD');
	
c01_w	C01%ROWTYPE;
	

BEGIN

if (ie_opcao_p = 'M') then
	begin
	
	update	rp_pac_modelo_agendamento
	set	nr_seq_motivo_fim_tratamento 	= nr_seq_motivo_p,
		dt_fim_tratamento 		= dt_fim_tratamento_p,
		nm_usuario 			= nm_usuario_p,
		dt_atualizacao			= clock_timestamp()
	where	nr_sequencia  			= nr_seq_modelo_p;
		
	update	rp_pac_modelo_agend_item
	set	nr_seq_motivo_fim_tratamento 	= nr_seq_motivo_p,
		dt_fim_tratamento 		= dt_fim_tratamento_p,
		nm_usuario 			= nm_usuario_p,
		dt_atualizacao			= clock_timestamp()
	where	nr_seq_modelo_pac		= nr_seq_modelo_p
	and	coalesce(dt_fim_tratamento::text, '') = '';
	
	open C01;
	loop
	fetch C01 into	
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		nr_seq_hora_w	:=  null;
		
		select	coalesce(max(nr_seq_hora),0) + 1
		into STRICT	nr_seq_hora_w
		from	agenda_consulta
		where	cd_agenda	= c01_w.cd_agenda
		and	dt_agenda	= c01_w.dt_agenda;
	
		update	agenda_consulta
		set	ie_status_agenda 	= 'C',
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p,
			nr_seq_hora		= nr_seq_hora_w
		where	nr_sequencia = c01_w.nr_sequencia;
	
	end loop;
	close C01;
	
	end;
elsif (ie_opcao_p = 'I') then
	begin
	
	select	max(nr_seq_modelo_pac)
	into STRICT	nr_seq_modelo_pac_w
	from	rp_pac_modelo_agend_item
	where	nr_sequencia 			= nr_seq_modelo_p;
	
	update	rp_pac_modelo_agend_item
	set	nr_seq_motivo_fim_tratamento 	= nr_seq_motivo_p,
		dt_fim_tratamento 		= dt_fim_tratamento_p,
		nm_usuario 			= nm_usuario_p,
		dt_atualizacao			= clock_timestamp()
	where	nr_sequencia     		= nr_seq_modelo_p;

	open C01;
	loop
	fetch C01 into	
			c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	
		nr_seq_hora_w	:=  null;
		
		select	coalesce(max(nr_seq_hora),0) + 1
		into STRICT	nr_seq_hora_w
		from	agenda_consulta
		where	cd_agenda	= c01_w.cd_agenda
		and	dt_agenda	= c01_w.dt_agenda;
	
		update	agenda_consulta
		set	ie_status_agenda 	= 'C',
				dt_atualizacao		= clock_timestamp(),
				nm_usuario		= nm_usuario_p,
				nr_seq_hora		= nr_seq_hora_w
		where	nr_sequencia = c01_w.nr_sequencia;
	
	end loop;
	close C01;
	
	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_existe_sem_fim_w
	from	rp_pac_modelo_agend_item
	where	nr_seq_modelo_pac		= nr_seq_modelo_pac_w
	and	coalesce(dt_fim_tratamento::text, '') = '';
	
	if (ie_existe_sem_fim_w = 'N') then
		begin
		update	rp_pac_modelo_agendamento
		set	nr_seq_motivo_fim_tratamento 	= nr_seq_motivo_p,
			dt_fim_tratamento 		= dt_fim_tratamento_p,
			nm_usuario 			= nm_usuario_p,
			dt_atualizacao			= clock_timestamp()
		where	nr_sequencia  			= nr_seq_modelo_pac_w;
		end;
	end if;
	
	end;
end if;
	
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rp_finalizar_modelo_agend (nr_seq_modelo_p text, nr_seq_motivo_p text, nm_usuario_p text, ie_opcao_p text, dt_fim_tratamento_p timestamp) FROM PUBLIC;

