-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE plt_estender_plano ( nr_seq_regra_p bigint, ie_modificar_p text, dt_inicio_plano_p timestamp, dt_fim_plano_p timestamp, nr_atendimento_p INOUT bigint, cd_pessoa_fisica_p text, cd_medico_p text, ie_copia_agora_p text, ie_reinicia_cont_p text, nr_seq_modelo_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, qt_dias_extensao_p bigint, ds_retorno_p INOUT text, nr_prescr_extensao_p INOUT bigint, dt_plano_p text, nr_seq_acao_p bigint, cd_setor_atendimento_p bigint, ie_curta_duracao_p text) AS $body$
DECLARE


ie_tipo_item_w			varchar(3);
nr_prescricao_w			bigint;
nr_seq_item_w			numeric(22);
nr_prescr_nova_w		bigint := 0;
ie_atend_alta_w			varchar(1);
ds_lista_medic_w		varchar(4000);
ds_lista_supl_w			varchar(4000);
ds_lista_sne_w			varchar(4000);
ds_lista_proced_w		varchar(4000);
ds_lista_dieta_w		varchar(4000);
ds_prescrito_w			varchar(255);
cd_intervalo_w			varchar(7);
cd_item_w				varchar(255);
qt_item_w				double precision;
nr_seq_leite_deriv_w	bigint;
cd_pessoa_usuario_w		varchar(10);
dt_inicio_plano_w		timestamp;
qt_prescr_w				bigint;
dt_validade_prescr_w	timestamp;
dt_prim_hor_prescr_w	timestamp;
cd_setor_atendimento_w	integer;
cd_setor_atend_alta_w	integer;
ie_estender_w			varchar(3);
hr_prescr_w				varchar(5);
hr_setor_w				varchar(5);
ds_log_w				varchar(2000);
dt_rep_pt_nova_w		timestamp;
dt_rep_pt_w				timestamp;
dt_rep_pt_orig_w		timestamp;
ds_prescr_sem_plano_w	varchar(2000);
ie_existe_w				varchar(2);
ie_estendida_liberacao_w varchar(1);
nr_seq_log_w			bigint;
nr_horas_validade_w		integer;
dt_inicio_prescr_w		timestamp;
dt_validade_prescr_ww	timestamp;
ie_suspende_horarios_w	varchar(1) := 'N';
VarQuestionaSetorEstender_w	varchar(2);
dt_quebra_setor_w		timestamp;
ie_prescr_pos_alta_w	varchar(1);
dt_alta_medico_w		timestamp;
ie_respiracao_w			prescr_gasoterapia.ie_respiracao%type;
ie_disp_resp_esp_w		prescr_gasoterapia.ie_disp_resp_esp%type;
ie_modo_adm_w			prescr_gasoterapia.ie_modo_adm%type;
nr_sequencia_w			prescr_mat_hor.nr_sequencia%type;
ie_existe_compl_w		smallint := 0;
ie_param110_w			varchar(1);
ie_motivo_w 			varchar(15);
nr_horas_val_orig_w		prescr_medica.nr_horas_validade%type;
ie_permite_prescricao_w varchar(1);
cd_setor_atual_w		integer;
ie_emergencia_w			prescr_medica.ie_emergencia%type;
dt_inicio_prescr_ww		prescr_medica.dt_inicio_prescr%type;


c01 REFCURSOR;

c02 CURSOR FOR
SELECT	ie_tipo_item,
	nr_prescricao,
	nr_seq_item,
	substr(ds_prescrito,1,255),
	cd_intervalo
from	w_rep_t_v
where	nm_usuario		= nm_usuario_p
and	ie_copiar		= 'N'
and	coalesce(nr_prescr_titulo::text, '') = ''
and	ie_modificar_p		= 'N'
and	((ADEP_obter_se_item_modelo(CASE WHEN ie_classif_adep='SADT' THEN ie_classif_adep  ELSE ie_tipo_item END ,nr_seq_modelo_p,coalesce(ie_hemodialise,'N')) = 'S') or (coalesce(nr_seq_modelo_p,0) = 0));

c03 CURSOR FOR
SELECT	a.ie_tipo_item,
		a.nr_prescricao,
		a.nr_seq_item,
		substr(a.ds_prescrito,1,255),
		a.cd_intervalo,
		CASE WHEN a.ie_estendido='P' THEN 'CD'  ELSE 'NCD' END ,
		coalesce(b.ie_emergencia,'N')
from	w_rep_t_v a,
		prescr_medica b	
where	a.nm_usuario		= nm_usuario_p
and		a.ie_copiar		= 'S'
and		a.nr_prescricao = b.nr_prescricao
and		((coalesce(ie_curta_duracao_p,'N') = 'S' and a.ie_estendido 	<> 'P') or (coalesce(ie_curta_duracao_p,'N') = 'N' and a.ie_estendido 	= 'P') or (coalesce(b.ie_emergencia,'N') = 'S'))
and		coalesce(a.nr_prescr_titulo::text, '') = ''
and		((ADEP_obter_se_item_modelo(CASE WHEN a.ie_classif_adep='SADT' THEN a.ie_classif_adep  ELSE a.ie_tipo_item END ,nr_seq_modelo_p,coalesce(a.ie_hemodialise,'N')) = 'S') or (coalesce(nr_seq_modelo_p,0) = 0));
		
c04 CURSOR FOR
SELECT	nr_sequencia
from	prescr_mat_hor
where	nr_prescricao = nr_prescricao_w 
and 	dt_horario >= clock_timestamp() 
and 	coalesce(dt_suspensao::text, '') = '';


BEGIN

if (coalesce(cd_setor_atendimento_p::text, '') = '') or (cd_setor_atendimento_p = 0) then
	cd_setor_atual_w := Obter_Setor_nova_prescr(nr_atendimento_p,nm_usuario_p,cd_perfil_p,cd_estabelecimento_p);
else
	cd_setor_atual_w := cd_setor_atendimento_p;
end if;

ie_permite_prescricao_w := Obter_se_permite_prescr(cd_perfil_p, cd_setor_atual_w, nr_atendimento_p);

if (ie_permite_prescricao_w = 'N') then
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(270411);
end if;

CALL Wheb_assist_pck.set_informacoes_usuario(cd_estabelecimento_p, cd_perfil_p, nm_usuario_p);
ie_param110_w := Obter_Param_Usuario(950, 110, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_param110_w);

if (coalesce(ie_curta_duracao_p,'N') = 'N') then
	open c01 for
	SELECT	a.ie_tipo_item,
			a.nr_prescricao,
			a.nr_seq_item,
			a.cd_item,
			a.cd_intervalo,
			a.qt_item,
			a.nr_seq_leite_deriv,
			a.ie_respiracao,
			a.ie_disp_resp_esp,
			a.ie_modo_adm
	from	w_rep_t_v a,
			prescr_medica b
	where	a.nm_usuario		= nm_usuario_p
	and		a.nr_prescricao = b.nr_prescricao
	and		a.ie_copiar		= 'S'
	--and 	ie_estendido 	<> 'P'
	and		coalesce(a.nr_prescr_titulo::text, '') = ''
	and		((ADEP_obter_se_item_modelo(CASE WHEN a.ie_classif_adep='SADT' THEN a.ie_classif_adep  ELSE a.ie_tipo_item END ,nr_seq_modelo_p,coalesce(a.ie_hemodialise,'N')) = 'S') or (coalesce(nr_seq_modelo_p,0) = 0))
	and 	coalesce(b.ie_emergencia,'N') = 'N'	
	and		coalesce(a.ie_tipo_item,'XPTO') <> 'E'
	and		b.cd_pessoa_fisica = cd_pessoa_fisica_p
	order by a.nr_agrupamento,
			 a.nr_seq_item;
else
	open c01 for
	SELECT	a.ie_tipo_item,
			a.nr_prescricao,
			a.nr_seq_item,
			a.cd_item,
			a.cd_intervalo,
			a.qt_item,
			a.nr_seq_leite_deriv,
			a.ie_respiracao,
			a.ie_disp_resp_esp,
			a.ie_modo_adm
	from	w_rep_t_v a,
			prescr_medica b
	where	a.nm_usuario		= nm_usuario_p
	and		a.nr_prescricao = b.nr_prescricao
	and		a.ie_copiar		= 'S'
	and 	a.ie_estendido 	= 'P'
	and		coalesce(a.nr_prescr_titulo::text, '') = ''
	and		((ADEP_obter_se_item_modelo(CASE WHEN a.ie_classif_adep='SADT' THEN a.ie_classif_adep  ELSE a.ie_tipo_item END ,nr_seq_modelo_p,coalesce(a.ie_hemodialise,'N')) = 'S') or (coalesce(nr_seq_modelo_p,0) = 0))
	and 	coalesce(b.ie_emergencia,'N') = 'N'
	and		coalesce(a.ie_tipo_item,'XPTO') <> 'E'
	and		b.cd_pessoa_fisica = cd_pessoa_fisica_p
	order by a.nr_agrupamento,
			 a.nr_seq_item;
end if;

dt_inicio_plano_w	:= dt_inicio_plano_p;

dt_quebra_setor_w := coalesce(dt_fim_plano_p,clock_timestamp()) + 1/86400;

if (coalesce(qt_dias_extensao_p,0) < 2)	 then
	
	begin
		select	nr_prescricao
		into STRICT	nr_prescr_nova_w
		from	prescr_medica
		where	dt_validade_prescr	= dt_fim_plano_p
		and		nr_atendimento		= nr_atendimento_p
		and		nm_usuario_original	= nm_usuario_p
		and		coalesce(coalesce(dt_liberacao_medico, dt_liberacao)::text, '') = ''
		and		((to_char(dt_inicio_prescr,'hh24:mi') = to_char(dt_quebra_setor_w,'hh24:mi')) or (dt_inicio_plano_w  = dt_inicio_prescr) or (ie_modificar_p = 'S'))
		and		dt_inicio_plano_w  	>= dt_inicio_prescr
		and		coalesce(cd_funcao_origem,924) = 950  LIMIT 1;
	exception
	when others then
		nr_prescr_nova_w := 0;
	end;	
	
end if;	

if (nr_prescr_nova_w	= 0) then

	ie_atend_alta_w		:= obter_se_atendimento_alta(nr_atendimento_p);

	select	max(plt_obter_prescricao(nr_prescricao,nr_prescricoes,nr_prescr_titulo,nm_usuario_p,cd_pessoa_fisica_p,'P'))
	into STRICT	nr_prescricao_w
	from	w_rep_t_v
	where	nm_usuario		= nm_usuario_p
	and		ie_copiar		= 'S'
	and		coalesce(nr_prescr_titulo::text, '') = '';
		
	if (nr_atendimento_p	> 0) and (ie_atend_alta_w	= 'S') then
		
		nr_atendimento_p	:= obter_atendimento_paciente(cd_pessoa_fisica_p, cd_estabelecimento_p);

		if (coalesce(nr_atendimento_p,0)	> 0) then

			cd_setor_atend_alta_w	:= Obter_Setor_nova_prescr(nr_atendimento_p,nm_usuario_p,cd_perfil_p,cd_estabelecimento_p);
		
			ds_retorno_p		:= wheb_mensagem_pck.get_texto(294369,'NR_ATENDIMENTO='||nr_atendimento_p);
			
			select	max(dt_validade_prescr)
			into STRICT	dt_validade_prescr_w
			from	prescr_medica
			where	nr_prescricao	= nr_prescricao_w  LIMIT 1;
			
			if	((dt_inicio_plano_w - 1)	> dt_validade_prescr_w) then
			
				dt_prim_hor_prescr_w	:= converte_char_data(	to_char(clock_timestamp(),'dd/mm/yyyy'),
										to_char(PLT_Obter_Prim_Hor_Plano(nr_atendimento_p,cd_setor_atend_alta_w,clock_timestamp(),nm_usuario_p),
										'hh24:mi')||':00',null);
				if (dt_inicio_plano_w	> dt_prim_hor_prescr_w) then
					dt_inicio_plano_w	:= dt_prim_hor_prescr_w;
					ie_estender_w		:= 'SE';
				else
					hr_prescr_w		:= to_char(dt_inicio_plano_w,'hh24:mi');
					
					select	max(to_char(hr_inicio_prescricao,'hh24:mi'))
					into STRICT	hr_setor_w
					from	setor_atendimento
					where	cd_setor_atendimento	= cd_setor_atend_alta_w  LIMIT 1;
					
					if (hr_prescr_w	<> hr_setor_w) then
						ie_estender_w		:= 'SE';
					end if;
				end if;
			
			end if;
			
		else
			ds_retorno_p		:= wheb_mensagem_pck.get_texto(294370,null);
			
			nr_atendimento_p	:= 0;
		end if;
	end if;
	
	ie_prescr_pos_alta_w				:= Wheb_assist_pck.obterParametroFuncao(924,174);
	
	if (ie_prescr_pos_alta_w	= 'N') then
		
		select	max(dt_alta_medico)
		into STRICT	dt_alta_medico_w
		from	atendimento_paciente
		where	nr_atendimento = nr_atendimento_p  LIMIT 1;
		
		if (dt_alta_medico_w IS NOT NULL AND dt_alta_medico_w::text <> '') then
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(283054);
		end if;
	end if;	
	
	if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then
	
		VarQuestionaSetorEstender_w := Obter_Param_Usuario(950, 161, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, VarQuestionaSetorEstender_w);
			
		if (coalesce(ie_estender_w::text, '') = '') and (ie_modificar_p	= 'S') then
			
			select	coalesce(max(ie_estendida_liberacao),'N'),
					max(dt_rep_pt),
					max(nr_horas_validade)
			into STRICT	ie_estendida_liberacao_w,
					dt_rep_pt_orig_w,
					nr_horas_val_orig_w
			from	prescr_medica
			where	nr_prescricao	= nr_prescricao_w  LIMIT 1;
			
			if (ie_estendida_liberacao_w	= 'S') then
				ie_estender_w	:= 'SE';
			end if;
			
		end if;
		
		dt_inicio_prescr_ww := dt_inicio_plano_w;
		
		if (ie_modificar_p = 'S') then
			
			select 	max(dt_inicio_prescr)
			into STRICT 	dt_inicio_prescr_ww
			from 	prescr_medica
			where	nr_prescricao = nr_prescricao_w;
			
			if (dt_inicio_plano_w > dt_inicio_prescr_ww) then
				dt_inicio_prescr_ww := dt_inicio_plano_w;
			end if;
		end if;
		
		if (coalesce(cd_setor_atend_alta_w::text, '') = '') then
			cd_setor_atendimento_w	:= Obter_Setor_nova_prescr(nr_atendimento_p,nm_usuario_p,cd_perfil_p,cd_estabelecimento_p);
		else
			cd_setor_atendimento_w	:= cd_setor_atend_alta_w;
		end if;
		
		if (coalesce(ie_estender_w,'XPTO')		<> 'SE') and (VarQuestionaSetorEstender_w	= 'S') and (ie_atend_alta_w		<> 'S') and (cd_setor_atendimento_p IS NOT NULL AND cd_setor_atendimento_p::text <> '') and (cd_setor_atendimento_p		<> coalesce(cd_setor_atendimento_w,0)) then
			ie_estender_w	:= 'SE';
		end if;	
	
		nr_prescr_nova_w := PLT_copia_Prescricao_regra(	nr_prescricao_w, nr_atendimento_p, nr_seq_regra_p, nm_usuario_p, cd_medico_p, dt_inicio_plano_w, null, to_char(dt_inicio_prescr_ww,'hh24:mi'), cd_perfil_p, null, null, nr_prescr_nova_w, ie_estender_w, qt_dias_extensao_p, cd_setor_atendimento_p);
						
		if	((ie_modificar_p			= 'S') and
			((ie_estender_w			= 'SE' AND ie_estendida_liberacao_w	= 'S') or (nr_horas_val_orig_w > 24))) then
			
			select	max(nr_horas_validade),
					max(dt_rep_pt)
			into STRICT	nr_horas_validade_w,
					dt_rep_pt_nova_w
			from	prescr_medica
			where	nr_prescricao	= nr_prescr_nova_w  LIMIT 1;
			
			if (dt_rep_pt_nova_w	= dt_rep_pt_orig_w) and (nr_horas_validade_w	< 24) then
				update	prescr_medica
				set	nr_horas_validade	= (nr_horas_validade + 24)
				where	nr_prescricao		= nr_prescr_nova_w;
			end if;
			
		end if;
						
	end if;					

end if;

loop
fetch C01 into	
	ie_tipo_item_w,
	nr_prescricao_w,
	nr_seq_item_w,
	cd_item_w,
	cd_intervalo_w,
	qt_item_w,
	nr_seq_leite_deriv_w,
	ie_respiracao_w,
	ie_disp_resp_esp_w,
	ie_modo_adm_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	if (nr_seq_item_w > nr_prescricao_w) then
		nr_seq_item_w := replace(nr_seq_item_w, nr_prescricao_w, '');
	end if;
	
	ds_log_w	:= substr(ds_log_w||'Tipo='||ie_tipo_item_w||obter_desc_expressao(309308)/*' Prescr='*/||'= '||nr_prescricao_w||' Seq='||nr_seq_item_w||';',1,2000);	
	
	select	max(dt_rep_pt)
	into STRICT	dt_rep_pt_w
	from	prescr_medica
	where	nr_prescricao	= nr_prescricao_w  LIMIT 1;
	
	CALL plt_gerar_log_acao_rep_pt('E',nm_usuario_p,cd_perfil_p,dt_plano_p,nr_atendimento_p,nr_seq_acao_p,nr_prescricao_w,nr_seq_item_w,ie_tipo_item_w);
	
	if (ie_tipo_item_w	= 'J') then
		CALL plt_copia_jejum(nr_prescricao_w,nr_prescr_nova_w,nr_seq_regra_p,nm_usuario_p,ie_modificar_p,nr_seq_item_w,cd_perfil_p,cd_estabelecimento_p, ie_param110_w);
	elsif (ie_tipo_item_w	= 'D') then
		if (coalesce(ds_lista_dieta_w::text, '') = '') then
			ds_lista_dieta_w	:= nr_prescricao_w || ' ' || nr_seq_item_w || ';' || cd_item_w || ',';
		else
			ds_lista_dieta_w	:= ds_lista_dieta_w || nr_prescricao_w || ' ' || nr_seq_item_w || ';' || cd_item_w || ',';
		end if;
	elsif (ie_tipo_item_w	= 'S') then	
		if (coalesce(ds_lista_supl_w::text, '') = '') then
			ds_lista_supl_w := nr_prescricao_w || ' ' || nr_seq_item_w || ',';
		else
			ds_lista_supl_w	:= ds_lista_supl_w || nr_prescricao_w || ' ' || nr_seq_item_w || ',';
		end if;	
	elsif (ie_tipo_item_w	= 'SOL') then
		CALL plt_copia_solucao(nr_prescricao_w,nr_prescr_nova_w,nr_seq_regra_p,dt_inicio_plano_w,nr_seq_item_w,ie_modificar_p,nm_usuario_p,cd_perfil_p,cd_estabelecimento_p, ie_param110_w,ie_copia_agora_p);
	elsif (ie_tipo_item_w	= 'SNE') then	
		if (coalesce(ds_lista_sne_w::text, '') = '') then
			ds_lista_sne_w	:= nr_prescricao_w || ' ' || nr_seq_item_w || ',';
		else
			ds_lista_sne_w	:= ds_lista_sne_w || nr_prescricao_w || ' ' || nr_seq_item_w || ',';
		end if;
	elsif (ie_tipo_item_w	= 'HM') then
		CALL plt_copia_banco_sangue(nr_prescricao_w,nr_prescr_nova_w,nr_seq_item_w,nr_seq_regra_p,ie_modificar_p,nm_usuario_p,cd_perfil_p,cd_estabelecimento_p, ie_param110_w);
	elsif (ie_tipo_item_w	in ('M','ME','MAT')) then
		if (coalesce(ds_lista_medic_w::text, '') = '') then
			ds_lista_medic_w	:= nr_prescricao_w || ' ' || nr_seq_item_w || ',';
		else
			ds_lista_medic_w	:= ds_lista_medic_w || nr_prescricao_w || ' ' || nr_seq_item_w || ',';
		end if;
	elsif (ie_tipo_item_w	in ('L','P','G','C','I')) then
		if (coalesce(ds_lista_proced_w::text, '') = '') then
			ds_lista_proced_w	:= nr_prescricao_w || ' ' || nr_seq_item_w || ',';
		else
			ds_lista_proced_w	:= ds_lista_proced_w || nr_prescricao_w || ' ' || nr_seq_item_w || ',';
		end if;
	elsif (ie_tipo_item_w	= 'O') then
		CALL plt_copia_gasoterapia(	nr_prescricao_w,nr_prescr_nova_w,dt_inicio_plano_w,nr_seq_regra_p,cd_item_w,cd_intervalo_w,qt_item_w,
					ie_modificar_p,	nm_usuario_p, cd_perfil_p, cd_estabelecimento_p, ie_param110_w,ie_respiracao_w,	ie_disp_resp_esp_w,ie_modo_adm_w);
	elsif (ie_tipo_item_w	= 'R') then
		CALL plt_copia_recomendacao(	nr_prescricao_w, nr_prescr_nova_w,nr_seq_regra_p, dt_inicio_plano_w, cd_intervalo_w, cd_item_w, qt_item_w,
					ie_modificar_p,nm_usuario_p, cd_perfil_p, cd_estabelecimento_p, ie_param110_w, ie_copia_agora_p);
	elsif (ie_tipo_item_w	= 'NAN') then
		CALL plt_copia_npt_adul_prot(nr_seq_item_w, nr_prescr_nova_w, nr_seq_regra_p, nm_usuario_p, ie_tipo_item_w, ie_modificar_p, cd_perfil_p, cd_estabelecimento_p, ie_param110_w);
	elsif (ie_tipo_item_w	= 'NPN') then
		CALL plt_copia_npt(nr_seq_item_w, nr_prescr_nova_w, nr_seq_regra_p, nm_usuario_p, ie_tipo_item_w, ie_modificar_p, cd_perfil_p, cd_estabelecimento_p, ie_param110_w);
	elsif (ie_tipo_item_w = 'NPP') then
		CALL PLT_copia_npt_pediatrica(nr_seq_item_w,nr_prescr_nova_w, nr_seq_regra_p, nm_usuario_p, ie_tipo_item_w, ie_modificar_p, cd_perfil_p, cd_estabelecimento_p, ie_param110_w);
	elsif (ie_tipo_item_w	= 'LD') then
		CALL PLT_copia_leite_deriv(	nr_prescr_nova_w, nr_prescricao_w, nr_seq_item_w, nr_seq_leite_deriv_w, nr_seq_regra_p,
					ie_modificar_p, nm_usuario_p, cd_perfil_p, cd_estabelecimento_p, ie_param110_w);
	elsif (ie_tipo_item_w	= 'DI') then	
		CALL plt_copia_hemodialise(	nr_prescr_nova_w, nr_prescricao_w, nr_seq_item_w, nr_seq_regra_p, clock_timestamp(),
					nm_usuario_p,ie_modificar_p);
	end if;
	
	begin				
		open c04;
		loop
		fetch c04 into	
			nr_sequencia_w;
		EXIT WHEN NOT FOUND; /* apply on c04 */
			begin
				select	count(*)
				into STRICT	ie_existe_compl_w
				from	prescr_mat_hor_compl
				where	nr_sequencia	= nr_sequencia_w;
				
				if (ie_existe_compl_w > 0) then
					update	prescr_mat_hor_compl
					set		dt_atualizacao	= clock_timestamp(),
							nm_usuario	= nm_usuario_p,
							nm_usuario_endosso	= nm_usuario_p,
							dt_endosso	= clock_timestamp()
					where	nr_sequencia	= nr_sequencia_w;
				else
					insert into prescr_mat_hor_compl(
						nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nm_usuario_endosso,
						dt_endosso
					)
					values (
						nr_sequencia_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nm_usuario_p,
						clock_timestamp()
					);						
				end if;				
			end;
		end loop;
		close c04;		

		commit;
	
	exception
	when others then
		CALL gerar_log_prescricao(nr_prescricao_w, nr_seq_item_w, null, null, null, substr(sqlerrm,1,2000), nm_usuario_p, 37992, 'S');
	end;	
	
	end;
end loop;
close C01;

open C03;
loop
fetch C03 into	
	ie_tipo_item_w,
	nr_prescricao_w,
	nr_seq_item_w,
	ds_prescrito_w,
	cd_intervalo_w,
	ie_motivo_w,
	ie_emergencia_w;
EXIT WHEN NOT FOUND; /* apply on C03 */
	begin
	
	if (ie_emergencia_w = 'S') then
		CALL plt_avisar_nao_copiado(ds_prescrito_w,'PE',ie_tipo_item_w,nr_prescricao_w,1,nm_usuario_p,nr_seq_item_w,null,'S',cd_intervalo_w,cd_perfil_p,cd_estabelecimento_p);
	else
		CALL plt_avisar_nao_copiado(ds_prescrito_w,ie_motivo_w,ie_tipo_item_w,nr_prescricao_w,1,nm_usuario_p,nr_seq_item_w,null,'N',cd_intervalo_w,cd_perfil_p,cd_estabelecimento_p);
	end if;	
	end;
end loop;
close C03;	


if (ds_lista_medic_w IS NOT NULL AND ds_lista_medic_w::text <> '') then
	CALL plt_copia_medicamento(	nr_prescr_nova_w, nr_seq_regra_p, dt_inicio_plano_w, to_char(dt_inicio_plano_w,'hh24:mi'),cd_perfil_p, 'N', ds_lista_medic_w,
				ie_modificar_p, ie_reinicia_cont_p, nm_usuario_p, cd_estabelecimento_p, coalesce(ie_param110_w, 'N'), ie_copia_agora_p,null);
end if;
if (ds_lista_supl_w IS NOT NULL AND ds_lista_supl_w::text <> '') then
	CALL plt_copia_suplemento(nr_prescr_nova_w, nr_seq_regra_p, ds_lista_supl_w, ie_modificar_p, nm_usuario_p, cd_perfil_p, cd_estabelecimento_p, ie_param110_w, ie_copia_agora_p);
end if;
if (ds_lista_sne_w IS NOT NULL AND ds_lista_sne_w::text <> '') then
	CALL plt_copia_suporte_nut(nr_prescr_nova_w, nr_seq_regra_p, ds_lista_sne_w, ie_modificar_p, nm_usuario_p, cd_perfil_p, cd_estabelecimento_p, ie_param110_w, ie_copia_agora_p);
end if;
if (ds_lista_proced_w IS NOT NULL AND ds_lista_proced_w::text <> '') then
	
	select	max(cd_pessoa_fisica)
	into STRICT	cd_pessoa_usuario_w
	from	usuario
	where	nm_usuario	= nm_usuario_p  LIMIT 1;
	
	CALL plt_copia_procedimento(	nr_prescr_nova_w, nr_seq_regra_p, dt_inicio_plano_w, dt_inicio_plano_w, null, cd_perfil_p, cd_pessoa_usuario_w,
				'S', ds_lista_proced_w, ie_modificar_p, nm_usuario_p, cd_estabelecimento_p, ie_param110_w,ie_copia_agora_p);
end if;
if (ds_lista_dieta_w IS NOT NULL AND ds_lista_dieta_w::text <> '') then
	CALL plt_copia_dieta(nr_prescr_nova_w,nr_seq_regra_p,nm_usuario_p,ie_modificar_p,ds_lista_dieta_w,cd_perfil_p,cd_estabelecimento_p, ie_param110_w);
end if;

CALL PLT_ajustar_prescr_pos_copia(nr_prescr_nova_w,ds_log_w,ie_modificar_p,cd_perfil_p,cd_estabelecimento_p,nm_usuario_p);

select	coalesce(max(nr_prescricao),0),
		max(dt_inicio_prescr),
		max(dt_validade_prescr),
		max(dt_rep_pt)
into STRICT	nr_prescr_extensao_p,
		dt_inicio_prescr_w,
		dt_validade_prescr_ww,
		dt_rep_pt_nova_w
from	prescr_medica
where	nr_prescricao	= nr_prescr_nova_w  LIMIT 1;

while dt_rep_pt_w	< dt_rep_pt_nova_w loop
	begin
	dt_rep_pt_w	:= dt_rep_pt_w + 1;
	
	select	coalesce(max('S'),'N')
	into STRICT	ie_existe_w
	from	prescr_medica
	where	nr_atendimento	= nr_atendimento_p
	and		((dt_rep_pt	= dt_rep_pt_w) or (dt_rep_pt2	= dt_rep_pt_w) or (trunc(dt_inicio_prescr) = trunc(dt_rep_pt_w)))  LIMIT 1;
		
	if (ie_existe_w	= 'N') then
		if (coalesce(ds_prescr_sem_plano_w::text, '') = '') then
			ds_prescr_sem_plano_w := substr(wheb_mensagem_pck.get_texto(294371, 'DT='||to_char(dt_rep_pt_w,'dd/mm')),1,2000);			
		else
			ds_prescr_sem_plano_w := substr(ds_prescr_sem_plano_w||', '||to_char(dt_rep_pt_w,'dd/mm'),1,2000);
		end if;
	end if;
	
	end;
end loop;

if (nr_prescr_nova_w IS NOT NULL AND nr_prescr_nova_w::text <> '') then
	ie_suspende_horarios_w := Obter_Param_Usuario(950, 162, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_suspende_horarios_w);
	
	if (ie_suspende_horarios_w = 'S') then
		CALL Suspender_horarios_extensao(nr_atendimento_p,nr_prescr_nova_w,dt_inicio_prescr_w,nm_usuario_p);
	end if;
end if;

open C02;
loop
fetch C02 into	
	ie_tipo_item_w,
	nr_prescricao_w,
	nr_seq_item_w,
	ds_prescrito_w,
	cd_intervalo_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	CALL plt_avisar_nao_copiado(ds_prescrito_w,'OU',ie_tipo_item_w,nr_prescricao_w,1,nm_usuario_p,nr_seq_item_w,null,'S',cd_intervalo_w,cd_perfil_p,cd_estabelecimento_p);
	end;
end loop;
close C02;

if (ds_prescr_sem_plano_w IS NOT NULL AND ds_prescr_sem_plano_w::text <> '') and (ds_retorno_p IS NOT NULL AND ds_retorno_p::text <> '') then
	ds_retorno_p := substr(ds_retorno_p ||chr(10)|| ds_prescr_sem_plano_w,1,255);
elsif (ds_prescr_sem_plano_w IS NOT NULL AND ds_prescr_sem_plano_w::text <> '') then
	ds_retorno_p := substr(ds_prescr_sem_plano_w,1,255);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE plt_estender_plano ( nr_seq_regra_p bigint, ie_modificar_p text, dt_inicio_plano_p timestamp, dt_fim_plano_p timestamp, nr_atendimento_p INOUT bigint, cd_pessoa_fisica_p text, cd_medico_p text, ie_copia_agora_p text, ie_reinicia_cont_p text, nr_seq_modelo_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, qt_dias_extensao_p bigint, ds_retorno_p INOUT text, nr_prescr_extensao_p INOUT bigint, dt_plano_p text, nr_seq_acao_p bigint, cd_setor_atendimento_p bigint, ie_curta_duracao_p text) FROM PUBLIC;

