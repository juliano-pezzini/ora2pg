-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qms_renova_treinamento () AS $body$
DECLARE


cd_pessoa_fisica_w	qms_treinamento.cd_pessoa_fisica%type;
cd_responsavel_w	qms_treinamento.cd_responsavel%type;
cd_cargo_w              cargo.cd_cargo%type;

C01 CURSOR FOR
	SELECT  DISTINCT
                pf.cd_pessoa_fisica,
                (SELECT  res.cd_responsavel
        	from    qms_treinamento res
        	where   res.nr_sequencia = (select  max(ult.nr_sequencia) 
                                	from    qms_treinamento ult
                                	where   ult.cd_pessoa_fisica = pf.cd_pessoa_fisica)) cd_responsavel,
                car.cd_cargo
        FROM    cargo car,
                usuario usu,
                pessoa_fisica pf,
                qms_treinamento qt
        WHERE   qt.cd_pessoa_fisica = pf.cd_pessoa_fisica
        AND     pf.cd_pessoa_fisica = usu.cd_pessoa_fisica
        AND     car.cd_cargo = pf.cd_cargo
        AND     car.ie_situacao = 'A'
        AND 	usu.ie_situacao = 'A'
        AND     (qt.cd_responsavel IS NOT NULL AND qt.cd_responsavel::text <> '')
        ORDER BY car.cd_cargo;


BEGIN
open C01;
        loop
        fetch C01 into
                cd_pessoa_fisica_w,
                cd_responsavel_w,
                cd_cargo_w;
        EXIT WHEN NOT FOUND; /* apply on C01 */
        begin
                CALL gerar_necessidade_treinamento(  cd_pessoa_fisica_p      => cd_pessoa_fisica_w,
                                                cd_responsavel_p        => cd_responsavel_w,
                                                cd_gerente_p            => null,
                                                cd_cargo_p              => cd_cargo_w,
                                                ie_nova_revisao_p       => 'N',
                                                ie_analise_eficacia_p   => 'N',
                                                cd_pessoa_eficacia_p    => 'N',
                                                nm_usuario_p            => 'TASY',
                                                cd_treinamento_cargo_p  => null);
        end;
        end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qms_renova_treinamento () FROM PUBLIC;

