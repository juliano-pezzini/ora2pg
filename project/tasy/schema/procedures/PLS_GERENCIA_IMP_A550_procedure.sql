-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerencia_imp_a550 ( nm_arquivo_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_camara_contest_p INOUT ptu_camara_contestacao.nr_sequencia%type) AS $body$
DECLARE

					
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Gerenciar a importação do arquivo A550 
	Gerar log PTU_PROCESSO_CAMARA_CONT
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[X]  Objetos do dicionário [X] Tasy (Delphi/Java) [ X] Portal [ X]  Relatórios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------

Pontos de atenção:
Alterações:
-------------------------------------------------------------------------------------------------------------------

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ds_conteudo_w		varchar(4000);
ie_leitura_w		boolean := true;
ie_versao_w		varchar(10);
nr_seq_referencia_w	bigint;
ds_erro_w		ptu_processo_camara_cont.ds_erro%type;
ie_tipo_arquivo_w	ptu_camara_contestacao.ie_tipo_arquivo%type;


BEGIN
-- Ler o arquivo
CALL pls_utl_file_pck.nova_leitura( 27, nm_arquivo_p);
while(ie_leitura_w) loop
	-- Obter linha do arquivo
	SELECT * FROM pls_utl_file_pck.ler( ds_conteudo_w, ie_leitura_w) INTO STRICT  ds_conteudo_w, ie_leitura_w;

	if (ie_leitura_w) then
		begin
		-- Importar arquivo A550
		SELECT * FROM pls_imp_camara_contest_a550( ds_conteudo_w, nm_usuario_p, null, ie_versao_w, nr_seq_referencia_w, cd_estabelecimento_p, nr_seq_camara_contest_p, 'S') INTO STRICT ie_versao_w, nr_seq_referencia_w, nr_seq_camara_contest_p;
		
		if (substr(ds_conteudo_w,9,3) = '551') then -- Obter qual o tipo de arquivo que está sendo importado
			ie_tipo_arquivo_w := (substr(ds_conteudo_w,104,1))::numeric;
		end if;
		
		exception
		when others then
			ds_erro_w := substr(sqlerrm || pls_util_pck.enter_w || 'Error Back Trace: ' || dbms_utility.format_error_backtrace, 1, 4000);
			
			if (coalesce(nr_seq_camara_contest_p::text, '') = '') then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(substr(sqlerrm,1,4000));
			end if;
		end;
	end if;
end loop;
-- Fechar o arquivo
CALL pls_utl_file_pck.fechar_arquivo();

-- Finalizar importação A550
pls_gerar_log_imp_a550( nr_seq_camara_contest_p, 'IA', 'FI', nm_usuario_p, null, clock_timestamp(), ds_erro_w, null, 'S');

-- Somente limpar quando o tipo de arquivo for inclusão
if (ie_tipo_arquivo_w = 1) then
	nr_seq_camara_contest_p := null;
end if;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerencia_imp_a550 ( nm_arquivo_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_camara_contest_p INOUT ptu_camara_contestacao.nr_sequencia%type) FROM PUBLIC;

