-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_acrescentar_juros_multa ( nr_seq_repasse_vend_p bigint, nr_seq_comissao_p bigint, ie_repasse_comiss_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

			 
/* 	ie_repasse_comiss_p 
		RN = repasse normal 
		RM = repasse mensal 
		RE = repasse por equipe 
		CN = comiss達o lote normal 
		CM = comiss達o lote mensal	 
		CE = comiss達o lote por equipe 
*/
 
 
-- Campos do cursor 1 e 3 
nr_titulo_w			titulo_receber.nr_titulo%type;	
 
-- Campos do cursor 2 
vl_mensalidade_w		pls_repasse_mens.vl_mensalidade%type;
pr_comissao_w			pls_repasse_mens.pr_comissao%type;
vl_incremento_w			pls_repasse_mens.vl_incremento%type;

-- Campos do cursor 2 e 7 
nr_seq_repasse_mens_w		pls_repasse_mens.nr_sequencia%type;

-- Campos do cursor 4 
nr_seq_item_comis_w		pls_comissao_benef_item.nr_sequencia%type;
vl_item_mensalidade_w		pls_comissao_benef_item.vl_item_mensalidade%type;
tx_comissao_w			pls_comissao_benef_item.tx_comissao%type;
vl_premio_comis_w		pls_comissao_benef_item.vl_premio%type;
vl_incremento_comis_w		pls_comissao_benef_item.vl_incremento%type;

-- Campos do cursor 6 
nr_seq_item_repas_w		pls_repasse_mens_item.nr_sequencia%type;
vl_item_w			pls_repasse_mens_item.vl_item%type;
pr_repasse_w			pls_repasse_mens_item.pr_repasse%type;
vl_premio_w			pls_repasse_mens_item.vl_premio%type;
vl_incremento_item_w		pls_repasse_mens_item.vl_incremento%type;

-- Outros campos 
vl_mensalidade_total_w		pls_repasse_mens.vl_mensalidade%type;	
pr_lancamento_w			double precision;
vl_juros_multa_w		double precision := 0;
vl_comissao_w			pls_repasse_mens.vl_repasse%type;		
ie_gerar_juro_mult_tit_w	varchar(1);	
	 
C01 CURSOR FOR 
	SELECT	distinct a.nr_titulo 
	from	titulo_receber 			a, 
		pls_mensalidade_segurado 	b, 
		pls_repasse_mens		c 
	where	a.nr_seq_mensalidade	= b.nr_seq_mensalidade 
	and	b.nr_sequencia		= c.nr_seq_mens_seg 
	and	c.nr_seq_repasse 	= nr_seq_repasse_vend_p 
	and  ((ie_repasse_comiss_p = 'RN') or (ie_repasse_comiss_p in ('RM','RE') and c.vl_repasse = 0 and coalesce(c.ds_observacao::text, '') = ''));
	
C02 CURSOR FOR 
	SELECT	c.nr_sequencia nr_seq_repasse_mens, 
		c.vl_mensalidade, 
		c.pr_comissao, 
		c.vl_incremento 
	from	titulo_receber 			a, 
		pls_mensalidade_segurado 	b, 
		pls_repasse_mens		c 
	where	a.nr_seq_mensalidade	= b.nr_seq_mensalidade 
	and	b.nr_sequencia		= c.nr_seq_mens_seg 
	and	c.nr_seq_repasse 	= nr_seq_repasse_vend_p 
	and	a.nr_titulo		= nr_titulo_w 
	and	c.vl_repasse = 0 
	and	coalesce(c.ds_observacao::text, '') = '';
	
C03 CURSOR FOR 
	SELECT	distinct a.nr_titulo 
	from	titulo_receber 			a, 
		pls_mensalidade_segurado 	b, 
		pls_comissao_beneficiario	c, 
		pls_comissao_benef_item		d 
	where	a.nr_seq_mensalidade	= b.nr_seq_mensalidade 
	and	b.nr_sequencia		= c.nr_seq_segurado_mens 
	and	c.nr_sequencia		= d.nr_seq_comissao_benef 
	and	c.nr_seq_comissao	= nr_seq_comissao_p 
	and 	d.vl_comissao = 0;
		
C04 CURSOR FOR 
	SELECT	d.nr_sequencia nr_seq_item_comis, 
		d.vl_item_mensalidade, 
		d.tx_comissao, 
		d.vl_premio, 
		d.vl_incremento 
	from	titulo_receber 			a, 
		pls_mensalidade_segurado 	b, 
		pls_comissao_beneficiario	c, 
		pls_comissao_benef_item		d 
	where	a.nr_seq_mensalidade	= b.nr_seq_mensalidade 
	and	b.nr_sequencia		= c.nr_seq_segurado_mens 
	and	c.nr_sequencia		= d.nr_seq_comissao_benef 
	and	c.nr_seq_comissao	= nr_seq_comissao_p 
	and	a.nr_titulo		= nr_titulo_w;

C06 CURSOR FOR 
	SELECT	d.nr_sequencia nr_seq_item_repas, 
		d.vl_item, 
		d.pr_repasse, 
		d.vl_premio, 
		coalesce(d.vl_incremento,0) 
	from	titulo_receber 			a, 
		pls_mensalidade_segurado 	b, 
		pls_repasse_mens		c, 
		pls_repasse_mens_item		d 
	where	a.nr_seq_mensalidade	= b.nr_seq_mensalidade 
	and	b.nr_sequencia		= c.nr_seq_mens_seg 
	and	c.nr_sequencia		= d.nr_seq_repasse 
	and	c.nr_seq_repasse 	= nr_seq_repasse_vend_p 
	and	a.nr_titulo		= nr_titulo_w 
	and  ((ie_repasse_comiss_p = 'RN') or (ie_repasse_comiss_p = 'RE' and d.vl_repasse = 0));
	
C07 CURSOR FOR 
	SELECT	c.nr_sequencia nr_seq_repasse_mens 
	from	titulo_receber 			a, 
		pls_mensalidade_segurado 	b, 
		pls_repasse_mens		c 
	where	a.nr_seq_mensalidade	= b.nr_seq_mensalidade 
	and	b.nr_sequencia		= c.nr_seq_mens_seg 
	and	c.nr_seq_repasse 	= nr_seq_repasse_vend_p 
	and	a.nr_titulo		= nr_titulo_w;


BEGIN 
 
if (ie_repasse_comiss_p = 'RN') then -- Repasse normal 
	ie_gerar_juro_mult_tit_w := pls_obter_se_gera_juro_mult(cd_estabelecimento_p);
	 
	if (ie_gerar_juro_mult_tit_w = 'S') then 
		open C01;
		loop 
		fetch C01 into	 
			nr_titulo_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin				 
			vl_juros_multa_w := pls_obter_vl_juros_mult_titulo(nr_titulo_w);
			 
			if (vl_juros_multa_w > 0) then 
				CALL pls_gerar_lanc_comissoes(nr_titulo_w, nr_seq_repasse_vend_p, null, nm_usuario_p, cd_estabelecimento_p);
			 
				select	sum(vl_item_comissao) 
				into STRICT	vl_mensalidade_total_w 
				from	pls_repasse_mens 
				where	nr_seq_repasse = nr_seq_repasse_vend_p 
				and	pls_obter_titulo_mensalidade(null,nr_seq_mens_seg) = nr_titulo_w;	
				 
				open C06;
				loop 
				fetch C06 into	 
					nr_seq_item_repas_w,	 
					vl_item_w,			 
					pr_repasse_w, 
					vl_premio_w, 
					vl_incremento_item_w;
				EXIT WHEN NOT FOUND; /* apply on C06 */
					begin 
					 
					pr_lancamento_w := vl_item_w / vl_mensalidade_total_w;	
				 
					vl_item_w := vl_item_w + (vl_juros_multa_w * pr_lancamento_w);
																 
					vl_comissao_w := round(((vl_item_w * pr_repasse_w) / 100) + vl_premio_w + vl_incremento_item_w,2);	
 
					update	pls_repasse_mens_item 
					set	vl_repasse = vl_comissao_w 
					where	nr_sequencia = nr_seq_item_repas_w;						
					end;
				end loop;
				close C06;	
				 
				open C07;
				loop 
				fetch C07 into	 
					nr_seq_repasse_mens_w;
				EXIT WHEN NOT FOUND; /* apply on C07 */
					begin						 
					select	sum(vl_repasse) 
					into STRICT	vl_comissao_w 
					from	pls_repasse_mens_item 
					where	nr_seq_repasse = nr_seq_repasse_mens_w;
				 
					update	pls_repasse_mens 
					set	vl_repasse = vl_comissao_w 
					where	nr_sequencia = nr_seq_repasse_mens_w;						
					end;
				end loop;
				close C07;								
			end if;
			end;
		end loop;
		close C01;
	end if;
elsif (ie_repasse_comiss_p = 'RM') then -- Repasse mensal	 
	open C01;
	loop 
	fetch C01 into	 
		nr_titulo_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		CALL pls_gerar_lanc_comissoes(nr_titulo_w, nr_seq_repasse_vend_p, null, nm_usuario_p, cd_estabelecimento_p);
 
		select	sum(vl_mensalidade) 
		into STRICT	vl_mensalidade_total_w 
		from	pls_repasse_mens 
		where	nr_seq_repasse = nr_seq_repasse_vend_p 
		and	pls_obter_titulo_mensalidade(null,nr_seq_mens_seg) = nr_titulo_w;
		 
		vl_juros_multa_w := pls_obter_vl_juros_mult_titulo(nr_titulo_w);
 
		open C02;
		loop 
		fetch C02 into	 
			nr_seq_repasse_mens_w, 
			vl_mensalidade_w, 
			pr_comissao_w, 
			vl_incremento_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin	 
			 
			pr_lancamento_w := vl_mensalidade_w / vl_mensalidade_total_w;			
						 
			vl_mensalidade_w := vl_mensalidade_w + (vl_juros_multa_w * pr_lancamento_w);
											 
			vl_comissao_w := round(((vl_mensalidade_w * pr_comissao_w) / 100) + vl_incremento_w,2);	
 
			update	pls_repasse_mens 
			set	vl_repasse = vl_comissao_w 
			where	nr_sequencia = nr_seq_repasse_mens_w;				
			end;
		end loop;
		close C02;			
		end;
	end loop;
	close C01;
elsif (ie_repasse_comiss_p = 'RE') then -- Repasse por equipe 
	open C01;
	loop 
	fetch C01 into	 
		nr_titulo_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin	 
		 
		CALL pls_gerar_lanc_comissoes(nr_titulo_w, nr_seq_repasse_vend_p, null, nm_usuario_p, cd_estabelecimento_p);
		 
		select	sum(vl_item) 
		into STRICT	vl_mensalidade_total_w 
		from	pls_repasse_mens	a, 
			pls_repasse_mens_item	b 
		where	a.nr_sequencia = b.nr_seq_repasse 
		and	a.nr_seq_repasse = nr_seq_repasse_vend_p 
		and	pls_obter_titulo_mensalidade(null,a.nr_seq_mens_seg) = nr_titulo_w;
				 
		vl_juros_multa_w := pls_obter_vl_juros_mult_titulo(nr_titulo_w);
		 
		open C06;
		loop 
		fetch C06 into	 
			nr_seq_item_repas_w,	 
			vl_item_w,			 
			pr_repasse_w, 
			vl_premio_w, 
			vl_incremento_item_w;
		EXIT WHEN NOT FOUND; /* apply on C06 */
			begin	 
			 
			pr_lancamento_w := vl_item_w / vl_mensalidade_total_w;	
			 
			vl_item_w := vl_item_w + (vl_juros_multa_w * pr_lancamento_w);
																		 
			vl_comissao_w := round(((vl_item_w * pr_repasse_w) / 100) + vl_incremento_item_w,2);	
			 
			update	pls_repasse_mens_item 
			set	vl_repasse = vl_comissao_w 
			where	nr_sequencia = nr_seq_item_repas_w;						
			end;
		end loop;
		close C06;
		end;
	end loop;
	close C01;
elsif (ie_repasse_comiss_p in ('CN','CM','CE')) then -- Comiss達o lote normal, mensal ou por equipe	 
	open C03;
	loop 
	fetch C03 into	 
		nr_titulo_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin 
		CALL pls_gerar_lanc_comissoes(nr_titulo_w, null, nr_seq_comissao_p, nm_usuario_p, cd_estabelecimento_p);
		 
		select	sum(vl_item_mensalidade) 
		into STRICT	vl_mensalidade_total_w 
		from	pls_comissao_benef_item		b, 
			pls_comissao_beneficiario	a 
		where	a.nr_sequencia 		= b.nr_seq_comissao_benef 
		and	a.nr_seq_comissao 	= nr_seq_comissao_p 
		and	pls_obter_titulo_mensalidade(null,nr_seq_segurado_mens) = nr_titulo_w;
			 
		vl_juros_multa_w := pls_obter_vl_juros_mult_titulo(nr_titulo_w);
		 
		open C04;
		loop 
		fetch C04 into	 
			nr_seq_item_comis_w, 
			vl_item_mensalidade_w, 
			tx_comissao_w, 
			vl_premio_comis_w, 
			vl_incremento_comis_w;
		EXIT WHEN NOT FOUND; /* apply on C04 */
			begin			 
			 
			pr_lancamento_w := vl_item_mensalidade_w / vl_mensalidade_total_w;			
						 
			vl_item_mensalidade_w := vl_item_mensalidade_w + (vl_juros_multa_w * pr_lancamento_w);
			 
			if (ie_repasse_comiss_p = 'CN') then 
				vl_comissao_w := round(((vl_item_mensalidade_w * tx_comissao_w) / 100) + vl_premio_comis_w + vl_incremento_comis_w,2);	
			elsif (ie_repasse_comiss_p = 'CM') then 
				vl_comissao_w := round(((vl_item_mensalidade_w * tx_comissao_w) / 100),2);	
			else	-- if(ie_repasse_comiss_p = 'CE') then 
				vl_comissao_w := round(((vl_item_mensalidade_w * tx_comissao_w) / 100) + vl_incremento_comis_w,2);	
			end if;		
			 
			update	pls_comissao_benef_item 
			set	vl_comissao = vl_comissao_w 
			where	nr_sequencia = nr_seq_item_comis_w;				
			end;
		end loop;
		close C04;			
		end;
	end loop;
	close C03;	
end if;
	 
--commit; 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_acrescentar_juros_multa ( nr_seq_repasse_vend_p bigint, nr_seq_comissao_p bigint, ie_repasse_comiss_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

