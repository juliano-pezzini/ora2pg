-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_mat_adic_barras ( nr_prescricao_p bigint, nr_seq_lote_fornec_p bigint, cd_material_p bigint, cd_local_estoque_p bigint, qt_material_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_status_cirurgia_p text, nr_doc_interno_p bigint, cd_kit_material_p bigint, nr_doc_interno_aux_p bigint, ie_tipo_doc_interno_p text, ie_tipo_doc_interno_aux_p text, cd_material_kit_p bigint default null, ie_disp_pepo_p text default 'N', nr_seq_regra_pepo_p bigint default null) AS $body$
DECLARE



ie_consiste_estoque_w		varchar(1) := 'N';	/* parametro [19] */
var_cd_intervalo_w			varchar(10);
ie_material_estoque_w		varchar(1);
ie_estoque_disp_w			varchar(1);
ds_material_w			varchar(255);
nr_sequencia_w			integer;
cd_pessoa_usuario_w		varchar(10);
ie_tipo_pessoa_w			smallint;
hr_prim_horario_w			varchar(5);
nr_agrupamento_w			double precision;
cd_unidade_medida_consumo_w	varchar(30);
ie_via_aplicacao_w			varchar(5);
ie_tipo_material_w			varchar(3);
ie_consignado_w			varchar(05);
cd_cgc_fornec_w			varchar(15);
nr_atendimento_w			bigint;
ds_observacao_w			varchar(2000);
qt_material_w			double precision;
qt_total_dispensar_w		double precision;
ie_regra_disp_w			varchar(1);
ds_erro_w			varchar(2000);
ie_baixa_estoque_cir_w		varchar(1):=null;
cd_tipo_baixa_w			smallint;
nr_cirurgia_w			bigint;
ie_grava_local_estoque_w		varchar(1);
ie_tipo_saldo_w			varchar(3);
ie_possui_kit_w			varchar(1) := 'N';
ds_observacao_mat_plano_w	varchar(255);
ie_grava_nf_entrada_w		varchar(15);


BEGIN

if (coalesce(cd_material_kit_p,0) > 0) then
	select 	CASE WHEN coalesce(max(cd_kit_material)::text, '') = '' THEN 'N'  ELSE 'S' END
	into STRICT	ie_possui_kit_w
	from   	material_estab  
        where  	cd_material = cd_material_kit_p;
end if;	

ie_grava_local_estoque_w := obter_param_usuario(900, 371, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_grava_local_estoque_w);
ie_grava_nf_entrada_w := obter_param_usuario(900, 544, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_grava_nf_entrada_w);

if (nr_prescricao_p > 0) then
	begin
	select	coalesce(max(nr_cirurgia),0)
	into STRICT	nr_cirurgia_w
	from	cirurgia
	where	nr_prescricao = nr_prescricao_p;
	
	select	coalesce(obter_se_mat_baixa_estoque_cir(cd_material_p,cd_local_estoque_p,nr_cirurgia_w,coalesce(cd_kit_material_p,0),0,0),0)
	into STRICT	cd_tipo_baixa_w
	;

	if (cd_tipo_baixa_w > 0) then
		ie_baixa_estoque_cir_w := 'N';
	end if;	
	end;
end if;


if (nr_prescricao_p > 0) and (cd_material_p > 0) then

	select	max(ie_consignado)
	into STRICT	ie_consignado_w
	from	material
	where	cd_material	= cd_material_p;

	select	coalesce(max(cd_cgc_fornec), '0')
	into STRICT	cd_cgc_fornec_w
	from	material_lote_fornec
	where	nr_sequencia		= nr_seq_lote_fornec_p;


	select	max(cd_intervalo)
	into STRICT	var_cd_intervalo_w
	from	intervalo_prescricao
	where	ie_agora = 'S'
	and 	qt_operacao = 1
	and 	coalesce(ie_situacao, 'A') = 'A';
	
	if (coalesce(var_cd_intervalo_w::text, '') = '') then
		select	coalesce(max(cd_intervalo),1)
		into STRICT	var_cd_intervalo_w
		from	intervalo_prescricao
		where	ie_agora = 'S';
	end if;

	select	substr(obter_desc_material(cd_material_p),1,255)
	into STRICT	ds_material_w
	;

	select	obter_pessoa_fisica_usuario(nm_usuario_p,'C')
	into STRICT	cd_pessoa_usuario_w
	;

	select	obter_tipo_pessoa(cd_pessoa_usuario_w)
	into STRICT	ie_tipo_pessoa_w
	;

	if (ie_consiste_estoque_w = 'S') then
		
		/* retirado por fabio, pois deve ser o local dependendo do parametro da funcao
		select	obter_setor_usuario(nm_usuario_p)
		into	cd_setor_usuario_w
		from	dual;

		select	cd_local_estoque
		into	cd_local_estoque_w
		from	setor_atendimento
		where	cd_setor_atendimento	=	cd_setor_usuario_w;	*/
		select	obter_se_material_estoque(cd_estabelecimento_p,0,cd_material_p)
		into STRICT	ie_material_estoque_w
		;
		
		if (ie_material_estoque_w = 'S') then
			ie_estoque_disp_w := obter_disp_estoque(cd_material_p, cd_local_estoque_p, cd_estabelecimento_p, 0, qt_material_p, null, ie_estoque_disp_w);

			if (ie_estoque_disp_w = 'N') then
				CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(186030,'DS_MATERIAL_W='||to_char(DS_MATERIAL_W));
			end if;

		end if;
		
	end if;

	select	coalesce(max(nr_sequencia),0) + 1
	into STRICT	nr_sequencia_w
	from	prescr_material
	where	nr_prescricao	=	nr_prescricao_p;

	select	to_char(dt_primeiro_horario,'hh24:mi')
	into STRICT	hr_prim_horario_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;

	select	coalesce(max(nr_agrupamento),0)  + 1
	into STRICT	nr_agrupamento_w
	from	prescr_material	
	where	nr_prescricao = nr_prescricao_p
	and	coalesce(nr_sequencia_solucao::text, '') = ''; 	

	select	substr(obter_dados_material_estab(cd_material,cd_estabelecimento_p,'UMS'),1,30) cd_unidade_medida_consumo,
		ie_via_aplicacao,
		ie_tipo_material
	into STRICT	cd_unidade_medida_consumo_w,
		ie_via_aplicacao_w,
		ie_tipo_material_w
	from	material
	where	cd_material	= cd_material_p;	

	select	max(nr_atendimento)
	into STRICT	nr_atendimento_w
	from 	prescr_medica
	where	nr_prescricao	= nr_prescricao_p;
	
	select  max(ds_observacao)
	into STRICT	ds_observacao_mat_plano_w
	from    w_dados_mat_cirurgia
	where	nr_prescricao	= nr_prescricao_p
	and	cd_material	= cd_material_p;


	if (ie_consignado_w	<> 0) then
		begin
		ie_tipo_saldo_w := null;
		
		if (ie_consignado_w = 2) then
			SELECT * FROM obter_fornec_consig_ambos(
				cd_estabelecimento_p, cd_material_p, nr_seq_lote_fornec_p, cd_local_estoque_p, ie_tipo_saldo_w, cd_cgc_fornec_w) INTO STRICT ie_tipo_saldo_w, cd_cgc_fornec_w;
		end if;
		
		if (ie_consignado_w = 1) or (ie_tipo_saldo_w = 'E') then
			SELECT * FROM obter_fornecedor_consignado(
					cd_material_p, pkg_date_utils.start_of(clock_timestamp(), 'MONTH', 0), cd_local_estoque_p, cd_estabelecimento_p, qt_material_p, 'E', nr_atendimento_w, cd_cgc_fornec_w, ds_observacao_w, nr_seq_lote_fornec_p) INTO STRICT cd_cgc_fornec_w, ds_observacao_w;
		end if;		
		end;
	end if;

	qt_material_w := qt_material_p;

	SELECT * FROM obter_quant_dispensar(	cd_estabelecimento_p, cd_material_p, nr_prescricao_p, nr_sequencia_w, var_cd_intervalo_w, ie_via_aplicacao_w, qt_material_p, null, 1, null, coalesce(ie_tipo_pessoa_w,1), cd_unidade_medida_consumo_w, null, qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w, 'N', 'N') INTO STRICT qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w;

	insert into prescr_material(
		nm_usuario,
		dt_atualizacao,
		nr_prescricao,
		nr_sequencia,
		ie_origem_inf,
		ie_medicacao_paciente,
		ie_utiliza_kit,
		ie_urgencia,
		ie_bomba_infusao,
		ie_suspenso,
		ie_se_necessario,
		hr_prim_horario,
		cd_motivo_baixa,
		nr_ocorrencia,
		nr_agrupamento,
		cd_material,
		cd_local_estoque,
		cd_unidade_medida,
		ie_via_aplicacao,
		ie_agrupador,
		qt_material,
		qt_unitaria,
		cd_intervalo,
		qt_dose,
		qt_total_dispensar,
		ie_status_cirurgia,
		nr_seq_lote_fornec,
		cd_fornec_consignado,
		ds_observacao,
		nr_doc_interno,
		ie_baixa_estoque_cir,
		cd_kit_material,
		nr_doc_interno_aux,
		ie_tipo_doc_interno,
		ie_tipo_doc_interno_aux,
		nm_usuario_original,
		ie_nao_requisitado,
		cd_material_kit,
		ie_disp_pepo,
		dt_atualizacao_adic,
		nm_usuario_adic,
		dt_atualizacao_consist,
		nm_usuario_consist,
		nr_seq_regra_pepo,
		nr_seq_nf_entrada)
	values (
		nm_usuario_p,
		clock_timestamp(),
		nr_prescricao_p,
		nr_sequencia_w,
		coalesce(ie_tipo_pessoa_w,1),
		'N',
		'N',
		'N',
		'N',
		'N',
		'N',
		hr_prim_horario_w,
		0,
		1,
		nr_agrupamento_w,
		cd_material_p,
		CASE WHEN ie_grava_local_estoque_w='S' THEN CASE WHEN cd_local_estoque_p=0 THEN null  ELSE cd_local_estoque_p END   ELSE null END , -- os134066, retirado o local de estoque
		cd_unidade_medida_consumo_w,
		ie_via_aplicacao_w,
		CASE WHEN ie_tipo_material_w=2 THEN 1 WHEN ie_tipo_material_w=3 THEN 1 WHEN ie_tipo_material_w=0 THEN 1  ELSE 2 END ,
		qt_material_w,
		qt_material_p,
		var_cd_intervalo_w,
		0,
		qt_total_dispensar_w,
		ie_status_cirurgia_p,
		nr_seq_lote_fornec_p,
		CASE WHEN ie_consignado_w=0 THEN  null  ELSE CASE WHEN cd_cgc_fornec_w='0' THEN  null  ELSE cd_cgc_fornec_w END  END ,
		substr(ds_observacao_w || chr(13) || chr(10) || ds_observacao_mat_plano_w,1,3800),
		CASE WHEN nr_doc_interno_p=0 THEN null  ELSE nr_doc_interno_p END ,
		ie_baixa_estoque_cir_w,
		cd_kit_material_p,
		CASE WHEN nr_doc_interno_aux_p=0 THEN null  ELSE nr_doc_interno_aux_p END ,
		ie_tipo_doc_interno_p,
		ie_tipo_doc_interno_aux_p,
		nm_usuario_p,
		'S',
		CASE WHEN ie_possui_kit_w='S' THEN cd_material_kit_p  ELSE null END ,
		coalesce(ie_disp_pepo_p,'N'),
		CASE WHEN ie_status_cirurgia_p='AD' THEN clock_timestamp()  ELSE null END ,
		CASE WHEN ie_status_cirurgia_p='AD' THEN nm_usuario_p  ELSE null END ,
		CASE WHEN ie_status_cirurgia_p='CB' THEN clock_timestamp()  ELSE null END ,
		CASE WHEN ie_status_cirurgia_p='CB' THEN nm_usuario_p  ELSE null END ,
		CASE WHEN nr_seq_regra_pepo_p=0 THEN null  ELSE nr_seq_regra_pepo_p END ,
		CASE WHEN ie_grava_nf_entrada_w='S' THEN Obter_dados_lote_fornec(nr_seq_lote_fornec_p,'SN')  ELSE null END );
	commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_mat_adic_barras ( nr_prescricao_p bigint, nr_seq_lote_fornec_p bigint, cd_material_p bigint, cd_local_estoque_p bigint, qt_material_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_status_cirurgia_p text, nr_doc_interno_p bigint, cd_kit_material_p bigint, nr_doc_interno_aux_p bigint, ie_tipo_doc_interno_p text, ie_tipo_doc_interno_aux_p text, cd_material_kit_p bigint default null, ie_disp_pepo_p text default 'N', nr_seq_regra_pepo_p bigint default null) FROM PUBLIC;

