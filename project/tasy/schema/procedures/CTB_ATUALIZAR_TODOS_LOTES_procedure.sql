-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_atualizar_todos_lotes ( nr_seq_mes_ref_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE


dt_abertura_w				timestamp;
dt_fechamento_w				timestamp;
nr_lote_contabil_w				bigint;
dt_consistencia_w				timestamp;
ds_erro_w				varchar(2000);
ds_lotes_w				varchar(2000);

C01 CURSOR FOR
SELECT	nr_lote_contabil,
	dt_consistencia
from	lote_contabil
where	nr_seq_mes_ref		= nr_seq_mes_ref_p
and	cd_estabelecimento		= cd_estabelecimento_p
and	coalesce(dt_atualizacao_saldo::text, '') = '';


BEGIN

select dt_abertura,
	dt_fechamento
into STRICT 	dt_abertura_w,
	dt_fechamento_w
from	ctb_mes_ref
where	nr_sequencia	= nr_seq_mes_ref_p;

if (coalesce(dt_abertura_w::text, '') = '')  then
	--(-20011,'O mês não está aberto');
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(269640);
end if;

if (dt_fechamento_w IS NOT NULL AND dt_fechamento_w::text <> '') then
	--(-20011,'O mês está fechado');
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(269641);
end if;

ds_lotes_w	:= '';

OPEN C01;
LOOP
FETCH C01 into
	nr_lote_contabil_w,
	dt_consistencia_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	ds_erro_w	:= '';
	if (coalesce(dt_consistencia_w::text, '') = '') then
		ds_erro_w := ctb_consistir_lote(nr_lote_contabil_w, ds_erro_w, nm_usuario_p);
		if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
			ds_lotes_w		:= ds_lotes_w || nr_lote_contabil_w || ',';
		else
			dt_consistencia_w	:= clock_timestamp();
		end if;
	end if;
	if (dt_consistencia_w IS NOT NULL AND dt_consistencia_w::text <> '') then
		begin
		ds_erro_w := ctb_atualizar_saldo(nr_lote_contabil_w, 'N', nm_usuario_p, 'N', ds_erro_w, 'S');
		exception
		when others then
			ds_lotes_w	:= ds_lotes_w || nr_lote_contabil_w || ',';
		end;
	end if;
END LOOP;
CLOSE C01;

CALL ctb_atualizar_dt_processo(	cd_estabelecimento_p, nr_seq_mes_ref_p, null, nm_usuario_p, null);

ds_erro_w := CTB_Acumular_Saldo(nr_seq_mes_ref_p, cd_estabelecimento_p, nm_usuario_p, ds_erro_w);

ds_erro_p := '';
if (ds_lotes_w IS NOT NULL AND ds_lotes_w::text <> '') then
	ds_erro_p		:= substr(ds_lotes_w || chr(10) || chr(13) || ds_erro_w, 1, 254);
end if;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_atualizar_todos_lotes ( nr_seq_mes_ref_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

