-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_duplicar_estrutura_tributo ( nr_seq_estrut_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_estrut_novo_w	fis_estrutura_calculo.nr_sequencia%type;

C01 CURSOR FOR
SELECT	a.ds_item,
	a.ds_observacao,
	a.ds_origem,
	a.ie_base_calculo,
	a.ie_gerar_conta,
	a.ie_origem_valor,
	a.ie_resultado,
	a.nr_seq_apres,
	a.nr_seq_somat
from	fis_estrutura_item a
where	a.nr_seq_estrutura = nr_seq_estrut_p
order by a.nr_seq_apres, a.nr_seq_somat, a.nr_sequencia;

vet01	c01%RowType;


BEGIN

if (nr_seq_estrut_p IS NOT NULL AND nr_seq_estrut_p::text <> '') then

	select	max(nr_sequencia) + 1
	into STRICT	nr_seq_estrut_novo_w
	from	fis_estrutura_calculo;

	insert into fis_estrutura_calculo(
		nr_sequencia,
		cd_empresa,
		cd_tributo,
		ds_titulo,
		dt_atualizacao,
		dt_atualizacao_nrec,
		dt_fim_vigencia,
		dt_inicio_vigencia,
		nm_usuario,
		nm_usuario_nrec,
		ie_lalur_lacs,
		ie_forma_apuracao,
		ie_parte_livro)
	(SELECT	nr_seq_estrut_novo_w,
		a.cd_empresa,
		a.cd_tributo,
		substr(a.ds_titulo || ' - CÃ³pia',1,255),
		clock_timestamp(),
		clock_timestamp(),
		a.dt_fim_vigencia,
		a.dt_inicio_vigencia,
		nm_usuario_p,
		nm_usuario_p,
		a.ie_lalur_lacs,
		a.ie_forma_apuracao,
		a.ie_parte_livro
	from	fis_estrutura_calculo a
	where	nr_sequencia = nr_seq_estrut_p);


	open C01;
	loop
	fetch C01 into
		vet01;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		insert into fis_estrutura_item(
			nr_sequencia,
			nr_seq_estrutura,
			ds_item,
			ds_observacao,
			ds_origem,
			dt_atualizacao,
			dt_atualizacao_nrec,
			ie_base_calculo,
			ie_gerar_conta,
			ie_origem_valor,
			ie_resultado,
			nm_usuario,
			nm_usuario_nrec,
			nr_seq_apres,
			nr_seq_somat)
		values (	nextval('fis_estrutura_item_seq'),
			nr_seq_estrut_novo_w,
			vet01.ds_item,
			vet01.ds_observacao,
			vet01.ds_origem,
			clock_timestamp(),
			clock_timestamp(),
			vet01.ie_base_calculo,
			vet01.ie_gerar_conta,
			vet01.ie_origem_valor,
			vet01.ie_resultado,
			nm_usuario_p,
			nm_usuario_p,
			vet01.nr_seq_apres,
			vet01.nr_seq_somat);
		end;
	end loop;
	close C01;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_duplicar_estrutura_tributo ( nr_seq_estrut_p bigint, nm_usuario_p text) FROM PUBLIC;

