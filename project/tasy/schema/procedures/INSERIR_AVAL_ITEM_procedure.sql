-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_aval_item ( nr_seq_avaliacao_p bigint, nr_seq_item_p bigint, nr_seq_result_p bigint, nm_usuario_p text) AS $body$
DECLARE

ie_insere_w		varchar(1);
nr_sequencia_w		bigint;
qt_result_w		bigint;

BEGIN

select	CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END ,
	nr_sequencia
into STRICT	ie_insere_w,
	nr_sequencia_w
from 	srpa_aval_item
where 	nr_seq_avaliacao 	= nr_seq_avaliacao_p
and	nr_seq_item			= nr_seq_item_p
group by  nr_sequencia;

select	obter_peso_result_item(nr_seq_result_p)
into STRICT	qt_result_w
;

if (ie_insere_w = 'S') then
	begin
	select	nextval('srpa_aval_item_seq')
	into STRICT	nr_sequencia_w
	;

	insert	into srpa_aval_item(nr_sequencia,
			nr_seq_avaliacao,
			nr_seq_item,
			dt_atualizacao,
			nm_usuario,
			nr_seq_result,
			qt_result,
			dt_atualizacao_nrec,
			nm_usuario_nrec)
	values (nr_sequencia_w,
			nr_seq_avaliacao_p,
			nr_seq_item_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_result_p,
			qt_result_w,
			clock_timestamp(),
			nm_usuario_p);
	end;
else
	begin
	update	srpa_aval_item
	set		nr_seq_result 	= nr_seq_result_p,
			qt_result		= qt_result_w,
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p
	where	nr_seq_avaliacao 		= nr_seq_avaliacao_p
	and		nr_seq_item	= nr_seq_item_p;
	end;
end if;

select	sum(qt_result)
into STRICT	qt_result_w
from	srpa_aval_item
where	nr_seq_avaliacao = nr_seq_avaliacao_p;

update	atend_aval_srpa
set		qt_pontuacao = qt_result_w
where	nr_sequencia = nr_seq_avaliacao_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_aval_item ( nr_seq_avaliacao_p bigint, nr_seq_item_p bigint, nr_seq_result_p bigint, nm_usuario_p text) FROM PUBLIC;

