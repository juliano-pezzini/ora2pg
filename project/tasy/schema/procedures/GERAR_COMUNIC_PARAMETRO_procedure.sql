-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_comunic_parametro ( cd_funcao_p bigint, nr_seq_parametro_p bigint, ie_tipo_alteracao_p text, vl_parametro_p text, cd_estab_ref_p text, cd_perfil_p text, nm_usuario_ref_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_tipo_envio_p text) AS $body$
DECLARE


ds_comunicado_w		varchar(4000)	:= null;
ds_usuarios_destino_w	varchar(4000)	:= null;
ds_perfis_destino_w	varchar(4000)	:= null;
ds_usuario_email_w	varchar(4000)	:= null;
ds_lista_emails_w	varchar(4000)	:= null;

ds_parametro_w		varchar(255);
vl_anterior_w		varchar(255);
vl_novo_w		varchar(255);
ds_titulo_w		varchar(255);
ds_usuario_alter_w	varchar(255);
nr_seq_classif_w	bigint;
tam_lista_w		bigint;
ie_pos_virgula_w	smallint	:= 0;
nm_usuario_w		varchar(15);
ds_email_destino_w	varchar(4000);
i  bigint;


BEGIN
if (nr_seq_parametro_p IS NOT NULL AND nr_seq_parametro_p::text <> '') then
	ds_usuarios_destino_w	:= obter_valor_param_usuario(6001,36,null,nm_usuario_p,cd_estabelecimento_p);
	ds_perfis_destino_w	:= obter_valor_param_usuario(6001,37,null,nm_usuario_p,cd_estabelecimento_p);
	ds_usuario_email_w	:= obter_valor_param_usuario(6001,155,null,nm_usuario_p,cd_estabelecimento_p);

	if (coalesce(somente_numero(obter_valor_param_usuario(6001,38,null,nm_usuario_p,cd_estabelecimento_p)),0) <> 0) then
		nr_seq_classif_w	:= somente_numero(obter_valor_param_usuario(6001,38,null,nm_usuario_p,cd_estabelecimento_p));
	end if;

	select	max(obter_desc_expressao(cd_exp_parametro, ds_parametro))
	into STRICT	ds_parametro_w
	from	funcao_parametro
	where	cd_funcao	= cd_funcao_p
	and	nr_sequencia	= nr_seq_parametro_p;

	if (ie_tipo_alteracao_p = 'A') then
		ds_titulo_w	:= wheb_mensagem_pck.get_texto(348087);
		--ds_titulo_w	:= 'Alteração de parâmetro do sistema';
		ds_comunicado_w	:= wheb_mensagem_pck.get_texto(348088,	'NR_SEQ_PARAMETRO=' || nr_seq_parametro_p || ';DS_PARAMETRO=' || ds_parametro_w) || chr(13);
		--ds_comunicado_w	:=	'Alterado o parâmetro [' || nr_seq_parametro_p || '] - ' || ds_parametro_w  || chr(13);
	elsif (ie_tipo_alteracao_p = 'E') then
		ds_titulo_w	:= wheb_mensagem_pck.get_texto(348089);
		--ds_titulo_w	:= 'Exclusão de parâmetro do sistema';
		ds_comunicado_w	:= wheb_mensagem_pck.get_texto(348090,	'NR_SEQ_PARAMETRO=' || nr_seq_parametro_p || ';DS_PARAMETRO=' || ds_parametro_w) || chr(13);
		--ds_comunicado_w	:=	'Excluído o parâmetro [' || nr_seq_parametro_p || '] - ' || ds_parametro_w  || chr(13);
	end if;

	if (nm_usuario_ref_p IS NOT NULL AND nm_usuario_ref_p::text <> '') then
		select	max(substr(obter_nome_usuario(nm_usuario_ref_p),1,255))
		into STRICT	ds_usuario_alter_w
		;
	end if;

	if (ie_tipo_envio_p = '1') then
		select	max(vl_parametro)
		into STRICT	vl_anterior_w
		from	funcao_param_usuario
		where	cd_funcao	= cd_funcao_p
		and	nr_sequencia	= nr_seq_parametro_p
		and	upper(nm_usuario_param)	= upper(nm_usuario_ref_p);
	elsif (ie_tipo_envio_p = '2')  then
		select	max(vl_parametro)
		into STRICT	vl_anterior_w
		from	funcao_param_perfil
		where	cd_funcao	= cd_funcao_p
		and	nr_sequencia	= nr_seq_parametro_p
		and	cd_perfil	= cd_perfil_p;
	elsif (ie_tipo_envio_p = '3') then
		select	max(vl_parametro)
		into STRICT	vl_anterior_w
		from	funcao_param_estab
		where	cd_funcao		= cd_funcao_p
		and	nr_seq_param		= nr_seq_parametro_p
		and	cd_estabelecimento	= cd_estab_ref_p;
	else
		select	max(vl_parametro)
		into STRICT	vl_anterior_w
		from	funcao_parametro
		where	cd_funcao	= cd_funcao_p
		and	nr_sequencia	= nr_seq_parametro_p;
		commit;

	end if;

	ds_comunicado_w	:= wheb_mensagem_pck.get_texto(348091,	'DS_COMUNICADO=' || ds_comunicado_w ||
								';DS_FUNCAO=' || substr(obter_desc_funcao(cd_funcao_p),1,255) ||
								';DS_DADOS=' || '' ||
								';DS_ESTAB=' || substr(obter_nome_estabelecimento(cd_estab_ref_p),1,255) ||
								';DS_PERFIL=' || substr(obter_desc_perfil(cd_perfil_p),1,255) ||
								';DS_USUARIO=' || ds_usuario_alter_w);

	/*ds_comunicado_w	:=	ds_comunicado_w ||chr(13) || chr(10) ||
				'Função: ' || substr(obter_desc_funcao(cd_funcao_p),1,255) || chr(13) || chr(10) || chr(13) || chr(10) ||
				'Dados da alteração: ' || chr(13) || chr(10) || chr(13) || chr(10) ||
				'Estabelecimento:	' || substr(obter_nome_estabelecimento(cd_estab_ref_p),1,255) || chr(13) || chr(10) ||
				'Perfil: 		' || substr(obter_desc_perfil(cd_perfil_p),1,255) || chr(13) || chr(10) ||
				'Usuário referência:	' || ds_usuario_alter_w || chr(13) || chr(10) || chr(13)|| chr(10);*/
	vl_novo_w	:= vl_parametro_p;

	if (cd_funcao_p = 7002) and (nr_seq_parametro_p = 12) then
		vl_anterior_w	:= rpad('*',LENGTH(vl_anterior_w),'*');
		vl_novo_w	:= rpad('*',LENGTH(vl_novo_w),'*');
	else
		vl_anterior_w	:= substr(obter_desc_param_senha(cd_funcao_p,nr_seq_parametro_p,vl_anterior_w),1,255);
		vl_novo_w	:= substr(obter_desc_param_senha(cd_funcao_p,nr_seq_parametro_p,vl_novo_w),1,255);
	end if;

	if (ie_tipo_alteracao_p = 'A') then
		ds_comunicado_w	:= wheb_mensagem_pck.get_texto(348092,	'DS_COMUNICADO=' || ds_comunicado_w ||
									';VL_ANTERIOR=' || vl_anterior_w||
									';VL_ATUAL=' || vl_novo_w);

		/*ds_comunicado_w	:= ds_comunicado_w ||
				'Valor anterior:	' || vl_anterior_w || chr(13) || chr(10) ||
				'Valor atual:	' || vl_novo_w || chr(13)|| chr(10);*/
	end if;

	ds_comunicado_w	:= wheb_mensagem_pck.get_texto(348093,	'DS_COMUNICADO=' || ds_comunicado_w ||
									';DS_USUARIO=' || substr(obter_nome_usuario(nm_usuario_p),1,255));
	/*ds_comunicado_w	:= 	ds_comunicado_w ||
				'Usuário alteração:	' || substr(obter_nome_usuario(nm_usuario_p),1,255); */
end if;

if (ds_comunicado_w IS NOT NULL AND ds_comunicado_w::text <> '') then
	CALL gerar_comunic_padrao(	clock_timestamp(),
				ds_titulo_w,
				ds_comunicado_w,
				nm_usuario_p,
				'N',
				ds_usuarios_destino_w,
				'N',
				nr_seq_classif_w,
				ds_perfis_destino_w,
				null,
				null,
				clock_timestamp(),
				null,
				null);

	if (ds_usuario_email_w IS NOT NULL AND ds_usuario_email_w::text <> '') then
		begin
		ds_lista_emails_w := substr(ds_usuario_email_w,1, length(ds_usuario_email_w));
		WHILE(ds_lista_emails_w IS NOT NULL AND ds_lista_emails_w::text <> '') LOOP
			begin
			tam_lista_w	:= length( ds_lista_emails_w );
			ie_pos_virgula_w 	:= position(',' in ds_lista_emails_w );

			if (ie_pos_virgula_w <> 0) then
				nm_usuario_w	:= substr(ds_lista_emails_w,1,(ie_pos_virgula_w - 1));
				ds_lista_emails_w	:= substr(ds_lista_emails_w,(ie_pos_virgula_w + 1),tam_lista_w);
			else
				nm_usuario_w	:= ds_lista_emails_w;
				ds_lista_emails_w 	:= null;
			end if;

			select  obter_dados_usuario_opcao(nm_usuario_w,'E') ds_email_pf
			into STRICT	ds_email_destino_w
			;

			CALL enviar_email(	ds_titulo_w,
					ds_comunicado_w,
					null,
					ds_email_destino_w,
					nm_usuario_p,
					'A');
			end;
		END loop;
		end;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_comunic_parametro ( cd_funcao_p bigint, nr_seq_parametro_p bigint, ie_tipo_alteracao_p text, vl_parametro_p text, cd_estab_ref_p text, cd_perfil_p text, nm_usuario_ref_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_tipo_envio_p text) FROM PUBLIC;

