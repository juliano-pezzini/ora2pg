-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_contabiliza_baixa_antec ( nr_lote_contabil_p bigint, nm_usuario_p text) AS $body$
DECLARE

						 
cd_estabelecimento_w	smallint;

nr_titulo_w		bigint;
vl_transacao_w		double precision;
nr_seq_trans_fin_w	bigint;
dt_movimento_w		timestamp;
nr_seq_conta_banco_w	bigint;
nm_atributo_w		varchar(255);
cd_centro_custo_w	integer;
dt_contabil_tit_w	timestamp;
cd_conta_contabil_w	varchar(20);
nr_seq_retorno_w	bigint;
nr_seq_ret_item_w	bigint;
cd_conta_deb_pls_w	varchar(20);
cd_conta_rec_pls_w	varchar(20);
cd_historico_pls_w	bigint;
NR_SEQ_MOVTO_TRANS_FIN_w	bigint;
ds_observacao_titulo_w		varchar(4000);
DS_COMPROVANTE_w		varchar(255);
NR_AUTORIZACAO_w		varchar(255);
nr_seq_produto_w		bigint;
ds_observacao_liq_w		varchar(255);
ie_acao_w			varchar(15);
nr_adiantamento_w		bigint;
nr_seq_movto_cartao_cr_w	bigint;
nr_sequencia_w			bigint;
ie_compl_hist_w			varchar(3);
ds_erro_w			varchar(2000);
ds_conteudo_w			varchar(4000);
cd_tipo_lote_contabil_w		bigint;
ds_compl_historico_w		varchar(4000);
cd_pessoa_fisica_w		varchar(10);
cd_cgc_w			varchar(14);
dt_contabil_w			timestamp;

nr_documento_w			numeric(22);
nr_interno_conta_w		bigint;
nr_seq_protocolo_w		bigint;
ds_devedor_w			varchar(80);
nr_nota_fiscal_w		varchar(255);
nr_doc_titulo_w			numeric(22);
nr_nota_protocolo_w		varchar(255);
nr_nota_conta_w			varchar(255);
nr_nfe_imp_w			varchar(255);			
ds_devedor_pj_w			varchar(80);

cd_convenio_w			integer;
nr_atendimento_w		bigint;
ds_mesano_referencia_prot_w	varchar(20);
ds_mesano_referencia_abrev_w	varchar(20);
ds_obs_convenio_receb_w		varchar(255);
ds_convenio_w			varchar(255);
dt_mesano_referencia_prot_w	timestamp;
ds_bandeira_cartao_w		varchar(255);
ds_pessoa_rec_cartao_w		varchar(80);
ds_comprovante_cartao_w		varchar(100);

c01 CURSOR FOR 
SELECT	a.nr_titulo, 
	CASE WHEN a.ie_acao='I' THEN  x.vl_recebido  ELSE x.vl_recebido * -1 END , 
	a.nr_seq_trans_fin, 
	a.dt_recebimento, 
	a.nr_seq_conta_banco, 
	'VL_REC_PLS', 
	x.cd_centro_custo, 
	a.dt_recebimento, 
	'' cd_conta_contabil, 
	a.nr_seq_retorno, 
	a.nr_seq_ret_item, 
	x.cd_conta_deb_pls, 
	x.cd_conta_rec_pls, 
	x.cd_historico_pls, 
	a.NR_SEQ_MOVTO_TRANS_FIN, 
	b.ds_observacao_titulo, 
	'' DS_COMPROVANTE, 
	'' NR_AUTORIZACAO, 
	x.nr_seq_produto, 
	a.ds_observacao, 
	a.ie_acao, 
	a.nr_adiantamento, 
	null nr_seq_movto_cartao_cr 
from 	Titulo_rec_liq_cc x, 
	titulo_receber b, 
	titulo_receber_liq a 
where 	a.nr_lote_contab_antecip	= nr_lote_contabil_p 
and	a.vl_recebido 		<> 0 
and	a.nr_titulo		= b.nr_titulo 
and	a.nr_titulo		= x.nr_titulo 
and	a.nr_sequencia		= x.nr_seq_baixa 
and	b.cd_estabelecimento	= cd_estabelecimento_w 
and	coalesce(ie_lib_caixa, 'S') 	= 'S' 
and	(b.nr_seq_mensalidade IS NOT NULL AND b.nr_seq_mensalidade::text <> '') 
and	(x.vl_antecipacao_mens IS NOT NULL AND x.vl_antecipacao_mens::text <> '');


BEGIN 
 
if (nr_lote_contabil_p IS NOT NULL AND nr_lote_contabil_p::text <> '') then 
	select	cd_estabelecimento, 
		obter_se_compl_tipo_lote(cd_estabelecimento, cd_tipo_lote_contabil), 
		cd_tipo_lote_contabil, 
		dt_referencia 
	into STRICT	cd_estabelecimento_w, 
		ie_compl_hist_w, 
		cd_tipo_lote_contabil_w, 
		dt_contabil_w 
	from	lote_contabil a 
	where	a.nr_lote_contabil	= nr_lote_contabil_p;
 
	open c01;
	loop 
	fetch c01 into	 
		nr_titulo_w, 
		vl_transacao_w, 
		nr_seq_trans_fin_w, 
		dt_movimento_w, 
		nr_seq_conta_banco_w, 
		nm_atributo_w, 
		cd_centro_custo_w, 
		dt_contabil_tit_w, 
		cd_conta_contabil_w, 
		nr_seq_retorno_w, 
		nr_seq_ret_item_w, 
		cd_conta_deb_pls_w, 
		cd_conta_rec_pls_w, 
		cd_historico_pls_w, 
		NR_SEQ_MOVTO_TRANS_FIN_w, 
		ds_observacao_titulo_w, 
		DS_COMPROVANTE_w, 
		NR_AUTORIZACAO_w, 
		nr_seq_produto_w, 
		ds_observacao_liq_w, 
		ie_acao_w, 
		nr_adiantamento_w, 
		nr_seq_movto_cartao_cr_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin 
		 
		ds_conteudo_w	:= '';
		if (ie_compl_hist_w = 'S') then 
			select max(a.cd_cgc), 
				max(coalesce(a.nr_documento,0)), 
				max(nr_interno_conta), 
				max(nr_seq_protocolo), 
				max(substr(obter_nome_pf_pj(cd_pessoa_fisica, cd_cgc),1,80)), 
				max(somente_numero(a.nr_nota_fiscal)), 
				max(a.nr_documento), 
				max(substr(OBTER_NOTA_CONTA_PROTOCOLO(a.nr_seq_protocolo,0),1,20)), 
				max(substr(OBTER_NOTA_CONTA_PROTOCOLO(0,a.nr_interno_conta),1,20)), 
				max(a.cd_pessoa_fisica), 
				max(obter_dados_titulo_receber(a.nr_titulo,'NE')), 
				max(substr(obter_nome_pf_pj(null, cd_cgc),1,80)) 
			into STRICT	cd_cgc_w, 
				nr_documento_w, 
				nr_interno_conta_w, 
				nr_seq_protocolo_w, 
				ds_devedor_w, 
				nr_nota_fiscal_w, 
				nr_doc_titulo_w, 
				nr_nota_protocolo_w, 
				nr_nota_conta_w, 
				cd_pessoa_fisica_w, 
				nr_nfe_imp_w, 
				ds_devedor_pj_w 
			from 	titulo_Receber a 
			where	nr_titulo		= nr_titulo_w;
		 
			ds_conteudo_w	:= substr(	cd_cgc_w			|| '#@' || 
						nr_doc_titulo_w			|| '#@' || 
						nr_interno_conta_w			|| '#@' || 
						nr_seq_protocolo_w		|| '#@' || 
						ds_devedor_w			|| '#@' || 
						nr_nota_fiscal_w			|| '#@' || 
						cd_convenio_w			|| '#@' || 
						nr_atendimento_w			|| '#@' || 
						nr_nota_conta_w			|| '#@' || 
						nr_nota_protocolo_w 		|| '#@' || 
						nr_titulo_w			|| '#@' || 
						ds_mesano_referencia_prot_w	|| '#@' || 
						ds_mesano_referencia_abrev_w 	|| '#@' || 
						nr_seq_retorno_w 			|| '#@' || 
						nr_nfe_imp_w			|| '#@' || 
						ds_devedor_pj_w			|| '#@' || 
						ds_observacao_titulo_w		|| '#@' || 
						to_char(dt_movimento_w, 'dd/mm/yyyy')	|| '#@' || 
						DS_COMPROVANTE_w		|| '#@' || 
						NR_AUTORIZACAO_w		|| '#@' || 
						ds_obs_convenio_receb_w		|| '#@' || 
						ds_convenio_w			|| '#@' || 
						dt_mesano_referencia_prot_w		|| '#@' || 
						ds_observacao_liq_w		|| '#@' || 
						nr_adiantamento_w		|| '#@' || 
						ds_bandeira_cartao_w		|| '#@' || 
						ds_pessoa_rec_cartao_w		|| '#@' || 
						ds_comprovante_cartao_w,1,4000);
		 
			select	substr(obter_compl_historico(cd_tipo_lote_contabil_w, cd_Historico_pls_w, ds_conteudo_w),1,255) 
			into STRICT	ds_compl_historico_w 
			;
 
		end if;
 
		if (cd_conta_deb_pls_w IS NOT NULL AND cd_conta_deb_pls_w::text <> '') and (cd_historico_pls_w IS NOT NULL AND cd_historico_pls_w::text <> '') then 
			select coalesce(max(nr_sequencia),0) + 1 
			into STRICT 	nr_sequencia_w 
			from 	w_movimento_contabil 
			where 	nr_lote_contabil 		= nr_lote_contabil_p;
			 
			begin 
			 
			insert 	into w_movimento_contabil( 
				nr_lote_contabil, nr_sequencia, cd_conta_contabil, 
				ie_debito_credito, cd_historico, dt_movimento, 
				vl_movimento, ds_doc_agrupamento, nr_seq_agrupamento, 
				cd_centro_custo, ds_compl_historico, nr_seq_trans_fin, 
				nr_documento, cd_pessoa_fisica, cd_cgc) 
			values ( 
				nr_lote_contabil_p, nr_sequencia_w, cd_conta_deb_pls_w, 
				'C', cd_historico_pls_w, dt_contabil_w, 
				vl_transacao_w, null, null, 
				null, ds_compl_historico_w, nr_seq_trans_fin_w, 
				null, cd_pessoa_fisica_w, cd_cgc_w);
			exception 
			when OTHERS then 
				ds_erro_w	:= sqlerrm(SQLSTATE);
				/* Erro ao inserir movimento contábil 
				cta=#@CD_CONTA_CONTABIL#@ titulo=#@NR_TITULO#@ seq=#@NR_SEQUENCIA#@ trans= #@NR_SEQ_TRANS_FIN#@ val=#@VL_MOVIMENTO#@ 
				#@DS_ERRO#@ */
 
				CALL wheb_mensagem_pck.exibir_mensagem_abort(267037, 'CD_CONTA_CONTABIL=' || cd_conta_deb_pls_w || 
										';NR_TITULO=' || nr_titulo_w || 
										';NR_SEQUENCIA=' || nr_sequencia_w || 
										';NR_SEQ_TRANS_FIN=' || nr_seq_trans_fin_w || 
										';VL_MOVIMENTO=' || vl_transacao_w || 
										';DS_ERRO=' || ds_erro_w);
			end;
				 
		end if;	
		end;
	end loop;
	close c01;
end if;
 
/* Não dar commit nesta procedure */
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_contabiliza_baixa_antec ( nr_lote_contabil_p bigint, nm_usuario_p text) FROM PUBLIC;

