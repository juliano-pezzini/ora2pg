-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_lote_auditoria (nr_seq_retorno_p bigint, ie_gerar_itens_p text, nm_usuario_p text, nr_seq_lote_audit_p bigint, ie_guia_sem_saldo_p text, ie_gerar_lotes_p text default 'N', ds_retorno_p INOUT text DEFAULT NULL) AS $body$
DECLARE


cd_convenio_w		integer;
cd_estabelecimento_w	smallint;
nr_seq_lote_audit_w	bigint;
nr_seq_lote_hist_w	bigint;
nr_analise_w		bigint;
dt_fechamento_w		timestamp;
nr_reg_atual_w		bigint;
nr_registro_w		varchar(255);
ie_adicional_w		varchar(5);
dt_envio_w		timestamp;
ie_data_retorno_w	varchar(1);
dt_retorno_w		timestamp;
ds_retorno_w		varchar(4000);


BEGIN

if (nr_seq_retorno_p IS NOT NULL AND nr_seq_retorno_p::text <> '') then

	select	max(a.cd_convenio),
		max(a.cd_estabelecimento),
		max(a.dt_retorno)
	into STRICT	cd_convenio_w,
		cd_estabelecimento_w,
		dt_retorno_w
	from	convenio_retorno a
	where	a.nr_sequencia	= nr_seq_retorno_p;

	if (coalesce(nr_seq_lote_audit_p::text, '') = '') then	/* se nenhum lote foi selecionado, gera um novo lote */
		nr_seq_lote_audit_w := Criar_Lote_Auditoria(	cd_convenio_w, cd_estabelecimento_w, nm_usuario_p, nr_seq_lote_audit_w);
	else
		select	a.dt_fechamento
		into STRICT	dt_fechamento_w
		from	lote_auditoria a
		where	a.nr_sequencia	= nr_seq_lote_audit_p;

		if (dt_fechamento_w IS NOT NULL AND dt_fechamento_w::text <> '') then
			/* Esta operação não pode ser realizada. O lote de recurso nr_seq_lote_audit_p já está fechado! */

			CALL wheb_mensagem_pck.exibir_mensagem_abort(199212,'NR_SEQ_LOTE_AUDIT_P=' || nr_seq_lote_audit_p);
		end if;

		nr_seq_lote_audit_w	:= nr_seq_lote_audit_p;
	end if;

	nr_seq_lote_hist_w := Criar_Lote_Audit_Hist(	nr_seq_lote_audit_w, cd_estabelecimento_w, nm_usuario_p, nr_seq_lote_hist_w, nr_seq_retorno_p);

	if (coalesce(ie_gerar_itens_p,'N')	= 'S') then
		ds_retorno_w := gerar_lote_audit_hist(nr_seq_lote_hist_w, nm_usuario_p, nr_seq_retorno_p, 'S', coalesce(ie_guia_sem_saldo_p,'S'), ie_gerar_lotes_p, ds_retorno_w);
		ds_retorno_p	:= substr(ds_retorno_w,1,255);
	else	/* na GERAR_LOTE_AUDIT_HIST já tem commit */
		commit;
	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_lote_auditoria (nr_seq_retorno_p bigint, ie_gerar_itens_p text, nm_usuario_p text, nr_seq_lote_audit_p bigint, ie_guia_sem_saldo_p text, ie_gerar_lotes_p text default 'N', ds_retorno_p INOUT text DEFAULT NULL) FROM PUBLIC;

