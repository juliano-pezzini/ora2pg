-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ageint_cancelar_item_sel (ds_seq_agenda_int_p text, ds_sequencia_p text, ds_motivo_p text DEFAULT NULL, nr_seq_motivo_canc_p text DEFAULT NULL, nm_usuario_p text DEFAULT NULL, cd_estabelecimento_p bigint) IS nr_seq_agenda_int_w varchar(100 DEFAULT NULL) RETURNS integer AS $body$
DECLARE

    v_cnt    integer := 0;
    v_string varchar(32767) := p_string;

BEGIN
    WHILE regexp_instr(v_string, p_expression) > 0 LOOP
      v_string := regexp_replace(v_string, p_expression, NULL, 1, 1);
      v_cnt    := v_cnt + 1;
    END LOOP;

    RETURN v_cnt;
  END;

BEGIN

  IF myregexp_count(ds_seq_agenda_int_p, ',') = myregexp_count(ds_sequencia_p, ',') THEN
    FOR i IN 1 .. myregexp_count(ds_seq_agenda_int_p, ',') + 1 LOOP
      BEGIN
        nr_seq_agenda_int_w := (regexp_substr(ds_seq_agenda_int_p, '[^,]+', 1, i))::numeric;
        nr_sequencia_w      := (regexp_substr(ds_sequencia_p, '[^,]+', 1, i))::numeric;
      EXCEPTION
        WHEN OTHERS THEN
          nr_seq_agenda_int_w := 0;
          nr_sequencia_w      := 0;
      END;

      IF (nr_seq_agenda_int_w > 0) AND (nr_sequencia_w > 0) THEN
      
        SELECT coalesce(MAX(ac.ie_status_agenda), 'X') ie_status_agecon,
               coalesce(MAX(ap.ie_status_agenda), 'X') ie_status_agepac,
               coalesce(MAX(aq.ie_status_agenda), 'X') ie_status_agequi
          INTO STRICT ie_status_agecon_w,
               ie_status_agepac_w,
               ie_status_agequi_w
          FROM agenda_integrada_item aii
LEFT OUTER JOIN agenda_consulta ac ON (aii.nr_seq_agenda_cons = ac.nr_sequencia)
LEFT OUTER JOIN agenda_paciente ap ON (aii.nr_seq_agenda_exame = ap.nr_sequencia)
LEFT OUTER JOIN agenda_quimio aq ON (aii.nr_seq_agequi = aq.nr_sequencia)
WHERE aii.nr_sequencia = nr_sequencia_w AND aii.nr_seq_agenda_int = nr_seq_agenda_int_w    AND (coalesce(aii.nr_seq_pend_quimio::text, '') = '' OR
               aq.nr_sequencia IN (SELECT nr_seq_atendimento FROM paciente_atendimento WHERE nr_seq_pend_agenda = aii.nr_seq_pend_quimio));

        IF (ie_status_agecon_w <> 'C') AND (ie_status_agepac_w <> 'C') AND (ie_status_agequi_w <> 'C') THEN
          CALL ageint_cancelar_item(nr_seq_agenda_int_p  => nr_seq_agenda_int_w,
                               nr_sequencia_p       => nr_sequencia_w,
                               ds_motivo_p          => ds_motivo_p,
                               nr_seq_motivo_canc_p => nr_seq_motivo_canc_p,
                               nm_usuario_p         => nm_usuario_p,
                               cd_estabelecimento_p => cd_estabelecimento_p);
        END IF;

        SELECT MAX(nr_sequencia)
          INTO STRICT nr_status_cancel_w
          FROM agenda_integrada_status
         WHERE ie_status_tasy = 'CA'
           AND ie_situacao = 'A';

        IF (nr_status_cancel_w IS NOT NULL AND nr_status_cancel_w::text <> '') THEN
          ie_cancela_agenda_w := ageint_obter_se_cancel_agenda(nr_seq_agenda_int_p => nr_seq_agenda_int_w);

          IF (ie_cancela_agenda_w = 'S') THEN
          
            CALL ageint_alterar_status(nr_seq_status_p      => nr_status_cancel_w,
                                  nr_seq_ageint_p      => nr_seq_agenda_int_w,
                                  ds_motivo_p          => ds_motivo_p,
                                  nm_usuario_p         => nm_usuario_p,
                                  cd_estabelecimento_p => cd_estabelecimento_p);

          END IF;
        END IF;
      END IF;
    END LOOP;
  END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageint_cancelar_item_sel (ds_seq_agenda_int_p text, ds_sequencia_p text, ds_motivo_p text DEFAULT NULL, nr_seq_motivo_canc_p text DEFAULT NULL, nm_usuario_p text DEFAULT NULL, cd_estabelecimento_p bigint) IS nr_seq_agenda_int_w varchar(100 DEFAULT NULL) FROM PUBLIC;

