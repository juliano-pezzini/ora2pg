-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE change_status_clinical_pathway ( nr_sequencia_p bigint , status_p text , code_p bigint ) AS $body$
DECLARE


status_w varchar(10);
cd_evolucao_old_w bigint;
ie_gerar_cli_path_evol_w    varchar(1);
cd_evolucao_w bigint;
nr_atendimento_origem_w protocolo_int_paciente.nr_atendimento_origem%TYPE;
cd_pessoa_fisica_w protocolo_int_paciente.cd_pessoa_fisica%TYPE;


BEGIN

if (code_p = 1146351 and status_p = 'N') then
    status_w:='A';

elsif (code_p = 1146352 and status_p = 'A') then
    status_w:='N';

elsif (code_p = 1146353 and status_p = 'A') then
    status_w:='F';

elsif (code_p = 1146354 and status_p = 'A') then
    status_w:='S';

elsif (code_p = 1146355 and status_p = 'F') then
    status_w:='A';

elsif (code_p = 1146356 and status_p = 'S') then
    status_w:='A';

else
    status_w:='A';

end if;

update    PROTOCOLO_INT_PACIENTE
set       IE_STATUS = status_w
where    nr_sequencia =     nr_sequencia_p;
commit;

select nr_atendimento_origem ,coalesce(cd_evolucao,0),cd_pessoa_fisica
into STRICT nr_atendimento_origem_w, cd_evolucao_old_w,cd_pessoa_fisica_w
from  protocolo_int_paciente
where  nr_sequencia = nr_sequencia_p;

ie_gerar_cli_path_evol_w := Obter_param_Usuario(281, 1628, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, coalesce(wheb_usuario_pck.get_cd_estabelecimento, 1), ie_gerar_cli_path_evol_w);

if ( ie_gerar_cli_path_evol_w = 'S' ) then
	if (( status_p = 'N' and status_w = 'A' ) or (status_p = 'A' and status_w = 'F'  ) or (status_p = 'A' and status_w = 'S'  )or (status_p = 'F' and status_w = 'A'  )or (status_p = 'S' and status_w = 'A'  )or (status_p = 'A' and status_w = 'N'  )) then
        if (cd_evolucao_old_w>0 )  then
			CALL clinical_notes_pck.soap_data_after_delete(cd_evolucao_old_w);
        else
			cd_evolucao_w := clinical_notes_pck.gerar_soap(nr_atendimento_origem_w, nr_sequencia_p, 'CLNICAL_PATHWAY', NULL, 'P', 1, cd_evolucao_w, null, cd_pessoa_fisica_w);
        end if;
		if (cd_evolucao_old_w > 0) then
        update protocolo_int_paciente
        set cd_evolucao = cd_evolucao_old_w
        where nr_sequencia = nr_sequencia_p;
        end if;
        if (cd_evolucao_w > 0) then
        update protocolo_int_paciente
        set cd_evolucao = cd_evolucao_w
        where nr_sequencia = nr_sequencia_p;
        end if;
		commit;
    end if;

end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE change_status_clinical_pathway ( nr_sequencia_p bigint , status_p text , code_p bigint ) FROM PUBLIC;

