-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ppm_copiar_metricas (nr_seq_metricas_p text, cd_pessoas_p text, nm_usuario_p text) AS $body$
DECLARE


pessoas_w		dbms_sql.varchar2_table;
metricas_w		dbms_sql.varchar2_table;
i			integer;
k			integer;
qt_w			bigint;
ppm_objetivo_w		ppm_objetivo%rowtype;
ppm_objetivo_meta_w	ppm_objetivo_meta%rowtype;
ppm_objetivo_metrica_w	ppm_objetivo_metrica%rowtype;
nr_seq_metrica_w	ppm_objetivo_metrica.nr_seq_metrica%type;
nr_seq_meta_w		ppm_objetivo_meta.nr_sequencia%type;
nr_seq_objetivo_w	ppm_objetivo.nr_sequencia%type;

c01 CURSOR FOR
SELECT	last_day(dt_mes) dt_mes
from	mes_v
where	trunc(dt_mes,'year') = trunc(clock_timestamp(),'year')
and	trunc(dt_mes,'month') <> trunc(clock_timestamp(),'month');

c01_w	c01%rowtype;


BEGIN

pessoas_w	:= obter_lista_string(cd_pessoas_p, ',');
metricas_w	:= obter_lista_string(nr_seq_metricas_p, ',');
k:= 0;
i:= 0;

for 	k in pessoas_w.first..pessoas_w.last loop
	begin

	for	i in metricas_w.first..metricas_w.last loop
		begin

		select	nr_seq_metrica
		into STRICT	nr_seq_metrica_w
		from	ppm_objetivo_metrica
		where	nr_sequencia	= metricas_w(i);

		select	count(*)
		into STRICT	qt_w
		from	ppm_objetivo_metrica a,
			ppm_objetivo_meta b,
			ppm_objetivo c
		where	a.nr_seq_meta		= b.nr_sequencia
		and	b.nr_seq_objetivo	= c.nr_sequencia
		and	c.cd_pessoa_fisica	= pessoas_w(k)
		and	a.nr_seq_metrica	= nr_seq_metrica_w
		and	clock_timestamp() between DT_INICIO_VIGENCIA and coalesce(DT_FINAL_VIGENCIA,clock_timestamp() + interval '1 days');

		if (qt_w = 0) then

			select	c.*
			into STRICT	ppm_objetivo_w
			from	ppm_objetivo_metrica a,
				ppm_objetivo_meta b,
				ppm_objetivo c
			where	a.nr_seq_meta		= b.nr_sequencia
			and	b.nr_seq_objetivo	= c.nr_sequencia
			and	a.nr_sequencia		= metricas_w(i);

			select	max(nr_sequencia)
			into STRICT	nr_seq_objetivo_w
			from	ppm_objetivo
			where	cd_pessoa_fisica	= pessoas_w(k)
			and	clock_timestamp() 		between DT_INICIO_VIGENCIA and coalesce(DT_FINAL_VIGENCIA,clock_timestamp() + interval '1 days')
			and	nr_seq_area		= ppm_objetivo_w.nr_seq_area;

			if (coalesce(nr_seq_objetivo_w::text, '') = '') then

				select	nextval('ppm_objetivo_seq')
				into STRICT	ppm_objetivo_w.nr_sequencia
				;

				ppm_objetivo_w.dt_atualizacao	:= clock_timestamp();
				ppm_objetivo_w.nm_usuario	:= nm_usuario_p;
				ppm_objetivo_w.cd_pessoa_fisica	:= pessoas_w(k);
				ppm_objetivo_w.nr_seq_gerencia	:= null;

				insert into ppm_objetivo values (ppm_objetivo_w.*);

				nr_seq_objetivo_w := ppm_objetivo_w.nr_sequencia;

			end if;

			select	b.*
			into STRICT	ppm_objetivo_meta_w
			from	ppm_objetivo_metrica a,
				ppm_objetivo_meta b,
				ppm_objetivo c
			where	a.nr_seq_meta		= b.nr_sequencia
			and	b.nr_seq_objetivo	= c.nr_sequencia
			and	a.nr_sequencia		= metricas_w(i);

			select	max(nr_sequencia)
			into STRICT	nr_seq_meta_w
			from	ppm_objetivo_meta a
			where	a.nr_seq_objetivo	= nr_seq_objetivo_w
			and	a.ie_tipo_meta		= ppm_objetivo_meta_w.ie_tipo_meta
			and	lower(a.DS_TITULO)	= lower(ppm_objetivo_meta_w.ds_titulo);

			if (coalesce(nr_seq_meta_w::text, '') = '') then

				select	nextval('ppm_objetivo_meta_seq')
				into STRICT	ppm_objetivo_meta_w.nr_sequencia
				;

				ppm_objetivo_meta_w.dt_atualizacao	:= clock_timestamp();
				ppm_objetivo_meta_w.nm_usuario		:= nm_usuario_p;
				ppm_objetivo_meta_w.nr_seq_objetivo	:= nr_seq_objetivo_w;

				insert into ppm_objetivo_meta values (ppm_objetivo_meta_w.*);
				nr_seq_meta_w	:= ppm_objetivo_meta_w.nr_sequencia;
			end if;

			select	a.*
			into STRICT	ppm_objetivo_metrica_w
			from	ppm_objetivo_metrica a,
				ppm_objetivo_meta b,
				ppm_objetivo c
			where	a.nr_seq_meta		= b.nr_sequencia
			and	b.nr_seq_objetivo	= c.nr_sequencia
			and	a.nr_sequencia		= metricas_w(i);

			select	nextval('ppm_objetivo_metrica_seq')
			into STRICT	ppm_objetivo_metrica_w.nr_sequencia
			;

			ppm_objetivo_metrica_w.dt_atualizacao	:= clock_timestamp();
			ppm_objetivo_metrica_w.nm_usuario	:= nm_usuario_p;
			ppm_objetivo_metrica_w.nr_seq_meta	:= nr_seq_meta_w;

			insert into ppm_objetivo_metrica values (ppm_objetivo_metrica_w.*);

		end if;
		end;
	end loop;

	end;
end loop;

commit;

--meses anteriores
/*open C01;
loop
fetch C01 into
	c01_w;
exit when C01%notfound;

	ppm_calcular_metricas(nm_usuario_p,c01_w.dt_mes,null);

end loop;
close C01;*/
--mes atual
--ppm_calcular_metricas(nm_usuario_p,sysdate-1,null);
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ppm_copiar_metricas (nr_seq_metricas_p text, cd_pessoas_p text, nm_usuario_p text) FROM PUBLIC;

