-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_proc_conv_agenda (( cd_estabelecimento_p bigint, cd_pessoa_fisica_p text, dt_referencia_p timestamp, cd_agenda_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_proc_interno_p bigint, cd_medico_p text, ie_medico_p text, cd_plano_p text, ie_consistencia_p out text, ie_agenda_p out text, nr_sequencia_p bigint default null, nr_seq_regra_p out bigint, ie_consist_js_p out text, nr_seq_cobertura_p bigint default null, nr_minuto_duracao_p bigint default null, cd_empresa_ref_p bigint default null, ie_anestesia_p text, ie_proc_adic_p text default 'N', nr_seq_item_p bigint default null) is /*	OBS.: AO REALIZAR QUALQUER ALTERACAO NESSA ROTINA, A MESMA DEVE SER REALIZADA TAMBEM NA GERAR_HORARIOS_AGEINT, NAS CONDICOES DO FOR ~ VETOR_REGRA_AGECONS_W	*/

 cd_area_proced_w bigint) AS $body$
DECLARE


	ds_comando_w				varchar(2000);

	ie_forma_consistencia_w			agenda_regra.ie_forma_consistencia%type;
	cd_medico_regra_w			agenda_regra.cd_medico%type;
	cd_convenio_regra_w			agenda_regra.cd_convenio%type;
	ie_convenio_qtd_w			agenda_regra.ie_convenio_qtd%type;
	cd_area_regra_w				agenda_regra.cd_area_proc%type;
	cd_grupo_regra_w			agenda_regra.cd_grupo_proc%type;
	cd_especialidade_regra_w		agenda_regra.cd_especialidade%type;
	ie_estrutra_qtd_w			agenda_regra.ie_estrutura_qtd%type;
	nr_seq_proc_int_qtd_w			agenda_regra.nr_seq_proc_interno%type;
	dt_atualizacao_nrec_w			timestamp;
	cd_proced_regra_w			agenda_regra.cd_procedimento%type;
	ie_origem_proced_regra_w		agenda_regra.ie_origem_proced%type;
	cd_categoria_regra_w			agenda_regra.cd_categoria%type;
	cd_plano_convenio_regra_w		agenda_regra.cd_plano_convenio%type;
	cd_agenda_regra_w			agenda_regra.cd_agenda%type;
	ds_inicio_w				varchar(7);
	ds_fim_w				varchar(7);
	hr_inicio_w				agenda_regra.hr_inicio%type;
	hr_fim_w				agenda_regra.hr_fim%type;
	ie_consiste_qtd_hora_w			agenda_regra.ie_consiste_qtd_hora%type;

	ds_ref_inicial_w			varchar(25);
	ds_ref_final_w				varchar(25);
	qt_agenda_w				bigint;
	ie_validar_dias_semana_w	agenda_regra.ie_validar_dias_semana%type;
	qt_marc_ageint_w		bigint := 0;
	nr_seq_topografia_w 			agenda_regra.nr_seq_topografia%type;
	
BEGIN

	select	coalesce(max(ie_forma_consistencia),'M'),
		max(cd_medico),
		coalesce(max(cd_convenio),0),
		coalesce(max(ie_convenio_qtd),'N'),
		max(cd_area_proc),
		max(cd_grupo_proc),
		max(cd_especialidade),
		coalesce(max(ie_estrutura_qtd),'N'),
		max(nr_seq_proc_interno),
		max(dt_atualizacao_nrec),
		max(cd_procedimento),
		max(ie_origem_proced),
		max(cd_categoria),
		max(cd_plano_convenio),
		max(cd_agenda),
		TO_CHAR(max(dt_inicio_agenda),'hh24:mi'),
		TO_CHAR(max(dt_fim_agenda),'hh24:mi'),
		max(hr_inicio),
		max(hr_fim),
		coalesce(max(ie_consiste_qtd_hora),'N'),
		coalesce(max(ie_validar_dias_semana),'A'),
		coalesce(max(ie_somente_mesmo_grupo),'S'),
		max(nr_seq_topografia)
	into STRICT	ie_forma_consistencia_w,
		cd_medico_regra_w,
		cd_convenio_regra_w,
		ie_convenio_qtd_w,
		cd_area_regra_w,
		cd_grupo_regra_w,
		cd_especialidade_regra_w,
		ie_estrutra_qtd_w,
		nr_seq_proc_int_qtd_w,
		dt_atualizacao_nrec_w,
		cd_proced_regra_w,
		ie_origem_proced_regra_w,
		cd_categoria_regra_w,
		cd_plano_convenio_regra_w,
		cd_agenda_regra_w,
		ds_inicio_w,
		ds_fim_w,
		hr_inicio_w,
		hr_fim_w,
		ie_consiste_qtd_hora_w,
		ie_validar_dias_semana_w,
		ie_somente_mesmo_grupo_w,
		nr_seq_topografia_w
	from	agenda_regra
	where	nr_sequencia = nr_seq_regra_p;



	ds_comando_w :=	' select	count(1) ' ||
		' from	agenda_paciente a ';

	if (ie_pac_proc_p = 'S') then
		ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
		'	, agenda_paciente_proc b';
	end if;

	if (nr_seq_grupo_selec_w > 0 and ie_somente_mesmo_grupo_w = 'S') then
		ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
		'	, agenda_integrada_item c';
	end if;


	ds_comando_w := ds_comando_w || chr(13) || chr(10) || ' where 1 = 1 ';

	if (ie_pac_proc_p = 'S') then
		ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
		' and	a.nr_sequencia		= b.nr_sequencia';
	end if;

	if (nr_seq_grupo_selec_w > 0 and ie_somente_mesmo_grupo_w = 'S') then
		ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
		'and	a.nr_Sequencia = c.nr_seq_Agenda_exame(+) ';
	end if;

	if (nr_seq_grupo_selec_w > 0 and ie_somente_mesmo_grupo_w = 'S') then
		ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
		'and	c.nr_Seq_grupo_Selec	=  '|| nr_seq_grupo_selec_w;
	end if;

	if (cd_agenda_regra_w IS NOT NULL AND cd_agenda_regra_w::text <> '') then
		ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
			' and a.cd_agenda		= ' || cd_agenda_regra_w;
	end if;
	if	(ie_convenio_qtd_w = 'S' AND cd_convenio_regra_w <> 0) then
		ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
			' and a.cd_convenio	= ' || cd_convenio_regra_w;
	end if;
	if (cd_categoria_regra_w IS NOT NULL AND cd_categoria_regra_w::text <> '') then
		ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
			' and a.cd_categoria = ' || cd_categoria_regra_w;
	end if;
	if (cd_plano_convenio_regra_w IS NOT NULL AND cd_plano_convenio_regra_w::text <> '') then
		ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
			' and a.cd_plano = ' || cd_plano_convenio_regra_w;
	end if;


	if (ie_forma_consistencia_w = 'M') then
		ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
			' and a.dt_agenda between ' ||CHR(39) || ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(dt_referencia_p)|| CHR(39)|| ' and ' || CHR(39)|| ESTABLISHMENT_TIMEZONE_UTILS.endOfMonth(dt_referencia_p) || CHR(39);
	elsif (ie_forma_consistencia_w = 'D') then
		ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
			' and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_agenda)	= '||CHR(39) ||ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_referencia_p)|| CHR(39);
	elsif (ie_forma_consistencia_w = 'A') then
		ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
			' and ESTABLISHMENT_TIMEZONE_UTILS.startOfYear(a.dt_agenda) = '||CHR(39) ||ESTABLISHMENT_TIMEZONE_UTILS.startOfYear(dt_referencia_p)|| CHR(39);
	elsif (ie_forma_consistencia_w = 'S') then
		select	obter_inicio_fim_semana(dt_referencia_p,'I'),
			obter_inicio_fim_semana(dt_referencia_p,'F')||'23:59:59'
		into STRICT	ds_ref_inicial_w,
			ds_ref_final_w
		;

		ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
			' and a.dt_agenda between to_date('''||ds_ref_inicial_w||''' ,''dd/mm/yyyy'') and to_date('''||ds_ref_final_w||''',''dd/mm/yyyy hh24:mi:ss'')';
	end if;

	ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
		' and a.ie_status_agenda		not in (''C'',''L'',''B'') and	a.nm_paciente is not null';

	if (ie_consiste_qtd_hora_w = 'S') then
		ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
			' and a.hr_inicio between to_date(to_char(a.dt_agenda, ''dd/mm/yyyy'') || '' '' ||'||   CHR(39)||coalesce(to_char(hr_inicio_w,'hh24:mi:ss'),'00:00:00')|| CHR(39)||',''dd/mm/yyyy hh24:mi:ss'') '|| chr(13) || chr(10) ||
				' and 	to_date(to_char(a.dt_agenda, ''dd/mm/yyyy'') || '' '' ||'||  CHR(39)|| coalesce(to_char(hr_fim_w,'hh24:mi:ss'), '00:00:00')|| CHR(39)||',''dd/mm/yyyy hh24:mi:ss'') ';
	end if;

	if (ie_medico_p = 'E') and (cd_medico_regra_w IS NOT NULL AND cd_medico_regra_w::text <> '') then
		ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
			' and a.cd_medico_exec = '|| cd_medico_regra_w;
	end if;

	if (ie_medico_p = 'R') and (cd_medico_regra_w IS NOT NULL AND cd_medico_regra_w::text <> '') then
		ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
			' and a.cd_medico = '|| cd_medico_regra_w;
	end if;

	if (nr_seq_proc_int_qtd_w IS NOT NULL AND nr_seq_proc_int_qtd_w::text <> '') then
		if (ie_pac_proc_p = 'S') then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) || 'and	b.nr_seq_proc_interno = '||nr_seq_proc_int_qtd_w;
		else
			ds_comando_w := ds_comando_w || chr(13) || chr(10) || 'and	a.nr_seq_proc_interno = '||nr_seq_proc_int_qtd_w;
		end if;
	end if;

	if (cd_proced_regra_w IS NOT NULL AND cd_proced_regra_w::text <> '') and ((cd_procedimento_p IS NOT NULL AND cd_procedimento_p::text <> '') or (cd_procedimento_global_p IS NOT NULL AND cd_procedimento_global_p::text <> '')) then
		if (ie_pac_proc_p = 'S') then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) || ' and	((b.cd_procedimento = '||cd_procedimento_p||') or (b.cd_procedimento = '||cd_procedimento_global_p||')) ';
		else
			ds_comando_w := ds_comando_w || chr(13) || chr(10) || ' and	((a.cd_procedimento = '||cd_procedimento_p||') or (a.cd_procedimento = '||cd_procedimento_global_p||')) ';
		end if;
	end if;
	if (ie_origem_proced_regra_w IS NOT NULL AND ie_origem_proced_regra_w::text <> '') and ((ie_origem_proced_p IS NOT NULL AND ie_origem_proced_p::text <> '') or (ie_origem_proced_global_p IS NOT NULL AND ie_origem_proced_global_p::text <> '')) then
		if (ie_pac_proc_p = 'S') then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) || ' and	((b.ie_origem_proced = '||ie_origem_proced_p||') or (b.ie_origem_proced = '||ie_origem_proced_global_p||')) ';
		else
			ds_comando_w := ds_comando_w || chr(13) || chr(10) || ' and	((a.ie_origem_proced = '||ie_origem_proced_p||') or (a.ie_origem_proced = '||ie_origem_proced_global_p||')) ';
		end if;
	end if;
	if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then
		ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
			' and	a.nr_sequencia <> '|| nr_sequencia_p;
	end if;
	if (ie_area_p = 'S') and (cd_area_regra_w IS NOT NULL AND cd_area_regra_w::text <> '') then
		if (ie_pac_proc_p = 'S') then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) || ' and	obter_area_procedimento(b.cd_procedimento,b.ie_origem_proced) = '||cd_area_regra_w;
		else
			ds_comando_w := ds_comando_w || chr(13) || chr(10) || ' and	obter_area_procedimento(a.cd_procedimento,a.ie_origem_proced) = '||cd_area_regra_w;
		end if;
	end if;
	if (ie_especialidade_p = 'S') and (cd_especialidade_regra_w IS NOT NULL AND cd_especialidade_regra_w::text <> '') then
		if (ie_pac_proc_p = 'S') then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) || ' and	Obter_Especialidade_Proced(b.cd_procedimento,b.ie_origem_proced) = '||cd_especialidade_regra_w;
		else
			ds_comando_w := ds_comando_w || chr(13) || chr(10) || ' and	Obter_Especialidade_Proced(a.cd_procedimento,a.ie_origem_proced) = '||cd_especialidade_regra_w;
		end if;
	end if;
	if (ie_grupo_p = 'S') and (cd_grupo_regra_w IS NOT NULL AND cd_grupo_regra_w::text <> '') then
		if (ie_pac_proc_p = 'S') then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) || ' and	obter_grupo_procedimento(b.cd_procedimento,b.ie_origem_proced,''C'') ='||cd_grupo_regra_w;
		else
			ds_comando_w := ds_comando_w || chr(13) || chr(10) || ' and	obter_grupo_procedimento(a.cd_procedimento,a.ie_origem_proced,''C'') ='||cd_grupo_regra_w;
		end if;
	end if;

	if (ie_validar_dias_semana_w <> 'A') then
		if (ie_validar_dias_semana_w = 'F') then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) || ' and obter_se_feriado(' || cd_estabelecimento_p || ', dt_agenda) > 0 ';
		elsif (ie_validar_dias_semana_w = 'D') then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) || ' and obter_se_feriado(' || cd_estabelecimento_p || ', dt_agenda) = 0 ';
		end if;
	end if;
	
	if (nr_seq_topografia_w IS NOT NULL AND nr_seq_topografia_w::text <> '') then
		if (ie_pac_proc_p = 'S') then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
				' and b.cd_topografia_proced = ' || nr_seq_topografia_w;
		else
			ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
				' and a.cd_topografia_proced = ' || nr_seq_topografia_w;
		end if;
	end if;
	

	EXECUTE ds_comando_w into STRICT qt_agenda_w;

	if (nr_seq_item_p > 0) then
		ds_comando_w	:= '';
		ds_comando_w :=	' select	count(1) ' ||
			' from	agenda_integrada_item a, ageint_marcacao_usuario b, agenda_integrada c ';


		ds_comando_w := ds_comando_w || chr(13) || chr(10) || ' where 1 = 1 ';

		ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
			' and	a.nr_sequencia		= b.nr_seq_Ageint_item and a.nr_seq_agenda_int = c.nr_sequencia ';

		ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
			' and b.nr_seq_ageint_item <> ' || nr_seq_item_p;

		if (nr_seq_grupo_selec_w > 0) then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
			'and	a.nr_Seq_grupo_Selec	=  '|| nr_seq_grupo_selec_w;
		end if;

		if (cd_agenda_regra_w IS NOT NULL AND cd_agenda_regra_w::text <> '') then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
				' and b.cd_agenda		= ' || cd_agenda_regra_w;
		end if;
		if	(ie_convenio_qtd_w = 'S' AND cd_convenio_regra_w <> 0) then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
				' and c.cd_convenio	= ' || cd_convenio_regra_w;
		end if;
		if (cd_categoria_regra_w IS NOT NULL AND cd_categoria_regra_w::text <> '') then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
				' and c.cd_categoria = ' || cd_categoria_regra_w;
		end if;
		if (cd_plano_convenio_regra_w IS NOT NULL AND cd_plano_convenio_regra_w::text <> '') then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
				' and c.cd_plano = ' || cd_plano_convenio_regra_w;
		end if;


		if (ie_forma_consistencia_w = 'M') then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
				' and b.hr_agenda between ' || CHR(39) ||ESTABLISHMENT_TIMEZONE_UTILS.startOfMonth(dt_referencia_p) || CHR(39) || ' and '|| CHR(39) ||  ESTABLISHMENT_TIMEZONE_UTILS.endOfMonth(dt_referencia_p) || CHR(39);
		elsif (ie_forma_consistencia_w = 'D') then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
				' and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.hr_agenda)	= '||CHR(39) ||to_char(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_referencia_p), 'dd/mm/yyyy')|| CHR(39);
		elsif (ie_forma_consistencia_w = 'A') then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
				' and ESTABLISHMENT_TIMEZONE_UTILS.startOfYear( b.hr_agenda) = '||CHR(39) ||ESTABLISHMENT_TIMEZONE_UTILS.startOfYear(dt_referencia_p)|| CHR(39);
		elsif (ie_forma_consistencia_w = 'S') then
			select	obter_inicio_fim_semana(dt_referencia_p,'I'),
				obter_inicio_fim_semana(dt_referencia_p,'F')||'23:59:59'
			into STRICT	ds_ref_inicial_w,
				ds_ref_final_w
			;

			ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
				' and b.hr_agenda between to_date('''||ds_ref_inicial_w||''' ,''dd/mm/yyyy'') and to_date('''||ds_ref_final_w||''',''dd/mm/yyyy hh24:mi:ss'')';
		end if;

		ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
			' and  nvl(b.ie_gerado,''N'') = ''N'' ';

		if (ie_consiste_qtd_hora_w = 'S') then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
				' and b.hr_agenda between to_date(to_char(b.hr_Agenda, ''dd/mm/yyyy'') || '' '' ||'||   CHR(39)||coalesce(to_char(hr_inicio_w,'hh24:mi:ss'),'00:00:00')|| CHR(39)||',''dd/mm/yyyy hh24:mi:ss'') '|| chr(13) || chr(10) ||
					' and 	to_date(to_char(b.hr_Agenda, ''dd/mm/yyyy'') || '' '' ||'||  CHR(39)|| coalesce(to_char(hr_fim_w,'hh24:mi:ss'), '00:00:00')|| CHR(39)||',''dd/mm/yyyy hh24:mi:ss'') ';
		end if;

		if (ie_medico_p = 'E') and (cd_medico_regra_w IS NOT NULL AND cd_medico_regra_w::text <> '') then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
				' and b.cd_pessoa_fisica = '|| cd_medico_regra_w;
		end if;

		/*if	(ie_medico_p = 'R') and (cd_medico_regra_w is not null) then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
				' and a.cd_medico = '|| cd_medico_regra_w;
		end if;*/
		if (nr_seq_proc_int_qtd_w IS NOT NULL AND nr_seq_proc_int_qtd_w::text <> '') then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) || 'and	a.nr_seq_proc_interno = '||nr_seq_proc_int_qtd_w;

		end if;

		if (cd_proced_regra_w IS NOT NULL AND cd_proced_regra_w::text <> '') and (cd_procedimento_global_p IS NOT NULL AND cd_procedimento_global_p::text <> '') then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) || ' and	((a.cd_procedimento = '||cd_procedimento_p||') or (a.cd_procedimento = '||cd_procedimento_global_p||')) ';

		end if;
		if (ie_origem_proced_regra_w IS NOT NULL AND ie_origem_proced_regra_w::text <> '') and (ie_origem_proced_global_p IS NOT NULL AND ie_origem_proced_global_p::text <> '') then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) || ' and	((a.ie_origem_proced = '||ie_origem_proced_p||') or (a.ie_origem_proced = '||ie_origem_proced_global_p||')) ';
		end if;

		if (ie_area_p = 'S') and (cd_area_regra_w IS NOT NULL AND cd_area_regra_w::text <> '') then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) || ' and	obter_area_procedimento(a.cd_procedimento,a.ie_origem_proced) = '||cd_area_regra_w;
		end if;
		if (ie_especialidade_p = 'S') and (cd_especialidade_regra_w IS NOT NULL AND cd_especialidade_regra_w::text <> '') then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) || ' and	Obter_Especialidade_Proced(a.cd_procedimento,a.ie_origem_proced) = '||cd_especialidade_regra_w;
		end if;
		if (ie_grupo_p = 'S') and (cd_grupo_regra_w IS NOT NULL AND cd_grupo_regra_w::text <> '') then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) || ' and	obter_grupo_procedimento(a.cd_procedimento,a.ie_origem_proced,''C'') ='||cd_grupo_regra_w;
		end if;

		if (ie_validar_dias_semana_w <> 'A') then
			if (ie_validar_dias_semana_w = 'F') then
				ds_comando_w := ds_comando_w || chr(13) || chr(10) || ' and obter_se_feriado(' || cd_estabelecimento_p || ', hr_agenda) > 0 ';
			elsif (ie_validar_dias_semana_w = 'D') then
				ds_comando_w := ds_comando_w || chr(13) || chr(10) || ' and obter_se_feriado(' || cd_estabelecimento_p || ', hr_Agenda) = 0 ';
			end if;
		end if;
		
		if (nr_seq_topografia_w IS NOT NULL AND nr_seq_topografia_w::text <> '') then
			ds_comando_w := ds_comando_w || chr(13) || chr(10) ||
				' and a.nr_seq_topografia = ' || nr_seq_topografia_w;
		end if;

		EXECUTE ds_comando_w into STRICT qt_marc_ageint_w;
	end if;

	return;

	end;

begin
--Exibir somente as agendas do estabelecimento do usuario
ie_estab_agenda_w := obter_valor_param_usuario(820, 1, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, coalesce(obter_estabelecimento_ativo,cd_estabelecimento_p));
qt_feriado_w := obter_se_feriado(cd_estabelecimento_p, dt_referencia_p);

if (ie_estab_agenda_w = 'N') then
	cd_estabelecimento_w := obter_estab_agenda(cd_agenda_p);
else
    cd_estabelecimento_w := cd_estabelecimento_p;
end if;

cd_tipo_agenda_w := obter_tipo_agenda(cd_agenda_p);

ie_considera_proc_int_qtd_w := obter_param_usuario(820, 383, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, cd_estabelecimento_w, ie_considera_proc_int_qtd_w);
cd_funcao_ativa_w	:= wheb_usuario_pck.get_cd_funcao;

if (cd_funcao_ativa_w = 869) and (nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '')then

	select	max(nr_minuto_duracao),
			coalesce(max(nr_seq_grupo_Selec),0)
	into STRICT	nr_minuto_duracao_w,
			nr_seq_grupo_selec_w
	from	agenda_integrada_item
	where	nr_sequencia = nr_seq_item_p;

end if;

if (coalesce(nr_minuto_duracao_p,0) > 0) then
	dt_final_w := dt_referencia_p + (nr_minuto_duracao_p/1440) - (1/86400);
elsif (coalesce(nr_minuto_duracao_w,0) > 0) and (cd_funcao_ativa_w = 869) then
	dt_final_w := dt_referencia_p + (nr_minuto_duracao_w/1440) - (1/86400);
end if;

if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
	qt_idade_pac_w := obter_idade_pf(cd_pessoa_fisica_p,clock_timestamp(),'A');
elsif (coalesce(nr_seq_item_p, 0) > 0) then
	select obter_idade(max(b.dt_nascimento), clock_timestamp(), 'A')
	into STRICT   qt_idade_pac_w
	from   agenda_integrada_item a,
		   agenda_integrada b
	where  a.nr_seq_agenda_int = b.nr_sequencia
	and    a.nr_sequencia = nr_seq_item_p;
elsif (coalesce(nr_sequencia_p, 0) > 0) then
	select obter_idade(max(dt_nascimento_pac), clock_timestamp(), 'A')
	into STRICT   qt_idade_pac_w
	from   agenda_paciente
	where  nr_sequencia = nr_sequencia_p;
end if;

qt_horas_w		:= (dt_referencia_p - clock_timestamp()) * 24;

select  Obter_Cod_Dia_Semana(dt_referencia_p), to_char(dt_referencia_p,'hh24:mi')
into STRICT 	dia_da_semana_w,
	ds_hora_referencia_w
;

cd_perfil_w			:= obter_perfil_ativo;


SELECT * FROM obter_proc_tab_interno_conv(
					nr_seq_proc_interno_p, cd_estabelecimento_w, cd_convenio_p, cd_categoria_p, cd_plano_p, null, cd_procedimento_global_w, ie_origem_proced_global_w, null, dt_referencia_p, null, null, null, null, null, null, null, null) INTO STRICT cd_procedimento_global_w, ie_origem_proced_global_w;

select	max(cd_municipio_ibge)
into STRICT	cd_municipio_ibge_w
from	compl_pessoa_fisica
where	cd_pessoa_fisica	= cd_pessoa_fisica_p
and	ie_tipo_complemento	= 1;

if (coalesce(nr_seq_proc_interno_p,0) > 0) then
	select	coalesce(max(nr_seq_classif),0)
	into STRICT	nr_seq_classif_w
	from	proc_interno
	where	nr_sequencia = nr_seq_proc_interno_p;
end if;


if (cd_estabelecimento_w IS NOT NULL AND cd_estabelecimento_w::text <> '') then
	/* obter informacao procedimento */

	select	coalesce(max(cd_area_procedimento),0),
		coalesce(max(cd_especialidade),0),
		coalesce(max(cd_grupo_proc),0),
		coalesce(max(substr(sus_obter_seq_estrut_proc(sus_obter_estrut_proc(cd_procedimento, ie_origem_proced, 'C', 'F'),'F'),1,10)),0),
		coalesce(max(substr(sus_obter_seq_estrut_proc(sus_obter_estrut_proc(cd_procedimento, ie_origem_proced, 'C', 'G'),'G'),1,10)),0),
		coalesce(max(substr(sus_obter_seq_estrut_proc(sus_obter_estrut_proc(cd_procedimento, ie_origem_proced, 'C', 'S'),'S'),1,10)),0)
	into STRICT	cd_area_proced_w,
		cd_espec_proced_w,
		cd_grupo_proced_w,
		nr_seq_forma_org_w,
		nr_seq_grupo_w,
		nr_seq_subgrupo_w
	from	estrutura_procedimento_v
	where	cd_procedimento = cd_procedimento_global_w
	and	ie_origem_proced = ie_origem_proced_global_w;

	/* obter regra exclusiva */

  for c_03 in C03 loop
	if (coalesce(c_03.nr_seq_proc_interno,0) = nr_seq_proc_interno_p) and (nr_seq_proc_interno_p IS NOT NULL AND nr_seq_proc_interno_p::text <> '') then
		ds_lista_sequencias := substr(ds_lista_sequencias || c_03.nr_sequencia ||', ',1,4000);
	end if;
    qt_exclusivo_w := qt_exclusivo_w + 1;
  end loop;

	begin
		select	ie_tipo_convenio
		into STRICT 	ie_tipo_convenio_w
		from 	convenio
		where 	cd_convenio = cd_convenio_p;
	EXCEPTION WHEN OTHERS THEN
		ie_tipo_convenio_w := null;
	end;

	select	pkg_date_utils.get_WeekDay(dt_referencia_p)
	into STRICT	ie_dia_semana_w
	;

	if (cd_tipo_agenda_w = 2) then

		select	coalesce(max(nr_sequencia), 0)
		into STRICT	nr_seq_turno_esp_w
		from	agenda_horario_esp a
		where	cd_agenda	= cd_agenda_p
		and	to_date('01/01/2000 ' || to_char(hr_inicial, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') 	<= to_date('01/01/2000 ' || to_char(dt_referencia_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss')
		and	to_date('01/01/2000 ' || to_char(hr_final, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') 	> to_date('01/01/2000 ' || to_char(dt_referencia_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss')
		and	((ie_dia_semana = ie_dia_semana_w) or ((ie_dia_semana = 9) and (ie_dia_semana_w not in (1,7))) or (coalesce(ie_dia_semana::text, '') = ''))
		and	dt_referencia_p	between pkg_date_utils.start_of(dt_agenda,'DAY') and pkg_date_utils.end_of(coalesce(dt_agenda_fim,dt_agenda),'DAY');

		if (coalesce(nr_seq_turno_esp_w,0) = 0) then
			select	coalesce(max(nr_sequencia), 0)
			into STRICT	nr_seq_turno_w
			from	agenda_horario a
			where	cd_agenda	= cd_agenda_p
			and (dt_dia_semana	= ie_dia_semana_w or (ie_dia_semana_w not in (7,1) and dt_dia_semana = 9))
			and	dt_referencia_p	between coalesce(dt_inicio_vigencia,to_date('01/01/1900 00:00:01','dd/mm/yyyy hh24:mi:ss')) and coalesce(dt_final_vigencia,to_date('01/01/2099 23:59:59','dd/mm/yyyy hh24:mi:ss'))
			and	to_date('01/01/2000 ' || to_char(hr_inicial, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') 	<= to_date('01/01/2000 ' || to_char(dt_referencia_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss')
			and	to_date('01/01/2000 ' || to_char(hr_final, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') 	> to_date('01/01/2000 ' || to_char(dt_referencia_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss');
		end if;

	elsif (cd_tipo_agenda_w = 5) then

		select	coalesce(max(nr_sequencia), 0)
		into STRICT	nr_seq_turno_w
		from	agenda_turno a
		where	cd_agenda	= cd_agenda_p
		and (ie_dia_semana	= ie_dia_semana_w or (ie_dia_semana_w not in (7,1) and ie_dia_semana = 9))
		and	to_date('01/01/2000 ' || to_char(hr_inicial, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') 	<= to_date('01/01/2000 ' || to_char(dt_referencia_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss')
		and	to_date('01/01/2000 ' || to_char(hr_final, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') 	> to_date('01/01/2000 ' || to_char(dt_referencia_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss');

	end if;

	if (qt_exclusivo_w > 0) then

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_regra_w
		from	agenda_regra
		where	((cd_estabelecimento = cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''))
		and	coalesce(cd_agenda,cd_agenda_p) = cd_agenda_p
		and	((cd_area_proc = cd_area_proced_w) or (coalesce(cd_area_proc::text, '') = ''))
		and	((cd_especialidade = cd_espec_proced_w) or (coalesce(cd_especialidade::text, '') = ''))
		and	((cd_grupo_proc = cd_grupo_proced_w) or (coalesce(cd_grupo_proc::text, '') = ''))
		and	coalesce(nr_seq_forma_org, nr_seq_forma_org_w)	= nr_seq_forma_org_w
		and	coalesce(nr_seq_grupo, nr_seq_grupo_w)		= nr_seq_grupo_w
		and	coalesce(nr_seq_subgrupo, nr_seq_subgrupo_w)		= nr_seq_subgrupo_w
		and	((cd_procedimento = cd_procedimento_p) or (coalesce(cd_procedimento::text, '') = ''))
		and	((coalesce(cd_procedimento::text, '') = '') or ((ie_origem_proced = ie_origem_proced_p) or (coalesce(ie_origem_proced::text, '') = '')))
		and	((nr_seq_proc_interno = nr_seq_proc_interno_p) or (coalesce(nr_seq_proc_interno::text, '') = ''))
		and	((cd_medico = cd_medico_p) or (coalesce(cd_medico::text, '') = ''))
		and	((cd_convenio = cd_convenio_p) or (coalesce(cd_convenio::text, '') = ''))
		and	((ie_tipo_convenio = ie_tipo_convenio_w) or (coalesce(ie_tipo_convenio::text, '') = ''))
		and 	((nr_seq_turno = nr_seq_turno_w) or (coalesce(nr_seq_turno::text, '') = ''))
		and 	((nr_seq_hor_esp = nr_seq_turno_esp_w) or (coalesce(nr_seq_hor_esp::text, '') = ''))
		and	((cd_perfil = cd_perfil_w) or (coalesce(cd_perfil::text, '') = ''))
   	and	coalesce(qt_idade_pac_w,0) >= coalesce(qt_idade_min,0)
  	and coalesce(qt_idade_pac_w,0) <= coalesce(qt_idade_max,999)
		and (coalesce(ie_medico, 'E') = ie_medico_p)
		and	coalesce(nr_seq_classif,nr_seq_classif_w) = nr_seq_classif_w
		and	ie_permite = 'E'
		and     ((obter_se_medico_equipe(nr_seq_equipe,cd_medico_p) = 'S') or (coalesce(nr_seq_equipe::text, '') = ''))
		and	((coalesce(ie_dia_semana,dia_da_Semana_w) = dia_da_Semana_w) or ((coalesce(ie_dia_semana,dia_da_Semana_w) = 9) and (dia_da_Semana_w not in (7,1))))
		and	dt_referencia_p	between coalesce(dt_inicio_vigencia,to_date('01/01/1900 00:00:01','dd/mm/yyyy hh24:mi:ss')) and coalesce(dt_fim_vigencia,to_date('01/01/2099 23:59:59','dd/mm/yyyy hh24:mi:ss'))
		and	((((coalesce(ie_consiste_final,'S') = 'N') or (coalesce(dt_final_w::text, '') = ''))
		and	dt_referencia_p between to_date(to_char(dt_referencia_p,'dd/mm/yyyy') || ' ' || coalesce(to_char(HR_INICIO,'hh24:mi:ss'),'00:00:00'),'dd/mm/yyyy hh24:mi:ss') and
					to_date(to_char(dt_referencia_p,'dd/mm/yyyy') || ' ' || coalesce(to_char(HR_FIM,'hh24:mi:ss'),'23:59:59'),'dd/mm/yyyy hh24:mi:ss')) or
			((coalesce(ie_consiste_final,'S') = 'S') or (dt_final_w IS NOT NULL AND dt_final_w::text <> ''))
		and	((dt_referencia_p	between	to_date(to_char(dt_referencia_p,'dd/mm/yyyy') || ' ' || coalesce(to_char(HR_INICIO,'hh24:mi:ss'),'00:00:00'),'dd/mm/yyyy hh24:mi:ss') and
						to_date(to_char(dt_referencia_p,'dd/mm/yyyy') || ' ' || coalesce(to_char(HR_FIM,'hh24:mi:ss'),'23:59:59'),'dd/mm/yyyy hh24:mi:ss')) or (dt_final_w  		between to_date(to_char(dt_referencia_p,'dd/mm/yyyy') || ' ' || coalesce(to_char(HR_INICIO,'hh24:mi:ss'),'00:00:00'),'dd/mm/yyyy hh24:mi:ss') and
						to_date(to_char(dt_referencia_p,'dd/mm/yyyy') || ' ' || coalesce(to_char(HR_FIM,'hh24:mi:ss'),'23:59:59'),'dd/mm/yyyy hh24:mi:ss')) or
			((dt_referencia_p 	< to_date(to_char(dt_referencia_p,'dd/mm/yyyy') || ' ' || coalesce(to_char(HR_INICIO,'hh24:mi:ss'),'00:00:00'),'dd/mm/yyyy hh24:mi:ss')) and (dt_final_w > to_date(to_char(dt_referencia_p,'dd/mm/yyyy') || ' ' || coalesce(to_char(HR_FIM,'hh24:mi:ss'),'23:59:59'),'dd/mm/yyyy hh24:mi:ss')))))
		and	((coalesce(qt_horas_ant_agenda,0) = 0) or (qt_horas_w > qt_horas_ant_agenda))
		and	coalesce(ie_situacao,'A') = 'A'
		and (cd_tipo_agenda_w <> 2 or ((coalesce(ie_somente_anestesia,'N') = 'S' and ie_anestesia_p = 'S') or (coalesce(ie_somente_anestesia,'N') = 'N')))
		and	((coalesce(ie_proc_adic_p,'N') = 'N') or (coalesce(IE_PROC_ADIC,'N') = 'S'))
		AND	((CD_AGENDA = CD_AGENDA_P)
		OR (coalesce(CD_AGENDA::text, '') = ''
			 AND (IE_AGENDA = CASE WHEN OBTER_TIPO_AGENDA(CD_AGENDA_P)=1 THEN  'CI' WHEN OBTER_TIPO_AGENDA(CD_AGENDA_P)=2 THEN  'E'  ELSE '' END
				OR	IE_AGENDA = 'T')))
		and (coalesce(ie_validar_dias_semana,'A') = 'A'
		or (ie_validar_dias_semana = 'F' and qt_feriado_w > 0)
		or (ie_validar_dias_semana = 'D' and qt_feriado_w = 0) )
		and (nr_seq_topografia = nr_seq_topografia_w or coalesce(nr_seq_topografia::text, '') = '');

		if (nr_seq_regra_w > 0) then
			select	max(ds_mensagem)
			into STRICT	ds_mensagem_padrao_w
			from	agenda_regra
			where	nr_sequencia = nr_seq_regra_w;
		end if;

		if (nr_seq_regra_w = 0) then
			ie_agenda_w := 'N';
			if (ds_mensagem_padrao_w IS NOT NULL AND ds_mensagem_padrao_w::text <> '') then
				ie_consist_js_w	:= substr(obter_texto_dic_objeto(183156, wheb_usuario_pck.get_nr_seq_idioma,'NR_SEQ_AGENDA=' || ds_lista_sequencias),1,255);
				ie_consistencia_w := 	substr(ds_mensagem_padrao_w,1,4000);
			else
				ie_consist_js_w	:= substr(obter_texto_dic_objeto(183156, wheb_usuario_pck.get_nr_seq_idioma,'NR_SEQ_AGENDA=' || ds_lista_sequencias),1,400);
				ie_consistencia_w := expressao1_w || chr(10) || expressao2_w;
			end if;

		end if;

	else
	
		select max(a.nr_seq_agenda_int)
		into STRICT   nr_seq_agenda_int_w
		from   agenda_integrada_item a
		where  a.nr_sequencia = nr_seq_item_p;	
		
		if (coalesce(nr_seq_agenda_int_w,0) > 0) then
		
			select  coalesce(max(1),0)
			into STRICT	qtd_agenda_proc_w
			from 	agenda_regra_proc a, agenda_regra b 
			where 	a.nr_seq_Regra = b.nr_sequencia 
			and (b.cd_agenda = cd_agenda_p or (coalesce(b.cd_agenda::text, '') = '' and b.cd_convenio = cd_convenio_p))  LIMIT 1;
			
			if (qtd_agenda_proc_w > 0) then
				open C04;
				loop                                                                          
				fetch C04 into                                                                
					nr_seq_agenda_regra_w;
				EXIT WHEN NOT FOUND; /* apply on C04 */
					begin                                                                        
					if (coalesce(nr_seq_agenda_regra_old_w::text, '') = '' or nr_seq_agenda_regra_old_w <> nr_seq_agenda_regra_w) then
						select 	coalesce(max(1),0)
						into STRICT	qt_regra_proc_w
						from 	agenda_regra_proc x, agenda_integrada_item b, estrutura_procedimento_v c
						where	x.nr_seq_regra = nr_seq_agenda_regra_w  
						and		b.nr_seq_agenda_int = nr_seq_agenda_int_w
						and 	b.ie_tipo_agendamento in ('E','S')				
						and		b.nr_sequencia <> nr_seq_item_p
						and  	c.cd_procedimento = b.cd_procedimento
						and  	c.ie_origem_proced = b.ie_origem_proced
						and 	((b.nr_seq_proc_interno = x.nr_seq_proc_interno) or (coalesce(x.nr_seq_proc_interno::text, '') = ''))
						and		((b.cd_procedimento = x.cd_procedimento) or (coalesce(x.cd_procedimento::text, '') = ''))
						and		((b.ie_origem_proced = x.ie_origem_proced) or (coalesce(x.ie_origem_proced::text, '') = ''))
						and		((c.cd_area_procedimento = x.cd_area_procedimento) or (coalesce(x.cd_area_procedimento::text, '') = ''))
						and		((c.cd_especialidade = x.cd_especialidade) or (coalesce(x.cd_especialidade::text, '') = ''))
						and		((c.cd_grupo_proc = x.cd_grupo_proc) or (coalesce(x.cd_grupo_proc::text, '') = ''));
					end if;
					if (qt_regra_proc_w > 0) then
						nr_seq_regra_nova_w	:= nr_seq_agenda_regra_w;
					end if;
					qt_regra_proc_w := 0;
					nr_seq_agenda_regra_old_w := nr_seq_agenda_regra_w;
					end;
				end loop;
				close C04;
			end if;
		
		end if;

		open C01;
		loop
		fetch C01 into
			nr_seq_regra_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			nr_seq_regra_w := nr_seq_regra_w;
			end;
		end loop;
		close C01;
		
		if (nr_seq_regra_w > 0) then

			select	coalesce(max(ie_permite),'S'),
					max(ds_mensagem)
			into STRICT	ie_agenda_w,
					ds_mensagem_padrao_w
			from	agenda_regra
			where	nr_sequencia = nr_seq_regra_w;


			select 	TO_CHAR(dt_inicio_agenda,'hh24:mi'),
					TO_CHAR(dt_fim_agenda,'hh24:mi'),
					hr_inicio,
					hr_fim,
					coalesce(ie_consiste_qtd_hora,'N')
			into STRICT	ds_inicio_w,
					ds_fim_w,
					hr_inicio_w,
					hr_fim_w,
					ie_consiste_qtd_hora_w
			from	agenda_regra
			where	nr_sequencia 	= nr_seq_regra_w
			and	((coalesce(ie_dia_semana,dia_da_Semana_w) = dia_da_Semana_w) or
				 ((coalesce(ie_dia_semana,dia_da_Semana_w) = 9) and (dia_da_Semana_w between 2 and 6)));


			select	max(dt_atualizacao_nrec)
			into STRICT	dt_atualizacao_nrec_w
			from	agenda_regra
			where	nr_sequencia = nr_seq_regra_w;

			select	max(dt_agendamento)
			into STRICT	dt_agendamento_w
			from	agenda_paciente
			where	nr_sequencia = nr_sequencia_p;

			if (ie_agenda_w = 'S') then
				if 	(ds_inicio_w IS NOT NULL AND ds_inicio_w::text <> '' AND ds_fim_w IS NOT NULL AND ds_fim_w::text <> '') then
					if (ds_hora_referencia_w < ds_inicio_w ) or (ds_hora_referencia_w > ds_fim_w) then
						ie_agenda_w := 'H';
						if (ds_mensagem_padrao_w IS NOT NULL AND ds_mensagem_padrao_w::text <> '') then
							ie_consist_js_w	:= substr(obter_texto_dic_objeto(183156, wheb_usuario_pck.get_nr_seq_idioma,'NR_SEQ_AGENDA=' || nr_seq_regra_w),1,255);
							ie_consistencia_w := substr(ds_mensagem_padrao_w,1,4000);
						else
							ie_consist_js_w	:= substr(obter_texto_dic_objeto(183156, wheb_usuario_pck.get_nr_seq_idioma,'NR_SEQ_AGENDA=' || nr_seq_regra_w),1,255);
							ie_consistencia_w := expressao3_w;
						end if;

					end if;
				end if;

				select	coalesce(max(qt_regra),0),
						coalesce(max(ie_forma_consistencia),'M'),
						max(cd_medico),
						coalesce(max(cd_convenio),0),
						coalesce(max(ie_convenio_qtd),'N'),
						max(cd_area_proc),
						max(cd_grupo_proc),
						max(cd_especialidade),
						coalesce(max(ie_estrutura_qtd),'N'),
						max(nr_seq_proc_interno),
						max(dt_atualizacao_nrec),
						max(cd_procedimento),
						max(ie_origem_proced),
						max(cd_categoria),
						max(cd_plano_convenio),
						max(cd_agenda),
						max(nr_seq_topografia)
				into STRICT	qt_regra_w,
						ie_forma_consistencia_w,
						cd_medico_regra_w,
						cd_convenio_regra_w,
						ie_convenio_qtd_w,
						cd_area_regra_w,
						cd_grupo_regra_w,
						cd_especialidade_regra_w,
						ie_estrutra_qtd_w,
						nr_seq_proc_int_qtd_w,
						dt_atualizacao_nrec_w,
						cd_proced_regra_w,
						ie_origem_proced_regra_w,
						cd_categoria_regra_w,
						cd_plano_convenio_regra_w,
						cd_agenda_regra_w,
						nr_seq_topografia_w
				from	agenda_regra
				where	nr_sequencia = nr_seq_regra_w;

				select	max(dt_agendamento)
				into STRICT	dt_agendamento_w
				from	agenda_paciente
				where	nr_sequencia = nr_sequencia_p;

				if (qt_regra_w	> 0) then
					if (ie_considera_proc_int_qtd_w = 'S') and (nr_seq_proc_int_qtd_w IS NOT NULL AND nr_seq_proc_int_qtd_w::text <> '') then

						qt_agenda_w	:= obter_qtd_agenda_regra(nr_seq_regra_w,
										'N','N','N','N',nr_sequencia_p,
										dt_referencia_p,
										ie_medico_p,
										null,
										null,
										null,
										null,
										null);

							if (ie_consiste_qtd_hora_w	= 'S') then

								qt_agenda_adic_w	:= obter_qtd_agenda_regra(nr_seq_regra_w,
												'S','N','N','N',nr_sequencia_p,
												dt_referencia_p,
												ie_medico_p,
												null,
												null,
												null,
												null,
												null);

								qt_agenda_w	:= qt_Agenda_w + qt_agenda_adic_w;
							end if;

					else
						if (ie_estrutra_qtd_w = 'S') then

							qt_agenda_w := obter_qtd_agenda_regra(nr_seq_regra_w,'N','S','S','S',nr_sequencia_p, dt_referencia_p, ie_medico_p, null, null, null, null, null);


							if (ie_consiste_qtd_hora_w	= 'S') then

								qt_agenda_adic_w := obter_qtd_agenda_regra(nr_seq_regra_w,'S','S','S','S',nr_sequencia_p, dt_referencia_p, ie_medico_p, null, null, null, null, null);

								qt_agenda_w	:= qt_Agenda_w + qt_agenda_adic_w;
							end if;
						else
							qt_agenda_w	:= obter_qtd_agenda_regra(	nr_seq_regra_w, 'N', 'N', 'N', 'N', nr_sequencia_p, dt_referencia_p, ie_medico_p,
								cd_procedimento_p, ie_origem_proced_p, nr_seq_proc_interno_p, cd_procedimento_global_w, ie_origem_proced_global_w);


							if (ie_consiste_qtd_hora_w	= 'S') then
								qt_agenda_adic_w	:= obter_qtd_agenda_regra(	nr_seq_regra_w, 'S', 'N', 'N', 'N', nr_sequencia_p, dt_referencia_p, ie_medico_p,
									cd_procedimento_p, ie_origem_proced_p, nr_seq_proc_interno_p, cd_procedimento_global_w, ie_origem_proced_global_w);

								qt_agenda_w	:= qt_Agenda_w + qt_agenda_adic_w;
							end if;


						end if;
					end if;

					if (qt_agenda_w >= qt_regra_w) then
						ie_agenda_w	:= 'Q';
					end if;

					if (ie_agenda_w <> 'Q' and qt_regra_w > 0) then
						SELECT * FROM consistir_proc_conv_forma( nr_seq_regra_w, ie_considera_proc_int_qtd_w, nr_seq_proc_int_qtd_w, cd_agenda_regra_w, cd_convenio_regra_w, ie_convenio_qtd_w, cd_categoria_regra_w, cd_plano_convenio_regra_w, ie_consiste_qtd_hora_w, hr_inicio_w, hr_fim_w, cd_medico_regra_w, ie_medico_p, nr_sequencia_p, ie_estrutra_qtd_w, cd_area_regra_w, cd_especialidade_regra_w, cd_grupo_regra_w, nr_seq_proc_interno_p, cd_procedimento_global_w, ie_origem_proced_global_w, cd_proced_regra_w, ie_origem_proced_p, ie_origem_proced_regra_w, dt_referencia_p, cd_procedimento_p, cd_agenda_p, dt_referencia_p) INTO STRICT ie_agenda_w, ds_mensagem_padrao_w
							;
					end if;
				end if;
			else
				if 	(ds_inicio_w IS NOT NULL AND ds_inicio_w::text <> '' AND ds_fim_w IS NOT NULL AND ds_fim_w::text <> '') then
					if (ie_agenda_w = 'N') then
						if (ds_hora_referencia_w >= ds_inicio_w ) and (ds_hora_referencia_w <= ds_fim_w) then
							ie_agenda_w := 'H';
							if (ds_mensagem_padrao_w IS NOT NULL AND ds_mensagem_padrao_w::text <> '') then
								ie_consist_js_w	:= substr(obter_texto_dic_objeto(183156, wheb_usuario_pck.get_nr_seq_idioma,'NR_SEQ_AGENDA=' || nr_seq_regra_w),1,255);
								ie_consistencia_w := substr(ds_mensagem_padrao_w,1,4000);
							else
								ie_consist_js_w	:= substr(obter_texto_dic_objeto(183156, wheb_usuario_pck.get_nr_seq_idioma,'NR_SEQ_AGENDA=' || nr_seq_regra_w),1,255);
								ie_consistencia_w := expressao4_w;
							end if;
						else
							ie_agenda_w := 'S';
						end if;
					end if;
				end if;
			end if;

			if (ie_agenda_w in ('N', 'Q'))  then
				if (ds_mensagem_padrao_w IS NOT NULL AND ds_mensagem_padrao_w::text <> '') then
					ie_consist_js_w	:= substr(obter_texto_dic_objeto(183156, wheb_usuario_pck.get_nr_seq_idioma,'NR_SEQ_AGENDA=' || nr_seq_regra_w),1,255);
					ie_consistencia_w := substr(ds_mensagem_padrao_w,1,4000);
				else
					ie_consist_js_w	:= substr(obter_texto_dic_objeto(183156, wheb_usuario_pck.get_nr_seq_idioma,'NR_SEQ_AGENDA=' || nr_seq_regra_w),1,255);
					select	coalesce(max(cd_medico),0),
							coalesce(max(cd_convenio),0)
					into STRICT	cd_medico_regra_w,
							cd_convenio_regra_w
					from	agenda_regra
					where	nr_sequencia = nr_seq_regra_w;

					if (cd_convenio_regra_w = 0 and cd_medico_regra_w > 0) then
						expressao5_w := obter_desc_expressao_idioma(892632, null, wheb_usuario_pck.get_nr_seq_idioma);
						-- Regras da agenda - O medico nao possui permissao para realizar esse procedimento.
					end if;
					ie_consistencia_w := expressao5_w;
				end if;
			end if;
		end if;

	end if;
end if;

if (dt_agendamento_w < dt_atualizacao_nrec_w)then
	ie_agenda_w := 'S';
end if;

ie_consistencia_p := ie_consistencia_w;
ie_consist_js_p	:= ie_consist_js_w;
nr_seq_regra_p	:= nr_seq_regra_w;
ie_agenda_p := ie_agenda_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_proc_conv_agenda (( cd_estabelecimento_p bigint, cd_pessoa_fisica_p text, dt_referencia_p timestamp, cd_agenda_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_proc_interno_p bigint, cd_medico_p text, ie_medico_p text, cd_plano_p text, ie_consistencia_p out text, ie_agenda_p out text, nr_sequencia_p bigint default null, nr_seq_regra_p out bigint, ie_consist_js_p out text, nr_seq_cobertura_p bigint default null, nr_minuto_duracao_p bigint default null, cd_empresa_ref_p bigint default null, ie_anestesia_p text, ie_proc_adic_p text default 'N', nr_seq_item_p bigint default null) is  cd_area_proced_w bigint) FROM PUBLIC;

