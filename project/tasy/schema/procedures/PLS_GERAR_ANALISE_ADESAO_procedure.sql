-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_analise_adesao ( nr_seq_pessoa_proposta_p bigint, nm_usuario_p text, ie_pode_commitar_p text) AS $body$
DECLARE


nr_seq_proposta_w		bigint;
cd_pessoa_fisica_w		varchar(10);
cd_estabelecimento_w		smallint;
qt_analise_w			integer	:= 0;
dt_contratacao_w		timestamp;
nr_seq_analise_w		bigint;
ie_exige_declaracao_analise_w	varchar(1);
qt_declaracao_saude_w		bigint;
nr_seq_beneficiario_w		pls_proposta_beneficiario.nr_seq_beneficiario%type;

C01 CURSOR FOR
	SELECT	nr_seq_tipo_carencia,
		qt_dias,
		dt_inicio_vigencia,
		ds_observacao
	from	pls_carencia
	where	nr_seq_segurado	= nr_seq_beneficiario_w
	and	ie_cpt = 'S';

BEGIN

select	max(ie_exige_declaracao_analise)
into STRICT	ie_exige_declaracao_analise_w
from	pls_parametros
where	cd_estabelecimento	= wheb_usuario_pck.get_cd_estabelecimento;

/* Obter dados dados da pessoa da proposta */

begin
select	nr_seq_proposta,
	cd_beneficiario,
	dt_contratacao,
	nr_seq_beneficiario
into STRICT	nr_seq_proposta_w,
	cd_pessoa_fisica_w,
	dt_contratacao_w,
	nr_seq_beneficiario_w
from	pls_proposta_beneficiario
where	nr_sequencia	= nr_seq_pessoa_proposta_p;
exception
	when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort( 241396, 'BENEF='||nr_seq_pessoa_proposta_p || ' - ' || sqlerrm(SQLSTATE) );
	/*Nao foi possivel ler os dados do beneficiario (' || 
			 || '#@#@');*/
end;

if (coalesce(ie_exige_declaracao_analise_w,'N') = 'S') then
	select	count(1)
	into STRICT	qt_declaracao_saude_w
	from	pls_declaracao_segurado
	where	nr_seq_proposta_adesao	= nr_seq_proposta_w
	and	cd_pessoa_fisica	= cd_pessoa_fisica_w
	and	ie_status		in ('L','E','P');
	
	if (qt_declaracao_saude_w = 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort( 241394, null);
	end if;
end if;

/* Obter dados da proposta */

select	cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	pls_proposta_adesao
where	nr_sequencia	= nr_seq_proposta_w;

select	count(*)
into STRICT	qt_analise_w
from	pls_analise_adesao
where	nr_seq_pessoa_proposta	= nr_seq_pessoa_proposta_p;

if (qt_analise_w	> 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort( 241395, null);
	/*A pessoa selecionada ja possui analise de adesao em aberto.
	E permitida apenas uma analise por beneficiario!*/
end if;

select	nextval('pls_analise_adesao_seq')
into STRICT	nr_seq_analise_w
;

insert into pls_analise_adesao(
	nr_sequencia, cd_estabelecimento, nr_seq_pessoa_proposta,
	cd_pessoa_fisica, dt_analise, dt_atualizacao,
	nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
	nr_seq_proposta, ie_status, nm_usuario_analise,
	dt_solicitacao_inclusao)
values (	nr_seq_analise_w, cd_estabelecimento_w, nr_seq_pessoa_proposta_p,
	cd_pessoa_fisica_w, clock_timestamp(), clock_timestamp(),
	nm_usuario_p, clock_timestamp(), nm_usuario_p,
	nr_seq_proposta_w, 'A', nm_usuario_p,
	dt_contratacao_w);

for c01_w in C01 loop
	begin		
	insert into pls_carencia(
		nr_sequencia, nr_seq_analise_adesao , nr_seq_tipo_carencia, qt_dias,
		dt_inicio_vigencia, ds_observacao, dt_atualizacao, nr_seq_pessoa_proposta,
		nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,ie_cpt)
	values (	nextval('pls_carencia_seq'), nr_seq_analise_w, c01_w.nr_seq_tipo_carencia, c01_w.qt_dias,
		c01_w.dt_inicio_vigencia, c01_w.ds_observacao, clock_timestamp(),nr_seq_pessoa_proposta_p,
		nm_usuario_p, clock_timestamp(), nm_usuario_p,'S');
	end;
end loop;
/*aaschlote 17/02/2011 OS - 287034*/

CALL pls_gerar_ocorrencias_analise(nr_seq_analise_w,cd_estabelecimento_w,nm_usuario_p);

/*aaschlote 02/05/2011 OS - 314422 - Gerar historico para o beneficiario*/

CALL pls_gravar_histor_prop_benef(nr_seq_pessoa_proposta_p,clock_timestamp(),'9',wheb_mensagem_pck.get_texto(1126674),nm_usuario_p);

/*Modificar o status da proposta para Analise de adesao*/

update	pls_proposta_adesao
set	ie_status = 'N'
where	nr_sequencia = nr_seq_proposta_w;

if (ie_pode_commitar_p = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_analise_adesao ( nr_seq_pessoa_proposta_p bigint, nm_usuario_p text, ie_pode_commitar_p text) FROM PUBLIC;

