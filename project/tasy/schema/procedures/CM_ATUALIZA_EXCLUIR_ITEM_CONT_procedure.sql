-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cm_atualiza_excluir_item_cont ( nr_seq_item_cont_p bigint, qt_item_p bigint, nr_seq_motivo_exclusao_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_item_atual_w			double precision;
qt_item_restante_w		double precision;
nr_seq_item_novo_w		bigint;
nr_seq_conjunto_w		bigint;
nr_seq_item_w			bigint;
ds_observacao_w			varchar(255);
ie_status_w			varchar(15);


BEGIN

select	qt_item
into STRICT	qt_item_atual_w
from	cm_item_cont
where	nr_sequencia = nr_seq_item_cont_p;

if (qt_item_atual_w = qt_item_p) then
	begin

	update	cm_item_cont
	set	ie_excluido = 'S',
		nr_seq_mot_exclusao = nr_seq_motivo_exclusao_p,
		dt_atualizacao = clock_timestamp(),
		nm_usuario = nm_usuario_p
	where	nr_sequencia = nr_seq_item_cont_p;

	end;
elsif (qt_item_atual_w > qt_item_p) and (qt_item_p > 0) then
	begin

	select (qt_item_atual_w - qt_item_p)
	into STRICT	qt_item_restante_w
	;

	select	nextval('cm_item_cont_seq')
	into STRICT	nr_seq_item_novo_w
	;

	select	nr_seq_conjunto,
		nr_seq_item,
		ds_observacao,
		ie_status
	into STRICT	nr_seq_conjunto_w,
		nr_seq_item_w,
		ds_observacao_w,
		ie_status_w
	from	cm_item_cont
	where	nr_sequencia = nr_seq_item_cont_p;

	insert into cm_item_cont(
		nr_sequencia,
		nr_seq_conjunto,
		nr_seq_item,
		qt_item,
		ie_excluido,
		ie_status,
		dt_atualizacao,
		nm_usuario,
		ds_observacao,
		nr_seq_mot_exclusao) values (
			nr_seq_item_novo_w,
			nr_seq_conjunto_w,
			nr_seq_item_w,
			qt_item_p,
			'S',
			ie_status_w,
			clock_timestamp(),
			nm_usuario_p,
			ds_observacao_w,
			nr_seq_motivo_exclusao_p);


	update	cm_item_cont
	set	qt_item = qt_item_restante_w,
		dt_atualizacao = clock_timestamp(),
		nm_usuario = nm_usuario_p
	where	nr_sequencia = nr_seq_item_cont_p;

	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cm_atualiza_excluir_item_cont ( nr_seq_item_cont_p bigint, qt_item_p bigint, nr_seq_motivo_exclusao_p bigint, nm_usuario_p text) FROM PUBLIC;

