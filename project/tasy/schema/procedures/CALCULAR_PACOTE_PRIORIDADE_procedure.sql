-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_pacote_prioridade ( cd_convenio_conta_p bigint, cd_categoria_conta_p text, cd_estabelecimento_p bigint, nr_interno_conta_p bigint, nr_atendimento_p bigint, nm_usuario_p text, ie_prioridade_pacote_job_p text, ds_erro_p INOUT text ) AS $body$
DECLARE


nr_seq_w_atend_pacote_w	w_atendimento_pacote.nr_sequencia%type;
nr_seq_pacote_w			w_atendimento_pacote.nr_seq_pacote%type;
nr_seq_proc_origem_w	w_atendimento_pacote.nr_seq_proc_origem%type;
qt_job_auto_w			bigint;
ie_erro_w				varchar(1) := 'N';
ie_prioridade_w			w_atendimento_pacote.ie_prioridade%type;
ie_prioridade_ant_w		w_atendimento_pacote.ie_prioridade%type;
ie_calcular_w       	varchar(1);
ie_pacote_automatico_w	pacote.ie_pacote_automatico%type;
ds_erro_w				varchar(2000);

C01 CURSOR FOR
	
	SELECT	a.nr_sequencia,
		a.nr_seq_pacote,
		a.nr_seq_proc_origem,
		coalesce(a.ie_prioridade, 999),
		b.ie_pacote_automatico
	from 	w_atendimento_pacote a, 
		pacote b
	where 	nr_atendimento	= nr_atendimento_p
	and 	a.nr_seq_pacote = b.nr_seq_pacote
	order by coalesce(a.ie_prioridade, 999);		


BEGIN
	ds_erro_w := null;
	begin
		-- 1 - Listar os pacotes
		CALL calcular_pacote(
				nr_atendimento_p,
				nr_interno_conta_p,
				cd_convenio_conta_p,
				cd_categoria_conta_p,
				nm_usuario_p,
				'N',	-- ie_define_pacote_p
				'N',	-- ie_atualiza_procedimento_p
				'N',	-- ie_atualiza_material_p
				'N',	-- ie_ratear_valores_p
				'S');	-- ie_lista_pacote_p
	exception
		when others then
		ie_erro_w	:= 'S';
		ds_erro_w := substr(ds_erro_w || sqlerrm(SQLSTATE) || chr(13) || chr(10) || ds_erro_w,1,2000);
	end;
	
	-- 2 - Marcar os pacotes que devem gerar e os que nao devem
	update	w_atendimento_pacote
	set 	ie_gerar = 'N'
	where 	nr_atendimento = nr_atendimento_p;
	
	ie_calcular_w := 'N';	

	open C01;
	loop
	fetch C01 into	
		nr_seq_w_atend_pacote_w,
		nr_seq_pacote_w,
		nr_seq_proc_origem_w,
		ie_prioridade_w,
		ie_pacote_automatico_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin	
			if (coalesce(ie_prioridade_ant_w::text, '') = '') then
				ie_prioridade_ant_w	:= ie_prioridade_w;
			end if;
			
			if	((ie_prioridade_pacote_job_p = 'S') and (ie_prioridade_w <> ie_prioridade_ant_w) and (ie_calcular_w = 'S')) or
				((ie_prioridade_pacote_job_p = 'R') and (ie_pacote_automatico_w = 'S') and (ie_prioridade_w <> ie_prioridade_ant_w) and (ie_calcular_w = 'S'))	then
				--3 Gerar os pacotes.	
				begin	
					ie_calcular_w := 'N';	
					
					CALL calcular_pacote(
							nr_atendimento_p,
							nr_interno_conta_p,
							cd_convenio_conta_p,
							cd_categoria_conta_p,
							nm_usuario_p,
							'S',	-- ie_define_pacote_p
							'S',	-- ie_atualiza_procedimento_p
							'S',	-- ie_atualiza_material_p
							'S',	-- ie_ratear_valores_p
							'N');	-- ie_lista_pacote_p
					ie_prioridade_ant_w	:= ie_prioridade_w;
					
				exception
					when others then
					ie_erro_w	:= 'S';
					ds_erro_w := substr(ds_erro_w || sqlerrm(SQLSTATE) || chr(13) || chr(10) || ds_erro_w,1,2000);
				end;	
			end if;
			
			select	count(*)
			into STRICT	qt_job_auto_w
			from	procedimento_paciente a,
				pacote b
			where	a.nr_interno_conta = nr_interno_conta_p
			and 	a.nr_sequencia     = nr_seq_proc_origem_w
			and 	b.nr_seq_pacote    = nr_seq_pacote_w
			and 	b.cd_convenio 	   = cd_convenio_conta_p
			and 	a.cd_procedimento  = b.cd_proced_pacote
			and 	a.ie_origem_proced = b.ie_origem_proced			
			and (ie_prioridade_pacote_job_p <> 'N' and coalesce(a.nr_seq_proc_pacote::text, '') = '')
			and 	((coalesce(b.ie_pacote_automatico,'N') = 'S') or (ie_prioridade_pacote_job_p = 'S'));

			if (qt_job_auto_w > 0) then
			
				update	w_atendimento_pacote
				set 	ie_gerar = 'S'
				where 	nr_sequencia = nr_seq_w_atend_pacote_w
				and 	nr_seq_pacote = nr_seq_pacote_w
				and 	nr_seq_proc_origem = nr_seq_proc_origem_w
				and 	nr_atendimento = nr_atendimento_p;
				ie_calcular_w := 'S';

			end if;
		
		end;
	end loop;
	close C01;
	
	if (ie_erro_w = 'N') and (ie_calcular_w = 'S') then
		begin
		CALL calcular_pacote(
				nr_atendimento_p,
				nr_interno_conta_p,
				cd_convenio_conta_p,
				cd_categoria_conta_p,
				nm_usuario_p,
				'S',	-- ie_define_pacote_p
				'S',	-- ie_atualiza_procedimento_p
				'S',	-- ie_atualiza_material_p
				'S',	-- ie_ratear_valores_p
				'N');	-- ie_lista_pacote_p
		exception
			when others then
			ie_erro_w:= 'S';
			ds_erro_w := ds_erro_w || substr(sqlerrm(SQLSTATE) || chr(13) || chr(10) || ds_erro_w,1,2000);
		end;	
	end if;
	
	ds_erro_p := ds_erro_w;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_pacote_prioridade ( cd_convenio_conta_p bigint, cd_categoria_conta_p text, cd_estabelecimento_p bigint, nr_interno_conta_p bigint, nr_atendimento_p bigint, nm_usuario_p text, ie_prioridade_pacote_job_p text, ds_erro_p INOUT text ) FROM PUBLIC;

