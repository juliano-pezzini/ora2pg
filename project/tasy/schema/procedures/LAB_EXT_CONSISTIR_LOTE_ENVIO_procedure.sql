-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_ext_consistir_lote_envio ( nr_seq_lote_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ds_retorno_p INOUT text) AS $body$
DECLARE

 
ds_retorno_w		varchar(4000);
ds_retorno_aux_w	varchar(4000);
quebra_w		varchar(20) := chr(10)||chr(13);

qt_idade_w		integer;

			 
C01 CURSOR FOR 
	SELECT	e.cd_pessoa_fisica, 
		SUBSTR(OBTER_NOME_PF(e.CD_PESSOA_FISICA),0,60) nm_pessoa_fisica, 
		e.dt_nascimento, 
		e.ie_sexo, 
		coalesce(e.ie_revisar,'N') ie_revisar, 
		e.nr_cpf 
	from	pessoa_fisica e, 
		exame_laboratorio d, 	 
		lab_lote_externo c, 	 
		prescr_procedimento b, 		 
		prescr_medica a 
	where	c.nr_sequencia = b.nr_seq_lote_externo 
	and   a.nr_prescricao = b.nr_prescricao 
	and   b.nr_seq_exame = d.nr_seq_exame 
	and	a.cd_pessoa_fisica = e.cd_pessoa_fisica 
	and   c.nr_sequencia = nr_seq_lote_p 
	group by e.cd_pessoa_fisica, 
		SUBSTR(OBTER_NOME_PF(e.CD_PESSOA_FISICA),0,60), 
		e.dt_nascimento, 
		e.ie_sexo, 
		e.ie_revisar, 
		e.nr_cpf;
	
c01_w	c01%rowtype;	
 

BEGIN 
ds_retorno_w	:= null;
 
if (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') then 
	 
	open c01;
	loop 
	fetch c01 into c01_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin 
			 
			ds_retorno_aux_w	:= null;
			 
			/*if (c01_w.cd_pessoa_fisica is null) then 
				ds_retorno_w	:= ds_retorno_w||'Código do paciente'||quebra_w; 
			end if; 
			 
			if (c01_w.nm_pessoa_fisica is null) then 
				ds_retorno_w	:= ds_retorno_w||'Nome do paciente'||quebra_w; 
			end if;*/
 
			 
			if (coalesce(c01_w.dt_nascimento::text, '') = '') then 
				ds_retorno_aux_w	:= substr(ds_retorno_aux_w||obter_texto_tasy(106153, wheb_usuario_pck.get_nr_seq_idioma)||quebra_w,1,4000); --Data de nascimento 
			end if;
			 
			if (coalesce(c01_w.ie_sexo::text, '') = '') then 
				ds_retorno_aux_w	:= substr(ds_retorno_aux_w||obter_texto_tasy(106155, wheb_usuario_pck.get_nr_seq_idioma)||quebra_w,1,4000); --Sexo 
			end if;
			 
			if (c01_w.ie_revisar = 'R') then 
				ds_retorno_aux_w	:= substr(ds_retorno_aux_w||obter_texto_tasy(106156, wheb_usuario_pck.get_nr_seq_idioma)||quebra_w,1,4000); --Campo de revisão 
			end if;
			 
			if (coalesce(c01_w.nr_cpf::text, '') = '') then 
		 
				begin 
				qt_idade_w :=	(obter_idade(c01_w.dt_nascimento,clock_timestamp(),'A'))::numeric;
				exception 
				when others then 
				qt_idade_w := 999;
				end;
		 
				if (qt_idade_w >= 18) then 
					 
					ds_retorno_aux_w	:= substr(ds_retorno_aux_w||obter_texto_tasy(106158, wheb_usuario_pck.get_nr_seq_idioma)||quebra_w,1,4000);
					 
				end if;
				 
			end if;
			 
			if (ds_retorno_aux_w IS NOT NULL AND ds_retorno_aux_w::text <> '') then 
				ds_retorno_w		:= 	substr(ds_retorno_w||quebra_w|| 
								replace_macro(obter_texto_tasy(106159, wheb_usuario_pck.get_nr_seq_idioma), 
									'@PACIENTE@','('||c01_w.cd_pessoa_fisica||') - '||c01_w.nm_pessoa_fisica)||quebra_w||ds_retorno_aux_w--||quebra_w 
									,1,4000);
			end if;
					 
			end;
	end loop;
	close c01;
	 
	ds_retorno_p	:= substr(ds_retorno_w,3,255);
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_ext_consistir_lote_envio ( nr_seq_lote_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ds_retorno_p INOUT text) FROM PUBLIC;

