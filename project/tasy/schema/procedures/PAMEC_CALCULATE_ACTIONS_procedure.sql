-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pamec_calculate_actions ( nr_seq_qua_pamec_p qua_nao_conformidade.nr_sequencia%type, dt_encerramento_p qua_pamec.dt_encerramento%type, nm_usuario_p qua_pamec.nm_usuario%type ) AS $body$
DECLARE


    qt_acao_programada_w        qua_pamec.qt_acao_programada%type;
    qt_acao_executada_w         qua_pamec.qt_acao_executada%type;


BEGIN

select count(b.nr_sequencia)
into STRICT    qt_acao_programada_w
from    qua_nao_conformidade a,
        man_ordem_servico b
where a.nr_sequencia = b.nr_seq_nao_conform
and a.nr_seq_qua_pamec = nr_seq_qua_pamec_p
and b.nr_seq_tipo_ordem = (SELECT tp.nr_sequencia
                            from    man_tipo_ordem_servico tp 
                            where tp.nr_sequencia=b.nr_seq_tipo_ordem 
                            and tp.ie_pamec = 'S');

select count(os.nr_sequencia)
into STRICT qt_acao_executada_w
from qua_nao_conformidade  q,
        man_ordem_servico os
where q.nr_sequencia = os.nr_seq_nao_conform
and q.nr_seq_qua_pamec = nr_seq_qua_pamec_p
and os.ie_status_ordem = '3' --EXECUTADAS
and os.nr_seq_tipo_ordem = (SELECT tp.nr_sequencia
                            from    man_tipo_ordem_servico tp 
                            where tp.nr_sequencia=os.nr_seq_tipo_ordem 
                            and tp.ie_pamec = 'S');

if (dt_encerramento_p IS NOT NULL AND dt_encerramento_p::text <> '') then
    update qua_pamec
    set qt_acao_programada  = qt_acao_programada_w,
        qt_acao_executada   = qt_acao_executada_w,
        nm_usuario          = nm_usuario_p,
        dt_atualizacao      = clock_timestamp()
    where nr_sequencia = nr_seq_qua_pamec_p;
else
    update qua_pamec
    set qt_acao_programada   = NULL,
        qt_acao_executada    = NULL,
        nm_usuario          = nm_usuario_p,
        dt_atualizacao      = clock_timestamp()
    where nr_sequencia = nr_seq_qua_pamec_p;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pamec_calculate_actions ( nr_seq_qua_pamec_p qua_nao_conformidade.nr_sequencia%type, dt_encerramento_p qua_pamec.dt_encerramento%type, nm_usuario_p qua_pamec.nm_usuario%type ) FROM PUBLIC;

