-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pepo_atual_st_desc_cirurgia ( nr_seq_carta_mae_p carta_medica.nr_seq_carta_mae%type, ie_status_p text, nm_usuario_p text) AS $body$
DECLARE


nr_cirurgia_w           carta_medica.nr_cirurgia%TYPE;
cd_estabelecimento_w    carta_medica.cd_estabelecimento%TYPE;
param_532_w             funcao_param_usuario.vl_parametro%TYPE;
ie_status_w             pepo_doc_status.ie_status%TYPE;
qt_aprovadas_w          bigint;
ie_preliminar_w         carta_medica.ie_preliminar%TYPE;
qt_ie_preliminar_w      bigint;


BEGIN

    select  nr_cirurgia,
            cd_estabelecimento
    into STRICT    nr_cirurgia_w,
            cd_estabelecimento_w
    from    carta_medica
    where	nr_sequencia = nr_seq_carta_mae_p;

    if (nr_cirurgia_w IS NOT NULL AND nr_cirurgia_w::text <> '') then
        select  max(ie_status)
        into STRICT    ie_status_w
        from    pepo_doc_status
        where   cd_item = 1
          and   nr_cirurgia = nr_cirurgia_w;

    param_532_w := obter_param_usuario(872, 532, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, param_532_w);

        if  (ie_status_w IS NOT NULL AND ie_status_w::text <> '' AND param_532_w = 'MEDL') then                 
            if ie_status_p = 'RE' then
                select  COUNT(*) 
                into STRICT    qt_aprovadas_w
                FROM    carta_medica a
                where   a.nr_cirurgia = nr_cirurgia_w
                and     a.IE_STATUS_APROVACAO = 'AP'
                and     'N' in (SELECT b.ie_preliminar from carta_medica b where a.nr_seq_carta_mae = b.nr_seq_carta_mae);

                if qt_aprovadas_w < 1 then
                    CALL pepo_atualizar_status_doc(nr_cirurgia_w, 1, 'P', nm_usuario_p, null);
                end if;

            elsif ie_status_p = 'AP' then
                
                select COUNT(*)
                into STRICT qt_ie_preliminar_w
                FROM carta_medica
                where nr_seq_carta_mae = nr_seq_carta_mae_p
                and IE_STATUS_APROVACAO = 'AP'
                and ie_preliminar <> 'S';

                select ie_preliminar
                into STRICT ie_preliminar_w
                FROM carta_medica
                where nr_sequencia = nr_seq_carta_mae_p;

                if (qt_ie_preliminar_w > 0) then
                    CALL pepo_atualizar_status_doc(nr_cirurgia_w, 1, 'C', nm_usuario_p, null);
                end if;
            end if;
        end if;
    end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pepo_atual_st_desc_cirurgia ( nr_seq_carta_mae_p carta_medica.nr_seq_carta_mae%type, ie_status_p text, nm_usuario_p text) FROM PUBLIC;

