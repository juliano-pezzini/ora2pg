-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_usuario_padrao (cd_pessoa_fisica_p text, nm_usuario_p INOUT text) AS $body$
DECLARE

 
ie_tipo_regra_w		varchar(1);
ds_separador_w		varchar(10) := ' ';
ds_retorno_ww		varchar(255);
nm_pessoa_fisica_w	varchar(255);
nm_usuario_w		varchar(255) := '';
nm_usuario_ww		varchar(255) := '';
qt_nome_w		bigint := 1;
qt_xx_w			bigint := 1;
x			varchar(255);
qt_ultimo_w		bigint := 0;
qt_usuario_w		bigint;

BEGIN 
 
select	coalesce(max(IE_TIPO_REGRA),'N') 
into STRICT	ie_tipo_regra_w 
from	REGRA_PADRAO_USUARIO 
where	ie_situacao = 'A';
 
if (ie_tipo_regra_w = 'I') then 
 
	select substr(obter_nome_pf(cd_pessoa_fisica_p),1,60) 
	into STRICT	nm_pessoa_fisica_w 
	;
	 
	for i in 1..length(nm_pessoa_fisica_w) loop 
		x	:= substr(nm_pessoa_fisica_w, i, 1);	
		if (x = ' ') then 
			qt_nome_w := qt_nome_w + 1;
		end if;
	end loop;
	 
	while qt_xx_w <= qt_nome_w loop 
	 
		nm_usuario_w := OBTER_VALOR_CAMPO_SEPARADOR(nm_pessoa_fisica_w,qt_xx_w,' ');
		if (qt_xx_w <> qt_nome_w) then 
			nm_usuario_ww := nm_usuario_ww || substr(nm_usuario_w,1,1);
		elsif (qt_xx_w = qt_nome_w) then 
			nm_usuario_ww := nm_usuario_ww || substr(nm_usuario_w,1,255);
		end if;
		qt_xx_w := qt_xx_w + 1;
 
	end loop;
 
end if;
 
select	count(*) 
into STRICT	qt_usuario_w 
from	usuario 
where	lower(nm_usuario) = lower(substr(nm_usuario_ww,1,15));
 
if (qt_usuario_w > 0) then 
	 
	qt_nome_w 	:= 1;
	qt_xx_w		:= 1;
	 
	select substr(obter_nome_pf(cd_pessoa_fisica_p),1,60) 
	into STRICT	nm_pessoa_fisica_w 
	;
	 
	for i in 1..length(nm_pessoa_fisica_w) loop 
		x	:= substr(nm_pessoa_fisica_w, i, 1);	
		if (x = ' ') then 
			qt_nome_w := qt_nome_w + 1;
		end if;
	end loop;
	 
	nm_usuario_ww := '';
	 
	while qt_xx_w <= qt_nome_w loop 
	 
		nm_usuario_w := OBTER_VALOR_CAMPO_SEPARADOR(nm_pessoa_fisica_w,qt_xx_w,' ');
		if (qt_xx_w = 1) then 
			nm_usuario_ww := nm_usuario_ww || substr(nm_usuario_w,1,15);
		else 
			nm_usuario_ww := nm_usuario_ww || substr(nm_usuario_w,1,1);
		end if;
		qt_xx_w := qt_xx_w + 1;
	end loop;
	 
	select	count(*) 
	into STRICT	qt_usuario_w 
	from	usuario 
	where	lower(nm_usuario) = lower(substr(nm_usuario_ww,1,15));
	 
	if (qt_usuario_w > 0) then 
		CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(279488,'NM_USUARIO='||lower(substr(nm_usuario_ww,1,15)));
	else 
		nm_usuario_p := lower(substr(nm_usuario_ww,1,15));
	end if;
	 
else 
	nm_usuario_p	:= lower(substr(nm_usuario_ww,1,15));
end if;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_usuario_padrao (cd_pessoa_fisica_p text, nm_usuario_p INOUT text) FROM PUBLIC;

