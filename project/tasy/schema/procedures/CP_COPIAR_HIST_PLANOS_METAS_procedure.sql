-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cp_copiar_hist_planos_metas ((nr_seq_prescr_p bigint, nr_seq_pat_cp_indic_p bigint, nr_seq_pat_cp_indic_ant_p bigint) IS TYPE pat_cp_indic_plan_type IS TABLE OF patient_cp_indic_plan index by integer) RETURNS bigint AS $body$
DECLARE

        nr_seq_result patient_cp_indic_plan.nr_sequencia%type := 0;

BEGIN
        FOR i IN pat_cp_indic_plan_seq_row_p.FIRST..pat_cp_indic_plan_seq_row_p.LAST LOOP
            IF pat_cp_indic_plan_seq_row_p[i].nr_sequencia_ant = nr_seq_ant_p THEN
                nr_seq_result := pat_cp_indic_plan_seq_row_p[i].nr_sequencia_new;
            END IF;
        END LOOP;
        RETURN nr_seq_result;
    END;

BEGIN

	SELECT *
	BULK COLLECT INTO STRICT pat_cp_indic_plan_row
	FROM patient_cp_indic_plan
	WHERE nr_seq_pat_cp_ind = nr_seq_pat_cp_indic_ant_p;

	SELECT *
	BULK COLLECT INTO STRICT pat_cp_indic_measure_row
	FROM patient_cp_indic_measure a
	WHERE nr_seq_pat_cp_ind = nr_seq_pat_cp_indic_ant_p;

    IF (pat_cp_indic_plan_row.FIRST IS NOT NULL AND pat_cp_indic_plan_row.FIRST::text <> '') THEN
        FOR plan_index_w IN pat_cp_indic_plan_row.FIRST..pat_cp_indic_plan_row.LAST LOOP
            plan_nr_seq_ant_w := pat_cp_indic_plan_row[plan_index_w].nr_sequencia;
            plan_nr_seq_new_w := obter_nextval_sequence('PATIENT_CP_INDIC_PLAN');

            pat_cp_indic_plan_seq_row.EXTEND;
            pat_cp_indic_plan_seq_row[plan_index_w].nr_sequencia_ant := plan_nr_seq_ant_w;
            pat_cp_indic_plan_seq_row[plan_index_w].nr_sequencia_new := plan_nr_seq_new_w;

            pat_cp_indic_plan_row[plan_index_w].nr_sequencia := plan_nr_seq_new_w;
            pat_cp_indic_plan_row[plan_index_w].nr_seq_pat_cp_ind := nr_seq_pat_cp_indic_p;
            pat_cp_indic_plan_row[plan_index_w].nr_seq_prescr := nr_seq_prescr_p;
        END LOOP;

        IF (pat_cp_indic_measure_row.FIRST IS NOT NULL AND pat_cp_indic_measure_row.FIRST::text <> '') THEN
            FOR measure_index_w IN pat_cp_indic_measure_row.FIRST..pat_cp_indic_measure_row.LAST LOOP
                pat_cp_indic_measure_row[measure_index_w].nr_seq_plan_indic := get_pat_ind_plan_seq_number(pat_cp_indic_measure_row[measure_index_w].nr_seq_plan_indic);
                pat_cp_indic_measure_row[measure_index_w].nr_sequencia := obter_nextval_sequence('PATIENT_CP_INDIC_MEASURE');
                pat_cp_indic_measure_row[measure_index_w].nr_seq_pat_cp_ind := nr_seq_pat_cp_indic_p;
                pat_cp_indic_measure_row[measure_index_w].nr_seq_prescr := nr_seq_prescr_p;
            END LOOP;
        END IF;
    END IF;

    IF (pat_cp_indic_plan_row.FIRST IS NOT NULL AND pat_cp_indic_plan_row.FIRST::text <> '') THEN
        FORALL i IN pat_cp_indic_plan_row.FIRST..pat_cp_indic_plan_row.LAST  
        INSERT INTO patient_cp_indic_plan VALUES pat_cp_indic_plan_row(i);
    END IF;

    IF (pat_cp_indic_measure_row.FIRST IS NOT NULL AND pat_cp_indic_measure_row.FIRST::text <> '') THEN
        FORALL i IN pat_cp_indic_measure_row.FIRST..pat_cp_indic_measure_row.LAST  
        INSERT INTO patient_cp_indic_measure VALUES pat_cp_indic_measure_row(i);
    END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cp_copiar_hist_planos_metas ((nr_seq_prescr_p bigint, nr_seq_pat_cp_indic_p bigint, nr_seq_pat_cp_indic_ant_p bigint) IS TYPE pat_cp_indic_plan_type IS TABLE OF patient_cp_indic_plan index by integer) FROM PUBLIC;

