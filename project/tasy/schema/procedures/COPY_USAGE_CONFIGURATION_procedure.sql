-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copy_usage_configuration (cd_src_profile_p bigint, cd_dest_profile_p bigint, cd_funcao_p bigint, ie_filter_rule_p text, ie_grid_attr_p text, ie_mouse_options_p text, ie_table_permission_rule_p text, ie_dropdown_order_rule_p text, ie_tab_view_rule_p text, ie_external_call_p text, nm_usuario_p text) AS $body$
DECLARE


    c01 CURSOR FOR
        SELECT a.nr_sequencia,
               a.nr_seq_obj_schem_param,
               a.vl_parametro,
               a.ds_observacao,
               a.cd_funcao,
               a.cd_estabelecimento,
               a.nr_seq_lote_par_regra_item
          from obj_schem_perfil       a,
               objeto_schematic_param b,
               objeto_schematic       c
         where b.nr_sequencia = a.nr_seq_obj_schem_param
           and c.nr_sequencia = b.nr_seq_obj_sch
           and c.ie_tipo_objeto in ('T', 'DDM')
           and a.cd_perfil = cd_src_profile_p
           and coalesce(cd_funcao_p, c.cd_funcao) = c.cd_funcao;

    c02 CURSOR FOR
        SELECT a.nr_sequencia,
               a.nr_seq_obj_schem_param,
               a.vl_parametro,
               a.ds_observacao,
               a.cd_funcao,
               a.cd_estabelecimento,
               a.nr_seq_lote_par_regra_item
          from obj_schem_perfil       a,
               objeto_schematic_param b,
               objeto_schematic       c
         where b.nr_sequencia = a.nr_seq_obj_schem_param
           and c.nr_sequencia = b.nr_seq_obj_sch
           and c.ie_tipo_objeto = 'C'
           and c.ie_tipo_componente = 'WAE'
           and a.cd_perfil = cd_src_profile_p
           and coalesce(cd_funcao_p, c.cd_funcao) = c.cd_funcao;

    c03 CURSOR FOR
        SELECT nr_sequencia,
               nr_seq_wfiltro,
               cd_estabelecimento,
               nm_usuario_regra,
               nr_seq_lote_par_regra_item
          from wfiltro_atrib_regra a
         where cd_perfil = cd_src_profile_p
           and not exists (SELECT 1
                  from wfiltro_atrib_regra x
                 where x.cd_perfil = cd_dest_profile_p
                   and coalesce(a.cd_estabelecimento, 0) = coalesce(x.cd_estabelecimento, 0)
                   and coalesce(a.nm_usuario_regra, 0) = coalesce(x.nm_usuario_regra, 0)
                   and a.nr_seq_wfiltro = x.nr_seq_wfiltro)
           and ((cd_funcao_p = (select max(b.cd_funcao)
                                  from dic_objeto        b,
                                       dic_objeto_filtro c
                                 where b.nr_sequencia = c.nr_seq_objeto
                                   and c.nr_sequencia = a.nr_seq_wfiltro)) or coalesce(cd_funcao_p::text, '') = '');

    c04 CURSOR FOR
        SELECT a.nr_sequencia,
               a.nr_seq_wcpanel,
               a.nr_seq_atributo,
               a.nm_usuario_regra,
               a.ie_exibir_atributo,
               a.ds_titulo,
               a.ie_sensitive,
               a.ie_patient_info
          from wcp_regra_atributo a,
               dic_objeto         b
         where cd_perfil = cd_src_profile_p
           and b.nr_sequencia = a.nr_seq_wcpanel
           and coalesce(cd_funcao_p, cd_funcao) = cd_funcao;

    new_seq_w          bigint;
    nr_sequencia_rem_w bigint;

  r RECORD;
BEGIN

    /* Tables configure only profile:
    obj_schem_perfil(UK)
    obj_schem_order_perfil
    */


    /* Tables configure many things:
    tabela_crud_param
    funcao_popup_regra
    wfiltro_atrib_regra
    wcp_regra_atributo(UK)
    */


    /* copies the profile tab visualization */

    if ie_tab_view_rule_p = 'S' then
        for c01_w in c01 loop
            begin

                $if $$tasy_local_dict=true $then
                nr_sequencia_rem_w := get_remote_sequence('seq:obj_schem_perfil_seq');
                $else
                select nextval('obj_schem_perfil_seq') into STRICT nr_sequencia_rem_w;
                $end

                insert into obj_schem_perfil(nr_sequencia,
                     dt_atualizacao,
                     nm_usuario,
                     dt_atualizacao_nrec,
                     nm_usuario_nrec,
                     nr_seq_obj_schem_param,
                     cd_perfil,
                     vl_parametro,
                     ds_observacao,
                     cd_funcao,
                     cd_estabelecimento,
                     nr_seq_lote_par_regra_item)
                values (nr_sequencia_rem_w, --obj_schem_perfil_seq.nextval,
                     clock_timestamp(),
                     nm_usuario_p,
                     clock_timestamp(),
                     nm_usuario_p,
                     c01_w.nr_seq_obj_schem_param,
                     cd_dest_profile_p,
                     c01_w.vl_parametro,
                     c01_w.ds_observacao,
                     c01_w.cd_funcao,
                     c01_w.cd_estabelecimento,
                     c01_w.nr_seq_lote_par_regra_item);
            exception
                when others then
                    null;
            end;
        end loop;
    end if;

    /*   copies the profile external call rules   */

    if ie_external_call_p = 'S' then
        for c02_w in c02 loop
            begin

                $if $$tasy_local_dict=true $then
                nr_sequencia_rem_w := get_remote_sequence('seq:obj_schem_perfil_seq');
                $else
                select nextval('obj_schem_perfil_seq') into STRICT nr_sequencia_rem_w;
                $end

                insert into obj_schem_perfil(nr_sequencia,
                     dt_atualizacao,
                     nm_usuario,
                     dt_atualizacao_nrec,
                     nm_usuario_nrec,
                     nr_seq_obj_schem_param,
                     cd_perfil,
                     vl_parametro,
                     ds_observacao,
                     cd_funcao,
                     cd_estabelecimento,
                     nr_seq_lote_par_regra_item)
                values (nr_sequencia_rem_w, --obj_schem_perfil_seq.nextval,
                     clock_timestamp(),
                     nm_usuario_p,
                     clock_timestamp(),
                     nm_usuario_p,
                     c02_w.nr_seq_obj_schem_param,
                     cd_dest_profile_p,
                     c02_w.vl_parametro,
                     c02_w.ds_observacao,
                     c02_w.cd_funcao,
                     c02_w.cd_estabelecimento,
                     c02_w.nr_seq_lote_par_regra_item);
            exception
                when others then
                    null;
            end;
        end loop;
    end if;

    /*  copies the profile tab rule order  */

    if ie_dropdown_order_rule_p = 'S' then
        for r in (SELECT nr_seq_regra,
                         cd_dest_profile_p,
                         nr_seq_lote_par_regra_item
                    from obj_schem_order_perfil a
                   where cd_perfil = cd_src_profile_p
                     and not exists (select 1
                            from obj_schem_order_perfil x
                           where x.cd_perfil = cd_dest_profile_p
                             and x.nr_seq_regra = a.nr_seq_regra)
                     and ((cd_funcao_p = (select max(cd_funcao)
                                            from objeto_schematic b,
                                                 obj_schem_order  c
                                           where b.nr_sequencia = nr_seq_obj_schematic
                                             and c.nr_sequencia = a.nr_seq_regra)) or coalesce(cd_funcao_p::text, '') = '')) loop

            $if $$tasy_local_dict=true $then
            nr_sequencia_rem_w := get_remote_sequence('seq:obj_schem_order_perfil_seq');
            $else
            select nextval('obj_schem_order_perfil_seq') into STRICT nr_sequencia_rem_w;
            $end

            insert into obj_schem_order_perfil(nr_sequencia,
                 dt_atualizacao,
                 nm_usuario,
                 dt_atualizacao_nrec,
                 nm_usuario_nrec,
                 nr_seq_regra,
                 cd_perfil,
                 nr_seq_lote_par_regra_item)
            values (nr_sequencia_rem_w, --obj_schem_order_perfil_seq.nextval,
                 clock_timestamp(),
                 nm_usuario_p,
                 clock_timestamp(),
                 nm_usuario_p,
                 r.nr_seq_regra,
                 r.cd_dest_profile_p,
                 r.nr_seq_lote_par_regra_item);
        end loop;
    end if;

    /*  copies the table permissions rules  */

    if ie_table_permission_rule_p = 'S' then
        for r in (SELECT a.cd_estabelecimento,
                         a.nm_tabela,
                         a.nr_seq_visao,
                         a.nr_seq_obj_schematic,
                         a.ie_insert,
                         a.ie_update,
                         a.ie_delete,
                         a.ie_duplicar,
                         a.ds_observacao,
                         a.nm_usuario_param,
                         a.ie_aplicar_filhos,
                         a.ie_inativar,
                         a.nr_seq_lote_par_regra_item
                    from tabela_crud_param a,
                         objeto_schematic  b
                   where b.nr_sequencia = a.nr_seq_obj_schematic
                     and cd_perfil = cd_src_profile_p
                     and not exists (select 1
                            from tabela_crud_param x
                           where x.cd_perfil = cd_dest_profile_p
                             and coalesce(a.cd_estabelecimento, 0) = coalesce(x.cd_estabelecimento, 0)
                             and coalesce(a.nm_usuario_param, 0) = coalesce(x.nm_usuario_param, 0)
                             and a.nr_seq_obj_schematic = x.nr_seq_obj_schematic
                             and a.nm_tabela = x.nm_tabela)
                     and coalesce(cd_funcao_p, cd_funcao) = cd_funcao) loop

            $if $$tasy_local_dict=true $then
            nr_sequencia_rem_w := get_remote_sequence('seq:tabela_crud_param_seq');
            $else
            select nextval('tabela_crud_param_seq') into STRICT nr_sequencia_rem_w;
            $end

            insert into tabela_crud_param(nr_sequencia,
                 cd_estabelecimento,
                 dt_atualizacao,
                 nm_usuario,
                 dt_atualizacao_nrec,
                 nm_usuario_nrec,
                 nm_tabela,
                 nr_seq_visao,
                 nr_seq_obj_schematic,
                 ie_insert,
                 ie_update,
                 ie_delete,
                 ie_duplicar,
                 ds_observacao,
                 cd_perfil,
                 nm_usuario_param,
                 ie_aplicar_filhos,
                 ie_inativar,
                 nr_seq_lote_par_regra_item)
            values (nr_sequencia_rem_w, --tabela_crud_param_seq.nextval,
                 r.cd_estabelecimento,
                 clock_timestamp(),
                 nm_usuario_p,
                 clock_timestamp(),
                 nm_usuario_p,
                 r.nm_tabela,
                 r.nr_seq_visao,
                 r.nr_seq_obj_schematic,
                 r.ie_insert,
                 r.ie_update,
                 r.ie_delete,
                 r.ie_duplicar,
                 r.ds_observacao,
                 cd_dest_profile_p,
                 r.nm_usuario_param,
                 r.ie_aplicar_filhos,
                 r.ie_inativar,
                 r.nr_seq_lote_par_regra_item);
        end loop;
    end if;

    /*  Copies the mouse option rules  */

    if ie_mouse_options_p = 'S' then
        for r in (SELECT a.cd_estabelecimento,
                         a.nm_usuario_regra,
                         a.cd_funcao,
                         a.nr_seq_objeto,
                         a.ie_enable,
                         a.ie_visible,
                         a.ie_tipo_regra,
                         a.nr_seq_apresent,
                         a.nr_seq_lote_par_regra_item
                    from funcao_popup_regra a,
                         dic_objeto         b
                   where a.nr_seq_objeto = b.nr_sequencia
                     and cd_perfil = cd_src_profile_p
                     and not exists (select 1
                            from funcao_popup_regra x
                           where x.cd_perfil = cd_dest_profile_p
                             and coalesce(a.nm_usuario_regra, 0) = coalesce(x.nm_usuario_regra, 0)
                             and a.nr_seq_objeto = x.nr_seq_objeto)
                     and coalesce(cd_funcao_p, b.cd_funcao) = b.cd_funcao) loop

            $if $$tasy_local_dict=true $then
            nr_sequencia_rem_w := get_remote_sequence('seq:funcao_popup_regra_seq');
            $else
            select nextval('funcao_popup_regra_seq') into STRICT nr_sequencia_rem_w;
            $end

            insert into funcao_popup_regra(nr_sequencia,
                 cd_estabelecimento,
                 dt_atualizacao,
                 nm_usuario,
                 dt_atualizacao_nrec,
                 nm_usuario_nrec,
                 nm_usuario_regra,
                 cd_perfil,
                 cd_funcao,
                 nr_seq_objeto,
                 ie_enable,
                 ie_visible,
                 ie_tipo_regra,
                 nr_seq_apresent,
                 nr_seq_lote_par_regra_item)
            values (nr_sequencia_rem_w, --funcao_popup_regra_seq.nextval,
                 r.cd_estabelecimento,
                 clock_timestamp(),
                 nm_usuario_p,
                 clock_timestamp(),
                 nm_usuario_p,
                 r.nm_usuario_regra,
                 cd_dest_profile_p,
                 r.cd_funcao,
                 r.nr_seq_objeto,
                 r.ie_enable,
                 r.ie_visible,
                 r.ie_tipo_regra,
                 r.nr_seq_apresent,
                 r.nr_seq_lote_par_regra_item);
        end loop;
    end if;

    /* copies the filter attribute rules */

    if ie_filter_rule_p = 'S' then
        for c03_w in c03 loop

            $if $$tasy_local_dict=true $then
            new_seq_w := get_remote_sequence('seq:wfiltro_atrib_regra_seq');
            $else
            select nextval('wfiltro_atrib_regra_seq') into STRICT new_seq_w;
            $end

            insert into wfiltro_atrib_regra(nr_sequencia,
                 dt_atualizacao,
                 nm_usuario,
                 dt_atualizacao_nrec,
                 nm_usuario_nrec,
                 nr_seq_wfiltro,
                 cd_estabelecimento,
                 cd_perfil,
                 nm_usuario_regra,
                 nr_seq_lote_par_regra_item)
            values (new_seq_w,
                 clock_timestamp(),
                 nm_usuario_p,
                 clock_timestamp(),
                 nm_usuario_p,
                 c03_w.nr_seq_wfiltro,
                 c03_w.cd_estabelecimento,
                 cd_dest_profile_p,
                 c03_w.nm_usuario_regra,
                 c03_w.nr_seq_lote_par_regra_item);

            for r in (SELECT cd_item,
                             ie_configuracao,
                             vl_minimo,
                             vl_maximo,
                             ie_tipo_calculo,
                             ds_msg_aviso,
                             vl_padrao,
                             ie_obrigatorio,
                             ie_habilitado,
                             ds_script,
                             ie_tipo_script,
                             nr_seq_lote_par_regra_item
                        from wfiltro_atrib_regra_item
                       where nr_seq_atrib_regra = c03_w.nr_sequencia) loop
                $if $$tasy_local_dict=true $then
                nr_sequencia_rem_w := get_remote_sequence('seq:wfiltro_atrib_regra_item_seq');
                $else
                select nextval('wfiltro_atrib_regra_item_seq') into STRICT nr_sequencia_rem_w;
                $end

                insert into wfiltro_atrib_regra_item(nr_sequencia,
                     cd_item,
                     ie_configuracao,
                     dt_atualizacao,
                     nm_usuario,
                     dt_atualizacao_nrec,
                     nm_usuario_nrec,
                     nr_seq_atrib_regra,
                     vl_minimo,
                     vl_maximo,
                     ie_tipo_calculo,
                     ds_msg_aviso,
                     vl_padrao,
                     ie_obrigatorio,
                     ie_habilitado,
                     ds_script,
                     ie_tipo_script,
                     nr_seq_lote_par_regra_item)
                values (nr_sequencia_rem_w, --wfiltro_atrib_regra_item_seq.nextval,
                     r.cd_item,
                     r.ie_configuracao,
                     clock_timestamp(),
                     nm_usuario_p,
                     clock_timestamp(),
                     nm_usuario_p,
                     new_seq_w,
                     r.vl_minimo,
                     r.vl_maximo,
                     r.ie_tipo_calculo,
                     r.ds_msg_aviso,
                     r.vl_padrao,
                     r.ie_obrigatorio,
                     r.ie_habilitado,
                     r.ds_script,
                     r.ie_tipo_script,
                     r.nr_seq_lote_par_regra_item);
            end loop;

        end loop;
    end if;

    /* Copies the CPanel  attribute rules */

    if ie_grid_attr_p = 'S' then
        for c04_w in c04 loop
            begin

                $if $$tasy_local_dict=true $then
                nr_sequencia_rem_w := get_remote_sequence('seq:wcp_regra_atributo_seq');
                $else
                select nextval('wcp_regra_atributo_seq') into STRICT nr_sequencia_rem_w;
                $end

                insert into wcp_regra_atributo(nr_sequencia,
                     dt_atualizacao_nrec,
                     nm_usuario_nrec,
                     dt_atualizacao,
                     nm_usuario,
                     nr_seq_wcpanel,
                     nr_seq_atributo,
                     nm_usuario_regra,
                     cd_perfil,
                     ie_exibir_atributo,
                     ds_titulo,
                     ie_sensitive,
                     ie_patient_info)
                values (nr_sequencia_rem_w, --wcp_regra_atributo_seq.nextval,
                     clock_timestamp(),
                     nm_usuario_p,
                     clock_timestamp(),
                     nm_usuario_p,
                     c04_w.nr_seq_wcpanel,
                     c04_w.nr_seq_atributo,
                     c04_w.nm_usuario_regra,
                     cd_dest_profile_p,
                     c04_w.ie_exibir_atributo,
                     c04_w.ds_titulo,
                     c04_w.ie_sensitive,
                     c04_w.ie_patient_info);
            exception
                when others then
                    null;
            end;
        end loop;
    end if;

    commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copy_usage_configuration (cd_src_profile_p bigint, cd_dest_profile_p bigint, cd_funcao_p bigint, ie_filter_rule_p text, ie_grid_attr_p text, ie_mouse_options_p text, ie_table_permission_rule_p text, ie_dropdown_order_rule_p text, ie_tab_view_rule_p text, ie_external_call_p text, nm_usuario_p text) FROM PUBLIC;

