-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_estoque_requisicao ( nr_requisicao_p bigint, nr_sequencia_p bigint, qt_atendida_p bigint, nm_usuario_p text, cd_mat_lido_p bigint, nr_seq_lote_lido_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE



ie_entrada_saida_w			varchar(01);
ie_consignado_w			varchar(01);
cd_local_estoque_w		smallint;
cd_local_estoque_dest_w		smallint;
cd_local_teste_W			smallint;
cd_estabelecimento_w		smallint;
qt_saldo_requisicao_w		double precision;
qt_conv_estoque_consumo_w	double precision;
qt_saldo_estoque_w		double precision;
cd_cgc_fornecedor_w		varchar(14);
cd_material_w			integer;
cd_material_estoque_w		integer;
ie_operacao_consignado_w		varchar(01);
ie_tipo_requisicao_w		varchar(03);
dt_mesano_referencia_w		timestamp;
ds_material_w			varchar(255);
ie_material_estoque_w		varchar(01);
ie_local_valido_w			varchar(01);
ie_permite_w			varchar(01);
cd_centro_custo_w			integer;
cd_operacao_estoque_w		operacao_estoque.cd_operacao_estoque%type;
VarConsisteMaterialCCusto_w		varchar(01);
VarConsisteMaterialLocal_w		varchar(01);
VarPermiteQtMaiorPadrao_w		varchar(01);
cd_cgc_w			varchar(14);
ie_estoque_lote_w			varchar(1);
ie_forma_consistencia_w		varchar(1);
ds_erro_w			varchar(255);
ie_disp_req_trans_w		varchar(1);
qt_requisicao_transf_w		double precision;
ds_observacao_w			varchar(255);
ie_tipo_saldo_w			varchar(1);
nr_seq_regra_w		bigint;
ie_apresentar_msg	varchar(01) := 'S';
ie_requisicao_transferencia_w	varchar(1) := 'N';


BEGIN
				
select	a.cd_local_estoque,
	a.cd_local_estoque_destino,
	b.ie_entrada_saida,
	coalesce(b.ie_consignado,'0'),
	b.ie_tipo_requisicao,
	a.cd_centro_custo,
	a.cd_operacao_estoque
into STRICT	cd_local_estoque_w,
	cd_local_estoque_dest_w,
	ie_entrada_saida_w,
	ie_operacao_consignado_w,
	ie_tipo_requisicao_w,
	cd_centro_custo_w,
	cd_operacao_estoque_w
from	operacao_estoque b,
	requisicao_material a
where	a.cd_operacao_estoque	= b.cd_operacao_estoque
and	a.nr_requisicao		= nr_requisicao_p;

select	cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	local_estoque
where	cd_local_estoque = cd_local_estoque_w;

select	coalesce(max(IE_REGRA_SALDO_CONSIG),0)
into STRICT	nr_seq_regra_w
from	parametro_estoque
where	cd_estabelecimento = cd_estabelecimento_w;

select 	max(cd_cgc_fornec)
into STRICT	cd_cgc_fornecedor_w
from 	material_lote_fornec 
where 	nr_sequencia = nr_seq_lote_lido_p;

select	coalesce(b.ie_consignado,'X'),
	a.qt_material_requisitada - coalesce(a.qt_material_atendida,0),
	coalesce(cd_cgc_fornecedor_w, a.cd_cgc_fornecedor),
	coalesce(a.cd_material_lido, a.cd_material),
	b.cd_material_estoque,
	coalesce(b.qt_conv_estoque_consumo,1),
	substr(obter_se_material_estoque(cd_estabelecimento_w, 0, coalesce(a.cd_material_lido, a.cd_material)),1,1)
into STRICT	ie_consignado_w,
	qt_saldo_requisicao_w,
	cd_cgc_fornecedor_w,
	cd_material_w,
	cd_material_estoque_w,
	qt_conv_estoque_consumo_w,
	ie_material_estoque_w
from	material b,
	item_requisicao_material a
where	coalesce(a.cd_material_lido, a.cd_material) = b.cd_material
and	a.nr_requisicao		= nr_requisicao_p
and	a.nr_sequencia		= nr_sequencia_p;

if (qt_atendida_p IS NOT NULL AND qt_atendida_p::text <> '') then
	qt_saldo_requisicao_w	:= qt_atendida_p;
end if;

select	coalesce(max(ie_estoque_lote),'N')
into STRICT	ie_estoque_lote_w
from	material_estab
where	cd_material = cd_material_w
and	cd_estabelecimento = cd_estabelecimento_w;

if (cd_mat_lido_p <> 0) then
	cd_material_w	:=	cd_mat_lido_p;
end if;

qt_saldo_requisicao_w		:= dividir(qt_saldo_requisicao_w, qt_conv_estoque_consumo_w);

select 	max(dt_mesano_vigente),
	max(ie_disp_req_trans)
into STRICT 	dt_mesano_referencia_w,
	ie_disp_req_trans_w
from 	Parametro_estoque
where 	cd_estabelecimento = cd_estabelecimento_w;

cd_local_teste_w := 0;

/* Tratamento transferencia entre locais Mexico */

if (ie_tipo_requisicao_w in ('2','21')) then
	ie_requisicao_transferencia_w := 'S';
else
	ie_requisicao_transferencia_w := obter_se_transf_local_mexico(
							cd_estabelecimento_p	=> cd_estabelecimento_w,
							cd_operacao_estoque_p	=> cd_operacao_estoque_w);
end if;

if (ie_requisicao_transferencia_w = 'S') then
	if (ie_entrada_saida_w = 'S') then
		cd_local_teste_W	:= cd_local_estoque_w;
	elsif (cd_local_estoque_dest_w IS NOT NULL AND cd_local_estoque_dest_w::text <> '') then
		cd_local_teste_W	:= cd_local_estoque_dest_w;
	else
		--Nao informado o local de destino!
		CALL wheb_mensagem_pck.exibir_mensagem_abort(239632);
	end if;	
elsif (ie_tipo_requisicao_w in ('1', '3','8')) and (ie_entrada_saida_w = 'S') then
	cd_local_teste_W	:= cd_local_estoque_w;
end if;

VarConsisteMaterialCCusto_w	:= substr(coalesce(obter_valor_param_usuario(919, 4, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w),'N'),1,1);
VarConsisteMaterialLocal_w	:= substr(coalesce(obter_valor_param_usuario(919, 5, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w),'N'),1,1);
VarPermiteQtMaiorPadrao_w	:= substr(coalesce(obter_valor_param_usuario(919, 69, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w),'N'),1,1);
ie_forma_consistencia_w	:= substr(coalesce(obter_valor_param_usuario(919, 16, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w),'N'),1,1);

if (ie_forma_consistencia_w <> 'M') then
	ie_forma_consistencia_w := 'C';
end if;


SELECT * FROM Consistir_item_Requisicao(
	cd_material_w, nr_requisicao_p, VarConsisteMaterialCCusto_w, 'N', VarConsisteMaterialLocal_w, 'N', VarPermiteQtMaiorPadrao_w, 'S', nm_usuario_p, 'N', cd_cgc_w, ds_erro_w) INTO STRICT cd_cgc_w, ds_erro_w;

if (ie_material_estoque_w	= 'S') then
	begin
	if (cd_local_teste_w	<> 0) then
		begin
		
		select	substr(ds_material,1,255)
		into STRICT	ds_material_w
		from	material	
		where	cd_material	= cd_material_w;

		if (ie_operacao_consignado_W = '0') and (ie_consignado_w = '1') then
			--O material e consignado e a operacao nao e consignada!
			CALL wheb_mensagem_pck.exibir_mensagem_abort(239623);
		elsif (ie_operacao_consignado_W <> '0') and (ie_consignado_w	= '0') then
			--O material nao e consignado e a operacao e consignada!
			CALL wheb_mensagem_pck.exibir_mensagem_abort(239631);
		end if;
		
		if (ie_consignado_w = '2' and nr_seq_regra_w > 0 and coalesce(cd_cgc_fornecedor_w::text, '') = '') then
			begin
			SELECT * FROM obter_fornec_consig_ambos(cd_estabelecimento_w, cd_material_estoque_w, nr_seq_lote_lido_p, cd_local_estoque_w, ie_tipo_saldo_w, cd_cgc_fornecedor_w) INTO STRICT ie_tipo_saldo_w, cd_cgc_fornecedor_w;

			if (ie_tipo_saldo_w = 'C') and (cd_cgc_fornecedor_w IS NOT NULL AND cd_cgc_fornecedor_w::text <> '') then
				ie_operacao_consignado_w := '1';
			end if;
			end;
		elsif (ie_consignado_w = '2' and nr_seq_regra_w > 0 and (cd_cgc_fornecedor_w IS NOT NULL AND cd_cgc_fornecedor_w::text <> '')) then
			ie_operacao_consignado_w := '1';
		end if;

		if (ie_consignado_w = 'X') then
			ds_erro_w := substr(WHEB_MENSAGEM_PCK.get_texto(280505) || cd_material_w || ' - ' || ds_material_w ||
								WHEB_MENSAGEM_PCK.get_texto(280506),1,255);
			CALL gravar_consistencia_requisicao(
						nr_requisicao_p, cd_material_w,'1',
						WHEB_MENSAGEM_PCK.get_texto(280507),
						'C',WHEB_MENSAGEM_PCK.get_texto(280508), nm_usuario_p);
		elsif (ie_operacao_consignado_w = '0') or
			((ie_operacao_consignado_w <> '0') and (ie_consignado_w = '2') and (coalesce(cd_cgc_fornecedor_w::text, '') = '')) then
			begin
			if (ie_estoque_lote_w = 'S') and (coalesce(nr_seq_lote_lido_p,0) > 0) then
				qt_saldo_estoque_w := obter_saldo_estoque_lote(
						cd_estabelecimento_w,
						cd_material_w,
						cd_local_teste_w,
						trunc(clock_timestamp(),'month'),
						nr_seq_lote_lido_p);
			else
				begin					
				if (ie_consignado_w = '2' and nr_seq_regra_w >0 )then
				begin
					qt_saldo_estoque_w := Obter_Saldo_Total_Consig(cd_estabelecimento_w, cd_material_w, cd_local_teste_w, null, null);
				end;
				else
				begin
					select	coalesce(obter_saldo_disp_estoque(cd_estabelecimento_w, cd_material_w, cd_local_teste_w, trunc(clock_timestamp(),'month')),0)
					into STRICT	qt_saldo_estoque_w
					;				
				end;
				end if;

				if (ie_disp_req_trans_w = 'S') and (ie_tipo_requisicao_w = '2')  then
					begin
					/*Sidnei - 17/09/2011 - OS 353667
					Tratamento necessario, pois se for considerado a quantidade em requisicao no disponiovel, esta quantidade sera diminuida na function obter_saldo_disp_estoque. 
					O local tem estoque disponivel, mas foi diminuido para atender a requisicao*/
					select	coalesce(sum(a.qt_estoque), 0) - coalesce(sum(a.qt_material_atendida), 0) qt_material
					into STRICT	qt_requisicao_transf_w
					from	operacao_estoque o,
						requisicao_material b,
						item_requisicao_material a
					where	a.nr_requisicao		= b.nr_requisicao
					and	b.cd_operacao_estoque	= o.cd_operacao_estoque
					and	b.cd_estabelecimento	= cd_estabelecimento_w
					and	b.cd_local_estoque	= cd_local_teste_w
					and	o.ie_tipo_requisicao	= '2'
					and	obter_tipo_motivo_baixa_req(a.cd_motivo_baixa)		= 0
					and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
					and	a.cd_material in (
						SELECT	x.cd_material
						from	material x
						where	x.cd_material_estoque = cd_material_w);
						
					qt_saldo_estoque_w := qt_saldo_estoque_w + qt_requisicao_transf_w;
					end;
				end if;
			
				if (ie_disp_req_trans_w = 'S') and (ie_tipo_requisicao_w = '21')  then
					begin
					/*Sidnei - 17/09/2011 - OS 353667
					Tratamento necessario, pois se for considerado a quantidade em requisicao no disponivel, esta quantidade sera diminuida na function obter_saldo_disp_estoque. 
					O local tem estoque disponivel, mas foi diminuido para atender a requisicao*/
					select	coalesce(sum(a.qt_estoque), 0) - coalesce(sum(a.qt_material_atendida), 0) qt_material
					into STRICT	qt_requisicao_transf_w
					from	operacao_estoque o,
						requisicao_material b,
						item_requisicao_material a
					where	a.nr_requisicao		= b.nr_requisicao
					and	b.cd_operacao_estoque	= o.cd_operacao_estoque
					and	b.cd_estabelecimento	= cd_estabelecimento_w
					and	b.cd_local_estoque	= cd_local_teste_w
					and	o.ie_tipo_requisicao	= '21'
					and	obter_tipo_motivo_baixa_req(a.cd_motivo_baixa)		= 0
					and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
					and	a.cd_material in (
						SELECT	x.cd_material
						from	material x
						where	x.cd_material_estoque = cd_material_w);
						
					qt_saldo_estoque_w := qt_saldo_estoque_w + qt_requisicao_transf_w;
					end;
				end if;
				end;
			end if;
			
			if (ie_consignado_w = '2' and nr_seq_regra_w > 0 AND qt_saldo_estoque_w > 0)then
			begin
				ie_apresentar_msg := 'N';
			end;
			end if;
			if	(qt_saldo_estoque_w < qt_saldo_requisicao_w AND ie_apresentar_msg = 'S') then	

				ds_erro_w := substr(WHEB_MENSAGEM_PCK.get_texto(280505) || cd_material_w || ' - ' || ds_material_w ||
									WHEB_MENSAGEM_PCK.get_texto(280509) || 
									WHEB_MENSAGEM_PCK.get_texto(280510) ||	qt_saldo_requisicao_w || '/' || 
									WHEB_MENSAGEM_PCK.get_texto(819384) || ': ' || qt_saldo_estoque_w || ').' || chr(13) || chr(10),1,255);
				ds_observacao_w := substr(WHEB_MENSAGEM_PCK.get_texto(280513) || chr(13) || chr(10) ||
						WHEB_MENSAGEM_PCK.get_texto(280514) 	|| obter_desc_local_estoque(cd_local_teste_w)		|| chr(13) || chr(10) ||
						WHEB_MENSAGEM_PCK.get_texto(280515) 	|| qt_saldo_requisicao_w 			|| chr(13) || chr(10) ||
						WHEB_MENSAGEM_PCK.get_texto(280516) 	|| qt_saldo_estoque_w,1,255);
				CALL gravar_consistencia_requisicao(
					nr_requisicao_p, cd_material_w,'1',
					WHEB_MENSAGEM_PCK.get_texto(280517),
					ie_forma_consistencia_w, ds_observacao_w, nm_usuario_p);
				if (wheb_usuario_pck.get_cd_funcao = '919') then
					CALL enviar_email_consist_req(nm_usuario_p, cd_estabelecimento_w, nr_requisicao_p, nr_sequencia_p, ds_erro_w || chr(13) || chr(10) || ds_observacao_w);
				end if;
			end if;		
			end;
		else
			begin
			if (ie_consignado_w = '2' and nr_seq_regra_w >0 )then
			begin
				qt_saldo_estoque_w := Obter_Saldo_Total_Consig(cd_estabelecimento_w, cd_material_w, cd_local_teste_w, null, null);
			end;
			elsif (ie_estoque_lote_w = 'S') and (coalesce(nr_seq_lote_lido_p,0) > 0) then
			begin
				select	coalesce(sum(a.qt_estoque),0)
				into STRICT	qt_saldo_estoque_w
				from	fornecedor_mat_consig_lote a
				where	a.cd_estabelecimento	= cd_estabelecimento_w
				and	a.cd_local_estoque	= cd_local_teste_w
				and	a.cd_fornecedor		= cd_cgc_fornecedor_w
				and	a.cd_material		= cd_material_estoque_w
				and	a.nr_seq_lote 		= nr_seq_lote_lido_p
				and	a.dt_mesano_referencia	=
				       (SELECT	max(x.dt_mesano_referencia)
					from	fornecedor_mat_consig_lote x
					where	x.cd_estabelecimento    = a.cd_estabelecimento
					and	x.cd_local_estoque      = a.cd_local_estoque
					and	x.cd_fornecedor         = a.cd_fornecedor
					and	x.cd_material           = a.cd_material
					and	x.nr_seq_lote	   	= a.nr_seq_lote
					and	x.dt_mesano_referencia  >= dt_mesano_referencia_w);
				
			end;
			else
			begin
				select	coalesce(sum(a.qt_estoque),0)
				into STRICT	qt_saldo_estoque_w
				from	fornecedor_mat_consignado a
				where	a.cd_estabelecimento	= cd_estabelecimento_w
				and	a.cd_local_estoque	= cd_local_teste_w
				and	a.cd_fornecedor	= cd_cgc_fornecedor_w
				and	a.cd_material		= cd_material_estoque_w
				and	a.dt_mesano_referencia	=
				       (SELECT max(x.dt_mesano_referencia)
					from    fornecedor_mat_consignado x
					where      x.cd_estabelecimento    = a.cd_estabelecimento
					and        x.cd_local_estoque      = a.cd_local_estoque
					and        x.cd_fornecedor         = a.cd_fornecedor
					and        x.cd_material           = a.cd_material
					and        x.dt_mesano_referencia  >= dt_mesano_referencia_w);
			end;
			end if;
			
			if (ie_consignado_w = '2' and nr_seq_regra_w > 0 AND qt_saldo_estoque_w > 0)then
			begin
				ie_apresentar_msg := 'N';
			end;
			end if;
			
			if	(qt_saldo_estoque_w < qt_saldo_requisicao_w AND ie_apresentar_msg = 'S') then
				ds_erro_w := substr(WHEB_MENSAGEM_PCK.get_texto(280505) || cd_material_w || ' - ' || ds_material_w || 	WHEB_MENSAGEM_PCK.get_texto(280518) || chr(13) || chr(10),1,255);
				ds_observacao_w := substr(WHEB_MENSAGEM_PCK.get_texto(280519) || chr(13) || chr(10) ||
						WHEB_MENSAGEM_PCK.get_texto(280514) 	|| obter_desc_local_estoque(cd_local_teste_w)		|| chr(13) || chr(10) ||
						WHEB_MENSAGEM_PCK.get_texto(280520) 	|| cd_cgc_fornecedor_w				|| chr(13) || chr(10) ||
						WHEB_MENSAGEM_PCK.get_texto(280521)  	|| qt_saldo_requisicao_w 				|| chr(13) || chr(10) ||
						WHEB_MENSAGEM_PCK.get_texto(280523) 	|| qt_saldo_estoque_w,1,255);
				CALL gravar_consistencia_requisicao(
					nr_requisicao_p, cd_material_w,'1',
					WHEB_MENSAGEM_PCK.get_texto(280517),
					ie_forma_consistencia_w, ds_observacao_w, nm_usuario_p);
				if (wheb_usuario_pck.get_cd_funcao = '919') then
					CALL enviar_email_consist_req(nm_usuario_p, cd_estabelecimento_w, nr_requisicao_p, nr_sequencia_p, ds_erro_w || chr(13) || chr(10) || ds_observacao_w);
				end if;				
			end if;
			end;
		end if;
		end;
	end if;
	end;
end if;
ds_erro_p := ds_erro_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_estoque_requisicao ( nr_requisicao_p bigint, nr_sequencia_p bigint, qt_atendida_p bigint, nm_usuario_p text, cd_mat_lido_p bigint, nr_seq_lote_lido_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

