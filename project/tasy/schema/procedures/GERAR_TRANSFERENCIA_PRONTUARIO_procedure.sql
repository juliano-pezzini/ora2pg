-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_transferencia_prontuario ( nm_usuario_p text, ds_lista_prontuario_p text, cd_pessoa_origem_p text, cd_pessoa_destino_p text, cd_setor_origem_p bigint, cd_setor_destino_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_sequencia_w			bigint;
nr_prontuario_w			bigint;
nr_atendimento_w			bigint;
cd_pessoa_fisica_paciente_w		varchar(10);
ds_parametro_w			varchar(10) := obter_valor_param_usuario(941,103,obter_perfil_ativo,nm_usuario_p,cd_estabelecimento_p);

c01 CURSOR FOR
SELECT	nr_sequencia
from	same_prontuario
where 	obter_se_contido(nr_sequencia, '(' || ds_lista_prontuario_p || ')') = 'S'
and	((ds_parametro_w = 'N') or (cd_estabelecimento = cd_estabelecimento_p));


BEGIN

open c01;
loop
fetch c01 into
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin


	select 	max(obter_prontuario_pf(cd_estabelecimento, cd_pessoa_fisica)),
		max(nr_atendimento),
		max(cd_pessoa_fisica)
	into STRICT	nr_prontuario_w,
		nr_atendimento_w,
		cd_pessoa_fisica_paciente_w
	from	same_prontuario
	where	nr_sequencia = nr_sequencia_w;

	CALL consiste_pront_transf_pendente(cd_pessoa_fisica_paciente_w, nr_atendimento_w, null);

	insert into transf_prontuario(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_pessoa_origem,
		cd_pessoa_destino,
		cd_setor_origem,
		cd_setor_destino,
		nr_prontuario,
		nr_atendimento,
		cd_pessoa_fisica,
		dt_envio,
		cd_estabelecimento)
	values (	nextval('transf_prontuario_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_pessoa_origem_p,
		cd_pessoa_destino_p,
		cd_setor_origem_p,
		cd_setor_destino_p,
		nr_prontuario_w,
		nr_atendimento_w,
		cd_pessoa_fisica_paciente_w,
		clock_timestamp(),
		cd_estabelecimento_p);

	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_transferencia_prontuario ( nm_usuario_p text, ds_lista_prontuario_p text, cd_pessoa_origem_p text, cd_pessoa_destino_p text, cd_setor_origem_p bigint, cd_setor_destino_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

