-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_cancel_protocolo_gestao ( nr_seq_protocolo_p bigint, nm_usuario_p text, cd_estabelecimento_p text, nr_seq_mot_cancel_p bigint, ds_motivo_canc_p text default null) AS $body$
DECLARE

 
ie_tipo_protocolo_w	varchar(2);			
ie_motivo_canc_w	bigint;
nr_fatura_w		ptu_fatura.nr_fatura%type;
nr_seq_fatura_w		bigint;
nr_seq_lote_pgto_w	bigint;
nr_titulo_w		bigint;	
 
/*Chamado no fonte da função OPS - Gestão de contas médicas*/
 
/* Esta rotina serve para cancelar um protocolo a partir da gestão de contas médicas.*/
 
/* Há dois tipos de tratamento: quando o protocolo for de intercâmbio e quando não for de intercâmbio*/
 
/* Não pode cancelar o protocolo caso uma das contas deste já tenha gerado títulos a pagar. */
 
/* Caso este protocolo esteja na função OPS - Pagamentos de Produção Médica , não pode ser cancelado*/
 
 

BEGIN 
 
if (coalesce( nr_seq_protocolo_p,0) > 0) then 
	 
	select	ie_tipo_protocolo 
	into STRICT	ie_tipo_protocolo_w 
	from 	pls_protocolo_conta 
	where	nr_Sequencia = 	nr_seq_protocolo_p;
	 
	/*TRATAMENTO PARA QUANDO O PROTOCOLO FOR DE INTERCÂMBIO*/
 
	if (coalesce(ie_tipo_protocolo_w,'C') = 'I') then	 
 
		select	max(nr_fatura), 
			max(nr_Sequencia), 
			max(nr_titulo) 
		into STRICT	nr_fatura_w, 
			nr_seq_fatura_w, 
			nr_titulo_w 
		from	ptu_fatura 
		where	nr_Seq_protocolo = nr_seq_protocolo_p;
		 
		/*SE A FATURA TEM TITULO, ENTAO NAO CANCELA PROTOCOLO.*/
 
		if (coalesce(nr_titulo_w,0) > 0) then 
			/* NÃO FOI POSSÍVEL CANCELAR A FATURA nr_fatura_w POIS A MESMA POSSUI TÍTULO  nr_titulo_w . */
 
			CALL wheb_mensagem_pck.exibir_mensagem_abort( 181477 , 'NR_FATURA='||nr_fatura_w||';NR_TITULO='||nr_titulo_w);
		end if;
		 
		CALL ptu_cancelar_fatura(	nr_seq_mot_cancel_p, nr_seq_fatura_w, 'Cancelamento realizado na função OPS - Gestão de Contas Médicas.', 
					nm_usuario_p,cd_estabelecimento_p,ds_motivo_canc_p);
					 
	else	/*Quando nao é protocolo de intercâmbio*/
	 
		CALL pls_cancelar_protocolo_conta(nr_seq_protocolo_p,'N',cd_estabelecimento_p, nm_usuario_p,ds_motivo_canc_p,nr_seq_mot_cancel_p);
	end if;	
	 
	CALL pls_inclui_prot_conta_hist(nr_seq_protocolo_p, wheb_mensagem_pck.get_texto(315922), nm_usuario_p, '12');
	 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cancel_protocolo_gestao ( nr_seq_protocolo_p bigint, nm_usuario_p text, cd_estabelecimento_p text, nr_seq_mot_cancel_p bigint, ds_motivo_canc_p text default null) FROM PUBLIC;

