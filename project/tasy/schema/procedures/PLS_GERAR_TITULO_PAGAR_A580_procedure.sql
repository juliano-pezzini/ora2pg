-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_titulo_pagar_a580 ( nr_seq_fat_geral_p ptu_fatura_geral.nr_sequencia%type, ie_commit_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_regra_tit_p pls_regra_tit_fat_geral.nr_sequencia%type) AS $body$
DECLARE


/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Gerar o titulo a pagar do arquivo A580
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  ]  Objetos do dicionario [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/	

cd_moeda_cp_w			parametros_contas_pagar.cd_moeda_padrao%type;
cd_tipo_taxa_juro_cp_w		parametros_contas_pagar.cd_tipo_taxa_juro%type;
cd_tipo_taxa_multa_cp_w		parametros_contas_pagar.cd_tipo_taxa_multa%type;
tx_juros_cp_w			parametros_contas_pagar.pr_juro_padrao%type;
tx_multa_cp_w			parametros_contas_pagar.pr_multa_padrao%type;

nr_titulo_pagar_w		titulo_pagar.nr_titulo%type;
vl_tot_doc_w			ptu_fatura_geral.vl_tot_doc%type;
dt_emi_doc_w			ptu_fatura_geral.dt_emi_doc%type;
dt_ven_doc_w			ptu_fatura_geral.dt_ven_doc%type;
nr_documento_w			ptu_fatura_geral.nr_documento%type;
cd_uni_ori_w			ptu_fatura_geral.cd_uni_ori%type;
cd_cgc_w			pessoa_juridica.cd_cgc%type;
nr_seq_congenere_w		pls_congenere.nr_sequencia%type;
nr_seq_camara_w			pls_congenere_camara.nr_sequencia%type;
nr_seq_trans_fin_baixa_w	pls_regra_tit_fat_geral.nr_seq_trans_fin_baixa%type;
nr_seq_trans_fin_contab_w	pls_regra_tit_fat_geral.nr_seq_trans_fin_contab%type;
nr_seq_regra_tit_w		ptu_fatura_geral.nr_seq_regra_tit_fat%type;
ie_status_tit_pagar_w		pls_regra_tit_fat_geral.ie_status_tit_pagar%type;
dt_postagem_w			ptu_fatura_geral.dt_postagem%type;
nr_seq_classe_w			pls_regra_tit_fat_geral.nr_seq_classe%type;
nr_seq_conta_financ_w		pls_regra_tit_fat_geral.nr_seq_conta_financ%type;
nr_sequencia_w			titulo_pagar_classif.nr_sequencia%type;


BEGIN
if (nr_seq_fat_geral_p IS NOT NULL AND nr_seq_fat_geral_p::text <> '') then

	-- se nao foi informado a regra, tenta buscar do proprio titulo
	if (coalesce(nr_seq_regra_tit_p::text, '') = '') then
		select	nr_seq_regra_tit_fat
		into STRICT	nr_seq_regra_tit_w
		from	ptu_fatura_geral
		where	nr_sequencia	= nr_seq_fat_geral_p;
	else
		nr_seq_regra_tit_w := nr_seq_regra_tit_p;
	end if;
	if (nr_seq_regra_tit_w IS NOT NULL AND nr_seq_regra_tit_w::text <> '') then
		select	max(nr_seq_trans_fin_baixa),
			max(nr_seq_trans_fin_contab),
			coalesce(max(ie_status_tit_pagar),'P'),
			max(nr_seq_classe),
			max(nr_seq_conta_financ)
		into STRICT	nr_seq_trans_fin_baixa_w,
			nr_seq_trans_fin_contab_w,
			ie_status_tit_pagar_w,
			nr_seq_classe_w,
			nr_seq_conta_financ_w
		from	pls_regra_tit_fat_geral
		where	nr_sequencia	= nr_seq_regra_tit_w;
	end if;

	select	coalesce(vl_tot_doc,0),
		coalesce(dt_emi_doc,clock_timestamp()),
		coalesce(dt_ven_doc,clock_timestamp()),
		coalesce(dt_postagem,clock_timestamp()),
		nr_documento,
		cd_uni_ori
	into STRICT	vl_tot_doc_w,
		dt_emi_doc_w,
		dt_ven_doc_w,
		dt_postagem_w,
		nr_documento_w,
		cd_uni_ori_w
	from	ptu_fatura_geral
	where	nr_sequencia	= nr_seq_fat_geral_p
	and	coalesce(nr_titulo_receber::text, '') = '';
	
	select	max(a.cd_cgc),
		max(a.nr_sequencia)
	into STRICT	cd_cgc_w,
		nr_seq_congenere_w
	from	pls_congenere a
	where	(a.cd_cooperativa)::numeric 	= (cd_uni_ori_w)::numeric;
	
	if (vl_tot_doc_w > 0) and (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') then		
		begin
		select	a.cd_moeda_padrao,
			a.cd_tipo_taxa_juro,
			a.cd_tipo_taxa_multa,
			a.pr_juro_padrao,
			a.pr_multa_padrao
		into STRICT	cd_moeda_cp_w,
			cd_tipo_taxa_juro_cp_w,
			cd_tipo_taxa_multa_cp_w,
			tx_juros_cp_w,
			tx_multa_cp_w
		from	parametros_contas_pagar a
		where	a.cd_estabelecimento	= cd_estabelecimento_p;
		exception
			when no_data_found then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(189164);
		end;
		
		insert into titulo_pagar(nr_titulo,
			nm_usuario,
			dt_atualizacao,
			cd_estabelecimento,
			vl_titulo,
			vl_saldo_titulo,
			dt_emissao,
			dt_contabil,
			dt_vencimento_original,
			dt_vencimento_atual,
			vl_saldo_juros,
			vl_saldo_multa,
			cd_moeda,
			cd_tipo_taxa_juro,
			cd_tipo_taxa_multa,
			tx_juros,
			tx_multa,
			ie_origem_titulo,
			ie_tipo_titulo,
			ie_situacao,
			cd_pessoa_fisica,
			cd_cgc,
			ie_pls,
			nr_lote_contabil,
			ds_observacao_titulo,
			nr_seq_trans_fin_baixa,
			nr_seq_trans_fin_contab,
			ie_desconto_dia,
			ie_bloqueto,
			nr_seq_nota_deb_conclusao,
			nr_documento,
			ie_status,
			dt_liberacao,
			nm_usuario_lib,
			nr_seq_pls_lote_contest,
			nr_seq_classe)
		values (nextval('titulo_pagar_seq'),
			nm_usuario_p,
			clock_timestamp(),
			cd_estabelecimento_p,
			vl_tot_doc_w,
			vl_tot_doc_w,
			dt_emi_doc_w,
			clock_timestamp(),
			dt_ven_doc_w,
			dt_ven_doc_w,
			0,
			0,
			cd_moeda_cp_w,
			cd_tipo_taxa_juro_cp_w,
			cd_tipo_taxa_multa_cp_w,
			tx_juros_cp_w,
			tx_multa_cp_w,
			'24', --OPS - Fatura de Uso Geral (A580)
			'27', --27 - Nota a pagar (credito/debito) 
			'A',
			null,
			cd_cgc_w,
			'S',
			0,
			wheb_mensagem_pck.get_texto(1107059),
			nr_seq_trans_fin_baixa_w,
			nr_seq_trans_fin_contab_w,
			'N',
			'N',
			null,
			nr_documento_w,
			coalesce(ie_status_tit_pagar_w, 'P'),
			null,
			null,
			null,
			nr_seq_classe_w) returning nr_titulo into nr_titulo_pagar_w;

		select	coalesce(max(nr_sequencia),0) + 1
		into STRICT	nr_sequencia_w
		from	titulo_pagar_classif
		where   nr_titulo = nr_titulo_pagar_w;
		
		insert into titulo_pagar_classif(nr_sequencia,
			nr_titulo,  
			cd_centro_custo,         
			cd_conta_contabil,       
			ds_observacao,           
			dt_atualizacao,          
			nm_usuario,              
			nr_contrato,             
			nr_seq_conta_financ,     
			nr_seq_conta_gpi,        
			nr_seq_etapa_gpi,        
			nr_seq_item_mensalidade, 
			nr_seq_orc_item_gpi,     
			nr_seq_produto,          
			nr_seq_proj_gpi,         
			nr_seq_trans_fin,                     
			vl_acrescimo,            
			vl_desconto,             
			vl_original,             
			vl_titulo)
		values (nr_sequencia_w,
			nr_titulo_pagar_w,
			null,
			null,
			null,
			clock_timestamp(),
			nm_usuario_p,
			null,
			nr_seq_conta_financ_w,
			null,
			null,
			null,
			null,
			null,
			null,
			null,
			null,
			null,
			null,
			vl_tot_doc_w);
			
		update	ptu_fatura_geral
		set	nr_titulo_pagar	= nr_titulo_pagar_w
		where	nr_sequencia 	= nr_seq_fat_geral_p;
		
		if (nr_seq_congenere_w IS NOT NULL AND nr_seq_congenere_w::text <> '') then
			select	max(a.nr_seq_camara)
			into STRICT	nr_seq_camara_w
			from	pls_congenere_camara	a
			where	a.nr_seq_congenere	= nr_seq_congenere_w
			and	dt_postagem_w between a.dt_inicio_vigencia_ref and a.dt_fim_vigencia_ref;

			if (nr_seq_camara_w IS NOT NULL AND nr_seq_camara_w::text <> '') then
				CALL pls_inserir_tit_camara( nr_titulo_pagar_w, null, nr_seq_camara_w, dt_postagem_w, 0, cd_estabelecimento_p, nm_usuario_p);
			end if;	
		end if;
	end if;
end if;

if (coalesce(ie_commit_p,'N') = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_titulo_pagar_a580 ( nr_seq_fat_geral_p ptu_fatura_geral.nr_sequencia%type, ie_commit_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_regra_tit_p pls_regra_tit_fat_geral.nr_sequencia%type) FROM PUBLIC;

