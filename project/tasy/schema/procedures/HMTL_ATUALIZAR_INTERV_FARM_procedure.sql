-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hmtl_atualizar_interv_farm ( nr_seq_cpoe_p bigint, nr_prescricao_p bigint, ie_tipo_item_p text) AS $body$
DECLARE


nr_seq_cpoe_anterior_w		bigint;
nr_prescricao_inter_farm_w 	bigint;
nr_seq_interv_farm_w 		bigint;
nr_sequencia_solucao_w 		bigint;

c01 CURSOR(	nr_seq_cpoe_ant_pc	bigint,
			nr_seq_ult_presc_pc	bigint) FOR
	SELECT 	a.nr_sequencia nr_seq_prescr_mat,
			a.ie_agrupador
	from    prescr_material	a
	where 	a.nr_seq_mat_cpoe 	= nr_seq_cpoe_ant_pc
	and		a.nr_prescricao		= nr_seq_ult_presc_pc;

BEGIN
nr_prescricao_inter_farm_w 	:= nr_prescricao_p;

if (ie_tipo_item_p in ('M', 'SOL', 'S')) then
	select 	max(nr_seq_cpoe_anterior)
	into STRICT 	nr_seq_cpoe_anterior_w
	from 	cpoe_material
	where 	nr_sequencia 	= nr_seq_cpoe_p;

	if (coalesce(nr_seq_cpoe_anterior_w, 0) > 0) then
		select 	max(nr_sequencia),
				max(nr_prescricao),
				max(nr_sequencia_solucao)
		into STRICT 	nr_seq_interv_farm_w,
				nr_prescricao_inter_farm_w,
				nr_sequencia_solucao_w
		from    prescr_material
		where 	nr_seq_mat_cpoe 	= nr_seq_cpoe_anterior_w;

		if (ie_tipo_item_p = 'SOL') then
			update	prescr_solucao
			set 	nr_seq_interf_farm = nr_seq_interv_farm_w
			where   nr_seq_solucao 	= nr_sequencia_solucao_w
			and 	nr_prescricao 	= nr_prescricao_p;
		else
			for c01_w in c01(nr_seq_cpoe_anterior_w, nr_prescricao_inter_farm_w) loop
				begin
					update 	prescr_material
					set 	nr_seq_interf_farm	= c01_w.nr_seq_prescr_mat
					where   nr_seq_mat_cpoe		= nr_seq_cpoe_p
					and		ie_agrupador		= c01_w.ie_agrupador;
				end;
			end loop;
		end if;
	end if;

elsif (ie_tipo_item_p = 'P') then
	select  max(nr_seq_cpoe_anterior)
	into STRICT    nr_seq_cpoe_anterior_w
	from    cpoe_procedimento
	where   nr_sequencia 	= nr_seq_cpoe_p;

	if (coalesce(nr_seq_cpoe_anterior_w, 0) > 0) then
		select 	max(nr_sequencia),
				max(nr_prescricao)
		into STRICT 	nr_seq_interv_farm_w,
				nr_prescricao_inter_farm_w
		from 	prescr_procedimento
		where	nr_seq_proc_cpoe 	= nr_seq_cpoe_anterior_w;

		update  prescr_procedimento
		set 	nr_seq_interf_farm = nr_seq_interv_farm_w
		where   nr_seq_proc_cpoe 	= nr_seq_cpoe_p;
	end if;

elsif (ie_tipo_item_p = 'R') then
	select 	max(nr_seq_cpoe_anterior)
	into STRICT 	nr_seq_cpoe_anterior_w
	from 	cpoe_recomendacao
	where nr_sequencia 	= nr_seq_cpoe_p;

	if (coalesce(nr_seq_cpoe_anterior_w, 0) > 0) then
		select 	max(nr_sequencia),
				max(nr_prescricao)
		into STRICT 	nr_seq_interv_farm_w,
				nr_prescricao_inter_farm_w
		from 	prescr_recomendacao
		where 	nr_seq_rec_cpoe 	= nr_seq_cpoe_anterior_w;

		update 	prescr_recomendacao
		set		nr_seq_interf_farm = nr_seq_interv_farm_w
		where 	nr_seq_rec_cpoe 	= nr_seq_cpoe_p;
	end if;

elsif (ie_tipo_item_p = 'O') then
	select 	max(nr_seq_cpoe_anterior)
	into STRICT 	nr_seq_cpoe_anterior_w
	from 	cpoe_gasoterapia
	where	nr_sequencia 	= nr_seq_cpoe_p;

	if (coalesce(nr_seq_cpoe_anterior_w, 0) > 0) then
		select	max(nr_sequencia),
				max(nr_prescricao)
		into STRICT 	nr_seq_interv_farm_w,
				nr_prescricao_inter_farm_w
		from 	prescr_gasoterapia
		where 	nr_seq_gas_cpoe 	= nr_seq_cpoe_anterior_w;

		update 	prescr_gasoterapia
		set 	nr_seq_interf_farm = nr_seq_interv_farm_w
		where	nr_seq_gas_cpoe 	= nr_seq_cpoe_p;
	end if;

elsif (ie_tipo_item_p = 'D') then
	select 	max(nr_seq_cpoe_anterior)
	into STRICT 	nr_seq_cpoe_anterior_w
	from 	cpoe_dieta
	where 	nr_sequencia 	= nr_seq_cpoe_p;

	if (coalesce(nr_seq_cpoe_anterior_w, 0) > 0) then
		select	max(nr_sequencia),
				max(nr_prescricao)
		into STRICT 	nr_seq_interv_farm_w,
				nr_prescricao_inter_farm_w
		from 	prescr_dieta
		where 	nr_seq_dieta_cpoe 	= nr_seq_cpoe_anterior_w;

		update	prescr_dieta
		set		nr_seq_interf_farm = nr_seq_interv_farm_w
		where	nr_seq_dieta_cpoe 	= nr_seq_cpoe_p;
	end if;
end if;

if (coalesce(nr_prescricao_inter_farm_w,0) > 0) then
update 	prescr_medica
set 	nr_prescr_interf_farm 	= nr_prescricao_inter_farm_w
where 	nr_prescricao 			= nr_prescricao_p;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hmtl_atualizar_interv_farm ( nr_seq_cpoe_p bigint, nr_prescricao_p bigint, ie_tipo_item_p text) FROM PUBLIC;

