-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE validar_gerar_lote_audit_rec (nr_seq_lote_rec_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

			 
VarPermiteContasSemDtAnalise	varchar(10);
VarPermiteReceb			varchar(10);
dt_item_receb_w			timestamp;	
dt_item_indev_w			timestamp;		
			 

BEGIN 
 
VarPermiteContasSemDtAnalise := obter_param_usuario(66, 12, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, VarPermiteContasSemDtAnalise);
VarPermiteReceb := obter_param_usuario(66, 5, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, VarPermiteReceb);
 
select	max(b.dt_historico) 
into STRICT	dt_item_receb_w 
from	conta_paciente d, 
	hist_audit_conta_paciente c, 
	conta_paciente_ret_hist b, 
	conta_paciente_retorno a, 
	lote_audit_recurso e 
where	a.nr_sequencia		= b.nr_seq_conpaci_ret 
and	d.nr_interno_conta	= a.nr_interno_conta 
and	a.nr_interno_conta	= d.nr_interno_conta 
and	b.nr_seq_hist_audit	= c.nr_sequencia 
and	e.nr_sequencia		= nr_seq_lote_rec_p 
and	a.cd_convenio		= e.cd_convenio 
and	d.cd_estabelecimento 	= cd_estabelecimento_p 
and	((b.nm_usuario_resp 	= e.nm_usuario_resp) or (coalesce(e.nm_usuario_resp::text, '') = '')) 
and	b.dt_historico 		between e.dt_inicial and e.dt_final 
and	coalesce(b.nr_seq_lote_recurso::text, '') = '' 
and	c.ie_acao  = 1 
and (VarPermiteContasSemDtAnalise = 'S' or (a.dt_analise IS NOT NULL AND a.dt_analise::text <> '')) 
and	c.ie_acao 		= coalesce(e.ie_acao_historico, c.ie_acao) 
and (exists (SELECT	1 
		from	convenio_retorno_item z 
		where	z.nr_sequencia  	= b.nr_seq_ret_item 
		and	z.nr_seq_retorno	= e.nr_seq_ret_filtro) 
	or coalesce(e.nr_seq_ret_filtro,0) 	= 0);
	 
select	max(b.dt_historico) 
into STRICT	dt_item_indev_w 
from	conta_paciente d, 
	hist_audit_conta_paciente c, 
	conta_paciente_ret_hist b, 
	conta_paciente_retorno a, 
	lote_audit_recurso e 
where	a.nr_sequencia		= b.nr_seq_conpaci_ret 
and	d.nr_interno_conta	= a.nr_interno_conta 
and	a.nr_interno_conta	= d.nr_interno_conta 
and	b.nr_seq_hist_audit	= c.nr_sequencia 
and	e.nr_sequencia		= nr_seq_lote_rec_p 
and	a.cd_convenio		= e.cd_convenio 
and	d.cd_estabelecimento 	= cd_estabelecimento_p 
and	((b.nm_usuario_resp 	= e.nm_usuario_resp) or (coalesce(e.nm_usuario_resp::text, '') = '')) 
and	b.dt_historico 		between e.dt_inicial and e.dt_final 
and	coalesce(b.nr_seq_lote_recurso::text, '') = '' 
and	c.ie_acao  = 4 
and (VarPermiteContasSemDtAnalise = 'S' or (a.dt_analise IS NOT NULL AND a.dt_analise::text <> '')) 
and	c.ie_acao 		= coalesce(e.ie_acao_historico, c.ie_acao) 
and (exists (SELECT	1 
		from	convenio_retorno_item z 
		where	z.nr_sequencia  	= b.nr_seq_ret_item 
		and	z.nr_seq_retorno	= e.nr_seq_ret_filtro) 
	or coalesce(e.nr_seq_ret_filtro,0) 	= 0);
	 
if (dt_item_receb_w IS NOT NULL AND dt_item_receb_w::text <> '' AND dt_item_indev_w IS NOT NULL AND dt_item_indev_w::text <> '') and (VarPermiteReceb = 'N') and (dt_item_receb_w > dt_item_indev_w) then 
	--Existem ítens de recebimento lançados após a glosa indevida. 
	--Não é possível gerar o lote de recurso! 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(209942);
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE validar_gerar_lote_audit_rec (nr_seq_lote_rec_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

