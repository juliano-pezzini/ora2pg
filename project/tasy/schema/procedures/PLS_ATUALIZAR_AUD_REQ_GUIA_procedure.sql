-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_aud_req_guia ( nr_seq_auditoria_p pls_auditoria.nr_sequencia%type, nr_seq_requisicao_p pls_requisicao.nr_sequencia%type, nm_usuario_p text) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Ao finalizar a auditoria o sistema deve atualizar as informações da guia que 
foi gerada via Webservice
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  ]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [X  ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atenção: 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_guia_plano_w		pls_guia_plano.nr_sequencia%type;
ie_tipo_processo_w		pls_requisicao.ie_tipo_processo%type;


C01 CURSOR FOR
	SELECT 	a.ie_anexo_guia,
		a.ie_anexo_quimioterapia,
		a.ie_anexo_radioterapia,
		a.ie_anexo_opme,
		a.ie_estagio,
		a.dt_validade_senha,
		a.cd_senha
	from	pls_requisicao a
	where	a.nr_sequencia = nr_seq_requisicao_p;
		

C02 CURSOR FOR
	SELECT	a.nr_seq_proc_origem,
		a.cd_procedimento,
		a.ie_origem_proced,
		a.qt_ajuste,
		a.nr_seq_motivo_exc,
		a.ie_status,
		a.vl_item,
		a.ie_pacote_ptu
	from	pls_auditoria_item	a
	where	a.nr_seq_auditoria = nr_seq_auditoria_p
	and	(a.nr_seq_proc_origem IS NOT NULL AND a.nr_seq_proc_origem::text <> '')	
	order by nr_sequencia;
	
C03 CURSOR FOR
	SELECT	a.nr_seq_mat_origem,
		a.nr_seq_material,
		a.qt_ajuste,
		a.nr_seq_motivo_exc,
		a.ie_status,
		a.vl_item,
		a.nr_seq_regra_vl_mat
	from	pls_auditoria_item	a
	where	a.nr_seq_auditoria = nr_seq_auditoria_p
	and	(a.nr_seq_mat_origem IS NOT NULL AND a.nr_seq_mat_origem::text <> '')
	order by nr_sequencia;	
	
BEGIN		

--Garante que a guia gerada é devido ao pedido recebido via Webservice	
select	max(nr_seq_guia_plano)
into STRICT	nr_seq_guia_plano_w
from	pls_guia_plano_imp
where	nr_seq_requisicao = nr_seq_requisicao_p;

if (nr_seq_guia_plano_w IS NOT NULL AND nr_seq_guia_plano_w::text <> '') then

	select	ie_tipo_processo
	into STRICT	ie_tipo_processo_w
	from	pls_requisicao
	where	nr_sequencia	= nr_seq_requisicao_p;

	for C01_w in C01 loop
		begin	
			update	pls_guia_plano
			set	ie_anexo_guia 		= C01_w.ie_anexo_guia,
				ie_anexo_quimioterapia 	= C01_w.ie_anexo_quimioterapia,
				ie_anexo_radioterapia 	= C01_w.ie_anexo_radioterapia,
				ie_anexo_opme 		= C01_w.ie_anexo_opme,
				ie_status	= CASE WHEN C01_w.ie_estagio=1 THEN  2 WHEN C01_w.ie_estagio=	-- Aberta				- Em análise
							2 THEN  1 WHEN C01_w.ie_estagio=	-- Aprovada				- Autorizado
							3 THEN  3 WHEN C01_w.ie_estagio=	-- Cancelada				- Negado
							4 THEN  2 WHEN C01_w.ie_estagio=	-- Auditoria				- Em análise
							5 THEN  2 WHEN C01_w.ie_estagio=	-- Auditoria Intercâmbio		- Em análise
							6 THEN  1 WHEN C01_w.ie_estagio=	-- Parcialmente Aprovada		- Autorizado
							7 THEN  3 WHEN C01_w.ie_estagio=	-- Reprovada				- Negado
							8 THEN  2 WHEN C01_w.ie_estagio=	-- Aguardando autorização do contratante- Em análise
							9 THEN  1 WHEN C01_w.ie_estagio=	-- Autorizada pelo contratante		- Autorizado
							10 THEN  2  ELSE 	-- Aguardando envio Intercâmbio		- Em análise
							C01_w.ie_estagio END ,
				ie_estagio	= CASE WHEN C01_w.ie_estagio=1 THEN  7 WHEN C01_w.ie_estagio=	-- Aberta				- Usuário (aguardando ação)
							2 THEN  6 WHEN C01_w.ie_estagio=	-- Aprovada				- Autorizado sem glosa
							3 THEN  8 WHEN C01_w.ie_estagio=	-- Cancelada				- Cancelada
							4 THEN  11 WHEN C01_w.ie_estagio=	-- Auditoria				- Auditoria intercâmbio
							5 THEN  11 WHEN C01_w.ie_estagio=	-- Auditoria Intercâmbio		- Auditoria intercâmbio
							6 THEN  10 WHEN C01_w.ie_estagio=	-- Parcialmente Aprovada		- Autorizado sem glosa
							7 THEN  4 WHEN C01_w.ie_estagio=	-- Reprovada				- Negado
							8 THEN  9 WHEN C01_w.ie_estagio=	-- Aguardando autorização do contratante- Aguardando autorização do contratante
							9 THEN  6 WHEN C01_w.ie_estagio=	-- Autorizada				- Autorizado sem glosa
							10 THEN  12  ELSE 	-- Aguardando envio Intercâmbio		- Aguardando autorização intercâmbio
							C01_w.ie_estagio END ,
				nm_usuario		= nm_usuario_p,
				dt_atualizacao		= clock_timestamp(),
				dt_validade_senha	= C01_w.dt_validade_senha,
				cd_senha		= C01_w.cd_senha
			where 	nr_sequencia 		= nr_seq_guia_plano_w;
			
			--Atualizar as informações dos procedimentos na guia liberados na OPS - Gestão de análise de autorização
			for C02_w in C02 loop	

				update	pls_guia_plano_proc
				set	qt_solicitada		= CASE WHEN ie_tipo_processo_w='I' THEN  0  ELSE C02_w.qt_ajuste END ,
					qt_autorizada		= CASE WHEN C02_w.ie_status='N' THEN 0  ELSE C02_w.qt_ajuste END ,
					ie_status		= CASE WHEN C02_w.ie_status='A' THEN CASE WHEN C01_w.ie_estagio=10 THEN  'I'  ELSE 'S' END   ELSE 'N' END ,
					nm_usuario		= nm_usuario_p,
					dt_atualizacao		= clock_timestamp()
				where	nr_seq_guia		= nr_seq_guia_plano_w
				and	cd_procedimento		= C02_w.cd_procedimento
				and	ie_origem_proced	= C02_w.ie_origem_proced;
				
				update	pls_itens_lote_execucao
				set	qt_aprovado 		= C02_w.qt_ajuste,
					qt_pendente 		= C02_w.qt_ajuste,
					dt_validade_senha	= C01_w.dt_validade_senha
				where	nr_seq_req_proc 	= C02_w.nr_seq_proc_origem;
				
				update	pls_execucao_req_item
				set	qt_item			= CASE WHEN C02_w.ie_status='N' THEN 0  ELSE C02_w.qt_ajuste END
				where	nr_seq_req_proc		= C02_w.nr_seq_proc_origem;
				
				update	pls_requisicao_proc
				set	qt_proc_executado 	= CASE WHEN C02_w.ie_status='N' THEN 0  ELSE C02_w.qt_ajuste END ,
					nm_usuario		= nm_usuario_p,
					dt_atualizacao		= clock_timestamp()
				where	nr_sequencia		= C02_w.nr_seq_proc_origem;

			end loop;
			
			--Atualizar as informações dos materiais na guia liberados na OPS - Gestão de análise de autorização
			for C03_w in C03 loop					
				update	pls_guia_plano_mat
				set	qt_solicitada		= CASE WHEN ie_tipo_processo_w='I' THEN  0  ELSE C03_w.qt_ajuste END ,
					qt_autorizada		= CASE WHEN C03_w.ie_status='N' THEN 0  ELSE C03_w.qt_ajuste END ,
					ie_status		= CASE WHEN C03_w.ie_status='A' THEN CASE WHEN C01_w.ie_estagio=10 THEN  'I'  ELSE 'S' END   ELSE 'N' END ,
					nm_usuario		= nm_usuario_p,
					dt_atualizacao		= clock_timestamp()
				where	nr_seq_guia	 	= nr_seq_guia_plano_w
				and	nr_seq_material		= C03_w.nr_seq_material;
				
				update	pls_itens_lote_execucao
				set	qt_aprovado 		= C03_w.qt_ajuste,
					qt_pendente 		= C03_w.qt_ajuste,
					dt_validade_senha	= C01_w.dt_validade_senha
				where	nr_seq_req_mat 		= C03_w.nr_seq_mat_origem;
				
				update	pls_execucao_req_item
				set	qt_item			= CASE WHEN C03_w.ie_status='N' THEN 0  ELSE C03_w.qt_ajuste END
				where	nr_seq_req_mat 		= C03_w.nr_seq_mat_origem;
				
				update	pls_requisicao_mat
				set	qt_mat_executado 	= CASE WHEN C03_w.ie_status='N' THEN 0  ELSE C03_w.qt_ajuste END ,
					nm_usuario		= nm_usuario_p,
					dt_atualizacao		= clock_timestamp()
				where	nr_sequencia		= C03_w.nr_seq_mat_origem;
				
			end loop;
		end;
		
		--Gerar as glosas da requisição na guia, quando for gerada negativa para o pedido de autorização
		CALL pls_gravar_glosa_req_guia_imp(nr_seq_requisicao_p, nr_seq_guia_plano_w, nm_usuario_p);
	end loop;	

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_aud_req_guia ( nr_seq_auditoria_p pls_auditoria.nr_sequencia%type, nr_seq_requisicao_p pls_requisicao.nr_sequencia%type, nm_usuario_p text) FROM PUBLIC;

