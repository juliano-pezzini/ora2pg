-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_nutricao_dia (cd_estabelecimento_p bigint, dt_referencia_p timestamp, cd_setor_atendimento_p bigint, nr_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_comando_w		varchar(4000);
ds_sql_serv_cria_w	varchar(2000);
ds_sql_servico_w	varchar(2000);
ds_sql_seq_serv_cria_w	varchar(2000);
ds_sql_seq_servico_w	varchar(2000);
ds_sql_ins_servico_w	varchar(4000);
ds_sql_ins_servico_ww	varchar(4000);
nr_seq_servico_w	bigint;
ds_servico_w		varchar(2000);
nr_seq_acompanhante_w	bigint;
cd_acompanhante_w	varchar(10);
ie_destino_w		varchar(1);
ds_observacao_w		varchar(255);
nr_atributo_w		smallint;
ds_meal_size_w		varchar(50);
ds_services_meal_size_w	varchar(2000);
ie_feeder_w		varchar(1);
ds_feeder_w		varchar(30);

C01 CURSOR FOR
	SELECT	nr_sequencia,
		ds_servico
	from	nut_servico
	where (cd_estabelecimento	= cd_estabelecimento_p
	or	coalesce(cd_estabelecimento::text, '') = '')
	and	ie_situacao		= 'A'
	AND	ie_tipo_prescricao_servico   = 1
	order by coalesce(nr_seq_apres,0);


C02 CURSOR FOR
	SELECT	DISTINCT(coalesce(a.cd_acompanhante,0)),
		coalesce(a.nr_seq_acompanhante,0)
	FROM	nut_pac_opcao_rec a,
		nut_atend_serv_dia b
	WHERE	a.nr_seq_servico_dia		= b.nr_sequencia
	AND	b.cd_setor_atendimento		= cd_setor_atendimento_p
	AND	b.nr_atendimento		= nr_atendimento_p
	AND	trunc(b.dt_servico)		= trunc(dt_referencia_p)
	ORDER BY 1;

C03 CURSOR FOR
	SELECT	a.ds_servico,
		case when coalesce(b.nr_meal_size::text, '') = '' then null else (SELECT ds_meal_size from nut_meal_size where ie_situacao = 'A' and nr_sequencia = b.nr_meal_size) end,
		case when coalesce(b.ie_feeder, 'N') = 'S' then 'S' else null end
	from	nut_servico a, nut_atend_serv_dia b
	where	a.nr_sequencia			= b.nr_seq_servico
	and	b.cd_setor_atendimento		= cd_setor_atendimento_p
	and (coalesce(b.nr_meal_size, 0) > 0	or	b.ie_feeder = 'S')
	and	b.nr_atendimento		= nr_atendimento_p
	and	trunc(b.dt_servico)		= trunc(dt_referencia_p)
	order by	dt_liberacao;


BEGIN

ds_servico_w	:= '';
nr_atributo_w	:= 1;

open C01;
loop
fetch 	C01 into
	nr_seq_servico_w,
	ds_servico_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ds_sql_servico_w		:= ds_sql_servico_w || chr(39) || ds_servico_w || chr(39) || ',';
	ds_sql_serv_cria_w		:= ds_sql_serv_cria_w || ' ds_servico_' || nr_atributo_w || ',';
	
	ds_sql_seq_servico_w		:= ds_sql_seq_servico_w || chr(39) || nr_seq_servico_w || chr(39) || ',';
	ds_sql_seq_serv_cria_w		:= ds_sql_seq_serv_cria_w || ' nr_seq_servico_' || nr_atributo_w || ',';
	
	nr_atributo_w			:= nr_atributo_w + 1;
	--ds_servico_w			:= 'Obter_Cardapio_Paciente(:nr_atendimento, ' || cd_setor_atendimento_p || ', to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy')  || 

						--chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || '), ' || nr_seq_servico_w || ' )';

	--ds_sql_ins_servico_w		:= ds_sql_ins_servico_w || ds_servico_w || ',';
	end;
end loop;
close C01;

--Montar o cabeçalho
delete	from	nut_cardapio_servico
where	nm_usuario = nm_usuario_p;

ds_comando_w	:= ' insert into nut_cardapio_servico (ie_destino,
							nr_atendimento,
							dt_referencia,
							cd_setor_atendimento,
							nr_seq_acompanhante,
							cd_acompanhante,'||
							ds_sql_serv_cria_w||
							ds_sql_seq_serv_cria_w||
							'ds_observacao,
							nm_usuario)
						values('|| chr(39)||wheb_mensagem_pck.get_texto(795700)||chr(39)||
							',0,
							to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || '),'
							|| cd_setor_atendimento_p||
							',0,
							0,'
							|| ds_sql_servico_w  ||
							ds_sql_seq_servico_w ||
							chr(39)||wheb_mensagem_pck.get_texto(795701)||chr(39)||','
							||chr(39)||nm_usuario_p||chr(39)||') ';

CALL exec_sql_dinamico('TASY', ds_comando_w);

open	C03;
loop
fetch	C03	into
	ds_servico_w,
	ds_meal_size_w,
	ie_feeder_w;
EXIT WHEN NOT FOUND; /* apply on C03 */
	begin
		if (ds_meal_size_w IS NOT NULL AND ds_meal_size_w::text <> '')	then
			ds_services_meal_size_w	:= ds_services_meal_size_w || ds_servico_w || ': ' || ds_meal_size_w || ', ';
		end if;
		if (ie_feeder_w IS NOT NULL AND ie_feeder_w::text <> '') and coalesce(ds_feeder_w::text, '') = ''	then
			ds_feeder_w	:= obter_desc_expressao(955753) || ': ' || obter_desc_expressao(327113);
		end if;
	end;
end loop;
close C03;

if (ds_feeder_w IS NOT NULL AND ds_feeder_w::text <> '')	then
	ds_services_meal_size_w	:= ds_feeder_w || ', ' || ds_services_meal_size_w;
end if;
if	(ds_services_meal_size_w IS NOT NULL AND ds_services_meal_size_w::text <> '')	then
	ds_services_meal_size_w	:= substr(ds_services_meal_size_w, 1, (length(ds_services_meal_size_w) - 2));
end if;
--Montar as informações
open C02;
loop
fetch C02 into	
	cd_acompanhante_w,
	nr_seq_acompanhante_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	ds_sql_ins_servico_w 	:= '';
	ds_sql_servico_w	:= '';
	ds_sql_serv_cria_w   	:= '';
	ds_sql_seq_servico_w 	:= '';
	ds_sql_seq_serv_cria_w	:= '';
	nr_atributo_w	     	:= 1;
	open C01;
	loop
	fetch 	C01 into	
		nr_seq_servico_w,
		ds_servico_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ds_sql_servico_w		:= ds_sql_servico_w || chr(39) || ds_servico_w || chr(39) || ',';
		ds_sql_serv_cria_w		:= ds_sql_serv_cria_w || ' ds_servico_' || nr_atributo_w || ',';
		ds_sql_seq_servico_w		:= ds_sql_seq_servico_w || chr(39) || nr_seq_servico_w || chr(39) || ',';
		ds_sql_seq_serv_cria_w		:= ds_sql_seq_serv_cria_w || ' nr_seq_servico_' || nr_atributo_w || ',';
		ds_servico_w			:= 'Obter_Cardapio_Paciente(:nr_atendimento, ' || cd_setor_atendimento_p || ', to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy')  ||
						chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || '), ' || nr_seq_servico_w || ', ' || nr_seq_acompanhante_w || ' , ' || cd_acompanhante_w || ')';
		ds_sql_ins_servico_w		:= ds_sql_ins_servico_w || ds_servico_w || ',';
		nr_atributo_w			:= nr_atributo_w + 1;
		end;
	end loop;
	close C01;

	if (cd_acompanhante_w = 0 AND nr_seq_acompanhante_w = 0) then
		ie_destino_w := 'P';
	else
		ie_destino_w := 'A';
		if (cd_acompanhante_w <> 0) then
			select  substr(obter_nome_pf(cd_pessoa_fisica),1,255)
			into STRICT	ds_observacao_w
			from	pessoa_fisica
			where	cd_pessoa_fisica = cd_acompanhante_w;
		else
			select 	nm_pessoa_fisica
			into STRICT 	ds_observacao_w
			from	nut_atend_acompanhante
			where	nr_sequencia 	= nr_seq_acompanhante_w;
		end if;
	end if;

	ds_sql_ins_servico_ww	:= replace( ds_sql_ins_servico_w, ':nr_atendimento', nr_atendimento_p);

	ds_comando_w	:= ' insert into nut_cardapio_servico (ie_destino,
							nr_atendimento,
							dt_referencia,
							cd_setor_atendimento,
							nr_seq_acompanhante,
							cd_acompanhante, '||
							ds_sql_serv_cria_w||
							ds_sql_seq_serv_cria_w||
							'ds_observacao,
							nm_usuario,
							ds_meal_size)
						values ('|| chr(39)||ie_destino_w|| chr(39)||', '
							||nr_atendimento_p || ', '
							||'to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') , '
							|| cd_setor_atendimento_p || ', '
							||nr_seq_acompanhante_w||', '
							||cd_acompanhante_w||', '
							||ds_sql_ins_servico_ww||
							ds_sql_seq_servico_w ||
							chr(39)||ds_observacao_w||chr(39)||', '||
							chr(39)||nm_usuario_p||chr(39)||', '||
							chr(39)||ds_services_meal_size_w||chr(39)||') ';

	CALL exec_sql_dinamico('TASY', ds_comando_w);

	end;
end loop;
close C02;

/*ds_sql_ins_servico_ww	:= replace(ds_sql_ins_servico_w, ':nr_atendimento', nr_atendimento_p);

	ds_comando_w	:= ' insert into w_nut_at_dia_' || replace(Elimina_Caracteres_Especiais(nm_usuario_p),' ','') || 
		   ' values (' || nr_atendimento_p || ', '  ||
		   ' to_date(' || chr(39) || to_char(dt_referencia_p, 'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') , ' 		   
		   || ds_sql_ins_servico_ww  || cd_setor_atendimento_p || ' ) ';

	exec_sql_dinamico('TASY', ds_comando_w);

*/
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_nutricao_dia (cd_estabelecimento_p bigint, dt_referencia_p timestamp, cd_setor_atendimento_p bigint, nr_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

