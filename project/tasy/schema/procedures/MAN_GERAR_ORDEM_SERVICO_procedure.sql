-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_ordem_servico ( nr_seq_localizacao_p bigint, nr_seq_equipamento_p bigint, cd_pessoa_solicitante_p text, dt_ordem_servico_p timestamp, ie_prioridade_p text, ie_parado_p text, ds_dano_breve_p text, nm_usuario_p text, ds_dano_p text, ie_tipo_ordem_p text, ie_status_ordem_p text, ie_classificacao_p text, nr_seq_estagio_p bigint, nr_grupo_planej_p bigint, nr_grupo_trabalho_p bigint, nr_ordem_servico_p INOUT text) AS $body$
DECLARE


nr_sequencia_w			bigint;
nm_usuario_exec_w		varchar(15);
qt_existe_w			bigint;

c01 CURSOR FOR
SELECT	nm_usuario_exec
from	man_equip_usuario_exec
where	nr_seq_equipamento 				= nr_seq_equipamento_p
and	coalesce(nr_seq_grupo_trabalho,coalesce(nr_grupo_trabalho_p,0)) 	= coalesce(nr_grupo_trabalho_p,0)
and	coalesce(nr_seq_grupo_planej,coalesce(nr_grupo_planej_p,0)) 	= coalesce(nr_grupo_planej_p,0);


BEGIN
select	nextval('man_ordem_servico_seq')
into STRICT	nr_sequencia_w
;

insert	into man_ordem_servico(
	nr_sequencia,
	nr_seq_localizacao,
	nr_seq_equipamento,
	cd_pessoa_solicitante,
	dt_ordem_servico,
	ie_prioridade,
	ie_parado,
	ds_dano_breve,
	dt_atualizacao,
	nm_usuario,
	dt_inicio_desejado,
	dt_conclusao_desejada,
	ds_dano,
	dt_inicio_previsto,
	dt_fim_previsto,
	dt_inicio_real,
	dt_fim_real,
	ie_tipo_ordem,
	ie_status_ordem,
	nr_grupo_planej,
	nr_grupo_trabalho,
	nr_seq_tipo_solucao,
	ds_solucao,
	nm_usuario_exec,
	qt_contador,
	nr_seq_planej,
	nr_seq_tipo_contador,
	nr_seq_estagio,
	cd_projeto,
	nr_seq_etapa_proj,
	dt_reabertura,
	cd_funcao,
	nm_tabela,
	ie_classificacao,
	nr_seq_origem,
	nr_seq_projeto,
	ie_grau_satisfacao,
	nr_seq_indicador,
	nr_seq_causa_dano,
	ie_forma_receb,
	nr_seq_cliente,
	nr_seq_grupo_des,
	nr_seq_grupo_sup,
	nr_seq_superior,
	ie_eficacia,
	dt_prev_eficacia,
	cd_pf_eficacia,
	nr_seq_nao_conform,
	nr_seq_complex,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	ie_obriga_news,
	nr_seq_meta_pe,
	nr_seq_classif,
	nr_seq_nivel_valor,
	nm_usuario_lib_news,
	dt_libera_news,
	dt_envio_wheb,
	ds_contato_solicitante,
	ie_prioridade_desen,
	ie_prioridade_sup,
	ie_origem_os)
values(nr_sequencia_w,				-- nr_sequencia,
	nr_seq_localizacao_p,			-- nr_seq_localizacao,
	nr_seq_equipamento_p,			-- nr_seq_equipamento,
	cd_pessoa_solicitante_p,			-- cd_pessoa_solicitante,
	coalesce(dt_ordem_servico_p,clock_timestamp()),		-- dt_ordem_servico,
	ie_prioridade_p,				-- ie_prioridade,
	ie_parado_p,				-- ie_parado,
	substr(ds_dano_breve_p,1,80),		-- ds_dano_breve,
	clock_timestamp(),					-- dt_atualizacao,
	nm_usuario_p,				-- nm_usuario,
	clock_timestamp(),					-- dt_inicio_desejado,
	(clock_timestamp() + interval '15 days'),				-- dt_conclusao_desejada,
	ds_dano_p,				-- ds_dano,
	clock_timestamp(),					-- dt_inicio_previsto,
	null,					-- dt_fim_previsto,
	clock_timestamp(),					-- dt_inicio_real,
	null,					-- dt_fim_real,
	ie_tipo_ordem_p,				-- ie_tipo_ordem,
	ie_status_ordem_p,				-- ie_status_ordem,
	nr_grupo_planej_p,				-- nr_grupo_planej,
	nr_grupo_trabalho_p,			-- nr_grupo_trabalho,
	null,					-- nr_seq_tipo_solucao,
	null,					-- ds_solucao,
	CASE WHEN ie_status_ordem_p='1' THEN null  ELSE nm_usuario_p END , -- nm_usuario_exec,
	null,					-- qt_contador,
	null,					-- nr_seq_planej,
	null,					-- nr_seq_tipo_contador,
	nr_seq_estagio_p,				-- nr_seq_estagio,
	null,					-- cd_projeto,
	null,					-- nr_seq_etapa_proj,
	null,					-- dt_reabertura,
	null,					-- cd_funcao,
	null,					-- nm_tabela,
	ie_classificacao_p,				-- ie_classificacao,
	null,					-- nr_seq_origem,
	null,					-- nr_seq_projeto,
	null,					-- ie_grau_satisfacao,
	null,					-- nr_seq_indicador,
	null,					-- nr_seq_causa_dano,
	null,					-- ie_forma_receb,
	null,					-- nr_seq_cliente,
	null,					-- nr_seq_grupo_des,
	null,					-- nr_seq_grupo_sup,
	null,					-- nr_seq_superior,
	null,					-- ie_eficacia,
	null,					-- dt_prev_eficacia,
	null,					-- cd_pf_eficacia,
	null,					-- nr_seq_nao_conform,
	null,					-- nr_seq_complex,
	null,					-- dt_atualizacao_nrec,
	nm_usuario_p,				-- nm_usuario_nrec,
	null,					-- ie_obriga_news,
	null,					-- nr_seq_meta_pe,
	null,					-- nr_seq_classif,
	null,					-- nr_seq_nivel_valor,
	null,					-- nm_usuario_lib_news,
	null,					-- dt_libera_news,
	null,					-- dt_envio_wheb,
	null,					-- ds_contato_solicitante,
	null,					-- ie_prioridade_desen,
	null,					-- ie_prioridade_sup
	'4');					-- ie_origem_os
open C01;
loop
fetch C01 into
	nm_usuario_exec_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	select 	count(*)
	into STRICT	qt_existe_w
	from	man_ordem_servico_exec
	where	nr_seq_ordem = nr_sequencia_w
	and	nm_usuario_exec = nm_usuario_exec_w;

	if (qt_existe_w = 0) then
		insert into  man_ordem_servico_exec(
				nr_sequencia,
				nr_seq_ordem,
				dt_atualizacao,
				nm_usuario,
				nm_usuario_exec)
			values (	nextval('man_ordem_servico_exec_seq'),
				nr_sequencia_w,
				clock_timestamp(),
				nm_usuario_p,
				nm_usuario_exec_w);
	end if;
	end;
end loop;
close C01;

nr_ordem_servico_p := nr_sequencia_w;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_ordem_servico ( nr_seq_localizacao_p bigint, nr_seq_equipamento_p bigint, cd_pessoa_solicitante_p text, dt_ordem_servico_p timestamp, ie_prioridade_p text, ie_parado_p text, ds_dano_breve_p text, nm_usuario_p text, ds_dano_p text, ie_tipo_ordem_p text, ie_status_ordem_p text, ie_classificacao_p text, nr_seq_estagio_p bigint, nr_grupo_planej_p bigint, nr_grupo_trabalho_p bigint, nr_ordem_servico_p INOUT text) FROM PUBLIC;

