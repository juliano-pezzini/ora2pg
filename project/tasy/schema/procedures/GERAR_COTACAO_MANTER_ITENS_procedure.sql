-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cotacao_manter_itens ( nr_ordem_compra_p bigint, nr_item_oci_p bigint, nm_usuario_p text, nr_cot_compra_p bigint, nr_item_cot_compra_p bigint) AS $body$
DECLARE

 
cd_cgc_fornecedor_w		varchar(14);
cd_cgc_fornecedor_ww		varchar(14);
nr_seq_fornec_orig_w		bigint;
nr_cot_compra_orig_w		bigint;
nr_seq_cot_fornec_w		bigint;
nr_seq_cot_forn_item_orig_w	bigint;
nr_seq_cot_forn_item_w		bigint;

c02 CURSOR FOR 
SELECT	a.nr_sequencia, 
	a.cd_cgc_fornecedor 
from	cot_compra_forn a 
where	a.nr_cot_compra = nr_cot_compra_orig_w 
and	a.cd_cgc_fornecedor <> cd_cgc_fornecedor_w 
and exists (	SELECT	1 
		from	cot_compra_forn_item x 
		where	a.nr_sequencia = x.nr_seq_cot_forn 
		and	nr_item_cot_compra(	select 	nr_item_cot_compra 
						from 	ordem_compra_item 
						where	nr_ordem_compra = nr_ordem_compra_p 
						and	nr_item_oci = coalesce(nr_item_oci_p,nr_item_oci)));

c03 CURSOR FOR 
SELECT	a.nr_sequencia 
from	cot_compra_forn_item a 
where	a.nr_seq_cot_forn = nr_seq_fornec_orig_w 
and	a.cd_cgc_fornecedor = cd_cgc_fornecedor_ww 
and	a.nr_cot_compra = nr_cot_compra_orig_w 
and	a.nr_item_cot_compra in ( 
		SELECT 	nr_item_cot_compra 
		from 	ordem_compra_item 
		where	nr_ordem_compra = nr_ordem_compra_p 
		and	nr_item_oci = coalesce(nr_item_oci_p,nr_item_oci));


BEGIN 
 
select	coalesce(max(nr_cot_compra), 0) 
into STRICT	nr_cot_compra_orig_w 
from	ordem_compra_item 
where	nr_ordem_compra = nr_ordem_compra_p 
and	nr_item_oci = coalesce(nr_item_oci_p,nr_item_oci);
 
select	cd_cgc_fornecedor 
into STRICT	cd_cgc_fornecedor_w 
from	ordem_compra 
where	nr_ordem_compra = nr_ordem_compra_p;
 
open c02;
loop 
fetch c02 into 
	nr_seq_fornec_orig_w, 
	cd_cgc_fornecedor_ww;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin 
 
	select	coalesce(max(nr_sequencia),0) 
	into STRICT	nr_seq_cot_fornec_w 
	from	cot_compra_forn 
	where	nr_cot_compra = nr_cot_compra_p 
	and	cd_cgc_fornecedor = cd_cgc_fornecedor_ww;
	 
	if (nr_seq_cot_fornec_w = 0) then 
		select	nextval('cot_compra_forn_seq') 
		into STRICT	nr_seq_cot_fornec_w 
		;
	 
		insert into cot_compra_forn( 
			nr_sequencia, 
			nr_cot_compra, 
			cd_cgc_fornecedor, 
			cd_condicao_pagamento, 
			cd_moeda, 
			ie_frete, 
			dt_atualizacao, 
			nm_usuario, 
			vl_previsto_frete, 
			nr_documento_fornec, 
			dt_documento, 
			ie_tipo_documento, 
			qt_dias_validade, 
			qt_dias_entrega, 
			pr_desconto, 
			pr_desconto_pgto_antec, 
			pr_juros_negociado, 
			ds_observacao, 
			cd_pessoa_fisica, 
			ie_status, 
			dt_fechamento, 
			nm_usuario_fechamento, 
			vl_despesa_acessoria, 
			ie_gerado_bionexo, 
			vl_desconto, 
			ie_exclusivo, 
			nr_seq_motivo_exclusivo, 
			ie_forma_pagto, 
			ie_liberada_internet, 
			ie_status_envio_email_lib) 
		SELECT	nr_seq_cot_fornec_w, 
			nr_cot_compra_p, 
			cd_cgc_fornecedor, 
			cd_condicao_pagamento, 
			cd_moeda, 
			ie_frete, 
			clock_timestamp(), 
			nm_usuario_p, 
			vl_previsto_frete, 
			nr_documento_fornec, 
			dt_documento, 
			ie_tipo_documento, 
			qt_dias_validade, 
			qt_dias_entrega, 
			pr_desconto, 
			pr_desconto_pgto_antec, 
			pr_juros_negociado, 
			ds_observacao, 
			cd_pessoa_fisica, 
			ie_status, 
			dt_fechamento, 
			nm_usuario_fechamento, 
			vl_despesa_acessoria, 
			ie_gerado_bionexo, 
			vl_desconto, 
			ie_exclusivo, 
			nr_seq_motivo_exclusivo, 
			ie_forma_pagto, 
			ie_liberada_internet, 
			ie_status_envio_email_lib 
		from	cot_compra_forn 
		where	nr_sequencia = nr_seq_fornec_orig_w 
		and	nr_cot_compra = nr_cot_compra_orig_w;
	end if;	
	 
	open c03;
	loop 
	fetch c03 into	 
		nr_seq_cot_forn_item_orig_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		begin 
 
		select	nextval('cot_compra_forn_item_seq') 
		into STRICT	nr_seq_cot_forn_item_w 
		;
 
		insert into cot_compra_forn_item( 
			nr_sequencia, 
			nr_cot_compra, 
			nr_item_cot_compra, 
			cd_cgc_fornecedor, 
			qt_material, 
			vl_unitario_material, 
			dt_atualizacao, 
			nm_usuario, 
			pr_desconto, 
			vl_frete_rateio, 
			ds_observacao, 
			ds_marca, 
			qt_prioridade, 
			qt_conv_unid_fornec, 
			ds_material_direto, 
			ie_situacao, 
			dt_validade, 
			nr_seq_cot_forn, 
			vl_preco, 
			cd_material, 
			vl_desconto, 
			vl_unitario_inicial, 
			ie_preco_fornec, 
			nr_contrato, 
			ds_marca_fornec, 
			ie_considera_media_lic, 
			ds_motivo_desconsiderar) 
		SELECT	nr_seq_cot_forn_item_w, 
			nr_cot_compra_p, 
			nr_item_cot_compra_p, 
			cd_cgc_fornecedor, 
			qt_material, 
			vl_unitario_material, 
			clock_timestamp(), 
			nm_usuario_p, 
			pr_desconto, 
			vl_frete_rateio, 
			ds_observacao, 
			ds_marca, 
			qt_prioridade, 
			qt_conv_unid_fornec, 
			ds_material_direto, 
			ie_situacao, 
			dt_validade, 
			nr_seq_cot_fornec_w, 
			vl_preco, 
			cd_material, 
			vl_desconto, 
			vl_unitario_material, 
			ie_preco_fornec, 
			nr_contrato, 
			ds_marca_fornec, 
			ie_considera_media_lic, 
			ds_motivo_desconsiderar 
		from	cot_compra_forn_item 
		where	nr_sequencia = nr_seq_cot_forn_item_orig_w 
		and	nr_cot_compra = nr_cot_compra_orig_w;
		end;
	end loop;
	close c03;
	end;
end loop;
close c02;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cotacao_manter_itens ( nr_ordem_compra_p bigint, nr_item_oci_p bigint, nm_usuario_p text, nr_cot_compra_p bigint, nr_item_cot_compra_p bigint) FROM PUBLIC;

