-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE selecionar_resultado ( nr_prescricao_p bigint, nr_seq_result_p bigint, nr_seq_item_p bigint, nr_seq_topografia_p bigint, ie_lado_p text, nm_usuario_p text) AS $body$
DECLARE


ie_forma_selecao_w		varchar(1);
qt_result_w			bigint;
qt_ponto_w			bigint;
NR_SEQ_TIPO_ITEM_w	bigint;
ie_forma_selecao_tipo_w		varchar(1);
NR_SEQ_ITEM_w			bigint;
nr_seq_diag_w			bigint;
ds_resultado_w			varchar(255);
IE_SELEC_EXCLUSIVA_w		varchar(10);

C01 CURSOR FOR
	SELECT a.nr_seq_diag
	from   pe_result_item_diag a
	where  a.nr_seq_result = nr_seq_result_p
	and    a.ie_confirmar_diag = 'S';


BEGIN
select	ie_forma_selecao
into STRICT	ie_forma_selecao_w
from	pe_item_examinar
where	nr_sequencia	= nr_seq_item_p;



select	qt_ponto,
		IE_SELEC_EXCLUSIVA
into STRICT	qt_ponto_w,
		IE_SELEC_EXCLUSIVA_w
from	PE_ITEM_RESULTADO
where	nr_sequencia	= nr_seq_result_p;



select	max(NR_SEQ_TIPO_ITEM),
	max(NR_SEQ_ITEM)
into STRICT	NR_SEQ_TIPO_ITEM_w,
	NR_SEQ_ITEM_w
from	PE_ITEM_TIPO_ITEM
where	nr_seq_item	= nr_seq_item_p;

select	max(ie_forma_selecao)
into STRICT	ie_forma_selecao_tipo_w
from	PE_TIPO_ITEM
where	nr_sequencia	= NR_SEQ_TIPO_ITEM_w;

if (ie_forma_selecao_tipo_w	= 'S') then



	select	count(*)
	into STRICT	qt_result_w
	from	pe_prescr_item_result a,
		pe_item_tipo_item b
	where	a.nr_seq_prescr = nr_prescricao_p
	and	a.nr_seq_item	= b.nr_seq_item
	and	b.nr_seq_tipo_item	= NR_SEQ_TIPO_ITEM_w
	and	b.NR_SEQ_ITEM		<> NR_SEQ_ITEM_w;

	if (qt_result_w	> 0) then
		CALL exibir_erro_abortar(Wheb_mensagem_pck.get_texto(387889) || '#@#@' /*'Esse tipo permite a seleção de apenas um aspecto! #@#@'*/,null);
	end if;

end if;

select 	max(b.ds_resultado)
into STRICT	ds_resultado_w
from 	pe_prescr_item_result a,
      	pe_item_resultado b
where	1=1
and 	a.nr_seq_result =  b.nr_sequencia
 and	a.nr_seq_item  =   nr_seq_item_p
and	a.nr_seq_prescr  = nr_prescricao_p
and	b.ie_selec_exclusiva  = 'S';

if (ds_resultado_w IS NOT NULL AND ds_resultado_w::text <> '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(249072,'DS_RESULTADO_W='||DS_RESULTADO_W);
end if;

select 	 max(b.ds_resultado)
into STRICT	 ds_resultado_w
from 	 pe_prescr_item_result a,
	 pe_item_resultado b
where	 1=1
and 	 a.nr_seq_result =  b.nr_sequencia
 and	 a.nr_seq_item  = nr_seq_item_p
and	 a.nr_seq_prescr  = nr_prescricao_p
and	 coalesce(b.ie_selec_exclusiva,'N')  = 'N';

if (ds_resultado_w IS NOT NULL AND ds_resultado_w::text <> '') and (IE_SELEC_EXCLUSIVA_w = 'S')then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(249082,'DS_RESULTADO_W='||DS_RESULTADO_W);
end if;



select	count(*)
into STRICT	qt_result_w
from	pe_prescr_item_result
where	nr_seq_prescr	= nr_prescricao_p
and	nr_seq_item	= nr_seq_item_p;




if (ie_forma_selecao_w = 'S') and (qt_result_w > 0) then
	CALL exibir_erro_abortar(Wheb_mensagem_pck.get_texto(387890)/*'Esse item permite a seleção de apenas um resultado! #@#@'*/
,null);

else
	insert into pe_prescr_item_result(
		NR_SEQUENCIA,
		DT_ATUALIZACAO,
		NM_USUARIO,
		NR_SEQ_ITEM,
		NR_SEQ_RESULT,
		NR_SEQ_PRESCR,
		NR_SEQ_TOPOGRAFIA,
		IE_LADO,
		qt_ponto)
	SELECT	nextval('pe_prescr_item_result_seq'),
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_item_p,
		nr_seq_result_p,
		nr_prescricao_p,
		nr_seq_topografia_p,
		ie_lado_p,
		qt_ponto_w
	
	where not exists (	SELECT	1
				from	pe_prescr_item_result b
				where	nr_seq_prescr	= nr_prescricao_p
				and	nr_seq_result	= nr_seq_result_p
				and	nr_seq_item	= nr_seq_item_p);
end if;

open C01;
loop
fetch C01 into
	nr_seq_diag_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	CALL Gerar_diag_enfermagem(nr_prescricao_p, nr_seq_diag_w, nm_usuario_p);
	end;
end loop;
close C01;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE selecionar_resultado ( nr_prescricao_p bigint, nr_seq_result_p bigint, nr_seq_item_p bigint, nr_seq_topografia_p bigint, ie_lado_p text, nm_usuario_p text) FROM PUBLIC;

