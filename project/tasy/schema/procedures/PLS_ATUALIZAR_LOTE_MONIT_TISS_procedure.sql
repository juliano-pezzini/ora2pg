-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_lote_monit_tiss ( nr_seq_lote_p bigint) AS $body$
DECLARE


qt_procedimento_w	pls_monitor_tiss_lote.qt_procedimento%type;
qt_material_w		pls_monitor_tiss_lote.qt_material%type;
qt_conta_w		pls_monitor_tiss_lote.qt_conta%type;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_monitor_tiss_lote
	where	((nr_sequencia	= nr_seq_lote_p) or (coalesce(nr_seq_lote_p::text, '') = ''));

BEGIN

for c01_w in c01 loop
	begin

	select	max(qnt_contas)	qnt_contas,
		max(qnt_proc)	qnt_proc,
		max(qnt_mat)	qnt_mat
	into STRICT	qt_conta_w,
		qt_procedimento_w,
		qt_material_w
	from (	SELECT	count(1)		qnt_contas,
			0			qnt_proc,
			0			qnt_mat
		from	pls_monitor_tiss_cta_val
		where	nr_seq_lote_monitor	= c01_w.nr_sequencia
		
union all

		SELECT	0		qnt_contas,
			count(1)	qnt_proc,
			0		qnt_mat
		from	pls_monitor_tiss_cta_val	a,
			pls_monitor_tiss_proc_val	b
		where a.nr_seq_lote_monitor	= c01_w.nr_sequencia
		and    b.nr_seq_cta_val 	= a.nr_sequencia
		
union all

		select	0		qnt_contas,
			0		qnt_proc,
			count(1)	qnt_mat
		from	pls_monitor_tiss_cta_val	a,
			pls_monitor_tiss_mat_val	b
		where	a.nr_seq_lote_monitor	= c01_w.nr_sequencia
		and	a.nr_sequencia 		= b.nr_seq_cta_val) alias6;

	update	pls_monitor_tiss_lote
	set	qt_conta	= qt_conta_w,
		qt_procedimento	= qt_procedimento_w,
		qt_material	= qt_material_w
	where	nr_sequencia	= c01_w.nr_sequencia;

	end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_lote_monit_tiss ( nr_seq_lote_p bigint) FROM PUBLIC;

