-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_baixa_nota_credito (nr_seq_liq_p bigint, nr_seq_tit_cobr_p bigint, nr_bordero_p bigint, nr_titulo_p bigint, nm_usuario_p text, ie_opcao_p text) AS $body$
DECLARE


/* NÃO DAR COMMIT NESTA PROCEDURE */

/* ie_opcao_p
'B'	baixar nota de crédito
'E'	excluir baixa da nota de crédito
*/
nr_seq_tit_cobr_w	bigint;
nr_seq_nota_credito_w	bigint;
vl_nota_credito_w	double precision;
nr_seq_liq_w		bigint;
nr_titulo_w		bigint;
dt_baixa_w		timestamp;
/* Projeto Multimoeda - Variáveis */

vl_nota_cred_estrang_w	double precision;
vl_baixa_estrang_w	double precision;
vl_complemento_w	double precision;
vl_cotacao_w		cotacao_moeda.vl_cotacao%type;
cd_moeda_w		integer;

c01 CURSOR FOR
SELECT	a.nr_seq_nota_credito,
	CASE WHEN ie_opcao_p='E' THEN a.vl_nota_credito * -1  ELSE a.vl_nota_credito END
from	titulo_receber_nc a
where	a.nr_titulo_rec		= nr_titulo_w
and	((ie_opcao_p = 'B' and coalesce(a.nr_seq_liq::text, '') = '') or (ie_opcao_p = 'E' and (a.nr_seq_liq IS NOT NULL AND a.nr_seq_liq::text <> '')))
and	a.vl_nota_credito	> 0

union

select	a.nr_sequencia,
	a.vl_nota_credito
from	nota_credito a
where	a.nr_titulo_receber	= nr_titulo_w
and	ie_opcao_p		= 'E';


BEGIN

if (nr_seq_tit_cobr_p IS NOT NULL AND nr_seq_tit_cobr_p::text <> '') then

	select	max(a.nr_titulo),
		max(a.dt_liquidacao)
	into STRICT	nr_titulo_w,
		dt_baixa_w
	from	titulo_receber_cobr a
	where	a.nr_sequencia	= nr_seq_tit_cobr_p;

elsif (nr_bordero_p IS NOT NULL AND nr_bordero_p::text <> '') then

	select	max(a.nr_titulo)
	into STRICT	nr_titulo_w
	from	bordero_tit_rec a
	where	a.nr_bordero	= nr_bordero_p
	and	a.nr_titulo	= nr_titulo_p;

else
	nr_titulo_w	:= nr_titulo_p;

	select	max(a.dt_recebimento)
	into STRICT	dt_baixa_w
	from	titulo_receber_liq a
	where	a.nr_titulo	= nr_titulo_p
	and	a.nr_sequencia	= nr_seq_liq_p;
end if;

if (ie_opcao_p	= 'B') then
	nr_seq_liq_w	:= nr_seq_liq_p;
elsif (ie_opcao_p	= 'E') then
	nr_seq_liq_w	:= null;
end if;

open c01;
loop
fetch c01 into
	nr_seq_nota_credito_w,
	vl_nota_credito_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	/* Projeto Multimoeda - Busca os dados da nota de crédito. */

	select	max(vl_nota_cred_estrang),
		max(vl_cotacao),
		max(cd_moeda)
	into STRICT	vl_nota_cred_estrang_w,
		vl_cotacao_w,
		cd_moeda_w
	from	nota_credito
	where	nr_sequencia = nr_seq_nota_credito_w;

	/* Projeto Multimoeda - Verifica se a nota de crédito é moeda estrangeira, caso positivo calcula os valores para gravar na baixa. */

	if (coalesce(vl_nota_cred_estrang_w,0) <> 0 and coalesce(vl_cotacao_w,0) <> 0) then
		vl_baixa_estrang_w := vl_nota_credito_w / vl_cotacao_w;
		vl_complemento_w := vl_nota_credito_w - vl_baixa_estrang_w;
	else
		vl_baixa_estrang_w := null;
		vl_complemento_w := null;
		vl_cotacao_w := null;
		cd_moeda_w := null;
	end if;

	insert	into nota_credito_baixa(dt_atualizacao,
		nm_usuario,
		nr_seq_nota_credito,
		nr_bordero,
		nr_seq_tit_rec_cobr,
		nr_sequencia,
		vl_baixa,
		nr_titulo,
		dt_baixa,
		vl_baixa_estrang,
		vl_complemento,
		vl_cotacao,
		cd_moeda)
	values (clock_timestamp(),
		nm_usuario_p,
		nr_seq_nota_credito_w,
		nr_bordero_p,
		nr_seq_tit_cobr_p,
		nextval('nota_credito_baixa_seq'),
		vl_nota_credito_w,
		nr_titulo_w,
		coalesce(dt_baixa_w,clock_timestamp()),
		vl_baixa_estrang_w,
		vl_complemento_w,
		vl_cotacao_w,
		cd_moeda_w);

	update	titulo_receber_nc
	set	nr_seq_liq		= nr_seq_liq_w
	where	nr_titulo_rec		= nr_titulo_w
	and	nr_seq_nota_credito	= nr_seq_nota_credito_w;

	CALL atualizar_saldo_nota_credito(nr_seq_nota_credito_w,nm_usuario_p);

end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_baixa_nota_credito (nr_seq_liq_p bigint, nr_seq_tit_cobr_p bigint, nr_bordero_p bigint, nr_titulo_p bigint, nm_usuario_p text, ie_opcao_p text) FROM PUBLIC;

