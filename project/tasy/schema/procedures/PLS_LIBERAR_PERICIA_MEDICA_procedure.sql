-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_liberar_pericia_medica ( nr_seq_pericia_p integer, nm_usuario_p text) AS $body$
DECLARE

 
cd_estabelecimento_w		smallint;
ie_status_w			varchar(2);
ie_status_ww			varchar(2)	:= 'X';
ie_nivel_liberacao_w		varchar(3);
dt_liberacao_w			timestamp;
dt_liberacao_ww			timestamp;
dt_liberacao_atendimento_w	timestamp;
dt_liberacao_atendimento_ww	timestamp;
dt_solicitacao_pericia_w	timestamp;
ds_especialidade_medica_w	varchar(80);
ds_rede_atendimento_w		varchar(255);
nm_prestador_w			varchar(100);
nm_medico_executor_w		varchar(60);
dt_pericia_w			timestamp;


BEGIN 
 
/* Obter dados da perícia */
 
select	cd_estabelecimento, 
	ie_status, 
	dt_liberacao, 
	dt_liberacao_atendimento, 
	dt_solicitacao_pericia, 
	substr(obter_desc_espec_medica(cd_especialidade),1,255), 
	substr(obter_valor_dominio(2431, ie_tipo_rede_atendimento),1,255), 
	substr(pls_obter_dados_prestador(nr_seq_prestador,'N'),1,255), 
	substr(obter_nome_pf(cd_medico_executor),1,80), 
	dt_pericia 
into STRICT	cd_estabelecimento_w, 
	ie_status_w, 
	dt_liberacao_w, 
	dt_liberacao_atendimento_w, 
	dt_solicitacao_pericia_w, 
	ds_especialidade_medica_w, 
	ds_rede_atendimento_w, 
	nm_prestador_w, 
	nm_medico_executor_w, 
	dt_pericia_w 
from	pls_pericia_medica 
where	nr_sequencia	= nr_seq_pericia_p;
 
dt_liberacao_ww			:= dt_liberacao_w;
dt_liberacao_atendimento_ww	:= dt_liberacao_atendimento_w;
 
ie_nivel_liberacao_w := Obter_Param_Usuario(1235, 3, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_nivel_liberacao_w);
 
if (ie_nivel_liberacao_w	= 'SA') then 
	ie_status_ww	:= 'A';
	dt_liberacao_ww			:= clock_timestamp();
	dt_liberacao_atendimento_ww	:= clock_timestamp();
elsif (ie_nivel_liberacao_w	= 'S') and (ie_status_w	= 'U') then 
	ie_status_ww	:= 'L';
	dt_liberacao_ww	:= clock_timestamp();
elsif (ie_nivel_liberacao_w	= 'A') and (ie_status_w	= 'L') then 
	ie_status_ww	:= 'A';	
	dt_liberacao_atendimento_ww	:= clock_timestamp();
end if;
 
if (ie_status_ww	<> 'X') then 
	update	pls_pericia_medica 
	set	ie_status			= ie_status_ww, 
		dt_liberacao			= dt_liberacao_ww, 
		dt_liberacao_atendimento	= dt_liberacao_atendimento_ww, 
		dt_atualizacao			= clock_timestamp(), 
		nm_usuario			= nm_usuario_p 
	where	nr_sequencia			= nr_seq_pericia_p;
end if;
 
insert into pls_pericia_log( 
	nr_sequencia, nr_seq_pericia, ds_log, 
	dt_atualizacao, nm_usuario) 
values (	nextval('pls_pericia_log_seq'), nr_seq_pericia_p, ' Data solicitação: ' || dt_solicitacao_pericia_w || 
	' Data liberação: ' || dt_liberacao_ww || 
	' Especialidade médica: ' || ds_especialidade_medica_w || 
	' Rede atendimento: ' || ds_rede_atendimento_w || 
	' Dt. liberação atend.: ' || dt_liberacao_atendimento_ww || 
	' Prestador: ' || nm_prestador_w || 
	' Médico executor: ' || nm_medico_executor_w || 
	' Data perícia: ' || dt_pericia_w || 
	' Status: ' || ie_status_ww, 
	clock_timestamp(), nm_usuario_p);
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_liberar_pericia_medica ( nr_seq_pericia_p integer, nm_usuario_p text) FROM PUBLIC;

