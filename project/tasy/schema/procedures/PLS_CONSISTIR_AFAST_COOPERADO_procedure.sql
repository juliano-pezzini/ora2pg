-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consistir_afast_cooperado (nr_seq_cooperado_p bigint, nr_seq_ausencia_p bigint, nr_seq_motivo_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp) AS $body$
DECLARE


qt_dias_afast_w		bigint;
ie_periodo_w		varchar(3);
qt_limite_regra_w	bigint;
qt_dias_afast_ano_w	bigint;
qt_ausencia_w		bigint;

c01 CURSOR FOR
SELECT	a.ie_periodo,
	a.qt_limite
from	pls_regra_afast_coop a
where	dt_inicio_p between a.dt_inicio_vigencia and coalesce(a.dt_fim_vigencia,dt_inicio_p)
and	coalesce(a.nr_seq_cooperado,nr_seq_cooperado_p)	= nr_seq_cooperado_p
and	coalesce(a.nr_seq_motivo,nr_seq_motivo_p)		= nr_seq_motivo_p
order by
	coalesce(a.nr_seq_cooperado,0);


BEGIN

if (nr_seq_cooperado_p IS NOT NULL AND nr_seq_cooperado_p::text <> '') then
	select	count(*)
	into STRICT	qt_ausencia_w
	from	pls_cooperado_ausencia	a
	where	a.nr_sequencia	<> nr_seq_ausencia_p
	and	a.nr_seq_cooperado = nr_seq_cooperado_p
	and (a.dt_inicio between dt_inicio_p and dt_fim_p
		or coalesce(a.dt_fim, clock_timestamp()) between dt_inicio_p and dt_fim_p)  LIMIT 1;

	if (qt_ausencia_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(199351);
	end if;

	qt_dias_afast_w	:= obter_dias_entre_datas(trunc(dt_inicio_p,'dd'),fim_dia(coalesce(dt_fim_p,to_date('31/12/' || to_char(clock_timestamp(),'yyyy'),'dd/mm/yyyy')))) + 1;

	open c01;
	loop
	fetch c01 into
		ie_periodo_w,
		qt_limite_regra_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		if (ie_periodo_w = 'A') then
			select	coalesce(sum(pls_obter_qt_dias_afast_coop(a.nr_sequencia)),0)
			into STRICT	qt_dias_afast_ano_w
			from	pls_cooperado_ausencia a
			where	a.nr_seq_cooperado 	= nr_seq_cooperado_p
			and	a.nr_seq_motivo 	= nr_seq_motivo_p
			and	a.dt_inicio between trunc(clock_timestamp(),'year') and to_date('31/12/' || to_char(clock_timestamp(),'yyyy'),'dd/mm/yyyy')
			and	a.nr_sequencia	<> nr_seq_ausencia_p;

			if (qt_dias_afast_ano_w + qt_dias_afast_w > qt_limite_regra_w) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(199352,	'QT_LIMITE_REGRA_W='	|| to_char(qt_limite_regra_w) ||
										';QT_DIAS_AFASTADOS_W='	|| to_char(qt_dias_afast_ano_w + qt_dias_afast_w));
			end if;
		elsif (ie_periodo_w = 'S') then
			if (dt_inicio_p > last_day(add_months(trunc(clock_timestamp(),'year'),6)) ) then
				select 	coalesce(sum(pls_obter_qt_dias_afast_coop(a.nr_sequencia)),0)
				into STRICT	qt_dias_afast_ano_w
				from	pls_cooperado_ausencia a
				where	a.nr_seq_cooperado	= nr_seq_cooperado_p
				and	a.nr_seq_motivo 	= nr_seq_motivo_p
				and	a.dt_inicio between to_date('01/07/' || to_char(clock_timestamp(),'yyyy'),'dd/mm/yyyy')
						and to_date('31/12/' || to_char(clock_timestamp(),'yyyy'),'dd/mm/yyyy')
				and	a.nr_sequencia <> nr_seq_ausencia_p;
			else
				select	coalesce(sum(pls_obter_qt_dias_afast_coop(a.nr_sequencia)),0)
				into STRICT	qt_dias_afast_ano_w
				from	pls_cooperado_ausencia a
				where	a.nr_seq_cooperado	= nr_seq_cooperado_p
				and	a.nr_seq_motivo 	= nr_seq_motivo_p
				and	a.dt_inicio between trunc(clock_timestamp(),'year') and
						last_day(to_date('01/06/' || to_char(clock_timestamp(),'yyyy'),'dd/mm/yyyy'))
				and	a.nr_sequencia <> nr_seq_ausencia_p;
			end if;

			if (qt_dias_afast_ano_w + qt_dias_afast_w > qt_limite_regra_w) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(199354,	'QT_LIMITE_REGRA_W='	|| to_char(qt_limite_regra_w) ||
										';QT_DIAS_AFASTADOS_W='	|| to_char(qt_dias_afast_ano_w + qt_dias_afast_w));
			end if;
		end if;
		end;
	end loop;
	close c01;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consistir_afast_cooperado (nr_seq_cooperado_p bigint, nr_seq_ausencia_p bigint, nr_seq_motivo_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp) FROM PUBLIC;

