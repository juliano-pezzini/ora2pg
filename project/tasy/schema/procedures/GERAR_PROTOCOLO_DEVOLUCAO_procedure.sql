-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_protocolo_devolucao (nr_seq_protocolo_p bigint, nm_usuario_p text, nr_seq_gerado_p INOUT text) AS $body$
DECLARE


dt_envio_w		timestamp;
dt_fechamento_w		timestamp;
dt_rec_destino_w	timestamp;
nm_usuario_envio_w	varchar(15);
ie_tipo_protocolo_w	varchar(3);
cd_pessoa_origem_w	varchar(10);
cd_pessoa_destino_w	varchar(10);
cd_cgc_destino_w	varchar(14);
nm_usuario_receb_w	varchar(15);
ds_obs_w		varchar(4000);
cd_setor_destino_w	integer;
cd_setor_origem_w	integer;
nr_seq_prot_novo_w	bigint;


BEGIN

if (coalesce(nr_seq_protocolo_p, 0) > 0) then

select	dt_envio,
	nm_usuario_envio,
	ie_tipo_protocolo,
	cd_pessoa_origem,
	cd_setor_origem,
	cd_pessoa_destino,
	coalesce(cd_setor_destino,cd_setor_origem)cd_setor_destino,
	cd_cgc_destino,
	dt_rec_destino,
	nm_usuario_receb,
	ds_obs,
	dt_fechamento
into STRICT	dt_envio_w,
	nm_usuario_envio_w,
	ie_tipo_protocolo_w,
	cd_pessoa_origem_w,
	cd_setor_origem_w,
	cd_pessoa_destino_w,
	cd_setor_destino_w,
	cd_cgc_destino_w,
	dt_rec_destino_w,
	nm_usuario_receb_w,
	ds_obs_w,
	dt_fechamento_w
from	protocolo_documento
where	nr_sequencia	= nr_seq_protocolo_p;

select	nextval('protocolo_documento_seq')
into STRICT	nr_seq_prot_novo_w
;

ds_obs_w	:= substr(wheb_mensagem_pck.get_texto(305769, 'NR_SEQ_PROTOCOLO_P=' || NR_SEQ_PROTOCOLO_P)||chr(10)||chr(13)||ds_obs_w,1,4000);

insert into protocolo_documento(nr_sequencia,
	dt_envio,
	nm_usuario_envio,
	ie_tipo_protocolo,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	cd_pessoa_origem,
	cd_setor_origem,
	cd_pessoa_destino,
	cd_setor_destino,
	cd_cgc_destino,
	dt_rec_destino,
	nm_usuario_receb,
	ds_obs,
	dt_fechamento,
	nr_seq_protocolo_dev,
	dt_devolucao)
values (	nr_seq_prot_novo_w,
	null,
	nm_usuario_p,
	ie_tipo_protocolo_w,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	cd_pessoa_destino_w,
	cd_setor_destino_w,
	cd_pessoa_origem_w,
	cd_setor_origem_w,
	cd_cgc_destino_w,
	null,
	null,
	ds_obs_w,
	null,
	nr_seq_protocolo_p,
	clock_timestamp());


update	protocolo_documento
set	ds_obs =  substr(ds_obs ||chr(10)||chr(13)|| wheb_mensagem_pck.get_texto(305772, 'NR_SEQ_PROT_NOVO_W=' || NR_SEQ_PROT_NOVO_W),1,4000)
where	nr_sequencia = nr_seq_protocolo_p;

commit;

end if;

nr_seq_gerado_p := nr_seq_prot_novo_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_protocolo_devolucao (nr_seq_protocolo_p bigint, nm_usuario_p text, nr_seq_gerado_p INOUT text) FROM PUBLIC;

