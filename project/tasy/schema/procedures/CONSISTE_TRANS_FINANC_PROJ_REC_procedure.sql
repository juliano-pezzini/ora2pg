-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_trans_financ_proj_rec ( nr_seq_proj_rec_p bigint, nr_seq_titulo_pagar_p bigint, nr_seq_titulo_receber_p bigint, nr_seq_nota_fiscal_p bigint, vl_transacao_p bigint, nr_seq_trans_financ_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE



nr_seq_proj_rec_tp_w			titulo_pagar.nr_seq_proj_rec%type;
nr_seq_proj_rec_tr_w			titulo_receber.nr_seq_proj_rec%type;
nr_seq_proj_rec_nf_w			nota_fiscal_item.nr_seq_proj_rec%type;
ds_documento_w					varchar(20);
qt_reg_w						bigint;
vl_saldo_projeto_w				projeto_recurso_saldo.vl_saldo%type;
ie_proj_rec_w					transacao_financeira.ie_proj_rec%type;
ie_contr_banc_proj_rec_w		parametro_compras.ie_contr_banc_proj_rec%type;
cd_funcao_ativa_w				bigint;


BEGIN

cd_funcao_ativa_w 	:= obter_funcao_ativa;
/*
814 = Controle Bancário
813 = Tesouraria
*/
/*Se tiver projeto recurso na transação, verificar se titulo rec, pagar ou NF possui projeto vinculado aos mesmos diferente da TF*/

if ( coalesce(nr_seq_proj_rec_p,0) <> 0) then
	/*Alterações efetuadas pela Luane na OS 1661447, e estavam em anexo na OS. Como ela se desligou, apenas documentei.*/

	/*Se a TF for Recebimento, deve consistir na Tesouraria e CB. Se for Rendimento, deve consistir apenas no CB*/

	select 	coalesce(max(ie_contr_banc_proj_rec),'N')
	into STRICT 	ie_contr_banc_proj_rec_w
	from 	parametro_compras
	where	cd_estabelecimento = cd_estabelecimento_p;

	vl_saldo_projeto_w := coalesce(projeto_recurso_pck.obter_vl_saldo_proj_rec(nr_seq_proj_rec_p, obter_usuario_ativo, obter_estabelecimento_ativo),0);

	if (ie_contr_banc_proj_rec_w = 'S') and (cd_funcao_ativa_w = 814) then /*Para o CB tem parametro especifico na funcao do compras, e consiste se a TF for Recebimento, para rendimento não consiste*/
	    select 	coalesce(max(ie_proj_rec),'N')
		into STRICT 	ie_proj_rec_w
		from 	transacao_financeira
		where 	nr_sequencia = nr_seq_trans_financ_p;

	    if ((coalesce(vl_transacao_p,0) > vl_saldo_projeto_w) and (ie_proj_rec_w = 'REC'))	then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(791736,'vl_saldo_projeto_w='||campo_mascara_virgula(vl_saldo_projeto_w));
		end if;

	elsif (cd_funcao_ativa_w = 813) then	/*Se for na Tesouraria, faz o que fazia antes, ou seja, so verifica os saldo */
		if (coalesce(vl_transacao_p,0) > vl_saldo_projeto_w) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(791736,'vl_saldo_projeto_w='||campo_mascara_virgula(vl_saldo_projeto_w));
		end if;

	end if;

	/*Verificar se existe projeto recurso no titulo a pagar diferente do projeto informado na transacao*/

	if (coalesce(nr_seq_titulo_pagar_p,0) <> 0) then

		select	count(*)
		into STRICT	qt_reg_w
		from	titulo_pagar a
		where	a.nr_titulo = nr_seq_titulo_pagar_p
		and		(a.nr_seq_proj_rec IS NOT NULL AND a.nr_seq_proj_rec::text <> '')
		and		a.nr_seq_proj_rec = nr_seq_proj_rec_p;

		/*Se não tiver projeto no titulo igual ao projeto da TF, consistir.*/

		if (qt_reg_w = 0) then
			ds_documento_w := substr(wheb_mensagem_pck.get_texto(791207),1,20);
			CALL wheb_mensagem_pck.exibir_mensagem_abort(791227,'ds_documento_w='||ds_documento_w||
														   ';nr_documento_w='||nr_seq_titulo_pagar_p||
														   ';nr_seq_proj_rec_w='||nr_seq_proj_rec_p);
		end if;

	end if;

	/*Verificar se existe projeto recurso no titulo a receber diferente do projeto informado na transacao*/

	if (coalesce(nr_seq_titulo_receber_p,0) <> 0) then

		select	count(*)
		into STRICT	qt_reg_w
		from	titulo_receber a
		where	a.nr_titulo = nr_seq_titulo_receber_p
		and		(a.nr_seq_proj_rec IS NOT NULL AND a.nr_seq_proj_rec::text <> '')
		and		a.nr_seq_proj_rec = nr_seq_proj_rec_p;

		if (qt_reg_w = 0) then
			ds_documento_w := substr(wheb_mensagem_pck.get_texto(791217),1,20);
			CALL wheb_mensagem_pck.exibir_mensagem_abort(791227,'ds_documento_w='||ds_documento_w||
														   ';nr_documento_w='||nr_seq_titulo_receber_p||
														   ';nr_seq_proj_rec_w='||nr_seq_proj_rec_p);
		end if;

	end if;

	/*Projeto recurso da NF da transacao*/

	if (coalesce(nr_seq_nota_fiscal_p,0) <> 0) then
		/*Como a nota pode ter varios itens, primeiro vamos verificar se existe algum item na NF que esteja vinculado ao projeto da TF*/

		select	count(*)
		into STRICT	qt_reg_w
		from	nota_fiscal_item a
		where	a.nr_sequencia = nr_seq_nota_fiscal_p
		and		a.nr_seq_proj_rec = nr_seq_proj_rec_p;

		if (qt_reg_w = 0) then
			ds_documento_w := substr(wheb_mensagem_pck.get_texto(791218),1,20);
			CALL wheb_mensagem_pck.exibir_mensagem_abort(791227,'ds_documento_w='||ds_documento_w||
														   ';nr_documento_w='||nr_seq_nota_fiscal_p||
														   ';nr_seq_proj_rec_w='||nr_seq_proj_rec_p);

		end if;

	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_trans_financ_proj_rec ( nr_seq_proj_rec_p bigint, nr_seq_titulo_pagar_p bigint, nr_seq_titulo_receber_p bigint, nr_seq_nota_fiscal_p bigint, vl_transacao_p bigint, nr_seq_trans_financ_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

