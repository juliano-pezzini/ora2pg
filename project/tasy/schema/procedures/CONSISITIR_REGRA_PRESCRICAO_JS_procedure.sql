-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consisitir_regra_prescricao_js ( nr_atendimento_p bigint, nr_min_prescr_alta_p bigint, ie_gerar_prescr_conta_def_p text, ds_msg_erro_p INOUT text) AS $body$
DECLARE


qt_regra_alta_w		bigint;
dt_alta_prescr_w	timestamp;
ie_continuar_exec_w	varchar(1)	:= 'S';
qt_atend_pac_w		bigint;
ds_erro_w		varchar(255);
			

BEGIN
if (coalesce(nr_atendimento_p,0) > 0) then

	select 	count(*)
	into STRICT	qt_regra_alta_w
	from 	regra_cons_min_prescr_alta;

	select (coalesce(dt_alta, clock_timestamp()) + obter_min_alta_prescr(ie_tipo_atendimento)/1440)
	into STRICT	dt_alta_prescr_w
	from  	atendimento_paciente 
	where 	nr_atendimento = nr_atendimento_p;

	if (qt_regra_alta_w > 0)and (dt_alta_prescr_w < clock_timestamp())then
		begin
		
		ds_msg_erro_p		:= obter_texto_tasy(82833, wheb_usuario_pck.get_nr_seq_idioma);
		ie_continuar_exec_w	:= 'N';
		
		end;
	end if;

	if (ie_continuar_exec_w = 'S')then
		begin
		
		if (qt_regra_alta_w = 0)and (nr_min_prescr_alta_p <> -1)then
			begin
			
			select (coalesce(dt_alta, clock_timestamp()) + nr_min_prescr_alta_p /1440)
			into STRICT	dt_alta_prescr_w
			from  	atendimento_paciente 
			where 	nr_atendimento = nr_atendimento_p;
			
			if (dt_alta_prescr_w < clock_timestamp())then
				begin
				
				ds_msg_erro_p		:= obter_texto_tasy(82835, wheb_usuario_pck.get_nr_seq_idioma);
				ie_continuar_exec_w	:= 'N';
				
				end;
			end if;
			
			end;
		end if;
		
		end;
	end if;

	if (ie_continuar_exec_w = 'S')then
		begin
		
		select  count(*)
		into STRICT	qt_atend_pac_w
		from  	atendimento_paciente
		where 	nr_atendimento = nr_atendimento_p 
		and   	(dt_fim_conta IS NOT NULL AND dt_fim_conta::text <> '');
		
		if (qt_atend_pac_w = 1)then
			begin
			
			ds_msg_erro_p		:= obter_texto_tasy(82843, wheb_usuario_pck.get_nr_seq_idioma);
			ie_continuar_exec_w	:= 'N';
			
			end;
		end if;
		
		end;
	end if;

	if (ie_continuar_exec_w = 'S')then
		begin
		
		if (ie_gerar_prescr_conta_def_p = 'S')then
			begin
			
			ds_erro_w := consistir_prescr_conta(nr_atendimento_p, ds_erro_w);
			
			if (ds_erro_w <> '')then
				begin
				
				ds_msg_erro_p		:= ds_erro_w;
				ie_continuar_exec_w	:= 'N';
				
				end;
			end if;
			
			end;
		end if;
		
		end;
	end if;

	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consisitir_regra_prescricao_js ( nr_atendimento_p bigint, nr_min_prescr_alta_p bigint, ie_gerar_prescr_conta_def_p text, ds_msg_erro_p INOUT text) FROM PUBLIC;

