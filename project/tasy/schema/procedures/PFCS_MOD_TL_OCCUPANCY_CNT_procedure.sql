-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pfcs_mod_tl_occupancy_cnt ( nr_seq_indicator_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text ) AS $body$
DECLARE


-- Variables
pfcs_panel_seq_w					pfcs_panel.nr_sequencia%type;

qt_available_tl_w					numeric(20)    := 0; --> Available Beds
qt_total_in_use_w					numeric(20)    := 0; --> Occupied Beds
qt_total_brkn_pfcs_w				numeric(20)    := 0; --> Blocked Beds
qt_total_aux_w						numeric(20)    := 0; --> Total Capacity
qt_discharge_unit_w					numeric(20)    := 0; --> Discharge Count
BEGIN
	qt_available_tl_w 		:= 	pfcs_func_tl_device_usage('Monitor', 'A', cd_estabelecimento_p);
   	qt_total_in_use_w 		:= 	pfcs_func_tl_device_usage('Monitor', 'U', cd_estabelecimento_p);
   	qt_total_brkn_pfcs_w 	:=  pfcs_func_tl_device_usage('Monitor', 'B_L_D', cd_estabelecimento_p);
	qt_total_aux_w 			:=  qt_available_tl_w + qt_total_in_use_w;

	select	count(*) into STRICT qt_discharge_unit_w
	from	pfcs_service_request sr,
			pfcs_encounter enc,
			pfcs_patient pat,
			pfcs_device dev,
			pfcs_encounter_location el,
			unidade_atendimento uni,
			setor_atendimento sa
	where	upper(sr.si_status) = 'ACTIVE'
	   and	upper(sr.cd_service) = 'E0403'
	   and	sr.nr_seq_encounter = enc.nr_sequencia
	   and	enc.nr_seq_patient = pat.nr_sequencia
	   and	pat.ie_active = '1'
	   and	pat.nr_sequencia = dev.nr_seq_patient
	   and	dev.si_status = 'ACTIVE'
	   and	dev.ds_device_type = 'Monitor'		
	   and	el.nr_seq_encounter = enc.nr_sequencia
	   and	uni.nr_seq_location = el.nr_seq_location
	   and	uni.ie_situacao = 'A'
	   and	uni.cd_setor_atendimento = sa.cd_setor_atendimento
	   and	sa.ie_situacao = 'A'
	   and	sa.cd_estabelecimento_base = cd_estabelecimento_p;

     := pfcs_pck_v2.pfcs_generate_results(
		vl_indicator_p => qt_available_tl_w, vl_indicator_aux_p => qt_total_in_use_w, vl_indicator_help_p => qt_total_brkn_pfcs_w, vl_indicator_assist_p => qt_discharge_unit_w, vl_indicator_collab_p => qt_total_aux_w, nr_seq_indicator_p => nr_seq_indicator_p, nr_seq_operational_level_p => cd_estabelecimento_p, nm_usuario_p => nm_usuario_p, nr_seq_panel_p => pfcs_panel_seq_w);
	commit;
CALL pfcs_pck_v2.pfcs_activate_records(
        nr_seq_indicator_p => nr_seq_indicator_p,
        nr_seq_operational_level_p => cd_estabelecimento_p,
        nm_usuario_p => nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_mod_tl_occupancy_cnt ( nr_seq_indicator_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text ) FROM PUBLIC;

