-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_alter_just_prot_onc ( nr_seq_paciente_p bigint, nr_seq_material_p bigint, nr_seq_regra_p bigint, ds_justificativa_p text, qt_dose_prescr_p bigint default 0) AS $body$
DECLARE


ds_justificativa_w			varchar(255);
nm_usuario_w				varchar(15);
qt_reg_w					bigint;
ds_justif_incons_quimio_w	varchar(255);
qt_dose_prescricao_w		double precision;


BEGIN

if (nr_seq_paciente_p IS NOT NULL AND nr_seq_paciente_p::text <> '') and (nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') and (nr_seq_regra_p IS NOT NULL AND nr_seq_regra_p::text <> '') and ((trim(both ds_justificativa_p) IS NOT NULL AND (trim(both ds_justificativa_p))::text <> ''))then

	ds_justificativa_w := substr(ds_justificativa_p,1,255);
	nm_usuario_w := wheb_usuario_pck.get_nm_usuario;

	Select  count(*)
	into STRICT	qt_reg_w
	from	paciente_atend_erro_just
	where	nr_seq_material = nr_seq_material_p
	and		nr_seq_paciente = nr_seq_paciente_p
	and		nr_seq_regra = nr_seq_regra_p;

	if ( qt_reg_w = 0) then

		insert into paciente_atend_erro_just(nr_sequencia,
											 nr_seq_paciente,
											 nr_seq_material,
											 nm_usuario,
											 nm_usuario_nrec,
											 dt_atualizacao,
											 dt_atualizacao_nrec,
											 ds_justif_incons_quimio,
											 nr_seq_regra,
											 qt_dose_prescricao)
									values ( nextval('paciente_atend_erro_just_seq'),
											nr_seq_paciente_p,
											nr_seq_material_p,
											nm_usuario_w,
											nm_usuario_w,
											clock_timestamp(),
											clock_timestamp(),
											ds_justificativa_w,
											nr_seq_regra_p,
											qt_dose_prescr_p);

	else


		Select  ds_justif_incons_quimio,
				qt_dose_prescricao
		into STRICT	ds_justif_incons_quimio_w,
				qt_dose_prescricao_w
		from	paciente_atend_erro_just
		where	nr_seq_material = nr_seq_material_p
		and		nr_seq_paciente = nr_seq_paciente_p
		and		nr_seq_regra = nr_seq_regra_p;

		if (upper(ds_justif_incons_quimio_w) <> upper(ds_justificativa_p)) or (upper(qt_dose_prescricao_w) <> upper(qt_dose_prescr_p))	then

			Update	paciente_atend_erro_just
			set		ds_justif_incons_quimio = ds_justificativa_w,
					qt_dose_prescricao = qt_dose_prescr_p,
					dt_atualizacao = clock_timestamp(),
					nm_usuario = nm_usuario_w
			where	nr_seq_paciente = nr_seq_paciente_p
			and		nr_seq_material = nr_seq_material_p
			and		nr_seq_regra 	= nr_seq_regra_p;

		end if;

	end if;

	commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_alter_just_prot_onc ( nr_seq_paciente_p bigint, nr_seq_material_p bigint, nr_seq_regra_p bigint, ds_justificativa_p text, qt_dose_prescr_p bigint default 0) FROM PUBLIC;

