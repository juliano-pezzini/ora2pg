-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cp_create_indic_measure_guid ( ds_guidance_p CP_GUIDANCE.DS_GUIDANCE%type, nr_seq_indic_measure_p CP_INDICATOR_MEASURE_GUID.NR_SEQ_INDIC_MEASURE%type, ds_version_p CP_GUIDANCE.DS_VERSION%type, nm_usuario_p CP_INDICATOR_MEASURE_GUID.NM_USUARIO%type ) AS $body$
DECLARE


nr_seq_guidance_w             CP_GUIDANCE.NR_SEQUENCIA%type;
nr_seq_indic_measure_guid_w   CP_INDICATOR_MEASURE_GUID.NR_SEQUENCIA%type;
nr_sequencia_w			      CP_GUIDANCE.NR_SEQUENCIA%type;
ds_version_w			      CP_GUIDANCE.DS_VERSION%type;
ie_situacao_w			      CP_GUIDANCE.IE_SITUACAO%type;


BEGIN

    begin
        select	max(nr_sequencia),
                ds_version
        into STRICT	nr_sequencia_w,
                ds_version_w
        from	CP_GUIDANCE
        where	DS_GUIDANCE = ds_guidance_p
        group by ds_version;
        exception when others then
            nr_sequencia_w := null;
            ds_version_w := null;
    end;

    if (coalesce(nr_sequencia_w::text, '') = '' or ds_version_w <> ds_version_p) then
        if (coalesce(nr_sequencia_w::text, '') = '') then
            ie_situacao_w	:= 'A';
        else
            ie_situacao_w	:= 'I';
        end if;

        select  nextval('cp_guidance_seq')
        into STRICT    nr_seq_guidance_w
;

        insert into CP_GUIDANCE(
            DS_GUIDANCE,
            DT_ATUALIZACAO,
            DT_ATUALIZACAO_NREC,
            IE_ORIGIN,
            IE_SITUACAO,
            NM_USUARIO,
            NM_USUARIO_NREC,
            NR_SEQUENCIA
        ) values (
            ds_guidance_p,
            clock_timestamp(),
            clock_timestamp(),
            'E', -- From Elsevier
            ie_situacao_w,
            nm_usuario_p,
            nm_usuario_p,
            nr_seq_guidance_w
        );

        select  nextval('cp_indicator_measure_guid_seq')
        into STRICT    nr_seq_indic_measure_guid_w
;

        insert into CP_INDICATOR_MEASURE_GUID(
            DT_ATUALIZACAO,
            DT_ATUALIZACAO_NREC,
            IE_ORIGIN,
            IE_SITUACAO,
            NM_USUARIO,
            NM_USUARIO_NREC,
            NR_SEQ_GUIDANCE,
            NR_SEQ_INDIC_MEASURE,
            NR_SEQUENCIA
        ) values (
            clock_timestamp(),
            clock_timestamp(),
            'E', -- From Elsevier
            ie_situacao_w,
            nm_usuario_p,
            nm_usuario_p,
            nr_seq_guidance_w,
            nr_seq_indic_measure_p,
            nr_seq_indic_measure_guid_w
        );

    end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cp_create_indic_measure_guid ( ds_guidance_p CP_GUIDANCE.DS_GUIDANCE%type, nr_seq_indic_measure_p CP_INDICATOR_MEASURE_GUID.NR_SEQ_INDIC_MEASURE%type, ds_version_p CP_GUIDANCE.DS_VERSION%type, nm_usuario_p CP_INDICATOR_MEASURE_GUID.NM_USUARIO%type ) FROM PUBLIC;

