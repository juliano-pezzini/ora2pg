-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_os_sla ( nr_seq_ordem_p bigint, nm_usuario_p text) AS $body$
DECLARE


/*Procedure chamada via botão direito, para forçar uma OS a virar SLA*/

ie_prioridade_w		varchar(10);
ie_classificacao_w		varchar(10);
dt_inicio_prev_w		timestamp;
dt_termino_prev_w		timestamp;
dt_ordem_servico_w	timestamp;
dt_inicio_real_w		timestamp;
cd_estabelecimento_w	smallint := Wheb_usuario_pck.get_cd_estabelecimento;
qt_min_real_inic_w		bigint;
qt_min_real_os_w		bigint;


BEGIN

if (coalesce(nr_seq_ordem_p,0) > 0) then
	begin
	select	ie_prioridade,
		ie_classificacao,
		dt_ordem_servico,
		dt_inicio_real
	into STRICT	ie_prioridade_w,
		ie_classificacao_w,
		dt_ordem_servico_w,
		dt_inicio_real_w
	from	man_ordem_servico
	where	nr_sequencia = nr_seq_ordem_p;

	dt_inicio_prev_w	:= man_obter_hor_com(cd_estabelecimento_w, dt_ordem_servico_w, 30);
	dt_termino_prev_w	:= man_obter_hor_com(cd_estabelecimento_w, dt_ordem_servico_w, 540);

	select	Man_Obter_Min_com(cd_estabelecimento_w, dt_ordem_servico_w, dt_inicio_real_w)
	into STRICT	qt_min_real_inic_w
	;

	select	Man_Obter_Min_SLA_OS(nr_seq_ordem_p, 'COM')
	into STRICT	qt_min_real_os_w
	;

	insert into man_ordem_serv_sla(	nr_sequencia,
					nr_seq_ordem,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_sla,
					ie_prioridade,
					ie_classificacao,
					qt_min_inicio,
					qt_min_termino,
					dt_inicio_prev,
					dt_termino_prev,
					dt_inicio,
					dt_termino,
					qt_desvio,
					nr_seq_status,
					qt_min_real_inic,
					qt_min_real_os,
					ie_tempo,
					cd_estabelecimento,
					dt_ordem,
					qt_desvio_inic,
					nr_seq_estagio,
					nr_seq_equipamento,
					nr_seq_tipo_equipamento,
					nr_seq_sla_regra)
				values (	nextval('man_ordem_serv_sla_seq'),
					nr_seq_ordem_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					0,
					ie_prioridade_w,
					ie_classificacao_w,
					30,
					540,
					dt_inicio_prev_w,
					dt_termino_prev_w,
					dt_inicio_real_w,
					null,
					0,
					415,
					qt_min_real_inic_w,
					qt_min_real_os_w,
					'COM',
					cd_estabelecimento_w,
					dt_ordem_servico_w,
					0,
					null,
					null,
					null,
					null);
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_os_sla ( nr_seq_ordem_p bigint, nm_usuario_p text) FROM PUBLIC;

