-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cp_mensurar_meta_educacional ( nr_seq_pat_cp_goal_p bigint, nr_seq_pat_cp_indic_p bigint, nr_seq_measure_p bigint default null, ds_note_p text DEFAULT NULL, ie_checkbox_p text DEFAULT NULL, ie_component_p text DEFAULT NULL, nm_usuario_p text DEFAULT NULL, nr_sequencia_p INOUT bigint DEFAULT NULL) AS $body$
DECLARE

	

nr_sequencia_eg_w		pat_cp_ind_measure_eg.nr_sequencia%type;
nr_sequencia_item_w		pat_cp_ind_measure_eg_item.nr_sequencia%type;
ds_note_w				pat_cp_ind_measure_eg_item.ds_note%type;
count_bothers_w	        bigint;


BEGIN

select 	coalesce(max(nr_sequencia),0)
into STRICT	nr_sequencia_eg_w
from	pat_cp_ind_measure_eg
where	nr_seq_pat_cp_goal = nr_seq_pat_cp_goal_p
and		coalesce(dt_liberacao::text, '') = '';

if (nr_sequencia_eg_w = 0) then

	select	nextval('pat_cp_ind_measure_eg_seq')
	into STRICT	nr_sequencia_eg_w
	;
	
	insert into pat_cp_ind_measure_eg(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_pat_cp_goal,
					dt_evaluation)
				values (
					nr_sequencia_eg_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_pat_cp_goal_p,
					clock_timestamp());
	
end if;

if (ie_checkbox_p = 'N') then

	delete from pat_cp_ind_measure_eg_item where nr_seq_measure = nr_seq_measure_p and nr_seq_ind_measure_eg = nr_sequencia_eg_w;
    select count(1) into STRICT count_bothers_w from pat_cp_ind_measure_eg_item where nr_seq_ind_measure_eg = nr_sequencia_eg_w;

    if (count_bothers_w = 0) then
        delete from pat_cp_ind_measure_eg where nr_sequencia = nr_sequencia_eg_w;
    end if;

	return;
	
else
	if (ie_component_p = 'lcb') then
	
		select 	max(nr_sequencia)
		into STRICT	nr_sequencia_item_w
		from	pat_cp_ind_measure_eg_item
		where	nr_seq_ind_measure_eg = nr_sequencia_eg_w
		and		nr_seq_pat_cp_indic = nr_seq_pat_cp_indic_p
		and		ie_component = 'lcb';
		
		if (nr_sequencia_item_w IS NOT NULL AND nr_sequencia_item_w::text <> '') then
		
			delete 	from pat_cp_ind_measure_eg_item
			where 	nr_sequencia = nr_sequencia_item_w;

            select count(1) into STRICT count_bothers_w from pat_cp_ind_measure_eg_item where nr_seq_ind_measure_eg = nr_sequencia_eg_w;

            if (count_bothers_w = 0) then
                delete from pat_cp_ind_measure_eg where nr_sequencia = nr_sequencia_eg_w;
            end if;
			
		end if;
		
	elsif (ie_component_p = 'ed') then
		
		update	pat_cp_ind_measure_eg_item
		set		ds_note = ds_note_p
		where	nr_seq_pat_cp_indic = nr_seq_pat_cp_indic_p
		and		nr_seq_ind_measure_eg = nr_sequencia_eg_w;
		
	end if;
end if;

if (nr_seq_measure_p IS NOT NULL AND nr_seq_measure_p::text <> '') then

	select	max(nr_sequencia)
	into STRICT	nr_sequencia_item_w
	from	pat_cp_ind_measure_eg_item
	where	nr_seq_ind_measure_eg = nr_sequencia_eg_w
	and		nr_seq_measure = nr_seq_measure_p;
	
	if (coalesce(nr_sequencia_item_w::text, '') = '') then
	
		insert into	pat_cp_ind_measure_eg_item(
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_seq_ind_measure_eg,
							nr_seq_pat_cp_indic,
							nr_seq_measure,
							ds_note,
							ie_component)
						values (
							nextval('pat_cp_ind_measure_eg_item_seq'),
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							nr_sequencia_eg_w,
							nr_seq_pat_cp_indic_p,
							nr_seq_measure_p,
							ds_note_p,
							ie_component_p);
	
	end if;
	
end if;

commit;
nr_sequencia_p := nr_sequencia_eg_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cp_mensurar_meta_educacional ( nr_seq_pat_cp_goal_p bigint, nr_seq_pat_cp_indic_p bigint, nr_seq_measure_p bigint default null, ds_note_p text DEFAULT NULL, ie_checkbox_p text DEFAULT NULL, ie_component_p text DEFAULT NULL, nm_usuario_p text DEFAULT NULL, nr_sequencia_p INOUT bigint DEFAULT NULL) FROM PUBLIC;

