-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rxt_gerar_status_aplic_agenda ( nr_seq_agenda_p bigint, nr_seq_fase_p bigint, nm_usuario_p text, ie_opcao_p text) AS $body$
DECLARE


qt_campo_fase_w		bigint;
qt_campo_aplic_w	bigint;


BEGIN

if (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') then
	begin
    if (ie_opcao_p = 'F') and (nr_seq_fase_p IS NOT NULL AND nr_seq_fase_p::text <> '') then

        select	count(*)
        into STRICT	qt_campo_fase_w
        from	rxt_campo
        where	nr_seq_fase in (SELECT	nr_seq_fase
                    from	rxt_agenda_fase
                    where	nr_seq_agenda_rxt = nr_seq_agenda_p)
        or	nr_seq_fase = nr_seq_fase_p;
				
        select	count(distinct(nr_seq_campo))
        into STRICT	qt_campo_aplic_w
        from	rxt_campo_aplic
        where	nr_seq_agenda = nr_seq_agenda_p
        and	nr_seq_campo in (SELECT nr_sequencia
                    from rxt_campo 
                    where nr_seq_fase in (select nr_seq_fase
                                from	rxt_agenda_fase
                                where	nr_seq_agenda_rxt = nr_seq_agenda_p)
                                or	nr_seq_fase = nr_seq_fase_p)
        and	ie_evento_aplic = 'A'
        and	ie_evento_valido = 'S';

        if (qt_campo_fase_w = qt_campo_aplic_w) then
            CALL rxt_alterar_status_agenda(nr_seq_agenda_p, 'E', nm_usuario_p);
        elsif (qt_campo_aplic_w > 0) then
            CALL rxt_alterar_status_agenda(nr_seq_agenda_p, 'AP', nm_usuario_p);
        else
            CALL rxt_alterar_status_agenda(nr_seq_agenda_p, 'T', nm_usuario_p);

        end if;
    end if;

    if (ie_opcao_p = 'B') then 

        select	count(*)
        into STRICT	qt_campo_fase_w
        from	rxt_braq_campo_aplic_trat
        where	nr_seq_agenda = nr_seq_agenda_p;

        select	count(distinct(nr_seq_campo_braq))
        into STRICT	qt_campo_aplic_w
        from	rxt_campo_aplic
        where	nr_seq_agenda = nr_seq_agenda_p
        and	    nr_seq_campo_braq in (SELECT nr_sequencia
                            from RXT_BRAQ_CAMPO_APLIC_TRAT
                            where	nr_seq_agenda = nr_seq_agenda_p)
        and	ie_evento_aplic = 'A'
        and	ie_evento_valido = 'S';

        if (qt_campo_fase_w = qt_campo_aplic_w) then
                CALL rxt_alterar_status_agenda(nr_seq_agenda_p, 'E', nm_usuario_p);
            elsif (qt_campo_aplic_w > 0) then
                CALL rxt_alterar_status_agenda(nr_seq_agenda_p, 'AP', nm_usuario_p);
            else
                CALL rxt_alterar_status_agenda(nr_seq_agenda_p, 'T', nm_usuario_p);

        end if;
    end if;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rxt_gerar_status_aplic_agenda ( nr_seq_agenda_p bigint, nr_seq_fase_p bigint, nm_usuario_p text, ie_opcao_p text) FROM PUBLIC;

