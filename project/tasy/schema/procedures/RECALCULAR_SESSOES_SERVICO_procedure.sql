-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE recalcular_sessoes_servico (nr_seq_agenda_p bigint) AS $body$
DECLARE


cd_pessoa_fisica_w		varchar(10);
nr_atendimento_w		bigint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
nr_seq_proc_interno_w		bigint;
nr_secao_w			smallint;
nr_seq_agenda_w			agenda_consulta.cd_pessoa_fisica%type;
nr_controle_secao_w		agenda_consulta.NR_CONTROLE_SECAO%type;
dt_agenda_w			timestamp;
ie_status_f_w			varchar(1) := '';
ie_status_fj_w			varchar(2) := '';
ie_status_i_w			varchar(1) := '';
ie_recalcula_sessao_atual_w	varchar(1);

c01 CURSOR FOR
	SELECT	nr_sequencia
	from	agenda_consulta
	where	ie_status_agenda 	not in ('C', 'B', 'L', 'II', ie_status_f_w, ie_status_fj_w, ie_status_i_w)
	and 	dt_agenda between clock_timestamp() and dt_agenda_w
	AND	cd_pessoa_fisica	= cd_pessoa_fisica_w
	AND	nr_controle_secao	= nr_controle_secao_w
	AND	qt_total_secao	>= nr_secao
	order by dt_agenda;


BEGIN
if (coalesce(nr_seq_agenda_p,0) > 0) then
	ie_recalcula_sessao_atual_w := Obter_Param_Usuario(866, 244, obter_perfil_ativo, obter_usuario_ativo, obter_estabelecimento_ativo, ie_recalcula_sessao_atual_w);
	if (ie_recalcula_sessao_atual_w in ('S','A','C')) then
		ie_status_f_w := 'F';
		ie_status_fj_w := 'FJ';
		ie_status_i_w := 'I';
	end if;
	select	max(cd_pessoa_fisica),
		MAX(NR_CONTROLE_SECAO)
	into STRICT	cd_pessoa_fisica_w,
		nr_controle_secao_w
	from	agenda_consulta
	where	nr_sequencia = nr_seq_agenda_p;

	select 	max(dt_agenda)+1
	into STRICT 	dt_agenda_w
	from 	agenda_consulta
	where 	nr_controle_secao	= nr_controle_secao_w;

	select 	max(nr_sequencia)
	into STRICT	nr_seq_agenda_w
	from 	agenda_consulta
	where 	nr_controle_secao	= nr_controle_secao_w
	and 	cd_pessoa_fisica = cd_pessoa_fisica_w
	and 	dt_agenda between clock_timestamp() and dt_agenda_w
	and 	ie_status_agenda not in ('C', 'B', 'L', 'II', ie_status_f_w, ie_status_fj_w, ie_status_i_w);

	select	max(nr_atendimento),
		max(cd_procedimento),
		max(ie_origem_proced),
		max(nr_seq_proc_interno),
		max(nr_secao),
		MAX(NR_CONTROLE_SECAO)
	into STRICT	nr_atendimento_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		nr_seq_proc_interno_w,
		nr_secao_w,
		nr_controle_secao_w
	from	agenda_consulta
	where	nr_sequencia = nr_seq_agenda_w;

	if (nr_secao_w IS NOT NULL AND nr_secao_w::text <> '') and (nr_secao_w = 1) then
		nr_secao_w := 0;
	else
		SELECT	coalesce(MAX(nr_secao),0)
		into STRICT	nr_secao_w
		FROM	agenda_consulta
		WHERE	ie_status_agenda	not in ('C', 'B', 'L', 'II', ie_status_f_w, ie_status_fj_w, ie_status_i_w)
		AND	dt_agenda		< clock_timestamp()
		AND	cd_pessoa_fisica	= cd_pessoa_fisica_w
		AND	nr_controle_secao	= nr_controle_secao_w
		AND	qt_total_secao	> nr_secao;
	end if;

	open c01;
	loop
	fetch c01 into	nr_seq_agenda_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		update	agenda_consulta
		set	nr_secao	= nr_secao_w + 1
		where	nr_sequencia	= nr_seq_agenda_w;

		nr_secao_w	:= nr_secao_w + 1;
		end;
	end loop;
	close c01;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE recalcular_sessoes_servico (nr_seq_agenda_p bigint) FROM PUBLIC;

