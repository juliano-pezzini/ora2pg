-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_baixa_lote ( nr_prescricao_p bigint, cd_material_p bigint, qt_material_p bigint, nr_seq_lote_fornec_p bigint, cd_local_estoque_p bigint, dt_entrada_unidade_p timestamp, cd_tipo_baixa_p bigint, ie_prescrito_p text, nr_seq_material_p bigint, ie_acao_p text, nr_lote_prescr_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_opcao_p INOUT text, ds_erro_p INOUT text) AS $body$
DECLARE

 
nr_prescricao_w		bigint;
cd_material_w		integer;
qt_material_w		double precision;
nr_seq_lote_fornec_w	bigint;
cd_local_estoque_w	smallint;
dt_entrada_unidade_w	timestamp;
cd_tipo_baixa_w		smallint;
ie_prescrito_w		varchar(1);
nr_seq_lote_w		bigint;
nr_seq_material_w	bigint;
ie_acao_w		varchar(1);
ds_erro_w		varchar(255) := '';
ds_material_w		varchar(255);

/* 
ie_opcao_p 
LT = Limpa tabela 
IT = Inseri itens tabela 
*/
 
 
C01 CURSOR FOR 
	SELECT	nr_prescricao, 
		cd_material, 
		qt_material, 
		nr_seq_lote_fornec, 
		cd_local_estoque, 
		dt_entrada_unidade, 
		cd_tipo_baixa, 
		ie_prescrito, 
		nr_seq_lote, 
		nr_seq_material, 
		ie_acao 
	from	w_gerar_itens_lote_ap 
	where	nm_usuario = nm_usuario_p 
	and	nr_seq_lote = nr_lote_prescr_p;


BEGIN 
 
if (coalesce(ie_opcao_p,'X') = 'LT') or (coalesce(ie_opcao_p,'X') = 'IT') then 
 
	if (coalesce(ie_opcao_p,'X') = 'LT') then 
 
		delete	FROM w_gerar_itens_lote_ap 
		where	nm_usuario = nm_usuario_p;
		 
		commit;
	 
	end if;
 
	insert into w_gerar_itens_lote_ap( 
		nr_prescricao, 
		cd_material, 
		qt_material, 
		nr_seq_lote_fornec, 
		cd_local_estoque, 
		dt_entrada_unidade, 
		cd_tipo_baixa, 
		ie_prescrito, 
		nr_seq_lote, 
		nr_seq_material, 
		ie_acao, 
		nm_usuario) 
	values (	nr_prescricao_p, 
		cd_material_p, 
		qt_material_p, 
		nr_seq_lote_fornec_p, 
		cd_local_estoque_p, 
		dt_entrada_unidade_p, 
		cd_tipo_baixa_p, 
		ie_prescrito_p, 
		nr_lote_prescr_p, 
		nr_seq_material_p, 
		ie_acao_p, 
		nm_usuario_p);
 
else 
	 
	open C01;
	loop 
	fetch C01 into	 
		nr_prescricao_w, 
		cd_material_w, 
		qt_material_w, 
		nr_seq_lote_fornec_w, 
		cd_local_estoque_w, 
		dt_entrada_unidade_w, 
		cd_tipo_baixa_w, 
		ie_prescrito_w, 
		nr_seq_lote_w, 
		nr_seq_material_w, 
		ie_acao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		 
		ds_material_w := cd_material_w || ' ' || obter_desc_material(cd_material_w);
     		 
		ds_erro_w := consiste_material_barras_lote(	nr_prescricao_w, cd_material_w, qt_material_w, nr_seq_lote_fornec_w, cd_estabelecimento_p, cd_local_estoque_w, dt_entrada_unidade_w, cd_tipo_baixa_w, nr_seq_lote_w, nm_usuario_p, 'B', ds_erro_w);
		 
		if (ds_erro_w <> '') then 
			ds_erro_w := ds_erro_w || ds_material_w;
			exit;
		end if;
		 
		end;
	end loop;
	close C01;
	 
	if (coalesce(ds_erro_w::text, '') = '') then 
	 
		open C01;
		loop 
		fetch C01 into	 
			nr_prescricao_w, 
			cd_material_w, 
			qt_material_w, 
			nr_seq_lote_fornec_w, 
			cd_local_estoque_w, 
			dt_entrada_unidade_w, 
			cd_tipo_baixa_w, 
			ie_prescrito_w, 
			nr_seq_lote_w, 
			nr_seq_material_w, 
			ie_acao_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin 
	 
			CALL baixar_material_barras_lote(	nr_prescricao_w, 
							cd_material_w, 
							qt_material_w, 
							nr_seq_lote_fornec_w, 
							cd_estabelecimento_p, 
							cd_local_estoque_w, 
							dt_entrada_unidade_w, 
							cd_tipo_baixa_w, 
							ie_prescrito_w, 
							nr_seq_lote_w, 
							nr_seq_material_w, 
							'B', 
							nm_usuario_p);
			 
			end;
		end loop;
		close C01;
	 
	end if;
	 
end if;
 
if (ie_opcao_p = 'LT') then 
	ie_opcao_p := 'IT';
end if;
 
ds_erro_p := ds_erro_w;
 
if (coalesce(ds_erro_w::text, '') = '') then 
	commit;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_baixa_lote ( nr_prescricao_p bigint, cd_material_p bigint, qt_material_p bigint, nr_seq_lote_fornec_p bigint, cd_local_estoque_p bigint, dt_entrada_unidade_p timestamp, cd_tipo_baixa_p bigint, ie_prescrito_p text, nr_seq_material_p bigint, ie_acao_p text, nr_lote_prescr_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_opcao_p INOUT text, ds_erro_p INOUT text) FROM PUBLIC;

