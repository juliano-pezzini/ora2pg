-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rep_copia_item_gas ( nr_prescricao_orig_p bigint, nr_prescricao_p bigint, nr_seq_gas_old_p bigint, nr_seq_gasoterapia_p bigint, nr_seq_material_p bigint, nm_usuario_p text, nr_dia_util_p bigint default null, nr_seq_regra_p bigint default null) AS $body$
DECLARE

								

nr_agrup_acum_w				bigint;
qt_itens_w					bigint;
nr_sequencia_w				bigint;
ie_loop_w					varchar(2);
cd_material_w				bigint;
--C01
ds_horarios_w				varchar(2000);
ds_horarios_cursor_w		varchar(2000);
ds_horarios2_w				varchar(2000);
nr_agrupamento_w			bigint;
nr_ocorrencia_w				bigint;
nr_dia_util_w				bigint;
hr_prim_horario_w			varchar(50);
dt_inicio_medic_w			timestamp;
ie_param_1180_w				varchar(2);
cd_perfil_w					integer;
cd_estabelecimento_w		integer;
--C02
ie_manter_intervalo_w		varchar(1);
ie_regra_geral_w			varchar(15);
ie_operacao_w				varchar(15);
qt_operacao_w				double precision;
dt_inicio_prescr_w			timestamp;
nr_horas_validade_w			bigint;
cd_intervalo_w				varchar(255);
qt_material_w				prescr_material.qt_material%type;
qt_dispensar_w				prescr_material.qt_total_dispensar%type;
ie_regra_disp_w				prescr_material.ie_regra_disp%type;
ds_erro_w					varchar(2000);

C01 CURSOR FOR
SELECT  a.ie_origem_inf,
		a.cd_material,
		a.cd_unidade_medida,
		a.qt_dose,
		a.qt_unitaria,
		a.qt_material,
		a.cd_intervalo,
		a.ds_horarios ds_horarios_cursor_w,
		a.ds_observacao ds_observacao,
		a.ds_observacao_enf ds_observacao_enf,
		a.ie_via_aplicacao,
		a.nr_agrupamento + nr_agrup_acum_w nr_agrupamento_w,
		coalesce(a.ie_cobra_paciente,'S') ie_cobra_paciente,
		CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.cd_motivo_baixa  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  0  ELSE a.cd_motivo_baixa END  END  cd_motivo_baixa,
		CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  clock_timestamp()  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  null  ELSE clock_timestamp() END  END  dt_baixa,
		a.ie_utiliza_kit,
		a.cd_unidade_medida_dose,
		a.qt_conversao_dose,
		a.nr_ocorrencia,
		a.qt_total_dispensar,
		a.cd_fornec_consignado,
		CASE WHEN coalesce(a.nr_sequencia_solucao::text, '') = '' THEN  null  ELSE a.nr_sequencia_solucao END  nr_sequencia_solucao,
		CASE WHEN coalesce(a.nr_sequencia_proc::text, '') = '' THEN  null  ELSE a.nr_sequencia_proc END  nr_sequencia_proc,
		a.qt_solucao,
		a.ds_dose_diferenciada,
		a.ie_medicacao_paciente,
		CASE WHEN coalesce(a.nr_sequencia_diluicao::text, '') = '' THEN  null  ELSE a.nr_sequencia_diluicao END  nr_sequencia_diluicao,
		CASE WHEN a.ie_se_necessario='S' THEN  null  ELSE a.hr_prim_horario END  hr_prim_horario,
		CASE WHEN coalesce(a.nr_sequencia_dieta::text, '') = '' THEN null  ELSE a.nr_sequencia_dieta END  nr_sequencia_dieta,
		a.ie_agrupador,
		a.nr_dia_util,
		CASE WHEN b.ie_situacao='A' THEN  'N'  ELSE 'S' END  ie_situacao,
		a.ie_se_necessario,
		a.qt_min_aplicacao,
		a.ie_bomba_infusao,
		coalesce(a.ie_aplic_bolus,'N') ie_aplic_bolus,
		coalesce(a.ie_aplic_lenta,'N') ie_aplic_lenta,
		coalesce(a.ie_acm,'N') ie_acm,
		a.ie_objetivo,
		a.cd_topografia_cih,
		a.ie_origem_infeccao,
		a.cd_amostra_cih,
		a.cd_microorganismo_cih,
		coalesce(a.ie_uso_antimicrobiano,'N') ie_uso_antimicrobiano,
		a.cd_protocolo,
		a.nr_seq_protocolo,
		a.nr_seq_mat_protocolo,
		a.qt_hora_aplicacao,
		a.qt_vel_infusao,
		CASE WHEN 'S'='S' THEN CASE WHEN coalesce(b.nr_dias_justif,0)=0 THEN  a.ds_justificativa  ELSE CASE WHEN Obter_se_maior(b.nr_dias_justif, coalesce(nr_dia_util_w,0)+1)='N' THEN a.ds_justificativa END  END   ELSE '' END  ds_justificativa,		
		a.ie_sem_aprazamento,
		a.ie_indicacao,
		a.dt_proxima_dose,
		a.qt_total_dias_lib,
		a.nr_seq_substituto,
		a.ie_lado,
		a.dt_inicio_medic,
		a.qt_dia_prim_hor,
		CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.ie_regra_disp  ELSE null END  ie_regra_disp,
		a.qt_vol_adic_reconst,
		a.qt_hora_intervalo,
		a.qt_min_intervalo
From	Material b,
		Prescr_Material a
where	(a.nr_seq_gasoterapia IS NOT NULL AND a.nr_seq_gasoterapia::text <> '')
and		coalesce(a.nr_sequencia_diluicao::text, '') = ''
and		a.ie_suspenso 	<> 'S'
and		(((ie_param_1180_w = 'S') and (a.ie_origem_inf not in ('K','A'))) or															
		 (ie_param_1180_w = 'N' AND a.ie_origem_inf	<> 'K'))
and		b.ie_situacao	= 'A'
and		a.cd_material 	= b.cd_material
and		a.ie_agrupador = 15
and		a.nr_seq_gasoterapia = nr_seq_gas_old_p
and		a.nr_prescricao = nr_prescricao_orig_p;

c01_w	c01%rowtype;

c02 CURSOR FOR
SELECT	ie_regra_geral,
	coalesce(ie_manter_intervalo, 'N')
from	rep_regra_copia_crit
where	ie_tipo_item	= 'GAS'
and		nr_seq_regra	= nr_seq_regra_p
order by nr_seq_apres;


BEGIN

select	coalesce(max(nr_agrupamento),0)
into STRICT	nr_agrup_acum_w
from	prescr_material
where	nr_prescricao = nr_prescricao_p;

select  coalesce(max(nr_dia_util),0) + 1
into STRICT	nr_dia_util_w
from    prescr_gasoterapia
where   nr_sequencia	= nr_seq_gas_old_p
and		nr_prescricao	= nr_prescricao_orig_p;

select	max(cd_intervalo)
into STRICT	cd_intervalo_w
from	prescr_gasoterapia
where	nr_sequencia	= nr_seq_gasoterapia_p
and		nr_prescricao	= nr_prescricao_p;

select	max(dt_inicio_prescr),
		coalesce(max(nr_horas_validade), 24)
into STRICT	dt_inicio_prescr_w,
		nr_horas_validade_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p  LIMIT 1;

CALL Wheb_assist_pck.set_informacoes_usuario(cd_estabelecimento_w, cd_perfil_w, nm_usuario_p);
ie_param_1180_w		:= Wheb_assist_pck.obterParametroFuncao(924, 1180);

open c02;
loop
fetch c02 into	
	ie_regra_geral_w,
	ie_manter_intervalo_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
end loop;
close c02;
	
open C01;
loop
fetch C01 into	
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

	ie_loop_w	:= 'S';
	nr_sequencia_w	:= 1;
	while(ie_loop_w = 'S') loop
		select	count(*)
		into STRICT	qt_itens_w
		from	prescr_material
		where	nr_prescricao	= nr_prescricao_p
		and		nr_sequencia	= nr_sequencia_w  LIMIT 1;
		
		if (qt_itens_w	= 0) then
			ie_loop_w	:= 'N';
		else	
			nr_sequencia_w	:= nr_sequencia_w + 1;
		end if;
	end loop;

	if (length(c01_w.nr_agrupamento_w) >= 4) then
		select	coalesce(max(nr_agrupamento),0) + 1
		into STRICT	nr_agrupamento_w
		from	prescr_material
		where	nr_prescricao	= nr_prescricao_p;
	end if;
	
	qt_material_w 	:= null;
	qt_dispensar_w	:= null;
	ie_regra_disp_w	:= null;
	ds_erro_w		:= null;
	
	if (ie_regra_geral_w = 'H') then
		if (ie_manter_intervalo_w = 'S') and (c01_w.cd_intervalo IS NOT NULL AND c01_w.cd_intervalo::text <> '') then
			
			select	max(dt_prev_execucao)
			into STRICT	dt_inicio_medic_w
			from	prescr_gasoterapia
			where	nr_sequencia = nr_seq_gasoterapia_p
			and		nr_prescricao = nr_prescricao_p  LIMIT 1;
			
			if (dt_inicio_medic_w IS NOT NULL AND dt_inicio_medic_w::text <> '') then				
				hr_prim_horario_w	:= to_char(dt_inicio_medic_w,'hh24:mi');


				
				ds_horarios_w := c01_w.ds_horarios_cursor_w;
				nr_ocorrencia_w := 0;
				SELECT * FROM Calcular_Horario_Prescricao(nr_prescricao_p, c01_w.cd_intervalo, dt_inicio_prescr_w, dt_inicio_medic_w, nr_horas_validade_w, /*cd_material_w*/
null, 0, 0, nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w, 'N', '') INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w;
				ds_horarios_w := ds_horarios_w || ds_horarios2_w;
				
				SELECT * FROM Obter_Quant_Dispensar(wheb_usuario_pck.get_cd_estabelecimento, c01_w.cd_material, nr_prescricao_p, nr_sequencia_w, c01_w.cd_intervalo, c01_w.ie_via_aplicacao, c01_w.qt_unitaria, null, nr_ocorrencia_w, null, c01_w.ie_origem_inf, c01_w.cd_unidade_medida_dose, 1, qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w, c01_w.ie_se_necessario, c01_w.ie_acm) INTO STRICT qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w;
			end if;
		end if;
	elsif (ie_regra_geral_w = 'I') then
		hr_prim_horario_w	:= c01_w.hr_prim_horario;
		ds_horarios_w 	:= c01_w.ds_horarios_cursor_w;
	end if;

	insert  into prescr_material(
		nr_prescricao,
		nr_sequencia,
		ie_origem_inf,
		cd_material,
		cd_unidade_medida,
		qt_dose,
		qt_unitaria,
		qt_material,
		dt_atualizacao,
		nm_usuario,
		cd_intervalo,
		ds_horarios,
		ds_observacao,
		ds_observacao_enf,
		ie_via_aplicacao,
		nr_agrupamento,
		ie_cobra_paciente,
		cd_motivo_baixa,
		dt_baixa,
		ie_utiliza_kit,
		cd_unidade_medida_dose,
		qt_conversao_dose,
		ie_urgencia,
		nr_ocorrencia,
		qt_total_dispensar,
		cd_fornec_consignado,
		nr_sequencia_solucao,
		nr_sequencia_proc,
		qt_solucao,
		hr_dose_especial,
		qt_dose_especial,
		ds_dose_diferenciada,
		ie_medicacao_paciente,
		nr_sequencia_diluicao,
		hr_prim_horario,
		nr_sequencia_dieta,
		ie_agrupador,
		nr_dia_util,
		ie_suspenso,
		ie_se_necessario,
		qt_min_aplicacao,
		ie_bomba_infusao,
		ie_aplic_bolus,
		ie_aplic_lenta,
		ie_acm,
		ie_objetivo,
		cd_topografia_cih,
		ie_origem_infeccao,
		cd_amostra_cih,
		cd_microorganismo_cih,
		ie_uso_antimicrobiano,
		cd_protocolo,
		nr_seq_protocolo,
		nr_seq_mat_protocolo,
		qt_hora_aplicacao,
		ie_recons_diluente_fixo,
		qt_vel_infusao,
		ds_justificativa,
		ie_sem_aprazamento,
		ie_indicacao,
		dt_proxima_dose,
		qt_total_dias_lib,
		nr_seq_substituto,
		ie_lado,
		dt_inicio_medic,
		qt_dia_prim_hor,
		ie_regra_disp,
		qt_vol_adic_reconst,
		qt_hora_intervalo,
		qt_min_intervalo,
		nr_seq_gasoterapia,
		nr_prescricao_original)
	values ( nr_prescricao_p,
		nr_sequencia_w,
		c01_w.ie_origem_inf,
		c01_w.cd_material,
		c01_w.cd_unidade_medida,
		c01_w.qt_dose,
		c01_w.qt_unitaria,
		coalesce(qt_material_w,c01_w.qt_material),
		clock_timestamp(),
		nm_usuario_p,
		c01_w.cd_intervalo,
		ds_horarios_w,
		c01_w.ds_observacao,
		c01_w.ds_observacao_enf,
		c01_w.ie_via_aplicacao,
		nr_agrupamento_w,
		c01_w.ie_cobra_paciente,
		c01_w.cd_motivo_baixa,
		c01_w.dt_baixa,
		c01_w.ie_utiliza_kit,
		c01_w.cd_unidade_medida_dose,
		c01_w.qt_conversao_dose,
		'N',
		coalesce(nr_ocorrencia_w,c01_w.nr_ocorrencia),
		coalesce(qt_dispensar_w,c01_w.qt_total_dispensar),
		c01_w.cd_fornec_consignado,
		c01_w.nr_sequencia_solucao,
		c01_w.nr_sequencia_proc,
		c01_w.qt_solucao,
		null,
		null,
		c01_w.ds_dose_diferenciada,
		c01_w.ie_medicacao_paciente,
		c01_w.nr_sequencia_diluicao,
		hr_prim_horario_w,
		c01_w.nr_sequencia_dieta,
		c01_w.ie_agrupador,
		coalesce(nr_dia_util_p, c01_w.nr_dia_util),
		c01_w.ie_situacao,
		c01_w.ie_se_necessario,
		c01_w.qt_min_aplicacao,
		c01_w.ie_bomba_infusao,
		c01_w.ie_aplic_bolus,
		c01_w.ie_aplic_lenta,
		c01_w.ie_acm,
		c01_w.ie_objetivo,
		c01_w.cd_topografia_cih,
		c01_w.ie_origem_infeccao,
		c01_w.cd_amostra_cih,
		c01_w.cd_microorganismo_cih,
		c01_w.ie_uso_antimicrobiano,
		c01_w.cd_protocolo,
		c01_w.nr_seq_protocolo,
		c01_w.nr_seq_mat_protocolo,
		c01_w.qt_hora_aplicacao,
		'N',
		c01_w.qt_vel_infusao,
		c01_w.ds_justificativa,
		c01_w.ie_sem_aprazamento,
		c01_w.ie_indicacao,
		c01_w.dt_proxima_dose,
		c01_w.qt_total_dias_lib,
		c01_w.nr_seq_substituto,
		c01_w.ie_lado,
		dt_inicio_medic_w,
		c01_w.qt_dia_prim_hor,
		coalesce(ie_regra_disp_w,c01_w.ie_regra_disp),
		c01_w.qt_vol_adic_reconst,
		c01_w.qt_hora_intervalo,
		c01_w.qt_min_intervalo,
		nr_seq_gasoterapia_p,
		nr_prescricao_orig_p);
	
end loop;
close c01;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

if (ie_param_1180_w = 'S') then
	CALL Gerar_med_mat_assoc_gas(
				nr_prescricao_p,
				nr_seq_gasoterapia_p,
				nm_usuario_p,	
				'N',	
				cd_intervalo_w);

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rep_copia_item_gas ( nr_prescricao_orig_p bigint, nr_prescricao_p bigint, nr_seq_gas_old_p bigint, nr_seq_gasoterapia_p bigint, nr_seq_material_p bigint, nm_usuario_p text, nr_dia_util_p bigint default null, nr_seq_regra_p bigint default null) FROM PUBLIC;

