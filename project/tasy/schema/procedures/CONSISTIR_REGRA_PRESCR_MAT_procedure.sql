-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_regra_prescr_mat (nr_prescricao_p bigint, nr_seq_material_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, ds_erro_p INOUT text, ds_proced_glosa_p INOUT text, cd_perfil_aviso_p INOUT text, nm_usuario_aviso_p INOUT text) AS $body$
DECLARE


/* parametros */

ie_consistir_saldo_estoque_w	varchar(15);
ie_prescr_nao_padronizado_w		varchar(15);
ie_receita_cadastro_w			varchar(15);
ie_prescr_composto_w			varchar(15);
ie_exigir_via_aplicacao_w		varchar(15);
nr_seq_estrutura_w				varchar(10);
qt_material_limite_w			bigint;
/* parametros medicos */

ie_consistir_regra_uso_w		varchar(15);
ie_justificar_sn_w				varchar(1);
ds_prim_horario_w				varchar(2000);
ds_intervalos_w					varchar(2000);
VarIeConsisteKit_w				varchar(1);
VarConsisteDilSolucao_w			varchar(1);
ie_consiste_estoque_w			varchar(1);
ie_obriga_just_dose_w           varchar(1);
ie_permite_sn_w					varchar(15);
qt_min_total_aplic_w			bigint;
ie_via_medic_w					varchar(15);
ie_consistir_w					varchar(1);
ie_permite_agora_w				varchar(1);
ie_consistir_glosa_convenio_w	varchar(15);
ie_permite_w					varchar(15);
ie_bomba_infusao_w				prescr_material.ie_bomba_infusao%type := null;
ie_bomba_infusao_sol_w			prescr_solucao.ie_bomba_infusao%type := null;
ie_via_aplic_sol_w				varchar(15);
ie_dias_util_medic_w			varchar(15);
qt_volume_leite_w				double precision;
ie_regra_volume_leite_w			varchar(5);
nr_seq_leite_deriv_w			bigint;
ie_consiste_dupl_w				varchar(15);
ds_material_w					varchar(255);
nm_usuario_aviso_w				varchar(4000);
nm_usuario_aviso_ww				varchar(4000);
cd_perfil_aviso_w				varchar(20);
cd_perfil_aviso_ww				varchar(2000);
ie_solucao_w					varchar(15);
ds_stack_w						varchar(2000);
ie_consignado_w					varchar(15);
ie_permite_com_justificativa_w	varchar(15);
VarGeraDilSolucao_w				varchar(15);
ie_consiste_dias_w				varchar(15);
ie_exigir_via_aplic_dieta_w		varchar(15);
ie_consistir_setor_material_w	varchar(15);
cd_unidade_medida_consumo_w		varchar(50);
ds_item_w						varchar(2000);
ds_compl_w						varchar(2000);
cd_cgc_fornecedor_w				varchar(200);
ds_hor_aux_w					varchar(2000);
ds_erro_prescr_w				varchar(2000);
nr_prescricao_anterior_w		bigint;
qt_hora_aplicacao_w				bigint;
nr_dias_lib_w					bigint;
cd_grupo_material_w				bigint;
qt_operacao_w					bigint;
cd_subgrupo_w					bigint;
nr_seq_familia_w				bigint;
cd_classe_material_w			bigint;
nr_dias_justif_w				smallint;
ie_justificar_acm_w				varchar(1);
ie_horario_null_w				varchar(1);
ie_justificar_acm_sn_so_w		varchar(1);
ie_justificar_agora_w			varchar(1);
dt_prim_hor_prescr_w			timestamp;
dt_prim_hor_medic_w				timestamp;
nr_seq_mat_w					bigint;
ie_consiste_perido_w			varchar(1);
/* antimicrobianos */

ie_justificativa_antimicrob_w	varchar(1);
ie_objetivo_antimicrob_w		varchar(1);
ds_erro_w						varchar(255);
ie_dia_utilizacao_antimicrob_w	varchar(1);
ie_gera_horarios_w				varchar(10);
ie_topografia_antimicrob_w		varchar(1);
ie_amostra_antimicrob_w			varchar(1);
ie_microorganismo_antimicrob_w	varchar(1);
ie_origem_antimicrob_w			varchar(1);
ie_atualiza_estoque_w			varchar(10);
ie_avaliacao_antimicrob_w		varchar(1);
ie_exige_cid_antimicrob_w		varchar(1);
qt_peso_prescr_w				real;
cd_material_substituir_w		bigint;
qt_dia_prim_hor_w				bigint;
ie_indicacao_antimicrob_w		varchar(1);
/* globais */

nr_seq_erro_w					bigint;
nr_seq_solucao_w				bigint;
nr_horas_validade_w				integer;
nr_seq_kit_w					bigint;
ie_erro_liberar_prescr_w		varchar(255);
ie_consistir_antimicrobiano_w	varchar(1);
qt_erro_nao_lib_w				bigint;
qt_erro_lib_w					bigint;
cont_w							bigint;
cont2_w							bigint;
/* regras */

qt_saldo_disponivel_estoque_w	double precision;
qt_estoque_minimo_w				double precision;
nr_sequencia_proc_w				integer;
dt_suspensao_w					timestamp;
ie_erro_regra_uso_w				varchar(255);
ie_acao_excesso_w				convenio_regra_qtde_mat.ie_acao_excesso%type;
ie_erro_intervalo_w				varchar(255);
ie_setor_regra_w				varchar(1);
ie_erro_prescritor_w			varchar(255);
ie_supera_limite_uso_w			varchar(1)	:= 'N';
ie_sn_interv_w					varchar(1);
ie_acm_interv_w					varchar(1);
/* rep */

cd_estab_prescr_w				smallint;
cd_setor_prescr_w				integer;
cd_local_prescr_w				smallint;
cd_local_estoque_ww				bigint;
dt_inicio_prescr_w				timestamp;
dt_prim_horario_w				timestamp;
dt_validade_prescr_w			timestamp;
dt_prescricao_w					timestamp;
hr_prescricao_w					varchar(5);
nr_atendimento_w				bigint;
nr_seq_atepacu_w				bigint;
qt_solucao_w					double precision;
qt_volume_diluicao_w			double precision;
cd_pessoa_prescr_w				varchar(10);
ie_prescr_emergencia_w			varchar(1);
hr_primeiro_horario_w			varchar(5);
hr_inicio_prescr_w				varchar(5);
nr_sequencia_diluicao_w			bigint;
ds_diluente_w					varchar(255);
hr_validade_prescr_w			varchar(5);
cd_prescritor_w					varchar(10);
qt_dias_lib_w					smallint;
qt_material_prescr_w			bigint;
qt_min_aplicacao_w				smallint;
/* material */

ie_libera_w						varchar(3);
count_w							bigint;
cd_material_w					integer;
cd_material_ww					integer;
cd_diluente_w					integer;
cd_rediluente_w					integer;
cd_reconst_w					integer;
ie_agrupador_w					smallint;
qt_total_dispensar_w			double precision;
hr_prim_horario_w				varchar(5);
hr_dose_especial_w				varchar(5);
cd_intervalo_w					varchar(7);
qt_dose_w						double precision;
ds_dose_diferenciada_w			varchar(50);
ds_dose_diferenciada_ww			varchar(50);
qt_unitaria_w					double precision;
nr_ocorrencia_w					double precision;
nr_ocorrencias_sist_w			double precision;
nr_ocorrencias_atual_w			double precision;
ie_via_aplicacao_w				varchar(5);
ie_ctrl_medico_antimicrob_w		varchar(1);
ie_objetivo_w					varchar(1);
ie_se_necessario_w				varchar(1);
qt_dias_solicitado_w			smallint;
nr_dia_util_w					bigint;
ie_novo_ciclo_ccih_w			varchar(1);
cd_topografia_cih_w				bigint;
cd_amostra_cih_w				bigint;
cd_microorganismo_cih_w			bigint;
ie_origem_infeccao_w			varchar(1);
nr_seq_avaliacao_w				bigint;
ds_justificativa_w				varchar(2000);
ie_cid_informado_w				varchar(1);
cd_unid_med_dose_w				varchar(30);
ie_medicacao_paciente_w			varchar(1);
nr_agrupamento_w				double precision;
qt_material_w					double precision;
nr_receita_w					bigint;
ie_situacao_via_aplicacao_w		varchar(1);
ie_unid_med_compativel_w		varchar(1);
ie_material_disponivel_w		varchar(1);
ie_material_diluicao_w			varchar(1);
ie_material_diluido_w			varchar(1);
ie_situacao_material_w			varchar(1);
ie_material_prescricao_w		varchar(1);
ie_situacao_diluente_w			varchar(1);
ie_diluente_prescricao_w		varchar(1);
ie_situacao_rediluente_w		varchar(1);
ie_rediluente_prescricao_w		varchar(1);
ie_situacao_reconstituinte_w	varchar(1);
ie_reconstituinte_prescricao_w	varchar(1);
qt_max_dia_aplic_w				smallint;
ie_material_padronizado_w		varchar(1);
ie_intervalo_composto_valido_w	varchar(1);
ie_material_exige_justif_w		varchar(1);
ie_mat_necessita_receita_w		varchar(1);
qt_dias_lib_prescr_w			smallint;
qt_dia_terapeutico_w			smallint;
qt_dia_profilatico_w			smallint;
ie_medic_composto_w				varchar(1);
ie_material_lado_w				varchar(15);
ie_lado_w						varchar(15);
ie_urgencia_w					varchar(1);
ie_sem_aprazamento_w			varchar(1);
ds_horarios_w					varchar(2000);
ie_acm_w						varchar(1);
ds_compl_erro_w					varchar(2000);
ie_concentracao_medic_w			varchar(255);
ie_indicacao_w					varchar(1);
qt_dose_min_w					double precision;
cd_unidade_medida_min_w			varchar(30);
qt_classif_dif_w				bigint;
qt_classif_igual_w				bigint;
qt_max_classif_w				bigint;
qt_produtos_vig_w				bigint;
dt_inicio_item_w				timestamp;
ie_componente_diluido_w			varchar(1);
ie_permite_fracionado_w			varchar(1);
/* gerais */

ie_situacao_via_w				varchar(3);
nr_dia_util_matmed_w			bigint;
qt_dias_liberado_w				bigint;
ie_controle_medico_w			varchar(10);
qt_total_dias_lib_w				bigint;
ie_paciente_alergico_w			varchar(1);
ie_erro_dose_usual_w			varchar(255);
ie_erro_dose_maxima_w			varchar(2000);
ie_erro_maximo_dias_w			varchar(255);
ie_erro_interv_horas_w			varchar(255);
ds_observacao_w					varchar(4000);
cd_convenio_w					integer;
cd_categoria_w					varchar(10);
cd_tipo_acomodacao_w			smallint;
ie_tipo_atendimento_w			smallint;
tx_ajuste_w						double precision 	:= 0;
vl_negociado_w					double precision 	:= 0;
ie_preco_informado_w			varchar(1)	:= '0';
ie_glosa_w						varchar(1);
tx_brasindice_pfb_w				REGRA_AJUSTE_MATERIAL.TX_BRASINDICE_PFB%type := 0;--number(15,4)	:= 0;
tx_brasindice_pmc_w				CONVENIO_BRASINDICE.TX_BRASINDICE_PMC%type;	--number(15,4)	:= 0;
tx_pmc_neg_w					CONVENIO_BRASINDICE.TX_PMC_NEG%type;--number(15,4)	:= 0;
tx_pmc_pos_w					CONVENIO_BRASINDICE.TX_PMC_POS%type;--number(15,4)	:= 0;
tx_afaturar_w					double precision	:= 0;
tx_simpro_pfb_w					double precision	:= 0;
tx_simpro_pmc_w					double precision	:= 0;
ie_origem_preco_w				varchar(5)	:= '0';
ie_precedencia_w				varchar(1)	:= '0';
pr_glosa_w					double precision	:= 0;
vl_glosa_w					double precision	:= 0;
cd_tabela_preco_w				bigint	:= 0;
cd_motivo_exc_conta_w			bigint;
nr_seq_regra_w					bigint;
ie_autor_particular_w			varchar(1);
cd_convenio_glosa_w				integer	:= 0;
cd_categoria_glosa_w			varchar(10)	:= ' ';
cd_plano_convenio_w				varchar(10);
ie_erro_autorizacao_w			varchar(255);
ie_bloqueia_agenda_w			varchar(1);
ie_regra_plano_w				smallint;
nr_seq_regra_plano_w			bigint;
qt_peso_w						double precision;
ds_consist_mat_w				varchar(4000);
ie_pertence_estrutura_w			varchar(1);
ie_albubina_justi_w				varchar(1);
ie_tipo_material_w				varchar(3);
ie_dia_semana_w					bigint;
dt_liberacao_w					timestamp;
ie_medico_habilitado_w			varchar(1)	:= 'S';
qt_conversao_dose_w				double precision;
qt_dose_ww						double precision;
cd_unidade_medida_est_w 		varchar(10);
ie_prim_hor_w					varchar(2);
ie_sexo_material_w				varchar(2);
ie_sexo_paciente_w				varchar(2);
ie_obr_justificativa_w			varchar(2);
ie_obr_justificativa_ww			varchar(2);
ie_dose_espec_agora_w			varchar(2);
qt_dose_especial_w				double precision;
ds_mensagem_w					varchar(2000);
ds_horarios_inconsistentes_w	varchar(2000);
qt_ocorrencias_hor_w			bigint;
qt_suspenso_w					bigint;
nr_agrupamento_ww				double precision;
qt_agrupamento_w				bigint;
cd_pessoa_fisica_w				varchar(10);
qt_max_dia_aplic_ww				smallint;
ie_item_superior_w				varchar(1);
x								bigint;
dt_suspensao_ww					timestamp;
ie_obriga_just_w				varchar(1);
ie_loop_w						smallint;
h								integer;
dt_liberacao_medico_w			timestamp;
ie_justifica_dias_util_w		varchar(1);
ds_carct_min_just_w				varchar(10);
qt_carct_min_just_w				bigint;
ds_mens_nao_per_mat_w			varchar(2000);
tx_pfb_neg_w					CONVENIO_BRASINDICE.TX_PFB_NEG%type;--number(15,4)	:= 0;
tx_pfb_pos_w					CONVENIO_BRASINDICE.TX_PFB_POS%type;--number(15,4)	:= 0;
ds_via_disp_w					varchar(255);
vl_procedimento_w				bigint;
vl_material_w					bigint;
ieAutConvComJust_w				varchar(1);
cd_kit_material_w				bigint;
cd_material_conta_w				bigint;
cd_material_estoque_ww			bigint;
vl_neutro_w						varchar(10);
ie_situacao_interv_w			varchar(10);
nr_seq_classif_w				bigint;
ds_horarios_1w					varchar(255);
ds_horarios_2w					varchar(255);
qt_hora_intervalo_w				integer;
qt_min_intervalo_w				integer;
tx_simpro_pos_pfb_w				double precision;
tx_simpro_neg_pfb_w				double precision;
tx_simpro_pos_pmc_w				double precision;
tx_simpro_neg_pmc_w				double precision;
qt_idade_w						double precision;
qt_aplic_max_pad_w				smallint;
qt_aplic_min_pad_w				smallint;
ie_duplicado_prescr_w			varchar(1);
cd_intervaloAcmSn_w				varchar(10);
cd_material_estoque_w			bigint;
nr_seq_ficha_tecnica_w			bigint;
/* Regra autor */

qt_autorizada_w					bigint;
qt_negada_w						bigint;
qt_item_prescrito_w				bigint;
ie_clinica_w					integer;
ie_obriga_tempo_aplic_w			varchar(1);
ie_aplic_bolus_w				varchar(1);
ie_aplic_lenta_w				varchar(1);
ie_via_endov_w					bigint;
nr_seq_lib_mat_pac_w			bigint;
ie_em_protocolo_vanco_w			varchar(1);
ie_indicacao_solic_w			varchar(1);
qt_dia_interv_profilaxia_w		integer;
qt_dias_profilaxia_w			integer;
dt_horario_w					timestamp;
ds_inconsis277_w				varchar(255);
ie_via_nao_recomendada_w		varchar(1);
qt_dias_tratamento_w			prescr_material.qt_dias_tratamento%type;
ie_feriado_w					bigint;
ie_data_antimicrobiano_w 		varchar(1);
nm_usuario_original_w			prescr_medica.nm_usuario_original%type;
ie_dias_validade_w				varchar(1);
ie_mesma_vigencia_w				varchar(1);
VarConsisteObsACMSN_w			varchar(15);
ie_permite_lib_just_w			varchar(1);
nr_seq_mat_cpoe_w				prescr_Material.nr_seq_mat_cpoe%type;
cd_funcao_origem_w				prescr_medica.cd_funcao_origem%type;
ie_param953_w					varchar(1);
ds_param1056_w					varchar(255);
ie_param215_w					varchar(1);
ie_param216_w					varchar(1);
ds_justificativa_prescr_w		prescr_medica.ds_justificativa%type;
ie_tipo_erro_consis_w			varchar(1);
ie_lib_mat_result_exame_w		varchar(1) := 'S';
ds_inf_just_exam_w				varchar(4000);
qt_caract_just_dose_lim_w		bigint;
cd_protocolo_w					bigint;
nr_seq_protocolo_w				integer;
cd_protocolo_item_w				bigint;
ie_liberar_w					regra_material_duplic.ie_liberar%type;
qt_riscos_medic_w				bigint;
qt_dose_limite_w				double precision;
cd_unidade_medida_limte_w		varchar(15);	
cd_unidade_medida_estoque_w		material.cd_unidade_medida_estoque%type;
nr_sequencia_anterior_w			prescr_material.nr_sequencia_anterior%type;
dt_mesano_referencia_w			fornecedor_mat_consignado.dt_mesano_referencia%type;
cd_fornec_consignado_w			pessoa_juridica.cd_cgc%type;

/* regras antimicrobianos */

c01 CURSOR FOR
SELECT	ie_justificativa,
		ie_objetivo,
		ie_dia_utilizacao,
		ie_topografia,
		ie_amostra,
		ie_microorganismo,
		ie_origem,
		ie_avaliacao,
		ie_exige_cid,
		ie_indicacao
from	regra_antimicrobiano
where	cd_regra		= ie_ctrl_medico_antimicrob_w
and		cd_estabelecimento		= cd_estabelecimento_p
and		((coalesce(cd_perfil::text, '') = '') or (cd_perfil = cd_perfil_p))
and		((coalesce(cd_intervalo::text, '') = '') or (cd_intervalo = cd_intervalo_w))
and		((coalesce(cd_grupo_material::text, '') = '') or (cd_grupo_material = cd_grupo_material_w))
and		((coalesce(cd_subgrupo_material::text, '') = '') or (cd_subgrupo_material = cd_subgrupo_w))
and		((coalesce(nr_seq_familia::text, '') = '') or (nr_seq_familia = nr_seq_familia_w))
and		((coalesce(cd_classe_material::text, '') = '') or (cd_classe_material = cd_classe_material_w))
and		((coalesce(cd_material::text, '') = '') or (cd_material = cd_material_w))
and		coalesce(cd_material_estoque, coalesce(cd_material_estoque_w,0)) = coalesce(cd_material_estoque_w,0)
and		coalesce(nr_seq_ficha_tecnica, coalesce(nr_seq_ficha_tecnica_w,0)) = coalesce(nr_seq_ficha_tecnica_w,0)
and		coalesce(cd_setor_atendimento, coalesce(cd_setor_prescr_w, 0)) = coalesce(cd_setor_prescr_w, 0)
and		((coalesce(ie_objetivo_filtro::text, '') = '') or (ie_objetivo_filtro = ie_objetivo_w) or
		(((ie_objetivo_w in ('P', 'C', 'F')) and (ie_objetivo_filtro = 'R')) or ((ie_objetivo_w in ('T', 'E', 'D')) and (ie_objetivo_filtro = 'G'))))
--and		((ie_objetivo_filtro = ie_objetivo_w) or
--		 (ie_objetivo_filtro is null))
and		(((ie_dia_semana = 9) or (coalesce(ie_dia_semana,ie_dia_semana_w) = ie_dia_semana_w))
		or (ie_feriado_w > 0 AND ie_dia_semana = 0))
and		((coalesce(dt_hora_inicio::text, '') = '') or (to_char(dt_hora_inicio,'hh24:mi:ss') < to_char(clock_timestamp(),'hh24:mi:ss')))
and		((coalesce(dt_hora_fim::text, '') = '') or (to_char(dt_hora_fim,'hh24:mi:ss') > to_char(clock_timestamp(),'hh24:mi:ss')))
order by
		coalesce(cd_material,0),
		coalesce(cd_material_estoque,0),
		coalesce(nr_seq_ficha_tecnica,0),
		coalesce(nr_seq_familia,0),
		coalesce(cd_classe_material,0),
		coalesce(cd_subgrupo_material,0),
		coalesce(cd_grupo_material,0),
		coalesce(cd_perfil,0),
		coalesce(ie_dia_semana,0),
		coalesce(to_char(dt_hora_inicio,'hh24:mi:ss'),'00:00:00'),
		coalesce(to_char(dt_hora_fim,'hh24:mi:ss'),'00:00:00'),
		coalesce(ie_objetivo_filtro,'X') desc;

c02 CURSOR FOR
SELECT	cd_local_estoque
from	setor_local
where	cd_setor_atendimento	= cd_setor_prescr_w;

c06 CURSOR FOR
SELECT	nm_usuario_aviso,
		to_char(cd_perfil_aviso)
from	regra_ajuste_mat_aviso
where	nr_seq_regra = nr_seq_regra_w;

c07 CURSOR FOR
SELECT	coalesce(ie_liberar,'N')
from	regra_material_duplic
where	coalesce(cd_classe_material,cd_classe_material_w)	= cd_classe_material_w
and	coalesce(cd_grupo_material,cd_grupo_material_w) 	= cd_grupo_material_w
and	coalesce(cd_subgrupo_material,cd_subgrupo_w) 	= cd_subgrupo_w
and	coalesce(cd_material,cd_material_w) 			= cd_material_w
and	coalesce(cd_setor_atendimento,cd_setor_prescr_w) 	= cd_setor_prescr_w
and	((coalesce(ie_consiste_justificativa,'N') = 'N') or (coalesce(ds_justificativa_w::text, '') = ''))
and coalesce(ie_consistir,'D')  = 'D'
order by
        coalesce(cd_setor_atendimento,99999),
		coalesce(cd_material,999999) desc;


c00 REFCURSOR;


BEGIN

select	a.cd_estabelecimento,
		a.cd_setor_atendimento,
		coalesce(obter_local_estoque_setor(a.cd_setor_atendimento,a.cd_estabelecimento),0) cd_local_prescr,
		a.dt_prescricao,
		to_char(a.dt_prescricao,'hh24:mi'),
		a.nr_atendimento,
		a.cd_pessoa_fisica,
		a.ie_prescr_emergencia,
		to_char(a.dt_primeiro_horario,'hh24:mi'),
		obter_convenio_atendimento(a.nr_atendimento),
		substr(obter_categoria_atendimento(a.nr_atendimento),1,10),
		substr(obter_tipo_acomod_atend(a.nr_atendimento,'C'),1,4),
		obter_tipo_atendimento(a.nr_atendimento),
		substr(obter_dados_categ_conv(a.nr_atendimento,'P'),1,10),
		to_char(a.dt_inicio_prescr,'hh24:mi'),
		to_char(a.dt_validade_prescr,'hh24:mi'),
		a.dt_liberacao,
		a.cd_prescritor,
		a.qt_peso,
		a.nr_horas_validade,
		a.dt_inicio_prescr,
		a.dt_validade_prescr,
		a.cd_pessoa_fisica,
		a.dt_liberacao_medico,
		a.nr_prescricao_anterior,
		obter_idade_pf(a.cd_pessoa_fisica, clock_timestamp(), 'A'),
		obter_clinica_atend(nr_atendimento,'C'),
		a.nm_usuario_original,
		a.ds_justificativa,
		a.cd_protocolo,
		a.nr_seq_protocolo,
		a.cd_funcao_origem
into STRICT	cd_estab_prescr_w,
		cd_setor_prescr_w,
		cd_local_prescr_w,
		dt_prescricao_w,
		hr_prescricao_w,
		nr_atendimento_w,
		cd_pessoa_prescr_w,
		ie_prescr_emergencia_w,
		hr_primeiro_horario_w,
		cd_convenio_w,
		cd_categoria_w,
		cd_tipo_acomodacao_w,
		ie_tipo_atendimento_w,
		cd_plano_convenio_w,
		hr_inicio_prescr_w,
		hr_validade_prescr_w,
		dt_liberacao_w,
		cd_prescritor_w,
		qt_peso_prescr_w,
		nr_horas_validade_w,
		dt_inicio_prescr_w,
		dt_validade_prescr_w,
		cd_pessoa_fisica_w,
		dt_liberacao_medico_w,
		nr_prescricao_anterior_w,
		qt_idade_w,
		ie_clinica_w,
		nm_usuario_original_w,
		ds_justificativa_prescr_w,
		cd_protocolo_w,
		nr_seq_protocolo_w,
		cd_funcao_origem_w
from	prescr_medica a
where	a.nr_prescricao	= nr_prescricao_p;

if (nr_atendimento_w > 0) then
	qt_peso_w	:= obter_sinal_vital(nr_atendimento_w,'Peso');
end if;

ie_dia_semana_w	:= pkg_date_utils.get_WeekDay(clock_timestamp());
CALL Wheb_assist_pck.set_informacoes_usuario( cd_estab_prescr_w, cd_perfil_p, nm_usuario_p);
ie_prescr_nao_padronizado_w 	:= Wheb_assist_pck.obterParametroFuncao(924,18);
ie_receita_cadastro_w 			:= Wheb_assist_pck.obterParametroFuncao(924,152);
ie_prescr_composto_w 			:= Wheb_assist_pck.obterParametroFuncao(924,224);
ie_exigir_via_aplicacao_w 		:= Wheb_assist_pck.obterParametroFuncao(924,8);
nr_seq_estrutura_w 				:= Wheb_assist_pck.obterParametroFuncao(924,239);
ie_gera_horarios_w 				:= Wheb_assist_pck.obterParametroFuncao(924,116);
ie_obriga_just_w 				:= Wheb_assist_pck.obterParametroFuncao(924,485);
ds_carct_min_just_w 			:= Wheb_assist_pck.obterParametroFuncao(924,27);
ie_permite_com_justificativa_w 	:= Wheb_assist_pck.obterParametroFuncao(924,625);
ie_exigir_via_aplic_dieta_w 	:= Wheb_assist_pck.obterParametroFuncao(924,766);
VarIeConsisteKit_w 				:= Wheb_assist_pck.obterParametroFuncao(924,779);
ieAutConvComJust_w 				:= Wheb_assist_pck.obterParametroFuncao(924,829);
qt_max_classif_w 				:= Wheb_assist_pck.obterParametroFuncao(924,877);
VarGeraDilSolucao_w 			:= Wheb_assist_pck.obterParametroFuncao(924,601);
VarConsisteDilSolucao_w 		:= Wheb_assist_pck.obterParametroFuncao(924,980);
VarConsisteObsACMSN_w			:= Wheb_assist_pck.obterParametroFuncao(924,464);
ie_param953_w					:= Wheb_assist_pck.obterParametroFuncao(924,953);
ds_param1056_w					:= Wheb_assist_pck.obterParametroFuncao(924,1056);
ie_param215_w					:= Wheb_assist_pck.obterParametroFuncao(924,215);
ie_param216_w					:= Wheb_assist_pck.obterParametroFuncao(924,216);
qt_caract_just_dose_lim_w		:= Wheb_assist_pck.obterParametroFuncao(924,1183);

begin

qt_carct_min_just_w	:= (ds_carct_min_just_w)::numeric;
exception
	when others then
		qt_carct_min_just_w := 0;
end;

select	coalesce(max(ie_consiste_regra_uso_conv),'N'),
		coalesce(max(ie_just_se_necessario),'N'),
		coalesce(max(ie_consiste_glosa_conv),'N'),
		coalesce(max(ie_consiste_setor_mat),'N'),
		coalesce(max(ie_just_acm),'N'),
		coalesce(max(ie_just_suplemen),'N'),
		coalesce(max(ie_just_agora),'N'),
		coalesce(max(ie_data_antimicrobiano),'M'),
		coalesce(max(ie_dias_validade),'S')
into STRICT	ie_consistir_regra_uso_w,
		ie_justificar_sn_w,
		ie_consistir_glosa_convenio_w,
		ie_consistir_setor_material_w,
		ie_justificar_acm_w,
		ie_justificar_acm_sn_SO_w,
		ie_justificar_agora_w,
		ie_data_antimicrobiano_w,
		ie_dias_validade_w
from	parametro_medico
where	cd_estabelecimento	= cd_estabelecimento_p;


if (nr_seq_material_p = 0) then
	delete	FROM prescr_medica_erro
	where	nr_prescricao	= nr_prescricao_p
	and		(nr_seq_medic IS NOT NULL AND nr_seq_medic::text <> '');

  delete	FROM prescr_medica_erro_just
	where	nr_prescricao	= nr_prescricao_p
	and		(nr_seq_medic IS NOT NULL AND nr_seq_medic::text <> '');
	
	delete	FROM prescr_medica_risco
	where	nr_prescricao	= nr_prescricao_p
	and		(nr_seq_risco IS NOT NULL AND nr_seq_risco::text <> '');

	CALL Verificar_interacao_medic(nr_prescricao_p);

	open c00 for
	SELECT	b.cd_material,
			b.ie_agrupador,
			b.qt_total_dispensar,
			b.hr_prim_horario,
			b.hr_dose_especial,
			b.cd_intervalo,
			coalesce(b.qt_dose,0),
			b.ds_dose_diferenciada,
			b.qt_unitaria,
			b.nr_ocorrencia,
			b.ie_via_aplicacao,
			substr(obter_controle_medic(c.cd_material,cd_estabelecimento_p,c.ie_controle_medico,null,null,null),1,1),
			b.ie_objetivo,
			coalesce(b.ie_se_necessario,'N'),
			coalesce(b.qt_dias_solicitado,0),
			b.nr_dia_util,
			coalesce(b.ie_novo_ciclo_ccih,'N'),
			b.cd_topografia_cih,
			b.cd_amostra_cih,
			b.cd_microorganismo_cih,
			b.ie_origem_infeccao,
			b.nr_seq_avaliacao,
			b.ds_justificativa,
			substr(obter_se_cid_medic_preenchido(b.nr_prescricao,b.nr_sequencia),1,1),
			b.cd_unidade_medida_dose,
			b.ie_medicacao_paciente,
			b.nr_agrupamento,
			b.qt_material,
			b.nr_receita,
			substr(obter_situacao_via_aplic(b.ie_via_aplicacao),1,1),
			substr(obter_se_unid_med_compativel(b.cd_material,b.cd_unidade_medida_dose),1,1),
			substr(coalesce(c.ie_disponivel_mercado,'N'),1,1),
			substr(coalesce(c.ie_diluicao,'N'),1,1),
			substr(obter_se_material_diluido(b.nr_prescricao,b.nr_sequencia),1,1),
			substr(coalesce(c.ie_situacao,'A'),1,1),
			substr(obter_se_material_prescricao(cd_estabelecimento_p,b.cd_material),1,1),
			--substr(obter_situacao_material(cd_diluente_w),1,1),
			--substr(obter_se_material_prescricao(cd_estabelecimento_p,cd_diluente_w),1,1),
			--substr(obter_situacao_material(cd_rediluente_w),1,1),
			--substr(obter_se_material_prescricao(cd_estabelecimento_p,cd_rediluente_w),1,1),
			--substr(obter_situacao_material(cd_reconst_w),1,1),
			--substr(obter_se_material_prescricao(cd_estabelecimento_p,cd_reconst_w),1,1),
			obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_max_dia_aplic,'DA',ie_tipo_atendimento_w,cd_setor_prescr_w,ie_clinica_w),
			coalesce(substr(obter_se_material_padronizado(cd_estabelecimento_p,b.cd_material),1,1),'N'),
			substr(consistir_interv_item_composto(b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento,b.cd_intervalo),1,1),
			substr(coalesce(obter_dados_medic_atb_var(c.cd_material,cd_estabelecimento_p,c.ie_obriga_justificativa,'OJ',ie_tipo_atendimento_w,cd_setor_prescr_w,ie_clinica_w),'N'),1,1),
			substr(c.ie_receita,1,1),
			b.qt_dias_liberado,
			coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_terapeutico,'DT',ie_tipo_atendimento_w,cd_setor_prescr_w,ie_clinica_w),0),
			coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_profilatico,'DP',ie_tipo_atendimento_w,cd_setor_prescr_w,ie_clinica_w),0),
			substr(obter_se_medic_composto(b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento),1,1),
			substr(c.ie_exige_lado,1,1),
			b.ie_lado,
			coalesce(b.ie_urgencia,'N'),
			coalesce(b.ie_sem_aprazamento,'N'),
			coalesce(b.ie_acm,'N'),
			b.ds_horarios,
			b.QT_SOLUCAO,
			ie_indicacao,
			b.IE_DOSE_ESPEC_AGORA,
			b.nr_seq_kit,
			b.nr_sequencia_proc,
			b.dt_suspensao,
			b.QT_DIAS_LIBERADO,
			b.ds_observacao,
			b.qt_dia_prim_hor,
			b.qt_hora_aplicacao,
			b.qt_min_aplicacao,
			obter_dados_medic_atb_var(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.ie_consiste_dias,'CD',ie_tipo_atendimento_w,cd_setor_prescr_w,ie_clinica_w),
			b.cd_kit_material,
			b.qt_dose_especial,
			c.nr_dias_justif,
			obter_se_material_diluido_sol(b.nr_prescricao,b.nr_sequencia),
			coalesce(c.ie_consiste_estoque,'S'),
			coalesce(c.ie_consiste_dupl,'N'),
			obter_diluente_material(b.nr_prescricao,b.nr_sequencia),
			obter_rediluente_material(b.nr_prescricao,b.nr_sequencia),
			obter_reconstituinte_material(b.nr_prescricao,b.nr_sequencia),
			b.nr_sequencia_solucao,
			coalesce(obter_dados_medic_atb_var(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.ie_justifica_dias_util,'JD',ie_tipo_atendimento_w,cd_setor_prescr_w,ie_clinica_w),'N'),
			c.ie_dias_util_medic,
			coalesce(c.ie_consignado,'0'),
			c.ie_tipo_material,
			coalesce(c.ie_sexo,'A'),
			b.ie_item_superior,
			c.ie_solucao,
			b.nr_sequencia,
			substr(c.ds_material,1,255),
			coalesce(c.ie_permite_fracionado,'S'),
			Obter_limites_Param_Prescr(b.cd_material,b.ie_via_aplicacao,cd_setor_prescr_w,cd_pessoa_prescr_w,qt_idade_w,qt_peso_prescr_w,b.ie_se_necessario,'AM',b.cd_intervalo,b.ie_agrupador) qt_aplic_min_pad,
			Obter_limites_Param_Prescr(b.cd_material,b.ie_via_aplicacao,cd_setor_prescr_w,cd_pessoa_prescr_w,qt_idade_w,qt_peso_prescr_w,b.ie_se_necessario,'AH',b.cd_intervalo,b.ie_agrupador) qt_aplic_max_pad,
			c.cd_unidade_medida_consumo,
			coalesce(b.ie_regra_volume_leite,'I'),
			b.nr_seq_leite_deriv,
			coalesce(c.ie_obriga_tempo_aplic,'N'),
			coalesce(b.ie_aplic_bolus,'N'),
			coalesce(b.ie_aplic_lenta,'N'),
			b.nr_seq_lib_mat_pac,
			coalesce(b.ie_em_protocolo_vanco, 'N'),
			c.qt_dia_interv_profilaxia,
			coalesce(b.qt_dias_tratamento,0),
			coalesce(b.nr_seq_mat_cpoe,0),
			b.cd_protocolo,
			b.nr_sequencia_anterior,
			b.ie_bomba_infusao,
			b.cd_fornec_consignado
	from		material c,
			prescr_material b
	where		b.nr_prescricao	= nr_prescricao_p
	and		c.cd_material	= b.cd_material
	and		coalesce(b.dt_suspensao::text, '') = ''
	and		b.ie_agrupador not in (3,7,9,10,11)
	and		coalesce(b.nr_sequencia_dieta::text, '') = '';


elsif (nr_prescricao_p > 0) and (nr_seq_material_p > 0) then
	delete	FROM prescr_medica_erro
	where	nr_prescricao	= nr_prescricao_p
	and	nr_seq_medic	= nr_seq_material_p;

  delete	FROM prescr_medica_erro_just
	where	nr_prescricao	= nr_prescricao_p
	and	nr_seq_medic	= nr_seq_material_p;
	
	delete	FROM prescr_medica_risco
	where	nr_prescricao	= nr_prescricao_p
	and		(nr_seq_risco IS NOT NULL AND nr_seq_risco::text <> '');

	open c00 for
	SELECT	b.cd_material,
			b.ie_agrupador,
			b.qt_total_dispensar,
			b.hr_prim_horario,
			b.hr_dose_especial,
			b.cd_intervalo,
			coalesce(b.qt_dose,0),
			b.ds_dose_diferenciada,
			b.qt_unitaria,
			b.nr_ocorrencia,
			b.ie_via_aplicacao,
			substr(obter_controle_medic(c.cd_material,cd_estabelecimento_p,c.ie_controle_medico,null,null,null),1,1),
			b.ie_objetivo,
			coalesce(b.ie_se_necessario,'N'),
			coalesce(b.qt_dias_solicitado,0),
			b.nr_dia_util,
			coalesce(b.ie_novo_ciclo_ccih,'N'),
			b.cd_topografia_cih,
			b.cd_amostra_cih,
			b.cd_microorganismo_cih,
			b.ie_origem_infeccao,
			b.nr_seq_avaliacao,
			b.ds_justificativa,
			substr(obter_se_cid_medic_preenchido(b.nr_prescricao,b.nr_sequencia),1,1),
			b.cd_unidade_medida_dose,
			b.ie_medicacao_paciente,
			b.nr_agrupamento,
			b.qt_material,
			b.nr_receita,
			substr(obter_situacao_via_aplic(b.ie_via_aplicacao),1,1),
			substr(obter_se_unid_med_compativel(b.cd_material,b.cd_unidade_medida_dose),1,1),
			substr(coalesce(c.ie_disponivel_mercado,'N'),1,1),
			substr(coalesce(c.ie_diluicao,'N'),1,1),
			substr(obter_se_material_diluido(b.nr_prescricao,b.nr_sequencia),1,1),
			substr(coalesce(c.ie_situacao,'A'),1,1),
			substr(obter_se_material_prescricao(cd_estabelecimento_p,b.cd_material),1,1),
			--substr(obter_situacao_material(cd_diluente_w),1,1),
			--substr(obter_se_material_prescricao(cd_estabelecimento_p,cd_diluente_w),1,1),
			--substr(obter_situacao_material(cd_rediluente_w),1,1),
			--substr(obter_se_material_prescricao(cd_estabelecimento_p,cd_rediluente_w),1,1),
			--substr(obter_situacao_material(cd_reconst_w),1,1),
			--substr(obter_se_material_prescricao(cd_estabelecimento_p,cd_reconst_w),1,1),
			obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_max_dia_aplic,'DA',ie_tipo_atendimento_w,cd_setor_prescr_w,ie_clinica_w),
			coalesce(substr(obter_se_material_padronizado(cd_estabelecimento_p,b.cd_material),1,1),'N'),
			substr(consistir_interv_item_composto(b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento,b.cd_intervalo),1,1),
			substr(coalesce(c.ie_obriga_justificativa,'N'),1,1),
			substr(c.ie_receita,1,1),
			b.qt_dias_liberado,
			coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_terapeutico,'DT',ie_tipo_atendimento_w,cd_setor_prescr_w,ie_clinica_w),0),
			coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_profilatico,'DP',ie_tipo_atendimento_w,cd_setor_prescr_w,ie_clinica_w),0),
			substr(obter_se_medic_composto(b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento),1,1),
			substr(c.ie_exige_lado,1,1),
			b.ie_lado,
			coalesce(b.ie_urgencia,'N'),
			coalesce(b.ie_sem_aprazamento,'N'),
			coalesce(b.ie_acm,'N'),
			b.ds_horarios,
			b.QT_SOLUCAO,
			ie_indicacao,
			b.IE_DOSE_ESPEC_AGORA,
			b.nr_seq_kit,
			b.nr_sequencia_proc,
			b.dt_suspensao,
			b.QT_DIAS_LIBERADO,
			b.ds_observacao,
			b.qt_dia_prim_hor,
			b.qt_hora_aplicacao,
			b.qt_min_aplicacao,
			c.ie_consiste_dias,
			b.cd_kit_material,
			b.qt_dose_especial,
			c.nr_dias_justif,
			obter_se_material_diluido_sol(b.nr_prescricao,b.nr_sequencia),
			coalesce(c.ie_consiste_estoque,'S'),
			coalesce(c.ie_consiste_dupl,'N'),
			obter_diluente_material(b.nr_prescricao,b.nr_sequencia),
			obter_rediluente_material(b.nr_prescricao,b.nr_sequencia),
			obter_reconstituinte_material(b.nr_prescricao,b.nr_sequencia),
			b.nr_sequencia_solucao,
			coalesce(obter_dados_medic_atb_var(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.ie_justifica_dias_util,'JD',ie_tipo_atendimento_w,cd_setor_prescr_w,ie_clinica_w),'N'),
			c.ie_dias_util_medic,
			coalesce(c.ie_consignado,'0'),
			c.ie_tipo_material,
			coalesce(c.ie_sexo,'A'),
			b.ie_item_superior,
			c.ie_solucao,
			b.nr_sequencia,
			substr(c.ds_material,1,255),
			coalesce(c.ie_permite_fracionado,'S'),
			Obter_limites_Param_Prescr(b.cd_material,b.ie_via_aplicacao,cd_setor_prescr_w,cd_pessoa_prescr_w,qt_idade_w,qt_peso_prescr_w,b.ie_se_necessario,'AM',b.cd_intervalo,b.ie_agrupador) qt_aplic_min_pad,
			Obter_limites_Param_Prescr(b.cd_material,b.ie_via_aplicacao,cd_setor_prescr_w,cd_pessoa_prescr_w,qt_idade_w,qt_peso_prescr_w,b.ie_se_necessario,'AH',b.cd_intervalo,b.ie_agrupador) qt_aplic_max_pad,
			c.cd_unidade_medida_consumo,
			coalesce(b.ie_regra_volume_leite,'I'),
			b.nr_seq_leite_deriv,
			coalesce(c.ie_obriga_tempo_aplic,'N'),
			coalesce(b.ie_aplic_bolus,'N'),
			coalesce(b.ie_aplic_lenta,'N'),
			b.nr_seq_lib_mat_pac,
			coalesce(b.ie_em_protocolo_vanco, 'N'),
			c.qt_dia_interv_profilaxia,
			coalesce(b.qt_dias_tratamento,0),
			coalesce(b.nr_seq_mat_cpoe,0),
			b.cd_protocolo,
			b.nr_sequencia_anterior,
			b.ie_bomba_infusao,
			b.cd_fornec_consignado
	from	material c,
			prescr_material b
	where	b.nr_prescricao	= nr_prescricao_p
	and		c.cd_material	= b.cd_material
	and		b.nr_sequencia	= nr_seq_material_p
	and		coalesce(b.dt_suspensao::text, '') = ''
	and		b.ie_agrupador not in (3,7,9,10,11)
	and		coalesce(b.nr_sequencia_dieta::text, '') = '';
end if;



loop
fetch c00 into
	cd_material_w,
	ie_agrupador_w,
	qt_total_dispensar_w,
	hr_prim_horario_w,
	hr_dose_especial_w,
	cd_intervalo_w,
	qt_dose_w,
	ds_dose_diferenciada_w,
	qt_unitaria_w,
	nr_ocorrencia_w,
	ie_via_aplicacao_w,
	ie_ctrl_medico_antimicrob_w,
	ie_objetivo_w,
	ie_se_necessario_w,
	qt_dias_solicitado_w,
	nr_dia_util_w,
	ie_novo_ciclo_ccih_w,
	cd_topografia_cih_w,
	cd_amostra_cih_w,
	cd_microorganismo_cih_w,
	ie_origem_infeccao_w,
	nr_seq_avaliacao_w,
	ds_justificativa_w,
	ie_cid_informado_w,
	cd_unid_med_dose_w,
	ie_medicacao_paciente_w,
	nr_agrupamento_w,
	qt_material_w,
	nr_receita_w,
	ie_situacao_via_aplicacao_w,
	ie_unid_med_compativel_w,
	ie_material_disponivel_w,
	ie_material_diluicao_w,
	ie_material_diluido_w,
	ie_situacao_material_w,
	ie_material_prescricao_w,
--	ie_situacao_diluente_w,
	--ie_diluente_prescricao_w,
	--ie_situacao_rediluente_w,
	--ie_rediluente_prescricao_w,
	--ie_situacao_reconstituinte_w,
	--ie_reconstituinte_prescricao_w,
	qt_max_dia_aplic_w,
	ie_material_padronizado_w,
	ie_intervalo_composto_valido_w,
	ie_material_exige_justif_w,
	ie_mat_necessita_receita_w,
	qt_dias_lib_prescr_w,
	qt_dia_terapeutico_w,
	qt_dia_profilatico_w,
	ie_medic_composto_w,
	ie_material_lado_w,
	ie_lado_w,
	ie_urgencia_w,
	ie_sem_aprazamento_w,
	ie_acm_w,
	ds_horarios_w,
	qt_solucao_w,
	ie_indicacao_w,
	ie_dose_espec_agora_w,
	nr_seq_kit_w,
	nr_sequencia_proc_w,
	dt_suspensao_w,
	qt_dias_lib_w,
	ds_observacao_w,
	qt_dia_prim_hor_w,
	qt_hora_aplicacao_w,
	qt_min_aplicacao_w,
	ie_consiste_dias_w,
	cd_kit_material_w ,
	qt_dose_especial_w,
	nr_dias_justif_w,
	ie_componente_diluido_w,
	ie_consiste_estoque_w,
	ie_consiste_dupl_w,
	cd_diluente_w,
	cd_rediluente_w,
	cd_reconst_w,
	nr_seq_solucao_w,
	ie_justifica_dias_util_w,
	ie_dias_util_medic_w,
	ie_consignado_w,
	ie_tipo_material_w,
	ie_sexo_material_w,
	ie_item_superior_w,
	ie_solucao_w,
	nr_seq_mat_w,
	ds_material_w,
	ie_permite_fracionado_w,
	qt_aplic_min_pad_w,
	qt_aplic_max_pad_w,
	cd_unidade_medida_consumo_w,
	ie_regra_volume_leite_w,
	nr_seq_leite_deriv_w,
	ie_obriga_tempo_aplic_w,
	ie_aplic_bolus_w,
	ie_aplic_lenta_w,
	nr_seq_lib_mat_pac_w,
	ie_em_protocolo_vanco_w,
	qt_dia_interv_profilaxia_w,
	qt_dias_tratamento_w,
	nr_seq_mat_cpoe_w,
	cd_protocolo_item_w,
	nr_sequencia_anterior_w,
	ie_bomba_infusao_w,
	cd_fornec_consignado_w;
EXIT WHEN NOT FOUND; /* apply on c00 */

	ie_situacao_diluente_w 				:= 	substr(obter_situacao_material(cd_diluente_w),1,1);
	ie_diluente_prescricao_w		 	:=	substr(obter_se_material_prescricao(cd_estabelecimento_p,cd_diluente_w),1,1);
	ie_situacao_rediluente_w			:=	substr(obter_situacao_material(cd_rediluente_w),1,1);
	ie_rediluente_prescricao_w			:=	substr(obter_se_material_prescricao(cd_estabelecimento_p,cd_rediluente_w),1,1);
	ie_situacao_reconstituinte_w		:=	substr(obter_situacao_material(cd_reconst_w),1,1);
	ie_reconstituinte_prescricao_w		:=	substr(obter_se_material_prescricao(cd_estabelecimento_p,cd_reconst_w),1,1);
	cd_unidade_medida_est_w	:= null;
	
	if (nr_seq_solucao_w > 0) then
		select	max(ie_via_aplicacao)
		into STRICT	ie_via_aplic_sol_w
		from	prescr_solucao
		where	nr_prescricao 	= nr_prescricao_p
		and		nr_seq_solucao	= nr_seq_solucao_w;
	end if;

	select	coalesce(max(ie_acm),'N'),
			coalesce(max(ie_se_necessario),'N'),
			coalesce(max(ie_situacao),'A'),
			max(ds_prim_horario)
	into STRICT	ie_acm_interv_w,
			ie_sn_interv_w,
			ie_situacao_interv_w,
			ds_prim_horario_w
	from	intervalo_prescricao
	where	cd_intervalo	= cd_intervalo_w;

	select	max(cd_grupo_material),
			max(cd_subgrupo_material),
			max(cd_classe_material),
			max(nr_seq_familia),
			max(cd_material_estoque),
			max(nr_seq_ficha_tecnica)
	into STRICT	cd_grupo_material_w,
			cd_subgrupo_w,
			cd_classe_material_w,
			nr_seq_familia_w,
			cd_material_estoque_w,
			nr_seq_ficha_tecnica_w
	from	estrutura_material_v
	where 	cd_material	= cd_material_w;

	select 	max(ie_situacao)
	into STRICT 	ie_situacao_via_w
	from	via_aplicacao
	where	ie_via_aplicacao = ie_via_aplicacao_w;

	ie_feriado_w := coalesce(obter_se_feriado(cd_estabelecimento_p, clock_timestamp()),0);

	open c01;
	loop
	fetch c01 into	ie_justificativa_antimicrob_w,
			ie_objetivo_antimicrob_w,
			ie_dia_utilizacao_antimicrob_w,
			ie_topografia_antimicrob_w,
			ie_amostra_antimicrob_w,
			ie_microorganismo_antimicrob_w,
			ie_origem_antimicrob_w,
			ie_avaliacao_antimicrob_w,
			ie_exige_cid_antimicrob_w,
			ie_indicacao_antimicrob_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		ie_justificativa_antimicrob_w		:= ie_justificativa_antimicrob_w;
		ie_objetivo_antimicrob_w		:= ie_objetivo_antimicrob_w;
		ie_dia_utilizacao_antimicrob_w	:= ie_dia_utilizacao_antimicrob_w;
		ie_topografia_antimicrob_w		:= ie_topografia_antimicrob_w;
		ie_amostra_antimicrob_w		:= ie_amostra_antimicrob_w;
		ie_microorganismo_antimicrob_w	:= ie_microorganismo_antimicrob_w;
		ie_origem_antimicrob_w		:= ie_origem_antimicrob_w;
		ie_avaliacao_antimicrob_w		:= ie_avaliacao_antimicrob_w;
		ie_exige_cid_antimicrob_w		:= ie_exige_cid_antimicrob_w;
		ie_indicacao_antimicrob_w		:= ie_indicacao_antimicrob_w;
		end;
	end loop;
	close c01;

	if (ie_agrupador_w not in (3,7,9)) and (coalesce(nr_seq_kit_w::text, '') = '') then
		SELECT * FROM consiste_util_medic(nr_prescricao_p, nr_atendimento_w, dt_prescricao_w, cd_material_w, nr_dia_util_matmed_w, qt_dias_liberado_w, ie_controle_medico_w, qt_total_dias_lib_w) INTO STRICT nr_dia_util_matmed_w, qt_dias_liberado_w, ie_controle_medico_w, qt_total_dias_lib_w;
	end if;
	
	if (obter_funcao_ativa = 2314 and qt_dias_liberado_w = 0) then
		qt_dias_liberado_w := null;
	end if;

	if (ie_consistir_glosa_convenio_w <> 'N') then
		SELECT * FROM obter_regra_ajuste_mat( cd_estab_prescr_w, cd_convenio_w, cd_categoria_w, cd_material_w, dt_prescricao_w, coalesce(cd_tipo_acomodacao_w,0), coalesce(ie_tipo_atendimento_w,0), coalesce(cd_setor_prescr_w,0), 0, null, null, null, null, null, null, tx_ajuste_w, vl_negociado_w, ie_preco_informado_w, ie_glosa_w, tx_brasindice_pfb_w, tx_brasindice_pmc_w, tx_pmc_neg_w, tx_pmc_pos_w, tx_afaturar_w, tx_simpro_pfb_w, tx_simpro_pmc_w, ie_origem_preco_w, ie_precedencia_w, pr_glosa_w, vl_glosa_w, cd_tabela_preco_w, cd_motivo_exc_conta_w, nr_seq_regra_w, ie_autor_particular_w, cd_convenio_glosa_w, cd_categoria_glosa_w, null, tx_pfb_neg_w, tx_pfb_pos_w, vl_neutro_w, tx_simpro_pos_pfb_w, tx_simpro_neg_pfb_w, tx_simpro_pos_pmc_w, tx_simpro_neg_pmc_w, null, null, 0, null, null, null, null, null) INTO STRICT tx_ajuste_w, vl_negociado_w, ie_preco_informado_w, ie_glosa_w, tx_brasindice_pfb_w, tx_brasindice_pmc_w, tx_pmc_neg_w, tx_pmc_pos_w, tx_afaturar_w, tx_simpro_pfb_w, tx_simpro_pmc_w, ie_origem_preco_w, ie_precedencia_w, pr_glosa_w, vl_glosa_w, cd_tabela_preco_w, cd_motivo_exc_conta_w, nr_seq_regra_w, ie_autor_particular_w, cd_convenio_glosa_w, cd_categoria_glosa_w, tx_pfb_neg_w, tx_pfb_pos_w, vl_neutro_w, tx_simpro_pos_pfb_w, tx_simpro_neg_pfb_w, tx_simpro_pos_pmc_w, tx_simpro_neg_pmc_w;

		open c06;
		loop
		fetch c06 into
			nm_usuario_aviso_w,
			cd_perfil_aviso_w;
		EXIT WHEN NOT FOUND; /* apply on c06 */
			begin

			if (nm_usuario_aviso_w IS NOT NULL AND nm_usuario_aviso_w::text <> '') then
				nm_usuario_aviso_ww := nm_usuario_aviso_ww ||', '||nm_usuario_aviso_w;
			end if;

			if (cd_perfil_aviso_w IS NOT NULL AND cd_perfil_aviso_w::text <> '') then
				cd_perfil_aviso_ww := cd_perfil_aviso_ww ||', '||cd_perfil_aviso_w;
			end if;
			if (cd_material_ww	<> cd_material_w) then
				ds_proced_glosa_p	:= substr(ds_proced_glosa_p || chr(13) || chr(10) ||ds_material_w ,1,255);
			end if;
			cd_material_ww	 := cd_material_w;
			end;
		end loop;
		close c06;
		cd_perfil_aviso_p	:= cd_perfil_aviso_ww;
		nm_usuario_aviso_p	:= nm_usuario_aviso_ww;

	end if;

	select coalesce(max('S'),'N')
	into STRICT	ie_mesma_vigencia_w
	from	prescr_medica a
	where	a.dt_validade_prescr = dt_validade_prescr_w
	and		coalesce(ie_dias_validade_w,'S') <> 'S'
	and		exists (SELECT 1
				   from  prescr_material b
				   where b.cd_material 	 = cd_material_w
				   and	 b.nr_prescricao = a.nr_prescricao
				   and	 coalesce(b.ie_suspenso,'N') <> 'S')
	and		a.nr_prescricao <> nr_prescricao_p
	and 	a.nr_atendimento = nr_atendimento_w;


	if (ie_justifica_dias_util_w <> 'S') then
		ie_consistir_antimicrobiano_w	:= obter_se_consistir_antimicrob(ie_agrupador_w, ie_ctrl_medico_antimicrob_w, nr_dia_util_w, ie_novo_ciclo_ccih_w, ie_controle_medico_w,ie_dias_util_medic_w);
	else
		ie_consistir_antimicrobiano_w := 'N';
	end if;
	ie_erro_liberar_prescr_w	:= '';
	
	select 	count(c.nr_sequencia)
	into STRICT	qt_riscos_medic_w
	from 	material a,
			medicamento_risco b, 
			prescr_material c 
	where 	a.cd_material = cd_material_w
	and 	a.cd_material = b.cd_material
	and 	a.cd_material = c.cd_material
	and 	c.nr_prescricao = nr_prescricao_p
	and		coalesce(b.ie_situacao, 'A') = 'A';
	
	if (coalesce(qt_riscos_medic_w, 0) > 0 and ie_agrupador_w = 1) then
	
		CALL gerar_erro_prescr_risco(nr_prescricao_p, cd_material_w);
	
	end if;


	ie_erro_liberar_prescr_w	:= '';
	if (coalesce(qt_dias_solicitado_w,0) = 0) and (coalesce(qt_dias_liberado_w,0) = 0) and (nr_dia_util_w	> qt_total_dias_lib_w) and (nr_dia_util_w > 1) and (ie_consistir_antimicrobiano_w = 'S') and (ie_agrupador_w <> 16) and (wheb_assist_pck.Obter_Se_Consiste_REP(249,cd_perfil_p) = 'S') then
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 249, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	if	((wheb_assist_pck.Obter_Se_Consiste_REP(1,cd_perfil_p) = 'S') or (wheb_assist_pck.Obter_Se_Consiste_REP(104,cd_perfil_p) = 'S')) then
		 qt_saldo_disponivel_estoque_w	:= obter_saldo_disp_estoque(cd_estab_prescr_w, cd_material_w, cd_local_prescr_w, clock_timestamp());
	elsif (wheb_assist_pck.Obter_Se_Consiste_REP(20,cd_perfil_p) = 'S') then
		  qt_saldo_disponivel_estoque_w := 0;
		  if (ie_material_disponivel_w = 'E') then
		  	  qt_saldo_disponivel_estoque_w	:= obter_saldo_disp_estoque(cd_estab_prescr_w, cd_material_w, 0, clock_timestamp());
		  end if;
	end if;
	
	ie_atualiza_estoque_w := obter_se_consiste_estoque_mat(cd_material_w, cd_setor_prescr_w, cd_estab_prescr_w, cd_convenio_w, ie_atualiza_estoque_w, cd_kit_material_w);
	
	if (ie_agrupador_w <> 16) and (wheb_assist_pck.Obter_Se_Consiste_REP(1,cd_perfil_p) = 'S') then
		
		if (ie_atualiza_estoque_w = 'S') then

			qt_estoque_minimo_w				:= obter_estoque_minimo_material(cd_estab_prescr_w, cd_material_w);

			if (qt_saldo_disponivel_estoque_w	<= qt_estoque_minimo_w)  then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(1, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 1, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
			end if;
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';
	
	if (ie_agrupador_w <> 16) and (coalesce(ie_consiste_estoque_w,'S') = 'S') and (wheb_assist_pck.obter_se_consiste_rep(2,cd_perfil_p) = 'S') then

		select	coalesce(max(ie_consiste_saldo_rep),'S')
		into STRICT	ie_consiste_estoque_w
		from	local_Estoque
		where	cd_local_estoque = cd_local_prescr_w;

		if (coalesce(cd_unidade_medida_est_w::text, '') = '') then
			cd_unidade_medida_est_w := substr(obter_dados_material_estab(cd_material_w,cd_estabelecimento_p,'UME'),1,30);
		end if;

		qt_dose_ww := obter_conversao_unid_med_cons(cd_material_w, cd_unidade_medida_est_w, qt_total_dispensar_w);

		if (coalesce(ie_consiste_estoque_w,'S') = 'S') then
		
			if (ie_consignado_w <> '1') then

				qt_saldo_disponivel_estoque_w := obter_saldo_estoque_consist(cd_estab_prescr_w, cd_material_w, cd_local_prescr_w, clock_timestamp());

				if (ie_consignado_w = '2') then
					begin
						qt_saldo_disponivel_estoque_w := obter_saldo_estoque_consig(cd_estabelecimento_p => cd_estab_prescr_w,
																					cd_cgc_fornec_p => cd_fornec_consignado_w,
																					cd_material_estoque_p => cd_material_w,
																					cd_local_estoque_p => cd_local_prescr_w) + qt_saldo_disponivel_estoque_w;
					exception when others then
						qt_saldo_disponivel_estoque_w := 0;
					end;
				end if;

				if (coalesce(qt_saldo_disponivel_estoque_w,0) < qt_dose_ww) then
					open C02;
					loop
					fetch C02 into
						cd_local_estoque_ww;
					EXIT WHEN NOT FOUND; /* apply on C02 */
						if (coalesce(qt_saldo_disponivel_estoque_w,0) < qt_dose_ww) then
							qt_saldo_disponivel_estoque_w := obter_saldo_estoque_consist(cd_estab_prescr_w, cd_material_w, cd_local_estoque_ww, clock_timestamp());

							if (ie_consignado_w = '2') then
								qt_saldo_disponivel_estoque_w := obter_saldo_estoque_consig(cd_estabelecimento_p => cd_estab_prescr_w,
																							cd_cgc_fornec_p => cd_fornec_consignado_w,
																							cd_material_estoque_p => cd_material_w,
																							cd_local_estoque_p => cd_local_estoque_ww) + qt_saldo_disponivel_estoque_w;
							end if;
						end if;
					end loop;
					close C02;
				end if;
			else
				begin
					qt_saldo_disponivel_estoque_w := obter_saldo_estoque_consig(cd_estabelecimento_p => cd_estab_prescr_w,
																				cd_cgc_fornec_p => cd_fornec_consignado_w,
																				cd_material_estoque_p => cd_material_w,
																				cd_local_estoque_p => cd_local_prescr_w);
				exception when others then
					qt_saldo_disponivel_estoque_w := 0;
				end;

				if (coalesce(qt_saldo_disponivel_estoque_w,0) < qt_dose_ww) then
					open C02;
					loop
					fetch C02 into
						cd_local_estoque_ww;
					EXIT WHEN NOT FOUND; /* apply on C02 */
						if (coalesce(qt_saldo_disponivel_estoque_w,0) < qt_dose_ww) then
							begin
								qt_saldo_disponivel_estoque_w := obter_saldo_estoque_consig(cd_estabelecimento_p => cd_estab_prescr_w,
																							cd_cgc_fornec_p => cd_fornec_consignado_w,
																							cd_material_estoque_p => cd_material_w,
																							cd_local_estoque_p => cd_local_estoque_ww);
							exception when others then
								qt_saldo_disponivel_estoque_w := 0;
							end;
						end if;
					end loop;
					close C02;
				end if;
			end if;

			if (qt_saldo_disponivel_estoque_w < qt_dose_ww) and (coalesce(ie_atualiza_estoque_w,'S')	= 'S') then
				ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(2, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 2, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
			end if;
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w in (1,8,12)) and (coalesce(dt_suspensao_w::text, '') = '') and (wheb_assist_pck.Obter_Se_Consiste_REP(3,cd_perfil_p) = 'S') then

		ie_horario_null_w	:= 'N';
		if	((coalesce(hr_prim_horario_w::text, '') = '') or (hr_prim_horario_w = '  :  ')) and (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then
			ie_horario_null_w	:= 'S';
			if (position(':' in ds_horarios_w) > 0) then
				hr_prim_horario_w	:= substr(ds_horarios_w,1,5);
			else
				hr_prim_horario_w	:= substr(ds_horarios_w,1,2) || ':00';
			end if;
		end if;

		if (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') and (hr_dose_especial_w IS NOT NULL AND hr_dose_especial_w::text <> '') and (hr_dose_especial_w <> '  :  ') then
			if (hr_prim_horario_w > hr_prescricao_w) and (qt_dia_prim_hor_w = 0) and
				((hr_dose_especial_w >= hr_prim_horario_w) or (hr_dose_especial_w < hr_prescricao_w)) then
				nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 3, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
			elsif (hr_prim_horario_w < hr_prescricao_w) and (qt_dia_prim_hor_w = 0) and (hr_dose_especial_w >= hr_prim_horario_w) and (hr_dose_especial_w < hr_prescricao_w) then
				nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 3, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
			end if;

		end if;

		if (ie_horario_null_w = 'S') then
			hr_prim_horario_w	:= '';
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and
		((coalesce(cd_intervalo_w::text, '') = '') or (ie_situacao_interv_w = 'I')) and
		((coalesce(nr_seq_kit_w::text, '') = '' and coalesce(cd_kit_material_w::text, '') = '') or (VarIeConsisteKit_w = 'S')) and (wheb_assist_pck.Obter_Se_Consiste_REP(4,cd_perfil_p) = 'S') then
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 4, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	if (ie_agrupador_w = 2) and
		((coalesce(cd_intervalo_w::text, '') = '') or (ie_situacao_interv_w = 'I')) and
		((coalesce(nr_seq_kit_w::text, '') = '' and coalesce(cd_kit_material_w::text, '') = '') or (VarIeConsisteKit_w = 'S')) and (wheb_assist_pck.Obter_Se_Consiste_REP(188,cd_perfil_p) = 'S') then
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 188, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	ie_erro_liberar_prescr_w	:= '';


	if (ie_agrupador_w in (1,8,12)) and (coalesce(qt_dose_w,0) = 0) and (coalesce(nr_seq_Kit_w::text, '') = '') and (coalesce(ds_dose_diferenciada_w::text, '') = '') and (wheb_assist_pck.Obter_Se_Consiste_REP(5,cd_perfil_p) = 'S') then
		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(5, cd_perfil_p);
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 5, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 4) and (coalesce(qt_dose_w,0) = 0) and (coalesce(ds_dose_diferenciada_w::text, '') = '') and (wheb_assist_pck.Obter_Se_Consiste_REP(223,cd_perfil_p) = 'S') then
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 223, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	if (ie_agrupador_w = 2) and (qt_dose_w = 0) and (coalesce(ds_dose_diferenciada_w::text, '') = '') and (wheb_assist_pck.Obter_Se_Consiste_REP(189,cd_perfil_p) = 'S') then
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 189, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	ie_erro_liberar_prescr_w	:= '';
	ds_compl_erro_w				:= '';

	if (ie_consistir_regra_uso_w <> 'N') and (ie_agrupador_w <> 16) and (wheb_assist_pck.Obter_Se_Consiste_REP(6,cd_perfil_p) = 'S') then
		nr_seq_atepacu_w	:= obter_atepacu_paciente(nr_atendimento_w,'A');

		ie_acao_excesso_w	:= obter_se_uso_qtde_mat_prescr(nr_atendimento_w, cd_material_w, (qt_unitaria_w * nr_ocorrencia_w), cd_setor_prescr_w, nr_seq_atepacu_w, '1', ds_justificativa_w, nr_prescricao_p, nr_seq_mat_w);
		ie_erro_regra_uso_w	:= obter_se_uso_qtde_mat_prescr(nr_atendimento_w, cd_material_w, (qt_unitaria_w * nr_ocorrencia_w), cd_setor_prescr_w, nr_seq_atepacu_w, '4', ds_justificativa_w, nr_prescricao_p, nr_seq_mat_w);

		if (ie_erro_regra_uso_w IS NOT NULL AND ie_erro_regra_uso_w::text <> '') then

			if (ie_consistir_regra_uso_w = 'CA') then
				ie_erro_liberar_prescr_w	:= 'S';
			else
				ie_erro_liberar_prescr_w	:= 'N';
			end if;

			if (ie_acao_excesso_w = 'J') and (ds_justificativa_w IS NOT NULL AND ds_justificativa_w::text <> '') then
			  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 6, ie_erro_liberar_prescr_w, ie_erro_regra_uso_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w, 'S');
      		else
			  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 6, ie_erro_liberar_prescr_w, ie_erro_regra_uso_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
			end if;
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_situacao_via_aplicacao_w = 'I') and (ie_agrupador_w <> 16) and (wheb_assist_pck.Obter_Se_Consiste_REP(7,cd_perfil_p) = 'S') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 7, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_consistir_antimicrobiano_w = 'S') and (ie_objetivo_antimicrob_w = 'S') and (coalesce(ie_objetivo_w::text, '') = '') and (ie_agrupador_w <> 16) and (wheb_assist_pck.Obter_Se_Consiste_REP(8,cd_perfil_p) = 'S') and
		(cd_funcao_origem_w <> 2314 AND ie_dose_espec_agora_w <> 'S') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 8, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (ie_justificar_SN_w = 'S') and (coalesce(nr_seq_kit_w::text, '') = '') and (ie_se_necessario_w = 'S') and (wheb_assist_pck.Obter_Se_Consiste_REP(9,cd_perfil_p) = 'S') then

		if (coalesce(ds_justificativa_w::text, '') = '') then
		  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 9, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		else
		  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 9, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w, 'S');
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_consistir_antimicrobiano_w = 'S') and (ie_mesma_vigencia_w <> 'S') and
		((ie_dia_utilizacao_antimicrob_w = 'S' AND qt_dias_solicitado_w < 1) or
		 ((ie_dia_utilizacao_antimicrob_w = 'P') and (ie_objetivo_w = 'F') and (qt_dias_solicitado_w < 1)) or
		 ((ie_dia_utilizacao_antimicrob_w = 'F') and (ie_objetivo_w = 'P') and (qt_dias_solicitado_w < 1)) or
		 ((ie_dia_utilizacao_antimicrob_w = 'C') and (ie_objetivo_w = 'C') and (qt_dias_solicitado_w < 1)) or
		 ((ie_dia_utilizacao_antimicrob_w = 'D') and (ie_objetivo_w = 'D') and (qt_dias_solicitado_w < 1)) or
		 ((ie_dia_utilizacao_antimicrob_w = 'E') and (ie_objetivo_w = 'E') and (qt_dias_solicitado_w < 1)) or
		 ((ie_dia_utilizacao_antimicrob_w = 'T') and (ie_objetivo_w = 'T') and (qt_dias_solicitado_w < 1))) and
		((((ie_dias_util_medic_w = 'S') and ((nr_dia_util_w = 1) or (nr_dia_util_w > qt_total_dias_lib_w))) or
		  (ie_dias_util_medic_w = 'O' AND nr_dia_util_w >= qt_total_dias_lib_w)) or (ie_novo_ciclo_ccih_w = 'S')) and
		(((ie_data_antimicrobiano_w = 'M')  and (coalesce(dt_liberacao_medico_w::text, '') = '')) or
		  ((ie_data_antimicrobiano_w = 'E')	and (coalesce(dt_liberacao_w::text, '') = ''))) and (wheb_assist_pck.Obter_Se_Consiste_REP( 10,cd_perfil_p) = 'S') and
		(cd_funcao_origem_w <> 2314 AND ie_dose_espec_agora_w <> 'S') then
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 10, 'N', ds_compl_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_consistir_antimicrobiano_w = 'S') and (coalesce(qt_dias_solicitado_w,0) > coalesce(qt_dias_lib_w,0)) and (coalesce(nr_dia_util_w,0)	> 1) and (wheb_assist_pck.Obter_Se_Consiste_REP(124,cd_perfil_p) = 'S') then
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 124, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_consistir_antimicrobiano_w = 'S') and
		(((ie_topografia_antimicrob_w = 'S') and (coalesce(cd_topografia_cih_w::text, '') = '')) or
		 ((ie_topografia_antimicrob_w = 'P') and (ie_objetivo_w = 'F') and (coalesce(cd_topografia_cih_w::text, '') = '')) or
		 ((ie_topografia_antimicrob_w = 'F') and (ie_objetivo_w = 'P') and (coalesce(cd_topografia_cih_w::text, '') = '')) or
		 ((ie_topografia_antimicrob_w = 'C') and (ie_objetivo_w = 'C') and (coalesce(cd_topografia_cih_w::text, '') = '')) or
		 ((ie_topografia_antimicrob_w = 'D') and (ie_objetivo_w = 'D') and (coalesce(cd_topografia_cih_w::text, '') = '')) or
		 ((ie_topografia_antimicrob_w = 'E') and (ie_objetivo_w = 'E') and (coalesce(cd_topografia_cih_w::text, '') = '')) or
		 ((ie_topografia_antimicrob_w = 'T') and (ie_objetivo_w = 'T') and (coalesce(cd_topografia_cih_w::text, '') = ''))) and (wheb_assist_pck.Obter_Se_Consiste_REP(11,cd_perfil_p) = 'S') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 11, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_consistir_antimicrobiano_w = 'S') and
		(((ie_amostra_antimicrob_w = 'S') and (coalesce(cd_amostra_cih_w::text, '') = '')) or
		 ((ie_amostra_antimicrob_w = 'P') and (ie_objetivo_w = 'F') and (coalesce(cd_amostra_cih_w::text, '') = '')) or
		 ((ie_amostra_antimicrob_w = 'F') and (ie_objetivo_w = 'P') and (coalesce(cd_amostra_cih_w::text, '') = '')) or
		 ((ie_amostra_antimicrob_w = 'C') and (ie_objetivo_w = 'C') and (coalesce(cd_amostra_cih_w::text, '') = '')) or
		 ((ie_amostra_antimicrob_w = 'D') and (ie_objetivo_w = 'D') and (coalesce(cd_amostra_cih_w::text, '') = '')) or
		 ((ie_amostra_antimicrob_w = 'E') and (ie_objetivo_w = 'E') and (coalesce(cd_amostra_cih_w::text, '') = '')) or
		 ((ie_amostra_antimicrob_w = 'T') and (ie_objetivo_w = 'T') and (coalesce(cd_amostra_cih_w::text, '') = ''))) and (wheb_assist_pck.Obter_Se_Consiste_REP(12,cd_perfil_p) = 'S') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 12, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_consistir_antimicrobiano_w = 'S') and
		(((ie_microorganismo_antimicrob_w = 'S') and (coalesce(cd_microorganismo_cih_w::text, '') = '')) or
		 ((ie_microorganismo_antimicrob_w = 'P') and (ie_objetivo_w = 'F') and (coalesce(cd_microorganismo_cih_w::text, '') = '')) or
		 ((ie_microorganismo_antimicrob_w = 'F') and (ie_objetivo_w = 'P') and (coalesce(cd_microorganismo_cih_w::text, '') = '')) or
		 ((ie_microorganismo_antimicrob_w = 'C') and (ie_objetivo_w = 'C') and (coalesce(cd_microorganismo_cih_w::text, '') = '')) or
		 ((ie_microorganismo_antimicrob_w = 'D') and (ie_objetivo_w = 'D') and (coalesce(cd_microorganismo_cih_w::text, '') = '')) or
		 ((ie_microorganismo_antimicrob_w = 'E') and (ie_objetivo_w = 'E') and (coalesce(cd_microorganismo_cih_w::text, '') = '')) or
		 ((ie_microorganismo_antimicrob_w = 'T') and (ie_objetivo_w = 'T') and (coalesce(cd_microorganismo_cih_w::text, '') = ''))) and (wheb_assist_pck.Obter_Se_Consiste_REP(13,cd_perfil_p) = 'S') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 13, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_consistir_antimicrobiano_w = 'S') and
		(((ie_origem_antimicrob_w = 'S') and (coalesce(ie_origem_infeccao_w::text, '') = '')) or
		 ((ie_origem_antimicrob_w = 'P') and (ie_objetivo_w = 'F') and (coalesce(ie_origem_infeccao_w::text, '') = '')) or
		 ((ie_origem_antimicrob_w = 'F') and (ie_objetivo_w = 'P') and (coalesce(ie_origem_infeccao_w::text, '') = '')) or
		 ((ie_origem_antimicrob_w = 'C') and (ie_objetivo_w = 'C') and (coalesce(ie_origem_infeccao_w::text, '') = '')) or
		 ((ie_origem_antimicrob_w = 'D') and (ie_objetivo_w = 'D') and (coalesce(ie_origem_infeccao_w::text, '') = '')) or
		 ((ie_origem_antimicrob_w = 'E') and (ie_objetivo_w = 'E') and (coalesce(ie_origem_infeccao_w::text, '') = '')) or
		 ((ie_origem_antimicrob_w = 'T') and (ie_objetivo_w = 'T') and (coalesce(ie_origem_infeccao_w::text, '') = ''))) and (wheb_assist_pck.Obter_Se_Consiste_REP(14,cd_perfil_p) = 'S') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 14, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_consistir_antimicrobiano_w = 'S') and
		(((ie_avaliacao_antimicrob_w = 'S') and (coalesce(nr_seq_avaliacao_w::text, '') = '')) or
		 ((ie_avaliacao_antimicrob_w = 'P') and (ie_objetivo_w = 'F') and (coalesce(nr_seq_avaliacao_w::text, '') = '')) or
		 ((ie_avaliacao_antimicrob_w = 'F') and (ie_objetivo_w = 'P') and (coalesce(nr_seq_avaliacao_w::text, '') = '')) or
		 ((ie_avaliacao_antimicrob_w = 'D') and (ie_objetivo_w = 'D') and (coalesce(nr_seq_avaliacao_w::text, '') = '')) or
		 ((ie_avaliacao_antimicrob_w = 'C') and (ie_objetivo_w = 'C') and (coalesce(nr_seq_avaliacao_w::text, '') = '')) or
		 ((ie_avaliacao_antimicrob_w = 'E') and (ie_objetivo_w = 'E') and (coalesce(nr_seq_avaliacao_w::text, '') = '')) or
		 ((ie_avaliacao_antimicrob_w = 'T') and (ie_objetivo_w = 'T') and (coalesce(nr_seq_avaliacao_w::text, '') = ''))) and (wheb_assist_pck.Obter_Se_Consiste_REP(15,cd_perfil_p) = 'S') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 15, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_consistir_antimicrobiano_w = 'S') and
		((ie_justificativa_antimicrob_w = 'S') or
		 (ie_justificativa_antimicrob_w = 'P' AND ie_objetivo_w = 'F') or
		 (ie_justificativa_antimicrob_w = 'F' AND ie_objetivo_w = 'P') or
		 (ie_justificativa_antimicrob_w = 'C' AND ie_objetivo_w = 'C') or
		 (ie_justificativa_antimicrob_w = 'D' AND ie_objetivo_w = 'D') or
		 (ie_justificativa_antimicrob_w = 'E' AND ie_objetivo_w = 'E') or
		 (ie_justificativa_antimicrob_w = 'T' AND ie_objetivo_w = 'T')) and
		(((ie_data_antimicrobiano_w = 'M') and (coalesce(dt_liberacao_medico_w::text, '') = '')) or
		  ((ie_data_antimicrobiano_w = 'E')	and (coalesce(dt_liberacao_w::text, '') = ''))) and (wheb_assist_pck.Obter_Se_Consiste_REP(16,cd_perfil_p) = 'S') then

		if (coalesce(ds_justificativa_w::text, '') = '') then
		  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 16, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		else
		  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 16, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w, 'S');
		end if;
	end if;

	if (ie_consistir_antimicrobiano_w = 'S') and (ie_ctrl_medico_antimicrob_w = 4) and (qt_dias_solicitado_w IS NOT NULL AND qt_dias_solicitado_w::text <> '') then

		if (ie_objetivo_w in ('T', 'D', 'E')) then
			select CASE WHEN qt_dia_terapeutico_w=0 THEN  qt_dias_solicitado_w  ELSE qt_dia_terapeutico_w END
			into STRICT qt_dias_lib_prescr_w
			;
		else
			select CASE WHEN qt_dia_profilatico_w=0 THEN  qt_dias_solicitado_w  ELSE qt_dia_profilatico_w END
			into STRICT qt_dias_lib_prescr_w
			;
		end if;

		if (qt_dias_lib_prescr_w > qt_dias_solicitado_w) then
			qt_dias_lib_prescr_w	:= qt_dias_solicitado_w;
		end if;

		update	prescr_material
		set	qt_dias_liberado	= qt_dias_lib_prescr_w
		where	nr_prescricao		= nr_prescricao_p
		and	nr_sequencia		= nr_seq_mat_w;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_consistir_antimicrobiano_w = 'S') and
		((ie_exige_cid_antimicrob_w = 'S' AND ie_cid_informado_w = 'N') or
		 ((ie_exige_cid_antimicrob_w = 'P') and (ie_objetivo_w = 'F') and (ie_cid_informado_w = 'N')) or
		 ((ie_exige_cid_antimicrob_w = 'F') and (ie_objetivo_w = 'P') and (ie_cid_informado_w = 'N')) or
		 ((ie_exige_cid_antimicrob_w = 'C') and (ie_objetivo_w = 'C') and (ie_cid_informado_w = 'N')) or
		 ((ie_exige_cid_antimicrob_w = 'D') and (ie_objetivo_w = 'D') and (ie_cid_informado_w = 'N')) or
		 ((ie_exige_cid_antimicrob_w = 'E') and (ie_objetivo_w = 'E') and (ie_cid_informado_w = 'N')) or
		 ((ie_exige_cid_antimicrob_w = 'T') and (ie_objetivo_w = 'T') and (ie_cid_informado_w = 'N'))) and (wheb_assist_pck.Obter_Se_Consiste_REP(17,cd_perfil_p) = 'S') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 17, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;


	ie_erro_liberar_prescr_w	:= '';
	if (ie_consistir_antimicrobiano_w = 'S') and
		(((ie_indicacao_antimicrob_w = 'S') and (coalesce(ie_indicacao_w::text, '') = '')) or
		 ((ie_indicacao_antimicrob_w = 'P') and (ie_objetivo_w = 'F') and (coalesce(ie_indicacao_w::text, '') = '')) or
		 ((ie_indicacao_antimicrob_w = 'F') and (ie_objetivo_w = 'P') and (coalesce(ie_indicacao_w::text, '') = '')) or
		 ((ie_indicacao_antimicrob_w = 'C') and (ie_objetivo_w = 'C') and (coalesce(ie_indicacao_w::text, '') = '')) or
		 ((ie_indicacao_antimicrob_w = 'D') and (ie_objetivo_w = 'D') and (coalesce(ie_indicacao_w::text, '') = '')) or
		 ((ie_indicacao_antimicrob_w = 'E') and (ie_objetivo_w = 'E') and (coalesce(ie_indicacao_w::text, '') = '')) or
		 ((ie_indicacao_antimicrob_w = 'T') and (ie_objetivo_w = 'T') and (coalesce(ie_indicacao_w::text, '') = ''))) and (wheb_assist_pck.Obter_Se_Consiste_REP(157,cd_perfil_p) = 'S') then
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 157, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;


	ie_erro_liberar_prescr_w	:= '';


	if (ie_unid_med_compativel_w = 'N') and (ie_agrupador_w <> 16) and (wheb_assist_pck.Obter_Se_Consiste_REP(18,cd_perfil_p) = 'S') then

		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(18, cd_perfil_p);

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 18, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w <> 16) and (wheb_assist_pck.Obter_Se_Consiste_REP(19,cd_perfil_p) = 'S') then

		SELECT * FROM verifica_paciente_alergico(cd_pessoa_prescr_w, cd_material_w, ds_item_w, ie_paciente_alergico_w) INTO STRICT ds_item_w, ie_paciente_alergico_w;

		if (ie_paciente_alergico_w = 'S') then

			if (nr_seq_mat_cpoe_w > 0) and (ds_justificativa_w IS NOT NULL AND ds_justificativa_w::text <> '') then
				ie_erro_liberar_prescr_w	:= 'S';
			else
				ie_erro_liberar_prescr_w	:= (obter_lib_erro_regra_rep(19, cd_perfil_p));
			end if;

			if (ie_permite_com_justificativa_w = 'S') and (coalesce(nr_seq_mat_cpoe_w, 0) = 0) THEN
				if (coalesce(ds_justificativa_w::text, '') = '') then
				  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 19, ie_erro_liberar_prescr_w, wheb_mensagem_pck.get_texto(278883), cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
				else
				  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 19, ie_erro_liberar_prescr_w, wheb_mensagem_pck.get_texto(278883), cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w, 'S');
				end if;
			else
				nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 19, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
			end if;
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_material_disponivel_w <> 'S') and (coalesce(ie_medicacao_paciente_w,'N') <> 'S') and (wheb_assist_pck.Obter_Se_Consiste_REP(20,cd_perfil_p) = 'S') then

		if (qt_saldo_disponivel_estoque_w <= 0) then
			begin
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(20, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 20, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
			end;
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if	((wheb_assist_pck.Obter_Se_Consiste_REP(21,cd_perfil_p) = 'S') or (wheb_assist_pck.Obter_Se_Consiste_REP(22,cd_perfil_p) = 'S')) and (ie_agrupador_w in (1,4)) then
		ie_material_diluicao_w	:= coalesce(Obter_Padrao_Param_Prescr(nr_atendimento_w,cd_material_w,ie_via_aplicacao_w, cd_setor_prescr_w, cd_pessoa_prescr_w,null,null,'N','L', null),ie_material_diluicao_w);
	end if;

	if (ie_agrupador_w = 1) and (ie_material_diluido_w = 'N') and (wheb_assist_pck.Obter_Se_Consiste_REP(21,cd_perfil_p) = 'S') then

		if (ie_material_diluicao_w = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(21, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 21, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if	(ie_agrupador_w = 4 AND VarGeraDilSolucao_w = 'S')and (ie_material_diluicao_w = 'S') and (ie_componente_diluido_w = 'N') and (VarConsisteDilSolucao_w = 'S') and (wheb_assist_pck.Obter_Se_Consiste_REP(21,cd_perfil_p) = 'S') then

		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(21, cd_perfil_p);

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 21, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w in (1,4)) and (ie_material_diluido_w = 'S') and (wheb_assist_pck.Obter_Se_Consiste_REP(22,cd_perfil_p) = 'S') then

		if (ie_material_diluicao_w = 'R') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(22, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 22, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if	--(ie_agrupador_w = 1) and
		(ie_situacao_material_w = 'I') and (wheb_assist_pck.Obter_Se_Consiste_REP(23,cd_perfil_p) = 'S') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 23, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w in (1,5,8,12)) and (ie_material_prescricao_w = 'N') and (wheb_assist_pck.Obter_Se_Consiste_REP(24,cd_perfil_p) = 'S') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 24, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (ie_situacao_diluente_w = 'I') and (wheb_assist_pck.Obter_Se_Consiste_REP(25,cd_perfil_p) = 'S') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 25, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (ie_diluente_prescricao_w = 'N') and (wheb_assist_pck.Obter_Se_Consiste_REP(26,cd_perfil_p) = 'S') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 26, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (ie_situacao_rediluente_w = 'I') and (wheb_assist_pck.Obter_Se_Consiste_REP(27,cd_perfil_p) = 'S') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 27, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (ie_rediluente_prescricao_w = 'N') and (wheb_assist_pck.Obter_Se_Consiste_REP(28,cd_perfil_p) = 'S') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 28, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (ie_situacao_reconstituinte_w = 'I') and (wheb_assist_pck.Obter_Se_Consiste_REP(29,cd_perfil_p) = 'S') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 29, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (ie_reconstituinte_prescricao_w = 'N') and (wheb_assist_pck.Obter_Se_Consiste_REP(30,cd_perfil_p) = 'S') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 30, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w in (1,4,8,12))then
		SELECT * FROM verifica_dose_maxima(nr_prescricao_p, nr_seq_mat_w, ie_gera_horarios_w, ie_erro_dose_usual_w, ie_erro_dose_maxima_w, null, ie_tipo_erro_consis_w, qt_dose_limite_w, cd_unidade_medida_limte_w) INTO STRICT ie_erro_dose_usual_w, ie_erro_dose_maxima_w, ie_tipo_erro_consis_w, qt_dose_limite_w, cd_unidade_medida_limte_w;
	end if;

	if (ie_agrupador_w in (1,4,8,12)) then
		if (ie_erro_dose_maxima_w IS NOT NULL AND ie_erro_dose_maxima_w::text <> '') and (wheb_assist_pck.Obter_Se_Consiste_REP(31,cd_perfil_p) = 'S') then

			ie_supera_limite_uso_w		:= 'S';

			if (nr_seq_mat_cpoe_w > 0) and (ds_justificativa_w IS NOT NULL AND ds_justificativa_w::text <> '') then
				
				ie_erro_liberar_prescr_w	:= 'S';
			elsif (ie_tipo_erro_consis_w = 'A') and (ds_justificativa_w IS NOT NULL AND ds_justificativa_w::text <> '') then
				
				ie_erro_liberar_prescr_w	:= 'S';
			elsif ((ie_tipo_erro_consis_w in ('A','J')) and (coalesce(ds_justificativa_w::text, '') = '')) then
				
				ie_erro_dose_maxima_w := ie_erro_dose_maxima_w || ' ' || wheb_mensagem_pck.get_texto(802291);
        if (cd_funcao_origem_w <> 2314) then
  				ie_erro_liberar_prescr_w := (obter_lib_erro_regra_rep(31, cd_perfil_p));
        end if;
			else

				if (coalesce(qt_caract_just_dose_lim_w,0) > 0) and (coalesce(length(ds_justificativa_w),0) > 0) and (coalesce(length(trim(both ds_justificativa_w)),0) >= coalesce(qt_caract_just_dose_lim_w,0)) then
					ie_erro_liberar_prescr_w	:= 'S';
				else
					
					if (coalesce(qt_caract_just_dose_lim_w,0) > 0) then
						ie_erro_dose_maxima_w := substr(ie_erro_dose_maxima_w || ' ' || wheb_mensagem_pck.get_texto(802297, 'QT_CARACTERES=' || qt_caract_just_dose_lim_w || ';DS_PARAMETRO=1183 - ' || wheb_mensagem_pck.get_texto(802304)),1,2000);
					end if;
	        if (cd_funcao_origem_w <> 2314) then
  					ie_erro_liberar_prescr_w	:= (obter_lib_erro_regra_rep(31, cd_perfil_p));
          end if;
				end if;
			end if;
			
			CALL inserir_jutificativa_mat_dose(nr_atendimento_w, nr_prescricao_p, nr_seq_mat_w, cd_material_w, qt_dose_w, cd_unid_med_dose_w, qt_dose_limite_w, cd_unidade_medida_limte_w, ds_justificativa_w, nm_usuario_p);

			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 31, ie_erro_liberar_prescr_w, ie_erro_dose_maxima_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (wheb_assist_pck.Obter_Se_Consiste_REP(32,cd_perfil_p) = 'S') then

		if (ie_erro_dose_usual_w IS NOT NULL AND ie_erro_dose_usual_w::text <> '') then
			ie_supera_limite_uso_w		:= 'S';
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(32, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 32, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (wheb_assist_pck.Obter_Se_Consiste_REP(33,cd_perfil_p) = 'S') then

		ie_erro_maximo_dias_w := verifica_maximo_dias(nr_prescricao_p, nr_seq_mat_w, ie_erro_maximo_dias_w);

		if (ie_erro_maximo_dias_w IS NOT NULL AND ie_erro_maximo_dias_w::text <> '') then

			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(33, cd_perfil_p);

			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 33, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (wheb_assist_pck.Obter_Se_Consiste_REP(34,cd_perfil_p) = 'S') then

		qt_ocorrencias_hor_w	:= coalesce(obter_ocorrencia_intervalo(cd_intervalo_w, 25, 'H'),0);

		ie_erro_interv_horas_w := verifica_intervalo_horas(nr_prescricao_p, nr_seq_mat_w, cd_setor_prescr_w, cd_material_w, ie_via_aplicacao_w, qt_ocorrencias_hor_w, ie_erro_interv_horas_w, ie_agrupador_w);

		if (ie_erro_interv_horas_w IS NOT NULL AND ie_erro_interv_horas_w::text <> '') then

			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(34, cd_perfil_p);

			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 34, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (ie_prescr_emergencia_w = 'S') and (hr_primeiro_horario_w <> hr_prim_horario_w) and (wheb_assist_pck.Obter_Se_Consiste_REP(35,cd_perfil_p) = 'S') then

		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(35, cd_perfil_p);

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 35, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (ie_prescr_emergencia_w = 'S') and (coalesce(nr_ocorrencia_w,1) > 1) and (wheb_assist_pck.Obter_Se_Consiste_REP(36,cd_perfil_p) = 'S') then

		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(36, cd_perfil_p);

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 36, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (cd_material_w > 0) and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
		begin

		select	coalesce(obter_dados_medic_atb_num(max(cd_material),wheb_usuario_pck.get_cd_estabelecimento,max(qt_max_dia_aplic),'DA',ie_tipo_atendimento_w,cd_setor_prescr_w,ie_clinica_w),0)
		into STRICT	qt_max_dia_aplic_ww
		from	rep_regra_dias_util
		where	cd_material = cd_material_w
		and	cd_pessoa_fisica = cd_pessoa_fisica_w;

		end;
	end if;

	if (qt_max_dia_aplic_ww > 0 ) and (nr_dia_util_w > qt_max_dia_aplic_ww) and (wheb_assist_pck.Obter_Se_Consiste_REP(37,cd_perfil_p) = 'S') then
		begin
		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(37, cd_perfil_p);

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 37, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end;
	elsif (coalesce(qt_max_dia_aplic_ww,0) = 0) and (nr_dia_util_w > qt_max_dia_aplic_w) and (wheb_assist_pck.Obter_Se_Consiste_REP(37,cd_perfil_p) = 'S') then
		begin
		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(37, cd_perfil_p);

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 37, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_material_padronizado_w = 'N') and (ie_prescr_nao_padronizado_w in ('J','JSS')) and (ie_medicacao_paciente_w <> 'S') and (ie_Agrupador_w not in (16,17,13)) and (wheb_assist_pck.Obter_Se_Consiste_REP(38,cd_perfil_p) = 'S') and (coalesce(Obter_se_medic_lib_pac2(cd_pessoa_prescr_w, cd_material_w, dt_prescricao_w, cd_estabelecimento_p, nm_usuario_p),'N') = 'N') THEN
		if (coalesce(ds_justificativa_w::text, '') = '') then
		  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 38, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		else
		  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 38, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w, 'S');
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (ie_intervalo_composto_valido_w = 'N') and (wheb_assist_pck.Obter_Se_Consiste_REP(39,cd_perfil_p) = 'S') then

		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(39, cd_perfil_p);

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 39, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;



	ie_erro_liberar_prescr_w	:= '';

	if (ie_consistir_glosa_convenio_w <> 'N') and (nr_atendimento_w > 0) and
		((wheb_assist_pck.Obter_Se_Consiste_REP(41,cd_perfil_p) = 'S') 	or (wheb_assist_pck.Obter_Se_Consiste_REP(42,cd_perfil_p) = 'S') 	or (wheb_assist_pck.Obter_Se_Consiste_REP(47,cd_perfil_p) = 'S') 	or (wheb_assist_pck.Obter_Se_Consiste_REP(48,cd_perfil_p) = 'S')	or (wheb_assist_pck.Obter_Se_Consiste_REP(257,cd_perfil_p) = 'S') or (wheb_assist_pck.Obter_Se_Consiste_REP(263,cd_perfil_p) = 'S') or (wheb_assist_pck.Obter_Se_Consiste_REP(40,cd_perfil_p) = 'S')) then

		SELECT * FROM consiste_mat_plano_convenio(coalesce(cd_convenio_w,0), coalesce(cd_plano_convenio_w,'0'), cd_material_w, nr_atendimento_w, cd_setor_prescr_w, ie_erro_autorizacao_w, ie_bloqueia_agenda_w, ie_regra_plano_w, nr_seq_regra_plano_w, qt_material_w, clock_timestamp(), null, cd_estabelecimento_p, null, null) INTO STRICT ie_erro_autorizacao_w, ie_bloqueia_agenda_w, ie_regra_plano_w, nr_seq_regra_plano_w;

			if (wheb_assist_pck.Obter_Se_Consiste_REP(263,cd_perfil_p) = 'S') then

				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(263, cd_perfil_p);
				if (ie_erro_liberar_prescr_w = 'C') then
					if (ie_consistir_glosa_convenio_w = 'CAI') then
					ie_erro_liberar_prescr_w	:= 'N';
					else
						ie_erro_liberar_prescr_w	:= 'S';
					end if;
				end if;

				select	count(*)
				into STRICT	qt_negada_w
				from	autorizacao_convenio a,
					material_autorizado b,
					estagio_autorizacao c
				where	a.nr_sequencia = b.nr_sequencia_autor
				and	a.cd_convenio =  cd_convenio_w
				and	c.nr_sequencia = a.nr_seq_estagio
				and	clock_timestamp() between coalesce(a.dt_inicio_vigencia,clock_timestamp()) and coalesce(a.dt_fim_vigencia,clock_timestamp() + interval '1000 days')
				and	c.ie_interno   = '90'
				and	a.nr_atendimento = nr_atendimento_w
				and	b.cd_material    = cd_material_w  LIMIT 1;

				if (coalesce(qt_negada_w,0) > 0) then
					if ((ie_obriga_just_w = 'N') or (coalesce(ds_justificativa_w::text, '') = '')) then
					  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 263, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
					else
					  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 263, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w, 'S');
					end if;
				end if;
			end if;


			if (ie_regra_plano_w = 10) and (wheb_assist_pck.Obter_Se_Consiste_REP(257,cd_perfil_p) = 'S') then

				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(257, cd_perfil_p);
				if (ie_erro_liberar_prescr_w = 'C') then
					if (ie_consistir_glosa_convenio_w = 'CAI') then
					ie_erro_liberar_prescr_w	:= 'N';
					else
						ie_erro_liberar_prescr_w	:= 'S';
					end if;
				end if;

				select	sum(b.qt_autorizada)
				into STRICT	qt_autorizada_w
				from	autorizacao_convenio a,
					material_autorizado b,
					estagio_autorizacao c
				where	a.nr_sequencia = b.nr_sequencia_autor
				and	a.cd_convenio =  cd_convenio_w
				and	c.nr_sequencia = a.nr_seq_estagio
				and	clock_timestamp() between coalesce(a.dt_inicio_vigencia,clock_timestamp()) and coalesce(a.dt_fim_vigencia,clock_timestamp() + interval '1000 days')
				and	c.ie_interno   = '10'
				and	a.nr_atendimento = nr_atendimento_w
				and	b.cd_material    = cd_material_w;

				if (qt_autorizada_w > 0) then

					select	sum(qt_material)
					into STRICT	qt_item_prescrito_w
					from	prescr_medica a,
						prescr_material b
					where	a.nr_prescricao = b.nr_prescricao
					and	a.nr_atendimento = nr_atendimento_w
					and	b.cd_material = cd_material_w;

					if (qt_item_prescrito_w > qt_autorizada_w) THEN
						if ((ie_obriga_just_w = 'N') or (coalesce(ds_justificativa_w::text, '') = '')) then
						  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 257, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
						else
						  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 257, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w, 'S');
						end if;
					end if;

				end if;
			end if;

		if (ie_regra_plano_w = 6) and (wheb_assist_pck.Obter_Se_Consiste_REP(41,cd_perfil_p) = 'S') then

			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(41, cd_perfil_p);
			if (ie_erro_liberar_prescr_w = 'C') then
				if (ie_consistir_glosa_convenio_w = 'CAI') then
					ie_erro_liberar_prescr_w	:= 'N';
				else
					ie_erro_liberar_prescr_w	:= 'S';
				end if;
			end if;

			IF ((ie_obriga_just_w = 'N') or (coalesce(ds_justificativa_w::text, '') = '')) then
			  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 41, ie_erro_liberar_prescr_w, ds_mensagem_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
			ELSE
			  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 41, ie_erro_liberar_prescr_w, ds_mensagem_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w, 'S');
			END IF;
		end if;


		if (ie_regra_plano_w = 7) and (wheb_assist_pck.Obter_Se_Consiste_REP(41,cd_perfil_p) = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(41, cd_perfil_p);

			if (ie_erro_liberar_prescr_w = 'C') then
				if (ie_consistir_glosa_convenio_w = 'CAI') then
					ie_erro_liberar_prescr_w	:= 'N';
				else
					ie_erro_liberar_prescr_w	:= 'S';
				end if;
			end if;

			if ((ie_obriga_just_w = 'N') or (coalesce(ds_justificativa_w::text, '') = '')) then
			  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 41, ie_erro_liberar_prescr_w, wheb_mensagem_pck.get_texto(278884), cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
			else
			  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 41, ie_erro_liberar_prescr_w, wheb_mensagem_pck.get_texto(278884), cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w, 'S');
			end if;

		end if;


		if	((ie_consistir_glosa_convenio_w <> 'N') or (ie_regra_plano_w = 7)) and (wheb_assist_pck.Obter_Se_Consiste_REP(40,cd_perfil_p) = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(40, cd_perfil_p);


			if (ie_consistir_glosa_convenio_w = 'CAI') then
				ie_erro_liberar_prescr_w	:= 'N';
			else
				ie_erro_liberar_prescr_w	:= 'S';
			end if;

			if	((ie_glosa_w in ('T','G')) or (ie_regra_plano_w = 7)) and (ie_medicacao_paciente_w <> 'S') then
				nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 40, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
			end if;

		end if;

		if	((ie_erro_autorizacao_w IS NOT NULL AND ie_erro_autorizacao_w::text <> '') or (ie_regra_plano_w = 7))	then
			if (ie_regra_plano_w in (1,2,7)) and (wheb_assist_pck.Obter_Se_Consiste_REP(42,cd_perfil_p) = 'S') then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(42, cd_perfil_p);

				if (ie_erro_liberar_prescr_w = 'C') then
					if (ie_consistir_glosa_convenio_w = 'CAI') then
						ie_erro_liberar_prescr_w	:= 'N';
					else
						ie_erro_liberar_prescr_w	:= 'S';
					end if;
				end if;
				nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 42, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

			elsif (ie_regra_plano_w = 3) and (coalesce(nr_seq_kit_w::text, '') = '') and (ie_agrupador_w	<> 5) and (wheb_assist_pck.Obter_Se_Consiste_REP(47,cd_perfil_p) = 'S') and
					((coalesce(qt_dias_solicitado_w,0) = 0) or (ie_consistir_antimicrobiano_w = 'S')) then

				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(47, cd_perfil_p);
				if (ie_erro_liberar_prescr_w = 'C') then
					if (ie_consistir_glosa_convenio_w = 'CAI') then
						ie_erro_liberar_prescr_w	:= 'N';
					else
						ie_erro_liberar_prescr_w	:= 'S';
					end if;
				end if;

				if ((ieAutConvComJust_w <> 'S') or (coalesce(ds_justificativa_w::text, '') = '')) then
				  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 47, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
				else
				  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 47, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w, 'S');
				end if;
			elsif (ie_regra_plano_w = 5) and (wheb_assist_pck.Obter_Se_Consiste_REP(48,cd_perfil_p) = 'S') then

				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(48, cd_perfil_p);
				if (ie_erro_liberar_prescr_w = 'C') then
					if (ie_consistir_glosa_convenio_w = 'CAI') then
						ie_erro_liberar_prescr_w	:= 'N';
					else
						ie_erro_liberar_prescr_w	:= 'S';
					end if;
				end if;

				nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 48, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
			end if;

		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (wheb_assist_pck.Obter_Se_Consiste_REP(43,cd_perfil_p) = 'S') and (coalesce(nr_sequencia_proc_w::text, '') = '') then
		ie_erro_intervalo_w := consistir_interv_solic_mat_med(nr_prescricao_p, nr_seq_mat_w, ie_erro_intervalo_w);
		if (ie_erro_intervalo_w IS NOT NULL AND ie_erro_intervalo_w::text <> '') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(43, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 43, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if	((ie_material_exige_justif_w = 'S') or (obter_se_obriga_justificativa(cd_material_w,coalesce(qt_peso_w,0), cd_setor_prescr_w, cd_convenio_w,ie_bomba_infusao_w, nr_atendimento_w) = 'S')) and (coalesce(cd_kit_material_w::text, '') = '') and (wheb_assist_pck.Obter_Se_Consiste_REP(44,cd_perfil_p) = 'S') then

		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(44, cd_perfil_p);

		if (coalesce(ds_justificativa_w::text, '') = '') THEN
		  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 44, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		else
		  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 44, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w, 'S');
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_consistir_setor_material_w <> 'S') and (wheb_assist_pck.Obter_Se_Consiste_REP(45,cd_perfil_p) = 'S') then

		ie_setor_regra_w := consiste_setor_exclusivo_item(cd_estab_prescr_w, nr_prescricao_p, cd_material_w, ie_setor_regra_w);

		if (ie_setor_regra_w = 'N') and (ie_consistir_setor_material_w = 'CA') then
			ie_erro_liberar_prescr_w	:= 'S';
		elsif (ie_setor_regra_w = 'N') and (ie_consistir_setor_material_w = 'CAI') then
			ie_erro_liberar_prescr_w	:= 'N';
		end if;

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 45, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_receita_cadastro_w = 'S') and (ie_agrupador_w		= 1) and (ie_mat_necessita_receita_w = 'S') and (coalesce(nr_receita_w::text, '') = '') and (wheb_assist_pck.Obter_Se_Consiste_REP(46,cd_perfil_p) = 'S') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 46, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (ie_prescr_composto_w = 'N') and (ie_medic_composto_w = 'S') and (wheb_assist_pck.Obter_Se_Consiste_REP(49,cd_perfil_p) = 'S') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 49, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (ie_material_lado_w = 'S') and (coalesce(ie_lado_w::text, '') = '') and (wheb_assist_pck.Obter_Se_Consiste_REP(50,cd_perfil_p) = 'S') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 50, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (ie_material_lado_w = 'O') and (ie_lado_w IS NOT NULL AND ie_lado_w::text <> '') and (wheb_assist_pck.Obter_Se_Consiste_REP(51,cd_perfil_p) = 'S') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 51, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (ie_exigir_via_aplicacao_w = 'S') and (coalesce(nr_seq_kit_w::text, '') = '') and (coalesce(ie_via_aplicacao_w::text, '') = '') and (wheb_assist_pck.Obter_Se_Consiste_REP(52,cd_perfil_p) = 'S') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 52, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (ie_exigir_via_aplicacao_w = 'S') and (coalesce(nr_seq_kit_w::text, '') = '') and (ie_situacao_via_w = 'I') and (wheb_assist_pck.Obter_Se_Consiste_REP(215,cd_perfil_p) = 'S') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 215, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w not in (1,4,2,5,13,16,17)) and (ie_exigir_via_aplic_dieta_w = 'S') and (coalesce(nr_seq_kit_w::text, '') = '') and (coalesce(ie_via_aplicacao_w::text, '') = '') and (wheb_assist_pck.Obter_Se_Consiste_REP(52,cd_perfil_p) = 'S') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 52, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w in (1,2,4,5)) and (wheb_assist_pck.Obter_Se_Consiste_REP(53,cd_perfil_p) = 'S') and (coalesce(dt_liberacao_medico_w::text, '') = '') then

		ie_erro_prescritor_w := consistir_prescr_nao_medico(nr_prescricao_p, nr_seq_mat_w, ie_erro_prescritor_w, nm_usuario_p);

		if (ie_erro_prescritor_w IS NOT NULL AND ie_erro_prescritor_w::text <> '') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(53, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 53, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and
	--	(ie_urgencia_w <> 'S') and
		(hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') and (coalesce(trim(both ds_horarios_w)::text, '') = '') and (ie_sem_aprazamento_w <> 'S') and (coalesce(nr_seq_kit_w::text, '') = '') and (wheb_assist_pck.Obter_Se_Consiste_REP(54,cd_perfil_p) = 'S') then

		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(54, cd_perfil_p);

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 54, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (wheb_assist_pck.Obter_Se_Consiste_REP(87,cd_perfil_p) = 'S') then
		begin

		qt_volume_diluicao_w	:= Obter_Volume_Medic(nr_prescricao_p, nr_seq_mat_w);

		if (coalesce(qt_volume_diluicao_w,0) <> 0) and (coalesce(qt_solucao_w,0) <> 0) and (qt_volume_diluicao_w < qt_solucao_w) then

			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(87, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 87, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

		end if;
		end;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (ie_se_necessario_w = 'N') and (ie_sn_interv_w = 'S') and (wheb_assist_pck.Obter_Se_Consiste_REP(192,cd_perfil_p) = 'S') then

		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(192, cd_perfil_p);
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 192, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (ie_acm_w = 'N') and (ie_acm_interv_w = 'S') and (wheb_assist_pck.Obter_Se_Consiste_REP(191,cd_perfil_p) = 'S') then

		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(191, cd_perfil_p);
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 191, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	ie_erro_liberar_prescr_w	:= '';

	begin
	if (length(trim(both hr_prim_horario_w)) = 5) then
		dt_prim_horario_w	:= PKG_DATE_UTILS.get_Time(dt_inicio_prescr_w, hr_prim_horario_w, 0);
	else
		dt_prim_horario_w	:= dt_inicio_prescr_w;
	end if;
	exception when others then
		dt_prim_horario_w	:= dt_inicio_prescr_w;
	end;

	if (dt_prim_horario_w	< dt_inicio_prescr_w) then
		dt_prim_horario_w	:= dt_prim_horario_w + 1;
	end if;

	if (ie_agrupador_w = 1) and (coalesce(ie_urgencia_w,'N') <> 'S') and (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') and (nr_horas_validade_w	< 24) and
		((dt_prim_horario_w	< dt_inicio_prescr_w) or (dt_prim_horario_w	> dt_validade_prescr_w)) and (wheb_assist_pck.Obter_Se_Consiste_REP(55,cd_perfil_p) = 'S') then
		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(55, cd_perfil_p);
		ds_erro_w	:= wheb_mensagem_pck.get_texto(278885, 'DT_INICIO_PRESCR_P=' || PKG_DATE_FORMATERS.TO_VARCHAR(dt_inicio_prescr_w, 'timestamp', cd_estabelecimento_p, nm_usuario_p) ||
									';DT_VALIDADE_PRESCR_P='|| PKG_DATE_FORMATERS.TO_VARCHAR(dt_validade_prescr_w, 'timestamp', cd_estabelecimento_p, nm_usuario_p));
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 55, ie_erro_liberar_prescr_w, ds_erro_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (ie_justificar_acm_w = 'S') and (ie_acm_w = 'S') and (wheb_assist_pck.Obter_Se_Consiste_REP(56,cd_perfil_p) = 'S') then

		if (coalesce(ds_justificativa_w::text, '') = '') then
		  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 56, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		else
		  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 56, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w, 'S');
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 12) and (ie_justificar_acm_sn_SO_w = 'S') and
		((ie_acm_w = 'S') or (ie_se_necessario_w = 'S')) and (wheb_assist_pck.Obter_Se_Consiste_REP(57,cd_perfil_p) = 'S') then

		if (coalesce(ds_justificativa_w::text, '') = '') then
		  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 57, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		else
		  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 57, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w, 'S');
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (ie_justificar_agora_w = 'S') and (ie_urgencia_w = 'S') and (wheb_assist_pck.Obter_Se_Consiste_REP(194,cd_perfil_p) = 'S') THEN
		if (coalesce(ds_justificativa_w::text, '') = '') then
		  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 194, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		else
		  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 194, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w, 'S');
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_controle_medico_w = '8') and (wheb_assist_pck.Obter_Se_Consiste_REP(58,cd_perfil_p) = 'S') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 58, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;
	
	ie_erro_liberar_prescr_w	:= '';
	
	if (coalesce(nr_seq_kit_w::text, '') = '') and (ie_agrupador_w <> 16) and (ie_agrupador_w <> 5) and (ie_agrupador_w <> 2) and (ie_agrupador_w <> 4) and (obter_funcao_ativa = 2314) and (wheb_assist_pck.Obter_Se_Consiste_REP(300,cd_perfil_p) = 'S') then
		if (ie_liberar_w = 'N') then
			ie_erro_liberar_prescr_w := 'N';
		end if;

		ds_consist_mat_w := verifica_medic_dupl_dia_assoc(cd_material_w, nr_atendimento_w, cd_pessoa_fisica_w, nm_usuario_p, ds_consist_mat_w);

		if (ds_consist_mat_w IS NOT NULL AND ds_consist_mat_w::text <> '') then
			if (ie_liberar_w = 'N') then
				ie_erro_liberar_prescr_w := 'N';
			else
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(300, cd_perfil_p);
			end if;
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 300, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_em_protocolo_vanco_w <> 'S') and
		((obter_funcao_ativa <> 2314) or (pkg_i18n.get_user_locale() = 'en_AU')) and
		((wheb_assist_pck.Obter_Se_Consiste_REP(59,cd_perfil_p) = 'S') or (wheb_assist_pck.Obter_Se_Consiste_REP(234,cd_perfil_p) = 'S')) then

		ds_consist_mat_w := verifica_medic_dupl_dia(cd_material_w, nr_prescricao_p, nm_usuario_p, ds_consist_mat_w);

		ie_liberar_w := 'S';
		
		open C07;
		loop
		fetch C07 into	
			ie_liberar_w;
		EXIT WHEN NOT FOUND; /* apply on C07 */
			begin
				ie_liberar_w := ie_liberar_w;
			end;
		end loop;
		close C07;
	end if;

	if (coalesce(nr_seq_kit_w::text, '') = '') and (ie_agrupador_w <> 16) and (ie_agrupador_w <> 5) and (ie_agrupador_w <> 2) and (ie_agrupador_w <> 4) and (obter_funcao_ativa <> 2314 or (pkg_i18n.get_user_locale() = 'en_AU')) and (wheb_assist_pck.Obter_Se_Consiste_REP(59,cd_perfil_p) = 'S') then
		if (ie_liberar_w = 'N') then
			ie_erro_liberar_prescr_w := 'N';
		end if;

		if (ds_consist_mat_w IS NOT NULL AND ds_consist_mat_w::text <> '') then
			if (ie_liberar_w = 'N') then
				ie_erro_liberar_prescr_w := 'N';
			else
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(59, cd_perfil_p);
			end if;
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 59, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;

	end if;

	if (coalesce(nr_seq_kit_w::text, '') = '') and (ie_consiste_dupl_w = 'S') and (ie_agrupador_w = 2) and (obter_funcao_ativa <> 2314) and (wheb_assist_pck.Obter_Se_Consiste_REP(234,cd_perfil_p) = 'S') then

		if (ie_liberar_w = 'N') then
			ie_erro_liberar_prescr_w := 'N';
		end if;

		if (ds_consist_mat_w IS NOT NULL AND ds_consist_mat_w::text <> '') then
			if (ie_liberar_w = 'N') then
				ie_erro_liberar_prescr_w := 'N';
			else
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(234, cd_perfil_p);
			end if;
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 234, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';
	if (wheb_assist_pck.Obter_Se_Consiste_REP(187,cd_perfil_p) = 'S') and (ie_controle_medico_w	<> '0') then

		ds_consist_mat_w := verifica_medic_dupl_dia(cd_material_w, nr_prescricao_p, nm_usuario_p, ds_consist_mat_w);

		if (ds_consist_mat_w IS NOT NULL AND ds_consist_mat_w::text <> '') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(187, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 187, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';
	nr_seq_estrutura_w		:= campo_numerico(nr_seq_estrutura_w);
	if (nr_seq_estrutura_w > 0) and (wheb_assist_pck.Obter_Se_Consiste_REP(81,cd_perfil_p) = 'S') then

		ie_pertence_estrutura_w	:= consistir_se_mat_estrutura(nr_seq_estrutura_w,cd_material_w);

		if (ie_pertence_estrutura_w = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(81, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 81, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (wheb_assist_pck.Obter_Se_Consiste_REP(82,cd_perfil_p) = 'S') then
		ie_albubina_justi_w := obter_se_albubina_just(nr_prescricao_p, nr_seq_mat_w);

		if (ie_albubina_justi_w = 'N') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(82, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 82, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (wheb_assist_pck.Obter_Se_Consiste_REP(83,cd_perfil_p) = 'S') then

		if (ie_tipo_material_w not in (0,2,3,6,9,10)) then
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 83, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 2) and (wheb_assist_pck.Obter_Se_Consiste_REP(274,cd_perfil_p) = 'S') then

		if (ie_tipo_material_w not in (1,10,7)) then
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 274, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;

	end if;


	if (ie_agrupador_w = 1) and (wheb_assist_pck.Obter_Se_Consiste_REP(273,cd_perfil_p) = 'S') then

		ie_indicacao_solic_w	    := 'N';
		ie_erro_liberar_prescr_w	:= ' ';

		select coalesce(max('S'),'N')
		into STRICT	ie_indicacao_solic_w
		from	prescr_material
		where	nr_sequencia	= nr_seq_material_p
		and		nr_prescricao   = nr_prescricao_p
		and		coalesce(Obter_Se_Solic_Mat(cd_material),'N') = 'S'  LIMIT 1;

		if (ie_indicacao_solic_w = 'S') then
			select  coalesce(max('S'),'N')
			into STRICT	ie_indicacao_solic_w
			FROM prescr_medica_solic a
LEFT OUTER JOIN prescr_medica_indic_solic b ON (a.nr_sequencia = b.nr_seq_solic)
WHERE a.nr_seq_material   = nr_seq_material_p and a.nr_prescricao 	= nr_prescricao_p and coalesce(Obter_Se_Solic_Mat(cd_material_w),'N') = 'S' and (b.nr_seq_indicacao IS NOT NULL AND b.nr_seq_indicacao::text <> '')   LIMIT 1;

			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(273, cd_perfil_p);

			if (ie_indicacao_solic_w = 'N') then
				nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 273, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
			end if;
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';
	if (wheb_assist_pck.Obter_Se_Consiste_REP(90,cd_perfil_p) = 'S') then
		select	max(ds_mensagem)
		into STRICT	ds_mensagem_w
		from	orientacao_prescritor
		where	cd_material	= cd_material_w;

		if (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(90, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 90, ie_erro_liberar_prescr_w, ds_mensagem_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w in (1,8,12)) and (wheb_assist_pck.Obter_Se_Consiste_REP(92,cd_perfil_p) = 'S') then

		ie_prim_hor_w := 'N';
		if (coalesce(ie_acm_w,'N') = 'N') and
	--		(coalesce(ie_urgencia_w,'N') = 'N') and
			(coalesce(ie_se_necessario_w,'N') = 'N') and
			((coalesce(hr_prim_horario_w::text, '') = '') or (hr_prim_horario_w = '  :  ')) and
			((cd_funcao_origem_w = 2314 and ((coalesce(hr_dose_especial_w::text, '') = '') or (hr_dose_especial_w = '  :  '))) or cd_funcao_origem_w <> 2314) and (coalesce(nr_seq_kit_w::text, '') = '') then
			ie_prim_hor_w := 'S';
		end if;

		if (ie_prim_hor_w = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(92, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 92, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	if (ie_agrupador_w in (1,8,12)) and (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') and (obter_se_limpa_prim_hor(cd_intervalo_w, cd_setor_prescr_w) <> 'S') and (coalesce(ie_prescr_emergencia_w,'N') <> 'S') and (wheb_assist_pck.Obter_Se_Consiste_REP(197,cd_perfil_p) = 'S') then

		ie_prim_hor_w := 'N';
		if (coalesce(ie_se_necessario_w,'N') = 'N') and (coalesce(ie_urgencia_w,'N') = 'N') and (coalesce(ie_acm_w,'N') = 'N') and
			((coalesce(hr_prim_horario_w::text, '') = '') or (hr_prim_horario_w = '  :  ')) and
			((cd_funcao_origem_w = 2314 and ((coalesce(hr_dose_especial_w::text, '') = '') or (hr_dose_especial_w = '  :  '))) or cd_funcao_origem_w <> 2314) and (coalesce(nr_seq_kit_w::text, '') = '') then
			ie_prim_hor_w := 'S';
		end if;

		if (ie_prim_hor_w = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(197, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 197, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (wheb_assist_pck.Obter_Se_Consiste_REP(84,cd_perfil_p) = 'S') then
		ie_medico_habilitado_w	:= consistir_medic_prescritor(cd_material_w, cd_prescritor_w, cd_estabelecimento_p);

		if (ie_medico_habilitado_w	= 'N') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(84, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 84, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (wheb_assist_pck.Obter_Se_Consiste_REP(88,cd_perfil_p) = 'S') then
		ie_concentracao_medic_w	:= obter_concent_medic_prescr(nr_prescricao_p, nr_seq_mat_w,'M');

		if (ie_concentracao_medic_w  <> 'N') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(88, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 88, ie_erro_liberar_prescr_w, ie_concentracao_medic_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (wheb_assist_pck.Obter_Se_Consiste_REP(98,cd_perfil_p) = 'S') then
		if (ie_indicacao_w	= 'N') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(98, cd_perfil_p);
			if (coalesce(ds_justificativa_w::text, '') = '') then
			  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 98, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
			else
			  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 98, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w, 'S');
			end if;
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (wheb_assist_pck.Obter_Se_Consiste_REP(99,cd_perfil_p) = 'S') then

		if (ie_objetivo_w	in ('C', 'P')) and (qt_dias_solicitado_w > 1) then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(99, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 99, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (wheb_assist_pck.Obter_Se_Consiste_REP(100,cd_perfil_p) = 'S') then

		if (ie_objetivo_w	= 'T') and (coalesce(ie_indicacao_w, 'X') not in ('S', 'C')) then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(100, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 100, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (wheb_assist_pck.Obter_Se_Consiste_REP(101,cd_perfil_p) = 'S') then

		select	max(ie_sexo)
		into STRICT	ie_sexo_paciente_w
		from	pessoa_fisica
		where	cd_pessoa_fisica	= cd_pessoa_prescr_w;

		if	(ie_sexo_material_w	<> 'A' AND ie_sexo_material_w	<> ie_sexo_paciente_w) then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(101, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 101, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (wheb_assist_pck.Obter_Se_Consiste_REP(103,cd_perfil_p) = 'S') then


		ie_obr_justificativa_w := coalesce(Obter_Padrao_Param_Prescr(nr_atendimento_w,cd_material_w,ie_via_aplicacao_w, cd_setor_prescr_w, cd_pessoa_prescr_w,null,qt_peso_prescr_w,ie_se_necessario_w,'EJ', null),'N');

		if (ie_obr_justificativa_w = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(103, cd_perfil_p);
			if (coalesce(ds_justificativa_w::text, '') = '') then
			  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 103, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
			else
			  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 103, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w, 'S');
			end if;
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (wheb_assist_pck.Obter_Se_Consiste_REP(104,cd_perfil_p) = 'S') then

		select	coalesce(max(qt_dose),0),
			max(cd_material_substituir)
		into STRICT	qt_dose_ww,
			cd_material_substituir_w
		from	prescr_estoque_redu
		where	cd_material		= cd_material_w
		and	cd_local_estoque	= cd_local_prescr_w;

		if (cd_material_substituir_w IS NOT NULL AND cd_material_substituir_w::text <> '') then
			ds_erro_w	:= wheb_mensagem_pck.get_texto(278886, 'CD_MATERIAL_SUBSTITUIR_P=' || substr(obter_desc_material(cd_material_substituir_w),1,150));
		end if;

		if (coalesce(qt_dose_ww,0) > 0) and (qt_saldo_disponivel_estoque_w < qt_dose_ww) then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(104, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 104, ie_erro_liberar_prescr_w, ds_erro_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (coalesce(ie_urgencia_w,'N')		= 'S') and (coalesce(ie_dose_espec_agora_w,'N') = 'S') and (wheb_assist_pck.Obter_Se_Consiste_REP(105,cd_perfil_p) = 'S') then

		if (hr_dose_especial_w = hr_prim_horario_w) then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(105, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 105, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (wheb_assist_pck.Obter_Se_Consiste_REP(106,cd_perfil_p) = 'S') and (coalesce(nr_seq_kit_w,0) = 0) and (ie_agrupador_w	in (1,2)) and (coalesce(ie_urgencia_w,'N')		= 'N') and (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then

		begin
		ds_horarios_inconsistentes_w	:= Obter_Se_horario_validade(nr_prescricao_p, nr_seq_mat_w);
		exception when others then
			ds_horarios_inconsistentes_w := null;
		end;

		if	((ds_horarios_inconsistentes_w IS NOT NULL AND ds_horarios_inconsistentes_w::text <> '') or (ds_horarios_inconsistentes_w <> '')) then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(106, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 106, ie_erro_liberar_prescr_w, wheb_mensagem_pck.get_texto(278887, 'DS_HORARIOS_INCONSISTENTES_P=' || substr(ds_horarios_inconsistentes_w,3,2000)), cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;

	end if;

	if (coalesce(nr_seq_kit_w,0) = 0) and (ie_agrupador_w	<> 5) and (coalesce(ie_urgencia_w,'N')		= 'N') and (coalesce(hr_prim_horario_w::text, '') = '') and (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') and (wheb_assist_pck.Obter_Se_Consiste_REP(106,cd_perfil_p) = 'S') then

		begin
		ds_horarios_inconsistentes_w := Obter_Se_horario_validade(nr_prescricao_p, nr_seq_mat_w);
		exception when others then
			ds_horarios_inconsistentes_w := null;
		end;

		if (ds_horarios_inconsistentes_w IS NOT NULL AND ds_horarios_inconsistentes_w::text <> '') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(106, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 106, ie_erro_liberar_prescr_w, wheb_mensagem_pck.get_texto(278887, 'DS_HORARIOS_INCONSISTENTES_P=' || substr(ds_horarios_inconsistentes_w,3,2000)), cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;

	end if;

	if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') and (coalesce(nr_seq_kit_w,0) = 0) and (ie_agrupador_w	<> 5) and (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') and (nr_ocorrencia_w > 0) and (ie_agrupador_w in (1,2,4)) and (wheb_assist_pck.Obter_Se_Consiste_REP(108,cd_perfil_p) = 'S') then

		qt_ocorrencias_hor_w	:= coalesce(obter_ocorrencias_horarios_rep(ds_horarios_w),0);

		if (qt_ocorrencias_hor_w > nr_ocorrencia_w) then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(108, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 108, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_controle_medico_w	<> '0') and (coalesce(qt_peso_prescr_w::text, '') = '') and (wheb_assist_pck.Obter_Se_Consiste_REP(109,cd_perfil_p) = 'S') then
		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(109, cd_perfil_p);
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 109, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (wheb_assist_pck.Obter_Se_Consiste_REP(110,cd_perfil_p) = 'S') then
		begin
		select	count(1)
		into STRICT	qt_suspenso_w
		from	prescr_material		a,
			prescr_medica		b
		where	b.nr_prescricao		<> nr_prescricao_p
		and	a.cd_material		= cd_material_w
		and	b.cd_pessoa_fisica	= cd_pessoa_prescr_w
		and	b.dt_prescricao between PKG_DATE_UTILS.start_of(dt_prescricao_w, 'dd', 0) and fim_dia(dt_prescricao_w)
		and	a.nr_prescricao		= b.nr_prescricao
		and	a.ie_suspenso		= 'S'
		and	coalesce(a.ie_modificado,'N') <> 'S'  LIMIT 1;

		if (qt_suspenso_w > 0) then
			begin
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(110, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 110, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
			end;
		end if;
		end;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_material_padronizado_w = 'N') and (ie_medicacao_paciente_w <> 'S') and (nr_sequencia_anterior_w IS NOT NULL AND nr_sequencia_anterior_w::text <> '') and (wheb_assist_pck.Obter_Se_Consiste_REP(111,cd_perfil_p) = 'S') and (coalesce(Obter_se_medic_lib_pac2(cd_pessoa_prescr_w, cd_material_w, dt_prescricao_w, cd_estabelecimento_p, nm_usuario_p),'N') = 'N') then
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 111, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (coalesce(nr_seq_kit_w::text, '') = '') and (ie_agrupador_w = 1) and (ie_em_protocolo_vanco_w <> 'S') and (obter_funcao_ativa <> 2314) and (wheb_assist_pck.Obter_Se_Consiste_REP(113,cd_perfil_p) = 'S') then
		ds_consist_mat_w := verifica_dupl_dia_PA(cd_material_w, nr_prescricao_p, nr_seq_mat_w, nm_usuario_p, ds_consist_mat_w);
		if (ds_consist_mat_w IS NOT NULL AND ds_consist_mat_w::text <> '') then
			ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(113, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 113, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (coalesce(nr_seq_kit_w::text, '') = '') and (ie_agrupador_w = 1) and (ie_em_protocolo_vanco_w <> 'S') and (wheb_assist_pck.Obter_Se_Consiste_REP(276,cd_perfil_p) = 'S') then
		ds_consist_mat_w := verifica_dupl_dia_PA2(cd_material_w, nr_prescricao_p, nr_seq_mat_w, nm_usuario_p, ds_consist_mat_w);
		if (ds_consist_mat_w IS NOT NULL AND ds_consist_mat_w::text <> '') then
			ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(276, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 276, ie_erro_liberar_prescr_w, ds_consist_mat_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';
	if (ie_em_protocolo_vanco_w <> 'S') and (ie_agrupador_w = 1) and
		((obter_funcao_ativa <> 2314) or (pkg_i18n.get_user_locale() = 'en_AU')) and (wheb_assist_pck.Obter_Se_Consiste_REP(114,cd_perfil_p) = 'S') then
		ds_consist_mat_w := verifica_dupl_dia_classe(cd_material_w, nr_prescricao_p, nm_usuario_p, ds_consist_mat_w);
		if (ds_consist_mat_w IS NOT NULL AND ds_consist_mat_w::text <> '') then
			ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(114, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 114, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';
	if (ie_agrupador_w = 1) and (wheb_assist_pck.Obter_Se_Consiste_REP(119,cd_perfil_p) = 'S') then

		select	count(1)
		into STRICT	qt_agrupamento_w
		from	prescr_material a
                where  	nr_prescricao  		= nr_prescricao_p
                and    	nr_agrupamento 		= nr_agrupamento_w
                and	ie_item_superior	= 'S'
		and	ie_agrupador		= 1  LIMIT 2;

		if	(qt_agrupamento_w > 1 AND ie_item_superior_w = 'S') then
			ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(119, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 119, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';
	if (ie_agrupador_w	<> 4) and (wheb_assist_pck.Obter_Se_Consiste_REP(120,cd_perfil_p) = 'S') then

		if (ie_solucao_w = 'C') then
			ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(120, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 120, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';
	if (coalesce(ie_se_necessario_w,'N')	= 'S') and (wheb_assist_pck.Obter_Se_Consiste_REP(121,cd_perfil_p) = 'S') then

                ie_permite_sn_w := Obter_Se_consiste_SN(cd_material_w, ie_permite_sn_w, nm_usuario_p);
		if (coalesce(ie_permite_sn_w,'S') = 'N') then
			ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(121, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 121, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';
	if (wheb_assist_pck.Obter_Se_Consiste_REP(126,cd_perfil_p) = 'S') then

		select	count(1)
		into STRICT	cont_w
		from	prescr_mat_hor_copia
		where	nr_prescricao	= nr_prescricao_p
		and	nr_seq_material	= nr_seq_mat_w  LIMIT 1;

                if (cont_w > 0) then
			ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(126, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 126, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';
	if	((ds_horarios_w	<> 'SN' AND ie_se_necessario_w = 'S') or
		(ds_horarios_w	<> 'ACM' AND ie_acm_w = 'S') or
		((coalesce(ie_se_necessario_w, 'N') = 'N') and (coalesce(ie_acm_w,'N') = 'N'))) and (ie_agrupador_w		in (1,2,8)) and (wheb_assist_pck.Obter_Se_Consiste_REP(127,cd_perfil_p) = 'S') then

		ds_hor_aux_w	:= replace(replace(ds_horarios_w,' ',''),':','');
		x	:= 1;
		while(x	< length(ds_horarios_w)) loop
			if (substr(ds_hor_aux_w,x,1) not in ('0','1','2','3','4','5','6','7','8','9')) then
				ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(127, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 127, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
				exit;
			end if;
			x	:= x + 1;
		end loop;
	end if;

	ie_erro_liberar_prescr_w	:= '';
	if	(
		((ie_acm_w		= 'S') and (VarConsisteObsACMSN_w in ('S', 'A')))or
		 ((ie_se_necessario_w	= 'S') and (VarConsisteObsACMSN_w in ('S', 'E')))
		) and (ie_agrupador_w		= 1) and (wheb_assist_pck.Obter_Se_Consiste_REP(128,cd_perfil_p) = 'S') then

		if (coalesce(ds_observacao_w::text, '') = '') then
			ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(128, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 128, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';
	if (ie_agrupador_w		= 1) and (wheb_assist_pck.Obter_Se_Consiste_REP(129,cd_perfil_p) = 'S') and (Obter_se_horario_item(ds_horarios_w, cd_material_w) = 'N') then
		ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(129, cd_perfil_p);
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 129, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	ie_erro_liberar_prescr_w	:= '';
	if (ie_consignado_w	= '0') and (wheb_assist_pck.Obter_Se_Consiste_REP(130,cd_perfil_p) = 'S') then

		select	max(a.cd_fornecedor)
		into STRICT	cd_cgc_fornecedor_w
		from	fornecedor_mat_consignado a,
				Material m
		where	a.cd_material           	= m.cd_material_estoque
		and		a.dt_mesano_referencia  	> clock_timestamp() - interval '60 days'
		and		m.cd_material           	= cd_material_w
		and		a.cd_local_estoque		= cd_local_prescr_w
		and		a.cd_estabelecimento		= cd_estab_prescr_w;

		Select 	max(f.qt_estoque)
		into STRICT	qt_saldo_disponivel_estoque_w
		from 	fornecedor_mat_consignado f
		where 	f.cd_fornecedor			= cd_cgc_fornecedor_w
		and 	f.cd_estabelecimento		= cd_estab_prescr_w
		and 	f.cd_material			= cd_material_w
		and		f.cd_local_estoque		= coalesce(cd_local_prescr_w, f.cd_local_estoque)
		and 	f.dt_mesano_referencia		= clock_timestamp();

		if (coalesce(cd_unidade_medida_est_w::text, '') = '') then
			cd_unidade_medida_est_w	:= substr(obter_dados_material_estab(cd_material_w,cd_estabelecimento_p,'UME'),1,30);
		end if;

		qt_dose_ww := obter_conversao_unid_med_cons(cd_material_w, cd_unidade_medida_est_w, qt_total_dispensar_w);
		if (qt_saldo_disponivel_estoque_w < qt_dose_ww) and (coalesce(ie_atualiza_estoque_w,'S')	= 'S') then
			ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(130, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 130, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (coalesce(nr_seq_kit_w,0) = 0) and (ie_agrupador_w = 12) and (coalesce(ie_urgencia_w,'N')		= 'N') and (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') and (wheb_assist_pck.Obter_Se_Consiste_REP(131,cd_perfil_p) = 'S') then

		begin
		ds_horarios_inconsistentes_w	:= Obter_Se_horario_validade(nr_prescricao_p, nr_seq_mat_w);
		exception when others then
			ds_horarios_inconsistentes_w := null;
		end;

		if (ds_horarios_inconsistentes_w IS NOT NULL AND ds_horarios_inconsistentes_w::text <> '') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(131, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 131, ie_erro_liberar_prescr_w, wheb_mensagem_pck.get_texto(278887, 'DS_HORARIOS_INCONSISTENTES_P=' || substr(ds_horarios_inconsistentes_w,3,2000)), cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;

	end if;

	if (wheb_assist_pck.Obter_Se_Consiste_REP(132,cd_perfil_p) = 'S') then
		begin
		if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then
			ie_loop_w := 0;
			ds_dose_diferenciada_ww	:= ds_dose_diferenciada_w;

			while(ds_dose_diferenciada_ww IS NOT NULL AND ds_dose_diferenciada_ww::text <> '') and (ie_loop_w < 101) LOOP
				begin
				select position('-' in ds_dose_diferenciada_ww)
				into STRICT 	h
				;

				if (h > 0) then
					ds_dose_diferenciada_ww	:= substr(ds_dose_diferenciada_ww, h+1, 50);
				else
					ds_dose_diferenciada_ww	:= null;
				end if;
				ie_loop_w	:=  ie_loop_w + 1;
				end;
			end loop;
			if (nr_ocorrencia_w <> ie_loop_w)  then
				begin
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(132, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 132, ie_erro_liberar_prescr_w, '', cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
				end;
			end if;
		end if;

		end;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (ie_urgencia_w <> 'S') and (ie_acm_w <> 'S') and (ie_se_necessario_w <> 'S') and (coalesce(ds_horarios_w::text, '') = '') and (dt_liberacao_medico_w IS NOT NULL AND dt_liberacao_medico_w::text <> '') and (wheb_assist_pck.Obter_Se_Consiste_REP(133,cd_perfil_p) = 'S') then
		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(133, cd_perfil_p);
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 133, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (coalesce(qt_dias_solicitado_w,0) > 0) and (wheb_assist_pck.Obter_Se_Consiste_REP(134,cd_perfil_p) = 'S') then

		SELECT * FROM Verifica_Maximo_Dias_prev(nr_prescricao_p, nr_seq_mat_w, ie_erro_maximo_dias_w, ie_permite_lib_just_w) INTO STRICT ie_erro_maximo_dias_w, ie_permite_lib_just_w;
		if (ie_erro_maximo_dias_w IS NOT NULL AND ie_erro_maximo_dias_w::text <> '') then
			ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(134, cd_perfil_p);

			if (ie_erro_liberar_prescr_w <> 'X') and (ie_permite_lib_just_w IS NOT NULL AND ie_permite_lib_just_w::text <> '') then
				ie_erro_liberar_prescr_w := ie_permite_lib_just_w;
			end if;
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 134, ie_erro_liberar_prescr_w, ie_erro_maximo_dias_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if	--(ie_consistir_antimicrobiano_w = 'S') and
		(ie_ctrl_medico_antimicrob_w = '4') and
		((qt_dia_profilatico_w > nr_dia_util_w AND ie_dias_util_medic_w <> 'O') or (qt_dia_profilatico_w = nr_dia_util_w AND ie_dias_util_medic_w = 'O')) and (nr_dia_util_w > 0) and (ie_objetivo_w	in ('F','C')) and (wheb_assist_pck.Obter_Se_Consiste_REP(138,cd_perfil_p) = 'S') then
		ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(138, cd_perfil_p);
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 138, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_consistir_antimicrobiano_w = 'S') and (ie_controle_medico_w = '4') and (qt_dia_terapeutico_w < qt_dias_solicitado_w) and (ie_objetivo_w = 'T') and (wheb_assist_pck.Obter_Se_Consiste_REP(139,cd_perfil_p) = 'S') then
		ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(139, cd_perfil_p);
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 139, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (wheb_assist_pck.Obter_Se_Consiste_REP(140,cd_perfil_p) = 'S') then
		ds_erro_prescr_w	:= Obter_regra_validade_prescr(nr_prescricao_anterior_w, nr_prescricao_p);
		if (ds_erro_prescr_w IS NOT NULL AND ds_erro_prescr_w::text <> '') then
			ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(140, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 140, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (coalesce(nr_seq_kit_w,0) = 0) and (ie_agrupador_w	= 8) and (coalesce(ie_urgencia_w,'N')		= 'N') and (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') and (wheb_assist_pck.Obter_Se_Consiste_REP(141,cd_perfil_p) = 'S') then
		ds_horarios_inconsistentes_w	:= '';
		begin
		ds_horarios_inconsistentes_w	:= Obter_Se_horario_validade(nr_prescricao_p, nr_seq_mat_w);
		exception when others then
			ds_horarios_inconsistentes_w := null;
		end;

		if	((ds_horarios_inconsistentes_w IS NOT NULL AND ds_horarios_inconsistentes_w::text <> '') or (ds_horarios_inconsistentes_w <> '')) then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(141, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 141, ie_erro_liberar_prescr_w, wheb_mensagem_pck.get_texto(278887, 'DS_HORARIOS_INCONSISTENTES_P=' || substr(ds_horarios_inconsistentes_w,3,2000)), cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (coalesce(nr_seq_kit_w,0) = 0) and (ie_agrupador_w	= 5) and (coalesce(ie_urgencia_w,'N')		= 'N') and (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') and (wheb_assist_pck.Obter_Se_Consiste_REP(142,cd_perfil_p) = 'S') then
		ds_horarios_inconsistentes_w	:= '';
		begin
		ds_horarios_inconsistentes_w	:= Obter_Se_horario_validade(nr_prescricao_p, nr_seq_mat_w);
		exception when others then
			ds_horarios_inconsistentes_w := null;
		end;

		if	((ds_horarios_inconsistentes_w IS NOT NULL AND ds_horarios_inconsistentes_w::text <> '') or (ds_horarios_inconsistentes_w <> '')) then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(142, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 142, ie_erro_liberar_prescr_w, wheb_mensagem_pck.get_texto(278887, 'DS_HORARIOS_INCONSISTENTES_P=' || substr(ds_horarios_inconsistentes_w,3,2000)), cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (coalesce(nr_seq_kit_w::text, '') = '') and (ie_agrupador_w <> 16) and (wheb_assist_pck.Obter_Se_Consiste_REP(144,cd_perfil_p) = 'S') then

		select	count(1)
		into STRICT	qt_material_prescr_w
		from	prescr_material
		where	cd_material	= cd_material_w
		and	nr_prescricao	= nr_prescricao_p
		and	ie_agrupador in (1,2,4)  LIMIT 2;

		if (qt_material_prescr_w > 1) then
			ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(144, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 144, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (wheb_assist_pck.Obter_Se_Consiste_REP(150,cd_perfil_p) = 'S') and (consistir_medic_especialidade(cd_material_w,nr_prescricao_p) = 'S') then
		ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(150, cd_perfil_p);
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 150, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (wheb_assist_pck.Obter_Se_Consiste_REP(151,cd_perfil_p) = 'S') and (consistir_via_aplicacao(nr_prescricao_p, nr_seq_mat_w) = 'S') then
		ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(151, cd_perfil_p);

		begin
		select	max(substr(obter_via_aplicacao(b.ie_via_aplicacao,'D'),1,255))
		into STRICT	ds_via_disp_w
		from	atend_pac_dispositivo a,
			dispositivo_via b,
			mat_via_aplic c
		where	a.nr_seq_dispositivo = b.nr_seq_dispositivo
		and	c.ie_via_aplicacao = b.ie_via_aplicacao
		and	c.cd_material = cd_material_w
		and	coalesce(a.dt_retirada::text, '') = ''
		and	a.nr_atendimento = nr_atendimento_w;
		exception
		when others then
		ds_via_disp_w := '';
		end;

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 151, ie_erro_liberar_prescr_w, ds_via_disp_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	ie_erro_liberar_prescr_w	:= '';


	if (ie_agrupador_w = 1) and (wheb_assist_pck.Obter_Se_Consiste_REP(152,cd_perfil_p) = 'S') then

		SELECT * FROM Verifica_dose_minima(nr_prescricao_p, nr_seq_mat_w, ie_gera_horarios_w, ie_erro_dose_usual_w, ie_erro_dose_maxima_w) INTO STRICT ie_erro_dose_usual_w, ie_erro_dose_maxima_w;
	
		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(152, cd_perfil_p);
		if (ie_erro_dose_maxima_w IS NOT NULL AND ie_erro_dose_maxima_w::text <> '') and
			((coalesce(ds_justificativa_w::text, '') = '') or
				(ds_justificativa_w IS NOT NULL AND ds_justificativa_w::text <> '' AND cd_funcao_origem_w <> 2314)) then
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 152, ie_erro_liberar_prescr_w, ie_erro_dose_maxima_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		elsif (ie_erro_dose_maxima_w IS NOT NULL AND ie_erro_dose_maxima_w::text <> '') and (cd_funcao_origem_w = 2314) then
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 152, ie_erro_liberar_prescr_w, ie_erro_dose_maxima_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w, 'S');
		end if;
		
		
	end if;


	if (ie_agrupador_w = 1) and (ie_controle_medico_w <> '0') and
		((ie_ctrl_medico_antimicrob_w = '0' AND nr_dia_util_w = 0) or
		 (ie_ctrl_medico_antimicrob_w = 'S' AND nr_dia_util_w = 1) or (ie_novo_ciclo_ccih_w = 'S')) and (ie_justifica_dias_util_w = 'S') and (coalesce(qt_dias_solicitado_w,0) <=0) and (wheb_assist_pck.Obter_Se_Consiste_REP(154,cd_perfil_p) = 'S') then

		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(154, cd_perfil_p);
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 154, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	if (ie_agrupador_w = 1) and (ie_controle_medico_w <> '0') and
		(((ie_ctrl_medico_antimicrob_w = '0') and (coalesce(nr_dia_util_w,0) = 0)) or
		 ((ie_ctrl_medico_antimicrob_w = 'S') and (coalesce(nr_dia_util_w,1) = 1)) or (ie_novo_ciclo_ccih_w = 'S')) and (ie_justifica_dias_util_w = 'S') and (wheb_assist_pck.Obter_Se_Consiste_REP(155,cd_perfil_p) = 'S') then
		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(155, cd_perfil_p);
		if (coalesce(ds_justificativa_w::text, '') = '') then
		  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 155, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		else
		  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 155, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w, 'S');
		end if;
	end if;

	if (qt_carct_min_just_w > 0) and (ie_agrupador_w = 1) and (wheb_assist_pck.Obter_Se_Consiste_REP(156,cd_perfil_p) = 'S') then
		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(156, cd_perfil_p);
		if (coalesce(length(ds_justificativa_w),0) > 0) and (coalesce(length(trim(both ds_justificativa_w)),0) < qt_carct_min_just_w) then
		  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 156, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w 	= 1) and (ie_controle_medico_w	<> '0') and (ie_em_protocolo_vanco_w <> 'S') and (wheb_assist_pck.Obter_Se_Consiste_REP(161,cd_perfil_p) = 'S') then
		ds_consist_mat_w := verifica_medic_dupl_dia(cd_material_w, nr_prescricao_p, nm_usuario_p, ds_consist_mat_w);
		if (ds_consist_mat_w IS NOT NULL AND ds_consist_mat_w::text <> '') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(161, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 161, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 8) and
		((coalesce(qt_hora_aplicacao_w::text, '') = '') and (coalesce(qt_min_aplicacao_w, 0) = 0)) and (wheb_assist_pck.Obter_Se_Consiste_REP(166,cd_perfil_p) = 'S') then

		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(166, cd_perfil_p);
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 166, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 5) and (nr_sequencia_proc_w IS NOT NULL AND nr_sequencia_proc_w::text <> '') and (wheb_assist_pck.Obter_Se_Consiste_REP(167,cd_perfil_p) = 'S') then

		begin
		select	coalesce(max(sus_obter_valor_proc_unif(dt_prev_execucao,cd_procedimento,ie_origem_proced,cd_estabelecimento_p,ie_tipo_atendimento_w)),0)
		into STRICT	vl_procedimento_w
		from	prescr_procedimento
		where	nr_prescricao		= nr_prescricao_p
		and	nr_sequencia 		= nr_sequencia_proc_w
		and	ie_origem_proced 	= 7;
		exception
			when others then
			vl_procedimento_w := 0;
			end;

		begin
		select	coalesce(sum(qt_total_dispensar * obter_preco_custo_material(cd_material,cd_estabelecimento_p)),0)
		into STRICT	vl_material_w
		from	prescr_material
		where	nr_prescricao		= nr_prescricao_p
		and	nr_sequencia_proc	= nr_sequencia_proc_w
		and	ie_agrupador		= 5;
		exception
			when others then
			vl_material_w := 0;
			end;

		if (vl_procedimento_w <> 0) and (vl_material_w <> 0) and (vl_procedimento_w < vl_material_w) then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(167, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 167, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;

	end if;


	if (coalesce(ie_medicacao_paciente_w,'N') <> 'S') and (ds_mens_nao_per_mat_w := obter_se_medic_lib_prescr(nr_atendimento_w, cd_material_w, cd_perfil_p, cd_setor_prescr_w, cd_convenio_w, ie_tipo_atendimento_w, nm_usuario_p, nm_usuario_original_w, ie_agrupador_w, cd_pessoa_fisica_w, nr_prescricao_p, ie_via_aplicacao_w) = 'N') and (wheb_assist_pck.Obter_Se_Consiste_REP(168,cd_perfil_p) = 'S') then

		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(168, cd_perfil_p);
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 168, ie_erro_liberar_prescr_w, ds_mens_nao_per_mat_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);

	end if;


	if (wheb_assist_pck.Obter_Se_Consiste_REP(170,cd_perfil_p) = 'S') and (obter_se_justifcativa_conv(cd_convenio_w,cd_material_w,cd_setor_prescr_w,ie_tipo_atendimento_w) = 'S') then
		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(170, cd_perfil_p);
		if (coalesce(ds_justificativa_w::text, '') = '') then
		  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 170, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		else
		  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 170, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w, 'S');
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') and (coalesce(nr_seq_kit_w,0) = 0) and (ie_agrupador_w	<> 5) and (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') and (ie_acm_w <> 'S') and (ie_se_necessario_w <> 'S') and (ie_dose_espec_agora_w <> 'S') and (coalesce(ds_dose_diferenciada_w::text, '') = '') and (nr_ocorrencia_w > 0) and (wheb_assist_pck.Obter_Se_Consiste_REP(174,cd_perfil_p) = 'S') then

		if (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') and (hr_prim_horario_w <> '  :  ') then
			dt_prim_hor_prescr_w	:= PKG_DATE_UTILS.get_Time(clock_timestamp(), hr_primeiro_horario_w, 0);
			dt_prim_hor_medic_w	:= PKG_DATE_UTILS.get_Time(clock_timestamp(), hr_prim_horario_w, 0);

			if (dt_prim_hor_medic_w <> dt_prim_hor_prescr_w) then
				nr_horas_validade_w	:= nr_horas_validade_w - Obter_Hora_Entre_datas(dt_prim_hor_prescr_w, dt_prim_hor_medic_w);
			end if;

		end if;
		
		-- Se for CPOE deixa fixo 24h
		if (nr_seq_mat_cpoe_w > 0) then
			nr_horas_validade_w	:= 24;			
		end if;
		
		select	coalesce(max(qt_operacao),1)
		into STRICT	qt_operacao_w
		from	intervalo_prescricao
		where	cd_intervalo	= cd_intervalo_w;

		if (qt_operacao_w <= 24) then
			qt_ocorrencias_hor_w	:= coalesce(obter_ocorrencia_intervalo(cd_intervalo_w, nr_horas_validade_w, 'O'),0);
		else
			qt_ocorrencias_hor_w	:= 1;
		end if;

		if (qt_ocorrencias_hor_w <> nr_ocorrencia_w) then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(174, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 174, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;


	if (wheb_assist_pck.Obter_Se_Consiste_REP(179,cd_perfil_p) = 'S') and (consistir_recomendacao_mat(nr_prescricao_p,cd_material_w) = 'S')then
		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(179, cd_perfil_p);
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 179, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	if	((coalesce(cd_unid_med_dose_w::text, '') = '') or ((cd_unid_med_dose_w = cd_unidade_medida_consumo_w) and (Obter_se_unid_consumo(cd_material_w, cd_estabelecimento_p, 0) = 'N'))) and (ie_agrupador_w <> 16) and (wheb_assist_pck.Obter_Se_Consiste_REP(180,cd_perfil_p) = 'S') then
		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(180, cd_perfil_p);
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 180, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	if (ie_agrupador_w in (8,12)) and (wheb_assist_pck.Obter_Se_Consiste_REP(181,cd_perfil_p) = 'S') then
		ie_permite_w	:= Obter_se_permite_nut(cd_material_w);
		if (ie_permite_w = 'N') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(181, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 181, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	if (ie_consiste_dias_w = 'S') and (coalesce(qt_dias_solicitado_w,0) = 0) and (wheb_assist_pck.Obter_Se_Consiste_REP(184,cd_perfil_p) = 'S') then
		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(184, cd_perfil_p);
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 184, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	if (wheb_assist_pck.Obter_Se_Consiste_REP(185,cd_perfil_p) = 'S') and (REP_Obter_se_itens_iguais(nr_prescricao_p,nr_seq_mat_w ) = 'S') then
		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(185, cd_perfil_p);
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 185, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	if (wheb_assist_pck.Obter_Se_Consiste_REP(190,cd_perfil_p) = 'S') then
		ds_mensagem_w	:= Obter_msg_control_medic(nr_dia_util_w, cd_material_w, cd_pessoa_fisica_w, ie_objetivo_w);
		if (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(190, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 190, ie_erro_liberar_prescr_w, ds_mensagem_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	if (coalesce(ie_dose_espec_agora_w,'N')	= 'S') and (coalesce(hr_dose_especial_w::text, '') = '') and (wheb_assist_pck.Obter_Se_Consiste_REP(195,cd_perfil_p) = 'S') then
		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(195, cd_perfil_p);
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 195, ie_erro_liberar_prescr_w, ds_mensagem_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	if (wheb_assist_pck.Obter_Se_Consiste_REP(198,cd_perfil_p) = 'S') then
		select	max(nr_dias_lib)
		into STRICT	nr_dias_lib_w
		from	rep_controle_atb
		where	nr_sequencia	= (SELECT	max(nr_sequencia)
					   from		rep_controle_atb
					   where	nr_atendimento	= nr_atendimento_w
					   --and		coalesce(ie_continuou,'N')	<> 'S'
					   and		cd_material	= cd_material_w);

		if (nr_dias_lib_w = 0) then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(198, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 198, ie_erro_liberar_prescr_w, ds_mensagem_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	if (coalesce(qt_dose_especial_w,0) = 0) and (ie_dose_espec_agora_w	= 'S') and (wheb_assist_pck.Obter_Se_Consiste_REP(200,cd_perfil_p) = 'S') then
		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(200, cd_perfil_p);
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 200, ie_erro_liberar_prescr_w, ds_mensagem_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if	((obter_funcao_ativa <> 2314) and (wheb_assist_pck.Obter_Se_Consiste_REP(202,cd_perfil_p) = 'S')) then
		ds_consist_mat_w := verifica_dupl_dia_grupo(cd_material_w, nr_prescricao_p, nr_atendimento_w, cd_pessoa_fisica_w, dt_prescricao_w, cd_estabelecimento_p, cd_grupo_material_w, nm_usuario_p, ds_horarios_w, ds_consist_mat_w);

		if (ds_consist_mat_w IS NOT NULL AND ds_consist_mat_w::text <> '') then
			ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(202, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 202, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (qt_max_classif_w > 0) and ((coalesce(hr_prim_horario_w,hr_dose_especial_w) IS NOT NULL AND (coalesce(hr_prim_horario_w,hr_dose_especial_w))::text <> '')) and (wheb_assist_pck.Obter_Se_Consiste_REP(203,cd_perfil_p) = 'S') then

		dt_inicio_item_w	:= PKG_DATE_UTILS.get_Time(dt_inicio_prescr_w, coalesce(hr_prim_horario_w,hr_dose_especial_w), 0);
		nr_seq_classif_w	:= obter_classif_mat_leite_deriv(cd_material_w);

		select	count(*)
		into STRICT	qt_classif_igual_w
		from	prescr_material
		where	nr_prescricao = nr_prescricao_p
		and	ie_agrupador = 16
		and	(nr_seq_leite_deriv IS NOT NULL AND nr_seq_leite_deriv::text <> '')
		and	(obter_classif_mat_leite_deriv(cd_material) IS NOT NULL AND (obter_classif_mat_leite_deriv(cd_material))::text <> '')
		and	obter_classif_mat_leite_deriv(cd_material) = nr_seq_classif_w;

		select	count(*) + qt_classif_igual_w
		into STRICT	qt_classif_igual_w
		from	prescr_material b,
			prescr_medica a
		where	a.nr_atendimento = nr_atendimento_w
		and	a.nr_prescricao = b.nr_prescricao
		and	b.nr_prescricao <> nr_prescricao_p
		and	a.dt_prescricao between clock_timestamp() - interval '5 days' and clock_timestamp() + interval '1 days'
		and	coalesce(a.dt_suspensao::text, '') = ''
		and	((a.nm_usuario_original = nm_usuario_p) or ((coalesce(a.dt_liberacao,a.dt_liberacao_medico) IS NOT NULL AND (coalesce(a.dt_liberacao,a.dt_liberacao_medico))::text <> '')))
		and	dt_inicio_item_w between obter_data_leite_deriv(a.nr_prescricao,'m') and obter_data_leite_deriv(a.nr_prescricao,'M')
		and	b.ie_agrupador = 16
		and	coalesce(b.dt_suspensao::text, '') = ''
		and	coalesce(b.ie_suspenso,'N') = 'N'
		and	(obter_classif_mat_leite_deriv(b.cd_material) IS NOT NULL AND (obter_classif_mat_leite_deriv(b.cd_material))::text <> '')
		and	obter_classif_mat_leite_deriv(b.cd_material) = nr_seq_classif_w;

		select	count(*)
		into STRICT	qt_classif_dif_w
		from	prescr_material
		where	nr_prescricao = nr_prescricao_p
		and	ie_agrupador = 16
		and	(nr_seq_leite_deriv IS NOT NULL AND nr_seq_leite_deriv::text <> '')
		and	(obter_classif_mat_leite_deriv(cd_material) IS NOT NULL AND (obter_classif_mat_leite_deriv(cd_material))::text <> '')
		and	obter_classif_mat_leite_deriv(cd_material) <> nr_seq_classif_w;

		select	count(*) + qt_classif_dif_w
		into STRICT	qt_classif_dif_w
		from	prescr_material b,
			prescr_medica a
		where	a.nr_atendimento = nr_atendimento_w
		and	a.nr_prescricao = b.nr_prescricao
		and	b.nr_prescricao <> nr_prescricao_p
		and	a.dt_prescricao between clock_timestamp() - interval '5 days' and clock_timestamp() + interval '1 days'
		and	coalesce(a.dt_suspensao::text, '') = ''
		and	((a.nm_usuario_original = nm_usuario_p) or ((coalesce(a.dt_liberacao,a.dt_liberacao_medico) IS NOT NULL AND (coalesce(a.dt_liberacao,a.dt_liberacao_medico))::text <> '')))
		and	dt_inicio_item_w between obter_data_leite_deriv(a.nr_prescricao,'m') and obter_data_leite_deriv(a.nr_prescricao,'M')
		and	b.ie_agrupador = 16
		and	coalesce(b.dt_suspensao::text, '') = ''
		and	coalesce(b.ie_suspenso,'N') = 'N'
		and	(obter_classif_mat_leite_deriv(b.cd_material) IS NOT NULL AND (obter_classif_mat_leite_deriv(b.cd_material))::text <> '')
		and	obter_classif_mat_leite_deriv(b.cd_material) <> nr_seq_classif_w;

		if (qt_classif_igual_w > 1) or (qt_classif_dif_w >= qt_max_classif_w) then
			ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(203, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 203, ie_erro_liberar_prescr_w, Obter_msg_class_leite_deriv(nr_prescricao_p,nr_seq_mat_w,nm_usuario_p, qt_classif_igual_w, qt_classif_dif_w), cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (wheb_assist_pck.Obter_Se_Consiste_REP(204,cd_perfil_p) = 'S') then

		select	count(*)
		into STRICT	qt_produtos_vig_w
		from	prescr_mat_hor a,
			prescr_material b,
			prescr_medica c
		where	c.nr_atendimento = nr_atendimento_w
		and	c.dt_inicio_prescr between dt_inicio_prescr_w - 1 and dt_validade_prescr_w + 1
		and	a.nr_prescricao = b.nr_prescricao
		and	b.nr_prescricao = c.nr_prescricao
		and	b.nr_sequencia = b.nr_seq_material
		and	a.nr_prescricao <> nr_prescricao_p
		and	a.ie_agrupador	= 16
		and	coalesce(a.dt_suspensao::text, '') = ''
		and	coalesce(b.dt_suspensao::text, '') = ''
		and	coalesce(b.ie_suspenso,'N') = 'N'
		and	coalesce(c.dt_suspensao::text, '') = ''
		and	coalesce(a.ie_situacao,'A') = 'A'
		and	a.cd_material	= cd_material_w
		and	a.dt_horario	between dt_inicio_prescr_w and dt_validade_prescr_w  LIMIT 1;

		if (qt_produtos_vig_w > 0) then
			ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(204, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 204, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_acm_w = 'S') and (wheb_assist_pck.Obter_Se_Consiste_REP(205,cd_perfil_p) = 'S') then

		select	count(*),
			sum(CASE WHEN cd_setor_atendimento=cd_setor_prescr_w THEN 1  ELSE 0 END )
		into STRICT	cont_w,
			cont2_w
		from	REP_SETOR_ACM;

		if (cont_w > 0) and (cont2_w = 0) then
			ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(205, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 205, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (nr_dias_justif_w > 0) and (ie_agrupador_w = 15) and (nr_dia_util_w > 0) and
		((mod(nr_dia_util_w,nr_dias_justif_w) = 0) or (nr_dia_util_w = 1)) and (wheb_assist_pck.Obter_Se_Consiste_REP(206,cd_perfil_p) = 'S') then
		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(206, cd_perfil_p);
		if (coalesce(ds_justificativa_w::text, '') = '') then
		  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 206, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		else
		  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 206, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w, 'S');
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_material_padronizado_w = 'N') and
		((ie_prescr_nao_padronizado_w = 'O') or
		 ((ie_prescr_nao_padronizado_w = 'R') and (wheb_assist_pck.Obter_Se_Consiste_REP(224,cd_perfil_p) = 'S') and (obter_prescr_nao_padronizado(nr_atendimento_w) <> 'S'))) and (coalesce(Obter_se_medic_lib_pac2(cd_pessoa_prescr_w, cd_material_w, dt_prescricao_w, cd_estabelecimento_p, nm_usuario_p),'N') = 'N') then
		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(224, cd_perfil_p);
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 224, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (ie_medic_composto_w = 'S') and (ie_material_diluido_w = 'S') and (wheb_assist_pck.Obter_Se_Consiste_REP(225,cd_perfil_p) = 'S') then

		select	count(*)
		into STRICT	cont_w
		from	prescr_material
		where	nr_prescricao	= nr_prescricao_p
		and	nr_sequencia	<> nr_seq_mat_w
		and	nr_agrupamento	= nr_agrupamento_w
		and	ie_agrupador	= 1
		and	coalesce(cd_kit_material::text, '') = ''
		and	obter_se_material_diluido(nr_prescricao, nr_sequencia) = 'S'  LIMIT 1;

		if (cont_w > 0) then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(225, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 225, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 4) and (wheb_assist_pck.Obter_Se_Consiste_REP(221,cd_perfil_p) = 'S') then
		if (ie_via_medic_w <> ie_via_aplicacao_w) then
			ie_via_medic_w	:= Obter_se_via_adm_medic(cd_material_w, ie_via_aplic_sol_w);
			if (ie_via_medic_w = 'N') then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(221, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 221, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
			end if;
		end if;
	end if;

	if (ie_agrupador_w = 1) and (coalesce(nr_seq_kit_w::text, '') = '') and (wheb_assist_pck.Obter_Se_Consiste_REP(248,cd_perfil_p) = 'S') then
		ie_via_medic_w	:= Obter_se_via_adm_medic(cd_material_w, ie_via_aplicacao_w);

		if (ie_via_medic_w = 'N') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(248, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 248, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w <> 16) and (coalesce(ie_consiste_estoque_w,'S') = 'S') and (wheb_assist_pck.Obter_Se_Consiste_REP(233,cd_perfil_p) = 'S') then

		CALL define_local_disp_prescr(nr_prescricao_p, null, cd_perfil_p, nm_usuario_p);
		
		qt_saldo_disponivel_estoque_w	:= obter_saldo_estoque_consist(cd_estab_prescr_w, cd_material_w, 0, clock_timestamp());
		
		select	max(cd_unidade_medida_estoque)
		into STRICT	cd_unidade_medida_estoque_w
		from	material
		where	cd_material = cd_material_w;
		
		qt_saldo_disponivel_estoque_w := obter_quantidade_convertida(cd_material_w, qt_saldo_disponivel_estoque_w, cd_unidade_medida_estoque_w,'UMC');

		select	coalesce(max(ie_consiste_saldo_rep),'S')
		into STRICT	ie_consiste_estoque_w
		from	local_Estoque
		where	cd_local_estoque = cd_local_prescr_w;

		if (coalesce(ie_consiste_estoque_w,'S') = 'S') then

			if (coalesce(qt_saldo_disponivel_estoque_w,0) = 0) then
				open C02;
				loop
				fetch C02 into
					cd_local_estoque_ww;
				EXIT WHEN NOT FOUND; /* apply on C02 */
					if (coalesce(qt_saldo_disponivel_estoque_w,0) = 0) then
						qt_saldo_disponivel_estoque_w	:= obter_saldo_estoque_consist(cd_estab_prescr_w, cd_material_w, cd_local_estoque_ww, clock_timestamp());
					end if;
				end loop;
				close C02;
			end if;

			if (coalesce(cd_unidade_medida_est_w::text, '') = '') then
				cd_unidade_medida_est_w	:= substr(obter_dados_material_estab(cd_material_w,cd_estabelecimento_p,'UME'),1,30);
			end if;

			qt_dose_ww := obter_conversao_unid_med_cons(cd_material_w, cd_unidade_medida_est_w, qt_total_dispensar_w);
			if (qt_saldo_disponivel_estoque_w < qt_dose_ww) and (coalesce(ie_atualiza_estoque_w,'S')	= 'S') then
				ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(233, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 233, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
			end if;
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (ds_horarios_w not in ('ACM','SN')) and (coalesce(hr_prim_horario_w,'  :  ') = '  :  ') and (wheb_assist_pck.Obter_Se_Consiste_REP(238,cd_perfil_p) = 'S') then

		select	max(qt_hora_intervalo),
				max(qt_min_intervalo)
		into STRICT	qt_hora_intervalo_w,
				qt_min_intervalo_w
		from	prescr_material
		where	nr_prescricao = nr_prescricao_p
		and		nr_sequencia = nr_seq_material_p;

		if (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then
			if (position(':' in ds_horarios_w) > 0) then
				dt_prim_hor_medic_w	:= PKG_DATE_UTILS.get_Time(dt_inicio_prescr_w, substr(ds_horarios_w,1,5), 0);
			else
				dt_prim_hor_medic_w	:= PKG_DATE_UTILS.get_Time(dt_inicio_prescr_w, substr(ds_horarios_w,1,2), 0);
			end if;
		else
			dt_prim_hor_medic_w := dt_inicio_prescr_w;
		end if;

		SELECT * FROM Calcular_Horario_Prescricao(nr_prescricao_p, cd_intervalo_w, dt_inicio_prescr_w, dt_prim_hor_medic_w, nr_horas_validade_w, cd_material_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_ocorrencias_sist_w, ds_horarios_1w, ds_horarios_2w, 'N', null) INTO STRICT nr_ocorrencias_sist_w, ds_horarios_1w, ds_horarios_2w;

		select	obter_ocorrencias_horarios_rep(ds_horarios_1w || ds_horarios_2w),
				obter_ocorrencias_horarios_rep(ds_horarios_w)
		into STRICT	nr_ocorrencias_sist_w,
				nr_ocorrencias_atual_w
		;

		if (coalesce(nr_ocorrencias_sist_w,0) <> coalesce(nr_ocorrencias_atual_w,0)) then
			ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(238, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 238, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (wheb_assist_pck.Obter_Se_Consiste_REP(239,cd_perfil_p) = 'S') and (qt_dose_w <> trunc(qt_dose_w)) and (ie_permite_fracionado_w = 'N')	then
		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(239, cd_perfil_p);
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 239, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w = 1) and (wheb_assist_pck.Obter_Se_Consiste_REP(240,cd_perfil_p) = 'S') then
		ie_consiste_perido_w	:= obter_se_consiste_periodo(7,nr_prescricao_p,nr_seq_mat_w,cd_perfil_p,cd_setor_prescr_w,'C');
		if (ie_consiste_perido_w  = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(240, cd_perfil_p);
			ds_mensagem_w	:= obter_se_consiste_periodo(7,nr_prescricao_p,nr_seq_mat_w,cd_perfil_p,cd_setor_prescr_w,'M');
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 240, ie_erro_liberar_prescr_w, ds_mensagem_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	elsif (ie_agrupador_w = 12) and (wheb_assist_pck.Obter_Se_Consiste_REP(241,cd_perfil_p) = 'S') then
		ie_consiste_perido_w	:= obter_se_consiste_periodo(15,nr_prescricao_p,nr_seq_mat_w,cd_perfil_p,cd_setor_prescr_w,'C');
		if (ie_consiste_perido_w  = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(241, cd_perfil_p);
			ds_mensagem_w	:= obter_se_consiste_periodo(15,nr_prescricao_p,nr_seq_mat_w,cd_perfil_p,cd_setor_prescr_w,'M');
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 241, ie_erro_liberar_prescr_w, ds_mensagem_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;


	if (ie_agrupador_w = 1) and (wheb_assist_pck.Obter_Se_Consiste_REP(246,cd_perfil_p) = 'S') and (coalesce(ie_prescr_emergencia_w,'N') = 'S') and
		((coalesce(ie_se_necessario_w,'N') = 'S') or (coalesce(ie_acm_w,'N') = 'S') or (coalesce(ie_urgencia_w,'N') = 'S')) then
		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(246, cd_perfil_p);
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 246, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	ie_erro_liberar_prescr_w := '';
	if (wheb_assist_pck.Obter_Se_Consiste_REP(242,cd_perfil_p) = 'S')  and (obter_se_diluicao_prescr_mat(nr_prescricao_p,nr_seq_mat_w) = 'S') and (coalesce(cd_diluente_w,0) > 0) then
		if (obter_se_permite_diluente(cd_diluente_w) = 'N') then
			select	max(nr_sequencia),
				max(obter_desc_material(cd_diluente_w))
			into STRICT	nr_sequencia_diluicao_w,
				ds_diluente_w
			from	prescr_material
			where	nr_sequencia		= nr_seq_mat_w
			and	nr_prescricao		= nr_prescricao_p;

			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(242, cd_perfil_p);

			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_sequencia_diluicao_w, 242, ie_erro_liberar_prescr_w, ds_diluente_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, 3);
		end if;
	end if;

	ie_erro_liberar_prescr_w := '';
	if (nr_seq_solucao_w > 0) then
		select	max(ie_bomba_infusao)
		into STRICT	ie_bomba_infusao_sol_w
		from	prescr_solucao
		where	nr_prescricao 	= nr_prescricao_p
		and	nr_seq_solucao	= nr_seq_solucao_w;

		if (wheb_assist_pck.Obter_Se_Consiste_REP(247,cd_perfil_p) = 'S') and (obter_se_obriga_campo_sol(nr_prescricao_p, nr_seq_solucao_w, ie_bomba_infusao_sol_w, 'J') = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(247, cd_perfil_p);
			if (coalesce(ds_justificativa_w::text, '') = '') then
			  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 247, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
			else
			  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 247, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w, 'S');
			end if;
		end if;
	end if;

	if	((qt_hora_aplicacao_w IS NOT NULL AND qt_hora_aplicacao_w::text <> '') or (qt_min_aplicacao_w IS NOT NULL AND qt_min_aplicacao_w::text <> '')) and (wheb_assist_pck.Obter_Se_Consiste_REP(250,cd_perfil_p) = 'S') then
		select	coalesce(obter_minutos_hora(coalesce(qt_hora_aplicacao_w,0)||':'||qt_min_aplicacao_w),0)
		into STRICT		qt_min_total_aplic_w
		;

		if	((qt_min_total_aplic_w > qt_aplic_max_pad_w) or (qt_min_total_aplic_w < qt_aplic_min_pad_w)) then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(250, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 250, ie_erro_liberar_prescr_w, wheb_mensagem_pck.get_texto(278888, 'QT_APLIC_MAX_PAD_P=' || qt_aplic_max_pad_w || ';QT_APLIC_MIN_PAD_P=' || qt_aplic_min_pad_w), cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w := '';

	if (ds_prim_horario_w IS NOT NULL AND ds_prim_horario_w::text <> '') and (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') and (hr_prim_horario_w <> '  :  ')	and (ie_agrupador_w	= 1) and (wheb_assist_pck.Obter_Se_Consiste_REP(251,cd_perfil_p) = 'S') then
		hr_prim_horario_w		:= substr(hr_prim_horario_w,1,2);

		if (obter_se_contido_char(hr_prim_horario_w, replace(ds_prim_horario_w,' ',',')) = 'N') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(251, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 251, ie_erro_liberar_prescr_w, wheb_mensagem_pck.get_texto(278892, 'DS_PRIM_HORARIO_P=' || ds_prim_horario_w), cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') and (ie_agrupador_w = 1) and (wheb_assist_pck.Obter_Se_Consiste_REP(252,cd_perfil_p) = 'S') then
		if (obter_se_dose_esp_zero(ds_dose_diferenciada_w) = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(252, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 252, ie_erro_liberar_prescr_w, wheb_mensagem_pck.get_texto(278893, 'DS_DOSE_DIFERENCIADA_P=' || ds_dose_diferenciada_w), cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w := '';

	select  max(qt_limite_pessoa),
			coalesce(max(ie_obriga_just_dose),'N')
	into STRICT 	qt_material_limite_w,
			ie_obriga_just_dose_w
	from 	material
	where	cd_material = cd_material_w;

	if (ie_agrupador_w in (1,8,12)) and (ie_obriga_just_dose_w = 'S') and (wheb_assist_pck.Obter_Se_Consiste_REP(275,cd_perfil_p) = 'S') then

		if (qt_material_limite_w)  = 0 then
			SELECT   MAX(Obter_dose_maxima_cons(cd_material_w,cd_unid_med_dose_w, qt_dose_w, ie_via_aplicacao_w, nr_prescricao_p, cd_estabelecimento_p,ie_agrupador_w))
			INTO STRICT     qt_material_limite_w
			;
		end if;

		qt_ocorrencias_hor_w	:= coalesce(obter_ocorrencia_intervalo(cd_intervalo_w, nr_horas_validade_w, 'O'),1);

		if (qt_material_limite_w > 0) and
		   (qt_material_limite_w < (qt_dose_w * qt_ocorrencias_hor_w)) then
		    ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(275, cd_perfil_p);
			IF (coalesce(ds_justificativa_w::text, '') = '') then
			  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 275, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
			ELSE
			  nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 275, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w, 'S');
			END IF;
		   end if;
	end if;

	ie_erro_liberar_prescr_w := '';
	if (wheb_assist_pck.Obter_Se_Consiste_REP(255,cd_perfil_p) = 'S') and (coalesce(nr_seq_kit_w::text, '') = '') and (ie_agrupador_w	= 1) then

			ie_duplicado_prescr_w	:= verifica_medic_dupl_prescr(cd_material_w,nr_prescricao_p,nr_seq_mat_w,nm_usuario_p);

			select	count(1)
			into STRICT	count_w
			from	regra_material_duplic
			where	coalesce(cd_classe_material,cd_classe_material_w)	= cd_classe_material_w
			and	coalesce(cd_grupo_material,cd_grupo_material_w) 	= cd_grupo_material_w
			and	coalesce(cd_subgrupo_material,cd_subgrupo_w) 	= cd_subgrupo_w
			and	coalesce(cd_material,cd_material_w) 			= cd_material_w
			and	coalesce(cd_setor_atendimento,cd_setor_prescr_w) 	= cd_setor_prescr_w
			and	((coalesce(ie_consiste_justificativa,'N') = 'N') or (coalesce(ds_justificativa_w::text, '') = ''))
			and	coalesce(ie_liberar,'S') = 'N'
			and coalesce(ie_consistir,'D')  = 'P'  LIMIT 1;

			if (ie_duplicado_prescr_w	= 'S') then
				if (count_w > 0)then
					ie_erro_liberar_prescr_w := 'N';
				else
					ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(255, cd_perfil_p);
				end if;
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 255, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
			end if;

	end if;

	if (wheb_assist_pck.Obter_Se_Consiste_REP(261,cd_perfil_p) = 'S') and (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') and (cd_setor_prescr_w IS NOT NULL AND cd_setor_prescr_w::text <> '') and
		((obter_se_exibe_intervalo(nr_prescricao_p,cd_intervalo_w,cd_setor_prescr_w) = 'N') or (Obter_se_setor_intervalo(cd_intervalo_w,cd_setor_prescr_w,cd_estabelecimento_p,cd_material_w,ie_via_aplicacao_w,null) = 'N')) then
		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(261, cd_perfil_p);
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 261, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;



	if (wheb_assist_pck.Obter_Se_Consiste_REP(262,cd_perfil_p) = 'S') then

		cd_intervaloAcmSn_w := obter_se_interv_agora_acm_sn(cd_intervalo_w);

		if	((coalesce(ie_acm_w,'N')   = 'N') and (cd_intervaloAcmSn_w = 'ACM')) or
			((coalesce(ie_se_necessario_w,'N') = 'N') and (cd_intervaloAcmSn_w = 'SN')) then

			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(262, cd_perfil_p);
			if (cd_intervaloAcmSn_w = 'ACM') then
				nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 262, ie_erro_liberar_prescr_w, wheb_mensagem_pck.get_texto(278894), cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
			else
				nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 262, ie_erro_liberar_prescr_w, wheb_mensagem_pck.get_texto(278896), cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
			end if;

		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_agrupador_w <> 16) and (wheb_assist_pck.Obter_Se_Consiste_REP(264,cd_perfil_p) = 'S') then

		SELECT * FROM Verifica_Pac_Alergico_classe(cd_pessoa_prescr_w, cd_material_w, ds_item_w, ie_paciente_alergico_w) INTO STRICT ds_item_w, ie_paciente_alergico_w;

		if (ie_paciente_alergico_w = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(264, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 264, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	select	max(coalesce(qt_volume_oral, qt_volume_sonda))
	into STRICT	qt_volume_leite_w
	from	prescr_leite_deriv
	where	nr_sequencia	= nr_seq_leite_deriv_w;

	if (ie_agrupador_w = 16) and (wheb_assist_pck.Obter_Se_Consiste_REP(265,cd_perfil_p) = 'S') then

		ie_consistir_w	:= 'N';
		if (ie_regra_volume_leite_w = 'I') and (qt_dose_w > qt_volume_leite_w) then
			ie_consistir_w	:= 'S';
		elsif (ie_regra_volume_leite_w = 'C') then
			select	sum(qt_dose)
			into STRICT	qt_dose_w
			from	prescr_material
			where	nr_prescricao	= nr_prescricao_p
			and		ie_agrupador	= 16
			and		nr_seq_leite_deriv = nr_seq_leite_deriv_w
			and		ie_regra_volume_leite = 'C';
			if (qt_dose_w > qt_volume_leite_w) then
				ie_consistir_w	:= 'S';
			end if;
		end if;

		if (ie_consistir_w = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(265, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 265, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;

	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_material_padronizado_w = 'N') and (ie_prescr_nao_padronizado_w in ('J','JSS')) and (ie_medicacao_paciente_w <> 'S') and (qt_dias_tratamento_w = 0) and (qt_dias_solicitado_w = 0) and (ie_Agrupador_w not in (2,16)) and (wheb_assist_pck.Obter_Se_Consiste_REP(267,cd_perfil_p) = 'S') and (coalesce(Obter_se_medic_lib_pac2(cd_pessoa_prescr_w, cd_material_w, dt_prescricao_w, cd_estabelecimento_p, nm_usuario_p),'N') = 'N') then
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 267, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (wheb_assist_pck.Obter_Se_Consiste_REP(268,cd_perfil_p) = 'S') and (ie_obriga_tempo_aplic_w = 'S') and (ie_aplic_bolus_w = 'N') and (ie_aplic_lenta_w = 'N') and (ie_via_aplicacao_w IS NOT NULL AND ie_via_aplicacao_w::text <> '') and (ie_agrupador_w = 1) then

		select	count(ie_via_aplicacao)
		into STRICT	ie_via_endov_w
		from	via_aplicacao
		where	ie_via_aplicacao = ie_via_aplicacao_w
		and		coalesce(ie_endovenosa,'N') = 'S';

		if (ie_via_endov_w > 0) and (coalesce(qt_hora_aplicacao_w::text, '') = '') and (coalesce(qt_min_aplicacao_w::text, '') = '') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(268, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 268, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_urgencia_w = 'S') and (wheb_assist_pck.Obter_Se_Consiste_REP(269,cd_perfil_p) = 'S') then
		ie_permite_agora_w	:= obter_se_permite_agora(cd_material_w);
		if (ie_permite_agora_w = 'N') then
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 269, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
		end if;
	end if;

	if (obter_se_intervalo_sugerido(cd_material_w,cd_intervalo_w) = 'N') and (wheb_assist_pck.Obter_Se_Consiste_REP(270,cd_perfil_p) = 'S') then
		ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(270, cd_perfil_p);
		ds_intervalos_w	:= obter_intervalos_sugeridos(cd_material_w);
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 270, ie_erro_liberar_prescr_w, ds_intervalos_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_material_padronizado_w = 'N') and (ie_prescr_nao_padronizado_w = 'P') and (ie_medicacao_paciente_w <> 'S') and (coalesce(nr_seq_lib_mat_pac_w::text, '') = '') and (ie_Agrupador_w in (1)) and (wheb_assist_pck.Obter_Se_Consiste_REP(272,cd_perfil_p) = 'S') and (coalesce(Obter_se_medic_lib_pac2(cd_pessoa_prescr_w, cd_material_w, dt_prescricao_w, cd_estabelecimento_p, nm_usuario_p),'N') = 'N') then

		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 272, 'N', null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	ie_erro_liberar_prescr_w := '';

	if (wheb_assist_pck.Obter_Se_Consiste_REP(277,cd_perfil_p) = 'S') and (ie_Agrupador_w	= 1) and (ie_objetivo_w	in ('F','P','C')) and (coalesce(qt_dia_interv_profilaxia_w,0)	> 0) and
		((nr_dia_util_w	= 0 AND ie_dias_util_medic_w	= 'O') or
		  (ie_dias_util_medic_w	= 'S' AND nr_dia_util_w > qt_dia_interv_profilaxia_w)) then
		  /*
		select	max(a.dt_horario)
		into	dt_horario_w
		from	prescr_medica c,
				prescr_material b,
				prescr_mat_hor a
		where	c.nr_prescricao = b.nr_prescricao
		and		c.nr_prescricao = a.nr_prescricao
		and		b.nr_prescricao = a.nr_prescricao
		and		b.nr_sequencia	= a.nr_seq_material
		and		c.nr_atendimento = nr_atendimento_w
		and		b.cd_material	= cd_material_w
		and		c.nr_prescricao	<> nr_prescricao_p
		and		b.ie_objetivo	in ('F','P','C')
		and		b.ie_agrupador	= 1
		and		a.dt_lib_horario is not null
		and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_horario)	> ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_prescr_w	- qt_dia_interv_profilaxia_w);

		*/
		--if	(dt_horario_w	is not null) then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(277, cd_perfil_p);

			ds_inconsis277_w	:= wheb_mensagem_pck.get_texto(278897, 'DT_HORARIO_P=' || PKG_DATE_FORMATERS.TO_VARCHAR(dt_horario_w, 'timestamp', cd_estabelecimento_p, nm_usuario_p) ||
											';QT_DIA_INTERV_PROFILAXIA_P=' || qt_dia_interv_profilaxia_w);

			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 277, ie_erro_liberar_prescr_w, ds_inconsis277_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, null, ie_agrupador_w);
		--end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';

	if (ie_Agrupador_w in (1)) and (wheb_assist_pck.Obter_Se_Consiste_REP(278,cd_perfil_p) = 'S') then

			select	coalesce(max(ie_recomendada),'N')
			into STRICT	ie_via_nao_recomendada_w
			from	mat_via_aplic
			where	cd_material		= cd_material_w
			and		ie_via_aplicacao = ie_via_aplicacao_w;

			if (ie_via_nao_recomendada_w       = 'S') then
				ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(278, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 278, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, null, ie_agrupador_w);
			end if;

	end if;

	if ( (ie_Agrupador_w =1) or (ie_Agrupador_w =4) ) and (wheb_assist_pck.Obter_Se_Consiste_REP(284,cd_perfil_p) = 'S') then

		SELECT * FROM mat_lib_prescr_result_exame(nr_atendimento_w, cd_material_w, ie_lib_mat_result_exame_w, ds_mensagem_w) INTO STRICT ie_lib_mat_result_exame_w, ds_mensagem_w;
		
		if ((ie_lib_mat_result_exame_w = 'N') or (ie_lib_mat_result_exame_w = 'J')) then
	
			ds_inf_just_exam_w := null;

			if ((ie_lib_mat_result_exame_w = 'N') or
				((ie_lib_mat_result_exame_w = 'J') and (coalesce(ds_justificativa_w::text, '') = ''))) then
				ie_erro_liberar_prescr_w := 'N';
				
				if (ie_lib_mat_result_exame_w = 'J') then
					ds_inf_just_exam_w := wheb_mensagem_pck.get_texto(802291);
				end if;
			else
				ie_erro_liberar_prescr_w := 'S';
			end if;
			
			if (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') then
				ds_inf_just_exam_w := ds_inf_just_exam_w || ' ' || ds_mensagem_w;
			end if;
			
			nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 284, ie_erro_liberar_prescr_w, ds_inf_just_exam_w, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, null, ie_agrupador_w);
		end if;	
	end if;

	if      ((ie_Agrupador_w = 1) and (ie_param953_w in ('A', 'S'))) then

			if	(((coalesce(ds_param1056_w::text, '') = '') or (obter_se_exibe_int_medic(nr_prescricao_p, ds_param1056_w, cd_material_w) = 'S')) and ((obter_interacao_item_prescr(nr_prescricao_p, cd_material_w) IS NOT NULL AND (obter_interacao_item_prescr(nr_prescricao_p, cd_material_w))::text <> ''))) then

				ie_erro_liberar_prescr_w := 'S';

				if ((ie_param216_w IS NOT NULL AND ie_param216_w::text <> '') and (Obter_se_lib_prescr_interacao(nr_prescricao_p, ie_param216_w) = 'N')) then
					ie_erro_liberar_prescr_w := 'N';
				end if;

				if ((ie_param215_w IS NOT NULL AND ie_param215_w::text <> '') and (Obter_se_obriga_just_interacao(nr_prescricao_p, ie_param215_w) = 'S') and (coalesce(ds_justificativa_prescr_w::text, '') = '')) then
					ie_erro_liberar_prescr_w := 'N';
				end if;

				nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 283, ie_erro_liberar_prescr_w, substr(obter_interacao_item_prescr(nr_prescricao_p, cd_material_w), 1, 2000), cd_perfil_p, nm_usuario_p, nr_seq_erro_w, null, ie_agrupador_w);

			end if;

	end if;

	if ((ie_agrupador_w in (1,2,4,5,8,12,15,16) and (coalesce(ds_justificativa_w::text, '') = '')) or
	   ((ie_agrupador_w = 13) and (coalesce(ds_observacao_w::text, '') = ''))) and (wheb_assist_pck.obter_se_consiste_rep(285,cd_perfil_p) = 'S') and (obriga_justificativa_protocolo(nr_prescricao_p, cd_protocolo_w, nr_seq_protocolo_w) = 'S') and
	   ((coalesce(cd_protocolo_item_w::text, '') = '') or (cd_protocolo_item_w <> cd_protocolo_w)) then
		ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(285, cd_perfil_p);
		nr_seq_erro_w := gerar_erro_prescr_material(nr_prescricao_p, nr_seq_mat_w, 285, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, nr_seq_erro_w, nr_seq_solucao_w, ie_agrupador_w);
	end if;

	ie_erro_liberar_prescr_w	:= '';

	select	count(*)
	into STRICT	qt_erro_nao_lib_w
	from	prescr_medica_erro
	where	nr_prescricao	= nr_prescricao_p
	and	nr_seq_medic	= nr_seq_mat_w
	and	ie_libera	= 'N'  LIMIT 1;

	if (qt_erro_nao_lib_w > 0) then

		update	prescr_material
		set	ie_erro			= 125,
			dt_atualizacao		= clock_timestamp(),
			ie_supera_limite_uso	= ie_supera_limite_uso_w,
			ds_cor_erro		= obter_cor_erro_prescr_mat(nr_prescricao_p, nr_seq_mat_w, 125, cd_estabelecimento_p, cd_perfil_p)
		where	nr_prescricao		= nr_prescricao_p
		and	nr_sequencia		= nr_seq_mat_w;

		ds_erro_p	:= '125';

	else
		select	count(*)
		into STRICT	qt_erro_lib_w
		from	prescr_medica_erro
		where	nr_prescricao	= nr_prescricao_p
		and	nr_seq_medic	= nr_seq_mat_w
		and	ie_libera	= 'S';

		if (qt_erro_lib_w > 0) then
			update	prescr_material
			set	ie_erro			= 124,
				dt_atualizacao		= clock_timestamp(),
				ie_supera_limite_uso	= ie_supera_limite_uso_w,
				ds_cor_erro		= obter_cor_erro_prescr_mat(nr_prescricao_p, nr_seq_mat_w, 124, cd_estabelecimento_p, cd_perfil_p)
			where	nr_prescricao		= nr_prescricao_p
			and	nr_sequencia		= nr_seq_mat_w;
		else
			update	prescr_material
			set	ie_erro			= 0,
				dt_atualizacao		= clock_timestamp(),
				ie_supera_limite_uso	= ie_supera_limite_uso_w,
				ds_cor_erro		 = NULL
			where	nr_prescricao		= nr_prescricao_p
			and	nr_sequencia		= nr_seq_mat_w;
		end if;
	end if;

end loop;
close c00;


if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_regra_prescr_mat (nr_prescricao_p bigint, nr_seq_material_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, ds_erro_p INOUT text, ds_proced_glosa_p INOUT text, cd_perfil_aviso_p INOUT text, nm_usuario_aviso_p INOUT text) FROM PUBLIC;

