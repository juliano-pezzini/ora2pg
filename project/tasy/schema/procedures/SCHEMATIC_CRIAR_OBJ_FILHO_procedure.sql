-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE schematic_criar_obj_filho (nr_seq_obj_pai_p bigint, nr_seq_tipo_sch_pai_p bigint, nm_usuario_p text, cd_funcao_p bigint, nr_seq_bo_p bigint) AS $body$
DECLARE


j 				integer;
qt_objeto_filho_w		bigint;
nr_sequencia_w			bigint;
nr_seq_apres_w			bigint;
nr_seq_tipo_schematic_w		bigint;
nr_seq_funcao_schematic_w	bigint;
id_objeto_w			objeto_schematic.id_objeto%type;

c01 CURSOR FOR
SELECT	nr_sequencia,
	ie_tipo_objeto,
	ie_tipo_obj_painel,
	ie_tipo_obj_master_regiao,
	ie_tipo_obj_navegador,
	ie_tipo_componente,
	substr(obter_desc_expressao(CD_EXP_DESC_OBJ,ds_objeto),1,254) ds_objeto,
	qt_objeto,
	cd_exp_desc_obj,
	ie_tipo_obj_button
from	tipo_schematic_objeto
where	nr_seq_obj_sup	= nr_seq_tipo_sch_pai_p;

c01_w	c01%rowtype;


BEGIN

open C01;
loop
fetch C01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	j := 0;
	for j in 1..c01_w.qt_objeto loop
		begin

		select	nextval('objeto_schematic_seq')
		into STRICT	nr_sequencia_w
		;

		if (coalesce(nr_seq_bo_p,0) > 0) then
			select	coalesce(max(nr_seq_apres),0)
			into STRICT	nr_seq_apres_w
			from	objeto_schematic
			where	nr_seq_bo	= nr_seq_bo_p
			and	nr_seq_obj_sup	= nr_seq_obj_pai_p;

			id_objeto_w	:= nr_sequencia_w;
		else
			select	coalesce(max(nr_seq_apres),0)
			into STRICT	nr_seq_apres_w
			from	objeto_schematic
			where	cd_funcao	= cd_funcao_p
			and	nr_seq_obj_sup	= nr_seq_obj_pai_p;
		end if;

		select	max(nr_sequencia)
		into STRICT	nr_seq_tipo_schematic_w
		from	tipo_schematic
		where	ie_tipo_objeto			= c01_w.ie_tipo_objeto
		and (ie_tipo_obj_painel 		= c01_w.ie_tipo_obj_painel or
			ie_tipo_obj_master_regiao	= c01_w.ie_tipo_obj_master_regiao or
			ie_tipo_obj_navegador		= c01_w.ie_tipo_obj_navegador or
			ie_tipo_componente		= c01_w.ie_tipo_componente)
		and	coalesce(ie_situacao,'A')	= 'A';


		select	max(nr_seq_funcao_schematic)
		into STRICT	nr_seq_funcao_schematic_w
		from	objeto_schematic
		where	nr_sequencia = nr_seq_obj_pai_p;

		insert into objeto_schematic(nr_sequencia,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_atualizacao,
			nm_usuario,
			cd_funcao,
			ds_objeto,
			ie_tipo_objeto,
			ie_tipo_obj_painel,
			ie_tipo_obj_master_regiao,
			ie_tipo_obj_navegador,
			ie_tipo_componente,
			nr_seq_obj_sup,
			nr_seq_funcao_schematic,
			nr_seq_tipo_schematic,
			nr_seq_apres,
			cd_exp_desc_obj,
			ie_tipo_obj_button,
			nr_seq_bo,
			id_objeto)
		values (nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_funcao_p,
			c01_w.ds_objeto,
			c01_w.ie_tipo_objeto,
			c01_w.ie_tipo_obj_painel,
			c01_w.ie_tipo_obj_master_regiao,
			c01_w.ie_tipo_obj_navegador,
			c01_w.ie_tipo_componente,
			nr_seq_obj_pai_p,
			nr_seq_funcao_schematic_w,
			nr_seq_tipo_schematic_w,
			nr_seq_apres_w + 1,
			c01_w.cd_exp_desc_obj,
			c01_w.ie_tipo_obj_button,
			nr_seq_bo_p,
			id_objeto_w);

		select	count(*)
		into STRICT	qt_objeto_filho_w
		from	tipo_schematic_objeto
		where	nr_seq_obj_sup	= c01_w.nr_sequencia;

		if (qt_objeto_filho_w > 0) then
			CALL SCHEMATIC_CRIAR_OBJ_FILHO(nr_sequencia_w,c01_w.nr_sequencia,nm_usuario_p,cd_funcao_p, nr_seq_bo_p);
		end if;

		end;
	end loop;

	end;
end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE schematic_criar_obj_filho (nr_seq_obj_pai_p bigint, nr_seq_tipo_sch_pai_p bigint, nm_usuario_p text, cd_funcao_p bigint, nr_seq_bo_p bigint) FROM PUBLIC;

