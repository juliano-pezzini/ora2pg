-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_gerar_itens_nota_rvs ( nm_usuario_p text, nr_seq_siscoserv_rf_p bigint, nr_seq_nota_p bigint, nr_seq_rvs_p bigint) AS $body$
DECLARE


nr_sequencia_w		bigint;
qt_insert_w		bigint;
nr_seq_operacao_w	bigint;

c01 CURSOR FOR
	SELECT	sum(vl_total_item_nf) vl_total_itens,
		fis_obter_nbs_procedimento(b.cd_area_procedimento, b.cd_especialidade, b.cd_grupo_proc, b.cd_procedimento, 'S') nr_seq_nbs_proc
	from	estrutura_procedimento_v b,
		nota_fiscal_item a
	where	a.cd_procedimento	= b.cd_procedimento
	and	a.ie_origem_proced	= b.ie_origem_proced
	and	a.nr_sequencia		= nr_seq_nota_p
	group by
		fis_obter_nbs_procedimento(b.cd_area_procedimento, b.cd_especialidade, b.cd_grupo_proc, b.cd_procedimento, 'S');

c01_w		c01%rowtype;


BEGIN
qt_insert_w := 0;

open c01;
loop
fetch c01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	select	max(nr_sequencia) nr_seq_operacao
	into STRICT	nr_seq_operacao_w
	from	siscoserv_rvs_operacao a
	where	a.nr_seq_nbs = c01_w.nr_seq_nbs_proc
	and	a.nr_seq_rvs = nr_seq_rvs_p;


	select	nextval('siscoserv_fatura_item_seq')
	into STRICT	nr_sequencia_w
	;

	insert into siscoserv_fatura_item(
					nr_sequencia,
					nr_seq_fatura,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_oper_rvs,
					vl_item,
					vl_exterior)
	values (
					nr_sequencia_w,
					nr_seq_siscoserv_rf_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_operacao_w, -- nr_seq_oper_rvs
					c01_w.vl_total_itens,
					null);

		qt_insert_w := qt_insert_w + 1;
		if (qt_insert_w > 100) then
			begin
			commit;
			qt_insert_w := 0;
			end;
		end if;
	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_gerar_itens_nota_rvs ( nm_usuario_p text, nr_seq_siscoserv_rf_p bigint, nr_seq_nota_p bigint, nr_seq_rvs_p bigint) FROM PUBLIC;

