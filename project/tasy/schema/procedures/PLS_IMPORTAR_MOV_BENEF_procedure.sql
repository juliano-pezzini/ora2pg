-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_importar_mov_benef ( nr_seq_lote_p pls_mov_benef_lote.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) is ie_tipo_linha_w varchar(10) RETURNS bigint AS $body$
DECLARE


nr_seq_mov_segurado_w	pls_mov_benef_segurado.nr_sequencia%type;

BEGIN

select	max(nr_sequencia)
into STRICT	nr_seq_mov_segurado_w
from	pls_mov_benef_segurado
where	nr_seq_lote = nr_seq_lote_p
and	cd_usuario_plano = cd_usuario_plano_p;

return nr_seq_mov_segurado_w;

end;

function obter_seq_congenere(	cd_cooperativa_p	pls_congenere.cd_cooperativa%type)
					return number is

nr_seq_congenere_w	pls_congenere.nr_sequencia%type;

begin

select	max(nr_sequencia)
into STRICT	nr_seq_congenere_w
from	pls_congenere
where	cd_cooperativa = cd_cooperativa_p;

return nr_seq_congenere_w;

end;

begin

--Loop para percorrer todas as linhas do arquivo
for r_c01_w in C01 loop
	begin
	ds_conteudo_aux_w := replace(replace(r_c01_w.ds_conteudo,CHR(10),''),CHR(13),'');
	SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, ie_tipo_linha_w) INTO STRICT ds_conteudo_aux_w, ie_tipo_linha_w;
	if (ie_tipo_linha_w = '1') then -- Lote
		begin
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nr_seq_lote_ant_w) INTO STRICT ds_conteudo_aux_w, nr_seq_lote_ant_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_cooperativa_destino_w) INTO STRICT ds_conteudo_aux_w, cd_cooperativa_destino_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_cooperativa_origem_w) INTO STRICT ds_conteudo_aux_w, cd_cooperativa_origem_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, dt_referencia_w) INTO STRICT ds_conteudo_aux_w, dt_referencia_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, dt_geracao_lote_w) INTO STRICT ds_conteudo_aux_w, dt_geracao_lote_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, ie_tipo_movimento_w) INTO STRICT ds_conteudo_aux_w, ie_tipo_movimento_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, dt_movimento_inicial_w) INTO STRICT ds_conteudo_aux_w, dt_movimento_inicial_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, dt_movimento_final_w) INTO STRICT ds_conteudo_aux_w, dt_movimento_final_w;
		
		nr_seq_congenere_destino_w	:= obter_seq_congenere(cd_cooperativa_destino_w);
		nr_seq_congenere_origem_w	:= obter_seq_congenere(cd_cooperativa_origem_w);
		
		insert	into	pls_mov_benef_lote(	nr_sequencia, nr_seq_regra, cd_estabelecimento,
				dt_referencia, ie_tipo_movimento, dt_atualizacao, 
				nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, 
				dt_movimento_inicial, dt_movimento_final, dt_geracao_lote, 
				ie_tipo_lote, nr_seq_congenere_origem, nr_seq_congenere_destino)
			values (	nr_seq_lote_p, null, cd_estabelecimento_p, 
				clock_timestamp(), 'M', clock_timestamp(), 
				nm_usuario_p, clock_timestamp(), nm_usuario_p,
				to_date(dt_movimento_inicial_w,'ddmmYYYY'), to_date(dt_movimento_final_w,'ddmmYYYY'),clock_timestamp(),
				'R', nr_seq_congenere_origem_w, nr_seq_congenere_destino_w);
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1091531, 'DS_TIPO_REGISTRO='||wheb_mensagem_pck.get_texto(1091532)||';NR_LINHA='||r_c01_w.nr_linha);
		end;
	elsif (ie_tipo_linha_w = '2') then -- Contrato
		begin
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_cnpj_w) INTO STRICT ds_conteudo_aux_w, cd_cnpj_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nr_contrato_w) INTO STRICT ds_conteudo_aux_w, nr_contrato_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_empresa_w) INTO STRICT ds_conteudo_aux_w, cd_empresa_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, dt_contrato_w) INTO STRICT ds_conteudo_aux_w, dt_contrato_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, dt_rescisao_contrato_w) INTO STRICT ds_conteudo_aux_w, dt_rescisao_contrato_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, ds_razao_social_w) INTO STRICT ds_conteudo_aux_w, ds_razao_social_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nm_fantasia_w) INTO STRICT ds_conteudo_aux_w, nm_fantasia_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nr_inscricao_estadual_w) INTO STRICT ds_conteudo_aux_w, nr_inscricao_estadual_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nr_inscricao_municipal_w) INTO STRICT ds_conteudo_aux_w, nr_inscricao_municipal_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_municipio_ibge_w) INTO STRICT ds_conteudo_aux_w, cd_municipio_ibge_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_tipo_logradouro_w) INTO STRICT ds_conteudo_aux_w, cd_tipo_logradouro_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_cep_w) INTO STRICT ds_conteudo_aux_w, cd_cep_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, ds_endereco_w) INTO STRICT ds_conteudo_aux_w, ds_endereco_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nr_endereco_contrato_w) INTO STRICT ds_conteudo_aux_w, nr_endereco_contrato_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, ds_complemento_w) INTO STRICT ds_conteudo_aux_w, ds_complemento_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, ds_bairro_w) INTO STRICT ds_conteudo_aux_w, ds_bairro_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, sg_estado_w) INTO STRICT ds_conteudo_aux_w, sg_estado_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nm_pessoa_contato_w) INTO STRICT ds_conteudo_aux_w, nm_pessoa_contato_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nr_ddi_telefone_w) INTO STRICT ds_conteudo_aux_w, nr_ddi_telefone_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nr_ddd_telefone_w) INTO STRICT ds_conteudo_aux_w, nr_ddd_telefone_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nr_telefone_w) INTO STRICT ds_conteudo_aux_w, nr_telefone_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, ds_email_w) INTO STRICT ds_conteudo_aux_w, ds_email_w;
		
		insert	into	pls_mov_benef_contrato(	nr_sequencia, dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
				nm_usuario_nrec, nr_seq_contrato, nr_seq_intercambio, nr_seq_mov_operadora,
				cd_cnpj, ds_razao_social, nm_fantasia, ds_nome_abrev,
				nr_inscricao_estadual, nr_inscricao_municipal, cd_municipio_ibge, cd_cep, ds_endereco,
				nr_endereco, ds_bairro, ds_complemento, sg_estado, nr_ddi_telefone,
				nr_ddd_telefone, nr_telefone, ds_email, nm_pessoa_contato, cd_tipo_logradouro,
				nr_contrato, dt_contrato, dt_rescisao, cd_empresa,
				ie_tipo_compartilhamento, nr_seq_lote)
			values (	nextval('pls_mov_benef_contrato_seq'), clock_timestamp(), nm_usuario_p, clock_timestamp(),
				nm_usuario_p,null, null,null,
				cd_cnpj_w, ds_razao_social_w, nm_fantasia_w,null,
				nr_inscricao_estadual_w, nr_inscricao_municipal_w, cd_municipio_ibge_w,cd_cep_w,ds_endereco_w,
				nr_endereco_contrato_w, ds_bairro_w,ds_complemento_w,sg_estado_w,nr_ddi_telefone_w,
				nr_ddd_telefone_w, nr_telefone_w, ds_email_w,nm_pessoa_contato_w,cd_tipo_logradouro_w,
				nr_contrato_w, to_date(dt_contrato_w,'ddmmYYYY'),to_date(dt_rescisao_contrato_w,'ddmmYYYY'), cd_empresa_w,
				null, nr_seq_lote_p);
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1091531, 'DS_TIPO_REGISTRO='||wheb_mensagem_pck.get_texto(1091533)||';NR_LINHA='||r_c01_w.nr_linha);
		end;
	elsif (ie_tipo_linha_w = '3') then -- Produto
		begin
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_cnpj_w) INTO STRICT ds_conteudo_aux_w, cd_cnpj_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nr_contrato_w) INTO STRICT ds_conteudo_aux_w, nr_contrato_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_empresa_w) INTO STRICT ds_conteudo_aux_w, cd_empresa_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_plano_origem_w) INTO STRICT ds_conteudo_aux_w, cd_plano_origem_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, ds_plano_origem_w) INTO STRICT ds_conteudo_aux_w, ds_plano_origem_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_plano_intercambio_w) INTO STRICT ds_conteudo_aux_w, cd_plano_intercambio_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nr_protocolo_ans_w) INTO STRICT ds_conteudo_aux_w, nr_protocolo_ans_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_operadora_ans_w) INTO STRICT ds_conteudo_aux_w, cd_operadora_ans_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, ie_abrangencia_w) INTO STRICT ds_conteudo_aux_w, ie_abrangencia_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, ie_regulamentacao_w) INTO STRICT ds_conteudo_aux_w, ie_regulamentacao_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, ie_tipo_contratacao_w) INTO STRICT ds_conteudo_aux_w, ie_tipo_contratacao_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_segmentacao_w) INTO STRICT ds_conteudo_aux_w, cd_segmentacao_w;
		
		insert	into	pls_mov_benef_plano(	nr_sequencia, dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
				nm_usuario_nrec, nr_seq_lote, nr_seq_mov_contrato, cd_plano_intercambio, 
				cd_plano_origem, ds_plano_origem, nr_protocolo_ans, cd_operadora_ans, 
				cd_segmentacao, ie_tipo_contratacao, ie_regulamentacao, ie_abrangencia)
			values (	nextval('pls_mov_benef_plano_seq'), clock_timestamp(), nm_usuario_p, clock_timestamp(), 
				nm_usuario_p, nr_seq_lote_p, null, cd_plano_intercambio_w,
				cd_plano_origem_w, ds_plano_origem_w, nr_protocolo_ans_w, cd_operadora_ans_w,
				cd_segmentacao_w, ie_tipo_contratacao_w, ie_regulamentacao_w, ie_abrangencia_w);
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1091531, 'DS_TIPO_REGISTRO='||wheb_mensagem_pck.get_texto(1091534)||';NR_LINHA='||r_c01_w.nr_linha);
		end;
	elsif (ie_tipo_linha_w = '4') then --Beneficiário
		begin
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_cnpj_w) INTO STRICT ds_conteudo_aux_w, cd_cnpj_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nr_contrato_w) INTO STRICT ds_conteudo_aux_w, nr_contrato_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_empresa_w) INTO STRICT ds_conteudo_aux_w, cd_empresa_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_usuario_plano_w) INTO STRICT ds_conteudo_aux_w, cd_usuario_plano_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, dt_validade_carteira_w) INTO STRICT ds_conteudo_aux_w, dt_validade_carteira_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nr_via_carteira_w) INTO STRICT ds_conteudo_aux_w, nr_via_carteira_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nm_beneficiario_w) INTO STRICT ds_conteudo_aux_w, nm_beneficiario_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nm_abreviado_w) INTO STRICT ds_conteudo_aux_w, nm_abreviado_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nm_social_w) INTO STRICT ds_conteudo_aux_w, nm_social_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nm_social_abreviado_w) INTO STRICT ds_conteudo_aux_w, nm_social_abreviado_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_plano_intercambio_w) INTO STRICT ds_conteudo_aux_w, cd_plano_intercambio_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_plano_origem_w) INTO STRICT ds_conteudo_aux_w, cd_plano_origem_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, dt_nascimento_w) INTO STRICT ds_conteudo_aux_w, dt_nascimento_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, ie_sexo_w) INTO STRICT ds_conteudo_aux_w, ie_sexo_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nr_cpf_w) INTO STRICT ds_conteudo_aux_w, nr_cpf_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nr_identidade_w) INTO STRICT ds_conteudo_aux_w, nr_identidade_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, ds_orgao_emissor_ci_w) INTO STRICT ds_conteudo_aux_w, ds_orgao_emissor_ci_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, sg_emissora_ci_w) INTO STRICT ds_conteudo_aux_w, sg_emissora_ci_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, ie_estado_civil_w) INTO STRICT ds_conteudo_aux_w, ie_estado_civil_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nm_mae_w) INTO STRICT ds_conteudo_aux_w, nm_mae_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nr_pis_pasep_w) INTO STRICT ds_conteudo_aux_w, nr_pis_pasep_w;	
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nr_cartao_nac_sus_w) INTO STRICT ds_conteudo_aux_w, nr_cartao_nac_sus_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_familia_w) INTO STRICT ds_conteudo_aux_w, cd_familia_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_matricula_estipulante_w) INTO STRICT ds_conteudo_aux_w, cd_matricula_estipulante_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, ie_nascido_plano_w) INTO STRICT ds_conteudo_aux_w, ie_nascido_plano_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_dependencia_w) INTO STRICT ds_conteudo_aux_w, cd_dependencia_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_titular_w) INTO STRICT ds_conteudo_aux_w, cd_titular_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, dt_inclusao_operadora_w) INTO STRICT ds_conteudo_aux_w, dt_inclusao_operadora_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, dt_contratacao_w) INTO STRICT ds_conteudo_aux_w, dt_contratacao_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, dt_rescisao_benef_w) INTO STRICT ds_conteudo_aux_w, dt_rescisao_benef_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_motivo_rescisao_w) INTO STRICT ds_conteudo_aux_w, cd_motivo_rescisao_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, dt_compartilhamento_w) INTO STRICT ds_conteudo_aux_w, dt_compartilhamento_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, dt_fim_compartilhamento_w) INTO STRICT ds_conteudo_aux_w, dt_fim_compartilhamento_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, ie_tipo_repasse_w) INTO STRICT ds_conteudo_aux_w, ie_tipo_repasse_w;
		
		if (nr_contrato_w IS NOT NULL AND nr_contrato_w::text <> '') then		
			select	max(nr_sequencia)
			into STRICT	nr_seq_mov_contrato_w
			from	pls_mov_benef_contrato
			where	nr_seq_lote = nr_seq_lote_p
			and	nr_contrato = nr_contrato_w;
			
			select	max(nr_sequencia)
			into STRICT	nr_seq_intercambio_w
			from	pls_intercambio
			where	nr_contrato_origem = nr_contrato_w;
		end if;			

		insert	into	pls_mov_benef_segurado(nr_sequencia, nr_seq_lote, dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
				nm_usuario_nrec, nr_seq_segurado, nr_seq_mov_contrato, nr_seq_mov_operadora, nr_contrato,
				cd_usuario_plano, dt_validade_carteira, nr_via_carteira, nm_beneficiario, nm_abreviado,
				nm_social, nm_social_abreviado, dt_nascimento, ie_sexo, nr_cpf,
				nr_identidade, ds_orgao_emissor_ci, sg_emissora_ci, ie_estado_civil, nm_mae,
				nr_pis_pasep, nr_cartao_nac_sus, cd_plano_intercambio, cd_familia, cd_matricula_estipulante,
				ie_nascido_plano, cd_dependencia, cd_titular, dt_contratacao, dt_inclusao_operadora,
				dt_rescisao, cd_motivo_rescisao, dt_compartilhamento, dt_fim_compartilhamento, cd_plano_origem,
				ie_tipo_repasse,nr_seq_intercambio)
			values (	nextval('pls_mov_benef_segurado_seq'), nr_seq_lote_p,clock_timestamp(), nm_usuario_p,clock_timestamp(),
				nm_usuario_p, null, nr_seq_mov_contrato_w, null, nr_contrato_w,
				cd_usuario_plano_w, to_date(dt_validade_carteira_w,'ddmmYYYY'), nr_via_carteira_w, nm_beneficiario_w, nm_abreviado_w,
				nm_social_w, nm_social_abreviado_w, to_date(dt_nascimento_w,'ddmmyyyy'), ie_sexo_w, nr_cpf_w,
				nr_identidade_w, ds_orgao_emissor_ci_w, sg_emissora_ci_w, ie_estado_civil_w, nm_mae_w,
				nr_pis_pasep_w, nr_cartao_nac_sus_w, cd_plano_intercambio_w, cd_familia_w, cd_matricula_estipulante_w, 
				ie_nascido_plano_w, cd_dependencia_w, cd_titular_w, to_date(dt_contratacao_w,'ddmmYYYY'), to_date(dt_inclusao_operadora_w,'ddmmYYYY'),
				to_date(dt_rescisao_benef_w,'ddmmYYYY'), cd_motivo_rescisao_w, to_date(dt_compartilhamento_w,'ddmmYYYY'), to_date(dt_fim_compartilhamento_w,'ddmmYYYY'), cd_plano_origem_w,
				ie_tipo_repasse_w,nr_seq_intercambio_w);
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1091531, 'DS_TIPO_REGISTRO='||wheb_mensagem_pck.get_texto(1091535)||';NR_LINHA='||r_c01_w.nr_linha);
		end;
	elsif (ie_tipo_linha_w = '5') then --Complemento
		begin
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_usuario_plano_w) INTO STRICT ds_conteudo_aux_w, cd_usuario_plano_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, ie_tipo_complemento_w) INTO STRICT ds_conteudo_aux_w, ie_tipo_complemento_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_cep_w) INTO STRICT ds_conteudo_aux_w, cd_cep_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, ds_endereco_w) INTO STRICT ds_conteudo_aux_w, ds_endereco_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nr_endereco_benef_w) INTO STRICT ds_conteudo_aux_w, nr_endereco_benef_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, ds_complemento_w) INTO STRICT ds_conteudo_aux_w, ds_complemento_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, ds_bairro_w) INTO STRICT ds_conteudo_aux_w, ds_bairro_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_municipio_ibge_w) INTO STRICT ds_conteudo_aux_w, cd_municipio_ibge_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, sg_estado_w) INTO STRICT ds_conteudo_aux_w, sg_estado_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_tipo_logradouro_w) INTO STRICT ds_conteudo_aux_w, cd_tipo_logradouro_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nr_ddi_telefone_w) INTO STRICT ds_conteudo_aux_w, nr_ddi_telefone_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nr_ddd_telefone_w) INTO STRICT ds_conteudo_aux_w, nr_ddd_telefone_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, nr_telefone_w) INTO STRICT ds_conteudo_aux_w, nr_telefone_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, ds_email_w) INTO STRICT ds_conteudo_aux_w, ds_email_w;
		nr_seq_mov_segurado_w	:= obter_seq_mov_segurado(nr_seq_lote_p,cd_usuario_plano_w);
		
		insert	into	pls_mov_benef_seg_compl(	nr_sequencia, nr_seq_mov_segurado, ie_tipo_complemento, dt_atualizacao, nm_usuario,
				dt_atualizacao_nrec, nm_usuario_nrec, cd_cep, ds_endereco, nr_endereco,
				ds_complemento, ds_bairro, cd_municipio_ibge, sg_estado, cd_tipo_logradouro,
				nr_ddi_telefone, nr_ddd_telefone, nr_telefone, ds_email)
			values (	nextval('pls_mov_benef_seg_compl_seq'), nr_seq_mov_segurado_w, ie_tipo_complemento_w, clock_timestamp(), nm_usuario_p,
				clock_timestamp(), nm_usuario_p, cd_cep_w, ds_endereco_w, nr_endereco_benef_w,
				ds_complemento_w,ds_bairro_w,cd_municipio_ibge_w,sg_estado_w,cd_tipo_logradouro_w,
				nr_ddi_telefone_w, nr_ddd_telefone_w, nr_telefone_w, ds_email_w);
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1091531, 'DS_TIPO_REGISTRO='||wheb_mensagem_pck.get_texto(1091536)||';NR_LINHA='||r_c01_w.nr_linha);
		end;
	elsif (ie_tipo_linha_w = '6') then --Carência
		begin
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_usuario_plano_w) INTO STRICT ds_conteudo_aux_w, cd_usuario_plano_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_tipo_cobertura_w) INTO STRICT ds_conteudo_aux_w, cd_tipo_cobertura_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, dt_fim_carencia_w) INTO STRICT ds_conteudo_aux_w, dt_fim_carencia_w;
		nr_seq_mov_segurado_w	:= obter_seq_mov_segurado(nr_seq_lote_p,cd_usuario_plano_w);
		
		insert	into	pls_mov_benef_seg_carencia(	nr_sequencia, nr_seq_mov_segurado, cd_tipo_cobertura, dt_fim_carencia,
				dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec)
			values (	nextval('pls_mov_benef_seg_carencia_seq'),nr_seq_mov_segurado_w, cd_tipo_cobertura_w, to_date(dt_fim_carencia_w,'ddmmyyyy'),
				clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p);
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1091531, 'DS_TIPO_REGISTRO='||wheb_mensagem_pck.get_texto(1091537)||';NR_LINHA='||r_c01_w.nr_linha);
		end;
	elsif (ie_tipo_linha_w = '7') then --SCA
		begin
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_usuario_plano_w) INTO STRICT ds_conteudo_aux_w, cd_usuario_plano_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, cd_tipo_produto_w) INTO STRICT ds_conteudo_aux_w, cd_tipo_produto_w;
		SELECT * FROM pls_busca_prox_reg_sep(ds_conteudo_aux_w, ';', ds_conteudo_aux_w, ds_produto_w) INTO STRICT ds_conteudo_aux_w, ds_produto_w;
		nr_seq_mov_segurado_w	:= obter_seq_mov_segurado(nr_seq_lote_p,cd_usuario_plano_w);

		insert	into	pls_mov_benef_seg_sca(	nr_sequencia, nr_seq_mov_segurado, cd_tipo_produto,
				dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
				nm_usuario_nrec, ds_produto)
			values (	nextval('pls_mov_benef_seg_sca_seq'), nr_seq_mov_segurado_w, cd_tipo_produto_w,
				clock_timestamp(), nm_usuario_p, clock_timestamp(), 
				nm_usuario_p,ds_produto_w);
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1091531, 'DS_TIPO_REGISTRO='||wheb_mensagem_pck.get_texto(1091538)||';NR_LINHA='||r_c01_w.nr_linha);
		end;
	end if;
	end;
end loop;

CALL pls_mov_benef_imp_pck.alterar_status_lote(nr_seq_lote_p,'I',nm_usuario_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_importar_mov_benef ( nr_seq_lote_p pls_mov_benef_lote.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) is ie_tipo_linha_w varchar(10) FROM PUBLIC;

