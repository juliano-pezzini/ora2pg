-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_atualizar_saldo_empenho ( cd_estabelecimento_p bigint, dt_referencia_p timestamp, cd_centro_custo_p bigint, cd_conta_contabil_p text, nm_usuario_p text) AS $body$
DECLARE


cd_empresa_w				bigint;
dt_referencia_w				timestamp;
ie_empenho_orcamento_w			varchar(15);
nr_seq_mes_ref_w				bigint;
qt_registro_w				bigint;
vl_empenho_w				double precision;


BEGIN

select	coalesce(max(ie_empenho_orcamento),'N')
into STRICT	ie_empenho_orcamento_w
from	parametro_estoque
where	cd_estabelecimento	= cd_estabelecimento_p;

if (ie_empenho_orcamento_w = 'S') then
	begin

	cd_empresa_w	:= obter_empresa_estab(cd_estabelecimento_p);
	dt_referencia_w	:= PKG_DATE_UTILS.start_of(dt_referencia_p, 'month', 0);

	select	coalesce(sum(vl_empenho),0)
	into STRICT	vl_empenho_w
	from	ctb_orc_doc_empenho
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	dt_referencia		= dt_referencia_w
	and	cd_centro_custo		= cd_centro_custo_p
	and	cd_conta_contabil	= cd_conta_contabil_p;

	select	max(nr_sequencia)
	into STRICT	nr_seq_mes_ref_w
	from	ctb_mes_ref
	where	cd_empresa	= cd_empresa_w
	and	dt_referencia	= dt_referencia_w;

	select	count(*)
	into STRICT	qt_registro_w
	from	ctb_orcamento
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	nr_seq_mes_ref		= nr_seq_mes_ref_w
	and	cd_centro_custo		= cd_centro_custo_p
	and	cd_conta_contabil	= cd_conta_contabil_p;

	if (qt_registro_w > 0) then
		begin
		update	ctb_orcamento
		set	vl_empenho		= vl_empenho_w
		where	cd_estabelecimento	= cd_estabelecimento_p
		and	nr_seq_mes_ref		= nr_seq_mes_ref_w
		and	cd_centro_custo		= cd_centro_custo_p
		and	cd_conta_contabil	= cd_conta_contabil_p;
		exception when others then
			vl_empenho_w	:= 0;
		end;
	elsif (vl_empenho_w > 0) then
		begin
		CALL wheb_usuario_pck.set_ie_executar_trigger('N');
		insert into ctb_orcamento(
			nr_sequencia,
			nr_seq_mes_ref,
			dt_atualizacao,
			nm_usuario,
			cd_estabelecimento,
			cd_conta_contabil,
			cd_centro_custo,
			vl_original,
			vl_orcado,
			vl_realizado,
			vl_empenho,
			ie_cenario,
			ie_origem_orc)
		values (nextval('ctb_orcamento_seq'),
			nr_seq_mes_ref_w,
			clock_timestamp(),
			nm_usuario_p,
			cd_estabelecimento_p,
			cd_conta_contabil_p,
			cd_centro_custo_p,
			0,
			0,
			0,
			vl_empenho_w,
			'N',
			'SIS');
			CALL wheb_usuario_pck.set_ie_executar_trigger('S');
		exception when others then
			vl_empenho_w	:= 0;
			CALL wheb_usuario_pck.set_ie_executar_trigger('S');
		end;
	end if;




	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_atualizar_saldo_empenho ( cd_estabelecimento_p bigint, dt_referencia_p timestamp, cd_centro_custo_p bigint, cd_conta_contabil_p text, nm_usuario_p text) FROM PUBLIC;

