-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_custo_reposicao ( cd_estabelecimento_p bigint, dt_referencia_p timestamp, nm_usuario_p text) AS $body$
DECLARE


CD_MATERIAL_w			integer;
vl_custo_medio_w		double precision;


dt_atualizacao_w		timestamp;
ds_erro_w			varchar(2000);

c01 CURSOR FOR
SELECT	C.CD_MATERIAL_ESTOQUE,
	CASE WHEN C.QT_ITEM_ESTOQUE=0 THEN 0  ELSE coalesce(c.vl_liquido,0) / C.QT_ITEM_ESTOQUE END
FROM 	NOTA_FISCAL_ITEM C,
	NOTA_FISCAL B
WHERE (B.nr_sequencia			= C.nr_sequencia )
AND (b.DT_ATUALIZACAO_ESTOQUE IS NOT NULL AND b.DT_ATUALIZACAO_ESTOQUE::text <> '')
AND (b.dt_entrada_saida between dt_atualizacao_w and PKG_DATE_UTILS.ADD_MONTH(dt_atualizacao_w,1,0) - 1/86400)
AND (b.cd_estabelecimento		= cd_estabelecimento_p)
and (coalesce(C.QT_ITEM_ESTOQUE,0)	> 0)
order by b.dt_entrada_saida;


BEGIN
dt_atualizacao_w			:= PKG_DATE_UTILS.start_of(dt_referencia_p,'month',0);
OPEN C01;
LOOP
	FETCH C01 into
		 CD_MATERIAL_w,
		 vl_custo_medio_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		insert into	custo_mensal_material(cd_estabelecimento, dt_referencia, cd_material,
			ie_tipo_custo, dt_atualizacao, nm_usuario, vl_custo)
		values (cd_estabelecimento_p, dt_atualizacao_w,
			cd_material_w, 'R', clock_timestamp(), nm_usuario_p, vl_custo_medio_w);
		exception
			when unique_violation then
				update	custo_mensal_material
				set	vl_custo		= vl_custo_medio_w
				where	cd_estabelecimento	= cd_estabelecimento_p
				and	dt_referencia		= dt_atualizacao_w
				and	cd_material		= cd_material_w
				and	ie_tipo_custo		= 'R';
			when others then
				ds_erro_w	:= SQLERRM(SQLSTATE);
				CALL wheb_mensagem_pck.exibir_mensagem_abort(265569,'DS_ERRO=' || ds_erro_w);
				--'Erro Inclus√£o ' || chr(10) || ds_erro_w);
		end;
END LOOP;
close C01;
commit;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_custo_reposicao ( cd_estabelecimento_p bigint, dt_referencia_p timestamp, nm_usuario_p text) FROM PUBLIC;

