-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_dados_pac_obito (dt_liberacao_p timestamp, dt_liberacao_old_p timestamp, nm_usuario_p text, nr_atendimento_p bigint, dt_obito_p timestamp, dt_obito_old_p timestamp, cd_cid_direta_p text, ie_rn_p text) AS $body$
DECLARE


cd_pessoa_fisica_w		varchar(10);
ie_atualiza_cid_morte_aih_w	varchar(10) := 'N';
dt_emissao_w			timestamp;
qt_registro_w			bigint;
nr_aih_w			bigint;
nr_seq_aih_w			bigint;


BEGIN

if (dt_liberacao_p IS NOT NULL AND dt_liberacao_p::text <> '') and (coalesce(dt_liberacao_old_p::text, '') = '') then
	
  ie_atualiza_cid_morte_aih_w := coalesce(obter_valor_param_usuario(1123, 212, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento),'N');

	select	cd_pessoa_fisica
	into STRICT	cd_pessoa_fisica_w
	from	atendimento_paciente
	where	nr_atendimento	= nr_atendimento_p;

	if (dt_obito_p IS NOT NULL AND dt_obito_p::text <> '') and (ie_rn_p <> 'S') then

		update	pessoa_fisica
		set	dt_obito		= dt_obito_p,
			nm_usuario		= nm_usuario_p
		where	cd_pessoa_fisica	= cd_pessoa_fisica_w
		and	coalesce(dt_obito::text, '') = '';	
	
	end if;

	if (ie_atualiza_cid_morte_aih_w = 'S') and (coalesce(cd_cid_direta_p,'X') <> 'X') then
		begin
		
		begin
		
		select	max(a.nr_aih),
				max(a.nr_sequencia)
		into STRICT	nr_aih_w,
			nr_seq_aih_w
		from	sus_aih_unif a
		where	a.nr_atendimento 	= nr_atendimento_p
		and	a.dt_emissao 	= (	SELECT	max(b.dt_emissao)
						from	sus_aih_unif b
						where	b.nr_atendimento = nr_atendimento_p);
		exception
		when no_data_found then
			nr_aih_w	:= null;
			nr_seq_aih_w	:= null;
		end;
		
	
		if (nr_aih_w IS NOT NULL AND nr_aih_w::text <> '') and (nr_seq_aih_w IS NOT NULL AND nr_seq_aih_w::text <> '') then
			begin
			
			update	sus_aih_unif
			set	cd_cid_causa_morte = cd_cid_direta_p
			where	nr_atendimento = nr_atendimento_p
			and	nr_aih = nr_aih_w
			and	nr_sequencia = nr_seq_aih_w;
			
			end;
		end if;
		
		end;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_dados_pac_obito (dt_liberacao_p timestamp, dt_liberacao_old_p timestamp, nm_usuario_p text, nr_atendimento_p bigint, dt_obito_p timestamp, dt_obito_old_p timestamp, cd_cid_direta_p text, ie_rn_p text) FROM PUBLIC;

