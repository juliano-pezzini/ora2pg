-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_liberar_produto ( nr_seq_produto_p bigint, nm_usuario_p text) AS $body$
DECLARE

				 
ds_inconsistencia_w		varchar(2000);
qt_registro_w			integer	:= 0;
qt_rede_exclusivas_w		integer;
qt_prestadores_w		integer;
qt_com_tabela_w			bigint := 0;
ie_preco_w			varchar(5);
ie_tipo_operacao_w		varchar(10);
cd_estabelecimento_w		bigint;
ie_att_rede_referenciada_w	varchar(1);


BEGIN 
 /* Alex 02/03/2010 OS - 196038 - Verificar se possui uma rede exclusiva */
 
 
ie_att_rede_referenciada_w	:= coalesce(obter_valor_param_usuario(1201, 29, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_w), 'S');
 
select	count(*) 
into STRICT	qt_rede_exclusivas_w 
from	pls_plano 
where	nr_sequencia = nr_seq_produto_p 
and	ie_rede_exclusiva = 'S';
 
if (qt_rede_exclusivas_w > 0) then	 
	select	count(*) 
	into STRICT	qt_prestadores_w 
	from	pls_prestador_plano 
	where	nr_seq_plano	= nr_seq_produto_p 
	and	ie_situacao	= 'A';
	if (coalesce(qt_prestadores_w,0) = 0) then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(262383);
		/* Mensagem: Produto com rede exclusiva necessita ter um prestador cadastrado! Verifique a pasta "Produtos" na função OPS - Prestadores. */
 
	end if;
end if;
 
begin 
select	ie_tipo_operacao 
into STRICT	ie_tipo_operacao_w 
from	pls_plano 
where	nr_sequencia	= nr_seq_produto_p;
exception 
when others then 
	ie_tipo_operacao_w	:= 'B';
end;
 
if (ie_tipo_operacao_w <> 'A') then 
	/* Consistir o produto */
 
	ds_inconsistencia_w := pls_consiste_produto(nr_seq_produto_p, ds_inconsistencia_w);
 
	select	count(*) 
	into STRICT	qt_registro_w 
	from	pls_inconsistencia 
	where	obter_Se_contido(cd_inconsistencia, ds_inconsistencia_w)	= 'S' 
	and	ie_situacao		= 'A' 
	and	ie_liberar_produto	= 'N';
 
	if (qt_registro_w	> 0) then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(262384);
		/* Mensagem: Produto inconsistente, favor verificar. O processo foi cancelado! */
		 
	end if;
end if;
 
begin 
select	ie_preco 
into STRICT	ie_preco_w 
from	pls_plano 
where	nr_sequencia	= nr_seq_produto_p 
and	ie_tipo_operacao	in ('A','B');
exception 
when others then 
	ie_preco_w	:= '2';
end;
 
if (ie_preco_w = '1') then 
	select	count(*) 
	into STRICT	qt_com_tabela_w 
	from	pls_tabela_preco 
	where	nr_seq_plano	= nr_seq_produto_p;
 
	if (qt_com_tabela_w = 0) then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(262386);
		/* Mensagem: Produto sem tabela de preço vinculada! Favor verificar. */
		 
	end if;
end if;
 
select	cd_estabelecimento 
into STRICT	cd_estabelecimento_w 
from	pls_plano 
where	nr_sequencia = nr_seq_produto_p;
	 
/*aaschlote 17/01/2012 - OS - 400818*/
 
if (ie_att_rede_referenciada_w = 'S') then 
	CALL pls_ajustar_rede_referencias(nr_seq_produto_p,cd_estabelecimento_w,nm_usuario_p);
end if;
	 
update	pls_plano 
set	dt_liberacao	= clock_timestamp(), 
	nm_usuario	= nm_usuario_p, 
	dt_atualizacao	= clock_timestamp() 
where	nr_sequencia	= nr_seq_produto_p;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_liberar_produto ( nr_seq_produto_p bigint, nm_usuario_p text) FROM PUBLIC;

