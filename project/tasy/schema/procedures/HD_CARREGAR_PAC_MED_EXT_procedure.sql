-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hd_carregar_pac_med_ext (nr_seq_entrega_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


cd_pessoa_fisica_w	varchar(10);
cd_material_w		bigint;

c01 CURSOR FOR
	SELECT	a.cd_pessoa_fisica
	from    	hd_pac_renal_cronico a,
		medic_uso_continuo b
	where   	a.cd_pessoa_fisica = b.cd_pessoa_fisica
	and	hd_obter_se_mostra_unidade(hd_obter_unidade_prc(a.cd_pessoa_fisica,'C'), nm_usuario_p) = 'S'
	and	substr(hd_obter_se_paciente_ativo(a.cd_pessoa_fisica),1,1) = 'S'
	AND	b.cd_material = cd_material_w
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	not exists ( SELECT 1
			from	hd_lote_paciente x
			where	x.nr_seq_entrega = nr_seq_entrega_p
			and	x.cd_pessoa_fisica = a.cd_pessoa_fisica)
	AND	(hd_obter_unidade_prc(a.cd_pessoa_fisica,'C') =  (SELECT 	max(y.nr_seq_unidade)
							FROM 	hd_parametro y
							WHERE 	y.cd_estabelecimento = cd_estabelecimento_p))
	AND	EXISTS (	SELECT	1
			FROM	paciente_tratamento z
			WHERE	a.cd_pessoa_fisica = z.cd_pessoa_fisica)
	order by 1;


BEGIN


select	max(b.cd_material)
into STRICT	cd_material_w
from	hd_entrega_medic a,
	hd_medic_externo b
where	a.nr_seq_medic = b.nr_sequencia
and	a.nr_sequencia = nr_seq_entrega_p;

open C01;
loop
fetch C01 into
	cd_pessoa_fisica_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	insert into hd_lote_paciente(	nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				cd_pessoa_fisica,
				qt_material,
				nr_seq_entrega)
			values (nextval('hd_lote_paciente_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				cd_pessoa_fisica_w,
				0,
				nr_seq_entrega_p);

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hd_carregar_pac_med_ext (nr_seq_entrega_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

