-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE nut_gerar_w_nutricao_setores (dt_referencia_p timestamp, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE



ie_setores_internacao_w			varchar(1);
dt_referencia_w				timestamp;
ds_comando_w				varchar(32767);
C01					integer;
ds_sql_where_w				varchar(32767);
cd_setor_atendimento_w			integer;
nr_atendimento_w			bigint;
ds_filtros_me_w				varchar(32767);
retorno_w				bigint;


BEGIN

CALL exec_sql_dinamico(nm_usuario_p,'truncate table w_nutricao_setores');

dt_referencia_w		:= trunc(dt_referencia_p);

/*Par√¢metros*/

ie_setores_internacao_w := coalesce(obter_valor_param_usuario(1003, 51, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p),'N');
/*--------------*/

if (dt_referencia_p IS NOT NULL AND dt_referencia_p::text <> '') then

	--Comando SQL
	ds_comando_w :=
		'SELECT c.cd_setor_atendimento,
			b.nr_atendimento
		FROM   	atendimento_paciente b,
			unidade_atendimento a,
			setor_atendimento c,
			pessoa_fisica d,
			pessoa_fisica e
		WHERE  	a.nr_atendimento = b.nr_atendimento
		and	a.cd_setor_Atendimento = c.cd_setor_atendimento
		and	b.cd_pessoa_fisica = d.cd_pessoa_fisica
		and	b.cd_medico_resp = e.cd_pessoa_fisica
		AND	b.cd_estabelecimento = :cd_estabelecimento
		AND	a.ie_status_unidade IN ('||chr(39)||'R'||chr(39)||','||chr(39)||'L'||chr(39)||','||chr(39)||'H'||chr(39)||','||chr(39)||'G'||chr(39)||','||chr(39)||'A'||chr(39)||','||chr(39)||'O'||chr(39)||','||chr(39)||'E'||chr(39)||','||chr(39)||'C'||chr(39)||','||chr(39)||'P'||chr(39)||','||chr(39)||'M'||chr(39)||','||chr(39)||'I'||chr(39)||','||chr(39)||'S'||chr(39)||')
		';

	ds_comando_w := ds_comando_w ||chr(10)||ds_sql_where_w||chr(10)||ds_filtros_me_w;

	if (ie_setores_internacao_w = 'S')  then

		ds_comando_w	:= ds_comando_w ||chr(10)||
		'union
		SELECT	c.cd_setor_atendimento,
			b.nr_atendimento
		FROM	atendimento_paciente b,
			pessoa_fisica d,
			pessoa_fisica e,
			setor_atendimento c
		WHERE	d.cd_pessoa_fisica = b.cd_pessoa_fisica
		AND	e.cd_pessoa_fisica     = b.cd_medico_resp
		and	b.cd_estabelecimento   = :cd_estabelecimento
		AND   	b.dt_alta IS NULL
		AND	c.cd_setor_atendimento = (	select	max(x.cd_setor_atendimento)
							from	atend_paciente_unidade x
							where	x.nr_atendimento = b.nr_atendimento
							and	x.nr_seq_interno = ( 	select	nvl(max(y.nr_seq_interno),0)
											from 	atend_paciente_unidade y
											where	y.nr_atendimento = x.nr_atendimento
											and 	nvl(y.dt_saida_unidade, y.dt_entrada_unidade + 9999) = (select	max(nvl(z.dt_saida_unidade, z.dt_entrada_unidade + 9999))
																			from   	atend_paciente_unidade z
																			where  	z.nr_atendimento = y.nr_atendimento)))
		AND	NVL(c.ie_mostra_gestao_nutricao, '||chr(39)||'S'||chr(39)||') = '||chr(39)||'S'||chr(39)||'
		AND	NOT EXISTS (	SELECT  1
					FROM 	unidade_atendimento c
					WHERE	c.nr_atendimento     = b.nr_atendimento
					AND	c.ie_status_unidade IN ('||chr(39)||'R'||chr(39)||','||chr(39)||'L'||chr(39)||','||chr(39)||'H'||chr(39)||','||chr(39)||'G'||chr(39)||','||chr(39)||'A'||chr(39)||','||chr(39)||'O'||chr(39)||','||chr(39)||'E'||chr(39)||','||chr(39)||'C'||chr(39)||','||chr(39)||'P'||chr(39)||','||chr(39)||'M'||chr(39)||','||chr(39)||'I'||chr(39)||','||chr(39)||'S'||chr(39)||')
					and	rownum = 1) ';


		ds_comando_w := ds_comando_w ||chr(10)||ds_sql_where_w||chr(10)||ds_filtros_me_w;
	end if;

	C01 := DBMS_SQL.OPEN_CURSOR;
	DBMS_SQL.PARSE(C01, ds_comando_w, dbms_sql.Native);
	DBMS_SQL.DEFINE_COLUMN(C01, 1,  cd_setor_atendimento_w);
	DBMS_SQL.DEFINE_COLUMN(C01, 2,  nr_atendimento_w);

	DBMS_SQL.BIND_VARIABLE(C01,'CD_ESTABELECIMENTO', cd_estabelecimento_p);

	if (position(':DT_REFERENCIA' in upper(ds_comando_w)) > 0) then
		DBMS_SQL.BIND_VARIABLE(C01,'DT_REFERENCIA', dt_referencia_w);
	end if;

	retorno_w := DBMS_SQL.execute(C01);

	while( DBMS_SQL.FETCH_ROWS(C01) > 0 ) loop
		begin

		cd_setor_atendimento_w	:= null;
		nr_atendimento_w	:= null;


		DBMS_SQL.COLUMN_VALUE(C01, 1,  cd_setor_atendimento_w);
		DBMS_SQL.COLUMN_VALUE(C01, 2,  nr_atendimento_w);


		insert	 into w_nutricao_setores(nr_sequencia,
						cd_setor_atendimento,
						nr_atendimento,
						nm_usuario)
				values (nextval('w_nutricao_setores_seq'),
						cd_setor_atendimento_w,
						nr_atendimento_w,
						nm_usuario_p);

		end;
	end loop;

DBMS_SQL.CLOSE_CURSOR(C01);

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nut_gerar_w_nutricao_setores (dt_referencia_p timestamp, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

