-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inserir_receber_cam_a580 (nr_seq_fat_geral_p ptu_fatura_geral.nr_sequencia%type, ie_commit_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Insere o titulo a receber do A580 em camara de compensação
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [X] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/nr_seq_congenere_w	pls_congenere.nr_sequencia%type;
nr_titulo_receber_w	ptu_fatura_geral.nr_titulo_receber%type;
dt_ven_doc_w		ptu_fatura_geral.dt_ven_doc%type;
dt_emi_doc_w		ptu_fatura_geral.dt_emi_doc%type;
cd_uni_des_w		ptu_fatura_geral.cd_uni_des%type;
nr_seq_camara_w		pls_congenere_camara.nr_sequencia%type;
cd_estabelecimento_w	titulo_receber.cd_estabelecimento%type;
dt_postagem_w		ptu_fatura_geral.dt_postagem%type;
qt_registro_w		integer;

BEGIN

if (nr_seq_fat_geral_p IS NOT NULL AND nr_seq_fat_geral_p::text <> '') then

	-- levanta dos dados iniciais do titulo
	select	coalesce(dt_ven_doc,clock_timestamp()),
		coalesce(dt_emi_doc,clock_timestamp()),
		coalesce(dt_postagem,clock_timestamp()),
		cd_uni_des,
		nr_titulo_receber
	into STRICT	dt_ven_doc_w,
		dt_emi_doc_w,
		dt_postagem_w,
		cd_uni_des_w,
		nr_titulo_receber_w
	from	ptu_fatura_geral
	where	nr_sequencia	= nr_seq_fat_geral_p
	and	coalesce(nr_titulo_pagar::text, '') = ''; -- somente titulo a receber
	select 	count(1)
	into STRICT 	qt_registro_w
	from	pls_titulo_lote_camara
	where	nr_titulo_receber = nr_titulo_receber_w;

	if (qt_registro_w = 0) then
		-- verifica os dados do titulo
		if (coalesce(cd_estabelecimento_p::text, '') = '') then
			select	cd_estabelecimento
			into STRICT	cd_estabelecimento_w
			from	titulo_receber
			where	nr_titulo	= nr_titulo_receber_w  LIMIT 1;
		else
			cd_estabelecimento_w := cd_estabelecimento_p;
		end if;

		-- dados do congenere
		select	max(a.nr_sequencia)
		into STRICT	nr_seq_congenere_w
		from	pls_congenere a
		where	(a.cd_cooperativa)::numeric 	= (cd_uni_des_w)::numeric;

		-- se localizou um congenre na camara, busqua qual camara
		if (nr_seq_congenere_w IS NOT NULL AND nr_seq_congenere_w::text <> '') then
			select	max(a.nr_seq_camara)
			into STRICT	nr_seq_camara_w
			from	pls_congenere_camara	a
			where	a.nr_seq_congenere	= nr_seq_congenere_w
			and	dt_postagem_w between a.dt_inicio_vigencia_ref and a.dt_fim_vigencia_ref;

			-- verifica se o título já está vinculado a um lote de câmara de compensação
			if (nr_titulo_receber_w IS NOT NULL AND nr_titulo_receber_w::text <> '') then

				-- se localizou uma camara valida insere nela.
				if (nr_seq_camara_w IS NOT NULL AND nr_seq_camara_w::text <> '') then
					CALL pls_inserir_tit_camara( null, nr_titulo_receber_w, nr_seq_camara_w, dt_postagem_w, 0, cd_estabelecimento_p, nm_usuario_p);
				end if;
			end if;
		end if;
	end if;

	if (coalesce(ie_commit_p,'N') = 'S') then
		commit;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inserir_receber_cam_a580 (nr_seq_fat_geral_p ptu_fatura_geral.nr_sequencia%type, ie_commit_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

