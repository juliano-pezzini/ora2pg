-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_dados_lote_fornec ( nr_seq_lote_fornec_p bigint, ds_lote_atual_p text, dt_validade_atual_p timestamp, nm_usuario_p text, ie_indeterminado_p text) AS $body$
DECLARE

	
ds_lote_fornec_w	varchar(20);
dt_validade_w		timestamp;
dt_validade_atual_w	timestamp;
nr_sequencia_nf_w	bigint;
nr_item_nf_w		bigint;
ds_historico_w		varchar(2000);
nr_seq_mat_lote_nf_w	material_lote_fornec_nf.nr_sequencia%type;


BEGIN

select	ds_lote_fornec,
	dt_validade,
	nr_sequencia_nf,
	nr_item_nf
into STRICT	ds_lote_fornec_w,
	dt_validade_w,
	nr_sequencia_nf_w,
	nr_item_nf_w
from	material_lote_fornec
where	nr_sequencia = nr_seq_lote_fornec_p;

select	max(nr_sequencia)
into STRICT	nr_seq_mat_lote_nf_w
from	material_lote_fornec_nf
where	nr_seq_lote_fornec = nr_seq_lote_fornec_p;

if (ie_indeterminado_p = 'S') then
	dt_validade_atual_w := null;
else
	dt_validade_atual_w := dt_validade_atual_p;
end if;

update	nota_fiscal_item
set	cd_lote_fabricacao	= ds_lote_atual_p,
	dt_validade		= dt_validade_atual_w,
	ie_indeterminado	= ie_indeterminado_p
where	nr_seq_lote_fornec = nr_seq_lote_fornec_p;

update	nota_fiscal_item_lote
set	cd_lote_fabricacao	= ds_lote_atual_p,
	dt_validade		= dt_validade_atual_w,
	ie_indeterminado	= ie_indeterminado_p
where	nr_seq_lote_fornec = nr_seq_lote_fornec_p;

update	material_lote_fornec
set	ds_lote_fornec			= ds_lote_atual_p,
	dt_validade			= dt_validade_atual_w,
	ie_validade_indeterminada	= ie_indeterminado_p
where	nr_sequencia = nr_seq_lote_fornec_p;

if (nr_sequencia_nf_w > 0) or (nr_seq_mat_lote_nf_w IS NOT NULL AND nr_seq_mat_lote_nf_w::text <> '') then
	
	ds_historico_w := substr(wheb_mensagem_pck.get_texto(315093)|| ' ' || chr(13) || chr(10) ||
				wheb_mensagem_pck.get_texto(312535)|| ' ' || ds_lote_fornec_w || ' - ' || dt_validade_w || chr(13) || chr(10) ||
				wheb_mensagem_pck.get_texto(182372)|| ' ' || ds_lote_atual_p  || ' - ' || dt_validade_atual_w,1,2000);

	if (nr_sequencia_nf_w > 0) then
		insert into nota_fiscal_hist(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_nota,
			cd_evento,
			ds_historico)
		values (	nextval('nota_fiscal_hist_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_sequencia_nf_w,
			42,
			ds_historico_w);
	end if;
	
	if (nr_seq_mat_lote_nf_w IS NOT NULL AND nr_seq_mat_lote_nf_w::text <> '') then
		insert into nota_fiscal_hist(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_nota,
			cd_evento,
			ds_historico)
		SELECT	nextval('nota_fiscal_hist_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_sequencia_nf,
			42,
			ds_historico_w
		from	material_lote_fornec_nf
		where	nr_seq_lote_fornec = nr_seq_lote_fornec_p;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_dados_lote_fornec ( nr_seq_lote_fornec_p bigint, ds_lote_atual_p text, dt_validade_atual_p timestamp, nm_usuario_p text, ie_indeterminado_p text) FROM PUBLIC;

