-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_w_pls_conta_guia_pend ( ie_usa_data_p text, dt_inicio_p timestamp, dt_fim_p timestamp, ie_tipo_guia_p text, nr_seq_prestador_p bigint, ie_opcao_p text, nm_usuario_p text, cd_estabelecimento_p text, ie_alteracao_p text, nr_sequencia_p bigint, cd_procedimento_p bigint, cd_guias_p text, cd_medico_solic_p text, cd_produto_p text, nr_seq_clas_prestador_p bigint, ie_processo_p text) AS $body$
DECLARE




ie_inserir_w                    varchar(4);
nr_sequencia_guia_w             bigint;
cd_guia_w                       varchar(20);
nr_seq_segurado_w               bigint;
cd_medico_solicitante_w         varchar(10);
ie_tipo_guia_w                  varchar(3);
ie_carater_internacao_w         varchar(3);
ie_tipo_atend_tiss_w            varchar(3);
ie_estagio_w                    varchar(4);
nr_sequencia_w                  bigint;
nr_seq_prestador_w              bigint;
nr_seq_plano_w                  bigint;
nr_seq_prestador_ww             bigint:= 1;
ie_tipo_repasse_w               varchar(1);
ie_tipo_segurado_w              varchar(1);
ie_preco_w                      varchar(2);

C01 CURSOR FOR
        SELECT  CASE WHEN ie_opcao_p='N' THEN 'N'  ELSE 'S' END  ie_inserir,
                nr_sequencia,
                cd_guia,
                nr_seq_segurado,
                nr_seq_prestador,
                cd_medico_solicitante,
                ie_tipo_guia,
                ie_carater_internacao,
                ie_tipo_atend_tiss,
                ie_estagio,
                nr_seq_plano
        from	pls_guia_plano 	a
        where 	a.ie_status     = '1'
        and     a.cd_estabelecimento        = cd_estabelecimento_p
        and     pls_conta_autor_pck.pls_obter_ie_utilizado_guia(nr_sequencia, null,null, cd_estabelecimento_p)	in ('P','N')
	and	((a.IE_TIPO_PROCESSO = ie_processo_p) or (coalesce(ie_processo_p::text, '') = ''))
        and (a.dt_solicitacao between dt_inicio_p and fim_dia(dt_fim_p)
		or (ie_usa_data_p = 'N'))
        and     ie_tipo_guia = ie_tipo_guia_w
        and     ((a.nr_seq_prestador = nr_seq_prestador_p) or (nr_seq_prestador_ww = 0))
        and     ((a.nr_seq_prestador in ( SELECT x.nr_sequencia
                                         from   pls_prestador  x
                                         where  x.nr_seq_classificacao =  nr_seq_clas_prestador_p)) or (coalesce(nr_seq_clas_prestador_p::text, '') = ''))
        and     ((pls_obter_se_entre_guias(a.cd_guia,cd_guias_p ) = 'S' ) or (coalesce(cd_guias_p::text, '') = ''))
        and     ((exists (       select  1
                                        from    pls_guia_plano_proc     x
                                        where   x.nr_seq_guia           = a.nr_sequencia
                                        and     x.cd_procedimento       = cd_procedimento_p
                                        and     pls_conta_autor_pck.pls_obter_ie_utilizado_guia(x.nr_seq_guia, x.nr_sequencia,null, cd_estabelecimento_p) in ('P','N')
                                        and     coalesce(nr_seq_motivo_exc::text, '') = '')) or (coalesce(cd_procedimento_p::text, '') = ''))
        and     ((a.cd_medico_solicitante = cd_medico_solic_p ) or (coalesce(cd_medico_solic_p::text, '') = ''))
	and	not exists ( select 1 from pls_conta x where nr_seq_guia = a.nr_sequencia and x.ie_status != 'C');



BEGIN
select  CASE WHEN ie_tipo_guia_p='4' THEN '2' WHEN ie_tipo_guia_p='5' THEN '1' WHEN ie_tipo_guia_p='3' THEN '3'  ELSE '8' END
into STRICT    ie_tipo_guia_w
;

if (ie_alteracao_p      = 'A') then

        CALL pls_delete_w_guias_gera_conta(nm_usuario_p);

        if (coalesce(nr_seq_prestador_p,0) = 0 ) then
           nr_seq_prestador_ww := 0;
        end if;
        open C01;
        loop
        fetch C01 into
                ie_inserir_w,
                nr_sequencia_guia_w,
                cd_guia_w,
                nr_seq_segurado_w,
                nr_seq_prestador_w,
                cd_medico_solicitante_w,
                ie_tipo_guia_w,
                ie_carater_internacao_w,
                ie_tipo_atend_tiss_w,
                ie_estagio_w,
                nr_seq_plano_w;
        EXIT WHEN NOT FOUND; /* apply on C01 */
                begin
		if (coalesce(cd_produto_p,0) > 0) then
			if (coalesce(nr_seq_segurado_w,0) > 0) then
				select 	nr_seq_plano
				into STRICT	nr_seq_plano_w
				from	pls_segurado
				where 	nr_sequencia = nr_seq_segurado_w;

				if ( nr_seq_plano_w <> cd_produto_p ) then
					goto final;
				end if;
			else
				goto final;
			end if;
		end if;

                select  coalesce(max(nr_sequencia),0) + 1
                into STRICT    nr_sequencia_w
                from    w_pls_guias_gera_conta
                where   nm_usuario_logado       = nm_usuario_p;

                insert into w_pls_guias_gera_conta(     nr_sequencia, dt_atualizacao, nm_usuario,
                                                        dt_atualizacao_nrec, nm_usuario_nrec,cd_guia,
                                                        cd_medico_solicitante, dt_solicitacao,ie_carater_internacao,
                                                        ie_estagio,ie_tipo_atend_tiss, ie_tipo_guia,
                                                        nm_usuario_logado,nr_seq_guia_plano,nr_seq_prestador,
                                                        nr_seq_segurado,ie_inserir)
                                                values ( nr_sequencia_w, clock_timestamp(), nm_usuario_p,
                                                        clock_timestamp(), nm_usuario_p,cd_guia_w,
                                                        cd_medico_solicitante_w,null,ie_carater_internacao_w,
                                                        ie_estagio_w,ie_tipo_atend_tiss_w,ie_tipo_guia_w,
                                                        nm_usuario_p,nr_sequencia_guia_w,nr_seq_prestador_w,
                                                        nr_seq_segurado_w,ie_inserir_w);
                <<final>>
		null;
                end;
        end loop;
        close C01;
elsif (ie_alteracao_p = 'U') then
        update  w_pls_guias_gera_conta
        set     ie_inserir  = ie_opcao_p
        where   nm_usuario_logado = nm_usuario_p
        and     nr_sequencia = nr_sequencia_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_w_pls_conta_guia_pend ( ie_usa_data_p text, dt_inicio_p timestamp, dt_fim_p timestamp, ie_tipo_guia_p text, nr_seq_prestador_p bigint, ie_opcao_p text, nm_usuario_p text, cd_estabelecimento_p text, ie_alteracao_p text, nr_sequencia_p bigint, cd_procedimento_p bigint, cd_guias_p text, cd_medico_solic_p text, cd_produto_p text, nr_seq_clas_prestador_p bigint, ie_processo_p text) FROM PUBLIC;

