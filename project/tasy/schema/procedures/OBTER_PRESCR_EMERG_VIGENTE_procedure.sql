-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_prescr_emerg_vigente ( nr_atendimento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, cd_perfil_ativo_p bigint, cd_setor_atendimento_p bigint, nr_prescricao_out_p INOUT bigint, cd_medico_p INOUT text, cd_motivo_prescricao_p INOUT bigint, nm_maquina_p text default null) AS $body$
DECLARE

				 
dt_inicio_prescr_w		timestamp;
dt_validade_prescr_w		timestamp;
nr_prescricao_w			bigint;
nr_prescricao_emer_w		bigint := 0;
cd_pessoa_fisica_w		varchar(10);
ie_setor_pac_usuar_w		varchar(1);
cd_setor_atendimento_w		bigint;
cd_setor_atendimento_maq_w	bigint;
qt_setor_atend_usuario_w	bigint;
cd_medico_w			varchar(10);
cd_motivo_prescricao_w		bigint;

			 
C01 CURSOR FOR 
	SELECT	dt_inicio_prescr, 
		dt_validade_prescr, 
		nr_prescricao, 
		cd_medico, 
		ie_motivo_prescricao 
	from	prescr_medica 
	where	nr_atendimento = nr_atendimento_p 
	and 	coalesce(dt_liberacao::text, '') = '' 
	and 	coalesce(dt_liberacao_medico::text, '') = '' 
	and	coalesce(ie_emergencia,'N') = 'S' 
	order by nr_prescricao desc;

BEGIN
cd_medico_p		:=	'0';			
cd_motivo_prescricao_p	:=	0;
 
cd_medico_w	:= Obter_Pf_Usuario(nm_usuario_p, 'C');
 
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then 
 
	if (nr_prescricao_emer_w = 0) then 
	 
		ie_setor_pac_usuar_w := Obter_Param_Usuario(998, 2, cd_perfil_ativo_p, nm_usuario_p, cd_estabelecimento_p, ie_setor_pac_usuar_w);
		 
		Select	coalesce(obter_unidade_atendimento(nr_atendimento_p,'IA','CS'),obter_unidade_atendimento(nr_atendimento_p,'A','CS')) 
		into STRICT	cd_setor_atendimento_w 
		;
		 
		if (ie_setor_pac_usuar_w = 'U') and (cd_setor_atendimento_p IS NOT NULL AND cd_setor_atendimento_p::text <> '') then 
			select 	count(*) 
			into STRICT  	qt_setor_atend_usuario_w 
			from  	setor_atendimento a 
			where 	a.cd_setor_atendimento in (SELECT b.cd_setor_atendimento  
												from 	atend_paciente_unidade b   
												where 	b.nr_atendimento = nr_atendimento_p 
												and b.cd_setor_atendimento = cd_setor_atendimento_p);
			if (qt_setor_atend_usuario_w > 0) then 
				cd_setor_atendimento_w := cd_setor_atendimento_p;
			end if;
		 
		elsif (ie_setor_pac_usuar_w = 'C') then			 
				 
			select 	coalesce(max(cd_setor_atendimento),0) 
			into STRICT	cd_setor_atendimento_maq_w 
			from	computador 
			where	nm_computador_pesquisa = padronizar_nome(upper(nm_maquina_p));
						 
			if (cd_setor_atendimento_maq_w > 0) then			  
			 cd_setor_atendimento_w	:= cd_setor_atendimento_maq_w;
		  end if;
			 
		end if;
 
		select 	max(cd_pessoa_fisica) 
		into STRICT	cd_pessoa_fisica_w 
		from	atendimento_paciente 
		where	nr_atendimento	=	nr_atendimento_p;
 
		SELECT	nextval('prescr_medica_seq') 
		INTO STRICT	nr_prescricao_emer_w 
		;
		 
			insert into prescr_medica(	nr_prescricao, 
										cd_pessoa_fisica, 
										dt_prescricao, 
										dt_atualizacao, 
										nm_usuario, 
										nr_atendimento, 
										cd_prescritor, 
										ie_emergencia, 
										nm_usuario_original, 
										cd_estabelecimento, 
										ie_prescr_emergencia, 
										ie_adep, 
										ie_prescr_farm, 
										ie_prescritor_aux, 
										ie_prescr_nutricao, 
										ie_liberacao_final, 
										ie_cartao_emergencia, 
										ie_paciente_dialise, 
										ie_ajusta_validade_atend, 
										cd_funcao_origem, 
										cd_perfil_ativo, 
										--nr_seq_status_opm, 
										cd_setor_atendimento, 
										ie_recem_nato, 
										ie_origem_inf, 
										ie_prescricao_alta, 
										nr_horas_validade, 
										dt_liberacao_aux, 
										dt_primeiro_horario) 
						values (nr_prescricao_emer_w, 
										cd_pessoa_fisica_w, 
										clock_timestamp(), 
										clock_timestamp(), 
										nm_usuario_p, 
										nr_atendimento_p, 
										cd_medico_w, 
										'S', 
										nm_usuario_P, 
										cd_estabelecimento_p, 
										'S', 
										'S', 
										'N', 
										'S', 
										'N', 
										'N', 
										'N', 
										'N', 
										'N', 
										998, 
										cd_perfil_ativo_p, 
										--4, 
										cd_setor_atendimento_w, 
										'N', 
										1, 
										'N', 
										12, 
										clock_timestamp(), 
										clock_timestamp());
										 
										 
	cd_medico_p	:= cd_medico_w;		
	end if;
end if;
commit;
 
nr_prescricao_out_p := nr_prescricao_emer_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_prescr_emerg_vigente ( nr_atendimento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, cd_perfil_ativo_p bigint, cd_setor_atendimento_p bigint, nr_prescricao_out_p INOUT bigint, cd_medico_p INOUT text, cd_motivo_prescricao_p INOUT bigint, nm_maquina_p text default null) FROM PUBLIC;

