-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE supplypoint_gerar_inventario ( cd_local_estoque_p bigint, cd_material_p bigint, qt_contagem_p bigint, cd_fornecedor_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE


ds_erro_w			varchar(2000);
ie_tipo_entrada_w		varchar(1);
cd_operacao_estoque_w		bigint;
dt_mesano_referencia_w		timestamp;
nr_movimento_w			bigint;
qt_estoque_w                	double precision := 0;
qt_material_estoque_w		double precision;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
cd_local_estoque_w		smallint;


BEGIN
cd_estabelecimento_w := cd_estabelecimento_p;
dt_mesano_referencia_w := trunc(clock_timestamp(),'mm');

if (cd_estabelecimento_w = 0) then
	select	max(cd_estabelecimento)
	into STRICT	cd_estabelecimento_w
	from	parametros_farmacia
	where	(cd_pessoa_requisicao IS NOT NULL AND cd_pessoa_requisicao::text <> '');
end if;

select	coalesce(max(cd_local_estoque),0)
into STRICT	cd_local_estoque_w
from	parametros_farmacia
where	cd_estabelecimento = cd_estabelecimento_w;

if (cd_local_estoque_w = 0) then
	goto Final;
end if;

qt_estoque_w := Obter_Saldo_Estoque(cd_estabelecimento_w, cd_material_p, cd_local_estoque_w, dt_mesano_referencia_w, qt_estoque_w);

select (qt_contagem_p - qt_estoque_w)
into STRICT	qt_material_estoque_w
;

if (coalesce(qt_material_estoque_w,0) > 0) then
	ie_tipo_entrada_w := 'E';
else
	ie_tipo_entrada_w := 'S';
	qt_material_estoque_w := (qt_material_estoque_w * -1);
end if;

if (coalesce(ie_tipo_entrada_w,'X') <> 'X') then
	select	min(cd_operacao_estoque)
	into STRICT	cd_operacao_estoque_w
	from	operacao_estoque
	where	ie_tipo_requisicao = 5
	and	ie_entrada_saida = ie_tipo_entrada_w
	and	ie_consignado	= '0'
	and	ie_situacao	= 'A';
end if;

if (coalesce(cd_operacao_estoque_w,0) <> 0) then
	begin
	select	nextval('movimento_estoque_seq')
	into STRICT	nr_movimento_w
	;

	begin

	insert into movimento_estoque(
		nr_movimento_estoque,
		cd_estabelecimento,
		cd_local_estoque,
		dt_movimento_estoque,
		cd_operacao_estoque,
		cd_acao,
		cd_material,
		dt_mesano_referencia,
		qt_movimento,
		dt_atualizacao,
		nm_usuario,
		ie_origem_documento,
		ie_origem_proced,
		qt_estoque,
		dt_processo,
		cd_material_estoque,
		qt_inventario,
		ie_movto_consignado,
		ds_observacao)
	values ( nr_movimento_w,
		cd_estabelecimento_w,
		cd_local_estoque_w,
		clock_timestamp(),
		cd_operacao_estoque_w,
		1,
		cd_material_p,
		dt_mesano_referencia_w,
		qt_material_estoque_w,
		clock_timestamp(),
		nm_usuario_p,
		5,
		1,
		qt_material_estoque_w,
		null,
		cd_material_p,
		qt_material_estoque_w,
		'N',
		WHEB_MENSAGEM_PCK.get_texto(278957));
	exception when others then
		ds_erro_w := substr(sqlerrm,1,2000);
	end;
	end;
end if;

<<Final>>

ds_erro_p := ds_erro_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE supplypoint_gerar_inventario ( cd_local_estoque_p bigint, cd_material_p bigint, qt_contagem_p bigint, cd_fornecedor_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

