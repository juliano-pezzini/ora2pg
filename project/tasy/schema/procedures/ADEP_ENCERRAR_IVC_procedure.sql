-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE adep_encerrar_ivc (nr_seq_irrigacao_p bigint, dt_registro_p timestamp, nr_prescricao_p bigint, qt_infusao_p bigint, qt_drenagem_p bigint, nm_usuario_p text, nr_seq_assinatura_p bigint default null, nr_seq_aspecto_p bigint default null, ds_observacao_p text default null) AS $body$
DECLARE


nr_seq_etapa_w		bigint;
nr_seq_aspecto_w	bigint;
ie_status_ivc_w		varchar(10);
nr_prescricao_w		bigint;
nr_seq_procedimento_w	bigint;
nr_seq_alteracao_w	bigint;
cd_procedimento_w	bigint;
nr_seq_proc_interno_w	bigint;
nr_atendimento_w	bigint;
nr_seq_procedimento_ww	bigint;
nr_prescricao_ww	bigint;
ie_gerar_evento_w	varchar(1);
ds_observacao_w		varchar(2000);


BEGIN
ie_gerar_evento_w := obter_param_usuario(1113, 431, Obter_perfil_Ativo, nm_usuario_p, 0, ie_gerar_evento_w);
if (nr_seq_irrigacao_p IS NOT NULL AND nr_seq_irrigacao_p::text <> '') and (dt_registro_p IS NOT NULL AND dt_registro_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then

	update	adep_irrigacao
	set	dt_fim			= coalesce(dt_registro_p,clock_timestamp()),
		cd_pessoa_fisica_fim	= substr(obter_dados_usuario_opcao(nm_usuario_p,'C'),1,10),
		ie_status_ivc		= 'F'
	where	nr_sequencia		= nr_seq_irrigacao_p;

	/* Diego OS124445*/

	select	coalesce(nr_seq_aspecto_p,max(nr_seq_aspecto))
	into STRICT	nr_seq_aspecto_w
	from	adep_irrigacao_etapa
	where	nr_seq_irrigacao = nr_seq_irrigacao_p
	and		ie_evento = 'I';

	select	nextval('adep_irrigacao_etapa_seq')
	into STRICT	nr_seq_etapa_w
	;
	
	ds_observacao_w	:= substr(ds_observacao_p,1,2000);

	insert into adep_irrigacao_etapa(
		nr_sequencia,
		nr_seq_irrigacao,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		dt_registro,
		qt_infusao,
		qt_drenagem,
		nr_seq_aspecto,
		ds_observacao,
		cd_pessoa_fisica,
		ie_evento,
		ie_evento_valido)
	values (
		nr_seq_etapa_w,
		nr_seq_irrigacao_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		coalesce(dt_registro_p,clock_timestamp()),
		qt_infusao_p,
		qt_drenagem_p,
		nr_seq_aspecto_w,
		ds_observacao_w,
		substr(obter_dados_usuario_opcao(nm_usuario_p,'C'),1,10),
		'E',
		'S');


	/*Gerar a etapa como evento*/

	if (ie_gerar_evento_w = 'S') then

		select	nextval('prescr_mat_alteracao_seq')
		into STRICT	nr_seq_alteracao_w
		;

		select	max(nr_seq_procedimento),
			max(nr_prescricao),
			max(nr_atendimento)
		into STRICT	nr_seq_procedimento_ww,
			nr_prescricao_ww,
			nr_atendimento_w
		from	adep_irrigacao
		where	nr_sequencia = nr_seq_irrigacao_p;

		select	max(cd_procedimento),
			max(nr_seq_proc_interno)
		into STRICT	cd_procedimento_w,
			nr_seq_proc_interno_w
		from 	prescr_procedimento
		where 	nr_prescricao = nr_prescricao_ww
		and 	nr_sequencia = nr_seq_procedimento_ww;

		insert into prescr_mat_alteracao(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_prescricao,
				nr_seq_procedimento,
				dt_alteracao,
				cd_pessoa_fisica,
				ie_alteracao,
				nr_seq_motivo,
				ds_justificativa,
				ie_tipo_item,
				nr_atendimento,
				cd_item,
				nr_seq_proc_interno,
				nr_seq_motivo_susp,
				nr_seq_assinatura,
				ds_observacao
				)
			values (
				nr_seq_alteracao_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_prescricao_ww,
				nr_seq_procedimento_ww,
				clock_timestamp(),
				obter_dados_usuario_opcao(nm_usuario_p,'C'),
				42,
				null,
				null,
				'I',
				nr_atendimento_w,
				cd_procedimento_w,
				nr_seq_proc_interno_w,
				null,
				nr_seq_assinatura_p,
				ds_observacao_w
				);
	end if;
	
	select	max(ie_status_ivc),
		max(nr_prescricao),
		max(nr_seq_procedimento)
	into STRICT	ie_status_ivc_w,
		nr_prescricao_w,
		nr_seq_procedimento_w
	from	adep_irrigacao
	where	nr_sequencia	= nr_seq_irrigacao_p;
	
	if (ie_status_ivc_w = 'F') then
		ie_status_ivc_w	:= 'A';
	elsif (ie_status_ivc_w = 'P') then
		ie_status_ivc_w	:= 'N';
	end if;
	
	update	prescr_proc_hor
	set	ie_status_ivc	= ie_status_ivc_w
	where	nr_prescricao	= nr_prescricao_w
	and	nr_seq_procedimento = nr_seq_procedimento_w;

end if;

CALL ADEP_finalizacao_ivc(nr_seq_irrigacao_p,nm_usuario_p, nr_seq_etapa_w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE adep_encerrar_ivc (nr_seq_irrigacao_p bigint, dt_registro_p timestamp, nr_prescricao_p bigint, qt_infusao_p bigint, qt_drenagem_p bigint, nm_usuario_p text, nr_seq_assinatura_p bigint default null, nr_seq_aspecto_p bigint default null, ds_observacao_p text default null) FROM PUBLIC;

