-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ajustar_prescr_mat_solucao ( nr_prescricao_p bigint, nr_sequencia_p bigint) AS $body$
DECLARE


nr_ocorrencia_w				bigint;
nr_sequencia_w				integer;
qt_conversao_dose_w			double precision;
cd_material_w				integer;
qt_unitaria_w				double precision;
qt_material_w				double precision;
qt_dose_especial_w			double precision;
qt_dispensar_acm_w			double precision;
ds_dose_diferenciada_w		varchar(50);
ie_origem_inf_w				varchar(1);
qt_dispensar_w				double precision;
qt_horas_estabilidade_w		double precision;
ds_erro_w					varchar(255);
cd_intervalo_w				varchar(7);
cd_intervalo_sol_w			varchar(7);
ie_via_aplicacao_w			varchar(5);
ie_urgencia_w				varchar(1);
ie_pca_w					varchar(1);
ie_se_necessario_w			varchar(1);
ie_acm_w					varchar(1);
ie_acm_ww					varchar(1);
cd_unidade_medida_dose_w	varchar(30);
ie_regra_disp_w				varchar(1);/* Rafael em 15/3/8 OS86206 */
qt_solucao_total_w			double precision;
ie_bomba_infusao_w			varchar(50);
nm_usuario_w				varchar(200);
cd_estabelecimento_w		integer;
cd_protocolo_w				bigint;
nr_seq_protocolo_w			bigint;
nr_seq_mat_protocolo_w		bigint;
qt_volume_corrigido_w		double precision;
ie_fator_correcao_w			prescr_solucao.ie_fator_correcao%type;
ds_horarios_w				prescr_solucao.ds_horarios%type;
nr_sequencia_kit_w				integer;
qt_conversao_dose_kit_w			double precision;
cd_material_kit_w				double precision;
qt_unitaria_kit_w				double precision;
qt_material_kit_w				double precision;
qt_dose_especial_kit_w			double precision;
ds_dose_diferenciada_kit_w		varchar(50);
ie_origem_inf_kit_w 			varchar(1);
cd_intervalo_kit_w				varchar(7);
ie_via_aplicacao_kit_w			varchar(5);
cd_unidade_medida_dose_kit_w	varchar(30);
ie_se_necessario_kit_w			varchar(1);
ie_acm_kit_w					varchar(1);
cd_protocolo_kit_w				bigint;
nr_seq_protocolo_kit_w			bigint;
nr_seq_mat_protocolo_kit_w		bigint;
qt_volume_corrigido_kit_w		double precision;
qt_dispensar_kit_w				double precision;
ie_regra_disp_kit_w				varchar(1);
ds_erro_kit_w					varchar(255);
qt_dose_extra_w					prescr_material.qt_dose%type;
qt_vol_corrigido_w				prescr_material.qt_dose%type;
ie_param302_w					varchar(2);
ie_param431_w					varchar(2);

C01 CURSOR FOR
SELECT	coalesce(nr_sequencia,0),
		coalesce(qt_conversao_dose,0),
		coalesce(cd_material,0),
		coalesce(qt_unitaria,0),
		coalesce(qt_material,0),
		coalesce(qt_dose_especial,0),
		coalesce(ds_dose_diferenciada,''),
		coalesce(ie_origem_inf,'1'),
		coalesce(cd_intervalo_sol_w, cd_intervalo),
		ie_via_aplicacao,
		cd_unidade_medida_dose,
		coalesce(ie_se_necessario,'N'),
		coalesce(ie_acm,'N'),
		cd_protocolo,
		nr_seq_protocolo,
		nr_seq_mat_protocolo,
		coalesce(qt_volume_corrigido,0)
from	prescr_material
where	coalesce(ie_suspenso,'N') <> 'S'
and		nr_sequencia_solucao = nr_sequencia_p
and		nr_prescricao = nr_prescricao_p;

C02 CURSOR FOR
SELECT	coalesce(nr_sequencia,0),
		coalesce(qt_conversao_dose,0),
		coalesce(cd_material,0),
		coalesce(qt_unitaria,0),
		coalesce(qt_material,0),
		coalesce(qt_dose_especial,0),
		coalesce(ds_dose_diferenciada,''),
		coalesce(ie_origem_inf,'1'),
		coalesce(cd_intervalo_sol_w, cd_intervalo),
		ie_via_aplicacao,
		cd_unidade_medida_dose,
		coalesce(ie_se_necessario,'N'),
		coalesce(ie_acm,'N'),
		cd_protocolo,
		nr_seq_protocolo,
		nr_seq_mat_protocolo,
		coalesce(qt_volume_corrigido,0)
from	prescr_material
where	coalesce(ie_suspenso,'N') <> 'S'
and		nr_prescricao = nr_prescricao_p
and		nr_seq_kit = nr_sequencia_w;


BEGIN

ie_param302_w	:= Wheb_assist_pck.obterParametroFuncao(924,302);
ie_param431_w	:= Wheb_assist_pck.obterParametroFuncao(924,431);

select	coalesce(max(a.nr_etapas),1),
		coalesce(max(a.ie_urgencia),'N'),
		coalesce(max(a.ie_se_necessario),'N'),
		coalesce(max(a.IE_SOLUCAO_PCA),'N'),
		coalesce(max(a.qt_solucao_total),0),
		coalesce(max(a.ie_bomba_infusao),'N'),
		max(a.nm_usuario),
		max(b.cd_estabelecimento),
		max(a.cd_intervalo),
		max(a.ie_acm),
		coalesce(max(a.ie_fator_correcao),'N'),
		max(a.ds_horarios)
into STRICT	nr_ocorrencia_w,
		ie_urgencia_w,
		ie_se_necessario_w,
		ie_pca_w,
		qt_solucao_total_w,
		ie_bomba_infusao_w,
		nm_usuario_w,
		cd_estabelecimento_w,
		cd_intervalo_sol_w,
		ie_acm_ww,
		ie_fator_correcao_w,
		ds_horarios_w
from	prescr_solucao a,
		prescr_medica b
where	a.nr_seq_solucao	= nr_sequencia_p
and		a.nr_prescricao	= b.nr_prescricao
and		b.nr_prescricao	= nr_prescricao_p;

begin
	qt_horas_estabilidade_w := obter_estabilidade_mat_prescr(nr_prescricao_p, nr_sequencia_p);
exception when others then
	qt_horas_estabilidade_w := null;
end;

update	prescr_solucao
set		qt_horas_estabilidade	= qt_horas_estabilidade_w
where	nr_seq_solucao		= nr_sequencia_p
and		nr_prescricao		= nr_prescricao_p;

if	((ie_se_necessario_w = 'S') and (ie_param302_w = 'S') and (ie_param431_w = 'S') and (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '')) then
	nr_ocorrencia_w	:= obter_ocorrencias_horarios_rep(ds_horarios_w);
elsif (ie_se_necessario_w = 'S') then
	nr_ocorrencia_w := 1;
end if;

open C01;
loop
fetch C01 into
	nr_sequencia_w,
	qt_conversao_dose_w,
	cd_material_w,
	qt_unitaria_w,
	qt_material_w,
	qt_dose_especial_w,
	ds_dose_diferenciada_w,
	ie_origem_inf_w,
	cd_intervalo_w,
	ie_via_aplicacao_w,
	cd_unidade_medida_dose_w,
	ie_se_necessario_w,
	ie_acm_w,
	cd_protocolo_w,
	nr_seq_protocolo_w,
	nr_seq_mat_protocolo_w,
	qt_volume_corrigido_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

	if (ie_pca_w = 'S') and (nr_ocorrencia_w = 1) and (coalesce(cd_intervalo_w::text, '') = '') then
		select	max(cd_intervalo)
		into STRICT	cd_intervalo_w
		from 	intervalo_prescricao
		where	nr_etapas = nr_ocorrencia_w
		and	ie_situacao = 'A'
		and	Obter_se_intervalo(cd_intervalo, 15) = 'S'
		and	((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento));
	end if;
/*
	--Tratamento criado por conta do Fator de correção
	if (qt_volume_corrigido_w > 0) then
		qt_unitaria_w := (qt_volume_corrigido_w)/qt_conversao_dose_w;
	end if;
	--Fim tratamento fator correção
*/
	SELECT * FROM Obter_Quant_Dispensar(	wheb_usuario_pck.get_cd_estabelecimento, cd_material_w, nr_prescricao_p, nr_sequencia_w, cd_intervalo_w, ie_via_aplicacao_w, qt_unitaria_w, qt_dose_especial_w, nr_ocorrencia_w, ds_dose_diferenciada_w, ie_origem_inf_w, cd_unidade_medida_dose_w, 1, qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w;

	if (coalesce(cd_intervalo_w::text, '') = '') and (ie_regra_disp_w <> 'E') and (ie_regra_disp_w <> 'N') then
		ie_regra_disp_w	:= 'S';
	end if;


	begin
		qt_horas_estabilidade_w := obter_estabilidade_mat_prescr(nr_prescricao_p, nr_sequencia_w);
	exception when others then
		qt_horas_estabilidade_w := null;
	end;

	select	max(QT_DISPENSAR_ACM)
	into STRICT	QT_DISPENSAR_ACM_w
	from	protocolo_medic_material
	where	nr_seq_material = nr_seq_mat_protocolo_w
	and	nr_sequencia = nr_seq_protocolo_w
	and	cd_protocolo = cd_protocolo_w;

	if (QT_DISPENSAR_ACM_w > 0) and
		((ie_acm_ww = 'S') or (ie_se_necessario_w = 'S')) then
		qt_dispensar_w	:= QT_DISPENSAR_ACM_w;
	end if;

	if (ie_se_necessario_w	= 'S') then
		ds_horarios_w	:= 'SN';
	elsif (ie_acm_w	= 'S') then
		ds_horarios_w	:= 'ACM';
	end if;

	Update	prescr_material
	set		nr_ocorrencia		= nr_ocorrencia_w,
			qt_total_dispensar	= qt_dispensar_w,
			qt_material		= qt_material_w,
			ie_medicacao_paciente	= 'N',
			ie_utiliza_kit		= 'N',
			ie_urgencia		= ie_urgencia_w,
			ie_suspenso		= 'N',
			ds_horarios		= ds_horarios_w,
			qt_volume_corrigido  = NULL,
			qt_horas_estabilidade	= coalesce(qt_horas_estabilidade_w, qt_horas_estabilidade),
			ie_regra_disp		= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END ,
			ie_bomba_infusao  = ie_bomba_infusao_w
	where	nr_sequencia  = nr_sequencia_w
	and	nr_prescricao = nr_prescricao_p;

	open C02;
	loop
	fetch C02 into
		nr_sequencia_kit_w,
		qt_conversao_dose_kit_w,
		cd_material_kit_w,
		qt_unitaria_kit_w,
		qt_material_kit_w,
		qt_dose_especial_kit_w,
		ds_dose_diferenciada_kit_w,
		ie_origem_inf_kit_w,
		cd_intervalo_kit_w,
		ie_via_aplicacao_kit_w,
		cd_unidade_medida_dose_kit_w,
		ie_se_necessario_kit_w,
		ie_acm_kit_w,
		cd_protocolo_kit_w,
		nr_seq_protocolo_kit_w,
		nr_seq_mat_protocolo_kit_w,
		qt_volume_corrigido_kit_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */

		--Tratamento criado por conta do Fator de correção
		if (qt_volume_corrigido_kit_w > 0) then
			qt_unitaria_w := (qt_volume_corrigido_kit_w)/qt_conversao_dose_kit_w;
		end if;
		--Fim tratamento fator correção
		SELECT * FROM Obter_Quant_Dispensar(wheb_usuario_pck.get_cd_estabelecimento, cd_material_kit_w, nr_prescricao_p, nr_sequencia_kit_w, cd_intervalo_kit_w, ie_via_aplicacao_kit_w, qt_unitaria_kit_w, qt_dose_especial_kit_w, nr_ocorrencia_w, ds_dose_diferenciada_kit_w, ie_origem_inf_kit_w, cd_unidade_medida_dose_kit_w, 1, qt_material_kit_w, qt_dispensar_kit_w, ie_regra_disp_kit_w, ds_erro_kit_w, ie_se_necessario_kit_w, ie_acm_kit_w) INTO STRICT qt_material_kit_w, qt_dispensar_kit_w, ie_regra_disp_kit_w, ds_erro_kit_w;

		Update	prescr_material
		set		nr_ocorrencia		= nr_ocorrencia_w,
				qt_total_dispensar	= qt_dispensar_kit_w,
				qt_material		= qt_material_kit_w,
				ie_medicacao_paciente	= 'N',
				ie_utiliza_kit		= 'N',
				ie_urgencia		= ie_urgencia_w,
				ie_suspenso		= 'N',
				ds_horarios		= ds_horarios_w,
				qt_volume_corrigido  = NULL,
				qt_horas_estabilidade	= coalesce(qt_horas_estabilidade_w, qt_horas_estabilidade),
				ie_regra_disp		= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END ,
				ie_bomba_infusao  = ie_bomba_infusao_w
		where	nr_prescricao = nr_prescricao_p
		and 	nr_sequencia  = nr_sequencia_kit_w;

	end loop;
	close c02;

	qt_vol_corrigido_w	:= 0;

	qt_vol_corrigido_w := ajustar_vol_equipo_solucao(qt_solucao_total_w, nr_prescricao_p, nr_sequencia_w, ie_bomba_infusao_w, ie_fator_correcao_w, nr_ocorrencia_w, qt_vol_corrigido_w);

	--Tratamento criado por conta do Fator de correção
	if (qt_vol_corrigido_w > 0) then
		qt_unitaria_w := (qt_vol_corrigido_w)/qt_conversao_dose_w;

		SELECT * FROM Obter_Quant_Dispensar(	wheb_usuario_pck.get_cd_estabelecimento, cd_material_w, nr_prescricao_p, nr_sequencia_w, cd_intervalo_w, ie_via_aplicacao_w, qt_unitaria_w, qt_dose_especial_w, nr_ocorrencia_w, ds_dose_diferenciada_w, ie_origem_inf_w, cd_unidade_medida_dose_w, 1, qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w;

		Update	prescr_material
		set	qt_total_dispensar = qt_dispensar_w
		where	nr_sequencia  = nr_sequencia_w
		and	nr_prescricao = nr_prescricao_p;

		qt_vol_corrigido_w	:= 0;

	end if;
	-- Fim tratamento Fator correção.
end loop;
close C01;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ajustar_prescr_mat_solucao ( nr_prescricao_p bigint, nr_sequencia_p bigint) FROM PUBLIC;

