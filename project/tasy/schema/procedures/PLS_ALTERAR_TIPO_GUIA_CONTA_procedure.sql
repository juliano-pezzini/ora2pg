-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alterar_tipo_guia_conta ( nr_seq_conta_p bigint, ie_tipo_guia_p bigint, nr_seq_protocolo_alt_p INOUT bigint, cd_estabalecimento_p bigint, nm_usuario_p text ) AS $body$
DECLARE


nr_seq_lote_conta_w		bigint;
nr_seq_protocolo_w		bigint;
nr_seq_protocolo_ww		bigint;


BEGIN

select	b.nr_seq_lote_conta,
	a.nr_seq_protocolo
into STRICT	nr_seq_lote_conta_w,
	nr_seq_protocolo_w
from	pls_conta a,
	pls_protocolo_conta b
where	b.nr_sequencia = a.nr_seq_protocolo
and	a.nr_sequencia = nr_seq_conta_p;

select	max(nr_sequencia)
into STRICT	nr_seq_protocolo_ww
from	pls_protocolo_conta
where	nr_seq_lote_conta_w	= nr_seq_lote_conta
and	ie_tipo_guia		= ie_tipo_guia_p
and	ie_status		in ('1','2');

if (coalesce(nr_seq_protocolo_ww,0) = 0) then

	select	nextval('pls_protocolo_conta_seq')
	into STRICT	nr_seq_protocolo_ww
	;

	insert into pls_protocolo_conta(	nr_sequencia,
			cd_agencia_bancaria,
			cd_banco,
			cd_cgc_prestador_imp,
			cd_condicao_pagamento,
			cd_conta,
			cd_estabelecimento,
			cd_pessoa_fisica,
			cd_prestador,
			cd_prestador_imp,
			cd_profissional_executor,
			cd_versao,
			cd_versao_tiss,
			ds_aplicativo,
			ds_fabricante,
			ds_observacao,
			dt_atualizacao,
			dt_atualizacao_nrec,
			dt_base_venc,
			dt_fechamento_contas,
			dt_integracao,
			dt_lib_pagamento,
			dt_mes_competencia,
			dt_protocolo,
			dt_protocolo_imp,
			ie_apresentacao,
			ie_digito_agencia,
			ie_digito_conta,
			ie_forma_imp,
			ie_forma_pagamento,
			ie_guia_fisica,
			ie_protocolo_compl,
			ie_situacao,
			ie_status,
			ie_tipo_guia,
			ie_tipo_protocolo,
			ie_tipo_resp_credito,
			nm_prestador_imp,
			nm_usuario,
			nm_usuario_integracao,
			nm_usuario_nrec,
			nr_cpf_prestador_imp,
			nr_lote_contabil,
			nr_protocolo_prestador,
			nr_seq_congenere,
			nr_seq_conta_banco,
			nr_seq_grau_partic,
			nr_seq_lote,
			nr_seq_lote_conta,
			nr_seq_mot_reembolso,
			nr_seq_outorgante,
			nr_seq_periodo_pgto,
			nr_seq_prestador,
			nr_seq_prestador_imp,
			nr_seq_prot_referencia,
			nr_seq_resumo_lote,
			nr_seq_segurado,
			nr_seq_transacao,
			qt_contas_informadas,
			qt_ocorrencias,
			vl_cobrado,
			vl_cobrado_manual,
			vl_contabil,
			vl_coparticipacao,
			vl_glosa,
			vl_lib_sistema,
			vl_lib_usuario,
			vl_pendente,
			vl_total,
			vl_total_beneficiario,
			vl_total_imp,
			ie_origem_protocolo)
	SELECT	nr_seq_protocolo_ww,
			cd_agencia_bancaria,
			cd_banco,
			cd_cgc_prestador_imp,
			cd_condicao_pagamento,
			cd_conta,
			cd_estabelecimento,
			cd_pessoa_fisica,
			cd_prestador,
			cd_prestador_imp,
			cd_profissional_executor,
			cd_versao,
			cd_versao_tiss,
			ds_aplicativo,
			ds_fabricante,
			ds_observacao,
			clock_timestamp(),
			clock_timestamp(),
			dt_base_venc,
			dt_fechamento_contas,
			dt_integracao,
			dt_lib_pagamento,
			dt_mes_competencia,
			dt_protocolo,
			dt_protocolo_imp,
			ie_apresentacao,
			ie_digito_agencia,
			ie_digito_conta,
			ie_forma_imp,
			ie_forma_pagamento,
			ie_guia_fisica,
			ie_protocolo_compl,
			ie_situacao,
			ie_status,
			ie_tipo_guia_p,
			ie_tipo_protocolo,
			ie_tipo_resp_credito,
			nm_prestador_imp,
			nm_usuario_p,
			nm_usuario_integracao,
			nm_usuario_p,
			nr_cpf_prestador_imp,
			nr_lote_contabil,
			nr_protocolo_prestador,
			nr_seq_congenere,
			nr_seq_conta_banco,
			nr_seq_grau_partic,
			nr_seq_lote,
			nr_seq_lote_conta,
			nr_seq_mot_reembolso,
			nr_seq_outorgante,
			nr_seq_periodo_pgto,
			nr_seq_prestador,
			nr_seq_prestador_imp,
			nr_seq_prot_referencia,
			nr_seq_resumo_lote,
			nr_seq_segurado,
			nr_seq_transacao,
			qt_contas_informadas,
			qt_ocorrencias,
			vl_cobrado,
			vl_cobrado_manual,
			vl_contabil,
			vl_coparticipacao,
			vl_glosa,
			vl_lib_sistema,
			vl_lib_usuario,
			vl_pendente,
			vl_total,
			vl_total_beneficiario,
			vl_total_imp,
			ie_origem_protocolo
		from	pls_protocolo_conta
		where	nr_sequencia = nr_seq_protocolo_w;
end if;

update	pls_conta
set	ie_tipo_guia		= ie_tipo_guia_p,
	nr_seq_protocolo	= nr_seq_protocolo_ww
where	nr_sequencia		= nr_seq_conta_p;

nr_seq_protocolo_alt_p := nr_seq_protocolo_ww;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alterar_tipo_guia_conta ( nr_seq_conta_p bigint, ie_tipo_guia_p bigint, nr_seq_protocolo_alt_p INOUT bigint, cd_estabalecimento_p bigint, nm_usuario_p text ) FROM PUBLIC;

