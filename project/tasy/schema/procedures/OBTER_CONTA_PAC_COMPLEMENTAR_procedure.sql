-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_conta_pac_complementar (nr_interno_conta_atual_p bigint, nr_interno_conta_compl_p INOUT bigint) AS $body$
DECLARE


nr_interno_conta_compl_w	bigint := null;
cd_estabelecimento_w		bigint;
nr_atendimento_w		bigint;
cd_convenio_parametro_w		bigint;
cd_categoria_parametro_w	varchar(10);
dt_referencia_w			timestamp;
dt_acerto_conta_w		timestamp;
dt_periodo_inicial_w		timestamp;
dt_periodo_final_w		timestamp;



BEGIN

select	nr_atendimento,
	cd_convenio_parametro,
	cd_categoria_parametro,
	cd_estabelecimento,
	dt_mesano_referencia,
	dt_acerto_conta,
	dt_periodo_inicial,
	dt_periodo_final
into STRICT	nr_atendimento_w,
	cd_convenio_parametro_w,
	cd_categoria_parametro_w,
	cd_estabelecimento_w,
	dt_referencia_w,
	dt_acerto_conta_w,
	dt_periodo_inicial_w,
	dt_periodo_final_w
from	conta_paciente
where	nr_interno_conta	= nr_interno_conta_atual_p;


select 	coalesce(max(a.nr_interno_conta),0)
into STRICT	nr_interno_conta_compl_w
from 	conta_paciente a
where 	ie_status_acerto 	= 1
and   	nr_atendimento 		= nr_atendimento_w
and   	not exists (SELECT	x.nr_sequencia
	from	procedimento_paciente x
	where	x.nr_interno_conta	= a.nr_interno_conta
	and	(x.nr_seq_proc_pacote IS NOT NULL AND x.nr_seq_proc_pacote::text <> '')
	
union

	SELECT	x.nr_sequencia
	from	material_atend_paciente x
	where	x.nr_interno_conta	= a.nr_interno_conta
	and	(x.nr_seq_proc_pacote IS NOT NULL AND x.nr_seq_proc_pacote::text <> ''));

if (nr_interno_conta_compl_w = 0) then
	begin


    	select	nextval('conta_paciente_seq')
     	into STRICT 	nr_interno_conta_compl_w
     	;

    	insert into conta_paciente(nr_atendimento,
 	      	dt_acerto_conta,
 		ie_status_acerto,
 		dt_periodo_inicial,
 		dt_periodo_final,
 		dt_atualizacao,
 		nm_usuario,
 		cd_convenio_parametro,
 		cd_categoria_parametro,
 		dt_mesano_referencia,
		dt_mesano_contabil,
		cd_convenio_calculo,
		cd_categoria_calculo,
		nr_interno_conta,
		cd_estabelecimento,
		nr_protocolo,
		vl_conta,
		vl_desconto)
    	Values (nr_atendimento_w,
            	dt_acerto_conta_w,
            	1,
            	dt_periodo_inicial_w,
            	dt_periodo_final_w,
            	clock_timestamp(),
            	'Tasy',
            	cd_convenio_parametro_w,
            	cd_categoria_parametro_w,
            	dt_referencia_w,
		dt_referencia_w,
            	cd_convenio_parametro_w,
            	cd_categoria_parametro_w,
		nr_interno_conta_compl_w,
		cd_estabelecimento_w,
		'0', 0, 0);


	end;
end if;

nr_interno_conta_compl_p	:= nr_interno_conta_compl_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_conta_pac_complementar (nr_interno_conta_atual_p bigint, nr_interno_conta_compl_p INOUT bigint) FROM PUBLIC;

