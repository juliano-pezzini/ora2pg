-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE efetivar_importacao_materiais ( nr_seq_inventario_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_item_w inventario_material.nr_sequencia%type;
cd_material_w inventario_material.cd_material%type;
nr_seq_lote_w inventario_material_lote.nr_seq_lote_fornec%type;

C01 CURSOR FOR
    SELECT  cd_material,
            nr_seq_lote
    from    importar_material
    where   nr_seq_inventario = nr_seq_inventario_p;

C02 CURSOR FOR
    SELECT  a.nr_sequencia,
            b.nr_seq_lote
    from    inventario_material a,
            importar_material b
    where   a.nr_seq_inventario = nr_seq_inventario_p
    and     a.nr_seq_inventario = b.nr_seq_inventario
    and     a.cd_material = b.cd_material;


BEGIN
    --importa os materiais
    open C01;
    loop
    fetch C01 into cd_material_w, nr_seq_lote_w;
    EXIT WHEN NOT FOUND; /* apply on C01 */
        begin
            insert into inventario_material(nr_sequencia, nr_seq_inventario , cd_material , dt_atualizacao, nm_usuario)
            values (nextval('inventario_material_seq'), nr_seq_inventario_p , cd_material_w, clock_timestamp(), nm_usuario_p);
        end;
    end loop;
    close C01;

    --importa os lotes
    open C02;
    loop
    fetch C02 into nr_seq_item_w, nr_seq_lote_w;
    EXIT WHEN NOT FOUND; /* apply on C02 */
        begin
            insert into inventario_material_lote(nr_sequencia, nr_seq_inventario, nr_seq_item, nr_seq_lote_fornec, dt_atualizacao, nm_usuario)
            values (nextval('inventario_material_lote_seq'), nr_seq_inventario_p, nr_seq_item_w, nr_seq_lote_w, clock_timestamp(), nm_usuario_p);
        end;
    end loop;
    close C01;

    commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE efetivar_importacao_materiais ( nr_seq_inventario_p bigint, nm_usuario_p text) FROM PUBLIC;

