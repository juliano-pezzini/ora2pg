-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_ordem_compra_sgh ( nr_seq_w_ordem_compra_p bigint, cd_estabelecimento_p bigint, cd_cgc_p text, cd_condicao_pagamento_p bigint, cd_comprador_p text, dt_ordem_compra_p timestamp, nm_usuario_p text, cd_moeda_p bigint, cd_pessoa_solicitante_p text, ie_frete_p text, nm_pessoa_contato_p text, ds_observacao_p text, cd_local_estoque_p bigint, dt_entrega_p timestamp, cd_material_p bigint, cd_unid_medida_compra_p text, vl_unitario_material_p bigint, qt_material_p bigint, cd_centro_custo_p bigint, vl_item_liquido_p bigint, ie_tipo_integracao_p text, nr_documento_externo_p bigint) AS $body$
DECLARE


nr_seq_ord_comp_item_w		bigint;
qt_registro_w		        bigint;
ds_erro_w 		        varchar(4000);
nr_ordem_compra_w		bigint;
nr_ordem_compra_gerada_w	bigint;
dt_prevista_entrega_w		timestamp;
cd_conta_contabil_w		ordem_compra_item.cd_conta_contabil%type;
cd_centro_custo_W		ordem_compra_item.cd_centro_custo%type;
cd_centro_custo_WW		ordem_compra_item.cd_centro_custo%type;
ie_status_integracao_w		w_ordem_compra.ie_status_integracao%type;
qt_registros_w			bigint;


BEGIN

--verifica se a ordem de compra ja foi inserida
select	count(1)
into STRICT	qt_registro_w
from	ordem_compra
where	nr_documento_interno = nr_seq_w_ordem_compra_p;

--if	( qt_registro_w = 0 ) then nao foi inserido a capa da ordem anteriormente
	select	nextval('ordem_compra_seq')
	into STRICT	nr_ordem_compra_w
	;

	insert into ordem_compra(
		nr_ordem_compra,
		cd_estabelecimento,
		cd_cgc_fornecedor,
		cd_condicao_pagamento,
		cd_comprador,
		dt_ordem_compra,
		dt_atualizacao,
		nm_usuario,
		cd_moeda,
		ie_situacao,
		dt_inclusao,
		cd_pessoa_solicitante,
		ie_frete,
		vl_frete,
		pr_desc_pgto_antec,
		pr_juros_negociado,
		ds_pessoa_contato,
		ds_observacao,
		cd_local_entrega,
		dt_entrega,
		ie_aviso_chegada,
		ie_emite_obs,
		ie_urgente,
		ie_somente_pagto,
		nr_documento_interno,
		vl_desconto,
		ie_tipo_ordem,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ie_necessita_enviar_int,
		ie_orcado,
		nr_documento_externo,
		ie_sistema_origem)
	values (
		nr_ordem_compra_w,
		cd_estabelecimento_p,
		cd_cgc_p,
		cd_condicao_pagamento_p,
		cd_comprador_p,
		dt_ordem_compra_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_moeda_p,
		'A',
		clock_timestamp(),
		cd_pessoa_solicitante_p,
		ie_frete_p,
		0,
		0,
		0,
		nm_pessoa_contato_p,
		ds_observacao_p,
		cd_local_estoque_p,
		dt_entrega_p,
		'N',
		'S',
		'N',
		'N',
		nr_seq_w_ordem_compra_p,
		0,
		'I',
		clock_timestamp(),
		nm_usuario_p,
		'N',
		'N',
		nr_documento_externo_p,
		'SGH');
--end if;
if ( qt_registro_w > 0 ) then
	select	max(nr_ordem_compra)
	into STRICT	nr_ordem_compra_gerada_w
	from	ordem_compra
	where	nr_documento_interno = nr_seq_w_ordem_compra_p;

	nr_ordem_compra_w := nr_ordem_compra_gerada_w;
end if;


--busca a proxima chave do item
select  coalesce(max(nr_item_oci),0)+1
into STRICT    nr_seq_ord_comp_item_w
from    ordem_compra_item
where   nr_ordem_compra = nr_ordem_compra_w;

--retorna o cd_conta_contabil
SELECT * FROM define_conta_material(
	cd_estabelecimento_p, cd_material_p, 3, null, 0, null, 0, 0, 0, null, cd_local_estoque_p, null, dt_ordem_compra_p, cd_conta_contabil_w, cd_centro_custo_ww, null, null, null) INTO STRICT cd_conta_contabil_w, cd_centro_custo_ww;

if (cd_centro_custo_p > 0) then

	select	count(*)
	into STRICT	qt_registros_w
	from	centro_custo
	where	ie_situacao = 'A'
	and	cd_estabelecimento = cd_estabelecimento_p
	and	cd_centro_custo = cd_centro_custo_p;
	
	if (qt_registros_w > 0) then
		cd_centro_custo_w := cd_centro_custo_p;		
	end if;
end if;
	
	
--insere o item
insert into ordem_compra_item(
	nr_ordem_compra,
	nr_item_oci,
	cd_material,
	cd_unidade_medida_compra,
	vl_unitario_material,
	qt_material,
	dt_atualizacao,
	nm_usuario,
	ie_situacao,
	cd_pessoa_solicitante,
	pr_descontos,
	cd_local_estoque,
	vl_item_liquido,
	cd_centro_custo,
	cd_conta_contabil,
	ie_geracao_solic,
	ie_sistema_origem,
	vl_total_item,
	cd_sequencia_parametro)
values (
	nr_ordem_compra_w,
	nr_seq_ord_comp_item_w,
	cd_material_p,
	cd_unid_medida_compra_p,
	vl_unitario_material_p,
	qt_material_p,
	clock_timestamp(),
	nm_usuario_p,
	'A',
	cd_pessoa_solicitante_p,
	0,
	cd_local_estoque_p,
	vl_item_liquido_p,
	cd_centro_custo_w,
	cd_conta_contabil_w,
	'U',
	'SGH',
	round((qt_material_p * vl_unitario_material_p)::numeric,4),
	philips_contabil_pck.get_parametro_conta_contabil);

select  to_date(clock_timestamp() + coalesce(qt_dias_entrega_oc_consig,0))
into STRICT    dt_prevista_entrega_w
from	parametro_compras
where   cd_estabelecimento = cd_estabelecimento_p;

insert into ordem_compra_item_entrega(
		nr_sequencia,
		nr_ordem_compra,
		nr_item_oci,
		dt_prevista_entrega,
		dt_real_entrega,
		dt_entrega_original,
		dt_entrega_limite,
		qt_prevista_entrega,
		qt_real_entrega,
		dt_atualizacao,
		nm_usuario,
		ds_observacao)
	values (	nextval('ordem_compra_item_entrega_seq'),
		nr_ordem_compra_w,
		nr_seq_ord_comp_item_w,
		dt_entrega_p,
		null,
		dt_entrega_p,
		dt_entrega_p,
		qt_material_p,
		null,
		clock_timestamp(),
		nm_usuario_p,
		null);



	calcular_liquido_ordem_compra(nr_ordem_compra_w, nm_usuario_p);
	CALL gerar_ordem_compra_venc(nr_ordem_compra_w, nm_usuario_p);

	select	ie_status_integracao
	into STRICT	ie_status_integracao_w
	from	w_ordem_compra
	where	nr_documento_externo = nr_documento_externo_p;

	if (coalesce(ie_status_integracao_w,0) = 1) then
		CALL gerar_aprov_ordem_compra(nr_ordem_compra_w, null, 'S', nm_usuario_p);

		update	w_ordem_compra
		set	ie_status_integracao = '3'
		where	nr_documento_externo = nr_documento_externo_p;
	end if;
exception
when others then
	ds_erro_w := SUBSTR(SQLERRM,1,4000);
	CALL gravar_w_sup_inconsis_int(
		cd_estabelecimento_p,
		nm_usuario_p,
		wheb_mensagem_pck.get_Texto(179907, 'DS_ERRO='|| ds_erro_w),
		ie_tipo_integracao_p,
		'R',
		nr_ordem_compra_w,
		'OC');

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_ordem_compra_sgh ( nr_seq_w_ordem_compra_p bigint, cd_estabelecimento_p bigint, cd_cgc_p text, cd_condicao_pagamento_p bigint, cd_comprador_p text, dt_ordem_compra_p timestamp, nm_usuario_p text, cd_moeda_p bigint, cd_pessoa_solicitante_p text, ie_frete_p text, nm_pessoa_contato_p text, ds_observacao_p text, cd_local_estoque_p bigint, dt_entrega_p timestamp, cd_material_p bigint, cd_unid_medida_compra_p text, vl_unitario_material_p bigint, qt_material_p bigint, cd_centro_custo_p bigint, vl_item_liquido_p bigint, ie_tipo_integracao_p text, nr_documento_externo_p bigint) FROM PUBLIC;

