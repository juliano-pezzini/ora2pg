-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ws_registrar_barras ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_amostra_p bigint, cd_barras_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_prescr_proc_mat_w	prescr_proc_material.nr_sequencia%type;
nr_seq_material_w			material_exame_lab.nr_sequencia%type;
qt_volume_padrao_w			material_exame_lab.qt_volume_padrao%type;
qt_tempo_padrao_w			material_exame_lab.qt_tempo_padrao%type;
qt_coleta_w					exame_lab_material.qt_coleta%type;
nr_seq_grupo_w				exame_laboratorio.nr_seq_grupo%type;
ie_amostra_w				prescr_procedimento.ie_amostra%type;
nr_seq_frasco_w				prescr_procedimento.nr_seq_frasco%type;
ie_status_atend_w			prescr_procedimento.ie_status_atend%type;
nr_seq_grupo_imp_w			exame_laboratorio.nr_seq_grupo_imp%type;


BEGIN

select	max(a.nr_seq_material),
		max(coalesce(c.qt_volume_padrao,0)),
		max(coalesce(c.qt_tempo_padrao,0)),
		max(coalesce(d.qt_coleta,1)),
		max(e.nr_seq_grupo),
		max(f.ie_amostra),
		max(f.nr_seq_frasco),
		max(e.nr_seq_grupo_imp),
		max(f.ie_status_atend)
into STRICT	nr_seq_material_w,
		qt_volume_padrao_w,
		qt_tempo_padrao_w,
		qt_coleta_w,
		nr_seq_grupo_w,
		ie_amostra_w,
		nr_seq_frasco_w,
		nr_seq_grupo_imp_w,
		ie_status_atend_w
from	exame_lab_result_item a,
		exame_lab_resultado b,
		material_exame_lab c,
		exame_lab_material d,
		exame_laboratorio e,
		prescr_procedimento f
where	a.nr_seq_resultado = b.nr_seq_resultado
and		a.nr_seq_material = c.nr_sequencia
and		c.nr_sequencia = d.nr_seq_material
and		d.nr_seq_exame = a.nr_seq_exame
and		a.nr_seq_exame = e.nr_seq_exame
and		(a.nr_seq_material IS NOT NULL AND a.nr_seq_material::text <> '')
and		f.nr_prescricao = b.nr_prescricao
and		f.nr_sequencia = a.nr_seq_prescr
and		a.nr_seq_prescr = nr_seq_prescr_p
and		b.nr_prescricao = nr_prescricao_p;

select	nextval('prescr_proc_material_seq')
into STRICT	nr_seq_prescr_proc_mat_w
;

insert into prescr_proc_material(	nr_sequencia,
									nr_prescricao,
									nr_seq_material,
									qt_volume,
									dt_atualizacao,
									qt_tempo,
									qt_minuto,
									nm_usuario,
									dt_coleta,
									nr_seq_grupo,
									nr_amostra,
									ie_amostra,
									nr_seq_frasco,
									nr_seq_grupo_imp,
									nr_seq_int_prescr,
									cd_barras)
						values (nr_seq_prescr_proc_mat_w,
									nr_prescricao_p,
									nr_seq_material_w,
									qt_volume_padrao_w,
									clock_timestamp(),
									qt_tempo_padrao_w,
									0,
									nm_usuario_p,
									CASE WHEN qt_coleta_w=1 THEN clock_timestamp()  ELSE null END ,
									nr_seq_grupo_w,
									1,
									ie_amostra_w,
									nr_seq_frasco_w,
									nr_seq_grupo_imp_w,
									nr_seq_amostra_p,
									cd_barras_p);

insert into prescr_proc_mat_item(nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									dt_atualizacao_nrec,
									nm_usuario_nrec,
									nr_prescricao,
									nr_seq_prescr,
									nr_seq_prescr_proc_mat,
									ie_status,
									cd_barras,
									nr_seq_frasco)
						values (nextval('prescr_proc_mat_item_seq'),
									clock_timestamp(),
									nm_usuario_p,
									clock_timestamp(),
									nm_usuario_p,
									nr_prescricao_p,
									nr_seq_prescr_p,
									nr_seq_prescr_proc_mat_w,
									ie_status_atend_w,
									cd_barras_p,
									nr_seq_frasco_w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ws_registrar_barras ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_amostra_p bigint, cd_barras_p text, nm_usuario_p text) FROM PUBLIC;

