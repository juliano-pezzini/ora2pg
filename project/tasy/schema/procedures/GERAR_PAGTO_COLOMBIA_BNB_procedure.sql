-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_pagto_colombia_bnb ( nr_seq_envio_p BANCO_ESCRITURAL.NR_SEQUENCIA%type, nm_usuario_p W_ENVIO_BANCO.NM_USUARIO%type ) AS $body$
DECLARE


ie_situacao_s               CONSTANT TITULO_PAGAR.IE_SITUACAO%type  := 'A';
cd_moeda_w                  TITULO_PAGAR.CD_MOEDA%type              := 1;
nr_seq_apres_w              W_ENVIO_BANCO.NR_SEQ_APRES%type         := 1;
ds_conteudo_w               varchar(197);

cd_estab_w                  varchar(14);
nr_client_w                 varchar(14);
nr_debit_account_w          varchar(10);
dt_file_emission_w          varchar(8);
qt_file_rows_w              varchar(6);
sum_currency_a1lowance_1_w  bigint;
sum_currency_allowance_2_w  bigint;
ds_empty_w                  varchar(137);

cd_estabelecimento_w        varchar(10);
ie_transaction_type_w       varchar(2);
ie_ident_type_doc_w         varchar(2);
nr_ident_doc_w              varchar(15);
nm_recepient_w              varchar(40);
dt_allowance_w              varchar(6);
ie_currency_allowance_w     varchar(1);
qt_allowance_w              varchar(13);
cd_bank_w                   varchar(4);
nr_account_w                varchar(20);
nr_recepient_phone_w        varchar(15);
nr_oficina_dest_transac_w   varchar(2);
cd_refer_transaction_w      varchar(15);
ds_transaction_w            varchar(60);
ie_allowance_type_w         varchar(2);

c01 CURSOR FOR
    SELECT  a.CD_ESTABELECIMENTO NR_CLIENT,
            CASE WHEN c.IE_TIPO_PAGAMENTO='DOC' THEN  1 WHEN c.IE_TIPO_PAGAMENTO='CC' THEN  2 WHEN c.IE_TIPO_PAGAMENTO='CCP' THEN  2 WHEN c.IE_TIPO_PAGAMENTO='CHQ' THEN  3 WHEN c.IE_TIPO_PAGAMENTO='TED' THEN  4 WHEN c.IE_TIPO_PAGAMENTO='OP' THEN  1 END        IE_TRANSACTION_TYPE,
            SUBSTR(CASE WHEN coalesce(d.CD_PESSOA_FISICA::text, '') = '' THEN  9  ELSE 1 END , 1, 2)                                        IE_IDENTIFICATION_TYPE_DOC,
            SUBSTR(CASE WHEN coalesce(d.CD_PESSOA_FISICA::text, '') = '' THEN  i.CD_RFC  ELSE g.NR_IDENTIDADE END , 1, 15)                  NR_IDENTIFICATION_DOC,
            SUBSTR(CASE WHEN coalesce(d.CD_PESSOA_FISICA::text, '') = '' THEN  i.DS_RAZAO_SOCIAL  ELSE g.NM_PESSOA_FISICA END , 1, 40)      NM_RECEPIENT,
            TO_CHAR(d.DT_VENCIMENTO_ATUAL, 'YYYYMM')                                                    DT_ALLOWANCE,
            SUBSTR(CASE WHEN d.CD_MOEDA=21 THEN  1  ELSE 2 END , 1, 1)                                                  IE_CURRENCY_ALLOWANCE,
            SUBSTR(c.VL_ESCRITURAL, 1, 13)                                                              QT_ALLOWANCE,
            SUBSTR(f.CD_BANCO_EXTERNO, 1, 4)                                                            CD_BANK,
            SUBSTR(c.NR_CONTA, 1, 20)                                                                   NR_ACCOUNT,
            SUBSTR(CASE WHEN coalesce(d.CD_PESSOA_FISICA::text, '') = '' THEN  i.NR_TELEFONE  ELSE g.NR_TELEFONE_CELULAR END , 1, 15)       NR_RECEPIENT_PHONE,
            SUBSTR(CASE WHEN coalesce(d.CD_PESSOA_FISICA::text, '') = '' THEN                 h.SG_ESTADO  ELSE (                    SELECT MAX(SG_ESTADO)                     FROM   PESSOA_JURIDICA_COMPL                     WHERE  CD_CGC = i.CD_CGC                ) END , 1, 2)                                                                               DS_OFICINA_DEST_TRANSACTION,
            SUBSTR(d.NR_NOSSO_NUMERO,1,15)                                                              CD_REFER_TRANSACTION,
            SUBSTR(coalesce(d.DS_OBSERVACAO_TITULO,' '), 1, 60)                                              DS_OBS_TRANSACTION,
            CASE WHEN d.IE_TIPO_TITULO=1 THEN  '10' WHEN d.IE_TIPO_TITULO=6 THEN  '07' WHEN d.IE_TIPO_TITULO=18 THEN  '08' WHEN d.IE_TIPO_TITULO=17 THEN  '09' WHEN d.IE_TIPO_TITULO=7 THEN  '11' WHEN d.IE_TIPO_TITULO=10 THEN  '12' WHEN d.IE_TIPO_TITULO=0 THEN  '10' END   IE_ALLOWANCE_TYPE
    FROM banco f, titulo_pagar_escrit c, banco_escritural b, banco_estabelecimento a, titulo_pagar d
LEFT OUTER JOIN pessoa_fisica g ON (d.CD_PESSOA_FISICA = g.CD_PESSOA_FISICA)
LEFT OUTER JOIN pessoa_juridica i ON (d.CD_CGC = i.CD_CGC)
LEFT OUTER JOIN compl_pessoa_fisica h ON (g.CD_PESSOA_FISICA = h.CD_PESSOA_FISICA)
WHERE 1                   = 1 AND a.NR_SEQUENCIA      = b.NR_SEQ_CONTA_BANCO AND a.CD_BANCO          = f.CD_BANCO AND (b.CD_ESTABELECIMENTO = a.CD_ESTABELECIMENTO OR OBTER_ESTAB_FINANCEIRO(b.CD_ESTABELECIMENTO) = a.CD_ESTABELECIMENTO) AND b.NR_SEQUENCIA      = c.NR_SEQ_ESCRIT AND c.NR_TITULO         = d.NR_TITULO    AND d.IE_SITUACAO       = ie_situacao_s AND b.NR_SEQUENCIA      = nr_seq_envio_p;


BEGIN

DELETE  FROM W_ENVIO_BANCO
WHERE   NM_USUARIO  = nm_usuario_p;

SELECT  a.CD_ESTABELECIMENTO            CD_ESTAB,
        a.NR_CONTRATO                   NR_CLIENT,
        a.CD_CONTA                      NR_ACCOUNT,
        TO_CHAR(clock_timestamp(), 'YYYYMMDD')    DT_FILE,
        d.CD_MOEDA,
        SUM(coalesce(c.VL_ESCRITURAL, 0))    SUM_CURRENCY_ALLOWANCE_1,
        SUM(coalesce(c.VL_ESCRITURAL, 0))    SUM_CURRENCY_ALLOWANCE_2,
        RPAD(' ', 136, ' ')             DS_EMPTY
INTO STRICT    cd_estab_w,
        nr_client_w,
        nr_debit_account_w,
        dt_file_emission_w,
        cd_moeda_w,
        sum_currency_a1lowance_1_w,
        sum_currency_allowance_2_w,
        ds_empty_w
FROM    BANCO_ESTABELECIMENTO a,
        BANCO_ESCRITURAL b,
        TITULO_PAGAR_ESCRIT c,
        TITULO_PAGAR d
WHERE   a.NR_SEQUENCIA          = b.NR_SEQ_CONTA_BANCO
AND (b.CD_ESTABELECIMENTO   = a.CD_ESTABELECIMENTO OR OBTER_ESTAB_FINANCEIRO(b.CD_ESTABELECIMENTO) = a.CD_ESTABELECIMENTO)
AND     b.NR_SEQUENCIA          = c.NR_SEQ_ESCRIT
AND     c.NR_TITULO             = d.NR_TITULO
AND     d.IE_SITUACAO           = ie_situacao_s
AND     b.NR_SEQUENCIA          = nr_seq_envio_p
GROUP BY a.CD_ESTABELECIMENTO,
         a.NR_CONTRATO,
         a.CD_CONTA,
         TO_CHAR(clock_timestamp(), 'YYYYMMDD'),
         d.CD_MOEDA;

SELECT  COUNT(1)
INTO STRICT    qt_file_rows_w
FROM    BANCO_ESTABELECIMENTO a,
        BANCO_ESCRITURAL b,
        TITULO_PAGAR_ESCRIT c,
        TITULO_PAGAR d
WHERE   a.NR_SEQUENCIA          = b.NR_SEQ_CONTA_BANCO
AND (b.CD_ESTABELECIMENTO = a.CD_ESTABELECIMENTO OR OBTER_ESTAB_FINANCEIRO(b.CD_ESTABELECIMENTO) = a.CD_ESTABELECIMENTO)
AND     b.NR_SEQUENCIA          = c.NR_SEQ_ESCRIT
AND     c.NR_TITULO             = d.NR_TITULO
AND     d.IE_SITUACAO           = ie_situacao_s
AND     b.NR_SEQUENCIA          = nr_seq_envio_p;

ds_conteudo_w   :=  SUBSTR(coalesce(nr_client_w, 0), 1, 14)                          ||
                    LPAD(SUBSTR(coalesce(nr_debit_account_w, ' '), 1, 10), 10, '0')  ||
                    dt_file_emission_w                                          ||
                    LPAD(qt_file_rows_w, 6, '0');

IF (cd_moeda_w = 21) THEN
    ds_conteudo_w   :=  ds_conteudo_w                                                               ||
                        LPAD(SUBSTR(SOMENTE_NUMERO(sum_currency_a1lowance_1_w), 1, 13), 13, '0')    ||
                        LPAD(0, 13, '0');
ELSIF (cd_moeda_w = 3) THEN
    ds_conteudo_w   :=  ds_conteudo_w       ||
                        LPAD(0, 13, '0')    ||
                        LPAD(SUBSTR(SOMENTE_NUMERO(sum_currency_allowance_2_w), 1, 13), 13, '0');
END IF;

ds_conteudo_w   :=  ds_conteudo_w ||
                    ds_empty_w;

INSERT INTO W_ENVIO_BANCO(
    CD_ESTABELECIMENTO,
    DS_CONTEUDO,
    DT_ATUALIZACAO,
    NM_USUARIO,
    NR_SEQ_APRES,
    NR_SEQ_APRES_2,
    NR_SEQUENCIA
) VALUES (
    cd_estab_w,
    ds_conteudo_w,
    clock_timestamp(),
    nm_usuario_p,
    nr_seq_apres_w,
    nr_seq_apres_w,
    nextval('w_envio_banco_seq')
);

OPEN c01;
LOOP
FETCH c01 INTO
    cd_estabelecimento_w,
    ie_transaction_type_w,
    ie_ident_type_doc_w,
    nr_ident_doc_w,
    nm_recepient_w,
    dt_allowance_w,
    ie_currency_allowance_w,
    qt_allowance_w,
    cd_bank_w,
    nr_account_w,
    nr_recepient_phone_w,
    nr_oficina_dest_transac_w,
    cd_refer_transaction_w,
    ds_transaction_w,
    ie_allowance_type_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

    nr_seq_apres_w  :=  coalesce(nr_seq_apres_w, 0) + 1;

    ds_conteudo_w   :=  LPAD(ie_transaction_type_w, 2, '0')             ||
                        LPAD(ie_ident_type_doc_w, 2, '0')               ||
                        RPAD(nr_ident_doc_w, 15, ' ')                   ||
                        RPAD(UPPER(nm_recepient_w), 40, ' ')            ||
                        dt_allowance_w                                  ||
                        ie_currency_allowance_w                         ||
                        LPAD(SOMENTE_NUMERO(qt_allowance_w), 13, '0')   ||
                        cd_bank_w;

    IF (ie_transaction_type_w = 3) THEN
        ds_conteudo_w   :=  ds_conteudo_w ||
                            RPAD(' ', 20, ' ');
    ELSE
        ds_conteudo_w   :=  ds_conteudo_w ||
                            RPAD(coalesce(nr_account_w, ' '), 20, ' ');
    END IF;

    IF (ie_transaction_type_w = 2 OR ie_transaction_type_w = 3) THEN
        ds_conteudo_w   :=  ds_conteudo_w                           ||
                            LPAD(nr_recepient_phone_w, 15, 0)       ||
                            LPAD(nr_oficina_dest_transac_w, 2, 0);
    ELSE
        ds_conteudo_w   :=  ds_conteudo_w ||
                            LPAD(0, 17, 0);
    END IF;

    ds_conteudo_w   :=  ds_conteudo_w                                   ||
                        RPAD(coalesce(cd_refer_transaction_w,' '),15,' ')    ||
                        RPAD(UPPER(ds_transaction_w),60,' ')            ||
                        LPAD(ie_allowance_type_w,2,'0');

    INSERT  INTO W_ENVIO_BANCO(
        CD_ESTABELECIMENTO,
        DS_CONTEUDO,
        DT_ATUALIZACAO,
        NM_USUARIO,
        NR_SEQ_APRES,
        NR_SEQ_APRES_2,
        NR_SEQUENCIA
    ) values (
        cd_estabelecimento_w,
        ds_conteudo_w,
        clock_timestamp(),
        nm_usuario_p,
        nr_seq_apres_w,
        nr_seq_apres_w,
        nextval('w_envio_banco_seq')
    );

END LOOP;
CLOSE c01;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_pagto_colombia_bnb ( nr_seq_envio_p BANCO_ESCRITURAL.NR_SEQUENCIA%type, nm_usuario_p W_ENVIO_BANCO.NM_USUARIO%type ) FROM PUBLIC;

