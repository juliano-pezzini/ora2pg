-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_dados_cep_inc_benef (cd_cep_p INOUT text, nm_usuario_p text, nm_logradouro_p INOUT text, nm_localidade_p INOUT text, ds_bairro_p INOUT text, ds_uf_p INOUT text, cd_municipio_ibge_p INOUT text, nr_seq_regiao_p INOUT bigint) AS $body$
DECLARE


nm_logradouro_w		varchar(255);
nm_localidade_w		varchar(255);
ds_bairro_w		varchar(255);
ds_uf_w			valor_dominio.vl_dominio%type;
cd_cep_w		varchar(255);
cd_municipio_ibge_w	varchar(255);
nr_seq_regiao_w		bigint;


BEGIN
if (cd_cep_p IS NOT NULL AND cd_cep_p::text <> '') then
	select 	a.nm_logradouro log,
		b.nm_localidade loc,
		c.ds_bairro bairro,
		a.ds_uf uf,
		a.cd_cep cep,
		c.nr_seq_regiao reg
	into STRICT	nm_logradouro_w,
		nm_localidade_w,
		ds_bairro_w,
		ds_uf_w,
		cd_cep_w,
		nr_seq_regiao_w
	from 	cep_loc b,
		cep_bairro c,
		cep_log a
	where  b.nr_sequencia     = c.nr_seq_loc
	and   a.cd_bairro_inicial = c.nr_sequencia
	and   b.nr_sequencia      = a.nr_seq_loc
	and   a.cd_cep            = cd_cep_p;

	if (coalesce(cd_cep_w::text, '') = '') then
		select 	b.nm_localidade loc,
			b.ds_uf uf,
			b.cd_cep cep
		into STRICT	nm_localidade_w,
			ds_uf_w,
			cd_cep_w
		from   	cep_loc b
		where 	b.cd_cep = cd_cep_p;
	end if;

	select	max(cd_municipio_ibge) cd_municipio_ibge
	into STRICT	cd_municipio_ibge_w
	from (SELECT	cd_municipio_ibge
		from	cep_municipio
		where	cd_cep = cd_cep_w
		
union

		SELECT	cd_municipio_ibge
		from	sus_cep
		where	cd_cep = cd_cep_w) alias1;
end if;

nm_logradouro_p 	:= nm_logradouro_w;
nm_localidade_p		:= nm_localidade_w;
ds_bairro_p 		:= ds_bairro_w;
ds_uf_p			:= ds_uf_w;
cd_cep_p		:= cd_cep_w;
nr_seq_regiao_p 	:= nr_seq_regiao_w;
cd_municipio_ibge_p	:= cd_municipio_ibge_w;

/* Sem commit */

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_dados_cep_inc_benef (cd_cep_p INOUT text, nm_usuario_p text, nm_logradouro_p INOUT text, nm_localidade_p INOUT text, ds_bairro_p INOUT text, ds_uf_p INOUT text, cd_municipio_ibge_p INOUT text, nr_seq_regiao_p INOUT bigint) FROM PUBLIC;

