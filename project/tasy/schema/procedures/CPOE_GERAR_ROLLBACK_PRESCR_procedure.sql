-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_rollback_prescr (ds_lista_p text, nm_usuario_p text) AS $body$
DECLARE


ds_lista_w				varchar(2000);
item_w					varchar(255);
ie_opcao_prescr_w		varchar(255);
nr_seq_reg_item_w		cpoe_material.nr_sequencia%type;
ds_log_w				varchar(4000) := '';
nr_seq_cpoe_anterior_w	cpoe_material.nr_seq_cpoe_anterior%type;
nr_seq_receita_amb_w    cpoe_material.nr_seq_receita_amb%type;

BEGIN

ds_lista_w := substr(ds_lista_p,1,2000);



while(ds_lista_w IS NOT NULL AND ds_lista_w::text <> '')  loop

	if (position(';' in ds_lista_w) = 0) and (ds_lista_w IS NOT NULL AND ds_lista_w::text <> '') then
		ds_lista_w	:= ds_lista_w||';';
	end if;
	
	item_w := substr(ds_lista_w, 1, position(';' in ds_lista_w) - 1);
	ie_opcao_prescr_w := substr(item_w, 1, position(',' in item_w) - 1);
	nr_seq_reg_item_w := (substr(item_w, position(',' in item_w) + 1, length(item_w)))::numeric;
	ds_lista_w := substr(ds_lista_w, position(';' in ds_lista_w) + 1, length(ds_lista_w));
	
	if (ie_opcao_prescr_w IS NOT NULL AND ie_opcao_prescr_w::text <> '') and (nr_seq_reg_item_w IS NOT NULL AND nr_seq_reg_item_w::text <> '') then
	
		case ie_opcao_prescr_w
			when 'MA' then
			begin
			
				select  coalesce(max(nr_seq_cpoe_anterior),0)
				into STRICT    nr_seq_cpoe_anterior_w
				from    cpoe_material
				where   nr_sequencia = nr_seq_reg_item_w;
				
				if (nr_seq_cpoe_anterior_w > 0) then		
					update	cpoe_material
					set	dt_lib_suspensao  = NULL,
						dt_suspensao  = NULL,
						nm_usuario_susp  = NULL
					where nr_sequencia = nr_seq_cpoe_anterior_w;
				end if;		
				
				update	cpoe_material
				set		dt_liberacao	 = NULL
				where	nr_sequencia	= nr_seq_reg_item_w;
				
				delete from cpoe_revalidation_events
				where nr_seq_material = nr_seq_reg_item_w;
				
				ds_log_w := substr(ds_log_w||';MA'||nr_seq_reg_item_w,1,4000);
			
			end;
			when 'M' then
			begin
			
				select  coalesce(max(nr_seq_cpoe_anterior),0),
						coalesce(max(nr_seq_receita_amb),null)
				into STRICT    nr_seq_cpoe_anterior_w,
						nr_seq_receita_amb_w
				from    cpoe_material
				where   nr_sequencia = nr_seq_reg_item_w;
				
				if (coalesce(nr_seq_receita_amb_w::text, '') = '') then
					if (nr_seq_cpoe_anterior_w > 0) then		
						update	cpoe_material
						set	dt_lib_suspensao  = NULL,
							dt_suspensao  = NULL,
							nm_usuario_susp  = NULL
						where nr_sequencia = nr_seq_cpoe_anterior_w;
					end if;		

					update	cpoe_material
					set		dt_liberacao	 = NULL
					where	nr_sequencia	= nr_seq_reg_item_w;
					
					delete from cpoe_revalidation_events
					where nr_seq_material = nr_seq_reg_item_w;
				
					ds_log_w := substr(ds_log_w||';M'||nr_seq_reg_item_w,1,4000);
				end if;
			end;
			when 'N' then --Nutricao
			begin
			
				select  coalesce(max(nr_seq_cpoe_anterior),0)
				into STRICT    nr_seq_cpoe_anterior_w
				from    cpoe_dieta
				where   nr_sequencia = nr_seq_reg_item_w;
				
				if (nr_seq_cpoe_anterior_w > 0) then		
					update	cpoe_dieta
					set	dt_lib_suspensao  = NULL,
						dt_suspensao  = NULL,
						nm_usuario_susp  = NULL
					where nr_sequencia = nr_seq_cpoe_anterior_w;
				end if;
				
				update	cpoe_dieta
				set	dt_liberacao  = NULL
				where	nr_sequencia = nr_seq_reg_item_w;	
				
				delete from cpoe_revalidation_events
				where nr_seq_diet = nr_seq_reg_item_w;
				
				ds_log_w := substr(ds_log_w||';N'||nr_seq_reg_item_w,1,4000);
			
			end;
			when 'P' then --Procedimentos
			begin
			
				select  max(nr_seq_cpoe_anterior)
				into STRICT    nr_seq_cpoe_anterior_w
				from    cpoe_procedimento
				where   nr_sequencia = nr_seq_reg_item_w;
				
				if (nr_seq_cpoe_anterior_w > 0) then		
					update	cpoe_procedimento
					set	dt_lib_suspensao  = NULL,
						dt_suspensao  = NULL,
						nm_usuario_susp  = NULL
					where nr_sequencia = nr_seq_cpoe_anterior_w;
				end if;
			
				update  cpoe_procedimento
				set		dt_liberacao  = NULL
				where   nr_sequencia = nr_seq_reg_item_w;
				
				delete from cpoe_revalidation_events
				where nr_seq_exam = nr_seq_reg_item_w;
				
				ds_log_w := substr(ds_log_w||';P'||nr_seq_reg_item_w,1,4000);
			
			end;
			when 'G' then --Gasoterapia
			begin
			
				select  max(nr_seq_cpoe_anterior)
				into STRICT    nr_seq_cpoe_anterior_w
				from    cpoe_gasoterapia
				where   nr_sequencia = nr_seq_reg_item_w;
				
				if (nr_seq_cpoe_anterior_w > 0) then		
					update	cpoe_gasoterapia
					set	dt_lib_suspensao  = NULL,
						dt_suspensao  = NULL,
						nm_usuario_susp  = NULL
					where nr_sequencia = nr_seq_cpoe_anterior_w;
				end if;
			
				update  cpoe_gasoterapia
				set		dt_liberacao  = NULL
				where   nr_sequencia = nr_seq_reg_item_w;
				
				delete from cpoe_revalidation_events
				where nr_seq_gasotherapy = nr_seq_reg_item_w;
				
				ds_log_w := substr(ds_log_w||';G'||nr_seq_reg_item_w,1,4000);
			
			end;
			when 'R' then --Recomendacao
			begin
			
				select  max(nr_seq_cpoe_anterior)
				into STRICT    nr_seq_cpoe_anterior_w
				from    cpoe_recomendacao
				where   nr_sequencia = nr_seq_reg_item_w;	
				
				if (nr_seq_cpoe_anterior_w > 0) then		
					update	cpoe_recomendacao
					set		dt_lib_suspensao  = NULL,
							dt_suspensao  = NULL,
							nm_usuario_susp  = NULL
					where 	nr_sequencia = nr_seq_cpoe_anterior_w;
				end if;
			
				update  cpoe_recomendacao
				set		dt_liberacao  = NULL
				where   nr_sequencia = nr_seq_reg_item_w;
				
				delete from cpoe_revalidation_events
				where nr_seq_recomendation = nr_seq_reg_item_w;
				
				ds_log_w := substr(ds_log_w||';R'||nr_seq_reg_item_w,1,4000);
			
			end;
			when 'H' then --Hemoterapia
			begin
			
				select  max(nr_seq_cpoe_anterior)
				into STRICT    nr_seq_cpoe_anterior_w
				from    cpoe_hemoterapia
				where   nr_sequencia = nr_seq_reg_item_w;
				
				if (nr_seq_cpoe_anterior_w > 0) then		
					update	cpoe_hemoterapia
					set		dt_lib_suspensao  = NULL,
							dt_suspensao  = NULL,
							nm_usuario_susp  = NULL
					where 	nr_sequencia = nr_seq_cpoe_anterior_w;
				end if;
			
				update  cpoe_hemoterapia
				set		dt_liberacao  = NULL
				where   nr_sequencia = nr_seq_reg_item_w;
				
				delete from cpoe_revalidation_events
				where nr_seq_hemotherapy = nr_seq_reg_item_w;
				
				ds_log_w := substr(ds_log_w||';H'||nr_seq_reg_item_w,1,4000);
			
			end;
			when 'DI' then --Dialysis
			begin
			
				select  max(nr_seq_cpoe_anterior)
				into STRICT    nr_seq_cpoe_anterior_w
				from    cpoe_dialise
				where   nr_sequencia = nr_seq_reg_item_w;
			
				if (nr_seq_cpoe_anterior_w > 0) then		
					update	cpoe_dialise
					set		dt_lib_suspensao  = NULL,
							dt_suspensao  = NULL,
							nm_usuario_susp  = NULL
					where 	nr_sequencia = nr_seq_cpoe_anterior_w;
				end if;
			
				update  cpoe_dialise
				set		dt_liberacao  = NULL
				where   nr_sequencia = nr_seq_reg_item_w;
				
				delete from cpoe_revalidation_events
				where nr_seq_dialysis = nr_seq_reg_item_w;
				
				ds_log_w := substr(ds_log_w||';DI'||nr_seq_reg_item_w,1,4000);
			
			end;
			when 'DP' then --Dialysis
			begin
			
				select  max(nr_seq_cpoe_anterior)
				into STRICT    nr_seq_cpoe_anterior_w
				from    cpoe_dialise
				where   nr_sequencia = nr_seq_reg_item_w;
				
				if (nr_seq_cpoe_anterior_w > 0) then		
					update	cpoe_dialise
					set		dt_lib_suspensao  = NULL,
							dt_suspensao  = NULL,
							nm_usuario_susp  = NULL
					where 	nr_sequencia = nr_seq_cpoe_anterior_w;
				end if;
			
				update  cpoe_dialise
				set		dt_liberacao  = NULL
				where   nr_sequencia = nr_seq_reg_item_w;
				
				delete from cpoe_revalidation_events
				where nr_seq_dialysis = nr_seq_reg_item_w;
				
				ds_log_w := substr(ds_log_w||';DP'||nr_seq_reg_item_w,1,4000);
			
			end;
			when 'AP' then --Anatomia Patologica
			begin
			
				select  max(nr_seq_cpoe_anterior)
				into STRICT    nr_seq_cpoe_anterior_w
				from    cpoe_anatomia_patologica
				where   nr_sequencia = nr_seq_reg_item_w;
				
				if (nr_seq_cpoe_anterior_w > 0) then		
					update	cpoe_anatomia_patologica
					set		dt_lib_suspensao  = NULL,
							dt_suspensao  = NULL,
							nm_usuario_susp  = NULL
					where 	nr_sequencia = nr_seq_cpoe_anterior_w;
				end if;
			
				update  cpoe_anatomia_patologica
				set		dt_liberacao  = NULL
				where   nr_sequencia = nr_seq_reg_item_w;
				
				ds_log_w := substr(ds_log_w||';AP'||nr_seq_reg_item_w,1,4000);
			
			end;
		end case;	
	end if;

end loop;
if (coalesce(nr_seq_receita_amb_w::text, '') = '') then
	CALL gravar_log_tasy(10007,'Rollback Prescricao - '||ds_log_w,nm_usuario_p);
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_rollback_prescr (ds_lista_p text, nm_usuario_p text) FROM PUBLIC;

