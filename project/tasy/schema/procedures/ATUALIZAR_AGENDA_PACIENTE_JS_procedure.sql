-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_agenda_paciente_js ( nr_seq_agenda_p bigint, ie_atual_conv_agenda_pac_p text, nr_atendimento_p bigint, cd_convenio_p bigint, cd_categoria_p bigint, cd_plano_p bigint, cd_tipo_agenda_p bigint, ie_agenda_nova_p text, ie_gestao_agenda_p text, ie_param_func_ext_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


ie_evento_e_w		varchar(1);
ie_evento_ci_w		varchar(1);
nr_seq_agenda_int_w	bigint;


BEGIN

if (nr_seq_agenda_p <> 0)then
	begin

	if (ie_atual_conv_agenda_pac_p = 'S')then
		begin

		update 	agenda_paciente
		set 	nr_atendimento 	= nr_atendimento_p,
			cd_convenio    	= cd_convenio_p,
			cd_categoria   	= cd_categoria_p,
			cd_plano       	= cd_plano_p,
			nm_usuario     	= nm_usuario_p
		where 	nr_sequencia 	= nr_seq_agenda_p;

		end;
	else
		begin

		update 	agenda_paciente
		set 	nr_atendimento = nr_atendimento_p
		where 	nr_sequencia 	= nr_seq_agenda_p;

		end;
	end if;

	ie_evento_e_w	:= obter_se_existe_evento_agenda(cd_estabelecimento_p,'GA','E');
	ie_evento_ci_w	:= obter_se_existe_evento_agenda(cd_estabelecimento_p,'GA','CI');

	if	(((cd_tipo_agenda_p = 2) and
		  ((ie_agenda_nova_p = 'N') or (ie_evento_e_w = 'N'))) or
		((cd_tipo_agenda_p = 1) and
		 ((ie_gestao_agenda_p = 'N') or (ie_evento_ci_w = 'N'))))then
		begin

		if (ie_param_func_ext_p = 'S')then
			begin

			update 	agenda_paciente
			set 	ie_status_agenda = 'E'
			where 	nr_sequencia = nr_seq_agenda_p;

			end;
		end if;

		end;
	end if;

	update 	autorizacao_convenio
	set   	nr_atendimento  = nr_atendimento_p
        where 	nr_seq_agenda 	= nr_seq_agenda_p
	and   	coalesce(nr_atendimento::text, '') = '';

	--trecho de c√≥digo comentado na OS 909793 - 06/10/2015
	/*select  max(a.nr_seq_agenda_int)
	into	nr_seq_agenda_int_w
	from    autorizacao_convenio b,
		agenda_integrada_item a
	where   a.nr_seq_agenda_int = b.nr_seq_age_integ
	and     a.nr_seq_agenda_exame = nr_seq_agenda_p;

	if	(nr_seq_agenda_int_w <> 0)then
		begin

		update   autorizacao_convenio
		set      nr_atendimento = nr_atendimento_p
		where    nr_seq_age_integ = nr_seq_agenda_int_w
		and      nr_atendimento is null;

		end;
	end if;*/
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_agenda_paciente_js ( nr_seq_agenda_p bigint, ie_atual_conv_agenda_pac_p text, nr_atendimento_p bigint, cd_convenio_p bigint, cd_categoria_p bigint, cd_plano_p bigint, cd_tipo_agenda_p bigint, ie_agenda_nova_p text, ie_gestao_agenda_p text, ie_param_func_ext_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

