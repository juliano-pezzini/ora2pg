-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE excluir_taxa_sala_cirurgica (CD_ESTABELECIMENTO_P bigint, NR_ATENDIMENTO_P bigint, DT_ENTRADA_UNIDADE_P timestamp, NR_CIRURGIA_P bigint, CD_CONVENIO_P bigint, CD_CATEGORIA_P text) AS $body$
DECLARE

dt_atualizacao_w        	timestamp			:= clock_timestamp();
dt_final_cirurgia_w        	timestamp			:= clock_timestamp();
cd_taxa_pri_horario_w       	bigint  		:= 0;
cd_taxa_seg_horario_w       	bigint  		:= 0;
ie_origem_proced_w       	bigint  		:= 0;
ie_flag_ok              	varchar(1)   		:= 'S';
nr_seq_proc_int_pri_w		bigint;
nr_seq_proc_int_seg_w		bigint;
ie_situacao_w			varchar(1);


BEGIN
/* Obter o codigo do servico da taxa de sala cirurgica(Primeiro Horario) */

begin
select		cd_taxa_servico,
		ie_origem_proced,
		nr_seq_proc_interno
into STRICT		cd_taxa_pri_horario_w,
		ie_origem_proced_w,
		nr_seq_proc_int_pri_w
from		convenio_taxa_servico
where		cd_estabelecimento	= cd_estabelecimento_p
and		cd_convenio		= cd_convenio_p
and		cd_categoria		= cd_categoria_p
and		ie_taxa_servico		= 3
and		coalesce(ie_situacao, 'A')	= 'A';
exception
     when others then
          ie_flag_ok := 'N';
end;

/* Obter o codigo do servico da taxa de sala cirurgica(Segundo Horario) */

if (ie_flag_ok = 'S') then
	begin
	select		cd_taxa_servico,
			nr_seq_proc_interno
	into STRICT		cd_taxa_seg_horario_w,
			nr_seq_proc_int_seg_w
	from		convenio_taxa_servico
	where		cd_estabelecimento	= cd_estabelecimento_p
	and		cd_convenio		= cd_convenio_p
	and		cd_categoria		= cd_categoria_p
	and		ie_taxa_servico		= 4
	and		coalesce(ie_situacao, 'A')	= 'A';
	exception
     		when others then
          	ie_flag_ok := 'N';
	end;
end if;

/* Obter dados da cirurgia */

if (ie_flag_ok = 'S') then
	begin
	select		dt_termino
	into STRICT		dt_final_cirurgia_w
	from		cirurgia
	where		nr_cirurgia	= nr_cirurgia_p;
	exception
     		when others then
          	ie_flag_ok := 'N';
	end;
end if;


/* Excluir taxa cirurgia Primeiro Horario*/

if (ie_flag_ok = 'S') then
     begin
     	delete  from procedimento_paciente
     	where   nr_atendimento 		= nr_atendimento_p
	and	dt_entrada_unidade 	= dt_entrada_unidade_p
	and	((cd_procedimento 	= cd_taxa_pri_horario_w) or (nr_seq_proc_interno	= nr_seq_proc_int_pri_w))
	and	dt_procedimento		= dt_final_cirurgia_w;
     end;
end if;

/* Excluir taxa cirurgia Segundo Horario*/

if (ie_flag_ok = 'S') then
     begin
     	delete  from procedimento_paciente
     	where   nr_atendimento 		= nr_atendimento_p
	and	dt_entrada_unidade 	= dt_entrada_unidade_p
	and	((cd_procedimento 	= cd_taxa_seg_horario_w) or (nr_seq_proc_interno	= nr_seq_proc_int_seg_w))
	and	dt_procedimento		= dt_final_cirurgia_w;
     end;
end if;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE excluir_taxa_sala_cirurgica (CD_ESTABELECIMENTO_P bigint, NR_ATENDIMENTO_P bigint, DT_ENTRADA_UNIDADE_P timestamp, NR_CIRURGIA_P bigint, CD_CONVENIO_P bigint, CD_CATEGORIA_P text) FROM PUBLIC;

