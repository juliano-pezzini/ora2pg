-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_define_conta_aih ( nr_atendimento_p bigint, nr_aih_p bigint, nr_seq_aih_p bigint, nr_interno_conta_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_atendimento_w		bigint;
nr_interno_conta_w		bigint	:= 0;
cd_convenio_w		integer;
nr_interno_conta_ww	bigint	:= 0;


BEGIN 
 
select	max(a.cd_convenio) 
into STRICT	cd_convenio_w 
from	atend_categoria_convenio	a, 
	convenio			c 
where	c.cd_convenio	= a.cd_convenio 
and	c.ie_tipo_convenio	= 3 
and	a.nr_atendimento	= nr_atendimento_p;
		 
select	coalesce(max(a.nr_interno_conta),0) 
into STRICT	nr_interno_conta_w 
from 	conta_paciente	a 
where 	a.nr_atendimento 	= nr_atendimento_p 
and	a.cd_convenio_parametro	= cd_convenio_w 
and	a.ie_status_acerto	= 1 
and	a.nr_interno_conta not in (	SELECT	x.nr_interno_conta 
				from 	sus_aih_unif	x 
				where 	x.nr_interno_conta 	= a.nr_interno_conta 
				and	x.nr_atendimento	= nr_atendimento_p);
					 
begin 
select	nr_interno_conta 
into STRICT	nr_interno_conta_ww 
from	conta_paciente 
where	nr_interno_conta 	= nr_interno_conta_p 
and	nr_atendimento 	= nr_atendimento_p 
and	ie_status_acerto 	= 1 
and	coalesce(ie_cancelamento::text, '') = '';
exception 
when others then 
	nr_interno_conta_ww := 0;
end;					
					 
if (coalesce(nr_interno_conta_ww,0) > 0) then 
	update	sus_aih_unif 
	set	nr_interno_conta	= nr_interno_conta_ww 
	where	nr_aih			= nr_aih_p 
	and	nr_sequencia		= nr_seq_aih_p 
	and	nr_atendimento		= nr_atendimento_p;
	commit;
elsif (nr_interno_conta_w > 0) then 
	update	sus_aih_unif 
	set	nr_interno_conta	= nr_interno_conta_w 
	where	nr_aih			= nr_aih_p 
	and	nr_sequencia		= nr_seq_aih_p 
	and	nr_atendimento		= nr_atendimento_p;
	commit;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_define_conta_aih ( nr_atendimento_p bigint, nr_aih_p bigint, nr_seq_aih_p bigint, nr_interno_conta_p bigint, nm_usuario_p text) FROM PUBLIC;

