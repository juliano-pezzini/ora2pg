-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE carregar_material_convenio ( CD_CONVENIO_P bigint, CD_MAT_CON_P text, NM_USUARIO_P text, CD_MATERIAL_P bigint, DS_MAT_CON_P text, CD_GRUPO_P text, TX_CONV_QT_P bigint, CD_UNID_CO_P text, CD_SETOR_A_P bigint, CD_CGC_P text, NR_SEQ_MARCA_P bigint, IE_TIPO_ATEND_P text, DT_INI_VIG_P text, CD_CATEGOR_P text, CD_ESTAB_P bigint, qt_erros_p INOUT bigint, qt_nao_importados_p INOUT bigint ) AS $body$
DECLARE

ie_categoria_w  boolean := true;
nr_seq_marca_w conversao_material_convenio.nr_seq_marca%type;
qt_marca_w bigint;
qt_cat_conv_w bigint;
qt_conv_mat_conv_w bigint;
qt_material_w bigint;


BEGIN
	qt_erros_p := 0;
	qt_nao_importados_p :=0;
	nr_seq_marca_w := NR_SEQ_MARCA_P;

	if (NR_SEQ_MARCA_P IS NOT NULL AND NR_SEQ_MARCA_P::text <> '') then
		begin
			select 	count(1)
			into STRICT 	qt_marca_w
			from 	marca
			where 	nr_sequencia = NR_SEQ_MARCA_P;
		exception
		when others then
			qt_erros_p := qt_erros_p +1;
			qt_marca_w :=0;
		end;
		if (qt_marca_w = 0) then
			nr_seq_marca_w := NULL;
		end if;
	end if;

	begin
		select 	count(1)
		into STRICT 	qt_cat_conv_w
		from 	categoria_convenio
		where 	cd_convenio = CD_CONVENIO_P
		and 	cd_categoria = CD_CATEGOR_P;
	exception
	when others then
		qt_erros_p := qt_erros_p +1;
		qt_cat_conv_w := 0;
	end;

	if (qt_cat_conv_w = 0) then
		ie_categoria_w := false;
	end if;

	begin
		select 	count(1)
		into STRICT 	qt_conv_mat_conv_w
		from 	conversao_material_convenio
		where	cd_material_convenio = CD_MAT_CON_P
		and		cd_material = CD_MATERIAL_P
		and		ds_material_convenio = DS_MAT_CON_P
		and		((cd_categoria = CD_CATEGOR_P) or (coalesce(CD_CATEGOR_P,0) = 0));
	exception
	when others then
		qt_erros_p := qt_erros_p +1;
		qt_conv_mat_conv_w := 0;
	end;

	begin
		select 	count(1)
		into STRICT 	qt_material_w
		from 	material
		where	cd_material = CD_MATERIAL_P;
	exception
	when others then
		qt_erros_p := qt_erros_p +1;
		qt_material_w := 0;
	end;

	IF ((qt_material_w <> 0) AND (CD_MATERIAL_P <> 0) AND (qt_conv_mat_conv_w = 0) AND (coalesce(CD_MAT_CON_P,'X') <> 'X') AND (ie_categoria_w)) THEN
			begin
				insert into conversao_material_convenio(
					nr_sequencia,
					cd_convenio,
					cd_material_convenio,
					dt_atualizacao,
					nm_usuario,
					cd_grupo_material,
					cd_subgrupo_material,
					cd_classe_material,
					cd_material,
					ds_material_convenio,
					cd_grupo,
					tx_conversao_qtde,
					cd_unidade_convenio,
					cd_setor_atendimento,
					cd_cgc,
					ie_situacao,
					nr_seq_marca,
					ie_tipo_atendimento,
					dt_inicio_vigencia,
					cd_categoria,
					cd_estabelecimento
				)
				values (
					nextval('conversao_mat_convenio_seq'),
					CD_CONVENIO_P,
					CD_MAT_CON_P,
					clock_timestamp(),
					NM_USUARIO_P,
					null,
					null,
					null,
					CD_MATERIAL_P,
					DS_MAT_CON_P,
					CD_GRUPO_P,
					TX_CONV_QT_P,
					CD_UNID_CO_P,
					CD_SETOR_A_P,
					CD_CGC_P,
					'A',
					nr_seq_marca_w,
					IE_TIPO_ATEND_P,
					to_date(DT_INI_VIG_P, 'yyyyMMdd'),
					CD_CATEGOR_P,
					CD_ESTAB_P
				);
				commit;
			exception
			when others then
				qt_nao_importados_p := qt_nao_importados_p +1;
			end;
		end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE carregar_material_convenio ( CD_CONVENIO_P bigint, CD_MAT_CON_P text, NM_USUARIO_P text, CD_MATERIAL_P bigint, DS_MAT_CON_P text, CD_GRUPO_P text, TX_CONV_QT_P bigint, CD_UNID_CO_P text, CD_SETOR_A_P bigint, CD_CGC_P text, NR_SEQ_MARCA_P bigint, IE_TIPO_ATEND_P text, DT_INI_VIG_P text, CD_CATEGOR_P text, CD_ESTAB_P bigint, qt_erros_p INOUT bigint, qt_nao_importados_p INOUT bigint ) FROM PUBLIC;

