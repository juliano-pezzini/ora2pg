-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE estornar_movto_cartao_baixa ( nr_seq_baixa_p bigint, nm_usuario_p text, ie_gerar_movto_baixa_p text, ie_commit_p text, dt_estorno_p timestamp default null) AS $body$
DECLARE

 
nr_sequencia_w		bigint;
nr_seq_conta_banco_w	bigint;
nr_seq_trans_financ_w	bigint;
nr_seq_movto_w		bigint;
nr_seq_trans_fin_desp_w	bigint;
vl_total_baixa_w		double precision;
vl_baixa_w		double precision;
nr_seq_parcela_w		bigint;


BEGIN 
 
select	nextval('movto_cartao_cr_baixa_seq') 
into STRICT	nr_sequencia_w
;
 
select	coalesce(max(vl_baixa * -1),0), 
	max(nr_seq_parcela) 
into STRICT	vl_baixa_w, 
	nr_seq_parcela_w 
from	movto_cartao_cr_baixa 
where	nr_sequencia	= nr_seq_baixa_p;
 
select	coalesce(sum(a.vl_baixa),0) 
into STRICT	vl_total_baixa_w 
from	movto_cartao_cr_baixa a 
where	a.nr_seq_parcela	= nr_seq_parcela_w;
 
if	((vl_total_baixa_w + vl_baixa_w) < 0) then 
	--'O valor total das baixas nÃ£o pode ser negativo!'); 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(95962);
else 
	insert into movto_cartao_cr_baixa(nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_seq_movto, 
		dt_baixa, 
		vl_baixa, 
		nr_seq_conta_banco, 
		nr_seq_trans_financ, 
		ds_observacao, 
		nr_seq_parcela, 
		vl_despesa, 
		vl_desp_equip, 
		nr_seq_baixa_orig) 
	SELECT	nr_sequencia_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_seq_movto, 
		coalesce(dt_estorno_p,dt_baixa), 
		(vl_baixa * -1), 
		nr_seq_conta_banco, 
		nr_seq_trans_financ, 
		ds_observacao, 
		nr_seq_parcela, 
		(vl_despesa * -1), 
		coalesce(vl_desp_equip,0) * -1, 
		nr_sequencia 
	from	movto_cartao_cr_baixa 
	where	nr_sequencia	= nr_seq_baixa_p;
 
	update	movto_cartao_cr_baixa 
	set	nr_seq_lote	 = NULL 
	where	nr_sequencia	= nr_seq_baixa_p;
end if;
 
/* Francisco - 25/11/2009 - Atualizar repasse ao estornar - OS 142835 */
 
CALL ATUALIZA_REPASSE_CARTAO(nr_sequencia_w,nm_usuario_p);
 
select	max(nr_seq_conta_banco), 
	max(nr_seq_trans_financ), 
	max(nr_seq_movto) 
into STRICT	nr_seq_conta_banco_w, 
	nr_seq_trans_financ_w, 
	nr_seq_movto_w 
from	movto_cartao_cr_baixa 
where	nr_sequencia = nr_sequencia_w;
 
select	max((obter_valor_bandeira_estab(c.nr_sequencia,b.cd_estabelecimento,'NR_SEQ_TRANS_FIN_DESP'))::numeric ) 
into STRICT	nr_seq_trans_fin_desp_w 
from	bandeira_cartao_cr c, 
	movto_cartao_cr b, 
	movto_cartao_cr_baixa a 
where	a.nr_seq_movto		= b.nr_sequencia 
and	b.nr_seq_bandeira	= c.nr_sequencia 
and	a.nr_sequencia		= nr_sequencia_w;
 
if (nr_seq_conta_banco_w IS NOT NULL AND nr_seq_conta_banco_w::text <> '') and ((nr_seq_trans_financ_w IS NOT NULL AND nr_seq_trans_financ_w::text <> '') or (nr_seq_trans_fin_desp_w IS NOT NULL AND nr_seq_trans_fin_desp_w::text <> '')) and (coalesce(ie_gerar_movto_baixa_p,'S') = 'S') then 
 
	CALL gerar_movto_baixa_cartao(nr_sequencia_w,nm_usuario_p,0);
 
end if;
 
CALL atualizar_saldo_cartao_cr(nr_seq_movto_w,nm_usuario_p);
 
 
if (ie_commit_p = 'S') then 
	commit;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE estornar_movto_cartao_baixa ( nr_seq_baixa_p bigint, nm_usuario_p text, ie_gerar_movto_baixa_p text, ie_commit_p text, dt_estorno_p timestamp default null) FROM PUBLIC;

