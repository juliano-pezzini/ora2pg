-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_suspender_hor_item_prescr ( nr_prescricao_p bigint, nr_sequencia_p bigint, ie_tipo_item_p text, nr_atendimento_p bigint, nm_usuario_p text, ds_observacao_p text default null, ie_interv_farmacia_p text default 'N') AS $body$
DECLARE


ie_suspendeu_hor_w		boolean:=false;
dt_suspensao_cpoe_w		timestamp;
dt_suspensao_w			timestamp;
ie_dieta_por_horar_w	char(1);
ie_atualizou_w			char(1);
ie_tipo_solucao_w		smallint;
ie_ctrl_glic_w			varchar(15);
ie_tipo_item_w			varchar(20);
cd_item_w				varchar(255);
cd_material_onc_w	cpoe_material.cd_material%type;
nr_seq_atendimento_w	paciente_atendimento.nr_seq_atendimento%type;
ds_mensagem_w			varchar(255);
nr_sequencia_w			bigint;
nr_count_adm_w			bigint;
cd_evolucao_w			bigint;
nr_seq_item_w			bigint;
nr_seq_solic_sangue_w	bigint;
nr_seq_derivado_w		bigint;
nr_seq_mat_princ_w		bigint;
nr_seq_alteracao_w		bigint;
ie_acmsn_w				varchar(1);
ie_solucao_w			varchar(1);
nr_seq_precaucao_w		bigint;
ie_suspende_isolamento_w		varchar(1)  := 'N';
ie_paciente_isolado_w			varchar(1) := 'N';
ie_procedimento_isolado_w		varchar(1) := 'N';

ie_alteracao_w			smallint:= 1;
ie_alteracao_sol_w		smallint:= 7;
ds_observacao_w			varchar(255) := '';
ie_lado_w               cpoe_procedimento.ie_lado%type;											

nr_seq_evento_w			prescr_solucao_evento.nr_sequencia%type;

nr_seq_ataque_w      	cpoe_material.nr_seq_ataque%type;
ie_sn_w					cpoe_material.ie_se_necessario%type;
ie_acm_w				cpoe_material.ie_acm%type;


ie_tipo_dieta_w      	cpoe_dieta.ie_tipo_dieta%type;
cd_dieta_cpoe_w      	cpoe_dieta.cd_dieta%type;
nr_seq_dieta_w      	cpoe_dieta.nr_sequencia%type;

ie_npt_adulta_w			nut_pac.ie_npt_adulta%type;

cd_dieta_w				prescr_dieta.cd_dieta%type;

ie_agrupador_w			prescr_material.ie_agrupador%type;

cd_refeicao_w			prescr_dieta_hor.cd_refeicao%type;

nr_seq_solucao_w      	prescr_solucao.nr_seq_solucao%type;

nr_seq_gasoterapia_w	prescr_gasoterapia.nr_sequencia%type;

ie_tipo_proced_w		prescr_procedimento.ie_tipo_proced%type;
nr_seq_solic_sangue_cpoe_w		prescr_procedimento.nr_seq_solic_sangue%type;

dt_validade_prescr_w	prescr_medica.dt_validade_prescr%type;
cd_estabelecimento_w	prescr_medica.cd_estabelecimento%type;
nr_horas_validade_w		prescr_medica.nr_horas_validade%type;

nr_seq_nut_pac_hor_w 	nut_paciente_hor.nr_sequencia%type;
ie_desfazer_conduta_w	varchar(1);
nr_seq_material_w		prescr_material.nr_sequencia%type;
nr_etapa_sol_w			prescr_mat_hor.nr_etapa_sol%type;
nr_etapas_erro_p		varchar(255);
nr_seq_dialise_w		hd_prescricao.nr_sequencia%type;

nr_seq_proc_origem_w	prescr_proc_hor.nr_seq_proc_origem%type;

nr_seq_motivo_susp_w			bigint;
ds_justif_w				varchar(2000);
ds_msg_w				varchar(255);

nr_seq_processo_w 		prescr_mat_hor.nr_seq_processo%type;
qt_processo_w     		integer;

nr_seq_procedimento_w   bigint;
ie_origem_w				bigint;
nr_sequencia_diluicao_w bigint;
dt_horario_w			timestamp;
cd_motivo_baixa_w		bigint;
nr_agrupamento_w		bigint;
nr_count_temp_w			bigint;
ie_suspend_med_atend_w	varchar(1);
ds_material_w			varchar(255);
nr_prescricao_w			bigint;
ie_consiste_em_adm_w   varchar(1);
dt_fim_horario_w		timestamp;
ie_prescr_acm_w			varchar(1);	
ie_prescr_sn_w			varchar(1);

cd_material_cpoe_w		cpoe_material.cd_material%type;
cd_material_prescr_w	prescr_material.cd_material%type;
ds_erro_w			varchar(1000);
qt_hor_nao_susp_w       bigint;
cd_funcao_origem_w		bigint;								   							


--Materiais--Enteral--Suplementar
C01 REFCURSOR;

C02 CURSOR FOR  --Recomendacao
SELECT 	b.nr_sequencia
from	prescr_medica a,
		prescr_rec_hor b,
		prescr_recomendacao c,
		cpoe_recomendacao d
where	a.nr_prescricao = b.nr_prescricao
and		b.nr_prescricao = c.nr_prescricao
and		b.nr_seq_recomendacao = c.nr_sequencia
and		a.nr_prescricao = nr_prescricao_p
and		c.nr_seq_rec_cpoe = nr_sequencia_p
and		c.nr_seq_rec_cpoe = d.nr_sequencia
and	    coalesce(b.dt_fim_horario::text, '') = ''
and	    coalesce(b.dt_suspensao::text, '') = ''
and		((b.dt_horario >= dt_suspensao_w) or (coalesce(a.dt_liberacao::text, '') = '') or (ie_forma_suspensao = 'I'));

C06 CURSOR FOR
SELECT 	a.nr_sequencia
from	prescr_material a
where	a.nr_prescricao	= nr_prescricao_p
and 	a.nr_seq_dieta_cpoe = nr_sequencia_p
and 	a.ie_suspenso = 'S';

C03 CURSOR FOR  --Procedimentos
SELECT	b.nr_sequencia,
		b.nr_seq_proc_origem
from	prescr_medica a,
		prescr_proc_hor b,
		prescr_procedimento c,
		cpoe_procedimento d
where	a.nr_prescricao = b.nr_prescricao
and		a.nr_prescricao = c.nr_prescricao
and		b.nr_seq_procedimento = c.nr_sequencia
and		a.nr_prescricao = nr_prescricao_p
and		c.nr_seq_proc_cpoe = nr_sequencia_p
and		c.nr_seq_proc_cpoe = d.nr_sequencia
and	    coalesce(b.dt_fim_horario::text, '') = ''
and	    coalesce(b.dt_suspensao::text, '') = ''
and		((b.dt_horario >= dt_suspensao_w) or (coalesce(a.dt_liberacao::text, '') = '')  or (d.ie_forma_suspensao = 'I'));

c04 CURSOR FOR  --Dieta  Oral
SELECT	b.nr_sequencia,
		b.cd_refeicao,
		c.cd_dieta
from	prescr_medica a,
		prescr_dieta_hor b,
		prescr_dieta c,
		cpoe_dieta d
where	a.nr_prescricao = b.nr_prescricao
and		a.nr_prescricao = c.nr_prescricao
and		b.nr_seq_dieta = c.nr_sequencia
and		a.nr_prescricao = nr_prescricao_p
and		c.nr_seq_dieta_cpoe = nr_sequencia_p
and		c.nr_seq_dieta_cpoe = d.nr_sequencia
and	    coalesce(b.dt_fim_horario::text, '') = ''
and	    coalesce(b.dt_suspensao::text, '') = ''
and		((b.dt_horario >= dt_suspensao_w) or (coalesce(a.dt_liberacao::text, '') = '')  or (d.ie_forma_suspensao = 'I'));

c05 CURSOR FOR  --Gasoterapia
SELECT  b.nr_sequencia
from    prescr_medica a,
		prescr_gasoterapia_hor b,
		prescr_gasoterapia c,
		cpoe_gasoterapia d
where   a.nr_prescricao = b.nr_prescricao
and     a.nr_prescricao = c.nr_prescricao
and	    a.nr_prescricao = nr_prescricao_p
and		c.nr_seq_gas_cpoe = nr_sequencia_p
and		c.nr_seq_gas_cpoe = d.nr_sequencia
and     b.nr_seq_gasoterapia = c.nr_sequencia
and	    coalesce(b.dt_fim_horario::text, '') = ''
and	    coalesce(b.dt_suspensao::text, '') = ''
and		coalesce(substr(obter_status_etapa_gas(c.nr_sequencia,b.nr_etapa,b.dt_fim_horario,b.dt_suspensao),1,10),'N') in ('P', 'N')
and		((b.dt_horario >= dt_suspensao_w) or (coalesce(a.dt_liberacao::text, '') = '')  or (d.ie_forma_suspensao = 'I'));

c08 CURSOR FOR
SELECT	b.nr_etapa_sol,
		c.nr_sequencia_solucao,
		b.nr_sequencia,
		b.dt_horario,
		c.cd_motivo_baixa,
		b.ie_agrupador,
		b.nr_agrupamento,
		c.nr_prescricao,
		b.dt_fim_horario,
		c.ie_acm,
		c.ie_se_necessario,
		a.cd_funcao_origem,
		obter_desc_material(c.cd_material),
		c.nr_sequencia_diluicao,
		d.cd_material,
		c.cd_material
from	prescr_medica a,
		prescr_mat_hor b,
		prescr_material c,
		cpoe_material d
where	a.nr_prescricao = b.nr_prescricao
and		a.nr_prescricao = c.nr_prescricao
and		b.nr_seq_material = c.nr_sequencia
and		a.nr_prescricao = nr_prescricao_p
and		c.nr_seq_mat_cpoe = nr_sequencia_p
and		c.nr_seq_mat_cpoe = d.nr_sequencia
and	    coalesce(b.dt_fim_horario::text, '') = ''
and	    coalesce(b.dt_suspensao::text, '') = ''
and     coalesce(b.dt_inicio_horario::text, '') = ''
and	    (coalesce(b.dt_fim_horario::text, '') = '' or ((c.ie_acm = 'S' OR c.IE_SE_NECESSARIO = 'S') and a.cd_funcao_origem = 924))
and		((b.dt_horario >= dt_suspensao_w) or (coalesce(a.dt_liberacao::text, '') = '') or (d.ie_forma_suspensao = 'I'))
and     coalesce(b.ie_horario_especial, 'N') <> 'S'
order by c.nr_sequencia;

C09 CURSOR FOR
	SELECT	nr_seq_solucao
	from 	prescr_solucao
	where 	nr_prescricao = nr_prescricao_p
	and 	nr_seq_dialise = nr_seq_dialise_w;

c10 CURSOR FOR
SELECT	nr_sequencia
from	prescr_material
where	nr_prescricao 	= nr_prescricao_p
and		nr_seq_mat_cpoe = nr_sequencia_p
and		ie_agrupador not in (3,7,9);

c11 CURSOR FOR
SELECT nr_seq_processo
FROM   prescr_mat_hor
WHERE  nr_prescricao   = nr_prescricao_p
and    nr_seq_material = nr_seq_item_w
and    dt_suspensao    >= dt_suspensao_w;

c12 CURSOR FOR
SELECT	b.nr_sequencia
from	prescr_medica a,
		prescr_solic_bco_sangue c,
		prescr_procedimento b
where	a.nr_prescricao	= c.nr_prescricao
and		c.nr_sequencia = b.nr_seq_solic_sangue
and		a.nr_atendimento	= nr_atendimento_p
and		a.nr_prescricao	= nr_prescricao_p
and		c.nr_seq_hemo_cpoe	= nr_sequencia_p;

c13 CURSOR FOR
SELECT	b.nr_sequencia,
		b.dt_horario,
		coalesce(c.cd_motivo_baixa,0),
		b.ie_agrupador,
		b.nr_agrupamento,
		c.nr_prescricao,
		b.dt_fim_horario,
		c.ie_acm,
		c.ie_se_necessario,
		a.cd_funcao_origem,
		obter_desc_material(c.cd_material),
		nr_sequencia_diluicao
from	prescr_medica a,
		prescr_mat_hor b,
		prescr_material c,
		cpoe_material d
where	a.nr_prescricao = b.nr_prescricao
and		a.nr_prescricao = c.nr_prescricao
and		b.nr_seq_material = c.nr_sequencia
and		a.nr_prescricao = nr_prescricao_p
and		c.nr_seq_mat_cpoe = nr_sequencia_p
and		c.nr_seq_mat_cpoe = d.nr_sequencia
and	    (coalesce(b.dt_fim_horario::text, '') = '' or ((c.ie_acm = 'S' OR c.IE_SE_NECESSARIO = 'S') and a.cd_funcao_origem = 924))
and	    coalesce(b.dt_suspensao::text, '') = ''
and		((b.dt_horario >= dt_suspensao_w) or (coalesce(a.dt_liberacao::text, '') = '') or (d.ie_forma_suspensao = 'I'))
order by c.nr_sequencia;

 --medicamentos hemoterapia
C07 REFCURSOR;


BEGIN
CALL gravar_log_cpoe('CPOE_SUSPENDER_HOR_ITEM_PRESCR nr_prescricao_p: '||nr_prescricao_p||
		' nr_sequencia_p: '||nr_sequencia_p||
		' ie_tipo_item_p: '||ie_tipo_item_p||
		' nm_usuario_p: '||nm_usuario_p||
		' ds_observacao_p: '||ds_observacao_p||
		' ie_interv_farmacia_p: '||ie_interv_farmacia_p||
		' get_ie_commit: ' || wheb_usuario_pck.get_ie_commit,
		nr_atendimento_p);

ie_suspend_med_atend_w  :=  coalesce(obter_valor_param_usuario(924, 	57, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento),'N');
ie_desfazer_conduta_w 	:=	coalesce(obter_valor_param_usuario(924, 867, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento),'N');

if (ie_tipo_item_p = 'N') then
	select	max(ie_tipo_dieta)
	into STRICT	ie_tipo_dieta_w
	from	cpoe_dieta
	where	nr_sequencia = nr_sequencia_p;
end if;

select	max(dt_validade_prescr)
into STRICT	dt_validade_prescr_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

select	max(cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

if (ie_interv_farmacia_p = 'S') then
	ie_alteracao_w := 28;
	ie_alteracao_sol_w := 24;
	ds_observacao_w	:= wheb_mensagem_pck.get_texto(307010, null); -- Suspensao do item por substituicao em intervencao farmaceutica.
end if;

if	(( ie_tipo_item_p = 'M') or ( ie_tipo_item_p = 'MA') or ( ie_tipo_item_p = 'S') or
	((ie_tipo_dieta_w IS NOT NULL AND ie_tipo_dieta_w::text <> '') and (ie_tipo_dieta_w in ('S','L','P','E','I')))) then --Suplemento - Leites e formulas infantis - NPT Adulta - Dietas enterais (Materiais -Enteral -Suplementar)
	begin

	if	((ie_tipo_dieta_w IS NOT NULL AND ie_tipo_dieta_w::text <> '') and (ie_tipo_dieta_w in ('S','L','P','E','I'))) then

		select	max(dt_suspensao),
				max(nr_seq_motivo_susp),
				max(ds_motivo_susp)
		into STRICT	dt_suspensao_cpoe_w,
				nr_seq_motivo_susp_w,
				ds_justif_w
		from	cpoe_dieta
		where	nr_sequencia = nr_sequencia_p
		and		nr_atendimento = nr_atendimento_p
		and 	(dt_lib_suspensao IS NOT NULL AND dt_lib_suspensao::text <> '');

		if (dt_suspensao_cpoe_w > dt_validade_prescr_w) then
			dt_suspensao_w := dt_validade_prescr_w;
		else
			dt_suspensao_w := dt_suspensao_cpoe_w;
		end if;

		ie_consiste_em_adm_w := Obter_Param_Usuario(924, 330, obter_perfil_ativo, nm_usuario_p, coalesce(wheb_usuario_pck.get_cd_estabelecimento, 1), ie_consiste_em_adm_w);													
   
		open C01 for
			SELECT	b.nr_sequencia
			from	prescr_medica a,
					prescr_mat_hor b,
					prescr_material c,
					cpoe_dieta d
			where	a.nr_prescricao = b.nr_prescricao
			and		a.nr_prescricao = c.nr_prescricao
			and		b.nr_seq_material = c.nr_sequencia
			and		a.nr_prescricao = nr_prescricao_p
			and		c.nr_seq_dieta_cpoe = nr_sequencia_p
			and		c.nr_seq_dieta_cpoe = d.nr_sequencia
			and     	((coalesce(ie_consiste_em_adm_w,'N') != 'S') or (coalesce(ie_consiste_em_adm_w,'N') = 'S' and coalesce(b.dt_inicio_horario::text, '') = ''))
			and     	coalesce(b.dt_inicio_horario::text, '') = ''											 
			and		coalesce(b.dt_fim_horario::text, '') = ''
			and		coalesce(b.dt_suspensao::text, '') = ''
			and		((b.dt_horario >= dt_suspensao_w) or (coalesce(a.dt_liberacao::text, '') = '') or (d.ie_forma_suspensao = 'I'));
	else

		select	max(dt_suspensao),
				max(ie_administracao),
				max(ie_controle_tempo),
				max(nr_seq_motivo_susp),
				max(ds_motivo_susp),
				max(ie_se_necessario),
				max(ie_acm)
		into STRICT	dt_suspensao_cpoe_w,
				ie_acmsn_w,
				ie_solucao_w,
				nr_seq_motivo_susp_w,
				ds_justif_w,
				ie_sn_w,
				ie_acm_w
		from	cpoe_material
		where	nr_sequencia = nr_sequencia_p
		and		nr_atendimento = nr_atendimento_p
		and 	(dt_lib_suspensao IS NOT NULL AND dt_lib_suspensao::text <> '');

		if (dt_suspensao_cpoe_w > dt_validade_prescr_w) then
			dt_suspensao_w := dt_validade_prescr_w;
		else
			dt_suspensao_w := dt_suspensao_cpoe_w;
		end if;

		if (ie_tipo_item_p = 'S') then

			open c08;
			loop
			fetch c08 into
				nr_etapa_sol_w,
				nr_seq_solucao_w,
				nr_sequencia_w,
				dt_horario_w,
				cd_motivo_baixa_w,
				ie_agrupador_w,
				nr_agrupamento_w,
				nr_prescricao_w,
				dt_fim_horario_w,
				ie_prescr_acm_w,
				ie_prescr_sn_w,
				ie_origem_w,
				ds_material_w,
				nr_sequencia_diluicao_w,
				cd_material_cpoe_w,
				cd_material_prescr_w;
			EXIT WHEN NOT FOUND; /* apply on c08 */
				if (dt_fim_horario_w IS NOT NULL AND dt_fim_horario_w::text <> '' AND (ie_prescr_acm_w = 'S' or ie_prescr_sn_w = 'S')) then
					ie_suspendeu_hor_w := true;
				end if;
				if (ie_suspend_med_atend_w = 'N')then
					if (ie_agrupador_w in (3,7,9) and cd_motivo_baixa_w = 0) then
						select max(cd_motivo_baixa)	
						into STRICT	cd_motivo_baixa_w
						from	prescr_material
						where	nr_prescricao	=	nr_prescricao_w 
						and		nr_sequencia	=	nr_sequencia_diluicao_w;
					end if;
				end if;
				if (ie_suspend_med_atend_w = 'N' and cd_motivo_baixa_w > 0)	then				
					INSERT INTO w_adep_t_cpoe(nr_sequencia,
							nm_usuario, 
							nr_agrupamento, 
							nr_seq_item, 
							ds_item, 
							nr_prescricoes,
							ie_tipo_item, 
							hora1, 
							ie_suspenso, 
							nr_atendimento) 
					VALUES (nextval('w_adep_t_cpoe_seq'), 
							nm_usuario_p, 
							nr_agrupamento_w, 
							nr_sequencia_w, 
							ds_material_w, 
							to_char(nr_prescricao_p), 
							ie_agrupador_w,
							To_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss'), 
							'X', 
							nr_atendimento_p);
				else
					if (cd_material_cpoe_w = cd_material_prescr_w) then
						nr_etapas_erro_p := suspender_etapa_solucao(1, nr_prescricao_p, nr_seq_solucao_w, null, 12, null, nm_usuario_p, null, nr_etapa_sol_w, null, nr_etapas_erro_p, null, obter_perfil_ativo, null, 'N');
						ie_suspendeu_hor_w := true;
					end if;
				end if;
			end loop;
			close c08;
			if (not ie_suspendeu_hor_w and coalesce(nr_etapa_sol_w::text, '') = '' and coalesce(nr_seq_solucao_w::text, '') = '' and (coalesce(ie_sn_w, 'N') = 'S' or coalesce(ie_acm_w, 'N') = 'S')) then
				ie_suspendeu_hor_w := true;
			end if;
			
			
			select 	count(*)
			into STRICT	nr_count_adm_w
			from	prescr_mat_hor b,
					prescr_material c
			where	b.nr_prescricao 		= c.nr_prescricao
			and		b.nr_seq_material	 	= c.nr_sequencia
			and		b.nr_prescricao 		= nr_prescricao_p
			and 	c.nr_seq_mat_cpoe	 	= nr_sequencia_p
			and 	coalesce(b.dt_suspensao::text, '') = '';
			if (nr_count_adm_w > 0 and (ie_prescr_acm_w = 'S' or ie_prescr_sn_w = 'S') and ie_origem_w = 924) then
				nr_count_adm_w := 0;
			end if;
			if ( nr_count_adm_w = 0) then
				update 	can_ordem_prod a
				set	a.ie_cancelada = 'S'
				where 	coalesce(a.dt_inicio_preparo::text, '') = ''
				and 	exists ( SELECT 1
						from can_ordem_item_prescr b,
						     prescr_material c
						where a.nr_sequencia = b.nr_seq_ordem
						and a.nr_prescricao = c.nr_prescricao
						and b.nr_prescricao = c.nr_prescricao
						and b.nr_seq_prescricao = c.nr_sequencia
						and b.nr_prescricao = nr_prescricao_p
						and c.nr_seq_mat_cpoe = nr_sequencia_p );
				update	prescr_solucao a
				set 	ie_suspenso = 'S',
					nm_usuario_susp		= nm_usuario_p,
					dt_suspensao 		= dt_suspensao_w,
					nr_seq_motivo_susp	= nr_seq_motivo_susp_w,
					ds_motivo_susp		= ds_justif_w
				where	nr_prescricao  	= nr_prescricao_p
				and  	exists ( SELECT	b.nr_sequencia
								from 	prescr_material b
								where 	b.nr_prescricao = a.nr_prescricao
								and 	 b.nr_seq_mat_cpoe = nr_sequencia_p
								and  	b.nr_sequencia_solucao = a.nr_seq_solucao
								and  	coalesce(b.ie_suspenso,'N') = 'N');

			end if;
		end if;
	end if;
	
	CALL gravar_log_cpoe('CPOE_SUSPENDER_HOR_ITEM_PRESCR - C13 - nr_prescricao_p: '||nr_prescricao_p||
		' nr_sequencia_p: '||nr_sequencia_p||
		' ie_tipo_item_p: '||ie_tipo_item_p||
		' nm_usuario_p: '||nm_usuario_p||
		' ie_solucao_w: '||ie_solucao_w||
		' ie_tipo_dieta_w: '||ie_tipo_dieta_w||
		' ie_suspend_med_atend_w: ' || ie_suspend_med_atend_w||
		' cd_motivo_baixa_w: ' || cd_motivo_baixa_w||
		' dt_suspensao_w: ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_suspensao_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone),nr_atendimento_p);

	if (coalesce(ie_solucao_w,'N') <> 'S' and (ie_tipo_item_p <> 'S')) then
		if (coalesce(ie_tipo_dieta_w::text, '') = '') then
			open c13;
				loop
					fetch c13 into
						nr_sequencia_w,
						dt_horario_w,
						cd_motivo_baixa_w,
						ie_agrupador_w,
						nr_agrupamento_w,
						nr_prescricao_w,
						dt_fim_horario_w,
						ie_prescr_acm_w,
						ie_prescr_sn_w,
						ie_origem_w,
						ds_material_w,
						nr_sequencia_diluicao_w;
					EXIT WHEN NOT FOUND; /* apply on c13 */
					if (dt_fim_horario_w IS NOT NULL AND dt_fim_horario_w::text <> '' AND (ie_prescr_acm_w = 'S' or ie_prescr_sn_w = 'S')) then
						ie_suspendeu_hor_w := true;
					end if;
					if (ie_suspend_med_atend_w = 'N') then
						if ((ie_agrupador_w in (3,7,9)) and (cd_motivo_baixa_w = 0))	then
							select max(cd_motivo_baixa)	
							into STRICT	cd_motivo_baixa_w
							from	prescr_material
							where	nr_prescricao	=	nr_prescricao_w 
							and		nr_sequencia	=		nr_sequencia_diluicao_w;
						end if;
					end if;
					if (ie_suspend_med_atend_w = 'N' and cd_motivo_baixa_w > 0)	then				
						INSERT INTO w_adep_t_cpoe(nr_sequencia,
								nm_usuario, 
								nr_agrupamento, 
								nr_seq_item, 
								ds_item, 
								nr_prescricoes, 
								ie_tipo_item, 
								hora1, 
								ie_suspenso, 
								nr_atendimento) 
						VALUES (nextval('w_adep_t_cpoe_seq'), 
								nm_usuario_p,
								nr_agrupamento_w, 
								nr_sequencia_w, 
								ds_material_w, 
								to_char(nr_prescricao_p), 
								ie_agrupador_w,
								To_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss'), 
								'X', 
								nr_atendimento_p);				
					else
						CALL suspender_prescr_mat_hor( nr_sequencia_w, nm_usuario_p, 0, null, 'N',null);
						ie_suspendeu_hor_w := true;
					end if;
				end loop;
			close c13;
		else
			loop
				fetch C01 into
					nr_sequencia_w;
				EXIT WHEN NOT FOUND; /* apply on C01 */
					CALL suspender_prescr_mat_hor(nr_sequencia_w, nm_usuario_p, 0, null, 'N',null);
					ie_suspendeu_hor_w := true;
			end loop;
			close C01;
		end if;
	end if;

	if (not ie_suspendeu_hor_w) and (ie_tipo_item_p = 'N') and (ie_tipo_dieta_w in ('P','I')) then
		ie_suspendeu_hor_w := true;
	end if;
	if (not ie_suspendeu_hor_w and ie_tipo_item_p in ('M','S')) then
																			
		select coalesce(max(1),0)
		into STRICT qt_hor_nao_susp_w
		from	prescr_medica a,
			prescr_mat_hor b,
			prescr_material c,
				cpoe_material d
		where	a.nr_prescricao = b.nr_prescricao
		and		a.nr_prescricao = c.nr_prescricao
		and		b.nr_seq_material = c.nr_sequencia
		and		a.nr_prescricao = nr_prescricao_p
		and		c.nr_seq_mat_cpoe = nr_sequencia_p
		and		c.nr_seq_mat_cpoe = d.nr_sequencia
		and 	coalesce(b.dt_suspensao::text, '') = '';
		
		select cd_funcao_origem
		into STRICT cd_funcao_origem_w
		from prescr_medica
		where nr_prescricao = nr_sequencia_p;
		
		if (qt_hor_nao_susp_w = 0 and cd_funcao_origem_w = 2314) then
			ie_suspendeu_hor_w := true;
		end if;

	end if;															

	if (ie_suspendeu_hor_w) then

		if (ie_tipo_item_p in ('M','MA')) then

			select	max(a.nr_sequencia),
					max(a.cd_material),
					max(a.ie_agrupador)
			into STRICT	nr_seq_item_w,
					cd_item_w,
					ie_agrupador_w
			from	prescr_material a,
					cpoe_material b
			where	a.nr_prescricao = nr_prescricao_p
			and	b.nr_sequencia = nr_sequencia_p
			and	a.nr_seq_mat_cpoe = b.nr_sequencia
			and a.cd_material = b.cd_material
			and	a.ie_agrupador 	in (1,2,4);
		elsif (ie_tipo_item_p in ('S')) then
			select	max(c.nr_seq_solucao),
					max(a.cd_material),
					max(a.ie_agrupador)
			into STRICT	nr_seq_item_w,
					cd_item_w,
					ie_agrupador_w
			from	prescr_material a,
					cpoe_material b,
					prescr_solucao c
			where	a.nr_prescricao = nr_prescricao_p
			and	b.nr_sequencia = nr_sequencia_p
			and	c.nr_prescricao = a.nr_prescricao
			and	c.nr_seq_solucao = a.nr_sequencia_solucao
			and	a.nr_seq_mat_cpoe = b.nr_sequencia
			and a.cd_material = b.cd_material
			and	a.ie_agrupador 	in (1,2,4);
		else
			select	max(nr_sequencia),
				max(cd_material),
				max(ie_agrupador)
			into STRICT	nr_seq_item_w,
				cd_item_w,
				ie_agrupador_w
			from	prescr_material
			where	nr_prescricao = nr_prescricao_p
			and	nr_seq_dieta_cpoe = nr_sequencia_p;
		end if;

		if (ie_agrupador_w = 1) then -- Medicamento
			CALL gerar_alter_item_prescr_adep(nr_atendimento_p, 'M', cd_item_w, nr_prescricao_p, nr_seq_item_w, ie_alteracao_w, ds_justif_w, nm_usuario_p, nr_seq_motivo_susp_w, ds_observacao_w);

		elsif (ie_agrupador_w = 2) then --Material
			CALL gerar_alter_item_prescr_adep(nr_atendimento_p, 'MAT', cd_item_w, nr_prescricao_p, nr_seq_item_w, ie_alteracao_w, ds_justif_w, nm_usuario_p, nr_seq_motivo_susp_w, ds_observacao_w);

		elsif (ie_agrupador_w = 4) then --Solucao
			CALL gerar_alter_sol_prescr_adep(1, nr_prescricao_p, nr_seq_item_w, ie_alteracao_sol_w, null, nm_usuario_p, null);

		elsif (ie_agrupador_w = 8) then --Enteral
			CALL gerar_alter_sol_prescr_adep(2, nr_prescricao_p, nr_seq_item_w, ie_alteracao_sol_w, null, nm_usuario_p,null);

		elsif (ie_agrupador_w = 12) then --Suplemtno
			CALL gerar_alter_item_prescr_adep(nr_atendimento_p, 'S', cd_item_w, nr_prescricao_p, nr_seq_item_w, ie_alteracao_w, ds_justif_w, nm_usuario_p, nr_seq_motivo_susp_w, ds_observacao_w);

		elsif (ie_agrupador_w = 16) then --Leites e Derivados
			CALL gerar_alter_item_prescr_adep(nr_atendimento_p, 'LD', cd_item_w, nr_prescricao_p, nr_seq_item_w, ie_alteracao_w, ds_justif_w, nm_usuario_p, nr_seq_motivo_susp_w, ds_observacao_w);
		end if;

		if (ie_agrupador_w in (1,2,8,12,16)) then

			open C11;
			loop
			fetch C11 into
				nr_seq_processo_w;
			EXIT WHEN NOT FOUND; /* apply on C11 */
			begin
				select coalesce(count(*), 0)
				into STRICT   qt_processo_w
				from   prescr_mat_hor
				where  nr_seq_processo = nr_seq_processo_w
				and    coalesce(dt_suspensao::text, '') = '';

				if (qt_processo_w = 0) then
					update	adep_processo
					set	ie_inconsistencia = 'S',
						dt_cancelamento = clock_timestamp(),
						nm_usuario_cancelamento = nm_usuario_p,
						dt_suspensao = clock_timestamp(),
						nm_usuario_susp = nm_usuario_p
					where	nr_sequencia = nr_seq_processo_w;
				end if;
			end;
			end loop;
			close C11;
		end if;

		if (cd_item_w IS NOT NULL AND cd_item_w::text <> '') then
			cd_material_onc_w := (cd_item_w)::numeric;
		end if;	
		nr_seq_item_w 	:= null;
		cd_item_w		:= null;

		if (ie_tipo_dieta_w in ('P','I')) then
			select	max(nr_sequencia),
				max(ie_npt_adulta)
			into STRICT	nr_seq_item_w,
				ie_npt_adulta_w
			from	nut_pac
			where	nr_sequencia	= nr_sequencia_p;

			ie_tipo_solucao_w := 5;

			if	coalesce(ie_npt_adulta_w, 'N') = 'S' then
				ie_tipo_solucao_w	:= 6;
			end if;

			CALL gerar_alter_sol_prescr_adep(ie_tipo_solucao_w, nr_prescricao_p, nr_seq_item_w, 5, null, nm_usuario_p, null);

			/* Desfaz a prescricao como sendo de conduta dietoterapica na Gestao da Nutricao.*/

			if (ie_desfazer_conduta_w = 'S') then
				CALL nut_desfazer_prescr_nut_susp(nr_prescricao_p, 'NUT_PAC', nr_sequencia_p, nm_usuario_p);
			end if;

		end if;

		if (ie_tipo_dieta_w IS NOT NULL AND ie_tipo_dieta_w::text <> '') and (ie_tipo_dieta_w in ('S','L','P','E','I')) then --Suplemento - Leites e formulas infantis - NPT Adulta - Dietas enterais
			begin

			if (ie_tipo_dieta_w in ('P','I')) then
				update	nut_pac
				set		ie_suspenso 	= 'S',
						dt_suspensao = dt_suspensao_w,
						nm_usuario_susp = nm_usuario_p
				where	nr_prescricao =  nr_prescricao_p
				and		nr_seq_npt_cpoe = nr_sequencia_p;
			end if;

			select 	count(*)
			into STRICT	nr_count_adm_w
			from	prescr_mat_hor b,
				prescr_material c
			where	b.nr_prescricao		= c.nr_prescricao
			and	b.nr_seq_material 	= c.nr_sequencia
			and	b.nr_prescricao		= nr_prescricao_p
			and 	c.nr_seq_dieta_cpoe 	= nr_sequencia_p
			and	coalesce(b.dt_suspensao::text, '') = '';

			if (nr_count_adm_w = 0) then

				update 	prescr_material
				set	ie_suspenso 	= 'S',
					nm_usuario_susp = nm_usuario_p,
					dt_suspensao 	= dt_suspensao_w,
					ds_observacao	= ds_observacao || ds_observacao_p,
					nr_seq_motivo_susp	= nr_seq_motivo_susp_w,
					ds_motivo_susp		= ds_justif_w
				where	nr_prescricao 	= nr_prescricao_p
				and 	nr_seq_dieta_cpoe = nr_sequencia_p
				and	coalesce(ie_acm, 'N') = 'N'
				and	coalesce(ie_se_necessario, 'N') = 'N';

				/* Desfaz a prescricao como sendo de conduta dietoterapica na Gestao da Nutricao.*/

				if (ie_desfazer_conduta_w = 'S') then

					open C06;
					loop
					fetch C06 into
						nr_seq_material_w;
					EXIT WHEN NOT FOUND; /* apply on C06 */
						begin
						CALL nut_desfazer_prescr_nut_susp(nr_prescricao_p, 'PRESCR_MATERIAL', nr_seq_material_w, nm_usuario_p);
						end;
					end loop;
					close C06;
				end if;

			end if;
			end;
		else --Medicamento
			begin
			select 	count(*)
			into STRICT	nr_count_adm_w
			from	prescr_mat_hor b,
				prescr_material c
			where	b.nr_prescricao   = c.nr_prescricao
			and	b.nr_seq_material = c.nr_sequencia
			and	b.nr_prescricao   = nr_prescricao_p
			and 	c.nr_seq_mat_cpoe = nr_sequencia_p
			and	coalesce(b.dt_suspensao::text, '') = '';
			if (nr_count_adm_w > 0 and (ie_prescr_acm_w = 'S' or ie_prescr_sn_w = 'S') and ie_origem_w = 924) then
				nr_count_adm_w := 0;
			end if;
			update 	can_ordem_prod a
			set	a.ie_cancelada = 'S'
			where 	coalesce(a.dt_inicio_preparo::text, '') = ''
			and 	exists ( SELECT 1
					from can_ordem_item_prescr b,
					     prescr_material c
					where a.nr_sequencia = b.nr_seq_ordem
					and a.nr_prescricao = c.nr_prescricao
					and b.nr_prescricao = c.nr_prescricao
					and b.nr_seq_prescricao = c.nr_sequencia
					and b.nr_prescricao = nr_prescricao_p
					and c.nr_seq_mat_cpoe = nr_sequencia_p );
			if (nr_count_adm_w = 0) then
				update 	prescr_material
				set	ie_suspenso 	= 'S',
					nm_usuario_susp = nm_usuario_p,
					dt_suspensao 	= dt_suspensao_w,
					ds_observacao	= ds_observacao || ds_observacao_p,
					nr_seq_motivo_susp = nr_seq_motivo_susp_w,
					ds_motivo_susp	= ds_justif_w
				where	nr_prescricao 	= nr_prescricao_p
				and 	nr_seq_mat_cpoe = nr_sequencia_p;

				
				select	max(nr_seq_atendimento)
				into STRICT		nr_seq_atendimento_w
				from		paciente_atendimento
				where	nr_prescricao = nr_prescricao_p;
				
				if (nr_seq_atendimento_w > 0) then
					update	paciente_atend_medic
					set		ie_cancelada = 'S'
					where	nr_seq_atendimento = nr_seq_atendimento_w
					and (cd_material = cd_material_onc_w
					or 	cd_material  in (SELECT	cd_material
										 from	material
										 where	nr_seq_ficha_tecnica = cd_material_onc_w));	
				end if;
				
				open c10;
				loop
				fetch c10 into
					nr_seq_mat_princ_w;
				EXIT WHEN NOT FOUND; /* apply on c10 */

					update 	prescr_material
					set		ie_suspenso 	= 'S',
							nm_usuario_susp = nm_usuario_p,
							dt_suspensao 	= dt_suspensao_w,
							ds_observacao	= ds_observacao || ds_observacao_p,
							nr_seq_motivo_susp	= nr_seq_motivo_susp_w,
							ds_motivo_susp		= ds_justif_w
					where	nr_prescricao 	= nr_prescricao_p
					and 	nr_seq_kit 		= nr_seq_mat_princ_w;

					update 	prescr_material
					set		nm_usuario_susp 	= nm_usuario_p,
							dt_suspensao_progr 	= dt_suspensao_w,
							ds_observacao		= ds_observacao || ds_observacao_p,
							nr_seq_motivo_susp	= nr_seq_motivo_susp_w,
							ds_motivo_susp		= ds_justif_w
					where	nr_prescricao 		= nr_prescricao_p
					and 	nr_sequencia_diluicao	= nr_seq_mat_princ_w;

				end loop;
				close c10;

			else
				update 	prescr_material
				set		nm_usuario_susp 	= nm_usuario_p,
						dt_suspensao_progr 	= dt_suspensao_w,
						ds_observacao		= ds_observacao || ds_observacao_p,
						nr_seq_motivo_susp	= nr_seq_motivo_susp_w,
					ds_motivo_susp		= ds_justif_w
				where	nr_prescricao 	= nr_prescricao_p
				and 	nr_seq_mat_cpoe = nr_sequencia_p;

				open c10;
				loop
				fetch c10 into
					nr_seq_mat_princ_w;
				EXIT WHEN NOT FOUND; /* apply on c10 */

					update 	prescr_material
					set		nm_usuario_susp 	= nm_usuario_p,
							dt_suspensao_progr 	= dt_suspensao_w,
							ds_observacao		= ds_observacao || ds_observacao_p,
							nr_seq_motivo_susp	= nr_seq_motivo_susp_w,
							ds_motivo_susp		= ds_justif_w
					where	nr_prescricao 	= nr_prescricao_p
					and 	nr_seq_mat_cpoe = nr_sequencia_p
					and 	nr_seq_kit 		= nr_seq_mat_princ_w;

					update 	prescr_material
					set		nm_usuario_susp 	= nm_usuario_p,
							dt_suspensao_progr 	= dt_suspensao_w,
							ds_observacao		= ds_observacao || ds_observacao_p,
							nr_seq_motivo_susp	= nr_seq_motivo_susp_w,
							ds_motivo_susp		= ds_justif_w
					where	nr_prescricao 		= nr_prescricao_p
					and 	nr_sequencia_diluicao	= nr_seq_mat_princ_w;

				end loop;
				close c10;

			end if;
			end;
		end if;
	end if;

	end;
end if;

ie_suspendeu_hor_w 	:= false;
dt_suspensao_w 		:= null;
nr_seq_item_w 		:= null;
cd_item_w			:= null;

if (ie_tipo_item_p = 'R') then--Recomendacao
	begin

	select	max(dt_suspensao),
		max(nr_seq_motivo_susp),
		max(ds_motivo_susp)
	into STRICT	dt_suspensao_cpoe_w,
		nr_seq_motivo_susp_w,
		ds_justif_w
	from	cpoe_recomendacao
	where	nr_sequencia = nr_sequencia_p
	and		nr_atendimento = nr_atendimento_p
	and 	(dt_lib_suspensao IS NOT NULL AND dt_lib_suspensao::text <> '');

	if (dt_suspensao_cpoe_w > dt_validade_prescr_w) then
		dt_suspensao_w := dt_validade_prescr_w;
	else
		dt_suspensao_w := dt_suspensao_cpoe_w;
	end if;

	open C02;
	loop
	fetch C02 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		CALL suspender_prescr_rec_hor(nr_sequencia_w, nm_usuario_p, 'XX');
		ie_suspendeu_hor_w := true;
		end;
	end loop;
	close C02;

	if (ie_suspendeu_hor_w) then

		select	max(nr_sequencia),
				max(cd_recomendacao)
		into STRICT	nr_seq_item_w,
				cd_item_w
		from	prescr_recomendacao
		where	nr_prescricao = nr_prescricao_p
		and		nr_seq_rec_cpoe = nr_sequencia_p;

		CALL gerar_alter_item_prescr_adep(nr_atendimento_p, 'R', cd_item_w, nr_prescricao_p, nr_seq_item_w, 1, ds_justif_w, nm_usuario_p, nr_seq_motivo_susp_w, null);

		select 	count(*)
		into STRICT	nr_count_adm_w
		from	prescr_rec_hor b,
				prescr_recomendacao c
		where	b.nr_prescricao 		= c.nr_prescricao
		and		b.nr_seq_recomendacao 	= c.nr_sequencia
		and		b.nr_prescricao 		= nr_prescricao_p
		and 	c.nr_seq_rec_cpoe 		= nr_sequencia_p
		and 	coalesce(b.dt_suspensao::text, '') = '';

		if (nr_count_adm_w = 0) then
			update 	prescr_recomendacao
			set		ie_suspenso 	= 'S',
					nm_usuario_susp = nm_usuario_p,
					dt_suspensao 	= dt_suspensao_w,
					ds_observacao	= ds_observacao || ds_observacao_p,
					nr_seq_motivo_susp	= nr_seq_motivo_susp_w,
					ds_motivo_susp		= ds_justif_w
			where	nr_prescricao 	= nr_prescricao_p
			and 	nr_seq_rec_cpoe = nr_sequencia_p
			and		coalesce(ie_acm, 'N') = 'N'
			and		coalesce(ie_se_necessario, 'N') = 'N';
			
			update	prescr_material
			set	ie_suspenso	= 'S',
				dt_suspensao	= clock_timestamp(),
				nm_usuario_susp	= nm_usuario_p,
				dt_atualizacao	= clock_timestamp(),
				nm_usuario	= nm_usuario_p,
				ds_motivo_susp  = ds_justif_w,
				nr_seq_motivo_susp = nr_seq_motivo_susp_w
			where	nr_prescricao	= nr_prescricao_p
			and	nr_seq_recomendacao	= nr_seq_item_w;
		end if;
	end if;
	end;
end if;

ie_suspendeu_hor_w 	:= false;
dt_suspensao_w 		:= null;
nr_seq_item_w 		:= null;
cd_item_w			:= null;

if (ie_tipo_item_p = 'H') then

	open c12;
	loop
	fetch c12 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on c12 */
	
		update	prescr_proc_hor
		set		nm_usuario			= nm_usuario_p,
				dt_atualizacao		= clock_timestamp(),
				dt_suspensao		= clock_timestamp()
		where	nr_prescricao		= nr_prescricao_p
		and 	coalesce(dt_inicio_horario::text, '') = ''
		and		coalesce(dt_fim_horario::text, '') = ''
		and		coalesce(dt_suspensao::text, '') = ''
		and 	nr_seq_procedimento = nr_sequencia_w;

		select 	count(*)
		into STRICT	nr_count_adm_w
		from	prescr_proc_hor
		where	nr_prescricao		= nr_prescricao_p
		and		coalesce(dt_suspensao::text, '') = ''
		and 	nr_seq_procedimento = nr_sequencia_w;

		if ( nr_count_adm_w = 0) then

			update	prescr_procedimento
			set		ie_suspenso			= 'S',
					nm_usuario			= nm_usuario_p,
					dt_atualizacao		= clock_timestamp(),
					dt_suspensao		= clock_timestamp(),
					nm_usuario_susp		= nm_usuario_p,
					ds_observacao		= ds_observacao || ds_observacao_p,
					cd_motivo_suspensao	= nr_seq_motivo_susp_w,
					ds_motivo_susp		= ds_justif_w
			where	nr_prescricao		= nr_prescricao_p
			and		nr_sequencia		= nr_sequencia_w;
		end if;

		open C07 for
		SELECT a.nr_sequencia
		from   prescr_mat_hor a,
			   prescr_material b,
			   prescr_medica c,
			   prescr_procedimento d
		where c.nr_prescricao = b.nr_prescricao
		and c.nr_prescricao = a.nr_prescricao
		and a.nr_prescricao = b.nr_prescricao
		and a.nr_seq_material = b.nr_sequencia
		and c.nr_prescricao = d.nr_prescricao
		and d.nr_sequencia = b.nr_sequencia_proc
		and d.nr_sequencia = nr_sequencia_w
		and a.nr_prescricao = nr_prescricao_p;

		loop
		fetch C07 into
			nr_sequencia_w;
		EXIT WHEN NOT FOUND; /* apply on C07 */
			CALL suspender_prescr_mat_hor( nr_sequencia_w, nm_usuario_p, 0, null, 'N',null);
			ie_suspendeu_hor_w := true;
			end loop;
		close C07;

		select	coalesce(max('S'),'N')
		into STRICT 	ie_atualizou_w
		from 	prescr_procedimento where		nr_prescricao	 = nr_prescricao_p
		and		nr_sequencia	 = nr_sequencia_w
		and		(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
		and		(nm_usuario_susp IS NOT NULL AND nm_usuario_susp::text <> '') LIMIT 1;

		if (ie_atualizou_w = 'S') then

			select	nextval('prescr_solucao_evento_seq')
			into STRICT	nr_seq_evento_w
			;

			insert into prescr_solucao_evento(nr_sequencia,
												dt_atualizacao,
											nm_usuario,
											dt_atualizacao_nrec,
											nm_usuario_nrec,
											nr_prescricao,
											nr_seq_solucao,
											nr_seq_material,
											nr_seq_procedimento,
											nr_seq_nut,
											nr_seq_nut_neo,
											ie_forma_infusao,
											qt_volume_fase,
											ie_tipo_dosagem,
											qt_dosagem,
											qt_vol_infundido,
											qt_vol_desprezado,
											cd_pessoa_fisica,
											ie_alteracao,
											dt_alteracao,
											ie_evento_valido,
											nr_seq_motivo,
											ds_observacao,
											ie_tipo_solucao,
											qt_volume_parcial,
											qt_tempo_infusao,
											nr_seq_lote,
											nr_seq_assinatura,
											ds_justificativa,
											dt_horario)
								values (	nr_seq_evento_w,
											clock_timestamp(),
											nm_usuario_p,
											clock_timestamp(),
											nm_usuario_p,
											nr_prescricao_p,
											null,
											null,
											nr_sequencia_w,
											null,
											null,
											null,
											null,
											null,
											null,
											null,
											null,
											obter_dados_usuario_opcao(nm_usuario_p, 'C'),
											'7',
											clock_timestamp(),
											'S',
											null,
											null,
											3,
											null,
											null,
											null,
											null,
											null,
											null);
		end if;
		
	end loop;
	close c12;
end if;

ie_suspendeu_hor_w 	:= false;
dt_suspensao_w 		:= null;
nr_seq_item_w 		:= null;
cd_item_w			:= null;

if (ie_tipo_item_p = 'P') then --Procedimentos - Hemoterapia
	begin
	
	ie_suspende_isolamento_w := obter_param_usuario(924, 1093, Obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, ie_suspende_isolamento_w);
	
	select	max(dt_suspensao),
		max(nr_seq_motivo_susp),
		max(ds_motivo_susp),
		max(ie_lado)
	into STRICT	dt_suspensao_cpoe_w,
		nr_seq_motivo_susp_w,
		ds_justif_w,
		ie_lado_w
	from	cpoe_procedimento
	where	nr_sequencia = nr_sequencia_p
	and	nr_atendimento = nr_atendimento_p
	and 	(dt_lib_suspensao IS NOT NULL AND dt_lib_suspensao::text <> '');

	if (dt_suspensao_cpoe_w > dt_validade_prescr_w) then
		dt_suspensao_w := dt_validade_prescr_w;
	else
		dt_suspensao_w := dt_suspensao_cpoe_w;
	end if;

	open C03;
	loop
	fetch C03 into
		nr_sequencia_w,
		nr_seq_proc_origem_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		CALL suspender_prescr_proc_hor(nr_sequencia_w, nm_usuario_p, 'XX');
		ie_suspendeu_hor_w := true;

		if (nr_seq_proc_origem_w IS NOT NULL AND nr_seq_proc_origem_w::text <> '') then
			update 	prescr_procedimento
			set		ie_suspenso 	= 'S',
					nm_usuario_susp = nm_usuario_p,
					dt_suspensao 	= dt_suspensao_w,
					ds_observacao	= ds_observacao || ds_observacao_p,
					cd_motivo_suspensao	= nr_seq_motivo_susp_w,
					ds_motivo_susp		= ds_justif_w
			where	nr_prescricao 	= nr_prescricao_p
			and 	nr_sequencia = nr_seq_proc_origem_w
			and		coalesce(ie_acm, 'N') = 'N'
			and		coalesce(ie_se_necessario, 'N') = 'N';
		end if;
	end loop;
	close C03;
	
	if ( not ie_suspendeu_hor_w  AND ie_lado_w = 'D')then
			select 	count(*)
			into STRICT	nr_count_adm_w
			from	prescr_proc_hor b,
					prescr_procedimento c
			where	b.nr_prescricao 		= c.nr_prescricao
			and		b.nr_seq_procedimento 	= c.nr_sequencia
			and		b.nr_prescricao 		= nr_prescricao_p
			and 	c.nr_seq_proc_cpoe 		= nr_sequencia_p
			and 	coalesce(b.dt_suspensao::text, '') = '';
			
			if (nr_count_adm_w = 0) then
				ie_suspendeu_hor_w := true;
			end if;
	end if;		
	if (ie_suspendeu_hor_w) then
		select	max(nr_sequencia),
				max(cd_procedimento),
				max(coalesce(obter_ctrl_glic_proc(nr_seq_proc_interno),'NC')),
				max(coalesce(nr_seq_solic_sangue,0)),
				max(coalesce(nr_seq_derivado,0)),
				max(CASE WHEN obter_se_proc_ivc(nr_seq_proc_interno)='S' THEN 'I'  ELSE 'P' END ),
				max(coalesce(ie_tipo_proced,'XPTO'))
		into STRICT	nr_seq_item_w,
				cd_item_w,
				ie_ctrl_glic_w,
				nr_seq_solic_sangue_w,
				nr_seq_derivado_w,
				ie_tipo_item_w,
				ie_tipo_proced_w
		from	prescr_procedimento a
		where	nr_prescricao = nr_prescricao_p
		and		nr_seq_proc_cpoe = nr_sequencia_p
		and		not exists (SELECT nr_sequencia from prescr_proc_hor c where a.nr_prescricao = c.nr_prescricao and c.nr_seq_proc_origem = a.nr_sequencia);

		if (nr_seq_solic_sangue_w > 0) and
			((nr_seq_derivado_w > 0) or (ie_tipo_proced_w = 'BS')) then
			CALL gerar_alter_sol_prescr_adep(3, nr_prescricao_p, nr_seq_item_w, 1, null, nm_usuario_p,null);

		elsif (ie_ctrl_glic_w = 'NC') then
			CALL gravar_log_tasy(10007,	'GERAR_ALTER_ITEM_PRESCR_ADEP LOG - nr_atendimento_p: ' || nr_atendimento_p ||
									' ie_tipo_item_w: ' || ie_tipo_item_w || ' cd_item_w: ' || cd_item_w ||
									' nr_prescricao_p: ' || nr_prescricao_p || ' nr_seq_item_w: ' || nr_seq_item_w ||
									' ds_justif_w: ' || ds_justif_w || ' nm_usuario_p: ' || nm_usuario_p ||
									' nr_seq_motivo_susp_w: ' || nr_seq_motivo_susp_w, nm_usuario_p);

			CALL gerar_alter_item_prescr_adep(nr_atendimento_p, ie_tipo_item_w, cd_item_w, nr_prescricao_p, nr_seq_item_w, 1, ds_justif_w, nm_usuario_p, nr_seq_motivo_susp_w, null);

		elsif (ie_ctrl_glic_w = 'CIG') then
			update	atend_glicemia
			set		ie_status_glic	= 'S',
					dt_atualizacao	= clock_timestamp()
			where	nr_prescricao 	= nr_prescricao_p
			and		nr_seq_procedimento = nr_seq_item_w;

			CALL gerar_alter_item_prescr_adep(nr_atendimento_p, 'C', cd_item_w, nr_prescricao_p, nr_seq_item_w, 1, ds_justif_w, nm_usuario_p, nr_seq_motivo_susp_w, null);

		elsif (ie_ctrl_glic_w = 'CCG') then
			update	atend_glicemia
			set		ie_status_glic = 'S',
					dt_atualizacao	= clock_timestamp()
			where	nr_prescricao = nr_prescricao_p
			and		nr_seq_procedimento = nr_seq_item_w;

			CALL gerar_alter_item_prescr_adep(nr_atendimento_p, 'G', cd_item_w, nr_prescricao_p, nr_seq_item_w, 1, ds_justif_w, nm_usuario_p, nr_seq_motivo_susp_w, null);
		end if;

		select 	count(*)
		into STRICT	nr_count_adm_w
		from	prescr_proc_hor b,
				prescr_procedimento c
		where	b.nr_prescricao 		= c.nr_prescricao
		and		b.nr_seq_procedimento 	= c.nr_sequencia
		and		b.nr_prescricao 		= nr_prescricao_p
		and 	c.nr_seq_proc_cpoe 		= nr_sequencia_p
		and 	coalesce(b.dt_suspensao::text, '') = '';

		if (nr_count_adm_w = 0) then
		
			ie_paciente_isolado_w	  	:= obter_se_pac_isolamento(nr_atendimento_p);
			ie_procedimento_isolado_w 	:= obter_se_proced_isolamento(nr_prescricao_p,nr_sequencia_p);
				
			if (coalesce(ie_paciente_isolado_w,'N') = 'S') and (coalesce(ie_procedimento_isolado_w,'N') = 'S') and (ie_suspende_isolamento_w = 'S') then		
				nr_seq_precaucao_w	:= obter_atendimento_precaucao(nr_atendimento_p,'C');	
				CALL atualizar_pac_isolamento(coalesce(nr_seq_precaucao_w,0),nr_atendimento_p,nm_usuario_p);
			end if;
			
			update 	prescr_procedimento
			set		ie_suspenso 	= 'S',
					nm_usuario_susp = nm_usuario_p,
					dt_suspensao 	= dt_suspensao_w,
					ds_observacao	= ds_observacao || ds_observacao_p,
					cd_motivo_suspensao	= nr_seq_motivo_susp_w,
					ds_motivo_susp		= ds_justif_w
			where	nr_prescricao 	= nr_prescricao_p
			and 	nr_seq_proc_cpoe = nr_sequencia_p
			and		coalesce(dt_suspensao::text, '') = ''
			and		coalesce(ie_acm, 'N') = 'N'
			and		coalesce(ie_se_necessario, 'N') = 'N';
		end if;
	end if;
	end;
end if;

ie_suspendeu_hor_w 	:= false;
dt_suspensao_w 		:= null;
nr_seq_item_w 		:= null;
cd_item_w			:= null;

if (ie_tipo_item_p = 'AP') then

	select	max(dt_suspensao),
			max(nr_seq_motivo_susp),
			max(ds_motivo_susp)
	into STRICT	dt_suspensao_cpoe_w,
			nr_seq_motivo_susp_w,
			ds_justif_w
	from	cpoe_procedimento
	where	nr_sequencia = nr_sequencia_p
	and		nr_atendimento = nr_atendimento_p
	and 	(dt_lib_suspensao IS NOT NULL AND dt_lib_suspensao::text <> '');

	if (dt_suspensao_cpoe_w > dt_validade_prescr_w) then
		dt_suspensao_w := dt_validade_prescr_w;
	else
		dt_suspensao_w := dt_suspensao_cpoe_w;
	end if;

	select	max(c.nr_sequencia)
	into STRICT	nr_sequencia_w
	from	prescr_medica a,
			prescr_proc_hor b,
			prescr_procedimento c,
			cpoe_anatomia_patologica d
	where	a.nr_prescricao = b.nr_prescricao
	and		a.nr_prescricao = c.nr_prescricao
	and		b.nr_seq_procedimento = c.nr_sequencia
	and		a.nr_prescricao = nr_prescricao_p
	and		c.nr_seq_proc_cpoe = nr_sequencia_p
	and		c.nr_seq_proc_cpoe = d.nr_sequencia
	and	    coalesce(b.dt_fim_horario::text, '') = ''
	and	    coalesce(b.dt_suspensao::text, '') = ''
	and		((b.dt_horario >= dt_suspensao_w) or (coalesce(a.dt_liberacao::text, '') = '')  or (d.ie_forma_suspensao = 'I'));

	if (coalesce(nr_sequencia_w,0) > 0) then

		update	prescr_procedimento
		set		ie_suspenso			= 'S',
				nm_usuario			= nm_usuario_p,
				dt_atualizacao		= clock_timestamp(),
				dt_suspensao		= clock_timestamp(),
				nm_usuario_susp		= nm_usuario_p,
				ds_observacao		= ds_observacao || ds_observacao_p,
				cd_motivo_suspensao	= nr_seq_motivo_susp_w,
				ds_motivo_susp		= ds_justif_w
		where	nr_prescricao		= nr_prescricao_p
		and		nr_sequencia		= nr_sequencia_w;

		update	prescr_proc_hor
		set		nm_usuario			= nm_usuario_p,
				dt_atualizacao		= clock_timestamp(),
				dt_suspensao		= clock_timestamp()
		where	nr_prescricao		= nr_prescricao_p
		and 	nr_seq_procedimento = nr_sequencia_w;

	end if;
end if;

ie_suspendeu_hor_w 	:= false;
dt_suspensao_w 		:= null;
nr_seq_item_w 		:= null;
cd_item_w			:= null;

if (ie_tipo_item_p = 'N') and (ie_tipo_dieta_w = 'O') then --Dietas Oral
	begin

	ie_dieta_por_horar_w := obter_param_usuario(1113, 148, Obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, ie_dieta_por_horar_w);

	select	max(a.dt_suspensao),
		max(a.nr_seq_motivo_susp),
		max(a.ds_justificativa),
		max(a.cd_dieta),
		max(b.nr_sequencia)
	into STRICT	dt_suspensao_cpoe_w,
		nr_seq_motivo_susp_w,
		ds_justif_w,
		cd_dieta_cpoe_w,
		nr_seq_dieta_w
	from	cpoe_dieta a,
			prescr_dieta b
	where	a.nr_sequencia = nr_sequencia_p
	and		a.nr_atendimento = nr_atendimento_p
	and		a.nr_sequencia = b.nr_seq_dieta_cpoe
	and 	(a.dt_lib_suspensao IS NOT NULL AND a.dt_lib_suspensao::text <> '')
	and 	a.ie_tipo_dieta = 'O';

	if (dt_suspensao_cpoe_w > dt_validade_prescr_w) then
		dt_suspensao_w := dt_validade_prescr_w;
	else
		dt_suspensao_w := dt_suspensao_cpoe_w;
	end if;

	open C04;
	loop
	fetch C04 into
		nr_sequencia_w,
		cd_refeicao_w,
		cd_dieta_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
		update	prescr_dieta_hor
		set		dt_suspensao 	= dt_suspensao_w,
				nm_usuario_susp = nm_usuario_p
		where	nr_prescricao = nr_prescricao_p
		and		nr_sequencia = nr_sequencia_w;

		commit;

		if ((cd_refeicao_w IS NOT NULL AND cd_refeicao_w::text <> '') and ie_dieta_por_horar_w = 'S') then
			insert into prescr_mat_alteracao(
								nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								nr_prescricao,
								nr_seq_horario_dieta,
								dt_alteracao,
								cd_pessoa_fisica,
								ie_alteracao,
								nr_seq_qualidade,
								ds_justificativa,
								ds_observacao,
								ie_tipo_item,
								dt_horario,
								nr_atendimento,
								cd_item
								)
							values (
								nextval('prescr_mat_alteracao_seq'),
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								nr_prescricao_p,
								nr_sequencia_w,
								clock_timestamp(),
								obter_dados_usuario_opcao(nm_usuario_p,'C'),
								1,
								null,
								ds_justif_w,
								ds_observacao_p,
								'D',
								null,
								nr_atendimento_p,
								cd_refeicao_w
								);
		end if;

		ie_suspendeu_hor_w := true;
	end loop;
	close C04;

	if (ie_dieta_por_horar_w <> 'S' or coalesce(cd_refeicao_w::text, '') = '') then
		select	max(nr_horas_validade)
		into STRICT	nr_horas_validade_w
		from	prescr_medica
		where	nr_prescricao	= nr_prescricao_p;

		SELECT * FROM gerar_alteracao_horario_prescr(cd_estabelecimento_w, nr_atendimento_p, 'DS', cd_dieta_w, null, null, nr_horas_validade_w, null, nr_sequencia_w, null, nr_prescricao_p, nr_prescricao_p, null, 'N', 1, null, null, null, null, ds_justif_w, null, nm_usuario_p, 'N', null, null, nr_seq_motivo_susp_w, 'N', null, 'N', null, 'N', obter_perfil_ativo, null, 'N', null, null, null, null, null, 'N', null, null, null, null, '', '', cd_evolucao_w, null, null, ds_msg_w) INTO STRICT cd_evolucao_w, ds_msg_w;
	end if;


	if (ie_suspendeu_hor_w) then
		select 	count(*)
		into STRICT	nr_count_adm_w
		from	prescr_dieta_hor b,
				prescr_dieta c
		where	b.nr_prescricao 		= c.nr_prescricao
		and		b.nr_seq_dieta		 	= c.nr_sequencia
		and		b.nr_prescricao 		= nr_prescricao_p
		and 	c.nr_seq_dieta_cpoe 	= nr_sequencia_p
		and 	coalesce(b.dt_suspensao::text, '') = '';

		if (nr_count_adm_w = 0) then
			update 	prescr_dieta
			set		ie_suspenso 	= 'S',
					dt_suspensao 	= dt_suspensao_w,
					ds_observacao	= ds_observacao || ds_observacao_p,
					nr_seq_motivo_susp	= nr_seq_motivo_susp_w,
					ds_motivo_susp		= ds_justif_w
			where	nr_prescricao 	= nr_prescricao_p
			and 	nr_seq_dieta_cpoe = nr_sequencia_p;
		end if;
		
		/* Desfaz a prescricao como sendo de conduta dietoterapica na Gestao da Nutricao.*/

		if (ie_desfazer_conduta_w = 'S') then
			CALL nut_desfazer_prescr_nut_susp(nr_prescricao_p, 'PRESCR_DIETA', null, nm_usuario_p);
		end if;
	end if;
	end;
end if;

ie_suspendeu_hor_w 	:= false;
dt_suspensao_w 		:= null;
nr_seq_item_w 		:= null;
cd_item_w			:= null;

if (ie_tipo_item_p = 'G') then--Gasoterapia
	begin

	select	max(dt_suspensao)
	into STRICT	dt_suspensao_cpoe_w
	from	cpoe_gasoterapia
	where	nr_sequencia = nr_sequencia_p
	and		nr_atendimento = nr_atendimento_p
	and 	(dt_lib_suspensao IS NOT NULL AND dt_lib_suspensao::text <> '');

	if (dt_suspensao_cpoe_w > dt_validade_prescr_w) then
		dt_suspensao_w := dt_validade_prescr_w;
	else
		dt_suspensao_w := dt_suspensao_cpoe_w;
	end if;

	select	max(nr_sequencia)
	into STRICT 	nr_seq_gasoterapia_w
	from	prescr_gasoterapia
	where	nr_prescricao = nr_prescricao_p
	and		nr_seq_gas_cpoe = nr_sequencia_p;

	open C05;
	loop
	fetch C05 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C05 */
		CALL suspender_prescr_gas_hor(nr_prescricao_p, nr_seq_gasoterapia_w, nr_sequencia_w, nm_usuario_p, 'N');
		CALL gerar_alter_horario_item_assoc(nr_atendimento_p, 'IAO', nr_prescricao_p, nr_seq_gasoterapia_w, nr_sequencia_w,
						dt_horario_w, clock_timestamp(), 5, nm_usuario_p);
		ie_suspendeu_hor_w := true;
	end loop;
	close C05;

	if (ie_suspendeu_hor_w) then
		insert into prescr_gasoterapia_evento(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_gasoterapia,
					ie_evento,
					dt_evento,
					ie_evento_valido)
				values (nextval('prescr_gasoterapia_evento_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_gasoterapia_w,
					'S',
					clock_timestamp(),
					'S');

		select 	count(*)
		into STRICT	nr_count_adm_w
		from	prescr_gasoterapia_hor b,
				prescr_gasoterapia c
		where	b.nr_prescricao 		= c.nr_prescricao
		and		b.nr_seq_gasoterapia 	= c.nr_sequencia
		and		b.nr_prescricao 		= nr_prescricao_p
		and 	c.nr_seq_gas_cpoe 		= nr_sequencia_p
		and 	coalesce(b.dt_suspensao::text, '') = '';

		if (nr_count_adm_w = 0) then

			update 	prescr_gasoterapia
			set		ie_suspenso 	= 'S',
					dt_suspensao 	= dt_suspensao_w,
					ds_observacao	= ds_observacao || ds_observacao_p,
					nr_seq_motivo_susp	= nr_seq_motivo_susp_w,
					ds_motivo_susp		= ds_justif_w
			where	nr_prescricao 	= nr_prescricao_p
			and 	nr_seq_gas_cpoe = nr_sequencia_p;
		end if;
	end if;

	end;
end if;

ie_suspendeu_hor_w 	:= false;
dt_suspensao_w 		:= null;
nr_seq_item_w 		:= null;
cd_item_w		:= null;

if (ie_tipo_item_p = 'DI' OR ie_tipo_item_p = 'DP' OR ie_tipo_item_p = 'D') then --Dialise
		select	max(a.nr_sequencia)
		into STRICT	nr_seq_dialise_w
		from	hd_prescricao a
		where	a.nr_seq_dialise_cpoe = nr_sequencia_p
		and		a.nr_prescricao = nr_prescricao_p;

		open C09;
		loop
		fetch C09 into
			nr_seq_solucao_w;
		EXIT WHEN NOT FOUND; /* apply on C09 */

			update	prescr_solucao
			set		ie_suspenso	= 'S',
					ie_status = 'S',
					nm_usuario	= nm_usuario_p,
					dt_atualizacao	= clock_timestamp(),
					dt_suspensao	= clock_timestamp(),
					nm_usuario_susp	= nm_usuario_p,
					ds_orientacao	= ds_orientacao || ds_observacao_p,
					nr_seq_motivo_susp	= nr_seq_motivo_susp_w,
					ds_motivo_susp		= ds_justif_w
			where	nr_prescricao	= nr_prescricao_p
			and		nr_seq_solucao	= nr_seq_solucao_w
			and		(nr_seq_dialise IS NOT NULL AND nr_seq_dialise::text <> '')
			and 	coalesce(ie_status,'P') in ('N','P');

			commit;

			select	coalesce(max('S'),'N')
			into STRICT 	ie_atualizou_w
			from 	prescr_solucao where nr_seq_solucao = nr_seq_solucao_w
			and nr_prescricao = nr_prescricao_p
			and	coalesce(ie_suspenso,'N') = 'S'
			and	(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
			and	(nm_usuario_susp IS NOT NULL AND nm_usuario_susp::text <> '') LIMIT 1;

			if (coalesce(ie_atualizou_w,'N') = 'S') then

				update hd_prescricao
				set ie_status = 'SI'
				where nr_prescricao = nr_prescricao_p
				and nr_seq_dialise_cpoe = nr_sequencia_p
				and nr_sequencia = nr_seq_dialise_w;

				update	prescr_material
				set		ie_suspenso		= 'S',
						nm_usuario		= nm_usuario_p,
						dt_atualizacao	= clock_timestamp(),
						dt_suspensao	= clock_timestamp(),
						nm_usuario_susp	= nm_usuario_p,
						ds_observacao	= ds_observacao || ds_observacao_p,
						nr_seq_motivo_susp	= nr_seq_motivo_susp_w,
					ds_motivo_susp		= ds_justif_w
				where	nr_prescricao	= nr_prescricao_p
				and		nr_sequencia_solucao = nr_seq_solucao_w;

			end if;

			insert into hd_prescricao_evento(
							nr_sequencia,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							dt_atualizacao,
							nm_usuario,
							nr_prescricao,
							nr_seq_solucao,
							nr_etapa_evento,
							ie_evento,
							dt_evento,
							cd_pessoa_evento,
							dt_ciclo)
				values (	nextval('hd_prescricao_evento_seq'),
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							nr_prescricao_p,
							nr_seq_solucao_w,
							null,
							'SI',
							clock_timestamp(),
							substr(obter_dados_usuario_opcao(nm_usuario_p,'C'),1,10),
							null);

		end loop;
		close C09;
end if;


if (ie_tipo_dieta_w = 'J') then

	select	max(dt_suspensao),
		max(nr_seq_motivo_susp),
		max(ds_motivo_susp)
	into STRICT	dt_suspensao_cpoe_w,
		nr_seq_motivo_susp_w,
		ds_justif_w
	from	cpoe_dieta
	where	nr_sequencia = nr_sequencia_p
	and	nr_atendimento = nr_atendimento_p
	and 	(dt_lib_suspensao IS NOT NULL AND dt_lib_suspensao::text <> '');

	if (dt_suspensao_cpoe_w > dt_validade_prescr_w) then
		dt_suspensao_w := dt_validade_prescr_w;
	else
		dt_suspensao_w := dt_suspensao_cpoe_w;
	end if;

	update	rep_jejum
	set	dt_fim 		= dt_suspensao_w,
		ds_observacao	= ds_observacao || ds_observacao_p,
		ie_suspenso 	= 'S'
	where	nr_prescricao 	  = nr_prescricao_p
	and	nr_seq_dieta_cpoe = nr_sequencia_p;

	select	max(PKG_DATE_FORMATERS.to_varchar(c.dt_inicio, 'timestamp', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, nm_usuario_p) || '-' || PKG_DATE_FORMATERS.to_varchar(c.dt_fim, 'timestamp', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, nm_usuario_p))
	into STRICT	cd_item_w
	from	rep_jejum c
	where	nr_prescricao = nr_prescricao_p
	and		nr_seq_dieta_cpoe = nr_sequencia_p;

	select	nextval('prescr_mat_alteracao_seq')
	into STRICT	nr_seq_alteracao_w
	;

	insert into	prescr_mat_alteracao(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_prescricao,
				nr_seq_prescricao,
				nr_seq_horario,
				dt_alteracao,
				cd_pessoa_fisica,
				ie_alteracao,
				ds_justificativa,
				ie_tipo_item,
				dt_horario,
				nr_atendimento,
				cd_item,
				qt_dose_adm,
				cd_um_dose_adm,
				qt_dose_original,
				nr_agrupamento,
				ie_acm_sn,
				cd_medico_solic,
				ds_observacao,
				nr_seq_motivo_susp,
				ie_mostra_adep,
				nr_seq_assinatura,
				nr_seq_lote)
		values (
				nr_seq_alteracao_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_prescricao_p,
				null,
				null,
				clock_timestamp(),
				obter_dados_usuario_opcao(nm_usuario_p,'C'),
				1,
				ds_justif_w,
				'J',
				clock_timestamp(),
				nr_atendimento_p,
				cd_item_w,
				null,
				null,
				null,
				null,
				'N',
				null,
				null,
				nr_seq_motivo_susp_w,
				'S',
				null,
				null);

	/* Desfaz a prescricao como sendo de conduta dietoterapica na Gestao da Nutricao.*/

	if (ie_desfazer_conduta_w = 'S') then
		CALL nut_desfazer_prescr_nut_susp(nr_prescricao_p, 'REP_JEJUM', null, nm_usuario_p);
	end if;

end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

exception
when others then
	rollback;

	ds_erro_w := substr(sqlerrm,1,1000);
	CALL gravar_log_cpoe('CPOE_SUSPENDER_HOR_ITEM_PRESCR exception: '||ds_erro_w||
			' nr_prescricao_p: '||nr_prescricao_p||
			' nr_sequencia_p: '||nr_sequencia_p||
			' ie_tipo_item_p: '||ie_tipo_item_p||
			' nm_usuario_p: '||nm_usuario_p||
			' ds_observacao_p: '||ds_observacao_p||
			' ie_interv_farmacia_p: '||ie_interv_farmacia_p,nr_atendimento_p);

	commit;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_suspender_hor_item_prescr ( nr_prescricao_p bigint, nr_sequencia_p bigint, ie_tipo_item_p text, nr_atendimento_p bigint, nm_usuario_p text, ds_observacao_p text default null, ie_interv_farmacia_p text default 'N') FROM PUBLIC;

