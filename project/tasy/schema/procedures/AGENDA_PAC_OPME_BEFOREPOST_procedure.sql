-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE agenda_pac_opme_beforepost ( ds_grupos_adic_mat_p text, cd_material_p bigint, cd_material_old_p bigint, ie_consiste_saldo_disp_p text, ie_insert_p text, ie_edicao_p text, qt_material_old_p bigint, qt_material_p bigint, cd_setor_atendimento_p bigint, cd_convenio_p bigint, nr_seq_proc_interno_p bigint, nr_seq_agenda_p bigint, ie_valida_maior_zero_p text, ie_consiste_material_opme_p text, ie_mat_codigo_p text, cd_estabelecimento_p bigint, ds_mensagem_p INOUT text, nm_usuario_p text) AS $body$
DECLARE

 
cd_local_estoque_w	smallint;
qt_conversao_w		double precision;
qt_saldo_disp_w		double precision;
cd_tipo_convenio_w	smallint;
ie_grupo_nao_lib_w	varchar(1);
ie_mat_compativel_w	varchar(1);
ie_cadastrado_w		varchar(1);
ds_mensagem_w		varchar(2000);

BEGIN
if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then 
	begin 
 
	if (ds_grupos_adic_mat_p IS NOT NULL AND ds_grupos_adic_mat_p::text <> '') then 
		begin 
		select	CASE WHEN coalesce(count(*),0)=0 THEN 'N'  ELSE 'S' END  
		into STRICT	ie_grupo_nao_lib_w 
		from	estrutura_material_v 
		where	obter_se_contido_char(cd_grupo_material, ds_grupos_adic_mat_p) = 'S';
 
		if (ie_grupo_nao_lib_w = 'S') then 
			begin 
			CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(281310, 'PARAMETRO=' || obter_texto_dic_objeto(73637, wheb_usuario_pck.get_nr_seq_idioma, null));
			end;
		end if;
		end;
	end if;
 
	if (ie_consiste_saldo_disp_p = 'S') and 
		((ie_insert_p = 'S') or (ie_edicao_p = 'S')) and (qt_material_old_p <> qt_material_p) then 
		begin 
 
		select	cd_local_estoque 
		into STRICT	cd_local_estoque_w 
		from	setor_atendimento 
		where	cd_setor_atendimento	= cd_setor_atendimento_p;
 
		select	coalesce(qt_conv_estoque_consumo,1) 
		into STRICT	qt_conversao_w 
		from	material 
		where	cd_material	= cd_material_p;
 
		qt_saldo_disp_w		:= coalesce(obter_saldo_disp_estoque(cd_estabelecimento_p, cd_material_p,cd_local_estoque_w, trunc(clock_timestamp(),'mm')),0);
 
		if (ie_edicao_p = 'S') and (qt_material_old_p <> qt_material_p) then 
			begin 
			qt_saldo_disp_w	:= qt_saldo_disp_w + qt_material_p;
			end;
		end if;
 
		if	(qt_saldo_disp_w < (qt_material_p / qt_conversao_w)) then 
			begin 
			ds_mensagem_w	:= obter_texto_dic_objeto(73642, wheb_usuario_pck.get_nr_seq_idioma, 'QT_DISPONIVEL='||qt_saldo_disp_w||';QT_SOLICITADA='||qt_material_p);
			end;
		end if;
		end;
	end if;
 
	if (ie_valida_maior_zero_p	<> 'S') and (qt_material_p < 1) then 
		begin 
		CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(281310, 'PARAMETRO=' || obter_texto_dic_objeto(73643, wheb_usuario_pck.get_nr_seq_idioma,null));
		end;
	end if;
 
	if (ie_consiste_material_opme_p = 'S') then 
		begin 
		cd_tipo_convenio_w	:= obter_tipo_convenio(cd_convenio_p);
 
		if (cd_tipo_convenio_w = 3) then 
			begin 
			ie_mat_compativel_w	:= sus_obter_se_mat_compativel(cd_estabelecimento_p,cd_convenio_p,nr_seq_proc_interno_p,null,null,cd_material_p);
 
			if (ie_mat_compativel_w <> 'S') then 
				begin 
				CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(281310, 'PARAMETRO=' || obter_texto_dic_objeto(73645, wheb_usuario_pck.get_nr_seq_idioma,null));
				end;
			end if;
			end;
		end if;
		end;
	end if;
 
	if (ie_mat_codigo_p <> 'S') and 
		((ie_insert_p = 'S') or (ie_edicao_p = 'S')) and (cd_material_old_p <> cd_material_p) then 
		begin 
		select	CASE WHEN coalesce(count(*),0)=0 THEN 'N'  ELSE 'S' END  
		into STRICT	ie_cadastrado_w 
		from	agenda_pac_opme 
		where	coalesce(nr_seq_motivo_exclusao::text, '') = '' 
		and	nr_seq_agenda	= nr_seq_agenda_p 
		and	cd_material	= cd_material_p;
 
		if (ie_cadastrado_w = 'S') then 
			begin 
			CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(281310, 'PARAMETRO=' || obter_texto_dic_objeto(73647, wheb_usuario_pck.get_nr_seq_idioma,null));
			end;
		end if;
		end;
	end if;
	end;
end if;
ds_mensagem_p := ds_mensagem_w;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE agenda_pac_opme_beforepost ( ds_grupos_adic_mat_p text, cd_material_p bigint, cd_material_old_p bigint, ie_consiste_saldo_disp_p text, ie_insert_p text, ie_edicao_p text, qt_material_old_p bigint, qt_material_p bigint, cd_setor_atendimento_p bigint, cd_convenio_p bigint, nr_seq_proc_interno_p bigint, nr_seq_agenda_p bigint, ie_valida_maior_zero_p text, ie_consiste_material_opme_p text, ie_mat_codigo_p text, cd_estabelecimento_p bigint, ds_mensagem_p INOUT text, nm_usuario_p text) FROM PUBLIC;

