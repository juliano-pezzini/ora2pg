-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_aval_fornec_inspecao ( dt_inicio_p timestamp, dt_final_p timestamp, cd_grupo_material_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_cgc_emitente_w			varchar(14);
cd_grupo_material_w			bigint;
qt_entregue_w				bigint;
qt_sem_inspecao_w			bigint;
qt_nao_conformidade_w			bigint;
qt_devolucao_w				bigint;
qt_data_superior_oc_w			bigint;
qt_quantidade_maior_oc_w			bigint;

c01 CURSOR FOR
SELECT	distinct
	a.cd_cgc_emitente
from	nota_fiscal a,
	nota_fiscal_item b,
	estrutura_material_v e
where	a.nr_sequencia = b.nr_sequencia
and	b.cd_material = e.cd_material
and	a.cd_estabelecimento = cd_estabelecimento_p
and	((cd_grupo_material_w = 0) or (e.cd_grupo_material = cd_grupo_material_w))
and	a.dt_atualizacao_estoque between dt_inicio_p and fim_dia(dt_final_p)
and	a.ie_tipo_nota = 'EN'
and	(a.cd_cgc_emitente IS NOT NULL AND a.cd_cgc_emitente::text <> '');


BEGIN

cd_grupo_material_w	:= coalesce(cd_grupo_material_p,0);

delete from w_aval_fornec_inspecao
where nm_usuario = nm_usuario_p;

open C01;
loop
fetch C01 into
	cd_cgc_emitente_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	coalesce(sum(qt_material),0)
	into STRICT	qt_entregue_w
	from(
		SELECT	coalesce(count(distinct b.cd_material),0) qt_material
		from	nota_fiscal a,
			nota_fiscal_item b,
			estrutura_material_v e
		where	a.nr_sequencia = b.nr_sequencia
		and	b.cd_material = e.cd_material
		and	a.cd_estabelecimento = cd_estabelecimento_p
		and	((cd_grupo_material_w = 0) or (e.cd_grupo_material = cd_grupo_material_w))
		and	a.dt_atualizacao_estoque between dt_inicio_p and fim_dia(dt_final_p)
		and	a.cd_cgc_emitente = cd_cgc_emitente_w
		and	a.ie_tipo_nota = 'EN'
		and	(a.cd_cgc_emitente IS NOT NULL AND a.cd_cgc_emitente::text <> '')
		group by	a.nr_nota_fiscal);

	select	coalesce(sum(qt_material),0)
	into STRICT	qt_sem_inspecao_w
	from(
		SELECT	coalesce(count(distinct b.cd_material),0) qt_material
		from	nota_fiscal a,
			nota_fiscal_item b,
			estrutura_material_v e
		where	a.nr_sequencia = b.nr_sequencia
		and	b.cd_material = e.cd_material
		and	a.cd_estabelecimento = cd_estabelecimento_p
		and	((cd_grupo_material_w = 0) or (e.cd_grupo_material = cd_grupo_material_w))
		and	a.dt_atualizacao_estoque between dt_inicio_p and fim_dia(dt_final_p)
		and	a.cd_cgc_emitente = cd_cgc_emitente_w
		and	a.ie_tipo_nota = 'EN'
		and	(a.cd_cgc_emitente IS NOT NULL AND a.cd_cgc_emitente::text <> '')
		and not exists (
			SELECT	1
			from	inspecao_recebimento x
			where	x.nr_seq_nota_fiscal = b.nr_sequencia
			and	x.nr_seq_item_nf = b.nr_item_nf)
		group by	a.nr_nota_fiscal);

	select	coalesce(sum(qt_material),0)
	into STRICT	qt_nao_conformidade_w
	from(
		SELECT	coalesce(count(distinct b.cd_material),0) qt_material
		from	nota_fiscal a,
			nota_fiscal_item b,
			estrutura_material_v e
		where	a.nr_sequencia = b.nr_sequencia
		and	b.cd_material = e.cd_material
		and	a.cd_estabelecimento = cd_estabelecimento_p
		and	((cd_grupo_material_w = 0) or (e.cd_grupo_material = cd_grupo_material_w))
		and	a.dt_atualizacao_estoque between dt_inicio_p and fim_dia(dt_final_p)
		and	a.cd_cgc_emitente = cd_cgc_emitente_w
		and	a.ie_tipo_nota = 'EN'
		and	(a.cd_cgc_emitente IS NOT NULL AND a.cd_cgc_emitente::text <> '')
		and exists (
			SELECT	1
			from	inspecao_recebimento x
			where	x.nr_seq_nota_fiscal = b.nr_sequencia
			and	x.nr_seq_item_nf = b.nr_item_nf
			and	(x.nr_seq_tipo_nao_conf IS NOT NULL AND x.nr_seq_tipo_nao_conf::text <> ''))
		group by	a.nr_nota_fiscal);

	select	coalesce(sum(qt_material),0)
	into STRICT	qt_devolucao_w
	from(
		SELECT	coalesce(count(distinct b.cd_material),0) qt_material
		from	nota_fiscal a,
			nota_fiscal_item b,
			estrutura_material_v e
		where	a.nr_sequencia = b.nr_sequencia
		and	b.cd_material = e.cd_material
		and	a.cd_estabelecimento = cd_estabelecimento_p
		and	((cd_grupo_material_w = 0) or (e.cd_grupo_material = cd_grupo_material_w))
		and	a.dt_atualizacao_estoque between dt_inicio_p and fim_dia(dt_final_p)
		and	a.cd_cgc_emitente = cd_cgc_emitente_w
		and	a.ie_tipo_nota = 'EN'
		and	(a.cd_cgc_emitente IS NOT NULL AND a.cd_cgc_emitente::text <> '')
		and exists (
			SELECT	1
			from	inspecao_recebimento x
			where	x.nr_seq_nota_fiscal = b.nr_sequencia
			and	x.nr_seq_item_nf = b.nr_item_nf
			and	(x.ie_motivo_devolucao IS NOT NULL AND x.ie_motivo_devolucao::text <> ''))
		group by	a.nr_nota_fiscal);

	select	coalesce(sum(qt_material),0)
	into STRICT	qt_data_superior_oc_w
	from(
		SELECT	coalesce(count(distinct b.cd_material),0) qt_material
		from	nota_fiscal a,
			nota_fiscal_item b,
			estrutura_material_v e
		where	a.nr_sequencia = b.nr_sequencia
		and	b.cd_material = e.cd_material
		and	a.cd_estabelecimento = cd_estabelecimento_p
		and	((cd_grupo_material_w = 0) or (e.cd_grupo_material = cd_grupo_material_w))
		and	a.dt_atualizacao_estoque between dt_inicio_p and fim_dia(dt_final_p)
		and	a.cd_cgc_emitente = cd_cgc_emitente_w
		and	a.ie_tipo_nota = 'EN'
		and	(a.cd_cgc_emitente IS NOT NULL AND a.cd_cgc_emitente::text <> '')
		and exists (
			SELECT	1
			from	inspecao_recebimento x
			where	x.nr_seq_nota_fiscal = b.nr_sequencia
			and	x.nr_seq_item_nf = b.nr_item_nf
			and	x.dt_entrega_real > obter_dt_prev_oci_inspecao(x.nr_sequencia))
		group by	a.nr_nota_fiscal);

	select	coalesce(sum(qt_material),0)
	into STRICT	qt_quantidade_maior_oc_w
	from(
		SELECT	coalesce(count(distinct b.cd_material),0) qt_material
		from	nota_fiscal a,
			nota_fiscal_item b,
			estrutura_material_v e
		where	a.nr_sequencia = b.nr_sequencia
		and	b.cd_material = e.cd_material
		and	a.cd_estabelecimento = cd_estabelecimento_p
		and	((cd_grupo_material_w = 0) or (e.cd_grupo_material = cd_grupo_material_w))
		and	a.dt_atualizacao_estoque between dt_inicio_p and fim_dia(dt_final_p)
		and	a.cd_cgc_emitente = cd_cgc_emitente_w
		and	a.ie_tipo_nota = 'EN'
		and	(a.cd_cgc_emitente IS NOT NULL AND a.cd_cgc_emitente::text <> '')
		and exists (
			SELECT	1
			from	inspecao_recebimento x
			where	x.nr_seq_nota_fiscal = b.nr_sequencia
			and	x.nr_seq_item_nf = b.nr_item_nf
			and	x.qt_inspecao > obter_qt_prev_oci_inspecao(x.nr_sequencia))
		group by	a.nr_nota_fiscal);

	insert into w_aval_fornec_inspecao(
		nm_usuario,
		cd_cnpj,
		qt_entregue,
		qt_sem_inspecao,
		qt_nao_conformidade,
		qt_devolucao,
		qt_data_superior_oc,
		qt_quantidade_maior_oc)
	values (	nm_usuario_p,
		cd_cgc_emitente_w,
		qt_entregue_w,
		qt_sem_inspecao_w,
		qt_nao_conformidade_w,
		qt_devolucao_w,
		qt_data_superior_oc_w,
		qt_quantidade_maior_oc_w);

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_aval_fornec_inspecao ( dt_inicio_p timestamp, dt_final_p timestamp, cd_grupo_material_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

