-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_gerar_aih_paga ( nr_seq_protocolo_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_aih_w		bigint;
nr_seq_aih_w		bigint;
dt_mesano_refer_w	timestamp;
dt_alta_w		timestamp;
vl_conta_w		double precision;

c01 CURSOR FOR 
	SELECT	b.nr_aih, 
		b.nr_sequencia, 
		a.dt_mesano_referencia, 
		coalesce(b.dt_final, c.dt_alta), 
		a.vl_conta 
	from	atendimento_paciente c, 
		sus_aih b, 
		conta_paciente a 
	where a.nr_interno_conta = b.nr_interno_conta 
	 and a.nr_atendimento	 = c.nr_atendimento 
	 and a.nr_seq_protocolo = nr_seq_protocolo_p 
	 and not exists (SELECT 1 from sus_aih_rejeitada x 
			 where x.nr_seq_protocolo = a.nr_seq_protocolo 
			  and x.nr_aih	  = b.nr_aih 
			  and x.nr_seq_aih	  = b.nr_sequencia);

BEGIN
 
open c01;
loop 
fetch c01 into	nr_aih_w, 
		nr_seq_aih_w, 
		dt_mesano_refer_w, 
		dt_alta_w, 
		vl_conta_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
 
	insert into sus_aih_paga(NR_SEQUENCIA, NR_AIH, NR_PROCESSO, 
				 DT_APRESENTACAO, DT_ATUALIZACAO, NM_USUARIO, 
				 CD_PROC_REALIZADO, DT_ALTA, QT_DIAS_UTI, 
				 QT_DIAS_ACOMPANHANTE, VL_SH, VL_SP, 
				 QT_PONTOS_SP, VL_SADT, QT_PONTOS_SADT, 
				 VL_SANGUE, VL_OPM, VL_RNATO, 
				 VL_S_RATEIO, VL_ANALG, VL_PEDCON, 
				 NR_IDENT, NR_SEQ_PROTOCOLO, DT_ATUALIZACAO_NREC, 
				 NM_USUARIO_NREC, NR_SEQ_AIH) 
	values (nextval('sus_aih_paga_seq'), nr_aih_w, 0, 
		dt_mesano_refer_w, clock_timestamp(), nm_usuario_p, 
		null, dt_alta_w, null, 
		null, vl_conta_w, null, 
		null, null, null, 
		null, null, null, 
		null, null, null, 
		null, nr_seq_protocolo_p, clock_timestamp(), 
		nm_usuario_p, nr_seq_aih_w);
 
end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_gerar_aih_paga ( nr_seq_protocolo_p bigint, nm_usuario_p text) FROM PUBLIC;

