-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_consulta_res ( nr_atendimento_p bigint, nr_seq_prontuario_p text default null, cd_transacao_p bigint DEFAULT NULL, ie_regra_p text DEFAULT NULL, IE_TIPO_INFO_HSF_p text default 'N', QT_REQUISITADA_HSF_p bigint default 0, IE_TIPO_INFO_HSA_p text default 'N', QT_REQUISITADA_HSA_p bigint default 0, IE_TIPO_INFO_AT_p text default 'N', QT_REQUISITADA_AT_p bigint default 0, IE_TIPO_INFO_EI_p text default 'N', QT_REQUISITADA_EI_p bigint default 0, IE_TIPO_INFO_EL_p text default 'N', QT_REQUISITADA_EL_p bigint default 0, IE_TIPO_INFO_HSH_p text default 'N', QT_REQUISITADA_HSH_p bigint default 0, IE_TIPO_INFO_IM_p text default 'N', QT_REQUISITADA_IM_p bigint default 0, IE_TIPO_INFO_ME_p text default 'N', QT_REQUISITADA_ME_p bigint default 0, IE_TIPO_INFO_EDP_p text default 'N', QT_REQUISITADA_EDP_p bigint default 0, IE_TIPO_INFO_DI_p text default 'N', QT_REQUISITADA_DI_p bigint default 0, IE_TIPO_INFO_PR_p text default 'N', QT_REQUISITADA_PR_p bigint default 0, IE_TIPO_INFO_TS_p text default 'N', QT_REQUISITADA_TS_p bigint default 0, IE_TIPO_INFO_SVA_p text default 'N', QT_REQUISITADA_SVA_p bigint default 0) AS $body$
DECLARE


ie_resUnimed_w				varchar(1);
ds_param_integ_hl7_w 		varchar(4000);
cd_convenio_w				integer;
ie_atualiza_w				varchar(1);
cd_especialidade_medica_w	smallint;
usuario_ativo_w				varchar(10);
cd_profissional_w			varchar(10);
ie_empresa_res_w			varchar(100);
ie_tipo_consulta_res_w		varchar(100);
qt_dias_w					numeric(20);
ie_tipo_area_w				varchar(1000);
cd_perfil_ativo_w			bigint;
qt_requisicao_w				bigint;
nr_requisicao_w				bigint;
cd_pessoa_fisica_w			varchar(10);
nm_usuario_w				varchar(15);
qt_registros_automaticos	varchar(1);
cd_estabelecimento_w		varchar(50) := obter_estabelecimento_ativo;

C01 CURSOR FOR
	SELECT  a.ie_empresa_res,
			a.qt_dias,
			a.ie_tipo_area
	FROM 	res_regra_consulta a,
			RES_REGRA_CONSULTA_LIB b
	WHERE 	b.nr_seq_regra = a.nr_sequencia
	AND (b.cd_estabelecimento = obter_estabelecimento_ativo OR coalesce(b.cd_estabelecimento::text, '') = '')
	AND (b.cd_perfil = obter_perfil_ativo OR coalesce(b.cd_perfil::text, '') = '')
	AND (obter_se_especialidade_medico(cd_profissional_w, b.cd_especialidade) = 'S' OR coalesce(b.cd_especialidade::text, '') = '');



	procedure gerar_integracao_res( 	nr_seq_pront_p 			text,
										nr_atend_p				bigint,
										cd_transacao_res_p 		bigint,
										ie_empresa_res_p		text,
										ie_tipo_consulta_res_p 	text,
										qt_dias_p				bigint,
										ie_tipo_area_p			text,
										pessoa_fisica_p			text,
										ie_regra_res_p			text,
										nr_requisicao_p			bigint := 0,
										qt_requisicao_p			bigint) is



;
BEGIN


   	cd_perfil_ativo_w := obter_perfil_ativo;
	
			ds_param_integ_hl7_w := 'nr_seq_prontuario_emissao=' 	|| nr_seq_pront_p  || ';' ||
											'nr_atendimento='       || nr_atend_p            || ';' ||
											'cd_transacao='         || cd_transacao_res_p            || ';' ||
											'ie_empresa_res='       || ie_empresa_res_p            || ';' ||
											'ie_tipo_consulta_res=' || ie_tipo_consulta_res_p            || ';' ||
											'qt_dias='              || qt_dias_p            || ';' ||
											'ie_tipo_area='         || ie_tipo_area_p            || ';' ||
											'cd_pf_usuario='        || pessoa_fisica_p            || ';'||
											'ie_regra='             || ie_regra_res_p            || ';' ||
											'cd_perfil_ativo='             || cd_perfil_ativo_w            || ';' ||
											'cd_estabelecimento='               || cd_estabelecimento_w      || ';' ||
											'qt_requisicao='             || qt_requisicao_p            || ';' ||
											'nr_requisicao='             || nr_requisicao_p            || ';' ||
											'nr_seq_idioma='             || wheb_usuario_pck.get_nr_seq_idioma   || ';';

			CALL gravar_agend_integracao(682, ds_param_integ_hl7_w);


   end;

begin


If ( coalesce(nr_atendimento_p,0) > 0 ) then

	
	Select 	obter_pessoa_atendimento(nr_atendimento_p,'C'),
			wheb_usuario_pck.get_nm_usuario,
			Obter_Convenio_Atendimento(nr_atendimento_p)
	into STRICT	cd_pessoa_fisica_w,
			nm_usuario_w,
			cd_convenio_w
	;
	
	
	Select  coalesce(max('S'),'N')
	into STRICT	ie_resUnimed_w
	from    conversao_meio_externo
	where   upper(cd_externo) = 'RESUNIMED'
	and		upper(nm_tabela) = 'ATEND_CATEGORIA_CONVENIO'
	and     cd_interno = to_char(cd_convenio_w);
	
		
	if ( ie_resUnimed_w = 'S') then
	
		nr_requisicao_w := 0;
		cd_profissional_w := Obter_Pessoa_Fisica_Usuario(nm_usuario_w, 'C');
		ie_tipo_consulta_res_w := 'DADOS_CLINICOS';
		

		
		if (ie_regra_p = 'M') then

			ie_empresa_res_w := 'UNI';
			ie_tipo_consulta_res_w := 'DADOS_CLINICOS';
			
			
			Select  CASE WHEN ie_tipo_info_hsf_p='S' THEN 1  ELSE 0 END  +  CASE WHEN IE_TIPO_INFO_HSA_p='S' THEN 1  ELSE 0 END  +  CASE WHEN IE_TIPO_INFO_AT_p='S' THEN 1  ELSE 0 END  + CASE WHEN IE_TIPO_INFO_EI_p='S' THEN 1  ELSE 0 END  +
					CASE WHEN ie_tipo_info_el_p='S' THEN 1  ELSE 0 END  +  CASE WHEN IE_TIPO_INFO_HSH_p='S' THEN 1  ELSE 0 END  +  CASE WHEN IE_TIPO_INFO_IM_p='S' THEN 1  ELSE 0 END  + CASE WHEN IE_TIPO_INFO_ME_p='S' THEN 1  ELSE 0 END  +
					CASE WHEN ie_tipo_info_edp_p='S' THEN 1  ELSE 0 END  +  CASE WHEN IE_TIPO_INFO_DI_p='S' THEN 1  ELSE 0 END  +  CASE WHEN IE_TIPO_INFO_PR_p='S' THEN 1  ELSE 0 END  + CASE WHEN IE_TIPO_INFO_TS_p='S' THEN 1  ELSE 0 END  +
					CASE WHEN IE_TIPO_INFO_SVA_p='S' THEN 1  ELSE 0 END
			into STRICT	qt_requisicao_w
			;
			
			delete 	from res_paciente_resultado
			where	cd_pessoa_fisica = cd_pessoa_fisica_w
			and		cd_profissional_dest = cd_profissional_w
			and		nm_usuario = nm_usuario_w
			and		(qt_requisicao IS NOT NULL AND qt_requisicao::text <> '');
			
			insert into res_paciente_resultado(	NR_SEQUENCIA,
													DT_ATUALIZACAO,
													NM_USUARIO,
													CD_PESSOA_FISICA, 
													IE_TIPO_CONSULTA, 
													IE_TIPO,
													IE_EMPRESA, 
													DT_INFORMACAO, 
													DS_INFORMACAO,
													CD_PROFISSIONAL_DEST,
													qt_requisicao,
													qt_requisicao_atual) 
										values ( 	nextval('res_paciente_resultado_seq'), 
													clock_timestamp(),
													nm_usuario_w,
													cd_pessoa_fisica_w,
													'C',
													'AT',
													'UNI',
													clock_timestamp(),
													'Requisicao',
													cd_profissional_w,
													qt_requisicao_w,
													0);
			commit;		
			
			
			


			if ( coalesce(ie_tipo_info_hsf_p,'N') = 'S' ) then

				ie_tipo_area_w 	:= 'ANTECEDENTES_FAMILIARES';
				qt_dias_w 		:= QT_REQUISITADA_HSF_p;
				nr_requisicao_w := nr_requisicao_w + 1;

				gerar_integracao_res(nr_seq_prontuario_p, nr_atendimento_p, cd_transacao_p, ie_empresa_res_w, ie_tipo_consulta_res_w, qt_dias_w, ie_tipo_area_w, cd_profissional_w, ie_regra_p,nr_requisicao_w, qt_requisicao_w);

			end if;

			if ( coalesce(IE_TIPO_INFO_HSA_p,'N') = 'S' ) then

				ie_tipo_area_w 	:= 'ANTECEDENTES_PESSOAIS';
				qt_dias_w 		:= QT_REQUISITADA_HSA_p;
				nr_requisicao_w := nr_requisicao_w + 1;

				gerar_integracao_res(nr_seq_prontuario_p, nr_atendimento_p, cd_transacao_p, ie_empresa_res_w, ie_tipo_consulta_res_w, qt_dias_w, ie_tipo_area_w, cd_profissional_w, ie_regra_p,nr_requisicao_w, qt_requisicao_w);

			end if;


			if ( coalesce(IE_TIPO_INFO_AT_p,'N') = 'S' ) then

				ie_tipo_area_w 	:= 'ANTROPOMETRIA';
				qt_dias_w 		:= qt_requisitada_AT_p;
				nr_requisicao_w := nr_requisicao_w + 1;

				gerar_integracao_res(nr_seq_prontuario_p, nr_atendimento_p, cd_transacao_p, ie_empresa_res_w, ie_tipo_consulta_res_w, qt_dias_w, ie_tipo_area_w, cd_profissional_w, ie_regra_p, nr_requisicao_w, qt_requisicao_w);

			end if;

			if ( coalesce(IE_TIPO_INFO_EI_p,'N') = 'S' ) then

				ie_tipo_area_w 	:= 'EXAMES_DE_IMAGEM';
				qt_dias_w 		:= qt_requisitada_EI_p;
				nr_requisicao_w := nr_requisicao_w + 1;

				gerar_integracao_res(nr_seq_prontuario_p, nr_atendimento_p, cd_transacao_p, ie_empresa_res_w, ie_tipo_consulta_res_w, qt_dias_w, ie_tipo_area_w, cd_profissional_w, ie_regra_p, nr_requisicao_w, qt_requisicao_w);

			end if;


			if ( coalesce(IE_TIPO_INFO_EL_p,'N') = 'S' ) then

				ie_tipo_area_w 	:= 'EXAMES_DE_LABORATORIO';
				qt_dias_w 		:= qt_requisitada_EL_p;
				nr_requisicao_w := nr_requisicao_w + 1;

				gerar_integracao_res(nr_seq_prontuario_p, nr_atendimento_p, cd_transacao_p, ie_empresa_res_w, ie_tipo_consulta_res_w, qt_dias_w, ie_tipo_area_w, cd_profissional_w, ie_regra_p, nr_requisicao_w, qt_requisicao_w);

			end if;


			if ( coalesce(IE_TIPO_INFO_HSH_p,'N') = 'S' ) then

				ie_tipo_area_w 	:= 'HABITOS';
				qt_dias_w 		:= qt_requisitada_HSH_p;
				nr_requisicao_w := nr_requisicao_w + 1;

				gerar_integracao_res(nr_seq_prontuario_p, nr_atendimento_p, cd_transacao_p, ie_empresa_res_w, ie_tipo_consulta_res_w, qt_dias_w, ie_tipo_area_w, cd_profissional_w, ie_regra_p, nr_requisicao_w, qt_requisicao_w);

			end if;


			if ( coalesce(IE_TIPO_INFO_IM_p,'N') = 'S' ) then

				ie_tipo_area_w 	:= 'IMUNIZACOES';
				qt_dias_w 		:= qt_requisitada_IM_p;
				nr_requisicao_w := nr_requisicao_w + 1;

				gerar_integracao_res(nr_seq_prontuario_p, nr_atendimento_p, cd_transacao_p, ie_empresa_res_w, ie_tipo_consulta_res_w, qt_dias_w, ie_tipo_area_w, cd_profissional_w, ie_regra_p, nr_requisicao_w, qt_requisicao_w);

			end if;


			if ( coalesce(IE_TIPO_INFO_ME_p,'N') = 'S' ) then

				ie_tipo_area_w 	:= 'MEDICAMENTOS';
				qt_dias_w 		:= qt_requisitada_ME_p;
				nr_requisicao_w := nr_requisicao_w + 1;

				gerar_integracao_res(nr_seq_prontuario_p, nr_atendimento_p, cd_transacao_p, ie_empresa_res_w, ie_tipo_consulta_res_w, qt_dias_w, ie_tipo_area_w, cd_profissional_w, ie_regra_p, nr_requisicao_w, qt_requisicao_w);

			end if;


			if ( coalesce(IE_TIPO_INFO_EDP_p,'N') = 'S' ) then

				ie_tipo_area_w 	:= 'EDUCACAO_AO_PACIENTE';
				qt_dias_w 		:= qt_requisitada_EDP_p;
				nr_requisicao_w := nr_requisicao_w + 1;

				gerar_integracao_res(nr_seq_prontuario_p, nr_atendimento_p, cd_transacao_p, ie_empresa_res_w, ie_tipo_consulta_res_w, qt_dias_w, ie_tipo_area_w, cd_profissional_w, ie_regra_p, nr_requisicao_w, qt_requisicao_w);

			end if;


			if ( coalesce(IE_TIPO_INFO_DI_p,'N') = 'S' ) then

				ie_tipo_area_w 	:= 'PROBLEMAS_E_DIAGNOSTICOS';
				qt_dias_w 		:= qt_requisitada_DI_p;
				nr_requisicao_w := nr_requisicao_w + 1;

				gerar_integracao_res(nr_seq_prontuario_p, nr_atendimento_p, cd_transacao_p, ie_empresa_res_w, ie_tipo_consulta_res_w, qt_dias_w, ie_tipo_area_w, cd_profissional_w, ie_regra_p, nr_requisicao_w, qt_requisicao_w);

			end if;

			if ( coalesce(IE_TIPO_INFO_PR_p,'N') = 'S' ) then

				ie_tipo_area_w 	:= 'PROCEDIMENTOS';
				qt_dias_w 		:= qt_requisitada_PR_p;
				nr_requisicao_w := nr_requisicao_w + 1;

				gerar_integracao_res(nr_seq_prontuario_p, nr_atendimento_p, cd_transacao_p, ie_empresa_res_w, ie_tipo_consulta_res_w, qt_dias_w, ie_tipo_area_w, cd_profissional_w, ie_regra_p, nr_requisicao_w, qt_requisicao_w);

			end if;


			if ( coalesce(IE_TIPO_INFO_TS_p,'N') = 'S' ) then

				ie_tipo_area_w 	:= 'TIPO_DE_SANGUE';
				qt_dias_w 		:= qt_requisitada_TS_p;
				nr_requisicao_w := nr_requisicao_w + 1;

				gerar_integracao_res(nr_seq_prontuario_p, nr_atendimento_p, cd_transacao_p, ie_empresa_res_w, ie_tipo_consulta_res_w, qt_dias_w, ie_tipo_area_w, cd_profissional_w, ie_regra_p, nr_requisicao_w, qt_requisicao_w);

			end if;

			if ( coalesce(IE_TIPO_INFO_SVA_p,'N') = 'S' ) then

				ie_tipo_area_w 	:= 'SINAIS_VITAIS';
				qt_dias_w 		:= qt_requisitada_SVA_p;
				nr_requisicao_w := nr_requisicao_w + 1;

				gerar_integracao_res(nr_seq_prontuario_p, nr_atendimento_p, cd_transacao_p, ie_empresa_res_w, ie_tipo_consulta_res_w, qt_dias_w, ie_tipo_area_w, cd_profissional_w, ie_regra_p, nr_requisicao_w, qt_requisicao_w);

			end if;


		else
		
		
			SELECT  count(*)
			into STRICT 	qt_requisicao_w
			FROM 	res_regra_consulta a,
					RES_REGRA_CONSULTA_LIB b
			WHERE 	b.nr_seq_regra = a.nr_sequencia
			AND (b.cd_estabelecimento = obter_estabelecimento_ativo OR coalesce(b.cd_estabelecimento::text, '') = '')
			AND (b.cd_perfil = obter_perfil_ativo OR coalesce(b.cd_perfil::text, '') = '')
			AND (obter_se_especialidade_medico(cd_profissional_w, b.cd_especialidade) = 'S' OR coalesce(b.cd_especialidade::text, '') = '');
			
			Select  coalesce(max('S'),'N')
			into STRICT	qt_registros_automaticos
			from	res_paciente_resultado
			where	cd_pessoa_fisica = cd_pessoa_fisica_w
			and		cd_profissional_dest = cd_profissional_w
			and		nm_usuario = nm_usuario_w
			and 	trunc(dt_atualizacao) = trunc(clock_timestamp());
			
	if (qt_registros_automaticos	= 'N') then
	
			delete 	from res_paciente_resultado
			where	cd_pessoa_fisica = cd_pessoa_fisica_w
			and		cd_profissional_dest = cd_profissional_w
			and		nm_usuario = nm_usuario_w
			and		(qt_requisicao IS NOT NULL AND qt_requisicao::text <> '');
			
			insert into res_paciente_resultado(	NR_SEQUENCIA,
													DT_ATUALIZACAO,
													NM_USUARIO,
													CD_PESSOA_FISICA, 
													IE_TIPO_CONSULTA, 
													IE_TIPO,
													IE_EMPRESA, 
													DT_INFORMACAO, 
													DS_INFORMACAO,
													CD_PROFISSIONAL_DEST,
													qt_requisicao,
													qt_requisicao_atual) 
										values ( 	nextval('res_paciente_resultado_seq'), 
													clock_timestamp(),
													nm_usuario_w,
													cd_pessoa_fisica_w,
													'C',
													'AT',
													'UNI',
													clock_timestamp(),
													'Requisicao',
													cd_profissional_w,
													qt_requisicao_w,
													0);
			commit;		


			open c01;
			loop
			fetch c01 into
				ie_empresa_res_w,
				qt_dias_w,
				ie_tipo_area_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
				begin
				
				nr_requisicao_w := nr_requisicao_w + 1;

				if (ie_empresa_res_w = 'UNI') then

					if (ie_tipo_area_w IS NOT NULL AND ie_tipo_area_w::text <> '') then

						ie_tipo_area_w := obter_tipo_area_res(ie_tipo_area_w);

						gerar_integracao_res(nr_seq_prontuario_p, nr_atendimento_p, cd_transacao_p, ie_empresa_res_w, ie_tipo_consulta_res_w, qt_dias_w, ie_tipo_area_w, cd_profissional_w, ie_regra_p, nr_requisicao_w, qt_requisicao_w);

						
					end if;
				end if;
				end;
			end loop;
			Close C01;

		end if;
		
	end if;

  end if;

 end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_consulta_res ( nr_atendimento_p bigint, nr_seq_prontuario_p text default null, cd_transacao_p bigint DEFAULT NULL, ie_regra_p text DEFAULT NULL, IE_TIPO_INFO_HSF_p text default 'N', QT_REQUISITADA_HSF_p bigint default 0, IE_TIPO_INFO_HSA_p text default 'N', QT_REQUISITADA_HSA_p bigint default 0, IE_TIPO_INFO_AT_p text default 'N', QT_REQUISITADA_AT_p bigint default 0, IE_TIPO_INFO_EI_p text default 'N', QT_REQUISITADA_EI_p bigint default 0, IE_TIPO_INFO_EL_p text default 'N', QT_REQUISITADA_EL_p bigint default 0, IE_TIPO_INFO_HSH_p text default 'N', QT_REQUISITADA_HSH_p bigint default 0, IE_TIPO_INFO_IM_p text default 'N', QT_REQUISITADA_IM_p bigint default 0, IE_TIPO_INFO_ME_p text default 'N', QT_REQUISITADA_ME_p bigint default 0, IE_TIPO_INFO_EDP_p text default 'N', QT_REQUISITADA_EDP_p bigint default 0, IE_TIPO_INFO_DI_p text default 'N', QT_REQUISITADA_DI_p bigint default 0, IE_TIPO_INFO_PR_p text default 'N', QT_REQUISITADA_PR_p bigint default 0, IE_TIPO_INFO_TS_p text default 'N', QT_REQUISITADA_TS_p bigint default 0, IE_TIPO_INFO_SVA_p text default 'N', QT_REQUISITADA_SVA_p bigint default 0) FROM PUBLIC;

