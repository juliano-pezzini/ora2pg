-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE prescr_proc_befpost_eup (cd_material_exame_p INOUT text, ds_material_especial_p text, ie_pasta_laboratorio_p text, cd_guia_p text, cd_senha_p text, cd_convenio_p bigint, ie_tipo_atendimento_p bigint, ie_carater_inter_sus_p text, ie_clinica_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_classificacao_p bigint, nr_seq_proc_interno_p bigint, cd_categoria_p text, cd_plano_p text, nr_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_proced_p bigint, dt_prev_execucao_p timestamp, cd_estabelecimento_p bigint, cd_perfil_p bigint, cd_setor_atendimento_p bigint, qt_procedimento_p bigint, ie_opcao_p text, nr_seq_exame_p bigint, cd_setor_entrega_prescr_p bigint, ie_tipo_convenio_p bigint, cd_funcao_p bigint, nr_seq_agenda_p bigint, nr_sequencia_p bigint, cd_tipo_acomodacao_p bigint, ie_possui_registros_p text, nr_seq_material_p text, dt_prescr_exame_p timestamp, cd_medico_executor_p INOUT text, ds_sexo_paciente_p text, cd_pessoa_fisica_p INOUT text, ie_edicao_novo_p text, ie_pendente_amostra_p text, cd_setor_solicitacao_p bigint, dt_coleta_p timestamp, ie_urgencia_p text, cd_setor_origem_p bigint, ie_origem_proced_user_p bigint, ie_exclusao_p text, cd_empresa_p bigint, cd_procedencia_p bigint, nr_seq_cobertura_p bigint, nr_seq_tipo_acidente_p bigint, nr_seq_queixa_p bigint, cd_setor_exclusivo_p INOUT bigint, ds_msg_erro_p INOUT text, ds_msg_aviso_p INOUT text, ds_valor_particular_p INOUT text, ds_msg_alerta_p INOUT text, ie_cancelar_edicao_p INOUT text, dt_prevista_retorno_p INOUT timestamp, cd_setor_atend_p INOUT text, cd_setor_coleta_p INOUT text, cd_setor_entrega_p INOUT text, qt_dia_entrega_p INOUT bigint, ie_emite_mapa_p INOUT text, ds_hora_fixa_p INOUT text, ie_data_resultado_p INOUT text, qt_min_entrega_p INOUT bigint, ie_atualizar_recoleta_p INOUT text, ie_gerar_setor_p INOUT text, ds_msg_info_p INOUT text, dt_prev_exec_p INOUT timestamp, dt_result_p INOUT timestamp, ds_valor_partic_p INOUT text, ie_consistir_regra_p INOUT text, ds_texto_1_p INOUT text, ds_texto_2_p INOUT text, ds_texto_3_p INOUT text, ds_texto_4_p INOUT text, ds_texto_5_p INOUT text, ie_acao_regra_p INOUT text, cd_medico_exclusivo_p INOUT text, ie_setor_liberado_p INOUT text, ds_nome_setor_p INOUT text, ie_medico_executor_p INOUT text, cd_cgc_p INOUT text, ie_existe_p INOUT text, ds_mensagem_p INOUT text, ie_bloqueia_atendimento_p INOUT text, ie_prescr_liberada_p INOUT text, dt_entrega_p INOUT timestamp, ie_pergunta_p INOUT text, nr_proc_interno_p INOUT text, ds_msg_limite_med_p INOUT text, nm_usuario_p text, ie_forma_atual_dt_result_p INOUT text, qt_min_atraso_p INOUT bigint) AS $body$
DECLARE


nr_soma_horas_fixa_w		bigint;
nr_hora_fixa_w				bigint;
ie_regra_w					varchar(15);


BEGIN

ie_regra_w := Obter_param_Usuario(916, 37, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_regra_w);

SELECT * FROM prescr_proc_befpost_abort_eup(cd_material_exame_p, ds_material_especial_p, ie_pasta_laboratorio_p, cd_guia_p, cd_senha_p, cd_convenio_p, ie_tipo_atendimento_p, ie_carater_inter_sus_p, ie_clinica_p, cd_procedimento_p, ie_origem_proced_p, nr_seq_classificacao_p, nr_seq_proc_interno_p, cd_categoria_p, cd_plano_p, nr_atendimento_p, nr_prescricao_p, nr_seq_proced_p, dt_prev_execucao_p, cd_estabelecimento_p, cd_perfil_p, cd_setor_atendimento_p, qt_procedimento_p, ie_opcao_p, nr_seq_exame_p, cd_setor_entrega_prescr_p, ie_tipo_convenio_p, cd_funcao_p, nr_seq_agenda_p, cd_tipo_acomodacao_p, ie_possui_registros_p, nr_seq_material_p, dt_prescr_exame_p, cd_medico_executor_p, ds_sexo_paciente_p, cd_pessoa_fisica_p, ie_edicao_novo_p, ie_pendente_amostra_p, cd_setor_solicitacao_p, dt_coleta_p, ie_urgencia_p, cd_setor_origem_p, ie_origem_proced_user_p, ie_exclusao_p, cd_empresa_p, cd_procedencia_p, nr_seq_cobertura_p, nr_seq_tipo_acidente_p, nr_seq_queixa_p, cd_setor_exclusivo_p, ds_msg_erro_p, ds_msg_aviso_p, ds_valor_particular_p, ds_msg_alerta_p, ie_cancelar_edicao_p, dt_prevista_retorno_p, cd_setor_atend_p, cd_setor_coleta_p, cd_setor_entrega_p, qt_dia_entrega_p, ie_emite_mapa_p, ds_hora_fixa_p, ie_data_resultado_p, qt_min_entrega_p, ie_atualizar_recoleta_p, ie_gerar_setor_p, ds_msg_info_p, ds_valor_partic_p, ie_consistir_regra_p, ds_texto_1_p, ds_texto_2_p, ds_texto_3_p, ds_texto_4_p, ds_texto_5_p, ie_acao_regra_p, cd_medico_exclusivo_p, ds_mensagem_p, ie_bloqueia_atendimento_p, ie_prescr_liberada_p, ie_pergunta_p, ds_msg_limite_med_p, nm_usuario_p, ie_forma_atual_dt_result_p, qt_min_atraso_p) INTO STRICT cd_material_exame_p, cd_setor_exclusivo_p, ds_msg_erro_p, ds_msg_aviso_p, ds_valor_particular_p, ds_msg_alerta_p, ie_cancelar_edicao_p, dt_prevista_retorno_p, cd_setor_atend_p, cd_setor_coleta_p, cd_setor_entrega_p, qt_dia_entrega_p, ie_emite_mapa_p, ds_hora_fixa_p, ie_data_resultado_p, qt_min_entrega_p, ie_atualizar_recoleta_p, ie_gerar_setor_p, ds_msg_info_p, ds_valor_partic_p, ie_consistir_regra_p, ds_texto_1_p, ds_texto_2_p, ds_texto_3_p, ds_texto_4_p, ds_texto_5_p, ie_acao_regra_p, cd_medico_exclusivo_p, ds_mensagem_p, ie_bloqueia_atendimento_p, ie_prescr_liberada_p, ie_pergunta_p, ds_msg_limite_med_p, ie_forma_atual_dt_result_p, qt_min_atraso_p; 	
	
if (ds_msg_erro_p IS NOT NULL AND ds_msg_erro_p::text <> '') then
	goto final;
end if;

select	CASE WHEN count(nr_sequencia)=1 THEN 'S'  ELSE 'N' END  ie_existe
into STRICT	ie_existe_p
from	proc_interno b
where	b.nr_sequencia = nr_seq_proc_interno_p
and		b.ie_tipo in ('ap','aph','apc')
order 	by 1;

if (ie_existe_p = 'S') then
	begin
	dt_entrega_p := obter_entrega_laudo(nr_prescricao_p, dt_prev_execucao_p, nr_seq_proc_interno_p, cd_procedimento_p, ie_origem_proced_p, cd_setor_atendimento_p, nm_usuario_p, dt_entrega_p);
	end;
end if;

if (((ds_hora_fixa_p IS NOT NULL AND ds_hora_fixa_p::text <> '') and (ds_hora_fixa_p / 24) > 0) or ((qt_dia_entrega_p IS NOT NULL AND qt_dia_entrega_p::text <> '') and
		qt_dia_entrega_p > 0)) then
	begin
	if (ie_data_resultado_p = 'P' and
		ie_data_resultado_p = 'N') then
		begin
			nr_soma_horas_fixa_w := ds_hora_fixa_p / 24;
			nr_hora_fixa_w := (ds_hora_fixa_p / 24) - nr_soma_horas_fixa_w;
			nr_soma_horas_fixa_w := qt_dia_entrega_p + nr_soma_horas_fixa_w;
			dt_prev_exec_p := PKG_DATE_UTILS.get_DateTime(dt_prev_execucao_p + nr_soma_horas_fixa_w, pkg_date_utils.get_Time(nr_hora_fixa_w,00,00));			
			--dt_prev_exec_p := to_char(dt_prev_execucao_p + nr_soma_horas_fixa_w,'dd/mm/yyyy')         ||' '|| nr_hora_fixa_w || ':00:00';
		end;
	end if;
	end;
end if;

select 	obter_Data_Result_Prescr_Lab(nr_prescricao_p, nr_seq_exame_p, nr_sequencia_p)
into STRICT	dt_result_p
;

select	coalesce(verifica_setor_lib_proc(ie_regra_w ,cd_setor_atendimento_p,nm_usuario_p),'N'),
		substr(obter_nome_setor(cd_setor_atendimento_p),1,40) ds_nome_setor
into STRICT	ie_setor_liberado_p,
		ds_nome_setor_p
;

if (nr_seq_proc_interno_p <> '')  then
	CALL consistir_valor_proced(cd_convenio_p, cd_categoria_p, cd_estabelecimento_p, cd_procedimento_p, ie_origem_proced_p, 'P', nm_usuario_p, '', nr_seq_proc_interno_p, ie_tipo_atendimento_p);
elsif (nr_seq_exame_p <> '') then
	CALL consistir_valor_proced(cd_convenio_p, cd_categoria_p, cd_estabelecimento_p, cd_procedimento_p, ie_origem_proced_p, 'P', nm_usuario_p, nr_seq_exame_p, '', ie_tipo_atendimento_p);
end if;

SELECT * FROM consiste_medico_executor(cd_estabelecimento_p, cd_convenio_p, cd_setor_atendimento_p, cd_procedimento_p, ie_origem_proced_p, ie_tipo_atendimento_p, nr_seq_exame_p, nr_seq_proc_interno_p, ie_medico_executor_p, cd_cgc_p, cd_medico_executor_p, cd_pessoa_fisica_p, null, clock_timestamp(), nr_seq_classificacao_p, null, cd_setor_entrega_prescr_p, null) INTO STRICT ie_medico_executor_p, cd_cgc_p, cd_medico_executor_p, cd_pessoa_fisica_p;
	
select 	max(nr_sequencia)
into STRICT	nr_proc_interno_p
from 	proc_interno
where 	nr_seq_exame_lab = nr_seq_exame_p;

<<final>>
	
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE prescr_proc_befpost_eup (cd_material_exame_p INOUT text, ds_material_especial_p text, ie_pasta_laboratorio_p text, cd_guia_p text, cd_senha_p text, cd_convenio_p bigint, ie_tipo_atendimento_p bigint, ie_carater_inter_sus_p text, ie_clinica_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_classificacao_p bigint, nr_seq_proc_interno_p bigint, cd_categoria_p text, cd_plano_p text, nr_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_proced_p bigint, dt_prev_execucao_p timestamp, cd_estabelecimento_p bigint, cd_perfil_p bigint, cd_setor_atendimento_p bigint, qt_procedimento_p bigint, ie_opcao_p text, nr_seq_exame_p bigint, cd_setor_entrega_prescr_p bigint, ie_tipo_convenio_p bigint, cd_funcao_p bigint, nr_seq_agenda_p bigint, nr_sequencia_p bigint, cd_tipo_acomodacao_p bigint, ie_possui_registros_p text, nr_seq_material_p text, dt_prescr_exame_p timestamp, cd_medico_executor_p INOUT text, ds_sexo_paciente_p text, cd_pessoa_fisica_p INOUT text, ie_edicao_novo_p text, ie_pendente_amostra_p text, cd_setor_solicitacao_p bigint, dt_coleta_p timestamp, ie_urgencia_p text, cd_setor_origem_p bigint, ie_origem_proced_user_p bigint, ie_exclusao_p text, cd_empresa_p bigint, cd_procedencia_p bigint, nr_seq_cobertura_p bigint, nr_seq_tipo_acidente_p bigint, nr_seq_queixa_p bigint, cd_setor_exclusivo_p INOUT bigint, ds_msg_erro_p INOUT text, ds_msg_aviso_p INOUT text, ds_valor_particular_p INOUT text, ds_msg_alerta_p INOUT text, ie_cancelar_edicao_p INOUT text, dt_prevista_retorno_p INOUT timestamp, cd_setor_atend_p INOUT text, cd_setor_coleta_p INOUT text, cd_setor_entrega_p INOUT text, qt_dia_entrega_p INOUT bigint, ie_emite_mapa_p INOUT text, ds_hora_fixa_p INOUT text, ie_data_resultado_p INOUT text, qt_min_entrega_p INOUT bigint, ie_atualizar_recoleta_p INOUT text, ie_gerar_setor_p INOUT text, ds_msg_info_p INOUT text, dt_prev_exec_p INOUT timestamp, dt_result_p INOUT timestamp, ds_valor_partic_p INOUT text, ie_consistir_regra_p INOUT text, ds_texto_1_p INOUT text, ds_texto_2_p INOUT text, ds_texto_3_p INOUT text, ds_texto_4_p INOUT text, ds_texto_5_p INOUT text, ie_acao_regra_p INOUT text, cd_medico_exclusivo_p INOUT text, ie_setor_liberado_p INOUT text, ds_nome_setor_p INOUT text, ie_medico_executor_p INOUT text, cd_cgc_p INOUT text, ie_existe_p INOUT text, ds_mensagem_p INOUT text, ie_bloqueia_atendimento_p INOUT text, ie_prescr_liberada_p INOUT text, dt_entrega_p INOUT timestamp, ie_pergunta_p INOUT text, nr_proc_interno_p INOUT text, ds_msg_limite_med_p INOUT text, nm_usuario_p text, ie_forma_atual_dt_result_p INOUT text, qt_min_atraso_p INOUT bigint) FROM PUBLIC;

