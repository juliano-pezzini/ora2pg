-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_diagnostico_hist_saude ( nr_atendimento_p bigint, cd_doenca_p text, cd_medico_p text, nm_usuario_p text, ie_historico_p text, ie_tipo_diagnostico_p bigint default 2, ie_classificacao_doenca_p text default 'S', nr_seq_problema_p bigint default null, ie_tipo_p text default null) AS $body$
DECLARE


ie_lista_problema_w		varchar(1);
nr_seq_atend_cons_pepa_w ATEND_CONSULTA_PEPA.NR_SEQUENCIA%TYPE := null;
nm_tabela_w			varchar(50);
ie_nivel_atencao_w  varchar(1);

ds_descricao_problema_w	 varchar(255);
ds_cid_w				 varchar(255);
ds_sae_w				 varchar(255);
ds_doenca_w				 varchar(255);

ds_alergia_w			 varchar(255);
ds_medic_nao_cad_w		 varchar(255);
ds_tipo_w				 varchar(255);

dt_inicio_w				 timestamp;


BEGIN

ie_nivel_atencao_w := wheb_assist_pck.get_nivel_atencao_perfil;

if (nr_seq_problema_p IS NOT NULL AND nr_seq_problema_p::text <> '') then

    if (ie_tipo_p = 'DP') then
		begin
			select  coalesce(max(ie_lista_problema),'N'),
					max(obter_desc_cid(CD_DOENCA)),
					max(obter_desc_pe_doenca(NR_SEQ_DOENCA)),
					max(ds_doenca),
					max(dt_inicio),
          max(nr_seq_atend_cons_pepa)
			into STRICT 	ie_lista_problema_w,
					ds_cid_w,
					ds_sae_w,
					ds_doenca_w,
					dt_inicio_w,
          nr_seq_atend_cons_pepa_w
			from 	paciente_antec_clinico
			where 	nr_sequencia = nr_seq_problema_p;
			
			If (ds_cid_w IS NOT NULL AND ds_cid_w::text <> '') then
			
				ds_descricao_problema_w := ds_cid_w;
			
			elsif (ds_sae_w IS NOT NULL AND ds_sae_w::text <> '') then
			
				ds_descricao_problema_w := ds_sae_w;
			
			else
			
				ds_descricao_problema_w := ds_doenca_w;
			
			end if;
			
			nm_tabela_w := 'PACIENTE_ANTEC_CLINICO';
			
		end;
    elsif (ie_tipo_p = 'AL') then
		begin
		
		
			select  coalesce(max(ie_lista_problema),'N'),
					max(SUBSTR(coalesce(coalesce(coalesce(coalesce(obter_desc_dcb(NR_SEQ_DCB),SUBSTR(obter_desc_material(cd_material),1,254)),SUBSTR(Obter_desc_classe_mat(CD_CLASSE_MAT),1,255)),obter_desc_ficha_tecnica(nr_seq_ficha_tecnica)),Obter_Desc_Familia_Mat(nr_seq_familia)),1,255)),
					max(DS_MEDIC_NAO_CAD),
					max(substr(obter_desc_alergeno(nr_seq_tipo),1,80)),
					max(dt_inicio),
          max(nr_seq_atend_cons_pepa)
			into STRICT 	ie_lista_problema_w,
					ds_alergia_w,
					ds_medic_nao_cad_w,
					ds_tipo_w,
					dt_inicio_w,
          nr_seq_atend_cons_pepa_w
			from 	paciente_alergia
			where 	nr_sequencia = nr_seq_problema_p;
			
			
			If (ds_alergia_w IS NOT NULL AND ds_alergia_w::text <> '') then
			
				ds_descricao_problema_w := ds_alergia_w;
			
			elsif (ds_medic_nao_cad_w IS NOT NULL AND ds_medic_nao_cad_w::text <> '') then
			
				ds_descricao_problema_w := ds_medic_nao_cad_w;
			
			else
			
				ds_descricao_problema_w := ds_tipo_w;
			
			end if;
			
			
			nm_tabela_w := 'PACIENTE_ALERGIA';
			
		end;
	end if;
	
	if (ie_lista_problema_w = 'S') then
		CALL gerar_lista_problema(	
      NR_ATENDIMENTO_P => nr_atendimento_p, 
			IE_TIPO_REGISTRO_P => 'HS', 
			IE_ESCALA_P => null,
			NR_SEQ_REG_P => nr_seq_problema_p,
			CD_DIGNOSTICO_P => null,
			NM_TABELA_P => nm_tabela_w,
			NM_USUARIO_P => nm_usuario_p,
			IE_TIPO_DIAG_P => null,
			IE_CIAP_INSERIR_LISTA_P => 'S',
			IE_IMPORTADO_HIST_P => 'S',
			DS_DESCRICAO_PROBLEMA_P => ds_descricao_problema_w,
			DT_INICIO_P => dt_inicio_w,
      NR_SEQ_ATEND_CONS_PEPA_P => nr_seq_atend_cons_pepa_w
    );
	end if;
	
	
end if;
	

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_diagnostico_hist_saude ( nr_atendimento_p bigint, cd_doenca_p text, cd_medico_p text, nm_usuario_p text, ie_historico_p text, ie_tipo_diagnostico_p bigint default 2, ie_classificacao_doenca_p text default 'S', nr_seq_problema_p bigint default null, ie_tipo_p text default null) FROM PUBLIC;

