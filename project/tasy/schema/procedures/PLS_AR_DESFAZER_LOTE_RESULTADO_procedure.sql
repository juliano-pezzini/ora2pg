-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_ar_desfazer_lote_resultado ( nr_seq_lote_p pls_ar_lote.nr_sequencia%type, nm_usuario_p text) AS $body$
DECLARE

qt_registro	integer;

BEGIN

-- É verificado se existe os grupos de contratos já ligados ao lote de resultado, se existir caracteriza o uso da rotina  de geraçãojá otimizada, portanto deve
-- utilizar a rotina de desfazer que foi implementada dentro da package pls_ar_gerar_resultado_pck. Se não tiver ligação é considerado
-- a autilização da rotina de geração ainda não otimizada, portanto deve seguir com o procedimento antigo
select	count(1)
into STRICT	qt_registro
from	pls_ar_grupo_contrato
where	nr_seq_lote = nr_seq_lote_p;

if (qt_registro > 0) then
	-- rotina otimizada
	CALL pls_ar_gerar_resultado_pck.pls_ar_desfazer_lote_resultado(nr_seq_lote_p, nm_usuario_p);
else
	-- rotina antiga
	delete	FROM pls_ar_grupo_contrato a
	where	a.ds_tabela 	= 'PLS_AR_MENSALIDADE'
	and	exists (SELECT	1
			from	pls_ar_mensalidade x
			where	x.nr_seq_lote 	= nr_seq_lote_p
			and	a.ds_tabela 	= 'PLS_AR_MENSALIDADE'
			and	x.nr_sequencia 	= a.nr_seq_reg_tabela);

	delete	FROM pls_ar_grupo_contrato a
	where	a.ds_tabela 	= 'PLS_AR_CONTA'
	and	exists (SELECT	1
			from	pls_ar_conta x
			where	x.nr_seq_lote 	= nr_seq_lote_p
			and	x.nr_sequencia 	= a.nr_seq_reg_tabela);

	delete	FROM pls_ar_grupo_contrato a
	where	a.ds_tabela 	= 'PLS_AR_REEMBOLSO'
	and	exists (SELECT	1
			from	pls_ar_reembolso x
			where	x.nr_seq_lote 	= nr_seq_lote_p
			and	x.nr_sequencia 	= a.nr_seq_reg_tabela);

	delete	FROM pls_ar_grupo_contrato a
	where	a.ds_tabela 	= 'PLS_AR_COPARTICIPACAO'
	and	exists (SELECT	1
			from	pls_ar_coparticipacao x
			where	x.nr_seq_lote 	= nr_seq_lote_p
			and	a.ds_tabela 	= 'PLS_AR_COPARTICIPACAO'
			and	x.nr_sequencia 	= a.nr_seq_reg_tabela);

	delete	FROM pls_ar_grupo_contrato a
	where	a.ds_tabela 	= 'PLS_AR_COMISSAO'
	and	exists (SELECT	1
			from	pls_ar_comissao x
			where	x.nr_seq_lote 	= nr_seq_lote_p
			and	a.ds_tabela 	= 'PLS_AR_COMISSAO'
			and	x.nr_sequencia 	= a.nr_seq_reg_tabela);

	delete	FROM pls_ar_grupo_contrato a
	where	a.ds_tabela 	= 'PLS_AR_RESS_SUS'
	and	exists (SELECT	1
			from	pls_ar_ress_sus x
			where	x.nr_seq_lote 	= nr_seq_lote_p
			and	a.ds_tabela 	= 'PLS_AR_RESS_SUS'
			and	x.nr_sequencia 	= a.nr_seq_reg_tabela);

	delete	FROM pls_ar_grupo_contrato a
	where	a.ds_tabela 	= 'PLS_AR_REC_GLOSA'
	and	exists (SELECT	1
			from	pls_ar_rec_glosa x
			where	x.nr_seq_lote 	= nr_seq_lote_p
			and	a.ds_tabela 	= 'PLS_AR_REC_GLOSA'
			and	x.nr_sequencia 	= a.nr_seq_reg_tabela);

	delete	FROM pls_ar_grupo_contrato a
	where	a.ds_tabela 	= 'PLS_AR_CONTESTACAO'
	and	exists (SELECT	1
			from	pls_ar_contestacao x
			where	x.nr_seq_lote 	= nr_seq_lote_p
			and	a.ds_tabela 	= 'PLS_AR_CONTESTACAO'
			and	x.nr_sequencia 	= a.nr_seq_reg_tabela);

	delete	FROM pls_ar_grupo_contrato a
	where	a.ds_tabela 	= 'PLS_AR_FATURAMENTO'
	and	exists (SELECT	1
			from	pls_ar_faturamento x
			where	x.nr_seq_lote 	= nr_seq_lote_p
			and	a.ds_tabela 	= 'PLS_AR_FATURAMENTO'
			and	x.nr_sequencia 	= a.nr_seq_reg_tabela);

	delete	FROM pls_ar_conta
	where	nr_seq_lote = nr_seq_lote_p;

	delete	FROM pls_ar_reembolso
	where	nr_seq_lote = nr_seq_lote_p;

	delete	FROM pls_ar_mensalidade
	where	nr_seq_lote = nr_seq_lote_p;

	delete	FROM pls_ar_coparticipacao
	where	nr_seq_lote = nr_seq_lote_p;

	delete	FROM pls_ar_comissao
	where	nr_seq_lote = nr_seq_lote_p;

	delete	FROM pls_ar_ress_sus
	where	nr_seq_lote = nr_seq_lote_p;

	delete	FROM pls_ar_rec_glosa
	where	nr_seq_lote = nr_seq_lote_p;

	delete	FROM pls_ar_contestacao
	where	nr_seq_lote = nr_seq_lote_p;

	delete	FROM pls_ar_faturamento
	where	nr_seq_lote = nr_seq_lote_p;

	update	pls_ar_lote
	set	dt_geracao 	 = NULL,
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia 	= nr_seq_lote_p;

	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ar_desfazer_lote_resultado ( nr_seq_lote_p pls_ar_lote.nr_sequencia%type, nm_usuario_p text) FROM PUBLIC;

