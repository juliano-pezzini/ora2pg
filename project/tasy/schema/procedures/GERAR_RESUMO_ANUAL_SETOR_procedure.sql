-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_resumo_anual_setor ( dt_parametro_p timestamp, nm_usuario_p text) AS $body$
DECLARE


cd_estabelecimento_w		integer;
nr_seq_indicador_w		bigint;
cd_setor_atendimento_w		bigint;
vl_indicador_w		double precision;
dt_referencia_w		timestamp;
nr_sequencia_w		bigint;
ie_prev_real_w		varchar(01);
qt_mes_w			bigint;
dt_ref_prev_w			timestamp;

C01 CURSOR FOR
/* os tries selects abaixo são para gerar os indicadores reais (Média, Acumulado e ultimo */

SELECT	cd_setor_atendimento,
	cd_estabelecimento,
	nr_seq_indicador,
	sum(vl_indicador),
	'R'
from	w_indicador_gestao
where	dt_referencia	between dt_referencia_w and PKG_DATE_UTILS.ADD_MONTH(dt_referencia_w,11,0)
and	ie_periodo	= 'M'
and	nr_seq_indicador in (
	SELECT	nr_seq_wheb
	from	indicador_gestao
	where	ie_formato_evolucao = 'S')
group by
	cd_estabelecimento,
	cd_setor_atendimento,
	nr_seq_indicador

union all

select	cd_estabelecimento,
	cd_setor_atendimento,
	nr_seq_indicador,
	avg(vl_indicador),
	'R'
from	w_indicador_gestao
where	dt_referencia	between dt_referencia_w and PKG_DATE_UTILS.ADD_MONTH(dt_referencia_w,11,0)
and	ie_periodo		= 'M'
and	nr_seq_indicador in (
	select	nr_seq_wheb
	from	indicador_gestao
	where	ie_formato_evolucao = 'M')
group by
	cd_estabelecimento,
	cd_setor_atendimento,
	nr_seq_indicador

union all

select	cd_estabelecimento,
	cd_setor_atendimento,
	nr_seq_indicador,
	sum(vl_indicador),
	'R'
from	w_indicador_gestao a
where	dt_referencia	= (
	select max(dt_referencia)
	from	w_indicador_gestao b
	where	a.nr_seq_indicador	= b.nr_seq_indicador
	and	a.cd_estabelecimento	= b.cd_estabelecimento
	and	a.ie_periodo		= b.ie_periodo
	and	a.ie_prev_real	= b.ie_prev_real
	and	b.dt_referencia between dt_referencia_w and PKG_DATE_UTILS.ADD_MONTH(dt_referencia_w,11,0))
and	ie_periodo	= 'M'
and	nr_seq_indicador in (
	select	nr_seq_wheb
	from	indicador_gestao
	where	ie_formato_evolucao = 'U')
group by
	cd_estabelecimento,
	cd_setor_atendimento,
	nr_seq_indicador

union all

/* o select abaixo é para gerar os indicadores previstos para o ano em curso */

select	cd_estabelecimento,
	cd_setor_atendimento,
	nr_seq_indicador,
	sum(vl_indicador),
	'P'
from	w_indicador_gestao
where	dt_referencia	between dt_referencia_w and dt_ref_prev_w
and	ie_periodo		= 'M'
and	qt_mes_w		< 12
and	nr_seq_indicador in (
	select	nr_seq_wheb
	from	indicador_gestao
	where	ie_formato_evolucao = 'S')
group by
	cd_estabelecimento,
	cd_setor_atendimento,
	nr_seq_indicador;


BEGIN

dt_referencia_w		:= PKG_DATE_UTILS.start_of(dt_parametro_p,'year',0);
if (dt_parametro_p < PKG_DATE_UTILS.start_of(clock_timestamp(),'year',0)) then
	qt_mes_w			:= 99;
elsif (dt_parametro_p > PKG_DATE_UTILS.start_of(PKG_DATE_UTILS.END_OF(clock_timestamp(), 'MONTH', 0), 'dd', 0)) then
	dt_ref_prev_w			:= PKG_DATE_UTILS.start_of(dt_parametro_p,'month',0);
	qt_mes_w			:= PKG_DATE_UTILS.extract_field('MONTH', dt_ref_prev_w);
else
	dt_ref_prev_w			:= PKG_DATE_UTILS.ADD_MONTH(PKG_DATE_UTILS.start_of(dt_parametro_p,'month',0), -1,0);
	qt_mes_w			:= PKG_DATE_UTILS.extract_field('MONTH', dt_ref_prev_w);
end if;

delete from	w_indicador_gestao
where	dt_referencia		= dt_referencia_w
and	ie_periodo		= 'A';
commit;

OPEN C01;
LOOP
FETCH C01 into
		cd_estabelecimento_w,
		cd_setor_atendimento_w,
		nr_seq_indicador_w,
		vl_indicador_w,
		ie_prev_real_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	select	nextval('w_indicador_gestao_seq')
	into STRICT	nr_sequencia_w
	;
	if (ie_prev_real_w = 'P') then
		vl_indicador_w	:=  vl_indicador_w / qt_mes_w * 12;
	end if;
	insert into w_indicador_gestao(
		nr_sequencia,
		cd_estabelecimento,
		cd_setor_atendimento,
		dt_atualizacao,
		nm_usuario,
		dt_referencia,
		nr_seq_indicador,
		ie_prev_real,
		ie_periodo,
		vl_indicador)
	values (
		nr_sequencia_w,
		cd_estabelecimento_w,
		cd_setor_atendimento_w,
		clock_timestamp(),
		nm_usuario_p,
		dt_referencia_w,
		nr_seq_indicador_w,
		ie_prev_real_w,
		'A',
		vl_indicador_w);
END LOOP;
CLOSE C01;

if (qt_mes_w < 12) then
	insert into w_indicador_gestao(
		nr_sequencia,
		cd_estabelecimento,
		cd_setor_atendimento,
		dt_atualizacao,
		nm_usuario,
		dt_referencia,
		nr_seq_indicador,
		ie_prev_real,
		ie_periodo,
		vl_indicador)
	SELECT	nextval('eis_indicador_gestao_seq'),
		cd_estabelecimento,
		cd_setor_atendimento,
		clock_timestamp(),
		nm_usuario_p,
		dt_referencia_w,
		nr_seq_indicador,
		'P',
		'A',
		vl_indicador
	from	w_indicador_gestao
	where	ie_periodo	= 'A'
	and	ie_prev_real	= 'R'
	and	dt_referencia	= dt_referencia_w
	and	nr_seq_indicador in (
		SELECT	nr_seq_wheb
		from	indicador_gestao
		where	ie_formato_evolucao <> 'S');
end if;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_resumo_anual_setor ( dt_parametro_p timestamp, nm_usuario_p text) FROM PUBLIC;

