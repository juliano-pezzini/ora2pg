-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_estrut_proc (cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_area_p INOUT bigint, cd_especialidade_p INOUT bigint, cd_grupo_p INOUT bigint, ie_origem_p INOUT bigint) AS $body$
DECLARE


ie_origem_proced_w		bigint;
cd_grupo_proc_w			bigint;
cd_especialidade_w		bigint;
cd_area_procedimento_w		bigint;
qt_registros_w			bigint;


BEGIN

-- jjung OS 575917 - Se a origem vier nula busca a maior origem cadastrada por que no caso do PTU é tratado apenas pelo código do procedimento.
-- jjung alterado o max(ie_origem_proced) para buscar da tabela procedimento e não da view estrutura_procedimento_v.
if (ie_origem_proced_p IS NOT NULL AND ie_origem_proced_p::text <> '') then
	ie_origem_proced_w		:= ie_origem_proced_p;
else
	select	max(ie_origem_proced)
	into STRICT	ie_origem_proced_w
	from	procedimento
	where	cd_procedimento	= cd_procedimento_p;
end if;


/*	obter estrutura do procedimento */

begin
select 	cd_grupo_proc,
	cd_especialidade,
	cd_area_procedimento
into STRICT	cd_grupo_proc_w,
	cd_especialidade_w,
	cd_area_procedimento_w
from	estrutura_procedimento_v
where	cd_procedimento 	= cd_procedimento_p
and	ie_origem_proced	= ie_origem_proced_w;
exception
when others then
	cd_grupo_proc_w	:= null;
	cd_especialidade_w	:= null;
	cd_area_procedimento_w	:= null;
end;

/*	1. Trocar ie_origem_proced qandodo CBHPM com ajuste AMB ou invertido	*/

if (coalesce(cd_grupo_proc_w,0)		= 0) and (coalesce(cd_especialidade_w,0)	= 0) and (coalesce(cd_area_procedimento_w,0)	= 0) then

	select	count(1)
	into STRICT	qt_registros_w
	from	procedimento
	where	cd_procedimento		= cd_procedimento_p
	and	ie_origem_proced	= ie_origem_proced_w
	and	ie_situacao		= 'A';

	if (qt_registros_w = 0) then
		if (ie_origem_proced_w = 1) then
			ie_origem_proced_w	:= 5;
		elsif (ie_origem_proced_w = 5) then
			ie_origem_proced_w	:= 1;
		end if;

		/*	obter estrutura do procedimento */

		begin
			select 	cd_grupo_proc,
				cd_especialidade,
				cd_area_procedimento
			into STRICT	cd_grupo_proc_w,
				cd_especialidade_w,
				cd_area_procedimento_w
			from	estrutura_procedimento_v
			where	cd_procedimento 	= cd_procedimento_p
			and	ie_origem_proced	= ie_origem_proced_w;
		exception
		when others then
			cd_grupo_proc_w	:= null;
			cd_especialidade_w	:= null;
			cd_area_procedimento_w	:= null;
		end;
	end if;
end if;

cd_area_p		:= coalesce(cd_area_procedimento_w,0);
cd_especialidade_p	:= coalesce(cd_especialidade_w,0);
cd_grupo_p		:= coalesce(cd_grupo_proc_w,0);
ie_origem_p		:= ie_origem_proced_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_estrut_proc (cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_area_p INOUT bigint, cd_especialidade_p INOUT bigint, cd_grupo_p INOUT bigint, ie_origem_p INOUT bigint) FROM PUBLIC;

