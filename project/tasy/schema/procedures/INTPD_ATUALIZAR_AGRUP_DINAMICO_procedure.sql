-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE intpd_atualizar_agrup_dinamico ( nr_seq_agrupador_p bigint default null) AS $body$
DECLARE


qt_packs_w			bigint;
qt_hrs_envio_w			bigint;

ie_status_w		intpd_fila_transmissao.ie_status%type;
dt_envio_pacote_w		intpd_eventos_env_pacote.dt_envio%type;
dt_final_pacote_w		intpd_eventos_env_pacote.dt_envio%type;
hr_envio_pacote_w		intpd_eventos_env_pacote.hr_envio%type;
nr_seq_evento_sistema_w	intpd_fila_transmissao.nr_seq_evento_sistema%type;
nr_seq_agrupador_w	intpd_fila_transmissao.nr_seq_agrupador%type;
nr_seq_agrupador_ww	intpd_fila_transmissao.nr_sequencia%type;

c02 CURSOR FOR
SELECT	a.nr_seq_agrupador,
	a.ie_evento
from	intpd_fila_transmissao a
where	a.ie_envio_recebe in ('E', 'C')
and	(a.nr_seq_agrupador IS NOT NULL AND a.nr_seq_agrupador::text <> '')
and	a.nr_seq_agrupador = coalesce(nr_seq_agrupador_ww, a.nr_seq_agrupador)
and	exists (
	SELECT	1
	from	intpd_fila_transmissao x
	where	x.nr_seq_agrupador = a.nr_seq_agrupador
	and	x.ie_evento = a.ie_evento
	and	coalesce(x.ie_status,'X') not in ('E','S','AEX'))
group by	a.nr_seq_agrupador,
	a.ie_evento;

c02_w	c02%rowtype;

c03 CURSOR FOR
SELECT	a.nr_sequencia,
	coalesce(b.nr_seq_ordem_exec,0) nr_seq_ordem_exec
from	intpd_fila_transmissao a,
	intpd_eventos_sistema b
where	a.nr_seq_evento_sistema = b.nr_sequencia
and	a.nr_seq_agrupador = c02_w.nr_seq_agrupador
and	a.ie_evento = c02_w.ie_evento
order by	a.nr_sequencia;

c03_w	c03%rowtype;

c04 CURSOR FOR
SELECT	a.nr_seq_agrupador
from	intpd_fila_transmissao a
where	a.ie_envio_recebe in ('E', 'C')
and	(a.nr_seq_agrupador IS NOT NULL AND a.nr_seq_agrupador::text <> '')
and	a.nr_seq_agrupador = coalesce(nr_seq_agrupador_ww, a.nr_seq_agrupador)
and	exists (
	SELECT	1
	from	intpd_fila_transmissao x
	where	x.nr_seq_agrupador = a.nr_seq_agrupador
	and	coalesce(x.ie_status,'X') not in ('E','S','AEX')
	)
group by	a.nr_seq_agrupador;

c04_w	c04%rowtype;

c05 CURSOR FOR
SELECT	a.nr_sequencia,
	a.ie_evento
from	intpd_fila_transmissao a,
	intpd_eventos_sistema b
where	a.nr_seq_evento_sistema = b.nr_sequencia
and	a.nr_seq_agrupador = c04_w.nr_seq_agrupador
order by	a.nr_sequencia;

c05_w	c05%rowtype;



BEGIN
if (nr_seq_agrupador_p > 0) then
	nr_seq_agrupador_ww	:=	nr_seq_agrupador_p;
end if;


open c04;
loop
fetch c04 into
	c04_w;
EXIT WHEN NOT FOUND; /* apply on c04 */
	begin
	open c05;
	loop
	fetch c05 into
		c05_w;
	EXIT WHEN NOT FOUND; /* apply on c05 */
		begin
		select	ie_status, nr_seq_evento_sistema
		into STRICT	ie_status_w, nr_seq_evento_sistema_w
		from	intpd_fila_transmissao
		where	nr_sequencia = c05_w.nr_sequencia;

		select	count(*)
		into STRICT	qt_packs_w
		from	intpd_eventos_env_pacote a
		where	a.nr_seq_evento_sistema = nr_seq_evento_sistema_w;

		if (qt_packs_w > 0) then

			select  count(a.hr_envio)
			into STRICT	qt_hrs_envio_w
			from	intpd_eventos_env_pacote a
			where	a.nr_seq_evento_sistema = nr_seq_evento_sistema_w
			and	to_char(clock_timestamp(), 'hh24:mi') = a.hr_envio
			and (coalesce(a.dt_envio::text, '') = '' or trunc(clock_timestamp()) = trunc(a.dt_envio));

			if (qt_hrs_envio_w > 0) then
				select	a.hr_envio, a.dt_envio
				into STRICT	hr_envio_pacote_w, dt_envio_pacote_w
				from	intpd_eventos_env_pacote a
				where	a.nr_seq_evento_sistema = nr_seq_evento_sistema_w
				and	to_char(clock_timestamp(), 'hh24:mi') = a.hr_envio
				and (coalesce(a.dt_envio::text, '') = '' or trunc(clock_timestamp()) = trunc(a.dt_envio));

				if (coalesce(dt_envio_pacote_w::text, '') = '' and (hr_envio_pacote_w IS NOT NULL AND hr_envio_pacote_w::text <> '')) then
					dt_final_pacote_w := pkg_date_utils.get_time(clock_timestamp(), substr(hr_envio_pacote_w,0,2),substr(hr_envio_pacote_w,4,6),00);
				elsif (hr_envio_pacote_w IS NOT NULL AND hr_envio_pacote_w::text <> '') then
					dt_final_pacote_w := pkg_date_utils.get_time(dt_envio_pacote_w, substr(hr_envio_pacote_w,0,2),substr(hr_envio_pacote_w,4,6),00);
				end if;
			end if;
		end if;

		if	((qt_packs_w = 0) or (dt_final_pacote_w IS NOT NULL AND dt_final_pacote_w::text <> '')) then
			if (ie_status_w = 'P') then
				update	intpd_fila_transmissao a
				set	ie_status = 'AP',
					nr_seq_dependencia = c05_w.nr_sequencia
				where	nr_seq_agrupador = c04_w.nr_seq_agrupador
				and	ie_status not in ('E','S','AP')
				and	ie_evento <> c05_w.ie_evento
				and	nr_sequencia > c05_w.nr_sequencia
				and	((qt_packs_w = 0) or (dt_atualizacao_nrec <= dt_final_pacote_w))
				and not exists (	SELECT	1
						from	intpd_eventos b,
							intpd_evento_superior c
						where	b.nr_sequencia = c.nr_seq_evento
						and	b.ie_evento = a.ie_evento);
			elsif (ie_status_w = 'S') then
				update	intpd_fila_transmissao a
				set	ie_status = 'P',
					nr_seq_dependencia = c05_w.nr_sequencia
				where	nr_seq_agrupador = c04_w.nr_seq_agrupador
				and	ie_status not in ('E','S','P')
				and	ie_evento <> c05_w.ie_evento
				and	nr_sequencia > c05_w.nr_sequencia
				and	((qt_packs_w = 0) or (dt_atualizacao_nrec <= dt_final_pacote_w));
			elsif (ie_status_w = 'E') then
				update	intpd_fila_transmissao a
				set	ie_status = 'AP',
					nr_seq_dependencia = c05_w.nr_sequencia
				where	nr_seq_agrupador = c04_w.nr_seq_agrupador
				and	ie_status not in ('E','S','AP')
				and	ie_evento <> c05_w.ie_evento
				and	nr_sequencia > c05_w.nr_sequencia
				and	((qt_packs_w = 0) or (dt_atualizacao_nrec <= dt_final_pacote_w))
				and not exists (	SELECT	1
						from	intpd_eventos b,
							intpd_evento_superior c
						where	b.nr_sequencia = c.nr_seq_evento
						and	b.ie_evento = a.ie_evento);
			elsif (ie_status_w = 'R') then
				update	intpd_fila_transmissao a
				set	ie_status = 'AP',
					nr_seq_dependencia = c05_w.nr_sequencia
				where	nr_seq_agrupador = c04_w.nr_seq_agrupador
				and	ie_status not in ('E','S','AP')
				and	ie_evento <> c05_w.ie_evento
				and	nr_sequencia > c05_w.nr_sequencia
				and	((qt_packs_w = 0) or (dt_atualizacao_nrec <= dt_final_pacote_w))
				and not exists (	SELECT	1
						from	intpd_eventos b,
							intpd_evento_superior c
						where	b.nr_sequencia = c.nr_seq_evento
						and	b.ie_evento = a.ie_evento);
			elsif (ie_status_w = 'A') then
				update	intpd_fila_transmissao a
				set	ie_status = 'AP',
					nr_seq_dependencia = c05_w.nr_sequencia
				where	nr_seq_agrupador = c04_w.nr_seq_agrupador
				and	ie_status not in ('E','S','AP')
				and	ie_evento <> c05_w.ie_evento
				and	nr_sequencia > c05_w.nr_sequencia
				and	((qt_packs_w = 0) or (dt_atualizacao_nrec <= dt_final_pacote_w))
				and not exists (	SELECT	1
						from	intpd_eventos b,
							intpd_evento_superior c
						where	b.nr_sequencia = c.nr_seq_evento
						and	b.ie_evento = a.ie_evento);
			elsif (ie_status_w = 'AP') then
				update	intpd_fila_transmissao a
				set	ie_status = 'AP',
					nr_seq_dependencia = c05_w.nr_sequencia
				where	nr_seq_agrupador = c04_w.nr_seq_agrupador
				and	ie_status not in ('E','S','AP')
				and	ie_evento <> c05_w.ie_evento
				and	nr_sequencia > c05_w.nr_sequencia
				and	((qt_packs_w = 0) or (dt_atualizacao_nrec <= dt_final_pacote_w))
				and not exists (	SELECT	1
						from	intpd_eventos b,
							intpd_evento_superior c
						where	b.nr_sequencia = c.nr_seq_evento
						and	b.ie_evento = a.ie_evento);
			end if;
		end if;
		end;
	end loop;
	close c05;
	end;
end loop;
close c04;

open c02;
loop
fetch c02 into
	c02_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin
	open c03;
	loop
	fetch c03 into
		c03_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		begin
		select	ie_status, nr_seq_evento_sistema
		into STRICT	ie_status_w, nr_seq_evento_sistema_w
		from	intpd_fila_transmissao
		where	nr_sequencia = c03_w.nr_sequencia;

		select	count(*)
		into STRICT	qt_packs_w
		from	intpd_eventos_env_pacote a
		where	a.nr_seq_evento_sistema = nr_seq_evento_sistema_w;

		if (qt_packs_w > 0) then
			select  count(a.hr_envio)
			into STRICT	qt_hrs_envio_w
			from	intpd_eventos_env_pacote a
			where	a.nr_seq_evento_sistema = nr_seq_evento_sistema_w
			and	to_char(clock_timestamp(), 'hh24:mi') = a.hr_envio
			and (coalesce(a.dt_envio::text, '') = '' or trunc(clock_timestamp()) = trunc(a.dt_envio));

			if (qt_hrs_envio_w > 0) then
				select	a.hr_envio, a.dt_envio
				into STRICT	hr_envio_pacote_w, dt_envio_pacote_w
				from	intpd_eventos_env_pacote a
				where	a.nr_seq_evento_sistema = nr_seq_evento_sistema_w
				and	to_char(clock_timestamp(), 'hh24:mi') = a.hr_envio
				and (coalesce(a.dt_envio::text, '') = '' or trunc(clock_timestamp()) = trunc(a.dt_envio));

				if (coalesce(dt_envio_pacote_w::text, '') = '' and (hr_envio_pacote_w IS NOT NULL AND hr_envio_pacote_w::text <> '')) then
					dt_final_pacote_w := pkg_date_utils.get_time(clock_timestamp(), substr(hr_envio_pacote_w,0,2),substr(hr_envio_pacote_w,4,6),00);
				elsif (hr_envio_pacote_w IS NOT NULL AND hr_envio_pacote_w::text <> '') then
					dt_final_pacote_w := pkg_date_utils.get_time(dt_envio_pacote_w, substr(hr_envio_pacote_w,0,2),substr(hr_envio_pacote_w,4,6),00);
				end if;
			end if;
		end if;

		if ((qt_packs_w = 0) or (dt_final_pacote_w IS NOT NULL AND dt_final_pacote_w::text <> '')) then
			if (ie_status_w = 'P') then
				update	intpd_fila_transmissao a
				set	ie_status = 'AP',
					nr_seq_dependencia = c03_w.nr_sequencia
				where	nr_seq_agrupador = c02_w.nr_seq_agrupador
				and	ie_status not in ('E','S','AP')
				and	ie_evento = c02_w.ie_evento
				and	exists (	SELECT	1
						from	intpd_eventos_sistema x
						where	x.nr_sequencia = a.nr_seq_evento_sistema
						and	x.nr_seq_ordem_exec > c03_w.nr_seq_ordem_exec)
				and ((qt_packs_w = 0) or (dt_atualizacao_nrec <= dt_final_pacote_w))
				and not exists (	select	1
						from	intpd_eventos b,
							intpd_evento_superior c
						where	b.nr_sequencia = c.nr_seq_evento
						and	b.ie_evento = a.ie_evento);
			elsif (ie_status_w = 'S') then
				update	intpd_fila_transmissao a
				set	ie_status = 'P',
					nr_seq_dependencia = c03_w.nr_sequencia
				where	nr_seq_agrupador = c02_w.nr_seq_agrupador
				and	ie_status not in ('E','S','P')
				and	ie_evento = c02_w.ie_evento
				and	exists (	SELECT	1
						from	intpd_eventos_sistema x
						where	x.nr_sequencia = a.nr_seq_evento_sistema
						and	x.nr_seq_ordem_exec > c03_w.nr_seq_ordem_exec)
				and ((qt_packs_w = 0) or (dt_atualizacao_nrec <= dt_final_pacote_w));
			elsif (ie_status_w = 'E') then
				update	intpd_fila_transmissao a
				set	ie_status = 'AP',
					nr_seq_dependencia = c03_w.nr_sequencia
				where	nr_seq_agrupador = c02_w.nr_seq_agrupador
				and	ie_status not in ('E','S','AP')
				and	ie_evento = c02_w.ie_evento
				and	exists (	SELECT	1
						from	intpd_eventos_sistema x
						where	x.nr_sequencia = a.nr_seq_evento_sistema
						and	x.nr_seq_ordem_exec > c03_w.nr_seq_ordem_exec)
				and ((qt_packs_w = 0) or (dt_atualizacao_nrec <= dt_final_pacote_w))
				and not exists (	select	1
						from	intpd_eventos b,
							intpd_evento_superior c
						where	b.nr_sequencia = c.nr_seq_evento
						and	b.ie_evento = a.ie_evento);
			elsif (ie_status_w = 'R') then
				update	intpd_fila_transmissao a
				set	ie_status = 'AP',
					nr_seq_dependencia = c03_w.nr_sequencia
				where	nr_seq_agrupador = c02_w.nr_seq_agrupador
				and	ie_status not in ('E','S','AP')
				and	ie_evento = c02_w.ie_evento
				and	exists (	SELECT	1
						from	intpd_eventos_sistema x
						where	x.nr_sequencia = a.nr_seq_evento_sistema
						and	x.nr_seq_ordem_exec > c03_w.nr_seq_ordem_exec)
				and ((qt_packs_w = 0) or (dt_atualizacao_nrec <= dt_final_pacote_w))
				and not exists (	select	1
						from	intpd_eventos b,
							intpd_evento_superior c
						where	b.nr_sequencia = c.nr_seq_evento
						and	b.ie_evento = a.ie_evento);
			elsif (ie_status_w = 'A') then
				update	intpd_fila_transmissao a
				set	ie_status = 'AP',
					nr_seq_dependencia = c03_w.nr_sequencia
				where	nr_seq_agrupador = c02_w.nr_seq_agrupador
				and	ie_status not in ('E','S','AP')
				and	ie_evento = c02_w.ie_evento
				and	exists (	SELECT	1
						from	intpd_eventos_sistema x
						where	x.nr_sequencia = a.nr_seq_evento_sistema
						and	x.nr_seq_ordem_exec > c03_w.nr_seq_ordem_exec)
				and ((qt_packs_w = 0) or (dt_atualizacao_nrec <= dt_final_pacote_w))
				and not exists (	select	1
						from	intpd_eventos b,
							intpd_evento_superior c
						where	b.nr_sequencia = c.nr_seq_evento
						and	b.ie_evento = a.ie_evento);
			elsif (ie_status_w = 'AP') then
				update	intpd_fila_transmissao a
				set	ie_status = 'AP',
					nr_seq_dependencia = c03_w.nr_sequencia
				where	nr_seq_agrupador = c02_w.nr_seq_agrupador
				and	ie_status not in ('E','S','AP')
				and	ie_evento = c02_w.ie_evento
				and	exists (	SELECT	1
						from	intpd_eventos_sistema x
						where	x.nr_sequencia = a.nr_seq_evento_sistema
						and	x.nr_seq_ordem_exec > c03_w.nr_seq_ordem_exec)
				and	((qt_packs_w = 0) or (dt_atualizacao_nrec <= dt_final_pacote_w))
				and not exists (	select	1
						from	intpd_eventos b,
							intpd_evento_superior c
						where	b.nr_sequencia = c.nr_seq_evento
						and	b.ie_evento = a.ie_evento);
			end if;
		end if;
		end;
	end loop;
	close c03;
	end;
end loop;
close c02;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE intpd_atualizar_agrup_dinamico ( nr_seq_agrupador_p bigint default null) FROM PUBLIC;

