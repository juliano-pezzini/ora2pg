-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_consistir_classif_lote ( nr_lote_contabil_p ctb_movimento.nr_lote_contabil%type, nm_usuario_p ctb_movimento.nm_usuario%type, ds_erro_p INOUT text) AS $body$
DECLARE


cd_classificacao_w  ctb_movimento.cd_classif_debito%type;
ds_consistencia_w   ctb_movimento.ds_consistencia%type;
ie_validacao_w      ctb_movimento.ie_validacao%type;

C01 CURSOR FOR
SELECT  nr_sequencia,
        dt_movimento,
        cd_conta_debito,
        cd_conta_credito,
        cd_classif_debito,
        cd_classif_credito
from    ctb_movimento
where   nr_lote_contabil = nr_lote_contabil_p;

vet01   C01%RowType;


BEGIN

/* Consistir a ClassificaCAo das Contas Contabeis */

open C01;
loop
fetch C01 into
    vet01;
EXIT WHEN NOT FOUND; /* apply on C01 */
    begin
    ds_consistencia_w := null;

    /*Debito*/

    if (coalesce(vet01.cd_conta_debito,'X') <> 'X') then

        if (coalesce(vet01.cd_classif_debito,'X') = 'X') then
            ds_consistencia_w   := WHEB_MENSAGEM_PCK.get_texto(279062);
            ie_validacao_w      := '29';
            ds_erro_p           := ds_consistencia_w;
        else
            cd_classificacao_w  := ctb_obter_classif_conta(vet01.cd_conta_debito, vet01.cd_classif_debito, vet01.dt_movimento);

            if (coalesce(cd_classificacao_w,'X') <> vet01.cd_classif_debito) then
                ds_consistencia_w   := WHEB_MENSAGEM_PCK.get_texto(279063);
                ie_validacao_w      := '28';
                ds_erro_p           := ds_consistencia_w;
            end if;

        end if;

    end if;

    /*Credito*/

    if (coalesce(vet01.cd_conta_credito,'X') <> 'X') then

        if (coalesce(vet01.cd_classif_credito,'X') = 'X') then
            ds_consistencia_w   :=  WHEB_MENSAGEM_PCK.get_texto(279062);
            ie_validacao_w      := '29';
            ds_erro_p           := ds_consistencia_w;
        else

            cd_classificacao_w  := ctb_obter_classif_conta(vet01.cd_conta_credito, null, vet01.dt_movimento);
            if (coalesce(cd_classificacao_w,'X') <> vet01.cd_classif_credito) then
                ds_consistencia_w   := WHEB_MENSAGEM_PCK.get_texto(279063);
                ie_validacao_w      := '28';
                ds_erro_p           := ds_consistencia_w;
            end if;

        end if;

    end if;

    /*Atualizar consistencia*/

    if (ds_consistencia_w IS NOT NULL AND ds_consistencia_w::text <> '') then
        update  ctb_movimento
        set     ds_consistencia = ds_consistencia_w
        where   nr_sequencia    = vet01.nr_sequencia;
    end if;

    end;
end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_consistir_classif_lote ( nr_lote_contabil_p ctb_movimento.nr_lote_contabil%type, nm_usuario_p ctb_movimento.nm_usuario%type, ds_erro_p INOUT text) FROM PUBLIC;

