-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_lei_provincial ( nr_interno_conta_p conta_paciente.nr_interno_conta%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_sequencia_w         procedimento_paciente.nr_sequencia%type;
ie_tipo_atendimento_w  atendimento_paciente.ie_tipo_atendimento%type;
ie_transplante_w       atendimento_paciente_inf.ie_transplante%type;
ie_pagador_lei_w       categoria_convenio.ie_pagador_lei%type;
nr_atendimento_w       atendimento_paciente.nr_atendimento%type;
cd_convenio_w          parametro_faturamento.cd_convenio_partic%type;
cd_categoria_w         parametro_faturamento.cd_categoria_partic%type;
ie_origem_proced_w     procedimento.ie_origem_proced%type;
cd_setor_atendimento_w atend_paciente_unidade.cd_setor_atendimento%type;
nr_seq_interno_w       atend_paciente_unidade.nr_seq_interno%type;
dt_entrada_unidade_w   atend_paciente_unidade.dt_entrada_unidade%type;
cd_procedimento_w      procedimento_paciente.cd_procedimento%type;
nr_interno_conta_w     conta_paciente.nr_interno_conta%type;
nr_conta_lei_prov_w    conta_paciente.nr_conta_lei_prov%type;
ie_calc_lei_w          varchar(1);
cd_estabelecimento_w   conta_paciente.cd_estabelecimento%type;


BEGIN
    select CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
    into STRICT   ie_calc_lei_w
    from   conta_paciente a,
           atendimento_paciente b,
           categoria_convenio c,
           atendimento_paciente_inf d
    where  a.nr_interno_conta = nr_interno_conta_p
    and    b.nr_atendimento = a.nr_atendimento
    and    c.cd_convenio = a.cd_convenio_calculo
    and    c.cd_categoria = a.cd_categoria_calculo
    and    b.ie_tipo_atendimento = 1
    and    d.nr_atendimento = b.nr_atendimento
    and (d.ie_transplante)::numeric  = 0;

    if (ie_calc_lei_w = 'S') then

        

        select count(1)
        into STRICT   nr_conta_lei_prov_w
        from   conta_paciente
        where  nr_conta_lei_prov = nr_interno_conta_p;

        if (nr_conta_lei_prov_w = 0) then

            select nextval('procedimento_paciente_seq')
            into STRICT  nr_sequencia_w
;

            select nextval('conta_paciente_seq')
            into STRICT nr_interno_conta_w
;

            select b.ie_tipo_atendimento,
                   c.ie_transplante,
                   d.ie_pagador_lei,
                   b.nr_atendimento,
                   d.cd_procedimento,
                   d.ie_origem_proced
            into STRICT   ie_tipo_atendimento_w,
                   ie_transplante_w,
                   ie_pagador_lei_w,
                   nr_atendimento_w,
                   cd_procedimento_w,
                   ie_origem_proced_w
            from   conta_paciente a,
                   atendimento_paciente b,
                   atendimento_paciente_inf c,
                   categoria_convenio d
            where  a.nr_atendimento = b.nr_atendimento
            and    a.nr_atendimento = c.nr_atendimento
            and    a.cd_convenio_parametro = d.cd_convenio
            and    a.cd_convenio_parametro = d.cd_convenio
            and    a.cd_categoria_parametro = d.cd_categoria
            and    a.nr_interno_conta = nr_interno_conta_p;

            cd_estabelecimento_w := obter_estabelecimento_ativo;

            select cd_convenio_partic,
                   cd_categoria_partic
            into STRICT   cd_convenio_w,
                   cd_categoria_w
            from   parametro_faturamento
            where  cd_estabelecimento = cd_estabelecimento_w;

            select   cd_setor_atendimento,
                     nr_seq_interno,
                     max(dt_entrada_unidade)
            into STRICT     cd_setor_atendimento_w,
                     nr_seq_interno_w,
                     dt_entrada_unidade_w
            from     atend_paciente_unidade
            where    nr_seq_interno in (SELECT obter_Atepacu_paciente(nr_atendimento_w, 'A') )
            group    by cd_setor_atendimento, nr_seq_interno;

                if (ie_tipo_atendimento_w = 1 and ie_transplante_w = 0 and ie_pagador_lei_w = 2) then

                    insert into conta_paciente(
                           cd_estabelecimento,
                           nr_atendimento,
                           dt_acerto_conta,
                           ie_status_acerto,
                           nr_interno_conta,
                           dt_periodo_final,
                           dt_atualizacao,
                           nm_usuario,
                           cd_convenio_parametro,
                           cd_categoria_parametro,
                           dt_periodo_inicial
                           )
                    values (
                           cd_estabelecimento_w,
                           nr_atendimento_w,
                           clock_timestamp(),
                           1,
                           nr_interno_conta_w,
                           clock_timestamp(),
                           clock_timestamp(),
                           nm_usuario_p,
                           cd_convenio_w,
                           cd_categoria_w,
                           clock_timestamp()
                        );

                        insert into procedimento_paciente(
                            nr_sequencia,
                            nr_atendimento,
                            dt_entrada_unidade,
                            cd_procedimento,
                            dt_procedimento,
                            cd_convenio,
                            cd_categoria,
                            ie_origem_proced,
                            qt_procedimento,
                            ie_valor_informado,
                            dt_atualizacao,
                            nm_usuario,
                            vl_procedimento,
                            cd_setor_atendimento,
                            nr_seq_atepacu,
                            nr_interno_conta,
                            vl_medico
                            )
                        values (
                            nr_sequencia_w,
                            nr_atendimento_w,
                            dt_entrada_unidade_w,
                            cd_procedimento_w,
                            clock_timestamp(),
                            cd_convenio_w,
                            cd_categoria_w,
                            ie_origem_proced_w,
                            1,
                            'S',
                            clock_timestamp(),
                            nm_usuario_p,
                            0,
                            cd_setor_atendimento_w,
                            nr_seq_interno_w,
                            nr_interno_conta_w,
                            0
                            );

                            update conta_paciente
                            set    nr_conta_lei_prov = nr_interno_conta_p
                            where  nr_interno_conta  = nr_interno_conta_w
                            and    nr_atendimento    = nr_atendimento_w;

                            CALL add_ley_prov_patient_acc(nr_interno_conta_p);

                            commit;
                    end if;
            end if;
        end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_lei_provincial ( nr_interno_conta_p conta_paciente.nr_interno_conta%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

