-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_exame_lab_result_pepa ( cd_pessoa_fisica_p exame_lab_resultado.cd_pessoa_fisica%type, nr_seq_atend_cons_pepa_p exame_lab_resultado.nr_seq_atend_cons_pepa%type, nr_tipo_atendimento_p ehr_tipo_registro.nr_sequencia%type, nr_atendimento_p exame_lab_resultado.nr_atendimento%type DEFAULT NULL, dt_resultado_p exame_lab_resultado.dt_resultado%type DEFAULT NULL) AS $body$
DECLARE

    exam_lab_result_w    exame_lab_resultado%rowtype;

BEGIN
    BEGIN
        SELECT nr_seq_protocol_ext
        INTO STRICT exam_lab_result_w.nr_seq_protocolo
        FROM ehr_tipo_registro
        WHERE nr_sequencia = nr_tipo_atendimento_p;

    EXCEPTION
       WHEN no_data_found OR too_many_rows OR data_exception THEN
           exam_lab_result_w.nr_seq_protocolo := NULL;
    END;

    exam_lab_result_w.dt_resultado := dt_resultado_p;
    IF coalesce(exam_lab_result_w.dt_resultado::text, '') = '' THEN
        exam_lab_result_w.dt_resultado := clock_timestamp();
    END IF;

    exam_lab_result_w.nr_atendimento := nr_atendimento_p;
    exam_lab_result_w.cd_pessoa_fisica := cd_pessoa_fisica_p;
    exam_lab_result_w.nr_seq_atend_cons_pepa := nr_seq_atend_cons_pepa_p;


        exam_lab_result_p => exam_lab_result_w
     := generate_exam_lab_result(
        exam_lab_result_p => exam_lab_result_w
    );

    CALL lab_gerar_protocolo_exame_ext(
        nr_seq_resultado_p => exam_lab_result_w.nr_seq_resultado,
        nm_usuario_p => exam_lab_result_w.nm_usuario,
        dt_result_item_p => exam_lab_result_w.dt_resultado
    );

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_exame_lab_result_pepa ( cd_pessoa_fisica_p exame_lab_resultado.cd_pessoa_fisica%type, nr_seq_atend_cons_pepa_p exame_lab_resultado.nr_seq_atend_cons_pepa%type, nr_tipo_atendimento_p ehr_tipo_registro.nr_sequencia%type, nr_atendimento_p exame_lab_resultado.nr_atendimento%type DEFAULT NULL, dt_resultado_p exame_lab_resultado.dt_resultado%type DEFAULT NULL) FROM PUBLIC;

