-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_trev_calcular_hidro ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_peso_w						double precision;	
qt_idade_dia_w					bigint;
qt_idade_mes_w					bigint;
qt_idade_ano_w					bigint;
qt_altura_cm_w					bigint;
qt_kcal_total_w					double precision;
qt_kcal_kg_w					double precision;
qt_etapa_w						bigint;
qt_nec_hidrica_diaria_w			double precision;
qt_elem_calcio_w				double precision;
qt_teste_w						double precision;
qt_aporte_hidrico_diario_w		double precision;
qt_vel_inf_glicose_w			double precision;
qt_nec_kcal_dia_w				double precision;
qt_equipo_w						double precision;
qt_soma_outros_w				double precision;
pr_conc_glic_solucao_w			double precision;
ie_magnesio_w					varchar(01);
ie_calculo_auto_w				varchar(01);
ie_correcao_w					varchar(01);
ie_fator_correcao_w				varchar(01);
ie_calcula_vel_inf_glicose_w	varchar(01) := 'N';
hr_prim_horario_w				varchar(05);
qt_gotejo_w						double precision;
ie_emissao_w					varchar(01);
qt_vol_desconto_w				bigint;
qt_hora_validade_w				bigint;
qt_hora_fase_w					bigint;
nr_seq_glicose_w				bigint;
qt_g_glic_kg_dia_w				double precision;
qt_vol_glic_w					double precision;
qt_g_glic_dia_w					double precision;
ie_equilibrio_w					varchar(01);
nr_seq_elemento_w				bigint;
nr_seq_pac_elem_w				bigint;
nr_seq_glic_troca_w				bigint;
qt_vol_elemento_w				double precision;
qt_vol_total_w					double precision;
qt_conversao_ml_w				double precision;
qt_produto_w					integer;
qt_g_menor_w					double precision;
qt_g_maior_w					double precision;
qt_troca_glicose_w				bigint;
qt_vol_cor_w					double precision;
qt_vol_etapa_w					double precision;
qt_min_dia_w					bigint;
qt_gotas_w						bigint;
ie_processo_hidrico_w			varchar(1);
ie_glicose_w					varchar(1);

C01 CURSOR FOR
SELECT	a.nr_sequencia,
		b.qt_conversao_ml,
		a.nr_seq_ele_cpoe
from	nut_elem_material b,
		cpoe_trev_elem_mat a,
		cpoe_trev_elem e
where	a.nr_seq_ele_cpoe	= e.nr_sequencia
and		a.nr_seq_elem_mat	= b.nr_sequencia
and		e.nr_seq_elemento	= nr_seq_glicose_w
and		e.nr_seq_cpoe_trev		= nr_sequencia_p
and		qt_g_menor_w		> 0	
and		coalesce(b.ie_tipo,'NPT')	= 'NPT'
order by qt_conversao_ml desc;

C02 CURSOR FOR
SELECT	b.nr_sequencia
from	nut_elem_material b
where	b.nr_seq_elemento       = nr_seq_glicose_w
and		b.nr_sequencia  not in (	SELECT	nr_seq_ele_cpoe
									from	cpoe_trev_elem_mat
									where	nr_seq_ele_cpoe = nr_seq_pac_elem_w)
and		qt_conversao_ml < qt_conversao_ml_w
and		coalesce(b.ie_tipo,'NPT')	= 'NPT'
order by qt_conversao_ml;

c03 CURSOR FOR
SELECT	b.nr_sequencia,
		b.qt_volume,
		b.qt_vol_cor
from	cpoe_trev_elem_mat b,
		cpoe_trev_elem a
where	a.nr_seq_cpoe_trev	= nr_sequencia_p
and		a.nr_sequencia	= b.nr_seq_ele_cpoe
and		coalesce(b.qt_volume,0)	> 0;

BEGIN


CALL cpoe_trev_gerar_element_prod(nr_sequencia_p, nm_usuario_p);

select	qt_peso,
	qt_altura_cm,
	qt_kcal_total,
	qt_kcal_kg,
	qt_nec_hidrica_diaria,
	qt_aporte_hidrico_diario,
	qt_vel_inf_glicose,
	pr_conc_glic_solucao,
	qt_equipo,
	coalesce(qt_etapa,1),
	coalesce(ie_magnesio,'N'),
	coalesce(ie_processo_hidrico,'N'),
	coalesce(ie_fator_correcao, 'N'),
	coalesce(ie_glicose, 'N')
into STRICT	qt_peso_w,
	qt_altura_cm_w,
	qt_kcal_total_w,
	qt_kcal_kg_w,
	qt_nec_hidrica_diaria_w,
	qt_aporte_hidrico_diario_w,
	qt_vel_inf_glicose_w,
	pr_conc_glic_solucao_w,
	qt_equipo_w,
	qt_etapa_w,
	ie_magnesio_w,
	ie_processo_hidrico_w,
	ie_fator_correcao_w,
	ie_glicose_w
from	cpoe_trev
where	nr_sequencia			= nr_sequencia_p;	

/* Sempre passar zero quando nao for marcado o fator de correcao */

if (ie_fator_correcao_w = 'N') then
	qt_equipo_w := 0;
end if;

select	coalesce(sum(cpoe_obter_vol_elem(a.nr_sequencia)),0)
into STRICT	qt_soma_outros_w
from	nut_elemento b,
		cpoe_trev_elem a
where	a.nr_seq_cpoe_trev		= nr_sequencia_p
and		a.nr_seq_elemento	= b.nr_sequencia
and		b.ie_tipo_elemento	<> 'C';

if (qt_vel_inf_glicose_w > 0) then
	qt_g_Glic_kg_dia_w			:= qt_vel_inf_glicose_w * 1.44;
	ie_calcula_vel_inf_glicose_w := 'N';
else
	select	max(z.qt_dose_padrao)
	into STRICT	qt_g_Glic_kg_dia_w
	from	cpoe_trev_elem x,
			nut_elemento z
	where	nr_seq_cpoe_trev		= nr_sequencia_p
	and		z.nr_sequencia		= x.nr_seq_elemento
	and		z.ie_tipo_elemento	= 'C'
	and		coalesce(z.ie_situacao,'A')	= 'A';

	ie_calcula_vel_inf_glicose_w := 'S';
end if;


qt_vol_Glic_w				:= trunc(qt_aporte_hidrico_diario_w - qt_soma_outros_w); /* Ignora demais */
qt_g_glic_dia_w				:= qt_g_glic_kg_dia_w * qt_peso_w;

qt_kcal_total_w				:= qt_g_glic_dia_w * 4;
qt_kcal_kg_w				:= Dividir(qt_kcal_total_w, qt_peso_w);
pr_conc_glic_solucao_w		:= Dividir((qt_g_glic_dia_w * 100), qt_aporte_hidrico_diario_w);
qt_hora_fase_w				:= Dividir(qt_hora_validade_w, qt_etapa_w);

select	coalesce(max(nr_sequencia),0)
into STRICT	nr_seq_glicose_w
from	nut_elemento
where	ie_tipo_elemento		= 'C'
and ie_situacao	= 'A'
and	ie_rep_he	= 'S'
and	(cd_unidade_medida IS NOT NULL AND cd_unidade_medida::text <> '');


if (ie_calcula_vel_inf_glicose_w = 'S' and ie_glicose_w = 'S') then
	qt_g_glic_dia_w			:= qt_aporte_hidrico_diario_w * 0.08;
	qt_g_Glic_kg_dia_w		:= dividir(qt_g_glic_dia_w, qt_peso_w);
	qt_vel_inf_glicose_w	:= dividir(dividir((qt_g_glic_dia_w * 1000),qt_peso_w),1440);

	update	cpoe_trev
	set		qt_vel_inf_glicose	= qt_vel_inf_glicose_w
	where	nr_sequencia		= nr_sequencia_p;
	
end if;

update	cpoe_trev_elem
set		qt_elem_kg_dia		= qt_g_Glic_kg_dia_w,
		qt_diaria			= qt_g_glic_dia_w
where	nr_seq_cpoe_trev		= nr_sequencia_p
and		nr_seq_elemento		= nr_seq_glicose_w;

update	cpoe_trev
set		qt_kcal_total				= coalesce(qt_kcal_total_w,0),
		qt_kcal_kg					= coalesce(qt_kcal_kg_w,0),
		pr_conc_glic_solucao		= pr_conc_glic_solucao_w,
		qt_etapa					= qt_etapa_w
where	nr_sequencia				= nr_sequencia_p;

CALL cpoe_calcular_trev_element(nr_sequencia_p, nm_usuario_p);

if (ie_magnesio_w = 'S') then
	select	max(qt_elem_kg_dia)
	into STRICT	qt_elem_calcio_w
	from	cpoe_trev_elem x,
			nut_elemento z
	where	nr_seq_cpoe_trev		= nr_sequencia_p
	and		z.nr_sequencia		= x.nr_seq_elemento
	and		z.ie_tipo_elemento	= 'I'
	and		coalesce(z.ie_situacao,'A')	= 'A';

	update	cpoe_trev_elem x
	set		qt_elem_kg_dia		= coalesce(dividir(qt_elem_calcio_w,4),0)
	where	nr_seq_cpoe_trev		= nr_sequencia_p
	and		qt_elem_calcio_w	> 0
	and		x.nr_seq_elemento	= (	SELECT	max(z.nr_sequencia)
									from	nut_elemento z
									where	z.ie_tipo_elemento	= 'M'
									and		coalesce(z.ie_situacao,'A')	= 'A');
end if;

/* Equilibrar Glicose x Balanco Hidrico */

qt_produto_w				:= 0;
qt_vol_total_w				:= 0;
ie_equilibrio_w				:= 'S';
qt_troca_glicose_w			:= 0;
qt_g_menor_w				:= 999;

select	qt_aporte_hidrico_diario
into STRICT	qt_aporte_hidrico_diario_w
from	cpoe_trev
where	nr_sequencia = nr_sequencia_p;

open C01;
loop
fetch C01	into
	nr_seq_elemento_w,
	qt_conversao_ml_w,
	nr_seq_pac_elem_w;	
EXIT WHEN NOT FOUND; /* apply on C01 */
	qt_produto_w := qt_produto_w + 1;
	if (qt_produto_w = 1) then
		qt_vol_elemento_w	:= qt_g_glic_dia_w * qt_conversao_ml_w;
		qt_vol_total_w		:= qt_vol_elemento_w;
		qt_g_menor_w		:= qt_g_glic_dia_w;
		qt_g_maior_w		:= 0;
		nr_seq_glic_Troca_w	:= nr_seq_elemento_w;
	else
		qt_vol_elemento_w	:= 0;
	end if;

	update	cpoe_trev_elem_mat
	set		qt_volume		= qt_vol_elemento_w,
			qt_vol_cor		= 0
	where	nr_sequencia	= nr_seq_elemento_w;
end loop;
close C01;

if (qt_vol_total_w <= qt_vol_glic_w) then
	ie_equilibrio_w			:= 'S';
elsif (qt_produto_w	= 2) then
	ie_equilibrio_w			:= 'N';
end if;
while(ie_equilibrio_w = 'N') loop
	if (qt_vol_total_w > 0) and (qt_vol_total_w <= qt_vol_glic_w) then
		ie_equilibrio_w		:= 'S';
	elsif (qt_vol_total_w = 0) and (qt_troca_glicose_w > 7) then
		ie_equilibrio_w		:= 'S';
	elsif (qt_vol_total_w = 0) or (qt_g_menor_w < 0) then
		nr_seq_elemento_w		:= 0;
		open C02;
		loop
		fetch C02	into
			nr_seq_elemento_w;	
		EXIT WHEN NOT FOUND; /* apply on C02 */
			nr_seq_elemento_w	:= nr_seq_elemento_w;
		end loop;
		close C02;
		if (nr_seq_elemento_w > 0) then
			qt_troca_glicose_w	:= qt_troca_glicose_w + 1;
			
			update	cpoe_trev_elem_mat
			set		nr_seq_elem_mat = nr_seq_elemento_w
			where	nr_sequencia	= nr_seq_glic_Troca_w;
		else
			ie_equilibrio_w	:= 'S';
		end if;
	else
		qt_g_menor_w		:= qt_g_menor_w - 1;
		qt_g_maior_w		:= qt_g_maior_w + 1;
		qt_vol_total_w		:= 0;
		open C01;
		loop
		fetch C01	into
			nr_seq_elemento_w,
			qt_conversao_ml_w,
			nr_seq_pac_elem_w;	
		EXIT WHEN NOT FOUND; /* apply on C01 */
			if (qt_vol_total_w = 0) then
				qt_vol_elemento_w	:= qt_g_menor_w * qt_conversao_ml_w;
			else
				qt_vol_elemento_w	:= qt_g_maior_w * qt_conversao_ml_w;
			end if;
			qt_vol_total_w		:= qt_vol_total_w + qt_vol_elemento_w;
			
			update	cpoe_trev_elem_mat
			set		qt_volume	= qt_vol_elemento_w
			where	nr_sequencia	= nr_seq_elemento_w;
		end loop;
		close C01;
	end if;
end loop;

select	sum(b.qt_volume)
into STRICT	qt_vol_total_w
from	cpoe_trev_elem_mat b,
		cpoe_trev_elem a
where	a.nr_seq_cpoe_trev	= nr_sequencia_p
and		a.nr_sequencia	= b.nr_seq_ele_cpoe;

for c03_w in C03
loop
	qt_vol_cor_w := c03_w.qt_vol_cor;

	if (coalesce(qt_aporte_hidrico_diario_w,0) > 0) then
		qt_vol_cor_w		:= round(c03_w.qt_volume * ((qt_aporte_hidrico_diario_w + qt_equipo_w) / qt_aporte_hidrico_diario_w),4);
		qt_vol_etapa_w		:= dividir(qt_vol_cor_w, coalesce(qt_etapa_w,1));
	end if;
	
	update 	cpoe_trev_elem_mat
	set		qt_vol_cor		= qt_vol_cor_w,
			qt_vol_etapa	= qt_vol_etapa_w
	where	nr_sequencia	= c03_w.nr_sequencia;
end loop;


update	cpoe_trev_elem a
set		qt_volume_corrigido	= (	SELECT	coalesce(sum(b.qt_vol_cor),0)
								from	cpoe_trev_elem_mat b
								where	a.nr_sequencia= b.nr_seq_ele_cpoe),
		qt_volume_etapa		= (	select	coalesce(sum(b.qt_vol_etapa),0)
								from	cpoe_trev_elem_mat b
								where	a.nr_sequencia= b.nr_seq_ele_cpoe),
		qt_volume			= (	select	coalesce(sum(b.qt_volume),0)
								from	cpoe_trev_elem_mat b
								where	a.nr_sequencia= b.nr_seq_ele_cpoe)
where	nr_seq_cpoe_trev	= nr_sequencia_p;

/* Calcular o gotejo em gotas por minuto */

qt_min_dia_w	:= 60 * qt_hora_validade_w;
qt_gotas_w		:= 20 * qt_vol_total_w;
qt_gotejo_w		:= round((dividir(qt_gotas_w, qt_min_dia_w))::numeric,0);


commit;

if (ie_processo_hidrico_w = 'N') then
	CALL cpoe_ajustar_vol_glic_trev(nr_sequencia_p,nm_usuario_p);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_trev_calcular_hidro ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

