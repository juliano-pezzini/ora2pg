-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inativar_registro_template ( nr_sequencia_p bigint, nm_usuario_p text, ds_justificativa_p text default null) AS $body$
DECLARE


qt_nao_lib_w		bigint;
nr_sequencia_w		bigint;
cd_evolucao_w		bigint;
qt_doc_aprov_w      bigint;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	ehr_reg_template
	where	nr_seq_reg	= nr_sequencia_p;

C02 CURSOR FOR
	SELECT	cd_evolucao
	from	evolucao_paciente
	where	NR_SEQ_EHR_REG = nr_sequencia_p;



BEGIN

update	ehr_registro
set	dt_inativacao	= clock_timestamp(),
	NM_USUARIO_INATIVACAO	= nm_usuario_p,
	IE_SITUACAO	= 'I',
	DS_JUSTIFICATIVA	=ds_justificativa_p
where	nr_sequencia	= nr_sequencia_p;

CALL inativar_template_sinal_vital(nr_sequencia_p, nm_usuario_p, ds_justificativa_p);

open C01;
loop
fetch C01 into
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	CALL inativar_reg_template(nr_sequencia_w,nm_usuario_p);
	end;
end loop;
close C01;

open C02;
loop
fetch C02 into
	cd_evolucao_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	CALL inativar_evolucao_paciente(cd_evolucao_w,ds_justificativa_p,nm_usuario_p);
	end;
end loop;
close C02;

CALL delete_assinat_inativa('EHR_REGISTRO','',nr_sequencia_p);

commit;

SELECT COUNT(*) INTO STRICT qt_doc_aprov_w FROM DOCUMENTO_APROVACAO WHERE NM_TABELA_ORIGEM = 'EHR_TEMPLATE' AND NR_SEQ_ORIGEM = nr_sequencia_p;

if (qt_doc_aprov_w > 0) then
    CALL INATIVAR_APROVACAO_DOCUMENTO('EHR_ REGISTRO', 'NR_SEQUENCIA', nr_sequencia_p, nm_usuario_p);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inativar_registro_template ( nr_sequencia_p bigint, nm_usuario_p text, ds_justificativa_p text default null) FROM PUBLIC;

