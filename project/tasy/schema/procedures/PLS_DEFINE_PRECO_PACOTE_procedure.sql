-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_define_preco_pacote ( cd_estabelecimento_p bigint, nr_seq_prestador_p bigint, nr_seq_tipo_acomod_p bigint, dt_pacote_p timestamp, cd_procedimento_p bigint, ie_origem_proced_p bigint, ie_internado_p text, nr_seq_plano_p text, nr_contrato_p bigint, nr_seq_congenere_p bigint, nm_usuario_p text, ie_origem_conta_p text, ie_tipo_intercambio_p text, nr_seq_pacote_p INOUT bigint, nr_seq_regra_pacote_p INOUT bigint, cd_proc_pacote_p INOUT bigint, ie_origem_pacote_p INOUT bigint, vl_pacote_p INOUT bigint, vl_medico_p INOUT bigint, vl_anestesista_p INOUT bigint, vl_auxiliares_p INOUT bigint, vl_custo_operacional_p INOUT bigint, vl_materiais_p INOUT bigint, nr_seq_intercambio_p bigint, nr_seq_classificacao_prest_p bigint, nr_seq_procedimento_p bigint, nr_seq_segurado_p bigint, ie_gerar_log_p text, ie_conta_medica_p text, nr_seq_prest_inter_p pls_conta_v.nr_seq_prest_inter%type default null, ie_tipo_tabela_p bigint default 1) AS $body$
DECLARE


nr_seq_categoria_w		bigint;
vl_pacote_w			double precision	:= 0;
vl_medico_w			double precision	:= 0;
vl_anestesista_w		double precision	:= 0;
vl_auxiliares_w			double precision	:= 0;
vl_custo_operacional_w		double precision	:= 0;
vl_materiais_w			double precision	:= 0;
dt_pacote_w			timestamp;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
ie_preco_w			varchar(10);
ie_tipo_contratacao_w		varchar(10);
ie_regulamentacao_w		varchar(10);
nr_Seq_regra_preco_w		bigint;
ie_excecao_w			varchar(1);
nr_seq_regra_pacote_ww		bigint;
qt_regra_w			bigint;
nr_seq_regra_pacote_w		bigint;
nr_seq_pacote_w			bigint;
nr_seq_grupo_prestador_w	bigint;
ie_grupo_prestador_w		varchar(1)	:= 'S';	
cd_prestador_w			varchar(30);
nr_seq_grupo_produto_w		bigint;
nr_seq_grupo_contrato_w		bigint;
nr_seq_contrato_w		bigint;
nr_seq_intercambio_w		bigint;
ie_grupo_contrato_w		varchar(2);
ie_grupo_produto_w		varchar(2);
nr_seq_regra_w			bigint;
ds_observacao_log_w		varchar(4000);
ie_restringe_estab_w		varchar(2);
ie_tipo_segurado_w		varchar(255);
ie_tipo_repasse_w		varchar(255)	:= 'X';
nr_seq_congenere_w  		pls_segurado.nr_seq_congenere%type;
ie_grupo_operadora_w    	varchar(1);
nr_seq_grupo_operadora_w    	pls_pacote_tipo_acomodacao.nr_seq_grupo_operadora%type;
ie_acomodacao_valida_w		varchar(1);
ie_acomodacao_regra_w		pls_pacote_tipo_acomodacao.ie_acomodacao%type;
nr_seq_tipo_acomod_benef_w	pls_segurado.nr_seq_tipo_acomodacao%type;
ie_tipo_acomodacao_w		pls_tipo_acomodacao.ie_tipo_acomodacao%type;
ie_acomodacao_plano_w		pls_plano.ie_acomodacao%type;

C01 CURSOR FOR	
	SELECT	b.nr_sequencia,
		a.nr_sequencia,
		a.cd_procedimento,
		a.ie_origem_proced,
		coalesce(a.nr_seq_grupo_prestador,0),
		coalesce(a.vl_pacote,0),
		coalesce(a.vl_medico,0),
		coalesce(a.vl_anestesista,0),
		coalesce(a.vl_auxiliares,0),
		coalesce(a.vl_custo_operacional,0),
		coalesce(a.vl_materiais,0),
		coalesce(a.nr_seq_grupo_contrato,0),
		coalesce(a.nr_seq_grupo_produto,0),
		a.nr_seq_grupo_operadora,
		coalesce(a.ie_acomodacao,'N') ie_acomodacao
	from	pls_pacote			b,
		pls_pacote_tipo_acomodacao	a
	where	a.nr_seq_pacote		= b.nr_sequencia
	and	a.ie_situacao = 'A'
	and	((ie_restringe_estab_w	= 'N') or (coalesce(ie_restringe_estab_w::text, '') = '')
	or	(ie_restringe_estab_w	= 'S' AND a.cd_estabelecimento = cd_estabelecimento_p))
	and	(((coalesce(a.nr_seq_prestador::text, '') = '') or a.nr_seq_prestador = coalesce(nr_seq_prestador_p,0)))
	and	((a.cd_prestador = coalesce(cd_prestador_w,'0')) or (coalesce(a.cd_prestador::text, '') = ''))
	and	coalesce(b.cd_procedimento, cd_procedimento_p)	= cd_procedimento_p
	and	coalesce(b.ie_origem_proced,ie_origem_proced_p)	= ie_origem_proced_p
	--and 	nvl(dt_pacote_w,sysdate) between a.dt_inicio_vigencia and nvl(a.dt_fim_vigencia,dt_pacote_w+1)
	and	coalesce(dt_pacote_w,clock_timestamp()) between a.dt_inicio_vigencia AND ESTABLISHMENT_TIMEZONE_UTILS.endOfDay(coalesce(a.dt_fim_vigencia,dt_pacote_w+1)) 
	and	((coalesce(a.nr_seq_tipo_acomodacao::text, '') = '') or (coalesce(nr_seq_tipo_acomod_p::text, '') = '') or (a.nr_seq_tipo_acomodacao = nr_seq_tipo_acomod_p))
	and	((coalesce(a.nr_seq_categoria_acomod::text, '') = '') or (coalesce(nr_seq_categoria_w::text, '') = '') or (a.nr_seq_categoria_acomod = nr_seq_categoria_w))
	and	(
		(coalesce(a.ie_preco,coalesce(ie_preco_w,0)) = coalesce(ie_preco_w,0) and ie_tipo_repasse_w = 'X') or
		/*Preco produto: 1 - Pre, 2,3 - Pos  ----- Tipo repasse PTU: C - Custo, P - Pre pagamento    */

		((ie_tipo_repasse_w <> 'X') and
		((a.ie_preco in ('2','3') and ie_tipo_repasse_w = 'C') or (a.ie_preco  = '1' and ie_tipo_repasse_w = 'P') or (coalesce(a.ie_preco::text, '') = ''))
		)
		)
	and	((coalesce(a.ie_tipo_contratacao::text, '') = '') or (a.ie_tipo_contratacao = coalesce(ie_tipo_contratacao_w,0)))
	and	((coalesce(a.ie_internado,'N') = 'N' ) or (a.ie_internado	= ie_internado_p))
	and	((coalesce(a.ie_tipo_intercambio,'A') = 'A') or (coalesce(a.ie_tipo_intercambio,'A') = coalesce(ie_tipo_intercambio_p,'A')))
	and (coalesce(a.nr_contrato,coalesce(nr_contrato_p,0)) = coalesce(nr_contrato_p,0))
	and	((coalesce(a.nr_seq_plano::text, '') = '') or (a.nr_seq_plano = nr_seq_plano_p))
	and	((coalesce(nr_seq_congenere,0) = coalesce(nr_seq_congenere_p,0)) or (coalesce(nr_seq_congenere::text, '') = ''))
	and	((coalesce(nr_seq_intercambio,0) = coalesce(nr_seq_intercambio_p,0)) or (coalesce(nr_seq_intercambio::text, '') = ''))
	and	((coalesce(ie_regulamentacao,0) = coalesce(ie_regulamentacao_w,0)) or (coalesce(ie_regulamentacao::text, '') = ''))
	and	((coalesce(a.ie_origem_conta, ie_origem_conta_p) = ie_origem_conta_p) or (coalesce(ie_origem_conta_p,'X') = 'X'))
	and (coalesce(ie_tipo_repasse::text, '') = '' or ie_tipo_repasse	= ie_tipo_repasse_w)
	and	((coalesce(ie_tipo_segurado::text, '') = '') or (ie_tipo_segurado 	= ie_tipo_segurado_w))
	and	((coalesce(ie_conta_medica::text, '') = '') or (ie_conta_medica	= ie_conta_medica_p) or (ie_conta_medica = 'S'))
	and (coalesce(ie_tipo_tabela,1) = ie_tipo_tabela_p)
	and	((coalesce(a.nr_seq_prest_inter::text, '') = '')  or (nr_seq_prest_inter_p = a.nr_seq_prest_inter))
	order by coalesce(a.nr_seq_prestador,0),
		coalesce(a.cd_prestador,'0'),
		coalesce(a.cd_procedimento,0),
		coalesce(a.nr_seq_plano,0),        
		coalesce(a.nr_seq_grupo_produto,0),
		coalesce(a.ie_tipo_intercambio,'A'),
		coalesce(a.nr_seq_grupo_prestador,0), 
		coalesce(a.nr_seq_grupo_contrato,0),
		coalesce(a.nr_seq_categoria_acomod,0),
		coalesce(a.nr_seq_tipo_acomodacao,0),
		coalesce(a.nr_contrato,0),     
		a.dt_inicio_vigencia,         
		coalesce(a.ie_tipo_contratacao,'Z') desc,  
		coalesce(a.ie_tipo_segurado,'A'),
		coalesce(a.ie_preco,'0'),          
		coalesce(a.ie_internado,'N'),
		coalesce(a.nr_seq_intercambio,0),  
		coalesce(a.nr_seq_congenere,0),
		coalesce(a.ie_acomodacao,'N');
		

BEGIN
dt_pacote_w	:= coalesce(dt_pacote_p, clock_timestamp());

begin
	select	ie_tipo_segurado,
		nr_seq_congenere,
		nr_seq_tipo_acomodacao
	into STRICT	ie_tipo_segurado_w,
		nr_seq_congenere_w,
		nr_seq_tipo_acomod_benef_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
exception
when others then
	ie_tipo_segurado_w	:= 'X';
end;

if (nr_seq_tipo_acomod_benef_w IS NOT NULL AND nr_seq_tipo_acomod_benef_w::text <> '') then
	select 	max(ie_tipo_acomodacao)
	into STRICT	ie_tipo_acomodacao_w
	from	pls_tipo_acomodacao
	where	nr_sequencia = nr_seq_tipo_acomod_benef_w;
end if;

if (coalesce(ie_tipo_segurado_w,'X')	in ('I','C','T','H')) then /* Se responsabilidade assumida, verifica a formacao de preco do beneficiario */
	begin
		select	coalesce(ie_tipo_repasse,'X')
		into STRICT	ie_tipo_repasse_w
		from	pls_segurado
		where	nr_sequencia	= nr_seq_segurado_p;
	exception
	when others then
		ie_tipo_repasse_w	:= 'X';
	end;
end if;

begin
	select	ie_preco
	into STRICT	ie_preco_w
	from	pls_plano
	where	nr_sequencia	= nr_seq_plano_p;
exception
when others then
	ie_preco_w	:= 0;
end;

begin
	select	ie_tipo_contratacao,
		ie_regulamentacao,
		ie_acomodacao
	into STRICT	ie_tipo_contratacao_w,
		ie_regulamentacao_w,
		ie_acomodacao_plano_w
	from	pls_plano
	where	nr_sequencia	= nr_seq_plano_p;
exception
when others then
	ie_tipo_contratacao_w	:= '';
	ie_regulamentacao_w	:= '';
end;

select	max(nr_seq_categoria)
into STRICT	nr_seq_categoria_w
from	pls_regra_categoria
where	nr_seq_tipo_acomodacao	= nr_seq_tipo_acomod_p;

select	max(cd_prestador)
into STRICT	cd_prestador_w
from	pls_prestador
where	nr_sequencia	= nr_seq_prestador_p;

ie_restringe_estab_w	:= pls_obter_se_controle_estab('GP');


if (coalesce(ie_gerar_log_p,'N') = 'S') then
	ds_observacao_log_w	:=	';cd_estabelecimento_p='||chr(39)||cd_estabelecimento_p||chr(39)||
					';nr_seq_prestador_p='||chr(39)||nr_seq_prestador_p||chr(39)||
					';cd_prestador_w='||chr(39)||cd_prestador_w||chr(39)||
					';cd_procedimento_p='||chr(39)||cd_procedimento_p||chr(39)||
					';ie_origem_proced_p='||chr(39)||ie_origem_proced_p||chr(39)||
					';dt_pacote_w='||chr(39)||dt_pacote_w||chr(39)||
					';nr_seq_tipo_acomod_p='||chr(39)||nr_seq_tipo_acomod_p||chr(39)||
					';nr_seq_categoria_w='||chr(39)||nr_seq_categoria_w||chr(39)||
					';ie_preco_w='||chr(39)||ie_preco_w||chr(39)||
					';ie_tipo_contratacao_w='||chr(39)||ie_tipo_contratacao_w||chr(39)||
					';ie_internado_p='||chr(39)||ie_internado_p||chr(39)||
					';ie_tipo_intercambio_p='||chr(39)||ie_tipo_intercambio_p||chr(39)||
					';nr_contrato_p='||chr(39)||nr_contrato_p||chr(39)||
					';nr_seq_plano_p='||chr(39)||nr_seq_plano_p||chr(39)||
					';nr_seq_congenere_p='||chr(39)||nr_seq_congenere_p||chr(39)||
					';nr_seq_intercambio_p='||chr(39)||nr_seq_intercambio_p||chr(39)||
					';ie_regulamentacao_w='||chr(39)||ie_regulamentacao_w||chr(39)||
					';ie_origem_conta_p='||chr(39)||ie_origem_conta_p||chr(39);

	CALL pls_gravar_log_calculo_proc(	'S', nr_seq_procedimento_p, cd_estabelecimento_p,
					'Inicio da definicao do preco', ds_observacao_log_w, 'pls_define_preco_pacote',
					0, 0, 0, 
					0, 0, 0,
					0, nr_seq_regra_w, 0,
					0,null,null, 'Log');
end if;

open C01;
loop
fetch C01 into	
	nr_seq_pacote_w,
	nr_seq_regra_pacote_ww,
	cd_procedimento_w,
	ie_origem_proced_w,
	nr_seq_grupo_prestador_w,
	vl_pacote_w,
	vl_medico_w,
	vl_anestesista_w,
	vl_auxiliares_w,
	vl_custo_operacional_w,
	vl_materiais_w,
	nr_seq_grupo_contrato_w,
	nr_seq_grupo_produto_w,
	nr_seq_grupo_operadora_w,
	ie_acomodacao_regra_w;	
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	ie_acomodacao_valida_w := 'S';
	
	if (ie_acomodacao_regra_w <> 'N') then
			
		if (ie_acomodacao_regra_w <> ie_tipo_acomodacao_w or coalesce(ie_tipo_acomodacao_w::text, '') = '') and (ie_acomodacao_regra_w <> ie_acomodacao_plano_w or coalesce(ie_acomodacao_plano_w::text, '') = '') then
			ie_acomodacao_valida_w := 'N';
		end if;	
	end if;
	
	if (ie_acomodacao_valida_w = 'S') then
	
		ie_excecao_w	:= 'N';
		ie_grupo_produto_w		:= 'S';
		ie_grupo_contrato_w		:= 'S';
		ie_grupo_prestador_w		:= 'S';
		ie_grupo_operadora_w    := 'S';

		select 	count(1)	
		into STRICT 	qt_regra_w
		from	pls_pacote_preco_Excecao
		where	nr_seq_regra_preco	= nr_seq_regra_pacote_ww;

		if (qt_regra_w > 0)	then
			ie_excecao_w := pls_excecao_preco_pacote(nr_seq_regra_pacote_ww, nr_seq_congenere_p, '', nr_seq_intercambio_p, nr_seq_prestador_p, ie_excecao_w, nr_seq_congenere_w);
		end if;
		
		if (coalesce(nr_seq_grupo_contrato_w,0) > 0) then
			if	((coalesce(nr_contrato_p,0)	> 0) or (coalesce(nr_seq_intercambio_p,0) > 0)) then
				ie_grupo_contrato_w	:= pls_se_grupo_preco_contrato(nr_seq_grupo_contrato_w, nr_contrato_p, nr_seq_intercambio_p);
			else
				ie_grupo_contrato_w	:= 'N';
			end if;
		end if;
		/* Grupo de produtos */

		if (coalesce(nr_seq_grupo_produto_w,0) > 0) then
			ie_grupo_produto_w	:= pls_se_grupo_preco_produto(nr_seq_grupo_produto_w, nr_seq_plano_p);
		end if;
	
		if (coalesce(nr_seq_grupo_prestador_w,0) > 0) then
			ie_grupo_prestador_w	:= pls_se_grupo_preco_prestador(nr_seq_grupo_prestador_w, nr_seq_prestador_p,coalesce(nr_seq_classificacao_prest_p,''));
		end if;
	
		if (ie_excecao_w = 'N') then		
			nr_seq_regra_pacote_w	:=	nr_seq_regra_pacote_ww;
		end if;	
	
	    if (nr_seq_grupo_operadora_w IS NOT NULL AND nr_seq_grupo_operadora_w::text <> '') then
		ie_grupo_operadora_w := pls_se_grupo_preco_operadora(nr_seq_grupo_operadora_w,coalesce(nr_seq_congenere_w,nr_seq_congenere_p));
		end if;
		
		if (coalesce(ie_grupo_prestador_w,'N') = 'S') and (coalesce(ie_grupo_produto_w,'N') = 'S') and (coalesce(ie_grupo_contrato_w,'N') = 'S') and (coalesce(ie_grupo_operadora_w,'N') = 'S') and (coalesce(nr_seq_regra_pacote_w,0) > 0) and (ie_excecao_w = 'N') then	
			nr_seq_regra_pacote_p	:= nr_seq_regra_pacote_w;
			nr_seq_pacote_p		:= nr_seq_pacote_w;
			cd_proc_pacote_p	:= cd_procedimento_w;
			ie_origem_pacote_p	:= ie_origem_proced_w;
			vl_pacote_p		:= vl_pacote_w;
			vl_medico_p		:= vl_medico_w;
			vl_anestesista_p	:= vl_anestesista_w;
		
		end if;	
	end if;

    end;
end loop;
close C01;

if (coalesce(ie_gerar_log_p,'N') = 'S') then
	ds_observacao_log_w	:= 'Regra: '||nr_seq_regra_pacote_w||' / Seq. pacote : '||nr_seq_pacote_w;

	CALL pls_gravar_log_calculo_proc(	'S', nr_seq_procedimento_p, cd_estabelecimento_p,
					'Preco informado', ds_observacao_log_w, 'pls_define_preco_pacote',
					vl_pacote_w, 0, 0, 
					vl_medico_w, 0, vl_anestesista_w,
					1, nr_seq_regra_pacote_w, 0,
					0,null, null, 'Log');
end if;

 /*Felipe - OS 84642 - 10/09/2008
vl_auxiliares_p		:= vl_auxiliares_w;
vl_custo_operacional_p		:= vl_custo_operacional_w;
vl_materiais_p		:= vl_materiais_w;
*/
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_define_preco_pacote ( cd_estabelecimento_p bigint, nr_seq_prestador_p bigint, nr_seq_tipo_acomod_p bigint, dt_pacote_p timestamp, cd_procedimento_p bigint, ie_origem_proced_p bigint, ie_internado_p text, nr_seq_plano_p text, nr_contrato_p bigint, nr_seq_congenere_p bigint, nm_usuario_p text, ie_origem_conta_p text, ie_tipo_intercambio_p text, nr_seq_pacote_p INOUT bigint, nr_seq_regra_pacote_p INOUT bigint, cd_proc_pacote_p INOUT bigint, ie_origem_pacote_p INOUT bigint, vl_pacote_p INOUT bigint, vl_medico_p INOUT bigint, vl_anestesista_p INOUT bigint, vl_auxiliares_p INOUT bigint, vl_custo_operacional_p INOUT bigint, vl_materiais_p INOUT bigint, nr_seq_intercambio_p bigint, nr_seq_classificacao_prest_p bigint, nr_seq_procedimento_p bigint, nr_seq_segurado_p bigint, ie_gerar_log_p text, ie_conta_medica_p text, nr_seq_prest_inter_p pls_conta_v.nr_seq_prest_inter%type default null, ie_tipo_tabela_p bigint default 1) FROM PUBLIC;

