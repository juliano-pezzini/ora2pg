-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_ordem_serv_inserir_hist_ws (nr_seq_ordem_serv_p bigint, dt_historico_p timestamp, ds_relat_tecnico_p text, cd_estabelecimento_p text, nr_seq_philips_p bigint, ie_status_ws_p text ) AS $body$
DECLARE

					 nr_seq_hist_w	bigint;

qt_os_w				  smallint := 0;
nr_sequencia_w  man_ordem_serv_tecnico.nr_sequencia%type;


BEGIN

if (nr_seq_ordem_serv_p IS NOT NULL AND nr_seq_ordem_serv_p::text <> '') then

    if (nr_seq_philips_p IS NOT NULL AND nr_seq_philips_p::text <> '') then 
  
        select  max(nr_sequencia)
        into STRICT    nr_seq_hist_w
        from    man_ordem_serv_tecnico
        where   nr_seq_ordem_serv = nr_seq_ordem_serv_p
        and     nr_seq_philips = nr_seq_philips_p;

        if (nr_seq_hist_w IS NOT NULL AND nr_seq_hist_w::text <> '') then
            
            update  man_ordem_serv_tecnico
            set     dt_atualizacao    = clock_timestamp(),
                                    dt_historico      = dt_historico_p,
                                    dt_liberacao      = dt_historico_p,
                                    nm_usuario        = 'WebService',
                                    nr_seq_tipo       = obter_parametro_usuario_js(299, 200),
                                    ie_origem         = 'E',
                                    ds_relat_tecnico  = ds_relat_tecnico_p,
                                    ie_status_ws      = ie_status_ws_p
            where   nr_seq_ordem_serv = nr_seq_ordem_serv_p
            and     nr_seq_philips    = nr_seq_philips_p
            and     nr_sequencia      = nr_seq_hist_w;

        end if;
	end if;
	
	if (coalesce(nr_seq_hist_w::text, '') = '') then
	
		select 	nextval('man_ordem_serv_tecnico_seq')
		into STRICT	nr_seq_hist_w
		;
	
		insert
			into 	man_ordem_serv_tecnico(nr_sequencia, 
								nr_seq_ordem_serv, 
								dt_atualizacao, 
								dt_historico, 
								dt_liberacao,
								nm_usuario, 
								nr_seq_tipo,
								ie_origem,
								ds_relat_tecnico,
								nr_seq_philips,
								ie_status_ws) 
						values (nr_seq_hist_w, 
								nr_seq_ordem_serv_p, 
								clock_timestamp(),
								dt_historico_p, 
								dt_historico_p, 
								'WebService',
								obter_parametro_usuario_js(299, 200), 
								'E',
								ds_relat_tecnico_p,
								nr_seq_philips_p,
								ie_status_ws_p
								);
	end if;

    if (obter_parametro_usuario_js(299, 142) = 'S') then
                CALL man_comunicar_historico(nr_seq_hist_w, 'E', 'WebService', 'N', cd_estabelecimento_p);
    end if;
    commit;
	
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_ordem_serv_inserir_hist_ws (nr_seq_ordem_serv_p bigint, dt_historico_p timestamp, ds_relat_tecnico_p text, cd_estabelecimento_p text, nr_seq_philips_p bigint, ie_status_ws_p text ) FROM PUBLIC;

