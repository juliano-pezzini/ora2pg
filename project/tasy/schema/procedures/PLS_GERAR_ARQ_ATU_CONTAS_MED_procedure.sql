-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_arq_atu_contas_med ( nm_arquivo_p text, cd_interface_p bigint, ie_tipo_registro_p bigint, ds_local_p INOUT text) AS $body$
DECLARE


arq_texto_w			utl_file.file_type;
ds_erro_w			varchar(255);
ds_conteudo_w			varchar(4000);
ds_campos_w			varchar(4000);
ds_sql_w			varchar(4000);
bind_sql_valor_w		sql_pck.t_dado_bind;
cursor_w			sql_pck.t_cursor;
ds_registro_w			varchar(4000);
ds_local_w			evento_tasy_utl_file.ds_local%type;
ds_local_windows_w		evento_tasy_utl_file.ds_local_rede%type;

C01 CURSOR(	cd_interface_pc		bigint) FOR
	SELECT	nm_atributo,
		qt_tamanho,
		ie_tipo_atributo
	from 	interface_atributo
	where 	cd_interface	= cd_interface_pc
	and 	qt_tamanho 	> 0
	order by nr_seq_atributo;
BEGIN

--Monta o layout da interface
for r_CO1_w in C01(cd_interface_p) loop
	if (r_CO1_w.ie_tipo_atributo = 'NUMBER') then
		ds_campos_w := ds_campos_w ||' lpad('||r_CO1_w.nm_atributo||','||r_CO1_w.qt_tamanho||',0)||';
	else
		ds_campos_w := ds_campos_w ||' rpad('||r_CO1_w.nm_atributo||','||r_CO1_w.qt_tamanho||')||';
	end if;
end loop;


ds_campos_w 	:= substr(ds_campos_w,0,length(ds_campos_w)-2);
ds_sql_w	:= 'Select '||ds_campos_w||' from pls_atuarial where ie_tipo_registro = ' || ie_tipo_registro_p || ' order by ie_tipo_registro ';

begin
select	max(ds_local),
	max(ds_local_rede)
into STRICT	ds_local_w,
	ds_local_windows_w
from	evento_tasy_utl_file
where	cd_evento	= 14;

arq_texto_w := utl_file.fopen(ds_local_w,nm_arquivo_p,'W');
exception
when others then
	if (SQLSTATE = -29289) then
		ds_erro_w  := 'O acesso ao arquivo foi negado pelo sistema operacional (access_denied).';
	elsif (SQLSTATE = -29298) then
		ds_erro_w  := 'O arquivo foi aberto usando FOPEN_NCHAR,  mas efetuaram-se operações de I/O usando funções nonchar comos PUTF ou GET_LINE (charsetmismatch).';
	elsif (SQLSTATE = -29291) then
		ds_erro_w  := 'Não foi possível apagar o arquivo (delete_failed).';
	elsif (SQLSTATE = -29286) then
		ds_erro_w  := 'Erro interno desconhecido no package UTL_FILE (internal_error).';
	elsif (SQLSTATE = -29282) then
		ds_erro_w  := 'O handle do arquivo não existe (invalid_filehandle).';
	elsif (SQLSTATE = -29288) then
		ds_erro_w  := 'O arquivo com o nome especificado não foi encontrado neste local (invalid_filename).';
	elsif (SQLSTATE = -29287) then
		ds_erro_w  := 'O valor de MAX_LINESIZE para FOPEN() é inválido; deveria estar na faixa de 1 a 32767 (invalid_maxlinesize).';
	elsif (SQLSTATE = -29281) then
		ds_erro_w  := 'O parâmetro open_mode na chamda FOPEN é inválido (invalid_mode).';
	elsif (SQLSTATE = -29290) then
		ds_erro_w  := 'O parâmetro ABSOLUTE_OFFSET para a chamada FSEEK() é inválido; deveria ser maior do que 0 e menor do que o número total de bytes do arquivo (invalid_offset).';
	elsif (SQLSTATE = -29283) then
		ds_erro_w  := 'O arquivo não pôde ser aberto ou operado da forma desejada - ou o caminho não foi encontrado (invalid_operation).';
	elsif (SQLSTATE = -29280) then
		ds_erro_w  := 'O caminho especificado não existe ou não está visível ao Oracle (invalid_path).';
	elsif (SQLSTATE = -29284) then
		ds_erro_w  := 'Não é possível efetuar a leitura do arquivo (read_error).';
	elsif (SQLSTATE = -29292) then
		ds_erro_w  := 'Não é possível renomear o arquivo.';
	elsif (SQLSTATE = -29285) then
		ds_erro_w  := 'Não foi possível gravar no arquivo (write_error).';
	else
		ds_erro_w  := 'Erro desconhecido no package UTL_FILE.';
	end if;
end;
if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_erro_w );
end if;

begin
	bind_sql_valor_w := sql_pck.executa_sql_cursor(ds_sql_w, bind_sql_valor_w);

	loop
		fetch 	cursor_w
		into	ds_registro_w;
		EXIT WHEN NOT FOUND; /* apply on cursor_w */
			utl_file.put_line(arq_texto_w,ds_registro_w || chr(13));
	end loop;
	close cursor_w;
exception
	when others then

		if (cursor_w%isopen) then
			close cursor_w;
		end if;
end;

utl_file.fflush(arq_texto_w);
utl_file.fclose(arq_texto_w);
ds_local_p := ds_local_windows_w || nm_arquivo_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_arq_atu_contas_med ( nm_arquivo_p text, cd_interface_p bigint, ie_tipo_registro_p bigint, ds_local_p INOUT text) FROM PUBLIC;

