-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE angular_alterar_status_age_pac ( ie_status_agenda_p text, ds_sequencia_p text, nm_usuario_p text) AS $body$
DECLARE

 
cd_agenda_w			bigint;
ds_sequencia_w 	varchar(255);
nr_sequencia_w		bigint;
cd_tipo_agenda_w	bigint;
cd_funcao_ativa_w	bigint;
tam_lista_w			bigint;
ie_pos_virgula_w	bigint;
			
			 

BEGIN 
cd_funcao_ativa_w := obter_funcao_ativa;
ds_sequencia_w	:= ds_sequencia_p;
 
--R a i s e_application_error(-20011,'#@#@ - ' || ds_sequencia_w); 
 
while(ds_sequencia_w IS NOT NULL AND ds_sequencia_w::text <> '') loop 
	begin 
	 
	tam_lista_w			:= length(ds_sequencia_w);
	ie_pos_virgula_w	:= position(',' in ds_sequencia_w);
 
	 
	 
	if (ie_pos_virgula_w <> 0) then 
		nr_sequencia_w	:= (substr(ds_sequencia_w,1,(ie_pos_virgula_w - 1)))::numeric;
		ds_sequencia_w	:= substr(ds_sequencia_w,(ie_pos_virgula_w + 1),tam_lista_w);
		 
		 
		if (nr_sequencia_w > 0) then 
			 
			if (cd_funcao_ativa_w = 869) then -- 869 = Agenda Integrada 
				select 	b.cd_agenda, 
					b.cd_tipo_agenda 
				into STRICT 	cd_agenda_w, 
					cd_tipo_agenda_w 
				from	agenda_paciente a, 
					agenda b 
				where	a.cd_agenda	= b.cd_agenda			 
				and	b.cd_tipo_agenda in (1,2) 
				and	a.nr_sequencia 	= nr_sequencia_w 
				
union
 
				SELECT 	b.cd_agenda, 
					b.cd_tipo_agenda 
				from	agenda_consulta a, 
					agenda b 
				where	a.cd_agenda	= b.cd_agenda			 
				and	b.cd_tipo_agenda in (3,4,5) 
				and	a.nr_sequencia 	= nr_sequencia_w;			
			else				 
				select 	b.cd_agenda, 
					b.cd_tipo_agenda 
				into STRICT 	cd_agenda_w, 
					cd_tipo_agenda_w 
				from	agenda_paciente a, 
					agenda b 
				where	a.cd_agenda	= b.cd_agenda			 
				and	b.cd_tipo_agenda in (1,2) 
				and	a.nr_sequencia 	= nr_sequencia_w;
			end if;
		end if;
		 
	end if;
	 
	 
	if (cd_tipo_agenda_w in (1,2))then 
		CALL Alterar_Status_Agenda(cd_agenda_w, nr_sequencia_w, ie_status_agenda_p, '', '', 'N', nm_usuario_p);
	elsif (cd_tipo_agenda_w in (3,4,5)) then 
			CALL alterar_status_agecons(cd_agenda_w, nr_sequencia_w, ie_status_agenda_p, '', '', 'N', nm_usuario_p, null);
	end if;
	 
	 
	end;
end loop;	
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE angular_alterar_status_age_pac ( ie_status_agenda_p text, ds_sequencia_p text, nm_usuario_p text) FROM PUBLIC;

