-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dirf_registro_decpj ( nr_seq_lote_p bigint, nm_usuario_p text) AS $body$
DECLARE


separador_w	varchar(1) := '|';
ds_arquivo_w	varchar(2000);
ie_fund_pub_privado_w  varchar(1);

BEGIN

select max(b.ie_fund_pub_privado)
into STRICT ie_fund_pub_privado_w
from dirf_lote a,
     dirf_regra_geral b
where a.cd_estabelecimento = b.cd_estabelecimento
and a.nr_sequencia = nr_seq_lote_p;

select  'DECPJ' || separador_w ||
	lpad(b.cd_cgc,14,'0') || separador_w || --cpf/cnpj
	substr(e.nm_razao_social,1,150) || separador_w || -- nome empresarial
	substr(a.ie_natureza_declarante,1,1) || separador_w || --natureza do declarante
	lpad(coalesce(substr(obter_dados_pf(CASE WHEN coalesce(a.ie_responsavel_cnpj,'C')='C' THEN e.cd_contabilista WHEN coalesce(a.ie_responsavel_cnpj,'C')='T' THEN e.cd_titular  ELSE e.cd_contabilista END ,'CPF'),1,11),' '),11,'0') || separador_w || -- cpf do responsavel
	CASE WHEN a.ie_indicador_socio=0 THEN 'N'  ELSE 'S' END  || separador_w || --indicasdor de de socio
	CASE WHEN a.ie_declarante_depositario=0 THEN 'N'  ELSE 'S' END   || separador_w || --declarante depositário
	'N' || separador_w || -- declarante é ionsituicao administradora
	'N' || separador_w || -- pagou rendimentos a residentes no exterior
	ie_ind_plano_privado || separador_w || -- Indicador plano privado
	obter_dados_dirf_estab(a.cd_estabelecimento, 'EII') || separador_w || -- Indicador de entidade em que a União detém maioria do capital social sujeito a voto, recebe recursos do Tesouro Nacional e está obrigada a registrar a execução orçamentária no Siafi (IN 1.234/2012, art. 4º, incisos III e IV)
	coalesce(ie_fund_pub_privado_w, 'N') || separador_w || -- CAMPO NOVO
	CASE WHEN coalesce(a.ie_situacao_especial::text, '') = '' THEN 'N'  ELSE a.ie_situacao_especial END   || separador_w || --  declaracao de situação especial
	separador_w -- data do evento quando campo anterior for S
into STRICT	ds_arquivo_w
from	dirf_lote a,
	estabelecimento b,
	empresa e
where	a.cd_estabelecimento	= b.cd_estabelecimento
and	b.cd_empresa = e.cd_empresa
and	a.nr_sequencia = nr_seq_lote_p;

insert 	into w_dirf_arquivo(nr_sequencia,
			     nm_usuario,
			     nm_usuario_nrec,
			     dt_atualizacao,
			     dt_atualizacao_nrec,
			     ds_arquivo,
			     nr_seq_apresentacao,
			     nr_seq_registro)
values (nextval('w_dirf_arquivo_seq'),
			     nm_usuario_p,
			     nm_usuario_p,
			     clock_timestamp(),
			     clock_timestamp(),
			     ds_arquivo_w,
			     '3',
			     0);


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dirf_registro_decpj ( nr_seq_lote_p bigint, nm_usuario_p text) FROM PUBLIC;

