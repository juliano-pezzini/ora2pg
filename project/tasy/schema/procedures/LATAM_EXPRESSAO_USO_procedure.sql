-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE latam_expressao_uso (cd_expressao_p bigint, nm_usuario_p text) AS $body$
DECLARE


nm_tabela_w			varchar(255);
nm_integridade_referencial_w	varchar(255);
nm_atributo_w			varchar(255);
cd_expressao_w			bigint;
ds_sep_bv_w			varchar(20);
qt_expressao_w			double precision := 0;
total_expressao_w		double precision := 0;
nm_atributo_ind_w	varchar(255);
retorno_w			integer;
nm_indice_w			varchar(255);
ds_comando_w		varchar(2000);
c08				integer;

C01 CURSOR FOR
SELECT 	cd_expressao
from	dic_expressao
where	cd_expressao = cd_expressao_p;

C02 CURSOR FOR
SELECT 	a.nm_tabela,
		b.nm_atributo
FROM	integridade_referencial a,
		integridade_atributo b
where	a.nm_integridade_referencial = b.nm_integridade_referencial
and		nm_tabela_referencia = 'DIC_EXPRESSAO'
and		a.nm_tabela not in ('DIC_EXPRESSAO_TRADUCAO','W_DIC_EXPRESSAO_USO','DIC_EXPRESSAO_HISTORICO');

C03 CURSOR FOR
SELECT	b.NM_ATRIBUTO
from	indice a,
		indice_atributo b
where	a.nm_tabela = b.nm_tabela
and		a.nm_indice = b.nm_indice
and		a.nm_tabela = nm_tabela_w
and		a.ie_tipo 	= 'PK';



BEGIN

delete
from	w_dic_expressao_uso
where	cd_expressao = cd_expressao_p
and		nm_usuario	= nm_usuario_p;
commit;

select	obter_separador_bv
into STRICT	ds_sep_bv_w
;

open C01;
loop
fetch C01 into
	cd_expressao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
		total_expressao_w := 0;
		open C02;
		loop
		fetch C02 into
			nm_tabela_w,
			nm_atributo_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
				qt_expressao_w := 0;
				nm_atributo_ind_w := '';

				if (nm_tabela_w = 'TABELA_VISAO_ATRIBUTO') then
					nm_atributo_ind_w	:= 'NR_SEQUENCIA';
				elsif (nm_tabela_w = 'TABELA_ATRIBUTO') then
					nm_atributo_ind_w	:= 'NM_TABELA';
				elsif (nm_tabela_w = 'FUNCAO_PARAMETRO') then
					nm_atributo_ind_w	:= 'CD_FUNCAO';
				else
					open C03;
					loop
					fetch C03 into
						nm_indice_w;
					EXIT WHEN NOT FOUND; /* apply on C03 */
						begin
						if coalesce(nm_atributo_ind_w::text, '') = '' then
							nm_atributo_ind_w := nm_indice_w;
						else
							nm_atributo_ind_w := nm_atributo_ind_w || ' || ' || ' '' - '' ' || ' || ' || nm_indice_w;
						end if;

						end;
					end loop;
					close C03;
				end if;

				ds_comando_w := 'select ' || nm_atributo_ind_w || ' from ' || nm_tabela_w || ' where ' || nm_atributo_w || ' = ' || cd_expressao_w;

				c08 := dbms_sql.open_cursor;
				dbms_sql.parse(c08, ds_comando_w, dbms_sql.native);
				dbms_sql.define_column(c08, 1, nm_indice_w, 255);
				retorno_w := dbms_sql.execute(c08);

				while(dbms_sql.fetch_rows(c08) > 0 ) loop
					dbms_sql.column_value(c08, 1, nm_indice_w);

					insert into w_dic_expressao_uso(nr_sequencia, dt_atualizacao, nm_usuario, cd_expressao, nm_tabela, nm_atributo, nm_indice)
					values (nextval('w_dic_expressao_uso_seq'), clock_timestamp(), nm_usuario_p, cd_expressao_w,nm_tabela_w,nm_atributo_w,nm_indice_w);

				end loop;

				dbms_sql.close_cursor(c08);
			end;
		end loop;
		close C02;
	end;

end loop;
close C01;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE latam_expressao_uso (cd_expressao_p bigint, nm_usuario_p text) FROM PUBLIC;

