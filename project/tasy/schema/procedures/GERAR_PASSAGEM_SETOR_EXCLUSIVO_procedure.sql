-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_passagem_setor_exclusivo ( cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_atendimento_p bigint, nm_usuario_p text, nr_seq_atepacu_p INOUT bigint, dt_entrada_unidade_p INOUT timestamp, cd_setor_exclusivo_p INOUT bigint, nr_sequencia_p INOUT bigint) AS $body$
DECLARE

 
						 
cd_setor_exclusivo_w	bigint;
qt_existe_w		bigint;
nr_seq_atepacu_w		bigint;
dt_entrada_unidade_w	timestamp;
nr_sequencia_w		bigint;


BEGIN 
 
select	max(obter_setor_exclusivo(cd_procedimento_p, ie_origem_proced_p, nm_usuario_p)) 
into STRICT	cd_setor_exclusivo_w
;
 
if (coalesce(cd_setor_exclusivo_w,0) <> 0) then 
	 
	select	count(*) 
	into STRICT	qt_existe_w 
	from	atend_paciente_unidade 
	where	cd_setor_atendimento = cd_setor_exclusivo_w 
	and	nr_atendimento = nr_atendimento_p;
	 
	if (qt_existe_w > 0) then 
		 
		select	max(nr_seq_interno) 
		into STRICT	nr_seq_atepacu_w 
		from	atend_paciente_unidade 
		where	cd_setor_atendimento = cd_setor_exclusivo_w 
		and	nr_atendimento = nr_atendimento_p;
		 
		select	max(dt_entrada_unidade) 
		into STRICT	dt_entrada_unidade_w 
		from	atend_paciente_unidade 
		where	nr_atendimento = nr_atendimento_p 
		and	nr_seq_interno = nr_seq_atepacu_w;
	 
	else 
		 
		CALL gerar_passagem_setor_atend(nr_atendimento_p, cd_setor_exclusivo_w, clock_timestamp(), 'S', nm_usuario_p);
		 
		select	max(nr_sequencia) 
		into STRICT	nr_sequencia_w 
		from	atend_paciente_unidade 
		where	nr_atendimento = nr_atendimento_p;
		 
		select	max(nr_seq_interno) 
		into STRICT	nr_seq_atepacu_w 
		from	atend_paciente_unidade 
		where	nr_atendimento = nr_atendimento_p 
		and	nr_sequencia = nr_sequencia_w;
		 
		select	max(dt_entrada_unidade) 
		into STRICT	dt_entrada_unidade_w 
		from	atend_paciente_unidade 
		where	nr_atendimento = nr_atendimento_p 
		and	nr_seq_interno = nr_seq_atepacu_w;
		 
	end if;
 
end if;
 
nr_seq_atepacu_p := nr_seq_atepacu_w;
dt_entrada_unidade_p := dt_entrada_unidade_w;
cd_setor_exclusivo_p := cd_setor_exclusivo_w;
nr_sequencia_p := nr_sequencia_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_passagem_setor_exclusivo ( cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_atendimento_p bigint, nm_usuario_p text, nr_seq_atepacu_p INOUT bigint, dt_entrada_unidade_p INOUT timestamp, cd_setor_exclusivo_p INOUT bigint, nr_sequencia_p INOUT bigint) FROM PUBLIC;

