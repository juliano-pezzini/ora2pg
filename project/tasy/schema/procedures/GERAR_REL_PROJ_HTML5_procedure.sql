-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_rel_proj_html5 ( dt_inic_prev_p timestamp, dt_fim_prev_p timestamp, dt_inic_real_p timestamp, dt_fim_real_p timestamp, cd_coordenador_p text, nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_projeto_w		bigint;
ds_sql_w			varchar(2000);
c001				integer;
retorno_w			integer;
qt_reg_w			bigint;
nr_sequencia_w			bigint;

-- Projet
dt_inicio_prev_w		timestamp;
dt_fim_prev_w			timestamp;
dt_inicio_real_w		timestamp;
dt_fim_real_w			timestamp;
qt_horas_proj_w			bigint;

--Plan
dt_inicio_prev_plan_w		timestamp;
dt_fim_prev_plan_w		timestamp;
dt_inicio_real_plan_w		timestamp;
dt_fim_real_plan_w		timestamp;
qt_horas_plan_w			bigint;

--Execução
dt_inicio_prev_exec_w		timestamp;
dt_fim_prev_exec_w		timestamp;
dt_inicio_real_exec_w		timestamp;
dt_fim_real_exec_w		timestamp;
qt_horas_exec_w			bigint;

--Aprovação gerente
dt_inicio_prev_aprov_w		timestamp;
dt_inicio_real_aprov_w		timestamp;

--Prepare to Checkpoint
dt_inicio_prev_prep_w		timestamp;
dt_fim_prev_prep_w		timestamp;
dt_inicio_real_prep_w		timestamp;
dt_fim_real_prep_w		timestamp;
qt_horas_prep_w			bigint;

--Check Point Meeting
dt_inicio_prev_meet_w		timestamp;
dt_fim_prev_meet_w		timestamp;
dt_inicio_real_meet_w		timestamp;
dt_fim_real_meet_w		timestamp;
qt_horas_meet_w			bigint;

--bug fix
dt_inicio_prev_bug_w		timestamp;
dt_fim_prev_bug_w		timestamp;
dt_inicio_real_bug_w		timestamp;
dt_fim_real_bug_w		timestamp;
qt_horas_bug_w			bigint;


C10 CURSOR FOR
	SELECT	a.nr_sequencia
	from	proj_projeto a
	where	((coalesce(nr_sequencia_p,0) = 0) or (a.nr_sequencia = nr_sequencia_p))
	and	((coalesce(dt_inic_prev_p::text, '') = '') or (dt_inicio_prev between dt_inic_prev_p and coalesce(fim_dia(dt_fim_prev_p),clock_timestamp())))
	and	((coalesce(dt_inic_real_p::text, '') = '') or (dt_inicio_real between dt_inic_real_p and coalesce(fim_dia(dt_fim_real_p),clock_timestamp())))
	and	((coalesce(cd_coordenador_p::text, '') = '') or (cd_coordenador = cd_coordenador_p))
	order by 1;

procedure update_tabela(ds_atributo_p text,
				dt_valor_p	timestamp,
				qt_valor_p	bigint,
				nr_seq_p	bigint) is

	;
BEGIN
	if (dt_valor_p IS NOT NULL AND dt_valor_p::text <> '') then
		ds_sql_w := ' update w_acomp_proj_html5 set ' || ds_atributo_p || ' = to_date(''' || dt_valor_p || ''',''dd/mm/yyyy hh24:mi:ss'')' || '  where nr_sequencia = '|| nr_seq_p;
	elsif (coalesce(qt_valor_p,0) <> 0) then
		ds_sql_w := ' update w_acomp_proj_html5 set ' || ds_atributo_p || ' = ' || qt_valor_p || '  where nr_sequencia = '|| nr_seq_p;
	end if;

	if ((trim(both ds_sql_w) IS NOT NULL AND (trim(both ds_sql_w))::text <> '')) then
		CALL Exec_sql_Dinamico_bv('',ds_sql_w,'');
	end if;

	end;


begin
select	count(*)
into STRICT	qt_reg_w
from	w_acomp_proj_html5
where	nm_usuario = nm_usuario_p;

if (qt_reg_w > 0) then
	delete from w_acomp_proj_html5
	where	nm_usuario = nm_usuario_p;

	commit;
end if;

open C10;
loop
fetch C10 into
	nr_seq_projeto_w;
EXIT WHEN NOT FOUND; /* apply on C10 */
	begin

	select	nextval('w_acomp_proj_html5_seq')
	into STRICT	nr_sequencia_w
	;


	insert into w_acomp_proj_html5(nr_sequencia,
			nm_usuario,
			nm_usuario_nrec,
			dt_atualizacao,
			dt_atualizacao_nrec)
	values (		nr_sequencia_w,
			nm_usuario_p,
			nm_usuario_p,
			clock_timestamp(),
			clock_timestamp());

	-- Projeto
	select	max(c.dt_inicio_prev),
		max(c.dt_fim_prev),
		max(c.dt_inicio_real),
		max(c.dt_fim_real)
	into STRICT	dt_inicio_prev_w,
		dt_fim_prev_w,
		dt_inicio_real_w,
		dt_fim_real_w
	from	proj_projeto a,
		proj_cronograma b,
		proj_cron_etapa c
	where	a.nr_sequencia = b.nr_seq_proj
	and	b.nr_sequencia = c.nr_seq_cronograma
	and	b.ie_situacao = 'A'
	and	coalesce(c.nr_seq_superior::text, '') = ''
	and	a.nr_sequencia = nr_seq_projeto_w;

	qt_horas_proj_w := trunc((coalesce(dt_fim_prev_w - dt_inicio_prev_w,0) - coalesce(dt_fim_real_w - dt_inicio_real_w,0)) * 7); -- 7 = horas de trabalho
	update_tabela('DT_INICIO_PREV_PROJ',dt_inicio_prev_w,null,nr_sequencia_w);
	update_tabela('DT_FIM_PREV_PROJ',dt_fim_prev_w,null,nr_sequencia_w);
	update_tabela('DT_INICIO_REAL_PROJ',dt_inicio_real_w,null,nr_sequencia_w);
	update_tabela('DT_FIM_REAL_PROJ',dt_fim_real_w,null,nr_sequencia_w);
	update_tabela('QT_HORAS_SALDO_PROJ',null,qt_horas_proj_w,nr_sequencia_w);


	-- Plan
	select	max(c.dt_inicio_prev),
		max(c.dt_fim_prev),
		max(c.dt_inicio_real),
		max(c.dt_fim_real)
	into STRICT	dt_inicio_prev_plan_w,
		dt_fim_prev_plan_w,
		dt_inicio_real_plan_w,
		dt_fim_real_plan_w
	from	proj_projeto a,
		proj_cronograma b,
		proj_cron_etapa c
	where	a.nr_sequencia = b.nr_seq_proj
	and	b.nr_sequencia = c.nr_seq_cronograma
	and	b.ie_situacao = 'A'
	and 	ds_atividade = 'Create Statement of Work'
	and	a.nr_sequencia = nr_seq_projeto_w;

	qt_horas_plan_w := trunc((coalesce(dt_fim_prev_plan_w - dt_inicio_prev_plan_w,0) - coalesce(dt_fim_real_plan_w - dt_inicio_real_plan_w,0)) * 7); -- 7 = horas de trabalho
	update_tabela('QT_HORAS_SALDO_PLAN',null,qt_horas_plan_w,nr_sequencia_w);


	-- Execução
	select	max(c.dt_inicio_prev),
		max(c.dt_fim_prev),
		max(c.dt_inicio_real),
		max(c.dt_fim_real)
	into STRICT	dt_inicio_prev_exec_w,
		dt_fim_prev_exec_w,
		dt_inicio_real_exec_w,
		dt_fim_real_exec_w
	from	proj_projeto a,
		proj_cronograma b,
		proj_cron_etapa c
	where	a.nr_sequencia = b.nr_seq_proj
	and	b.nr_sequencia = c.nr_seq_cronograma
	and	b.ie_situacao = 'A'
	and 	ds_atividade = 'Analyze of Analyst SOs'
	and	a.nr_sequencia = nr_seq_projeto_w;

	qt_horas_exec_w := trunc((coalesce(dt_fim_prev_exec_w - dt_inicio_prev_exec_w,0) - coalesce(dt_fim_real_exec_w - dt_inicio_real_exec_w,0)) * 7); -- 7 = horas de trabalho
	update_tabela('DT_INICIO_PREV_ANA',dt_inicio_prev_exec_w,null,nr_sequencia_w);
	update_tabela('DT_FIM_PREV_ANA',dt_fim_prev_exec_w,null,nr_sequencia_w);
	update_tabela('DT_INICIO_REAL_ANA',dt_inicio_real_exec_w,null,nr_sequencia_w);
	update_tabela('DT_FIM_REAL_ANA',dt_fim_real_exec_w,null,nr_sequencia_w);
	update_tabela('QT_HORAS_SALDO_ANA',null,qt_horas_exec_w,nr_sequencia_w);


	-- Aprovação gerente
	select	max(c.dt_inicio_prev),
		max(c.dt_inicio_real)
	into STRICT	dt_inicio_prev_aprov_w,
		dt_inicio_real_aprov_w
	from	proj_projeto a,
		proj_cronograma b,
		proj_cron_etapa c
	where	a.nr_sequencia = b.nr_seq_proj
	and	b.nr_sequencia = c.nr_seq_cronograma
	and	b.ie_situacao = 'A'
	and	ds_atividade = 'Approved to proceed (Manager Approval)'
	and	a.nr_sequencia = nr_seq_projeto_w;

	update_tabela('DT_APROV_GER_PREV',dt_inicio_prev_aprov_w,null,nr_sequencia_w);
	update_tabela('DT_APROV_GER_REAL',dt_inicio_real_aprov_w,null,nr_sequencia_w);


	-- Envio da Liberação para outros departamento  **VERIFICAR AINDA
	--update_tabela('DT_LIB_DEPART',dt_fim_real_exec_w,null,nr_sequencia_w);
	-- Prepare to Checkpoint
	select	max(c.dt_inicio_prev),
		max(c.dt_fim_prev),
		max(c.dt_inicio_real),
		max(c.dt_fim_real)
	into STRICT	dt_inicio_prev_prep_w,
		dt_fim_prev_prep_w,
		dt_inicio_real_prep_w,
		dt_fim_real_prep_w
	from	proj_projeto a,
		proj_cronograma b,
		proj_cron_etapa c
	where	a.nr_sequencia = b.nr_seq_proj
	and	b.nr_sequencia = c.nr_seq_cronograma
	and	b.ie_situacao = 'A'
	and	ds_atividade = 'Prepare to Checkpoint'
	and	a.nr_sequencia = nr_seq_projeto_w;

	qt_horas_prep_w := trunc((coalesce(dt_fim_prev_prep_w - dt_inicio_prev_prep_w,0) - coalesce(dt_fim_real_prep_w - dt_inicio_real_prep_w,0)) * 7); -- 7 = horas de trabalho
	update_tabela('DT_FIM_PREP_CP_PREV',dt_fim_prev_prep_w,null,nr_sequencia_w);
	update_tabela('DT_FIM_PREP_CP_REAL',dt_fim_real_prep_w,null,nr_sequencia_w);
	update_tabela('QT_HORAS_SALDO_PREP_CP',null,qt_horas_prep_w,nr_sequencia_w);


	-- Check Point Meeting
	select	max(c.dt_inicio_prev),
		max(c.dt_fim_prev),
		max(c.dt_inicio_real),
		max(c.dt_fim_real)
	into STRICT	dt_inicio_prev_meet_w,
		dt_fim_prev_meet_w,
		dt_inicio_real_meet_w,
		dt_fim_real_meet_w
	from	proj_projeto a,
		proj_cronograma b,
		proj_cron_etapa c
	where	a.nr_sequencia = b.nr_seq_proj
	and	b.nr_sequencia = c.nr_seq_cronograma
	and	b.ie_situacao = 'A'
	and	ds_atividade = 'Checkpoint Meeting (Analysis Phase Exit)'
	and	a.nr_sequencia = nr_seq_projeto_w;

	qt_horas_meet_w := trunc((coalesce(dt_fim_prev_meet_w - dt_inicio_prev_meet_w,0) - coalesce(dt_fim_real_meet_w - dt_inicio_real_meet_w,0)) * 7); -- 7 = horas de trabalho
	update_tabela('DT_INICIO_PREV_MEET',dt_inicio_prev_meet_w,null,nr_sequencia_w);
	update_tabela('DT_INICIO_REAL_MEET',dt_inicio_real_meet_w,null,nr_sequencia_w);
	update_tabela('QT_HORAS_SALDO_MEET',null,qt_horas_meet_w,nr_sequencia_w);


	-- bug fix
	select	max(c.dt_inicio_prev),
		max(c.dt_fim_prev),
		max(c.dt_inicio_real),
		max(c.dt_fim_real)
	into STRICT	dt_inicio_prev_bug_w,
		dt_fim_prev_bug_w,
		dt_inicio_real_bug_w,
		dt_fim_real_bug_w
	from	proj_projeto a,
		proj_cronograma b,
		proj_cron_etapa c
	where	a.nr_sequencia = b.nr_seq_proj
	and	b.nr_sequencia = c.nr_seq_cronograma
	and	b.ie_situacao = 'A'
	and	ds_atividade = 'Finilize the Check Point Actions'
	and	a.nr_sequencia = nr_seq_projeto_w;

	qt_horas_bug_w := trunc((coalesce(dt_fim_prev_bug_w - dt_inicio_prev_bug_w,0) - coalesce(dt_fim_real_bug_w - dt_inicio_real_bug_w,0)) * 7); -- 7 = horas de trabalho
	update_tabela('DT_FIM_PREV_BUGFIX',dt_fim_prev_bug_w,null,nr_sequencia_w);
	update_tabela('DT_FIM_REAL_BUGFIX',dt_fim_real_bug_w,null,nr_sequencia_w);
	update_tabela('QT_HORAS_SALDO_BUGFIX',null,qt_horas_bug_w,nr_sequencia_w);

	end;
end loop;
close C10;

commit;



end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_rel_proj_html5 ( dt_inic_prev_p timestamp, dt_fim_prev_p timestamp, dt_inic_real_p timestamp, dt_fim_real_p timestamp, cd_coordenador_p text, nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

