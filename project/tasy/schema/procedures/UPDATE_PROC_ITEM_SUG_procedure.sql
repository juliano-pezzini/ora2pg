-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE update_proc_item_sug (nr_seq_proc_interno_p bigint, nr_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

												  
qt_register_w         integer;

c01 CURSOR FOR
SELECT    *
from      proc_int_nec_item
where     nr_seq_proc_interno = nr_seq_proc_interno_p
and       cd_departamento = obter_departamento_atual_atend(nr_atendimento_p)
or        coalesce(cd_departamento::text, '') = ''
and       ie_situacao = 'A'
order by  nr_seq_proc_interno;

c01_w c01%rowtype;		


BEGIN

open c01;

loop

fetch c01 into	

	c01_w;

EXIT WHEN NOT FOUND; /* apply on c01 */

	begin
	
	select	count(1)
	into STRICT	qt_register_w
	from	prescr_proc_item_sug
	where	nr_atendimento = nr_atendimento_p
	and		nr_seq_proc_interno = nr_seq_proc_interno_p;
	
	if (qt_register_w = 0)then
	
		insert	into prescr_proc_item_sug(nr_sequencia,
		  dt_atualizacao,
		  nm_usuario,
		  dt_atualizacao_nrec,
		  nm_usuario_nrec,
		  cd_unidade_medida,
		  qt_dose,
		  cd_intervalo,
		  nr_seq_proc_interno,
		  ie_via_aplicacao,
		  cd_material,
		  nr_atendimento,
      si_status) 
		values (nextval('prescr_proc_item_sug_seq'), 
		  clock_timestamp(),     
		  nm_usuario_p,
		  clock_timestamp(),        
		  nm_usuario_p,
		  c01_w.cd_unidade_medida,
		  c01_w.qt_dose,
		  null,
		  c01_w.nr_seq_proc_interno,
		  null,
		  c01_w.cd_material,
		  nr_atendimento_p,
      c01_w.si_status);


	end if;

end;

end loop;

close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE update_proc_item_sug (nr_seq_proc_interno_p bigint, nr_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

