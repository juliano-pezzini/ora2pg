-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE upt_entrega_prescr_atend_adic ( nr_atendimento_p bigint, ds_lista_atend_p text) AS $body$
DECLARE

 
dt_entrega_atend_w  timestamp;
dt_entrega_atend_lista_w timestamp;
dt_maior_entrega_w  timestamp;
C01 CURSOR FOR
SELECT nr_atend_adicional
from entrega_laudo_atend
where nr_atend_origem = nr_atendimento_p;

BEGIN

/* Pega a maior data do atendimento principal */

  
  select max(dt_entrega) dt_entrega
  into STRICT dt_entrega_atend_w
  from prescr_medica
  where  nr_atendimento = nr_atendimento_p
  and  (dt_entrega IS NOT NULL AND dt_entrega::text <> '');

  /* abre cursor dos atendimentos adicionais*/

  for c01_w in C01 loop

    select max(dt_entrega) dt_entrega
    into STRICT dt_entrega_atend_lista_w
    from prescr_medica
    where  nr_atendimento = c01_w.nr_atend_adicional
    and  (dt_entrega IS NOT NULL AND dt_entrega::text <> '');

    /* Com isso, obtemos a maior data de todas*/

    if (dt_entrega_atend_lista_w > dt_entrega_atend_w) then
      dt_entrega_atend_w := dt_entrega_atend_lista_w;
    end if;

  end loop;


  if (dt_entrega_atend_w IS NOT NULL AND dt_entrega_atend_w::text <> '') then

    /* atualiza atendimento principal */

    update prescr_medica
    set dt_entrega = dt_entrega_atend_w
    where  nr_atendimento = nr_atendimento_p;

    for c01_w in C01 loop
      /* atualiza atendimentos adicionais */

      update prescr_medica
      set dt_entrega = dt_entrega_atend_w
      where  nr_atendimento = c01_w.nr_atend_adicional;

    end loop;

  end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE upt_entrega_prescr_atend_adic ( nr_atendimento_p bigint, ds_lista_atend_p text) FROM PUBLIC;

