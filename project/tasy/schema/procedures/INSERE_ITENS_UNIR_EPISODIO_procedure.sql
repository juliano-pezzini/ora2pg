-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insere_itens_unir_episodio ( NR_SEQ_EPISODIOS_ORIGEM_P text , NR_SEQ_EPISODIO_DESTINO_P bigint ) AS $body$
DECLARE


  TRANSFERENCIA_EPISODIO_SEQ_W bigint;
  TRANSF_EPISODIO_ITEM_SEQ_W bigint;
  NR_SEQ_EPISODIO_ORIGEM_c01_W bigint;WITH RECURSIVE cte AS (


  -- CURSOR COM OS NR_SEQ_EPISODIO.
  c01 CURSOR FOR
    SELECT regexp_substr(info, separador, 1, 1) info
    FROM (SELECT NR_SEQ_EPISODIOS_ORIGEM_P info, '[^,]+' separador )
    (regexp_substr(info, separador, 1, LEVEL) IS NOT NULL AND (regexp_substr(info, separador, 1, LEVEL))::text <> '')  UNION ALL


  
  c01 CURSOR FOR
    SELECT regexp_substr(info, separador, 1, (c.level+1)) info
    FROM (SELECT NR_SEQ_EPISODIOS_ORIGEM_P info, '[^,]+' separador ) JOIN cte c ON ()

) SELECT * FROM cte;
;

  REC RECORD;

BEGIN

  OPEN c01;
  LOOP
    FETCH c01 INTO NR_SEQ_EPISODIO_ORIGEM_c01_W;
    EXIT WHEN NOT FOUND; /* apply on c01 */
    BEGIN

      select     nextval('transferencia_episodio_seq') into STRICT TRANSFERENCIA_EPISODIO_SEQ_W;

      INSERT
      INTO TRANSFERENCIA_EPISODIO(
          NR_SEQUENCIA ,
          DT_ATUALIZACAO ,
          NM_USUARIO ,
          DT_ATUALIZACAO_NREC ,
          NM_USUARIO_NREC ,
          NR_SEQ_EPISODIO
        )
        VALUES (
          TRANSFERENCIA_EPISODIO_SEQ_W,
          clock_timestamp() ,
          Obter_Usuario_Ativo ,
          clock_timestamp() ,
          Obter_Usuario_Ativo ,
          NR_SEQ_EPISODIO_DESTINO_P --armazenamos em qual episodio os outros foram transferidos,
        );

      FOR REC IN (SELECT NR_ATENDIMENTO FROM ATENDIMENTO_PACIENTE WHERE NR_SEQ_EPISODIO = NR_SEQ_EPISODIO_ORIGEM_c01_W)
      LOOP

          select nextval('transf_episodio_item_seq') into STRICT TRANSF_EPISODIO_ITEM_SEQ_W;

        INSERT
        INTO TRANSF_EPISODIO_ITEM(
            NR_SEQUENCIA ,
            DT_ATUALIZACAO ,
            NM_USUARIO ,
            DT_ATUALIZACAO_NREC ,
            NM_USUARIO_NREC ,
            NR_SEQ_TRANSFERENCIA ,
            NR_SEQ_EPISODIO_ORIGEM ,
            NR_ATENDIMENTO
          )
          VALUES (
            TRANSF_EPISODIO_ITEM_SEQ_W,
            clock_timestamp() ,
            Obter_Usuario_Ativo ,
            clock_timestamp() ,
            Obter_Usuario_Ativo ,
            TRANSFERENCIA_EPISODIO_SEQ_W ,
            NR_SEQ_EPISODIO_ORIGEM_c01_W ,
            REC.NR_ATENDIMENTO
          );

      END LOOP;

    END;

  END LOOP;
  CLOSE c01;

  COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insere_itens_unir_episodio ( NR_SEQ_EPISODIOS_ORIGEM_P text , NR_SEQ_EPISODIO_DESTINO_P bigint ) FROM PUBLIC;

