-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE same_inserir_pendencia (nr_seq_prontuario_p bigint, cd_barras_p text, ie_assinatura_p text, ie_existe_tasy_p text, nr_seq_tipo_documento_p bigint, nr_documento_p bigint, ie_documentacao_p text, cd_responsavel_p text, ie_situacao_doc_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_sequencia_w			bigint;
qt_pendencia_existe_tasy_w	bigint;
qt_pendencia_assinatura_w	bigint;

ie_pendencia_existe_tasy_w	varchar(1);
ie_pendencia_assinatura_w	varchar(1);



BEGIN

if (nr_seq_tipo_documento_p IS NOT NULL AND nr_seq_tipo_documento_p::text <> '') and (nr_documento_p IS NOT NULL AND nr_documento_p::text <> '') then

	select	nextval('same_controle_prontuario_seq')
	into STRICT	nr_sequencia_w
	;

	select	max(a.ie_exige_registro),
		max(a.ie_exige_assinatura)
	into STRICT	ie_pendencia_existe_tasy_w,
		ie_pendencia_assinatura_w
	from	same_tipo_documento a
	where	a.nr_sequencia = nr_seq_tipo_documento_p;

	insert into same_controle_prontuario(
					nr_sequencia,
					nr_seq_tipo_documento,
					nr_seq_prontuario,
					nr_documento,
					cd_barras,
					nm_usuario_nrec,
					nm_usuario,
					ie_situacao,
					ie_documentacao,
					dt_registro,
					dt_atualizacao_nrec,
					dt_atualizacao,
					cd_responsavel,
					cd_estabelecimento)
			values (nr_sequencia_w,
					nr_seq_tipo_documento_p,
					nr_seq_prontuario_p,
					nr_documento_p,
					cd_barras_p,
					nm_usuario_p,
					nm_usuario_p,
					'A',
					ie_documentacao_p,
					clock_timestamp(),
					clock_timestamp(),
					clock_timestamp(),
					cd_responsavel_p,
					cd_Estabelecimento_p);

	--Falta Assinatura
	select	count(*)
	into STRICT	qt_pendencia_assinatura_w
	from	same_pendencia
	where	ie_tipo_pendencia = 'A';

	if (ie_assinatura_p = 'N') and (qt_pendencia_assinatura_w > 0) and (ie_pendencia_assinatura_w = 'S') then

		insert into same_pendencia_prontuario(	nr_sequencia,
							nr_seq_controle,
							nr_seq_pendencia,
							nm_usuario,
							nm_usuario_nrec,
							dt_atualizacao,
							dt_atualizacao_nrec,
							ie_situacao_doc)
						SELECT	nextval('same_pendencia_prontuario_seq'),
							nr_sequencia_w,
							nr_sequencia,
							nm_usuario_p,
							nm_usuario_p,
							clock_timestamp(),
							clock_timestamp(),
							ie_situacao_doc_p
						from	same_pendencia
						where	ie_tipo_pendencia = 'A'
						and	ie_situacao = 'A';
	end if;

	--Falta registro no Tasy
	select	count(*)
	into STRICT	qt_pendencia_existe_tasy_w
	from	same_pendencia
	where	ie_tipo_pendencia = 'R';

	if (ie_existe_tasy_p = 'N') and (qt_pendencia_assinatura_w > 0) and (ie_pendencia_existe_tasy_w = 'S')  then

		insert into same_pendencia_prontuario(	nr_sequencia,
							nr_seq_controle,
							nr_seq_pendencia,
							nm_usuario,
							nm_usuario_nrec,
							dt_atualizacao,
							dt_atualizacao_nrec,
							ie_situacao_doc)
						SELECT	nextval('same_pendencia_prontuario_seq'),
							nr_sequencia_w,
							nr_sequencia,
							nm_usuario_p,
							nm_usuario_p,
							clock_timestamp(),
							clock_timestamp(),
							ie_situacao_doc_p
						from	same_pendencia
						where	ie_tipo_pendencia = 'R'
						and	ie_situacao = 'A';
	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE same_inserir_pendencia (nr_seq_prontuario_p bigint, cd_barras_p text, ie_assinatura_p text, ie_existe_tasy_p text, nr_seq_tipo_documento_p bigint, nr_documento_p bigint, ie_documentacao_p text, cd_responsavel_p text, ie_situacao_doc_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

