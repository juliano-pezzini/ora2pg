-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_consulta_reg_mentor ( nm_usuario_p text, nm_tabela_origem_p text default null, nr_seq_pend_regra_p bigint DEFAULT NULL, nr_seq_origem_p bigint DEFAULT NULL, nr_seq_pend_pac_p bigint DEFAULT NULL, vl_atributo_p text default null, nm_atributo_p text default null, ds_unid_medida_p text default null, nr_prescricao_p bigint default null, nr_pend_prot_assist_p bigint default null) AS $body$
DECLARE


C01 CURSOR FOR
	SELECT distinct
	nm_tabela_origem,
	ds_valor,
	nr_sequencia_origem,
	ds_campo,
	ds_unid_medida,
	nr_prescricao,
	ds_titulo,
	nr_seq_regra,
	nr_seq_pend_pac
	from CONSULTA_REG_MENTOR where NR_SEQ_PEND_PAC in (
	  SELECT max(a.NR_SEQUENCIA)
	  from gqa_pendencia_pac a
	  where a.NR_SEQ_PEND_REGRA in (
		select NR_SEQ_REGRA_GQA 
		from PROTOCOLO_ASSIST_ITEM d
		where d.NR_SEQ_PROTOCOLO = nr_pend_prot_assist_p
	  )
	  group by a.NR_SEQ_PEND_REGRA
	);
	
ds_titulo_w			varchar(10000);
nr_seq_pend_pac_assoc_w		bigint;


BEGIN
if (coalesce(nm_tabela_origem_p::text, '') = '' and nr_seq_origem_p = 4) then
begin
	for regras in C01
	loop
		select max(nr_seq_pend_pac_assoc)
		into STRICT   nr_seq_pend_pac_assoc_w
		from   consulta_reg_mentor
		where  nr_seq_pend_pac = regras.nr_seq_pend_pac;
		
		if (coalesce(nr_seq_pend_pac_assoc_w::text, '') = '') then
			update consulta_reg_mentor
			set nr_seq_pend_pac_assoc = nr_seq_pend_pac_p
			where nr_seq_pend_pac = regras.nr_seq_pend_pac;
		else
			insert into consulta_reg_mentor(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_regra,
				nm_tabela_origem,
				ds_valor,
				nr_sequencia_origem,
				ds_campo,
				ds_unid_medida,
				ds_titulo,
				nr_prescricao,
				nr_seq_pend_pac,
				nr_seq_pend_pac_assoc)
			values (	nextval('consulta_reg_mentor_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				regras.nr_seq_regra,
				regras.nm_tabela_origem,
				regras.ds_valor,
				regras.nr_sequencia_origem,
				regras.ds_campo,
				regras.ds_unid_medida,
				regras.ds_titulo,
				regras.nr_prescricao,
				regras.nr_seq_pend_pac,
				nr_seq_pend_pac_p);
			commit;
		end if;		
	end loop;
end;

else
begin
	select ds_regra
	into STRICT   ds_titulo_w
	from   GQA_PENDENCIA_REGRA
	where  nr_sequencia = nr_seq_pend_regra_p;

	insert into consulta_reg_mentor(	nr_sequencia,
										dt_atualizacao,
										nm_usuario,
										dt_atualizacao_nrec,
										nm_usuario_nrec,
										nr_seq_regra,
										nm_tabela_origem,
										ds_valor,
										nr_sequencia_origem,
										ds_campo,
										ds_unid_medida,
										ds_titulo,
										nr_prescricao,
										nr_seq_pend_pac)
	values (	nextval('consulta_reg_mentor_seq'),
										clock_timestamp(),
										nm_usuario_p,
										clock_timestamp(),
										nm_usuario_p,
										nr_seq_pend_regra_p,
										nm_tabela_origem_p,
										vl_atributo_p,
										nr_seq_origem_p,
										nm_atributo_p,
										ds_unid_medida_p,
										ds_titulo_w,
										nr_prescricao_p,
										nr_seq_pend_pac_p);
	commit;
end;							
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_consulta_reg_mentor ( nm_usuario_p text, nm_tabela_origem_p text default null, nr_seq_pend_regra_p bigint DEFAULT NULL, nr_seq_origem_p bigint DEFAULT NULL, nr_seq_pend_pac_p bigint DEFAULT NULL, vl_atributo_p text default null, nm_atributo_p text default null, ds_unid_medida_p text default null, nr_prescricao_p bigint default null, nr_pend_prot_assist_p bigint default null) FROM PUBLIC;

