-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desdobrar_lote_fornec (nr_sequencia_p bigint, qt_material_p bigint, cd_local_estoque_p bigint, ie_calculo_validade_p text, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_lote_p INOUT bigint) AS $body$
DECLARE


nr_seq_lote_w			bigint;	

nr_seq_lote_origem_w		bigint;
dt_validade_origem_w		timestamp;
cd_material_w			integer;

cd_operacao_entrada_w		smallint;
cd_operacao_saida_w		smallint;
			
qt_material_w			double precision;

dt_validade_w			timestamp;

cd_cgc_fornec_w			varchar(14);
ds_lote_fornec_w		varchar(20);
ie_validade_indeterminada_w	varchar(1);
nr_digito_verif_w		smallint;

nr_sequencia_w			bigint;
cd_unidade_medida_w		varchar(30);
cd_unidade_medida_estoque_w	varchar(30);

cd_conta_contabil_w		varchar(20);
cd_centro_custo_w		integer;
cd_setor_atendimento_w		integer := obter_Setor_ativo;
cd_local_estoque_w		smallint;
nm_computador_w			varchar(80);
nr_seq_computador_w		bigint;
qt_estoque_lote_w		double precision;
nr_item_nf_w			integer;
nr_lote_producao_w		bigint;
nr_nota_fiscal_w		varchar(255);
nr_sequencia_nf_w		bigint;


BEGIN
nr_seq_lote_origem_w := nr_sequencia_p;

qt_estoque_lote_w := obter_saldo_lote_fornec(nr_seq_lote_origem_w);
	
if (qt_estoque_lote_w < qt_material_p) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(190984);
end if;

nm_computador_w		:= upper(substr(wheb_usuario_pck.get_nm_estacao,1,80));
cd_local_estoque_w	:= coalesce(cd_local_estoque_p,0);

if (cd_local_estoque_w = 0) then
	begin
	begin
	select	nr_sequencia,
		cd_setor_atendimento
	into STRICT	nr_seq_computador_w,
		cd_setor_atendimento_w
	from	COMPUTADOR
	where	nm_computador_pesquisa  = padronizar_nome(upper(nm_computador_w));
	exception
	when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(184568,'NM_COMPUTADOR='||nm_computador_w);
	end;	

	select	coalesce(max(cd_local_estoque),0)
	into STRICT	cd_local_estoque_w
	from   	local_estoque_computador
	where  	nr_seq_computador = nr_seq_computador_w;

	if (cd_local_estoque_w = 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(184569,'NM_COMPUTADOR='||nm_computador_w);
	end if;
	end;
end if;

select	cd_material,
	dt_validade,
	ie_validade_indeterminada,
	cd_cgc_fornec,
	ds_lote_fornec,
	nr_item_nf,
	nr_lote_producao,
	nr_nota_fiscal,
	nr_sequencia_nf
into STRICT	cd_material_w,
	dt_validade_origem_w,
	ie_validade_indeterminada_w,
	cd_cgc_fornec_w,
	ds_lote_fornec_w,
	nr_item_nf_w,
	nr_lote_producao_w,
	nr_nota_fiscal_w,
	nr_sequencia_nf_w
from	material_lote_fornec
where	nr_sequencia = nr_seq_lote_origem_w;

select	cd_unidade_medida_estoque
into STRICT	cd_unidade_medida_estoque_w
from	material
where	cd_material = cd_material_w;

cd_operacao_entrada_w := sup_verifica_cria_operacao(cd_estabelecimento_p, 11, nm_usuario_p, cd_operacao_entrada_w);
cd_operacao_saida_w := sup_verifica_cria_operacao(cd_estabelecimento_p, 12, nm_usuario_p, cd_operacao_saida_w);
	
if (ie_calculo_validade_p = 'S') and (dt_validade_origem_w IS NOT NULL AND dt_validade_origem_w::text <> '') then
	dt_validade_w := obter_val_lote_prod(cd_estabelecimento_p, cd_material_w, dt_validade_origem_w);
else
	dt_validade_w := dt_validade_origem_w;
end if;

select	nextval('material_lote_fornec_seq')
into STRICT	nr_seq_lote_w
;

nr_digito_verif_w	:= calcula_digito('MODULO11',nr_seq_lote_w);

insert into material_lote_fornec(
	nr_sequencia,
	cd_material,
	nr_digito_verif,
	dt_atualizacao,
	nm_usuario,
	ds_lote_fornec,
	dt_validade,
	cd_cgc_fornec,
	qt_material,
	cd_estabelecimento,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_seq_marca,
	ie_origem_lote,
	ie_validade_indeterminada,
	ie_situacao,
	ie_bloqueio,
	ds_observacao,
	dt_validade_original,
	dt_fabricacao,
	ds_localizacao,
	nr_seq_local,
	nr_item_nf,
	nr_lote_producao,
	nr_nota_fiscal,
	nr_sequencia_nf)
SELECT	nr_seq_lote_w,
	cd_material,
	calcula_digito('Modulo11', nr_seq_lote_w),
	clock_timestamp(),
	nm_usuario_p,
	ds_lote_fornec,
	dt_validade_w,
	cd_cgc_fornec,
	qt_material_p,
	cd_estabelecimento,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_marca,
	'D',
	ie_validade_indeterminada,
	'A',
	'N',
	ds_observacao,
	dt_validade_origem_w,
	dt_fabricacao,
	ds_localizacao,
	nr_seq_local,
	nr_item_nf_w,
	nr_lote_producao_w,
	nr_nota_fiscal_w,
	nr_sequencia_nf_w
from	material_lote_fornec
where	nr_sequencia = nr_sequencia_p;

update	material_lote_fornec
set	qt_material = qt_material - qt_material_p
where	nr_sequencia = nr_sequencia_p;

insert into material_lote_fornec_nf(
	nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_seq_lote_fornec,
	nr_sequencia_nf,
	nr_item_nf)
SELECT	nextval('material_lote_fornec_nf_seq'),
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_lote_w,
	nr_sequencia_nf,
	nr_item_nf
from	material_lote_fornec_nf
where	nr_seq_lote_fornec = nr_sequencia_p;
	
insert into movimento_estoque(
	nr_movimento_estoque,
	cd_estabelecimento,
	cd_local_estoque,
	dt_movimento_estoque,
	cd_operacao_estoque,
	cd_acao,
	cd_material,
	dt_mesano_referencia,
	qt_movimento,
	dt_atualizacao,
	nm_usuario,
	ie_origem_documento,
	nr_documento,
	nr_sequencia_item_docto,
	cd_unidade_medida_estoque,
	cd_setor_atendimento,
	qt_estoque,
	cd_centro_custo,
	cd_unidade_med_mov,
	cd_fornecedor,
	nr_seq_tab_orig,
	nr_seq_lote_fornec,
	cd_lote_fabricacao,
	dt_validade,		
	cd_conta_contabil)
values (	nextval('movimento_estoque_seq'),
	cd_estabelecimento_p,
	cd_local_estoque_w,
	clock_timestamp(),
	cd_operacao_saida_w,
	'1',
	cd_material_w,
	clock_timestamp(),
	qt_material_p,
	clock_timestamp(),
	nm_usuario_p,
	'18',
	null,
	null,
	cd_unidade_medida_estoque_w,
	cd_setor_atendimento_w,
	qt_material_p,
	null,
	cd_unidade_medida_estoque_w,
	null,
	null,
	nr_sequencia_p,
	ds_lote_fornec_w,
	dt_validade_origem_w,
	null);
	
insert into movimento_estoque(
	nr_movimento_estoque,
	cd_estabelecimento,
	cd_local_estoque,
	dt_movimento_estoque,
	cd_operacao_estoque,
	cd_acao,
	cd_material,
	dt_mesano_referencia,
	qt_movimento,
	dt_atualizacao,
	nm_usuario,
	ie_origem_documento,
	nr_documento,
	nr_sequencia_item_docto,
	cd_unidade_medida_estoque,
	cd_setor_atendimento,
	qt_estoque,
	cd_centro_custo,
	cd_unidade_med_mov,
	cd_fornecedor,
	nr_seq_tab_orig,
	nr_seq_lote_fornec,
	cd_lote_fabricacao,
	dt_validade,		
	cd_conta_contabil)
values (	nextval('movimento_estoque_seq'),
	cd_estabelecimento_p,
	cd_local_estoque_w,
	clock_timestamp(),
	cd_operacao_entrada_w,
	'1',
	cd_material_w,
	clock_timestamp(),
	qt_material_p,
	clock_timestamp(),
	nm_usuario_p,
	'18',
	null,
	null,
	cd_unidade_medida_estoque_w,
	cd_setor_atendimento_w,
	qt_material_p,
	null,
	cd_unidade_medida_estoque_w,
	null,
	null,
	nr_seq_lote_w,
	ds_lote_fornec_w,
	dt_validade_w,
	null);

commit;

nr_seq_lote_p := nr_seq_lote_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desdobrar_lote_fornec (nr_sequencia_p bigint, qt_material_p bigint, cd_local_estoque_p bigint, ie_calculo_validade_p text, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_lote_p INOUT bigint) FROM PUBLIC;

