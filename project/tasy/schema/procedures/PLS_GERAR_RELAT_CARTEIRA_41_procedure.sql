-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE registro_titular AS (nr_seq_titular_ww bigint, ie_linha_ww bigint);


CREATE OR REPLACE PROCEDURE pls_gerar_relat_carteira_41 ( nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_linha_w		bigint;
nr_coluna_w		bigint;
nr_seq_segurado_w	bigint;
nr_seq_titular_w	bigint;
ds_endereco_w		varchar(4000);
nr_seq_benef_interno_w	bigint;
------------------------------------------------------------ 
nr_vetor_w		bigint;
ie_linha_reg_w		bigint;
type vetor is table of registro_titular index by integer;
vetor_w				vetor;

 
C01 CURSOR FOR 
	SELECT	CASE WHEN coalesce(nr_seq_titular::text, '') = '' THEN nr_seq_segurado  ELSE nr_seq_titular END , 
		row_number() OVER () AS rownum 
	from	pls_carteira_emissao_corresp_v 
	where	nr_seq_lote	= nr_seq_lote_p;

C02 CURSOR FOR 
	SELECT	CASE WHEN coalesce(nr_seq_titular::text, '') = '' THEN nr_seq_segurado  ELSE nr_seq_titular END , 
		nr_seq_titular 
	from	pls_carteira_emissao_corresp_v 
	where	nr_seq_lote	= nr_seq_lote_p;

BEGIN 
nr_linha_w	:= 1;
nr_coluna_w	:= 0;
 
delete	from	w_pls_relat_carteira;
 
open C01;
loop 
fetch C01 into	 
	nr_seq_segurado_w, 
	ie_linha_reg_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	nr_vetor_w	:= vetor_w.count+1;
	vetor_w[nr_vetor_w].nr_seq_titular_ww	:= nr_seq_segurado_w;
	vetor_w[nr_vetor_w].ie_linha_ww		:= ie_linha_reg_w;
	 
	end;
end loop;
close C01;
 
open C02;
loop 
fetch C02 into	 
	nr_seq_segurado_w, 
	nr_seq_titular_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin 
	 
	nr_coluna_w	:= nr_coluna_w + 1;
	nr_seq_benef_interno_w	:= 0;
	 
	for i in 1..vetor_w.count loop 
		if (vetor_w[i].nr_seq_titular_ww = nr_seq_segurado_w) then 
			nr_seq_benef_interno_w	:= vetor_w[i].ie_linha_ww;
			exit;
		end if;
	end loop;
	 
	ds_endereco_w	:= pls_obter_enderec_corresp(nr_seq_segurado_w) ||'                  ' || to_char(nr_seq_benef_interno_w);
	 
	insert	into	w_pls_relat_carteira(	nr_sequencia, dt_atualizacao, nm_usuario, 
			dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_segurado, 
			nr_linha, nr_coluna, nr_seq_titular,ds_endereco,nr_seq_benef_interno) 
		values (	nextval('w_pls_relat_carteira_seq'), clock_timestamp(), nm_usuario_p, 
			clock_timestamp(), nm_usuario_p, nr_seq_segurado_w, 
			nr_linha_w, nr_coluna_w, nr_seq_titular_w,ds_endereco_w,nr_seq_benef_interno_w);
	 
	if (nr_coluna_w = 3) then 
		nr_coluna_w	:= 0;
		nr_linha_w	:= nr_linha_w + 1;
	end if;
	end;
end loop;
close C02;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_relat_carteira_41 ( nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

