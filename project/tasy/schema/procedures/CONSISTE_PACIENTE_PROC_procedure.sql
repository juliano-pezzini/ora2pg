-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_paciente_proc ( nr_seq_proc_interno_p bigint, NR_ATENDIMENTO_P bigint, CD_PESSOA_FISICA_P text, CD_PROCEDIMENTO_P bigint, IE_ORIGEM_PROCED_P bigint, DS_ERRO_P INOUT text) AS $body$
DECLARE


ie_sexo_w				varchar(1)		:= 'M';
qt_idade_minima_w			integer		:= 0;
qt_idade_maxima_w			integer		:= 0;
ie_sexo_pac_w			varchar(1)		:= 'M';
qt_idade_Pac_w			integer		:= 0;
ds_erro_w				varchar(255);
ie_autorizacao_w			smallint		:= 0;


BEGIN
ds_erro_w				:= '';

/*    Procedimento não cadastrado */

begin
select 	ie_sexo_sus,
		qt_idade_minima_sus,
		qt_idade_maxima_sus
into STRICT		ie_sexo_w,
		qt_idade_minima_w,
		qt_idade_maxima_w
from Procedimento
where cd_procedimento 	= cd_procedimento_p
  and ie_origem_proced 	= ie_origem_proced_p;
exception
	when others then
		ds_erro_w	:= ds_erro_w ||'401'||'('||to_char(cd_procedimento_p)||') ';
end;

select	coalesce(max(ie_sexo), ie_sexo_w)
into STRICT	ie_sexo_w
from	proc_interno
where	nr_sequencia		= nr_seq_proc_interno_p;


/*    Obter dados Paciente */

begin
select 	ie_sexo,
		obter_idade(dt_nascimento,clock_timestamp(),'A')
into STRICT		ie_sexo_Pac_w,
		qt_idade_Pac_w
from Pessoa_Fisica
where cd_pessoa_fisica	= cd_pessoa_fisica_p;
exception
	when others then
		--r.aise_application_error(-20011,'Pessoa física não encontrada ! Código: "' || CD_PESSOA_FISICA_P|| '".');
		CALL wheb_mensagem_pck.exibir_mensagem_abort(263286,'CD_PESSOA_FISICA_P='||CD_PESSOA_FISICA_P);
end;



/*    Consistencias AIH */

if (ie_origem_proced_p = 2) then
	begin
	if (ie_sexo_w IS NOT NULL AND ie_sexo_w::text <> '') and (ie_sexo_w <> ie_sexo_pac_w) then
		ds_erro_w	:= ds_erro_w ||'402'||'('||to_char(cd_procedimento_p)||') ';
	end if;

	if (qt_idade_pac_w > 0) and (qt_idade_maxima_w > 0) and
		((qt_idade_pac_w < qt_idade_minima_w) or (qt_idade_pac_w > qt_idade_maxima_w)) then
		if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
			select coalesce(max(ie_autorizacao_gestor),0)
			into STRICT ie_autorizacao_w
			from sus_aih
			where nr_atendimento = nr_atendimento_p
			  and (dt_autorizacao_gestor IS NOT NULL AND dt_autorizacao_gestor::text <> '');
		end if;
		if	(qt_idade_pac_w < qt_idade_minima_w AND ie_autorizacao_w <> 2) or
			(qt_idade_pac_w > qt_idade_maxima_w AND ie_autorizacao_w <> 3) or (ie_autorizacao_w not in (2,3)) then
			ds_erro_w	:= ds_erro_w ||'403'||'('||to_char(cd_procedimento_p)||') ';
		end if;
	end if;
	end;


/*    Consistencias BPA */

elsif (ie_origem_proced_p = 3) then
	begin
    	select	min(b.qt_idade_minima),
			max(b.qt_idade_maxima)
	into STRICT		qt_idade_minima_w,
			qt_idade_maxima_w
      from 	sus_faixa_etaria_bpa b,
		sus_proc_faixa_etaria a
      where a.cd_faixa_etaria = b.cd_faixa_etaria
        and a.cd_procedimento = cd_procedimento_p
        and a.ie_origem_proced = ie_origem_proced_p;

	if (qt_idade_pac_w > 0) and (qt_idade_maxima_w > 0) and
		((qt_idade_pac_w < qt_idade_minima_w) or (qt_idade_pac_w > qt_idade_maxima_w)) then
		ds_erro_w	:= ds_erro_w ||'403'||'('||to_char(cd_procedimento_p)||') ';
	end if;
	end;
end if;

ds_erro_p	:= ds_erro_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_paciente_proc ( nr_seq_proc_interno_p bigint, NR_ATENDIMENTO_P bigint, CD_PESSOA_FISICA_P text, CD_PROCEDIMENTO_P bigint, IE_ORIGEM_PROCED_P bigint, DS_ERRO_P INOUT text) FROM PUBLIC;

