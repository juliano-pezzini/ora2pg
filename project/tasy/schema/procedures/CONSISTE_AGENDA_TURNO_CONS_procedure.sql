-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_agenda_turno_cons ((cd_agenda_p bigint, ie_dia_semana_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, hr_inicial_p timestamp, hr_final_p timestamp, nr_seq_sala_p bigint, ie_consiste_horario_p text, nm_usuario_p text, ds_erro_p out text, nr_seq_turno_p bigint, ie_frequencia_p text default null, ie_semana_p bigint default 0) is ds_erro_w varchar(4000) DEFAULT '') AS $body$
DECLARE

	
	nr_dia_semana_w		bigint;
	dt_vig_dia_sem_w	timestamp;
	
	
  c RECORD;

BEGIN
		nr_dia_semana_w	:= obter_cod_dia_semana(dt_ini_p);
		dt_vig_dia_sem_w := dt_ini_p;
		
		if (ie_dia_Sem_p <> nr_dia_semana_w) then
			while(ie_dia_Sem_p <> nr_dia_semana_w) loop
				
				dt_vig_dia_sem_w := dt_vig_dia_sem_w +1;
				nr_dia_semana_w := obter_cod_dia_semana(dt_vig_dia_sem_w);
			
			end loop;
		else
			dt_vig_dia_sem_w := dt_ini_p;
		end if;
		
		return;
		
	end;
	
begin

/* Rafael em 22/09/2006 OS40064 -> Somente ira consistir horarios quando o parametro[119] da agenda de consultas estiver definido como 'SIM' */

select	coalesce(max(obter_valor_param_usuario(821, 119, obter_perfil_ativo, nm_usuario_p, 0)),'S'),
		coalesce(max(obter_valor_param_usuario(821, 302, obter_perfil_ativo, nm_usuario_p, 0)),'S'),
		coalesce(max(obter_valor_param_usuario(821, 464, obter_perfil_ativo, nm_usuario_p, 0)),'S')
into STRICT	ie_consistir_horario_w,
		ie_consiste_sala_w,
		ie_consiste_medico_w
;

select	max(cd_pessoa_fisica)
into STRICT	cd_medico_w
from	agenda
where	cd_agenda	= cd_agenda_p;

dt_inicial_w	:= dt_inicial_p;
dt_final_w		:= dt_final_p;

if (to_char(dt_inicial_p,'ddmmyyyy hh24mi') <> to_char(clock_timestamp(),'ddmmyyyy hh24mi')) then
	dt_ini_lib_w := dt_inicial_p;
end if;

if (to_char(dt_final_p,'ddmmyyyy hh24mi') <> to_char(clock_timestamp(),'ddmmyyyy hh24mi')) then
	dt_fim_lib_w := dt_final_p;
end if;

if (to_char(dt_final_w, 'dd/mm/yyyy') = to_char(clock_timestamp(), 'dd/mm/yyyy'))then
	dt_final_w	:= null;
end if;

if (ie_consiste_sala_w = 'S') and (nr_seq_sala_p > 0) and (coalesce(ie_frequencia_w,'D') = 'D') then

	select 	count(*)
	into STRICT	qt_regra_bloq_sala_w
	from	AGECONS_REGRA_TURNO_SALA art
	where 	coalesce(ie_situacao, 'A') = 'A';

	if (qt_regra_bloq_sala_w > 0) then

		select max(qt_lib_sala) qt_lib_sala
		 into STRICT ie_verifica_lib_bloq_w from (
				 SELECT COUNT(1) qt_lib_sala
			  FROM AGENDA_TURNO AGT,
				   AGENDA_BLOQUEIO AB,
				   AGECONS_REGRA_TURNO_SALA ATS
			 WHERE AGT.CD_AGENDA = AB.CD_AGENDA
			   AND AB.IE_MOTIVO_BLOQUEIO = ATS.IE_MOTIVO_BLOQUEIO
			   AND coalesce(AB.NR_SEQ_MOTIVO_BLOQ_AG,0) = coalesce(coalesce(ATS.NR_SEQ_MOTIVO,AB.NR_SEQ_MOTIVO_BLOQ_AG),0)
			   and (agt.ie_dia_semana = coalesce(ab.ie_dia_semana,agt.ie_dia_semana)
				or (agt.ie_dia_semana = 9 and coalesce(ab.ie_dia_semana,agt.ie_dia_semana) not in (7,1))
				or (ab.ie_dia_semana = 9 and agt.ie_dia_semana not in (7,1)))
			   and ((ie_dia_semana_p = coalesce(ab.ie_dia_semana,ie_dia_semana_p))
				or (ab.ie_dia_semana = 9 and ie_dia_semana_p not in (1,7)))
			   AND AGT.HR_INICIAL <= coalesce(AB.HR_INICIO_BLOQUEIO,AGT.HR_INICIAL)
			   AND AGT.HR_FINAL >= coalesce(AB.HR_FINAL_BLOQUEIO,AGT.HR_FINAL)
			   AND AB.DT_INICIAL >= coalesce(AGT.DT_INICIO_VIGENCIA, AB.DT_INICIAL)
			   AND AB.DT_FINAL >= coalesce(AGT.DT_FINAL_VIGENCIA, AB.DT_FINAL) --VER ESSA LINHA
			   AND to_date('30121899 '||to_char(hr_inicial_p,'hh24miss'),'ddmmyyyy hh24miss') >= coalesce(AB.HR_INICIO_BLOQUEIO,to_date('30121899 '||to_char(hr_inicial_p,'hh24miss'),'ddmmyyyy hh24miss'))
			   and to_date('30121899 '||to_char(hr_inicial_p,'hh24miss'),'ddmmyyyy hh24miss') <= coalesce(AB.HR_FINAL_BLOQUEIO,to_date('30121899 '||to_char(hr_final_p,'hh24miss'),'ddmmyyyy hh24miss'))
			   AND to_date('30121899 '||to_char(hr_final_p,'hh24miss'),'ddmmyyyy hh24miss') <= coalesce(AB.HR_FINAL_BLOQUEIO,to_date('30121899 '||to_char(hr_final_p,'hh24miss'),'ddmmyyyy hh24miss'))
			   AND AB.DT_INICIAL <= coalesce(dt_ini_lib_w,to_date('30121899','ddmmyyyy')) and AB.DT_FINAL >= coalesce(dt_ini_lib_w,to_date('30121899','ddmmyyyy'))
			   AND AB.DT_FINAL >= coalesce(dt_fim_lib_w,to_date('31122999 235959','ddmmyyyy hh24miss'))
			   and ab.cd_agenda <> cd_agenda_p
			   and agt.nr_seq_sala = nr_seq_sala_p
			
UNION ALL

			SELECT COUNT(1) qt_lib_sala
			  FROM AGENDA_TURNO_ESP AGT,
				   AGENDA_BLOQUEIO AB,
				   AGECONS_REGRA_TURNO_SALA ATS
			 WHERE AGT.CD_AGENDA = AB.CD_AGENDA
			   AND AB.IE_MOTIVO_BLOQUEIO = ATS.IE_MOTIVO_BLOQUEIO
			   AND coalesce(AB.NR_SEQ_MOTIVO_BLOQ_AG,0) = coalesce(coalesce(ATS.NR_SEQ_MOTIVO,AB.NR_SEQ_MOTIVO_BLOQ_AG),0)
			   and (agt.ie_dia_semana = coalesce(ab.ie_dia_semana,agt.ie_dia_semana)
				or (agt.ie_dia_semana = 9 and coalesce(ab.ie_dia_semana,agt.ie_dia_semana) not in (7,1))
				or (ab.ie_dia_semana = 9 and agt.ie_dia_semana not in (7,1)))
			   and ((ie_dia_semana_p = coalesce(ab.ie_dia_semana,ie_dia_semana_p))
				or (ab.ie_dia_semana = 9 and ie_dia_semana_p not in (1,7)))
			   AND AGT.HR_INICIAL <= coalesce(AB.HR_INICIO_BLOQUEIO,AGT.HR_INICIAL)
			   AND AGT.HR_FINAL >= coalesce(AB.HR_FINAL_BLOQUEIO,AGT.HR_FINAL)
			   AND AB.DT_INICIAL >= AGT.DT_AGENDA
			   AND AB.DT_FINAL >= coalesce(AGT.DT_AGENDA_FIM, AB.DT_FINAL)
			   AND to_date('30121899 '||to_char(hr_inicial_p,'hh24miss'),'ddmmyyyy hh24miss') >= coalesce(AB.HR_INICIO_BLOQUEIO,to_date('30121899 '||to_char(hr_inicial_p,'hh24miss'),'ddmmyyyy hh24miss'))
			   and to_date('30121899 '||to_char(hr_inicial_p,'hh24miss'),'ddmmyyyy hh24miss') <= coalesce(AB.HR_FINAL_BLOQUEIO,to_date('30121899 '||to_char(hr_final_p,'hh24miss'),'ddmmyyyy hh24miss'))
			   AND to_date('30121899 '||to_char(hr_final_p,'hh24miss'),'ddmmyyyy hh24miss') <= coalesce(AB.HR_FINAL_BLOQUEIO,to_date('30121899 '||to_char(hr_final_p,'hh24miss'),'ddmmyyyy hh24miss'))
			   AND AB.DT_INICIAL <= coalesce(dt_ini_lib_w,to_date('30121899','ddmmyyyy')) and AB.DT_FINAL >= coalesce(dt_ini_lib_w,to_date('30121899','ddmmyyyy'))
			   AND AB.DT_FINAL >= coalesce(dt_fim_lib_w,to_date('31122999 235959','ddmmyyyy hh24miss'))
			   and ab.cd_agenda <> cd_agenda_p
			   and agt.nr_seq_sala = nr_seq_sala_p) alias83;

	end if;

	if (ie_verifica_lib_bloq_w = 0)  then

	/*
	VIGENCIAS DO TURNO:
	Data incial/final nao informadas
	*/
	select	coalesce(max(cd_agenda),0)
	into STRICT	cd_agenda_ocup_w
	from   	agenda_turno
	where  	cd_agenda       	<> 	cd_agenda_p
	and    	((ie_dia_semana   	= 	ie_dia_semana_p)
		or ((ie_dia_semana = 9) and (ie_dia_semana_p not in (1,7)))
		or ((ie_dia_semana_p = 9) and (ie_dia_semana not in (1,7)))
		or (coalesce(ie_dia_semana_p::text, '') = ''))
	and (ie_semana = ie_semana_p
		or	ie_semana_p = 0
		or	ie_semana = 0)
	and		nr_seq_sala			= 	nr_seq_sala_p
	and    	(to_char(hr_inicial_p, 'hh24:mi:ss') >= (to_char(hr_inicial, 'hh24:mi:ss'))
	or (to_char(hr_final_p, 'hh24:mi:ss')	>= to_char(hr_inicial, 'hh24:mi:ss')))
	and		(to_char(hr_final_p, 'hh24:mi:ss')	<= (to_char(hr_final, 'hh24:mi:ss'))
	or (to_char(hr_inicial_p, 'hh24:mi:ss') <= to_char(hr_final, 'hh24:mi:ss')))
	and		coalesce(dt_inicio_vigencia::text, '') = ''
	and		coalesce(dt_final_vigencia::text, '') = ''
	order by cd_agenda;
	
	/*
	VIGENCIAS DO TURNO:
	Data inicial/final informadas
	*/
	if (cd_agenda_ocup_w = 0) and (dt_final_w IS NOT NULL AND dt_final_w::text <> '')then
		--DATA FINAL INFORMADA NO TURNO QUE ESTA SENDO MODIFICADO
		select	coalesce(max(cd_agenda),0)
		into STRICT	cd_agenda_ocup_w
		from   	agenda_turno
		where  	cd_agenda       	<> 	cd_agenda_p
		and    	((ie_dia_semana   	= 	ie_dia_semana_p)
			or ((ie_dia_semana = 9) and (ie_dia_semana_p not in (1,7)))
			or ((ie_dia_semana_p = 9) and (ie_dia_semana not in (1,7)))
			or (coalesce(ie_dia_semana_p::text, '') = ''))
		and (ie_semana = ie_semana_p
			or	ie_semana_p = 0
			or	ie_semana = 0)
		and		nr_seq_sala			= 	nr_seq_sala_p
		and    	(to_char(hr_inicial_p, 'hh24:mi:ss') >= (to_char(hr_inicial, 'hh24:mi:ss'))
		or (to_char(hr_final_p, 'hh24:mi:ss')	>= to_char(hr_inicial, 'hh24:mi:ss')))
		and		(to_char(hr_final_p, 'hh24:mi:ss')	<= (to_char(hr_final, 'hh24:mi:ss'))
		or (to_char(hr_inicial_p, 'hh24:mi:ss') <= to_char(hr_final, 'hh24:mi:ss')))
		and		(dt_inicio_vigencia IS NOT NULL AND dt_inicio_vigencia::text <> '')
		and		(dt_final_vigencia IS NOT NULL AND dt_final_vigencia::text <> '')
		--and		(nvl(dt_inicial_p,sysdate)	>= dt_inicio_vigencia)
		and (trunc(coalesce(dt_inicial_p,clock_timestamp()))	= trunc(dt_inicio_vigencia))
		--and		(nvl(dt_final_p,sysdate)	<= dt_final_vigencia)
		and (trunc(coalesce(dt_final_p,clock_timestamp()))		= trunc(dt_final_vigencia))
		order by cd_agenda;
		
		if (cd_agenda_ocup_w = 0)then

			select	coalesce(max(cd_agenda),0)
			into STRICT	cd_agenda_ocup_w
			from   	agenda_turno
			where  	cd_agenda       	<> 	cd_agenda_p
			and    	((ie_dia_semana   	= 	ie_dia_semana_p)
				or ((ie_dia_semana = 9) and (ie_dia_semana_p not in (1,7)))
				or ((ie_dia_semana_p = 9) and (ie_dia_semana not in (1,7)))
				or (coalesce(ie_dia_semana_p::text, '') = ''))
			and (ie_semana = ie_semana_p
				or	ie_semana_p = 0
				or	ie_semana = 0)
			and		nr_seq_sala			= 	nr_seq_sala_p
			and    	(to_char(hr_inicial_p, 'hh24:mi:ss') >= (to_char(hr_inicial, 'hh24:mi:ss'))
			or (to_char(hr_final_p, 'hh24:mi:ss')	>= to_char(hr_inicial, 'hh24:mi:ss')))
			and		(to_char(hr_final_p, 'hh24:mi:ss')	<= (to_char(hr_final, 'hh24:mi:ss'))
			or (to_char(hr_inicial_p, 'hh24:mi:ss') <= to_char(hr_final, 'hh24:mi:ss')))
			and		(dt_inicio_vigencia IS NOT NULL AND dt_inicio_vigencia::text <> '')
			and		(dt_final_vigencia IS NOT NULL AND dt_final_vigencia::text <> '')
			and (coalesce(dt_inicial_p,clock_timestamp())	>= dt_inicio_vigencia)
				--or	(nvl(dt_inicial_p,sysdate)	<= dt_final_vigencia))
			and (coalesce(dt_final_p,clock_timestamp())	<= dt_final_vigencia)
				--or	(nvl(dt_final_p,sysdate)	>= dt_final_vigencia))
			order by cd_agenda;

		end if;

		if (cd_agenda_ocup_w = 0)then

			select	coalesce(max(cd_agenda),0)
			into STRICT	cd_agenda_ocup_w
			from   	agenda_turno
			where  	cd_agenda       	<> 	cd_agenda_p
			and    	((ie_dia_semana   	= 	ie_dia_semana_p)
				or ((ie_dia_semana = 9) and (ie_dia_semana_p not in (1,7)))
				or ((ie_dia_semana_p = 9) and (ie_dia_semana not in (1,7)))
				or (coalesce(ie_dia_semana_p::text, '') = ''))
			and (ie_semana = ie_semana_p
				or	ie_semana_p = 0
				or	ie_semana = 0)
			and		nr_seq_sala			= 	nr_seq_sala_p
			and    	(to_char(hr_inicial_p, 'hh24:mi:ss') >= (to_char(hr_inicial, 'hh24:mi:ss'))
			or (to_char(hr_final_p, 'hh24:mi:ss')	>= to_char(hr_inicial, 'hh24:mi:ss')))
			and		(to_char(hr_final_p, 'hh24:mi:ss')	<= (to_char(hr_final, 'hh24:mi:ss'))
			or (to_char(hr_inicial_p, 'hh24:mi:ss') <= to_char(hr_final, 'hh24:mi:ss')))
			and		(dt_inicio_vigencia IS NOT NULL AND dt_inicio_vigencia::text <> '')
			and		(dt_final_vigencia IS NOT NULL AND dt_final_vigencia::text <> '')
			--and		(nvl(dt_inicial_p,sysdate)	>= dt_inicio_vigencia)
			and (coalesce(dt_inicial_p,clock_timestamp())	<= dt_final_vigencia)
			--and		(nvl(dt_final_p,sysdate)	<= dt_final_vigencia)
			and (coalesce(dt_final_p,clock_timestamp())	>= dt_final_vigencia)
			order by cd_agenda;

		end if;

		if (cd_agenda_ocup_w = 0)then

			select	coalesce(max(cd_agenda),0)
			into STRICT	cd_agenda_ocup_w
			from   	agenda_turno
			where  	cd_agenda       	<> 	cd_agenda_p
			and    	((ie_dia_semana   	= 	ie_dia_semana_p)
				or ((ie_dia_semana = 9) and (ie_dia_semana_p not in (1,7)))
				or ((ie_dia_semana_p = 9) and (ie_dia_semana not in (1,7)))
				or (coalesce(ie_dia_semana_p::text, '') = ''))
			and (ie_semana = ie_semana_p
				or	ie_semana_p = 0
				or	ie_semana = 0)
			and		nr_seq_sala			= 	nr_seq_sala_p
			and    	(to_char(hr_inicial_p, 'hh24:mi:ss') >= (to_char(hr_inicial, 'hh24:mi:ss'))
			or (to_char(hr_final_p, 'hh24:mi:ss')	>= to_char(hr_inicial, 'hh24:mi:ss')))
			and		(to_char(hr_final_p, 'hh24:mi:ss')	<= (to_char(hr_final, 'hh24:mi:ss'))
			or (to_char(hr_inicial_p, 'hh24:mi:ss') <= to_char(hr_final, 'hh24:mi:ss')))
			and		(dt_inicio_vigencia IS NOT NULL AND dt_inicio_vigencia::text <> '')
			and		(dt_final_vigencia IS NOT NULL AND dt_final_vigencia::text <> '')
			--and		(nvl(dt_inicial_p,sysdate)	>= dt_inicio_vigencia)
			and (coalesce(dt_inicial_p,clock_timestamp())	<= dt_inicio_vigencia)
			--and		(nvl(dt_final_p,sysdate)	<= dt_final_vigencia)
			and (coalesce(dt_final_p,clock_timestamp())	>= dt_inicio_vigencia)
			order by cd_agenda;

		end if;

	elsif (cd_agenda_ocup_w = 0) then

	--DATA INICIO E FIM DA AGENDA QUE ESTA SENDO MODIFICADA E NULA
		if (cd_agenda_ocup_w = 0)then

			select	coalesce(max(cd_agenda),0)
			into STRICT	cd_agenda_ocup_w
			from   	agenda_turno
			where  	cd_agenda       	<> 	cd_agenda_p
			and    	((ie_dia_semana   	= 	ie_dia_semana_p)
				or ((ie_dia_semana = 9) and (ie_dia_semana_p not in (1,7)))
				or ((ie_dia_semana_p = 9) and (ie_dia_semana not in (1,7)))
				or (coalesce(ie_dia_semana_p::text, '') = ''))
			and (ie_semana = ie_semana_p
				or	ie_semana_p = 0
				or	ie_semana = 0)
			and		nr_seq_sala			= 	nr_seq_sala_p
			and    	(to_char(hr_inicial_p, 'hh24:mi:ss') >= (to_char(hr_inicial, 'hh24:mi:ss'))
			or (to_char(hr_final_p, 'hh24:mi:ss')	>= to_char(hr_inicial, 'hh24:mi:ss')))
			and		(to_char(hr_final_p, 'hh24:mi:ss')	<= (to_char(hr_final, 'hh24:mi:ss'))
			or (to_char(hr_inicial_p, 'hh24:mi:ss') <= to_char(hr_final, 'hh24:mi:ss')))
			and 	(dt_inicio_vigencia IS NOT NULL AND dt_inicio_vigencia::text <> '')
			and 	(dt_final_vigencia IS NOT NULL AND dt_final_vigencia::text <> '')
			and		dt_final_vigencia > coalesce(dt_ini_lib_w,to_date('30121899 000000','ddmmyyyy hh24miss'))
			and		dt_inicio_vigencia < coalesce(dt_fim_lib_w,to_date('31122999 235959','ddmmyyyy hh24miss'))
			order by cd_agenda;
	
			if (cd_agenda_ocup_w = 0)then
				/*FALTA*/

				select	coalesce(max(cd_agenda),0)
				into STRICT	cd_agenda_ocup_w
				from   	agenda_turno_esp
				where  	cd_agenda       	<> 	cd_agenda_p
				and    	((ie_dia_semana   	= 	ie_dia_semana_p)
					or ((ie_dia_semana = 9) and (ie_dia_semana_p not in (1,7)))
					or ((ie_dia_semana_p = 9) and (ie_dia_semana not in (1,7)))
					or (coalesce(ie_dia_semana_p::text, '') = ''))
				and		nr_seq_sala			= 	nr_seq_sala_p
				and    	(to_char(hr_inicial_p, 'hh24:mi:ss') >= (to_char(hr_inicial, 'hh24:mi:ss'))
				or (to_char(hr_final_p, 'hh24:mi:ss')	>= to_char(hr_inicial, 'hh24:mi:ss')))
				and		(to_char(hr_final_p, 'hh24:mi:ss')	<= (to_char(hr_final, 'hh24:mi:ss'))
				or (to_char(hr_inicial_p, 'hh24:mi:ss') <= to_char(hr_final, 'hh24:mi:ss')))
				and 	(dt_agenda IS NOT NULL AND dt_agenda::text <> '')
				and 	(dt_agenda_fim IS NOT NULL AND dt_agenda_fim::text <> '')
				and		dt_agenda > coalesce(dt_ini_lib_w,to_date('30121899 000000','ddmmyyyy hh24miss'))
				and		dt_agenda_fim < coalesce(dt_fim_lib_w,to_date('31122999 235959','ddmmyyyy hh24miss'))
				order by cd_agenda;

			end if;

		end if;

	elsif (cd_agenda_ocup_w = 0) and (coalesce(dt_final_w::text, '') = '')then
		--DATA FINAL NAO INFORMADA NO TURNO QUE ESTA SENDO MODIFICADO
		select	coalesce(max(cd_agenda),0)
		into STRICT	cd_agenda_ocup_w
		from   	agenda_turno
		where  	cd_agenda       	<> 	cd_agenda_p
		and    	((ie_dia_semana   	= 	ie_dia_semana_p)
			or ((ie_dia_semana = 9) and (ie_dia_semana_p not in (1,7)))
			or ((ie_dia_semana_p = 9) and (ie_dia_semana not in (1,7)))
			or (coalesce(ie_dia_semana_p::text, '') = ''))
		and (ie_semana = ie_semana_p
			or	ie_semana_p = 0
			or	ie_semana = 0)
		and		nr_seq_sala			= 	nr_seq_sala_p
		and    	(to_char(hr_inicial_p, 'hh24:mi:ss') >= (to_char(hr_inicial, 'hh24:mi:ss'))
		or (to_char(hr_final_p, 'hh24:mi:ss')	>= to_char(hr_inicial, 'hh24:mi:ss')))
		and		(to_char(hr_final_p, 'hh24:mi:ss')	<= (to_char(hr_final, 'hh24:mi:ss'))
		or (to_char(hr_inicial_p, 'hh24:mi:ss') <= to_char(hr_final, 'hh24:mi:ss')))
		and		(dt_inicio_vigencia IS NOT NULL AND dt_inicio_vigencia::text <> '')
		and		(dt_final_vigencia IS NOT NULL AND dt_final_vigencia::text <> '')
		and (trunc(coalesce(dt_inicial_p,clock_timestamp()))	= trunc(dt_inicio_vigencia))
		--and		(nvl(dt_final_p,sysdate)	<= dt_final_vigencia)
		and (trunc(coalesce(dt_final_w, dt_inicial_p))		= trunc(dt_final_vigencia))
		order by cd_agenda;

		if (cd_agenda_ocup_w = 0)then
			/*FALTA*/

			select	coalesce(max(cd_agenda),0)
			into STRICT	cd_agenda_ocup_w
			from   	agenda_turno
			where  	cd_agenda       	<> 	cd_agenda_p
			and    	((ie_dia_semana   	= 	ie_dia_semana_p)
				or ((ie_dia_semana = 9) and (ie_dia_semana_p not in (1,7)))
				or ((ie_dia_semana_p = 9) and (ie_dia_semana not in (1,7)))
				or (coalesce(ie_dia_semana_p::text, '') = ''))
			and (ie_semana = ie_semana_p
				or	ie_semana_p = 0
				or	ie_semana = 0)
			and		nr_seq_sala			= 	nr_seq_sala_p
			and    	(to_char(hr_inicial_p, 'hh24:mi:ss') >= (to_char(hr_inicial, 'hh24:mi:ss'))
			or (to_char(hr_final_p, 'hh24:mi:ss')	>= to_char(hr_inicial, 'hh24:mi:ss')))
			and		(to_char(hr_final_p, 'hh24:mi:ss')	<= (to_char(hr_final, 'hh24:mi:ss'))
			or (to_char(hr_inicial_p, 'hh24:mi:ss') <= to_char(hr_final, 'hh24:mi:ss')))
			and		(dt_inicio_vigencia IS NOT NULL AND dt_inicio_vigencia::text <> '')
			and		(dt_final_vigencia IS NOT NULL AND dt_final_vigencia::text <> '')
			and (coalesce(dt_inicial_p,clock_timestamp())		>= dt_inicio_vigencia)
				--or	(nvl(dt_inicial_p,sysdate)	<= dt_final_vigencia))
			and (coalesce(dt_final_w, dt_inicial_p)	<= dt_final_vigencia)
				--or	(nvl(dt_final_p,sysdate)	>= dt_final_vigencia))
			order by cd_agenda;

		end if;

		if (cd_agenda_ocup_w = 0)then

			select	coalesce(max(cd_agenda),0)
			into STRICT	cd_agenda_ocup_w
			from   	agenda_turno
			where  	cd_agenda       	<> 	cd_agenda_p
			and    	((ie_dia_semana   	= 	ie_dia_semana_p)
				or ((ie_dia_semana = 9) and (ie_dia_semana_p not in (1,7)))
				or ((ie_dia_semana_p = 9) and (ie_dia_semana not in (1,7)))
				or (coalesce(ie_dia_semana_p::text, '') = ''))
			and (ie_semana = ie_semana_p
				or	ie_semana_p = 0
				or	ie_semana = 0)
			and		nr_seq_sala			= 	nr_seq_sala_p
			and    	(to_char(hr_inicial_p, 'hh24:mi:ss') >= (to_char(hr_inicial, 'hh24:mi:ss'))
			or (to_char(hr_final_p, 'hh24:mi:ss')	>= to_char(hr_inicial, 'hh24:mi:ss')))
			and		(to_char(hr_final_p, 'hh24:mi:ss')	<= (to_char(hr_final, 'hh24:mi:ss'))
			or (to_char(hr_inicial_p, 'hh24:mi:ss') <= to_char(hr_final, 'hh24:mi:ss')))
			and		(dt_inicio_vigencia IS NOT NULL AND dt_inicio_vigencia::text <> '')
			and		(dt_final_vigencia IS NOT NULL AND dt_final_vigencia::text <> '')
			and (coalesce(dt_inicial_p,clock_timestamp())		>= dt_inicio_vigencia)
				--or	(nvl(dt_inicial_p,sysdate)	<= dt_final_vigencia))
			and (coalesce(dt_final_w, dt_inicial_p)	<= dt_final_vigencia)
				--or	(nvl(dt_final_p,sysdate)	>= dt_final_vigencia))
			order by cd_agenda;
		end if;

		if (cd_agenda_ocup_w = 0)then

			select	coalesce(max(cd_agenda),0)
			into STRICT	cd_agenda_ocup_w
			from   	agenda_turno
			where  	cd_agenda       	<> 	cd_agenda_p
			and    	((ie_dia_semana   	= 	ie_dia_semana_p)
				or ((ie_dia_semana = 9) and (ie_dia_semana_p not in (1,7)))
				or ((ie_dia_semana_p = 9) and (ie_dia_semana not in (1,7)))
				or (coalesce(ie_dia_semana_p::text, '') = ''))
			and (ie_semana = ie_semana_p
				or	ie_semana_p = 0
				or	ie_semana = 0)
			and		nr_seq_sala			= 	nr_seq_sala_p
			and    	(to_char(hr_inicial_p, 'hh24:mi:ss') >= (to_char(hr_inicial, 'hh24:mi:ss'))
			or (to_char(hr_final_p, 'hh24:mi:ss')	>= to_char(hr_inicial, 'hh24:mi:ss')))
			and		(to_char(hr_final_p, 'hh24:mi:ss')	<= (to_char(hr_final, 'hh24:mi:ss'))
			or (to_char(hr_inicial_p, 'hh24:mi:ss') <= to_char(hr_final, 'hh24:mi:ss')))
			and		(dt_inicio_vigencia IS NOT NULL AND dt_inicio_vigencia::text <> '')
			and		(dt_final_vigencia IS NOT NULL AND dt_final_vigencia::text <> '')
			--and		(nvl(dt_inicial_p,sysdate)	>= dt_inicio_vigencia)
			and (coalesce(dt_inicial_p,clock_timestamp())	<= dt_final_vigencia)
			--and		(nvl(dt_final_p,sysdate)	<= dt_final_vigencia)
			and (coalesce(dt_final_w, dt_inicial_p)	>= dt_final_vigencia)
			order by cd_agenda;

		end if;

		if (cd_agenda_ocup_w = 0)then

			select	coalesce(max(cd_agenda),0)
			into STRICT	cd_agenda_ocup_w
			from   	agenda_turno
			where  	cd_agenda       	<> 	cd_agenda_p
			and    	((ie_dia_semana   	= 	ie_dia_semana_p)
				or ((ie_dia_semana = 9) and (ie_dia_semana_p not in (1,7)))
				or ((ie_dia_semana_p = 9) and (ie_dia_semana not in (1,7)))
				or (coalesce(ie_dia_semana_p::text, '') = ''))
			and (ie_semana = ie_semana_p
				or	ie_semana_p = 0
				or	ie_semana = 0)
			and		nr_seq_sala			= 	nr_seq_sala_p
			and    	(to_char(hr_inicial_p, 'hh24:mi:ss') >= (to_char(hr_inicial, 'hh24:mi:ss'))
			or (to_char(hr_final_p, 'hh24:mi:ss')	>= to_char(hr_inicial, 'hh24:mi:ss')))
			and		(to_char(hr_final_p, 'hh24:mi:ss')	<= (to_char(hr_final, 'hh24:mi:ss'))
			or (to_char(hr_inicial_p, 'hh24:mi:ss') <= to_char(hr_final, 'hh24:mi:ss')))
			and		(dt_inicio_vigencia IS NOT NULL AND dt_inicio_vigencia::text <> '')
			and		(dt_final_vigencia IS NOT NULL AND dt_final_vigencia::text <> '')
			--and		(nvl(dt_inicial_p,sysdate)	>= dt_inicio_vigencia)
			and (coalesce(dt_inicial_p,clock_timestamp())	<= dt_inicio_vigencia)
			--and		(nvl(dt_final_p,sysdate)	<= dt_final_vigencia)
			and (coalesce(dt_final_w, dt_inicial_p)	>= dt_inicio_vigencia)
			order by cd_agenda;

		end if;

	end if;

	/*
	VIGENCIAS DO TURNO:
	Data inicial informada / Data final nao informada
	*/
	if (cd_agenda_ocup_w = 0)then
		select	coalesce(max(cd_agenda),0)
		into STRICT	cd_agenda_ocup_w
		from   	agenda_turno
		where  	cd_agenda       	<> 	cd_agenda_p
		and    	((ie_dia_semana   	= 	ie_dia_semana_p)
			or ((ie_dia_semana = 9) and (ie_dia_semana_p not in (1,7)))
			or ((ie_dia_semana_p = 9) and (ie_dia_semana not in (1,7)))
			or (coalesce(ie_dia_semana_p::text, '') = ''))
		and (ie_semana = ie_semana_p
			or	ie_semana_p = 0
			or	ie_semana = 0)
		and		nr_seq_sala			= 	nr_seq_sala_p
		and    	(to_char(hr_inicial_p, 'hh24:mi:ss') >= (to_char(hr_inicial, 'hh24:mi:ss'))
		or (to_char(hr_final_p, 'hh24:mi:ss')	>= to_char(hr_inicial, 'hh24:mi:ss')))
		and		(to_char(hr_final_p, 'hh24:mi:ss')	<= (to_char(hr_final, 'hh24:mi:ss'))
		or (to_char(hr_inicial_p, 'hh24:mi:ss') <= to_char(hr_final, 'hh24:mi:ss')))
		and		(dt_inicio_vigencia IS NOT NULL AND dt_inicio_vigencia::text <> '')
		and		coalesce(dt_final_vigencia::text, '') = ''
		and		((coalesce(dt_inicio_vigencia,clock_timestamp()) between coalesce(dt_inicial_p,clock_timestamp()) and coalesce(dt_final_p,clock_timestamp()) + 86399/86400) or (coalesce(dt_final_vigencia,clock_timestamp()) between coalesce(dt_inicial_p,clock_timestamp()) and coalesce(dt_final_p,clock_timestamp()) + 86399/86400))
		/*and		((nvl(dt_inicial_p,sysdate)	>= dt_inicio_vigencia)
			or	(nvl(dt_inicial_p,sysdate)	<= nvl(dt_final_vigencia,sysdate)))
		and		((nvl(dt_final_p,sysdate)	<= nvl(dt_final_vigencia,sysdate))
			or	(nvl(dt_final_p,sysdate)	>= nvl(dt_final_vigencia,sysdate)))*/
		order by cd_agenda;

	end if;

	if (cd_agenda_ocup_w = 0) and (coalesce(dt_final_w::text, '') = '')then
		select	coalesce(max(cd_agenda),0)
		into STRICT	cd_agenda_ocup_w
		from   	agenda_turno
		where  	cd_agenda       	<> 	cd_agenda_p
		and    	((ie_dia_semana   	= 	ie_dia_semana_p)
			or ((ie_dia_semana = 9) and (ie_dia_semana_p not in (1,7)))
			or ((ie_dia_semana_p = 9) and (ie_dia_semana not in (1,7)))
			or (coalesce(ie_dia_semana_p::text, '') = ''))
		and (ie_semana = ie_semana_p
			or	ie_semana_p = 0
			or	ie_semana = 0)
		and		nr_seq_sala			= 	nr_seq_sala_p
		and    	(to_char(hr_inicial_p, 'hh24:mi:ss') >= (to_char(hr_inicial, 'hh24:mi:ss'))
		or (to_char(hr_final_p, 'hh24:mi:ss')	>= to_char(hr_inicial, 'hh24:mi:ss')))
		and		(to_char(hr_final_p, 'hh24:mi:ss')	<= (to_char(hr_final, 'hh24:mi:ss'))
		or (to_char(hr_inicial_p, 'hh24:mi:ss') <= to_char(hr_final, 'hh24:mi:ss')))
		and		(dt_inicio_vigencia IS NOT NULL AND dt_inicio_vigencia::text <> '')
		and		coalesce(dt_final_vigencia::text, '') = ''
		and		coalesce(dt_inicial_p,clock_timestamp()) >= dt_inicio_vigencia
		order by cd_agenda;

		if (cd_agenda_ocup_w = 0)then
		
			/*FALTA*/

			select	coalesce(max(cd_agenda),0)
			into STRICT	cd_agenda_ocup_w
			from   	agenda_turno
			where  	cd_agenda       	<> 	cd_agenda_p
			and    	((ie_dia_semana   	= 	ie_dia_semana_p)
				or ((ie_dia_semana = 9) and (ie_dia_semana_p not in (1,7)))
				or ((ie_dia_semana_p = 9) and (ie_dia_semana not in (1,7)))
				or (coalesce(ie_dia_semana_p::text, '') = ''))
			and (ie_semana = ie_semana_p
				or	ie_semana_p = 0
				or	ie_semana = 0)
			and		nr_seq_sala			= 	nr_seq_sala_p
			and    	(to_char(hr_inicial_p, 'hh24:mi:ss') >= (to_char(hr_inicial, 'hh24:mi:ss'))
			or (to_char(hr_final_p, 'hh24:mi:ss')	>= to_char(hr_inicial, 'hh24:mi:ss')))
			and		(to_char(hr_final_p, 'hh24:mi:ss')	<= (to_char(hr_final, 'hh24:mi:ss'))
			or (to_char(hr_inicial_p, 'hh24:mi:ss') <= to_char(hr_final, 'hh24:mi:ss')))
			and		(dt_inicio_vigencia IS NOT NULL AND dt_inicio_vigencia::text <> '')
			and		coalesce(dt_final_vigencia::text, '') = ''
			and		coalesce(dt_inicial_p,clock_timestamp()) <= dt_inicio_vigencia
			order by cd_agenda;

		end if;

	end if;

	if (cd_agenda_ocup_w > 0) then

		/*INICIO - Consiste bloqueio em outras agendas que usam a mesma sala, verificando se as datas do turno/turno especial nao estao dentro do periodo
		do bloqueio(quando a sala estiver livre)*/

			/*falta*/

			if (ie_verifica_lib_bloq_w = 0) then
				
				--TURNO NORMAL
				select	coalesce(max(b.cd_agenda), 0)
				into STRICT	cd_agenda_ocup_bloq_w
				from	agenda_bloqueio a,
						agenda b,
						agenda_turno c
				where	a.cd_agenda			=  b.cd_agenda
				and		b.cd_agenda			=  c.cd_agenda
				and		b.cd_tipo_agenda	=  3
				and		a.cd_agenda			<> cd_agenda_p
				and    	((a.ie_dia_semana   	= 	ie_dia_semana_p)
					or ((a.ie_dia_semana = 9) and (ie_dia_semana_p not in (1,7)))
					or ((ie_dia_semana_p = 9) and (a.ie_dia_semana not in (1,7)))
					or (coalesce(ie_dia_semana_p::text, '') = ''))
				and (c.ie_semana = ie_semana_p
					or	ie_semana_p = 0
					or	c.ie_semana = 0)
				and		c.nr_seq_sala		=  nr_seq_sala_p
				and		dt_inicial_p 		>= trunc(a.dt_inicial)
				and		dt_final_p			<= trunc(a.dt_final)
				and		((coalesce(c.dt_inicio_vigencia,clock_timestamp()) between coalesce(dt_inicial_p,clock_timestamp()) and coalesce(dt_final_p,clock_timestamp()) + 86399/86400) or (coalesce(c.dt_final_vigencia,clock_timestamp()) between coalesce(dt_inicial_p,clock_timestamp()) and coalesce(dt_final_p,clock_timestamp()) + 86399/86400));

				--TURNO ESPECIAL
				if (cd_agenda_ocup_bloq_w = 0) then

					select	coalesce(max(b.cd_agenda), 0)
					into STRICT	cd_agenda_ocup_bloq_w
					from	agenda_bloqueio a,
							agenda b,
							agenda_turno_esp c
					where	a.cd_agenda			=  b.cd_agenda
					and		b.cd_agenda			=  c.cd_agenda
					and		b.cd_tipo_agenda	=  3
					and		a.cd_agenda			<> cd_agenda_p
					and    	((a.ie_dia_semana   	= 	ie_dia_semana_p)
						or ((a.ie_dia_semana = 9) and (ie_dia_semana_p not in (1,7)))
						or ((ie_dia_semana_p = 9) and (a.ie_dia_semana not in (1,7)))
						or (coalesce(ie_dia_semana_p::text, '') = ''))
					and		c.nr_seq_sala		=  nr_seq_sala_p
					and		dt_inicial_p 		>= trunc(a.dt_inicial)
					and		dt_final_p			<= trunc(a.dt_final);

				end if;

				select	substr(coalesce(obter_nome_pf(cd_pessoa_fisica),'"'||wheb_mensagem_pck.get_texto(795843)||'"'),1,100)
				into STRICT	nm_pessoa_w
				from	agenda
				where	cd_agenda	= cd_agenda_ocup_w;

				ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(280407,'NM_PESSOA='|| nm_pessoa_w||';CD_AGENDA_OCUP='||cd_agenda_ocup_w);

			/*FIM - Consiste bloqueio em outras agendas que usam a mesma sala, verificando se as datas do turno/turno especial nao estao dentro do periodo
			do bloqueio(quando a sala estiver livre)*/
			end if;
	end if;

	/*DATA INICIO NAO INFORMADO E DATA FIM INFORMADA*/

	if (cd_agenda_ocup_w = 0) then
	
		select	coalesce(max(cd_agenda),0)
		into STRICT	cd_agenda_ocup_w
		from   	agenda_turno
		where  	cd_agenda       	<> 	cd_agenda_p
		and    	((ie_dia_semana   	= 	ie_dia_semana_p)
			or ((ie_dia_semana = 9) and (ie_dia_semana_p not in (1,7)))
			or ((ie_dia_semana_p = 9) and (ie_dia_semana not in (1,7)))
			or (coalesce(ie_dia_semana_p::text, '') = ''))
		and (ie_semana = 0
			or	0 = 0
			or	ie_semana = 0)
		and		nr_seq_sala			= 	nr_seq_sala_p
		and    	(to_char(hr_inicial_p, 'hh24:mi:ss') >= (to_char(hr_inicial, 'hh24:mi:ss'))
		or (to_char(hr_final_p, 'hh24:mi:ss')	>= to_char(hr_inicial, 'hh24:mi:ss')))
		and		(to_char(hr_final_p, 'hh24:mi:ss')	<= (to_char(hr_final, 'hh24:mi:ss'))
		or (to_char(hr_inicial_p, 'hh24:mi:ss') <= to_char(hr_final, 'hh24:mi:ss')))
		and 	coalesce(dt_inicio_vigencia::text, '') = ''
		and (dt_final_vigencia >= dt_ini_lib_w or coalesce(dt_ini_lib_w::text, '') = '')
		order by cd_agenda;
		
		if (cd_agenda_ocup_w > 0) then
			ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(280407,'NM_PESSOA='|| nm_pessoa_w||';CD_AGENDA_OCUP='||cd_agenda_ocup_w);	
		end if;

	end if;
	
	if (cd_agenda_ocup_w = 0) then

		select	coalesce(max(cd_agenda),0)
		into STRICT	cd_agenda_ocup_w
		from   	agenda_turno
		where  	cd_agenda       <> cd_agenda_p
		and    	ie_dia_semana   = ie_dia_semana_p
		and		nr_seq_sala		= nr_seq_sala_p
		and (ie_semana = ie_semana_p
			or	ie_semana_p = 0
			or	ie_semana = 0)
		and    	to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_final_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') >=
				to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_inicial, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss')
		and		to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_final_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') <=
				to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_final,   'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss')
		and (dt_inicial_w >= dt_inicio_vigencia)
		and (coalesce(dt_final_w, dt_inicial_w) <= dt_final_vigencia)
		and		cd_agenda_ocup_w = 0;
		
	end if;
	
	if (cd_agenda_ocup_w = 0) then
		/*COMPARAR TURNO SEMANAL COM MESMO DIA SEMANA*/

		select	coalesce(max(cd_agenda),0)
		into STRICT	cd_agenda_ocup_w
		from   	agenda_turno
		where  	cd_agenda       <> cd_agenda_p
		and    	ie_dia_semana   = ie_dia_semana_p
		and		nr_seq_sala		= nr_seq_sala_p
		and		coalesce(ie_semana,ie_semana_p) = ie_semana_p
		and    	to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_final_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') >=
				to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_inicial, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss')
		and		to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_final_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') <=
				to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_final,   'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss')
		and (dt_inicial_w >= dt_inicio_vigencia)
		and		coalesce(dt_final_vigencia::text, '') = ''
		and		cd_agenda_ocup_w = 0;
		
		if (cd_agenda_ocup_w > 0) then
			ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(280407,'NM_PESSOA='|| nm_pessoa_w||';CD_AGENDA_OCUP='||cd_agenda_ocup_w);	
		end if;
		
	end if;
	
	
	if (cd_agenda_ocup_w > 0) and (ds_erro_w = '') then
		/*INICIO - Consiste bloqueio em outras agendas que usam a mesma sala, verificando se as datas do turno/turno especial nao estao dentro do periodo
		do bloqueio(quando a sala estiver livre)*/


		--TURNO NORMAL
		select	coalesce(max(b.cd_agenda), 0)
		into STRICT	cd_agenda_ocup_bloq_w
		from	agenda_bloqueio a,
				agenda b,
				agenda_turno c
		where	a.cd_agenda			=  b.cd_agenda
		and		b.cd_agenda			=  c.cd_agenda
		and		b.cd_tipo_agenda	=  3
		and		a.cd_agenda			<> cd_agenda_p
		and    	((c.ie_dia_semana   	= 	ie_dia_semana_p)
			or ((c.ie_dia_semana = 9) and (ie_dia_semana_p not in (1,7)))
			or ((ie_dia_semana_p = 9) and (c.ie_dia_semana not in (1,7)))
			or (coalesce(ie_dia_semana_p::text, '') = ''))
		and (ie_semana = ie_semana_p
			or	ie_semana_p = 0
			or	ie_semana = 0)
		and		c.nr_seq_sala		=  nr_seq_sala_p
		and		dt_inicial_p 		>= trunc(a.dt_inicial)
		and		dt_final_p			<= trunc(a.dt_final);

		--TURNO ESPECIAL
		if (cd_agenda_ocup_bloq_w = 0) then

			select	coalesce(max(b.cd_agenda), 0)
			into STRICT	cd_agenda_ocup_bloq_w
			from	agenda_bloqueio a,
					agenda b,
					agenda_turno_esp c
			where	a.cd_agenda			=  b.cd_agenda
			and		b.cd_agenda			=  c.cd_agenda
			and		b.cd_tipo_agenda	=  3
			and		a.cd_agenda			<> cd_agenda_p
			and    	((c.ie_dia_semana   	= 	ie_dia_semana_p)
				or ((c.ie_dia_semana = 9) and (ie_dia_semana_p not in (1,7)))
				or ((ie_dia_semana_p = 9) and (c.ie_dia_semana not in (1,7)))
				or (coalesce(ie_dia_semana_p::text, '') = ''))
			and		c.nr_seq_sala		=  nr_seq_sala_p
			and		dt_inicial_p 		>= trunc(a.dt_inicial)
			and		dt_final_p			<= trunc(a.dt_final);
		end if;

	commit;

			select	substr(coalesce(obter_nome_pf(cd_pessoa_fisica),'"'||wheb_mensagem_pck.get_texto(795843)||'"'),1,100)
			into STRICT	nm_pessoa_w
			from	agenda
			where	cd_agenda	= cd_agenda_ocup_w;

			ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(280407,'NM_PESSOA='|| nm_pessoa_w||';CD_AGENDA_OCUP='||cd_agenda_ocup_w);
		/*FIM - Consiste bloqueio em outras agendas que usam a mesma sala, verificando se as datas do turno/turno especial nao estao dentro do periodo
		do bloqueio(quando a sala estiver livre)*/
	end if;

	if (cd_agenda_ocup_w	> 0) and (ds_erro_w = '') then
		begin

		select	substr(obter_nome_pf(cd_pessoa_fisica),1,100)
		into STRICT	nm_pessoa_w
		from	agenda
		where	cd_agenda	= cd_agenda_ocup_w;

		ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(280407,'NM_PESSOA='|| nm_pessoa_w||';CD_AGENDA_OCUP='||cd_agenda_ocup_w);

		end;
	end if;

	end if;
end if;

if (ie_consiste_sala_w = 'S') and (nr_seq_sala_p > 0) and (coalesce(ie_frequencia_w,'D') <> 'D') then

	select CASE WHEN coalesce(ie_frequencia_w,'D')='D' THEN 1 WHEN coalesce(ie_frequencia_w,'D')='M' THEN 30 WHEN coalesce(ie_frequencia_w,'D')='Q' THEN 14 WHEN coalesce(ie_frequencia_w,'D')='S' THEN 7 END
	  into STRICT nr_dias_add_w
	;

	dt_vig_dia_sem_w := get_proximo_dia_semana(coalesce(dt_ini_lib_w,to_date('30121899 000000','ddmmyyyy hh24miss')), ie_dia_semana_p);
	
	<<principal>>
	for c in (
		SELECT	a.nr_sequencia, a.DT_INICIO_VIGENCIA, a.cd_agenda, a.ie_semana, a.ie_dia_semana, a.dt_final_vigencia
		from	agenda_turno a,
				agenda b
		where	a.cd_agenda = b.cd_agenda
		and		a.nr_sequencia <> nr_seq_turno_p
		and		a.cd_agenda <> cd_agenda_p
		and		b.cd_tipo_agenda = 3
		and     ((to_date(to_char(a.HR_INICIAL,'hh24mi'),'hh24mi') >= TO_DATE(TO_CHAR(hr_inicial_p,'HH24:MI'),'HH24:MI')
		and     to_date(to_char(a.HR_INICIAL,'hh24mi'),'hh24mi') < TO_DATE(TO_CHAR(hr_final_p,'HH24:MI'),'HH24:MI')) or (
                to_date(to_char(a.HR_INICIAL,'hh24mi'),'hh24mi') < TO_DATE(TO_CHAR(hr_inicial_p,'HH24:MI'),'HH24:MI')
        and     to_date(to_char(a.HR_FINAL,'hh24mi'),'hh24mi') > TO_DATE(TO_CHAR(hr_inicial_p,'HH24:MI'),'HH24:MI')))
		and     a.nr_seq_sala = nr_seq_sala_p
		order by a.DT_INICIO_VIGENCIA asc) loop

		dt_inicio_vigenciac_w := get_proximo_dia_semana(coalesce(c.DT_INICIO_VIGENCIA,to_date('30121899 000000','ddmmyyyy hh24miss')),c.ie_dia_semana);

		dt_calc_vg_w := dt_inicio_vigenciac_w;
		cont_w := 0;

		begin
		select	1
		into STRICT	cd_agenda_ocup_w
		from	agenda_turno
		where	nr_sequencia = c.nr_sequencia
		and		nr_seq_sala = nr_seq_sala_p
		and		((ie_semana = ie_semana_p
			or	 ie_semana_p = 0
			or	ie_semana = 0) and coalesce(dt_inicio_vigencia, dt_ini_lib_w) = dt_ini_lib_w and dt_final_vigencia >= dt_ini_lib_w)
		and (ie_dia_semana = ie_dia_semana_p
			or (ie_dia_semana = 9 and ie_dia_semana_p between 2 and 6)
			or (ie_dia_semana_p = 9 and ie_dia_semana between 2 and 6))  LIMIT 1;
		exception
		when no_data_found then
			cd_agenda_ocup_w := 0;
			
		end;

		if (cd_agenda_ocup_w > 0) then

			select	substr(coalesce(obter_nome_pf(cd_pessoa_fisica),'"'||wheb_mensagem_pck.get_texto(795843)||'"'),1,100)
			into STRICT	nm_pessoa_w
			from	agenda
			where	cd_agenda	= c.cd_agenda;

			ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(280407,'NM_PESSOA='|| nm_pessoa_w||';CD_AGENDA_OCUP='||c.cd_agenda);

			exit principal;
		end if;

		if (dt_calc_vg_w <= dt_ini_lib_w) then
			while(dt_calc_vg_w <= dt_vig_dia_sem_w and (coalesce(ds_erro_w::text, '') = '') and dt_calc_vg_w <= to_date('31122050','ddmmyyyy')) loop
				
				if((dt_calc_vg_w = dt_vig_dia_sem_w and cont_w > 0
					and (dt_inicial_p <= c.dt_final_vigencia)
					and ((dt_final_p >= c.DT_INICIO_VIGENCIA or c.dt_final_vigencia >= dt_inicial_p )
					    and ((coalesce(dt_ini_lib_w::text, '') = '' and (c.dt_inicio_vigencia IS NOT NULL AND c.dt_inicio_vigencia::text <> ''))
						or ((dt_ini_lib_w IS NOT NULL AND dt_ini_lib_w::text <> '') and coalesce(c.dt_final_vigencia::text, '') = '')
						or (coalesce(dt_ini_lib_w::text, '') = '' and coalesce(c.dt_final_vigencia::text, '') = '')
						or (coalesce(dt_fim_lib_w::text, '') = '' and coalesce(c.dt_inicio_vigencia::text, '') = '')
						or ((dt_fim_lib_w IS NOT NULL AND dt_fim_lib_w::text <> '') and coalesce(c.dt_inicio_vigencia::text, '') = '')
						or (coalesce(dt_fim_lib_w::text, '') = '' and (c.dt_inicio_vigencia IS NOT NULL AND c.dt_inicio_vigencia::text <> ''))
						or (coalesce(dt_fim_lib_w::text, '') = '' and coalesce(c.dt_final_vigencia::text, '') = '' ) 
						) or (coalesce(dt_fim_lib_w,c.DT_INICIO_VIGENCIA) >= c.DT_INICIO_VIGENCIA or (coalesce(c.dt_final_vigencia,dt_fim_lib_w) >= dt_fim_lib_w and dt_fim_lib_w > c.dt_inicio_vigencia ))) or (dt_inicio_vigenciac_w = dt_vig_dia_sem_w))) then

					
				
					select	substr(coalesce(obter_nome_pf(cd_pessoa_fisica),'"'||wheb_mensagem_pck.get_texto(795843)||'"'),1,100)
					into STRICT	nm_pessoa_w
					from	agenda
					where	cd_agenda	= c.cd_agenda;

					ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(280407,'NM_PESSOA='|| nm_pessoa_w||';CD_AGENDA_OCUP='||c.cd_agenda);

					exit principal;
				end if;

				dt_calc_vg_w := dt_calc_vg_w + nr_dias_add_w;
				cont_w := cont_w +1;

			end loop;
		else
			while(dt_calc_vg_w >= dt_vig_dia_sem_w and (coalesce(ds_erro_w::text, '') = '') and dt_calc_vg_w >= to_date('01011990','ddmmyyyy')) loop

				if((dt_calc_vg_w = dt_vig_dia_sem_w and cont_w > 0 /*and ()*/
						and (dt_inicial_p <= c.dt_final_vigencia)				
					    and ((coalesce(dt_ini_lib_w::text, '') = '' and (c.dt_inicio_vigencia IS NOT NULL AND c.dt_inicio_vigencia::text <> ''))
						or ((dt_ini_lib_w IS NOT NULL AND dt_ini_lib_w::text <> '') and coalesce(c.dt_final_vigencia::text, '') = '')
						or (coalesce(dt_ini_lib_w::text, '') = '' and coalesce(c.dt_final_vigencia::text, '') = '')
						or (coalesce(dt_fim_lib_w::text, '') = '' and coalesce(c.dt_inicio_vigencia::text, '') = '')
						or ((dt_fim_lib_w IS NOT NULL AND dt_fim_lib_w::text <> '') and coalesce(c.dt_inicio_vigencia::text, '') = '')
						or (coalesce(dt_fim_lib_w::text, '') = '' and (c.dt_inicio_vigencia IS NOT NULL AND c.dt_inicio_vigencia::text <> ''))
						or (coalesce(dt_fim_lib_w::text, '') = '' and coalesce(c.dt_final_vigencia::text, '') = '' )
						) or (coalesce(dt_fim_lib_w,c.DT_INICIO_VIGENCIA) >= c.DT_INICIO_VIGENCIA or (coalesce(c.dt_final_vigencia,dt_fim_lib_w) >= dt_fim_lib_w and dt_fim_lib_w > c.dt_inicio_vigencia ))) or (dt_inicio_vigenciac_w = dt_vig_dia_sem_w)) then
				
					
				
					select	substr(coalesce(obter_nome_pf(cd_pessoa_fisica),'"'||wheb_mensagem_pck.get_texto(795843)||'"'),1,100)
					into STRICT	nm_pessoa_w
					from	agenda
					where	cd_agenda	= c.cd_agenda;

					ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(280407,'NM_PESSOA='|| nm_pessoa_w||';CD_AGENDA_OCUP='||c.cd_agenda);

					exit principal;
				end if;

				dt_calc_vg_w := dt_calc_vg_w - nr_dias_add_w;
				cont_w := cont_w +1;

			end loop;
		end if;
	end loop principal;

end if;

if (ie_consiste_medico_w = 'S') then

	dt_inicial_ww := inicio_dia(coalesce(dt_inicial_p, clock_timestamp()));
		
		select	count(*)
		into STRICT	qt_agenda_turno_med_w
		from	agenda_turno a,
				agenda b
		where	a.cd_agenda = b.cd_agenda
		and		a.nr_sequencia <> nr_seq_turno_p
		and		b.cd_tipo_agenda in (3,4)
		and		b.cd_pessoa_fisica = cd_medico_w
		and		((a.ie_dia_semana =	ie_dia_semana_p)
			or (a.ie_dia_semana = 9 and ie_dia_semana_p not in (1,7))
			or (ie_dia_semana_p = 9 and a.ie_dia_semana not in (1,7)))
		and (ie_semana = ie_semana_p
			or	ie_semana_p = 0
			or	ie_semana = 0)
		and    	to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_final_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') >=
				to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_inicial, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss')
		and		to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_inicial_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') <=
				to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_final,   'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss')
		and		(((coalesce(dt_inicio_vigencia,clock_timestamp()) between coalesce(dt_inicial_p,clock_timestamp()) and fim_dia(coalesce(dt_final_p,clock_timestamp())))
			or (coalesce(dt_final_vigencia,clock_timestamp()) between coalesce(dt_inicial_p,clock_timestamp()) and fim_dia(coalesce(dt_final_p,clock_timestamp()))))
			or (coalesce(dt_inicial_p,clock_timestamp()) between coalesce(dt_inicio_vigencia,clock_timestamp()) and fim_dia(coalesce(dt_final_vigencia,clock_timestamp())))
			or (coalesce(dt_final_p,clock_timestamp()) between coalesce(dt_inicio_vigencia,clock_timestamp()) and fim_dia(coalesce(dt_final_vigencia,clock_timestamp()))));
		
		if (qt_agenda_turno_med_w > 0) then
			ds_erro_w	:= wheb_mensagem_pck.get_texto(280414,null);
		end if;

end if;

open	c02;
loop
fetch	c02 into
	qt_agenda_exame_w,
	ie_tipo_w,
	ds_agenda_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin

	ds_agenda_geral_w	:= ds_agenda_geral_w || ds_agenda_w || chr(13) || chr(10);

	qt_agenda_exame_tot_w	:= qt_agenda_exame_tot_w + qt_agenda_exame_w;

	end;
end loop;
close	c02;

if (qt_agenda_exame_tot_w	> 0) and (coalesce(ie_consistir_horario_w,'S') = 'S') then
	begin
	ds_erro_w	:= wheb_mensagem_pck.get_texto(280415,null) || chr(13) || chr(10) || ds_agenda_geral_w;
	end;
end if;

ds_erro_p	:= ds_erro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_agenda_turno_cons ((cd_agenda_p bigint, ie_dia_semana_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, hr_inicial_p timestamp, hr_final_p timestamp, nr_seq_sala_p bigint, ie_consiste_horario_p text, nm_usuario_p text, ds_erro_p out text, nr_seq_turno_p bigint, ie_frequencia_p text default null, ie_semana_p bigint default 0) is ds_erro_w varchar(4000) DEFAULT '') FROM PUBLIC;

