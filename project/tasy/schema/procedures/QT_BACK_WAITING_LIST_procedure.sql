-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qt_back_waiting_list ( nr_seq_agenda_quimio_p bigint, dt_agenda_p timestamp, nr_seq_grupo_quimio_p bigint ) AS $body$
BEGIN

IF ((nr_seq_agenda_quimio_p IS NOT NULL AND nr_seq_agenda_quimio_p::text <> '') OR (dt_agenda_p IS NOT NULL AND dt_agenda_p::text <> '')) THEN
    UPDATE paciente_atendimento
    SET ie_alocado = 'N',
        nr_seq_local  = NULL
    WHERE nr_seq_atendimento IN (
        SELECT paciente_atendimento.nr_seq_atendimento
        FROM 
            paciente_atendimento,
            qt_local
        WHERE 
            paciente_atendimento.nr_seq_local = qt_local.nr_sequencia
            AND coalesce(paciente_atendimento.dt_inicio_adm::text, '') = ''
            AND paciente_atendimento.nr_seq_atendimento = coalesce(nr_seq_agenda_quimio_p, paciente_atendimento.nr_seq_atendimento)
            AND TRUNC(coalesce(paciente_atendimento.dt_real, paciente_atendimento.dt_prevista)) = TRUNC(coalesce(dt_agenda_p, coalesce(paciente_atendimento.dt_real, paciente_atendimento.dt_prevista)))
            AND paciente_atendimento.ie_alocado = 'S'
            AND (coalesce(nr_seq_grupo_quimio_p::text, '') = '' OR ((nr_seq_grupo_quimio_p IS NOT NULL AND nr_seq_grupo_quimio_p::text <> '') AND qt_local.nr_seq_grupo_quimio = nr_seq_grupo_quimio_p))
    );

    COMMIT;
END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qt_back_waiting_list ( nr_seq_agenda_quimio_p bigint, dt_agenda_p timestamp, nr_seq_grupo_quimio_p bigint ) FROM PUBLIC;

