-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE bt_desfazer_alta_eup (nr_atendimento_p bigint, qt_atend_p INOUT bigint, ds_msg_p INOUT text, dt_tempo_alta_p INOUT text, ds_msg_tempo_alta_p INOUT text, ie_conta_aberto_p INOUT text, ds_texto_p INOUT text, nm_usuario_p text) AS $body$
DECLARE


nr_temp_desf_alta_w			bigint;
ie_desf_alta_aten_def_w		varchar(1);


BEGIN

ie_desf_alta_aten_def_w := Obter_param_Usuario(916, 198, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_desf_alta_aten_def_w);
nr_temp_desf_alta_w := Obter_param_Usuario(916, 472, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, nr_temp_desf_alta_w);

SELECT 	count(1) qt_atend
INTO STRICT	qt_atend_p
FROM   	atendimento_paciente a
WHERE  	(a.dt_alta IS NOT NULL AND a.dt_alta::text <> '')
AND		a.nr_atendimento = nr_atendimento_p
AND		EXISTS (SELECT e.nr_atendimento
				FROM   atendimento_paciente e
				WHERE  e.cd_pessoa_fisica = a.cd_pessoa_fisica
				AND	   coalesce(e.dt_alta::text, '') = ''
				AND	   e.nr_atendimento <> nr_atendimento_p);

if (qt_atend_p > 0) then				
	ds_msg_p := wheb_mensagem_pck.get_texto(121153);
end if;

IF (nr_temp_desf_alta_w > 0) THEN
	BEGIN
	SELECT 	TO_CHAR(dt_alta + nr_temp_desf_alta_w /1440, 'dd/mm/yyyy hh24:mi:ss') dt_tempo_alta
	INTO STRICT	dt_tempo_alta_p
	FROM 	atendimento_paciente
	WHERE 	nr_atendimento = nr_atendimento_p;

	ds_msg_tempo_alta_p := wheb_mensagem_pck.get_texto(122204);
	END;
END IF;

IF (ie_desf_alta_aten_def_w <> 'S') THEN
	BEGIN
	SELECT  obter_se_atend_conta_aberto(nr_atendimento_p) ie_conta_aberto,
			obter_texto_tasy(122225, null) ds_texto
	INTO STRICT	ie_conta_aberto_p,
			ds_texto_p
	;
	END;
END IF;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE bt_desfazer_alta_eup (nr_atendimento_p bigint, qt_atend_p INOUT bigint, ds_msg_p INOUT text, dt_tempo_alta_p INOUT text, ds_msg_tempo_alta_p INOUT text, ie_conta_aberto_p INOUT text, ds_texto_p INOUT text, nm_usuario_p text) FROM PUBLIC;

