-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_dia_proc_aih ( nr_atendimento_p bigint, nr_interno_conta_p bigint, cd_procedimento_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE

 
qt_dia_pac_w		integer;
qt_dia_proc_w		integer;

dt_inicial_w		timestamp;
dt_final_w		timestamp;


BEGIN 
 
if (coalesce(nr_interno_conta_p,0) <> 0) then 
	begin 
	select coalesce(max(dt_inicial),null), 
		 coalesce(max(dt_final),clock_timestamp()) 
	into STRICT	 dt_inicial_w, 
		 dt_final_w 
	from	 sus_aih 
	where	 nr_interno_conta = nr_interno_conta_p;
	end;
end if;
 
if (coalesce(dt_inicial_w::text, '') = '') then 
	begin 
	select coalesce(round(coalesce(dt_alta,clock_timestamp()) - dt_entrada),0) 
	into STRICT	 qt_dia_pac_w 
	from 	 atendimento_paciente 
	where	 nr_atendimento 	= nr_atendimento_p;
	end;
else 
	qt_dia_pac_w := coalesce(round(dt_final_w - dt_inicial_w),0);
end if;
 
select	coalesce(max(qt_dia_internacao_sus),0) 
into STRICT	qt_dia_proc_w 
from	Procedimento 
where	cd_procedimento	= cd_procedimento_p 
and	ie_origem_proced	= 2;
 
ds_erro_p	:= '';
if (qt_dia_proc_w > 0) and (qt_dia_pac_w > 0) and (qt_dia_pac_w > qt_dia_proc_w) then 
	ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(281508,null) || '(' || qt_dia_proc_w || '/' || qt_dia_pac_w || ')';
end if;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_dia_proc_aih ( nr_atendimento_p bigint, nr_interno_conta_p bigint, cd_procedimento_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

