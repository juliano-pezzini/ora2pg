-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_reconst_diluicao_agente ( cd_estabelecimento_p bigint, nr_seq_agente_cir_p bigint, ie_opcao_p text, nm_usuario_p text ) AS $body$
DECLARE


cd_material_w					integer;
ie_via_aplicacao_w				varchar(5);
ie_gera_diluicao_w				varchar(1) := 'S';
cd_material_generico_w			integer;
qt_registro_w					smallint;
ie_diluente_w					varchar(1) := 'N';
cd_diluente_w					integer;
qt_diluicao_w					double precision;
cd_unid_med_diluente_w			varchar(30);
ie_reconstituicao_w				varchar(1);
cd_intervalo_cad_w				varchar(7);
qt_minuto_aplicacao_w			smallint;
nr_seq_prioridade_w				smallint;
ie_diluente_padrao_w				varchar(2);

/*
ie_opcao_p
	D Diluição
	R Reconstituição
	A Ambos
*/
c01 CURSOR FOR
SELECT	coalesce(cd_diluente,0),
	coalesce(qt_diluicao,0),
	coalesce(cd_unid_med_diluente,substr(obter_unid_med_usua('ml'),1,255)),
	coalesce(ie_reconstituicao,'A'),
	ie_via_aplicacao,
	coalesce(qt_minuto_aplicacao,0),
	cd_intervalo,
	nr_seq_prioridade
from	material_diluicao
where	ie_gera_diluicao_w 		= 'S'
and	ie_diluente_padrao_w in ('S','D')
and	ie_reconstituicao		= 'N'
and	cd_material			= cd_material_w
and	cd_estabelecimento		= cd_estabelecimento_p
and	((ie_via_aplicacao		= ie_via_aplicacao_w) or (coalesce(ie_via_aplicacao::text, '') = ''))

union

select	coalesce(cd_diluente,0),
	coalesce(qt_diluicao,0),
	coalesce(cd_unid_med_diluente,substr(obter_unid_med_usua('ml'),1,255)),
	coalesce(ie_reconstituicao,'A'),
	ie_via_aplicacao,
	coalesce(qt_minuto_aplicacao,0),
	cd_intervalo,
	nr_seq_prioridade
from	material_diluicao
where	ie_gera_diluicao_w		= 'S'
and	ie_diluente_padrao_w in ('S','D')
and	ie_reconstituicao		= 'N'
and	cd_material			= cd_material_generico_w
and	cd_estabelecimento		= cd_estabelecimento_p
and	((ie_via_aplicacao		= ie_via_aplicacao_w) or (coalesce(ie_via_aplicacao::text, '') = ''))
order by ie_via_aplicacao desc, nr_seq_prioridade desc;


c02 CURSOR FOR
SELECT	coalesce(cd_diluente,0),
	coalesce(qt_diluicao,0),
	coalesce(cd_unid_med_diluente,substr(obter_unid_med_usua('ml'),1,255)),
	coalesce(ie_reconstituicao,'A'),
	ie_via_aplicacao,
	cd_intervalo,
	nr_seq_prioridade
from	material_diluicao
where	ie_diluente_padrao_w in ('S','R')
and	cd_material		= cd_material_w
and	ie_reconstituicao 		= 'S'
and	cd_estabelecimento		= cd_estabelecimento_p
and	((ie_via_aplicacao 		= ie_via_aplicacao_w) or (coalesce(ie_via_aplicacao::text, '') = ''))

union

Select	coalesce(cd_diluente,0),
	coalesce(qt_diluicao,0),
	coalesce(cd_unid_med_diluente,substr(obter_unid_med_usua('ml'),1,255)),
	coalesce(ie_reconstituicao,'A'),
	ie_via_aplicacao,
	cd_intervalo,
	nr_seq_prioridade
from	material_diluicao
where	ie_diluente_padrao_w in ('S','R')
and	cd_material 		= cd_material_generico_w
and	cd_estabelecimento		= cd_estabelecimento_p
and	ie_reconstituicao		= 'S'
and	((ie_via_aplicacao		= ie_via_aplicacao_w) or (coalesce(ie_via_aplicacao::text, '') = ''))
order by ie_via_aplicacao desc, nr_seq_prioridade desc;


BEGIN

select	coalesce(ie_diluente_padrao,'S')
into STRICT	ie_diluente_padrao_w
from	agente_anestesico
where	nr_sequencia = (SELECT	max(nr_seq_agente)
			from	cirurgia_agente_anestesico
			where	nr_sequencia	= nr_seq_agente_cir_p
			and	coalesce(ie_situacao,'A') = 'A');

if (ie_diluente_padrao_w in ('S','D','R')) then
	begin

	if (nr_seq_agente_cir_p > 0) then

		select	cd_material,
			ie_via_aplicacao
		into STRICT	cd_material_w,
			ie_via_aplicacao_w
		from	cirurgia_agente_anestesico
		where	nr_sequencia	=	nr_seq_agente_cir_p
		and	coalesce(ie_situacao,'A') = 'A';

		select	coalesce(max(cd_material_generico), cd_material_w)
		into STRICT	cd_material_generico_w
		from	material
		where	cd_material	= 	cd_material_w;

		/* Inserir o reconstituinte */

		open C02;
		loop
			fetch C02 into
				cd_diluente_w,
				qt_diluicao_w,
				cd_unid_med_diluente_w,
				ie_reconstituicao_w,
				ie_via_aplicacao_w,
				cd_intervalo_cad_w,
				nr_seq_prioridade_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				ie_diluente_w	:= 'S';
		end loop;
		close C02;

		if (ie_diluente_w = 'S') and (coalesce(cd_diluente_w,0) > 0) then

			select	count(*)
			into STRICT	qt_registro_w
			from	agente_anest_diluicao
			where	nr_seq_agente_cir	=	nr_seq_agente_cir_p
			and	ie_origem_inf	=	1;

			if (qt_registro_w = 0) then
				insert into agente_anest_diluicao(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					cd_material,
					cd_unidade_medida,
					ie_origem_inf,
					qt_rediluir,
					qt_dose,
					nr_seq_agente_cir)
				values (
					nextval('agente_anest_diluicao_seq'),
					clock_timestamp(),
					nm_usuario_p,
					cd_diluente_w,
					cd_unid_med_diluente_w,
					1,
					null,
					qt_diluicao_w,
					nr_seq_agente_cir_p );
			end if;
		end if;

		/* Inserir o Diluente */

		select	max(cd_material),
			max(ie_via_aplicacao)
		into STRICT	cd_material_w,
			ie_via_aplicacao_w
		from	cirurgia_agente_anestesico
		where	nr_sequencia	=	nr_seq_agente_cir_p
		and	coalesce(ie_situacao,'A') = 'A';

		if (ie_via_aplicacao_w IS NOT NULL AND ie_via_aplicacao_w::text <> '') then
			select	ie_gera_diluicao
			into STRICT	ie_gera_diluicao_w
			from	via_aplicacao
			where	ie_via_aplicacao = ie_via_aplicacao_w;
		end if;

		ie_diluente_w	:= 'N';

		open C01;
		loop
			fetch C01 into
				cd_diluente_w,
				qt_diluicao_w,
				cd_unid_med_diluente_w,
				ie_reconstituicao_w,
				ie_via_aplicacao_w,
				qt_minuto_aplicacao_w,
				cd_intervalo_cad_w,
				nr_seq_prioridade_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				ie_diluente_w	:= 'S';
		end loop;
		close C01;

		if (ie_diluente_w = 'S') then

			select	count(*)
			into STRICT	qt_registro_w
			from	agente_anest_diluicao
			where	nr_seq_agente_cir	=	nr_seq_agente_cir_p
			and	ie_origem_inf	=	2;

			if (qt_registro_w = 0) then
				insert into agente_anest_diluicao(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					cd_material,
					cd_unidade_medida,
					ie_origem_inf,
					qt_rediluir,
					qt_dose,
					nr_seq_agente_cir)
				values (
					nextval('agente_anest_diluicao_seq'),
					clock_timestamp(),
					nm_usuario_p,
					cd_diluente_w,
					cd_unid_med_diluente_w,
					2,
					null,
					qt_diluicao_w,
					nr_seq_agente_cir_p );
			end if;
		end if;
	end if;

	commit;

	end;
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_reconst_diluicao_agente ( cd_estabelecimento_p bigint, nr_seq_agente_cir_p bigint, ie_opcao_p text, nm_usuario_p text ) FROM PUBLIC;

