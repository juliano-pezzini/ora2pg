-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_siscolo_cito_pathox (nr_seq_siscolo_p siscolo_cito_avaliacao.nr_seq_siscolo%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nm_usuario_p usuario.nm_usuario%type default null) AS $body$
DECLARE


nr_seq_sis_cito_ava_w		w_int_pathox_sis_cito_ava.nr_sequencia%type;
nr_seq_sis_cito_dia_w		w_int_pathox_sis_cito_dia.nr_sequencia%type;
nr_seq_sis_cito_ati_w		w_int_pathox_sis_cito_ati.nr_sequencia%type;
nr_seq_siscolo_cito_ava_w	siscolo_cito_avaliacao.nr_sequencia%type;
ie_ausencia_erro_w		siscolo_cito_avaliacao.ie_ausencia_erro%type;
ie_lamina_danificada_w		siscolo_cito_avaliacao.ie_lamina_danificada%type;
ie_causas_alheias_w		siscolo_cito_avaliacao.ie_causas_alheias%type;
ds_causas_alheias_w		siscolo_cito_avaliacao.ds_causas_alheias%type;
ie_outras_causas_w		siscolo_cito_avaliacao.ie_outras_causas%type;
ds_outras_causas_w		siscolo_cito_avaliacao.ds_outras_causas%type;
ie_adequabilidade_w		siscolo_cito_avaliacao.ie_adequabilidade%type;
ie_acelular_w			siscolo_cito_avaliacao.ie_acelular%type;
ie_prejudic_sague_w		siscolo_cito_avaliacao.ie_prejudic_sague%type;
ie_prejudic_piocitos_w		siscolo_cito_avaliacao.ie_prejudic_piocitos%type;
ie_artefatos_dessec_w		siscolo_cito_avaliacao.ie_artefatos_dessec%type;
ie_contaminantes_ext_w		siscolo_cito_avaliacao.ie_contaminantes_ext%type;
ie_superposicao_cel_w		siscolo_cito_avaliacao.ie_superposicao_cel%type;
ie_prejudic_outros_w		siscolo_cito_avaliacao.ie_prejudic_outros%type;
ie_epitelio_escamoso_w		siscolo_cito_avaliacao.ie_epitelio_escamoso%type;
ie_epitelio_glandular_w		siscolo_cito_avaliacao.ie_epitelio_glandular%type;
ie_epitelio_metaplasico_w	siscolo_cito_avaliacao.ie_epitelio_metaplasico%type;
nr_seq_siscolo_cito_dia_w	siscolo_cito_diagnostico.ie_normalidade_mat%type;
ie_normalidade_mat_w		siscolo_cito_diagnostico.ie_normalidade_mat%type;
ie_alter_inflamacao_w		siscolo_cito_diagnostico.ie_alter_inflamacao%type;
ie_metaplasia_esc_w		siscolo_cito_diagnostico.ie_metaplasia_esc%type;
ie_alter_reparacao_w		siscolo_cito_diagnostico.ie_alter_reparacao%type;
ie_atrofia_inflam_w		siscolo_cito_diagnostico.ie_atrofia_inflam%type;
ie_alter_radiacao_w		siscolo_cito_diagnostico.ie_alter_radiacao%type;
ie_alter_outras_w		siscolo_cito_diagnostico.ie_alter_outras%type;
ds_alter_outras_w		siscolo_cito_diagnostico.ds_alter_outras%type;
ie_lactobacilos_w		siscolo_cito_diagnostico.ie_lactobacilos%type;
ie_microb_cocos_w		siscolo_cito_diagnostico.ie_microb_cocos%type;
ie_micro_bacilos_w		siscolo_cito_diagnostico.ie_micro_bacilos%type;
ie_micro_chlamydia_w		siscolo_cito_diagnostico.ie_micro_chlamydia%type;
ie_actinomyces_sp_w		siscolo_cito_diagnostico.ie_actinomyces_sp%type;
ie_candida_sp_w			siscolo_cito_diagnostico.ie_candida_sp%type;
ie_trichomonas_vag_w		siscolo_cito_diagnostico.ie_trichomonas_vag%type;
ie_citopatico_herpes_w		siscolo_cito_diagnostico.ie_citopatico_herpes%type;
ie_bacilos_supracito_w		siscolo_cito_diagnostico.ie_bacilos_supracito%type;
ie_microb_outras_w		siscolo_cito_diagnostico.ie_microb_outras%type;
ds_microb_outras_w		siscolo_cito_diagnostico.ds_microb_outras%type;
nr_seq_siscolo_atipias_w	siscolo_cito_atipias.ie_atipicas_escamosas%type;
ie_atipicas_escamosas_w		siscolo_cito_atipias.ie_atipicas_escamosas%type;
ie_atipicas_glandulares_w	siscolo_cito_atipias.ie_atipicas_glandulares%type;
ie_atipicas_indefinidas_w	siscolo_cito_atipias.ie_atipicas_indefinidas%type;
ie_atipias_escamosas_w		siscolo_cito_atipias.ie_atipias_escamosas%type;
ie_atipias_gla_adeno_w		siscolo_cito_atipias.ie_atipias_gla_adeno%type;
ie_neo_malignas_w		siscolo_cito_atipias.ie_neo_malignas%type;
ds_neo_malignas_w		siscolo_cito_atipias.ds_neo_malignas%type;
ie_celula_endometrial_w		siscolo_cito_atipias.ie_celula_endometrial%type;
ds_obs_gerais_w			siscolo_cito_atipias.ds_obs_gerais%type;
dt_liberacao_w			siscolo_cito_atipias.dt_liberacao%type;
cd_cns_resp_result_w		siscolo_cito_atipias.cd_cns_resp_result%type;
cd_cpf_resp_result_w		siscolo_cito_atipias.cd_cpf_resp_result%type;


BEGIN

if (nr_seq_siscolo_p = 0 )then
   return;
end if;

--avaliacao
select	max(nr_sequencia)
into STRICT	nr_seq_sis_cito_ava_w
from	w_int_pathox_sis_cito_ava
where	nr_seq_siscolo	= nr_seq_siscolo_p and
	nr_prescricao 	= nr_prescricao_p;

begin
select	CASE WHEN ie_ausencia_erro='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_lamina_danificada='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_causas_alheias='3' THEN 'S'  ELSE 'N' END ,
	ds_causas_alheias,
	CASE WHEN ie_outras_causas='3' THEN 'S'  ELSE 'N' END ,
	ds_outras_causas,
	CASE WHEN ie_adequabilidade='3' THEN 'S' WHEN ie_adequabilidade='1' THEN 'I'  ELSE null END ,
	CASE WHEN ie_acelular='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_prejudic_sague='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_prejudic_piocitos='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_artefatos_dessec='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_contaminantes_ext='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_superposicao_cel='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_prejudic_outros='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_epitelio_escamoso='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_epitelio_glandular='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_epitelio_metaplasico='3' THEN 'S'  ELSE 'N' END
into STRICT	ie_ausencia_erro_w,
	ie_lamina_danificada_w,
	ie_causas_alheias_w,
	ds_causas_alheias_w,
	ie_outras_causas_w,
	ds_outras_causas_w,
	ie_adequabilidade_w,
	ie_acelular_w,
	ie_prejudic_sague_w,
	ie_prejudic_piocitos_w,
	ie_artefatos_dessec_w,
	ie_contaminantes_ext_w,
	ie_superposicao_cel_w,
	ie_prejudic_outros_w,
	ie_epitelio_escamoso_w,
	ie_epitelio_glandular_w,
	ie_epitelio_metaplasico_w
from	w_int_pathox_sis_cito_ava
where	nr_sequencia = nr_seq_sis_cito_ava_w;
exception when others then
	null;
end;

begin
select	nr_sequencia
into STRICT	nr_seq_siscolo_cito_ava_w
from	siscolo_cito_avaliacao
where	nr_seq_siscolo = nr_seq_siscolo_p;
exception when others then
	null;
end;

if (coalesce(nr_seq_siscolo_cito_ava_w::text, '') = '') then
	insert into siscolo_cito_avaliacao(
		nr_sequencia,
		dt_atualizacao,
		dt_atualizacao_nrec,
		nm_usuario,
		nm_usuario_nrec,
		nr_seq_siscolo,
		ie_ausencia_erro,
		ie_lamina_danificada,
		ie_causas_alheias,
		ds_causas_alheias,
		ie_outras_causas,
		ds_outras_causas,
		ie_adequabilidade,
		ie_acelular,
		ie_prejudic_sague,
		ie_prejudic_piocitos,
		ie_artefatos_dessec,
		ie_contaminantes_ext,
		ie_superposicao_cel,
		ie_prejudic_outros,
		ie_epitelio_escamoso,
		ie_epitelio_glandular,
		ie_epitelio_metaplasico)
	values (nextval('siscolo_cito_avaliacao_seq'),
		clock_timestamp(),
		clock_timestamp(),
		coalesce(nm_usuario_p, wheb_usuario_pck.get_nm_usuario),
		coalesce(nm_usuario_p, wheb_usuario_pck.get_nm_usuario),
		nr_seq_siscolo_p,
		ie_ausencia_erro_w,
		ie_lamina_danificada_w,
		ie_causas_alheias_w,
		ds_causas_alheias_w,
		ie_outras_causas_w,
		ds_outras_causas_w,
		ie_adequabilidade_w,
		ie_acelular_w,
		ie_prejudic_sague_w,
		ie_prejudic_piocitos_w,
		ie_artefatos_dessec_w,
		ie_contaminantes_ext_w,
		ie_superposicao_cel_w,
		ie_prejudic_outros_w,
		ie_epitelio_escamoso_w,
		ie_epitelio_glandular_w,
		ie_epitelio_metaplasico_w);
	commit;
else
	update 	siscolo_cito_avaliacao
	set	dt_atualizacao = clock_timestamp(),
		nm_usuario = coalesce(nm_usuario_p, wheb_usuario_pck.get_nm_usuario),
		ie_ausencia_erro = ie_ausencia_erro_w,
		ie_lamina_danificada = ie_lamina_danificada_w,
		ie_causas_alheias = ie_causas_alheias_w,
		ds_causas_alheias = ds_causas_alheias_w,
		ie_outras_causas = ie_outras_causas_w,
		ds_outras_causas = ds_outras_causas_w,
		ie_adequabilidade = ie_adequabilidade_w,
		ie_acelular = ie_acelular_w,
		ie_prejudic_sague = ie_prejudic_sague_w,
		ie_prejudic_piocitos = ie_prejudic_piocitos_w,
		ie_artefatos_dessec = ie_artefatos_dessec_w,
		ie_contaminantes_ext = ie_contaminantes_ext_w,
		ie_superposicao_cel = ie_superposicao_cel_w,
		ie_prejudic_outros = ie_prejudic_outros_w,
		ie_epitelio_escamoso = ie_epitelio_escamoso_w,
		ie_epitelio_glandular = ie_epitelio_glandular_w,
		ie_epitelio_metaplasico = ie_epitelio_metaplasico_w
	where	nr_sequencia = nr_seq_siscolo_cito_ava_w;
	commit;
end if;

--diagnostico
select	max(nr_sequencia)
into STRICT	nr_seq_sis_cito_dia_w
from	w_int_pathox_sis_cito_dia
where	nr_seq_siscolo	= nr_seq_siscolo_p and
	nr_prescricao 	= nr_prescricao_p;

begin
select	CASE WHEN ie_normalidade_mat='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_alter_inflamacao='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_metaplasia_esc='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_alter_reparacao='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_atrofia_inflam='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_alter_radiacao='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_alter_outras='3' THEN 'S'  ELSE 'N' END ,
	ds_alter_outras,
	CASE WHEN ie_lactobacilos='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_microb_cocos='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_micro_bacilos='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_micro_chlamydia='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_actinomyces_sp='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_candida_sp='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_trichomonas_vag='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_citopatico_herpes='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_bacilos_supracito='3' THEN 'S'  ELSE 'N' END ,
	CASE WHEN ie_microb_outras='3' THEN 'S'  ELSE 'N' END ,
	ds_microb_outras
into STRICT	ie_normalidade_mat_w,
	ie_alter_inflamacao_w,
	ie_metaplasia_esc_w,
	ie_alter_reparacao_w,
	ie_atrofia_inflam_w,
	ie_alter_radiacao_w,
	ie_alter_outras_w,
	ds_alter_outras_w,
	ie_lactobacilos_w,
	ie_microb_cocos_w,
	ie_micro_bacilos_w,
	ie_micro_chlamydia_w,
	ie_actinomyces_sp_w,
	ie_candida_sp_w,
	ie_trichomonas_vag_w,
	ie_citopatico_herpes_w,
	ie_bacilos_supracito_w,
	ie_microb_outras_w,
	ds_microb_outras_w
from	w_int_pathox_sis_cito_dia
where	nr_sequencia = nr_seq_sis_cito_dia_w;
exception when others then
	null;
end;

begin
select	nr_sequencia
into STRICT	nr_seq_siscolo_cito_dia_w
from	siscolo_cito_diagnostico
where	nr_seq_siscolo = nr_seq_siscolo_p;
exception when others then
	null;
end;

if (coalesce(nr_seq_siscolo_cito_dia_w::text, '') = '') then
	insert into siscolo_cito_diagnostico(
		nr_sequencia,
		dt_atualizacao,
		dt_atualizacao_nrec,
		nm_usuario,
		nm_usuario_nrec,
		nr_seq_siscolo,
		ie_normalidade_mat,
		ie_alter_inflamacao,
		ie_metaplasia_esc,
		ie_alter_reparacao,
		ie_atrofia_inflam,
		ie_alter_radiacao,
		ie_alter_outras,
		ds_alter_outras,
		ie_lactobacilos,
		ie_microb_cocos,
		ie_micro_bacilos,
		ie_micro_chlamydia,
		ie_actinomyces_sp,
		ie_candida_sp,
		ie_trichomonas_vag,
		ie_citopatico_herpes,
		ie_bacilos_supracito,
		ie_microb_outras,
		ds_microb_outras)
	values (nextval('siscolo_cito_diagnostico_seq'),
		clock_timestamp(),
		clock_timestamp(),
		coalesce(nm_usuario_p, wheb_usuario_pck.get_nm_usuario),
		coalesce(nm_usuario_p, wheb_usuario_pck.get_nm_usuario),
		nr_seq_siscolo_p,
		ie_normalidade_mat_w,
		ie_alter_inflamacao_w,
		ie_metaplasia_esc_w,
		ie_alter_reparacao_w,
		ie_atrofia_inflam_w,
		ie_alter_radiacao_w,
		ie_alter_outras_w,
		ds_alter_outras_w,
		ie_lactobacilos_w,
		ie_microb_cocos_w,
		ie_micro_bacilos_w,
		ie_micro_chlamydia_w,
		ie_actinomyces_sp_w,
		ie_candida_sp_w,
		ie_trichomonas_vag_w,
		ie_citopatico_herpes_w,
		ie_bacilos_supracito_w,
		ie_microb_outras_w,
		ds_microb_outras_w);
	commit;
else
	update	siscolo_cito_diagnostico
	set	dt_atualizacao = clock_timestamp(),
		nm_usuario = coalesce(nm_usuario_p, wheb_usuario_pck.get_nm_usuario),
		ie_normalidade_mat = ie_normalidade_mat_w,
		ie_alter_inflamacao = ie_alter_inflamacao_w,
		ie_metaplasia_esc = ie_metaplasia_esc_w,
		ie_alter_reparacao = ie_alter_reparacao_w,
		ie_atrofia_inflam = ie_atrofia_inflam_w,
		ie_alter_radiacao = ie_alter_radiacao_w,
		ie_alter_outras = ie_alter_outras_w,
		ds_alter_outras = ds_alter_outras_w,
		ie_lactobacilos = ie_lactobacilos_w,
		ie_microb_cocos = ie_microb_cocos_w,
		ie_micro_bacilos = ie_micro_bacilos_w,
		ie_micro_chlamydia = ie_micro_chlamydia_w,
		ie_actinomyces_sp = ie_actinomyces_sp_w,
		ie_candida_sp = ie_candida_sp_w,
		ie_trichomonas_vag = ie_trichomonas_vag_w,
		ie_citopatico_herpes = ie_citopatico_herpes_w,
		ie_bacilos_supracito = ie_bacilos_supracito_w,
		ie_microb_outras = ie_microb_outras_w,
		ds_microb_outras = ds_microb_outras_w
	where	nr_sequencia = nr_seq_siscolo_cito_dia_w;
	commit;
end if;

--atipias
select	max(nr_sequencia)
into STRICT	nr_seq_sis_cito_ati_w
from	w_int_pathox_sis_cito_ati
where	nr_seq_siscolo	= nr_seq_siscolo_p and
	nr_prescricao 	= nr_prescricao_p;

begin
select	CASE WHEN ie_atipicas_escamosas='1' THEN 'P' WHEN ie_atipicas_escamosas='2' THEN 'N'  ELSE null END ,
	CASE WHEN ie_atipicas_glandulares='1' THEN 'P' WHEN ie_atipicas_glandulares='2' THEN 'N'  ELSE null END ,
	CASE WHEN ie_atipicas_indefinidas='1' THEN 'P' WHEN ie_atipicas_indefinidas='2' THEN 'N'  ELSE null END ,
	CASE WHEN ie_atipias_escamosas='1' THEN 'H' WHEN ie_atipias_escamosas='2' THEN 'N' WHEN ie_atipias_escamosas='3' THEN 'M' WHEN ie_atipias_escamosas='4' THEN 'C'  ELSE null END ,
	CASE WHEN ie_atipias_gla_adeno='1' THEN 'A' WHEN ie_atipias_gla_adeno='2' THEN 'C' WHEN ie_atipias_gla_adeno='3' THEN 'E' WHEN ie_atipias_gla_adeno='4' THEN 'S'  ELSE null END ,
	CASE WHEN ie_neo_malignas='3' THEN 'S'  ELSE 'N' END ,
	ds_neo_malignas,
	CASE WHEN ie_celula_endometrial='3' THEN 'S'  ELSE 'N' END ,
	ds_obs_gerais,
	dt_liberacao,
	cd_cns_resp_result,
	cd_cpf_resp_result
into STRICT	ie_atipicas_escamosas_w,
	ie_atipicas_glandulares_w,
	ie_atipicas_indefinidas_w,
	ie_atipias_escamosas_w,
	ie_atipias_gla_adeno_w,
	ie_neo_malignas_w,
	ds_neo_malignas_w,
	ie_celula_endometrial_w,
	ds_obs_gerais_w,
	dt_liberacao_w,
	cd_cns_resp_result_w,
	cd_cpf_resp_result_w
from	w_int_pathox_sis_cito_ati
where	nr_sequencia = nr_seq_sis_cito_ati_w;
exception when others then
	null;
end;

begin
select	nr_sequencia
into STRICT	nr_seq_siscolo_atipias_w
from	siscolo_cito_atipias
where	nr_seq_siscolo = nr_seq_siscolo_p;
exception when others then
	null;
end;

if (coalesce(nr_seq_siscolo_atipias_w::text, '') = '') then
	insert into siscolo_cito_atipias(
		nr_sequencia,
		dt_atualizacao,
		dt_atualizacao_nrec,
		nm_usuario,
		nm_usuario_nrec,
		nr_seq_siscolo,
		ie_atipicas_escamosas,
		ie_atipicas_glandulares,
		ie_atipicas_indefinidas,
		ie_atipias_escamosas,
		ie_atipias_gla_adeno,
		ie_neo_malignas,
		ds_neo_malignas,
		ie_celula_endometrial,
		ds_obs_gerais,
		dt_liberacao,
		cd_cns_resp_result,
		cd_cpf_resp_result)
	values (nextval('siscolo_cito_atipias_seq'),
		clock_timestamp(),
		clock_timestamp(),
		coalesce(nm_usuario_p, wheb_usuario_pck.get_nm_usuario),
		coalesce(nm_usuario_p, wheb_usuario_pck.get_nm_usuario),
		nr_seq_siscolo_p,
		ie_atipicas_escamosas_w,
		ie_atipicas_glandulares_w,
		ie_atipicas_indefinidas_w,
		ie_atipias_escamosas_w,
		ie_atipias_gla_adeno_w,
		ie_neo_malignas_w,
		ds_neo_malignas_w,
		ie_celula_endometrial_w,
		ds_obs_gerais_w,
		dt_liberacao_w,
		cd_cns_resp_result_w,
		cd_cpf_resp_result_w);
	commit;
else
	update	siscolo_cito_atipias
	set 	dt_atualizacao = clock_timestamp(),
		nm_usuario = coalesce(nm_usuario_p, wheb_usuario_pck.get_nm_usuario),
		ie_atipicas_escamosas = ie_atipicas_escamosas_w,
		ie_atipicas_glandulares = ie_atipicas_glandulares_w,
		ie_atipicas_indefinidas = ie_atipicas_indefinidas_w,
		ie_atipias_escamosas = ie_atipias_escamosas_w,
		ie_atipias_gla_adeno = ie_atipias_gla_adeno_w,
		ie_neo_malignas = ie_neo_malignas_w,
		ds_neo_malignas = ds_neo_malignas_w,
		ie_celula_endometrial = ie_celula_endometrial_w,
		ds_obs_gerais = ds_obs_gerais_w,
		dt_liberacao = dt_liberacao_w,
		cd_cns_resp_result = cd_cns_resp_result_w,
		cd_cpf_resp_result = cd_cpf_resp_result_w
	where	nr_sequencia = nr_seq_siscolo_atipias_w;
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_siscolo_cito_pathox (nr_seq_siscolo_p siscolo_cito_avaliacao.nr_seq_siscolo%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nm_usuario_p usuario.nm_usuario%type default null) FROM PUBLIC;

