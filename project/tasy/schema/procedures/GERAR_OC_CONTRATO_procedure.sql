-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_oc_contrato ( cd_comprador_p text, dt_ordem_p timestamp, dt_inclusao_p timestamp, dt_entrega_p timestamp, nr_seq_contrato_p bigint, cd_estabelecimento_p bigint, cd_setor_atendimento_p bigint, cd_pessoa_solicitante_p text, cd_pessoa_fisica_p text, cd_cgc_fornecedor_p text, ie_frete_p text, cd_moeda_p bigint, ie_aviso_chegada_p text, ie_emite_obs_p text, ie_urgente_p text, nm_usuario_p text, cd_local_estoque_p bigint, ie_gerar_tributos_p text, vl_item_p bigint, dt_vencimento_p timestamp, nr_ordem_compra_p INOUT bigint) AS $body$
DECLARE


cd_cgc_contratado_w		varchar(14);
cd_pessoa_contratada_w		varchar(10);
cd_condicao_pagamento_w		bigint;
cd_unid_med_compra_w		varchar(30);
cd_material_w			integer;
cd_conta_contabil_w		varchar(20);
cd_centro_custo_w		integer;
nr_seq_crit_rateio_w		bigint;
nr_seq_conta_financ_w		bigint;
vl_pagto_w			double precision;
nr_ordem_compra_w		bigint;
nr_item_oci_w			integer;
ie_tipo_conta_w			integer	:= 2;
nr_seq_proj_rec_w		bigint;
ie_qtde_contrato_w		varchar(1);
qt_material_w			double precision;
nr_seq_regra_contrato_w		bigint;
cd_tributo_ww			bigint;
pr_tributo_ww			double precision;
vl_tributo_ww			double precision;
nm_usuario_ww			varchar(15);
nm_usuario_nrec_ww		varchar(15);
dt_atualizacao_ww		timestamp;
dt_atualizacao_nrec_ww		timestamp;
ie_corpo_item_w			varchar(1);
ds_observacao_w			varchar(255);
vl_total_item_w			ordem_compra_item.vl_total_item%type;
ie_regra_trib_w			contrato_regra_pagto_trib.ie_regra_trib%type;
ie_corpo_atrib_w		tributo.ie_corpo_item%type;
ie_somente_pagto_w		ordem_compra.ie_somente_pagto%type;
ds_complemento_w		contrato_regra_nf.ds_complemento%type;
ds_obs_item_w			contrato_regra_nf.ds_observacao%type;
ie_copiar_ds_compl_oc_w		parametro_compras.ie_copiar_ds_compl_oc%type;
ie_preco_ordem_compra_w		contrato_regra_nf.ie_preco_oc%type;
ie_forma_pagamento_w		condicao_pagamento.ie_forma_pagamento%type;
vl_total_oc_w			ordem_compra_venc.vl_vencimento%type;
vl_desconto_w			contrato_regra_nf.vl_desconto%type;
pr_desconto_w			contrato_regra_nf.pr_desconto%type;
nr_seq_marca_w			contrato_regra_nf.nr_seq_marca%type;
cd_paciente_soli_compra_w	contrato_regra_nf.cd_paciente_soli_compra%type;
pr_desc_financ_w		contrato_regra_pagto.pr_desc_financ%type;

c01 CURSOR FOR
SELECT	a.cd_material,
	a.cd_conta_contabil,
	CASE WHEN coalesce(a.nr_seq_crit_rateio::text, '') = '' THEN  a.cd_centro_custo  ELSE null END  cd_centro_custo,
	a.nr_seq_crit_rateio,
	a.nr_seq_conta_financ,
	a.vl_pagto,
	a.nr_seq_proj_rec,
	CASE WHEN ie_qtde_contrato_w='S' THEN coalesce(obter_contrato_regra_nf_qtde(a.nr_sequencia, clock_timestamp()),1)  ELSE 1 END ,
	a.nr_sequencia,
	CASE WHEN ie_copiar_ds_compl_oc_w='N' THEN null  ELSE a.ds_complemento END ,
	a.ds_observacao,
	a.vl_desconto,
	a.pr_desconto,
	a.cd_paciente_soli_compra
from	contrato b,
	contrato_regra_nf a
where	b.nr_sequencia 	= a.nr_seq_contrato
and	b.nr_sequencia	= nr_seq_contrato_p
and	coalesce(ie_tipo_regra,'NF') = 'NF'
and	((coalesce(a.dt_inicio_vigencia::text, '') = '') or (trunc(a.dt_inicio_vigencia,'dd') <= trunc(clock_timestamp(),'dd')))
and	((coalesce(a.dt_fim_vigencia::text, '') = '') or (trunc(a.dt_fim_vigencia,'dd') >= trunc(clock_timestamp(),'dd')))
and	((coalesce(a.cd_estab_regra::text, '') = '') or (a.cd_estab_regra = cd_estabelecimento_p) or (exists (	SELECT	1
												from	contrato_regra_nf_estab x
												where	x.cd_estab_regra = cd_estabelecimento_p
												and	x.nr_seq_regra_nf = a.nr_sequencia)))
and (coalesce(a.ie_situacao::text, '') = '' or a.ie_situacao = 'A');

c02 CURSOR FOR
SELECT	distinct a.cd_tributo
from	contrato_regra_pagto_trib a
where	a.nr_seq_regra_nf = nr_seq_regra_contrato_w;


BEGIN

select	coalesce(obter_valor_param_usuario(917, 134, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p),'N')
into STRICT	ie_qtde_contrato_w
;

select	cd_cgc_contratado,
	cd_pessoa_contratada,
	cd_condicao_pagamento,
	ie_somente_oc_pagto
into STRICT	cd_cgc_contratado_w,
	cd_pessoa_contratada_w,
	cd_condicao_pagamento_w,
	ie_somente_pagto_w
from	contrato
where	nr_sequencia = nr_seq_contrato_p;

select 	obter_desconto_financ_contr(nr_seq_contrato_p)
into STRICT   	pr_desc_financ_w
;

select	coalesce(ie_copiar_ds_compl_oc,'N')
into STRICT	ie_copiar_ds_compl_oc_w
from	parametro_compras
where	cd_estabelecimento = cd_estabelecimento_p;

if (cd_cgc_fornecedor_p IS NOT NULL AND cd_cgc_fornecedor_p::text <> '') then
	begin
	cd_cgc_contratado_w	:= cd_cgc_fornecedor_p;
	cd_pessoa_contratada_w	:= null;
	end;
elsif (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
	begin
	cd_cgc_contratado_w	:= null;
	cd_pessoa_contratada_w	:= cd_pessoa_fisica_p;
	end;
end if;

if (coalesce(cd_condicao_pagamento_w::text, '') = '') then
	/*(-20011,'Nao existe condicao de pagamento informada no contrato selecionado.');*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(187504);
end if;

if (coalesce(cd_cgc_contratado_w::text, '') = '') and (coalesce(cd_pessoa_contratada_w::text, '') = '') then
	/*(-20011,'Nao existe pessoa fisica ou juridica informada no contrato para a geracao da ordem de compras.');*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(187505);
end if;

select nextval('ordem_compra_seq')
into STRICT nr_ordem_compra_w
;

select	substr( Wheb_mensagem_pck.get_Texto(301897,'DS_OBJETO_CONTRATO_W='|| DS_OBJETO_CONTRATO ),1,255)
into STRICT	ds_observacao_w
from	contrato
where	nr_sequencia = nr_seq_contrato_p;

insert into ordem_compra(
	nr_ordem_compra,
	cd_estabelecimento,
	cd_cgc_fornecedor,
	cd_condicao_pagamento,
	cd_comprador,
	dt_ordem_compra,
	dt_atualizacao,
	nm_usuario,
	cd_moeda,
	ie_situacao,
	dt_inclusao,
	cd_pessoa_solicitante,
	ie_frete,
	vl_frete,
	pr_desconto,
	pr_desc_pgto_antec,
	pr_juros_negociado,
	dt_entrega,
	ie_aviso_chegada,
	cd_pessoa_fisica,
	ie_emite_obs,
	ie_urgente,
	cd_setor_atendimento,
	pr_desc_financeiro,
	vl_desconto,
	ie_somente_pagto,
	ie_tipo_ordem,
	cd_local_entrega,
	nr_seq_contrato,
	ds_observacao)
values (	nr_ordem_compra_w,
	cd_estabelecimento_p,
	cd_cgc_contratado_w,
	cd_condicao_pagamento_w,
	cd_comprador_p,
	dt_ordem_p,
	clock_timestamp(),
	nm_usuario_p,
	cd_moeda_p,
	'A',
	dt_inclusao_p,
	cd_pessoa_solicitante_p,
	ie_frete_p,
	0,
	0,
	0,
	0,
	dt_entrega_p,
	ie_aviso_chegada_p,
	cd_pessoa_contratada_w,
	ie_emite_obs_p,
	ie_urgente_p,
	cd_setor_atendimento_p,
	pr_desc_financ_w,
	0,
	coalesce(ie_somente_pagto_w,'N'),
	'C',
	cd_local_estoque_p,
	nr_seq_contrato_p,
	ds_observacao_w);
	
	
open C01;
loop
fetch C01 into	
	cd_material_w,
	cd_conta_contabil_w,
	cd_centro_custo_w,
	nr_seq_crit_rateio_w,
	nr_seq_conta_financ_w,
	vl_pagto_w,
	nr_seq_proj_rec_w,
	qt_material_w,
	nr_seq_regra_contrato_w,
	ds_complemento_w,
	ds_obs_item_w,
	vl_desconto_w,
	pr_desconto_w,
	cd_paciente_soli_compra_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	select	substr(obter_dados_material_estab(cd_material,cd_estabelecimento_p,'UMC'),1,30) cd_unidade_medida_compra
	into STRICT  	cd_unid_med_compra_w
	from	material
	where	cd_material = cd_material_w;
	
	select	coalesce(max(nr_item_oci),0) + 1
	into STRICT	nr_item_oci_w
	from	ordem_compra_item
	where	nr_ordem_compra = nr_ordem_compra_w;
	
	if (coalesce(cd_conta_contabil_w::text, '') = '') then
		if (coalesce(cd_centro_custo_w::text, '') = '') then
			ie_tipo_conta_w	:= 2;
		else
			ie_tipo_conta_w	:= 3;
		end if;

		SELECT * FROM define_conta_material(	cd_estabelecimento_p, cd_material_w, ie_tipo_conta_w, null, null, null, null, null, null, null, cd_local_estoque_p, Null, dt_ordem_p, cd_conta_contabil_w, cd_centro_custo_w, null) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w;
	end if;
	
	if (nr_seq_regra_contrato_w > 0) then
	
		select	coalesce(ie_preco_oc,'V'), nr_seq_marca
		into STRICT	ie_preco_ordem_compra_w,
				nr_seq_marca_w
		from	contrato_regra_nf
		where	nr_sequencia = nr_seq_regra_contrato_w;
		
		if (vl_item_p > 0) and (ie_preco_ordem_compra_w = 'V') then
			vl_pagto_w := vl_item_p;
		end if;
	end if;
	
	vl_total_item_w	:= qt_material_w * vl_pagto_w;
	
	insert into ordem_compra_item(
		nr_ordem_compra,
		nr_item_oci,
		cd_material,
		cd_unidade_medida_compra,
		vl_unitario_material,
		qt_material,
		qt_original,
		dt_atualizacao,
		nm_usuario,
		ie_situacao,
		cd_pessoa_solicitante,
		pr_descontos,
		cd_local_estoque,
		vl_item_liquido,
		cd_centro_custo,
		cd_conta_contabil,
		pr_desc_financ,
		nr_seq_conta_financ,
		nr_seq_criterio_rateio,
		vl_desconto,
		ie_geracao_solic,
		nr_contrato,
		nr_seq_proj_rec,
		nr_seq_regra_contrato,
		vl_total_item,
		ds_material_direto,
		nr_seq_marca,
		ds_observacao,
		cd_paciente_ordem_compra)
	values (	nr_ordem_compra_w,
		nr_item_oci_w,
		cd_material_w,
		cd_unid_med_compra_w,
		vl_pagto_w,
		qt_material_w,
		qt_material_w,
		clock_timestamp(),
		nm_usuario_p,
		'A',
		cd_pessoa_solicitante_p,
		coalesce(pr_desconto_w,0),
		cd_local_estoque_p,
		vl_pagto_w,
		cd_centro_custo_w,
		cd_conta_contabil_w,
		0,
		nr_seq_conta_financ_w,
		nr_seq_crit_rateio_w,
		coalesce(vl_desconto_w,0),
		'U',
		nr_seq_contrato_p,
		nr_seq_proj_rec_w,
		nr_seq_regra_contrato_w,
		vl_total_item_w,
		ds_complemento_w,
		nr_seq_marca_w,
		ds_obs_item_w,
		cd_paciente_soli_compra_w);

	insert into ordem_compra_item_entrega(
		nr_ordem_compra,
		nr_item_oci,
		dt_prevista_entrega,
		qt_prevista_entrega,
		dt_atualizacao,
		nm_usuario,
		nr_sequencia)
	values (	nr_ordem_compra_w,
		nr_item_oci_w,
		dt_entrega_p,
		qt_material_w,
		clock_timestamp(),
		nm_usuario_p,
		nextval('ordem_compra_item_entrega_seq'));
	
	if (ie_gerar_tributos_p = 'S') then
		begin
		open c02;
		loop
		fetch c02 into	
			cd_tributo_ww;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
			
			select	max(a.pr_tributo),
				max(a.vl_tributo),
				max(a.ie_corpo_item),
				max(coalesce(a.ie_regra_trib,'N'))
			into STRICT	pr_tributo_ww,
				vl_tributo_ww,
				ie_corpo_item_w,
				ie_regra_trib_w
			from	contrato_regra_pagto_trib a,
				contrato_regra_nf b
			where	a.nr_seq_regra_nf = b.nr_sequencia
			and	b.cd_material = cd_material_w
			and	a.cd_tributo = cd_tributo_ww
			and	b.nr_seq_contrato = nr_seq_contrato_p;
			
			if (vl_item_p > 0 and pr_tributo_ww > 0) then
				
				vl_tributo_ww	:= dividir((vl_total_item_w * pr_tributo_ww), 100);
			end if;
			
			if (ie_regra_trib_w = 'S') then
				
				select	max(a.ie_corpo_item)
				into STRICT	ie_corpo_atrib_w
				from	tributo a,
					contrato_regra_pagto_trib b,
					contrato_regra_nf c
				where 	a.cd_tributo		= b.cd_tributo
				and 	b.nr_seq_regra_nf 	= c.nr_sequencia
				and	c.nr_seq_contrato 	= nr_seq_contrato_p;	
				
				ie_corpo_item_w := ie_corpo_atrib_w;
			end if;
			
			insert into ordem_compra_item_trib(
				nr_ordem_compra,
				nr_item_oci,
				cd_tributo,
				pr_tributo,
				vl_tributo,
				nm_usuario,
				nm_usuario_nrec,
				dt_atualizacao,
				dt_atualizacao_nrec,
				ie_corpo_item)
			values (	nr_ordem_compra_w,
				nr_item_oci_w,
				cd_tributo_ww,
				pr_tributo_ww,
				vl_tributo_ww,
				nm_usuario_p,
				nm_usuario_p,
				clock_timestamp(),
				clock_timestamp(),
				ie_corpo_item_w);
			end;
		end loop;
		close c02;
		end;
	end if;	
	end;
end loop;
close C01;

select	coalesce(max(ie_forma_pagamento),0)
into STRICT	ie_forma_pagamento_w
from	condicao_pagamento
where	cd_condicao_pagamento = cd_condicao_pagamento_w;

select	round((coalesce(sum(obter_valor_liquido_ordem(nr_ordem_compra)), 0))::numeric, 2)
into STRICT	vl_total_oc_w
from	ordem_compra
where	nr_ordem_compra = nr_ordem_compra_w;

if (ie_forma_pagamento_w <> 10) then
	begin
	CALL Gerar_Ordem_Compra_Venc(nr_ordem_compra_w, nm_usuario_p);
	end;
else
	begin
	insert into ordem_compra_venc(
		nr_ordem_compra,
		nr_item_oc_venc,
		dt_vencimento,
		vl_vencimento,
		dt_atualizacao,
		nm_usuario,
		ie_inf_calc,
		ie_gerar_adiantamento)
	values (	nr_ordem_compra_w,
		1,
		dt_vencimento_p,								
		vl_total_oc_w,
		clock_timestamp(),
		nm_usuario_p,
		'C',
		'N');
	end;
end if;

commit;

nr_ordem_compra_p	:= nr_ordem_compra_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_oc_contrato ( cd_comprador_p text, dt_ordem_p timestamp, dt_inclusao_p timestamp, dt_entrega_p timestamp, nr_seq_contrato_p bigint, cd_estabelecimento_p bigint, cd_setor_atendimento_p bigint, cd_pessoa_solicitante_p text, cd_pessoa_fisica_p text, cd_cgc_fornecedor_p text, ie_frete_p text, cd_moeda_p bigint, ie_aviso_chegada_p text, ie_emite_obs_p text, ie_urgente_p text, nm_usuario_p text, cd_local_estoque_p bigint, ie_gerar_tributos_p text, vl_item_p bigint, dt_vencimento_p timestamp, nr_ordem_compra_p INOUT bigint) FROM PUBLIC;

