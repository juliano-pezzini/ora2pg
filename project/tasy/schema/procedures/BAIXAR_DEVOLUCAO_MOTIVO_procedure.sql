-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baixar_devolucao_motivo ( nr_devolucao_p bigint, cd_tipo_baixa_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_pessoa_usuario_w			varchar(10);
ie_atualiza_estoque_w		varchar(1);
ie_atualiza_conta_w			varchar(1);
nr_sequencia_w			bigint;
qt_item_nao_baixado_w		bigint;
ie_cancelar_autor_w		varchar(2);
nr_prescricao_w			bigint;
nr_sequencia_prescricao_w	integer;

c01 CURSOR FOR 
SELECT	a.nr_sequencia, 
	a.nr_prescricao, 
	a.nr_sequencia_prescricao 
from	item_devolucao_material_pac a 
where	a.nr_devolucao = nr_devolucao_p 
and	coalesce(a.qt_material_estoque,0) = 0 
and	coalesce(a.nm_usuario_receb::text, '') = '' 
and	coalesce(a.dt_recebimento::text, '') = '';


BEGIN 
 
select	coalesce(max(ie_atualiza_estoque),'N'), 
	coalesce(max(ie_conta_paciente),'N'), 
	coalesce(max(ie_cancelar_autor),'N') 
into STRICT	ie_atualiza_estoque_w, 
	ie_atualiza_conta_w, 
	ie_cancelar_autor_w 
from	tipo_baixa_prescricao 
where	cd_tipo_baixa = cd_tipo_baixa_p 
and	ie_prescricao_devolucao = 'D';
 
if (ie_atualiza_estoque_w = 'S') or (ie_atualiza_conta_w = 'S') then 
	-- Para baixar por motivo, o tipo de baixa n√£o deve atualizar a conta ou o estoque! 
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(264810,'');
end if;
 
select	substr(obter_pessoa_fisica_usuario(nm_usuario_p, 'C'),1,10) 
into STRICT	cd_pessoa_usuario_w
;
 
open c01;
loop 
fetch c01 into 
	nr_sequencia_w, 
	nr_prescricao_w, 
	nr_sequencia_prescricao_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	update	item_devolucao_material_pac 
	set	qt_material_estoque		= 0, 
		ie_tipo_baixa_estoque	= cd_tipo_baixa_p, 
		dt_recebimento		= clock_timestamp(), 
		cd_pessoa_fisica_receb	= cd_pessoa_usuario_w, 
		nm_usuario_receb		= nm_usuario_p, 
		nm_usuario			= nm_usuario_p 
	where	nr_devolucao			= nr_devolucao_p 
	and	nr_sequencia			= nr_sequencia_w;
 
	/* Francisco - OS 79511 - 08/04/2008 */
 
	if (ie_cancelar_autor_w = 'S') and (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') and (nr_sequencia_prescricao_w IS NOT NULL AND nr_sequencia_prescricao_w::text <> '') then 
 
		CALL suspender_autor_convenio(nr_prescricao_w,null,nr_sequencia_prescricao_w,nm_usuario_p);
	end if;
 
end loop;
close c01;
 
select	count(*) 
into STRICT	qt_item_nao_baixado_w 
from	item_devolucao_material_pac a 
where	a.nr_devolucao = nr_devolucao_p 
and	coalesce(a.dt_recebimento::text, '') = '' 
and	coalesce(a.nm_usuario_receb::text, '') = '';
 
if (qt_item_nao_baixado_w = 0) then 
 
	update	devolucao_material_pac 
	set	dt_baixa_total	= clock_timestamp(), 
		nm_usuario_baixa	= nm_usuario_p 
	where	nr_devolucao		= nr_devolucao_p;
end if;
 
commit;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baixar_devolucao_motivo ( nr_devolucao_p bigint, cd_tipo_baixa_p bigint, nm_usuario_p text) FROM PUBLIC;

