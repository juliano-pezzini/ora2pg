-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE exclui_comunic_interna () AS $body$
DECLARE



qt_dia_w			bigint;
nr_seq_classif_w		bigint;
cd_perfil_destino_w		integer;
cd_setor_destino_w		integer;
nr_seq_grupo_usu_destino_w	bigint;
nm_usuario_destino_w	varchar(15);
ie_abrangencia_w		varchar(15);
nr_sequencia_w		bigint;

C01 CURSOR FOR
	SELECT	qt_dia,
		nr_seq_classif,
		cd_perfil_destino,
		cd_setor_destino,
		nr_seq_grupo_usu_destino,
		nm_usuario_destino,
		ie_abrangencia
	from	comunic_interna_regra_excl
	where	ie_situacao  = 'A';

C02 CURSOR FOR
	SELECT	nr_sequencia
	from	comunic_interna
	where	((nr_seq_classif = nr_seq_classif_w) or (coalesce(nr_seq_classif_w,0) = 0))
	and	((coalesce(cd_perfil_destino_w,0) = 0) or
		((obter_se_contido_char(cd_perfil_destino_w, replace(ds_perfil_adicional,' ','')) = 'S') and (instr(ds_perfil_adicional,',',position(',' in ds_perfil_adicional)+1) = 0)))
	and	((coalesce(cd_setor_destino_w,0) = 0) or
		((obter_se_contido_char(cd_setor_destino_w, replace(ds_setor_adicional,' ','')) = 'S') and (instr(ds_setor_adicional,',',position(',' in ds_setor_adicional)+1) = 0)))
	and	((coalesce(nr_seq_grupo_usu_destino_w,0) = 0) or
		((obter_se_contido_char(nr_seq_grupo_usu_destino_w, replace(ds_grupo,' ','')) = 'S') and (instr(ds_grupo,',',position(',' in ds_grupo)+1) = 0)))
	and	((coalesce(nm_usuario_destino_w,'0') = '0') or
		((nm_usuario_destino like to_char(Chr(37)||nm_usuario_destino_w||Chr(37))) and (instr(nm_usuario_destino,',',position(',' in nm_usuario_destino)+1) = 0)))
	and (obter_dias_entre_datas(dt_comunicado,clock_timestamp()) >= qt_dia_w)
	and	ie_abrangencia_w = 'E'
	
union

	SELECT	nr_sequencia
	from	comunic_interna
	where	((nr_seq_classif = nr_seq_classif_w) or (coalesce(nr_seq_classif_w,0) = 0))
	and	((coalesce(cd_perfil_destino_w,0) = 0) or (obter_se_contido_char(cd_perfil_destino_w, replace(ds_perfil_adicional,' ','')) = 'S'))
	and	((coalesce(cd_setor_destino_w,0) = 0) or (obter_se_contido_char(cd_setor_destino_w, replace(ds_setor_adicional,' ','')) = 'S'))
	and	((coalesce(nr_seq_grupo_usu_destino_w,0) = 0) or (obter_se_contido_char(nr_seq_grupo_usu_destino_w, replace(ds_grupo,' ','')) = 'S'))
	and	((coalesce(nm_usuario_destino_w,'0') = '0') or (nm_usuario_destino like to_char(Chr(37)||nm_usuario_destino_w||Chr(37))))
	and (obter_dias_entre_datas(dt_comunicado,clock_timestamp()) >= qt_dia_w)
	and	ie_abrangencia_w = 'Q';


BEGIN
open C01;
loop
fetch C01 into
	qt_dia_w,
	nr_seq_classif_w,
	cd_perfil_destino_w,
	cd_setor_destino_w,
	nr_seq_grupo_usu_destino_w,
	nm_usuario_destino_w,
	ie_abrangencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	open C02;
	loop
	fetch C02 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		delete	from alerta_tasy_ocor
		where	nr_seq_comunic = nr_sequencia_w;

		delete	from comunic_interna_arq
		where	nr_seq_comunic = nr_sequencia_w;

		delete	from comunic_interna_lida
		where	nr_sequencia = nr_sequencia_w;

		delete	from tasy_dica_interna_java
		where	nr_seq_comunic_interna = nr_sequencia_w;

		delete	from comunic_interna
		where	nr_sequencia = nr_sequencia_w;

		end;
	end loop;
	close C02;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE exclui_comunic_interna () FROM PUBLIC;

