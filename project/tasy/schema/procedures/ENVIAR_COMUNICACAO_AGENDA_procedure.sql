-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_comunicacao_agenda (cd_estabelecimento_p bigint, nr_seq_agenda_p bigint, ds_lista_usuario_p text, ds_lista_setor_p text, ds_lista_perfil_p text, ie_tipo_comunicacao_p text, nm_usuario_p text, hr_inicio_p timestamp) AS $body$
DECLARE

 
nr_sequencia_w		bigint;
ds_titulo_w		varchar(255);
ds_mensagem_w		varchar(1000);
nm_paciente_w		varchar(80);
dt_agenda_w		timestamp;
nr_atendimento_w	bigint;
ds_motivo_cancel_w	varchar(255);
ds_procedimento_w	varchar(200);
nm_cirurgiao_w		varchar(80);


BEGIN 
if (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') and 
	((ds_lista_usuario_p IS NOT NULL AND ds_lista_usuario_p::text <> '') or (ds_lista_setor_p IS NOT NULL AND ds_lista_setor_p::text <> '') or (ds_lista_perfil_p IS NOT NULL AND ds_lista_perfil_p::text <> '')) and (ie_tipo_comunicacao_p IS NOT NULL AND ie_tipo_comunicacao_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then 
	/* obter dados agenda */
 
	select	substr(coalesce(obter_nome_pf(a.cd_pessoa_fisica),a.nm_paciente),1,80), 
		a.hr_inicio, 
		a.nr_atendimento, 
		substr(obter_valor_dominio(1011,a.cd_motivo_cancelamento),1,100), 
		coalesce(substr(obter_nome_pf(a.cd_medico_exec),1,80), substr(obter_nome_pf(a.cd_medico),1,80)), 
		substr(obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced),1,200) 
	into STRICT	nm_paciente_w, 
		dt_agenda_w, 
		nr_atendimento_w, 
		ds_motivo_cancel_w, 
		nm_cirurgiao_w, 
		ds_procedimento_w 
	from	agenda_paciente a 
	where	a.nr_sequencia = nr_seq_agenda_p;
 
	/* classificar comunicação */
 
	if (ie_tipo_comunicacao_p = 'C') then 
		ds_titulo_w	:= Wheb_mensagem_pck.get_texto(307954) || '.'; --'Cancelamento de agenda.'; 
		ds_mensagem_w	:= Wheb_mensagem_pck.get_texto(308027, 'NM_PACIENTE_W='||nm_paciente_w||';DT_AGENDA_W='||to_char(dt_agenda_w, 'dd/mm/yyyy hh24:mi:ss')||
															  ';NR_ATENDIMENTO_W='||nr_atendimento_w||';DS_MOTIVO_CANCEL_W='||ds_motivo_cancel_w|| 
															  ';NM_CIRURGIAO_W='||nm_cirurgiao_w||';DS_PROCEDIMENTO_W='||ds_procedimento_w);
		      /*'Cancelamento da agenda do paciente: ' || nm_paciente_w || chr(10) || 
				  'Data: ' || to_char(dt_agenda_w, 'dd/mm/yyyy hh24:mi:ss') || chr(10) || 
				  'Atendimento: ' || nr_atendimento_w || chr(10) || 
				  'Motivo do cancelamento: ' || ds_motivo_cancel_w || chr(10) || 
				  'Cirurgião: ' || nm_cirurgiao_w || chr(10) || 
				  'Procedimento: ' || ds_procedimento_W;*/
 
	elsif (ie_tipo_comunicacao_p = 'T') then 
		ds_titulo_w	:= Wheb_mensagem_pck.get_texto(308024) || '.'; --'Transferência de agenda.'; 
		ds_mensagem_w	:= Wheb_mensagem_pck.get_texto(308029, 'NM_PACIENTE_W='||nm_paciente_w||';HR_INICIO_P='||to_char(hr_inicio_p, 'dd/mm/yyyy hh24:mi:ss')||
															  ';DT_AGENDA_W='||to_char(dt_agenda_w, 'dd/mm/yyyy hh24:mi:ss')||';NR_ATENDIMENTO_W='||nr_atendimento_w || 
															  ';NM_CIRURGIAO_W='||nm_cirurgiao_w||';DS_PROCEDIMENTO_W='||ds_procedimento_w);
		      /*'Transferência da agenda do paciente: ' || nm_paciente_w || chr(10) || 
				  'Data origem: ' || to_char(hr_inicio_p, 'dd/mm/yyyy hh24:mi:ss') || ' Data destino: ' || to_char(dt_agenda_w, 'dd/mm/yyyy hh24:mi:ss') || chr(10) || 
				  'Atendimento: ' || nr_atendimento_w || chr(10) || 
				  'Cirurgião: ' || nm_cirurgiao_w || chr(10) || 
				  'Procedimento: ' || ds_procedimento_w;*/
 
	end if;
 
	/* gerar comunicação interna */
 
	select	nextval('comunic_interna_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	insert into comunic_interna( 
					dt_comunicado, 
					ds_titulo, 
					ds_comunicado, 
					nm_usuario, 
					dt_atualizacao, 
					ie_geral, 
					nm_usuario_destino, 
					cd_perfil, 
					nr_sequencia, 
					ie_gerencial, 
					nr_seq_classif, 
					ds_perfil_adicional, 
					cd_setor_destino, 
					cd_estab_destino, 
					ds_setor_adicional, 
					dt_liberacao, 
					ds_grupo) 
				values ( 
					clock_timestamp(), 
					ds_titulo_w, 
					ds_mensagem_w, 
					nm_usuario_p, 
					clock_timestamp(), 
					'N', 
					ds_lista_usuario_p, 
					null, 
					nr_sequencia_w, 
					'N', 
					null, 
					ds_lista_perfil_p, 
					null, 
					cd_estabelecimento_p, 
					ds_lista_setor_p, 
					clock_timestamp(), 
					null);
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_comunicacao_agenda (cd_estabelecimento_p bigint, nr_seq_agenda_p bigint, ds_lista_usuario_p text, ds_lista_setor_p text, ds_lista_perfil_p text, ie_tipo_comunicacao_p text, nm_usuario_p text, hr_inicio_p timestamp) FROM PUBLIC;

