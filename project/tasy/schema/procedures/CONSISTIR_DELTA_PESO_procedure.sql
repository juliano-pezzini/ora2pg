-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_delta_peso ( nr_atendimento_p bigint, qt_peso_novo_p bigint, qt_delta_peso_p INOUT bigint, dt_delta_peso_p INOUT timestamp, nm_usuario_p text ) AS $body$
DECLARE


    qt_peso_antigo_w		double precision;
    qt_delta_peso_w			double precision;
    dt_sinal_vital_w		timestamp;
    sql_w                   varchar(250);


BEGIN
    select  max(a.qt_peso),
        max(a.dt_sinal_vital)
    into STRICT	qt_peso_antigo_w,
        dt_sinal_vital_w
    from    atendimento_sinal_vital a
    where   a.nr_atendimento = nr_atendimento_p
    and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
    and	coalesce(a.dt_inativacao::text, '') = ''
    and     a.nr_sequencia = (SELECT max(e.nr_sequencia)
                            from   atendimento_sinal_vital e
                            where  e.nr_atendimento = nr_atendimento_p
                and	(e.qt_peso IS NOT NULL AND e.qt_peso::text <> ''));

    begin
        sql_w := 'CALL OBTER_QT_DELTA_PESO_MD(:1, :2) INTO :qt_delta_peso_w';
        EXECUTE sql_w USING IN qt_peso_novo_p, IN qt_peso_antigo_w, OUT qt_delta_peso_w;
    exception
        when others then
            qt_delta_peso_w := null;
    end;
    qt_delta_peso_p := qt_delta_peso_w;
    dt_delta_peso_p	:= dt_sinal_vital_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_delta_peso ( nr_atendimento_p bigint, qt_peso_novo_p bigint, qt_delta_peso_p INOUT bigint, dt_delta_peso_p INOUT timestamp, nm_usuario_p text ) FROM PUBLIC;

