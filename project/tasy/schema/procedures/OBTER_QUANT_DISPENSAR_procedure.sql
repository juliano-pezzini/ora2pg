-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_quant_dispensar (cd_estabelecimento_p bigint, cd_material_p bigint, nr_prescricao_p bigint, nr_sequencia_p bigint, cd_intervalo_p text, ie_via_aplicacao_p text, qt_unitaria_p bigint, qt_dose_esp_p bigint, nr_ocorrencia_p bigint, ds_dose_dif_p text, ie_origem_inf_p text, cd_unid_med_dose_p text, qt_dias_p bigint, qt_material_p INOUT bigint, qt_dispensar_p INOUT bigint, ie_regra_disp_p INOUT text, ds_erro_p INOUT text, ie_se_necessario_p text, ie_acm_p text ) AS $body$
DECLARE


qt_unitaria_w				double precision 	:= 0;
qt_dose_esp_w				double precision 	:= 0;
qt_dispensar_w				double precision 	:= 0;
qt_material_w				double precision	:= 0;
qt_multiplo_w				double precision	:= 0;
qt_max_pres_w				double precision	:= 0;
nr_multiplo_w				double precision	:= 0;
qt_mat_w					bigint;
cd_unid_med_w				varchar(30);
ie_regra_disp_w				varchar(1);
ie_regra_w					varchar(1);
cd_convenio_w				integer	:= 0;
cd_setor_w					integer	:= 0;
nr_atendimento_w			bigint	:= 0;
qt_conversao_w				double precision	:= 0;
cd_unidade_medida_w			varchar(30);
cd_unidade_medida_estoque_w		varchar(30);
qt_dias_w					integer	:= 1;
ie_usuario_def_disp_w			varchar(1);
cd_perfil_w					bigint;
IE_MOTIVO_PRESCRICAO_w		varchar(3);
cd_material_estoque_w   	integer;
ie_info_rastre_prescr_w		varchar(1);
ds_alteracao_rastre_w		varchar(1800);
nm_usuario_w				usuario.nm_usuario%type;
qt_material_dose_dif_w double precision	:= 0;
EXEC_w varchar(200);

/*
cd_unidade_medida_dose_w		Varchar2(30);
cd_unid_med_cursor_w		Varchar2(30);
ie_unidade_medida_w		varchar2(1); */
C01 CURSOR FOR
	SELECT	ie_regra,
			ie_regra_disp,
			coalesce(ie_usuario_def_disp,'N')
	from	material_regra_disp
	where	1 = 1
	and		(((coalesce(cd_unid_med_w,cd_unidade_medida) = cd_unidade_medida) and (ie_unidade_medida = 1)) or
			 ((coalesce(cd_unid_med_dose_p,cd_unidade_medida) = cd_unidade_medida) and (ie_unidade_medida = 2)) or
			 ((coalesce(cd_unidade_medida_estoque_w,cd_unidade_medida) = cd_unidade_medida) and (ie_unidade_medida = 3)) or (coalesce(cd_unidade_medida::text, '') = ''))
	and		(((coalesce(ie_acm_sn,'X') = 'N') and (coalesce(ie_acm_p,'N')  = 'N') and (coalesce(ie_se_necessario_p,'N') = 'N')) or
			 ((coalesce(ie_acm_sn,'X') = 'S') and
			  ((coalesce(ie_acm_p,'N') = 'S') or (coalesce(ie_se_necessario_p,'N') = 'S'))) or (coalesce(ie_acm_sn,'X') = 'X'))
	and		coalesce(cd_unid_med_estoque, cd_unidade_medida_estoque_w) = cd_unidade_medida_estoque_w
	and		((coalesce(ie_via_aplicacao::text, '') = '') or (coalesce(ie_via_aplicacao, ie_via_aplicacao_p) = ie_via_aplicacao_p))
	and		((coalesce(cd_intervalo::text, '') = '') or (coalesce(cd_intervalo, cd_intervalo_p) = cd_intervalo_p))
	and		coalesce(cd_convenio, cd_convenio_w)		= cd_convenio_w
	and		coalesce(cd_setor_atendimento,cd_setor_w)	= cd_setor_w
	and		(((coalesce(cd_material, cd_material_p)	= cd_material_p) and (coalesce(ie_material_estoque,'N') = 'N')) or
			((coalesce(cd_material, cd_material_estoque_w)	= cd_material_estoque_w) and (coalesce(ie_material_estoque,'N') = 'S')))
	and		coalesce(cd_perfil, cd_perfil_w) = cd_perfil_w
	and		cd_estabelecimento	= cd_estabelecimento_p
	and 	((coalesce(ie_motivo_prescricao::text, '') = '') or (ie_motivo_prescricao = ie_motivo_prescricao_w))
	and		((coalesce(nr_seq_estrut_int::text, '') = '') or (consistir_se_mat_estrutura(nr_seq_estrut_int,cd_material_p) = 'S'))
	order by coalesce(cd_material,0),
		--nvl(ie_unidade_medida,0),
		coalesce(cd_convenio,0),
		coalesce(cd_setor_atendimento,0),
		coalesce(cd_unidade_medida,'zzzz') desc,
		coalesce(ie_via_aplicacao,'zzzz') desc,
		CASE WHEN coalesce(cd_intervalo::text, '') = '' THEN 1   ELSE 0 END  desc,
		coalesce(nr_seq_estrut_int,0),
		coalesce(cd_perfil,0);

/* Marcus 15/07/2004 alterou a via de aplicacao e intervalo */

BEGIN

/*   Edilson em 28/11/05 OS 24673 mudei o parametro pelo campo ie_unidade_medida no cursor
select	nvl(nvl(vl_parametro, vl_parametro_padrao),'S')
into	ie_unidade_medida_w
from	funcao_parametro
where	cd_funcao = 924
and	nr_sequencia = 63;

cd_unidade_medida_dose_w	:= nvl(cd_unid_med_dose_p,'zzzz'); */


/*select	nvl(max(cd_unidade_medida_dose),'zzzz')
into	cd_unidade_medida_dose_w
from	prescr_material
where	nr_prescricao		= nr_prescricao_p
and	nr_sequencia		= nr_sequencia_p;*/
select	count(*)
into STRICT 	qt_mat_w
from	Material
where	cd_material	= cd_material_p;

if (qt_mat_w > 0) and (nr_prescricao_p	> 0) then

	cd_perfil_w		:= coalesce(obter_perfil_ativo,0);
	
	ds_erro_p		:= '';
	qt_unitaria_w		:= qt_unitaria_p;
	
	select	coalesce(qt_minimo_multiplo_solic,1),
			coalesce(qt_max_prescricao,0),
			substr(obter_dados_material_estab(cd_material,cd_estabelecimento_p,'UMS'),1,30) cd_unidade_medida_consumo,
			substr(obter_dados_material_estab(cd_material,cd_estabelecimento_p,'UME'),1,30) cd_unidade_medida_estoque,
			substr(obter_dados_material(cd_material_p,'EST'),1,30)
	into STRICT	qt_multiplo_w,
			qt_max_pres_w,
			cd_unid_med_w,
			cd_unidade_medida_estoque_w,
			cd_material_estoque_w
	from	Material
	where	cd_material	= cd_material_p;

	if (qt_multiplo_w = 0) then
		qt_multiplo_w := 1;
	end if;


	/* Edilson em 28/11/05 OS 24673
	cd_unid_med_cursor_w	:= cd_unid_med_w;
	if	(ie_unidade_medida_w = 'N') and
		(cd_unidade_medida_dose_w <> 'zzzz') then
		cd_unid_med_cursor_w	:= cd_unidade_medida_dose_w;
	end if; */
	if (qt_dias_p IS NOT NULL AND qt_dias_p::text <> '') and (qt_dias_p > 0) then
		qt_dias_w := qt_dias_p;
	end if;

	ie_regra_w := 'S';
	select	max(nr_atendimento),
			max(IE_MOTIVO_PRESCRICAO)
	into STRICT	nr_atendimento_w,
			IE_MOTIVO_PRESCRICAO_w
	from	prescr_medica
	where	nr_prescricao	= nr_prescricao_p;

	cd_convenio_w	:= obter_convenio_atendimento(nr_atendimento_w);
	cd_setor_w		:= coalesce(obter_setor_atendimento(nr_atendimento_w),0);
	
	nm_usuario_w 		:= obter_usuario_ativo;	

	ie_info_rastre_prescr_w := obter_se_info_rastre_prescr( 'L', nm_usuario_w, cd_perfil_w, cd_estabelecimento_p );

	if (ie_info_rastre_prescr_w = 'S') then
		ds_alteracao_rastre_w := substr(obter_desc_expressao(942996) || ' / obter_quant_dispensar = ' || chr(13)
											|| ' 01 - linha'
											|| ' nr_prescricao_p: '					|| nr_prescricao_p
											|| ' cd_unid_med_w: '					|| cd_unid_med_w
											|| ' cd_unid_med_dose_p: '				|| cd_unid_med_dose_p
											|| ' cd_unidade_medida_estoque_w: '		|| cd_unidade_medida_estoque_w
											|| ' ie_acm_p: '						|| ie_acm_p
											|| ' ie_se_necessario_p: '				|| ie_se_necessario_p
											|| ' ie_via_aplicacao_p: '				|| ie_via_aplicacao_p
											|| ' cd_intervalo_p: '					|| cd_intervalo_p
											|| ' cd_convenio_w'						|| cd_convenio_w
											|| ' cd_setor_w: '						|| cd_setor_w
											|| ' cd_material_p: '					|| cd_material_p
											|| ' cd_material_estoque_w: '			|| cd_material_estoque_w
											|| ' cd_perfil_w: '						|| cd_perfil_w
											|| ' cd_estabelecimento_p: '			|| cd_estabelecimento_p
											|| ' ie_motivo_prescricao_w: '			|| ie_motivo_prescricao_w
											|| ' qt_dias_p: '						|| qt_dias_p
											|| ' qt_dias_w: '						|| qt_dias_w
											|| ' qt_dose_esp_p: '					|| qt_dose_esp_p
											|| ' ie_origem_inf_p: '					|| ie_origem_inf_p
											|| ' qt_unitaria_p: '					|| qt_unitaria_p
											|| ' nr_ocorrencia_p: '					|| nr_ocorrencia_p
											|| ' qt_material_p: '					|| qt_material_p
											,1,1800);

	end if;
	
	OPEN	c01;
	Loop
	Fetch	c01 into	ie_regra_w,
				ie_regra_disp_w,
				ie_usuario_def_disp_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		ie_regra_w		:= ie_regra_w;
		ie_regra_disp_w		:= ie_regra_disp_w;
		ie_usuario_def_disp_w	:= ie_usuario_def_disp_w;
	END LOOP;
	CLOSE C01;

	if (ie_info_rastre_prescr_w = 'S') then
		ds_alteracao_rastre_w := substr(ds_alteracao_rastre_w				|| chr(13)
											|| ' 02 - linha'
											|| ' ie_regra_w: '				|| ie_regra_w
											|| ' ie_regra_disp_w: '			|| ie_regra_disp_w
											|| ' ie_usuario_def_disp_w: '	|| ie_usuario_def_disp_w
											,1,1800);											
	end if;
	
	if (ie_usuario_def_disp_w = 'S') then
		update	prescr_material
		set	ie_regra_disp	= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE 'U' END
		where	coalesce(nm_usuario_disp::text, '') = ''
		and	nr_sequencia	= nr_sequencia_p
		and	nr_prescricao	= nr_prescricao_p;
		if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
	end if;

  begin
    EXEC_w := 'CALL OBTER_QT_UNIT_QUANT_DISP_MD(:1,:2) INTO :result';

    EXECUTE EXEC_w USING IN ie_regra_w,
                                   IN qt_unitaria_w,
                                   OUT qt_unitaria_w;
  exception
      when others then
        qt_unitaria_w := null;
  end;

  begin
    qt_material_dose_dif_w := obter_qt_material_dose_dif(cd_material_p, cd_unid_med_dose_p, ds_dose_dif_p);
  exception
     when others then
        qt_material_dose_dif_w := 0;
  end;

  begin             
    EXEC_w := 'CALL OBTER_QT_MAT_QUANT_DISP_MD(:1,:2,:3,:4,:5) INTO :result';

    EXECUTE EXEC_w USING IN ds_dose_dif_p,
                                   IN qt_unitaria_w,
                                   IN nr_ocorrencia_p,
                                   IN qt_material_dose_dif_w,
                                   IN qt_material_p,
                                   OUT qt_material_w;
  exception
      when others then
        qt_material_w := null;
  end;
	
	if (ie_info_rastre_prescr_w = 'S') then
			ds_alteracao_rastre_w := substr(ds_alteracao_rastre_w					|| chr(13)
													|| ' 03 - linha'
													|| ' ds_dose_dif_p: '			|| ds_dose_dif_p
													|| ' qt_material_w: '			|| qt_material_w
													|| ' qt_unitaria_w: '			|| qt_unitaria_w
													|| ' qt_material_p: '			|| qt_material_p
													,1,1800);										
	end if;

	if (coalesce(qt_dose_esp_p, 0) > 0) then
		cd_unidade_medida_w	:= coalesce(cd_unid_med_dose_p,'zzzz');

		select	coalesce(max(coalesce(cd_unid_med_dose_esp, cd_unid_med_dose_p)),'zzzz')
		into STRICT	cd_unidade_medida_w
		from	prescr_material
		where	nr_sequencia		= nr_sequencia_p
		and		nr_prescricao		= nr_prescricao_p;

		if (coalesce(cd_unidade_medida_w::text, '') = '') or (cd_unidade_medida_w = 'zzzz') then
			cd_unidade_medida_w	:= coalesce(cd_unid_med_dose_p,'zzzz');
		end if;


		select	coalesce(max(qt_conversao),1)
		into STRICT	qt_conversao_w
		from	material_conversao_unidade
		where	cd_unidade_medida	= cd_unidade_medida_w
		and		cd_material		= cd_material_p;

    begin
      EXEC_w := 'BEGIN OBTER_DOSE_ESP_QUANT_DISP_MD(:1,:2,:3,:4,:5); END;';

      EXECUTE EXEC_w USING IN qt_conversao_w,
                                     IN ie_regra_w,
                                     IN qt_dose_esp_p,
                                     OUT qt_dose_esp_w,
                                     IN OUT qt_material_w;
    exception
        when others then
          qt_dose_esp_w := null;
          qt_material_w := null;
    end;
	end if;

	ie_regra_disp_w		:= coalesce(ie_regra_disp_w,'C');
	/* 	Rotina para definir a dispensacao de um material
		C= Sol Min.Cadastro
		M= Mantem a Pedida,
		S= Arredonda Superior */
		
	if (ie_info_rastre_prescr_w = 'S') then
			ds_alteracao_rastre_w := substr(ds_alteracao_rastre_w					|| chr(13)
													|| ' 04 - linha'
													|| ' qt_dose_esp_p: '			|| qt_dose_esp_p
													|| ' qt_conversao_w: '			|| qt_conversao_w
													|| ' qt_dose_esp_w: '			|| qt_dose_esp_w
													|| ' ie_regra_w: '				|| ie_regra_w
													|| ' qt_material_w: '			|| qt_material_w
													,1,1800);										
	end if;

	if (ie_origem_inf_p = '9') or (ie_regra_disp_w = 'M') then
    begin
      EXEC_w := 'BEGIN OBTER_MULT_DISP_QUANT_DISP_MD(:1,:2,:3,:4,:5,:6,:7); END;';

      EXECUTE EXEC_w USING IN ie_regra_disp_w,
                                     IN qt_material_w,
                                     IN qt_multiplo_w,
                                     IN qt_unitaria_w,
                                     IN nr_ocorrencia_p,
                                     OUT nr_multiplo_w,
                                     OUT qt_Dispensar_w;
    exception
        when others then
          nr_multiplo_w  := null;
          qt_Dispensar_w := null;
    end;

		if (ie_info_rastre_prescr_w = 'S') then
			ds_alteracao_rastre_w := substr(ds_alteracao_rastre_w					|| chr(13)
													|| ' 05 - linha'
													|| ' ie_regra_disp_w: '			|| ie_regra_disp_w
													|| ' qt_material_w: '			|| qt_material_w
													|| ' qt_dispensar_w: '			|| qt_dispensar_w
													,1,1800);										
		end if;
	elsif (ie_regra_disp_w = 'S') then
		begin
          begin
            EXEC_w := 'BEGIN OBTER_MULT_DISP_QUANT_DISP_MD(:1,:2,:3,:4,:5,:6,:7); END;';

            EXECUTE EXEC_w USING IN ie_regra_disp_w,
                                           IN qt_material_w,
                                           IN qt_multiplo_w,
                                           IN qt_unitaria_w,
                                           IN nr_ocorrencia_p,
                                           OUT nr_multiplo_w,
                                           OUT qt_Dispensar_w;
          exception
              when others then
                nr_multiplo_w  := null;
                qt_Dispensar_w := null;
          end;

          if (ie_info_rastre_prescr_w = 'S') then
              ds_alteracao_rastre_w := substr(ds_alteracao_rastre_w					|| chr(13)
                                                      || ' 06 - linha'
                                                      || ' ie_regra_disp_w: '			|| ie_regra_disp_w
                                                      || ' qt_material_w: '			|| qt_material_w
                                                      || ' qt_dispensar_w: '			|| qt_dispensar_w
                                                      ,1,1800);										
          end if;
		end;
	elsif (ie_regra_disp_w = 'I') then
		begin
          begin
            EXEC_w := 'BEGIN OBTER_MULT_DISP_QUANT_DISP_MD(:1,:2,:3,:4,:5,:6,:7); END;';

            EXECUTE EXEC_w USING IN ie_regra_disp_w,
                                           IN qt_material_w,
                                           IN qt_multiplo_w,
                                           IN qt_unitaria_w,
                                           IN nr_ocorrencia_p,
                                           OUT nr_multiplo_w,
                                           OUT qt_Dispensar_w;
          exception
              when others then
                nr_multiplo_w  := null;
                qt_Dispensar_w := null;
          end;

          if (ie_info_rastre_prescr_w = 'S') then
              ds_alteracao_rastre_w := substr(ds_alteracao_rastre_w					|| chr(13)
                                                      || ' 07 - linha'
                                                      || ' ie_regra_disp_w: '			|| ie_regra_disp_w 
                                                      || ' qt_material_w: '			|| qt_material_w
                                                      || ' qt_dispensar_w: '			|| qt_dispensar_w
                                                      ,1,1800);										
          end if;
		end;
	else
		begin
          if (ie_regra_disp_w = 'C') then --Solicitacao Min Cadastro
              begin
                EXEC_w := 'BEGIN OBTER_MULT_DISP_QUANT_DISP_MD(:1,:2,:3,:4,:5,:6,:7); END;';

                EXECUTE EXEC_w USING IN ie_regra_disp_w,
                                               IN qt_material_w,
                                               IN qt_multiplo_w,
                                               IN qt_unitaria_w,
                                               IN nr_ocorrencia_p,
                                               OUT nr_multiplo_w,
                                               OUT qt_Dispensar_w;
              exception
                  when others then
                    nr_multiplo_w  := null;
                    qt_Dispensar_w := null;
              end;

              if (ie_info_rastre_prescr_w = 'S') then
                  ds_alteracao_rastre_w := substr(ds_alteracao_rastre_w				|| chr(13)
                                                      || ' 08 - linha'
                                                      || ' ie_regra_disp_w: '			|| ie_regra_disp_w
                                                      || ' qt_multiplo_w: '			|| qt_multiplo_w
                                                      || ' qt_material_w: '			|| qt_material_w
                                                      || ' ie_usuario_def_disp_w: '	|| ie_usuario_def_disp_w
                                                      || ' nr_multiplo_w: '			|| nr_multiplo_w
                                                      || ' qt_dispensar_w: '			|| qt_dispensar_w
                                                      ,1,1800);									
              end if;
          else
              --Solicitacao Min. Cadastro - Por horario
              begin
                EXEC_w := 'BEGIN OBTER_MULT_DISP_QUANT_DISP_MD(:1,:2,:3,:4,:5,:6,:7); END;';

                EXECUTE EXEC_w USING IN ie_regra_disp_w,
                                               IN qt_material_w,
                                               IN qt_multiplo_w,
                                               IN qt_unitaria_w,
                                               IN nr_ocorrencia_p,
                                               OUT nr_multiplo_w,
                                               OUT qt_Dispensar_w;
              exception
                  when others then
                    nr_multiplo_w  := null;
                    qt_Dispensar_w := null;
              end;

              if (ie_info_rastre_prescr_w = 'S') then
                  ds_alteracao_rastre_w := substr(ds_alteracao_rastre_w				|| chr(13)
                                                      || ' 09 - linha'
                                                      || ' qt_multiplo_w: '			|| qt_multiplo_w
                                                      || ' qt_unitaria_w: '			|| qt_unitaria_w
                                                      || ' nr_multiplo_w: '			|| nr_multiplo_w
                                                      || ' qt_dispensar_w: '			|| qt_dispensar_w
                                                      ,1,1800);									
              end if;
          end if;
		end;
	end if;
	
	begin
		EXEC_w := 'CALL OBTER_DS_ERRO_QUANT_DISPEN_MD(:1,:2,:3) INTO :result';
		
		EXECUTE EXEC_w USING IN qt_max_pres_w,
									   IN qt_Dispensar_w,
									   IN cd_unid_med_w,
									   OUT ds_erro_p;
	exception
	when others then
		ds_erro_p := null;
	end;

	if (ie_info_rastre_prescr_w = 'S') then
		ds_alteracao_rastre_w := substr(ds_alteracao_rastre_w						|| chr(13)
													|| ' 10 - linha'
													|| ' qt_dias_w: '				|| qt_dias_w
													|| ' qt_material_w: '			|| qt_material_w
													|| ' ie_usuario_def_disp_w: '	|| ie_usuario_def_disp_w
													|| ' qt_dispensar_w: '			|| qt_dispensar_w
													,1,1800);
		
													
	end if;

  begin
    EXEC_w := 'BEGIN OBTER_MAT_DISP_RE_QUA_DISP_MD(:1,:2,:3,:4,:5); END;';

    EXECUTE EXEC_w USING IN qt_dias_w,
                                   IN ie_usuario_def_disp_w,
                                   IN OUT qt_material_w,
                                   IN OUT qt_dispensar_w,
                                   OUT ie_regra_disp_p;
  exception
      when others then
        nr_multiplo_w   := null;
        qt_Dispensar_w  := null;
        ie_regra_disp_p := null;
  end;

  qt_material_p	 := qt_material_w;
  qt_dispensar_p := qt_dispensar_w;
	
	if (ie_info_rastre_prescr_w = 'S') then
		CALL gerar_log_prescr_mat(nr_prescricao_p, null, null, null, null, ds_alteracao_rastre_w, nm_usuario_w, 'N');
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_quant_dispensar (cd_estabelecimento_p bigint, cd_material_p bigint, nr_prescricao_p bigint, nr_sequencia_p bigint, cd_intervalo_p text, ie_via_aplicacao_p text, qt_unitaria_p bigint, qt_dose_esp_p bigint, nr_ocorrencia_p bigint, ds_dose_dif_p text, ie_origem_inf_p text, cd_unid_med_dose_p text, qt_dias_p bigint, qt_material_p INOUT bigint, qt_dispensar_p INOUT bigint, ie_regra_disp_p INOUT text, ds_erro_p INOUT text, ie_se_necessario_p text, ie_acm_p text ) FROM PUBLIC;

