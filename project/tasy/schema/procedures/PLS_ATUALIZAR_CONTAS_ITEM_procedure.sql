-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_contas_item ( nr_seq_movimento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atencao:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_item_mens_w		bigint;
nr_seq_conta_proc_w		bigint;
nr_seq_conta_mat_w		bigint;
nr_seq_conta_w			bigint;
nr_seq_esquema_w		bigint;
nr_seq_protocolo_w		bigint;
nr_seq_conta_copartic_w		bigint;
nr_seq_conta_pos_estab_w	bigint;
nr_seq_ppsc_movimento_w		bigint;
nr_seq_ppsc_mov_item_w		bigint;
nr_seq_lote_ppsc_w		bigint;
nr_seq_fatura_proc_w		bigint;
nr_seq_fatura_mat_w		bigint;
nr_seq_fatura_w			bigint;
nr_seq_fat_item_trib_w		bigint;
dt_referencia_w			timestamp;
dt_mes_competencia_w		timestamp;
dt_competencia_month_w		timestamp;
cd_tipo_lote_contabil_w		bigint;
cd_conta_credito_w		varchar(20);
cd_conta_debito_w		varchar(20);
cd_conta_ato_coop_w		varchar(20);
cd_conta_ato_aux_w		varchar(20);
cd_conta_ato_nao_coop_w		varchar(20);
ie_corrigido_w			varchar(1);
ie_conta_glosa_w		varchar(2);
ie_status_w			varchar(2);
ie_tipo_lote_w			varchar(2);
nr_seq_lote_cancel_w		bigint;
nr_seq_evento_movimento_w	bigint;
nr_seq_pag_tributo_w		bigint;
nr_seq_lote_evento_w		bigint;
nr_seq_lote_pagamento_w		bigint;
qt_vago_w			bigint	:= 0;
qt_prest_pgto_w			bigint;
qt_outro_w			bigint;
ie_status_prov_pagto_w		pls_parametro_contabil.ie_status_prov_pagto%type;
ie_lote_ajuste_prod_w		pls_parametro_contabil.ie_status_prov_pagto%type;
cd_empresa_w			estabelecimento.cd_empresa%type;
nr_seq_lote_disc_w		pls_lote_discussao.nr_sequencia%type;
nr_seq_conta_resumo_w		pls_conta_medica_resumo.nr_sequencia%type;
nr_seq_pag_item_trib_w  	pls_pag_item_trib.nr_sequencia%type;
ie_tipo_movimento_w		pls_movimento_contabil.ie_tipo_movimento%type;
nr_seq_pp_item_lote_w		pls_movimento_contabil.nr_seq_pp_item_lote%type;
nr_seq_pp_base_atual_trib_w	pls_movimento_contabil.nr_seq_pp_base_atual_trib%type;
nr_seq_aviso_proc_w		pls_movimento_contabil.nr_seq_aviso_proc%type;
nr_seq_aviso_mat_w		pls_movimento_contabil.nr_seq_aviso_mat%type;
nr_seq_aviso_proc_item_w	pls_movimento_contabil.nr_seq_aviso_proc_item%type;
nr_seq_aviso_mat_item_w		pls_movimento_contabil.nr_seq_aviso_mat_item%type;
nr_seq_processo_conta_w		pls_movimento_contabil.nr_seq_processo_conta%type;
nr_seq_processo_conta_comp_w	pls_movimento_contabil.nr_seq_processo_conta_comp%type;
nr_seq_lote_aviso_w		ptu_lote_aviso.nr_sequencia%type;
nr_seq_plano_w                  pls_plano.nr_sequencia%type;
nr_seq_rec_resumo_item_w	bigint;
nr_seq_atualizacao_w		bigint;
nr_seq_arquivo_w		ptu_aviso_arquivo.nr_sequencia%type;
nr_seq_pos_taxa_contab_w	pls_movimento_contabil.nr_seq_taxa_adm_contab%type;
nr_seq_processo_w		pls_processo.nr_sequencia%type;
nr_seq_competencia_w		pls_processo_competencia.nr_sequencia%type;
nr_seq_conta_pos_estab_prev_w	pls_conta_pos_estab_prev.nr_sequencia%type;
nr_seq_mens_seg_w		pls_mensalidade_segurado.nr_sequencia%type;
qt_regra_ato_item_w		bigint;
ie_contab_ppcng_w		pls_parametro_contabil.ie_contab_ppcng%type;
ie_performance_contab_w		pls_visible_false.ie_performance_contab%type;
nr_seq_esquema_rec_w		pls_mensalidade_seg_item.nr_seq_esquema_rec%type;


BEGIN
ie_corrigido_w	:= 'N';

delete	from	pls_movto_contab_inconsist
where	nr_seq_movimento	= nr_seq_movimento_p;

select	coalesce(max(ie_performance_contab), 'N')
into STRICT	ie_performance_contab_w
from	pls_visible_false
where	cd_estabelecimento = cd_estabelecimento_p;

select	max(cd_empresa)
into STRICT	cd_empresa_w
from	estabelecimento
where	cd_estabelecimento	= cd_estabelecimento_p;

select	b.cd_tipo_lote_contabil,
	a.nr_seq_item_mensalidade,
	a.nr_seq_conta_proc,
	a.nr_seq_conta_mat,
	a.ie_conta_glosa,
	a.nr_seq_conta_copartic,
	a.nr_seq_conta_pos_estab,
	a.nr_seq_ppsc_movimento,
	a.nr_seq_ppsc_mov_item,
	a.nr_seq_fatura_proc,
	a.nr_seq_fatura_mat,
	a.nr_seq_evento_movimento,
	a.nr_seq_pag_tributo,
	nr_seq_fat_item_trib,
	trunc(b.dt_atualizacao_contas,'month'),
	trunc(b.dt_mes_competencia,'month'),
	a.nr_seq_resumo,
	a.nr_seq_pag_item_trib,
	a.nr_seq_rec_resumo_item,
	a.nr_seq_pp_item_lote,
	a.nr_seq_pp_base_atual_trib,
	a.nr_seq_aviso_proc,
	a.nr_seq_aviso_mat,
	a.nr_seq_aviso_proc_item,
	a.nr_seq_aviso_mat_item,
	a.nr_seq_taxa_adm_contab,
	a.nr_seq_processo_conta,
	a.nr_seq_processo_conta_comp,
	a.nr_seq_conta_pos_estab_prev,
	a.ie_tipo_movimento
into STRICT	cd_tipo_lote_contabil_w,
	nr_seq_item_mens_w,
	nr_seq_conta_proc_w,
	nr_seq_conta_mat_w,
	ie_conta_glosa_w,
	nr_seq_conta_copartic_w,
	nr_seq_conta_pos_estab_w,
	nr_seq_ppsc_movimento_w,
	nr_seq_ppsc_mov_item_w,
	nr_seq_fatura_proc_w,
	nr_seq_fatura_mat_w,
	nr_seq_evento_movimento_w,
	nr_seq_pag_tributo_w,
	nr_seq_fat_item_trib_w,
	dt_referencia_w,
	dt_mes_competencia_w,
	nr_seq_conta_resumo_w,
	nr_seq_pag_item_trib_w,
	nr_seq_rec_resumo_item_w,
	nr_seq_pp_item_lote_w,
	nr_seq_pp_base_atual_trib_w,
	nr_seq_aviso_proc_w,
	nr_seq_aviso_mat_w,
	nr_seq_aviso_proc_item_w,
	nr_seq_aviso_mat_item_w,
	nr_seq_pos_taxa_contab_w,
	nr_seq_processo_conta_w,
	nr_seq_processo_conta_comp_w,
	nr_seq_conta_pos_estab_prev_w,
	ie_tipo_movimento_w
from	pls_movimento_contabil		a,
	pls_atualizacao_contabil	b
where	a.nr_seq_atualizacao	= b.nr_sequencia
and	a.nr_sequencia		= nr_seq_movimento_p;

CALL pls_atualizar_codificacao_pck.pls_atualizar_codificacao(dt_referencia_w);

dt_competencia_month_w	:= trunc(dt_mes_competencia_w,'month');

if (cd_tipo_lote_contabil_w = 21) then
	
	select	b.nr_sequencia nr_seq_mens_seg,
		(select	count(*)
		from	pls_contab_ato_item x
		where	x.ie_tipo_item_mensalidade = a.ie_tipo_item
		and	((x.nr_seq_tipo_lanc = a.nr_seq_tipo_lanc) or (coalesce(x.nr_seq_tipo_lanc::text, '') = ''))) qt_regra_ato_item
	into STRICT	nr_seq_mens_seg_w,
		qt_regra_ato_item_w
	from	pls_mensalidade_seg_item a,
		pls_mensalidade_segurado b
	where	b.nr_sequencia	= a.nr_seq_mensalidade_seg
	and 	a.nr_sequencia 	= nr_seq_item_mens_w;

	if (ie_performance_contab_w = 'M') then
		if (ie_tipo_movimento_w = 1) then /* 1 - Provision */
			ie_tipo_lote_w	:= 'P';
		elsif (ie_tipo_movimento_w = 2) then /* 2 - Revenue */
			ie_tipo_lote_w	:= 'R';
		else
			nr_seq_mens_seg_w	:= null;
		end if;
	else
		nr_seq_mens_seg_w	:= null;
	end if;
	
	qt_vago_w := ctb_pls_atualizar_receita_in(null, null, nr_seq_item_mens_w, null, nm_usuario_p, cd_estabelecimento_p, nr_seq_mens_seg_w, ie_tipo_lote_w, qt_vago_w);
	
	select	nr_seq_esquema,
		nr_seq_esquema_rec,
		cd_conta_rec,
		cd_conta_deb,
		cd_conta_ato_cooperado,
		cd_conta_ato_auxiliar,
		cd_conta_ato_nao_coop
	into STRICT	nr_seq_esquema_w,
		nr_seq_esquema_rec_w,
		cd_conta_credito_w,
		cd_conta_debito_w,
		cd_conta_ato_coop_w,
		cd_conta_ato_aux_w,
		cd_conta_ato_nao_coop_w		
	from	pls_movto_contab_mensalidade_v
	where	nr_sequencia = nr_seq_movimento_p;
	
	if	((ie_performance_contab_w = 'N' or ie_tipo_movimento_w <> 2) and coalesce(nr_seq_esquema_w::text, '') = '') or /* 1 - Provision */
		((ie_performance_contab_w = 'M' and ie_tipo_movimento_w = 2) and coalesce(nr_seq_esquema_rec_w::text, '') = '') then /* 2 - Revenue - MUDAR QUANDO CRIAR O CAMPO NOVO DE ESQUEMA */
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '1';
	elsif	(((ie_performance_contab_w = 'N' or ie_tipo_movimento_w <> 2) and coalesce(cd_conta_debito_w::text, '') = '') or /* Provision - Debit */
		((ie_performance_contab_w = 'N' or ie_tipo_movimento_w <> 1) and /* Revenue - Credit - Cooperative act */
		(((qt_regra_ato_item_w > 0 and
		((coalesce(cd_conta_ato_coop_w::text, '') = '') or (coalesce(cd_conta_ato_aux_w::text, '') = '') or (coalesce(cd_conta_ato_nao_coop_w::text, '') = ''))) and (coalesce(cd_conta_credito_w::text, '') = '')) or (qt_regra_ato_item_w = 0 and coalesce(cd_conta_credito_w::text, '') = '')))) then /* 2 - Revenue - Credit */
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '2';
	else
		ie_corrigido_w	:= 'S';
	end if;	

elsif (cd_tipo_lote_contabil_w = 22) then

	if (nr_seq_conta_proc_w IS NOT NULL AND nr_seq_conta_proc_w::text <> '') then
		select	b.nr_sequencia,
			'P'
		into STRICT	nr_seq_conta_w,
			ie_conta_glosa_w
		from	pls_conta		b,
			pls_conta_proc		c
		where	b.nr_sequencia	= c.nr_seq_conta
		and	c.nr_sequencia	= nr_seq_conta_proc_w;
	
	elsif (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') then
		select	b.nr_sequencia,
			'P'
		into STRICT	nr_seq_conta_w,
			ie_conta_glosa_w
		from	pls_conta		b,
			pls_conta_mat		c
		where	b.nr_sequencia	= c.nr_seq_conta
		and	c.nr_sequencia	= nr_seq_conta_mat_w;
	end if;

	qt_vago_w := ctb_pls_atualizar_despesa_in(	null, null, nm_usuario_p, cd_estabelecimento_p, qt_vago_w, nr_seq_conta_w);
	
	if (coalesce(ie_conta_glosa_w,'N') = 'P') then
		select	nr_seq_esquema,
			cd_conta_cred,
			cd_conta_deb
		into STRICT	nr_seq_esquema_w,
			cd_conta_credito_w,
			cd_conta_debito_w
		from	pls_conta_proc
		where	nr_sequencia	= nr_seq_conta_proc_w;
	elsif (coalesce(ie_conta_glosa_w,'N') = 'M') then
		select	nr_seq_esquema,
			cd_conta_cred,
			cd_conta_deb
		into STRICT	nr_seq_esquema_w,
			cd_conta_credito_w,
			cd_conta_debito_w
		from	pls_conta_proc
		where	nr_sequencia	= nr_seq_conta_proc_w;
	end if;
	
	if (coalesce(nr_seq_esquema_w::text, '') = '') then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '1';
	elsif	((coalesce(cd_conta_credito_w::text, '') = '') or (coalesce(cd_conta_debito_w::text, '') = '')) then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '2';
	else
		ie_corrigido_w	:= 'S';
	end if;
	
elsif (cd_tipo_lote_contabil_w = 40) then
	select	sum(CASE WHEN ie_prestador_codificacao='P' THEN  1  ELSE 0 END ) qt_prest_pgto,
		sum(CASE WHEN ie_prestador_codificacao='P' THEN  0  ELSE 1 END ) qt_outro
	into STRICT	qt_prest_pgto_w,
		qt_outro_w
	from	pls_esquema_contabil
	where	ie_tipo_regra		= 'PP'
	and	cd_estabelecimento	= cd_estabelecimento_p
	and	dt_competencia_month_w between dt_inicio_vigencia and coalesce(dt_fim_vigencia, dt_competencia_month_w);
	
	select	max(coalesce(ie_status_prov_pagto,'NC')),
		max(coalesce(ie_lote_ajuste_prod,'R'))
	into STRICT	ie_status_prov_pagto_w,
		ie_lote_ajuste_prod_w
	from	pls_parametro_contabil
	where	cd_estabelecimento	= cd_estabelecimento_p;
	
	if (qt_prest_pgto_w > 0) and (qt_outro_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(358873);
	end if;
	
	if (coalesce(nr_seq_conta_proc_w,0) <> 0) then
		select	max(nr_seq_conta)
		into STRICT	nr_seq_conta_w
		from	pls_conta_proc
		where	nr_sequencia	= nr_seq_conta_proc_w;
		
		if (qt_outro_w > 0) then
			qt_vago_w := ctb_pls_atualizar_prov_prod_in(	nr_seq_conta_w, nr_seq_conta_proc_w, 0, null, nm_usuario_p, cd_estabelecimento_p, qt_vago_w);
		end if;
		
		if (qt_prest_pgto_w > 0) then
			qt_vago_w := ctb_pls_atualiza_prov_prod_res( nr_seq_conta_w, nr_seq_conta_proc_w, 0, null, nm_usuario_p, cd_estabelecimento_p, cd_empresa_w, ie_status_prov_pagto_w, ie_lote_ajuste_prod_w, qt_vago_w, dt_mes_competencia_w);
		end if;
		
	elsif (coalesce(nr_seq_conta_mat_w,0) <> 0) then
		select	max(nr_seq_conta)
		into STRICT	nr_seq_conta_w
		from	pls_conta_mat
		where	nr_sequencia	= nr_seq_conta_mat_w;
		
		if (qt_outro_w > 0) then
			qt_vago_w := ctb_pls_atualizar_prov_prod_in(	nr_seq_conta_w, 0, nr_seq_conta_mat_w, null, nm_usuario_p, cd_estabelecimento_p, qt_vago_w);
		end if;
		
		if (qt_prest_pgto_w > 0) then
			qt_vago_w := ctb_pls_atualiza_prov_prod_res( nr_seq_conta_w, 0, nr_seq_conta_mat_w, null, nm_usuario_p, cd_estabelecimento_p, cd_empresa_w, ie_status_prov_pagto_w, ie_lote_ajuste_prod_w, qt_vago_w, dt_mes_competencia_w);
		end if;
	end if;
	
	if (coalesce(nr_seq_conta_w,0) <> 0) then
                select  max(nr_seq_plano)
                into STRICT    nr_seq_plano_w
                from    pls_conta
                where   nr_sequencia = nr_seq_conta_w;

		if (coalesce(nr_seq_conta_proc_w,0) <> 0) then
			if (qt_outro_w > 0) then
				select	nr_seq_esquema_prov,
					cd_conta_provisao_cred,
					cd_conta_provisao_deb
				into STRICT	nr_seq_esquema_w,
					cd_conta_credito_w,
					cd_conta_debito_w
				from	pls_conta_proc
				where	nr_sequencia	= nr_seq_conta_proc_w;
			end if;
		
			if (qt_prest_pgto_w > 0) then
				select	max(nr_seq_esquema_prov),
					max(cd_conta_prov_cred),
					max(cd_conta_prov_deb)
				into STRICT	nr_seq_esquema_w,
					cd_conta_credito_w,
					cd_conta_debito_w
				from	pls_conta_medica_resumo
				where	nr_sequencia	= nr_seq_conta_resumo_w
				and	nr_seq_conta	= nr_seq_conta_w;
			end if;
		elsif (coalesce(nr_seq_conta_mat_w,0) <> 0) then			
			if (qt_outro_w > 0) then
				select	nr_seq_esquema_prov,
					cd_conta_provisao_cred,
					cd_conta_provisao_deb
				into STRICT	nr_seq_esquema_w,
					cd_conta_credito_w,
					cd_conta_debito_w
				from	pls_conta_mat
				where	nr_sequencia	= nr_seq_conta_mat_w;
			end if;
		
			if (qt_prest_pgto_w > 0) then
				select	max(nr_seq_esquema_prov),
					max(cd_conta_prov_cred),
					max(cd_conta_prov_deb)
				into STRICT	nr_seq_esquema_w,
					cd_conta_credito_w,
					cd_conta_debito_w
				from	pls_conta_medica_resumo
				where	nr_sequencia	= nr_seq_conta_resumo_w
				and	nr_seq_conta	= nr_seq_conta_w;
			end if;
		end if;
	end if;
	
	if (coalesce(nr_seq_esquema_w::text, '') = '') then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '1';
	elsif	((coalesce(cd_conta_credito_w::text, '') = '') or (coalesce(cd_conta_debito_w::text, '') = '')) then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '2';
        elsif (coalesce(nr_seq_plano_w, 0) = 0) then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '8';
	else
		ie_corrigido_w	:= 'S';
	end if;
	
elsif (cd_tipo_lote_contabil_w = 41) then
	select	sum(CASE WHEN ie_prestador_codificacao='P' THEN  1  ELSE 0 END ) qt_prest_pgto,
		sum(CASE WHEN ie_prestador_codificacao='P' THEN  0  ELSE 1 END ) qt_outro
	into STRICT	qt_prest_pgto_w,
		qt_outro_w
	from	pls_esquema_contabil
	where	ie_tipo_regra		= 'PM'
	and	cd_estabelecimento	= cd_estabelecimento_p
	and	dt_competencia_month_w between dt_inicio_vigencia and coalesce(dt_fim_vigencia, dt_competencia_month_w);

	if (nr_seq_evento_movimento_w IS NOT NULL AND nr_seq_evento_movimento_w::text <> '') then
		select	nr_seq_lote
		into STRICT	nr_seq_lote_evento_w
		from	pls_evento_movimento
		where	nr_sequencia	= nr_seq_evento_movimento_w;
		
		qt_vago_w := ctb_pls_atualizar_prod_eve_in(nr_seq_lote_evento_w, nr_seq_evento_movimento_w, null, nm_usuario_p, cd_estabelecimento_p, qt_vago_w);
		
		select	nr_seq_esquema,
			cd_conta_credito,
			cd_conta_debito
		into STRICT	nr_seq_esquema_w,
			cd_conta_credito_w,
			cd_conta_debito_w
		from	pls_evento_movimento
		where	nr_sequencia	= nr_seq_evento_movimento_w;
	elsif (nr_seq_pag_tributo_w IS NOT NULL AND nr_seq_pag_tributo_w::text <> '') then
		select	max(b.nr_seq_lote)
		into STRICT	nr_seq_lote_pagamento_w
		from	pls_pag_prest_venc_trib		d,
			pls_pag_prest_vencimento	c,
			pls_pagamento_prestador		b
		where	b.nr_sequencia	= c.nr_seq_pag_prestador
		and	c.nr_sequencia	= d.nr_seq_vencimento
		and	d.nr_sequencia	= nr_seq_pag_tributo_w;
	
		qt_vago_w := ctb_pls_atualizar_trib_pag_in(nr_seq_lote_pagamento_w, nr_seq_pag_tributo_w, null, nm_usuario_p, cd_estabelecimento_p, qt_vago_w);
		
		if (coalesce(nr_seq_pag_item_trib_w,0) <> 0) then
				select	nr_seq_esquema,
					cd_conta_cred,
					cd_conta_deb
				into STRICT	nr_seq_esquema_w,
					cd_conta_credito_w,
					cd_conta_debito_w
				from	pls_pag_item_trib
				where	nr_sequencia	= nr_seq_pag_item_trib_w;
		else	
				select	nr_seq_esquema,
					cd_conta_cred,
					cd_conta_deb
				into STRICT	nr_seq_esquema_w,
					cd_conta_credito_w,
					cd_conta_debito_w
				from	pls_pag_prest_venc_trib
				where	nr_sequencia	= nr_seq_pag_tributo_w;
		end if;
		
	elsif (nr_seq_rec_resumo_item_w IS NOT NULL AND nr_seq_rec_resumo_item_w::text <> '') then
		select	a.nr_sequencia
		into STRICT	nr_seq_conta_w
		from	pls_rec_glosa_conta a,
			pls_conta_rec_resumo_item b
		where	a.nr_sequencia = b.nr_seq_conta_rec
		and	b.nr_sequencia = nr_seq_rec_resumo_item_w;
		
		select 	max(ie_tipo_movimento)
		into STRICT	ie_tipo_movimento_w
		from	pls_movimento_contabil
		where	nr_sequencia = nr_seq_movimento_p;
		
		qt_vago_w := ctb_pls_atualizar_rec_glosa(nr_seq_conta_w, null, nm_usuario_p, cd_estabelecimento_p, qt_vago_w);
		
		if (ie_tipo_movimento_w = '20') then	
			select 	a.cd_conta_cred_apres,
				a.cd_conta_deb_apres,
				a.nr_seq_esquema_apres
			into STRICT 	cd_conta_credito_w,
				cd_conta_debito_w,
				nr_seq_esquema_w
			from 	pls_conta_rec_resumo_item a
			where 	a.nr_sequencia 	= nr_seq_rec_resumo_item_w;
		
		elsif (ie_tipo_movimento_w = '21') then	
			select 	a.cd_conta_cred,
				a.cd_conta_deb,
				a.nr_seq_esquema
			into STRICT 	cd_conta_credito_w,
				cd_conta_debito_w,
				nr_seq_esquema_w
			from 	pls_conta_rec_resumo_item a
			where 	a.nr_sequencia 	= nr_seq_rec_resumo_item_w;
		
		elsif (ie_tipo_movimento_w = '22') then
			select 	a.cd_conta_cred_pag,
				a.cd_conta_deb_pag,
				a.nr_seq_esquema_pag
			into STRICT 	cd_conta_credito_w,
				cd_conta_debito_w,
				nr_seq_esquema_w
			from 	pls_conta_rec_resumo_item a
			where 	a.nr_sequencia 	= nr_seq_rec_resumo_item_w;
		
		end if;
		
	elsif (nr_seq_pp_item_lote_w IS NOT NULL AND nr_seq_pp_item_lote_w::text <> '') then
		
		select	i.nr_seq_lote
		into STRICT	nr_seq_lote_pagamento_w
		from	pls_pp_item_lote	i
		where	i.nr_sequencia		= nr_seq_pp_item_lote_w;
		
		qt_vago_w := ctb_pls_atualizar_eventos_pp(	nr_seq_lote_pagamento_w, nr_seq_pp_item_lote_w, null, cd_estabelecimento_p, nm_usuario_p, qt_vago_w);
		
		select 	a.cd_conta_debito,
			a.cd_conta_credito,
			a.nr_seq_esquema
		into STRICT 	cd_conta_credito_w,
			cd_conta_debito_w,
			nr_seq_esquema_w
		from 	pls_pp_item_lote a
		where 	a.nr_sequencia 	= nr_seq_pp_item_lote_w;
		
	elsif (nr_seq_pp_base_atual_trib_w IS NOT NULL AND nr_seq_pp_base_atual_trib_w::text <> '') then
	
		select	t.nr_seq_lote
		into STRICT	nr_seq_lote_pagamento_w
		from	pls_pp_base_atual_trib	t
		where	t.nr_sequencia		= nr_seq_pp_base_atual_trib_w;
	
		qt_vago_w := ctb_pls_atualizar_tributo_pp(	nr_seq_lote_pagamento_w, nr_seq_pp_base_atual_trib_w, null, cd_estabelecimento_p, nm_usuario_p, qt_vago_w);
		
		select 	a.cd_conta_debito,
			a.cd_conta_credito,
			a.nr_seq_esquema
		into STRICT 	cd_conta_credito_w,
			cd_conta_debito_w,
			nr_seq_esquema_w
		from 	pls_pp_base_atual_trib a
		where 	a.nr_sequencia 	= nr_seq_pp_base_atual_trib_w;
	else
		if (nr_seq_conta_proc_w IS NOT NULL AND nr_seq_conta_proc_w::text <> '') then
			select	max(nr_seq_conta)
			into STRICT	nr_seq_conta_w
			from	pls_conta_proc
			where	nr_sequencia	= nr_seq_conta_proc_w;
			
			qt_vago_w := ctb_pls_atualizar_prod_med_in(nr_seq_conta_w, nr_seq_conta_proc_w, 0, null, nm_usuario_p, cd_estabelecimento_p, qt_vago_w);
			
			qt_vago_w := ctb_pls_atualizar_prod_med_res(	nr_seq_conta_w, nr_seq_conta_proc_w, null, null, nm_usuario_p, cd_estabelecimento_p, qt_vago_w, dt_referencia_w);
		elsif (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') then
			select	max(nr_seq_conta)
			into STRICT	nr_seq_conta_w
			from	pls_conta_mat
			where	nr_sequencia	= nr_seq_conta_mat_w;
			
			qt_vago_w := ctb_pls_atualizar_prod_med_in(nr_seq_conta_w, 0, nr_seq_conta_mat_w, null, nm_usuario_p, cd_estabelecimento_p, qt_vago_w);
			
			qt_vago_w := ctb_pls_atualizar_prod_med_res(	nr_seq_conta_w, null, nr_seq_conta_mat_w, null, nm_usuario_p, cd_estabelecimento_p, qt_vago_w, dt_referencia_w);
		end if;
		
		if (nr_seq_conta_w IS NOT NULL AND nr_seq_conta_w::text <> '') then
			if (ie_conta_glosa_w = 'C') then
				if (qt_prest_pgto_w > 0 and (nr_seq_conta_resumo_w IS NOT NULL AND nr_seq_conta_resumo_w::text <> '')) then
					select	nr_seq_esquema,
						cd_conta_cred,
						cd_conta_deb
					into STRICT	nr_seq_esquema_w,
						cd_conta_credito_w,
						cd_conta_debito_w
					from	pls_conta_medica_resumo
					where	nr_sequencia	= nr_seq_conta_resumo_w;
				elsif (qt_outro_w > 0) then			
					if (nr_seq_conta_proc_w IS NOT NULL AND nr_seq_conta_proc_w::text <> '') then
						select	nr_seq_esquema,
							cd_conta_cred,
							cd_conta_deb
						into STRICT	nr_seq_esquema_w,
							cd_conta_credito_w,
							cd_conta_debito_w
						from	pls_conta_proc
						where	nr_sequencia	= nr_seq_conta_proc_w;
					elsif (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') then
						select	nr_seq_esquema,
							cd_conta_cred,
							cd_conta_deb
						into STRICT	nr_seq_esquema_w,
							cd_conta_credito_w,
							cd_conta_debito_w
						from	pls_conta_mat
						where	nr_sequencia	= nr_seq_conta_mat_w;
					end if;
				end if;
			elsif (ie_conta_glosa_w = 'G') then
				if (qt_prest_pgto_w > 0 and (nr_seq_conta_resumo_w IS NOT NULL AND nr_seq_conta_resumo_w::text <> '')) then
					select	nr_seq_esquema_glosa,
						cd_conta_glosa_cred,
						cd_conta_glosa_deb
					into STRICT	nr_seq_esquema_w,
						cd_conta_credito_w,
						cd_conta_debito_w
					from	pls_conta_medica_resumo
					where	nr_sequencia	= nr_seq_conta_resumo_w;
				elsif (qt_outro_w > 0) then			
					if (nr_seq_conta_proc_w IS NOT NULL AND nr_seq_conta_proc_w::text <> '') then
							select	nr_seq_esquema_glosa,
								cd_conta_glosa_cred,
								cd_conta_glosa_deb
							into STRICT	nr_seq_esquema_w,
								cd_conta_credito_w,
								cd_conta_debito_w
							from	pls_conta_proc
							where	nr_sequencia	= nr_seq_conta_proc_w;
					elsif (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') then
							select	nr_seq_esquema_glosa,
								cd_conta_glosa_cred,
								cd_conta_glosa_deb
							into STRICT	nr_seq_esquema_w,
								cd_conta_credito_w,
								cd_conta_debito_w
							from	pls_conta_mat
							where	nr_sequencia	= nr_seq_conta_mat_w;
					end if;
				end if;
			elsif (ie_conta_glosa_w = 'TC') then		
				if (nr_seq_conta_proc_w IS NOT NULL AND nr_seq_conta_proc_w::text <> '') then
					select	nr_seq_esquema_tx_inter,
						cd_conta_cred_tx_inter,
						cd_conta_deb_tx_inter
					into STRICT	nr_seq_esquema_w,
						cd_conta_credito_w,
						cd_conta_debito_w
					from	pls_conta_proc
					where	nr_sequencia	= nr_seq_conta_proc_w;
				elsif (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') then
					select	nr_seq_esquema_tx_inter,
						cd_conta_cred_tx_inter,
						cd_conta_deb_tx_inter
					into STRICT	nr_seq_esquema_w,
						cd_conta_credito_w,
						cd_conta_debito_w
					from	pls_conta_mat
					where	nr_sequencia	= nr_seq_conta_mat_w;
				end if;
			elsif (ie_conta_glosa_w = 'TG') then	
				if (nr_seq_conta_proc_w IS NOT NULL AND nr_seq_conta_proc_w::text <> '') then
					select	nr_seq_esquema_tx_inter_glosa,
						cd_conta_cred_tx_inter_glosa,
						cd_conta_deb_tx_inter_glosa
					into STRICT	nr_seq_esquema_w,
						cd_conta_credito_w,
						cd_conta_debito_w
					from	pls_conta_proc
					where	nr_sequencia	= nr_seq_conta_proc_w;
				elsif (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') then
					select	nr_seq_esquema_tx_inter_glosa,
						cd_conta_cred_tx_inter_glosa,
						cd_conta_deb_tx_inter_glosa
					into STRICT	nr_seq_esquema_w,
						cd_conta_credito_w,
						cd_conta_debito_w
					from	pls_conta_mat
					where	nr_sequencia	= nr_seq_conta_mat_w;
				end if;
			end if;
		end if;
	end if;
	
	if (coalesce(nr_seq_esquema_w::text, '') = '') then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '1';
	elsif	((coalesce(cd_conta_credito_w::text, '') = '') or (coalesce(cd_conta_debito_w::text, '') = '')) then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '2';
	else
		ie_corrigido_w	:= 'S';
	end if;
elsif (cd_tipo_lote_contabil_w = 33) then
	if (nr_seq_conta_proc_w IS NOT NULL AND nr_seq_conta_proc_w::text <> '') then
		select	a.nr_seq_conta
		into STRICT	nr_seq_conta_w
		from	pls_conta_proc	a
		where	a.nr_sequencia	= nr_seq_conta_proc_w;
		
		qt_vago_w := ctb_pls_atualizar_desp_interc(null, nr_seq_conta_w, nr_seq_conta_proc_w, 0, null, nm_usuario_p, cd_estabelecimento_p, qt_vago_w);
	elsif (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') then
		select	a.nr_seq_conta
		into STRICT	nr_seq_conta_w
		from	pls_conta_mat	a
		where	a.nr_sequencia	= nr_seq_conta_mat_w;
		
		qt_vago_w := ctb_pls_atualizar_desp_interc(null, nr_seq_conta_w, 0, nr_seq_conta_mat_w, null, nm_usuario_p, cd_estabelecimento_p, qt_vago_w);
	end if;
	
        select  max(nr_seq_plano)
        into STRICT    nr_seq_plano_w
        from    pls_conta
        where   nr_sequencia = nr_seq_conta_w;

	if (ie_conta_glosa_w = 'C') then
		if (nr_seq_conta_proc_w IS NOT NULL AND nr_seq_conta_proc_w::text <> '') then
			select	nr_seq_esquema,
				cd_conta_cred,
				cd_conta_deb
			into STRICT	nr_seq_esquema_w,
				cd_conta_credito_w,
				cd_conta_debito_w
			from	pls_conta_proc
			where	nr_sequencia	= nr_seq_conta_proc_w;
		elsif (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') then
			select	nr_seq_esquema,
				cd_conta_cred,
				cd_conta_deb
			into STRICT	nr_seq_esquema_w,
				cd_conta_credito_w,
				cd_conta_debito_w
			from	pls_conta_mat
			where	nr_sequencia	= nr_seq_conta_mat_w;
		end if;
	elsif (ie_conta_glosa_w = 'G') then
		if (nr_seq_conta_proc_w IS NOT NULL AND nr_seq_conta_proc_w::text <> '') then
			select	nr_seq_esquema_glosa,
				cd_conta_glosa_cred,
				cd_conta_glosa_deb
			into STRICT	nr_seq_esquema_w,
				cd_conta_credito_w,
				cd_conta_debito_w
			from	pls_conta_proc
			where	nr_sequencia	= nr_seq_conta_proc_w;
		elsif (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') then
			select	nr_seq_esquema_glosa,
				cd_conta_glosa_cred,
				cd_conta_glosa_deb
			into STRICT	nr_seq_esquema_w,
				cd_conta_credito_w,
				cd_conta_debito_w
			from	pls_conta_mat
			where	nr_sequencia	= nr_seq_conta_mat_w;
		end if;
	end if;
	
	if (coalesce(nr_seq_esquema_w::text, '') = '') then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '1';
	elsif	((coalesce(cd_conta_credito_w::text, '') = '') or (coalesce(cd_conta_debito_w::text, '') = '')) then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '2';
        elsif (coalesce(nr_seq_plano_w, 0) = 0) then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '8';
	else
		ie_corrigido_w	:= 'S';
	end if;
elsif (cd_tipo_lote_contabil_w = 42) then /* OPS - Provisao de coparticipacao */
	select	nr_seq_conta
	into STRICT	nr_seq_conta_w
	from	pls_conta_copartic_contab
	where	nr_sequencia	= nr_seq_conta_copartic_w;
	
	qt_vago_w := ctb_pls_atualizar_prov_copart(nr_seq_conta_w, null, null, nm_usuario_p, cd_estabelecimento_p, qt_vago_w, nr_seq_conta_copartic_w);
	
	select	nr_seq_esquema_prov,
		cd_conta_cred_provisao,
		cd_conta_deb_provisao
	into STRICT	nr_seq_esquema_w,
		cd_conta_credito_w,
		cd_conta_debito_w
	from	pls_conta_copartic_contab
	where	nr_sequencia	= nr_seq_conta_copartic_w;

        select  max(nr_seq_plano)
        into STRICT    nr_seq_plano_w
        from    pls_conta
        where   nr_sequencia = nr_seq_conta_w;
	
	if (coalesce(nr_seq_esquema_w::text, '') = '') then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '1';
	elsif	((coalesce(cd_conta_credito_w::text, '') = '') or (coalesce(cd_conta_debito_w::text, '') = '')) then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '2';
        elsif (coalesce(nr_seq_plano_w, 0) = 0) then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '8';
	else
		ie_corrigido_w	:= 'S';
	end if;
elsif (cd_tipo_lote_contabil_w = 43) then /* OPS - Provisao de Faturamento */
	

		
	if (nr_seq_pos_taxa_contab_w IS NOT NULL AND nr_seq_pos_taxa_contab_w::text <> '') then		
		select	nr_seq_conta
		into STRICT	nr_seq_conta_w
		from	pls_conta_pos_estab_contab
		where	nr_sequencia	= nr_seq_conta_pos_estab_w;

		qt_vago_w := ctb_pls_atualizar_taxa_adm(nr_seq_conta_w, nr_seq_pos_taxa_contab_w, null, nm_usuario_p, cd_estabelecimento_p, qt_vago_w);
		
		select	nr_seq_esquema,
			cd_conta_cred,
			cd_conta_deb
		into STRICT	nr_seq_esquema_w,
			cd_conta_credito_w,
			cd_conta_debito_w
		from	pls_conta_pos_taxa_contab
		where	nr_sequencia	= nr_seq_pos_taxa_contab_w;
	elsif (nr_seq_conta_pos_estab_w IS NOT NULL AND nr_seq_conta_pos_estab_w::text <> '') then
		select	nr_seq_conta
		into STRICT	nr_seq_conta_w
		from	pls_conta_pos_estab_contab
		where	nr_sequencia	= nr_seq_conta_pos_estab_w;

		qt_vago_w := ctb_pls_atualizar_prov_fat(nr_seq_conta_w, nr_seq_conta_pos_estab_w, null, null, nm_usuario_p, cd_estabelecimento_p, qt_vago_w);
		
		select	nr_seq_esquema_prov,
			cd_conta_cred_provisao,
			cd_conta_deb_provisao
		into STRICT	nr_seq_esquema_w,
			cd_conta_credito_w,
			cd_conta_debito_w
		from	pls_conta_pos_estab_contab
		where	nr_sequencia	= nr_seq_conta_pos_estab_w;
	elsif (nr_seq_conta_pos_estab_prev_w IS NOT NULL AND nr_seq_conta_pos_estab_prev_w::text <> '') then
		select	nr_seq_conta
		into STRICT	nr_seq_conta_w
		from	pls_conta_pos_estab_prev
		where	nr_sequencia	= nr_seq_conta_pos_estab_prev_w;

		qt_vago_w := ctb_pls_atualizar_prov_fat(nr_seq_conta_w, null, nr_seq_conta_pos_estab_prev_w, null, nm_usuario_p, cd_estabelecimento_p, qt_vago_w);
		
		select	nr_seq_esquema_prov,
			cd_conta_cred_provisao,
			cd_conta_deb_provisao
		into STRICT	nr_seq_esquema_w,
			cd_conta_credito_w,
			cd_conta_debito_w
		from	pls_conta_pos_estab_prev
		where	nr_sequencia	= nr_seq_conta_pos_estab_prev_w;
	end if;

	select  max(nr_seq_plano)
	into STRICT    nr_seq_plano_w
	from    pls_conta
	where   nr_sequencia = nr_seq_conta_w;
					
	if (coalesce(nr_seq_esquema_w::text, '') = '') then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '1';
	elsif	((coalesce(cd_conta_credito_w::text, '') = '') or (coalesce(cd_conta_debito_w::text, '') = '')) then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '2';
	elsif (coalesce(nr_seq_plano_w, 0) = 0) then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '8';
	else
		ie_corrigido_w	:= 'S';
	end if;
elsif (cd_tipo_lote_contabil_w = 32) then /* OPS - Provisao de Faturamento */
	if (nr_seq_ppsc_movimento_w IS NOT NULL AND nr_seq_ppsc_movimento_w::text <> '') then
		select	nr_seq_lote
		into STRICT	nr_seq_lote_ppsc_w
		from	pls_ppsc_movimento
		where	nr_sequencia	= nr_seq_ppsc_movimento_w;
	elsif (nr_seq_ppsc_mov_item_w IS NOT NULL AND nr_seq_ppsc_mov_item_w::text <> '') then
		select	b.nr_seq_lote
		into STRICT	nr_seq_lote_ppsc_w
		from	pls_ppsc_movimento_item	a,
			pls_ppsc_movimento	b
		where	a.nr_seq_movimento	= b.nr_sequencia
		and	a.nr_sequencia		= nr_seq_ppsc_mov_item_w;
	end if;
	
	CALL ctb_pls_atualizar_ppsc(nr_seq_lote_ppsc_w, nr_seq_ppsc_movimento_w, nr_seq_ppsc_mov_item_w, null, nm_usuario_p, cd_estabelecimento_p);
	
	if (nr_seq_ppsc_movimento_w IS NOT NULL AND nr_seq_ppsc_movimento_w::text <> '') then
		select	CASE WHEN ie_conta_glosa_w='R' THEN  nr_seq_regra_cont_reversao  ELSE nr_seq_regra_contabil END ,
			CASE WHEN ie_conta_glosa_w='R' THEN  cd_conta_cred_reversao  ELSE cd_conta_credito END ,
			CASE WHEN ie_conta_glosa_w='R' THEN  cd_classif_deb_reversao  ELSE cd_conta_debito END
		into STRICT	nr_seq_esquema_w,
			cd_conta_credito_w,
			cd_conta_debito_w
		from	pls_ppsc_movimento
		where	nr_sequencia	= nr_seq_ppsc_movimento_w;
	elsif (nr_seq_ppsc_mov_item_w IS NOT NULL AND nr_seq_ppsc_mov_item_w::text <> '') then
		select	CASE WHEN ie_conta_glosa_w='R' THEN  nr_seq_regra_cont_reversao  ELSE nr_seq_regra_contabil END ,
			CASE WHEN ie_conta_glosa_w='R' THEN  cd_conta_cred_reversao  ELSE cd_conta_cred END ,
			CASE WHEN ie_conta_glosa_w='R' THEN  cd_classif_deb_reversao  ELSE cd_conta_deb END
		into STRICT	nr_seq_esquema_w,
			cd_conta_credito_w,
			cd_conta_debito_w
		from	pls_ppsc_movimento_item
		where	nr_sequencia	= nr_seq_ppsc_mov_item_w;
	end if;
	
	if (coalesce(nr_seq_esquema_w::text, '') = '') then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '1';
	elsif	((coalesce(cd_conta_credito_w::text, '') = '') or (coalesce(cd_conta_debito_w::text, '') = '')) then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '2';
	else
		ie_corrigido_w	:= 'S';
	end if;
elsif (cd_tipo_lote_contabil_w = 44) then /* OPS - Receitas com Faturamento */
	if (nr_seq_fatura_proc_w IS NOT NULL AND nr_seq_fatura_proc_w::text <> '') then
		select	b.nr_sequencia
		into STRICT	nr_seq_fatura_w
		from	pls_fatura_proc		e,
			pls_fatura_conta	d,
			pls_fatura_evento	c,
			pls_fatura		b
		where	e.nr_seq_fatura_conta	= d.nr_sequencia
		and	d.nr_seq_fatura_evento	= c.nr_sequencia
		and	c.nr_seq_fatura		= b.nr_sequencia
		and	e.nr_sequencia		= nr_seq_fatura_proc_w;
		
		CALL ctb_pls_atualizar_faturamento(nr_seq_fatura_w, nr_seq_fatura_proc_w, nr_seq_fatura_mat_w, null, nm_usuario_p, cd_estabelecimento_p);
	elsif (nr_seq_fatura_mat_w IS NOT NULL AND nr_seq_fatura_mat_w::text <> '') then
		select	b.nr_sequencia
		into STRICT	nr_seq_fatura_w
		from	pls_fatura_mat		e,
			pls_fatura_conta	d,
			pls_fatura_evento	c,
			pls_fatura		b
		where	e.nr_seq_fatura_conta	= d.nr_sequencia
		and	d.nr_seq_fatura_evento	= c.nr_sequencia
		and	c.nr_seq_fatura		= b.nr_sequencia
		and	e.nr_sequencia		= nr_seq_fatura_mat_w;
		
		CALL ctb_pls_atualizar_faturamento(nr_seq_fatura_w, nr_seq_fatura_proc_w, nr_seq_fatura_mat_w, null, nm_usuario_p, cd_estabelecimento_p);
	elsif (nr_seq_fat_item_trib_w IS NOT NULL AND nr_seq_fat_item_trib_w::text <> '') then
		select	a.nr_seq_fatura
		into STRICT	nr_seq_fatura_w
		from	pls_fatura_trib		a,
			pls_fatura_item_trib	b
		where	a.nr_sequencia	= b.nr_seq_fatura_trib
		and	b.nr_sequencia	= nr_seq_fat_item_trib_w;
	
		CALL pls_atualizar_tributo_fat(nm_usuario_p, cd_estabelecimento_p, nr_seq_fatura_w, null);
	end if;
	
	if (nr_seq_fatura_proc_w IS NOT NULL AND nr_seq_fatura_proc_w::text <> '') then
		select	nr_seq_esquema,
			cd_conta_credito,
			cd_conta_debito
		into STRICT	nr_seq_esquema_w,
			cd_conta_credito_w,
			cd_conta_debito_w
		from	pls_fatura_proc
		where	nr_sequencia	= nr_seq_fatura_proc_w;
	elsif (nr_seq_fatura_mat_w IS NOT NULL AND nr_seq_fatura_mat_w::text <> '') then
		select	nr_seq_esquema,
			cd_conta_credito,
			cd_conta_debito
		into STRICT	nr_seq_esquema_w,
			cd_conta_credito_w,
			cd_conta_debito_w
		from	pls_fatura_mat
		where	nr_sequencia	= nr_seq_fatura_mat_w;
	elsif (nr_seq_fat_item_trib_w IS NOT NULL AND nr_seq_fat_item_trib_w::text <> '') then
		select	coalesce(nr_seq_esquema,nr_seq_esquema_prov),
			coalesce(cd_conta_cred,cd_conta_prov_cred),
			coalesce(cd_conta_deb,cd_conta_prov_deb)
		into STRICT	nr_seq_esquema_w,
			cd_conta_credito_w,
			cd_conta_debito_w
		from	pls_fatura_item_trib
		where	nr_sequencia	 = nr_seq_fat_item_trib_w;
	end if;
	
	if (coalesce(nr_seq_esquema_w::text, '') = '') then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '1';
	elsif	((coalesce(cd_conta_credito_w::text, '') = '') or (coalesce(cd_conta_debito_w::text, '') = '')) then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '2';
	else
		ie_corrigido_w	:= 'S';
	end if;
elsif (cd_tipo_lote_contabil_w = 46) then
	CALL ctb_pls_atualizar_cancel_mens(null, nr_seq_item_mens_w, null, nm_usuario_p, cd_estabelecimento_p);
	
	select	nr_seq_esquema,
		cd_conta_rec,
		cd_conta_deb,
		cd_conta_ato_cooperado,
		cd_conta_ato_auxiliar,
		cd_conta_ato_nao_coop
	into STRICT	nr_seq_esquema_w,
		cd_conta_credito_w,
		cd_conta_debito_w,
		cd_conta_ato_coop_w,
		cd_conta_ato_aux_w,
		cd_conta_ato_nao_coop_w
	from	pls_mensalidade_seg_item
	where	nr_sequencia	= nr_seq_item_mens_w;
	
	if (coalesce(nr_seq_esquema_w::text, '') = '') then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '1';
	elsif	((((coalesce(cd_conta_credito_w::text, '') = '') or (coalesce(cd_conta_debito_w::text, '') = '')) and
		((coalesce(cd_conta_ato_coop_w::text, '') = '') or (coalesce(cd_conta_ato_aux_w::text, '') = '') or (coalesce(cd_conta_ato_nao_coop_w::text, '') = ''))) or
		((coalesce(cd_conta_credito_w::text, '') = '') and (coalesce(cd_conta_debito_w::text, '') = ''))) then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '2';
	else
		ie_corrigido_w	:= 'S';
	end if;
elsif (cd_tipo_lote_contabil_w = 47) then /* OPS - Cancelamento de Faturamento */
	if (nr_seq_fatura_proc_w IS NOT NULL AND nr_seq_fatura_proc_w::text <> '') then
		select	f.nr_seq_lote
		into STRICT	nr_seq_lote_cancel_w
		from	pls_fatura_proc		e,
			pls_fatura_conta	d,
			pls_fatura_evento	c,
			pls_fatura		b,
			pls_cancel_rec_fatura	f
		where	e.nr_seq_fatura_conta	= d.nr_sequencia
		and	d.nr_seq_fatura_evento	= c.nr_sequencia
		and	c.nr_seq_fatura		= b.nr_sequencia
		and	b.nr_seq_cancel_fat	= f.nr_sequencia
		and	e.nr_sequencia		= nr_seq_fatura_proc_w;
	elsif (nr_seq_fatura_mat_w IS NOT NULL AND nr_seq_fatura_mat_w::text <> '') then
		select	f.nr_seq_lote
		into STRICT	nr_seq_lote_cancel_w
		from	pls_fatura_mat		e,
			pls_fatura_conta	d,
			pls_fatura_evento	c,
			pls_fatura		b,
			pls_cancel_rec_fatura	f
		where	e.nr_seq_fatura_conta	= d.nr_sequencia
		and	d.nr_seq_fatura_evento	= c.nr_sequencia
		and	c.nr_seq_fatura		= b.nr_sequencia
		and	b.nr_seq_cancel_fat	= f.nr_sequencia
		and	e.nr_sequencia		= nr_seq_fatura_mat_w;
	end if;
	
	CALL ctb_pls_atualizar_cancel_fat(nr_seq_lote_cancel_w, nr_seq_fatura_proc_w, nr_seq_fatura_mat_w, null, nm_usuario_p, cd_estabelecimento_p);
	
	if (nr_seq_fatura_proc_w IS NOT NULL AND nr_seq_fatura_proc_w::text <> '') then
		select	nr_seq_esquema,
			cd_conta_credito,
			cd_conta_debito
		into STRICT	nr_seq_esquema_w,
			cd_conta_credito_w,
			cd_conta_debito_w
		from	pls_fatura_proc
		where	nr_sequencia	= nr_seq_fatura_proc_w;
	elsif (nr_seq_fatura_mat_w IS NOT NULL AND nr_seq_fatura_mat_w::text <> '') then
		select	nr_seq_esquema,
			cd_conta_credito,
			cd_conta_debito
		into STRICT	nr_seq_esquema_w,
			cd_conta_credito_w,
			cd_conta_debito_w
		from	pls_fatura_mat
		where	nr_sequencia	= nr_seq_fatura_mat_w;
	end if;
	
	if (coalesce(nr_seq_esquema_w::text, '') = '') then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '1';
	elsif	((coalesce(cd_conta_credito_w::text, '') = '') or (coalesce(cd_conta_debito_w::text, '') = '')) then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '2';
	else
		ie_corrigido_w	:= 'S';
	end if;
elsif (cd_tipo_lote_contabil_w = 23) then
	if (nr_seq_conta_proc_w IS NOT NULL AND nr_seq_conta_proc_w::text <> '') then
		select	max(nr_seq_conta)
		into STRICT	nr_seq_conta_w
		from	pls_conta_proc
		where	nr_sequencia	= nr_seq_conta_proc_w;
		
		qt_vago_w := ctb_pls_atualizar_reembolso_in(null, nr_seq_conta_w, nr_seq_conta_proc_w, 0, null, nm_usuario_p, cd_estabelecimento_p, qt_vago_w);
	elsif (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') then
		select	max(nr_seq_conta)
		into STRICT	nr_seq_conta_w
		from	pls_conta_mat
		where	nr_sequencia	= nr_seq_conta_mat_w;
		
		qt_vago_w := ctb_pls_atualizar_reembolso_in(null, nr_seq_conta_w, 0, nr_seq_conta_mat_w, null, nm_usuario_p, cd_estabelecimento_p, qt_vago_w);
	end if;
	
	if (nr_seq_conta_w IS NOT NULL AND nr_seq_conta_w::text <> '') then
		if (nr_seq_conta_proc_w IS NOT NULL AND nr_seq_conta_proc_w::text <> '') then
			select	nr_seq_esquema,
				cd_conta_cred,
				cd_conta_deb
			into STRICT	nr_seq_esquema_w,
				cd_conta_credito_w,
				cd_conta_debito_w
			from	pls_conta_proc
			where	nr_sequencia	= nr_seq_conta_proc_w;
		elsif (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') then
			select	nr_seq_esquema,
				cd_conta_cred,
				cd_conta_deb
			into STRICT	nr_seq_esquema_w,
				cd_conta_credito_w,
				cd_conta_debito_w
			from	pls_conta_mat
			where	nr_sequencia	= nr_seq_conta_mat_w;
		end if;
	end if;
	
	if (coalesce(nr_seq_esquema_w::text, '') = '') then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '1';
	elsif	((coalesce(cd_conta_credito_w::text, '') = '') or (coalesce(cd_conta_debito_w::text, '') = '')) then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '2';
	else
		ie_corrigido_w	:= 'S';
	end if;

elsif (cd_tipo_lote_contabil_w = 27) then
	if (ie_conta_glosa_w in ('PR', 'AC', 'DC')) then
		select 	max(nr_seq_competencia)
		into STRICT	nr_seq_competencia_w
		from	pls_processo_contas_comp
		where	nr_sequencia = nr_seq_processo_conta_comp_w;

		qt_vago_w := ctb_pls_atualizar_ressa(null, nm_usuario_p, cd_estabelecimento_p, null, nr_seq_competencia_w, nr_seq_processo_conta_comp_w, qt_vago_w, null);

	elsif (ie_conta_glosa_w in ('DF', 'RE')) then
		select 	max(nr_seq_processo)
		into STRICT 	nr_seq_processo_w
		from 	pls_processo_conta
		where 	nr_sequencia = nr_seq_processo_conta_w;

		qt_vago_w := ctb_pls_atualizar_ressa(nr_seq_processo_w, nm_usuario_p, cd_estabelecimento_p, nr_seq_processo_conta_w, null, null, qt_vago_w, null);
	end if;
	
	if (ie_conta_glosa_w = 'PR') then
		select	max(nr_seq_esquema_prov),
			max(cd_conta_cred_prov),
			max(cd_conta_deb_prov)
		into STRICT	nr_seq_esquema_w,
			cd_conta_credito_w,
			cd_conta_debito_w
		from	pls_processo_contas_comp
		where	nr_sequencia			= nr_seq_processo_conta_comp_w;
	elsif (ie_conta_glosa_w in ('AC', 'DC')) then
		select	max(nr_seq_esquema_ajuste),
			max(cd_conta_cred_ajuste),
			max(cd_conta_deb_ajuste)
		into STRICT	nr_seq_esquema_w,
			cd_conta_credito_w,
			cd_conta_debito_w
		from	pls_processo_contas_comp
		where	nr_sequencia			= nr_seq_processo_conta_comp_w;
	elsif (ie_conta_glosa_w = 'DF') then
		select	max(nr_seq_esquema_def),
			max(cd_conta_deferido_cred),
			max(cd_conta_deferido_deb)
		into STRICT	nr_seq_esquema_w,
			cd_conta_credito_w,
			cd_conta_debito_w
		from	pls_processo_conta
		where	nr_sequencia			= nr_seq_processo_conta_w;
	elsif (ie_conta_glosa_w = 'RE') then
		select	max(nr_seq_esquema_ressarc),
			max(cd_conta_cred),
			max(cd_conta_deb)
		into STRICT	nr_seq_esquema_w,
			cd_conta_credito_w,
			cd_conta_debito_w
		from	pls_processo_conta
		where	nr_sequencia			= nr_seq_processo_conta_w;
	end if;

	if (coalesce(nr_seq_esquema_w::text, '') = '') then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '1';
	elsif	((coalesce(cd_conta_credito_w::text, '') = '') or (coalesce(cd_conta_debito_w::text, '') = '')) then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '2';
	else
		ie_corrigido_w	:= 'S';
	end if;


elsif (cd_tipo_lote_contabil_w = 38) then	
	if (nr_seq_conta_proc_w IS NOT NULL AND nr_seq_conta_proc_w::text <> '') then
		select	max(a.nr_sequencia)
		into STRICT	nr_seq_lote_disc_w
		from	pls_discussao_proc 		c,
			pls_contestacao_discussao	b,
			pls_lote_discussao		a			
		where	a.nr_sequencia		= b.nr_seq_lote
		and	b.nr_sequencia		= c.nr_seq_discussao
		and	c.nr_sequencia		= nr_seq_conta_proc_w;
		
	elsif (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') then
		select	max(a.nr_sequencia)
		into STRICT	nr_seq_lote_disc_w
		from	pls_discussao_mat 		c,
			pls_contestacao_discussao	b,
			pls_lote_discussao		a			
		where	a.nr_sequencia		= b.nr_seq_lote
		and	b.nr_sequencia		= c.nr_seq_discussao
		and	c.nr_sequencia		= nr_seq_conta_mat_w;
	end if;
		
	qt_vago_w := ctb_pls_atualizar_discussao(nr_seq_lote_disc_w, null, nm_usuario_p, cd_estabelecimento_p, qt_vago_w);
	
	if (nr_seq_conta_proc_w IS NOT NULL AND nr_seq_conta_proc_w::text <> '') then
		select	nr_seq_esquema,
			cd_conta_cred,
			cd_conta_deb
		into STRICT	nr_seq_esquema_w,
			cd_conta_credito_w,
			cd_conta_debito_w
		from	pls_discussao_proc
		where	nr_sequencia	= nr_seq_conta_proc_w;
	elsif (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') then
		select	nr_seq_esquema,
			cd_conta_cred,
			cd_conta_deb
		into STRICT	nr_seq_esquema_w,
			cd_conta_credito_w,
			cd_conta_debito_w
		from	pls_discussao_mat
		where	nr_sequencia	= nr_seq_conta_mat_w;
	end if;
	
	if (coalesce(nr_seq_esquema_w::text, '') = '') then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '1';
	elsif	((coalesce(cd_conta_credito_w::text, '') = '') or (coalesce(cd_conta_debito_w::text, '') = '')) then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '2';
	else
		ie_corrigido_w	:= 'S';
	end if;
	
elsif (cd_tipo_lote_contabil_w = 57) then	
	if (nr_seq_aviso_proc_item_w IS NOT NULL AND nr_seq_aviso_proc_item_w::text <> '') then
		select	max(a.nr_seq_lote),
			max(a.nr_sequencia)
		into STRICT	nr_seq_lote_aviso_w,
			nr_seq_arquivo_w
		from	ptu_aviso_arquivo	a,
			ptu_aviso_protocolo	ap,
			ptu_aviso_conta		ac,
			ptu_aviso_procedimento	p,
			ptu_aviso_proc_item	i
		where	ap.nr_seq_arquivo	= a.nr_sequencia
		and	ap.nr_sequencia		= ac.nr_seq_aviso_protocolo
		and	ac.nr_sequencia		= p.nr_seq_aviso_conta
		and	p.nr_sequencia		= i.nr_seq_aviso_procedimento
		and	i.nr_sequencia		= nr_seq_aviso_proc_item_w;
		
		qt_vago_w := ctb_pls_atualizar_aviso_cobr(nr_seq_lote_aviso_w, nr_seq_arquivo_w, 0, 0, nr_seq_aviso_proc_item_w, 0, null, null, null, null, nm_usuario_p, cd_estabelecimento_p, qt_vago_w);
		
	elsif (nr_seq_aviso_mat_item_w IS NOT NULL AND nr_seq_aviso_mat_item_w::text <> '') then
		select	max(a.nr_seq_lote),
			max(a.nr_sequencia)
		into STRICT	nr_seq_lote_aviso_w,
			nr_seq_arquivo_w
		from	ptu_aviso_arquivo	a,
			ptu_aviso_protocolo	ap,
			ptu_aviso_conta		ac,
			ptu_aviso_material	m,
			ptu_aviso_mat_item	i
		where	ap.nr_seq_arquivo	= a.nr_sequencia
		and	ap.nr_sequencia		= ac.nr_seq_aviso_protocolo
		and	ac.nr_sequencia		= m.nr_seq_aviso_conta
		and	m.nr_sequencia		= i.nr_seq_aviso_material
		and	i.nr_sequencia		= nr_seq_aviso_mat_item_w;
		
		qt_vago_w := ctb_pls_atualizar_aviso_cobr(nr_seq_lote_aviso_w, nr_seq_arquivo_w, 0, 0, 0, nr_seq_aviso_mat_item_w, null, null, null, null, nm_usuario_p, cd_estabelecimento_p, qt_vago_w);
		
	elsif (nr_seq_aviso_proc_w IS NOT NULL AND nr_seq_aviso_proc_w::text <> '') then
		select	max(a.nr_seq_lote),
			max(a.nr_sequencia)
		into STRICT	nr_seq_lote_aviso_w,
			nr_seq_arquivo_w
		from	ptu_aviso_arquivo	a,
			ptu_aviso_protocolo	ap,
			ptu_aviso_conta		ac,
			ptu_aviso_procedimento	p
		where	ap.nr_seq_arquivo	= a.nr_sequencia
		and	ap.nr_sequencia		= ac.nr_seq_aviso_protocolo
		and	ac.nr_sequencia		= p.nr_seq_aviso_conta
		and	p.nr_sequencia		= nr_seq_aviso_proc_w;
		
		qt_vago_w := ctb_pls_atualizar_aviso_cobr(nr_seq_lote_aviso_w, nr_seq_arquivo_w, nr_seq_aviso_proc_w, 0, 0, 0, null, null, null, null, nm_usuario_p, cd_estabelecimento_p, qt_vago_w);
		
	elsif (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') then
		select	max(a.nr_seq_lote),
			max(a.nr_sequencia)
		into STRICT	nr_seq_lote_aviso_w,
			nr_seq_arquivo_w
		from	ptu_aviso_arquivo	a,
			ptu_aviso_protocolo	ap,
			ptu_aviso_conta		ac,
			ptu_aviso_material	m
		where	ap.nr_seq_arquivo	= a.nr_sequencia
		and	ap.nr_sequencia		= ac.nr_seq_aviso_protocolo
		and	ac.nr_sequencia		= m.nr_seq_aviso_conta
		and	m.nr_sequencia		= nr_seq_conta_mat_w;
		
		qt_vago_w := ctb_pls_atualizar_aviso_cobr(nr_seq_lote_aviso_w, nr_seq_arquivo_w, 0, nr_seq_conta_mat_w, 0, 0, null, null, null, null, nm_usuario_p, cd_estabelecimento_p, qt_vago_w);
	end if;
	
	if (nr_seq_aviso_proc_item_w IS NOT NULL AND nr_seq_aviso_proc_item_w::text <> '') then
		select	nr_seq_esquema,
			cd_conta_credito,
			cd_conta_debito
		into STRICT	nr_seq_esquema_w,
			cd_conta_credito_w,
			cd_conta_debito_w
		from	ptu_aviso_proc_item
		where	nr_sequencia	= nr_seq_aviso_proc_item_w;
		
	elsif (nr_seq_aviso_mat_item_w IS NOT NULL AND nr_seq_aviso_mat_item_w::text <> '') then
		select	nr_seq_esquema,
			cd_conta_credito,
			cd_conta_debito
		into STRICT	nr_seq_esquema_w,
			cd_conta_credito_w,
			cd_conta_debito_w
		from	ptu_aviso_mat_item
		where	nr_sequencia	= nr_seq_aviso_mat_item_w;
		
	elsif (nr_seq_aviso_proc_w IS NOT NULL AND nr_seq_aviso_proc_w::text <> '') then
		select	nr_seq_esquema,
			cd_conta_credito,
			cd_conta_debito
		into STRICT	nr_seq_esquema_w,
			cd_conta_credito_w,
			cd_conta_debito_w
		from	ptu_aviso_procedimento
		where	nr_sequencia	= nr_seq_aviso_proc_w;
		
	elsif (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') then
		select	nr_seq_esquema,
			cd_conta_credito,
			cd_conta_debito
		into STRICT	nr_seq_esquema_w,
			cd_conta_credito_w,
			cd_conta_debito_w
		from	ptu_aviso_material
		where	nr_sequencia	= nr_seq_conta_mat_w;
	end if;
	
	if (coalesce(nr_seq_esquema_w::text, '') = '') then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '1';
	elsif	((coalesce(cd_conta_credito_w::text, '') = '') or (coalesce(cd_conta_debito_w::text, '') = '')) then
		ie_corrigido_w	:= 'N';
		ie_status_w	:= '2';
	else
		ie_corrigido_w	:= 'S';
	end if;
end if;

if (ie_corrigido_w = 'N') then
	update	pls_movimento_contabil
	set	ie_status		= ie_status_w
	where	nr_sequencia		= nr_seq_movimento_p;
end if;

if (ie_corrigido_w = 'S') then
	update	pls_movimento_contabil
	set	ie_status		= '3',
		nm_usuario_correcao	= nm_usuario_p,
		dt_correcao		= clock_timestamp()
	where	nr_sequencia		= nr_seq_movimento_p;
else
	CALL pls_consistir_mov_contab(nr_seq_movimento_p, nm_usuario_p);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_contas_item ( nr_seq_movimento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

