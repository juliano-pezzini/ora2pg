-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_atualizacao_conta_pac (nr_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
			 
			 
			 
ds_item_w			varchar(255);
ie_tipo_item_w			integer;
nr_atendimento_w		atendimento_paciente.nr_atendimento%type;
nr_interno_conta_w		conta_paciente.nr_interno_conta%type;
dt_atualizacao_w		timestamp;
dt_registro_w			timestamp;
nm_usuario_registro_w		usuario.nm_usuario%type;	
nm_usuario_ant_w		usuario.nm_usuario%type;		
cd_profissional_w		pessoa_fisica.cd_pessoa_fisica%type;
ds_texto1_w			varchar(255);			
ds_texto2_w			varchar(255);			
ds_texto3_w			varchar(255);			
ds_texto4_w			varchar(255);			
ds_texto5_w			varchar(255);			
ds_texto6_w			varchar(255);			
ds_texto7_w			varchar(255);			
ds_texto8_w			varchar(255);			
ds_texto9_w			varchar(255);			
ds_texto10_w			varchar(255);			
ds_texto11_w			varchar(255);			
ds_texto12_w			varchar(255);			
ds_texto13_w			varchar(255);			
ds_texto14_w			varchar(255);			
ds_texto15_w			varchar(255);			
ds_texto16_w			varchar(255);			
ds_texto17_w			varchar(255);			
ds_texto18_w			varchar(255);			
ds_texto19_w			varchar(255);			
ds_texto20_w			varchar(255);			
			 
C01 CURSOR FOR 
	SELECT	ds_texto1_w ds_item, 
		1 ie_item, 
		nr_atendimento, 
		nr_interno_conta, 
		dt_atualizacao, 
		dt_acerto_conta dt_registro, 
		nm_usuario 
	from	conta_paciente 
	where	nr_atendimento = nr_atendimento_p 
	
union all
 
	SELECT	ds_texto2_w ds_item, 
		2 ie_item, 
		nr_atendimento, 
		nr_interno_conta, 
		dt_atualizacao, 
		dt_procedimento dt_registro,		 
		coalesce(nm_usuario_original,nm_usuario) 
	from	procedimento_paciente 
	where	((coalesce(ie_responsavel_credito::text, '') = '' or (coalesce(vl_custo_operacional, 0) + coalesce(vl_materiais, 0)) > 0) or (obter_se_pasta_honorario(ie_responsavel_credito) = 'N')) 
	and		coalesce(cd_motivo_exc_conta::text, '') = '' 
	and	nr_atendimento = nr_atendimento_p 
	
union all
 
	select	ds_texto3_w ds_item, 
		3 ie_item, 
		b.nr_atendimento, 
		b.nr_interno_conta, 
		a.dt_atualizacao, 
		a.dt_atualizacao dt_registro, 
		a.nm_usuario 
	from	procedimento_paciente b, 
		procedimento_participante a 
	where	a.nr_sequencia = b.nr_sequencia	 
	and	b.nr_atendimento = nr_atendimento_p 
	
union all
 
	select	ds_texto4_w ds_item, 
		4 ie_item, 
		nr_atendimento, 
		nr_interno_conta, 
		dt_atualizacao, 
		dt_procedimento dt_registro, 
		nm_usuario 
	from	procedimento_paciente 
	where (ie_responsavel_credito IS NOT NULL AND ie_responsavel_credito::text <> '') 
	and (obter_se_pasta_honorario(ie_responsavel_credito) = 'S') 
	and		coalesce(cd_motivo_exc_conta::text, '') = '' 
	and	nr_atendimento = nr_atendimento_p 
	
union all
 
	select	ds_texto5_w ds_item, 
		5 ie_item, 
		nr_atendimento, 
		nr_interno_conta, 
		dt_atualizacao, 
		dt_procedimento dt_registro, 
		coalesce(nm_usuario_original,nm_usuario) 
	from	procedimento_paciente 
	where (ie_responsavel_credito IS NOT NULL AND ie_responsavel_credito::text <> '') 
	and (obter_se_pasta_honorario(ie_responsavel_credito) = 'S') 
	and		obter_classif_material_proced(null, cd_procedimento, ie_origem_proced) = '2' 
	and		coalesce(cd_motivo_exc_conta::text, '') = '' 
	and	nr_atendimento = nr_atendimento_p 
	
union all
 
	select	ds_texto6_w ds_item, 
		6 ie_item, 
		nr_atendimento, 
		nr_interno_conta, 
		dt_atualizacao, 
		dt_procedimento dt_registro, 
		coalesce(nm_usuario_original,nm_usuario) 
	from	procedimento_paciente 
	where (ie_responsavel_credito IS NOT NULL AND ie_responsavel_credito::text <> '') 
	and (obter_se_pasta_honorario(ie_responsavel_credito) = 'S') 
	and		obter_classif_material_proced(null, cd_procedimento, ie_origem_proced) = '3' 
	and		coalesce(cd_motivo_exc_conta::text, '') = '' 
	and	nr_atendimento = nr_atendimento_p 
	
union all
 
	select	ds_texto7_w ds_item, 
		7 ie_item, 
		b.nr_atendimento, 
		b.nr_interno_conta, 
		a.dt_atualizacao, 
		a.dt_atualizacao dt_registro, 
		a.nm_usuario 
	from	procedimento_paciente b, 
		proc_paciente_material a 
	where	a.nr_seq_procedimento = b.nr_sequencia 
	and	b.nr_atendimento = nr_atendimento_p 
	
union all
 
	select	ds_texto19_w ds_item, 
		8 ie_item, 
		nr_atendimento, 
		null nr_interno_conta, 
		dt_atualizacao, 
		dt_atualizacao dt_registro, 
		nm_usuario 
	from	atend_pac_proc_princ 
	where	nr_atendimento = nr_atendimento_p 
	
union all
 
	select	ds_texto8_w ds_item, 
		9 ie_item, 
		nr_atendimento, 
		nr_interno_conta, 
		dt_atualizacao, 
		dt_atendimento dt_registro, 
		nm_usuario 
	from	material_atend_paciente 
	where	coalesce(cd_motivo_exc_conta::text, '') = '' 
	and	coalesce(dt_acerto_convenio::text, '') = '' 
	and 	obter_classif_material_proced(cd_material, null, null) in ('1','5') 
	and	nr_atendimento = nr_atendimento_p 
	
union all
 
	select	ds_texto9_w ds_item, 
		10 ie_item, 
		nr_atendimento, 
		nr_interno_conta, 
		dt_atualizacao, 
		dt_atendimento dt_registro, 
		nm_usuario 
	from	material_atend_paciente 
	where	coalesce(cd_motivo_exc_conta::text, '') = '' 
	and	coalesce(dt_acerto_convenio::text, '') = '' 
	and 	obter_classif_material_proced(cd_material, null, null) in ('2','3','4') 
	and	nr_atendimento = nr_atendimento_p 
	
union all
 
	select	ds_texto10_w ds_item, 
		11 ie_item, 
		nr_atendimento, 
		nr_interno_conta, 
		dt_atualizacao, 
		dt_atendimento dt_registro, 
		nm_usuario 
	from	material_atend_paciente 
	where	coalesce(cd_motivo_exc_conta::text, '') = '' 
	and	coalesce(dt_acerto_convenio::text, '') = '' 
	and 	obter_classif_material_proced(cd_material, null, null) in ('5') 
	and	nr_atendimento = nr_atendimento_p 
	
union all
 
	select	ds_texto11_w ds_item, 
		12 ie_item, 
		b.nr_atendimento, 
		b.nr_interno_conta, 
		coalesce(a.dt_atualizacao_nrec ,a.dt_atualizacao) dt_atualizacao, 
		a.dt_atualizacao dt_registro, 
		coalesce(a.nm_usuario_nrec,a.nm_usuario) 
	from	material_atend_paciente	b, 
		mat_atend_paciente_opme a 
	where	a.nr_seq_material = b.nr_sequencia 
	and	coalesce(cd_motivo_exc_conta::text, '') = '' 
	and	coalesce(dt_acerto_convenio::text, '') = '' 
	and 	obter_classif_material_proced(cd_material, null, null) in ('5') 
	and	b.nr_atendimento = nr_atendimento_p 
	
union all
 
	select	ds_texto12_w ds_item, 
		13 ie_item, 
		c.nr_atendimento, 
		a.nr_interno_conta, 
		a.dt_atualizacao, 
		a.dt_desconto dt_registro, 
		a.nm_usuario 
	from	conta_paciente_desconto a, 
		conta_paciente c 
	where	a.nr_interno_conta = c.nr_interno_conta 
	and	c.nr_atendimento = nr_atendimento_p 
	
union all
 
	select	ds_texto13_w ds_item, 
		14 ie_item, 
		c.nr_atendimento, 
		b.nr_interno_conta, 
		coalesce(a.dt_atualizacao_nrec, a.dt_atualizacao) dt_atualizacao, 
		a.dt_atualizacao dt_registro, 
		coalesce(a.nm_usuario_nrec,a.nm_usuario) 
	from	conta_paciente_desconto b, 
		conta_paciente_desc_item a, 
		conta_paciente c 
	where	a.nr_seq_desconto = b.nr_sequencia 
	and	b.nr_interno_conta = c.nr_interno_conta 
	and	c.nr_atendimento = nr_atendimento_p 
	
union all
 
	select	ds_texto14_w ds_item, 
		15 ie_item, 
		a.nr_atendimento, 
		null nr_interno_conta, 
		a.dt_atualizacao, 
		a.dt_atualizacao dt_registro, 
		a.nm_usuario 
	from	atendimento_pacote a 
	where	a.nr_atendimento = nr_atendimento_p 
	
union all
 
	select	ds_texto15_w ds_item, 
		16 ie_item, 
		a.nr_atendimento, 
		null nr_interno_conta, 
		a.dt_atualizacao, 
		a.dt_atualizacao dt_registro, 
		a.nm_usuario 
	from	atend_pacote_regra a 
	where	a.nr_atendimento = nr_atendimento_p 
	
union all
 
	select	ds_texto16_w ds_item, 
		17 ie_item, 
		a.nr_atendimento, 
		null nr_interno_conta, 
		a.dt_atualizacao, 
		a.dt_fim_prev dt_registro, 
		a.nm_usuario 
	from	processo_atendimento a 
	where	a.nr_atendimento = nr_atendimento_p 
	
union all
 
	select	ds_texto17_w ds_item, 
		18 ie_item, 
		b.nr_atendimento, 
		a.nr_interno_conta, 
		a.dt_atualizacao, 
		a.dt_etapa dt_registro, 
		a.nm_usuario 
	from	conta_paciente_etapa a, 
		conta_paciente b 
	where	a.nr_interno_conta = b.nr_interno_conta 
	and	b.nr_atendimento = nr_atendimento_p 
	
union all
 
	select	ds_texto18_w ds_item, 
		19 ie_item, 
		c.nr_atendimento, 
		b.nr_interno_conta, 
		coalesce(a.dt_atualizacao_nrec, a.dt_atualizacao) dt_atualizacao, 
		a.dt_atualizacao dt_registro, 
		coalesce(a.nm_usuario_nrec,a.nm_usuario) 
	from	conta_paciente_etapa b, 
		conta_paciente_etapa_dev a, 
		conta_paciente c 
	where	b.nr_sequencia = a.nr_seq_etapa 
	and	b.nr_interno_conta = c.nr_interno_conta 
	and	c.nr_atendimento = nr_atendimento_p 
	
union all
 
	select	ds_texto20_w ds_item, 
		20 ie_item, 
		b.nr_atendimento nr_atendimento, 
		a.nr_interno_conta, 
		a.dt_atualizacao, 
		a.dt_atualizacao dt_registro, 
		a.nm_usuario 
	from	tiss_conta_guia a, 
		conta_paciente b 
	where	a.nr_interno_conta = b.nr_interno_conta 
	and	b.nr_atendimento = nr_atendimento_p 
	order by 7;
		
			 

BEGIN 
CALL exec_sql_dinamico('Tasy','Truncate table w_atualizacao_conta_pac');
 
ds_texto1_w	:= substr(wheb_mensagem_pck.get_texto(179073),1,255); -- Conta 
ds_texto2_w	:= substr(wheb_mensagem_pck.get_texto(299651),1,255); -- Procedimento 
ds_texto3_w	:= substr(wheb_mensagem_pck.get_texto(299652),1,255); -- Procedimento participante 
ds_texto4_w	:= substr(wheb_mensagem_pck.get_texto(299653),1,255); -- Honorário 
ds_texto5_w	:= substr(wheb_mensagem_pck.get_texto(299654),1,255); -- Taxa 
ds_texto6_w	:= substr(wheb_mensagem_pck.get_texto(299655),1,255); -- Diária 
ds_texto7_w	:= substr(wheb_mensagem_pck.get_texto(299656),1,255); -- Filme Utilizado 
ds_texto8_w	:= substr(wheb_mensagem_pck.get_texto(299657),1,255); -- Material 
ds_texto9_w	:= substr(wheb_mensagem_pck.get_texto(299658),1,255); -- Medicamento 
ds_texto10_w	:= substr(wheb_mensagem_pck.get_texto(299659),1,255); -- Extras 
ds_texto11_w	:= substr(wheb_mensagem_pck.get_texto(299660),1,255); -- OPME 
ds_texto12_w	:= substr(wheb_mensagem_pck.get_texto(299661),1,255); -- Desconto 
ds_texto13_w	:= substr(wheb_mensagem_pck.get_texto(299662),1,255); -- Desc. Item(Desconto) 
ds_texto14_w	:= substr(wheb_mensagem_pck.get_texto(299663),1,255); -- Pacote 
ds_texto15_w	:= substr(wheb_mensagem_pck.get_texto(299664),1,255); -- Regras especiais pacote(Pacote) 
ds_texto16_w	:= substr(wheb_mensagem_pck.get_texto(299161),1,255); -- Processo 
ds_texto17_w	:= substr(wheb_mensagem_pck.get_texto(299665),1,255); -- Controle de contas(Etapas Conta) 
ds_texto18_w	:= substr(wheb_mensagem_pck.get_texto(299666),1,255); -- Motivos devolução adicional(Etapas Conta) 
ds_texto19_w	:= substr(wheb_mensagem_pck.get_texto(299667),1,255); -- Proced Principal 
ds_texto20_w	:= substr(wheb_mensagem_pck.get_texto(299668),1,255); -- Guias 
open C01;
loop 
fetch C01 into	 
	ds_item_w, 
	ie_tipo_item_w, 
	nr_atendimento_w, 
	nr_interno_conta_w, 
	dt_atualizacao_w, 
	dt_registro_w, 
	nm_usuario_registro_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	if (coalesce(nm_usuario_ant_w,'X') <> coalesce(nm_usuario_registro_w,'X')) then 
	 
		select 	max(cd_pessoa_fisica) 
		into STRICT	cd_profissional_w 
		from 	usuario 
		where 	nm_usuario = nm_usuario_registro_w;
		 
	end if;
	 
 
	if (cd_profissional_w IS NOT NULL AND cd_profissional_w::text <> '') then 
		insert into w_atualizacao_conta_pac( 
			cd_pessoa_fisica,     
			ds_item,         
			dt_atualizacao,      
			dt_atualizacao_nrec,   
			dt_registro,       
			ie_tipo_item,       
			nm_usuario,        
			nm_usuario_nrec ,     
			nm_usuario_registro,   
			nr_atendimento,      
			nr_interno_conta) 
		values ( 
			cd_profissional_w,     
			ds_item_w,         
			dt_atualizacao_w,      
			clock_timestamp(),   
			dt_registro_w,       
			ie_tipo_item_w,       
			nm_usuario_p,        
			nm_usuario_p,     
			nm_usuario_registro_w,   
			nr_atendimento_w,      
			nr_interno_conta_w);
	end if;
	 
	 
	 
	nm_usuario_ant_w := nm_usuario_registro_w;
	end;
end loop;
close C01;
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_atualizacao_conta_pac (nr_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

