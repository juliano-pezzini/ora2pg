-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_nom_rc_resultado_lab ( nr_seq_cabecalho_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_atendimento_w						atendimento_paciente.nr_atendimento%type;
cd_pessoa_fisica_w						atendimento_paciente.cd_pessoa_fisica%type;
nr_seq_episodio_w						episodio_paciente.nr_sequencia%type;
cd_estabelecimento_w					estabelecimento.cd_estabelecimento%type;

ds_oid_primario_w						varchar(60);	-- id_14						
nm_ident_primario_w						varchar(100);	-- id_16
ds_oid_cod_pedido_exame_w				nom_rc_resultado_lab.ds_oid_cod_pedido_exame%type;
nm_cod_pedido_exame_w					nom_rc_resultado_lab.nm_cod_pedido_exame%type;
nr_ident_codigo_exame_w					nom_rc_resultado_lab.nr_ident_codigo_exame%type;
nm_exame_w								nom_rc_resultado_lab.nm_exame%type;
nm_exame_principal_w								nom_rc_resultado_lab.nm_exame%type;
ds_oid_cod_result_exame_w				nom_rc_resultado_lab.ds_oid_cod_result_exame%type;
nm_cod_result_exame_w					nom_rc_resultado_lab.nm_cod_result_exame%type;
nr_ident_result_exame_w					nom_rc_resultado_lab.nr_ident_result_exame%type;
ds_ident_result_exame_w					nom_rc_resultado_lab.ds_ident_result_exame%type;
dt_result_exame_utc_w					varchar(255);
dt_result_exame_w						nom_rc_resultado_lab.dt_result_exame%type;
vl_resultado_w							nom_rc_resultado_lab.vl_resultado%type;
ds_unidade_medida_w						nom_rc_resultado_lab.ds_unidade_medida%type;
vl_referencia_result_w					nom_rc_resultado_lab.vl_referencia_result%type;

qt_registro_w		bigint	:= 0;

ds_html_w			varchar(32000)	:= null;

c_resultado_lab CURSOR FOR
	SELECT 	'2.16.840.1.113883.6.1' ds_oid_cod_pedido_exame,
			'LOINC' nm_cod_pedido_exame,
			loinc_pedido.cd_loinc nr_ident_codigo_exame,
			coalesce(Obter_Desc_Exame(exame_resultado.nr_seq_superior),exame_pedido.nm_exame) nm_exame_principal,
			'2.16.840.1.113883.6.1' ds_oid_cod_result_exame,
			'LOINC' nm_cod_result_exame,
			loinc_resultado.cd_loinc nr_ident_result_exame,
			(SELECT max(x.ds_componente)
			from    lab_loinc_dados_reg x
			where   x.nr_seq_loinc_dados = loinc_resultado.nr_sequencia) ds_ident_result_exame,
			obter_data_utc(b.dt_resultado,'NOM_TABLE') dt_result_exame_utc,
			b.dt_resultado dt_result_exame,
			replace(lab_obter_resultado_exame(b.nr_seq_resultado,c.nr_sequencia),',','.') vl_resultado,
			replace(c.ds_unidade_medida,' ','') ds_unidade_medida,
			replace(obter_valor_ref_exame(c.nr_seq_resultado, c.nr_sequencia),',','.') vl_referencia_result
	from	lab_loinc_dados loinc_pedido,
			lab_loinc_dados loinc_resultado,
			exame_laboratorio exame_resultado,
			exame_laboratorio exame_pedido,
			exame_lab_result_item c,
			exame_lab_resultado b,
			prescr_procedimento pp,
			prescr_medica pm
	where	c.nr_seq_resultado = b.nr_seq_resultado
	and		exame_resultado.nr_seq_exame = c.nr_seq_exame
	and		pp.nr_sequencia = c.nr_seq_prescr
	and		pp.nr_prescricao = pm.nr_prescricao
	and		b.nr_prescricao = pm.nr_prescricao
	and		exame_pedido.nr_seq_exame = pp.nr_seq_exame
	and		loinc_pedido.nr_sequencia = exame_pedido.nr_seq_loinc
	and		loinc_resultado.nr_sequencia = exame_resultado.nr_seq_loinc
	and 	((c.qt_resultado IS NOT NULL AND c.qt_resultado::text <> '') or (c.ds_resultado IS NOT NULL AND c.ds_resultado::text <> '') or (c.pr_resultado IS NOT NULL AND c.pr_resultado::text <> ''))
	and ((pm.dt_liberacao IS NOT NULL AND pm.dt_liberacao::text <> '') or (pm.dt_liberacao_medico IS NOT NULL AND pm.dt_liberacao_medico::text <> ''))	
	and (coalesce(pm.dt_suspensao::text, '') = '')	
	and		pp.cd_motivo_baixa > 0
	and		((exame_resultado.nr_seq_superior IS NOT NULL AND exame_resultado.nr_seq_superior::text <> '') or (not exists (select 1
						from	exame_laboratorio y
						where  	exame_resultado.nr_seq_exame = y.nr_seq_superior)))
	and		pm.nr_atendimento 	in (select	x.nr_atendimento
									from	nom_rc_cabecalho x
									where	x.nr_sequencia = nr_seq_cabecalho_p
									and		(x.nr_atendimento IS NOT NULL AND x.nr_atendimento::text <> '')
									
union

									select	y.nr_atendimento
									from	atendimento_paciente y,
											nom_rc_cabecalho x
									where	x.nr_seq_episodio = y.nr_seq_episodio
									and		x.nr_sequencia = nr_seq_cabecalho_p)
	
union all

	select 	get_oid_details(25,'OID_NUMBER', 'NOM', pm.cd_estabelecimento) ds_oid_cod_pedido_exame,
			get_oid_details(25,'OID_SHORTNAME', 'NOM',pm.cd_estabelecimento) nm_cod_pedido_exame,
			to_char(exame_pedido.nr_seq_exame) nr_ident_codigo_exame,
			coalesce(Obter_Desc_Exame(exame_resultado.nr_seq_superior),exame_pedido.nm_exame) nm_exame_principal,
			get_oid_details(28,'OID_NUMBER', 'NOM', pm.cd_estabelecimento) ds_oid_cod_result_exame,
			get_oid_details(28,'OID_SHORTNAME', 'NOM', pm.cd_estabelecimento) nm_cod_result_exame,
			to_char(exame_resultado.nr_seq_exame) nr_ident_result_exame,
			exame_resultado.nm_exame ds_ident_result_exame,
			obter_data_utc(b.dt_resultado,'NOM_TABLE') dt_result_exame_utc,
			b.dt_resultado dt_result_exame,
			replace(lab_obter_resultado_exame(b.nr_seq_resultado,c.nr_sequencia),',','.') vl_resultado,
			replace(c.ds_unidade_medida,' ','') ds_unidade_medida,
			replace(obter_valor_ref_exame(c.nr_seq_resultado, c.nr_sequencia),',','.') vl_referencia_result
	from	exame_laboratorio exame_resultado,
			exame_laboratorio exame_pedido,
			exame_lab_result_item c,
			exame_lab_resultado b,
			prescr_procedimento pp,
			prescr_medica pm
	where	c.nr_seq_resultado = b.nr_seq_resultado
	and		exame_resultado.nr_seq_exame = c.nr_seq_exame
	and		pp.nr_sequencia = c.nr_seq_prescr
	and		pp.nr_prescricao = pm.nr_prescricao
	and		b.nr_prescricao = pm.nr_prescricao
	and		exame_pedido.nr_seq_exame = pp.nr_seq_exame
	and		coalesce(exame_pedido.nr_seq_loinc::text, '') = ''
	and		coalesce(exame_resultado.nr_seq_loinc::text, '') = ''
	and 	((c.qt_resultado IS NOT NULL AND c.qt_resultado::text <> '') or (c.ds_resultado IS NOT NULL AND c.ds_resultado::text <> '') or (c.pr_resultado IS NOT NULL AND c.pr_resultado::text <> ''))
	and ((pm.dt_liberacao IS NOT NULL AND pm.dt_liberacao::text <> '') or (pm.dt_liberacao_medico IS NOT NULL AND pm.dt_liberacao_medico::text <> ''))	
	and (coalesce(pm.dt_suspensao::text, '') = '')	
	and		pp.cd_motivo_baixa > 0
	and		((exame_resultado.nr_seq_superior IS NOT NULL AND exame_resultado.nr_seq_superior::text <> '') or (not exists (select 1
						from	exame_laboratorio y
						where  	exame_resultado.nr_seq_exame = y.nr_seq_superior)))
	and		pm.nr_atendimento 	in (select	x.nr_atendimento
									from	nom_rc_cabecalho x
									where	x.nr_sequencia = nr_seq_cabecalho_p
									and		(x.nr_atendimento IS NOT NULL AND x.nr_atendimento::text <> '')
									
union

									select	y.nr_atendimento
									from	atendimento_paciente y,
											nom_rc_cabecalho x
									where	x.nr_seq_episodio = y.nr_seq_episodio
									and		x.nr_sequencia = nr_seq_cabecalho_p);

BEGIN

delete from nom_rc_resultado_lab
where nr_seq_cabecalho = nr_seq_cabecalho_p;

select	a.nr_atendimento,
		a.nr_seq_episodio,
		a.cd_estabelecimento
into STRICT	nr_atendimento_w,
		nr_seq_episodio_w,
		cd_estabelecimento_w
from	nom_rc_cabecalho a
where	a.nr_sequencia	= nr_seq_cabecalho_p;


if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
	select	max(cd_pessoa_fisica)
	into STRICT	cd_pessoa_fisica_w
	from	atendimento_paciente
	where	nr_atendimento = nr_atendimento_w;
elsif (nr_seq_episodio_w IS NOT NULL AND nr_seq_episodio_w::text <> '') then
	select	max(cd_pessoa_fisica)
	into STRICT	cd_pessoa_fisica_w
	from	atendimento_paciente a
	where	a.nr_seq_episodio = nr_seq_episodio_w;
end if;


if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then

	ds_html_w	:= '<table class="wrichedit-table" width="100%" xmlns="urn:hl7-org:v3">';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || '<thead>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '<tr>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Prueba</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Fecha de resultado</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Resultado</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Rango</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '</tr>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) ||  '</thead>';

	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || '<tbody>';

	for	r_c_resultado_lab in c_resultado_lab LOOP

		qt_registro_w	:= qt_registro_w + 1;

		ds_oid_cod_pedido_exame_w	:= r_c_resultado_lab.ds_oid_cod_pedido_exame;
		nm_cod_pedido_exame_w		:= r_c_resultado_lab.nm_cod_pedido_exame;
		nr_ident_codigo_exame_w		:= r_c_resultado_lab.nr_ident_codigo_exame;
		nm_exame_principal_w		:= r_c_resultado_lab.nm_exame_principal;
		ds_oid_cod_result_exame_w	:= r_c_resultado_lab.ds_oid_cod_result_exame;
		nm_cod_result_exame_w		:= r_c_resultado_lab.nm_cod_result_exame;
		nr_ident_result_exame_w		:= r_c_resultado_lab.nr_ident_result_exame;
		ds_ident_result_exame_w		:= r_c_resultado_lab.ds_ident_result_exame;
		dt_result_exame_utc_w		:= r_c_resultado_lab.dt_result_exame_utc;
		dt_result_exame_w			:= r_c_resultado_lab.dt_result_exame;
		vl_resultado_w				:= r_c_resultado_lab.vl_resultado;
		ds_unidade_medida_w			:= r_c_resultado_lab.ds_unidade_medida;
		vl_referencia_result_w		:= r_c_resultado_lab.vl_referencia_result;

		insert into nom_rc_resultado_lab(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_oid_cod_pedido_exame,
			nm_cod_pedido_exame,
			nr_ident_codigo_exame,
			nm_exame,
			ds_oid_cod_result_exame,
			nm_cod_result_exame,
			nr_ident_result_exame,
			ds_ident_result_exame,
			dt_result_exame,
			vl_resultado,
			ds_unidade_medida,
			vl_referencia_result,
			nr_seq_cabecalho)
		values (nextval('nom_rc_resultado_lab_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			ds_oid_cod_pedido_exame_w,
			nm_cod_pedido_exame_w,
			nr_ident_codigo_exame_w,
			nm_exame_principal_w,
			ds_oid_cod_result_exame_w,
			nm_cod_result_exame_w,
			nr_ident_result_exame_w,
			ds_ident_result_exame_w,
			dt_result_exame_w,
			vl_resultado_w,
			ds_unidade_medida_w,
			vl_referencia_result_w,
			nr_seq_cabecalho_p);

		if (length(ds_html_w) < 31000) then
			ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '<tr>';
			ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || nm_exame_principal_w || ': ' || ds_ident_result_exame_w || '</td>';
			ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || dt_result_exame_utc_w || '</td>';
			ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || vl_resultado_w || ' ' || ds_unidade_medida_w || '</td>';
			ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || vl_referencia_result_w ||  ' ' || ds_unidade_medida_w || '</td>';
			ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '</tr>';
		end if;

	end loop;

	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || '</tbody>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || '</table>';

	if (qt_registro_w > 0) then

		insert into nom_rc_resultado_lab(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_resultado_lab,
			nr_seq_cabecalho,
			nm_exame)
		values (nextval('nom_rc_resultado_lab_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			ds_html_w,
			nr_seq_cabecalho_p,
			nm_exame_principal_w);

	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_nom_rc_resultado_lab ( nr_seq_cabecalho_p bigint, nm_usuario_p text) FROM PUBLIC;

