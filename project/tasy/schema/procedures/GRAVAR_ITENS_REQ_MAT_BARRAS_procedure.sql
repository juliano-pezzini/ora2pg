-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_itens_req_mat_barras ( nr_requisicao_p bigint, cd_material_p bigint, cd_estabelecimento_p bigint, qt_material_requisitada_p bigint, vl_material_p bigint, cd_kit_material_p bigint, nr_seq_lote_fornec_p bigint, ie_busca_fornec_consig_p text, ie_atualiza_conta_contabil_p text, cd_operacao_estoque_p bigint, cd_setor_atendimento_p bigint, cd_local_estoque_p bigint, dt_vigencia_p timestamp, cd_centro_custo_p bigint, nr_seq_etapa_gpi_p bigint, nm_usuario_p text, nr_seq_item_p INOUT bigint) AS $body$
DECLARE


nr_seq_item_w			integer;
cd_unidade_medida_w		varchar(30);
cd_unidade_medida_estoque_w	varchar(35);
qt_estoque_w			double precision;
qt_conv_estoque_consumo_w	double precision;
ie_consignado_w			varchar(1);
cd_cgc_fornecedor_w		varchar(60);
cd_conta_contabil_w		varchar(45);
ie_tipo_requisicao_w		varchar(3);
ie_tipo_conta_w			smallint;
cd_centro_custo_w		integer;
ie_preencher_fornec_w 	varchar(1);


BEGIN
ie_preencher_fornec_w := obter_param_usuario(919, 125, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_preencher_fornec_w);

cd_cgc_fornecedor_w	:= '';
cd_conta_contabil_w	:= '';
cd_centro_custo_w	:= cd_centro_custo_p;
nr_seq_item_p := 0;
if (nr_requisicao_p IS NOT NULL AND nr_requisicao_p::text <> '') and (cd_material_p IS NOT NULL AND cd_material_p::text <> '') and (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') and (qt_material_requisitada_p IS NOT NULL AND qt_material_requisitada_p::text <> '') and (vl_material_p IS NOT NULL AND vl_material_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then

	begin
	
	select	coalesce(max(nr_sequencia),0)+1
	into STRICT	nr_seq_item_w
	from	item_requisicao_material
	where	nr_requisicao	= nr_requisicao_p;
	
	nr_seq_item_p := nr_seq_item_w;
	
	select	cd_unidade_medida_consumo,
		cd_unidade_medida_estoque,
		qt_conv_estoque_consumo,
		coalesce(ie_consignado,'X')
	into STRICT	cd_unidade_medida_w,
		cd_unidade_medida_estoque_w,
		qt_conv_estoque_consumo_w,
		ie_consignado_w
        from	material
        where	cd_material = cd_material_p;
	
	qt_estoque_w := qt_material_requisitada_p / qt_conv_estoque_consumo_w;
	
	if (coalesce(nr_seq_lote_fornec_p,0) <> 0) then
		select cd_cgc_fornec
		into STRICT cd_cgc_fornecedor_w
		from material_lote_fornec
		where nr_sequencia = nr_seq_lote_fornec_p;
	end if;	
	
	if (ie_consignado_w <> '0') and (ie_busca_fornec_consig_p <> 'N') then
		if (ie_busca_fornec_consig_p = 'L') then
			cd_cgc_fornecedor_w	:= obter_fornecedor_regra_consig(cd_estabelecimento_p, cd_material_p, '1',cd_local_estoque_p);		
		else
			cd_cgc_fornecedor_w	:= obter_fornecedor_regra_consig(cd_estabelecimento_p, cd_material_p, '1');		
		end if;
	end if;
		

	if (ie_preencher_fornec_w = 'N')then
		cd_cgc_fornecedor_w := null;




	end if;	
		
		
	select	ie_tipo_requisicao
	into STRICT	ie_tipo_requisicao_w
	from	operacao_estoque
	where	cd_operacao_estoque = cd_operacao_estoque_p;
	
	if (ie_tipo_requisicao_w = 2) or (ie_tipo_requisicao_w = 21) then
		ie_tipo_conta_w := 2;
	else
		ie_tipo_conta_w := 3;
	end if;	
	
	if (ie_atualiza_conta_contabil_p = 'S') then
	
		SELECT * FROM Define_Conta_Material(	cd_estabelecimento_p, cd_material_p, ie_tipo_conta_w, 0, cd_setor_atendimento_p, '0', 0, 0, 0, '', cd_local_estoque_p, cd_operacao_estoque_p, dt_vigencia_p, cd_conta_contabil_w, cd_centro_custo_w, '') INTO STRICT cd_conta_contabil_w, cd_centro_custo_w;
		
	end if;

	insert into item_requisicao_material(
						nr_requisicao,
						nr_sequencia,
						cd_estabelecimento,
						cd_material,
						cd_material_req,
						qt_material_requisitada,						
						vl_material,
						dt_atualizacao,
						nm_usuario,
						cd_unidade_medida,
						qt_estoque,
						cd_unidade_medida_estoque,
						cd_conta_contabil,						
						cd_kit_material,
						nr_seq_lote_fornec,
						cd_cgc_fornecedor,
						nr_seq_etapa_gpi)
					values (	nr_requisicao_p,
						nr_seq_item_w,
						cd_estabelecimento_p,
						cd_material_p,
						cd_material_p,
						qt_material_requisitada_p,
						vl_material_p,
						clock_timestamp(),
						nm_usuario_p,
						cd_unidade_medida_w,
						qt_estoque_w,
						cd_unidade_medida_estoque_w,
						cd_conta_contabil_w,						
						cd_kit_material_p,
						nr_seq_lote_fornec_p,
						cd_cgc_fornecedor_w,
						nr_seq_etapa_gpi_p);	

	commit;

	end;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_itens_req_mat_barras ( nr_requisicao_p bigint, cd_material_p bigint, cd_estabelecimento_p bigint, qt_material_requisitada_p bigint, vl_material_p bigint, cd_kit_material_p bigint, nr_seq_lote_fornec_p bigint, ie_busca_fornec_consig_p text, ie_atualiza_conta_contabil_p text, cd_operacao_estoque_p bigint, cd_setor_atendimento_p bigint, cd_local_estoque_p bigint, dt_vigencia_p timestamp, cd_centro_custo_p bigint, nr_seq_etapa_gpi_p bigint, nm_usuario_p text, nr_seq_item_p INOUT bigint) FROM PUBLIC;

