-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_copy_w_prescr_histopatol ( NR_CPOE_OLD_ANATOMIA_P bigint, NR_CPOE_NEW_ANATOMIA_P bigint ) AS $body$
DECLARE

qtde		bigint;

BEGIN

	select count(*)
	into STRICT qtde
	FROM W_CPOE_PRESCR_HISTOPATOL
	WHERE NR_SEQ_PROC_ANATOMIA = NR_CPOE_OLD_ANATOMIA_P;

	if (qtde > 0) then
		INSERT INTO CPOE_PRESCR_HISTOPATOL(NR_SEQUENCIA,
		NR_SEQ_TRANSCRICAO,
		NR_SEQ_PROC_ANATOMIA,
		NR_SEQ_CPOE_ANTERIOR,
		NR_CPOE_INTERF_FARM,
		NR_ATENDIMENTO,
		NM_USUARIO_SUSP,
		NM_USUARIO_NREC,
		NM_USUARIO_LIB_ENF,
		NM_USUARIO,
		IE_RESULT_OUTROS,
		IE_RESULT_NICIII,
		IE_RESULT_NICII,
		IE_RESULT_NICI,
		IE_RESULT_NAO_FORNEC,
		IE_RESULT_HPV,
		IE_RESULT_CAR_ESC_INV,
		IE_RESULT_ASCUS,
		IE_RESULT_ADEN_INVASIVO,
		IE_RESULT_ADEN_IN_SITO,
		IE_PROCEDIMENTO,
		IE_MOTIVO_PRESCRICAO,
		IE_ITEM_VALIDO,
		IE_ITEM_ALTA,
		IE_INTERVENCAO_FARM,
		IE_EVENTO_UNICO,
		IE_DURACAO,
		IE_CPOE_FARM,
		IE_COLPOSCOPIA_ANORMAL,
		IE_COLPOSCOPIA,
		IE_CAF,
		IE_BAIXADO_POR_ALTA,
		IE_ADMINISTRACAO,
		HR_PRIM_HORARIO,
		DT_SUSPENSAO,
		DT_PROX_GERACAO,
		DT_PRIM_HORARIO,
		DT_LIB_SUSPENSAO,
		DT_LIBERACAO,
		DT_INICIO,
		DT_FIM,
		DT_ATUALIZACAO_NREC,
		DT_ATUALIZACAO,
		DS_STACK,
		DS_RESULT_EXAME_OUTRO,
		DS_INF_ADIC,
		CD_SETOR_ATENDIMENTO,
		CD_PESSOA_FISICA,
		CD_PERFIL_ATIVO,
		CD_FUNCAO_ORIGEM
		)
		SELECT
		nextval('cpoe_prescr_histopatol_seq'),
		NR_SEQ_TRANSCRICAO,
		NR_CPOE_NEW_ANATOMIA_P,
		NR_SEQ_CPOE_ANTERIOR,
		NR_CPOE_INTERF_FARM,
		NR_ATENDIMENTO,
		NM_USUARIO_SUSP,
		NM_USUARIO_NREC,
		NM_USUARIO_LIB_ENF,
		NM_USUARIO,
		IE_RESULT_OUTROS,
		IE_RESULT_NICIII,
		IE_RESULT_NICII,
		IE_RESULT_NICI,
		IE_RESULT_NAO_FORNEC,
		IE_RESULT_HPV,
		IE_RESULT_CAR_ESC_INV,
		IE_RESULT_ASCUS,
		IE_RESULT_ADEN_INVASIVO,
		IE_RESULT_ADEN_IN_SITO,
		IE_PROCEDIMENTO,
		IE_MOTIVO_PRESCRICAO,
		IE_ITEM_VALIDO,
		IE_ITEM_ALTA,
		IE_INTERVENCAO_FARM,
		IE_EVENTO_UNICO,
		IE_DURACAO,
		IE_CPOE_FARM,
		IE_COLPOSCOPIA_ANORMAL,
		IE_COLPOSCOPIA,
		IE_CAF,
		IE_BAIXADO_POR_ALTA,
		IE_ADMINISTRACAO,
		HR_PRIM_HORARIO,
		DT_SUSPENSAO,
		DT_PROX_GERACAO,
		DT_PRIM_HORARIO,
		DT_LIB_SUSPENSAO,
		DT_LIBERACAO,
		DT_INICIO,
		DT_FIM,
		DT_ATUALIZACAO_NREC,
		DT_ATUALIZACAO,
		DS_STACK,
		DS_RESULT_EXAME_OUTRO,
		DS_INF_ADIC,
		CD_SETOR_ATENDIMENTO,
		CD_PESSOA_FISICA,
		CD_PERFIL_ATIVO,
		CD_FUNCAO_ORIGEM
		FROM W_CPOE_PRESCR_HISTOPATOL
		WHERE NR_SEQ_PROC_ANATOMIA = NR_CPOE_OLD_ANATOMIA_P;
	else
		INSERT INTO CPOE_PRESCR_HISTOPATOL(NR_SEQUENCIA,
		NR_SEQ_TRANSCRICAO,
		NR_SEQ_PROC_ANATOMIA,
		NR_SEQ_CPOE_ANTERIOR,
		NR_CPOE_INTERF_FARM,
		NR_ATENDIMENTO,
		NM_USUARIO_SUSP,
		NM_USUARIO_NREC,
		NM_USUARIO_LIB_ENF,
		NM_USUARIO,
		IE_RESULT_OUTROS,
		IE_RESULT_NICIII,
		IE_RESULT_NICII,
		IE_RESULT_NICI,
		IE_RESULT_NAO_FORNEC,
		IE_RESULT_HPV,
		IE_RESULT_CAR_ESC_INV,
		IE_RESULT_ASCUS,
		IE_RESULT_ADEN_INVASIVO,
		IE_RESULT_ADEN_IN_SITO,
		IE_PROCEDIMENTO,
		IE_MOTIVO_PRESCRICAO,
		IE_ITEM_VALIDO,
		IE_ITEM_ALTA,
		IE_INTERVENCAO_FARM,
		IE_EVENTO_UNICO,
		IE_DURACAO,
		IE_CPOE_FARM,
		IE_COLPOSCOPIA_ANORMAL,
		IE_COLPOSCOPIA,
		IE_CAF,
		IE_BAIXADO_POR_ALTA,
		IE_ADMINISTRACAO,
		HR_PRIM_HORARIO,
		DT_SUSPENSAO,
		DT_PROX_GERACAO,
		DT_PRIM_HORARIO,
		DT_LIB_SUSPENSAO,
		DT_LIBERACAO,
		DT_INICIO,
		DT_FIM,
		DT_ATUALIZACAO_NREC,
		DT_ATUALIZACAO,
		DS_STACK,
		DS_RESULT_EXAME_OUTRO,
		DS_INF_ADIC,
		CD_SETOR_ATENDIMENTO,
		CD_PESSOA_FISICA,
		CD_PERFIL_ATIVO,
		CD_FUNCAO_ORIGEM
		)
		SELECT
		nextval('cpoe_prescr_histopatol_seq'),
		NR_SEQ_TRANSCRICAO,
		NR_CPOE_NEW_ANATOMIA_P,
		NR_SEQ_CPOE_ANTERIOR,
		NR_CPOE_INTERF_FARM,
		NR_ATENDIMENTO,
		NM_USUARIO_SUSP,
		NM_USUARIO_NREC,
		NM_USUARIO_LIB_ENF,
		NM_USUARIO,
		IE_RESULT_OUTROS,
		IE_RESULT_NICIII,
		IE_RESULT_NICII,
		IE_RESULT_NICI,
		IE_RESULT_NAO_FORNEC,
		IE_RESULT_HPV,
		IE_RESULT_CAR_ESC_INV,
		IE_RESULT_ASCUS,
		IE_RESULT_ADEN_INVASIVO,
		IE_RESULT_ADEN_IN_SITO,
		IE_PROCEDIMENTO,
		IE_MOTIVO_PRESCRICAO,
		IE_ITEM_VALIDO,
		IE_ITEM_ALTA,
		IE_INTERVENCAO_FARM,
		IE_EVENTO_UNICO,
		IE_DURACAO,
		IE_CPOE_FARM,
		IE_COLPOSCOPIA_ANORMAL,
		IE_COLPOSCOPIA,
		IE_CAF,
		IE_BAIXADO_POR_ALTA,
		IE_ADMINISTRACAO,
		HR_PRIM_HORARIO,
		DT_SUSPENSAO,
		DT_PROX_GERACAO,
		DT_PRIM_HORARIO,
		DT_LIB_SUSPENSAO,
		DT_LIBERACAO,
		DT_INICIO,
		DT_FIM,
		DT_ATUALIZACAO_NREC,
		DT_ATUALIZACAO,
		DS_STACK,
		DS_RESULT_EXAME_OUTRO,
		DS_INF_ADIC,
		CD_SETOR_ATENDIMENTO,
		CD_PESSOA_FISICA,
		CD_PERFIL_ATIVO,
		CD_FUNCAO_ORIGEM
		FROM CPOE_PRESCR_HISTOPATOL
		WHERE NR_SEQ_PROC_ANATOMIA = NR_CPOE_OLD_ANATOMIA_P;
	end if;

	DELETE FROM W_CPOE_PRESCR_CITOP
	WHERE nr_seq_proc_anatomia = NR_CPOE_OLD_ANATOMIA_P;

	DELETE FROM W_CPOE_PRESCR_PROC_PECA
	WHERE DT_ATUALIZACAO_NREC <= clock_timestamp() - interval '2 days';

	DELETE FROM W_CPOE_PRESCR_HISTOPATOL
	WHERE DT_ATUALIZACAO_NREC <= clock_timestamp() - interval '2 days';

	DELETE FROM W_CPOE_PRESCR_CITOP
	WHERE DT_ATUALIZACAO_NREC <= clock_timestamp() - interval '2 days';

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_copy_w_prescr_histopatol ( NR_CPOE_OLD_ANATOMIA_P bigint, NR_CPOE_NEW_ANATOMIA_P bigint ) FROM PUBLIC;

