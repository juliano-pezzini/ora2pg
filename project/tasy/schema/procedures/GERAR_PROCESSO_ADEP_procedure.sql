-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_processo_adep ( nr_atendimento_p bigint, dt_horario_p timestamp, nm_usuario_p text, nr_seq_processo_p INOUT bigint, ie_somente_gedipa_p text, cd_funcao_origem_p bigint, ie_origem_processo_p text, ie_gedipa_p text, ie_separar_agora_p text, nr_seq_processo_agora_p INOUT bigint, cd_local_estoque_p bigint, cd_setor_prescr_p bigint, ie_intervencao_p text default 'N', nr_seq_processo_nut_p INOUT bigint DEFAULT NULL, nr_seq_area_prep_p bigint default null, nr_prescricao_p bigint default null, ie_gera_nutricao_p text default 'N') AS $body$
DECLARE


nr_seq_processo_w			bigint := 0;
nr_seq_processo_ww			bigint := 0;
nr_seq_processo_agora_w		bigint := 0;
nr_seq_processo_ged_w		adep_processo.nr_sequencia%type;
ie_processo_separado_w		varchar(1);
ie_tipo_item_w				varchar(15);
nr_seq_horario_w			bigint;
nr_prescricao_w				bigint;
nr_seq_material_w			integer;
nr_seq_mat_princ_w			integer;
nr_seq_mat_composto_w		integer;
nr_agrupamento_w			double precision;
nr_seq_area_prep_w			bigint;
nr_seq_horario_ww			bigint;
ie_agrupador_w				smallint;
nr_seq_horario_www			bigint;
nr_seq_horario_wwww			bigint;
cd_setor_atend_w			integer;
cd_local_estoque_w			smallint;
cd_estabelecimento_w		integer;
ds_erro_w					varchar(1800);
ie_local_estoque_proc_w		varchar(15);
ie_separa_nutricao_w		varchar(7);
cd_intervalo_w				varchar(7);
ie_acm_w					varchar(1);
ie_se_necessario_w			varchar(1);
ie_dose_especial_w			varchar(1);
nr_seq_regra_w				bigint;
ie_gerar_urgente_w			varchar(1);
qt_tempo_min_w				bigint;
ie_higienizacao_w			varchar(1);
ie_preparo_w				varchar(1);
ie_conferencia_w			varchar(1);
nr_etapas_w					smallint;
ie_trans_proc_gedipa_w		varchar(1);
dt_inicio_w					timestamp;
dt_fim_w					timestamp;
ie_vincula_processo_pharm_w	varchar(1);
ie_tipo_processo_w			varchar(15);
ie_dose_especial_ww			varchar(1);
nr_sequencia_proc_w			prescr_material.nr_sequencia_proc%type;
nr_seq_area_prep_ini_w		prescr_mat_hor.nr_seq_area_prep%type;
ie_separar_proc_area_w		varchar(1);
ie_atualizou_w				varchar(1);
ie_prescr_quimio_w			varchar(1);
nr_seq_processo_ant_w		adep_processo.nr_sequencia%type;
ie_referencia_processo_w	varchar(1);
nr_prescr_npt_w				prescr_medica.nr_prescricao%type;
ie_gerar_proc_dieta_w		parametros_farmacia.ie_gerar_proc_dieta%type;
ie_existe_sne_npt_proc_w	varchar(1);

--Criado o parametro ie_gera_nutricao_p para que quando for passado 'S' gere os processo para itens de nutricao. 
--So sera passado 'S' quando a chamada vier do ADEP.
c01 CURSOR FOR
SELECT	ie_tipo_item,
	nr_seq_horario,
	nr_prescricao,
	nr_seq_item,
	nr_agrupamento,
	nr_seq_area_prep,
	ie_dose_especial,
	nr_sequencia_proc,
	nr_seq_processo
FROM	adep_pend_v2
WHERE	nr_atendimento	= nr_atendimento_p
AND	dt_horario	= dt_horario_p
and	((nr_prescricao = nr_prescricao_p) or (coalesce(nr_prescricao_p::text, '') = ''))
and	((nr_seq_area_prep = nr_seq_area_prep_p) or (coalesce(nr_seq_area_prep_p::text, '') = ''))
and	dt_inicio_prescr between dt_horario_p - 2 and dt_horario_p + 2
AND	(((ie_separa_nutricao_w = 'S') and (ie_tipo_item	IN ('M','NAN'))) or
	 ((ie_separa_nutricao_w = 'N') and (ie_tipo_item	IN ('M','S','NE','NAN'))))
AND	((coalesce(nr_seq_processo::text, '') = '') or
	 ((ie_trans_proc_gedipa_w = 'S') and (obter_dados_processo_adep(nr_seq_processo,'O') not in ('GGP','GGPI')) and (obter_status_processo(nr_seq_processo) in ('G','D','L'))))
and	(((ie_origem_processo_p in ('GGP','GGPI')) and (nr_seq_area_prep IS NOT NULL AND nr_seq_area_prep::text <> '')) or (ie_origem_processo_p not in ('GGP','GGPI')))
and	((ie_local_estoque_proc_w in ('L','P','R')) OR
	 ((cd_local_estoque = cd_local_estoque_w) or (cd_local_estoque_aux = cd_local_estoque_w) or  	
	 ((coalesce(cd_local_estoque_w::text, '') = '') and (cd_local_estoque_mat = obter_local_disp_prescr(nr_prescricao, nr_seq_item,Obter_perfil_Ativo, nm_usuario_p))))	 
	 )
and	((ie_local_estoque_proc_w in ('L','P','R')) OR (cd_setor_prescr		= cd_setor_atend_w) or (cd_setor_aux		= cd_setor_atend_w)) 
AND	((coalesce(ie_separar_agora_p,'N') = 'N') OR
	 ((coalesce(ie_separar_agora_p,'N') = 'S') AND (coalesce(ie_urgencia,'N') = 'N')))
and	((coalesce(ie_conferencia,'S') = 'S'
	 and	coalesce(ie_higienizacao,'S') = 'S'
	 and	coalesce(ie_preparo,'S')  = 'S'
	 and	ie_intervencao_p = 'N') or
	(((coalesce(ie_conferencia,'S') = 'N') 
	  OR (coalesce(ie_higienizacao,'S') = 'N') 
	  OR (coalesce(ie_preparo,'S')  = 'N'))
	 and ie_intervencao_p = 'S'))
and	 (((coalesce(cd_funcao_origem_p,0) <> 1113 and coalesce(ie_gera_nutricao_p,'N') <> 'D') or ((ie_tipo_item not in ('S','NE','NAN')) and (coalesce(ie_gera_nutricao_p,'N') = 'N'))) or ((coalesce(ie_gera_nutricao_p,'N') = 'S') and (ie_tipo_item in ('S','NE','NAN')))) 
ORDER BY coalesce(ie_item_superior,'N'),
	ie_tipo_item,
	nr_seq_horario;

c02 CURSOR FOR
SELECT	nr_sequencia,
		ie_agrupador
from	prescr_mat_hor
where	nr_prescricao	= nr_prescricao_w
and		nr_seq_superior	= nr_seq_material_w
and		dt_horario	= dt_horario_p
and		ie_agrupador	IN (3,7,8,9)
and		coalesce(ie_horario_especial,'N') = 'N'
and		((coalesce(nr_seq_processo::text, '') = '') or
		 ((ie_trans_proc_gedipa_w = 'S') and (obter_dados_processo_adep(nr_seq_processo,'O') not in ('GGP','GGPI')) and (obter_status_processo(nr_seq_processo) in ('G','D','L'))))
and		(((ie_origem_processo_p in ('GGP','GGPI')) and (nr_seq_area_prep IS NOT NULL AND nr_seq_area_prep::text <> '')) or (ie_origem_processo_p not in ('GGP','GGPI')))
and		Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S'
and		ie_atualizou_w = 'S'
order by
		nr_sequencia;

c03 CURSOR FOR
SELECT	nr_sequencia,
		nr_seq_material
from	prescr_mat_hor
where	nr_prescricao		= nr_prescricao_w
and		nr_seq_material 	<> nr_seq_material_w
and		nr_agrupamento		= nr_agrupamento_w
and		dt_horario		= dt_horario_p
and		ie_agrupador	in (1,11)
and		coalesce(dt_suspensao::text, '') = ''
and		coalesce(ie_horario_especial,'N') = 'N'
and		((coalesce(nr_seq_processo::text, '') = '') or
		 ((ie_trans_proc_gedipa_w = 'S') and (obter_dados_processo_adep(nr_seq_processo,'O') not in ('GGP','GGPI')) and (obter_status_processo(nr_seq_processo) in ('G','D','L'))))
and		ie_tipo_item_w	in ('M','NAN')
and		(((ie_origem_processo_p in ('GGP','GGPI')) and (nr_seq_area_prep IS NOT NULL AND nr_seq_area_prep::text <> '')) or (ie_origem_processo_p not in ('GGP','GGPI')))
and		Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S'
and		ie_atualizou_w = 'S'
order by
		nr_sequencia;

c04 CURSOR FOR
SELECT	a.nr_sequencia
from	prescr_material b,
		prescr_mat_hor a
where	b.nr_sequencia	= a.nr_seq_material
and		b.nr_prescricao	= a.nr_prescricao
and		a.nr_prescricao	= nr_prescricao_w
and		b.nr_seq_kit	= nr_seq_material_w
and		a.dt_horario	= dt_horario_p
and		coalesce(a.ie_horario_especial,'N') = 'N'
and		coalesce(a.ie_administrar,'S') = 'S'
and 	coalesce(b.nr_seq_recomendacao::text, '') = ''
and		((coalesce(nr_seq_processo::text, '') = '') or
		 ((ie_trans_proc_gedipa_w = 'S') and (obter_dados_processo_adep(nr_seq_processo,'O') not in ('GGP','GGPI')) and (obter_status_processo(nr_seq_processo) in ('G','D','L'))))
and		(((ie_origem_processo_p in ('GGP','GGPI')) and (nr_seq_area_prep IS NOT NULL AND nr_seq_area_prep::text <> '')) or (ie_origem_processo_p not in ('GGP','GGPI')))
and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
and		ie_atualizou_w = 'S'
order by
		a.nr_sequencia;

c05 CURSOR FOR
SELECT	z.ie_tipo_item,
		z.nr_seq_horario,
		z.nr_prescricao,
		z.nr_seq_item,
		z.nr_agrupamento,
		z.nr_seq_area_prep,
		z.cd_intervalo,
		z.ie_dose_especial,
		z.nr_sequencia_proc,
		z.nr_seq_processo
FROM	adep_ged_pend_v z
WHERE	z.nr_atendimento	= nr_atendimento_p
AND		z.dt_horario		= dt_horario_p
and		((z.nr_prescricao = nr_prescricao_p) or (coalesce(nr_prescricao_p::text, '') = ''))
and		((z.nr_seq_area_prep = nr_seq_area_prep_p) or (coalesce(nr_seq_area_prep_p::text, '') = ''))
AND		z.ie_tipo_item	IN ('M','MAP','NE','NAN','S')
AND		((coalesce(z.nr_seq_processo::text, '') = '') or (ie_trans_proc_gedipa_w = 'S'))
AND		coalesce(z.ie_urgencia,'N') = 'S'
AND		coalesce(ie_separar_agora_p,'N') = 'S'
and		(((ie_origem_processo_p in ('GGP','GGPI')) and (z.nr_seq_area_prep IS NOT NULL AND z.nr_seq_area_prep::text <> '')) or (ie_origem_processo_p not in ('GGP','GGPI')))
and		 ((((coalesce(cd_funcao_origem_p,0) <> 1113) or (z.ie_tipo_item not in ('S','NE','NAN'))) and coalesce(ie_gera_nutricao_p,'N') <> 'D') or ((coalesce(ie_gera_nutricao_p,'N') = 'S') and (z.ie_tipo_item in ('S','NE','NAN'))))
and 	z.nr_seq_horario not in (select q.nr_sequencia
								from 	prescr_material w,
										prescr_procedimento x,
										proc_interno y,
										prescr_mat_hor q
								where 	w.nr_prescricao = x.nr_prescricao
								and 	w.nr_sequencia_proc = x.nr_sequencia
								and 	x.nr_seq_proc_interno = y.nr_sequencia
								and 	coalesce(y.ie_ivc, 'N') = 'S'
								and 	w.nr_prescricao = z.nr_prescricao
								and 	w.nr_sequencia = z.nr_seq_item
								and 	(x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '')
								and 	q.nr_sequencia = z.nr_seq_horario
								and 	q.nr_prescricao = x.nr_prescricao
								and 	q.nr_seq_material = w.nr_sequencia)
ORDER BY coalesce(z.ie_item_superior,'N'),
			z.ie_tipo_item,
			z.nr_seq_horario;
	
C06 CURSOR FOR
	SELECT	nr_sequencia
	from	regra_etapa_gedipa
	where	coalesce(cd_setor_atendimento,coalesce(cd_setor_atend_w,0)) 	= coalesce(cd_setor_atend_w,0)
	and	coalesce(cd_intervalo,coalesce(cd_intervalo_w,'0'))		= coalesce(cd_intervalo_w,'0')
	and	coalesce(ie_acm,coalesce(ie_acm_w,'N'))				= coalesce(ie_acm_w,'N')
	and	coalesce(ie_se_necessario,coalesce(ie_se_necessario_w,'N'))	= coalesce(ie_se_necessario_w,'N')
	and	coalesce(ie_dose_especial,coalesce(ie_dose_especial_w,'N'))	= coalesce(ie_dose_especial_w,'N')
	and	coalesce(qt_tempo_min_w,0) between coalesce(qt_tempo_min,-99999) and coalesce(qt_tempo_max,99999)
	and	ie_situacao = 'A'
	and	(((coalesce(ie_hemodialise,'S') = 'S') and (coalesce(ie_tipo_processo_w,'XX') = 'H')) or
		((coalesce(ie_hemodialise,'N') = 'N') and (coalesce(ie_tipo_processo_w,'XX') <> 'H')))
	order by
		coalesce(cd_setor_atendimento,000000),
		coalesce(cd_intervalo,'AAAAAAA'),
		coalesce(ie_acm,'AAAAAAA'),
		coalesce(ie_se_necessario,'AAAAAAA'),
		coalesce(qt_tempo_min,000000);
		
c07 CURSOR FOR
SELECT	ie_tipo_item,
	nr_seq_horario,
	nr_prescricao,
	nr_seq_item,
	nr_agrupamento,
	nr_seq_area_prep,
	ie_dose_especial
FROM	adep_pend_v2
WHERE	nr_atendimento	= nr_atendimento_p
AND	dt_horario	= dt_horario_p
and	((nr_prescricao = nr_prescricao_p) or (coalesce(nr_prescricao_p::text, '') = ''))
and	((nr_seq_area_prep = nr_seq_area_prep_p) or (coalesce(nr_seq_area_prep_p::text, '') = ''))
and 	dt_inicio_prescr between dt_inicio_w and dt_fim_w
AND	Ie_Separa_nutricao_w = 'S'
and	ie_tipo_item	IN ('S','NE','NAN')
AND	((coalesce(nr_seq_processo::text, '') = '') or
	 ((ie_trans_proc_gedipa_w = 'S') and (obter_dados_processo_adep(nr_seq_processo,'O') not in ('GGP','GGPI')) and (obter_status_processo(nr_seq_processo) in ('G','D','L'))))
and	(((ie_origem_processo_p in ('GGP','GGPI')) and (nr_seq_area_prep IS NOT NULL AND nr_seq_area_prep::text <> '')) or (ie_origem_processo_p not in ('GGP','GGPI')))
and	((ie_local_estoque_proc_w in ('L','P','R')) OR
	 ((cd_local_estoque = cd_local_estoque_w) or (cd_local_estoque_aux = cd_local_estoque_w) or  	
	 ((coalesce(cd_local_estoque_w::text, '') = '') and (cd_local_estoque_mat = obter_local_disp_prescr(nr_prescricao, nr_seq_item,Obter_perfil_Ativo, nm_usuario_p))))	 
	 )
and	((ie_local_estoque_proc_w	in ('L','P','R')) OR (cd_setor_prescr		= cd_setor_atend_w) or (cd_setor_aux		= cd_setor_atend_w)) 
AND	((coalesce(ie_separar_agora_p,'N') = 'N') OR
	 ((coalesce(ie_separar_agora_p,'N') = 'S') AND (coalesce(ie_urgencia,'N') = 'N')))
and	 ((coalesce(cd_funcao_origem_p,0) <> 1113 and coalesce(ie_gera_nutricao_p,'N') <> 'D') or (coalesce(ie_gera_nutricao_p,'N') = 'S'))	 
ORDER BY coalesce(ie_item_superior,'N'),
	ie_tipo_item,
	nr_seq_horario;

c08 CURSOR FOR
SELECT	ie_tipo_item,
	nr_seq_horario,
	nr_prescricao,
	nr_seq_item,
	nr_agrupamento,
	nr_seq_area_prep,
	ie_dose_especial
FROM	adep_pend_v2
WHERE	nr_atendimento	= nr_atendimento_p
AND	dt_horario	= dt_horario_p
and	((nr_prescricao = nr_prescricao_p) or (coalesce(nr_prescricao_p::text, '') = ''))
and	((nr_seq_area_prep = nr_seq_area_prep_p) or (coalesce(nr_seq_area_prep_p::text, '') = ''))
and	ie_tipo_item	IN ('LD')
AND	((coalesce(nr_seq_processo::text, '') = '') or
	 ((ie_trans_proc_gedipa_w = 'S') and (obter_dados_processo_adep(nr_seq_processo,'O') not in ('GGP','GGPI')) and (obter_status_processo(nr_seq_processo) in ('G','D','L'))))
and	(((ie_origem_processo_p in ('GGP','GGPI')) and (nr_seq_area_prep IS NOT NULL AND nr_seq_area_prep::text <> '')) or (ie_origem_processo_p not in ('GGP','GGPI')))
and	((ie_local_estoque_proc_w in ('L','P','R')) OR
	 ((cd_local_estoque = cd_local_estoque_w) or (cd_local_estoque_aux = cd_local_estoque_w) or
	 ((coalesce(cd_local_estoque_w::text, '') = '') and (cd_local_estoque_mat = obter_local_disp_prescr(nr_prescricao, nr_seq_item,Obter_perfil_Ativo, nm_usuario_p))))
	 )
and	((ie_local_estoque_proc_w	in ('L','P','R')) OR (cd_setor_prescr		= cd_setor_atend_w) or (cd_setor_aux		= cd_setor_atend_w))
ORDER BY coalesce(ie_item_superior,'N'),
	ie_tipo_item,
	nr_seq_horario;
	
c09 CURSOR FOR
SELECT	z.ie_tipo_item,
		z.nr_seq_horario,
		z.nr_prescricao,
		z.nr_seq_item,
		z.nr_agrupamento,
		z.nr_seq_area_prep,
		z.ie_dose_especial,
		z.nr_sequencia_proc
FROM	adep_pend_v2 z
WHERE	z.nr_atendimento	= nr_atendimento_p
AND		z.dt_horario	= dt_horario_p
and		((z.nr_prescricao = nr_prescricao_p) or (coalesce(nr_prescricao_p::text, '') = ''))
and		((z.nr_seq_area_prep = nr_seq_area_prep_p) or (coalesce(nr_seq_area_prep_p::text, '') = ''))
and		z.dt_inicio_prescr between dt_horario_p - 2 and dt_horario_p + 2
AND		z.ie_tipo_item = 'MAP'	
AND		((coalesce(z.nr_seq_processo::text, '') = '') or  
		((ie_trans_proc_gedipa_w = 'S') and (obter_dados_processo_adep(z.nr_seq_processo,'O') not in ('GGP','GGPI')) and (obter_status_processo(z.nr_seq_processo) in ('G','D','L'))))
and		(((ie_origem_processo_p in ('GGP','GGPI','GPAP')) and (z.nr_seq_area_prep IS NOT NULL AND z.nr_seq_area_prep::text <> '')) or (ie_origem_processo_p not in ('GGP','GGPI')))
and		((ie_local_estoque_proc_w in ('L','P','R')) OR
		((z.cd_local_estoque = cd_local_estoque_w) or (z.cd_local_estoque_aux = cd_local_estoque_w) or  	
		((coalesce(cd_local_estoque_w::text, '') = '') and (z.cd_local_estoque_mat = obter_local_disp_prescr(z.nr_prescricao, z.nr_seq_item, Obter_perfil_Ativo, nm_usuario_p)))))
and		((ie_local_estoque_proc_w in ('L','P','R')) OR (z.cd_setor_prescr		= cd_setor_atend_w) or (z.cd_setor_aux		= cd_setor_atend_w)) 
AND		((coalesce(ie_separar_agora_p,'N') = 'N') OR
		((coalesce(ie_separar_agora_p,'N') = 'S') AND (coalesce(ie_urgencia,'N') = 'N')))
and		((coalesce(z.ie_conferencia,'S') = 'S'
		and	coalesce(z.ie_higienizacao,'S') = 'S'
		and	coalesce(z.ie_preparo,'S')  = 'S'
		and	ie_intervencao_p = 'N') or
		(((coalesce(z.ie_conferencia,'S') = 'N') 
		OR (coalesce(z.ie_higienizacao,'S') = 'N') 
		OR (coalesce(z.ie_preparo,'S')  = 'N'))
		and ie_intervencao_p = 'S'))
ORDER BY coalesce(z.ie_item_superior,'N'),
		z.ie_tipo_item,
		z.nr_seq_horario;	

c_dietas_orais CURSOR FOR
SELECT	a.nr_prescricao,
		b.nr_sequencia nr_seq_dieta,
		c.nr_sequencia nr_seq_horario
from	prescr_dieta_hor c,
		prescr_dieta b,
		prescr_medica a
where	a.nr_atendimento = nr_atendimento_p
and		c.dt_horario = dt_horario_p
and (a.nr_prescricao = nr_prescricao_p or coalesce(nr_prescricao_p::text, '') = '')
and		c.nr_prescricao = a.nr_prescricao
and		c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_dieta = b.nr_sequencia
and		coalesce(c.nr_seq_processo::text, '') = ''
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		coalesce(b.dt_suspensao::text, '') = ''
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(a.ie_adep,'S') = 'S'
and		obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		a.dt_inicio_prescr between clock_timestamp() - interval '2 days' and clock_timestamp() + interval '2 days'
order by c.nr_sequencia;
	
BEGIN

SELECT	MAX(cd_estabelecimento)
INTO STRICT	cd_estabelecimento_w
FROM	atendimento_paciente
WHERE	nr_atendimento	= nr_atendimento_p;

SELECT	coalesce(MAX(ie_local_estoque_proc),'P'),
	coalesce(max(ie_separa_nutricao),'N'),
	coalesce(max(ie_trans_proc_gedipa),'N'),
	coalesce(max(ie_gerar_processo_area),'N'),
	coalesce(max(ie_gerar_proc_dieta),'N')
INTO STRICT	ie_local_estoque_proc_w,
	ie_separa_nutricao_w,
	ie_trans_proc_gedipa_w,
	ie_separar_proc_area_w,
	ie_gerar_proc_dieta_w
FROM	parametros_farmacia
WHERE	cd_estabelecimento	= cd_estabelecimento_w;

if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
    CALL adep_gerar_log_rastr('{'||chr(10)||
        '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
        '"cd_estabelecimento_w" : "'||cd_estabelecimento_w||'",'||chr(10)||
        '"cd_funcao_origem_p" : "'||cd_funcao_origem_p||'",'||chr(10)||
        '"cd_local_estoque_p" : "'||cd_local_estoque_p||'",'||chr(10)||
        '"cd_setor_prescr_p" : "'||cd_setor_prescr_p||'",'||chr(10)||
        '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
        '"ie_gedipa_p" : "'||ie_gedipa_p||'",'||chr(10)||
        '"ie_gera_nutricao_p" : "'||ie_gera_nutricao_p||'",'||chr(10)||
        '"ie_gerar_proc_dieta_w" : "'||ie_gerar_proc_dieta_w||'",'||chr(10)||
        '"ie_intervencao_p" : "'||ie_intervencao_p||'",'||chr(10)||
        '"ie_local_estoque_proc_w" : "'||ie_local_estoque_proc_w||'",'||chr(10)||
        '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
        '"ie_separa_nutricao_w" : "'||ie_separa_nutricao_w||'",'||chr(10)||
        '"ie_separar_agora_p" : "'||ie_separar_agora_p||'",'||chr(10)||
        '"ie_separar_proc_area_w" : "'||ie_separar_proc_area_w||'",'||chr(10)||
        '"ie_somente_gedipa_p" : "'||ie_somente_gedipa_p||'",'||chr(10)||
        '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
        '"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
        '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
        '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
        '"nr_seq_area_prep_p" : "'||nr_seq_area_prep_p||'",'||chr(10)||
        '"nr_seq_processo_agora_p" : "'||nr_seq_processo_agora_p||'",'||chr(10)||
        '"nr_seq_processo_nut_p" : "'||nr_seq_processo_nut_p||'",'||chr(10)||
        '"nr_seq_processo_p" : "'||nr_seq_processo_p||'"}', wheb_usuario_pck.get_ie_commit);
end if;

IF (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') AND (dt_horario_p IS NOT NULL AND dt_horario_p::text <> '') AND (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') THEN

	cd_setor_atend_w	:= Obter_Unidade_Atendimento(nr_atendimento_p,'IAA','CS');
	IF (coalesce(cd_local_estoque_p::text, '') = '') OR (ie_local_estoque_proc_w = 'P') THEN
		cd_local_estoque_w	:= obter_local_estoque_setor(cd_setor_atend_w, obter_estab_atend(nr_atendimento_p));
	ELSIF (ie_local_estoque_proc_w = 'S') THEN
		cd_setor_atend_w	:= coalesce(cd_setor_prescr_p,cd_setor_atend_w);
		cd_local_estoque_w	:= cd_local_estoque_p;
	END IF;

	ie_vincula_processo_pharm_w := obter_param_usuario(1113, 617, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, cd_estabelecimento_w, ie_vincula_processo_pharm_w);
	ie_atualizou_w	:= 'S';
	
	if (ie_separa_nutricao_w = 'S') then
		
		nr_seq_processo_w := 0;
		nr_prescr_npt_w		:= 0;	
		nr_seq_processo_nut_p	:= 0;
		
		dt_inicio_w 	:= dt_horario_p - 2;
		dt_fim_w	:= dt_horario_p + 2;

        if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
            CALL adep_gerar_log_rastr('{'||chr(10)||
                '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                '"c07" : "c07",'||chr(10)||
                '"Ie_Separa_nutricao_w" : "'||Ie_Separa_nutricao_w||'",'||chr(10)||
                '"cd_funcao_origem_p" : "'||cd_funcao_origem_p||'",'||chr(10)||
                '"cd_local_estoque_w" : "'||cd_local_estoque_w||'",'||chr(10)||
                '"cd_setor_atend_w" : "'||cd_setor_atend_w||'",'||chr(10)||
                '"dt_fim_w" : "'||to_char(dt_fim_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                '"dt_inicio_w" : "'||to_char(dt_inicio_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                '"ie_gera_nutricao_p" : "'||ie_gera_nutricao_p||'",'||chr(10)||
                '"ie_local_estoque_proc_w" : "'||ie_local_estoque_proc_w||'",'||chr(10)||
                '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
                '"ie_separar_agora_p" : "'||ie_separar_agora_p||'",'||chr(10)||
                '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
                '"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
                '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
                '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
                '"nr_seq_area_prep_p" : "'||nr_seq_area_prep_p||'"}', wheb_usuario_pck.get_ie_commit);
        end if;
		
		OPEN c07;
		LOOP
		FETCH c07 INTO
			ie_tipo_item_w,
			nr_seq_horario_w,
			nr_prescricao_w,
			nr_seq_material_w,
			nr_agrupamento_w,
			nr_seq_area_prep_w,
			ie_dose_especial_ww;
		EXIT WHEN NOT FOUND; /* apply on c07 */
			BEGIN
			
			IF (ie_local_estoque_proc_w in ('R','L')) THEN
				select	max(cd_local_estoque_proc)
				into STRICT	cd_local_estoque_w
				from	regra_local_dispensacao
				where	nr_sequencia in (	SELECT	max(nr_regra_local_disp)
												from	prescr_mat_hor
												where	nr_sequencia = nr_seq_horario_w);											
											
			    if (coalesce(cd_local_estoque_w::text, '') = '') then
					cd_local_estoque_w	:= obter_local_estoque_regra_ged(cd_setor_atend_w,nr_prescricao_w,nr_seq_material_w,null, dt_horario_p,ie_dose_especial_ww);
				end if;
			end if;
			
			if (ie_local_estoque_proc_w in ('L','P','R')) then
				cd_setor_atend_w	:=	obter_setor_processo_gedipa(cd_setor_prescr_p, nr_atendimento_p);
			end if;
				
			if (ie_tipo_item_w = 'NAN') then
				if (nr_prescr_npt_w <> nr_prescricao_w) then
					nr_prescr_npt_w	:= nr_prescricao_w;		
					nr_seq_processo_w		:= 0;
				    if ((nr_seq_processo_nut_p > 0) and (ie_origem_processo_p in ('GGP','GGPI'))) then
						CALL gerar_fracionamento_processo(nr_seq_processo_nut_p, nm_usuario_p);				
						nr_seq_processo_nut_p	:= 0;
					end if;						
				end if;
			elsif (nr_prescr_npt_w > 0) then				
				if ((nr_seq_processo_nut_p > 0) and (ie_origem_processo_p in ('GGP','GGPI'))) then
					CALL gerar_fracionamento_processo(nr_seq_processo_nut_p, nm_usuario_p);									
				end if;	
				nr_seq_processo_nut_p	:= 0;
				nr_seq_processo_w		:= 0;
				nr_prescr_npt_w			:= 0;
			end if;
			
			if (ie_tipo_item_w = 'S') and (coalesce(nr_seq_processo_w,0) > 0) then
				
				select	coalesce(max('S'), 'N') ie_existe_sne_npt_proc
				into STRICT	ie_existe_sne_npt_proc_w
				from	prescr_mat_hor a
				where	a.nr_seq_processo = nr_seq_processo_w
				and		a.ie_agrupador in (8,11);
				
				if (ie_existe_sne_npt_proc_w = 'S') then
					nr_seq_processo_w := 0;
				end if;
			end if;
			
			IF (coalesce(nr_seq_processo_w,0) = 0) THEN

				SELECT	coalesce(MAX(ie_acm),'N'),
						coalesce(MAX(ie_se_necessario),'N'),
						trunc((dt_horario_p - clock_timestamp()) * 1440),
						max(ie_higienizacao),
						max(ie_preparo),
						max(ie_conferencia),
						max(CASE WHEN ie_agrupador=13 THEN 'H'  ELSE null END ),
						max(cd_intervalo),
						coalesce(max(ie_dose_espec_agora),'N'),
						max(ie_agrupador)
				INTO STRICT	ie_acm_w,
						ie_se_necessario_w,
						qt_tempo_min_w,
						ie_higienizacao_w,
						ie_preparo_w,
						ie_conferencia_w,
						ie_tipo_processo_w,
						cd_intervalo_w,
						ie_dose_especial_w,
						ie_agrupador_w
				FROM	prescr_material
				WHERE	nr_prescricao	= nr_prescricao_w
				AND		nr_sequencia	= nr_seq_material_w;
				
				select	coalesce(max(ie_dose_especial),'N')
				into STRICT	ie_dose_especial_w
				from	prescr_mat_hor
				where	nr_sequencia = nr_seq_horario_w
				and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
								

                if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
                    CALL adep_gerar_log_rastr('{'||chr(10)||
                        '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                        '"c06" : "c06",'||chr(10)||
                        '"cd_intervalo_w" : "'||cd_intervalo_w||'",'||chr(10)||
                        '"cd_setor_atend_w" : "'||cd_setor_atend_w||'",'||chr(10)||
                        '"ie_acm_w" : "'||ie_acm_w||'",'||chr(10)||
                        '"ie_dose_especial_w" : "'||ie_dose_especial_w||'",'||chr(10)||
                        '"ie_se_necessario_w" : "'||ie_se_necessario_w||'",'||chr(10)||
                        '"ie_tipo_processo_w" : "'||ie_tipo_processo_w||'",'||chr(10)||
                        '"qt_tempo_min_w" : "'||qt_tempo_min_w||'"}', wheb_usuario_pck.get_ie_commit);
                end if;

				open C06;
				loop
				fetch C06 into	
					nr_seq_regra_w;
				EXIT WHEN NOT FOUND; /* apply on C06 */
				begin
					nr_seq_regra_w := nr_seq_regra_w;
				end;
				end loop;
				close C06;
				

				if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then
					select	coalesce(ie_gerar_urgente,'N')
					into STRICT	ie_gerar_urgente_w
					from	regra_etapa_gedipa
					where	nr_sequencia	= nr_seq_regra_w;
				end if;
				
				SELECT	nextval('adep_processo_seq')
				INTO STRICT	nr_seq_processo_w
				;
				
				
				if (ie_tipo_item_w	= 'NE') then
					nr_etapas_w	:=  obter_etapas_adep_sne(nr_seq_horario_w);
				else
					nr_etapas_w	:= null;			
				end if;			

				INSERT INTO adep_processo(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_atendimento,
					cd_setor_atendimento,
					cd_local_estoque,
					dt_processo,
					nm_usuario_processo,
					dt_horario_processo,
					cd_funcao_origem,
					ie_origem_processo,
					ie_gedipa,
					ie_urgente,
					ie_acm,
					ie_se_necessario,
					ie_dose_especial,
					ie_higienizacao,
					ie_preparo,
					ie_conferencia,
					nr_prescricao,
					nr_seq_material,
					nr_etapa,
					nr_seq_regra)
				VALUES (
					nr_seq_processo_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_atendimento_p,
					cd_setor_atend_w,
					cd_local_estoque_w,
					clock_timestamp(),
					nm_usuario_p,
					dt_horario_p,
					cd_funcao_origem_p,
					ie_origem_processo_p,
					ie_gedipa_p,
					CASE WHEN ie_gerar_urgente_w='S' THEN 'S'  ELSE 'N' END ,
					ie_acm_w,
					ie_se_necessario_w,
					ie_dose_especial_w,
					ie_higienizacao_w,
					ie_preparo_w,
					ie_conferencia_w,
					nr_prescricao_w,
					nr_seq_material_w,
					CASE WHEN nr_etapas_w=0 THEN 1  ELSE nr_etapas_w END ,
					nr_seq_regra_w);
					
					--if (nvl(ie_vincula_processo_pharm_w,'N') = 'X') then	
					if (((coalesce(ie_vincula_processo_pharm_w,'N') = 'X') and (ie_agrupador_w <> 11)) or (coalesce(ie_vincula_processo_pharm_w,'N') = 'T')) or (coalesce(ie_vincula_processo_pharm_w,'N') = 'I') then	
						CALL preparar_processo_adep(nr_seq_processo_w,'S',nm_usuario_p);
					end if;
					
				nr_seq_processo_nut_p := nr_seq_processo_w;
			END IF;
			
			UPDATE	prescr_mat_hor
			SET		nr_seq_processo		= nr_seq_processo_w,
					ie_tipo_item_processo	= 'M'
			WHERE	nr_sequencia		= nr_seq_horario_w;

            if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
                CALL adep_gerar_log_rastr('{'||chr(10)||
                    '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                    '"c02" : "c02",'||chr(10)||
                    '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                    '"ie_atualizou_w" : "'||ie_atualizou_w||'",'||chr(10)||
                    '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
                    '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
                    '"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
                    '"nr_seq_material_w" : "'||nr_seq_material_w||'"}', wheb_usuario_pck.get_ie_commit);
            end if;
				
			OPEN c02;
			LOOP
			FETCH c02 INTO	nr_seq_horario_ww,
					ie_agrupador_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				BEGIN
				
				UPDATE	prescr_mat_hor
				SET	nr_seq_processo		= nr_seq_processo_w,
					ie_tipo_item_processo	= CASE WHEN ie_agrupador_w=3 THEN 'D' WHEN ie_agrupador_w=7 THEN 'RD'  ELSE 'RC' END ,
					nr_seq_area_prep	= nr_seq_area_prep_w
				WHERE	nr_sequencia		= nr_seq_horario_ww;

				END;
			END LOOP;
			CLOSE c02;

            if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then                
                CALL adep_gerar_log_rastr('{'||chr(10)||
                    '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                    '"c04" : "c04",'||chr(10)||
                    '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                    '"ie_atualizou_w" : "'||ie_atualizou_w||'",'||chr(10)||
                    '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
                    '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
                    '"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
                    '"nr_seq_material_w" : "'||nr_seq_material_w||'"}', wheb_usuario_pck.get_ie_commit);
            end if;
			
			open c04;
			loop
			fetch c04 into
				nr_seq_horario_wwww;
			EXIT WHEN NOT FOUND; /* apply on c04 */
				begin
				
				update	prescr_mat_hor
				set		nr_seq_processo			= nr_seq_processo_w,
						nr_seq_superior			= nr_seq_material_w,
						ie_tipo_item_processo	= 'K',
						nr_seq_area_prep		= nr_seq_area_prep_w
				where	nr_sequencia			= nr_seq_horario_wwww;

				end;
			end loop;
			close c04;

			nr_seq_mat_princ_w	:= nr_seq_material_w;
			END;
		END LOOP;
		CLOSE c07;
		
	end if;

	nr_seq_processo_w := 0;

    if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
        CALL adep_gerar_log_rastr('{'||chr(10)||
            '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
            '"c08" : "c08",'||chr(10)||
            '"cd_local_estoque_w" : "'||cd_local_estoque_w||'",'||chr(10)||
            '"cd_setor_atend_w" : "'||cd_setor_atend_w||'",'||chr(10)||
            '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
            '"ie_local_estoque_proc_w" : "'||ie_local_estoque_proc_w||'",'||chr(10)||
            '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
            '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
            '"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
            '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
            '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
            '"nr_seq_area_prep_p" : "'||nr_seq_area_prep_p||'"}', wheb_usuario_pck.get_ie_commit);
    end if;

	OPEN c08;
	LOOP
	FETCH c08 INTO
		ie_tipo_item_w,
		nr_seq_horario_w,
		nr_prescricao_w,
		nr_seq_material_w,
		nr_agrupamento_w,
		nr_seq_area_prep_w,
		ie_dose_especial_ww;
	EXIT WHEN NOT FOUND; /* apply on c08 */
		BEGIN
		
		IF (ie_local_estoque_proc_w in ('R','L')) THEN
			select	max(cd_local_estoque_proc)
			into STRICT	cd_local_estoque_w
			from	regra_local_dispensacao
			where	nr_sequencia in (	SELECT	max(nr_regra_local_disp)
											from	prescr_mat_hor
											where	nr_sequencia = nr_seq_horario_w);											
											
			if (coalesce(cd_local_estoque_w::text, '') = '') then
				cd_local_estoque_w	:= obter_local_estoque_regra_ged(cd_setor_atend_w,nr_prescricao_w,nr_seq_material_w,null, dt_horario_p,ie_dose_especial_ww);
			end if;
		end if;

		if (ie_local_estoque_proc_w in ('L','P','R')) then
			cd_setor_atend_w	:=	obter_setor_processo_gedipa(cd_setor_prescr_p, nr_atendimento_p);
		end if;

		IF (coalesce(nr_seq_processo_w,0) = 0) THEN

			SELECT	coalesce(MAX(ie_acm),'N'),
					coalesce(MAX(ie_se_necessario),'N'),
					trunc((dt_horario_p - clock_timestamp()) * 1440),
					max(ie_higienizacao),
					max(ie_preparo),
					max(ie_conferencia),
					max(CASE WHEN ie_agrupador=13 THEN 'H'  ELSE null END ),
					max(cd_intervalo),
					coalesce(max(ie_dose_espec_agora),'N')
			INTO STRICT	ie_acm_w,
					ie_se_necessario_w,
					qt_tempo_min_w,
					ie_higienizacao_w,
					ie_preparo_w,
					ie_conferencia_w,
					ie_tipo_processo_w,
					cd_intervalo_w,
					ie_dose_especial_w
			FROM	prescr_material
			WHERE	nr_prescricao	= nr_prescricao_w
			AND		nr_sequencia	= nr_seq_material_w;

			select	coalesce(max(ie_dose_especial),'N')
			into STRICT	ie_dose_especial_w
			from	prescr_mat_hor
			where	nr_sequencia = nr_seq_horario_w
			and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

            if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
                CALL adep_gerar_log_rastr('{'||chr(10)||
                    '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                    '"c06" : "c06",'||chr(10)||
                    '"cd_intervalo_w" : "'||cd_intervalo_w||'",'||chr(10)||
                    '"cd_setor_atend_w" : "'||cd_setor_atend_w||'",'||chr(10)||
                    '"ie_acm_w" : "'||ie_acm_w||'",'||chr(10)||
                    '"ie_dose_especial_w" : "'||ie_dose_especial_w||'",'||chr(10)||
                    '"ie_se_necessario_w" : "'||ie_se_necessario_w||'",'||chr(10)||
                    '"ie_tipo_processo_w" : "'||ie_tipo_processo_w||'",'||chr(10)||
                    '"qt_tempo_min_w" : "'||qt_tempo_min_w||'"}', wheb_usuario_pck.get_ie_commit);
            end if;

			open C06;
			loop
			fetch C06 into
				nr_seq_regra_w;
			EXIT WHEN NOT FOUND; /* apply on C06 */
			begin
				nr_seq_regra_w := nr_seq_regra_w;
			end;
			end loop;
			close C06;


			if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then
				select	coalesce(ie_gerar_urgente,'N')
				into STRICT	ie_gerar_urgente_w
				from	regra_etapa_gedipa
				where	nr_sequencia	= nr_seq_regra_w;
			end if;

			SELECT	nextval('adep_processo_seq')
			INTO STRICT	nr_seq_processo_w
			;

			if (ie_tipo_item_w	= 'NE') then
				nr_etapas_w	:=  obter_etapas_adep_sne(nr_seq_horario_w);
			else
				nr_etapas_w	:= null;
			end if;

			INSERT INTO adep_processo(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_atendimento,
				cd_setor_atendimento,
				cd_local_estoque,
				dt_processo,
				nm_usuario_processo,
				dt_horario_processo,
				cd_funcao_origem,
				ie_origem_processo,
				ie_gedipa,
				ie_urgente,
				ie_acm,
				ie_se_necessario,
				ie_dose_especial,
				ie_higienizacao,
				ie_preparo,
				ie_conferencia,
				nr_prescricao,
				nr_seq_material,
				nr_etapa,
				nr_seq_regra)
			VALUES (
				nr_seq_processo_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_atendimento_p,
				cd_setor_atend_w,
				cd_local_estoque_w,
				clock_timestamp(),
				nm_usuario_p,
				dt_horario_p,
				cd_funcao_origem_p,
				ie_origem_processo_p,
				ie_gedipa_p,
				CASE WHEN ie_gerar_urgente_w='S' THEN 'S'  ELSE 'N' END ,
				ie_acm_w,
				ie_se_necessario_w,
				ie_dose_especial_w,
				ie_higienizacao_w,
				ie_preparo_w,
				ie_conferencia_w,
				nr_prescricao_w,
				nr_seq_material_w,
				CASE WHEN nr_etapas_w=0 THEN 1  ELSE nr_etapas_w END ,
				nr_seq_regra_w);

				nr_seq_processo_p := nr_seq_processo_w;
				
				if (coalesce(ie_vincula_processo_pharm_w,'N') in ('X','T','I')) then	
					CALL preparar_processo_adep(nr_seq_processo_w,'S',nm_usuario_p);
				end if;
			
		END IF;

		UPDATE	prescr_mat_hor
		SET		nr_seq_processo		= nr_seq_processo_w,
				ie_tipo_item_processo	= 'M'
		WHERE	nr_sequencia		= nr_seq_horario_w;

        if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
            CALL adep_gerar_log_rastr('{'||chr(10)||
                '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                '"c02" : "c02",'||chr(10)||
                '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                '"ie_atualizou_w" : "'||ie_atualizou_w||'",'||chr(10)||
                '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
                '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
                '"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
                '"nr_seq_material_w" : "'||nr_seq_material_w||'"}', wheb_usuario_pck.get_ie_commit);
        end if;

		OPEN c02;
		LOOP
		FETCH c02 INTO	nr_seq_horario_ww,
				ie_agrupador_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			BEGIN

			UPDATE	prescr_mat_hor
			SET	nr_seq_processo		= nr_seq_processo_w,
				ie_tipo_item_processo	= CASE WHEN ie_agrupador_w=3 THEN 'D' WHEN ie_agrupador_w=7 THEN 'RD'  ELSE 'RC' END ,
				nr_seq_area_prep	= nr_seq_area_prep_w
			WHERE	nr_sequencia		= nr_seq_horario_ww;

			END;
		END LOOP;
		CLOSE c02;

        if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
            CALL adep_gerar_log_rastr('{'||chr(10)||
                '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                '"c04" : "c04",'||chr(10)||
                '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                '"ie_atualizou_w" : "'||ie_atualizou_w||'",'||chr(10)||
                '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
                '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
                '"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
                '"nr_seq_material_w" : "'||nr_seq_material_w||'"}', wheb_usuario_pck.get_ie_commit);
        end if;

		open c04;
		loop
		fetch c04 into
			nr_seq_horario_wwww;
		EXIT WHEN NOT FOUND; /* apply on c04 */
			begin

			update	prescr_mat_hor
			set		nr_seq_processo			= nr_seq_processo_w,
					nr_seq_superior			= nr_seq_material_w,
					ie_tipo_item_processo	= 'K',
					nr_seq_area_prep		= nr_seq_area_prep_w
			where	nr_sequencia			= nr_seq_horario_wwww;

			end;
		end loop;
		close c04;

		nr_seq_mat_princ_w	:= nr_seq_material_w;
		END;
	END LOOP;
	CLOSE c08;

	if (ie_gerar_proc_dieta_w = 'S' and ie_origem_processo_p in ('GGP','GGPI')) then

		if (ie_local_estoque_proc_w in ('L','P','R')) then
			cd_setor_atend_w := obter_setor_processo_gedipa(cd_setor_prescr_p, nr_atendimento_p);
		else
			cd_setor_atend_w := null;
		end if;

        if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
            CALL adep_gerar_log_rastr('{'||chr(10)||
                '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                '"c_dietas_orais" : "c_dietas_orais",'||chr(10)||
                '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
                '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
                '"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}', wheb_usuario_pck.get_ie_commit);
        end if;

		for r_c_dietas_orais in c_dietas_orais loop
			if (ie_local_estoque_proc_w in ('L','R')) then
				cd_local_estoque_w := obter_local_estoque_regra_ged(cd_setor_atend_w, r_c_dietas_orais.nr_prescricao, r_c_dietas_orais.nr_seq_dieta, null, dt_horario_p, null);
			end if;

			if (coalesce(nr_seq_processo_w,0) = 0) then
				select	max(a.cd_intervalo),
						coalesce(max(a.ie_dose_espec_agora),'N')
				into STRICT	cd_intervalo_w,
						ie_dose_especial_w
				from	prescr_dieta a
				where	a.nr_prescricao = r_c_dietas_orais.nr_prescricao
				and		a.nr_sequencia = r_c_dietas_orais.nr_seq_dieta;
				qt_tempo_min_w := trunc((dt_horario_p - clock_timestamp()) * 1440);

                if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
                    CALL adep_gerar_log_rastr('{'||chr(10)||
                        '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                        '"c06" : "c06",'||chr(10)||
                        '"cd_intervalo_w" : "'||cd_intervalo_w||'",'||chr(10)||
                        '"cd_setor_atend_w" : "'||cd_setor_atend_w||'",'||chr(10)||
                        '"ie_acm_w" : "'||ie_acm_w||'",'||chr(10)||
                        '"ie_dose_especial_w" : "'||ie_dose_especial_w||'",'||chr(10)||
                        '"ie_se_necessario_w" : "'||ie_se_necessario_w||'",'||chr(10)||
                        '"ie_tipo_processo_w" : "'||ie_tipo_processo_w||'",'||chr(10)||
                        '"qt_tempo_min_w" : "'||qt_tempo_min_w||'"}', wheb_usuario_pck.get_ie_commit);
                end if;

				for r_c06 in c06 loop
					nr_seq_regra_w := r_c06.nr_sequencia;
				end loop;

				if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then
					select	coalesce(a.ie_gerar_urgente,'N')
					into STRICT	ie_gerar_urgente_w
					from	regra_etapa_gedipa a
					where	a.nr_sequencia = nr_seq_regra_w;
				end if;

				select	nextval('adep_processo_seq')
				into STRICT	nr_seq_processo_w
				;

				insert into adep_processo(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_atendimento,
					cd_setor_atendimento,
					cd_local_estoque,
					dt_processo,
					nm_usuario_processo,
					dt_horario_processo,
					cd_funcao_origem,
					ie_origem_processo,
					ie_gedipa,
					ie_urgente,
					ie_dose_especial,
					nr_prescricao,
					nr_seq_dieta,
					nr_seq_regra)
				values (
					nr_seq_processo_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_atendimento_p,
					cd_setor_atend_w,
					cd_local_estoque_w,
					clock_timestamp(),
					nm_usuario_p,
					dt_horario_p,
					cd_funcao_origem_p,
					ie_origem_processo_p,
					ie_gedipa_p,
					CASE WHEN ie_gerar_urgente_w='S' THEN 'S'  ELSE 'N' END ,
					ie_dose_especial_w,
					r_c_dietas_orais.nr_prescricao,
					r_c_dietas_orais.nr_seq_dieta,
					nr_seq_regra_w);

				nr_seq_processo_p := nr_seq_processo_w;

				if (coalesce(ie_vincula_processo_pharm_w,'N') in ('X','T','I')) then
					CALL preparar_processo_adep(	nr_seq_processo_p	=> nr_seq_processo_w,
											ie_preparar_p		=> 'S',
											nm_usuario_p		=> nm_usuario_p);
				end if;
			end if;

			CALL gerar_fracionamento_processo(	nr_seq_processo_p	=> nr_seq_processo_w,
											nm_usuario_p		=> nm_usuario_p);

			update	prescr_dieta_hor
			set		nr_seq_processo = nr_seq_processo_w
			where	nr_sequencia = r_c_dietas_orais.nr_seq_horario;

			cd_local_estoque_w := null;
			nr_seq_regra_w := null;
			ie_gerar_urgente_w := null;
		end loop;

	end if;

	nr_seq_processo_w 		:= 0;
	nr_seq_area_prep_ini_w	:= null;
	ie_atualizou_w			:= 'N';

    if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
        CALL adep_gerar_log_rastr('{'||chr(10)||
            '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
            '"c01" : "c01",'||chr(10)||
            '"cd_funcao_origem_p" : "'||cd_funcao_origem_p||'",'||chr(10)||
            '"cd_local_estoque_w" : "'||cd_local_estoque_w||'",'||chr(10)||
            '"cd_setor_atend_w" : "'||cd_setor_atend_w||'",'||chr(10)||
            '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
            '"ie_gera_nutricao_p" : "'||ie_gera_nutricao_p||'",'||chr(10)||
            '"ie_intervencao_p" : "'||ie_intervencao_p||'",'||chr(10)||
            '"ie_local_estoque_proc_w" : "'||ie_local_estoque_proc_w||'",'||chr(10)||
            '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
            '"ie_separa_nutricao_w" : "'||ie_separa_nutricao_w||'",'||chr(10)||
            '"ie_separar_agora_p" : "'||ie_separar_agora_p||'",'||chr(10)||
            '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
            '"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
            '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
            '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
            '"nr_seq_area_prep_p" : "'||nr_seq_area_prep_p||'"}', wheb_usuario_pck.get_ie_commit);
    end if;

	OPEN c01;
	LOOP
	FETCH c01 INTO
		ie_tipo_item_w,
		nr_seq_horario_w,
		nr_prescricao_w,
		nr_seq_material_w,
		nr_agrupamento_w,
		nr_seq_area_prep_w,
		ie_dose_especial_ww,
		nr_sequencia_proc_w,
		nr_seq_processo_ant_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		BEGIN

		IF (ie_local_estoque_proc_w in ('R','L')) THEN
		
			select	max(cd_local_estoque_proc)
			into STRICT	cd_local_estoque_w
			from	regra_local_dispensacao
			where	nr_sequencia in (	SELECT	max(nr_regra_local_disp)
											from	prescr_mat_hor
											where	nr_sequencia = nr_seq_horario_w);											
											
			if (coalesce(cd_local_estoque_w::text, '') = '') then
				cd_local_estoque_w	:= obter_local_estoque_regra_ged(cd_setor_atend_w,nr_prescricao_w,nr_seq_material_w,null, dt_horario_p,ie_dose_especial_ww);
			end if;
			
		end if;
		
		if (ie_local_estoque_proc_w in ('L','P','R')) then
			cd_setor_atend_w	:=	obter_setor_processo_gedipa(cd_setor_prescr_p, nr_atendimento_p);
		end if;
		
		IF (coalesce(nr_seq_processo_w,0) = 0) THEN

			SELECT	coalesce(MAX(ie_acm),'N'),
					coalesce(MAX(ie_se_necessario),'N'),
					trunc((dt_horario_p - clock_timestamp()) * 1440),
					max(ie_higienizacao),
					max(ie_preparo),
					max(ie_conferencia),
					max(CASE WHEN ie_agrupador=13 THEN 'H'  ELSE null END ),
					max(cd_intervalo),
					coalesce(max(ie_dose_espec_agora),'N')
			INTO STRICT	ie_acm_w,
					ie_se_necessario_w,
					qt_tempo_min_w,
					ie_higienizacao_w,
					ie_preparo_w,
					ie_conferencia_w,
					ie_tipo_processo_w,
					cd_intervalo_w,
					ie_dose_especial_w
			FROM	prescr_material
			WHERE	nr_prescricao	= nr_prescricao_w
			AND		nr_sequencia	= nr_seq_material_w;
			
			select	coalesce(max(ie_dose_especial),'N')
			into STRICT	ie_dose_especial_w
			from	prescr_mat_hor
			where	nr_sequencia = nr_seq_horario_w
			and		Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

            if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
                CALL adep_gerar_log_rastr('{'||chr(10)||
                    '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                    '"c06" : "c06",'||chr(10)||
                    '"cd_intervalo_w" : "'||cd_intervalo_w||'",'||chr(10)||
                    '"cd_setor_atend_w" : "'||cd_setor_atend_w||'",'||chr(10)||
                    '"ie_acm_w" : "'||ie_acm_w||'",'||chr(10)||
                    '"ie_dose_especial_w" : "'||ie_dose_especial_w||'",'||chr(10)||
                    '"ie_se_necessario_w" : "'||ie_se_necessario_w||'",'||chr(10)||
                    '"ie_tipo_processo_w" : "'||ie_tipo_processo_w||'",'||chr(10)||
                    '"qt_tempo_min_w" : "'||qt_tempo_min_w||'"}', wheb_usuario_pck.get_ie_commit);
            end if;
			
			open C06;
			loop
			fetch C06 into	
			nr_seq_regra_w;
			EXIT WHEN NOT FOUND; /* apply on C06 */
			begin
				nr_seq_regra_w := nr_seq_regra_w;
			end;
			end loop;
			close C06;
			
			if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then
				select	coalesce(ie_gerar_urgente,'N')
				into STRICT	ie_gerar_urgente_w
				from	regra_etapa_gedipa
				where	nr_sequencia	= nr_seq_regra_w;
			end if;
			
			SELECT	nextval('adep_processo_seq')
			INTO STRICT	nr_seq_processo_w
			;
			
			if (ie_tipo_item_w	= 'NE') then
				nr_etapas_w	:=  obter_etapas_adep_sne(nr_seq_horario_w);
			else
				nr_etapas_w	:= null;			
			end if;

			INSERT INTO adep_processo(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_atendimento,
				cd_setor_atendimento,
				cd_local_estoque,
				dt_processo,
				nm_usuario_processo,
				dt_horario_processo,
				cd_funcao_origem,
				ie_origem_processo,
				ie_gedipa,
				ie_urgente,
				ie_acm,
				ie_se_necessario,
				ie_dose_especial,
				ie_higienizacao,
				ie_preparo,
				ie_conferencia,
				nr_prescricao,
				nr_seq_material,
				nr_etapa,
				nr_seq_regra,
				nr_seq_procedimento)
			VALUES (
				nr_seq_processo_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_atendimento_p,
				cd_setor_atend_w,
				cd_local_estoque_w,
				clock_timestamp(),
				nm_usuario_p,
				dt_horario_p,
				cd_funcao_origem_p,
				ie_origem_processo_p,
				ie_gedipa_p,
				CASE WHEN ie_gerar_urgente_w='S' THEN 'S'  ELSE 'N' END ,
				ie_acm_w,
				ie_se_necessario_w,
				ie_dose_especial_w,
				ie_higienizacao_w,
				ie_preparo_w,
				ie_conferencia_w,
				nr_prescricao_w,
				nr_seq_material_w,
				CASE WHEN nr_etapas_w=0 THEN 1  ELSE nr_etapas_w END ,
				nr_seq_regra_w,
				nr_sequencia_proc_w);
				
			select	coalesce(max('S'),'N')
			into STRICT	ie_prescr_quimio_w
			from	prescr_medica
			where	nr_prescricao = nr_prescricao_w
			and		(nr_seq_atend IS NOT NULL AND nr_seq_atend::text <> '');
			
			if (coalesce(ie_vincula_processo_pharm_w,'N') = 'S') or (coalesce(ie_vincula_processo_pharm_w,'N') = 'I') or
				((coalesce(ie_vincula_processo_pharm_w,'N') = 'Q') and (ie_prescr_quimio_w = 'S')) or
				((coalesce(ie_vincula_processo_pharm_w,'N') = 'L') and (ie_tipo_item_w = 'M')) then
				CALL preparar_processo_adep(nr_seq_processo_w,'S',nm_usuario_p);
			elsif (((ie_tipo_item_w in ('S', 'NE', 'LD')) and (coalesce(ie_vincula_processo_pharm_w,'N') = 'X')) or
				((ie_tipo_item_w in ('S', 'NE', 'LD', 'NAN')) and (coalesce(ie_vincula_processo_pharm_w,'N') = 'T')) or (coalesce(ie_vincula_processo_pharm_w,'N') = 'I')) then	
				CALL preparar_processo_adep(nr_seq_processo_w,'S',nm_usuario_p);
			end if;
				
			nr_seq_processo_p 		:= nr_seq_processo_w;
			
			if (ie_separar_proc_area_w = 'S') then
				nr_seq_area_prep_ini_w	:= nr_seq_area_prep_w;
			end if;
			
		END IF;
		
		UPDATE	prescr_mat_hor
		SET		nr_seq_processo		= nr_seq_processo_w,
				ie_tipo_item_processo	= 'M'
		WHERE	nr_sequencia		= nr_seq_horario_w
		and		((nr_seq_area_prep = nr_seq_area_prep_ini_w) or (coalesce(nr_seq_area_prep_ini_w::text, '') = '') or (coalesce(nr_seq_area_prep_w::text, '') = ''));
		
		select	coalesce(max('S'), 'N')
		into STRICT	ie_atualizou_w
		from	prescr_mat_hor			
		where	nr_sequencia		= nr_seq_horario_w
		and		((nr_seq_area_prep = nr_seq_area_prep_ini_w) or (coalesce(nr_seq_area_prep_ini_w::text, '') = '') or (coalesce(nr_seq_area_prep_w::text, '') = ''));

        if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
            CALL adep_gerar_log_rastr('{'||chr(10)||
                '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                '"c02" : "c02",'||chr(10)||
                '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                '"ie_atualizou_w" : "'||ie_atualizou_w||'",'||chr(10)||
                '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
                '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
                '"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
                '"nr_seq_material_w" : "'||nr_seq_material_w||'"}', wheb_usuario_pck.get_ie_commit);
        end if;
		
		OPEN c02;
		LOOP
		FETCH c02 INTO	nr_seq_horario_ww,
				ie_agrupador_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			BEGIN
			
			UPDATE	prescr_mat_hor
			SET	nr_seq_processo		= nr_seq_processo_w,
				ie_tipo_item_processo	= CASE WHEN ie_agrupador_w=3 THEN 'D' WHEN ie_agrupador_w=7 THEN 'RD'  ELSE 'RC' END ,
				nr_seq_area_prep	= nr_seq_area_prep_w
			WHERE	nr_sequencia		= nr_seq_horario_ww;
			
			END;
		END LOOP;
		CLOSE c02;

        if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
            CALL adep_gerar_log_rastr('{'||chr(10)||
                '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                '"c04" : "c04",'||chr(10)||
                '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                '"ie_atualizou_w" : "'||ie_atualizou_w||'",'||chr(10)||
                '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
                '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
                '"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
                '"nr_seq_material_w" : "'||nr_seq_material_w||'"}', wheb_usuario_pck.get_ie_commit);
        end if;
		
		OPEN c04;
		LOOP
		FETCH c04 INTO
			nr_seq_horario_wwww;
		EXIT WHEN NOT FOUND; /* apply on c04 */
			BEGIN
			
			UPDATE	prescr_mat_hor
			SET	nr_seq_processo		= nr_seq_processo_w,
				nr_seq_superior		= nr_seq_material_w,
				ie_tipo_item_processo	= 'K',
				nr_seq_area_prep	= nr_seq_area_prep_w
			WHERE	nr_sequencia		= nr_seq_horario_wwww;
			
			END;
		END LOOP;
		CLOSE c04;
		
		nr_seq_mat_princ_w	:= nr_seq_material_w;

        if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
            CALL adep_gerar_log_rastr('{'||chr(10)||
                '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                '"c03" : "c03",'||chr(10)||
                '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                '"ie_atualizou_w" : "'||ie_atualizou_w||'",'||chr(10)||
                '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
                '"ie_tipo_item_w" : "'||ie_tipo_item_w||'",'||chr(10)||
                '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
                '"nr_agrupamento_w" : "'||nr_agrupamento_w||'",'||chr(10)||
                '"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
                '"nr_seq_material_w" : "'||nr_seq_material_w||'"}', wheb_usuario_pck.get_ie_commit);
        end if;

		OPEN c03;
		LOOP
		FETCH c03 INTO
			nr_seq_horario_www,
			nr_seq_mat_composto_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
			BEGIN
				
			UPDATE	prescr_mat_hor
			SET	nr_seq_processo		= nr_seq_processo_w,
				nr_seq_superior		= nr_seq_material_w,
				ie_tipo_item_processo	= 'C',
				nr_seq_area_prep	= nr_seq_area_prep_w
			WHERE	nr_sequencia		= nr_seq_horario_www;

			nr_seq_material_w	:= nr_seq_mat_composto_w;

            if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
                CALL adep_gerar_log_rastr('{'||chr(10)||
                    '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                    '"c02" : "c02",'||chr(10)||
                    '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                    '"ie_atualizou_w" : "'||ie_atualizou_w||'",'||chr(10)||
                    '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
                    '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
                    '"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
                    '"nr_seq_material_w" : "'||nr_seq_material_w||'"}', wheb_usuario_pck.get_ie_commit);
            end if;
			
            OPEN c02;
			LOOP
			FETCH c02 INTO
				nr_seq_horario_ww,
				ie_agrupador_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				BEGIN
				
				UPDATE	prescr_mat_hor
				SET	nr_seq_processo		= nr_seq_processo_w,
					ie_tipo_item_processo	= CASE WHEN ie_agrupador_w=3 THEN 'D' WHEN ie_agrupador_w=7 THEN 'RD'  ELSE 'RC' END ,
					nr_seq_area_prep	= nr_seq_area_prep_w
				WHERE	nr_sequencia		= nr_seq_horario_ww;

				END;
			END LOOP;
			CLOSE c02;

            if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then                
                CALL adep_gerar_log_rastr('{'||chr(10)||
                    '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                    '"c04" : "c04",'||chr(10)||
                    '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                    '"ie_atualizou_w" : "'||ie_atualizou_w||'",'||chr(10)||
                    '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
                    '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
                    '"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
                    '"nr_seq_material_w" : "'||nr_seq_material_w||'"}', wheb_usuario_pck.get_ie_commit);
            end if;

			OPEN c04;
			LOOP
			FETCH c04 INTO
				nr_seq_horario_wwww;
			EXIT WHEN NOT FOUND; /* apply on c04 */
				BEGIN
				
				UPDATE	prescr_mat_hor
				SET	nr_seq_processo		= nr_seq_processo_w,
					nr_seq_superior		= nr_seq_material_w,
					ie_tipo_item_processo	= 'K',
					nr_seq_area_prep	= nr_seq_area_prep_w
				WHERE	nr_sequencia		= nr_seq_horario_wwww;

				END;
			END LOOP;
			CLOSE c04;

			nr_seq_material_w	:= nr_seq_mat_princ_w;

			END;
		END LOOP;
		CLOSE c03;
		
		select coalesce(max(ie_processo_separado),'N')
		into STRICT 	ie_processo_separado_w
		from 	adep_area_prep
		where	nr_sequencia = nr_seq_area_prep_w;
			
		if (ie_processo_separado_w = 'S') then
			nr_seq_processo_ww := desdobrar_processo_gedipa(	nr_seq_processo_w, nr_seq_horario_w, nr_seq_area_prep_w, nr_seq_processo_ww, nm_usuario_p, 'N');
			CALL gerar_fracionamento_processo(nr_seq_processo_ww, nm_usuario_p);
		end if;
		
		if (nr_seq_processo_ant_w IS NOT NULL AND nr_seq_processo_ant_w::text <> '') then
			select	coalesce(max('S'),'N')
			into STRICT	ie_referencia_processo_w
			from	prescr_mat_hor
			where	nr_seq_processo = nr_seq_processo_ant_w;
			
			if (ie_referencia_processo_w = 'N') then
				begin
					CALL desfazer_processo_adep(nr_seq_processo_ant_w, 'S', nm_usuario_p);
				exception when others then
					null;
				end;
			end if;
		end if;
		
		END;
	END LOOP;
	CLOSE c01;
		
	-- Cursor so para MAP (itens associados ao procedimento)	
	nr_seq_processo_w 		:= 0;
	nr_seq_area_prep_ini_w	:= null;
	ie_atualizou_w			:= 'N';

    if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
        CALL adep_gerar_log_rastr('{'||chr(10)||
            '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
            '"c09" : "c09",'||chr(10)||
            '"cd_local_estoque_w" : "'||cd_local_estoque_w||'",'||chr(10)||
            '"cd_setor_atend_w" : "'||cd_setor_atend_w||'",'||chr(10)||
            '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
            '"ie_intervencao_p" : "'||ie_intervencao_p||'",'||chr(10)||
            '"ie_local_estoque_proc_w" : "'||ie_local_estoque_proc_w||'",'||chr(10)||
            '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
            '"ie_separar_agora_p" : "'||ie_separar_agora_p||'",'||chr(10)||
            '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
            '"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
            '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
            '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
            '"nr_seq_area_prep_p" : "'||nr_seq_area_prep_p||'"}', wheb_usuario_pck.get_ie_commit);
    end if;
	
	OPEN c09;
	LOOP
	FETCH c09 INTO
		ie_tipo_item_w,
		nr_seq_horario_w,
		nr_prescricao_w,
		nr_seq_material_w,
		nr_agrupamento_w,
		nr_seq_area_prep_w,
		ie_dose_especial_ww,
		nr_sequencia_proc_w;
	EXIT WHEN NOT FOUND; /* apply on c09 */
		BEGIN

		IF (ie_local_estoque_proc_w in ('R','L')) THEN
		
			select	max(cd_local_estoque_proc)
			into STRICT	cd_local_estoque_w
			from	regra_local_dispensacao
			where	nr_sequencia in (	SELECT	max(nr_regra_local_disp)
											from	prescr_mat_hor
											where	nr_sequencia = nr_seq_horario_w);											
											
			if (coalesce(cd_local_estoque_w::text, '') = '') then
				cd_local_estoque_w	:= obter_local_estoque_regra_ged(cd_setor_atend_w,nr_prescricao_w,nr_seq_material_w,null, dt_horario_p,ie_dose_especial_ww);
			end if;
			
		end if;
		
		if (ie_local_estoque_proc_w in ('L','P','R')) then
			cd_setor_atend_w	:=	obter_setor_processo_gedipa(cd_setor_prescr_p, nr_atendimento_p);
		end if;
		
		IF (coalesce(nr_seq_processo_w,0) = 0) THEN

			SELECT	coalesce(MAX(ie_acm),'N'),
					coalesce(MAX(ie_se_necessario),'N'),
					trunc((dt_horario_p - clock_timestamp()) * 1440),
					max(ie_higienizacao),
					max(ie_preparo),
					max(ie_conferencia),
					max(CASE WHEN ie_agrupador=13 THEN 'H'  ELSE null END ),
					max(cd_intervalo),
					coalesce(max(ie_dose_espec_agora),'N')
			INTO STRICT	ie_acm_w,
					ie_se_necessario_w,
					qt_tempo_min_w,
					ie_higienizacao_w,
					ie_preparo_w,
					ie_conferencia_w,
					ie_tipo_processo_w,
					cd_intervalo_w,
					ie_dose_especial_w
			FROM	prescr_material
			WHERE	nr_prescricao	= nr_prescricao_w
			AND		nr_sequencia	= nr_seq_material_w;
			
			select	coalesce(max(ie_dose_especial),'N')
			into STRICT	ie_dose_especial_w
			from	prescr_mat_hor
			where	nr_sequencia = nr_seq_horario_w
			and		Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

            if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
                CALL adep_gerar_log_rastr('{'||chr(10)||
                    '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                    '"c06" : "c06",'||chr(10)||
                    '"cd_intervalo_w" : "'||cd_intervalo_w||'",'||chr(10)||
                    '"cd_setor_atend_w" : "'||cd_setor_atend_w||'",'||chr(10)||
                    '"ie_acm_w" : "'||ie_acm_w||'",'||chr(10)||
                    '"ie_dose_especial_w" : "'||ie_dose_especial_w||'",'||chr(10)||
                    '"ie_se_necessario_w" : "'||ie_se_necessario_w||'",'||chr(10)||
                    '"ie_tipo_processo_w" : "'||ie_tipo_processo_w||'",'||chr(10)||
                    '"qt_tempo_min_w" : "'||qt_tempo_min_w||'"}', wheb_usuario_pck.get_ie_commit);
            end if;
			
			open C06;
			loop
			fetch C06 into	
			nr_seq_regra_w;
			EXIT WHEN NOT FOUND; /* apply on C06 */
			begin
				nr_seq_regra_w := nr_seq_regra_w;
			end;
			end loop;
			close C06;
			
			if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then
				select	coalesce(ie_gerar_urgente,'N')
				into STRICT	ie_gerar_urgente_w
				from	regra_etapa_gedipa
				where	nr_sequencia	= nr_seq_regra_w;
			end if;
			
			SELECT	nextval('adep_processo_seq')
			INTO STRICT	nr_seq_processo_w
			;
			
			nr_etapas_w	:= null;			

			INSERT INTO adep_processo(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_atendimento,
				cd_setor_atendimento,
				cd_local_estoque,
				dt_processo,
				nm_usuario_processo,
				dt_horario_processo,
				cd_funcao_origem,
				ie_origem_processo,
				ie_gedipa,
				ie_urgente,
				ie_acm,
				ie_se_necessario,
				ie_dose_especial,
				ie_higienizacao,
				ie_preparo,
				ie_conferencia,
				nr_prescricao,
				nr_seq_material,
				nr_etapa,
				nr_seq_regra,
				nr_seq_procedimento)
			VALUES (
				nr_seq_processo_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_atendimento_p,
				cd_setor_atend_w,
				cd_local_estoque_w,
				clock_timestamp(),
				nm_usuario_p,
				dt_horario_p,
				cd_funcao_origem_p,
				ie_origem_processo_p,
				ie_gedipa_p,
				CASE WHEN ie_gerar_urgente_w='S' THEN 'S'  ELSE 'N' END ,
				ie_acm_w,
				ie_se_necessario_w,
				ie_dose_especial_w,
				ie_higienizacao_w,
				ie_preparo_w,
				ie_conferencia_w,
				nr_prescricao_w,
				nr_seq_material_w,
				CASE WHEN nr_etapas_w=0 THEN 1  ELSE nr_etapas_w END ,
				nr_seq_regra_w,
				nr_sequencia_proc_w);
				
			select	coalesce(max('S'),'N')
			into STRICT	ie_prescr_quimio_w
			from	prescr_medica
			where	nr_prescricao = nr_prescricao_w
			and		(nr_seq_atend IS NOT NULL AND nr_seq_atend::text <> '');
			
			if (coalesce(ie_vincula_processo_pharm_w,'N') = 'S') or (coalesce(ie_vincula_processo_pharm_w,'N') = 'I') or
				((coalesce(ie_vincula_processo_pharm_w,'N') = 'Q') and (ie_prescr_quimio_w = 'S')) then
				CALL preparar_processo_adep(nr_seq_processo_w,'S',nm_usuario_p);			
			end if;
						
			if (ie_separar_proc_area_w = 'S') then
				nr_seq_area_prep_ini_w	:= nr_seq_area_prep_w;
			end if;
			
		END IF;

        CALL atualiza_ie_tipo_processo(nr_seq_processo_p => nr_seq_processo_w,
                                    nr_seq_horario_p => nr_seq_horario_w,
                                    nr_seq_area_prep_p => nr_seq_area_prep_ini_w,
                                    nr_prescricao_p => nr_prescricao_w,
                                    nr_sequencia_proc_p => nr_sequencia_proc_w);

		select	coalesce(max('S'), 'N')
		into STRICT	ie_atualizou_w
		from	prescr_mat_hor			
		where	nr_sequencia		= nr_seq_horario_w
		and		((nr_seq_area_prep = nr_seq_area_prep_ini_w) or (coalesce(nr_seq_area_prep_ini_w::text, '') = ''));

        if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
            CALL adep_gerar_log_rastr('{'||chr(10)||
                '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                '"c02" : "c02",'||chr(10)||
                '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                '"ie_atualizou_w" : "'||ie_atualizou_w||'",'||chr(10)||
                '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
                '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
                '"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
                '"nr_seq_material_w" : "'||nr_seq_material_w||'"}', wheb_usuario_pck.get_ie_commit);
        end if;
				
		OPEN c02;
		LOOP
		FETCH c02 INTO	nr_seq_horario_ww,
				ie_agrupador_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			BEGIN
		
			UPDATE	prescr_mat_hor
			SET	nr_seq_processo		= nr_seq_processo_w,
				ie_tipo_item_processo	= CASE WHEN ie_agrupador_w=3 THEN 'D' WHEN ie_agrupador_w=7 THEN 'RD'  ELSE 'RC' END ,
				nr_seq_area_prep	= nr_seq_area_prep_w
			WHERE	nr_sequencia		= nr_seq_horario_ww;
			
			END;
		END LOOP;
		CLOSE c02;

        if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
            CALL adep_gerar_log_rastr('{'||chr(10)||
                '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                '"c04" : "c04",'||chr(10)||
                '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                '"ie_atualizou_w" : "'||ie_atualizou_w||'",'||chr(10)||
                '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
                '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
                '"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
                '"nr_seq_material_w" : "'||nr_seq_material_w||'"}', wheb_usuario_pck.get_ie_commit);
        end if;
		
		OPEN c04;
		LOOP
		FETCH c04 INTO
			nr_seq_horario_wwww;
		EXIT WHEN NOT FOUND; /* apply on c04 */
			BEGIN
						
			UPDATE	prescr_mat_hor
			SET	nr_seq_processo		= nr_seq_processo_w,
				nr_seq_superior		= nr_seq_material_w,
				ie_tipo_item_processo	= 'K',
				nr_seq_area_prep	= nr_seq_area_prep_w
			WHERE	nr_sequencia		= nr_seq_horario_wwww;
			
			END;
		END LOOP;
		CLOSE c04;
		
		nr_seq_mat_princ_w	:= nr_seq_material_w;

        if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
            CALL adep_gerar_log_rastr('{'||chr(10)||
                '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                '"c03" : "c03",'||chr(10)||
                '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                '"ie_atualizou_w" : "'||ie_atualizou_w||'",'||chr(10)||
                '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
                '"ie_tipo_item_w" : "'||ie_tipo_item_w||'",'||chr(10)||
                '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
                '"nr_agrupamento_w" : "'||nr_agrupamento_w||'",'||chr(10)||
                '"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
                '"nr_seq_material_w" : "'||nr_seq_material_w||'"}', wheb_usuario_pck.get_ie_commit);
        end if;

		OPEN c03;
		LOOP
		FETCH c03 INTO
			nr_seq_horario_www,
			nr_seq_mat_composto_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
			BEGIN
				
			UPDATE	prescr_mat_hor
			SET	nr_seq_processo		= nr_seq_processo_w,
				nr_seq_superior		= nr_seq_material_w,
				ie_tipo_item_processo	= 'C',
				nr_seq_area_prep	= nr_seq_area_prep_w
			WHERE	nr_sequencia		= nr_seq_horario_www;

			nr_seq_material_w	:= nr_seq_mat_composto_w;

            if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
                CALL adep_gerar_log_rastr('{'||chr(10)||
                    '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                    '"c02" : "c02",'||chr(10)||
                    '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                    '"ie_atualizou_w" : "'||ie_atualizou_w||'",'||chr(10)||
                    '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
                    '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
                    '"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
                    '"nr_seq_material_w" : "'||nr_seq_material_w||'"}', wheb_usuario_pck.get_ie_commit);
            end if;

			OPEN c02;
			LOOP
			FETCH c02 INTO
				nr_seq_horario_ww,
				ie_agrupador_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				BEGIN
				
				UPDATE	prescr_mat_hor
				SET	nr_seq_processo		= nr_seq_processo_w,
					ie_tipo_item_processo	= CASE WHEN ie_agrupador_w=3 THEN 'D' WHEN ie_agrupador_w=7 THEN 'RD'  ELSE 'RC' END ,
					nr_seq_area_prep	= nr_seq_area_prep_w
				WHERE	nr_sequencia		= nr_seq_horario_ww;

				END;
			END LOOP;
			CLOSE c02;

            if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
                CALL adep_gerar_log_rastr('{'||chr(10)||
                    '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                    '"c04" : "c04",'||chr(10)||
                    '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                    '"ie_atualizou_w" : "'||ie_atualizou_w||'",'||chr(10)||
                    '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
                    '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
                    '"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
                    '"nr_seq_material_w" : "'||nr_seq_material_w||'"}', wheb_usuario_pck.get_ie_commit);
            end if;

			OPEN c04;
			LOOP
			FETCH c04 INTO
				nr_seq_horario_wwww;
			EXIT WHEN NOT FOUND; /* apply on c04 */
				BEGIN
				
				UPDATE	prescr_mat_hor
				SET	nr_seq_processo		= nr_seq_processo_w,
					nr_seq_superior		= nr_seq_material_w,
					ie_tipo_item_processo	= 'K',
					nr_seq_area_prep	= nr_seq_area_prep_w
				WHERE	nr_sequencia		= nr_seq_horario_wwww;

				END;
			END LOOP;
			CLOSE c04;

			nr_seq_material_w	:= nr_seq_mat_princ_w;

			END;
		END LOOP;
		CLOSE c03;
		
		select coalesce(max(ie_processo_separado),'N')
		into STRICT 	ie_processo_separado_w
		from 	adep_area_prep
		where	nr_sequencia = nr_seq_area_prep_w;
			
		if (ie_processo_separado_w = 'S') then
			nr_seq_processo_ww := desdobrar_processo_gedipa(	nr_seq_processo_w, nr_seq_horario_w, nr_seq_area_prep_w, nr_seq_processo_ww, nm_usuario_p, 'N');
			CALL gerar_fracionamento_processo(nr_seq_processo_ww, nm_usuario_p);
		end if;
		
		END;
	END LOOP;
	CLOSE c09;
	
	if (ie_tipo_item_w = 'MAP') and (coalesce(nr_seq_processo_w,0) > 0) then	
		if (ie_origem_processo_p in ('GGP','GGPI'))  then		
			CALL gerar_fracionamento_processo(nr_seq_processo_w, 'Job');	
		elsif (ie_origem_processo_p = 'GPAP') then
			CALL gerar_fracionamento_processo(nr_seq_processo_w, nm_usuario_p);	
		end if;
	end if;	
	
	ie_atualizou_w := 'S';

	-- Cursor 'Agora' 
		
    if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
        CALL adep_gerar_log_rastr('{'||chr(10)||
            '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
            '"c05" : "c05",'||chr(10)||
            '"cd_funcao_origem_p" : "'||cd_funcao_origem_p||'",'||chr(10)||
            '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
            '"ie_gera_nutricao_p" : "'||ie_gera_nutricao_p||'",'||chr(10)||
            '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
            '"ie_separar_agora_p" : "'||ie_separar_agora_p||'",'||chr(10)||
            '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
            '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
            '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
            '"nr_seq_area_prep_p" : "'||nr_seq_area_prep_p||'"}', wheb_usuario_pck.get_ie_commit);
    end if;

	OPEN c05;
	LOOP
	FETCH c05 INTO	ie_tipo_item_w,
			nr_seq_horario_w,
			nr_prescricao_w,
			nr_seq_material_w,
			nr_agrupamento_w,
			nr_seq_area_prep_w,
			cd_intervalo_w,
			ie_dose_especial_ww,
			nr_sequencia_proc_w,
			nr_seq_processo_ged_w;
	EXIT WHEN NOT FOUND; /* apply on c05 */
		BEGIN

        if ((ie_trans_proc_gedipa_w = 'N') or (coalesce(nr_seq_processo_ged_w::text, '') = '') or (obter_dados_processo_adep(nr_seq_processo_ged_w,'O') not in ('GGP','GGPI')) and (obter_status_processo(nr_seq_processo_ged_w) in ('G','D','L'))) then
		
            IF (ie_local_estoque_proc_w in ('L','R')) THEN
                select	max(cd_local_estoque_proc)
                into STRICT	cd_local_estoque_w
                from	regra_local_dispensacao
                where	nr_sequencia in (	SELECT	max(nr_regra_local_disp)
                                                from	prescr_mat_hor
                                                where	nr_sequencia = nr_seq_horario_w);											

                if (coalesce(cd_local_estoque_w::text, '') = '') then
                    cd_local_estoque_w	:= obter_local_estoque_regra_ged(cd_setor_atend_w,nr_prescricao_w,nr_seq_material_w,null, dt_horario_p,ie_dose_especial_ww);
                end if;
            end if;

            if (ie_local_estoque_proc_w in ('L','P','R')) then
                cd_setor_atend_w	:=	obter_setor_processo_gedipa(cd_setor_prescr_p, nr_atendimento_p);
            end if;

            if (coalesce(nr_seq_processo_agora_w,0) = 0) then

                select	coalesce(max(ie_acm),'N'),
                        coalesce(max(ie_se_necessario),'N'),
                        trunc((dt_horario_p - clock_timestamp()) * 1440),
                        max(ie_higienizacao),
                        max(ie_preparo),
                        max(ie_conferencia),
                        max(CASE WHEN ie_agrupador=13 THEN 'H'  ELSE null END ),
                        max(cd_intervalo),
                        coalesce(max(ie_dose_espec_agora),'N')
                into STRICT	ie_acm_w,
                        ie_se_necessario_w,
                        qt_tempo_min_w,
                        ie_higienizacao_w,
                        ie_preparo_w,
                        ie_conferencia_w,
                        ie_tipo_processo_w,
                        cd_intervalo_w,
                        ie_dose_especial_w
                from	prescr_material
                where	nr_prescricao	= nr_prescricao_w
                and		nr_sequencia	= nr_seq_material_w;

                select	coalesce(max(ie_dose_especial),'N')
                into STRICT	ie_dose_especial_w
                from	prescr_mat_hor
                where	nr_sequencia = nr_seq_horario_w
                and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

                if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
                    CALL adep_gerar_log_rastr('{'||chr(10)||
                        '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                        '"c06" : "c06",'||chr(10)||
                        '"cd_intervalo_w" : "'||cd_intervalo_w||'",'||chr(10)||
                        '"cd_setor_atend_w" : "'||cd_setor_atend_w||'",'||chr(10)||
                        '"ie_acm_w" : "'||ie_acm_w||'",'||chr(10)||
                        '"ie_dose_especial_w" : "'||ie_dose_especial_w||'",'||chr(10)||
                        '"ie_se_necessario_w" : "'||ie_se_necessario_w||'",'||chr(10)||
                        '"ie_tipo_processo_w" : "'||ie_tipo_processo_w||'",'||chr(10)||
                        '"qt_tempo_min_w" : "'||qt_tempo_min_w||'"}', wheb_usuario_pck.get_ie_commit);
                end if;

                open C06;
                loop
                fetch C06 into	
                    nr_seq_regra_w;
                EXIT WHEN NOT FOUND; /* apply on C06 */
                begin
                    nr_seq_regra_w := nr_seq_regra_w;
                end;
                end loop;
                close C06;

                if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then
                    select	coalesce(ie_gerar_urgente,'N')
                    into STRICT	ie_gerar_urgente_w
                    from	regra_etapa_gedipa
                    where	nr_sequencia	= nr_seq_regra_w;
                end if;			

                SELECT	nextval('adep_processo_seq')
                INTO STRICT	nr_seq_processo_agora_w
;

                if (ie_tipo_item_w	= 'NE') then
                    nr_etapas_w	:=  obter_etapas_adep_sne(nr_seq_horario_w);
                else
                    nr_etapas_w	:= null;			
                end if;

                INSERT INTO adep_processo(
                    nr_sequencia,
                    dt_atualizacao,
                    nm_usuario,
                    dt_atualizacao_nrec,
                    nm_usuario_nrec,
                    nr_atendimento,
                    cd_setor_atendimento,
                    cd_local_estoque,
                    dt_processo,
                    nm_usuario_processo,
                    dt_horario_processo,
                    cd_funcao_origem,
                    ie_origem_processo,
                    ie_gedipa,
                    ie_urgente,
                    cd_intervalo,
                    nr_prescricao,
                    nr_seq_material,
                    nr_etapa,
                    nr_seq_regra,
                    nr_seq_procedimento)
                VALUES (
                    nr_seq_processo_agora_w,
                    clock_timestamp(),
                    nm_usuario_p,
                    clock_timestamp(),
                    nm_usuario_p,
                    nr_atendimento_p,
                    cd_setor_atend_w,
                    cd_local_estoque_w,
                    clock_timestamp(),
                    nm_usuario_p,
                    dt_horario_p,
                    cd_funcao_origem_p,
                    ie_origem_processo_p,
                    ie_gedipa_p,
                    'S',
                    cd_intervalo_w,
                    nr_prescricao_w,
                    nr_seq_material_w,
                    CASE WHEN nr_etapas_w=0 THEN 1  ELSE nr_etapas_w END ,
                    nr_seq_regra_w,
                    nr_sequencia_proc_w);
            END IF;

            UPDATE	prescr_mat_hor
            SET	nr_seq_processo		= nr_seq_processo_agora_w,
                ie_tipo_item_processo	= 'M'
            WHERE	nr_sequencia		= nr_seq_horario_w;

            select	coalesce(max('S'),'N')
            into STRICT	ie_prescr_quimio_w
            from	prescr_medica
            where	nr_prescricao = nr_prescricao_w
            and		(nr_seq_atend IS NOT NULL AND nr_seq_atend::text <> '');

            if (coalesce(ie_vincula_processo_pharm_w,'N') = 'S') or (coalesce(ie_vincula_processo_pharm_w,'N') = 'I') or
                ((coalesce(ie_vincula_processo_pharm_w,'N') = 'Q') and (ie_prescr_quimio_w = 'S')) then
                    CALL preparar_processo_adep(nr_seq_processo_w,'S',nm_usuario_p);
            elsif (((ie_tipo_item_w in ('S', 'NE', 'LD')) and (coalesce(ie_vincula_processo_pharm_w,'N') = 'X')) or
                ((ie_tipo_item_w in ('S', 'NE', 'LD', 'NAN')) and (coalesce(ie_vincula_processo_pharm_w,'N') = 'T')) or (coalesce(ie_vincula_processo_pharm_w,'N') = 'I')) then	
                CALL preparar_processo_adep(nr_seq_processo_w,'S',nm_usuario_p);
            end if;

            if (ie_tipo_item_w = 'MAP') then
                CALL atualiza_ie_tipo_processo(nr_seq_processo_p => nr_seq_processo_agora_w,
                                    nr_seq_horario_p => nr_seq_horario_w,
                                    nr_seq_area_prep_p => nr_seq_area_prep_ini_w,
                                    nr_prescricao_p => nr_prescricao_w,
                                    nr_sequencia_proc_p => nr_sequencia_proc_w);
            end if;

            if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
                CALL adep_gerar_log_rastr('{'||chr(10)||
                    '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                    '"c02" : "c02",'||chr(10)||
                    '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                    '"ie_atualizou_w" : "'||ie_atualizou_w||'",'||chr(10)||
                    '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
                    '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
                    '"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
                    '"nr_seq_material_w" : "'||nr_seq_material_w||'"}', wheb_usuario_pck.get_ie_commit);
            end if;

            OPEN c02;
            LOOP
            FETCH c02 INTO	nr_seq_horario_ww,
                    ie_agrupador_w;
            EXIT WHEN NOT FOUND; /* apply on c02 */
                BEGIN

                UPDATE	prescr_mat_hor
                SET	nr_seq_processo		= nr_seq_processo_agora_w,
                    ie_tipo_item_processo	= CASE WHEN ie_agrupador_w=3 THEN 'D' WHEN ie_agrupador_w=7 THEN 'RD'  ELSE 'RC' END ,
                    nr_seq_area_prep		= nr_seq_area_prep_w
                WHERE	nr_sequencia		= nr_seq_horario_ww;

                END;
            END LOOP;
            CLOSE c02;

            if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
                CALL adep_gerar_log_rastr('{'||chr(10)||
                    '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                    '"c04" : "c04",'||chr(10)||
                    '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                    '"ie_atualizou_w" : "'||ie_atualizou_w||'",'||chr(10)||
                    '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
                    '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
                    '"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
                    '"nr_seq_material_w" : "'||nr_seq_material_w||'"}', wheb_usuario_pck.get_ie_commit);
            end if;

            OPEN c04;
            LOOP
            FETCH c04 INTO	nr_seq_horario_wwww;
            EXIT WHEN NOT FOUND; /* apply on c04 */
                BEGIN

                UPDATE	prescr_mat_hor
                SET	nr_seq_processo		= nr_seq_processo_agora_w,
                    nr_seq_superior		= nr_seq_material_w,
                    ie_tipo_item_processo	= 'K',
                    nr_seq_area_prep		= nr_seq_area_prep_w
                WHERE	nr_sequencia		= nr_seq_horario_wwww;

                END;
            END LOOP;
            CLOSE c04;

            nr_seq_mat_princ_w	:= nr_seq_material_w;

            if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
                CALL adep_gerar_log_rastr('{'||chr(10)||
                    '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                    '"c03" : "c03",'||chr(10)||
                    '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                    '"ie_atualizou_w" : "'||ie_atualizou_w||'",'||chr(10)||
                    '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
                    '"ie_tipo_item_w" : "'||ie_tipo_item_w||'",'||chr(10)||
                    '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
                    '"nr_agrupamento_w" : "'||nr_agrupamento_w||'",'||chr(10)||
                    '"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
                    '"nr_seq_material_w" : "'||nr_seq_material_w||'"}', wheb_usuario_pck.get_ie_commit);
            end if;

            OPEN c03;
            LOOP
            FETCH c03 INTO
                nr_seq_horario_www,
                nr_seq_mat_composto_w;
            EXIT WHEN NOT FOUND; /* apply on c03 */
                BEGIN

                UPDATE	prescr_mat_hor
                SET	nr_seq_processo		= nr_seq_processo_agora_w,
                    nr_seq_superior		= nr_seq_material_w,
                    ie_tipo_item_processo	= 'C',
                    nr_seq_area_prep	= nr_seq_area_prep_w
                WHERE	nr_sequencia		= nr_seq_horario_www;

                nr_seq_material_w	:= nr_seq_mat_composto_w;

                if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
                    CALL adep_gerar_log_rastr('{'||chr(10)||
                        '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                        '"c02" : "c02",'||chr(10)||
                        '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                        '"ie_atualizou_w" : "'||ie_atualizou_w||'",'||chr(10)||
                        '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
                        '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
                        '"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
                        '"nr_seq_material_w" : "'||nr_seq_material_w||'"}', wheb_usuario_pck.get_ie_commit);
                end if;

                OPEN c02;
                LOOP
                FETCH c02 INTO
                    nr_seq_horario_ww,
                    ie_agrupador_w;
                EXIT WHEN NOT FOUND; /* apply on c02 */
                    BEGIN

                    UPDATE	prescr_mat_hor
                    SET	nr_seq_processo		= nr_seq_processo_agora_w,
                        ie_tipo_item_processo	= CASE WHEN ie_agrupador_w=3 THEN 'D' WHEN ie_agrupador_w=7 THEN 'RD'  ELSE 'RC' END ,
                        nr_seq_area_prep		= nr_seq_area_prep_w
                    WHERE	nr_sequencia		= nr_seq_horario_ww;

                    END;
                END LOOP;
                CLOSE c02;

                if (obter_rastreabilidade_adep(nr_prescricao_p, 'GP') = 'S') then
                    CALL adep_gerar_log_rastr('{'||chr(10)||
                        '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                        '"c04" : "c04",'||chr(10)||
                        '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                        '"ie_atualizou_w" : "'||ie_atualizou_w||'",'||chr(10)||
                        '"ie_origem_processo_p" : "'||ie_origem_processo_p||'",'||chr(10)||
                        '"ie_trans_proc_gedipa_w" : "'||ie_trans_proc_gedipa_w||'",'||chr(10)||
                        '"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
                        '"nr_seq_material_w" : "'||nr_seq_material_w||'"}', wheb_usuario_pck.get_ie_commit);
                end if;

                OPEN c04;
                LOOP
                FETCH c04 INTO
                    nr_seq_horario_wwww;
                EXIT WHEN NOT FOUND; /* apply on c04 */
                    BEGIN

                    UPDATE	prescr_mat_hor
                    SET	nr_seq_processo		= nr_seq_processo_agora_w,
                        nr_seq_superior		= nr_seq_material_w,
                        ie_tipo_item_processo	= 'K',
                        nr_seq_area_prep	= nr_seq_area_prep_w
                    WHERE	nr_sequencia		= nr_seq_horario_wwww;

                    END;
                END LOOP;
                CLOSE c04;

                nr_seq_material_w	:= nr_seq_mat_princ_w;

                END;
            END LOOP;
            CLOSE c03;

            select coalesce(max(ie_processo_separado),'N')
            into STRICT 	ie_processo_separado_w
            from 	adep_area_prep
            where	nr_sequencia = nr_seq_area_prep_w;

            if (ie_processo_separado_w = 'S') then
                nr_processo_desdobrado_p => nr_seq_processo_ww := desdobrar_processo_gedipa(	nr_processo_p => nr_seq_processo_agora_w, nr_etiquetas_desdobrar_p => nr_seq_horario_w, nr_seq_area_prep_p => nr_seq_area_prep_w, nr_processo_desdobrado_p => nr_seq_processo_ww, nm_usuario_p => nm_usuario_p, ie_atualizar_processo_p => 'N');
                CALL gerar_fracionamento_processo(	nr_seq_processo_p => nr_seq_processo_ww,
                                                nm_usuario_p => nm_usuario_p);
            end if;
		
        end if;

		END;
	END LOOP;
	CLOSE c05;
	
	nr_seq_processo_agora_p	:= nr_seq_processo_agora_w;

    CALL desdobrar_processo_item_pharm( nr_atendimento_p => nr_atendimento_p,
                                    dt_horario_p => dt_horario_p,
                                    nr_prescricao_p => nr_prescricao_p,
                                    nr_seq_area_prep_p => nr_seq_area_prep_p );

END IF;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

EXCEPTION
WHEN OTHERS THEN
	ds_erro_w	:= SUBSTR(SQLERRM(SQLSTATE),1,1800);
	
	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_processo_adep ( nr_atendimento_p bigint, dt_horario_p timestamp, nm_usuario_p text, nr_seq_processo_p INOUT bigint, ie_somente_gedipa_p text, cd_funcao_origem_p bigint, ie_origem_processo_p text, ie_gedipa_p text, ie_separar_agora_p text, nr_seq_processo_agora_p INOUT bigint, cd_local_estoque_p bigint, cd_setor_prescr_p bigint, ie_intervencao_p text default 'N', nr_seq_processo_nut_p INOUT bigint DEFAULT NULL, nr_seq_area_prep_p bigint default null, nr_prescricao_p bigint default null, ie_gera_nutricao_p text default 'N') FROM PUBLIC;

