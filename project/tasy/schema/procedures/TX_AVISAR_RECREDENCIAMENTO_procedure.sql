-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tx_avisar_recredenciamento (nm_usuario_p text) AS $body$
DECLARE



nr_seq_centro_w			bigint;
dt_credenciamento_centro_w	timestamp;
nr_seq_centro_rec_w		bigint;
ie_forma_recred_centro_w	varchar(15);
cd_estabelecimento_centro_w	integer;
dt_proximo_cred_centro_w	timestamp;
ds_centro_w			varchar(80);

nr_seq_equipe_w			bigint;
dt_credenciamento_equipe_w	timestamp;
nr_seq_equipe_rec_w		bigint;
ie_forma_recred_equipe_w	varchar(15);
cd_estabelecimento_equipe_w	integer;
dt_proximo_cred_equipe_w	timestamp;
ds_equipe_w			varchar(80);
cd_perfil_recredenc_w		integer;
qt_dias_ant_equipe_w		bigint;
qt_dias_ant_centro_w		bigint;
dt_proximo_base_centro_w	timestamp;
dt_proximo_base_equipe_w	timestamp;

c01 CURSOR FOR
	SELECT	nr_sequencia,
		dt_credenciamento,
		ie_forma_recredenciamento,
		cd_estabelecimento,
		ds_central,
		coalesce(qt_dias_antecedencia,0)
	from	tx_central_transpl
	where	coalesce(dt_exclusao::text, '') = ''
	and	(ie_forma_recredenciamento IS NOT NULL AND ie_forma_recredenciamento::text <> '');

c02 CURSOR FOR
	SELECT	nr_sequencia,
		dt_credenciamento,
		ie_forma_recredenciamento,
		cd_estabelecimento,
		ds_equipe,
		coalesce(qt_dias_antecedencia,0)
	from	tx_equipe_transpl
	where	coalesce(dt_exclusao::text, '') = ''
	and	(ie_forma_recredenciamento IS NOT NULL AND ie_forma_recredenciamento::text <> '');


BEGIN

open c01;
loop
fetch c01 into 	nr_seq_centro_w,
		dt_credenciamento_centro_w,
		ie_forma_recred_centro_w,
		cd_estabelecimento_centro_w,
		ds_centro_w,
		qt_dias_ant_centro_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	select 	coalesce(max(cd_perfil_recredenc),0)
	into STRICT	cd_perfil_recredenc_w
	from	tx_parametros
	where	cd_estabelecimento = cd_estabelecimento_centro_w;

	select 	coalesce(max(nr_sequencia),0)
	into STRICT	nr_seq_centro_rec_w
	from	tx_central_recred
	where	nr_seq_central = nr_seq_centro_w;

	if (nr_seq_centro_rec_w > 0) then

		select 	dt_recredenciamento
		into STRICT	dt_credenciamento_centro_w
		from	tx_central_recred
		where 	nr_sequencia = nr_seq_centro_rec_w;

	end if;

	if (dt_credenciamento_centro_w IS NOT NULL AND dt_credenciamento_centro_w::text <> '') and (cd_perfil_recredenc_w > 0) then


		dt_proximo_cred_centro_w	:= trunc(obter_prox_data_solic(ie_forma_recred_centro_w,dt_credenciamento_centro_w,null));
		dt_proximo_base_centro_w	:= trunc(obter_prox_data_solic(ie_forma_recred_centro_w,dt_credenciamento_centro_w,null));

		if (qt_dias_ant_centro_w > 0) and (dt_proximo_base_centro_w IS NOT NULL AND dt_proximo_base_centro_w::text <> '') then

			dt_proximo_base_centro_w := dt_proximo_base_centro_w - qt_dias_ant_centro_w;

		end if;

		if (dt_proximo_base_centro_w <= trunc(clock_timestamp())) and (dt_proximo_cred_centro_w IS NOT NULL AND dt_proximo_cred_centro_w::text <> '') then

			insert into comunic_interna(
				dt_comunicado,
				ds_titulo,
				ds_comunicado,
				nm_usuario,
				dt_atualizacao,
				ie_geral,
				nm_usuario_destino,
				ds_perfil_adicional,
				nr_sequencia,
				ie_gerencial,
				dt_liberacao,
				cd_estab_destino
			) values (
				clock_timestamp(),
				wheb_mensagem_pck.get_texto(798664) || ': ' || ds_centro_w,
				wheb_mensagem_pck.get_texto(798696,
							'DS_CENTRO='||ds_centro_w||
							';DT_PROXIMO_CRED_CENTRO='||dt_proximo_cred_centro_w),
				nm_usuario_p,
				clock_timestamp(),
				'N',
				'',
				cd_perfil_recredenc_w||', ',
				nextval('comunic_interna_seq'),
				'N',
				clock_timestamp(),
				cd_estabelecimento_centro_w);
		end if;
	end if;
	end;
end loop;
close c01;

open c02;
loop
fetch c02 into 	nr_seq_equipe_w,
		dt_credenciamento_equipe_w,
		ie_forma_recred_equipe_w,
		cd_estabelecimento_equipe_w,
		ds_equipe_w,
		qt_dias_ant_equipe_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin

	select 	coalesce(max(cd_perfil_recredenc),0)
	into STRICT	cd_perfil_recredenc_w
	from	tx_parametros
	where	cd_estabelecimento = cd_estabelecimento_equipe_w;

	select 	coalesce(max(nr_sequencia),0)
	into STRICT	nr_seq_equipe_rec_w
	from	tx_equipe_recred
	where	nr_seq_equipe = nr_seq_equipe_w;

	if (nr_seq_equipe_rec_w > 0) then

		select 	dt_recredenciamento
		into STRICT	dt_credenciamento_equipe_w
		from	tx_equipe_recred
		where 	nr_sequencia = nr_seq_equipe_rec_w;

	end if;

	if (dt_credenciamento_equipe_w IS NOT NULL AND dt_credenciamento_equipe_w::text <> '') and (cd_perfil_recredenc_w > 0) then

		dt_proximo_cred_equipe_w	:= trunc(obter_prox_data_solic(ie_forma_recred_equipe_w,dt_credenciamento_equipe_w,null));
		dt_proximo_base_equipe_w	:= trunc(obter_prox_data_solic(ie_forma_recred_equipe_w,dt_credenciamento_equipe_w,null));

		if (qt_dias_ant_equipe_w > 0) and (dt_proximo_base_equipe_w IS NOT NULL AND dt_proximo_base_equipe_w::text <> '') then

			dt_proximo_base_equipe_w := dt_proximo_base_equipe_w - qt_dias_ant_equipe_w;

		end if;


		if (dt_proximo_base_equipe_w <= trunc(clock_timestamp())) and (dt_proximo_cred_equipe_w IS NOT NULL AND dt_proximo_cred_equipe_w::text <> '') then

			insert into comunic_interna(
				dt_comunicado,
				ds_titulo,
				ds_comunicado,
				nm_usuario,
				dt_atualizacao,
				ie_geral,
				nm_usuario_destino,
				ds_perfil_adicional,
				nr_sequencia,
				ie_gerencial,
				dt_liberacao,
				cd_estab_destino
			) values (
				clock_timestamp(),
				wheb_mensagem_pck.get_texto(798697) || ': ' || ds_equipe_w,
				wheb_mensagem_pck.get_texto(798698,
							'DS_EQUIPE='||ds_equipe_w||
							';DT_PROXIMO_CRED_EQUIPE='||dt_proximo_cred_equipe_w),
				nm_usuario_p,
				clock_timestamp(),
				'N',
				'',
				cd_perfil_recredenc_w||', ',
				nextval('comunic_interna_seq'),
				'N',
				clock_timestamp(),
				cd_estabelecimento_equipe_w
			);

		end if;

	end if;

	end;
end loop;
close c02;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tx_avisar_recredenciamento (nm_usuario_p text) FROM PUBLIC;

