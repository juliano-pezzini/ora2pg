-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_data_resultado_js ( nr_prescricao_p bigint, nr_sequencia_p bigint, dt_resultado_p timestamp, cd_perfil_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


vl_parametro_w	varchar(1);
ie_urgente_w	varchar(1);

BEGIN

if (coalesce(nr_prescricao_p,0) > 0) and (coalesce(nr_sequencia_p,0) > 0) then
	begin
	vl_parametro_w := obter_param_usuario(916, 827, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, vl_parametro_w);
	ie_urgente_w := obter_param_usuario(916, 1159, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_urgente_w);

	update 	prescr_procedimento
	set 	dt_resultado 	= dt_resultado_p,
		ie_urgencia 	= CASE WHEN ie_urgente_w='S' THEN 'S'  ELSE ie_urgencia END
	where  	nr_sequencia 	= nr_sequencia_p
	and    	nr_prescricao 	= nr_prescricao_p;

	if (vl_parametro_w = 'S')then
		begin
		CALL ajustar_entrega_lib_prescr(nm_usuario_p, nr_prescricao_p);
		end;
	end if;

	insert into log_atendimento(dt_atualizacao, nm_usuario, cd_log, ds_log, nr_atendimento)
			values (clock_timestamp(), nm_usuario_p, 7,substr(wheb_mensagem_pck.get_texto(796334) || ': ' || nr_prescricao_p || ' seq. : ' || nr_sequencia_p ,1,255),null);

	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_data_resultado_js ( nr_prescricao_p bigint, nr_sequencia_p bigint, dt_resultado_p timestamp, cd_perfil_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

