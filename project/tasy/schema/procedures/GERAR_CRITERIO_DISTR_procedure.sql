-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_criterio_distr ( cd_estab_p bigint, nr_seq_distribuicao_p bigint, nr_ano_referencia_p text, dt_mes_inicial_p timestamp, dt_mes_final_p timestamp) AS $body$
DECLARE


cd_sequencia_criterio_w	bigint;
cd_centro_controle_w		integer;
cd_centro_controle_dest_w	integer;
ie_data_ref_w			varchar(01);
pr_jan_w				double precision;
pr_fev_w				double precision;
pr_mar_w				double precision;
pr_abr_w				double precision;
pr_mai_w				double precision;
pr_jun_w				double precision;
pr_jul_w				double precision;
pr_ago_w				double precision;
pr_set_w				double precision;
pr_out_w				double precision;
pr_nov_w				double precision;
pr_dez_w				double precision;
pr_distribuicao_w		double precision;
qt_registro_w			integer;
qt_meses_qtdade_w		integer;
qt_jan_w			double precision;
qt_fev_w			double precision;
qt_mar_w			double precision;
qt_abr_w			double precision;
qt_mai_w			double precision;
qt_jun_w			double precision;
qt_jul_w			double precision;
qt_ago_w			double precision;
qt_set_w			double precision;
qt_out_w			double precision;
qt_nov_w			double precision;
qt_dez_w			double precision;
qt_distribuicao_w		double precision;
nr_seq_distribuicao_w	bigint;

C01 CURSOR FOR
	SELECT	cd_sequencia_criterio,
		cd_centro_controle,
		nr_seq_distribuicao
	from	criterio_distr_orc
	where	nr_seq_distribuicao	= coalesce(nr_seq_distribuicao_p, nr_seq_distribuicao)
	and	cd_estabelecimento	= coalesce(cd_estab_p,cd_estabelecimento);

C02 CURSOR FOR
SELECT	c.cd_centro_controle_dest,
	coalesce(CASE WHEN to_char(a.dt_mes_referencia, 'mm')='01' THEN sum(c.qt_distribuicao) END ,0),
	coalesce(CASE WHEN to_char(a.dt_mes_referencia, 'mm')='02' THEN sum(c.qt_distribuicao) END ,0),
	coalesce(CASE WHEN to_char(a.dt_mes_referencia, 'mm')='03' THEN sum(c.qt_distribuicao) END ,0),
	coalesce(CASE WHEN to_char(a.dt_mes_referencia, 'mm')='04' THEN sum(c.qt_distribuicao) END ,0),
	coalesce(CASE WHEN to_char(a.dt_mes_referencia, 'mm')='05' THEN sum(c.qt_distribuicao) END ,0),
	coalesce(CASE WHEN to_char(a.dt_mes_referencia, 'mm')='06' THEN sum(c.qt_distribuicao) END ,0),
	coalesce(CASE WHEN to_char(a.dt_mes_referencia, 'mm')='07' THEN sum(c.qt_distribuicao) END ,0),
	coalesce(CASE WHEN to_char(a.dt_mes_referencia, 'mm')='08' THEN sum(c.qt_distribuicao) END ,0),
	coalesce(CASE WHEN to_char(a.dt_mes_referencia, 'mm')='09' THEN sum(c.qt_distribuicao) END ,0),
	coalesce(CASE WHEN to_char(a.dt_mes_referencia, 'mm')='10' THEN sum(c.qt_distribuicao) END ,0),
	coalesce(CASE WHEN to_char(a.dt_mes_referencia, 'mm')='11' THEN sum(c.qt_distribuicao) END ,0),
	coalesce(CASE WHEN to_char(a.dt_mes_referencia, 'mm')='12' THEN sum(c.qt_distribuicao) END ,0),
	sum(c.qt_distribuicao) qt_distribuicao,
	coalesce(CASE WHEN to_char(a.dt_mes_referencia, 'mm')='01' THEN sum(c.pr_distribuicao) END ,0),
	coalesce(CASE WHEN to_char(a.dt_mes_referencia, 'mm')='02' THEN sum(c.pr_distribuicao) END ,0),
	coalesce(CASE WHEN to_char(a.dt_mes_referencia, 'mm')='03' THEN sum(c.pr_distribuicao) END ,0),
	coalesce(CASE WHEN to_char(a.dt_mes_referencia, 'mm')='04' THEN sum(c.pr_distribuicao) END ,0),
	coalesce(CASE WHEN to_char(a.dt_mes_referencia, 'mm')='05' THEN sum(c.pr_distribuicao) END ,0),
	coalesce(CASE WHEN to_char(a.dt_mes_referencia, 'mm')='06' THEN sum(c.pr_distribuicao) END ,0),
	coalesce(CASE WHEN to_char(a.dt_mes_referencia, 'mm')='07' THEN sum(c.pr_distribuicao) END ,0),
	coalesce(CASE WHEN to_char(a.dt_mes_referencia, 'mm')='08' THEN sum(c.pr_distribuicao) END ,0),
	coalesce(CASE WHEN to_char(a.dt_mes_referencia, 'mm')='09' THEN sum(c.pr_distribuicao) END ,0),
	coalesce(CASE WHEN to_char(a.dt_mes_referencia, 'mm')='10' THEN sum(c.pr_distribuicao) END ,0),
	coalesce(CASE WHEN to_char(a.dt_mes_referencia, 'mm')='11' THEN sum(c.pr_distribuicao) END ,0),
	coalesce(CASE WHEN to_char(a.dt_mes_referencia, 'mm')='12' THEN sum(c.pr_distribuicao) END ,0),
	sum(c.pr_distribuicao) pr_distribuicao
from	criterio_distr_orc_dest c,
	criterio_distr_orc b,
	tabela_custo a
where	c.cd_sequencia_criterio	= cd_sequencia_criterio_w
and	b.nr_seq_distribuicao	= nr_seq_distribuicao_w
and	a.cd_tabela_custo		= b.cd_tabela_custo
and	a.cd_empresa		= coalesce(obter_empresa_estab(cd_estab_p),a.cd_empresa)
and	coalesce(a.cd_estabelecimento, cd_estab_p)	= 	cd_estab_p
and	b.cd_sequencia_criterio	= c.cd_sequencia_criterio
and	((( ie_data_ref_w = 'A') and (to_char(a.dt_mes_referencia, 'yyyy') = nr_ano_referencia_p ))
or	(ie_data_ref_w = 'M' AND a.dt_mes_referencia between dt_mes_inicial_p and dt_mes_final_p ))
group by c.cd_centro_controle_dest, a.dt_mes_referencia;


BEGIN

if (nr_ano_referencia_p IS NOT NULL AND nr_ano_referencia_p::text <> '') then
	ie_data_ref_w		:= 'A';
else
	ie_data_ref_w		:= 'M';
end if;

delete from w_criterio_distr_orc;

OPEN C01;
LOOP
	FETCH C01 into
		cd_sequencia_criterio_w,
		cd_centro_controle_w,
		nr_seq_distribuicao_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	OPEN C02;
	LOOP


		FETCH C02 into
			cd_centro_controle_dest_w,
			qt_jan_w,
			qt_fev_w,
			qt_mar_w,
			qt_abr_w,
			qt_mai_w,
			qt_jun_w,
			qt_jul_w,
			qt_ago_w,
			qt_set_w,
			qt_out_w,
			qt_nov_w,
			qt_dez_w,
			qt_distribuicao_w,
			pr_jan_w,
			pr_fev_w,
			pr_mar_w,
			pr_abr_w,
			pr_mai_w,
			pr_jun_w,
			pr_jul_w,
			pr_ago_w,
			pr_set_w,
			pr_out_w,
			pr_nov_w,
			pr_dez_w,
			pr_distribuicao_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
		begin

		select	count(*)
		into STRICT	qt_registro_w
		from	w_criterio_distr_orc
		where	nr_seq_distribuicao		= nr_seq_distribuicao_w
		and	cd_centro_controle		= cd_centro_controle_w
		and	cd_centro_controle_dest	= cd_centro_controle_dest_w;

		if (qt_registro_w = 0) and ( qt_distribuicao_w > 0) then
			insert into w_criterio_distr_orc(
				nr_seq_distribuicao,
				cd_centro_controle,
				cd_centro_controle_dest,
				qt_jan,
				qt_fev,
				qt_mar,
				qt_abr,
				qt_mai,
				qt_jun,
				qt_jul,
				qt_ago,
				qt_set,
				qt_out,
				qt_nov,
				qt_dez,
				qt_distribuicao,
				pr_jan,
				pr_fev,
				pr_mar,
				pr_abr,
				pr_mai,
				pr_jun,
				pr_jul,
				pr_ago,
				pr_set,
				pr_out,
				pr_nov,
				pr_dez,
				pr_distribuicao)
			values (nr_seq_distribuicao_w,
				cd_centro_controle_w,
				cd_centro_controle_dest_w,
				coalesce(qt_jan_w,0),
				coalesce(qt_fev_w,0),
				coalesce(qt_mar_w,0),
				coalesce(qt_abr_w,0),
				coalesce(qt_mai_w,0),
				coalesce(qt_jun_w,0),
				coalesce(qt_jul_w,0),
				coalesce(qt_ago_w,0),
				coalesce(qt_set_w,0),
				coalesce(qt_out_w,0),
				coalesce(qt_nov_w,0),
				coalesce(qt_dez_w,0),
				coalesce(qt_distribuicao_w,0),
				coalesce(pr_jan_w,0),
				coalesce(pr_fev_w,0),
				coalesce(pr_mar_w,0),
				coalesce(pr_abr_w,0),
				coalesce(pr_mai_w,0),
				coalesce(pr_jun_w,0),
				coalesce(pr_jul_w,0),
				coalesce(pr_ago_w,0),
				coalesce(pr_set_w,0),
				coalesce(pr_out_w,0),
				coalesce(pr_nov_w,0),
				coalesce(pr_dez_w,0),
				coalesce(pr_distribuicao_w,0));
		else
			update	w_criterio_distr_orc
			set	qt_jan = qt_jan + coalesce(qt_jan_w,0),
				qt_fev = qt_fev + coalesce(qt_fev_w,0),
				qt_mar = qt_mar + coalesce(qt_mar_w,0),
				qt_abr = qt_abr + coalesce(qt_abr_w,0),
				qt_mai = qt_mai + coalesce(qt_mai_w,0),
				qt_jun = qt_jun + coalesce(qt_jun_w,0),
				qt_jul = qt_jul + coalesce(qt_jul_w,0),
				qt_ago = qt_ago + coalesce(qt_ago_w,0),
				qt_set = qt_set + coalesce(qt_set_w,0),
				qt_out = qt_out + coalesce(qt_out_w,0),
				qt_nov = qt_nov + coalesce(qt_nov_w,0),
				qt_dez = qt_dez + coalesce(qt_dez_w,0),
				qt_distribuicao = qt_distribuicao + coalesce(qt_distribuicao_w,0),
				pr_jan = pr_jan + coalesce(pr_jan_w,0),
				pr_fev = pr_fev + coalesce(pr_fev_w,0),
				pr_mar = pr_mar + coalesce(pr_mar_w,0),
				pr_abr = pr_abr + coalesce(pr_abr_w,0),
				pr_mai = pr_mai + coalesce(pr_mai_w,0),
				pr_jun = pr_jun + coalesce(pr_jun_w,0),
				pr_jul = pr_jul + coalesce(pr_jul_w,0),
				pr_ago = pr_ago + coalesce(pr_ago_w,0),
				pr_set = pr_set + coalesce(pr_set_w,0),
				pr_out = pr_out + coalesce(pr_out_w,0),
				pr_nov = pr_nov + coalesce(pr_nov_w,0),
				pr_dez = pr_dez + coalesce(pr_dez_w,0),
				pr_distribuicao = pr_distribuicao + coalesce(pr_distribuicao_w,0)
			where	nr_seq_distribuicao		= nr_seq_distribuicao_w
			and	cd_centro_controle		= cd_centro_controle_w
			and	cd_centro_controle_dest	= cd_centro_controle_dest_w;
		end if;
		commit;
		end;
	END LOOP;
	CLOSE C02;
	end;
END LOOP;
CLOSE C01;

/* Atualiza toda a tabela, fazendo a media dependendo da quantidade de meses */

update	w_criterio_distr_orc
set	qt_meses_qtdade =
	CASE WHEN qt_jan=0 THEN 0  ELSE 1 END  + CASE WHEN qt_fev=0 THEN 0  ELSE 1 END  + CASE WHEN qt_mar=0 THEN 0  ELSE 1 END  +
	CASE WHEN qt_abr=0 THEN 0  ELSE 1 END  + CASE WHEN qt_mai=0 THEN 0  ELSE 1 END  + CASE WHEN qt_jun=0 THEN 0  ELSE 1 END  +
	CASE WHEN qt_jul=0 THEN 0  ELSE 1 END  + CASE WHEN qt_ago=0 THEN 0  ELSE 1 END  + CASE WHEN qt_set=0 THEN 0  ELSE 1 END  +
	CASE WHEN qt_out=0 THEN 0  ELSE 1 END  + CASE WHEN qt_nov=0 THEN 0  ELSE 1 END  + CASE WHEN qt_dez=0 THEN 0  ELSE 1 END;

update	w_criterio_distr_orc
set	qt_meses_percent =
	CASE WHEN pr_jan=0 THEN 0  ELSE 1 END  + CASE WHEN pr_fev=0 THEN 0  ELSE 1 END  + CASE WHEN pr_mar=0 THEN 0  ELSE 1 END  +
	CASE WHEN pr_abr=0 THEN 0  ELSE 1 END  + CASE WHEN pr_mai=0 THEN 0  ELSE 1 END  + CASE WHEN pr_jun=0 THEN 0  ELSE 1 END  +
	CASE WHEN pr_jul=0 THEN 0  ELSE 1 END  + CASE WHEN pr_ago=0 THEN 0  ELSE 1 END  + CASE WHEN pr_set=0 THEN 0  ELSE 1 END  +
	CASE WHEN pr_out=0 THEN 0  ELSE 1 END  + CASE WHEN pr_nov=0 THEN 0  ELSE 1 END  + CASE WHEN pr_dez=0 THEN 0  ELSE 1 END;
commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_criterio_distr ( cd_estab_p bigint, nr_seq_distribuicao_p bigint, nr_ano_referencia_p text, dt_mes_inicial_p timestamp, dt_mes_final_p timestamp) FROM PUBLIC;

