-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_relat_vipe ( cd_perfil_p bigint, cd_estabelecimento_p bigint, nr_atendimento_p bigint, dt_referencia_p timestamp, ie_exibir_realizados_p text, ie_exibir_suspensos_p text, nm_usuario_p text) AS $body$
DECLARE


/*
PROCEDURE CRIADA COM BASE NA PACKAGE DA VIPE - VERSÃO 871
*/
cd_item_w						varchar(255);
ds_item_w						varchar(255);
ds_dosagem_w					varchar(255);
ds_prescricao_w					varchar(2000);
ie_data_lib_prescr_w			varchar(15);
ie_acm_sn_w						varchar(15);
ie_exibe_sem_lib_farm_w			varchar(15);
ie_considera_horario_w			varchar(15);
ie_utiliza_serv_w				varchar(15);
ie_exibe_dietas_w				varchar(15);
ie_agrupar_acm_sn_w				varchar(15);
ie_agrupa_item_igual_w			varchar(15);
ie_agrupa_coletas_w				varchar(15);
ie_mostrar_subs_w				varchar(15);
ie_agrupar_dose_esp_w			varchar(15);
ie_agrupar_associados_w			varchar(15);
qt_horas_anteriores_w			bigint := 0;
qt_horas_adicionais_w			bigint := 0;
qt_horas_vigencia_w				bigint := 0;
nr_prescricao_w					bigint;
nr_seq_item_w					bigint;
cd_setor_usuario_w				integer;
dt_fim_w						timestamp;
dt_validade_limite_w			timestamp;
dt_inicial_horarios_w			timestamp;
dt_final_horarios_w				timestamp;
ie_regra_incl_dieta_oral_w		varchar(15)	:= 'S';
ie_regra_incl_supl_oral_w		varchar(15)	:= 'S';
ie_regra_incl_solucao_w			varchar(15)	:= 'S';
ie_regra_incl_dialise_w			varchar(15)	:= 'S';
ie_regra_incl_medicamento_w		varchar(15)	:= 'S';
ie_regra_incl_material_w		varchar(15)	:= 'S';
ie_regra_incl_procedimento_w	varchar(15)	:= 'S';
ie_regra_incl_coleta_w			varchar(15)	:= 'S';
ie_regra_incl_ccg_w				varchar(15)	:= 'S';
ie_regra_incl_cig_w				varchar(15)	:= 'S';
ie_regra_incl_recomendacao_w	varchar(15)	:= 'S';
ie_regra_incl_intervencao_w		varchar(15)	:= 'S';
ie_regra_incl_ivc_w				varchar(15)	:= 'S';
ie_regra_incl_gas_w				varchar(15)	:= 'S';
ie_regra_incl_hemoterapia_w		varchar(15)	:= 'S';
ie_regra_incl_sne_w				varchar(15)	:= 'S';
ie_regra_incl_npt_adulta_w		varchar(15)	:= 'S';
ie_regra_incl_npt_neonatal_w	varchar(15)	:= 'S';
ie_regra_incl_jejum_w			varchar(15)	:= 'S';
ds_horarios_w					varchar(4000);
ds_enfermagem_w					varchar(4000);

C00 CURSOR FOR  --Regras de inclusão
SELECT	coalesce(ie_dieta_oral,'S'),
	coalesce(ie_suplemento_oral,'S'),
	coalesce(ie_solucao,'S'),
	coalesce(ie_dialise,'S'),
	coalesce(ie_medicamento,'S'),
	coalesce(ie_material,'R'),
	coalesce(ie_procedimento,'S'),
	coalesce(ie_coleta,'S'),
	coalesce(ie_ccg,'S'),
	coalesce(ie_cig,'S'),
	coalesce(ie_recomendacao,'S'),
	coalesce(ie_sae,'S'),
	coalesce(ie_ivc,'N'),
	coalesce(ie_oxigenio,'N'),
	coalesce(ie_hemoterapia,'N'),
	coalesce(ie_sup_nutricional,'N'),
	coalesce(ie_npt_adulta,'N'),
	coalesce(ie_npt_neonatal,'N')
from	adep_regra_inclusao
where	cd_estabelecimento				= cd_estabelecimento_p
and	coalesce(cd_setor_atendimento,cd_setor_usuario_w)	= cd_setor_usuario_w
and	coalesce(cd_perfil,cd_perfil_p)			= cd_perfil_p
order by
	coalesce(cd_setor_atendimento,99999) desc,
	coalesce(cd_perfil,99999) desc,
	nr_sequencia;

C01 CURSOR FOR  --Jejum
SELECT	to_char(c.dt_inicio,'dd/mm/yyyy hh24:mi:ss') || '-' || to_char(c.dt_fim,'dd/mm/yyyy hh24:mi:ss') cd_jejum,
	x.ds_tipo ds_jejum,
	obter_desc_expressao(301700)%ORA2PG_COMMENT492901(|': '|| to_char(c.dt_inicio,'dd/mm/yyyy hh24:mi:ss') || ' à ' || to_char(c.dt_fim,'dd/mm/yyyy hh24:mi:ss') ds_vigencia
from	rep_tipo_jejum x,
	rep_jejum c,
	prescr_medica a
where	x.nr_sequencia = c.nr_seq_tipo
and	c.nr_prescricao = a.nr_prescricao
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
and	coalesce(a.dt_suspensao::text, '') = ''
and	((obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S') or
	((ie_exibe_sem_lib_farm_w = 'S') and (coalesce(a.ie_prescr_nutricao, 'N') = 'S')))
and	(((c.dt_inicio between dt_inicial_horarios_w and dt_final_horarios_w) or
	 ((ie_considera_horario_w = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S'))))
and	((ie_exibir_suspensos_p = 'S') or (coalesce(c.ie_suspenso,'N') = 'N'))
group by
	c.dt_inicio,
	c.dt_fim,
	x.ds_tipo;

C02 CURSOR FOR  --Dieta Oral
SELECT	to_char(d.cd_dieta),
	x.nm_dieta,
	substr(obter_desc_intervalo_prescr(d.cd_intervalo),1,15) ds_intervalo
from	dieta x,
	prescr_dieta d,
	prescr_dieta_hor c,
	prescr_medica a
where	x.cd_dieta = d.cd_dieta
and	d.nr_prescricao = c.nr_prescricao
and	d.nr_prescricao	= a.nr_prescricao
and	c.nr_prescricao = a.nr_prescricao
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
and	coalesce(a.dt_suspensao::text, '') = ''
and	obter_se_prescr_lib_vipe(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w,c.dt_lib_horario) = 'S'
and	((ie_exibir_suspensos_p = 'S') or (coalesce(d.dt_suspensao::text, '') = ''))
and	coalesce(c.ie_situacao,'A') = 'A'
and	c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w
and	((ie_exibir_realizados_p = 'S') or (coalesce(c.dt_fim_horario::text, '') = ''))
and	((ie_exibir_suspensos_p = 'S') or (coalesce(c.dt_suspensao::text, '') = ''))
and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
and	((ie_data_lib_prescr_w = 'M') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'))
group by
	d.cd_dieta,
	x.nm_dieta,
	CASE WHEN coalesce(d.ds_observacao::text, '') = '' THEN null  ELSE 'S' END ,
	c.dt_fim_horario,
	d.dt_suspensao,
	d.cd_intervalo

union

select	to_char(d.cd_dieta),
	x.nm_dieta,
	substr(obter_desc_intervalo_prescr(d.cd_intervalo),1,15) ds_intervalo
from	dieta x,
	prescr_dieta d,
	prescr_medica a
where	x.cd_dieta = d.cd_dieta
and	d.nr_prescricao	= a.nr_prescricao
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
and	coalesce(a.dt_suspensao::text, '') = ''
and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
and	((ie_exibir_suspensos_p = 'S') or (coalesce(d.dt_suspensao::text, '') = ''))
and	((a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '') or (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
and	a.dt_inicio_prescr between dt_inicial_horarios_w and dt_final_horarios_w
and	not exists (
		SELECT	1
		from	prescr_dieta_hor c
		where	c.nr_prescricao = d.nr_prescricao
		and	c.nr_prescricao = a.nr_prescricao
		and	((ie_data_lib_prescr_w = 'M') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S')))
and	ie_exibe_dietas_w = 'S'
group by
	d.cd_dieta,
	x.nm_dieta,
	CASE WHEN coalesce(d.ds_observacao::text, '') = '' THEN null  ELSE 'S' END ,
	d.dt_suspensao,
	d.cd_intervalo;

C03 CURSOR FOR  --Suplemento Oral
SELECT	CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_material,ie_agrupar_acm_sn_w)='N' THEN  nr_prescricao  ELSE null END   ELSE null END ,
	CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_material,ie_agrupar_acm_sn_w)='N' THEN  nr_seq_material  ELSE null END   ELSE null END ,
	cd_material,
	ds_material,
	qt_dose || ' ' || cd_unidade_medida_dose,
	ds_intervalo || ' - Via: ' || ie_via_aplicacao,
	ds_horarios
from	(
	SELECT	a.nr_prescricao,
		c.nr_seq_material,
		c.cd_material,
		y.ds_material,
		obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) ie_acm_sn,
		x.cd_intervalo,
		x.qt_dose,
		substr(adep_obter_um_dosagem_prescr(a.nr_prescricao,c.nr_seq_material,x.ie_acm,x.ie_se_necessario),1,100) ds_prescricao,
		x.cd_unidade_medida_dose,
		x.ie_via_aplicacao,
		substr(obter_desc_intervalo_prescr(x.cd_intervalo),1,15) ds_intervalo,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'S', 'S', 'S', nm_usuario_p) ds_horarios
	FROM material y, prescr_material x, prescr_medica a, prescr_mat_hor c
LEFT OUTER JOIN nut_atend_serv_dia s ON (c.nr_sequencia = s.nr_seq_horario)
WHERE y.cd_material = x.cd_material and y.cd_material = c.cd_material and x.nr_prescricao = c.nr_prescricao and x.nr_sequencia = c.nr_seq_material and x.nr_prescricao = a.nr_prescricao and c.nr_prescricao = a.nr_prescricao  and Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S' and a.nr_atendimento = nr_atendimento_p and a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w and coalesce(a.dt_suspensao::text, '') = '' and ((obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S') or
		((ie_exibe_sem_lib_farm_w = 'S') and (coalesce(a.ie_prescr_nutricao, 'N') = 'S'))) and ((ie_utiliza_serv_w <> 'S') or (s.nr_seq_horario IS NOT NULL AND s.nr_seq_horario::text <> '')) and x.ie_agrupador = 12 and ((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = '')) and (((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'N') and (c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w)) or
		 ((ie_considera_horario_w = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')) or
		 ((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S'))) and coalesce(c.ie_situacao,'A') = 'A' and c.ie_agrupador = 12 and ((ie_exibir_realizados_p = 'S') or (coalesce(c.dt_fim_horario::text, '') = '')) and ((ie_exibir_suspensos_p = 'S') or (coalesce(c.dt_suspensao::text, '') = '')) and ((ie_regra_incl_supl_oral_w = 'S') or
		 ((ie_regra_incl_supl_oral_w = 'R') and (adep_obter_regra_inclusao(	'SO',
																			cd_estabelecimento_p,
																			cd_setor_usuario_w,
																			cd_perfil_p,
																			c.cd_material,
																			null,
																			null,
																			null,
																			a.cd_setor_atendimento,
																			null,
																			null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
																			null) = 'S')))  -- nr_seq_exame_p
  and ((ie_data_lib_prescr_w = 'M') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S')) group by
		a.nr_prescricao,
		c.nr_seq_material,
		c.cd_material,
		y.ds_material,
		x.ie_acm,
		x.ie_se_necessario,
		x.cd_intervalo,
		x.qt_dose,
		x.cd_unidade_medida_dose,
		x.ie_via_aplicacao,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'S', 'S', 'S', nm_usuario_p)
	) alias58
group by
	CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_material,ie_agrupar_acm_sn_w)='N' THEN  nr_prescricao  ELSE null END   ELSE null END ,
	CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_material,ie_agrupar_acm_sn_w)='N' THEN  nr_seq_material  ELSE null END   ELSE null END ,
	cd_material,
	ds_material,
	qt_dose || ' ' || cd_unidade_medida_dose,
	ds_intervalo || ' - Via: ' || ie_via_aplicacao,
	ds_horarios;

C04 CURSOR FOR  --Soluções
SELECT	nr_prescricao,
	nr_seq_solucao,
	ds_solucao,
	qt_solucao_total || ' ' || ie_tipo_dosagem,
	ds_intervalo || ' Via: ' || ie_via_aplicacao,
	ds_horarios
from	(
	SELECT	a.nr_prescricao,
		x.nr_seq_solucao,
		substr(coalesce(x.ds_solucao,obter_prim_comp_sol(a.nr_prescricao,x.nr_seq_solucao)),1,240) ds_solucao,
		obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) ie_acm_sn,
		substr(obter_desc_vol_etapa_adep2(a.nr_prescricao,x.nr_seq_solucao,x.ie_acm,x.ie_se_necessario),1,240) ds_prescricao,
		substr(obter_componentes_solucao(a.nr_prescricao,x.nr_seq_solucao,'S',nm_usuario_p,cd_estabelecimento_p),1,240) ds_componentes,
		substr(obter_status_solucao_prescr(1,a.nr_prescricao,x.nr_seq_solucao),1,3) ie_status_solucao,
		coalesce(x.ie_suspenso,'N') ie_suspenso,
		x.dt_prev_prox_etapa,
		x.ie_tipo_dosagem,
		x.ie_via_aplicacao,
		x.qt_solucao_total,
		substr(obter_interv_solucao_vipe(x.ie_acm,x.ie_se_necessario,x.ie_urgencia,x.nr_etapas,x.qt_hora_fase) || CASE WHEN coalesce(x.ie_classif_agora::text, '') = '' THEN ''  ELSE ' - ' END  || obter_desc_intervalo(x.ie_classif_agora),1,240) ds_intervalo,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_seq_solucao, dt_referencia_p, 'SOL', 'S', 'S', nm_usuario_p) ds_horarios
	from	prescr_solucao x,
		prescr_medica a
	where	x.nr_prescricao = a.nr_prescricao
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
	and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
	and	coalesce(x.nr_seq_dialise::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(x.ie_hemodialise,'N') = 'N'
	and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
	and	((x.ie_status in ('I','INT')) or
		 ((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'N') and (x.dt_status between dt_inicial_horarios_w and dt_final_horarios_w)) or
		 ((ie_considera_horario_w = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')) or
		 ((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')))
	and	((ie_exibir_realizados_p = 'S') or (x.ie_status <> 'T'))
	and	obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S'
	and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
	and	((ie_regra_incl_solucao_w = 'S') or
		 ((ie_regra_incl_solucao_w = 'R') and (adep_obter_regra_inclusao(	'SOL',
																			cd_estabelecimento_p,
																			cd_setor_usuario_w,
																			cd_perfil_p,
																			null,
																			null,
																			null,
																			null,
																			a.cd_setor_atendimento,
																			null,
																			null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
																			null) = 'S'))) -- nr_seq_exame_p
	group by
		a.nr_prescricao,
		x.nr_seq_solucao,
		x.ds_solucao,
		x.ie_acm,
		x.ie_se_necessario,
		nm_usuario_p,
		cd_estabelecimento_p,
		obter_desc_intervalo(x.ie_classif_agora),
		x.ie_suspenso,
		x.dt_prev_prox_etapa,
		x.ie_tipo_dosagem,
		x.ie_via_aplicacao,
		x.qt_solucao_total,
		CASE WHEN coalesce(x.ie_classif_agora::text, '') = '' THEN ''  ELSE ' - ' END ,
		x.ie_urgencia,
		x.nr_etapas,
		x.qt_hora_fase,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_seq_solucao, dt_referencia_p, 'SOL', 'S', 'S', nm_usuario_p)
	) alias54
group by
	nr_prescricao,
	nr_seq_solucao,
	ds_solucao,
	ie_acm_sn,
	ds_componentes,
	ie_status_solucao,
	null,
	dt_prev_prox_etapa,
	ie_tipo_dosagem,
	ie_via_aplicacao,
	qt_solucao_total,
	ds_intervalo,
	ds_horarios;

C05 CURSOR FOR  --Suporte Nutricional Enteral
SELECT	nr_prescricao,
	nr_seq_material,
	cd_material,
	ds_material,
	ds_intervalo || ' Via: ' || ie_via_aplicacao,
	qt_dose || ' ' || cd_unidade_medida_dose,
	ds_horarios
from	(
	SELECT	null nr_prescricao,
		null nr_seq_material,
		x.cd_material,
		y.ds_material,
		obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) ie_acm_sn,
		x.cd_intervalo,
		x.qt_dose,
		substr(adep_obter_um_dosagem_prescr(a.nr_prescricao,x.nr_sequencia,x.ie_acm,x.ie_se_necessario),1,100) ds_prescricao,
		substr(obter_status_solucao_prescr(2,a.nr_prescricao,x.nr_sequencia),1,3) ie_status_solucao,
		coalesce(x.ie_suspenso,'N') ie_suspenso,
		x.cd_unidade_medida_dose,
		x.ie_via_aplicacao,
		substr(obter_desc_intervalo_prescr(x.cd_intervalo),1,15) ds_intervalo,
		CASE WHEN coalesce(coalesce(x.ds_observacao,x.ds_observacao_enf)::text, '') = '' THEN null  ELSE 'S' END  ie_observacao,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'SNE', 'S', 'S', nm_usuario_p) ds_horarios
	FROM material y, prescr_mat_hor c, prescr_medica a, prescr_material x
LEFT OUTER JOIN nut_atend_serv_dia s ON (x.nr_prescricao = s.nr_prescricao AND x.nr_sequencia = s.nr_Seq_material)
WHERE y.cd_material = x.cd_material and x.nr_prescricao = a.nr_prescricao and c.nr_prescricao = a.nr_prescricao and x.nr_sequencia	= c.nr_seq_material   and a.nr_atendimento = nr_atendimento_p and Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S' and x.ie_agrupador = 8 and a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w and coalesce(a.dt_suspensao::text, '') = '' and (ie_utiliza_serv_w <> 'S' or (s.nr_prescricao IS NOT NULL AND s.nr_prescricao::text <> '' AND s.nr_Seq_material IS NOT NULL AND s.nr_Seq_material::text <> '')) and ((obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S') or
		((ie_exibe_sem_lib_farm_w = 'S') and (coalesce(a.ie_prescr_nutricao, 'N') = 'S'))) and coalesce(c.ie_situacao,'A') = 'A' and coalesce(c.ie_adep,'S') = 'S' and ((ie_data_lib_prescr_w = 'M') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S')) and ((x.ie_status in ('I','INT')) or
		 ((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'N') and (c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w)) or
		 ((ie_considera_horario_w = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')) or
		 ((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S'))) and ((ie_exibir_realizados_p = 'S') or (x.ie_status <> 'T')) and ((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = '')) and ((ie_regra_incl_sne_w = 'S') or
		 ((ie_regra_incl_sne_w = 'R') and (adep_obter_regra_inclusao(	'SNE',
																		cd_estabelecimento_p,
																		cd_setor_usuario_w,
																		cd_perfil_p,
																		x.cd_material,
																		null,
																		null,
																		null,
																		a.cd_setor_atendimento,
																		null,
																		null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
																		null) = 'S')))  -- nr_seq_exame_p
 group by
		a.nr_prescricao,
		x.nr_sequencia,
		x.cd_material,
		y.ds_material,
		CASE WHEN coalesce(coalesce(x.ds_observacao,x.ds_observacao_enf)::text, '') = '' THEN null  ELSE 'S' END ,
		x.ie_acm,
		x.ie_se_necessario,
		x.cd_intervalo,
		x.qt_dose,
		x.ie_suspenso,
		x.cd_unidade_medida_dose,
		x.ie_via_aplicacao,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'SNE', 'S', 'S', nm_usuario_p)
	) alias60
group by
	nr_prescricao,
	nr_seq_material,
	cd_material,
	ds_material,
	ds_intervalo || ' Via: ' || ie_via_aplicacao,
	qt_dose || ' ' || cd_unidade_medida_dose,
	ds_horarios;

C06 CURSOR FOR  --NPT Adulta
SELECT	nr_prescricao,
	nr_seq_npt,
	ds_npt,
	ds_intervalo,
	QT_VOLUME_DIARIO || ' ml',
	ds_horarios
from	(
	SELECT	a.nr_prescricao,
		x.nr_sequencia nr_seq_npt,
		CASE WHEN x.ie_forma='P' THEN  'Protocolo ' || y.ds_npt  ELSE obter_valor_dominio(1988,x.ie_forma) END  ds_npt,
		substr(obter_status_solucao_prescr(6,a.nr_prescricao,x.nr_sequencia),1,3) ie_status_solucao,
		(x.QT_FASE_NPT || ' Fase(s)') ds_intervalo,
		x.QT_VOLUME_DIARIO,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'NAN', 'S', 'S', nm_usuario_p) ds_horarios
	FROM prescr_medica a, nut_pac x
LEFT OUTER JOIN protocolo_npt y ON (x.nr_seq_protocolo = y.nr_sequencia)
WHERE x.nr_prescricao = a.nr_prescricao and a.nr_atendimento = nr_atendimento_p and a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w and obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S' and x.ie_npt_adulta = 'S' and Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S' and coalesce(a.dt_suspensao::text, '') = '' and ((x.ie_status in ('I','INT')) or
		 ((obter_se_acm_sn(null,null) = 'N') and (x.dt_status between dt_inicial_horarios_w and dt_final_horarios_w)) or
		 ((ie_considera_horario_w = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')) or
		 ((obter_se_acm_sn(null,null) = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S'))) and ((ie_exibir_realizados_p = 'S') or (x.ie_status <> 'T')) and ((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = '')) and ((ie_regra_incl_npt_adulta_w = 'S') or
		 ((ie_regra_incl_npt_adulta_w = 'R') and (adep_obter_regra_inclusao(	'NAN',
																				cd_estabelecimento_p,
																				cd_setor_usuario_w,
																				cd_perfil_p,
																				null,
																				null,
																				null,
																				null,
																				a.cd_setor_atendimento,
																				null,
																				null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
																				null) = 'S')))  -- nr_seq_exame_p
 group by
		a.nr_prescricao,
		x.nr_sequencia,
		x.ie_forma,
		x.QT_VOLUME_DIARIO,
		(x.QT_FASE_NPT || ' Fase(s)'),
		y.ds_npt,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'NAN', 'S', 'S', nm_usuario_p)
	) alias39
group by
	nr_prescricao,
	nr_seq_npt,
	ds_npt,
	ds_intervalo,
	QT_VOLUME_DIARIO || ' ml',
	ds_horarios;

C07 CURSOR FOR  --NPT Neonatal
SELECT	nr_prescricao,
	nr_seq_npt,
	ds_npt
from	(
	SELECT	a.nr_prescricao,
		x.nr_sequencia nr_seq_npt,
		'NPT Neonatal ' || x.hr_prim_horario ds_npt,
		substr(obter_status_solucao_prescr(5,a.nr_prescricao,x.nr_sequencia),1,3) ie_status_solucao
	from	nut_pac x,
		prescr_medica a
	where	x.nr_prescricao = a.nr_prescricao
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
	and	x.ie_npt_adulta <> 'S'
	and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
	and	((x.ie_status in ('I','INT')) or
		 ((obter_se_acm_sn(null,null) = 'N') and (x.dt_status between dt_inicial_horarios_w and dt_final_horarios_w)) or
		 ((ie_considera_horario_w = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')) or
		 ((obter_se_acm_sn(null,null) = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')))
	and	((ie_exibir_realizados_p = 'S') or (x.ie_status <> 'T'))
	and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
	and	((ie_regra_incl_npt_neonatal_w = 'S') or
		 ((ie_regra_incl_npt_neonatal_w = 'R') and (adep_obter_regra_inclusao(	'NPN',
																				cd_estabelecimento_p,
																				cd_setor_usuario_w,
																				cd_perfil_p,
																				null,
																				null,
																				null,
																				null,
																				a.cd_setor_atendimento,
																				null,
																				null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
																				null) = 'S'))) -- nr_seq_exame_p
	group by
		a.nr_prescricao,
		x.nr_sequencia,
		x.hr_prim_horario
	) alias34
group by
	nr_prescricao,
	nr_seq_npt,
	ds_npt;

C08 CURSOR FOR  --Hemoterapias
SELECT	nr_prescricao,
	nr_seq_procedimento,
	cd_procedimento,
	ds_procedimento,
	'Qtde: ' || qt_procedimento,
	ds_intervalo,
	ds_horarios
from	(
	SELECT	a.nr_prescricao,
		x.nr_sequencia nr_seq_procedimento,
		x.cd_procedimento,
		z.ds_derivado ds_procedimento,
		obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) ie_acm_sn,
		x.cd_intervalo,
		x.qt_procedimento,
		substr(adep_obter_dados_prescr_proc(a.nr_prescricao,x.nr_sequencia,'QIL','S',x.ie_acm,x.ie_se_necessario),1,100) ds_prescricao,
		substr(obter_status_solucao_prescr(3,a.nr_prescricao,x.nr_sequencia),1,3) ie_status_solucao,
		coalesce(x.ie_suspenso,'N') ie_suspenso,
		coalesce(x.nr_seq_proc_interno,0) nr_seq_proc_interno,
		'P' ie_classif_adep,
		x.nr_seq_lab,
		substr(obter_desc_intervalo_prescr(x.cd_intervalo),1,15) ds_intervalo,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'HM', 'S', 'S', nm_usuario_p) ds_horarios
	from	san_derivado z,
		procedimento y,
		prescr_procedimento x,
		prescr_medica a
	where	z.nr_sequencia = x.nr_seq_derivado
	and	y.cd_procedimento = x.cd_procedimento
	and	y.ie_origem_proced = x.ie_origem_proced
	and	x.nr_prescricao = a.nr_prescricao
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
	and	coalesce(x.nr_seq_proc_interno::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(x.nr_seq_exame::text, '') = ''
	and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
	and	(x.nr_seq_solic_sangue IS NOT NULL AND x.nr_seq_solic_sangue::text <> '')
	and	(x.nr_seq_derivado IS NOT NULL AND x.nr_seq_derivado::text <> '')
	and	coalesce(x.nr_seq_exame_sangue::text, '') = ''
	and	((x.ie_status in ('I','INT')) or
		 ((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'N') and (coalesce(x.dt_status,x.dt_prev_execucao) between dt_inicial_horarios_w and dt_final_horarios_w)) or
		 ((ie_considera_horario_w = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')) or
		 ((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')))
	and	((ie_exibir_realizados_p = 'S') or (x.ie_status <> 'T'))
	and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
	and	((ie_regra_incl_hemoterapia_w = 'S') or
		 ((ie_regra_incl_hemoterapia_w = 'R') and (adep_obter_regra_inclusao(	'HM',
																				cd_estabelecimento_p,
																				cd_setor_usuario_w,
																				cd_perfil_p,
																				null,
																				x.cd_procedimento,
																				x.ie_origem_proced,
																				x.nr_seq_proc_interno,
																				a.cd_setor_atendimento,
																				x.cd_setor_atendimento,
																				null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
																				x.nr_seq_exame) = 'S'))) -- nr_seq_exame_p
	group by
		a.nr_prescricao,
		x.nr_sequencia,
		x.cd_procedimento,
		z.ds_derivado,
		x.ie_acm,
		x.ie_se_necessario,
		x.cd_intervalo,
		x.qt_procedimento,
		x.ie_suspenso,
		x.nr_seq_proc_interno,
		'P',
		x.nr_seq_lab,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'HM', 'S', 'S', nm_usuario_p)
	
union all

	select	a.nr_prescricao,
		x.nr_sequencia,
		x.cd_procedimento,
		z.ds_derivado ds_procedimento,
		obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) ie_acm_sn,
		x.cd_intervalo,
		x.qt_procedimento,
		substr(adep_obter_dados_prescr_proc(a.nr_prescricao,x.nr_sequencia,'QIL','S',x.ie_acm,x.ie_se_necessario),1,100) ds_prescricao,
		substr(obter_status_solucao_prescr(3,a.nr_prescricao,x.nr_sequencia),1,3) ie_status_solucao,
		coalesce(x.ie_suspenso,'N') ie_suspenso,
		x.nr_seq_proc_interno,
		w.ie_classif_adep,
		x.nr_seq_lab,
		substr(obter_desc_intervalo_prescr(x.cd_intervalo),1,15) ds_intervalo,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'HM', 'S', 'S', nm_usuario_p) ds_horarios
	from	san_derivado z,
		procedimento y,
		proc_interno w,
		prescr_procedimento x,
		prescr_medica a
	where	z.nr_sequencia = x.nr_seq_derivado
	and	y.cd_procedimento = x.cd_procedimento
	and	y.ie_origem_proced = x.ie_origem_proced
	and	w.nr_sequencia = x.nr_seq_proc_interno
	and	x.nr_prescricao = a.nr_prescricao
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
	and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
	and	w.ie_tipo <> 'G'
	and	w.ie_tipo <> 'BS'
	and	coalesce(w.ie_ivc,'N') <> 'S'
	and	coalesce(w.ie_ctrl_glic,'NC') = 'NC'
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	(x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '')
	and	coalesce(x.nr_seq_prot_glic::text, '') = ''
	and	coalesce(x.nr_seq_exame::text, '') = ''
	and	(x.nr_seq_solic_sangue IS NOT NULL AND x.nr_seq_solic_sangue::text <> '')
	and	(x.nr_seq_derivado IS NOT NULL AND x.nr_seq_derivado::text <> '')
	and	coalesce(x.nr_seq_exame_sangue::text, '') = ''
	and	((x.ie_status in ('I','INT')) or
		 ((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'N') and (coalesce(x.dt_status,x.dt_prev_execucao) between dt_inicial_horarios_w and dt_final_horarios_w)) or
		 ((ie_considera_horario_w = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')) or
		 ((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')))
	and	((ie_exibir_realizados_p = 'S') or (x.ie_status <> 'T'))
	and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
	and	((ie_regra_incl_hemoterapia_w = 'S') or
		 ((ie_regra_incl_hemoterapia_w = 'R') and (adep_obter_regra_inclusao(	'HM',
																				cd_estabelecimento_p,
																				cd_setor_usuario_w,
																				cd_perfil_p,
																				null,
																				x.cd_procedimento,
																				x.ie_origem_proced,
																				x.nr_seq_proc_interno,
																				a.cd_setor_atendimento,
																				x.cd_setor_atendimento,
																				null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
																				x.nr_seq_exame) = 'S'))) -- nr_seq_exame_p
	group by
		a.nr_prescricao,
		x.nr_sequencia,
		x.cd_procedimento,
		z.ds_derivado,
		x.ie_acm,
		x.ie_se_necessario,
		x.cd_intervalo,
		x.qt_procedimento,
		x.ie_suspenso,
		x.nr_seq_proc_interno,
		w.ie_classif_adep,
		x.nr_seq_lab,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'HM', 'S', 'S', nm_usuario_p)
	) alias98
group by
	nr_prescricao,
	nr_seq_procedimento,
	cd_procedimento,
	ds_procedimento,
	'Qtde: ' || qt_procedimento,
	ds_intervalo,
	ds_horarios;

C09 CURSOR FOR  --Medicamentos
SELECT	CASE WHEN ie_agrupar='N' THEN  nr_prescricao  ELSE CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_material,ie_agrupar_acm_sn_w)='N' THEN  nr_prescricao END  END  END ,
	CASE WHEN ie_agrupar='N' THEN  nr_seq_material  ELSE CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_material,ie_agrupar_acm_sn_w)='N' THEN  nr_seq_material END  END  END ,
	cd_material,
	ds_material,
	qt_dose || ' ' || cd_unidade_medida_dose,
	ds_intervalo || ' Via: ' || ie_via_aplicacao,
	ds_horarios
from	(
	SELECT	a.nr_prescricao,
		c.nr_seq_material,
		c.cd_material,
		VIPE_obter_se_medic_composto(a.nr_prescricao, x.nr_sequencia, x.nr_agrupamento, 'D') ds_material,
		obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) ie_acm_sn,
		x.cd_intervalo,
		vipe_obter_dose_composto(a.nr_prescricao, x.nr_sequencia, x.nr_agrupamento) qt_dose,
		CASE WHEN obter_se_agrupa_composto(a.nr_prescricao,c.nr_seq_material,x.nr_agrupamento,c.cd_material)='S' THEN x.nr_agrupamento  ELSE 0 END  nr_agrupamento,
		substr(adep_obter_um_dosagem_prescr(a.nr_prescricao,c.nr_seq_material,x.ie_acm,x.ie_se_necessario),1,100) ds_prescricao,
		CASE WHEN obter_se_acm_sn(x.ie_acm,x.ie_se_necessario)='S' THEN substr(adep_obter_inf_dil_obs(a.nr_prescricao,c.nr_seq_material),1,2000)  ELSE null END  ds_dil_obs,
		coalesce(x.ie_suspenso,'N') ie_suspenso,
		x.cd_unidade_medida_dose,
		x.ie_via_aplicacao,
		CASE WHEN x.ie_acm='S' THEN 'ACM '  ELSE CASE WHEN x.ie_se_necessario='S' THEN 'SN '  ELSE '' END  END  || substr(coalesce(obter_desc_intervalo_prescr(x.cd_intervalo),x.cd_intervalo),1,15) ds_intervalo,
		coalesce(x.qt_total_dias_lib,0) qt_total_dias_lib,
		VIPE_obter_se_medic_composto(a.nr_prescricao, x.nr_sequencia, x.nr_agrupamento, 'P') ie_composto,
		x.ds_dose_diferenciada,
		VIPE_obter_se_agrupa_item(ie_agrupa_item_igual_w, 'M', a.nr_atendimento, c.nr_sequencia, c.nr_prescricao, x.qt_dose, x.cd_intervalo, c.dt_horario, c.cd_material, x.nr_sequencia, a.dt_inicio_prescr, a.dt_validade_prescr) ie_agrupar,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'M', 'S', 'S', nm_usuario_p) ds_horarios
	from	material y,
		prescr_material x,
		prescr_mat_hor c,
		prescr_medica a
	where	y.cd_material = x.cd_material
	and	x.nr_prescricao = c.nr_prescricao
	and	x.nr_sequencia = c.nr_seq_material
	and	x.nr_prescricao = a.nr_prescricao
	and	c.nr_prescricao = a.nr_prescricao
	and	a.nr_atendimento = nr_atendimento_p
	and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
	and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	obter_se_prescr_lib_vipe(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w, c.dt_lib_horario) = 'S'
	and	x.ie_agrupador = 1
	and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
	and	obter_se_gerar_item_vipe('M',a.nr_prescricao,c.nr_seq_material,x.nr_agrupamento) = 'S'
	and	coalesce(c.ie_situacao,'A') = 'A'
	and	coalesce(c.ie_adep,'S') = 'S'
	and	((ie_mostrar_subs_w	= 'S') or (coalesce(x.nr_seq_substituto::text, '') = ''))
	and	c.ie_agrupador = 1
	and	((ie_agrupar_dose_esp_w = 'S') or (coalesce(c.ie_dose_especial,'N') = 'N'))
	and	(((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'N') and (c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w)) or
		 ((ie_considera_horario_w = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')) or
		 ((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')))
	and	((ie_exibir_realizados_p = 'S') or (coalesce(c.dt_fim_horario::text, '') = ''))
	and	((ie_exibir_suspensos_p = 'S') or (coalesce(c.dt_suspensao::text, '') = ''))
	and	((ie_regra_incl_medicamento_w = 'S') or
		 ((ie_regra_incl_medicamento_w = 'R') and (adep_obter_regra_inclusao(	'MED',
																				cd_estabelecimento_p,
																				cd_setor_usuario_w,
																				cd_perfil_p,
																				c.cd_material,
																				null,
																				null,
																				null,
																				a.cd_setor_atendimento,
																				null,
																				null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
																				null) = 'S'))) -- nr_seq_exame_p
	and	((ie_data_lib_prescr_w = 'M') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'))
	group by
		a.nr_prescricao,
		c.nr_seq_material,
		c.cd_material,
		VIPE_obter_se_medic_composto(a.nr_prescricao, x.nr_sequencia, x.nr_agrupamento, 'D'),
		x.ie_acm,
		VIPE_obter_se_agrupa_item(ie_agrupa_item_igual_w, 'M', a.nr_atendimento, c.nr_sequencia, c.nr_prescricao, x.qt_dose, x.cd_intervalo, c.dt_horario, c.cd_material, x.nr_sequencia, a.dt_inicio_prescr, a.dt_validade_prescr),
		coalesce(x.qt_total_dias_lib,0),
		x.ie_se_necessario,
		x.cd_intervalo,
		VIPE_obter_se_medic_composto(a.nr_prescricao, x.nr_sequencia, x.nr_agrupamento, 'P'),
		vipe_obter_dose_composto(a.nr_prescricao, x.nr_sequencia, x.nr_agrupamento),
		x.nr_agrupamento,
		x.ie_suspenso,
		x.cd_unidade_medida_dose,
		x.ie_via_aplicacao,
		x.ds_dose_diferenciada,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'M', 'S', 'S', nm_usuario_p)
	) alias75
group by
	CASE WHEN ie_agrupar='N' THEN  nr_prescricao  ELSE CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_material,ie_agrupar_acm_sn_w)='N' THEN  nr_prescricao END  END  END ,
	CASE WHEN ie_agrupar='N' THEN  nr_seq_material  ELSE CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_material,ie_agrupar_acm_sn_w)='N' THEN  nr_seq_material END  END  END ,
	cd_material,
	ds_material,
	qt_dose || ' ' || cd_unidade_medida_dose,
	ds_intervalo || ' Via: ' || ie_via_aplicacao,
	ds_horarios;

C10 CURSOR FOR  --Procedimentos
SELECT	CASE WHEN obter_se_agrupar_proced_adep(nr_prescricao,nr_seq_procedimento,ie_acm_sn,ie_agrupar_acm_sn_w,ie_associados,ie_agrupar_associados_w)='N' THEN nr_prescricao  ELSE null END ,
	CASE WHEN obter_se_agrupar_proced_adep(nr_prescricao,nr_seq_procedimento,ie_acm_sn,ie_agrupar_acm_sn_w,ie_associados,ie_agrupar_associados_w)='N' THEN CASE WHEN ie_associados='N' THEN nr_seq_proced_prescr  ELSE nr_seq_procedimento END   ELSE null END ,
	cd_procedimento,
	ds_procedimento,
	'Qtde: ' || qt_procedimento,
	ds_intervalo,
	ds_horarios
from	(
	SELECT	a.nr_prescricao,
		c.nr_seq_procedimento,
		c.nr_seq_procedimento||a.nr_prescricao nr_seq_proced_prescr,
		c.cd_procedimento,
		coalesce(x.ds_rotina, y.ds_procedimento) ds_procedimento,
		obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) ie_acm_sn,
		x.cd_intervalo,
		x.qt_procedimento,
		substr(adep_obter_dados_prescr_proc(a.nr_prescricao,c.nr_seq_procedimento,'QIL','S',x.ie_acm,x.ie_se_necessario),1,100) ds_prescricao,
		coalesce(x.ie_suspenso,'N') ie_suspenso,
		substr(obter_se_associado_dif(a.nr_prescricao,c.nr_seq_procedimento),1,1) ie_associados,
		c.nr_seq_proc_interno,
		'P' ie_classif_adep,
		substr(obter_desc_intervalo_prescr(x.cd_intervalo),1,15) ds_intervalo,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'P', 'S', 'S', nm_usuario_p) ds_horarios
	from	procedimento y,
		prescr_procedimento x,
		prescr_proc_hor c,
		prescr_medica a
	where	y.cd_procedimento = x.cd_procedimento
	and	y.ie_origem_proced = x.ie_origem_proced
	and	y.cd_procedimento = c.cd_procedimento
	and	y.ie_origem_proced = c.ie_origem_proced
	and	x.nr_prescricao = c.nr_prescricao
	and	x.nr_sequencia = c.nr_seq_procedimento
	and	x.nr_prescricao = a.nr_prescricao
	and	c.nr_prescricao = a.nr_prescricao
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
	and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
	and	coalesce(x.nr_seq_proc_interno::text, '') = ''
	and	coalesce(x.nr_seq_exame::text, '') = ''
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(x.nr_seq_prot_glic::text, '') = ''
	and	coalesce(x.nr_seq_solic_sangue::text, '') = ''
	and	coalesce(x.nr_seq_derivado::text, '') = ''
	and	coalesce(x.nr_seq_exame_sangue::text, '') = ''
	and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
	and	coalesce(c.ie_situacao,'A') = 'A'
	and	(((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'N') and (c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w)) or
		 ((ie_considera_horario_w = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')) or
		 ((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')))
	and	((ie_exibir_realizados_p = 'S') or (coalesce(c.dt_fim_horario::text, '') = ''))
	and	((ie_exibir_suspensos_p = 'S') or (coalesce(c.dt_suspensao::text, '') = ''))
	and	((ie_regra_incl_procedimento_w = 'S') or
		 ((ie_regra_incl_procedimento_w = 'R') and (adep_obter_regra_inclusao(	'PROC',
																				cd_estabelecimento_p,
																				cd_setor_usuario_w,
																				cd_perfil_p,
																				null,
																				c.cd_procedimento,
																				c.ie_origem_proced,
																				c.nr_seq_proc_interno,
																				a.cd_setor_atendimento,
																				x.cd_setor_atendimento,
																				null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
																				x.nr_seq_exame) = 'S'))) -- nr_seq_exame_p
	and	((ie_data_lib_prescr_w = 'M') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'))
	group by
		a.nr_prescricao,
		c.nr_seq_procedimento,
		c.nr_seq_procedimento||a.nr_prescricao,
		c.cd_procedimento,
		coalesce(x.ds_rotina, y.ds_procedimento) ,
		x.ie_acm,
		x.ie_se_necessario,
		x.cd_intervalo,
		x.qt_procedimento,
		x.ie_suspenso,
		c.nr_seq_proc_interno,
		'P',
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'P', 'S', 'S', nm_usuario_p)
	
union all

	select	a.nr_prescricao,
		c.nr_seq_procedimento,
		c.nr_seq_procedimento||a.nr_prescricao nr_seq_proced_prescr,
		c.cd_procedimento,
		coalesce(x.ds_rotina, coalesce(w.ds_proc_exame,y.ds_procedimento)) ds_procedimento,
		obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) ie_acm_sn,
		x.cd_intervalo,
		x.qt_procedimento,
		substr(adep_obter_dados_prescr_proc(a.nr_prescricao,c.nr_seq_procedimento,'QIL','S',x.ie_acm,x.ie_se_necessario),1,100) ds_prescricao,
		coalesce(x.ie_suspenso,'N') ie_suspenso,
		substr(obter_se_associado_dif(a.nr_prescricao,c.nr_seq_procedimento),1,1) ie_associados,
		c.nr_seq_proc_interno,
		coalesce(w.ie_classif_adep,'P') ie_classif_adep,
		substr(obter_desc_intervalo_prescr(x.cd_intervalo),1,15) ds_intervalo,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'P', 'S', 'S', nm_usuario_p) ds_horarios
	from	procedimento y,
		proc_interno w,
		prescr_procedimento x,
		prescr_proc_hor c,
		prescr_medica a
	where	y.cd_procedimento = x.cd_procedimento
	and	y.ie_origem_proced = x.ie_origem_proced
	and	y.cd_procedimento = c.cd_procedimento
	and	y.ie_origem_proced = c.ie_origem_proced
	and	w.nr_sequencia = x.nr_seq_proc_interno
	and	w.nr_sequencia = c.nr_seq_proc_interno
	and	x.nr_prescricao = c.nr_prescricao
	and	x.nr_sequencia = c.nr_seq_procedimento
	and	x.nr_prescricao = a.nr_prescricao
	and	c.nr_prescricao = a.nr_prescricao
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
	and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	w.ie_tipo <> 'G'
	and	w.ie_tipo <> 'BS'
	and	coalesce(w.ie_ivc,'N') <> 'S'
	and	coalesce(w.ie_ctrl_glic,'NC') = 'NC'
	and	(x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '')
	and	coalesce(x.nr_seq_prot_glic::text, '') = ''
	and	coalesce(x.nr_seq_exame::text, '') = ''
	and	coalesce(x.nr_seq_solic_sangue::text, '') = ''
	and	coalesce(x.nr_seq_derivado::text, '') = ''
	and	coalesce(x.nr_seq_exame_sangue::text, '') = ''
	and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
	and	coalesce(c.ie_situacao,'A') = 'A'
	and	(((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'N') and (c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w)) or
		 ((ie_considera_horario_w = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')) or
		 ((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')))
	and	((ie_exibir_realizados_p = 'S') or (coalesce(c.dt_fim_horario::text, '') = ''))
	and	((ie_exibir_suspensos_p = 'S') or (coalesce(c.dt_suspensao::text, '') = ''))
	and	((ie_regra_incl_procedimento_w = 'S') or
		 ((ie_regra_incl_procedimento_w = 'R') and (adep_obter_regra_inclusao(	'PROC',
																				cd_estabelecimento_p,
																				cd_setor_usuario_w,
																				cd_perfil_p,
																				null,
																				c.cd_procedimento,
																				c.ie_origem_proced,
																				c.nr_seq_proc_interno,
																				a.cd_setor_atendimento,
																				x.cd_setor_atendimento,
																				null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
																				x.nr_seq_exame) = 'S')))		 -- nr_seq_exame_p
	and	((ie_data_lib_prescr_w = 'M') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'))
	group by
		a.nr_prescricao,
		c.nr_seq_procedimento,
		c.nr_seq_procedimento||a.nr_prescricao,
		c.cd_procedimento,
		w.ds_proc_exame,
		y.ds_procedimento,
		x.ds_rotina,
		x.ie_acm,
		x.ie_se_necessario,
		x.cd_intervalo,
		x.qt_procedimento,
		x.ie_suspenso,
		c.nr_seq_proc_interno,
		w.ie_classif_adep,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'P', 'S', 'S', nm_usuario_p)
	) alias119
group by
	CASE WHEN obter_se_agrupar_proced_adep(nr_prescricao,nr_seq_procedimento,ie_acm_sn,ie_agrupar_acm_sn_w,ie_associados,ie_agrupar_associados_w)='N' THEN nr_prescricao  ELSE null END ,
	CASE WHEN obter_se_agrupar_proced_adep(nr_prescricao,nr_seq_procedimento,ie_acm_sn,ie_agrupar_acm_sn_w,ie_associados,ie_agrupar_associados_w)='N' THEN CASE WHEN ie_associados='N' THEN nr_seq_proced_prescr  ELSE nr_seq_procedimento END   ELSE null END ,
	cd_procedimento,
	ds_procedimento,
	'Qtde: ' || qt_procedimento,
	ds_intervalo,
	ds_horarios;

C11 CURSOR FOR  --Controles de Glicemia
SELECT	CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_procedimento,ie_agrupar_acm_sn_w)='N' THEN  nr_prescricao  ELSE null END   ELSE null END ,
	CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_procedimento,ie_agrupar_acm_sn_w)='N' THEN  nr_seq_procedimento  ELSE null END   ELSE null END ,
	cd_procedimento,
	ds_procedimento,
	'Qtde: ' || qt_procedimento,
	ds_intervalo,
	ds_horarios
from	(
	SELECT	a.nr_prescricao,
		c.nr_seq_procedimento,
		c.cd_procedimento,
		z.ds_protocolo ds_procedimento,
		obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) ie_acm_sn,
		x.cd_intervalo,
		x.qt_procedimento,
		coalesce(x.ie_suspenso,'N') ie_suspenso,
		c.nr_seq_proc_interno,
		x.nr_seq_prot_glic,
		substr(obter_desc_intervalo_prescr(x.cd_intervalo),1,15) ds_intervalo,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'CCG', 'S', 'S', nm_usuario_p) ds_horarios
	from	pep_protocolo_glicemia z,
		procedimento y,
		proc_interno w,
		prescr_procedimento x,
		prescr_proc_hor c,
		prescr_medica a
	where	z.nr_sequencia = x.nr_seq_prot_glic
	and	y.cd_procedimento = x.cd_procedimento
	and	y.ie_origem_proced = x.ie_origem_proced
	and	y.cd_procedimento = c.cd_procedimento
	and	y.ie_origem_proced = c.ie_origem_proced
	and	w.nr_sequencia = x.nr_seq_proc_interno
	and	w.nr_sequencia = c.nr_seq_proc_interno
	and	x.nr_prescricao = c.nr_prescricao
	and	x.nr_sequencia = c.nr_seq_procedimento
	and	x.nr_prescricao = a.nr_prescricao
	and	c.nr_prescricao = a.nr_prescricao
	and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
	and	w.ie_tipo <> 'G'
	and	w.ie_tipo <> 'BS'
	and	coalesce(w.ie_ivc,'N') <> 'S'
	and	w.ie_ctrl_glic = 'CCG'
	and	(x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '')
	and	(x.nr_seq_prot_glic IS NOT NULL AND x.nr_seq_prot_glic::text <> '')
	and	coalesce(x.nr_seq_solic_sangue::text, '') = ''
	and	coalesce(x.nr_seq_derivado::text, '') = ''
	and	coalesce(x.nr_seq_exame_sangue::text, '') = ''
	and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
	and	coalesce(c.ie_situacao,'A') = 'A'
	and	(((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'N') and (c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w)) or
		 ((ie_considera_horario_w = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')) or
		 ((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')))
	and	((ie_exibir_realizados_p = 'S') or (coalesce(c.dt_fim_horario::text, '') = ''))
	and	((ie_exibir_suspensos_p = 'S') or (coalesce(c.dt_suspensao::text, '') = ''))
	and	((ie_regra_incl_ccg_w = 'S') or
		 ((ie_regra_incl_ccg_w = 'R') and (adep_obter_regra_inclusao(	'CCG',
																		cd_estabelecimento_p,
																		cd_setor_usuario_w,
																		cd_perfil_p,
																		null,
																		c.cd_procedimento,
																		c.ie_origem_proced,
																		c.nr_seq_proc_interno,
																		a.cd_setor_atendimento,
																		x.cd_setor_atendimento,
																		null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
																		x.nr_seq_exame) = 'S'))) -- nr_seq_exame_p
	and	((ie_data_lib_prescr_w = 'M') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'))
	group by
		a.nr_prescricao,
		c.nr_seq_procedimento,
		c.cd_procedimento,
		z.ds_protocolo,
		x.ie_acm,
		x.ie_se_necessario,
		x.cd_intervalo,
		x.qt_procedimento,
		x.ie_suspenso,
		c.nr_seq_proc_interno,
		x.nr_seq_prot_glic,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'CCG', 'S', 'S', nm_usuario_p)
	) alias53
group by
	CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_procedimento,ie_agrupar_acm_sn_w)='N' THEN  nr_prescricao  ELSE null END   ELSE null END ,
	CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_procedimento,ie_agrupar_acm_sn_w)='N' THEN  nr_seq_procedimento  ELSE null END   ELSE null END ,
	cd_procedimento,
	ds_procedimento,
	'Qtde: ' || qt_procedimento,
	ds_intervalo,
	ds_horarios;

C12 CURSOR FOR  --Controles de Glicemia - Itens Associados
SELECT	CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_material,ie_agrupar_acm_sn_w)='N' THEN  nr_prescricao  ELSE null END   ELSE null END ,
	CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_material,ie_agrupar_acm_sn_w)='N' THEN  nr_seq_material  ELSE null END   ELSE null END ,
	cd_material,
	ds_material,
	qt_dose || ' ' || cd_unidade_medida_dose,
	ds_intervalo || ' Via: ' || ie_via_aplicacao,
	ds_horarios
from	(
	SELECT	a.nr_prescricao,
		c.nr_seq_material,
		c.cd_material,
		z.ds_material,
		obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) ie_acm_sn,
		x.cd_intervalo,
		c.qt_dose,
		CASE WHEN obter_se_agrupa_composto(a.nr_prescricao,c.nr_seq_material,x.nr_agrupamento,c.cd_material)='S' THEN x.nr_agrupamento  ELSE 0 END  nr_agrupamento,
		substr(adep_obter_um_dosagem_glic(a.nr_prescricao,c.nr_sequencia,x.ie_acm,x.ie_se_necessario),1,100) ds_prescricao,
		coalesce(x.ie_suspenso,'N') ie_suspenso,
		x.cd_unidade_medida_dose,
		x.ie_via_aplicacao,
		substr(obter_desc_intervalo_prescr(x.cd_intervalo),1,15) ds_intervalo,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'IAG', 'S', 'S', nm_usuario_p) ds_horarios
	from	material z,
		proc_interno w,
		prescr_procedimento y,
		prescr_material x,
		prescr_mat_hor c,
		prescr_medica a
	where	z.cd_material = x.cd_material
	and	z.cd_material = c.cd_material
	and	w.nr_sequencia = y.nr_seq_proc_interno
	and	y.nr_prescricao = x.nr_prescricao
	and	y.nr_sequencia = x.nr_sequencia_proc
	and	y.nr_prescricao = a.nr_prescricao
	and	x.nr_prescricao = c.nr_prescricao
	and	x.nr_sequencia = c.nr_seq_material
	and	x.nr_prescricao = a.nr_prescricao
	and	c.nr_prescricao = y.nr_prescricao
	and	c.nr_prescricao = a.nr_prescricao
	and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(c.ie_adep,'S') = 'S'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w
	and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
	and	w.ie_tipo <> 'BS'
	and	w.ie_ivc <> 'S'
	and	coalesce(w.ie_ctrl_glic,'NC') = 'CCG'
	and	(y.nr_seq_proc_interno IS NOT NULL AND y.nr_seq_proc_interno::text <> '')
	and	(y.nr_seq_prot_glic IS NOT NULL AND y.nr_seq_prot_glic::text <> '')
	and	coalesce(y.nr_seq_exame::text, '') = ''
	and	coalesce(y.nr_seq_solic_sangue::text, '') = ''
	and	coalesce(y.nr_seq_derivado::text, '') = ''
	and	coalesce(y.nr_seq_exame_sangue::text, '') = ''
	and	x.ie_agrupador = 5
	and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
	and	coalesce(c.ie_situacao,'A') = 'A'
	and	c.ie_agrupador = 5
	and	(((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'N') and (c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w)) or
		 ((ie_considera_horario_w = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')) or
		 ((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')))
	and	((ie_exibir_realizados_p = 'S') or (coalesce(c.dt_fim_horario::text, '') = ''))
	and	((ie_exibir_suspensos_p = 'S') or (coalesce(c.dt_suspensao::text, '') = ''))
	and	((ie_data_lib_prescr_w = 'M') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'))
	group by
		a.nr_prescricao,
		c.nr_seq_material,
		c.nr_sequencia,
		c.cd_material,
		z.ds_material,
		x.ie_acm,
		x.ie_se_necessario,
		x.cd_intervalo,
		c.qt_dose,
		x.nr_agrupamento,
		x.ie_suspenso,
		x.cd_unidade_medida_dose,
		x.ie_via_aplicacao,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'IAG', 'S', 'S', nm_usuario_p)
	) alias53
group by
	CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_material,ie_agrupar_acm_sn_w)='N' THEN  nr_prescricao  ELSE null END   ELSE null END ,
	CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_material,ie_agrupar_acm_sn_w)='N' THEN  nr_seq_material  ELSE null END   ELSE null END ,
	cd_material,
	ds_material,
	qt_dose || ' ' || cd_unidade_medida_dose,
	ds_intervalo || ' Via: ' || ie_via_aplicacao,
	ds_horarios;

C13 CURSOR FOR  --Coletas
SELECT	CASE WHEN ie_Agrupa_coletas_w='S' THEN null  ELSE nr_prescricao END  nr_prescricao,
	CASE WHEN ie_Agrupa_coletas_w='S' THEN null  ELSE nr_seq_procedimento END  nr_seq_procedimento,
	cd_procedimento,
	ds_procedimento,
	'Qtde: ' || qt_procedimento,
	ds_intervalo,
	ds_horarios
from	(
	SELECT	a.nr_prescricao,
		c.nr_seq_procedimento,
		c.cd_procedimento,
		substr(adep_obter_desc_exame_lab(x.ie_acm,x.ie_se_necessario,z.nm_exame),1,255) ds_procedimento,
		obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) ie_acm_sn,
		x.cd_intervalo,
		x.qt_procedimento,
		v.ds_material_exame ds_prescricao,
		coalesce(x.ie_suspenso,'N') ie_suspenso,
		coalesce(c.nr_seq_proc_interno,0) nr_seq_proc_interno,
		substr(obter_desc_intervalo_prescr(x.cd_intervalo),1,15) ds_intervalo,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'L', 'S', 'S', nm_usuario_p) ds_horarios
	FROM exame_laboratorio z, procedimento y, prescr_proc_hor c, prescr_medica a, prescr_procedimento x
LEFT OUTER JOIN material_exame_lab v ON (x.cd_material_exame = v.cd_material_exame)
WHERE z.nr_seq_exame = x.nr_seq_exame and y.cd_procedimento = x.cd_procedimento and y.ie_origem_proced = x.ie_origem_proced and y.cd_procedimento = c.cd_procedimento and y.ie_origem_proced = c.ie_origem_proced and x.nr_prescricao = c.nr_prescricao and x.nr_sequencia = c.nr_seq_procedimento and x.nr_prescricao = a.nr_prescricao and c.nr_prescricao = a.nr_prescricao and Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S' and a.nr_atendimento = nr_atendimento_p and a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w and coalesce(a.dt_suspensao::text, '') = '' and coalesce(x.nr_seq_proc_interno::text, '') = '' and (x.nr_seq_exame IS NOT NULL AND x.nr_seq_exame::text <> '') and coalesce(x.nr_seq_solic_sangue::text, '') = '' and coalesce(x.nr_seq_derivado::text, '') = '' and coalesce(x.nr_seq_exame_sangue::text, '') = '' and ((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = '')) and coalesce(c.ie_situacao,'A') = 'A' and (((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'N') and (c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w)) or
		 ((ie_considera_horario_w = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')) or
		 ((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S'))) and ((ie_exibir_realizados_p = 'S') or (coalesce(c.dt_fim_horario::text, '') = '')) and ((ie_exibir_suspensos_p = 'S') or (coalesce(c.dt_suspensao::text, '') = '')) and ((ie_regra_incl_coleta_w = 'S') or
		 ((ie_regra_incl_coleta_w = 'R') and (adep_obter_regra_inclusao(	'LAB',
																			cd_estabelecimento_p,
																			cd_setor_usuario_w,
																			cd_perfil_p,
																			null,
																			c.cd_procedimento,
																			c.ie_origem_proced,
																			c.nr_seq_proc_interno,
																			a.cd_setor_atendimento,
																			x.cd_setor_atendimento,
																			null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
																			x.nr_seq_exame) = 'S')))  -- nr_seq_exame_p
  and ((ie_data_lib_prescr_w = 'M') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S')) group by
		a.nr_prescricao,
		c.nr_seq_procedimento,
		c.cd_procedimento,
		x.ie_acm,
		x.ie_se_necessario,
		z.nm_exame,
		x.cd_intervalo,
		x.qt_procedimento,
		v.ds_material_exame,
		x.ie_suspenso,
		c.nr_seq_proc_interno,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'L', 'S', 'S', nm_usuario_p)
	
union all

	select	a.nr_prescricao,
		c.nr_seq_procedimento,
		c.cd_procedimento,
		substr(adep_obter_desc_exame_lab(x.ie_acm,x.ie_se_necessario,z.nm_exame),1,255) ds_procedimento,
		obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) ie_acm_sn,
		x.cd_intervalo,
		x.qt_procedimento,
		v.ds_material_exame ds_prescricao,
		coalesce(x.ie_suspenso,'N') ie_suspenso,
		c.nr_seq_proc_interno,
		substr(obter_desc_intervalo_prescr(x.cd_intervalo),1,15) ds_intervalo,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'L', 'S', 'S', nm_usuario_p) ds_horarios
	FROM exame_laboratorio z, procedimento y, proc_interno w, prescr_proc_hor c, prescr_medica a, prescr_procedimento x
LEFT OUTER JOIN material_exame_lab v ON (x.cd_material_exame = v.cd_material_exame)
WHERE z.nr_seq_exame = x.nr_seq_exame and y.cd_procedimento = x.cd_procedimento and y.ie_origem_proced = x.ie_origem_proced and y.cd_procedimento = c.cd_procedimento and y.ie_origem_proced = c.ie_origem_proced and w.nr_sequencia = x.nr_seq_proc_interno and w.nr_sequencia = c.nr_seq_proc_interno and x.nr_prescricao = c.nr_prescricao and x.nr_sequencia = c.nr_seq_procedimento and x.nr_prescricao = a.nr_prescricao and c.nr_prescricao = a.nr_prescricao and Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S' and a.nr_atendimento = nr_atendimento_p and a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w and coalesce(a.dt_suspensao::text, '') = '' and w.ie_tipo <> 'G' and w.ie_tipo <> 'BS' and w.ie_ivc <> 'S' and (x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '') and coalesce(x.nr_seq_prot_glic::text, '') = '' and (x.nr_seq_exame IS NOT NULL AND x.nr_seq_exame::text <> '') and coalesce(x.nr_seq_solic_sangue::text, '') = '' and coalesce(x.nr_seq_derivado::text, '') = '' and coalesce(x.nr_seq_exame_sangue::text, '') = '' and ((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = '')) and coalesce(c.ie_situacao,'A') = 'A' and (((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'N') and (c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w)) or
		 ((ie_considera_horario_w = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')) or
		 ((obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S'))) and ((ie_exibir_realizados_p = 'S') or (coalesce(c.dt_fim_horario::text, '') = '')) and ((ie_exibir_suspensos_p = 'S') or (coalesce(c.dt_suspensao::text, '') = '')) and ((ie_regra_incl_coleta_w = 'S') or
		 ((ie_regra_incl_coleta_w = 'R') and (adep_obter_regra_inclusao(	'LAB',
																			cd_estabelecimento_p,
																			cd_setor_usuario_w,
																			cd_perfil_p,
																			null,
																			c.cd_procedimento,
																			c.ie_origem_proced,
																			c.nr_seq_proc_interno,
																			a.cd_setor_atendimento,
																			x.cd_setor_atendimento,
																			null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
																			x.nr_seq_exame) = 'S')))  -- nr_seq_exame_p
  and ((ie_data_lib_prescr_w = 'M') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S')) group by
		a.nr_prescricao,
		c.nr_seq_procedimento,
		c.cd_procedimento,
		x.ie_acm,
		x.ie_se_necessario,
		z.nm_exame,
		x.cd_intervalo,
		x.qt_procedimento,
		v.ds_material_exame,
		x.ie_suspenso,
		c.nr_seq_proc_interno,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'L', 'S', 'S', nm_usuario_p)
	) alias106
group by
	CASE WHEN ie_Agrupa_coletas_w='S' THEN null  ELSE nr_prescricao END ,
	CASE WHEN ie_Agrupa_coletas_w='S' THEN null  ELSE nr_seq_procedimento END ,
	cd_procedimento,
	ds_procedimento,
	'Qtde: ' || qt_procedimento,
	ds_intervalo,
	ds_horarios;

C14 CURSOR FOR  --Gasoterapia
SELECT	CASE WHEN coalesce(ie_lib_pend_rep::text, '') = '' THEN  CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_gasoterapia,ie_agrupar_acm_sn_w)='N' THEN  nr_prescricao  ELSE null END   ELSE nr_prescricao END   ELSE nr_prescricao END ,
	CASE WHEN coalesce(ie_lib_pend_rep::text, '') = '' THEN  CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_gasoterapia,ie_agrupar_acm_sn_w)='N' THEN  nr_seq_gasoterapia  ELSE null END   ELSE nr_seq_gasoterapia END   ELSE nr_seq_gasoterapia END ,
	ds_gas,
	'Qtde: ' || qt_gasoterapia,
	ds_intervalo
from	(
	SELECT	a.nr_prescricao,
		x.nr_sequencia nr_seq_gasoterapia,
		x.nr_seq_gas,
		coalesce(Obter_nome_rotina_gas(x.nr_seq_item_rotina), y.ds_gas) ds_gas,
		'N' ie_acm_sn,
		x.cd_intervalo,
		x.qt_gasoterapia,
		x.qt_gasoterapia || ' ' || w.ds_valor_dominio || ' ' || z.ds_intervalo ds_prescricao,
		substr(adep_obter_config_gas(x.cd_modalidade_vent,x.ie_respiracao,x.ie_modo_adm),1,255) ds_config_gas,
		CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN substr(adep_obter_lib_pend_rep_gestao(a.dt_liberacao_medico,a.dt_liberacao,a.dt_liberacao_farmacia),1,1)  ELSE null END  ie_lib_pend_rep,
		substr(Obter_Status_Gasoterapia(x.nr_sequencia, 'C'),1,10) ie_status_item,
		substr(obter_desc_intervalo_prescr(x.cd_intervalo),1,15) ds_intervalo
	FROM gas y, prescr_medica a, prescr_gasoterapia x
LEFT OUTER JOIN valor_dominio w ON (x.ie_unidade_medida = w.vl_dominio AND 1580 = w.cd_dominio)
LEFT OUTER JOIN intervalo_prescricao z ON (x.cd_intervalo = z.cd_intervalo)
WHERE y.nr_sequencia = x.nr_seq_gas and x.nr_prescricao = a.nr_prescricao and a.nr_atendimento = nr_atendimento_p and a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w and coalesce(a.dt_suspensao::text, '') = '' and Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S' and obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S' and ((coalesce(x.dt_prev_execucao::text, '') = '') or (x.dt_prev_execucao between dt_inicial_horarios_w and dt_final_horarios_w) or
		 ((ie_considera_horario_w = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S'))) and ((ie_regra_incl_gas_w = 'S') or
		 ((ie_regra_incl_gas_w = 'R') and (adep_obter_regra_inclusao(	'OX',
																		cd_estabelecimento_p,
																		cd_setor_usuario_w,
																		cd_perfil_p,
																		null,
																		null,
																		null,
																		null,
																		a.cd_setor_atendimento,
																		null,
																		null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
																		null) = 'S'))) 	 -- nr_seq_exame_p
  and ((ie_exibir_realizados_p = 'S') or ((ie_exibir_realizados_p = 'N') and coalesce(substr(Obter_Status_Gasoterapia(x.nr_sequencia, 'C'),1,10),'N') <> 'T')) and ((ie_exibir_suspensos_p = 'S') or ((ie_exibir_suspensos_p = 'N') and coalesce(substr(Obter_Status_Gasoterapia(x.nr_sequencia, 'C'),1,10),'N') <> 'S')) group by
		a.nr_prescricao,
		x.nr_sequencia,
		x.nr_seq_gas,
		coalesce(Obter_nome_rotina_gas(x.nr_seq_item_rotina), y.ds_gas),
		'N',
		x.cd_intervalo,
		x.qt_gasoterapia,
		w.ds_valor_dominio,
		z.ds_intervalo,
		x.cd_modalidade_vent,
		x.ie_respiracao,
		x.ie_modo_adm,
		a.dt_liberacao_medico,
		a.dt_liberacao,
		a.dt_liberacao_farmacia,
		substr(Obter_Status_Gasoterapia(x.nr_sequencia, 'C'),1,10)
	) alias50
group by
	CASE WHEN coalesce(ie_lib_pend_rep::text, '') = '' THEN  CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_gasoterapia,ie_agrupar_acm_sn_w)='N' THEN  nr_prescricao  ELSE null END   ELSE nr_prescricao END   ELSE nr_prescricao END ,
	CASE WHEN coalesce(ie_lib_pend_rep::text, '') = '' THEN  CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_gasoterapia,ie_agrupar_acm_sn_w)='N' THEN  nr_seq_gasoterapia  ELSE null END   ELSE nr_seq_gasoterapia END   ELSE nr_seq_gasoterapia END ,
	nr_seq_gas,
	ds_gas,
	'Qtde: ' || qt_gasoterapia,
	ds_intervalo;

C15 CURSOR FOR  --Recomendações/Ordens
SELECT	CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_recomendacao,ie_agrupar_acm_sn_w)='N' THEN  nr_prescricao  ELSE null END   ELSE null END ,
	CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_recomendacao,ie_agrupar_acm_sn_w)='N' THEN  nr_seq_recomendacao  ELSE null END   ELSE null END ,
	cd_recomendacao,
	ds_recomendacao,
	'Qtde: ' || coalesce(qt_recomendacao,1),
	ds_intervalo,
	ds_horarios
from	(
	SELECT	a.nr_prescricao,
		c.nr_seq_recomendacao,
		substr(coalesce(to_char(x.cd_recomendacao),x.ds_recomendacao),1,255) cd_recomendacao,
		coalesce(y.ds_tipo_recomendacao,x.ds_recomendacao) ds_recomendacao,
		obter_se_acm_sn_rec(x.ds_horarios, x.ie_se_necessario) ie_acm_sn,
		x.cd_intervalo,
		x.qt_recomendacao,
		w.ds_prescricao ds_prescricao,
		coalesce(x.ie_suspenso,'N') ie_suspenso,
		substr(obter_desc_intervalo_prescr(x.cd_intervalo),1,15) ds_intervalo,
		x.ds_recomendacao ds_rec,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'R', 'S', 'S', nm_usuario_p) ds_horarios
	FROM prescr_rec_hor c, prescr_medica a, prescr_recomendacao x
LEFT OUTER JOIN intervalo_prescricao w ON (x.cd_intervalo = w.cd_intervalo)
LEFT OUTER JOIN tipo_recomendacao y ON (x.cd_recomendacao = y.cd_tipo_recomendacao)
WHERE x.nr_prescricao = c.nr_prescricao and x.nr_sequencia = c.nr_seq_recomendacao and x.nr_prescricao = a.nr_prescricao and c.nr_prescricao = a.nr_prescricao and a.nr_atendimento = nr_atendimento_p and Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S' and a.dt_validade_prescr between dt_validade_limite_w and dt_fim_w and coalesce(a.dt_suspensao::text, '') = '' and ((ie_data_lib_prescr_w = 'F') or (obter_se_prescr_lib_vipe(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w,c.dt_lib_horario) = 'S')) and ((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = '')) and coalesce(c.ie_situacao,'A') = 'A' and (((obter_se_acm_sn_rec(x.ds_horarios, x.ie_se_necessario) = 'N') and (c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w)) or
		 ((ie_considera_horario_w = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S')) or
		 ((obter_se_acm_sn_rec(x.ds_horarios, x.ie_se_necessario) = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_horarios_w,dt_final_horarios_w) = 'S'))) and ((ie_exibir_realizados_p = 'S') or (coalesce(c.dt_fim_horario::text, '') = '')) and ((ie_exibir_suspensos_p = 'S') or (coalesce(c.dt_suspensao::text, '') = '')) and ((ie_regra_incl_recomendacao_w = 'S') or
		 ((ie_regra_incl_recomendacao_w = 'R') and (adep_obter_regra_inclusao(	'REC',
																				cd_estabelecimento_p,
																				cd_setor_usuario_w,
																				cd_perfil_p,
																				null,
																				null,
																				null,
																				null,
																				a.cd_setor_atendimento,
																				null,
																				null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
																				null) = 'S')))  -- nr_seq_exame_p
  and ((ie_data_lib_prescr_w = 'M') or (Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S')) group by
		a.nr_prescricao,
		c.nr_seq_recomendacao,
		x.cd_recomendacao,
		x.ds_recomendacao,
		y.ds_tipo_recomendacao,
		x.ds_horarios,
		x.cd_intervalo,
		x.qt_recomendacao,
		w.ds_prescricao,
		x.ie_suspenso,
		x.ie_se_necessario,
		x.ds_recomendacao,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_sequencia, dt_referencia_p, 'R', 'S', 'S', nm_usuario_p)
	) alias56
group by
	CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_recomendacao,ie_agrupar_acm_sn_w)='N' THEN  nr_prescricao  ELSE null END   ELSE null END ,
	CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_recomendacao,ie_agrupar_acm_sn_w)='N' THEN  nr_seq_recomendacao  ELSE null END   ELSE null END ,
	cd_recomendacao,
	ds_recomendacao,
	'Qtde: ' || coalesce(qt_recomendacao,1),
	ds_intervalo,
	ds_horarios;

C16 CURSOR FOR  --Diálise
SELECT	nr_prescricao,
	nr_seq_solucao,
	ds_solucao,
	qt_solucao_total || ' ' || ie_tipo_dosagem,
	ds_intervalo || ' Via: ' || ie_via_aplicacao,
	ds_horarios
from	(
	SELECT	a.nr_prescricao,
		x.nr_seq_solucao,
		substr(coalesce(substr(obter_descricao_padrao('PROTOCOLO_NPT', 'DS_NPT', x.nr_seq_protocolo),1,100),obter_prim_comp_sol(a.nr_prescricao,x.nr_seq_solucao)),1,240) ds_solucao,
		obter_se_acm_sn(x.ie_acm,x.ie_se_necessario) ie_acm_sn,
		substr(obter_desc_vol_etapa_adep2(a.nr_prescricao,x.nr_seq_solucao,x.ie_acm,x.ie_se_necessario),1,240) ds_prescricao,
		substr(obter_componentes_solucao(a.nr_prescricao,x.nr_seq_solucao,'S',nm_usuario_p,cd_estabelecimento_p),1,240) ds_componentes,
		substr(obter_status_solucao_prescr(1,a.nr_prescricao,x.nr_seq_solucao),1,3) ie_status_solucao,
		coalesce(x.ie_suspenso,'N') ie_suspenso,
		x.dt_prev_prox_etapa,
		x.ie_tipo_dosagem,
		x.ie_via_aplicacao,
		x.qt_solucao_total,
		substr(obter_interv_solucao_vipe(x.ie_acm,x.ie_se_necessario,x.ie_urgencia,x.nr_etapas,x.qt_hora_fase) || CASE WHEN coalesce(x.ie_classif_agora::text, '') = '' THEN ''  ELSE ' - ' END  || obter_desc_intervalo(x.ie_classif_agora),1,240) ds_intervalo,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_seq_solucao, dt_referencia_p, 'MD', 'S', 'S', nm_usuario_p) ds_horarios
	from	prescr_solucao x,
		prescr_medica a
	where	x.nr_prescricao = a.nr_prescricao
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_inicio_prescr between dt_validade_limite_w and dt_fim_w
	and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
	and	(x.nr_seq_dialise IS NOT NULL AND x.nr_seq_dialise::text <> '')
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	exists (select 1 from prescr_mat_hor c where c.ie_agrupador = 13 and c.nr_prescricao = x.nr_prescricao and c.nr_seq_solucao = x.nr_seq_solucao and c.dt_horario between dt_inicial_horarios_w and dt_final_horarios_w)
	and	Obter_se_setor_vipe(a.cd_setor_atendimento) = 'S'
	and	((ie_exibir_realizados_p = 'S') or (x.ie_status <> 'T'))
	and	((ie_exibir_suspensos_p = 'S') or (coalesce(x.dt_suspensao::text, '') = ''))
	and	((ie_regra_incl_dialise_w = 'S') or
		 ((ie_regra_incl_dialise_w = 'R') and (adep_obter_regra_inclusao(	'SOL',
																			cd_estabelecimento_p,
																			cd_setor_usuario_w,
																			cd_perfil_p,
																			null,
																			null,
																			null,
																			null,
																			a.cd_setor_atendimento,
																			null,
																			null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
																			null) = 'S'))) -- nr_seq_exame_p
	group by
		a.nr_prescricao,
		x.nr_seq_solucao,
		substr(obter_descricao_padrao('PROTOCOLO_NPT', 'DS_NPT', x.nr_seq_protocolo),1,100),
		x.ie_acm,
		x.ie_se_necessario,
		nm_usuario_p,
		cd_estabelecimento_p,
		obter_desc_intervalo(x.ie_classif_agora),
		x.ie_suspenso,
		x.dt_prev_prox_etapa,
		x.ie_tipo_dosagem,
		x.ie_via_aplicacao,
		x.qt_solucao_total,
		CASE WHEN coalesce(x.ie_classif_agora::text, '') = '' THEN ''  ELSE ' - ' END ,
		x.ie_urgencia,
		x.nr_etapas,
		x.qt_hora_fase,
		Obter_hor_item_relat_vipe(cd_perfil_p, cd_estabelecimento_p, nr_atendimento_p, x.nr_prescricao, x.nr_seq_solucao, dt_referencia_p, 'MD', 'S', 'S', nm_usuario_p)
	) alias41
group by
	nr_prescricao,
	nr_seq_solucao,
	ds_solucao,
	qt_solucao_total || ' ' || ie_tipo_dosagem,
	ds_intervalo || ' Via: ' || ie_via_aplicacao,
	ds_horarios;


BEGIN

delete
from	w_relat_vipe
where	nr_atendimento	= nr_atendimento_p
and	nm_usuario	= nm_usuario_p;

cd_setor_usuario_w := wheb_usuario_pck.get_cd_setor_atendimento;

ie_agrupar_acm_sn_w := Obter_Param_Usuario(8030, 17, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_agrupar_acm_sn_w);
ie_data_lib_prescr_w := Obter_Param_Usuario(8030, 16, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_data_lib_prescr_w);
ie_agrupar_dose_esp_w := Obter_Param_Usuario(8030, 19, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_agrupar_dose_esp_w);
ie_mostrar_subs_w := Obter_Param_Usuario(8030, 28, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_mostrar_subs_w);
ie_agrupar_associados_w := Obter_Param_Usuario(8030, 25, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_agrupar_associados_w);
ie_exibe_sem_lib_farm_w := Obter_Param_Usuario(8030, 30, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_exibe_sem_lib_farm_w);
ie_exibe_dietas_w := Obter_Param_Usuario(8030, 31, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_exibe_dietas_w);
ie_considera_horario_w := Obter_Param_Usuario(8030, 46, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_considera_horario_w);
ie_agrupa_coletas_w := Obter_Param_Usuario(8030, 48, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_agrupa_coletas_w);
ie_utiliza_serv_w := Obter_Param_Usuario(8030, 49, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_utiliza_serv_w);
ie_agrupa_item_igual_w := Obter_Param_Usuario(8030, 55, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_agrupa_item_igual_w);

if (dt_referencia_p IS NOT NULL AND dt_referencia_p::text <> '') then
	begin
	dt_validade_limite_w	:= dt_referencia_p - 1/86400;
	dt_inicial_horarios_w	:= dt_referencia_p;
	dt_final_horarios_w	:= (dt_inicial_horarios_w + 1) - 1/86400;
	end;
else
	begin
	dt_validade_limite_w	:= clock_timestamp() - dividir(qt_horas_vigencia_w,24);
	dt_inicial_horarios_w	:= to_date(to_char(trunc(clock_timestamp() - dividir(qt_horas_anteriores_w,24),'hh24'),'dd/mm/yyyy hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
	dt_final_horarios_w	:= to_date(to_char(trunc(clock_timestamp() + dividir(qt_horas_adicionais_w,24),'hh24'),'dd/mm/yyyy hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
	end;
end if;

dt_fim_w := dt_validade_limite_w + 3;

open c00;
loop
fetch c00 into	ie_regra_incl_dieta_oral_w,
		ie_regra_incl_supl_oral_w,
		ie_regra_incl_solucao_w,
		ie_regra_incl_dialise_w,
		ie_regra_incl_medicamento_w,
		ie_regra_incl_material_w,
		ie_regra_incl_procedimento_w,
		ie_regra_incl_coleta_w,
		ie_regra_incl_ccg_w,
		ie_regra_incl_cig_w,
		ie_regra_incl_recomendacao_w,
		ie_regra_incl_intervencao_w,
		ie_regra_incl_ivc_w,
		ie_regra_incl_gas_w,
		ie_regra_incl_hemoterapia_w,
		ie_regra_incl_sne_w,
		ie_regra_incl_npt_adulta_w,
		ie_regra_incl_npt_neonatal_w;
EXIT WHEN NOT FOUND; /* apply on c00 */
	begin
	ie_regra_incl_dieta_oral_w	:= ie_regra_incl_dieta_oral_w;
	ie_regra_incl_supl_oral_w	:= ie_regra_incl_supl_oral_w;
	ie_regra_incl_solucao_w		:= ie_regra_incl_solucao_w;
	ie_regra_incl_dialise_w		:= ie_regra_incl_dialise_w;
	ie_regra_incl_medicamento_w	:= ie_regra_incl_medicamento_w;
	ie_regra_incl_material_w	:= ie_regra_incl_material_w;
	ie_regra_incl_procedimento_w	:= ie_regra_incl_procedimento_w;
	ie_regra_incl_coleta_w		:= ie_regra_incl_coleta_w;
	ie_regra_incl_ccg_w		:= ie_regra_incl_ccg_w;
	ie_regra_incl_cig_w		:= ie_regra_incl_cig_w;
	ie_regra_incl_recomendacao_w	:= ie_regra_incl_recomendacao_w;
	ie_regra_incl_intervencao_w	:= ie_regra_incl_intervencao_w;
	ie_regra_incl_ivc_w		:= ie_regra_incl_ivc_w;
	ie_regra_incl_gas_w		:= ie_regra_incl_gas_w;
	ie_regra_incl_hemoterapia_w	:= ie_regra_incl_hemoterapia_w;
	ie_regra_incl_jejum_w		:= ie_regra_incl_dieta_oral_w;
	ie_regra_incl_sne_w		:= ie_regra_incl_sne_w;
	ie_regra_incl_npt_adulta_w	:= ie_regra_incl_npt_adulta_w;
	ie_regra_incl_npt_neonatal_w	:= ie_regra_incl_npt_neonatal_w;
	end;
end loop;
close c00;

open C01;
loop
fetch C01 into
	cd_item_w,
	ds_item_w,
	ds_prescricao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

	insert into w_relat_vipe(nr_sequencia,
			 nr_seq_apresent,
			 nr_atendimento,
			 cd_item,
			 ds_item,
			 ie_tipo_item,
			 ds_tipo_item,
			 ds_dosagem,
			 ds_prescricao,
			 ds_enfermagem,
			 dt_atualizacao,
			 nm_usuario)
		values (nextval('w_relat_vipe_seq'),
			 1,
			 nr_atendimento_p,
			 cd_item_w,
			 ds_item_w,
			 'J',
			 'Jejum',
			 null,
			 ds_prescricao_w,
			 null,
			 clock_timestamp(),
			 nm_usuario_p);

end loop;
close C01;

open C02;
loop
fetch C02 into
	cd_item_w,
	ds_item_w,
	ds_prescricao_w;
EXIT WHEN NOT FOUND; /* apply on C02 */

	insert into w_relat_vipe(nr_sequencia,
			 nr_seq_apresent,
			 nr_atendimento,
			 cd_item,
			 ds_item,
			 ie_tipo_item,
			 ds_tipo_item,
			 ds_dosagem,
			 ds_prescricao,
			 ds_enfermagem,
			 dt_atualizacao,
			 nm_usuario)
		values (nextval('w_relat_vipe_seq'),
			 2,
			 nr_atendimento_p,
			 cd_item_w,
			 ds_item_w,
			 'D',
			 'Dieta Oral',
			 null,
			 ds_prescricao_w,
			 null,
			 clock_timestamp(),
			 nm_usuario_p);

end loop;
close C02;

open C03;
loop
fetch C03 into
	nr_prescricao_w,
	nr_seq_item_w,
	cd_item_w,
	ds_item_w,
	ds_dosagem_w,
	ds_prescricao_w,
	ds_enfermagem_w;
EXIT WHEN NOT FOUND; /* apply on C03 */

	insert into w_relat_vipe(nr_sequencia,
			 nr_seq_apresent,
			 nr_atendimento,
			 cd_item,
			 ds_item,
			 ie_tipo_item,
			 ds_tipo_item,
			 ds_dosagem,
			 ds_prescricao,
			 ds_enfermagem,
			 dt_atualizacao,
			 nm_usuario)
		values (nextval('w_relat_vipe_seq'),
			 3,
			 nr_atendimento_p,
			 cd_item_w,
			 ds_item_w,
			 'S',
			 'Suplemento Oral',
			 ds_dosagem_w,
			 ds_prescricao_w,
			 ds_enfermagem_w,
			 clock_timestamp(),
			 nm_usuario_p);

end loop;
close C03;

open C04;
loop
fetch C04 into
	nr_prescricao_w,
	nr_seq_item_w,
	ds_item_w,
	ds_dosagem_w,
	ds_prescricao_w,
	ds_enfermagem_w;
EXIT WHEN NOT FOUND; /* apply on C04 */

	insert into w_relat_vipe(nr_sequencia,
			 nr_seq_apresent,
			 nr_atendimento,
			 cd_item,
			 ds_item,
			 ie_tipo_item,
			 ds_tipo_item,
			 ds_dosagem,
			 ds_prescricao,
			 ds_enfermagem,
			 dt_atualizacao,
			 nm_usuario)
		values (nextval('w_relat_vipe_seq'),
			 4,
			 nr_atendimento_p,
			 cd_item_w,
			 ds_item_w,
			 'SOL',
			 'Soluções',
			 ds_dosagem_w,
			 ds_prescricao_w,
			 ds_enfermagem_w,
			 clock_timestamp(),
			 nm_usuario_p);

end loop;
close C04;

open C05;
loop
fetch C05 into
	nr_prescricao_w,
	nr_seq_item_w,
	cd_item_w,
	ds_item_w,
	ds_prescricao_w,
	ds_dosagem_w,
	ds_enfermagem_w;
EXIT WHEN NOT FOUND; /* apply on C05 */

	insert into w_relat_vipe(nr_sequencia,
			 nr_seq_apresent,
			 nr_atendimento,
			 cd_item,
			 ds_item,
			 ie_tipo_item,
			 ds_tipo_item,
			 ds_dosagem,
			 ds_prescricao,
			 ds_enfermagem,
			 dt_atualizacao,
			 nm_usuario)
		values (nextval('w_relat_vipe_seq'),
			 5,
			 nr_atendimento_p,
			 cd_item_w,
			 ds_item_w,
			 'SNE',
			 'Suporte Nutricional Enteral',
			 ds_dosagem_w,
			 ds_prescricao_w,
			 ds_enfermagem_w,
			 clock_timestamp(),
			 nm_usuario_p);

end loop;
close C05;

open C06;
loop
fetch C06 into
	nr_prescricao_w,
	nr_seq_item_w,
	ds_item_w,
	ds_prescricao_w,
	ds_dosagem_w,
	ds_enfermagem_w;
EXIT WHEN NOT FOUND; /* apply on C06 */

	insert into w_relat_vipe(nr_sequencia,
			 nr_seq_apresent,
			 nr_atendimento,
			 cd_item,
			 ds_item,
			 ie_tipo_item,
			 ds_tipo_item,
			 ds_dosagem,
			 ds_prescricao,
			 ds_enfermagem,
			 dt_atualizacao,
			 nm_usuario)
		values (nextval('w_relat_vipe_seq'),
			 6,
			 nr_atendimento_p,
			 null,
			 ds_item_w,
			 'NAN',
			 'NPT Adulta',
			 ds_dosagem_w,
			 ds_prescricao_w,
			 ds_enfermagem_W,
			 clock_timestamp(),
			 nm_usuario_p);

end loop;
close C06;

open C07;
loop
fetch C07 into
	nr_prescricao_w,
	nr_seq_item_w,
	ds_item_w;
EXIT WHEN NOT FOUND; /* apply on C07 */

	insert into w_relat_vipe(nr_sequencia,
			 nr_seq_apresent,
			 nr_atendimento,
			 cd_item,
			 ds_item,
			 ie_tipo_item,
			 ds_tipo_item,
			 ds_dosagem,
			 ds_prescricao,
			 ds_enfermagem,
			 dt_atualizacao,
			 nm_usuario)
		values (nextval('w_relat_vipe_seq'),
			 7,
			 nr_atendimento_p,
			 null,
			 ds_item_w,
			 'NPN',
			 'NPT Neonatal',
			 null,
			 null,
			 null,
			 clock_timestamp(),
			 nm_usuario_p);

end loop;
close C07;

open C08;
loop
fetch C08 into
	nr_prescricao_w,
	nr_seq_item_w,
	cd_item_w,
	ds_item_w,
	ds_dosagem_w,
	ds_prescricao_w,
	ds_enfermagem_w;
EXIT WHEN NOT FOUND; /* apply on C08 */

	insert into w_relat_vipe(nr_sequencia,
			 nr_seq_apresent,
			 nr_atendimento,
			 cd_item,
			 ds_item,
			 ie_tipo_item,
			 ds_tipo_item,
			 ds_dosagem,
			 ds_prescricao,
			 ds_enfermagem,
			 dt_atualizacao,
			 nm_usuario)
		values (nextval('w_relat_vipe_seq'),
			 8,
			 nr_atendimento_p,
			 cd_item_w,
			 ds_item_w,
			 'HM',
			 'Hemoterapias',
			 ds_dosagem_w,
			 ds_prescricao_w,
			 ds_enfermagem_w,
			 clock_timestamp(),
			 nm_usuario_p);

end loop;
close C08;

open C09;
loop
fetch C09 into
	nr_prescricao_w,
	nr_seq_item_w,
	cd_item_w,
	ds_item_w,
	ds_dosagem_w,
	ds_prescricao_w,
	ds_enfermagem_w;
EXIT WHEN NOT FOUND; /* apply on C09 */

	insert into w_relat_vipe(nr_sequencia,
			 nr_seq_apresent,
			 nr_atendimento,
			 cd_item,
			 ds_item,
			 ie_tipo_item,
			 ds_tipo_item,
			 ds_dosagem,
			 ds_prescricao,
			 ds_enfermagem,
			 dt_atualizacao,
			 nm_usuario)
		values (nextval('w_relat_vipe_seq'),
			 9,
			 nr_atendimento_p,
			 cd_item_w,
			 ds_item_w,
			 'M',
			 'Medicamentos',
			 ds_dosagem_w,
			 ds_prescricao_w,
			 ds_enfermagem_w,
			 clock_timestamp(),
			 nm_usuario_p);

end loop;
close C09;

open C10;
loop
fetch C10 into
	nr_prescricao_w,
	nr_seq_item_w,
	cd_item_w,
	ds_item_w,
	ds_dosagem_w,
	ds_prescricao_w,
	ds_enfermagem_w;
EXIT WHEN NOT FOUND; /* apply on C10 */

	insert into w_relat_vipe(nr_sequencia,
			 nr_seq_apresent,
			 nr_atendimento,
			 cd_item,
			 ds_item,
			 ie_tipo_item,
			 ds_tipo_item,
			 ds_dosagem,
			 ds_prescricao,
			 ds_enfermagem,
			 dt_atualizacao,
			 nm_usuario)
		values (nextval('w_relat_vipe_seq'),
			 10,
			 nr_atendimento_p,
			 cd_item_w,
			 ds_item_w,
			 'P',
			 'Procedimentos',
			 ds_dosagem_w,
			 ds_prescricao_w,
			 ds_enfermagem_w,
			 clock_timestamp(),
			 nm_usuario_p);

end loop;
close C10;

open C11;
loop
fetch C11 into
	nr_prescricao_w,
	nr_seq_item_w,
	cd_item_w,
	ds_item_w,
	ds_dosagem_w,
	ds_prescricao_w,
	ds_enfermagem_w;
EXIT WHEN NOT FOUND; /* apply on C11 */

	insert into w_relat_vipe(nr_sequencia,
			 nr_seq_apresent,
			 nr_atendimento,
			 cd_item,
			 ds_item,
			 ie_tipo_item,
			 ds_tipo_item,
			 ds_dosagem,
			 ds_prescricao,
			 ds_enfermagem,
			 dt_atualizacao,
			 nm_usuario)
		values (nextval('w_relat_vipe_seq'),
			 11,
			 nr_atendimento_p,
			 cd_item_w,
			 ds_item_w,
			 'CCG',
			 'Controles de Glicemia',
			 ds_dosagem_w,
			 ds_prescricao_w,
			 ds_enfermagem_w,
			 clock_timestamp(),
			 nm_usuario_p);

end loop;
close C11;

open C12;
loop
fetch C12 into
	nr_prescricao_w,
	nr_seq_item_w,
	cd_item_w,
	ds_item_w,
	ds_dosagem_w,
	ds_prescricao_w,
	ds_enfermagem_w;
EXIT WHEN NOT FOUND; /* apply on C12 */

	insert into w_relat_vipe(nr_sequencia,
			 nr_seq_apresent,
			 nr_atendimento,
			 cd_item,
			 ds_item,
			 ie_tipo_item,
			 ds_tipo_item,
			 ds_dosagem,
			 ds_prescricao,
			 ds_enfermagem,
			 dt_atualizacao,
			 nm_usuario)
		values (nextval('w_relat_vipe_seq'),
			 12,
			 nr_atendimento_p,
			 cd_item_w,
			 ds_item_w,
			 'IAG',
			 'Controles de Glicemia - Itens Associados',
			 ds_dosagem_w,
			 ds_prescricao_w,
			 ds_enfermagem_w,
			 clock_timestamp(),
			 nm_usuario_p);

end loop;
close C12;

open C13;
loop
fetch C13 into
	nr_prescricao_w,
	nr_seq_item_w,
	cd_item_w,
	ds_item_w,
	ds_dosagem_w,
	ds_prescricao_w,
	ds_enfermagem_w;
EXIT WHEN NOT FOUND; /* apply on C13 */

	insert into w_relat_vipe(nr_sequencia,
			 nr_seq_apresent,
			 nr_atendimento,
			 cd_item,
			 ds_item,
			 ie_tipo_item,
			 ds_tipo_item,
			 ds_dosagem,
			 ds_prescricao,
			 ds_enfermagem,
			 dt_atualizacao,
			 nm_usuario)
		values (nextval('w_relat_vipe_seq'),
			 13,
			 nr_atendimento_p,
			 cd_item_w,
			 ds_item_w,
			 'L',
			 'Coletas',
			 ds_dosagem_w,
			 ds_prescricao_w,
			 ds_enfermagem_w,
			 clock_timestamp(),
			 nm_usuario_p);

end loop;
close C13;

open C14;
loop
fetch C14 into
	nr_prescricao_w,
	nr_seq_item_w,
	ds_item_w,
	ds_dosagem_w,
	ds_prescricao_w;
EXIT WHEN NOT FOUND; /* apply on C14 */

	insert into w_relat_vipe(nr_sequencia,
			 nr_seq_apresent,
			 nr_atendimento,
			 cd_item,
			 ds_item,
			 ie_tipo_item,
			 ds_tipo_item,
			 ds_dosagem,
			 ds_prescricao,
			 ds_enfermagem,
			 dt_atualizacao,
			 nm_usuario)
		values (nextval('w_relat_vipe_seq'),
			 14,
			 nr_atendimento_p,
			 null,
			 ds_item_w,
			 'GAS',
			 'Gasoterapia',
			 ds_dosagem_w,
			 ds_prescricao_w,
			 null,
			 clock_timestamp(),
			 nm_usuario_p);

end loop;
close C14;

open C15;
loop
fetch C15 into
	nr_prescricao_w,
	nr_seq_item_w,
	cd_item_w,
	ds_item_w,
	ds_dosagem_w,
	ds_prescricao_w,
	ds_enfermagem_w;
EXIT WHEN NOT FOUND; /* apply on C15 */

	insert into w_relat_vipe(nr_sequencia,
			 nr_seq_apresent,
			 nr_atendimento,
			 cd_item,
			 ds_item,
			 ie_tipo_item,
			 ds_tipo_item,
			 ds_dosagem,
			 ds_prescricao,
			 ds_enfermagem,
			 dt_atualizacao,
			 nm_usuario)
		values (nextval('w_relat_vipe_seq'),
			 15,
			 nr_atendimento_p,
			 cd_item_w,
			 ds_item_w,
			 'R',
			 'Recomendações/Ordens',
			 ds_dosagem_w,
			 ds_prescricao_w,
			 ds_enfermagem_w,
			 clock_timestamp(),
			 nm_usuario_p);

end loop;
close C15;

open C16;
loop
fetch C16 into
	nr_prescricao_w,
	nr_seq_item_w,
	ds_item_w,
	ds_dosagem_w,
	ds_prescricao_w,
	ds_enfermagem_w;
EXIT WHEN NOT FOUND; /* apply on C16 */

	insert into w_relat_vipe(nr_sequencia,
			 nr_seq_apresent,
			 nr_atendimento,
			 cd_item,
			 ds_item,
			 ie_tipo_item,
			 ds_tipo_item,
			 ds_dosagem,
			 ds_prescricao,
			 ds_enfermagem,
			 dt_atualizacao,
			 nm_usuario)
		values (nextval('w_relat_vipe_seq'),
			 16,
			 nr_atendimento_p,
			 null,
			 ds_item_w,
			 'MD',
			 'Diálise',
			 ds_dosagem_w,
			 ds_prescricao_w,
			 ds_enfermagem_w,
			 clock_timestamp(),
			 nm_usuario_p);

end loop;
close C16;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_relat_vipe ( cd_perfil_p bigint, cd_estabelecimento_p bigint, nr_atendimento_p bigint, dt_referencia_p timestamp, ie_exibir_realizados_p text, ie_exibir_suspensos_p text, nm_usuario_p text) FROM PUBLIC;

