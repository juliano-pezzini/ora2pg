-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_concentracao_dil ( cd_material_p bigint, cd_reconstituinte_p bigint, qt_reconstituinte_p INOUT bigint, cd_unid_med_reconst_p text, qt_concentracao_p bigint, cd_unid_med_base_p text, cd_unid_med_cons_p text) AS $body$
DECLARE



cd_unid_med_concentracao_w	varchar(30);
cd_unid_med_base_conc_w		varchar(30);
qt_conversao_mg_w		double precision;
cd_material_w			integer;
qt_conv_ww			double precision;
qt_conv_w			double precision;
qt_conv_ml_w			double precision;
qt_conv_mg_w			double precision;
qt_caract_neg_w			smallint:= 0;


BEGIN

select	cd_material,
	cd_unid_med_concetracao,
	cd_unid_med_base_conc,
	qt_conversao_mg
into STRICT	cd_material_w,
	cd_unid_med_concentracao_w,
	cd_unid_med_base_conc_w,
	qt_conversao_mg_w
from	material
where	cd_material	= cd_material_p;

qt_conv_w    := obter_conversao_ml(cd_material_w, obter_conversao_unid_med(cd_material_w, cd_unid_med_base_conc_w), cd_unid_med_base_conc_w);

qt_conv_mg_w	:= obter_conversao_unid_med(cd_material_w,obter_unid_med_usua('mg'));
qt_conv_ml_w	:= obter_conversao_unid_med(cd_material_w,obter_unid_med_usua('ml'));

begin
qt_conv_ww	:= dividir(qt_conv_mg_w	- (qt_conv_ml_w * qt_concentracao_p), qt_concentracao_p);
exception when others then
qt_conv_ww := null;
end;

qt_caract_neg_w := position('-' in qt_conv_ww);

if (qt_conv_ww IS NOT NULL AND qt_conv_ww::text <> '') and (qt_caract_neg_w  > 0) then
	begin
	qt_conv_ww	:= replace(qt_conv_ww, '-', '');
	end;
end if;

qt_reconstituinte_p	:= qt_conv_ww;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_concentracao_dil ( cd_material_p bigint, cd_reconstituinte_p bigint, qt_reconstituinte_p INOUT bigint, cd_unid_med_reconst_p text, qt_concentracao_p bigint, cd_unid_med_base_p text, cd_unid_med_cons_p text) FROM PUBLIC;

