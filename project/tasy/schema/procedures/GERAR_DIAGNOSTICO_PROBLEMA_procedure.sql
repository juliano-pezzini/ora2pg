-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_diagnostico_problema ( nr_seq_problema_p bigint, nr_atendimento_p bigint, cd_doenca_p text, cd_medico_p text, nm_usuario_p text, ie_tipo_diagnostico_p bigint default 2, ie_classificacao_doenca_p text default 'S', dt_liberacao_p timestamp default null, ie_main_enc_probl_p text default 'N') AS $body$
DECLARE


qt_tempo_w          bigint;
ie_tipo_doenca_w    varchar(2);
ie_unidade_tempo_w  varchar(2);
dt_diagnostico_w	timestamp;
nr_atendimento_ww   bigint;
cd_doenca_ww        varchar(10);
nr_seq_interno_w	bigint;
qt_diag_w			bigint;


BEGIN

select	max(b.nr_atendimento),
		max(b.cd_doenca),
		max(qt_tempo),
		max(ie_tipo_doenca), 
		max(ie_unidade_tempo) 
into STRICT	nr_atendimento_ww,
		cd_doenca_ww,	
		qt_tempo_w,
		ie_tipo_doenca_w,
		ie_unidade_tempo_w
from	diagnostico_doenca b,
		atendimento_paciente a
where	a.cd_pessoa_fisica = (	SELECT	cd_pessoa_fisica
								from	atendimento_paciente where		nr_atendimento = nr_atendimento_p LIMIT 1)
and		a.nr_atendimento = b.nr_atendimento
and		cd_doenca = cd_doenca_p;

select	max(dt_diagnostico)
into STRICT	dt_diagnostico_w
from	diagnostico_medico
where	pkg_date_utils.start_of(dt_diagnostico,'DD',0)	= pkg_date_utils.start_of(clock_timestamp(),'DD',0)
and		nr_atendimento		= nr_atendimento_p
and		cd_medico		= cd_medico_p;

if (coalesce(dt_diagnostico_w::text, '') = '') then
	dt_diagnostico_w	:= clock_timestamp();
	insert into diagnostico_medico(
					nr_atendimento,
					dt_diagnostico,
					ie_tipo_diagnostico,
					cd_medico,
					dt_atualizacao,
					nm_usuario,
					ds_diagnostico
				) values (	
					nr_atendimento_p,
					dt_diagnostico_w,
					coalesce(ie_tipo_diagnostico_p,2),
					cd_medico_p,
					clock_timestamp(),
					nm_usuario_p,
					null);
end if;

Select 	nextval('diagnostico_doenca_seq')
into STRICT	nr_seq_interno_w
;
	
insert into diagnostico_doenca(
				nr_atendimento,
				dt_diagnostico, 
				cd_doenca, 
				dt_atualizacao, 
				nm_usuario, 
				ds_diagnostico, 
				ie_classificacao_doenca,
				ie_tipo_diagnostico,
				dt_liberacao,
				ie_situacao,
				qt_tempo,
				ie_tipo_doenca,
				ie_unidade_tempo,
				nr_seq_interno,
                		ie_main_enc_probl)
SELECT	nr_atendimento_p,
		dt_diagnostico_w,
		cd_doenca_p,
		clock_timestamp(),
		nm_usuario_p,
		null,
		coalesce(ie_classificacao_doenca_p,'S'),
		coalesce(ie_tipo_diagnostico_p,2),
		dt_liberacao_p,
		'A',
		qt_tempo_w,
		ie_tipo_doenca_w,
		ie_unidade_tempo_w,
		nr_seq_interno_w,
        	ie_main_enc_probl_p

where	not exists (	SELECT	1
					from	diagnostico_doenca where		nr_atendimento	= nr_atendimento_p
					and		cd_doenca	= cd_doenca_p
					and		dt_diagnostico	= dt_diagnostico_w LIMIT 1);

commit;

select  count(1)
into STRICT	qt_diag_w
from	diagnostico_doenca
where	nr_seq_interno = nr_seq_interno_w;

if (coalesce(qt_diag_w,0) > 0) then

	
	insert into lista_problema_pac_item(	nr_sequencia,
											dt_atualizacao,
											dt_atualizacao_nrec,
											nm_usuario,
											nm_usuario_nrec,
											nr_seq_problema,
											nr_seq_registro,
											ie_tipo_registro,
											nm_tabela)
								values (		nextval('lista_problema_pac_item_seq'),
											clock_timestamp(),
											clock_timestamp(),
											nm_usuario_p,
											nm_usuario_p,
											nr_seq_problema_p,
											nr_seq_interno_w,
											'DM',
											'DIAGNOSTICO_DOENCA');
	


end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_diagnostico_problema ( nr_seq_problema_p bigint, nr_atendimento_p bigint, cd_doenca_p text, cd_medico_p text, nm_usuario_p text, ie_tipo_diagnostico_p bigint default 2, ie_classificacao_doenca_p text default 'S', dt_liberacao_p timestamp default null, ie_main_enc_probl_p text default 'N') FROM PUBLIC;

