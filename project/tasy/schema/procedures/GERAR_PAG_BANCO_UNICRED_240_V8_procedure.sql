-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_pag_banco_unicred_240_v8 (nr_seq_envio_p bigint, cd_estabelecimento_p text, nm_usuario_p text) AS $body$
DECLARE


-- Header do Arquivo
nr_seq_registro_w		varchar(10) := 0;
ds_conteudo_w			varchar(240);
nr_seq_arquivo_w		bigint	:= 0;
nr_inscricao_w			varchar(14);
cd_convenio_banco_w		varchar(20);
cd_agencia_w			varchar(5);
cd_conta_w			varchar(12);
nr_digito_conta_w		varchar(1);
nm_empresa_w			varchar(30);
ds_banco_w			varchar(30);
dt_arquivo_w			varchar(8);
hr_arquivo_w			varchar(6);
nm_pessoa_w			varchar(30);
cd_pf_w  			varchar(11);
cd_cnpj_w            varchar(14);

-- Header do Lote
ie_forma_lancamento_w		varchar(2);
nr_inscricao_lote_w		varchar(14);
ds_endereco_w			varchar(30);
nr_endereco_w			varchar(5);
ds_complemento_w		varchar(15);
ds_cidade_w			varchar(20);
cd_cep_w			varchar(8);
sg_estado_w			varchar(15);
ds_ocorrencia_w			varchar(10);
nr_lote_w			varchar(4)	:= 0;
nr_seq_lote_a_w			varchar(5)	:= 0;
nr_lote_servico_w	bigint;

-- Detalhe Documento - Segmento A
cd_compensacao_w		varchar(3);
cd_banco_favorecido_w		varchar(3);
cd_agencia_favorecido_w		varchar(5);
ie_digito_agencia_w		varchar(1);
nr_conta_favorecido_w		varchar(12);
nr_digito_conta_hsbc_w       varchar(2);
nr_digito_agencia_w		varchar(1);
nm_favorecido_w			varchar(30);
nr_documento_w			varchar(20);
dt_pagamento_w			varchar(8);
vl_pagamento_w			varchar(15);
nr_documento_banco_w		varchar(20);
dt_real_pagamento_w		varchar(8);
vl_real_pagamento_w		varchar(15);
cd_tipo_movimento_w		varchar(1);
vl_pagamento_number_w		double precision;
ie_tipo_servico_w		varchar(5);
ie_tipo_servico_arq_w		varchar(2);

-- Detalhe Documento - Segmento B
ie_tipo_favorecido_w		varchar(1);
cd_favorecido_w			varchar(14);
ds_bairro_w			varchar(15);
cd_cep_b_w			varchar(8);
dt_vencimento_w			varchar(8);
vl_documento_w			varchar(15);
vl_liquidacao_w			varchar(15);
vl_acrescimo_w			varchar(15);
vl_desconto_w			varchar(15);
vl_multa_w			varchar(15);
nr_seq_lote_b_w			varchar(5)	:= 1;
qt_cursor_w			smallint 	:= 0;
vl_documento_number_w		double precision;

-- Trailer do Lote
nr_titulo_w			bigint;
vl_detalhes_w			double precision	:= 0;
vl_total_detalhes_w		double precision	:= 0;

-- Trailer do Arquivo
qt_registros_lote_w		bigint	:= 0;
qt_registros_total_w		bigint	:= 0;

-- Brancos
ds_brancos_9_w			varchar(9);
ds_brancos_19_w			varchar(19);
ds_brancos_20_w			varchar(20);
ds_brancos_40_w			varchar(40);
ds_brancos_8_w			varchar(8);
ds_brancos_10_w			varchar(10);
ds_brancos_3_w			varchar(3);
ds_brancos_11_w			varchar(11);
ds_brancos_211_w		varchar(211);
ds_brancos_165_w		varchar(165);
ds_brancos_54_w			varchar(54);
ds_brancos_2_w			varchar(2);
ds_brancos_15_w			varchar(15);
ds_brancos_12_w			varchar(12);
ds_brancos_6_w			varchar(6);
ds_brancos_38_w			varchar(38);
nr_sequencia_w			bigint;
cd_banco_w			varchar(5);
nr_seq_lote_j_w			bigint;
nr_bloqueto_w			varchar(44);
nr_nosso_numero_w		varchar(20);
cd_moeda_w			varchar(2);
cd_ocorrencia_w			varchar(10);
ie_tipo_pagamento_w		varchar(3);
qt_reg_ab_w			bigint := 0;
qt_reg_j_w			bigint := 0;
qt_reg_escrit_w			bigint := 0;
qt_reg_total_w			bigint := 0;
cd_pessoa_fisica_w		varchar(10);
cd_cgc_w			varchar(14);
cd_pessoa_pf_pj_w		varchar(255);
ie_favorecido_w			varchar(255);
ie_tipo_pagamento_ww		varchar(3);
nr_conta_w			varchar(20);
nr_lotes_w			integer := 0;
qt_cont_w			bigint := 0;
cd_ocorrencia_pag_w		varchar(2);
ie_ocorrencia_w			varchar(1);

-- Detalhe Documento - Segmento A
C02 CURSOR FOR
	SELECT	d.nr_titulo nr_titulo,
		cd_camara_compensacao cd_compensacao,
		lpad(coalesce(c.cd_banco,'0'),3,'0') cd_banco_favorecido,
		lpad(coalesce(c.cd_agencia_bancaria,'0'),5,'0') cd_agencia_favorecido,
		coalesce(substr(c.ie_digito_agencia,1,1),'0') ie_digito_agencia,
		lpad(coalesce(c.nr_conta,'0'),12,'0') nr_conta_favorecido,
		coalesce(CASE WHEN coalesce(c.cd_banco,'0')=399 THEN substr(c.ie_digito_conta,1,2)  ELSE substr(c.ie_digito_conta,1,1) END ,'0')  nr_digito_conta,
		coalesce(substr(c.ie_digito_agencia,1,1),'0') nr_digito_agencia,
		rpad(upper(substr(coalesce(d.nm_favorecido,' '),1,30)),30,' ') nm_favorecido,
		d.nr_titulo nr_documento,
		to_char(a.dt_remessa_retorno, 'DDMMYYYY') dt_pagamento,
		replace(to_char(coalesce(d.vl_saldo_titulo,0), 'fm0000000000000.00'),'.','') vl_pagamento,
		lpad(coalesce(d.nr_documento,'0'),20,'0') nr_documento_banco,
		to_char(a.dt_remessa_retorno, 'DDMMYYYY') dt_real_pagamento,
		replace(to_char(coalesce(d.vl_saldo_titulo,0), 'fm0000000000000.00'),'.','') vl_real_pagamento,
		lpad(coalesce(CASE WHEN coalesce(c.cd_ocorrencia_ret::text, '') = '' THEN '0' WHEN c.cd_ocorrencia_ret=01 THEN '0' WHEN c.cd_ocorrencia_ret=02 THEN '5' WHEN c.cd_ocorrencia_ret=03 THEN '9' END ,'0'),1,'0') cd_tipo_movimento,
		coalesce((obter_dados_tit_escrit(c.nr_titulo,c.nr_seq_escrit,'VL'))::numeric ,0) vl_pagamento_number,
		c.ie_tipo_pagamento,
		d.cd_pessoa_pf_pj,
		d.ie_favorecido,
		c.nr_conta,
		c.cd_ocorrencia,
		c.ie_tipo_servico
	from	estabelecimento e,
		banco_estabelecimento_v b,
		banco_escritural a,
		titulo_pagar_v2 d,
		titulo_pagar_escrit c
	where	c.nr_titulo		= d.nr_titulo
	and	a.nr_sequencia		= c.nr_seq_escrit
	and	a.cd_estabelecimento	= e.cd_estabelecimento
	and	b.nr_sequencia		= a.nr_seq_conta_banco
	and 	c.ie_tipo_pagamento 	in ('CC','CHQ','OP','DOC','TED')
	and	a.nr_sequencia		= nr_seq_envio_p;

-- Detalhe Documento - Segmento B
C03 CURSOR FOR
	SELECT	coalesce(d.ie_tipo_favorecido,'0') ie_tipo_favorecido,
		lpad(coalesce(d.cd_favorecido, ' '),14, '0') cd_favorecido,
		rpad(upper(coalesce(substr(d.ds_endereco,1,30),' ')),30, ' ') ds_endereco,
		rpad(coalesce(d.nr_endereco,'0'),5,' ') nr_endereco,
		rpad(upper(coalesce(substr(d.ds_bairro,1,15),' ')),15,' ') ds_bairro,
		rpad(upper(coalesce(substr(d.ds_cidade,1,20),' ')),20,' ') ds_cidade,
		lpad(coalesce(d.cd_cep, ' '),8,' ') cd_cep,
		coalesce(d.ds_estado,'  ') sg_estado,
		to_char(coalesce(d.dt_vencimento_atual,clock_timestamp()),'DDMMYYYY') dt_vencimento,
		replace(to_char(coalesce(d.vl_saldo_titulo,0), 'fm0000000000000.00'),'.','')	vl_documento,
		replace(to_char(coalesce(c.vl_liquidacao,0), 'fm0000000000000.00'),'.','') vl_liquidacao,
		replace(to_char(coalesce(c.vl_acrescimo,0), 'fm0000000000000.00'),'.','') vl_acrescimo,
		replace(to_char(coalesce(c.vl_desconto,0), 'fm0000000000000.00'),'.','') vl_desconto,
		replace(to_char(coalesce(c.vl_multa,0), 'fm0000000000000.00'),'.','') vl_multa,
		d.vl_saldo_titulo vl_documento_number
	from	estabelecimento e,
		banco_estabelecimento_v b,
		banco_escritural a,
		titulo_pagar_v2 d,
		titulo_pagar_escrit c
	where	c.nr_titulo		= d.nr_titulo
	and	a.nr_sequencia		= c.nr_seq_escrit
	and	a.cd_estabelecimento	= e.cd_estabelecimento
	and	b.nr_sequencia		= a.nr_seq_conta_banco
	and 	c.ie_tipo_pagamento 	in ('CC','CHQ','OP','DOC','TED')
	and	a.nr_sequencia		= nr_seq_envio_p
	and	c.nr_titulo		= nr_titulo_w;

-- Detalhe TÃ­tulo - Segmento J
C01 CURSOR FOR
	SELECT	coalesce(d.ie_tipo_favorecido,'0') ie_tipo_favorecido,
		lpad(coalesce(d.cd_favorecido, ' '),14, '0') cd_favorecido,
		rpad(upper(coalesce(substr(d.ds_endereco,1,30),' ')),30, ' ') ds_endereco,
		rpad(coalesce(d.nr_endereco,'0'),5,' ') nr_endereco,
		rpad(upper(coalesce(substr(d.ds_bairro,1,15),' ')),15,' ') ds_bairro,
		rpad(upper(coalesce(substr(d.ds_cidade,1,20),' ')),20,' ') ds_cidade,
		lpad(coalesce(d.cd_cep, ' '),8,' ') cd_cep,
		coalesce(d.ds_estado,'  ') sg_estado,
		to_char(coalesce(d.dt_vencimento_atual,clock_timestamp()),'DDMMYYYY') dt_vencimento,
		replace(to_char(coalesce(d.vl_saldo_titulo,0), 'fm0000000000000.00'),'.','')	vl_documento,
		replace(to_char(coalesce(c.vl_liquidacao,0), 'fm0000000000000.00'),'.','') vl_liquidacao,
		replace(to_char(coalesce(c.vl_acrescimo,0) + coalesce(c.vl_multa,0), 'fm0000000000000.00'),'.','') vl_acrescimo,
		replace(to_char(coalesce(c.vl_desconto,0), 'fm0000000000000.00'),'.','') vl_desconto,
		d.vl_saldo_titulo vl_documento_number,
		substr(d.nr_bloqueto,1,44) nr_bloqueto,
		rpad(upper(substr(coalesce(d.nm_favorecido,' '),1,30)),30,' ') nm_favorecido,
		rpad(coalesce(to_char(d.cd_pessoa_pf_pj),' '),20,' ') nr_documento,
		rpad(coalesce(coalesce(d.nr_nosso_numero,d.nr_documento),' '),20,' ') nr_nosso_numero,
		'09' cd_moeda,
		lpad(coalesce(c.cd_ocorrencia,' '),10,' ') cd_ocorrencia,
		c.cd_ocorrencia
	from	estabelecimento e,
		banco_estabelecimento_v b,
		banco_escritural a,
		titulo_pagar_v2 d,
		titulo_pagar_escrit c
	where	c.nr_titulo		= d.nr_titulo
	and	a.nr_sequencia		= c.nr_seq_escrit
	and	a.cd_estabelecimento	= e.cd_estabelecimento
	and	b.nr_sequencia		= a.nr_seq_conta_banco
	and 	c.ie_tipo_pagamento 	= 'BLQ'
	and	a.nr_sequencia		= nr_seq_envio_p;



BEGIN

delete from w_envio_banco
where nm_usuario = nm_usuario_p;

select	count(1)
into STRICT	qt_reg_ab_w
from	titulo_pagar_escrit c,
	banco_escritural a
where	a.nr_sequencia		= c.nr_seq_escrit
and 	c.ie_tipo_pagamento 	in ('CC','CHQ','OP','DOC','TED')
and	a.nr_sequencia		= nr_seq_envio_p  LIMIT 1;

select	count(1)
into STRICT	qt_reg_j_w
from	titulo_pagar_escrit c,
	banco_escritural a
where	a.nr_sequencia		= c.nr_seq_escrit
and 	c.ie_tipo_pagamento 	= 'BLQ'
and	a.nr_sequencia		= nr_seq_envio_p  LIMIT 1;


select	lpad(' ',9,' '),
	lpad(' ',19,' '),
	lpad(' ',20,' '),
	lpad(' ',40,' '),
	lpad(' ',8,' '),
	lpad(' ',10,' '),
	lpad(' ',3,' '),
	lpad(' ',11,' '),
	lpad(' ',211,' '),
	lpad(' ',165,' '),
	lpad(' ',54,' '),
	lpad(' ',2,' '),
	lpad(' ',15,' '),
	lpad(' ',12,' '),
	lpad(' ',6,' '),
	lpad(' ',38,' ')
into STRICT	ds_brancos_9_w,
	ds_brancos_19_w,
	ds_brancos_20_w,
	ds_brancos_40_w,
	ds_brancos_8_w,
	ds_brancos_10_w,
	ds_brancos_3_w,
	ds_brancos_11_w,
	ds_brancos_211_w,
	ds_brancos_165_w,
	ds_brancos_54_w,
	ds_brancos_2_w,
	ds_brancos_15_w,
	ds_brancos_12_w,
	ds_brancos_6_w,
	ds_brancos_38_w
;

-- Header do Arquivo
select	lpad(coalesce(a.cd_cgc,'0'),14,'0') nr_inscricao,
	lpad(g.cd_convenio_banco,20,'0') cd_convenio_banco,
	lpad(somente_numero(coalesce(g.cd_agencia_bancaria,0)),5,'0') cd_agencia,
	lpad(coalesce(g.cd_conta,'0'),12,'0') cd_conta,
	coalesce(substr(g.ie_digito_conta,1,1),' ') nr_digito_conta,
	rpad(coalesce(substr(upper(p.ds_razao_social),1,30),' '),30,' ') nm_empresa,
	rpad(coalesce(substr(upper(g.ds_banco),1,30),' '),30,' ')	ds_banco,
	to_char(clock_timestamp(),'DDMMYYYY') dt_arquivo,
	to_char(clock_timestamp(),'HH24MISS') hr_arquivo,
	e.cd_banco
into STRICT	nr_inscricao_w,
	cd_convenio_banco_w,
	cd_agencia_w,
	cd_conta_w,
	nr_digito_conta_w,
	nm_empresa_w,
	ds_banco_w,
	dt_arquivo_w,
	hr_arquivo_w,
	cd_banco_w
from	estabelecimento a,
	banco_estabelecimento_v g,
	pessoa_juridica p,
	banco_escritural e
where	e.cd_estabelecimento   	= a.cd_estabelecimento
and	a.cd_cgc		= p.cd_cgc
and	g.nr_sequencia		= e.nr_seq_conta_banco
and	e.nr_sequencia		= nr_seq_envio_p;

select	coalesce(cd_banco_externo,cd_banco_w)
into STRICT	cd_banco_w
from	banco
where	cd_banco = cd_banco_w;

select	nextval('w_envio_banco_seq')
into STRICT	nr_sequencia_w
;

nr_seq_arquivo_w := nr_seq_arquivo_w + 1;
qt_cont_w := qt_cont_w + 1;

ds_conteudo_w :=	lpad(cd_banco_w,3,'0') ||
					'0000' ||
					'0' ||
					ds_brancos_9_w ||
					'2' ||
					nr_inscricao_w ||
					cd_convenio_banco_w ||
					cd_agencia_w ||
					'2' ||
					cd_conta_w ||
					nr_digito_conta_w ||
					' ' ||
					nm_empresa_w ||
					ds_banco_w ||
					ds_brancos_10_w ||
					'1' ||
					dt_arquivo_w ||
					hr_arquivo_w ||
					lpad(nr_seq_arquivo_w,6,'0') ||
					'084' ||
					'00000' ||
					ds_brancos_54_w ||
					'   ' ||
					ds_brancos_12_w;

insert into w_envio_banco(	nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_estabelecimento,
		ds_conteudo,
		nr_seq_apres)
values (	nr_sequencia_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_p,
		ds_conteudo_w,
		qt_cont_w);

qt_registros_total_w := qt_registros_total_w + 1;
-- Fim - Header do Arquivo
-- Segmentos A e B
if (qt_reg_ab_w > 0) then
	nr_lotes_w := nr_lotes_w + 1;

	-- Header do Lote
	select	'01' ie_forma_lancamento,
		lpad(coalesce(e.cd_cgc,'0'),14,'0') nr_inscricao,
		lpad(b.cd_convenio_banco,20,'0') cd_convenio_banco,
		lpad(somente_numero(coalesce(b.cd_agencia_bancaria,0)),5,'0') cd_agencia,
		lpad((coalesce(b.cd_conta,0))::numeric ,12,'0') cd_conta,
		coalesce(substr(b.ie_digito_conta,1,1),' ') nr_digito_conta,
		rpad(coalesce(substr(upper(j.ds_razao_social),1,30),' '),30,' ') nm_empresa,
		rpad(coalesce(substr(upper(j.ds_endereco),1,30),' '),30,' ') ds_endereco,
		lpad(coalesce(substr(j.nr_endereco,1,5),' '),5,'0') nr_endereco,
		rpad(coalesce(substr(j.ds_complemento,1,15), ' '),15,' ') ds_complemento,
		rpad(coalesce(substr(j.ds_municipio,1,20), ' '),20,' ') ds_cidade,
		rpad(coalesce(substr(somente_numero(j.cd_cep),1,8),' '),8,' ') cd_cep,
		coalesce(j.sg_estado,'  ') sg_estado
	into STRICT	ie_forma_lancamento_w,
		nr_inscricao_lote_w,
		cd_convenio_banco_w,
		cd_agencia_w,
		cd_conta_w,
		nr_digito_conta_w,
		nm_empresa_w,
		ds_endereco_w,
		nr_endereco_w,
		ds_complemento_w,
		ds_cidade_w,
		cd_cep_w,
		sg_estado_w
	from	pessoa_juridica j,
		estabelecimento e,
		banco_estabelecimento_v b,
		banco_escritural a
	where	e.cd_cgc		= j.cd_cgc
	and	a.cd_estabelecimento    = e.cd_estabelecimento
	and	b.nr_sequencia		= a.nr_seq_conta_banco
	and	a.nr_sequencia		= nr_seq_envio_p;


	select	nextval('w_envio_banco_seq')
	into STRICT	nr_sequencia_w
	;

	nr_lote_w := nr_lote_w + 1;
	qt_cont_w := qt_cont_w + 1;
	nr_lote_servico_w	:= coalesce(nr_lote_servico_w,0) + 1;

	ds_conteudo_w :=	lpad(cd_banco_w,3,'0') || -- 1 a 3
						lpad(nr_lote_servico_w,4,'0') || --4 a 7
						'1' || --8
						'R' || --9
						'01'|| -- 10 a 11
						'03'|| -- 12 a 13 Fixo para Unimed Blumenau
						'043' || --14 a 16
						' ' || --17
						'2' || --18
						nr_inscricao_lote_w ||
						cd_convenio_banco_w ||
						cd_agencia_w ||
						'2' ||
						cd_conta_w ||
						nr_digito_conta_w
						|| ' ' ||
						nm_empresa_w ||
						ds_brancos_40_w ||
						ds_endereco_w ||
						nr_endereco_w ||
						ds_complemento_w ||
						ds_cidade_w ||
						cd_cep_w ||
						substr(sg_estado_w,1,2) ||
						ds_brancos_8_w ||
						ds_brancos_10_w;

	insert into w_envio_banco(	nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_estabelecimento,
			ds_conteudo,
			nr_seq_apres)
	values (	nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_estabelecimento_p,
			ds_conteudo_w,
			qt_cont_w);

	qt_registros_total_w 	:= qt_registros_total_w + 1;
	qt_registros_lote_w 	:= qt_registros_lote_w + 1;
	-- Fim - Header do Lote
	vl_total_detalhes_w := 0;
	vl_pagamento_number_w := 0;
	vl_detalhes_w := 0;

	-- Detalhe Documento - Segmento A
	open C02;
	loop
	fetch C02 into
		nr_titulo_w,
		cd_compensacao_w,
		cd_banco_favorecido_w,
		cd_agencia_favorecido_w,
		ie_digito_agencia_w,
		nr_conta_favorecido_w,
		nr_digito_conta_hsbc_w,
		nr_digito_agencia_w,
		nm_favorecido_w,
		nr_documento_w,
		dt_pagamento_w,
		vl_pagamento_w,
		nr_documento_banco_w,
		dt_real_pagamento_w,
		vl_real_pagamento_w,
		cd_tipo_movimento_w,
		vl_pagamento_number_w,
		ie_tipo_pagamento_w,
		cd_pessoa_pf_pj_w,
		ie_favorecido_w,
		nr_conta_w,
		cd_ocorrencia_pag_w,
		ie_tipo_servico_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		vl_total_detalhes_w	:= vl_total_detalhes_w + vl_pagamento_number_w;

		if (ie_favorecido_w = '1') then
			cd_pessoa_fisica_w := null;
			cd_cgc_w := cd_pessoa_pf_pj_w;

		elsif (ie_favorecido_w = '2') then
			cd_pessoa_fisica_w := cd_pessoa_pf_pj_w;
			cd_cgc_w := null;
		end if;

		ie_tipo_pagamento_ww := obter_tipo_pag_escrit_regra(vl_pagamento_number_w,cd_pessoa_fisica_w,cd_cgc_w,nr_conta_w);

		select	lpad(CASE WHEN ie_tipo_pagamento_ww='CC' THEN '000'  ELSE CASE WHEN ie_tipo_pagamento_ww='DOC' THEN '700'  ELSE CASE WHEN ie_tipo_pagamento_ww='TED' THEN '018'  ELSE ' ' END  END  END ,3,' ')
		into STRICT	cd_compensacao_w
		;

		select	CASE WHEN cd_ocorrencia_pag_w='01' THEN '0'  ELSE CASE WHEN cd_ocorrencia_pag_w='02' THEN '5'  ELSE CASE WHEN cd_ocorrencia_pag_w='03' THEN '9'  ELSE ' ' END  END  END
		into STRICT	ie_ocorrencia_w
		;

		nr_seq_registro_w := nr_seq_registro_w + 1;
		nr_seq_lote_a_w := nr_seq_lote_a_w + 1;
		qt_cont_w := qt_cont_w + 1;

		--00010           Pagamento Dividendos
		--00020           Pagamento Fornecedores
		--00030           Pagamento SalÃ¡rios
		--00050           Pagamento Sinistros Segurados
		--00060           Pagamento Despesa Viajantes em TrÃ¢nsito
		--00070           Pagamento Autorizados
		--00075           Pagamento Credenciados
		--00080           Pagamento Representantes/Vendedores Autorizados
		--00090           Pagamento de BenefÃ­cios
		--00094           Pagamento de ArrecadaÃ§Ã£o (Prefeituras, Ãgua, Luz, etc.) com barras
		--00095           TelecomunicaÃ§Ãµes - Com cÃ³digo de barras
		--00098           Pagamento Diversos
		case	ie_tipo_servico_w
			when	'00010'	then ie_tipo_servico_arq_w := '04';
			when	'00020'	then ie_tipo_servico_arq_w := '07';
			when 	'00030'	then ie_tipo_servico_arq_w := '06';
			when	'00050'	then ie_tipo_servico_arq_w := '13';
			when	'00060'	then ie_tipo_servico_arq_w := '02';
			when	'00070'	then ie_tipo_servico_arq_w := '13';
			when	'00075'	then ie_tipo_servico_arq_w := '13';
			when	'00080'	then ie_tipo_servico_arq_w := '13';
			when	'00090'	then ie_tipo_servico_arq_w := '16';
			when	'00094'	then ie_tipo_servico_arq_w := '09';
			when	'00095'	then ie_tipo_servico_arq_w := '13';
			when	'00098'	then ie_tipo_servico_arq_w := '13';
			else		ie_tipo_servico_arq_w := '13';
		end case;

		select cd_pessoa_fisica, cd_cgc
		into STRICT cd_pf_w,cd_cnpj_w
		from titulo_pagar
		where nr_titulo = nr_documento_w;

		if (cd_pf_w IS NOT NULL AND cd_pf_w::text <> '') then
			select nr_cpf
			into STRICT nr_documento_w
			from pessoa_fisica
			where cd_pessoa_fisica = cd_pf_w;
		else
			nr_documento_w := cd_cgc_w;
		end if;



		nr_digito_agencia_w := ' ';
		if  ((cd_banco_favorecido_w = '399') and (length(nr_digito_conta_hsbc_w) > 1)) then
			nr_digito_agencia_w := substr(nr_digito_conta_hsbc_w,2,1);
			nr_digito_conta_hsbc_w := substr(nr_digito_conta_hsbc_w,1,1);
		else
			nr_digito_agencia_w := ' ';
		end if;

		ds_conteudo_w :=	lpad(cd_banco_w,3,'0') || /*1 a 3*/
							lpad(nr_lote_servico_w,4,'0') || /*4 a 7*/
							'3' || /*8*/
							lpad(nr_seq_registro_w,5,'0') || --9 a 13
							'A' || --14
							ie_ocorrencia_w || -- 15
							'00' || --16 a 17
							cd_compensacao_w || --18 a 20
							cd_banco_favorecido_w || --21 a 23
							cd_agencia_favorecido_w || --24 a 28
							' '/*ie_digito_agencia_w*/
 || --29
							nr_conta_favorecido_w || --30 a 41
							nr_digito_conta_hsbc_w || --42
							nr_digito_agencia_w ||  -- 43
							nm_favorecido_w || --44 a 73
							rpad(coalesce(to_char(nr_documento_w),' '),20,' ') || --74 a 93
							dt_real_pagamento_w || --94 a 101
							'BRL' ||
							'000000000000000' ||
							rpad(replace(to_char(coalesce(vl_pagamento_number_w,'0'), 'fm0000000000000.00'),'.',''),15,'0') ||
							ds_brancos_20_w ||
							'00000000' ||
							'000000000000000' ||
							ds_brancos_40_w ||
							ie_tipo_servico_arq_w ||
							ds_brancos_10_w ||
							'5' ||
							ds_brancos_10_w;

		select	nextval('w_envio_banco_seq')
		into STRICT	nr_sequencia_w
		;

		insert into w_envio_banco(	nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				cd_estabelecimento,
				ds_conteudo,
				nr_seq_apres)
		values (	nr_sequencia_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				cd_estabelecimento_p,
				ds_conteudo_w,
				qt_cont_w);

		qt_registros_lote_w	:= qt_registros_lote_w + 1;
		qt_registros_total_w 	:= qt_registros_total_w + 1;

		-- Detalhe Documento - Segmento B
		open C03;
		loop
		fetch C03 into
			ie_tipo_favorecido_w,
			cd_favorecido_w,
			ds_endereco_w,
			nr_endereco_w,
			ds_bairro_w,
			ds_cidade_w,
			cd_cep_b_w,
			sg_estado_w,
			dt_vencimento_w,
			vl_documento_w,
			vl_liquidacao_w,
			vl_acrescimo_w,
			vl_desconto_w,
			vl_multa_w,
			vl_documento_number_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			select	nextval('w_envio_banco_seq')
			into STRICT	nr_sequencia_w
			;

			nr_seq_registro_w := nr_seq_registro_w + 1;
			qt_cont_w := qt_cont_w + 1;

			ds_conteudo_w :=	lpad(cd_banco_w,3,'0') || lpad(nr_lote_servico_w,4,'0') || '3' || lpad(nr_seq_registro_w,5,'0') ||
						'B' || ds_brancos_3_w || ie_tipo_favorecido_w || cd_favorecido_w || ds_endereco_w ||
						nr_endereco_w ||ds_brancos_15_w || ds_bairro_w || ds_cidade_w || cd_cep_b_w || substr(sg_estado_w,1,2) ||
						dt_vencimento_w ||vl_documento_w || vl_liquidacao_w || vl_desconto_w || vl_acrescimo_w ||
						vl_multa_w ||rpad(trim(both nr_documento_banco_w),15,' ') || '5' || '000000' || ds_brancos_8_w;

			insert into w_envio_banco(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				cd_estabelecimento,
				ds_conteudo,
				nr_seq_apres)
			values (nr_sequencia_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				cd_estabelecimento_p,
				ds_conteudo_w,
				qt_cont_w);

			qt_registros_lote_w	:= qt_registros_lote_w + 1;
			qt_registros_total_w 	:= qt_registros_total_w + 1;
			nr_seq_lote_b_w := nr_seq_lote_b_w + 1;
			end;
		end loop;
		close C03;
		-- Fim - Detalhe Documento - Segmento B
		end;
	end loop;
	close C02;
	-- Fim - Detalhe Documento - Segmento A
	-- Trailler do Lote
	select	nextval('w_envio_banco_seq')
	into STRICT	nr_sequencia_w
	;

	qt_registros_lote_w	:= qt_registros_lote_w + 1;
	qt_registros_total_w 	:= qt_registros_total_w + 1;
	qt_cont_w := qt_cont_w + 1;

	ds_conteudo_w := 	lpad(cd_banco_w,3,'0') ||
						lpad(nr_lote_servico_w,4, '0') ||
						'5' || ds_brancos_9_w ||
						lpad(qt_registros_lote_w,6,'0') ||
						replace(to_char(coalesce(vl_total_detalhes_w,0), 'fm00000000000000.00'),'.','') ||
						replace(to_char(coalesce(vl_detalhes_w,0), 'fm0000000000000.00000'),'.','') ||
						ds_brancos_6_w ||
						ds_brancos_165_w ||
						ds_brancos_10_w;

	insert into w_envio_banco(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_estabelecimento,
		ds_conteudo,
		nr_seq_apres)
	values (nr_sequencia_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_p,
		ds_conteudo_w,
		qt_cont_w);
	-- Fim - Trailler do Lote
end if;

qt_registros_lote_w := 0;

-- Segmentos J
if (qt_reg_j_w > 0) then
	nr_lotes_w := nr_lotes_w + 1;

	select	'01' ie_forma_lancamento,
		lpad(coalesce(e.cd_cgc,'0'),14,'0') nr_inscricao,
		lpad(b.cd_convenio_banco,20,'0') cd_convenio_banco,
		lpad(somente_numero(coalesce(b.cd_agencia_bancaria,0)),5,'0') cd_agencia,
		lpad((coalesce(b.cd_conta,0))::numeric ,12,'0') cd_conta,
		coalesce(substr(b.ie_digito_conta,1,1),' ') nr_digito_conta,
		rpad(coalesce(substr(upper(j.ds_razao_social),1,30),' '),30,' ') nm_empresa,
		rpad(coalesce(substr(upper(j.ds_endereco),1,30),' '),30,' ') ds_endereco,
		lpad(coalesce(substr(j.nr_endereco,1,5),' '),5,'0') nr_endereco,
		rpad(coalesce(substr(j.ds_complemento,1,15), ' '),15,' ') ds_complemento,
		rpad(coalesce(substr(j.ds_municipio,1,20), ' '),20,' ') ds_cidade,
		rpad(coalesce(substr(somente_numero(j.cd_cep),1,8),' '),8,' ') cd_cep,
		coalesce(j.sg_estado,'  ') sg_estado
	into STRICT	ie_forma_lancamento_w,
		nr_inscricao_lote_w,
		cd_convenio_banco_w,
		cd_agencia_w,
		cd_conta_w,
		nr_digito_conta_w,
		nm_empresa_w,
		ds_endereco_w,
		nr_endereco_w,
		ds_complemento_w,
		ds_cidade_w,
		cd_cep_w,
		sg_estado_w
	from	pessoa_juridica j,
		estabelecimento e,
		banco_estabelecimento_v b,
		banco_escritural a
	where	e.cd_cgc		= j.cd_cgc
	and	a.cd_estabelecimento    = e.cd_estabelecimento
	and	b.nr_sequencia		= a.nr_seq_conta_banco
	and	a.nr_sequencia		= nr_seq_envio_p;

	select	nextval('w_envio_banco_seq')
	into STRICT	nr_sequencia_w
	;

	nr_lote_w := nr_lote_w + 1;
	qt_cont_w := qt_cont_w + 1;
	nr_lote_servico_w	:= coalesce(nr_lote_servico_w,0) + 1;

	ds_conteudo_w :=	lpad(cd_banco_w,3,'0') ||
						lpad(nr_lote_servico_w,4,'0')  ||
						'1' ||
						'C' ||
						'20'||
						'01' ||
						'043' ||
						' ' ||
						'2' ||
						nr_inscricao_lote_w ||
						cd_convenio_banco_w ||
						cd_agencia_w ||
						'2' ||
						cd_conta_w ||
						nr_digito_conta_w ||
						' ' ||
						nm_empresa_w ||
						ds_brancos_40_w ||
						ds_endereco_w ||
						nr_endereco_w ||
						ds_complemento_w ||
						ds_cidade_w ||
						cd_cep_w ||
						substr(sg_estado_w,1,2) ||
						ds_brancos_8_w ||
						ds_brancos_10_w;

	insert into w_envio_banco(	nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_estabelecimento,
			ds_conteudo,
			nr_seq_apres)
	values (	nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_estabelecimento_p,
			ds_conteudo_w,
			qt_cont_w);

	qt_registros_total_w 	:= qt_registros_total_w + 1;
	qt_registros_lote_w 	:= qt_registros_lote_w + 1;
	-- Fim - Header do Lote
	vl_total_detalhes_w := 0;
	vl_documento_number_w := 0;
	vl_detalhes_w := 0;

	-- Detalhe Documento - Segmento J
	open C01;
	loop
	fetch C01 into
		ie_tipo_favorecido_w,
		cd_favorecido_w,
		ds_endereco_w,
		nr_endereco_w,
		ds_bairro_w,
		ds_cidade_w,
		cd_cep_b_w,
		sg_estado_w,
		dt_vencimento_w,
		vl_documento_w,
		vl_liquidacao_w,
		vl_acrescimo_w,
		vl_desconto_w,
		vl_documento_number_w,
		nr_bloqueto_w,
		nm_favorecido_w,
		nr_documento_w,
		nr_nosso_numero_w,
		cd_moeda_w,
		cd_ocorrencia_w,
		cd_ocorrencia_pag_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		vl_total_detalhes_w	:= vl_total_detalhes_w + vl_documento_number_w;

		select	CASE WHEN cd_ocorrencia_pag_w='01' THEN '0'  ELSE CASE WHEN cd_ocorrencia_pag_w='02' THEN '5'  ELSE CASE WHEN cd_ocorrencia_pag_w='03' THEN '9'  ELSE ' ' END  END  END
		into STRICT	ie_ocorrencia_w
		;

		select	nextval('w_envio_banco_seq')
		into STRICT	nr_sequencia_w
		;

		nr_seq_registro_w := nr_seq_registro_w + 1;
		qt_cont_w := qt_cont_w + 1;

		ds_conteudo_w :=	lpad(cd_banco_w,3,'0') ||
							lpad(nr_lote_servico_w,4,'0') ||
							'3' ||
							lpad(nr_seq_registro_w,5,'0') ||
							'J' ||
							ie_ocorrencia_w ||
							'19' ||
							lpad(coalesce(nr_bloqueto_w,' '),44,' ') ||
							nm_favorecido_w ||
							dt_vencimento_w ||
							vl_documento_w ||
							vl_desconto_w ||
							vl_acrescimo_w ||
							ds_brancos_38_w ||
							nr_documento_w ||
							nr_nosso_numero_w ||
							cd_moeda_w ||
							ds_brancos_6_w ||
							cd_ocorrencia_w;

		insert into w_envio_banco(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_estabelecimento,
			ds_conteudo,
			nr_seq_apres)
		values (nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_estabelecimento_p,
			ds_conteudo_w,
			qt_cont_w);


		qt_registros_total_w 	:= qt_registros_total_w + 1;
		qt_registros_lote_w 	:= qt_registros_lote_w + 1;
		nr_seq_lote_j_w := nr_seq_lote_j_w + 1;
		end;
	end loop;
	close C01;
	-- Fim - Detalhe Documento - Segmento J
	-- Trailler do Lote
	select	nextval('w_envio_banco_seq')
	into STRICT	nr_sequencia_w
	;

	qt_registros_lote_w := qt_registros_lote_w + 1;
	qt_registros_total_w := qt_registros_total_w + 1;
	qt_cont_w := qt_cont_w + 1;

	ds_conteudo_w := 	lpad(cd_banco_w,3,'0') ||
						lpad(nr_lote_servico_w,4, '0') ||
						'5' ||
						ds_brancos_9_w ||
						lpad(qt_registros_lote_w,6,'0') ||
						replace(to_char(coalesce(vl_total_detalhes_w,0), 'fm0000000000000000.00'),'.','') ||
						replace(to_char(coalesce(vl_detalhes_w,0), 'fm0000000000000.00000'),'.','') ||
						ds_brancos_6_w ||
						ds_brancos_165_w ||
						ds_brancos_10_w;

	insert into w_envio_banco(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_estabelecimento,
		ds_conteudo,
		nr_seq_apres)
	values (nr_sequencia_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_p,
		ds_conteudo_w,
		qt_cont_w);
	-- Fim - Trailler do Lote
end if;

-- Trailer do Arquivo
select	nextval('w_envio_banco_seq')
into STRICT	nr_sequencia_w
;


qt_registros_total_w := qt_registros_total_w + 1;
qt_cont_w := qt_cont_w + 1;

ds_conteudo_w := 	lpad(cd_banco_w,3,'0') ||
					'9999' ||
					'9' ||
					ds_brancos_9_w ||
					lpad(nr_lotes_w,6,'0') ||
					lpad(qt_registros_total_w,6,'0') ||
					ds_brancos_211_w;

insert into w_envio_banco(	nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_estabelecimento,
		ds_conteudo,
		nr_seq_apres)
values (	nr_sequencia_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_p,
		ds_conteudo_w,
		qt_cont_w);
-- Fim - Trailer do Arquivo
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_pag_banco_unicred_240_v8 (nr_seq_envio_p bigint, cd_estabelecimento_p text, nm_usuario_p text) FROM PUBLIC;

