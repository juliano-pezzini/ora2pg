-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_insert_prescr_proced_reg (( nr_atendimento_p bigint, nr_prescricao_p bigint, nr_sequencia_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_setor_atendimento_p bigint, ie_origem_inf_p text, cd_convenio_p bigint, dt_inicio_prescr_p timestamp, dt_inicio_ret_p out timestamp, cd_pessoa_fisica_p text, ie_copia_diaria_p char default 'N') is qt_procedimento_w cpoe_procedimento.qt_procedimento%type) AS $body$
DECLARE

				
	qt_horas_w  varchar(10);
	dt_fim_ww   timestamp;
	
	
BEGIN	
		/*Tratamento igual ao java e da rotina que insere os medicamentos, +1 para pegar todos os intervalos entre os horarios*/

		select max(trunc((obter_dif_data(dt_inicio, dt_fim,'TM')/60),0))+1,
		       max(dt_fim)
		into STRICT qt_horas_w,
		     dt_fim_ww
		from cpoe_procedimento
		where nr_sequencia = nr_sequencia_p 
		and nr_atendimento = nr_atendimento_p;
		
		if (qt_horas_w > 24 or coalesce(dt_fim_ww::text, '') = '') then
		
		 return;	
		
		else 	
		
		 return;
		
		end if;	
	
	end;



	procedure CPOE_Inserir_medic_assoc is

		dt_inicio_assoc_w				date;

		ie_se_necessario_assoc_w		char(1);
		ie_acm_assoc_w					char(1);

		qt_material_w					prescr_material.qt_material%type;
		cd_unidade_medida_consumo_w		prescr_material.cd_unidade_medida%type;
		qt_total_dispensar_w			prescr_material.qt_total_dispensar%type;
		qt_unitaria_w					prescr_material.qt_unitaria%type;
		ie_regra_disp_w					prescr_material.ie_regra_disp%type;
		ie_checar_adep_assoc_w			prescr_material.ie_checar_adep%type;
		nr_ocorrencia_assoc_w			prescr_material.nr_ocorrencia%type;
		nr_sequencia_assoc_w			prescr_material.nr_sequencia%type;
		ie_origem_inf_mat_assoc_w		prescr_material.ie_origem_inf%type;
		nr_agrup_assoc_w				prescr_material.nr_agrupamento%type;

		cd_material_assoc_w				cpoe_procedimento.cd_mat_proc1%type;
		ie_via_aplicacao_assoc_w		cpoe_procedimento.ie_via_mat_proc1%type;
		qt_dose_assoc_w					cpoe_procedimento.qt_dose_mat1%type;
		cd_unidade_medida_assoc_w		cpoe_procedimento.cd_unid_medida_dose_mat1%type;
		cd_intervalo_assoc_w			cpoe_procedimento.cd_interv_proc1%type;
		hr_prim_horario_assoc_w			cpoe_procedimento.hr_prim_hor_proc1%type;
		ds_horarios_assoc_w				cpoe_procedimento.ds_hor_proc1%type;
		ie_administracao_assoc_w		cpoe_procedimento.ie_adm_mat1%type;
		ie_urgencia_assoc_w				cpoe_procedimento.ie_urgencia_mat1%type;

		qt_diluente_w					prescr_material.qt_material%type;
		cd_unid_med_consumo_dil_w		prescr_material.cd_unidade_medida%type;
		qt_unitaria_diluente_w			prescr_material.qt_unitaria%type;
		qt_total_dispensar_dil_w		prescr_material.qt_total_dispensar%type;
		ie_regra_disp_dil_w				prescr_material.ie_regra_disp%type;
        nr_sequencia_diluente_w         prescr_material.nr_sequencia%type;
		cd_mat_diluente_w				cpoe_procedimento.cd_mat_dil1%type;
		qt_dose_diluente_w				cpoe_procedimento.qt_dose_dil1%type;
		cd_unid_medida_dose_dil_w	    cpoe_procedimento.cd_unid_medida_dose_dil1%type;

        nr_sequencia_recons_w         	prescr_material.nr_sequencia%type;		
		qt_total_dispensar_recons_w		prescr_material.qt_total_dispensar%type;
		ie_regra_disp_recons_w			prescr_material.ie_regra_disp%type;		
		cd_mat_recons_w					cpoe_procedimento.cd_mat_recons1%type;
		qt_dose_recons_w				cpoe_procedimento.qt_dose_recons1%type;
		cd_unid_medida_dose_recons_w	cpoe_procedimento.cd_unid_medida_dose_recons1%type;
		nr_seq_prot_glic_w				cpoe_procedimento.nr_seq_prot_glic%type;
		ie_glicemia_w					protocolo_glic_mat_med.ie_glicemia%type;
		
		cMateriaisAssoc CURSOR FOR
			SELECT	cd_material,
					qt_dose,
					ie_via_aplicacao,
					cd_unidade_medida,
					ds_horarios,
					ie_checar_adep,
					cd_intervalo,
					dt_inicio,
					hr_prim_horario,
					coalesce(ie_administracao,'P'),
					ie_urgencia,
					cd_diluente,
					qt_dose_diluente,
					cd_unidade_medida_diluente,
					cd_reconst,
					qt_dose_reconst,
					cd_unidade_medida_reconst,
					nr_seq_prot_glic
			from	cpoe_material_proced_v
			where	nr_seq_proced = nr_sequencia_p
			and		((nr_atendimento = nr_atendimento_p) or (cd_pessoa_fisica = cd_pessoa_fisica_p));

	begin
		select	coalesce(max(nr_sequencia),0),
				coalesce(max(nr_agrupamento),0)
		into STRICT	nr_sequencia_assoc_w,
				nr_agrup_assoc_w
		from	prescr_material
		where	nr_prescricao = nr_prescricao_p;

		open cMateriaisAssoc;
		loop
		fetch cMateriaisAssoc into
			cd_material_assoc_w,
			qt_dose_assoc_w,
			ie_via_aplicacao_assoc_w,
			cd_unidade_medida_assoc_w,
			ds_horarios_assoc_w,
			ie_checar_adep_assoc_w,
			cd_intervalo_assoc_w,
			dt_inicio_assoc_w,
			hr_prim_horario_assoc_w,
			ie_administracao_assoc_w,
			ie_urgencia_assoc_w,
			cd_mat_diluente_w,
			qt_dose_diluente_w,
			cd_unid_medida_dose_dil_w,
			cd_mat_recons_w,
			qt_dose_recons_w,
			cd_unid_medida_dose_recons_w,
			nr_seq_prot_glic_w;			
		EXIT WHEN NOT FOUND; /* apply on cMateriaisAssoc */
			begin
			nr_sequencia_assoc_w	:= nr_sequencia_assoc_w + 1;
			nr_agrup_assoc_w		:= nr_agrup_assoc_w + 1;
			
			select	max(nr_sequencia),
					max(dt_lib_suspensao)
			into STRICT	nr_seq_mat_cpoe_assoc_w,
					dt_lib_suspensao_w
			from	cpoe_material
			where	nr_seq_procedimento = nr_sequencia_p
			and		cd_material = cd_material_assoc_w;
			
			if (dt_lib_suspensao_w IS NOT NULL AND dt_lib_suspensao_w::text <> '') then
				goto proximo_associado;
			end if;
						
			-- Inicialmente, sera assumida a data de inicio do procedimento para os materiais associados.
			if (ie_checar_adep_assoc_w = 'S') then			
				ie_calcula_horarios_w	:= false;

				-- Itens ACM e SN nao possuem 1 horario, definir inicio do item para execucao da geracao.
				if (ie_administracao_w <> 'P') then
					begin
					if (trunc(dt_inicio_assoc_w) > trunc(dt_inicio_base_w)) then
						hr_prim_horario_assoc_w	:= '00:00';
					else
						hr_prim_horario_assoc_w	:= to_char(dt_inicio_base_w,'hh24:mi');
					end if;
					end;
				end if;

				-- Atualiza a data inicio com dia e horario.
				dt_inicio_assoc_w		:= to_date(to_char(dt_inicio_assoc_w,'dd/mm/yyyy ') || hr_prim_horario_assoc_w,'dd/mm/yyyy hh24:mi');

				-- Atualizar data de inicio com a data atual, para itens que a data de inicio ja tenha sido ultrapassada.
				if (dt_inicio_assoc_w < dt_inicio_base_w) then
					-- Assumir data da prescricao para o item
					dt_inicio_assoc_w		:= to_date(to_char(dt_inicio_base_w,'dd/mm/yyyy ') || hr_prim_horario_assoc_w, 'dd/mm/yyyy hh24:mi');

					-- Adicionar um dia, caso o inicio do item, nao caia na data de hoje
					if (dt_inicio_assoc_w < dt_inicio_base_w) then
						dt_inicio_assoc_w	:= dt_inicio_assoc_w+1;
					end if;
					ie_calcula_horarios_w	:= true;
				end if;

				ie_origem_inf_mat_assoc_w		:= ie_origem_inf_p;
				
				select	max(qt_min_intervalo)
				into STRICT	qt_min_intervalo_assoc_w
				from	intervalo_prescricao
				where	cd_intervalo = cd_intervalo_assoc_w;

				nr_ocorrencia_assoc_w := 0;
				
				begin
					cpoe_calcular_horario_prescr(	nr_atendimento_p, cd_intervalo_assoc_w, cd_material_assoc_w, dt_inicio_assoc_w,
													0, qt_min_intervalo_w, nr_ocorrencia_assoc_w, ds_horarios_assoc_w, ds_horarios_aux_w,
													nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null,
													null, null, null, null,
													ceil((dt_fim_w - dt_inicio_assoc_w)*24) );
				exception when others then
					CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG EXCEPTION CPOE_CALCULAR_HORARIO_PRESCR:'|| substr(to_char(sqlerrm),1,2000)
						||' nr_sequencia_p'		|| nr_sequencia_p
						||' nr_atendimento_p '	|| nr_atendimento_p
						||' cd_pessoa_fisica_p '|| cd_pessoa_fisica_p
						||' nr_agrup_assoc_w: '	|| nr_agrup_assoc_w
						||' cd_intervalo_assoc_w:'|| cd_intervalo_assoc_w
						||' cd_material_assoc_w:'|| cd_material_assoc_w
						||' dt_inicio_assoc_w:'	|| to_char(dt_inicio_assoc_w,'dd/mm/yyyy hh24:mi:ss')
						||' qt_min_intervalo_w:'	|| qt_min_intervalo_w
						||' nr_ocorrencia_assoc_w:'|| nr_ocorrencia_assoc_w
						||' ds_horarios_assoc_w:'|| ds_horarios_assoc_w
						||' ds_horarios_aux_w:'	|| ds_horarios_aux_w
						||' nm_usuario_p:'		|| nm_usuario_p
						||' cd_estabelecimento_p:'|| cd_estabelecimento_p,1,2000),
						nr_atendimento_p, 'P', nr_sequencia_p);
				end;	
				
				ds_horarios_assoc_w	:= ds_horarios_assoc_w||ds_horarios_aux_w;

				if (ie_calcula_horarios_w) and (ie_administracao_assoc_w = 'P') then
					nr_ocorrencia_assoc_w		:= 0;
					begin
						SELECT * FROM CPOE_Prever_horarios_futuros(	nr_atendimento_p, nr_prescricao_p, nr_agrup_assoc_w, 'prescr_material', 'nr_agrupamento', 'prescr_mat_hor', 'nr_seq_material', 'cpoe_procedimento', dt_inicio_base_w, dt_inicio_assoc_w, dt_fim_w, cd_intervalo_assoc_w, ds_horarios_assoc_w, nr_ocorrencia_assoc_w, hr_prim_horario_assoc_w, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, null, null, cd_material_assoc_w, null, null, ie_origem_proced_w, 'ds_hor_proc'||nr_agrup_assoc_w, null, 'hr_prim_hor_proc'||nr_agrup_assoc_w, null, null, null, nr_sequencia_p, 'nr_seq_proc_cpoe', 'prescr_procedimento', 'nr_sequencia', 'nr_sequencia_proc') INTO STRICT dt_inicio_assoc_w, dt_fim_w, ds_horarios_assoc_w, nr_ocorrencia_assoc_w, hr_prim_horario_assoc_w;
					exception when others then
						CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG EXCEPTION CPOE_PREVER_HORARIOS_FUTUROS:'|| substr(to_char(sqlerrm),1,2000)
							||' nr_sequencia_p:' || nr_sequencia_p
							||' nr_prescricao_p :' || nr_prescricao_p
							||' dt_inicio_base_w:'	|| to_char(dt_inicio_base_w,'dd/mm/yyyy hh24:mi:ss')
							||' dt_inicio_assoc_w:'	|| to_char(dt_inicio_assoc_w,'dd/mm/yyyy hh24:mi:ss')
							||' dt_fim_w:'	 || to_char(dt_fim_w,'dd/mm/yyyy hh24:mi:ss')
							||' cd_intervalo_assoc_w:' || cd_intervalo_assoc_w
							||' ds_horarios_assoc_w:' || ds_horarios_assoc_w
							||' nr_ocorrencia_assoc_w:'|| nr_ocorrencia_assoc_w
							||' hr_prim_horario_assoc_w:' || hr_prim_horario_assoc_w
							||' cd_estabelecimento_p:' 	|| cd_estabelecimento_p
							||' cd_perfil_p:'|| cd_perfil_p
							||' nm_usuario_p:'	|| nm_usuario_p
							||' cd_material_assoc_w:'|| cd_material_assoc_w
							||' ie_origem_proced_w :'|| ie_origem_proced_w
							||' nr_agrup_assoc_w' || nr_agrup_assoc_w,1,2000), 
							nr_atendimento_p, 'P', nr_sequencia_p);
					end;	
				end if;
	
				-- Se o inicio do item for apos a data de fim, definida para o mesmo, este item nao deve ser mais copiado.
				if (dt_fim_w IS NOT NULL AND dt_fim_w::text <> '') and (dt_fim_w <= dt_inicio_assoc_w) then
						CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG LOG DT_FIM_W <= DT_INICIO_ASSOC_W:'
							||'//dt_inicio_base_w : ' || to_char(dt_inicio_base_w,'dd/mm/yyyy hh24:mi:ss')
							||' dt_inicio_assoc_w : ' || to_char(dt_inicio_assoc_w,'dd/mm/yyyy hh24:mi:ss')
							||' dt_fim_w : ' || to_char(dt_fim_w,'dd/mm/yyyy hh24:mi:ss')
							||' nr_prescricao_p : ' || nr_prescricao_p
							||' nr_seq_mat_cpoe_assoc_w :' || nr_seq_mat_cpoe_assoc_w
							||' nr_seq_proc_cpoe_w :' || nr_sequencia_p
							||' cd_perfil_p: ' || cd_perfil_p,1,2000),
							nr_atendimento_p, 'P', nr_sequencia_p);
					goto proximo_associado;
				end if;
				
				ie_se_necessario_assoc_w	:= 'N';
				ie_acm_assoc_w				:= 'N';

				if (ie_administracao_assoc_w = 'N') then
					ie_se_necessario_assoc_w	:= 'S';
					ie_urgencia_assoc_w			:= null;
					hr_prim_horario_assoc_w		:= null;
					ds_horarios_assoc_w			:= 'SN';
				elsif (ie_administracao_assoc_w = 'C') then
					ie_acm_assoc_w				:= 'S';
					ie_urgencia_assoc_w			:= null;
					hr_prim_horario_assoc_w		:= null;
					ds_horarios_assoc_w			:= 'ACM';
				end if;
			else
				ie_origem_inf_mat_assoc_w	:= 'A';
				dt_inicio_assoc_w			:= dt_inicio_w;
				hr_prim_horario_assoc_w		:= hr_prim_horario_w;
				cd_intervalo_assoc_w		:= cd_intervalo_w;
				nr_ocorrencia_assoc_w		:= coalesce(nr_ocorrencia_w,1);
				ds_horarios_assoc_w			:= ds_horarios_w;
				ie_acm_assoc_w				:= ie_acm_w;
				ie_se_necessario_assoc_w	:= ie_se_necessario_w;
				ie_urgencia_assoc_w			:= ie_urgencia_w;
			end if;
			
			if (nr_prescricao_orig_w IS NOT NULL AND nr_prescricao_orig_w::text <> '') then
				ie_urgencia_assoc_w	:= null;
			end if;

			qt_conversao_w := coalesce(obter_conversao_unid_med(cd_material_assoc_w, cd_unidade_medida_assoc_w),0);
			cd_unidade_medida_consumo_w := coalesce(substr(obter_dados_material_estab(cd_material_assoc_w,cd_estabelecimento_p,'UMS'),1,30),cd_unidade_medida_assoc_w);
			qt_unitaria_w	:= dividir(qt_dose_assoc_w,qt_conversao_w);
			qt_material_w	:= 0;

			begin
				if (ie_copia_diaria_p = 'S' AND dt_fim_proc_w IS NOT NULL AND dt_fim_proc_w::text <> '') then
					ds_horarios_assoc_w := cpoe_recalcula_horarios_copia(ds_horarios_assoc_w, dt_inicio_assoc_w, dt_fim_proc_w, ie_acm_assoc_w, ie_se_necessario_assoc_w, cd_intervalo_assoc_w);
					nr_ocorrencia_assoc_w := obter_ocorrencias_horarios_rep(ds_horarios_assoc_w);
				end if;
			exception when others then
				CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG CPOE_RECALCULA_HORARIOS_COPIA ASSOC EXCEPTION: ' || substr(to_char(sqlerrm),1,2000)
					|| '-nr_sequencia_p: ' || nr_sequencia_p
					|| '-nr_prescricao_p: ' || nr_prescricao_p
					|| '-nr_atendimento_p: ' || nr_atendimento_p
					|| '-cd_estabelecimento_p: ' || cd_estabelecimento_p
					|| '-cd_perfil_p: ' || cd_perfil_p
					|| '-nm_usuario_p: ' || nm_usuario_p
					|| '-cd_setor_atendimento_p: ' || cd_setor_atendimento_p
					|| '-ie_origem_inf_p: ' || ie_origem_inf_p
					|| '-cd_convenio_p: ' || cd_convenio_p 
					|| '-dt_inicio_prescr_p: ' || to_char(dt_inicio_prescr_p,'dd/mm/yyyy hh24:mi:ss')
					|| '-dt_inicio_ret_p: ' || to_char(dt_inicio_ret_p,'dd/mm/yyyy hh24:mi:ss')
					|| '-ds_horarios_assoc_w: ' || ds_horarios_assoc_w
					|| '-dt_inicio_assoc_w: ' || to_char(dt_inicio_assoc_w,'dd/mm/yyyy hh24:mi:ss')
					|| '-dt_fim_proc_w: ' || to_char(dt_fim_proc_w,'dd/mm/yyyy hh24:mi:ss')
					|| '-ie_acm_assoc_w: ' || ie_acm_assoc_w
					|| '-ie_se_necessario_assoc_w: ' || ie_se_necessario_assoc_w
					|| '-cd_intervalo_assoc_w: ' || cd_intervalo_assoc_w, 1, 2000),
					nr_atendimento_p, 'P', nr_sequencia_p);
			end;

			ie_glicemia_w	:= null;
			
			if (coalesce(nr_seq_prot_glic_w,0) > 0) then
				select	max(ie_glicemia)
				into STRICT	ie_glicemia_w				
				from 	protocolo_glic_mat_med
				where 	nr_seq_protocolo_glic = nr_seq_prot_glic_w
				and		cd_material = cd_material_assoc_w;
			end if;
			
			begin
				SELECT * FROM obter_quant_dispensar(	cd_estabelecimento_p, cd_material_assoc_w, nr_prescricao_p, nr_sequencia_assoc_w, cd_intervalo_assoc_w, ie_via_aplicacao_assoc_w, qt_unitaria_w, 0, nr_ocorrencia_assoc_w, null, ie_origem_inf_mat_assoc_w, cd_unidade_medida_consumo_w, 0, qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_ww, ie_se_necessario_assoc_w, ie_acm_assoc_w ) INTO STRICT qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_ww;
			exception when others then
				CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG EXCEPTION OBTER_QUANT_DISPENSAR:'|| substr(to_char(sqlerrm),1,2000)
					||'//nr_sequencia_p:'|| nr_sequencia_p
					||' nr_prescricao_p : ' ||nr_prescricao_p
					||' cd_material_assoc_w:'|| cd_material_assoc_w
					||' nr_sequencia_assoc_w:'|| nr_sequencia_assoc_w
					||' cd_estabelecimento_p:'|| cd_estabelecimento_p
					||' cd_intervalo_assoc_w:'|| cd_intervalo_assoc_w
					||' ie_via_aplicacao_assoc_w:'|| ie_via_aplicacao_assoc_w
					||' qt_unitaria_w:'	|| qt_unitaria_w
					||' nr_ocorrencia_assoc_w:'	|| nr_ocorrencia_assoc_w
					||' ie_origem_inf_p:'|| ie_origem_inf_p
					||' ie_origem_inf_mat_assoc_w:'	|| ie_origem_inf_mat_assoc_w
					||' cd_unidade_medida_consumo_w:'|| cd_unidade_medida_consumo_w
					||' qt_material_w:'	|| qt_material_w
					||' qt_total_dispensar_w :'	|| qt_total_dispensar_w
					||' ie_regra_disp_w:'|| ie_regra_disp_w
					||' ds_erro_ww:'|| ds_erro_ww
					||' ie_se_necessario_assoc_w:'|| ie_se_necessario_assoc_w
					||' ie_acm_assoc_w:' || ie_acm_assoc_w,1,2000),
					nr_atendimento_p, 'P', nr_sequencia_p);
			end;				
			
			begin
				insert into prescr_material(
						nr_prescricao,
						nr_sequencia,
						ie_origem_inf,
						ie_agrupador,
						nr_agrupamento,
						nr_sequencia_proc,
						cd_material,
						cd_unidade_medida_dose,
						cd_unidade_medida,
						qt_unitaria,
						qt_material,
						qt_dose,
						qt_total_dispensar,
						nr_ocorrencia,
						ie_via_aplicacao,
						cd_intervalo,
						hr_prim_horario,
						ds_horarios,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						ie_regra_disp,
						ie_acm,
						ie_se_necessario,
						ie_urgencia,
						ie_checar_adep,
						nr_seq_mat_cpoe,
						ie_glicemia)
				values (
						nr_prescricao_p,
						nr_sequencia_assoc_w,
						ie_origem_inf_mat_assoc_w,
						5,
						nr_agrup_assoc_w,
						nr_sequencia_w,
						cd_material_assoc_w,
						cd_unidade_medida_assoc_w,
						cd_unidade_medida_consumo_w,
						qt_unitaria_w,
						qt_material_w,
						qt_dose_assoc_w,
						qt_total_dispensar_w,
						nr_ocorrencia_assoc_w,
						ie_via_aplicacao_assoc_w,
						cd_intervalo_assoc_w,
						hr_prim_horario_assoc_w,
						ds_horarios_assoc_w,
						dt_inicio_base_w,
						nm_usuario_w,
						dt_inicio_base_w,
						nm_usuario_nrec_w,
						ie_regra_disp_w,
						ie_acm_assoc_w,
						ie_se_necessario_assoc_w,
						CASE WHEN coalesce(ie_urgencia_assoc_w::text, '') = '' THEN 'N'  ELSE 'S' END ,
						ie_checar_adep_assoc_w,
						nr_seq_mat_cpoe_assoc_w,
						ie_glicemia_w);
						
			exception when others then
				CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG EXCEPTION INSERT PRESCR_MATERIAL:'|| substr(to_char(sqlerrm),1,2000)
					||'//nr_sequencia_p:' || nr_sequencia_p
					||' nr_prescricao_p : ' || nr_prescricao_p
					||' nr_sequencia_assoc_w:'|| nr_sequencia_assoc_w
					||' ie_origem_inf_p:'|| ie_origem_inf_p
					||' nr_agrup_assoc_w:'|| nr_agrup_assoc_w
					||' nr_sequencia_w:'|| nr_sequencia_w
					||' cd_material_assoc_w:'|| cd_material_assoc_w
					||' cd_unidade_medida_assoc_w:'	 || cd_unidade_medida_assoc_w
					||' cd_unidade_medida_consumo_w:'|| cd_unidade_medida_consumo_w
					||' qt_unitaria_w:'|| qt_unitaria_w
					||' qt_material_w:'|| qt_material_w
					||' qt_dose_assoc_w:'|| qt_dose_assoc_w
					||' qt_total_dispensar_w :'		|| qt_total_dispensar_w
					||' nr_ocorrencia_assoc_w:'	|| nr_ocorrencia_assoc_w
					||' ie_via_aplicacao_assoc_w:'	|| ie_via_aplicacao_assoc_w
					||' cd_intervalo_assoc_w:'|| cd_intervalo_assoc_w
					||' hr_prim_horario_assoc_w:'|| hr_prim_horario_assoc_w
					||' ds_horarios_assoc_w:'|| ds_horarios_assoc_w
					||' dt_inicio_base_w:'|| to_char(dt_inicio_base_w,'dd/mm/yyyy hh24:mi:ss')
					||' nm_usuario_w '|| nm_usuario_w
					||' ie_regra_disp_w:'				|| ie_regra_disp_w
					||' ie_acm_assoc_w:'|| ie_acm_assoc_w
					||' ie_se_necessario_assoc_w:'	|| ie_se_necessario_assoc_w
					||' ie_checar_adep_assoc_w : '	|| ie_checar_adep_assoc_w
					||' nr_seq_mat_cpoe_assoc_w:'	|| nr_seq_mat_cpoe_assoc_w,1,2000),
					nr_atendimento_p, 'P', nr_sequencia_p);
			end;	

			nr_sequencia_diluente_w   := nr_sequencia_assoc_w;
			nr_sequencia_recons_w     := nr_sequencia_assoc_w;
			
			/*--Inicio Diluentes */

			begin			
				if (cd_mat_diluente_w IS NOT NULL AND cd_mat_diluente_w::text <> '') then
					nr_sequencia_assoc_w	  := nr_sequencia_assoc_w + 1;
					qt_conversao_diluente_w   := coalesce(obter_conversao_unid_med(cd_mat_diluente_w, cd_unid_medida_dose_dil_w),0);
					cd_unid_med_consumo_dil_w := coalesce(substr(obter_dados_material_estab(cd_mat_diluente_w, cd_estabelecimento_p, 'UMS'),1,30), cd_unid_medida_dose_dil_w);
					qt_unitaria_diluente_w	  := dividir(qt_dose_diluente_w, qt_conversao_diluente_w);
					qt_diluente_w 			  := 0;

					begin
						SELECT * FROM obter_quant_dispensar(	cd_estabelecimento_p, cd_mat_diluente_w, nr_prescricao_p, nr_sequencia_diluente_w, null, null, qt_unitaria_diluente_w, 0, nr_ocorrencia_assoc_w, null, ie_origem_inf_mat_assoc_w, cd_unid_med_consumo_dil_w, 0, qt_diluente_w, qt_total_dispensar_dil_w, ie_regra_disp_dil_w, ds_erro_ww, null, null ) INTO STRICT qt_diluente_w, qt_total_dispensar_dil_w, ie_regra_disp_dil_w, ds_erro_ww;
					exception when others then
						CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG EXCEPTION INSERT PRESCR_MATERIAL:'|| substr(to_char(sqlerrm),1,2000)
							||'//nr_sequencia_p:'|| nr_sequencia_p
							||' nr_prescricao_p : ' || nr_prescricao_p
							||' cd_mat_diluente_w:'	 || cd_mat_diluente_w
							||' nr_sequencia_diluente_w:'|| nr_sequencia_diluente_w
							||' cd_estabelecimento_p:' || cd_estabelecimento_p
							||' cd_intervalo_assoc_w:'	|| null
							||' ie_via_aplicacao_assoc_w:'|| null
							||' qt_unitaria_diluente_w:'|| qt_unitaria_diluente_w
							||' nr_ocorrencia_assoc_w:'	|| nr_ocorrencia_assoc_w
							||' ie_origem_inf_p:'|| null
							||' ie_origem_inf_mat_assoc_w:'|| ie_origem_inf_mat_assoc_w
							||' cd_unid_med_consumo_dil_w:'|| cd_unid_med_consumo_dil_w
							||' qt_diluente_w:'	|| qt_diluente_w
							||' qt_total_dispensar_dil_w :'|| qt_total_dispensar_dil_w
							||' ie_regra_disp_dil_w:'	|| ie_regra_disp_dil_w
							||' ds_erro_ww:'|| ds_erro_ww
							||' ie_se_necessario_assoc_w:'|| null
							||' ie_acm_assoc_w:'|| null,1,2000),
							nr_atendimento_p, 'P', nr_sequencia_p);
					end;
					--
					begin
						insert into prescr_material(
								nr_prescricao,
								nr_sequencia,
								ie_origem_inf,
								ie_agrupador,
								nr_sequencia_proc,
								cd_material,
								cd_unidade_medida_dose,
								cd_unidade_medida,
								qt_unitaria,
								qt_material,
								qt_dose,
								qt_total_dispensar,
								nr_ocorrencia,
								ie_via_aplicacao,
								cd_intervalo,
								hr_prim_horario,
								ds_horarios,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								ie_regra_disp,
								ie_acm,
								ie_se_necessario,
								ie_urgencia,
								ie_checar_adep,
								nr_seq_mat_cpoe,
								nr_sequencia_diluicao)
						values (
								nr_prescricao_p,
								nr_sequencia_assoc_w,
								ie_origem_inf_mat_assoc_w,
								3,
								nr_sequencia_w,
								cd_mat_diluente_w,
								cd_unid_medida_dose_dil_w,
								cd_unid_med_consumo_dil_w,
								qt_unitaria_diluente_w,
								qt_diluente_w,
								qt_dose_diluente_w,
								qt_total_dispensar_dil_w,
								nr_ocorrencia_assoc_w,
								ie_via_aplicacao_assoc_w,
								cd_intervalo_assoc_w,
								hr_prim_horario_assoc_w,
								ds_horarios_assoc_w,
								dt_inicio_base_w,
								nm_usuario_w,
								dt_inicio_base_w,
								nm_usuario_nrec_w,
								ie_regra_disp_w,
								ie_acm_assoc_w,
								ie_se_necessario_assoc_w,
								CASE WHEN coalesce(ie_urgencia_assoc_w::text, '') = '' THEN 'N'  ELSE 'S' END ,
								ie_checar_adep_assoc_w,
								nr_seq_mat_cpoe_assoc_w,
								nr_sequencia_diluente_w);
					exception when others then
						CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG EXCEPTION INSERT PRESCR_MATERIAL2:'|| substr(to_char(sqlerrm),1,2000)
							||'//nr_sequencia_p:'	    	|| nr_sequencia_p
							||' nr_prescricao_p : ' 			|| nr_prescricao_p
							||' nr_sequencia_diluente_w:'	|| nr_sequencia_assoc_w
							||' ie_origem_inf_p:'			|| ie_origem_inf_p
							||' nr_sequencia_w:'				|| nr_sequencia_w
							||' cd_mat_diluente_w:'	    	|| cd_mat_diluente_w
							||' cd_unid_medida_dose_dil_w:'	|| cd_unid_medida_dose_dil_w
							||' cd_unid_med_consumo_dil_w:'	|| cd_unid_med_consumo_dil_w
							||' qt_unitaria_diluente_w:'		|| qt_unitaria_diluente_w
							||' qt_diluente_w:'				|| qt_diluente_w
							||' qt_dose_diluente_w:'			|| qt_dose_diluente_w
							||' qt_total_dispensar_dil_w :'	|| qt_total_dispensar_dil_w
							||' nr_ocorrencia_assoc_w:'		|| nr_ocorrencia_assoc_w
							||' ie_via_aplicacao_assoc_w:'	|| ie_via_aplicacao_assoc_w
							||' cd_intervalo_assoc_w:'		|| cd_intervalo_assoc_w
							||' hr_prim_horario_assoc_w:'	|| hr_prim_horario_assoc_w
							||' ds_horarios_assoc_w:'		|| ds_horarios_assoc_w
							||' dt_inicio_base_w:'			|| to_char(dt_inicio_base_w,'dd/mm/yyyy hh24:mi:ss')
							||' nm_usuario_w '				|| nm_usuario_w
							||' ie_regra_disp_w:'			|| ie_regra_disp_w
							||' ie_acm_assoc_w:'				|| ie_acm_assoc_w
							||' ie_se_necessario_assoc_w:'	|| ie_se_necessario_assoc_w
							||' ie_checar_adep_assoc_w : '	|| ie_checar_adep_assoc_w
							||' nr_seq_mat_cpoe_assoc_w:'		|| nr_seq_mat_cpoe_assoc_w,1,2000),
							nr_atendimento_p, 'P', nr_sequencia_p);
					end;
				end if;
			end;
			/*-- Fim Diluentes */


			
			/*--Inicio Reconstituentes */

			begin
				if (cd_mat_recons_w IS NOT NULL AND cd_mat_recons_w::text <> '') then
					nr_sequencia_assoc_w	  := nr_sequencia_assoc_w + 1;
					qt_conversao_diluente_w   := coalesce(obter_conversao_unid_med(cd_mat_recons_w, cd_unid_medida_dose_recons_w),0);
					cd_unid_med_consumo_dil_w := coalesce(substr(obter_dados_material_estab(cd_mat_recons_w, cd_estabelecimento_p, 'UMS'),1,30), cd_unid_medida_dose_recons_w);
					qt_unitaria_diluente_w	  := dividir(qt_dose_recons_w, qt_conversao_diluente_w);
					qt_diluente_w 			  := 0;

					begin
						SELECT * FROM obter_quant_dispensar(	cd_estabelecimento_p, cd_mat_recons_w, nr_prescricao_p, nr_sequencia_recons_w, null, null, qt_unitaria_diluente_w, 0, nr_ocorrencia_assoc_w, null, ie_origem_inf_mat_assoc_w, cd_unid_med_consumo_dil_w, 0, qt_diluente_w, qt_total_dispensar_recons_w, ie_regra_disp_recons_w, ds_erro_ww, null, null ) INTO STRICT qt_diluente_w, qt_total_dispensar_recons_w, ie_regra_disp_recons_w, ds_erro_ww;
					exception when others then
						CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG EXCEPTION OBTER_QUANT_DISPENSAR:'|| substr(to_char(sqlerrm),1,2000)
							||'//nr_sequencia_p:'|| nr_sequencia_p
							||' nr_prescricao_p : '|| nr_prescricao_p
							||' cd_mat_recons_w:'|| cd_mat_recons_w
							||' nr_sequencia_recons_w:'	|| nr_sequencia_recons_w
							||' cd_estabelecimento_p:'	   || cd_estabelecimento_p
							||' cd_intervalo_assoc_w:'	|| null
							||' ie_via_aplicacao_assoc_w:'|| null
							||' qt_unitaria_diluente_w:'		|| qt_unitaria_diluente_w
							||' nr_ocorrencia_assoc_w:'|| nr_ocorrencia_assoc_w
							||' ie_origem_inf_p:'|| null
							||' ie_origem_inf_mat_assoc_w:'|| ie_origem_inf_mat_assoc_w
							||' cd_unid_med_consumo_dil_w:'|| cd_unid_med_consumo_dil_w
							||' qt_diluente_w:'	|| qt_diluente_w
							||' qt_total_dispensar_recons_w :'|| qt_total_dispensar_recons_w	
							||' ie_regra_disp_recons_w:'|| ie_regra_disp_recons_w
							||' ds_erro_ww:'|| ds_erro_ww
							||' ie_se_necessario_assoc_w:'	|| null
							||' ie_acm_assoc_w:'|| null,1,2000),
							nr_atendimento_p, 'P', nr_sequencia_p);
					end;
					
					begin
						insert into prescr_material(
								nr_prescricao,
								nr_sequencia,
								ie_origem_inf,
								ie_agrupador,
								nr_sequencia_proc,
								cd_material,
								cd_unidade_medida_dose,
								cd_unidade_medida,
								qt_unitaria,
								qt_material,
								qt_dose,
								qt_total_dispensar,
								nr_ocorrencia,
								ie_via_aplicacao,
								cd_intervalo,
								hr_prim_horario,
								ds_horarios,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								ie_regra_disp,
								ie_acm,
								ie_se_necessario,
								ie_urgencia,
								ie_checar_adep,
								nr_seq_mat_cpoe,
								nr_sequencia_diluicao)
						values (
								nr_prescricao_p,
								nr_sequencia_assoc_w,
								ie_origem_inf_mat_assoc_w,
								9,
								nr_sequencia_w,
								cd_mat_recons_w,
								cd_unid_medida_dose_recons_w,
								cd_unid_med_consumo_dil_w,
								qt_unitaria_diluente_w,
								qt_diluente_w,
								qt_dose_recons_w,
								qt_total_dispensar_recons_w,
								nr_ocorrencia_assoc_w,
								ie_via_aplicacao_assoc_w,
								cd_intervalo_assoc_w,
								hr_prim_horario_assoc_w,
								ds_horarios_assoc_w,
								dt_inicio_base_w,
								nm_usuario_w,
								dt_inicio_base_w,
								nm_usuario_nrec_w,
								ie_regra_disp_w,
								ie_acm_assoc_w,
								ie_se_necessario_assoc_w,
								CASE WHEN coalesce(ie_urgencia_assoc_w::text, '') = '' THEN 'N'  ELSE 'S' END ,
								ie_checar_adep_assoc_w,
								nr_seq_mat_cpoe_assoc_w,
								nr_sequencia_recons_w);
					exception when others then
						CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG EXCEPTION INSERT PRESCR_MATERIAL3:'|| substr(to_char(sqlerrm),1,2000)
							||'//nr_sequencia_p:'|| nr_sequencia_p
							||' nr_prescricao_p : '|| nr_prescricao_p
							||' nr_sequencia_recons_w:'	|| nr_sequencia_recons_w
							||' ie_origem_inf_p:'||ie_origem_inf_p
							||' nr_sequencia_w:'||nr_sequencia_w
							||' cd_mat_recons_w:'|| cd_mat_recons_w
							||' cd_unid_medida_dose_recons_w:'	|| cd_unid_medida_dose_recons_w
							||' cd_unid_med_consumo_dil_w:'	|| cd_unid_med_consumo_dil_w
							||' qt_unitaria_diluente_w:'|| qt_unitaria_diluente_w
							||' qt_diluente_w:'	|| qt_diluente_w
							||' qt_dose_recons_w:'|| qt_dose_recons_w
							||' qt_total_dispensar_recons_w :'	|| qt_total_dispensar_recons_w
							||' nr_ocorrencia_assoc_w:'	|| nr_ocorrencia_assoc_w
							||' ie_via_aplicacao_assoc_w:'|| ie_via_aplicacao_assoc_w
							||' cd_intervalo_assoc_w:'	|| cd_intervalo_assoc_w
							||' hr_prim_horario_assoc_w:'|| hr_prim_horario_assoc_w
							||' ds_horarios_assoc_w:'|| ds_horarios_assoc_w
							||' dt_inicio_base_w:'|| to_char(dt_inicio_base_w,'dd/mm/yyyy hh24:mi:ss')
							||' nm_usuario_w '|| nm_usuario_w
							||' ie_regra_disp_w:'|| ie_regra_disp_w
							||' ie_acm_assoc_w:'|| ie_acm_assoc_w
							||' ie_se_necessario_assoc_w:'|| ie_se_necessario_assoc_w
							||' ie_checar_adep_assoc_w : '|| ie_checar_adep_assoc_w
							||' nr_seq_mat_cpoe_assoc_w:'|| nr_seq_mat_cpoe_assoc_w,1,2000),
							nr_atendimento_p, 'P', nr_sequencia_p);
					end;
				end if;
			end;
			/*-- Fim Reconstituentes */

						
			<<proximo_associado>>
			
			commit;
		
			end;
		end loop;
		close cMateriaisAssoc;
	end;

	procedure CPOE_Inserir_mat_assoc is
	
		nr_seq_mat_w	cpoe_material.nr_sequencia%type;
		dt_inicio_ret_w	date;
		C01 CURSOR FOR
			SELECT	nr_sequencia
			from	cpoe_material
			where	nr_seq_procedimento = nr_sequencia_p
			and (coalesce(dt_liberacao::text, '') = '' or ie_copia_diaria_p = 'S')
			and coalesce(ie_material,'N') = 'S';	
	begin
	
		open C01;
		loop
		fetch C01 into	
			nr_seq_mat_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			
			if (coalesce(nr_seq_mat_w,0) > 0) then
				dt_inicio_ret_w := cpoe_insert_materials_reg( nr_atendimento_p, nr_prescricao_p, nr_seq_mat_w, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, dt_inicio_prescr_p, dt_inicio_ret_w, null, null, nr_sequencia_w);				
				
				update  cpoe_material
				set     dt_liberacao = clock_timestamp()
				where   nr_sequencia = nr_seq_mat_w	
				and coalesce(dt_liberacao::text, '') = '';
				
			end if;
			
		end loop;
		close C01;
	
	end;
	
	procedure Localizar_ultimo_item is
	begin
		nr_prescricao_orig_w	:= null;
		nr_sequencia_orig_w		:= null;
		
		if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
			-- Localizar ultima prescricao
			select	max(a.nr_prescricao)
			into STRICT	nr_prescricao_orig_w
			from	prescr_medica a
			where	a.nr_atendimento = nr_atendimento_p
			and		a.dt_prescricao > dt_inicio_base_w - 10
			and		exists (	SELECT	1
							from	prescr_procedimento b
							where	b.nr_prescricao = a.nr_prescricao
							and		b.nr_seq_proc_cpoe = nr_sequencia_p );
			
			if (nr_prescricao_orig_w IS NOT NULL AND nr_prescricao_orig_w::text <> '') then
				-- Itens  dos nao devem ser gerados como agora
				ie_urgencia_w	:= null;
				
				-- Localizar ultimo item
				select	min(nr_sequencia)
				into STRICT	nr_sequencia_orig_w
				from	prescr_procedimento
				where	nr_prescricao = nr_prescricao_orig_w
				and		nr_seq_proc_cpoe = nr_sequencia_p;
				
				
				if (ie_copia_diaria_p = 'S' and (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '')) then	
					if (ie_operacao_w = 'H' and qt_operacao_w > 12) then
					
						dt_inicio_w := cpoe_obter_inicio_interv_horas(cd_intervalo_w, dt_inicio_w, dt_inicio_base_w);
						hr_prim_horario_w	:= to_char(dt_inicio_w,'hh24:mi');
						dt_inicio_base_w	:= dt_inicio_w;
						ds_horarios_w		:= hr_prim_horario_w;
						
						if (qt_operacao_w < 24) then
							SELECT * FROM cpoe_calcular_horario_prescr(nr_atendimento_p, cd_intervalo_w, null, dt_inicio_w, null, 0, nr_ocorrencia_w, ds_horarios_aux_w, ds_horarios_aux2_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, '', null, cd_procedimento_w, ie_origem_proced_w, nr_seq_proc_interno_w, obterValidade(nr_atendimento_p,nr_sequencia_p)) INTO STRICT nr_ocorrencia_w, ds_horarios_aux_w, ds_horarios_aux2_w;
								
							ds_horarios_w := ds_horarios_aux_w||ds_horarios_aux2_w;
							ds_horarios_w := replace(padroniza_horario_prescr(ds_horarios_w,NULL),'A','');
						end if;
						
						update	cpoe_procedimento
						set		hr_prim_horario = hr_prim_horario_w,
								ds_horarios = ds_horarios_w
						where	nr_sequencia = nr_sequencia_p;		
						
					end if;
				end if;
				
			elsif (ie_administracao_w = 'P') and (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') and (ie_operacao_w in ('X','H')) and
					(((obter_quantidade_horarios(ds_horarios_w) <> Obter_ocorrencia_intervalo(cd_intervalo_w, obterValidade(nr_atendimento_p,nr_sequencia_p), 'O')) and (ie_ctrl_glic_w = 'NC')) or (coalesce(ds_horarios_w::text, '') = '')) then
				begin
					CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG LOG LOCALIZAR_ULTIMO_ITEM1:'||
						' nr_sequencia_p: ' || nr_sequencia_p ||
						' cd_intervalo_w: ' || cd_intervalo_w ||
						' dt_inicio_w: ' || to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss') ||
						' cd_estabelecimento_p: ' || cd_estabelecimento_p ||
						' cd_perfil_p: ' ||  cd_perfil_p ||
						' ds_horarios_w : ' || ds_horarios_w ||
						' ds_horarios_aux_w : ' || ds_horarios_aux_w ||
						' ds_horarios_aux2_w : ' || ds_horarios_aux2_w ||
						' cd_procedimento_w : ' || cd_procedimento_w ||
						' ie_origem_proced_w : ' || ie_origem_proced_w ||
						' nr_seq_proc_interno_w : ' || nr_seq_proc_interno_w ||
						' nr_ocorrencia_w : ' || nr_ocorrencia_w,1,2000), 
						nr_atendimento_p, 'P', nr_sequencia_p);

					nr_ocorrencia_w := null;
											
					
					SELECT * FROM cpoe_calcular_horario_prescr(nr_atendimento_p, cd_intervalo_w, null, dt_inicio_w, null, 0, nr_ocorrencia_w, ds_horarios_aux_w, ds_horarios_aux2_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, '', null, cd_procedimento_w, ie_origem_proced_w, nr_seq_proc_interno_w, obterValidade(nr_atendimento_p,nr_sequencia_p)) INTO STRICT nr_ocorrencia_w, ds_horarios_aux_w, ds_horarios_aux2_w;

					CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG LOG LOCALIZAR_ULTIMO_ITEM2:'||
						' nr_sequencia_p: ' || nr_sequencia_p ||
						' cd_intervalo_w: ' || cd_intervalo_w ||
						' dt_inicio_w: ' || to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss') ||
						' cd_estabelecimento_p: ' || cd_estabelecimento_p ||
						' cd_perfil_p: ' ||  cd_perfil_p ||
						' ds_horarios_w : ' || ds_horarios_w ||
						' ds_horarios_aux_w : ' || ds_horarios_aux_w ||
						' ds_horarios_aux2_w : ' || ds_horarios_aux2_w ||
						' cd_procedimento_w : ' || cd_procedimento_w ||
						' ie_origem_proced_w : ' || ie_origem_proced_w ||
						' nr_seq_proc_interno_w : ' || nr_seq_proc_interno_w ||
						' nr_ocorrencia_w : ' || nr_ocorrencia_w,1,2000),
						nr_atendimento_p, 'P', nr_sequencia_p);

					ds_horarios_w := ds_horarios_aux_w||ds_horarios_aux2_w;
					ds_horarios_w := replace(padroniza_horario_prescr(ds_horarios_w,NULL),'A','');
					
					CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG LOG LOCALIZAR_ULTIMO_ITEM3:'||
						' nr_sequencia_p: ' || nr_sequencia_p ||
						' cd_intervalo_w: ' || cd_intervalo_w ||
						' dt_inicio_w: ' || to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss') ||
						' cd_estabelecimento_p: ' || cd_estabelecimento_p ||
						' cd_perfil_p: ' ||  cd_perfil_p ||
						' ds_horarios_w : ' || ds_horarios_w ||
						' ds_horarios_aux_w : ' || ds_horarios_aux_w ||
						' ds_horarios_aux2_w : ' || ds_horarios_aux2_w ||
						' cd_procedimento_w : ' || cd_procedimento_w ||
						' ie_origem_proced_w : ' || ie_origem_proced_w ||
						' nr_seq_proc_interno_w : ' || nr_seq_proc_interno_w ||
						' nr_ocorrencia_w : ' || nr_ocorrencia_w,1,2000),
						nr_atendimento_p, 'P', nr_sequencia_p);					
					
					update  cpoe_procedimento
					set		nr_ocorrencia = nr_ocorrencia_w,
							ds_horarios = ds_horarios_w
					where	nr_sequencia = nr_sequencia_p;
				exception when others then
					CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG EXCEPTION LOCALIZAR_ULTIMO_ITEM:'||substr(to_char(sqlerrm),1,2000) ||
						' nr_sequencia_p: ' || nr_sequencia_p ||
						' cd_intervalo_w: ' || cd_intervalo_w ||
						' dt_inicio_w: ' || to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss') ||
						' cd_estabelecimento_p: ' || cd_estabelecimento_p ||
						' cd_perfil_p: ' ||  cd_perfil_p ||
						' ds_horarios_w : ' || ds_horarios_w ||
						' ds_horarios_aux_w : ' || ds_horarios_aux_w ||
						' ds_horarios_aux2_w : ' || ds_horarios_aux2_w ||
						' cd_procedimento_w : ' || cd_procedimento_w ||
						' ie_origem_proced_w : ' || ie_origem_proced_w ||
						' nr_seq_proc_interno_w : ' || nr_seq_proc_interno_w ||
						' nr_ocorrencia_w : ' || nr_ocorrencia_w,1,2000),
						nr_atendimento_p, 'P', nr_sequencia_p);	
				end;
			end if;
		end if;
	end;

begin

dt_inicio_base_w		:= trunc(dt_inicio_prescr_p,'mi');
nr_horas_prox_geracao_w	:= get_qt_hours_after_copy_cpoe(cd_perfil_p, nm_usuario_p, cd_estabelecimento_p);
ie_vinc_seq_agend_w := Obter_param_Usuario(924, 1020, cd_perfil_p, nm_usuario_p, coalesce(cd_estabelecimento_p, obter_estabelecimento_ativo), ie_vinc_seq_agend_w);
ie_gerar_setor_exec_proc_w := Obter_param_Usuario(924, 493, cd_perfil_p, nm_usuario_p, coalesce(cd_estabelecimento_p, obter_estabelecimento_ativo), ie_gerar_setor_exec_proc_w);
cd_setor_atual_usuario_w	:= obter_setor_usuario(nm_usuario_p);

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
	select	max(cd_pessoa_fisica)
	into STRICT	cd_pessoa_fisica_w
	from	atendimento_paciente
	where	nr_atendimento = nr_atendimento_p;
end if;

open cProcedimentos;
loop
fetch cProcedimentos into
	nr_sequencia_cpoe_w,
	nr_seq_proc_interno_w,
	qt_procedimento_w,
	nr_seq_topografia_w,
	ie_lado_w,
	nr_seq_prot_glic_w,
	cd_material_exame_w,
	ds_material_especial_w,
	cd_intervalo_w,
	dt_inicio_orig_w,
	hr_prim_horario_w,
	dt_fim_w,
	ds_horarios_w,
	ds_observacao_w,
	ds_justificativa_w,
	dt_atualizacao_w,
	nm_usuario_w,
	dt_atualizacao_nrec_w,
	nm_usuario_nrec_w,
	ie_duracao_w,
	dt_liberacao_w,
	ie_administracao_w,
	nr_ocorrencia_w,
	ie_urgencia_w,
	ds_dado_clinico_w,
	nr_seq_agenda_w,
	ie_anestesia_w,
	nr_seq_contraste_w,
	ie_executar_leito_w,
	nr_seq_avaliacao_w,
	nr_seq_condicao_w,
	nr_seq_rotina_w,
	nr_seq_rotina_especial_w,
	dt_fim_proc_w,
	ie_amostra_w,
    cd_protocolo_w,
    nr_seq_protocolo_w,
    nr_seq_proc_rotina_w,
	cd_medico_exec_w,
	cd_setor_entrega_ww,
    ie_kit_gerado_w;
EXIT WHEN NOT FOUND; /* apply on cProcedimentos */
	begin
--	ie_calcula_horarios_w	:= false;
	dt_inicio_w				:= dt_inicio_orig_w;
	ie_administrar_w 		:= null;

	-- Itens ACM e SN nao possuem 1 horario, definir inacio do item para execucao da geracao.
	if (ie_administracao_w <> 'P') then
		begin
		if (trunc(dt_inicio_w) > trunc(dt_inicio_base_w)) then
			hr_prim_horario_w	:= '00:00';
		else
			hr_prim_horario_w		:= to_char(dt_inicio_base_w,'hh24:mi');
		end if;
		end;
	end if;		
		
	-- Atualiza a data inicio com dia e horario.
	dt_inicio_w		:= to_date(to_char(dt_inicio_w,'dd/mm/yyyy ') || hr_prim_horario_w,'dd/mm/yyyy hh24:mi');
	
	CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG SEQ_EXAME_1:'||substr(to_char(sqlerrm),1,2000)
		||' nr_sequencia_p'	|| nr_sequencia_p
		||' nr_prescricao_p'	|| nr_prescricao_p
		||' cd_estabelecimento_p' || cd_estabelecimento_p
		||' nr_seq_proc_interno_w:' ||nr_seq_proc_interno_w
		||' nr_seq_rotina_w:'|| nr_seq_rotina_w, 1,2000),
		nr_atendimento_p, 'P', nr_sequencia_p);

	select 	max(nr_seq_exame_lab),
			max(coalesce(ie_ctrl_glic,'NC'))	
	into STRICT	nr_seq_exame_w,
			ie_ctrl_glic_w
	from  	proc_interno
	where	nr_sequencia = nr_seq_proc_interno_w;

	if (coalesce(nr_seq_exame_w::text, '') = '') then
		select max(a.nr_seq_exame)
		into STRICT nr_seq_exame_w
		from exame_laboratorio a
		where ((a.cd_estabelecimento = cd_estabelecimento_p) or (coalesce(a.cd_estabelecimento::text, '') = ''))
		and a.nr_seq_proc_interno = nr_seq_proc_interno_w
		and coalesce(a.ie_situacao,'A') = 'A';
	end if;	

    if (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') then
       	select max(a.nr_seq_exame)
		into STRICT nr_seq_exame_validity_w
		from exame_laboratorio a,
		exame_lab_validade b
		where a.nr_seq_exame = b.nr_seq_exame_lab
		and a.nr_seq_exame = nr_seq_exame_w
		and ESTABLISHMENT_TIMEZONE_UTILS.startofday(clock_timestamp())
		between ESTABLISHMENT_TIMEZONE_UTILS.startofday(b.dt_inicio_vigencia)
		and ESTABLISHMENT_TIMEZONE_UTILS.startofday(b.dt_fim_vigencia)
		and a.cd_estabelecimento = cd_estabelecimento_p
		and coalesce(a.ie_situacao,'A') = 'A';
	end if;
	
        if (nr_seq_exame_validity_w IS NOT NULL AND nr_seq_exame_validity_w::text <> '') then
	      nr_seq_exame_w := nr_seq_exame_validity_w;
        end if;
	
	CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG SEQ_EXAME_2:'||substr(to_char(sqlerrm),1,2000)
		||' nr_sequencia_p'	|| nr_sequencia_p
		||' nr_prescricao_p'	|| nr_prescricao_p
		||' cd_estabelecimento_p' || cd_estabelecimento_p
		||' ie_ctrl_glic_w' || ie_ctrl_glic_w
		||' nr_seq_proc_interno_w:' ||nr_seq_proc_interno_w
		||' nr_seq_exame_w:'|| nr_seq_exame_w, 1,2000),
		nr_atendimento_p, 'P', nr_sequencia_p);
	
	begin
		if (coalesce(nr_seq_exame_w::text, '') = '') then
			dt_entrega_w  := Obter_Entrega_Laudo(	nr_prescricao_p, dt_inicio_w, nr_seq_proc_interno_w, cd_procedimento_w, ie_origem_proced_w, cd_setor_atendimento_p, nm_usuario_p, dt_entrega_w );
		else
			dt_prevista_retorno_w  := Atualiza_dt_realizacao_exame(	nr_seq_exame_w, nr_prescricao_p, dt_inicio_w, dt_prevista_retorno_w );

			select	CASE WHEN coalesce(ie_urgencia_w::text, '') = '' THEN 'N'  ELSE 'S' END  ie_agora
			into STRICT	ie_agora_w
			;

			SELECT * FROM obter_setor_exame_lab(	nr_prescricao_p				=>	nr_prescricao_p, nr_seq_exame_p				=>	nr_seq_exame_w, cd_setor_solicitacao_p		=>	cd_setor_atual_usuario_w, cd_material_exame_p			=>	cd_material_exame_w, dt_coleta_p					=>	null, ie_atualizar_dt_prescr_p	=>	'S', cd_setor_atendimento_p		=>	ds_lista_setores_atend_w, cd_setor_coleta_p			=>	ds_lista_setores_col_w, cd_setor_entrega_p			=>	ds_lista_setores_ent_w, qt_dia_entrega_p			=>	qt_dia_entrega_w, ie_emite_mapa_p				=>	ie_emite_mapa_w, ds_hora_fixa_p				=>	ds_hora_fixa_w, ie_data_resultado_p			=>	ie_data_resultado_w, qt_min_entrega_p			=>	qt_min_entrega_w, ie_atualizar_recoleta_p		=>	ie_atualizar_recoleta_w, ie_urgencia_p				=>	ie_agora_w, ie_dia_semana_final_p		=>	ie_dia_semana_final_w, ie_forma_atual_dt_result_p	=>	ie_forma_atual_dt_result_w, qt_min_atraso_p				=>	qt_min_atraso_w, dt_entrada_p				=>	dt_prevista_retorno_w) INTO STRICT cd_setor_atendimento_p		=>	ds_lista_setores_atend_w, cd_setor_coleta_p			=>	ds_lista_setores_col_w, cd_setor_entrega_p			=>	ds_lista_setores_ent_w, qt_dia_entrega_p			=>	qt_dia_entrega_w, ie_emite_mapa_p				=>	ie_emite_mapa_w, ds_hora_fixa_p				=>	ds_hora_fixa_w, ie_data_resultado_p			=>	ie_data_resultado_w, qt_min_entrega_p			=>	qt_min_entrega_w, ie_atualizar_recoleta_p		=>	ie_atualizar_recoleta_w, ie_dia_semana_final_p		=>	ie_dia_semana_final_w, ie_forma_atual_dt_result_p	=>	ie_forma_atual_dt_result_w, qt_min_atraso_p				=>	qt_min_atraso_w;

			cd_setor_coleta_w := gerar_setor_exame_lab(ds_lista_setores_col_w);
			cd_setor_entrega_w := gerar_setor_exame_lab(ds_lista_setores_ent_w);

			if (to_char(dt_prevista_retorno_w,'hh24:mi:ss') <> '00:00:00')  then
			   dt_inicio_w	:= dt_prevista_retorno_w;
			elsif (ie_acm_w = 'N') and (ie_se_necessario_w = 'N')	then
			   dt_inicio_w	:= dt_prevista_retorno_w;
			end if;
		end if;

	exception when others then
		CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG EXCEPTION ATUALIZA_DT_REALIZACAO_EXAME:'||substr(to_char(sqlerrm),1,2000)
			||' nr_sequencia_p'	|| nr_sequencia_p
			||' nr_prescricao_p'	|| nr_prescricao_p
			||' nr_seq_exame_w:' ||nr_seq_exame_w
			||' dt_prevista_retorno_w:'|| to_char(dt_prevista_retorno_w,'dd/mm/yyyy hh24:mi:ss'),1,2000),
			nr_atendimento_p, 'P', nr_sequencia_p);
	end;	
	
	begin
		-- Atualizar data de inicio com a data atual, para itens que a data de inicio ja tenha sido ultrapassada.
		if (dt_inicio_w < dt_inicio_base_w) then
			-- Assumir data da prescricao para o item
			dt_inicio_w		:= to_date(to_char(dt_inicio_base_w,'dd/mm/yyyy ') || hr_prim_horario_w, 'dd/mm/yyyy hh24:mi');
			-- Adicionar um dia, caso o inicio do item, nao caia na data de hoje
			if (dt_inicio_w < dt_inicio_base_w) then
				dt_inicio_w	:= dt_inicio_w+1;
			end if;
			--ie_calcula_horarios_w	:= true;
		end if;
		
	exception when others then
		CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG EXCEPTION ATUALIZAR COM DATA ATUAL:'||substr(to_char(sqlerrm),1,2000)
			||' nr_sequencia_p'	|| nr_sequencia_p
			||' dt_inicio_w'		|| to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss')
			||' dt_inicio_base_w:'|| to_char(dt_inicio_base_w,'dd/mm/yyyy hh24:mi:ss'),1,2000),
			nr_atendimento_p, 'P', nr_sequencia_p);
	end;		
		
	dt_proxima_dose_w	:= dt_inicio_w;
	
	
	
	begin
		SELECT * FROM Obter_Proc_Tab_Interno(nr_seq_proc_interno_w, nr_prescricao_p, nr_atendimento_p, 0, cd_procedimento_w, ie_origem_proced_w) INTO STRICT cd_procedimento_w, ie_origem_proced_w;
		
		SELECT * FROM tiss_obter_guia(	'4', null, nr_doc_convenio_w, 'N', null, null, null, null, null, ie_guia_w, null, nr_prescricao_p, null, cd_setor_atendimento_p, null, nr_prescricao_p, null, null, null, null, nr_seq_proc_interno_w, null, cd_procedimento_w, ie_origem_proced_w, null, null ) INTO STRICT nr_doc_convenio_w, ie_guia_w;
	exception when others then
		CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG EXCEPTION OBTER_PROC_TAB_INTERNO:'||substr(to_char(sqlerrm),1,2000)
			||' nr_sequencia_p:'	     || nr_sequencia_p
			||' nr_prescricao_p :'	 || nr_prescricao_p
			||' nr_seq_proc_interno_w:'|| nr_seq_proc_interno_w
			||' cd_procedimento_w:'	 || cd_procedimento_w
			||' ie_origem_proced_w'	 || ie_origem_proced_w	
			||' nr_doc_convenio_w:' 	 || nr_doc_convenio_w
			||' cd_setor_atendimento_p:'|| cd_setor_atendimento_p,1,2000), 
			nr_atendimento_p, 'P', nr_sequencia_p);
	end;
	
	select 	max(ie_operacao),
		max(qt_operacao)
	into STRICT	ie_operacao_w,
		qt_operacao_w
	from	intervalo_prescricao
	where 	cd_intervalo = cd_intervalo_w;
	
	-- Localizar ultima prescricao e item principal vinculado ao registro da CPOE
	Localizar_ultimo_item;

	ie_administrar_w	:= null;
	dt_prox_geracao_w	:= null;

	begin
		-- Caso a data de inicio do item maior que data fim de base do item, reprogramar geracao do item.

		--  A prescricao deste item, deve ser gerada diariamente, independente de sua administracao.
		if (dt_proxima_dose_w > dt_inicio_base_w + 1 - 1/86400) then
			
			-- Se a data de inicio do item for superior a data de inicio da prescricao adicionando 1 dia (totalizando 24h),

			--  e nao existe nenhuma prescricao gerada anteriormente, quer dizer que e um novo item.

			--  sendo assim, deve-se programar a geracao de uma prescricao para este.
			if (coalesce(nr_prescricao_orig_w::text, '') = '') then
				update	cpoe_procedimento
				set		dt_prox_geracao = trunc(dt_proxima_dose_w,'hh24') - (nr_horas_prox_geracao_w/24)
				where	nr_sequencia = nr_sequencia_p;
				
				CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG LOG DT_PROXIMA_DOSE_W > DT_INICIO_BASE_W1:'
					||'//dt_proxima_dose_w : ' || to_char(dt_proxima_dose_w,'dd/mm/yyyy hh24:mi:ss')
					||' dt_proxima_dose_new : ' || to_char(trunc(dt_proxima_dose_w,'hh24') - (nr_horas_prox_geracao_w/24),'dd/mm/yyyy hh24:mi:ss')
					||' dt_inicio_base_w : ' || to_char(dt_inicio_base_w,'dd/mm/yyyy hh24:mi:ss')
					||' nr_prescricao_p : ' || nr_prescricao_p
					||' nr_seq_proc_cpoe_w :' || nr_sequencia_p
					||' cd_perfil_p: ' || cd_perfil_p,1,2000),
					nr_atendimento_p, 'P', nr_sequencia_p);
				
				commit;
				goto proximo_item;
			else
				dt_prox_geracao_w	:= trunc(dt_inicio_base_w + abs(mod(dt_proxima_dose_w - dt_inicio_base_w,24))/24 + 1,'hh24');
				ie_administrar_w	:= 'N';

				select	coalesce(max('S'),'N')
				into STRICT	ie_administrar_w
				from	prescr_procedimento item
				where	item.nr_prescricao = nr_prescricao_orig_w
				and		item.nr_sequencia = nr_sequencia_orig_w
				and		coalesce(item.ie_administrar,'N') = 'N'
				and		exists (	SELECT	1
								from	prescr_proc_hor horario
								where	horario.nr_prescricao = item.nr_prescricao
								and		horario.nr_seq_procedimento = item.nr_sequencia
								and		horario.dt_horario = dt_inicio_w
								);

				if (ie_administrar_w = 'S') then
					update	cpoe_procedimento
					set		dt_prox_geracao = dt_prox_geracao_w
					where	nr_sequencia = nr_sequencia_p;
				
					CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG LOG DT_PROXIMA_DOSE_W > DT_INICIO_BASE_W2:'
							||'//dt_proxima_dose_w : ' || to_char(dt_proxima_dose_w,'dd/mm/yyyy hh24:mi:ss')
							||' dt_proxima_dose_new : ' || to_char(dt_prox_geracao_w,'dd/mm/yyyy hh24:mi:ss')
							||' dt_inicio_base_w : ' || to_char(dt_inicio_base_w,'dd/mm/yyyy hh24:mi:ss')
							||' nr_prescricao_p : ' || nr_prescricao_p
							||' nr_seq_proc_cpoe_w :' || nr_sequencia_p
							||' cd_perfil_p: ' || cd_perfil_p,1,2000),
						nr_atendimento_p, 'P', nr_sequencia_p);
							
					commit;
					goto proximo_item;
				end if;
			end if;
		else
			--dt_inicio_w			:= dt_proxima_dose_w;
			dt_proxima_dose_w	:= null;
		end if;
	exception when others then
		CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG EXCEPTION DT_PROXIMA_DOSE_W > DT_INICIO_BASE_W:'||substr(to_char(sqlerrm),1,2000)
			||' nr_sequencia_p:'	     || nr_sequencia_p
			||' nr_prescricao_p :'	 || nr_prescricao_p
			||' dt_inicio_base_w:'	 || to_char(dt_inicio_base_w,'dd/mm/yyyy hh24:mi:ss')
			||' dt_proxima_dose_w:'	 		 || to_char(dt_proxima_dose_w,'dd/mm/yyyy hh24:mi:ss')
			||' dt_fim_w:'	 		 || to_char(dt_fim_w,'dd/mm/yyyy hh24:mi:ss')
			||' cd_intervalo_w:'		 || cd_intervalo_w
			||' ds_horarios_w:' 	 	 || ds_horarios_w
			||' nr_ocorrencia_w:'		 || nr_ocorrencia_w
			||' hr_prim_horario_w:'    || hr_prim_horario_w
			||' cd_estabelecimento_p:' || cd_estabelecimento_p
			||' cd_perfil_p:'			 || cd_perfil_p
			||' nm_usuario_p:'		 || nm_usuario_p
			||' cd_procedimento_w:'	 || cd_procedimento_w
			||' nr_seq_proc_interno_w :'|| nr_seq_proc_interno_w
			||' ie_origem_proced_w:' 	 || ie_origem_proced_w,1,2000), 
			nr_atendimento_p, 'P', nr_sequencia_p);
	end;		
	
	-- Se o inicio do item for apos a data de fim, definida para o mesmo, este item nao deve ser mais copiado.
	if (dt_fim_w IS NOT NULL AND dt_fim_w::text <> '') and (dt_fim_w <= dt_inicio_w) then
		CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG EXCEPTION DT_FIM_W <= DT_INICIO_W:'
			||'//dt_inicio_base_w : ' || to_char(dt_inicio_base_w,'dd/mm/yyyy hh24:mi:ss')
			||' dt_inicio_w : ' || to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss')
			||' dt_fim_w : ' || to_char(dt_fim_w,'dd/mm/yyyy hh24:mi:ss')
			||' nr_prescricao_p : ' || nr_prescricao_p
			||' nr_seq_proc_cpoe_w :' || nr_sequencia_p
			||' cd_perfil_p: ' || cd_perfil_p,1,2000),
			nr_atendimento_p, 'P', nr_sequencia_p);
		goto proximo_item;
	end if;

	-- Retornar a maior data de inicio dos itens.
	if	((coalesce(dt_inicio_ret_p::text, '') = '') or (dt_inicio_w > dt_inicio_ret_p)) then
		 dt_inicio_ret_p	:= dt_inicio_w;
	end if;

	ie_se_necessario_w	:= 'N';
	ie_acm_w			:= 'N';

	if (ie_administracao_w = 'N') then
		ie_se_necessario_w	:= 'S';
		ie_acm_w			:= 'N';
		hr_prim_horario_w	:= null;
		ds_horarios_w		:= 'SN';
		ie_urgencia_w		:= null;
	elsif (ie_administracao_w = 'C') then
		ie_se_necessario_w	:= 'N';
		ie_acm_w			:= 'S';
		hr_prim_horario_w	:= null;
		ds_horarios_w		:= 'ACM';
		ie_urgencia_w		:= null;
	end if;

	begin
		if (ie_copia_diaria_p = 'S' AND dt_fim_proc_w IS NOT NULL AND dt_fim_proc_w::text <> '') then
			ds_horarios_w := cpoe_recalcula_horarios_copia(ds_horarios_w, dt_inicio_w, dt_fim_proc_w, ie_acm_w, ie_se_necessario_w, cd_intervalo_w);
			nr_ocorrencia_w := obter_ocorrencias_horarios_rep(ds_horarios_w);
		end if;
	exception when others then
		CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG CPOE_RECALCULA_HORARIOS_COPIA EXCEPTION:'||substr(to_char(sqlerrm),1,2000)
			|| '-nr_sequencia_p: ' || nr_sequencia_p
			|| '-nr_prescricao_p: ' || nr_prescricao_p
			|| '-nr_atendimento_p: ' || nr_atendimento_p
			|| '-cd_estabelecimento_p: ' || cd_estabelecimento_p
			|| '-cd_perfil_p: ' || cd_perfil_p
			|| '-nm_usuario_p: ' || nm_usuario_p
			|| '-cd_setor_atendimento_p: ' || cd_setor_atendimento_p
			|| '-ie_origem_inf_p: ' || ie_origem_inf_p
			|| '-cd_convenio_p: ' || cd_convenio_p 
			|| '-dt_inicio_prescr_p: ' || to_char(dt_inicio_prescr_p,'dd/mm/yyyy hh24:mi:ss')
			|| '-dt_inicio_ret_p: ' || to_char(dt_inicio_ret_p,'dd/mm/yyyy hh24:mi:ss')
			|| '-ds_horarios_w: ' || ds_horarios_w
			|| '-dt_inicio_w: ' || to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss')
			|| '-dt_fim_proc_w: ' || to_char(dt_fim_proc_w,'dd/mm/yyyy hh24:mi:ss')
			|| '-ie_acm_w: ' || ie_acm_w
			|| '-ie_se_necessario_w: ' || ie_se_necessario_w
			|| '-cd_intervalo_w: ' || cd_intervalo_w, 1, 2000),
			nr_atendimento_p, 'P', nr_sequencia_p);
	end;
	
	if (cd_setor_atendimento_p IS NOT NULL AND cd_setor_atendimento_p::text <> '') and (obter_se_setor_exec( cd_setor_atendimento_p, cd_estabelecimento_p, cd_procedimento_w, ie_origem_proced_w, nr_seq_proc_interno_w ) = 'S')then
		cd_setor_atendimento_w := cd_setor_atendimento_p;
		cd_setor_atendimento_ww := cd_setor_atendimento_w;
	end if;

	begin
		select max(cd_setor_atendimento)
		into STRICT cd_setor_atendimento_cpoe_w
		from cpoe_procedimento
		where nr_sequencia = nr_sequencia_p
		and nr_atendimento = nr_atendimento_p;
		
		if (coalesce(cd_setor_atendimento_cpoe_w::text, '') = '')  then		
			if (obter_se_gerar_setor_rotina(cd_estabelecimento_p,924,cd_procedimento_w,ie_origem_proced_w,nr_seq_proc_interno_w,nr_seq_exame_w,cd_setor_atendimento_p,nm_usuario_p) = 'S') then
				
				if (coalesce(cd_setor_atendimento_p::text, '') = '') then
					cd_setor_atendimento_w := obter_setor_atend_proc(cd_estabelecimento_p,cd_procedimento_w,ie_origem_proced_w,null,null,null,nr_seq_proc_interno_w, nr_atendimento_p);
					if (coalesce(cd_setor_atendimento_w::text, '') = '')then
						cd_setor_atendimento_w := Obter_setor_Atend_proc_lab(cd_estabelecimento_p,cd_procedimento_w,ie_origem_proced_w,null,cd_setor_atendimento_p,null,nr_seq_exame_w, nr_atendimento_p);
					end if;
				else
					cd_setor_atendimento_w := obter_setor_atend_proc(cd_estabelecimento_p,cd_procedimento_w,ie_origem_proced_w,null,cd_setor_atendimento_p,null,nr_seq_proc_interno_w, nr_atendimento_p);
					if (coalesce(cd_setor_atendimento_w::text, '') = '')then
						cd_setor_atendimento_w := Obter_setor_Atend_proc_lab(cd_estabelecimento_p,cd_procedimento_w,ie_origem_proced_w,null,cd_setor_atendimento_p,null,nr_seq_exame_w, nr_atendimento_p);
					end if;
				end if;
				
				if (coalesce(cd_setor_atendimento_w::text, '') = '') then
					select obter_setor_atend_proc_estab(cd_procedimento_w,ie_origem_proced_w,null,cd_setor_atendimento_p,null,nr_seq_proc_interno_w, nr_atendimento_p)
					into STRICT   cd_setor_atendimento_w
					;
					
					 if ((coalesce(cd_setor_atendimento_w::text, '') = '') and (ie_gerar_setor_exec_proc_w = 'S')) then
						cd_setor_atendimento_w := cd_setor_atendimento_ww;
					 end if;
				end if;

			end if;
		else
			cd_setor_atendimento_w := cd_setor_atendimento_cpoe_w;
		end if;
		
		if (coalesce(cd_setor_atendimento_w::text, '') = '') then
			param_REP_42_w := obter_param_usuario(924, 42, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, param_REP_42_w);
			param_REP_136_w := obter_param_usuario(924, 136, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, param_REP_136_w);
			cd_setor_atendimento_w := cpoe_obter_setor_prescricao(param_REP_42_w, param_REP_136_w, cd_setor_atendimento_p, nr_atendimento_p, cd_perfil_p, nm_usuario_p, cd_setor_atendimento_w);
			
			if (coalesce(cd_setor_atendimento_w::text, '') = '') then
				cd_setor_atendimento_w := cpoe_obter_setor_atend_prescr( nr_atendimento_p, cd_estabelecimento_p,cd_perfil_p, nm_usuario_p );
			end if;
		end if;
	exception when others then
		cd_setor_atendimento_w := null;
	end;

    ds_justificativa_item_w := cpoe_obter_justificativa_item(nr_sequencia_p, nr_seq_proc_interno_w,'P');

    if (ds_justificativa_w IS NOT NULL AND ds_justificativa_w::text <> '') then
        if (ds_justificativa_item_w IS NOT NULL AND ds_justificativa_item_w::text <> '') then
            ds_justificativa_ww := substr(ds_justificativa_w, 1, 1999);
            ds_justificativa_w := ds_justificativa_ww || chr(13) || ds_justificativa_item_w;
        end if;
    else
        ds_justificativa_w := ds_justificativa_item_w;
    end if;

	if (coalesce(nr_atendimento_p,0) > 0) and (coalesce(ie_vinc_seq_agend_w,'N') = 'S') then
		
		select	max(a.cd_pessoa_fisica)
		into STRICT	cd_pessoa_fis_agenda_w 
		from	atendimento_paciente a 
		where	a.nr_atendimento	= nr_atendimento_p;

		nr_seq_agenda_serv_w := Age_obt_regra_vinc_proc_rep( dt_inicio_prescr_p, cd_pessoa_fis_agenda_w, cd_estabelecimento_p, nr_seq_proc_interno_w, nm_usuario_p, nr_seq_agenda_serv_w);			
		
	end if;
	
	if (position(' ' in trim(both ds_horarios_w)) > 0) then
		ie_urgencia_w := null;
	end if;
	
	select	coalesce(max(nr_sequencia),0) + 1
	into STRICT	nr_sequencia_w
	from 	prescr_procedimento
	where	nr_prescricao	= nr_prescricao_p;	
	
	begin
		insert into prescr_procedimento(
				nr_prescricao,
				nr_seq_proc_cpoe,
				ie_origem_proced,
				nr_sequencia,
				cd_procedimento,
				qt_procedimento,
				ie_origem_inf,
				ds_horarios,
				ds_observacao,
				ds_justificativa,
				dt_atualizacao,
				nm_usuario,
				cd_intervalo,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ie_urgencia,
				dt_prev_execucao,
				cd_material_exame,
				ds_material_especial,
				ie_se_necessario,
				ie_acm,
				nr_seq_proc_interno,
				ie_lado,
				nr_seq_topografia,
				nr_seq_prot_glic,
				dt_resultado,
				nr_doc_convenio,
				nr_seq_exame,
				cd_setor_atendimento,
				cd_motivo_baixa,
				ie_orientar_paciente,
				ie_util_hemocomponente,
				ie_unid_med_hemo,
				ie_autorizacao,
				ie_amostra,
				ie_coleta_externa,
				ie_executar_leito,
				ie_suspenso,
				ie_externo,
				ie_avisar_result,
				ie_exame_bloqueado,
				ie_aliquotado,
				ie_filtrado,
				ie_lavado,
				ie_fenotipado,
				ie_irradiado,
				ie_proced_bloqueado,
				ie_exige_liberacao,
				ie_imagem_pacs,
				ie_baixa_dep_lab,
				ie_descricao_cirurgica,
				ie_modificado,
				ie_pendente_amostra,
				ie_email_aprovacao,
				ie_prev_execucao_alt,
				ie_horario_susp,
				ie_anestesia,
				ie_result_lab_gerado,
				ie_em_protocolo_vanco,
				ie_tipo_proced,
				ie_emite_mapa,
				ie_cobra_paciente,
				ie_mostrar_web,
				ie_plano,
				ie_alterar_horario,
				ie_aprovacao_execucao,
				ie_lote_ent_exibe_result,
				nr_ocorrencia,
				dt_inicio,
				dt_fim,
				ie_administrar,
				dt_proxima_dose,
				nr_prescricao_original,
				nr_seq_anterior,
				ds_dado_clinico,
				nr_seq_agenda,
				nr_seq_agenda_cons,
				nr_seq_contraste,
				nr_seq_avaliacao,
				nr_seq_condicao,
				nr_seq_rotina_especial,
				cd_protocolo,
				nr_seq_protocolo,
				cd_setor_coleta,
				cd_setor_entrega,
				nr_seq_rotina,
				cd_medico_exec,
                ie_kit_gerado)
			values (
				nr_prescricao_p,
				nr_sequencia_cpoe_w,
				ie_origem_proced_w,
				nr_sequencia_w,
				cd_procedimento_w,
				qt_procedimento_w,
				ie_origem_inf_p,
				ds_horarios_w,
				ds_observacao_w,
				ds_justificativa_w,
				dt_atualizacao_w,
				nm_usuario_w,
				cd_intervalo_w,
				dt_atualizacao_nrec_w,
				nm_usuario_nrec_w,
				CASE WHEN coalesce(ie_urgencia_w::text, '') = '' THEN 'N'  ELSE 'S' END ,
				dt_inicio_w,
				cd_material_exame_w,
				ds_material_especial_w,
				ie_se_necessario_w,
				ie_acm_w,
				nr_seq_proc_interno_w,
				CASE WHEN ie_lado_w='N' THEN null  ELSE ie_lado_w END ,
				nr_seq_topografia_w,
				nr_seq_prot_glic_w,
				dt_entrega_w,
				nr_doc_convenio_w,
				nr_seq_exame_w,
				cd_setor_atendimento_w,
				0,
				'N',
				'C',
				'gpm',
				'L',
				ie_amostra_w,
				'N',
				coalesce(ie_executar_leito_w,'N'),
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				coalesce(ie_anestesia_w,'N'),
				'N',
				'N',
				'O',
				'S',
				'S',
				'S',
				'S',
				'S',
				'S',
				'S',
				nr_ocorrencia_w,
				dt_inicio_base_w,
				dt_inicio_base_w,
				ie_administrar_w,
				dt_proxima_dose_w,
				nr_prescricao_orig_w,
				nr_sequencia_orig_w,
				ds_dado_clinico_w,
				nr_seq_agenda_w,
				nr_seq_agenda_serv_w,
				nr_seq_contraste_w,
				nr_seq_avaliacao_w,
				nr_seq_condicao_w,
				nr_seq_rotina_especial_w,
				cd_protocolo_w,
				nr_seq_protocolo_w,
				cd_setor_coleta_w,
				coalesce(cd_setor_entrega_ww,cd_setor_entrega_w),
				nr_seq_proc_rotina_w,
				cd_medico_exec_w,
                ie_kit_gerado_w);

	exception when others then
		CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG EXCEPTION INSERT PRESCR_PROCEDIMENTO:'||substr(to_char(sqlerrm),1,2000)
			||' nr_sequencia_p:'|| nr_sequencia_p
			||' nr_prescricao_p :'	 || nr_prescricao_p
			||' nr_sequencia_cpoe_w:'  || nr_sequencia_cpoe_w
			||' cd_procedimento_w:'	 || cd_procedimento_w
			||' ie_origem_proced_w'	 || ie_origem_proced_w	
			||' qt_procedimento_w: ' || qt_procedimento_w
			||' ie_origem_inf_p: ' || ie_origem_inf_p
			||' ds_horarios_w: ' || ds_horarios_w
			||' ds_observacao_w: ' || ds_observacao_w
			||' ds_justificativa_w: ' || ds_justificativa_w
			||' dt_atualizacao_w: '|| dt_atualizacao_w
			||' nm_usuario_w: ' || nm_usuario_w
			||' cd_intervalo_w: ' 	 || cd_intervalo_w
			||' dt_inicio_w: ' 	 	|| to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss')
			||' cd_material_exame_w: ' || cd_material_exame_w
			||' ds_material_especial_w: '|| ds_material_especial_w
			||' ie_se_necessario_w: '|| ie_se_necessario_w
			||' ie_acm_w: ' || ie_acm_w
			||' nr_seq_proc_interno_w: ' || nr_seq_proc_interno_w
			||' ie_lado_w: ' 	 	|| ie_lado_w
			||' nr_seq_topografia_w: ' || nr_seq_topografia_w
			||' nr_seq_prot_glic_w: ' || nr_seq_prot_glic_w
			||' dt_entrega_w: ' || to_char(dt_entrega_w,'dd/mm/yyyy hh24:mi:ss')
			||' nr_doc_convenio_w: ' 	|| nr_doc_convenio_w
			||' nr_seq_exame_w: ' || nr_seq_exame_w
			||' cd_setor_atendimento_w: '|| cd_setor_atendimento_w
			||' nr_ocorrencia_w: ' 	|| nr_ocorrencia_w
			||' dt_inicio_base_w: ' || to_char(dt_inicio_base_w,'dd/mm/yyyy hh24:mi:ss')
			||' ie_administrar_w: ' || ie_administrar_w
			||' dt_proxima_dose_w: '|| dt_proxima_dose_w	
			||' nr_prescricao_orig_w: '	|| nr_prescricao_orig_w
			||' nr_sequencia_orig_w: ' || nr_sequencia_orig_w,1,2000),
			nr_atendimento_p, 'P', nr_sequencia_p);
	end;				
				
	begin
		if (nr_seq_prot_glic_w IS NOT NULL AND nr_seq_prot_glic_w::text <> '') then
			CALL cpoe_gerar_proc_glic_reg(nr_prescricao_p,nr_atendimento_p, nr_sequencia_p, nr_seq_prot_glic_w, nr_sequencia_w, nm_usuario_p, cd_pessoa_fisica_p);
		end if;
	exception when others then
		CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG EXCEPTION CPOE_GERAR_PROC_GLIC_REG:'||substr(to_char(sqlerrm),1,2000)
			||' nr_sequencia_p:'	     || nr_sequencia_p
			||' nr_prescricao_p :'	 || nr_prescricao_p
			||' nr_sequencia_w:'    	 || nr_sequencia_w,1,2000),
			nr_atendimento_p, 'P', nr_sequencia_p);
	end;	
	
	if (ie_copia_diaria_p = 'S') and (coalesce(dt_fim_w::text, '') = '' or dt_fim_w > clock_timestamp())	then
		update CPOE_MATERIAL
		set dt_fim = dt_fim + 1
		where ie_material = 'S'
		and nr_seq_procedimento = nr_sequencia_p
		and dt_fim < clock_timestamp();
	end if;
	
	CPOE_Inserir_medic_assoc;
	CPOE_Inserir_mat_assoc;
	
	<<proximo_item>>
	commit;
	end;
end loop;
close cProcedimentos;

open c02;
	loop
	fetch c02 into
			nr_seq_interno_w,
			nr_seq_proc_princ_cpoe_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */

		begin
		
		select	nr_seq_interno
		into STRICT	nr_seq_interno_update_w
		from	prescr_procedimento
		where	nr_seq_proc_cpoe = 	nr_seq_proc_princ_cpoe_w;

			
		update	prescr_procedimento
		set		nr_seq_proc_princ = nr_seq_interno_update_w
		where	nr_seq_interno = nr_seq_interno_w;	
		
		commit;
		end;
	end loop;
close c02;

begin
	CALL reordenar_procedimento(nr_prescricao_p);
exception when others then	
	CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG EXCEPTION REORDENAR_PROCEDIMENTO:'||substr(to_char(sqlerrm),1,2000)
		||' nr_sequencia_p:'|| nr_sequencia_p
		||' nr_prescricao_p :'	 || nr_prescricao_p,1,2000),
		nr_atendimento_p, 'P', nr_sequencia_p);
end;

begin
	CALL cpoe_check_special_appproval('CPOE_PROCEDIMENTO', nr_sequencia_p, nm_usuario_p);
exception when others then	
	CALL GRAVAR_LOG_CPOE(SUBSTR('CPOE_INSERT_PRESCR_PROCED_REG EXCEPTION CPOE_CHECK_SPECIAL_APPPROVAL:'||SUBSTR(TO_CHAR(SQLERRM),1,2000)
		||' nr_sequencia_p:'|| nr_sequencia_p
		||' nr_prescricao_p :'	 || nr_prescricao_p,1,2000),
		nr_atendimento_p, 'P', nr_sequencia_p);
end;
commit;

exception when others then
	CALL gravar_log_cpoe(substr('CPOE_INSERT_PRESCR_PROCED_REG EXCEPTION:'||substr(to_char(sqlerrm),1,2000)
			||' nr_sequencia_p:'||nr_sequencia_p||'nr_prescricao_p:'||nr_prescricao_p
			||' nr_atendimento_p:'||nr_atendimento_p||'cd_estabelecimento_p'||cd_estabelecimento_p
			||' cd_perfil_p:'||cd_perfil_p||'nm_usuario_p : '||nm_usuario_p||'cd_setor_atendimento_p:'||cd_setor_atendimento_p
			||' ie_origem_inf_p:'||ie_origem_inf_p||'cd_convenio_p'||cd_convenio_p 
			||' dt_inicio_prescr_p :'||to_char(dt_inicio_prescr_p,'dd/mm/yyyy hh24:mi:ss')
			||' dt_inicio_ret_p :'||to_char(dt_inicio_ret_p,'dd/mm/yyyy hh24:mi:ss'),1,2000),
		nr_atendimento_p, 'P', nr_sequencia_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_insert_prescr_proced_reg (( nr_atendimento_p bigint, nr_prescricao_p bigint, nr_sequencia_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_setor_atendimento_p bigint, ie_origem_inf_p text, cd_convenio_p bigint, dt_inicio_prescr_p timestamp, dt_inicio_ret_p out timestamp, cd_pessoa_fisica_p text, ie_copia_diaria_p char default 'N') is qt_procedimento_w cpoe_procedimento.qt_procedimento%type) FROM PUBLIC;

