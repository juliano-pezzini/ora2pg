-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE importa_extrato_hsbc_240 ( nr_seq_extrato_p bigint) AS $body$
DECLARE


nr_seq_conta_W		bigint;
vl_saldo_inicial_w		double precision;
vl_saldo_final_w		double precision;
dt_saldo_inicial_w		timestamp;
dt_saldo_final_w		timestamp;
nr_seq_extrato_w		bigint;
nr_seq_conta_nova_w	bigint;
nr_conta_ant_w		varchar(13)	:= '-1';
ie_digito_ant_w		varchar(1);
ie_deb_cred_saldo_ini_w	varchar(1);
ie_deb_cred_saldo_fin_w	varchar(1);
cd_banco_w		smallint;

/* Registro detalhe */

nr_documento_w		varchar(39) := '0';
dt_lancamento_w		varchar(8);
vl_lancamento_w		varchar(18);
ie_deb_cred_w		varchar(1);
nr_conta_w		varchar(11);
digito_conta_w		varchar(1);
ds_historico_w		varchar(25);
nr_lote_w			varchar(4);
ie_natureza_w		varchar(3);
cd_historico_w		varchar(4);
nr_cred_deb_w		smallint;

/* Saldos inicial e final sem lan√ßamentos */

qt_lancamento_w		bigint;
nr_sequencia_w		bigint;
nr_seq_final_w		bigint;
nr_Seq_banco_extrato_w	bigint;

nr_conta_estab_w	banco_estabelecimento.cd_conta%type;
ie_digito_w		banco_estabelecimento.ie_digito_conta%type;

c01 CURSOR FOR
SELECT	substr(ds_conteudo,30,11) nr_conta,
	substr(ds_conteudo,41,1) digito_conta,
	substr(ds_conteudo,81,6) dt_lancamento,
	substr(ds_conteudo,87,18) vl_lancamento,
	substr(ds_conteudo,43,3) nr_cred_deb_w,
	substr(ds_conteudo,111,4) nr_lote,
	substr(ds_conteudo,75,6) nr_documento
from	w_interf_concil
where	substr(ds_conteudo,1,1)		= '1'
and	substr(ds_conteudo,42,1)	= '1'
and	ltrim(substr(ds_conteudo,30,11),'0')	= nr_conta_estab_w
and	substr(ds_conteudo,41,1)	= ie_digito_w;


BEGIN

Select	max(b.nr_seq_conta),
	max(a.cd_banco),
	max(a.cd_conta),
	max(ie_digito_conta)
into STRICT	nr_seq_conta_w,
	cd_banco_w,
	nr_conta_estab_w,
	ie_digito_w
from	banco_estabelecimento a,
	banco_extrato b
where	b.nr_seq_conta	= a.nr_sequencia
and	b.nr_sequencia	= nr_seq_extrato_p;

open c01;
loop
fetch c01 into
	nr_conta_w,
	digito_conta_w,
	dt_lancamento_w,
	vl_lancamento_w,
	nr_cred_deb_w,
	nr_lote_w,
	nr_documento_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	if (nr_conta_ant_w	= '-1') or (nr_conta_ant_w <> nr_conta_w) or (ie_digito_ant_w <> digito_conta_w) then

		nr_conta_ant_w	:= nr_conta_w;
		ie_digito_ant_w := digito_conta_w;

		/* saldo anterior */

		select	substr(ds_conteudo,87,18) vl_lancamento,
			substr(ds_conteudo,81,6) dt_lancamento,
			substr(ds_conteudo,105,1) ie_deb_cred_saldo_ini
		into STRICT	vl_saldo_inicial_w,
			dt_saldo_inicial_w,
			ie_deb_cred_saldo_ini_w
		from	w_interf_concil a
		where	substr(ds_conteudo,41,1)	= digito_conta_w
		and	substr(ds_conteudo,30,11)	= nr_conta_w
		and	substr(ds_conteudo,1,1)		= '1'
		and	substr(ds_conteudo,42,1)	= '0'
		and	a.nr_seq_conta			= nr_seq_conta_w;

		/* saldo atual */

		select	substr(ds_conteudo,87,18) vl_lancamento,
			substr(ds_conteudo,81,6) dt_lancamento,
			substr(ds_conteudo,105,1) ie_deb_cred_saldo_fin
		into STRICT	vl_saldo_final_w,
			dt_saldo_final_w,
			ie_deb_cred_saldo_fin_w
		from	w_interf_concil a
		where	substr(ds_conteudo,41,1)	= digito_conta_w
		and	substr(ds_conteudo,30,11)	= nr_conta_w
		and	substr(ds_conteudo,1,1)		= '1'
		and	substr(ds_conteudo,42,1)	= '2'
		and	a.nr_seq_conta			= nr_seq_conta_w;

		select	max(a.nr_sequencia)
		into STRICT	nr_seq_conta_nova_w
		from	banco_estabelecimento a
		where (a.nr_sequencia = nr_seq_conta_w or
			not exists (SELECT	1
			from	banco_estabelecimento x
			where	x.ie_digito_conta	= a.ie_digito_conta
			and	x.cd_conta		= a.cd_conta
			and	x.nr_sequencia		= nr_seq_conta_w))
		and	somente_numero(a.cd_conta)||somente_numero(a.ie_digito_conta) = somente_numero(nr_conta_w)||somente_numero(coalesce(trim(both digito_conta_w),a.ie_digito_conta))
		and	cd_banco				= cd_banco_w;

		if (coalesce(nr_seq_conta_nova_w::text, '') = '') then

			select	max(a.nr_sequencia)
			into STRICT	nr_seq_conta_nova_w
			from	banco_estabelecimento a
			where (a.nr_sequencia = nr_seq_conta_w or
				not exists (SELECT	1
				from	banco_estabelecimento x
				where	x.ie_digito_conta	= a.ie_digito_conta
				and	x.cd_conta		= a.cd_conta
				and	x.nr_sequencia		= nr_seq_conta_w))
			and	somente_numero(a.ie_digito_conta)	= somente_numero(coalesce(trim(both digito_conta_w),a.ie_digito_conta))
			and	somente_numero(a.cd_conta)		= somente_numero(nr_conta_w)
			and	cd_banco				= cd_banco_w;

		end if;

		select 	max(nr_seq_conta)
		into STRICT	nr_SeQ_conta_nova_w
		from	banco_extrato
		where	nr_sequencia = nr_seq_extrato_p;

		if (coalesce(nr_seq_conta_nova_w::text, '') = '') and (digito_conta_w = ' ') then

			select	max(a.nr_sequencia)
			into STRICT	nr_seq_conta_nova_w
			from	banco_estabelecimento a
			where (a.nr_sequencia = nr_seq_conta_w or
				not exists (SELECT	1
				from	banco_estabelecimento x
				where	x.ie_digito_conta	= a.ie_digito_conta
				and	x.cd_conta		= a.cd_conta
				and	x.nr_sequencia		= nr_seq_conta_w))
			and	somente_numero(a.ie_digito_conta)	= somente_numero(coalesce(trim(both substr(nr_conta_w,13,1)),a.ie_digito_conta))
			and	somente_numero(a.cd_conta)		= somente_numero(substr(nr_conta_w,1,12))
			and	cd_banco				= cd_banco_w;

		end if;

		if (ie_deb_cred_saldo_ini_w	= 'D') then
			vl_saldo_inicial_w	:= coalesce(vl_saldo_inicial_w,0) * -1;
		end if;

		if (ie_deb_cred_saldo_fin_w	= 'D') then
			vl_saldo_final_w	:= coalesce(vl_saldo_final_w,0) * -1;
		end if;


		if (nr_seq_conta_w	= nr_seq_conta_nova_w ) or (coalesce(nr_seq_conta_nova_w::text, '') = '') then

			nr_seq_extrato_w	:= nr_seq_extrato_p;
			nr_seq_conta_nova_w	:= nr_seq_conta_w;

			update	banco_extrato
			set	vl_saldo_inicial	= vl_saldo_inicial_w,
				vl_saldo_final		= vl_saldo_final_w,
				dt_inicio		= dt_saldo_inicial_w,
				dt_final		= dt_saldo_final_w,
				dt_atualizacao		= clock_timestamp()
			where	nr_sequencia		= nr_seq_extrato_w;

		elsif (nr_seq_conta_nova_w IS NOT NULL AND nr_seq_conta_nova_w::text <> '') then

			select	nextval('banco_extrato_seq')
			into STRICT	nr_seq_extrato_w
			;

			insert	into banco_extrato(dt_atualizacao,
				dt_atualizacao_nrec,
				dt_final,
				dt_importacao,
				dt_inicio,
				nm_usuario,
				nm_usuario_nrec,
				nr_seq_conta,
				nr_sequencia,
				vl_saldo_final,
				vl_saldo_inicial)
			values (clock_timestamp(),
				clock_timestamp(),
				dt_saldo_final_w,
				clock_timestamp(),
				dt_saldo_inicial_w,
				'Tasy',
				'Tasy',
				nr_seq_conta_nova_w,
				nr_seq_extrato_w,
				vl_saldo_final_w,
				vl_saldo_inicial_w);

		end if;

	end if;

	if (nr_seq_conta_nova_w IS NOT NULL AND nr_seq_conta_nova_w::text <> '') or (coalesce(nr_Seq_conta_nova_w::text, '') = '') then

	if (nr_cred_deb_w between 101 and 122) then
			ie_deb_cred_w := 'D';

		elsif (nr_cred_deb_w between 201 and 216) then
			ie_deb_cred_w := 'C';
		end if;

	select	nextval('banco_extrato_lanc_seq')
	into STRICT	nr_Seq_banco_extrato_w
	;

		insert	into banco_extrato_lanc(nr_documento,
			dt_movimento,
			vl_lancamento,
			ie_deb_cred,
			nr_seq_extrato,
			nr_sequencia,
			nm_usuario,
			ie_conciliacao,
			dt_atualizacao,
			--ds_historico,
			nr_lote)
			--ie_natureza,
			--cd_historico)
		values (nr_documento_w,
			to_date(dt_lancamento_w,'dd/mm/yy'),
			somente_numero(vl_lancamento_w) / 100,
			ie_deb_cred_w,
			nr_seq_extrato_w,
			nextval('banco_extrato_lanc_seq'),
			'Tasy',
			'N',
			clock_timestamp(),
			--ds_historico_w,
			nr_lote_w);
			--ie_natureza_w,
			--cd_historico_w);
	end if;

end loop;
close c01;

delete 	from w_interf_concil
where	nr_seq_conta	= nr_seq_conta_W;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importa_extrato_hsbc_240 ( nr_seq_extrato_p bigint) FROM PUBLIC;

