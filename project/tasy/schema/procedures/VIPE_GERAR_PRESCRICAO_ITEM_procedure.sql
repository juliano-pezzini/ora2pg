-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vipe_gerar_prescricao_item ( cd_estabelecimento_p bigint, nr_prescricao_p bigint, nr_atendimento_p bigint, cd_material_novo_p bigint, cd_material_p bigint, nr_seq_item_p bigint, cd_intervalo_p text, cd_intervalo_novo_p text, ie_acm_sn_p text, qt_dose_p bigint, ie_via_aplicacao_p text, nr_prescricoes_p text, dt_primeiro_horario_p timestamp, cd_unidade_med_p text, ds_horarios_p text, ie_susp_anterior_p text, ie_tipo_pessoa_p text, cd_perfil_p bigint, nm_usuario_p text, ds_dose_dif_p text, qt_dose_esp_p bigint, ds_justificativa_p text, ds_observacao_subs_p text, hr_dose_especial_p text, ie_dose_especial_p text, ie_se_necessario_p text, ie_acm_p text, ie_urgencia_p text, ie_interv_farm_p text, nr_nova_prescricao_p INOUT bigint, nr_seq_novo_item_p INOUT bigint, cd_funcao_p bigint ) AS $body$
DECLARE

 
nr_prescricao_w				bigint;
nr_prescricao_ww			bigint;
nr_atendimento_w			bigint;
nr_agrupamento_w			bigint;
nr_seq_composto_w			bigint;
nr_agrup_acum_w				bigint;
nr_seq_w					bigint;
nr_sequencia_w				bigint;
nr_seq_dil_w				bigint;
ie_agrup_w					bigint;
QT_ITENS_W					bigint;
nr_seq_item_w				integer;
dt_primeiro_horario_w		timestamp;
hr_dose_especial_w			varchar(255);
IE_LOOP_W					varchar(5);
ie_medico_w					varchar(5);
cd_prescritor_w				varchar(50);
VarCalculaValidade_w		varchar(5);
nr_horas_validade_w			bigint;
VarEstenderPrescricao_w		varchar(5);
ie_verificar_prescr_w		varchar(1);
ie_nova_prescricao_w		varchar(1):='S';
nr_prescricoes_w			varchar(255);
ie_pos_virgula_w			smallint;
ie_prescr_mat_sem_lib_w		varchar(30);
nr_prescricao_www			bigint;
nr_sequencia_ww				bigint;
ie_origem_inf_w				varchar(1);
cd_material_w				integer;
cd_unidade_medida_w			varchar(30);
qt_dose_w					double precision;
qt_unitaria_w				double precision;
qt_material_w				double precision;
dt_atualizacao_w			timestamp;
nm_usuario_w				varchar(15);
cd_intervalo_w				varchar(7);
ds_horarios_w				varchar(2000);
ds_observacao_w				varchar(4000);
ds_observacao_enf_w			varchar(2000);
ie_via_aplicacao_w			varchar(5);
nr_agrupamento_ww			double precision;
ie_cobra_paciente_w			varchar(1);
cd_motivo_baixa_w			smallint;
dt_baixa_w					timestamp;
ie_utiliza_kit_w			varchar(1);
cd_unidade_medida_dose_w	varchar(30);
qt_conversao_dose_w			double precision;
ie_urgencia_w				varchar(1);
nr_ocorrencia_w				double precision;
qt_total_dispensar_w		double precision;
cd_fornec_consignado_w		varchar(14);
nr_sequencia_solucao_w		integer;
nr_sequencia_proc_w			integer;
qt_solucao_w				double precision;
hr_dose_especial_ww			varchar(5);
qt_dose_especial_w			double precision;
ds_dose_diferenciada_w		varchar(50);
ie_medicacao_paciente_w		varchar(1);
nr_sequencia_diluicao_w		integer;
hr_prim_horario_w			varchar(5);
nr_sequencia_dieta_w		integer;
ie_agrupador_w				smallint;
nr_dia_util_w				bigint;
ie_suspenso_w				varchar(1);
ie_se_necessario_w			varchar(1);
qt_min_aplicacao_w			smallint;
ie_bomba_infusao_w			varchar(1);
ie_aplic_bolus_w			varchar(1);
ie_aplic_lenta_w			varchar(1);
ie_acm_w					varchar(1);
ie_objetivo_w				varchar(1);
cd_topografia_cih_w			bigint;
ie_origem_infeccao_w		varchar(1);
cd_amostra_cih_w			bigint;
cd_microorganismo_cih_w		bigint;
ie_uso_antimicrobiano_w		varchar(1);
cd_protocolo_w				bigint;
nr_seq_protocolo_w			integer;
nr_seq_mat_protocolo_w		integer;
qt_hora_aplicacao_w			smallint;
ie_recons_diluente_fixo_w	varchar(1);
qt_vel_infusao_w			double precision;
ds_justificativa_w			varchar(2000);
ie_sem_aprazamento_w		varchar(1);
ie_indicacao_w				varchar(1);
dt_proxima_dose_w			timestamp;
qt_total_dias_lib_w			integer;
nr_seq_substituto_w			integer;
ie_lado_w					varchar(1);
dt_inicio_medic_w			timestamp;
qt_dia_prim_hor_w			bigint;
ie_regra_disp_w				varchar(1);
qt_vol_adic_reconst_w		double precision;
qt_hora_intervalo_w			smallint;
qt_min_intervalo_w			integer;
ie_permite_substituir_w		varchar(1);
ie_dose_espec_agora_w		varchar(1);
ie_motivo_prescr_w			varchar(5);
cd_setor_atendimento_w		integer;
dt_prescricao_w				timestamp;
ie_limpa_prim_hor_acm_w		varchar(1);
qt_espacos_horarios_w		bigint;
ds_erro_w				varchar(255);

c01 CURSOR FOR 
	SELECT 	nr_prescricao_ww, 
			nr_seq_composto_w, 
			a.ie_origem_inf, 
			a.cd_material, 
			a.cd_unidade_medida, 
			a.qt_dose, 
			a.qt_unitaria, 
			a.qt_material, 
			clock_timestamp(), 
			nm_usuario_p, 
			cd_intervalo_novo_p, 
			ds_horarios_p, 
			--a.ds_observacao, 
			ds_observacao_subs_p, 
			a.ds_observacao_enf, 
			ie_via_aplicacao_p, 
			a.nr_agrupamento + nr_agrup_acum_w, 
			coalesce(a.ie_cobra_paciente,'S'),		 
			CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.cd_motivo_baixa  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  0  ELSE a.cd_motivo_baixa END  END , 
			CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  clock_timestamp()  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  null  ELSE clock_timestamp() END  END , 
			a.ie_utiliza_kit, 
			cd_unidade_medida_dose, 
			a.qt_conversao_dose, 
			coalesce(ie_urgencia_p,'N'), 
			a.nr_ocorrencia, 
			a.qt_total_dispensar, 
			a.cd_fornec_consignado, 
			null, 
			null, 
			a.qt_solucao, 
			hr_dose_especial_w, 
			CASE WHEN qt_dose_esp_p=0 THEN  null  ELSE 0 END , 
			ds_dose_dif_p, 
			a.ie_medicacao_paciente, 
			a.nr_sequencia_diluicao, 
			CASE WHEN ie_limpa_prim_hor_acm_w='S' THEN  CASE WHEN coalesce(ie_acm_p,coalesce(a.ie_acm,'N'))='S' THEN null  ELSE to_char(dt_primeiro_horario_p, 'hh24:mi') END   ELSE to_char(dt_primeiro_horario_p, 'hh24:mi') END , 
			null, 
			a.ie_agrupador, 
			a.nr_dia_util, 
			CASE WHEN b.ie_situacao='A' THEN  'N'  ELSE 'S' END , 
			coalesce(ie_se_necessario_p,a.ie_se_necessario), 
			a.qt_min_aplicacao, 
			a.ie_bomba_infusao, 
			coalesce(a.ie_aplic_bolus,'N'), 
			coalesce(a.ie_aplic_lenta,'N'), 
			coalesce(ie_acm_p,coalesce(a.ie_acm,'N')), 
			a.ie_objetivo, 
			a.cd_topografia_cih, 
			a.ie_origem_infeccao, 
			a.cd_amostra_cih, 
			a.cd_microorganismo_cih, 
			coalesce(a.ie_uso_antimicrobiano,'N'), 
			a.cd_protocolo, 
			a.nr_seq_protocolo, 
			a.nr_seq_mat_protocolo, 
			a.qt_hora_aplicacao, 
			'N', 
			a.qt_vel_infusao, 
			ds_justificativa_p, 
			a.ie_sem_aprazamento, 
			a.ie_indicacao, 
			a.dt_proxima_dose, 
			a.qt_total_dias_lib, 
			a.nr_seq_substituto, 
			a.ie_lado, 
			a.dt_inicio_medic,		 
			a.qt_dia_prim_hor, 
			CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.ie_regra_disp  ELSE null END , 
			a.qt_vol_adic_reconst, 
			a.qt_hora_intervalo, 
			a.qt_min_intervalo, 
			ie_permite_substituir, 
			ie_dose_especial_p 
	from	Material b, 
			Prescr_Material a 
	where	a.cd_material 	= b.cd_material 
	and		a.nr_prescricao = nr_prescricao_w 
	and		a.nr_agrupamento = nr_agrupamento_w 
	and		a.ie_agrupador	= ie_agrup_w 
	and		a.nr_sequencia	<> nr_seq_item_w;
	
c02 CURSOR FOR	 
	SELECT nr_prescricao_ww, 
			a.nr_sequencia + nr_seq_w, 
			a.ie_origem_inf, 
			a.cd_material, 
			a.cd_unidade_medida, 
			a.qt_dose, 
			a.qt_unitaria, 
			a.qt_material, 
			clock_timestamp(), 
			nm_usuario_p, 
			cd_intervalo_novo_p, 
			ds_horarios_p, 
			--a.ds_observacao, 
			ds_observacao_subs_p, 
			a.ds_observacao_enf, 
			ie_via_aplicacao_p, 
			a.nr_agrupamento + nr_agrup_acum_w, 
			coalesce(a.ie_cobra_paciente,'S'),		 
			CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.cd_motivo_baixa  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  0  ELSE a.cd_motivo_baixa END  END , 
			CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  clock_timestamp()  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  null  ELSE clock_timestamp() END  END , 
			a.ie_utiliza_kit, 
			cd_unidade_medida_dose, 
			a.qt_conversao_dose, 
			coalesce(ie_urgencia_p,'N'), 
			a.nr_ocorrencia, 
			a.qt_total_dispensar, 
			a.cd_fornec_consignado, 
			null, 
			null, 
			a.qt_solucao, 
			hr_dose_especial_w, 
			CASE WHEN qt_dose_esp_p=0 THEN  null  ELSE 0 END , 
			ds_dose_dif_p, 
			a.ie_medicacao_paciente, 
			nr_sequencia_w, 
			CASE WHEN ie_limpa_prim_hor_acm_w='S' THEN  CASE WHEN coalesce(ie_acm_p,coalesce(a.ie_acm,'N'))='S' THEN null  ELSE to_char(dt_primeiro_horario_p, 'hh24:mi') END   ELSE to_char(dt_primeiro_horario_p, 'hh24:mi') END , 
			null, 
			a.ie_agrupador, 
			a.nr_dia_util, 
			CASE WHEN b.ie_situacao='A' THEN  'N'  ELSE 'S' END , 
			coalesce(ie_se_necessario_p,a.ie_se_necessario), 
			a.qt_min_aplicacao, 
			a.ie_bomba_infusao, 
			coalesce(a.ie_aplic_bolus,'N'), 
			coalesce(a.ie_aplic_lenta,'N'), 
			coalesce(ie_acm_p,coalesce(a.ie_acm,'N')), 
			a.ie_objetivo, 
			a.cd_topografia_cih, 
			a.ie_origem_infeccao, 
			a.cd_amostra_cih, 
			a.cd_microorganismo_cih, 
			coalesce(a.ie_uso_antimicrobiano,'N'), 
			a.cd_protocolo, 
			a.nr_seq_protocolo, 
			a.nr_seq_mat_protocolo, 
			a.qt_hora_aplicacao, 
			'N', 
			a.qt_vel_infusao, 
			ds_justificativa_p, 
			a.ie_sem_aprazamento, 
			a.ie_indicacao, 
			a.dt_proxima_dose, 
			a.qt_total_dias_lib, 
			a.nr_seq_substituto, 
			a.ie_lado, 
			a.dt_inicio_medic,		 
			a.qt_dia_prim_hor, 
			a.ie_regra_disp, 
			a.qt_vol_adic_reconst, 
			a.qt_hora_intervalo, 
			a.qt_min_intervalo, 
			ie_permite_substituir, 
			ie_dose_especial_p 
	from	Material b, 
			Prescr_Material a 
	where	a.cd_material 	= b.cd_material 
	and		a.nr_prescricao = nr_prescricao_w 
	and		a.ie_agrupador	in (3,7,9) 
	and		a.nr_sequencia_diluicao	= nr_seq_item_w;


BEGIN 
 
VarCalculaValidade_w := Obter_Param_Usuario(924, 98, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, VarCalculaValidade_w);
VarEstenderPrescricao_w := Obter_Param_Usuario(924, 249, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, VarEstenderPrescricao_w);
ie_limpa_prim_hor_acm_w := Obter_Param_Usuario(924, 445, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_limpa_prim_hor_acm_w);
ie_prescr_mat_sem_lib_w := Obter_Param_Usuario(924, 530, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_prescr_mat_sem_lib_w);
qt_espacos_horarios_w := Obter_Param_Usuario(924, 1033, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, qt_espacos_horarios_w);
ie_verificar_prescr_w := Obter_Param_Usuario(8030, 47, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_verificar_prescr_w);
ie_motivo_prescr_w := Obter_Param_Usuario(8030, 65, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_motivo_prescr_w);
 
if (nr_prescricao_p = 0) then 
	 
	select 	Obter_Max_NrPrescricao(nr_prescricoes_p) 
	into STRICT	nr_prescricao_w 
	;
else	 
	nr_prescricao_w := nr_prescricao_p;
end if;
 
if (VarCalculaValidade_w	= 'R') then 
	 
	select	max(cd_setor_atendimento) 
	into STRICT	cd_setor_atendimento_w 
	from	prescr_medica 
	where	nr_prescricao	= nr_prescricao_w;
	 
	VarCalculaValidade_w	:= obter_se_calcula_validade(cd_setor_atendimento_w);
	 
end if;
 
if (nr_prescricao_w > 0) then	 
	begin 
	 
	select	max(cd_pessoa_fisica) 
	into STRICT	cd_prescritor_w 
	from	usuario 
	where	nm_usuario	= nm_usuario_p;
 
	if (cd_funcao_p = 950) then 
		if (coalesce(nr_nova_prescricao_p,0) > 0 ) then 
			 
			nr_prescricao_ww := nr_nova_prescricao_p;
			ie_nova_prescricao_w := 'N';
		else  
			select 	nextval('prescr_medica_seq') 
			into STRICT  	nr_prescricao_ww 
			;
		end if;
	else 
	 
		if (coalesce(ie_interv_farm_p,'N') = 'N') then 
 
				if (ie_verificar_prescr_w = 'S') then 
					select	max(nr_prescricao) 
					into STRICT 	nr_prescricao_ww 
					from	Prescr_medica 
					where	nr_atendimento 		= nr_atendimento_p 
					and	coalesce(dt_liberacao::text, '') = '' 
					and	coalesce(dt_liberacao_medico::text, '') = '' 
					and	cd_prescritor		= cd_prescritor_w 
					and	trunc(dt_prescricao,'dd') = trunc(clock_timestamp(),'dd');
					 
					 
					 
					if (coalesce(nr_prescricao_ww::text, '') = '') then 
						select 	nextval('prescr_medica_seq') 
						into STRICT  	nr_prescricao_ww 
						;
					else 
						ie_nova_prescricao_w := 'N';
					end if;
				else 
					select 	nextval('prescr_medica_seq') 
					into STRICT  	nr_prescricao_ww 
					;
				end if;
			 
		else 
			 
			  select	max(nr_prescricao) 
			  into STRICT 	nr_prescricao_ww 
			  from		Prescr_medica 
			  where	nr_prescricao_anterior = nr_prescricao_w;
			 
			 
			if (coalesce(nr_prescricao_ww::text, '') = '') then 
				select 	nextval('prescr_medica_seq') 
				into STRICT  	nr_prescricao_ww 
				;
			else 
				ie_nova_prescricao_w := 'N';
			end if;
		end if;
	end if;
	select	coalesce(max(dt_primeiro_horario),clock_timestamp()), 
		max(nr_atendimento) 
	into STRICT	dt_primeiro_horario_w, 
		nr_atendimento_w 
	from	prescr_medica 
	where	nr_prescricao = nr_prescricao_w;
	 
	--if	(to_char(dt_primeiro_horario_w,'hh24:mi') < to_char(sysdate,'hh24:mi')) then 
		dt_primeiro_horario_w	:= clock_timestamp();
	--end if; 
	 
	if (VarCalculaValidade_w	<> 'N') then 
		select	max(obter_horas_validade_prescr(clock_timestamp(),nr_atendimento_w,VarEstenderPrescricao_w,'A',clock_timestamp(),nr_prescricao_w)) 
		into STRICT	nr_horas_validade_w 
		;
	end if;
	 
	select	max(Obter_se_medico(cd_prescritor_w,'M')) 
	into STRICT	ie_medico_w 
	;
 
	dt_prescricao_w := to_date(to_char(clock_timestamp(),'dd/mm/yyyy')||' '||to_char(dt_primeiro_horario_w,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
	if (ie_nova_prescricao_w = 'S') then	 
		insert into prescr_medica( 
				nr_prescricao, 
				cd_pessoa_fisica, 
				nr_atendimento, 
				cd_medico, 
				dt_prescricao, 
				dt_atualizacao, 
				nm_usuario, 
				nm_usuario_original, 
				ds_observacao, 
				nr_horas_validade, 
				cd_motivo_baixa, 
				dt_baixa, 
				dt_primeiro_horario, 
				dt_liberacao, 
				dt_emissao_setor, 
				dt_emissao_farmacia, 
				cd_setor_atendimento, 
				dt_entrada_unidade, 
				ie_recem_nato, 
				ie_origem_inf, 
				nr_prescricao_anterior, 
				nr_prescricao_mae, 
				cd_protocolo, 
				nr_seq_protocolo, 
				nr_cirurgia, 
				nr_seq_agenda, 
				cd_estabelecimento, 
				ds_medicacao_uso, 
				cd_prescritor, 
				qt_altura_cm, 
				qt_peso, 
				ie_adep, 
				ie_prescr_emergencia, 
				ie_prescricao_alta, 
				ie_hemodialise, 
				ie_motivo_prescricao, 
				nr_prescricoes, 
				nr_seq_transcricao, 
				ie_prescr_farm, 
				cd_funcao_origem) 
		SELECT	nr_prescricao_ww, 
				cd_pessoa_fisica, 
				CASE WHEN nr_atendimento_p=0 THEN null  ELSE nr_atendimento_p END , 
				CASE WHEN ie_medico_w='S' THEN cd_prescritor_w  ELSE cd_medico END , 
				dt_prescricao_w, 
				clock_timestamp(), 
				nm_usuario_p, 
				nm_usuario_p, 
				ds_observacao, 
				coalesce(nr_horas_validade_w, nr_horas_validade), 
				null, 
				null, 
				dt_primeiro_horario_w, 
				null, 
				null, 
				null, 
				coalesce(obter_setor_atendimento(nr_atendimento),cd_setor_atendimento), 
				null, 
				'N', 
				ie_origem_inf, 
				nr_prescricao_w, 
				nr_prescricao_mae, 
				cd_protocolo, 
				nr_seq_protocolo, 
				nr_cirurgia, 
				null, 
				cd_estabelecimento, 
				ds_medicacao_uso, 
				coalesce(cd_prescritor_w, cd_prescritor), 
				qt_altura_cm, 
				qt_peso, 
				ie_adep, 
				'N', 
				'N', 
				ie_hemodialise, 
				coalesce(ie_motivo_prescr_w,ie_motivo_prescricao), 
				nr_prescricoes_p, 
				nr_seq_transcricao, 
				CASE WHEN coalesce(ie_interv_farm_p,'N')='N' THEN ie_prescr_farm  ELSE 'S' END , 
				coalesce(cd_funcao_p,0) 
		from	prescr_medica 
		where	nr_prescricao = nr_prescricao_w;
		commit;
	end if;	
	hr_dose_especial_w	:= hr_dose_especial_p;
	if (hr_dose_especial_p = ' : ') then 
		hr_dose_especial_w	:= '';
	end if;
	 
	if (nr_seq_item_p = 0) then 
		 
		select	max(nr_sequencia) 
		into STRICT	nr_seq_item_w 
		from 	prescr_material 
		where	nr_prescricao = nr_prescricao_w	 
		and	cd_material = cd_material_p 
		and	cd_intervalo = cd_intervalo_p 
		and	obter_se_acm_sn(ie_acm, ie_se_necessario) = ie_acm_sn_p;
	else 
		nr_seq_item_w := nr_seq_item_p;
	end if;
	 
	if (nr_seq_item_w IS NOT NULL AND nr_seq_item_w::text <> '') and (nr_seq_item_w > 0) then 
		begin 
		 
		nr_sequencia_w	:= nr_seq_item_w;
		ie_loop_w	:= 'S';
		while(ie_loop_w = 'S') loop 
			select	count(*) 
			into STRICT	qt_itens_w 
			from	prescr_material 
			where	nr_prescricao	= nr_prescricao_ww 
			and	nr_sequencia	= nr_sequencia_w;
			if (qt_itens_w	= 0) then 
				ie_loop_w	:= 'N';
			else	 
				nr_sequencia_w	:= nr_sequencia_w + 1;
			end if;
		end loop;
		 
		select	coalesce(max(nr_agrupamento),0) 
		into STRICT	nr_agrup_acum_w 
		from	prescr_material a 
		where	a.nr_prescricao = nr_prescricao_ww 
		and	a.ie_agrupador = 1;
			 
		Insert into Prescr_Material( 
				nr_prescricao, 
				nr_sequencia, 
				ie_origem_inf, 
				cd_material, 
				cd_unidade_medida, 
				qt_dose, 
				qt_unitaria, 
				qt_material, 
				dt_atualizacao, 
				nm_usuario, 
				cd_intervalo, 
				ds_horarios, 
				ds_observacao, 
				ds_observacao_enf, 
				ie_via_aplicacao, 
				nr_agrupamento, 
				ie_cobra_paciente, 
				cd_motivo_baixa, 
				dt_baixa, 
				ie_utiliza_kit, 
				cd_unidade_medida_dose, 
				qt_conversao_dose, 
				ie_urgencia, 
				nr_ocorrencia, 
				qt_total_dispensar, 
				cd_fornec_consignado, 
				nr_sequencia_solucao, 
				nr_sequencia_proc, 
				qt_solucao, 
				hr_dose_especial, 
				qt_dose_especial, 
				ds_dose_diferenciada, 
				ie_medicacao_paciente, 
				nr_sequencia_diluicao, 
				hr_prim_horario, 
				nr_sequencia_dieta, 
				ie_agrupador, 
				nr_dia_util, 
				ie_suspenso, 
				ie_se_necessario, 
				qt_min_aplicacao, 
				ie_bomba_infusao, 
				ie_aplic_bolus, 
				ie_aplic_lenta, 
				ie_acm, 
				ie_objetivo, 
				cd_topografia_cih, 
				ie_origem_infeccao, 
				cd_amostra_cih, 
				cd_microorganismo_cih, 
				ie_uso_antimicrobiano, 
				cd_protocolo, 
				nr_seq_protocolo, 
				nr_seq_mat_protocolo, 
				qt_hora_aplicacao, 
				ie_recons_diluente_fixo, 
				qt_vel_infusao, 
				ds_justificativa, 
				ie_sem_aprazamento, 
				ie_indicacao, 
				dt_proxima_dose, 
				qt_total_dias_lib, 
				nr_seq_substituto, 
				ie_lado, 
				dt_inicio_medic, 
				qt_dia_prim_hor, 
				ie_regra_disp, 
				qt_vol_adic_reconst, 
				qt_hora_intervalo, 
				qt_min_intervalo, 
				ie_permite_substituir, 
				ie_dose_espec_agora)		 
		SELECT nr_prescricao_ww, 
		   	nr_sequencia_w, 
				a.ie_origem_inf, 
				cd_material_novo_p, 
				a.cd_unidade_medida, 
				qt_dose_p, 
				a.qt_unitaria, 
				a.qt_material, 
				clock_timestamp(), 
				nm_usuario_p, 
				cd_intervalo_novo_p, 
				ds_horarios_p, 
				--a.ds_observacao, 
				ds_observacao_subs_p, 
				a.ds_observacao_enf, 
				ie_via_aplicacao_p, 
				a.nr_agrupamento + nr_agrup_acum_w, 
				coalesce(a.ie_cobra_paciente,'S'),		 
				CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.cd_motivo_baixa  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  0  ELSE a.cd_motivo_baixa END  END , 
				CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  clock_timestamp()  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  null  ELSE clock_timestamp() END  END , 
				a.ie_utiliza_kit, 
				cd_unidade_med_p, 
				a.qt_conversao_dose, 
				coalesce(ie_urgencia_p,'N'), 
				a.nr_ocorrencia, 
				a.qt_total_dispensar, 
				a.cd_fornec_consignado, 
				null, 
				null, 
				a.qt_solucao, 
				hr_dose_especial_w, 
				CASE WHEN qt_dose_esp_p=0 THEN  null  ELSE 0 END , 
				ds_dose_dif_p, 
				a.ie_medicacao_paciente, 
				a.nr_sequencia_diluicao, 
				CASE WHEN ie_limpa_prim_hor_acm_w='S' THEN  CASE WHEN coalesce(ie_acm_p,coalesce(a.ie_acm,'N'))='S' THEN null  ELSE to_char(dt_primeiro_horario_p, 'hh24:mi') END   ELSE to_char(dt_primeiro_horario_p, 'hh24:mi') END , 
				null, 
				a.ie_agrupador, 
				a.nr_dia_util, 
				CASE WHEN b.ie_situacao='A' THEN  'N'  ELSE 'S' END , 
				coalesce(ie_se_necessario_p,a.ie_se_necessario), 
				a.qt_min_aplicacao, 
				a.ie_bomba_infusao, 
				coalesce(a.ie_aplic_bolus,'N'), 
				coalesce(a.ie_aplic_lenta,'N'), 
				coalesce(ie_acm_p,coalesce(a.ie_acm,'N')), 
				a.ie_objetivo, 
				a.cd_topografia_cih, 
				a.ie_origem_infeccao, 
				a.cd_amostra_cih, 
				a.cd_microorganismo_cih, 
				coalesce(a.ie_uso_antimicrobiano,'N'), 
				a.cd_protocolo, 
				a.nr_seq_protocolo, 
				a.nr_seq_mat_protocolo, 
				a.qt_hora_aplicacao, 
				'N', 
				a.qt_vel_infusao, 
				ds_justificativa_p, 
				a.ie_sem_aprazamento, 
				a.ie_indicacao, 
				a.dt_proxima_dose, 
				a.qt_total_dias_lib, 
				a.nr_seq_substituto, 
				a.ie_lado, 
				a.dt_inicio_medic,		 
				a.qt_dia_prim_hor, 
				CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.ie_regra_disp  ELSE null END , 
				a.qt_vol_adic_reconst, 
				a.qt_hora_intervalo, 
				a.qt_min_intervalo, 
				ie_permite_substituir, 
				ie_dose_especial_p 
		From	Material b, 
				Prescr_Material a 
		where	a.cd_material 	= b.cd_material 
		and		a.nr_prescricao = nr_prescricao_w 
		and		a.nr_sequencia	= nr_seq_item_w;
		 
		select	max(ie_agrupador) 
		into STRICT	ie_agrup_w 
		From	Material b, 
			Prescr_Material a 
		where	a.cd_material 	= b.cd_material 
		and	a.nr_prescricao = nr_prescricao_w 
		and	a.nr_sequencia	= nr_seq_item_w;
		 
		if (ie_agrup_w not in (3,7,9)) then		 
		 
			select	max(a.ds_horarios), 
				max(a.cd_intervalo), 
				max(b.nr_horas_validade), 
				max(a.cd_material), 
				max(a.ie_via_aplicacao), 
				max(a.qt_unitaria), 
				max(a.qt_dose_especial), 
				max(a.ds_dose_diferenciada), 
				max(a.ie_origem_inf), 
				max(a.cd_unidade_medida_dose), 
				max(a.qt_material), 
				max(a.qt_total_dispensar), 
				max(a.ie_regra_disp), 
				max(a.qt_conversao_dose), 
				max(a.qt_dose), 
				coalesce(max(ie_se_necessario),'N'), 
				coalesce(max(ie_acm),'N')				 
			into STRICT	ds_horarios_w, 
				cd_intervalo_w, 
				nr_horas_validade_w, 
				cd_material_w, 
				ie_via_aplicacao_w, 
				qt_unitaria_w, 
				qt_dose_especial_w, 
				ds_dose_diferenciada_w, 
				ie_origem_inf_w, 
				cd_unidade_medida_dose_w, 
				qt_material_w, 
				qt_total_dispensar_w, 
				ie_regra_disp_w, 
				qt_conversao_dose_w, 
				qt_dose_w, 
				ie_se_necessario_w, 
				ie_acm_w 
			from	prescr_medica b, 
				prescr_material a 
			where	a.nr_prescricao	= b.nr_prescricao 
			and	a.nr_prescricao	= nr_prescricao_ww 
			and	b.nr_prescricao	= nr_prescricao_ww 
			and	a.nr_sequencia	= nr_sequencia_w;
		 
			select	coalesce(max(qt_conversao),qt_conversao_dose_w) 
			into STRICT	qt_conversao_dose_w 
			from	unidade_medida_dose_v 
			where	cd_material		= cd_material_w 
			and	cd_unidade_medida	= cd_unidade_medida_dose_w;
			 
			begin 
			qt_unitaria_w	:= dividir(qt_dose_w, qt_conversao_dose_w);
			exception when others then 
			qt_unitaria_w	:= null;		
			end;		
		 
			nr_ocorrencia_w := obter_ocorrencias_horarios_rep(replace(ds_horarios_w,lpad(' ',qt_espacos_horarios_w),' '));
					 
			if (nr_ocorrencia_w = 0) then 
				select	max(obter_ocorrencia_intervalo(cd_intervalo_w, nr_horas_validade_w, 'O')) 
				into STRICT	nr_ocorrencia_w 
				;
			end if;
 
			SELECT * FROM Obter_Quant_Dispensar(cd_estabelecimento_p, cd_material_w, nr_prescricao_ww, nr_sequencia_w, cd_intervalo_w, ie_via_aplicacao_w, qt_unitaria_w, coalesce(qt_dose_especial_w,0), nr_ocorrencia_w, ds_dose_diferenciada_w, ie_origem_inf_w, cd_unidade_medida_dose_w, 1, qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w;
 
			update	prescr_material 
			set 	nr_ocorrencia		= nr_ocorrencia_w, 
				qt_total_dispensar	= qt_total_dispensar_w, 
				qt_material		= coalesce(qt_material_w,1), 
				ie_regra_disp		= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END , 
				qt_unitaria		= coalesce(qt_unitaria_w,qt_unitaria), 
				qt_conversao_dose	= qt_conversao_dose_w 
			where	nr_prescricao 		= nr_prescricao_ww 
			and	nr_sequencia		= nr_sequencia_w;
			 
			begin 
			CALL Ajustar_Prescr_Material(nr_prescricao_ww,nr_sequencia_w);
			exception when others then 
				ds_erro_w	:= sqlerrm;
			end;		
		end if;
		 
		commit;	
		 
		if (ie_prescr_mat_sem_lib_w = 'S') then 
			CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_ww,nr_sequencia_w,obter_perfil_ativo,'N',nm_usuario_p,null,null);
		end if;		
		 
		select	max(nr_agrupamento) 
		into STRICT	nr_agrupamento_w 
		from	prescr_material a 
		where	a.nr_prescricao = nr_prescricao_w 
		and		a.nr_sequencia	= nr_seq_item_w;
		 
		nr_seq_composto_w := nr_seq_item_w;
		ie_loop_w	:= 'S';
		while(ie_loop_w = 'S') loop 
			select	count(*) 
			into STRICT	qt_itens_w 
			from	prescr_material 
			where	nr_prescricao	= nr_prescricao_ww 
			and		nr_sequencia	= nr_seq_composto_w;
			if (qt_itens_w	= 0) then 
				ie_loop_w	:= 'N';
			else	 
				nr_seq_composto_w	:= nr_seq_composto_w + 1;
			end if;
		end loop;
 
		open c01;
		loop 
		fetch c01 into	nr_prescricao_www, 
				nr_sequencia_ww, 
				ie_origem_inf_w,		 
				cd_material_w,		 
				cd_unidade_medida_w, 
				qt_dose_w,	 
				qt_unitaria_w,		 
				qt_material_w,		 
				dt_atualizacao_w,	 
				nm_usuario_w,		 
				cd_intervalo_w,			 
				ds_horarios_w,		 
				ds_observacao_w,	 
				ds_observacao_enf_w,	 
				ie_via_aplicacao_w,	 
				nr_agrupamento_ww, 
				ie_cobra_paciente_w,	 
				cd_motivo_baixa_w,	 
				dt_baixa_w,		 
				ie_utiliza_kit_w, 
				cd_unidade_medida_dose_w,	 
				qt_conversao_dose_w,	 
				ie_urgencia_w,		 
				nr_ocorrencia_w,	 
				qt_total_dispensar_w,			 
				cd_fornec_consignado_w,	 
				nr_sequencia_solucao_w,	 
				nr_sequencia_proc_w,	 
				qt_solucao_w,		 
				hr_dose_especial_ww, 
				qt_dose_especial_w,	 
				ds_dose_diferenciada_w, 
				ie_medicacao_paciente_w	, 
				nr_sequencia_diluicao_w	, 
				hr_prim_horario_w, 
				nr_sequencia_dieta_w,	 
				ie_agrupador_w,	 
				nr_dia_util_w,		 
				ie_suspenso_w,		 
				ie_se_necessario_w,	 
				qt_min_aplicacao_w,	 
				ie_bomba_infusao_w,	 
				ie_aplic_bolus_w,	 
				ie_aplic_lenta_w,	 
				ie_acm_w,		 
				ie_objetivo_w,			 
				cd_topografia_cih_w,	 
				ie_origem_infeccao_w,	 
				cd_amostra_cih_w,	 
				cd_microorganismo_cih_w,	 
				ie_uso_antimicrobiano_w,	 
				cd_protocolo_w,		 
				nr_seq_protocolo_w,	 
				nr_seq_mat_protocolo_w,	 
				qt_hora_aplicacao_w,	 
				ie_recons_diluente_fixo_w,	 
				qt_vel_infusao_w,	 
				ds_justificativa_w,	 
				ie_sem_aprazamento_w,	 
				ie_indicacao_w,		 
				dt_proxima_dose_w,	 
				qt_total_dias_lib_w,	 
				nr_seq_substituto_w,	 
				ie_lado_w,		 
				dt_inicio_medic_w,	 
				qt_dia_prim_hor_w,	 
				ie_regra_disp_w,		 
				qt_vol_adic_reconst_w, 
				qt_hora_intervalo_w, 
				qt_min_intervalo_w,	 
				ie_permite_substituir_w, 
				ie_dose_espec_agora_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		 
		ie_loop_w	:= 'S';
		while(ie_loop_w = 'S') loop 
			select	count(*) 
			into STRICT	qt_itens_w 
			from	prescr_material 
			where	nr_prescricao	= nr_prescricao_ww 
			and	nr_sequencia	= nr_sequencia_ww;
			if (qt_itens_w	= 0) then 
				ie_loop_w	:= 'N';
			else	 
				nr_sequencia_ww	:= nr_sequencia_ww + 1;
			end if;
		end loop;
		 
		Insert into Prescr_Material( 
			nr_prescricao, 
			nr_sequencia, 
			ie_origem_inf, 
			cd_material, 
			cd_unidade_medida, 
			qt_dose, 
			qt_unitaria, 
			qt_material, 
			dt_atualizacao, 
			nm_usuario, 
			cd_intervalo, 
			ds_horarios, 
			ds_observacao, 
			ds_observacao_enf, 
			ie_via_aplicacao, 
			nr_agrupamento, 
			ie_cobra_paciente, 
			cd_motivo_baixa, 
			dt_baixa, 
			ie_utiliza_kit, 
			cd_unidade_medida_dose, 
			qt_conversao_dose, 
			ie_urgencia, 
			nr_ocorrencia, 
			qt_total_dispensar, 
			cd_fornec_consignado, 
			nr_sequencia_solucao, 
			nr_sequencia_proc, 
			qt_solucao, 
			hr_dose_especial, 
			qt_dose_especial, 
			ds_dose_diferenciada, 
			ie_medicacao_paciente, 
			nr_sequencia_diluicao, 
			hr_prim_horario, 
			nr_sequencia_dieta, 
			ie_agrupador, 
			nr_dia_util, 
			ie_suspenso, 
			ie_se_necessario, 
			qt_min_aplicacao, 
			ie_bomba_infusao, 
			ie_aplic_bolus, 
			ie_aplic_lenta, 
			ie_acm, 
			ie_objetivo, 
			cd_topografia_cih, 
			ie_origem_infeccao, 
			cd_amostra_cih, 
			cd_microorganismo_cih, 
			ie_uso_antimicrobiano, 
			cd_protocolo, 
			nr_seq_protocolo, 
			nr_seq_mat_protocolo, 
			qt_hora_aplicacao, 
			ie_recons_diluente_fixo, 
			qt_vel_infusao, 
			ds_justificativa, 
			ie_sem_aprazamento, 
			ie_indicacao, 
			dt_proxima_dose, 
			qt_total_dias_lib, 
			nr_seq_substituto, 
			ie_lado, 
			dt_inicio_medic, 
			qt_dia_prim_hor, 
			ie_regra_disp, 
			qt_vol_adic_reconst, 
			qt_hora_intervalo, 
			qt_min_intervalo, 
			ie_permite_substituir, 
			ie_dose_espec_agora)		 
		values (nr_prescricao_www, 
			nr_sequencia_ww, 
			ie_origem_inf_w,		 
			cd_material_w,		 
			cd_unidade_medida_w, 
			qt_dose_w,	 
			qt_unitaria_w,		 
			qt_material_w,		 
			dt_atualizacao_w,	 
			nm_usuario_w,		 
			cd_intervalo_w,			 
			ds_horarios_w,		 
			ds_observacao_w,	 
			ds_observacao_enf_w,	 
			ie_via_aplicacao_w,	 
			nr_agrupamento_ww, 
			ie_cobra_paciente_w,	 
			cd_motivo_baixa_w,	 
			dt_baixa_w,		 
			ie_utiliza_kit_w, 
			cd_unidade_medida_dose_w,	 
			qt_conversao_dose_w,	 
			ie_urgencia_w,		 
			nr_ocorrencia_w,	 
			qt_total_dispensar_w,			 
			cd_fornec_consignado_w,	 
			nr_sequencia_solucao_w,	 
			nr_sequencia_proc_w,	 
			qt_solucao_w,		 
			hr_dose_especial_ww, 
			qt_dose_especial_w,	 
			ds_dose_diferenciada_w, 
			ie_medicacao_paciente_w	, 
			nr_sequencia_diluicao_w	, 
			hr_prim_horario_w, 
			nr_sequencia_dieta_w,	 
			ie_agrupador_w,	 
			nr_dia_util_w,		 
			ie_suspenso_w,		 
			ie_se_necessario_w,	 
			qt_min_aplicacao_w,	 
			ie_bomba_infusao_w,	 
			ie_aplic_bolus_w,	 
			ie_aplic_lenta_w,	 
			ie_acm_w,		 
			ie_objetivo_w,			 
			cd_topografia_cih_w,	 
			ie_origem_infeccao_w,	 
			cd_amostra_cih_w,	 
			cd_microorganismo_cih_w,	 
			ie_uso_antimicrobiano_w,	 
			cd_protocolo_w,		 
			nr_seq_protocolo_w,	 
			nr_seq_mat_protocolo_w,	 
			qt_hora_aplicacao_w,	 
			ie_recons_diluente_fixo_w,	 
			qt_vel_infusao_w,	 
			ds_justificativa_w,	 
			ie_sem_aprazamento_w,	 
			ie_indicacao_w,		 
			dt_proxima_dose_w,	 
			qt_total_dias_lib_w,	 
			nr_seq_substituto_w,	 
			ie_lado_w,		 
			dt_inicio_medic_w,	 
			qt_dia_prim_hor_w,	 
			ie_regra_disp_w,		 
			qt_vol_adic_reconst_w, 
			qt_hora_intervalo_w, 
			qt_min_intervalo_w,	 
			ie_permite_substituir_w, 
			ie_dose_espec_agora_w 
			);
			 
		if (ie_prescr_mat_sem_lib_w = 'S') then 
			CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_www,nr_sequencia_ww,obter_perfil_ativo,'N',nm_usuario_p,null,null);
		end if;	
			 
		end;
		end loop;
		close c01;	
		 
		/*diluentes*/
 
		select	coalesce(max(nr_sequencia),0) +1 
		into STRICT	nr_seq_w 
		from	prescr_material a 
		where	a.nr_prescricao = nr_prescricao_ww;
		 
		nr_seq_dil_w 	:= nr_seq_composto_w;
		ie_loop_w	:= 'S';
		while(ie_loop_w = 'S') loop 
			select	count(*) 
			into STRICT	qt_itens_w 
			from	prescr_material 
			where	nr_prescricao	= nr_prescricao_ww 
			and	nr_sequencia	= nr_seq_dil_w;
			if (qt_itens_w	= 0) then 
				ie_loop_w	:= 'N';
			else	 
				nr_seq_dil_w	:= coalesce(nr_seq_dil_w,0) + 1;
			end if;
		end loop;
		 
		open c02;
		loop 
		fetch c02 into	nr_prescricao_www, 
				nr_sequencia_ww, 
				ie_origem_inf_w,		 
				cd_material_w,		 
				cd_unidade_medida_w, 
				qt_dose_w,	 
				qt_unitaria_w,		 
				qt_material_w,		 
				dt_atualizacao_w,	 
				nm_usuario_w,		 
				cd_intervalo_w,			 
				ds_horarios_w,		 
				ds_observacao_w,	 
				ds_observacao_enf_w,	 
				ie_via_aplicacao_w,	 
				nr_agrupamento_ww, 
				ie_cobra_paciente_w,	 
				cd_motivo_baixa_w,	 
				dt_baixa_w,		 
				ie_utiliza_kit_w, 
				cd_unidade_medida_dose_w,	 
				qt_conversao_dose_w,	 
				ie_urgencia_w,		 
				nr_ocorrencia_w,	 
				qt_total_dispensar_w,			 
				cd_fornec_consignado_w,	 
				nr_sequencia_solucao_w,	 
				nr_sequencia_proc_w,	 
				qt_solucao_w,		 
				hr_dose_especial_ww, 
				qt_dose_especial_w,	 
				ds_dose_diferenciada_w, 
				ie_medicacao_paciente_w	, 
				nr_sequencia_diluicao_w	, 
				hr_prim_horario_w, 
				nr_sequencia_dieta_w,	 
				ie_agrupador_w,	 
				nr_dia_util_w,		 
				ie_suspenso_w,		 
				ie_se_necessario_w,	 
				qt_min_aplicacao_w,	 
				ie_bomba_infusao_w,	 
				ie_aplic_bolus_w,	 
				ie_aplic_lenta_w,	 
				ie_acm_w,		 
				ie_objetivo_w,			 
				cd_topografia_cih_w,	 
				ie_origem_infeccao_w,	 
				cd_amostra_cih_w,	 
				cd_microorganismo_cih_w,	 
				ie_uso_antimicrobiano_w,	 
				cd_protocolo_w,		 
				nr_seq_protocolo_w,	 
				nr_seq_mat_protocolo_w,	 
				qt_hora_aplicacao_w,	 
				ie_recons_diluente_fixo_w,	 
				qt_vel_infusao_w,	 
				ds_justificativa_w,	 
				ie_sem_aprazamento_w,	 
				ie_indicacao_w,		 
				dt_proxima_dose_w,	 
				qt_total_dias_lib_w,	 
				nr_seq_substituto_w,	 
				ie_lado_w,		 
				dt_inicio_medic_w,	 
				qt_dia_prim_hor_w,	 
				ie_regra_disp_w,		 
				qt_vol_adic_reconst_w, 
				qt_hora_intervalo_w, 
				qt_min_intervalo_w,	 
				ie_permite_substituir_w, 
				ie_dose_espec_agora_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		 
		Insert into Prescr_Material( 
			nr_prescricao, 
			nr_sequencia, 
			ie_origem_inf, 
			cd_material, 
			cd_unidade_medida, 
			qt_dose, 
			qt_unitaria, 
			qt_material, 
			dt_atualizacao, 
			nm_usuario, 
			cd_intervalo, 
			ds_horarios, 
			ds_observacao, 
			ds_observacao_enf, 
			ie_via_aplicacao, 
			nr_agrupamento, 
			ie_cobra_paciente, 
			cd_motivo_baixa, 
			dt_baixa, 
			ie_utiliza_kit, 
			cd_unidade_medida_dose, 
			qt_conversao_dose, 
			ie_urgencia, 
			nr_ocorrencia, 
			qt_total_dispensar, 
			cd_fornec_consignado, 
			nr_sequencia_solucao, 
			nr_sequencia_proc, 
			qt_solucao, 
			hr_dose_especial, 
			qt_dose_especial, 
			ds_dose_diferenciada, 
			ie_medicacao_paciente, 
			nr_sequencia_diluicao, 
			hr_prim_horario, 
			nr_sequencia_dieta, 
			ie_agrupador, 
			nr_dia_util, 
			ie_suspenso, 
			ie_se_necessario, 
			qt_min_aplicacao, 
			ie_bomba_infusao, 
			ie_aplic_bolus, 
			ie_aplic_lenta, 
			ie_acm, 
			ie_objetivo, 
			cd_topografia_cih, 
			ie_origem_infeccao, 
			cd_amostra_cih, 
			cd_microorganismo_cih, 
			ie_uso_antimicrobiano, 
			cd_protocolo, 
			nr_seq_protocolo, 
			nr_seq_mat_protocolo, 
			qt_hora_aplicacao, 
			ie_recons_diluente_fixo, 
			qt_vel_infusao, 
			ds_justificativa, 
			ie_sem_aprazamento, 
			ie_indicacao, 
			dt_proxima_dose, 
			qt_total_dias_lib, 
			nr_seq_substituto, 
			ie_lado, 
			dt_inicio_medic, 
			qt_dia_prim_hor, 
			ie_regra_disp, 
			qt_vol_adic_reconst, 
			qt_hora_intervalo, 
			qt_min_intervalo, 
			ie_permite_substituir, 
			ie_dose_espec_agora)		 
		values (nr_prescricao_www, 
			nr_sequencia_ww, 
			ie_origem_inf_w,		 
			cd_material_w,		 
			cd_unidade_medida_w, 
			qt_dose_w,	 
			qt_unitaria_w,		 
			qt_material_w,		 
			dt_atualizacao_w,	 
			nm_usuario_w,		 
			cd_intervalo_w,			 
			ds_horarios_w,		 
			ds_observacao_w,	 
			ds_observacao_enf_w,	 
			ie_via_aplicacao_w,	 
			nr_agrupamento_ww, 
			ie_cobra_paciente_w,	 
			cd_motivo_baixa_w,	 
			dt_baixa_w,		 
			ie_utiliza_kit_w, 
			cd_unidade_medida_dose_w,	 
			qt_conversao_dose_w,	 
			ie_urgencia_w,		 
			nr_ocorrencia_w,	 
			qt_total_dispensar_w,			 
			cd_fornec_consignado_w,	 
			nr_sequencia_solucao_w,	 
			nr_sequencia_proc_w,	 
			qt_solucao_w,		 
			hr_dose_especial_ww, 
			qt_dose_especial_w,	 
			ds_dose_diferenciada_w, 
			ie_medicacao_paciente_w	, 
			nr_sequencia_diluicao_w	, 
			hr_prim_horario_w, 
			nr_sequencia_dieta_w,	 
			ie_agrupador_w,	 
			nr_dia_util_w,		 
			ie_suspenso_w,		 
			ie_se_necessario_w,	 
			qt_min_aplicacao_w,	 
			ie_bomba_infusao_w,	 
			ie_aplic_bolus_w,	 
			ie_aplic_lenta_w,	 
			ie_acm_w,		 
			ie_objetivo_w,			 
			cd_topografia_cih_w,	 
			ie_origem_infeccao_w,	 
			cd_amostra_cih_w,	 
			cd_microorganismo_cih_w,	 
			ie_uso_antimicrobiano_w,	 
			cd_protocolo_w,		 
			nr_seq_protocolo_w,	 
			nr_seq_mat_protocolo_w,	 
			qt_hora_aplicacao_w,	 
			ie_recons_diluente_fixo_w,	 
			qt_vel_infusao_w,	 
			ds_justificativa_w,	 
			ie_sem_aprazamento_w,	 
			ie_indicacao_w,		 
			dt_proxima_dose_w,	 
			qt_total_dias_lib_w,	 
			nr_seq_substituto_w,	 
			ie_lado_w,		 
			dt_inicio_medic_w,	 
			qt_dia_prim_hor_w,	 
			ie_regra_disp_w,		 
			qt_vol_adic_reconst_w, 
			qt_hora_intervalo_w, 
			qt_min_intervalo_w,	 
			ie_permite_substituir_w, 
			ie_dose_espec_agora_w 
		);
		 
		 
		if (ie_prescr_mat_sem_lib_w = 'S') then 
			CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_www,nr_sequencia_ww,obter_perfil_ativo,'N',nm_usuario_p,null,null);
		end if;
		 
		end;
		end loop;
		close c02;	
		 
		nr_seq_novo_item_p := nr_seq_item_w;
		end;
	end if;
	nr_nova_prescricao_p := nr_prescricao_ww;
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vipe_gerar_prescricao_item ( cd_estabelecimento_p bigint, nr_prescricao_p bigint, nr_atendimento_p bigint, cd_material_novo_p bigint, cd_material_p bigint, nr_seq_item_p bigint, cd_intervalo_p text, cd_intervalo_novo_p text, ie_acm_sn_p text, qt_dose_p bigint, ie_via_aplicacao_p text, nr_prescricoes_p text, dt_primeiro_horario_p timestamp, cd_unidade_med_p text, ds_horarios_p text, ie_susp_anterior_p text, ie_tipo_pessoa_p text, cd_perfil_p bigint, nm_usuario_p text, ds_dose_dif_p text, qt_dose_esp_p bigint, ds_justificativa_p text, ds_observacao_subs_p text, hr_dose_especial_p text, ie_dose_especial_p text, ie_se_necessario_p text, ie_acm_p text, ie_urgencia_p text, ie_interv_farm_p text, nr_nova_prescricao_p INOUT bigint, nr_seq_novo_item_p INOUT bigint, cd_funcao_p bigint ) FROM PUBLIC;

