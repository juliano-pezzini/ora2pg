-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_imp_prestador_intercambio (ds_conteudo_p text, nr_lote_p bigint, nm_usuario_p text, ds_retorno_p INOUT text) AS $body$
DECLARE


cd_cgc_w			varchar(14);
ds_razao_social_w		varchar(60);
ie_tipo_w			smallint;
cd_municipio_w			integer;
ie_tipo_contratacao_w		varchar(1);
dt_contratacao_w		timestamp;
cd_cnes_w			integer;
dt_vinculo_w			timestamp;
cd_classificacao_w		smallint;
cd_ans_int_w			integer;
ie_disp_servicos_w		varchar(1);
ie_indicador_ug_eme_w		varchar(1);
ds_erro_w			varchar(4000);


BEGIN

ds_retorno_p := '';

if (ds_conteudo_p IS NOT NULL AND ds_conteudo_p::text <> '') and (nr_lote_p IS NOT NULL AND nr_lote_p::text <> '') then

	cd_cgc_w		:= trim(both substr(ds_conteudo_p,1,14));
	ds_razao_social_w	:= trim(both substr(ds_conteudo_p,15,60));
	ie_tipo_w		:= (trim(both substr(ds_conteudo_p,75,4)))::numeric;
	cd_municipio_w		:= (trim(both substr(ds_conteudo_p,79,7)))::numeric;
	ie_tipo_contratacao_w	:= trim(both substr(ds_conteudo_p,86,1));

	begin
	dt_contratacao_w	:= to_date(substr(ds_conteudo_p,87,8), 'dd/mm/yyyy');
	exception
	when others then
		dt_contratacao_w := null;
	end;

	cd_cnes_w		:= (trim(both substr(ds_conteudo_p,95,7)))::numeric;

	begin
	dt_vinculo_w		:= to_date(substr(ds_conteudo_p,102,8),'dd/mm/yyyy');
	exception
	when others then
		dt_vinculo_w := null;
	end;

	cd_classificacao_w	:= (trim(both substr(ds_conteudo_p,110,1)))::numeric;
	cd_ans_int_w		:= (trim(both substr(ds_conteudo_p,111,6)))::numeric;
	ie_disp_servicos_w	:= trim(both substr(ds_conteudo_p,117,1));
	ie_indicador_ug_eme_w	:= trim(both substr(ds_conteudo_p,118,1));

	begin
	/* Inserir os prestadores importados para a tabela de prestadores, localizado na função 'OPS - Prestadores de Intercambio' */

	insert into pls_prestador_interc_movto(	nr_sequencia, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_lote,
						cd_cgc_cpf, ds_razao_social, ie_tipo, cd_municipio_ibge, ie_contratacao, dt_contratacao,
						cd_cnes, dt_vinculo, cd_classificacao, cd_ans_int, ie_disponibilidade_serv, ie_urgencia_emergencia)
					values (	nextval('pls_prestador_interc_movto_seq'), clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p, nr_lote_p,
						cd_cgc_w, ds_razao_social_w, ie_tipo_w, cd_municipio_w, ie_tipo_contratacao_w, dt_contratacao_w,
						cd_cnes_w, dt_vinculo_w, cd_classificacao_w, cd_ans_int_w, ie_disp_servicos_w, ie_indicador_ug_eme_w);
	ds_retorno_p := 'S';
	exception
	when others then
	ds_retorno_p := 'N';
	ds_erro_w := substr(SQLERRM,0,4000);
	CALL wheb_mensagem_pck.exibir_mensagem_abort(330141, 'ERRO=' || ds_erro_w, -20012);
	end;

	/*Informar data de importação, para não permitir mais importações para o Lote */

	update	pls_lote_prestador_interc
	set	dt_importacao = clock_timestamp()
	where	nr_sequencia = nr_lote_p;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_imp_prestador_intercambio (ds_conteudo_p text, nr_lote_p bigint, nm_usuario_p text, ds_retorno_p INOUT text) FROM PUBLIC;

