-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_divergencia_nota_ordem ( nr_sequencia_p nota_fiscal_item.nr_sequencia%type, nm_usuario_p nota_fiscal_item.nm_usuario%type, ds_retorno_p INOUT text ) AS $body$
DECLARE


    qt_existe_w                 regra_diverg_oc_nf.qt_diferenca%type;
    pr_diferenca_w              regra_diverg_oc_nf.pr_diferenca%type;
    qt_diferenca_w              double precision;
    qt_diferenca_ww             double precision;
    nr_ordem_compra_w           nota_fiscal_item.nr_ordem_compra%type;
    cd_material_w               nota_fiscal_item.cd_material%type;
    cd_material_oci_w           ordem_compra_item.cd_material%type;
    pr_desconto_w               ordem_compra.pr_desconto%type;
    pr_desconto_nf_w            ordem_compra.pr_desconto%type;
    cd_local_estoque_w          nota_fiscal_item.cd_local_estoque%type;
    nr_item_oci_w               nota_fiscal_item.nr_item_oci%type;
    nr_seq_divergencia_w        divergencia_ordem_compra_item.nr_sequencia%type;
    cd_estabelecimento_w        nota_fiscal_item.cd_estabelecimento%type;
    cd_cgc_emitente_w           nota_fiscal_item.cd_cgc_emitente%type;
    cd_pessoa_fisica_w          nota_fiscal.cd_pessoa_fisica%type;
    cd_serie_nf_w               nota_fiscal.cd_serie_nf%type;
    nr_nota_fiscal_w            nota_fiscal_item.nr_nota_fiscal%type;
    nr_sequencia_nf_w           nota_fiscal_item.nr_sequencia_nf%type;
    nr_item_nf_w                nota_fiscal_item.nr_item_nf%type;
    qt_item_nf_w                nota_fiscal_item.qt_item_nf%type;
    vl_unitario_item_nf_w       nota_fiscal_item.vl_unitario_item_nf%type;
    ie_diverg_oc_nf_w           parametro_compras.ie_diverg_oc_nf%type;
    ds_justificativa_w          nota_fiscal_item.ds_justificativa%type;
    dt_entrega_ordem_w          nota_fiscal_item.dt_entrega_ordem%type;
    nr_item_oci_ww              nota_fiscal_item.nr_item_oci%type;
    dt_entrada_saida_w          nota_fiscal.dt_entrada_saida%type;
    dt_prevista_entrega_w       ordem_compra_item_entrega.dt_prevista_entrega%type;
    qt_item_oci_w               ordem_compra_item.qt_material%type;
    vl_unitario_item_oci_w      ordem_compra_item.vl_unitario_material%type;
    pr_descontos_oci_w          ordem_compra_item.pr_descontos%type;
    cd_local_estoque_oci_w      ordem_compra_item.cd_local_estoque%type;
    ie_divergencia_w            varchar(1);
    vl_desconto_oc_w            ordem_compra.vl_desconto%type;
    vl_descontos_nf_w           nota_fiscal.vl_descontos%type;
    cd_grupo_material_w         estrutura_material_v.cd_grupo_material%type;
    cd_subgrupo_material_w      estrutura_material_v.cd_subgrupo_material%type;
    cd_classe_material_w        estrutura_material_v.cd_classe_material%type;
    ie_tipo_nota_w              nota_fiscal.ie_tipo_nota%type;
    nr_seq_entrega_w            ordem_compra_item_entrega.nr_sequencia%type;
    cd_cond_pagto_ordem_w       ordem_compra.cd_condicao_pagamento%type;
    cd_cond_pagto_nota_w        nota_fiscal.cd_condicao_pagamento%type;
    vl_frete_ordem_w            ordem_compra.vl_frete%type;
    vl_despesa_acessoria_oc_w   ordem_compra.vl_despesa_acessoria%type;
    vl_despesa_acessoria_nf_w   nota_fiscal.vl_despesa_acessoria%type;
    vl_frete_nota_w             nota_fiscal.vl_frete%type;
    ds_material_w               material.ds_material%type;
    vl_total_ordem_w            nota_fiscal.vl_total_nota%type;
    vl_total_nota_w             nota_fiscal.vl_total_nota%type;
    vl_ipi_item_oc_w            ordem_compra_item_trib.vl_tributo%type;
    vl_ipi_item_nf_w            ordem_compra_item_trib.vl_tributo%type;
    ie_permite_justif_w         regra_diverg_oc_nf.ie_permite_justif%type;
    ie_frete_w                  ordem_compra.ie_frete%type;
    vl_mercadoria_w             nota_fiscal.vl_mercadoria%type;

    c01 CURSOR FOR
    SELECT
        a.cd_estabelecimento,
        a.cd_cgc_emitente,
        n.cd_pessoa_fisica,
        a.nr_nota_fiscal,
        a.cd_serie_nf,
        a.nr_sequencia_nf,
        a.nr_item_nf,
        a.vl_unitario_item_nf,
        a.cd_material,
        a.cd_local_estoque,
        a.nr_ordem_compra,
        o.pr_desconto,
        a.nr_item_oci,
        a.ds_justificativa,
        b.qt_material,
        b.cd_material,
        b.vl_unitario_material,
        b.pr_descontos,
        b.cd_local_estoque,
        a.dt_entrega_ordem,
        b.nr_item_oci,
        coalesce(o.vl_desconto, 0),
        coalesce(n.vl_descontos, 0),
        o.cd_condicao_pagamento,
        n.cd_condicao_pagamento,
        coalesce(o.vl_despesa_acessoria, 0),
        coalesce(n.vl_despesa_acessoria, 0),
        obter_vl_ipi_item_oc(o.nr_ordem_compra, b.nr_item_oci) vl_ipi_item_oc,
        obter_vl_ipi_item_nf(n.nr_sequencia, a.nr_item_nf) vl_ipi_item_nf,
        o.vl_frete,
        n.vl_frete,
        coalesce((SELECT  sum(coalesce(obter_valor_liquido_oci(y.nr_ordem_compra, x.nr_item_oci), 0))
                from    ordem_compra        y, 
                        nota_fiscal_item    x
                where   x.nr_ordem_compra = y.nr_ordem_compra
                and     x.nr_sequencia = nr_sequencia_p), 0),
        n.vl_total_nota,
        o.ie_frete,
        n.vl_mercadoria
    from    ordem_compra_item   b,
            ordem_compra        o,
            nota_fiscal_item    a,
            nota_fiscal         n
    where   a.nr_sequencia = nr_sequencia_p
    and     o.nr_ordem_compra = b.nr_ordem_compra
    and     n.nr_sequencia = a.nr_sequencia
    and     (a.nr_ordem_compra IS NOT NULL AND a.nr_ordem_compra::text <> '')
    and     a.nr_ordem_compra = b.nr_ordem_compra
    and     a.nr_item_oci = b.nr_item_oci;


BEGIN

    select  coalesce(max(ie_tipo_nota), 'X')
    into STRICT    ie_tipo_nota_w
    from    nota_fiscal
    where   nr_sequencia = nr_sequencia_p;

    if (ie_tipo_nota_w in ('EN','EF','EP')) then
        begin
            select  b.ie_diverg_oc_nf,
                    a.dt_entrada_saida
            into STRICT    ie_diverg_oc_nf_w,
                    dt_entrada_saida_w
            from    parametro_compras   b,
                    nota_fiscal         a
            where   a.cd_estabelecimento = b.cd_estabelecimento
            and     a.nr_sequencia = nr_sequencia_p;
            exception
            when no_data_found then
                ie_diverg_oc_nf_w := null;
                dt_entrada_saida_w := clock_timestamp();
            when too_many_rows then raise;
        end;
        begin
            update  divergencia_ordem_compra_item
            set     ie_situacao = 'I'
            where   nr_seq_nf = nr_sequencia_p;

            open c01;
            loop
                fetch c01 into
                    cd_estabelecimento_w,
                    cd_cgc_emitente_w,
                    cd_pessoa_fisica_w,
                    nr_nota_fiscal_w,
                    cd_serie_nf_w,
                    nr_sequencia_nf_w,
                    nr_item_nf_w,
                    vl_unitario_item_nf_w,
                    cd_material_w,
                    cd_local_estoque_w,
                    nr_ordem_compra_w,
                    pr_desconto_w,
                    nr_item_oci_w,
                    ds_justificativa_w,
                    qt_item_oci_w,
                    cd_material_oci_w,
                    vl_unitario_item_oci_w,
                    pr_descontos_oci_w,
                    cd_local_estoque_oci_w,
                    dt_entrega_ordem_w,
                    nr_item_oci_ww,
                    vl_desconto_oc_w,
                    vl_descontos_nf_w,
                    cd_cond_pagto_ordem_w,
                    cd_cond_pagto_nota_w,
                    vl_despesa_acessoria_oc_w,
                    vl_despesa_acessoria_nf_w,
                    vl_ipi_item_oc_w,
                    vl_ipi_item_nf_w,
                    vl_frete_ordem_w,
                    vl_frete_nota_w,
                    vl_total_ordem_w,
                    vl_total_nota_w,
                    ie_frete_w,
                    vl_mercadoria_w;

                EXIT WHEN NOT FOUND; /* apply on c01 */
                begin
                    ie_divergencia_w := 'N';
                    begin
                        begin
                            select  min(a.nr_sequencia)
                            into STRICT    nr_seq_entrega_w
                            from    ordem_compra_item_entrega a
                            where   a.nr_ordem_compra = nr_ordem_compra_w
                            and     a.nr_item_oci = nr_item_oci_ww
                            and     trunc(a.dt_prevista_entrega, 'dd') = trunc(dt_entrega_ordem_w, 'dd')
                            and     coalesce(a.dt_cancelamento::text, '') = ''
                            and     ((coalesce(a.dt_real_entrega::text, '') = '') or (coalesce(a.qt_real_entrega, 0) < a.qt_prevista_entrega));
                        exception
                        when no_data_found then
                            select  min(a.nr_sequencia)
                            into STRICT    nr_seq_entrega_w
                            from    ordem_compra_item_entrega a
                            where   a.nr_ordem_compra = nr_ordem_compra_w
                            and     a.nr_item_oci = nr_item_oci_ww
                            and     coalesce(a.dt_cancelamento::text, '') = ''
                            and     ((coalesce(a.dt_real_entrega::text, '') = '') or (coalesce(a.qt_real_entrega, 0) < a.qt_prevista_entrega));
                        end;

                        begin
                            select  substr(obter_desc_material(cd_material_w), 1, 255)
                            into STRICT    ds_material_w
;
                        exception
                        when no_data_found then
                            ds_material_w := null;
                        when too_many_rows then raise;
                        end;

                        begin
                            select  qt_prevista_entrega,
                                    dt_prevista_entrega
                            into STRICT    qt_item_oci_w,
                                    dt_prevista_entrega_w
                            from    ordem_compra_item_entrega
                            where   nr_sequencia = nr_seq_entrega_w;
                        exception
                        when no_data_found then
                            qt_item_oci_w := 0;
                            dt_prevista_entrega_w := null;
                        when too_many_rows then raise;
                        end;
                    exception
                        when no_data_found then
                            CALL wheb_mensagem_pck.exibir_mensagem_abort(196423, 'NR_ITEM_NF_W=' || nr_item_nf_w || ';' ||
                                                                            'NR_ITEM_OCI_WW=' || nr_item_oci_ww || ';' || 
                                                                            'CD_MATERIAL_W=' || cd_material_w || ';' || 
                                                                            'DS_MATERIAL_W=' || ds_material_w);
                    end;

                    begin
                        select  sum(qt_item_nf)
                        into STRICT    qt_item_nf_w
                        from    nota_fiscal_item
                        where   nr_sequencia = nr_sequencia_p
                        and     nr_ordem_compra = nr_ordem_compra_w
                        and     nr_item_oci = nr_item_oci_w
                        and     trunc(dt_entrega_ordem, 'dd') = trunc(dt_entrega_ordem_w, 'dd');
                    exception
                    when no_data_found then
                        qt_item_nf_w := 0;
                    when too_many_rows then raise;
                    end;

                    begin
                        select  cd_grupo_material,
                                cd_subgrupo_material,
                                cd_classe_material
                        into STRICT    cd_grupo_material_w,
                                cd_subgrupo_material_w,
                                cd_classe_material_w
                        from    estrutura_material_v
                        where   cd_material = cd_material_w;
                    exception
                    when no_data_found then
                        cd_grupo_material_w := 0;
                        cd_subgrupo_material_w := 0;
                        cd_classe_material_w := 0;
                    when too_many_rows then raise;
                    end;

		/* 2 - Alteracao na quantidade(a maior)*/

                    select  count(*),
                            coalesce(max(pr_diferenca), 0),
                            coalesce(max(qt_diferenca), 0),
                            coalesce(max(ie_permite_justif), 'S')
                    into STRICT    qt_existe_w,
                            pr_diferenca_w,
                            qt_diferenca_w,
                            ie_permite_justif_w
                    from    regra_diverg_oc_nf
                    where   cd_estabelecimento = cd_estabelecimento_w
                    and     coalesce(cd_local_estoque, cd_local_estoque_w) = cd_local_estoque_w
                    and     coalesce(cd_grupo_material, cd_grupo_material_w) = cd_grupo_material_w
                    and     coalesce(cd_subgrupo_material, cd_subgrupo_material_w) = cd_subgrupo_material_w
                    and     coalesce(cd_classe_material, cd_classe_material_w) = cd_classe_material_w
                    and     coalesce(cd_material, cd_material_w) = cd_material_w
                    and     ie_tipo_regra = '2'
                    and     coalesce(obter_se_restringe_div_oc_nf(nr_sequencia, cd_cgc_emitente_w), 'S') = 'S';

                    if (pr_diferenca_w > 0) then
                        qt_diferenca_w := round((dividir((qt_item_oci_w * pr_diferenca_w), 100))::numeric, 4);
                    end if;

                    if (qt_existe_w > 0) and (round((qt_diferenca_w + qt_item_oci_w)::numeric, 4) < qt_item_nf_w) then
                        begin
                            select  coalesce(max(nr_sequencia), 0)
                            into STRICT    nr_seq_divergencia_w
                            from    divergencia_ordem_compra_item
                            where   cd_tipo_divergencia = 2
                            and     ie_situacao = 'I'
                            and     nr_seq_nf = nr_sequencia_p
                            and     nr_item_nf = nr_item_nf_w
                            and     nr_ordem_compra = nr_ordem_compra_w
                            and     nr_item_doi_nfe = nr_item_oci_w;

                            if (nr_seq_divergencia_w > 0) then
                                update  divergencia_ordem_compra_item
                                set     ie_situacao = 'A'
                                where   nr_sequencia = nr_seq_divergencia_w;

                            else
                                select  coalesce(max(nr_sequencia), 0) + 1
                                into STRICT    nr_seq_divergencia_w
                                from    divergencia_ordem_compra_item;

                                insert into divergencia_ordem_compra_item(
                                    nr_ordem_compra,
                                    nr_item_doi_nfe,
                                    cd_tipo_divergencia,
                                    cd_estabelecimento,
                                    cd_cgc_emitente,
                                    cd_pessoa_fisica,
                                    cd_serie_nf,
                                    nr_nota_fiscal,
                                    nr_sequencia_nf,
                                    nr_item_nf,
                                    dt_atualizacao,
                                    nm_usuario,
                                    ds_observacao,
                                    nr_seq_nf,
                                    nr_sequencia,
                                    ie_situacao,
                                    ie_permite_justif,
                                    dt_prevista_entrega
                               ) values (
                                    nr_ordem_compra_w,
                                    nr_item_oci_w,
                                    2,
                                    cd_estabelecimento_w,
                                    cd_cgc_emitente_w,
                                    cd_pessoa_fisica_w,
                                    cd_serie_nf_w,
                                    nr_nota_fiscal_w,
                                    nr_sequencia_nf_w,
                                    nr_item_nf_w,
                                    clock_timestamp(),
                                    nm_usuario_p,
                                    null,
                                    nr_sequencia_p,
                                    nr_seq_divergencia_w,
                                    'A',
                                    ie_permite_justif_w,
                                    dt_entrega_ordem_w
                               );

                            end if;

                            ie_divergencia_w := 'S';
                        end;
                    end if;	
			
		/* 7 - Alteracao na quantidade(a menor) */

                    select  count(*),
                            coalesce(max(pr_diferenca), 0),
                            coalesce(max(qt_diferenca), 0),
                            coalesce(max(ie_permite_justif), 'S')
                    into STRICT    qt_existe_w,
                            pr_diferenca_w,
                            qt_diferenca_w,
                            ie_permite_justif_w
                    from    regra_diverg_oc_nf
                    where   cd_estabelecimento = cd_estabelecimento_w
                    and     coalesce(cd_local_estoque, cd_local_estoque_w) = cd_local_estoque_w
                    and     coalesce(cd_grupo_material, cd_grupo_material_w) = cd_grupo_material_w
                    and     coalesce(cd_subgrupo_material, cd_subgrupo_material_w) = cd_subgrupo_material_w
                    and     coalesce(cd_classe_material, cd_classe_material_w) = cd_classe_material_w
                    and     coalesce(cd_material, cd_material_w) = cd_material_w
                    and     ie_tipo_regra = '7'
                    and     coalesce(obter_se_restringe_div_oc_nf(nr_sequencia, cd_cgc_emitente_w), 'S') = 'S';

                    if (pr_diferenca_w > 0) then
                        qt_diferenca_w := round((dividir((qt_item_oci_w * pr_diferenca_w), 100))::numeric, 4);
                    end if;

                    if (qt_existe_w > 0) and (round((abs(qt_diferenca_w - qt_item_oci_w))::numeric, 4) > qt_item_nf_w) then
                        begin
                            select  coalesce(max(nr_sequencia), 0)
                            into STRICT    nr_seq_divergencia_w
                            from    divergencia_ordem_compra_item
                            where   cd_tipo_divergencia = 7
                            and     ie_situacao = 'I'
                            and     nr_seq_nf = nr_sequencia_p
                            and     nr_item_nf = nr_item_nf_w
                            and     nr_ordem_compra = nr_ordem_compra_w
                            and     nr_item_doi_nfe = nr_item_oci_w;

                            if (nr_seq_divergencia_w > 0) then
                                update  divergencia_ordem_compra_item
                                set     ie_situacao = 'A'
                                where   nr_sequencia = nr_seq_divergencia_w;
                            else
                                select  coalesce(max(nr_sequencia), 0) + 1
                                into STRICT    nr_seq_divergencia_w
                                from    divergencia_ordem_compra_item;

                                insert into divergencia_ordem_compra_item(
                                    nr_ordem_compra,
                                    nr_item_doi_nfe,
                                    cd_tipo_divergencia,
                                    cd_estabelecimento,
                                    cd_cgc_emitente,
                                    cd_pessoa_fisica,
                                    cd_serie_nf,
                                    nr_nota_fiscal,
                                    nr_sequencia_nf,
                                    nr_item_nf,
                                    dt_atualizacao,
                                    nm_usuario,
                                    ds_observacao,
                                    nr_seq_nf,
                                    nr_sequencia,
                                    ie_situacao,
                                    ie_permite_justif,
                                    dt_prevista_entrega
                               ) values (
                                    nr_ordem_compra_w,
                                    nr_item_oci_w,
                                    7,
                                    cd_estabelecimento_w,
                                    cd_cgc_emitente_w,
                                    cd_pessoa_fisica_w,
                                    cd_serie_nf_w,
                                    nr_nota_fiscal_w,
                                    nr_sequencia_nf_w,
                                    nr_item_nf_w,
                                    clock_timestamp(),
                                    nm_usuario_p,
                                    null,
                                    nr_sequencia_p,
                                    nr_seq_divergencia_w,
                                    'A',
                                    ie_permite_justif_w,
                                    dt_entrega_ordem_w
                               );

                            end if;

                            ie_divergencia_w := 'S';
                        end;
                    end if;
		
		/* 3 - Alteracao preco unitario (a maior) */

                    select  count(*),
                            coalesce(max(pr_diferenca), 0),
                            coalesce(max(qt_diferenca), 0),
                            coalesce(max(ie_permite_justif), 'S')
                    into STRICT    qt_existe_w,
                            pr_diferenca_w,
                            qt_diferenca_w,
                            ie_permite_justif_w
                    from    regra_diverg_oc_nf
                    where   cd_estabelecimento = cd_estabelecimento_w
                    and     coalesce(cd_local_estoque, cd_local_estoque_w) = cd_local_estoque_w
                    and     coalesce(cd_grupo_material, cd_grupo_material_w) = cd_grupo_material_w
                    and     coalesce(cd_subgrupo_material, cd_subgrupo_material_w) = cd_subgrupo_material_w
                    and     coalesce(cd_classe_material, cd_classe_material_w) = cd_classe_material_w
                    and     coalesce(cd_material, cd_material_w) = cd_material_w
                    and     ie_tipo_regra = '3'
                    and     coalesce(obter_se_restringe_div_oc_nf(nr_sequencia, cd_cgc_emitente_w), 'S') = 'S';

                    if (pr_diferenca_w > 0) then
                        qt_diferenca_ww := round((dividir((vl_unitario_item_oci_w * pr_diferenca_w), 100))::numeric, 4);
                    end if;

                    if (qt_existe_w > 0) and
                      (((pr_diferenca_w > 0) and (round((qt_diferenca_ww + vl_unitario_item_oci_w)::numeric, 4) < vl_unitario_item_nf_w)) or 
                      ((qt_diferenca_w > 0) and (vl_unitario_item_nf_w > vl_unitario_item_oci_w) and (abs(vl_unitario_item_nf_w - vl_unitario_item_oci_w) > qt_diferenca_w))) then
                        begin
                            select  coalesce(max(nr_sequencia), 0)
                            into STRICT    nr_seq_divergencia_w
                            from    divergencia_ordem_compra_item
                            where   cd_tipo_divergencia = 3
                            and     ie_situacao = 'I'
                            and     nr_seq_nf = nr_sequencia_p
                            and     nr_item_nf = nr_item_nf_w
                            and     nr_ordem_compra = nr_ordem_compra_w
                            and     nr_item_doi_nfe = nr_item_oci_w;

                            if (nr_seq_divergencia_w > 0) then
                                update  divergencia_ordem_compra_item
                                set     ie_situacao = 'A'
                                where   nr_sequencia = nr_seq_divergencia_w;
                            else
                                select  coalesce(max(nr_sequencia), 0) + 1
                                into STRICT    nr_seq_divergencia_w
                                from    divergencia_ordem_compra_item;

                                insert into divergencia_ordem_compra_item(
                                    nr_ordem_compra,
                                    nr_item_doi_nfe,
                                    cd_tipo_divergencia,
                                    cd_estabelecimento,
                                    cd_cgc_emitente,
                                    cd_pessoa_fisica,
                                    cd_serie_nf,
                                    nr_nota_fiscal,
                                    nr_sequencia_nf,
                                    nr_item_nf,
                                    dt_atualizacao,
                                    nm_usuario,
                                    ds_observacao,
                                    nr_seq_nf,
                                    nr_sequencia,
                                    ie_situacao,
                                    ie_permite_justif,
                                    dt_prevista_entrega
                               ) values (
                                    nr_ordem_compra_w,
                                    nr_item_oci_w,
                                    3,
                                    cd_estabelecimento_w,
                                    cd_cgc_emitente_w,
                                    cd_pessoa_fisica_w,
                                    cd_serie_nf_w,
                                    nr_nota_fiscal_w,
                                    nr_sequencia_nf_w,
                                    nr_item_nf_w,
                                    clock_timestamp(),
                                    nm_usuario_p,
                                    null,
                                    nr_sequencia_p,
                                    nr_seq_divergencia_w,
                                    'A',
                                    ie_permite_justif_w,
                                    dt_entrega_ordem_w
                               );

                            end if;
                        end;

                        ie_divergencia_w := 'S';
                    end if;

		/* 8 - Alteracao preco unitario (a menor)*/

                    select  count(*),
                            coalesce(max(pr_diferenca), 0),
                            coalesce(max(qt_diferenca), 0),
                            coalesce(max(ie_permite_justif), 'S')
                    into STRICT    qt_existe_w,
                            pr_diferenca_w,
                            qt_diferenca_w,
                            ie_permite_justif_w
                    from
                        regra_diverg_oc_nf
                    where
                        cd_estabelecimento = cd_estabelecimento_w
                        and coalesce(cd_local_estoque, cd_local_estoque_w) = cd_local_estoque_w
                        and coalesce(cd_grupo_material, cd_grupo_material_w) = cd_grupo_material_w
                        and coalesce(cd_subgrupo_material, cd_subgrupo_material_w) = cd_subgrupo_material_w
                        and coalesce(cd_classe_material, cd_classe_material_w) = cd_classe_material_w
                        and coalesce(cd_material, cd_material_w) = cd_material_w
                        and ie_tipo_regra = '8'
                        and coalesce(obter_se_restringe_div_oc_nf(nr_sequencia, cd_cgc_emitente_w), 'S') = 'S';

                    if (pr_diferenca_w > 0) then
                        qt_diferenca_ww := round((dividir((vl_unitario_item_oci_w * pr_diferenca_w), 100))::numeric, 4);
                    end if;

                    if (qt_existe_w > 0) and
                        (((pr_diferenca_w > 0) and (round((abs(qt_diferenca_ww - vl_unitario_item_oci_w))::numeric, 4) > vl_unitario_item_nf_w)) or 
                         ((qt_diferenca_w > 0) and (vl_unitario_item_nf_w < vl_unitario_item_oci_w) and (abs(vl_unitario_item_nf_w - vl_unitario_item_oci_w) > qt_diferenca_w))) then
                        begin
                            select  coalesce(max(nr_sequencia), 0)
                            into STRICT    nr_seq_divergencia_w
                            from    divergencia_ordem_compra_item
                            where   cd_tipo_divergencia = 8
                            and     ie_situacao = 'I'
                            and     nr_seq_nf = nr_sequencia_p
                            and     nr_item_nf = nr_item_nf_w
                            and     nr_ordem_compra = nr_ordem_compra_w
                            and     nr_item_doi_nfe = nr_item_oci_w;

                            if (nr_seq_divergencia_w > 0) then
                                update  divergencia_ordem_compra_item
                                set     ie_situacao = 'A'
                                where   nr_sequencia = nr_seq_divergencia_w;
                            else
                                select  coalesce(max(nr_sequencia), 0) + 1
                                into STRICT    nr_seq_divergencia_w
                                from    divergencia_ordem_compra_item;

                                insert into divergencia_ordem_compra_item(
                                    nr_ordem_compra,
                                    nr_item_doi_nfe,
                                    cd_tipo_divergencia,
                                    cd_estabelecimento,
                                    cd_cgc_emitente,
                                    cd_pessoa_fisica,
                                    cd_serie_nf,
                                    nr_nota_fiscal,
                                    nr_sequencia_nf,
                                    nr_item_nf,
                                    dt_atualizacao,
                                    nm_usuario,
                                    ds_observacao,
                                    nr_seq_nf,
                                    nr_sequencia,
                                    ie_situacao,
                                    ie_permite_justif,
                                    dt_prevista_entrega
                               ) values (
                                    nr_ordem_compra_w,
                                    nr_item_oci_w,
                                    8,
                                    cd_estabelecimento_w,
                                    cd_cgc_emitente_w,
                                    cd_pessoa_fisica_w,
                                    cd_serie_nf_w,
                                    nr_nota_fiscal_w,
                                    nr_sequencia_nf_w,
                                    nr_item_nf_w,
                                    clock_timestamp(),
                                    nm_usuario_p,
                                    null,
                                    nr_sequencia_p,
                                    nr_seq_divergencia_w,
                                    'A',
                                    ie_permite_justif_w,
                                    dt_entrega_ordem_w
                               );

                            end if;

                        end;

                        ie_divergencia_w := 'S';
                    end if;

		/* 4 - Alteracao desconto (a maior)*/

                    select  count(*),
                            coalesce(max(pr_diferenca), 0),
                            coalesce(max(ie_permite_justif), 'S')
                    into STRICT    qt_existe_w,
                            pr_diferenca_w,
                            ie_permite_justif_w
                    from    regra_diverg_oc_nf
                    where   cd_estabelecimento = cd_estabelecimento_w
                    and     coalesce(cd_local_estoque, cd_local_estoque_w) = cd_local_estoque_w
                    and     coalesce(cd_grupo_material, cd_grupo_material_w) = cd_grupo_material_w
                    and     coalesce(cd_subgrupo_material, cd_subgrupo_material_w) = cd_subgrupo_material_w
                    and     coalesce(cd_classe_material, cd_classe_material_w) = cd_classe_material_w
                    and     coalesce(cd_material, cd_material_w) = cd_material_w
                    and     ie_tipo_regra = '4'
                    and     coalesce(obter_se_restringe_div_oc_nf(nr_sequencia, cd_cgc_emitente_w), 'S') = 'S';

                    pr_desconto_nf_w := round((dividir((vl_descontos_nf_w * 100), vl_mercadoria_w))::numeric, 4);

                    if (qt_existe_w > 0) and
                        ((vl_desconto_oc_w > 0 and round((abs(dividir((vl_desconto_oc_w * pr_diferenca_w), 100) + vl_desconto_oc_w))::numeric, 4) < vl_descontos_nf_w) or (pr_desconto_w > 0 and round((abs(dividir((pr_desconto_w * pr_diferenca_w), 100) + pr_desconto_w))::numeric, 4) < pr_desconto_nf_w)) then
                        begin
                            select  coalesce(max(nr_sequencia), 0)
                            into STRICT    nr_seq_divergencia_w
                            from    divergencia_ordem_compra_item
                            where   cd_tipo_divergencia = 4
                            and     ie_situacao = 'I'
                            and     nr_seq_nf = nr_sequencia_p
                            and     nr_item_nf = nr_item_nf_w
                            and     nr_ordem_compra = nr_ordem_compra_w
                            and     nr_item_doi_nfe = nr_item_oci_w;

                            if (nr_seq_divergencia_w > 0) then
                                update  divergencia_ordem_compra_item
                                set     ie_situacao = 'A'
                                where   nr_sequencia = nr_seq_divergencia_w;
                            else
                                select  coalesce(max(nr_sequencia), 0) + 1
                                into STRICT    nr_seq_divergencia_w
                                from    divergencia_ordem_compra_item;

                                insert into divergencia_ordem_compra_item(
                                    nr_ordem_compra,
                                    nr_item_doi_nfe,
                                    cd_tipo_divergencia,
                                    cd_estabelecimento,
                                    cd_cgc_emitente,
                                    cd_pessoa_fisica,
                                    cd_serie_nf,
                                    nr_nota_fiscal,
                                    nr_sequencia_nf,
                                    nr_item_nf,
                                    dt_atualizacao,
                                    nm_usuario,
                                    ds_observacao,
                                    nr_seq_nf,
                                    nr_sequencia,
                                    ie_situacao,
                                    ie_permite_justif,
                                    dt_prevista_entrega
                               ) values (
                                    nr_ordem_compra_w,
                                    nr_item_oci_w,
                                    4,
                                    cd_estabelecimento_w,
                                    cd_cgc_emitente_w,
                                    cd_pessoa_fisica_w,
                                    cd_serie_nf_w,
                                    nr_nota_fiscal_w,
                                    nr_sequencia_nf_w,
                                    nr_item_nf_w,
                                    clock_timestamp(),
                                    nm_usuario_p,
                                    null,
                                    nr_sequencia_p,
                                    nr_seq_divergencia_w,
                                    'A',
                                    ie_permite_justif_w,
                                    dt_entrega_ordem_w
                               );

                            end if;

                            ie_divergencia_w := 'S';
                        end;
                    end if;
			
		/* 9 - Alteracao desconto (a menor) */

                    select  count(*),
                            coalesce(max(pr_diferenca), 0),
                            coalesce(max(ie_permite_justif), 'S')
                    into STRICT    qt_existe_w,
                            pr_diferenca_w,
                            ie_permite_justif_w
                    from    regra_diverg_oc_nf
                    where   cd_estabelecimento = cd_estabelecimento_w
                    and     coalesce(cd_local_estoque, cd_local_estoque_w) = cd_local_estoque_w
                    and     coalesce(cd_grupo_material, cd_grupo_material_w) = cd_grupo_material_w
                    and     coalesce(cd_subgrupo_material, cd_subgrupo_material_w) = cd_subgrupo_material_w
                    and     coalesce(cd_classe_material, cd_classe_material_w) = cd_classe_material_w
                    and     coalesce(cd_material, cd_material_w) = cd_material_w
                    and     ie_tipo_regra = '9'
                    and     coalesce(obter_se_restringe_div_oc_nf(nr_sequencia, cd_cgc_emitente_w), 'S') = 'S';

                    pr_desconto_nf_w := round((abs(dividir((vl_descontos_nf_w * 100), vl_total_nota_w)))::numeric, 4);

                    if (qt_existe_w > 0) and
                        ((round((abs(dividir((vl_desconto_oc_w * pr_diferenca_w), 100) - vl_desconto_oc_w))::numeric, 4) > vl_descontos_nf_w) or (round((abs(dividir((pr_desconto_w * pr_diferenca_w), 100) - pr_desconto_w))::numeric, 4) > pr_desconto_nf_w)) then
                        begin
                            select  coalesce(max(nr_sequencia), 0)
                            into STRICT    nr_seq_divergencia_w
                            from    divergencia_ordem_compra_item
                            where   cd_tipo_divergencia = 9
                            and     ie_situacao = 'I'
                            and     nr_seq_nf = nr_sequencia_p
                            and     nr_item_nf = nr_item_nf_w
                            and     nr_ordem_compra = nr_ordem_compra_w
                            and     nr_item_doi_nfe = nr_item_oci_w;

                            if (nr_seq_divergencia_w > 0) then
                                update  divergencia_ordem_compra_item
                                set     ie_situacao = 'A'
                                where   nr_sequencia = nr_seq_divergencia_w;
                            else
                                select  coalesce(max(nr_sequencia), 0) + 1
                                into STRICT    nr_seq_divergencia_w
                                from    divergencia_ordem_compra_item;

                                insert into divergencia_ordem_compra_item(
                                    nr_ordem_compra,
                                    nr_item_doi_nfe,
                                    cd_tipo_divergencia,
                                    cd_estabelecimento,
                                    cd_cgc_emitente,
                                    cd_pessoa_fisica,
                                    cd_serie_nf,
                                    nr_nota_fiscal,
                                    nr_sequencia_nf,
                                    nr_item_nf,
                                    dt_atualizacao,
                                    nm_usuario,
                                    ds_observacao,
                                    nr_seq_nf,
                                    nr_sequencia,
                                    ie_situacao,
                                    ie_permite_justif,
                                    dt_prevista_entrega
                               ) values (
                                    nr_ordem_compra_w,
                                    nr_item_oci_w,
                                    9,
                                    cd_estabelecimento_w,
                                    cd_cgc_emitente_w,
                                    cd_pessoa_fisica_w,
                                    cd_serie_nf_w,
                                    nr_nota_fiscal_w,
                                    nr_sequencia_nf_w,
                                    nr_item_nf_w,
                                    clock_timestamp(),
                                    nm_usuario_p,
                                    null,
                                    nr_sequencia_p,
                                    nr_seq_divergencia_w,
                                    'A',
                                    ie_permite_justif_w,
                                    dt_entrega_ordem_w
                               );

                            end if;

                            ie_divergencia_w := 'S';
                        end;
                    end if;
		
		/* 5 -  Alteracao local estoque */

                    select  count(*),
                            coalesce(max(ie_permite_justif), 'S')
                    into STRICT    qt_existe_w,
                            ie_permite_justif_w
                    from    regra_diverg_oc_nf
                    where   cd_estabelecimento = cd_estabelecimento_w
                    and     coalesce(cd_local_estoque, cd_local_estoque_w) = cd_local_estoque_w
                    and     coalesce(cd_grupo_material, cd_grupo_material_w) = cd_grupo_material_w
                    and     coalesce(cd_subgrupo_material, cd_subgrupo_material_w) = cd_subgrupo_material_w
                    and     coalesce(cd_classe_material, cd_classe_material_w) = cd_classe_material_w
                    and     coalesce(cd_material, cd_material_w) = cd_material_w
                    and     ie_tipo_regra = '5'
                    and     coalesce(obter_se_restringe_div_oc_nf(nr_sequencia, cd_cgc_emitente_w), 'S') = 'S';

                    if (qt_existe_w > 0) and (cd_local_estoque_w <> cd_local_estoque_oci_w) then
                        begin
                            select  coalesce(max(nr_sequencia), 0)
                            into STRICT    nr_seq_divergencia_w
                            from    divergencia_ordem_compra_item
                            where   cd_tipo_divergencia = 5
                            and     ie_situacao = 'I'
                            and     nr_seq_nf = nr_sequencia_p
                            and     nr_item_nf = nr_item_nf_w
                            and     nr_ordem_compra = nr_ordem_compra_w
                            and     nr_item_doi_nfe = nr_item_oci_w;

                            if (nr_seq_divergencia_w > 0) then
                                update  divergencia_ordem_compra_item
                                set     ie_situacao = 'A'
                                where   nr_sequencia = nr_seq_divergencia_w;
                            else
                                select  coalesce(max(nr_sequencia), 0) + 1
                                into STRICT    nr_seq_divergencia_w
                                from    divergencia_ordem_compra_item;

                                insert into divergencia_ordem_compra_item(
                                    nr_ordem_compra,
                                    nr_item_doi_nfe,
                                    cd_tipo_divergencia,
                                    cd_estabelecimento,
                                    cd_cgc_emitente,
                                    cd_pessoa_fisica,
                                    cd_serie_nf,
                                    nr_nota_fiscal,
                                    nr_sequencia_nf,
                                    nr_item_nf,
                                    dt_atualizacao,
                                    nm_usuario,
                                    ds_observacao,
                                    nr_seq_nf,
                                    nr_sequencia,
                                    ie_situacao,
                                    ie_permite_justif,
                                    dt_prevista_entrega
                               ) values (
                                    nr_ordem_compra_w,
                                    nr_item_oci_w,
                                    5,
                                    cd_estabelecimento_w,
                                    cd_cgc_emitente_w,
                                    cd_pessoa_fisica_w,
                                    cd_serie_nf_w,
                                    nr_nota_fiscal_w,
                                    nr_sequencia_nf_w,
                                    nr_item_nf_w,
                                    clock_timestamp(),
                                    nm_usuario_p,
                                    null,
                                    nr_sequencia_p,
                                    nr_seq_divergencia_w,
                                    'A',
                                    ie_permite_justif_w,
                                    dt_entrega_ordem_w
                               );
                            end if;

                            ie_divergencia_w := 'S';
                        end;
                    end if;

		/* 6 -  Atraso na entrega */

                    select  count(*),
                            coalesce(max(ie_permite_justif), 'S'),
                            coalesce(max(qt_diferenca), 0)
                    into STRICT    qt_existe_w,
                            ie_permite_justif_w,
                            qt_diferenca_w
                    from    regra_diverg_oc_nf
                    where   cd_estabelecimento = cd_estabelecimento_w
                    and     coalesce(cd_local_estoque, cd_local_estoque_w) = cd_local_estoque_w
                    and     coalesce(cd_grupo_material, cd_grupo_material_w) = cd_grupo_material_w
                    and     coalesce(cd_subgrupo_material, cd_subgrupo_material_w) = cd_subgrupo_material_w
                    and     coalesce(cd_classe_material, cd_classe_material_w) = cd_classe_material_w
                    and     coalesce(cd_material, cd_material_w) = cd_material_w
                    and     ie_tipo_regra = '6'
                    and     coalesce(obter_se_restringe_div_oc_nf(nr_sequencia, cd_cgc_emitente_w), 'S') = 'S';

                    if (qt_existe_w > 0) and
                        (((trunc(dt_entrada_saida_w, 'dd') > trunc(dt_prevista_entrega_w, 'dd')) and (qt_diferenca_w = 0)) or 
                            (((trunc(dt_entrada_saida_w, 'dd') - trunc(dt_prevista_entrega_w, 'dd')) > qt_diferenca_w) and 
                              qt_diferenca_w > 0)) then
                        begin
                            select  coalesce(max(nr_sequencia), 0)
                            into STRICT    nr_seq_divergencia_w
                            from    divergencia_ordem_compra_item
                            where   cd_tipo_divergencia = 6
                            and     ie_situacao = 'I'
                            and     nr_seq_nf = nr_sequencia_p
                            and     nr_item_nf = nr_item_nf_w
                            and     nr_ordem_compra = nr_ordem_compra_w
                            and     nr_item_doi_nfe = nr_item_oci_w;

                            if (nr_seq_divergencia_w > 0) then
                                update  divergencia_ordem_compra_item
                                set     ie_situacao = 'A'
                                where   nr_sequencia = nr_seq_divergencia_w;
                            else
                                select  coalesce(max(nr_sequencia), 0) + 1
                                into STRICT    nr_seq_divergencia_w
                                from    divergencia_ordem_compra_item;

                                insert into divergencia_ordem_compra_item(
                                    nr_ordem_compra,
                                    nr_item_doi_nfe,
                                    cd_tipo_divergencia,
                                    cd_estabelecimento,
                                    cd_cgc_emitente,
                                    cd_pessoa_fisica,
                                    cd_serie_nf,
                                    nr_nota_fiscal,
                                    nr_sequencia_nf,
                                    nr_item_nf,
                                    dt_atualizacao,
                                    nm_usuario,
                                    ds_observacao,
                                    nr_seq_nf,
                                    nr_sequencia,
                                    ie_situacao,
                                    ie_permite_justif,
                                    dt_prevista_entrega
                               ) values (
                                    nr_ordem_compra_w,
                                    nr_item_oci_w,
                                    6,
                                    cd_estabelecimento_w,
                                    cd_cgc_emitente_w,
                                    cd_pessoa_fisica_w,
                                    cd_serie_nf_w,
                                    nr_nota_fiscal_w,
                                    nr_sequencia_nf_w,
                                    nr_item_nf_w,
                                    clock_timestamp(),
                                    nm_usuario_p,
                                    null,
                                    nr_sequencia_p,
                                    nr_seq_divergencia_w,
                                    'A',
                                    ie_permite_justif_w,
                                    dt_entrega_ordem_w
                               );

                            end if;

                            ie_divergencia_w := 'S';
                        end;
                    end if;
		
		/*10 - Especificacao do item*/

                    select  count(*),
                            coalesce(max(ie_permite_justif), 'S')
                    into STRICT    qt_existe_w,
                            ie_permite_justif_w
                    from    regra_diverg_oc_nf
                    where   cd_estabelecimento = cd_estabelecimento_w
                    and     coalesce(cd_local_estoque, cd_local_estoque_w) = cd_local_estoque_w
                    and     coalesce(cd_grupo_material, cd_grupo_material_w) = cd_grupo_material_w
                    and     coalesce(cd_subgrupo_material, cd_subgrupo_material_w) = cd_subgrupo_material_w
                    and     coalesce(cd_classe_material, cd_classe_material_w) = cd_classe_material_w
                    and     coalesce(cd_material, cd_material_w) = cd_material_w
                    and     ie_tipo_regra = '10'
                    and     coalesce(obter_se_restringe_div_oc_nf(nr_sequencia, cd_cgc_emitente_w), 'S') = 'S';

                    if (qt_existe_w > 0) and (cd_material_oci_w <> cd_material_w) then
                        begin
                            select  coalesce(max(nr_sequencia), 0)
                            into STRICT    nr_seq_divergencia_w
                            from    divergencia_ordem_compra_item
                            where   cd_tipo_divergencia = 10
                            and     ie_situacao = 'I'
                            and     nr_seq_nf = nr_sequencia_p
                            and     nr_item_nf = nr_item_nf_w
                            and     nr_ordem_compra = nr_ordem_compra_w
                            and     nr_item_doi_nfe = nr_item_oci_w;

                            if (nr_seq_divergencia_w > 0) then
                                update  divergencia_ordem_compra_item
                                set     ie_situacao = 'A'
                                where   nr_sequencia = nr_seq_divergencia_w;
                            else
                                select  coalesce(max(nr_sequencia), 0) + 1
                                into STRICT    nr_seq_divergencia_w
                                from    divergencia_ordem_compra_item;

                                insert into divergencia_ordem_compra_item(
                                    nr_ordem_compra,
                                    nr_item_doi_nfe,
                                    cd_tipo_divergencia,
                                    cd_estabelecimento,
                                    cd_cgc_emitente,
                                    cd_pessoa_fisica,
                                    cd_serie_nf,
                                    nr_nota_fiscal,
                                    nr_sequencia_nf,
                                    nr_item_nf,
                                    dt_atualizacao,
                                    nm_usuario,
                                    ds_observacao,
                                    nr_seq_nf,
                                    nr_sequencia,
                                    ie_situacao,
                                    ie_permite_justif,
                                    dt_prevista_entrega
                               ) values (
                                    nr_ordem_compra_w,
                                    nr_item_oci_w,
                                    10,
                                    cd_estabelecimento_w,
                                    cd_cgc_emitente_w,
                                    cd_pessoa_fisica_w,
                                    cd_serie_nf_w,
                                    nr_nota_fiscal_w,
                                    nr_sequencia_nf_w,
                                    nr_item_nf_w,
                                    clock_timestamp(),
                                    nm_usuario_p,
                                    null,
                                    nr_sequencia_p,
                                    nr_seq_divergencia_w,
                                    'A',
                                    ie_permite_justif_w,
                                    dt_entrega_ordem_w
                               );

                            end if;

                            ie_divergencia_w := 'S';
                        end;
                    end if;
		
		/* 11 -  Alteracao na condicao de pagamento */

                    select  count(*),
                            coalesce(max(ie_permite_justif), 'S')
                    into STRICT    qt_existe_w,
                            ie_permite_justif_w
                    from    regra_diverg_oc_nf
                    where   cd_estabelecimento = cd_estabelecimento_w
                    and     coalesce(cd_local_estoque, cd_local_estoque_w) = cd_local_estoque_w
                    and     coalesce(cd_grupo_material, cd_grupo_material_w) = cd_grupo_material_w
                    and     coalesce(cd_subgrupo_material, cd_subgrupo_material_w) = cd_subgrupo_material_w
                    and     coalesce(cd_classe_material, cd_classe_material_w) = cd_classe_material_w
                    and     coalesce(cd_material, cd_material_w) = cd_material_w
                    and     ie_tipo_regra = '11'
                    and     coalesce(obter_se_restringe_div_oc_nf(nr_sequencia, cd_cgc_emitente_w), 'S') = 'S';

                    if (qt_existe_w > 0) and (cd_cond_pagto_ordem_w <> cd_cond_pagto_nota_w) then
                        begin
                            select  coalesce(max(nr_sequencia), 0)
                            into STRICT    nr_seq_divergencia_w
                            from    divergencia_ordem_compra_item
                            where   cd_tipo_divergencia = 11
                            and     ie_situacao = 'I'
                            and     nr_seq_nf = nr_sequencia_p
                            and     nr_item_nf = nr_item_nf_w
                            and     nr_ordem_compra = nr_ordem_compra_w
                            and     nr_item_doi_nfe = nr_item_oci_w;

                            if (nr_seq_divergencia_w > 0) then
                                update  divergencia_ordem_compra_item
                                set     ie_situacao = 'A'
                                where   nr_sequencia = nr_seq_divergencia_w;
                            else
                                select  coalesce(max(nr_sequencia), 0) + 1
                                into STRICT    nr_seq_divergencia_w
                                from    divergencia_ordem_compra_item;

                                insert into divergencia_ordem_compra_item(
                                    nr_ordem_compra,
                                    nr_item_doi_nfe,
                                    cd_tipo_divergencia,
                                    cd_estabelecimento,
                                    cd_cgc_emitente,
                                    cd_pessoa_fisica,
                                    cd_serie_nf,
                                    nr_nota_fiscal,
                                    nr_sequencia_nf,
                                    nr_item_nf,
                                    dt_atualizacao,
                                    nm_usuario,
                                    ds_observacao,
                                    nr_seq_nf,
                                    nr_sequencia,
                                    ie_situacao,
                                    ie_permite_justif,
                                    dt_prevista_entrega
                               ) values (
                                    nr_ordem_compra_w,
                                    nr_item_oci_w,
                                    11,
                                    cd_estabelecimento_w,
                                    cd_cgc_emitente_w,
                                    cd_pessoa_fisica_w,
                                    cd_serie_nf_w,
                                    nr_nota_fiscal_w,
                                    nr_sequencia_nf_w,
                                    nr_item_nf_w,
                                    clock_timestamp(),
                                    nm_usuario_p,
                                    null,
                                    nr_sequencia_p,
                                    nr_seq_divergencia_w,
                                    'A',
                                    ie_permite_justif_w,
                                    dt_entrega_ordem_w
                               );

                            end if;

                            ie_divergencia_w := 'S';
                        end;
                    end if;
		
		/*12 - Alteracao no frete (a maior) */

                    select  count(*),
                            coalesce(max(pr_diferenca), 0),
                            coalesce(max(qt_diferenca), 0),
                            coalesce(max(ie_permite_justif), 'S')
                    into STRICT    qt_existe_w,
                            pr_diferenca_w,
                            qt_diferenca_w,
                            ie_permite_justif_w
                    from    regra_diverg_oc_nf
                    where   cd_estabelecimento = cd_estabelecimento_w
                    and     coalesce(cd_local_estoque, cd_local_estoque_w) = cd_local_estoque_w
                    and     coalesce(cd_grupo_material, cd_grupo_material_w) = cd_grupo_material_w
                    and     coalesce(cd_subgrupo_material, cd_subgrupo_material_w) = cd_subgrupo_material_w
                    and     coalesce(cd_classe_material, cd_classe_material_w) = cd_classe_material_w
                    and     coalesce(cd_material, cd_material_w) = cd_material_w
                    and     ie_tipo_regra = '12'
                    and     coalesce(obter_se_restringe_div_oc_nf(nr_sequencia, cd_cgc_emitente_w), 'S') = 'S';

                    if (pr_diferenca_w > 0) then
                        qt_diferenca_ww := round((dividir((vl_frete_ordem_w * pr_diferenca_w), 100))::numeric, 4);
                    end if;

                    if (qt_existe_w > 0) and
                        (((pr_diferenca_w > 0) and (round((qt_diferenca_ww + vl_frete_ordem_w)::numeric, 4) < vl_frete_nota_w)) or 
                         ((qt_diferenca_w > 0) and (vl_frete_nota_w > vl_frete_ordem_w) and (abs(vl_frete_nota_w - vl_frete_ordem_w) > qt_diferenca_w))) then
                        begin
                            select  coalesce(max(nr_sequencia), 0)
                            into STRICT    nr_seq_divergencia_w
                            from    divergencia_ordem_compra_item
                            where   cd_tipo_divergencia = 12
                            and     ie_situacao = 'I'
                            and     nr_seq_nf = nr_sequencia_p
                            and     nr_item_nf = nr_item_nf_w
                            and     nr_ordem_compra = nr_ordem_compra_w
                            and     nr_item_doi_nfe = nr_item_oci_w;

                            if (nr_seq_divergencia_w > 0) then
                                update  divergencia_ordem_compra_item
                                set     ie_situacao = 'A'
                                where   nr_sequencia = nr_seq_divergencia_w;
                            else
                                select  coalesce(max(nr_sequencia), 0) + 1
                                into STRICT    nr_seq_divergencia_w
                                from    divergencia_ordem_compra_item;

                                insert into divergencia_ordem_compra_item(
                                    nr_ordem_compra,
                                    nr_item_doi_nfe,
                                    cd_tipo_divergencia,
                                    cd_estabelecimento,
                                    cd_cgc_emitente,
                                    cd_pessoa_fisica,
                                    cd_serie_nf,
                                    nr_nota_fiscal,
                                    nr_sequencia_nf,
                                    nr_item_nf,
                                    dt_atualizacao,
                                    nm_usuario,
                                    ds_observacao,
                                    nr_seq_nf,
                                    nr_sequencia,
                                    ie_situacao,
                                    ie_permite_justif,
                                    dt_prevista_entrega
                               ) values (
                                    nr_ordem_compra_w,
                                    nr_item_oci_w,
                                    12,
                                    cd_estabelecimento_w,
                                    cd_cgc_emitente_w,
                                    cd_pessoa_fisica_w,
                                    cd_serie_nf_w,
                                    nr_nota_fiscal_w,
                                    nr_sequencia_nf_w,
                                    nr_item_nf_w,
                                    clock_timestamp(),
                                    nm_usuario_p,
                                    null,
                                    nr_sequencia_p,
                                    nr_seq_divergencia_w,
                                    'A',
                                    ie_permite_justif_w,
                                    dt_entrega_ordem_w
                               );

                            end if;

                            ie_divergencia_w := 'S';
                        end;
                    end if;
		
		/* 13 - Alteracao valor total da nota (a menor)*/

                    select  count(*),
                            coalesce(max(pr_diferenca), 0),
                            coalesce(max(qt_diferenca), 0),
                            coalesce(max(ie_permite_justif), 'S')
                    into STRICT    qt_existe_w,
                            pr_diferenca_w,
                            qt_diferenca_w,
                            ie_permite_justif_w
                    from    regra_diverg_oc_nf
                    where   cd_estabelecimento = cd_estabelecimento_w
                    and     coalesce(cd_local_estoque, cd_local_estoque_w) = cd_local_estoque_w
                    and     coalesce(cd_grupo_material, cd_grupo_material_w) = cd_grupo_material_w
                    and     coalesce(cd_subgrupo_material, cd_subgrupo_material_w) = cd_subgrupo_material_w
                    and     coalesce(cd_classe_material, cd_classe_material_w) = cd_classe_material_w
                    and     coalesce(cd_material, cd_material_w) = cd_material_w
                    and     ie_tipo_regra = '13'
                    and     coalesce(obter_se_restringe_div_oc_nf(nr_sequencia, cd_cgc_emitente_w), 'S') = 'S';

                    if (ie_frete_w = 'F') then
                        vl_total_ordem_w := vl_total_ordem_w + vl_frete_ordem_w;
                    end if;
                    if (pr_diferenca_w > 0) then
                        qt_diferenca_ww := round((dividir((vl_total_ordem_w * pr_diferenca_w), 100))::numeric, 4);
                    end if;

                    if (qt_existe_w > 0) and
                        (((pr_diferenca_w > 0) and (round((abs(qt_diferenca_ww - vl_total_ordem_w))::numeric,4) > vl_total_nota_w)) or ((qt_diferenca_w > 0) and (vl_total_nota_w < vl_total_ordem_w) and (abs(vl_total_nota_w - vl_total_ordem_w) > qt_diferenca_w))) then
                        begin
                            select  coalesce(max(nr_sequencia), 0)
                            into STRICT    nr_seq_divergencia_w
                            from    divergencia_ordem_compra_item
                            where   cd_tipo_divergencia = 13
                            and     ie_situacao = 'I'
                            and     nr_seq_nf = nr_sequencia_p
                            and     nr_item_nf = nr_item_nf_w
                            and     nr_ordem_compra = nr_ordem_compra_w
                            and     nr_item_doi_nfe = nr_item_oci_w;

                            if (nr_seq_divergencia_w > 0) then
                                update  divergencia_ordem_compra_item
                                set     ie_situacao = 'A'
                                where   nr_sequencia = nr_seq_divergencia_w;
                            else
                                select  coalesce(max(nr_sequencia), 0) + 1
                                into STRICT    nr_seq_divergencia_w
                                from    divergencia_ordem_compra_item;

                                insert into divergencia_ordem_compra_item(
                                    nr_ordem_compra,
                                    nr_item_doi_nfe,
                                    cd_tipo_divergencia,
                                    cd_estabelecimento,
                                    cd_cgc_emitente,
                                    cd_pessoa_fisica,
                                    cd_serie_nf,
                                    nr_nota_fiscal,
                                    nr_sequencia_nf,
                                    nr_item_nf,
                                    dt_atualizacao,
                                    nm_usuario,
                                    ds_observacao,
                                    nr_seq_nf,
                                    nr_sequencia,
                                    ie_situacao,
                                    ie_permite_justif,
                                    dt_prevista_entrega
                               ) values (
                                    nr_ordem_compra_w,
                                    nr_item_oci_w,
                                    13,
                                    cd_estabelecimento_w,
                                    cd_cgc_emitente_w,
                                    cd_pessoa_fisica_w,
                                    cd_serie_nf_w,
                                    nr_nota_fiscal_w,
                                    nr_sequencia_nf_w,
                                    nr_item_nf_w,
                                    clock_timestamp(),
                                    nm_usuario_p,
                                    null,
                                    nr_sequencia_p,
                                    nr_seq_divergencia_w,
                                    'A',
                                    ie_permite_justif_w,
                                    dt_entrega_ordem_w
                               );

                            end if;

                        end;

                        ie_divergencia_w := 'S';
                    end if;

		/* 14 - Alteracao valor total da nota (a maior)*/

                    select  count(*),
                            coalesce(max(pr_diferenca), 0),
                            coalesce(max(qt_diferenca), 0),
                            coalesce(max(ie_permite_justif), 'S')
                    into STRICT    qt_existe_w,
                            pr_diferenca_w,
                            qt_diferenca_w,
                            ie_permite_justif_w
                    from    regra_diverg_oc_nf
                    where   cd_estabelecimento = cd_estabelecimento_w
                    and     coalesce(cd_local_estoque, cd_local_estoque_w) = cd_local_estoque_w
                    and     coalesce(cd_grupo_material, cd_grupo_material_w) = cd_grupo_material_w
                    and     coalesce(cd_subgrupo_material, cd_subgrupo_material_w) = cd_subgrupo_material_w
                    and     coalesce(cd_classe_material, cd_classe_material_w) = cd_classe_material_w
                    and     coalesce(cd_material, cd_material_w) = cd_material_w
                    and     ie_tipo_regra = '14'
                    and     coalesce(obter_se_restringe_div_oc_nf(nr_sequencia, cd_cgc_emitente_w), 'S') = 'S';

                    if (ie_frete_w = 'F') then
                        vl_total_ordem_w := vl_total_ordem_w + vl_frete_ordem_w;
                    end if;
                    if (pr_diferenca_w > 0) then
                        qt_diferenca_w := round((dividir((vl_total_ordem_w * pr_diferenca_w), 100))::numeric, 4);
                    end if;

                    if (qt_existe_w > 0) and (((pr_diferenca_w > 0) and (round((abs(qt_diferenca_ww - vl_total_ordem_w))::numeric,4) > vl_total_nota_w)) or
                         ((qt_diferenca_w > 0) and (vl_total_nota_w > vl_total_ordem_w) and (abs(vl_total_nota_w- vl_total_ordem_w) > qt_diferenca_w))) then
                        begin
                            select  coalesce(max(nr_sequencia), 0)
                            into STRICT    nr_seq_divergencia_w
                            from    divergencia_ordem_compra_item
                            where   cd_tipo_divergencia = 14
                            and     ie_situacao = 'I'
                            and     nr_seq_nf = nr_sequencia_p
                            and     nr_item_nf = nr_item_nf_w
                            and     nr_ordem_compra = nr_ordem_compra_w
                            and     nr_item_doi_nfe = nr_item_oci_w;

                            if (nr_seq_divergencia_w > 0) then
                                update  divergencia_ordem_compra_item
                                set     ie_situacao = 'A'
                                where   nr_sequencia = nr_seq_divergencia_w;
                            else
                                select  coalesce(max(nr_sequencia), 0) + 1
                                into STRICT    nr_seq_divergencia_w
                                from    divergencia_ordem_compra_item;

                                insert into divergencia_ordem_compra_item(
                                    nr_ordem_compra,
                                    nr_item_doi_nfe,
                                    cd_tipo_divergencia,
                                    cd_estabelecimento,
                                    cd_cgc_emitente,
                                    cd_pessoa_fisica,
                                    cd_serie_nf,
                                    nr_nota_fiscal,
                                    nr_sequencia_nf,
                                    nr_item_nf,
                                    dt_atualizacao,
                                    nm_usuario,
                                    ds_observacao,
                                    nr_seq_nf,
                                    nr_sequencia,
                                    ie_situacao,
                                    ie_permite_justif,
                                    dt_prevista_entrega
                               ) values (
                                    nr_ordem_compra_w,
                                    nr_item_oci_w,
                                    14,
                                    cd_estabelecimento_w,
                                    cd_cgc_emitente_w,
                                    cd_pessoa_fisica_w,
                                    cd_serie_nf_w,
                                    nr_nota_fiscal_w,
                                    nr_sequencia_nf_w,
                                    nr_item_nf_w,
                                    clock_timestamp(),
                                    nm_usuario_p,
                                    null,
                                    nr_sequencia_p,
                                    nr_seq_divergencia_w,
                                    'A',
                                    ie_permite_justif_w,
                                    dt_entrega_ordem_w
                               );

                            end if;

                        end;

                        ie_divergencia_w := 'S';
                    end if;
		
		/*15 - Alteracao na despesa acessoria */

                    select  count(*),
                            coalesce(max(pr_diferenca), 0),
                            coalesce(max(qt_diferenca), 0),
                            coalesce(max(ie_permite_justif), 'S')
                    into STRICT    qt_existe_w,
                            pr_diferenca_w,
                            qt_diferenca_w,
                            ie_permite_justif_w
                    from    regra_diverg_oc_nf
                    where   cd_estabelecimento = cd_estabelecimento_w
                    and     coalesce(cd_local_estoque, cd_local_estoque_w) = cd_local_estoque_w
                    and     coalesce(cd_grupo_material, cd_grupo_material_w) = cd_grupo_material_w
                    and     coalesce(cd_subgrupo_material, cd_subgrupo_material_w) = cd_subgrupo_material_w
                    and     coalesce(cd_classe_material, cd_classe_material_w) = cd_classe_material_w
                    and     coalesce(cd_material, cd_material_w) = cd_material_w
                    and     ie_tipo_regra = '15'
                    and     coalesce(obter_se_restringe_div_oc_nf(nr_sequencia, cd_cgc_emitente_w), 'S') = 'S';

                    if (pr_diferenca_w > 0) then
                        qt_diferenca_w := round((dividir((vl_despesa_acessoria_oc_w * pr_diferenca_w), 100))::numeric, 4);
                    end if;

                    if (qt_existe_w > 0) and (round((abs(vl_despesa_acessoria_nf_w - vl_despesa_acessoria_oc_w))::numeric, 4) > qt_diferenca_w) then
                        begin
                            select  coalesce(max(nr_sequencia), 0)
                            into STRICT    nr_seq_divergencia_w
                            from    divergencia_ordem_compra_item
                            where   cd_tipo_divergencia = 15
                            and     ie_situacao = 'I'
                            and     nr_seq_nf = nr_sequencia_p
                            and     nr_item_nf = nr_item_nf_w
                            and     nr_ordem_compra = nr_ordem_compra_w
                            and     nr_item_doi_nfe = nr_item_oci_w;

                            if (nr_seq_divergencia_w > 0) then
                                update  divergencia_ordem_compra_item
                                set     ie_situacao = 'A'
                                where   nr_sequencia = nr_seq_divergencia_w;
                            else
                                select  coalesce(max(nr_sequencia), 0) + 1
                                into STRICT    nr_seq_divergencia_w
                                from    divergencia_ordem_compra_item;

                                insert into divergencia_ordem_compra_item(
                                    nr_ordem_compra,
                                    nr_item_doi_nfe,
                                    cd_tipo_divergencia,
                                    cd_estabelecimento,
                                    cd_cgc_emitente,
                                    cd_pessoa_fisica,
                                    cd_serie_nf,
                                    nr_nota_fiscal,
                                    nr_sequencia_nf,
                                    nr_item_nf,
                                    dt_atualizacao,
                                    nm_usuario,
                                    ds_observacao,
                                    nr_seq_nf,
                                    nr_sequencia,
                                    ie_situacao,
                                    ie_permite_justif,
                                    dt_prevista_entrega
                               ) values (
                                    nr_ordem_compra_w,
                                    nr_item_oci_w,
                                    15,
                                    cd_estabelecimento_w,
                                    cd_cgc_emitente_w,
                                    cd_pessoa_fisica_w,
                                    cd_serie_nf_w,
                                    nr_nota_fiscal_w,
                                    nr_sequencia_nf_w,
                                    nr_item_nf_w,
                                    clock_timestamp(),
                                    nm_usuario_p,
                                    null,
                                    nr_sequencia_p,
                                    nr_seq_divergencia_w,
                                    'A',
                                    ie_permite_justif_w,
                                    dt_entrega_ordem_w
                               );

                            end if;

                            ie_divergencia_w := 'S';
                        end;
                    end if;
		
		
		/* 16 - Alteracao valor IPI*/

                    select  count(*),
                            coalesce(max(pr_diferenca), 0),
                            coalesce(max(qt_diferenca), 0),
                            coalesce(max(ie_permite_justif), 'S')
                    into STRICT    qt_existe_w,
                            pr_diferenca_w,
                            qt_diferenca_w,
                            ie_permite_justif_w
                    from    regra_diverg_oc_nf
                    where   cd_estabelecimento = cd_estabelecimento_w
                    and     coalesce(cd_local_estoque, cd_local_estoque_w) = cd_local_estoque_w
                    and     coalesce(cd_grupo_material, cd_grupo_material_w) = cd_grupo_material_w
                    and     coalesce(cd_subgrupo_material, cd_subgrupo_material_w) = cd_subgrupo_material_w
                    and     coalesce(cd_classe_material, cd_classe_material_w) = cd_classe_material_w
                    and     coalesce(cd_material, cd_material_w) = cd_material_w
                    and     ie_tipo_regra = '16'
                    and     coalesce(obter_se_restringe_div_oc_nf(nr_sequencia, cd_cgc_emitente_w), 'S') = 'S';

                    if (pr_diferenca_w > 0) then
                        qt_diferenca_w := round((dividir((vl_ipi_item_oc_w * pr_diferenca_w), 100))::numeric, 4);
                    end if;

                    if (qt_existe_w > 0) and (round((abs(vl_ipi_item_nf_w - vl_ipi_item_oc_w))::numeric, 4) <> qt_diferenca_w) then
                        begin
                            select  coalesce(max(nr_sequencia), 0)
                            into STRICT    nr_seq_divergencia_w
                            from    divergencia_ordem_compra_item
                            where   cd_tipo_divergencia = 16
                            and     ie_situacao = 'I'
                            and     nr_seq_nf = nr_sequencia_p
                            and     nr_item_nf = nr_item_nf_w
                            and     nr_ordem_compra = nr_ordem_compra_w
                            and     nr_item_doi_nfe = nr_item_oci_w;

                            if (nr_seq_divergencia_w > 0) then
                                update  divergencia_ordem_compra_item
                                set     ie_situacao = 'A'
                                where   nr_sequencia = nr_seq_divergencia_w;
                            else
                                select  coalesce(max(nr_sequencia), 0) + 1
                                into STRICT    nr_seq_divergencia_w
                                from    divergencia_ordem_compra_item;

                                insert into divergencia_ordem_compra_item(
                                    nr_ordem_compra,
                                    nr_item_doi_nfe,
                                    cd_tipo_divergencia,
                                    cd_estabelecimento,
                                    cd_cgc_emitente,
                                    cd_pessoa_fisica,
                                    cd_serie_nf,
                                    nr_nota_fiscal,
                                    nr_sequencia_nf,
                                    nr_item_nf,
                                    dt_atualizacao,
                                    nm_usuario,
                                    ds_observacao,
                                    nr_seq_nf,
                                    nr_sequencia,
                                    ie_situacao,
                                    ie_permite_justif,
                                    dt_prevista_entrega
                               ) values (
                                    nr_ordem_compra_w,
                                    nr_item_oci_w,
                                    16,
                                    cd_estabelecimento_w,
                                    cd_cgc_emitente_w,
                                    cd_pessoa_fisica_w,
                                    cd_serie_nf_w,
                                    nr_nota_fiscal_w,
                                    nr_sequencia_nf_w,
                                    nr_item_nf_w,
                                    clock_timestamp(),
                                    nm_usuario_p,
                                    null,
                                    nr_sequencia_p,
                                    nr_seq_divergencia_w,
                                    'A',
                                    ie_permite_justif_w,
                                    dt_entrega_ordem_w
                               );

                            end if;

                        end;

                        ie_divergencia_w := 'S';
                    end if;

                    if (ie_divergencia_w = 'S') and
                        ((ds_justificativa_w = '') or (coalesce(ds_justificativa_w::text, '') = '')) and (ie_diverg_oc_nf_w = 'S') then
                            
                        ds_retorno_p := substr(ds_retorno_p || nr_item_nf_w || ' - ', 1, 255);
                    end if;
                end;
            end loop;

            close c01;
            delete from divergencia_ordem_compra_item
            where
                ie_situacao = 'I'
                and nr_seq_nf = nr_sequencia_p;

            commit;
        exception
            when no_data_found then null;
            when too_many_rows then raise;
        end;
    end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_divergencia_nota_ordem ( nr_sequencia_p nota_fiscal_item.nr_sequencia%type, nm_usuario_p nota_fiscal_item.nm_usuario%type, ds_retorno_p INOUT text ) FROM PUBLIC;

