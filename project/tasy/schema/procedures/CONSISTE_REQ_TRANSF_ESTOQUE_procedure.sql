-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_req_transf_estoque (cd_local_estoque_p bigint, cd_material_p bigint, qt_material_p bigint, cd_unidade_medida_p text, nr_requisicao_p bigint, cd_estabelecimento_p bigint, ie_consiste_transferencia_p text, ie_erro_reduzido_p text, ds_erro_p INOUT text) AS $body$
DECLARE


qt_estoque_disp_w		double precision := 0;
qt_pendente_w		double precision := 0;
qt_estoque_max_w		double precision := 0;
qt_total_w		double precision := 0;
qt_material_w		double precision;
ds_erro_w		varchar(300);

cd_material_estoque_w	material.cd_material_estoque%type;


BEGIN

ds_erro_w := '';

begin
select	cd_material_estoque
into STRICT	cd_material_estoque_w
from	material
where	cd_material = cd_material_p;
exception
when others then
	cd_material_estoque_w	:=	cd_material_p;
end;

qt_estoque_max_w	:= coalesce(obter_regra_padrao_local(cd_material_estoque_w, cd_local_estoque_p, cd_estabelecimento_p, 'qt_max'),0);

if (qt_estoque_max_w > 0) then
	begin
	qt_material_w	:= obter_quantidade_convertida(cd_material_p, qt_material_p, cd_unidade_medida_p, 'UME');
	qt_estoque_disp_w	:= obter_saldo_disp_estoque(cd_estabelecimento_p, cd_material_p, cd_local_estoque_p, clock_timestamp());

	/*select 	nvl(sum(a.qt_estoque),0)
	into	qt_pendente_w
	from   	requisicao_material_pendente_v a,
		operacao_estoque b
	where  	a.cd_estabelecimento 		= cd_estabelecimento_p
	and	a.cd_local_estoque_destino 		= cd_local_estoque_p
	and	a.cd_operacao_estoque 		= b.cd_operacao_estoque
	and   	a.cd_material	 		= cd_material_p
	and	a.nr_requisicao			<> nr_requisicao_p
	and   	b.ie_tipo_requisicao 		= '2';

	Alterado pelo comando abaixo - Sidnei - OS 338450
	*/
	/*Alterado comando abaixo - Sidnei - OS 386264*/

	select 	coalesce(sum(b.qt_estoque),0)
	into STRICT	qt_pendente_w
	from	requisicao_material a,
		item_requisicao_material b,
		operacao_estoque o
	where	a.nr_requisicao	= b.nr_requisicao
	and	a.cd_operacao_estoque	= o.cd_operacao_estoque
	and	a.nr_requisicao		<> nr_requisicao_p
	and	a.cd_estabelecimento 	= cd_estabelecimento_p
	and	a.cd_local_estoque_destino 	= cd_local_estoque_p
	and	exists (	SELECT	1
			from	material x
			where	x.cd_material = b.cd_material
			and	x.cd_material_estoque = cd_material_estoque_w)
	and   	o.ie_tipo_requisicao in ('2','21')
	and	coalesce(b.cd_motivo_baixa,0) 	= 0
	and (ie_consiste_transferencia_p <> 'L' or (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''));

	qt_total_w := (qt_estoque_disp_w + qt_pendente_w + qt_material_w);

	if (qt_total_w > qt_estoque_max_w) then

		if (ie_erro_reduzido_p <> 'S') then
			/*Quantidade #@QT_MATERIAL#@, somando com o saldo de estoque (#@QT_ESTOQUE_DISP#@) e quantidade de requisição pendente (#@QT_PENDENTE#@) é maior que a quantidade máxima (#@QT_ESTOQUE_MAX#@) liberada para o local de estoque!*/

			ds_erro_w := 	wheb_mensagem_pck.get_texto(	298911,	'QT_MATERIAL=' || campo_mascara_virgula(qt_material_w) ||
										';QT_ESTOQUE_DISP=' || campo_mascara_virgula(qt_estoque_disp_w) ||
										';QT_PENDENTE=' || campo_mascara_virgula(qt_pendente_w) ||
										';QT_ESTOQUE_MAX=' || campo_mascara_virgula(qt_estoque_max_w));
		else
			/*Quantidade total (requisição, saldo, requisições pendentes) superou a quantidade máxima liberada para o local!*/

			ds_erro_w :=	wheb_mensagem_pck.get_texto(279508);
		end if;

	end if;

	end;
end if;

ds_erro_p	:= ds_erro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_req_transf_estoque (cd_local_estoque_p bigint, cd_material_p bigint, qt_material_p bigint, cd_unidade_medida_p text, nr_requisicao_p bigint, cd_estabelecimento_p bigint, ie_consiste_transferencia_p text, ie_erro_reduzido_p text, ds_erro_p INOUT text) FROM PUBLIC;

