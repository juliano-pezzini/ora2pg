-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desdobrar_procmat_repasse (nr_seq_proc_repasse_p bigint, nr_seq_mat_repasse_p bigint, ie_status_p text, vl_repasse_p bigint, nm_usuario_p text, nr_seq_proc_rep_novo_p INOUT bigint, nr_seq_mat_rep_novo_p INOUT bigint) AS $body$
DECLARE


/*	Tipo Liberacao
	A - Aguardando acao do usuario
	G - Glosado	*/
ie_status_w			varchar(01);
nr_seq_proc_rep_novo_w		bigint := null;
nr_seq_mat_rep_novo_w		bigint := null;
nr_interno_conta_w		bigint;
nr_seq_retorno_w			bigint;
nr_seq_retorno_nova_w		bigint;
dt_retorno_w			timestamp;
cont_w				bigint;
nr_seq_guia_w			bigint;
dt_atualizacao_retorno_w		timestamp;
dt_atualizacao_tit_w		timestamp;


BEGIN

if (nr_seq_proc_repasse_p IS NOT NULL AND nr_seq_proc_repasse_p::text <> '') and (nr_seq_proc_repasse_p > 0) then
	begin


	-- o select abaixo eh para o caso de estar sendo desdobrado atraves da nova rotina . dsantos em 29/08/2011
	select	max(c.nr_seq_retorno)
	into STRICT	nr_seq_retorno_nova_w
	from	convenio_retorno_item c,
		convenio_retorno_glosa b,
		procedimento_repasse a
	where	b.nr_seq_propaci	= a.nr_seq_procedimento
	and	b.nr_seq_ret_item	= c.nr_sequencia
	and	a.nr_sequencia	= nr_seq_proc_repasse_p;

	select	max(c.nr_seq_retorno)
	into STRICT	nr_seq_retorno_w
	from	convenio_retorno_item c,
		convenio_retorno_glosa b,
		procedimento_repasse a
	where	c.nr_sequencia	= b.nr_seq_ret_item
	and	b.nr_sequencia	= a.nr_seq_ret_glosa
	and	a.nr_sequencia	= nr_seq_proc_repasse_p;


	if ((nr_seq_retorno_w IS NOT NULL AND nr_seq_retorno_w::text <> '') or (nr_seq_retorno_nova_w IS NOT NULL AND nr_seq_retorno_nova_w::text <> '')) then -- nr_seq_retorno_nova_w trata-se da liberacao na nova rotina.
		select	max(dt_retorno),
			max(dt_atualizacao)
		into STRICT	dt_retorno_w,
			dt_atualizacao_retorno_w
		from (
			SELECT	CASE WHEN b.ie_data_lib_repasse_ret='F' THEN coalesce(a.dt_baixa_cr, a.dt_fechamento) WHEN b.ie_data_lib_repasse_ret='R' THEN a.dt_retorno WHEN b.ie_data_lib_repasse_ret='E' THEN  a.dt_fechamento END  dt_retorno,
				a.dt_atualizacao
			from	parametro_faturamento b,
				convenio_retorno a
			where	a.nr_sequencia		= nr_seq_retorno_w
			and	a.cd_estabelecimento	= b.cd_estabelecimento
			
union

			SELECT	CASE WHEN b.ie_data_lib_repasse_ret='F' THEN coalesce(a.dt_baixa_cr, a.dt_fechamento) WHEN b.ie_data_lib_repasse_ret='R' THEN a.dt_retorno WHEN b.ie_data_lib_repasse_ret='E' THEN  a.dt_fechamento END ,
				a.dt_atualizacao
			from	parametro_faturamento b,
				convenio_retorno a
			where	a.nr_sequencia		= nr_seq_retorno_nova_w
			and	a.cd_estabelecimento	= b.cd_estabelecimento
			) alias7;

	end if;

	select	count(*),
		max(a.nr_Seq_guia)
	into STRICT	cont_w,
		nr_seq_guia_w
	from	lote_audit_hist_item a,
		procedimento_repasse b
	where	b.nr_seq_procedimento	= a.nr_seq_propaci
	and	b.nr_sequencia		= nr_seq_proc_repasse_p;

	if (cont_w > 0) and (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') then

		select	max(dt_atualizacao)
		into STRICT	dt_atualizacao_tit_w
		from	titulo_receber_liq
		where	NR_SEQ_LOTE_HIST_GUIA	= nr_seq_guia_w;


		if (coalesce(dt_atualizacao_retorno_w::text, '') = '') or (dt_atualizacao_tit_w > dt_atualizacao_retorno_w) then

			select	max(dt_recebimento)
			into STRICT	dt_retorno_w
			from	titulo_receber_liq
			where	NR_SEQ_LOTE_HIST_GUIA	= nr_seq_guia_w;
		end if;

	end if;


	select	nextval('procedimento_repasse_seq')
	into STRICT	nr_seq_proc_rep_novo_w
	;

	insert into procedimento_repasse(	NR_SEQUENCIA,
					NR_SEQ_PROCEDIMENTO,
					VL_REPASSE,
					DT_ATUALIZACAO,
					NM_USUARIO,
					NR_SEQ_TERCEIRO,
					NR_LOTE_CONTABIL,
					NR_REPASSE_TERCEIRO,
					CD_CONTA_CONTABIL,
					NR_SEQ_TRANS_FIN,
					VL_LIBERADO,
					NR_SEQ_ITEM_RETORNO,
					IE_STATUS,
					NR_SEQ_ORIGEM,
					CD_REGRA,
					DT_LIBERACAO,
					CD_MEDICO,
					dt_contabil_titulo,
					dt_contabil,
					nr_seq_partic,
					NR_SEQ_TRANS_FIN_REP_MAIOR,
					NR_SEQ_CRITERIO,
					VL_ORIGINAL_REPASSE,
                                        NR_SEQ_RET_GLOSA,
                                        DT_ATUALIZACAO_NREC,
                                        NM_USUARIO_NREC,
                                        DS_OBSERVACAO,
                                        NR_PROCESSO_AIH,
                                        NM_USUARIO_LIB,
                                        NR_INTERNO_CONTA_EST,
                                        IE_ESTORNO,
                                        IE_REPASSE_CALC,
                                        NR_SEQ_REGRA_ITEM,
                                        IE_ANALISADO,
                                        NR_SEQ_LOTE_AUDIT_HIST,
                                        NR_SEQ_MOTIVO_DES,
                                        IE_DESC_CAIXA,
                                        VL_DESP_CARTAO,
                                        NR_SEQ_PARCELA,
                                        VL_CUSTO_ITEM,
                                        VL_DESCONTO,
                                        NR_ATENDIMENTO,
                                        NM_PESSOA_FISICA,
                                        DS_PROCEDIMENTO,
                                        DS_STATUS,
                                        NM_MEDICO,
                                        NM_MEDICO_EXECUTOR,
                                        DS_TRANSACAO,
                                        DS_CONVENIO,
                                        DS_REGRA,
                                        DT_PROCEDIMENTO,
                                        DS_TIPO_ATENDIMENTO,
                                        DT_MESANO_REFERENCIA,
                                        CD_PROCEDIMENTO,
                                        NR_INTERNO_CONTA,
                                        DS_CENTRO_CUSTO,
                                        NM_USUARIO_ORIGINAL,
                                        DT_ENTRADA_ATEND,
                                        DS_CONTA_CONTABIL,
                                        DS_OBS_FORMA_REPASSE,
                                        --DS_SETOR_ATENDIMENTO,
                                        DS_FUNCAO_MED,
                                        NM_MEDICO_REQ,
                                        DS_OBSERVACAO_CRITERIO,
                                        DS_CATEGORIA,
                                        NR_PRESCRICAO,
                                        DS_VIA_ACESSO,
                                        DS_MEDICO_RESP,
                                        DS_CARATER,
                                        DS_MEDICO_LAUDO,
                                        QT_PROCEDIMENTO,
                                        IE_ORIGEM_PROCED,
                                        CD_PESSOA_FISICA,
                                        NR_SEQ_PROC_CRIT_REPASSE,
                                        CD_CONVENIO,
                                        IE_TIPO_CONVENIO,
                                        IE_TIPO_ATENDIMENTO,
                                        CD_MEDICO_LAUDO,
                                        DS_CLASSIF_ATUA_MEDICO,
                                        NR_LAUDO,
                                        IE_BLOQ_LAUDO_LIBERADO,
                                        VL_CUSTO,
                                        VL_IMPOSTO,
                                        DT_ENTREGA_CONVENIO,
                                        DS_TIPO_CONV,
                                        IE_ALTA_COMPLEXIDADE,
                                        DS_LOG,
                                        NR_CODIGO_CONTROLE)
	SELECT	nr_seq_proc_rep_novo_w,
		a.nr_seq_procedimento,
		vl_repasse_p,
		clock_timestamp(),
		nm_usuario_p,
		a.nr_seq_terceiro,
		a.nr_lote_contabil,
		null,
		null,
		a.nr_seq_trans_fin,
		0,
		null,
		coalesce(ie_status_p,'A'),
		a.nr_sequencia,
		a.cd_regra,
		CASE WHEN ie_status_p='G' THEN  coalesce(dt_retorno_w, clock_timestamp())  ELSE null END ,
		a.cd_medico,
		a.dt_contabil_titulo,
		a.dt_contabil,
		a.nr_seq_partic,
		a.nr_seq_trans_fin_rep_maior,
		a.nr_seq_criterio,
		a.vl_original_repasse,
                a.NR_SEQ_RET_GLOSA,
                clock_timestamp(),
                nm_usuario_p,
                a.DS_OBSERVACAO,
                a.NR_PROCESSO_AIH,
                a.NM_USUARIO_LIB,
                a.NR_INTERNO_CONTA_EST,
                a.IE_ESTORNO,
                a.IE_REPASSE_CALC,
                a.NR_SEQ_REGRA_ITEM,
                a.IE_ANALISADO,
                a.NR_SEQ_LOTE_AUDIT_HIST,
                a.NR_SEQ_MOTIVO_DES,
                a.IE_DESC_CAIXA,
                a.VL_DESP_CARTAO,
                a.NR_SEQ_PARCELA,
                a.VL_CUSTO_ITEM,
                a.VL_DESCONTO,
                a.NR_ATENDIMENTO,
                a.NM_PESSOA_FISICA,
                a.DS_PROCEDIMENTO,
                a.DS_STATUS,
                a.NM_MEDICO,
                a.NM_MEDICO_EXECUTOR,
                a.DS_TRANSACAO,
                a.DS_CONVENIO,
                a.DS_REGRA,
                a.DT_PROCEDIMENTO,
                a.DS_TIPO_ATENDIMENTO,
                a.DT_MESANO_REFERENCIA,
                a.CD_PROCEDIMENTO,
                a.NR_INTERNO_CONTA,
                a.DS_CENTRO_CUSTO,
                a.NM_USUARIO_ORIGINAL,
                a.DT_ENTRADA_ATEND,
                a.DS_CONTA_CONTABIL,
                a.DS_OBS_FORMA_REPASSE,
                --a.DS_SETOR_ATENDIMENTO,
                a.DS_FUNCAO_MED,
                a.NM_MEDICO_REQ,
                a.DS_OBSERVACAO_CRITERIO,
                a.DS_CATEGORIA,
                a.NR_PRESCRICAO,
                a.DS_VIA_ACESSO,
                a.DS_MEDICO_RESP,
                a.DS_CARATER,
                a.DS_MEDICO_LAUDO,
                a.QT_PROCEDIMENTO,
                a.IE_ORIGEM_PROCED,
                a.CD_PESSOA_FISICA,
                a.NR_SEQ_PROC_CRIT_REPASSE,
                a.CD_CONVENIO,
                a.IE_TIPO_CONVENIO,
                a.IE_TIPO_ATENDIMENTO,
                a.CD_MEDICO_LAUDO,
                a.DS_CLASSIF_ATUA_MEDICO,
                a.NR_LAUDO,
                a.IE_BLOQ_LAUDO_LIBERADO,
                a.VL_CUSTO,
                a.VL_IMPOSTO,
                a.DT_ENTREGA_CONVENIO,
                a.DS_TIPO_CONV,
                a.IE_ALTA_COMPLEXIDADE,
                a.DS_LOG,
                a.NR_CODIGO_CONTROLE
	from	procedimento_repasse a
	where	nr_sequencia = nr_seq_proc_repasse_p;
	exception
		when unique_violation then
			---20011, 'Erro Desdobrar_ProcMat_Repasse! ' || SQLERRM;
			CALL wheb_mensagem_pck.exibir_mensagem_abort(194264, 'SQLERRM_P='||SQLERRM);
	end;

	select	max(a.nr_interno_conta)
	into STRICT	nr_interno_conta_w
	from	procedimento_paciente a,
		procedimento_repasse b
	where	a.nr_sequencia	= b.nr_seq_procedimento
	and 	b.nr_sequencia	= nr_seq_proc_repasse_p;

	if (nr_interno_conta_w IS NOT NULL AND nr_interno_conta_w::text <> '') then
		CALL gerar_procmat_repasse_nf(nr_interno_conta_w, nm_usuario_p, 'N');
	end if;

elsif (nr_seq_mat_repasse_p IS NOT NULL AND nr_seq_mat_repasse_p::text <> '') and (nr_seq_mat_repasse_p > 0) then

	select	max(c.nr_seq_retorno)
	into STRICT	nr_seq_retorno_w
	from	convenio_retorno_item c,
		convenio_retorno_glosa b,
		material_repasse a
	where	c.nr_sequencia	= b.nr_seq_ret_item
	and	b.nr_sequencia	= a.nr_seq_ret_glosa
	and	a.nr_sequencia	= nr_seq_mat_repasse_p;

	if (nr_seq_retorno_w IS NOT NULL AND nr_seq_retorno_w::text <> '') then

		select	CASE WHEN b.ie_data_lib_repasse_ret='F' THEN coalesce(a.dt_baixa_cr, a.dt_fechamento) WHEN b.ie_data_lib_repasse_ret='R' THEN a.dt_retorno WHEN b.ie_data_lib_repasse_ret='E' THEN  a.dt_fechamento END
		into STRICT	dt_retorno_w
		from	parametro_faturamento b,
			convenio_retorno a
		where	a.nr_sequencia		= nr_seq_retorno_w
		and	a.cd_estabelecimento	= b.cd_estabelecimento;

	end if;

	select	nextval('material_repasse_seq')
	into STRICT	nr_seq_mat_rep_novo_w
	;

	insert into material_repasse(	NR_SEQUENCIA,
                                        NR_SEQ_MATERIAL,
                                        VL_REPASSE,
                                        DT_ATUALIZACAO,
                                        NM_USUARIO,
                                        NR_SEQ_TERCEIRO,
                                        NR_LOTE_CONTABIL,
                                        NR_REPASSE_TERCEIRO,
                                        CD_CONTA_CONTABIL,
                                        NR_SEQ_TRANS_FIN,
                                        VL_LIBERADO,
                                        NR_SEQ_ITEM_RETORNO,
                                        IE_STATUS,
                                        NR_SEQ_ORIGEM,
                                        CD_REGRA,
                                        DT_LIBERACAO,
                                        CD_MEDICO,
                                        dt_contabil_titulo,
                                        dt_contabil,
                                        nr_seq_trans_fin_rep_maior,
                                        nr_seq_criterio,
                                        vl_original_repasse,
                                        NR_SEQ_RET_GLOSA,
                                        DT_ATUALIZACAO_NREC,
                                        NM_USUARIO_NREC,
                                        DS_OBSERVACAO,
                                        NM_USUARIO_LIB,
                                        NR_INTERNO_CONTA_EST,
                                        IE_ESTORNO,
                                        IE_REPASSE_CALC,
                                        NR_SEQ_REGRA_ITEM,
                                        IE_ANALISADO,
                                        NR_SEQ_MOTIVO_DES,
                                        IE_DESC_CAIXA,
                                        NR_SEQ_LOTE_AUDIT_HIST,
                                        VL_DESP_CARTAO,
                                        NR_SEQ_PARCELA,
                                        VL_CUSTO_ITEM,
                                        VL_DESCONTO,
                                        DS_REGRA,
                                        CD_MATERIAL,
                                        DS_MATERIAL,
                                        NR_ATENDIMENTO,
                                        CD_PESSOA_FISICA,
                                        NM_PESSOA_FISICA,
                                        DS_STATUS,
                                        DS_TRANSACAO,
                                        DS_CONVENIO,
                                        NM_MEDICO,
                                        NR_INTERNO_CONTA,
                                        DT_CONTA,
                                        DS_TIPO_ATENDIMENTO,
                                        DS_CENTRO_CUSTO,
                                        NM_USUARIO_ORIGINAL,
                                        DS_OBSERVACAO_CRITERIO,
                                        DS_CATEGORIA,
                                        NR_PRESCRICAO,
                                        DS_CLASSIF_ATUA_MEDICO,
                                        DT_ENTRADA,
                                        CD_CONVENIO,
                                        IE_TIPO_CONVENIO,
                                        IE_TIPO_ATENDIMENTO,
                                        CD_SETOR_ATENDIMENTO,
                                        QT_MATERIAL,
                                        CD_MOTIVO_EXC_CONTA,
                                        CD_PROTOCOLO,
                                        NR_CICLO,
                                        VL_CUSTO,
                                        VL_IMPOSTO,
                                        NR_SEQ_MEDICACAO,
                                        DT_ENTREGA_CONVENIO,
                                        DS_TIPO_CONV,
                                        DS_CLINICA,
                                        CD_UNIDADE_BASICA,
                                        NM_MEDICO_REFERIDO,
                                        NR_ATENDIMENTO_MAE,
                                        DS_LOG,
                                        --DS_SETOR_ATENDIMENTO,
                                        NR_CODIGO_CONTROLE)
	SELECT	nr_seq_mat_rep_novo_w,
		a.nr_seq_material,
		vl_repasse_p,
		clock_timestamp(),
		nm_usuario_p,
		a.nr_seq_terceiro,
		a.nr_lote_contabil,
		null,
		null,
		a.nr_seq_trans_fin,
		0,
		null,
		coalesce(ie_status_p,'A'),
		a.nr_sequencia,
		a.cd_regra,
		CASE WHEN ie_status_p='G' THEN  coalesce(dt_retorno_w, clock_timestamp())  ELSE null END ,
		a.cd_medico,
		a.dt_contabil_titulo,
		a.dt_contabil,
		a.nr_seq_trans_fin_rep_maior,
		a.nr_seq_criterio,
		a.vl_original_repasse,
                a.NR_SEQ_RET_GLOSA,
                clock_timestamp(),
                nm_usuario_p,
                a.DS_OBSERVACAO,
                a.NM_USUARIO_LIB,
                a.NR_INTERNO_CONTA_EST,
                a.IE_ESTORNO,
                a.IE_REPASSE_CALC,
                a.NR_SEQ_REGRA_ITEM,
                a.IE_ANALISADO,
                a.NR_SEQ_MOTIVO_DES,
                a.IE_DESC_CAIXA,
                a.NR_SEQ_LOTE_AUDIT_HIST,
                a.VL_DESP_CARTAO,
                a.NR_SEQ_PARCELA,
                a.VL_CUSTO_ITEM,
                a.VL_DESCONTO,
                a.DS_REGRA,
                a.CD_MATERIAL,
                a.DS_MATERIAL,
                a.NR_ATENDIMENTO,
                a.CD_PESSOA_FISICA,
                a.NM_PESSOA_FISICA,
                a.DS_STATUS,
                a.DS_TRANSACAO,
                a.DS_CONVENIO,
                a.NM_MEDICO,
                a.NR_INTERNO_CONTA,
                a.DT_CONTA,
                a.DS_TIPO_ATENDIMENTO,
                a.DS_CENTRO_CUSTO,
                a.NM_USUARIO_ORIGINAL,
                a.DS_OBSERVACAO_CRITERIO,
                a.DS_CATEGORIA,
                a.NR_PRESCRICAO,
                a.DS_CLASSIF_ATUA_MEDICO,
                a.DT_ENTRADA,
                a.CD_CONVENIO,
                a.IE_TIPO_CONVENIO,
                a.IE_TIPO_ATENDIMENTO,
                a.CD_SETOR_ATENDIMENTO,
                a.QT_MATERIAL,
                a.CD_MOTIVO_EXC_CONTA,
                a.CD_PROTOCOLO,
                a.NR_CICLO,
                a.VL_CUSTO,
                a.VL_IMPOSTO,
                a.NR_SEQ_MEDICACAO,
                a.DT_ENTREGA_CONVENIO,
                a.DS_TIPO_CONV,
                a.DS_CLINICA,
                a.CD_UNIDADE_BASICA,
                a.NM_MEDICO_REFERIDO,
                a.NR_ATENDIMENTO_MAE,
                a.DS_LOG,
                --a.DS_SETOR_ATENDIMENTO,
                a.NR_CODIGO_CONTROLE
	from material_repasse a
	where nr_sequencia = nr_seq_mat_repasse_p;

	select	max(a.nr_interno_conta)
	into STRICT	nr_interno_conta_w
	from	material_atend_paciente a,
		material_repasse b
	where	a.nr_sequencia	= b.nr_seq_material
	and	b.nr_sequencia	= nr_seq_mat_repasse_p;

	if (nr_interno_conta_w IS NOT NULL AND nr_interno_conta_w::text <> '') then
		CALL gerar_procmat_repasse_nf(nr_interno_conta_w, nm_usuario_p, 'N');
	end if;

end if;

nr_seq_proc_rep_novo_p		:= nr_seq_proc_rep_novo_w;
nr_seq_mat_rep_novo_p		:= nr_seq_mat_rep_novo_w;

--commit; Bruna OS79739 comentado o commit
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desdobrar_procmat_repasse (nr_seq_proc_repasse_p bigint, nr_seq_mat_repasse_p bigint, ie_status_p text, vl_repasse_p bigint, nm_usuario_p text, nr_seq_proc_rep_novo_p INOUT bigint, nr_seq_mat_rep_novo_p INOUT bigint) FROM PUBLIC;

