-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_dados_obst_nascimento ( cd_pessoa_fisica_p text, nm_tabela_p text, ds_campo_p text, nr_atendimento_p bigint default null, ds_resultado_p INOUT text DEFAULT NULL) AS $body$
DECLARE

			 
			 
nr_atendimento_w	bigint;


BEGIN 
 
begin 
 
if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') and (nm_tabela_p IS NOT NULL AND nm_tabela_p::text <> '') and (ds_campo_p IS NOT NULL AND ds_campo_p::text <> '') then	 
	 
	If (nr_atendimento_p > 0) then 
	 
		select coalesce(nr_atendimento_mae,nr_atendimento_p) 
		into STRICT	nr_atendimento_w 
		from	atendimento_paciente 
		where	nr_atendimento = nr_atendimento_p;
	 
		if (upper(nm_tabela_p) = 'ATENDIMENTO_GRAVIDEZ') then 
	 
			if ( upper(ds_campo_p) = 'DUM') then 
				 
				select	max(a.dt_ultima_menstruacao) 
				into STRICT	ds_resultado_p 
				from	atendimento_gravidez a 
				where  a.nr_sequencia = (SELECT max(b.nr_sequencia) 
							 from 	atendimento_gravidez b, 
								atendimento_paciente c 
							where  (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') 
							and   coalesce(b.dt_inativacao::text, '') = '' 
							and   b.dt_liberacao >= (clock_timestamp() - interval '308 days') 
							and   b.nr_atendimento = c.nr_atendimento 
							and   c.cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_w,'C'));
			 
			elsif ( upper(ds_campo_p) = 'IG_SEM') then 
 
				select	max(a.QT_IG_SEM_US) 
				into STRICT	ds_resultado_p 
				from	atendimento_gravidez a 
				where  a.nr_sequencia = (SELECT max(b.nr_sequencia) 
							 from 	atendimento_gravidez b, 
								atendimento_paciente c 
							where  (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') 
							and   coalesce(b.dt_inativacao::text, '') = '' 
							and   b.dt_liberacao >= (clock_timestamp() - interval '308 days') 
							and   b.nr_atendimento = c.nr_atendimento 
							and   c.cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_w,'C'));
							 
			elsif ( upper(ds_campo_p) = 'IG_DIA') then 
 
				select	max(a.QT_IG_DIA_US) 
				into STRICT	ds_resultado_p 
				from	atendimento_gravidez a 
				where  a.nr_sequencia = (SELECT max(b.nr_sequencia) 
							 from 	atendimento_gravidez b, 
								atendimento_paciente c 
							where  (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') 
							and   coalesce(b.dt_inativacao::text, '') = '' 
							and   b.dt_liberacao >= (clock_timestamp() - interval '308 days') 
							and   b.nr_atendimento = c.nr_atendimento 
							and   c.cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_w,'C'));
							 
			elsif ( upper(ds_campo_p) = 'DT_AVALIACAO') then 
 
				select	max(trunc(a.DT_AVALIACAO)) 
				into STRICT	ds_resultado_p 
				from	atendimento_gravidez a 
				where  a.nr_sequencia = (SELECT max(b.nr_sequencia) 
							 from 	atendimento_gravidez b, 
								atendimento_paciente c 
							where  (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') 
							and   coalesce(b.dt_inativacao::text, '') = '' 
							and   b.dt_liberacao >= (clock_timestamp() - interval '308 days') 
							and   b.nr_atendimento = c.nr_atendimento 
							and   c.cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_w,'C'));	
			 
			end if;	
	 
		elsif (upper(nm_tabela_p) = 'MED_PAC_PRE_NATAL') then 
		 
			if ( upper(ds_campo_p) = 'IGSU') then 
				 
				select	max(a.QT_IG_SEM_US) 
				into STRICT	ds_resultado_p 
				from	med_pac_pre_natal a 
				where  a.nr_sequencia = (SELECT max(b.nr_sequencia) 
							 from 	med_pac_pre_natal b, 
								atendimento_paciente c 
							where  (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') 
							and   coalesce(b.dt_inativacao::text, '') = '' 
							and   b.dt_liberacao >= (clock_timestamp() - interval '308 days') 
							and   b.nr_atendimento = c.nr_atendimento 
							and   c.cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_w,'C'));
			 
			elsif ( upper(ds_campo_p) = 'IGDU') then 
			 
				select	max(a.QT_IG_DIA_US) 
				into STRICT	ds_resultado_p 
				from	med_pac_pre_natal a 
				where  a.nr_sequencia = (SELECT max(b.nr_sequencia) 
							 from 	med_pac_pre_natal b, 
								atendimento_paciente c 
							where  (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') 
							and   coalesce(b.dt_inativacao::text, '') = '' 
							and   b.dt_liberacao >= (clock_timestamp() - interval '308 days') 
							and   b.nr_atendimento = c.nr_atendimento 
							and   c.cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_w,'C'));
			 
			elsif ( upper(ds_campo_p) = 'TIPSANGMAE') then 
			 
				select	max(a.IE_TIPO_SANGUINEO) 
				into STRICT	ds_resultado_p 
				from	med_pac_pre_natal a 
				where  a.nr_sequencia = (SELECT max(b.nr_sequencia) 
							 from 	med_pac_pre_natal b, 
								atendimento_paciente c 
							where  (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') 
							and   coalesce(b.dt_inativacao::text, '') = '' 
							and   b.dt_liberacao >= (clock_timestamp() - interval '308 days') 
							and   b.nr_atendimento = c.nr_atendimento 
							and   c.cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_w,'C'));
				 
			elsif ( upper(ds_campo_p) = 'FATRHMAE') then 
			 
				select	max(a.IE_FATOR_RH) 
				into STRICT	ds_resultado_p 
				from	med_pac_pre_natal a 
				where  a.nr_sequencia = (SELECT max(b.nr_sequencia) 
							 from 	med_pac_pre_natal b, 
								atendimento_paciente c 
							where  (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') 
							and   coalesce(b.dt_inativacao::text, '') = '' 
							and   b.dt_liberacao >= (clock_timestamp() - interval '308 days') 
							and   b.nr_atendimento = c.nr_atendimento 
							and   c.cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_w,'C'));
				 
			elsif ( upper(ds_campo_p) = 'TIPSANGPAI') then 
			 
				select	max(a.IE_TIPO_SANGUINEO_PAI) 
				into STRICT	ds_resultado_p 
				from	med_pac_pre_natal a 
				where  a.nr_sequencia = (SELECT max(b.nr_sequencia) 
							 from 	med_pac_pre_natal b, 
								atendimento_paciente c 
							where  (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') 
							and   coalesce(b.dt_inativacao::text, '') = '' 
							and   b.dt_liberacao >= (clock_timestamp() - interval '308 days') 
							and   b.nr_atendimento = c.nr_atendimento 
							and   c.cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_w,'C'));
				 
			elsif ( upper(ds_campo_p) = 'FATRHPAI') then 
			 
				select	max(a.IE_FATOR_RH_PAI) 
				into STRICT	ds_resultado_p 
				from	med_pac_pre_natal a 
				where  a.nr_sequencia = (SELECT max(b.nr_sequencia) 
							 from 	med_pac_pre_natal b, 
								atendimento_paciente c 
							where  (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') 
							and   coalesce(b.dt_inativacao::text, '') = '' 
							and   b.dt_liberacao >= (clock_timestamp() - interval '308 days') 
							and   b.nr_atendimento = c.nr_atendimento 
							and   c.cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_w,'C'));		
			 
			elsif ( upper(ds_campo_p) = 'IGSEMANA') then 
			 
				select	max(a.QT_IG_SEMANA) 
				into STRICT	ds_resultado_p 
				from	med_pac_pre_natal a 
				where  a.nr_sequencia = (SELECT max(b.nr_sequencia) 
							 from 	med_pac_pre_natal b, 
								atendimento_paciente c 
							where  (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') 
							and   coalesce(b.dt_inativacao::text, '') = '' 
							and   b.dt_liberacao >= (clock_timestamp() - interval '308 days') 
							and   b.nr_atendimento = c.nr_atendimento 
							and   c.cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_w,'C'));
				 
			elsif ( upper(ds_campo_p) = 'IGDIA') then 
			 
				select	max(a.QT_IG_DIA) 
				into STRICT	ds_resultado_p 
				from	med_pac_pre_natal a 
				where  a.nr_sequencia = (SELECT max(b.nr_sequencia) 
							 from 	med_pac_pre_natal b, 
								atendimento_paciente c 
							where  (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') 
							and   coalesce(b.dt_inativacao::text, '') = '' 
							and   b.dt_liberacao >= (clock_timestamp() - interval '308 days') 
							and   b.nr_atendimento = c.nr_atendimento 
							and   c.cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_w,'C'));
				 
			elsif ( upper(ds_campo_p) = 'PARTOUS') then 
			 
				select	max(a.DT_PROV_PARTO_US) 
				into STRICT	ds_resultado_p 
				from	med_pac_pre_natal a 
				where  a.nr_sequencia = (SELECT max(b.nr_sequencia) 
							 from 	med_pac_pre_natal b, 
								atendimento_paciente c 
							where  (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') 
							and   coalesce(b.dt_inativacao::text, '') = '' 
							and   b.dt_liberacao >= (clock_timestamp() - interval '308 days') 
							and   b.nr_atendimento = c.nr_atendimento 
							and   c.cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_w,'C'));		
			 
			end if;
 
		elsif (upper(nm_tabela_p) = 'MED_PAC_PRE_NATAL_EVOL') then 
 
			if ( upper(ds_campo_p) = 'IGSEM') then 
				 
				select	max(a.QT_IG_SEM) 
				into STRICT	ds_resultado_p 
				from	med_pac_pre_natal_evol a 
				 where a.nr_sequencia = (SELECT  max(b.nr_sequencia) 
							from 	med_pac_pre_natal_evol b,  
								atendimento_paciente c, 
								med_pac_pre_natal d 
							where  (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') 
							and   coalesce(b.dt_inativacao::text, '') = '' 
							and	 b.nr_seq_pre_natal = d.nr_sequencia 
							and   b.dt_liberacao >= (clock_timestamp() - interval '308 days') 
							and   d.nr_atendimento = c.nr_atendimento 
							and   c.cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_w,'C'));
			 
			elsif ( upper(ds_campo_p) = 'FETO') then 
			 
				select	max(a.NR_FETO ) 
				into STRICT	ds_resultado_p 
				from	med_pac_pre_natal_evol a 
				where a.nr_sequencia = (SELECT  max(b.nr_sequencia) 
							from 	med_pac_pre_natal_evol b,  
								atendimento_paciente c, 
								med_pac_pre_natal d 
							where  (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') 
							and   coalesce(b.dt_inativacao::text, '') = '' 
							and	 b.nr_seq_pre_natal = d.nr_sequencia 
							and   b.dt_liberacao >= (clock_timestamp() - interval '308 days') 
							and   d.nr_atendimento = c.nr_atendimento 
							and   c.cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_w,'C'));
				 
			end if;
		 
		end if;	
	 
	end if;
end if;
exception 
	when others then 
	ds_resultado_p := null;
	 
end;
 
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_dados_obst_nascimento ( cd_pessoa_fisica_p text, nm_tabela_p text, ds_campo_p text, nr_atendimento_p bigint default null, ds_resultado_p INOUT text DEFAULT NULL) FROM PUBLIC;

