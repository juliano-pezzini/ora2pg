-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_guia_item_lib_auditoria ( nr_sequencia_p bigint, ie_tipo_item_p bigint, nr_seq_motivo_lib_p bigint, ds_observacao_p text, ie_status_p text, nm_usuario_p text) AS $body$
DECLARE


/*	IE_TIPO_ITEM_P
	1 - Procedimento
	2 - Material
*/
nr_seq_guia_w			bigint;
nr_seq_guia_proc_w		bigint;
nr_seq_guia_mat_w		bigint;
qt_autorizada_w			pls_guia_plano_proc.qt_autorizada%type;
qt_total_negado_w		bigint;
qt_total_autorizado_w		bigint;
qt_total_auditoria_w		bigint;
qt_glosa_guia_w			bigint;
ie_status_w			pls_guia_plano.ie_status%type;
nr_seq_prestador_web_w		pls_guia_plano.nr_seq_prestador_web%type;
nr_seq_perfil_web_w		pls_perfil_web.nr_sequencia%type;
ie_origem_solic_w		pls_guia_plano.ie_origem_solic%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;


BEGIN

if (ie_tipo_item_p	= 1) then
	nr_seq_guia_proc_w := nr_sequencia_p;

	select	nr_seq_guia
	into STRICT	nr_seq_guia_w
	from	pls_guia_plano_proc
	where	nr_sequencia	= nr_sequencia_p;
	
	if (ie_status_p = 'P') then
		select	CASE WHEN qt_autorizada=0 THEN qt_solicitada  ELSE qt_autorizada END
		into STRICT	qt_autorizada_w
		from	pls_guia_plano_proc
		where	nr_sequencia	= nr_sequencia_p;
	else
		qt_autorizada_w := 0;
	end if;

	update	pls_guia_plano_proc
	set   	dt_atualizacao		= clock_timestamp(),
		nm_usuario		= nm_usuario_p,
		ie_status		= ie_status_p,
		qt_autorizada 		= qt_autorizada_w,
		dt_liberacao		= clock_timestamp(),
		nm_usuario_liberacao	= nm_usuario_p
	where	nr_sequencia		= nr_sequencia_p;
	
elsif (ie_tipo_item_p	= 2) then
	nr_seq_guia_mat_w		:= nr_sequencia_p;
	
	select	nr_seq_guia
	into STRICT	nr_seq_guia_w
	from	pls_guia_plano_mat
	where	nr_sequencia		= nr_sequencia_p;
	
	if (ie_status_p = 'P') then
		select	CASE WHEN qt_autorizada=0 THEN qt_solicitada  ELSE qt_autorizada END
		into STRICT	qt_autorizada_w
		from	pls_guia_plano_mat
		where	nr_sequencia	= nr_sequencia_p;
	else
		qt_autorizada_w := 0;
	end if;

	update	pls_guia_plano_mat
	set   	dt_atualizacao		= clock_timestamp(),
		nm_usuario		= nm_usuario_p,
		ie_status		= ie_status_p,
		qt_autorizada		= qt_autorizada_w,
		dt_liberacao		= clock_timestamp(),
		nm_usuario_liberacao	= nm_usuario_p
	where	nr_sequencia		= nr_sequencia_p;
end if;

nr_seq_guia_w := coalesce(nr_seq_guia_w,0);

begin
	select	nr_seq_prestador_web,
		coalesce(ie_origem_solic, 'X'),
		cd_estabelecimento
	into STRICT	nr_seq_prestador_web_w,
		ie_origem_solic_w,
		cd_estabelecimento_w
	from	pls_guia_plano
	where	nr_sequencia	= nr_seq_guia_w;
exception
when others then
	nr_seq_prestador_web_w	:= null;
end;

insert into pls_guia_motivo_lib(nr_sequencia, dt_atualizacao, nm_usuario,
	dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_motivo,
	nr_seq_guia, ds_observacao, nm_usuario_liberacao, 
	dt_liberacao, nr_seq_guia_proc, nr_seq_guia_mat, 
	ie_auditoria)
values (nextval('pls_guia_motivo_lib_seq'), clock_timestamp(), nm_usuario_p,
	clock_timestamp(), nm_usuario_p, nr_seq_motivo_lib_p,
	nr_seq_guia_w, ds_observacao_p, nm_usuario_p,
	clock_timestamp(), nr_seq_guia_proc_w, nr_seq_guia_mat_w,
	ie_status_p);
	
if (ie_status_p  = 'M') then
	if (ie_origem_solic_w = 'E') then
		CALL pls_gravar_motivo_glosa('1426', null, nr_seq_guia_proc_w, nr_seq_guia_mat_w,
					ds_observacao_p,
					nm_usuario_p, '', 'IG', null, '', null);
	else
		insert into pls_guia_glosa(nr_sequencia, dt_atualizacao, nm_usuario,
			dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_guia,
			nr_seq_guia_proc, nr_seq_guia_mat, nr_seq_motivo_glosa,
			ds_observacao, ie_origem)
		values (nextval('pls_guia_glosa_seq'), clock_timestamp(), nm_usuario_p,
			clock_timestamp(), nm_usuario_p, null,
			nr_seq_guia_proc_w, nr_seq_guia_mat_w, 566,
			ds_observacao_p, '');
	end if;
end if;

if (obter_valor_param_usuario(1204, 97, Obter_Perfil_Ativo, nm_usuario_p, 0) = 'S') then
	qt_total_negado_w	:= pls_obter_qt_itens_status(nr_seq_guia_w, null, 'N', null, null, null, null);
	qt_total_autorizado_w	:= pls_obter_qt_itens_status(nr_seq_guia_w, null, 'S', null, null, null, null);
	qt_total_auditoria_w	:= pls_obter_qt_itens_status(nr_seq_guia_w, null, 'A', null, null, null, null);
	
	if (qt_total_auditoria_w = 0) then	
	
		select	count(1)
		into STRICT	qt_glosa_guia_w
		from	pls_guia_glosa
		where	nr_seq_guia	= nr_seq_guia_w;
		
		if	(qt_total_negado_w > 0 AND qt_total_autorizado_w = 0) then
			ie_status_w	:= '3';
			update	pls_guia_plano
			set	ie_status	= '3',
				ie_estagio 	= 4
			where	nr_sequencia	= nr_seq_guia_w;
			
		elsif (qt_total_negado_w = 0 AND qt_total_autorizado_w > 0) then
			ie_status_w	:= '1';
			if (qt_glosa_guia_w = 0) then				
				update	pls_guia_plano
				set	ie_status	= '1',
					ie_estagio 	= 6
				where	nr_sequencia	= nr_seq_guia_w;
			else
				update	pls_guia_plano
				set	ie_status	= '1',
					ie_estagio 	= 5
				where	nr_sequencia	= nr_seq_guia_w;
			end if;
			
		elsif (qt_total_negado_w > 0 AND qt_total_autorizado_w > 0) then
			ie_status_w	:= '1';
			update	pls_guia_plano
			set	ie_status	= '1',
				ie_estagio 	= 10
			where	nr_sequencia	= nr_seq_guia_w;
		end if;
		
		if (ie_status_w = '1') then		
			if (ie_origem_solic_w	= 'P') then
				begin
					select	nr_seq_perfil_web
					into STRICT	nr_seq_perfil_web_w
					from	pls_usuario_web
					where	nr_sequencia	= nr_seq_prestador_web_w;
				exception
				when others then
					nr_seq_perfil_web_w	:= null;
				end;
				
				if (pls_obter_param_web(1247, 20, cd_estabelecimento_w, nr_seq_prestador_web_w, nr_seq_perfil_web_w, null, null, 'P', null, null) = 'S') then				
					CALL pls_gerar_franquia_guia(nr_seq_guia_w, cd_estabelecimento_w, nm_usuario_p);
				end if;
			end if;
		end if;
	end if;	
else
	CALL pls_atualizar_estagio_guia(nr_seq_guia_w, nm_usuario_p,null);	
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_guia_item_lib_auditoria ( nr_sequencia_p bigint, ie_tipo_item_p bigint, nr_seq_motivo_lib_p bigint, ds_observacao_p text, ie_status_p text, nm_usuario_p text) FROM PUBLIC;

