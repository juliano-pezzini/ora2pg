-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE apae_new_record_html ( nr_seq_pepo_p bigint, nr_cirurgia_p bigint, nm_usuario_p text, ie_inseriu_registro_p INOUT text, nr_atendimento_p INOUT bigint, cd_pessoa_fisica_p INOUT text, nr_sequencia_p INOUT bigint) AS $body$
DECLARE

  nr_sequencia_w          bigint;
  nr_atendimento_w        bigint;
  nr_cirurgia_w           bigint;
  qt_apae_w               bigint;
  qt_existe_apae_w        bigint;
  cd_procedimento_princ_w bigint;
  ie_origem_proced_w      bigint;
  cd_medico_cirurgiao_w   varchar(10);
  cd_medico_anestesista_w varchar(10);
  dt_cirurgia_w           timestamp;
  nr_seq_proc_interno_w   bigint;
  cd_pessoa_fisica_w      varchar(10);
  cd_pf_usuario_w pessoa_fisica.cd_pessoa_fisica%type;

BEGIN
  nr_atendimento_w      := 0;
  cd_pf_usuario_w       := obter_pf_usuario(nm_usuario_p,'C');
  ie_inseriu_registro_p := 'N';
  nr_atendimento_p      := NULL;
  cd_pessoa_fisica_p    := NULL;
  nr_sequencia_p        := NULL;
  IF (nr_cirurgia_p       > 0) THEN
    BEGIN
      SELECT * FROM apae_obter_dados_cir_externo(nr_cirurgia_p, qt_apae_w, nr_atendimento_w, cd_procedimento_princ_w, ie_origem_proced_w, cd_medico_cirurgiao_w, cd_medico_anestesista_w, dt_cirurgia_w, nr_seq_proc_interno_w) INTO STRICT qt_apae_w, nr_atendimento_w, cd_procedimento_princ_w, ie_origem_proced_w, cd_medico_cirurgiao_w, cd_medico_anestesista_w, dt_cirurgia_w, nr_seq_proc_interno_w;
      IF (qt_apae_w = 0) THEN
        BEGIN
          SELECT nextval('aval_pre_anestesica_seq') INTO STRICT nr_sequencia_w;
          SELECT MAX(cd_pessoa_fisica)
          INTO STRICT cd_pessoa_fisica_w
          FROM cirurgia
          WHERE nr_cirurgia = nr_cirurgia_p;
          INSERT
          INTO aval_pre_anestesica(
              nr_sequencia,
              nr_cirurgia,
              cd_pessoa_fisica,
              cd_medico,
              cd_avaliador,
              cd_procedimento,
              ie_origem_proced,
              nr_seq_proc_interno,
              dt_cirurgia,
              nm_usuario_nrec,
              nm_usuario,
              dt_atualizacao_nrec,
              dt_atualizacao,
              dt_avaliacao,
              nr_atendimento
            )
            VALUES (
              nr_sequencia_w,
              nr_cirurgia_p,
              cd_pessoa_fisica_w,
              coalesce(cd_medico_cirurgiao_w,cd_pf_usuario_w),
              coalesce(cd_medico_anestesista_w,cd_pf_usuario_w),
              cd_procedimento_princ_w,
              ie_origem_proced_w,
              nr_seq_proc_interno_w,
              dt_cirurgia_w,
              nm_usuario_p,
              nm_usuario_p,
              clock_timestamp(),
              clock_timestamp(),
              clock_timestamp(),
              nr_atendimento_w
            );
          ie_inseriu_registro_p := 'S';
          nr_atendimento_p      := nr_atendimento_w;
          cd_pessoa_fisica_p    := cd_pessoa_fisica_w;
          nr_sequencia_p        := nr_sequencia_w;
        END;
      END IF;
    END;
  elsif (nr_seq_pepo_p > 0) THEN
    BEGIN
      SELECT * FROM apae_obter_dados_estrut_pepo(nr_seq_pepo_p, nr_atendimento_w, qt_apae_w, cd_procedimento_princ_w, ie_origem_proced_w, cd_medico_cirurgiao_w, cd_medico_anestesista_w, dt_cirurgia_w) INTO STRICT nr_atendimento_w, qt_apae_w, cd_procedimento_princ_w, ie_origem_proced_w, cd_medico_cirurgiao_w, cd_medico_anestesista_w, dt_cirurgia_w;
      IF (qt_apae_w = 0) THEN
        BEGIN
          SELECT nextval('aval_pre_anestesica_seq') INTO STRICT nr_sequencia_w;
          SELECT MAX(cd_pessoa_fisica)
          INTO STRICT cd_pessoa_fisica_w
          FROM cirurgia
          WHERE nr_seq_pepo = nr_seq_pepo_p;
          INSERT
          INTO aval_pre_anestesica(
              nr_sequencia,
              nr_seq_pepo,
              cd_pessoa_fisica,
              cd_medico,
              cd_avaliador,
              cd_procedimento,
              ie_origem_proced,
              dt_cirurgia,
              nm_usuario_nrec,
              nm_usuario,
              dt_atualizacao_nrec,
              dt_atualizacao,
              dt_avaliacao,
              nr_atendimento
            )
            VALUES (
              nr_sequencia_w,
              nr_seq_pepo_p,
              cd_pessoa_fisica_w,
              coalesce(cd_medico_cirurgiao_w,cd_pf_usuario_w),
              coalesce(cd_medico_anestesista_w,cd_pf_usuario_w),
              cd_procedimento_princ_w,
              ie_origem_proced_w,
              dt_cirurgia_w,
              nm_usuario_p,
              nm_usuario_p,
              clock_timestamp(),
              clock_timestamp(),
              clock_timestamp(),
              nr_atendimento_w
            );
          ie_inseriu_registro_p := 'S';
          nr_atendimento_p      := nr_atendimento_w;
          cd_pessoa_fisica_p    := cd_pessoa_fisica_w;
          nr_sequencia_p        := nr_sequencia_w;
        END;
      END IF;
    END;
  END IF;
  COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE apae_new_record_html ( nr_seq_pepo_p bigint, nr_cirurgia_p bigint, nm_usuario_p text, ie_inseriu_registro_p INOUT text, nr_atendimento_p INOUT bigint, cd_pessoa_fisica_p INOUT text, nr_sequencia_p INOUT bigint) FROM PUBLIC;

