-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplic_transcricao_prescr ( nr_sequencia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE



dt_anexo_w				timestamp;
ds_arquivo_w  			varchar(255);
nr_sequencia_w			bigint;
nr_seq_classificacao_w	transcricao_prescricao.nr_seq_classificacao%type;

C01 CURSOR FOR
SELECT 	dt_anexo,
	ds_arquivo
from 	transcricao_prescricao_arq
where 	nr_seq_transcricao = nr_sequencia_p;


BEGIN

select	nextval('transcricao_prescricao_seq')
into STRICT
	nr_sequencia_w
;

select 	nr_seq_classificacao
into STRICT	nr_seq_classificacao_w
from 	transcricao_prescricao
where 	nr_sequencia = nr_sequencia_p;

insert into transcricao_prescricao(	nr_sequencia,
				nr_seq_classificacao,
				dt_anexo,
				nm_usuario_nrec,
				dt_liberacao,
				nm_usuario_lib,
				cd_setor_atendimento,
				ds_observacao,
				cd_estabelecimento,
				nr_atendimento,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				cd_pessoa_fisica,
				ie_status,
				ds_arquivo,
				dt_transcricao,
				nm_usuario_transcricao)
			SELECT 	nr_sequencia_w,
				nr_seq_classificacao,
				clock_timestamp(),
				nm_usuario_p,
				null,
				null,
				cd_setor_atendimento,
				ds_observacao,
				cd_estabelecimento_p,
				nr_atendimento,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				cd_pessoa_fisica,
				'S',
				ds_arquivo,
				null,
				null
			from	transcricao_prescricao
			where 	nr_sequencia = nr_sequencia_p;

open C01;
loop
fetch C01 into
	dt_anexo_w,
	ds_arquivo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	insert into transcricao_prescricao_arq(	nr_sequencia,
					dt_anexo,
					ds_arquivo,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					dt_atualizacao,
					nm_usuario,
					nr_seq_transcricao)
	values (nextval('transcricao_prescricao_arq_seq'),
					dt_anexo_w,
					ds_arquivo_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_sequencia_w);
	end;
end loop;
close C01;
commit;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplic_transcricao_prescr ( nr_sequencia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

