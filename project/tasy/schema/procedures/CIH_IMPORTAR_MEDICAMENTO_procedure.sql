-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cih_importar_medicamento ( nr_ficha_ocorrencia_p bigint, nm_usuario_p text, ie_vincular_medic_conta_p text, nr_atendimento_p bigint default null) AS $body$
DECLARE


nr_atendimento_w		bigint;
cd_clinica_w			bigint;
cd_medicamento_w		bigint;
dt_inicial_utilizacao_w		timestamp;
dt_final_utilizacao_w		timestamp;
qt_dia_profilatico_w		smallint;
qt_dia_terapeutico_w		smallint;
ie_tipo_utilizacao_w		smallint;
vl_material_w			material_atend_paciente.vl_material%type;
qt_material_w			prescr_mat_alteracao.qt_dose_adm%type;
nr_seq_medicamento_w		bigint;
nr_seq_matpaci_w		bigint;
nr_seq_cih_util_paciente_w	bigint;
dt_parametro_w			timestamp;
ie_inseriu_w			boolean;
dt_inicial_utilizacao_ww	timestamp;
dt_final_utilizacao_ww		timestamp;
cd_medicamento_ww		material.cd_medicamento%type;
qt_dias_utilizacao_w		bigint := 0;
cd_unidade_medida_w		material_atend_paciente.cd_unidade_medida%type;
cd_setor_atendimento_w		setor_atendimento.cd_setor_atendimento%type;
ie_tipo_inf_medic_w		varchar(1);
ie_existe_w			varchar(1);
ie_antimicrobiano_w		varchar(1);
nr_seq_interno_prescr_w		bigint;
cd_intervalo_w			varchar(7);
ds_justificativa_w		varchar(2000);
ie_origem_infeccao_w		varchar(1);
cd_topografia_cih_w		bigint;
ie_regra_uso_w			varchar(1);
cd_material_w			material.cd_material%type;
ie_tipo_atendimento_w		smallint;
ie_clinica_w			integer;
cd_setor_w			integer;
cd_unidade_medida_dose_w	varchar(30);
ie_import_uso_prescricao_w	varchar(1);
ie_objetivo_w			prescr_material.ie_objetivo%type;

C01 CURSOR FOR
	SELECT	c.cd_medicamento,
		min(a.dt_atendimento) dt_inicial_utilizacao,
		max(a.dt_atendimento) dt_final_utilizacao,
		coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_profilatico,'DP',ie_tipo_atendimento_w,cd_setor_w,ie_clinica_w),0),
		coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_terapeutico,'DT',ie_tipo_atendimento_w,cd_setor_w,ie_clinica_w),0)
	from	material_atend_paciente a,
		material c
	where	a.nr_atendimento	= coalesce(nr_atendimento_p,nr_atendimento_w)
	and	a.cd_material		= c.cd_material
	and	(c.cd_medicamento IS NOT NULL AND c.cd_medicamento::text <> '')
	and 	not exists (	SELECT	1
				from	cih_medic_utilizado_paciente d
				where	d.nr_seq_matpaci = a.nr_sequencia)
	group by	
		c.cd_medicamento,
		coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_profilatico,'DP',ie_tipo_atendimento_w,cd_setor_w,ie_clinica_w),0),
		coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_terapeutico,'DT',ie_tipo_atendimento_w,cd_setor_w,ie_clinica_w),0),
		c.cd_material;

C02 CURSOR FOR
	SELECT 	a.nr_sequencia
	from	material_atend_paciente a,
		material c
	where	a.nr_atendimento	= coalesce(nr_atendimento_p,nr_atendimento_w)
	and	a.cd_material		= c.cd_material
	and	c.cd_medicamento	= cd_medicamento_w
	and	coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_profilatico,'DP',ie_tipo_atendimento_w,cd_setor_w,ie_clinica_w),qt_dia_profilatico_w)	= qt_dia_profilatico_w
	and	coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_terapeutico,'DT',ie_tipo_atendimento_w,cd_setor_w,ie_clinica_w),qt_dia_terapeutico_w)	= qt_dia_terapeutico_w
	and	pkg_date_utils.get_time(a.dt_atendimento,0,0,0) = dt_parametro_w
	and 	not exists (	SELECT	1
				from 	cih_medic_utilizado_paciente d
				where	d.nr_seq_matpaci = a.nr_sequencia);
			
C03 CURSOR FOR
	SELECT	c.cd_medicamento,
		min(e.dt_alteracao) dt_inicial_utilizacao,
		max(e.dt_alteracao) dt_final_utilizacao,
		coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_profilatico,'DP',ie_tipo_atendimento_w,a.cd_setor_atendimento,ie_clinica_w),0),
		coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_terapeutico,'DT',ie_tipo_atendimento_w,a.cd_setor_atendimento,ie_clinica_w),0),
		e.cd_um_dose_adm,
		b.cd_intervalo,
		b.ds_justificativa,
		b.ie_origem_infeccao,
		b.cd_topografia_cih
	from	prescr_mat_alteracao e,
		prescr_medica a,
		prescr_material b,
		material c
	where 	e.nr_prescricao		= b.nr_prescricao
	and	e.nr_seq_prescricao 	= b.nr_sequencia
	and	a.nr_prescricao  	= b.nr_prescricao
	and	b.cd_material	 	= c.cd_material	
	and	a.nr_atendimento 	= coalesce(nr_atendimento_p,nr_atendimento_w)
	and	(c.cd_medicamento IS NOT NULL AND c.cd_medicamento::text <> '')
	and 	not exists (	SELECT	1
				from 	cih_medic_utilizado_paciente d,
					cih_medic_utilizado f
				where 	d.nr_seq_interno_prescr = b.nr_seq_interno
				and	d.nr_seq_medic_utilizado = f.nr_seq_medicamento
				and	f.nr_ficha_ocorrencia = nr_ficha_ocorrencia_p
				and	f.cd_unidade_medida = e.cd_um_dose_adm)
	group by	
		c.cd_medicamento, 
		e.cd_um_dose_adm,
		coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_profilatico,'DP',ie_tipo_atendimento_w,a.cd_setor_atendimento,ie_clinica_w),0),
		coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_terapeutico,'DT',ie_tipo_atendimento_w,a.cd_setor_atendimento,ie_clinica_w),0),
		b.cd_intervalo,
		c.cd_material,
		b.ds_justificativa,
		b.ie_origem_infeccao,
		b.cd_topografia_cih;						
	

C04 CURSOR FOR
	SELECT	b.nr_seq_interno
	from   	prescr_mat_alteracao e,
		prescr_medica a,
		prescr_material b,
		material c
	where  	e.nr_prescricao    	= b.nr_prescricao
	and    	e.nr_seq_prescricao	= b.nr_sequencia	
	and	a.nr_prescricao		= b.nr_prescricao
	and	b.cd_material	  	= c.cd_material	
	and	a.nr_atendimento 	= coalesce(nr_atendimento_p,nr_atendimento_w)
	and	c.cd_medicamento	= cd_medicamento_w
	and	coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_profilatico,'DP',ie_tipo_atendimento_w,a.cd_setor_atendimento,ie_clinica_w),qt_dia_profilatico_w)	= qt_dia_profilatico_w
	and	coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_terapeutico,'DT',ie_tipo_atendimento_w,a.cd_setor_atendimento,ie_clinica_w),qt_dia_terapeutico_w)	= qt_dia_terapeutico_w
	and	pkg_date_utils.get_time(e.dt_alteracao,0,0,0)	= dt_parametro_w
	and	e.cd_um_dose_adm	= cd_unidade_medida_w	
	and 	not exists (	SELECT 	1 
				from	cih_medic_utilizado_paciente d,
					cih_medic_utilizado f
				where 	d.nr_seq_interno_prescr = b.nr_seq_interno
				and	d.nr_seq_medic_utilizado = f.nr_seq_medicamento
				and	f.nr_ficha_ocorrencia = nr_ficha_ocorrencia_p
				and	f.cd_unidade_medida = cd_unidade_medida_w);

C05 CURSOR FOR
	SELECT	a.nr_seq_medicamento
	from	cih_medic_utilizado a
	where	a.nr_ficha_ocorrencia = nr_ficha_ocorrencia_p
	and	exists (	SELECT 	1
				from	cih_medic_utilizado f,
					cih_medic_utilizado_paciente b,
					prescr_material c,
					prescr_mat_alteracao d
				where	b.nr_seq_interno_prescr = c.nr_seq_interno
				and	c.nr_sequencia = d.nr_seq_prescricao
				and	c.nr_prescricao = d.nr_prescricao
				and	b.nr_seq_medic_utilizado = f.nr_seq_medicamento
				and	f.nr_ficha_ocorrencia = nr_ficha_ocorrencia_p
				and	b.nr_ficha_ocorrencia = nr_ficha_ocorrencia_p
				--and	d.dt_alteracao > f.dt_final_utilizacao
				and	b.nr_seq_medic_utilizado = a.nr_seq_medicamento
				and	f.cd_unidade_medida = a.cd_unidade_medida);
					
C06 CURSOR FOR
	SELECT  distinct c.cd_medicamento,
		min(a.dt_prescricao) dt_inicial_utilizacao,
		max(a.dt_prescricao) dt_final_utilizacao,
		coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_profilatico,'DP',ie_tipo_atendimento_w,a.cd_setor_atendimento,ie_clinica_w),0),
		coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_terapeutico,'DT',ie_tipo_atendimento_w,a.cd_setor_atendimento,ie_clinica_w),0),
		b.cd_unidade_medida_dose
	from    material c,
		prescr_material b,
		prescr_medica a
	where   a.nr_atendimento = coalesce(nr_atendimento_p,nr_atendimento_w)
	and	a.nr_prescricao  = b.nr_prescricao
	and	b.cd_material    = c.cd_material
	and	(c.cd_medicamento IS NOT NULL AND c.cd_medicamento::text <> '')
	and	((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> ''))
	and 	obter_ctrl_antimicrobiano_mat(b.cd_material) >  0
	and 	not exists (	SELECT	1 
				from 	cih_medic_utilizado_paciente d,
					cih_medic_utilizado f
				where 	d.nr_seq_interno_prescr = b.nr_seq_interno
				and	d.nr_seq_medic_utilizado = f.nr_seq_medicamento
				and	f.nr_ficha_ocorrencia = nr_ficha_ocorrencia_p)
	group by	
		c.cd_medicamento,
		coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_profilatico,'DP',ie_tipo_atendimento_w,a.cd_setor_atendimento,ie_clinica_w),0),
		coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_terapeutico,'DT',ie_tipo_atendimento_w,a.cd_setor_atendimento,ie_clinica_w),0),
		c.cd_material,
		b.cd_unidade_medida_dose;				
			
			
C07 CURSOR FOR
	SELECT	b.nr_seq_interno
	from    material c,
		prescr_material b,
		prescr_medica a
	where   a.nr_atendimento = coalesce(nr_atendimento_p,nr_atendimento_w)
	and	a.nr_prescricao  = b.nr_prescricao
	and	b.cd_material    = c.cd_material
	and	(c.cd_medicamento IS NOT NULL AND c.cd_medicamento::text <> '')
	and	((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> ''))
	and 	obter_ctrl_antimicrobiano_mat(b.cd_material) >  0
	and	c.cd_medicamento = cd_medicamento_w
	and	b.cd_unidade_medida_dose = cd_unidade_medida_dose_w
	and	coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_profilatico,'DP',ie_tipo_atendimento_w,a.cd_setor_atendimento,ie_clinica_w),qt_dia_profilatico_w)	= qt_dia_profilatico_w
	and	coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_terapeutico,'DT',ie_tipo_atendimento_w,a.cd_setor_atendimento,ie_clinica_w),qt_dia_terapeutico_w)	= qt_dia_terapeutico_w
	and	pkg_date_utils.get_time(a.dt_prescricao,0,0,0)	= dt_parametro_w
	and 	not exists (	SELECT	1 
				from 	cih_medic_utilizado_paciente d,
					cih_medic_utilizado f
				where 	d.nr_seq_interno_prescr = b.nr_seq_interno
				and	d.nr_seq_medic_utilizado = f.nr_seq_medicamento
				and	f.nr_ficha_ocorrencia = nr_ficha_ocorrencia_p);	
C08 CURSOR FOR
SELECT 	distinct c.cd_medicamento,
	min(a.dt_prescricao) dt_inicial_utilizacao,
	max(a.dt_prescricao) dt_final_utilizacao,
	coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_profilatico,'DP',ie_tipo_atendimento_w,a.cd_setor_atendimento,ie_clinica_w),0),
	coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_terapeutico,'DT',ie_tipo_atendimento_w,a.cd_setor_atendimento,ie_clinica_w),0),
	b.cd_unidade_medida_dose,
	b.ie_objetivo
FROM cih_ficha_ocorrencia g, material c, prescr_medica a, prescr_material b
LEFT OUTER JOIN cih_amostra_cultura e ON (b.cd_amostra_cih = e.cd_amostra_cultura)
LEFT OUTER JOIN cih_microorganismo f ON (b.cd_microorganismo_cih = f.cd_microorganismo)
WHERE b.cd_material = c.cd_material and a.nr_prescricao = b.nr_prescricao and g.nr_atendimento = a.nr_atendimento   and b.ie_agrupador = 1 and b.ie_suspenso <> 'S' and coalesce(a.dt_suspensao::text, '') = '' and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') and (c.cd_medicamento IS NOT NULL AND c.cd_medicamento::text <> '') and g.nr_atendimento = coalesce(nr_atendimento_p,nr_atendimento_w) group by	
	c.cd_medicamento,
	coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_profilatico,'DP',ie_tipo_atendimento_w,a.cd_setor_atendimento,ie_clinica_w),0),
	coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_terapeutico,'DT',ie_tipo_atendimento_w,a.cd_setor_atendimento,ie_clinica_w),0),
	c.cd_material,
	b.cd_unidade_medida_dose,
	b.ie_objetivo;	
					

BEGIN

ie_regra_uso_w := obter_param_usuario(936, 84, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_regra_uso_w);
ie_antimicrobiano_w := obter_param_usuario(936, 93, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_antimicrobiano_w);
ie_import_uso_prescricao_w := obter_param_usuario(1302, 55, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_import_uso_prescricao_w);

select	coalesce(max(nr_atendimento),0) ,
	coalesce(max(cd_clinica),0)
into STRICT	nr_atendimento_w,
	cd_clinica_w
from	cih_ficha_ocorrencia
where	nr_ficha_ocorrencia = nr_ficha_ocorrencia_p;

if (coalesce(nr_atendimento_p,nr_atendimento_w) > 0) then
	select	ie_tipo_atendimento,
		ie_clinica,
		obter_setor_atendimento(nr_atendimento)
	into STRICT	ie_tipo_atendimento_w,
		ie_clinica_w,
		cd_setor_w
	from	atendimento_paciente
	where	nr_atendimento = coalesce(nr_atendimento_p,nr_atendimento_w);
end if;

select 	coalesce(max(ie_tipo_inf_medic),'C')
into STRICT	ie_tipo_inf_medic_w
from	cih_parametros
where	((cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento) or	
	((coalesce(cd_estabelecimento::text, '') = '') and (not exists (	SELECT	1
				from	cih_parametros
				where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento))));


if (ie_tipo_inf_medic_w = 'C') then --busca as informacoes da conta paciente
	OPEN C01;
	LOOP
	FETCH C01 into
		cd_medicamento_w,
		dt_inicial_utilizacao_w,
		dt_final_utilizacao_w,
		qt_dia_profilatico_w,
		qt_dia_terapeutico_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		dt_parametro_w	:= PKG_DATE_UTILS.start_of(dt_inicial_utilizacao_w,'dd',0);
		ie_inseriu_w	:= false;	

		while(dt_parametro_w <= dt_final_utilizacao_w) loop
			begin

			select	max(c.cd_medicamento),
				min(a.dt_atendimento) dt_inicial_utilizacao,
				max(a.dt_atendimento) dt_final_utilizacao,
				coalesce(sum(a.vl_material),0) vl_material,
				coalesce(sum(a.qt_material),0) qt_material,
				max(a.cd_unidade_medida),
				max(a.cd_setor_atendimento),
				max(a.cd_material)
			into STRICT	cd_medicamento_ww,
				dt_inicial_utilizacao_ww,
				dt_final_utilizacao_ww,
				vl_material_w,
				qt_material_w,
				cd_unidade_medida_w,
				cd_setor_atendimento_w,
				cd_material_w
			from	material_atend_paciente a,
				material c
			where	a.nr_atendimento	= coalesce(nr_atendimento_p,nr_atendimento_w)
			and	c.cd_medicamento	= cd_medicamento_w
			and	coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_profilatico,'DP',ie_tipo_atendimento_w,cd_setor_w,ie_clinica_w),qt_dia_profilatico_w)	= qt_dia_profilatico_w
			and	coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_terapeutico,'DT',ie_tipo_atendimento_w,cd_setor_w,ie_clinica_w),qt_dia_terapeutico_w)	= qt_dia_terapeutico_w
			and	pkg_date_utils.get_time(a.dt_atendimento,0,0,0)	= dt_parametro_w
			and	a.cd_material		= c.cd_material
			and	(c.cd_medicamento IS NOT NULL AND c.cd_medicamento::text <> '')
			and 	not exists (	SELECT	1
						from		cih_medic_utilizado_paciente d
						where	d.nr_seq_matpaci = a.nr_sequencia);

			if (coalesce(cd_medicamento_ww::text, '') = '') then
				ie_inseriu_w	:= false;

			else
				if (ie_inseriu_w = false) then

					select	coalesce(max(nr_seq_medicamento),0) + 1
					into STRICT	nr_seq_medicamento_w
					from	cih_medic_utilizado
					where	nr_ficha_ocorrencia = nr_ficha_ocorrencia_p;
					
					/*
					if	(qt_dia_profilatico_w is null) then
						ie_tipo_utilizacao_w	:= 2;
					else
						ie_tipo_utilizacao_w	:= 1;
					end if;
					*/
					
					qt_dias_utilizacao_w	:= pkg_date_utils.get_time(dt_parametro_w,0,0,0) - pkg_date_utils.get_time(dt_inicial_utilizacao_w,0,0,0);
					
					if (qt_dias_utilizacao_w <= qt_dia_terapeutico_w) then
						ie_tipo_utilizacao_w	:= 1;
					else
						ie_tipo_utilizacao_w	:= 2;
					end if;
					
					if (ie_regra_uso_w = 'S') then
					
						ie_tipo_utilizacao_w := cih_obter_tipo_util(cd_material_w);
												
						if (coalesce(ie_tipo_utilizacao_w::text, '') = '') then
							if (qt_dias_utilizacao_w <= qt_dia_terapeutico_w) then
								ie_tipo_utilizacao_w	:= 1;
							else
								ie_tipo_utilizacao_w	:= 2;
							end if;
						end if;
					
					end if;
					
					
					insert into cih_medic_utilizado(nr_ficha_ocorrencia,
						nr_seq_medicamento,
						cd_medicamento,
						cd_clinica,
						dt_inicial_utilizacao,
						dt_final_utilizacao,
						ie_tipo_utilizacao,
						dt_atualizacao,
						nm_usuario,
						vl_medicamento,
						qt_dose,
						cd_unidade_medida,
						cd_setor_atendimento
					) values (
						nr_ficha_ocorrencia_p,
						nr_seq_medicamento_w,
						cd_medicamento_ww,
						cd_clinica_w,
						dt_inicial_utilizacao_ww,
						dt_final_utilizacao_ww,
						ie_tipo_utilizacao_w,
						clock_timestamp(),
						nm_usuario_p,
						vl_material_w,
						qt_material_w,
						cd_unidade_medida_w,
						cd_setor_atendimento_w);

					ie_inseriu_w	:= true;
			
				elsif (ie_inseriu_w = true) then
					qt_dias_utilizacao_w	:= pkg_date_utils.get_time(dt_parametro_w,0,0,0) - pkg_date_utils.get_time(dt_inicial_utilizacao_w,0,0,0);
					
					if (qt_dias_utilizacao_w <= qt_dia_terapeutico_w) then
						ie_tipo_utilizacao_w	:= 1;
					else
						ie_tipo_utilizacao_w	:= 2;
					end if;
					
					if (ie_regra_uso_w = 'S') then
					
						ie_tipo_utilizacao_w := cih_obter_tipo_util(cd_material_w);
						
						if (coalesce(ie_tipo_utilizacao_w::text, '') = '') then
							if (qt_dias_utilizacao_w <= qt_dia_terapeutico_w) then
								ie_tipo_utilizacao_w	:= 1;
							else
								ie_tipo_utilizacao_w	:= 2;
							end if;
						end if;
					
					end if;

					update cih_medic_utilizado
					set	dt_final_utilizacao 	= dt_final_utilizacao_ww,
						vl_medicamento 		= vl_medicamento + vl_material_w,
						qt_dose 		= qt_dose + qt_material_w,
						cd_unidade_medida	= cd_unidade_medida_w,
						ie_tipo_utilizacao  	= ie_tipo_utilizacao_w
					where  	nr_ficha_ocorrencia = nr_ficha_ocorrencia_p
					and    	nr_seq_medicamento  = nr_seq_medicamento_w;
						
				end if;

				
			
			end if;
			OPEN C02;
			LOOP
			FETCH C02 into
				nr_seq_matpaci_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */

			select	coalesce(max(nr_sequencia),0) + 1
			into STRICT	nr_seq_cih_util_paciente_w
			from 	cih_medic_utilizado_paciente;
			
			insert into cih_medic_utilizado_paciente(
				NR_SEQUENCIA,
				NR_FICHA_OCORRENCIA,
				NR_SEQ_MEDIC_UTILIZADO,
				NR_SEQ_MATPACI,
				DT_ATUALIZACAO,
				NM_USUARIO
			) values (
				nr_seq_cih_util_paciente_w,
				nr_ficha_ocorrencia_p,
				nr_seq_medicamento_w,
				nr_seq_matpaci_w,
				clock_timestamp(),
				nm_usuario_p);
			END LOOP;
			CLOSE C02;

			dt_parametro_w := dt_parametro_w +1;

			end;
		end loop;

	END LOOP;
	CLOSE C01;
elsif (ie_tipo_inf_medic_w = 'A') then
	open C03;
	loop
	fetch C03 into	
		cd_medicamento_w,
		dt_inicial_utilizacao_w,
		dt_final_utilizacao_w,
		qt_dia_profilatico_w,
		qt_dia_terapeutico_w,
		cd_unidade_medida_w,
		cd_intervalo_w,
		ds_justificativa_w,
		ie_origem_infeccao_w,
		cd_topografia_cih_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin
		
		dt_parametro_w	:= PKG_DATE_UTILS.start_of(dt_inicial_utilizacao_w,'dd',0);
		ie_inseriu_w	:= false;	

		
		while(dt_parametro_w <= dt_final_utilizacao_w) loop
			begin

			
			select	max(c.cd_medicamento),
				min(e.dt_alteracao) dt_inicial_utilizacao,
				max(e.dt_alteracao) dt_final_utilizacao,
				--nvl(sum(e.vl_material),0) vl_material,
				coalesce(sum(e.qt_dose_adm),0) qt_material,
				max(a.cd_setor_atendimento),
				max(c.cd_material),
				max(b.ie_objetivo)
			into STRICT	cd_medicamento_ww,
				dt_inicial_utilizacao_ww,
				dt_final_utilizacao_ww,
				--vl_material_w,
				qt_material_w,
				cd_setor_atendimento_w,
				cd_material_w,
				ie_objetivo_w
			from	prescr_mat_alteracao e,
				prescr_medica a,
				prescr_material b,
				material c
			where 	e.nr_prescricao     	= b.nr_prescricao
			and 	e.nr_seq_prescricao	= b.nr_sequencia	
			and	a.nr_prescricao		= b.nr_prescricao
			and	b.cd_material	  	= c.cd_material	
			and	a.nr_atendimento 	= coalesce(nr_atendimento_p,nr_atendimento_w)
			and	(c.cd_medicamento IS NOT NULL AND c.cd_medicamento::text <> '')
			and	c.cd_medicamento	= cd_medicamento_w
			and	coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_profilatico,'DP',ie_tipo_atendimento_w,a.cd_setor_atendimento,ie_clinica_w),qt_dia_profilatico_w)	= qt_dia_profilatico_w
			and	coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_terapeutico,'DT',ie_tipo_atendimento_w,a.cd_setor_atendimento,ie_clinica_w),qt_dia_terapeutico_w)	= qt_dia_terapeutico_w
			and	pkg_date_utils.get_time(e.dt_alteracao,0,0,0)	= dt_parametro_w
			and	e.cd_um_dose_adm	= cd_unidade_medida_w
			and 	not exists (	SELECT 	1
						from 	cih_medic_utilizado_paciente d,
							cih_medic_utilizado f
						where 	d.nr_seq_interno_prescr = b.nr_seq_interno
						and	d.nr_seq_medic_utilizado = f.nr_seq_medicamento
						and	f.nr_ficha_ocorrencia = nr_ficha_ocorrencia_p
						and	f.cd_unidade_medida = cd_unidade_medida_w)
			and	e.ie_alteracao = 3
			and exists (	select 	1
					from	prescr_mat_alteracao x
					where	x.nr_sequencia = (	select	max(y.nr_sequencia)
									from	prescr_mat_alteracao y
									where	y.nr_prescricao = e.nr_prescricao
									and	y.nr_seq_prescricao = e.nr_seq_prescricao
									and	y.ie_alteracao = 3
									and	coalesce(to_char(y.dt_hor_acm_sn,'dd/mm/yyyy hh24:mi:ss'),substr(plt_obter_dados_hor_item(coalesce(coalesce(coalesce(coalesce(y.nr_seq_horario, y.nr_seq_horario_proc), y.nr_seq_horario_rec),y.nr_seq_horario_dieta),y.nr_seq_horario_sae),y.ie_tipo_item,'H'),1,19)) =
										coalesce(to_char(x.dt_hor_acm_sn,'dd/mm/yyyy hh24:mi:ss'),substr(plt_obter_dados_hor_item(coalesce(coalesce(coalesce(coalesce(x.nr_seq_horario, x.nr_seq_horario_proc), x.nr_seq_horario_rec),x.nr_seq_horario_dieta),x.nr_seq_horario_sae),x.ie_tipo_item,'H'),1,19)))
									and	x.nr_sequencia = e.nr_sequencia);	
			
				
			
			if (coalesce(cd_medicamento_ww::text, '') = '') then
				ie_inseriu_w	:= false;

			else
				if (ie_inseriu_w = false) then

					select	coalesce(max(nr_seq_medicamento),0) + 1
					into STRICT	nr_seq_medicamento_w
					from	cih_medic_utilizado
					where	nr_ficha_ocorrencia = nr_ficha_ocorrencia_p;
					
					qt_dias_utilizacao_w	:= pkg_date_utils.get_time(dt_parametro_w,0,0,0) - pkg_date_utils.get_time(dt_inicial_utilizacao_w,0,0,0);
					
					if (qt_dias_utilizacao_w <= qt_dia_terapeutico_w) then
						ie_tipo_utilizacao_w	:= 1;
					else
						ie_tipo_utilizacao_w	:= 2;
					end if;
					
					if (ie_regra_uso_w = 'S') then
					
						ie_tipo_utilizacao_w := cih_obter_tipo_util(cd_material_w);
						
						if (coalesce(ie_tipo_utilizacao_w::text, '') = '') then
							if (qt_dias_utilizacao_w <= qt_dia_terapeutico_w) then
								ie_tipo_utilizacao_w	:= 1;
							else
								ie_tipo_utilizacao_w	:= 2;
							end if;
						end if;
					
					end if;
					
					insert into cih_medic_utilizado(nr_ficha_ocorrencia,
						nr_seq_medicamento,
						cd_medicamento,
						cd_clinica,
						dt_inicial_utilizacao,
						dt_final_utilizacao,
						ie_tipo_utilizacao,
						dt_atualizacao,
						nm_usuario,
						--vl_medicamento,
						qt_dose,
						cd_unidade_medida,
						cd_setor_atendimento,
						cd_intervalo,
						ds_justificativa,
						ie_origem_infeccao,
						cd_topografia_cih
					) values (
						nr_ficha_ocorrencia_p,
						nr_seq_medicamento_w,
						cd_medicamento_ww,
						cd_clinica_w,
						dt_inicial_utilizacao_ww,
						dt_final_utilizacao_ww,
						CASE WHEN ie_import_uso_prescricao_w='S' THEN  CASE WHEN ie_objetivo_w='C' THEN  3 WHEN ie_objetivo_w='D' THEN  4 WHEN ie_objetivo_w='E' THEN  5 WHEN ie_objetivo_w='F' THEN  1 WHEN ie_objetivo_w='N' THEN  7 WHEN ie_objetivo_w='P' THEN  6 WHEN ie_objetivo_w='T' THEN  2  ELSE ie_tipo_utilizacao_w END   ELSE ie_tipo_utilizacao_w END ,
						clock_timestamp(),
						nm_usuario_p,
						--vl_material_w,
						qt_material_w,
						cd_unidade_medida_w,
						cd_setor_atendimento_w,
						cd_intervalo_w,
						ds_justificativa_w,
						ie_origem_infeccao_w,
						cd_topografia_cih_w);
	
					ie_inseriu_w	:= true;
			
				elsif (ie_inseriu_w = true) then
					
					qt_dias_utilizacao_w	:= pkg_date_utils.get_time(dt_parametro_w,0,0,0) - pkg_date_utils.get_time(dt_inicial_utilizacao_w,0,0,0);
					
					if (qt_dias_utilizacao_w <= qt_dia_terapeutico_w) then
						ie_tipo_utilizacao_w	:= 1;
					else
						ie_tipo_utilizacao_w	:= 2;
					end if;
					
					if (ie_regra_uso_w = 'S') then
					
						ie_tipo_utilizacao_w := cih_obter_tipo_util(cd_material_w);
						
						if (coalesce(ie_tipo_utilizacao_w::text, '') = '') then
							if (qt_dias_utilizacao_w <= qt_dia_terapeutico_w) then
								ie_tipo_utilizacao_w	:= 1;
							else
								ie_tipo_utilizacao_w	:= 2;
							end if;
						end if;
					
					end if;

					update cih_medic_utilizado
					set	dt_final_utilizacao 	= dt_final_utilizacao_ww,
						--vl_medicamento 		= vl_medicamento + vl_material_w,
						qt_dose 		= qt_dose + qt_material_w,
						ie_tipo_utilizacao      = CASE WHEN ie_import_uso_prescricao_w='S' THEN  CASE WHEN ie_objetivo_w='C' THEN  3 WHEN ie_objetivo_w='D' THEN  4 WHEN ie_objetivo_w='E' THEN  5 WHEN ie_objetivo_w='F' THEN  1 WHEN ie_objetivo_w='N' THEN  7 WHEN ie_objetivo_w='P' THEN  6 WHEN ie_objetivo_w='T' THEN  2  ELSE ie_tipo_utilizacao END   ELSE ie_tipo_utilizacao_w END
					where  	nr_ficha_ocorrencia = nr_ficha_ocorrencia_p
					and    	nr_seq_medicamento  = nr_seq_medicamento_w;
						
				end if;

			end if;
			
			OPEN C04;
			LOOP
			FETCH C04 into
				nr_seq_interno_prescr_w;
			EXIT WHEN NOT FOUND; /* apply on c04 */
			
			select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ie_existe_w
			from	cih_medic_utilizado_paciente
			where	((NR_FICHA_OCORRENCIA 	= nr_ficha_ocorrencia_p) or (coalesce(nr_ficha_ocorrencia_p::text, '') = '' and coalesce(NR_FICHA_OCORRENCIA::text, '') = ''))
			and	((NR_SEQ_MEDIC_UTILIZADO	= nr_seq_medicamento_w) or (coalesce(nr_seq_medicamento_w::text, '') = '' and coalesce(NR_SEQ_MEDIC_UTILIZADO::text, '') = ''))
			and	((nr_seq_interno_prescr = nr_seq_interno_prescr_w) or (coalesce(nr_seq_interno_prescr_w::text, '') = '' and coalesce(nr_seq_interno_prescr::text, '') = ''));

			if (ie_existe_w = 'N') then
			
				select	coalesce(max(nr_sequencia),0) + 1
				into STRICT	nr_seq_cih_util_paciente_w
				from 	cih_medic_utilizado_paciente;
				
				insert into cih_medic_utilizado_paciente(nr_sequencia,
					nr_ficha_ocorrencia,
					nr_seq_medic_utilizado,
					nr_seq_interno_prescr,
					dt_atualizacao,
					nm_usuario
				) values (
					nr_seq_cih_util_paciente_w,
					nr_ficha_ocorrencia_p,
					nr_seq_medicamento_w,
					nr_seq_interno_prescr_w,
					clock_timestamp(),
					nm_usuario_p);
			end if;
			END LOOP;
			CLOSE C04;

			dt_parametro_w := dt_parametro_w +1;

			end;
		end loop;

		end;
	end loop;
	close C03;

	open C05;
	loop
	fetch C05 into	
		nr_seq_medicamento_w;
	EXIT WHEN NOT FOUND; /* apply on C05 */
		begin
		
		SELECT	coalesce(SUM(d.qt_dose_adm),0) qt_material,
			max(a.cd_unidade_medida),
			MAX(d.dt_alteracao) dt_final_utilizacao
		into STRICT	qt_material_w,
			cd_unidade_medida_w,
			dt_final_utilizacao_ww
		FROM	cih_medic_utilizado a,
			cih_medic_utilizado_paciente b,
			prescr_material c,
			prescr_mat_alteracao d
		WHERE	b.nr_seq_interno_prescr = c.nr_seq_interno
		AND	c.nr_sequencia = d.nr_seq_prescricao
		AND	c.nr_prescricao = d.nr_prescricao
		aND	b.nr_seq_medic_utilizado = a.nr_seq_medicamento
		AND	b.nr_seq_medic_utilizado = nr_seq_medicamento_w				
		and	a.nr_ficha_ocorrencia = nr_ficha_ocorrencia_p
		and	a.cd_unidade_medida   = d.cd_um_dose_adm
		and	b.nr_ficha_ocorrencia = nr_ficha_ocorrencia_p
		and	d.ie_alteracao = 3
		and exists (	SELECT 	1
				from	prescr_mat_alteracao x
				where	x.nr_sequencia = (
						SELECT max(y.nr_sequencia)
						from	prescr_mat_alteracao y
						where	y.nr_prescricao = d.nr_prescricao
						and	y.nr_seq_prescricao = d.nr_seq_prescricao
						and	y.ie_alteracao = 3
						and	coalesce(to_char(y.dt_hor_acm_sn,'dd/mm/yyyy hh24:mi:ss'),substr(plt_obter_dados_hor_item(coalesce(coalesce(coalesce(coalesce(y.nr_seq_horario, y.nr_seq_horario_proc), y.nr_seq_horario_rec),y.nr_seq_horario_dieta),y.nr_seq_horario_sae),y.ie_tipo_item,'H'),1,19)) =
							coalesce(to_char(x.dt_hor_acm_sn,'dd/mm/yyyy hh24:mi:ss'),substr(plt_obter_dados_hor_item(coalesce(coalesce(coalesce(coalesce(x.nr_seq_horario, x.nr_seq_horario_proc), x.nr_seq_horario_rec),x.nr_seq_horario_dieta),x.nr_seq_horario_sae),x.ie_tipo_item,'H'),1,19)))
			and	x.nr_sequencia = d.nr_sequencia);
	
		update 	cih_medic_utilizado
		set	dt_final_utilizacao 	= dt_final_utilizacao_ww,
			qt_dose 		= qt_material_w
		where  	nr_ficha_ocorrencia 	= nr_ficha_ocorrencia_p
		and    	nr_seq_medicamento 	= nr_seq_medicamento_w;
		
		end;
	end loop;
	close C05;
elsif (ie_tipo_inf_medic_w = 'P') then
	open C06;
	loop
	fetch C06 into	
		cd_medicamento_w,
		dt_inicial_utilizacao_w,
		dt_final_utilizacao_w,
		qt_dia_profilatico_w,
		qt_dia_terapeutico_w,
		cd_unidade_medida_dose_w;
	EXIT WHEN NOT FOUND; /* apply on C06 */
		begin
		dt_parametro_w	:= PKG_DATE_UTILS.start_of(dt_inicial_utilizacao_w,'dd',0);
		ie_inseriu_w	:= false;	
		while(dt_parametro_w <= dt_final_utilizacao_w) loop
			begin
			select  max(c.cd_medicamento),
				min(a.dt_prescricao) dt_inicial_utilizacao,
				max(a.dt_prescricao) dt_final_utilizacao,	
				coalesce(sum(b.qt_dose),0) qt_material,
				max(b.cd_unidade_medida_dose),
				max(a.cd_setor_atendimento),
				max(c.cd_material),
				max(b.cd_intervalo),
				max(b.ie_objetivo)
			into STRICT	cd_medicamento_ww,
				dt_inicial_utilizacao_ww,
				dt_final_utilizacao_ww,				
				qt_material_w,
				cd_unidade_medida_w,
				cd_setor_atendimento_w,
				cd_material_w	,
				cd_intervalo_w,
				ie_objetivo_w
			from    material c,
				prescr_material b,
				prescr_medica a
			where   a.nr_atendimento = coalesce(nr_atendimento_p,nr_atendimento_w)
			and	a.nr_prescricao  = b.nr_prescricao
			and	b.cd_material    = c.cd_material
			and	(c.cd_medicamento IS NOT NULL AND c.cd_medicamento::text <> '')
			and	((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> ''))
			and	c.cd_medicamento = cd_medicamento_w
			and	b.cd_unidade_medida_dose = cd_unidade_medida_dose_w
			and 	obter_ctrl_antimicrobiano_mat(b.cd_material) >  0
			and 	not exists (	SELECT	1 
						from 	cih_medic_utilizado_paciente d,
							cih_medic_utilizado f
						where 	d.nr_seq_interno_prescr = b.nr_seq_interno
						and	d.nr_seq_medic_utilizado = f.nr_seq_medicamento
						and	f.nr_ficha_ocorrencia = nr_ficha_ocorrencia_p)
			and	coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_profilatico,'DP',ie_tipo_atendimento_w,a.cd_setor_atendimento,ie_clinica_w),qt_dia_profilatico_w)	= qt_dia_profilatico_w
			and	coalesce(obter_dados_medic_atb_num(c.cd_material,wheb_usuario_pck.get_cd_estabelecimento,c.qt_dia_terapeutico,'DT',ie_tipo_atendimento_w,a.cd_setor_atendimento,ie_clinica_w),qt_dia_terapeutico_w)	= qt_dia_terapeutico_w
			and	pkg_date_utils.get_time(a.dt_prescricao,0,0,0)	= dt_parametro_w;			
			
			
			if (coalesce(cd_medicamento_ww::text, '') = '') then
				ie_inseriu_w	:= false;

			else
				if (ie_inseriu_w = false) then

					select	coalesce(max(nr_seq_medicamento),0) + 1
					into STRICT	nr_seq_medicamento_w
					from	cih_medic_utilizado
					where	nr_ficha_ocorrencia = nr_ficha_ocorrencia_p;
					
					/*
					if	(qt_dia_profilatico_w is null) then
						ie_tipo_utilizacao_w	:= 2;
					else
						ie_tipo_utilizacao_w	:= 1;
					end if;
					*/
					
					qt_dias_utilizacao_w	:= pkg_date_utils.get_time(dt_parametro_w,0,0,0) - pkg_date_utils.get_time(dt_inicial_utilizacao_w,0,0,0);
					
					if (qt_dias_utilizacao_w <= qt_dia_terapeutico_w) then
						ie_tipo_utilizacao_w	:= 1;
					else
						ie_tipo_utilizacao_w	:= 2;
					end if;
					
					if (ie_regra_uso_w = 'S') then
					
						ie_tipo_utilizacao_w := cih_obter_tipo_util(cd_material_w);

						if (coalesce(ie_tipo_utilizacao_w::text, '') = '') then
							if (qt_dias_utilizacao_w <= qt_dia_terapeutico_w) then
								ie_tipo_utilizacao_w	:= 1;
							else
								ie_tipo_utilizacao_w	:= 2;
							end if;
						end if;
					
					end if;
					
					
					insert into cih_medic_utilizado(nr_ficha_ocorrencia,
						nr_seq_medicamento,
						cd_medicamento,
						cd_clinica,
						dt_inicial_utilizacao,
						dt_final_utilizacao,
						ie_tipo_utilizacao,
						dt_atualizacao,
						nm_usuario,						
						qt_dose,
						cd_unidade_medida,
						cd_setor_atendimento,
						cd_intervalo
					) values (
						nr_ficha_ocorrencia_p,
						nr_seq_medicamento_w,
						cd_medicamento_ww,
						cd_clinica_w,
						dt_inicial_utilizacao_ww,
						dt_final_utilizacao_ww,
						CASE WHEN ie_import_uso_prescricao_w='S' THEN  CASE WHEN ie_objetivo_w='C' THEN  3 WHEN ie_objetivo_w='D' THEN  4 WHEN ie_objetivo_w='E' THEN  5 WHEN ie_objetivo_w='F' THEN  1 WHEN ie_objetivo_w='N' THEN  7 WHEN ie_objetivo_w='P' THEN  6 WHEN ie_objetivo_w='T' THEN  2  ELSE ie_tipo_utilizacao_w END   ELSE ie_tipo_utilizacao_w END ,
						clock_timestamp(),
						nm_usuario_p,						
						qt_material_w,
						cd_unidade_medida_w,
						cd_setor_atendimento_w,
						cd_intervalo_w);

					ie_inseriu_w	:= true;
			
				elsif (ie_inseriu_w = true) then

					qt_dias_utilizacao_w	:= pkg_date_utils.get_time(dt_parametro_w,0,0,0) - pkg_date_utils.get_time(dt_inicial_utilizacao_w,0,0,0);
					
					if (qt_dias_utilizacao_w <= qt_dia_terapeutico_w) then
						ie_tipo_utilizacao_w	:= 1;
					else
						ie_tipo_utilizacao_w	:= 2;
					end if;
					
					if (ie_regra_uso_w = 'S') then
					
						ie_tipo_utilizacao_w := cih_obter_tipo_util(cd_material_w);
						
					
						
						if (coalesce(ie_tipo_utilizacao_w::text, '') = '') then
							if (qt_dias_utilizacao_w <= qt_dia_terapeutico_w) then
								ie_tipo_utilizacao_w	:= 1;
							else
								ie_tipo_utilizacao_w	:= 2;
							end if;
						end if;
					
					end if;

					update cih_medic_utilizado
					set	dt_final_utilizacao 	= dt_final_utilizacao_ww,						
						qt_dose 		= qt_dose + qt_material_w,
						cd_unidade_medida	= cd_unidade_medida_w,
						ie_tipo_utilizacao  	= CASE WHEN ie_import_uso_prescricao_w='S' THEN  CASE WHEN ie_objetivo_w='C' THEN  3 WHEN ie_objetivo_w='D' THEN  4 WHEN ie_objetivo_w='E' THEN  5 WHEN ie_objetivo_w='F' THEN  1 WHEN ie_objetivo_w='N' THEN  7 WHEN ie_objetivo_w='P' THEN  6 WHEN ie_objetivo_w='T' THEN  2  ELSE ie_tipo_utilizacao END   ELSE ie_tipo_utilizacao_w END
					where  	nr_ficha_ocorrencia 	= nr_ficha_ocorrencia_p
					and    	nr_seq_medicamento  	= nr_seq_medicamento_w;
						
				end if;

				
			
			end if;
			OPEN C07;
			LOOP
			FETCH C07 into
				nr_seq_interno_prescr_w;
			EXIT WHEN NOT FOUND; /* apply on c07 */
			
			select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ie_existe_w
			from	cih_medic_utilizado_paciente
			where	NR_FICHA_OCORRENCIA 	= nr_ficha_ocorrencia_p
			and	NR_SEQ_MEDIC_UTILIZADO	= nr_seq_medicamento_w
			and	nr_seq_interno_prescr 	= nr_seq_interno_prescr_w;

			if (ie_existe_w = 'N') then
			
				select	coalesce(max(nr_sequencia),0) + 1
				into STRICT	nr_seq_cih_util_paciente_w
				from 	cih_medic_utilizado_paciente;
				
				insert into cih_medic_utilizado_paciente(nr_sequencia,
					nr_ficha_ocorrencia,
					nr_seq_medic_utilizado,
					nr_seq_interno_prescr,
					dt_atualizacao,
					nm_usuario)
				values (
					nr_seq_cih_util_paciente_w,
					nr_ficha_ocorrencia_p,
					nr_seq_medicamento_w,
					nr_seq_interno_prescr_w,
					clock_timestamp(),
					nm_usuario_p);
			end if;
			END LOOP;
			CLOSE C07;

			dt_parametro_w := dt_parametro_w +1;

			end;
			
			
		end loop;
		end;
	end loop;
	close C06;
end if;

select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
into STRICT	ie_existe_w
from	cih_medic_utilizado
where	1 = 1
and	nr_ficha_ocorrencia = nr_ficha_ocorrencia_p
and	cd_medicamento = cd_medicamento_w
and	dt_inicial_utilizacao = dt_inicial_utilizacao_w;

if (ie_antimicrobiano_w = 'S') then

open C08;
loop
fetch C08 into			
	cd_medicamento_w,
	dt_inicial_utilizacao_w,
	dt_final_utilizacao_w,
	qt_dia_profilatico_w,
	qt_dia_terapeutico_w,
	cd_unidade_medida_dose_w,
	ie_objetivo_w;
EXIT WHEN NOT FOUND; /* apply on C08 */
	begin	
		select	coalesce(max(nr_seq_medicamento),0) + 1
		into STRICT	nr_seq_medicamento_w
		from	cih_medic_utilizado
		where	nr_ficha_ocorrencia = nr_ficha_ocorrencia_p;
		
		if (dt_parametro_w IS NOT NULL AND dt_parametro_w::text <> '') and (dt_inicial_utilizacao_w IS NOT NULL AND dt_inicial_utilizacao_w::text <> '') then
			qt_dias_utilizacao_w	:= pkg_date_utils.get_time(dt_parametro_w,0,0,0) - pkg_date_utils.get_time(dt_inicial_utilizacao_w,0,0,0);
		end if;	
						
		if (qt_dias_utilizacao_w <= qt_dia_terapeutico_w) then
			ie_tipo_utilizacao_w	:= 2;
		else
			ie_tipo_utilizacao_w	:= 1;
		end if;
						
		if (ie_regra_uso_w = 'S') then
			ie_tipo_utilizacao_w := cih_obter_tipo_util(cd_material_w);
			if (coalesce(ie_tipo_utilizacao_w::text, '') = '') then
				if (qt_dias_utilizacao_w <= qt_dia_terapeutico_w) then
					ie_tipo_utilizacao_w	:= 2;
				else
					ie_tipo_utilizacao_w	:= 1;
				end if;
			end if;
		end if;	
								
	select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_existe_w
	from	cih_medic_utilizado
	where	1 = 1
	and	nr_ficha_ocorrencia = nr_ficha_ocorrencia_p
	and	cd_medicamento = cd_medicamento_w
	and	dt_inicial_utilizacao = dt_inicial_utilizacao_w;

	if (ie_existe_w = 'N')	 then

		insert into CIH_Medic_Utilizado(
			nr_ficha_ocorrencia,
			nr_seq_medicamento,
			cd_medicamento,
			cd_clinica,
			dt_inicial_utilizacao,
			dt_final_utilizacao,
			ie_tipo_utilizacao,
			dt_atualizacao,
			nm_usuario,
			qt_dose,					
			cd_unidade_medida)
		values (
			nr_ficha_ocorrencia_p,
			nr_seq_medicamento_w,
			cd_medicamento_w,
			cd_clinica_w,
			dt_inicial_utilizacao_w,
			dt_final_utilizacao_w,
			CASE WHEN ie_import_uso_prescricao_w='S' THEN  CASE WHEN ie_objetivo_w='C' THEN  3 WHEN ie_objetivo_w='D' THEN  4 WHEN ie_objetivo_w='E' THEN  5 WHEN ie_objetivo_w='F' THEN  1 WHEN ie_objetivo_w='N' THEN  7 WHEN ie_objetivo_w='P' THEN  6 WHEN ie_objetivo_w='T' THEN  2  ELSE ie_tipo_utilizacao_w END   ELSE ie_tipo_utilizacao_w END ,
			clock_timestamp(),
			nm_usuario_p,
			qt_material_w,
			cd_unidade_medida_dose_w);						
	end if;	
	end;
end loop;
close C08;
end if;		


if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cih_importar_medicamento ( nr_ficha_ocorrencia_p bigint, nm_usuario_p text, ie_vincular_medic_conta_p text, nr_atendimento_p bigint default null) FROM PUBLIC;

