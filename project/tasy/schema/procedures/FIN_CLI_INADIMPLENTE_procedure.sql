-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fin_cli_inadimplente ( nr_seq_lote_p bigint default 0, ie_opcao_p text DEFAULT NULL, nm_usuario_p text DEFAULT NULL) AS $body$
DECLARE


cd_cnpj_w		varchar(14);
ie_situacao_w		varchar(1);
nr_seq_cliente_w	bigint;
nr_seq_inad_w		bigint;
qt_cliente_w		bigint;

c01 CURSOR FOR
SELECT	distinct
	a.nr_seq_cliente
from	fin_titulo_lote_clie a
where	a.nr_lote_cliente = nr_seq_lote_p;


BEGIN
if (ie_opcao_p = 'L') then -- Limpar
	begin
	delete
	from	fin_cliente_inadimplente;
	end;
elsif (ie_opcao_p = 'M') then -- Menssagem
	begin
	open C01;
	loop
	fetch C01 into
		nr_seq_cliente_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		select	max(a.cd_cnpj)
		into STRICT	cd_cnpj_w
		from	com_cliente a
		where	a.nr_sequencia = nr_seq_cliente_w;

		select	count(*)
		into STRICT	qt_cliente_w
		from	fin_cliente_inadimplente a
		where	a.cd_cnpj = cd_cnpj_w;

		if (coalesce(qt_cliente_w,0) = 0) then
			begin
			insert into fin_cliente_inadimplente(	nr_sequencia,
								cd_cnpj,
								dt_atualizacao,
								dt_atualizacao_nrec,
								ie_atualizar_versao,
								ie_comunicado,
								ie_situacao,
								nm_usuario,
								nm_usuario_nrec)
							values (	nextval('fin_cliente_inadimplente_seq'),
								cd_cnpj_w,
								clock_timestamp(),
								clock_timestamp(),
								'C',
								null,
								'A',
								nm_usuario_p,
								nm_usuario_p);
			end;
		end if;
		end;
	end loop;
	close C01;
	end;
elsif (ie_opcao_p = 'B') then -- Bloqueio
	begin
	open C01;
	loop
	fetch C01 into
		nr_seq_cliente_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		select	max(a.cd_cnpj)
		into STRICT	cd_cnpj_w
		from	com_cliente a
		where	a.nr_sequencia = nr_seq_cliente_w;

		select	count(*)
		into STRICT	qt_cliente_w
		from	fin_cliente_inadimplente a
		where	a.cd_cnpj = cd_cnpj_w;

		if (coalesce(qt_cliente_w,0) = 0) then
			begin
			insert into fin_cliente_inadimplente(	nr_sequencia,
								cd_cnpj,
								dt_atualizacao,
								dt_atualizacao_nrec,
								ie_atualizar_versao,
								ie_comunicado,
								ie_situacao,
								nm_usuario,
								nm_usuario_nrec)
							values (	nextval('fin_cliente_inadimplente_seq'),
								cd_cnpj_w,
								clock_timestamp(),
								clock_timestamp(),
								'R',
								null,
								'A',
								nm_usuario_p,
								nm_usuario_p);
			end;
		elsif (coalesce(qt_cliente_w,0) > 0) then
			begin
			update	fin_cliente_inadimplente
			set	ie_situacao = 'A',
				dt_atualizacao = clock_timestamp(),
				nm_usuario = nm_usuario_p,
				ie_atualizar_versao = 'R'
			where	cd_cnpj = cd_cnpj_w;
			end;
		end if;
		end;
	end loop;
	close C01;
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fin_cli_inadimplente ( nr_seq_lote_p bigint default 0, ie_opcao_p text DEFAULT NULL, nm_usuario_p text DEFAULT NULL) FROM PUBLIC;

