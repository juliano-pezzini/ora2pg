-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--
-- dblink wrapper to call function aghos_verifica_solicitacoes as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE PROCEDURE aghos_verifica_solicitacoes (cd_estabelecimento_p bigint default 1) AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

BEGIN
	v_query := 'CALL aghos_verifica_solicitacoes_atx ( ' || quote_nullable(cd_estabelecimento_p) || ' )';
	PERFORM * FROM dblink(v_conn_str, v_query) AS p (ret boolean);

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE PROCEDURE aghos_verifica_solicitacoes_atx (cd_estabelecimento_p bigint default 1) AS $body$
DECLARE


cd_pessoa_fisica_w		varchar(10);
cd_estabelecimento_w		bigint;

nr_seq_internacao_aghos_w 	bigint := 0;
ie_status_w 			varchar(1) := 'A';
ds_erro_w 			varchar(500);
dt_integracao_w			timestamp := clock_timestamp();
ds_usuario_w 			varchar(15);
cd_cnes_solicitante_w 		integer;
nr_prontuario_w			integer;
ds_nome_paciente_w 		varchar(60);
dt_nascimento_w			timestamp;
ie_sexo_w 			smallint;
ie_estado_civil_w 		smallint;
ds_nome_mae_w 			varchar(60);
ds_nome_pai_w 			varchar(60);
cd_cep_w 			integer;
nr_endereco_w			bigint;
ds_complemento_w		varchar(100);
cd_ocupacao_cbo_w		varchar(6);
ie_cor_raca_w 			smallint;
cd_naturalidade_w		integer;
cd_nacionalidade_w 		integer;
nr_identidade_w			varchar(20);
nr_cpf_w			bigint;
nr_cartao_sus_w			bigint;
nr_internacao_w			integer;
ie_prioridade_w			smallint;
nr_cpf_medico_solicitante_w 	bigint;
cd_procedimento_unificado_w 	bigint;
cd_cid_w			varchar(4);
ds_laudo_sinais_sintomas_w 	varchar(1000);
ds_laudo_justificativa_w	varchar(1000);
ds_laudo_result_diagnostico_w 	varchar(1000);
ie_uti_w 			smallint;
ds_prontuario_solicitante_w 	varchar(11);

ds_sep_bv_w			varchar(50);
ds_comando_w			varchar(2000);

ie_integracao_aghos_w	varchar(1);
BEGIN

ie_integracao_aghos_w := obter_dados_param_atend(cd_estabelecimento_p, 'AG');

If (ie_integracao_aghos_w = 'S') then

	ds_sep_bv_w  := obter_separador_bv;

	ds_comando_w := null;
	ds_comando_w :=	'declare '||
			' solici_sai gsh_i_pkg_integra_sai.solici_sai@tasy_aghos; '||
			' ds_erro_ww varchar2(500); '||
			' cd_cgc_w varchar2(14); '||
			' nr_seq_solicitacao_w	number(10); '||
			' var_teste_w varchar2(10); '||
			'begin '||
			'   begin ' ||
			' gsh_i_pkg_integra_sai.gsh_i_prc_intern_solici_sai@tasy_aghos(solici_sai); '||
			' '||
			' if (solici_sai.first is not null) then '||
			' for i in solici_sai.first..solici_sai.last loop '||
			' '||
			' begin '||
			' select nr_sequencia '||
			' into nr_seq_solicitacao_w '||
			' from solicitacao_tasy_aghos '||
			' where	nr_internacao = solici_sai(i).idf_internacao '||
			' and rownum = 1; '||
			' exception '||
			' when no_data_found then '||
			' nr_seq_solicitacao_w := 0; '||
			' end; '||
			' '||
			' If (nr_seq_solicitacao_w = 0) then '||
			' '||
			' insert into solicitacao_tasy_aghos ( '||
			'nr_sequencia, '||
			'dt_atualizacao, '||
			'nm_usuario, '||
			'dt_atualizacao_nrec, '||
			'nm_usuario_nrec, '||
			'nr_internacao, '||
			'ie_urgencia, '||
			'nr_seq_laudo, '||
			'nr_atend_original, '||
			'ie_situacao , '||
			'ie_motivo_rejeicao, '||
			'nr_atendimento, '||
			'ie_erro, '||
			'ds_erro, '||
			'ds_motivo_situacao, '||
			'cd_cgc, '||
			'nm_paciente) '||
			' values (solicitacao_tasy_aghos_seq.nextval, '||
			'sysdate, '||
			'''Aghos'', '||
			'solici_sai(i).dat_integracao, '||
			'''Aghos'', '||
			'solici_sai(i).idf_internacao, '||
			'solici_sai(i).idf_prioridade, '||
			'null, '||
			'null, '||
			'''A'', '||
			'null, '||
			'null, '||
			'decode(solici_sai(i).des_erro, null, ''N'', ''S''), '||
			'solici_sai(i).des_erro, '||
			'''Solicitação de outra instituição'', '||
			'null, '||
			'solici_sai(i).des_nome_paciente); '||
			' '||
			' commit; '||
			' '||
			' gsh_i_prc_intern_solici_s_u@tasy_aghos(	solici_sai(i).idf_gsh_i_intern_solici_sai,  '||
			'						''P'', '||
			'						ds_erro_ww); '||
			' end if; '||
			' end loop; '||
			' end if; '||
			' commit; '||
			' DBMS_SESSION.CLOSE_DATABASE_LINK(''tasy_aghos''); ' ||
			' exception '||
			' when others then '||
			' rollback; ' ||
			' DBMS_SESSION.CLOSE_DATABASE_LINK(''tasy_aghos''); ' ||
			' end; '||
			'end;';

	CALL exec_sql_dinamico('AGHOS', ds_comando_w);

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE aghos_verifica_solicitacoes (cd_estabelecimento_p bigint default 1) FROM PUBLIC; -- REVOKE ALL ON PROCEDURE aghos_verifica_solicitacoes_atx (cd_estabelecimento_p bigint default 1) FROM PUBLIC;

