-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alimenta_estab_cta_exc () AS $body$
DECLARE


tb_nr_sequencia_w	pls_util_cta_pck.t_number_table;
tb_cd_estab_w		pls_util_cta_pck.t_varchar2_table_5;

nr_seq_ini_w		pls_conta_exclusao.nr_sequencia%type;
nr_seq_fim_w		pls_conta_exclusao.nr_sequencia%type;
nr_seq_min_w		pls_conta_exclusao.nr_sequencia%type;
nr_seq_max_w		pls_conta_exclusao.nr_sequencia%type;
cd_estabelecimento_w	pls_conta_exclusao.cd_estabelecimento%type;
ie_finaliza_w		varchar(1);
j			integer;

C01 CURSOR(	nr_seq_ini_pc	pls_conta_exclusao.nr_sequencia%type,
		nr_seq_fim_pc	pls_conta_exclusao.nr_sequencia%type) FOR
	SELECT	nr_sequencia
	from	pls_conta_exclusao
	where	nr_sequencia between nr_seq_ini_pc and nr_seq_fim_pc
	and	coalesce(cd_estabelecimento::text, '') = '';

BEGIN
CALL exec_sql_dinamico('Tasy',' alter trigger PLS_CONTA_EXCLUSAO_DELETE disable ');

j := 0;
ie_finaliza_w := 'N';

select	pls_obter_cd_estab_ops
into STRICT	cd_estabelecimento_w
;

select	coalesce(min(nr_sequencia),0),
	coalesce(max(nr_sequencia),0)
into STRICT	nr_seq_min_w,
	nr_seq_max_w
from	pls_conta_exclusao
where	coalesce(cd_estabelecimento::text, '') = '';

nr_seq_ini_w := nr_seq_min_w;
nr_seq_fim_w := nr_seq_ini_w + 500;

loop
	for r_C01_w in C01(nr_seq_ini_w, nr_seq_fim_w) loop
		tb_nr_sequencia_w(j) := r_C01_w.nr_sequencia;
		tb_cd_estab_w(j) := cd_estabelecimento_w;

		if (tb_nr_sequencia_w.count >= pls_util_pck.qt_registro_transacao_w) then
			forall i in tb_nr_sequencia_w.first .. tb_nr_sequencia_w.last
				update	pls_conta_exclusao set
					cd_estabelecimento = tb_cd_estab_w(i)
				where	nr_sequencia = tb_nr_sequencia_w(i);
			commit;

			tb_nr_sequencia_w.delete;
			tb_cd_estab_w.delete;
			j := 0;
		else
			j := j + 1;
		end if;
	end loop;

	nr_seq_ini_w := nr_seq_fim_w + 1;
	nr_seq_fim_w := nr_seq_ini_w + 500;

	if (nr_seq_ini_w > nr_seq_max_w) then
		ie_finaliza_w := 'S';
	end if;
exit when
	ie_finaliza_w = 'S';
end loop;

if (tb_nr_sequencia_w.count > 0) then
	forall i in tb_nr_sequencia_w.first .. tb_nr_sequencia_w.last
		update	pls_conta_exclusao set
			cd_estabelecimento = tb_cd_estab_w(i)
		where	nr_sequencia = tb_nr_sequencia_w(i);
	commit;
end if;

CALL exec_sql_dinamico('Tasy',' alter trigger PLS_CONTA_EXCLUSAO_DELETE enable ');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alimenta_estab_cta_exc () FROM PUBLIC;

