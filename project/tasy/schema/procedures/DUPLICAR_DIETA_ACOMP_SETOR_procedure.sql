-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicar_dieta_acomp_setor ( cd_refeicao_p text, cd_setor_atendimento_p bigint, dt_dieta_p timestamp, cd_dieta_acomp_p bigint, nm_usuario_p text) AS $body$
DECLARE

nr_sequencia_w		bigint;
ie_gerar_uti_w		varchar(01);

C01 CURSOR FOR 
SELECT	a.nr_sequencia 
from	setor_atendimento b, 
	mapa_dieta a 
where	a.cd_setor_atendimento		= b.cd_setor_atendimento 
and	((ie_gerar_uti_w = 'S') or (b.cd_classif_setor <> '4')) 
and	a.cd_refeicao			= cd_refeicao_p 
and	((a.cd_setor_atendimento		= cd_setor_atendimento_p) or (cd_setor_atendimento_p = 0)) 
and	a.dt_dieta			= dt_dieta_p 
and	coalesce(a.nr_seq_superior::text, '') = '' 
and not exists (	SELECT		1 
		from		mapa_dieta b 
		where		b.cd_refeicao 		= cd_refeicao_p 
		and		b.cd_setor_atendimento 	= a.cd_setor_atendimento 
		and		b.dt_dieta 		= dt_dieta_p 
		and		b.cd_pessoa_fisica		= a.cd_pessoa_fisica 
		and		b.ie_destino_dieta		= 'A');


BEGIN 
 
select	coalesce(obter_valor_param_usuario(1000, 24, Obter_Perfil_Ativo, nm_usuario_p, 1),'S') 
into STRICT	ie_gerar_uti_w
;
 
OPEN C01;
LOOP 
FETCH C01 into 
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	CALL duplicar_dieta_acomp(nr_sequencia_w, 'A', nm_usuario_p, cd_dieta_acomp_p);
	end;
END LOOP;
CLOSE C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_dieta_acomp_setor ( cd_refeicao_p text, cd_setor_atendimento_p bigint, dt_dieta_p timestamp, cd_dieta_acomp_p bigint, nm_usuario_p text) FROM PUBLIC;

