-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE executar_material_lib_prescr ( nr_prescricao_p bigint, nm_usuario_p text, ie_lib_medico_p text, ie_lib_enfermeiro_p text) AS $body$
DECLARE


cd_grupo_material_w			bigint;
cd_subgrupo_material_w		bigint;
cd_classe_material_w		bigint;
cd_material_w				bigint;
cd_setor_atendimento_w		bigint;
cd_estabelecimento_w		smallint;
ie_liberar_w				bigint;
nr_seq_mat_atend_w			bigint;
nr_seq_atepacu_w			bigint;
nr_atendimento_w			bigint;
cd_unidade_medida_w			varchar(30);
qt_material_w				double precision;
ie_consistido_agenda_w		varchar(30);
dt_prescricao_w				timestamp;
cd_local_estoque_w			smallint;
nr_sequencia_w				integer;
dt_entrada_unidade_w		timestamp;
cd_convenio_w				integer;
cd_convenio_final_w			integer;
cd_categoria_w				varchar(10);
cd_categoria_final_w		varchar(10);
nr_doc_convenio_w			varchar(20);
ie_tipo_guia_w				varchar(2);
ie_urgencia_w				varchar(1);
nr_seq_motivo_baixa_w		bigint;
cd_tipo_baixa_w				bigint;
dt_lib_w					timestamp;
ie_atualiza_estoque_w		varchar(1);
ie_conta_paciente_w			varchar(1);
cd_senha_w					varchar(20);
nr_seq_proc_w				integer;
cd_unidade_medida_dose_w	varchar(30);
ie_acm_w					varchar(1);
ie_sn_w						varchar(1);
cd_kit_material_w			integer;
nr_sequencia_solucao_w		integer;
nr_seq_kit_w				integer;
ie_considera_setor_proc_w	varchar(1);
ie_cobrar_diluicao_w		varchar(1);
cd_perfil_w					integer;
ie_agrupador_w				integer;
ie_prescr_emergencia_w		varchar(1);
dt_item_w					timestamp;
dt_entrada_pac_w			timestamp;
ie_data_prescricao_w		varchar(1);
nr_sequencia_diluicao_w		integer;
cd_motivo_baixa_w			smallint;
dt_liberacao_enfermagem_w	timestamp;
dt_liberacao_medico_w		timestamp;
nr_seq_sub_protocolo_w		bigint;
cd_protocolo_w				bigint;
dt_inicio_prescr_w			timestamp;
ie_motivo_prescricao_w		varchar(3);
nr_seq_lote_fornec_w		bigint;
nr_seq_atend_futuro_w		bigint;
cd_funcao_origem_w			prescr_medica.cd_funcao_origem%type;
cd_cgc_fornecedor_w			prescr_material.cd_fornec_consignado%type;
ie_rastre_prescr_libfarm_w	varchar(1);
ds_log_w                varchar(100);
ie_regra_uso_mat_w      regra_exec_lib_prescr_mat.ie_regra_uso%type;
ie_acao_excesso_w       convenio_regra_qtde_mat.ie_acao_excesso%type;
qt_excedida_w           double precision	:= 0;
nr_seq_regra_uso_mat_w  bigint;
ds_erro_uso_w		varchar(255);
cd_plano_w	        atend_categoria_convenio.cd_plano_convenio%type;
nr_seq_excedido_w	material_atend_paciente.nr_sequencia%type;
nr_conta_w		material_atend_paciente.nr_interno_conta%type;
cd_motivo_exc_conta_w	parametro_faturamento.cd_motivo_exc_conta%type;
ds_texto_w		varchar(255);
cd_convenio_glosa_w	convenio.cd_convenio_glosa%type;
cd_categoria_glosa_w	convenio.cd_categoria_glosa%type;
ie_valor_informado_w	material_atend_paciente.ie_valor_informado%type := 'N';

C01 CURSOR FOR	
	SELECT	a.nr_atendimento,
			b.cd_material,
			b.cd_unidade_medida,
			coalesce(b.qt_total_dispensar,1),
			a.dt_prescricao,
			b.nr_sequencia,
			coalesce(b.cd_local_estoque, c.cd_local_estoque),
			a.cd_setor_atendimento,
			coalesce(a.CD_ESTABELECIMENTO,1),
			obter_convenio_atendimento(a.nr_atendimento),
			obter_categoria_atendimento(a.nr_atendimento),
			b.nr_sequencia_proc,
			coalesce(b.cd_unidade_medida_dose,'0'),
			coalesce(b.ie_acm,'N'),
			coalesce(b.ie_se_necessario,'N'),
			b.cd_kit_material,
			b.nr_sequencia_solucao,
			b.nr_seq_kit,
			b.ie_agrupador,
			coalesce(a.ie_prescr_emergencia,'N'),
			b.dt_liberacao,
			coalesce(b.ie_consistido_agenda,'N'),
			coalesce(b.nr_sequencia_diluicao,0) nr_sequencia_diluicao,
			coalesce(b.ie_urgencia,'N'),
			a.dt_liberacao,
			a.dt_liberacao_medico,
			b.cd_protocolo,
			b.nr_seq_protocolo,
			a.dt_inicio_prescr,
			b.nr_seq_lote_fornec,
			a.nr_seq_atend_futuro,
			b.cd_fornec_consignado,
                        obter_plano_atendimento(a.nr_atendimento, 'C')
	from	setor_atendimento c,
			prescr_material b,
			prescr_medica a
	where	a.nr_prescricao	= b.nr_prescricao
	and		a.cd_setor_atendimento	= c.cd_setor_atendimento
	and		coalesce(b.cd_motivo_baixa,0) = 0
	and		a.nr_prescricao = nr_prescricao_p
	order by nr_sequencia_diluicao;

c02 CURSOR FOR
	SELECT	cd_tipo_baixa,
		ie_cobrar_diluicao,
                ie_regra_uso
	from	regra_exec_lib_prescr_mat a
	where	coalesce(cd_grupo_material, coalesce(cd_grupo_material_w,0))		= coalesce(cd_grupo_material_w,0)
	and		coalesce(cd_subgrupo_material, coalesce(cd_subgrupo_material_w,0))	= coalesce(cd_subgrupo_material_w,0)
	and		coalesce(cd_classe_material, coalesce(cd_classe_material_w,0))		= coalesce(cd_classe_material_w,0)
	and		((coalesce(cd_material, coalesce(cd_material_w,0))			= coalesce(cd_material_w,0)) or (exists (	SELECT	1
						from	regra_exec_lib_prescr_dil b
						where	a.nr_sequencia	= b.nr_seq_regra
						and		b.cd_material	= cd_material_w
						and		ie_agrupador_w	in (3,7,9)
						and		cd_motivo_baixa_w > 0)))
	and		((coalesce(cd_setor_atendimento, coalesce(cd_setor_atendimento_w, 0))	= coalesce(cd_setor_atendimento_w,0)) and (not exists (	select	1
							from	rep_excluir_mat_conta c
							where	c.cd_setor_atendimento = cd_setor_atendimento_w
							and		c.nr_seq_regra = a.nr_sequencia)))
	and		coalesce(cd_convenio, coalesce(cd_convenio_w,0)) = coalesce(cd_convenio_w,0)
	and		coalesce(cd_unidade_medida_dose, coalesce(cd_unidade_medida_dose_w,'0'))  = coalesce(cd_unidade_medida_dose_w,'0')
	and		coalesce(cd_kit_material, coalesce(cd_kit_material_w,0))  		= coalesce(cd_kit_material_w,0)
	and		((coalesce(ie_acm, 'A') = 'A') or ( coalesce(ie_acm, 'A') = ie_acm_w))
	and		((coalesce(ie_sn, 'A') = 'A') or ( coalesce(ie_sn, 'A') = ie_sn_w))
	and		((coalesce(ie_urgencia, 'A') = 'A') or ( coalesce(ie_urgencia, 'A') = ie_urgencia_w))
	and		coalesce(cd_perfil, coalesce(cd_perfil_w,0)) = coalesce(cd_perfil_w,0)
	and		((coalesce(ie_consistido_agenda,'N') = 'N') or (ie_consistido_agenda = ie_consistido_agenda_w))
	and		((coalesce(nr_seq_estrutura::text, '') = '') or (consistir_se_mat_estrutura(nr_seq_estrutura,cd_material_w) = 'S'))
	and		((((nr_seq_sub_protocolo = nr_seq_sub_protocolo_w) or (coalesce(nr_seq_sub_protocolo::text, '') = '')) and (cd_protocolo = cd_protocolo_w)) or (coalesce(cd_protocolo::text, '') = ''))
	and		(((coalesce(ie_liberacao,'S') = 'E') and (ie_lib_enfermeiro_p = 'S')) or (coalesce(ie_liberacao,'S') = 'S') and (coalesce(coalesce(dt_liberacao_medico_w,dt_liberacao_enfermagem_w)::text, '') = ''))
	and		cd_estabelecimento = cd_estabelecimento_w
	and		coalesce(ie_motivo_prescricao,coalesce(ie_motivo_prescricao_w,'XXX'))	= coalesce(ie_motivo_prescricao_w,'XXX')
	order by	coalesce(cd_material, 0),
				coalesce(cd_classe_material, 0),
				coalesce(cd_subgrupo_material, 0),
				coalesce(cd_grupo_material, 0),	
				coalesce(nr_seq_estrutura,0),
				coalesce(cd_unidade_medida_dose,'0'),
				coalesce(cd_kit_material,0),
				coalesce(cd_setor_atendimento, 0),
				coalesce(cd_convenio,0),
				coalesce(cd_unidade_medida_dose,'0'),
				coalesce(cd_perfil,0);

c03 CURSOR FOR
SELECT	dt_entrada_unidade,
		nr_seq_interno
from 	atend_paciente_unidade
where 	nr_atendimento		= nr_atendimento_w
and		cd_setor_atendimento	= cd_setor_atendimento_w
order by dt_entrada_unidade;


BEGIN
ie_considera_setor_proc_w := Obter_Param_Usuario(924, 624, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_considera_setor_proc_w);
ie_data_prescricao_w:=  coalesce(Obter_valor_param_usuario(924, 759, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento),'N');
ie_rastre_prescr_libfarm_w := obter_se_info_rastre_prescr('RLA', nm_usuario_p, obter_perfil_ativo, wheb_usuario_pck.get_cd_estabelecimento);

if (ie_rastre_prescr_libfarm_w = 'S') then
	CALL gerar_log_prescr_mat(nr_prescricao_p, null, null, null, null, 'EXECUTAR_MATERIAL_LIB_PRESCR LOG - chegou na rotina'
    ,nm_usuario_p, 'N');
end if;

select	max(ie_motivo_prescricao),
		max(cd_funcao_origem)
into STRICT 	ie_motivo_prescricao_w,
		cd_funcao_origem_w
from	prescr_medica a
where 	a.nr_prescricao = nr_prescricao_p;

if (ie_rastre_prescr_libfarm_w = 'S') then
  ds_log_w := 'EXECUTAR_MATERIAL_LIB_PRESCR LOG - ';
  select ds_log_w || coalesce(max('Nao possui setor'), 'possui setor')
  into STRICT  ds_log_w
  from	prescr_medica a
  where	a.nr_prescricao	= nr_prescricao_p
  and		coalesce(a.cd_setor_atendimento::text, '') = '';

  select ds_log_w || coalesce(max(' Possui motivo baixa'), ' Nao possui motivo baixa')
  into STRICT  ds_log_w
  from	prescr_material a
  where	a.nr_prescricao	= nr_prescricao_p
  and		coalesce(a.cd_motivo_baixa, 0)	<> 0;

	CALL gerar_log_prescr_mat(nr_prescricao_p, null, null, null, null, ds_log_w
    ,nm_usuario_p, 'N');
end if;

open c01;
loop
fetch c01 into	nr_atendimento_w,
				cd_material_w,
				cd_unidade_medida_w,
				qt_material_w,
				dt_prescricao_w,
				nr_sequencia_w,
				cd_local_estoque_w,
				cd_setor_atendimento_w,
				cd_estabelecimento_w,
				cd_convenio_w,
				cd_categoria_w,
				nr_seq_proc_w,
				cd_unidade_medida_dose_w,
				ie_acm_w,
				ie_sn_w,
				cd_kit_material_w,
				nr_sequencia_solucao_w,
				nr_seq_kit_w,
				ie_agrupador_w,
				ie_prescr_emergencia_w,
				dt_lib_w,
				ie_consistido_agenda_w,
				nr_sequencia_diluicao_w,
				ie_urgencia_w,
				dt_liberacao_enfermagem_w,
				dt_liberacao_medico_w,
				cd_protocolo_w,
				nr_seq_sub_protocolo_w,
				dt_inicio_prescr_w,
				nr_seq_lote_fornec_w,
				nr_seq_atend_futuro_w,
				cd_cgc_fornecedor_w,
                                cd_plano_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

        select 	max(cd_motivo_exc_conta)
        into STRICT	cd_motivo_exc_conta_w
        from	parametro_faturamento
        where	cd_estabelecimento = cd_estabelecimento_w;

  if (ie_rastre_prescr_libfarm_w = 'S') then
	CALL gerar_log_prescr_mat(nr_prescricao_p, null, null, null, null, 'EXECUTAR_MATERIAL_LIB_PRESCR LOG - abriu C01 material: ' || obter_desc_material(cd_material_w)
    ,nm_usuario_p, 'N');
end if;
	if (coalesce(nr_atendimento_w,0) = 0) and (nr_seq_atend_futuro_w IS NOT NULL AND nr_seq_atend_futuro_w::text <> '') then
		select	max(nr_atend_origem)
		into STRICT	nr_atendimento_w
		from	atend_pac_futuro
		where	nr_sequencia = nr_seq_atend_futuro_w;
	end if;
	
	if (coalesce(nr_atendimento_w,0) > 0) then
		select 	coalesce(max(dt_entrada),clock_timestamp())
		into STRICT	dt_entrada_pac_w
		from 	atendimento_paciente
		where 	nr_atendimento = nr_atendimento_w;
	end if;

	if (nr_seq_kit_w IS NOT NULL AND nr_seq_kit_w::text <> '') then
		select	max(nr_sequencia_solucao),
				coalesce(max(ie_acm), 'N'),
				coalesce(max(ie_se_necessario), 'N')
		into STRICT	nr_sequencia_solucao_w,
				ie_acm_w,
				ie_sn_w
		from	prescr_material
		where	nr_sequencia	= nr_seq_kit_w
		and		nr_prescricao	= nr_prescricao_p;
	end if;

	if (nr_sequencia_solucao_w IS NOT NULL AND nr_sequencia_solucao_w::text <> '') then
		select 	coalesce(max(ie_acm), 'N'),
				coalesce(max(ie_se_necessario), 'N')
		into STRICT 	ie_acm_w,
				ie_sn_w
		from	prescr_solucao
		where	nr_seq_solucao 	= nr_sequencia_solucao_w
		and		nr_prescricao	=	nr_prescricao_p;
	end if;
	
	select	cd_grupo_material,
			cd_subgrupo_material,
			cd_classe_material
	into STRICT	cd_grupo_material_W,
			cd_subgrupo_material_W,
			cd_classe_material_W
	from	estrutura_material_v
	where	cd_material	= cd_material_w;

	if (nr_seq_proc_w IS NOT NULL AND nr_seq_proc_w::text <> '') and (ie_considera_setor_proc_w = 'S') then
		select	coalesce(max(cd_setor_atendimento), cd_setor_atendimento_w)
		into STRICT	cd_setor_atendimento_w
		from	prescr_procedimento
		where	nr_prescricao = nr_prescricao_p
		and		nr_sequencia = nr_seq_proc_w;
	end if;

	nr_seq_motivo_baixa_w	:= 0;	
	
	select	obter_perfil_ativo
	into STRICT	cd_perfil_w
	;
	
	select	coalesce(max(cd_motivo_baixa),0)
	into STRICT	cd_motivo_baixa_w
	from	prescr_material
	where	nr_sequencia	= nr_sequencia_diluicao_w
	and		nr_prescricao	= nr_prescricao_p;
	
  if (ie_rastre_prescr_libfarm_w = 'S') then
	CALL gerar_log_prescr_mat(nr_prescricao_p, null, null, null, null, 'EXECUTAR_MATERIAL_LIB_PRESCR LOG {'||chr(10)||
    '"cd_classe_material_w" : "'||cd_classe_material_w||'",'||chr(10)||
    '"cd_convenio_w" : "'||cd_convenio_w||'",'||chr(10)||
    '"cd_estabelecimento_w" : "'||cd_estabelecimento_w||'",'||chr(10)||
    '"cd_grupo_material_w" : "'||cd_grupo_material_w||'",'||chr(10)||
    '"cd_kit_material_w" : "'||cd_kit_material_w||'",'||chr(10)||
    '"cd_material_w" : "'||cd_material_w||'",'||chr(10)||
    '"cd_motivo_baixa_w" : "'||cd_motivo_baixa_w||'",'||chr(10)||
    '"cd_perfil_w" : "'||cd_perfil_w||'",'||chr(10)||
    '"cd_protocolo_w" : "'||cd_protocolo_w||'",'||chr(10)||
    '"cd_setor_atendimento_w" : "'||cd_setor_atendimento_w||'",'||chr(10)||
    '"cd_subgrupo_material_w" : "'||cd_subgrupo_material_w||'",'||chr(10)||
    '"cd_unidade_medida_dose_w" : "'||cd_unidade_medida_dose_w||'",'||chr(10)||
    '"dt_liberacao_enfermagem_w" : "'||to_char(dt_liberacao_enfermagem_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
    '"dt_liberacao_medico_w" : "'||to_char(dt_liberacao_medico_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
    '"ie_acm_w" : "'||ie_acm_w||'",'||chr(10)||
    '"ie_agrupador_w" : "'||ie_agrupador_w||'",'||chr(10)||
    '"ie_consistido_agenda_w" : "'||ie_consistido_agenda_w||'",'||chr(10)||
    '"ie_lib_enfermeiro_p" : "'||ie_lib_enfermeiro_p||'",'||chr(10)||
    '"ie_motivo_prescricao_w" : "'||ie_motivo_prescricao_w||'",'||chr(10)||
    '"ie_sn_w" : "'||ie_sn_w||'",'||chr(10)||
    '"ie_urgencia_w" : "'||ie_urgencia_w||'",'||chr(10)||
    '"nr_seq_sub_protocolo_w" : "'||nr_seq_sub_protocolo_w||'"}'
, nm_usuario_p, 'N');
end if;
	open	c02;
	loop
	fetch	c02 into
		nr_seq_motivo_baixa_w,
		ie_cobrar_diluicao_w,
                ie_regra_uso_mat_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		nr_seq_motivo_baixa_w	:= nr_seq_motivo_baixa_w;
		ie_cobrar_diluicao_w	:= ie_cobrar_diluicao_w;

		end;
	end loop;
	close c02;	
	
  if (ie_rastre_prescr_libfarm_w = 'S') then
	  CALL gerar_log_prescr_mat(nr_prescricao_p, null, null, null, null, 'EXECUTAR_MATERIAL_LIB_PRESCR LOG - nr_seq_motivo_baixa_w: ' || nr_seq_motivo_baixa_w ||
        ' ie_cobrar_diluicao_w: ' || ie_cobrar_diluicao_w ||
        ' ie_agrupador_w: ' || ie_agrupador_w ||
        ' nr_sequencia_w: ' || nr_sequencia_w ||
        ' cd_material_w: ' || cd_material_w
      ,nm_usuario_p, 'N');
  end if;

	if (ie_cobrar_diluicao_w = 'N') and (ie_agrupador_w in (3,7,9)) then
		nr_seq_motivo_baixa_w	:= 0;
	end if;
	
	if (nr_seq_motivo_baixa_w > 0) then	
		begin

		select	nextval('material_atend_paciente_seq')
		into STRICT	nr_seq_mat_atend_w
		;

		open C03;
		loop
		fetch C03 into	
			dt_entrada_unidade_w,
			nr_seq_atepacu_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			dt_entrada_unidade_w	:= dt_entrada_unidade_w;
			nr_seq_atepacu_w	:= nr_seq_atepacu_w;
			end;
		end loop;
		close C03;
		
		if (coalesce(nr_seq_atepacu_w,0) = 0) then
			begin
			select	max(Obter_Atepacu_paciente(nr_atendimento_w,'IAA'))
			into STRICT	nr_seq_atepacu_w
			;

			select	max(dt_entrada_unidade)
			into STRICT	dt_entrada_unidade_w
			from 	atend_paciente_unidade
			where 	nr_seq_interno = nr_seq_atepacu_w;
			end;
		end if;

		cd_convenio_final_w	:= cd_convenio_w;
		cd_categoria_final_w	:= cd_categoria_w;
		begin
		SELECT * FROM obter_convenio_execucao(nr_atendimento_w, clock_timestamp(), cd_convenio_w, cd_categoria_w, nr_doc_convenio_w, ie_tipo_guia_w, cd_senha_w) INTO STRICT cd_convenio_w, cd_categoria_w, nr_doc_convenio_w, ie_tipo_guia_w, cd_senha_w;
		exception when others then
			cd_convenio_w	:= cd_convenio_final_w;
			cd_categoria_w	:= cd_categoria_final_w;
		end;

    if (ie_rastre_prescr_libfarm_w = 'S') then
      CALL gerar_log_prescr_mat(nr_prescricao_p, null, null, null, null, 'EXECUTAR_MATERIAL_LIB_PRESCR LOG - cd_convenio_w: ' || cd_convenio_w || ' nr_seq_atepacu_w: ' || nr_seq_atepacu_w
        ,nm_usuario_p, 'N');
    end if;

		if (cd_convenio_w > 0) then
			select	cd_tipo_baixa,
					ie_atualiza_estoque,
					ie_conta_paciente
			into STRICT	cd_tipo_baixa_w,
					ie_atualiza_estoque_w,
					ie_conta_paciente_w
			from	tipo_baixa_prescricao	
			where	nr_sequencia	= nr_seq_motivo_baixa_w;

      if (ie_rastre_prescr_libfarm_w = 'S') then
        CALL gerar_log_prescr_mat(nr_prescricao_p, null, null, null, null, 'EXECUTAR_MATERIAL_LIB_PRESCR LOG - cd_tipo_baixa_w: ' || cd_tipo_baixa_w ||
          ' ie_atualiza_estoque_w: ' || ie_atualiza_estoque_w ||
          ' ie_conta_paciente_w: ' || ie_conta_paciente_w
          ,nm_usuario_p, 'N');
      end if;

			if (ie_atualiza_estoque_w = 'N') then
				cd_local_estoque_w	:= null;
			end if;
			
			
			if (ie_conta_paciente_w	= 'S') then
		
				dt_item_w := coalesce(dt_lib_w,clock_timestamp());
				if (ie_prescr_emergencia_w = 'S') and (ie_data_prescricao_w = 'S') then
					dt_item_w:= dt_prescricao_w;
				end if;
				
				if (ie_data_prescricao_w = 'P') then
					dt_item_w := dt_prescricao_w;
				end if;
				
				if (ie_data_prescricao_w = 'E') then
					dt_item_w:= dt_entrada_pac_w;
				end if;
				
				if (ie_data_prescricao_w = 'I') then
					dt_item_w:= dt_inicio_prescr_w;
				end if;
			
				if (coalesce(nr_seq_atepacu_w,0) = 0) and (cd_funcao_origem_w <> 2314) then
					CALL Wheb_mensagem_pck.exibir_mensagem_abort(257448);
				end if;
			
                                if (ie_regra_uso_mat_w = 'S') then
                                        SELECT * FROM obter_regra_uso_mat(nr_atendimento_w, cd_material_w, qt_material_w, cd_setor_atendimento_w, ie_acao_excesso_w, qt_excedida_w, nr_seq_regra_uso_mat_w, ds_erro_uso_w, cd_categoria_w, cd_plano_w, null, cd_cgc_fornecedor_w, dt_item_w, null, null) INTO STRICT ie_acao_excesso_w, qt_excedida_w, nr_seq_regra_uso_mat_w, ds_erro_uso_w;

                                        if (ie_acao_excesso_w = 'E') then
                                                if (qt_excedida_w   > 0) then
                                                        if 	((qt_material_w - qt_excedida_w) >= 0) then
                                                                nr_seq_excedido_w := inserir_material_atend_pac(nr_atendimento_w, null, cd_material_w, dt_item_w, cd_convenio_w, cd_categoria_w, nr_seq_atepacu_w, nm_usuario_p, qt_excedida_w, cd_local_estoque_w, '1', 'N', nr_seq_excedido_w, null, null);

                                                                CALL atualiza_preco_material(nr_seq_excedido_w, nm_usuario_p);

                                                                select 	max(nr_interno_conta)
                                                                into STRICT	nr_conta_w
                                                                from 	material_atend_paciente
                                                                where 	nr_sequencia = nr_seq_excedido_w;
                                                                ds_texto_w := substr(wheb_mensagem_pck.get_texto(306744),1,255);
                                                                CALL excluir_matproc_conta(nr_seq_excedido_w, nr_conta_w, coalesce(cd_motivo_exc_conta_w, 12), ds_texto_w, 'M', nm_usuario_p);

                                                                qt_material_w := qt_material_w - qt_excedida_w;
                                                        end if;
                                                end if;
                                        elsif (ie_acao_excesso_w = 'P') then
                                                SELECT * FROM obter_convenio_particular_pf(cd_estabelecimento_w, cd_convenio_w, null, dt_item_w, cd_convenio_glosa_w, cd_categoria_glosa_w) INTO STRICT cd_convenio_glosa_w, cd_categoria_glosa_w;

                                                if (qt_excedida_w   >= qt_material_w) then
                                                        cd_convenio_w		:= cd_convenio_glosa_w;
                                                        cd_categoria_w		:= cd_categoria_glosa_w;
                                                else
                                                        qt_material_w := qt_material_w - qt_excedida_w;

                                                        nr_seq_excedido_w := inserir_material_atend_pac(nr_atendimento_w, null, cd_material_w, dt_item_w, cd_convenio_glosa_w, cd_categoria_glosa_w, nr_seq_atepacu_w, nm_usuario_p, qt_excedida_w, cd_local_estoque_w, '1', 'N', nr_seq_excedido_w, null, null);

                                                        CALL atualiza_preco_material(nr_seq_excedido_w, nm_usuario_p);
                                                        CALL ajustar_conta_vazia(nr_atendimento_w, nm_usuario_p);
                                                end if;

                                        elsif (ie_acao_excesso_w = 'Z') then
                                                if (qt_excedida_w   >= qt_material_w) then
                                                        ie_valor_informado_w := 'S';
                                                else
                                                        qt_material_w := qt_material_w - qt_excedida_w;

                                                        nr_seq_excedido_w := inserir_material_atend_pac(nr_atendimento_w, null, cd_material_w, dt_item_w, cd_convenio_w, cd_categoria_w, nr_seq_atepacu_w, nm_usuario_p, qt_excedida_w, cd_local_estoque_w, '1', 'S', nr_seq_excedido_w, null, null);

                                                        CALL atualiza_preco_material(nr_seq_excedido_w, nm_usuario_p);
                                                        CALL ajustar_conta_vazia(nr_atendimento_w, nm_usuario_p);
                                                end if;
                                        end if;
                                end if;
                                if (qt_material_w <> 0) then
                                        insert	into material_atend_paciente(
                                                nr_sequencia,
                                                nr_atendimento,
                                                dt_entrada_unidade,
                                                cd_material,
                                                dt_atendimento,
                                                dt_conta,
                                                cd_unidade_medida,
                                                qt_material,
                                                dt_atualizacao,
                                                nm_usuario,
                                                cd_convenio,
                                                cd_categoria,
                                                nr_doc_convenio,
                                                ie_tipo_guia,
                                                dt_prescricao,
                                                cd_material_prescricao,
                                                cd_material_exec,
                                                nr_prescricao,
                                                nr_sequencia_prescricao,
                                                cd_acao,
                                                cd_setor_atendimento,
                                                qt_executada,
                                                vl_unitario,
                                                qt_ajuste_conta,
                                                ie_valor_informado,
                                                ie_guia_informada,
                                                ie_auditoria,
                                                nm_usuario_original,
                                                cd_situacao_glosa,
                                                nr_seq_atepacu,
                                                nr_seq_cor_exec,
                                                cd_local_estoque,
                                                nr_seq_tipo_baixa,
                                                cd_senha,
                                                nr_seq_lote_fornec,
                                                cd_cgc_fornecedor)
                                        values (
                                                nr_seq_mat_atend_w,
                                                nr_atendimento_w,
                                                dt_entrada_unidade_w,
                                                cd_material_w,
                                                dt_item_w,
                                                dt_item_w,
                                                cd_unidade_medida_w,
                                                qt_material_w,		
                                                clock_timestamp(),
                                                nm_usuario_p,
                                                cd_convenio_w,
                                                cd_categoria_w,
                                                nr_doc_convenio_w,
                                                ie_tipo_guia_w,
                                                dt_prescricao_w,
                                                cd_material_w,
                                                cd_material_w,
                                                nr_prescricao_p,
                                                nr_sequencia_w,
                                                '1',
                                                cd_setor_atendimento_w,
                                                qt_material_w, 
                                                0, 
                                                0,
                                                ie_valor_informado_w, 
                                                'N', 
                                                'N', 
                                                nm_usuario_p, 
                                                0,
                                                nr_seq_atepacu_w,
                                                231,
                                                cd_local_estoque_w,	
                                                nr_seq_motivo_baixa_w, 
                                                cd_senha_w,
                                                nr_seq_lote_fornec_w,
                                                cd_cgc_fornecedor_w);

                                                
                                        CALL Atualiza_Preco_Material(nr_seq_mat_atend_w,nm_usuario_p);

                                        CALL Gerar_Lanc_Automatico_Mat(nr_atendimento_w,cd_local_estoque_w,132,nm_usuario_p,nr_seq_mat_atend_w,null,null);

                                        update	material_atend_paciente
                                        set 	cd_kit_material = CASE WHEN coalesce(ie_consistido_agenda_w,'N')='S' THEN null  ELSE cd_kit_material_w END 
                                        where 	nr_sequencia = nr_seq_mat_atend_w;				
                                end if;
			elsif (ie_atualiza_estoque_w = 'S') then

				CALL Gerar_Prescricao_estoque(
					cd_estabelecimento_w,
					nr_atendimento_w,
					dt_prescricao_w,
					cd_material_w,
					dt_prescricao_w,
					1,
					cd_local_estoque_w,
					qt_material_w,
					cd_setor_atendimento_w,
					cd_unidade_medida_w,
					nm_usuario_p, 'I',
					nr_prescricao_p,
	       		    nr_sequencia_w,
					null,
					nr_sequencia_w,
					null,
					null,
					null,
					null,
					null,
					null, '','','');

			end if;


			update	prescr_material
			set		dt_baixa	= clock_timestamp(),
					nm_usuario	= nm_usuario_p,
					cd_motivo_baixa	= cd_tipo_baixa_w
			where	nr_prescricao	= nr_prescricao_p
			and		nr_sequencia	= nr_sequencia_w
			and		cd_material	= cd_material_w;
		end if;
		end;		
	end if;

end;
end loop;
close c01;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE executar_material_lib_prescr ( nr_prescricao_p bigint, nm_usuario_p text, ie_lib_medico_p text, ie_lib_enfermeiro_p text) FROM PUBLIC;

