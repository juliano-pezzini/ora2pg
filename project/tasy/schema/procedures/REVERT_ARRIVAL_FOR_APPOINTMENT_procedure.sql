-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE revert_arrival_for_appointment (cd_agenda_p bigint, nr_sequencia_p bigint, nr_atendimento_p bigint, cd_pessoa_fisica_p text) AS $body$
DECLARE

  ie_altera_status_confirmada_w   parametro_agenda.ie_altera_status_confirmada%type;
  cd_tipo_agenda_w                bigint;
  nr_seq_lista_ret_p              varchar(10);
  nr_atend_lista_ret_p            varchar(10);
  nr_sequencia_ret_p              varchar(10);
  nr_atendimento_ret_p            varchar(10);
  ds_perg_desvincular_p           varchar(10);
  qtd_linhas_p                    bigint;
  param32_w                       varchar(10);
  qtd_appointments_w              bigint;
  ds_param_integration_w            varchar(255);
  nr_waiting_number_w               varchar(20);


BEGIN
	
	 select obter_senha_gerada_agendas(cd_agenda_p, nr_sequencia_p)
    into STRICT    nr_waiting_number_w
;

  cd_tipo_agenda_w := obter_tipo_agenda(cd_agenda_p);
  param32_w := obter_param_usuario_logado(970,32);

  IF (cd_tipo_agenda_w IN (3, 5)) THEN
    update agenda_consulta a
    set	a.nr_atendimento	 = NULL
	  where	a.nr_sequencia	= nr_sequencia_p;
  ELSIF (cd_tipo_agenda_w = 2) THEN
    update	agenda_paciente a
    set	a.nr_atendimento	 = NULL
	  where	a.nr_sequencia	= nr_sequencia_p;
  END IF;

  --RETURNS THE QUANTITY OF SCHEDULES WITH CONFIRMED ARRIVAL AND THAT HAVE THE SAME NR_ATENDIMENTO
    SELECT count(*)
    INTO STRICT qtd_appointments_w
    FROM (
      SELECT a.nr_sequencia 
      FROM agenda_consulta a
      WHERE a.nr_atendimento = nr_atendimento_p
      
UNION ALL

      SELECT a.nr_sequencia 
      FROM agenda_paciente a
      WHERE a.nr_atendimento = nr_atendimento_p
    ) t;

  -- CONSULTATION SCHEDULE
  IF cd_tipo_agenda_w = 3 THEN
    CALL alterar_status_agecons(
      cd_agenda_p,
      nr_sequencia_p,
      'RA',
      '',
      '',
      'N',
      wheb_usuario_pck.get_nm_usuario,
      0
    );

  IF (param32_w = 'S') THEN
    update agenda_consulta
    set nr_seq_pac_senha_fila = ''
    where nr_sequencia = nr_sequencia_p;
  END IF;

  -- REVERT PATIENT'S ENCOUNTER
  IF (qtd_appointments_w = 0) THEN
    CALL cancelar_atendimento_paciente(
      NR_ATENDIMENTO_P          => nr_atendimento_p,
      NM_USUARIO_P              => wheb_usuario_pck.GET_NM_USUARIO(),
      NR_SEQ_MOTIVO_P           => 1,
      CD_PESSOA_FISICA_P        => cd_pessoa_fisica_p,
      DS_OBSERVACAO_P           => WHEB_MENSAGEM_PCK.get_texto(1041900),
      NR_SEQ_EPISODIO_P         => 0,
      NR_SEQ_TIPO_EPISODIO_P    => 0,
      IE_CANCEL_ENCOUNTER_CLICK => null
    );
  END IF;

  -- SERVICE SCHEDULE
  ELSIF cd_tipo_agenda_w = 5 THEN
    select  coalesce(max(ie_altera_status_confirmada), 'N')
    into STRICT    ie_altera_status_confirmada_w
    from    parametro_agenda
    where   cd_estabelecimento = obter_estabelecimento_ativo;

    update agenda_consulta
    set    ie_status_agenda      = CASE WHEN ie_altera_status_confirmada_w='N' THEN  'N'  ELSE CASE WHEN dt_confirmacao = NULL THEN  'N'  ELSE 'CN' END  END ,
           dt_aguardando          = NULL,
           dt_chegada             = NULL,
           nm_usuario_aguardando  = NULL,
           nm_usuario            = wheb_usuario_pck.get_nm_usuario
    where nr_sequencia = nr_sequencia_p;

  IF (param32_w = 'S') THEN
    update agenda_consulta
    set nr_seq_pac_senha_fila = ''
    where nr_sequencia = nr_sequencia_p;
  END IF;

  IF (qtd_appointments_w = 0) THEN
    CALL cancelar_atendimento_paciente(
      NR_ATENDIMENTO_P          => nr_atendimento_p,
      NM_USUARIO_P              => wheb_usuario_pck.GET_NM_USUARIO(),
      NR_SEQ_MOTIVO_P           => 1,
      CD_PESSOA_FISICA_P        => cd_pessoa_fisica_p,
      DS_OBSERVACAO_P           => WHEB_MENSAGEM_PCK.get_texto(1041900),
      NR_SEQ_EPISODIO_P         => 0,
      NR_SEQ_TIPO_EPISODIO_P    => 0,
      IE_CANCEL_ENCOUNTER_CLICK => null
    );
  END IF;

  -- EXAM SCHEDULE
  ELSIF cd_tipo_agenda_w = 2 THEN
    CALL alterar_status_agenda(
      cd_agenda_p,
      nr_sequencia_p,
      'RA',
      '',
      '',
      'N',
      wheb_usuario_pck.get_nm_usuario
    );

  IF (param32_w = 'S') then
    update agenda_paciente
    set nr_seq_pac_senha_fila = ''
    where nr_sequencia = nr_sequencia_p;
  END IF;

  IF (qtd_appointments_w = 0) THEN
    CALL cancelar_atendimento_paciente(
      NR_ATENDIMENTO_P          => nr_atendimento_p,
      NM_USUARIO_P              => wheb_usuario_pck.GET_NM_USUARIO(),
      NR_SEQ_MOTIVO_P           => 1,
      CD_PESSOA_FISICA_P        => cd_pessoa_fisica_p,
      DS_OBSERVACAO_P           => WHEB_MENSAGEM_PCK.get_texto(1041900),
      NR_SEQ_EPISODIO_P         => 0,
      NR_SEQ_TIPO_EPISODIO_P    => 0,
      IE_CANCEL_ENCOUNTER_CLICK => null
    );
  END IF;
  END IF;

IF coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S' THEN
  COMMIT;
END IF;

if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'ja_JP') then 		-- Locale Japan Check
	
	ds_param_integration_w := '{"recordId" : "'
                            || nr_sequencia_p
                            || '"'
                            || ','
                            || '"waitingSeq" :"'
                            || nr_waiting_number_w
                            || '"'
                            ||'}';
	
	CALL execute_bifrost_integration(258,ds_param_integration_w);
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE revert_arrival_for_appointment (cd_agenda_p bigint, nr_sequencia_p bigint, nr_atendimento_p bigint, cd_pessoa_fisica_p text) FROM PUBLIC;

