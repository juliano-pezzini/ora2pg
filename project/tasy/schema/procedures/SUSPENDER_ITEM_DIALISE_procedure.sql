-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE suspender_item_dialise (nr_prescricao_p bigint ,nr_seq_dialise_p bigint ,nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_solucao_w					integer;
nr_seq_dialise_cpoe_w				bigint;
ie_sol_dialise_w					varchar(1);

c01 CURSOR FOR 
 SELECT nr_seq_solucao 
    ,nr_seq_dialise_cpoe 
 FROM prescr_solucao 
 WHERE nr_prescricao = nr_prescricao_p 
  AND nr_seq_dialise = nr_seq_dialise_p;


BEGIN 
 
 UPDATE hd_prescricao 
 SET ie_status = 'SI' 
 WHERE nr_prescricao = nr_prescricao_p 
  AND nr_sequencia = nr_seq_dialise_p;
 
 UPDATE prescr_solucao 
 SET ie_suspenso = 'S' 
   ,dt_atualizacao = clock_timestamp() 
   ,nm_usuario = nm_usuario_p 
   ,dt_suspensao = clock_timestamp() 
   ,nm_usuario_susp = nm_usuario_p 
 WHERE nr_prescricao = nr_prescricao_p 
  AND nr_seq_dialise = nr_seq_dialise_p;
 
	OPEN C01;
	LOOP 
	FETCH C01 INTO 
		nr_seq_solucao_w, 
		nr_seq_dialise_cpoe_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		BEGIN 
 
   UPDATE prescr_material 
   SET ie_suspenso = 'S' 
     ,dt_atualizacao = clock_timestamp() 
     ,nm_usuario = nm_usuario_p 
     ,dt_suspensao = clock_timestamp() 
     ,nm_usuario_susp = nm_usuario_p 
   WHERE nr_prescricao = nr_prescricao_p 
    AND nr_sequencia_solucao = nr_seq_solucao_w;
 
   UPDATE cpoe_dialise 
   SET dt_suspensao = clock_timestamp() 
     ,dt_lib_suspensao = clock_timestamp() 
     ,nm_usuario_susp = nm_usuario_p 
   WHERE nr_sequencia = nr_seq_dialise_cpoe_w;
 
			SELECT coalesce(Max('S'),'N') 
			INTO STRICT ie_sol_dialise_w 
			FROM prescr_solucao 
			WHERE nr_prescricao	= nr_prescricao_p 
			 AND nr_seq_solucao	= nr_seq_solucao_w 
			 AND (nr_seq_dialise IS NOT NULL AND nr_seq_dialise::text <> '');
 
		 IF (ie_sol_dialise_w = 'S') THEN 
			 INSERT INTO hd_prescricao_evento( 
				nr_sequencia, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				dt_atualizacao, 
				nm_usuario, 
				nr_prescricao, 
				nr_seq_solucao, 
	 			nr_etapa_evento, 
				ie_evento, 
				dt_evento, 
				cd_pessoa_evento, 
				dt_ciclo) 
			VALUES ( 
				nextval('hd_prescricao_evento_seq'), 
				clock_timestamp(), 
				nm_usuario_p, 
				clock_timestamp(), 
				nm_usuario_p, 
				nr_prescricao_p, 
				nr_seq_solucao_w, 
				NULL, 
				'SI', 
				clock_timestamp(), 
				SubStr(obter_dados_usuario_opcao(nm_usuario_p,'C'),1,10), 
				NULL);
		 END IF;
 
		END;
	END LOOP;
	CLOSE C01;
 
IF (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') THEN COMMIT; END IF;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE suspender_item_dialise (nr_prescricao_p bigint ,nr_seq_dialise_p bigint ,nm_usuario_p text) FROM PUBLIC;

