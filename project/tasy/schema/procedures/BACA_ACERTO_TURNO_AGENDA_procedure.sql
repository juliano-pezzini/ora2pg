-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_acerto_turno_agenda () AS $body$
DECLARE


QT_REG_W	bigint;


BEGIN

update	agenda_turno
set	nr_sequencia	= nextval('agenda_turno_seq')
where	coalesce(nr_sequencia::text, '') = '';

update	agenda_turno_conv a
set 	nr_seq_turno	=
	(SELECT x.nr_sequencia
	from	agenda_turno x
	where	x.cd_agenda	= a.cd_agenda
	and	x.hr_inicial	= a.hr_inicial
	and	x.ie_dia_semana	= a.ie_dia_semana)
where	coalesce(nr_seq_turno::text, '') = '';

select	count(*)
into STRICT	qt_reg_w
from 	user_cons_columns
where 	CONSTRAINT_NAME = 'AGETURN_PK';

if (qt_reg_w > 1) then
	begin

	CALL Exec_sql_Dinamico('Agenda Turno', ' alter table agenda_turno modify (nr_sequencia number(10,0) not null) ');

	CALL Exec_sql_Dinamico('Agenda Turno', ' alter table agenda_turno_conv modify (nr_seq_turno number(10,0) not null) ');

	CALL Exec_sql_Dinamico('Agenda Turno', ' ALTER TABLE AGENDA_TURNO_CONV drop CONSTRAINT AGETUCO_AGETURN_FK ');

	CALL Exec_sql_Dinamico('Agenda Turno', ' ALTER TABLE AGENDA_TURNO drop CONSTRAINT AGETURN_PK ');

	CALL Exec_sql_Dinamico('Agenda Turno', ' ALTER TABLE AGENDA_TURNO ADD ( CONSTRAINT AGETURN_PK Primary Key  (
				               nr_sequencia)) ');

	CALL Exec_sql_Dinamico('Agenda Turno', ' ALTER TABLE AGENDA_TURNO_CONV ADD
				( CONSTRAINT AGETUCO_AGETURN_FK FOREIGN KEY (
				               NR_SEQ_TURNO)
				REFERENCES agenda_turno (
			               NR_SEQUENCIA)) ');
	end;
end if;

update	agenda_horario
set	nr_sequencia	= nextval('agenda_horario_seq')
where	coalesce(nr_sequencia::text, '') = '';

select	count(*)
into STRICT	qt_reg_w
from 	user_cons_columns
where 	CONSTRAINT_NAME = 'AGEHORA_PK';

if (qt_reg_w > 1) then
	begin

	CALL Exec_sql_Dinamico('Agenda Turno', ' alter table agenda_horario modify (nr_sequencia number(10,0) not null) ');

	CALL Exec_sql_Dinamico('Agenda Turno', ' ALTER TABLE AGENDA_horario drop CONSTRAINT AGEHORA_PK ');

	CALL Exec_sql_Dinamico('Agenda Turno', ' ALTER TABLE AGENDA_horario ADD ( CONSTRAINT AGEHORA_PK Primary Key  (
				               nr_sequencia)) ');

	end;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_acerto_turno_agenda () FROM PUBLIC;

