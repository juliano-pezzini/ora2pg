-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE material_imp_ficha_tec ( cd_dcb_p text, ds_ficha_tecnica_p text, nr_seq_superior_p bigint, nr_seq_retorno_p INOUT bigint, nr_externo_p text, cd_atc_p text, nm_usuario_p text) AS $body$
DECLARE

nr_seq_dcb_w		bigint;
nr_seq_ficha_w		bigint;
medic_ficha_tecnica_w	medic_ficha_tecnica%rowtype;
ds_atc_w		varchar(255);
ds_ficha_w		varchar(255)	:= ds_ficha_tecnica_p;
nr_seq_ficha_igual_w	bigint;
nr_seq_ficha_count_w                  bigint;


BEGIN

if (cd_dcb_p IS NOT NULL AND cd_dcb_p::text <> '') then
	nr_seq_dcb_w := material_imp_dcb_medic(	cd_dcb_p, ds_ficha_tecnica_p, nm_usuario_p, nr_seq_dcb_w);
end if;

if (nr_seq_dcb_w IS NOT NULL AND nr_seq_dcb_w::text <> '') and (coalesce(nr_seq_superior_p::text, '') = '') then
	
	select	max(nr_sequencia)
	into STRICT	nr_seq_ficha_w
	from	medic_ficha_tecnica
	where	nr_seq_dcb	= nr_seq_dcb_w
	and	coalesce(nr_seq_superior::text, '') = '';
		
end if;

if (coalesce(nr_seq_ficha_w::text, '') = '') then
	
	select	nextval('medic_ficha_tecnica_seq')
	into STRICT	nr_seq_ficha_w
	;
	
	medic_ficha_tecnica_w.nr_sequencia		:= nr_seq_ficha_w;
	medic_ficha_tecnica_w.DS_SUBSTANCIA		:= substr(ds_ficha_w,1,80);
	medic_ficha_tecnica_w.NR_SEQ_DCB		:= nr_seq_dcb_w;
	medic_ficha_tecnica_w.dt_atualizacao		:= clock_timestamp();
	medic_ficha_tecnica_w.dt_atualizacao_nrec	:= clock_timestamp();
	medic_ficha_tecnica_w.nm_usuario		:= nm_usuario_p;
	medic_ficha_tecnica_w.nm_usuario_nrec		:= nm_usuario_p;
	medic_ficha_tecnica_w.nr_seq_superior		:= nr_seq_superior_p;
	medic_ficha_tecnica_w.ie_antimicrobiano		:= 'N';
	medic_ficha_tecnica_w.nr_externo		:= coalesce(cd_atc_p,nr_externo_p);
	if (cd_atc_p IS NOT NULL AND cd_atc_p::text <> '') then
		medic_ficha_tecnica_w.ds_observacao		:= cd_atc_p||',';
	end if;
	
	insert into medic_ficha_tecnica values (medic_ficha_tecnica_w.*);
	
     if ( nr_seq_superior_p is not  null  AND (nr_seq_dcb_w IS NOT NULL AND nr_seq_dcb_w::text <> '')  )then
         SELECT count(*) into STRICT nr_seq_ficha_count_w FROM medic_ficha_tecnica 
          where NR_SEQ_DCB=nr_seq_dcb_w AND nr_seq_superior is  null;
      if (nr_seq_ficha_count_w = 0 ) then
          select   nextval('medic_ficha_tecnica_seq')
          into STRICT nr_seq_ficha_w
;
           medic_ficha_tecnica_w.nr_sequencia                        := nr_seq_ficha_w;
           medic_ficha_tecnica_w.nr_seq_superior                     := null;
           insert into medic_ficha_tecnica values (medic_ficha_tecnica_w.*);
     end if;
    end if;
	
end if;

nr_seq_retorno_p	:= nr_seq_ficha_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE material_imp_ficha_tec ( cd_dcb_p text, ds_ficha_tecnica_p text, nr_seq_superior_p bigint, nr_seq_retorno_p INOUT bigint, nr_externo_p text, cd_atc_p text, nm_usuario_p text) FROM PUBLIC;

