-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE same_devolver_solicitacao ( nr_seq_solic_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


qt_nao_devolvido_w	bigint;
ie_status_w		varchar(1);


BEGIN

/* ATENÇÃO: ESTA PROCEDURE NÃO TEM COMMIT, POIS SOMENTE É CHAMADA ATRAVÉS DE OUTRA PROCEDURE.
 *          CASO SEJA NECESSÁRIO IMPLEMENTAR O COMMIT, FAVOR VERIFICAR OS PONTOS ONDE PODEM
 *          OCORRER ROLLBACKS E TRATAR OS MESMOS DE OUTRA FORMA.
 */
select	count(*)
into STRICT	qt_nao_devolvido_w
from	same_solic_pront_envelope
where	nr_seq_solic	= nr_seq_solic_p
and	coalesce(dt_devolucao::text, '') = '';

select	coalesce(max(obter_valor_param_usuario(941, 82, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)), 'D')
into STRICT	ie_status_w
;

if (qt_nao_devolvido_w = 0) then
	update	same_solic_pront
	set	ie_status	= ie_status_w,
		dt_devolucao	= clock_timestamp(),
		dt_atualizacao	= clock_timestamp(),
		nm_usuario	= nm_usuario_p
	where	nr_sequencia	= nr_seq_solic_p;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE same_devolver_solicitacao ( nr_seq_solic_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

