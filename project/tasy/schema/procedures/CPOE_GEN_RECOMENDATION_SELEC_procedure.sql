-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gen_recomendation_selec ( nr_atendimento_p bigint, cd_pessoa_fisica_p text default null, nr_seq_produto_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL, cd_estabelecimento_p bigint DEFAULT NULL, cd_perfil_p bigint DEFAULT NULL, nr_seq_item_gerado_p INOUT bigint DEFAULT NULL, ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, nr_seq_cpoe_order_unit_p bigint default null, cd_kit_p bigint default null) AS $body$
DECLARE


ds_stack_w				log_cpoe.ds_stack%type;
ds_log_cpoe_w			log_cpoe.ds_log%type;
nr_seq_recomendacao_w	cpoe_recomendacao.nr_sequencia%type;
nr_ocorrencia_w			cpoe_recomendacao.nr_ocorrencia%type;
ie_duracao_w			cpoe_recomendacao.ie_duracao%type := 'C';
ie_evento_unico_w		cpoe_recomendacao.ie_evento_unico%type;

cd_intervalo_w			tipo_recomendacao.cd_intervalo%type;
cd_intervalo_agora_w	tipo_recomendacao.cd_intervalo%type;
cd_tipo_recomendacao_w	tipo_recomendacao.cd_tipo_recomendacao%type;
ds_tipo_recomendacao_w	tipo_recomendacao.ds_tipo_recomendacao%type;
ie_urgencia_w			tipo_recomendacao.ie_urgencia%type;
nr_seq_topografia_w		tipo_recomendacao.nr_seq_topografia%type;
ds_complemento_w        tipo_recomendacao.ds_complemento%type;

ie_exibe_w				intervalo_prescricao.cd_intervalo%type;
ie_dose_unica_cpoe_w	intervalo_prescricao.ie_dose_unica_cpoe%type;


ie_prescr_alta_agora_w	varchar(1);
ds_horarios_w			varchar(4000);
ds_horarios_aux_w		varchar(4000);
hr_prim_horario_w		char(5);
dt_inicio_w				timestamp;

dt_fim_w				timestamp := null;

C01 CURSOR FOR
		SELECT	cd_intervalo,
			cd_tipo_recomendacao,
			ds_tipo_recomendacao,
			coalesce(ie_urgencia,'N') ie_urgencia,
			nr_seq_topografia,
            ds_complemento
		from	tipo_recomendacao
		where	cd_tipo_recomendacao = nr_seq_produto_p;
		

BEGIN


open C01;
loop
fetch C01 into	
	cd_intervalo_w,
	cd_tipo_recomendacao_w,
	ds_tipo_recomendacao_w,
	ie_urgencia_w,
	nr_seq_topografia_w,
    ds_complemento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	select	nextval('cpoe_recomendacao_seq')
	into STRICT	nr_seq_recomendacao_w
	;
	
	insert into cpoe_recomendacao(
			nr_sequencia,
			cd_intervalo,
			cd_recomendacao, 
			ds_recomendacao,
			nm_usuario,
			nm_usuario_nrec,
			dt_atualizacao,
			dt_atualizacao_nrec,
			nr_atendimento,
			ie_duracao,
			cd_perfil_ativo,
			cd_funcao_origem,
			cd_pessoa_fisica,
			ie_prescritor_aux,
			cd_medico,
            nr_seq_cpoe_order_unit,
			ie_administracao,
			cd_kit
			)
		values (
			nr_seq_recomendacao_w,
			cd_intervalo_w,
			cd_tipo_recomendacao_w,
			substr(coalesce(trim(both ds_complemento_w),ds_tipo_recomendacao_w),1,4000),
			nm_usuario_p,
			nm_usuario_p,
			clock_timestamp(),
			clock_timestamp(),
			nr_atendimento_p,
			ie_duracao_w,
			cd_perfil_p,
			2314,
			cd_pessoa_fisica_p,
			ie_prescritor_aux_p,
			cd_medico_p,
            nr_seq_cpoe_order_unit_p,
			'P',
			cd_kit_p
			);
	commit;		
	
	end;
end loop;
close C01;

nr_seq_item_gerado_p := nr_seq_recomendacao_w;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gen_recomendation_selec ( nr_atendimento_p bigint, cd_pessoa_fisica_p text default null, nr_seq_produto_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL, cd_estabelecimento_p bigint DEFAULT NULL, cd_perfil_p bigint DEFAULT NULL, nr_seq_item_gerado_p INOUT bigint DEFAULT NULL, ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, nr_seq_cpoe_order_unit_p bigint default null, cd_kit_p bigint default null) FROM PUBLIC;

