-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_alterar_dados_dirf ( nm_usuario_p text, nr_sequencia_p bigint, vl_rendimento_p bigint, vl_imposto_p bigint, ds_justificativa_p text ) AS $body$
DECLARE



ds_alteracao_w			dirf_log_exclusao.ds_alteracao%type;
ds_justificativa_w		dirf_log_exclusao.ds_justificativa%type;

nr_seq_lote_dirf_w		dirf_lote_mensal.nr_sequencia%type;
nm_usuario_w			dirf_titulo_pagar.nm_usuario%type;
dt_atualizacao_w		dirf_titulo_pagar.dt_atualizacao%type;
nr_titulo_w			dirf_titulo_pagar.nr_titulo%type;
cd_tributo_w			dirf_titulo_pagar.cd_tributo%type;
cd_darf_w			dirf_titulo_pagar.cd_darf%type;
vl_rendimento_w			dirf_titulo_pagar.vl_rendimento%type;
vl_imposto_w			dirf_titulo_pagar.vl_imposto%type;
ie_status_w			dirf_lote.ie_status%type;


BEGIN

if (coalesce(nr_sequencia_p,0) > 0) and (length(ds_justificativa_p) > 0) then
	begin
	ds_justificativa_w := substr(ds_justificativa_p,1,255);

	select	nr_seq_lote_dirf,
		nm_usuario,
		dt_atualizacao,
		nr_titulo,
		cd_tributo,
		cd_darf,
		vl_rendimento,
		vl_imposto
	into STRICT	nr_seq_lote_dirf_w,
		nm_usuario_w,
		dt_atualizacao_w,
		nr_titulo_w,
		cd_tributo_w,
		cd_darf_w,
		vl_rendimento_w,
		vl_imposto_w
	from	dirf_titulo_pagar
	where	nr_sequencia = nr_sequencia_p;


	ds_alteracao_w	:=	substr(wheb_mensagem_pck.get_texto(323692)	|| ' ' || nr_sequencia_p	|| chr(13) || chr(10) ||
				wheb_mensagem_pck.get_texto(323693)	|| ' ' || nm_usuario_p		|| chr(13) || chr(10) ||
				wheb_mensagem_pck.get_texto(323694)	|| ' ' || nm_usuario_w		|| chr(13) || chr(10) ||
				wheb_mensagem_pck.get_texto(323695)	|| ' ' || dt_atualizacao_w	|| chr(13) || chr(10) ||
				wheb_mensagem_pck.get_texto(323697)	|| ' ' || campo_mascara(vl_rendimento_w,2)	|| chr(13) || chr(10) ||
				wheb_mensagem_pck.get_texto(323699)	|| ' ' || campo_mascara(vl_rendimento_p,2)	|| chr(13) || chr(10) ||
				wheb_mensagem_pck.get_texto(323700)	|| ' ' || campo_mascara(vl_imposto_w,2)	|| chr(13) || chr(10) ||
				wheb_mensagem_pck.get_texto(323701)	|| ' ' || campo_mascara(vl_imposto_p,2),1,250);

	insert	into dirf_log_exclusao(	nr_sequencia,
					nm_usuario,
					nm_usuario_nrec,
					dt_atualizacao,
					dt_atualizacao_nrec,
					ie_tipo_alteracao,
					nr_titulo,
					cd_tributo,
					cd_darf,
					nr_seq_lote_dirf,
					ds_alteracao,
					ds_justificativa
					)
	values (				nextval('dirf_log_exclusao_seq'),
					nm_usuario_p,
					nm_usuario_p,
					clock_timestamp(),
					clock_timestamp(),
					'A',
					nr_titulo_w,
					cd_tributo_w,
					cd_darf_w,
					nr_seq_lote_dirf_w,
					ds_alteracao_w,
					ds_justificativa_w
					);

	update	dirf_titulo_pagar
	set	vl_rendimento	= coalesce(vl_rendimento_p, vl_rendimento),
		vl_imposto	= coalesce(vl_imposto_p, vl_imposto),
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_sequencia_p;

	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_alterar_dados_dirf ( nm_usuario_p text, nr_sequencia_p bigint, vl_rendimento_p bigint, vl_imposto_p bigint, ds_justificativa_p text ) FROM PUBLIC;

