-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_transferencia_js ( nr_atendimento_p bigint, cd_setor_atendimento_p bigint, cd_unidade_basica_p text, cd_unidade_compl_p text, cd_tipo_acomodacao_p bigint, nr_acompanhantes_p bigint, nr_seq_motivo_transf_p bigint, ds_observacao_p text, nm_usuario_p text, dt_entrada_unidade_p timestamp, nr_sequencia_p bigint, ie_atualizar_set_presc_p text, update_status_p text) AS $body$
DECLARE

				
cd_setor_atual_w		varchar(255);
ie_grava_setor_atual_w	varchar(1);
cd_unid_basica_atual_w		gestao_vaga.cd_unid_basica_atual%type;
cd_unid_compl_atual_w		gestao_vaga.cd_unid_compl_atual%type;

BEGIN

ie_grava_setor_atual_w := obter_param_usuario(1002, 87, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_Ativo, ie_grava_setor_atual_w);

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '')and (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '')then
	begin
	
	if (update_status_p <> 'S' or coalesce(update_status_p::text, '') = '') then

		CALL gerar_transferencia_paciente(	nr_atendimento_p, 
					cd_setor_atendimento_p, 
					cd_unidade_basica_p, 
					cd_unidade_compl_p, 
					cd_tipo_acomodacao_p, 
					nr_acompanhantes_p,
					nr_seq_motivo_transf_p, 
					ds_observacao_p, 
					nm_usuario_p, 
					dt_entrada_unidade_p);
				
		if (ie_atualizar_set_presc_p = 'S') then
	
			cd_setor_atual_w := obter_unidade_atendimento(nr_atendimento_p, 'IAA', 'CS');
		
			CALL Atualizar_setor_prescricao(nr_atendimento_p,
						cd_setor_atendimento_p,
						cd_setor_atual_w,
						nm_usuario_p);
	
		end if;
	
		CALL gerar_ajustes_ap_lote(	'M',
					nr_atendimento_p,
					nm_usuario_p);

	end if;

	if (ie_grava_setor_atual_w = 'S') then	
		begin
		
		cd_setor_atual_w := obter_unidade_atendimento(nr_atendimento_p, 'IAA', 'CS');
		
		select substr(obter_unidade_atendimento(nr_atendimento_p,'IAA','UB'),1,40)
		into STRICT 	cd_unid_basica_atual_w
		;
				
		select substr(obter_unidade_atendimento(nr_atendimento_p,'IAA','UC'),1,40)
		into STRICT 	cd_unid_compl_atual_w
		;
		
		
		update    	gestao_vaga
		set       	ie_status         = 'F',
			dt_acomodacao     = clock_timestamp(),
			nm_resp_transf    = nm_usuario_p,
			cd_setor_desejado = cd_setor_atendimento_p,
			cd_setor_atual	  = cd_setor_atual_w,
			cd_unidade_basica = cd_unidade_basica_p,
			cd_unidade_compl  = cd_unidade_compl_p,
			nm_usuario        = nm_usuario_p,
			dt_atualizacao    = clock_timestamp(),
			cd_unid_basica_atual = cd_unid_basica_atual_w,
			cd_unid_compl_atual  = cd_unid_compl_atual_w
		where     	nr_sequencia      = nr_sequencia_p;
		end;
	else
		begin
		update    	gestao_vaga
		set       	ie_status         = 'F',
			dt_acomodacao     = clock_timestamp(),
			nm_resp_transf    = nm_usuario_p,
			cd_setor_desejado = cd_setor_atendimento_p,
			cd_unidade_basica = cd_unidade_basica_p,
			cd_unidade_compl  = cd_unidade_compl_p,
			nm_usuario        = nm_usuario_p,
			dt_atualizacao    = clock_timestamp()
		where     	nr_sequencia      = nr_sequencia_p;
		end;
	end if;

	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_transferencia_js ( nr_atendimento_p bigint, cd_setor_atendimento_p bigint, cd_unidade_basica_p text, cd_unidade_compl_p text, cd_tipo_acomodacao_p bigint, nr_acompanhantes_p bigint, nr_seq_motivo_transf_p bigint, ds_observacao_p text, nm_usuario_p text, dt_entrada_unidade_p timestamp, nr_sequencia_p bigint, ie_atualizar_set_presc_p text, update_status_p text) FROM PUBLIC;

