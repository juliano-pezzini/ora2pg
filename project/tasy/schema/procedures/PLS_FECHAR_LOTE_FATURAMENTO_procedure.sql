-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_fechar_lote_faturamento ( nr_seq_lote_p bigint, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE

					
/*ie_opcao_p
'F ' -> Fechar lote
'D' -> Desfazer fechamento lote
*/
ie_novo_pos_estab_w		pls_visible_false.ie_novo_pos_estab%type := 'N';
dt_referencia_w			timestamp;
dt_referencia_month_w           timestamp;
dt_ref_inicial_w                timestamp;
dt_ref_final_w                  timestamp;
ie_data_rec_faturamento_w	pls_parametro_contabil.ie_data_rec_faturamento%type;
cd_estabelecimento_w		smallint;
nr_seq_fatura_w			bigint;
nr_seq_atualizacao_w		bigint;
qt_movimento_w			bigint := 0;
qt_fatura_proc_w		bigint;
qt_fatura_mat_w			bigint;
ie_concil_contab_w		pls_visible_false.ie_concil_contab%type;

c_contas_faturamento CURSOR FOR
	SELECT	b.nr_sequencia
	from	pls_fatura		b,
		pls_lote_faturamento	a
	where	b.nr_seq_lote		= a.nr_sequencia
	and	coalesce(b.nr_seq_cancel_fat::text, '') = ''
	and	coalesce(a.cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w
	and	coalesce(b.nr_lote_contabil,0) = 0
	and	a.nr_sequencia = nr_seq_lote_p
	
union

	SELECT	b.nr_sequencia
	from	pls_fatura		b,
		pls_lote_faturamento	a
	where	b.nr_seq_lote		= a.nr_sequencia
	and	coalesce(b.nr_seq_cancel_fat::text, '') = ''
	and	coalesce(a.cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w
	and	coalesce(b.nr_lote_contabil,0) = 0
	and	a.nr_sequencia = nr_seq_lote_p;


BEGIN

select	coalesce(max(ie_concil_contab), 'N')
into STRICT	ie_concil_contab_w
from 	pls_visible_false;

if (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') then
	select	coalesce(max(ie_novo_pos_estab),'N')
	into STRICT	ie_novo_pos_estab_w
	from	pls_visible_false;
	
	if (ie_novo_pos_estab_w = 'S') then
		if (ie_opcao_p = 'F') then
			CALL pls_faturamento_pck.fechar_lote_faturamento(nr_seq_lote_p, null, nm_usuario_p);
			
		elsif (ie_opcao_p = 'D') then
			CALL pls_faturamento_pck.desfazer_fechar_lote_fat(nr_seq_lote_p, null, nm_usuario_p);
		end if;
	else
		if (ie_opcao_p = 'F') then
			update	pls_lote_faturamento
			set	dt_fechamento 	= clock_timestamp(),
				nm_usuario	= nm_usuario_p,
				dt_atualizacao	= clock_timestamp()
			where	nr_sequencia 	= nr_seq_lote_p;
			
		elsif (ie_opcao_p = 'D') then		
			update	pls_lote_faturamento
			set	dt_fechamento 	 = NULL,
				nm_usuario	= nm_usuario_p,
				dt_atualizacao	= clock_timestamp()
			where	nr_sequencia 	= nr_seq_lote_p;
		end if;
	end if;
	
	commit;
end if;

if (ie_opcao_p = 'F') then

	select	max(a.cd_estabelecimento)
	into STRICT	cd_estabelecimento_w
	from	pls_lote_faturamento a
	where	a.nr_sequencia	= nr_seq_lote_p;

	select	count(*)
	into STRICT	qt_fatura_proc_w
	from	pls_conta 			a,
		pls_conta_pos_estabelecido 	b,
		pls_conta_pos_estab_contab 	c,
		pls_fatura 			d,
		pls_fatura_proc 		e,
		pls_fatura_conta 		f,
		pls_fatura_evento 		g,
		pls_lote_faturamento 		h,
		pls_plano			i,
		pls_segurado			j
	where	a.nr_sequencia 		= b.nr_seq_conta
	and	b.nr_sequencia 		= c.nr_seq_conta_pos
	and	b.nr_sequencia 		= e.nr_seq_conta_pos_estab
	and	d.nr_sequencia 		= g.nr_seq_fatura
	and	f.nr_sequencia 		= e.nr_seq_fatura_conta
	and	g.nr_sequencia 		= f.nr_seq_fatura_evento
	and	h.nr_sequencia 		= d.nr_seq_lote
	and	i.nr_sequencia 		= a.nr_seq_plano
	and	j.nr_sequencia		= a.nr_seq_segurado
	and	(a.nr_seq_plano IS NOT NULL AND a.nr_seq_plano::text <> '')
	and	coalesce(d.nr_seq_cancel_fat::text, '') = ''
	and	coalesce(h.cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w
	and	h.nr_sequencia		= nr_seq_lote_p;

	select	count(*)
	into STRICT	qt_fatura_mat_w
	from	pls_conta 			a,
		pls_conta_pos_estabelecido 	b,
		pls_conta_pos_estab_contab 	c,
		pls_fatura 			d,
		pls_fatura_mat 			e,
		pls_fatura_conta 		f,
		pls_fatura_evento 		g,
		pls_lote_faturamento 		h,
		pls_plano			i,
		pls_segurado			j
	where	a.nr_sequencia 		= b.nr_seq_conta
	and	b.nr_sequencia 		= c.nr_seq_conta_pos
	and	b.nr_sequencia 		= e.nr_seq_conta_pos_estab
	and	d.nr_sequencia 		= g.nr_seq_fatura
	and	f.nr_sequencia 		= e.nr_seq_fatura_conta
	and	g.nr_sequencia 		= f.nr_seq_fatura_evento
	and	h.nr_sequencia 		= d.nr_seq_lote
	and	i.nr_sequencia 		= a.nr_seq_plano
	and	j.nr_sequencia		= a.nr_seq_segurado
	and	(a.nr_seq_plano IS NOT NULL AND a.nr_seq_plano::text <> '')
	and	coalesce(d.nr_seq_cancel_fat::text, '') = ''
	and	coalesce(h.cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w
	and	h.nr_sequencia		= nr_seq_lote_p;

	qt_movimento_w	:= qt_fatura_proc_w + qt_fatura_mat_w;

	select	coalesce(max(a.ie_data_rec_faturamento),'MC')
	into STRICT	ie_data_rec_faturamento_w
	from	pls_parametro_contabil	a
	where	a.cd_estabelecimento	= cd_estabelecimento_w;

	select	trunc(a.dt_mesano_referencia,'month')
	into STRICT	dt_referencia_w
	from	pls_lote_faturamento	a
	where	a.nr_sequencia	= nr_seq_lote_p;

	dt_referencia_month_w	:= trunc(dt_referencia_w,'month');

	dt_ref_inicial_w	:= dt_referencia_month_w;
	dt_ref_final_w		:= fim_dia(fim_mes(dt_referencia_month_w));


	if (ie_concil_contab_w = 'N') then
		nr_seq_atualizacao_w := pls_gerar_atualizacao_contabil(	dt_referencia_w, nm_usuario_p, cd_estabelecimento_w, 44, 'G', qt_movimento_w, nr_seq_atualizacao_w);

		open c_contas_faturamento;
		loop
		fetch c_contas_faturamento into
			nr_seq_fatura_w;
		EXIT WHEN NOT FOUND; /* apply on c_contas_faturamento */
			begin
										
			CALL ctb_pls_atualizar_faturamento(	nr_seq_fatura_w,
							null,
							null,
							nr_seq_atualizacao_w,
							nm_usuario_p,
							cd_estabelecimento_w);
										
			commit;

			CALL pls_atualizar_tributo_fat(	nm_usuario_p,
							cd_estabelecimento_w,
							nr_seq_fatura_w,
							nr_seq_atualizacao_w);


			commit;

			end;
		end loop;
		close c_contas_faturamento;

		nr_seq_atualizacao_w := pls_gerar_atualizacao_contabil(	dt_referencia_w, nm_usuario_p, cd_estabelecimento_w, 44, 'A', qt_movimento_w, nr_seq_atualizacao_w);
	end if;
end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_fechar_lote_faturamento ( nr_seq_lote_p bigint, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

