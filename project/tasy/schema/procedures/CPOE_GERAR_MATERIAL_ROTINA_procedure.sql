-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_material_rotina ( nr_atendimento_p bigint, nr_seq_produto_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_pessoa_fisica_p text, nr_seq_item_gerado_p INOUT bigint, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, nr_seq_conclusao_apae_p bigint default null, ie_futuro_p text default 'N', nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) AS $body$
DECLARE


cd_material_w				material.cd_material%type;
cd_unidade_medida_w			varchar(30);
cd_intervalo_w				intervalo_prescricao.cd_intervalo%type;
cd_interv_param_w			intervalo_prescricao.cd_intervalo%type;
qt_min_intervalo_w			intervalo_prescricao.qt_min_intervalo%type;
ds_justificativa_w		varchar(2000);
ie_justific_padrao_w	varchar(2);
hr_prim_horario_w			varchar(5);

ie_agora_w					varchar(2) := 'N';
qt_dose_w 					double precision;
ie_check_tipo_interv_w		char(1);
qt_conversao_dose_w	   		double precision;

ds_stack_w					log_cpoe.ds_stack%type;
ds_log_cpoe_w				log_cpoe.ds_log%type;

ie_urgencia_cpoe_w			cpoe_material.ie_urgencia%type;
ds_horarios_aux_w			cpoe_material.ds_horarios%type;
ds_horarios_w				cpoe_material.ds_horarios%type;
qt_unitaria_w				cpoe_material.qt_unitaria%type;
dt_inicio_w					cpoe_material.dt_inicio%type;
dt_inicio_base_w			cpoe_material.dt_inicio%type;
dt_fim_w					cpoe_material.dt_fim%type;
nr_ocorrencia_w				cpoe_material.nr_ocorrencia%type;
cd_setor_atendimento_w	cpoe_material.cd_setor_atendimento%type;



BEGIN
	cd_interv_param_w := Wheb_assist_pck.obterValorParametroREP(49, cd_interv_param_w);
	--Wheb_assist_pck.obterValorParametroREP(530, ie_prescr_mat_sem_lib_w);
	ie_justific_padrao_w := Wheb_assist_pck.obterValorParametroREP(640, ie_justific_padrao_w);
	ie_check_tipo_interv_w := Wheb_assist_pck.obterValorParametroREP(809, ie_check_tipo_interv_w);
	if (nr_atendimento_p > 0) then
		cd_setor_atendimento_w := cpoe_obter_setor_atend_prescr(nr_atendimento_p, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p);
	end if;
	nr_ocorrencia_w := 0;
	dt_inicio_base_w := trunc(clock_timestamp() + (1/24),'hh24');

	if (coalesce(cd_interv_param_w::text, '') = '') then
		begin
			select	cd_intervalo_padrao
			into STRICT	cd_intervalo_w
			from	parametro_medico
			where	cd_estabelecimento = cd_estabelecimento_p;
		end;
	else
		cd_intervalo_w	:= cd_interv_param_w;
	end if;
	
	select 	coalesce(max(ie_agora),'N'),
			max(hr_prim_horario),
			max(coalesce(cd_intervalo,cd_intervalo_w)), 
			max(coalesce(qt_dose,1)), 
			max(cd_unidade_medida),
			max(cd_material)
	into STRICT	ie_agora_w,
			hr_prim_horario_w,
			cd_intervalo_w, 
			qt_dose_w,
			cd_unidade_medida_w,
			cd_material_w
	from	material_rotina
	where	nr_sequencia = nr_seq_produto_p
	and		((cd_setor_atendimento = cd_setor_atendimento_w) or (coalesce(cd_setor_atendimento::text, '') = ''))
	and		((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento));

	if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') then
	
		if (ie_justific_padrao_w = 'S') then
			select	max(ds_justificativa)
			into STRICT	ds_justificativa_w
			from	rep_justificativa_material
			where	obter_se_justif_padrao_medic(cd_material_w, nr_sequencia, cd_estabelecimento_p,'N','N') = 'S';
		end if;
		
		if (coalesce(cd_unidade_medida_w::text, '') = '') then
			select	max(substr(obter_dados_material_estab(cd_material,cd_estabelecimento_p,'UMS'),1,30))
			into STRICT	cd_unidade_medida_w
			from	material
			where	cd_material	= cd_material_w;		
		end if;
		
		if (ie_check_tipo_interv_w = 'S') and (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') and (coalesce(ie_agora_w,'N') = 'N') then
			Select	coalesce(coalesce(max(ie_agora),ie_agora_w),'N')
			into STRICT	ie_agora_w
			from	intervalo_prescricao
			where	cd_intervalo = cd_intervalo_w;
		end if;	

		if (ie_agora_w = 'S') then
			hr_prim_horario_w 	:= to_char(clock_timestamp(),'hh24:mi');
			ds_horarios_w		:= to_char(clock_timestamp(),'hh24:mi');
			ie_urgencia_cpoe_w  := 0;
		end if;

		qt_conversao_dose_w	:= obter_conversao_unid_med(cd_material_w,cd_unidade_medida_w);

		qt_unitaria_w := dividir(trunc(dividir(qt_dose_w * 1000,qt_conversao_dose_w)),1000);

		if (coalesce(hr_prim_horario_w::text, '') = '') then
			hr_prim_horario_w := cpoe_obter_primeiro_horario(nr_atendimento_p,cd_intervalo_w,cd_material_w,cd_estabelecimento_p,cd_perfil_p,nm_usuario_p, cd_pessoa_fisica_p);
			if ((coalesce(hr_prim_horario_w::text, '') = '') or (hr_prim_horario_w = '  :  ')) then
				hr_prim_horario_w	:=	to_char(trunc(dt_inicio_base_w,'hh24'),'hh24:mi');
			end if;
		end if;
		
		if (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') then
			dt_inicio_w := to_date(to_char(dt_inicio_base_w,'dd/mm/yyyy ') || substr(hr_prim_horario_w,1,5),'dd/mm/yyyy hh24:mi');
			if (dt_inicio_w < trunc(clock_timestamp(),'mi')) then
				dt_inicio_w := dt_inicio_w + 1;
			elsif ((dt_inicio_w = trunc(clock_timestamp(),'mi')) and (ie_agora_w <> 'S')) then
				dt_inicio_w	:= dt_inicio_base_w;
				hr_prim_horario_w	:=	to_char(trunc(dt_inicio_base_w,'hh24'),'hh24:mi');
			end if;
		end if;
		
	select	max(qt_min_intervalo)
	into STRICT	qt_min_intervalo_w
	from	intervalo_prescricao
	where	cd_intervalo = cd_intervalo_w;
	
	SELECT * FROM cpoe_calcular_horario_prescr(	nr_atendimento_p, cd_intervalo_w, cd_material_w, dt_inicio_w, 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;
	ds_horarios_w	:= ds_horarios_w || ds_horarios_aux_w;	
	dt_fim_w := ((dt_inicio_w + 1) - 1/1440);
	
		select	nextval('cpoe_material_seq')
		into STRICT	nr_seq_item_gerado_p
		;
		
					insert into
					cpoe_material(nr_sequencia, 
								  nr_atendimento, 
								  cd_pessoa_fisica,
								  cd_material, 
								  ie_material,
								  qt_dose, 
								  cd_unidade_medida, 
								  dt_inicio, 
								  hr_prim_horario,
								  nr_ocorrencia,
								  dt_fim,
								  cd_intervalo, 
								  ie_urgencia, 
								  ds_horarios, 
								  qt_unitaria,
								  ds_justificativa, 
								  nm_usuario, 
								  nm_usuario_nrec, 
								  dt_atualizacao, 
								  dt_atualizacao_nrec, 
								  cd_perfil_ativo,
								  cd_funcao_origem,
								  cd_protocolo,
								  nr_seq_protocolo,
								  nr_seq_transcricao,
								  ie_item_alta,
								  ie_prescritor_aux,
								  cd_medico,
								  ie_retrogrado,
								  ie_futuro,
								  nr_seq_pepo,
								  nr_cirurgia,
								  nr_cirurgia_patologia,
								  nr_seq_agenda,
								  nr_seq_conclusao_apae,
								  ie_forma_geracao,
								  ie_administracao,
								  ie_duracao,
								  nr_seq_cpoe_order_unit
								  )			
					values (	nr_seq_item_gerado_p,
							nr_atendimento_p, 
							cd_pessoa_fisica_p,
							cd_material_w,
							'S',
							qt_dose_w,
							cd_unidade_medida_w,
							dt_inicio_w, 
							hr_prim_horario_w,
							nr_ocorrencia_w,
							dt_fim_w,				
							cd_intervalo_w,
							ie_urgencia_cpoe_w,
							ds_horarios_w,
							qt_unitaria_w,
							ds_justificativa_w, 
							nm_usuario_p,
							nm_usuario_p,
							clock_timestamp(),
							clock_timestamp(),
							cd_perfil_p,
							2314,
							null,
							null,
							nr_seq_transcricao_p,
							ie_item_alta_p,
							ie_prescritor_aux_p,
							cd_medico_p,
							ie_retrogrado_p,
							ie_futuro_p,
							nr_seq_pepo_p,
							nr_cirurgia_p,
							nr_cirurgia_patologia_p,
							nr_seq_agenda_p,
							nr_seq_conclusao_apae_p,
							'P',
							'P',
							'P',
							nr_seq_cpoe_order_unit_p
							);		
		commit;

	end if;

	exception
	   when others then
		rollback;

		ds_stack_w	:= substr(dbms_utility.format_call_stack,1,2000);
		ds_log_cpoe_w := substr('CPOE_GERAR_MATERIAL_ROTINA '
			||  CHR(10) || '| nr_atendimento_p: ' || NR_ATENDIMENTO_P
			||  CHR(10) || '| nr_seq_produto_p: ' || NR_SEQ_PRODUTO_P
			||  CHR(10) || '| cd_estabelecimento_p: ' || CD_ESTABELECIMENTO_P
			||  CHR(10) || '| cd_perfil_p: ' || CD_PERFIL_P
			||  CHR(10) || '| nm_usuario_p: ' || NM_USUARIO_P
			||  CHR(10) || '| cd_pessoa_fisica_p: ' || CD_PESSOA_FISICA_P
			||  CHR(10) || '| nr_seq_item_gerado_p: ' || NR_SEQ_ITEM_GERADO_P
			||  CHR(10) || '| nr_seq_transcricao_p: ' || NR_SEQ_TRANSCRICAO_P
			||  CHR(10) || '| ie_item_alta_p: ' || IE_ITEM_ALTA_P
			||  CHR(10) || '| ie_prescritor_aux_p: ' || IE_PRESCRITOR_AUX_P
			||  CHR(10) || '| cd_medico_p: ' || CD_MEDICO_P
			||  CHR(10) || '| ie_retrogrado_p: ' || IE_RETROGRADO_P
			||  CHR(10) || '| dt_inicio_p: ' || to_char(dt_inicio_p,'dd/mm/yyyy hh24:mi:ss')
			||  CHR(10) || '| nr_seq_pepo_p: ' || NR_SEQ_PEPO_P
			||  CHR(10) || '| nr_cirurgia_p: ' || NR_CIRURGIA_P
			||  CHR(10) || '| nr_cirurgia_patologia_p: ' || NR_CIRURGIA_PATOLOGIA_P
			||  CHR(10) || '| nr_seq_agenda_p: ' || NR_SEQ_AGENDA_P
			||  CHR(10) || '| nr_seq_conclusao_apae_p: ' || NR_SEQ_CONCLUSAO_APAE_P
			||  CHR(10) || '| ie_futuro_p: ' || IE_FUTURO_P
			||  CHR(10) || ' - ERRO: ' || sqlerrm
			|| chr(13) || ' - FUNCAO('||to_char(obter_funcao_ativa)||'); PERFIL('||to_char(obter_perfil_ativo)||')',1,2000);
			
		insert into log_cpoe(
			nr_sequencia,
			nr_atendimento, 
			dt_atualizacao, 
			nm_usuario, 
			ds_log, 
			ds_stack) 
		values (
			nextval('log_cpoe_seq'), 
			nr_atendimento_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			ds_log_cpoe_w, 
			ds_stack_w);
			
		commit;

		CALL wheb_mensagem_pck.exibir_mensagem_abort(sqlerrm);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_material_rotina ( nr_atendimento_p bigint, nr_seq_produto_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_pessoa_fisica_p text, nr_seq_item_gerado_p INOUT bigint, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, nr_seq_conclusao_apae_p bigint default null, ie_futuro_p text default 'N', nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) FROM PUBLIC;

