-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_processamento_conta ( nr_interno_conta_p bigint, nm_usuario_p text) AS $body$
DECLARE


/*Esta rotina irá apenas voltar os valores originais do procedimento para o reprocessamento, não irá atualizar as demais informações que não serão utilizadas no processo*/

nr_seq_conta_des_w	conta_paciente.nr_interno_conta%type;
ie_status_conta_des_w	conta_paciente.ie_status_acerto%type;

nr_seq_proc_partic_w	procedimento_paciente.nr_sequencia%type;
ie_valor_inf_proc_w	procedimento_paciente.ie_valor_informado%type;

nr_seq_mat_partic_w	material_atend_paciente.nr_sequencia%type;
ie_valor_inf_mat_w	material_atend_paciente.ie_valor_informado%type;

cursor_dados_proc CURSOR(nr_interno_conta_pc bigint) FOR
	SELECT	a.nr_sequencia,
		a.nr_atendimento,
		a.cd_convenio,
		a.cd_categoria,
		a.nr_seq_proc_pacote,
		b.ie_tipo_valor,
		b.vl_procedimento,
		b.vl_medico,
		b.vl_anestesista,
		b.vl_materiais,
		b.vl_auxiliares,
		b.vl_custo_operacional
	from	procedimento_paciente a,
		proc_paciente_valor b
	where	a.nr_sequencia = b.nr_seq_procedimento
	and	a.nr_interno_conta = nr_interno_conta_p
	and	b.ie_tipo_valor in (94,95);

cursor_dados_mat CURSOR(nr_interno_conta_pc bigint) FOR
	SELECT	a.nr_sequencia,
		b.ie_tipo_valor,
		b.vl_material
	from	material_atend_paciente a,
		mat_atend_paciente_valor b
	where	a.nr_sequencia = b.nr_seq_material
	and	a.nr_interno_conta = nr_interno_conta_p
	and	b.ie_tipo_valor in (94,95)
	order by	b.vl_material desc;
BEGIN

if (nr_interno_conta_p IS NOT NULL AND nr_interno_conta_p::text <> '') then

	/*Verificar se a conta particular está fechada*/

	select	max(nr_seq_conta_des)
	into STRICT	nr_seq_conta_des_w
	from	conta_pac_deducao_conv
	where	nr_seq_conta_orig = nr_interno_conta_p;

	select	max(ie_status_acerto)
	into STRICT	ie_status_conta_des_w
	from	conta_paciente
	where	nr_interno_conta = nr_seq_conta_des_w;

	/*Retornar os valores dos procedimentos*/

	for dados_proc in cursor_dados_proc(nr_interno_conta_p) loop

		if (dados_proc.ie_tipo_valor = 95) then
			ie_valor_inf_proc_w	:= 'S';
		else
			ie_valor_inf_proc_w	:= 'N';
		end if;

		/*Excluir o item com o rateio da dedução*/

		if (ie_status_conta_des_w = 1) then
			select	max(nr_seq_propaci_dest)
			into STRICT	nr_seq_proc_partic_w
			from	conta_pac_ded_conv_item
			where	nr_seq_propaci_origem = dados_proc.nr_sequencia;

			delete	from conta_pac_ded_conv_item
			where	nr_seq_propaci_origem = dados_proc.nr_sequencia;

			delete	from procedimento_paciente
			where	nr_sequencia = nr_seq_proc_partic_w;
		end if;

		/*Retornar o valor do procedimento para o valor antes da dedução*/

		update	procedimento_paciente
		set	ie_valor_informado = ie_valor_inf_proc_w,
			vl_procedimento = dados_proc.vl_procedimento,
			vl_medico = dados_proc.vl_medico,
			vl_anestesista = dados_proc.vl_anestesista,
			vl_materiais = dados_proc.vl_materiais,
			vl_auxiliares = dados_proc.vl_auxiliares,
			vl_custo_operacional = dados_proc.vl_custo_operacional
		where	nr_sequencia = dados_proc.nr_sequencia;

		/*Atualizar o valor do procedimento, se não informado manualmente, caso tenha alguma alteração de preço*/

		if (ie_valor_inf_proc_w = 'N') then
			CALL atualiza_preco_procedimento(dados_proc.nr_sequencia, dados_proc.cd_convenio, nm_usuario_p);
		else
			if (dados_proc.nr_sequencia = coalesce(dados_proc.nr_seq_proc_pacote,0)) then
				CALL calcular_pacote(dados_proc.nr_atendimento, nr_interno_conta_p, dados_proc.cd_convenio, dados_proc.cd_categoria, nm_usuario_p, 'N', 'N', 'N', 'S', 'N');
			else
				CALL gerar_tributo_conta_pac(nr_interno_conta_p, dados_proc.nr_sequencia, 'P', nm_usuario_p);
			end if;
		end if;

	end loop;

	/*Retornar os valores dos materiais*/

	for dados_mat in cursor_dados_mat(nr_interno_conta_p) loop

		if (dados_mat.ie_tipo_valor = 95) then
			ie_valor_inf_mat_w	:= 'S';
		else
			ie_valor_inf_mat_w	:= 'N';
		end if;

		/*Excluir o item com o rateio da dedução*/

		if (ie_status_conta_des_w = 1) then
			select	max(nr_seq_matpaci_dest)
			into STRICT	nr_seq_mat_partic_w
			from	conta_pac_ded_conv_item
			where	nr_seq_matpaci_origem = dados_mat.nr_sequencia;

			delete	from conta_pac_ded_conv_item
			where	nr_seq_matpaci_origem = dados_mat.nr_sequencia;

			delete	from material_atend_paciente
			where	nr_sequencia = nr_seq_mat_partic_w;
		end if;

		/*Retornar o valor do procedimento para o valor antes da dedução*/

		update	material_atend_paciente
		set	ie_valor_informado = ie_valor_inf_mat_w,
			vl_material = dados_mat.vl_material,
			vl_unitario = dividir(dados_mat.vl_material, qt_material)
		where	nr_sequencia = dados_mat.nr_sequencia;

		/*Atualizar o valor do material e do imposto*/

		if (ie_valor_inf_mat_w = 'N') then
			CALL atualiza_preco_material(dados_mat.nr_sequencia, nm_usuario_p);
		else
			CALL gerar_tributo_conta_pac(nr_interno_conta_p, dados_mat.nr_sequencia, 'M', nm_usuario_p);
		end if;

	end loop;

	if (coalesce(nr_seq_conta_des_w,0) > 0) then
		if (ie_status_conta_des_w = 2) then
			CALL Cancelar_Conta_Paciente(nr_seq_conta_des_w, nm_usuario_p, 'N');
		else
			update	conta_pac_deducao_conv
			set		nr_seq_conta_des  = NULL
			where	nr_seq_conta_des = nr_seq_conta_des_w;

			delete from conta_paciente a
			where nr_interno_conta = nr_seq_conta_des_w
			and not exists (SELECT	1
							from	procedimento_paciente x
							where	x.nr_interno_conta = a.nr_interno_conta)
			and not exists (select 1
							from	material_atend_paciente x
							where	x.nr_interno_conta	= a.nr_interno_conta);
		end if;
	end if;

	/* Alterado para provisoriamente atualizar isso só no final na processar_conta, que é chamada sempre depois de excluir
	update	conta_pac_deducao_conv
	set	dt_atualizacao = sysdate,
		nm_usuario = nm_usuario_p,
		nr_seq_conta_des = null,
		dt_processamento = null,
		vl_calculado = null
	where	nr_seq_conta_orig = nr_interno_conta_p;
	*/
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_processamento_conta ( nr_interno_conta_p bigint, nm_usuario_p text) FROM PUBLIC;

