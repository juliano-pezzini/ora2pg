-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mprev_gerar_captacao_indicacao ( nr_seq_indicacao_p bigint, nm_usuario_p text, nr_seq_captacao_p INOUT bigint) AS $body$
DECLARE


nr_seq_captacao_w  bigint;
cd_pessoa_fisica_w  varchar(10);
nr_seq_forma_ingresso_w  mprev_forma_ingresso.nr_sequencia%type;
ie_origem_capt_w  mprev_forma_ingresso.ie_origem%type;
cd_estabelecimento_origem_w  mprev_indicacao_paciente.CD_ESTABELECIMENTO_ORIGEM%type;


BEGIN

begin
  select  x.nr_sequencia
  into STRICT  nr_seq_captacao_w
  from  mprev_captacao x
  where  x.nr_seq_indicacao = nr_seq_indicacao_p;
exception
  when  no_data_found then
    nr_seq_captacao_w := null;
end;

if (coalesce(nr_seq_captacao_w::text, '') = '') then

  select  max(a.cd_pessoa_fisica),
      max(a.nr_seq_forma_ingresso),
      max(a.cd_estabelecimento_origem)    
  into STRICT  cd_pessoa_fisica_w,
      nr_seq_forma_ingresso_w,
      cd_estabelecimento_origem_w
  from  mprev_indicacao_paciente a
  where  a.nr_sequencia = nr_seq_indicacao_p;

  select   coalesce(max(ie_origem),'OU') -- OU "Outros".
  into STRICT  ie_origem_capt_w
  from    MPREV_FORMA_INGRESSO
  where  nr_sequencia = nr_seq_forma_ingresso_w;

  select  nextval('mprev_captacao_seq')
  into STRICT  nr_seq_captacao_w
;

  insert  into mprev_captacao(nr_sequencia, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, 
                cd_pessoa_fisica, nr_seq_indicacao, ie_status, 
                ie_origem, cd_estabelecimento)
               values (nr_seq_captacao_w, clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p,
                cd_pessoa_fisica_w, nr_seq_indicacao_p, 'N', 
                ie_origem_capt_w, cd_estabelecimento_origem_w);
  commit;

end if;

nr_seq_captacao_p := nr_seq_captacao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mprev_gerar_captacao_indicacao ( nr_seq_indicacao_p bigint, nm_usuario_p text, nr_seq_captacao_p INOUT bigint) FROM PUBLIC;

