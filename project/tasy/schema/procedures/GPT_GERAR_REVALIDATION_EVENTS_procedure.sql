-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gpt_gerar_revalidation_events (nr_atendimento_p bigint, nr_seq_cpoe_p bigint, ie_tipo_item_p text, nr_seq_revalidation_rule_p bigint, nm_usuario_p text) AS $body$
DECLARE


dt_validacao_w				timestamp;
dt_hora_fim_revalidacao_w	gpt_revalidation_rule.dt_hora_fim_revalidacao%type;
qt_dias_revalidacao_w		gpt_revalidation_rule.qt_dias_revalidacao%type;
cd_profissional_ant_w		gpt_revalidation_events.cd_profissional%type;
cd_estabelecimento_w		gpt_revalidation_rule.cd_estabelecimento%type;
cd_setor_atendimento_w		gpt_revalidation_rule.cd_setor_atendimento%type;


BEGIN

cd_estabelecimento_w 	:= wheb_usuario_pck.get_cd_estabelecimento;
cd_setor_atendimento_w 	:= wheb_usuario_pck.get_cd_setor_atendimento;

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') and (ie_tipo_item_p not in ('MAT', 'HM', 'AP')) and (nr_seq_revalidation_rule_p IS NOT NULL AND nr_seq_revalidation_rule_p::text <> '') then
	
	
	select	max(dt_hora_fim_revalidacao),
			max(qt_dias_revalidacao) 
	into STRICT	dt_hora_fim_revalidacao_w,
			qt_dias_revalidacao_w
	from	gpt_revalidation_rule
	where	nr_sequencia = nr_seq_revalidation_rule_p 
	and 	coalesce(ie_situacao, 'A') = 'A'
	and (cd_estabelecimento = cd_estabelecimento_w 
	or 		coalesce(cd_estabelecimento::text, '') = '') 
	and (cd_setor_atendimento = cd_setor_atendimento_w
	or		coalesce(cd_setor_atendimento::text, '') = '');
	
											
	if qt_dias_revalidacao_w > 0 then
	
		dt_validacao_w := ((to_date((to_char(clock_timestamp(), 'dd/mm/yyyy ') || to_char(dt_hora_fim_revalidacao_w, 'hh24:mi:ss')), 'dd/mm/yyyy hh24:mi:ss') + (	qt_dias_revalidacao_w)));
			
		begin
			cd_profissional_ant_w := gpt_obter_prof_reval_events(nr_seq_cpoe_p, ie_tipo_item_p);
		exception when others then
			cd_profissional_ant_w := null;
		end;
	
		
		insert into gpt_revalidation_events(
					nr_sequencia,
					dt_atualizacao, 
					nm_usuario, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec, 
					cd_profissional, 
					nr_atendimento, 
					cd_profissional_anterior, 
					nr_seq_cpoe, 
					ie_tipo_item, 
					nr_seq_revalidation_rule,
					dt_validacao,
					cd_estabelecimento)
					values (
					nextval('gpt_revalidation_events_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					obter_pf_usuario(nm_usuario_p,'C'),
					nr_atendimento_p,
					cd_profissional_ant_w,
					nr_seq_cpoe_p,
					ie_tipo_item_p,
					nr_seq_revalidation_rule_p,
					dt_validacao_w,
					cd_estabelecimento_w);
					
		commit;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gpt_gerar_revalidation_events (nr_atendimento_p bigint, nr_seq_cpoe_p bigint, ie_tipo_item_p text, nr_seq_revalidation_rule_p bigint, nm_usuario_p text) FROM PUBLIC;

