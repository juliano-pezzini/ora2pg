-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cp_review_record ( nm_tabela_p text, nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_comando_w		varchar(2000);
ie_consiste_w		varchar(1) := 'N';
				

BEGIN

CALL cp_validate_record(nm_tabela_p,nr_sequencia_p,nm_usuario_p);


/*  ----- CADASTROS - Fazer update no registro selecionado e update nos registros da aba Plano de Cuidado onde utiliza o cadastro selecionado*/

if (nm_tabela_p = 'CP_MEASURE') then

	/*Cadastros >> Mensuração*/

	update	cp_measure
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	nr_sequencia = nr_sequencia_p;
	
elsif (nm_tabela_p = 'CP_INTERVENTION_ITEM') then
	
	/*Cadastros >> Atividades*/

	update	cp_intervention_item
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	nr_sequencia = nr_sequencia_p;
	
elsif (nm_tabela_p = 'CP_INTERVENTION_ITEM_ASSOC') then
	
	/*Cadastros >> Intervenções >> Atividades*/

	update	cp_intervention_item_assoc
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	nr_sequencia = nr_sequencia_p;
		
elsif (nm_tabela_p = 'CP_INTERVENTION_CLIN_TERM') then
	
	/*Cadastros >> Intervenções >> Termos clínicos*/

	update	cp_intervention_clin_term
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	nr_sequencia = nr_sequencia_p;	

elsif (nm_tabela_p = 'CP_INDICATOR_MEASURE_GUID') then

	/*Cadastros >> Indicadores >> Mensuração >> Orientação*/

	update	cp_indicator_measure_guid
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	nr_sequencia = nr_sequencia_p;
		
elsif (nm_tabela_p = 'CP_GUIDANCE') then
	
	/*Cadastros >> Orientação*/

	update	cp_guidance
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	nr_sequencia = nr_sequencia_p;
	
	/*Plano de cuidado >> Problemas >> Plano de intervenção >> Orientação*/

	update	cp_interv_plan_guid
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	nr_seq_guidance = nr_sequencia_p;	
	
elsif (nm_tabela_p = 'CP_GOAL_INDICATOR') then

	/*Cadastros >> Metas >> Indicadores da meta*/

	update	cp_goal_indicator
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	nr_sequencia = nr_sequencia_p;
	
elsif (nm_tabela_p = 'CP_GOAL_CLIN_TERM') then

	/*Cadastros >> Metas >> Termos clínicos*/

	update	cp_goal_clin_term
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	nr_sequencia = nr_sequencia_p;	
	
elsif (nm_tabela_p = 'CP_PROBLEM') then

	/*Cadastros >> Problemas*/

	update	cp_problem
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	nr_sequencia = nr_sequencia_p;		
	
	/*Plano de cuidado >> Problemas*/

	update	cp_possible_prob
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	nr_seq_problem = nr_sequencia_p;	
	
elsif (nm_tabela_p = 'CP_CLINICAL_TERM') then

	/*Cadastros >> Termos clínicos*/

	update	cp_clinical_term
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	nr_sequencia = nr_sequencia_p;	

	/*Plano de cuidado >> Termos clínicos*/

	update	cp_clinical_term_assoc
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	nr_seq_clin_term = nr_sequencia_p;
	
elsif (nm_tabela_p = 'CP_INTERVENTION') then

	/*Cadastros >> Intervenções*/

	update	cp_intervention
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	nr_sequencia = nr_sequencia_p;
	
	/*Plano de cuidado >> Problemas >> Plano de intervenções >> Intervenção*/

	update	cp_interv_plan_assoc
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	nr_seq_intervention = nr_sequencia_p;
	
elsif (nm_tabela_p = 'CP_INDICATOR_MEASURE') then

	/*Cadastros >> Indicadores >> Mensuração*/

	update	cp_indicator_measure
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	nr_sequencia = nr_sequencia_p;
	
	
elsif (nm_tabela_p = 'CP_INDICATOR') then
	
	/*Cadastros >> Indicadores*/

	update	cp_indicator
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	nr_sequencia = nr_sequencia_p;
	
	
elsif (nm_tabela_p = 'CP_GOAL') then

	/*Cadastros >> Metas*/

	update	cp_goal
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	nr_sequencia = nr_sequencia_p;
	
	/*Plano de cuidado >> Meta educacional*/

	update	cp_education
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	nr_seq_goal = nr_sequencia_p;
	
	/*Plano de cuidado >> Problemas >> Metas de cuidado*/

	update	cp_problem_goal
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	nr_seq_goal = nr_sequencia_p;
	
end if;


/*  ----- PLANO DE CUIDADO - Fazer update no registro selecionado e update nos registros da aba Plano de Cuidado onde utiliza o cadastro selecionado*/

if (nm_tabela_p = 'CARE_PLAN') then

	/*Plano de cuidado*/

	update	care_plan
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	nr_sequencia = nr_sequencia_p;	
	
	/*Plano de cuidado >> População*/

	update	cp_population
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	nr_seq_care_plan = nr_sequencia_p
	and	si_import_status = 'UP';
	
	/*Plano de cuidado >> Problemas*/

	update	cp_possible_prob
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	si_import_status = 'UP'
	and	nr_seq_care_plan = nr_sequencia_p;
	
	
	/*Plano de cuidado >> Problemas >> Metas de cuidado*/

	update	cp_problem_goal
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	si_import_status = 'UP'
	and	nr_seq_possible_prob in (
		SELECT	nr_sequencia
		from	cp_possible_prob
		where	nr_seq_care_plan = nr_sequencia_p);
		
	/*Plano de cuidado >> Problemas >> Plano de intervenções*/

	update	cp_interv_plan
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	si_import_status = 'UP'
	and	nr_seq_possible_prob in (
		SELECT	nr_sequencia
		from	cp_possible_prob
		where	nr_seq_care_plan = nr_sequencia_p);
		
		
	/*Plano de cuidado >> Problemas >> Plano de intervenções >> Intervenção*/

	update	cp_interv_plan_assoc
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	si_import_status = 'UP'
	and	nr_seq_interv_plan in (
		SELECT	nr_sequencia
		from	cp_interv_plan
		where	nr_seq_possible_prob in (
			SELECT	nr_sequencia
			from	cp_possible_prob
			where	nr_seq_care_plan = nr_sequencia_p));
			
	/*Plano de cuidado >> Problemas >> Plano de intervenções >> Orientação*/

	update	cp_interv_plan_guid
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	si_import_status = 'UP'
	and	nr_seq_interv_plan in (
		SELECT	nr_sequencia
		from	cp_interv_plan
		where	nr_seq_possible_prob in (
			SELECT	nr_sequencia
			from	cp_possible_prob
			where	nr_seq_care_plan = nr_sequencia_p));
	
	/*Plano de cuidado >> Termos clínicos*/

	update	cp_clinical_term_assoc
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	si_import_status = 'UP'
	and	nr_seq_care_plan = nr_sequencia_p;
	
	/*Plano de cuidado >> Meta educacional*/

	update	cp_education
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	si_import_status = 'UP'
	and	nr_seq_care_plan = nr_sequencia_p;
	
	/*Plano de cuidado >> Meta educacional*/

	update	cp_keyword
	set 	si_import_status =  'UR',
		dt_atualizacao = clock_timestamp(),
		nm_usuario  = nm_usuario_p
	where	si_import_status = 'UP'
	and	nr_seq_care_plan = nr_sequencia_p;

	/*A ativação é feita somente quando revisa o care plan, pois a rotina de ativação já vare todos os registros do care plan para ir ativando*/

	CALL cp_active_inactive_care_plan(nr_sequencia_p,nm_usuario_p);
	
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cp_review_record ( nm_tabela_p text, nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

