-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_crit_rateio_oc_transf ( nr_ordem_compra_p bigint, nm_usuario_p text, ds_retorno_p INOUT text) AS $body$
DECLARE


nr_item_oci_w	integer;
cd_material_w	integer;
ds_material_w	varchar(255);
ds_retorno_w	varchar(255);
ds_erro_w	varchar(255);

C01 CURSOR FOR
	SELECT	a.nr_item_oci,
		a.cd_material,
		b.ds_material
	from	ordem_compra_item a,
		material b
	where	a.cd_material = b.cd_material
	and	coalesce(a.nr_seq_criterio_rateio::text, '') = ''
	and	(((a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> '') and coalesce(a.cd_local_estoque::text, '') = '') or (substr(obter_se_local_direto(a.cd_local_estoque),1,1) = 'S'))
	and	a.nr_ordem_compra = nr_ordem_compra_p;


BEGIN
open C01;
loop
fetch C01 into
	nr_item_oci_w,
	cd_material_w,
	ds_material_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	ds_retorno_w := substr(ds_retorno_w || adiciona_zeros_esquerda(to_char(nr_item_oci_w),5) || ' - [' || adiciona_zeros_esquerda(to_char(cd_material_w),6) || '] - ' || substr(ds_material_w,1,40) || chr(13) || chr(10),1,255);
	ds_erro_w := substr(adiciona_zeros_esquerda(to_char(nr_item_oci_w),5) || ' - (' || adiciona_zeros_esquerda(to_char(cd_material_w),6) || ') ' || ds_material_w,1,255);
	CALL gravar_ordem_compra_consist(nr_ordem_compra_p, '12', ds_erro_w, 'C',  null, nm_usuario_p);
end loop;
close C01;

if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
	-- Deve ser informado crit√©rio de rateio para os itens abaixo:
	ds_retorno_w := substr(wheb_mensagem_pck.get_texto(298734,'DS_ITENS='||ds_retorno_w),1,255);
end if;

ds_retorno_p := ds_retorno_w;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_crit_rateio_oc_transf ( nr_ordem_compra_p bigint, nm_usuario_p text, ds_retorno_p INOUT text) FROM PUBLIC;

