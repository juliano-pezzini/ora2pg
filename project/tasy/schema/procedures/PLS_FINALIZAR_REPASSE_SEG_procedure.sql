-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_finalizar_repasse_seg ( nr_seq_seg_repasse_p bigint, dt_fim_repasse_p timestamp, ie_commit_p text, nm_usuario_p text) AS $body$
DECLARE


dt_liberacao_w			timestamp;
nr_seq_segurado_w		bigint;
ie_tipo_segurado_ant_w		varchar(1);
nr_seq_intercambio_w		bigint;
ie_tipo_segurado_w		varchar(10);
ie_tipo_contrato_w		varchar(10);
qt_reg_w			bigint;
ie_tipo_compartilhamento_w	pls_segurado_repasse.ie_tipo_compartilhamento%type;
nr_seq_contrato_w		pls_contrato.nr_sequencia%type;
ie_tipo_operacao_w		pls_contrato.ie_tipo_operacao%type;


BEGIN

select	dt_liberacao,
	nr_seq_segurado,
	ie_tipo_compartilhamento
into STRICT	dt_liberacao_w,
	nr_seq_segurado_w,
	ie_tipo_compartilhamento_w
from	pls_segurado_repasse
where	nr_sequencia	= nr_seq_seg_repasse_p;

if (dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '') then
	select	ie_tipo_segurado,
		nr_seq_intercambio,
		nr_seq_contrato
	into STRICT	ie_tipo_segurado_ant_w,
		nr_seq_intercambio_w,
		nr_seq_contrato_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_w;

	ie_tipo_segurado_w	:= 'B';
	
	update	pls_segurado_repasse
	set	dt_fim_repasse	= dt_fim_repasse_p,
		dt_fim_real	= clock_timestamp(),
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_seq_seg_repasse_p;
	
	if (nr_seq_intercambio_w IS NOT NULL AND nr_seq_intercambio_w::text <> '') then
		select	ie_tipo_contrato
		into STRICT	ie_tipo_contrato_w
		from	pls_intercambio
		where	nr_sequencia	= nr_seq_intercambio_w;
		
		if (ie_tipo_contrato_w	= 'C') then
			ie_tipo_segurado_w	:= 'C';
		else
			ie_tipo_segurado_w	:= 'T';
		end if;	
	elsif (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then
		select	max(ie_tipo_operacao)
		into STRICT	ie_tipo_operacao_w
		from	pls_contrato
		where	nr_sequencia = nr_seq_contrato_w;
		
		if (ie_tipo_operacao_w = 'A') then
			ie_tipo_segurado_w	:= ie_tipo_operacao_w;
		end if;
	end if;	

	select	count(1)
	into STRICT	qt_reg_w
	from	pls_segurado_repasse
	where	nr_seq_segurado = nr_seq_segurado_w
    and     ie_tipo_compartilhamento = 1
	and	    nr_sequencia <> nr_seq_seg_repasse_p
	and	    (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	    coalesce(dt_fim_repasse::text, '') = '';
	
	if 	((trunc(dt_fim_repasse_p) <= (trunc(clock_timestamp()))) and (qt_reg_w = 0)) and (ie_tipo_compartilhamento_w = 1) then
		update	pls_segurado
		set	ie_tipo_segurado	= ie_tipo_segurado_w,
			nm_usuario		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp(),
			dt_alteracao_tipo_segurado = CASE WHEN ie_tipo_segurado=ie_tipo_segurado_w THEN  dt_alteracao_tipo_segurado  ELSE trunc(clock_timestamp(),'dd') END
		where	nr_sequencia		= nr_seq_segurado_w;
	end if;
	
	if (coalesce(nr_seq_intercambio_w::text, '') = '') then
		update	pls_segurado_carteira
		set	nr_cartao_intercambio	 = NULL
		where	nr_seq_segurado	= nr_seq_segurado_w;	
	end if;

	CALL pls_gerar_segurado_historico(	nr_seq_segurado_w, '32', clock_timestamp(), wheb_mensagem_pck.get_texto(1108741, 'IE_TIPO_SEGURADO_ANT='||obter_valor_dominio(2406,ie_tipo_segurado_ant_w)||';IE_TIPO_SEGURADO='||obter_valor_dominio(2406,ie_tipo_segurado_w)),
					'pls_finalizar_repasse_seg', null, null, null,
					null, null, null, null,
					null, null, null, null,
					nm_usuario_p, 'N');			
end if;

if (ie_commit_p = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_finalizar_repasse_seg ( nr_seq_seg_repasse_p bigint, dt_fim_repasse_p timestamp, ie_commit_p text, nm_usuario_p text) FROM PUBLIC;

