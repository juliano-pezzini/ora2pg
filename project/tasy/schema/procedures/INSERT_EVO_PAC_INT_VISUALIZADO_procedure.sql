-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_evo_pac_int_visualizado (NR_ATENDIMENTO_P bigint, NM_USUARIO_P text, CD_EVOLUCAO_P EVOLUCAO_PACIENTE.CD_EVOLUCAO%TYPE) AS $body$
DECLARE

  NR_SEQUENCIA_W EVO_PAC_INT_VISUALIZADO.NR_SEQUENCIA%TYPE;

BEGIN
  SELECT coalesce(MIN(EPV.NR_SEQUENCIA), 0)
    INTO STRICT NR_SEQUENCIA_W
    FROM EVO_PAC_INT_VISUALIZADO EPV
   WHERE EPV.NR_SEQ_EVO_PACIENTE = CD_EVOLUCAO_P
     AND EPV.NM_USUARIO = NM_USUARIO_P  LIMIT 1;

  IF (NR_SEQUENCIA_W = 0) THEN
    SELECT nextval('evo_pac_int_visualizado_seq')
      INTO STRICT NR_SEQUENCIA_W
;

    INSERT INTO EVO_PAC_INT_VISUALIZADO(NR_SEQUENCIA,
       NM_USUARIO,
       DT_ATUALIZACAO,
       NM_USUARIO_NREC,
       DT_ATUALIZACAO_NREC,
       NR_SEQ_EVO_PACIENTE)
    VALUES (NR_SEQUENCIA_W,
       NM_USUARIO_P,
       clock_timestamp(),
       NM_USUARIO_P,
       clock_timestamp(),
       CD_EVOLUCAO_P);

    COMMIT;
  ELSE
    DELETE FROM EVO_PAC_INT_VISUALIZADO EPV
     WHERE EPV.NR_SEQ_EVO_PACIENTE = CD_EVOLUCAO_P
       AND EPV.NM_USUARIO = NM_USUARIO_P
       AND EPV.NR_SEQUENCIA <> NR_SEQUENCIA_W;

    COMMIT;
  END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_evo_pac_int_visualizado (NR_ATENDIMENTO_P bigint, NM_USUARIO_P text, CD_EVOLUCAO_P EVOLUCAO_PACIENTE.CD_EVOLUCAO%TYPE) FROM PUBLIC;

