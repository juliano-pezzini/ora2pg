-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pa_gerar_medida_laudo ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
nr_seq_peca_w		bigint;
nr_seq_w		bigint;
nr_seq_proc_w		bigint;
nr_prescricao_w		bigint;
nr_seq_prescr_w		bigint;
dt_laudo_w		timestamp;

qt_anos_w		integer;
qt_peso_prescr_w	integer;
ie_sexo_w		varchar(10);
nr_atendimento_w	bigint;

cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;

qt_valor_minimo_w	double precision;
qt_valor_maximo_w	double precision;

vl_padrao_w		varchar(10);
ds_valor_medida_w	varchar(255);
ie_tipo_valor_w	varchar(5);
qt_peso_w		double precision;
qt_altura_cm_w	double precision;
qt_medida_w		double precision;
nr_Seq_interno_w	bigint;
nr_seq_apresent_w	bigint;
nr_seq_apresentacao_w	bigint;
cd_protocolo_w		bigint;
cd_especialidade_w	bigint;
cd_grupo_proc_w		bigint;
cd_area_procedimento_w	bigint;
ie_tipo_medida_w	varchar(15);
ie_existe_medida_w	bigint;

 
C01 CURSOR FOR 
SELECT	DISTINCT c.nr_sequencia, 
	UPPER(c.vl_padrao), 
	c.ie_tipo_valor, 
	coalesce(a.nr_seq_apresent,0), 
	c.nr_seq_apresentacao 
FROM	medida_exame_laudo c, 
	tipo_medida_laudo b, 
	tipo_medida_laudo_proc a, 
	tipo_medida_laudo_peca d 
WHERE	a.nr_seq_tipo		= b.nr_sequencia 
AND 	b.nr_sequencia		= c.nr_seq_tipo_medida 
AND	b.nr_sequencia		= d.nr_seq_tipo_medida 
AND	d.nr_tipo_amostra_pato	= nr_seq_peca_w 
AND (a.nr_seq_proc_interno = nr_seq_interno_w) 
AND	Obter_Se_mostra_medida(cd_protocolo_w, b.nr_sequencia) = 'S' 
AND	c.ie_situacao		= 'A' 
AND coalesce(b.ie_situacao,'A')		= 'A' 

UNION
 
SELECT	c.nr_sequencia, 
	UPPER(c.vl_padrao), 
	c.ie_tipo_valor, 
	coalesce(a.nr_seq_apresent,0), 
	c.nr_seq_apresentacao 
FROM	medida_exame_laudo c, 
	tipo_medida_laudo b, 
	tipo_medida_laudo_proc a, 
	tipo_medida_laudo_peca d 
WHERE	a.nr_seq_tipo		= b.nr_sequencia 
AND 	b.nr_sequencia		= c.nr_seq_tipo_medida 
AND	b.nr_sequencia		= d.nr_seq_tipo_medida 
AND	d.nr_tipo_amostra_pato	= nr_seq_peca_w 
AND	coalesce(a.cd_procedimento,cd_procedimento_w)	= cd_procedimento_w 
AND	coalesce(a.ie_origem_proced,ie_origem_proced_w)	= ie_origem_proced_w 
AND	cd_especialidade_w	= coalesce(a.cd_especialidade,cd_especialidade_w) 
AND	cd_grupo_proc_w		= coalesce(a.cd_grupo_proc,cd_grupo_proc_w) 
AND	cd_area_procedimento_w	= coalesce(a.cd_area_procedimento,cd_area_procedimento_w) 
AND	Obter_Se_mostra_medida(cd_protocolo_w, b.nr_sequencia) = 'S' 
AND	c.ie_situacao		= 'A' 
AND coalesce(b.ie_situacao,'A')		= 'A' 
ORDER BY 4,5;

C02 CURSOR FOR 
SELECT	QT_VALOR_MINIMO, 
	QT_VALOR_MAXIMO 
FROM	MEDIDA_EXAME_REFER 
WHERE	NR_SEQ_MEDIDA = nr_seq_w 
AND (ie_sexo = ie_sexo_w OR ie_sexo = 'A') 
AND	qt_anos_w BETWEEN qt_idade_minima AND qt_idade_maxima 
AND	qt_peso_prescr_w BETWEEN coalesce(qt_peso_minimo,qt_peso_prescr_w) AND coalesce(qt_peso_maximo,qt_peso_prescr_w) 
AND (coalesce(ie_tipo_medida,1) = coalesce(coalesce(ie_tipo_medida_w, ie_tipo_medida) ,1)) 
ORDER	BY ie_sexo;

C03 CURSOR FOR 
SELECT 	z.nr_seq_amostra_princ 
FROM	prescr_proc_peca z 
WHERE	z.nr_prescricao = nr_prescricao_w 
AND	z.nr_seq_prescr = nr_seq_prescr_w 
AND	coalesce(z.nr_seq_peca::text, '') = '';

 
 
 

BEGIN 
 
SELECT	nr_seq_proc, 
	nr_prescricao, 
	nr_seq_prescricao, 
	dt_laudo, 
	ie_tipo_medida, 
	cd_protocolo 
INTO STRICT	nr_seq_proc_w, 
	nr_prescricao_w, 
	nr_seq_prescr_w, 
	dt_laudo_w, 
	ie_tipo_medida_w, 
	cd_protocolo_w 
FROM	laudo_paciente 
WHERE	nr_sequencia = nr_sequencia_p;
 
SELECT	(obter_idade(b.dt_nascimento, dt_laudo_w, 'A'))::numeric , 
	coalesce(b.ie_sexo,'A') 
INTO STRICT	qt_anos_w, 
	ie_sexo_w 
FROM	pessoa_fisica b, 
	prescr_medica a 
WHERE	a.cd_pessoa_fisica	= b.cd_pessoa_fisica 
AND	a.nr_prescricao 	= nr_prescricao_w;
 
SELECT	coalesce(obter_peso_prescr_sinal(nr_prescricao_w),0) 
INTO STRICT	qt_peso_prescr_w
;
 
IF (nr_seq_proc_w IS NOT NULL AND nr_seq_proc_w::text <> '') THEN 
	BEGIN 
	SELECT	cd_procedimento, 
		ie_origem_proced, 
		nr_Seq_proc_interno 
	INTO STRICT	cd_procedimento_w, 
		ie_origem_proced_w, 
		nr_Seq_interno_w 
	FROM	procedimento_paciente 
	WHERE	nr_sequencia = nr_seq_proc_w;
	EXCEPTION 
	WHEN OTHERS THEN 
		cd_procedimento_w	:= NULL;
		ie_origem_proced_w	:= NULL;
	END;
ELSE 
	BEGIN 
	SELECT	cd_procedimento, 
		ie_origem_proced, 
		nr_Seq_proc_interno 
	INTO STRICT	cd_procedimento_w, 
		ie_origem_proced_w, 
		nr_Seq_interno_w 
	FROM	prescr_procedimento 
	WHERE	nr_prescricao	= nr_prescricao_w 
	AND	nr_sequencia	= nr_seq_prescr_w;
	EXCEPTION 
	WHEN OTHERS THEN 
		cd_procedimento_w	:= NULL;
		ie_origem_proced_w	:= NULL;
	END;
END IF;
 
SELECT	MAX(cd_especialidade), 
	MAX(cd_grupo_proc), 
	MAX(cd_area_procedimento) 
INTO STRICT	cd_especialidade_w, 
	cd_grupo_proc_w, 
	cd_area_procedimento_w 
FROM	estrutura_procedimento_v 
WHERE	cd_procedimento = cd_procedimento_w 
AND	ie_origem_proced = ie_origem_proced_w;
 
OPEN c03;
LOOP 
FETCH c03 INTO 
	nr_seq_peca_w;
EXIT WHEN NOT FOUND; /* apply on c03 */
	OPEN C01;
	LOOP 
	FETCH C01 INTO 
		nr_seq_w, 
		vl_padrao_w, 
		ie_tipo_valor_w, 
		nr_seq_apresent_w, 
		nr_seq_apresentacao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		SELECT	COUNT(*) 
		INTO STRICT	ie_existe_medida_w 
		FROM	laudo_paciente_medida 
		WHERE	nr_seq_laudo = nr_sequencia_p 
		AND	nr_seq_medida = nr_seq_w;
 
		IF (ie_existe_medida_w <= 0) THEN 
			qt_valor_minimo_w	:= NULL;
			qt_valor_maximo_w	:= NULL;
 
			OPEN c02;
			LOOP 
			FETCH c02 INTO 
				qt_valor_minimo_w, 
				qt_valor_maximo_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
			END LOOP;
			CLOSE c02;
 
			ds_valor_medida_w	:= '';
			qt_medida_w		:= NULL;
			IF (vl_padrao_w = '@PESO') THEN 
 
				SELECT	QT_PESO 
				INTO STRICT	qt_peso_w 
				FROM	prescr_medica 
				WHERE	nr_prescricao	= nr_prescricao_w;
				IF (ie_tipo_valor_w = 'N') THEN 
					qt_medida_w		:= qt_peso_w;
				ELSE 
					ds_valor_medida_w	:= qt_peso_w;
				END IF;
 
			ELSIF (vl_padrao_w = '@ALTURA') THEN 
 
				SELECT	QT_ALTURA_CM 
				INTO STRICT	qt_altura_cm_w 
				FROM	prescr_medica 
				WHERE	nr_prescricao	= nr_prescricao_w;
				IF (ie_tipo_valor_w = 'N') THEN 
					qt_medida_w		:= qt_altura_cm_w;
				ELSE 
					ds_valor_medida_w	:= qt_altura_cm_w;
				END IF;
 
			END IF;
 
			INSERT INTO laudo_paciente_medida(nr_sequencia, 
					nr_seq_laudo, 
					nr_seq_medida, 
					dt_atualizacao, 
					nm_usuario, 
					qt_minimo, 
					qt_maximo, 
					ds_valor_medida, 
					qt_medida) 
			VALUES (nextval('laudo_paciente_medida_seq'), 
					nr_sequencia_p, 
					nr_seq_w, 
					clock_timestamp(), 
					nm_usuario_p, 
					qt_valor_minimo_w, 
					qt_valor_maximo_w, 
					ds_valor_medida_w, 
					qt_medida_w);
		END IF;
 
	END LOOP;
	CLOSE C01;
END LOOP;
CLOSE c03;
 
COMMIT;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pa_gerar_medida_laudo ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

