-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_regra_sae ( nr_atendimento_p bigint, cd_setor_atendimento_p bigint) AS $body$
DECLARE


qt_reg_w					integer;
nr_seq_regra_w				bigint;
nr_seq_template_w       	bigint;
ie_informacao_w				varchar(10);
ds_template_w           	varchar(200);
ie_complexidade_assit_w		varchar(10);
ie_complexidade_assit2_w	varchar(10);
ie_complexidade_assit3_w	varchar(10);
ie_complexidade_assit4_w	varchar(10);

C01 CURSOR FOR
	SELECT	ie_informacao,
			nr_seq_template,
			nr_sequencia
	from	regra_consiste_inf_sae
	where	obter_se_regra_consist_sae_lib(nr_sequencia, cd_setor_atendimento_p)	= 'S'
	and		coalesce(ie_dia_semana,pkg_date_utils.get_WeekDay(clock_timestamp()))	= pkg_date_utils.get_WeekDay(clock_timestamp());

C02 CURSOR FOR
	SELECT	ie_complexidade_assit,
			ie_complexidade_assit2,
			ie_complexidade_assit3,
			ie_complexidade_assit4
	from	setor_atendimento
	where	cd_setor_atendimento	= cd_setor_atendimento_p;

C03 CURSOR FOR
	SELECT	nr_seq_template
	from	regra_cons_inf_sae_temp r
	where	r.nr_seq_regra	= nr_seq_regra_w;


BEGIN
open C01;
loop
fetch C01 into
	ie_informacao_w,
	nr_seq_template_w,
	nr_seq_regra_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	open C02;
	loop
	fetch C02 into
		ie_complexidade_assit_w,
		ie_complexidade_assit2_w,
		ie_complexidade_assit3_w,
		ie_complexidade_assit4_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		--Verifica se a regra consiste por dia
		if (ie_informacao_w	= 'GCA') then
		begin
			--Verifica a(s) escala(s) em que deve ser aplicada a regra
			if (ie_complexidade_assit_w = 'E')  or (ie_complexidade_assit2_w = 'E') or (ie_complexidade_assit3_w = 'E') or (ie_complexidade_assit4_w = 'E') then
				select	count(*)
				into STRICT	qt_reg_w
				from	gca_atendimento
				where	nr_atendimento	= nr_atendimento_p
				and		ie_situacao	= 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(176561);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'DT') or (ie_complexidade_assit2_w = 'DT') or (ie_complexidade_assit3_w = 'DT') or (ie_complexidade_assit4_w = 'DT') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_downton
				where	nr_atendimento	= nr_atendimento_p
				and		coalesce(ie_situacao,'A')	<> 'I'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(176562);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'D') or (ie_complexidade_assit2_w = 'D') or (ie_complexidade_assit3_w = 'D') or (ie_complexidade_assit4_w = 'D') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_dini
				where	nr_atendimento	= nr_atendimento_p
				and		ie_situacao	= 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(176563);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'M') or (ie_complexidade_assit2_w = 'M') or (ie_complexidade_assit3_w = 'M') or (ie_complexidade_assit4_w = 'M') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_mews
				where	nr_atendimento	= nr_atendimento_p
				and		ie_situacao	= 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(176564);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'MT') or (ie_complexidade_assit2_w = 'MT') or (ie_complexidade_assit3_w = 'MT') or (ie_complexidade_assit4_w = 'MT') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_must
				where	nr_atendimento	= nr_atendimento_p
				and		ie_situacao	= 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(176565);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'N') or (ie_complexidade_assit2_w = 'N') or (ie_complexidade_assit3_w = 'N') or (ie_complexidade_assit4_w = 'N') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_nas
				where	nr_atendimento	= nr_atendimento_p
				and		ie_situacao	= 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(176566);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'NT') or (ie_complexidade_assit2_w = 'NT') or (ie_complexidade_assit3_w = 'NT') or (ie_complexidade_assit4_w = 'NT') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_ntiss
				where	nr_atendimento	= nr_atendimento_p
				and		ie_situacao	= 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(176567);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'MO') or (ie_complexidade_assit2_w = 'MO') or (ie_complexidade_assit3_w = 'MO') or (ie_complexidade_assit4_w = 'MO') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_morse
				where	nr_atendimento	= nr_atendimento_p
				and		ie_situacao	= 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(176576);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'SF') or (ie_complexidade_assit2_w = 'SF') or (ie_complexidade_assit3_w = 'SF') or (ie_complexidade_assit4_w = 'SF') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_eif
				where	nr_atendimento	= nr_atendimento_p
				and		ie_situacao = 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(176577);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'T') or (ie_complexidade_assit2_w = 'T') or (ie_complexidade_assit3_w = 'T') or (ie_complexidade_assit4_w = 'T') then
				select	count(*)
				into STRICT	qt_reg_w
				from	tiss_interv_terapeutica
				where	nr_atendimento = nr_atendimento_p
				and		ie_situacao = 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(176568);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'AP') or (ie_complexidade_assit2_w = 'AP') or (ie_complexidade_assit3_w = 'AP') or (ie_complexidade_assit4_w = 'AP') then
				select	count(*)
				into STRICT	qt_reg_w
				from	apache
				where	nr_atendimento = nr_atendimento_p
				and	ie_situacao = 'A'
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(358477);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'TR') or (ie_complexidade_assit2_w = 'TR') or (ie_complexidade_assit3_w = 'TR') or (ie_complexidade_assit4_w = 'TR') then
				select	count(*)
				into STRICT	qt_reg_w
				from	atend_timi_risk
				where	nr_atendimento = nr_atendimento_p
				and	ie_situacao = 'A'
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(358478);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'GR') or (ie_complexidade_assit2_w = 'GR') or (ie_complexidade_assit3_w = 'GR') or (ie_complexidade_assit4_w = 'GR') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_grace_ii
				where	nr_atendimento = nr_atendimento_p
				and	ie_situacao = 'A'
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(358480);
				end if;
			end if;

			if (ie_complexidade_assit_w in ('SN','SE')) or (ie_complexidade_assit2_w in ('SN','SE')) or (ie_complexidade_assit3_w in ('SN','SE')) or (ie_complexidade_assit4_w in ('SN','SE')) then
				select	count(*)
				into STRICT	qt_reg_w
				from	ESCALA_SNAPII_SNAPPEII
				where	nr_atendimento = nr_atendimento_p
				and	ie_situacao = 'A'
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(358481);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'SA') or (ie_complexidade_assit2_w = 'SA') or (ie_complexidade_assit3_w = 'SA') or (ie_complexidade_assit4_w = 'SA') then
				select	count(*)
				into STRICT	qt_reg_w
				from	ESCALA_SAPS3
				where	nr_atendimento = nr_atendimento_p
				and	coalesce(ie_tipo_SAPS3,'ADM') = '28D'
				and	ie_situacao = 'A'
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(358487);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'SP') or (ie_complexidade_assit2_w = 'SP') or (ie_complexidade_assit3_w = 'SP') or (ie_complexidade_assit4_w = 'SP') then
				select	count(*)
				into STRICT	qt_reg_w
				from	ESCALA_SAPS3
				where	nr_atendimento = nr_atendimento_p
				and	coalesce(ie_tipo_SAPS3,'ADM') = 'PIR'
				and	ie_situacao = 'A'
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(358488);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'B') or (ie_complexidade_assit2_w = 'B') or (ie_complexidade_assit3_w = 'B') or (ie_complexidade_assit4_w = 'B') then
				select	count(*)
				into STRICT	qt_reg_w
				from	atend_escala_braden
				where	nr_atendimento = nr_atendimento_p
				and		ie_situacao = 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(185550);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'BQ') or (ie_complexidade_assit2_w = 'BQ') or (ie_complexidade_assit3_w = 'BQ') or (ie_complexidade_assit4_w = 'BQ') then
				select	count(*)
				into STRICT	qt_reg_w
				from	atend_escala_braden_q
				where	nr_atendimento = nr_atendimento_p
				and		ie_situacao = 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(185551);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'JH')  or (ie_complexidade_assit2_w = 'JH') or (ie_complexidade_assit3_w = 'JH') or (ie_complexidade_assit4_w = 'JH') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_frat
				where	nr_atendimento	= nr_atendimento_p
				and	ie_situacao	= 'A'
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(343493);
				end if;
				
			end if;
			
			if (ie_complexidade_assit_w = 'CI')  or (ie_complexidade_assit2_w = 'CI') or (ie_complexidade_assit3_w = 'CI') or (ie_complexidade_assit4_w = 'CI') then	
				select	count(*)	
				into STRICT	qt_reg_w	
				from	ESCALA_CAM_ICU	
				where	nr_atendimento	= nr_atendimento_p	
				and	ie_situacao	= 'A'	
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');	
				if (qt_reg_w = 0) then	
					CALL wheb_mensagem_pck.exibir_mensagem_abort(343494);	
				end if;	
			end if;
	
			if (ie_complexidade_assit_w = 'NE')  or (ie_complexidade_assit2_w = 'NE') or (ie_complexidade_assit3_w = 'NE') or (ie_complexidade_assit4_w = 'NE') then
				
				select	count(*)
				into STRICT	qt_reg_w
				from	ESCALA_NEWS
				where	nr_atendimento	= nr_atendimento_p
				and	coalesce(dt_inativacao::text, '') = ''
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(1113197);
				end if;
			end if;
			
			if (ie_complexidade_assit_w = 'DV')  or (ie_complexidade_assit2_w = 'DV') or (ie_complexidade_assit3_w = 'DV') or (ie_complexidade_assit4_w = 'DV') then
				select	count(*)
				into STRICT	qt_reg_w
				from	ESCALA_IDV
				where	nr_atendimento	= nr_atendimento_p
				and	ie_situacao	= 'A'
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(330431);
				end if;
			end if;	

			if (ie_complexidade_assit_w = 'PW')  or (ie_complexidade_assit2_w = 'PW') or (ie_complexidade_assit3_w = 'PW') or (ie_complexidade_assit4_w = 'PW') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_pews
				where	nr_atendimento	= nr_atendimento_p
				and	ie_situacao	= 'A'
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(330604);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'PW')  or (ie_complexidade_assit2_w = 'PW') or (ie_complexidade_assit3_w = 'PW') or (ie_complexidade_assit4_w = 'PW') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_pews
				where	nr_atendimento	= nr_atendimento_p
				and	ie_situacao	= 'A'
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(330604);
				end if;
			end if;
		end;	
		elsif (ie_informacao_w	= 'KZ') then
		begin
			if (ie_complexidade_assit_w = 'KZ') or (ie_complexidade_assit2_w = 'KZ') or (ie_complexidade_assit3_w = 'KZ') or (ie_complexidade_assit4_w = 'KZ') then
				select	count(*)
				into STRICT	qt_reg_w
				from	ESCALA_KATZ
				where	nr_atendimento	= nr_atendimento_p
				and		coalesce(ie_situacao,'A')	<> 'I'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(315636);
				end if;
			end if;
			
		end;	
		elsif (ie_informacao_w = 'GCAD') then
		begin
			if (ie_complexidade_assit_w = 'E') or (ie_complexidade_assit2_w = 'E') or (ie_complexidade_assit3_w = 'E') or (ie_complexidade_assit4_w = 'E') then
				select	count(*)
				into STRICT	qt_reg_w
				from	gca_atendimento
				where	nr_atendimento = nr_atendimento_p
				and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_avaliacao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())
				and		ie_situacao = 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(176561);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'DT') or (ie_complexidade_assit2_w = 'DT') or (ie_complexidade_assit3_w = 'DT') or (ie_complexidade_assit4_w = 'DT') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_downton
				where	nr_atendimento = nr_atendimento_p
				and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_avaliacao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())
				and		coalesce(ie_situacao,'A') <> 'I'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(176562);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'D') or (ie_complexidade_assit2_w = 'D') or (ie_complexidade_assit3_w = 'D') or (ie_complexidade_assit4_w = 'D') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_dini
				where	nr_atendimento = nr_atendimento_p
				and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_avaliacao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())
				and		ie_situacao = 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(176563);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'M') or (ie_complexidade_assit2_w = 'M') or (ie_complexidade_assit3_w = 'M') or (ie_complexidade_assit4_w = 'M') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_mews
				where	nr_atendimento = nr_atendimento_p
				and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_avaliacao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())
				and		ie_situacao = 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(176564);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'MT') or (ie_complexidade_assit2_w = 'MT') or (ie_complexidade_assit3_w = 'MT') or (ie_complexidade_assit4_w = 'MT') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_must
				where	nr_atendimento = nr_atendimento_p
				and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_avaliacao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())
				and		ie_situacao = 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(176565);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'N') or (ie_complexidade_assit2_w = 'N') or (ie_complexidade_assit3_w = 'N') or (ie_complexidade_assit4_w = 'N') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_nas
				where	nr_atendimento = nr_atendimento_p
				and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_avaliacao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())
				and		ie_situacao = 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(176566);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'NT') or (ie_complexidade_assit2_w = 'NT') or (ie_complexidade_assit3_w = 'NT') or (ie_complexidade_assit4_w = 'NT') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_ntiss
				where	nr_atendimento = nr_atendimento_p
				and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_avaliacao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())
				and		ie_situacao = 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(176567);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'MO') or (ie_complexidade_assit2_w = 'MO') or (ie_complexidade_assit3_w = 'MO') or (ie_complexidade_assit4_w = 'MO') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_morse
				where	nr_atendimento = nr_atendimento_p
				and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_avaliacao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())
				and		ie_situacao = 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(176576);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'SF') or (ie_complexidade_assit2_w = 'SF') or (ie_complexidade_assit3_w = 'SF') or (ie_complexidade_assit4_w = 'SF') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_eif
				where	nr_atendimento = nr_atendimento_p
				and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_avaliacao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())
				and		ie_situacao = 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(176577);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'T') or (ie_complexidade_assit2_w = 'T') or (ie_complexidade_assit3_w = 'T') or (ie_complexidade_assit4_w = 'T') then
				select	count(*)
				into STRICT	qt_reg_w
				from	tiss_interv_terapeutica
				where	nr_atendimento = nr_atendimento_p
				and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_avaliacao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())
				and		ie_situacao = 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(176568);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'B') or (ie_complexidade_assit2_w = 'B') or (ie_complexidade_assit3_w = 'B') or (ie_complexidade_assit4_w = 'B') then
				select	count(*)
				into STRICT	qt_reg_w
				from	atend_escala_braden
				where	nr_atendimento = nr_atendimento_p
				and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_avaliacao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())
				and		ie_situacao = 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(185550);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'BQ') or (ie_complexidade_assit2_w = 'BQ') or (ie_complexidade_assit3_w = 'BQ') or (ie_complexidade_assit4_w = 'BQ') then
				select	count(*)
				into STRICT	qt_reg_w
				from	atend_escala_braden_q
				where	nr_atendimento = nr_atendimento_p
				and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_avaliacao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())
				and		ie_situacao = 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(185551);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'ES') or (ie_complexidade_assit2_w = 'ES') or (ie_complexidade_assit3_w = 'ES') or (ie_complexidade_assit4_w = 'ES') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_stratify
				where	nr_atendimento = nr_atendimento_p
				and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_avaliacao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())
				and		ie_situacao = 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(190384);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'RT') or (ie_complexidade_assit2_w = 'RT') or (ie_complexidade_assit3_w = 'RT') or (ie_complexidade_assit4_w = 'RT') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_tev
				where	nr_atendimento = nr_atendimento_p
				and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_avaliacao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())
				and		ie_situacao = 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(216306);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'P') or (ie_complexidade_assit2_w = 'P') or (ie_complexidade_assit3_w = 'P') or (ie_complexidade_assit4_w = 'P') then
				select	count(*)
				into STRICT	qt_reg_w
				from	ESCALA_PRISM
				where	nr_atendimento = nr_atendimento_p
				and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_avaliacao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())
				and		ie_situacao = 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(211549);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'SO') or (ie_complexidade_assit2_w = 'SO') or (ie_complexidade_assit3_w = 'SO') or (ie_complexidade_assit4_w = 'SO') then
				select	count(*)
				into STRICT	qt_reg_w
				from	ESCALA_SOFA
				where	nr_atendimento = nr_atendimento_p
				and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_avaliacao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())
				and		ie_situacao = 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(211550);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'S') or (ie_complexidade_assit2_w = 'S') or (ie_complexidade_assit3_w = 'S') or (ie_complexidade_assit4_w = 'S') then
				select	count(*)
				into STRICT	qt_reg_w
				from	ESCALA_SAPS3
				where	nr_atendimento = nr_atendimento_p
				and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_avaliacao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())
				and		ie_situacao = 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(211551);
				end if;
			end if;
			
			if (ie_complexidade_assit_w = 'JH')  or (ie_complexidade_assit2_w = 'JH') or (ie_complexidade_assit3_w = 'JH') or (ie_complexidade_assit4_w = 'JH') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_frat
				where	nr_atendimento	= nr_atendimento_p
				and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_avaliacao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())					
				and	ie_situacao	= 'A'
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(343493);
				end if;
			end if;
			
			if (ie_complexidade_assit_w = 'CI')  or (ie_complexidade_assit2_w = 'CI') or (ie_complexidade_assit3_w = 'CI') or (ie_complexidade_assit4_w = 'CI') then
				select	count(*)
				into STRICT	qt_reg_w
				from	ESCALA_CAM_ICU
				where	nr_atendimento	= nr_atendimento_p
				and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_avaliacao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())					
				and	ie_situacao	= 'A'
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(343494);
				end if;
			end if;
			
			if (ie_complexidade_assit_w = 'DV')  or (ie_complexidade_assit2_w = 'DV') or (ie_complexidade_assit3_w = 'DV') or (ie_complexidade_assit4_w = 'DV') then
				select	count(*)
				into STRICT	qt_reg_w
				from	ESCALA_IDV
				where	nr_atendimento	= nr_atendimento_p
				and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_avaliacao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())				
				and	ie_situacao	= 'A'
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(330431);
				end if;
			end if;	

			if (ie_complexidade_assit_w = 'PW')  or (ie_complexidade_assit2_w = 'PW') or (ie_complexidade_assit3_w = 'PW') or (ie_complexidade_assit4_w = 'PW') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_pews
				where	nr_atendimento	= nr_atendimento_p
				and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_avaliacao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())				
				and	ie_situacao	= 'A'
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(330604);
				end if;
			end if;

			if (ie_complexidade_assit_w = 'NE')  or (ie_complexidade_assit2_w = 'NE') or (ie_complexidade_assit3_w = 'NE') or (ie_complexidade_assit4_w = 'NE') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_news
				where	nr_atendimento	= nr_atendimento_p
				and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_avaliacao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())				
				and	coalesce(dt_inativacao::text, '') = ''
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(1113197);
				end if;
			end if;				
		end;	
		elsif (ie_informacao_w	= 'KZ') then
		begin
			if (ie_complexidade_assit_w = 'KZ') or (ie_complexidade_assit2_w = 'KZ') or (ie_complexidade_assit3_w = 'KZ') or (ie_complexidade_assit4_w = 'KZ') then
				select	count(*)
				into STRICT	qt_reg_w
				from	ESCALA_KATZ
				where	nr_atendimento	= nr_atendimento_p
				and		coalesce(ie_situacao,'A')	<> 'I'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(315636);
				end if;
			end if;
		end;				
		elsif (ie_informacao_w = 'TMPL') then
		begin
			select	count(*)
			into STRICT    qt_reg_w
			from	ehr_registro a,
					ehr_reg_template b
			where	nr_atendimento = nr_atendimento_p
			and	b.nr_seq_reg = a.nr_sequencia
			and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_registro) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())
			and	coalesce(a.dt_inativacao::text, '') = ''
			and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			and   b.nr_seq_template = nr_seq_template_w;

			ds_template_w   := substr(EHR_Obter_Template(nr_seq_template_w),1,100);

			if (qt_reg_w = 0) then
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(218176,'DS_TEMPLATE_W=' || ds_template_w);
			end if;
		end;	
		elsif (ie_informacao_w = 'ETEMPL') then
		begin
			select	count(*)
			into STRICT    qt_reg_w
			from	ehr_registro a,
					ehr_reg_template b
			where	nr_atendimento = nr_atendimento_p
			and		b.nr_seq_reg = a.nr_sequencia
			and		coalesce(a.dt_inativacao::text, '') = ''
			and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			and     exists (	SELECT	1
							from	regra_cons_inf_sae_temp r
							where	b.nr_seq_template = r.nr_seq_template
							and		r.nr_seq_regra = nr_seq_regra_w);
							
			open C03;
			loop
			fetch C03 into
				nr_seq_template_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
				if (coalesce(ds_template_w::text, '') = '')then
					ds_template_w := substr(EHR_Obter_Template(nr_seq_template_w),1,100);
				else
					ds_template_w := ds_template_w||' ,'||chr(10)||substr(EHR_Obter_Template(nr_seq_template_w),1,100);
				end if;
			end;
			end loop;
			close C03;

			if (qt_reg_w = 0) then
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(225397,'DS_TEMPLATE_W=' || ds_template_w);
			end if;
		end;	
		elsif (ie_informacao_w	= 'NAS') then
		begin
			if (ie_complexidade_assit_w	= 'N') or (ie_complexidade_assit2_w	= 'N') or (ie_complexidade_assit3_w 	= 'N') or (ie_complexidade_assit4_w 	= 'N') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_nas
				where	nr_atendimento	= nr_atendimento_p
				and		ie_situacao	= 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(176566);
				end if;
			end if;
		end;
		elsif (ie_informacao_w	= 'FUG') then
		begin
			if (ie_complexidade_assit_w = 'E')  or (ie_complexidade_assit2_w = 'E') or (ie_complexidade_assit3_w = 'E') or (ie_complexidade_assit4_w = 'E') then
				select	count(*)
				into STRICT	qt_reg_w
				from	gca_atendimento
				where	nr_atendimento	= nr_atendimento_p
				and		ie_situacao	= 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(176561);
				end if;
			end if;
		end;	
		elsif (ie_informacao_w	= 'BRA') then
		begin
			if (ie_complexidade_assit_w = 'B') or (ie_complexidade_assit2_w = 'B') or (ie_complexidade_assit3_w = 'B') or (ie_complexidade_assit4_w = 'B') then
				select	count(*)
				into STRICT	qt_reg_w
				from	atend_escala_braden
				where	nr_atendimento = nr_atendimento_p
				and		ie_situacao = 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(185550);
				end if;
			end if;
		end;
		elsif (ie_informacao_w	= 'DOW') then
		begin
			if (ie_complexidade_assit_w = 'DT') or (ie_complexidade_assit2_w = 'DT') or (ie_complexidade_assit3_w = 'DT') or (ie_complexidade_assit4_w = 'DT') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_downton
				where	nr_atendimento	= nr_atendimento_p
				and		coalesce(ie_situacao,'A')	<> 'I'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(176562);
				end if;
			end if;
		end;	
		elsif (ie_informacao_w	= 'CAM') then
		begin
			if (ie_complexidade_assit_w = 'CI') or (ie_complexidade_assit2_w = 'CI') or (ie_complexidade_assit3_w = 'CI') or (ie_complexidade_assit4_w = 'CI') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_cam_icu
				where	nr_atendimento	= nr_atendimento_p
				and		coalesce(ie_situacao,'A')	<> 'I'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(296855);
				end if;
				
			end if;
		end;	
		elsif (ie_informacao_w	= 'KZ') then
		begin
			if (ie_complexidade_assit_w = 'KZ') or (ie_complexidade_assit2_w = 'KZ') or (ie_complexidade_assit3_w = 'KZ') or (ie_complexidade_assit4_w = 'KZ') then
				select	count(*)
				into STRICT	qt_reg_w
				from	ESCALA_KATZ
				where	nr_atendimento	= nr_atendimento_p
				and		coalesce(ie_situacao,'A')	<> 'I'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(315636);
				end if;
			end if;
		end;	
		elsif (ie_informacao_w	= 'NTISS') then
		begin
			if (ie_complexidade_assit_w = 'NT') or (ie_complexidade_assit2_w = 'NT') or (ie_complexidade_assit3_w = 'NT') or (ie_complexidade_assit4_w = 'NT') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_ntiss
				where	nr_atendimento	= nr_atendimento_p
				and		ie_situacao	= 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(176567);
				end if;
			end if;
		end;
		elsif (ie_informacao_w	= 'MNAL') then
		begin
			if (ie_complexidade_assit_w = 'MNAL') or (ie_complexidade_assit2_w = 'MNAL') or (ie_complexidade_assit3_w = 'MNAL') or (ie_complexidade_assit4_w = 'MNAL') then
				select	count(*)
				into STRICT	qt_reg_w
				from	escala_man
				where	nr_atendimento	= nr_atendimento_p
				and		ie_situacao	= 'A'
				and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

				if (qt_reg_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(355946);
				end if;
			end if;
		end;	
		end if;
		end;
	end loop;
	close C02;
	end;
end loop;
close C01;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_regra_sae ( nr_atendimento_p bigint, cd_setor_atendimento_p bigint) FROM PUBLIC;

