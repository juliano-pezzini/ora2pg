-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_componentes_agente ( nr_seq_agente_cir_p bigint, cd_list_mat_p text, nm_usuario_p text, nr_seq_agente_p text) AS $body$
DECLARE


cd_material_w				integer;
cd_mat_list_ww				varchar(255);
item_w						varchar(255);
cd_unidade_medida_w			agente_anest_componente.cd_unidade_medida%type;
qt_dose_w					agente_anest_componente.qt_dose%type;



BEGIN

cd_mat_list_ww := cd_list_mat_p;

while(cd_mat_list_ww IS NOT NULL AND cd_mat_list_ww::text <> '') loop
    if (position(',' in cd_mat_list_ww) = 0) and (cd_mat_list_ww IS NOT NULL AND cd_mat_list_ww::text <> '') then
      cd_mat_list_ww  := cd_mat_list_ww||',';
    end if;
    item_w := substr(cd_mat_list_ww, 1, position(',' in cd_mat_list_ww) - 1);
    cd_mat_list_ww := substr(cd_mat_list_ww, position(',' in cd_mat_list_ww) + 1, length(cd_mat_list_ww));
	
	select	max(a.cd_unidade_medida),
			max(a.qt_dose)
	into STRICT	cd_unidade_medida_w,
			qt_dose_w
	from    agente_anest_componente a,
            agente_anest_material b
	where   b.nr_sequencia = a.nr_seq_agente
        and a.cd_componente = (item_w)::numeric 
        and b.nr_seq_agente = (nr_seq_agente_p)::numeric;
	
	insert into agente_anest_diluicao(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					cd_material,
					cd_unidade_medida,
					ie_origem_inf,
					qt_rediluir,
					qt_dose,
					nr_seq_agente_cir)
				values (
					nextval('agente_anest_diluicao_seq'),
					clock_timestamp(),
					nm_usuario_p,
					item_w,
					cd_unidade_medida_w,
					1,
					null,
					qt_dose_w,
					nr_seq_agente_cir_p );

			
	commit;

end loop;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_componentes_agente ( nr_seq_agente_cir_p bigint, cd_list_mat_p text, nm_usuario_p text, nr_seq_agente_p text) FROM PUBLIC;

