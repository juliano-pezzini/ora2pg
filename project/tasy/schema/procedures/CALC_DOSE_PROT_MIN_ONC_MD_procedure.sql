-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calc_dose_prot_min_onc_md (qt_dose_ww_p bigint, qt_conversao_dose_p bigint, qt_dose_min_p bigint, qt_conversao_dose_limite_p bigint, ie_dose_limite_p text, nr_ocorrencia_p bigint, qt_peso_p bigint, qt_sc_p bigint, nr_ciclos_p bigint, dose_prot_pessoa_dia_p bigint, ie_justificativa_p text, ds_justificativa_p text, qt_dose_p INOUT bigint, qt_dose_limite_p INOUT bigint, ds_erro2_p INOUT text ) AS $body$
BEGIN
    qt_dose_p		     := dividir_sem_round_md(trunc(dividir_sem_round_md(qt_dose_ww_p * 1000,qt_conversao_dose_p)),1000);
    qt_dose_limite_p := dividir_sem_round_md(trunc(dividir_sem_round_md(qt_dose_min_p * 1000,qt_conversao_dose_limite_p)),1000);

    if (ie_dose_limite_p = 'DIA') then
      qt_dose_p	:= qt_dose_p * coalesce(nr_ocorrencia_p,1);

    elsif (qt_peso_p > 0) and (ie_dose_limite_p = 'KG') then
      qt_dose_p	:= dividir_sem_round_md(qt_dose_p,coalesce(qt_peso_p,1));

    elsif (ie_dose_limite_p = 'AT') then
      qt_dose_p	:= qt_dose_p * coalesce(nr_ocorrencia_p,1);

    elsif (qt_sc_p > 0) and (ie_dose_limite_p = 'SC') then

      qt_dose_p	:= dividir_sem_round_md(qt_dose_p,coalesce(qt_sc_p,1));	

      qt_dose_p	:= qt_dose_p * coalesce(nr_ocorrencia_p,1);
    elsif (qt_peso_p > 0) and (ie_dose_limite_p = 'CI') then
      qt_dose_p	:= dividir_sem_round_md(qt_dose_p,coalesce(nr_ciclos_p,1));	

      qt_dose_p	:= qt_dose_p * coalesce(nr_ocorrencia_p,1);
    elsif (ie_dose_limite_p = 'PF') then
      qt_dose_p	:= qt_dose_p * coalesce(nr_ocorrencia_p,1);
      qt_dose_p	:= coalesce(qt_dose_p,0) + coalesce(dose_prot_pessoa_dia_p,0);

    elsif (qt_peso_p > 0) and (ie_dose_limite_p = 'KG/DIA') then
      qt_dose_p	:= dividir_sem_round_md(qt_dose_p,coalesce(qt_peso_p,1));					

      qt_dose_p	:= qt_dose_p * coalesce(nr_ocorrencia_p,1);
    end if;		

    if (qt_dose_limite_p > 0) and (qt_dose_limite_p > coalesce(qt_dose_p,0)) and
      ((ie_justificativa_p = 'S') or (coalesce(ds_justificativa_p::text, '') = '')) then
      ds_erro2_p	:= ' ';
    end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calc_dose_prot_min_onc_md (qt_dose_ww_p bigint, qt_conversao_dose_p bigint, qt_dose_min_p bigint, qt_conversao_dose_limite_p bigint, ie_dose_limite_p text, nr_ocorrencia_p bigint, qt_peso_p bigint, qt_sc_p bigint, nr_ciclos_p bigint, dose_prot_pessoa_dia_p bigint, ie_justificativa_p text, ds_justificativa_p text, qt_dose_p INOUT bigint, qt_dose_limite_p INOUT bigint, ds_erro2_p INOUT text ) FROM PUBLIC;

