-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pcs_enviar_email_parecer ( nr_seq_reclassif_item_p bigint, cd_material_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_mensagem_w			varchar(4000);
ds_assunto_w			varchar(255);
nm_usuario_origem_w		varchar(255);
ds_email_origem_w		varchar(255);
ds_email_w				varchar(255);
ds_email_remetente_w	varchar(255);
ds_parecer_w			varchar(4000);
cd_pessoa_dest_w		varchar(10);
cd_pessoa_grupo_w		varchar(10);
nr_seq_parecer_w		bigint;
cd_material_w			bigint;
ds_material_w			varchar(255);
ds_tipo_parecer_w		varchar(255);
ds_destinatarios_w		varchar(255);
nr_seq_grupo_w			bigint;
ie_comunic_interna_w	varchar(1);
ie_email_w				varchar(1);
nr_seq_comunic_w		bigint;
nm_usuario_dest_w		varchar(255);
qt_selecionados_w		integer;
nm_destinatarios_w		varchar(4000);

C01 CURSOR FOR
	SELECT  b.cd_pessoa_dest,
			b.nr_seq_grupo_dest
	from	pcs_reclassif_curva_item a,
			pcs_parecer b
	where	a.nr_sequencia = b.nr_seq_reclassif
	and		a.nr_sequencia = nr_seq_reclassif_item_p
	and 	(b.cd_pessoa_dest IS NOT NULL AND b.cd_pessoa_dest::text <> '')
	and		coalesce(b.dt_envio::text, '') = ''
	and		b.ie_selecionado = 'S'
	and	b.cd_material = cd_material_p
	and		((ie_comunic_interna = 'S') or (ie_email = 'S'))
	group by b.cd_pessoa_dest,nr_seq_grupo_dest;

C02 CURSOR FOR
	SELECT  b.ds_parecer,
			a.cd_material,
			substr(obter_desc_material(a.cd_material),1,255),
			b.nr_sequencia,
			substr(obter_descricao_padrao('PCS_TIPO_PARECER','DS_TIPO_PARECER',NR_SEQ_TIPO_PARECER),1,255),
			ie_comunic_interna,
			ie_email
	from	pcs_reclassif_curva_item a,
			pcs_parecer b
	where	a.nr_sequencia = b.nr_seq_reclassif
	and		a.nr_sequencia = nr_seq_reclassif_item_p
	and		b.cd_pessoa_dest = cd_pessoa_dest_w
	and		b.ie_selecionado = 'S'
	and	b.cd_material = cd_material_p
	and		((ie_comunic_interna = 'S') or (ie_email = 'S'))
	and		coalesce(b.dt_envio::text, '') = ''
	order by b.nr_sequencia;

C03 CURSOR FOR
	SELECT	cd_pessoa_grupo
	from  	pcs_pessoas_grupo_dest
	where 	nr_seq_grupo = nr_seq_grupo_w
	and		cd_pessoa_grupo <> cd_pessoa_dest_w
	and		(cd_pessoa_grupo IS NOT NULL AND cd_pessoa_grupo::text <> '')
	group by cd_pessoa_grupo;


BEGIN

select	count(*)
into STRICT	qt_selecionados_w
from	pcs_reclassif_curva_item a,
		pcs_parecer b
where	a.nr_sequencia = b.nr_seq_reclassif
and		a.nr_sequencia = nr_seq_reclassif_item_p
and 	(b.cd_pessoa_dest IS NOT NULL AND b.cd_pessoa_dest::text <> '')
and		b.ie_selecionado = 'S'
and		((ie_comunic_interna = 'S') or (ie_email = 'S'))
and		coalesce(b.dt_envio::text, '') = '';

if (qt_selecionados_w = 0) then
	--É obrigatório marcar pelo menos um parecer e setar o registro para enviar comunicação interna ou e-mail!
	CALL wheb_mensagem_pck.exibir_mensagem_abort(295919);
end if;

select	max(ds_email)
into STRICT	ds_email_remetente_w
from	usuario
where	nm_usuario = nm_usuario_p;

open C01;
loop
fetch C01 into
	cd_pessoa_dest_w,
	nr_seq_grupo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin


	select	max(ds_email) || ';',
			max(nm_usuario) || ','
	into STRICT	ds_destinatarios_w,
			nm_usuario_dest_w
	from	usuario
	where	cd_pessoa_fisica = cd_pessoa_dest_w;

	if (nm_usuario_dest_w <> '') then
		nm_destinatarios_w := nm_usuario_dest_w;
	end if;

	ds_mensagem_w := null;
	ds_assunto_w := null;

	open C03;
	loop
	fetch C03 into
		cd_pessoa_grupo_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin

		select	max(ds_email),
				max(nm_usuario)
		into STRICT	ds_email_w,
				nm_usuario_dest_w
		from	usuario
		where	cd_pessoa_fisica = cd_pessoa_grupo_w;

		ds_destinatarios_w := ds_destinatarios_w || ds_email_w || ';';
		nm_destinatarios_w := nm_destinatarios_w || nm_usuario_dest_w || ';';

		--enviar_email(ds_assunto_w,ds_mensagem_w,ds_email_remetente_w,ds_email_w,'Maicon','M');
		end;
	end loop;
	close C03;

	open C02;
	loop
	fetch C02 into
		ds_parecer_w,
		cd_material_w,
		ds_material_w,
		nr_seq_parecer_w,
		ds_tipo_parecer_w,
		ie_comunic_interna_w,
		ie_email_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		ds_assunto_w := substr(wheb_mensagem_pck.get_Texto(295600) || ' ' || cd_material_w || ' - ' || ds_material_w,1,255);
		ds_mensagem_w := ds_mensagem_w || chr(13) || chr(10) || nr_seq_parecer_w || ' - ' || ds_tipo_parecer_w;
		ds_mensagem_w := substr(ds_mensagem_w || chr(13) || chr(10) || ds_parecer_w || chr(13) || chr(10),1,4000);
		ds_email_w := null;

		update	pcs_parecer
		set 	dt_envio = clock_timestamp(),
				nm_usuario_envio =  nm_usuario_p
		where	nr_sequencia = nr_seq_parecer_w;

		end;
	end loop;
	close C02;
		-- Parecer do item :
	if (coalesce(ie_email_w,'N') = 'S') then
		CALL enviar_email(ds_assunto_w,ds_mensagem_w,ds_email_remetente_w,ds_destinatarios_w,nm_usuario_p,'M'); --coloquei o usuario maicon só pra testar, por causa do SMTP
		--enviar_email(ds_assunto_w,ds_mensagem_w,ds_email_remetente_w,'maurici@wheb.com.br','Maicon','M'); --coloquei o usuario maicon só pra testar, por causa do SMTP
	end if;

	if (coalesce(ie_comunic_interna_w,'N') = 'S') then

			select	nextval('comunic_interna_seq')
			into STRICT	nr_seq_comunic_w
			;

			insert	into comunic_interna(
						dt_comunicado,
						ds_titulo,
						ds_comunicado,
						nm_usuario,
						dt_atualizacao,
						ie_geral,
						nm_usuario_destino,
						nr_sequencia,
						ie_gerencial,
						dt_liberacao)
				values (	clock_timestamp(),
						ds_assunto_w,
						ds_mensagem_w,
						nm_usuario_p,
						clock_timestamp(),
						'N',
						nm_destinatarios_w,
						nr_seq_comunic_w,
						'N',
						clock_timestamp());
	end if;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pcs_enviar_email_parecer ( nr_seq_reclassif_item_p bigint, cd_material_p bigint, nm_usuario_p text) FROM PUBLIC;

