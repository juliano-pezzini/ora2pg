-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_calcular_reaj_quota_parc (nr_seq_lote_p pls_lote_reaj_quota.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


pr_ajuste_w			cotacao_moeda.vl_cotacao%type;
dt_referencia_w			pls_lote_reaj_quota.dt_referencia%type;
vl_parcela_atual_w		pls_reaj_quota_parc.vl_parcela_atual%type;
cd_moeda_reaj_w			pls_lote_reaj_quota.cd_moeda_reaj%type;

C01 CURSOR(	nr_seq_lote_cp	pls_reaj_quota_parc.nr_sequencia%type) FOR
SELECT	a.vl_parcela_anterior,
	a.nr_sequencia
from	pls_reaj_quota_parc a
where	a.nr_seq_lote		= nr_seq_lote_cp;

BEGIN

select	dt_referencia,
	cd_moeda_reaj
into STRICT	dt_referencia_w,
	cd_moeda_reaj_w
from	pls_lote_reaj_quota
where	nr_sequencia	= nr_seq_lote_p;

pr_ajuste_w	:= obter_valor_cotacao_moeda_data(cd_moeda_reaj_w, dt_referencia_w);

for r_c01_w in c01(nr_seq_lote_p) loop

	vl_parcela_atual_w	:= r_c01_w.vl_parcela_anterior + (r_c01_w.vl_parcela_anterior * pr_ajuste_w);

	update	pls_reaj_quota_parc
	set	vl_parcela_atual		= vl_parcela_atual_w,
		vl_parcela_reajuste		= (r_c01_w.vl_parcela_anterior * pr_ajuste_w)
	where	nr_sequencia		= r_c01_w.nr_sequencia;

end loop;

update pls_lote_reaj_quota
set    dt_calculo_reajuste 	= clock_timestamp()
where  nr_sequencia    		= nr_seq_lote_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_calcular_reaj_quota_parc (nr_seq_lote_p pls_lote_reaj_quota.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

