-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE com_inserir_anexo_os_js ( nr_seq_solic_p bigint, nr_seq_ordem_p bigint, ds_arquivo_p text, nm_usuario_p text, ds_arquivo_ret_p INOUT text) AS $body$
DECLARE


ds_diretorio_anexo_os_w	varchar(255);
ds_arquivo_w			varchar(400);
qt_anexo_w				bigint;
ds_historico_w			man_ordem_serv_tecnico.ds_relat_tecnico%type;

nr_seq_localizacao_w	man_localizacao.nr_sequencia%type;
cd_cnpj_w				man_localizacao.cd_cnpj%type;
nr_seq_idioma_w			pessoa_juridica.nr_seq_idioma%type;


BEGIN

/*
APENAS NOS CASOS ONDE SERÁ VINCULADO O OS A SOLICITAÇÃO QUE SERÁ CHAMADA A PROCEDURE COM_ATUALIZAR_STATUS_SD  E SERÁ FEITO O INSERT NO HISTÓRICO DA OS
*/
ds_diretorio_anexo_os_w := Obter_param_Usuario(297, 34, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ds_diretorio_anexo_os_w);

if (coalesce(nr_seq_ordem_p,0) > 0) and (ds_arquivo_p IS NOT NULL AND ds_arquivo_p::text <> '') then

	select 	count(*) + 1
	into STRICT	qt_anexo_w
	from   	man_ordem_serv_arq
	where  	nr_seq_ordem = nr_seq_ordem_p;

	ds_arquivo_w := substr(ds_diretorio_anexo_os_w||ds_arquivo_p || '_' || qt_anexo_w || '.pdf',1,400);

	insert into man_ordem_serv_sd(nr_sequencia,
					nr_seq_ordem_serv,
					nr_seq_solic_sd)
		values (nextval('man_ordem_serv_sd_seq'),
			nr_seq_ordem_p,
			nr_seq_solic_p);

	insert into man_ordem_serv_arq(
                                	nr_sequencia,
	                                nr_seq_ordem,
					dt_atualizacao,
                                	nm_usuario,
	                                ds_arquivo,
	                                ie_status_anexo,
	                                ie_anexar_email)
		values (
                	                nextval('man_ordem_serv_arq_seq'),
                                	nr_seq_ordem_p,
	                                clock_timestamp(),
	                                nm_usuario_p,
	                                ds_arquivo_w,
	                                'P',
	                                'N');

	if	((qt_anexo_w > 1) and (coalesce(nr_seq_solic_p,0) > 0)) then

		CALL com_atualizar_status_sd(nm_usuario_p, nr_seq_ordem_p, nr_seq_solic_p, 'S');

		ds_historico_w := substr(obter_texto_dic_objeto(325932, wheb_usuario_pck.get_nr_seq_idioma, 'DS_SOLICITACAO='||nr_seq_solic_p),1,255);

		select	nr_seq_localizacao
		into STRICT	nr_seq_localizacao_w
		from	man_ordem_servico
		where	nr_sequencia = nr_seq_ordem_p;

		if (nr_seq_localizacao_w IS NOT NULL AND nr_seq_localizacao_w::text <> '') then
			select	max(a.cd_cnpj)
			into STRICT	cd_cnpj_w
			from	man_localizacao	a
			where	a.nr_sequencia	= nr_seq_localizacao_w;

			if (cd_cnpj_w IS NOT NULL AND cd_cnpj_w::text <> '') then
				select	max(a.nr_seq_idioma)
				into STRICT	nr_seq_idioma_w
				from	pessoa_juridica	a
				where	a.cd_cgc	= cd_cnpj_w;

				if (nr_seq_idioma_w IS NOT NULL AND nr_seq_idioma_w::text <> '') then
					-- Retorna com o idioma do cliente que abriu a OS.
					ds_historico_w := substr(obter_texto_dic_objeto(325932, nr_seq_idioma_w, 'DS_SOLICITACAO='||nr_seq_solic_p),1,255);

				end if;
			end if;
		end if;

		insert into man_ordem_serv_tecnico(
							nr_sequencia,
							nr_seq_ordem_serv,
							dt_atualizacao,
							nm_usuario,
							ds_relat_tecnico,
							cd_versao_tasy,
							dt_historico,
							ie_origem,
							nr_seq_tipo,
							nm_usuario_lib,
							dt_liberacao,
							ie_grau_satisfacao)
		values (
			nextval('man_ordem_serv_tecnico_seq'),
			nr_seq_ordem_p,
			clock_timestamp(),
			nm_usuario_p,
			ds_historico_w,
			null,
			clock_timestamp(),
			'I',
			1,
			nm_usuario_p,
			clock_timestamp(),
			null);
	end if;

	commit;

	ds_arquivo_ret_p := ds_arquivo_w;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE com_inserir_anexo_os_js ( nr_seq_solic_p bigint, nr_seq_ordem_p bigint, ds_arquivo_p text, nm_usuario_p text, ds_arquivo_ret_p INOUT text) FROM PUBLIC;

