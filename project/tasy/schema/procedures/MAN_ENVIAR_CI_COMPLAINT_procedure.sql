-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_enviar_ci_complaint ( nr_seq_ordem_serv_p bigint, nr_seq_localizacao_p bigint, cd_funcao_p bigint) AS $body$
DECLARE


ds_titulo_w		man_aviso_receb_complaint.ds_titulo%type;
ds_aviso_w		man_aviso_receb_complaint.ds_aviso%type;
nr_seq_aviso_w	bigint;
nr_seq_pais_w	bigint;
qt_dest_w	bigint;
nm_usuarios_dest_w	varchar(4000) := '';
ds_perfis_dest_w	varchar(4000) := '';
ie_terceiro_w		varchar(1);

c01 CURSOR FOR
SELECT	a.nr_sequencia,
		a.ds_titulo,
		a.ds_aviso
from	man_aviso_receb_complaint a,
		man_complaint_func b,
		man_complaint_pais c
where	a.nr_sequencia = b.nr_seq_complaint
and		a.nr_sequencia = c.nr_seq_complaint
and 	b.cd_funcao = cd_funcao_p
and		c.nr_seq_pais = nr_seq_pais_w
and		a.ie_situacao = 'A'
and		b.ie_situacao = 'A'
and		c.ie_situacao = 'A';


BEGIN

	select	max(b.nr_seq_pais),
			max(ie_terceiro)
	into STRICT	nr_seq_pais_w,
			ie_terceiro_w
	from	man_localizacao a,
			pessoa_juridica b
	where	a.nr_sequencia = nr_seq_localizacao_p
	and		a.cd_cnpj = b.cd_cgc;

	if (cd_funcao_p IS NOT NULL AND cd_funcao_p::text <> '') and (nr_seq_pais_w IS NOT NULL AND nr_seq_pais_w::text <> '') and (ie_terceiro_w = 'S') then
		open c01;
		loop
		fetch c01 into
			nr_seq_aviso_w,
			ds_titulo_w,
			ds_aviso_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
			select	count(*)
			into STRICT	qt_dest_w
			from	man_complaint_dest
			where	nr_seq_complaint = nr_seq_aviso_w
			and	(nm_usuario_dest IS NOT NULL AND nm_usuario_dest::text <> '')
			and	ie_situacao = 'A';WITH RECURSIVE cte AS (


			if (qt_dest_w > 0) then
				select	substr(ltrim(nm_usuario_dest, ', '), 1, 4000)
				into STRICT	nm_usuarios_dest_w
				from (	SELECT	nm_usuario_dest,
							row_number() over (order by nm_usuario_dest) nr_linha
						from	man_complaint_dest
						where	nr_seq_complaint = nr_seq_aviso_w
						and	(nm_usuario_dest IS NOT NULL AND nm_usuario_dest::text <> '')
						and	ie_situacao = 'A'
				) alias7 WHERE nr_linha = 1
  UNION ALL


			if (qt_dest_w > 0) then
				select	c.nm_usuarios_dest_w || ', ' || substr(ltrim(nm_usuario_dest, ', '), 1, 4000)
				into STRICT	nm_usuarios_dest_w
				from (	SELECT	nm_usuario_dest,
							row_number() over (order by nm_usuario_dest) nr_linha
						from	man_complaint_dest
						where	nr_seq_complaint = nr_seq_aviso_w
						and	(nm_usuario_dest IS NOT NULL AND nm_usuario_dest::text <> '')
						and	ie_situacao = 'A'
				) JOIN cte c ON (c.prior nr_linha = alias7.(nr_linha - 1))

) SELECT * FROM cte WHERE connect_by_isleaf = 1;
;
			end if;

			select	count(*)
			into STRICT	qt_dest_w
			from	man_complaint_dest
			where	nr_seq_complaint = nr_seq_aviso_w
			and	(cd_perfil_dest IS NOT NULL AND cd_perfil_dest::text <> '')
			and	ie_situacao = 'A';WITH RECURSIVE cte AS (


			if (qt_dest_w > 0) then
				select	substr(ltrim(cd_perfil_dest, ', '), 1, 4000)
				into STRICT	ds_perfis_dest_w
				from (	SELECT	cd_perfil_dest,
							row_number() over (order by cd_perfil_dest) nr_linha
						from	man_complaint_dest
						where	nr_seq_complaint = nr_seq_aviso_w
						and	(cd_perfil_dest IS NOT NULL AND cd_perfil_dest::text <> '')
						and	ie_situacao = 'A'
				) alias7 WHERE nr_linha = 1
  UNION ALL


			if (qt_dest_w > 0) then
				select	c.ds_perfis_dest_w || ', ' || substr(ltrim(cd_perfil_dest, ', '), 1, 4000)
				into STRICT	ds_perfis_dest_w
				from (	SELECT	cd_perfil_dest,
							row_number() over (order by cd_perfil_dest) nr_linha
						from	man_complaint_dest
						where	nr_seq_complaint = nr_seq_aviso_w
						and	(cd_perfil_dest IS NOT NULL AND cd_perfil_dest::text <> '')
						and	ie_situacao = 'A'
				) JOIN cte c ON (c.prior nr_linha = alias7.(nr_linha - 1))

) SELECT * FROM cte WHERE connect_by_isleaf = 1;
;
			end if;

			if (nm_usuarios_dest_w IS NOT NULL AND nm_usuarios_dest_w::text <> '') or (ds_perfis_dest_w IS NOT NULL AND ds_perfis_dest_w::text <> '') then
					CALL gerar_comunic_padrao(
						clock_timestamp(),
						(substr(obter_desc_expressao(309717, 'OS'), 1, 255) || ' ' || nr_seq_ordem_serv_p || ' - ' || ds_titulo_w),
						ds_aviso_w,
						'Tasy',
						'N',
						nm_usuarios_dest_w,
						'N',
						null,
						ds_perfis_dest_w,
						null,
						null,
						clock_timestamp(),
						null,
						null);
			end if;

		end;
		end loop;
		close c01;
	end if;

	-- chamada via Trigger da MAN_ORDEM_SERVICO(NÃ£o necessita commit aqui)
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_enviar_ci_complaint ( nr_seq_ordem_serv_p bigint, nr_seq_localizacao_p bigint, cd_funcao_p bigint) FROM PUBLIC;

