-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_procedimento_cih ( nr_atendimento_p bigint, cd_convenio_p bigint, ie_tipo_atendimento_p bigint, nr_interno_conta_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_registros_cih_w		integer;
ds_cod_proc_princ_w		varchar(15);
cd_proc_principal_w		bigint;
ie_origem_proc_princ_w	bigint;
cd_proc_sus_w			bigint;
cd_cid_principal_w		varchar(10);
cd_cid_secundario_w		varchar(10);
ie_origem_proced_sus_w		bigint;
ie_tipo_atendimento_w		smallint;
ie_clinica_w			integer;

BEGIN
select count(*)
into STRICT	qt_registros_cih_w
from	procedimento_paciente_cih
where	nr_atendimento = nr_atendimento_p;


if (qt_registros_cih_w	= 0) then
	begin
	cd_proc_principal_w	:= 0;
	select Obter_Proc_Principal(nr_atendimento_p,
					cd_convenio_p,
					ie_tipo_atendimento_p,
					nr_interno_conta_p,
					'CO')
	into STRICT	ds_cod_proc_princ_w
	;

	ie_origem_proc_princ_w 		:= somente_numero(substr(ds_cod_proc_princ_w,1,1));
	cd_proc_principal_w 		:= somente_numero(substr(ds_cod_proc_princ_w,2,16));

	if (cd_proc_principal_w	 > 0) then
		begin
		cd_proc_sus_w		:= 0;
		cd_cid_principal_w	:= null;
		cd_cid_secundario_w	:= null;

		begin
		select	ie_tipo_atendimento,
			coalesce(ie_clinica,0)
		into STRICT	ie_tipo_atendimento_w,
			ie_clinica_w
		from	atendimento_paciente
		where	nr_atendimento = nr_atendimento_p;
		exception
		when others then
			ie_tipo_atendimento_w	:= 0;
			ie_clinica_w		:= 0;
		end;

		select	coalesce(max(cd_procedimento_sus),0),
			coalesce(max(ie_origem_proced_sus),7)
		into STRICT	cd_proc_sus_w,
			ie_origem_proced_sus_w
		from	procedimento_conv_sus
		where	cd_procedimento	= cd_proc_principal_w
		and	ie_origem_proced	= ie_origem_proc_princ_w
		and	coalesce(ie_tipo_atendimento,ie_tipo_atendimento_w) = ie_tipo_atendimento_w
		and	coalesce(ie_clinica,ie_clinica_w) = ie_clinica_w;



		if (cd_proc_sus_w > 0) then
			begin
			select coalesce(max(cd_doenca_cid),'X'),
				max(cd_cid_secundario)
			into STRICT	cd_cid_principal_w,
				cd_cid_secundario_w
			from	procedimento
			where	cd_procedimento 	= cd_proc_sus_w
			and	ie_origem_proced	= ie_origem_proced_sus_w;
			end;
		end if;


		if (cd_proc_sus_w > 0) 		and (cd_cid_principal_w <> 'X')	then
			begin
			insert into procedimento_paciente_cih(
				NR_ATENDIMENTO,
				NR_SEQUENCIA,
				CD_PROCEDIMENTO,
				IE_ORIGEM_PROCED,
				DT_ATUALIZACAO,
				NM_USUARIO,
				CD_CID_PRIMARIO,
				CD_CID_SECUNDARIO)
			values (
				nr_atendimento_p,
				1,
				cd_proc_sus_w,
				ie_origem_proced_sus_w,
				clock_timestamp(),
				nm_usuario_p,
				cd_cid_principal_w,
				cd_cid_secundario_w);
			exception
				when others then
          			cd_cid_principal_w := cd_cid_principal_w;
			end;
		end if;
		end;
	end if;
	end;
end if;
if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_procedimento_cih ( nr_atendimento_p bigint, cd_convenio_p bigint, ie_tipo_atendimento_p bigint, nr_interno_conta_p bigint, nm_usuario_p text) FROM PUBLIC;

