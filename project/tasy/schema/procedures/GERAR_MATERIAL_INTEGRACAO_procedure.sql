-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_material_integracao ( cd_material_sistema_p text, nm_usuario_p text, cd_estabelecimento_p bigint, cd_classe_material_p bigint, cd_material_conta_p bigint, cd_material_estoque_p bigint, cd_material_generico_p bigint, cd_sistema_ant_p text, cd_unidade_medida_compra_p text, cd_unidade_medida_consumo_p text, cd_unidade_medida_estoque_p text, cd_unidade_medida_solic_p text, ds_material_p text, ds_reduzida_p text, ie_baixa_estoq_pac_p text, ie_cobra_paciente_p text, ie_consignado_p text, ie_disponivel_mercado_p text, ie_inf_ultima_compra_p text, ie_prescricao_p text, ie_preco_compra_p text, ie_tipo_material_p text, ie_padronizado_p text, ie_situacao_p text, ie_obrig_via_aplicacao_p text, ie_receita_p text, ie_material_estoque_p text, ie_via_aplicacao_p text, qt_conv_compra_estoque_p bigint, qt_conv_estoque_consumo_p bigint, qt_minimo_multiplo_solic_p bigint, qt_dia_estoque_minimo_p bigint, qt_dias_validade_p bigint, qt_dia_interv_ressup_p bigint, qt_dia_ressup_forn_p bigint, nr_seq_localizacao_p bigint, nr_seq_familia_p bigint, cd_fabricante_p text, nr_doc_externo_p text, ie_catalogo_p text, ie_curva_xyz_p text, cd_ncm_p text, cd_material_p INOUT bigint) AS $body$
DECLARE

 
cd_material_w			integer;
cd_material_ww			integer;
cd_material_conta_w		integer := cd_material_conta_p;
cd_material_estoque_w		integer := cd_material_estoque_p;
cd_material_generico_w		integer := cd_material_generico_p;
cd_unidade_medida_compra_w	varchar(30);
cd_unidade_medida_consumo_w	varchar(30);
cd_unidade_medida_estoque_w	varchar(30);
cd_unidade_medida_solic_w	varchar(30);
ie_de_para_unid_med_w		varchar(15);
qt_registro_w			bigint;
nr_seq_ncm_w	bigint;


BEGIN 
 
select	coalesce(max(cd_material),0) 
into STRICT	cd_material_ww 
from	material 
where	substr(obter_dados_material_estab(cd_material,cd_estabelecimento_p,'CSA'),1,20) = cd_material_sistema_p;
 
select	obter_ie_de_para_sup_integr('CM','R','UNIDADE_MEDIDA') 
into STRICT	ie_de_para_unid_med_w
;
 
/*Conversao para unidade de medida*/
 
cd_unidade_medida_compra_w 	:= cd_unidade_medida_compra_p;
cd_unidade_medida_consumo_w	:= cd_unidade_medida_consumo_p;
cd_unidade_medida_estoque_w	:= cd_unidade_medida_estoque_p;
cd_unidade_medida_solic_w	:= cd_unidade_medida_solic_p;
if (ie_de_para_unid_med_w = 'C') then 
	cd_unidade_medida_compra_w	:= coalesce(Obter_Conversao_interna(null,'UNIDADE_MEDIDA','CD_UNIDADE_MEDIDA',cd_unidade_medida_compra_p),cd_unidade_medida_compra_p);
	cd_unidade_medida_consumo_w	:= coalesce(Obter_Conversao_interna(null,'UNIDADE_MEDIDA','CD_UNIDADE_MEDIDA',cd_unidade_medida_consumo_p),cd_unidade_medida_consumo_p);
	cd_unidade_medida_estoque_w	:= coalesce(Obter_Conversao_interna(null,'UNIDADE_MEDIDA','CD_UNIDADE_MEDIDA',cd_unidade_medida_estoque_p),cd_unidade_medida_estoque_p);
	cd_unidade_medida_solic_w	:= coalesce(Obter_Conversao_interna(null,'UNIDADE_MEDIDA','CD_UNIDADE_MEDIDA',cd_unidade_medida_solic_p),cd_unidade_medida_solic_p);
	 
elsif (ie_de_para_unid_med_w = 'S') then		 
	cd_unidade_medida_compra_w	:= coalesce(obter_unid_med_sist_ant(cd_unidade_medida_compra_p),cd_unidade_medida_compra_p);
	cd_unidade_medida_consumo_w	:= coalesce(obter_unid_med_sist_ant(cd_unidade_medida_consumo_p),cd_unidade_medida_consumo_p);
	cd_unidade_medida_estoque_w	:= coalesce(obter_unid_med_sist_ant(cd_unidade_medida_estoque_p),cd_unidade_medida_estoque_p);
	cd_unidade_medida_solic_w	:= coalesce(obter_unid_med_sist_ant(cd_unidade_medida_solic_p),cd_unidade_medida_solic_p);
end if;
/*Fim*/
 
 
if (cd_material_ww = 0) then 
 
	select	nextval('material_seq') 
	into STRICT	cd_material_w 
	;
 
	if (cd_material_conta_p = 0) then 
		cd_material_conta_w	:= cd_material_w;
	end if;
 
	if (cd_material_generico_p = 0) then 
		cd_material_generico_w	:= cd_material_w;
	end if;
 
	if (coalesce(cd_material_estoque_p,0) = 0) then 
		cd_material_estoque_w	:= cd_material_w;
	end if;
 
	insert into material( 
		cd_material, 
		cd_fabricante, 
		cd_classe_material, 
		cd_material_estoque, 
		cd_material_generico, 
		cd_sistema_ant, 
		cd_unidade_medida_compra, 
		cd_unidade_medida_consumo, 
		cd_unidade_medida_estoque, 
		cd_unidade_medida_solic, 
		ds_material, 
		ds_reduzida, 
		ie_cobra_paciente, 
		ie_consignado, 
		ie_disponivel_mercado, 
		ie_inf_ultima_compra, 
		ie_obrig_via_aplicacao, 
		ie_preco_compra, 
		ie_receita, 
		ie_situacao, 
		ie_tipo_material, 
		ie_via_aplicacao, 
		nr_seq_familia, 
		nr_seq_localizacao, 
		qt_conv_compra_estoque, 
		qt_conv_estoque_consumo, 
		qt_dias_validade, 
		qt_minimo_multiplo_solic, 
		ie_abrigo_luz, 
		ie_baixa_inteira, 
		ie_bomba_infusao, 
		ie_controle_medico, 
		ie_diluicao, 
		ie_gravar_obs_prescr, 
		ie_mistura, 
		ie_solucao, 
		ie_umidade_controlada, 
		dt_cadastramento, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		ie_material_estoque, 
		ie_baixa_estoq_pac, 
		ie_curva_abc, 
		ie_catalogo) 
	values (cd_material_w, 
		cd_fabricante_p, 
		cd_classe_material_p, 
		cd_material_w,/*grava o próprio código do material, depois abaixo faz o update*/
 
		null, 
		cd_material_sistema_p, /*É o código do outro sistema*/
 
		cd_unidade_medida_compra_w, 
		cd_unidade_medida_consumo_w, 
		cd_unidade_medida_estoque_w, 
		cd_unidade_medida_solic_w, 
		ds_material_p, 
		ds_reduzida_p, 
		ie_cobra_paciente_p, 
		ie_consignado_p, 
		ie_disponivel_mercado_p, 
		ie_inf_ultima_compra_p, 
		ie_obrig_via_aplicacao_p, 
		ie_preco_compra_p, 
		ie_receita_p, 
		ie_situacao_p, 
		ie_tipo_material_p, 
		ie_via_aplicacao_p, 
		nr_seq_familia_p, 
		nr_seq_localizacao_p, 
		qt_conv_compra_estoque_p, 
		qt_conv_estoque_consumo_p, 
		qt_dias_validade_p, 
		qt_minimo_multiplo_solic_p, 
		'N','S','N',0,'N','N','N','S','N', 
		clock_timestamp(), 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		ie_material_estoque_p, 
		ie_baixa_estoq_pac_p, 
		'S', 
		ie_catalogo_p);
		 
	CALL gerar_material_estab_integ(cd_estabelecimento_p,cd_material_w,nm_usuario_p);
	 
	if (nr_doc_externo_p IS NOT NULL AND nr_doc_externo_p::text <> '') then 
		insert into material_sistema_externo( 
			nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			ie_sistema, 
			cd_material, 
			cd_codigo) 
		values (	nextval('material_sistema_externo_seq'), 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			'OCO', 
			cd_material_w, 
			nr_doc_externo_p);
	end if;
	 
	begin 
	update	material 
	set	cd_material_estoque = cd_material_estoque_w, 
		cd_material_generico = cd_material_generico_w 
	where	cd_material = cd_material_w;
	exception 
	when others then 
		cd_material_w := cd_material_w;
	end;
	 
	 
	update	material_estab 
	set	cd_material_conta 			= cd_material_conta_w, 
		ie_baixa_estoq_pac 		= ie_baixa_estoq_pac_p, 
		ie_material_estoque 		= ie_material_estoque_p, 
		ie_padronizado 			= ie_padronizado_p, 
		ie_prescricao 			= ie_prescricao_p, 
		qt_dia_estoque_minimo		= qt_dia_estoque_minimo_p, 
		qt_dia_interv_ressup		= qt_dia_interv_ressup_p, 
		qt_dia_ressup_forn		= qt_dia_ressup_forn_p, 
		ie_curva_xyz			= coalesce(ie_curva_xyz_p, ie_curva_xyz) 
	where	cd_material = cd_material_w 
	and	cd_estabelecimento = cd_estabelecimento_p;
	 
else 
	 
	if (cd_material_conta_p = 0) then 
		cd_material_conta_w	:= cd_material_ww;
	end if;
 
	if (cd_material_generico_p = 0) then 
		cd_material_generico_w	:= cd_material_ww;
	end if;
 
	if (coalesce(cd_material_estoque_p,0) = 0) then 
		cd_material_estoque_w	:= cd_material_ww;
	end if;
	 
	update	material 
	set	cd_fabricante				= cd_fabricante_p, 
		cd_classe_material			= coalesce(cd_classe_material_p, cd_classe_material), 
		cd_material_estoque			= cd_material_estoque_w, 
		cd_material_generico			= cd_material_generico_w, 
		cd_unidade_medida_compra			= cd_unidade_medida_compra_w, 
		cd_unidade_medida_consumo		= cd_unidade_medida_consumo_w, 
		cd_unidade_medida_estoque			= cd_unidade_medida_estoque_w, 
		cd_unidade_medida_solic			= cd_unidade_medida_solic_w, 
		ds_material				= ds_material_p, 
		ds_reduzida				= ds_reduzida_p, 
		ie_cobra_paciente				= ie_cobra_paciente_p, 
		ie_consignado				= ie_consignado_p, 
		ie_disponivel_mercado			= ie_disponivel_mercado_p, 
		ie_inf_ultima_compra			= ie_inf_ultima_compra_p, 
		ie_obrig_via_aplicacao			= ie_obrig_via_aplicacao_p, 
		ie_preco_compra				= ie_preco_compra_p, 
		ie_receita					= ie_receita_p, 
		ie_situacao				= ie_situacao_p, 
		ie_tipo_material				= ie_tipo_material_p, 
		ie_via_aplicacao				= ie_via_aplicacao_p, 
		nr_seq_familia				= nr_seq_familia_p, 
		nr_seq_localizacao				= nr_seq_localizacao_p, 
		qt_conv_compra_estoque			= qt_conv_compra_estoque_p, 
		qt_conv_estoque_consumo			= qt_conv_estoque_consumo_p, 
		qt_dias_validade				= qt_dias_validade_p, 
		qt_minimo_multiplo_solic			= qt_minimo_multiplo_solic_p, 
		dt_atualizacao				= clock_timestamp(), 
		nm_usuario				= nm_usuario_p, 
		ie_material_estoque				= ie_material_estoque_p, 
		ie_baixa_estoq_pac				= ie_baixa_estoq_pac_p, 
		ie_catalogo				= ie_catalogo_p 
	where	cd_material = cd_material_ww;
	 
	update	material_estab 
	set	cd_material_conta 			= cd_material_conta_w, 
		ie_baixa_estoq_pac 		= ie_baixa_estoq_pac_p, 
		ie_material_estoque 		= ie_material_estoque_p, 
		ie_padronizado 			= ie_padronizado_p, 
		ie_prescricao 			= ie_prescricao_p, 
		qt_dia_estoque_minimo		= qt_dia_estoque_minimo_p, 
		qt_dia_interv_ressup		= qt_dia_interv_ressup_p, 
		qt_dia_ressup_forn			= qt_dia_ressup_forn_p, 
		ie_curva_xyz			= coalesce(ie_curva_xyz_p, ie_curva_xyz) 
	where	cd_material = cd_material_ww 
	and	cd_estabelecimento = cd_estabelecimento_p;
	 
	if (nr_doc_externo_p IS NOT NULL AND nr_doc_externo_p::text <> '') then 
	 
		select	count(*) 
		into STRICT	qt_registro_w 
		from	material_sistema_externo 
		where	cd_material = cd_material_ww 
		and	ie_sistema = 'OCO';
		 
		if (qt_registro_w > 0) then 
			update	material_sistema_externo 
			set	cd_codigo = nr_doc_externo_p 
			where	cd_material = cd_material_ww 
			and	ie_sistema = 'OCO';
		else 
			insert into material_sistema_externo( 
				nr_sequencia, 
				dt_atualizacao, 
				nm_usuario, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				ie_sistema, 
				cd_material, 
				cd_codigo) 
			values (	nextval('material_sistema_externo_seq'), 
				clock_timestamp(), 
				nm_usuario_p, 
				clock_timestamp(), 
				nm_usuario_p, 
				'OCO', 
				cd_material_w, 
				nr_doc_externo_p);		
		end if;
	end if;
	 
	cd_material_w	:= cd_material_ww;
	 
end if;
 
if (cd_ncm_p <> '') and (cd_material_w > 0) then 
	select	coalesce(max(nr_sequencia), 0)  
	into STRICT	nr_seq_ncm_w 
	from	lista_ncm 
	where	cd_ncm = cd_ncm_p;
	 
	if (nr_seq_ncm_w > 0) then 
		update	material_fiscal 
		set	DT_ATUALIZACAO_NREC = clock_timestamp(), 
			NM_USUARIO_NREC = nm_usuario_p, 
			NR_SEQ_NCM = nr_seq_ncm_w 
		where	CD_MATERIAL = cd_material_w;
		 
		if (NOT FOUND) then 
			insert into	material_fiscal( 
				NR_SEQUENCIA, 
				DT_ATUALIZACAO, 
				NM_USUARIO, 
				DT_ATUALIZACAO_NREC, 
				NM_USUARIO_NREC, 
				CD_MATERIAL, 
				NR_SEQ_NCM) 
			values (nextval('material_fiscal_seq'), 
				clock_timestamp(), 
				nm_usuario_p, 
				clock_timestamp(), 
				nm_usuario_p, 
				cd_material_w, 
				nr_seq_ncm_w);
		end if;
	end if;
end if;
 
cd_material_p	:= cd_material_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_material_integracao ( cd_material_sistema_p text, nm_usuario_p text, cd_estabelecimento_p bigint, cd_classe_material_p bigint, cd_material_conta_p bigint, cd_material_estoque_p bigint, cd_material_generico_p bigint, cd_sistema_ant_p text, cd_unidade_medida_compra_p text, cd_unidade_medida_consumo_p text, cd_unidade_medida_estoque_p text, cd_unidade_medida_solic_p text, ds_material_p text, ds_reduzida_p text, ie_baixa_estoq_pac_p text, ie_cobra_paciente_p text, ie_consignado_p text, ie_disponivel_mercado_p text, ie_inf_ultima_compra_p text, ie_prescricao_p text, ie_preco_compra_p text, ie_tipo_material_p text, ie_padronizado_p text, ie_situacao_p text, ie_obrig_via_aplicacao_p text, ie_receita_p text, ie_material_estoque_p text, ie_via_aplicacao_p text, qt_conv_compra_estoque_p bigint, qt_conv_estoque_consumo_p bigint, qt_minimo_multiplo_solic_p bigint, qt_dia_estoque_minimo_p bigint, qt_dias_validade_p bigint, qt_dia_interv_ressup_p bigint, qt_dia_ressup_forn_p bigint, nr_seq_localizacao_p bigint, nr_seq_familia_p bigint, cd_fabricante_p text, nr_doc_externo_p text, ie_catalogo_p text, ie_curva_xyz_p text, cd_ncm_p text, cd_material_p INOUT bigint) FROM PUBLIC;

