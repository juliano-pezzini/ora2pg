-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_regra_comunic_evolucao (cd_evolucao_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
qt_existe_w				bigint := 0;
ie_evolucao_clinica_w	varchar(3);
nr_atendimento_w		bigint;
cd_pessoa_fisica_w		varchar(10);
cd_medico_w				varchar(10);
cd_perfil_w				integer;
ds_pos_inicio_rtf_w		bigint;
ds_evolucao_w 			varchar(32000) := '';
ds_evolucao_ww			varchar(32000) := '';
ds_perfil_dest_w		varchar(4000) := '';
ds_setor_w				varchar(255);
ds_leito_w				varchar(255);	
 
C01 CURSOR FOR 
	SELECT	distinct 
		cd_perfil 
	from	regra_comunic_evolucao 
	where	cd_tipo_evolucao = ie_evolucao_clinica_w 
	order by	1;

C02 CURSOR FOR 
	SELECT	ds_evolucao 
	from	evolucao_paciente 
	where	cd_evolucao	= cd_evolucao_p;
	
c02_w c02%rowtype;
	

BEGIN 
 
select	ie_evolucao_clinica, 
	nr_atendimento, 
	cd_pessoa_fisica, 
	cd_medico 
into STRICT	ie_evolucao_clinica_w, 
	nr_atendimento_w, 
	cd_pessoa_fisica_w, 
	cd_medico_w		 
from	evolucao_paciente 
where	cd_evolucao = cd_evolucao_p;
 
 
select	max(ds_setor_atendimento), 
	max(cd_unidade) 
into STRICT	ds_setor_w, 
	ds_leito_w 
from	atendimento_paciente_v 
where	nr_atendimento	= nr_atendimento_w;
 
select	count(*) 
into STRICT	qt_existe_w 
from	regra_comunic_evolucao 
where	cd_tipo_evolucao = ie_evolucao_clinica_w;
 
if (qt_existe_w > 0) then 
 
	open C02;
	loop 
	fetch C02 into	 
		c02_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		ds_evolucao_w	:= c02_w.ds_evolucao;
		end;
	end loop;
	close C02;
 
	if (ds_evolucao_w IS NOT NULL AND ds_evolucao_w::text <> '') then 
		/*Pega o cabecalho do RTF*/
 
		ds_pos_inicio_rtf_w := position('lang1046' in ds_evolucao_w)+8;
		ds_evolucao_ww 	:= substr(ds_evolucao_w,1,ds_pos_inicio_rtf_w) || 'fs20 ';
 
		ds_evolucao_ww := ds_evolucao_ww 	|| 
		obter_desc_expressao(283863) 	|| ' ' || nr_atendimento_w 									|| ' \par ' || -- Atendimento 
		obter_desc_expressao(295156) 	|| ' ' || substr(obter_nome_pf(cd_pessoa_fisica_w),1,60)	|| ' \par ' || -- Paciente 
		obter_desc_expressao(293090) 	|| ' ' || obter_nome_medico(cd_medico_w,'N') 				|| ' \par ' || -- Médico 
		obter_desc_expressao(298360) 	|| ' ' || ds_setor_w || ' \par ' || -- Setor 
		obter_desc_expressao(728916)/*'Leito\Compl : '*/
 ||ds_leito_w 								|| ' \par '|| 
		obter_desc_expressao(289676); -- Evolução 
		ds_evolucao_ww := ds_evolucao_ww || '\par \par '|| substr(ds_evolucao_w,ds_pos_inicio_rtf_w,length(ds_evolucao_w));
	end if;
 
	open C01;
	loop 
	fetch C01 into	 
		cd_perfil_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		ds_perfil_dest_w := ds_perfil_dest_w || to_char(cd_perfil_w) || ',';
		end;
	end loop;
	close C01;
	 
	insert	into comunic_interna( 
			nr_sequencia, 
			dt_comunicado, 
			ds_titulo, 
			ds_comunicado, 
			nm_usuario, 
			nm_usuario_destino, 
			dt_atualizacao, 
			ie_geral, 
			ie_gerencial, 
			ds_perfil_adicional, 
			dt_liberacao) 
	values ( 
			nextval('comunic_interna_seq'), 
			clock_timestamp(), 
			obter_desc_expressao(344746) || ' ' || substr(obter_nome_pf(cd_pessoa_fisica_w),1,60), --Evolução do Paciente 
			ds_evolucao_ww, 
			nm_usuario_p, 
			null, 
			clock_timestamp(), 
			'N', 
			'N', 
			ds_perfil_dest_w, 
			clock_timestamp());
	commit;		
 
end if;
 
end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_regra_comunic_evolucao (cd_evolucao_p bigint, nm_usuario_p text) FROM PUBLIC;

