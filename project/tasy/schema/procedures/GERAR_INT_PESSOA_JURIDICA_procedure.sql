-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_int_pessoa_juridica ( nr_sequencia_p bigint, nm_usuario_p text, ie_status_p INOUT text, ds_erro_p INOUT text) AS $body$
DECLARE



ds_erro_w       varchar(4000);
ds_erro_sqlerrm_w     varchar(4000);
qt_registros_w        bigint;
ie_status_w       varchar(15);
cd_retorno_de_para_w      varchar(255);

cd_regra_w        smallint;

/*PESSOA_JURIDICA*/

cd_cep_w    w_int_pessoa_juridica.cd_cep%type;
cd_cnpj_w               w_int_pessoa_juridica.cd_cnpj%type;
cd_tipo_pessoa_w  w_int_pessoa_juridica.cd_tipo_pessoa%type;
ds_endereco_w           w_int_pessoa_juridica.ds_endereco%type;
ds_municipio_w          w_int_pessoa_juridica.ds_municipio%type;
ds_razao_social_w       w_int_pessoa_juridica.ds_razao_social%type;
ie_prod_fabric_w        w_int_pessoa_juridica.ie_prod_fabric%type;
ie_situacao_w           w_int_pessoa_juridica.ie_situacao%type;
nm_fantasia_w           w_int_pessoa_juridica.nm_fantasia%type;
sg_estado_w   w_int_pessoa_juridica.sg_estado%type;
cd_ans_w      w_int_pessoa_juridica.cd_ans%type;
cd_cnes_w                       w_int_pessoa_juridica.cd_cnes%type;
cd_cnpj_mantenedora_w       w_int_pessoa_juridica.cd_cnpj_mantenedora%type;
cd_conta_contabil_w           w_int_pessoa_juridica.cd_conta_contabil%type;
cd_curp_w                     w_int_pessoa_juridica.cd_curp%type;
cd_internacional_w            w_int_pessoa_juridica.cd_internacional%type;
cd_municipio_ibge_w           w_int_pessoa_juridica.cd_municipio_ibge%type;
cd_operadora_empresa_w        w_int_pessoa_juridica.cd_operadora_empresa%type;
cd_pf_resp_tecnico_w          w_int_pessoa_juridica.cd_pf_resp_tecnico%type;
cd_pf_resp_tecnico_ww         w_int_pessoa_juridica.cd_pf_resp_tecnico%type;
cd_rfc_w                      w_int_pessoa_juridica.cd_rfc%type;
cd_sistema_ant_w                w_int_pessoa_juridica.cd_sistema_ant%type;
ds_bairro_w                   w_int_pessoa_juridica.ds_bairro%type;
ds_complemento_w              w_int_pessoa_juridica.ds_complemento%type;
ds_email_w                      w_int_pessoa_juridica.ds_email%type;
ds_nome_abrev_w               w_int_pessoa_juridica.ds_nome_abrev%type;
ds_observacao_w               w_int_pessoa_juridica.ds_observacao%type;
ds_observacao_compl_w         w_int_pessoa_juridica.ds_observacao_compl%type;
ds_orgao_reg_resp_tecnico_w     w_int_pessoa_juridica.ds_orgao_reg_resp_tecnico%type;
ds_site_internet_w            w_int_pessoa_juridica.ds_site_internet%type;
dt_validade_alvara_munic_w    w_int_pessoa_juridica.dt_validade_alvara_munic%type;
dt_validade_alvara_sanit_w    w_int_pessoa_juridica.dt_validade_alvara_sanit%type;
dt_validade_autor_func_w      w_int_pessoa_juridica.dt_validade_autor_func%type;
dt_validade_cert_boas_prat_w  w_int_pessoa_juridica.dt_validade_cert_boas_prat%type;
dt_validade_resp_tecnico_w    w_int_pessoa_juridica.dt_validade_resp_tecnico%type;
ie_empreendedor_individual_w  w_int_pessoa_juridica.ie_empreendedor_individual%type;
ie_fornecedor_opme_w            w_int_pessoa_juridica.ie_fornecedor_opme%type;
ie_qualidade_w                  w_int_pessoa_juridica.ie_qualidade%type;
ie_tipo_trib_municipal_w      w_int_pessoa_juridica.ie_tipo_trib_municipal%type;
ie_tipo_tributacao_w          w_int_pessoa_juridica.ie_tipo_tributacao%type;
ie_transporte_w                 w_int_pessoa_juridica.ie_transporte%type;
nr_alvara_sanitario_w       w_int_pessoa_juridica.nr_alvara_sanitario%type;
nr_alvara_sanitario_munic_w   w_int_pessoa_juridica.nr_alvara_sanitario_munic%type;
nr_autor_func_w               w_int_pessoa_juridica.nr_autor_func%type;
nr_certificado_boas_prat_w    w_int_pessoa_juridica.nr_certificado_boas_prat%type;
nr_ddd_fax_w                  w_int_pessoa_juridica.nr_ddd_fax%type;
nr_ddd_telefone_w             w_int_pessoa_juridica.nr_ddd_telefone%type;
nr_ddi_fax_w                  w_int_pessoa_juridica.nr_ddi_fax%type;
nr_ddi_telefone_w             w_int_pessoa_juridica.nr_ddi_telefone%type;
nr_endereco_w                 w_int_pessoa_juridica.nr_endereco%type;
nr_fax_w                      w_int_pessoa_juridica.nr_fax%type;
nr_inscricao_estadual_w       w_int_pessoa_juridica.nr_inscricao_estadual%type;
nr_inscricao_municipal_w      w_int_pessoa_juridica.nr_inscricao_municipal%type;
nr_registro_pls_w             w_int_pessoa_juridica.nr_registro_pls%type;
nr_registro_resp_tecnico_w    w_int_pessoa_juridica.nr_registro_resp_tecnico%type;
nr_seq_cnae_w                 w_int_pessoa_juridica.nr_seq_cnae%type;
nr_seq_idioma_w               w_int_pessoa_juridica.nr_seq_idioma%type;
nr_seq_pais_w                 w_int_pessoa_juridica.nr_seq_pais%type;
nr_seq_regiao_w               w_int_pessoa_juridica.nr_seq_regiao%type;
nr_seq_tipo_logradouro_w      w_int_pessoa_juridica.nr_seq_tipo_logradouro%type;
nr_telefone_w                   w_int_pessoa_juridica.nr_telefone%type;

/*PESSOA JURIDICA ESTAB*/

ie_conta_dif_nf_w     w_int_pes_juridica_estab.ie_conta_dif_nf%type;
cd_estabelecimento_w      w_int_pes_juridica_estab.cd_estabelecimento%type;
--cd_cgc_w        w_int_pes_juridica_estab.cd_cgc%type;
cd_cond_pagto_w       w_int_pes_juridica_estab.cd_cond_pagto%type;
cd_operacao_nf_w                w_int_pes_juridica_estab.cd_operacao_nf%type;
cd_portador_w                   w_int_pes_juridica_estab.cd_portador%type;
cd_referencia_fornec_w          w_int_pes_juridica_estab.cd_referencia_fornec%type;
cd_sistema_ant_estab_w              w_int_pes_juridica_estab.cd_sistema_ant%type;
cd_tipo_baixa_w                 w_int_pes_juridica_estab.cd_tipo_baixa%type;
cd_tipo_portador_w              w_int_pes_juridica_estab.cd_tipo_portador%type;
ds_email_estab_w                    w_int_pes_juridica_estab.ds_email%type;
ie_baixa_abat_w                 w_int_pes_juridica_estab.ie_baixa_abat%type;
ie_consiste_nr_serie_nf_w             w_int_pes_juridica_estab.ie_consiste_nr_serie_nf%type;
ie_endereco_correspondencia_w   w_int_pes_juridica_estab.ie_endereco_correspondencia%type;
ie_exige_anexo_nf_w             w_int_pes_juridica_estab.ie_exige_anexo_nf%type;
ie_exige_ordem_compra_w       w_int_pes_juridica_estab.ie_exige_ordem_compra%type;
ie_forma_pagto_w                w_int_pes_juridica_estab.ie_forma_pagto%type;
ie_frete_w                      w_int_pes_juridica_estab.ie_frete%type;
ie_moeda_estrangeira_w          w_int_pes_juridica_estab.ie_moeda_estrangeira%type;
ie_qualidade_estab_w                w_int_pes_juridica_estab.ie_qualidade%type;
ie_rateio_adiant_w              w_int_pes_juridica_estab.ie_rateio_adiant%type;
ie_rec_email_comercial_w        w_int_pes_juridica_estab.ie_rec_email_comercial%type;
ie_retem_iss_w                  w_int_pes_juridica_estab.ie_retem_iss%type;
ie_status_apenado_w             w_int_pes_juridica_estab.ie_status_apenado%type;
nm_pessoa_contato_w             w_int_pes_juridica_estab.nm_pessoa_contato%type;
nr_codigo_serv_prest_w          w_int_pes_juridica_estab.nr_codigo_serv_prest%type;
nr_ramal_contato_w                w_int_pes_juridica_estab.nr_ramal_contato%type;
pr_desc_financeiro_w            w_int_pes_juridica_estab.pr_desc_financeiro%type;
qt_dia_prazo_entrega_w          w_int_pes_juridica_estab.qt_dia_prazo_entrega%type;
tx_desc_antecipacao_w           w_int_pes_juridica_estab.tx_desc_antecipacao%type;
tx_desc_assiduidade_w           w_int_pes_juridica_estab.tx_desc_assiduidade%type;
tx_desc_ordem_w                 w_int_pes_juridica_estab.tx_desc_ordem%type;
vl_minimo_nf_w                  w_int_pes_juridica_estab.vl_minimo_nf%type;

C01 CURSOR FOR
SELECT  cd_estabelecimento,
  nm_pessoa_contato,
  nr_ramal_contato,
  ds_email,
  cd_cond_pagto,
  qt_dia_prazo_entrega,
  vl_minimo_nf,
  ie_qualidade,
  cd_referencia_fornec,
  ie_forma_pagto,
  coalesce(ie_conta_dif_nf,'N'),
  cd_portador,
  cd_tipo_portador,
  cd_tipo_baixa,
  nr_codigo_serv_prest,
  tx_desc_antecipacao,
  coalesce(ie_rateio_adiant,'P'),
  coalesce(ie_retem_iss,'N'),
  tx_desc_ordem,
  ie_endereco_correspondencia,
  pr_desc_financeiro,
  coalesce(cd_sistema_ant,cd_cnpj_w),
  ie_frete,
  coalesce(ie_exige_anexo_nf,'N'),
  coalesce(ie_exige_ordem_compra,'N'),
  coalesce(ie_baixa_abat,'N'),
  tx_desc_assiduidade,
  cd_operacao_nf,
  coalesce(ie_consiste_nr_serie_nf,'S'),
  ie_status_apenado,
  ie_rec_email_comercial,
  ie_moeda_estrangeira
from  w_int_pes_juridica_estab
where   nr_seq_pes_juridica = nr_sequencia_p;


BEGIN

ie_status_w := 'OK';

select  count(*)
into STRICT  qt_registros_w
from  w_int_pessoa_juridica
where nr_sequencia = nr_sequencia_p;

if (qt_registros_w > 0) then

  select  cd_ans,
    cd_cep,
    cd_cnes,
    cd_cnpj,
    cd_cnpj_mantenedora,
    cd_conta_contabil,
    cd_curp,
    cd_internacional,
    cd_municipio_ibge,
    cd_operadora_empresa,
    cd_pf_resp_tecnico,
    cd_rfc,
    coalesce(cd_sistema_ant,cd_cnpj),
    cd_tipo_pessoa,
    ds_bairro,
    ds_complemento,
    ds_email,
    ds_endereco,
    ds_municipio,
    ds_nome_abrev,
    ds_observacao,
    ds_observacao_compl,
    ds_orgao_reg_resp_tecnico,
    ds_razao_social,
    ds_site_internet,
    dt_validade_alvara_munic,
    dt_validade_alvara_sanit,
    dt_validade_autor_func,
    dt_validade_cert_boas_prat,
    dt_validade_resp_tecnico,
    coalesce(ie_empreendedor_individual,'N'),
    coalesce(ie_fornecedor_opme,'N'),
    coalesce(ie_prod_fabric,'N'),
    ie_qualidade,
    coalesce(ie_situacao,'A'),
    ie_tipo_trib_municipal,
    ie_tipo_tributacao,
    coalesce(ie_transporte,'N'),
    nm_fantasia,
    nr_alvara_sanitario,
    nr_alvara_sanitario_munic,
    nr_autor_func,
    nr_certificado_boas_prat,
    nr_ddd_fax,
    nr_ddd_telefone,
    nr_ddi_fax,
    nr_ddi_telefone,
    nr_endereco,
    nr_fax,
    nr_inscricao_estadual,
    nr_inscricao_municipal,
    nr_registro_pls,
    nr_registro_resp_tecnico,
    nr_seq_cnae,
    nr_seq_idioma,
    nr_seq_pais,
    nr_seq_regiao,
    nr_seq_tipo_logradouro,
    nr_telefone,
    sg_estado
  into STRICT  cd_ans_w,
    cd_cep_w,
    cd_cnes_w,
    cd_cnpj_w,
    cd_cnpj_mantenedora_w,
    cd_conta_contabil_w,
    cd_curp_w,
    cd_internacional_w,
    cd_municipio_ibge_w,
    cd_operadora_empresa_w,
    cd_pf_resp_tecnico_w,
    cd_rfc_w,
    cd_sistema_ant_w,
    cd_tipo_pessoa_w,
    ds_bairro_w,
    ds_complemento_w,
    ds_email_w,
    ds_endereco_w,
    ds_municipio_w,
    ds_nome_abrev_w,
    ds_observacao_w,
    ds_observacao_compl_w,
    ds_orgao_reg_resp_tecnico_w,
    ds_razao_social_w,
    ds_site_internet_w,
    dt_validade_alvara_munic_w,
    dt_validade_alvara_sanit_w,
    dt_validade_autor_func_w,
    dt_validade_cert_boas_prat_w,
    dt_validade_resp_tecnico_w,
    ie_empreendedor_individual_w,
    ie_fornecedor_opme_w,
    ie_prod_fabric_w,
    ie_qualidade_w,
    ie_situacao_w,
    ie_tipo_trib_municipal_w,
    ie_tipo_tributacao_w,
    ie_transporte_w,
    nm_fantasia_w,
    nr_alvara_sanitario_w,
    nr_alvara_sanitario_munic_w,
    nr_autor_func_w,
    nr_certificado_boas_prat_w,
    nr_ddd_fax_w,
    nr_ddd_telefone_w,
    nr_ddi_fax_w,
    nr_ddi_telefone_w,
    nr_endereco_w,
    nr_fax_w,
    nr_inscricao_estadual_w,
    nr_inscricao_municipal_w,
    nr_registro_pls_w,
    nr_registro_resp_tecnico_w,
    nr_seq_cnae_w,
    nr_seq_idioma_w,
    nr_seq_pais_w,
    nr_seq_regiao_w,
    nr_seq_tipo_logradouro_w,
    nr_telefone_w,
    sg_estado_w
  from  w_int_pessoa_juridica
  where nr_sequencia = nr_sequencia_p;
else
  ie_status_w := 'E';
  ds_erro_w := wheb_mensagem_pck.get_Texto(450133,'DS_TABELA_W='||'W_INT_PESSOA_JURIDICA'||';NR_SEQUENCIA_W=' || nr_sequencia_p);
  /*Não existe nenhum registro na tabela de #@DS_TABELA_W#@ com o código #@NR_SEQUENCIA_W#@.*/

end if;

if (ie_status_w = 'OK') and (cd_conta_contabil_w IS NOT NULL AND cd_conta_contabil_w::text <> '') then

  select  coalesce(somente_numero(bkf_obter_conv_interna('','CONTA_CONTABIL','CD_CONTA_CONTABIL',cd_conta_contabil_w,'BKF')),0)
  into STRICT  cd_retorno_de_para_w
;

  if (cd_retorno_de_para_w = 0) then
    ie_status_w := 'E';
    ds_erro_w := wheb_mensagem_pck.get_Texto(458566,'NM_TABELA='||'CONTA_CONTABIL'||';DS_ATRIBUTO='||'CD_CONTA_CONTABIL'||';CD_CODIGO='||cd_conta_contabil_w);
    /*Não foi cadastrada a conversão para a tabela: #@NM_TABELA#@; Atributo: #@DS_ATRIBUTO#@; Código: #@CD_CODIGO#@.*/

  else
    select  count(*)
    into STRICT  qt_registros_w
    from  conta_contabil
    where cd_conta_contabil = cd_retorno_de_para_w;

    if (qt_registros_w = 0) then
      ie_status_w := 'E';
      ds_erro_w := wheb_mensagem_pck.get_texto(458650,'CD_CONTA_CONTABIL_TASY_W='||cd_retorno_de_para_w ||';CD_CONTA_CONTABIL_INT_W='|| cd_conta_contabil_w);
      /*Não existe no Tasy a conta contábil com o código #@CD_CONTA_CONTABIL_TASY_W#@. Verifique o cadastro de conversão para o código da conta contábil #@CD_CONTA_CONTABIL_INT_W#@ que veio do sistema externo.*/

    else
      cd_conta_contabil_w := cd_retorno_de_para_w;
    end if;
  end if;
end if;

if (ie_status_w = 'OK') and (nr_seq_pais_w IS NOT NULL AND nr_seq_pais_w::text <> '') then

  select  coalesce(somente_numero(bkf_obter_conv_interna('','PAIS','NR_SEQUENCIA',nr_seq_pais_w,'BKF')),0)
  into STRICT  cd_retorno_de_para_w
;

  if (cd_retorno_de_para_w = 0) then
    ie_status_w := 'E';
    ds_erro_w := wheb_mensagem_pck.get_Texto(458566,'NM_TABELA='||'PAIS'||';DS_ATRIBUTO='||'NR_SEQUENCIA'||';CD_CODIGO='||nr_seq_pais_w);
    /*Não foi cadastrada a conversão para a tabela: #@NM_TABELA#@; Atributo: #@DS_ATRIBUTO#@; Código: #@CD_CODIGO#@.*/

  else
    select  count(*)
    into STRICT  qt_registros_w
    from  pais
    where nr_sequencia = cd_retorno_de_para_w;

    if (qt_registros_w = 0) then
      ie_status_w := 'E';
      ds_erro_w := wheb_mensagem_pck.get_texto(458656,'CD_PAIS_TASY_W='||cd_retorno_de_para_w ||';CD_PAIS_INT_W='|| nr_seq_pais_w);
      /*Não existe no Tasy o país com o código #@CD_PAIS_TASY_W#@. Verifique o cadastro de conversão para o código do país #@CD_PAIS_INT_W#@ que veio do sistema externo.*/

    else
      nr_seq_pais_w := cd_retorno_de_para_w;
    end if;
  end if;
end if;

if (ie_status_w = 'OK') and (nr_seq_tipo_logradouro_w IS NOT NULL AND nr_seq_tipo_logradouro_w::text <> '') then

  select  coalesce(somente_numero(bkf_obter_conv_interna('','CNS_TIPO_LOGRADOURO','NR_SEQUENCIA',nr_seq_tipo_logradouro_w,'BKF')),0)
  into STRICT  cd_retorno_de_para_w
;

  if (cd_retorno_de_para_w = 0) then
    ie_status_w := 'E';
    ds_erro_w := wheb_mensagem_pck.get_Texto(458566,'NM_TABELA='||'CNS_TIPO_LOGRADOURO'||';DS_ATRIBUTO='||'NR_SEQUENCIA'||';CD_CODIGO='||nr_seq_tipo_logradouro_w);
    /*Não foi cadastrada a conversão para a tabela: #@NM_TABELA#@; Atributo: #@DS_ATRIBUTO#@; Código: #@CD_CODIGO#@.*/

  else

    select  count(*)
    into STRICT  qt_registros_w
    from  cns_tipo_logradouro
    where nr_sequencia = cd_retorno_de_para_w;

    if (qt_registros_w = 0) then
      ie_status_w := 'E';
      ds_erro_w := wheb_mensagem_pck.get_texto(458657,'CD_LOG_TASY_W='||cd_retorno_de_para_w ||';CD_LOG_INT_W='|| nr_seq_tipo_logradouro_w);
      /*Não existe no Tasy o logradouro com o código #@CD_LOG_TASY_W#@. Verifique o cadastro de conversão para o código do país #@CD_LOG_INT_W#@ que veio do sistema externo.*/

    else
      nr_seq_tipo_logradouro_w := cd_retorno_de_para_w;
    end if;
  end if;
end if;

if (ie_status_w = 'OK') and (nr_seq_cnae_w IS NOT NULL AND nr_seq_cnae_w::text <> '') then

  select  coalesce(somente_numero(bkf_obter_conv_interna('','PLS_CNAE','NR_SEQUENCIA',nr_seq_cnae_w,'BKF')),0)
  into STRICT  cd_retorno_de_para_w
;

  if (cd_retorno_de_para_w = 0) then
    ie_status_w := 'E';
    ds_erro_w := wheb_mensagem_pck.get_Texto(458566,'NM_TABELA='||'PLS_CNAE'||';DS_ATRIBUTO='||'NR_SEQUENCIA'||';CD_CODIGO='||nr_seq_cnae_w);
    /*Não foi cadastrada a conversão para a tabela: #@NM_TABELA#@; Atributo: #@DS_ATRIBUTO#@; Código: #@CD_CODIGO#@.*/

  else
    select  count(*)
    into STRICT  qt_registros_w
    from  pls_cnae
    where nr_sequencia = cd_retorno_de_para_w;

    if (qt_registros_w = 0) then
      ie_status_w := 'E';
      ds_erro_w := wheb_mensagem_pck.get_texto(458658,'CD_CNAE_TASY_W='||cd_retorno_de_para_w ||';CD_CNAE_INT_W='|| nr_seq_cnae_w);
      /*Não existe no Tasy o CNAE com o código #@CD_CNAE_TASY_W#@. Verifique o cadastro de conversão para o código do CNAE #@CD_CNAE_INT_W#@ que veio do sistema externo.*/

    else
      nr_seq_cnae_w := cd_retorno_de_para_w;
    end if;
  end if;
end if;

if (ie_status_w = 'OK') and (nr_seq_regiao_w IS NOT NULL AND nr_seq_regiao_w::text <> '') then

  select  coalesce(somente_numero(bkf_obter_conv_interna('','SUS_MUNICIPIO_REGIAO','NR_SEQUENCIA',nr_seq_regiao_w,'BKF')),0)
  into STRICT  cd_retorno_de_para_w
;

  if (cd_retorno_de_para_w = 0) then
    ie_status_w := 'E';
    ds_erro_w := wheb_mensagem_pck.get_Texto(458566,'NM_TABELA='||'SUS_MUNICIPIO_REGIAO'||';DS_ATRIBUTO='||'NR_SEQUENCIA'||';CD_CODIGO='||nr_seq_regiao_w);
    /*Não foi cadastrada a conversão para a tabela: #@NM_TABELA#@; Atributo: #@DS_ATRIBUTO#@; Código: #@CD_CODIGO#@.*/

  else
    select  count(*)
    into STRICT  qt_registros_w
    from  sus_municipio_regiao
    where nr_sequencia = cd_retorno_de_para_w;

    if (qt_registros_w = 0) then
      ie_status_w := 'E';
      ds_erro_w := wheb_mensagem_pck.get_texto(458675,'NR_SEQ_REGIAO_TASY_W='||cd_retorno_de_para_w ||';NR_SEQ_REGIAO_INT_W='|| nr_seq_regiao_w);
      /*Não existe no Tasy a região com o código #@NR_SEQ_REGIAO_TASY_W#@. Verifique o cadastro de conversão para o código da região #@NR_SEQ_REGIAO_INT_W#@ que veio do sistema externo.*/

    else
      nr_seq_regiao_w := cd_retorno_de_para_w;
    end if;
  end if;
end if;

if (ie_status_w = 'OK') and (nr_seq_idioma_w IS NOT NULL AND nr_seq_idioma_w::text <> '') then

  select  coalesce(somente_numero(bkf_obter_conv_interna('','TASY_IDIOMA','NR_SEQUENCIA',nr_seq_idioma_w,'BKF')),0)
  into STRICT  cd_retorno_de_para_w
;

  if (cd_retorno_de_para_w = 0) then
    ie_status_w := 'E';
    ds_erro_w := wheb_mensagem_pck.get_Texto(458566,'NM_TABELA='||'TASY_IDIOMA'||';DS_ATRIBUTO='||'NR_SEQUENCIA'||';CD_CODIGO='||nr_seq_idioma_w);
    /*Não foi cadastrada a conversão para a tabela: #@NM_TABELA#@; Atributo: #@DS_ATRIBUTO#@; Código: #@CD_CODIGO#@.*/

  else
    select  count(*)
    into STRICT  qt_registros_w
    from  tasy_idioma
    where nr_sequencia = cd_retorno_de_para_w;

    if (qt_registros_w = 0) then
      ie_status_w := 'E';
      ds_erro_w := wheb_mensagem_pck.get_texto(458676,'NR_SEQ_IDIOMA_TASY_W='||cd_retorno_de_para_w ||';NR_SEQ_IDIOMA_INT_W='|| nr_seq_idioma_w);
      /*Não existe no Tasy o idioma com o código #@NR_SEQ_IDIOMA_TASY_W#@. Verifique o cadastro de conversão para o código do idioma #@NR_SEQ_IDIOMA_INT_W#@ que veio do sistema externo.*/

    else
      nr_seq_idioma_w := cd_retorno_de_para_w;
    end if;
  end if;
end if;

if (ie_status_w = 'OK') and (cd_tipo_pessoa_w IS NOT NULL AND cd_tipo_pessoa_w::text <> '') then

  select  coalesce(somente_numero(bkf_obter_conv_interna('','TIPO_PESSOA_JURIDICA','CD_TIPO_PESSOA',cd_tipo_pessoa_w,'BKF')),0)
  into STRICT  cd_retorno_de_para_w
;

  if (cd_retorno_de_para_w = 0) then
    ie_status_w := 'E';
    ds_erro_w := wheb_mensagem_pck.get_Texto(458566,'NM_TABELA='||'TIPO_PESSOA_JURIDICA'||';DS_ATRIBUTO='||'CD_TIPO_PESSOA'||';CD_CODIGO='||cd_tipo_pessoa_w);
    /*Não foi cadastrada a conversão para a tabela: #@NM_TABELA#@; Atributo: #@DS_ATRIBUTO#@; Código: #@CD_CODIGO#@.*/

  else
    select  count(*)
    into STRICT  qt_registros_w
    from  tipo_pessoa_juridica
    where cd_tipo_pessoa = cd_retorno_de_para_w;

    if (qt_registros_w = 0) then
      ie_status_w := 'E';
      ds_erro_w := wheb_mensagem_pck.get_texto(458677,'CD_TIPO_PESSOA_TASY_W='||cd_retorno_de_para_w ||';CD_TIPO_PESSOA_INT_W='|| cd_tipo_pessoa_w);
      /*Não existe no Tasy o tipo de pessoa jurídica com o código #@CD_TIPO_PESSOA_TASY_W#@. Verifique o cadastro de conversão para o código do tipo de pessoa jurídica #@CD_TIPO_PESSOA_INT_W#@ que veio do sistema externo.*/

    else
      cd_tipo_pessoa_w := cd_retorno_de_para_w;
    end if;
  end if;
elsif (ie_status_w = 'OK') and (coalesce(cd_tipo_pessoa_w::text, '') = '') then
  ie_status_w := 'E';
  ds_erro_w := wheb_mensagem_pck.get_texto(458678,'DS_CAMPO_W='||'CD_TIPO_PESSOA'); /*Não foi informado o campo #@DS_CAMPO#@. Esse campo é necessário para o cadastro do material.*/
end if;

if (ie_status_w = 'OK') and (cd_cnpj_mantenedora_w IS NOT NULL AND cd_cnpj_mantenedora_w::text <> '') then

  select  count(*)
  into STRICT  qt_registros_w
  from  pessoa_juridica
  where cd_cgc = cd_cnpj_mantenedora_w;

  if (qt_registros_w = 0) then
    ie_status_w := 'E';
    ds_erro_w := wheb_mensagem_pck.get_texto(458679, 'CD_CNPJ_MANTENEDORA_W='||cd_cnpj_mantenedora_w);
    /*Não existe no Tasy nenhuma pessoa jurídica com o CNPJ #@CD_CNPJ_MANTENEDORA_W#@.Esse CNPJ foi enviado no campo CD_CNPJ_MANTENEDORA.*/

  end if;
end if;

if (ie_status_w = 'OK') and (cd_pf_resp_tecnico_w IS NOT NULL AND cd_pf_resp_tecnico_w::text <> '') then

  select  count(*)
  into STRICT  qt_registros_w
  from  pessoa_fisica
  where nr_cpf = cd_pf_resp_tecnico_w;

  if (qt_registros_w = 0) then
    ie_status_w := 'E';
    ds_erro_w := wheb_mensagem_pck.get_texto(449240,'CD_CPF_W='||cd_pf_resp_tecnico_w); /*Não existe no Tasy uma pessoa física cadastrada com o CPF #@CD_CPF_W#@.*/
  else
    select  max(cd_pessoa_fisica)
    into STRICT  cd_pf_resp_tecnico_ww
    from  pessoa_fisica
    where nr_cpf = cd_pf_resp_tecnico_w;
  end if;
end if;

if (ie_status_w = 'OK') and (coalesce(cd_cep_w::text, '') = '') then
  ie_status_w := 'E';
  ds_erro_w := wheb_mensagem_pck.get_texto(458563,'DS_CAMPO='||'CD_CEP'); /*O campo #@DS_CAMPO#@ deve ser preenchido.*/
end if;

if (ie_status_w = 'OK') and (coalesce(cd_cnpj_w::text, '') = '') then
  ie_status_w := 'E';
  ds_erro_w := wheb_mensagem_pck.get_texto(458563,'DS_CAMPO='||'CD_CNPJ'); /*O campo #@DS_CAMPO#@ deve ser preenchido.*/
end if;

if (ie_status_w = 'OK') and (cd_cnpj_w IS NOT NULL AND cd_cnpj_w::text <> '') and (length(cd_cnpj_w) <> 14) then
  ie_status_w := 'E';
  ds_erro_w := wheb_mensagem_pck.get_texto(458680); /*O CNPJ deve ter 14 posições numéricas!*/
end if;

if (ie_status_w = 'OK') and (coalesce(ds_endereco_w::text, '') = '') then
  ie_status_w := 'E';
  ds_erro_w := wheb_mensagem_pck.get_texto(458563,'DS_CAMPO='||'DS_ENDERECO'); /*O campo #@DS_CAMPO#@ deve ser preenchido.*/
end if;

if (ie_status_w = 'OK') and (coalesce(ds_municipio_w::text, '') = '') then
  ie_status_w := 'E';
  ds_erro_w := wheb_mensagem_pck.get_texto(458563,'DS_CAMPO='||'DS_MUNICIPIO'); /*O campo #@DS_CAMPO#@ deve ser preenchido.*/
end if;

if (ie_status_w = 'OK') and (coalesce(sg_estado_w::text, '') = '') then
  ie_status_w := 'E';
  ds_erro_w := wheb_mensagem_pck.get_texto(458563,'DS_CAMPO='||'SG_ESTADO'); /*O campo #@DS_CAMPO#@ deve ser preenchido.*/
end if;

if (ie_status_w = 'OK') and (coalesce(ds_razao_social_w::text, '') = '') then
  ie_status_w := 'E';
  ds_erro_w := wheb_mensagem_pck.get_texto(458563,'DS_CAMPO='||'DS_RAZAO_SOCIAL'); /*O campo #@DS_CAMPO#@ deve ser preenchido.*/
end if;

if (ie_status_w = 'OK') and (coalesce(nm_fantasia_w::text, '') = '') then
  ie_status_w := 'E';
  ds_erro_w := wheb_mensagem_pck.get_texto(458563,'DS_CAMPO='||'NM_FANTASIA'); /*O campo #@DS_CAMPO#@ deve ser preenchido.*/
end if;

if (ie_status_w = 'OK') and (ie_prod_fabric_w not in ('S','N')) then
  ie_status_w := 'E';
  ds_erro_w := wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_PROD_FABRIC'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
end if;

if (ie_status_w = 'OK') and (ie_fornecedor_opme_w not in ('S','N')) then
  ie_status_w := 'E';
  ds_erro_w := wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_FORNECEDOR_OPME'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
end if;

if (ie_status_w = 'OK') and (ie_transporte_w not in ('S','N')) then
  ie_status_w := 'E';
  ds_erro_w := wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_TRANSPORTE'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
end if;

if (ie_status_w = 'OK') and (ie_situacao_w not in ('A','I')) then
  ie_status_w := 'E';
  ds_erro_w := wheb_mensagem_pck.get_texto(458683); /* Favor informar um valor válido para a situação da pessoa jurídica (A para ativo, I para inativo).*/
end if;

if (ie_status_w = 'OK') and (ie_empreendedor_individual_w not in ('S','N')) then
  ie_status_w := 'E';
  ds_erro_w := wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_EMPREENDEDOR_INDIVIDUAL'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
end if;

if (ie_status_w = 'OK') and (ie_tipo_trib_municipal_w not in ('I','N','U','S','SN')) then
  ie_status_w := 'E';
  ds_erro_w := wheb_mensagem_pck.get_texto(458686); /*Favor informar um valor válido para o campo IE_TIPO_TRIB_MUNICIPAL (I para Imune, N para Normal, S para Isenta, SN para Simples Nacional, U para Uniprofissional)*/
end if;

if (ie_status_w = 'OK') and (ie_tipo_tributacao_w not in ('0','1','2','20','3','5','6','7','8','9')) then
  ie_status_w := 'E';
  ds_erro_w := wheb_mensagem_pck.get_texto(458687);
  /*Favor informar um valor válido para o campo IE_TIPO_TRIBUTACAO (0 para Super Simples, 1 para Micro empresa, 2 para Pequeno porte, 20 para Isento, 3 para Imune, 5 para Lucro presumido, 6 para Normal, 7 para Simples, 8 para MEI.*/

end if;

if (ie_status_w = 'OK') then

  select count(*)
  into STRICT qt_registros_w
  from pessoa_juridica
  where cd_cgc = cd_cnpj_w;

  if (qt_registros_w = 0 ) then

    -- Verifica se há regra de pré cadastro para o tipo de pessoa juridica
    select coalesce(max(cd_tipo_pessoa),0)
      into STRICT cd_regra_w
      from ( SELECT cd_tipo_pessoa
               from regra_pre_cad_pj
              where cd_tipo_pessoa = cd_tipo_pessoa_w
                and ie_exige_aprov_cadastro = 'S'

union

             SELECT cd_tipo_pessoa
               from regra_pre_cad_pj
              where coalesce(cd_tipo_pessoa::text, '') = ''
                and ie_exige_aprov_cadastro = 'S' ) alias4;

    -- Se houver, insere na tabela PRE_PESSOA_JURIDICA
    if cd_regra_w <> 0 then
      begin
      insert into pre_pessoa_juridica(
        cd_ans,
        cd_cep,
        cd_cnes,
        cd_cgc,
        cd_cgc_mantenedora,
        cd_conta_contabil,
        cd_curp,
        cd_internacional,
        cd_municipio_ibge,
        cd_operadora_empresa,
        cd_pf_resp_tecnico,
        cd_rfc,
        cd_sistema_ant,
        cd_tipo_pessoa,
        ds_bairro,
        ds_complemento,
        ds_email,
        ds_endereco,
        ds_municipio,
        ds_nome_abrev,
        ds_observacao,
        ds_observacao_compl,
        ds_orgao_reg_resp_tecnico,
        ds_razao_social,
        ds_site_internet,
        dt_validade_alvara_munic,
        dt_validade_alvara_sanit,
        dt_validade_autor_func,
        dt_validade_cert_boas_prat,
        dt_validade_resp_tecnico,
        ie_empreendedor_individual,
        ie_fornecedor_opme,
        ie_prod_fabric,
        ie_qualidade,
        ie_situacao,
        ie_tipo_trib_municipal,
        ie_tipo_tributacao,
        ie_transporte,
        nm_fantasia,
        nr_alvara_sanitario,
        nr_alvara_sanitario_munic,
        nr_autor_func,
        nr_certificado_boas_prat,
        nr_ddd_fax,
        nr_ddd_telefone,
        nr_ddi_fax,
        nr_ddi_telefone,
        nr_endereco,
        nr_fax,
        nr_inscricao_estadual,
        nr_inscricao_municipal,
        nr_registro_pls,
        nr_registro_resp_tecnico,
        nr_seq_cnae,
        nr_seq_idioma,
        nr_seq_pais,
        nr_seq_regiao,
        nr_seq_tipo_logradouro,
        nr_telefone,
        sg_estado,
        nm_usuario,
        nm_usuario_nrec,
        dt_atualizacao,
        dt_atualizacao_nrec,
        nr_sequencia,
        nm_usuario_lib,
        dt_liberacao)
      values ( cd_ans_w,
        cd_cep_w,
        cd_cnes_w,
        cd_cnpj_w,
        cd_cnpj_mantenedora_w,
        cd_conta_contabil_w,
        cd_curp_w,
        cd_internacional_w,
        cd_municipio_ibge_w,
        cd_operadora_empresa_w,
        cd_pf_resp_tecnico_ww,
        cd_rfc_w,
        cd_sistema_ant_w,
        cd_tipo_pessoa_w,
        ds_bairro_w,
        ds_complemento_w,
        ds_email_w,
        ds_endereco_w,
        ds_municipio_w,
        ds_nome_abrev_w,
        ds_observacao_w,
        ds_observacao_compl_w,
        ds_orgao_reg_resp_tecnico_w,
        ds_razao_social_w,
        ds_site_internet_w,
        dt_validade_alvara_munic_w,
        dt_validade_alvara_sanit_w,
        dt_validade_autor_func_w,
        dt_validade_cert_boas_prat_w,
        dt_validade_resp_tecnico_w,
        ie_empreendedor_individual_w,
        ie_fornecedor_opme_w,
        ie_prod_fabric_w,
        ie_qualidade_w,
        ie_situacao_w,
        ie_tipo_trib_municipal_w,
        ie_tipo_tributacao_w,
        ie_transporte_w,
        nm_fantasia_w,
        nr_alvara_sanitario_w,
        nr_alvara_sanitario_munic_w,
        nr_autor_func_w,
        nr_certificado_boas_prat_w,
        nr_ddd_fax_w,
        nr_ddd_telefone_w,
        nr_ddi_fax_w,
        nr_ddi_telefone_w,
        nr_endereco_w,
        nr_fax_w,
        nr_inscricao_estadual_w,
        nr_inscricao_municipal_w,
        nr_registro_pls_w,
        nr_registro_resp_tecnico_w,
        nr_seq_cnae_w,
        nr_seq_idioma_w,
        nr_seq_pais_w,
        nr_seq_regiao_w,
        nr_seq_tipo_logradouro_w,
        nr_telefone_w,
        sg_estado_w,
        nm_usuario_p,
        nm_usuario_p,
        clock_timestamp(),
        clock_timestamp(),
        nextval('pre_pessoa_juridica_seq'),
        nm_usuario_p,
        clock_timestamp());
      exception
      when others then
        ie_status_w     := 'E';
        ds_erro_sqlerrm_w := substr(sqlerrm ,1,3000);
        ds_erro_w   := substr(wheb_mensagem_pck.get_texto(458624,'NM_TABELA_W='||'PRE_PESSOA_JURIDICA'||';DS_ERRO_W='||ds_erro_sqlerrm_w),1,4000);
        /*Ocorreu o seguinte erro ao gravar os dados na tabela #@NM_TABELA_W#@.Erro: #@DS_ERRO_W#@.*/

      end;

    else
      begin
      insert into pessoa_juridica(
        cd_ans,
        cd_cep,
        cd_cnes,
        cd_cgc,
        cd_cgc_mantenedora,
        cd_conta_contabil,
        cd_curp,
        cd_internacional,
        cd_municipio_ibge,
        cd_operadora_empresa,
        cd_pf_resp_tecnico,
        cd_rfc,
        cd_sistema_ant,
        cd_tipo_pessoa,
        ds_bairro,
        ds_complemento,
        ds_email,
        ds_endereco,
        ds_municipio,
        ds_nome_abrev,
        ds_observacao,
        ds_observacao_compl,
        ds_orgao_reg_resp_tecnico,
        ds_razao_social,
        ds_site_internet,
        dt_validade_alvara_munic,
        dt_validade_alvara_sanit,
        dt_validade_autor_func,
        dt_validade_cert_boas_prat,
        dt_validade_resp_tecnico,
        ie_empreendedor_individual,
        ie_fornecedor_opme,
        ie_prod_fabric,
        ie_qualidade,
        ie_situacao,
        ie_tipo_trib_municipal,
        ie_tipo_tributacao,
        ie_transporte,
        nm_fantasia,
        nr_alvara_sanitario,
        nr_alvara_sanitario_munic,
        nr_autor_func,
        nr_certificado_boas_prat,
        nr_ddd_fax,
        nr_ddd_telefone,
        nr_ddi_fax,
        nr_ddi_telefone,
        nr_endereco,
        nr_fax,
        nr_inscricao_estadual,
        nr_inscricao_municipal,
        nr_registro_pls,
        nr_registro_resp_tecnico,
        nr_seq_cnae,
        nr_seq_idioma,
        nr_seq_pais,
        nr_seq_regiao,
        nr_seq_tipo_logradouro,
        nr_telefone,
        sg_estado,
        nm_usuario,
        nm_usuario_nrec,
        dt_atualizacao,
        dt_atualizacao_nrec)
      values ( cd_ans_w,
        cd_cep_w,
        cd_cnes_w,
        cd_cnpj_w,
        cd_cnpj_mantenedora_w,
        cd_conta_contabil_w,
        cd_curp_w,
        cd_internacional_w,
        cd_municipio_ibge_w,
        cd_operadora_empresa_w,
        cd_pf_resp_tecnico_ww,
        cd_rfc_w,
        cd_sistema_ant_w,
        cd_tipo_pessoa_w,
        ds_bairro_w,
        ds_complemento_w,
        ds_email_w,
        ds_endereco_w,
        ds_municipio_w,
        ds_nome_abrev_w,
        ds_observacao_w,
        ds_observacao_compl_w,
        ds_orgao_reg_resp_tecnico_w,
        ds_razao_social_w,
        ds_site_internet_w,
        dt_validade_alvara_munic_w,
        dt_validade_alvara_sanit_w,
        dt_validade_autor_func_w,
        dt_validade_cert_boas_prat_w,
        dt_validade_resp_tecnico_w,
        ie_empreendedor_individual_w,
        ie_fornecedor_opme_w,
        ie_prod_fabric_w,
        ie_qualidade_w,
        ie_situacao_w,
        ie_tipo_trib_municipal_w,
        ie_tipo_tributacao_w,
        ie_transporte_w,
        nm_fantasia_w,
        nr_alvara_sanitario_w,
        nr_alvara_sanitario_munic_w,
        nr_autor_func_w,
        nr_certificado_boas_prat_w,
        nr_ddd_fax_w,
        nr_ddd_telefone_w,
        nr_ddi_fax_w,
        nr_ddi_telefone_w,
        nr_endereco_w,
        nr_fax_w,
        nr_inscricao_estadual_w,
        nr_inscricao_municipal_w,
        nr_registro_pls_w,
        nr_registro_resp_tecnico_w,
        nr_seq_cnae_w,
        nr_seq_idioma_w,
        nr_seq_pais_w,
        nr_seq_regiao_w,
        nr_seq_tipo_logradouro_w,
        nr_telefone_w,
        sg_estado_w,
        nm_usuario_p,
        nm_usuario_p,
        clock_timestamp(),
        clock_timestamp());
      exception
      when others then
        ie_status_w     := 'E';
        ds_erro_sqlerrm_w := substr(sqlerrm ,1,3000);
        ds_erro_w   := substr(wheb_mensagem_pck.get_texto(458624,'NM_TABELA_W='||'PESSOA_JURIDICA'||';DS_ERRO_W='||ds_erro_sqlerrm_w),1,4000);
        /*Ocorreu o seguinte erro ao gravar os dados na tabela #@NM_TABELA_W#@.Erro: #@DS_ERRO_W#@.*/

      end;
    end if;

  else
    begin
    update pessoa_juridica set
      cd_ans = cd_ans_w,
      cd_cep = cd_cep_w,
      cd_cnes = cd_cnes_w,
      cd_cgc = cd_cnpj_w,
      cd_cgc_mantenedora = cd_cnpj_mantenedora_w,
      cd_conta_contabil = cd_conta_contabil_w,
      cd_curp = cd_curp_w,
      cd_internacional = cd_internacional_w,
      cd_municipio_ibge = cd_municipio_ibge_w,
      cd_operadora_empresa = cd_operadora_empresa_w,
      cd_pf_resp_tecnico = cd_pf_resp_tecnico_ww,
      cd_rfc = cd_rfc_w,
      cd_sistema_ant = cd_sistema_ant_w,
      cd_tipo_pessoa = cd_tipo_pessoa_w,
      ds_bairro = ds_bairro_w,
      ds_complemento = ds_complemento_w,
      ds_email = ds_email_w,
      ds_endereco = ds_endereco_w,
      ds_municipio = ds_municipio_w,
      ds_nome_abrev = ds_nome_abrev_w,
      ds_observacao = ds_observacao_w,
      ds_observacao_compl = ds_observacao_compl_w,
      ds_orgao_reg_resp_tecnico = ds_orgao_reg_resp_tecnico_w,
      ds_razao_social = ds_razao_social_w,
      ds_site_internet = ds_site_internet_w,
      dt_validade_alvara_munic = dt_validade_alvara_munic_w,
      dt_validade_alvara_sanit = dt_validade_alvara_sanit_w,
      dt_validade_autor_func = dt_validade_autor_func_w,
      dt_validade_cert_boas_prat = dt_validade_cert_boas_prat_w,
      dt_validade_resp_tecnico = dt_validade_resp_tecnico_w,
      ie_empreendedor_individual = ie_empreendedor_individual_w,
      ie_fornecedor_opme = ie_fornecedor_opme_w,
      ie_prod_fabric = ie_prod_fabric,
      ie_qualidade = ie_qualidade_w,
      ie_situacao = ie_situacao_w,
      ie_tipo_trib_municipal = ie_tipo_trib_municipal_w,
      ie_tipo_tributacao = ie_tipo_tributacao_w,
      ie_transporte = ie_transporte_w,
      nm_fantasia = nm_fantasia_w,
      nr_alvara_sanitario = nr_alvara_sanitario_w,
      nr_alvara_sanitario_munic = nr_alvara_sanitario_munic_w,
      nr_autor_func = nr_autor_func_w,
      nr_certificado_boas_prat = nr_certificado_boas_prat_w,
      nr_ddd_fax = nr_ddd_fax_w,
      nr_ddd_telefone = nr_ddd_telefone_w,
      nr_ddi_fax = nr_ddi_fax_w,
      nr_ddi_telefone = nr_ddi_telefone_w,
      nr_endereco = nr_endereco_w,
      nr_fax = nr_fax_w,
      nr_inscricao_estadual = nr_inscricao_estadual_w,
      nr_inscricao_municipal = nr_inscricao_municipal_w,
      nr_registro_pls = nr_registro_pls_w,
      nr_registro_resp_tecnico = nr_registro_resp_tecnico_w,
      nr_seq_cnae = nr_seq_cnae_w,
      nr_seq_idioma = nr_seq_idioma_w,
      nr_seq_pais = nr_seq_pais_w,
      nr_seq_regiao = nr_seq_regiao_w,
      nr_seq_tipo_logradouro = nr_seq_tipo_logradouro_w,
      nr_telefone = nr_telefone_w,
      sg_estado = sg_estado_w,
      nm_usuario = nm_usuario_p,
      nm_usuario_nrec = nm_usuario_p,
      dt_atualizacao = clock_timestamp(),
      dt_atualizacao_nrec = clock_timestamp()
    where cd_cgc = cd_cnpj_w;
    exception
    when others then
      ie_status_w     := 'E';
      ds_erro_sqlerrm_w := substr(sqlerrm ,1,3000);
      ds_erro_w   := substr(wheb_mensagem_pck.get_texto(458690,'NM_TABELA_W='||'PESSOA_JURIDICA'||';DS_ERRO_W='||ds_erro_sqlerrm_w),1,4000);
      /*Ocorreu o seguinte erro ao atualizar os dados na tabela #@NM_TABELA_W#@.Erro: #@DS_ERRO_W#@.*/

    end;
  end if;
end if;

if (ie_status_w = 'OK') then

  open C01;
  loop
  fetch C01 into
    cd_estabelecimento_w,
    nm_pessoa_contato_w,
    nr_ramal_contato_w,
    ds_email_w,
    cd_cond_pagto_w,
    qt_dia_prazo_entrega_w,
    vl_minimo_nf_w,
    ie_qualidade_w,
    cd_referencia_fornec_w,
    ie_forma_pagto_w,
    ie_conta_dif_nf_w,
    cd_portador_w,
    cd_tipo_portador_w,
    cd_tipo_baixa_w,
    nr_codigo_serv_prest_w,
    tx_desc_antecipacao_w,
    ie_rateio_adiant_w,
    ie_retem_iss_w,
    tx_desc_ordem_w,
    ie_endereco_correspondencia_w,
    pr_desc_financeiro_w,
    cd_sistema_ant_estab_w,
    ie_frete_w,
    ie_exige_anexo_nf_w,
    ie_exige_ordem_compra_w,
    ie_baixa_abat_w,
    tx_desc_assiduidade_w,
    cd_operacao_nf_w,
    ie_consiste_nr_serie_nf_w,
    ie_status_apenado_w,
    ie_rec_email_comercial_w,
    ie_moeda_estrangeira_w;
  EXIT WHEN NOT FOUND; /* apply on C01 */

  if (ie_status_w = 'OK') and (cd_estabelecimento_w IS NOT NULL AND cd_estabelecimento_w::text <> '') then

    select  coalesce(somente_numero(bkf_obter_conv_interna('','ESTABELECIMENTO','CD_ESTABELECIMENTO',cd_estabelecimento_w,'BKF')),0)
    into STRICT  cd_retorno_de_para_w
;

    if (cd_retorno_de_para_w = 0) then
      ie_status_w := 'E';
      ds_erro_w := wheb_mensagem_pck.get_Texto(450150,'CD_ESTABELECIMENTO_W='||cd_estabelecimento_w);/*Não foi cadastrada a conversão para o estabelecimento código #@CD_ESTABELECIMENTO_W#@ que veio do sistema externo.*/
    else

      select  count(*)
      into STRICT  qt_registros_w
      from  estabelecimento
      where cd_estabelecimento = cd_retorno_de_para_w
      and ie_situacao = 'A';

      if (qt_registros_w = 0) then
        ie_status_w := 'E';
        ds_erro_w := wheb_mensagem_pck.get_texto(450159,'CD_ESTAB_TASY_W='|| cd_retorno_de_para_w ||';CD_ESTABELECIMENTO_W='|| cd_estabelecimento_w);
            /*Não existe no Tasy o estabelecimento com código  #@CD_ESTAB_TASY_W#@.Verifique o cadastro de conversão para o código do estabelecimento #@CD_ESTABELECIMENTO_W#@ que veio do sistema externo.*/

      else
        cd_estabelecimento_w := cd_retorno_de_para_w;
      end if;
    end if;
  elsif (ie_status_w = 'OK') and (coalesce(cd_estabelecimento_w::text, '') = '') then
    ie_status_w := 'E';
    ds_erro_w := wheb_mensagem_pck.get_texto(458563,'DS_CAMPO='||'CD_ESTABELECIMENTO'); /*O campo #@DS_CAMPO#@ deve ser preenchido.*/
  end if;

  if (ie_status_w = 'OK') and (ie_retem_iss_w not in ('N','X','S')) then
    ie_status_w := 'E';
    ds_erro_w := wheb_mensagem_pck.get_texto(458699); /* Favor informar um valor válido para o campo IE_RETEM_ISS (S para Sim, N para Não e X para Depende Nota).*/
  end if;

  if (ie_status_w = 'OK') and (ie_rateio_adiant_w not in ('P','R')) then
    ie_status_w := 'E';
    ds_erro_w := wheb_mensagem_pck.get_texto(458702); /*Favor informar um valor válido para o campo IE_RATEIO_ADIANT (P para Primeiro título, R para Ratear entre os títulos).*/
  end if;

  if (ie_status_w = 'OK') and (ie_moeda_estrangeira_w not in ('S','N')) then
    ie_status_w := 'E';
    ds_erro_w := wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_MOEDA_ESTRANGEIRA'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
  end if;

  if (ie_status_w = 'OK') and (ie_consiste_nr_serie_nf_w not in ('S','N','A','P')) then
    ie_status_w := 'E';
    ds_erro_w := wheb_mensagem_pck.get_texto(458708); /*'Favor informar um valor válido para o campo IE_CONSISTE_NR_SERIE_NF (S para Bloquear, N para Não bloquear, A para Somente avisar e P para Bloquear se mesmo ano).'*/
  end if;

  if (ie_status_w = 'OK') and (ie_exige_ordem_compra_w not in ('N','S')) then
    ie_status_w := 'E';
    ds_erro_w := wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_EXIGE_ORDEM_COMPRA'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
  end if;

  if (ie_status_w = 'OK') and (ie_conta_dif_nf_w not in ('S','N','A','E')) then
    ie_status_w := 'E';
    ds_erro_w := wheb_mensagem_pck.get_texto(458709);
    /*Favor informar um valor válido para o campo IE_CONTA_DIF_NF (N para Não considerar, S para Em todas NF, E para Somente NF entrada, A para Somente NF saída).*/

  end if;

  if (ie_status_w = 'OK') and (ie_status_apenado_w not in ('A','I','C','R')) then
    ie_status_w := 'E';
    ds_erro_w := wheb_mensagem_pck.get_texto(458710);/*Favor informar um valor válido para o campo IE_STATUS_APENADO (A para Ativo, I para Inativo, C para Restrito compras, R para Restrito compras e recebimento).*/
  end if;

  if (ie_status_w = 'OK') and (ie_forma_pagto_w not in ('BB', 'C','CA', 'CH', 'DCC','DDA','DOC','TB','TED')) then
    ie_status_w := 'E';
    ds_erro_w := wheb_mensagem_pck.get_texto(458711);
        /*Favor informar um valor válido para o campo IE_FORMA_PAGTO (BB para Bloqueto bancário, C para Carteira, CA para Cartão, CH para Cheque, DCC para Depósito em conta corrente, DDA para Débito direto automático, DOC para Documento de ordem de crédito, TB para Transferência bancária, TED para Transferência eletrônica disponível).*/

  end if;

  if (ie_status_w = 'OK') and (ie_frete_w not in ('C','F','N', 'T')) then
    ie_status_w := 'E';
    ds_erro_w := wheb_mensagem_pck.get_texto(458712);
        /*Favor informar um valor válido para o campo IE_FRETE (C para Frete por conta do Fornecedor, F para Frete por conta do Comprador, N para Sem frete, T para Frete por conta do Terceiro).*/

  end if;

  if (ie_status_w = 'OK') and (cd_cond_pagto_w IS NOT NULL AND cd_cond_pagto_w::text <> '') then

    select  coalesce(somente_numero(bkf_obter_conv_interna('','CONDICAO_PAGAMENTO','CD_CONDICAO_PAGAMENTO',cd_cond_pagto_w,'BKF')),0)
    into STRICT  cd_retorno_de_para_w
;

    if (cd_retorno_de_para_w = 0) then
      ie_status_w := 'E';
      ds_erro_w := wheb_mensagem_pck.get_Texto(449254,'CD_CONDICAO_PAGAMENTO_INT_W='||cd_cond_pagto_w);
        /*Não foi cadastrada a conversão para a condição de pagamento código #@CD_CONDICAO_PAGAMENTO_INT_W#@ que veio do sistema externo.*/

    else
      select  count(*)
      into STRICT  qt_registros_w
      from  condicao_pagamento
      where cd_condicao_pagamento    = cd_retorno_de_para_w;

      if (qt_registros_w = 0) then
        ie_status_w := 'E';
        ds_erro_w := wheb_mensagem_pck.get_texto(449255,'CD_CONDICAO_PAGAMENTO_TASY_W='|| cd_retorno_de_para_w ||';CD_CONDICAO_PAGAMENTO_INT_W='|| cd_cond_pagto_w);
            /*Não existe no Tasy a condição de pagamento com o código #@CD_CONDICAO_PAGAMENTO_TASY_W#@. Verifique o cadastro de conversão para o código da condição de pagamento #@CD_CONDICAO_PAGAMENTO_INT_W#@ que veio do sistema externo.*/

      else
        cd_cond_pagto_w := cd_retorno_de_para_w;
      end if;
    end if;
  end if;

  if (ie_status_w = 'OK') and (cd_operacao_nf_w IS NOT NULL AND cd_operacao_nf_w::text <> '') then

    select  coalesce(somente_numero(bkf_obter_conv_interna('','OPERACAO_NOTA','CD_OPERACAO_NF',cd_operacao_nf_w,'BKF')),0)
    into STRICT  cd_retorno_de_para_w
;

    if (cd_retorno_de_para_w = 0) then
      ie_status_w := 'E';
      ds_erro_w := wheb_mensagem_pck.get_Texto(452579,'DS_ATRIBUTO='||'OPERACAO NF'||';DS_VALOR_EXT='||cd_operacao_nf_w);
             /*Não foi cadastrada a conversão para o(a) #@DS_ATRIBUTO#@ o código #@DS_VALOR_EXT#@ que veio do sistema externo.*/

    else
      select  count(*)
      into STRICT  qt_registros_w
      from  operacao_nota
      where cd_operacao_nf = cd_retorno_de_para_w;

      if (qt_registros_w = 0) then
        ie_status_w := 'E';
        ds_erro_w := wheb_mensagem_pck.get_texto(449244,'CD_OPERACAO_NF_TASY_W='|| cd_retorno_de_para_w ||';CD_OPERACAO_NF_INT_W='|| cd_operacao_nf_w);
            /*Não existe no Tasy a operação da nota COM O CÓDIGO #@CD_OPERACAO_NF_TASY_W#@. Verifique o cadastro de conversão para o código da operação #@CD_OPERACAO_NF_INT_W#@ que veio do sistema externo.*/

      else
        cd_operacao_nf_w := cd_retorno_de_para_w;
      end if;
    end if;
  end if;

  if (ie_status_w = 'OK') and (ie_exige_anexo_nf_w not in ('N','S')) then
    ie_status_w := 'E';
    ds_erro_w := wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_EXIGE_ANEXO_NF'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
  end if;

  if (ie_status_w = 'OK') and (ie_baixa_abat_w not in ('N','S')) then
    ie_status_w := 'E';
    ds_erro_w := wheb_mensagem_pck.get_texto(458538,'DS_CAMPO=' || 'IE_BAIXA_ABAT'); /* Favor informar um valor válido para o campo #@DS_CAMPO#@ (S para Sim e N para Não)*/
  end if;


  if (ie_status_w = 'OK') then

    select  count(*)
    into STRICT  qt_registros_w
    from  pessoa_juridica_estab
    where   cd_cgc = cd_cnpj_w
    and cd_estabelecimento = cd_estabelecimento_w;

    if (qt_registros_w = 0) then

      -- Havendo regra de pré-cadastro, insere na tabela PRE_PESSOA_JURIDICA_ESTAB
      if cd_regra_w <> 0 then
        begin
        insert into pre_pessoa_juridica_estab(
          nr_sequencia,
          cd_cgc,
          ie_conta_dif_nf,
          cd_estabelecimento,
          cd_cond_pagto,
          cd_operacao_nf,
          cd_portador,
          cd_referencia_fornec,
          cd_sistema_ant,
          cd_tipo_baixa,
          cd_tipo_portador,
          ds_email,
          ie_baixa_abat,
          ie_consiste_nr_serie_nf,
          ie_endereco_correspondencia,
          ie_exige_anexo_nf,
          ie_exige_ordem_compra,
          ie_forma_pagto,
          ie_frete,
          ie_moeda_estrangeira,
          ie_qualidade,
          ie_rateio_adiant,
          ie_rec_email_comercial,
          ie_retem_iss,
          ie_status_apenado,
          nm_pessoa_contato,
          nr_codigo_serv_prest,
          nr_ramal_contato,
          pr_desc_financeiro,
          qt_dia_prazo_entrega,
          tx_desc_antecipacao,
          tx_desc_assiduidade,
          tx_desc_ordem,
          vl_minimo_nf,
          nm_usuario,
          nm_usuario_nrec,
          dt_atualizacao,
          dt_atualizacao_nrec,
          nr_seq_pre_pj)
        values (nextval('pre_pessoa_juridica_estab_seq'),
          cd_cnpj_w,
          ie_conta_dif_nf_w,
          cd_estabelecimento_w,
          cd_cond_pagto_w,
          cd_operacao_nf_w,
          cd_portador_w,
          cd_referencia_fornec_w,
          cd_sistema_ant_estab_w,
          cd_tipo_baixa_w,
          cd_tipo_portador_w,
          ds_email_estab_w,
          ie_baixa_abat_w,
          ie_consiste_nr_serie_nf_w,
          ie_endereco_correspondencia_w,
          ie_exige_anexo_nf_w,
          ie_exige_ordem_compra_w,
          ie_forma_pagto_w,
          ie_frete_w,
          ie_moeda_estrangeira_w,
          ie_qualidade_estab_w,
          ie_rateio_adiant_w,
          ie_rec_email_comercial_w,
          ie_retem_iss_w,
          ie_status_apenado_w,
          nm_pessoa_contato_w,
          nr_codigo_serv_prest_w,
          nr_ramal_contato_w,
          pr_desc_financeiro_w,
          qt_dia_prazo_entrega_w,
          tx_desc_antecipacao_w,
          tx_desc_assiduidade_w,
          tx_desc_ordem_w,
          vl_minimo_nf_w,
          nm_usuario_p,
          nm_usuario_p,
          clock_timestamp(),
          clock_timestamp(),
          currval('pre_pessoa_juridica_seq'));
        exception
        when others then
          ie_status_w     := 'E';
          ds_erro_sqlerrm_w := substr(sqlerrm ,1,3000);
          ds_erro_w   := substr(wheb_mensagem_pck.get_texto(458624,'NM_TABELA_W='||'PRE_PESSOA_JURIDICA_ESTAB'||';DS_ERRO_W='||ds_erro_sqlerrm_w),1,4000);
          /*Ocorreu o seguinte erro ao gravar os dados na tabela #@NM_TABELA_W#@.Erro: #@DS_ERRO_W#@.*/

        end;

      else
        begin
        insert into pessoa_juridica_estab(
          nr_sequencia,
          cd_cgc,
          ie_conta_dif_nf,
          cd_estabelecimento,
          cd_cond_pagto,
          cd_operacao_nf,
          cd_portador,
          cd_referencia_fornec,
          cd_sistema_ant,
          cd_tipo_baixa,
          cd_tipo_portador,
          ds_email,
          ie_baixa_abat,
          ie_consiste_nr_serie_nf,
          ie_endereco_correspondencia,
          ie_exige_anexo_nf,
          ie_exige_ordem_compra,
          ie_forma_pagto,
          ie_frete,
          ie_moeda_estrangeira,
          ie_qualidade,
          ie_rateio_adiant,
          ie_rec_email_comercial,
          ie_retem_iss,
          ie_status_apenado,
          nm_pessoa_contato,
          nr_codigo_serv_prest,
          nr_ramal_contato,
          pr_desc_financeiro,
          qt_dia_prazo_entrega,
          tx_desc_antecipacao,
          tx_desc_assiduidade,
          tx_desc_ordem,
          vl_minimo_nf,
          nm_usuario,
          nm_usuario_nrec,
          dt_atualizacao,
          dt_atualizacao_nrec)
        values (nextval('pessoa_juridica_estab_seq'),
          cd_cnpj_w,
          ie_conta_dif_nf_w,
          cd_estabelecimento_w,
          cd_cond_pagto_w,
          cd_operacao_nf_w,
          cd_portador_w,
          cd_referencia_fornec_w,
          cd_sistema_ant_estab_w,
          cd_tipo_baixa_w,
          cd_tipo_portador_w,
          ds_email_estab_w,
          ie_baixa_abat_w,
          ie_consiste_nr_serie_nf_w,
          ie_endereco_correspondencia_w,
          ie_exige_anexo_nf_w,
          ie_exige_ordem_compra_w,
          ie_forma_pagto_w,
          ie_frete_w,
          ie_moeda_estrangeira_w,
          ie_qualidade_estab_w,
          ie_rateio_adiant_w,
          ie_rec_email_comercial_w,
          ie_retem_iss_w,
          ie_status_apenado_w,
          nm_pessoa_contato_w,
          nr_codigo_serv_prest_w,
          nr_ramal_contato_w,
          pr_desc_financeiro_w,
          qt_dia_prazo_entrega_w,
          tx_desc_antecipacao_w,
          tx_desc_assiduidade_w,
          tx_desc_ordem_w,
          vl_minimo_nf_w,
          nm_usuario_p,
          nm_usuario_p,
          clock_timestamp(),
          clock_timestamp());
        exception
        when others then
          ie_status_w     := 'E';
          ds_erro_sqlerrm_w := substr(sqlerrm ,1,3000);
          ds_erro_w   := substr(wheb_mensagem_pck.get_texto(458624,'NM_TABELA_W='||'PESSOA_JURIDICA_ESTAB'||';DS_ERRO_W='||ds_erro_sqlerrm_w),1,4000);
          /*Ocorreu o seguinte erro ao gravar os dados na tabela #@NM_TABELA_W#@.Erro: #@DS_ERRO_W#@.*/

        end;
      end if;

    else
      begin
      update  pessoa_juridica_estab set
        cd_cgc = cd_cnpj_w,
        ie_conta_dif_nf = ie_conta_dif_nf_w,
        cd_estabelecimento = cd_estabelecimento_w,
        cd_cond_pagto = cd_cond_pagto_w,
        cd_operacao_nf = cd_operacao_nf_w,
        cd_portador = cd_portador_w,
        cd_referencia_fornec = cd_referencia_fornec_w,
        cd_sistema_ant = cd_sistema_ant_estab_w,
        cd_tipo_baixa = cd_tipo_baixa_w,
        cd_tipo_portador = cd_tipo_portador_w,
        ds_email = ds_email_estab_w,
        ie_baixa_abat = ie_baixa_abat_w,
        ie_consiste_nr_serie_nf = ie_consiste_nr_serie_nf_w,
        ie_endereco_correspondencia = ie_endereco_correspondencia_w,
        ie_exige_anexo_nf = ie_exige_anexo_nf_w,
        ie_exige_ordem_compra = ie_exige_ordem_compra_w,
        ie_forma_pagto = ie_forma_pagto_w,
        ie_frete = ie_frete_w,
        ie_moeda_estrangeira = ie_moeda_estrangeira_w,
        ie_qualidade = ie_qualidade_estab_w,
        ie_rateio_adiant = ie_rateio_adiant_w,
        ie_rec_email_comercial = ie_rec_email_comercial_w,
        ie_retem_iss = ie_retem_iss_w,
        ie_status_apenado = ie_status_apenado_w,
        nm_pessoa_contato = nm_pessoa_contato_w,
        nr_codigo_serv_prest = nr_codigo_serv_prest_w,
        nr_ramal_contato = nr_ramal_contato_w,
        pr_desc_financeiro = pr_desc_financeiro_w,
        qt_dia_prazo_entrega = qt_dia_prazo_entrega_w,
        tx_desc_antecipacao = tx_desc_antecipacao_w,
        tx_desc_assiduidade = tx_desc_assiduidade_w,
        tx_desc_ordem = tx_desc_ordem_w,
        vl_minimo_nf = vl_minimo_nf_w,
        nm_usuario = nm_usuario_p,
        nm_usuario_nrec = nm_usuario_p,
        dt_atualizacao = clock_timestamp(),
        dt_atualizacao_nrec = clock_timestamp()
      where   cd_cgc = cd_cnpj_w
      and cd_estabelecimento = cd_estabelecimento_w;
      exception
      when others then
        ie_status_w     := 'E';
        ds_erro_sqlerrm_w := substr(sqlerrm ,1,3000);
        ds_erro_w   := substr(wheb_mensagem_pck.get_texto(458690,'NM_TABELA_W='||'PESSOA_JURIDICA_ESTAB'||';DS_ERRO_W='||ds_erro_sqlerrm_w),1,4000);
        /*Ocorreu o seguinte erro ao atualizar os dados na tabela #@NM_TABELA_W#@.Erro: #@DS_ERRO_W#@.*/

      end;
    end if;
  end if;
  end loop;
  close C01;
end if;

if (ie_status_w = 'OK') then
  commit;
else
  rollback;
end if;

delete from w_int_pessoa_juridica
where nr_sequencia = nr_Sequencia_p;
commit;

ie_status_p   := ie_status_w;
ds_erro_p := ds_erro_w;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_int_pessoa_juridica ( nr_sequencia_p bigint, nm_usuario_p text, ie_status_p INOUT text, ds_erro_p INOUT text) FROM PUBLIC;

