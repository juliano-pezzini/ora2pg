-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_cardapio_nutricao (nr_seq_cardapio_p bigint, nr_seq_opcao_p bigint, ie_semana_p bigint, ie_dia_semana_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
nr_seq_cardapio_w	bigint;
nr_seq_comp_w		bigint;
nr_seq_receita_w	bigint;
dt_vigencia_inicial_w	timestamp;
dt_ini_destino_w		timestamp;
dt_fim_destino_w		timestamp;
qt_refeicao_w		bigint;
ie_dia_semana_w		smallint;

C01 CURSOR FOR
	SELECT	nr_seq_comp,
		nr_seq_receita,
		qt_refeicao
	from	nut_cardapio
	where	nr_seq_card_dia		= nr_seq_cardapio_p
	order by nr_seq_comp;

c02 CURSOR FOR
	SELECT	(vl_dominio)::numeric
	from	valor_dominio
	where	cd_dominio = 35
	and	((vl_dominio = ie_dia_semana_p) or (ie_dia_semana_p = 9))
	and	vl_dominio <> 9
	
union

	SELECT	ie_dia_semana
	from	nut_cardapio_dia
	where	nr_sequencia		= nr_seq_cardapio_p
	and	coalesce(ie_dia_semana_p::text, '') = '';


BEGIN

select	max(dt_vigencia_inicial)
into STRICT	dt_vigencia_inicial_w
from	nut_cardapio_dia
where	nr_sequencia = nr_seq_cardapio_p;

SELECT * FROM obter_dia_ini_fim_mes_vig(dt_vigencia_inicial_w, dt_ini_destino_w, dt_fim_destino_w) INTO STRICT dt_ini_destino_w, dt_fim_destino_w;

open C02;
loop
fetch C02 into
	ie_dia_semana_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin

	select	nextval('nut_cardapio_dia_seq')
	into STRICT	nr_sequencia_w
	;

	insert	into nut_cardapio_dia(nr_sequencia,
		cd_estabelecimento,
		dt_atualizacao,
		nm_usuario,
		nr_seq_servico,
		dt_cardapio,
		qt_pessoa_atend,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_opcao,
		ie_dia_semana,
		ie_semana,
		dt_vigencia_inicial,
		dt_vigencia_final,
		CD_DIETA,
		NR_SEQ_LOCAL,
		NR_SEQ_GRUPO_PRODUCAO)
	(SELECT	nr_sequencia_w,
		cd_estabelecimento,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_servico,
		dt_cardapio,
		qt_pessoa_atend,
		clock_timestamp(),
		nm_usuario_p,
		coalesce(nr_seq_opcao_p, nr_seq_opcao),
		ie_dia_semana_w,
		coalesce(ie_semana_p, ie_semana),
		dt_ini_destino_w,
		dt_fim_destino_w,
		CD_DIETA,
		NR_SEQ_LOCAL,
		NR_SEQ_GRUPO_PRODUCAO
	from	nut_cardapio_dia
	where	nr_sequencia		= nr_seq_cardapio_p);

	open C01;
	loop
	fetch C01 into
		nr_seq_comp_w,
		nr_seq_receita_w,
		qt_refeicao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		select	nextval('nut_cardapio_seq')
		into STRICT	nr_seq_cardapio_w
		;

		insert 	into nut_cardapio(nr_sequencia,
			nr_seq_card_dia,
			dt_atualizacao,
			nm_usuario,
			nr_seq_comp,
			nr_seq_receita,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			qt_refeicao)
		values (nr_seq_cardapio_w,
			nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_comp_w,
			nr_seq_receita_w,
			clock_timestamp(),
			nm_usuario_p,
			qt_refeicao_w);

		end;
	end loop;
	close C01;
	end;
end loop;
close C02;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_cardapio_nutricao (nr_seq_cardapio_p bigint, nr_seq_opcao_p bigint, ie_semana_p bigint, ie_dia_semana_p bigint, nm_usuario_p text) FROM PUBLIC;

