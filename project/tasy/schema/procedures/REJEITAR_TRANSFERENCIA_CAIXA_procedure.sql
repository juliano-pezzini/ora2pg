-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rejeitar_transferencia_caixa ( nr_seq_movto_trans_p bigint, ds_observacao_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_movto_trans_w	bigint;
nr_seq_movto_estorno_w	bigint;
cd_estabelecimento_w	smallint;
qt_movtos_transf_w		bigint;
nr_seq_saldo_caixa_w	bigint;
ie_posteriores_w		varchar(1);
qt_caixa_fechado_w	bigint;
ds_caixa_w		varchar(255);
dt_saldo_w		timestamp;
nr_caixa_saldo_w		bigint;

/* Transferência automática (bt direito "Gerar transferência saída") */

C01 CURSOR FOR
	SELECT	a.nr_sequencia,
		c.cd_estabelecimento
	from	caixa			c,
		caixa_saldo_diario	b,
		movto_trans_financ	a
	where	a.nr_seq_movto_transf	= nr_seq_movto_trans_p
	and	a.nr_seq_saldo_caixa	= b.nr_sequencia
	and	b.nr_seq_caixa		= c.nr_sequencia;


BEGIN

-- Não permitir que a transfrência seja rejeitada se o caixa origem estiver com o saldo fechado.
select	max(a.nr_seq_saldo_caixa)
into STRICT	nr_caixa_saldo_w
from	movto_trans_financ a
where	a.nr_sequencia	= nr_seq_movto_trans_p;

select	count(*)
into STRICT	qt_caixa_fechado_w
from	caixa_saldo_diario c,
	caixa b
where	c.nr_seq_caixa	= b.nr_sequencia
and	(c.dt_fechamento IS NOT NULL AND c.dt_fechamento::text <> '')
and	(c.nm_usuario_fechamento IS NOT NULL AND c.nm_usuario_fechamento::text <> '')
and	c.nr_sequencia	= nr_caixa_saldo_w;


if (qt_caixa_fechado_w > 0) then

	select	max(b.ds_caixa),
		max(c.dt_saldo)
	into STRICT	ds_caixa_w,
		dt_saldo_w
	from	caixa_saldo_diario c,
		caixa b
	where	c.nr_seq_caixa	= b.nr_sequencia
	and	(c.dt_fechamento IS NOT NULL AND c.dt_fechamento::text <> '')
	and	(c.nm_usuario_fechamento IS NOT NULL AND c.nm_usuario_fechamento::text <> '')
	and	c.nr_sequencia	= nr_caixa_saldo_w;


	CALL wheb_mensagem_pck.exibir_mensagem_abort(190828,'DS_CAIXA_W='||ds_caixa_w||';DT_SALDO_W='||dt_saldo_w);
end if;

select	count(*)
into STRICT	qt_movtos_transf_w
from	caixa c,
	caixa_saldo_diario b,
	movto_trans_financ a
where	a.nr_seq_movto_transf	= nr_seq_movto_trans_p
and	a.nr_seq_saldo_caixa	= b.nr_sequencia
and	b.nr_seq_caixa		= c.nr_sequencia;

if (qt_movtos_transf_w > 0) then	/* Se for transferência automática */
	open	C01;
	loop
	fetch	C01 into
		nr_seq_movto_trans_w,
		cd_estabelecimento_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */

		/* Marca o movimento que gerou a transferência como rejeitado, e desfaz o vínculo com a transferência */

		update	movto_trans_financ
		set	nr_seq_movto_transf	 = NULL,
			ie_rejeitado		= 'S',
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p,
			ds_observacao		= substr(ds_observacao_p,1,3999),
			dt_rejeicao		= clock_timestamp(),
			nm_usuario_rejeicao	= nm_usuario_p
		where	nr_sequencia		= nr_seq_movto_trans_w;

	end loop;
	close C01;
end if;

/* Estornar o movimento de transferência */

nr_seq_movto_estorno_w := ESTORNAR_MOVTO_TRANS_FINANC(nr_seq_movto_trans_p, nm_usuario_p, nr_seq_movto_estorno_w);

/* Marca o movimento como rejeitado e desfaz o vínculo com o caixa destino */

update	movto_trans_financ
set	nr_seq_caixa_od_rej	= nr_seq_caixa_od
where	nr_sequencia		= nr_seq_movto_trans_p;

update	movto_trans_financ
set	nr_seq_caixa_od		 = NULL,
	ie_rejeitado		= 'S',
	dt_atualizacao		= clock_timestamp(),
	nm_usuario		= nm_usuario_p,
	ds_observacao		= ds_observacao_p,
	dt_rejeicao		= clock_timestamp(),
	nm_usuario_rejeicao	= nm_usuario_p
where	nr_sequencia		= nr_seq_movto_trans_p;

/* Recalcular o saldo do caixa de origem da transferência */

select	max(c.cd_estabelecimento),
	max(b.nr_sequencia)
into STRICT	cd_estabelecimento_w,
	nr_seq_saldo_caixa_w
from	caixa c,
	caixa_saldo_diario b,
	movto_trans_financ a
where	a.nr_sequencia		= nr_seq_movto_trans_p
and	a.nr_seq_saldo_caixa	= b.nr_sequencia
and	b.nr_seq_caixa		= c.nr_sequencia;

ie_posteriores_w := obter_param_usuario(813, 11, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_posteriores_w);

CALL recalcular_caixa_saldo_diario(nr_seq_saldo_caixa_w,ie_posteriores_w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rejeitar_transferencia_caixa ( nr_seq_movto_trans_p bigint, ds_observacao_p text, nm_usuario_p text) FROM PUBLIC;

