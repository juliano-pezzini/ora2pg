-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_obs_oncologia ( nr_seq_paciente_p bigint, nm_usuario_p text ) AS $body$
DECLARE

    cd_grupo_material_w     bigint;
    cd_subgrupo_material_w  bigint;
    cd_classe_material_w    bigint;
    cd_material_w           bigint;
    ie_local_adm_w          varchar(10);
    qt_reg_w                bigint;
    ds_material_w           varchar(255);
    sql_w                   varchar(200);
    ds_material_aux_w       varchar(2000);
    c01 CURSOR FOR
    SELECT
        cd_material,
        ie_local_adm
    FROM
        paciente_protocolo_medic
    WHERE
            nr_seq_paciente = nr_seq_paciente_p
        AND coalesce(ds_observacao::text, '') = ''
        AND coalesce(nr_seq_diluicao::text, '') = ''
        AND coalesce(nr_seq_solucao::text, '') = ''
        AND coalesce(nr_seq_procedimento::text, '') = '';


BEGIN
    OPEN c01;
    LOOP
        FETCH c01 INTO
            cd_material_w,
            ie_local_adm_w;
        EXIT WHEN NOT FOUND; /* apply on c01 */
        BEGIN
            SELECT
                MAX(cd_grupo_material),
                MAX(cd_subgrupo_material),
                MAX(cd_classe_material)
            INTO STRICT
                cd_grupo_material_w,
                cd_subgrupo_material_w,
                cd_classe_material_w
            FROM
                estrutura_material_v
            WHERE
                cd_material = cd_material_w;

            SELECT
                COUNT(*)
            INTO STRICT qt_reg_w
            FROM
                regra_obs_oncologia
            WHERE
                    ie_local_adm = ie_local_adm_w
                AND coalesce(cd_material, cd_material_w) = cd_material_w
                AND coalesce(cd_grupo_material, cd_grupo_material_w) = cd_grupo_material_w
                AND coalesce(cd_subgrupo_material, cd_subgrupo_material_w) = cd_subgrupo_material_w
                AND coalesce(cd_classe_material, cd_classe_material_w) = cd_classe_material_w;

            IF ( qt_reg_w > 0 ) THEN
                BEGIN
                    ds_material_w := obter_desc_material(cd_material_w);
                    sql_w := 'CALL consiste_obs_oncologia_md(:1) INTO :ds_material_aux_w';
                    EXECUTE sql_w
                        USING IN ds_material_w, OUT ds_material_aux_w;
                EXCEPTION
                    WHEN OTHERS THEN
                        ds_material_aux_w := NULL;
                END;

                IF (ds_material_aux_w IS NOT NULL AND ds_material_aux_w::text <> '') THEN
                    CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_material_aux_w);
                END IF;
            END IF;
        END;
    END LOOP;

    CLOSE c01;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_obs_oncologia ( nr_seq_paciente_p bigint, nm_usuario_p text ) FROM PUBLIC;

