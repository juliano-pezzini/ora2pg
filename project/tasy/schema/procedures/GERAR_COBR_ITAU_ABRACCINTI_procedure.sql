-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cobr_itau_abraccinti ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
-- Cobrança Bancária Itaú 
-- Migração Unibanco/Itaú   Abraccinti 
					 
ds_conteudo_w		varchar(400);
nr_sequencial_w		bigint := 0;
vl_total_w		double precision := 0;

/* Header */
 
cd_cgc_w		varchar(10);
nm_empresa_w		varchar(30);
cd_banco_w		varchar(3);
nm_banco_w		varchar(15);
dt_gravacao_w		varchar(8);
hr_gravacao_w		varchar(6);

/* Registros */
 
nr_titulo_w		varchar(13);
dt_vencimento_w		varchar(6);
vl_documento_w		varchar(13);
dt_emissao_w		varchar(6);
ie_tipo_inscricao_w	varchar(2);
nr_inscricao_w		varchar(14);
nm_sacado_w		varchar(40);
ds_endereco_w		varchar(40);
ds_bairro_w		varchar(12);
cd_cep_w		varchar(8);	
ds_cidade_w		varchar(15);
ds_estado_w		varchar(2);

/* Brancos - Zeros */
					 
ds_brancos_10_w		varchar(10);
ds_zeros_8_w		varchar(8);
ds_zeros_5_w		varchar(5);
ds_brancos_267_w	varchar(267);
ds_brancos_63_w		varchar(63);
ds_brancos_43_w		varchar(43);
ds_brancos_8_w		varchar(8);
ds_brancos_62_w		varchar(62);
ds_brancos_27_w		varchar(27);
ds_brancos_69_w		varchar(69);
ds_brancos_16_w		varchar(16);
ds_brancos_6_w		varchar(6);
ds_brancos_374_w	varchar(374);
					
C01 CURSOR FOR 
	SELECT	lpad(coalesce(b.nr_titulo,'0'),13,'0') nr_documento, 
		to_char(coalesce(b.dt_pagamento_previsto, b.dt_vencimento),'ddmmyy') dt_vencimento, 
		replace(to_char(b.vl_titulo, 'fm00000000000.00'),'.','') vl_titulo, 
		to_char(b.dt_emissao,'ddmmyy') dt_emissao, 
		CASE WHEN coalesce(b.cd_cgc::text, '') = '' THEN '01'  ELSE '02' END  ie_tipo_inscricao, 
		lpad(coalesce(b.cd_cgc_cpf,'0'),14, '0') nr_inscricao, 
		rpad(upper(elimina_acentuacao(substr(b.nm_pessoa,1,40))),40, ' ') nm_sacado, 
		rpad(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'E')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'E') END ,1,40),40,' ') ds_endereco, 
		rpad(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'B')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'B') END ,1,12),12,' ') ds_bairro, 
		lpad(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CEP')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'CEP') END ,1,8),8,'0') cd_cep, 
		rpad(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CI')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'CI') END ,1,15),15,' ') ds_cidade, 
		coalesce(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'UF')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'UF') END ,1,2),' ') ds_estado 
	FROM banco_estabelecimento x, titulo_receber_cobr c, cobranca_escritural a, titulo_receber_v b
LEFT OUTER JOIN pls_mensalidade d ON (b.nr_seq_mensalidade = d.nr_sequencia)
LEFT OUTER JOIN banco_carteira e ON (b.nr_seq_carteira_cobr = e.nr_sequencia)
LEFT OUTER JOIN pls_contrato_pagador f ON (d.nr_seq_pagador = f.nr_sequencia)
WHERE a.nr_sequencia		= c.nr_seq_cobranca and c.nr_titulo		= b.nr_titulo and a.nr_seq_conta_banco	= x.nr_sequencia    and a.nr_sequencia		= nr_seq_cobr_escrit_p;					
					 

BEGIN 
delete from w_envio_banco where nm_usuario = nm_usuario_p;
 
/* Brancos - Zeros */
 
select	rpad(' ',10,' '), 
	rpad('0',8,'0'), 
	rpad('0',5,'0'), 
	rpad(' ',267,' '), 
	rpad(' ',63,' '), 
	rpad(' ',43,' '), 
	rpad(' ',8,' '), 
	rpad(' ',62,' '), 
	rpad(' ',27,' '), 
	rpad(' ',69,' '), 
	rpad(' ',16,' '), 
	rpad(' ',6,' '), 
	rpad(' ',374,' ') 
into STRICT	ds_brancos_10_w, 
	ds_zeros_8_w, 
	ds_zeros_5_w, 
	ds_brancos_267_w, 
	ds_brancos_63_w, 
	ds_brancos_43_w, 
	ds_brancos_8_w, 
	ds_brancos_62_w, 
	ds_brancos_27_w, 
	ds_brancos_69_w, 
	ds_brancos_16_w, 
	ds_brancos_6_w, 
	ds_brancos_374_w
;
 
/* Header */
 
select	lpad(substr(b.cd_cgc,1,10),10,'0') cd_cgc, 
	rpad(upper(elimina_acentuacao(substr(obter_nome_pf_pj(null, b.cd_cgc),1,30))),30, ' ') nm_empresa, 
	lpad(substr(c.cd_banco,1,3),3,'0') cd_banco, 
	rpad(upper(elimina_acentuacao(substr(Obter_Nome_Banco(c.cd_banco),1,15))),15, ' ') nm_banco, 
	to_char(clock_timestamp(),'ddmmyyyy') dt_gravacao, 
	to_char(clock_timestamp(),'hhmiss') hr_gravacao 
into STRICT	cd_cgc_w, 
	nm_empresa_w, 
	cd_banco_w, 
	nm_banco_w, 
	dt_gravacao_w, 
	hr_gravacao_w 
from	estabelecimento		b, 
	cobranca_escritural	a, 
	banco_estabelecimento	c 
where	a.cd_estabelecimento	= b.cd_estabelecimento 
and	a.nr_seq_conta_banco	= c.nr_sequencia 
and	a.nr_sequencia		= nr_seq_cobr_escrit_p;
 
nr_sequencial_w	:=	nr_sequencial_w + 1;
 
ds_conteudo_w	:=	'01REMESSA01COBRANCA    ' || cd_cgc_w || ds_brancos_10_w || nm_empresa_w || cd_banco_w || nm_banco_w || dt_gravacao_w || 
			ds_zeros_8_w || hr_gravacao_w || ds_zeros_5_w || ' ' || ds_zeros_5_w || ds_brancos_267_w || lpad(nr_sequencial_w,6,'0');
			 
insert into w_envio_banco(nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	cd_estabelecimento, 
	ds_conteudo, 
	nr_seq_apres, 
	nr_seq_apres_2) 
values (nextval('w_envio_banco_seq'), 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	cd_estabelecimento_p, 
	ds_conteudo_w, 
	nr_sequencial_w, 
	0);
			 
/* Registros */
 
open C01;
loop 
fetch C01 into	 
	nr_titulo_w, 
	dt_vencimento_w, 
	vl_documento_w, 
	dt_emissao_w, 
	ie_tipo_inscricao_w, 
	nr_inscricao_w, 
	nm_sacado_w, 
	ds_endereco_w, 
	ds_bairro_w, 
	cd_cep_w, 
	ds_cidade_w, 
	ds_estado_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	/* Registro - Detalhe */
 
	nr_sequencial_w	:=	nr_sequencial_w + 1;
	 
	ds_conteudo_w	:=	'1' || ds_brancos_63_w || nr_titulo_w || ds_brancos_43_w || dt_vencimento_w || vl_documento_w || cd_banco_w || 
				ds_brancos_8_w || dt_emissao_w || ds_brancos_62_w || ie_tipo_inscricao_w || nr_inscricao_w || nm_sacado_w || 
				ds_endereco_w || ds_bairro_w || cd_cep_w || ds_cidade_w || ds_estado_w || ds_brancos_43_w || 
				lpad(nr_sequencial_w,6,'0');
				 
	vl_total_w	:=	vl_total_w + vl_documento_w;
		 
	insert into w_envio_banco(nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		cd_estabelecimento, 
		ds_conteudo, 
		nr_seq_apres, 
		nr_seq_apres_2) 
	values (nextval('w_envio_banco_seq'), 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_estabelecimento_p, 
		ds_conteudo_w, 
		nr_sequencial_w, 
		nr_sequencial_w);
		 
	/* Registro - Utilização */
 
	nr_sequencial_w	:=	nr_sequencial_w + 1;
	 
	ds_conteudo_w	:=	'7' || ds_brancos_27_w || ds_brancos_69_w || '0' || ds_brancos_69_w || '0' || ds_brancos_69_w || '0' || 
				ds_brancos_69_w || '0' || ds_brancos_69_w || '0' || ds_brancos_16_w || lpad(nr_sequencial_w,6,'0');
		 
	insert into w_envio_banco(nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		cd_estabelecimento, 
		ds_conteudo, 
		nr_seq_apres, 
		nr_seq_apres_2) 
	values (nextval('w_envio_banco_seq'), 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_estabelecimento_p, 
		ds_conteudo_w, 
		nr_sequencial_w, 
		nr_sequencial_w);		
	end;
end loop;
close C01;
 
/* Trailler */
 
nr_sequencial_w	:=	nr_sequencial_w + 1;
 
ds_conteudo_w	:=	'9' || ds_brancos_6_w || lpad(vl_total_w,13,'0') || ds_brancos_374_w || lpad(nr_sequencial_w,6,'0');
 
insert into w_envio_banco(nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	cd_estabelecimento, 
	ds_conteudo, 
	nr_seq_apres, 
	nr_seq_apres_2) 
values (nextval('w_envio_banco_seq'), 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	cd_estabelecimento_p, 
	ds_conteudo_w, 
	nr_sequencial_w, 
	nr_sequencial_w);
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cobr_itau_abraccinti ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

