-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consistir_protocolo_reemb ( nr_seq_protocolo_p bigint, dt_protocolo_p timestamp, dt_mes_competencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text ) AS $body$
DECLARE


dt_mes_competencia_w	timestamp;
dt_protocolo_w		timestamp;
ie_param_mes_w		varchar(2);
dt_ref_inicial_w		timestamp;
dt_ref_final_w		timestamp;
ds_tipo_lote_contabil_w	tipo_lote_contabil.ds_tipo_lote_contabil%type;


BEGIN
if (coalesce(nr_seq_protocolo_p,0) > 0) then
	select	trunc(dt_mes_competencia, 'month'),
		trunc(dt_protocolo, 'month')
	into STRICT	dt_mes_competencia_w,
		dt_protocolo_w
	from	pls_protocolo_conta
	where	nr_sequencia = nr_seq_protocolo_p;
else	
	dt_mes_competencia_w	:= trunc(dt_mes_competencia_p, 'month');
	dt_protocolo_w 		:= trunc(dt_protocolo_p, 'month');
end if;

ie_param_mes_w := obter_valor_param_usuario(1229, 20, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_p);

if (coalesce(ie_param_mes_w,'N') = 'S') then
	if (dt_protocolo_w <> dt_mes_competencia_w) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort( 267022, null); /* The dates from the reference month and protocol aren't within the same month. 
									(Parameter [20] - Require the protocol date and the reference date to be within the same month) */
	end if;
end if;

if (dt_protocolo_w	> dt_mes_competencia_w) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(345369,null); /* The date/month of the protocol is bigger than the competency date of the protocol!*/
end if;

/* Check if there already is an accounting batch of the type HPMS - Expense - Reimbursement for the actual month of competency */

dt_ref_inicial_w	:= trunc(trunc(dt_mes_competencia_p,'month'),'dd');
dt_ref_final_w		:= fim_dia(fim_mes(dt_ref_inicial_w));

select	max(b.ds_tipo_lote_contabil)
into STRICT	ds_tipo_lote_contabil_w
from	lote_contabil		a,
	tipo_lote_contabil	b
where	a.cd_tipo_lote_contabil	= b.cd_tipo_lote_contabil
and	b.cd_tipo_lote_contabil	= 23 -- HPMS - Expenses - Reimbursement
and	a.dt_referencia between dt_ref_inicial_w and dt_ref_final_w
and	coalesce(a.cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p
and	(a.dt_geracao_lote IS NOT NULL AND a.dt_geracao_lote::text <> '');

if (ds_tipo_lote_contabil_w IS NOT NULL AND ds_tipo_lote_contabil_w::text <> '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(345368, 'DS_TIPO_LOTE_CONTABIL=' || ds_tipo_lote_contabil_w || ';' || 'DT_REFERENCIA=' || to_char(dt_mes_competencia_p,'mm/yyyy'));
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consistir_protocolo_reemb ( nr_seq_protocolo_p bigint, dt_protocolo_p timestamp, dt_mes_competencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text ) FROM PUBLIC;

