-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_evolucao_sintomapa ( nr_atendimento_p bigint, nm_usuario_p text, ds_evolucao_p text, cd_pessoa_fisica_p text, cd_medico_p text, cd_especial_medico_p bigint) AS $body$
DECLARE

 
ie_tipo_evolucao_w	  varchar(3);
cd_evolucao_w			bigint;
ie_situacao_w			varchar(1);
ie_relev_resumo_alta_w varchar(1);


BEGIN 
 
select	coalesce(max(ie_situacao),'I') 
into STRICT	ie_situacao_w 
from 	tipo_evolucao 
where  cd_tipo_evolucao = 'SPA';
 
if (ie_situacao_w = 'A') then 
 
	ie_tipo_evolucao_w 	:= Obter_Dados_Usuario_Opcao(nm_usuario_p,'F');
 
	select	nextval('evolucao_paciente_seq') 
	into STRICT	cd_evolucao_w 
	;
	 
	select	coalesce(max(ie_relev_resumo_alta),'N') 
	into STRICT	ie_relev_resumo_alta_w 
	from	tipo_evolucao 
	where  cd_tipo_evolucao = 'SPA';
 
	insert into 	evolucao_paciente(cd_evolucao, 
			 dt_evolucao, 
			 ie_tipo_evolucao,		 
			 cd_pessoa_fisica, 
			 nr_atendimento,				 
			 ie_situacao, 
			 dt_atualizacao, 
			 nm_usuario, 
			 ds_evolucao, 
			 cd_medico, 
			 cd_especialidade_medico, 
			 dt_liberacao, 
			 ie_evolucao_clinica, 
			 ie_relev_resumo_alta) 
	values ( 
			 cd_evolucao_w, 
			 clock_timestamp(), 
			 ie_tipo_evolucao_w,		 
			 cd_pessoa_fisica_p, 
			 nr_atendimento_p,		 
			 'A', 
			 clock_timestamp(), 
			 nm_usuario_p, 
			 ds_evolucao_p, 
			 cd_medico_p, 
			 cd_especial_medico_p, 
			 clock_timestamp(), 
			 'SPA', 
			 ie_relev_resumo_alta_w);
 
	commit;
	 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_evolucao_sintomapa ( nr_atendimento_p bigint, nm_usuario_p text, ds_evolucao_p text, cd_pessoa_fisica_p text, cd_medico_p text, cd_especial_medico_p bigint) FROM PUBLIC;

