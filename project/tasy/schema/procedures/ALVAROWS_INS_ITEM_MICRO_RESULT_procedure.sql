-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alvarows_ins_item_micro_result ( nr_controle_int_lab_p bigint, cd_analito_p text, cd_exame_p text, NM_MICROORGANISMO_P text, qt_microorganismo_p text, nm_medicamento_p text, ds_resultado_p text, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE



nr_seq_exame_w		exame_laboratorio.nr_seq_exame%type;
nr_seq_prescr_w		prescr_procedimento.nr_sequencia%type;
cd_microorganismo_w	CIH_MICROORGANISMO.cd_microorganismo%type;
cd_medicamento_w	CIH_MEDICAMENTO.cd_medicamento%type;						
ie_result_w			varchar(8);
cd_analito_w		varchar(20);
nr_prescricao_w		prescr_procedimento.nr_prescricao%type;
nr_seq_resultado_w  exame_lab_resultado.nr_seq_resultado%type;


BEGIN
--obter a sequência da prescrição e nr. sequência do exame
select 	MAX(a.nr_sequencia),
	MAX(a.nr_seq_exame),
	max(a.nr_prescricao)
into STRICT	nr_seq_prescr_w,
	nr_seq_exame_w,
	nr_prescricao_w
from 	prescr_procedimento a,
	exame_laboratorio b,
	prescr_medica c
where	c.nr_controle_int_lab = nr_controle_int_lab_p
and	a.nr_prescricao = c.nr_prescricao
and	a.nr_seq_exame = b.nr_seq_exame
and coalesce(coalesce(Obter_Equipamento_Exame(b.nr_seq_exame,null,'ALVARO'),b.cd_exame_integracao),b.cd_exame)= cd_exame_p;

--resultado
select 	upper(substr(ds_resultado_p,1,1))
into STRICT 	ie_result_w
;


if (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') then

select nr_seq_resultado
into STRICT nr_seq_resultado_w 
from exame_lab_resultado 
where nr_prescricao = nr_prescricao_w;


update exame_lab_result_item
set ds_observacao = ds_observacao || chr(10) || 'Antibiótico: ' || nm_medicamento_p || ' Resistência: ' || ds_resultado_p
where nr_seq_exame = nr_seq_exame_w
and nr_seq_prescr = nr_seq_prescr_w
and nr_seq_resultado = nr_seq_resultado_w;

else
	ds_erro_p := WHEB_MENSAGEM_PCK.get_texto(277362,'CD_DOENCA='||cd_analito_p||';NR_PRESCRICAO='||nr_prescricao_w);
end if;

commit;

end;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alvarows_ins_item_micro_result ( nr_controle_int_lab_p bigint, cd_analito_p text, cd_exame_p text, NM_MICROORGANISMO_P text, qt_microorganismo_p text, nm_medicamento_p text, ds_resultado_p text, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

