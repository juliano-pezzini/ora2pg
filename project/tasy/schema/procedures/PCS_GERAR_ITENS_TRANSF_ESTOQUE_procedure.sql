-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pcs_gerar_itens_transf_estoque ( nr_seq_registro_p bigint, cd_local_estoque_p bigint, cd_local_estoque_solicitante_p bigint, cd_material_p bigint, cd_condicao_pagto_p bigint, cd_comprador_p text, qt_material_p bigint, cd_estab_solicitado_p bigint, cd_estab_solicitante_p bigint, nm_usuario_p text, nr_ordem_compra_p INOUT bigint) AS $body$
DECLARE


cd_estabelecimento_w		smallint;
cd_material_w			bigint;
qt_minimo_w			double precision	:= 0;
qt_maximo_w			double precision	:= 0;
cd_unidade_medida_estoque_w	varchar(30)  	:= '';
qt_estoque_w           		double precision 	:= 0;
qt_item_w	           		double precision 	:= 0;
nr_item_oci_w			integer 	:= 0;
dt_entrega_w			timestamp;
qt_pendentes_transf_w		double precision;


nr_ordem_compra_w		bigint;
cd_condicao_pagamento_w bigint;
cd_comprador_w			varchar(10);
cd_moeda_w				integer;
cd_pessoa_solicitante_w	varchar(10);
ie_gerou_w				varchar(1);
qt_existe_w			smallint;
cd_cgc_solicitado_w		varchar(14);

c01 CURSOR FOR
SELECT	c.cd_material,
		substr(obter_dados_material_estab(c.cd_material,cd_estab_solicitante_p,'UME'),1,30) cd_unidade_medida_estoque
from	material c
where (c.cd_material 			= coalesce(cd_material_p, c.cd_material))
and (c.ie_situacao			= 'A')
order by c.cd_material;


BEGIN
ie_gerou_w	:= 'N';

/*select	max(cd_estabelecimento)
into	cd_estabelecimento_w
from 	local_estoque
where	cd_local_estoque = cd_local_estoque_p;*/
begin
select	a.cd_pessoa_fisica
into STRICT	cd_pessoa_solicitante_w
from	usuario a
where	a.nm_usuario_pesquisa = upper(nm_usuario_p);
exception
when others then
	cd_pessoa_solicitante_w	:= null;
end;

select cd_cgc
into STRICT cd_cgc_solicitado_w
from estabelecimento
where cd_estabelecimento = cd_estab_solicitado_p;

open C01;
loop
fetch C01 into
	cd_material_w,
	cd_unidade_medida_estoque_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (ie_gerou_w = 'N') then
		begin
		if (coalesce(nr_ordem_compra_p, 0) > 0) then
			nr_ordem_compra_w	:= nr_ordem_compra_p;

		end if;

		if (coalesce(nr_ordem_compra_p, 0) = 0) then

			select	nextval('ordem_compra_seq')
			into STRICT	nr_ordem_compra_w
			;

					insert into ordem_compra(
					nr_ordem_compra,
					cd_estabelecimento,
					cd_estab_transf,
					cd_condicao_pagamento,
					cd_comprador,
					dt_ordem_compra,
					dt_atualizacao,
					nm_usuario,
					cd_moeda,
					ie_situacao,
					dt_inclusao,
					cd_pessoa_solicitante,
					ie_frete,
					dt_entrega,
					ie_aviso_chegada,
					ie_emite_obs,
					ie_urgente,
					ie_tipo_ordem,
					--cd_pessoa_fisica,
					cd_local_transf,
					cd_cgc_fornecedor,
					cd_local_entrega)
			values (	nr_ordem_compra_w,
					cd_estab_solicitante_p,
					cd_estab_solicitado_p,
					cd_condicao_pagto_p,
					cd_comprador_p,
					clock_timestamp(),
					clock_timestamp(),
					nm_usuario_p,
					1,
					'A',
					clock_timestamp(),
					cd_pessoa_solicitante_w,
					'C',
					clock_timestamp() + interval '7 days',
					'N',
					'N',
					'N',
					'Z',
					--cd_pessoa_solicitante_w,
					cd_local_estoque_p,
					cd_cgc_solicitado_w,
					cd_local_estoque_solicitante_p);


		end if;
		ie_gerou_w	:= 'S';

		end;
	end if;

	select 	count(*)
	into STRICT	qt_existe_w
	from	ordem_compra_item
	where	nr_ordem_compra = nr_ordem_compra_w
	and	cd_material = cd_material_w
	and	cd_local_estoque = cd_local_estoque_p;

	if (qt_existe_w > 0) then
		begin
		select max(nr_item_oci)
		into STRICT	nr_item_oci_w
		from	ordem_compra_item
		where	nr_ordem_compra = nr_ordem_compra_w
		and	cd_material = cd_material_w
		and	cd_local_estoque = cd_local_estoque_p;

		update	ordem_compra_item
		set	qt_material = qt_material_p,
			cd_unidade_medida_compra = cd_unidade_medida_estoque_w,
			nm_usuario = nm_usuario_p,
			dt_atualizacao = clock_timestamp(),
			vl_total_item = round(( qt_material_p * vl_unitario_material)::numeric,4)
		where	nr_ordem_compra = nr_ordem_compra_w
		and	nr_item_oci = nr_item_oci_w;
		end;
	else
		begin

		select coalesce(max(nr_item_oci),0)
		into STRICT	nr_item_oci_w
		from	ordem_compra_item
		where	nr_ordem_compra = nr_ordem_compra_w;

		nr_item_oci_w := nr_item_oci_w + 1;

		insert into ordem_compra_item(
			nr_ordem_compra,
			nr_item_oci,
			cd_material,
			qt_material,
			qt_original,
			dt_atualizacao,
			nm_usuario,
			cd_unidade_medida_compra,
			ie_situacao,
			nr_seq_reg_pcs,
			cd_local_estoque)
		values (
			nr_ordem_compra_w,
			nr_item_oci_w,
			cd_material_w,
			qt_material_p,
			qt_material_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_unidade_medida_estoque_w,
			'A',
			nr_seq_registro_p,
			cd_local_estoque_solicitante_p);

		update	pcs_reg_analise_itens
		set		nr_ordem_compra = nr_ordem_compra_w
		where	nr_seq_registro = nr_seq_registro
		and		cd_material = cd_material_w;

		insert into ordem_compra_item_entrega(
			nr_ordem_compra,
			nr_item_oci,
			dt_prevista_entrega,
			qt_prevista_entrega,
			dt_atualizacao,
			nm_usuario,
			nr_sequencia)
		values (
			nr_ordem_compra_w,
			nr_item_oci_w,
			clock_timestamp() + interval '7 days',
			qt_material_p,
			clock_timestamp(),
			nm_usuario_p,
			nextval('ordem_compra_item_entrega_seq'));
		end;
	end if;
	end;
end loop;
close C01;

commit;

nr_ordem_compra_p := coalesce(nr_ordem_compra_w,0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pcs_gerar_itens_transf_estoque ( nr_seq_registro_p bigint, cd_local_estoque_p bigint, cd_local_estoque_solicitante_p bigint, cd_material_p bigint, cd_condicao_pagto_p bigint, cd_comprador_p text, qt_material_p bigint, cd_estab_solicitado_p bigint, cd_estab_solicitante_p bigint, nm_usuario_p text, nr_ordem_compra_p INOUT bigint) FROM PUBLIC;

