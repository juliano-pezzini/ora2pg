-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_proc_tuss ( cd_procedimento_p bigint, nm_usuario_p text, ie_opcao_p text, ie_classif_p text, ds_tuss_p text, nr_seq_tuss_serv_p bigint default null, qt_inativados_p INOUT bigint DEFAULT NULL) AS $body$
DECLARE



qt_reg_ativos_w		bigint;


BEGIN

if (ie_opcao_p = 'I') then

	if (ie_classif_p = '2') then
		select	count(*)
		into STRICT	qt_reg_ativos_w
		from 	procedimento
		where 	ie_origem_proced = 8
		and  	ie_situacao = 'A'
		and 	ie_classificacao in ('2','3');

		update	procedimento
		set 	ie_situacao = 'I',
			nr_seq_tuss_serv = coalesce(nr_seq_tuss_serv_p, nr_seq_tuss_serv),
			nm_usuario = nm_usuario_p,
			dt_atualizacao = clock_timestamp()
		where 	ie_origem_proced = 8
		and 	ie_situacao = 'A'
		and 	ie_classificacao in ('2','3');
	else
		select	count(*)
		into STRICT	qt_reg_ativos_w
		from 	procedimento
		where 	ie_origem_proced = 8
		and  	ie_situacao = 'A'
		and 	ie_classificacao = '1';

		update	procedimento
		set 	ie_situacao = 'I',
			nr_seq_tuss_serv = coalesce(nr_seq_tuss_serv_p, nr_seq_tuss_serv),
			nm_usuario = nm_usuario_p,
			dt_atualizacao = clock_timestamp()
		where 	ie_origem_proced = 8
		and 	ie_situacao = 'A'
		and 	ie_classificacao = '1';
	end if;

	qt_inativados_p:= qt_reg_ativos_w;

elsif (ie_opcao_p = 'A') then

	if (ie_classif_p = '2') then
		update	procedimento
		set 	ie_situacao = 'A',
			ds_procedimento = ds_tuss_p,
			nr_seq_tuss_serv = coalesce(nr_seq_tuss_serv_p, nr_seq_tuss_serv),
			nm_usuario = nm_usuario_p,
			dt_atualizacao = clock_timestamp()
		where 	ie_situacao = 'I'
		and 	cd_procedimento = cd_procedimento_p
		and 	ie_origem_proced = 8
		and 	ie_classificacao in ('2','3');
	else
		update	procedimento
		set 	ie_situacao = 'A',
			ds_procedimento = ds_tuss_p,
			nr_seq_tuss_serv = coalesce(nr_seq_tuss_serv_p, nr_seq_tuss_serv),
			nm_usuario = nm_usuario_p,
			dt_atualizacao = clock_timestamp()
		where 	ie_situacao = 'I'
		and 	cd_procedimento = cd_procedimento_p
		and 	ie_origem_proced = 8
		and 	ie_classificacao = '1';
	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_proc_tuss ( cd_procedimento_p bigint, nm_usuario_p text, ie_opcao_p text, ie_classif_p text, ds_tuss_p text, nr_seq_tuss_serv_p bigint default null, qt_inativados_p INOUT bigint DEFAULT NULL) FROM PUBLIC;

