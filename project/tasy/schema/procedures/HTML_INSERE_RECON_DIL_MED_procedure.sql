-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE html_insere_recon_dil_med (( nr_prescricao_p prescr_medica.nr_prescricao%type, nr_seq_cpoe_p cpoe_material.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_perfil_p perfil.cd_perfil%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_opcao_gerar_p text, ie_reg_alt_farm_p text) is type tcursor REFCURSOR) RETURNS bigint AS $body$
DECLARE

					
	ds_dose_dif_aux_w	varchar(4000) := ds_dose_diferenciada_p;
	qt_total_w			double precision := 0;
	i					integer;
	
BEGIN
	if (ds_dose_dif_aux_w IS NOT NULL AND ds_dose_dif_aux_w::text <> '') then
		 if (substr(ds_dose_dif_aux_w,length(ds_dose_dif_aux_w)-1) <> '-') then
			ds_dose_dif_aux_w	:= ds_dose_dif_aux_w || '-';
		 end if;
		
		 while(ds_dose_dif_aux_w IS NOT NULL AND ds_dose_dif_aux_w::text <> '') loop 
			begin
				i					:= position('-' in ds_dose_dif_aux_w);
				qt_total_w			:= qt_total_w + coalesce((substr(ds_dose_dif_aux_w,1,i-1))::numeric ,0);
				ds_dose_dif_aux_w	:= substr(ds_dose_dif_aux_w,i+1);
			exception when others then
				qt_total_w			:= 0;
				ds_dose_dif_aux_w	:= '';
			end;
		 end loop;
	end if;

	return qt_total_w;
	end;

	procedure gerar_item_medicacao(	cd_material_p				number,
									cd_unidade_medida_dose_p	varchar2,
									qt_dose_p					number,
									ds_dose_diferenciada_p		varchar2,
									qt_solucao_p				number,
									ie_agrupador_p				number,
									nr_seq_diluicao_p			number,
									ie_checar_adep_p			char,
									nr_prescricao_orig_p		number ,
									nr_sequencia_orig_p			number ,
									ie_item_superior_p			varchar2 default 'N') is
	ds_erro_ww					varchar2(2000);
	ds_dose_diferenciada_aux_w	varchar2(4000);
	nr_posicao_w				integer;
	qt_dose_medic_w				prescr_material.qt_dose%type;
	begin
	
	ds_dose_diferenciada_aux_w	:= replace(ds_dose_diferenciada_p,',','.');
	qt_dose_medic_w				:= qt_dose_p;
	
	if (coalesce(nr_agrupamento_w::text, '') = '') then
		select	coalesce(max(nr_agrupamento),0) + 1
		into STRICT	nr_agrupamento_w
		from	prescr_material
		where	nr_prescricao = nr_prescricao_p
		and		ie_agrupador = 1;
	end if;
	
	select	coalesce(max(nr_sequencia),0) + 1
	into STRICT	nr_seq_prescricao_w
	from	prescr_material
	where	nr_prescricao = nr_prescricao_p;

	cd_unidade_medida_w	:= substr(obter_dados_material_estab(cd_material_p, cd_estabelecimento_p ,'UMS'),1,30);	
	qt_conversao_dose_w	:= coalesce(obter_conversao_unid_med(cd_material_p, cd_unidade_medida_dose_p),0);
	
	if (qt_conversao_dose_w <= 0) then
		qt_conversao_dose_w	:= 1;
	end if;
	
	qt_unitaria_w	:= dividir(qt_dose_medic_w,qt_conversao_dose_w);
	qt_material_w	:= 0;
	if (ds_dose_diferenciada_aux_w IS NOT NULL AND ds_dose_diferenciada_aux_w::text <> '') then
		qt_material_w	:= dividir( somar_doses( ds_dose_diferenciada_p ), qt_conversao_dose_w );	
	end if;

	if (coalesce(nr_ocorrencia_w,0) = 0) then
		nr_ocorrencia_w	:= obter_ocorrencia_intervalo(cd_intervalo_w, 24, 'O');	
		if (coalesce(nr_ocorrencia_w,0) = 0) then
			nr_ocorrencia_w	:= 1;
		end if;
	end if;
	
	SELECT * FROM obter_quant_dispensar(	cd_estabelecimento_p, cd_material_p, nr_prescricao_p, nr_seq_prescricao_w, cd_intervalo_w, ie_via_aplicacao_w, qt_unitaria_w, 0, nr_ocorrencia_w, ds_dose_diferenciada_aux_w, ie_origem_inf_w, cd_unidade_medida_w, 0, qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_ww, ie_se_necessario_w, ie_acm_w ) INTO STRICT qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_ww;
	
	qt_material_w	:= coalesce(qt_material_w, qt_unitaria_w, 1);
	qt_unitaria_w	:= coalesce(qt_unitaria_w,0);
	
	if (qt_dias_liberado_w = 0) then
		qt_dias_liberado_w	:= null;
	end if;		
	
	ie_dose_espec_agora_w := 'N';
	qt_dose_especial_w := null;
	hr_dose_especial_w := null;	
	if (coalesce(nr_seq_ataque_w,0) > 0) then
		ie_dose_espec_agora_w := 'S';
		qt_dose_especial_w := qt_dose_medic_w;
		hr_dose_especial_w := hr_prim_horario_w;
	end if;

	select	coalesce(max(ie_dias_util_medic),'O'),
			coalesce(max(ie_medic_paciente),'N')
	into STRICT	ie_dias_util_medic_w,
			ie_medic_paciente_w
	from	material
	where	cd_material = cd_material_p;
	
	if (obter_enable_qt_total_dias(nr_dia_util_w, qt_dias_liberado_w, ie_dias_util_medic_w, nr_prescricao_p, cd_material_p) = 'N') then	
		qt_dias_solicitado_w := null;
	end if; 	
	
	ds_justificativa_w := cpoe_obter_justificativa_item(nr_seq_cpoe_p, cd_material_p,'M');

	insert into prescr_material(
			nr_prescricao,
			nr_sequencia,
			cd_material,
			qt_dose,
			cd_unidade_medida_dose,
			cd_unidade_medida,
			ie_via_aplicacao,
			cd_intervalo,
			ie_se_necessario,
			ie_acm,
			ie_urgencia,
			hr_prim_horario,
			ds_horarios,
			ie_origem_inf,
			ie_regra_disp,
			nr_sequencia_diluicao,
			ds_justificativa,
			qt_dias_solicitado,
			qt_dias_liberado,
			ie_objetivo,
			cd_microorganismo_cih,
			cd_amostra_cih,
			ie_origem_infeccao,
			cd_topografia_cih,
			ie_indicacao,
			nr_dia_util,
			qt_total_dias_lib,
			ie_uso_antimicrobiano,
			ie_bomba_infusao,
			qt_hora_aplicacao,
			qt_min_aplicacao,
			ie_aplic_bolus,
			ie_aplic_lenta,
			qt_solucao,
			nm_usuario,
			dt_atualizacao,
			ds_dose_diferenciada,
			cd_perfil_ativo,
			qt_unitaria,
			qt_material,
			qt_total_dispensar,
			ie_agrupador,
			nr_ocorrencia,
			qt_conversao_dose,
			nr_agrupamento,
			ie_ciente,
			ie_modificado,
			ie_novo_ciclo_ccih,
			ie_utiliza_kit,
			ie_antibiograma,
			ie_cultura_cih,
			ie_recons_diluente_fixo,
			ie_supera_limite_uso,
			ie_sem_aprazamento,
			ie_medicacao_paciente,
			ie_dose_espec_agora,
			ie_intervalo_dif,
			ie_pre_medicacao,
			ie_em_protocolo_vanco,
			ie_horario_susp,
			ie_fator_correcao,
			ie_suspenso,
			ie_cobra_paciente,
			ie_permite_substituir,
			ie_permite_alterar,
			ie_alterar_horario,
			ie_gerar_lote,
			ie_aplicar,
			ie_tipo_medic_hd,
			ie_status_cirurgia,
			nr_seq_mat_cpoe,
			qt_baixa_especial,
			qt_baixa_nconta,
			qt_dia_prim_hor,
			ie_erro,
			ie_checar_adep,
			ie_administrar,
			dt_proxima_dose,
			nr_prescricao_original,
			nr_prescricao_anterior,
			nr_sequencia_anterior,
			ds_observacao,
			dt_inicio_medic,
			cd_protocolo,
			nr_seq_protocolo,
			nr_seq_mat_protocolo,
			ie_lado,
			qt_dose_especial,
			hr_dose_especial,
			ie_item_superior
	) values (
			nr_prescricao_p,
			nr_seq_prescricao_w,
			cd_material_p,
			qt_dose_medic_w,
			cd_unidade_medida_dose_p,
			cd_unidade_medida_w,
			ie_via_aplicacao_w,
			cd_intervalo_w,
			ie_se_necessario_w,
			ie_acm_w,
			CASE WHEN coalesce(ie_urgencia_w::text, '') = '' THEN 'N'  ELSE 'S' END ,
			hr_prim_horario_w,
			ds_horarios_w,
			ie_origem_inf_w,
			CASE WHEN coalesce(ie_regra_disp_w,'X')='D' THEN  ie_regra_disp_w  ELSE ie_regra_disp_w END ,
			nr_seq_diluicao_p,
			ds_justificativa_w,
			qt_dias_solicitado_w,
			qt_dias_liberado_w,
			ie_objetivo_w,
			cd_microorganismo_cih_w,
			cd_amostra_cih_w,
			ie_origem_infeccao_w,
			cd_topografia_cih_w,
			ie_indicacao_w,
			coalesce(nr_dia_util_w,0),
			qt_total_dias_lib_w,
			ie_uso_antimicrobiano_w,
			ie_bomba_infusao_w,
			qt_hora_aplicacao_w,
			qt_min_aplicacao_w,
			ie_aplic_bolus_w,
			ie_aplic_lenta_w,
			qt_solucao_p,
			nm_usuario_p,
			dt_atualizacao_w,
			ds_dose_diferenciada_p,
			cd_perfil_p,
			qt_unitaria_w,
			qt_material_w,
			qt_total_dispensar_w,
			ie_agrupador_p,
			nr_ocorrencia_w,
			qt_conversao_dose_w,
			CASE WHEN coalesce(nr_seq_diluicao_p::text, '') = '' THEN nr_agrupamento_w  ELSE 0 END ,
			'N',
			'N',
			'N',
			'N',
			'N',
			'N',
			'N',
			'N',
			'N',
			ie_medicacao_paciente_w,
			ie_dose_espec_agora_w,
			'N',
			'N',
			'N',
			'N',
			'N',
			'N',
			'S',
			'S',
			'S',
			'S',
			'S',
			'S',
			'D',
			'GI',
			nr_seq_mat_cpoe_w,
			0,
			0,
			qt_dia_prim_hor_w,
			0,
			ie_checar_adep_p,
			ie_administrar_w,
			null,
			nr_prescricao_orig_p,
			nr_prescricao_orig_p,
			nr_sequencia_orig_p,
			ds_observacao_w,
			dt_inicio_w,
			cd_protocolo_w,
			nr_seq_protocolo_w,
			nr_seq_mat_protocolo_w,
			ie_lado_w,
			qt_dose_especial_w,
			hr_dose_especial_w,
			ie_item_superior_p);
	commit;
	
	select	coalesce(max(ie_padronizado),'S')
	into STRICT	ie_padronizado_w
	from	material_estab
	where	cd_material = cd_material_p
	and		cd_estabelecimento = cd_estabelecimento_p;
	
	if (ie_padronizado_w = 'N') and (ie_agrupador_p in (1, 4, 8, 12)) and (ie_origem_inf_w <> 'K') then
		
		if (ie_medic_paciente_w = 'N') and (ds_justificativa_w IS NOT NULL AND ds_justificativa_w::text <> '') and (coalesce(qt_dias_solicitado_w,0) > 0) and (cd_funcao_origem_w <> 2314) then
			CALL gerar_liberacao_med_naopadrao( nr_dia_util_w, cd_pessoa_fisica_w, cd_material_p, dt_inicio_base_w, qt_dose_medic_w , nm_usuario_p, ds_justificativa_w, nr_prescricao_p, nr_seq_prescricao_w,null, cd_intervalo_w);		
		end if;
	
	end if;
	
	if (coalesce(ie_reg_alt_farm_p,'N') = 'S') then
		CALL gerar_historico_dil_red_rec('N', 1, ie_agrupador_p, nr_prescricao_p, nr_seq_prescricao_w, null, cd_material_p,
									null, qt_dose_medic_w, null, qt_solucao_p, null, 
									cd_unidade_medida_dose_p,cd_estabelecimento_p, nm_usuario_p);
	end if;
	
	if (ie_agrupador_p = 3) then
		CALL define_local_disp_prescr( nr_prescricao_p, nr_seq_prescricao_w, cd_perfil_p, nm_usuario_p);
	end if;
	
	qt_dias_liberado_w	:= null;
	nr_dia_util_w		:= null;
	qt_total_dias_lib_w	:= null;	
	end;
	
begin
select	max(dt_inicio_prescr),
		max(cd_pessoa_fisica),
		max(ie_origem_inf),
		max(cd_funcao_origem)
into STRICT	dt_inicio_base_w,
		cd_pessoa_fisica_w,
		ie_origem_inf_w,
		cd_funcao_origem_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

open c001;
loop
fetch c001 into	
	cd_material_w,
	qt_dose_w,
	ie_via_aplicacao_w,
	cd_unidade_medida_dose_w,
	cd_intervalo_w,
	hr_prim_horario_w,
	ds_horarios_w,
	ie_se_necessario_w,
	ie_acm_w,
	ds_justificativa_w,
	qt_dias_solicitado_w,
	qt_dias_liberado_w,
	ie_objetivo_w,
	cd_microorganismo_cih_w,
	cd_amostra_cih_w,
	ie_origem_infeccao_w,
	cd_topografia_cih_w,
	ie_indicacao_w,
	nr_dia_util_w,
	qt_total_dias_lib_w,
	ie_uso_antimicrobiano_w,
	ie_bomba_infusao_w,
	qt_hora_aplicacao_w,
	qt_min_aplicacao_w,
	ie_aplic_bolus_w,
	ie_aplic_lenta_w,
	qt_solucao_w,
	dt_atualizacao_w,
	ds_dose_diferenciada_w,
	qt_dosagem_w,
	ie_tipo_dosagem_w,
	qt_tempo_aplicacao_w,
	qt_solucao_total_w,
	qt_hora_fase_w,			
	cd_mat_dil_w,
	qt_dose_dil_w,
	cd_unid_med_dose_dil_w,
	ds_dose_diferenciada_dil_w,
	qt_solucao_dil_w,
	cd_mat_recons_w,
	qt_dose_recons_w,
	cd_unid_med_dose_recons_w,
	cd_mat_red_w,
	qt_dose_red_w,
	cd_unid_med_dose_red_w,
	ds_dose_diferenciada_red_w,
	qt_solucao_red_w,
	nr_seq_mat_cpoe_w,
	cd_mat_comp1_w,
	qt_dose_comp1_w,
	cd_unid_med_dose_comp1_w,
	ds_dose_diferenciada_comp1_w,
	cd_mat_comp2_w,
	qt_dose_comp2_w,
	cd_unid_med_dose_comp2_w,
	ds_dose_diferenciada_comp2_w,
	cd_mat_comp3_w,
	qt_dose_comp3_w,
	cd_unid_med_dose_comp3_w,
	ds_dose_diferenciada_comp3_w,
	dt_inicio_orig_w,
	nr_ocorrencia_w,
	ds_observacao_w,
	ie_urgencia_w,
	ie_medicacao_paciente_w,
	cd_protocolo_w,
	nr_seq_protocolo_w,
	nr_seq_mat_protocolo_w,
	ie_administracao_w,
	ie_lado_w,
	nr_seq_ataque_w;
EXIT WHEN NOT FOUND; /* apply on c001 */
	begin
	
	select 	max(nr_sequencia)
	into STRICT	nr_seq_medic_princ_w
	from	prescr_material
	where	nr_seq_mat_cpoe = nr_seq_mat_cpoe_w
	and 	nr_prescricao = nr_prescricao_p
	and 	cd_material = cd_material_w;

	dt_inicio_w			:= to_date(to_char(dt_inicio_orig_w,'dd/mm/yyyy ') || hr_prim_horario_w,'dd/mm/yyyy hh24:mi');			
	ie_administrar_w	:= null;
	ie_se_necessario_w	:= 'N';
	ie_acm_w			:= 'N';
	
	if (ie_administracao_w = 'N') then
		ie_se_necessario_w	:= 'S';
		ie_acm_w			:= 'N';
		hr_prim_horario_w	:= null;
		ds_horarios_w		:= 'SN';
		ie_urgencia_w		:= null;
	elsif (ie_administracao_w = 'C') then
		ie_se_necessario_w	:= 'N';
		ie_acm_w			:= 'S';
		hr_prim_horario_w	:= null;
		ds_horarios_w		:= 'ACM';
		ie_urgencia_w		:= null;
	end if;
	
	qt_dia_prim_hor_w	:= trunc(dt_inicio_w) - trunc(dt_inicio_base_w);
	if (qt_dia_prim_hor_w < 0) then
		qt_dia_prim_hor_w	:= 0;
	end if;

	if (cd_mat_dil_w IS NOT NULL AND cd_mat_dil_w::text <> '') and (ie_opcao_gerar_p = 'D') then	
		gerar_item_medicacao( cd_mat_dil_w, cd_unid_med_dose_dil_w, qt_dose_dil_w, ds_dose_diferenciada_dil_w, qt_solucao_dil_w, 3, nr_seq_medic_princ_w, 'S');
	elsif (cd_mat_recons_w IS NOT NULL AND cd_mat_recons_w::text <> '')  and (ie_opcao_gerar_p = 'R') then	
		gerar_item_medicacao( cd_mat_recons_w, cd_unid_med_dose_recons_w, qt_dose_recons_w, null, null, 9, nr_seq_medic_princ_w, 'S');
	elsif (cd_mat_red_w IS NOT NULL AND cd_mat_red_w::text <> '')  and (ie_opcao_gerar_p = 'RD') then	
		gerar_item_medicacao( cd_mat_red_w, cd_unid_med_dose_red_w, qt_dose_red_w, ds_dose_diferenciada_red_w, qt_solucao_red_w, 7, nr_seq_medic_princ_w, 'S');
	end if;	
	end;
end loop;
close c001;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE html_insere_recon_dil_med (( nr_prescricao_p prescr_medica.nr_prescricao%type, nr_seq_cpoe_p cpoe_material.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_perfil_p perfil.cd_perfil%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_opcao_gerar_p text, ie_reg_alt_farm_p text) is type tcursor REFCURSOR) FROM PUBLIC;

