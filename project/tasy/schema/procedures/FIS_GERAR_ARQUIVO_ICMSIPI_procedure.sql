-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_gerar_arquivo_icmsipi ( nr_seq_controle_p bigint ) AS $body$
DECLARE


-- VARIABLES
arq_texto_w				utl_file.file_type;
ds_diretorio_w			varchar(255);
nm_arquivo_w			varchar(255);
qt_contador_w			bigint	:= 0;
ds_erro_w			 	varchar(2000);

-- USUARIO
nm_usuario_w		usuario.nm_usuario%type;

-- FIS_EFD_ICMSIPI_CONTROLE
cd_estabelecimento_w	fis_efd_icmsipi_controle.cd_estabelecimento%type;
dt_inicio_apuracao_w	fis_efd_icmsipi_controle.dt_inicio_apuracao%type;

-- FIS_EFD_ICMSIPI_ARQUIVO
ds_arquivo_w			fis_efd_icmsipi_arquivo.ds_arquivo%type;
ds_arquivo_compl_w		fis_efd_icmsipi_arquivo.ds_arquivo_compl%type;
cd_registro_w			fis_efd_icmsipi_arquivo.cd_registro%type;
nr_linha_w			 	fis_efd_icmsipi_arquivo.nr_linha%type;

C01 CURSOR FOR
SELECT	a.cd_registro,
        a.ds_arquivo,
		a.ds_arquivo_compl,
		a.nr_linha
from	fis_efd_icmsipi_arquivo a
where	a.nr_seq_controle = nr_seq_controle_p
order by nr_linha;


BEGIN
nm_usuario_w := Obter_Usuario_Ativo;

select	max(cd_estabelecimento),
		max(dt_inicio_apuracao)
into STRICT	cd_estabelecimento_w,
		dt_inicio_apuracao_w
from	fis_efd_icmsipi_controle
where	nr_sequencia = nr_seq_controle_p;

ds_diretorio_w		:= substr(coalesce(Obter_Valor_Param_Usuario(5500, 14, obter_perfil_ativo, Obter_Usuario_Ativo, cd_estabelecimento_w),''),1,255);
nm_arquivo_w 		:= ('ArquivoEFD_' || to_char(dt_inicio_apuracao_w,'ddmmyyyy') || '.txt');
CALL gravar_processo_longo('Carregando informações ' || nm_arquivo_w, 'EFD_GERAR_ARQ_BANCO_ICMSIPI', qt_contador_w);

begin
	arq_texto_w := utl_file.fopen(ds_diretorio_w, nm_arquivo_w, 'W');
exception when others then
	ds_erro_w	:= substr(sqlerrm(SQLSTATE),1,2000);
	CALL wheb_mensagem_pck.exibir_mensagem_abort(472074, 'DS_DIRETORIO=' || ds_diretorio_w || ';' ||	'DS_ERRO=' || ds_erro_w);
end;

open C01;
loop
fetch C01 into
	cd_registro_w,
	ds_arquivo_w,
	ds_arquivo_compl_w,
	nr_linha_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	qt_contador_w	:= nr_linha_w;
	CALL gravar_processo_longo('Gerando arquivo' || cd_registro_w || '-' || nm_arquivo_w, 'EFD_GERAR_ARQ_BANCO_ICMSIPI', qt_contador_w);

	utl_file.put_line(arq_texto_w, ds_arquivo_w || ds_arquivo_compl_w || chr(13));
	utl_file.fflush(arq_texto_w);
end loop;
close C01;

utl_file.fclose(arq_texto_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_gerar_arquivo_icmsipi ( nr_seq_controle_p bigint ) FROM PUBLIC;

