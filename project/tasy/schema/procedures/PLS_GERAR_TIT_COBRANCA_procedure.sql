-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_tit_cobranca ( nr_titulo_p bigint, nr_seq_cobrador_p bigint, nr_seq_orgao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


dt_vencimento_w			timestamp;
vl_saldo_titulo_w		double precision;
cd_tipo_portador_w		integer;
cd_portador_w			bigint;
vl_titulo_w			double precision;
nr_seq_cobranca_w		bigint;
qt_registros_w			bigint;


BEGIN

select	count(*)
into STRICT	qt_registros_w
from	cobranca
where	nr_titulo	= nr_titulo_p
and	ie_status	= 'P';

if (qt_registros_w = 0) then

	select	dt_pagamento_previsto,
		vl_saldo_titulo,
		cd_tipo_portador,
		cd_portador,
		vl_titulo
	into STRICT	dt_vencimento_w,
		vl_saldo_titulo_w,
		cd_tipo_portador_w,
		cd_portador_w,
		vl_titulo_w
	from	titulo_receber
	where	nr_titulo	= nr_titulo_p;

	select	nextval('cobranca_seq')
	into STRICT	nr_seq_cobranca_w
	;

	insert into cobranca(	nr_sequencia,
					cd_estabelecimento,
					dt_atualizacao,
					nm_usuario,
					nr_titulo,
					ie_status,
					vl_original,
					vl_acobrar,
					dt_previsao_cobranca,
					dt_inclusao,
					cd_tipo_portador,
					cd_portador,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_cobrador)
				values (	nr_seq_cobranca_w,
					cd_estabelecimento_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_titulo_p,
					'P',
					vl_titulo_w,
					vl_saldo_titulo_w,
					dt_vencimento_w,
					clock_timestamp(),
					cd_tipo_portador_w,
					cd_portador_w,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_cobrador_p);

	insert into cobranca_orgao(	nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_cobranca,
					nr_seq_orgao,
					dt_inclusao,
					dt_atualizacao_nrec,
					nm_usuario_nrec)
				values (	nextval('cobranca_orgao_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_cobranca_w,
					nr_seq_orgao_p,
					clock_timestamp(),
					clock_timestamp(),
					nm_usuario_p);

	/*insert into cobranca_alt_cobrador(	nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_seq_cobranca,
						dt_alteracao,
						nr_seq_cobr_ant,
						nr_seq_cobr_novo)
					values(	cobranca_alt_cobrador_seq.NextVal,
						sysdate,
						nm_usuario_p,
						sysdate,
						nm_usuario_p,
						nr_seq_cobranca_w,
						sysdate,
						*/
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_tit_cobranca ( nr_titulo_p bigint, nr_seq_cobrador_p bigint, nr_seq_orgao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

