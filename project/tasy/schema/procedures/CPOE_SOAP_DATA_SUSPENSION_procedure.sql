-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_soap_data_suspension (nr_atendimento_p bigint, lista_itens_p text, nm_usuario_p text) AS $body$
DECLARE

ds_items_suspend_w          varchar(2000);
ie_tipo_item_w      	    varchar(255);
nr_seq_item_w               bigint;
ie_se_liberado_w            varchar(1);
nr_cpoe_item_type_w         smallint;
cd_evolucao_w               evolucao_paciente.cd_evolucao%type;
ds_error_w                  varchar(1000);


BEGIN
ds_items_suspend_w :=   substr(lista_itens_p,2,length(lista_itens_p) - 2 );

WHILE (ds_items_suspend_w IS NOT NULL AND ds_items_suspend_w::text <> '') LOOP

    nr_seq_item_w := substr( ds_items_suspend_w,1,position(';' in ds_items_suspend_w) - 1);--254658 = sequencia do registro
    ds_items_suspend_w := substr( ds_items_suspend_w,position(';' in ds_items_suspend_w) + 1,length( ds_items_suspend_w ) - 1);--  ;M;S,  456786;D;N,  15648;P;S]
    ie_tipo_item_w := substr( ds_items_suspend_w,0,position(';' in ds_items_suspend_w) - 1);--'M' = Tipo item
    ds_items_suspend_w := substr( ds_items_suspend_w,position(';' in ds_items_suspend_w),length( ds_items_suspend_w ));--;S,  456786;D;N,  15648;P;S]r
    ie_se_liberado_w := substr( ds_items_suspend_w,position(';' in ds_items_suspend_w) + 1,position(',' in ds_items_suspend_w) - 2);--'S' = Se liberado
    ds_items_suspend_w := substr( ds_items_suspend_w,position(',' in ds_items_suspend_w) + 1,length( ds_items_suspend_w ));-- 456786;D;N,  15648;P;S]
    if (ie_se_liberado_w = 'S') then

        select CASE WHEN ie_tipo_item_w='N' THEN 0 WHEN ie_tipo_item_w='M' THEN 1 WHEN ie_tipo_item_w='P' THEN 2 WHEN ie_tipo_item_w='G' THEN 3 WHEN ie_tipo_item_w='R' THEN 4 WHEN ie_tipo_item_w='H' THEN 5 WHEN ie_tipo_item_w='D' THEN 6 WHEN ie_tipo_item_w='DI' THEN 6 WHEN ie_tipo_item_w='DP' THEN 6 WHEN ie_tipo_item_w='MA' THEN 8 WHEN ie_tipo_item_w='AP' THEN 9  ELSE null END
        into STRICT nr_cpoe_item_type_w
		;

        select max(cd_evolucao)
        into STRICT cd_evolucao_w
        from clinical_note_soap_data
        where nr_seq_med_item = nr_seq_item_w
        and ie_med_rec_type ='CPOE_ITEMS'
        and ie_stage = 1
        and ie_soap_type = 'P'
        and  ie_cpoe_item_type = to_char(nr_cpoe_item_type_w);

	if (cd_evolucao_w IS NOT NULL AND cd_evolucao_w::text <> '') then
        delete from clinical_note_soap_data
        where cd_evolucao = cd_evolucao_w
        and ie_med_rec_type ='CPOE_ITEMS'
        and ie_stage = 1
        and ie_soap_type = 'P'
        and nr_seq_med_item = nr_seq_item_w
        and ie_cpoe_item_type = to_char(nr_cpoe_item_type_w);
	end if;

   end if;
END LOOP;

CALL clinical_notes_pck.soap_data_after_delete(cd_evolucao_w);
exception
WHEN data_exception THEN
ds_error_w := substr(sqlerrm,1,1000);
	CALL gravar_log_cpoe('CPOE_SOAP_DATA_SUSPENSION exception: '||ds_error_w||
			' nr_atendimento_p: '||nr_atendimento_p||
			' lista_itens_p: '||lista_itens_p||
			' nm_usuario_p: '||nm_usuario_p,nr_atendimento_p);
when others then
	rollback;
	ds_error_w := substr(sqlerrm,1,1000);
	CALL gravar_log_cpoe('CPOE_SOAP_DATA_SUSPENSION exception: '||ds_error_w||
			' nr_atendimento_p: '||nr_atendimento_p||
			' lista_itens_p: '||lista_itens_p||
			' nm_usuario_p: '||nm_usuario_p,nr_atendimento_p);

commit;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_soap_data_suspension (nr_atendimento_p bigint, lista_itens_p text, nm_usuario_p text) FROM PUBLIC;

