-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE suspender_prescr_mipres ( nr_prescricao_p PRESCR_MIPRES.NR_PRESCRICAO%TYPE, nr_seq_item_cpoe_p CPOE_MATERIAL.NR_SEQUENCIA%TYPE, nr_atendimento_p PRESCR_MIPRES.NR_ATENDIMENTO%TYPE, nr_seq_receita_amb_p FA_RECEITA_FARMACIA.NR_SEQUENCIA%TYPE, ie_funcao_origem_p PRESCR_MIPRES.IE_STATUS%TYPE) AS $body$
DECLARE


dt_atual_s                   CONSTANT PRESCR_MIPRES.DT_ATUALIZACAO%TYPE := clock_timestamp();
ie_eps_w                     CONVENIO_PLANO.IE_EPS%TYPE;
			

BEGIN

  SELECT coalesce(max(a.IE_EPS),'N')
  INTO STRICT   ie_eps_w
  FROM   CONVENIO_PLANO a
  WHERE  a.cd_plano = obter_plano_convenio_atend(nr_atendimento_p,'C')
  AND    a.cd_convenio = obter_convenio_atendimento(nr_atendimento_p);

  IF (ie_eps_w = 'S') THEN

    UPDATE PRESCR_MIPRES a SET
      a.ie_status              = 4, --Suspenso,
      a.dt_inativacao          = dt_atual_s,
      a.nm_usuario_inativacao  = wheb_usuario_pck.get_nm_usuario,
      a.ds_justificativa       = obter_desc_expressao(505006) || CASE WHEN ie_funcao_origem_p='C' THEN  obter_desc_expressao(608679)  ELSE obter_desc_expressao(929142) END 
    WHERE (ie_funcao_origem_p   = 'C' 
    AND   ((a.nr_prescricao    = nr_prescricao_p 
    OR (coalesce(a.nr_prescricao::text, '') = '' AND coalesce(nr_prescricao_p::text, '') = ''))
    AND   a.nr_atendimento     = nr_atendimento_p
    AND (coalesce(a.nr_seq_item_cpoe::text, '') = '' 
    OR    a.nr_seq_item_cpoe   = nr_seq_item_cpoe_p)))
    OR (ie_funcao_origem_p  = 'P' AND a.nr_seq_receita_amb = nr_seq_receita_amb_p)
    OR (ie_funcao_origem_p  = 'O' AND a.nr_prescricao = nr_prescricao_p AND a.nr_atendimento = nr_atendimento_p);

  END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE suspender_prescr_mipres ( nr_prescricao_p PRESCR_MIPRES.NR_PRESCRICAO%TYPE, nr_seq_item_cpoe_p CPOE_MATERIAL.NR_SEQUENCIA%TYPE, nr_atendimento_p PRESCR_MIPRES.NR_ATENDIMENTO%TYPE, nr_seq_receita_amb_p FA_RECEITA_FARMACIA.NR_SEQUENCIA%TYPE, ie_funcao_origem_p PRESCR_MIPRES.IE_STATUS%TYPE) FROM PUBLIC;

