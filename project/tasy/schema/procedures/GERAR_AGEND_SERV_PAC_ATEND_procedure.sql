-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_agend_serv_pac_atend ( nr_seq_paciente_p bigint, nr_seq_atendimento_p bigint, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE

			
	
dt_agendamento_w	timestamp;
dt_agenda_w		timestamp;
cd_agenda_w		bigint;
ie_classif_agenda_w  	varchar(5);
nr_sequencia_w		bigint;
nr_seq_agenda_w		agenda_consulta.nr_sequencia%type;
cd_pessoa_fisica_w	varchar(10);
cd_medico_resp_w	varchar(10);	
ds_erro_w		varchar(2000) := '';
nr_seq_atendimento_w	bigint;
	
c01 CURSOR FOR
	SELECT	dt_prevista,
		nr_seq_atendimento
	from	paciente_atendimento
	where (nr_seq_paciente	= nr_seq_paciente_p)
	and	((nr_seq_atendimento_p = nr_seq_atendimento) or ((nr_seq_atendimento_p = 0) and (coalesce(dt_real::text, '') = '')))
	order 	by 1;					
					

BEGIN

ds_erro_w := null;

select	max(nr_sequencia)
into STRICT	nr_sequencia_w
from 	regra_agenda_serv_ciclo;


if (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') then

	select 	max(cd_agenda),
		max(ie_classif_agenda)
	into STRICT	cd_agenda_w,
		ie_classif_agenda_w
	from	regra_agenda_serv_ciclo
	where	nr_sequencia = nr_sequencia_w;


	select	max(cd_pessoa_fisica),
		max(cd_medico_resp)
	into STRICT	cd_pessoa_fisica_w,
		cd_medico_resp_w
	from	paciente_setor
	where	nr_seq_paciente = nr_seq_paciente_p;


	if not(coalesce(cd_agenda_w::text, '') = '') and
	   not(coalesce(ie_classif_agenda_w::text, '') = '')	 then

		open c01;
		loop
		fetch c01 into	
			dt_agendamento_w,
			nr_seq_atendimento_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin
				
			--Atualiza agenda de servico
			CALL Gerar_Horario_Agenda_Servico(obter_estab_agenda(cd_agenda_w), cd_agenda_w, trunc(dt_agendamento_w),nm_usuario_p );	
				
			
			select	max(dt_agenda)
			into STRICT	dt_agenda_w
			from	agenda_consulta
			where	trunc(dt_agenda) = trunc(dt_agendamento_w)
			and	ie_status_agenda = 'L'
			and	dt_agenda 	<= dt_agendamento_w
			and	cd_agenda 	= cd_agenda_w
			and	ie_classif_agenda = ie_classif_agenda_w;
			
			nr_seq_agenda_w := null;
			
			if (dt_agenda_w IS NOT NULL AND dt_agenda_w::text <> '') then
				
				select	max(nr_sequencia)
				into STRICT	nr_seq_agenda_w
				from	agenda_consulta
				where	trunc(dt_agenda) = trunc(dt_agendamento_w)
				and	ie_status_agenda = 'L'
				and	dt_agenda 	= dt_agenda_w
				and	cd_agenda 	= cd_agenda_w
				and	ie_classif_agenda = ie_classif_agenda_w;
				
			end if;	
				
				
			if (coalesce(nr_seq_agenda_w::text, '') = '') then
			
				ds_erro_w := ds_erro_w||' | '||to_char(dt_agendamento_w,'dd/mm/yyyy hh24:mi:ss');	
			else
			
				update 	agenda_consulta
				set	nm_usuario 	    = nm_usuario_p,
					dt_atualizacao	    = clock_timestamp(),
					ie_status_agenda    = 'N',
					ie_classif_agenda   = ie_classif_agenda_w,
					cd_agenda	    = cd_agenda_w,
					cd_pessoa_fisica    = cd_pessoa_fisica_w,
					cd_medico_solic	    = cd_medico_resp_w		
				where	nr_sequencia 	    = nr_seq_agenda_w;
				
				
				update	paciente_atendimento
				set	nr_seq_agenda_cons = nr_seq_agenda_w
				where	nr_seq_atendimento = nr_seq_atendimento_w;
				
				commit;
				
			end if;
			
			end;
		end loop;
		close c01;

	end if;

	if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
			
		select 	substr(substr(ds_erro_w,3,length(ds_erro_w)),1,255)
		into STRICT	ds_erro_w
		;
				
	end if;

	ds_erro_p := ds_erro_w;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_agend_serv_pac_atend ( nr_seq_paciente_p bigint, nr_seq_atendimento_p bigint, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

