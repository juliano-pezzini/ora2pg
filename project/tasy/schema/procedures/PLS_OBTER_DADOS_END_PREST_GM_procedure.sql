-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_dados_end_prest_gm ( cd_pessoa_fisica_p text, cd_cgc_p text, ie_tipo_compl_prest_p text, ie_compl_pj_adic_p text, nr_seq_compl_adic_p bigint, nr_seq_tipo_compl_adic_p bigint, ie_origem_p text, ds_endereco_p INOUT text, nr_endereco_p INOUT text, ds_complemento_p INOUT text, ds_bairro_p INOUT text, cd_cep_p INOUT text, nr_telefone_p INOUT text, ds_email_p INOUT text, ds_website_p INOUT text, nr_ddi_telefone_p INOUT text, nr_ddd_telefone_p INOUT text, nr_ramal_p INOUT bigint, cd_municipio_ibge_p INOUT text, sg_estado_p INOUT text, ds_fax_p INOUT text, nr_ddd_fax_p INOUT text, ds_municipio_p INOUT text, ds_fone_adic_p INOUT text) AS $body$
DECLARE


nr_tel_simples_w		varchar(30);
nr_telefone_w			varchar(30);
ds_fone_adic_w			varchar(255);
ds_fone_adic_aux_w		varchar(20);
cd_cgc_w			varchar(14)	:= null;
cd_pessoa_fisica_w		varchar(10)	:= null;
nr_ddd_telefone_w		varchar(3);
nr_ddi_telefone_w		varchar(3);
nr_ddd_simples_w		varchar(3);
ie_tipo_pessoa_w		varchar(2)	:= null;
ie_tipo_complemento_w		smallint	:= 0;
qt_length_w			bigint;
qt_registro_w			integer	:= 0;
nr_seq_tipo_logradouro_w	pessoa_juridica.nr_seq_tipo_logradouro%type;
ds_tipo_logradouro_w		cns_tipo_logradouro.ds_tipo_logradouro%type;		
ie_fone_princ_w			pls_web_param_guia_medico.ie_fone_princ%type;

C01 CURSOR FOR
	SELECT	substr(nr_telefone,1,15)
	from	pessoa_juridica_compl
	where	cd_cgc	= coalesce(cd_cgc_w,cd_cgc_p)
	and	ie_tipo_complemento = 3;


BEGIN

ds_tipo_logradouro_w := null;

if (ie_tipo_compl_prest_p	= 'PFR') then
	ie_tipo_complemento_w	:= 1;
elsif (ie_tipo_compl_prest_p	= 'PFC') then
	ie_tipo_complemento_w	:= 2;
elsif (ie_tipo_compl_prest_p	= 'PJ') then
	ie_tipo_complemento_w	:= 0;
elsif (ie_tipo_compl_prest_p	= 'PJF') then
	ie_tipo_complemento_w	:= 2;
elsif (ie_tipo_compl_prest_p	= 'PJC') then
	ie_tipo_complemento_w	:= 1;
elsif (ie_tipo_compl_prest_p	= 'PJA') then
	ie_tipo_complemento_w	:= 6;
elsif (ie_tipo_compl_prest_p	= 'PFA') then
	ie_tipo_complemento_w	:= 9;
end if;

select	max(ie_fone_princ)
into STRICT	ie_fone_princ_w
from	pls_web_param_guia_medico;

if (ie_tipo_complemento_w > 0) then
	if (ie_tipo_compl_prest_p in ('PFR','PFC','PFA')) then
		if (ie_tipo_complemento_w = 2) and (nr_seq_compl_adic_p IS NOT NULL AND nr_seq_compl_adic_p::text <> '') then
			select	max(ds_endereco),
				max(nr_endereco),
				max(ds_complemento),
				max(ds_bairro),
				max(cd_cep),
				max(nr_telefone),
				max(ds_email),
				null,
				max(nr_ddi_telefone),
				max(nr_ddd_telefone),
				null,
				max(cd_municipio_ibge),
				max(sg_estado),
				null,
				null,
				max(ds_municipio),
				null
			into STRICT	ds_endereco_p,
				nr_endereco_p,
				ds_complemento_p,
				ds_bairro_p,
				cd_cep_p,
				nr_telefone_p,
				ds_email_p,
				ds_website_p,
				nr_ddi_telefone_w,
				nr_ddd_telefone_w,
				nr_ramal_p,
				cd_municipio_ibge_p,
				sg_estado_p,
				ds_fax_p,
				nr_ddd_fax_p,
				ds_municipio_p,
				ds_fone_adic_p
			from	compl_pf_tel_adic
			where	nr_sequencia	= nr_seq_compl_adic_p;
		elsif (ie_tipo_compl_prest_p = 'PFA') then
			if (nr_seq_tipo_compl_adic_p IS NOT NULL AND nr_seq_tipo_compl_adic_p::text <> '') then
				begin
				select	ds_endereco,
					nr_endereco,
					ds_complemento,
					ds_bairro,
					cd_cep,
					nr_telefone,
					ds_email,
					ds_website,
					nr_ddi_telefone,
					nr_ddd_telefone,
					nr_ramal,
					cd_municipio_ibge,
					sg_estado,
					ds_fax,
					nr_ddd_fax,
					ds_municipio,
					ds_fone_adic
				into STRICT	ds_endereco_p,
					nr_endereco_p,
					ds_complemento_p,
					ds_bairro_p,
					cd_cep_p,
					nr_telefone_p,
					ds_email_p,
					ds_website_p,
					nr_ddi_telefone_w,
					nr_ddd_telefone_w,
					nr_ramal_p,
					cd_municipio_ibge_p,
					sg_estado_p,
					ds_fax_p,
					nr_ddd_fax_p,
					ds_municipio_p,
					ds_fone_adic_p
				from	compl_pessoa_fisica
				where	cd_pessoa_fisica	= cd_pessoa_fisica_p
				and	ie_tipo_complemento	= 9
				and	nr_seq_tipo_compl_adic	= nr_seq_tipo_compl_adic_p;
				exception
				when others then
					ds_endereco_p		:= null;
					nr_endereco_p		:= null;
					ds_complemento_p	:= null;
					ds_bairro_p		:= null;
					cd_cep_p		:= null;
					nr_telefone_p		:= null;
					ds_email_p		:= null;
					ds_website_p		:= null;
					nr_ddi_telefone_w	:= null;
					nr_ddd_telefone_w	:= null;
					nr_ramal_p		:= null;
					cd_municipio_ibge_p	:= null;
					sg_estado_p		:= null;
					ds_fax_p		:= null;
					nr_ddd_fax_p		:= null;
					ds_municipio_p		:= null;
					ds_fone_adic_p		:= null;
				end;
			else
				begin
				select	ds_endereco,
					nr_endereco,
					ds_complemento,
					ds_bairro,
					cd_cep,
					nr_telefone,
					ds_email,
					ds_website,
					nr_ddi_telefone,
					nr_ddd_telefone,
					nr_ramal,
					cd_municipio_ibge,
					sg_estado,
					ds_fax,
					nr_ddd_fax,
					ds_municipio,
					ds_fone_adic
				into STRICT	ds_endereco_p,
					nr_endereco_p,
					ds_complemento_p,
					ds_bairro_p,
					cd_cep_p,
					nr_telefone_p,
					ds_email_p,
					ds_website_p,
					nr_ddi_telefone_w,
					nr_ddd_telefone_w,
					nr_ramal_p,
					cd_municipio_ibge_p,
					sg_estado_p,
					ds_fax_p,
					nr_ddd_fax_p,
					ds_municipio_p,
					ds_fone_adic_p
				from	compl_pessoa_fisica
				where	cd_pessoa_fisica	= cd_pessoa_fisica_p
				and	ie_tipo_complemento	= 9
				and	coalesce(nr_seq_tipo_compl_adic::text, '') = ''  LIMIT 1;
				exception
				when others then
					ds_endereco_p		:= null;
					nr_endereco_p		:= null;
					ds_complemento_p	:= null;
					ds_bairro_p		:= null;
					cd_cep_p		:= null;
					nr_telefone_p		:= null;
					ds_email_p		:= null;
					ds_website_p		:= null;
					nr_ddi_telefone_w	:= null;
					nr_ddd_telefone_w	:= null;
					nr_ramal_p		:= null;
					cd_municipio_ibge_p	:= null;
					sg_estado_p		:= null;
					ds_fax_p		:= null;
					nr_ddd_fax_p		:= null;
					ds_municipio_p		:= null;
					ds_fone_adic_p		:= null;
				end;
			end if;
		else
			select	substr(pls_obter_compl_pf_gm(cd_pessoa_fisica_p, ie_tipo_complemento_w, 'EN'),1,255),
				substr(pls_obter_compl_pf_gm(cd_pessoa_fisica_p, ie_tipo_complemento_w, 'NR'),1,5),
				substr(pls_obter_compl_pf_gm(cd_pessoa_fisica_p, ie_tipo_complemento_w, 'CO'),1,255),
				substr(pls_obter_compl_pf_gm(cd_pessoa_fisica_p, ie_tipo_complemento_w, 'B'),1,40),
				substr(pls_obter_compl_pf_gm(cd_pessoa_fisica_p, ie_tipo_complemento_w, 'CEP'),1,15),
				substr(pls_obter_compl_pf_gm(cd_pessoa_fisica_p, ie_tipo_complemento_w, 'T'),1,15),
				substr(pls_obter_compl_pf_gm(cd_pessoa_fisica_p, ie_tipo_complemento_w, 'M'),1,255),
				substr(pls_obter_compl_pf_gm(cd_pessoa_fisica_p, ie_tipo_complemento_w, 'WS'),1,255),
				substr(pls_obter_compl_pf_gm(cd_pessoa_fisica_p, ie_tipo_complemento_w, 'DIT'),1,3),
				substr(pls_obter_compl_pf_gm(cd_pessoa_fisica_p, ie_tipo_complemento_w, 'DDT'),1,3),
				substr(pls_obter_compl_pf_gm(cd_pessoa_fisica_p, ie_tipo_complemento_w, 'RAM'),1,5),
				substr(pls_obter_compl_pf_gm(cd_pessoa_fisica_p, ie_tipo_complemento_w, 'CDM'),1,6),
				substr(pls_obter_compl_pf_gm(cd_pessoa_fisica_p, ie_tipo_complemento_w, 'UF'),1,2),
				substr(pls_obter_compl_pf_gm(cd_pessoa_fisica_p, ie_tipo_complemento_w, 'FAX'),1,80),
				substr(pls_obter_compl_pf_gm(cd_pessoa_fisica_p, ie_tipo_complemento_w, 'DDF'),1,3),
				substr(pls_obter_compl_pf_gm(cd_pessoa_fisica_p, ie_tipo_complemento_w, 'CI'),1,40),
				substr(pls_obter_compl_pf_gm(cd_pessoa_fisica_p, ie_tipo_complemento_w, 'TA'),1,255)
			into STRICT	ds_endereco_p,
				nr_endereco_p,
				ds_complemento_p,
				ds_bairro_p,
				cd_cep_p,
				nr_telefone_p,
				ds_email_p,
				ds_website_p,
				nr_ddi_telefone_w,
				nr_ddd_telefone_w,
				nr_ramal_p,
				cd_municipio_ibge_p,
				sg_estado_p,
				ds_fax_p,
				nr_ddd_fax_p,
				ds_municipio_p,
				ds_fone_adic_p
			;
		end if;
	elsif (ie_tipo_compl_prest_p in ('PJF','PJC', 'PJA', '3', '4', '5', '6', '7', '8')) then
		if (nr_seq_compl_adic_p IS NOT NULL AND nr_seq_compl_adic_p::text <> '') then
			select	max(ds_endereco),
				substr(max(nr_endereco),1,5),
				max(ds_complemento),
				max(ds_bairro),
				max(cd_cep),
				max(nr_telefone),
				max(ds_email),
				null,
				null,
				max(nr_ddd_telefone),
				null,
				max(cd_municipio_ibge),
				max(sg_estado),
				null,
				null,
				max(ds_municipio),
				max(nr_seq_tipo_logradouro)
			into STRICT	ds_endereco_p,
				nr_endereco_p,
				ds_complemento_p,
				ds_bairro_p,
				cd_cep_p,
				nr_telefone_p,
				ds_email_p,
				ds_website_p,
				nr_ddi_telefone_w,
				nr_ddd_telefone_w,
				nr_ramal_p,
				cd_municipio_ibge_p,
				sg_estado_p,
				ds_fax_p,
				nr_ddd_fax_p,
				ds_municipio_p,
				nr_seq_tipo_logradouro_w
			from	pessoa_juridica_compl a
			where	cd_cgc 		= cd_cgc_p
			and	nr_sequencia 	= nr_seq_compl_adic_p;
			
			if	((	coalesce(ie_origem_p, 'T') = 'W') and (	coalesce(ie_fone_princ_w, 'N') = 'N')) or ( 	coalesce(ie_origem_p, 'T') = 'T') then
			
				open C01;
				loop
				fetch C01 into	
					ds_fone_adic_aux_w;
				EXIT WHEN NOT FOUND; /* apply on C01 */
					begin
					if (length(ds_fone_adic_w || ds_fone_adic_aux_w) < 255) then
							
						ds_fone_adic_w	:= ds_fone_adic_w || ' / ' || ds_fone_adic_aux_w;
						
						if (substr(ds_fone_adic_w,1,3) = ' / ') then
							ds_fone_adic_w := substr(ds_fone_adic_w,4,255);
						end if;
						
					end if;
					end;
				end loop;
				close C01;
				
				qt_length_w := length(ds_fone_adic_w);
		
				if (substr(ds_fone_adic_w, qt_length_w -2, qt_length_w) = ' / ') then
					ds_fone_adic_p	:= substr(ds_fone_adic_w,1,qt_length_w -3);
				else
					ds_fone_adic_p	:= substr(ds_fone_adic_w,1,qt_length_w);
				end if;
			end if;
		else
			select	count(*)
			into STRICT	qt_registro_w
			from	pessoa_juridica_compl
			where	cd_cgc 			= cd_cgc_p
			and	ie_tipo_complemento 	= ie_tipo_complemento_w;
			
			if (qt_registro_w <> 0) then
				select	ds_endereco,
					nr_endereco,
					ds_complemento,
					ds_bairro,
					cd_cep,
					nr_telefone,
					ds_email,
					null,
					null,
					nr_ddd_telefone,
					nr_ramal_contato,
					cd_municipio_ibge,
					sg_estado,
					nr_fax,
					null,
					ds_municipio,
					nr_seq_tipo_logradouro
				into STRICT	ds_endereco_p,
					nr_endereco_p,
					ds_complemento_p,
					ds_bairro_p,
					cd_cep_p,
					nr_telefone_p,
					ds_email_p,
					ds_website_p,
					nr_ddi_telefone_w,
					nr_ddd_telefone_w,
					nr_ramal_p,
					cd_municipio_ibge_p,
					sg_estado_p,
					ds_fax_p,
					nr_ddd_fax_p,
					ds_municipio_p,
					nr_seq_tipo_logradouro_w
				from	pessoa_juridica_compl
				where	nr_sequencia = (SELECT max(nr_sequencia) from pessoa_juridica_compl where cd_cgc = cd_cgc_p and ie_tipo_complemento = ie_tipo_complemento_w)
				and	cd_cgc		= cd_cgc_p  LIMIT 1;
				
				if	((	coalesce(ie_origem_p, 'T') = 'W') and (	coalesce(ie_fone_princ_w, 'N') = 'N')) or ( 	coalesce(ie_origem_p, 'T') = 'T') then
					open C01;
					loop
					fetch C01 into	
						ds_fone_adic_aux_w;
					EXIT WHEN NOT FOUND; /* apply on C01 */
						begin
						if (length(ds_fone_adic_w || ds_fone_adic_aux_w) < 255) then
								
							ds_fone_adic_w	:= ds_fone_adic_w || ' / ' || ds_fone_adic_aux_w;
							
							if (substr(ds_fone_adic_w,1,3) = ' / ') then
								ds_fone_adic_w := substr(ds_fone_adic_w,4,255);
							end if;
							
						end if;
						end;
					end loop;
					close C01;
					
					qt_length_w := length(ds_fone_adic_w);
			
					if (substr(ds_fone_adic_w, qt_length_w -2, qt_length_w) = ' / ') then
						ds_fone_adic_p	:= substr(ds_fone_adic_w,1,qt_length_w -3);
					else
						ds_fone_adic_p	:= substr(ds_fone_adic_w,1,qt_length_w);
					end if;
					
				end if;	
			else
				ds_endereco_p := 'N/D';
				nr_endereco_p := 'N/D';
				ds_complemento_p := 'N/D';
				ds_bairro_p := 'N/D';
				cd_cep_p := 'N/D';
				nr_telefone_p := 'N/D';
				ds_email_p := 'N/D';
				ds_website_p := 'N/D';
				nr_ddi_telefone_w := 'N/D';
				nr_ddd_telefone_w := 'N/D';
				nr_ramal_p := null;
				cd_municipio_ibge_p := 'N/D';
				sg_estado_p := 'N/';
				ds_fax_p := 'N/D';
				nr_ddd_fax_p := 'N/D';
				ds_municipio_p := 'N/D';
			end if;
		
		end if;
		
		if (nr_seq_tipo_logradouro_w IS NOT NULL AND nr_seq_tipo_logradouro_w::text <> '') then
				select 	ds_tipo_logradouro|| ' '||ds_endereco_p
				into STRICT 	ds_tipo_logradouro_w
				from	cns_tipo_logradouro
				where	nr_sequencia = nr_seq_tipo_logradouro_w;
				
				if (ds_tipo_logradouro_w IS NOT NULL AND ds_tipo_logradouro_w::text <> '') then
				
					ds_endereco_p := ds_tipo_logradouro_w;
					
				end if;
				
		end if;
		
	end if;
else
	if (ie_tipo_compl_prest_p = 'PJ') then
		cd_cgc_w	:= cd_cgc_p;
	else
		cd_pessoa_fisica_w	:= cd_pessoa_fisica_p;
	end if;
	
	select	substr(obter_dados_pf_pj(cd_pessoa_fisica_w, cd_cgc_w, 'LO') ||
		CASE WHEN coalesce(obter_dados_pf_pj(cd_pessoa_fisica_w, cd_cgc_w, 'LO')::text, '') = '' THEN null  ELSE ' ' END  ||
		obter_dados_pf_pj(cd_pessoa_fisica_w, cd_cgc_w, 'EN'),1,255),
		substr(obter_dados_pf_pj(cd_pessoa_fisica_w, cd_cgc_w, 'NR'),1,5),
		substr(obter_dados_pf_pj(cd_pessoa_fisica_w, cd_cgc_w, 'CO'),1,255),
		substr(obter_dados_pf_pj(cd_pessoa_fisica_w, cd_cgc_w, 'B'),1,40),
		substr(obter_dados_pf_pj(cd_pessoa_fisica_w, cd_cgc_w, 'CEP'),1,15),
		substr(obter_dados_pf_pj(cd_pessoa_fisica_w, cd_cgc_w, 'T'),1,15),
		substr(obter_dados_pf_pj(cd_pessoa_fisica_w, cd_cgc_w, 'M'),1,255),
		substr(obter_dados_pf_pj(cd_pessoa_fisica_w, cd_cgc_w, 'WS'),1,255),
		substr(obter_dados_pf_pj(cd_pessoa_fisica_w, cd_cgc_w, 'DIT'),1,3),
		substr(obter_dados_pf_pj(cd_pessoa_fisica_w, cd_cgc_w, 'DDT'),1,3),
		null,
		substr(obter_dados_pf_pj(cd_pessoa_fisica_w, cd_cgc_w, 'CDM'),1,6),
		substr(obter_dados_pf_pj(cd_pessoa_fisica_w, cd_cgc_w, 'UF'),1,2),
		substr(obter_dados_pf_pj(cd_pessoa_fisica_w, cd_cgc_w, 'FAX'),1,80),
		substr(obter_dados_pf_pj(cd_pessoa_fisica_w, cd_cgc_w, 'DDF'),1,3),
		substr(obter_dados_pf_pj(cd_pessoa_fisica_w, cd_cgc_w, 'CI'),1,40),
		substr(obter_dados_pf_pj(cd_pessoa_fisica_w, null, 'TA'),1,255)
	into STRICT	ds_endereco_p,
		nr_endereco_p,
		ds_complemento_p,
		ds_bairro_p,
		cd_cep_p,
		nr_telefone_p,
		ds_email_p,
		ds_website_p,
		nr_ddi_telefone_w,
		nr_ddd_telefone_w,
		nr_ramal_p,
		cd_municipio_ibge_p,
		sg_estado_p,
		ds_fax_p,
		nr_ddd_fax_p,
		ds_municipio_p,
		ds_fone_adic_w
	;
	
	if	((	coalesce(ie_origem_p, 'T') = 'W') and (	coalesce(ie_fone_princ_w, 'N') = 'N')) or ( 	coalesce(ie_origem_p, 'T') = 'T') then
		open C01;
		loop
		fetch C01 into	
			ds_fone_adic_aux_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			if (length(ds_fone_adic_w || ds_fone_adic_aux_w) < 255) then
					
				ds_fone_adic_w	:= ds_fone_adic_w || ' / ' || ds_fone_adic_aux_w;
				
				if (substr(ds_fone_adic_w,1,3) = ' / ') then
					ds_fone_adic_w := substr(ds_fone_adic_w,4,255);
				end if;
				
			end if;
			end;
		end loop;
		close C01;
		
		qt_length_w := length(ds_fone_adic_w);
		
		if (substr(ds_fone_adic_w, qt_length_w -2, qt_length_w) = ' / ') then
			ds_fone_adic_p	:= substr(ds_fone_adic_w,1,qt_length_w -3);
		else
			ds_fone_adic_p	:= substr(ds_fone_adic_w,1,qt_length_w);
		end if;
	end if;	
end if;

nr_tel_simples_w	:= nr_telefone_w;
nr_ddd_simples_w	:= nr_ddd_telefone_w;

if (ie_compl_pj_adic_p = 'S') then
	nr_ddd_fax_p		:= nr_ddd_simples_w;
end if;

if (nr_ddi_telefone_w IS NOT NULL AND nr_ddi_telefone_w::text <> '') then
	nr_ddi_telefone_p	:= '(' || nr_ddi_telefone_w || ') ';
end if;

if (nr_ddd_telefone_w IS NOT NULL AND nr_ddd_telefone_w::text <> '') then
	nr_ddd_telefone_p	:= '(' || nr_ddd_telefone_w || ') ';
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_dados_end_prest_gm ( cd_pessoa_fisica_p text, cd_cgc_p text, ie_tipo_compl_prest_p text, ie_compl_pj_adic_p text, nr_seq_compl_adic_p bigint, nr_seq_tipo_compl_adic_p bigint, ie_origem_p text, ds_endereco_p INOUT text, nr_endereco_p INOUT text, ds_complemento_p INOUT text, ds_bairro_p INOUT text, cd_cep_p INOUT text, nr_telefone_p INOUT text, ds_email_p INOUT text, ds_website_p INOUT text, nr_ddi_telefone_p INOUT text, nr_ddd_telefone_p INOUT text, nr_ramal_p INOUT bigint, cd_municipio_ibge_p INOUT text, sg_estado_p INOUT text, ds_fax_p INOUT text, nr_ddd_fax_p INOUT text, ds_municipio_p INOUT text, ds_fone_adic_p INOUT text) FROM PUBLIC;

