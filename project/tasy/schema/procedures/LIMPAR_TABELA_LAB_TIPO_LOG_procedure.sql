-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE limpar_tabela_lab_tipo_log () AS $body$
DECLARE


cd_log_tasy_w		bigint;
qt_dia_log_tasy_w	bigint;
s_array 		LT_DATE;
i			integer := 1;
type Vetor is table of LT_DATE index by integer;
Vetor_c01_w		Vetor;
dt_inicial_w		timestamp := to_Date('01/01/1900','dd/mm/yyyy');
dt_final_w		timestamp;

c01 CURSOR FOR
	SELECT	tlt.cd_log,
		tlt.qt_dias_base
	from	lab_tipo_log tlt
	where	(tlt.qt_dias_base IS NOT NULL AND tlt.qt_dias_base::text <> '');

C02 CURSOR FOR
	SELECT *
	from (
		SELECT	a.dt_atualizacao
		from	log_lab a
		where	a.dt_atualizacao between dt_inicial_w and dt_final_w
		and	a.cd_log = cd_log_tasy_w
	) alias0 LIMIT 99999;


BEGIN

CALL gravar_processo_longo('Vetor Principal', 'LIMPAR_TABELA_LAB_TIPO_LOG', -1);

open c01;
loop
fetch c01 into
	cd_log_tasy_w,
	qt_dia_log_tasy_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	dt_final_w := clock_timestamp() - qt_dia_log_tasy_w;
	CALL gravar_processo_longo('LOG_TASY','LIMPAR_TABELA_LAB_TIPO_LOG',-1);

	/*TRATAMENTO ESPECÃŒFICO DEVIDO AO VOLUME DE DADOS*/

	CALL exec_sql_dinamico('Tasy','ALTER TABLE LOG_LAB NOLOGGING');
	open c02;
	loop
	FETCH C02 BULK COLLECT INTO s_array LIMIT 100;
		Vetor_c01_w(i) := s_array;
		i := i + 1;
	EXIT WHEN NOT FOUND; /* apply on C02 */
	END LOOP;
	CLOSE C02;

	for i in 1..Vetor_c01_w.COUNT loop
		s_array := Vetor_c01_w(i);

		CALL gravar_processo_longo('Removendo LOG_LAB -> ' || i || '/' || Vetor_c01_w.COUNT,'LIMPAR_TABELA_LAB_TIPO_LOG',-1);

		delete	from	log_lab
		where	dt_atualizacao in ( SELECT column_value from table(cast(s_array as LT_DATE)))
		and	cd_log = cd_log_tasy_w;

		commit;
	end LOOP;

	CALL exec_sql_dinamico('Tasy','ALTER TABLE LOG_LAB LOGGING');

	exception
	when others then
		CALL exec_sql_dinamico('Tasy','ALTER TABLE LOG_LAB LOGGING');
	end;
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE limpar_tabela_lab_tipo_log () FROM PUBLIC;

