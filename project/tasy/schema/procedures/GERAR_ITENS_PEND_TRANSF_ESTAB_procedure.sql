-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_itens_pend_transf_estab ( nr_ordem_compra_p bigint, nr_seq_pendencia_p bigint, qt_material_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_item_oci_w		integer;
cd_material_w		integer;
cd_unidade_medida_w	varchar(30);
dt_entrega_w		timestamp;
cd_local_estoque_w	smallint;


BEGIN 
select	coalesce(dt_entrega,clock_timestamp()), 
	a.cd_unidade_medida, 
	b.cd_material, 
	coalesce(b.cd_local_estoque, c.cd_local_entrega) 
into STRICT	dt_entrega_w, 
	cd_unidade_medida_w, 
	cd_material_w, 
	cd_local_estoque_w 
from	ordem_compra c, 
	ordem_compra_item b, 
	sup_pendencia_transf_estab a 
where	c.nr_ordem_compra = b.nr_ordem_compra 
and	a.nr_ordem_compra = b.nr_ordem_compra 
and	a.nr_item_oci = b.nr_item_oci 
and	a.nr_sequencia = nr_seq_pendencia_p;
 
select	coalesce(max(nr_item_oci),0) + 1 
into STRICT	nr_item_oci_w 
from	ordem_compra_item 
where	nr_ordem_compra = nr_ordem_compra_p;
 
insert into ordem_compra_item( 
	nr_ordem_compra, 
	nr_item_oci, 
	cd_material, 
	qt_material, 
	qt_original, 
	vl_unitario_material, 
	dt_atualizacao, 
	nm_usuario, 
	cd_unidade_medida_compra, 
	cd_local_estoque, 
	ie_situacao, 
	nr_seq_pendencia_transf, 
	vl_total_item) 
values (	nr_ordem_compra_p, 
	nr_item_oci_w, 
	cd_material_w, 
	qt_material_p, 
	qt_material_p, 
	0, 
	clock_timestamp(), 
	nm_usuario_p, 
	cd_unidade_medida_w, 
	cd_local_estoque_w, 
	'A', 
	nr_seq_pendencia_p, 
	round((qt_material_p * 0)::numeric,4));	
 
insert into ordem_compra_item_entrega( 
	nr_ordem_compra, 
	nr_item_oci, 
	qt_prevista_entrega, 
	dt_prevista_entrega, 
	nm_usuario, 
	dt_atualizacao, 
	nr_sequencia) 
values (nr_ordem_compra_p, 
	nr_item_oci_w, 
	qt_material_p, 
	dt_entrega_w, 
	nm_usuario_p, 
	clock_timestamp(), 
	nextval('ordem_compra_item_entrega_seq'));
 
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_itens_pend_transf_estab ( nr_ordem_compra_p bigint, nr_seq_pendencia_p bigint, qt_material_p bigint, nm_usuario_p text) FROM PUBLIC;

