-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_atepacu ( dt_parametro_p timestamp, ie_opcao_p text) AS $body$
DECLARE


rowid_w		oid;
nr_sequencia_w	bigint;
nr_reg_w		bigint;

retorno_w		bigint;

C01 CURSOR FOR
SELECT oid
from 	Procedimento_Paciente
where dt_procedimento between trunc(dt_parametro_p,'month') and
			trunc(add_months(dt_parametro_p,1),'month') + 86399/86400
and coalesce(nr_seq_atepacu::text, '') = ''
and ie_opcao_p	= 'P'

union

select oid
from 	Procedimento_Paciente
where  	coalesce(nr_seq_atepacu::text, '') = ''
and 	ie_opcao_p	= 'TP';

C02 CURSOR FOR
SELECT oid
from 	Material_Atend_Paciente
where dt_atendimento between trunc(dt_parametro_p,'month') and
					trunc(add_months(dt_parametro_p,1),'month') + 86399/86400
and coalesce(nr_seq_atepacu::text, '') = ''
and ie_opcao_p	= 'M'

union

select oid
from 	Material_Atend_Paciente
where coalesce(nr_seq_atepacu::text, '') = '' 
and 	ie_opcao_p	= 'TM' LIMIT 9999;



BEGIN

OPEN C01;
LOOP
FETCH C01 into	rowid_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	update procedimento_paciente a
	set	nr_seq_atepacu	=
		(SELECT nr_seq_interno
		from atend_paciente_unidade b
		where a.nr_atendimento = b.nr_atendimento
		  and	a.dt_entrada_unidade	= b.dt_entrada_unidade)
	where rowid = rowid_w;
	end;
END LOOP;
close c01;

commit;

/* Atend Paciente_unidade */

OPEN C02;
LOOP
FETCH C02 into	rowid_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	update material_atend_paciente a
	set	nr_seq_atepacu	=
		(SELECT nr_seq_interno
		from atend_paciente_unidade b
		where a.nr_atendimento = b.nr_atendimento
		  and	a.dt_entrada_unidade	= b.dt_entrada_unidade)
	where rowid = rowid_w;
	end;
END LOOP;
close c02;
commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_atepacu ( dt_parametro_p timestamp, ie_opcao_p text) FROM PUBLIC;

