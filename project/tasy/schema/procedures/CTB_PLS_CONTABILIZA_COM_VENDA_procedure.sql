-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_pls_contabiliza_com_venda ( nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text) AS $body$
DECLARE


qt_contab_comissao_w			smallint;
qt_contab_repasse_w			smallint;
cd_tipo_lote_contabil_w                 bigint;


BEGIN
/*Validacao para impedir a geracao em lotes incorretos */

if (ie_exclusao_p <> 'S') then
        select b.cd_tipo_lote_contabil
        into STRICT cd_tipo_lote_contabil_w
        from lote_contabil b
        where b.nr_lote_contabil = nr_lote_contabil_p;
        if (cd_tipo_lote_contabil_w <> 24) then
                CALL wheb_mensagem_pck.exibir_mensagem_abort(261346);
        end if;
end if;
begin
	select	CASE WHEN coalesce(upper(ds_valor_parametro),'GV')='GV' THEN 1 WHEN coalesce(upper(ds_valor_parametro),'GV')='A' THEN 1  ELSE 0 END  qt_contab_repasse,
		CASE WHEN coalesce(upper(ds_valor_parametro),'GV')='CV' THEN 1 WHEN coalesce(upper(ds_valor_parametro),'GV')='A' THEN 1  ELSE 0 END  qt_contab_comissao
	into STRICT	qt_contab_repasse_w,
		qt_contab_comissao_w
	from	lote_contabil_parametro
	where	nr_lote_contabil	= nr_lote_contabil_p
	and	nr_seq_parametro	= 1;
exception
when others then
	qt_contab_repasse_w	:= 1;
	qt_contab_comissao_w	:= 0;
end;

/*Nao alterar a ordem das rotinas!!*/

if (qt_contab_repasse_w > 0) then
	ds_retorno_p := ctb_pls_contab_desp_repasse(nr_lote_contabil_p, nm_usuario_p, ie_exclusao_p, ds_retorno_p);
end if;

if (qt_contab_comissao_w > 0) then
	ds_retorno_p := ctb_pls_contabilizar_comissao(nr_lote_contabil_p, nm_usuario_p, ie_exclusao_p, ds_retorno_p);
end if;

if (ie_exclusao_p = 'N') then
	CALL agrupa_movimento_contabil(	nr_lote_contabil_p,
					nm_usuario_p);
end if;

if (coalesce(ds_retorno_p::text, '') = '') then
	begin
	update	lote_contabil
	set	ie_situacao 		= 'A',
		dt_geracao_lote		= CASE WHEN ie_exclusao_p='N' THEN clock_timestamp() WHEN ie_exclusao_p='S' THEN null END
	where	nr_lote_contabil 	= nr_lote_contabil_p;
	
	if (ie_exclusao_p = 'S') then
		ds_retorno_p	:= wheb_mensagem_pck.get_texto(298774);

		CALL ctb_gravar_log_lote(	nr_lote_contabil_p,
					2,
					'',
					nm_usuario_p);
	else
		ds_retorno_p	:= wheb_mensagem_pck.get_texto(298775);

		CALL ctb_gravar_log_lote(	nr_lote_contabil_p,
					1,
					wheb_mensagem_pck.get_texto(1097175),
					nm_usuario_p);
	end if;
	
	commit;
	end;
else
	rollback;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_pls_contabiliza_com_venda ( nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text) FROM PUBLIC;

