-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualiza_reg_contab_item ( nr_seq_item_ref_p pls_conta_pos_estabelecido.nr_sequencia%type, ie_opcao_p text, ie_atualiza_val_adic_p text, ie_tipo_item_pos_p text default null, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type DEFAULT NULL, nm_usuario_p usuario.nm_usuario%type DEFAULT NULL) AS $body$
DECLARE


dt_mes_competencia_w		pls_protocolo_conta.dt_mes_competencia%type;
dt_inicio_w			pls_protocolo_conta.dt_mes_competencia%type;
dt_fim_w			pls_protocolo_conta.dt_mes_competencia%type;
nr_seq_conta_w			pls_conta.nr_sequencia%type;
nr_seq_conta_proc_w		pls_conta_proc.nr_sequencia%type;
nr_seq_conta_mat_w		pls_conta_mat.nr_sequencia%type;
ds_tipo_lote_contabil_w		tipo_lote_contabil.ds_tipo_lote_contabil%type;
qt_reg_w			integer := 0;
ie_origem_protocolo_w		pls_protocolo_conta.ie_origem_protocolo%type;
ie_atualiza_val_adic_w		varchar(1);
nr_seq_proc_rec_w		pls_rec_glosa_proc.nr_sequencia%type;
nr_seq_mat_rec_w		pls_rec_glosa_mat.nr_sequencia%type;
nr_seq_proc_disc_w		pls_discussao_proc.nr_sequencia%type;
nr_seq_mat_disc_w		pls_discussao_mat.nr_sequencia%type;
ie_novo_pos_w			pls_visible_false.ie_novo_pos_estab%type;
	
C01 CURSOR(	nr_seq_conta_proc_pc		pls_conta_proc.nr_sequencia%type,
		nr_seq_conta_mat_pc		pls_conta_mat.nr_sequencia%type,
		nr_seq_conta_pc			pls_conta.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia,
		(SELECT	max(x.nr_sequencia)
		 from	pls_conta_medica_resumo x
		 where	nr_seq_conta		= a.nr_seq_conta
		 and	nr_seq_conta_proc	= a.nr_seq_conta_proc
		 and	ie_situacao		= 'A') nr_seq_conta_resumo
	from	pls_conta_pos_estab_contab a
	where	a.nr_seq_conta_proc = nr_seq_conta_proc_pc
	and	a.nr_seq_conta	= nr_seq_conta_pc
	and	(a.nr_seq_conta_resumo IS NOT NULL AND a.nr_seq_conta_resumo::text <> '')
	and	not exists ( 	select  1
				from 	pls_conta_medica_resumo  x
				where	x.nr_sequencia	= a.nr_seq_conta_resumo
				and	x.nr_seq_conta  = a.nr_seq_conta)
	and	coalesce(nr_seq_conta_mat_pc::text, '') = ''
	
union all

	select	a.nr_sequencia,
		(select	max(x.nr_sequencia)
		 from	pls_conta_medica_resumo x
		 where	x.nr_seq_conta		= a.nr_seq_conta
		 and	x.nr_seq_conta_mat	= a.nr_seq_conta_mat
		 and	x.ie_situacao		= 'A') nr_seq_conta_resumo
	from	pls_conta_pos_estab_contab a
	where	a.nr_seq_conta_mat = nr_seq_conta_mat_pc
	and	a.nr_seq_conta	= nr_seq_conta_pc
	and	(a.nr_seq_conta_resumo IS NOT NULL AND a.nr_seq_conta_resumo::text <> '')
	and	not exists ( 	select  1
				from 	pls_conta_medica_resumo  x
				where	x.nr_sequencia	= a.nr_seq_conta_resumo
				and	x.nr_seq_conta  = a.nr_seq_conta)
	and	coalesce(nr_seq_conta_proc_pc::text, '') = '';
	
C02 CURSOR(	nr_seq_conta_proc_pc		pls_conta_proc.nr_sequencia%type,
		nr_seq_conta_mat_pc		pls_conta_mat.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia,
		(SELECT	max(x.nr_sequencia)
		 from	pls_conta_medica_resumo x
		 where	nr_seq_conta		= a.nr_seq_conta
		 and	nr_seq_conta_proc	= b.nr_seq_conta_proc
		 and	ie_situacao		= 'A') nr_seq_conta_resumo
	from	pls_conta_copartic_contab a,
		pls_conta_coparticipacao b
	where	b.nr_sequencia = a.nr_seq_conta_copartic
	and	b.nr_seq_conta_proc = nr_seq_conta_proc_pc
	and	(a.nr_seq_conta_resumo IS NOT NULL AND a.nr_seq_conta_resumo::text <> '')
	and	not exists ( 	select  1
				from 	pls_conta_medica_resumo  x
				where	x.nr_sequencia	= a.nr_seq_conta_resumo
				and	x.nr_seq_conta  = a.nr_seq_conta)
	and	coalesce(nr_seq_conta_mat_pc::text, '') = ''
	
union all

	select	a.nr_sequencia,
		(select	max(x.nr_sequencia)
		 from	pls_conta_medica_resumo x
		 where	x.nr_seq_conta		= a.nr_seq_conta
		 and	x.nr_seq_conta_mat	= b.nr_seq_conta_mat
		 and	x.ie_situacao		= 'A') nr_seq_conta_resumo
	from	pls_conta_copartic_contab a,
		pls_conta_coparticipacao b
	where	b.nr_sequencia = a.nr_seq_conta_copartic
	and	b.nr_seq_conta_mat = nr_seq_conta_mat_pc
	and	(a.nr_seq_conta_resumo IS NOT NULL AND a.nr_seq_conta_resumo::text <> '')
	and	not exists ( 	select  1
				from 	pls_conta_medica_resumo  x
				where	x.nr_sequencia	= a.nr_seq_conta_resumo
				and	x.nr_seq_conta  = a.nr_seq_conta)
	and	coalesce(nr_seq_conta_proc_pc::text, '') = '';
	
C03 CURSOR(	nr_seq_conta_proc_pc		pls_conta_proc.nr_sequencia%type,
		nr_seq_conta_mat_pc		pls_conta_mat.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia,
		(SELECT	max(x.nr_sequencia)
		 from	pls_conta_medica_resumo x
		 where	nr_seq_conta		= a.nr_seq_conta
		 and	nr_seq_conta_proc	= c.nr_seq_conta_proc
		 and	ie_situacao		= 'A') nr_seq_conta_resumo
	from	pls_conta_pos_taxa_contab a,
		pls_conta_pos_estab_taxa b,
		pls_conta_pos_estabelecido c
	where	c.nr_sequencia = b.nr_seq_conta_pos_estab
	and	b.nr_sequencia = a.nr_seq_pos_estab_taxa
	and	c.nr_seq_conta_proc = nr_seq_conta_proc_pc
	and	(a.nr_seq_conta_resumo IS NOT NULL AND a.nr_seq_conta_resumo::text <> '')
	and	not exists ( 	select  1
				from 	pls_conta_medica_resumo  x
				where	x.nr_sequencia	= a.nr_seq_conta_resumo
				and	x.nr_seq_conta  = a.nr_seq_conta)
	and	coalesce(nr_seq_conta_mat_pc::text, '') = ''
	
union all

	select	a.nr_sequencia,
		(select	max(x.nr_sequencia)
		 from	pls_conta_medica_resumo x
		 where	x.nr_seq_conta		= a.nr_seq_conta
		 and	x.nr_seq_conta_mat	= c.nr_seq_conta_mat
		 and	x.ie_situacao		= 'A') nr_seq_conta_resumo
	from	pls_conta_pos_taxa_contab a,
		pls_conta_pos_estab_taxa b,
		pls_conta_pos_estabelecido c
	where	c.nr_sequencia = b.nr_seq_conta_pos_estab
	and	b.nr_sequencia = a.nr_seq_pos_estab_taxa
	and	c.nr_seq_conta_mat = nr_seq_conta_mat_pc
	and	(a.nr_seq_conta_resumo IS NOT NULL AND a.nr_seq_conta_resumo::text <> '')
	and	not exists ( 	select  1
				from 	pls_conta_medica_resumo  x
				where	x.nr_sequencia	= a.nr_seq_conta_resumo
				and	x.nr_seq_conta  = a.nr_seq_conta)
	and	coalesce(nr_seq_conta_proc_pc::text, '') = '';
	
C04 CURSOR(	nr_seq_conta_proc_pc		pls_conta_proc.nr_sequencia%type,
		nr_seq_conta_mat_pc		pls_conta_mat.nr_sequencia%type) FOR
	SELECT	'P' ie_tipo_item,
		a.nr_sequencia,
		(SELECT	max(x.nr_sequencia)
		 from	pls_conta_medica_resumo x
		 where	nr_seq_conta		= b.nr_seq_conta
		 and	nr_seq_conta_proc	= b.nr_seq_conta_proc
		 and	ie_situacao		= 'A') nr_seq_conta_resumo
	from	pls_conta_pos_proc_contab	a,
		pls_conta_pos_proc		b
	where	a.nr_seq_conta_pos_proc = b.nr_sequencia
	and	(a.nr_seq_conta_resumo IS NOT NULL AND a.nr_seq_conta_resumo::text <> '')
	and	b.nr_seq_conta_proc = nr_seq_conta_proc_pc
	and	not exists ( 	select  1
				from 	pls_conta_medica_resumo  x
				where	x.nr_sequencia	= a.nr_seq_conta_resumo
				and	x.nr_seq_conta  = a.nr_seq_conta)
	and	coalesce(nr_seq_conta_mat_pc::text, '') = ''
	
union all

	select	'M' ie_tipo_item,
		a.nr_sequencia,
		(select	max(x.nr_sequencia)
		 from	pls_conta_medica_resumo x
		 where	x.nr_seq_conta		= b.nr_seq_conta
		 and	x.nr_seq_conta_mat	= b.nr_seq_conta_mat
		 and	x.ie_situacao		= 'A') nr_seq_conta_resumo
	from	pls_conta_pos_mat_contab a,
		pls_conta_pos_mat b
	where	a.nr_seq_conta_mat_pos = b.nr_sequencia
	and	(a.nr_seq_conta_resumo IS NOT NULL AND a.nr_seq_conta_resumo::text <> '')
	and	b.nr_seq_conta_mat = nr_seq_conta_mat_pc
	and	not exists ( 	select  1
				from 	pls_conta_medica_resumo  x
				where	x.nr_sequencia	= a.nr_seq_conta_resumo
				and	x.nr_seq_conta  = a.nr_seq_conta)
	and	coalesce(nr_seq_conta_proc_pc::text, '') = '';
	
C05 CURSOR(	nr_seq_conta_proc_pc		pls_conta_proc.nr_sequencia%type,
		nr_seq_conta_mat_pc		pls_conta_mat.nr_sequencia%type) FOR
	SELECT	'P' ie_tipo_item,
		a.nr_sequencia,
		(SELECT	max(x.nr_sequencia)
		 from	pls_conta_medica_resumo x
		 where	nr_seq_conta		= a.nr_seq_conta
		 and	nr_seq_conta_proc	= c.nr_seq_conta_proc
		 and	ie_situacao		= 'A') nr_seq_conta_resumo
	from	pls_conta_pos_proc_contab a,
		pls_conta_pos_proc_tx_ctb b,
		pls_conta_pos_proc c
	where	a.nr_sequencia = b.nr_seq_pos_proc_ctb
	and	c.nr_sequencia = a.nr_seq_conta_pos_proc
	and	c.nr_seq_conta_proc = nr_seq_conta_proc_pc
	and	(b.nr_seq_conta_resumo IS NOT NULL AND b.nr_seq_conta_resumo::text <> '')
	and	not exists ( 	select  1
				from 	pls_conta_medica_resumo  x
				where	x.nr_sequencia	= b.nr_seq_conta_resumo
				and	x.nr_seq_conta  = c.nr_seq_conta)
	and	coalesce(nr_seq_conta_mat_pc::text, '') = ''
	
union all

	select	'M' ie_tipo_item,
		a.nr_sequencia,
		(select	max(x.nr_sequencia)
		 from	pls_conta_medica_resumo x
		 where	x.nr_seq_conta		= a.nr_seq_conta
		 and	x.nr_seq_conta_mat	= c.nr_seq_conta_mat
		 and	x.ie_situacao		= 'A') nr_seq_conta_resumo
	from	pls_conta_pos_mat_contab a,
		pls_conta_pos_mat_tx_ctb b,
		pls_conta_pos_mat c
	where	a.nr_sequencia = b.nr_seq_pos_mat_ctb
	and	c.nr_sequencia = a.nr_seq_conta_mat_pos
	and	c.nr_seq_conta_mat = nr_seq_conta_mat_pc
	and	(a.nr_seq_conta_resumo IS NOT NULL AND a.nr_seq_conta_resumo::text <> '')
	and	not exists ( 	select  1
				from 	pls_conta_medica_resumo  x
				where	x.nr_sequencia	= b.nr_seq_conta_resumo
				and	x.nr_seq_conta  = c.nr_seq_conta)
	and	coalesce(nr_seq_conta_proc_pc::text, '') = '';
	
BEGIN
ie_atualiza_val_adic_w := coalesce(ie_atualiza_val_adic_p,'S');

select 	coalesce(max(ie_novo_pos_estab),'N')
into STRICT	ie_novo_pos_w
from	pls_visible_false;

if ( ie_opcao_p = 'P') then
	
	if ( ie_novo_pos_w = 'S') then
		
		if (coalesce(ie_tipo_item_pos_p,'X') = 'P') then
		
			select	a.dt_mes_competencia,
				a.ie_origem_protocolo,
				c.nr_seq_conta,
				c.nr_seq_conta_proc,
				c.nr_seq_proc_rec,		
				c.nr_seq_disc_proc
			into STRICT	dt_mes_competencia_w,
				ie_origem_protocolo_w,
				nr_seq_conta_w,
				nr_seq_conta_proc_w,
				nr_seq_proc_rec_w,
				nr_seq_proc_disc_w
			from	pls_protocolo_conta a,
				pls_conta b,
				pls_conta_pos_proc c
			where	a.nr_sequencia = b.nr_seq_protocolo
			and	b.nr_sequencia = c.nr_seq_conta
			and	c.nr_sequencia = nr_seq_item_ref_p;
		
		elsif (coalesce(ie_tipo_item_pos_p,'X') = 'M') then
		
			select	a.dt_mes_competencia,
				a.ie_origem_protocolo,
				c.nr_seq_conta,
				c.nr_seq_conta_mat,
				c.nr_seq_mat_rec,
				c.nr_seq_disc_mat
			into STRICT	dt_mes_competencia_w,
				ie_origem_protocolo_w,
				nr_seq_conta_w,
				nr_seq_conta_mat_w,
				nr_seq_mat_rec_w,
				nr_seq_mat_disc_w
			from	pls_protocolo_conta a,
				pls_conta b,
				pls_conta_pos_mat c
			where	a.nr_sequencia = b.nr_seq_protocolo
			and	b.nr_sequencia = c.nr_seq_conta
			and	c.nr_sequencia = nr_seq_item_ref_p;
		
		end if;
		
	else
		select	a.dt_mes_competencia,
			a.ie_origem_protocolo,
			c.nr_seq_conta,
			c.nr_seq_conta_proc,
			c.nr_seq_conta_mat,
			c.nr_seq_proc_rec,
			c.nr_seq_mat_rec,
			c.nr_seq_disc_proc,
			c.nr_seq_disc_mat
		into STRICT	dt_mes_competencia_w,
			ie_origem_protocolo_w,
			nr_seq_conta_w,
			nr_seq_conta_proc_w,
			nr_seq_conta_mat_w,
			nr_seq_proc_rec_w,
			nr_seq_mat_rec_w,
			nr_seq_proc_disc_w,
			nr_seq_mat_disc_w
		from	pls_protocolo_conta a,
			pls_conta b,
			pls_conta_pos_estabelecido c
		where	a.nr_sequencia = b.nr_seq_protocolo
		and	b.nr_sequencia = c.nr_seq_conta
		and	c.nr_sequencia = nr_seq_item_ref_p;
		
	
	end if;
	
elsif ( ie_opcao_p = 'C') then
	select	a.dt_mes_competencia,
		a.ie_origem_protocolo,
		c.nr_seq_conta,
		c.nr_seq_conta_proc,
		c.nr_seq_conta_mat,
		c.nr_seq_proc_rec,
		c.nr_seq_mat_rec,
		c.nr_seq_disc_proc,
		c.nr_seq_disc_mat
	into STRICT	dt_mes_competencia_w,
		ie_origem_protocolo_w,
		nr_seq_conta_w,
		nr_seq_conta_proc_w,
		nr_seq_conta_mat_w,
		nr_seq_proc_rec_w,
		nr_seq_mat_rec_w,
		nr_seq_proc_disc_w,
		nr_seq_mat_disc_w
	from	pls_protocolo_conta a,
		pls_conta b,
		pls_conta_coparticipacao c
	where	a.nr_sequencia = b.nr_seq_protocolo
	and	b.nr_sequencia = c.nr_seq_conta
	and	c.nr_sequencia = nr_seq_item_ref_p;
end if;
	
dt_inicio_w := trunc(dt_mes_competencia_w, 'mm');
dt_fim_w := fim_mes(dt_mes_competencia_w);

if (dt_inicio_w >= to_date('01/05/2015','DD/MM/YYYY')) then
	select	max(b.ds_tipo_lote_contabil)
	into STRICT	ds_tipo_lote_contabil_w
	from	lote_contabil		a,
		tipo_lote_contabil	b
	where	a.cd_tipo_lote_contabil	= b.cd_tipo_lote_contabil
	and	b.cd_tipo_lote_contabil	in (43,44) /* OPS - Provisao de Faturamento / OPS - Receitas com Faturamento */
	and	a.dt_referencia between dt_inicio_w and dt_fim_w
	and	(a.dt_geracao_lote IS NOT NULL AND a.dt_geracao_lote::text <> '');
end if;

--lrp aquiif	(ds_tipo_lote_contabil_w is not null) then
--	wheb_mensagem_pck.exibir_mensagem_abort(221408, 'DS_TIPO_LOTE_CONTABIL=' || ds_tipo_lote_contabil_w || ';' || 'DT_REFERENCIA=' || to_char(dt_mes_competencia_w,'mm/yyyy'));
--end if;
if (ie_atualiza_val_adic_w = 'S') then

	--Se for pos antigo 
	if (ie_novo_pos_w = 'N' or ie_opcao_p <> 'P') then
		if (ie_opcao_p = 'P') then	
			select	count(1)
			into STRICT	qt_reg_w
			from	pls_conta_pos_estab_contab
			where	nr_seq_conta_pos = nr_seq_item_ref_p
			and	(nr_seq_lote_fat IS NOT NULL AND nr_seq_lote_fat::text <> '');
			
			if (qt_reg_w = 0) then
				if (nr_seq_conta_proc_w IS NOT NULL AND nr_seq_conta_proc_w::text <> '') and (coalesce(nr_seq_proc_disc_w::text, '') = '') then
				
					select	count(1)
					into STRICT	qt_reg_w
					from	pls_fatura_proc		a
					where	a.nr_seq_conta_proc	= nr_seq_conta_proc_w
					and	(a.nr_seq_conta_pos_contab IS NOT NULL AND a.nr_seq_conta_pos_contab::text <> '');
					
				elsif (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') and (coalesce(nr_seq_mat_disc_w::text, '') = '') then
				
					select	count(1)
					into STRICT	qt_reg_w
					from	pls_fatura_mat		a
					where	a.nr_seq_conta_mat	= nr_seq_conta_mat_w
					and	(a.nr_seq_conta_pos_contab IS NOT NULL AND a.nr_seq_conta_pos_contab::text <> '');
				end if;
				
				if (qt_reg_w = 0) then
				
					select	count(1)
					into STRICT	qt_reg_w
					from	pls_conta_pos_estabelecido a,
							pls_lote_faturamento b
					where	a.nr_seq_lote_fat = b.nr_sequencia
					and 	a.nr_sequencia = nr_seq_item_ref_p
					and		(a.nr_seq_lote_fat IS NOT NULL AND a.nr_seq_lote_fat::text <> '')
					and		((a.ie_situacao	= 'A') or (coalesce(a.ie_situacao::text, '') = ''))
					and		b.ie_tipo_lote <> 'A';
				
				end if;
			end if;
			
			if (qt_reg_w > 0) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(736187, 'NR_SEQ_ITEM_REF=' || nr_seq_item_ref_p);
			end if;
		end if;
		
		if (qt_reg_w = 0) then
			CALL pls_gerar_contab_val_adic(	nr_seq_conta_w, nr_seq_conta_proc_w, nr_seq_conta_mat_w,
							nr_seq_proc_rec_w, nr_seq_mat_rec_w, nr_seq_proc_disc_w,
							nr_seq_mat_disc_w, ie_opcao_p,'N',nm_usuario_p);
		end if;
	else
	
		--if	(ie_opcao_p = 'P') then	 So caira aqui se for pos-estabelecido		
		select count(1)
		into STRICT	qt_reg_w
		from (	SELECT  1
			from	pls_conta_pos_proc a,
				pls_conta_pos_proc_contab b
			where 	a.nr_sequencia = b.nr_seq_conta_pos_proc
			and	b.nr_seq_conta_pos_proc = nr_seq_item_ref_p
			and	ie_tipo_item_pos_p = 'P'
			and	(a.nr_seq_lote_fat IS NOT NULL AND a.nr_seq_lote_fat::text <> '')
			
union all

			SELECT  1
			from	pls_conta_pos_mat a,
				pls_conta_pos_mat_contab b
			where 	a.nr_sequencia = b.nr_seq_conta_mat_pos
			and	b.nr_seq_conta_mat_pos = nr_seq_item_ref_p
			and	ie_tipo_item_pos_p = 'M'
			and	(a.nr_seq_lote_fat IS NOT NULL AND a.nr_seq_lote_fat::text <> '')
		) alias3;
		
		
		if (qt_reg_w = 0) then
			if (nr_seq_conta_proc_w IS NOT NULL AND nr_seq_conta_proc_w::text <> '') and (coalesce(nr_seq_proc_disc_w::text, '') = '') then
			
				select	count(1)
				into STRICT	qt_reg_w
				from	pls_fatura_proc		a
				where	a.nr_seq_conta_proc	= nr_seq_conta_proc_w
				and	(a.nr_seq_conta_pos_contab IS NOT NULL AND a.nr_seq_conta_pos_contab::text <> '');
				
			elsif (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') and (coalesce(nr_seq_mat_disc_w::text, '') = '') then
			
				select	count(1)
				into STRICT	qt_reg_w
				from	pls_fatura_mat		a
				where	a.nr_seq_conta_mat	= nr_seq_conta_mat_w
				and	(a.nr_seq_conta_pos_contab IS NOT NULL AND a.nr_seq_conta_pos_contab::text <> '');
			end if;
			
			if (qt_reg_w = 0) then
			
				select count(1)
				into STRICT	qt_reg_w
				from (	SELECT  1
					from	pls_conta_pos_proc a
					where 	a.nr_sequencia = nr_seq_item_ref_p
					and	(a.nr_seq_lote_fat IS NOT NULL AND a.nr_seq_lote_fat::text <> '')
					and	ie_tipo_item_pos_p = 'P'
					
union all

					SELECT  1
					from	pls_conta_pos_mat a
					where 	a.nr_sequencia = nr_seq_item_ref_p
					and	(a.nr_seq_lote_fat IS NOT NULL AND a.nr_seq_lote_fat::text <> '')
					and	ie_tipo_item_pos_p = 'M'
				) alias4;
			
			end if;
		end if;
		
		if (qt_reg_w > 0) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(736187, 'NR_SEQ_ITEM_REF=' || nr_seq_item_ref_p);
		end if;
		--end if;
		
		if (qt_reg_w = 0) then
			CALL pls_pos_estabelecido_pck.gerar_valores_adicionais(null, null, null,
									null, null, nr_seq_conta_mat_w, 
									nr_seq_conta_proc_w, 'N', nm_usuario_p, 
									cd_estabelecimento_p);
		
		end if;
	
	end if;
end if;

for r_C02_w in C02(nr_seq_conta_proc_w, nr_seq_conta_mat_w) loop
	
	if (r_C02_w.nr_seq_conta_resumo IS NOT NULL AND r_C02_w.nr_seq_conta_resumo::text <> '') then
		update	pls_conta_copartic_contab
		set	nr_seq_conta_resumo = r_C02_w.nr_seq_conta_resumo
		where	nr_sequencia = r_C02_w.nr_sequencia;
		
		commit;
	end if;
end loop;

if (ie_novo_pos_w = 'N') then
	for r_C01_w in C01(nr_seq_conta_proc_w, nr_seq_conta_mat_w, nr_seq_conta_w) loop
		
		if (r_C01_w.nr_seq_conta_resumo IS NOT NULL AND r_C01_w.nr_seq_conta_resumo::text <> '') then
			update	pls_conta_pos_estab_contab
			set	nr_seq_conta_resumo = r_C01_w.nr_seq_conta_resumo
			where	nr_sequencia = r_C01_w.nr_sequencia;
			
			commit;
		end if;
	end loop;	

	for r_C03_w in C03(nr_seq_conta_proc_w, nr_seq_conta_mat_w) loop
		
		if (r_C03_w.nr_seq_conta_resumo IS NOT NULL AND r_C03_w.nr_seq_conta_resumo::text <> '') then
			update	pls_conta_pos_taxa_contab
			set	nr_seq_conta_resumo = r_C03_w.nr_seq_conta_resumo
			where	nr_sequencia = r_C03_w.nr_sequencia;
			
			commit;
		end if;
	end loop;
else

	for r_C04_w in C04(nr_seq_conta_proc_w, nr_seq_conta_mat_w) loop
		
		if (r_C04_w.ie_tipo_item =  'P') then
			if (r_C04_w.nr_seq_conta_resumo IS NOT NULL AND r_C04_w.nr_seq_conta_resumo::text <> '') then
				update	pls_conta_pos_proc_contab
				set	nr_seq_conta_resumo 	= r_C04_w.nr_seq_conta_resumo
				where	nr_sequencia 		= r_C04_w.nr_sequencia;
				
				commit;
			end if;
		else
			if (r_C04_w.nr_seq_conta_resumo IS NOT NULL AND r_C04_w.nr_seq_conta_resumo::text <> '') then
				update	pls_conta_pos_mat_contab
				set	nr_seq_conta_resumo 	= r_C04_w.nr_seq_conta_resumo
				where	nr_sequencia 		= r_C04_w.nr_sequencia;
				
				commit;
			end if;
				
		end if;
		
	end loop;

	for r_C05_w in C05(nr_seq_conta_proc_w, nr_seq_conta_mat_w) loop
		
		if (r_C05_w.nr_seq_conta_resumo IS NOT NULL AND r_C05_w.nr_seq_conta_resumo::text <> '') then
			
			if (r_C05_w.ie_tipo_item = 'P') then
				update	pls_conta_pos_proc_tx_ctb
				set	nr_seq_conta_resumo 	= r_C05_w.nr_seq_conta_resumo
				where	nr_sequencia 		= r_C05_w.nr_sequencia;
			else
				update	pls_conta_pos_mat_tx_ctb
				set	nr_seq_conta_resumo 	= r_C05_w.nr_seq_conta_resumo
				where	nr_sequencia 		= r_C05_w.nr_sequencia;
			end if;
			
			commit;
		end if;
	end loop;
	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualiza_reg_contab_item ( nr_seq_item_ref_p pls_conta_pos_estabelecido.nr_sequencia%type, ie_opcao_p text, ie_atualiza_val_adic_p text, ie_tipo_item_pos_p text default null, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type DEFAULT NULL, nm_usuario_p usuario.nm_usuario%type DEFAULT NULL) FROM PUBLIC;

