-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_resumo_geral_setor ( dt_parametro_p timestamp, nm_usuario_p text) AS $body$
DECLARE


cd_estabelecimento_ww	integer;
cd_estabelecimento_w		integer;
nr_seq_indicador_w		bigint;
cd_setor_atendimento_w		bigint;
vl_indicador_w		double precision;
dt_referencia_w		timestamp;
dt_referencia_ww		timestamp;
nr_sequencia_w		bigint;
nr_dias_w			bigint;
dt_final_w			timestamp;
nr_pac_dia_w			bigint;
nr_total_w			bigint;
X			numeric(20);
C01 CURSOR FOR
/* Ocupação UTI */

SELECT	cd_estabelecimento,
	cd_setor_atendimento,
	365,
 	dividir(sum(nr_leitos_ocupados) * 100 , sum(nr_unidades_setor)) pr_ocupacao
from	eis_ocupacao_setor_v
where	dt_referencia		between dt_referencia_w and last_day(dt_referencia_w)
and	ie_periodo		= 'D'
and	IE_OCUP_HOSPITALAR = 'S'
and	cd_classif_setor	= 4
group by cd_estabelecimento, cd_setor_atendimento;
/*
select	cd_estabelecimento,
	cd_setor_atendimento,
	365,
 	dividir(sum(nr_leitos_ocupados) * 100 , sum(nr_unidades_setor)) pr_ocupacao,
	dt_referencia
from	eis_ocupacao_setor_v
where	dt_referencia		between dt_referencia_w and dt_final_w
and	ie_periodo		= 'D'
and	IE_OCUP_HOSPITALAR = 'S'
and	cd_classif_setor	= 4
group by cd_estabelecimento, dt_referencia,
	 cd_setor_atendimento;
*/
BEGIN

dt_referencia_w		:= trunc(dt_parametro_p,'month');
if (dt_referencia_w = trunc(clock_timestamp(),'month')) then
	dt_final_w	:= trunc(clock_timestamp(),'dd') -1;
else
	dt_final_w	:= last_day( dt_referencia_w );
end if;

nr_dias_w		:= round(last_day(dt_referencia_w) - dt_referencia_w) + 1;

delete from	w_indicador_gestao
where	dt_referencia		between dt_referencia_w and dt_final_w+ 86399/86400;
commit;


open C01;
loop
fetch C01 into
		cd_estabelecimento_w,
		cd_setor_atendimento_w,
		nr_seq_indicador_w,
		vl_indicador_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	select	nextval('w_indicador_gestao_seq')
	into STRICT	nr_sequencia_w
	;

	select	coalesce(max(cd_estabelecimento),0)
	into STRICT	cd_estabelecimento_ww
	from	estabelecimento
	where	cd_estabelecimento = cd_estabelecimento_w;

	if (cd_estabelecimento_ww > 0) then
		begin

		/*if	(nr_seq_indicador_w	= 413) then

			select  sum(decode(nr_seq_indicador, 393, vl_indicador, 0)),
				round(sum(decode(nr_seq_indicador, 412, vl_indicador, 0)))
			into	nr_pac_dia_w,
				nr_total_w
			from 	w_indicador_gestao
			where 	cd_estabelecimento 	= cd_estabelecimento_w
			and 	DT_REFERENCIA 		= dt_referencia_w;

			select	dividir_sem_round((nr_total_w - nr_pac_dia_w), vl_indicador_w)
			into	vl_indicador_w
			from	dual;

		end if; */
		insert into w_indicador_gestao(
			nr_sequencia,
			cd_estabelecimento,
			cd_setor_atendimento,
			dt_atualizacao,
			nm_usuario,
			dt_referencia,
			nr_seq_indicador,
			ie_prev_real,
			ie_periodo,
			vl_indicador)
		values (
			nr_sequencia_w,
			cd_estabelecimento_w,
			cd_setor_atendimento_w,
			clock_timestamp(),
			nm_usuario_p,
			dt_referencia_w,
			nr_seq_indicador_w,
			'R',
			'M',
			vl_indicador_w);

		end;
	end if;
end loop;
close C01;

commit;

CALL Gerar_Resumo_anual_Setor(dt_parametro_p, nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_resumo_geral_setor ( dt_parametro_p timestamp, nm_usuario_p text) FROM PUBLIC;

