-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_livro_aux_ev_liq_co ( nm_usuario_p usuario.nm_usuario%type, cd_empresa_p empresa.cd_empresa%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, dt_inicial_p ctb_livro_auxiliar.dt_inicial%type, dt_final_p ctb_livro_auxiliar.dt_final%type, dt_liberacao_p ctb_livro_auxiliar.dt_liberacao%type, ie_gerar_arquivo_p ctb_livro_auxiliar.ie_tipo_livro_ecd%type, nr_seq_regra_p ctb_livro_auxiliar.nr_sequencia%type) AS $body$
DECLARE

						
nr_contador_w					bigint;
qt_classif_diops_w				bigint;
nr_seq_pag_item_ant_w				bigint;
nr_titulo_ant_w					bigint := 0;
qt_registros_w					bigint := 0;
qt_itens_rateio_w				bigint := 0;
vl_acumulado_w					double precision;
vl_liquido_w					double precision;
vl_titulo_w					double precision;
vl_pagar_w					double precision := 0;
vl_sobra_w					double precision := 0;
vl_pagar_int_w					double precision := 0;
ie_tipo_documento_w				varchar(2);
ds_classif_pel_w				varchar(255);
ds_classif_diops_w				varchar(255);
ds_observacao_w					varchar(255);
ds_observacao_item_w				varchar(255);
nr_seq_event_liq_w				w_ctb_livro_aux_event_liq.nr_sequencia%type;
ie_gerar_ind_classif_w				ctb_livro_auxiliar.ie_gerar_ind_classif%type;
cd_conta_contabil_w				conta_contabil.cd_conta_contabil%type;
ie_tipo_segurado_w				pls_segurado.ie_tipo_segurado%type;
ie_tipo_compartilhamento_w			pls_segurado_repasse.ie_tipo_compartilhamento%type;
ie_tipo_repasse_w				pls_segurado_repasse.ie_tipo_repasse%type;
dt_repasse_w					pls_segurado_repasse.dt_repasse%type;
dt_fim_repasse_w				pls_segurado_repasse.dt_fim_repasse%type;
nr_seq_conta_w					pls_conta.nr_sequencia%type;
nr_seq_resumo_w					pls_conta_medica_resumo.nr_sequencia%type;
ds_erro_w					varchar(255);
ds_local_w					varchar(255);
arq_texto_w					utl_file.file_type;
nm_arquivo_w					varchar(255);
ds_nome_livro_w					varchar(255);
ds_periodo_w					varchar(255);
dt_final_w					timestamp;
ie_data_tipo_segurado_w				pls_parametros.ie_data_tipo_segurado%type;
dt_ref_repasse_w				pls_conta_proc.dt_procedimento%type;

type vetor_ctb_livro_aux_event_liq is table of w_ctb_livro_aux_event_liq%rowtype index by integer;
ctb_livro_aux_event_liq_w	vetor_ctb_livro_aux_event_liq;
								
c_linha CURSOR FOR
	SELECT	a.nm_prestador										|| ';' ||
		a.nr_cpf_cnpj										|| ';' ||
		a.ds_tipo_relacao									|| ';' ||
		a.nr_titulo										|| ';' ||
		a.nr_evento										|| ';' ||
		a.dt_vencimento										|| ';' ||
		a.cd_conta_contabil									|| ';' ||
		substr(ctb_obter_classif_conta(a.cd_conta_contabil, null, dt_final_w),1,255)		|| ';' ||
		a.nr_documento										|| ';' ||
		a.ds_tipo_documento									|| ';' ||
		a.ds_tipo_segurado									|| ';' ||
		substr(pls_obter_se_corresp_assumida(a.ie_tipo_segurado,
			a.nr_contrato),1,255)								|| ';' ||
		a.ds_tipo_contratacao									|| ';' ||
		a.ds_segmentacao									|| ';' ||
		substr(obter_valor_dominio(1669, a.ie_preco),1,255)					|| ';' ||
		substr(pls_obter_se_corresp_assumida(a.ie_tipo_segurado,
			a.nr_protocolo_ans),1,255)							|| ';' ||
		a.dt_conhecimento									|| ';' ||
		a.dt_ocorrencia										|| ';' ||
		a.dt_emissao										|| ';' ||
		a.cd_beneficiario									|| ';' ||
		substr(obter_valor_dominio(6,pls_obter_se_benef_remido(a.nr_seq_segurado,
			a.dt_ocorrencia)),1,255)							|| ';' ||
		a.nm_usuario_evento									|| ';' ||
		a.nm_usuario_princ									|| ';' ||
		substr(pls_obter_se_corresp_assumida(a.ie_tipo_segurado,
			a.nr_cpf_cnpj_adic),1,255)							|| ';' ||
		a.vl_pagar										|| ';' ||
		a.vl_evento										|| ';' ||
		a.dt_contabilizacao									|| ';' ||
		a.ds_classif_pel									|| ';' ||
		a.ds_classif_diops									|| ';' ||
		substr(obter_valor_dominio(3579,a.ie_tipo_evento),1,255)				|| ';' ||
                substr(obter_valor_dominio(3384, a.ie_tipo_repasse), 1,255)                             || ';' ||
                substr(obter_valor_dominio(8980, a.ie_tipo_compartilhamento), 1,255)                    || ';' ||
		a.dt_inicio_compartilhamento								|| ';' ||
		a.dt_fim_compartilhamento								|| ';' ||
		a.ds_observacao ds_linha
	from	w_ctb_livro_aux_event_liq a
	where	a.nr_seq_reg_auxiliar	= nr_seq_regra_p
	order by (nr_documento)::numeric;

c_titulo_conta CURSOR FOR	
	SELECT	t.nr_titulo,
		t.dt_emissao,
		t.dt_vencimento_atual dt_vencimento,
		v.vl_liquido,
		obter_saldo_titulo_pagar(t.nr_titulo,dt_final_w) vl_saldo,
		v.nr_seq_lote,
		t.cd_estabelecimento
	from	pls_lote_protocolo_venc		v,
		titulo_pagar			t
	where	v.nr_titulo	= t.nr_titulo
	and	((coalesce(t.dt_liquidacao::text, '') = '')
	or (t.dt_liquidacao > dt_final_w))
	and  	coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento
	and	t.vl_titulo > 0
	and	t.ie_origem_titulo <> '4'
	and 	t.ie_situacao <> 'C';
	
vet_titulo_conta		c_titulo_conta%rowtype;
	
c_itens_conta CURSOR FOR
	SELECT	'C',
		substr(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'N'),1,255) nm_prestador,
		substr(coalesce(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CPF'),
			pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CGC')),1,20) nr_cpf_cnpj,
		(SELECT	x.ie_tipo_relacao
		from	pls_prestador	x
		where	x.nr_sequencia	= c.nr_seq_prestador_exec) ie_tipo_relacao,
		vet_titulo_conta.nr_titulo,
		l.nr_sequencia nr_seq_lote,
		c.nr_sequencia nr_documento,
		vet_titulo_conta.dt_emissao,
		trunc(coalesce(p.dt_recebimento,p.dt_mes_competencia),'dd') dt_aviso,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_segurado,
		trunc(coalesce(p.dt_recebimento,p.dt_mes_competencia),'dd') dt_contabilizacao,
		coalesce(o.cd_conta_cred,o.cd_conta_provisao_cred) cd_conta_contabil,
		s.nr_sequencia nr_seq_segurado,
		a.ie_tipo_contratacao,
		a.ie_segmentacao,
		t.nr_contrato,
		substr(coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),
			pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')),1,20) nr_cpf_cnpj_adic,
		o.dt_procedimento dt_ocorrencia,
		substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_usuario_princ,
		dividir_sem_round((o.vl_liberado + o.vl_glosa) * vet_titulo_conta.vl_saldo, vet_titulo_conta.vl_liquido) vl_pagar,
		s.nr_seq_pagador,
		c.nr_seq_prestador_exec nr_seq_prestador,
		c.ie_tipo_segurado,
		CASE WHEN a.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
		k.ie_tipo_grupo_ans,
		a.ie_preco,
		p.nr_seq_congenere,
		p.dt_mes_competencia
	FROM pls_prot_conta_titulo u, pls_protocolo_conta p, pls_lote_protocolo l, pls_conta c, pls_plano a, pls_conta_proc o
LEFT OUTER JOIN ans_grupo_despesa k ON (o.nr_seq_grupo_ans = k.nr_sequencia)
, pls_segurado s
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
WHERE p.nr_sequencia	= c.nr_seq_protocolo and p.nr_sequencia	= u.nr_seq_protocolo and u.nr_seq_lote	= l.nr_sequencia and l.nr_sequencia	= vet_titulo_conta.nr_seq_lote and c.nr_sequencia	= o.nr_seq_conta and s.nr_sequencia	= c.nr_seq_segurado and a.nr_sequencia	= s.nr_seq_plano   and l.dt_mes_competencia <= dt_final_w and o.ie_status not in ('D','M') and ((ie_gerar_ind_classif_w <> 'N')
	or (coalesce(o.cd_conta_cred,o.cd_conta_provisao_cred) in (	select c.cd_conta_contabil
									from 	conta_contabil c
									where	c.ie_tipo = 'A'
									and 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '2.1.1'))) and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(c.ie_tipo_segurado,'X'))
	or (coalesce(ie_tipo_segurado_w,'X') = 'X'))									
	
union all

	select	'C',
		substr(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'N'),1,255) nm_prestador,
		substr(coalesce(pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CPF'),
			pls_obter_dados_prestador(c.nr_seq_prestador_exec,'CGC')),1,20) nr_cpf_cnpj,
		(select	x.ie_tipo_relacao
		from	pls_prestador	x
		where	x.nr_sequencia	= c.nr_seq_prestador_exec) ie_tipo_relacao,
		vet_titulo_conta.nr_titulo,
		l.nr_sequencia nr_seq_lote,
		c.nr_sequencia nr_documento,
		vet_titulo_conta.dt_emissao,
		trunc(coalesce(p.dt_recebimento,p.dt_mes_competencia),'dd') dt_aviso,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_segurado,
		trunc(coalesce(p.dt_recebimento,p.dt_mes_competencia),'dd') dt_contabilizacao,
		coalesce(o.cd_conta_cred,o.cd_conta_provisao_cred) cd_conta_contabil,
		s.nr_sequencia nr_seq_segurado,
		a.ie_tipo_contratacao,
		a.ie_segmentacao,
		t.nr_contrato,
		substr(coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),
			pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')),1,20) nr_cpf_cnpj_adic,
		o.dt_atendimento dt_ocorrencia,
		substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_usuario_princ,
		dividir_sem_round((o.vl_liberado + o.vl_glosa) * vet_titulo_conta.vl_saldo, vet_titulo_conta.vl_liquido) vl_pagar,
		s.nr_seq_pagador,
		c.nr_seq_prestador_exec nr_seq_prestador,
		c.ie_tipo_segurado,
		CASE WHEN a.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
		k.ie_tipo_grupo_ans,
		a.ie_preco,
		p.nr_seq_congenere,
		p.dt_mes_competencia
	FROM pls_prot_conta_titulo u, pls_protocolo_conta p, pls_lote_protocolo l, pls_conta c, pls_plano a, pls_conta_mat o
LEFT OUTER JOIN ans_grupo_despesa k ON (o.nr_seq_grupo_ans = k.nr_sequencia)
, pls_segurado s
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
WHERE p.nr_sequencia	= c.nr_seq_protocolo and p.nr_sequencia	= u.nr_seq_protocolo and u.nr_seq_lote	= l.nr_sequencia and l.nr_sequencia	= vet_titulo_conta.nr_seq_lote and c.nr_sequencia	= o.nr_seq_conta and s.nr_sequencia	= c.nr_seq_segurado and a.nr_sequencia	= s.nr_seq_plano   and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(c.ie_tipo_segurado,'X'))
	or (coalesce(ie_tipo_segurado_w,'X') = 'X')) and l.dt_mes_competencia	<= dt_final_w and obter_empresa_estab(vet_titulo_conta.cd_estabelecimento) = cd_empresa_p and o.ie_status not in ('D','M') and ((ie_gerar_ind_classif_w <> 'N')
	or (coalesce(o.cd_conta_cred,o.cd_conta_provisao_cred) in (	select c.cd_conta_contabil
									from 	conta_contabil c
									where	c.ie_tipo = 'A'
									and 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '2.1.1')));
	
vet_itens_conta		c_itens_conta%rowtype;
	
c_titulo_venc CURSOR FOR
	SELECT	t.nr_titulo,
		t.dt_vencimento_atual dt_vencimento,
		t.dt_emissao,
		obter_saldo_titulo_pagar(t.nr_titulo,dt_final_w) vl_saldo,
		obter_saldo_titulo_pagar(t.nr_titulo,dt_final_w) vl_saldo_orig,
		(	SELECT	coalesce(sum(f.vl_imposto),0)
			from	titulo_pagar_imposto 	f,
				tributo 		c
			where	f.cd_tributo	= c.cd_tributo
			and	f.nr_titulo		= t.nr_titulo
			and	f.ie_pago_prev 	= 'V'
			and	coalesce(c.ie_saldo_tit_pagar,'S')	= 'S') vl_imposto,
		(	select	coalesce(sum(x.vl_item),0)
			from	pls_pagamento_prestador	y,
				pls_pagamento_item	x,
				pls_evento		e
			where	y.nr_sequencia	= x.nr_seq_pagamento
			and	e.nr_sequencia	= x.nr_seq_evento
			and	y.nr_sequencia	= t.nr_seq_pls_pag_prest
			and	e.ie_tipo_evento <> 'P') vl_evento,
		t.ie_origem_titulo,
		t.cd_estabelecimento,
		t.vl_titulo,
		v.nr_sequencia,
		v.vl_vencimento vl_vencimento,
		v.nr_seq_pag_prestador
	from	titulo_pagar t,
		pls_pag_prest_vencimento v
	where	v.nr_titulo      	= t.nr_titulo
	and	((coalesce(t.dt_liquidacao::text, '') = '')
	or (t.dt_liquidacao > dt_final_w))
	and 	t.dt_contabil <= dt_final_w
	and  	coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento
	and	t.vl_titulo > 0
	and 	t.ie_situacao <> 'C'
	
union all

	select	t.nr_titulo,
		t.dt_vencimento_atual dt_vencimento,
		t.dt_emissao,
		obter_saldo_titulo_pagar(t.nr_titulo,dt_final_w) vl_saldo,
		obter_saldo_titulo_pagar(t.nr_titulo,dt_final_w) vl_saldo_orig,
		(	select	coalesce(sum(f.vl_imposto),0)
			from	titulo_pagar_imposto 	f,
				tributo 		c
			where	f.cd_tributo	= c.cd_tributo
			and	f.nr_titulo		= t.nr_titulo
			and	f.ie_pago_prev 	= 'V'
			and	coalesce(c.ie_saldo_tit_pagar,'S')	= 'S') vl_imposto,
		(	select	coalesce(sum(x.vl_item),0)
			from	pls_pagamento_prestador	y,
				pls_pagamento_item	x,
				pls_evento		e
			where	y.nr_sequencia	= x.nr_seq_pagamento
			and	e.nr_sequencia	= x.nr_seq_evento
			and	y.nr_sequencia	= t.nr_seq_pls_pag_prest
			and	e.ie_tipo_evento <> 'P') vl_evento,
		t.ie_origem_titulo,
		t.cd_estabelecimento,
		t.vl_titulo,
		v.nr_sequencia,
		v.vl_liquido vl_vencimento,
		v.nr_seq_pag_prestador
	from	titulo_pagar t,
		pls_pag_prest_vencimento v
	where	v.nr_titulo      	= t.nr_titulo_original
	and	((coalesce(t.dt_liquidacao::text, '') = '')
	or (t.dt_liquidacao > dt_final_w))
	and 	t.dt_contabil <= dt_final_w
	and  	coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento
	and	t.vl_titulo > 0
	and 	t.ie_situacao <> 'C';
	
vet_titulo_venc c_titulo_venc%rowtype;
	
c_itens_venc CURSOR FOR
	SELECT	ie_tipo_evento,
		nm_prestador,
		nr_cpf_cnpj,
		ie_tipo_relacao,
		nr_titulo,
		nr_seq_lote,
		nr_documento,
		dt_emissao,
		dt_aviso,
		cd_beneficiario,
		nm_segurado,
		vl_saldo,
		dt_contabilizacao,
		cd_conta_contabil,
		vl_item,
		vl_pagamento,
		vl_saldo_orig,
		vl_imposto,
		vl_evento,
		vl_item_evento,
		vl_vencimento,
		nr_seq_pag_item,
		nr_seq_segurado,
		ie_tipo_contratacao,
		ie_segmentacao,
		nr_contrato,
		nr_cpf_cnpj_adic,
		dt_ocorrencia,
		nm_usuario_princ,
		vl_pagar,
		nr_seq_pagador,
		nr_seq_prestador,
		ie_tipo_segurado,
		nr_protocolo_ans,
		ie_tipo_documento,
		ie_tipo_grupo_ans,
		ie_preco,
		nr_seq_congenere,
		dt_mes_competencia
	from	( 	SELECT	'P' ie_tipo_evento,
				substr(pls_obter_dados_prestador(p.nr_sequencia,'N'),1,255) nm_prestador,
				coalesce(substr(obter_dados_pf(p.cd_pessoa_fisica, 'CPF'),1,11),p.cd_cgc) nr_cpf_cnpj,
				p.ie_tipo_relacao,
				vet_titulo_venc.nr_titulo nr_titulo,
				b.nr_sequencia nr_seq_lote,
				d.nr_sequencia nr_documento,
				vet_titulo_venc.dt_emissao dt_emissao,
				trunc(coalesce(e.dt_recebimento,e.dt_mes_competencia),'dd') dt_aviso,
				substr(pls_obter_dados_segurado(s.nr_sequencia,'CR'),1,30) cd_beneficiario,
				substr(obter_nome_pf(s.cd_pessoa_fisica),1,100) nm_segurado,
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_usuario_princ,
				substr(coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')),1,20) nr_cpf_cnpj_adic,
				vet_titulo_venc.vl_saldo vl_saldo,
				coalesce(e.dt_recebimento,e.dt_mes_competencia) dt_contabilizacao,
				coalesce(r.cd_conta_cred,r.cd_conta_prov_cred) cd_conta_contabil,
				r.vl_liberado vl_item,
				a.vl_pagamento vl_pagamento,
				r.nr_sequencia nr_seq_conta_resumo,
				vet_titulo_venc.vl_saldo_orig vl_saldo_orig,
				vet_titulo_venc.vl_imposto vl_imposto,
				vet_titulo_venc.vl_evento vl_evento,
				round((dividir_sem_round(vet_titulo_venc.vl_saldo * i.vl_item,a.vl_pagamento))::numeric,2) vl_item_evento,
				vet_titulo_venc.vl_vencimento vl_vencimento,
				i.nr_sequencia nr_seq_pag_item,
				s.nr_sequencia nr_seq_segurado,
				n.ie_tipo_contratacao,
				n.ie_segmentacao,
				t.nr_contrato,
				(select	x.dt_procedimento
				from	pls_conta_proc	x
				where	x.nr_sequencia	= r.nr_seq_conta_proc
				and	d.nr_sequencia	= x.nr_seq_conta
				
union all

				select	y.dt_atendimento
				from	pls_conta_mat	y
				where	y.nr_sequencia	= r.nr_seq_conta_mat
				and	d.nr_sequencia	= y.nr_seq_conta) dt_ocorrencia,
				(r.vl_liberado + r.vl_glosa) vl_pagar,
				s.nr_seq_pagador,
				p.nr_sequencia nr_seq_prestador,
				d.ie_tipo_segurado,
				CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END  nr_protocolo_ans,
				'CM' ie_tipo_documento,
				k.ie_tipo_grupo_ans,
				n.ie_preco,
				e.nr_seq_congenere,
				e.dt_mes_competencia
			FROM pls_prestador p, pls_pagamento_item i, pls_protocolo_conta e, pls_lote_pagamento b, pls_pagamento_prestador a, pls_conta d
LEFT OUTER JOIN pls_plano n ON (d.nr_seq_plano = n.nr_sequencia)
, pls_conta_medica_resumo r
LEFT OUTER JOIN ans_grupo_despesa k ON (r.nr_seq_grupo_ans = k.nr_sequencia)
, pls_segurado s
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
WHERE a.nr_seq_lote 		= b.nr_sequencia and d.nr_seq_protocolo	= e.nr_sequencia and i.nr_seq_pagamento 	= a.nr_sequencia and i.nr_sequencia		= r.nr_seq_pag_item and r.nr_seq_lote_pgto 	= b.nr_sequencia and r.nr_seq_conta 		= d.nr_sequencia and r.nr_seq_segurado 	= s.nr_sequencia and a.nr_seq_prestador 	= r.nr_seq_prestador_pgto    and a.nr_sequencia      	= vet_titulo_venc.nr_seq_pag_prestador and p.nr_sequencia 		= a.nr_seq_prestador and b.dt_mes_competencia	<= dt_final_w and obter_empresa_estab(vet_titulo_venc.cd_estabelecimento) = cd_empresa_p and ((ie_gerar_ind_classif_w <> 'N')
			or (coalesce(r.cd_conta_cred,r.cd_conta_prov_cred) in (select c.cd_conta_contabil
										from 	conta_contabil c
										where	c.ie_tipo = 'A'
										and 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '2.1.1'))) and exists (select	1
					from	pls_conta_proc 	x
					where	x.nr_seq_conta		= d.nr_sequencia
					and	r.nr_seq_conta_proc	= x.nr_sequencia
					and	x.ie_status not in ('D','M')
					
union all

					select	1
					from	pls_conta_mat 	x
					where	x.nr_seq_conta		= d.nr_sequencia
					and	r.nr_seq_conta_mat	= x.nr_sequencia
					and	x.ie_status not in ('D','M')) and vet_titulo_venc.ie_origem_titulo <> '4' and coalesce(r.vl_liberado,0) <> 0 and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(d.ie_tipo_segurado,'X'))
			or (coalesce(ie_tipo_segurado_w,'X') = 'X'))			
			
union all

			select 	'P' ie_tipo_evento,
				substr(pls_obter_dados_prestador(p.nr_sequencia,'N'),1,255) nm_prestador,
				coalesce(substr(obter_dados_pf(p.cd_pessoa_fisica, 'CPF'),1,11),p.cd_cgc) nr_cpf_cnpj,
				p.ie_tipo_relacao,
				vet_titulo_venc.nr_titulo nr_titulo,
				b.nr_sequencia nr_seq_lote,
				d.nr_sequencia nr_documento,
				vet_titulo_venc.dt_emissao dt_emissao,
				trunc(coalesce(e.dt_recebimento,e.dt_mes_competencia),'dd') dt_aviso,
				substr(pls_obter_dados_segurado(s.nr_sequencia,'CR'),1,30) cd_beneficiario,
				substr(obter_nome_pf(s.cd_pessoa_fisica),1,100) nm_segurado,
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_usuario_princ,
				substr(coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')),1,20) nr_cpf_cnpj_adic,
				vet_titulo_venc.vl_saldo vl_saldo,
				coalesce(e.dt_recebimento,e.dt_mes_competencia) dt_contabilizacao,
				coalesce(z.cd_conta_cred, z.cd_conta_provisao_cred) cd_conta_contabil,
				r.vl_liberado vl_item,
				a.vl_pagamento vl_pagamento,
				r.nr_sequencia nr_seq_conta_resumo,
				vet_titulo_venc.vl_saldo_orig vl_saldo_orig,
				vet_titulo_venc.vl_imposto vl_imposto,
				vet_titulo_venc.vl_evento vl_evento,
				round((dividir_sem_round(vet_titulo_venc.vl_saldo * i.vl_item,a.vl_pagamento))::numeric,2) vl_item_evento,
				vet_titulo_venc.vl_vencimento vl_vencimento,
				i.nr_sequencia nr_seq_pag_item,
				s.nr_sequencia nr_seq_segurado,
				n.ie_tipo_contratacao,
				n.ie_segmentacao,
				w.nr_contrato,
				z.dt_procedimento,
				(r.vl_liberado + r.vl_glosa) vl_pagar,
				s.nr_seq_pagador,
				p.nr_sequencia nr_seq_prestador,
				d.ie_tipo_segurado,
				CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END  nr_protocolo_ans,
				'CM' ie_tipo_documento,
				k.ie_tipo_grupo_ans,
				n.ie_preco,
				e.nr_seq_congenere,
				e.dt_mes_competencia
			FROM pls_conta_medica_resumo r, pls_prestador p, pls_pagamento_item i, pls_protocolo_conta e, pls_lote_pagamento b, pls_pagamento_prestador a, pls_segurado s
LEFT OUTER JOIN pls_contrato w ON (s.nr_seq_contrato = w.nr_sequencia)
, pls_conta d
LEFT OUTER JOIN pls_plano n ON (d.nr_seq_plano = n.nr_sequencia)
, pls_conta_proc z
LEFT OUTER JOIN ans_grupo_despesa k ON (z.nr_seq_grupo_ans = k.nr_sequencia)
WHERE a.nr_seq_lote 		= b.nr_sequencia and r.nr_seq_lote_pgto 	= b.nr_sequencia and i.nr_seq_pagamento 	= a.nr_sequencia and i.nr_sequencia		= r.nr_seq_pag_item and r.nr_seq_segurado 	= s.nr_sequencia and r.nr_seq_conta 		= d.nr_sequencia and d.nr_seq_protocolo	= e.nr_sequencia and a.nr_seq_prestador 	= r.nr_seq_prestador_pgto and a.nr_sequencia      	= vet_titulo_venc.nr_seq_pag_prestador and p.nr_sequencia		= a.nr_seq_prestador  and z.nr_seq_conta		= d.nr_sequencia and r.nr_seq_conta_proc	= z.nr_sequencia   and coalesce(r.vl_liberado,0) <> 0 and coalesce(r.cd_conta_cred::text, '') = '' and coalesce(r.cd_conta_prov_cred::text, '') = '' and b.dt_mes_competencia	<= dt_final_w and obter_empresa_estab(vet_titulo_venc.cd_estabelecimento) = cd_empresa_p and vet_titulo_venc.ie_origem_titulo <> '4' and z.ie_status not in ('D','M') and ((ie_gerar_ind_classif_w <> 'N')
			or	coalesce(z.cd_conta_cred, z.cd_conta_provisao_cred)   in (select c.cd_conta_contabil
											from 	conta_contabil c
											where	c.ie_tipo = 'A'
											and 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '2.1.1')) and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(d.ie_tipo_segurado,'X'))
			or (coalesce(ie_tipo_segurado_w,'X') = 'X'))
			 
union all

			select 	'P' ie_tipo_evento,
				substr(pls_obter_dados_prestador(p.nr_sequencia,'N'),1,255) nm_prestador,
				coalesce(substr(obter_dados_pf(p.cd_pessoa_fisica, 'CPF'),1,11),p.cd_cgc) nr_cpf_cnpj,
				p.ie_tipo_relacao,
				vet_titulo_venc.nr_titulo nr_titulo,
				b.nr_sequencia nr_seq_lote,
				d.nr_sequencia nr_documento,
				vet_titulo_venc.dt_emissao dt_emissao,
				trunc(coalesce(e.dt_recebimento,e.dt_mes_competencia),'dd') dt_aviso,
				substr(pls_obter_dados_segurado(s.nr_sequencia,'CR'),1,30) cd_beneficiario,
				substr(obter_nome_pf(s.cd_pessoa_fisica),1,100) nm_segurado,
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_usuario_princ,
				substr(coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')),1,20) nr_cpf_cnpj_adic,
				vet_titulo_venc.vl_saldo vl_saldo,
				coalesce(e.dt_recebimento,e.dt_mes_competencia) dt_contabilizacao,
				coalesce(z.cd_conta_cred,z.cd_conta_provisao_cred) cd_conta_contabil,
				r.vl_liberado vl_item,
				a.vl_pagamento vl_pagamento,
				r.nr_sequencia nr_seq_conta_resumo,
				vet_titulo_venc.vl_saldo_orig vl_saldo_orig,
				vet_titulo_venc.vl_imposto vl_imposto,
				vet_titulo_venc.vl_evento vl_evento,
				round((dividir_sem_round(vet_titulo_venc.vl_saldo * i.vl_item,a.vl_pagamento))::numeric,2) vl_item_evento,
				vet_titulo_venc.vl_vencimento vl_vencimento,
				i.nr_sequencia nr_seq_pag_item,
				s.nr_sequencia nr_seq_segurado,
				n.ie_tipo_contratacao,
				n.ie_segmentacao,
				w.nr_contrato,
				z.dt_atendimento,
				(r.vl_liberado + r.vl_glosa) vl_pagar,
				s.nr_seq_pagador,
				p.nr_sequencia nr_seq_prestador,
				d.ie_tipo_segurado,
				CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END  nr_protocolo_ans,
				'CM' ie_tipo_documento,
				k.ie_tipo_grupo_ans,
				n.ie_preco,
				e.nr_seq_congenere,
				e.dt_mes_competencia
			FROM pls_conta_medica_resumo r, pls_prestador p, pls_pagamento_item i, pls_protocolo_conta e, pls_lote_pagamento b, pls_pagamento_prestador a, pls_segurado s
LEFT OUTER JOIN pls_contrato w ON (s.nr_seq_contrato = w.nr_sequencia)
, pls_conta d
LEFT OUTER JOIN pls_plano n ON (d.nr_seq_plano = n.nr_sequencia)
, pls_conta_mat z
LEFT OUTER JOIN ans_grupo_despesa k ON (z.nr_seq_grupo_ans = k.nr_sequencia)
WHERE a.nr_seq_lote 		= b.nr_sequencia and r.nr_seq_lote_pgto 	= b.nr_sequencia and i.nr_seq_pagamento 	= a.nr_sequencia and i.nr_sequencia		= r.nr_seq_pag_item and r.nr_seq_segurado 	= s.nr_sequencia and r.nr_seq_conta 		= d.nr_sequencia and d.nr_seq_protocolo	= e.nr_sequencia and a.nr_seq_prestador 	= r.nr_seq_prestador_pgto and a.nr_sequencia      	= vet_titulo_venc.nr_seq_pag_prestador  and p.nr_sequencia		= a.nr_seq_prestador and z.nr_seq_conta		= d.nr_sequencia and r.nr_seq_conta_mat	= z.nr_sequencia   and b.dt_mes_competencia	<= dt_final_w and coalesce(r.vl_liberado,0) <> 0 and obter_empresa_estab(vet_titulo_venc.cd_estabelecimento) = cd_empresa_p and coalesce(r.cd_conta_cred::text, '') = '' and coalesce(r.cd_conta_prov_cred::text, '') = '' and vet_titulo_venc.ie_origem_titulo <> '4' and z.ie_status not in ('D','M') and ((ie_gerar_ind_classif_w <> 'N')
			or	coalesce(z.cd_conta_cred, z.cd_conta_provisao_cred)  in (select c.cd_conta_contabil
											from 	conta_contabil c
											where	c.ie_tipo = 'A'
											and 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '2.1.1')) and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(d.ie_tipo_segurado,'X'))
			or (coalesce(ie_tipo_segurado_w,'X') = 'X'))									
			 
union all

			select	'O' ie_tipo_evento,
				substr(pls_obter_dados_prestador(p.nr_sequencia,'N'),1,255) nm_prestador,
				coalesce(substr(obter_dados_pf(p.cd_pessoa_fisica, 'CPF'),1,11),p.cd_cgc) nr_cpf_cnpj,
				p.ie_tipo_relacao,
				vet_titulo_venc.nr_titulo nr_titulo,
				l.nr_sequencia nr_seq_lote,
				l.nr_sequencia nr_documento,
				vet_titulo_venc.dt_emissao dt_emissao,
				dt_final_w dt_aviso,
				null cd_beneficiario,
				null nm_segurado,
				null nm_usuario_princ,
				null nr_cpf_cnpj_adic,
				--round(sum(dividir_sem_round(vet_titulo_venc.vl_saldo * m.vl_movimento, vet_titulo_venc.vl_titulo)),2) vl_saldo,
				vet_titulo_venc.vl_saldo vl_saldo,
				l.dt_mes_competencia dt_contabilizacao,
				m.cd_conta_credito cd_conta_contabil,
				sum(m.vl_movimento) vl_item,
				null vl_pagamento,
				null nr_seq_conta_resumo,
				vet_titulo_venc.vl_saldo_orig vl_saldo_orig,
				vet_titulo_venc.vl_imposto vl_imposto,
				sum(m.vl_movimento) vl_evento,
				0,
				vet_titulo_venc.vl_vencimento vl_vencimento,
				null nr_seq_pag_prest,
				null nr_seq_segurado,
				null ie_tipo_contratacao,
				null ie_segmentacao,
				null nr_contrato,
				null dt_ocorrencia,
				sum(m.vl_movimento) vl_pagar,
				null nr_seq_pagador,
				p.nr_sequencia nr_seq_prestador,
				null ie_tipo_segurado,
				null nr_protocolo_ans,
				'OF' ie_tipo_documento,
				null ie_tipo_grupo_ans,
				null ie_preco,
				null nr_seq_congenere,
				null dt_mes_competencia
			from    pls_evento			e,
				pls_evento_movimento  		m,
				pls_lote_pagamento		l,
				pls_prestador			p,
				pls_pagamento_prestador		a
			where	e.nr_sequencia		= m.nr_seq_evento
			and	l.nr_sequencia		= m.nr_seq_lote_pgto
			and	p.nr_sequencia		= m.nr_seq_prestador
			and	p.nr_sequencia		= a.nr_seq_prestador
			and	a.nr_sequencia		= vet_titulo_venc.nr_seq_pag_prestador
			and	l.nr_sequencia		= a.nr_seq_lote
			and	l.dt_mes_competencia 	<= dt_final_w
			and	coalesce(m.nr_seq_pagamento_item,0) <> 0
			and	e.ie_tipo_evento <> 'P'
			and	((ie_gerar_ind_classif_w <> 'N')
			or	m.cd_conta_credito in (select c.cd_conta_contabil
							from 	conta_contabil c
							where	c.ie_tipo = 'A'
							and 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '2.1.1'))
			and  	vet_titulo_venc.ie_origem_titulo <> '4'
			group by 'O',
				substr(pls_obter_dados_prestador(p.nr_sequencia,'N'),1,255),
				coalesce(substr(obter_dados_pf(p.cd_pessoa_fisica, 'CPF'),1,11),p.cd_cgc),
				p.ie_tipo_relacao,
				l.nr_sequencia,
				m.nr_sequencia,
				dt_final_w,
				l.dt_mes_competencia,
				m.cd_conta_credito,
				p.nr_sequencia
			having  sum(m.vl_movimento) <> 0
			
union all

			select  'T' ie_tipo_evento,
				substr(pls_obter_dados_prestador(e.nr_seq_prestador,'N'),1,255) nm_prestador,
				coalesce(pls_obter_dados_prestador(e.nr_seq_prestador,'CPF'), pls_obter_dados_prestador(e.nr_seq_prestador,'CGC')) nr_cpf_cnpj,
				p.ie_tipo_relacao,
				vet_titulo_venc.nr_titulo nr_titulo,
				f.nr_sequencia nr_seq_lote,
				f.nr_sequencia nr_documento,
				vet_titulo_venc.dt_emissao dt_emissao,
				trunc(f.dt_mes_competencia,'dd') dt_aviso,
				null cd_beneficiario,
				null nm_segurado,
				null nm_usuario_princ,
				null nr_cpf_cnpj_adic,
				(vet_titulo_venc.vl_saldo + (	select 	coalesce(sum(vl_adiantamento),0)
								from 	titulo_pagar_adiant x
								where	x.nr_titulo	= vet_titulo_venc.nr_titulo
								and 	trunc(coalesce(x.dt_contabil, x.dt_atualizacao), 'dd') <= dt_final_w)) vl_saldo,
				f.dt_mes_competencia dt_contabilizacao,
				b.cd_conta_deb cd_conta_contabil,
				dividir_sem_round(b.vl_evento * (vet_titulo_venc.vl_saldo + (	select 	coalesce(sum(vl_adiantamento),0)
												from 	titulo_pagar_adiant x
												where	x.nr_titulo	= vet_titulo_venc.nr_titulo
												and 	trunc(coalesce(x.dt_contabil, x.dt_atualizacao), 'dd') <= dt_final_w)), vet_titulo_venc.vl_vencimento) * (-1) vl_item,
				e.vl_pagamento vl_pagamento,
				null nr_seq_conta_resumo,
				1 vl_saldo_orig,
				0 vl_imposto,
				null vl_evento,
				round((dividir_sem_round(a.vl_item * vet_titulo_venc.vl_saldo, e.vl_pagamento))::numeric,2) vl_item_evento,
				vet_titulo_venc.vl_vencimento vl_vencimento,
				a.nr_sequencia nr_seq_pag_item,
				null nr_seq_segurado,
				null ie_tipo_contratacao,
				null ie_segmentacao,
				null nr_contrato,
				null dt_ocorrencia,
				a.vl_item vl_pagar,
				null nr_seq_pagador,
				p.nr_sequencia,
				null ie_tipo_segurado,
				null nr_protocolo_ans,
				'TB' ie_tipo_documento,
				null ie_tipo_grupo_ans,
				null ie_preco,
				null nr_seq_congenere,
				null dt_mes_competencia
			from  	pls_pagamento_item     		a,
				pls_pag_item_trib     		b,
				pls_pag_prest_venc_trib    	c,
				pls_pagamento_prestador    	e,
				pls_lote_pagamento    		f,
				pls_prestador      		p
			where  	a.nr_sequencia  	= b.nr_seq_pagamento
			and  	c.nr_sequencia 		= b.nr_seq_venc_trib
			and  	c.nr_seq_vencimento	= vet_titulo_venc.nr_sequencia
			and  	e.nr_sequencia 		= vet_titulo_venc.nr_seq_pag_prestador
			and  	f.nr_sequencia 		= e.nr_seq_lote
			and  	e.nr_sequencia 		= a.nr_seq_pagamento
			and  	e.nr_seq_prestador 	= p.nr_sequencia
			and  	c.ie_pago_prev  	!= 'R'
			and  	f.dt_mes_competencia 	<= dt_final_w
			and  	obter_empresa_estab(vet_titulo_venc.cd_estabelecimento) = cd_empresa_p
			and	((ie_gerar_ind_classif_w <> 'N')
			or  	b.cd_conta_deb in (	select c.cd_conta_contabil
							from   conta_contabil c
							where  c.ie_tipo = 'A'
							and   substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '2.1.1'))
			and  	vet_titulo_venc.ie_origem_titulo <> '4'
			and	b.vl_evento <> 0
			
union all

			select  'T' ie_tipo_evento,
				substr(pls_obter_dados_prestador(e.nr_seq_prestador,'N'),1,255) nm_prestador,
				coalesce(pls_obter_dados_prestador(e.nr_seq_prestador,'CPF'), pls_obter_dados_prestador(e.nr_seq_prestador,'CGC')) nr_cpf_cnpj,
				p.ie_tipo_relacao,
				vet_titulo_venc.nr_titulo nr_titulo,
				f.nr_sequencia nr_seq_lote,
				f.nr_sequencia nr_documento,
				vet_titulo_venc.dt_emissao dt_emissao,
				trunc(f.dt_mes_competencia,'dd') dt_aviso,
				null cd_beneficiario,
				null nm_segurado,
				null nm_usuario_princ,
				null nr_cpf_cnpj_adic,
				(vet_titulo_venc.vl_saldo + (	select 	coalesce(sum(vl_adiantamento),0)
								from 	titulo_pagar_adiant x
								where	x.nr_titulo	= vet_titulo_venc.nr_titulo
								and 	trunc(coalesce(x.dt_contabil, x.dt_atualizacao), 'dd') <= dt_final_w)) vl_saldo,
				f.dt_mes_competencia dt_contabilizacao,
				c.cd_conta_deb cd_conta_contabil,
				dividir_sem_round(c.vl_imposto * (vet_titulo_venc.vl_saldo + (	select 	coalesce(sum(vl_adiantamento),0)
												from 	titulo_pagar_adiant x
												where	x.nr_titulo	= vet_titulo_venc.nr_titulo
												and 	trunc(coalesce(x.dt_contabil, x.dt_atualizacao), 'dd') <= dt_final_w)), vet_titulo_venc.vl_vencimento) * (-1) vl_item,
				e.vl_pagamento vl_pagamento,
				null nr_seq_conta_resumo,
				1 vl_saldo_orig,
				0 vl_imposto,
				null vl_evento,
				null vl_item_evento,
				vet_titulo_venc.vl_vencimento vl_vencimento,
				null nr_seq_pag_item,
				null nr_seq_segurado,
				null ie_tipo_contratacao,
				null ie_segmentacao,
				null nr_contrato,
				null dt_ocorrencia,
				null vl_pagar,
				null nr_seq_pagador,
				p.nr_sequencia,
				null ie_tipo_segurado,
				null nr_protocolo_ans,
				'TB' ie_tipo_documento,
				null ie_tipo_grupo_ans,
				null ie_preco,
				null nr_seq_congenere,
				null dt_mes_competencia
			from  	pls_pag_prest_venc_trib    	c,
				pls_pagamento_prestador    	e,
				pls_lote_pagamento    		f,
				pls_prestador      		p
			where  	c.nr_seq_vencimento	= vet_titulo_venc.nr_sequencia
			and  	e.nr_sequencia 		= vet_titulo_venc.nr_seq_pag_prestador
			and  	f.nr_sequencia 		= e.nr_seq_lote
			and  	e.nr_seq_prestador 	= p.nr_sequencia
			and	not exists (	select	1
						from 	pls_pag_item_trib       x,
							pls_pagamento_item      y
						where	y.nr_sequencia		= x.nr_seq_pagamento
						and	c.nr_sequencia		= x.nr_seq_venc_trib
						and	e.nr_sequencia		= y.nr_seq_pagamento )			
			and  	c.ie_pago_prev  	!= 'R'
			and  	f.dt_mes_competencia 	<= dt_final_w
			and  	obter_empresa_estab(vet_titulo_venc.cd_estabelecimento) = cd_empresa_p
			and	((ie_gerar_ind_classif_w <> 'N')
			or  	c.cd_conta_deb in (	select c.cd_conta_contabil
							from   conta_contabil c
							where  c.ie_tipo = 'A'
							and   substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '2.1.1'))
			and  	vet_titulo_venc.ie_origem_titulo <> '4'
			and	c.vl_imposto <> 0		
			
union all

			select	'G' ie_tipo_evento,
				substr(pls_obter_dados_prestador(p.nr_sequencia,'N'),1,255) nm_prestador,
				coalesce(substr(obter_dados_pf(p.cd_pessoa_fisica, 'CPF'),1,11),p.cd_cgc) nr_cpf_cnpj,
				p.ie_tipo_relacao,
				vet_titulo_venc.nr_titulo nr_titulo,
				i.nr_sequencia nr_seq_lote,
				b.nr_sequencia nr_documento,
				vet_titulo_venc.dt_emissao dt_emissao,
				trunc(coalesce(a.dt_recebimento,a.dt_mes_competencia),'dd') dt_aviso,
				substr(pls_obter_dados_segurado(s.nr_sequencia,'CR'),1,30) cd_beneficiario,
				substr(obter_nome_pf(s.cd_pessoa_fisica),1,100) nm_segurado,
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_usuario_princ,
				substr(coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')),1,20) nr_cpf_cnpj_adic,
				vet_titulo_venc.vl_saldo vl_saldo,
				coalesce(a.dt_recebimento,a.dt_mes_competencia) dt_contabilizacao,
				coalesce(e.cd_conta_deb, e.cd_conta_cred_pag) cd_conta_contabil,
				--e.cd_conta_deb cd_conta_contabil,

				--dividir_sem_round(e.vl_liberado * vet_titulo_venc.vl_saldo, vet_titulo_venc.vl_vencimento) vl_item,
				e.vl_liberado vl_item,
				j.vl_pagamento vl_pagamento,
				null nr_seq_conta_resumo,
				vet_titulo_venc.vl_saldo_orig vl_saldo_orig,
				vet_titulo_venc.vl_imposto vl_imposto,
				vet_titulo_venc.vl_evento vl_evento,
				0 vl_item_evento,
				vet_titulo_venc.vl_vencimento vl_vencimento,
				0 nr_seq_pag_item,
				s.nr_sequencia nr_seq_segurado,
				y.ie_tipo_contratacao,
				y.ie_segmentacao,
				w.nr_contrato,
				(select	x.dt_procedimento
				from	pls_conta_proc		x,
					pls_rec_glosa_proc	p
				where	p.nr_sequencia	= e.nr_seq_proc_rec
				and	f.nr_sequencia	= p.nr_seq_conta_rec
				and	x.nr_sequencia	= p.nr_seq_conta_proc
				
union all

				select	y.dt_atendimento
				from	pls_conta_mat		y,
					pls_rec_glosa_mat	m
				where	m.nr_sequencia	= e.nr_seq_mat_rec
				and	f.nr_sequencia	= m.nr_seq_conta_rec
				and	y.nr_sequencia	= m.nr_seq_conta_mat) dt_ocorrencia,
				e.vl_glosa vl_pagar,
				s.nr_seq_pagador,
				p.nr_sequencia nr_seq_prestador,
				b.ie_tipo_segurado,
				CASE WHEN y.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(y.nr_protocolo_ans, y.cd_scpa) END  nr_protocolo_ans,
				'CM' ie_tipo_documento,
				k.ie_tipo_grupo_ans,
				y.ie_preco,
				a.nr_seq_congenere,
				a.dt_mes_competencia
			FROM pls_pagamento_item z, pls_prestador p, pls_pagamento_prestador j, pls_rec_glosa_conta f, pls_protocolo_conta a, pls_conta_rec_resumo_item e
LEFT OUTER JOIN pls_lote_pagamento i ON (e.nr_seq_lote_pgto = i.nr_sequencia)
LEFT OUTER JOIN ans_grupo_despesa k ON (e.nr_seq_grupo_ans = k.nr_sequencia)
, pls_conta b
LEFT OUTER JOIN pls_segurado s ON (b.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_plano y ON (b.nr_seq_plano = y.nr_sequencia)
LEFT OUTER JOIN pls_contrato w ON (s.nr_seq_contrato = w.nr_sequencia)
WHERE j.nr_sequencia			= vet_titulo_venc.nr_seq_pag_prestador and j.nr_seq_lote			= i.nr_sequencia  and e.nr_seq_conta_rec		= f.nr_sequencia and f.nr_seq_conta			= b.nr_sequencia and a.nr_sequencia			= b.nr_seq_protocolo    and p.nr_sequencia			= j.nr_seq_prestador and e.nr_seq_pag_item		= z.nr_sequencia and z.nr_seq_pagamento		= j.nr_sequencia  and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(b.ie_tipo_segurado,'X'))
			or (coalesce(ie_tipo_segurado_w,'X') = 'X')) and coalesce(e.vl_liberado,0)		<> 0 and coalesce(e.ie_situacao,'A')	 	= 'A' and vet_titulo_venc.ie_origem_titulo <> '4' and ((ie_gerar_ind_classif_w <> 'N')
			or	coalesce(e.cd_conta_deb, e.cd_conta_cred_pag)	in (	select c.cd_conta_contabil
			--or	e.cd_conta_deb	in  (	select c.cd_conta_contabil
							from   conta_contabil c
							where  c.ie_tipo = 'A'
							and   substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '2.1.1')) ) alias236
	where (vl_saldo_orig - vl_imposto) > 0
	order by nr_titulo;

vet_itens_venc c_itens_venc%rowtype;

c_titulo_fatura CURSOR FOR
	SELECT	t.nr_titulo,
		t.dt_emissao,
		t.dt_vencimento_atual dt_vencimento,
		(	SELECT	coalesce(sum(y.vl_imposto),0)
			from	titulo_pagar_imposto y,
				tributo z
			where	y.cd_tributo	= z.cd_tributo
			and	y.nr_titulo	= t.nr_titulo
			and	y.ie_pago_prev 	= 'V'
			and	coalesce(z.ie_saldo_tit_pagar,'S')	= 'S') vl_imposto,
		f.nr_sequencia nr_seq_fatura,
		f.vl_total_fatura
	from   	titulo_pagar t,
		ptu_fatura f
	where  	f.nr_titulo	= t.nr_titulo
	and	((coalesce(t.dt_liquidacao::text, '') = '')
	or (t.dt_liquidacao > dt_final_w))
	and	coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento
	and	obter_empresa_estab(t.cd_estabelecimento) = cd_empresa_p
	and	t.vl_titulo > 0
	and	obter_saldo_titulo_pagar(t.nr_titulo,dt_final_w) <> 0
	and 	t.ie_situacao <> 'C'
	
union all

	select	t.nr_titulo,
		t.dt_emissao,
		t.dt_vencimento_atual dt_vencimento,
		(	select	coalesce(sum(y.vl_imposto),0)
			from	titulo_pagar_imposto y,
				tributo z
			where	y.cd_tributo	= z.cd_tributo
			and	y.nr_titulo	= t.nr_titulo
			and	y.ie_pago_prev 	= 'V'
			and	coalesce(z.ie_saldo_tit_pagar,'S')	= 'S') vl_imposto,
		f.nr_sequencia nr_seq_fatura,
		f.vl_total_fatura
	from   	titulo_pagar t,
		ptu_fatura f
	where  	f.nr_titulo	= t.nr_titulo_original
	and	((coalesce(t.dt_liquidacao::text, '') = '')
	or (t.dt_liquidacao > dt_final_w))
	and	coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento
	and	obter_empresa_estab(t.cd_estabelecimento) = cd_empresa_p
	and	t.vl_titulo > 0
	and	obter_saldo_titulo_pagar(t.nr_titulo,dt_final_w) <> 0
	and 	t.ie_situacao <> 'C';
	
vet_titulo_fatura c_titulo_fatura%rowtype;

c_itens_fatura CURSOR FOR
	SELECT	ie_tipo_evento,
		nm_prestador,
		nr_cpf_cnpj,
		ie_tipo_relacao,
		nr_titulo,
		nr_seq_lote,
		dt_emissao,
		nr_documento,
		dt_aviso,
		cd_beneficiario,
		nm_segurado,
		vl_saldo,
		dt_contabilizacao,
		cd_conta_contabil,
		vl_item,
		vl_pagamento,
		vl_saldo_orig,
		vl_imposto,
		vl_evento,
		vl_item_evento,
		vl_vencimento,
		nr_seq_pag_item,
		nr_seq_segurado,
		nr_contrato,
		ie_tipo_contratacao,
		ie_segmentacao,
		nr_cpf_cnpj_adic,
		dt_ocorrencia,
		nm_usuario_princ,
		vl_pagar,
		nr_seq_pagador,
		ie_tipo_segurado,
		nr_protocolo_ans,
		ie_tipo_grupo_ans,
		ie_preco,
		nr_seq_congenere
	from	( 	SELECT 	'I' ie_tipo_evento,
				substr(pls_obter_nome_congenere(b.nr_seq_congenere),1,255) nm_prestador,
				cg.cd_cgc nr_cpf_cnpj,
				'' ie_tipo_relacao,
				vet_titulo_fatura.nr_titulo nr_titulo,
				null nr_seq_lote,
				vet_titulo_fatura.dt_emissao dt_emissao,
				c.nr_sequencia nr_documento,
				trunc(coalesce(b.dt_recebimento,b.dt_mes_competencia),'dd') dt_aviso,
				substr(pls_obter_dados_segurado(c.nr_seq_segurado,'CR'),1,30) cd_beneficiario,
				substr(pls_obter_dados_segurado(c.nr_seq_segurado,'N'),1,255) nm_segurado,
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_usuario_princ,
				substr(coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')),1,20) nr_cpf_cnpj_adic,
				round((dividir_sem_round(obter_saldo_titulo_pagar(vet_titulo_fatura.nr_titulo,dt_final_w) * p.vl_procedimento_imp, vet_titulo_fatura.vl_total_fatura)),2) vl_saldo,
				b.dt_mes_competencia dt_contabilizacao,
				p.cd_conta_cred cd_conta_contabil,
				null vl_item,
				null vl_pagamento,
				null nr_seq_conta_resumo,
				null nr_seq_pls_pag_prest,
				round((obter_saldo_titulo_pagar(vet_titulo_fatura.nr_titulo,dt_final_w))::numeric,2) vl_saldo_orig,
				vet_titulo_fatura.vl_imposto vl_imposto,
				0 vl_evento,
				0 vl_item_evento,
				0 vl_vencimento,
				null nr_seq_pag_item,
				c.nr_seq_segurado,
				n.ie_tipo_contratacao,
				n.ie_segmentacao,
				null nr_contrato,
				p.dt_procedimento dt_ocorrencia,
				p.vl_procedimento_imp vl_pagar,
				s.nr_seq_pagador,
				c.ie_tipo_segurado,
				CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END  nr_protocolo_ans,
				k.ie_tipo_grupo_ans,
				n.ie_preco,
				b.nr_seq_congenere
			FROM pls_congenere cg, pls_protocolo_conta b, pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_plano n ON (c.nr_seq_plano = n.nr_sequencia)
, pls_conta_proc p
LEFT OUTER JOIN ans_grupo_despesa k ON (p.nr_seq_grupo_ans = k.nr_sequencia)
WHERE c.nr_seq_fatura		= vet_titulo_fatura.nr_seq_fatura and p.nr_seq_conta		= c.nr_sequencia and c.nr_seq_protocolo	= b.nr_sequencia   and b.nr_seq_congenere	= cg.nr_sequencia  and b.dt_mes_competencia	<= dt_final_w and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(c.ie_tipo_segurado,'X'))
			or (coalesce(ie_tipo_segurado_w,'X') = 'X')) and p.ie_status not in ('D','M') and ((ie_gerar_ind_classif_w <> 'N')
			or	p.cd_conta_cred in (	select	c.cd_conta_contabil
								from 	conta_contabil c
								where	c.ie_tipo = 'A'
								and 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '2.1.1'))
			
union all

			select 	'I' ie_tipo_evento,
				substr(pls_obter_nome_congenere(b.nr_seq_congenere),1,255) nm_prestador,
				cg.cd_cgc nr_cpf_cnpj,
				'' ie_tipo_relacao,
				vet_titulo_fatura.nr_titulo nr_titulo,
				null nr_seq_lote,
				vet_titulo_fatura.dt_emissao dt_emissao,
				c.nr_sequencia nr_documento,
				trunc(coalesce(b.dt_recebimento,b.dt_mes_competencia),'dd') dt_aviso,
				substr(pls_obter_dados_segurado(c.nr_seq_segurado,'CR'),1,30) cd_beneficiario,
				substr(pls_obter_dados_segurado(c.nr_seq_segurado,'N'),1,255) nm_segurado,
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_usuario_princ,
				substr(coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')),1,20) nr_cpf_cnpj_adic,
				round((dividir_sem_round(obter_saldo_titulo_pagar(vet_titulo_fatura.nr_titulo,dt_final_w) * m.vl_material_imp,vet_titulo_fatura.vl_total_fatura)),2) vl_saldo,
				b.dt_mes_competencia dt_contabilizacao,
				m.cd_conta_cred cd_conta_contabil,
				null vl_item,
				null vl_pagamento,
				null nr_seq_conta_resumo,
				null nr_seq_pls_pag_prest,
				round((obter_saldo_titulo_pagar(vet_titulo_fatura.nr_titulo,dt_final_w))::numeric,2) vl_saldo_orig,
				vet_titulo_fatura.vl_imposto vl_imposto,
				0 vl_evento,
				0 vl_item_evento,
				0 vl_vencimento,
				null nr_seq_pag_item,
				c.nr_seq_segurado,
				n.ie_tipo_contratacao,
				n.ie_segmentacao,
				null nr_contrato,
				m.dt_atendimento dt_ocorrencia,
				m.vl_material_imp vl_pagar,
				s.nr_seq_pagador,
				c.ie_tipo_segurado,
				CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END  nr_protocolo_ans,
				k.ie_tipo_grupo_ans,
				n.ie_preco,
				b.nr_seq_congenere
			FROM pls_congenere cg, pls_protocolo_conta b, pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_plano n ON (c.nr_seq_plano = n.nr_sequencia)
, pls_conta_mat m
LEFT OUTER JOIN ans_grupo_despesa k ON (m.nr_seq_grupo_ans = k.nr_sequencia)
WHERE c.nr_seq_fatura		= vet_titulo_fatura.nr_seq_fatura and m.nr_seq_conta		= c.nr_sequencia and c.nr_seq_protocolo	= b.nr_sequencia and b.nr_seq_congenere	= cg.nr_sequencia    and b.dt_mes_competencia	<= dt_final_w and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(c.ie_tipo_segurado,'X'))
			or (coalesce(ie_tipo_segurado_w,'X') = 'X')) and m.ie_status not in ('D','M') and ((ie_gerar_ind_classif_w <> 'N')
			or	m.cd_conta_cred in (	select c.cd_conta_contabil
								from 	conta_contabil c
								where	c.ie_tipo = 'A'
								and 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '2.1.1')) ) alias68
		where (vl_saldo_orig - vl_imposto) > 0
		order by nr_titulo,
			vl_pagar;

vet_itens_fatura c_itens_fatura%rowtype;

c_itens_outros CURSOR FOR
	SELECT	ie_tipo_evento,
		nm_prestador,
		nr_cpf_cnpj,
		ie_tipo_relacao,
		nr_titulo,
		nr_seq_lote,
		dt_vencimento,
		dt_emissao,
		nr_documento,
		dt_aviso,
		cd_beneficiario,
		nm_segurado,
		vl_saldo,
		dt_contabilizacao,
		cd_conta_contabil,
		vl_item,
		vl_pagamento,
		vl_saldo_orig,
		vl_imposto,
		vl_evento,
		vl_item_evento,
		vl_vencimento,
		nr_seq_pag_item,
		nr_seq_segurado,
		nr_contrato,
		ie_tipo_contratacao,
		ie_segmentacao,
		nr_cpf_cnpj_adic,
		dt_ocorrencia,
		nm_usuario_princ,
		vl_pagar,
		nr_seq_pagador,
		ie_tipo_segurado,
		nr_protocolo_ans,
		ie_tipo_grupo_ans,
		ie_preco,
		nr_seq_congenere,
		dt_mes_competencia
	from	( 	SELECT	'R' ie_tipo_evento,
				substr(obter_nome_pf_pj(c.cd_pessoa_fisica, c.cd_cgc),1,255) nm_prestador,
				coalesce(substr(obter_dados_pf(c.cd_pessoa_fisica, 'CPF'),1,11),c.cd_cgc) nr_cpf_cnpj,
				'' ie_tipo_relacao,
				t.nr_titulo nr_titulo,
				t.nr_titulo_original nr_seq_lote,
				t.dt_vencimento_atual dt_vencimento,
				t.dt_emissao dt_emissao,
				c.nr_sequencia	nr_documento,
				trunc(coalesce(a.dt_recebimento,a.dt_mes_competencia),'dd') dt_aviso,
				substr(pls_obter_dados_segurado(s.nr_sequencia,'CR'),1,30) cd_beneficiario,
				substr(obter_nome_pf(s.cd_pessoa_fisica),1,100)	nm_segurado,
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_usuario_princ,
				substr(coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')),1,20) nr_cpf_cnpj_adic,
				round((sum(dividir_sem_round(obter_saldo_titulo_pagar(t.nr_titulo,dt_final_w) * p.vl_liberado, t.vl_titulo)))::numeric,2) vl_saldo,
				coalesce(a.dt_recebimento,a.dt_mes_competencia) dt_contabilizacao,
				p.cd_conta_cred cd_conta_contabil,
				sum(p.vl_liberado) vl_item,
				0 vl_pagamento,
				null nr_seq_conta_resumo,
				null nr_seq_pls_pag_prest,
				t.vl_titulo vl_saldo_orig,
				0 vl_imposto,
				CASE WHEN coalesce(sum(o.vl_coparticipacao),0)=0 THEN sum(p.vl_coparticipacao)  ELSE sum(o.vl_coparticipacao) END  vl_evento,
				0 vl_item_evento,
				0 vl_vencimento,
				null nr_seq_pag_item,
				c.nr_seq_segurado,
				n.ie_tipo_contratacao,
				n.ie_segmentacao,
				r.nr_contrato,
				p.dt_procedimento dt_ocorrencia,
				sum(coalesce(p.vl_liberado,0)) vl_pagar,
				s.nr_seq_pagador,
				c.ie_tipo_segurado,
				CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END  nr_protocolo_ans,
				k.ie_tipo_grupo_ans,
				n.ie_preco,
				a.nr_seq_congenere,
				a.dt_mes_competencia
			FROM titulo_pagar t, pls_protocolo_conta a, pls_conta c
LEFT OUTER JOIN pls_plano n ON (c.nr_seq_plano = n.nr_sequencia)
, pls_conta_proc p
LEFT OUTER JOIN pls_conta_coparticipacao o ON (p.nr_sequencia = o.nr_seq_conta_proc)
LEFT OUTER JOIN ans_grupo_despesa k ON (p.nr_seq_grupo_ans = k.nr_sequencia)
, pls_segurado s
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
WHERE a.nr_sequencia	= c.nr_seq_protocolo and c.nr_sequencia	= p.nr_seq_conta and s.nr_sequencia	= c.nr_seq_segurado and a.nr_sequencia	= t.nr_seq_reembolso     and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(c.ie_tipo_segurado,'X'))
			or (coalesce(ie_tipo_segurado_w,'X') = 'X')) and ((coalesce(t.dt_liquidacao::text, '') = '')
			or (t.dt_liquidacao > dt_final_w)) and a.dt_mes_competencia <= dt_final_w and t.ie_situacao not in ('D', 'C') and p.ie_status not in ('D','M') and ((ie_gerar_ind_classif_w <> 'N')
			or	p.cd_conta_cred in (select c.cd_conta_contabil
						from 	conta_contabil c
						where	c.ie_tipo = 'A'
						and 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '2.1.1')) group by 'R',
				substr(obter_nome_pf_pj(c.cd_pessoa_fisica, c.cd_cgc),1,255),
				coalesce(substr(obter_dados_pf(c.cd_pessoa_fisica, 'CPF'),1,11),c.cd_cgc),
				t.nr_titulo,
				t.nr_titulo_original,
				t.dt_emissao,
				t.dt_vencimento_atual,
				c.nr_sequencia,
				trunc(coalesce(a.dt_recebimento,a.dt_mes_competencia),'dd'),
				substr(pls_obter_dados_segurado(s.nr_sequencia,'CR'),1,30),
				substr(obter_nome_pf(s.cd_pessoa_fisica),1,100),
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255),
				substr(coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')),1,20),
				coalesce(a.dt_recebimento,a.dt_mes_competencia),
				p.cd_conta_cred,
				t.vl_titulo,
				c.nr_seq_segurado,
				n.ie_tipo_contratacao,
				n.ie_segmentacao,
				r.nr_contrato,
				p.dt_procedimento,
				s.nr_seq_pagador,
				c.ie_tipo_segurado,
				n.ie_tipo_operacao,
				n.nr_protocolo_ans,
				n.cd_scpa,
				k.ie_tipo_grupo_ans,
				n.ie_preco,
				a.nr_seq_congenere,
				a.dt_mes_competencia
			having sum(obter_saldo_titulo_pagar(t.nr_titulo,dt_final_w)) <> 0
			
union all

			select	'R' ie_tipo_evento,
				substr(obter_nome_pf_pj(c.cd_pessoa_fisica, c.cd_cgc),1,255) nm_prestador,
				coalesce(substr(obter_dados_pf(c.cd_pessoa_fisica, 'CPF'),1,11),c.cd_cgc) nr_cpf_cnpj,
				'' ie_tipo_relacao,
				t.nr_titulo nr_titulo,
				t.nr_titulo_original nr_seq_lote,
				t.dt_vencimento_atual dt_vencimento,
				t.dt_emissao dt_emissao,
				c.nr_sequencia	nr_documento,
				trunc(coalesce(a.dt_recebimento,a.dt_mes_competencia),'dd') dt_aviso,
				substr(pls_obter_dados_segurado(s.nr_sequencia,'CR'),1,30) cd_beneficiario,
				substr(obter_nome_pf(s.cd_pessoa_fisica),1,100)	nm_segurado,
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_usuario_princ,
				substr(coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')),1,20) nr_cpf_cnpj_adic,
				round((sum(dividir_sem_round(obter_saldo_titulo_pagar(t.nr_titulo,dt_final_w) * p.vl_liberado, t.vl_titulo)))::numeric,2) vl_saldo,
				coalesce(a.dt_recebimento,a.dt_mes_competencia) dt_contabilizacao,
				p.cd_conta_cred cd_conta_contabil,
				sum(p.vl_liberado) vl_item,
				0 vl_pagamento,
				null nr_seq_conta_resumo,
				null nr_seq_pls_pag_prest,
				obter_saldo_titulo_pagar(t.nr_titulo,dt_final_w) vl_saldo_orig,
				0 vl_imposto,
				CASE WHEN coalesce(sum(o.vl_coparticipacao),0)=0 THEN sum(p.vl_participacao)  ELSE sum(o.vl_coparticipacao) END  vl_evento,
				0 vl_item_evento,
				0 vl_vencimento,
				null nr_seq_pag_item,
				c.nr_seq_segurado,
				n.ie_tipo_contratacao,
				n.ie_segmentacao,
				r.nr_contrato,
				p.dt_atendimento dt_ocorrencia,
				sum(coalesce(p.vl_liberado,0)) vl_pagar,
				s.nr_seq_pagador,
				c.ie_tipo_segurado,
				CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END  nr_protocolo_ans,
				k.ie_tipo_grupo_ans,
				n.ie_preco,
				a.nr_seq_congenere,
				a.dt_mes_competencia
			FROM titulo_pagar t, pls_protocolo_conta a, pls_conta c
LEFT OUTER JOIN pls_plano n ON (c.nr_seq_plano = n.nr_sequencia)
, pls_conta_mat p
LEFT OUTER JOIN pls_conta_coparticipacao o ON (p.nr_sequencia = o.nr_seq_conta_mat)
LEFT OUTER JOIN ans_grupo_despesa k ON (p.nr_seq_grupo_ans = k.nr_sequencia)
, pls_segurado s
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
WHERE a.nr_sequencia	= c.nr_seq_protocolo and c.nr_sequencia	= p.nr_seq_conta and s.nr_sequencia	= c.nr_seq_segurado and a.nr_sequencia	= t.nr_seq_reembolso     and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(c.ie_tipo_segurado,'X'))
			or (coalesce(ie_tipo_segurado_w,'X') = 'X')) and ((coalesce(t.dt_liquidacao::text, '') = '')
			or (t.dt_liquidacao > dt_final_w)) and a.dt_mes_competencia <= dt_final_w and t.ie_situacao not in ('D', 'C') and p.ie_status not in ('D','M') and ((ie_gerar_ind_classif_w <> 'N')
			or	p.cd_conta_cred in (select c.cd_conta_contabil
						from 	conta_contabil c
						where	c.ie_tipo = 'A'
						and 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '2.1.1')) group by 'R',
				substr(obter_nome_pf_pj(c.cd_pessoa_fisica, c.cd_cgc),1,255),
				coalesce(substr(obter_dados_pf(c.cd_pessoa_fisica, 'CPF'),1,11),c.cd_cgc),
				t.nr_titulo,
				t.nr_titulo_original,
				t.dt_emissao,
				t.dt_vencimento_atual,
				c.nr_sequencia,
				trunc(coalesce(a.dt_recebimento,a.dt_mes_competencia),'dd'),
				substr(pls_obter_dados_segurado(s.nr_sequencia,'CR'),1,30),
				substr(obter_nome_pf(s.cd_pessoa_fisica),1,100),
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255),
				substr(coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')),1,20),
				coalesce(a.dt_recebimento,a.dt_mes_competencia),
				p.cd_conta_cred,
				t.vl_titulo,
				c.nr_seq_segurado,
				n.ie_tipo_contratacao,
				n.ie_segmentacao,
				r.nr_contrato,
				p.dt_atendimento,
				s.nr_seq_pagador,
				c.ie_tipo_segurado,
				n.ie_tipo_operacao,
				n.nr_protocolo_ans,
				n.cd_scpa,
				k.ie_tipo_grupo_ans,
				n.ie_preco,
				a.nr_seq_congenere,
				a.dt_mes_competencia
			having sum(obter_saldo_titulo_pagar(t.nr_titulo,dt_final_w)) <> 0
			
union all

			select  'A' ie_tipo_evento,
				max(substr(obter_nome_pf_pj(t.cd_pessoa_fisica,t.cd_cgc),1,255)) nm_prestador,
				max(coalesce(substr(obter_dados_pf(t.cd_pessoa_fisica, 'CPF'),1,11),t.cd_cgc)) nr_cpf_cnpj,
				'' ie_tipo_relacao,
				t.nr_titulo,
				null nr_seq_lote,
				max(t.dt_vencimento_atual) dt_vencimento,
				max(t.dt_emissao) dt_emissao,
				max(c.nr_sequencia) nr_documento,
				trunc(max(p.dt_mes_competencia),'dd') dt_aviso,
				max(substr(pls_obter_dados_segurado(c.nr_seq_segurado,'CR'),1,30)) cd_beneficiario,
				max(substr(pls_obter_dados_segurado(c.nr_seq_segurado,'N'),1,255)) nm_segurado,
				null nm_usuario_princ,
				null nr_cpf_cnpj_adic,
				max(obter_saldo_titulo_pagar(t.nr_titulo,dt_final_w)) vl_saldo,
				max(p.dt_mes_competencia) dt_contabilizacao,
				null cd_conta_contabil,
				0 vl_item,
				0 vl_pagamento,
				null nr_seq_conta_resumo,
				null nr_seq_pls_pag_prest,
				max(obter_saldo_titulo_pagar(t.nr_titulo,dt_final_w)) vl_saldo_orig,
				0 vl_imposto,
				0 vl_evento,
				0 vl_item_evento,
				0 vl_vencimento,
				null nr_seq_pag_item,
				max(c.nr_seq_segurado) nr_seq_segurado,
				null ie_tipo_contratacao,
				null ie_segmentacao,
				null nr_contrato,
				max(m.dt_atendimento) dt_ocorrencia,
				max(m.vl_material_imp) vl_pagar,
				null nr_seq_pagador,
				null ie_tipo_segurado,
				null nr_protocolo_ans,
				null ie_tipo_grupo_ans,
				null ie_preco,
				max(p.nr_seq_congenere),
				max(p.dt_mes_competencia)
			from 	pls_protocolo_conta 	p,
				pls_conta 		c,
				pls_conta_mat 		m,
				nota_fiscal 		n,
				nota_fiscal_adiant_pago z,
				adiantamento_pago 	a,
				titulo_pagar 		t
			where  	p.nr_sequencia 		= c.nr_seq_protocolo
			and  	c.nr_sequencia 		= m.nr_seq_conta
			and  	m.nr_seq_nota_fiscal 	= n.nr_sequencia
			and  	z.nr_sequencia_nf 	= n.nr_sequencia
			and  	z.nr_adiantamento 	= a.nr_adiantamento
			and  	t.nr_adiant_pago  	= a.nr_adiantamento
			and	((coalesce(t.dt_liquidacao::text, '') = '')
			or (t.dt_liquidacao > dt_final_w))
			and  	p.dt_mes_competencia 	<= dt_final_w
			and  	(m.nr_seq_nota_fiscal IS NOT NULL AND m.nr_seq_nota_fiscal::text <> '')
			and	m.ie_status not in ('D','M')
			and 	t.ie_situacao <> 'C'
			group by t.nr_titulo) alias171
		where (vl_saldo_orig - vl_imposto) > 0
		order by nr_titulo;

vet_itens_outros c_itens_outros%rowtype;

c_itens_discussao CURSOR FOR
	SELECT 	'P' ie_tipo_evento,
		substr(pls_obter_dados_prestador(d.nr_seq_prestador_exec,'N'),1,255) nm_prestador,
		substr(coalesce(pls_obter_dados_prestador(d.nr_seq_prestador_exec,'CPF'),
			pls_obter_dados_prestador(d.nr_seq_prestador_exec,'CGC')),1,20) nr_cpf_cnpj,
		(SELECT	x.ie_tipo_relacao
		from	pls_prestador	x
		where	x.nr_sequencia	= d.nr_seq_prestador_exec) ie_tipo_relacao,
		t.nr_titulo,
		l.nr_sequencia nr_seq_lote,
		d.nr_sequencia nr_documento,
		t.dt_emissao,
		trunc(coalesce(e.dt_recebimento,e.dt_mes_competencia),'dd') dt_aviso,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'CR'),1,30) cd_beneficiario,
		substr(obter_nome_pf(s.cd_pessoa_fisica),1,100) nm_segurado,
		substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_usuario_princ,
		substr(coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')),1,20) nr_cpf_cnpj_adic,
		obter_saldo_titulo_pagar(t.nr_titulo,dt_final_w) vl_saldo,
		coalesce(e.dt_recebimento,e.dt_mes_competencia) dt_contabilizacao,
		p.cd_conta_cred cd_conta_contabil,
		p.vl_ndc vl_item,
		0 vl_pagamento,
		null nr_seq_conta_resumo,
		obter_saldo_titulo_pagar(t.nr_titulo,dt_final_w) vl_saldo_orig,
		(select	coalesce(sum(f.vl_imposto),0)
		from	titulo_pagar_imposto 	f,
			tributo 		c
		where	f.cd_tributo	= c.cd_tributo
		and	f.nr_titulo	= t.nr_titulo
		and	f.ie_pago_prev 	= 'V'
		and	coalesce(c.ie_saldo_tit_pagar,'S')	= 'S') vl_imposto,
		0 vl_evento,
		round((dividir_sem_round(obter_saldo_titulo_pagar(t.nr_titulo,dt_final_w) * p.vl_ndc, t.vl_titulo))::numeric,2) vl_item_evento,
		t.dt_vencimento_atual dt_vencimento,
		null nr_seq_pag_item,
		s.nr_sequencia nr_seq_segurado,
		n.ie_tipo_contratacao,
		n.ie_segmentacao,
		w.nr_contrato,
		(select	x.dt_procedimento
		from	pls_conta_proc	x
		where	x.nr_sequencia	= p.nr_seq_conta_proc
		and	d.nr_sequencia	= x.nr_seq_conta) dt_ocorrencia,
		(p.vl_ndc + p.vl_negado) vl_pagar,
		s.nr_seq_pagador,
		d.nr_seq_prestador_exec nr_seq_prestador,
		d.ie_tipo_segurado,
		CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END  nr_protocolo_ans,
		'TP' ie_tipo_documento,
		n.ie_preco,
		e.nr_seq_congenere,
		e.dt_mes_competencia
	FROM titulo_pagar t, pls_discussao_proc p, pls_contestacao_discussao o, pls_lote_discussao l, pls_protocolo_conta e, pls_contestacao c, pls_conta d
LEFT OUTER JOIN pls_plano n ON (d.nr_seq_plano = n.nr_sequencia)
, pls_segurado s
LEFT OUTER JOIN pls_contrato w ON (s.nr_seq_contrato = w.nr_sequencia)
WHERE l.nr_titulo_pagar	= t.nr_titulo and l.nr_sequencia		= o.nr_seq_lote and c.nr_sequencia		= o.nr_seq_contestacao and o.nr_sequencia		= p.nr_seq_discussao and d.nr_sequencia		= c.nr_seq_conta and e.nr_sequencia		= d.nr_seq_protocolo and s.nr_sequencia		= d.nr_seq_segurado   and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(d.ie_tipo_segurado,'X'))
	or (coalesce(ie_tipo_segurado_w,'X') = 'X')) and p.ie_tipo_acordo	= '01' and ((coalesce(t.dt_liquidacao::text, '') = '')
	or (t.dt_liquidacao > dt_final_w)) and coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento and obter_empresa_estab(t.cd_estabelecimento) = cd_empresa_p and t.vl_titulo > 0 and obter_saldo_titulo_pagar(t.nr_titulo,dt_final_w) <> 0 and l.dt_fechamento	<= dt_final_w and ((ie_gerar_ind_classif_w <> 'N')
	or	p.cd_conta_cred   in (select c.cd_conta_contabil
					from 	conta_contabil c
					where	c.ie_tipo = 'A'
					and 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '2.1.1')) and t.ie_situacao <> 'C'
	
union all

	select 	'P' ie_tipo_evento,
		substr(pls_obter_dados_prestador(d.nr_seq_prestador_exec,'N'),1,255) nm_prestador,
		substr(coalesce(pls_obter_dados_prestador(d.nr_seq_prestador_exec,'CPF'),
			pls_obter_dados_prestador(d.nr_seq_prestador_exec,'CGC')),1,20) nr_cpf_cnpj,
		(select	x.ie_tipo_relacao
		from	pls_prestador	x
		where	x.nr_sequencia	= d.nr_seq_prestador_exec) ie_tipo_relacao,
		t.nr_titulo,
		l.nr_sequencia nr_seq_lote,
		d.nr_sequencia nr_documento,
		t.dt_emissao,
		trunc(coalesce(e.dt_recebimento,e.dt_mes_competencia),'dd') dt_aviso,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'CR'),1,30) cd_beneficiario,
		substr(obter_nome_pf(s.cd_pessoa_fisica),1,100) nm_segurado,
		substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_usuario_princ,
		substr(coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')),1,20) nr_cpf_cnpj_adic,
		obter_saldo_titulo_pagar(t.nr_titulo,dt_final_w) vl_saldo,
		coalesce(e.dt_recebimento,e.dt_mes_competencia) dt_contabilizacao,
		m.cd_conta_cred cd_conta_contabil,
		m.vl_ndc vl_item,
		0 vl_pagamento,
		null nr_seq_conta_resumo,
		obter_saldo_titulo_pagar(t.nr_titulo,dt_final_w) vl_saldo_orig,
		(select	coalesce(sum(f.vl_imposto),0)
		from	titulo_pagar_imposto 	f,
			tributo 		c
		where	f.cd_tributo	= c.cd_tributo
		and	f.nr_titulo	= t.nr_titulo
		and	f.ie_pago_prev 	= 'V'
		and	coalesce(c.ie_saldo_tit_pagar,'S')	= 'S') vl_imposto,
		0 vl_evento,
		round((dividir_sem_round(obter_saldo_titulo_pagar(t.nr_titulo,dt_final_w) * m.vl_ndc, t.vl_titulo))::numeric,2) vl_item_evento,
		t.dt_vencimento_atual dt_vencimento,
		null nr_seq_pag_item,
		s.nr_sequencia nr_seq_segurado,
		n.ie_tipo_contratacao,
		n.ie_segmentacao,
		w.nr_contrato,
		(select	x.dt_atendimento
		from	pls_conta_mat	x
		where	x.nr_sequencia	= m.nr_seq_conta_mat
		and	d.nr_sequencia	= x.nr_seq_conta) dt_ocorrencia,
		(m.vl_ndc + m.vl_negado) vl_pagar,
		s.nr_seq_pagador,
		d.nr_seq_prestador_exec nr_seq_prestador,
		d.ie_tipo_segurado,
		CASE WHEN n.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(n.nr_protocolo_ans, n.cd_scpa) END  nr_protocolo_ans,
		'TP' ie_tipo_documento,
		n.ie_preco,
		e.nr_seq_congenere,
		e.dt_mes_competencia
	FROM titulo_pagar t, pls_contestacao_discussao o, pls_discussao_mat m, pls_lote_discussao l, pls_protocolo_conta e, pls_contestacao c, pls_conta d
LEFT OUTER JOIN pls_plano n ON (d.nr_seq_plano = n.nr_sequencia)
, pls_segurado s
LEFT OUTER JOIN pls_contrato w ON (s.nr_seq_contrato = w.nr_sequencia)
WHERE l.nr_titulo_pagar	= t.nr_titulo and l.nr_sequencia		= o.nr_seq_lote and c.nr_sequencia		= o.nr_seq_contestacao and o.nr_sequencia		= m.nr_seq_discussao and d.nr_sequencia		= c.nr_seq_conta and e.nr_sequencia		= d.nr_seq_protocolo and s.nr_sequencia		= d.nr_seq_segurado   and m.ie_tipo_acordo	= '01' and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(d.ie_tipo_segurado,'X'))
	or (coalesce(ie_tipo_segurado_w,'X') = 'X')) and ((coalesce(t.dt_liquidacao::text, '') = '')
	or (t.dt_liquidacao > dt_final_w)) and coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento and obter_empresa_estab(t.cd_estabelecimento) = cd_empresa_p and t.vl_titulo > 0 and obter_saldo_titulo_pagar(t.nr_titulo,dt_final_w) <> 0 and l.dt_fechamento	<= dt_final_w and ((ie_gerar_ind_classif_w <> 'N')
	or	m.cd_conta_cred   in (select c.cd_conta_contabil
					from 	conta_contabil c
					where	c.ie_tipo = 'A'
					and 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '2.1.1')) and t.ie_situacao <> 'C';
vet_itens_discussao c_itens_discussao%rowtype;

c_titulo_ress_sus CURSOR FOR
	SELECT 	g.nr_sequencia nr_seq_proc_gru,
		t.nr_titulo nr_titulo,
		t.nr_seq_processo nr_seq_processo,
		t.dt_vencimento_atual dt_vencimento,
		t.dt_emissao dt_emissao,
		obter_saldo_titulo_pagar(t.nr_titulo,dt_final_w) vl_saldo,
		t.vl_titulo vl_titulo
	from	titulo_pagar t,
		pls_processo_gru g
	where	t.nr_seq_proc_gru	= g.nr_sequencia
	and	((coalesce(t.dt_liquidacao::text, '') = '')
	or (t.dt_liquidacao > dt_final_w))
	and  	coalesce(cd_estabelecimento_p,t.cd_estabelecimento) = t.cd_estabelecimento
	and	t.vl_titulo > 0
	and	t.ie_situacao <> 'C';

vet_titulo_ress_sus c_titulo_ress_sus%rowtype;

c_itens_ress_sus CURSOR FOR
	SELECT 	c.nr_seq_prestador nr_seq_prestador,
		c.nr_sequencia nr_documento,
		r.nr_sequencia nr_seq_contrato,
		a.ie_tipo_contratacao ie_tipo_contratacao,
		a.ie_segmentacao ie_segmentacao,
		s.nr_sequencia nr_seq_segurado,
		s.nr_seq_pagador nr_seq_pagador,
		(SELECT	x.ie_tipo_relacao
		from	pls_prestador	x
		where	x.nr_sequencia	= c.nr_seq_prestador) ie_tipo_relacao,
		s.ie_tipo_segurado ie_tipo_segurado,
		CASE WHEN a.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
		a.ie_preco ie_preco,
		c.cd_conta_cred cd_conta_contabil,
		p.dt_processo dt_aviso,
		p.dt_processo dt_contabilizacao,
		c.dt_internacao dt_ocorrencia,
		c.vl_ressarcir vl_pagar,
		substr(pls_obter_dados_prestador(c.nr_seq_prestador,'N'),1,255) nm_prestador,
		substr(coalesce(pls_obter_dados_prestador(c.nr_seq_prestador,'CPF'),
			pls_obter_dados_prestador(c.nr_seq_prestador,'CGC')),1,20) nr_cpf_cnpj,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
		substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_segurado,
		substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_usuario_princ,
		substr(coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),
			pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')),1,20) nr_cpf_cnpj_adic,
		r.nr_contrato nr_contrato
	FROM pls_processo p, pls_processo_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
LEFT OUTER JOIN pls_plano a ON (s.nr_seq_plano = a.nr_sequencia)
WHERE p.nr_sequencia		= c.nr_seq_processo    and (p.nr_sequencia		= vet_titulo_ress_sus.nr_seq_processo
	or 	coalesce(vet_titulo_ress_sus.nr_seq_processo::text, '') = '') and c.nr_seq_proc_gru	= vet_titulo_ress_sus.nr_seq_proc_gru and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and ((ie_gerar_ind_classif_w <> 'N')
	or (c.cd_conta_cred in (	select cc.cd_conta_contabil
						from 	conta_contabil cc
						where	cc.ie_tipo = 'A'
						and 	substr(ctb_obter_classif_conta(cc.cd_conta_contabil, cc.cd_classificacao, cc.dt_inicio_vigencia),1,5) = '2.1.1')));

vet_itens_ress_sus c_itens_ress_sus%rowtype;
				
BEGIN

CALL wheb_usuario_pck.set_ie_executar_trigger('N');

select	coalesce(max(a.ie_gerar_ind_classif),'N'),
	max(ie_tipo_segurado)
into STRICT	ie_gerar_ind_classif_w,
	ie_tipo_segurado_w
from	ctb_livro_auxiliar	a
where	a.nr_sequencia	= nr_seq_regra_p;

select	coalesce(max(a.ie_data_tipo_segurado),'A')
into STRICT	ie_data_tipo_segurado_w
from	pls_parametros a
where	a.cd_estabelecimento = cd_estabelecimento_p;

select	substr(obter_desc_expressao(922923),1,255)
into STRICT	ds_observacao_w
;

nr_contador_w	:= 0;

dt_final_w := fim_mes(dt_final_p);

if (ie_gerar_arquivo_p = 'N') then

	delete
	from	w_ctb_livro_aux_event_liq a
	where	a.nr_seq_reg_auxiliar	= nr_seq_regra_p;

	commit;

	vl_acumulado_w	:= 0;
	nr_titulo_ant_w := 0;
	qt_registros_w 	:= 0;

	open c_titulo_conta;
	loop
	fetch c_titulo_conta into	
		vet_titulo_conta;
	EXIT WHEN NOT FOUND; /* apply on c_titulo_conta */
		begin
		
		open c_itens_conta;
		loop
		fetch c_itens_conta into	
			vet_itens_conta;
		EXIT WHEN NOT FOUND; /* apply on c_itens_conta */
			begin
			
			if (ie_data_tipo_segurado_w = 'A') then
				dt_ref_repasse_w	:= vet_itens_conta.dt_ocorrencia;
			else
				dt_ref_repasse_w	:= vet_itens_conta.dt_mes_competencia;
			end if;
			
			SELECT * FROM pls_obter_dados_repasse(	vet_itens_conta.dt_ocorrencia, vet_itens_conta.nr_seq_segurado, vet_itens_conta.nr_seq_congenere, ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w) INTO STRICT ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w;

			ie_tipo_documento_w	:= 'CM';
			
			nr_contador_w		:= nr_contador_w + 1;
			
			qt_classif_diops_w 	:= dt_final_w - vet_titulo_conta.dt_vencimento;

			if	((obter_dias_entre(vet_itens_conta.dt_aviso, dt_final_w) + 1) > 30) then
				ds_classif_pel_w	:= obter_desc_expressao(778506);
			else
				ds_classif_pel_w	:= obter_desc_expressao(778508);
			end if;

			if (qt_classif_diops_w > 120) then
				ds_classif_diops_w := obter_desc_expressao(492546);
			elsif (qt_classif_diops_w > 90) then
				ds_classif_diops_w	:= obter_desc_expressao(491705);
			elsif (qt_classif_diops_w > 60) then
				ds_classif_diops_w	:= obter_desc_expressao(490311);
			elsif (qt_classif_diops_w > 30) then
				ds_classif_diops_w	:= obter_desc_expressao(490310);
			elsif (qt_classif_diops_w > 0) then
				ds_classif_diops_w	:= obter_desc_expressao(490309);
			else
				ds_classif_diops_w	:= obter_desc_expressao(330037);
			end if;
		
			ds_observacao_item_w	:= null;
		
			if (vet_itens_conta.ie_tipo_segurado in ('C','I','T')) then
				ds_observacao_item_w	:= ds_observacao_w;
			end if;
			
			insert into w_ctb_livro_aux_event_liq(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nm_prestador,
				nr_cpf_cnpj,
				ie_tipo_relacao,
				ds_tipo_relacao,
				nr_titulo,
				nr_evento,
				dt_vencimento,
				cd_conta_contabil,
				nr_documento,
				dt_conhecimento,
				nr_seq_segurado,
				cd_beneficiario,
				nm_usuario_evento,
				nm_usuario_princ,
				nr_cpf_cnpj_adic,
				dt_emissao,
				nr_contrato,
				ie_tipo_contratacao,
				ds_tipo_contratacao,
				ie_segmentacao,
				ds_segmentacao,
				dt_ocorrencia,
				vl_evento,
				dt_contabilizacao,
				ds_classif_pel,
				ds_classif_diops,
				vl_pagar,
				nr_seq_pagador,
				nr_seq_prestador,
				ie_tipo_segurado,
				ds_tipo_segurado,
				ie_tipo_livro,
				dt_referencia,
				nr_linha,
				nr_seq_reg_auxiliar,
				ie_tipo_documento,
				ds_tipo_documento,
				nr_protocolo_ans,
				ie_tipo_evento,
				ds_observacao,
				ie_preco,
				ie_tipo_compartilhamento,
				ie_tipo_repasse,
				dt_inicio_compartilhamento,
				dt_fim_compartilhamento)
			values (	nextval('w_ctb_livro_aux_event_liq_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				vet_itens_conta.nm_prestador,
				vet_itens_conta.nr_cpf_cnpj,
				vet_itens_conta.ie_tipo_relacao,
				substr(obter_valor_dominio(1668,vet_itens_conta.ie_tipo_relacao),1,255),
				vet_itens_conta.nr_titulo,
				vet_itens_conta.nr_seq_lote,
				vet_titulo_conta.dt_vencimento,
				vet_itens_conta.cd_conta_contabil,
				vet_itens_conta.nr_documento,
				vet_itens_conta.dt_aviso,
				vet_itens_conta.nr_seq_segurado,
				vet_itens_conta.cd_beneficiario,
				vet_itens_conta.nm_segurado,
				vet_itens_conta.nm_usuario_princ,
				vet_itens_conta.nr_cpf_cnpj_adic,
				vet_itens_conta.dt_emissao,
				vet_itens_conta.nr_contrato,
				vet_itens_conta.ie_tipo_contratacao,
				obter_valor_dominio(1666,vet_itens_conta.ie_tipo_contratacao),
				vet_itens_conta.ie_segmentacao,
				obter_valor_dominio(1665,vet_itens_conta.ie_segmentacao),
				vet_itens_conta.dt_ocorrencia,
				vl_pagar_w,
				vet_itens_conta.dt_contabilizacao,
				ds_classif_pel_w,
				ds_classif_diops_w,
				vet_itens_conta.vl_pagar,
				vet_itens_conta.nr_seq_pagador,
				vet_itens_conta.nr_seq_prestador,
				vet_itens_conta.ie_tipo_segurado,
				substr(obter_valor_dominio(2406, vet_itens_conta.ie_tipo_segurado),1,255),
				1,
				dt_final_w,
				nr_contador_w,
				nr_seq_regra_p,
				ie_tipo_documento_w,
				obter_valor_dominio(8372,ie_tipo_documento_w),
				vet_itens_conta.nr_protocolo_ans,
				vet_itens_conta.ie_tipo_grupo_ans,
				ds_observacao_item_w,
				vet_itens_conta.ie_preco,
				ie_tipo_compartilhamento_w,
				ie_tipo_repasse_w,
				dt_repasse_w,
				dt_fim_repasse_w);
				
			if (mod(nr_contador_w, 1000) = 0) then
				commit;
			end if;
			
			end;
		end loop;
		close c_itens_conta;
		
		end;
	end loop;
	close c_titulo_conta;
	
	open c_titulo_venc;
	loop
	fetch c_titulo_venc into
		vet_titulo_venc;
	EXIT WHEN NOT FOUND; /* apply on c_titulo_venc */
		begin
		
		open c_itens_venc;
		loop
		fetch c_itens_venc into
			vet_itens_venc;
		EXIT WHEN NOT FOUND; /* apply on c_itens_venc */
			begin
			
			if (vet_itens_venc.ie_tipo_evento = 'T' and coalesce(vet_itens_venc.nr_seq_pag_item, 0) <> 0) then
				select	max(nr_seq_conta)
				into STRICT	nr_seq_conta_w
				from	pls_conta_medica_resumo a
				where	a.nr_seq_pag_item	= vet_itens_venc.nr_seq_pag_item;

				select 	max(nr_sequencia)
				into STRICT	nr_seq_resumo_w
				from	pls_conta_medica_resumo a
				where	a.nr_seq_conta 		= nr_seq_conta_w
				and	a.nr_seq_pag_item	= vet_itens_venc.nr_seq_pag_item;

				if (coalesce(nr_seq_conta_w, 0) <> 0 and coalesce(nr_seq_resumo_w, 0) <> 0) then
					select 	substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
						substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_segurado,
						substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_usuario_princ,
						substr(coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),
							pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')),1,20) nr_cpf_cnpj_adic,
						s.nr_sequencia nr_seq_segurado,
						a.ie_tipo_contratacao ie_tipo_contratacao,
						a.ie_segmentacao ie_segmentacao,
						r.nr_contrato nr_contrato,
						(select	x.dt_procedimento
						from	pls_conta_proc	x
						where	x.nr_sequencia	= d.nr_seq_conta_proc
						and	c.nr_sequencia	= x.nr_seq_conta
						
union all

						select	y.dt_atendimento
						from	pls_conta_mat	y
						where	y.nr_sequencia	= d.nr_seq_conta_mat
						and	c.nr_sequencia	= y.nr_seq_conta) dt_ocorrencia,
						s.nr_seq_pagador nr_seq_pagador,
						c.ie_tipo_segurado ie_tipo_segurado,
						CASE WHEN a.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
						k.ie_tipo_grupo_ans ie_tipo_grupo_ans,
						a.ie_preco ie_preco,
						e.nr_seq_congenere nr_seq_congenere
					into STRICT	vet_itens_venc.cd_beneficiario,
						vet_itens_venc.nm_segurado,
						vet_itens_venc.nm_usuario_princ,
						vet_itens_venc.nr_cpf_cnpj_adic,
						vet_itens_venc.nr_seq_segurado,
						vet_itens_venc.ie_tipo_contratacao,
						vet_itens_venc.ie_segmentacao,
						vet_itens_venc.nr_contrato,
						vet_itens_venc.dt_ocorrencia,
						vet_itens_Venc.nr_seq_pagador,
						vet_itens_venc.ie_tipo_segurado,
						vet_itens_venc.nr_protocolo_ans,
						vet_itens_venc.ie_tipo_grupo_ans,
						vet_itens_venc.ie_preco,
						vet_itens_venc.nr_seq_congenere
					FROM pls_protocolo_conta e, pls_conta c, pls_plano a, pls_segurado s
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
, pls_conta_medica_resumo d
LEFT OUTER JOIN ans_grupo_despesa k ON (d.nr_seq_grupo_ans = k.nr_sequencia)
WHERE c.nr_seq_segurado	= s.nr_sequencia and a.nr_sequencia 		= s.nr_seq_plano  and c.nr_seq_protocolo 	= e.nr_sequencia and d.nr_seq_conta		= c.nr_sequencia  and d.nr_sequencia		= nr_seq_resumo_w and c.nr_sequencia		= nr_seq_conta_w;
				end if;
			end if;
			
			if (ie_data_tipo_segurado_w = 'A') then
				dt_ref_repasse_w	:= vet_itens_venc.dt_ocorrencia;
			else
				dt_ref_repasse_w	:= vet_itens_venc.dt_mes_competencia;
			end if;
			
			SELECT * FROM pls_obter_dados_repasse(	vet_itens_venc.dt_ocorrencia, vet_itens_venc.nr_seq_segurado, vet_itens_venc.nr_seq_congenere, ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w) INTO STRICT ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w;

			ie_tipo_documento_w	:= vet_itens_venc.ie_tipo_documento;
		
			nr_contador_w		:= nr_contador_w + 1;
			
			if (vet_itens_venc.ie_tipo_evento <> 'T') then
				vl_pagar_int_w	:= dividir_sem_round(vet_itens_venc.vl_item * vet_itens_venc.vl_saldo,vet_itens_venc.vl_vencimento);
			else
				vl_pagar_int_w 	:= vet_itens_venc.vl_item;
			end if;
			
			vl_pagar_w		:= trunc(vl_pagar_int_w,2);
			vl_sobra_w		:= vl_sobra_w + (vl_pagar_int_w - vl_pagar_w);

			qt_classif_diops_w 	:= dt_final_w - vet_titulo_venc.dt_vencimento;

			if	((obter_dias_entre(vet_itens_venc.dt_aviso, dt_final_w) + 1) > 30) then
				ds_classif_pel_w	:= obter_desc_expressao(778506);
			else
				ds_classif_pel_w	:= obter_desc_expressao(778508);
			end if;

			if (qt_classif_diops_w > 120) then
				ds_classif_diops_w 	:= obter_desc_expressao(492546);
			elsif (qt_classif_diops_w > 90) then
				ds_classif_diops_w	:= obter_desc_expressao(491705);
			elsif (qt_classif_diops_w > 60) then
				ds_classif_diops_w	:= obter_desc_expressao(490311);
			elsif (qt_classif_diops_w > 30) then
				ds_classif_diops_w	:= obter_desc_expressao(490310);
			elsif (qt_classif_diops_w > 0) then
				ds_classif_diops_w	:= obter_desc_expressao(490309);
			else
				ds_classif_diops_w	:= obter_desc_expressao(330037);
			end if;
			
			select	nextval('w_ctb_livro_aux_event_liq_seq')
			into STRICT	nr_seq_event_liq_w
			;
			
			ctb_livro_aux_event_liq_w[nr_contador_w].nr_sequencia                     := nr_seq_event_liq_w;
			ctb_livro_aux_event_liq_w[nr_contador_w].dt_atualizacao                   := clock_timestamp();
			ctb_livro_aux_event_liq_w[nr_contador_w].nm_usuario                       := nm_usuario_p;
			ctb_livro_aux_event_liq_w[nr_contador_w].dt_atualizacao_nrec              := clock_timestamp();
			ctb_livro_aux_event_liq_w[nr_contador_w].nm_usuario_nrec                  := nm_usuario_p;
			ctb_livro_aux_event_liq_w[nr_contador_w].nm_prestador                     := vet_itens_venc.nm_prestador;
			ctb_livro_aux_event_liq_w[nr_contador_w].nr_cpf_cnpj                      := vet_itens_venc.nr_cpf_cnpj;
			ctb_livro_aux_event_liq_w[nr_contador_w].ie_tipo_relacao                  := vet_itens_venc.ie_tipo_relacao;
			ctb_livro_aux_event_liq_w[nr_contador_w].ds_tipo_relacao                  := substr(obter_valor_dominio(1668,vet_itens_venc.ie_tipo_relacao),1,255);
			ctb_livro_aux_event_liq_w[nr_contador_w].nr_titulo                        := vet_itens_venc.nr_titulo;
			ctb_livro_aux_event_liq_w[nr_contador_w].nr_evento                        := vet_itens_venc.nr_seq_lote;
			ctb_livro_aux_event_liq_w[nr_contador_w].dt_vencimento                    := vet_titulo_venc.dt_vencimento;
			ctb_livro_aux_event_liq_w[nr_contador_w].cd_conta_contabil                := vet_itens_venc.cd_conta_contabil;
			ctb_livro_aux_event_liq_w[nr_contador_w].nr_documento                     := vet_itens_venc.nr_documento;
			ctb_livro_aux_event_liq_w[nr_contador_w].dt_conhecimento                  := vet_itens_venc.dt_aviso;
			ctb_livro_aux_event_liq_w[nr_contador_w].nr_seq_segurado                  := vet_itens_venc.nr_seq_segurado;
			ctb_livro_aux_event_liq_w[nr_contador_w].cd_beneficiario                  := vet_itens_venc.cd_beneficiario;
			ctb_livro_aux_event_liq_w[nr_contador_w].nm_usuario_evento                := vet_itens_venc.nm_segurado;
			ctb_livro_aux_event_liq_w[nr_contador_w].nm_usuario_princ                 := vet_itens_venc.nm_usuario_princ;
			ctb_livro_aux_event_liq_w[nr_contador_w].nr_cpf_cnpj_adic                 := vet_itens_venc.nr_cpf_cnpj_adic;
			ctb_livro_aux_event_liq_w[nr_contador_w].dt_emissao                       := vet_itens_venc.dt_emissao;
			ctb_livro_aux_event_liq_w[nr_contador_w].nr_contrato                      := vet_itens_venc.nr_contrato;
			ctb_livro_aux_event_liq_w[nr_contador_w].ie_tipo_contratacao              := vet_itens_venc.ie_tipo_contratacao;
			ctb_livro_aux_event_liq_w[nr_contador_w].ds_tipo_contratacao              := obter_valor_dominio(1666,vet_itens_venc.ie_tipo_contratacao);
			ctb_livro_aux_event_liq_w[nr_contador_w].ie_segmentacao                   := vet_itens_venc.ie_segmentacao;
			ctb_livro_aux_event_liq_w[nr_contador_w].ds_segmentacao                   := obter_valor_dominio(1665,vet_itens_venc.ie_segmentacao);
			ctb_livro_aux_event_liq_w[nr_contador_w].dt_ocorrencia                    := vet_itens_venc.dt_ocorrencia;
			ctb_livro_aux_event_liq_w[nr_contador_w].vl_evento                        := vl_pagar_w;
			ctb_livro_aux_event_liq_w[nr_contador_w].dt_contabilizacao                := vet_itens_venc.dt_contabilizacao;
			ctb_livro_aux_event_liq_w[nr_contador_w].ds_classif_pel                   := ds_classif_pel_w;
			ctb_livro_aux_event_liq_w[nr_contador_w].ds_classif_diops                 := ds_classif_diops_w;
			ctb_livro_aux_event_liq_w[nr_contador_w].vl_pagar                         := vl_pagar_w;
			ctb_livro_aux_event_liq_w[nr_contador_w].nr_seq_pagador                   := vet_itens_venc.nr_seq_pagador;
			ctb_livro_aux_event_liq_w[nr_contador_w].nr_seq_prestador                 := vet_itens_venc.nr_seq_prestador;
			ctb_livro_aux_event_liq_w[nr_contador_w].ie_tipo_segurado                 := vet_itens_venc.ie_tipo_segurado;
			ctb_livro_aux_event_liq_w[nr_contador_w].ds_tipo_segurado		  := substr(obter_valor_dominio(2406, vet_itens_venc.ie_tipo_segurado),1,255);
			ctb_livro_aux_event_liq_w[nr_contador_w].ie_tipo_livro                    := 1;
			ctb_livro_aux_event_liq_w[nr_contador_w].dt_referencia                    := dt_final_w;
			ctb_livro_aux_event_liq_w[nr_contador_w].nr_linha                         := nr_contador_w;
			ctb_livro_aux_event_liq_w[nr_contador_w].nr_seq_reg_auxiliar              := nr_seq_regra_p;
			ctb_livro_aux_event_liq_w[nr_contador_w].ie_tipo_documento                := ie_tipo_documento_w;
			ctb_livro_aux_event_liq_w[nr_contador_w].ds_tipo_documento                := obter_valor_dominio(8372,ie_tipo_documento_w);
			ctb_livro_aux_event_liq_w[nr_contador_w].nr_protocolo_ans                 := vet_itens_venc.nr_protocolo_ans;
			ctb_livro_aux_event_liq_w[nr_contador_w].ie_tipo_evento			  := vet_itens_venc.ie_tipo_grupo_ans;
			ctb_livro_aux_event_liq_w[nr_contador_w].ie_preco			  := vet_itens_venc.ie_preco;
			ctb_livro_aux_event_liq_w[nr_contador_w].ie_tipo_compartilhamento	  := ie_tipo_compartilhamento_w;
			ctb_livro_aux_event_liq_w[nr_contador_w].ie_tipo_repasse		  := ie_tipo_repasse_w;
			ctb_livro_aux_event_liq_w[nr_contador_w].dt_inicio_compartilhamento	  := dt_repasse_w;
			ctb_livro_aux_event_liq_w[nr_contador_w].dt_fim_compartilhamento	  := dt_fim_repasse_w;
		
			if (vet_itens_venc.ie_tipo_segurado in ('C','I','T')) then
				ctb_livro_aux_event_liq_w[nr_contador_w].ds_observacao		:= ds_observacao_w;
			else
				ctb_livro_aux_event_liq_w[nr_contador_w].ds_observacao		:= null;
			end if;
			
			if (mod(nr_contador_w, 1000) = 0) then
			
				forall i in ctb_livro_aux_event_liq_w.first .. ctb_livro_aux_event_liq_w.last
					insert into w_ctb_livro_aux_event_liq values ctb_livro_aux_event_liq_w(i);

				commit;
				
				ctb_livro_aux_event_liq_w.delete;
			end if;
			
			
			end;
		end loop;
		close c_itens_venc;
		
		vl_sobra_w	:= round((vl_sobra_w)::numeric,2);
	
		if (trunc(vl_sobra_w,2) > 0) and (ctb_livro_aux_event_liq_w.count > 0) then
			ctb_livro_aux_event_liq_w[nr_contador_w].vl_pagar	:= ctb_livro_aux_event_liq_w[nr_contador_w].vl_pagar + vl_sobra_w;
			ctb_livro_aux_event_liq_w[nr_contador_w].vl_evento	:= ctb_livro_aux_event_liq_w[nr_contador_w].vl_evento + vl_sobra_w;
			
		elsif (trunc(vl_sobra_w,2) > 0) and (ctb_livro_aux_event_liq_w.count = 0) then
			update	w_ctb_livro_aux_event_liq
			set	vl_pagar	= vl_pagar	+ vl_sobra_w,
				vl_evento	= vl_evento	+ vl_sobra_w
			where	nr_sequencia	= nr_seq_event_liq_w
			and 	nr_seq_reg_auxiliar	= nr_seq_regra_p;
		end if;
		
		vl_sobra_w	:= 0;
	
		end;
		
	end loop;
	close c_titulo_venc;

	forall i in ctb_livro_aux_event_liq_w.first .. ctb_livro_aux_event_liq_w.last
		insert into w_ctb_livro_aux_event_liq values ctb_livro_aux_event_liq_w(i);
	
	commit;	
	
	ctb_livro_aux_event_liq_w.delete;
	
	open c_titulo_fatura;
	loop
	fetch c_titulo_fatura into
		vet_titulo_fatura;
	EXIT WHEN NOT FOUND; /* apply on c_titulo_fatura */
		begin
		
		open c_itens_fatura;
		loop
		fetch c_itens_fatura into
			vet_itens_fatura;
		EXIT WHEN NOT FOUND; /* apply on c_itens_fatura */
			begin
			
			if (ie_data_tipo_segurado_w = 'A') then
				dt_ref_repasse_w	:= vet_itens_fatura.dt_ocorrencia;
			else
				dt_ref_repasse_w	:= vet_itens_fatura.dt_contabilizacao;
			end if;
			
			SELECT * FROM pls_obter_dados_repasse(	vet_itens_fatura.dt_ocorrencia, vet_itens_fatura.nr_seq_segurado, vet_itens_fatura.nr_seq_congenere, ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w) INTO STRICT ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w;

			ie_tipo_documento_w	:= 'CM';
			
			nr_contador_w		:= nr_contador_w + 1;

			if (vet_itens_fatura.ie_tipo_evento = 'I') then

				vl_pagar_w := vet_itens_fatura.vl_saldo;

				if (nr_titulo_ant_w = vet_itens_fatura.nr_titulo) then
					vl_acumulado_w := vl_acumulado_w + vl_pagar_w;
					qt_registros_w := qt_registros_w + 1;

					if (qt_registros_w = qt_itens_rateio_w) then
						if (vl_liquido_w > vl_acumulado_w) then
							vl_pagar_w := vl_pagar_w + (vl_liquido_w - vl_acumulado_w );
						elsif (vl_liquido_w < vl_acumulado_w) then
							vl_pagar_w := vl_pagar_w - (vl_acumulado_w - vl_liquido_w);
						end if;
					end if;
				else
					nr_titulo_ant_w := vet_itens_fatura.nr_titulo;
					vl_acumulado_w := vl_pagar_w;
					qt_registros_w := 1;

					vl_liquido_w := obter_saldo_titulo_pagar(vet_itens_fatura.nr_titulo,dt_final_w);

					select	count(*)
					into STRICT	qt_itens_rateio_w
					from (	SELECT	p.nr_sequencia
							from   	titulo_pagar t,
								ptu_fatura f,
								pls_conta c,
								pls_conta_proc p,
								pls_protocolo_conta b,
								pls_congenere cg
							where  	f.nr_titulo = t.nr_titulo
							and    	f.nr_sequencia = c.nr_seq_fatura
							and    	p.nr_seq_conta = c.nr_sequencia
							and	c.nr_seq_protocolo = b.nr_sequencia
							and	b.nr_seq_congenere = cg.nr_sequencia
							and	t.nr_titulo = vet_itens_fatura.nr_titulo
							
union all

							SELECT	m.nr_sequencia
							from   titulo_pagar t,
							       ptu_fatura f,
							       pls_conta c,
							       pls_conta_mat m,
							       pls_protocolo_conta b,
							       pls_congenere cg
							where  f.nr_titulo = t.nr_titulo
							and    f.nr_sequencia = c.nr_seq_fatura
							and    m.nr_seq_conta = c.nr_sequencia
							and	c.nr_seq_protocolo = b.nr_sequencia
							and	b.nr_seq_congenere = cg.nr_sequencia
							and	t.nr_titulo = vet_itens_fatura.nr_titulo) alias1;
				end if;
			else
				vl_pagar_w 	:= vet_itens_fatura.vl_saldo;
			end if;

			qt_classif_diops_w 	:= dt_final_w - vet_titulo_fatura.dt_vencimento;

			if	((obter_dias_entre(vet_itens_fatura.dt_aviso, dt_final_w) + 1) > 30) then
				ds_classif_pel_w	:= obter_desc_expressao(778506);
			else
				ds_classif_pel_w	:= obter_desc_expressao(778508);
			end if;

			if (qt_classif_diops_w > 120) then
				ds_classif_diops_w 	:= obter_desc_expressao(492546);
			elsif (qt_classif_diops_w > 90) then
				ds_classif_diops_w	:= obter_desc_expressao(491705);
			elsif (qt_classif_diops_w > 60) then
				ds_classif_diops_w	:= obter_desc_expressao(490311);
			elsif (qt_classif_diops_w > 30) then
				ds_classif_diops_w	:= obter_desc_expressao(490310);
			elsif (qt_classif_diops_w > 0) then
				ds_classif_diops_w	:= obter_desc_expressao(490309);
			else
				ds_classif_diops_w	:= obter_desc_expressao(330037);
			end if;
		
			ds_observacao_item_w	:= null;
		
			if (vet_itens_fatura.ie_tipo_segurado in ('C','I','T')) then
				ds_observacao_item_w	:= ds_observacao_w;
			end if;
			
			insert into w_ctb_livro_aux_event_liq(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nm_prestador,
				nr_cpf_cnpj,
				ie_tipo_relacao,
				ds_tipo_relacao,
				nr_titulo,
				nr_evento,
				dt_vencimento,
				cd_conta_contabil,
				nr_documento,
				dt_conhecimento,
				nr_seq_segurado,
				cd_beneficiario,
				nm_usuario_evento,
				nm_usuario_princ,
				nr_cpf_cnpj_adic,
				dt_emissao,
				nr_contrato,
				ie_tipo_contratacao,
				ds_tipo_contratacao,
				ie_segmentacao,
				ds_segmentacao,
				dt_ocorrencia,
				vl_evento,
				dt_contabilizacao,
				ds_classif_pel,
				ds_classif_diops,
				vl_pagar,
				nr_seq_pagador,
				ie_tipo_segurado,
				ds_tipo_segurado,
				ie_tipo_livro,
				dt_referencia,
				nr_linha,
				nr_seq_reg_auxiliar,
				ie_tipo_documento,
				ds_tipo_documento,
				nr_protocolo_ans,
				ie_tipo_evento,
				ds_observacao,
				ie_preco,
				ie_tipo_compartilhamento,
				ie_tipo_repasse,
				dt_inicio_compartilhamento,
				dt_fim_compartilhamento)
			values (	nextval('w_ctb_livro_aux_event_liq_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				vet_itens_fatura.nm_prestador,
				vet_itens_fatura.nr_cpf_cnpj,
				vet_itens_fatura.ie_tipo_relacao,
				substr(obter_valor_dominio(1668,vet_itens_fatura.ie_tipo_relacao),1,255),
				vet_itens_fatura.nr_titulo,
				vet_itens_fatura.nr_seq_lote,
				vet_titulo_fatura.dt_vencimento,
				vet_itens_fatura.cd_conta_contabil,
				vet_itens_fatura.nr_documento,
				vet_itens_fatura.dt_aviso,
				vet_itens_fatura.nr_seq_segurado,
				vet_itens_fatura.cd_beneficiario,
				vet_itens_fatura.nm_segurado,
				vet_itens_fatura.nm_usuario_princ,
				vet_itens_fatura.nr_cpf_cnpj_adic,
				vet_itens_fatura.dt_emissao,
				vet_itens_fatura.nr_contrato,
				vet_itens_fatura.ie_tipo_contratacao,
				obter_valor_dominio(1666,vet_itens_fatura.ie_tipo_contratacao),
				vet_itens_fatura.ie_segmentacao,
				obter_valor_dominio(1665,vet_itens_fatura.ie_segmentacao),
				vet_itens_fatura.dt_ocorrencia,
				vl_pagar_w,
				vet_itens_fatura.dt_contabilizacao,
				ds_classif_pel_w,
				ds_classif_diops_w,
				vet_itens_fatura.vl_pagar,
				vet_itens_fatura.nr_seq_pagador,
				vet_itens_fatura.ie_tipo_segurado,
				substr(obter_valor_dominio(2406, vet_itens_fatura.ie_tipo_segurado),1,255),
				1,
				dt_final_w,
				nr_contador_w,
				nr_seq_regra_p,
				ie_tipo_documento_w,
				obter_valor_dominio(8372,ie_tipo_documento_w),
				vet_itens_fatura.nr_protocolo_ans,
				vet_itens_fatura.ie_tipo_grupo_ans,
				ds_observacao_item_w,
				vet_itens_fatura.ie_preco,
				ie_tipo_compartilhamento_w,
				ie_tipo_repasse_w,
				dt_repasse_w,
				dt_fim_repasse_w);
				
			if (mod(nr_contador_w, 1000) = 0) then
				commit;
			end if;
			end;
		end loop;
		close c_itens_fatura;
		
		end;
	end loop;
	close c_titulo_fatura;

	open c_itens_outros;
	loop
	fetch c_itens_outros into
		vet_itens_outros;
	EXIT WHEN NOT FOUND; /* apply on c_itens_outros */
		begin
		
		if (ie_data_tipo_segurado_w = 'A') then
			dt_ref_repasse_w	:= vet_itens_outros.dt_ocorrencia;
		else
			dt_ref_repasse_w	:= vet_itens_outros.dt_mes_competencia;
		end if;
		
		SELECT * FROM pls_obter_dados_repasse(	vet_itens_outros.dt_ocorrencia, vet_itens_outros.nr_seq_segurado, vet_itens_outros.nr_seq_congenere, ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w) INTO STRICT ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w;

		ie_tipo_documento_w	:= 'CM';
		
		nr_contador_w		:= nr_contador_w + 1;

		if (vet_itens_outros.ie_tipo_evento = 'R') then
			if (coalesce(vet_itens_outros.nr_seq_lote,0) <> 0) then
				vl_pagar_w	:= obter_saldo_titulo_pagar(vet_itens_outros.nr_titulo,dt_final_w);
			else		
				vl_pagar_w	:= vet_itens_outros.vl_saldo - coalesce(vet_itens_outros.vl_evento,0);
			end if;
		else
			vl_pagar_w 	:= vet_itens_outros.vl_saldo;
		end if;

		qt_classif_diops_w 	:= dt_final_w - vet_itens_outros.dt_vencimento;

		if	((obter_dias_entre(vet_itens_outros.dt_aviso, dt_final_w) + 1) > 30) then
			ds_classif_pel_w	:= obter_desc_expressao(778506);
		else
			ds_classif_pel_w	:= obter_desc_expressao(778508);
		end if;

		if (qt_classif_diops_w > 120) then
			ds_classif_diops_w 	:= obter_desc_expressao(492546);
		elsif (qt_classif_diops_w > 90) then
			ds_classif_diops_w	:= obter_desc_expressao(491705);
		elsif (qt_classif_diops_w > 60) then
			ds_classif_diops_w	:= obter_desc_expressao(490311);
		elsif (qt_classif_diops_w > 30) then
			ds_classif_diops_w	:= obter_desc_expressao(490310);
		elsif (qt_classif_diops_w > 0) then
			ds_classif_diops_w	:= obter_desc_expressao(490309);
		else
			ds_classif_diops_w	:= obter_desc_expressao(330037);
		end if;
	
		ds_observacao_item_w	:= null;
	
		if (vet_itens_outros.ie_tipo_segurado in ('C','I','T')) then
			ds_observacao_item_w	:= ds_observacao_w;
		end if;
		
		insert into w_ctb_livro_aux_event_liq(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nm_prestador,
			nr_cpf_cnpj,
			ie_tipo_relacao,
			ds_tipo_relacao,
			nr_titulo,
			nr_evento,
			dt_vencimento,
			cd_conta_contabil,
			nr_documento,
			dt_conhecimento,
			nr_seq_segurado,
			cd_beneficiario,
			nm_usuario_evento,
			nm_usuario_princ,
			nr_cpf_cnpj_adic,
			dt_emissao,
			nr_contrato,
			ie_tipo_contratacao,
			ds_tipo_contratacao,
			ie_segmentacao,
			ds_segmentacao,
			dt_ocorrencia,
			vl_evento,
			dt_contabilizacao,
			ds_classif_pel,
			ds_classif_diops,
			vl_pagar,
			nr_seq_pagador,
			ie_tipo_segurado,
			ds_tipo_segurado,
			ie_tipo_livro,
			dt_referencia,
			nr_linha,
			nr_seq_reg_auxiliar,
			ie_tipo_documento,
			ds_tipo_documento,
			nr_protocolo_ans,
			ie_tipo_evento,
			ds_observacao,
			ie_preco,
			ie_tipo_compartilhamento,
			ie_tipo_repasse,
			dt_inicio_compartilhamento,
			dt_fim_compartilhamento)
		values (	nextval('w_ctb_livro_aux_event_liq_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			vet_itens_outros.nm_prestador,
			vet_itens_outros.nr_cpf_cnpj,
			vet_itens_venc.ie_tipo_relacao,
			substr(obter_valor_dominio(1668,vet_itens_outros.ie_tipo_relacao),1,255),
			vet_itens_outros.nr_titulo,
			vet_itens_outros.nr_seq_lote,
			vet_itens_outros.dt_vencimento,
			vet_itens_outros.cd_conta_contabil,
			vet_itens_outros.nr_documento,
			vet_itens_outros.dt_aviso,
			vet_itens_outros.nr_seq_segurado,
			vet_itens_outros.cd_beneficiario,
			vet_itens_outros.nm_segurado,
			vet_itens_outros.nm_usuario_princ,
			vet_itens_outros.nr_cpf_cnpj_adic,
			vet_itens_outros.dt_emissao,
			vet_itens_outros.nr_contrato,
			vet_itens_outros.ie_tipo_contratacao,
			obter_valor_dominio(1666,vet_itens_outros.ie_tipo_contratacao),
			vet_itens_outros.ie_segmentacao,
			obter_valor_dominio(1665,vet_itens_outros.ie_segmentacao),
			vet_itens_outros.dt_ocorrencia,
			vl_pagar_w,
			vet_itens_outros.dt_contabilizacao,
			ds_classif_pel_w,
			ds_classif_diops_w,
			vet_itens_outros.vl_pagar,
			vet_itens_outros.nr_seq_pagador,
			vet_itens_outros.ie_tipo_segurado,
			substr(obter_valor_dominio(2406, vet_itens_outros.ie_tipo_segurado),1,255),
			1,
			dt_final_w,
			nr_contador_w,
			nr_seq_regra_p,
			ie_tipo_documento_w,
			obter_valor_dominio(8372,ie_tipo_documento_w),
			vet_itens_outros.nr_protocolo_ans,
			vet_itens_outros.ie_tipo_grupo_ans,
			ds_observacao_item_w,
			vet_itens_outros.ie_preco,
			ie_tipo_compartilhamento_w,
			ie_tipo_repasse_w,
			dt_repasse_w,
			dt_fim_repasse_w);
			
		if (mod(nr_contador_w, 1000) = 0) then
			commit;
		end if;
		end;
	end loop;
	close c_itens_outros;
	
	open c_itens_discussao;
	loop
	fetch c_itens_discussao into
		vet_itens_discussao;
	EXIT WHEN NOT FOUND; /* apply on c_itens_discussao */
		begin
		
		if (ie_data_tipo_segurado_w = 'A') then
			dt_ref_repasse_w	:= vet_itens_discussao.dt_ocorrencia;
		else
			dt_ref_repasse_w	:= vet_itens_discussao.dt_mes_competencia;
		end if;
		
		SELECT * FROM pls_obter_dados_repasse(	vet_itens_discussao.dt_ocorrencia, vet_itens_discussao.nr_seq_segurado, vet_itens_discussao.nr_seq_congenere, ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w) INTO STRICT ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w;

		nr_contador_w		:= nr_contador_w + 1;

		qt_classif_diops_w 	:= dt_final_w - vet_itens_discussao.dt_vencimento;

		if	((obter_dias_entre(vet_itens_discussao.dt_aviso, dt_final_w) + 1) > 30) then
			ds_classif_pel_w	:= obter_desc_expressao(778506);
		else
			ds_classif_pel_w	:= obter_desc_expressao(778508);
		end if;

		if (qt_classif_diops_w > 120) then
			ds_classif_diops_w 	:= obter_desc_expressao(492546);
		elsif (qt_classif_diops_w > 90) then
			ds_classif_diops_w	:= obter_desc_expressao(491705);
		elsif (qt_classif_diops_w > 60) then
			ds_classif_diops_w	:= obter_desc_expressao(490311);
		elsif (qt_classif_diops_w > 30) then
			ds_classif_diops_w	:= obter_desc_expressao(490310);
		elsif (qt_classif_diops_w > 0) then
			ds_classif_diops_w	:= obter_desc_expressao(490309);
		else
			ds_classif_diops_w	:= obter_desc_expressao(330037);
		end if;
		
		ds_observacao_item_w	:= null;
	
		if (vet_itens_discussao.ie_tipo_segurado in ('C','I','T')) then
			ds_observacao_item_w	:= ds_observacao_w;
		end if;
		
		insert into w_ctb_livro_aux_event_liq(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nm_prestador,
			nr_cpf_cnpj,
			ie_tipo_relacao,
			ds_tipo_relacao,
			nr_titulo,
			nr_evento,
			dt_vencimento,
			cd_conta_contabil,
			nr_documento,
			dt_conhecimento,
			nr_seq_segurado,
			cd_beneficiario,
			nm_usuario_evento,
			nm_usuario_princ,
			nr_cpf_cnpj_adic,
			dt_emissao,
			nr_contrato,
			ie_tipo_contratacao,
			ds_tipo_contratacao,
			ie_segmentacao,
			ds_segmentacao,
			dt_ocorrencia,
			vl_evento,
			dt_contabilizacao,
			ds_classif_pel,
			ds_classif_diops,
			vl_pagar,
			nr_seq_pagador,
			ie_tipo_segurado,
			ds_tipo_segurado,
			ie_tipo_livro,
			dt_referencia,
			nr_linha,
			nr_seq_reg_auxiliar,
			ie_tipo_documento,
			ds_tipo_documento,
			nr_protocolo_ans,
			ds_observacao,
			ie_preco,
			ie_tipo_compartilhamento,
			ie_tipo_repasse,
			dt_inicio_compartilhamento,
			dt_fim_compartilhamento)
		values (	nextval('w_ctb_livro_aux_event_liq_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			vet_itens_discussao.nm_prestador,
			vet_itens_discussao.nr_cpf_cnpj,
			vet_itens_discussao.ie_tipo_relacao,
			substr(obter_valor_dominio(1668,vet_itens_discussao.ie_tipo_relacao),1,255),
			vet_itens_discussao.nr_titulo,
			vet_itens_discussao.nr_seq_lote,
			vet_itens_discussao.dt_vencimento,
			vet_itens_discussao.cd_conta_contabil,
			vet_itens_discussao.nr_documento,
			vet_itens_discussao.dt_aviso,
			vet_itens_discussao.nr_seq_segurado,
			vet_itens_discussao.cd_beneficiario,
			vet_itens_discussao.nm_segurado,
			vet_itens_discussao.nm_usuario_princ,
			vet_itens_discussao.nr_cpf_cnpj_adic,
			vet_itens_discussao.dt_emissao,
			vet_itens_discussao.nr_contrato,
			vet_itens_discussao.ie_tipo_contratacao,
			obter_valor_dominio(1666,vet_itens_discussao.ie_tipo_contratacao),
			vet_itens_discussao.ie_segmentacao,
			obter_valor_dominio(1665,vet_itens_discussao.ie_segmentacao),
			vet_itens_discussao.dt_ocorrencia,
			vet_itens_discussao.vl_evento,
			vet_itens_discussao.dt_contabilizacao,
			ds_classif_pel_w,
			ds_classif_diops_w,
			vet_itens_discussao.vl_item_evento,
			vet_itens_discussao.nr_seq_pagador,
			vet_itens_discussao.ie_tipo_segurado,
			substr(obter_valor_dominio(2406, vet_itens_discussao.ie_tipo_segurado),1,255),
			1,
			dt_final_w,
			nr_contador_w,
			nr_seq_regra_p,
			vet_itens_discussao.ie_tipo_documento,
			obter_valor_dominio(8372,vet_itens_discussao.ie_tipo_documento),
			vet_itens_discussao.nr_protocolo_ans,
			ds_observacao_item_w,
			vet_itens_discussao.ie_preco,
			ie_tipo_compartilhamento_w,
			ie_tipo_repasse_w,
			dt_repasse_w,
			dt_fim_repasse_w);
			
		if (mod(nr_contador_w, 1000) = 0) then
			commit;
		end if;
		end;
	end loop;
	close c_itens_discussao;

	open c_titulo_ress_sus;
	loop
	fetch c_titulo_ress_sus into	
		vet_titulo_ress_sus;
	EXIT WHEN NOT FOUND; /* apply on c_titulo_ress_sus */
	begin
	open c_itens_ress_sus;
	loop
	fetch c_itens_ress_sus into	
		vet_itens_ress_sus;
	EXIT WHEN NOT FOUND; /* apply on c_itens_ress_sus */
		begin
				
		nr_contador_w		:= nr_contador_w + 1;
		
		qt_classif_diops_w 	:= dt_final_w - vet_titulo_ress_sus.dt_vencimento;

		if	((obter_dias_entre(vet_itens_ress_sus.dt_aviso, dt_final_w) + 1) > 30) then
			ds_classif_pel_w	:= obter_desc_expressao(778506);
		else
			ds_classif_pel_w	:= obter_desc_expressao(778508);
		end if;

		if (qt_classif_diops_w > 120) then
			ds_classif_diops_w 	:= obter_desc_expressao(492546);
		elsif (qt_classif_diops_w > 90) then
			ds_classif_diops_w	:= obter_desc_expressao(491705);
		elsif (qt_classif_diops_w > 60) then
			ds_classif_diops_w	:= obter_desc_expressao(490311);
		elsif (qt_classif_diops_w > 30) then
			ds_classif_diops_w	:= obter_desc_expressao(490310);
		elsif (qt_classif_diops_w > 0) then
			ds_classif_diops_w	:= obter_desc_expressao(490309);
		else
			ds_classif_diops_w	:= obter_desc_expressao(330037);
		end if;
		
		ds_observacao_item_w := null;
		
		if (vet_itens_ress_sus.ie_tipo_segurado in ('C','I','T')) then
			ds_observacao_item_w	:= ds_observacao_w;
		end if;

		vl_pagar_w := dividir(vet_titulo_ress_sus.vl_saldo * vet_itens_ress_sus.vl_pagar, vet_titulo_ress_sus.vl_titulo);

		insert into w_ctb_livro_aux_event_liq(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nm_prestador,
			nr_cpf_cnpj,
			ie_tipo_relacao,
			ds_tipo_relacao,
			nr_titulo,
			nr_evento,
			dt_vencimento,
			cd_conta_contabil,
			nr_documento,
			dt_conhecimento,
			nr_seq_segurado,
			cd_beneficiario,
			nm_usuario_evento,
			nm_usuario_princ,
			nr_cpf_cnpj_adic,
			dt_emissao,
			nr_contrato,
			ie_tipo_contratacao,
			ds_tipo_contratacao,
			ie_segmentacao,
			ds_segmentacao,
			dt_ocorrencia,
			vl_evento,
			dt_contabilizacao,
			ds_classif_pel,
			ds_classif_diops,
			vl_pagar,
			nr_seq_pagador,
			ie_tipo_segurado,
			ds_tipo_segurado,
			ie_tipo_livro,
			dt_referencia,
			nr_linha,
			nr_seq_reg_auxiliar,
			ie_tipo_documento,
			ds_tipo_documento,
			nr_protocolo_ans,
			ds_observacao,
			ie_preco,
			ie_tipo_compartilhamento,
			ie_tipo_repasse,
			dt_inicio_compartilhamento,
			dt_fim_compartilhamento)
		values (	nextval('w_ctb_livro_aux_event_liq_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			vet_itens_ress_sus.nm_prestador,
			vet_itens_ress_sus.nr_cpf_cnpj,
			vet_itens_ress_sus.ie_tipo_relacao,
			substr(obter_valor_dominio(1668,vet_itens_ress_sus.ie_tipo_relacao),1,255),
			vet_titulo_ress_sus.nr_titulo,
			null,
			vet_titulo_ress_sus.dt_vencimento,
			vet_itens_ress_sus.cd_conta_contabil,
			vet_itens_ress_sus.nr_documento,
			vet_itens_ress_sus.dt_aviso,
			vet_itens_ress_sus.nr_seq_segurado,
			vet_itens_ress_sus.cd_beneficiario,
			vet_itens_ress_sus.nm_segurado,
			vet_itens_ress_sus.nm_usuario_princ,
			vet_itens_ress_sus.nr_cpf_cnpj_adic,
			vet_titulo_ress_sus.dt_emissao,
			vet_itens_ress_sus.nr_contrato,
			vet_itens_ress_sus.ie_tipo_contratacao,
			obter_valor_dominio(1666,vet_itens_ress_sus.ie_tipo_contratacao),
			vet_itens_ress_sus.ie_segmentacao,
			obter_valor_dominio(1665,vet_itens_ress_sus.ie_segmentacao),
			vet_itens_ress_sus.dt_ocorrencia,
			vet_itens_ress_sus.vl_pagar,
			vet_itens_ress_sus.dt_contabilizacao,
			ds_classif_pel_w,
			ds_classif_diops_w,
			vl_pagar_w,
			vet_itens_ress_sus.nr_seq_pagador,
			vet_itens_ress_sus.ie_tipo_segurado,
			substr(obter_valor_dominio(2406, vet_itens_ress_sus.ie_tipo_segurado),1,255),
			1,
			dt_final_w,
			nr_contador_w,
			nr_seq_regra_p,
			'PC',
			obter_valor_dominio(8372, 'PC'),
			vet_itens_ress_sus.nr_protocolo_ans,
			ds_observacao_item_w,
			vet_itens_ress_sus.ie_preco,
			null,
			null,
			null,
			null);
				
		if (mod(nr_contador_w, 1000) = 0) then
			commit;
		end if;
		
		end;
	end loop;
	close c_itens_ress_sus;
	
	end;
end loop;
close c_titulo_ress_sus;
	
	update	ctb_livro_auxiliar
	set	qt_registros	= nr_contador_w
	where	nr_sequencia	= nr_seq_regra_p;

elsif (ie_gerar_arquivo_p = 'S') then
	begin
	nm_arquivo_w	:= 'RegAuxEventosLiquidar' || to_char(clock_timestamp(),'ddmmyyyyhh24miss') || nm_usuario_p || '.csv';
	ds_nome_livro_w	:= 'Registro Auxiliar de Eventos a Liquidar';
	ds_periodo_w	:= wheb_mensagem_pck.get_texto(1108452,'DT_FINAL=' || dt_final_w || ';' || 'DT_LIBERACAO=' || dt_liberacao_p);

	SELECT * FROM obter_evento_utl_file(1, null, ds_local_w, ds_erro_w) INTO STRICT ds_local_w, ds_erro_w;

	arq_texto_w := utl_file.fopen(ds_local_w,nm_arquivo_w,'W', 32000);

	utl_file.put_line(arq_texto_w, ds_nome_livro_w);
	utl_file.put_line(arq_texto_w, ds_periodo_w);
	utl_file.put_line(arq_texto_w, expressao_pck.obter_desc_expressao(1082350));
	utl_file.fflush(arq_texto_w);
	for vetl in c_linha loop
		begin
		utl_file.put_line(arq_texto_w,vetl.ds_linha);
		utl_file.fflush(arq_texto_w);
		end;
	end loop;
	end;
end if;

commit;

CALL wheb_usuario_pck.set_ie_executar_trigger('S');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_livro_aux_ev_liq_co ( nm_usuario_p usuario.nm_usuario%type, cd_empresa_p empresa.cd_empresa%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, dt_inicial_p ctb_livro_auxiliar.dt_inicial%type, dt_final_p ctb_livro_auxiliar.dt_final%type, dt_liberacao_p ctb_livro_auxiliar.dt_liberacao%type, ie_gerar_arquivo_p ctb_livro_auxiliar.ie_tipo_livro_ecd%type, nr_seq_regra_p ctb_livro_auxiliar.nr_sequencia%type) FROM PUBLIC;

