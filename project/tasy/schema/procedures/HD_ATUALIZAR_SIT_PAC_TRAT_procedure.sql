-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hd_atualizar_sit_pac_trat (nr_seq_atual_p bigint, cd_pessoa_fisica_p bigint) AS $body$
DECLARE

	
ie_contagem_pacientes_w 	integer;
ie_cont_pac_trat_ativo_w 	integer;
ie_situacao_w 			varchar(1);


BEGIN

select	count(*)
into STRICT 	ie_contagem_pacientes_w
from 	paciente_tratamento
where 	cd_pessoa_fisica = cd_pessoa_fisica_p
and  	nr_sequencia 	<> nr_seq_atual_p;

ie_situacao_w := 'N';

if (ie_contagem_pacientes_w > 0) then

	select 	count(*)
	into STRICT	ie_cont_pac_trat_ativo_w
	from 	paciente_tratamento
	where 	cd_pessoa_fisica = cd_pessoa_fisica_p
	and 	ie_tratamento in ('HD','CH','CHD','CHDF','CHDI','PAF','SCUF','SLED','DPA','CPI','CO','CAPD','PL','DPAV','DDC','IHF','IHDF')
	and 	(dt_inicio_tratamento IS NOT NULL AND dt_inicio_tratamento::text <> '')
	and 	coalesce(dt_final_tratamento::text, '') = ''
	and 	nr_sequencia <> nr_seq_atual_p;
	
	if (ie_cont_pac_trat_ativo_w > 0) then
		ie_situacao_w := 'S';
	end if;
end if;
	
update	hd_pac_renal_cronico
set 	ie_situacao 		= ie_situacao_w 
where 	cd_pessoa_fisica 	= cd_pessoa_fisica_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hd_atualizar_sit_pac_trat (nr_seq_atual_p bigint, cd_pessoa_fisica_p bigint) FROM PUBLIC;

