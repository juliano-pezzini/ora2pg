-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_liberacao_enfermagem ( nr_prescricao_p bigint, ds_retorno_p INOUT text ) AS $body$
DECLARE


    ds_horarios_w           varchar(2000);
    ds_hora_w               varchar(255);
    ds_horarios_retorno_w   varchar(255) := '';
    dt_inicio_prescr_w      timestamp;
    dt_validade_prescr_w    timestamp;
    dt_prescricao_w         timestamp;
    dt_horario_w            timestamp;
    dt_inicio_medic_w       timestamp := NULL;
    qt_dia_adic_w           bigint;
    k                       bigint;
    nr_sequencia_w          bigint;
    ds_tipo_w               varchar(15);
    ds_itens_w              varchar(255);
    ie_consiste_agora_w     varchar(1);
    ie_prescr_emergencia_w  varchar(1);
    ds_material_w           varchar(80);
    ds_mensagem_w           varchar(255);
    sql_w                   varchar(5000);
    ie_exit_w               varchar(1);
    ds_erro_w               varchar(4000);
    ds_parametros_w         varchar(4000);
    c01 CURSOR FOR
    SELECT
        nr_sequencia,
        'M'                                                      ds_tipo,
        substr(obter_desc_material(cd_material), 1, 80)          ds_material
    FROM
        prescr_material
    WHERE
            nr_prescricao = nr_prescricao_p
        AND coalesce(dt_suspensao::text, '') = ''
        AND ie_agrupador = 1
        AND coalesce(nr_seq_kit::text, '') = ''
        AND coalesce(ie_administrar, 'S') = 'S'
        AND ( position('1' in ds_itens_w) > 0 )
        AND ( ( coalesce(ie_consiste_agora_w, 'S') = 'S' )
              OR ( ( coalesce(ie_consiste_agora_w, 'S') = 'N' )
                   AND ( coalesce(ie_urgencia, 'N') <> 'S' ) ) )

UNION ALL

    SELECT
        nr_seq_solucao,
        'S'  ds_tipo,
        ''   ds_material
    FROM
        prescr_solucao
    WHERE
            nr_prescricao = nr_prescricao_p
        AND ( position('2' in ds_itens_w) > 0 )
        AND ( ( coalesce(ie_consiste_agora_w, 'S') = 'S' )
              OR ( ( coalesce(ie_consiste_agora_w, 'S') = 'N' )
                   AND ( coalesce(ie_urgencia, 'N') <> 'S' ) ) )
        AND coalesce(dt_suspensao::text, '') = ''
    
UNION ALL

    SELECT
        nr_sequencia,
        'P'  ds_tipo,
        ''   ds_material
    FROM
        prescr_procedimento
    WHERE
            nr_prescricao = nr_prescricao_p
        AND ( position('3' in ds_itens_w) > 0 )
        AND ( ( coalesce(ie_consiste_agora_w, 'S') = 'S' )
              OR ( ( coalesce(ie_consiste_agora_w, 'S') = 'N' )
                   AND ( coalesce(ie_urgencia, 'N') <> 'S' ) ) )
        AND coalesce(dt_suspensao::text, '') = ''
    
UNION ALL

    SELECT
        nr_sequencia,
        'SNE'                                                    ds_tipo,
        substr(obter_desc_material(cd_material), 1, 80)          ds_material
    FROM
        prescr_material
    WHERE
            nr_prescricao = nr_prescricao_p
        AND coalesce(dt_suspensao::text, '') = ''
        AND ie_agrupador = 8
        AND coalesce(nr_seq_kit::text, '') = ''
        AND coalesce(ie_administrar, 'S') = 'S'
        AND ( position('4' in ds_itens_w) > 0 )
        AND ( ( coalesce(ie_consiste_agora_w, 'S') = 'S' )
              OR ( ( coalesce(ie_consiste_agora_w, 'S') = 'N' )
                   AND ( coalesce(ie_urgencia, 'N') <> 'S' ) ) )
    
UNION ALL

    SELECT
        nr_sequencia,
        'A'                                                      ds_tipo,
        substr(obter_desc_material(cd_material), 1, 80)          ds_material
    FROM
        prescr_material
    WHERE
            nr_prescricao = nr_prescricao_p
        AND coalesce(dt_suspensao::text, '') = ''
        AND ie_agrupador = 5
        AND coalesce(nr_seq_kit::text, '') = ''
        AND coalesce(ie_administrar, 'S') = 'S'
        AND ( position('5' in ds_itens_w) > 0 )
        AND ( ( coalesce(ie_consiste_agora_w, 'S') = 'S' )
              OR ( ( coalesce(ie_consiste_agora_w, 'S') = 'N' )
                   AND ( coalesce(ie_urgencia, 'N') <> 'S' ) ) );


BEGIN
    SELECT
        MAX(ie_prescr_emergencia)
    INTO STRICT ie_prescr_emergencia_w
    FROM
        prescr_medica
    WHERE
        nr_prescricao = nr_prescricao_p;

    IF ( coalesce(ie_prescr_emergencia_w, 'N') <> 'S' ) THEN
        IF ( obter_funcao_ativa = 252 ) THEN
            ds_itens_w := obter_param_usuario(252, 37, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ds_itens_w);

            ie_consiste_agora_w := 'S';
        ELSE
            ds_itens_w := obter_param_usuario(7015, 70, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ds_itens_w);

            ie_consiste_agora_w := obter_param_usuario(7015, 72, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_consiste_agora_w);

        END IF;

        OPEN c01;
        LOOP
            FETCH c01 INTO
                nr_sequencia_w,
                ds_tipo_w,
                ds_material_w;
            EXIT WHEN NOT FOUND; /* apply on c01 */
            BEGIN
                IF ( ds_tipo_w = 'M' ) THEN
                    SELECT
                        padroniza_horario_prescr(b.ds_horarios, CASE WHEN coalesce(b.qt_dia_prim_hor, 0)=0 THEN  CASE WHEN substr(obter_se_horario_hoje(                        a.dt_prescricao, a.dt_primeiro_horario, b.hr_prim_horario), 1, 1)='N' THEN                                                                                                             '01/01/2000 23:59:59'  ELSE to_char(coalesce(a.dt_primeiro_horario,                                                                                                                        a.dt_prescricao),                                                                                                                    'dd/mm/yyyy hh24:mi:ss') END   ELSE '01/01/2000 23:59:59' END ),
                        a.dt_inicio_prescr,
                        a.dt_validade_prescr,
                        trunc(a.dt_inicio_prescr, 'mi'),
                        b.dt_inicio_medic
                    INTO STRICT
                        ds_horarios_w,
                        dt_inicio_prescr_w,
                        dt_validade_prescr_w,
                        dt_prescricao_w,
                        dt_inicio_medic_w
                    FROM
                        prescr_material  b,
                        prescr_medica    a
                    WHERE
                            a.nr_prescricao = nr_prescricao_p
                        AND a.nr_prescricao = b.nr_prescricao
                        AND coalesce(b.ie_administrar, 'S') = 'S'
                        AND b.nr_sequencia = nr_sequencia_w;

                ELSIF ( ds_tipo_w = 'S' ) THEN
                    SELECT
                        padroniza_horario_prescr(b.ds_horarios, to_char(coalesce(a.dt_primeiro_horario, a.dt_prescricao), 'dd/mm/yyyy hh24:mi:ss')),
                        a.dt_inicio_prescr,
                        a.dt_validade_prescr,
                        trunc(a.dt_inicio_prescr, 'mi'),
                        NULL
                    INTO STRICT
                        ds_horarios_w,
                        dt_inicio_prescr_w,
                        dt_validade_prescr_w,
                        dt_prescricao_w,
                        dt_inicio_medic_w
                    FROM
                        prescr_solucao  b,
                        prescr_medica   a
                    WHERE
                            a.nr_prescricao = nr_prescricao_p
                        AND a.nr_prescricao = b.nr_prescricao
                        AND b.nr_seq_solucao = nr_sequencia_w;

                ELSIF ( ds_tipo_w = 'P' ) THEN
                    SELECT
                        padroniza_horario_prescr(b.ds_horarios, to_char(coalesce(a.dt_primeiro_horario, a.dt_prescricao), 'dd/mm/yyyy hh24:mi:ss')),
                        a.dt_inicio_prescr,
                        a.dt_validade_prescr,
                        trunc(a.dt_inicio_prescr, 'mi'),
                        NULL
                    INTO STRICT
                        ds_horarios_w,
                        dt_inicio_prescr_w,
                        dt_validade_prescr_w,
                        dt_prescricao_w,
                        dt_inicio_medic_w
                    FROM
                        prescr_procedimento  b,
                        prescr_medica        a
                    WHERE
                            a.nr_prescricao = nr_prescricao_p
                        AND a.nr_prescricao = b.nr_prescricao
                        AND b.nr_sequencia = nr_sequencia_w;

                ELSIF ( ds_tipo_w = 'SNE' ) THEN
                    SELECT
                        padroniza_horario_prescr(b.ds_horarios, CASE WHEN coalesce(b.qt_dia_prim_hor, 0)=0 THEN  CASE WHEN substr(obter_se_horario_hoje(                        a.dt_prescricao, a.dt_primeiro_horario, b.hr_prim_horario), 1, 1)='N' THEN                                                                                                             '01/01/2000 23:59:59'  ELSE to_char(coalesce(a.dt_primeiro_horario,                                                                                                                        a.dt_prescricao),                                                                                                                    'dd/mm/yyyy hh24:mi:ss') END   ELSE '01/01/2000 23:59:59' END ),
                        a.dt_inicio_prescr,
                        a.dt_validade_prescr,
                        trunc(a.dt_inicio_prescr, 'mi'),
                        b.dt_inicio_medic
                    INTO STRICT
                        ds_horarios_w,
                        dt_inicio_prescr_w,
                        dt_validade_prescr_w,
                        dt_prescricao_w,
                        dt_inicio_medic_w
                    FROM
                        prescr_material  b,
                        prescr_medica    a
                    WHERE
                            a.nr_prescricao = nr_prescricao_p
                        AND a.nr_prescricao = b.nr_prescricao
                        AND coalesce(b.ie_administrar, 'S') = 'S'
                        AND b.nr_sequencia = nr_sequencia_w;

                ELSIF ( ds_tipo_w = 'A' ) THEN
                    SELECT
                        padroniza_horario_prescr(b.ds_horarios, CASE WHEN coalesce(b.qt_dia_prim_hor, 0)=0 THEN  CASE WHEN substr(obter_se_horario_hoje(                        a.dt_prescricao, a.dt_primeiro_horario, b.hr_prim_horario), 1, 1)='N' THEN                                                                                                             '01/01/2000 23:59:59'  ELSE to_char(coalesce(a.dt_primeiro_horario,                                                                                                                        a.dt_prescricao),                                                                                                                    'dd/mm/yyyy hh24:mi:ss') END   ELSE '01/01/2000 23:59:59' END ),
                        a.dt_inicio_prescr,
                        a.dt_validade_prescr,
                        trunc(a.dt_inicio_prescr, 'mi'),
                        b.dt_inicio_medic
                    INTO STRICT
                        ds_horarios_w,
                        dt_inicio_prescr_w,
                        dt_validade_prescr_w,
                        dt_prescricao_w,
                        dt_inicio_medic_w
                    FROM
                        prescr_material  b,
                        prescr_medica    a
                    WHERE
                            a.nr_prescricao = nr_prescricao_p
                        AND a.nr_prescricao = b.nr_prescricao
                        AND b.nr_sequencia = nr_sequencia_w;

                END IF;

                qt_dia_adic_w := 0;
                BEGIN
                    sql_w := 'BEGIN obter_ds_horario_enfermagem_md(:1, :2, :3, :4, :5, :6, :7, :8, :9); END;';
                    EXECUTE sql_w
                        USING IN OUT ds_horarios_w, IN OUT ds_hora_w, IN OUT qt_dia_adic_w, IN dt_inicio_medic_w, IN OUT dt_horario_w,
                        IN dt_prescricao_w, IN ds_tipo_w, OUT ds_retorno_p, OUT ie_exit_w;

                EXCEPTION
                    WHEN OTHERS THEN
                        ds_erro_w := sqlerrm;
                        ds_parametros_w := ( 'nr_prescricao_p: '
                                             || nr_prescricao_p
                                             || '-'
                                             || 'dt_inicio_prescr_w: '
                                             || dt_inicio_prescr_w
                                             || '-'
                                             || 'dt_validade_prescr_w: '
                                             || dt_validade_prescr_w
                                             || '-'
                                             || 'nr_sequencia_w: '
                                             || nr_sequencia_w
                                             || '-'
                                             || 'ie_consiste_agora_w: '
                                             || ie_consiste_agora_w
                                             || '-'
                                             || 'IE_PRESCR_EMERGENCIA_w: '
                                             || ie_prescr_emergencia_w
                                             || '-'
                                             || 'ds_material_w: '
                                             || ds_material_w
                                             || '-'
                                             || 'ds_horarios_w: '
                                             || ds_horarios_w
                                             || '-'
                                             || 'ds_hora_w: '
                                             || ds_hora_w
                                             || '-'
                                             || 'qt_dia_adic_w: '
                                             || qt_dia_adic_w
                                             || '-'
                                             || 'dt_inicio_medic_w: '
                                             || dt_inicio_medic_w
                                             || '-'
                                             || 'dt_horario_w: '
                                             || dt_horario_w
                                             || '-'
                                             || 'dt_prescricao_w: '
                                             || dt_prescricao_w
                                             || '-'
                                             || 'ds_tipo_w: '
                                             || ds_tipo_w
                                             || '-'
                                             || 'ds_retorno_p: '
                                             || ds_retorno_p
                                             || '-'
                                             || 'ie_exit_w: '
                                             || ie_exit_w );

                        CALL gravar_log_medical_device('consistir_liberacao_enfermagem',
                                                 'obter_ds_horario_enfermagem_md',
                                                 ds_parametros_w,
                                                 ds_erro_w,
                                                 wheb_usuario_pck.get_nm_usuario,
                                                 'S');
                        ds_horarios_w := NULL;
                        ds_hora_w := NULL;
                        qt_dia_adic_w := NULL;
                        dt_horario_w := NULL;
                        ds_retorno_p := NULL;
                        ie_exit_w := 'N';
                END;

                sql_w := NULL;
                IF (
                    (ie_exit_w IS NOT NULL AND ie_exit_w::text <> '')
                    AND ie_exit_w = 'S'
                ) THEN
                    EXIT;
                END IF;
            END;

        END LOOP;

        CLOSE c01;
    END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_liberacao_enfermagem ( nr_prescricao_p bigint, ds_retorno_p INOUT text ) FROM PUBLIC;

