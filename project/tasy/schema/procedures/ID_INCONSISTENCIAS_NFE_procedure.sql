-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE id_inconsistencias_nfe (nm_usuario_p text, dt_inicial_p timestamp, dt_final_p timestamp, ie_tipo_nota_p text, nr_seq_nota_p bigint default 0) AS $body$
DECLARE


cd_pessoa_fisica_w      	varchar(10);
cd_cgc_w                	varchar(14);
nr_sequencia_w         	 bigint;
nr_cep_tomador_w        	varchar(15);
nr_ddd_tomador_w        	varchar(40);
nr_telefone_w           	varchar(8);
cd_mun_w                	varchar(8);
cd_item_lista_serv_w	varchar(20);
cd_tributacao_mun_w	varchar(20);
ds_endereco_tomador_w	varchar(255);
ds_email_tomador_w	varchar(255);
contador_w              	bigint := 0;
qt_registro_regra_w		bigint := 0;
cd_operacao_nf_w		smallint;
nr_cpf_w			varchar(11);
nr_cpf_resp_w		varchar(11);
ie_tipo_nota_w		varchar(1);
ds_existe_transp_w		varchar(1) := 'S';
sg_estado_w			pessoa_juridica.sg_estado%type;
ds_endereco_adic_w		varchar(255);
nr_endereco_adic_w		bigint;
ds_complemento_adic_w 	varchar(255);
ds_bairro_adic_w		varchar(60);
sg_uf_adic_w			pessoa_juridica.sg_estado%type;
cd_cep_adic_w			varchar(10);
cd_municipio_ibge_adic_w	bigint;
nr_telefone_adic_w		varchar(12);
nr_ddd_telefone_adic_w		integer;
ie_tomador_estrangeiro_w	varchar(1);
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
cd_empresa_w			empresa.cd_empresa%type;
dt_emissao_w			nota_fiscal.dt_emissao%type;

C01 CURSOR FOR
SELECT  cd_pessoa_fisica,
        cd_cgc,
        nr_sequencia,
        substr(obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc, 'CEP'),1,15) nr_cep_tomador,
        obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'DDT') nr_ddd_tomador,
        substr(Elimina_Caracteres_Especiais(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'T')), 1, 8) nr_telefone,
        obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc, 'CDM') cd_mun,
	obter_dados_grupo_servico_item(obter_item_servico_proced(obter_procedimento_nfse(a.nr_sequencia,'P'), obter_procedimento_nfse(a.nr_sequencia,'O'),a.cd_estabelecimento), 'GR') cd_item_lista_serv,
	obter_dados_grupo_servico_item(obter_item_servico_proced(obter_procedimento_nfse(a.nr_sequencia,'P'), obter_procedimento_nfse(a.nr_sequencia,'O'),a.cd_estabelecimento), 'CD') cd_tributacao_mun,
	substr(obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc, 'EN'), 1, 255) ds_endereco,
	obter_dados_pf(cd_pessoa_fisica, 'CPF') nr_cpf,
	obter_compl_pf(cd_pessoa_fisica,3,'C') nr_cpf_resp,
	a.cd_operacao_nf,
	nfe_obter_dados_transportadora(nr_sequencia,'EX') ds_existe_transp,
	obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'UF') sg_estado,
	cd_estabelecimento,
	obter_empresa_estab(cd_estabelecimento) cd_empresa,
	coalesce(substr(obter_se_pf_pj_estrangeiro(cd_pessoa_fisica,cd_cgc),1,1),'N')
from    nota_fiscal a
where   dt_emissao between dt_inicial_p and fim_dia(dt_final_p)
and     exists (SELECT 1 from w_nota_fiscal b where b.nr_seq_nota_fiscal = a.nr_sequencia);

C02 CURSOR FOR
SELECT  nr_sequencia
from    nota_fiscal a
where   dt_emissao between dt_inicial_p and fim_dia(dt_final_p)
and     exists (SELECT 1 from w_nota_fiscal b where b.nr_seq_nota_fiscal = a.nr_sequencia);

C03 CURSOR FOR
SELECT  cd_pessoa_fisica,
        cd_cgc,
        nr_sequencia,
        substr(obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc, 'CEP'),1,15) nr_cep_tomador,
        obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'DDT') nr_ddd_tomador,
        substr(Elimina_Caracteres_Especiais(obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'T')), 1, 8) nr_telefone,
        obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc, 'CDM') cd_mun,
	obter_dados_grupo_servico_item(obter_item_servico_proced(obter_procedimento_nfse(a.nr_sequencia,'P'), obter_procedimento_nfse(a.nr_sequencia,'O'),a.cd_estabelecimento), 'GR') cd_item_lista_serv,
	obter_dados_grupo_servico_item(obter_item_servico_proced(obter_procedimento_nfse(a.nr_sequencia,'P'), obter_procedimento_nfse(a.nr_sequencia,'O'),a.cd_estabelecimento), 'CD') cd_tributacao_mun,
	substr(obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc, 'EN'), 1, 255) ds_endereco,
	obter_dados_pf(cd_pessoa_fisica,'CPF') nr_cpf,
	obter_compl_pf(cd_pessoa_fisica,3,'C') nr_cpf_resp,
	a.cd_operacao_nf,
	nfe_obter_dados_transportadora(nr_sequencia,'EX') ds_existe_transp,
	obter_dados_pf_pj(a.cd_pessoa_fisica, a.cd_cgc, 'UF') sg_estado,
	nfse_obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc, 'EN') ds_endereco_adic,
	CASE WHEN nfse_obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc, 'NR')='0' THEN  null  ELSE nfse_obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc, 'NR') END  nr_endereco_adic,
  nfse_obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc, 'UF') sg_uf_adic,
	substr(nfse_obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc, 'B'),1,60) ds_bairro_adic,
	CASE WHEN nfse_obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc, 'CEP')='0' THEN  null  ELSE nfse_obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc, 'CEP') END  cd_cep_adic,
  nfse_obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc,'CDMDV') cd_municipio_ibge_adic,
	substr(CASE WHEN nfse_obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc,'T')=0 THEN  null  ELSE nfse_obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc,'T') END ,1,12) nr_telefone_adic,
	substr(nfse_obter_dados_pf_pj(cd_pessoa_fisica, cd_cgc,'DDT'),1,5) nr_ddd_telefone_adic,
	cd_estabelecimento,
	obter_empresa_estab(cd_estabelecimento) cd_empresa,
	coalesce(substr(obter_se_pf_pj_estrangeiro(cd_pessoa_fisica,cd_cgc),1,1),'N'),
	substr(CASE WHEN coalesce(nr_seq_mensalidade::text, '') = '' THEN				coalesce(CASE WHEN coalesce(cd_cgc::text, '') = '' THEN  CASE WHEN coalesce(nfse_obter_compl_pf(cd_pessoa_fisica,'M')::text, '') = '' THEN obter_dados_pf_pj(cd_pessoa_fisica, null, 'M')  ELSE nfse_obter_compl_pf(cd_pessoa_fisica,'M') END   ELSE obter_dados_pf_pj_estab(cd_estabelecimento, null, cd_cgc, 'M') END ,'')  ELSE coalesce(nfseops_obter_pf_pj_estab(cd_estabelecimento,cd_pessoa_fisica, cd_cgc, nr_seq_mensalidade,'M'),' ') END ,1,255),
	      a.dt_emissao
from    nota_fiscal a
where   a.nr_sequencia = nr_seq_nota_p;


BEGIN

delete
from    w_consistir_nfe
where   nm_usuario = nm_usuario_p;

commit;

select	count(*)
into STRICT	qt_registro_regra_w
from	regra_consistencia_nfe
where	ie_tipo_nota = ie_tipo_nota_p;

if (nr_seq_nota_p = 0) or (coalesce(nr_seq_nota_p::text, '') = '') then

        open C01;
        loop
        fetch C01 into
                cd_pessoa_fisica_w,
                cd_cgc_w,
                nr_sequencia_w,
                nr_cep_tomador_w,
                nr_ddd_tomador_w,
                nr_telefone_w,
                cd_mun_w,
		cd_item_lista_serv_w,
		cd_tributacao_mun_w,
		ds_endereco_tomador_w,
		nr_cpf_w,
		nr_cpf_resp_w,
		cd_operacao_nf_w,
		ds_existe_transp_w,
		sg_estado_w,
		cd_estabelecimento_w,
		cd_empresa_w,
		ie_tomador_estrangeiro_w;
        EXIT WHEN NOT FOUND; /* apply on C01 */
	if (qt_registro_regra_w > 0) then
		begin

		select	CASE WHEN ie_nf_eletronica='V' THEN 1 WHEN ie_nf_eletronica='S' THEN 2  ELSE 0 END
		into STRICT	ie_tipo_nota_w
		from	operacao_nota
		where	cd_operacao_nf = cd_operacao_nf_w;

		if (coalesce(nr_cep_tomador_w::text, '') = '') and (ie_tomador_estrangeiro_w = 'N') and (nfe_obter_se_consiste_campo(3,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313211),1,255),substr(wheb_mensagem_pck.get_texto(313212),1,255) );
		end if;

		if (coalesce(nr_DDD_Tomador_w::text, '') = '') and (nfe_obter_se_consiste_campo(4,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313213),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(nr_Telefone_w::text, '') = '') and (nfe_obter_se_consiste_campo(5,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313215),1,255),substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(cd_MUN_w::text, '') = '') and (ie_tomador_estrangeiro_w = 'N') and (nfe_obter_se_consiste_campo(6,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313216),1,255),substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (length(nr_cep_tomador_w) > 8) and (ie_tomador_estrangeiro_w = 'N') and (nfe_obter_se_consiste_campo(9,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313211),1,255), substr(wheb_mensagem_pck.get_texto(313221),1,255));
		end if;

		if (coalesce(cd_item_lista_serv_w::text, '') = '') and (nfe_obter_se_consiste_campo(7,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313217),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(cd_tributacao_mun_w::text, '') = '') and (nfe_obter_se_consiste_campo(8,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313218),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(ds_endereco_tomador_w::text, '') = '') and (nfe_obter_se_consiste_campo(10,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313220),1,255),substr(wheb_mensagem_pck.get_texto(313212),1,255) );
		end if;

		if (coalesce(nr_cpf_w::text, '') = '') and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and (ie_tomador_estrangeiro_w = 'N') and (nfe_obter_se_consiste_campo(12,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313224),1,255),substr(wheb_mensagem_pck.get_texto(313212),1,255) );
		end if;

		if (ds_existe_transp_w = 'N') and (nfe_obter_se_consiste_campo(13,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313226),1,255),substr(wheb_mensagem_pck.get_texto(313212),1,255) );
		end if;

		if (coalesce(nr_cpf_resp_w::text, '') = '') and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and (ie_tomador_estrangeiro_w = 'N') and (nfe_obter_se_consiste_campo(15,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313227),1,255),substr(wheb_mensagem_pck.get_texto(313212),1,255) );
		end if;

		if      ((coalesce(nr_cpf_resp_w::text, '') = '') and (coalesce(nr_cpf_w::text, '') = '')) and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and (ie_tomador_estrangeiro_w = 'N') and (nfe_obter_se_consiste_campo(16,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313229),1,255),substr(wheb_mensagem_pck.get_texto(313212),1,255) );
		end if;

		if (coalesce(sg_estado_w::text, '') = '') and (nfe_obter_se_consiste_campo(17,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313228),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		end;
	else
		begin
		if (coalesce(nr_cep_tomador_w::text, '') = '') and (ie_tomador_estrangeiro_w = 'N') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313211),1,255),substr(wheb_mensagem_pck.get_texto(313212),1,255) );
		end if;

		if (coalesce(nr_DDD_Tomador_w::text, '') = '') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313213),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(nr_Telefone_w::text, '') = '') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313215),1,255),substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(cd_MUN_w::text, '') = '') and (ie_tomador_estrangeiro_w = 'N') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313216),1,255),substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (length(nr_cep_tomador_w) > 8) and (ie_tomador_estrangeiro_w = 'N') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313211),1,255), substr(wheb_mensagem_pck.get_texto(313221),1,255));
		end if;

		if (coalesce(cd_item_lista_serv_w::text, '') = '') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313217),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(cd_tributacao_mun_w::text, '') = '') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313218),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(ds_endereco_tomador_w::text, '') = '') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313220),1,255),substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(nr_cpf_w::text, '') = '') and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and (ie_tomador_estrangeiro_w = 'N') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313224),1,255),substr(wheb_mensagem_pck.get_texto(313212),1,255) );
		end if;

		if      ((coalesce(nr_cpf_resp_w::text, '') = '') and (coalesce(nr_cpf_w::text, '') = '')) and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313229),1,255),substr(wheb_mensagem_pck.get_texto(313212),1,255) );
		end if;

		if (coalesce(sg_estado_w::text, '') = '') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313228),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		end;
	end if;
        contador_w := contador_w + 1;

        if (mod(contador_w,100) = 0) then
                commit;
        end if;

        end loop;
        close C01;

        commit;

        contador_w := 0;

        open C02;
        loop
        fetch C02 into
                nr_sequencia_w;
        EXIT WHEN NOT FOUND; /* apply on C02 */

                CALL estornar_exportacao_rps(nr_sequencia_w, nm_usuario_p);
                contador_w := contador_w + 1;

                if (mod(contador_w,100) = 0) then
                        commit;
                end if;
        end loop;
else
        open C03;
        loop
        fetch C03 into
                cd_pessoa_fisica_w,
                cd_cgc_w,
                nr_sequencia_w,
                nr_cep_tomador_w,
                nr_ddd_tomador_w,
                nr_telefone_w,
                cd_mun_w,
		            cd_item_lista_serv_w,
		            cd_tributacao_mun_w,
		            ds_endereco_tomador_w,
		            nr_cpf_w,
		            nr_cpf_resp_w,
		            cd_operacao_nf_w,
		            ds_existe_transp_w,
		            sg_estado_w,
		            ds_endereco_adic_w,
		            nr_endereco_adic_w,
		            sg_uf_adic_w,
		            ds_bairro_adic_w,
		            cd_cep_adic_w,
		            cd_municipio_ibge_adic_w,
		            nr_telefone_adic_w,
		            nr_ddd_telefone_adic_w,
		            cd_estabelecimento_w,
		            cd_empresa_w,
		            ie_tomador_estrangeiro_w,
		            ds_email_tomador_w,
		            dt_emissao_w;
        EXIT WHEN NOT FOUND; /* apply on C03 */

        	if (qt_registro_regra_w > 0) then
		begin

		select	CASE WHEN ie_nf_eletronica='V' THEN 1 WHEN ie_nf_eletronica='S' THEN 2  ELSE 0 END
		into STRICT	ie_tipo_nota_w
		from	operacao_nota
		where	cd_operacao_nf = cd_operacao_nf_w;

		if (coalesce(nr_cep_tomador_w::text, '') = '') and (ie_tomador_estrangeiro_w = 'N') and (nfe_obter_se_consiste_campo(3,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313211),1,255),substr(wheb_mensagem_pck.get_texto(313212),1,255) );
		end if;

		if (coalesce(nr_DDD_Tomador_w::text, '') = '') and (nfe_obter_se_consiste_campo(4,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313213),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(nr_Telefone_w::text, '') = '') and (nfe_obter_se_consiste_campo(5,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313215),1,255),substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(cd_MUN_w::text, '') = '') and (ie_tomador_estrangeiro_w = 'N') and (nfe_obter_se_consiste_campo(6,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313216),1,255),substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (length(nr_cep_tomador_w) > 8) and (ie_tomador_estrangeiro_w = 'N') and (nfe_obter_se_consiste_campo(9,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313211),1,255), substr(wheb_mensagem_pck.get_texto(313221),1,255));
		end if;

		if (coalesce(cd_item_lista_serv_w::text, '') = '') and (nfe_obter_se_consiste_campo(7,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313217),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(cd_tributacao_mun_w::text, '') = '') and (nfe_obter_se_consiste_campo(8,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313218),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(ds_endereco_tomador_w::text, '') = '') and (nfe_obter_se_consiste_campo(10,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313220),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (ds_existe_transp_w = 'N') and (nfe_obter_se_consiste_campo(13,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313226),1,255),substr(wheb_mensagem_pck.get_texto(313212),1,255) );
		end if;

		if (coalesce(nr_cpf_w::text, '') = '') and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and (ie_tomador_estrangeiro_w = 'N') and (nfe_obter_se_consiste_campo(12,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313224),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(nr_cpf_resp_w::text, '') = '') and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and (ie_tomador_estrangeiro_w = 'N') and (nfe_obter_se_consiste_campo(15,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313227),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if	((coalesce(nr_cpf_resp_w::text, '') = '') and (coalesce(nr_cpf_w::text, '') = '')) and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and (ie_tomador_estrangeiro_w = 'N') and (nfe_obter_se_consiste_campo(16,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313229),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(sg_estado_w::text, '') = '') and (nfe_obter_se_consiste_campo(17,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313228),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(ds_endereco_adic_w::text, '') = '') and (nfe_obter_se_consiste_campo(18,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313231),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(nr_endereco_adic_w::text, '') = '') and (nfe_obter_se_consiste_campo(19,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313232),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(sg_uf_adic_w::text, '') = '') and (nfe_obter_se_consiste_campo(20,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313233),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(ds_bairro_adic_w::text, '') = '') and (nfe_obter_se_consiste_campo(21,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313234),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(cd_cep_adic_w::text, '') = '') and (nfe_obter_se_consiste_campo(22,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313236),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(cd_municipio_ibge_adic_w::text, '') = '') and (nfe_obter_se_consiste_campo(23,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313237),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(nr_telefone_adic_w::text, '') = '') and (nfe_obter_se_consiste_campo(24,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313238),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(nr_ddd_telefone_adic_w::text, '') = '') and (nfe_obter_se_consiste_campo(25,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313239),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(ds_email_tomador_w::text, '') = '') and (nfe_obter_se_consiste_campo(26,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(356203),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;
		end;
		
		if (trunc(dt_emissao_w) <= trunc(clock_timestamp() - interval '5 days')) and (nfe_obter_se_consiste_campo(27,ie_tipo_nota_w,cd_estabelecimento_w,cd_empresa_w) = 'S') then			
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(1068852),1,255), substr(wheb_mensagem_pck.get_texto(290078),1,255));			
		end if;
		
	else
		begin
		if (coalesce(nr_cep_tomador_w::text, '') = '') and (ie_tomador_estrangeiro_w = 'N') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313211),1,255),substr(wheb_mensagem_pck.get_texto(313212),1,255) );
		end if;

		if (coalesce(nr_DDD_Tomador_w::text, '') = '') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313213),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(nr_Telefone_w::text, '') = '') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313215),1,255),substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(cd_MUN_w::text, '') = '') and (ie_tomador_estrangeiro_w = 'N') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313216),1,255),substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (length(nr_cep_tomador_w) > 8) and (ie_tomador_estrangeiro_w = 'N') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313211),1,255), substr(wheb_mensagem_pck.get_texto(313221),1,255));
		end if;

		if (coalesce(cd_item_lista_serv_w::text, '') = '') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313217),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(cd_tributacao_mun_w::text, '') = '') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313218),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(ds_endereco_tomador_w::text, '') = '') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313220),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		if (coalesce(nr_cpf_w::text, '') = '') and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')	and (ie_tomador_estrangeiro_w = 'N') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313224),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));

		end if;

		if (coalesce(nr_cpf_resp_w::text, '') = '') and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '')	then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313227),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));

		end if;

		if (ds_existe_transp_w = 'N') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313226),1,255),substr(wheb_mensagem_pck.get_texto(313212),1,255) );
		end if;

		if (coalesce(sg_estado_w::text, '') = '') then
			CALL inserir_dados_w_consistir_nfe(cd_pessoa_fisica_w , nm_usuario_p, cd_cgc_w, nr_sequencia_w, substr(wheb_mensagem_pck.get_texto(313228),1,255), substr(wheb_mensagem_pck.get_texto(313212),1,255));
		end if;

		end;
	end if;

        end loop;
        close C03;

        commit;
end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE id_inconsistencias_nfe (nm_usuario_p text, dt_inicial_p timestamp, dt_final_p timestamp, ie_tipo_nota_p text, nr_seq_nota_p bigint default 0) FROM PUBLIC;

