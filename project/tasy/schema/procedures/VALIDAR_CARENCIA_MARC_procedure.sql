-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE validar_carencia_marc (dt_agenda_p timestamp, cd_estabelecimento_p bigint, nr_seq_ageint_item_p bigint, ie_valida_caren_cober_p INOUT text, nr_exp_erro_p INOUT bigint, dt_carencia_p INOUT timestamp) AS $body$
DECLARE


dt_carencia_w  ageint_cobertura_item.dt_carencia%type;

c01 CURSOR FOR
 SELECT dt_carencia,
     cd_estabelecimento
 from ageint_cobertura_item
 where trunc(dt_referencia) = trunc(clock_timestamp())
 and   nr_seq_ageint_item = nr_seq_ageint_item_p;

BEGIN

 ie_valida_caren_cober_p := 'S';
 nr_exp_erro_p := 0;
 dt_carencia_p := clock_timestamp() - interval '365 days';

 for c01_w in c01 LOOP

  	dt_carencia_w := c01_w.dt_carencia;

  	if (dt_carencia_w IS NOT NULL AND dt_carencia_w::text <> '') then
  		dt_carencia_w := dt_carencia_w + 1;
  		dt_carencia_p := dt_carencia_w;
  	end if;

	if (coalesce(c01_w.cd_estabelecimento::text, '') = '' and coalesce(dt_carencia_w::text, '') = '') then
		ie_valida_caren_cober_p := 'S';
		exit;
	end if;

	if (coalesce(c01_w.cd_estabelecimento::text, '') = '' and trunc(dt_agenda_p) >= dt_carencia_w) then
		ie_valida_caren_cober_p := 'S';
		exit;
	end if;

	if (trunc(dt_agenda_p) >= dt_carencia_w and cd_estabelecimento_p = c01_w.cd_estabelecimento)
	or (coalesce(dt_carencia_w::text, '') = '' and cd_estabelecimento_p = c01_w.cd_estabelecimento) then
		ie_valida_caren_cober_p := 'S';
		exit;
	end if;

  if (trunc(dt_carencia_p) >= dt_agenda_p) then
   	nr_exp_erro_p := 580;
    ie_valida_caren_cober_p := 'N';
  end if;

  if (c01_w.cd_estabelecimento <> cd_estabelecimento_p) then
	if (nr_exp_erro_p = 0) or (coalesce(dt_carencia_w::text, '') = '') then
		nr_exp_erro_p := 570;
	else
		nr_exp_erro_p := 530;
	end if;
    ie_valida_caren_cober_p := 'N';
  end if;

  END LOOP;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE validar_carencia_marc (dt_agenda_p timestamp, cd_estabelecimento_p bigint, nr_seq_ageint_item_p bigint, ie_valida_caren_cober_p INOUT text, nr_exp_erro_p INOUT bigint, dt_carencia_p INOUT timestamp) FROM PUBLIC;

