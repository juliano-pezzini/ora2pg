-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gedipa_retornar_item_pend ( nr_seq_horario_p bigint, ie_status_preparo_p text, nm_usuario_p text ) AS $body$
DECLARE

 
ie_status_acerto_w		conta_paciente.ie_status_acerto%type;
cd_material_w		gedipa_etapa_hor.cd_material%type;
nr_sequencia_w		gedipa_etapa_prod_disp.nr_sequencia%type;
qt_material_w		gedipa_etapa_prod_disp.qt_material%type;
nr_seq_lote_fornec_w	gedipa_etapa_prod_disp.nr_seq_lote_fornec%type;
ie_status_etapa_w		gedipa_etapa_producao.ie_status_etapa%type;
nr_seq_etapa_w		gedipa_etapa_producao.nr_sequencia%type;
nr_seq_area_prep_w	gedipa_etapa_producao.nr_seq_area_prep%type;


BEGIN 
 
select	max(b.nr_sequencia), 
	max(d.ie_status_acerto) 
into STRICT	nr_sequencia_w, 
	ie_status_acerto_w 
from	gedipa_etapa_hor a, 
	gedipa_etapa_prod_disp b, 
	material_atend_paciente c, 
	conta_paciente d 
where	a.nr_sequencia 	= b.nr_seq_gedipa_hor 
and	b.nr_sequencia 	= c.nr_seq_gedipa_etapa_disp 
and	a.cd_material 	= c.cd_material 
and	c.nr_interno_conta = d.nr_interno_conta 
and	a.nr_sequencia 	= nr_seq_horario_p;
 
if (ie_status_acerto_w = 2) then		 
	--Conta do Paciente já fechada ! 
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(195615);
end if;
			 
--se o status do preparo do medicamento não for preparado, não existe registro na conta 
if (ie_status_preparo_p = obter_desc_expressao(321183)/*'Preparado'*/
) then	 
	 
	delete 	from material_atend_paciente 
	where	nr_seq_gedipa_etapa_disp	= nr_sequencia_w;
			 
end if;
		 
--retorna os itens para o estoque da cabine		 
select 	max(b.cd_material), 
	max(b.qt_material), 
	max(b.nr_seq_lote_fornec),		 
	max(c.nr_seq_area_prep) 
into STRICT	cd_material_w, 
	qt_material_w,			 
	nr_seq_lote_fornec_w,		 
	nr_seq_area_prep_w 
from  	gedipa_etapa_hor a, 
	gedipa_etapa_prod_disp b, 
	gedipa_etapa_producao c 
where 	a.nr_sequencia		= nr_seq_horario_p 
and  	a.nr_sequencia 		= b.nr_seq_gedipa_hor 
and  	a.nr_seq_etapa_gedipa	= c.nr_sequencia;
 
if (cd_material_w > 0) and (qt_material_w > 0) and (nr_seq_area_prep_w > 0) then 
 
	CALL gravar_gedipa_estoque_cab(nm_usuario_p, cd_material_w, qt_material_w, nr_seq_lote_fornec_w, nr_seq_area_prep_w);
	 
end if;
			 
--exclui os itens 
delete 	from gedipa_etapa_prod_disp 
where	nr_seq_gedipa_hor	= nr_seq_horario_p;
 
--verifica o status da etapa para retornar para higienizada caso esteja preparada 
select 	max(a.nr_sequencia), 
	max(a.ie_status_etapa)			 
into STRICT	nr_seq_etapa_w, 
	ie_status_etapa_w 
from 	gedipa_etapa_producao a, 
	gedipa_etapa_hor b 
where 	a.nr_sequencia 	= b.nr_seq_etapa_gedipa 
and	b.nr_sequencia 	= nr_seq_horario_p;
 
if (ie_status_etapa_w = 'P') then 
 
	update	gedipa_etapa_producao 
	set	ie_status_etapa	= 'H' 
	where	nr_sequencia	= nr_seq_etapa_w;
	 
end if;
 
update	gedipa_etapa_hor 
set	ie_status_preparo	= 'P' 
where 	nr_sequencia 	= nr_seq_horario_p;
 
commit;
	 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gedipa_retornar_item_pend ( nr_seq_horario_p bigint, ie_status_preparo_p text, nm_usuario_p text ) FROM PUBLIC;

