-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_diagnostico_doenca_eup (nr_atendimento_p bigint, nr_seq_agenda_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_retorno_p INOUT text) AS $body$
DECLARE



				    
cd_doenca_cid_w			varchar(10);		
cd_medico_w			varchar(10);
dt_diagnostico_w		timestamp;
cd_tipo_agenda_w		bigint;
ie_classificacao_doenca_w	varchar(1);
ie_tipo_diagnostico_w		smallint;

ie_tipo_doenca_tiss_w		varchar(1);
ie_diag_princ_agenda_exame_w	varchar(1);
ie_classific_diagonostico_w	varchar(1);
ie_diag_princ_agenda_serv_w 	varchar(1);


BEGIN

ie_tipo_doenca_tiss_w := Obter_param_Usuario(916, 898, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_tipo_doenca_tiss_w);
ie_diag_princ_agenda_exame_w := Obter_param_Usuario(916, 904, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_diag_princ_agenda_exame_w);
ie_classific_diagonostico_w := Obter_param_Usuario(916, 1106, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_classific_diagonostico_w);
ie_diag_princ_agenda_serv_w := Obter_param_Usuario(916, 1201, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_diag_princ_agenda_serv_w);
ie_retorno_p := 'N';


select	coalesce(max(cd_tipo_agenda),0)
into STRICT	cd_tipo_agenda_w
from	agenda_paciente a,
	agenda b
where	a.cd_agenda = b.cd_agenda
and	a.nr_sequencia = nr_seq_agenda_p;

if (coalesce(cd_tipo_agenda_w,0) = 0) then
	select	coalesce(obter_tipo_agenda(cd_agenda),3)
	into STRICT	cd_tipo_agenda_w
	from	agenda_consulta a
	where	a.nr_sequencia = nr_seq_agenda_p;
end if;

if (cd_tipo_agenda_w = 1) then
	-- Agenda Cirúrgica
	select	coalesce(max(cd_doenca_cid),'0'),
		coalesce(max(cd_medico),'0')
	into STRICT	cd_doenca_cid_w,
		cd_medico_w
	from	agenda_paciente
	where	nr_sequencia = nr_seq_agenda_p;

elsif (cd_tipo_agenda_w = 2) then
	-- Agenda de Exames
	select	coalesce(max(cd_doenca_cid),'0'),
		coalesce(max(cd_medico),'0')
	into STRICT	cd_doenca_cid_w,
		cd_medico_w
	from	agenda_paciente
	where	nr_sequencia = nr_seq_agenda_p;
	
	if (obter_funcao_ativa = 916) and -- Entrada Única
		(cd_medico_w = '0') then
		select	max(cd_medico_resp)
		into STRICT	cd_medico_w
		from	atendimento_paciente
		where	nr_atendimento = nr_atendimento_p;
	end if;
elsif (cd_tipo_agenda_w = 3) then
	-- Agenda de Consultas
	select	coalesce(max(cd_cid),'0'),
		coalesce(max(cd_medico_req),'0')
	into STRICT	cd_doenca_cid_w,
		cd_medico_w
	from	agenda_consulta
	where	nr_sequencia = nr_seq_agenda_p;
	
	if (obter_funcao_ativa = 916) and -- Entrada Única
		(cd_medico_w = '0') then
		select	max(cd_medico_resp)
		into STRICT	cd_medico_w
		from	atendimento_paciente
		where	nr_atendimento = nr_atendimento_p;
	end if;
elsif (cd_tipo_agenda_w = 5) then
	-- Agenda de Serviços
	select	coalesce(max(cd_cid),'0'),
		coalesce(max(cd_medico_solic),'0')
	into STRICT	cd_doenca_cid_w,
		cd_medico_w
	from	agenda_consulta
	where	nr_sequencia = nr_seq_agenda_p;
	
	if (obter_funcao_ativa = 916) and -- Entrada Única
		(cd_medico_w = '0') then
		select	max(cd_medico_resp)
		into STRICT	cd_medico_w
		from	atendimento_paciente
		where	nr_atendimento = nr_atendimento_p;
	end if;	
end if;

if (nr_atendimento_p > 0) and (cd_doenca_cid_w > '0') and (cd_medico_w > '0') then

	dt_diagnostico_w	:=	clock_timestamp();	
	
	if (cd_tipo_agenda_w = 3)
	or  (ie_diag_princ_agenda_serv_w = 'S' AND cd_tipo_agenda_w = 5)
	or	(ie_diag_princ_agenda_exame_w = 'S' AND cd_tipo_agenda_w = 2)
	or 	(ie_classific_diagonostico_w = 'S' AND cd_tipo_agenda_w = 1) then
		ie_tipo_diagnostico_w := 2;
		ie_classificacao_doenca_w := 'P';
	else	
		ie_tipo_doenca_tiss_w := null;
		ie_tipo_diagnostico_w := 1;
		ie_classificacao_doenca_w := null;
	end if;
	
	insert into  diagnostico_medico(
		nr_atendimento,
		dt_diagnostico,                 
		ie_tipo_diagnostico,           
		cd_medico,                      
		dt_atualizacao,                 
		nm_usuario)
	values (
		nr_atendimento_p,
		dt_diagnostico_w,		
		ie_tipo_diagnostico_w,
		cd_medico_w,
		clock_timestamp(),
		nm_usuario_p);
	commit;
			
	insert into diagnostico_doenca(
		nr_atendimento,
		dt_diagnostico,         
		cd_doenca,              
		dt_atualizacao,
		nm_usuario,
		ie_classificacao_doenca,
		ie_tipo_doenca,
		ie_situacao,
		ie_tipo_diagnostico)        
	values (
		nr_atendimento_p,
		dt_diagnostico_w,
		cd_doenca_cid_w,
		clock_timestamp(),
		nm_usuario_p,
		ie_classificacao_doenca_w,
		ie_tipo_doenca_tiss_w,
		'A',
		ie_tipo_diagnostico_w);
		
	ie_retorno_p	:=	'S';
	
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_diagnostico_doenca_eup (nr_atendimento_p bigint, nr_seq_agenda_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_retorno_p INOUT text) FROM PUBLIC;

