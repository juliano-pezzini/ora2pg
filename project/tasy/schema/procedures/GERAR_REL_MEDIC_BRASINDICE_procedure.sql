-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_rel_medic_brasindice ( nm_usuario_p text, cd_estabelecimento_p bigint, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, cd_material_p bigint, cd_brasindice_laboratorio_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, ie_versao_atual_p text, ie_classificacao_p bigint, ie_muda_preco_p text, ie_tipo_preco_p text, ie_somente_ativos_p text ) AS $body$
DECLARE


cd_material_w			material_brasindice.cd_material%type;
cd_tiss_w			brasindice_preco.cd_tiss%type;
ds_material_w			material.ds_material%type;
ds_laboratorio_w		brasindice_laboratorio.ds_laboratorio%type;
ds_medicamento_w		brasindice_medicamento.ds_medicamento%type;
ds_apresentacao_w		brasindice_apresentacao.ds_apresentacao%type;
vl_ultima_compra_w		double precision;
cd_unidade_medida_compra_w	varchar(255);
cd_unidade_medida_consumo_w	varchar(255);
dt_inicio_vigencia_w		timestamp;
ie_tipo_preco_w			varchar(3);
vl_preco_medicamento_w		double precision;
qt_conversao_w			double precision;
cd_laboratorio_w		varchar(6);
cd_medicamento_w		varchar(6);
cd_apresentacao_w		varchar(6);
cd_classe_material_w		integer;
qt_conv_estoque_consumo_w	double precision;
ds_classe_material_w		varchar(255);
ds_subgrupo_material_w		varchar(255);
ds_grupo_material_w		varchar(255);
vl_unitario_w			double precision;
cd_grupo_material_w		smallint;
cd_subgrupo_material_w		smallint;
ie_muda_preco_w			varchar(1);
ie_mudou_preco_tipo_w		varchar(1);
nr_count_w			smallint;
ie_ordenacao_w			varchar(40);
ie_ordem_w			bigint := 0;

C01 CURSOR FOR
SELECT	a.cd_material,
	a.cd_laboratorio,
	a.cd_medicamento,
	a.cd_apresentacao,
	a.qt_conversao,
	b.ds_material,
	b.cd_classe_material,
	substr(obter_dados_material_estab(b.cd_material,cd_estabelecimento_p,'UMC'),1,30) cd_unidade_medida_compra,
	substr(obter_dados_material_estab(b.cd_material,cd_estabelecimento_p,'UMS'),1,30) cd_unidade_medida_consumo,
	b.qt_conv_estoque_consumo,
	c.ds_laboratorio,
	d.ds_medicamento,
	e.ds_apresentacao,
	f.ds_classe_material,
	g.ds_subgrupo_material,
	h.ds_grupo_material,
	x.dt_inicio_vigencia,
	x.vl_preco_medicamento,
	x.ie_tipo_preco,
	obter_valor_ultima_compra(cd_estabelecimento_p, null, a.cd_material, null,'N') vl_ultima_compra,
	coalesce(x.cd_tiss,0) cd_tiss,
	h.cd_grupo_material,
	g.cd_subgrupo_material
from	material_brasindice a,
	material b,
	brasindice_laboratorio c,
	brasindice_medicamento d,
	brasindice_apresentacao e,
	classe_material f,
	subgrupo_material g,
	grupo_material h,
	brasindice_preco x
where (a.cd_material =  b.cd_material)
and (a.cd_laboratorio =  c.cd_laboratorio)
and (a.cd_medicamento =  d.cd_medicamento)
and (a.cd_apresentacao =  e.cd_apresentacao)
and (b.cd_classe_material =  f.cd_classe_material)
and (f.cd_subgrupo_material =  g.cd_subgrupo_material)
and (g.cd_grupo_material =  h.cd_grupo_material)
and (a.cd_laboratorio =  x.cd_laboratorio)
and (a.cd_medicamento =  x.cd_medicamento)
and (a.cd_apresentacao =  x.cd_apresentacao)
and	((ie_somente_ativos_p = 'N') or (b.ie_situacao = 'A'))
and	((h.cd_grupo_material = cd_grupo_material_p) or (coalesce(cd_grupo_material_p,'0') = '0'))
and	((g.cd_subgrupo_material = cd_subgrupo_material_p) or (coalesce(cd_subgrupo_material_p,'0') = '0'))
and	((f.cd_classe_material = cd_classe_material_p) or (coalesce(cd_classe_material_p,'0') = '0'))
and	((b.cd_material = cd_material_p) or (coalesce(cd_material_p,'0') = '0'))
and	((c.cd_laboratorio = cd_brasindice_laboratorio_p) or (coalesce(cd_brasindice_laboratorio_p,'0') = '0'))
and	((coalesce(dt_inicio_p::text, '') = '') or (x.dt_inicio_vigencia between dt_inicio_p and coalesce(dt_fim_p, dt_inicio_p)))
and 	((x.ie_versao_atual = ie_versao_atual_p) or (coalesce(ie_versao_atual_p,'0') = '0'))
and	((coalesce(ie_muda_preco_w,'0') = '0') or (Obter_Se_Mudou_Preco_tipo(x.cd_laboratorio, x.cd_apresentacao, x.cd_medicamento, x.ie_tipo_preco, dt_inicio_p, dt_fim_p) = ie_mudou_preco_tipo_w))
and	((ie_tipo_preco_p = 'A') or (x.ie_tipo_preco = ie_tipo_preco_w))
order by	CASE WHEN ie_classificacao_p=0 THEN  b.cd_material END ,
	CASE WHEN ie_classificacao_p=1 THEN  b.ds_material WHEN ie_classificacao_p=2 THEN  c.ds_laboratorio || d.ds_medicamento WHEN ie_classificacao_p=3 THEN  d.ds_medicamento END;


BEGIN

if (ie_muda_preco_p <> '0') then
	if (coalesce(dt_inicio_p::text, '') = '') and (coalesce(dt_fim_p::text, '') = '') then
		ie_muda_preco_w := '0';
	end if;

	if (ie_muda_preco_w = '1') then
		ie_mudou_preco_tipo_w := 'S';
	elsif (ie_muda_preco_w = '2') then
		ie_mudou_preco_tipo_w := 'N';
	end if;
end if;

if (ie_tipo_preco_p <> 'A') then
	if (ie_tipo_preco_p = 'B') then
		ie_tipo_preco_w := 'PFB';
	elsif (ie_tipo_preco_p = 'C') then
		ie_tipo_preco_w := 'PMC';
	end if;
end if;

delete from rel_medicamento_brasindice where nm_usuario = nm_usuario_p;
commit;

open C01;
loop
fetch C01 into
	cd_material_w,
	cd_laboratorio_w,
	cd_medicamento_w,
	cd_apresentacao_w,
	qt_conversao_w,
	ds_material_w,
	cd_classe_material_w,
	cd_unidade_medida_compra_w,
	cd_unidade_medida_consumo_w,
	qt_conv_estoque_consumo_w,
	ds_laboratorio_w,
	ds_medicamento_w,
	ds_apresentacao_w,
	ds_classe_material_w,
	ds_subgrupo_material_w,
	ds_grupo_material_w,
	dt_inicio_vigencia_w,
	vl_preco_medicamento_w,
	ie_tipo_preco_w,
	vl_ultima_compra_w,
	cd_tiss_w,
	cd_grupo_material_w,
	cd_subgrupo_material_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	ie_ordem_w := ie_ordem_w + 1;

	if (qt_conversao_w > 0) then
		vl_unitario_w := dividir(vl_preco_medicamento_w,qt_conversao_w);
	else
		vl_unitario_w := dividir(vl_preco_medicamento_w,1);
	end if;

	insert into rel_medicamento_brasindice(	cd_material,
					cd_laboratorio,
					cd_medicamento,
					cd_apresentacao,
					qt_conversao,
					ds_material,
					cd_classe_material,
					cd_unidade_medida_compra,
					cd_unidade_medida_consumo,
					qt_conv_estoque_consumo,
					ds_laboratorio,
					ds_medicamento,
					ds_apresentacao,
					ds_classe_material,
					ds_subgrupo_material,
					ds_grupo_material,
					dt_inicio_vigencia,
					vl_preco_medicamento,
					ie_tipo_preco,
					vl_ultima_compra,
					cd_tiss,
					vl_unitario,
					cd_grupo_material,
					cd_subgrupo_material,
					nm_usuario,
					ie_ordem)
				values (cd_material_w,
					cd_laboratorio_w,
					cd_medicamento_w,
					cd_apresentacao_w,
					qt_conversao_w,
					ds_material_w,
					cd_classe_material_w,
					cd_unidade_medida_compra_w,
					cd_unidade_medida_consumo_w,
					qt_conv_estoque_consumo_w,
					ds_laboratorio_w,
					ds_medicamento_w,
					ds_apresentacao_w,
					ds_classe_material_w,
					ds_subgrupo_material_w,
					ds_grupo_material_w,
					dt_inicio_vigencia_w,
					vl_preco_medicamento_w,
					ie_tipo_preco_w,
					vl_ultima_compra_w,
					cd_tiss_w,
					vl_unitario_w,
					cd_grupo_material_w,
					cd_subgrupo_material_w,
					nm_usuario_p,
					ie_ordem_w);

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_rel_medic_brasindice ( nm_usuario_p text, cd_estabelecimento_p bigint, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, cd_material_p bigint, cd_brasindice_laboratorio_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, ie_versao_atual_p text, ie_classificacao_p bigint, ie_muda_preco_p text, ie_tipo_preco_p text, ie_somente_ativos_p text ) FROM PUBLIC;

