-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qt_gerar_horario ( nr_seq_pendencia_p bigint, nr_seq_agenda_p bigint, dt_agenda_p timestamp, nm_usuario_p text, nr_min_duracao_p bigint, cd_pessoa_fisica_p text, nr_seq_grupo_quimio_p bigint default null, cd_estabelecimento_p bigint default null, nr_seq_local_p bigint default null, nr_seq_ageint_item_p bigint default null, nr_seq_prof_p bigint default null, ds_locais_p text default null) AS $body$
DECLARE


nr_seq_local_w		bigint;
hr_atual_w		timestamp;
hr_final_dia_w		timestamp;
hr_inicial_dia_w	timestamp;
hr_inicial_truncada_w	timestamp;
ie_status_w		varchar(15);
qt_marcado_w		bigint;
ie_dia_Semana_w		integer;
nr_seq_pend_maracada_w	bigint;
nr_Seq_pend_agenda_w	bigint;
nr_seq_atend_marcado_w	bigint;
nr_seq_pend_agenda_marcado_w	bigint;
nr_minuto_aval_w	bigint;
nr_seq_agequi_w		bigint;
qt_pac_horario_w	bigint;
ie_horario_bloq_w	varchar(1);
nr_seq_agenda_w		bigint;
nr_seq_agenda_marcado_w	bigint;
qt_turno_w		bigint;
dt_agenda_w		timestamp;
nr_duracao_W		bigint;
qt_tempo_entre_hor_W	bigint;
ie_indice_w		integer;
ie_ind_w		integer;
nr_seq_prof_w		bigint;
dt_min_agendamento_w	timestamp;
dt_max_agendamento_w	timestamp;
hr_inicio_turno_w	timestamp;
hr_fim_turno_w		timestamp;
ie_possui_turno_w	varchar(1)	:= 'N';
qt_marcacao_w		bigint;
ie_feriado_w		varchar(1);
cd_estabelecimento_w	smallint;
nr_seq_atendimento_w	bigint;
nr_seq_atendimento_ww	bigint;
ie_regra_bloq_medic_w	varchar(1);
cd_estab_pend_w		smallint;
nr_seq_ageint_item_w	bigint;
nr_seq_ageint_item_ww	bigint;
nr_seq_paciente_w	bigint;
nr_seq_atend_sim_w	bigint;
ie_gerado_w		varchar(1);
nr_seq_ageint_item_www	bigint;
ie_status_agenda_w	varchar(15);
ie_permite_w		varchar(1);

hr_quebra_turno_w		varchar(05);
hr_quebra_turno_not_w		varchar(05);
cd_turno_w			bigint := 0;
nr_minuto_duracao_w		bigint;
qt_registros_ag_quimio		bigint;

qt_horario_w			bigint;
ie_Reserva_w			varchar(1);
cd_pac_agenda_w			varchar(10);
dt_vigencia_inicial_w	timestamp;
dt_vigencia_final_w		timestamp;
nr_min_apres_local_w	qt_local.nr_min_apres%type;
ie_mesmo_local_w	varchar(1);
ie_bloq_regra_w		varchar(1);
ie_possui_bloq_regra_medic_w		varchar(1);
nr_seq_grupo_quimio_w	agenda_integrada_item.nr_seq_grupo_quimio%type;
ie_tipo_pend_agenda_w 	agenda_integrada_item.ie_tipo_pend_agenda%type;

ie_existe_agenda_w	varchar(1):= 'N';
/*
status
L - Livre
I - Invisivel (utilizado para montar corretamente os panels em caso de inicio em horarios "quebrados")
EA - Em agendamento
M - Marcado
*/


/*cursor dos locais*/

C01 CURSOR FOR
	SELECT	nr_sequencia,
			cd_estabelecimento,
			nr_min_apres
	from	qt_local
	where	ie_situacao	= 'A'
	and		(((nr_seq_grupo_quimio	= nr_seq_grupo_quimio_p) or (coalesce(nr_seq_grupo_quimio_p::text, '') = '')) or (ie_mesmo_local_w = 'S'))
	and		((cd_estabelecimento	= cd_estabelecimento_p) or (coalesce(cd_estabelecimento_p::text, '') = ''))
	and		nr_sequencia	= coalesce(nr_Seq_local_p, nr_Sequencia)
	and (Qt_Obter_Se_Local_Lib(nr_seq_ageint_item_p, nr_sequencia)	= 'S' or coalesce(nr_seq_ageint_item_p,0) = 0)
	and (obter_se_contido(nr_Sequencia, ds_locais_p)	= 'S' or coalesce(ds_locais_p::text, '') = '')
	order by 1;
	
/*cursor dos turnos dos locais*/
	
C02 CURSOR FOR
	SELECT	hr_inicial,
		hr_final,
		dt_vigencia_inicial,
		dt_vigencia_final
	from	qt_local_turno
	where	nr_seq_local	= nr_seq_local_w
	and	((dt_dia_semana = ie_dia_semana_w) or ((dt_dia_semana = 9) and (ie_dia_Semana_w not in (7,1))) or (coalesce(dt_dia_semana::text, '') = ''))	
	and	((ie_feriado_w	<> 'S' and coalesce(ie_feriado,'N') = 'N') or (coalesce(ie_feriado, 'N') = 'S' and ie_feriado_w = 'S'))
	and	((coalesce(dt_vigencia_inicial::text, '') = '') or (trunc(dt_vigencia_inicial) <= trunc(dt_agenda_p)))
	and	((coalesce(dt_vigencia_final::text, '') = '') or (trunc(dt_vigencia_final) >= trunc(dt_agenda_p)))
	order by 1;
	
C03 CURSOR FOR
	SELECT	dt_Agenda,
		nr_seq_pend_Agenda,
		nr_Seq_agenda,
		nr_duracao,
		nr_seq_ageint_item,
		nr_seq_paciente,
		nr_seq_atendimento
	from	agenda_quimio_marcacao
	where	nr_seq_local		= nr_Seq_local_w
	and	dt_agenda between trunc(dt_agenda_p) and fim_dia(dt_agenda_p);
	
C04 CURSOR FOR
	SELECT	a.dt_agenda,
		a.nr_minuto_duracao,
		a.nr_seq_local,
		a.nr_seq_pend_agenda,
		a.nr_sequencia,
		a.nr_seq_Ageint_item,
		a.ie_reserva,
		a.cd_pessoa_fisica,
		nr_seq_atendimento
	from	agenda_quimio a,
		qt_local b
	where	a.dt_agenda between trunc(dt_Agenda_p) and trunc(dt_Agenda_p) + 86399/86400
	and		a.nr_seq_local	= b.nr_sequencia
	and		a.ie_status_agenda	not in ('C', 'S')
	and (coalesce(a.nr_seq_pend_Agenda::text, '') = ''
	or ((a.nr_seq_pend_Agenda IS NOT NULL AND a.nr_seq_pend_Agenda::text <> '')
	and		exists (SELECT 1 from qt_pendencia_Agenda x where x.nr_sequencia = a.nr_seq_pend_Agenda)))
	--and		not exists (select 1 from w_agenda_quimio w where w.nr_seq_pend_agenda = a.nr_seq_pend_agenda)
	and		(((b.nr_seq_grupo_quimio	= nr_seq_grupo_quimio_p) or (coalesce(nr_seq_grupo_quimio_p::text, '') = '')) or (ie_mesmo_local_w = 'S'))
	and		((b.cd_estabelecimento	= cd_estabelecimento_p) or (coalesce(cd_estabelecimento_p::text, '') = ''))
	and		b.nr_sequencia	= coalesce(nr_Seq_local_p, b.nr_Sequencia)
	order by dt_Agenda;

C05 CURSOR FOR
	SELECT	dt_agenda,
		nr_duracao,
		nr_seq_local,
		nr_seq_pend_agenda,
		nr_seq_agenda,
		nr_seq_ageint_item,
		nr_seq_atendimento
	from	agenda_quimio_marcacao a
	where	dt_agenda between trunc(dt_Agenda_p) and trunc(dt_Agenda_p) + 86399/86400
	--and		ie_status_agenda	<> 'B' 
	and		nr_seq_local	= coalesce(nr_Seq_local_p, nr_seq_local)
	and		ie_gerado		= 'N'
	order by dt_Agenda;
		

BEGIN



commit;

delete	FROM w_agenda_quimio
where	nm_usuario		= nm_usuario_p
and 	trunc(dt_horario) < trunc(dt_agenda_p)
and		ie_status	in ('L','B','EA','I');

delete FROM w_agenda_quimio waq
where waq.nr_seq_agequi in (
    SELECT aq.nr_sequencia
        from agenda_quimio aq 
        where  aq.nm_usuario = nm_usuario_p 
        and trunc(aq.dt_agenda) = trunc(dt_agenda_p) 
        and aq.ie_status_agenda in ('F','E')
        )
and trunc(waq.dt_horario) = trunc(dt_agenda_p)
and waq.ie_status = 'AG';

if (nr_seq_ageint_item_p IS NOT NULL AND nr_seq_ageint_item_p::text <> '') and (nr_Seq_local_p IS NOT NULL AND nr_Seq_local_p::text <> '') then
	delete 	FROM w_agenda_quimio
	where	nm_usuario		= nm_usuario_p
	and (nr_seq_ageint_item	= nr_seq_ageint_item_p or coalesce(nr_seq_ageint_item_p::text, '') = '')
	and	nr_seq_local		= nr_Seq_local_p
	and (ie_status	in ('L','B','EA','I') or ie_reserva = 'S');
elsif (nr_seq_ageint_item_p IS NOT NULL AND nr_seq_ageint_item_p::text <> '') and (coalesce(nr_Seq_local_p::text, '') = '') then
		
		if (ds_locais_p IS NOT NULL AND ds_locais_p::text <> '') then
			delete 	FROM w_agenda_quimio
			where	nm_usuario			= nm_usuario_p
			and (obter_se_contido(nr_Seq_local, ds_locais_p)	= 'S' or coalesce(ds_locais_p::text, '') = '')
			and (nr_seq_ageint_item	= nr_seq_ageint_item_p or coalesce(nr_seq_ageint_item_p::text, '') = '')
			and (ie_status	in ('L','B','EA','I') or ie_reserva = 'S');
		else	
			delete 	FROM w_agenda_quimio
			where	nm_usuario			= nm_usuario_p
			and (nr_seq_ageint_item	= nr_seq_ageint_item_p or coalesce(nr_seq_ageint_item_p::text, '') = '')
			and (ie_status	in ('L','B','EA','I') or ie_reserva = 'S');
		end if;
		
		
elsif (coalesce(nr_seq_ageint_item_p::text, '') = '') and (nr_Seq_local_p IS NOT NULL AND nr_Seq_local_p::text <> '') then
		delete 	FROM w_agenda_quimio
		where	nm_usuario		= nm_usuario_p
		and		nr_seq_local	= nr_Seq_local_p
		and (nr_seq_ageint_item	= nr_seq_ageint_item_p or coalesce(nr_seq_ageint_item_p::text, '') = '')
		and (ie_status	in ('L','B','EA','I') or ie_reserva = 'S');
else
	if (ds_locais_p IS NOT NULL AND ds_locais_p::text <> '') then
		delete 	FROM w_agenda_quimio
		where	nm_usuario		= nm_usuario_p
		and (nr_seq_ageint_item	= nr_seq_ageint_item_p or coalesce(nr_seq_ageint_item_p::text, '') = '')
		and (obter_se_contido(nr_Seq_local, ds_locais_p)	= 'S' or coalesce(ds_locais_p::text, '') = '')
		and (ie_status	in ('L','B','EA','I') or ie_reserva = 'S');
	else
		delete 	FROM w_agenda_quimio
		where	nm_usuario		= nm_usuario_p
		and (nr_seq_ageint_item	= nr_seq_ageint_item_p or coalesce(nr_seq_ageint_item_p::text, '') = '')
		and (ie_status	in ('L','B','EA','I') or ie_reserva = 'S');
	end if;
	
end if;

commit;


select	obter_cod_dia_semana(dt_agenda_p)
into STRICT	ie_dia_semana_w
;



if (nr_seq_prof_p IS NOT NULL AND nr_seq_prof_p::text <> '') then
	nr_seq_prof_w	:= nr_seq_prof_p;
else
	nr_seq_prof_w	:= null;
end if;

ie_regra_bloq_medic_w	:= coalesce(Obter_Valor_Param_Usuario(865, 26, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p),'S');



open C01;
loop
fetch C01 into	
	nr_seq_local_w,
	cd_estabelecimento_w,
	nr_min_apres_local_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin	
	select	max(coalesce(hr_quebra_turno, '12')),
			max(hr_quebra_noturno)
	into STRICT	hr_quebra_turno_w,
			hr_quebra_turno_not_w
	from	qt_local
	where	nr_sequencia = nr_seq_local_w;
	
	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_feriado_w
	from 	feriado a
	where 	a.cd_estabelecimento 	= coalesce(cd_estabelecimento_p, cd_estabelecimento_w)
	and	a.dt_feriado between trunc(dt_agenda_p) and trunc(dt_agenda_p) + 86399/86400;
	
	ie_possui_turno_W	:= 'N';
	select	count(*)
	into STRICT	qt_turno_w
	from	qt_local_turno
	where	nr_seq_local	= nr_seq_local_w
	and	((dt_dia_semana = ie_dia_semana_w) or ((dt_dia_semana = 9) and (ie_dia_Semana_w not in (7,1))));
	--and	(dt_Agenda_w >= hr_inicial or hr_inicial is null)

	--and	(dt_Agenda_w <= hr_final or hr_final is null);

	--if	(qt_turno_w	= 0) then
	
		open C03;
		loop
		fetch C03 into	
			dt_Agenda_w,
			nr_seq_pend_agenda_w,
			nr_seq_agenda_w,
			nr_duracao_W,
			nr_seq_ageint_item_w,
			nr_seq_paciente_w,
			nr_seq_atendimento_ww;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin	

			select	count(*)
			into STRICT	qt_turno_w
			from	qt_local_turno
			where	nr_seq_local	= nr_seq_local_w
			and	((dt_dia_semana = ie_dia_semana_w) or ((dt_dia_semana = 9) and (ie_dia_Semana_w not in (7,1))))
			and (dt_Agenda_w >= to_date(to_char(dt_Agenda_w,'dd/mm/yyyy') ||' '|| to_char(hr_inicial,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss') or coalesce(hr_inicial::text, '') = '')
			and (dt_Agenda_w <= to_date(to_char(dt_Agenda_w,'dd/mm/yyyy') ||' '|| to_char(hr_final,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss') - 1/1440 or coalesce(hr_final::text, '') = '')
			and	((ie_feriado_w	<> 'S' and coalesce(ie_feriado,'N') = 'N') or (coalesce(ie_feriado, 'N') = 'S' and ie_feriado_w = 'S'));
			
			if (qt_turno_w	= 0) then
				qt_tempo_entre_hor_W	:= OBTER_MIN_ENTRE_DATAS( dt_agenda_w, dt_Agenda_W + (nr_duracao_W - 1) / 1440,1);
				ie_indice_w	:= trunc(qt_tempo_entre_hor_W / coalesce(nr_min_apres_local_w, nr_min_duracao_p));		
				ie_ind_w	:= 0;
				
				if	(((to_char(hr_atual_w, 'hh24'))::numeric  > somente_numero(hr_quebra_turno_w)) or ((to_char(hr_atual_w, 'hh24'))::numeric  = somente_numero(hr_quebra_turno_w))) then
					cd_turno_w	:= 1;
				else
					cd_turno_w	:= 0;
				end if;
				if (hr_quebra_turno_not_w IS NOT NULL AND hr_quebra_turno_not_w::text <> '') and ((to_char(hr_atual_w, 'hh24'))::numeric  >= somente_numero(hr_quebra_turno_not_w)) then
					cd_turno_w	:= 3;
				end if;
				
				while ie_ind_w	<= ie_indice_w loop
					begin
					begin
					select	1
					into STRICT	qt_horario_W
					from	w_agenda_quimio
					where (nr_seq_item_marc	= nr_seq_Ageint_item_w
					or 		nr_seq_pend_agenda = nr_seq_pend_agenda_w)
					and	dt_horario		= dt_agenda_w  LIMIT 1;
					exception
						when others then
						qt_horario_W	:= 0;
					end;
					
					
					
					if (qt_horario_W	= 0) then							

			
						
						
						select	coalesce(count(*),0)
						into STRICT	qt_registros_ag_quimio
						from	agenda_quimio
						where	nr_sequencia = nr_seq_agenda_w;
						
						
						if (qt_registros_ag_quimio = 0) then
							
							insert into w_agenda_quimio(--nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								dt_horario,
								ie_status,
								nr_seq_local,
								nr_seq_pend_agenda,
								nr_seq_agequi,
								nr_seq_ageint_item,
								nr_seq_item_marc,
								nr_seq_paciente,
								cd_turno,
								nr_seq_atendimento)
							values (--w_agenda_quimio_seq.nextval,
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(), 
								nm_usuario_p, 
								dt_Agenda_w,
								'EA',--ie_status_w, 
								nr_seq_local_w,
								coalesce(nr_seq_pend_agenda_w, null),
								null,
								nr_seq_ageint_item_p,
								nr_seq_ageint_item_w,
								nr_seq_paciente_w,
								cd_turno_w,
								nr_seq_atendimento_ww);	
						else
						
							insert into w_agenda_quimio(--nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								dt_horario,
								ie_status,
								nr_seq_local,
								nr_seq_pend_agenda,
								nr_seq_agequi,
								nr_seq_ageint_item,
								nr_seq_item_marc,
								nr_seq_paciente,
								cd_turno,
								nr_seq_atendimento)
							values (--w_agenda_quimio_seq.nextval,
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(), 
								nm_usuario_p, 
								dt_Agenda_w,
								'EA',--ie_status_w, 
								nr_seq_local_w,
								coalesce(nr_seq_pend_agenda_w, null),
								nr_seq_agenda_w,
								nr_seq_ageint_item_p,
								nr_seq_ageint_item_w,
								nr_seq_paciente_w,
								cd_turno_w,
								nr_seq_atendimento_ww);	
						end if;	
					end if;

					dt_agenda_w	:= dt_agenda_w + coalesce(nr_min_apres_local_w,nr_min_duracao_p) / 1440;
					ie_ind_w	:= ie_ind_w + 1;
					end;
				end loop;
				nr_seq_agenda_w	:= null;
			end if;
			end;
		end loop;
		close C03;
	--end if;
	
	open C02;
	loop
	fetch C02 into	
		hr_inicial_dia_w,
		hr_final_dia_w,
		dt_vigencia_inicial_w,
		dt_vigencia_final_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		hr_inicial_dia_w	:= to_date(to_char(dt_agenda_p, 'dd/mm/yyyy') || ' ' || to_char(hr_inicial_dia_w, 'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
		hr_final_dia_w		:= to_date(to_char(dt_agenda_p, 'dd/mm/yyyy') || ' ' || to_char(hr_final_dia_w, 'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
		
		hr_inicio_turno_w	:= hr_inicial_dia_w;
		hr_fim_turno_w		:= hr_final_dia_w;
		
		/*select	max(dt_agenda + nr_duracao / 1440) 
		into	dt_max_agendamento_w
		from 	agenda_quimio_marcacao 
		where 	trunc(dt_Agenda) = trunc(dt_agenda_p);*/
		if (dt_max_agendamento_w IS NOT NULL AND dt_max_agendamento_w::text <> '') and (dt_max_agendamento_w > hr_final_dia_w) then
			hr_final_dia_w	:= dt_max_agendamento_w;
		end if;
		
		/*select 	min(dt_agenda)
		into	dt_min_agendamento_w
		from 	agenda_quimio_marcacao 
		where 	trunc(dt_Agenda) = trunc(dt_agenda_p);		*/
		
		if (dt_min_agendamento_w IS NOT NULL AND dt_min_agendamento_w::text <> '') and (dt_min_agendamento_w < hr_inicial_dia_w) then
			hr_inicial_dia_w	:= dt_min_agendamento_w;
		end if;
		
		hr_inicial_truncada_w	:= to_date(to_char(dt_agenda_p, 'dd/mm/yyyy') || ' ' || to_char(hr_inicial_dia_w, 'hh24') || ':00:00','dd/mm/yyyy hh24:mi:ss');
		if (hr_inicial_truncada_w	<> hr_inicial_dia_w) then
			hr_atual_w	:= hr_inicial_truncada_w;
		else
			hr_atual_w	:= hr_inicial_dia_w;
		end if;
		while(hr_atual_w < hr_final_dia_w) loop
			begin
			ie_possui_turno_w	:= 'S';
				nr_seq_pend_agenda_w	:= nr_seq_pendencia_p;
				if (hr_atual_w	< hr_inicio_turno_w) or (hr_atual_w + coalesce(nr_min_apres_local_w, nr_min_duracao_p) / 1440	> hr_fim_turno_w) then
					ie_status_w	:= 'I';
				else	
					ie_status_w	:= 'L';
				end if;
				begin
				select	1
				into STRICT	qt_horario_w
				from	w_agenda_quimio
				where	dt_horario	= hr_atual_w
				and		nr_seq_local	= nr_seq_local_w
				and (nr_seq_ageint_item	= nr_seq_ageint_item_p or coalesce(nr_seq_ageint_item_p::text, '') = '')
				and		((nm_usuario		= nm_usuario_p
				and (ie_status	in ('L','B','EA','I') or ie_reserva = 'S'))
				or		ie_status	in ('AG','D'))  LIMIT 1;
				exception
				when others then
					qt_horario_w	:= 0;
				end;
				if (qt_horario_w	= 0) then
					if (ie_status_w	<> 'I') then

						select	coalesce(obter_agend_quimio_bloq(dt_agenda_p, hr_atual_w, (hr_atual_w + (coalesce(nr_min_apres_local_w, nr_min_duracao_p) / 1440)), nr_seq_local_w),'N')
						into STRICT	ie_horario_bloq_w
						;

						if (ie_horario_bloq_w = 'N') then
							--(cd_pessoa_fisica_p is not null) then

							/*if	(nr_seq_prof_p is null) then
								select	max(nr_seq_prof)
								into	nr_seq_prof_w
								from	qt_paciente_prof
								where	cd_pessoa_fisica = cd_pessoa_fisica_p;
							else
								nr_seq_prof_w	:= nr_seq_prof_p;
							end if;*/
							if (ie_regra_bloq_medic_w	= 'S') then				

		
								select 	obter_agend_quimio_bloq_prof(dt_agenda_p, hr_atual_w, (hr_atual_w + (coalesce(nr_min_apres_local_w, nr_min_duracao_p) / 1440)),nr_seq_prof_w)
								into STRICT	ie_horario_bloq_w
								;
								
								select	max(nr_seq_atendimento),
									max(cd_estabelecimento)
								into STRICT	nr_seq_atendimento_w,
									cd_estab_pend_w
								from	paciente_Atendimento
								where	nr_seq_pend_agenda	= nr_seq_pendencia_p
								and	coalesce(dt_suspensao::text, '') = ''
								and	coalesce(dt_interrompido::text, '') = ''
								and	trunc(coalesce(dt_real, dt_prevista))	= trunc(hr_atual_w);
								
								
								
								select  coalesce(max('S'),'N')
								into STRICT 	ie_possui_bloq_regra_medic_w
								from 	qt_bloqueio_medic;
								if (ie_possui_bloq_regra_medic_w = 'S')  then
									ie_horario_bloq_w	:= Qt_Consistir_Bloq_Medic(hr_atual_w, nr_seq_atendimento_w, nr_seq_local_w, nm_usuario_p, cd_estabelecimento_w);
								end if;
							
							end if;
						end if;						

						select	max(nr_seq_grupo_quimio),
							max(ie_tipo_pend_agenda)
						into STRICT	nr_seq_grupo_quimio_w,
							ie_tipo_pend_agenda_w 
						from	agenda_integrada_item
						where	nr_sequencia = nr_seq_ageint_item_p;
																
						ie_bloq_regra_w	:= qt_se_bloq_dia_posterior(nr_seq_grupo_quimio_w,ie_tipo_pend_agenda_w,hr_atual_w);
						
						if (ie_bloq_regra_w = 'S') then
							ie_horario_bloq_w := 'S';
						end if;
						
						if (ie_horario_bloq_w = 'S') then
							ie_status_w := 'B';
						end if;

					end if;
					
					ie_status_agenda_w	:= '';
					
					if	(((to_char(hr_atual_w, 'hh24'))::numeric  > somente_numero(hr_quebra_turno_w)) or ((to_char(hr_atual_w, 'hh24'))::numeric  = somente_numero(hr_quebra_turno_w))) then
						cd_turno_w	:= 1;
					else
						cd_turno_w	:= 0;
					end if;

					if (hr_quebra_turno_not_w IS NOT NULL AND hr_quebra_turno_not_w::text <> '') and ((to_char(hr_atual_w, 'hh24'))::numeric  >= somente_numero(hr_quebra_turno_not_w)) then
						cd_turno_w	:= 3;
					end if;
					
					/*select	nvl(count(*),0)
					into	qt_registros_ag_quimio
					from	agenda_quimio
					where	nr_sequencia = nr_seq_agenda_w;*/
					
					qt_registros_ag_quimio	:= 0;
					
					select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
					into STRICT	ie_permite_w
					
					where	((hr_atual_w between coalesce(dt_vigencia_inicial_w, trunc(dt_agenda_p)) and  coalesce(dt_vigencia_final_w, fim_dia(dt_agenda_p))) or (coalesce(dt_vigencia_inicial_w::text, '') = '' and coalesce(dt_vigencia_final_w::text, '') = ''));
						
					if (qt_registros_ag_quimio = 0) and (ie_permite_w = 'S') then		

							insert into w_agenda_quimio(--nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								dt_horario,
								ie_status,
								nr_seq_local,
								nr_seq_pend_agenda,
								nr_seq_agequi,
								nr_seq_ageint_item,
								nr_seq_item_marc,
								nr_seq_paciente,
								ie_status_agenda,
								cd_turno)
							values (--w_agenda_quimio_seq.nextval,
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p, 
								hr_atual_w,
								ie_status_w, 
								nr_seq_local_w,
								nr_seq_pend_agenda_w,
								null,
								nr_seq_ageint_item_p,
								coalesce(nr_seq_ageint_item_www, nr_seq_ageint_item_w),
								nr_seq_paciente_w,
								ie_status_agenda_w,
								cd_turno_w);							

	
							/*else
							
								insert into w_agenda_quimio
								(--nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								dt_horario,
								ie_status,
								nr_seq_local, 
								nr_seq_pend_agenda,
								nr_seq_agequi,
								nr_seq_ageint_item,
								nr_seq_item_marc,
								nr_seq_paciente,
								cd_turno)
							values
								(--w_agenda_quimio_seq.nextval,
								sysdate,
								nm_usuario_p,
								sysdate, 
								nm_usuario_p, 
								dt_agenda_w,
								'EA',--ie_status_w, 
								nr_seq_local_w,
								nvl(nr_seq_pend_agenda_w, null),
								nr_seq_agenda_w,
								nr_seq_ageint_item_p,
								nr_seq_ageint_item_w,
								nr_seq_paciente_w,
								cd_turno_w);*/
						end if;
						
						end if;
					
			nr_seq_pend_agenda_marcado_w	:= null;
			nr_seq_agequi_w			:= null;
			nr_seq_agenda_w			:= null;
			hr_atual_w	:= hr_atual_w + coalesce(nr_min_apres_local_w, nr_min_duracao_p) / 1440;
			end;
		end loop;
		end;
	end loop;
	close C02;

	if (ie_possui_turno_W	= 'N') then
	
		select  min(b.hr_inicial)
		into STRICT	hr_inicial_dia_w
		from    qt_local a,
			qt_local_turno b 
		where   b.nr_seq_local = a.nr_sequencia 
		and     a.cd_estabelecimento = cd_estabelecimento_p;
		
		select  max(b.hr_final)
		into STRICT	hr_final_dia_w
		from    qt_local a, 
			qt_local_turno b 
		where   b.nr_seq_local = a.nr_sequencia 
		and     a.cd_estabelecimento = cd_estabelecimento_p;
	
		hr_inicial_dia_w	:= to_date(to_char(dt_agenda_p, 'dd/mm/yyyy') || ' ' || to_char(hr_inicial_dia_w,

'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
		hr_final_dia_w		:= to_date(to_char(dt_agenda_p, 'dd/mm/yyyy') || ' ' || to_char(hr_final_dia_w,

'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
	
		hr_inicial_truncada_w	:= to_date(to_char(dt_agenda_p, 'dd/mm/yyyy') || ' ' || to_char(hr_inicial_dia_w,

'hh24') || ':00:00','dd/mm/yyyy hh24:mi:ss');
	
		if (hr_inicial_truncada_w	<> hr_inicial_dia_w) then
			hr_atual_w	:= hr_inicial_truncada_w;
		else
			hr_atual_w	:= hr_inicial_dia_w;
		end if;
		
		while(hr_atual_w < hr_final_dia_w) loop
			begin
			
			select	count(*)
			into STRICT	qt_marcacao_w
			from	agenda_quimio_marcacao
			where	hr_atual_w between dt_agenda and dt_agenda + (nr_duracao - 1) / 1440
			and	nr_seq_local	= nr_seq_local_w;
			
			if (qt_marcacao_w	= 0) then
				select	count(*)
				into STRICT	qt_marcacao_w
				from	w_agenda_quimio
				where	dt_horario	= hr_atual_w
				and		nr_seq_local	= nr_seq_local_w
				and		((nm_usuario		= nm_usuario_p
				and (ie_status	in ('L','B','EA','I') or ie_reserva = 'S'))
				or		ie_status	in ('AG','D'));
			end if;
			if (qt_marcacao_w	= 0) then
			
				if	(((to_char(hr_atual_w, 'hh24'))::numeric  > somente_numero(hr_quebra_turno_w)) or ((to_char(hr_atual_w, 'hh24'))::numeric  = somente_numero(hr_quebra_turno_w))) then
					cd_turno_w	:= 1;
				else
					cd_turno_w	:= 0;
				end if;

				if (hr_quebra_turno_not_w IS NOT NULL AND hr_quebra_turno_not_w::text <> '') and ((to_char(hr_atual_w, 'hh24'))::numeric  >= somente_numero(hr_quebra_turno_not_w)) then
					cd_turno_w	:= 3;
				end if;
			
				if (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') then
					nr_seq_pend_agenda_w	:= null;
					nr_seq_pend_agenda_marcado_w	:= null;
				end if;

				insert into w_agenda_quimio(--nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					dt_horario,
					ie_status,
					nr_seq_local,
					nr_seq_pend_agenda,
					nr_seq_agequi,
					nr_seq_ageint_item,
					cd_turno)
				values (--w_agenda_quimio_seq.nextval,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					hr_atual_w,
					'I', 
					nr_seq_local_w,
					coalesce(coalesce(nr_seq_pend_agenda_marcado_w, nr_seq_pend_agenda_w),null),
					coalesce(nr_seq_agenda_w, nr_seq_agenda_p),
					nr_seq_ageint_item_p,
					cd_turno_w);
			end if;
			hr_atual_w	:= hr_atual_w + coalesce(nr_min_apres_local_w, nr_min_duracao_p) / 1440;
			end;
		end loop;
			
	end if;
	end;
end loop;
close C01;

open C04;
loop
fetch C04 into	
	dt_agenda_w,
	nr_minuto_duracao_w,
	nr_seq_local_w,
	nr_seq_pend_agenda_w,
	nr_seq_agenda_w,
	nr_seq_ageint_item_w,
	ie_reserva_w,
	cd_pac_agenda_w,
	nr_seq_atendimento_ww;
EXIT WHEN NOT FOUND; /* apply on C04 */
	begin
		
	if (ie_reserva_w	= 'S') and (cd_pac_agenda_w	= cd_pessoa_fisica_p) then
		update	w_agenda_quimio
		set	ie_status			= 'AG',
			nr_seq_agequi		= nr_seq_agenda_w,
			nr_seq_item_marc	= nr_seq_ageint_item_w,
			ie_reserva		= ie_reserva_w,
			nr_seq_atendimento	= nr_seq_atendimento_ww
		where	dt_horario between  dt_Agenda_w and dt_agenda_w + (nr_minuto_duracao_w - 1) / 1440
		and	nr_seq_local		= nr_seq_local_w;
	else
		update	w_agenda_quimio
		set	ie_status		= 'D',
			nr_seq_pend_agenda	= nr_seq_pend_Agenda_w,
			nr_seq_agequi		= nr_seq_agenda_w,
			nr_seq_item_marc	= nr_seq_ageint_item_w,
			ie_reserva		= ie_reserva_w,
			nr_seq_atendimento	= nr_seq_atendimento_ww
		where	dt_horario between  dt_Agenda_w and dt_agenda_w + (nr_minuto_duracao_w - 1) / 1440
		and	nr_seq_local		= nr_seq_local_w
		and	nr_Seq_agequi		<> nr_seq_agenda_W
		and	ie_status		= 'AG';
		
		commit;
		
		select max(ie_status_agenda)
		into STRICT ie_status_agenda_w
		from agenda_quimio
		where nr_sequencia = nr_seq_agenda_w 
		and nm_usuario = nm_usuario_p 
		and nr_seq_local = nr_seq_local_w
		and trunc(dt_agenda) = trunc(dt_agenda_p);
		
		update	w_agenda_quimio
		set	ie_status		= 'AG',
			nr_seq_pend_agenda	= nr_seq_pend_Agenda_w,
			nr_seq_agequi		= nr_seq_agenda_w,
			nr_seq_item_marc	= nr_seq_ageint_item_w,
			ie_reserva		= ie_reserva_w,
			nr_seq_atendimento	= nr_seq_atendimento_ww,
			ie_status_agenda        = ie_status_agenda_w
		where	dt_horario between  dt_Agenda_w and dt_agenda_w + (nr_minuto_duracao_w - 1) / 1440
		and	nr_seq_local		= nr_seq_local_w
		and	ie_status		= 'L';
		
	end if;
	end;
end loop;
close C04;

open C05;
loop
fetch C05 into	
	dt_agenda_w,
	nr_minuto_duracao_w,
	nr_seq_local_w,
	nr_seq_pend_agenda_w,
	nr_seq_agenda_w,
	nr_seq_ageint_item_w,
	nr_seq_atendimento_ww;
EXIT WHEN NOT FOUND; /* apply on C05 */
	begin
	
	select coalesce(max('S'),'N')
	into STRICT ie_existe_agenda_w
	from agenda_quimio x
	where x.nr_sequencia = nr_seq_agenda_w;

	update	w_agenda_quimio
	set		ie_status		= 'EA',
			nr_seq_pend_agenda	= nr_seq_pend_Agenda_w,
			nr_seq_agequi		= CASE WHEN ie_existe_agenda_w='S' THEN  nr_seq_agenda_w  ELSE null END ,
			nr_seq_item_marc	= nr_seq_ageint_item_w,
			nr_seq_atendimento	= nr_seq_atendimento_ww
	where	dt_horario between  dt_Agenda_w and dt_agenda_w + (nr_minuto_duracao_w - 1) / 1440
	and	nr_seq_local		= nr_seq_local_w;
	end;
end loop;
close C05;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qt_gerar_horario ( nr_seq_pendencia_p bigint, nr_seq_agenda_p bigint, dt_agenda_p timestamp, nm_usuario_p text, nr_min_duracao_p bigint, cd_pessoa_fisica_p text, nr_seq_grupo_quimio_p bigint default null, cd_estabelecimento_p bigint default null, nr_seq_local_p bigint default null, nr_seq_ageint_item_p bigint default null, nr_seq_prof_p bigint default null, ds_locais_p text default null) FROM PUBLIC;

