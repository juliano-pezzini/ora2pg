-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_conta_movto_estoque ( CD_ESTABELECIMENTO_P bigint, DT_MESANO_REFERENCIA_P timestamp, IE_TIPO_CONTA_P text, NM_USUARIO_P text) AS $body$
DECLARE


DT_ATUALIZACAO_W			timestamp 				:= clock_timestamp();
IE_ORIGEM_PROCED_W      		bigint    		:= 0;
CD_CONTA_CONTABIL_W        		varchar(20);
NR_MOVIMENTO_ESTOQUE_W		bigint   		:= 0;
CD_PROCEDIMENTO_W			bigint   		:= 0;
CD_MATERIAL_W				bigint   		:= 0;
CD_CENTRO_CUSTO_W			bigint   		:= 0;
ie_clinica_w				integer;
cd_local_estoque_w			smallint		:= Null;
dt_movimento_estoque_w		timestamp;


/* Selecao do movimento de estoque de requisição e de prescrição */

C01 CURSOR FOR
SELECT	a.nr_movimento_estoque,
	a.dt_movimento_estoque,
	a.cd_material
from	movimento_estoque a
where	a.dt_mesano_referencia = dt_mesano_referencia_p
and	a.ie_origem_documento in (2,3);


BEGIN
/* Atualizar conta despesa dos materiais */

	begin
	OPEN C01;
	LOOP
   		FETCH C01 into
			nr_movimento_estoque_w,
			dt_movimento_estoque_w,
			cd_material_w;
    		if 	C01%FOUND then
			BEGIN
			/* Obter contas do material */

			begin
			SELECT * FROM Define_Conta_Material(
				CD_ESTABELECIMENTO_P, CD_MATERIAL_W, IE_TIPO_CONTA_P, ie_clinica_w, 0, '0', 0, null, null, null, cd_local_estoque_w, Null, dt_movimento_estoque_w, CD_CONTA_CONTABIL_W, CD_CENTRO_CUSTO_W, '') INTO STRICT CD_CONTA_CONTABIL_W, CD_CENTRO_CUSTO_W;
			end;
			/* Atualizar o movimento_estoque */

			begin
			if ie_tipo_conta_p		= 2 then
				begin
				UPDATE MOVIMENTO_ESTOQUE
				SET 	CD_CONTA		= CD_CONTA_CONTABIL_W
				WHERE NR_MOVIMENTO_ESTOQUE	= NR_MOVIMENTO_ESTOQUE_W;
				end;
			else
				begin
				UPDATE MOVIMENTO_ESTOQUE
				SET 	CD_CONTA_CONTABIL	= CD_CONTA_CONTABIL_W
				WHERE NR_MOVIMENTO_ESTOQUE	= NR_MOVIMENTO_ESTOQUE_W;
				end;
			end if;
			end;
			COMMIT;
			END;
    		else
       			exit;
    		end if;
	END LOOP;
	CLOSE C01;
	end;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_conta_movto_estoque ( CD_ESTABELECIMENTO_P bigint, DT_MESANO_REFERENCIA_P timestamp, IE_TIPO_CONTA_P text, NM_USUARIO_P text) FROM PUBLIC;

