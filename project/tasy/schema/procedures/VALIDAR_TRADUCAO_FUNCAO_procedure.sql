-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE validar_traducao_funcao ( cd_funcao_p bigint, nm_usuario_p text, nr_seq_idioma_p bigint) is /*

7	Alemão (DE)	de_DE
6	Inglês (UK)	en_GB
3	Espanhol (CO)	es_CO
1	Português (BR)	pt_BR
2	Espanhol (MX)	es_MX
5	Inglês (US)	en_US
4	Espanhol (AR)	es_AR
8	Árabe (SA)	ar_SA

*/
 ds_expressao_de_w varchar(4000) RETURNS varchar AS $body$
DECLARE

	ds_lang_w	varchar(20);

	ds_retorno_w	varchar(4000);
	
BEGIN

		if (nr_seq_idioma_w	= 2) then
			ds_lang_w	:=	'es';
		elsif (nr_seq_idioma_w	= 5) then
			ds_lang_w	:=	'en';
		elsif (nr_seq_idioma_w	= 6) then
			ds_lang_w	:=	'ar';
		elsif (nr_seq_idioma_w	= 7) then
			ds_lang_w	:=	'de';
		end if;

		select	max(ds_expressao)
		into STRICT	ds_retorno_w
		from	dic_expressao_idioma
		where	cd_expressao = cd_expressao_p
		and	DS_IDIOMA	= ds_lang_w;

		return ds_retorno_w;

	end;


begin
nr_seq_idioma_w := coalesce(nr_seq_idioma_p, -1);

if (nr_seq_idioma_w not in (2, 5, 6, 7)) then

	select	SUBSTR(obter_desc_expressao(CD_EXP_IDIOMA,DS_IDIOMA),1,80)
	into STRICT	ds_idioma_w
	from	tasy_idioma
	where	nr_sequencia = nr_seq_idioma_w;

	--Ra ise_application_error(-20011, 'Validation of the translation to the ' || ds_idioma_w || ' language is not possible yet!');
end if;

delete	FROM inconsistencia_traducao
where	nm_usuario = nm_usuario_p;

-- procura schematic ativo
select	max(nr_sequencia)
into STRICT	nr_seq_funcao_schematic_w
from	funcao_schematic
where	cd_funcao = cd_funcao_p
and	coalesce(ie_situacao_funcao, 'I') = 'A';

if (coalesce(nr_seq_funcao_schematic_w::text, '') = '') then
	-- se não houver schematic ativo, procura um que esteja em desenvolvimento
	select	max(nr_sequencia)
	into STRICT	nr_seq_funcao_schematic_w
	from	funcao_schematic
	where	cd_funcao = cd_funcao_p
	and	coalesce(ie_situacao_funcao, 'I') = 'D';
end if;

-- itens da função não vinculados ao schematic
open C03;
loop
fetch C03 into
	c03_w;
EXIT WHEN NOT FOUND; /* apply on C03 */

	ds_expressao_de_w := obterExpressaoIdioma(c03_w.cd_exp_label,nr_seq_idioma_w);


	if (coalesce(ds_expressao_de_w::text, '') = '') and
		((coalesce(ds_expressao_de_w::text, '') = '') or (coalesce(c03_w.cd_exp_label::text, '') = '')) and
		((c03_w.ds_label IS NOT NULL AND c03_w.ds_label::text <> '') or (c03_w.cd_exp_label IS NOT NULL AND c03_w.cd_exp_label::text <> '')) then

		if (c03_w.cd_exp_label IS NOT NULL AND c03_w.cd_exp_label::text <> '') then
			ds_texto_fixo_w := null;
		else
			ds_texto_fixo_w := c03_w.ds_label;
		end if;

		select	max(nr_sequencia)
		into STRICT	nr_seq_inconsistencia_igual_w
		from	inconsistencia_traducao
		where	cd_expressao = c03_w.cd_exp_label;

		if (coalesce(nr_seq_inconsistencia_igual_w::text, '') = '') then

			select	nextval('inconsistencia_traducao_seq')
			into STRICT	nr_inconsistencia_traducao_w
			;

			insert into inconsistencia_traducao(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nr_seq_funcao_schematic,
				nr_seq_objeto_schematic,
				nr_seq_dic_objeto,
				nm_tabela,
				nm_atributo,
				nr_seq_visao,
				ie_tipo_componente,
				cd_expressao,
				ds_label,
				cd_funcao,
				nr_seq_idioma)
			values (nr_inconsistencia_traducao_w,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_funcao_schematic_w,
				null,
				null,
				null,
				c03_w.nm_atributo,
				null,
				'FUNCTION',
				c03_w.cd_exp_label,
				ds_texto_fixo_w,
				cd_funcao_p,
				nr_seq_idioma_w);
		end if;

	end if;

end loop;
close C03;


ds_expressao_de_w := null;
open C01;
loop
fetch C01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

	open C02;
	loop
	fetch C02 into
		c02_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */

		ds_expressao_de_w := obterExpressaoIdioma(c02_w.cd_exp_label,nr_seq_idioma_w);

		if (coalesce(ds_expressao_de_w::text, '') = '') and
			((coalesce(ds_expressao_de_w::text, '') = '') or (coalesce(c02_w.cd_exp_label::text, '') = '')) and
			((c02_w.ds_label IS NOT NULL AND c02_w.ds_label::text <> '') or (c02_w.cd_exp_label IS NOT NULL AND c02_w.cd_exp_label::text <> '')) then

			if (c02_w.cd_exp_label IS NOT NULL AND c02_w.cd_exp_label::text <> '') then
				ds_texto_fixo_w := null;
			else
				ds_texto_fixo_w := c02_w.ds_label;
			end if;

			select	max(nr_sequencia)
			into STRICT	nr_seq_inconsistencia_igual_w
			from	inconsistencia_traducao
			where	cd_expressao = c02_w.cd_exp_label;

			if (coalesce(nr_seq_inconsistencia_igual_w::text, '') = '') then

				select	nextval('inconsistencia_traducao_seq')
				into STRICT	nr_inconsistencia_traducao_w
				;

				insert into inconsistencia_traducao(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_funcao_schematic,
					nr_seq_objeto_schematic,
					nr_seq_dic_objeto,
					nm_tabela,
					nm_atributo,
					nr_seq_visao,
					ie_tipo_componente,
					cd_expressao,
					ds_label,
					cd_funcao,
					nr_seq_idioma)
				values (nr_inconsistencia_traducao_w,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_funcao_schematic_w,
					c01_w.nr_sequencia,
					c01_w.nr_seq_dic_objeto,
					c01_w.nm_tabela,
					c02_w.nm_atributo,
					c01_w.nr_seq_visao,
					c01_w.ie_tipo_componente,
					c02_w.cd_exp_label,
					ds_texto_fixo_w,
					cd_funcao_p,
					nr_seq_idioma_w);
			end if;
		end if;
	end loop;
	close C02;

end loop;
close C01;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE validar_traducao_funcao ( cd_funcao_p bigint, nm_usuario_p text, nr_seq_idioma_p bigint) is  ds_expressao_de_w varchar(4000) FROM PUBLIC;

