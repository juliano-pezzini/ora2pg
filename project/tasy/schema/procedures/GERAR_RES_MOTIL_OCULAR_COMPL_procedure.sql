-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_res_motil_ocular_compl (cd_estabelecimento_p bigint, nr_seq_consulta_p bigint, cd_pessoa_fisica_p text, ie_mostra_todos_p text, nr_seq_item_p bigint, nm_usuario_p text) AS $body$
DECLARE



nm_profissional_w	varchar(255);
ds_espaco_20_w		varchar(255) 	:= lpad(' ',1,' ');
ds_enter_w		varchar(30)	:= chr(13) || chr(10);	
ds_observacao_w		varchar(1000);
dt_registro_w		varchar(30);
ds_motilidade_ocupar_w	varchar(32000);
rot_binoculares_esq_w	varchar(2000);
outras_medidas_w1	varchar(2000);
ds_d2_w			varchar(2000);
ds_d3_w			varchar(2000);
vl_od_sup_esq_w		smallint;
vl_od_sup_dir_w		smallint;
vl_od_centro_esq_w	smallint;
vl_od_centro_dir_w	smallint;
vl_od_inferior_esq_w	smallint;
vl_od_inferior_dir_w	smallint;
vl_oe_sup_esq_w		smallint;
vl_oe_sup_dir_w		smallint;
vl_oe_centro_esq_w	smallint;
vl_oe_centro_dir_w	smallint;
vl_oe_inferior_esq_w	smallint;
vl_oe_inferior_dir_w	smallint;
ie_med_estrab_di_w	varchar(30);
ie_med_estrab_sv_w	varchar(30);
ie_med_estrab_li_w	varchar(30);
ie_med_estrab_dv_w	varchar(30);
ie_med_estrab_oh_w	varchar(30);
ie_med_estrab_lv_w	varchar(30);
ie_med_estrab_in_w	varchar(30);

expressao1_w	varchar(255) := obter_desc_expressao_idioma(774095, null, wheb_usuario_pck.get_nr_seq_idioma);--Visualização não disponível, favor consultar o item no Prontuário.
expressao2_w	varchar(255) := obter_desc_expressao_idioma(327202, null, wheb_usuario_pck.get_nr_seq_idioma);--data:
expressao3_w	varchar(255) := obter_desc_expressao_idioma(728918, null, wheb_usuario_pck.get_nr_seq_idioma);--PROFISSIONAL:
expressao4_w	varchar(255) := obter_desc_expressao_idioma(297932, null, wheb_usuario_pck.get_nr_seq_idioma);--Rotações binoculares
expressao5_w	varchar(255) := obter_desc_expressao_idioma(295051, null, wheb_usuario_pck.get_nr_seq_idioma);--Outras medidas
C01 CURSOR FOR
SELECT 	obter_nome_pf(cd_profissional) nm_profissional,
	TO_CHAR(dt_exame,'dd/mm/yyyy hh24:mi:ss'),
	vl_od_sup_esq,
	vl_od_sup_dir,
	vl_od_centro_esq,
	vl_od_centro_dir,
	vl_od_inferior_esq,
	vl_od_inferior_dir,
	vl_oe_sup_esq,
	vl_oe_sup_dir,
	vl_oe_centro_esq,
	vl_oe_centro_dir,
	vl_oe_inferior_esq,
	vl_oe_inferior_dir,
	ie_med_estrab_di,
	ie_med_estrab_sv,
	ie_med_estrab_li,
	ie_med_estrab_dv,
	ie_med_estrab_oh,
	ie_med_estrab_lv,
	ie_med_estrab_in
FROM	oft_motilidade_ocular
WHERE 	((nr_seq_consulta = nr_seq_consulta_p) OR ((ie_mostra_todos_p = 'S') AND nr_seq_consulta IN (SELECT c.nr_sequencia
                                    	 	 	   FROM  atendimento_paciente b, 
                                       				   oft_consulta c 
                                    				   WHERE  c.nr_atendimento = b.nr_atendimento 
                                    			   AND  b.cd_pessoa_fisica = cd_pessoa_fisica_p)))
AND	coalesce(ie_situacao,'A') = 'A'
ORDER  BY dt_exame desc;


BEGIN
	
open C01;
loop
fetch C01 into
	nm_profissional_w,
	dt_registro_w,
	vl_od_sup_esq_w,
	vl_od_sup_dir_w,
	vl_od_centro_esq_w,
	vl_od_centro_dir_w,
	vl_od_inferior_esq_w,
	vl_od_inferior_dir_w,
	vl_oe_sup_esq_w,
	vl_oe_sup_dir_w,
	vl_oe_centro_esq_w,
	vl_oe_centro_dir_w,
	vl_oe_inferior_esq_w,
	vl_oe_inferior_dir_w,
	ie_med_estrab_di_w,
	ie_med_estrab_sv_w,
	ie_med_estrab_li_w,
	ie_med_estrab_dv_w,
	ie_med_estrab_oh_w,
	ie_med_estrab_lv_w,
	ie_med_estrab_in_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	outras_medidas_w1 := '';
	rot_binoculares_esq_w := '';
	
	
	if ((vl_od_centro_esq_w IS NOT NULL AND vl_od_centro_esq_w::text <> '') and (vl_od_sup_esq_w IS NOT NULL AND vl_od_sup_esq_w::text <> '') and (vl_od_sup_dir_w IS NOT NULL AND vl_od_sup_dir_w::text <> '') and (vl_oe_sup_esq_w IS NOT NULL AND vl_oe_sup_esq_w::text <> '') and (vl_oe_sup_dir_w IS NOT NULL AND vl_oe_sup_dir_w::text <> '') and (vl_od_centro_dir_w IS NOT NULL AND vl_od_centro_dir_w::text <> '') and (vl_oe_centro_esq_w IS NOT NULL AND vl_oe_centro_esq_w::text <> '') and (vl_oe_centro_dir_w IS NOT NULL AND vl_oe_centro_dir_w::text <> '') and (vl_od_inferior_esq_w IS NOT NULL AND vl_od_inferior_esq_w::text <> '') and (vl_od_inferior_dir_w IS NOT NULL AND vl_od_inferior_dir_w::text <> '') and (vl_oe_inferior_esq_w IS NOT NULL AND vl_oe_inferior_esq_w::text <> '') and (vl_oe_inferior_dir_w IS NOT NULL AND vl_oe_inferior_dir_w::text <> '')) then
		rot_binoculares_esq_w :=  lpad(vl_od_sup_esq_w,11,' ')||' '||lpad(vl_od_sup_dir_w,6,' ')||'  '||lpad(vl_oe_sup_esq_w,12,' ')||' '||lpad(vl_oe_sup_dir_w,6,' ')||ds_enter_w||
			' 	  \   / 	     \   /'||ds_enter_w||	
			'  	  \  /         \  /'||ds_enter_w||
			'  	   \ /	      \ /'||ds_enter_w||	
			' '||lpad(vl_od_centro_esq_w,8,' ')||' ======='||lpad(vl_od_centro_dir_w,4,' ')||' '||lpad(vl_oe_centro_esq_w,11,' ')||' ======='||lpad(vl_oe_centro_dir_w,4,' ')||ds_enter_w ||
			'	   / \		  / \ ' ||ds_enter_w ||
			'  	  /  \ 		  /  \ ' ||ds_enter_w || 
			' 	  /   \		 /   \ ' ||ds_enter_w|| 	
			lpad(vl_od_inferior_esq_w,11,' ')||' '||lpad(vl_od_inferior_dir_w,6,' ')||'  '||lpad(vl_oe_inferior_esq_w,12,' ')||' '||lpad(vl_oe_inferior_dir_w,6,' ') ||ds_enter_w;
	else
		rot_binoculares_esq_w	:=	ds_enter_w || expressao1_w || ds_enter_w;
		
	
	end if;
	
	if ((ie_med_estrab_di_w IS NOT NULL AND ie_med_estrab_di_w::text <> '') and (ie_med_estrab_sv_w IS NOT NULL AND ie_med_estrab_sv_w::text <> '') and (ie_med_estrab_li_w IS NOT NULL AND ie_med_estrab_li_w::text <> '') and (ie_med_estrab_dv_w IS NOT NULL AND ie_med_estrab_dv_w::text <> '') and (ie_med_estrab_oh_w IS NOT NULL AND ie_med_estrab_oh_w::text <> '') and (ie_med_estrab_lv_w IS NOT NULL AND ie_med_estrab_lv_w::text <> '') and (ie_med_estrab_in_w IS NOT NULL AND ie_med_estrab_in_w::text <> '')) then			
		outras_medidas_w1 := lpad(substr(ie_med_estrab_di_w,1,4),10,' ') ||' '||lpad(substr(ie_med_estrab_sv_w,1,4),6,' ')||' '||lpad(substr(ie_med_estrab_li_w,1,4),6,' ')||ds_enter_w||
			'     \   |  / '||ds_enter_w||
			'	  \  |  / '||ds_enter_w||
			''||lpad(substr(ie_med_estrab_dv_w,1,4),10,' ') ||' =='||lpad(substr(ie_med_estrab_oh_w,1,4),4,' ')||' =='||lpad(substr(ie_med_estrab_lv_w,1,4),4,' ')||ds_enter_w||
			'        |   '||ds_enter_w||
			'        |   '||ds_enter_w||
			lpad(substr(ie_med_estrab_in_w,1,4),17,' ') ||ds_enter_w;
	else
		outras_medidas_w1	:=	' ' || expressao1_w || ds_enter_w ||ds_enter_w;
	end if;
		
								
	ds_motilidade_ocupar_w	:=	'';
	ds_motilidade_ocupar_w	:= 	expressao2_w || ' ' || dt_registro_w || ds_espaco_20_w ||
					expressao3_w || ' ' ||nm_profissional_w || ds_enter_w||ds_enter_w||
					expressao4_w || ': '||ds_enter_w||ds_enter_w||			
					rot_binoculares_esq_w ||ds_enter_w||ds_enter_w||
					expressao5_w || ': ' ||ds_enter_w||ds_enter_w||outras_medidas_w1;
					
	CALL gravar_registro_resumo_oft(ds_motilidade_ocupar_w,nr_seq_item_p,nm_usuario_p,to_date(dt_registro_w,'dd/mm/yyyy hh24:mi:ss'));
	
	end;
end loop;
close C01;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_res_motil_ocular_compl (cd_estabelecimento_p bigint, nr_seq_consulta_p bigint, cd_pessoa_fisica_p text, ie_mostra_todos_p text, nr_seq_item_p bigint, nm_usuario_p text) FROM PUBLIC;

