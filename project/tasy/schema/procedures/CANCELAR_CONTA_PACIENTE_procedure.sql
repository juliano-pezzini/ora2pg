-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cancelar_conta_paciente ( nr_interno_conta_p bigint, nm_usuario_p text, ie_excluir_baixa_titulo_p text, ie_cancel_conta_dest_p text default null, nr_seq_conta_origem_p bigint default null) AS $body$
DECLARE


nr_sequencia_w		bigint;
nr_seq_protocolo_w		bigint;
vl_nf_w			double precision;
vl_titulo_w			double precision := 0;
vl_retornos_w			double precision := 0;
dt_atualizacao_estoque_w	timestamp;

nr_seq_conta_des_w		conta_paciente.nr_interno_conta%type;
ie_status_conta_des_w		conta_paciente.ie_status_acerto%type;
nr_conta_nova_w			conta_paciente.nr_interno_conta%type;
nr_seq_prot_ret_w		protocolo_convenio.nr_seq_protocolo%type;
ie_cancela_titulo_w     	varchar(15);
cd_estab_usuario_w	        smallint;
cd_convenio_parametro_w         conta_paciente.cd_convenio_parametro%type;
ie_tipo_atendimento_w           atendimento_paciente.ie_tipo_atendimento%type;

c01 CURSOR FOR
SELECT	nr_sequencia,
	dt_atualizacao_estoque
from	nota_fiscal
where	nr_interno_conta = nr_interno_conta_p
and	ie_situacao in ('1','8');


BEGIN

begin
cd_estab_usuario_w := wheb_usuario_pck.get_cd_estabelecimento;
exception
when others then
	cd_estab_usuario_w := 0;
end;

ie_cancela_titulo_w := coalesce(obter_valor_param_usuario(1123,253,obter_perfil_ativo,nm_usuario_p,cd_estab_usuario_w),'S');

select	coalesce(sum(vl_pago), 0) +
	coalesce(sum(VL_DESCONTO), 0) +
	coalesce(sum(VL_GLOSADO), 0) +
	coalesce(sum(VL_PERDAS), 0)/* Francisco - OS 186247 - 22/12/2009 - Antes considerava na soma todos os valores
				 Alterei para considerar somente os valores que influenciam no saldo /lancam baixas	*/
into STRICT	vl_retornos_w
from	convenio c,
	convenio_retorno b,
	convenio_retorno_item a
where	a.nr_seq_retorno	= b.nr_sequencia
and	b.cd_convenio		= c.cd_convenio
and	c.ie_tipo_convenio	<> 3 /* Francisco - OS 157151 - 06/10/2009 - Deixar cancelar contas com retorno SUS */
and	a.nr_interno_conta 	= nr_interno_conta_p;

if (vl_retornos_w = 0) then
	select	coalesce(max(c.nr_seq_protocolo),0),
                c.cd_convenio_parametro,
                a.ie_tipo_atendimento
	into STRICT	nr_seq_protocolo_w,
                cd_convenio_parametro_w,
                ie_tipo_atendimento_w
	from	conta_paciente c,
                atendimento_paciente a
	where	c.nr_atendimento = a.nr_atendimento
        and     nr_interno_conta = nr_interno_conta_p
        group by        c.cd_convenio_parametro,
                        a.ie_tipo_atendimento;
	
	if (coalesce(ie_cancel_conta_dest_p,'S') = 'S') then

		open C01;
		loop
		fetch C01 into
			nr_sequencia_w,
			dt_atualizacao_estoque_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin

			select	coalesce(max(vl_total_nota),0)
			into STRICT	vl_nf_w
			from	nota_fiscal
			where	nr_sequencia	= nr_sequencia_w
			and	nr_interno_conta = nr_interno_conta_p;

			if (dt_atualizacao_estoque_w IS NOT NULL AND dt_atualizacao_estoque_w::text <> '') then
				CALL estornar_nota_fiscal(nr_sequencia_w,nm_usuario_p,'N');

			else

				update	nota_fiscal
				set	ie_situacao 		= 9,
					nr_seq_exportada	 = NULL,
					ie_status_envio		 = NULL,
					nm_usuario		= nm_usuario_p,
					dt_atualizacao		= clock_timestamp()
				where	nr_sequencia 		= nr_sequencia_w;

				update	nf_credito
				set	ie_situacao 		= 9,
					nm_usuario		= nm_usuario_p,
					dt_atualizacao		= clock_timestamp()
				where	nr_seq_nf_orig 		= nr_sequencia_w
				and 	coalesce(nr_seq_nf_gerada::text, '') = '';

			end if;

			end;
		end loop;
		close C01;		
		
		if (ie_cancela_titulo_w = 'S') or (ie_tipo_atendimento_w <> 1) or (obter_tipo_convenio(cd_convenio_parametro_w) <> 3) then
                        CALL Cancelar_Titulo_Conta(nr_interno_conta_p, nr_seq_protocolo_w, nm_usuario_p, ie_excluir_baixa_titulo_p);
                end if;
	end if;

	/* Francisco - OS 70878 - 09/10/2007 - Se a conta e cancelada o vinculo com adiantamento deve ser excluido */

	delete 	from conta_paciente_adiant
	where	nr_interno_conta	= nr_interno_conta_p;

	CALL Estornar_Conta_Paciente(nr_interno_conta_p, nm_usuario_p, ie_cancel_conta_dest_p,nr_seq_conta_origem_p);

	/*Verificar se a conta particular esta fechada*/

	select	max(nr_seq_conta_des)
	into STRICT	nr_seq_conta_des_w
	from	conta_pac_deducao_conv
	where	nr_seq_conta_orig = nr_interno_conta_p;

	if (coalesce(nr_seq_conta_des_w,0) > 0) then

		select	max(ie_status_acerto)
		into STRICT	ie_status_conta_des_w
		from	conta_paciente
		where	nr_interno_conta = nr_seq_conta_des_w;

		if (ie_status_conta_des_w = 2) then			
			/* Esse cancelamento e diferente - Dentro da estornar_conta_paciente, esta tratado para gerar apenas a negativa, sem IE_CANCELAMENTO */

			CALL Cancelar_Conta_Paciente(nr_seq_conta_des_w, nm_usuario_p, 'N', 'N',nr_interno_conta_p);

			/* Isto e para excluir a conta positiva, que vai estar sem itens */

			delete from conta_paciente a
			where 	a.nr_seq_conta_origem = nr_seq_conta_des_w
			and 	not exists (SELECT	1
							from	procedimento_paciente x
							where	x.nr_interno_conta = a.nr_interno_conta
							
union all

							SELECT	1
							from	material_atend_paciente x
							where	x.nr_interno_conta = a.nr_interno_conta);

			select	max(nr_interno_conta)
			into STRICT	nr_conta_nova_w
			from	conta_paciente a
			where	a.nr_seq_conta_origem = nr_seq_conta_des_w;

			/* Como por padrao a conta vem fechada, feito esse tratamento para abrir a conta negativa gerada */

			if (nr_conta_nova_w IS NOT NULL AND nr_conta_nova_w::text <> '') then
				nr_seq_prot_ret_w := Abrir_conta_paciente(nr_conta_nova_w, nm_usuario_p, 'N', nr_seq_prot_ret_w);
			end if;
		end if;

	end if;

	commit;

else

	CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(235128);

end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cancelar_conta_paciente ( nr_interno_conta_p bigint, nm_usuario_p text, ie_excluir_baixa_titulo_p text, ie_cancel_conta_dest_p text default null, nr_seq_conta_origem_p bigint default null) FROM PUBLIC;

