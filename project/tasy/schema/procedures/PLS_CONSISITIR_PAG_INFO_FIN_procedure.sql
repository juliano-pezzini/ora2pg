-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consisitir_pag_info_fin ( nr_seq_pagador_fin_p bigint, nr_seq_contrato_p bigint, cd_condicacao_pag_p text, cd_tipo_portador_p text, cd_portador_p text, nr_seq_conta_banco_p text, dt_fim_vigencia_p text, nr_seq_forma_cobranca_p bigint, cd_banco_p bigint, cd_agencia_bancaria_p text, cd_conta_p text, nr_seq_empresa_p bigint, cd_matricula_p text, nr_seq_carteira_cobr_p bigint, ie_geracao_nota_titulo_p text, cd_pagador_pf_p text, nr_seq_classif_itens_p bigint, nr_seq_regra_port_p INOUT bigint, ds_erro_p INOUT text) AS $body$
DECLARE


ds_erro_w		varchar(4000);
nr_seq_regra_port_w	bigint;
ie_tipo_contratacao_w	varchar(3)	:= null;
dt_fim_vigencia_w	timestamp;
nr_seq_plano_w		bigint;


BEGIN

ds_erro_w := '';
nr_seq_regra_port_w := 0;

if (coalesce(cd_condicacao_pag_p::text, '') = '') then
	ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(280218);
end if;

if (coalesce(cd_tipo_portador_p::text, '') = '') then
	ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(280221);
end if;

if (coalesce(cd_portador_p::text, '') = '') then
	ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(280222);
end if;

if (coalesce(nr_seq_conta_banco_p::text, '') = '') and (cd_tipo_portador_p = 1) then
	ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(280223);
end if;

if (dt_fim_vigencia_p IS NOT NULL AND dt_fim_vigencia_p::text <> '') then
	select	max(dt_fim_vigencia)
	into STRICT	dt_fim_vigencia_w
	from	pls_contrato_pagador_fin
	where	nr_sequencia	= nr_seq_pagador_fin_p;

	if (coalesce(dt_fim_vigencia_w::text, '') = '') then
		ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(280284);
	end if;
end if;

if (nr_seq_forma_cobranca_p = 2) then
	if (coalesce(cd_banco_p::text, '') = '') then
		ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(280285);
	end if;

	if (coalesce(cd_agencia_bancaria_p::text, '') = '') then
		ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(280287);
	end if;

	if (coalesce(cd_conta_p::text, '') = '') then
		ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(280289);
	end if;
end if;

if (nr_seq_forma_cobranca_p = 4) then
	if (coalesce(nr_seq_empresa_p::text, '') = '') then
		ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(280290);
	end if;

	if (coalesce(cd_matricula_p::text, '') = '') then
		ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(280291);
	end if;
end if;

if (nr_seq_contrato_p IS NOT NULL AND nr_seq_contrato_p::text <> '') then
	select	CASE WHEN coalesce(cd_pf_estipulante::text, '') = '' THEN 'C'  ELSE 'I' END
	into STRICT	ie_tipo_contratacao_w
	from	pls_contrato
	where	nr_sequencia	= nr_seq_contrato_p;
end if;

begin
select 	max(nr_seq_plano)
into STRICT 	nr_seq_plano_w
from 	pls_contrato_plano
where 	nr_seq_contrato = nr_seq_contrato_p
and	clock_timestamp()	between pls_util_pck.obter_dt_vigencia_null(dt_inicio_vigencia,'I') and pls_util_pck.obter_dt_vigencia_null(dt_fim_vigencia,'F')
and 	ie_situacao 	= 'A';

select	max(a.nr_sequencia)
into STRICT	nr_seq_regra_port_w
from	pls_regra_portador_mens a
where (coalesce(a.nr_seq_forma_cobranca,0) = coalesce( nr_seq_forma_cobranca_p,0) or (coalesce(a.nr_seq_forma_cobranca::text, '') = ''))
and	coalesce(a.cd_banco,0) = coalesce(cd_banco_p,0)
and (coalesce(a.dt_fim_vigencia::text, '') = '' or a.dt_fim_vigencia >= clock_timestamp())
and (a.ie_tipo_contratacao = ie_tipo_contratacao_w or a.ie_tipo_contratacao = 'T')
and (a.nr_seq_classif_itens = nr_seq_classif_itens_p or coalesce(a.nr_seq_classif_itens::text, '') = '')
and	((exists (	SELECT	1
				from	pls_regra_portador_plano x
				where	x.nr_seq_regra	= a.nr_sequencia
				and	x.nr_seq_plano	= nr_seq_plano_w))
	or (not exists ( 	SELECT	1
				from	pls_regra_portador_plano x
				where	x.nr_seq_regra	= a.nr_sequencia)))
order by 1;
exception
when others then
	nr_seq_regra_port_w := 0;
end;

ds_erro_p := substr(ds_erro_w,1,255);
nr_seq_regra_port_p:= coalesce(nr_seq_regra_port_w,0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consisitir_pag_info_fin ( nr_seq_pagador_fin_p bigint, nr_seq_contrato_p bigint, cd_condicacao_pag_p text, cd_tipo_portador_p text, cd_portador_p text, nr_seq_conta_banco_p text, dt_fim_vigencia_p text, nr_seq_forma_cobranca_p bigint, cd_banco_p bigint, cd_agencia_bancaria_p text, cd_conta_p text, nr_seq_empresa_p bigint, cd_matricula_p text, nr_seq_carteira_cobr_p bigint, ie_geracao_nota_titulo_p text, cd_pagador_pf_p text, nr_seq_classif_itens_p bigint, nr_seq_regra_port_p INOUT bigint, ds_erro_p INOUT text) FROM PUBLIC;

