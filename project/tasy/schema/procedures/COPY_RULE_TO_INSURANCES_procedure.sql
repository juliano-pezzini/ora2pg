-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copy_rule_to_insurances ( cd_convenio_dest_p text, cd_convenio_orig_p bigint, cd_tipo_acomodacao_p bigint, nm_usuario_p text) AS $body$
DECLARE


 cd_procedimento_w		tipo_acomod_convenio.cd_procedimento%type;
 ie_origem_proced_w		tipo_acomod_convenio.ie_origem_proced%type;
 cd_procedimento_acomp_w	tipo_acomod_convenio.cd_procedimento_acomp%type;
 ie_origem_proced_acomp_w	tipo_acomod_convenio.ie_origem_proced_acomp%type;
 qt_dia_inicio_w		tipo_acomod_convenio.qt_dia_inicio%type;
 qt_dia_fim_w			tipo_acomod_convenio.qt_dia_fim%type;
 ie_clinica_w			tipo_acomod_convenio.ie_clinica%type;
 ie_tipo_dia_internacao_w	tipo_acomod_convenio.ie_tipo_dia_internacao%type;
 cd_setor_atendimento_w		tipo_acomod_convenio.cd_setor_atendimento%type;
 ie_carater_internacao_w	tipo_acomod_convenio.ie_carater_internacao%type;
 nr_seq_classificacao_w		tipo_acomod_convenio.nr_seq_classificacao%type;
 cd_categoria_w			tipo_acomod_convenio.cd_categoria%type;
 ie_paciente_isolado_w		tipo_acomod_convenio.ie_paciente_isolado%type;
 ie_gerar_primeiro_dia_w	tipo_acomod_convenio.ie_gerar_primeiro_dia%type;
 ie_origem_proc_conv_w		tipo_acomod_convenio.ie_origem_proc_conv%type;
 nr_seq_proced_int_w		tipo_acomod_convenio.nr_seq_proced_int%type;
 cd_plano_w			tipo_acomod_convenio.cd_plano%type;
 qt_ano_min_w			tipo_acomod_convenio.qt_ano_min%type;
 qt_ano_min_mes_w		tipo_acomod_convenio.qt_ano_min_mes%type;
 qt_ano_min_dia_w		tipo_acomod_convenio.qt_ano_min_dia%type;
 qt_ano_max_w			tipo_acomod_convenio.qt_ano_max%type;
 qt_ano_max_mes_w		tipo_acomod_convenio.qt_ano_max_mes%type;
 qt_ano_max_dia_w		tipo_acomod_convenio.qt_ano_max_dia%type;
 cd_unidade_basica_w		tipo_acomod_convenio.cd_unidade_basica%type;
 cd_unidade_compl_w		tipo_acomod_convenio.cd_unidade_compl%type;
 nr_acomp_inicial_w		tipo_acomod_convenio.nr_acomp_inicial%type;
 nr_acomp_final_w		tipo_acomod_convenio.nr_acomp_final%type;
 ie_sexo_w			tipo_acomod_convenio.ie_sexo%type;
 nr_seq_group_rule_w		tipo_acomod_convenio.nr_seq_group_rule%type;
 nr_seq_patient_category_w	tipo_acomod_convenio.nr_seq_patient_category%type;
 nr_seq_icu_patient_cat_w	tipo_acomod_convenio.ie_patient_category%type;

 nr_count_categoria_w		smallint;
 nr_count_plano_w		smallint;

C01 CURSOR FOR
	SELECT	cd_procedimento,
	ie_origem_proced,
	cd_procedimento_acomp,
	ie_origem_proced_acomp,
	qt_dia_inicio,
	qt_dia_fim,
	ie_clinica,
	ie_tipo_dia_internacao,
	cd_setor_atendimento,
	ie_carater_internacao,
	nr_seq_classificacao,
	cd_categoria,
	ie_paciente_isolado,
	ie_gerar_primeiro_dia,
	ie_origem_proc_conv,
	nr_seq_proced_int,
	cd_plano,
	qt_ano_min,
	qt_ano_min_mes,
	qt_ano_min_dia,
	qt_ano_max,
	qt_ano_max_mes,
	qt_ano_max_dia,
	cd_unidade_basica,
	cd_unidade_compl,
	nr_acomp_inicial,
	nr_acomp_final,
	ie_sexo,
	nr_seq_group_rule,
	nr_seq_patient_category,
	ie_patient_category
from tipo_acomod_convenio
where cd_tipo_acomodacao=cd_tipo_acomodacao_p
and cd_convenio=cd_convenio_orig_p;


BEGIN
	if((cd_tipo_acomodacao_p IS NOT NULL AND cd_tipo_acomodacao_p::text <> '')
	and (cd_convenio_orig_p IS NOT NULL AND cd_convenio_orig_p::text <> '')
	and (cd_convenio_dest_p IS NOT NULL AND cd_convenio_dest_p::text <> '')) then
	
	open C01;
	loop
	fetch C01 into	
		cd_procedimento_w,
		ie_origem_proced_w,
		cd_procedimento_acomp_w,
		ie_origem_proced_acomp_w,
		qt_dia_inicio_w,
		qt_dia_fim_w,
		ie_clinica_w,
		ie_tipo_dia_internacao_w,
		cd_setor_atendimento_w,
		ie_carater_internacao_w,
		nr_seq_classificacao_w,
		cd_categoria_w,
		ie_paciente_isolado_w,
		ie_gerar_primeiro_dia_w,
		ie_origem_proc_conv_w,
		nr_seq_proced_int_w,
		cd_plano_w,
		qt_ano_min_w,
		qt_ano_min_mes_w,
		qt_ano_min_dia_w,
		qt_ano_max_w,
		qt_ano_max_mes_w,
		qt_ano_max_dia_w,
		cd_unidade_basica_w,
		cd_unidade_compl_w,
		nr_acomp_inicial_w,
		nr_acomp_final_w,
		ie_sexo_w,
		nr_seq_group_rule_w,
		nr_seq_patient_category_w,
		nr_seq_icu_patient_cat_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
		
		
		select count(*)
		into STRICT nr_count_categoria_w
		from categoria_convenio
		where cd_convenio= cd_convenio_dest_p
		and cd_categoria = cd_categoria_w;
		
		select count(*)
		into STRICT nr_count_plano_w
		from categoria_plano
		where cd_convenio= cd_convenio_dest_p
		and cd_plano = cd_plano_w;
		
		if ( nr_count_categoria_w = 0 ) then
			cd_categoria_w := null;
		end if;
		
		if ( nr_count_plano_w = 0 ) then
			cd_plano_w := null;
		end if;
		
		insert into tipo_acomod_convenio(
			cd_tipo_acomodacao,
			cd_convenio,
			cd_procedimento,
			ie_origem_proced,
			dt_atualizacao,
			nm_usuario,
			cd_procedimento_acomp,
			ie_origem_proced_acomp,
			qt_dia_inicio,
			qt_dia_fim,
			nr_sequencia,
			ie_clinica,
			ie_tipo_dia_internacao,
			cd_setor_atendimento,
			ie_carater_internacao,
			nr_seq_classificacao,
			cd_categoria,
			ie_paciente_isolado,
			ie_gerar_primeiro_dia,
			ie_origem_proc_conv,
			nr_seq_proced_int,
			cd_plano,
			qt_ano_min,
			qt_ano_min_mes,
			qt_ano_min_dia,
			qt_ano_max,
			qt_ano_max_mes,
			qt_ano_max_dia,
			cd_unidade_basica,
			cd_unidade_compl,
			nr_acomp_inicial,
			nr_acomp_final,
			ie_sexo,
			nr_seq_group_rule,
			nr_seq_patient_category,
			ie_patient_category
		)
		values (
			cd_tipo_acomodacao_p,
			cd_convenio_dest_p,
			cd_procedimento_w,
			ie_origem_proced_w,
			clock_timestamp(),
			nm_usuario_p,
			cd_procedimento_acomp_w,
			ie_origem_proced_acomp_w,
			qt_dia_inicio_w,
			qt_dia_fim_w,
			nextval('tipo_acomod_convenio_seq'),
			ie_clinica_w,
			ie_tipo_dia_internacao_w,
			cd_setor_atendimento_w,
			ie_carater_internacao_w,
			nr_seq_classificacao_w,
			cd_categoria_w,
			ie_paciente_isolado_w,
			ie_gerar_primeiro_dia_w,
			ie_origem_proc_conv_w,
			nr_seq_proced_int_w,
			cd_plano_w,
			qt_ano_min_w,
			qt_ano_min_mes_w,
			qt_ano_min_dia_w,
			qt_ano_max_w,
			qt_ano_max_mes_w,
			qt_ano_max_dia_w,
			cd_unidade_basica_w,
			cd_unidade_compl_w,
			nr_acomp_inicial_w,
			nr_acomp_final_w,
			ie_sexo_w,
			nr_seq_group_rule_w,
			nr_seq_patient_category_w,
			nr_seq_icu_patient_cat_w
		);

		
	end loop;
	close C01;	
	commit;
	end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copy_rule_to_insurances ( cd_convenio_dest_p text, cd_convenio_orig_p bigint, cd_tipo_acomodacao_p bigint, nm_usuario_p text) FROM PUBLIC;

