-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE arquivo_pj_pf (cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, nm_usuario_p text) AS $body$
DECLARE

 
nr_sequencia_w			varchar(10);
dt_atualizacao_w		varchar(8);
cd_participante_w		varchar(14);
cd_cpf_cnpj_w			varchar(14);
cd_cei_w			varchar(12);
cd_insc_estadual_w		varchar(14);
cd_insc_municipal_w		varchar(14);
ds_pessoa_nota_w		varchar(70);
ds_endereco_w			varchar(60);
ds_bairro_w			varchar(20);
ds_municipio_w			varchar(20);
ds_uf_w				varchar(2);
ds_pais_w			varchar(20);
ds_cep_w			varchar(8);
cd_estabelecimento_w		varchar(10);
contador_w			bigint;
ds_arquivo_ww			varchar(4000);

c01 CURSOR FOR 
SELECT n.nr_sequencia							nr_sequencia, 
	lpad(coalesce(to_char(n.dt_atualizacao,'ddmmyyyy'),' '),8,' ') 	dt_atualizacao, 
    lpad(coalesce(substr(CASE WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='E' THEN n.cd_cgc_emitente WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='S' THEN CASE WHEN coalesce(n.cd_cgc::text, '') = '' THEN n.cd_pessoa_fisica  ELSE n.cd_cgc END  END ,1,14),' '),14,' ') cd_participante, 
    lpad(coalesce(substr(CASE WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='E' THEN n.cd_cgc_emitente WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='S' THEN CASE WHEN coalesce(n.cd_cgc::text, '') = '' THEN obter_cpf_pessoa_fisica(n.cd_pessoa_fisica)  ELSE n.cd_cgc END  END ,1,14),' '),14,' ') cd_cpf_cnpj, 
    lpad(' ',12,' ') 						cd_cei, 
    lpad(coalesce(substr(CASE WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='E' THEN obter_dados_pf_pj(null,n.cd_cgc_emitente,'IE') WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='S' THEN obter_dados_pf_pj(null,n.cd_cgc,'IE') END ,1,14),' '),14,' ') cd_insc_estadual, 
    lpad(coalesce(substr(CASE WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='E' THEN obter_dados_pf_pj(null,n.cd_cgc_emitente,'IM') WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='S' THEN obter_dados_pf_pj(null,n.cd_cgc,'IM') END ,1,14),' '),14,' ') cd_insc_municipal, 
    rpad(coalesce(substr(CASE WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='E' THEN obter_dados_pf_pj(null,n.cd_cgc_emitente,'N') WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='S' THEN obter_dados_nota_fiscal(n.nr_sequencia,5) END ,1,70),' '),70,' ') ds_pessoa_nota, 
    rpad(coalesce(substr(CASE WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='E' THEN obter_dados_pf_pj(null,n.cd_cgc_emitente,'E') WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='S' THEN CASE WHEN coalesce(n.cd_cgc::text, '') = '' THEN obter_dados_pf_pj(n.cd_pessoa_fisica,null,'E')  ELSE obter_dados_pf_pj(null,n.cd_cgc_emitente,'E') END  END ,1,60),' '),60,' ') ds_endereco, 
    rpad(coalesce(substr(CASE WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='E' THEN obter_dados_pf_pj(null,n.cd_cgc_emitente,'B') WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='S' THEN CASE WHEN coalesce(n.cd_cgc::text, '') = '' THEN obter_dados_pf_pj(n.cd_pessoa_fisica,null,'B')  ELSE obter_dados_pf_pj(null,n.cd_cgc_emitente,'B') END  END ,1,20),' '),20,' ') ds_bairro, 
    rpad(coalesce(substr(CASE WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='E' THEN obter_dados_pf_pj(null,n.cd_cgc_emitente,'CI') WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='S' THEN CASE WHEN coalesce(n.cd_cgc::text, '') = '' THEN obter_dados_pf_pj(n.cd_pessoa_fisica,null,'CI')  ELSE obter_dados_pf_pj(null,n.cd_cgc_emitente,'CI') END  END ,1,20),' '),20,' ') ds_municipio, 
    rpad(coalesce(substr(CASE WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='E' THEN obter_dados_pf_pj(null,n.cd_cgc_emitente,'UF') WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='S' THEN CASE WHEN coalesce(n.cd_cgc::text, '') = '' THEN obter_dados_pf_pj(n.cd_pessoa_fisica,null,'UF')  ELSE obter_dados_pf_pj(null,n.cd_cgc_emitente,'UF') END  END ,1,20),' '),2,' ') ds_uf, 
    rpad(coalesce(substr(CASE WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='E' THEN obter_dados_pf_pj(null,n.cd_cgc_emitente,'PAIS') WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='S' THEN CASE WHEN coalesce(n.cd_cgc::text, '') = '' THEN obter_dados_pf_pj(n.cd_pessoa_fisica,null,'PAIS')  ELSE obter_dados_pf_pj(null,n.cd_cgc_emitente,'PAIS') END  END ,1,20),' '),20,' ') ds_pais, 
    rpad(coalesce(substr(CASE WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='E' THEN obter_dados_pf_pj(null,n.cd_cgc_emitente,'CEP') WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='S' THEN CASE WHEN coalesce(n.cd_cgc::text, '') = '' THEN obter_dados_pf_pj(n.cd_pessoa_fisica,null,'CEP')  ELSE obter_dados_pf_pj(null,n.cd_cgc_emitente,'CEP') END  END ,1,20),' '),8,' ') ds_cep, 
	n.cd_estabelecimento						cd_estabelecimento 
from  nota_fiscal n 
where	n.cd_estabelecimento = cd_estabelecimento_p 
and	n.dt_emissao between to_date(to_char(dt_inicio_p,'dd/mm/yyyy'),'dd/mm/yyyy') and fim_dia(to_date(to_char(dt_fim_p,'dd/mm/yyyy'),'dd/mm/yyyy')) 
order by n.nr_sequencia;


BEGIN 
 
open c01;
loop 
fetch c01 into 
	nr_sequencia_w, 
	dt_atualizacao_w, 
	cd_participante_w, 
	cd_cpf_cnpj_w, 
	cd_cei_w, 
	cd_insc_estadual_w, 
	cd_insc_municipal_w, 
	ds_pessoa_nota_w, 
	ds_endereco_w, 
	ds_bairro_w, 
	ds_municipio_w, 
	ds_uf_w, 
	ds_pais_w, 
	ds_cep_w, 
	cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	begin 
 
	contador_w := contador_w + 1;
 
	ds_arquivo_ww	:=	 
				dt_atualizacao_w	|| 
				cd_participante_w	|| 
				cd_cpf_cnpj_w		|| 
				cd_cei_w		|| 
				cd_insc_estadual_w	|| 
				cd_insc_municipal_w	|| 
				ds_pessoa_nota_w	|| 
				ds_endereco_w		|| 
				ds_bairro_w		|| 
				ds_municipio_w		|| 
				ds_uf_w			|| 
				ds_pais_w		|| 
				ds_cep_w;
 
insert into w_inss_direp_arquivo( nr_sequencia, 
				cd_estabelecimento, 
				dt_atualizacao, 
				nm_usuario, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				ds_arquivo_w) 
		values (nextval('w_inss_direp_arquivo_seq'), 
				cd_estabelecimento_w, 
				clock_timestamp(), 
				nm_usuario_p, 
				clock_timestamp(), 
				nm_usuario_p, 
				ds_arquivo_ww);
 
	if (mod(contador_w,100) = 0) then 
		commit;
	end if;
 
	end;
 
end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE arquivo_pj_pf (cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, nm_usuario_p text) FROM PUBLIC;

