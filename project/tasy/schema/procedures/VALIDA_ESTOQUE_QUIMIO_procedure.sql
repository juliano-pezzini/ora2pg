-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE valida_estoque_quimio ( cd_material_p bigint, qt_material_p bigint, qt_cabine_p bigint, cd_local_estoque_p bigint, ie_cons_lote_fornec_p text, nr_seq_lote_p bigint, cd_unid_medida_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


qt_conv_estoque_consumo_w	bigint;
qt_saldo_disp_estoque_w		bigint;
qt_saldo_w                 bigint;
cd_unidade_medida_consumo_w	varchar(30);
qt_cabine_w			        bigint;
dt_mesano_referencia_w      timestamp;
cd_estabelecimento_w        smallint;
cd_local_estoque_w          smallint;
cd_material_w               integer;


BEGIN

select	max(qt_conv_estoque_consumo)
into STRICT	qt_conv_estoque_consumo_w
from	material
where	cd_material	= cd_material_p;

select	substr(obter_dados_material_estab(cd_material_p,cd_estabelecimento_p,'UMS'),1,30)
into STRICT	cd_unidade_medida_consumo_w
;

qt_cabine_w	:= qt_cabine_p;
dt_mesano_referencia_w	:= PKG_DATE_UTILS.start_of(clock_timestamp(), 'mm', 0);
cd_estabelecimento_w := cd_estabelecimento_p;
cd_local_estoque_w := cd_local_estoque_p;
cd_material_w := cd_material_p;

if (ie_cons_lote_fornec_p = 'N') then

    select	coalesce(SUM(qt_estoque),0)
	into STRICT	qt_saldo_w
    from	fornecedor_mat_consignado
    where	cd_material = cd_material_w
    and	cd_estabelecimento = cd_estabelecimento_w
    and	dt_mesano_referencia = dt_mesano_referencia_w
    and	cd_local_estoque = coalesce(cd_local_estoque_w,cd_local_estoque);

	select	coalesce(obter_saldo_disp_estoque(
		cd_estabelecimento_p,
		cd_material_p,
		cd_local_estoque_p,
		trunc(clock_timestamp(), 'mm')),0)
	into STRICT	qt_saldo_disp_estoque_w
	;

elsif (ie_cons_lote_fornec_p = 'S') then
	begin

    select	coalesce(sum(qt_estoque),0)
    into STRICT	qt_saldo_w
    from	fornecedor_mat_consig_lote
    where	nr_seq_lote = nr_seq_lote_p
    and	cd_estabelecimento = cd_estabelecimento_w
    and	dt_mesano_referencia = dt_mesano_referencia_w
    and	cd_local_estoque = coalesce(cd_local_estoque_w,cd_local_estoque);

	select 	coalesce(obter_saldo_estoque_lote(
		cd_estabelecimento_p,
		cd_material_p,
		cd_local_estoque_p,
		trunc(clock_timestamp(), 'mm'),
		nr_seq_lote_p),0)
	into STRICT	qt_saldo_disp_estoque_w
	;

	select	obter_quantidade_convertida(
		cd_material_p,
		(qt_cabine_p + qt_material_p),
		cd_unid_medida_p,
		'UME')
	into STRICT	qt_cabine_w
	;

	end;
end if;

qt_saldo_disp_estoque_w := qt_saldo_disp_estoque_w + qt_saldo_w;

if	(((cd_unidade_medida_consumo_w <> cd_unid_medida_p) and
	 (qt_saldo_disp_estoque_w - (coalesce(qt_cabine_w,qt_cabine_p) / qt_conv_estoque_consumo_w)) < (qt_material_p / qt_conv_estoque_consumo_w)) or
	((cd_unidade_medida_consumo_w = cd_unid_medida_p) and (qt_saldo_disp_estoque_w < coalesce(qt_cabine_w,qt_cabine_p)) and (ie_cons_lote_fornec_p = 'S'))) then
	  -- Quantidade insuficiente em estoque.

	  -- Estoque disponivel: #@ESTOQUE_DISPONIVEL#@"
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(1160565, 'ESTOQUE_DISPONIVEL=' || qt_saldo_disp_estoque_w);
elsif (qt_saldo_disp_estoque_w = 0) then
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(323253);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE valida_estoque_quimio ( cd_material_p bigint, qt_material_p bigint, qt_cabine_p bigint, cd_local_estoque_p bigint, ie_cons_lote_fornec_p text, nr_seq_lote_p bigint, cd_unid_medida_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

