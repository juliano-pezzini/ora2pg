-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_processo_aprovacao ( cd_material_p bigint, cd_centro_custo_p bigint, cd_setor_atendimento_p bigint, cd_local_Estoque_p bigint, cd_local_estoque_destino_p bigint, -- Usado somente na requisicao
 cd_operacao_estoque_p bigint, -- Usado somente na requisicao
 cd_conta_contabil_p text, cd_cgc_fornecedor_p text, cd_pessoa_fisica_p text, ie_tipo_processo_p text, ie_urgente_p text, cd_estabelecimento_p bigint, cd_perfil_ativo_p bigint, nr_seq_proj_rec_p bigint, nr_documento_p bigint, cd_processo_Aprov_p INOUT bigint) AS $body$
DECLARE


cd_grupo_material_w    grupo_material.cd_grupo_material%type;
cd_subgrupo_material_w    subgrupo_material.cd_subgrupo_material%type;
cd_classe_material_w    classe_material.cd_classe_material%type;
cd_familia_material_w     processo_aprov_estrut.cd_familia_material%type;
cd_Processo_Aprov_w    processo_aprov_resp.cd_processo_aprov%type;
ie_consignado_w      processo_aprov_estrut.ie_consignado%type;
ie_padronizado_w      processo_aprov_estrut.ie_padronizado%type;
ie_material_estoque_w    processo_aprov_estrut.ie_material_estoque%type;
ie_curva_abc_w      processo_aprov_estrut.ie_curva_abc%type;
ie_tipo_requisicao_w    operacao_estoque.ie_tipo_requisicao%type;
ie_ressuprimento_w      processo_aprov_estrut.ie_material_ressup%type;
ie_cobra_paciente_w    processo_aprov_estrut.ie_cobra_paciente%type;
nr_seq_motivo_solic_w    processo_aprov_estrut.nr_seq_motivo_solic%type  := 0;
nr_seq_tipo_compra_w    processo_aprov_estrut.nr_seq_tipo_compra%type  := 0;
ie_receita_w      processo_aprov_estrut.ie_receita%type;
ie_classif_custo_w      processo_aprov_estrut.ie_classif_custo%type;
nr_seq_forma_compra_w    processo_aprov_estrut.nr_seq_forma_compra%type;
ie_tipo_ordem_w      processo_aprov_estrut.ie_tipo_ordem%type  := 'N';
cd_operacao_nf_w    processo_aprov_estrut.cd_operacao_nf%type;
cd_cargo_w      cargo.cd_cargo%type;
ds_cargo_w      cargo.ds_cargo%type;
cd_modalidade_w     cot_compra.cd_modalidade%type;
qt_registros_w      bigint;

c01 CURSOR FOR
  /* Fabio 19/05/2004 - Alterei o select para nao buscar os processos inativos*/

  SELECT  a.cd_processo_aprov
  from  Processo_Aprov_Estrut a,
    processo_aprovacao b
  where  a.cd_processo_aprov           = b.cd_processo_aprov
  and  b.ie_situacao <> 'I'
  and  ((coalesce(a.cd_perfil::text, '') = '') or (coalesce(cd_perfil_ativo_p::text, '') = '') or (a.cd_perfil = cd_perfil_ativo_p))
  and  coalesce(a.cd_estabelecimento, cd_estabelecimento_p)      = cd_estabelecimento_p
  and  coalesce(b.cd_estabelecimento, cd_estabelecimento_p)      = cd_estabelecimento_p
  and  coalesce(a.cd_material, coalesce(cd_material_p,0))        = coalesce(cd_material_p,0)
  and  coalesce(a.cd_setor_atendimento,coalesce(cd_setor_atendimento_p,0))     = coalesce(cd_setor_atendimento_p,0)
  and  coalesce(a.cd_centro_custo,coalesce(cd_centro_custo_p,0))      = coalesce(cd_centro_custo_p,0)
  and  coalesce(a.cd_local_estoque,coalesce(cd_local_estoque_p,0))      = coalesce(cd_local_Estoque_p,0)
  and  coalesce(a.cd_local_estoque_destino,coalesce(cd_local_estoque_destino_p,0))  = coalesce(cd_local_estoque_destino_p,0)
  and  coalesce(a.cd_operacao_estoque,coalesce(cd_operacao_estoque_p,0))    = coalesce(cd_operacao_estoque_p,0)
  and  coalesce(a.nr_seq_proj_rec,coalesce(nr_seq_proj_rec_p,0))      = coalesce(nr_seq_proj_rec_p,0)
  and  coalesce(a.nr_seq_forma_compra,coalesce(nr_seq_forma_compra_w,0))      = coalesce(nr_seq_forma_compra_w,0)
  and  coalesce(a.nr_seq_motivo_solic,coalesce(nr_seq_motivo_solic_w,0))      = coalesce(nr_seq_motivo_solic_w,0)
  and  coalesce(a.nr_seq_tipo_compra,coalesce(nr_seq_tipo_compra_w,0))      = coalesce(nr_seq_tipo_compra_w,0)
  and  coalesce(a.cd_conta_contabil,coalesce(cd_conta_contabil_p,0)) = coalesce(cd_conta_contabil_p,0)
  and  coalesce(a.cd_cgc,coalesce(cd_cgc_fornecedor_p,0)) = coalesce(cd_cgc_fornecedor_p,0)
  and  coalesce(a.cd_pessoa_fisica,coalesce(cd_pessoa_fisica_p,0))      = coalesce(cd_pessoa_fisica_p,0)
  and  coalesce(a.cd_classe_material, coalesce(cd_classe_material_w, 0))      = coalesce(cd_classe_material_w, 0)
  and  coalesce(a.cd_subgrupo_material, coalesce(cd_subgrupo_material_w, 0))      = coalesce(cd_subgrupo_material_w, 0)
  and  coalesce(a.cd_grupo_material, coalesce(cd_grupo_material_w, 0))        = coalesce(cd_grupo_material_w, 0)
  and coalesce(a.cd_familia_material, coalesce(cd_familia_material_w, 0)) = coalesce(cd_familia_material_w, 0)
  and  coalesce(a.ie_consignado, coalesce(ie_consignado_w, 2)) = coalesce(ie_consignado_w, 2) -- 2 = Ambos
  and  coalesce(a.ie_classif_custo,coalesce(ie_classif_custo_w,0))      = coalesce(ie_classif_custo_w,0)
  and  coalesce(a.ie_tipo_ordem,coalesce(ie_tipo_ordem_w,'N'))        = coalesce(ie_tipo_ordem_w,'N')
  and  coalesce(a.cd_operacao_nf, coalesce(cd_operacao_nf_w,0)) = coalesce(cd_operacao_nf_w,0)
  and  coalesce(a.cd_mod_cotacao, coalesce(cd_modalidade_w,0)) = coalesce(cd_modalidade_w,0)
  and  ((coalesce(a.ie_receita,'A') = 'A') or (a.ie_receita        = ie_receita_w))
  and  ((ie_padronizado = 'T') or (ie_padronizado        = ie_padronizado_w))
  and  ((ie_material_estoque = 'A') or (ie_material_estoque      = ie_material_estoque_w))
  and  ((coalesce(ie_material_ressup,'A') = 'A') or (ie_material_ressup      = ie_ressuprimento_w))
  and  ((coalesce(a.ie_cobra_paciente,'A') = 'A') or (a.ie_cobra_paciente    = ie_cobra_paciente_w))
  and  ((ie_urgente = 'A') or (ie_urgente = ie_urgente_p))
  and  (( coalesce(ie_curva_abc,'N') = 'N') or (ie_curva_abc_w = 'N') or (ie_curva_abc = ie_curva_abc_w))
  and  ((coalesce(a.vl_compra_mes, 0) = 0) or ((b.ie_situacao = 'A') and (coalesce(a.vl_compra_mes, 0) < Obter_vl_compra_mes_proc_aprov(a.nr_sequencia, a.cd_processo_aprov))))
  and  not exists (SELECT  1
        from  processo_aprov_estrut_exc x
        where  x.cd_processo_aprov = a.cd_processo_aprov
        and  x.cd_centro_custo = coalesce(cd_centro_custo_p,0))
  and  a.cd_processo_aprov in(
      select  cd_processo_aprov
      from  processo_aprov_resp
      where  ie_solicitacao_compra   = 'S'
      and  ie_tipo_processo_p    = 'S'  /*Solicitacao de compras*/
union

      select  cd_processo_aprov
      from  processo_aprov_resp
      where  ie_solicitacao_pagto   = 'S'
      and  ie_tipo_processo_p    = 'P'  /*Solicitacao de pagamento*/
      
union

      select  cd_processo_aprov
      from  processo_aprov_resp
      where  ie_ordem_compra    = 'S'
      and  ie_tipo_processo_p    = 'O'  /*Ordem de compra*/
      
union

      select  cd_processo_aprov
      from  processo_aprov_resp
      where  ie_ordem_compra_transf  = 'S'
      and  ie_tipo_processo_p    = 'T'  /*Ordem de transferencia*/
      
union

      select  cd_processo_aprov
      from  processo_aprov_resp
      where  ie_transf_pcs  = 'S'
      and  ie_tipo_processo_p    = 'Z'  /*Transferencia PCS*/
      
union

      select cd_processo_aprov
      from   processo_aprov_resp
      where  coalesce(ie_cotacao,'N') = 'S'
      and    ie_tipo_processo_p = 'C' /*Cotacao de compras*/
      
union

      select  cd_processo_aprov
      from  processo_aprov_resp
      where  coalesce(ie_nota_fiscal,'N')    = 'S'  /*Nota fiscal */
      and  ie_tipo_processo_p    = 'N'
      
union

      select  cd_processo_aprov
      from  processo_aprov_resp
      where  coalesce(ie_reg_licitacao,'N')  = 'S'  /*Registro de licitacao*/
      and  ie_tipo_processo_p    = 'L'
      
union

      select  cd_processo_aprov
      from  processo_aprov_resp
      where  coalesce(ie_nota_fiscal_contrato,'N') = 'S'  /*Notas com contrato*/
      and  ie_tipo_processo_p     = 'NC'
      
union

      select  cd_processo_aprov
      from  processo_aprov_resp
      where  coalesce(ie_controle_contrato,'N')  = 'S'  /*Controle de contratos*/
      and  ie_tipo_processo_p     = 'G'
      
union

      select  cd_processo_aprov
      from  processo_aprov_resp
      where  coalesce(ie_contr_proj_rec_externo,'N')  = 'S'  /*Controle de Projetos e Recursos Externos*/
      and  ie_tipo_processo_p     = 'E'
      
union

      select  x.cd_processo_aprov
      from  processo_aprov_resp x
      where  x.ie_requisicao    = 'S'
      and  ie_tipo_processo_p    = 'R'
      and  ((ie_tipo_requisicao_w  <> '2') or
        ((ie_tipo_requisicao_w  = '2') and (coalesce(x.ie_desconsidera_req_transf,'N') = 'N'))))
  order by  coalesce(cd_material,0),
      coalesce(a.nr_seq_motivo_solic,0),
      a.ie_tipo_ordem nulls first,
      coalesce(a.ie_consignado,0),
      coalesce(cd_classe_material,0),
      coalesce(cd_subgrupo_material,0),
      coalesce(cd_grupo_material,0),
      coalesce(a.cd_perfil,0),
      coalesce(cd_local_estoque,0),
      coalesce(cd_centro_custo,0),
      coalesce(a.cd_setor_atendimento,0),
      coalesce(a.nr_seq_proj_rec,0),
      coalesce(a.cd_conta_contabil,0),
      coalesce(a.cd_cgc,0),
      coalesce(a.cd_pessoa_fisica,0),
      coalesce(a.cd_estabelecimento,0),
      coalesce(b.cd_estabelecimento,0),
      coalesce(a.nr_seq_tipo_compra,0);

c02 CURSOR FOR
SELECT  cd_cargo,
  substr(obter_desc_cargo(cd_cargo),1,100) ds_cargo
from  processo_aprov_resp
where  cd_processo_aprov = cd_processo_aprov_w
and  ie_responsavel = 'C'
and  (cd_cargo IS NOT NULL AND cd_cargo::text <> '');


BEGIN

if (ie_tipo_processo_p = 'R') and (nr_documento_p > 0) then

  select  coalesce(max(ie_tipo_requisicao),0)
  into STRICT  ie_tipo_requisicao_w
  from  operacao_estoque a,
    requisicao_material b
  where  a.cd_operacao_estoque = b.cd_operacao_estoque
  and  nr_requisicao = nr_documento_p;

elsif (ie_tipo_processo_p in ('O','T')) and (nr_documento_p > 0) then

  select  coalesce(max(nr_seq_tipo_compra),0),
    coalesce(max(nr_seq_motivo_solic),0),
    coalesce(max(ie_tipo_ordem),'N')
  into STRICT  nr_seq_tipo_compra_w,
    nr_seq_motivo_solic_w,
    ie_tipo_ordem_w
  from  ordem_compra
  where  nr_ordem_compra = nr_documento_p;


elsif (ie_tipo_processo_p = 'S') and (nr_documento_p > 0) then

  select  coalesce(max(nr_seq_motivo_solic),0),
    coalesce(max(nr_seq_forma_compra),0)
  into STRICT  nr_seq_motivo_solic_w,
    nr_seq_forma_compra_w
  from  solic_compra
  where  nr_solic_compra = nr_documento_p;
elsif (ie_tipo_processo_p in ('N','NC')) and (nr_documento_p > 0) then

  select  coalesce(max(cd_operacao_nf),0)
  into STRICT    cd_operacao_nf_w
  from    nota_fiscal
  where   nr_sequencia = nr_documento_p;

elsif (ie_tipo_processo_p = 'C') and (nr_documento_p > 0) then
	
	select coalesce(max(cd_modalidade),0)
	into STRICT cd_modalidade_w
	from cot_compra
	where nr_cot_compra = nr_documento_p;
	
end if;

if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then

    select  a.cd_grupo_material,
        a.cd_subgrupo_material,
        a.cd_classe_material,
        coalesce(a.nr_seq_familia,0),
        coalesce(a.ie_consignado,0),
        substr(obter_se_material_padronizado(cd_estabelecimento_p, cd_material_p),1,1) ie_padronizado,
        substr(obter_se_material_estoque(cd_estabelecimento_p, 0, cd_material_p),1,1) ie_material_estoque,
        substr(obter_curva_abc_estab(cd_estabelecimento_p,cd_material_p,'N',trunc(clock_timestamp(),'mm')),1,1),
        substr(obter_se_mat_ressuprimento(cd_estabelecimento_p, cd_material_p),1,1) ie_ressuprimento
    into STRICT  cd_grupo_material_w,
        cd_subgrupo_material_w,
        cd_classe_material_w,
        cd_familia_material_w,
        ie_consignado_w,
        ie_padronizado_w,
        ie_material_estoque_w,
        ie_curva_abc_w,
        ie_ressuprimento_w
    from  estrutura_material_v a
    where  a.cd_material = cd_material_p;

    select  coalesce(max(a.ie_cobra_paciente),'S'),
        coalesce(max(a.ie_receita),'N'),
        coalesce(max(b.ie_classif_custo),'B')
    into STRICT  ie_cobra_paciente_w,
        ie_receita_w,
        ie_classif_custo_w
    from  material_estab b,
        material a
    where  a.cd_material = cd_material_p
    and  b.cd_material = a.cd_material
    and  b.cd_estabelecimento = cd_estabelecimento_p;

end if;

if (ie_curva_abc_w = 'X') then
  ie_curva_abc_w      := 'N';
end if;

open C01;
loop
  fetch C01 into
    cd_processo_aprov_w;
  EXIT WHEN NOT FOUND; /* apply on c01 */
    cd_processo_aprov_p  := cd_processo_aprov_w;
end loop;
close C01;

if (cd_processo_aprov_w > 0) then

  open C02;
  loop
  fetch C02 into
    cd_cargo_w,
    ds_cargo_w;
  EXIT WHEN NOT FOUND; /* apply on C02 */
    begin

    select  count(*)
    into STRICT  qt_registros_w
    from  usuario a,
      pessoa_fisica b
    where  a.cd_pessoa_fisica = b.cd_pessoa_fisica
    and  b.cd_cargo = cd_cargo_w
    and  a.ie_situacao in ('A','B');

    if (qt_registros_w = 0) then
      CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(237043,  'DS_CARGO_P='||ds_cargo_w);
      /*rollback; Retirei para nao dar problema quando chamado a partir de trigger */

    end if;
    end;
  end loop;
  close C02;

end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_processo_aprovacao ( cd_material_p bigint, cd_centro_custo_p bigint, cd_setor_atendimento_p bigint, cd_local_Estoque_p bigint, cd_local_estoque_destino_p bigint, cd_operacao_estoque_p bigint, cd_conta_contabil_p text, cd_cgc_fornecedor_p text, cd_pessoa_fisica_p text, ie_tipo_processo_p text, ie_urgente_p text, cd_estabelecimento_p bigint, cd_perfil_ativo_p bigint, nr_seq_proj_rec_p bigint, nr_documento_p bigint, cd_processo_Aprov_p INOUT bigint) FROM PUBLIC;

