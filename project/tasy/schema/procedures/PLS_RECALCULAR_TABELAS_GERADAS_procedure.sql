-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_recalcular_tabelas_geradas ( nr_seq_simul_perfil_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_simul_plano_w		bigint;
qt_idade_inicial_w		bigint;
qt_idade_final_w		bigint;
qt_beneficiario_w		bigint;
nr_seq_tabela_w			bigint;
vl_preco_faixa_etaria_w		double precision;
nr_seq_tabela_ww		bigint;
vl_tot_preco_faixa_w		double precision := 0;
vl_preco_faixa_w		double precision := 0;
qt_total_beneficiarios_w	bigint := 0;
qt_vidas_w			bigint := 0;
tx_indice_perfil_w		double precision;
vl_preco_original_w		double precision := 0;
vl_preco_tot_original_w		double precision := 0;

C01 CURSOR FOR
	SELECT	qt_idade_inicial,
		qt_idade_final,
		qt_beneficiario
	from	pls_simulpreco_coletivo
	where	nr_seq_simul_perfil	= nr_seq_simul_perfil_p;

C02 CURSOR FOR
	SELECT	b.nr_sequencia
	from	pls_simulacao_plano b,
		pls_simulacao_perfil a
	where	b.nr_seq_simul_perfil	= a.nr_sequencia
	and	a.nr_sequencia		= nr_seq_simul_perfil_p
	and	b.qt_idade_inicial	= qt_idade_inicial_w
	and	b.qt_idade_final	= qt_idade_final_w;

C03 CURSOR FOR
	SELECT	b.nr_seq_tabela
	from	pls_simulacao_plano b,
		pls_simulacao_perfil a
	where	b.nr_seq_simul_perfil	= a.nr_sequencia
	and	a.nr_sequencia		= nr_seq_simul_perfil_p
	group by b.nr_seq_tabela;

C04 CURSOR FOR
	SELECT	b.nr_sequencia
	from	pls_simulacao_plano b,
		pls_simulacao_perfil a
	where	b.nr_seq_simul_perfil	= a.nr_sequencia
	and	a.nr_sequencia		= nr_seq_simul_perfil_p
	and	b.nr_seq_tabela		= nr_seq_tabela_ww
	and	b.qt_idade_final	<> 0;


BEGIN

select	max(tx_indice)
into STRICT	tx_indice_perfil_w
from	pls_simulacao_perfil
where	nr_sequencia		= nr_seq_simul_perfil_p;

if (coalesce(tx_indice_perfil_w::text, '') = '') then
	tx_indice_perfil_w	:= 1;
end if;

open C01;
loop
fetch C01 into
	qt_idade_inicial_w,
	qt_idade_final_w,
	qt_beneficiario_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	open C02;
	loop
	fetch C02 into
		nr_seq_simul_plano_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		select	max(nr_seq_tabela)
		into STRICT	nr_seq_tabela_w
		from	pls_simulacao_plano
		where	nr_sequencia	= nr_seq_simul_plano_w;

		if (nr_seq_tabela_w IS NOT NULL AND nr_seq_tabela_w::text <> '') then
			begin
			select	max(vl_preco_atual)
			into STRICT	vl_preco_faixa_etaria_w
			from	pls_plano_preco
			where	nr_seq_tabela		= nr_seq_tabela_w
			and	qt_idade_inicial	= qt_idade_inicial_w
			and	qt_idade_final		= qt_idade_final_w;
			exception
			when others then
				vl_preco_faixa_etaria_w	:= 0;
			end;

			if (coalesce(vl_preco_faixa_etaria_w::text, '') = '') then
				vl_preco_faixa_etaria_w	:= 0;
			end if;

			vl_preco_original_w	:= vl_preco_original_w;

			vl_preco_faixa_etaria_w	:= vl_preco_faixa_etaria_w * tx_indice_perfil_w;

			update	pls_simulacao_plano
			set	vl_preco_faixa		= vl_preco_faixa_etaria_w,
				vl_preco_original	= vl_preco_original_w,
				qt_vidas		= qt_beneficiario_w
			where	nr_sequencia		= nr_seq_simul_plano_w;
		end if;
		end;
	end loop;
	close C02;
	qt_total_beneficiarios_w	:= qt_total_beneficiarios_w + qt_beneficiario_w;
	end;
end loop;
close C01;

open C03;
loop
fetch C03 into
	nr_seq_tabela_ww;
EXIT WHEN NOT FOUND; /* apply on C03 */
	begin
	vl_tot_preco_faixa_w	:= 0;
	vl_preco_tot_original_w	:= 0;
	open C04;
	loop
	fetch C04 into
		nr_seq_simul_plano_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
		begin

		begin
		select	vl_preco_faixa,
			qt_vidas,
			vl_preco_original
		into STRICT	vl_preco_faixa_w,
			qt_vidas_w,
			vl_preco_original_w
		from	pls_simulacao_plano
		where	nr_sequencia	= nr_seq_simul_plano_w;
		exception
		when others then
			vl_preco_faixa_w	:= 0;
			qt_vidas_w		:= 0;
			vl_preco_original_w	:= 0;
		end;

		if (coalesce(vl_preco_faixa_w::text, '') = '') then
			vl_preco_faixa_w	:= 0;
		end if;

		if (coalesce(qt_vidas_w::text, '') = '') then
			qt_vidas_w	:= 0;
		end if;

		vl_tot_preco_faixa_w	:= vl_tot_preco_faixa_w + (vl_preco_faixa_w  * qt_vidas_w);
		vl_preco_tot_original_w	:= vl_preco_tot_original_w + vl_preco_original_w;

		end;
	end loop;
	close C04;

	update	pls_simulacao_plano
	set	vl_preco_faixa		= vl_tot_preco_faixa_w,
		vl_preco_original	= vl_preco_tot_original_w
	where	nr_seq_simul_perfil	= nr_seq_simul_perfil_p
	and	nr_seq_tabela		= nr_seq_tabela_ww
	and	qt_idade_inicial	= 0
	and	qt_idade_final		= 0;

	end;
end loop;
close C03;

update	pls_simulacao_plano
set	qt_vidas			= qt_total_beneficiarios_w
where	nr_seq_simul_perfil		= nr_seq_simul_perfil_p
and	qt_idade_inicial		= 0
and	qt_idade_final			= 0;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_recalcular_tabelas_geradas ( nr_seq_simul_perfil_p bigint, nm_usuario_p text) FROM PUBLIC;

