-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_ctrl_build_hotfix ( nr_seq_ctrl_desc_p man_os_ctrl_desc.nr_sequencia%type, nr_service_order_p man_ordem_servico.nr_sequencia%type, nr_seq_customer_p com_cliente.nr_sequencia%type, cd_version_p man_os_ctrl_build.cd_versao%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


cd_cnpj_w pessoa_juridica.cd_cgc%type;
ds_hotfix_w service_pack_hotfix.ds_hotfix%type;
cd_version_w service_pack_hotfix.cd_version%type;


BEGIN
  
  select max(cd_cnpj)
  into STRICT cd_cnpj_w
  from com_cliente
  where nr_sequencia = nr_seq_customer_p;

  if (cd_cnpj_w IS NOT NULL AND cd_cnpj_w::text <> '') then
      select max(a.ds_hotfix),
             max(a.cd_version)
      into STRICT ds_hotfix_w,
           cd_version_w
      from service_pack_hotfix a,
           service_order_sp_hotfix b
      where a.nr_sequencia = b.nr_service_pack_hotfix
      and b.cd_cnpj = cd_cnpj_w
      and b.nr_service_order = nr_service_order_p
	    and a.cd_version = cd_version_p;

      if (cd_version_w IS NOT NULL AND cd_version_w::text <> '' AND ds_hotfix_w IS NOT NULL AND ds_hotfix_w::text <> '') then
      
        insert into man_os_ctrl_build(
          nr_sequencia,
          dt_atualizacao,
          nm_usuario,
          dt_atualizacao_nrec,
          nm_usuario_nrec,
          cd_versao,
          nr_seq_man_os_ctrl_desc,
          ie_situacao,
          ds_hotfix
        )
        values (
          nextval('man_os_ctrl_build_seq'),
          clock_timestamp(),
          nm_usuario_p,
          clock_timestamp(),
          nm_usuario_p,
          cd_version_w,
          nr_seq_ctrl_desc_p,
          'A',
          ds_hotfix_w
        );

        commit;
      else
        CALL wheb_mensagem_pck.exibir_mensagem_abort(1101219);
      end if;
  else
    CALL wheb_mensagem_pck.exibir_mensagem_abort(1101217);
  end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_ctrl_build_hotfix ( nr_seq_ctrl_desc_p man_os_ctrl_desc.nr_sequencia%type, nr_service_order_p man_ordem_servico.nr_sequencia%type, nr_seq_customer_p com_cliente.nr_sequencia%type, cd_version_p man_os_ctrl_build.cd_versao%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

