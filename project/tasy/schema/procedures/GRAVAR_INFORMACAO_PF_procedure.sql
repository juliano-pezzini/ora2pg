-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_informacao_pf ( ie_chave_p bigint, vl_chave_p text, nr_seq_exame_p bigint, ie_tipo_p text, ds_resultado_p text, nm_usuario_p text, ie_commit_p bigint) AS $body$
DECLARE


/* ie_commit_p	-> 0-Não / 1-Sim */

/* ie_chave_p	-> 0-PF  / 1-Atendimento / 2-Prescrição*/

/* ie_tipo_p	-> E-Exame  / P-Perda Ganho  */

nr_sequencia_w	bigint;


BEGIN

if (nr_seq_exame_p IS NOT NULL AND nr_seq_exame_p::text <> '') then

	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_sequencia_w
	from 	config_comp_paciente
	where	(((nr_seq_exame    = nr_seq_exame_p)  and (coalesce(ie_tipo_p,'E') = 'E')) or
		((nr_seq_tipo_pg   = nr_seq_exame_p)  and (coalesce(ie_tipo_p,'E') = 'P')));


	if (nr_sequencia_w <> 0) then


		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_sequencia_w
		from	pessoa_fisica_inf
		where	cd_pessoa_fisica	= vl_chave_p
		 and	(((nr_seq_exame     	= nr_seq_exame_p) and (coalesce(nr_seq_tipo_pg::text, '') = '')) or
			((nr_seq_tipo_pg     	= nr_seq_exame_p) and (coalesce(nr_seq_exame::text, '') = '')));

		if (nr_sequencia_w = 0) then

			insert into pessoa_fisica_inf(	NR_SEQUENCIA,	CD_PESSOA_FISICA,
							DS_INFORMACAO,	DT_ATUALIZACAO,
							NM_USUARIO,	DT_ATUALIZACAO_NREC,
							NM_USUARIO_NREC,NR_SEQ_EXAME,
							NR_SEQ_TIPO_PG)
						values (	nextval('pessoa_fisica_inf_seq'),	vl_chave_p,
							ds_resultado_p,			clock_timestamp(),
							nm_usuario_p,			clock_timestamp(),
							nm_usuario_p,			CASE WHEN ie_tipo_p='E' THEN nr_seq_exame_p  ELSE null END ,
							CASE WHEN ie_tipo_p='P' THEN nr_seq_exame_p  ELSE null END );
		else
			update pessoa_fisica_inf
			set	DS_INFORMACAO 	= ds_resultado_p,
				DT_ATUALIZACAO	= clock_timestamp(),
				NM_USUARIO	= nm_usuario_p
			where	cd_pessoa_fisica = vl_chave_p
			and	(((nr_seq_exame    = nr_seq_exame_p)  and (coalesce(ie_tipo_p,'E') = 'E')) or
				((nr_seq_tipo_pg   = nr_seq_exame_p)  and (coalesce(ie_tipo_p,'E') = 'P')));
		end if;

		if (ie_commit_p	= 1) then
			commit;
		end if;
	end if;
end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_informacao_pf ( ie_chave_p bigint, vl_chave_p text, nr_seq_exame_p bigint, ie_tipo_p text, ds_resultado_p text, nm_usuario_p text, ie_commit_p bigint) FROM PUBLIC;

