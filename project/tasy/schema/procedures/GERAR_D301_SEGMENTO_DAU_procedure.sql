-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_d301_segmento_dau ( nr_seq_dataset_p bigint, nm_usuario_p text) AS $body$
DECLARE


dt_previsto_alta_w		varchar(8);
dt_entrada_w			varchar(8);
dt_cid_afastamento_w		varchar(8);
nr_atendimento_w		d301_dataset_envio.nr_atendimento%type;
cd_cid_acompanhamento_w		diagnostico_doenca.cd_doenca%type;
ie_lado_acompanhamento_w	diagnostico_doenca.ie_lado%type;
cd_cid_sec_afastamento_w	diagnostico_doenca.cd_doenca%type;
ie_lado_afastamento_w		diagnostico_doenca.ie_lado%type;
ie_dataset_w			d301_dataset_envio.ie_dataset%type;


BEGIN

select	max(ie_dataset)
into STRICT	ie_dataset_w
from	d301_dataset_envio
where	nr_sequencia	= nr_seq_dataset_p;

if (ie_dataset_w = 'VERL') then
	begin
	select	b.nr_atendimento,
		to_char(a.dt_previsto_alta,'yyyymmdd'),
		to_char(c.dt_entrada,'yyyymmdd')
	into STRICT	nr_atendimento_w,
		dt_previsto_alta_w,
		dt_entrada_w
	from	atend_previsao_alta a,
		d301_dataset_envio b,
		atendimento_paciente c
	where	a.nr_sequencia		= b.nr_seq_atend_prev_alta
	and	c.nr_atendimento	= a.nr_atendimento
	and	b.nr_sequencia		= nr_seq_dataset_p;
	exception
	when others then
		nr_atendimento_w	:= null;
		dt_previsto_alta_w	:= null;
		dt_entrada_w		:= null;
	end;

elsif (ie_dataset_w = 'ENTL') then
	begin
	select	b.nr_atendimento,
		to_char(c.dt_alta,'yyyymmdd'),
		to_char(c.dt_entrada,'yyyymmdd')
	into STRICT	nr_atendimento_w,
		dt_previsto_alta_w,
		dt_entrada_w
	from	d301_dataset_envio b,
		atendimento_paciente c
	where	c.nr_atendimento	= b.nr_atendimento
	and	b.nr_sequencia		= nr_seq_dataset_p;
	exception
	when others then
		nr_atendimento_w	:= null;
		dt_previsto_alta_w	:= null;
		dt_entrada_w		:= null;
	end;
end if;

select	max(d.cd_doenca),
	max(d.ie_lado),
	max(to_char(d.dt_diagnostico,'yyyymmdd'))
into STRICT	cd_cid_acompanhamento_w,
	ie_lado_acompanhamento_w,
	dt_cid_afastamento_w
from	atendimento_paciente a,
	medic_diagnostico_doenca b,
	classificacao_diagnostico c,
	diagnostico_doenca d
where	b.nr_seq_classificacao 		= c.nr_sequencia
and	b.nr_atendimento		= a.nr_atendimento
and	d.nr_atendimento		= a.nr_atendimento
and	b.cd_doenca			= d.cd_doenca
and	b.ie_situacao			= 'A'
--and	upper(c.ds_classificacao)	= 'NACHFOLGEDIAGNOSE'
and	'S'				= OBTER_SE_CLASSIF_DIAG_301(c.nr_sequencia,'NAC',d.DT_DIAGNOSTICO)
and	coalesce(d.cd_doenca_superior::text, '') = ''
and	coalesce(d.dt_inativacao::text, '') = ''
and	(d.dt_liberacao IS NOT NULL AND d.dt_liberacao::text <> '')
and	a.nr_atendimento 		= nr_atendimento_w;

select	max(a.cd_doenca),
	max(a.ie_lado)
into STRICT	cd_cid_sec_afastamento_w,
	ie_lado_afastamento_w
from	diagnostico_doenca a,
	medic_diagnostico_doenca b,
	classificacao_diagnostico c
where	b.nr_seq_classificacao 		= c.nr_sequencia
and	b.nr_atendimento		= a.nr_atendimento
and	b.cd_doenca			= a.cd_doenca
and	b.ie_situacao			= 'A'
--and	upper(c.ds_classificacao)	= 'NACHFOLGEDIAGNOSE'
and	'S'				= OBTER_SE_CLASSIF_DIAG_301(c.nr_sequencia,'NAC',a.DT_DIAGNOSTICO)
and	coalesce(a.dt_inativacao::text, '') = ''
and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and	a.cd_doenca_superior 		= cd_cid_acompanhamento_w
and	a.nr_atendimento		= nr_atendimento_w;


insert into d301_segmento_dau(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_seq_dataset,
	ds_dt_admissao,
	ds_dt_saida_prevista,
	cd_cid_acompanhamento,
	nr_seq_301_local_acomp,
	cd_cid_sec_afastamento,
	nr_seq_301_local_sec,
	ds_dt_cid_afastamento,
	qt_hota_ventilacao)
values (nextval('d301_segmento_dau_seq'),
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_dataset_p,
	dt_entrada_w,
	dt_previsto_alta_w,
	cd_cid_acompanhamento_w,
	OBTER_SEQ_VALOR_301('C301_16_LOCALIZACAO','IE_LOCALIZACAO',obter_conversao_301('C301_16_LOCALIZACAO',null,1372,ie_lado_acompanhamento_w,'I')),
	cd_cid_sec_afastamento_w,
	OBTER_SEQ_VALOR_301('C301_16_LOCALIZACAO','IE_LOCALIZACAO',obter_conversao_301('C301_16_LOCALIZACAO',null,1372,ie_lado_afastamento_w,'I')),
	dt_cid_afastamento_w,
	null);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_d301_segmento_dau ( nr_seq_dataset_p bigint, nm_usuario_p text) FROM PUBLIC;

