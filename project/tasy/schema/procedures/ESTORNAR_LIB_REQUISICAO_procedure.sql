-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE estornar_lib_requisicao ( nr_requisicao_p bigint, nm_usuario_p text) AS $body$
DECLARE



ie_estorna_aprov_solic_w	varchar(1);
nr_seq_aprovacao_w		bigint;
dt_liberacao_w			timestamp;
nm_usuario_lib_w		varchar(15);
reg_integracao_p		gerar_int_padrao.reg_integracao;
cd_operacao_estoque_w	requisicao_material.cd_operacao_estoque%type;
cd_local_estoque_w		requisicao_material.cd_local_estoque%type;
cd_local_estoque_dest_w	requisicao_material.cd_local_estoque_destino%type;
cd_centro_custo_w		requisicao_material.cd_centro_custo%type;

c01 CURSOR FOR
SELECT	distinct nr_seq_aprovacao
from	item_requisicao_material
where	nr_requisicao	= nr_requisicao_p;


BEGIN

select	dt_liberacao,
	nm_usuario_lib
into STRICT	dt_liberacao_w,
	nm_usuario_lib_w
from	requisicao_material
where	nr_requisicao = nr_requisicao_p;

if (coalesce(dt_liberacao_w::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(237194);
end if;

Update	requisicao_material
set	dt_liberacao		= '',
	nm_usuario		= nm_usuario_p,
	nm_usuario_lib		= '',
	dt_atualizacao		= clock_timestamp(),
	dt_aprovacao		= '',
	nm_usuario_aprov 		= ''
where	nr_requisicao	 	= nr_requisicao_p;

insert into requisicao_mat_historico(
	nr_sequencia,
	nr_requisicao,
	dt_atualizacao,
	nm_usuario,
	dt_historico,
	ds_titulo,
	ds_historico,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	ie_tipo,
	cd_evento,
	dt_liberacao,
	nm_usuario_lib)
values (nextval('requisicao_mat_historico_seq'),
	nr_requisicao_p,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	Wheb_mensagem_pck.get_Texto(300827),
	WHEB_MENSAGEM_PCK.get_texto(300828,'NM_USUARIO_P='|| NM_USUARIO_P ||';DT_LIBERACAO_W='|| PKG_DATE_FORMATERS.to_varchar(clock_timestamp(), 'timestamp', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, nm_usuario_p)),
	clock_timestamp(),
	nm_usuario_p,
	'S',
	'EL',
	clock_timestamp(),
	nm_usuario_p);

open C01;
loop
fetch C01 into	
	nr_seq_aprovacao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	delete
	from	processo_aprov_compra
	where	nr_sequencia 	= nr_seq_aprovacao_w;
	
	end;
end loop;
close C01;

update	item_requisicao_material
set	nr_seq_aprovacao	 = NULL,
	dt_aprovacao	 = NULL,
	nm_usuario_aprov	= ''
where	nr_requisicao	= nr_requisicao_p;

CALL gerar_int_dankia_pck.dankia_estornar_liberacao(nr_requisicao_p);

commit;

/*Integracao WMS*/

select	max(cd_operacao_estoque),
	max(cd_local_estoque),
	max(cd_local_estoque_destino),
	max(cd_centro_custo)
into STRICT	cd_operacao_estoque_w,
	cd_local_estoque_w,
	cd_local_estoque_dest_w,
	cd_centro_custo_w
from	requisicao_material
where	nr_requisicao	= nr_requisicao_p;

reg_integracao_p.ie_operacao			:= 'E';
reg_integracao_p.cd_estab_documento		:= wheb_usuario_pck.get_cd_estabelecimento;
reg_integracao_p.cd_operacao_estoque		:= cd_operacao_estoque_w;
reg_integracao_p.cd_local_estoque		:= cd_local_estoque_w;
reg_integracao_p.cd_local_estoque_destino	:= cd_local_estoque_dest_w;
reg_integracao_p.cd_centro_custo		:= cd_centro_custo_w;
reg_integracao_p := gerar_int_padrao.gravar_integracao('30', nr_requisicao_p, nm_usuario_p, reg_integracao_p);
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE estornar_lib_requisicao ( nr_requisicao_p bigint, nm_usuario_p text) FROM PUBLIC;

