-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dirf_registro_val_mensais_pf ( cd_pessoa_fisica_P text, cd_dirf_p text, dt_lote_p timestamp, nm_usuario_p text, nr_seq_posicao_p bigint, nr_seq_apres_p INOUT bigint, cd_estabelecimento_p text) AS $body$
DECLARE

					 
ds_arquivo_ret_w varchar(2000);
ds_arquivo_ir_w varchar(2000);
nr_seq_apres_w	bigint;
dt_lote_w	timestamp;
ie_mes_w	varchar(2);
ie_entou_w	boolean;
vl_rendimento_w	double precision;
vl_irrf_w	double precision;
separador_w	varchar(1) := '|';
nr_titulo_w	varchar(20);
qt_titulos_w	bigint;
dt_emissao_w	timestamp;

C01 CURSOR FOR 
	SELECT 	distinct p.nr_titulo, 
		p.dt_emissao 
	FROM titulo_pagar p
LEFT OUTER JOIN titulo_pagar_imposto i ON (p.nr_titulo = i.nr_titulo)
WHERE trunc(p.dt_liquidacao,'YYYY') = trunc(dt_lote_p,'YYYY') and p.cd_pessoa_fisica = cd_pessoa_fisica_p and CASE WHEN i.cd_darf='588' THEN '0588'  ELSE coalesce(i.cd_darf,'0588') END  = cd_dirf_p and coalesce(to_char(p.dt_liquidacao,'mm'),'00') = lpad(ie_mes_w,2,'0') and ( (p.cd_estabelecimento = coalesce(cd_estabelecimento_p,p.cd_estabelecimento)) 
	or	 ((coalesce(p.cd_estabelecimento::text, '') = '') and (coalesce(cd_estabelecimento_p::text, '') = ''))) and p.ie_tipo_titulo in (SELECT z.ie_tipo_titulo from dirf_regra_tipo_tit z) --and 	p.ie_tipo_titulo in (11,13,9) 
  and p.ie_situacao <> 'C' order by p.dt_emissao;


BEGIN 
nr_seq_apres_w := nr_seq_posicao_p;
ie_mes_w := '01';
ie_entou_w := false;
ds_arquivo_ret_w := 'RTRT' || separador_w;
ds_arquivo_ir_w := 'RTIRF' || separador_w;
 
 
while (ie_mes_w)::numeric  <= 13 loop 
	vl_rendimento_w := 0;
	vl_irrf_w := 0;
	qt_titulos_w:= 1;
	OPEN c01;
	LOOP 
	FETCH c01 INTO 
		nr_titulo_w, 
		dt_emissao_w;	
	EXIT WHEN NOT FOUND; /* apply on c01 */
		if (qt_titulos_w = 1) then 
			vl_rendimento_w := vl_rendimento_w + coalesce(obter_valor_rendimento_dirf_pf(nr_titulo_w,'S','S'),0);
		else 
			vl_rendimento_w := vl_rendimento_w + coalesce(obter_valor_rendimento_dirf_pf(nr_titulo_w,'S','N'),0);
		end if;
		vl_irrf_w := vl_irrf_w + coalesce(obter_valor_imposto_pf(nr_titulo_w,'IR'),0);
		ie_entou_w := true;
		qt_titulos_w := qt_titulos_w + 1;
	END LOOP;
	CLOSE c01;
	 
	if ((ie_mes_w)::numeric  = 13) and (coalesce(vl_rendimento_w,0) = 0) then 
		ds_arquivo_ret_w := ds_arquivo_ret_w || separador_w;		
	elsif (coalesce(vl_rendimento_w,0) = 0) then 
		ds_arquivo_ret_w := ds_arquivo_ret_w || lpad(replace(campo_mascara(coalesce('0','0'),2),'.',''),15,'0') || separador_w;
	else 
		ds_arquivo_ret_w := ds_arquivo_ret_w || lpad(replace(campo_mascara(coalesce(vl_rendimento_w,'0'),2),'.',''),15,'0') || separador_w;
	end if;
	 
	if ((ie_mes_w)::numeric  = 13) and (coalesce(vl_irrf_w,0) = 0) then 
		ds_arquivo_ir_w := ds_arquivo_ir_w  || separador_w;
	elsif (coalesce(vl_irrf_w,0) = 0) then 
		ds_arquivo_ir_w := ds_arquivo_ir_w || lpad(replace(campo_mascara(coalesce('0','0'),2),'.',''),15,'0') || separador_w;
	else 
		ds_arquivo_ir_w := ds_arquivo_ir_w || lpad(replace(campo_mascara(coalesce(vl_irrf_w,'0'),2),'.',''),15,'0') || separador_w;
	end if;
	 
		 
/*	if (not ie_entou_w) then 
		ds_arquivo_ret_w := ds_arquivo_ret_w || separador_w; 
		ds_arquivo_ir_w := ds_arquivo_ir_w  || separador_w; 
	end if 
	else 
		if (vl_rendimento_w = 0) then 
			ds_arquivo_ret_w := ds_arquivo_ret_w || separador_w; 
		else 
			ds_arquivo_ret_w := ds_arquivo_ret_w || lpad(replace(campo_mascara(nvl(vl_rendimento_w,'0'),2),'.',''),15,'0') || separador_w; 
		end if; 
		 
		if (vl_irrf_w = 0) then 
			ds_arquivo_ir_w := ds_arquivo_ir_w  || separador_w; 
		else 
			ds_arquivo_ir_w := ds_arquivo_ir_w || lpad(replace(campo_mascara(nvl(vl_irrf_w,'0'),2),'.',''),15,'0') || separador_w; 
		end if; 
	end if;*/
 
		 
	ie_entou_w := false;	
	ie_mes_w := to_char((ie_mes_w + 1)::numeric );
end loop;
 
--registro de rentdimentos 
insert 	into w_dirf_arquivo(nr_sequencia, 
				   nm_usuario, 
				   nm_usuario_nrec, 
				   dt_atualizacao, 
				   dt_atualizacao_nrec, 
				   ds_arquivo, 
				   nr_seq_apresentacao, 
				   nr_seq_registro, 
				   cd_pessoa_fisica) 
		values (nextval('w_dirf_arquivo_seq'), 
				   nm_usuario_p, 
				   nm_usuario_p, 
				   clock_timestamp(), 
				   clock_timestamp(), 
				   DS_ARQUIVO_RET_W, 
				   nr_seq_apres_w, 
				   0, 
				   cd_pessoa_fisica_p);
 
nr_seq_apres_w := nr_seq_apres_w + 1; 				
 
--registro de IR 
insert 	into w_dirf_arquivo(nr_sequencia, 
				   nm_usuario, 
				   nm_usuario_nrec, 
				   dt_atualizacao, 
				   dt_atualizacao_nrec, 
				   ds_arquivo, 
				   nr_seq_apresentacao, 
				   nr_seq_registro, 
				   cd_pessoa_fisica) 
		values (nextval('w_dirf_arquivo_seq'), 
				   nm_usuario_p, 
				   nm_usuario_p, 
				   clock_timestamp(), 
				   clock_timestamp(), 
				   DS_ARQUIVO_IR_W, 
				   nr_seq_apres_w, 
				   0, 
				   cd_pessoa_fisica_p);				
commit;
nr_seq_apres_p := nr_seq_apres_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dirf_registro_val_mensais_pf ( cd_pessoa_fisica_P text, cd_dirf_p text, dt_lote_p timestamp, nm_usuario_p text, nr_seq_posicao_p bigint, nr_seq_apres_p INOUT bigint, cd_estabelecimento_p text) FROM PUBLIC;

