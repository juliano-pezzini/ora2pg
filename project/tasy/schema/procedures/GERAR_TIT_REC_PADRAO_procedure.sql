-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_tit_rec_padrao ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_cgc_p pessoa_juridica.cd_cgc%type, dt_vencimento_p titulo_receber.dt_vencimento%type, dt_emissao_p titulo_receber.dt_emissao%type, vl_titulo_p titulo_receber.vl_titulo%type, nr_seq_trans_fin_contab_p titulo_receber.nr_seq_trans_fin_contab%type, nr_seq_trans_fin_baixa_p titulo_receber.nr_seq_trans_fin_baixa%type, ie_origem_titulo_p titulo_receber.ie_origem_titulo%type, nm_usuario_p text, nr_titulo_p INOUT titulo_receber.nr_titulo%type, ie_integra_unimed_p text default 'N') AS $body$
DECLARE

				 
nr_titulo_w			titulo_receber.nr_titulo%type;
cd_moeda_cr_w			parametro_contas_receber.cd_moeda_padrao%type;
cd_tipo_taxa_juro_cr_w		parametro_contas_receber.cd_tipo_taxa_juro%type;
cd_tipo_taxa_multa_cr_w		parametro_contas_receber.cd_tipo_taxa_multa%type;
tx_juros_cr_w			parametro_contas_receber.pr_juro_padrao%type;
tx_multa_cr_w			parametro_contas_receber.pr_multa_padrao%type;
cd_tipo_portador_w		parametro_contas_receber.cd_tipo_portador%type;
cd_portador_w			parametro_contas_receber.cd_portador%type;


BEGIN 
 
if (coalesce(dt_emissao_p::text, '') = '') then 
	-- Não foi possível gerar o título a receber. A data de emissão não foi informada. 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(308425);
end if;
 
if (coalesce(dt_vencimento_p::text, '') = '') then 
	-- Não foi possível gerar o título a receber. A data de vencimento não foi informada. 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(308426);
end if;
 
begin 
	select	a.cd_moeda_padrao, 
		a.cd_tipo_taxa_juro, 
		a.cd_tipo_taxa_multa, 
		a.pr_juro_padrao, 
		a.pr_multa_padrao, 
		a.cd_tipo_portador, 
		a.cd_portador 
	into STRICT	cd_moeda_cr_w, 
		cd_tipo_taxa_juro_cr_w, 
		cd_tipo_taxa_multa_cr_w, 
		tx_juros_cr_w, 
		tx_multa_cr_w, 
		cd_tipo_portador_w, 
		cd_portador_w 
	from	parametro_contas_receber a 
	where	a.cd_estabelecimento	= cd_estabelecimento_p;
exception 
	when no_data_found then 
	-- Não foram cadastrados os parâmetros do contas a receber! 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(194990);	
end;
 
select	nextval('titulo_seq') 
into STRICT	nr_titulo_w
;
 
insert	into	titulo_receber(nr_titulo, 
	nm_usuario, 
	dt_atualizacao, 
	cd_estabelecimento, 
	cd_tipo_portador, 
	cd_portador, 
	dt_emissao, 
	dt_contabil, 
	dt_vencimento, 
	dt_pagamento_previsto, 
	vl_titulo, 
	vl_saldo_titulo, 
	vl_saldo_juros, 
	vl_saldo_multa, 
	tx_juros, 
	tx_multa, 
	cd_tipo_taxa_juro, 
	cd_tipo_taxa_multa, 
	tx_desc_antecipacao, 
	ie_tipo_titulo, 
	ie_tipo_inclusao, 
	ie_origem_titulo, 
	cd_moeda, 
	ie_situacao, 
	cd_pessoa_fisica, 
	cd_cgc, 
	ie_tipo_emissao_titulo, 
	nr_lote_contabil, 
	nr_seq_trans_fin_contab, 
	nr_seq_trans_fin_baixa, 
	ie_integra_unimed) 
values (nr_titulo_w, 
	nm_usuario_p, 
	clock_timestamp(), 
	cd_estabelecimento_p, 
	cd_tipo_portador_w, 
	cd_portador_w, 
	dt_emissao_p, 
	dt_emissao_p, 
	dt_vencimento_p, 
	dt_vencimento_p, 
	vl_titulo_p, 
	vl_titulo_p, 
	0, 
	0, 
	0, 
	0, 
	cd_tipo_taxa_juro_cr_w, 
	cd_tipo_taxa_multa_cr_w, 
	0, 
	'1', /* Bloqueto */
 
	'2', 
	ie_origem_titulo_p, 
	cd_moeda_cr_w, 
	'1', 
	null, 
	cd_cgc_p, 
	'2' /* Emissão bloqueto origem */
, 
	0, 
	nr_seq_trans_fin_contab_p, 
	nr_seq_trans_fin_baixa_p, 
	coalesce(ie_integra_unimed_p,'N'));
	 
CALL gerar_imposto_tit_rec(nr_titulo_w,nm_usuario_p);
nr_titulo_p:= nr_titulo_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_tit_rec_padrao ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_cgc_p pessoa_juridica.cd_cgc%type, dt_vencimento_p titulo_receber.dt_vencimento%type, dt_emissao_p titulo_receber.dt_emissao%type, vl_titulo_p titulo_receber.vl_titulo%type, nr_seq_trans_fin_contab_p titulo_receber.nr_seq_trans_fin_contab%type, nr_seq_trans_fin_baixa_p titulo_receber.nr_seq_trans_fin_baixa%type, ie_origem_titulo_p titulo_receber.ie_origem_titulo%type, nm_usuario_p text, nr_titulo_p INOUT titulo_receber.nr_titulo%type, ie_integra_unimed_p text default 'N') FROM PUBLIC;

