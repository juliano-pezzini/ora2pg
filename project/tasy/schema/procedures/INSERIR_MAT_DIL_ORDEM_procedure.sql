-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_mat_dil_ordem (nr_seq_medic_diluido_p bigint, nr_seq_ordem_p bigint, nr_seq_ordem_item_p bigint) AS $body$
DECLARE





cd_diluente_w 				bigint;
qt_dose_dil_w				double precision;
cd_UM_dil_w					varchar(30);
nr_seq_lote_fornec_dil_w	bigint;
qt_dose_real_dil_w			double precision;
cd_um_real_dil_w			varchar(30);

--Pegar todos os diluentes do medicamento selecionado no medic_manip_nova_wcp
C01 CURSOR FOR
	SELECT      cd_material,
				qt_saldo,
				cd_unidade_medida,
				nr_seq_lote_fornec,
				Obter_dose_conv_quimio_ordem(cd_material, qt_saldo, obter_unid_med_usua('ml'), Obter_Diluente_ordem_prod(nr_seq_ordem_p, 'U'), nr_seq_ordem_p) qt_dose_real, --Dose real Ã© a dose convertida para unidade prescrita
				substr(Obter_Diluente_ordem_prod(nr_seq_ordem_p, 'U'),1,30)
	FROM      	quimio_sobra_overfill
	WHERE     	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
	AND	nr_seq_superior = nr_seq_medic_diluido_p  --nr_sequencia do medicamento
	AND	ie_tipo = 'DI';


BEGIN
	OPEN C01;
	LOOP
	FETCH C01 INTO
		cd_diluente_w,
		qt_dose_dil_w,
		cd_UM_dil_w,
		nr_seq_lote_fornec_dil_w,
		qt_dose_real_dil_w,
		cd_um_real_dil_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		BEGIN

		INSERT INTO can_ordem_prod_mat(
		nr_sequencia,
		nr_seq_ordem,
		dt_atualizacao,
		nm_usuario,
		cd_material,
		qt_dose,
		cd_unidade_medida,
		ie_medic_diluente,
		nr_seq_lote_fornec,
		qt_dose_real,
		qt_perda,
		cd_unidade_medida_real,
		nr_seq_item_prescr,
		cd_estabelecimento,
		ie_sobra_overfill,
		ie_reaproveitado,
		ie_estoque_cabine,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_superior)
	VALUES (	nextval('can_ordem_prod_mat_seq'),
		nr_seq_ordem_p,
		clock_timestamp(),
		wheb_usuario_pck.get_nm_usuario,
		cd_diluente_w,
		qt_dose_dil_w,
		cd_UM_dil_w,
		'D',
		CASE WHEN nr_seq_lote_fornec_dil_w=0 THEN NULL  ELSE nr_seq_lote_fornec_dil_w END ,
		qt_dose_real_dil_w,
		0,
		cd_um_real_dil_w,
		nr_seq_ordem_item_p,
		wheb_usuario_pck.get_cd_estabelecimento,
		'Z',
		'N',
		'N',
		clock_timestamp(),
		wheb_usuario_pck.get_nm_usuario,
		nr_seq_medic_diluido_p);

		END;
	END LOOP;
	CLOSE C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_mat_dil_ordem (nr_seq_medic_diluido_p bigint, nr_seq_ordem_p bigint, nr_seq_ordem_item_p bigint) FROM PUBLIC;

