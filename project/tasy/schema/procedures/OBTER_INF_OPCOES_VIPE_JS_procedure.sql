-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_inf_opcoes_vipe_js ( nm_maquina_p text, nr_atendimento_p bigint, cd_setor_atendimento_p bigint, cd_perfil_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_permite_p INOUT text) AS $body$
DECLARE

 
cd_setor_prescr_w	bigint;
qt_aux_w		bigint;
ie_pac_usuario_w	varchar(1);
ie_setor_usuario_w	varchar(1);
					

BEGIN 
 
ie_permite_p 		:= 'N';
qt_aux_w		:= 0;
cd_setor_prescr_w	:= 0;
 
ie_pac_usuario_w := obter_param_usuario(924, 42, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_pac_usuario_w);
ie_setor_usuario_w := obter_param_usuario(924, 136, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_setor_usuario_w);
 
if (ie_pac_usuario_w = 'C') then 
 
	select 	max(cd_setor_atendimento) 
	into STRICT	cd_setor_prescr_w 
	from  	computador 
	where 	nm_computador_pesquisa = padronizar_nome(upper(nm_maquina_p));
	 
elsif (ie_pac_usuario_w = 'U') and (ie_setor_usuario_w = 'S') then 
	 
	cd_setor_prescr_w := cd_setor_atendimento_p;
 
elsif (ie_pac_usuario_w = 'U') and (nr_atendimento_p > 0) then 
	 
	select 	count(*) 
	into STRICT	qt_aux_w 
	from  	setor_atendimento a 
	where 	a.cd_setor_atendimento in (SELECT 	b.cd_setor_atendimento  
					from 	atend_paciente_unidade b   
					where 	b.nr_atendimento = nr_atendimento_p 
					and 	b.cd_setor_atendimento = cd_setor_atendimento_p);
						 
	if (qt_aux_w > 0) then 
		cd_setor_prescr_w := cd_setor_atendimento_p;
	end if;
elsif (nr_atendimento_p > 0) then 
	cd_setor_prescr_w := coalesce(obter_unidade_atendimento(nr_atendimento_p,'IA','CS'), obter_unidade_atendimento(nr_atendimento_p,'A','CS'));
end if;
 
if (cd_setor_prescr_w > 0) then 
 
	select 	coalesce(max(ie_permite),'S') 
	into STRICT	ie_permite_p 
	from 	regra_prescr_setor 
	where 	coalesce(cd_setor_atendimento,cd_setor_prescr_w) = cd_setor_prescr_w 
	and 	coalesce(cd_perfil,cd_perfil_p) = cd_perfil_p;
 
end if;
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_inf_opcoes_vipe_js ( nm_maquina_p text, nr_atendimento_p bigint, cd_setor_atendimento_p bigint, cd_perfil_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_permite_p INOUT text) FROM PUBLIC;

