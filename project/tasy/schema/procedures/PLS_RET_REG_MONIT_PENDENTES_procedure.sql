-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_ret_reg_monit_pendentes ( nr_seq_arquivo_p pls_monitor_tiss_arquivo.nr_sequencia%type) AS $body$
DECLARE


dt_mes_comp_w pls_monitor_tiss_lote.dt_mes_competencia%type;
dt_fim_mes_comp_w pls_monitor_tiss_lote.dt_mes_competencia%type;

C01 CURSOR FOR
	SELECT nr_seq_conta ,
		row_number() over (partition by nr_seq_arq_monitor order by nr_seq_conta) nr_linha
	from pls_monitor_tiss_guia x
	where x.nr_seq_arq_monitor = nr_seq_arquivo_p;

BEGIN

	select trunc(dt_mes_competencia, 'MM'),
		fim_mes(dt_mes_competencia)
	into STRICT 	dt_mes_comp_w,
		dt_fim_mes_comp_w
	from pls_monitor_tiss_lote
	where nr_sequencia = (	SELECT 	max(nr_seq_lote_monitor)
				from 	pls_monitor_tiss_arquivo 
				where 	nr_sequencia = nr_seq_arquivo_p);

	for r_c01_w in C01 loop
		update 	pls_monitor_tiss_alt
		set 	ie_status = 'P'
		where 	nr_seq_conta = r_c01_w.nr_seq_conta
		and 	ie_status = 'PR'
		and 	dt_evento between dt_mes_comp_w and dt_fim_mes_comp_w;
		
		if ( r_c01_w.nr_linha mod 100 = 0) then
			commit;
		end if;
	end loop;
	commit;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ret_reg_monit_pendentes ( nr_seq_arquivo_p pls_monitor_tiss_arquivo.nr_sequencia%type) FROM PUBLIC;

