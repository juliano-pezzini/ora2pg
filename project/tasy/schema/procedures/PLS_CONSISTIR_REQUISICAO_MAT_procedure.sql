-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consistir_requisicao_mat ( nr_seq_requisicao_mat_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Realiza a consistencia dos materiais da requisicao, cobertura, carencia, limitacao e ocorrencias.
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[ X ]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
1 - Tomar muito cuidado com a performance
2 - Tomar cuidado pois as consistencias de cobertura, carencia, limitacao e ocorrencias. nao podem para de fuincionar.
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_segurado_w		bigint;
nr_seq_material_w		bigint;
qt_glosa_w			bigint;
ie_status_w			varchar(2);
nr_seq_requisicao_w		bigint;
ie_tipo_guia_w			varchar(2);
nr_seq_plano_w			bigint;
qt_solicitada_w			pls_requisicao_mat.qt_solicitado%type;
dt_requisicao_w			timestamp;
nr_seq_prestador_w		bigint;
nr_seq_uni_exec_w		bigint;
ie_tipo_processo_w		varchar(4);
ie_mat_inativo_w		varchar(1) := 'S';
qt_dias_vencido_w		bigint;
ie_tipo_pagador_w		varchar(2);
ie_tipo_intercambio_w		varchar(10);
nr_seq_congenere_w		bigint;
ie_tipo_gat_w			varchar(1);
ie_mat_audioria_w		varchar(1);
ie_cheque_w			varchar(1);
ie_carencia_abrangencia_ant_w	varchar(10);
nr_seq_prestador_exec_w		pls_requisicao.nr_seq_prestador_exec%type;


BEGIN

-- gerencia a atualizacao da tabela TM para estrutura de materiais
CALL PLS_GERENCIA_UPD_OBJ_PCK.ATUALIZAR_OBJETOS('Tasy', 'PLS_CONSISTIR_REQUISICAO_MAT', 'PLS_ESTRUTURA_MATERIAL_TM');
--Atualizando a tabela de grupo de procedimentos
CALL PLS_GERENCIA_UPD_OBJ_PCK.ATUALIZAR_OBJETOS('Tasy', 'PLS_CONSISTIR_REQUISICAO_MAT', 'PLS_GRUPO_SERVICO_TM');
-- gerencia a atualizacao da tabela TM para para grupos de materiais
CALL PLS_GERENCIA_UPD_OBJ_PCK.ATUALIZAR_OBJETOS('Tasy', 'PLS_CONSISTIR_REQUISICAO_MAT', 'PLS_GRUPO_MATERIAL_TM');

select	a.nr_seq_segurado,
	b.nr_seq_material,
	a.nr_sequencia,
	a.ie_tipo_guia,
	a.nr_seq_plano,
	b.qt_solicitado,
	a.dt_requisicao,
	a.nr_seq_prestador,
	a.nr_seq_uni_exec,
	a.ie_tipo_processo,
	a.ie_tipo_intercambio,
	a.ie_tipo_gat,
	a.nr_seq_prestador_exec
into STRICT	nr_seq_segurado_w,
	nr_seq_material_w,
	nr_seq_requisicao_w,
	ie_tipo_guia_w,
	nr_seq_plano_w,
	qt_solicitada_w,
	dt_requisicao_w,
	nr_seq_prestador_w,
	nr_seq_uni_exec_w,
	ie_tipo_processo_w,
	ie_tipo_intercambio_w,
	ie_tipo_gat_w,
	nr_seq_prestador_exec_w
from	pls_requisicao		a,
	pls_requisicao_mat	b
where	a.nr_sequencia	= b.nr_seq_requisicao
and	b.nr_sequencia	= nr_seq_requisicao_mat_p;

if (coalesce(qt_solicitada_w,0) <= 0) then
		CALL pls_gravar_requisicao_glosa('2005',null, null,
					nr_seq_requisicao_mat_p, '', nm_usuario_p,
					nr_seq_prestador_w, cd_estabelecimento_p, null,
					'');
	end if;

select	coalesce(max(ie_carencia_abrangencia_ant),'N')
into STRICT	ie_carencia_abrangencia_ant_w
from	pls_parametros
where	cd_estabelecimento	= cd_estabelecimento_p;

qt_dias_vencido_w	:= pls_obter_dias_inadimplencia(nr_seq_segurado_w);
ie_cheque_w		:= pls_obter_se_cheque_devolucao(nr_seq_segurado_w);

begin
select	CASE WHEN b.cd_cgc='' THEN 'PF'  ELSE 'PJ' END ,
	a.nr_seq_congenere
into STRICT	ie_tipo_pagador_w,
	nr_seq_congenere_w
from	pls_contrato_pagador	b,
	pls_segurado		a
where	a.nr_sequencia		= nr_seq_segurado_w
and	a.nr_seq_pagador	= b.nr_sequencia;
exception
	when others then
	ie_tipo_pagador_w	:= 'A';
	nr_seq_congenere_w	:= null;
end;

ie_mat_inativo_w := pls_obter_se_mat_inativo(nr_seq_material_w,dt_requisicao_w);

if (ie_mat_inativo_w = 'N') then
	CALL pls_gravar_requisicao_glosa('9920', null, null,
				nr_seq_requisicao_mat_p, 'Material inativo ou fora de vigencia. (Funcao: OPS - Cadastro de Materiais)', nm_usuario_p,
				nr_seq_prestador_w, cd_estabelecimento_p, null,
				'');
end if;
if (coalesce(ie_tipo_intercambio_w,'X')	<> 'I') then
	qt_glosa_w := pls_consistir_cobertura_mat(	nr_seq_segurado_w, 0, 0, nr_seq_material_w, '', cd_estabelecimento_p, nr_seq_requisicao_mat_p, nm_usuario_p, null, qt_glosa_w, 'R');
				
	if (coalesce(qt_glosa_w,0) = 0) then
		CALL pls_consistir_limitacao_mat(	nr_seq_segurado_w, null, null,
						nr_seq_requisicao_mat_p, nr_seq_material_w, qt_solicitada_w, 
						null, cd_estabelecimento_p,nm_usuario_p);
		CALL pls_consistir_carencia_mat(	nr_seq_segurado_w, null, null,
						null, nr_seq_requisicao_mat_p,nr_seq_material_w, 
						null, dt_requisicao_w, null, 
						'', ie_carencia_abrangencia_ant_w,cd_estabelecimento_p, 
						nm_usuario_p);	
	end if;

	if (coalesce(nr_seq_prestador_exec_w,0) > 0) and (ie_tipo_processo_w = 'E') then
		CALL pls_consistir_mat_prestador(nr_seq_prestador_exec_w, null, null, nr_seq_requisicao_mat_p, null, cd_estabelecimento_p, nm_usuario_p);	
	end if;	
end if;

ie_mat_audioria_w	:= pls_obter_se_gerar_analise(nr_seq_requisicao_w,nr_seq_requisicao_mat_p,6);
/*
select	count(*)
into	qt_registros_w
from	pls_requisicao_glosa
where	nr_seq_req_mat	= nr_seq_requisicao_mat_p;
*/
if (coalesce(ie_mat_audioria_w,'N')	= 'N') then
	update	pls_requisicao_mat
	set	ie_status	= 'N',
		dt_atualizacao	= clock_timestamp(),
		nm_usuario	= nm_usuario_p
	where	nr_sequencia	= nr_seq_requisicao_mat_p;
end if;

/*pls_gerar_ocorrencia(	nr_seq_segurado_w, nr_seq_requisicao_w, null,
			null, null, nr_seq_requisicao_mat_p, 
			null, null, nr_seq_material_w,
			ie_tipo_guia_w, nr_seq_plano_w, 'A',
			null, null, nr_seq_prestador_w,
			null,'I','',
			'',nm_usuario_p, cd_estabelecimento_p,
			nr_seq_uni_exec_w,'N', null, null, null);*/
			
CALL pls_gerar_ocorrencia_aut( nr_seq_segurado_w, nr_seq_requisicao_w, null,
			null, null, nr_seq_requisicao_mat_p,
			null, null, nr_seq_material_w,
			ie_tipo_guia_w, nr_seq_plano_w, 
			qt_dias_vencido_w, null, nr_seq_prestador_w,
			null,'I','',
			'',nm_usuario_p, cd_estabelecimento_p,
			nr_seq_congenere_w, ie_cheque_w, null);
			
select	ie_status
into STRICT	ie_status_w
from	pls_requisicao_mat
where	nr_sequencia = nr_seq_requisicao_mat_p;

if (ie_status_w not in ('A','N')) then
	--pls_obter_regra_exe_requisicao(cd_estabelecimento_p,0,0,nr_seq_material_w,nr_seq_grupo_execucao_w);
	if (ie_tipo_processo_w = 'I') and (ie_tipo_intercambio_w = 'I') and (ie_tipo_gat_w <> 'S') then
		update	pls_requisicao_mat
		set	ie_status		= 'I',
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p,			
			qt_material		= qt_solicitado
		where	nr_sequencia		= nr_seq_requisicao_mat_p;
	else
		update	pls_requisicao_mat
		set	ie_status		= 'S',
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p,			
			qt_material		= qt_solicitado
		where	nr_sequencia		= nr_seq_requisicao_mat_p;
	end if;
end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consistir_requisicao_mat ( nr_seq_requisicao_mat_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

