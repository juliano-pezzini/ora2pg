-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_valida_medico_importacao (( nr_seq_protocolo_p bigint, ie_tipo_medico_p text, nr_seq_proc_partic_p bigint, nr_seq_prestador_p bigint, nr_seq_conta_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, cd_medico_p INOUT bigint, cd_crm_p INOUT text ) is /*
Tipo medico
MS - Medico solicitante
ME - Medico executate
*/
 nr_seq_conta_w bigint) AS $body$
DECLARE

sg_conselho_w			tiss_conselho_profissional.sg_conselho%type;
nr_seq_conselho_ww		tiss_conselho_profissional.sg_conselho%type;

BEGIN
if (cd_versao_tiss_w >= '3.01.00') then
	select 	max(sg_conselho)
	into STRICT 	sg_conselho_w
	from 	tiss_conselho_profissional
	where 	cd_conselho = sg_conselho_p;

	select	max(nr_sequencia)
	into STRICT	nr_seq_conselho_ww
	from	conselho_profissional
	where	upper(coalesce(ie_conselho_prof_tiss, sg_conselho)) = upper(sg_conselho_w);
else
	select	max(nr_sequencia)
	into STRICT	nr_seq_conselho_ww
	from	conselho_profissional
	where	upper(coalesce(ie_conselho_prof_tiss, sg_conselho)) = upper(sg_conselho_p);
end if;
return;
end;

procedure	insert_especialidade(nr_seq_cbo_saude_p 	cbo_saude.nr_sequencia%type,
			cd_pessoa_fisica_p	pessoa_fisica.cd_pessoa_fisica%type) is
qt_especialidade	pls_integer;
qt_tiss_cbo_saude	pls_integer;
begin
if (cd_versao_tiss_w IS NOT NULL AND cd_versao_tiss_w::text <> '' AND cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
	if (nr_seq_cbo_saude_p IS NOT NULL AND nr_seq_cbo_saude_p::text <> '') then
		select 	max(cd_especialidade)
		into STRICT 	cd_especialidade_w
		from 	tiss_cbo_saude
		where 	nr_seq_cbo_saude = nr_seq_cbo_saude_p
		and	ie_versao = cd_versao_tiss_w
		and	coalesce(cd_pessoa_fisica::text, '') = '';
	end if;
	if (cd_especialidade_w IS NOT NULL AND cd_especialidade_w::text <> '') then

		select 	count(1)
		into STRICT	qt_especialidade
		from 	medico_especialidade a
		where	a.cd_pessoa_fisica 	= cd_pessoa_fisica_p
		and	a.cd_especialidade	= cd_especialidade_w;
		
		select 	count(1)
		into STRICT	qt_tiss_cbo_saude
		from 	tiss_cbo_saude a
		where	a.nr_seq_cbo_saude	= nr_seq_cbo_saude_p
		and	a.ie_versao		= cd_versao_tiss_w
		and	a.cd_pessoa_fisica	= cd_pessoa_fisica_p
		and	a.cd_especialidade	= cd_especialidade_w;
	
		if (qt_especialidade = 0) then
			insert into medico_especialidade(
				cd_pessoa_fisica,
				cd_especialidade,
				dt_atualizacao,
				nm_usuario,
				nr_seq_prioridade)
			values (cd_pessoa_fisica_p,
				cd_especialidade_w,
				clock_timestamp(),
				nm_usuario_p,
				1);
		end if;

		if (qt_tiss_cbo_saude = 0) then		
			insert into tiss_cbo_saude(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_cbo_saude,
				ie_versao,
				cd_pessoa_fisica,
				cd_especialidade,
				cd_convenio)
			values (nextval('tiss_cbo_saude_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_cbo_saude_p,
				cd_versao_tiss_w,
				cd_pessoa_fisica_p,
				cd_especialidade_w,
				null);
		end if;
	end if;
end if;
end;		
procedure	obter_regra(
		ie_tipo_guia_p 			pls_regra_medico_imp.ie_tipo_guia%type,
		nr_seq_tipo_atendimento_p 	pls_regra_medico_imp.nr_seq_tipo_atendimento%type,
		ie_tipo_medico_p 		pls_regra_medico_imp.ie_tipo_medico%type,
		cd_estab_p			estabelecimento.cd_estabelecimento%type,
		ie_restringe_estab_p		pls_controle_estab.ie_cad_conta_medica%type) is

c01 CURSOR(ie_tipo_guia_pc 		pls_regra_medico_imp.ie_tipo_guia%type,
		nr_seq_tipo_atendimento_pc 	pls_regra_medico_imp.nr_seq_tipo_atendimento%type,
		ie_tipo_medico_pc 		pls_regra_medico_imp.ie_tipo_medico%type,
		cd_estab_pc			estabelecimento.cd_estabelecimento%type,
		ie_restringe_estab_pc		pls_controle_estab.ie_cad_conta_medica%type) FOR
	-- primeira parte do union e para os casos onde NAO controla estabelecimento
	SELECT	t.nr_sequencia,
		t.ie_tipo_consistencia,
		t.ie_zero_esquerda,
		t.ie_vincula_cbo_xml,
		t.ie_consiste_nome
	from (	SELECT	a.nr_sequencia,
			a.ie_tipo_consistencia,
			a.ie_zero_esquerda,
			a.ie_vincula_cbo_xml,
			coalesce(a.nr_seq_tipo_atendimento,0) nr_seq_tipo_atendimento,
			coalesce(a.ie_tipo_guia,0) ie_tipo_guia,
			coalesce(a.ie_consiste_nome,'N') ie_consiste_nome
		from 	pls_regra_medico_imp a
		where	((a.ie_tipo_guia = ie_tipo_guia_pc) or (coalesce(a.ie_tipo_guia,0) = 0))
		and	((a.nr_seq_tipo_atendimento = nr_seq_tipo_atendimento_pc) or (coalesce(a.nr_seq_tipo_atendimento,0) = 0))
		and	a.ie_tipo_medico = ie_tipo_medico_pc
		and	a.ie_situacao = 'A'
		and	ie_restringe_estab_pc	= 'N'
		-- segunda parte, onde CONTROLA estabelecimento
		
union all

		select	a.nr_sequencia,
			a.ie_tipo_consistencia,
			a.ie_zero_esquerda,
			a.ie_vincula_cbo_xml,
			coalesce(a.nr_seq_tipo_atendimento,0) nr_seq_tipo_atendimento,
			coalesce(a.ie_tipo_guia,0) ie_tipo_guia,
			coalesce(a.ie_consiste_nome,'N') ie_consiste_nome
		from 	pls_regra_medico_imp a
		where	((a.ie_tipo_guia = ie_tipo_guia_pc) or (coalesce(a.ie_tipo_guia,0) = 0))
		and	((a.nr_seq_tipo_atendimento = nr_seq_tipo_atendimento_pc) or (coalesce(a.nr_seq_tipo_atendimento,0) = 0))
		and	a.ie_tipo_medico = ie_tipo_medico_pc
		and	a.ie_situacao = 'A'
		and	ie_restringe_estab_pc	= 'S'
		and	a.cd_estabelecimento	= cd_estab_pc
		order by	nr_seq_tipo_atendimento,
				ie_tipo_guia	) t;

begin
	open c01(ie_tipo_guia_p,
			nr_seq_tipo_atendimento_p,
			ie_tipo_medico_p,
			cd_estab_p,
			ie_restringe_estab_p);
	loop
	fetch c01 into
		nr_seq_regra_w,
		ie_tipo_consistencia_w,
		ie_zero_esquerda_w,
		ie_vincula_cbo_xml_w,
		ie_consiste_nome_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

	end loop;
	close c01;
end;
begin

if (nr_seq_protocolo_p IS NOT NULL AND nr_seq_protocolo_p::text <> '') then
	select	max(cd_versao_tiss)
	into STRICT	cd_versao_tiss_w
	from	pls_protocolo_conta
	where	nr_sequencia = nr_seq_protocolo_p;
elsif (nr_seq_conta_p IS NOT NULL AND nr_seq_conta_p::text <> '') then
	select	max(a.cd_versao_tiss)
	into STRICT	cd_versao_tiss_w
	from	pls_protocolo_conta a,
		pls_conta b
	where	a.nr_sequencia = b.nr_seq_protocolo
	and	b.nr_sequencia = nr_seq_conta_p;
elsif (nr_seq_proc_partic_p IS NOT NULL AND nr_seq_proc_partic_p::text <> '') then
	select	max(a.cd_versao_tiss)
	into STRICT	cd_versao_tiss_w
	from	pls_protocolo_conta a,
		pls_conta b,
		pls_conta_proc c,
		pls_proc_participante d
	where	a.nr_sequencia = b.nr_seq_protocolo
	and	b.nr_sequencia = c.nr_seq_conta
	and	c.nr_sequencia = d.nr_seq_conta_proc
	and	d.nr_sequencia = nr_seq_proc_partic_p;
end if;

ie_cad_conta_medica_w := pls_obter_se_controle_estab('CM');

if (ie_tipo_medico_p = 'MS') then
	begin
	select 	nr_crm_solic_imp,
		uf_crm_solic_imp,
		cd_cbo_saude_solic_imp,
		sg_conselho_solic_imp,
		nm_medico_solic_imp,
		nr_seq_tipo_atendimento,
		ie_tipo_atendimento_imp,
		ie_tipo_guia
	into STRICT	nr_crm_solic_imp_w,
		uf_crm_solic_imp_w,
		cd_cbo_saude_solic_imp_w,
		sg_conselho_solic_imp_w,
		nm_medico_solic_imp_w,
		nr_seq_tipo_atendimento_w,
		ie_tipo_atendimento_imp_w,
		ie_tipo_guia_w
	from 	pls_conta
	where 	nr_sequencia = nr_seq_conta_p;
	exception
	when others then
		nr_crm_solic_imp_w		:= null;
		uf_crm_solic_imp_w		:= null;
		cd_cbo_saude_solic_imp_w	:= null;
		sg_conselho_solic_imp_w		:= null;
		nm_medico_solic_imp_w		:= null;
	end;
	if (cd_versao_tiss_w >= '3.01.00') then
		uf_crm_solic_imp_w:=	pls_obter_sg_uf_tiss(uf_crm_solic_imp_w);
	end if;

	nr_crm_solic_imp_ww	:= pls_elimina_carac_espec_zero(nr_crm_solic_imp_w);

	select	max(nr_sequencia)
	into STRICT	nr_seq_tipo_atendimento_w
	from	pls_tipo_atendimento
	where	cd_tiss			= ie_tipo_atendimento_w
	and	cd_estabelecimento	= cd_estabelecimento_p;

	obter_regra(ie_tipo_guia_w,
			nr_seq_tipo_atendimento_w,
			ie_tipo_medico_p,
			cd_estabelecimento_p,
			ie_cad_conta_medica_w);

	select	max(nr_sequencia)
	into STRICT	nr_seq_tipo_atendimento_w
	from	pls_tipo_atendimento
	where	cd_tiss			= ie_tipo_atendimento_w
	and	cd_estabelecimento	= cd_estabelecimento_p;

	select	CASE WHEN ie_zero_esquerda_w='N' THEN elimina_caractere_especial(nr_crm_solic_imp_w)  ELSE nr_crm_solic_imp_ww END
	into STRICT	nr_crm_solic_ze_w
	;
	
	nm_medico_solic_imp_w := trim(both nm_medico_solic_imp_w);
	
	nr_seq_conselho_w:= obter_seq_conselho(sg_conselho_solic_imp_w);

	
	-- tratamento para os casos aonde tem o conselho OUT, que na ANS pode estar duplicado, replica da obter_seq_conselho declarada nesta mesma rotina
	if (cd_versao_tiss_w >= '3.01.00') then

		select	count(1)
		into STRICT	qt_conselho_rep_w
		from	conselho_profissional a
		where	upper(coalesce(a.ie_conselho_prof_tiss, a.sg_conselho)) = (	SELECT	upper(max(sg_conselho))
										from 	tiss_conselho_profissional
										where 	cd_conselho = sg_conselho_solic_imp_w);
	else
		-- caso for menor que a versao tiss acima, deve retornar zero
		qt_conselho_rep_w := 0;
	end if;
	
	if (coalesce(ie_consiste_nome_w,'N') = 'S') then
		select	max(cd_pessoa_fisica)
		into STRICT	cd_medico_solicitante_w
		from (	SELECT 	a.cd_pessoa_fisica
			from	medico 				a,
				pessoa_fisica 			b
			where	a.cd_pessoa_fisica		= b.cd_pessoa_fisica
			and	a.nr_crm			= nr_crm_solic_ze_w
			and	a.uf_crm			= uf_crm_solic_imp_w
			and	b.nr_seq_conselho		= nr_seq_conselho_w
			and	upper(b.nm_pessoa_fisica)	= upper(nm_medico_solic_imp_w)
			and	a.ie_situacao			= 'A'
			
union all

			SELECT 	a.cd_pessoa_fisica
			from	medico 				a,
				pessoa_fisica 			b
			where	a.cd_pessoa_fisica		= b.cd_pessoa_fisica
			and	a.nr_crm			= nr_crm_solic_ze_w
			and	a.uf_crm			= 'IN'
			and 	uf_crm_solic_imp_w  		= 'EX'
			and	b.nr_seq_conselho		= nr_seq_conselho_w
			and	upper(b.nm_pessoa_fisica)	= upper(nm_medico_solic_imp_w)
			and	a.ie_situacao			= 'A') alias7;

		
		-- tratamento para multiplos cadastros do conselho
		if (coalesce(cd_medico_solicitante_w::text, '') = '') and (qt_conselho_rep_w > 1) then

			select	max(cd_pessoa_fisica)
			into STRICT	cd_medico_solicitante_w
			from (	SELECT 	a.cd_pessoa_fisica
				from	medico 				a,
					pessoa_fisica 			b
				where	a.cd_pessoa_fisica		= b.cd_pessoa_fisica
				and	a.nr_crm			= nr_crm_solic_ze_w
				and	a.uf_crm			= uf_crm_solic_imp_w
				and	upper(b.nm_pessoa_fisica)	= upper(nm_medico_solic_imp_w)
				and	a.ie_situacao			= 'A'
				and	b.nr_seq_conselho		in (	select	x.nr_sequencia
										from	conselho_profissional	x
										where	upper(coalesce(x.ie_conselho_prof_tiss, x.sg_conselho)) = (	select	upper(max(y.sg_conselho))
																		from 	tiss_conselho_profissional	y
																		where 	y.cd_conselho	= sg_conselho_solic_imp_w))
				
union all

				SELECT 	a.cd_pessoa_fisica
				from	medico 				a,
					pessoa_fisica 			b
				where	a.cd_pessoa_fisica		= b.cd_pessoa_fisica
				and	a.nr_crm			= nr_crm_solic_ze_w
				and	a.uf_crm			= 'IN'
				and 	uf_crm_solic_imp_w  		= 'EX'
				and	upper(b.nm_pessoa_fisica)	= upper(nm_medico_solic_imp_w)
				and	a.ie_situacao			= 'A'
				and	b.nr_seq_conselho		in (	select	x.nr_sequencia
										from	conselho_profissional	x
										where	upper(coalesce(x.ie_conselho_prof_tiss, x.sg_conselho)) = (	select	upper(max(y.sg_conselho))
																		from 	tiss_conselho_profissional	y
																		where 	y.cd_conselho = sg_conselho_solic_imp_w))) alias20;

		end if;

			
		if (coalesce(cd_medico_solicitante_w::text, '') = '') then
			select	max(cd_pessoa_fisica)
			into STRICT	cd_medico_solicitante_w
			from (	SELECT 	a.cd_pessoa_fisica
				from	medico 				a,
					pessoa_fisica 			b
				where	a.cd_pessoa_fisica		= b.cd_pessoa_fisica
				and	a.nr_crm			= nr_crm_solic_ze_w
				and	a.uf_crm			= uf_crm_solic_imp_w
				and	b.nr_seq_conselho		= nr_seq_conselho_w
				and	upper(b.nm_pessoa_fisica)	= upper(nm_medico_solic_imp_w)
				
union all

				SELECT 	a.cd_pessoa_fisica
				from	medico 				a,
					pessoa_fisica 			b
				where	a.cd_pessoa_fisica		= b.cd_pessoa_fisica
				and	a.nr_crm			= nr_crm_solic_ze_w
				and	a.uf_crm			= 'IN'
				and 	uf_crm_solic_imp_w  		= 'EX'
				and	b.nr_seq_conselho		= nr_seq_conselho_w
				and	upper(b.nm_pessoa_fisica)	= upper(nm_medico_solic_imp_w)) alias7;


			-- tratamento para multiplos cadastros do conselho
			if (coalesce(cd_medico_solicitante_w::text, '') = '') and (qt_conselho_rep_w > 1) then

				select	max(cd_pessoa_fisica)
				into STRICT	cd_medico_solicitante_w
				from (	SELECT 	a.cd_pessoa_fisica
					from	medico 				a,
						pessoa_fisica 			b
					where	a.cd_pessoa_fisica		= b.cd_pessoa_fisica
					and	a.nr_crm			= nr_crm_solic_ze_w
					and	a.uf_crm			= uf_crm_solic_imp_w
					and	upper(b.nm_pessoa_fisica)	= upper(nm_medico_solic_imp_w)
					and	b.nr_seq_conselho		in (	select	x.nr_sequencia
											from	conselho_profissional	x
											where	upper(coalesce(x.ie_conselho_prof_tiss, x.sg_conselho)) = (	select	upper(max(y.sg_conselho))
																			from 	tiss_conselho_profissional	y
																			where 	y.cd_conselho	= sg_conselho_solic_imp_w))
					
union all

					SELECT 	a.cd_pessoa_fisica
					from	medico 				a,
						pessoa_fisica 			b
					where	a.cd_pessoa_fisica		= b.cd_pessoa_fisica
					and	a.nr_crm			= nr_crm_solic_ze_w
					and	a.uf_crm			= 'IN'
					and 	uf_crm_solic_imp_w  		= 'EX'
					and	upper(b.nm_pessoa_fisica)	= upper(nm_medico_solic_imp_w)
					and	b.nr_seq_conselho		in (	select	x.nr_sequencia
											from	conselho_profissional	x
											where	upper(coalesce(x.ie_conselho_prof_tiss, x.sg_conselho)) = (	select	upper(max(y.sg_conselho))
																			from 	tiss_conselho_profissional	y
																			where 	y.cd_conselho	= sg_conselho_solic_imp_w))) alias20;
			end if;
			
			if (coalesce(cd_medico_solicitante_w::text, '') = '') then	
				select	max(cd_pessoa_fisica)
				into STRICT	cd_medico_solicitante_w
				from (	SELECT 	a.cd_pessoa_fisica
					from	medico 			a,
						pessoa_fisica 		b
					where	a.cd_pessoa_fisica			= b.cd_pessoa_fisica
					and	a.nr_crm				= nr_crm_solic_ze_w
					and	a.uf_crm				= uf_crm_solic_imp_w
					and	b.nr_seq_conselho			= nr_seq_conselho_w
					and	upper(b.nm_pessoa_fisica_sem_acento)	= upper(nm_medico_solic_imp_w)
					and	a.ie_situacao				= 'A'
					
union all

					SELECT 	a.cd_pessoa_fisica
					from	medico 			a,
						pessoa_fisica 		b
					where	a.cd_pessoa_fisica			= b.cd_pessoa_fisica
					and	a.nr_crm				= nr_crm_solic_ze_w
					and	a.uf_crm				= 'IN'
					and 	uf_crm_solic_imp_w  			= 'EX'
					and	b.nr_seq_conselho			= nr_seq_conselho_w
					and	upper(b.nm_pessoa_fisica_sem_acento)	= upper(nm_medico_solic_imp_w)
					and	a.ie_situacao				= 'A') alias7;

				-- tratamento para multiplos cadastros do conselho
				if (coalesce(cd_medico_solicitante_w::text, '') = '') and (qt_conselho_rep_w > 1) then
						
					select	max(cd_pessoa_fisica)
					into STRICT	cd_medico_solicitante_w
					from (	SELECT 	a.cd_pessoa_fisica
						from	medico 			a,
							pessoa_fisica 		b
						where	a.cd_pessoa_fisica			= b.cd_pessoa_fisica
						and	a.nr_crm				= nr_crm_solic_ze_w
						and	a.uf_crm				= uf_crm_solic_imp_w
						and	upper(b.nm_pessoa_fisica_sem_acento)	= upper(nm_medico_solic_imp_w)
						and	a.ie_situacao				= 'A'
						and	b.nr_seq_conselho			in (	select	x.nr_sequencia
													from	conselho_profissional	x
													where	upper(coalesce(x.ie_conselho_prof_tiss, x.sg_conselho)) = (	select	upper(max(y.sg_conselho))
																					from 	tiss_conselho_profissional	y
																					where 	y.cd_conselho	= sg_conselho_solic_imp_w))
						
union all

						SELECT 	a.cd_pessoa_fisica
						from	medico 			a,
							pessoa_fisica 		b
						where	a.cd_pessoa_fisica			= b.cd_pessoa_fisica
						and	a.nr_crm				= nr_crm_solic_ze_w
						and	a.uf_crm				= 'IN'
						and 	uf_crm_solic_imp_w  			= 'EX'
						and	upper(b.nm_pessoa_fisica_sem_acento)	= upper(nm_medico_solic_imp_w)
						and	a.ie_situacao				= 'A'
						and	b.nr_seq_conselho			in (	select	x.nr_sequencia
													from	conselho_profissional	x
													where	upper(coalesce(x.ie_conselho_prof_tiss, x.sg_conselho)) = (	select	upper(max(y.sg_conselho))
																					from 	tiss_conselho_profissional	y
																					where 	y.cd_conselho	= sg_conselho_solic_imp_w))) alias20;
				end if;

				if (coalesce(cd_medico_solicitante_w::text, '') = '') then	
					select	max(cd_pessoa_fisica)
					into STRICT	cd_medico_solicitante_w
					from (	SELECT 	a.cd_pessoa_fisica
						from	medico 			a,
							pessoa_fisica 		b
						where	a.cd_pessoa_fisica			= b.cd_pessoa_fisica
						and	a.nr_crm				= nr_crm_solic_ze_w
						and	a.uf_crm				= uf_crm_solic_imp_w
						and	b.nr_seq_conselho			= nr_seq_conselho_w
						and	upper(b.nm_pessoa_fisica_sem_acento)	= upper(nm_medico_solic_imp_w)
						
union all

						SELECT 	a.cd_pessoa_fisica
						from	medico 			a,
							pessoa_fisica 		b
						where	a.cd_pessoa_fisica			= b.cd_pessoa_fisica
						and	a.nr_crm				= nr_crm_solic_ze_w
						and	a.uf_crm				= 'IN'
						and 	uf_crm_solic_imp_w  			= 'EX'
						and	b.nr_seq_conselho			= nr_seq_conselho_w
						and	upper(b.nm_pessoa_fisica_sem_acento)	= upper(nm_medico_solic_imp_w)) alias7;


					-- tratamento para multiplos cadastros do conselho
					if (coalesce(cd_medico_solicitante_w::text, '') = '') and (qt_conselho_rep_w > 1) then

						select	max(cd_pessoa_fisica)
						into STRICT	cd_medico_solicitante_w
						from (	SELECT 	a.cd_pessoa_fisica
							from	medico 			a,
								pessoa_fisica 		b
							where	a.cd_pessoa_fisica			= b.cd_pessoa_fisica
							and	a.nr_crm				= nr_crm_solic_ze_w
							and	a.uf_crm				= uf_crm_solic_imp_w
							and	upper(b.nm_pessoa_fisica_sem_acento)	= upper(nm_medico_solic_imp_w)
							and	b.nr_seq_conselho			in (	select	x.nr_sequencia
													from	conselho_profissional	x
													where	upper(coalesce(x.ie_conselho_prof_tiss, x.sg_conselho)) = (	select	upper(max(y.sg_conselho))
																					from 	tiss_conselho_profissional	y
																					where 	y.cd_conselho	= sg_conselho_solic_imp_w))
							
union all

							SELECT 	a.cd_pessoa_fisica
							from	medico 			a,
								pessoa_fisica 		b
							where	a.cd_pessoa_fisica			= b.cd_pessoa_fisica
							and	a.nr_crm				= nr_crm_solic_ze_w
							and	a.uf_crm				= 'IN'
							and 	uf_crm_solic_imp_w  			= 'EX'
							and	upper(b.nm_pessoa_fisica_sem_acento)	= upper(nm_medico_solic_imp_w)
							and	b.nr_seq_conselho			in (	select	x.nr_sequencia
													from	conselho_profissional	x
													where	upper(coalesce(x.ie_conselho_prof_tiss, x.sg_conselho)) = (	select	upper(max(y.sg_conselho))
																					from 	tiss_conselho_profissional	y
																					where 	y.cd_conselho	= sg_conselho_solic_imp_w))) alias20;
					end if;
						


				end if;
			end if;
		
		end if;
	else
		select	max(cd_pessoa_fisica)
		into STRICT	cd_medico_solicitante_w
		from (	SELECT 	a.cd_pessoa_fisica
			from	medico 			a,
				pessoa_fisica 		b
			where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
			and	a.nr_crm		= nr_crm_solic_ze_w
			and	a.uf_crm		= uf_crm_solic_imp_w
			and	b.nr_seq_conselho	= nr_seq_conselho_w
			and	a.ie_situacao		= 'A'
			
union all

			SELECT 	a.cd_pessoa_fisica
			from	medico 			a,
				pessoa_fisica 		b
			where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
			and	a.nr_crm		= nr_crm_solic_ze_w
			and	a.uf_crm		= 'IN'
			and 	uf_crm_solic_imp_w  	= 'EX'
			and	b.nr_seq_conselho	= nr_seq_conselho_w
			and	a.ie_situacao		= 'A') alias1;

		-- tratamento para multiplos cadastros do conselho
		if (coalesce(cd_medico_solicitante_w::text, '') = '') and (qt_conselho_rep_w > 1) then

			select	max(cd_pessoa_fisica)
			into STRICT	cd_medico_solicitante_w
			from (	SELECT 	a.cd_pessoa_fisica
				from	medico 			a,
					pessoa_fisica 		b
				where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
				and	a.nr_crm		= nr_crm_solic_ze_w
				and	a.uf_crm		= uf_crm_solic_imp_w
				and	a.ie_situacao		= 'A'
				and	b.nr_seq_conselho	in (	select	x.nr_sequencia
									from	conselho_profissional	x
									where	upper(coalesce(x.ie_conselho_prof_tiss, x.sg_conselho)) = (	select	upper(max(y.sg_conselho))
																	from 	tiss_conselho_profissional	y
																	where 	y.cd_conselho	= sg_conselho_solic_imp_w))
				
union all

				SELECT 	a.cd_pessoa_fisica
				from	medico 			a,
					pessoa_fisica 		b
				where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
				and	a.nr_crm		= nr_crm_solic_ze_w
				and	a.uf_crm		= 'IN'
				and 	uf_crm_solic_imp_w  	= 'EX'
				and	a.ie_situacao		= 'A'
				and	b.nr_seq_conselho	in (	select	x.nr_sequencia
									from	conselho_profissional	x
									where	upper(coalesce(x.ie_conselho_prof_tiss, x.sg_conselho)) = (	select	upper(max(y.sg_conselho))
																	from 	tiss_conselho_profissional	y
																	where 	y.cd_conselho	= sg_conselho_solic_imp_w))) alias16;
		end if;
			
		if (coalesce(cd_medico_solicitante_w::text, '') = '') then
			select	max(cd_pessoa_fisica)
			into STRICT	cd_medico_solicitante_w
			from (	SELECT 	a.cd_pessoa_fisica
				from	medico 			a,
					pessoa_fisica 		b
				where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
				and	a.nr_crm		= nr_crm_solic_ze_w
				and	a.uf_crm		= uf_crm_solic_imp_w
				and	b.nr_seq_conselho	= nr_seq_conselho_w
				
union all

				SELECT 	a.cd_pessoa_fisica
				from	medico 			a,
					pessoa_fisica 		b
				where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
				and	a.nr_crm		= nr_crm_solic_ze_w
				and	a.uf_crm		= 'IN'
				and 	uf_crm_solic_imp_w  	= 'EX'
				and	b.nr_seq_conselho	= nr_seq_conselho_w) alias3;
		
			-- tratamento para multiplos cadastros do conselho
			if (coalesce(cd_medico_solicitante_w::text, '') = '') and (qt_conselho_rep_w > 1) then

				select	max(cd_pessoa_fisica)
				into STRICT	cd_medico_solicitante_w
				from (	SELECT 	a.cd_pessoa_fisica
					from	medico 			a,
						pessoa_fisica 		b
					where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
					and	a.nr_crm		= nr_crm_solic_ze_w
					and	a.uf_crm		= uf_crm_solic_imp_w
					and	b.nr_seq_conselho	in (	select	x.nr_sequencia
										from	conselho_profissional	x
										where	upper(coalesce(x.ie_conselho_prof_tiss, x.sg_conselho)) = (	select	upper(max(y.sg_conselho))
																		from 	tiss_conselho_profissional	y
																		where 	y.cd_conselho	= sg_conselho_solic_imp_w))
					
union all

					SELECT 	a.cd_pessoa_fisica
					from	medico 			a,
						pessoa_fisica 		b
					where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
					and	a.nr_crm		= nr_crm_solic_ze_w
					and	a.uf_crm		= 'IN'
					and 	uf_crm_solic_imp_w  	= 'EX'
					and	b.nr_seq_conselho	in (	select	x.nr_sequencia
										from	conselho_profissional	x
										where	upper(coalesce(x.ie_conselho_prof_tiss, x.sg_conselho)) = (	select	upper(max(y.sg_conselho))
																		from 	tiss_conselho_profissional	y
																		where 	y.cd_conselho	= sg_conselho_solic_imp_w))) alias16;

			end if;
		end if;
			
	end if;

	cd_medico_p		:= cd_medico_solicitante_w;
	cd_crm_p		:= nr_crm_solic_ze_w;
	cd_pessoa_fisica_w	:= cd_medico_solicitante_w;

	if (ie_tipo_consistencia_w = 1) then
		if (coalesce(nr_seq_conselho_w,0) = 0) then
			CALL pls_gravar_conta_glosa('9915', nr_seq_conta_p, null,
						null, 'N', 'Conselho profissional do m'||chr(233)||'dico solicitante n'||chr(227)||'o informado ou n'||chr(227)||'o existente no padr'||chr(227)||'o TISS.' ,
						nm_usuario_p, 'A', 'IA',
						null, cd_estabelecimento_p, '', null);
		end if;

		if (coalesce(cd_medico_solicitante_w,0) = 0) then
			/*9906 - Medico solicitante nao informado*/

			CALL pls_gravar_conta_glosa('9906', nr_seq_conta_p, null,
					null, 'N', 'M'||chr(233)||'dico solicitante n'||chr(227)||'o informado ou n'||chr(227)||'o cadastrado' ,
					nm_usuario_p, 'A', 'IA',
					null, cd_estabelecimento_p, '', null);
		end if;
	elsif (ie_tipo_consistencia_w = 2) then

		if (coalesce(nr_seq_conselho_w,0) = 0) then
			CALL pls_gravar_conta_glosa('9915', nr_seq_conta_p, null,
						null, 'N', 'Conselho profissional do m'||chr(233)||'dico solicitante n'||chr(227)||'o informado ou n'||chr(227)||'o existente no padr'||chr(227)||'o TISS.' ,
						nm_usuario_p, 'A', 'IA',
						null, cd_estabelecimento_p, '', null);
		end if;

		if (coalesce(cd_medico_solicitante_w,0) = 0) then

			if (coalesce(nm_medico_solic_imp_w,'X') = 'X') then
				ds_observacao_w := 'Nome do m'||chr(233)||'dico';
			end if;

			if (coalesce(nr_seq_conselho_w,0) = 0) then
				if (coalesce(ds_observacao_w,'X') = 'X') then
					ds_observacao_w := 'Sigla do conselho';
				else
					ds_observacao_w := ds_observacao_w||', sigla do conselho';
				end if;
			end if;

			if (coalesce(nr_crm_solic_ze_w,'X') = 'X') then
				if (coalesce(ds_observacao_w,'X') = 'X') then
					ds_observacao_w := 'N'||chr(250)||'mero do conselho';
				else
					ds_observacao_w := ds_observacao_w||', n'||chr(250)||'mero do conselho';
				end if;
			end if;

			if (coalesce(nr_crm_solic_ze_w,'X') <> 'X') then
				select	count(1)
				into STRICT	qt_crm_w
				from	pls_ocorrencia_conta_atrib
				where	ie_atributo = 17
				and		ds_valor 	= nr_crm_solic_ze_w;

				if (qt_crm_w > 0) then
					if (coalesce(ds_observacao_w,'X') = 'X') then
						ds_observacao_w := 'N'||chr(250)||'mero do conselho';
					else
						ds_observacao_w := ds_observacao_w||', n'||chr(250)||'mero do conselho';
					end if;
				end if;

			end if;

			if (coalesce(uf_crm_solic_imp_w,'_X') = '_X') then
				if (coalesce(ds_observacao_w,'X') = 'X') then
					ds_observacao_w := 'Estado(UF) do conselho';
				else
					ds_observacao_w := ds_observacao_w||', estado(UF) do conselho';
				end if;
			end if;

			if (coalesce(ds_observacao_w,'X') = 'X') then
				begin
				select	count(1)
				into STRICT	qt_medico_w
				from	medico		a,
					pessoa_fisica	b
				where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
				and	a.nr_crm		= nr_crm_solic_ze_w
				and	a.uf_crm		= uf_crm_solic_imp_w
				and 	b.nr_seq_conselho 	= nr_seq_conselho_w;
				exception
				when others then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(235720);
				end;

				if (qt_medico_w > 0) then
					select	max(cd_pessoa_fisica)
					into STRICT	cd_pessoa_fisica_w
					from	medico
					where	nr_crm	= nr_crm_solic_ze_w
					and	uf_crm	= uf_crm_solic_imp_w;
				else

					select	nextval('pessoa_fisica_seq')
					into STRICT	cd_pessoa_fisica_w
					;

					insert into pessoa_fisica(
						cd_pessoa_fisica, nm_usuario, dt_atualizacao,
						nm_pessoa_fisica, ie_tipo_pessoa, nr_seq_conselho,
						nm_usuario_nrec, dt_atualizacao_nrec)
					values (	cd_pessoa_fisica_w, nm_usuario_p, clock_timestamp(),
						nm_medico_solic_imp_w, 1, nr_seq_conselho_w,
						nm_usuario_p, clock_timestamp());

					insert into medico(
						cd_pessoa_fisica,nr_crm, nm_guerra,
						ie_vinculo_medico, dt_atualizacao, nm_usuario,
						ie_corpo_clinico, ie_corpo_assist, uf_crm,
						ie_situacao, nm_usuario_nrec, dt_atualizacao_nrec)
					values (	cd_pessoa_fisica_w, nr_crm_solic_ze_w, nm_medico_solic_imp_w,
						9, clock_timestamp(), nm_usuario_p,
						'N', 'N', uf_crm_solic_imp_w,
						'A', nm_usuario_p, clock_timestamp());
						
					if (coalesce(ie_vincula_cbo_xml_w,'N') = 'S') then
						select	max(a.nr_sequencia)
						into STRICT	nr_seq_cbo_saude_w
						from	cbo_saude a
						where	a.cd_cbo	= cd_cbo_saude_solic_imp_w
						and	((a.ie_situacao = 'A') or (coalesce(a.ie_situacao::text, '') = ''));
					else
						nr_seq_cbo_saude_w := null;
					end if;		
					insert_especialidade(nr_seq_cbo_saude_w,cd_pessoa_fisica_w);
					
				end if;

				cd_medico_p	:= cd_pessoa_fisica_w;
				cd_crm_p	:= nr_crm_solic_ze_w;
			else

				CALL pls_gravar_conta_glosa('9906', nr_seq_conta_p, null,
							null, 'N', 'M'||chr(233)||'dico solicitante n'||chr(227)||'o informado ou n'||chr(227)||'o cadastrado. N'||chr(227)||'o existe dados suficientes para o cadastro do mesmo('||ds_observacao_w||').',
							nm_usuario_p, 'A', 'IA',
							null, cd_estabelecimento_p, '', null);
			end if;
		end if;
		
	end if;
end if;

if (ie_tipo_medico_p = 'ME') then
	if (nr_seq_proc_partic_p IS NOT NULL AND nr_seq_proc_partic_p::text <> '') then
		select	nr_cpf_imp,
			nr_crm_imp,
			uf_crm_imp,
			nm_medico_executor_imp,
			sg_conselho_imp,
			nr_seq_conta_proc,
			cd_cbo_saude_imp,
			cd_prestador_imp
		into STRICT	nr_cpf_exec_imp_w,
			nr_crm_exec_imp_w,
			uf_crm_exec_imp_w,
			nm_medico_exec_imp_w,
			sg_conselho_exec_imp_w,
			nr_seq_conta_proc_w,
			cd_cbo_saude_imp_w,
			cd_prestador_imp_w
		from	pls_proc_participante
		where	nr_sequencia = nr_seq_proc_partic_p;
		
		if (cd_versao_tiss_w >= '3.01.00') then
			uf_crm_exec_imp_w:=	pls_obter_sg_uf_tiss(uf_crm_exec_imp_w);
		end if;

		select	a.nr_seq_conta,
			b.ie_tipo_guia,
			b.ie_tipo_consulta,
			b.nr_seq_tipo_atendimento
		into STRICT	nr_seq_conta_w,
			ie_tipo_guia_w,
			ie_tipo_consulta_w,
			nr_seq_tipo_atendimento_w
		from	pls_conta_proc a,
			pls_conta b
		where 	b.nr_sequencia = a.nr_seq_conta
		and	a.nr_sequencia = nr_seq_conta_proc_w;

		obter_regra(ie_tipo_guia_w,
				nr_seq_tipo_atendimento_w,
				ie_tipo_medico_p,
				cd_estabelecimento_p,
				ie_cad_conta_medica_w);

		nr_crm_exec_imp_ww	:= pls_elimina_carac_espec_zero(nr_crm_exec_imp_w);

		select	CASE WHEN ie_zero_esquerda_w='N' THEN elimina_caractere_especial(nr_crm_exec_imp_w)  ELSE nr_crm_exec_imp_ww END
		into STRICT	nr_crm_exec_ze_w
		;

		if (cd_prestador_imp_w IS NOT NULL AND cd_prestador_imp_w::text <> '') then
			select	max(cd_pessoa_fisica)
			into STRICT	cd_medico_executor_w
			from	pls_prestador
			where	cd_prestador	= cd_prestador_imp_w;
		end if;
		
		nr_seq_conselho_w:= obter_seq_conselho(sg_conselho_exec_imp_w);	
		
		if (coalesce(cd_medico_executor_w::text, '') = '') then
			if (coalesce(ie_consiste_nome_w,'N') = 'S') then			
				select	max(cd_pessoa_fisica)
				into STRICT	cd_medico_executor_w
				from (	SELECT 	a.cd_pessoa_fisica
					from	medico 				a,
						pessoa_fisica 			b
					where	a.cd_pessoa_fisica		= b.cd_pessoa_fisica
					and	a.nr_crm			= nr_crm_exec_ze_w
					and	a.uf_crm			= uf_crm_exec_imp_w
					and	b.nr_seq_conselho		= nr_seq_conselho_w
					and	upper(b.nm_pessoa_fisica)	= upper(nm_medico_exec_imp_w)
					and	a.ie_situacao			= 'A'
					
union all

					SELECT 	a.cd_pessoa_fisica
					from	medico 				a,
						pessoa_fisica 			b
					where	a.cd_pessoa_fisica		= b.cd_pessoa_fisica
					and	a.nr_crm			= nr_crm_exec_ze_w
					and	a.uf_crm			= 'IN'
					and 	uf_crm_exec_imp_w  		= 'EX'
					and	b.nr_seq_conselho		= nr_seq_conselho_w
					and	upper(b.nm_pessoa_fisica)	= upper(nm_medico_exec_imp_w)
					and	a.ie_situacao			= 'A') alias9;
					
				if (coalesce(cd_medico_executor_w::text, '') = '') then
					select	max(cd_pessoa_fisica)
					into STRICT	cd_medico_executor_w
					from (	SELECT 	a.cd_pessoa_fisica
						from	medico 				a,
							pessoa_fisica 			b
						where	a.cd_pessoa_fisica		= b.cd_pessoa_fisica
						and	a.nr_crm			= nr_crm_exec_ze_w
						and	a.uf_crm			= uf_crm_exec_imp_w
						and	b.nr_seq_conselho		= nr_seq_conselho_w
						and	upper(b.nm_pessoa_fisica)	= upper(nm_medico_exec_imp_w)
						
union all

						SELECT 	a.cd_pessoa_fisica
						from	medico 				a,
							pessoa_fisica 			b
						where	a.cd_pessoa_fisica		= b.cd_pessoa_fisica
						and	a.nr_crm			= nr_crm_exec_ze_w
						and	a.uf_crm			= 'IN'
						and 	uf_crm_exec_imp_w  		= 'EX'
						and	b.nr_seq_conselho		= nr_seq_conselho_w
						and	upper(b.nm_pessoa_fisica)	= upper(nm_medico_exec_imp_w)) alias7;
					
					if (coalesce(cd_medico_executor_w::text, '') = '') then
						select	max(cd_pessoa_fisica)
						into STRICT	cd_medico_executor_w
						from (	SELECT 	a.cd_pessoa_fisica
							from	medico 			a,
								pessoa_fisica 		b
							where	a.cd_pessoa_fisica			= b.cd_pessoa_fisica
							and	a.nr_crm				= nr_crm_exec_ze_w
							and	a.uf_crm				= uf_crm_exec_imp_w
							and	b.nr_seq_conselho			= nr_seq_conselho_w
							and	upper(b.nm_pessoa_fisica_sem_acento)	= upper(nm_medico_exec_imp_w)
							and	a.ie_situacao				= 'A'
							
union all

							SELECT 	a.cd_pessoa_fisica
							from	medico 			a,
								pessoa_fisica 		b
							where	a.cd_pessoa_fisica			= b.cd_pessoa_fisica
							and	a.nr_crm				= nr_crm_exec_ze_w
							and	a.uf_crm				= 'IN'
							and 	uf_crm_exec_imp_w  			= 'EX'
							and	b.nr_seq_conselho			= nr_seq_conselho_w
							and	upper(b.nm_pessoa_fisica_sem_acento)	= upper(nm_medico_exec_imp_w)
							and	a.ie_situacao				= 'A') alias7;
						
							if (coalesce(cd_medico_executor_w::text, '') = '') then
								select	max(cd_pessoa_fisica)
								into STRICT	cd_medico_executor_w
								from (	SELECT 	a.cd_pessoa_fisica
									from	medico 			a,
										pessoa_fisica 		b
									where	a.cd_pessoa_fisica			= b.cd_pessoa_fisica
									and	a.nr_crm				= nr_crm_exec_ze_w
									and	a.uf_crm				= uf_crm_exec_imp_w
									and	b.nr_seq_conselho			= nr_seq_conselho_w
									and	upper(b.nm_pessoa_fisica_sem_acento)	= upper(nm_medico_exec_imp_w)
									
union all

									SELECT 	a.cd_pessoa_fisica
									from	medico 			a,
										pessoa_fisica 		b
									where	a.cd_pessoa_fisica			= b.cd_pessoa_fisica
									and	a.nr_crm				= nr_crm_exec_ze_w
									and	a.uf_crm				= 'IN'
									and 	uf_crm_exec_imp_w  			= 'EX'
									and	b.nr_seq_conselho			= nr_seq_conselho_w
									and	upper(b.nm_pessoa_fisica_sem_acento)	= upper(nm_medico_exec_imp_w)) alias7;
							end if;
					end if;
				end if;
			else			
				select	max(cd_pessoa_fisica)
				into STRICT	cd_medico_executor_w
				from (	SELECT 	a.cd_pessoa_fisica
					from	medico 			a,
						pessoa_fisica 		b
					where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
					and	a.nr_crm		= nr_crm_exec_ze_w
					and	a.uf_crm		= uf_crm_exec_imp_w
					and	b.nr_seq_conselho	= nr_seq_conselho_w
					and	a.ie_situacao		= 'A'
					
union all

					SELECT 	a.cd_pessoa_fisica
					from	medico 			a,
						pessoa_fisica 		b
					where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
					and	a.nr_crm		= nr_crm_exec_ze_w
					and	a.uf_crm		= 'IN'
					and 	uf_crm_exec_imp_w  	= 'EX'
					and	a.ie_situacao		= 'A'
					and	b.nr_seq_conselho	= nr_seq_conselho_w) alias1;
					
				if (coalesce(cd_medico_executor_w::text, '') = '') then
					select	max(cd_pessoa_fisica)
					into STRICT	cd_medico_executor_w
					from (	SELECT 	a.cd_pessoa_fisica
						from	medico 			a,
							pessoa_fisica 		b
						where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
						and	a.nr_crm		= nr_crm_exec_ze_w
						and	a.uf_crm		= uf_crm_exec_imp_w
						and	b.nr_seq_conselho	= nr_seq_conselho_w
						
union all

						SELECT 	a.cd_pessoa_fisica
						from	medico 			a,
							pessoa_fisica 		b
						where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
						and	a.nr_crm		= nr_crm_exec_ze_w
						and	a.uf_crm		= 'IN'
						and 	uf_crm_exec_imp_w  	= 'EX'
						and	b.nr_seq_conselho	= nr_seq_conselho_w) alias3;
				end if;
			end if;
		end if;

		if (coalesce(cd_medico_executor_w::text, '') = '') then
			select	max(b.cd_pessoa_fisica)
			into STRICT	cd_medico_executor_w
			from	medico 		b,
				pessoa_fisica	a
			where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
			and	a.nr_cpf		= nr_cpf_exec_imp_w;	
		end if;

		cd_medico_p 	:= cd_medico_executor_w;
		cd_crm_p	:= nr_crm_exec_ze_w;
		cd_pessoa_fisica_w:= cd_medico_executor_w;

			
		if (coalesce(nr_seq_regra_w,0) > 0) then
			if (ie_tipo_consistencia_w = 1) then
				if (coalesce(cd_medico_executor_w,0) <> 0) then --  so gerar a 9915 se existir um medico executor Demitrius OS - 412263
					if (coalesce(nr_seq_conselho_w,0) = 0) then
					CALL pls_gravar_conta_glosa('9915', nr_seq_conta_w, nr_seq_conta_proc_w,
								null, 'N', 'Conselho profissional do m'||chr(233)||'dico executante n'||chr(227)||'o informado ou n'||chr(227)||'o existente no padr'||chr(227)||'o TISS. (M'||chr(233)||'dico: ' || nm_medico_exec_imp_w||')',
								nm_usuario_p, 'A', 'IA',
								nr_seq_prestador_p, cd_estabelecimento_p, '', null);
					end if;
				else
					CALL pls_gravar_conta_glosa('9916', nr_seq_conta_w, nr_seq_conta_proc_w,
								null, 'N', 'M'||chr(233)||'dico: ' || nm_medico_exec_imp_w,
								nm_usuario_p, 'A', 'IA',
								nr_seq_prestador_p, cd_estabelecimento_p, '', null);
				end if;

			elsif (ie_tipo_consistencia_w = 2)  then

				if (coalesce(nr_seq_conselho_w,0) = 0) 	and (coalesce(cd_medico_executor_w,0) <> 0) then
					CALL pls_gravar_conta_glosa('9915', nr_seq_conta_w, nr_seq_conta_proc_w,
								null, 'N', 'Conselho profissional do m'||chr(233)||'dico executante n'||chr(227)||'o informado ou n'||chr(227)||'o existente no padr'||chr(227)||'o TISS. (M'||chr(233)||'dico: ' || nm_medico_exec_imp_w||')',
								nm_usuario_p, 'A', 'IA',
								nr_seq_prestador_p, cd_estabelecimento_p, '', null);
				end if;

				if (coalesce(cd_medico_executor_w,0) = 0) then

					if (coalesce(nm_medico_exec_imp_w,'X') = 'X') then
						ds_observacao_w := 'Nome do m'||chr(233)||'dico';
					end if;

					if (coalesce(nr_seq_conselho_w,0) = 0) then
						if (coalesce(ds_observacao_w,'X') = 'X') then
							ds_observacao_w := 'Sigla do conselho';
						else
							ds_observacao_w := ds_observacao_w||', sigla do conselho';
						end if;
					end if;

					if (coalesce(nr_crm_exec_ze_w,'X') = 'X') then
						if (coalesce(ds_observacao_w,'X') = 'X') then
							ds_observacao_w := 'N'||chr(250)||'mero do conselho';
						else
							ds_observacao_w := ds_observacao_w||', n'||chr(250)||'mero do conselho';
						end if;
					end if;

					if (coalesce(nr_crm_exec_ze_w,'X') <> 'X') then
						select	count(1)
						into STRICT	qt_crm_w
						from	pls_ocorrencia_conta_atrib
						where	ie_atributo = 17
						and		ds_valor 	= nr_crm_exec_ze_w;

						if (qt_crm_w > 0) then
							if (coalesce(ds_observacao_w,'X') = 'X') then
								ds_observacao_w := 'N'||chr(250)||'mero do conselho';
							else
								ds_observacao_w := ds_observacao_w||', n'||chr(250)||'mero do conselho';
							end if;
						end if;

					end if;

					if (coalesce(uf_crm_exec_imp_w,'_X') = '_X') then
						if (coalesce(ds_observacao_w,'X') = 'X') then
							ds_observacao_w := 'Estado(UF) do conselho';
						else
							ds_observacao_w := ds_observacao_w||', estado(UF) do conselho';
						end if;
					end if;

					if (coalesce(ds_observacao_w,'X') <> 'X') then
						/* 9916 - Profissional executante complementar nao informado */

						CALL pls_gravar_conta_glosa('9916', nr_seq_conta_p, null,
									null, 'N',
									'[1] M'||chr(233)||'dico executante n'||chr(227)||'o informado ou n'||chr(227)||'o cadastrado. N'||chr(227)||'o existe dados suficientes para o cadastro do mesmo('||ds_observacao_w||').',
									nm_usuario_p,'A','IA',
									nr_seq_prestador_p, cd_estabelecimento_p, '', null);
					else

						begin
						select	count(1)
						into STRICT	qt_medico_w
						from	medico		a,
							pessoa_fisica	b
						where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
						and	a.nr_crm		= nr_crm_exec_ze_w
						and	a.uf_crm		= uf_crm_exec_imp_w
						and 	b.nr_seq_conselho 	= nr_seq_conselho_w;
						exception
						when others then
							CALL wheb_mensagem_pck.exibir_mensagem_abort(235720);
						end;
						if (qt_medico_w > 0) then
							select	max(cd_pessoa_fisica)
							into STRICT	cd_pessoa_fisica_w
							from	medico
							where	nr_crm	= nr_crm_exec_ze_w
							and	uf_crm	= uf_crm_exec_imp_w;
						else
							select	nextval('pessoa_fisica_seq')
							into STRICT	cd_pessoa_fisica_w
							;


							insert into pessoa_fisica(
								cd_pessoa_fisica, nm_usuario, dt_atualizacao,
								nm_pessoa_fisica, ie_tipo_pessoa, nr_cpf,
								nr_seq_conselho, nm_usuario_nrec, dt_atualizacao_nrec)
							values (	cd_pessoa_fisica_w, nm_usuario_p, clock_timestamp(),
								nm_medico_exec_imp_w, 1, nr_cpf_exec_imp_w,
								nr_seq_conselho_w, nm_usuario_p, clock_timestamp());

							insert into medico(
								cd_pessoa_fisica,nr_crm, nm_guerra,
								ie_vinculo_medico, dt_atualizacao, nm_usuario,
								ie_corpo_clinico, ie_corpo_assist,uf_crm,
								ie_situacao, nm_usuario_nrec, dt_atualizacao_nrec)
							values (	cd_pessoa_fisica_w, nr_crm_exec_ze_w, nm_medico_exec_imp_w,
								9, clock_timestamp(), nm_usuario_p,
								'N', 'N', uf_crm_exec_imp_w,
								'A', nm_usuario_p, clock_timestamp());
								
							if (coalesce(ie_vincula_cbo_xml_w,'N') = 'S') then

								select	max(a.nr_sequencia)
								into STRICT	nr_seq_cbo_saude_partic_w
								from	cbo_saude a
								where	a.cd_cbo	= cd_cbo_saude_imp_w
								and	((a.ie_situacao = 'A') or (coalesce(a.ie_situacao::text, '') = ''));
							else
								nr_seq_cbo_saude_partic_w := null;
							end if;				
							insert_especialidade(nr_seq_cbo_saude_partic_w,cd_pessoa_fisica_w);								
							
						end if;

						cd_medico_p 	:= cd_pessoa_fisica_w;
						cd_crm_p	:= nr_crm_exec_ze_w;
					end if;
				end if;
			end if;
		else
			if (coalesce(cd_medico_executor_w,0) = 0) then
				CALL pls_gravar_conta_glosa('9918', nr_seq_conta_w, nr_seq_conta_proc_w,
						null, 'N', 'M'||chr(233)||'dico: ' || nm_medico_exec_imp_w,
						nm_usuario_p, 'A', 'IA',
						nr_seq_prestador_p, cd_estabelecimento_p, '', null);
			end if;
		end if;
	elsif (nr_seq_conta_p IS NOT NULL AND nr_seq_conta_p::text <> '') then

		select	nr_crm_exec_imp,
			uf_crm_exec_imp,
			sg_conselho_exec_imp,
			nm_medico_executor_imp,
			ie_tipo_guia,
			ie_tipo_consulta,
			nr_seq_tipo_atendimento,
			ie_tipo_atendimento_imp
		into STRICT	nr_crm_exec_imp_w,
			uf_crm_exec_imp_w,
			sg_conselho_exec_imp_w,
			nm_medico_exec_imp_w,
			ie_tipo_guia_w,
			ie_tipo_consulta_w,
			nr_seq_tipo_atendimento_w,
			ie_tipo_atendimento_imp_w
		from	pls_conta
		where	nr_sequencia	= nr_seq_conta_p;
		
		if ( cd_versao_tiss_w >= '3.01.00') then
			uf_crm_exec_imp_w:=	pls_obter_sg_uf_tiss(uf_crm_exec_imp_w);
		end if;

		obter_regra(ie_tipo_guia_w,
				nr_seq_tipo_atendimento_w,
				ie_tipo_medico_p,
				cd_estabelecimento_p,
				ie_cad_conta_medica_w);

		/*Diego OS 300602 - Obter se existem participantes. Se nao existir nem o paritcipantes nem o medico exec e gerado a glosa.*/

		select	CASE WHEN count(c.nr_sequencia)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_existe_participantes_w
		from	pls_conta a,
			pls_conta_proc b,
			pls_proc_participante c
		where	a.nr_sequencia	= b.nr_seq_conta
		and	b.nr_sequencia	= c.nr_seq_conta_proc
		and	a.nr_sequencia  = nr_seq_conta_p;

		nr_crm_exec_imp_ww	:= pls_elimina_carac_espec_zero(nr_crm_exec_imp_w);

		select	CASE WHEN ie_zero_esquerda_w='N' THEN elimina_caractere_especial(nr_crm_exec_imp_w)  ELSE nr_crm_exec_imp_ww END
		into STRICT	nr_crm_exec_ze_w
		;
		
		nr_seq_conselho_w := obter_seq_conselho(sg_conselho_exec_imp_w);
		--uf_crm_exec_imp_w:=	pls_obter_sg_uf_tiss(uf_crm_exec_imp_w);
		if (ie_existe_participantes_w = 'N') then
			if (coalesce(ie_consiste_nome_w,'N') = 'S') then
				select	max(a.cd_pessoa_fisica)
				into STRICT	cd_medico_executor_w
				from	medico 				a,
					pessoa_fisica 			b
				where	a.cd_pessoa_fisica		= b.cd_pessoa_fisica
				and	a.nr_crm			= nr_crm_exec_ze_w
				and	a.uf_crm			= uf_crm_exec_imp_w
				and	b.nr_seq_conselho		= nr_seq_conselho_w
				and	upper(b.nm_pessoa_fisica)	= upper(nm_medico_exec_imp_w)
				and	a.ie_situacao			= 'A';
				
				if (coalesce(cd_medico_executor_w::text, '') = '') then
					select	max(a.cd_pessoa_fisica)
					into STRICT	cd_medico_executor_w
					from	medico 				a,
						pessoa_fisica 			b
					where	a.cd_pessoa_fisica		= b.cd_pessoa_fisica
					and	a.nr_crm			= nr_crm_exec_ze_w
					and	a.uf_crm			= uf_crm_exec_imp_w
					and	b.nr_seq_conselho		= nr_seq_conselho_w
					and	upper(b.nm_pessoa_fisica)	= upper(nm_medico_exec_imp_w);
					
					if (coalesce(cd_medico_executor_w::text, '') = '') then

						select	max(a.cd_pessoa_fisica)
						into STRICT	cd_medico_executor_w
						from	medico 			a,
							pessoa_fisica 		b
						where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
						and	a.nr_crm		= nr_crm_exec_ze_w
						and	a.uf_crm		= uf_crm_exec_imp_w
						and	b.nr_seq_conselho	= nr_seq_conselho_w
						and	a.ie_situacao		= 'A';
						
						if (coalesce(cd_medico_executor_w::text, '') = '') then
							select	max(a.cd_pessoa_fisica)
							into STRICT	cd_medico_executor_w
							from	medico 			a,
								pessoa_fisica 		b
							where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
							and	a.nr_crm		= nr_crm_exec_ze_w
							and	a.uf_crm		= uf_crm_exec_imp_w
							and	b.nr_seq_conselho	= nr_seq_conselho_w;
						end if;
						
					end if;
				end if;
			else
				select	max(a.cd_pessoa_fisica)
				into STRICT	cd_medico_executor_w
				from	medico 			a,
					pessoa_fisica 		b
				where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
				and	a.nr_crm		= nr_crm_exec_ze_w
				and	a.uf_crm		= uf_crm_exec_imp_w
				and	b.nr_seq_conselho	= nr_seq_conselho_w
				and	a.ie_situacao		= 'A';
				
				if (coalesce(cd_medico_executor_w::text, '') = '') then
					select	max(a.cd_pessoa_fisica)
					into STRICT	cd_medico_executor_w
					from	medico 			a,
						pessoa_fisica 		b
					where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
					and	a.nr_crm		= nr_crm_exec_ze_w
					and	a.uf_crm		= uf_crm_exec_imp_w
					and	b.nr_seq_conselho	= nr_seq_conselho_w;
				end if;
			end if;

			cd_medico_p 	:= cd_medico_executor_w;
			cd_crm_p	:= nr_crm_exec_ze_w;
			
			cd_pessoa_fisica_w	:= cd_medico_executor_w;

			/*Diego OS 325798 - Consistencia do conselho segundo os padroes TISS.*/

			nr_seq_conselho_w:= obter_seq_conselho(sg_conselho_exec_imp_w);
			if (coalesce(nr_seq_regra_w,0) > 0) then
				if (ie_tipo_consistencia_w = 1) then
					if (coalesce(cd_medico_executor_w,0) <> 0) then
						if (coalesce(nr_seq_conselho_w,0) = 0) then
							CALL pls_gravar_conta_glosa('9915', nr_seq_conta_p, null,
										null, 'N', 'Conselho profissional do m'||chr(233)||'dico executante n'||chr(227)||'o informado ou n'||chr(227)||'o existente no padr'||chr(227)||'o TISS.' ,
										nm_usuario_p, 'A', 'IA',
										null, cd_estabelecimento_p, '', null);
						end if;
					else	/* 9916 - Profissional executante complementar nao informado */
						CALL pls_gravar_conta_glosa('9916', nr_seq_conta_p, null,
								null, 'N', '[2] M'||chr(233)||'dico executante n'||chr(227)||'o informado ou n'||chr(227)||'o cadastrado.',
								nm_usuario_p,'A','IA',
								nr_seq_prestador_p, cd_estabelecimento_p, '', null);
					end if;

				elsif (ie_tipo_consistencia_w = 2)  then
					if (coalesce(nr_seq_conselho_w,0) = 0) 	and (coalesce(cd_medico_executor_w,0) <> 0) then
						CALL pls_gravar_conta_glosa('9915', nr_seq_conta_p, null,
									null, 'N', 'Conselho profissional do m'||chr(233)||'dico executante n'||chr(227)||'o informado ou n'||chr(227)||'o existente no padr'||chr(227)||'o TISS.' ,
									nm_usuario_p, 'A', 'IA',
									null, cd_estabelecimento_p, '', null);
					end if;

					if (coalesce(cd_medico_executor_w,0) = 0) then

						if (coalesce(nm_medico_exec_imp_w,'X') = 'X') then
							ds_observacao_w := 'Nome do m'||chr(233)||'dico';
						end if;

						if (coalesce(nr_seq_conselho_w,0) = 0) then
							if (coalesce(ds_observacao_w,'X') = 'X') then
								ds_observacao_w := 'Sigla do conselho';
							else
								ds_observacao_w := ds_observacao_w||', sigla do conselho';
							end if;
						end if;

						if (coalesce(nr_crm_exec_ze_w,'X') = 'X') then
							if (coalesce(ds_observacao_w,'X') = 'X') then
								ds_observacao_w := 'N'||chr(250)||'mero do conselho';
							else
								ds_observacao_w := ds_observacao_w||', n'||chr(250)||'mero do conselho';
							end if;
						end if;

						if (coalesce(uf_crm_exec_imp_w,'_X') = '_X') then
							if (coalesce(ds_observacao_w,'X') = 'X') then
								ds_observacao_w := 'Estado(UF) do conselho';
							else
								ds_observacao_w := ds_observacao_w||', estado(UF) do conselho';
							end if;
						end if;

						if (coalesce(ds_observacao_w,'X') <> 'X') then
							/* 9916 - Profissional executante complementar nao informado */

							CALL pls_gravar_conta_glosa('9916', nr_seq_conta_p, null,
									null, 'N',
									'[3] M'||chr(233)||'dico executante n'||chr(227)||'o informado ou n'||chr(227)||'o cadastrado. N'||chr(227)||'o existe dados suficientes para o cadastro do mesmo('|| ds_observacao_w ||').',
									nm_usuario_p,'A','IA',
									nr_seq_prestador_p, cd_estabelecimento_p, '', null);
						else
							begin
							select	count(1)
							into STRICT	qt_medico_w
							from	medico		a,
								pessoa_fisica	b
							where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
							and	a.nr_crm		= nr_crm_exec_ze_w
							and	a.uf_crm		= uf_crm_exec_imp_w
							and 	b.nr_seq_conselho 	= nr_seq_conselho_w;
							exception
							when others then
								CALL wheb_mensagem_pck.exibir_mensagem_abort(235720);
							end;

							if (qt_medico_w > 0) then
								select	max(cd_pessoa_fisica)
								into STRICT	cd_pessoa_fisica_w
								from	medico
								where	nr_crm	= nr_crm_exec_ze_w
								and	uf_crm	= uf_crm_exec_imp_w;
							else
								select	nextval('pessoa_fisica_seq')
								into STRICT	cd_pessoa_fisica_w
								;

								insert into pessoa_fisica(
									cd_pessoa_fisica, nm_usuario, dt_atualizacao,
									nm_pessoa_fisica, ie_tipo_pessoa, nr_cpf,
									nr_seq_conselho, nm_usuario_nrec, dt_atualizacao_nrec)
								values (	cd_pessoa_fisica_w, nm_usuario_p, clock_timestamp(),
									nm_medico_exec_imp_w, 1, nr_cpf_exec_imp_w,
									nr_seq_conselho_w, nm_usuario_p, clock_timestamp());

								insert into medico(
									cd_pessoa_fisica,nr_crm, nm_guerra,
									ie_vinculo_medico, dt_atualizacao, nm_usuario,
									ie_corpo_clinico, ie_corpo_assist,uf_crm,
									ie_situacao, nm_usuario_nrec, dt_atualizacao_nrec)
								values (	cd_pessoa_fisica_w, nr_crm_exec_ze_w, nm_medico_exec_imp_w,
									9, clock_timestamp(), nm_usuario_p,
									'N', 'N', uf_crm_exec_imp_w,
									'S', nm_usuario_p, clock_timestamp());
									
								if (coalesce(ie_vincula_cbo_xml_w,'N') = 'S') then
									nr_seq_cbo_saude_w := pls_obter_dados_gerar_conta(nr_seq_conta_p, 'CBO');
								else
									nr_seq_cbo_saude_w := null;
								end if;
								insert_especialidade(nr_seq_cbo_saude_w, cd_pessoa_fisica_w);									
							end if;
							cd_medico_p 	:= cd_pessoa_fisica_w;
							cd_crm_p	:= nr_crm_exec_ze_w;
						end if;
					end if;
				end if;
			else
				/*Diego OS - 286039 - Tratamento realizado parta que se mantenha a mesma  consistencia existente.*/

				if (ie_tipo_atendimento_w = '04') and (coalesce(cd_medico_executor_w,0) = 0) then
					/* 9916 - Profissional executante complementar nao informado */

					CALL pls_gravar_conta_glosa('9916', nr_seq_conta_p, null,
								null, 'N',
								'[4] M'||chr(233)||'dico executante n'||chr(227)||'o informado ou n'||chr(227)||'o cadastrado.',
								nm_usuario_p,'A','IA',
								nr_seq_prestador_p, cd_estabelecimento_p, '', null);
				end if;
			end if;
		end if;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_valida_medico_importacao (( nr_seq_protocolo_p bigint, ie_tipo_medico_p text, nr_seq_proc_partic_p bigint, nr_seq_prestador_p bigint, nr_seq_conta_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, cd_medico_p INOUT bigint, cd_crm_p INOUT text ) is  nr_seq_conta_w bigint) FROM PUBLIC;

