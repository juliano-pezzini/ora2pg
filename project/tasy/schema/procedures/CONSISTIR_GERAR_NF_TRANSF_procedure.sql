-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_gerar_nf_transf ( nr_ordem_compra_p bigint, ie_opcao_gerar_itens_p text, ie_entrada_saida_p text, cd_estabelecimento_p text, cd_local_estoque_p bigint, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE


qt_item_baixado_w		bigint;
qt_item_ordem_w			bigint;
ds_material_w			material.ds_material%type;
cd_material_w			material.cd_material%type;
cd_material_estoque_w		material.cd_material%type;
nr_item_oci_w			ordem_compra_item.nr_item_oci%type;
qt_material_w			ordem_compra_item.qt_material%type;
qt_material_atendida_w		nota_fiscal_item.qt_item_estoque%type;
qt_material_consistida_w	nota_fiscal_item.qt_item_estoque%type;
cd_perfil_w			perfil.cd_perfil%type;
cd_local_estoque_w		local_estoque.cd_local_estoque%type;
ie_tipo_local_w			local_estoque.ie_tipo_local%type;
ie_gerar_itens_consistidos_w	varchar(15);
ie_consiste_qtd_maior_solic_w	varchar(15);
ie_consiste_nf_entrada_w	varchar(15) := 'N';
ie_consiste_nf_saida_w		varchar(15) := 'N';
ie_bloqueio_inventario_w	varchar(1) := 'N';
ds_erro_w			varchar(4000) := '';
ds_erro_2w			varchar(4000) := '';

C01 CURSOR FOR
SELECT	a.nr_item_oci,
	a.cd_material,
	substr(obter_desc_material(a.cd_material),1,255) ds_material,
	coalesce(obter_quantidade_convertida(a.cd_material,a.qt_material,a.cd_unidade_medida_compra,'UME'),0) qt_material
from	ordem_compra_item a,
	ordem_compra_item_cb b
where	a.nr_ordem_compra = b.nr_ordem_compra
and	a.nr_item_oci = b.nr_item_oci
and	a.nr_ordem_compra = nr_ordem_compra_p
and	coalesce(b.nr_seq_nota::text, '') = ''
and	b.ie_atende_recebe = 'A'
group by a.nr_ordem_compra,
	a.nr_item_oci,
	a.cd_material,
	a.qt_material,
	a.cd_unidade_medida_compra
order by a.nr_item_oci;

c02 CURSOR FOR
SELECT	distinct
	a.cd_material,
	substr(obter_desc_material(a.cd_material),1,255) ds_material,
	a.nr_item_oci
from	ordem_compra_item a,
	ordem_compra_item_entrega b
where	a.nr_ordem_compra = b.nr_ordem_compra
and	a.nr_item_oci = b.nr_item_oci
and	substr(obter_se_leitura_barras(cd_estabelecimento_p, a.cd_material, 146),1,1) = 'N'
and	a.nr_ordem_compra = nr_ordem_compra_p
and	coalesce(a.qt_material,0) > coalesce(a.qt_material_entregue,0)
and	coalesce(a.dt_reprovacao::text, '') = ''
and	coalesce(b.dt_cancelamento::text, '') = '';




BEGIN

cd_perfil_w			:= Obter_perfil_ativo;
ie_gerar_itens_consistidos_w 	:= substr(coalesce(obter_valor_param_usuario(146, 9, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p),'U'),1,1);
ie_consiste_qtd_maior_solic_w	:= substr(coalesce(obter_valor_param_usuario(146, 51, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p),'N'),1,1);
ie_consiste_nf_saida_w 		:= substr(coalesce(obter_valor_param_usuario(146, 100, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p),'N'),1,15);
ie_consiste_nf_entrada_w	:= substr(coalesce(obter_valor_param_usuario(146, 101, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p),'N'),1,15);

select	count(*)
into STRICT	qt_item_baixado_w
from	ordem_compra_item
where	nr_ordem_compra = nr_ordem_compra_p
and	obter_qt_oci_trans_nota(nr_ordem_compra,nr_item_oci,ie_entrada_saida_p) >= qt_material;

select	count(*)
into STRICT	qt_item_ordem_w
from	ordem_compra_item
where	nr_ordem_compra = nr_ordem_compra_p;

if (ie_entrada_saida_p = 'S') and
	((ie_gerar_itens_consistidos_w = 'C') or (ie_opcao_gerar_itens_p = 1)) then

	open C01;
	loop
	fetch C01 into
		nr_item_oci_w,
		cd_material_w,
		ds_material_w,
		qt_material_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		select	coalesce(sum(obter_quantidade_convertida(cd_material_w,qt_material,cd_unidade_medida_compra,'UME')),0)
		into STRICT	qt_material_consistida_w
		from	ordem_compra_item_cb
		where	nr_ordem_compra = nr_ordem_compra_p
		and	nr_item_oci = nr_item_oci_w
		and	coalesce(nr_seq_nota::text, '') = ''
		and	ie_atende_recebe = 'A';

		select	coalesce(sum(a.qt_item_estoque),0)
		into STRICT	qt_material_atendida_w
		from	nota_fiscal b,
			nota_fiscal_item a
		where	a.nr_ordem_compra = nr_ordem_compra_p
		and	a.nr_item_oci = nr_item_oci_w
		and	b.nr_sequencia = a.nr_sequencia
		and	b.ie_situacao = '1'
		and	obter_se_nota_entrada_saida(a.nr_sequencia) = 'S';

		if (qt_material_consistida_w = 0) then
			ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(280065) || nr_item_oci_w || '] ('||cd_material_w||') '|| ' ' || ds_material_w || ' ' || WHEB_MENSAGEM_PCK.get_texto(280068),1,4000);
		elsif (ie_consiste_qtd_maior_solic_w = 'S') and
			(qt_material_w < (qt_material_atendida_w + qt_material_consistida_w)) then
			ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(280065) || nr_item_oci_w || '] ('||cd_material_w||') ' || ' ' || ds_material_w || ' ' || WHEB_MENSAGEM_PCK.get_texto(280069),1,4000);
		end if;
		end;
	end loop;
	close C01;
end if;

if	((ie_consiste_nf_saida_w = 'S') or (ie_consiste_nf_entrada_w = 'S')) then

	open C02;
	loop
	fetch C02 into
		cd_material_w,
		ds_material_w,
		nr_item_oci_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		select	cd_material_estoque
		into STRICT	cd_material_estoque_w
		from	material
		where	cd_material = cd_material_w;

		if (ie_consiste_nf_saida_w = 'S') and (ie_entrada_saida_p = 'S') then

			select	coalesce(max(ie_tipo_local),0)
			into STRICT	ie_tipo_local_w
			from	local_estoque
			where	cd_local_estoque = cd_local_estoque_p;


			if (cd_local_estoque_p > 0) and (ie_tipo_local_w <> 8) then

				ie_bloqueio_inventario_w := sup_verifica_bloqueio_mat_inv(	cd_estabelecimento_p, pkg_date_utils.start_of(clock_timestamp(), 'MM', null), cd_local_estoque_p, cd_material_estoque_w, null, 'N', ie_bloqueio_inventario_w);

				if (ie_bloqueio_inventario_w = 'S') then
					ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(691434,'ds_material='||cd_material_w || ' - ' || ds_material_w) ,1,4000);
				end if;
			end if;
		end if;

		if (ie_consiste_nf_entrada_w = 'S') and (ie_entrada_saida_p = 'E') then

			select	coalesce(max(a.cd_local_estoque),0)
			into STRICT	cd_local_estoque_w
			from	ordem_compra_item a
			where	a.nr_ordem_compra = nr_ordem_compra_p
			and	a.nr_item_oci = nr_item_oci_w;

			select	coalesce(max(ie_tipo_local),0)
			into STRICT	ie_tipo_local_w
			from	local_estoque
			where	cd_local_estoque = cd_local_estoque_w;

			if (cd_local_estoque_w > 0) and (ie_tipo_local_w <> 8) then

				ie_bloqueio_inventario_w := sup_verifica_bloqueio_mat_inv(	cd_estabelecimento_p, pkg_date_utils.start_of(clock_timestamp(), 'MM', null), cd_local_estoque_w, cd_material_estoque_w, null, 'N', ie_bloqueio_inventario_w);

				if (ie_bloqueio_inventario_w = 'S') then
					ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(691434,'ds_material='||cd_material_w || ' - ' || ds_material_w) ,1,4000);
				end if;
			end if;
		end if;
		end;
	end loop;
	close C02;
end if;

if (qt_item_baixado_w = qt_item_ordem_w) and (ie_entrada_saida_p = 'S') then
	ds_erro_w	:= substr(WHEB_MENSAGEM_PCK.get_texto(280071),1,255);
elsif (qt_item_baixado_w = qt_item_ordem_w) and (ie_entrada_saida_p = 'E') then
	ds_erro_w	:= substr(WHEB_MENSAGEM_PCK.get_texto(280072),1,255);
end if;

/*retorno de procedure s√≥  pode contar 255 caracteres*/

ds_erro_p	:= substr(ds_erro_w,1,255);
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_gerar_nf_transf ( nr_ordem_compra_p bigint, ie_opcao_gerar_itens_p text, ie_entrada_saida_p text, cd_estabelecimento_p text, cd_local_estoque_p bigint, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

