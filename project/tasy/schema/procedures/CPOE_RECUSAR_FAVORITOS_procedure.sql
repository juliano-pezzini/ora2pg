-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_recusar_favoritos ( itens_liberar_p text, nm_usuario_p text) AS $body$
DECLARE

  obj RECORD;

BEGIN
for obj in (
	SELECT
	trim(both regexp_substr(str, '[^,]+', 1)) tp,
		(case trim(both regexp_substr(str, '[^,]+', 1)) when 'MA' then
			trim(both regexp_substr(str, '[^,]+', 3))
		else 
			trim(both regexp_substr(str, '[^,]+', 2))
		end) cd
	from (WITH RECURSIVE cte AS (
SELECT trim(both regexp_substr(str, '[^;]+', 1, 1)) str
	from (select itens_liberar_p str )(regexp_substr(str , '[^;]+', 1, level) IS NOT NULL AND (regexp_substr(str , '[^;]+', 1, level))::text <> '')  UNION ALL
SELECT trim(both regexp_substr(str, '[^;]+', 1, (c.level+1))) str
	from (select itens_liberar_p str ) JOIN cte c ON ()

) SELECT * FROM cte;
))
loop
	if (obj.tp IS NOT NULL AND obj.tp::text <> '') then
		if (obj.tp = 'MA' or obj.tp = 'M') then
			delete from cpoe_fav_material 
			where nr_sequencia = obj.cd 
			and nm_usuario = nm_usuario_p
			and coalesce(ie_pendente, 'N') = 'S';
		elsif (obj.tp = 'N') then
			delete from cpoe_fav_dieta 
			where nr_sequencia = obj.cd 
			and nm_usuario = nm_usuario_p
			and coalesce(ie_pendente, 'N') = 'S';
		elsif (obj.tp = 'P') then
			delete from cpoe_fav_procedimento 
			where nr_sequencia = obj.cd 
			and nm_usuario = nm_usuario_p
			and coalesce(ie_pendente, 'N') = 'S';
		elsif (obj.tp = 'G') then
			delete from cpoe_fav_gasoterapia 
			where nr_sequencia = obj.cd 
			and nm_usuario = nm_usuario_p
			and coalesce(ie_pendente, 'N') = 'S';
		elsif (obj.tp = 'R') then
			delete from cpoe_fav_recomendacao 
			where nr_sequencia = obj.cd 
			and nm_usuario = nm_usuario_p
			and coalesce(ie_pendente, 'N') = 'S';
		end if;
	end if;
end loop;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_recusar_favoritos ( itens_liberar_p text, nm_usuario_p text) FROM PUBLIC;

