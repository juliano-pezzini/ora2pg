-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fin_fechar_mes_estab_holding ( dt_referencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text, permite_abrir_estab_p text, ie_cp_cr_p text) AS $body$
DECLARE


ie_forma_fechamento_w	varchar(1);
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
nr_seq_fin_mes_ref_w	fin_mes_ref.nr_sequencia%type;
			
C01 CURSOR FOR
SELECT	cd_estabelecimento
from	estabelecimento
where	ie_situacao = 'A'
and		cd_empresa = obter_empresa_estab(cd_estabelecimento_p)
and (	permite_abrir_estab_p = 'F' and (cd_estab_financeiro = cd_estabelecimento_p or cd_estabelecimento = cd_estabelecimento_p))

union

select  b.cd_estabelecimento
FROM    estabelecimento b,
        GRUPO_EMP_ESTRUTURA a
WHERE   b.cd_empresa = a.cd_empresa
and     b.ie_situacao = 'A'
and		permite_abrir_estab_p = 'S'
and  a.nr_seq_grupo = holding_pck.get_grupo_emp_usuario(obter_empresa_estab(cd_estabelecimento_p))

union

select	cd_estabelecimento
from	estabelecimento
where	ie_situacao = 'A'
and		cd_empresa = obter_empresa_estab(cd_estabelecimento_p)
and		permite_abrir_estab_p = 'S';

  r RECORD;

BEGIN

open C01;
loop
fetch C01 into	
	cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	if (ie_cp_cr_p	= 'CR') then
	select	coalesce(max(ie_forma_fechamento),'M')
	into STRICT	ie_forma_fechamento_w
	from	parametro_contas_receber
	where	cd_estabelecimento	= cd_estabelecimento_p;
	elsif (ie_cp_cr_p	= 'CP') then
		select	coalesce(max(ie_forma_fechamento),'M')
		into STRICT	ie_forma_fechamento_w
		from	parametros_contas_pagar
		where	cd_estabelecimento	= cd_estabelecimento_p;
	elsif (ie_cp_cr_p	= 'A') then
		select	coalesce(max(ie_forma_fechamento),'M')
		into STRICT	ie_forma_fechamento_w
		from	parametro_contas_receber
		where	cd_estabelecimento	= cd_estabelecimento_p;
		
		if (ie_forma_fechamento_w = 'D') then
			select	coalesce(max(ie_forma_fechamento),'M')
			into STRICT	ie_forma_fechamento_w
			from	parametros_contas_pagar
			where	cd_estabelecimento	= cd_estabelecimento_p;	
		end if;		
	end if;

	if (ie_forma_fechamento_w = 'D') then
		update	fin_mes_ref
		set		dt_fechamento         	= clock_timestamp(),
				dt_atualizacao          = clock_timestamp(),
				nm_usuario_fechamento	= nm_usuario_p,
				nm_usuario            	= nm_usuario_p
		where	cd_estabelecimento 		= cd_estabelecimento_w
		and		trunc(dt_referencia, 'dd') = trunc(to_date(dt_referencia_p, 'dd/mm/yyyy'), 'dd');
		
		for r 	in (select nr_sequencia
					from fin_mes_ref 
					where cd_estabelecimento 		= cd_estabelecimento_w 
					and trunc(dt_referencia, 'dd') 	= trunc(to_date(dt_referencia_p, 'dd/mm/yyyy'), 'dd')) loop
			insert	into fin_mes_ref_hist(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_fin_mes,
				ds_historico)
				values (nextval('fin_mes_ref_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				r.nr_sequencia,
				OBTER_DESC_EXPRESSAO(728964));
		end loop;
		
	elsif (ie_forma_fechamento_w = 'M') then
		update	fin_mes_ref
		set		dt_fechamento         	= clock_timestamp(),
				dt_atualizacao		    = clock_timestamp(),
				nm_usuario_fechamento	= nm_usuario_p,
				nm_usuario            	= nm_usuario_p
		where	cd_estabelecimento 		= cd_estabelecimento_w
		and		dt_referencia = pkg_date_utils.start_of(dt_referencia_p, 'MONTH', 0);
		
		for r 	in (select nr_sequencia
					from fin_mes_ref 
					where cd_estabelecimento 	= cd_estabelecimento_w 
					and dt_referencia 			= pkg_date_utils.start_of(dt_referencia_p, 'MONTH', 0)) loop
			insert	into fin_mes_ref_hist(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_fin_mes,
				ds_historico)
				values (nextval('fin_mes_ref_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				r.nr_sequencia,
				OBTER_DESC_EXPRESSAO(728964));
		end loop;		
	end if;

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fin_fechar_mes_estab_holding ( dt_referencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text, permite_abrir_estab_p text, ie_cp_cr_p text) FROM PUBLIC;

