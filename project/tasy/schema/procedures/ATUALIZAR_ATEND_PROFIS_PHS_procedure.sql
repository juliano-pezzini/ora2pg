-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_atend_profis_phs ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, ie_profissional_p text, nm_usuario_p text, nr_seq_nursing_team_p bigint default null, nr_seq_phs_p atend_enfermagem_aux.nr_seq_phs%type DEFAULT NULL) AS $body$
DECLARE


cd_pessoa_fisica_w        varchar(10);

c01 CURSOR FOR
    SELECT  cd_pessoa_fisica
    from    atend_profissional
    where   nr_atendimento  = nr_atendimento_p
    and     ie_profissional = ie_profissional_p
    order by
            dt_inicio_vigencia;


BEGIN
	open C01;
        loop
            fetch C01 into
                cd_pessoa_fisica_w;
            EXIT WHEN NOT FOUND; /* apply on c01 */
        end loop;
	close c01;

    if (coalesce(cd_pessoa_fisica_w::text, '') = '') or (cd_pessoa_fisica_p <> cd_pessoa_fisica_w) then
        insert into atend_profissional(
            nr_sequencia,
            dt_atualizacao,
            nm_usuario,
            dt_atualizacao_nrec,
            nm_usuario_nrec,
            nr_atendimento,
            cd_pessoa_fisica,
            ie_profissional,
            dt_inicio_vigencia,
            ds_observacao,
            nr_seq_nursing_team,
            nr_seq_phs)
        values (
            nextval('atend_profissional_seq'),
            clock_timestamp(),
            nm_usuario_p,
            clock_timestamp(),
            nm_usuario_p,
            nr_atendimento_p,
            cd_pessoa_fisica_p,
            ie_profissional_p,
            clock_timestamp(),
            null,
            nr_seq_nursing_team_p,
            nr_seq_phs_p);
    end if;

    if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then
        commit;
    end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_atend_profis_phs ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, ie_profissional_p text, nm_usuario_p text, nr_seq_nursing_team_p bigint default null, nr_seq_phs_p atend_enfermagem_aux.nr_seq_phs%type DEFAULT NULL) FROM PUBLIC;

