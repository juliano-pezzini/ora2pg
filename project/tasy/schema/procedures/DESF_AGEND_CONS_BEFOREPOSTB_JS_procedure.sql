-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desf_agend_cons_beforepostb_js ( nr_atendimento_p bigint, ie_desfecho_p text, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_motivo_p bigint default 0, cd_cgc_p text default '', cd_medico_destino_p text default null) AS $body$
DECLARE

			 
cd_setor_transf_w			  varchar(10);
cd_setor_transf_int_w			bigint;
ie_tipo_atend_internado_w		bigint;
ie_desdobrar_conta_w			varchar(1) := 'N';
cd_motivo_alta_w				smallint;
ds_erro_alta_w					varchar(255);
cd_setor_transf_novo_atend_w	integer;
ie_escolhe_setor_internacao_w  varchar(1);
ie_gera_novo_atend_w	    varchar(1);
nr_atend_gerado_w	      bigint := 0;
ie_atualiza_novo_atend_w		varchar(1);
ie_atualiza_tipo_atend_w		varchar(1);
	

BEGIN 
 
cd_motivo_alta_w := obter_param_usuario(935, 43, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, cd_motivo_alta_w);
ie_escolhe_setor_internacao_w := obter_param_usuario(935, 44, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_escolhe_setor_internacao_w);
cd_setor_transf_w := obter_param_usuario(935, 57, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, cd_setor_transf_w);
ie_desdobrar_conta_w := obter_param_usuario(935, 62, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_desdobrar_conta_w);
ie_atualiza_novo_atend_w := obter_param_usuario(935, 72, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_atualiza_novo_atend_w);
ie_tipo_atend_internado_w := obter_param_usuario(935, 105, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_tipo_atend_internado_w);
ie_atualiza_tipo_atend_w := obter_param_usuario(935, 130, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_atualiza_tipo_atend_w);
 
if (ie_desfecho_p = 'I') then 
 
ds_erro_alta_w := '';
	if (cd_motivo_alta_w > 0) then 
		ds_erro_alta_w := gerar_estornar_alta(nr_atendimento_p, 'A', 0, cd_motivo_alta_w, clock_timestamp(), nm_usuario_p, ds_erro_alta_w, nr_seq_motivo_p, cd_cgc_p, null);
 
		cd_setor_transf_novo_atend_w := obter_regra_setor_desfecho(nr_atendimento_p, cd_setor_transf_novo_atend_w);
		 
		if (cd_setor_transf_novo_atend_w > 0) then 
			begin 
			CALL gerar_transf_novo_atend_pa(nr_atendimento_p, cd_setor_transf_novo_atend_w, nm_usuario_p);
			end;
		else 
			begin 
			if (ie_escolhe_setor_internacao_w = 'S') then 
				select	coalesce(ie_gera_novo_atend,'N') 
				into STRICT	ie_gera_novo_atend_w 
				from	motivo_alta 
				where	cd_motivo_alta = cd_motivo_alta_w;
				 
				if (ie_gera_novo_atend_w = 'S') then 
					select	max(nr_atendimento) 
					into STRICT	nr_atend_gerado_w 
					from	atendimento_paciente 
					where	nr_atend_alta = nr_atendimento_p;
					 
					if (ie_atualiza_novo_atend_w = 'S') and (nr_atend_gerado_w > 0) and (cd_medico_destino_p IS NOT NULL AND cd_medico_destino_p::text <> '') then 
						CALL assumir_paciente(nr_atend_gerado_w, cd_medico_destino_p, null, nm_usuario_p);
					end if;
				end if;
			end if;
			end;
		end if;
	end if;
	 
	begin 
		cd_setor_transf_int_w := (cd_setor_transf_w)::numeric;
	exception when others then 
		cd_setor_transf_int_w := 0;
	end;
 
	if (coalesce(cd_setor_transf_int_w,0) > 0) then 
		CALL gerar_transf_atend_pa(nr_atendimento_p,cd_setor_transf_int_w,nm_usuario_p);
	end if;
 
	if (coalesce(ie_tipo_atend_internado_w,0) > 0) then 
		CALL alterar_tipo_atend_novo_pa(nr_atendimento_p,ie_tipo_atend_internado_w,nm_usuario_p);
	end if;
	 
	if (ie_atualiza_tipo_atend_w = 'S') then 
		update atendimento_paciente 
		set  ie_tipo_atendimento = 1 
		where nr_atendimento = nr_atendimento_p;
		 
		commit;
	end if;
	 
	if (ie_desdobrar_conta_w = 'S') and (nr_atend_gerado_w = 0) then 
		CALL desdobrar_conta_paciente_pa(nr_atendimento_p,nm_usuario_p);
	end if;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desf_agend_cons_beforepostb_js ( nr_atendimento_p bigint, ie_desfecho_p text, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_motivo_p bigint default 0, cd_cgc_p text default '', cd_medico_destino_p text default null) FROM PUBLIC;

