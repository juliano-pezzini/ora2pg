-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_tipo_protocolo (cd_tipo_origem_p bigint, cd_tipo_destino_p bigint, ie_frase_padrao_p text, ie_subtipo_itens_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_copia_estabelecimento_p text) AS $body$
DECLARE


cd_protocolo_dest_w	bigint;
nr_sequencia_w		bigint;
cd_pessoa_fisica_w	varchar(10);

nm_protocolo_w		bigint;
ds_prim_horario_w	varchar(5);
ie_situacao_w		varchar(1);
ie_exige_grupo_desc_w   varchar(1);
ie_codigo_interno_w	varchar(1);
ds_ref_bibliog_w	varchar(1);
ie_tipo_atendimento_w	smallint;
ie_forma_autor_quimio_w	varchar(1);
ie_clinica_w		bigint;
ds_arquivo_w		varchar(255);
cd_setor_atendimento_w	integer;
cd_estabelecimento_w	smallint;
cd_especialidade_w 	integer;
ie_obrigatorio_w	varchar(1);

C01 CURSOR FOR
	SELECT 	nm_protocolo,
		ds_prim_horario,
		ie_situacao,
		ie_exige_grupo_desc,
		ie_codigo_interno,
		ds_ref_bibliog,
		ie_tipo_atendimento,
		ie_forma_autor_quimio,
		ie_clinica,
		ds_arquivo,
		cd_setor_atendimento,
		cd_estabelecimento,
		cd_especialidade,
		ie_obrigatorio	,
		cd_protocolo
	from	protocolo
	where	cd_tipo_protocolo	= cd_tipo_origem_p
	and	((ie_copia_estabelecimento_p	= 'N') or (cd_estabelecimento	= cd_estabelecimento_p) or (coalesce(cd_estabelecimento::text, '') = ''))
	order by cd_protocolo;

Cw01	C01%RowType;


BEGIN
select	max(cd_pessoa_fisica)
into STRICT	cd_pessoa_fisica_w
from	usuario
where	nm_usuario	= nm_usuario_p;


open	c01;
loop
fetch	c01 into
	Cw01;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	select	nextval('protocolo_seq')
	into STRICT	cd_protocolo_dest_w
	;

	select	coalesce(max(nr_sequencia),0) + 1
	into STRICT	nr_sequencia_w
	from	protocolo
	where	cd_tipo_protocolo	= cd_tipo_destino_p;


	insert	into protocolo(CD_PROTOCOLO,
		NM_PROTOCOLO,
		CD_TIPO_PROTOCOLO,
		NR_SEQUENCIA,
		DT_ATUALIZACAO,
		NM_USUARIO,
		DS_PROTOCOLO,
		DS_PRIM_HORARIO,
		IE_SITUACAO,
		IE_EXIGE_GRUPO_DESC,
		ie_codigo_interno,
		ds_ref_bibliog,
		cd_pessoa_criacao,
		cd_estabelecimento,
		nr_seq_apres)
	values (cd_protocolo_dest_w,
		Cw01.nm_protocolo,
		cd_tipo_destino_p,
		nr_sequencia_w,
		clock_timestamp(),
		nm_usuario_p,
		null,
		Cw01.ds_prim_horario,
		Cw01.ie_situacao,
		Cw01.ie_exige_grupo_desc,
		Cw01.ie_codigo_interno,
		Cw01.ds_ref_bibliog,
		cd_pessoa_fisica_w,
		cd_estabelecimento_p,
		999);


	CALL COPIA_CAMPO_LONG_DE_PARA('protocolo','ds_protocolo','where CD_PROTOCOLO =:CD_PROTOCOLO',
	'CD_PROTOCOLO='||Cw01.CD_PROTOCOLO||';','protocolo','ds_protocolo','where CD_PROTOCOLO =:CD_PROTOCOLO',
	'CD_PROTOCOLO='||cd_protocolo_dest_w||';');

	if (ie_frase_padrao_p = 'S') then
		CALL Copiar_Protocolo_Descricao(Cw01.cd_protocolo, cd_protocolo_dest_w, nm_usuario_p);
	end if;

	if (ie_subtipo_itens_p = 'S') then
		CALL copiar_protocolo(Cw01.cd_protocolo, nm_usuario_p, cd_protocolo_dest_w);
	end if;

	end;
end loop;
close	c01;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_tipo_protocolo (cd_tipo_origem_p bigint, cd_tipo_destino_p bigint, ie_frase_padrao_p text, ie_subtipo_itens_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_copia_estabelecimento_p text) FROM PUBLIC;

