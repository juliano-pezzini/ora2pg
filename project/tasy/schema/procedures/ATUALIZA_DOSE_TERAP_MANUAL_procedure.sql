-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_dose_terap_manual ( nr_prescricao_p bigint, nr_seq_solucao_p bigint, qt_dose_terap_p bigint, qt_peso_p bigint, nr_horas_validade_p bigint, nr_unid_terapeutica_p bigint, qt_dosagem_p bigint, ie_bomba_infusao_p text, ie_tipo_dosagem_p text, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE



nr_sequencia_w			double precision;
nr_seq_medic_w			double precision;
nr_seq_dilu_w			double precision;
cd_material_w			double precision;
cd_material_medic_w		double precision;
cd_material_dilu_w		double precision;
ie_ancora_solucao_w		varchar(1);
ie_calc_auto_w			varchar(1);
qt_corrigido_terap_w	double precision;
qt_diluente_w			double precision;
qt_corrigido_dilu_w		double precision;
qt_total_dose_w 		double precision;
qt_total_corrigido_w 	double precision;
qt_micrograma_w 		double precision;
qt_micro_corrigido_w	double precision;
qt_dose_terap_w			double precision;
qt_dose_medic_w			double precision;
qt_dose_dilu_w			double precision;
qt_vol_corr_medic_w		double precision;
qt_equipo_w				double precision;
qt_vol_corr_dilu_w		double precision;
qt_fator_correcao_w		double precision;
qt_volume_total_w		double precision;
qt_volume_tot_disp_w	double precision;
qt_peso_w				double precision;

C01 CURSOR FOR
	SELECT	coalesce(a.nr_sequencia,0),
			coalesce(a.cd_material,0),
			coalesce(b.ie_ancora_solucao,'N') ie_ancora
	from	prescr_material a,
			material b
	where	coalesce(ie_suspenso,'N') <> 'S'
	and		nr_sequencia_solucao = nr_seq_solucao_p
	and		nr_prescricao = nr_prescricao_p
	and		a.cd_material = b.cd_material
	order by ie_ancora desc;

BEGIN

Select 	coalesce(qt_peso_p,max(obter_peso_pf(cd_pessoa_fisica)))
into STRICT	qt_peso_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

Select 	coalesce(max(ie_calc_aut),'N')
into STRICT	ie_calc_auto_w
from	prescr_solucao
where	nr_prescricao = nr_prescricao_p
and		nr_seq_solucao = nr_seq_solucao_p;

if (ie_calc_auto_w = 'N') then
	open C01;
	loop
	fetch C01 into
		nr_sequencia_w,
		cd_material_w,
		ie_ancora_solucao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		if (cd_material_w > 0) and (qt_peso_w > 0) and (nr_horas_validade_p > 0) and (nr_unid_terapeutica_p > 0) and (qt_dosagem_p > 0) and (ie_bomba_infusao_p IS NOT NULL AND ie_bomba_infusao_p::text <> '') and (ie_tipo_dosagem_p IS NOT NULL AND ie_tipo_dosagem_p::text <> '') then
			qt_dose_terap_w		:= qt_dose_terap_p;
			if (ie_ancora_solucao_w = 'S') then
				SELECT * FROM Calcular_dose_medic_terap(  cd_material_w, qt_dose_terap_w, qt_peso_w, nr_horas_validade_p, nr_unid_terapeutica_p, qt_dosagem_p, ie_bomba_infusao_p, ie_tipo_dosagem_p, qt_corrigido_terap_w, qt_diluente_w, qt_corrigido_dilu_w, qt_total_dose_w, qt_total_corrigido_w, qt_micrograma_w, qt_micro_corrigido_w) INTO STRICT qt_dose_terap_w, qt_corrigido_terap_w, qt_diluente_w, qt_corrigido_dilu_w, qt_total_dose_w, qt_total_corrigido_w, qt_micrograma_w, qt_micro_corrigido_w;
			end if;


			if (qt_diluente_w < 0) or (qt_corrigido_dilu_w < 0) then
				ds_erro_p := substr(wheb_mensagem_pck.get_texto(278944),1,255);
				--Wheb_mensagem_pck.exibir_mensagem_abort(256527);
			end if;

			if (qt_dose_terap_w > 0) and (qt_corrigido_terap_w > 0) and (qt_diluente_w > 0) and (qt_corrigido_dilu_w > 0) then

				if (ie_ancora_solucao_w = 'S') then
					update	prescr_material
					set		qt_dose 	= qt_dose_terap_w,
							qt_unitaria = qt_dose_terap_w,
							qt_solucao  = qt_dose_terap_w,
							qt_volume_corrigido = qt_corrigido_terap_w,
							cd_unidade_medida_Dose = obter_unid_med_usua('ml')
					where	nr_prescricao = nr_prescricao_p
					and		nr_sequencia = nr_sequencia_w;
				else
					update	prescr_material
					set		qt_dose 	= qt_diluente_w,
							qt_unitaria = qt_diluente_w,
							qt_solucao  = qt_diluente_w,
							qt_volume_corrigido = qt_corrigido_dilu_w,
							cd_unidade_medida_Dose = obter_unid_med_usua('ml')
					where	nr_prescricao = nr_prescricao_p
					and		nr_sequencia = nr_sequencia_w;
				end if;

				update	prescr_solucao
				set		qt_solucao_total 	 = qt_total_dose_w,
						qt_volume			 = qt_total_dose_w,
						qt_volume_corrigido  = qt_total_corrigido_w,
						qt_dose_terapeutica  = qt_dose_terap_p,
						nr_unid_terapeutica  = nr_unid_terapeutica_p,
						qt_dosagem    		 = qt_dosagem_p,
						ie_tipo_dosagem		 = ie_tipo_dosagem_p,
						ie_bomba_infusao	 = ie_bomba_infusao_p
				where 	nr_prescricao  		 = nr_prescricao_p
				and		nr_seq_solucao 		 = nr_seq_solucao_p;
			end if;
		end if;

		end;
	end loop;
	close C01;
else
	select	coalesce(max(a.nr_sequencia),0),
			coalesce(max(a.cd_material),0),
			coalesce(max(a.qt_solucao),0),
			coalesce(max(a.qt_volume_corrigido),0)
	into STRICT	nr_seq_medic_w,
			cd_material_medic_w,
			qt_dose_medic_w,
			qt_vol_corr_medic_w
	from	prescr_material a,
			material b
	where	coalesce(ie_suspenso,'N') <> 'S'
	and		nr_sequencia_solucao = nr_seq_solucao_p
	and		nr_prescricao = nr_prescricao_p
	and		a.cd_material = b.cd_material
	and		coalesce(b.ie_ancora_solucao,'N') = 'S';

	select	coalesce(max(a.nr_sequencia),0),
			coalesce(max(a.cd_material),0),
			coalesce(max(a.qt_solucao),0),
			coalesce(max(a.qt_volume_corrigido),0)
	into STRICT	nr_seq_dilu_w,
			cd_material_dilu_w,
			qt_dose_dilu_w,
			qt_vol_corr_dilu_w
	from	prescr_material a,
			material b
	where	coalesce(ie_suspenso,'N') <> 'S'
	and		nr_sequencia_solucao = nr_seq_solucao_p
	and		nr_prescricao = nr_prescricao_p
	and		a.cd_material = b.cd_material
	and		coalesce(b.ie_ancora_solucao,'N') = 'N';

	select 	coalesce(max(qt_equipo),0)
	into STRICT	qt_equipo_w
	from	rep_dispositivo
	where	ie_bomba_infusao = ie_bomba_infusao_p
	and 	ie_tipo_item 	= 1;


	qt_volume_total_w 	 := qt_dose_medic_w + qt_dose_dilu_w;
	qt_volume_tot_disp_w := qt_volume_total_w + qt_equipo_w;
	qt_fator_correcao_w	 := qt_volume_tot_disp_w / qt_volume_total_w;
	qt_corrigido_terap_w := qt_dose_medic_w * qt_fator_correcao_w;
	qt_corrigido_dilu_w  := qt_dose_dilu_w * qt_fator_correcao_w;


	if (nr_seq_medic_w > 0) then
		update	prescr_material
		set		qt_volume_corrigido = qt_corrigido_terap_w
		where	nr_prescricao 		= nr_prescricao_p
		and		nr_sequencia		= nr_seq_medic_w;
	end if;

	if (nr_seq_dilu_w > 0) then
		update	prescr_material
		set		qt_volume_corrigido = qt_corrigido_dilu_w
		where	nr_prescricao 		= nr_prescricao_p
		and		nr_sequencia 		= nr_sequencia_w;
	end if;

end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_dose_terap_manual ( nr_prescricao_p bigint, nr_seq_solucao_p bigint, qt_dose_terap_p bigint, qt_peso_p bigint, nr_horas_validade_p bigint, nr_unid_terapeutica_p bigint, qt_dosagem_p bigint, ie_bomba_infusao_p text, ie_tipo_dosagem_p text, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

