-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_ajustar_valores_comissao ( nr_seq_comissao_p pls_comissao.nr_sequencia%type, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

			 
/* Finalidade: 
	Na função OPS - Controle de Comissões de Venda, quando as comissões são geradas e algum lançamento adicional for gerado na pasta Comissôes > Lançamentos adicionais , 
	o valor do lançamento será descontado/somado ao valor total da comissão, sendo assim, os valores de comissão de cada beneficiário também precisam ser ajustados de modo que a 
	soma das comissões de cada beneficiário seja igual ao total comissionado. 
*/
 
 
-- Campos do cursor 1 
nr_seq_comiss_benef_w		pls_comissao_beneficiario.nr_sequencia%type;
vl_comiss_benef_w		pls_comissao_beneficiario.vl_comissao_benef%type;

-- Campos do cursor 2 
nr_titulo_w			pls_repasse_lanc.nr_titulo%type;
vl_desconto_tit_w		pls_repasse_lanc.vl_lancamento%type;
vl_lanc_aplicado_w		pls_repasse_lanc.vl_lanc_aplicado%type;

vl_lancamento_w			pls_repasse_lanc.vl_lancamento%type;
vl_comissao_canal_w		pls_comissao.vl_comissao_canal%type;
vl_item_mensalidade_w		pls_comissao_benef_item.vl_item_mensalidade%type;
vl_comissao_benef_w		pls_comissao_beneficiario.vl_comissao_benef%type;
vl_comis_benef_ajust_w		pls_comissao_beneficiario.vl_comissao_benef%type;
vl_comiss_item_benef_w		pls_comissao_benef_item.vl_comissao%type;
nr_seq_item_w			pls_comissao_benef_item.nr_sequencia%type;
ie_valor_percent_desconto_w	pls_parametros.ie_valor_percent_desconto%type;
vl_total_w			double precision;

C01 CURSOR FOR 
	SELECT	nr_sequencia, 
		vl_comissao_benef 
	from	pls_comissao_beneficiario 
	where	nr_seq_comissao = nr_seq_comissao_p;
	
C02 CURSOR FOR 
	SELECT	distinct nr_titulo, 
		sum(vl_lancamento), 
		sum(vl_lanc_aplicado) 
	from	pls_repasse_lanc 
	where	nr_seq_comissao = nr_seq_comissao_p 
	and	ie_tipo_lancamento = '3' 
	group by nr_titulo;
			

BEGIN 
 
select	sum(vl_lancamento)											 
into STRICT	vl_lancamento_w 
from	pls_repasse_lanc 
where	nr_seq_comissao = nr_seq_comissao_p 
and	ie_tipo_lancamento not in ('3','5'); -- 3 - Desconto referente ao desconto concedido ao título a receber / 5 - Acréscimo referente aos juros e multas do título a receber 
if (coalesce(vl_lancamento_w,0) <> 0) then 
 
	update	pls_comissao 
	set	vl_comissao_canal = vl_comissao_canal + coalesce(vl_lancamento_w,0) 
	where	nr_sequencia = nr_seq_comissao_p;
 
	select	vl_comissao_canal 
	into STRICT	vl_comissao_canal_w 
	from	pls_comissao 
	where	nr_sequencia = nr_seq_comissao_p;
	 
	select	sum(vl_comissao_benef) 
	into STRICT	vl_comissao_benef_w 
	from	pls_comissao_beneficiario 
	where	nr_seq_comissao = nr_seq_comissao_p;
	 
	--Se o valor total da comissão não for igual ao total comissionado nos beneficiários... 
	if (vl_comissao_canal_w <> vl_comissao_benef_w) and (coalesce(vl_comissao_benef_w,0) > 0) then	 
			 
		update	pls_comissao_beneficiario 
		set	vl_comissao_benef = (vl_comissao_canal_w * vl_comissao_benef) / vl_comissao_benef_w 
		where	nr_seq_comissao = nr_seq_comissao_p;
				 
		select	sum(vl_comissao_benef) 
		into STRICT	vl_comis_benef_ajust_w 
		from	pls_comissao_beneficiario 
		where	nr_seq_comissao = nr_seq_comissao_p;
		 
		-- Obs: é necessário verificar novamente se o valor total da comissão é igual ao total comissionado nos beneficiários devido ao arredondamento dos valores, sendo assim ainda pode haver diferença de centavos entre os valores.					 
		if (vl_comis_benef_ajust_w <> vl_comissao_canal_w) then 		 
			update	pls_comissao_beneficiario 
			set	vl_comissao_benef = vl_comissao_benef + (vl_comissao_canal_w - vl_comis_benef_ajust_w) 
			where	nr_sequencia = (SELECT	max(nr_sequencia) 
						from	pls_comissao_beneficiario 
						where	nr_seq_comissao = nr_seq_comissao_p);
		end if;
		 
		update	pls_comissao_benef_item 
		set	vl_comissao = (vl_comissao_canal_w * vl_comissao) / vl_comissao_benef_w 
		where	nr_seq_comissao_benef in (	SELECT	nr_sequencia 
							from	pls_comissao_beneficiario 
							where	nr_Seq_comissao = nr_seq_comissao_p	);
							 
		open C01;
		loop 
		fetch C01 into	 
			nr_seq_comiss_benef_w, 
			vl_comiss_benef_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin 
			 
			select	sum(vl_comissao) 
			into STRICT	vl_comiss_item_benef_w 
			from	pls_comissao_benef_item 
			where	nr_seq_comissao_benef = nr_seq_comiss_benef_w;
			 
			-- Obs: é necessário verificar novamente se o valor total comissionado no beneficiário é igual ao total comissionado dos itens devido ao arredondamento dos valores, sendo assim ainda pode haver diferença de centavos entre os valores.	 
			if (vl_comiss_item_benef_w <> vl_comiss_benef_w) then				 
				select	max(nr_sequencia) 
				into STRICT	nr_seq_item_w 
				from	pls_comissao_benef_item 
				where	nr_seq_comissao_benef = nr_seq_comiss_benef_w 
				and	ie_tipo_item = 1;
				 
				if (coalesce(nr_seq_item_w::text, '') = '') then						 
					select	max(nr_sequencia) 
					into STRICT	nr_seq_item_w 
					from	pls_comissao_benef_item 
					where	nr_seq_comissao_benef = nr_seq_comiss_benef_w;						
				end if;
				 
				update	pls_comissao_benef_item 
				set	vl_comissao = vl_comissao + (vl_comiss_benef_w - vl_comiss_item_benef_w) 
				where	nr_sequencia = nr_seq_item_w;					
			end if;				
			end;
		end loop;
		close C01;								
	end if;
end if;
 
-- Soma o valor dos lançamentos adicionais de Desconto referente ao desconto concedido ao título a receber 
select	sum(vl_lanc_aplicado)											 
into STRICT	vl_lanc_aplicado_w 
from	pls_repasse_lanc 
where	nr_seq_comissao = nr_seq_comissao_p 
and	ie_tipo_lancamento = '3'; -- 3 - Desconto referente ao desconto concedido ao título a receber 
if (coalesce(vl_lanc_aplicado_w,0) <> 0) then	 
	update	pls_comissao 
	set	vl_comissao_canal = vl_comissao_canal + coalesce(vl_lanc_aplicado_w,0) 
	where	nr_sequencia = nr_seq_comissao_p;
	 
	select	coalesce(ie_valor_percent_desconto,'V') 
	into STRICT	ie_valor_percent_desconto_w 
	from	pls_parametros 
	where	cd_estabelecimento = cd_estabelecimento_p;
 
	open C02;
	loop 
	fetch C02 into	 
		nr_titulo_w, 
		vl_desconto_tit_w, 
		vl_lanc_aplicado_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		 
		select	sum(b.vl_item_mensalidade), 
			sum(b.vl_comissao) 
		into STRICT	vl_item_mensalidade_w, 
			vl_comissao_benef_w 
		from	pls_comissao_benef_item		b, 
			pls_comissao_beneficiario	a 
		where	a.nr_sequencia = b.nr_seq_comissao_benef 
		and	a.nr_seq_comissao = nr_seq_comissao_p 
		and	a.nr_titulo = nr_titulo_w;
		 
		if (coalesce(vl_comissao_benef_w,0) > 0) then		 
			if (ie_valor_percent_desconto_w = 'P') then 
				vl_total_w := vl_item_mensalidade_w;			
			else 
				vl_total_w := vl_comissao_benef_w;	
			end if;
		 
			update	pls_comissao_beneficiario 
			set	vl_comissao_benef = vl_comissao_benef + ((vl_desconto_tit_w * vl_comissao_benef) / vl_total_w) 
			where	nr_seq_comissao = nr_seq_comissao_p 
			and 	nr_titulo = nr_titulo_w;
 
			select	sum(vl_comissao_benef) 
			into STRICT	vl_comis_benef_ajust_w 
			from	pls_comissao_beneficiario 
			where	nr_seq_comissao = nr_seq_comissao_p 
			and 	nr_titulo = nr_titulo_w;
			 
			if	((vl_comis_benef_ajust_w - vl_comissao_benef_w) <> vl_lanc_aplicado_w) then 		 
				update	pls_comissao_beneficiario 
				set	vl_comissao_benef = vl_comissao_benef + (vl_desconto_tit_w + (vl_comis_benef_ajust_w - vl_comissao_benef_w)) 
				where	nr_sequencia = (SELECT	max(nr_sequencia) 
							from	pls_comissao_beneficiario 
							where	nr_seq_comissao = nr_seq_comissao_p 
							and 	nr_titulo = nr_titulo_w);
			end if;
			 
			update	pls_comissao_benef_item 
			set	vl_comissao = vl_comissao + ((vl_desconto_tit_w * vl_comissao) / vl_total_w) 
			where	nr_seq_comissao_benef in (	SELECT	nr_sequencia 
								from	pls_comissao_beneficiario 
								where	nr_seq_comissao = nr_seq_comissao_p 
								and 	nr_titulo = nr_titulo_w);
		end if;
		end;
	end loop;
	close C02;	
end if;
 
update	pls_comissao_beneficiario 
set	vl_lanc_adic_benef = vl_comissao_benef - vl_origem 
where	nr_seq_comissao = nr_seq_comissao_p;	
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ajustar_valores_comissao ( nr_seq_comissao_p pls_comissao.nr_sequencia%type, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

