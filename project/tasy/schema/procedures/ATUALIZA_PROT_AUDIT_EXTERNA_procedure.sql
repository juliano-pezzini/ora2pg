-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_prot_audit_externa ( nr_seq_protocolo_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
ie_status_protocolo_w	smallint;
nr_seq_audit_w		bigint;

 

BEGIN 
 
select	ie_status_protocolo 
into STRICT	ie_status_protocolo_w 
from	protocolo_convenio 
where	nr_seq_protocolo	= nr_seq_protocolo_p;
 
if (ie_status_protocolo_w	= 1) then 
	insert into protocolo_auditoria( 
		nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_seq_protocolo, 
		dt_inicial, 
		dt_final, 
		ds_observacao) 
	values (nextval('protocolo_auditoria_seq'), 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_seq_protocolo_p, 
		clock_timestamp(), 
		null, 
		'');
 
	update	protocolo_convenio 
	set	ie_status_protocolo	= 3, 
		nm_usuario		= nm_usuario_p, 
		dt_atualizacao		= clock_timestamp() 
	where	nr_seq_protocolo	= nr_seq_protocolo_p;
else 
	select	max(nr_sequencia) 
	into STRICT	nr_seq_audit_w 
	from	protocolo_auditoria 
	where	nr_seq_protocolo	= nr_seq_protocolo_p;
 
	update	protocolo_auditoria 
	set	dt_final		= clock_timestamp(), 
		nm_usuario		= nm_usuario_p, 
		dt_atualizacao		= clock_timestamp() 
	where	nr_sequencia		= nr_seq_audit_w;		
end if;
 
commit;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_prot_audit_externa ( nr_seq_protocolo_p bigint, nm_usuario_p text) FROM PUBLIC;

