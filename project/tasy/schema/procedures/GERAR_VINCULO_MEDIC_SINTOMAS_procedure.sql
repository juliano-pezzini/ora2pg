-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_vinculo_medic_sintomas (nr_seq_medic_p bigint, nr_seq_exame_p bigint, nr_seq_dieta_p bigint, nr_seq_dialise_p bigint, nr_seq_hemoterapia_p bigint, nr_seq_recomendacao_p bigint, nr_seq_material_p bigint, nr_prescricao_p bigint, ds_lista_sintomas_p text, ie_opcao_p text) AS $body$
DECLARE


ds_lista_sintomas_w	varchar(1000);
nr_pos_virgula_w		integer;
nr_seq_problema_w		prescr_item_sintoma.nr_seq_problema%type;
nm_usuario_w			varchar(15);


BEGIN

if ((nr_seq_medic_p IS NOT NULL AND nr_seq_medic_p::text <> '') or (nr_seq_exame_p IS NOT NULL AND nr_seq_exame_p::text <> '') or (nr_seq_dieta_p IS NOT NULL AND nr_seq_dieta_p::text <> '') or (nr_seq_dialise_p IS NOT NULL AND nr_seq_dialise_p::text <> '') or (nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') or (nr_seq_hemoterapia_p IS NOT NULL AND nr_seq_hemoterapia_p::text <> '') or (nr_seq_recomendacao_p IS NOT NULL AND nr_seq_recomendacao_p::text <> '')) then

	if (ie_opcao_p = 'I') then
		if (ds_lista_sintomas_p IS NOT NULL AND ds_lista_sintomas_p::text <> '') then
			nm_usuario_w := wheb_usuario_pck.get_nm_usuario;

			ds_lista_sintomas_w := ds_lista_sintomas_p;

			if (substr(ds_lista_sintomas_w, length(ds_lista_sintomas_w)) <> ',') then
				ds_lista_sintomas_w := ds_lista_sintomas_w ||',';
			end if;

			while(ds_lista_sintomas_w IS NOT NULL AND ds_lista_sintomas_w::text <> '') loop
				begin

					nr_pos_virgula_w := position(',' in ds_lista_sintomas_w);

					if (nr_pos_virgula_w <> 0) then
						nr_seq_problema_w		:= substr(ds_lista_sintomas_w, 1, (nr_pos_virgula_w - 1));
						ds_lista_sintomas_w	:= substr(ds_lista_sintomas_w, (nr_pos_virgula_w + 1), length(ds_lista_sintomas_w));
					end if;

					if (nr_seq_problema_w IS NOT NULL AND nr_seq_problema_w::text <> '') then

						insert into prescr_item_sintoma(
										nr_sequencia,
										dt_atualizacao,
										dt_atualizacao_nrec,
										nm_usuario,
										nm_usuario_nrec,
										nr_seq_problema,
										nr_seq_medic,
										nr_seq_exame,
										nr_seq_dieta,
										nr_seq_dialise,
										nr_seq_hemoterapia,
										nr_seq_recomendacao,
										nr_prescricao
									) values (
										nextval('prescr_item_sintoma_seq'),
										clock_timestamp(),
										clock_timestamp(),
										nm_usuario_w,
										nm_usuario_w,
										nr_seq_problema_w,
										coalesce(nr_seq_medic_p,nr_seq_material_p),
										nr_seq_exame_p,
										nr_seq_dieta_p,
										nr_seq_dialise_p,
										nr_seq_hemoterapia_p,
										nr_seq_recomendacao_p,
										nr_prescricao_p
									);

					end if;
				end;
			end loop;

			commit;
		end if;
	elsif (ie_opcao_p = 'D') then

		delete
		from prescr_item_sintoma
		where 1 = 1
		and ((nr_seq_medic = coalesce(nr_seq_medic_p,nr_seq_material_p)) or (nr_seq_exame = nr_seq_exame_p) or (nr_seq_dieta = nr_seq_dieta_p) or (nr_seq_dialise = nr_seq_dialise_p) or (nr_seq_hemoterapia =  nr_seq_hemoterapia_p) or (nr_seq_recomendacao = nr_seq_recomendacao_p))
		and   nr_seq_problema =  ds_lista_sintomas_p;
		commit;

	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_vinculo_medic_sintomas (nr_seq_medic_p bigint, nr_seq_exame_p bigint, nr_seq_dieta_p bigint, nr_seq_dialise_p bigint, nr_seq_hemoterapia_p bigint, nr_seq_recomendacao_p bigint, nr_seq_material_p bigint, nr_prescricao_p bigint, ds_lista_sintomas_p text, ie_opcao_p text) FROM PUBLIC;

