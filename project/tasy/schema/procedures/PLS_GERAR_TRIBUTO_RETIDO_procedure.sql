-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_tributo_retido ( nr_seq_lote_p bigint, nr_titulo_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_prestador_w		bigint;
dt_base_venc_w			timestamp;
dt_ref_tributo_w		timestamp;
cd_tributo_w			smallint;
vl_tributo_w			double precision;
vl_base_calculo_w		double precision;
ds_emp_retencao_w		varchar(255);


BEGIN

select	nr_seq_prestador,
	dt_mes_competencia
into STRICT	nr_seq_prestador_w,
	dt_base_venc_w
from	pls_lote_protocolo
where	nr_sequencia	= nr_seq_lote_p;

select	trunc(dt_referencia,'dd'),
	cd_tributo,
	vl_tributo,
	vl_base_calculo,
	ds_emp_retencao
into STRICT	dt_ref_tributo_w,
	cd_tributo_w,
	vl_tributo_w,
	vl_base_calculo_w,
	ds_emp_retencao_w
from	pls_prestador_tributo
where	nr_seq_prestador		= nr_seq_prestador_w
and	trunc(dt_referencia,'month')	= trunc(dt_base_venc_w, 'month');

insert into titulo_pagar_imposto(nr_sequencia, nr_titulo, cd_tributo,
	ie_pago_prev, dt_atualizacao, nm_usuario,
	dt_imposto, vl_base_calculo, vl_imposto,
	vl_nao_retido, ie_vencimento, vl_base_nao_retido,
	vl_trib_adic, vl_base_adic, ds_emp_retencao)
values (nextval('titulo_pagar_imposto_seq'), nr_titulo_p, cd_tributo_w,
	'R', clock_timestamp(), nm_usuario_p,
	dt_ref_tributo_w, vl_base_calculo_w, 0,
	0, 'V', 0,
	0, 0, ds_emp_retencao_w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_tributo_retido ( nr_seq_lote_p bigint, nr_titulo_p bigint, nm_usuario_p text) FROM PUBLIC;

