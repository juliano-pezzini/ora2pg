-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cus_gerar_w_custo_unitario ( cd_estabelecimento_p bigint, cd_centro_controle_p bigint, dt_referencia_p timestamp, nm_usuario_p text) AS $body$
DECLARE


/* Procedure criada por Matheus para o relat√≥rio WCUS 6023*/

cd_centro_controle_w				integer;
cd_classificacao_w				smallint;
cd_empresa_w					smallint;
ds_comando_w					varchar(4000);
dt_inicial_w					timestamp;
qt_dispo_w					double precision;
qt_dispo_1_w					double precision;
qt_dispo_2_w					double precision;
qt_dispo_3_w					double precision;
qt_registro_w					integer;
vl_custo_w					double precision;
vl_custo_1_w					double precision;
vl_custo_2_w					double precision;
vl_custo_3_w					double precision;
vl_custo_unitario_w				double precision;
vl_custo_unitario_1_w			double precision;
vl_custo_unitario_2_w			double precision;
vl_custo_unitario_3_w			double precision;
vl_mes_w					double precision;
vl_mes_1_w					double precision;
vl_mes_2_w					double precision;
vl_mes_3_w					double precision;

c01 CURSOR FOR
SELECT	a.cd_centro_controle,
	CASE WHEN b.dt_mes_referencia=pkg_date_utils.add_month(dt_referencia_p,00,0) THEN sum(a.vl_custo)  ELSE 0 END  vl_custo,
	CASE WHEN b.dt_mes_referencia=pkg_date_utils.add_month(dt_referencia_p,-1,0) THEN sum(a.vl_custo)  ELSE 0 END  vl_custo_1,
	CASE WHEN b.dt_mes_referencia=pkg_date_utils.add_month(dt_referencia_p,-2,0) THEN sum(a.vl_custo)  ELSE 0 END  vl_custo_2,
	CASE WHEN b.dt_mes_referencia=pkg_date_utils.add_month(dt_referencia_p,-3,0) THEN sum(a.vl_custo)  ELSE 0 END  vl_custo_3,
	CASE WHEN b.dt_mes_referencia=pkg_date_utils.add_month(dt_referencia_p,00,0) THEN avg(a.qt_disponibilidade)  ELSE 0 END  qt_disponibilidade,
	CASE WHEN b.dt_mes_referencia=pkg_date_utils.add_month(dt_referencia_p,-1,0) THEN avg(a.qt_disponibilidade)  ELSE 0 END  qt_disponibilidade_1,
	CASE WHEN b.dt_mes_referencia=pkg_date_utils.add_month(dt_referencia_p,-2,0) THEN avg(a.qt_disponibilidade)  ELSE 0 END  qt_disponibilidade_2,
	CASE WHEN b.dt_mes_referencia=pkg_date_utils.add_month(dt_referencia_p,-3,0) THEN avg(a.qt_disponibilidade)  ELSE 0 END  qt_disponibilidade_3
from	tabela_custo b,
	taxa_custo a
where	a.cd_tabela_custo 	= b.cd_tabela_custo
and	a.cd_estabelecimento	= b.cd_estabelecimento
and	a.cd_estabelecimento	= cd_estabelecimento_p
and	((a.cd_centro_controle	= cd_centro_controle_p) or coalesce(cd_centro_controle_p,0) = 0)
and	b.dt_mes_referencia between dt_inicial_w and dt_referencia_p
group by a.cd_centro_controle,
	 b.dt_mes_referencia;


BEGIN

CALL exec_sql_dinamico('WCUS6023','drop table w_custo_unitario');
CALL exec_sql_dinamico('WCUS6023','create table w_custo_unitario(cd_centro_controle 		number(8))');
CALL exec_sql_dinamico('WCUS6023','alter table w_custo_unitario add vl_custo 			number(15,2)');
CALL exec_sql_dinamico('WCUS6023','alter table w_custo_unitario add vl_custo_1 			number(15,2)');
CALL exec_sql_dinamico('WCUS6023','alter table w_custo_unitario add vl_custo_2 			number(15,2)');
CALL exec_sql_dinamico('WCUS6023','alter table w_custo_unitario add vl_custo_3 			number(15,2)');
CALL exec_sql_dinamico('WCUS6023','alter table w_custo_unitario add qt_disponibilidade		number(15,4)');
CALL exec_sql_dinamico('WCUS6023','alter table w_custo_unitario add qt_disponibilidade_1	number(15,4)');
CALL exec_sql_dinamico('WCUS6023','alter table w_custo_unitario add qt_disponibilidade_2 	number(15,4)');
CALL exec_sql_dinamico('WCUS6023','alter table w_custo_unitario add qt_disponibilidade_3 	number(15,4)');
CALL exec_sql_dinamico('WCUS6023','alter table w_custo_unitario add vl_custo_unitario 		number(15,2)');
CALL exec_sql_dinamico('WCUS6023','alter table w_custo_unitario add vl_custo_unitario_1 	number(15,2)');
CALL exec_sql_dinamico('WCUS6023','alter table w_custo_unitario add vl_custo_unitario_2 	number(15,2)');
CALL exec_sql_dinamico('WCUS6023','alter table w_custo_unitario add vl_custo_unitario_3 	number(15,2)');
CALL exec_sql_dinamico('WCUS6023','alter table w_custo_unitario add vl_mes 			number(15,2)');
CALL exec_sql_dinamico('WCUS6023','alter table w_custo_unitario add vl_mes_1 			number(15,2)');
CALL exec_sql_dinamico('WCUS6023','alter table w_custo_unitario add vl_mes_2 			number(15,2)');
CALL exec_sql_dinamico('WCUS6023','alter table w_custo_unitario add vl_mes_3 			number(15,2)');
CALL exec_sql_dinamico('WCUS6023','alter table w_custo_unitario add dt_atualizacao		Date');
CALL exec_sql_dinamico('WCUS6023','alter table w_custo_unitario add nm_usuario			Varchar2(15)');

dt_inicial_w	:= pkg_date_utils.add_month(dt_referencia_p,-3);

select	obter_empresa_estab(cd_estabelecimento_p)
into STRICT	cd_empresa_w
;

open c01;
loop
fetch c01 into
	cd_centro_controle_w,
	vl_custo_w,
	vl_custo_1_w,
	vl_custo_2_w,
	vl_custo_3_w,
	qt_dispo_w,
	qt_dispo_1_w,
	qt_dispo_2_w,
	qt_dispo_3_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	vl_custo_unitario_w		:= Dividir(vl_custo_w, qt_dispo_w);
	vl_custo_unitario_1_w	:= Dividir(vl_custo_1_w, qt_dispo_1_w);
	vl_custo_unitario_2_w	:= Dividir(vl_custo_2_w, qt_dispo_2_w);
	vl_custo_unitario_3_w	:= Dividir(vl_custo_3_w, qt_dispo_3_w);

	select	sum(CASE WHEN b.dt_mes_referencia=pkg_date_utils.add_month(dt_referencia_p,00,0) THEN sum(a.vl_mes)  ELSE 0 END ) vl_mes,
		sum(CASE WHEN b.dt_mes_referencia=pkg_date_utils.add_month(dt_referencia_p,-1,0) THEN sum(a.vl_mes)  ELSE 0 END ) vl_mes_1,
		sum(CASE WHEN b.dt_mes_referencia=pkg_date_utils.add_month(dt_referencia_p,-2,0) THEN sum(a.vl_mes)  ELSE 0 END ) vl_mes_2,
		sum(CASE WHEN b.dt_mes_referencia=pkg_date_utils.add_month(dt_referencia_p,-3,0) THEN sum(a.vl_mes)  ELSE 0 END ) vl_mes_3
	into STRICT	vl_mes_w,
		vl_mes_1_w,
		vl_mes_2_w,
		vl_mes_3_w
	from	classif_result d,
		tabela_custo b,
		resultado_centro_controle a
	where	a.cd_tabela_custo	= b.cd_tabela_custo
	and	a.cd_estabelecimento	= b.cd_estabelecimento
	and	a.cd_estabelecimento	= cd_estabelecimento_p
	and	a.cd_centro_controle	= cd_centro_controle_w
	and	a.ie_classif_conta	= d.cd_classificacao
	and	d.cd_empresa		= cd_empresa_w
	and	d.ie_custo_setor	= 'S'
	and	b.dt_mes_referencia between dt_inicial_w and dt_referencia_p
	group by b.dt_mes_referencia;

	ds_comando_w	:= 'insert into w_custo_unitario(
				cd_centro_controle,
				vl_custo,
				vl_custo_1,
				vl_custo_2,
				vl_custo_3,
				qt_disponibilidade,
				qt_disponibilidade_1,
				qt_disponibilidade_2,
				qt_disponibilidade_3,
				vl_custo_unitario,
				vl_custo_unitario_1,
				vl_custo_unitario_2,
				vl_custo_unitario_3,
				vl_mes,
				vl_mes_1,
				vl_mes_2,
				vl_mes_3,
				dt_atualizacao,
				nm_usuario)
		values(	' || cd_centro_controle_w || ',' ||
				replace(vl_custo_w,',','.') || ',' ||
				replace(vl_custo_1_w,',','.') || ',' ||
				replace(vl_custo_2_w,',','.') || ',' ||
				replace(vl_custo_3_w,',','.') || ',' ||
				replace(qt_dispo_w,',','.')   || ',' ||
				replace(qt_dispo_1_w,',','.') || ',' ||
				replace(qt_dispo_2_w,',','.') || ',' ||
				replace(qt_dispo_3_w,',','.') || ',' ||
				replace(vl_custo_unitario_w,',','.') || ',' ||
				replace(vl_custo_unitario_1_w,',','.') || ',' ||
				replace(vl_custo_unitario_2_w,',','.') || ',' ||
				replace(vl_custo_unitario_3_w,',','.') || ',' ||
				replace(vl_mes_w,',','.') || ',' ||
				replace(vl_mes_1_w,',','.') || ',' ||
				replace(vl_mes_2_w,',','.') || ',' ||
				replace(vl_mes_3_w,',','.') || ',' ||
				'sysdate, ' ||
				 CHR(39) || nm_usuario_p || CHR(39) || ')';
	CALL Exec_Sql_Dinamico('WCUS6023',ds_comando_w);
	end;
end loop;
close c01;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cus_gerar_w_custo_unitario ( cd_estabelecimento_p bigint, cd_centro_controle_p bigint, dt_referencia_p timestamp, nm_usuario_p text) FROM PUBLIC;

