-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE import_materiais_integracao ( cd_material_p bigint, cd_cod_inpart_p text, ie_status_p text, nm_usuario_p text, ds_erro_p text, ie_origem_p text, nr_sequencia_p INOUT bigint) AS $body$
DECLARE




nr_seq_imp_w		bigint;
nr_sequencia_ww		bigint;
nr_sequencia_w		bigint;
ds_erro_w		varchar(2000);
ds_erro_ww		varchar(2000);
qt_existe_w		bigint;
ds_mensagem_w		varchar(4000);
ds_titulo_w		varchar(255);
ie_situacao_w		varchar(1);

c01 CURSOR FOR
	SELECT	ds_mensagem,
		ds_titulo
	from	w_material_inativo
	where 	cd_material = cd_material_p;



BEGIN

select	count(*)
into STRICT	qt_existe_w
from	w_material_inativo
where	cd_material = cd_material_p;

if (qt_existe_w > 0) then

	open C01;
	loop
	fetch C01 into
		ds_mensagem_w,
		ds_titulo_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		select 	ie_situacao
		into STRICT	ie_situacao_w
		from	material
		where	cd_material = cd_material_p;

		if (ie_situacao_w = 'I') then

			ds_erro_w := substr(ds_erro_w ||ds_titulo_w || chr(13),1,2000);

		end if;
		end;
	end loop;
	close C01;

end if;
nr_sequencia_w	:= nr_sequencia_p;
ds_erro_ww	:= ds_erro_w||ds_erro_p||chr(13);

if (nr_sequencia_w = 0) then
	select	nextval('material_int_importacao_seq')
	into STRICT	nr_sequencia_ww
	;

	insert into material_int_importacao(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				dt_inicio,
				dt_fim,
				ie_origem)
			values (	nr_sequencia_ww,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				null,
				ie_origem_p);

	nr_sequencia_w := nr_sequencia_ww;

end if;

select	nextval('material_int_import_item_seq')
into STRICT	nr_seq_imp_w
;

insert into material_int_import_item(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_int_import,
			cd_material,
			cd_cod_inpart,
			ie_status,
			ds_erro)
		values (	nr_seq_imp_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_sequencia_w,
			cd_material_p,
			cd_cod_inpart_p,
			ie_status_p,
			ds_erro_ww);

nr_sequencia_p	:= nr_sequencia_w;



commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE import_materiais_integracao ( cd_material_p bigint, cd_cod_inpart_p text, ie_status_p text, nm_usuario_p text, ds_erro_p text, ie_origem_p text, nr_sequencia_p INOUT bigint) FROM PUBLIC;

