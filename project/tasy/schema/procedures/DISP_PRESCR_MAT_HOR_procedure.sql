-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE disp_prescr_mat_hor ( nr_prescricao_p bigint, nr_seq_horario_p bigint, nm_usuario_p text) AS $body$
DECLARE


				
nr_sequencia_w			bigint;
nr_prescricao_w			bigint;
nr_seq_material_w		bigint;
ie_agrupador_w			smallint;
cd_material_W			bigint;
qt_dose_W			double precision;
qt_dispensar_w			double precision;
qt_dispensar_hor_w		double precision;
ds_horario_w			varchar(15);
dt_horario_w			timestamp;
nr_ocorrencia_w			double precision;
cd_unidade_medida_w       	varchar(30);
cd_unidade_medida_dose_w  	varchar(30);
ds_turno_w			varchar(80);
ie_urgente_w			varchar(1);
dt_emissao_farmacia_w		timestamp;
dt_fim_horario_w		timestamp;
dt_suspensao_w			timestamp;
ds_cor_w			varchar(15);
ie_horario_especial_w		varchar(1);
qt_hor_reaprazamento_w		bigint;
nm_usuario_reaprazamento_w 	varchar(15);
nr_seq_turno_w			bigint;
dt_disp_farmacia_w		timestamp;
ie_aprazado_w			varchar(1);
ie_situacao_w			varchar(1);
ie_dose_especial_w		varchar(1);
ie_checagem_w			varchar(1);
nm_usuario_checagem_w		varchar(15);
dt_checagem_w			timestamp;
cd_setor_exec_w			integer;
nr_seq_lote_w			bigint;
ie_controlado_w           	varchar(1);
nr_seq_classif_w          	bigint;
ie_classif_urgente_w      	varchar(3);
ie_padronizado_w          	varchar(1);
nm_usuario_adm_w          	varchar(15);
nm_usuario_susp_w         	varchar(15);
nr_seq_processo_w         	bigint;
qt_conta_w                	double precision;
ie_dispensar_farm_w       	varchar(1);
nr_seq_superior_w         	bigint;
ie_tipo_item_processo_w   	varchar(15);
nr_agrupamento_w          	double precision;
ie_adep_w                 	varchar(1);
cd_unidade_medida_conta_w 	varchar(30);
nr_seq_digito_w           	smallint;
qt_horario_w              	double precision;
cd_unid_med_hor_w         	varchar(30);
ie_nec_etiqueta_w         	varchar(1);
nr_seq_etiqueta_w         	bigint;
nr_seq_area_prep_w        	bigint;
nr_seq_regra_area_prep_w  	bigint;
nr_seq_motivo_susp_w      	bigint;
ds_motivo_susp_w          	varchar(255);
nr_seq_dialise_w          	bigint;
ie_gedipa_w               	varchar(1);
ie_separado_w             	varchar(1);
cd_motivo_baixa_w         	smallint;
nr_etapa_sol_w            	smallint;
nr_seq_solucao_w          	integer;
ds_diluicao_w             	varchar(2000);
ie_etapa_especial_w       	varchar(1);
ie_gerar_lote_w           	varchar(1);
dt_inicio_horario_w       	timestamp;
nm_usuario_inicio_w       	varchar(15);
nm_usuario_inter_w        	varchar(15);
dt_interrupcao_w          	timestamp;
dt_lib_horario_w          	timestamp;
ie_somente_pt_w           	varchar(1);
dt_prev_fim_horario_w     	timestamp;
ie_pendente_w             	varchar(1);
ie_transferido_w          	varchar(1);
nr_ordem_compra_w         	bigint;
ie_ciente_w               	varchar(1);
dt_recusa_w               	timestamp;
ie_suspenso_adep_w        	varchar(1);
nr_motivo_disp_w          	bigint;
nr_seq_assinatura_susp_w  	bigint;
cd_local_estoque_w        	bigint;
nr_seq_lote_fornec_w      	bigint;
nr_seq_regra_disp_w       	bigint;
ds_horario_char_w         	varchar(20);
nr_seq_jejum_susp_w       	bigint;
qt_minutos_agora_w        	integer;
nr_seq_hor_glic_w         	bigint;
dt_bloqueio_w             	timestamp;
dt_primeira_checagem_w    	timestamp;
ie_administrar_w          	varchar(1);
dt_reinicio_w             	timestamp;
qt_bipado_w               	double precision;	
nr_seq_mat_hor_w		bigint;
nr_atendimento_w		bigint;
ds_mat_diluicao_w		varchar(2000);	
cd_local_estoque_mat_w		bigint;
ds_observacao_w			varchar(4000);
ds_justificativa_w		varchar(2000);
qt_existe_w				bigint;

C01 CURSOR FOR
	SELECT 	nr_sequencia,
		nr_prescricao,
		nr_seq_material,
		ie_agrupador,
		cd_material,
		qt_dose,
		qt_dispensar,
		qt_dispensar_hor,
		ds_horario,
		dt_horario,
		nr_ocorrencia,
		cd_unidade_medida,
		cd_unidade_medida_dose,
		ds_turno,
		ie_urgente,
		dt_emissao_farmacia,
		dt_fim_horario,
		dt_suspensao,
		ds_cor,
		ie_horario_especial,
		qt_hor_reaprazamento,
		nm_usuario_reaprazamento,
		nr_seq_turno,
		dt_disp_farmacia,
		ie_aprazado,
		ie_situacao,
		ie_dose_especial,
		ie_checagem,
		nm_usuario_checagem,
		dt_checagem,
		cd_setor_exec,
		nr_seq_lote,
		ie_controlado,
		nr_seq_classif,
		ie_classif_urgente,
		ie_padronizado,
		nm_usuario_adm,
		nm_usuario_susp,
		nr_seq_processo,
		qt_conta,
		ie_dispensar_farm,
		nr_seq_superior,
		ie_tipo_item_processo,
		nr_agrupamento,
		ie_adep,
		cd_unidade_medida_conta,
		nr_seq_digito,
		qt_horario,
		cd_unid_med_hor,
		ie_nec_etiqueta,
		nr_seq_etiqueta,
		nr_seq_area_prep,
		nr_seq_regra_area_prep,
		nr_seq_motivo_susp,
		ds_motivo_susp,
		nr_seq_dialise,
		ie_gedipa,
		ie_separado,
		cd_motivo_baixa,
		nr_etapa_sol,
		nr_seq_solucao,
		ds_diluicao,
		ie_etapa_especial,
		ie_gerar_lote,
		dt_inicio_horario,
		nm_usuario_inicio,
		nm_usuario_inter,
		dt_interrupcao,
		dt_lib_horario,
		ie_somente_pt,
		dt_prev_fim_horario,
		ie_pendente,
		ie_transferido,
		nr_ordem_compra,
		ie_ciente,
		dt_recusa,
		ie_suspenso_adep,
		nr_motivo_disp,
		nr_seq_assinatura_susp,
		cd_local_estoque,
		nr_seq_lote_fornec,
		nr_seq_regra_disp,
		ds_horario_char,
		nr_seq_jejum_susp,
		qt_minutos_agora,
		nr_seq_hor_glic,
		dt_bloqueio,
		dt_primeira_checagem,
		ie_administrar,
		dt_reinicio,
		qt_bipado
	from 	prescr_mat_hor a
	where 	nr_prescricao = nr_prescricao_p
	and	((coalesce(nr_seq_horario_p, 0) = 0) or (nr_sequencia = nr_seq_horario_p));
	
C02 CURSOR FOR
	SELECT	nr_sequencia
	from 	dispensario_mat_hor
	where 	nr_prescricao = nr_prescricao_p;
	

BEGIN

CALL gravar_log_tasy(18121,'nr_prescricao_p='|| nr_prescricao_p || ' nr_seq_horario_p=' || nr_seq_horario_p,nr_prescricao_p);

select	max(nr_atendimento)
into STRICT	nr_atendimento_w
from 	prescr_medica
where 	nr_prescricao = nr_prescricao_p;

open C02;
loop
fetch C02 into	
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	select	count(1)
	into STRICT	qt_existe_w
	from	prescr_mat_hor
	where	nr_sequencia = nr_sequencia_w;
	
	if (qt_existe_w = 0) then
		begin
			delete from dispensario_mat_hor
			where	nr_prescricao = nr_prescricao_p
			and		nr_seq_mat_hor = nr_sequencia_w;
		exception
		when others then
			null;
		end;
	end if;
	end;
end loop;
close C02;

open C01;
loop
fetch C01 into	
	nr_seq_mat_hor_w,
	nr_prescricao_w,
	nr_seq_material_w,
	ie_agrupador_w,
	cd_material_W,
	qt_dose_W,
	qt_dispensar_w,
	qt_dispensar_hor_w,
	ds_horario_w,
	dt_horario_w,
	nr_ocorrencia_w,
	cd_unidade_medida_w,
	cd_unidade_medida_dose_w,
	ds_turno_w,
	ie_urgente_w,
	dt_emissao_farmacia_w,
	dt_fim_horario_w,
	dt_suspensao_w,
	ds_cor_w,
	ie_horario_especial_w,
	qt_hor_reaprazamento_w,
	nm_usuario_reaprazamento_w,
	nr_seq_turno_w,
	dt_disp_farmacia_w,
	ie_aprazado_w,
	ie_situacao_w,
	ie_dose_especial_w,
	ie_checagem_w,
	nm_usuario_checagem_w,
	dt_checagem_w,
	cd_setor_exec_w,
	nr_seq_lote_w,
	ie_controlado_w,
	nr_seq_classif_w,
	ie_classif_urgente_w,
	ie_padronizado_w,
	nm_usuario_adm_w,
	nm_usuario_susp_w,
	nr_seq_processo_w,
	qt_conta_w,
	ie_dispensar_farm_w,
	nr_seq_superior_w,
	ie_tipo_item_processo_w,
	nr_agrupamento_w,
	ie_adep_w,
	cd_unidade_medida_conta_w,
	nr_seq_digito_w,
	qt_horario_w,
	cd_unid_med_hor_w,
	ie_nec_etiqueta_w,
	nr_seq_etiqueta_w,
	nr_seq_area_prep_w,
	nr_seq_regra_area_prep_w,
	nr_seq_motivo_susp_w,
	ds_motivo_susp_w,
	nr_seq_dialise_w,
	ie_gedipa_w,
	ie_separado_w,
	cd_motivo_baixa_w,
	nr_etapa_sol_w,
	nr_seq_solucao_w,
	ds_diluicao_w,
	ie_etapa_especial_w,
	ie_gerar_lote_w,
	dt_inicio_horario_w,
	nm_usuario_inicio_w,
	nm_usuario_inter_w,
	dt_interrupcao_w,
	dt_lib_horario_w,
	ie_somente_pt_w,
	dt_prev_fim_horario_w,
	ie_pendente_w,
	ie_transferido_w,
	nr_ordem_compra_w,
	ie_ciente_w,
	dt_recusa_w,
	ie_suspenso_adep_w,
	nr_motivo_disp_w,
	nr_seq_assinatura_susp_w,
	cd_local_estoque_w,
	nr_seq_lote_fornec_w,
	nr_seq_regra_disp_w,
	ds_horario_char_w,
	nr_seq_jejum_susp_w,
	qt_minutos_agora_w,
	nr_seq_hor_glic_w,
	dt_bloqueio_w,
	dt_primeira_checagem_w,
	ie_administrar_w,
	dt_reinicio_w,
	qt_bipado_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	select 	max(substr(obter_desc_material(a.cd_material),1,255)||' - '||substr(obter_diluicao_medic(a.nr_sequencia,a.nr_prescricao),1,255)),
			max(a.cd_local_estoque),
			max(a.ds_observacao),
			max(a.ds_justificativa)
	into STRICT	ds_mat_diluicao_w,
			cd_local_estoque_mat_w,
			ds_observacao_w,
			ds_justificativa_w	
	from 	prescr_material a,
		prescr_mat_hor b
	where 	a.nr_prescricao = nr_prescricao_p
	and 	a.nr_prescricao = b.nr_prescricao
	and 	a.nr_sequencia = b.nr_seq_material
	and 	b.nr_sequencia = nr_seq_mat_hor_w;
	
	select	count(1)
	into STRICT	qt_existe_w
	from	dispensario_mat_hor
	where	nr_seq_mat_hor = nr_seq_mat_hor_w
	and		coalesce(dt_recusa::text, '') = ''
	and		coalesce(dt_suspensao::text, '') = '';
	
	begin
	insert into dispensario_log_int(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nr_prescricao,
			ds_log)
	values (nextval('dispensario_log_int_seq'),
			clock_timestamp(),
			nm_usuario_p,
			nr_prescricao_w,
			'nr_seq_mat_hor_w=' || nr_seq_mat_hor_w || ' nr_prescricao_w=' || nr_prescricao_w || ' nr_seq_material_w=' || nr_seq_material_w || ' qt_existe_w=' || qt_existe_w ||
			' nm_usuario_p=' || nm_usuario_p || ' cd_material_W=' || cd_material_W || ' dt_suspensao_w=' || dt_suspensao_w || ' nr_seq_turno_w=' || nr_seq_turno_w || ' dt_horario_w=' || dt_horario_w ||
			' nr_seq_lote_w=' || nr_seq_lote_w || ' cd_motivo_baixa_w=' || cd_motivo_baixa_w || ' nr_seq_superior_w=' || nr_seq_superior_w || ' cd_local_estoque_mat_w=' || cd_local_estoque_mat_w ||
			' nr_seq_solucao=' || nr_seq_solucao_w || ' nr_seq_horario_p=' || nr_seq_horario_p);
	exception
	when others then
		null;
	end;
	
	if (qt_existe_w = 0) then
	
		insert into DISPENSARIO_MAT_HOR(
			nr_sequencia,
			nr_seq_mat_hor,
			nr_prescricao,
			nr_seq_material,
			ie_agrupador,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_material,
			qt_dose,
			qt_dispensar,
			qt_dispensar_hor,
			ds_horario,
			dt_horario,
			nr_ocorrencia,
			cd_unidade_medida,
			cd_unidade_medida_dose,
			ds_turno,
			ie_urgente,
			dt_emissao_farmacia,
			dt_fim_horario,
			dt_suspensao,
			ds_cor,
			ie_horario_especial,
			qt_hor_reaprazamento,
			nm_usuario_reaprazamento,
			nr_seq_turno,
			dt_disp_farmacia,
			ie_aprazado,
			ie_situacao,
			ie_dose_especial,
			ie_checagem,
			nm_usuario_checagem,
			dt_checagem,
			cd_setor_exec,
			nr_seq_lote,
			ie_controlado,
			nr_seq_classif,
			ie_classif_urgente,
			ie_padronizado,
			nm_usuario_adm,
			nm_usuario_susp,
			nr_seq_processo,
			qt_conta,
			ie_dispensar_farm,
			nr_seq_superior,
			ie_tipo_item_processo,
			nr_agrupamento,
			ie_adep,
			cd_unidade_medida_conta,
			nr_seq_digito,
			qt_horario,
			cd_unid_med_hor,
			ie_nec_etiqueta,
			nr_seq_etiqueta,
			nr_seq_area_prep,
			nr_seq_regra_area_prep,
			nr_seq_motivo_susp,
			ds_motivo_susp,
			nr_seq_dialise,
			ie_gedipa,
			ie_separado,
			cd_motivo_baixa,
			nr_etapa_sol,
			nr_seq_solucao,
			ds_diluicao,
			ie_etapa_especial,
			ie_gerar_lote,
			dt_inicio_horario,
			nm_usuario_inicio,
			nm_usuario_inter,
			dt_interrupcao,
			dt_lib_horario,
			ie_somente_pt,
			dt_prev_fim_horario,
			ie_pendente,
			ie_transferido,
			nr_ordem_compra,
			ie_ciente,
			dt_recusa,
			ie_suspenso_adep,
			nr_motivo_disp,
			nr_seq_assinatura_susp,
			cd_local_estoque,
			nr_seq_lote_fornec,
			nr_seq_regra_disp,
			ds_horario_char,
			nr_seq_jejum_susp,
			qt_minutos_agora,
			nr_seq_hor_glic,
			dt_bloqueio,
			dt_primeira_checagem,
			ie_administrar,
			dt_reinicio,
			nr_atendimento,
			ds_mat_diluicao,
			ds_observacao,
			ds_justificativa,
			qt_bipado)	
		values (nextval('dispensario_mat_hor_seq'),
			nr_seq_mat_hor_w,
			nr_prescricao_w,
			nr_seq_material_w,
			ie_agrupador_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_material_W,
			qt_dose_W,
			qt_dispensar_w,
			qt_dispensar_hor_w,
			to_char(dt_horario_w,'hh24:mi'),
			dt_horario_w,
			nr_ocorrencia_w,
			cd_unidade_medida_w,
			cd_unidade_medida_dose_w,
			ds_turno_w,
			ie_urgente_w,
			dt_emissao_farmacia_w,
			dt_fim_horario_w,
			dt_suspensao_w,
			ds_cor_w,
			ie_horario_especial_w,
			qt_hor_reaprazamento_w,
			nm_usuario_reaprazamento_w,
			nr_seq_turno_w,
			dt_disp_farmacia_w,
			ie_aprazado_w,
			ie_situacao_w,
			ie_dose_especial_w,
			ie_checagem_w,
			nm_usuario_checagem_w,
			dt_checagem_w,
			cd_setor_exec_w,
			nr_seq_lote_w,
			ie_controlado_w,
			nr_seq_classif_w,
			ie_classif_urgente_w,
			ie_padronizado_w,
			nm_usuario_adm_w,
			nm_usuario_susp_w,
			nr_seq_processo_w,
			qt_conta_w,
			ie_dispensar_farm_w,
			nr_seq_superior_w,
			ie_tipo_item_processo_w,
			nr_agrupamento_w,
			ie_adep_w,
			cd_unidade_medida_conta_w,
			nr_seq_digito_w,
			qt_horario_w,
			cd_unid_med_hor_w,
			ie_nec_etiqueta_w,
			nr_seq_etiqueta_w,
			nr_seq_area_prep_w,
			nr_seq_regra_area_prep_w,
			nr_seq_motivo_susp_w,
			ds_motivo_susp_w,
			nr_seq_dialise_w,
			ie_gedipa_w,
			ie_separado_w,
			cd_motivo_baixa_w,
			nr_etapa_sol_w,
			nr_seq_solucao_w,
			ds_diluicao_w,
			ie_etapa_especial_w,
			ie_gerar_lote_w,
			dt_inicio_horario_w,
			nm_usuario_inicio_w,
			nm_usuario_inter_w,
			dt_interrupcao_w,
			dt_lib_horario_w,
			ie_somente_pt_w,
			dt_prev_fim_horario_w,
			ie_pendente_w,
			ie_transferido_w,
			nr_ordem_compra_w,
			ie_ciente_w,
			dt_recusa_w,
			ie_suspenso_adep_w,
			nr_motivo_disp_w,
			nr_seq_assinatura_susp_w,
			cd_local_estoque_mat_w,
			nr_seq_lote_fornec_w,
			nr_seq_regra_disp_w,
			ds_horario_char_w,
			nr_seq_jejum_susp_w,
			qt_minutos_agora_w,
			nr_seq_hor_glic_w,
			dt_bloqueio_w,
			dt_primeira_checagem_w,
			ie_administrar_w,
			dt_reinicio_w,
			nr_atendimento_w,
			ds_mat_diluicao_w,
			ds_observacao_w,
			ds_justificativa_w,
			qt_bipado_w);
			
	else
		if (nr_seq_lote_w IS NOT NULL AND nr_seq_lote_w::text <> '') then
			update	dispensario_mat_hor
			set	nr_seq_lote = nr_seq_lote_w,
				dt_horario = dt_horario_w,
				ds_horario = to_char(dt_horario_w,'hh24:mi'),
				ds_turno = ds_turno_w,
				nm_usuario_reaprazamento = coalesce(nm_usuario_reaprazamento_w, nm_usuario_p),
				ie_lido = ''
			where	nr_seq_mat_hor = nr_seq_mat_hor_w;
		end if;
	
	end if;

	end;
end loop;
close C01;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE disp_prescr_mat_hor ( nr_prescricao_p bigint, nr_seq_horario_p bigint, nm_usuario_p text) FROM PUBLIC;

