-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_proc_participante ( nr_seq_proc_p bigint, cd_profissional_p text, nr_seq_grau_partic_p bigint, nr_seq_regra_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_reg_participante_w		bigint;
nr_seq_cbo_saude_w		bigint;
ie_tipo_guia_w			varchar(2);
cd_medico_executor_w		varchar(10);
nr_seq_prestador_exec_w		bigint;
nr_seq_grau_partic_w		bigint;
ie_medico_conta_w		varchar(1)	:= 'N';
nr_seq_prestador_cred_w		bigint;
nr_seq_conta_w			bigint;
ie_tipo_despesa_w		varchar(1);
ie_conselho_profissional_w	varchar(10);


BEGIN

select	count(1)
into STRICT	qt_reg_participante_w
from	pls_proc_participante
where	nr_seq_conta_proc	= nr_seq_proc_p;

select	b.nr_sequencia,
	coalesce(ie_tipo_guia,''),
	cd_medico_executor,
	nr_seq_prestador_exec,
	nr_seq_grau_partic,
	a.ie_tipo_despesa
into STRICT	nr_seq_conta_w,
	ie_tipo_guia_w,
	cd_medico_executor_w,
	nr_seq_prestador_exec_w,
	nr_seq_grau_partic_w,
	ie_tipo_despesa_w
from	pls_conta	b,
	pls_conta_proc	a
where	a.nr_seq_conta	= b.nr_sequencia
and	a.nr_sequencia	= nr_seq_proc_p;

if (qt_reg_participante_w	= 0) and (ie_tipo_despesa_w	= '1') then
	select	coalesce(max(nr_seq_cbo_saude),'')
	into STRICT	nr_seq_cbo_saude_w
	from	pessoa_fisica
	where	cd_pessoa_fisica	= cd_profissional_p;

	ie_conselho_profissional_w	:= pls_obter_conselho_prof(cd_medico_executor_w);

	insert into pls_proc_participante(nr_sequencia, dt_atualizacao, nm_usuario,
		dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_conta_proc,
		cd_medico, nr_cpf_imp, nm_medico_executor_imp,
		sg_conselho_imp, nr_crm_imp, uf_crm_imp,
		ie_funcao_medico_imp, cd_cgc_imp, cd_medico_imp,
		nr_seq_grau_partic, nr_seq_cbo_saude, cd_cbo_saude_imp,
		vl_participante, ie_conselho_profissional,ie_status)
	values (	nextval('pls_proc_participante_seq'), clock_timestamp(), nm_usuario_p,
		clock_timestamp(), nm_usuario_p, nr_seq_proc_p,
		cd_profissional_p, null, null,
		null, null, null,
		null, null, null,
		nr_seq_grau_partic_p, nr_seq_cbo_saude_w, null,
		null, ie_conselho_profissional_w,'U');

	update	pls_conta_proc
	set	nr_seq_dados_proc	= nr_seq_regra_p
	where	nr_sequencia		= nr_seq_proc_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_proc_participante ( nr_seq_proc_p bigint, cd_profissional_p text, nr_seq_grau_partic_p bigint, nr_seq_regra_p bigint, nm_usuario_p text) FROM PUBLIC;

