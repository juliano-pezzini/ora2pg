-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_mens_acrescimo ( nr_seq_mensalidade_p bigint, nr_seq_mens_seg_p bigint, nm_usuario_p text) AS $body$
DECLARE


ie_tipo_item_mensalidade_w	varchar(30);
ie_lanca_item_w			varchar(2)	:= 'N';
ie_tipo_regra_w			varchar(2);
ie_tipo_parentesco_w		varchar(2);
vl_total_w			double precision := 0;
vl_total_ww			double precision := 0;
vl_mensalidade_w		double precision;
vl_acrescimo_w			double precision;
tx_acrescimo_w			double precision;
nr_seq_contrato_w		bigint;
nr_seq_regra_acres_w		bigint;
nr_seq_segurado_w		bigint;
qt_min_vidas_w			bigint;
qt_max_vidas_w			bigint;
qt_vidas_contrato_w		bigint;
qt_dependentes_w		bigint;
qt_registro_contrato_w		bigint;
nr_seq_titular_w		bigint;
nr_seq_parentesco_w		bigint;
nr_seq_regra_w			bigint;
dt_referencia_w			timestamp;
nr_seq_item_w			bigint;
nr_seq_pagador_w		bigint;
nr_seq_mensalidade_seg_w	bigint;
qt_segurado_mens_w		bigint;
vl_inserido_w			double precision;
nr_seq_tipo_acrescimo_w		bigint;
nr_seq_item_mensalidade_w	pls_mensalidade_seg_item.nr_sequencia%type;
qt_regra_benef_mens_w		smallint;

C01 CURSOR FOR
	SELECT	b.nr_sequencia,
		a.vl_acrescimo,
		a.tx_acrescimo,
		a.qt_min_vidas,
		a.qt_max_vidas,
		b.ie_tipo_regra,
		b.ie_tipo_item_mensalidade
	from	pls_criterio_acrescimo	a,
		pls_regra_acrescimo	b
	where	a.nr_seq_regra		= b.nr_sequencia
	and	ie_situacao		= 'A'
	and	b.nr_seq_contrato	= nr_seq_contrato_w
	and	dt_referencia_w	between coalesce(b.dt_inicio_vigencia,dt_referencia_w) and coalesce(b.dt_fim_vigencia,dt_referencia_w)
	
union

	SELECT	b.nr_sequencia,
		a.vl_acrescimo,
		a.tx_acrescimo,
		a.qt_min_vidas,
		a.qt_max_vidas,
		b.ie_tipo_regra,
		b.ie_tipo_item_mensalidade
	from	pls_criterio_acrescimo	a,
		pls_regra_acrescimo	b
	where	a.nr_seq_regra		= b.nr_sequencia
	and	ie_situacao		= 'A'
	and	b.nr_seq_segurado	= nr_seq_segurado_w
	and	dt_referencia_w	between coalesce(b.dt_inicio_vigencia,dt_referencia_w) and coalesce(b.dt_fim_vigencia,dt_referencia_w);

C02 CURSOR FOR
	SELECT	b.nr_sequencia,
		coalesce(a.vl_acrescimo,0),
		coalesce(a.tx_acrescimo,0),
		b.ie_tipo_item_mensalidade,
		b.nr_seq_tipo_acrescimo
	from	pls_criterio_acrescimo	a,
		pls_regra_acrescimo	b
	where	a.nr_seq_regra		= b.nr_sequencia
	and	ie_situacao		= 'A'
	and	b.nr_seq_pagador	= nr_seq_pagador_w
	and	dt_referencia_w	between coalesce(b.dt_inicio_vigencia,dt_referencia_w) and coalesce(b.dt_fim_vigencia,dt_referencia_w);

C03 CURSOR FOR
	SELECT	a.nr_sequencia
	from	pls_mensalidade_segurado a
	where	a.nr_seq_mensalidade	= nr_seq_mensalidade_p
	and	((coalesce(a.dt_rescisao_benef::text, '') = '') or (a.dt_rescisao_benef > dt_referencia_w));


BEGIN

if (nr_seq_mens_seg_p IS NOT NULL AND nr_seq_mens_seg_p::text <> '') then

	nr_seq_segurado_w	:= pls_store_data_mens_pck.get_nr_seq_segurado;
	nr_seq_contrato_w	:= pls_store_data_mens_pck.get_nr_seq_contrato;
	dt_referencia_w		:= pls_store_data_mens_pck.get_dt_mesano_referencia;
	nr_seq_titular_w	:= pls_store_data_mens_pck.get_nr_seq_titular;
	nr_seq_parentesco_w	:=  pls_store_data_mens_pck.get_nr_seq_parentesco;

	open C01;
	loop
	fetch C01 into
		nr_seq_regra_w,
		vl_acrescimo_w,
		tx_acrescimo_w,
		qt_min_vidas_w,
		qt_max_vidas_w,
		ie_tipo_regra_w,
		ie_tipo_item_mensalidade_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (ie_tipo_item_mensalidade_w IS NOT NULL AND ie_tipo_item_mensalidade_w::text <> '') then
			select	sum(vl_item)
			into STRICT	vl_mensalidade_w
			from	pls_mensalidade_seg_item
			where	nr_seq_mensalidade_seg = nr_seq_mens_seg_p
			and	obter_se_contido(ie_tipo_item,ie_tipo_item_mensalidade_w) = 'S';
		elsif (coalesce(ie_tipo_item_mensalidade_w::text, '') = '') then
			select	sum(vl_item)
			into STRICT	vl_mensalidade_w
			from	pls_mensalidade_seg_item
			where	nr_seq_mensalidade_seg = nr_seq_mens_seg_p;
		end if;
		vl_total_w	:= vl_mensalidade_w;

		if (ie_tipo_regra_w = 'T') then
			select	count(1)
			into STRICT	qt_vidas_contrato_w
			from	pls_segurado
			where	nr_seq_contrato	= nr_seq_contrato_w
			and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
			and	coalesce(dt_rescisao::text, '') = '';

			if (qt_vidas_contrato_w >= coalesce(qt_min_vidas_w,1)) and (qt_vidas_contrato_w <= coalesce(qt_max_vidas_w,qt_vidas_contrato_w)) then
				ie_lanca_item_w	:= 'S';
				if (tx_acrescimo_w IS NOT NULL AND tx_acrescimo_w::text <> '') then
						vl_total_ww	:= vl_total_ww + round(vl_total_w * (tx_acrescimo_w/100),2);
				end if;
				if (vl_acrescimo_w IS NOT NULL AND vl_acrescimo_w::text <> '') then
					vl_total_ww	:= vl_total_ww + vl_acrescimo_w;
				end if;
			end if;
		else
			if (coalesce(nr_seq_titular_w::text, '') = '') then
				select 	count(1)
				into STRICT	qt_dependentes_w
				from	pls_segurado
				where	nr_seq_contrato = nr_seq_contrato_w
				and	nr_seq_titular = nr_seq_segurado_w
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and	coalesce(dt_rescisao::text, '') = '';
			end if;

			if (nr_seq_titular_w IS NOT NULL AND nr_seq_titular_w::text <> '') and (nr_seq_parentesco_w IS NOT NULL AND nr_seq_parentesco_w::text <> '') then
				select 	coalesce(max(ie_tipo_parentesco),'2')
				into STRICT	ie_tipo_parentesco_w
				from	grau_parentesco
				where	nr_sequencia = nr_seq_parentesco_w;

				select	count(1)
				into STRICT	qt_dependentes_w
				from	pls_segurado
				where	nr_seq_contrato = nr_seq_contrato_w
				and	nr_seq_titular = nr_seq_titular_w
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and	coalesce(dt_rescisao::text, '') = '';
			end if;

			qt_registro_contrato_w	:= (qt_dependentes_w + 1);

			if (qt_registro_contrato_w >= coalesce(qt_min_vidas_w,1)) and (qt_registro_contrato_w <= coalesce(qt_max_vidas_w,qt_registro_contrato_w)) then

				if 	((ie_tipo_regra_w = 'I') and (coalesce(nr_seq_titular_w::text, '') = '')) or
					(ie_tipo_regra_w = 'L' AND ie_tipo_parentesco_w = '1') or
					((ie_tipo_regra_w = 'E') and ((ie_tipo_parentesco_w = '1') or (coalesce(nr_seq_titular_w::text, '') = ''))) then
					ie_lanca_item_w	:= 'S';
					if (tx_acrescimo_w IS NOT NULL AND tx_acrescimo_w::text <> '') then
						vl_total_ww	:= vl_total_ww + round(vl_total_w * (tx_acrescimo_w/100),2);
					end if;
					if (vl_acrescimo_w IS NOT NULL AND vl_acrescimo_w::text <> '') then
						vl_total_ww	:= vl_total_ww + vl_acrescimo_w;
					end if;
				else
					vl_total_w	:= 0;
				end if;
			end if;
		end if;
		end;
	end loop;
	close C01;

	select	count(1)
	into STRICT	qt_regra_benef_mens_w
	from	pls_mensalidade a,
		pls_mensalidade_segurado b,
		pls_mensalidade_seg_item c
	where	a.nr_sequencia = b.nr_seq_mensalidade
	and	b.nr_sequencia = c.nr_seq_mensalidade_seg
	and	coalesce(a.ie_cancelamento::text, '') = ''
	and	b.dt_mesano_referencia = dt_referencia_w
	and	c.ie_tipo_item = '22'
	and	c.nr_seq_regra_acrescimo = nr_seq_regra_w
	and	b.nr_seq_segurado = nr_seq_segurado_w;

	if	(((coalesce(ie_lanca_item_w,'S') = 'S') and (vl_total_ww > 0)) and (qt_regra_benef_mens_w = 0)) then

		nr_seq_item_mensalidade_w	:= null;

		nr_seq_item_mensalidade_w := pls_insert_mens_seg_item('22', nm_usuario_p, null, null, null, null, null, null, null, 'N', null, null, null, null, null, null, null, nr_seq_mens_seg_p, null, null, null, null, null, nr_seq_regra_w, null, nr_seq_tipo_acrescimo_w, null, null, null, null, null, vl_total_ww, nr_seq_item_mensalidade_w);
	end if;
elsif (nr_seq_mensalidade_p IS NOT NULL AND nr_seq_mensalidade_p::text <> '') then
	nr_seq_pagador_w	:= pls_store_data_mens_pck.get_nr_seq_pagador;
	dt_referencia_w		:= pls_store_data_mens_pck.get_dt_referencia;

	open c02;
	loop
	fetch c02 into
		nr_seq_regra_w,
		vl_acrescimo_w,
		tx_acrescimo_w,
		ie_tipo_item_mensalidade_w,
		nr_seq_tipo_acrescimo_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		vl_inserido_w	:= 0;

		if	((vl_acrescimo_w <> 0) or (tx_acrescimo_w <> 0)) then

			if (vl_acrescimo_w <> 0) then
				select	count(1)
				into STRICT	qt_segurado_mens_w
				from	pls_mensalidade_segurado a
				where	a.nr_seq_mensalidade	= nr_seq_mensalidade_p
				and	((coalesce(a.dt_rescisao_benef::text, '') = '') or (a.dt_rescisao_benef > dt_referencia_w));

				if (qt_segurado_mens_w = 0) then
					select	count(1)
					into STRICT	qt_segurado_mens_w
					from	pls_mensalidade_segurado a
					where	a.nr_seq_mensalidade	= nr_seq_mensalidade_p;
				end if;
			end if;

			open c03;
			loop
			fetch c03 into
				nr_seq_mensalidade_seg_w;
			EXIT WHEN NOT FOUND; /* apply on c03 */
				begin

				vl_total_ww		:= 0;
				vl_mensalidade_w	:= 0;

				if (tx_acrescimo_w <> 0) then
					if (ie_tipo_item_mensalidade_w IS NOT NULL AND ie_tipo_item_mensalidade_w::text <> '') then
						select	sum(vl_item)
						into STRICT	vl_mensalidade_w
						from	pls_mensalidade_seg_item
						where	nr_seq_mensalidade_seg = nr_seq_mensalidade_seg_w
						and	obter_se_contido(ie_tipo_item,ie_tipo_item_mensalidade_w) = 'S';
					elsif (coalesce(ie_tipo_item_mensalidade_w::text, '') = '') then
						select	sum(vl_item)
						into STRICT	vl_mensalidade_w
						from	pls_mensalidade_seg_item
						where	nr_seq_mensalidade_seg = nr_seq_mensalidade_seg_w;
					end if;

					vl_total_ww	:= round(vl_mensalidade_w * (tx_acrescimo_w/100),2);

				elsif (vl_acrescimo_w <> 0) then
					vl_total_ww	:= vl_acrescimo_w / qt_segurado_mens_w;

					if (c03%rowCount = qt_segurado_mens_w) then
						vl_total_ww	:= vl_acrescimo_w - vl_inserido_w;
					end if;

					vl_inserido_w	:= coalesce(vl_inserido_w,0) + vl_total_ww;
				end if;

				if (coalesce(vl_total_ww,0) <> 0) then

					nr_seq_item_mensalidade_w := null;

					nr_seq_item_mensalidade_w := pls_insert_mens_seg_item('22', nm_usuario_p, null, null, null, null, null, null, null, 'P', null, null, null, null, null, null, null, nr_seq_mensalidade_seg_w, null, null, null, null, null, nr_seq_regra_w, null, nr_seq_tipo_acrescimo_w, null, null, null, null, null, vl_total_ww, nr_seq_item_mensalidade_w);
				end if;

				end;
			end loop;
			close c03;
		end if;

		end;
	end loop;
	close c02;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_mens_acrescimo ( nr_seq_mensalidade_p bigint, nr_seq_mens_seg_p bigint, nm_usuario_p text) FROM PUBLIC;

