-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qt_inserir_protocolo_externo (dt_inicio_p timestamp, nr_seq_protocolo_p bigint, nr_seq_medicacao_p bigint, nr_ciclo_inicial_p bigint, nr_ciclo_final_p bigint, nr_dia_inicial_p bigint, nr_dia_final_p bigint, nr_atendimento_p bigint, qt_peso_p bigint, nr_seq_ageint_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

						 
nr_seq_pac_sim_w	bigint;	
qt_tempo_medic_w	bigint;	
 
ie_tipo_pend_agenda_w	varchar(15);
nr_seq_grupo_quimio_w	bigint;

dt_prevista_w		timestamp;
nr_ciclo_w		smallint;
ds_dia_ciclo_w		varchar(5);
qt_min_duracao_w	bigint;

C01 CURSOR FOR 
	SELECT	dt_prevista, 
		ds_dia_ciclo, 
		nr_ciclo, 
		qt_tempo_medic 
	from	paciente_atendimento_sim 
	where	nr_seq_paciente = nr_seq_pac_sim_w 
	order by 1;			
				 

BEGIN 
 
select	nextval('paciente_setor_sim_seq') 
into STRICT	nr_seq_pac_sim_w
;
 
select	qt_tempo_medic 
into STRICT	qt_tempo_medic_w 
from	protocolo_medicacao 
where	cd_protocolo = nr_seq_protocolo_p 
and	nr_sequencia = nr_seq_medicacao_p;
 
select	max(b.cd_item), 
	max(b.nr_seq_grupo) 
into STRICT	ie_tipo_pend_agenda_w, 
	nr_seq_grupo_quimio_w 
from	qt_grupo_item_agenda a, 
	qt_item_agenda b 
where	b.nr_seq_grupo = a.nr_sequencia 
and	b.cd_protocolo = nr_seq_protocolo_p;
 
insert into paciente_setor_sim( 
			nr_sequencia, 
			cd_estabelecimento, 
			cd_pessoa_fisica, 
			cd_protocolo, 
			nr_seq_medicacao, 
			qt_tempo_medic, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec) 
		values (	nr_seq_pac_sim_w, 
			cd_estabelecimento_p, 
			cd_pessoa_fisica_p, 
			nr_seq_protocolo_p, 
			nr_seq_medicacao_p, 
			qt_tempo_medic_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p);
			 
CALL qt_Copiar_Prot_Oncologia(nr_seq_protocolo_p, 
			 nr_seq_medicacao_p, 
			 nr_seq_pac_sim_w, 
			 nm_usuario_p);
			 
CALL qt_gerar_ciclo_simulacao(nr_seq_pac_sim_w, 
			 dt_inicio_p, 
			 nr_seq_protocolo_p, 
			 nr_ciclo_inicial_p, 
			 nr_ciclo_final_p, 
			 nr_dia_inicial_p, 
			 null, 
			 null, 
			 null, 
			 nm_usuario_p, 
			 'N', 
			 'S');
			 
open C01;
loop 
fetch C01 into	 
	dt_prevista_w, 
	ds_dia_ciclo_w, 
	nr_ciclo_w, 
	qt_min_duracao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	insert into agenda_integrada_item( 
				nr_sequencia, 
				nr_seq_agenda_int, 
				ie_tipo_agendamento, 
				nr_seq_grupo_quimio, 
				ie_tipo_pend_agenda, 
				nr_minuto_duracao, 
				cd_protocolo, 
				nr_seq_medicacao, 
				ds_dia_ciclo, 
				nr_ciclo, 
				dt_prevista_quimio, 
				cd_estabelecimento, 
				nm_usuario, 
				dt_atualizacao, 
				nm_usuario_nrec, 
				dt_atualizacao_nrec) 
			values (	nextval('agenda_integrada_item_seq'), 
				nr_seq_ageint_p, 
				'Q', 
				nr_seq_grupo_quimio_w, 
				ie_tipo_pend_agenda_w, 
				qt_min_duracao_w, 
				nr_seq_protocolo_p, 
				nr_seq_medicacao_p, 
				ds_dia_ciclo_w, 
				nr_ciclo_w, 
				dt_prevista_w, 
				cd_estabelecimento_p, 
				nm_usuario_p, 
				clock_timestamp(), 
				nm_usuario_p, 
				clock_timestamp());
	 
	end;
end loop;
close C01;
 
delete	FROM paciente_Atendimento_sim 
where	nr_seq_paciente = nr_seq_pac_sim_w;
 
delete	FROM paciente_prot_medic_sim 
where	nr_seq_paciente = nr_seq_pac_sim_w;
 
delete	FROM paciente_prot_soluc_sim 
where	nr_seq_paciente = nr_seq_pac_sim_w;
 
delete	FROM paciente_prot_proc_sim 
where	nr_seq_paciente = nr_seq_pac_sim_w;
 
delete	FROM paciente_setor_sim 
where	nr_sequencia = nr_seq_pac_sim_w;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qt_inserir_protocolo_externo (dt_inicio_p timestamp, nr_seq_protocolo_p bigint, nr_seq_medicacao_p bigint, nr_ciclo_inicial_p bigint, nr_ciclo_final_p bigint, nr_dia_inicial_p bigint, nr_dia_final_p bigint, nr_atendimento_p bigint, qt_peso_p bigint, nr_seq_ageint_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

