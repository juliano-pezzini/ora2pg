-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE adep_consistir_margem_reval ( nr_seq_cpoe_p cpoe_material.nr_sequencia%type, nr_seq_horario_p prescr_mat_hor.nr_sequencia%type, ie_tipo_item_p text, nr_prescricao_p prescr_mat_hor.nr_prescricao%type, nr_sequencia_p prescr_mat_hor.nr_seq_solucao%type, ie_margem_valida_p INOUT text, qt_minutos_p INOUT bigint, dt_evento_med_p timestamp) AS $body$
DECLARE


ds_retorno_w				varchar(1);
ie_gas_horario_w			varchar(1);
cd_estabelecimento_w		prescr_medica.cd_estabelecimento%type;
cd_estabelecimento_usuario_w	prescr_medica.cd_estabelecimento%type;
cd_setor_atendimento_w		cpoe_revalidation_rule.cd_setor_atendimento%type;
cd_perfil_w					cpoe_revalidation_rule.cd_perfil%type;
nm_usuario_w				cpoe_revalidation_rule.nm_usuario_regra%type;
nr_seq_regra_w				cpoe_revalidation_rule.nr_sequencia%type;
qt_hora_justificativa_w		cpoe_revalidation_rule.qt_hora_justificativa%type;
qt_hora_bloqueio_w			cpoe_revalidation_rule.qt_hora_bloqueio%type;
nr_seq_horario_w			prescr_mat_hor.nr_sequencia%type;
dt_horario_w				prescr_mat_hor.dt_horario%type;
dt_validacao_w				cpoe_revalidation_events.dt_validacao%type;
qt_min_justificativa_w		smallint;
qt_min_bloqueio_w			smallint;

c01 CURSOR FOR
SELECT	a.nr_sequencia nr_seq_regra
from	adep_revalidation_rule a
where (coalesce(a.cd_setor_atendimento::text, '') = '' or a.cd_setor_atendimento = cd_setor_atendimento_w)
and (coalesce(a.cd_perfil::text, '') = '' or a.cd_perfil = cd_perfil_w)
and (coalesce(a.nm_usuario_regra::text, '') = '' or a.nm_usuario_regra = nm_usuario_w)
and (coalesce(a.cd_estabelecimento::text, '') = '' or a.cd_estabelecimento = cd_estabelecimento_usuario_w)
and (a.ie_situacao = 'A')
order by
	coalesce(a.nm_usuario_regra, 'ZXPTO') desc,
	coalesce(a.cd_perfil, 99999) desc,
	coalesce(a.cd_setor_atendimento, 99999) desc;

BEGIN

ds_retorno_w := 'S';
cd_setor_atendimento_w := wheb_usuario_pck.get_cd_setor_atendimento;
cd_perfil_w := wheb_usuario_pck.get_cd_perfil;
nm_usuario_w := wheb_usuario_pck.get_nm_usuario;
cd_estabelecimento_usuario_w := obter_estabelecimento_ativo;

for r_c01 in c01 loop
	nr_seq_regra_w := r_c01.nr_seq_regra;
end loop;

if (ie_tipo_item_p = 'SOL') then
	select	max(a.nr_sequencia)
	into STRICT	nr_seq_horario_w
	from	prescr_mat_hor a
	where	a.nr_prescricao = nr_prescricao_p
	and		a.nr_seq_solucao = nr_sequencia_p
	and		a.nr_etapa_sol = nr_seq_horario_p;
else
	nr_seq_horario_w := nr_seq_horario_p;
end if;

if (coalesce(nr_seq_regra_w, 0) > 0) then
	select	max(a.qt_hora_justificativa),
			max(a.qt_hora_bloqueio)
	into STRICT	qt_hora_justificativa_w,
			qt_hora_bloqueio_w
	from	adep_revalidation_rule a
	where	a.nr_sequencia = nr_seq_regra_w;

	if (ie_tipo_item_p in ('M','SOL','MAT')) then
		select	max(a.dt_horario)
		into STRICT	dt_horario_w
		from	prescr_mat_hor a
		where	a.nr_sequencia = nr_seq_horario_w
		and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S';

		select	max(a.dt_validacao)
		into STRICT	dt_validacao_w
		from	cpoe_revalidation_events a
		where	a.nr_seq_material = nr_seq_cpoe_p;

	elsif (ie_tipo_item_p in ('P','G','C','I','L')) then
		select	max(a.dt_horario)
		into STRICT	dt_horario_w
		from	prescr_proc_hor a
		where	a.nr_sequencia = nr_seq_horario_w
		and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S';

		select	max(a.dt_validacao)
		into STRICT	dt_validacao_w
		from	cpoe_revalidation_events a
		where	a.nr_seq_exam = nr_seq_cpoe_p;

	elsif (ie_tipo_item_p = 'R') then
		select	max(a.dt_horario)
		into STRICT	dt_horario_w
		from	prescr_rec_hor a
		where	a.nr_sequencia = nr_seq_horario_w
		and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S';

		select	max(a.dt_validacao)
		into STRICT	dt_validacao_w
		from	cpoe_revalidation_events a
		where	a.nr_seq_recomendation = nr_seq_cpoe_p;

	elsif (ie_tipo_item_p = 'HM') then
		if (coalesce(nr_seq_horario_w, 0) > 0) then
			select	max(a.dt_horario)
			into STRICT	dt_horario_w
			from	prescr_proc_hor a
			where	a.nr_sequencia = nr_seq_horario_w
			and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S';
		else
			dt_horario_w := dt_evento_med_p;
		end if;

		select	max(a.dt_validacao)
		into STRICT	dt_validacao_w
		from	cpoe_revalidation_events a
		where	a.nr_seq_hemotherapy = nr_seq_cpoe_p;

	elsif (ie_tipo_item_p = 'O') then
		if (coalesce(nr_seq_horario_w, 0) = 0) then
			select	max(a.dt_inicio_prescr)
			into STRICT	dt_horario_w
			from	prescr_medica a
			where	a.nr_prescricao = nr_prescricao_p;
		else
			select	max(a.cd_estabelecimento)
			into STRICT	cd_estabelecimento_w
			from	prescr_medica a
			where	a.nr_prescricao = nr_prescricao_p;

			ie_gas_horario_w := obter_param_usuario(1113, 538, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_gas_horario_w);

			if (ie_gas_horario_w = 'N') then
				select	max(coalesce(a.dt_prev_execucao, b.dt_inicio_prescr))
				into STRICT	dt_horario_w
				from	prescr_gasoterapia a,
						prescr_medica b
				where	b.nr_prescricao = a.nr_prescricao
				and		a.nr_sequencia = nr_seq_horario_w;

			elsif (ie_gas_horario_w = 'S') then
				select	max(a.dt_horario)
				into STRICT	dt_horario_w
				from	prescr_gasoterapia_hor a
				where	a.nr_sequencia = nr_seq_horario_w
				and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S';
			end if;
		end if;

		select	max(a.dt_validacao)
		into STRICT	dt_validacao_w
		from	cpoe_revalidation_events a
		where	a.nr_seq_gasotherapy = nr_seq_cpoe_p;

	elsif (ie_tipo_item_p = 'D') then
		select	max(a.dt_horario)
		into STRICT	dt_horario_w
		from	prescr_dieta_hor a
		where	a.nr_sequencia = nr_seq_horario_w
		and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S';

		select	max(a.dt_validacao)
		into STRICT	dt_validacao_w
		from	cpoe_revalidation_events a
		where	a.nr_seq_diet = nr_seq_cpoe_p;

	elsif (ie_tipo_item_p = 'DE') then
		select	max(a.dt_servico)
		into STRICT	dt_horario_w
		from	nut_atend_serv_dia a
		where	a.nr_sequencia = nr_seq_horario_w;

		select	max(a.dt_validacao)
		into STRICT	dt_validacao_w
		from	cpoe_revalidation_events a
		where	a.nr_seq_diet = nr_seq_cpoe_p;

	elsif (ie_tipo_item_p in ('SNE','LD','S')) then
		select	max(a.dt_horario)
		into STRICT	dt_horario_w
		from	prescr_mat_hor a
		where	a.nr_sequencia = nr_seq_horario_w
		and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S';

		select	max(a.dt_validacao)
		into STRICT	dt_validacao_w
		from	cpoe_revalidation_events a
		where	a.nr_seq_diet = nr_seq_cpoe_p;

	elsif (ie_tipo_item_p = 'DI') then
		dt_horario_w := dt_evento_med_p;

		select	max(a.dt_validacao)
		into STRICT	dt_validacao_w
		from	cpoe_revalidation_events a
		where	a.nr_seq_dialysis = nr_seq_cpoe_p;
	end if;

	if (dt_horario_w IS NOT NULL AND dt_horario_w::text <> '' AND dt_validacao_w IS NOT NULL AND dt_validacao_w::text <> '') then
		if (qt_hora_bloqueio_w IS NOT NULL AND qt_hora_bloqueio_w::text <> '') then
			qt_min_bloqueio_w := (substr(qt_hora_bloqueio_w, 1, 2))::numeric  * 60 + (substr(qt_hora_bloqueio_w, 4, 2))::numeric;
			if (dt_horario_w > dt_validacao_w + qt_min_bloqueio_w/1440) then
				ds_retorno_w := 'B';
			end if;
		end if;
		if (ds_retorno_w = 'S') then
			if (qt_hora_justificativa_w IS NOT NULL AND qt_hora_justificativa_w::text <> '') then
				qt_min_justificativa_w := (substr(qt_hora_justificativa_w, 1, 2))::numeric  * 60 + (substr(qt_hora_justificativa_w, 4, 2))::numeric;
				if (dt_horario_w > dt_validacao_w + qt_min_justificativa_w/1440) then
					ds_retorno_w := 'J';
				end if;
			end if;
		end if;
	end if;
end if;

ie_margem_valida_p	:= ds_retorno_w;
qt_minutos_p		:= qt_min_justificativa_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE adep_consistir_margem_reval ( nr_seq_cpoe_p cpoe_material.nr_sequencia%type, nr_seq_horario_p prescr_mat_hor.nr_sequencia%type, ie_tipo_item_p text, nr_prescricao_p prescr_mat_hor.nr_prescricao%type, nr_sequencia_p prescr_mat_hor.nr_seq_solucao%type, ie_margem_valida_p INOUT text, qt_minutos_p INOUT bigint, dt_evento_med_p timestamp) FROM PUBLIC;

