-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_atualiza_apac_continuidade ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
nr_apac_w		bigint;
nr_atendimento_w		bigint;
cd_procedimento_w	bigint;
dt_emissao_w		timestamp;
dt_inicio_validade_w	timestamp;
dt_fim_validade_w		timestamp;
cd_medico_responsavel_w	varchar(15);
cd_medico_autorizador_w sus_apac_unif.cd_medico_autorizador%type;
dt_autorizacao_w          sus_apac_unif.dt_autorizacao%type;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	sus_apac_unif
	where	nr_atendimento 	= nr_atendimento_w
	and	nr_apac 		= 0
	and	ie_tipo_apac 	= 2
	and	dt_emissao 	= dt_emissao_w
	and	dt_inicio_validade	= dt_inicio_validade_w
	and	dt_fim_validade 	= dt_fim_validade_w
	and	cd_medico_responsavel = cd_medico_responsavel_w
	order by nr_sequencia;


BEGIN

select	nr_apac,
	nr_atendimento,
	cd_procedimento,
	dt_emissao,
	dt_inicio_validade,
	dt_fim_validade,
	cd_medico_responsavel,
    cd_medico_autorizador,
    dt_autorizacao
into STRICT	nr_apac_w,
	nr_atendimento_w,
	cd_procedimento_w,
	dt_emissao_w,
	dt_inicio_validade_w,
	dt_fim_validade_w,
	cd_medico_responsavel_w,
	cd_medico_autorizador_w,
	dt_autorizacao_w
from	sus_apac_unif
where	nr_sequencia = nr_sequencia_p;

open C01;
loop
fetch C01 into
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	update	sus_apac_unif
	set	nr_apac 		= nr_apac_w,
		nm_usuario 	        = nm_usuario_p,
		dt_atualizacao 	        = clock_timestamp(),
        cd_medico_autorizador   = cd_medico_autorizador_w,
        dt_autorizacao          = dt_autorizacao_w
	where	nr_sequencia 	= nr_sequencia_w;

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_atualiza_apac_continuidade ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

