-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_prod_lac_item (nr_seq_prod_lac_p bigint, dt_producao_p timestamp, nr_seq_turno_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_seq_prod_princ_w 		nut_prod_principal.nr_sequencia%type;
nr_seq_prod_item_w 		nut_prod_lac_item.nr_sequencia%type;
hr_inicial_w			timestamp;
hr_final_w			timestamp;
dt_inicio_turno_w		timestamp;
dt_fim_turno_w			timestamp;
qt_amostra_w			nutricao_leite_deriv.qt_vol_amostra%type;
cd_material_w			prescr_material.cd_material%type;
nr_seq_solubilidade_w   	prescr_material.nr_seq_solubilidade%type;
nr_seq_produto_w   		prescr_material.nr_seq_produto%type;
qt_volume_total_w 		nut_prod_principal.qt_volume_total%type;
qt_vol_agua_w			nut_prod_principal.qt_vol_agua%type;
qt_po_w				nut_prod_principal.qt_po%type;
qt_volume_regra_w		nutricao_leite_deriv_solub.qt_vol_agua%type;
qt_volume_total_regra_w		nutricao_leite_deriv_solub.qt_volume_total%type;
qt_diluicao_regra_w		nutricao_leite_deriv_solub.qt_fator_diluicao%type;
nr_seq_nut_prod_princ_w		nut_prod_principal.nr_sequencia%type;
nr_seq_prod_lac_item_w		nut_prod_lac_item.nr_sequencia%type;
nr_seq_prod_lac_item_adic_w 	nut_prod_lac_item_adic.nr_sequencia%type;
nm_usuario_w 			varchar(255);
nr_seq_mat_hor_w		prescr_mat_hor.nr_sequencia%type;
nr_prescricao_w			prescr_material.nr_prescricao%type;
nr_seq_material_w		prescr_material.nr_sequencia%type;
qt_dose_w			prescr_material.qt_dose%type;
dt_horario_w			prescr_mat_hor.dt_horario%type;
cd_unidade_medida_w		nutricao_leite_deriv.cd_unidade_medida%type;
cd_unidade_medida_adic_w 	nutricao_leite_deriv.cd_unidade_medida%type;
nr_seq_temperatura_w		prescr_material.nr_seq_temperatura%type;
nr_seq_mat_adic_w		prescr_material.nr_sequencia%type;
qt_dose_adic_w			prescr_material.qt_dose%type;
qt_porcentagem_adic_w		prescr_material.qt_porcentagem%type;
cd_material_adic_w		prescr_material.cd_material%type;
ie_situacao_sol_w		varchar(1);
cd_unidade_medida_dose_w	prescr_material.cd_unidade_medida_dose%type;
EXEC_W      varchar(200);

c01 CURSOR FOR
	SELECT	a.nr_sequencia
	from	nut_prod_principal a
	where	a.nr_seq_prod_lac = nr_seq_prod_lac_p
	and	a.ie_status = 'P';
	
c02 CURSOR FOR
	SELECT	a.nr_sequencia
	from	nut_prod_lac_item a
	where	a.nr_seq_prod_princ = nr_seq_prod_princ_w;
	
c03 CURSOR FOR
	SELECT 	a.cd_material,
		a.nr_seq_solubilidade,
		sum(a.qt_dose) qt_volume_total
	from	(SELECT	a.cd_material,
			a.nr_seq_solubilidade,
			c.qt_dose,
			c.nr_sequencia seq_mat_hor
		from	prescr_material a,
			prescr_medica b,
			prescr_mat_hor c
		where	a.nr_prescricao = b.nr_prescricao
		and ((b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') or (b.dt_liberacao_medico IS NOT NULL AND b.dt_liberacao_medico::text <> ''))
		and (a.ie_suspenso <> 'S' or coalesce(a.ie_suspenso::text, '') = '')
		and	((a.ie_se_necessario = 'N')
			or (a.ie_se_necessario = 'S' and c.ie_aprazado = 'S'))
		and	c.nr_prescricao = a.nr_prescricao
		and 	coalesce(c.dt_suspensao::text, '') = ''
		and 	(c.dt_lib_horario IS NOT NULL AND c.dt_lib_horario::text <> '')
		and	a.nr_sequencia = c.nr_seq_material
		and	c.dt_horario between  dt_inicio_turno_w AND dt_fim_turno_w
		and (b.cd_estabelecimento = cd_estabelecimento_p or coalesce(cd_estabelecimento_p::text, '') = '')
		and 	coalesce(a.nr_sequencia_diluicao::text, '') = ''
		and 	a.ie_agrupador = 12 --Suplemento
		and	((select max(x.ie_tipo_local)
			from local_estoque x 
			where x.cd_local_estoque = a.cd_local_estoque) = '5') /* 5 - Nutricao.*/
		
union

		select 	a.cd_material,
			a.nr_seq_solubilidade,
			c.qt_dose,
			c.nr_sequencia seq_mat_hor
		from	prescr_material a,
			prescr_medica b,
			prescr_mat_hor c,
			prescr_leite_deriv d
		where	a.nr_prescricao = b.nr_prescricao
		and	a.nr_seq_leite_deriv = d.nr_sequencia
		and ((b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') or (b.dt_liberacao_medico IS NOT NULL AND b.dt_liberacao_medico::text <> ''))
		and (a.ie_suspenso <> 'S' or coalesce(a.ie_suspenso::text, '') = '')
		and	((d.ie_se_necessario = 'N')
			or (d.ie_se_necessario = 'S' and c.ie_aprazado = 'S'))
		and	c.nr_prescricao = a.nr_prescricao
		and 	coalesce(c.dt_suspensao::text, '') = ''
		and 	(c.dt_lib_horario IS NOT NULL AND c.dt_lib_horario::text <> '')
		and	a.nr_sequencia = c.nr_seq_material
		and	c.dt_horario between  dt_inicio_turno_w AND dt_fim_turno_w
		and (b.cd_estabelecimento = cd_estabelecimento_p or coalesce(cd_estabelecimento_p::text, '') = '')
		and 	coalesce(a.nr_sequencia_diluicao::text, '') = ''
		and 	a.ie_agrupador = 16 --Leites e derivados
	) a
	where 	not exists (	select 	1 
				from 	nut_prod_principal p,
					nut_prod_lac_item i
				where	i.nr_seq_prod_princ = p.nr_sequencia
				and	p.ie_status in ('E','F')
				and	p.nr_seq_prod_lac = nr_seq_prod_lac_p
				and 	a.seq_mat_hor = i.nr_seq_mat_hor)
	group by a.cd_material, a.nr_seq_solubilidade;
	
		
c04 CURSOR FOR
	SELECT	a.seq_mat_hor,
		a.nr_prescricao,
		a.nr_sequencia,
		a.cd_material,
		a.qt_dose,
		a.cd_unidade_medida,
		a.dt_horario,
		a.nr_seq_temperatura
	from (	SELECT c.nr_sequencia seq_mat_hor,
			a.nr_prescricao,
			a.nr_sequencia,
			a.cd_material,
			c.qt_dose,
			coalesce(a.cd_unidade_medida_dose,
				(select max(l.cd_unidade_medida)
				from	nutricao_leite_deriv l
				where	l.cd_material = a.cd_material
				and 	coalesce(l.ie_situacao,'A') = 'A')) cd_unidade_medida,
			c.dt_horario,
			a.nr_seq_temperatura,
			a.ie_agrupador
		from	prescr_material a,
			prescr_medica b,
			prescr_mat_hor c,
			prescr_leite_deriv d
		where	a.nr_prescricao = b.nr_prescricao
		and	a.nr_seq_leite_deriv = d.nr_sequencia
		and	c.nr_prescricao = a.nr_prescricao
		and 	coalesce(c.dt_suspensao::text, '') = ''
		and 	(c.dt_lib_horario IS NOT NULL AND c.dt_lib_horario::text <> '')
		and	a.nr_sequencia = c.nr_seq_material
		and	c.dt_horario between  dt_inicio_turno_w AND dt_fim_turno_w
		and ((b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') or (b.dt_liberacao_medico IS NOT NULL AND b.dt_liberacao_medico::text <> ''))
		and (a.ie_suspenso <> 'S' or coalesce(a.ie_suspenso::text, '') = '')
		and	((d.ie_se_necessario = 'N')
		    or (d.ie_se_necessario = 'S' and c.ie_aprazado = 'S'))
		and (b.cd_estabelecimento = cd_estabelecimento_p or coalesce(cd_estabelecimento_p::text, '') = '')
		and	a.cd_material = cd_material_w
		and (a.nr_seq_solubilidade = nr_seq_solubilidade_w or (coalesce(a.nr_seq_solubilidade::text, '') = '' and coalesce(nr_seq_solubilidade_w::text, '') = ''))
		and 	coalesce(a.nr_sequencia_diluicao::text, '') = ''
		and 	a.ie_agrupador = 16 --Leites e derivados
		
union

		select	c.nr_sequencia seq_mat_hor,
			a.nr_prescricao,
			a.nr_sequencia,
			a.cd_material,
			c.qt_dose,
			a.cd_unidade_medida_dose cd_unidade_medida,
			c.dt_horario,
			a.nr_seq_temperatura,
			a.ie_agrupador
		from	prescr_material a,
			prescr_medica b,
			prescr_mat_hor c
		where	a.nr_prescricao = b.nr_prescricao
		and	c.nr_prescricao = a.nr_prescricao
		and 	coalesce(c.dt_suspensao::text, '') = ''
		and 	(c.dt_lib_horario IS NOT NULL AND c.dt_lib_horario::text <> '')
		and	a.nr_sequencia = c.nr_seq_material
		and	c.dt_horario between  dt_inicio_turno_w AND dt_fim_turno_w
		and ((b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') or (b.dt_liberacao_medico IS NOT NULL AND b.dt_liberacao_medico::text <> ''))
		and (a.ie_suspenso <> 'S' or coalesce(a.ie_suspenso::text, '') = '')
		and	((a.ie_se_necessario = 'N')
		    or (a.ie_se_necessario = 'S' and c.ie_aprazado = 'S'))
		and (b.cd_estabelecimento = cd_estabelecimento_p or coalesce(cd_estabelecimento_p::text, '') = '')
		and	a.cd_material = cd_material_w
		and (a.nr_seq_solubilidade = nr_seq_solubilidade_w or (coalesce(a.nr_seq_solubilidade::text, '') = '' and coalesce(nr_seq_solubilidade_w::text, '') = ''))
		and 	coalesce(a.nr_sequencia_diluicao::text, '') = ''
		and 	a.ie_agrupador = 12 --Suplemento
		and	((select max(x.ie_tipo_local) 
			from local_estoque x 
			where x.cd_local_estoque = a.cd_local_estoque) = '5') /* 5 - Nutricao.*/
		) a
		where	not exists (	select 	1 
					from 	nut_prod_principal p,
						nut_prod_lac_item i
					where	i.nr_seq_prod_princ = p.nr_sequencia
					and	p.ie_status in ('E','F')
					and	p.nr_seq_prod_lac = nr_seq_prod_lac_p
					and 	a.seq_mat_hor = i.nr_seq_mat_hor);
			
c05 CURSOR FOR
	SELECT	a.nr_sequencia,		
		a.qt_dose,
		a.qt_porcentagem,
		a.cd_material,
		a.cd_unidade_medida_dose
	from	prescr_material a
	where	a.nr_prescricao 	= nr_prescricao_w
	and	a.nr_sequencia_diluicao = nr_seq_material_w;


BEGIN

nm_usuario_w := wheb_usuario_pck.get_nm_usuario;

/*Deleta os que estao pendentes para gerar novamente*/

open c01;
	loop
	fetch c01 into	
		nr_seq_prod_princ_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		
		open c02;
			loop
			fetch c02 into	
				nr_seq_prod_item_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				begin
				
				delete	from nut_prod_lac_item_adic
				where	nr_seq_prod_item = nr_seq_prod_item_w;

				delete	from nut_prod_lac_item
				where	nr_sequencia = nr_seq_prod_item_w;
				
				end;
			end loop;
		close c02;
		
		delete	from nut_prod_principal
		where	nr_sequencia = nr_seq_prod_princ_w;
		
		end;
	end loop;
close c01;

select	t.hr_inicial,
	t.hr_final
into STRICT	hr_inicial_w,
	hr_final_w
from	nut_turno_lactario t
where	t.nr_sequencia = nr_seq_turno_p;

dt_inicio_turno_w	:=	to_date(to_char(dt_producao_p,'dd/mm/yyyy')||' ' || to_char(hr_inicial_w,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
dt_fim_turno_w		:=	to_date(to_char(dt_producao_p,'dd/mm/yyyy')||' ' || to_char(hr_final_w,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');

if (dt_fim_turno_w < dt_inicio_turno_w) then
  begin
    EXEC_W := 'CALL OBTER_FIM_TURNO_PROD_LAC_MD(:1) INTO :result';

    EXECUTE EXEC_W USING IN dt_fim_turno_w,
                                   OUT dt_fim_turno_w;
  exception
    when others then
      dt_fim_turno_w := null;
  end;
end if;

open c03;
	loop
	fetch c03 into	
		cd_material_w,
		nr_seq_solubilidade_w,
		qt_volume_total_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		begin

		qt_vol_agua_w := null;
		qt_po_w := null;
		qt_volume_regra_w := null;
		qt_diluicao_regra_w := null;
		qt_volume_total_regra_w := null;		

		if (nr_seq_solubilidade_w IS NOT NULL AND nr_seq_solubilidade_w::text <> '') then

			select	max(s.qt_vol_agua),
				max(s.qt_fator_diluicao),
				max(s.qt_volume_total),
				max(ie_situacao)
			into STRICT 	qt_volume_regra_w,
				qt_diluicao_regra_w,
				qt_volume_total_regra_w,
				ie_situacao_sol_w
			from	nutricao_leite_deriv_solub s
			where	s.nr_sequencia = nr_seq_solubilidade_w;

			if (ie_situacao_sol_w = 'I') then
				nr_seq_solubilidade_w := null;
				qt_volume_regra_w := null;
				qt_diluicao_regra_w := null;
				qt_volume_total_regra_w := null;				
			end if;

		end if;

		select 	max(l.nr_sequencia)
		into STRICT	nr_seq_produto_w
		from	nutricao_leite_deriv l
		where	l.cd_material = cd_material_w
		and 	coalesce(l.ie_situacao,'A') = 'A';

		select 	coalesce(max(l.qt_vol_amostra),0)
		into STRICT	qt_amostra_w
		from	nutricao_leite_deriv l
		where	l.nr_sequencia = nr_seq_produto_w
		and 	coalesce(l.ie_situacao,'A') = 'A';

    begin
      EXEC_W := 'BEGIN OBTER_VOLUME_PROD_LAC_ITEM_MD(:1,:2,:3,:4,:5,:6,:7); END;';

      EXECUTE EXEC_W USING IN qt_volume_total_w,
                                     IN qt_amostra_w,
                                     IN qt_volume_regra_w,
                                     IN qt_volume_total_regra_w,
                                     IN qt_diluicao_regra_w,
                                     OUT qt_vol_agua_w,
                                     OUT qt_po_w;
    exception
      when others then
        qt_vol_agua_w := null;
        qt_po_w       := null;
    end;
    		qt_volume_total_w := coalesce(qt_volume_total_w,0) + coalesce(qt_amostra_w,0);

		select 	nextval('nut_prod_principal_seq')
		into STRICT 	nr_seq_nut_prod_princ_w
		;

		insert 	into nut_prod_principal(
					nr_sequencia,
					nr_seq_prod_lac,
					cd_material,
					nr_seq_solubilidade,
					qt_volume_total,
					qt_vol_agua,
					qt_po,
					nr_seq_produto,
					ie_status,
					qt_vol_amostra,
					nm_usuario_nrec,
					nm_usuario,
					dt_atualizacao_nrec,
					dt_atualizacao)
			values (
					nr_seq_nut_prod_princ_w,
					nr_seq_prod_lac_p,
					cd_material_w,
					nr_seq_solubilidade_w,
					qt_volume_total_w,
					qt_vol_agua_w,
					qt_po_w,
					nr_seq_produto_w,
					'P',
					qt_amostra_w,
					nm_usuario_w,
					nm_usuario_w,
					clock_timestamp(),
					clock_timestamp());
					
		open c04;
			loop
			fetch c04 into	
				nr_seq_mat_hor_w,
				nr_prescricao_w,
				nr_seq_material_w,
				cd_material_w,
				qt_dose_w,
				cd_unidade_medida_w,
				dt_horario_w,
				nr_seq_temperatura_w;
			EXIT WHEN NOT FOUND; /* apply on c04 */
				begin
								
				select 	nextval('nut_prod_lac_item_seq')
				into STRICT 	nr_seq_prod_lac_item_w
				;
				
				insert into nut_prod_lac_item(
							nr_sequencia,
							nr_seq_prod_princ,
							nr_seq_mat_hor,
							nr_prescricao,
							nr_seq_material,
							cd_material,
							qt_dose,
							cd_unidade_medida,
							dt_horario,
							nr_seq_temperatura,
							nm_usuario_nrec,
							nm_usuario,
							dt_atualizacao_nrec,
							dt_atualizacao)
						values (
							nr_seq_prod_lac_item_w,
							nr_seq_nut_prod_princ_w,
							nr_seq_mat_hor_w,
							nr_prescricao_w,
							nr_seq_material_w,
							cd_material_w,
							qt_dose_w,
							cd_unidade_medida_w,
							dt_horario_w,
							nr_seq_temperatura_w,
							nm_usuario_w,
							nm_usuario_w,
							clock_timestamp(),
							clock_timestamp());
							
				open c05;
					loop
					fetch c05 into
						nr_seq_mat_adic_w,
						qt_dose_adic_w,
						qt_porcentagem_adic_w,
						cd_material_adic_w,
						cd_unidade_medida_dose_w;
					EXIT WHEN NOT FOUND; /* apply on c05 */
						begin
						
						if (coalesce(qt_dose_adic_w::text, '') = '') then
              begin
                EXEC_W := 'CALL OBTER_QTDE_DOSE_ADIC_MD(:1,:2) INTO :result';

                EXECUTE EXEC_W USING IN qt_dose_w,
                                               IN qt_porcentagem_adic_w,
                                               OUT qt_dose_adic_w;
              exception
                when others then
                  qt_dose_adic_w := null;
              end;
						end if;
						
						select 	coalesce(max(a.cd_unidade_medida), cd_unidade_medida_dose_w)
						into STRICT	cd_unidade_medida_adic_w
						from 	nutricao_leite_deriv_adic a
						where	a.nr_seq_produto = nr_seq_produto_w
						and	a.cd_material = cd_material_adic_w;

						insert into nut_prod_lac_item_adic(
									nr_sequencia,
									nr_prescricao,
									nr_seq_material,
									nr_seq_prod_item,
									qt_dose,
									qt_porcentagem,
									cd_unidade_medida,
									nm_usuario_nrec,
									nm_usuario,
									dt_atualizacao_nrec,
									dt_atualizacao)
								values (	
									nextval('nut_prod_lac_item_adic_seq'),
									nr_prescricao_w,
									nr_seq_mat_adic_w,
									nr_seq_prod_lac_item_w,
									qt_dose_adic_w,
									qt_porcentagem_adic_w,
									cd_unidade_medida_adic_w,
									nm_usuario_w,
									nm_usuario_w,
									clock_timestamp(),
									clock_timestamp());
						end;
					end loop;
				close c05;
				
				end;
			end loop;
		close c04;	
		
		end;
	end loop;
close c03;					

commit;				

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_prod_lac_item (nr_seq_prod_lac_p bigint, dt_producao_p timestamp, nr_seq_turno_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

