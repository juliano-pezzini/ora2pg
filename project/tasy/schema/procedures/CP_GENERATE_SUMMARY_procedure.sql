-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cp_generate_summary ((nr_seq_prescr_p bigint, nm_usuario_p text, si_measures_result_p text default 'N', si_dates_p text default 'N', si_rtf_p text default 'Y', nr_not_checked_p text default null) is nr_seq_patient_cp_summary_w patient_cp_summary.nr_sequencia%type) RETURNS varchar AS $body$
BEGIN	
		for r_diag in c_diag LOOP
			if (r_diag.tipo = ie_sugerido_w) then
				diags_sug_w := diags_sug_w || newline_w || space_n2_w || '\u9632    ' || r_diag.ds_diagnostico;
			else
				diags_adc_w := diags_adc_w || newline_w || space_n2_w || '\u9632    ' || r_diag.ds_diagnostico;
			end if;
		end loop;
		
		return  ' \b ' || obter_desc_expressao(339335,null) || ' \b0 ' || newline_w ||
			space_n1_w || '\u9632    ' || obter_desc_expressao(331675,null)  || diags_sug_w || newline_w ||
			space_n1_w || '\u9632    ' || obter_desc_expressao(948969,null)  || diags_adc_w;
	end;

begin
si_measures_result_w	:= coalesce(si_measures_result_p,'N');
si_dates_w		:= coalesce(si_dates_p,'N');
si_rtf_w		:= coalesce(si_rtf_p,'Y');
nr_not_checked_w := coalesce(nr_not_checked_p,'S');
cd_perfil_ativo_w := obter_perfil_ativo;
cd_estabelecimento_ativo_w := obter_estabelecimento_ativo;
ds_fonte_w := obter_param_usuario(281, 5, cd_perfil_ativo_w, nm_usuario_p, cd_perfil_ativo_w, ds_fonte_w);
ds_tam_fonte_w := obter_param_usuario(281, 6, cd_perfil_ativo_w, nm_usuario_p, cd_perfil_ativo_w, ds_tam_fonte_w);
nr_tam_fonte_w := somente_numero(ds_tam_fonte_w) * 2;

for plano_cuidado in c01 loop
	begin
	nr_seq_pat_care_plan_w := plano_cuidado.nr_sequencia;
	
	if (saida_w IS NOT NULL AND saida_w::text <> '') then
		saida_w := saida_w || newline_w;
	end if;

	if (si_dates_w = 'Y' ) then
		ds_data_ini_fim_w := null;
		
		select	substr(newline_w || space_n1_w || obter_desc_expressao(291978, null) || ': ' || /*Inicio: */
			pkg_date_utils.start_of(plano_cuidado.dt_start, 'DD', null) ||
			newline_w || space_n1_w || obter_desc_expressao(290101, null) || ': ' || /*Fim*/
			pkg_date_utils.start_of(plano_cuidado.dt_end, 'DD') ||
			newline_w || space_n1_w || obter_desc_expressao(955005, null) || ': ' || /*Sugerido por: */
			newline_w || plano_cuidado.ds_diagnosticos,1,4000)
		into STRICT	ds_data_ini_fim_w
		;

	else
		ds_data_ini_fim_w := '';
	end if;
	
	saida_w := saida_w
                   || '\b '
                   || obter_desc_expressao(784741,null) || ': ' || plano_cuidado.ds_display_name /*Plano de cuidado: */
                   || '\b0 '
                   || ds_data_ini_fim_w;
        saida_w := saida_w || newline_w;
	
  	
    for intervencao_retirada_plano in c08 loop
      begin
        if intervencao_retirada_plano.seq = 1 then
          saida_w := saida_w
            || space_n1_w
            || '\u9632    '
            || obter_desc_expressao(1056512,null) || ': '; /*Intervencoes retiradas do plano: */
		
          saida_w := saida_w || newline_w;
        end if;
        saida_w := saida_w
          	|| space_n2_w
            || '\u9632    '
            || obter_desc_expressao(292220,null) || ': ' || intervencao_retirada_plano.ds_display_name /*Intervencao: */
            || newline_w
            || space_n3_w
            || '\u9632    '
            || obter_desc_expressao(292337,null) || ': ' || intervencao_retirada_plano.ds_justificativa /*Justificativa */
            || newline_w 
            || space_n3_w
            || '\u9632    '
            || obter_desc_expressao(297865,null) || ': ' || intervencao_retirada_plano.ds_profissional /*Retirado por */
;
				saida_w := saida_w || newline_w;
      end;
    end loop;

	for problema in c02 loop
		begin
		nr_seq_pat_cp_problem_w := problema.nr_sequencia;
		
		if ( si_dates_w = 'Y' ) then
			ds_data_ini_fim_w := null;
			
			select	substr(newline_w || space_n2_w || obter_desc_expressao(291978, null) || ': ' || /*Inicio: */
				pkg_date_utils.start_of(problema.dt_start, 'DD', null) ||
				newline_w || space_n2_w || obter_desc_expressao(290101, null) || ': ' || /*Fim*/
				pkg_date_utils.start_of(problema.dt_end, 'DD'),1,4000)
			into STRICT	ds_data_ini_fim_w
			;
		else
			ds_data_ini_fim_w := '';
		end if;

		saida_w := saida_w
			|| space_n1_w
			|| '\u9632    '
			|| obter_desc_expressao(296350,null) || ': ' || problema.ds_display_name /*Problema: */
			|| ds_data_ini_fim_w;
		saida_w := saida_w || newline_w;
	
		for plano_intervencao in c03 loop
			begin
			nr_seq_pat_cp_interv_plan_w := plano_intervencao.nr_sequencia;			
			saida_w := saida_w
				|| space_n2_w
				|| '\u9632    '
				|| obter_desc_expressao(954939,null) || ': ' || plano_intervencao.ds_display_name; /*Plano de intervencao: */
		
			saida_w := saida_w || newline_w;
			
			for intervencao in c04 loop
				begin
				saida_w := saida_w
					|| space_n3_w
					|| '\u9632    '
					|| obter_desc_expressao(292220,null) || ': ' || intervencao.ds_display_name; /*Intervencao: */
					
				if (intervencao.ds_horarios IS NOT NULL AND intervencao.ds_horarios::text <> '') then
				saida_w := saida_w
					|| newline_w
					|| space_n5_w
					|| obter_desc_expressao(291449,null) || ': ' || intervencao.ds_horarios;
				end if;
				saida_w := saida_w || newline_w;
				end;
			end loop;			
			end;
		end loop;

		for meta_clinica in c05 loop
			begin			
			nr_seq_pat_cp_goal_w := meta_clinica.nr_sequencia;
			saida_w := saida_w
				|| space_n2_w
				|| '\u9632    '
				|| obter_desc_expressao(948691) || ': ' || meta_clinica.ds_display_name; /*Meta de cuidado: */
			saida_w := saida_w || newline_w;
			

			for indicador in c06 loop
				begin				
				if (si_dates_w = 'Y' ) then
					
					select	substr(newline_w || space_n4_w || obter_desc_expressao(291978, null) || ': ' || /*Inicio: */
						pkg_date_utils.start_of(indicador.dt_start, 'DD', null) ||
						newline_w || space_n4_w || obter_desc_expressao(290101, null) || ': ' || /*Fim*/
						pkg_date_utils.start_of(indicador.dt_end, 'DD'),1,4000)
					into STRICT	ds_data_ini_fim_w
					;

				else
					ds_data_ini_fim_w := '';
				end if;

				if (si_measures_result_w = 'Y' ) then
					saida_w := saida_w
						|| space_n3_w
						|| '\u9632    '
						|| obter_desc_expressao(291850,null) || ': ' || indicador.ds_display_name /*Indicador: */
						|| newline_w || space_n4_w
						|| obter_desc_expressao(951411, null) || ': ' /*Mensuracao atual: */
						|| indicador.ds_cp_measure
						|| ds_data_ini_fim_w;
				    else
					saida_w := saida_w
						|| space_n3_w
						|| '\u9632    '
						|| obter_desc_expressao(291850,null) || ': ' || indicador.ds_display_name /*Indicador: */
						|| ds_data_ini_fim_w;
				    end if;
					
					if (indicador.ie_evolution IS NOT NULL AND indicador.ie_evolution::text <> '') then
					
					select 	CASE WHEN indicador.ie_evolution='PR' THEN  obter_desc_expressao(951545,null) WHEN indicador.ie_evolution='NE' THEN  obter_desc_expressao(951549,null) WHEN indicador.ie_evolution='RE' THEN  obter_desc_expressao(951547,null)  ELSE null END
					into STRICT 	ds_evolucao_metas_w
					;
					
					saida_w := saida_w
						||	newline_w
						||	space_n4_w
						|| 	obter_desc_expressao(326269, null) /*Status: */
						|| 	' ' || ds_evolucao_metas_w;
					end if;
					saida_w := saida_w || newline_w;
				end;
			end loop;
			end;
		end loop;	
		end;
	end loop;
        for meta_educacional in c07 loop
		begin
		if (si_dates_w = 'Y' ) then
			ds_data_ini_fim_w := null;
			
			select	substr(newline_w || space_n2_w || obter_desc_expressao(291978, null) || ': ' || /*Inicio: */
				pkg_date_utils.start_of(meta_educacional.dt_start, 'DD', null),1,4000)
			into STRICT	ds_data_ini_fim_w
			;
		else
			ds_data_ini_fim_w := '';
		end if;

		saida_w := saida_w
			|| space_n1_w
			|| '\u9632    '			
			|| obter_desc_expressao(947748,null) || ': ' || meta_educacional.ds_display_name /*Meta educacional: */
			|| ds_data_ini_fim_w;
			
		if (coalesce(meta_educacional.dt_end::text, '') = '' and coalesce(meta_educacional.LIBERADO::text, '') = '') then
			ds_status_metas_w := obter_desc_expressao(957340, null);
		elsif (coalesce(meta_educacional.dt_end::text, '') = '' and meta_educacional.LIBERADO = '0') then
			ds_status_metas_w := obter_desc_expressao(331364, null);
		elsif (coalesce(meta_educacional.dt_end::text, '') = '' and meta_educacional.LIBERADO = '1') then
			ds_status_metas_w := obter_desc_expressao(957336, null);
		elsif (meta_educacional.dt_end IS NOT NULL AND meta_educacional.dt_end::text <> '') then
			ds_status_metas_w := obter_desc_expressao(290157, null);
		end if;
		
		if (ds_status_metas_w IS NOT NULL AND ds_status_metas_w::text <> '') then
			saida_w := saida_w
				|| newline_w
				|| space_n4_w
				|| obter_desc_expressao(326269, null) /*Status: */
				|| 	' ' || ds_status_metas_w;
		end if;
		
		saida_w := saida_w || newline_w;
		end;
	end loop;
	end;
end loop;

if (nr_not_checked_w <> 'N') then

		for intervencoes_manuais in c09 loop
			begin
				ds_intervencoes_w := ds_intervencoes_w
					|| space_n1_w
					|| '\u9632    '			
					|| intervencoes_manuais.ds_display_name /*Intervencao: */
 
					|| ds_data_ini_fim_w;
				ds_intervencoes_w := ds_intervencoes_w || newline_w;
				
			if (intervencoes_manuais.ds_horarios IS NOT NULL AND intervencoes_manuais.ds_horarios::text <> '') then
				ds_intervencoes_w := ds_intervencoes_w
					|| space_n1_w || '    '
					|| obter_desc_expressao(291449,null) || ': ' 
					|| intervencoes_manuais.ds_horarios
					|| newline_w;
			end if;
			end;
		end loop;

		if (ds_intervencoes_w IS NOT NULL AND ds_intervencoes_w::text <> '') then
			saida_w := saida_w
				|| newline_w
				|| '\b '
				|| obter_desc_expressao(491031,null) /*Intervencoes de enfermagem: */
				|| '\b0 '
				|| ds_data_ini_fim_w;
			saida_w := saida_w || newline_w || ds_intervencoes_w;
		end if;

end if;

if (si_clinical_note_w = 'Y') and (si_measures_result_w = 'Y') and (si_dates_w = 'Y') and (si_rtf_w = 'N') then

	saida_w := replace(obter_diagnosticos || saida_w, chr(13) || chr(10), ' \par ');
else
	ds_cabecalho_w := '{\rtf1\ansi\ansicpg1252\deff0\deflang1046{\fonttbl{\f0\fswiss\fcharset0 '
		|| ds_fonte_w
		|| ';}}'
		|| '{\*\generator msftedit 5.41.15.1507;}\viewkind4\uc1\pard\f0\fs'
		|| nr_tam_fonte_w
		|| ' ';
    CALL gerar_resumo_exame_fis(nr_seq_prescr_p,nm_usuario_p,'N');

    begin
        select ds_resumo
        into STRICT saida2_w
        from PE_PRESCR_RESUMO
        where NR_SEQ_PE_PRESCR = nr_seq_prescr_p;
    exception when others then
    saida2_w := null;
    end;

	ds_rodape_w := '}';
	saida_w := ds_cabecalho_w
	    || '\b ' || obter_desc_expressao(10652844,null)  ||'\b0  \par '
	    || replace(saida2_w, chr(13) || chr(10), ' \par ')
	    || ' \par '
		|| replace(obter_diagnosticos, chr(13) || chr(10), ' \par ')
		|| ' \par \par '
		|| replace(saida_w, chr(13) || chr(10), ' \par ')
		|| ds_rodape_w;

end if;

select	nextval('patient_cp_summary_seq')
into STRICT	nr_seq_patient_cp_summary_w
;

delete from patient_cp_summary
where nr_seq_prescr = nr_seq_prescr_p;

insert into patient_cp_summary(
	ds_summary,
	dt_atualizacao,
	dt_atualizacao_nrec,
	nm_usuario,
	nm_usuario_nrec,
	nr_seq_prescr,
	nr_sequencia)
values (	saida_w,
	clock_timestamp(),
	clock_timestamp(),
	nm_usuario_p,
	nm_usuario_p,
	nr_seq_prescr_p,
	nr_seq_patient_cp_summary_w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cp_generate_summary ((nr_seq_prescr_p bigint, nm_usuario_p text, si_measures_result_p text default 'N', si_dates_p text default 'N', si_rtf_p text default 'Y', nr_not_checked_p text default null) is nr_seq_patient_cp_summary_w patient_cp_summary.nr_sequencia%type) FROM PUBLIC;

