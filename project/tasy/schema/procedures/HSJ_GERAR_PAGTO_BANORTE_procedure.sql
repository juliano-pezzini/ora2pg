-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hsj_gerar_pagto_banorte ( nr_seq_envio_p bigint, nm_usuario_p text) AS $body$
DECLARE



subtype valor_char is varchar(14);
subtype date_char is varchar(8);

c01 REFCURSOR;
nr_conta_estab_w              banco_estabelecimento.cd_conta%type;
cd_estabelecimento_w          estabelecimento.cd_estabelecimento%type;
ie_movto_bco_pag_escrit_w     parametros_contas_pagar.ie_movto_bco_pag_escrit%type;
cd_rfc_estab_w                pessoa_juridica.cd_rfc%type;
ds_conteudo_w                 w_envio_banco.ds_conteudo%type;
nr_seq_apres_w                w_envio_banco.nr_seq_apres%type := 0;

id_tipo_pagto_w               titulo_pagar_escrit.ie_tipo_pagamento%type;
clave_id_w                    pessoa_fisica_conta.cd_codigo_identificacao%type;
nr_conta_w                    pessoa_fisica_conta.nr_conta%type;
ds_referencia_w               nota_fiscal.nr_nota_fiscal%type;
ds_descricao_w                titulo_pagar.ds_observacao_titulo%type;
vl_escritural_w               valor_char;
vl_imposto_w                  valor_char;
cd_moeda_w                    titulo_pagar.cd_moeda%type;
ds_email_w                    compl_pessoa_fisica.ds_email%type;
dt_vencimento_w               date_char;
ds_beneficiario_w             pessoa_juridica.ds_razao_social%type;


ds_sql_cursor_w             varchar(4000) :=
  ' from	nota_fiscal     n,
    titulo_pagar_imposto    i,
    banco_tipo_pagto_escrit g,
    compl_pessoa_fisica     f,
    pessoa_juridica_estab   ff,
    PESSOA_JURIDICA_CONTA   ee,
    pessoa_fisica_conta     e,
    pessoa_juridica         dd,
    pessoa_fisica           d,
    titulo_pagar            c,
    titulo_pagar_escrit     b,
    banco_escritural        a 
  where	f.cd_pessoa_fisica(+) = d.cd_pessoa_fisica
  and	e.ie_conta_pagamento(+) = ''S''
  and	e.ie_situacao(+) = ''A''
  and	e.cd_pessoa_fisica(+) = d.cd_pessoa_fisica
  and	c.cd_pessoa_fisica = d.cd_pessoa_fisica(+)
  and	ee.ie_conta_pagamento(+) = ''S''
  and	ee.ie_situacao(+) = ''A''
  and	ee.cd_cgc(+) = dd.cd_cgc
  and	ff.cd_cgc(+) = dd.cd_cgc
  and	c.cd_cgc = dd.cd_cgc(+)
  and	b.nr_seq_tipo_pagto = g.nr_sequencia
  and	c.nr_titulo = i.nr_titulo(+)
  and	c.nr_seq_nota_fiscal = n.nr_Sequencia(+)
  and	b.nr_titulo = c.nr_titulo
  and	a.nr_sequencia = b.nr_seq_escrit
  and	a.nr_sequencia = ';


BEGIN

delete	from w_envio_banco
where	nm_usuario	= nm_usuario_p;

begin

  select	rpad(d.cd_rfc,12,' ')||' ', -- RFC Ordenante
    lpad(somente_numero(substr(c.cd_conta,1,12)),20,'0'), -- Cuenta Origen 
    a.cd_estabelecimento
  into STRICT	cd_rfc_estab_w,
    nr_conta_estab_w,
    cd_estabelecimento_w
  from   pessoa_juridica d,
    banco_estabelecimento c,
    estabelecimento b,
    banco_escritural a
  where b.cd_cgc = d.cd_cgc
  and a.nr_seq_conta_banco	= c.nr_sequencia
  and	a.cd_estabelecimento	= b.cd_estabelecimento
  and	a.nr_sequencia		= nr_seq_envio_p;

  select	coalesce(max(ie_movto_bco_pag_escrit),'T')
  into STRICT	ie_movto_bco_pag_escrit_w
  from	parametros_contas_pagar
  where	cd_estabelecimento	= cd_estabelecimento_w;

exception
  when no_data_found then
    CALL wheb_mensagem_pck.exibir_mensagem_abort(262142);
  when too_many_rows then raise;
end;

if (ie_movto_bco_pag_escrit_w = 'F') then
  ds_sql_cursor_w := 'select  lpad(max(g.cd_tipo),2,0) id_tipo_pagto,
    rpad(max(coalesce(e.cd_codigo_identificacao,nvl(ee.cd_codigo_identificacao,'' ''))),13,'' '') ds_clave_id,
    lpad(max(coalesce(e.nr_conta,nvl(ee.nr_conta,0))),20,''0'') nr_conta, 
    lpad(sum(b.vl_escritural)*100,14,''0'') vl_escritural,
    lpad(substr(max(nvl(n.nr_nota_fiscal,''0'')),1,9),10,''0'') ds_referencia,
    rpad(substr(max(decode(c.cd_cgc, null, c.cd_pessoa_fisica||'':PF'', c.cd_cgc||'':PJ''))||'';'||nr_seq_envio_p||'|'',1,30),30,''0'') ds_descricao,
    decode(max(c.cd_moeda),18,1,2) cd_moeda,
    lpad(sum(decode(g.cd_tipo,95,i.vl_imposto*100,0)),14,0) vl_imposto,
    rpad(max(coalesce(f.ds_email,nvl(ff.ds_email,'' ''))),39,'' '') ds_email,
    max(to_char(decode(g.cd_tipo,95,c.dt_vencimento_original,sysdate),''DDMMYYYY'')) dt_vencimento,
    rpad(max(coalesce(d.nm_pessoa_fisica,nvl(dd.ds_razao_social,'' ''))),70,'' '') ds_beneficiario ' ||
    ds_sql_cursor_w || nr_seq_envio_p ||
    ' group by c.cd_pessoa_fisica, c.cd_cgc';
else
  ds_sql_cursor_w := 'select	lpad(g.cd_tipo,2,0),
    rpad(nvl(e.cd_codigo_identificacao,nvl(ee.cd_codigo_identificacao,'' '')),13,'' ''),
    lpad(nvl(e.nr_conta,nvl(ee.nr_conta,0)),20,''0''),
    lpad(b.vl_escritural*100,14,''0''),
    lpad(substr(nvl(c.nr_titulo,''0''),1,7),10,''0''),
    rpad(substr(''T:''||c.nr_titulo||'' - F:''||n.nr_nota_fiscal,1,30),30,''0''),
    decode(c.cd_moeda,18,1,2),
    lpad(decode(g.cd_tipo,95,i.vl_imposto*100,0),14,0),
    rpad(max(nvl(f.ds_email,nvl(ff.ds_email,'' ''))),39,'' ''),
    to_char(decode(g.cd_tipo,95,c.dt_vencimento_original,sysdate),''DDMMYYYY''),
    rpad(nvl(d.nm_pessoa_fisica,nvl(dd.ds_razao_social,'' '')),70,'' '') ' ||
    ds_sql_cursor_w || nr_seq_envio_p ||
    ' group by lpad(g.cd_tipo,2,0),
    rpad(nvl(e.cd_codigo_identificacao,nvl(ee.cd_codigo_identificacao,'' '')),13,'' ''),
    lpad(nvl(e.nr_conta,nvl(ee.nr_conta,0)),20,''0''),
    lpad(b.vl_escritural*100,14,''0''),
    lpad(substr(nvl(c.nr_titulo,''0''),1,7),10,''0''),
    rpad(substr(''T:''||c.nr_titulo||'' - F:''||n.nr_nota_fiscal,1,30),30,''0''),
    decode(c.cd_moeda,18,1,2),
    lpad(decode(g.cd_tipo,95,i.vl_imposto*100,0),14,0),
    to_char(decode(g.cd_tipo,95,c.dt_vencimento_original,sysdate),''DDMMYYYY''),
    rpad(nvl(d.nm_pessoa_fisica,nvl(dd.ds_razao_social,'' '')),70,'' '')';
end if;

  open c01 for EXECUTE ds_sql_cursor_w;
  loop
  fetch	c01 into
    id_tipo_pagto_w,
    clave_id_w,
    nr_conta_w,
    vl_escritural_w,
    ds_referencia_w,
    ds_descricao_w,
    cd_moeda_w,	
    vl_imposto_w,
    ds_email_w,
    dt_vencimento_w,
    ds_beneficiario_w;
  EXIT WHEN NOT FOUND; /* apply on c01 */

    nr_seq_apres_w		:= coalesce(nr_seq_apres_w,0) + 1;

    if (id_tipo_pagto_w not in ('04', '05')) then
      cd_rfc_estab_w := lpad(' ',13,' ');
    end if;

    ds_conteudo_w	:= id_tipo_pagto_w 	||--  1-2
        clave_id_w				||--  3-15
        nr_conta_estab_w		||-- 16-35
        nr_conta_w				||-- 36-55
        vl_escritural_w			||-- 56-69
        ds_referencia_w			||-- 70-79
        ds_descricao_w			||-- 80-109
        cd_moeda_w				||-- 110-110
        cd_moeda_w				||-- 111-111
        cd_rfc_estab_w			||-- 112-124
        vl_imposto_w			||-- 125-138
        ds_email_w				||-- 139-177
        dt_vencimento_w			||-- 178-185
        elimina_caractere_esp_asc(ds_beneficiario_w,'S','S');	-- 186-255
    insert	into w_envio_banco(cd_estabelecimento,
      ds_conteudo,
      dt_atualizacao,
      nm_usuario,
      nr_seq_apres,
      nr_seq_apres_2,
      nr_sequencia)
    values (cd_estabelecimento_w,
      substr(rpad(ds_conteudo_w,255,' '),1,255),
      clock_timestamp(),
      nm_usuario_p,
      nr_seq_apres_w,
      nr_seq_apres_w,
      nextval('w_envio_banco_seq'));

  end loop;
  close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hsj_gerar_pagto_banorte ( nr_seq_envio_p bigint, nm_usuario_p text) FROM PUBLIC;

