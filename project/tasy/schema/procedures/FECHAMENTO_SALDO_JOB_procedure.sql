-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fechamento_saldo_job () AS $body$
DECLARE


ds_erro_w			varchar(500);

c01 CURSOR FOR
SELECT	a.NR_SEQUENCIA,
	a.DT_REFERENCIA,
	a.NR_SEQ_CONTA
from	BANCO_SALDO a
where coalesce(a.dt_fechamento::text, '') = ''
and TRUNC(LAST_DAY(a.dt_referencia)) = TRUNC(LAST_DAY(clock_timestamp()));

vet01	c01%rowtype;


BEGIN

open C01;
loop
fetch C01 into	
	vet01;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	begin
	
		CALL ferchar_mes_js(clock_timestamp(), vet01.DT_REFERENCIA, vet01.NR_SEQ_CONTA, vet01.NR_SEQUENCIA, 'TASY');
		
	exception when others then
		ds_erro_w	:= sqlerrm(SQLSTATE);
		CALL gravar_log_tasy(5465, vet01.NR_SEQUENCIA||' - '||vet01.NR_SEQ_CONTA||' - '||vet01.DT_REFERENCIA||' - '||ds_erro_w, 'TASYY');		
	end;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fechamento_saldo_job () FROM PUBLIC;

