-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_me_canc_ped_itens_ent ( nr_Seq_pedido_item_p bigint, dt_entrega_p text, qt_entrega_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_me_canc_ped_itens_ent_w		w_me_cancela_ped_itens_ent.nr_sequencia%type;
dt_entrega_w						timestamp;
nr_ordem_compra_w					w_me_cancela_pedido.numeropedidowpd%type;


BEGIN

dt_entrega_w := to_date(substr(replace(dt_entrega_p,'-','/'),1,10),'yyyy-mm-dd');

select	max(b.numeropedidowpd)
into STRICT	nr_ordem_compra_w
from	w_me_cancela_pedido_itens a,
		w_me_cancela_pedido b
where 	b.nr_sequencia = a.nr_seq_pedido
and 	a.nr_sequencia = nr_Seq_pedido_item_p;

CALL inserir_log_me('OC', substr(nr_ordem_compra_w||'@',1,position('@' in nr_ordem_compra_w||'@')-1), 'AVISO', 'ROC', WHEB_MENSAGEM_PCK.get_texto(297876,'NR_ORDEM_COMPRA_P='||nr_ordem_compra_w), '128', nm_usuario_p,'');
/* Entro cancela item entrega #@NR_ORDEM_COMPRA_P#@. */

select	nextval('w_me_cancela_ped_itens_ent_seq')
into STRICT	nr_seq_me_canc_ped_itens_ent_w
;

/*Tabela temporária usada na integração com o sistema Mercado Eletrônico.
Nesta tabela ficam registradas as entregas dos itens dos pedido de compras que foram cancelados no sistema Mercado Eletrônico, e que precisam ser cancelados também no Tasy.*/
insert into w_me_cancela_ped_itens_ent(
	nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	data,
	nr_seq_item,
	quantidade)
values (	nr_seq_me_canc_ped_itens_ent_w,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	dt_entrega_w,
	nr_Seq_pedido_item_p,
	qt_entrega_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_me_canc_ped_itens_ent ( nr_Seq_pedido_item_p bigint, dt_entrega_p text, qt_entrega_p bigint, nm_usuario_p text) FROM PUBLIC;

