-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_aualizar_desistencia (nr_seq_doacao_p bigint, nr_motivo_desistencia_p bigint, ds_justificativa_p text, ds_local_desistencia_p text, nm_usuario_p text, qt_coletada_p san_doacao.qt_coletada%type) AS $body$
DECLARE


ie_desistencia_w varchar(10);


BEGIN

	select 	ie_desistencia
	into STRICT 	ie_desistencia_w
	from 	san_motivo_desistencia
	where	nr_sequencia = nr_motivo_desistencia_p;

if (ie_desistencia_w = 'S')
	and (nr_seq_doacao_p IS NOT NULL AND nr_seq_doacao_p::text <> '') then

		update 	san_doacao
		set 	ie_avaliacao_final 		= 'I',
			nr_motivo_desistencia 		= nr_motivo_desistencia_p,
			ds_justificativa_desistencia  	= substr(ds_justificativa_p,0,255),
			ds_local_desistencia		= ds_local_desistencia_p,
			nm_usuario 			= nm_usuario_p,
			dt_atualizacao 			= clock_timestamp(),
			qt_coletada  			= coalesce(qt_coletada_p,0)
		where 	nr_sequencia 			= nr_seq_doacao_p;
		
		--SAN EVENTO - INAPTIDAO DO DOADOR
		CALL executa_evento_hemoterapia( nm_usuario_p , nr_seq_doacao_p , 6);
		
else
	if (nr_seq_doacao_p IS NOT NULL AND nr_seq_doacao_p::text <> '') then
		update 	san_doacao
		set 	ie_avaliacao_final 		= 'A',
			nr_motivo_desistencia 		= nr_motivo_desistencia_p,
			ds_justificativa_desistencia  	= substr(ds_justificativa_p,0,255),
			ds_local_desistencia		= ds_local_desistencia_p,
			nm_usuario 			= nm_usuario_p,
			dt_atualizacao 			= clock_timestamp(),
			qt_coletada  			= coalesce(qt_coletada_p,0)
		where 	nr_sequencia 			= nr_seq_doacao_p;
	end if;
end if;
	
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_aualizar_desistencia (nr_seq_doacao_p bigint, nr_motivo_desistencia_p bigint, ds_justificativa_p text, ds_local_desistencia_p text, nm_usuario_p text, qt_coletada_p san_doacao.qt_coletada%type) FROM PUBLIC;

