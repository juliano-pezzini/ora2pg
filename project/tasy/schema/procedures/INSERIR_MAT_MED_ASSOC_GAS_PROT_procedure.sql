-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_mat_med_assoc_gas_prot ( cd_protocolo_p bigint, nr_sequencia_p bigint, nr_seq_gas_prot_p bigint, nr_prescricao_p bigint, qt_peso_p bigint, nr_seq_gasoterapia_p bigint, nm_usuario_p text, cd_intervalo_p text default null) AS $body$
DECLARE


nr_sequencia_w	integer;
qt_dose_w	double precision;
cd_material_w	integer;	
cd_unidade_medida_w	varchar(30);
cd_unidade_medida_Cons_w	varchar(30);
ds_recomendacao_w		varchar(2000);
ie_via_aplicacao_w	varchar(5);
ie_agrupador_w		smallint;
cd_intervalo_w		varchar(7);
qt_dose_peso_w		double precision;
ie_multiplicar_dose_w	varchar(1);
ds_justificativa_w	varchar(2000);
qt_conversao_w		double precision;
nr_horas_validade_w	integer;
nr_ocorrencia_w		bigint := 0;
cd_estabelecimento_w	smallint;
dt_primeiro_horario_w	timestamp;
dt_prescricao_w			timestamp;
ds_horarios_w		varchar(2000);
ds_horarios_ww		varchar(2000);
ds_horarios2_ww		varchar(2000);
qt_hora_intervalo_w	smallint;
qt_min_intervalo_w	integer;
dt_prev_execucao_w	timestamp;
qt_total_disp_w		double precision;
ie_regra_disp_w		varchar(1);
ds_erro_w			varchar(255);
nr_dia_util_w		bigint;
ie_limpa_prim_hor_w		intervalo_prescricao.ie_limpa_prim_hor%type;
ie_inicio_w			prescr_gasoterapia.ie_inicio%type;
ie_se_necessario_w	prescr_material.ie_se_necessario%type;
ie_acm_w			prescr_material.ie_acm%type;

c01 CURSOR FOR
SELECT	cd_material,
	coalesce(CASE WHEN coalesce(obter_dose_w_item_prescr_gas(cd_protocolo, nr_sequencia, nr_prescricao_p, nr_seq_material, nr_seq_gas, 'O', nm_usuario_p),0)=0 THEN qt_dose  ELSE obter_dose_w_item_prescr_gas(cd_protocolo, nr_sequencia, nr_prescricao_p, nr_seq_material, nr_seq_gas, 'O', nm_usuario_p) END ,0),
	cd_unidade_medida, 
	ds_recomendacao, 
	ie_via_aplicacao, 
	ie_agrupador, 
	coalesce(cd_intervalo, cd_intervalo_p),
	qt_dose_peso, 
	ie_multiplicar_dose,
	ds_justificativa
from	protocolo_medic_material
where 	cd_protocolo = cd_protocolo_p
and	nr_sequencia = nr_sequencia_p
and	nr_seq_gas	 = nr_seq_gas_prot_p
and	ie_agrupador = 15;	


BEGIN

if (cd_protocolo_p IS NOT NULL AND cd_protocolo_p::text <> '')  and (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '')  and (nr_seq_gas_prot_p IS NOT NULL AND nr_seq_gas_prot_p::text <> '')  and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '')  and (nr_seq_gasoterapia_p IS NOT NULL AND nr_seq_gasoterapia_p::text <> '')  then
	
	
	select	dt_prev_execucao,
		nr_dia_util,
		CASE WHEN ie_inicio='ACM' THEN  'S'  ELSE 'N' END ,
		CASE WHEN ie_inicio='D' THEN  'S'  ELSE 'N' END
	into STRICT	dt_prev_execucao_w,
		nr_dia_util_w,
		ie_acm_w,
		ie_se_necessario_w
	from	prescr_gasoterapia
	where	nr_sequencia = nr_seq_gasoterapia_p;
	
	select	cd_estabelecimento,
		dt_primeiro_horario,
		dt_prescricao,
		nr_horas_validade
	into STRICT	cd_estabelecimento_w,
		dt_primeiro_horario_w,
		dt_prescricao_w,
		nr_horas_validade_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;

	open C01;
	loop
	fetch C01 into	
		cd_material_w,
		qt_dose_w,
		cd_unidade_medida_w,
		ds_recomendacao_w,	
		ie_via_aplicacao_w,	
		ie_agrupador_w,		
		cd_intervalo_w,		
		qt_dose_peso_w,		
		ie_multiplicar_dose_w,
		ds_justificativa_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		
		Select	coalesce(max(nr_sequencia),0) + 1
		into STRICT	nr_sequencia_w
		from	prescr_material
		where	nr_prescricao = nr_prescricao_p;
		
		if (coalesce(qt_peso_p,0) > 0) and (qt_dose_peso_w IS NOT NULL AND qt_dose_peso_w::text <> '')then
			qt_dose_w := coalesce(qt_dose_peso_w * qt_peso_p,0);
		end if;
		
		Select	substr(obter_dados_material_estab(cd_material,cd_estabelecimento_w,'UMS'),1,30) cd_unidade_medida_consumo
		into STRICT 	cd_unidade_medida_Cons_w
		from	Material
		where 	cd_material = cd_material_w;
				
		select	coalesce(max(qt_conversao),1)
		into STRICT	qt_conversao_w
		from	material_conversao_unidade
		where	cd_material		= cd_material_w
		and	cd_unidade_medida	= cd_unidade_medida_w;

		select 	coalesce(max(ie_limpa_prim_hor),'N'),
			coalesce(max(qt_min_intervalo),0)
		into STRICT	ie_limpa_prim_hor_w,
			qt_min_intervalo_w
		from	intervalo_prescricao
		where	cd_intervalo = cd_intervalo_w;
		
		nr_ocorrencia_w := 0;
		
		SELECT * FROM Calcular_Horario_Prescricao(nr_prescricao_p, cd_intervalo_w, coalesce(dt_prev_execucao_w, coalesce(dt_primeiro_horario_w,dt_prescricao_w)), coalesce(dt_prev_execucao_w,dt_primeiro_horario_w), 24, cd_material_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_ww, ds_horarios2_ww, 'N', null) INTO STRICT nr_ocorrencia_w, ds_horarios_ww, ds_horarios2_ww;
	
		ds_horarios_ww	:= ds_horarios_ww || ds_horarios2_ww;
							
		Insert	into Prescr_material(
			nr_prescricao,
			nr_sequencia,
			ie_origem_inf,
			cd_material,
			cd_unidade_medida_dose,
			cd_unidade_medida,
			qt_dose,
			qt_unitaria,
			qt_material,
			dt_atualizacao,
			nm_usuario,
			cd_intervalo,
			ds_observacao,
			nr_seq_gasoterapia,
			ie_agrupador,
			ie_medicacao_paciente,
			ie_se_necessario,
			ie_urgencia,
			ie_suspenso,
			ie_utiliza_kit,
			ie_status_cirurgia,
			ie_bomba_infusao,
			ie_aplic_bolus, 
			ie_aplic_lenta, 
			ie_acm,
			cd_motivo_baixa,
			qt_conversao_dose,
			ds_horarios,
			nr_ocorrencia,
			ie_via_aplicacao,
			ie_recons_diluente_fixo,
			ie_sem_aprazamento,
			ie_cobra_paciente,
			ie_intervalo_dif,
			hr_prim_horario,
			ds_justificativa,
			nr_dia_util,
			qt_min_intervalo,
			cd_protocolo,
			nr_seq_protocolo)
		Values (NR_PRESCRICAO_P,
			nr_sequencia_w,
			'A',
			cd_material_w,
			cd_unidade_medida_w,
			cd_unidade_medida_Cons_w,
			qt_dose_w,
			coalesce(dividir(qt_dose_w,qt_conversao_w),1),
			coalesce(qt_dose_w,0),
			clock_timestamp(),
			nm_usuario_p,
			cd_intervalo_w,
			ds_recomendacao_w,
			nr_seq_gasoterapia_p,
			15,
			'N',
			ie_se_necessario_w,
			'N',
			'N',
			'N',
			'GI',
			'N',
			'N',
			'N',
			ie_acm_w,
			0,
			qt_conversao_w,
			CASE WHEN ie_limpa_prim_hor_w='N' THEN ds_horarios_ww  ELSE '' END ,
			nr_ocorrencia_w,
			ie_via_aplicacao_w,
			'N',
			'N',
			'S',
			'N',
			CASE WHEN ie_limpa_prim_hor_w='N' THEN to_char(coalesce(dt_prev_execucao_w,dt_primeiro_horario_w),'hh24:mi')  ELSE '' END ,
			ds_justificativa_w,
			nr_dia_util_w,
			qt_min_intervalo_w,
			cd_protocolo_p,
			nr_sequencia_p); --insert prescr_material cd_protoclo item gasoterapia
			
		SELECT * FROM Obter_Quant_Dispensar(cd_estabelecimento_w, cd_material_w, NR_PRESCRICAO_P, nr_sequencia_w, cd_intervalo_w, null, dividir(qt_dose_w,qt_conversao_w), null, nr_ocorrencia_w, null, '1', cd_unidade_medida_w, 1, qt_dose_w, qt_total_disp_w, ie_regra_disp_w, ds_erro_w, 'N', 'N') INTO STRICT qt_dose_w, qt_total_disp_w, ie_regra_disp_w, ds_erro_w;
		
		update	prescr_material
		set	qt_material		= coalesce(qt_dose_w,0),
			qt_total_dispensar	= qt_total_disp_w,
			ie_regra_disp		= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END
		where	nr_prescricao		= NR_PRESCRICAO_P
		and	nr_sequencia		= nr_sequencia_w;
		
		ds_erro_w := consistir_prescr_material(NR_PRESCRICAO_P, nr_sequencia_w, nm_usuario_p, obter_perfil_Ativo, ds_erro_w);
		
		end;
	end loop;
	close C01;
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_mat_med_assoc_gas_prot ( cd_protocolo_p bigint, nr_sequencia_p bigint, nr_seq_gas_prot_p bigint, nr_prescricao_p bigint, qt_peso_p bigint, nr_seq_gasoterapia_p bigint, nm_usuario_p text, cd_intervalo_p text default null) FROM PUBLIC;

