-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicar_nota_fiscal_item ( nr_sequencia_p bigint, nr_item_nf_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_item_nf_w	integer;
cd_material_w   nota_fiscal_item.cd_material%type;
qtd_w           bigint;


BEGIN

select	coalesce(max(nr_item_nf),0) + 1
into STRICT	nr_item_nf_w
from	nota_fiscal_item
where	nr_sequencia = nr_sequencia_p;

if (substr(coalesce(obter_valor_param_usuario(40, 42, obter_perfil_ativo, nm_usuario_p, OBTER_ESTABELECIMENTO_ATIVO),'S'),1,1) = 'N') then

select  max(cd_material)
into STRICT    cd_material_w
from    nota_fiscal_item
where   nr_sequencia = nr_sequencia_p
and     nr_item_nf = nr_item_nf_p;

select  count(*)
into STRICT    qtd_w
from    nota_fiscal_item
where   nr_sequencia = nr_sequencia_p
and     cd_material = cd_material_w;

	if (qtd_w > 0) then	
		CALL wheb_mensagem_pck.exibir_mensagem_abort(168856);
	end if;

end if;

insert	into nota_fiscal_item(
	nr_sequencia,
	cd_estabelecimento,
	cd_cgc_emitente,
	cd_serie_nf,
	nr_sequencia_nf,
	nr_item_nf,
	cd_natureza_operacao,
	qt_item_nf,
	vl_unitario_item_nf,
	vl_total_item_nf,
	dt_atualizacao,
	nm_usuario,
	vl_frete,
	vl_desconto,
	vl_despesa_acessoria,
	cd_material,
	cd_procedimento,
	cd_setor_atendimento,
	cd_conta,
	cd_local_estoque,
	ds_observacao,
	qt_peso_bruto,
	qt_peso_liquido,
	cd_unidade_medida_compra,
	qt_item_estoque,
	cd_unidade_medida_estoque,
	cd_lote_fabricacao,
	dt_validade,
	dt_atualizacao_estoque,
	cd_conta_contabil,
	vl_desconto_rateio,
	vl_seguro,
	cd_centro_custo,
	cd_material_estoque,
	ie_origem_proced,
	vl_liquido,
	pr_desconto,
	nr_seq_conta_financ,
	ds_complemento,
	nr_seq_proj_rec,
	vl_projeto,
	nr_atendimento,
	pr_desc_financ,
	vl_desc_financ,
	ds_inconsistencia,
	ds_justificativa,
	vl_liq_moeda_ref,
	nr_seq_unidade_adic,
	nr_seq_lote_fornec,
	ie_atualizar_barras,
	cd_barra_material,
	nr_sequencia_vinc_consig,
	nr_nota_fiscal,
	ds_barras,
	cd_imobilizado,
	cd_imob_serie,
	ie_indeterminado,
	nr_nfe_imp,
	nr_seq_classif_trib,
	nr_seq_cnae,
	nr_seq_marca,
	dt_inicio_garantia,
	dt_fim_garantia,
	nr_seq_equipamento,
	dt_fabricacao,
	nr_seq_variacao_fiscal,
	ie_forma_gerado_empres,
	nr_seq_regra_contrato,
	dt_reg_importacao,
	ds_local_desemb,
	sg_uf_desemb,
	dt_desemb,
	cd_exportador,
	cd_fab_estrangeiro,
	vl_desc_adicao,
	nr_doc_importacao,
	nr_seq_proc_interno,
	dt_lib_estrut_pj,
	nm_usuario_lib,
	ds_justificativa_lib,
	ie_material_estoque,
	nr_seq_produto,
	nr_laudo,
	nr_item_sequencial,
	nr_contrato)
(SELECT	nr_sequencia,
	cd_estabelecimento,
	cd_cgc_emitente,
	cd_serie_nf,
	nr_sequencia_nf,
	nr_item_nf_w,
	cd_natureza_operacao,
	qt_item_nf,
	vl_unitario_item_nf,
	vl_total_item_nf,
	clock_timestamp(),
	nm_usuario_p,
	vl_frete,
	vl_desconto,
	vl_despesa_acessoria,
	cd_material,
	cd_procedimento,
	cd_setor_atendimento,
	cd_conta,
	cd_local_estoque,
	ds_observacao,
	qt_peso_bruto,
	qt_peso_liquido,
	cd_unidade_medida_compra,
	qt_item_estoque,
	cd_unidade_medida_estoque,
	cd_lote_fabricacao,
	dt_validade,
	dt_atualizacao_estoque,
	cd_conta_contabil,
	vl_desconto_rateio,
	vl_seguro,
	cd_centro_custo,
	cd_material_estoque,
	ie_origem_proced,
	vl_liquido,
	pr_desconto,
	nr_seq_conta_financ,
	ds_complemento,
	nr_seq_proj_rec,
	vl_projeto,
	nr_atendimento,
	pr_desc_financ,
	vl_desc_financ,
	ds_inconsistencia,
	ds_justificativa,
	vl_liq_moeda_ref,
	nr_seq_unidade_adic,
	nr_seq_lote_fornec,
	ie_atualizar_barras,
	cd_barra_material,
	nr_sequencia_vinc_consig,
	nr_nota_fiscal,
	ds_barras,
	cd_imobilizado,
	cd_imob_serie,
	ie_indeterminado,
	nr_nfe_imp,
	nr_seq_classif_trib,
	nr_seq_cnae,
	nr_seq_marca,
	dt_inicio_garantia,
	dt_fim_garantia,
	nr_seq_equipamento,
	dt_fabricacao,
	nr_seq_variacao_fiscal,
	ie_forma_gerado_empres,
	nr_seq_regra_contrato,
	dt_reg_importacao,
	ds_local_desemb,
	sg_uf_desemb,
	dt_desemb,
	cd_exportador,
	cd_fab_estrangeiro,
	vl_desc_adicao,
	nr_doc_importacao,
	nr_seq_proc_interno,
	dt_lib_estrut_pj,
	nm_usuario_lib,
	ds_justificativa_lib,
	ie_material_estoque,
	nr_seq_produto,
	nr_laudo,
	nr_item_sequencial,
	nr_contrato
from	nota_fiscal_item
where	nr_sequencia = nr_sequencia_p
and	nr_item_nf = nr_item_nf_p);

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_nota_fiscal_item ( nr_sequencia_p bigint, nr_item_nf_p bigint, nm_usuario_p text) FROM PUBLIC;

