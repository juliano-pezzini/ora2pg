-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mprev_cancelar_captacao ( nr_seq_captacao_p mprev_captacao.nr_sequencia%type, nm_usuario_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Cancelar a captação quando o número de tentativas ultrapasar a quantidade informada no
parâmetro [2] da função HDM - Captação.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[X]  Objetos do dicionário [X] Tasy (Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:

 -----------------------------------------------------------------------------------------------------------------
Alterações:

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
qt_tentativas_w		bigint;
qt_tentativas_cancel_w	bigint;



BEGIN
/*Obter a quantidade de tentativas para cancelar a captação cadastrado no parâmetro [2] da função HDM - Captação*/

									qt_tentativas_cancel_w := obter_param_usuario(10155, 2, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, qt_tentativas_cancel_w);
if (qt_tentativas_cancel_w > 0) then
	/*Obtem a quantidade de tentativas realizadas para captar a pessoa*/

	qt_tentativas_w	:= somente_numero(mprev_obter_dados_captacao(	nr_seq_captacao_p,
									clock_timestamp(),
									'QT'));
	if (qt_tentativas_w >= qt_tentativas_cancel_w) then

		/*Altera o status da captação para Cancelada*/

		CALL mprev_alterar_status_capt(	nr_seq_captacao_p,
						'C',
						nm_usuario_p);

	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mprev_cancelar_captacao ( nr_seq_captacao_p mprev_captacao.nr_sequencia%type, nm_usuario_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

