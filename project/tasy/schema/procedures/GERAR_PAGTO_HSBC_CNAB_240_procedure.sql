-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_pagto_hsbc_cnab_240 ( nr_seq_envio_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* PADRÃO CNAB 240 VERSÃO 04.40 DE 02/2016 */

ds_conteudo_w		varchar(240);
cd_estabelecimento_w	smallint;
nr_seq_apres_w		bigint	:= 0;

/* header de arquivo */

cd_agencia_estab_w	varchar(5);
cd_cgc_estab_w		varchar(14);
cd_convenio_banco_w	varchar(6);
dt_geracao_w		varchar(14);
nm_empresa_w		varchar(30);
nr_conta_estab_w	varchar(12);
nr_remessa_w		bigint;
ie_digito_estab_w	varchar(1);
ds_agencia_bancaria_w	varchar(20);
ds_endereco_agencia_w	varchar(25);
nr_contrato_w		varchar(6);

/* header de lote - DOC */

nr_lote_servico_w	bigint;
ie_forma_lanc_w		varchar(2);
ie_tipo_pagamento_w	varchar(3);
ie_finalidade_w		varchar(2);
ds_endereco_w		varchar(30);
nr_endereco_w		varchar(5);
ds_complemento_w	varchar(15);
ds_municipio_w		varchar(20);
nr_cep_w		varchar(8);
sg_estado_w		varchar(15);
nm_pessoa_ava_w		varchar(40);
cd_cgc_estab_ava_w	varchar(14);
qt_favorecido_w		integer;

c01 CURSOR FOR
SELECT	distinct
	CASE WHEN b.ie_tipo_pagamento='CC' THEN '01' WHEN b.ie_tipo_pagamento='DOC' THEN '03' WHEN b.ie_tipo_pagamento='TED' THEN '03' WHEN b.ie_tipo_pagamento='OP' THEN 30 END ,
	b.ie_tipo_pagamento,
	CASE WHEN b.ie_tipo_pagamento='CC' THEN '01'  ELSE '99' END
from	titulo_pagar_escrit b,
	banco_escritural a
where	b.ie_tipo_pagamento	in ('DOC','CC','OP','TED')
and	a.nr_sequencia		= b.nr_seq_escrit
and	a.nr_sequencia		= nr_seq_envio_p;

/* detalhe - DOC */

nr_sequencia_w		bigint;
cd_camara_compensacao_w	varchar(3);
cd_banco_w		smallint;
cd_agencia_bancaria_w	varchar(6);
nr_conta_w		varchar(20);
nm_pessoa_w		varchar(30);
nr_titulo_w		bigint;
dt_remessa_retorno_w	timestamp;
vl_escritural_w		double precision;
vl_acrescimo_w		double precision;
vl_desconto_w		double precision;
vl_despesa_w		double precision;
ie_tipo_inscricao_w	varchar(1);
nr_inscricao_w		varchar(14);
dt_vencimento_w		timestamp;
vl_juros_w		double precision;
vl_multa_w		double precision;
cd_agencia_conta_w	varchar(20);
ie_digito_conta_w	varchar(1);
nr_nosso_numero_w	varchar(16);
cd_agencia_w		varchar(5);
ds_bairro_w		varchar(15);
ds_endereco_dest_w	varchar(30);
nr_endereco_dest_w	varchar(5);
ds_complem_dest_w	varchar(15);
ds_municipio_dest_w	varchar(20);
nr_cep_dest_w		varchar(8);
sg_estado_dest_w	varchar(2);

c02 CURSOR FOR
SELECT	b.cd_banco,
	lpad(substr(b.cd_agencia_bancaria,1,5) || substr(b.ie_digito_agencia,1,1),6,'0'),
	rpad(substr(obter_nome_pf_pj(c.cd_pessoa_fisica,c.cd_cgc),1,30),30,' '),
	c.nr_titulo,
	b.vl_escritural,
	b.vl_acrescimo,
	b.vl_desconto,
	b.vl_despesa,
	lpad(coalesce(d.nr_cpf,c.cd_cgc),14,'0'),
	substr(b.nr_conta,1,19) || CASE WHEN length(b.ie_digito_conta)=2 THEN substr(b.ie_digito_conta,1,1)  ELSE null END ,
	rpad(CASE WHEN length(b.ie_digito_conta)=2 THEN substr(b.ie_digito_conta,2,1)  ELSE substr(b.ie_digito_conta,1,1) END ,1,' '),
	rpad(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'R'),1,30),30,' '),
	lpad(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'NR'),1,5),5,'0'),
	rpad(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'CO'),1,15),15,' '),
	rpad(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'B'),1,15),15,' '),
	rpad(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'CI'),1,20),20,' '),
	lpad(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'CEP'),1,8),8,'0'),
	rpad(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'UF'),1,2),2,' '),
	CASE WHEN coalesce(c.cd_pessoa_fisica::text, '') = '' THEN '2'  ELSE '1' END  ie_tipo_inscricao,
	b.cd_agencia_bancaria
FROM titulo_pagar_escrit b, banco_escritural a, titulo_pagar c
LEFT OUTER JOIN pessoa_fisica d ON (c.cd_pessoa_fisica = d.cd_pessoa_fisica)
WHERE b.nr_titulo		= c.nr_titulo and b.ie_tipo_pagamento	= ie_tipo_pagamento_w and a.nr_sequencia		= b.nr_seq_escrit and a.nr_sequencia		= nr_seq_envio_p;

/* trailer lote - DOC */

vl_total_w		double precision;

/* header de lote - BLQ */

c03 CURSOR FOR
SELECT	distinct
	CASE WHEN b.cd_banco=399 THEN '30'  ELSE '31' END ,
	b.ie_tipo_pagamento
from	titulo_pagar_escrit b,
	banco_escritural a
where	b.ie_tipo_pagamento	= 'BLQ'
and	a.nr_sequencia		= b.nr_seq_escrit
and	a.nr_sequencia		= nr_seq_envio_p;

/* detalhe - BLQ */

nr_bloqueto_w		titulo_pagar.nr_bloqueto%type;
nr_bloqueto_edit_w	varchar(44);
ie_tipo_identificacao_w	varchar(2);

c04 CURSOR FOR
SELECT	rpad(substr(obter_nome_pf_pj(c.cd_pessoa_fisica,c.cd_cgc),1,30),30,' '),
	c.nr_titulo,
	b.vl_escritural,
	b.vl_acrescimo,
	b.vl_desconto,
	b.vl_despesa,
	c.dt_vencimento_atual,
	b.vl_juros,
	b.vl_multa,
	c.nr_bloqueto,
	lpad(substr(b.cd_agencia_bancaria,1,5),0,' '),
	substr(b.nr_conta,1,19) || CASE WHEN length(b.ie_digito_conta)=2 THEN substr(b.ie_digito_conta,1,1)  ELSE null END ,
	rpad(CASE WHEN length(b.ie_digito_conta)=2 THEN substr(b.ie_digito_conta,2,1)  ELSE substr(b.ie_digito_conta,1,1) END ,1,' '),
	lpad(coalesce(d.nr_cpf,c.cd_cgc),14,'0'),
	rpad(substr(c.nr_nosso_numero,1,16),16,' '),
	CASE WHEN coalesce(c.cd_pessoa_fisica::text, '') = '' THEN '2'  ELSE '1' END  ie_tipo_inscricao
FROM titulo_pagar_escrit b, banco_escritural a, titulo_pagar c
LEFT OUTER JOIN pessoa_fisica d ON (c.cd_pessoa_fisica = d.cd_pessoa_fisica)
WHERE b.nr_titulo		= c.nr_titulo and b.ie_tipo_pagamento	= ie_tipo_pagamento_w and ie_forma_lanc_w		= CASE WHEN b.cd_banco=399 THEN '30'  ELSE '31' END and a.nr_sequencia		= b.nr_seq_escrit and a.nr_sequencia		= nr_seq_envio_p;

/* trailer do arquivo */

qt_registro_w		bigint;


BEGIN

delete	from w_envio_banco
where	nm_usuario	= nm_usuario_p;

/* header de arquivo */

nr_seq_apres_w		:= coalesce(nr_seq_apres_w,0) + 1;

select	lpad(b.cd_cgc,14,'0'),
	rpad(substr(coalesce(c.cd_convenio_banco,' '),1,6),6,' '),
	rpad(substr(coalesce(c.nr_contrato,' '),1,6),6,' '),
	lpad(substr(c.cd_agencia_bancaria,1,5),5,'0'),
	lpad(somente_numero(substr(c.cd_conta,1,12)),12,'0'),
	rpad(substr(obter_nome_estabelecimento(b.cd_estabelecimento),1,30),30,' '),
	to_char(clock_timestamp(),'ddmmyyyyhhmiss'),
	coalesce(a.nr_remessa,a.nr_sequencia),
	b.cd_estabelecimento,
	a.dt_remessa_retorno,
	rpad(substr(obter_dados_pf_pj(null,b.cd_cgc,'R'),1,30),30,' '),
	lpad(substr(obter_dados_pf_pj(null,b.cd_cgc,'NR'),1,5),5,'0'),
	rpad(substr(obter_dados_pf_pj(null,b.cd_cgc,'CO'),1,15),15,' '),
	rpad(substr(obter_dados_pf_pj(null,b.cd_cgc,'CI'),1,20),20,' '),
	lpad(substr(obter_dados_pf_pj(null,b.cd_cgc,'CEP'),1,8),8,'0'),
	rpad(substr(obter_dados_pf_pj(null,b.cd_cgc,'UF'),1,2),2,' '),
	substr(coalesce(c.ie_digito_conta,'0'),1,1),
	rpad(substr(d.ds_agencia_bancaria,1,20),20,' '),
	rpad(substr(d.ds_endereco,1,25),25,' ')
into STRICT	cd_cgc_estab_w,
	cd_convenio_banco_w,
	nr_contrato_w,
	cd_agencia_estab_w,
	nr_conta_estab_w,
	nm_empresa_w,
	dt_geracao_w,
	nr_remessa_w,
	cd_estabelecimento_w,
	dt_remessa_retorno_w,
	ds_endereco_w,
	nr_endereco_w,
	ds_complemento_w,
	ds_municipio_w,
	nr_cep_w,
	sg_estado_w,
	ie_digito_estab_w,
	ds_agencia_bancaria_w,
	ds_endereco_agencia_w
from	agencia_bancaria d,
	banco_estabelecimento c,
	estabelecimento b,
	banco_escritural a
where	c.cd_banco		= d.cd_banco
and	c.cd_agencia_bancaria	= d.cd_agencia_bancaria
and	a.nr_seq_conta_banco	= c.nr_sequencia
and	a.cd_estabelecimento	= b.cd_estabelecimento
and	a.nr_sequencia		= nr_seq_envio_p;

ds_conteudo_w	:=	'399' ||
			'0000' ||
			'0' ||
			rpad(' ',9,' ') ||
			'2' ||
			cd_cgc_estab_w ||
			nr_contrato_w ||
			rpad(' ',14,' ') ||
			cd_agencia_estab_w ||
			' ' ||
			nr_conta_estab_w ||
			ie_digito_estab_w ||
			' ' ||
			nm_empresa_w ||
			rpad('Banco HSBC',30,' ') ||
			rpad(' ',10,' ') ||
			'1' ||
			dt_geracao_w ||
			lpad(nr_remessa_w,6,'0') ||
			'020' ||
			'01600' ||
			'CPG' ||
			'Y2K' ||
			rpad(' ',63,' ');

insert	into w_envio_banco(cd_estabelecimento,
	ds_conteudo,
	dt_atualizacao,
	nm_usuario,
	nr_seq_apres,
	nr_seq_apres_2,
	nr_sequencia)
values (cd_estabelecimento_w,
	ds_conteudo_w,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_apres_w,
	nr_seq_apres_w,
	nextval('w_envio_banco_seq'));

open	c01;
loop
fetch	c01 into
	ie_forma_lanc_w,
	ie_tipo_pagamento_w,
	ie_finalidade_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	/* header de lote */

	nr_lote_servico_w	:= coalesce(nr_lote_servico_w,0) + 1;
	nr_seq_apres_w		:= coalesce(nr_seq_apres_w,0) + 1;
	nr_sequencia_w		:= 0;
	vl_total_w		:= 0;

	ds_conteudo_w	:=	'399' ||
				lpad(nr_lote_servico_w,4,'0') ||
				'1' ||
				'C' ||
				'20' ||
				ie_forma_lanc_w ||
				'020' ||
				' ' ||
				'2' ||
				cd_cgc_estab_w ||
				nr_contrato_w ||
				rpad(' ',14,' ') ||
				cd_agencia_estab_w ||
				' ' ||
				nr_conta_estab_w ||
				ie_digito_estab_w ||
				' ' ||
				nm_empresa_w ||
				rpad(' ',40,' ') ||
				ds_endereco_w ||
				nr_endereco_w ||
				ds_complemento_w ||
				ds_municipio_w ||
				nr_cep_w ||
				substr(sg_estado_w,1,2) ||
				'S' ||
				rpad(' ',17,' ');

	insert	into w_envio_banco(cd_estabelecimento,
		ds_conteudo,
		dt_atualizacao,
		nm_usuario,
		nr_seq_apres,
		nr_seq_apres_2,
		nr_sequencia)
	values (cd_estabelecimento_w,
		ds_conteudo_w,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_apres_w,
		nr_seq_apres_w,
		nextval('w_envio_banco_seq'));

	open	c02;
	loop
	fetch	c02 into
		cd_banco_w,
		cd_agencia_bancaria_w,
		nm_pessoa_w,
		nr_titulo_w,
		vl_escritural_w,
		vl_acrescimo_w,
		vl_desconto_w,
		vl_despesa_w,
		nr_inscricao_w,
		nr_conta_w,
		ie_digito_conta_w,
		ds_endereco_dest_w,
		nr_endereco_dest_w,
		ds_complem_dest_w,
		ds_bairro_w,
		ds_municipio_dest_w,
		nr_cep_dest_w,
		sg_estado_dest_w,
		ie_tipo_inscricao_w,
		cd_agencia_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */

		/* segmento A */

		nr_sequencia_w	:= coalesce(nr_sequencia_w,0) + 1;
		nr_seq_apres_w	:= coalesce(nr_seq_apres_w,0) + 1;
		qt_registro_w	:= coalesce(qt_registro_w,0) + 1;
		vl_total_w	:= coalesce(vl_total_w,0) + (coalesce(vl_escritural_w,0) - coalesce(vl_desconto_w,0) + coalesce(vl_acrescimo_w,0) + coalesce(vl_despesa_w,0));

		cd_agencia_conta_w	:=	lpad(substr(coalesce(somente_numero(cd_agencia_w),0),1,5),5,'0') ||
						' ' ||
						lpad(substr(coalesce(nr_conta_w,0),1,12),12,'0') ||
						coalesce(ie_digito_conta_w,' ') ||
						' ';

		ds_conteudo_w	:=	'399' ||
					lpad(nr_lote_servico_w,4,'0') ||
					'3' ||
					lpad(nr_sequencia_w,5,'0') ||
					'A' ||
					'0' ||
					'00' ||
					'018' ||
					lpad(coalesce(cd_banco_w,0),3,'0') ||
					cd_agencia_conta_w ||
					nm_pessoa_w ||
					rpad(nr_titulo_w,16,' ') ||
					rpad(' ',4,' ') ||
					to_char(dt_remessa_retorno_w,'ddmmyyyy') ||
					'R$ ' ||
					rpad(' ',17,' ') ||
					lpad(somente_numero(to_char(coalesce(vl_escritural_w,0) - coalesce(vl_desconto_w,0) + coalesce(vl_acrescimo_w,0) + coalesce(vl_despesa_w,0),'99999999990.00')),13,'0') ||
					'S' ||
					rpad(' ',82,' ') ||
					'01' ||
					rpad(' ',5,' ') ||
					'CC' ||
					rpad(' ',3,' ') ||
					'0' ||
					rpad(' ',10,' ');

		insert	into w_envio_banco(cd_estabelecimento,
			ds_conteudo,
			dt_atualizacao,
			nm_usuario,
			nr_seq_apres,
			nr_seq_apres_2,
			nr_sequencia)
		values (cd_estabelecimento_w,
			ds_conteudo_w,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_apres_w,
			nr_seq_apres_w,
			nextval('w_envio_banco_seq'));

		/* segmento B */

		nr_sequencia_w	:= coalesce(nr_sequencia_w,0) + 1;
		nr_seq_apres_w	:= coalesce(nr_seq_apres_w,0) + 1;
		qt_registro_w	:= coalesce(qt_registro_w,0) + 1;

		ds_conteudo_w	:=	'399' ||
					lpad(nr_lote_servico_w,4,'0') ||
					'3' ||
					lpad(nr_sequencia_w,5,'0') ||
					'B' ||
					rpad(' ',3,' ') ||
					ie_tipo_inscricao_w ||
					nr_inscricao_w ||
					ds_endereco_dest_w ||
					nr_endereco_dest_w ||
					ds_complem_dest_w ||
					ds_bairro_w ||
					ds_municipio_dest_w ||
					nr_cep_dest_w ||
					substr(sg_estado_dest_w,1,2) ||
					rpad(' ',113,' ');

		insert	into w_envio_banco(cd_estabelecimento,
			ds_conteudo,
			dt_atualizacao,
			nm_usuario,
			nr_seq_apres,
			nr_seq_apres_2,
			nr_sequencia)
		values (cd_estabelecimento_w,
			ds_conteudo_w,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_apres_w,
			nr_seq_apres_w,
			nextval('w_envio_banco_seq'));

	end	loop;
	close	c02;

	/* trailer de lote */

	nr_seq_apres_w	:= coalesce(nr_seq_apres_w,0) + 1;

	ds_conteudo_w	:=	'399' ||
				lpad(nr_lote_servico_w,4,'0') ||
				'5' ||
				rpad(' ',9,' ') ||
				lpad(nr_sequencia_w + 2,6,'0') ||
				rpad(' ',3,' ') ||
				lpad(somente_numero(to_char(coalesce(vl_total_w,0),'9999999999990.00')),15,'0') ||
				rpad(' ',199,' ');

	insert	into w_envio_banco(cd_estabelecimento,
		ds_conteudo,
		dt_atualizacao,
		nm_usuario,
		nr_seq_apres,
		nr_seq_apres_2,
		nr_sequencia)
	values (cd_estabelecimento_w,
		ds_conteudo_w,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_apres_w,
		nr_seq_apres_w,
		nextval('w_envio_banco_seq'));

end	loop;
close	c01;

open	c03;
loop
fetch	c03 into
	ie_forma_lanc_w,
	ie_tipo_pagamento_w;
EXIT WHEN NOT FOUND; /* apply on c03 */

	/* header de lote - BLQ */

	nr_lote_servico_w	:= coalesce(nr_lote_servico_w,0) + 1;
	nr_seq_apres_w		:= coalesce(nr_seq_apres_w,0) + 1;
	nr_sequencia_w		:= 0;
	vl_total_w		:= 0;

	ds_conteudo_w	:=	'399' ||
				lpad(nr_lote_servico_w,4,'0') ||
				'1' ||
				'C' ||
				'01' ||
				ie_forma_lanc_w ||
				'020' ||
				' ' ||
				'2' ||
				cd_cgc_estab_w ||
				nr_contrato_w ||
				rpad(' ',14,' ') ||
				cd_agencia_estab_w ||
				' ' ||
				nr_conta_estab_w ||
				ie_digito_estab_w ||
				' ' ||
				nm_empresa_w ||
				rpad(' ',40,' ') ||
				ds_endereco_w ||
				nr_endereco_w ||
				ds_complemento_w ||
				ds_municipio_w ||
				nr_cep_w ||
				substr(sg_estado_w,1,2) ||
				'S' ||
				rpad(' ',17,' ');

	
	insert	into w_envio_banco(cd_estabelecimento,
		ds_conteudo,
		dt_atualizacao,
		nm_usuario,
		nr_seq_apres,
		nr_seq_apres_2,
		nr_sequencia)
	values (cd_estabelecimento_w,
		ds_conteudo_w,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_apres_w,
		nr_seq_apres_w,
		nextval('w_envio_banco_seq'));

	open	c04;
	loop
	fetch	c04 into
		nm_pessoa_w,
		nr_titulo_w,
		vl_escritural_w,
		vl_acrescimo_w,
		vl_desconto_w,
		vl_despesa_w,
		dt_vencimento_w,
		vl_juros_w,
		vl_multa_w,
		nr_bloqueto_w,
		cd_agencia_conta_w,
		nr_conta_w,
		ie_digito_conta_w,
		nr_inscricao_w,
		nr_nosso_numero_w,
		ie_tipo_inscricao_w;
	EXIT WHEN NOT FOUND; /* apply on c04 */

		/* segmento J */

		nr_sequencia_w	:= coalesce(nr_sequencia_w,0) + 1;
		nr_seq_apres_w	:= coalesce(nr_seq_apres_w,0) + 1;
		qt_registro_w	:= coalesce(qt_registro_w,0) + 1;
		vl_total_w	:= coalesce(vl_total_w,0) + (coalesce(vl_escritural_w,0) - coalesce(vl_desconto_w,0) + coalesce(vl_acrescimo_w,0) + coalesce(vl_despesa_w,0));

		if (length(nr_bloqueto_w) > 44) then
			nr_bloqueto_edit_w	:= rpad(substr(nr_bloqueto_w,1,4) || substr(nr_bloqueto_w,33,15) || substr(nr_bloqueto_w,5,5) || substr(nr_bloqueto_w,11,10) || substr(nr_bloqueto_w,22,10),44,' ');
		else
			nr_bloqueto_edit_w	:= rpad(substr(nr_bloqueto_w,1,44),44,' ');
		end if;

		ds_conteudo_w	:=	'399' ||
					lpad(nr_lote_servico_w,4,'0') ||
					'3' ||
					lpad(nr_sequencia_w,5,'0') ||
					'J' ||
					'0' ||
					'00' ||
					nr_bloqueto_edit_w ||
					nm_pessoa_w ||
					to_char(dt_vencimento_w,'ddmmyyyy') ||
					rpad(' ',2,' ') ||
					lpad(somente_numero(to_char(coalesce(vl_escritural_w,0),'99999999990.00')),13,'0') ||
					rpad(' ',2,' ') ||
					lpad(somente_numero(to_char(coalesce(vl_desconto_w,0),'99999999990.00')),13,'0') ||
					rpad(' ',2,' ') ||
					lpad(somente_numero(to_char(coalesce(vl_multa_w,0) + coalesce(vl_juros_w,0),'99999999990.00')),13,'0') ||
					to_char(dt_remessa_retorno_w,'ddmmyyyy') ||
					rpad(' ',2,' ') ||
					lpad(somente_numero(to_char(coalesce(vl_escritural_w,0) - coalesce(vl_desconto_w,0) + coalesce(vl_acrescimo_w,0) + coalesce(vl_despesa_w,0),'99999999990.00')),13,'0') ||
					rpad(' ',2,' ') ||
					rpad('0',13,'0') ||
					rpad(nr_titulo_w,20,' ') ||
					rpad(' ',22,' ') ||
					'S' ||
					rpad(' ',15,' ');

		insert	into w_envio_banco(cd_estabelecimento,
			ds_conteudo,
			dt_atualizacao,
			nm_usuario,
			nr_seq_apres,
			nr_seq_apres_2,
			nr_sequencia)
		values (cd_estabelecimento_w,
			ds_conteudo_w,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_apres_w,
			nr_seq_apres_w,
			nextval('w_envio_banco_seq'));
		
		/* Para títulos com valor igual ou superior a 250.000,00 o segmento J52 é obrigatório */


		--if (nvl(vl_escritural_w,0) >= 250000) then
			cd_cgc_estab_ava_w	:= '0';
			nm_pessoa_ava_w		:= ' ';
			
			select	count(*)
			into STRICT	qt_favorecido_w
			from	titulo_pagar_favorecido a
			where	a.nr_titulo	= nr_titulo_w;

			if (coalesce(qt_favorecido_w,0)	> 0) then
				select	coalesce(a.cd_cgc,a.cd_pessoa_fisica),
					rpad(substr(obter_nome_pf_pj(a.cd_pessoa_fisica,a.cd_cgc),1,30),30,' ')
				into STRICT	cd_cgc_estab_ava_w,
				        nm_pessoa_ava_w
				from	titulo_pagar_favorecido a
				where	a.nr_titulo	= nr_titulo_w;
			end if;

			nr_sequencia_w	:= coalesce(nr_sequencia_w,0) + 1;
			nr_seq_apres_w	:= coalesce(nr_seq_apres_w,0) + 1;
			qt_registro_w	:= coalesce(qt_registro_w,0) + 1;

			ds_conteudo_w	:=	'399' ||
						lpad(nr_lote_servico_w,4,'0') ||
						'3' ||
						lpad(nr_sequencia_w,5,'0') ||
						'J' ||
						' ' ||
						rpad(' ',2,' ') ||
						'52' ||
						'2' ||
						lpad(cd_cgc_estab_w,15,'0') ||
						rpad(nm_empresa_w,40,' ') ||
						ie_tipo_inscricao_w ||
						lpad(nr_inscricao_w,15,'0') ||
						rpad(nm_pessoa_w,40,' ') ||
						substr(ie_tipo_inscricao_w,2,1) ||		--132 - 132
						lpad(nr_inscricao_w,15,'0') ||			--133 - 147
						rpad(nm_pessoa_w,40,' ') ||			--148 - 187
						rpad(' ',52,' ');				--188 - 240
						--'0' ||

						--rpad('0',15,'0') ||

						--rpad(' ',40,' ') ||

						--rpad(' ',53,' ');
			insert	into w_envio_banco(cd_estabelecimento,
				ds_conteudo,
				dt_atualizacao,
				nm_usuario,
				nr_seq_apres,
				nr_seq_apres_2,
				nr_sequencia)
			values (cd_estabelecimento_w,
				ds_conteudo_w,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_apres_w,
				nr_seq_apres_w,
				nextval('w_envio_banco_seq'));
		--end if;


		/* segmento K - ahoffelder 05/11/2013 - retirei o segmento K por causa da OS 655374, onde o banco afirmou que o segmento K não deve ser gerado caso haja código de barras no título */

		if (coalesce(trim(both nr_bloqueto_w)::text, '') = '') then

			nr_sequencia_w	:= coalesce(nr_sequencia_w,0) + 1;
			nr_seq_apres_w	:= coalesce(nr_seq_apres_w,0) + 1;
			qt_registro_w	:= coalesce(qt_registro_w,0) + 1;

			ds_conteudo_w	:=	'399' ||
						lpad(nr_lote_servico_w,4,'0') ||
						'3' ||
						lpad(nr_sequencia_w,5,'0') ||
						'K' ||
						'0' ||
						'00' ||
						rpad(' ',3,' ') ||
						'399' ||
						rpad('Banco HSBC',20,' ') ||
						cd_agencia_estab_w ||
						ds_agencia_bancaria_w ||
						ds_endereco_agencia_w ||
						ie_tipo_inscricao_w ||
						nr_inscricao_w ||
						cd_agencia_bancaria_w ||
						' ' ||
						nr_conta_w ||
						ie_digito_conta_w ||
						' ' ||
						nm_pessoa_w ||
						rpad(nr_titulo_w,20,' ') ||
						nr_nosso_numero_w ||
						rpad(' ',4,' ') ||
						to_char(dt_remessa_retorno_w,'ddmmyyyy') ||
						rpad(' ',2,' ') ||
						lpad(somente_numero(to_char(coalesce(vl_escritural_w,0) - coalesce(vl_desconto_w,0) + coalesce(vl_acrescimo_w,0) + coalesce(vl_despesa_w,0),'99999999990.00')),13,'0') ||
						rpad(' ',19,' ');

			insert	into w_envio_banco(cd_estabelecimento,
				ds_conteudo,
				dt_atualizacao,
				nm_usuario,
				nr_seq_apres,
				nr_seq_apres_2,
				nr_sequencia)
			values (cd_estabelecimento_w,
				ds_conteudo_w,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_apres_w,
				nr_seq_apres_w,
				nextval('w_envio_banco_seq'));

		end if;

	end	loop;
	close	c04;

	/* trailer de lote */

	nr_seq_apres_w	:= coalesce(nr_seq_apres_w,0) + 1;

	ds_conteudo_w	:=	'399' ||
				lpad(nr_lote_servico_w,4,'0') ||
				'5' ||
				rpad(' ',9,' ') ||
				lpad(nr_sequencia_w + 2,6,'0') ||
				rpad(' ',3,' ') ||
				lpad(somente_numero(to_char(coalesce(vl_total_w,0),'9999999999990.00')),15,'0') ||
				' ' ||
				'000000000000000' ||
				rpad(' ',183,' ');

	insert	into w_envio_banco(cd_estabelecimento,
		ds_conteudo,
		dt_atualizacao,
		nm_usuario,
		nr_seq_apres,
		nr_seq_apres_2,
		nr_sequencia)
	values (cd_estabelecimento_w,
		ds_conteudo_w,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_apres_w,
		nr_seq_apres_w,
		nextval('w_envio_banco_seq'));

end	loop;
close	c03;

/* trailer de arquivo */

nr_seq_apres_w	:= coalesce(nr_seq_apres_w,0) + 1;

ds_conteudo_w	:=	'399' ||
			'9999' ||
			'9' ||
			rpad(' ',9,' ') ||
			lpad(nr_lote_servico_w,6,'0') ||
			lpad(coalesce(qt_registro_w,0) + (coalesce(nr_lote_servico_w,0) * 2) + 2,6,'0') ||	/* registros detalhe + header e trailer dos lotes + header e trailer do arquivo */
			rpad(' ',211,' ');

insert	into w_envio_banco(cd_estabelecimento,
	ds_conteudo,
	dt_atualizacao,
	nm_usuario,
	nr_seq_apres,
	nr_seq_apres_2,
	nr_sequencia)
values (cd_estabelecimento_w,
	ds_conteudo_w,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_apres_w,
	nr_seq_apres_w,
	nextval('w_envio_banco_seq'));

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_pagto_hsbc_cnab_240 ( nr_seq_envio_p bigint, nm_usuario_p text) FROM PUBLIC;

