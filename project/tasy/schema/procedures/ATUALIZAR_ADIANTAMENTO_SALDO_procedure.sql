-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_adiantamento_saldo (cd_estabelecimento_p bigint, nr_interno_conta_p bigint, nr_adiantamento_p bigint, nm_usuario_p text, nr_titulo_p bigint default null) AS $body$
DECLARE


ie_tipo_adiantamento_w	smallint;
vl_saldo_w		double precision;
vl_especie_w		double precision;
vl_adiantamento_w	double precision;
vl_atualizado_w		double precision;
vl_saldo_atualizar_w	double precision;
cd_moeda_w		integer;
nr_seq_adiant_w		bigint;

dt_baixa_w			timestamp;
vl_saldo_adiant_w	adiantamento.vl_saldo%type;
ie_utiliza_data_tit_w	varchar(1);
dt_baixa_adiant_w	titulo_receber_liq.dt_recebimento%type;


BEGIN
/*OS 2054132 - Tratado igual faz na rotina Atualizar_Saldo_Adiantamento*/

ie_utiliza_data_tit_w	:= obter_valor_param_usuario(801,149,obter_perfil_ativo,nm_usuario_p,cd_estabelecimento_p);

if ( coalesce(nr_titulo_p,0) <> 0 ) and ( coalesce(ie_utiliza_data_tit_w,'N') = 'S') then

	select	max(dt_recebimento)
	into STRICT	dt_baixa_adiant_w
	from	titulo_receber_liq a
	where	nr_sequencia	=
		(SELECT	max(x.nr_sequencia)
		from	titulo_receber_liq x
		where	x.nr_adiantamento	= nr_adiantamento_p
		and	x.nr_titulo		= nr_titulo_p)
	and	nr_adiantamento	= nr_adiantamento_p
	and	nr_titulo	= nr_titulo_p;
else
	dt_baixa_adiant_w	:= clock_timestamp();
end if;
/*OS 2054132 - FIM*/

select	max(ie_tipo_adiant)
into STRICT	ie_tipo_adiantamento_w
from	conta_paciente_adiant
where	nr_interno_conta	= nr_interno_conta_p
and	nr_adiantamento		= nr_adiantamento_p;

select	cd_moeda_padrao
into STRICT	cd_moeda_w
from	parametro_contas_receber
where	cd_estabelecimento	= cd_estabelecimento_p;

if (ie_tipo_adiantamento_w IS NOT NULL AND ie_tipo_adiantamento_w::text <> '') then
	begin

	select	vl_adiantamento,
		vl_saldo,
		vl_especie
	into STRICT	vl_adiantamento_w,
		vl_saldo_w,
		vl_especie_w
	from	adiantamento
	where	nr_adiantamento	= nr_adiantamento_p;


	if (ie_tipo_adiantamento_w = 1) then
		begin
		vl_atualizado_w	:= vl_adiantamento_w - vl_especie_w;

		if (vl_saldo_w = vl_especie_w) then
			vl_saldo_atualizar_w := vl_atualizado_w;
		else
			vl_saldo_atualizar_w := vl_saldo_w - vl_especie_w;
		end if;


		update	adiantamento
		set	vl_saldo	= vl_saldo_atualizar_w,
			vl_especie	= vl_atualizado_w,
			dt_baixa	= CASE WHEN vl_atualizado_w=0 THEN  coalesce(dt_baixa_adiant_w,clock_timestamp())  ELSE null END ,
			nm_usuario	= nm_usuario_p
		where	nr_adiantamento	= nr_adiantamento_p;
		
		/*inicio alteracao OS 752158. Nao sei o motivo mas o vl_saldo estava sendo setado como zero mas nao estava atualizando a data de baixa com sysdate, por isso foi feito novamente abaixo*/

		select	max(a.dt_baixa),
				max(a.vl_saldo)
		into STRICT	dt_baixa_w,
				vl_saldo_adiant_w
		from	adiantamento a
		where	a.nr_adiantamento = nr_adiantamento_p;
		
		if (coalesce(dt_baixa_w::text, '') = '') and (vl_saldo_adiant_w = 0) then
		
			update	adiantamento
			set		dt_baixa = CASE WHEN vl_saldo=0 THEN  coalesce(dt_baixa_adiant_w,clock_timestamp())  ELSE null END 
			where	nr_adiantamento = nr_adiantamento_p;
			
		end if;
		/*fim OS 752158*/

		end;
	else
		begin
		vl_atualizado_w	:= vl_adiantamento_w - vl_saldo_w;

		select	obter_saldo_adiantamento(nr_adiantamento_p, clock_timestamp())
		into STRICT	vl_atualizado_w
		;
		
		update	adiantamento
		set	vl_saldo	= vl_atualizado_w,
			dt_baixa	= CASE WHEN vl_atualizado_w=0 THEN  coalesce(dt_baixa_adiant_w,clock_timestamp())  ELSE null END ,
			nm_usuario	= nm_usuario_p
		where	nr_adiantamento = nr_adiantamento_p;

		end;
	end if;

	/* update	cheque_cr
	set	dt_deposito	= sysdate,
		nm_usuario	= nm_usuario_p
	where	dt_vencimento	<= sysdate
	and	nr_adiantamento	= nr_adiantamento_p
	and	dt_venda_terc is null; Francisco - OS 41205 - Comentei o update */
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_adiantamento_saldo (cd_estabelecimento_p bigint, nr_interno_conta_p bigint, nr_adiantamento_p bigint, nm_usuario_p text, nr_titulo_p bigint default null) FROM PUBLIC;

