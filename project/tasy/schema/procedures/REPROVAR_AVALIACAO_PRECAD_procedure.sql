-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reprovar_avaliacao_precad (nr_seq_avaliacao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_processo_p bigint default null, ds_justificativa_p text default '') AS $body$
DECLARE


nr_seq_tipo_avaliacao_w		pre_cad_avaliacao.nr_seq_tipo_avaliacao%type;
nr_nivel_w			pre_cad_avaliacao.nr_nivel%type;
ie_tipo_pro_w 			processo_avaliacao.ie_tipo_processo%type;
cd_tipo_pessoa_w		processo_avaliacao.cd_tipo_pessoa%type := null;
nm_usuario_avaliacao_w		usuario_processo_aval.nm_usuario_avaliacao%type;
ds_destinatario_w		compl_pessoa_fisica.ds_email%type;
ds_destinatarios_w		varchar(1000);
ie_primeiro_w 			varchar(1) := 'S';
nm_usuario_w			varchar(255);
ds_remetente_w			compl_pessoa_fisica.ds_email%type;
nr_sequencia_w			comunic_interna.nr_sequencia%type;
nr_seq_classif_w		comunic_interna_classif.nr_sequencia%type;
ds_comunicado_w			comunic_interna.ds_comunicado%type;
ds_titulo_w			comunic_interna.ds_titulo%type;

c01 CURSOR FOR
SELECT nm_usuario_avaliacao
from   usuario_processo_aval usu, processo_avaliacao pa 
where  pa.nr_sequencia = usu.nr_processo_aval 
and    pa.nr_tipo_avaliacao = nr_seq_tipo_avaliacao_w
and    pa.nr_nivel  = nr_nivel_w
and    pa.ie_tipo_processo = ie_tipo_pro_w
and    coalesce(pa.cd_tipo_pessoa, 0)  = coalesce(cd_tipo_pessoa_w, 0);


BEGIN
	select max(nr_seq_tipo_avaliacao),
	       max(nr_nivel)
	into STRICT   nr_seq_tipo_avaliacao_w,
	       nr_nivel_w
	from   pre_cad_avaliacao
	where nr_sequencia = nr_seq_avaliacao_p;
	
	select pro.ie_tipo_processo
	into STRICT   ie_tipo_pro_w
	from   processo_pre_cadastro pro
	where  pro.nr_sequencia = nr_seq_processo_p;
		
	if (ie_tipo_pro_w = 'FPF') then
		select pf.cd_tipo_pj
		into STRICT   cd_tipo_pessoa_w
		from   pessoa_fisica_precad pf
		where  pf.nr_seq_processo = nr_seq_processo_p;
			
	elsif (ie_tipo_pro_w = 'FPJ') then
		select pj.cd_tipo_pessoa
		into STRICT   cd_tipo_pessoa_w
		from   pessoa_juridica_precad pj
		where  pj.nr_seq_processo = nr_seq_processo_p;
		
	elsif (ie_tipo_pro_w = 'MAT') then
		cd_tipo_pessoa_w := 0;
	end if;
	
	ds_comunicado_w := substr(WHEB_MENSAGEM_PCK.get_texto(1150441,'NR_SEQ_AVALIACAO_P=' || nr_seq_avaliacao_p || ';' ||
				'NR_SEQ_PROCESSO_P=' || nr_seq_processo_p) || chr(10) ||
				WHEB_MENSAGEM_PCK.get_texto(306881, 'DS_MOTIVO_W=' || ds_justificativa_p),1,2000);

	update pre_cad_avaliacao
	set    DT_REPROVACAO = clock_timestamp(),
	       NM_USUARIO_REPROV = nm_usuario_p
	where  nr_sequencia = nr_seq_avaliacao_p;
	
	insert into processo_precad_hist(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					dt_liberacao,
					nm_usuario_lib,
					nr_seq_processo,
					ds_historico
					)values (
					nextval('processo_precad_hist_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_processo_p,
					ds_comunicado_w);
	commit;
	
	open c01;
	loop
	fetch c01 into	nm_usuario_avaliacao_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
			select max(obter_compl_pf(usu.cd_pessoa_fisica, 1, 'M'))
			into STRICT   ds_destinatario_w
			from   usuario usu
			where  nm_usuario = nm_usuario_avaliacao_w;
			
			if (ds_destinatario_w IS NOT NULL AND ds_destinatario_w::text <> '') then
				if (ie_primeiro_w = 'N') then
					ds_destinatarios_w := substr(ds_destinatarios_w || ','  || ds_destinatario_w,1,1000);
				else
					ds_destinatarios_w := ds_destinatario_w;
					ie_primeiro_w := 'N';
				end if;
			end if;
			
			if (nm_usuario_avaliacao_w IS NOT NULL AND nm_usuario_avaliacao_w::text <> '') then
				nm_usuario_w := substr(nm_usuario_w || ',' || nm_usuario_avaliacao_w,1,255);
			end if;
		end;
	end loop;
	close c01;
	
	select max(obter_compl_pf(usu.cd_pessoa_fisica, 1, 'M'))
	into STRICT   ds_remetente_w
	from   usuario usu where nm_usuario = nm_usuario_p;
	
	ds_titulo_w := WHEB_MENSAGEM_PCK.get_texto(1150430);
	
	if (nm_usuario_w IS NOT NULL AND nm_usuario_w::text <> '') then
		begin
			select	nextval('comunic_interna_seq')
			into STRICT	nr_sequencia_w
			;

			select	obter_classif_comunic('F')
			into STRICT	nr_seq_classif_w
			;
				
			insert into comunic_interna(
				dt_comunicado,
				ds_titulo,
				ds_comunicado,
				nm_usuario,
				dt_atualizacao,
				ie_geral,
				nm_usuario_destino,
				nr_sequencia,
				ie_gerencial,
				nr_seq_classif,
				dt_liberacao)
			values (	clock_timestamp(),
				ds_titulo_w,
				ds_comunicado_w,
				nm_usuario_p,
				clock_timestamp(),
				'N',
				nm_usuario_w,
				nr_sequencia_w,
				'N',
				nr_seq_classif_w,
				clock_timestamp());
		end;
	end if;

	if (ds_destinatarios_w IS NOT NULL AND ds_destinatarios_w::text <> '' AND ds_remetente_w IS NOT NULL AND ds_remetente_w::text <> '') then
		begin
			CALL enviar_email(ds_titulo_w,
				     ds_comunicado_w,
				     ds_remetente_w,
				     ds_destinatarios_w,
				     nm_usuario_p,
				     'A');
		end;

	end if;	
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reprovar_avaliacao_precad (nr_seq_avaliacao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_processo_p bigint default null, ds_justificativa_p text default '') FROM PUBLIC;

