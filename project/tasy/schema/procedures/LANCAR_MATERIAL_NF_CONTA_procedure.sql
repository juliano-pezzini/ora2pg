-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lancar_material_nf_conta ( nr_sequencia_p bigint, nm_usuario_p text, ie_commit_p text default 'S') AS $body$
DECLARE
						
cd_perfil_w		integer;
nr_seq_mat_atend_w	bigint;
nr_atendimento_w	bigint;
cd_convenio_w		integer;
cd_categoria_w		varchar(10);
nr_doc_convenio_w	varchar(20);
ie_tipo_guia_w		varchar(2);
cd_senha_w		varchar(20);
cd_setor_atendimento_w	integer;
nr_seq_atepacu_w	bigint;
dt_entrada_unidade_w	timestamp;
dt_atendimento_w	timestamp;
nr_item_nf_w		bigint;
cd_material_w		integer;
cd_local_estoque_w	smallint;
cd_unidade_medida_w	varchar(30);
qt_material_w		double precision;
nr_seq_lote_fornec_w	bigint;
vl_unitario_material_w	double precision;
vl_total_material_w	double precision;
ie_preco_conta_w	varchar(15);
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
ie_valor_informado_w	material_atend_paciente.ie_valor_informado%type;
ie_tipo_atend_w		smallint    := 0;
tx_ajuste_w		double precision;
vl_negociado_w		double precision;
ie_preco_informado_w	varchar(01);
ie_glosa_w		varchar(01);
tx_brasindice_pfb_w	REGRA_AJUSTE_MATERIAL.TX_BRASINDICE_PFB%type;--number(15,2);
tx_brasindice_pmc_w	CONVENIO_BRASINDICE.TX_BRASINDICE_PMC%type;--number(15,2);
tx_pmc_neg_w           	CONVENIO_BRASINDICE.TX_PMC_NEG%type;--number(15,2);
tx_pmc_pos_w           	CONVENIO_BRASINDICE.TX_PMC_POS%type;--number(15,2);
tx_afaturar_w          	double precision;
tx_simpro_pfb_w        	double precision;
tx_simpro_pmc_w        	double precision;
ie_origem_preco_w	varchar(10);
ie_precedencia_w	varchar(10);
pr_glosa_w		double precision;
vl_glosa_w		double precision;
cd_tabela_preco_w	bigint;
cd_motivo_exc_conta_w	smallint;
nr_seq_regra_ajuste_w	bigint;
ie_autor_particular_w	varchar(1);
cd_convenio_glosa_w	integer;
cd_categoria_glosa_w	varchar(10);
tx_pfb_neg_w           	CONVENIO_BRASINDICE.TX_PFB_NEG%type;--number(15,4);
tx_pfb_pos_w           	CONVENIO_BRASINDICE.TX_PFB_POS%type;--number(15,4);
vl_Neutro_w		varchar(10);
tx_simpro_pos_pfb_w	double precision;
tx_simpro_neg_pfb_w	double precision;
tx_simpro_pos_pmc_w	double precision;
tx_simpro_neg_pmc_w	double precision;
vl_desconto_w		nota_fiscal_item.vl_desconto%type;
cd_cgc_emitente_w       nota_fiscal.cd_cgc_emitente%type;


c01 CURSOR FOR
SELECT	a.nr_item_nf,
	a.cd_material,
	a.nr_atend_lancamento,
	a.dt_atend_lancamento,
	a.cd_local_estoque,
	a.cd_unidade_medida_estoque,
	a.qt_item_estoque,
	a.vl_unitario_item_nf,
	a.vl_liquido,
	a.vl_desconto
from	nota_fiscal_item a
where	a.nr_sequencia = nr_sequencia_p
and	(a.nr_atend_lancamento IS NOT NULL AND a.nr_atend_lancamento::text <> '')
and	(cd_material IS NOT NULL AND cd_material::text <> '');

c02 CURSOR FOR
SELECT	dt_entrada_unidade,
	nr_seq_interno
from 	atend_paciente_unidade
where 	nr_atendimento		= nr_atendimento_w
and	cd_setor_atendimento	= cd_setor_atendimento_w
order by	dt_entrada_unidade;


BEGIN

select	obter_perfil_ativo,
	cd_estabelecimento,
	cd_cgc_emitente
into STRICT	cd_perfil_w,
	cd_estabelecimento_w,
	cd_cgc_emitente_w
from	nota_fiscal
where	nr_sequencia = nr_sequencia_p;

select	coalesce(obter_valor_param_usuario(40, 436, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w),'NF')
into STRICT	ie_preco_conta_w
;

open c01;
loop
fetch c01 into
	nr_item_nf_w,
	cd_material_w,
	nr_atendimento_w,
	dt_atendimento_w,
	cd_local_estoque_w,
	cd_unidade_medida_w,
	qt_material_w,
	vl_unitario_material_w,
	vl_total_material_w,
	vl_desconto_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	select	coalesce(max(nr_seq_lote_fornec),0)
	into STRICT	nr_seq_lote_fornec_w
	from	nota_fiscal_item
	where	nr_sequencia = nr_sequencia_p
	and	nr_item_nf = nr_item_nf_w;

	if (nr_seq_lote_fornec_w = 0) then
		begin

		select	coalesce(max(nr_seq_lote_fornec),0)
		into STRICT	nr_seq_lote_fornec_w
		from	nota_fiscal_item_lote
		where	nr_seq_nota = nr_sequencia_p
		and	nr_item_nf = nr_item_nf_w;

		end;
	end if;

	select	obter_atepacu_paciente(nr_atendimento_w,'A')
	into STRICT	nr_seq_atepacu_w
	;

	select	dt_entrada_unidade
	into STRICT	dt_entrada_unidade_w
	from 	atend_paciente_unidade
	where 	nr_seq_interno = nr_seq_atepacu_w;

	select	max(cd_setor_atendimento)
	into STRICT	cd_setor_atendimento_w
	from	atend_paciente_unidade
	where	nr_seq_interno = nr_seq_atepacu_w;
	
	select 	max(ie_tipo_atendimento)
	into STRICT	ie_tipo_atend_w
	from 	atendimento_paciente
	where 	nr_atendimento = nr_atendimento_w;

	SELECT * FROM obter_convenio_execucao(nr_atendimento_w, clock_timestamp(), cd_convenio_w, cd_categoria_w, nr_doc_convenio_w, ie_tipo_guia_w, cd_senha_w) INTO STRICT cd_convenio_w, cd_categoria_w, nr_doc_convenio_w, ie_tipo_guia_w, cd_senha_w;

	select	nextval('material_atend_paciente_seq')
	into STRICT	nr_seq_mat_atend_w
	;
	
	ie_valor_informado_w	:= 'S';
	
	if (vl_desconto_w > 0) then
	
		vl_unitario_material_w	:= vl_unitario_material_w - (vl_desconto_w / qt_material_w);
	
	end if;
	
	if (ie_preco_conta_w = 'PR') then
	
		ie_valor_informado_w	:= 'N';
		vl_unitario_material_w	:= 0;
		vl_total_material_w	:= 0;
		
	else		
		SELECT * FROM obter_regra_ajuste_mat(cd_estabelecimento_w, 		--cd_estabelecimento_p
					cd_convenio_w,                   --cd_convenio_p
					cd_categoria_w,                  --cd_categoria_p
					cd_material_w,                   --cd_material_p
					dt_atendimento_w, 		--dt_vigencia_p
					0,                               --cd_tipo_acomodacao_p
					ie_tipo_atend_w,                 --ie_tipo_atendimento_p
					coalesce(cd_setor_atendimento_w,0),   --cd_setor_atendimento_p
					0,                               --qt_idade_p
					0,                               --nr_sequencia_p
					null,                            --cd_plano_p
					null,                            --cd_proc_referencia_p
					null,                            --ie_origem_proced_p
					null,                            --nr_seq_proc_interno_p
					null,                            --dt_entrada_p
					tx_ajuste_w,                     --OUT tx_ajuste_p
					vl_negociado_w,                  --OUT vl_negociado_p
					ie_preco_informado_w,            --OUT ie_preco_informado_p
					ie_glosa_w,                      --OUT ie_glosa_p
					tx_brasindice_pfb_w,             --OUT tx_brasindice_pfb_p
					tx_brasindice_pmc_w,             --OUT tx_brasindice_pmc_p
					tx_pmc_neg_w,                    --OUT tx_pmc_neg_p
					tx_pmc_pos_w,                    --OUT tx_pmc_pos_p
					tx_afaturar_w,                   --OUT tx_afaturar_p
					tx_simpro_pfb_w,                 --OUT tx_simpro_pfb_p
					tx_simpro_pmc_w,                 --OUT tx_simpro_pmc_p
					ie_origem_preco_w,               --OUT ie_origem_preco_p
					ie_precedencia_w,                --OUT ie_precedencia_p
					pr_glosa_w,                      --OUT pr_glosa_p
					vl_glosa_w,                      --OUT vl_glosa_p
					cd_tabela_preco_w,               --OUT cd_tabela_preco_p
					cd_motivo_exc_conta_w,           --OUT cd_motivo_exc_conta_p
					nr_seq_regra_ajuste_w,           --OUT nr_seq_regra_p
					ie_autor_particular_w,           --OUT ie_autor_particular_p
					cd_convenio_glosa_w,             --OUT cd_convenio_glosa_p
					cd_categoria_glosa_w, 		--OUT cd_categoria_glosa_p
					null,                            --ie_atend_retorno_p
					tx_pfb_neg_w,                    --OUT tx_pfb_neg_p 
					tx_pfb_pos_w,                    --OUT tx_pfb_pos_p
					vl_Neutro_w,                     --OUT ie_ignora_preco_venda_p
					tx_simpro_pos_pfb_w,             --OUT tx_simpro_pos_pfb_p
					tx_simpro_neg_pfb_w,             --OUT tx_simpro_neg_pfb_p
					tx_simpro_pos_pmc_w,             --OUT tx_simpro_pos_pmc_p
					tx_simpro_neg_pmc_w,             --OUT tx_simpro_neg_pmc_p
					null,                            --nr_seq_origem_p
					null,                            --nr_seq_cobertura_p
					0,                               --qt_dias_internacao_p
					null,                            --nr_seq_regra_lanc_p
					null,                            --nr_seq_lib_dieta_conv_p
					null,                            --ie_clinica_p
					null,                            --cd_usuario_convenio_p
					null) INTO STRICT 
					tx_ajuste_w, 
					vl_negociado_w, 
					ie_preco_informado_w, 
					ie_glosa_w, 
					tx_brasindice_pfb_w, 
					tx_brasindice_pmc_w, 
					tx_pmc_neg_w, 
					tx_pmc_pos_w, 
					tx_afaturar_w, 
					tx_simpro_pfb_w, 
					tx_simpro_pmc_w, 
					ie_origem_preco_w, 
					ie_precedencia_w, 
					pr_glosa_w, 
					vl_glosa_w, 
					cd_tabela_preco_w, 
					cd_motivo_exc_conta_w, 
					nr_seq_regra_ajuste_w, 
					ie_autor_particular_w, 
					cd_convenio_glosa_w, 
					cd_categoria_glosa_w, 
					tx_pfb_neg_w, 
					tx_pfb_pos_w, 
					vl_Neutro_w, 
					tx_simpro_pos_pfb_w, 
					tx_simpro_neg_pfb_w, 
					tx_simpro_pos_pmc_w, 
					tx_simpro_neg_pmc_w;                          --nr_seq_classif_atend_p
					
			vl_unitario_material_w	:= vl_unitario_material_w * tx_afaturar_w;
			vl_total_material_w	:= vl_total_material_w    * tx_afaturar_w;
		
	end if;

	insert into material_atend_paciente(nr_sequencia,			nr_atendimento,			dt_entrada_unidade,
		cd_material,			dt_atendimento,			dt_conta,
		cd_unidade_medida,		qt_material,			dt_atualizacao,
		nm_usuario,			cd_convenio,			cd_categoria,
		nr_doc_convenio,		ie_tipo_guia,			dt_prescricao,
		cd_material_prescricao,		cd_material_exec,		nr_prescricao,
		nr_sequencia_prescricao,	cd_acao,			cd_setor_atendimento,
		qt_executada,			vl_unitario,			vl_material,
		qt_ajuste_conta,
		ie_valor_informado,		ie_guia_informada,		ie_auditoria,
		nm_usuario_original,		cd_situacao_glosa,		nr_seq_atepacu,
		nr_seq_cor_exec,		cd_local_estoque,		nr_seq_tipo_baixa,
		cd_senha,			nr_seq_lote_fornec,          	cd_cgc_fornecedor)
	values (nr_seq_mat_atend_w,		nr_atendimento_w,		dt_entrada_unidade_w,
		cd_material_w,			dt_atendimento_w,		dt_atendimento_w,
		cd_unidade_medida_w,		qt_material_w,			clock_timestamp(),
		nm_usuario_p,			cd_convenio_w,			cd_categoria_w,
		nr_doc_convenio_w,		ie_tipo_guia_w,			null,
		cd_material_w,			cd_material_w,			null,
		null,				'1',				cd_setor_atendimento_w,
		qt_material_w, 			vl_unitario_material_w,		vl_total_material_w,
		0,
		ie_valor_informado_w,		'N', 				'N',
		nm_usuario_p, 			0,				nr_seq_atepacu_w,
		null,				cd_local_estoque_w,		null,
		cd_senha_w,			CASE WHEN nr_seq_lote_fornec_w=0 THEN null  ELSE nr_seq_lote_fornec_w END ,    cd_cgc_emitente_w);

	CALL Atualiza_Preco_Material(nr_seq_mat_atend_w,nm_usuario_p);

	end;
end loop;
close c01;

if (coalesce(ie_commit_p,'S') = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lancar_material_nf_conta ( nr_sequencia_p bigint, nm_usuario_p text, ie_commit_p text default 'S') FROM PUBLIC;

