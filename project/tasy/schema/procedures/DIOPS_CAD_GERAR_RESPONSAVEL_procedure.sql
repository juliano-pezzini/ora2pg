-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE diops_cad_gerar_responsavel ( nr_seq_operadora_p bigint, nr_seq_periodo_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Gerar as informações cadastrais do responsável
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[ X ]  Objetos do dicionário [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
-------------------------------------------------------------------------------------------------------------------
Referências:
	PLS_GERAR_DIOPS
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
dt_periodo_final_w		timestamp;
cd_pj_resp_contabil_w		varchar(14);
cd_pj_atuaria_w			varchar(14);
cd_pj_auditor_w			varchar(14);
cd_pf_resp_contabil_w		varchar(10);
cd_pf_atuaria_w			varchar(10);
cd_pf_auditor_w			varchar(10);


BEGIN

select	fim_dia(dt_periodo_final)
into STRICT	dt_periodo_final_w
from	diops_periodo
where	nr_sequencia	= nr_seq_periodo_p;

/* Obter o responsável pela Contabilidade */

begin
select	max(b.cd_pessoa_fisica),
	max(b.cd_cgc)
into STRICT	cd_pf_resp_contabil_w,
	cd_pj_resp_contabil_w
from	pls_responsavel_contab	b
where	coalesce(b.nr_seq_operadora,nr_seq_operadora_p) = nr_seq_operadora_p
and	trunc(dt_periodo_final_w,'dd') between b.dt_vigencia_inicial and coalesce(b.dt_vigencia_final,dt_periodo_final_w);
exception
	when others then
	cd_pf_resp_contabil_w	:= '';
	cd_pj_resp_contabil_w	:= '';
end;

/* Obter o responsável pela Atuária */

begin
select	max(b.cd_pessoa_fisica),
	max(b.cd_cgc)
into STRICT	cd_pf_atuaria_w,
	cd_pj_atuaria_w
from	pls_responsavel_atuaria	b
where	coalesce(b.nr_seq_operadora,nr_seq_operadora_p) = nr_seq_operadora_p
and	trunc(dt_periodo_final_w,'dd') between b.dt_vigencia_inicial and coalesce(b.dt_vigencia_final,dt_periodo_final_w);
exception
	when others then
	cd_pf_atuaria_w	:= '';
	cd_pj_atuaria_w	:= '';
end;

/* Obter o responsável pela Auditoria */

begin
select	max(b.cd_pessoa_fisica),
	max(b.cd_cgc)
into STRICT	cd_pf_auditor_w,
	cd_pj_auditor_w
from	pls_responsavel_auditor	b
where	coalesce(b.nr_seq_operadora,nr_seq_operadora_p) = nr_seq_operadora_p
and	trunc(dt_periodo_final_w,'dd') between b.dt_vigencia_inicial and coalesce(b.dt_vigencia_final,dt_periodo_final_w);
exception
	when others then
	cd_pf_auditor_w	:= '';
	cd_pj_auditor_w	:= '';
end;

/* Gravar o registro do responsável pela contabilidade */

CALL diops_cad_gravar_responsavel(nr_seq_operadora_p, nr_seq_periodo_p, cd_pf_resp_contabil_w, cd_pj_resp_contabil_w, 'C', nm_usuario_p);

/* Gravar o registro do Atuário */

CALL diops_cad_gravar_responsavel(nr_seq_operadora_p, nr_seq_periodo_p, cd_pf_atuaria_w, cd_pj_atuaria_w, 'T', nm_usuario_p);

/* Gravar o registro do responsável pela auditoria */

CALL diops_cad_gravar_responsavel(nr_seq_operadora_p, nr_seq_periodo_p, cd_pf_auditor_w, cd_pj_auditor_w, 'A', nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE diops_cad_gerar_responsavel ( nr_seq_operadora_p bigint, nr_seq_periodo_p bigint, nm_usuario_p text) FROM PUBLIC;

