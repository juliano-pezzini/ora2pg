-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE schematic4test_insertpackage (NR_SEQUENCIA_P bigint, NR_SEQ_PACKAGE_P bigint, NR_SEQ_URL_P bigint, NR_SEQ_BROWSER_P bigint, NR_SEQ_SERVICE_P bigint, NM_USUARIO_P text) AS $body$
DECLARE

QTD_W bigint;
QTD_W2 bigint;
NR_SEQ_EXECUTION_W bigint;


BEGIN
  --procedure that insert suite in package
  INSERT INTO SCHEM_TEST_BEHOLDER(nr_sequencia, nm_usuario, dt_atualizacao, nm_usuario_nrec, dt_atualizacao_nrec, ds_interaction, ds_param_a, ds_param_b, ds_param_c)
	VALUES (nextval('schem_test_beholder_seq'), NM_USUARIO_P, clock_timestamp(), 'Robot', clock_timestamp(), 'SCHEMATIC4TEST_INSERTPACKAGE', 
	'NR_SEQUENCIA_P as '||NR_SEQUENCIA_P, 
	'NR_SEQ_PACKAGE_P as '||NR_SEQ_PACKAGE_P, 
	'NR_SEQ_URL_P as '||NR_SEQ_URL_P);

  IF (NR_SEQUENCIA_P IS NOT NULL AND NR_SEQUENCIA_P::text <> '') THEN  
      SELECT COUNT(item.NR_SEQUENCIA) QTD 
          INTO STRICT QTD_W
      FROM SCHEM_TEST_PACKAGE_ITEM item, SCHEM_TEST_PACKAGE pack
      WHERE item.NR_SEQ_PACKAGE = pack.NR_SEQUENCIA    
      AND pack.NR_SEQUENCIA = NR_SEQ_PACKAGE_P  
      AND item.nr_seq_suite = NR_SEQUENCIA_P;

      IF (QTD_W = 0) THEN        
        SELECT MAX(NR_SEQ_EXECUTION) NR_SEQ_EXECUTION 
           INTO STRICT NR_SEQ_EXECUTION_W
        FROM SCHEM_TEST_PACKAGE_ITEM item, SCHEM_TEST_PACKAGE pack
        WHERE item.NR_SEQ_PACKAGE = pack.NR_SEQUENCIA    
        AND pack.NR_SEQUENCIA = NR_SEQ_PACKAGE_P;
          
        IF (coalesce(NR_SEQ_EXECUTION_W::text, '') = '') THEN
           NR_SEQ_EXECUTION_W := 0;
        END IF;

        INSERT INTO SCHEM_TEST_PACKAGE_ITEM(NR_SEQUENCIA, NR_SEQ_EXECUTION, NR_SEQ_SUITE, NR_SEQ_URL, NR_SEQ_BROWSER, NR_SEQ_SERVICE, NR_SEQ_PACKAGE, DT_ATUALIZACAO, DT_ATUALIZACAO_NREC, NM_USUARIO_NREC, NM_USUARIO, IE_JOBS, IE_SWITCH)
              VALUES (nextval('schem_test_package_item_seq'), NR_SEQ_EXECUTION_W+2, NR_SEQUENCIA_P, NR_SEQ_URL_P, NR_SEQ_BROWSER_P, NR_SEQ_SERVICE_P, NR_SEQ_PACKAGE_P, clock_timestamp(), clock_timestamp(), NM_USUARIO_P, NM_USUARIO_P, '0', '1');
            COMMIT;
      END IF;
  END IF;
  EXCEPTION
  WHEN no_data_found THEN
    RAISE NOTICE 'Erro: Data not found';
END;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE schematic4test_insertpackage (NR_SEQUENCIA_P bigint, NR_SEQ_PACKAGE_P bigint, NR_SEQ_URL_P bigint, NR_SEQ_BROWSER_P bigint, NR_SEQ_SERVICE_P bigint, NM_USUARIO_P text) FROM PUBLIC;

