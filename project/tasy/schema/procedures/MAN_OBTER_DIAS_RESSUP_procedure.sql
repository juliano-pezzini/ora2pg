-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_obter_dias_ressup (cd_estabelecimento_p bigint, cd_material_p bigint, ie_abc_p text, ie_xyz_p text, qt_dia_interv_ressup_p INOUT bigint, qt_dia_ressup_forn_p INOUT bigint, qt_dia_estoque_minimo_p INOUT bigint, ie_atualizar_p INOUT text) AS $body$
DECLARE


ie_abc_xyz_w		varchar(01);
ie_abc_w			varchar(01);

dt_mesano_referencia_w	timestamp;

qt_dia_interv_ressup_w	bigint;
qt_dia_ressup_forn_w	bigint;
qt_dia_estoque_minimo_w	bigint;

cd_grupo_material_w	smallint;
cd_subgrupo_material_w	smallint;
cd_classe_material_w	integer;
cd_material_w		integer;
nr_seq_fabric_w		bigint;

c01 CURSOR FOR
SELECT	coalesce(qt_dia_interv_ressup,0),
	coalesce(qt_dia_ressup_forn,0),
	coalesce(qt_dia_estoque_minimo,0)
from	mat_peso_xyz_abc
where	coalesce(cd_material, cd_material_w) = cd_material_w
and	coalesce(nr_seq_fabric, nr_seq_fabric_w) = nr_seq_fabric_w
and	coalesce(cd_classe_material, cd_classe_material_w) = cd_classe_material_w
and	coalesce(cd_subgrupo_material, cd_subgrupo_material_w) = cd_subgrupo_material_w
and	coalesce(cd_grupo_material, cd_grupo_material_w) = cd_grupo_material_w
and	((ie_abc = 'T') or (ie_abc = ie_abc_w))
and	((ie_xyz = 'T') or (ie_xyz = ie_xyz_p))
and	cd_estabelecimento = cd_estabelecimento_p
order by cd_material desc,
	cd_classe_material desc, 
	cd_subgrupo_material desc, 
	cd_grupo_material desc,
	nr_seq_fabric desc,
	ie_abc desc,
	ie_xyz;


BEGIN
ie_atualizar_p := 'N';

select	max(ie_abc_xyz)
into STRICT	ie_abc_xyz_w
from	parametro_estoque
where	cd_estabelecimento = cd_estabelecimento_p;

if (ie_abc_xyz_w = 'S') then
	begin
	
	if (coalesce(ie_xyz_p,'0') not in ('X','Y','Z')) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(188173);
	end if;
	
	ie_abc_w := ie_abc_p;
	
	if (coalesce(ie_abc_w::text, '') = '') then
		begin
		select	max(dt_mesano_referencia)
		into STRICT	dt_mesano_referencia_w
		from	material_abc
		where	cd_material	= cd_material_p
		and	cd_estabelecimento	= cd_estabelecimento_p;
		
		select	coalesce(max(ie_curva_abc),'0')
		into STRICT	ie_abc_w
		from	material_abc
		where	cd_material		= cd_material_p
		and	dt_mesano_referencia	= dt_mesano_referencia_w
		and	cd_estabelecimento	= cd_estabelecimento_p;
		end;
	end if;

	if (ie_xyz_p in ('X','Y','Z')) and (ie_abc_w in ('A','B','C')) then
		begin
		begin
		/* OS 2005249 - Removida a utilização da view estrutura_material_v pois esta function é chamada pela trigger 
	    MATERIAL_ESTAB_ATUAL. Como a view está consultando a própria tabela MATERIAL_ESTAB, estava gerando erro. */
		Select max(d.cd_grupo_material),
			   max(c.cd_subgrupo_material),
			   max(b.cd_classe_material),
			   max(a.cd_material)
		  into STRICT cd_grupo_material_w,
			   cd_subgrupo_material_w,
			   cd_classe_material_w,
			   cd_material_w
		  from Grupo_material d,
			   SubGrupo_Material c,
			   Classe_material b,
			   Material a
		 where a.cd_classe_material	  = b.cd_classe_material
		   and b.cd_subgrupo_material	= c.cd_subgrupo_material
		   and c.cd_grupo_material	  = d.cd_grupo_material
		   and a.cd_material          = cd_material_p;

		select	coalesce(nr_seq_fabric,0)
		into STRICT	nr_seq_fabric_w
		from	material
		where	cd_material = cd_material_p;
		exception
		when others then
			begin
			cd_grupo_material_w 	:= 0;
			cd_subgrupo_material_w	:= 0;
			cd_classe_material_w	:= 0;
			cd_material_w		:= 0;
			end;
		end;
		
		open c01;
		loop
		fetch c01 into	
			qt_dia_interv_ressup_w,
			qt_dia_ressup_forn_w,
			qt_dia_estoque_minimo_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
		end loop;
		close c01;
		
		qt_dia_interv_ressup_w	:= coalesce(qt_dia_interv_ressup_w, 0);
		qt_dia_ressup_forn_w	:= coalesce(qt_dia_ressup_forn_w, 0);
		qt_dia_estoque_minimo_w	:= coalesce(qt_dia_estoque_minimo_w, 0);

		if (qt_dia_interv_ressup_w > 0) or (qt_dia_ressup_forn_w > 0) or (qt_dia_estoque_minimo_w > 0) then
			ie_atualizar_p := 'S';
		end if;

		qt_dia_interv_ressup_p	:= qt_dia_interv_ressup_w;
		qt_dia_ressup_forn_p	:= qt_dia_ressup_forn_w;
		qt_dia_estoque_minimo_p	:= qt_dia_estoque_minimo_w;
		end;
	end if;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_obter_dias_ressup (cd_estabelecimento_p bigint, cd_material_p bigint, ie_abc_p text, ie_xyz_p text, qt_dia_interv_ressup_p INOUT bigint, qt_dia_ressup_forn_p INOUT bigint, qt_dia_estoque_minimo_p INOUT bigint, ie_atualizar_p INOUT text) FROM PUBLIC;

