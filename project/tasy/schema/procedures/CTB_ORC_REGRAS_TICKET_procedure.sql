-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_orc_regras_ticket ( nr_seq_cenario_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w			bigint;
nr_seq_grupo_conta_w		bigint;
nr_seq_grupo_centro_w		bigint;
nr_seq_metrica_w			bigint;
cd_centro_custo_w			bigint;
cd_conta_contabil_w		varchar(20);
nr_seq_mes_ref_w			bigint;
dt_mes_inic_w			timestamp;
dt_mes_fim_w			timestamp;
ie_regra_w			varchar(20);
pr_aplicar_w			double precision;
ie_sobrepor_w			varchar(20);
vl_fixo_w				double precision;
cd_estabelecimento_w		bigint;
cd_empresa_w			bigint;
ds_erro_w			varchar(500);

c01 CURSOR FOR
SELECT	nr_sequencia,
	cd_estabelecimento,
	cd_centro_custo,
	cd_conta_contabil,
	nr_seq_metrica,
	nr_seq_mes_ref,
	dt_mes_inic,
	dt_mes_fim,
	ie_regra,
	pr_aplicar,
	ie_sobrepor,
	nr_seq_grupo_conta,
	nr_seq_grupo_centro,
	vl_fixo
from	ctb_regra_ticket_medio
where	nr_seq_cenario	= nr_seq_cenario_p
order	by nr_seq_regra, ie_padrao_ajuste desc;


BEGIN
/*limpar o ticket medio antes de gerar novamente*/

delete from ctb_cen_ticket_medio
where	nr_seq_cenario = nr_seq_cenario_p;

select	cd_empresa
into STRICT	cd_empresa_w
from	ctb_orc_cenario
where	nr_sequencia			= nr_seq_cenario_p;

open c01;
loop
fetch c01 into
	nr_sequencia_w,
	cd_estabelecimento_w,
	cd_centro_custo_w,
	cd_conta_contabil_w,
	nr_seq_metrica_w,
	nr_seq_mes_ref_w,
	dt_mes_inic_w,
	dt_mes_fim_w,
	ie_regra_w,
	pr_aplicar_w,
	ie_sobrepor_w,
	nr_seq_grupo_conta_w,
	nr_seq_grupo_centro_w,
	vl_fixo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	if (ie_regra_w = 'VF') then
		begin
		CALL ctb_aplicar_regra_ticket_fixo(nr_seq_cenario_p,
				nr_sequencia_w,
				cd_centro_custo_w,
				cd_conta_contabil_w,
				nr_seq_metrica_w,
				dt_mes_inic_w,
				dt_mes_fim_w,
				ie_sobrepor_w,
				nr_seq_grupo_centro_w,
				nr_seq_grupo_conta_w,
				vl_fixo_w,
				cd_empresa_w,
				cd_estabelecimento_w,
				nm_usuario_p);
		end;
	elsif (ie_regra_w = 'PG') then
		begin
		CALL ctb_aplicar_regra_ticket_grupo(	nr_seq_cenario_p,
						cd_estabelecimento_w,
						cd_empresa_w,
						nr_sequencia_w,
						nm_usuario_p,
						nr_seq_grupo_centro_w,
						ie_sobrepor_w,
						cd_centro_custo_w);
		end;
	else
		begin
		CALL ctb_aplicar_regra_ticket(
				nr_seq_cenario_p,
				nr_sequencia_w,
				cd_centro_custo_w,
				cd_conta_contabil_w,
				nr_seq_mes_ref_w,
				nr_seq_metrica_w,
				dt_mes_inic_w,
				dt_mes_fim_w,
				ie_regra_w,
				pr_aplicar_w,
				ie_sobrepor_w,
				nr_seq_grupo_centro_w,
				nr_seq_grupo_conta_w,
				vl_fixo_w,
				cd_empresa_w,
				cd_estabelecimento_w,
				nm_usuario_p);
		end;
	end if;
	exception when others then
		ds_erro_w	:= SQLERRM(SQLSTATE);
		CALL wheb_mensagem_pck.exibir_mensagem_abort(266623,'NR_SEQUENCIA_W=' || nr_sequencia_w || ';' ||
							'DS_ERRO_W=' || ds_erro_w);
	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_orc_regras_ticket ( nr_seq_cenario_p bigint, nm_usuario_p text) FROM PUBLIC;

