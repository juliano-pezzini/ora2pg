-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_incluir_titulo_cobran_terc (nr_seq_lote_p pls_lote_cob_terceiro.nr_sequencia%type, nr_titulo_p titulo_receber.nr_titulo%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


vl_cobrado_w				titulo_receber.vl_saldo_titulo%type;
qt_registros_w				integer := 0;
qt_regra_w				integer := 0;
nr_seq_conta_banco_w			titulo_receber.nr_seq_conta_banco%type;
nr_seq_carteira_w			titulo_receber.nr_seq_carteira_cobr%type;
ie_considerar_tit_liq_perda_w		pls_lote_cob_terceiro.ie_considerar_tit_liq_perda%type;
vl_titulo_w				titulo_receber.vl_titulo%type;
ie_situacao_w				titulo_receber.ie_situacao%type;


BEGIN
if (nr_titulo_p IS NOT NULL AND nr_titulo_p::text <> '') and (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') then
	select	count(1)
	into STRICT	qt_registros_w
	from	pls_lote_cob_terceiro_item
	where	nr_seq_lote	= nr_seq_lote_p
	and	nr_titulo	= nr_titulo_p;

	select	coalesce(max(ie_considerar_tit_liq_perda),'N')
	into STRICT	ie_considerar_tit_liq_perda_w
	from	pls_lote_cob_terceiro
	where	nr_sequencia	= nr_seq_lote_p;

	if (qt_registros_w = 0) then
		begin
		select	coalesce(a.vl_saldo_titulo,0),
			a.nr_seq_conta_banco,
			coalesce(a.vl_titulo,0),
			ie_situacao
		into STRICT	vl_cobrado_w,
			nr_seq_conta_banco_w,
			vl_titulo_w,
			ie_situacao_w
		from	titulo_receber	a
		where	a.nr_titulo	= nr_titulo_p;
		exception
		when others then
			vl_cobrado_w	:= 0;
			vl_titulo_w	:= 0;
		end;

		if (ie_considerar_tit_liq_perda_w = 'S') and (ie_situacao_w = '6') then -- Liquidado como perda
			vl_cobrado_w := vl_titulo_w;
		end if;

		if (vl_cobrado_w > 0) then
			insert into pls_lote_cob_terceiro_item(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_lote,
				nr_titulo,
				vl_cobrado,
				dt_pagamento,
				vl_pagamento)
			values (nextval('pls_lote_cob_terceiro_item_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_lote_p,
				nr_titulo_p,
				vl_cobrado_w,
				null,
				null);

			select	count(1)
			into STRICT	qt_regra_w
			from	pls_regra_carteira_ted
			where	cd_estabelecimento = cd_estabelecimento_p  LIMIT 1;

			if (qt_regra_w > 0) then
				SELECT * FROM pls_obter_carteira_cobran_ted(cd_estabelecimento_p, vl_cobrado_w, clock_timestamp(), nr_seq_conta_banco_w, nr_seq_carteira_w) INTO STRICT nr_seq_conta_banco_w, nr_seq_carteira_w;

				if (nr_seq_carteira_w IS NOT NULL AND nr_seq_carteira_w::text <> '') then
					update	titulo_receber
					set	nr_seq_carteira_cobr	= nr_seq_carteira_w,
						nr_seq_conta_banco	= nr_seq_conta_banco_w
					where	nr_titulo		= nr_titulo_p;
				end if;
			end if;
		end if;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_incluir_titulo_cobran_terc (nr_seq_lote_p pls_lote_cob_terceiro.nr_sequencia%type, nr_titulo_p titulo_receber.nr_titulo%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

