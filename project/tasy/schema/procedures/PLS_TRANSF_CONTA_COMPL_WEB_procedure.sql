-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_transf_conta_compl_web ( nr_seq_conta_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_protocolo_p INOUT bigint) AS $body$
DECLARE


nr_seq_protocolo_w		bigint;
nr_seq_protocolo_ww		bigint := null; -- Procolo da conta passada pelo parâmetro
nr_seq_prestador_w		bigint;
ie_tipo_guia_w			smallint;
dt_mes_competencia_w		timestamp;
qt_conta_protocolo_w		bigint;
qt_registros_w			bigint;
ie_vinculo_complemento_w	pls_web_param_geral.ie_vinculo_complemento%type;
cd_medico_solicitante_w		pls_conta.cd_medico_solicitante%type;


BEGIN
select	max(nr_seq_protocolo),
	max(cd_medico_solicitante)
into STRICT	nr_seq_protocolo_ww,
	cd_medico_solicitante_w
from	pls_conta
where 	nr_sequencia = nr_seq_conta_p;

select	max(ie_vinculo_complemento)
into STRICT	ie_vinculo_complemento_w
from	pls_web_param_geral
where	cd_estabelecimento	= cd_estabelecimento_p;

ie_vinculo_complemento_w	:= coalesce(ie_vinculo_complemento_w,'P');

/* Verifica um protocolo para poder transferir as contas */

begin
select	nr_seq_prestador,
	ie_tipo_guia
into STRICT	nr_seq_prestador_w,
	ie_tipo_guia_w
from 	pls_protocolo_conta
where	nr_sequencia = nr_seq_protocolo_ww;
exception
when others then
	nr_seq_prestador_w := null;
end;

if (nr_seq_prestador_w IS NOT NULL AND nr_seq_prestador_w::text <> '') then

	nr_seq_protocolo_w	:= 0;

	if (ie_vinculo_complemento_w = 'PM') then
		select 	coalesce(min(nr_sequencia), 0)
		into STRICT	nr_seq_protocolo_w
		from 	pls_protocolo_conta 	x
		where	ie_protocolo_compl 	= 'S'
		and	ie_status		= 1
		and	ie_tipo_guia		= ie_tipo_guia_w
		and	nr_seq_prestador	= nr_seq_prestador_w
		and	ie_situacao 		= 'I'
		and	nr_sequencia  		<> nr_seq_protocolo_ww
		and	99			> (	SELECT	count(1)
							from	pls_conta	s
							where 	s.nr_seq_protocolo = x.nr_sequencia
							and	ie_status <> 'C')
		and	exists (	select 1
					from 	pls_conta  	s
					where 	s.nr_seq_protocolo 	= x.nr_sequencia
					and	s.cd_medico_solicitante	= cd_medico_solicitante_w);

	elsif (ie_vinculo_complemento_w = 'P') then
		select 	coalesce(min(nr_sequencia), 0)
		into STRICT	nr_seq_protocolo_w
		from 	pls_protocolo_conta 	x
		where	ie_protocolo_compl 	= 'S'
		and	ie_status		= 1
		and	ie_tipo_guia		= ie_tipo_guia_w
		and	nr_seq_prestador	= nr_seq_prestador_w
		and	ie_situacao 		= 'I'
		and	nr_sequencia  		<> nr_seq_protocolo_ww
		and	99			> (	SELECT	count(1)
							from	pls_conta	s
							where 	s.nr_seq_protocolo = x.nr_sequencia
							and	ie_status <> 'C');
	end if;

	if (nr_seq_protocolo_w = 0) then
		select	nextval('pls_protocolo_conta_seq')
		into STRICT	nr_seq_protocolo_w
		;

		dt_mes_competencia_w	:= pls_obter_dataref_prot_imp(	nr_seq_prestador_w, 'C',clock_timestamp(),
									clock_timestamp(), clock_timestamp(), clock_timestamp(),
									ie_tipo_guia_w,null,cd_estabelecimento_p);

		insert into pls_protocolo_conta(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			ie_status,
			ie_situacao,
			cd_estabelecimento,
			dt_mes_competencia,
			nr_seq_prestador,
			ie_apresentacao,
			ie_protocolo_compl,
			ie_tipo_guia,
			ie_origem_protocolo,
			ie_tipo_protocolo)
		values (nr_seq_protocolo_w,
			clock_timestamp(),
			nm_usuario_p,
			'1',
			'I',
			cd_estabelecimento_p,
			dt_mes_competencia_w,
			nr_seq_prestador_w,
			'A',
			'S',
			ie_tipo_guia_w,
			'C',
			'C');
	end if;

	/* Transfere a conta para o novo protocolo */

	update	pls_conta
	set	nr_seq_protocolo = nr_seq_protocolo_w
	where	nr_sequencia = nr_seq_conta_p;

	nr_seq_protocolo_p := nr_seq_protocolo_w;
end if;

select	count(1)
into STRICT	qt_conta_protocolo_w
from	pls_conta
where	nr_seq_protocolo = nr_seq_protocolo_ww;

if (qt_conta_protocolo_w = 0) then
	update	pls_protocolo_conta
	set		ie_status    = '4',
			ie_situacao  = 'D',
			ds_observacao = 'Protocolo cancelado pois não possui contas devido a transferência de contas do complemento do portal.'
	where	nr_sequencia = nr_seq_protocolo_ww;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_transf_conta_compl_web ( nr_seq_conta_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_protocolo_p INOUT bigint) FROM PUBLIC;

