-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiz_secao_ageserv_coptrans ( nr_seq_agenda_origem_p bigint, nr_seq_agenda_destino_p bigint, ie_tipo_operacao_p text, nr_secao_p bigint, qt_total_secao_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_secao_w integer := null;
qt_total_secao_w integer := null;
qt_secao_atual_w integer:=null; --depende do valor do ie_tipo_operacao_p
nr_controle_secao_w	bigint := null;
nr_controle_secao_origem_w	bigint;
cd_pessoa_origem_w		varchar(10);
cd_agenda_origem_w		bigint;
dt_agenda_origem_w	timestamp;
dt_agenda_ww		timestamp;


BEGIN

if (nr_seq_agenda_origem_p IS NOT NULL AND nr_seq_agenda_origem_p::text <> '') 	and (nr_seq_agenda_destino_p IS NOT NULL AND nr_seq_agenda_destino_p::text <> '')	and (ie_tipo_operacao_p IS NOT NULL AND ie_tipo_operacao_p::text <> '')	and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '')	and (nr_secao_p IS NOT NULL AND nr_secao_p::text <> '') then

	select	max(nr_controle_secao),
		max(cd_pessoa_fisica),
		max(cd_Agenda),
		max(dt_agenda)
	into STRICT	nr_controle_secao_origem_w,
		cd_pessoa_origem_w,
		cd_agenda_origem_w,
		dt_agenda_origem_w
	from	agenda_consulta
	where	nr_sequencia	= nr_seq_agenda_origem_p;

	if (ie_tipo_operacao_p 	= 'C') then --copiar
		select 	MAX(nr_secao),
			MAX(qt_total_secao),
			MAX(nr_controle_secao)
		into STRICT	nr_secao_w,
			qt_total_secao_w,
			nr_controle_secao_w
		from	agenda_consulta
		where	cd_pessoa_fisica	= cd_pessoa_origem_w
		and	cd_agenda		= cd_agenda_origem_w
		and	dt_agenda		>= dt_agenda_origem_w
		and	ie_status_agenda	<> 'C'
		and	((nr_controle_secao	= nr_controle_secao_origem_w) or (coalesce(nr_controle_secao_origem_w::text, '') = ''));


		qt_secao_atual_w := nr_secao_w + 1;

	elsif 	ie_tipo_operacao_p = 'T' then --transferir
		qt_secao_atual_w 	:= nr_secao_p;
		qt_total_secao_w 	:= qt_total_secao_p;
		nr_controle_secao_w	:= nr_controle_secao_origem_w;
	end if;

	if (qt_secao_atual_w <= qt_total_secao_w) then
		update	agenda_consulta set
			nr_secao 		= coalesce(qt_secao_atual_w,nr_secao),
			qt_total_secao		= coalesce(qt_total_secao_w,qt_total_secao),
		--	nr_controle_secao	= nr_controle_secao_w,
			nm_usuario		= nm_usuario_p
		where	nr_sequencia		= nr_seq_agenda_destino_p;
	else
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(262559);
	end if;
	COMMIT;
	CALL recalcular_sessoes_servico(nr_seq_agenda_destino_p);
end if;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiz_secao_ageserv_coptrans ( nr_seq_agenda_origem_p bigint, nr_seq_agenda_destino_p bigint, ie_tipo_operacao_p text, nr_secao_p bigint, qt_total_secao_p bigint, nm_usuario_p text) FROM PUBLIC;

