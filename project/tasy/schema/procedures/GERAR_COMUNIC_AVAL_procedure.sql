-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_comunic_aval ( nr_seq_avaliacao_p bigint, cd_pessoa_fisica_p text, nr_atendimento_p bigint, nr_seq_tipo_avaliacao_p bigint, dt_avaliacao_p timestamp, nm_usuario_p text) AS $body$
DECLARE

		
nr_seq_tipo_aval_w	bigint;
cd_estabelecimento_w	smallint;
ds_mensagem_w		varchar(4000);
ds_titulo_w		varchar(100);
nm_usuario_envio_w	varchar(15);
cd_perfil_w		integer;
nr_seq_comunic_new_w	bigint;

ds_resultado_w		varchar(100) := '';
cd_pessoa_fisica_w	varchar(010);
nm_pessoa_fisica_w	varchar(060);
ds_idade_w		varchar(020);
ds_amd_w		varchar(30);
dt_nascimento_w		timestamp;
dt_entrada_w		timestamp;
qt_altura_cm_w		real;
ie_sexo_w		varchar(001);
ds_sexo_w		varchar(040);
cd_doenca_w		varchar(10);
nr_prontuario_w		bigint;
ds_tipo_aval_w		varchar(255);
nm_pessoa_liberacao_w	varchar(60);
nr_seq_classif_w	bigint;
CD_MEDICO_w			varchar(10);

			
c01 CURSOR FOR
	SELECT	r.ds_titulo,
		r.ds_mensagem,
		d.nm_usuario_envio,
		d.cd_perfil,
		r.nr_seq_classif
	from	envio_comunic_aval_dest d,
		regra_envio_comunic_aval r
	where	d.nr_seq_regra 		= r.nr_sequencia
	and	r.nr_seq_tipo_aval	= nr_seq_tipo_avaliacao_p
	and     obter_se_item_comunic_int_aval(r.nr_sequencia,nr_seq_avaliacao_p) = 'S';
	

BEGIN

if (nr_seq_tipo_avaliacao_p > 0) then

	select	substr(obter_cid_atendimento(nr_atendimento_p, 'P'),1,10),
		obter_data_entrada(nr_atendimento_p),
		substr(obter_desc_tipo_avaliacao(nr_seq_tipo_avaliacao_p),1,255),
		obter_estab_atend(nr_atendimento_p)
	into STRICT	cd_doenca_w,
		dt_entrada_w,
		ds_tipo_aval_w,
		cd_estabelecimento_w
	;


	select	max(substr(obter_nome_pf(cd_pessoa_fisica),1,60)),
		substr(max(obter_idade(dt_nascimento, clock_timestamp(), 'A')),1,20),
		max(dt_nascimento),
		max(qt_altura_cm),
		max(ie_sexo),
		substr(max(obter_idade(dt_nascimento, clock_timestamp(), 'S')),1,30),
		max(nr_prontuario),
		max(CD_MEDICO)
	into STRICT	nm_pessoa_fisica_w,
		ds_idade_w,
		dt_nascimento_w,
		qt_altura_cm_w,
		ie_sexo_w,
		ds_amd_w,
		nr_prontuario_w,
		CD_MEDICO_w
	from	pessoa_fisica
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p;

	select	max(ds_valor_dominio)
	into STRICT	ds_sexo_w
	from	valor_dominio
	where	cd_dominio		= 4
	and	vl_dominio		= ie_sexo_w;

	nm_pessoa_liberacao_w	:= substr(Obter_Pessoa_Fisica_Usuario(nm_usuario_p,'D'),1,60);

	open c01;
	loop
	fetch c01 into	
		ds_titulo_w,
		ds_mensagem_w,
		nm_usuario_envio_w,
		cd_perfil_w,
		nr_seq_classif_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Paciente', 	nm_pessoa_fisica_w);
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Idade', 		ds_idade_w);
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Nascimento', 	to_char(dt_nascimento_w, 'dd/mm/yyyy'));
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Altura', 	to_char(qt_altura_cm_w));
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Sexo_abrev', 	ie_sexo_w);
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Sexo', 		ds_sexo_w);
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Data_atual',	to_char(clock_timestamp(), 'dd/mm/yyyy'));
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Data_hr_atual',	to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss'));
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Atendimento',	nr_atendimento_p);
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Cid',		cd_doenca_w);
  		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Data_entrada',	to_char(dt_entrada_w, 'dd/mm/yyyy hh24:mi:ss'));
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Data_atual',	to_char(clock_timestamp(), 'dd/mm/yyyy'));
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Data_hr_atual',	to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss'));
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Atendimento',	nr_atendimento_p);
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@CID',		cd_doenca_w);
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Data_entrada',	to_char(dt_entrada_w, 'dd/mm/yyyy hh24:mi:ss'));
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Usuario',	nm_usuario_p);
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Setor',		substr(obter_nome_setor(obter_setor_usuario(nm_usuario_p)),1,60));
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Pac_setor', 	substr(obter_setor_atepacu(Obter_AtePacu_Paciente(nr_atendimento_p,'P'),1),1,240));
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Avaliacao',	ds_tipo_aval_w);
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Prontuario',	nr_prontuario_w);
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Data_aval',	dt_avaliacao_p);
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Nr_aval',	nr_seq_avaliacao_p);
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Pessoa_lib',	nm_pessoa_liberacao_w);
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Profissional',	obter_nome_pf(CD_MEDICO_w));
		ds_mensagem_w := replace_macro(ds_mensagem_w,'@Pac_set_atual',	substr(Obter_Unidade_Atendimento(nr_atendimento_p,'IA','SU'),1,60));
		
		insert  into comunic_interna(
			dt_comunicado,
			ds_titulo,
			ds_comunicado,
			nm_usuario,
			dt_atualizacao,
			ie_geral,
			nr_sequencia,
			ie_gerencial,
			ds_perfil_adicional,
			cd_estab_destino,
			nm_usuario_destino,
			dt_liberacao,
			nr_seq_classif)
		values (clock_timestamp(),
			ds_titulo_w,
			ds_mensagem_w,
			nm_usuario_p,
			clock_timestamp(),
			'N',
			nextval('comunic_interna_seq'),
			'N',
			to_char(cd_perfil_w),
			cd_estabelecimento_w,
			nm_usuario_envio_w,
			clock_timestamp(),
			nr_seq_classif_w);  				
		end;
	end loop;
	close c01;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_comunic_aval ( nr_seq_avaliacao_p bigint, cd_pessoa_fisica_p text, nr_atendimento_p bigint, nr_seq_tipo_avaliacao_p bigint, dt_avaliacao_p timestamp, nm_usuario_p text) FROM PUBLIC;

