-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_atualizar_pedido_status ( nr_seq_pedido_status_p ptu_pedido_status.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_seq_guia_w		pls_guia_plano.nr_sequencia%type;
nr_seq_requisicao_w	pls_requisicao.nr_sequencia%type;

C01 CURSOR( nr_seq_ped_status_pc  	ptu_pedido_status.nr_sequencia%type) FOR

	SELECT (SELECT	max(b.nr_sequencia)
		from	ptu_pedido_compl_aut b
		where	b.nr_seq_execucao	= a.nr_transacao_uni_exec
		and	b.cd_unimed_executora	= a.cd_unimed_executora) nr_seq_pedido_compl,
		(select	max(b.nr_sequencia)
		from	ptu_pedido_autorizacao b
		where	b.nr_seq_execucao	= a.nr_transacao_uni_exec
		and	b.cd_unimed_executora	= a.cd_unimed_executora) nr_seq_pedido_aut
	from	ptu_pedido_status a
	where	a.nr_sequencia = nr_seq_ped_status_pc;

BEGIN

--Carregar as informações da Guia e da Requisição
for c01_w in C01( nr_seq_pedido_status_p ) loop

	--Verificar a origem do pedido de cancelamento se a mesma foi gerada para um Pedido de Autorização ou Pedido de Complemento
	if (c01_w.nr_seq_pedido_aut IS NOT NULL AND c01_w.nr_seq_pedido_aut::text <> '') then
		select	nr_seq_guia,
			nr_seq_requisicao
		into STRICT	nr_seq_guia_w,
			nr_seq_requisicao_w
		from	ptu_pedido_autorizacao
		where	nr_sequencia		= c01_w.nr_seq_pedido_aut;
	elsif (c01_w.nr_seq_pedido_compl IS NOT NULL AND c01_w.nr_seq_pedido_compl::text <> '') then
		select	nr_seq_guia,
			nr_seq_requisicao
		into STRICT	nr_seq_guia_w,
			nr_seq_requisicao_w
		from	ptu_pedido_compl_aut
		where	nr_sequencia		= c01_w.nr_seq_pedido_compl;
	end if;

	update	ptu_pedido_status
	set	nr_seq_guia		= nr_seq_guia_w,
		nr_seq_requisicao	= nr_seq_requisicao_w,
		dt_atualizacao		= clock_timestamp(),
		nm_usuario		= nm_usuario_p
	where	nr_sequencia 		= nr_seq_pedido_status_p;

	commit;
end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_atualizar_pedido_status ( nr_seq_pedido_status_p ptu_pedido_status.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

