-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE projeto_recurso_comunicao ( nr_sequencia_p bigint, ds_perfil_adicional_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_tipo_comunic_p text) AS $body$
DECLARE

 
 
			 
			 
 
nr_sequencia_w				bigint;
nr_seq_classif_w				bigint;
dt_projeto_w				timestamp;
ds_projeto_w				varchar(80);
ds_origem_recurso_w			varchar(15);
nr_processo_w				varchar(60);
ds_convenio_ano_w			varchar(20);
ds_receita_w				varchar(255);
ds_elemento_despesa_w			varchar(255);
nm_representante_w			varchar(255);	
vl_projeto_w				double precision;
dt_inicio_exec_w				timestamp;
dt_fim_exec_w				timestamp;
dt_fim_prest_conta_w			timestamp;
ds_conta_w				varchar(255);
vl_utilizado_projeto_w			double precision;
nr_seq_conta_bco_w			bigint;		
ds_titulo_w					varchar(100);
ds_comunicado_w				varchar(4000);

 
 
 

BEGIN 
 
select	dt_projeto, 
	ds_projeto, 
	/*decode(ie_origem_recurso,'F','Federal', 
				'E','Estadual', 
				'M','Municipal', 
				'P','Privado') ds_origem,*/
 
	CASE WHEN ie_origem_recurso='F' THEN wheb_mensagem_pck.get_texto(311665) WHEN ie_origem_recurso='E' THEN wheb_mensagem_pck.get_texto(311667) WHEN ie_origem_recurso='M' THEN wheb_mensagem_pck.get_texto(311668) WHEN ie_origem_recurso='P' THEN wheb_mensagem_pck.get_texto(311669) END  ds_origem, 
	coalesce(nr_processo,'') nr_processo, 
	coalesce(substr(ds_convenio_ano,1,20),'') ds_convenio_ano, 
	coalesce(substr(ds_receita,1,255),'')ds_receita, 
	coalesce(substr(ds_elemento_despesa,1,255),'') ds_elemento_despesa, 
	coalesce(substr(obter_nome_pf(cd_pf_representante),1,255),'') nm_representante, 
	vl_projeto, 
	dt_inicio_exec, 
	dt_fim_exec, 
	dt_fim_prest_conta, 
	coalesce(obter_saldo_projeto(nr_sequencia_p,1),0), 
	coalesce(nr_seq_conta_bco,0) nr_seq_conta_bco 
into STRICT	dt_projeto_w, 
	ds_projeto_w,	 
	ds_origem_recurso_w, 
	nr_processo_w, 
	ds_convenio_ano_w, 
	ds_receita_w, 
	ds_elemento_despesa_w, 
	nm_representante_w, 
	vl_projeto_w,	 
	dt_inicio_exec_w, 
	dt_fim_exec_w,			 
	dt_fim_prest_conta_w, 
	vl_utilizado_projeto_w, 
	nr_seq_conta_bco_w 
from	projeto_recurso 
where	nr_sequencia = nr_sequencia_p;
 
 
if (nr_seq_conta_bco_w > 0) then 
	select	ds_conta 
	into STRICT 	ds_conta_w 
	from	banco_estabelecimento_v a 
	where	nr_sequencia = nr_seq_conta_bco_w;
else 
	--ds_conta_w := 'Banco não informado.';	 
	ds_conta_w := wheb_mensagem_pck.get_texto(311664);
end if;
	 
	select	obter_classif_comunic('F') 
	into STRICT	nr_seq_classif_w 
	;
 
	select	nextval('comunic_interna_seq') 
	into STRICT	nr_sequencia_w 
	;	
	 
	 
if (ie_tipo_comunic_p = 'L') then	 
	--ds_comunicado_w :=	ds_comunicado_w || ' ' || 'Liberado o projeto' || ' ' || ds_projeto_w || chr(13); 
	ds_comunicado_w :=	ds_comunicado_w || ' ' || wheb_mensagem_pck.get_texto(311672, 'DS_PROJETO=' || ds_projeto_w) || chr(13);
	 
else 
	--ds_comunicado_w :=	ds_comunicado_w || ' ' || 'Estornada a liberação do projeto' || ' ' || ds_projeto_w || chr(13); 
	ds_comunicado_w :=	ds_comunicado_w || ' ' || wheb_mensagem_pck.get_texto(311673, 'DS_PROJETO=' || ds_projeto_w) || chr(13);
end if;	
	/*ds_comunicado_w :=	ds_comunicado_w || ' ' || 'Data projeto:' || ' ' || dt_projeto_w || chr(13); 
	ds_comunicado_w :=	ds_comunicado_w || ' ' || 'Origem:' || ' ' || ds_origem_recurso_w || chr(13); 
	ds_comunicado_w :=	ds_comunicado_w || ' ' || 'N processo:' || ' ' || nr_processo_w || chr(13); 
	ds_comunicado_w :=	ds_comunicado_w || ' ' || 'Convênio N/Ano:' || ' ' || ds_convenio_ano_w || chr(13); 
	ds_comunicado_w :=	ds_comunicado_w || ' ' || 'Receita:' || ' ' || ds_receita_w || chr(13); 
	ds_comunicado_w :=	ds_comunicado_w || ' ' || 'Elemento:' || ' ' || ds_elemento_despesa_w || chr(13); 
	ds_comunicado_w :=	ds_comunicado_w || ' ' || 'Dirigente/Rep. legal:' || ' ' || nm_representante_w ||chr(13); 
	ds_comunicado_w :=	ds_comunicado_w || ' ' || 'Valor Total Projeto:' || ' ' || substr(campo_mascara_virgula(vl_projeto_w),1,30) || chr(13); 
	ds_comunicado_w :=	ds_comunicado_w || ' ' || 'Valor Utilizado:' || ' ' || substr(campo_mascara_virgula(vl_utilizado_projeto_w),1,30) || chr(13); 
	ds_comunicado_w :=	ds_comunicado_w || ' ' || 'Início Execução:' || ' ' || dt_inicio_exec_w || chr(13); 
	ds_comunicado_w :=	ds_comunicado_w || ' ' || 'Fim prest. Conta:' || ' ' || dt_fim_prest_conta_w || chr(13); 
	ds_comunicado_w :=	ds_comunicado_w || ' ' || 'Banco/Agência:' || ' ' || ds_conta_w || chr(13);*/
 
	ds_comunicado_w :=	ds_comunicado_w || ' ' || wheb_mensagem_pck.get_texto(311675, 'DT_PROJETO=' || dt_projeto_w) || chr(13);
	ds_comunicado_w :=	ds_comunicado_w || ' ' || wheb_mensagem_pck.get_texto(311676, 'DS_ORIGEM_RECURSO=' || ds_origem_recurso_w) || chr(13);
	ds_comunicado_w :=	ds_comunicado_w || ' ' || wheb_mensagem_pck.get_texto(311677, 'NR_PROCESSO=' || nr_processo_w) || chr(13);
	ds_comunicado_w :=	ds_comunicado_w || ' ' || wheb_mensagem_pck.get_texto(311679, 'DS_CONVENIO_ANO=' || ds_convenio_ano_w) || chr(13);
	ds_comunicado_w :=	ds_comunicado_w || ' ' || wheb_mensagem_pck.get_texto(311680, 'DS_RECEITA=' || ds_receita_w) || chr(13);
	ds_comunicado_w :=	ds_comunicado_w || ' ' || wheb_mensagem_pck.get_texto(311681, 'DS_ELEMENTO_DESPESA=' || ds_elemento_despesa_w) || chr(13);
	ds_comunicado_w :=	ds_comunicado_w || ' ' || wheb_mensagem_pck.get_texto(311682, 'NM_REPRESENTANTE=' || nm_representante_w) || chr(13);
	ds_comunicado_w :=	ds_comunicado_w || ' ' || wheb_mensagem_pck.get_texto(311683, 'VL_PROJETO=' || substr(campo_mascara_virgula(vl_projeto_w),1,30)) || chr(13);
	ds_comunicado_w :=	ds_comunicado_w || ' ' || wheb_mensagem_pck.get_texto(311684, 'VL_UTILIZADO_PROJETO=' || substr(campo_mascara_virgula(vl_utilizado_projeto_w),1,30)) || chr(13);
	ds_comunicado_w :=	ds_comunicado_w || ' ' || wheb_mensagem_pck.get_texto(311685, 'DT_INICIO_EXEC=' || dt_inicio_exec_w) || chr(13);
	ds_comunicado_w :=	ds_comunicado_w || ' ' || wheb_mensagem_pck.get_texto(311686, 'DT_FIM_PREST_CONTA=' || dt_fim_prest_conta_w) || chr(13);
	ds_comunicado_w :=	ds_comunicado_w || ' ' || wheb_mensagem_pck.get_texto(311687, 'DS_CONTA=' || ds_conta_w) || chr(13);
	 
if (ie_tipo_comunic_p = 'L') then	 
	--ds_titulo_w :=	'Liberação de Projeto'; 
	ds_titulo_w :=	wheb_mensagem_pck.get_texto(311662);
else 
	--ds_titulo_w :=	'Estorno da liberação do Projeto'; 
	ds_titulo_w :=	wheb_mensagem_pck.get_texto(311663);
end if;	
	 
	 
	insert into comunic_interna( 
		dt_comunicado, 
		ds_titulo, 
		ds_comunicado, 
		nm_usuario, 
		dt_atualizacao, 
		ie_geral, 
		nr_sequencia, 
		ie_gerencial, 
		dt_liberacao, 
		ds_perfil_adicional) 
	values ( 
		clock_timestamp(), 
		ds_titulo_w, 
		ds_comunicado_w, 
		nm_usuario_p, 
		clock_timestamp(),	 
		'N', 
		nr_sequencia_w, 
		'N', 
		clock_timestamp(), 
		ds_perfil_adicional_p);
 
	commit;	
	 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE projeto_recurso_comunicao ( nr_sequencia_p bigint, ds_perfil_adicional_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_tipo_comunic_p text) FROM PUBLIC;

