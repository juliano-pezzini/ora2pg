-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE create_protocol_ispm_return ( cd_prontuario_p bigint, cd_protocolo_ispm_p protocolo_medicacao.nr_seq_ispm%type, cd_finalidade_ispm_p bigint) AS $body$
DECLARE


cd_pessoa_fisica_w 		paciente_setor.cd_pessoa_fisica%type;
cd_medico_resp_w		paciente_setor.cd_pessoa_fisica%type;
cd_protocolo_w 			bigint;
cd_estabelecimento_w	bigint;
nr_seq_paciente_w		bigint;
cd_setor_w				bigint;
cd_finalidade_w			bigint;
nr_seq_medic_w 			bigint;
nr_seq_table_w			bigint;
qt_altura_cm_w			bigint;
qt_peso_w 				bigint;
qt_peso_atual_w			bigint;
qt_peso_oficial_w		bigint;
ie_unid_med_peso_w		varchar(10);
nm_usuario_w			varchar(15);
error_code				bigint;
error_text 				varchar(32000);
error_observarion_w		varchar(32000);


BEGIN
	qt_peso_oficial_w := null;
	
	select max(cd_pessoa_fisica)
	into STRICT cd_pessoa_fisica_w
	from pessoa_fisica 
	where nr_prontuario = cd_prontuario_p;
	
	select CASE WHEN cd_finalidade_ispm_p=1 THEN  5 WHEN cd_finalidade_ispm_p=2 THEN  1 WHEN cd_finalidade_ispm_p=3 THEN  10 WHEN cd_finalidade_ispm_p=4 THEN  2 WHEN cd_finalidade_ispm_p=5 THEN  3 WHEN cd_finalidade_ispm_p=6 THEN  11  ELSE cd_finalidade_ispm_p END
	into STRICT cd_finalidade_w
	;
	
	select max(nr_sequencia),
		   cd_estabelecimento,
		   nm_usuario
	into STRICT nr_seq_table_w,
		 cd_estabelecimento_w,
		 nm_usuario_w
	from w_ispm_pathway
	where nr_prontuario = cd_prontuario_p
	group by cd_estabelecimento,
			 nm_usuario LIMIT 1;
	
	if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '' AND nr_seq_table_w IS NOT NULL AND nr_seq_table_w::text <> '') then
		cd_setor_w := get_setor_user_estab(nm_usuario_w, cd_estabelecimento_w);

		select max(qt_altura_cm),
			   max(qt_peso), 
			   max(qt_peso_atual), 
			   upper(max(ie_unid_med_peso))
		into STRICT qt_altura_cm_w, 
			 qt_peso_w, 
			 qt_peso_atual_w, 
			 ie_unid_med_peso_w 
		from atendimento_sinal_vital  a
		where cd_paciente = cd_pessoa_fisica_w and 
			  ie_situacao <> 'I' 
    order by dt_atualizacao desc LIMIT 1;
		
		qt_peso_oficial_w := qt_peso_atual_w;
		
		if (qt_peso_w IS NOT NULL AND qt_peso_w::text <> '') then
			if (ie_unid_med_peso_w = 'OZ') then
				qt_peso_oficial_w := round((qt_peso_w * 0.0283495)::numeric, 3);
				
			else if (ie_unid_med_peso_w = 'KG') then
				qt_peso_oficial_w := qt_peso_w;
			
			else if (ie_unid_med_peso_w = 'G') then
				qt_peso_oficial_w := round((qt_peso_w * 0.001)::numeric, 3);
			
			else if (ie_unid_med_peso_w = 'LB') then
				qt_peso_oficial_w := round((qt_peso_w * 0.453592)::numeric, 3);
			end if;
			end if;
			end if;
			end if;
		end if;

		if (cd_setor_w IS NOT NULL AND cd_setor_w::text <> '') then
			select max(p.cd_protocolo),
				   max(pm.nr_sequencia)
			into STRICT cd_protocolo_w,
				 nr_seq_medic_w
			from protocolo p,
				 protocolo_medicacao pm
			where p.cd_protocolo = pm.cd_protocolo 
			and pm.nr_seq_ispm = cd_protocolo_ispm_p;
			
			select cd_pessoa_fisica
			into STRICT cd_medico_resp_w
			from usuario
			where nm_usuario = nm_usuario_w;

			insert into paciente_setor(
				nr_seq_paciente,
				cd_pessoa_fisica,
				cd_setor_atendimento,
				cd_estabelecimento,
				ie_status,
				cd_protocolo,
				nr_seq_medicacao,
				dt_atualizacao,
				dt_protocolo,
				nm_usuario,
				ie_finalidade,
				qt_peso,
				qt_altura,
				cd_medico_resp)
			values (
				nextval('paciente_setor_seq'),
				cd_pessoa_fisica_w,
				cd_setor_w,
				cd_estabelecimento_w,
				'A',
				cd_protocolo_w,
				nr_seq_medic_w,
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_w,
				cd_finalidade_w,
				qt_peso_oficial_w,
				qt_altura_cm_w,
				cd_medico_resp_w);
			
			commit;
			
			select max(nr_seq_paciente)
			into STRICT nr_seq_paciente_w
			from paciente_setor 
			where cd_pessoa_fisica = cd_pessoa_fisica_w and 
				  cd_protocolo = cd_protocolo_w and
				  nr_seq_medicacao = nr_seq_medic_w and
				  nm_usuario = nm_usuario_w;
				
				
			delete from w_ispm_pathway where nr_sequencia = nr_seq_table_w;
			commit;

			begin
				CALL copiar_protocolo_onc(cd_protocolo_w,
									 nr_seq_medic_w, 
									 nr_seq_paciente_w, 
									 'N', 
									 'S', 
									 nm_usuario_w);
				commit;

			exception
			when others then
				error_text := sqlerrm;
				
				update paciente_setor
				set ds_observacao = error_text 
				where nr_seq_paciente = nr_seq_paciente_w;
				commit;
				raise;
			end;
		end if;
	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE create_protocol_ispm_return ( cd_prontuario_p bigint, cd_protocolo_ispm_p protocolo_medicacao.nr_seq_ispm%type, cd_finalidade_ispm_p bigint) FROM PUBLIC;

