-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pepo_generate_cosign (NM_USUARIO_P text, NR_SEQUENCIA_P bigint) AS $body$
DECLARE

nr_seq_funcao_pf_t bigint := 0;
cd_pessoa_fisica_t varchar(10);
pending_approvals bigint := 0;
nr_seq_doc_t bigint;


BEGIN
    cd_pessoa_fisica_t := Obter_Cod_PF_Usuario(NM_USUARIO_P);

	begin
    select NR_SEQ_FUNCAO_PF, NR_SEQ_DOC into STRICT nr_seq_funcao_pf_t, nr_seq_doc_t from documento_aprov_prof where nr_sequencia = NR_SEQUENCIA_P;
	exception
	when no_data_found then
		nr_seq_funcao_pf_t:= null;
		nr_seq_doc_t := null;
	when too_many_rows then raise;
	end;

    if (NOT(nr_seq_funcao_pf_t > 0)) then
        select NR_SEQ_FUNCAO_PF into STRICT nr_seq_funcao_pf_t from pessoa_fisica where cd_pessoa_fisica = cd_pessoa_fisica_t;
    end if;

    update documento_aprov_prof 
    set
        cd_pessoa_fisica = cd_pessoa_fisica_t,
        nr_seq_funcao_pf = nr_seq_funcao_pf_t,
        dt_aprovacao = clock_timestamp(),
        ie_status = 'A'
    where 
        nr_sequencia = NR_SEQUENCIA_P;
    commit;

    select max(nr_sequencia) into STRICT pending_approvals from documento_aprov_prof where NR_SEQ_DOC = nr_seq_doc_t and ie_status <> 'A';

    if (pending_approvals IS NOT NULL AND pending_approvals::text <> '') then 
        update documento_aprovacao
        set
            IE_STATUS = 'P'
        where
            nr_sequencia = nr_seq_doc_t;
            commit;
    else
        update documento_aprovacao
        set
            IE_STATUS = 'A'
        where
            nr_sequencia = nr_seq_doc_t;
            commit;
    end if;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pepo_generate_cosign (NM_USUARIO_P text, NR_SEQUENCIA_P bigint) FROM PUBLIC;

