-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_saldo_neg_cheque_cr (nr_seq_cheque_p bigint, nm_usuario_p text) AS $body$
DECLARE


-- EDGAR 25/09/2008, NÃO DAR COMMIT
vl_cheque_w		double precision;
vl_saldo_negociado_w	double precision;
vl_negociado_w		double precision;
vl_novo_saldo_w		double precision;
cont_w			bigint;
vl_transacao_w		double precision;
vl_perda_w		double precision;
vl_transacao_perda_w	double precision;
qt_perda_w		bigint;
qt_movto_perda_w	bigint;
vl_baixa_perdas_canc_w		perda_contas_receb_baixa.vl_baixa%type;


BEGIN

select	max(vl_cheque),
	max(vl_saldo_negociado)
into STRICT	vl_cheque_w,
	vl_saldo_negociado_w
from	cheque_cr
where	nr_seq_cheque	= nr_seq_cheque_p;

select	count(*),
	coalesce(sum(coalesce(vl_negociado,0) + coalesce(vl_desconto,0)),0)
into STRICT	cont_w,
	vl_negociado_w
from	cheque_cr_negociado
where	nr_seq_cheque	= nr_seq_cheque_p;

select	coalesce(sum(a.vl_transacao),0)
into STRICT	vl_transacao_w
FROM transacao_financeira b, movto_trans_financ a
LEFT OUTER JOIN caixa_receb c ON (a.nr_seq_caixa_rec = c.nr_sequencia)
WHERE coalesce(c.ie_tipo_receb,'R')	<> 'C'  and b.ie_acao			= 30 and a.nr_seq_trans_financ		= b.nr_sequencia and a.nr_seq_cheque			= nr_seq_cheque_p;

select	count(*),
	coalesce(sum(a.vl_perda),0)
into STRICT	qt_perda_w,
	vl_perda_w
from	caixa_receb b,
	cheque_cr_perda a
where	coalesce(b.dt_cancelamento::text, '') = ''
and	coalesce(b.dt_fechamento::text, '') = ''
and	coalesce(b.ie_tipo_receb,'R')	= 'P'
and	a.nr_seq_caixa_rec		= b.nr_sequencia
and	a.nr_seq_cheque			= nr_seq_cheque_p;

select	count(*),
	coalesce(sum(a.vl_transacao),0)
into STRICT	qt_movto_perda_w,
	vl_transacao_perda_w
from	transacao_financeira b,
	movto_trans_financ a
where	b.ie_acao			= 33
and	a.nr_seq_trans_financ		= b.nr_sequencia
and	a.nr_seq_cheque			= nr_seq_cheque_p;

/*OS 1799459 Se o cheque tiver baixa por perda, verificar se a perda foi cancelada, para devolver o saldo negociado ao cheque e poder ser negociado novamente*/

if (vl_transacao_perda_w > 0) then

	select	sum(coalesce(b.vl_baixa,0))
	into STRICT	vl_baixa_perdas_canc_w
	from	perda_contas_receber a,
			perda_contas_receb_baixa b,
			fin_tipo_baixa_perda c
	where	a.nr_seq_cheque			= nr_seq_cheque_p
	and		a.nr_sequencia			= b.nr_seq_perda
	and		b.nr_seq_tipo_baixa 	= c.nr_sequencia
	and		c.ie_tipo_consistencia 	= '4'; -- Tipo de cancelamento com consistência de cancelamento, onde devolve o saldo a perda
	if (coalesce(vl_baixa_perdas_canc_w,0) <= coalesce(vl_transacao_perda_w,0)) then
		vl_transacao_perda_w := vl_transacao_perda_w - coalesce(vl_baixa_perdas_canc_w,0);
	end if;

end if;

if (cont_w > 0) or (vl_transacao_w > 0) or (qt_perda_w > 0) or (qt_movto_perda_w > 0) then

	if (vl_negociado_w > 0) or (vl_transacao_w > 0) or (qt_perda_w > 0) or (qt_movto_perda_w > 0) then

		/*vl_novo_saldo_w	:= nvl(vl_saldo_negociado_w,vl_cheque_w) - vl_negociado_w;
		Francisco - OS 171678 - 06/11/2009  - Troquei pela linha abaixo */
		vl_novo_saldo_w	:= coalesce(vl_cheque_w,0) - coalesce(vl_negociado_w,0) - coalesce(vl_transacao_w,0) - coalesce(vl_perda_w,0) - coalesce(vl_transacao_perda_w,0);
	else
		/* Posse hospital */

		if (obter_status_cheque(nr_seq_cheque_p) in (1,3,5,10)) then
			vl_novo_saldo_w	:= vl_cheque_w;
		/* Fora do hospital, sacado ou vendido p/terceiros */

		else
			vl_novo_saldo_w	:= 0;
		end if;
	end if;
else
	vl_novo_saldo_w	:= vl_cheque_w;
end if;

update	cheque_cr
set	vl_saldo_negociado	= vl_novo_saldo_w
where	nr_seq_cheque		= nr_seq_cheque_p;

--commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_saldo_neg_cheque_cr (nr_seq_cheque_p bigint, nm_usuario_p text) FROM PUBLIC;

