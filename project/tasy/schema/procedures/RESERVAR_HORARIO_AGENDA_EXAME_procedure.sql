-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reservar_horario_agenda_exame (nr_seq_agenda_p bigint, nm_usuario_p text, ie_reservado_p INOUT text) AS $body$
DECLARE


qt_agenda_w    bigint;
ie_reservado_w varchar(1) := 'S';


BEGIN
  IF (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') THEN
    SELECT count(*)
      INTO STRICT qt_agenda_w
      FROM agenda_paciente
     WHERE nr_sequencia = nr_seq_agenda_p
        AND (coalesce(ie_status_agenda, 'L') = 'L'
        or (nm_usuario = nm_usuario_p and coalesce(ie_status_agenda, 'N') = 'N'));

    IF (qt_agenda_w > 0) THEN
      BEGIN
        UPDATE agenda_paciente
           SET ie_status_agenda  = 'N',
               nm_usuario        = nm_usuario_p,
               nm_usuario_acesso = nm_usuario_p
         WHERE nr_sequencia = nr_seq_agenda_p;
        COMMIT;
          ie_reservado_w := 'S';
      EXCEPTION
        WHEN OTHERS THEN
          ie_reservado_w := 'H';
      END;
    ELSE
      SELECT CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
        INTO STRICT ie_reservado_w
        FROM agenda_paciente
       WHERE nr_sequencia = nr_seq_agenda_p
       AND   (nm_paciente IS NOT NULL AND nm_paciente::text <> '');
    END IF;
  END IF;

ie_reservado_p := ie_reservado_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reservar_horario_agenda_exame (nr_seq_agenda_p bigint, nm_usuario_p text, ie_reservado_p INOUT text) FROM PUBLIC;

