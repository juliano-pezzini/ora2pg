-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE integrar_agfa_ws ( nr_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text, ie_cancelamento_p text, ie_commit_p text) AS $body$
DECLARE


ds_sep_bv_w				varchar(1);
ds_param_integ_xml_w	varchar(4000);

enviarProntuario_w		smallint := 535;
enviarProfissional_w	smallint := 536;
enviarAtendimento_w		smallint := 537;
enviarCancelarPedido_w	smallint := 541;

ie_envia_mensagem_w		varchar(1);
ds_log_w				varchar(2000);


BEGIN
	begin
		ie_envia_mensagem_w := 'N';
		ds_log_w := '';
		ds_sep_bv_w := ';';

		if (upper(ie_cancelamento_p) = 'N') then

			select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ie_envia_mensagem_w
			from	prescr_procedimento a,
					lab_exame_equip b,
					equipamento_lab c,
					material_exame_lab d
			where	a.nr_seq_exame    = b.nr_seq_exame
			and		b.cd_equipamento  = c.cd_equipamento
			and 	a.cd_material_exame = d.cd_material_exame
			and		a.nr_prescricao   = nr_prescricao_p
			and (b.nr_seq_material = d.nr_sequencia or coalesce(b.nr_seq_material::text, '') = '')
			and		c.ds_sigla = 'AGFAWS'
			and (coalesce(nr_seq_prescr_p::text, '') = '' or a.nr_sequencia = nr_seq_prescr_p)
			and		a.ie_suspenso = 'N';

			if (ie_envia_mensagem_w = 'S') then

				/* Foi requisitado pela AGFA que o Tasy enviasse as mensagens de prontuário, profissional, atendimento e pedido nessa ordem e o Tasy deve esperar a primeira mensagem ser processada para só então enviar a segunda,
				 * Ficou decidido que seria gerado o agendamento_integracao apenas do prontuário, e no envio do prontuário seria feito o envio das mensagens de profissional, atendimento e pedido, isso foi tratado diretamente no código Java.
				 * OS 984162
				 */
				if (wheb_usuario_pck.is_evento_ativo(enviarProntuario_w) = 'S' and wheb_usuario_pck.is_evento_ativo(enviarProfissional_w) = 'S' and wheb_usuario_pck.is_evento_ativo(enviarAtendimento_w) = 'S' and wheb_usuario_pck.is_evento_ativo(enviarCancelarPedido_w) = 'S') then
					ds_param_integ_xml_w := 'nr_atendimento=' || to_char(nr_atendimento_p) || ds_sep_bv_w || 'nr_prescricao=' || to_char(nr_prescricao_p) || ds_sep_bv_w || 'tipo_operacao_pedido=I' || ds_sep_bv_w|| 'tipo_operacao_exame=I' || ds_sep_bv_w;
					ds_log_w := substr('AGFA - nr_seq_evento_p: ' || to_char(enviarProntuario_w) || ' - ' || ds_param_integ_xml_w, 1, 2000);
					CALL gravar_log_lab(66, ds_log_w, nm_usuario_p, nr_prescricao_p, 'AGFA');
					CALL gravar_agend_integracao(enviarProntuario_w, ds_param_integ_xml_w);

					if (ie_commit_p = 'S') then
						if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
					end if;
				end if;
			end if;

		elsif (upper(ie_cancelamento_p) = 'S') then
			-- Cancela no AGFA os itens que estão suspensos.
			if (wheb_usuario_pck.is_evento_ativo(enviarCancelarPedido_w) = 'S') then
				ds_param_integ_xml_w := 'nr_prescricao=' || to_char(nr_prescricao_p) || ds_sep_bv_w || 'nr_seq_prescr=' || to_char(nr_seq_prescr_p) || ds_sep_bv_w || 'tipo_operacao_pedido=A' || ds_sep_bv_w || 'tipo_operacao_exame=E' || ds_sep_bv_w;
				ds_log_w := substr('AGFA - nr_seq_evento_p: ' || to_char(enviarCancelarPedido_w) || ' - ' || ds_param_integ_xml_w, 1, 2000);
				CALL gravar_log_lab(66, ds_log_w, nm_usuario_p, nr_prescricao_p, 'AGFA');
				CALL gravar_agend_integracao(enviarCancelarPedido_w, ds_param_integ_xml_w);

				if (ie_commit_p = 'S') then
					if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
				end if;
			end if;
		end if;
	exception when others then
		 CALL gravar_log_lab(66, 'An error was encountered - '||SQLSTATE||' -ERROR- '||SQLERRM, nm_usuario_p, nr_prescricao_p, 'AGFA');
    end;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE integrar_agfa_ws ( nr_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text, ie_cancelamento_p text, ie_commit_p text) FROM PUBLIC;

