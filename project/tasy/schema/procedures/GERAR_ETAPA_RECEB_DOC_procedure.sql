-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_etapa_receb_doc ( nr_seq_documento_p bigint, nr_seq_etapa_p bigint, nm_usuario_p text, ie_opcao_p text default 'R') AS $body$
DECLARE

		 
nr_seq_item_w			bigint;
nr_interno_conta_w		bigint;
cd_setor_destino_w		integer;
cd_pessoa_destino_w		varchar(10);
ie_conta_existe_w		varchar(10);
ds_documento_w			varchar(2000);
ie_tipo_protocolo_w		varchar(3);
nr_atendimento_w		bigint;
nr_conta_atend_w		bigint;
cd_estabelecimento_w		bigint;
cd_perfil_w			bigint;
nr_seq_etapa_w			bigint;
ds_texto_etapa_w		varchar(250);
ie_regra_restrita_etapa_w	varchar(1);
ie_encontrou_regra_w		varchar(1);
		
C01 CURSOR FOR 
	SELECT	nr_seq_item, 
		nr_seq_interno, 
		ds_documento 
	from	protocolo_doc_item 
	where	nr_sequencia = nr_seq_documento_p 
	and	(nr_seq_interno IS NOT NULL AND nr_seq_interno::text <> '') 
	and	coalesce(dt_retirada::text, '') = '' 
	order by nr_seq_item;
	
C02 CURSOR FOR 
	SELECT	b.nr_seq_item, 
		b.nr_documento, 
		b.ds_documento 
	from	protocolo_documento a, 
		protocolo_doc_item b 
	where	a.nr_sequencia = b.nr_sequencia 
	and	a.nr_sequencia = nr_seq_documento_p 
	and	a.ie_tipo_protocolo = ie_tipo_protocolo_w 
	and	coalesce(b.dt_retirada::text, '') = '' 
	order by nr_seq_item;
	
C03 CURSOR FOR 
	SELECT	nr_interno_conta 
	from	conta_paciente 
	where	nr_atendimento = nr_atendimento_w;
	
C04 CURSOR FOR 
	SELECT	nr_seq_etapa 
	from	fatur_etapa_alta 
	where	nr_seq_etapa_filtro = nr_seq_etapa_p 
	and	ie_evento = '1' 
	and 	coalesce(cd_estabelecimento,coalesce(cd_estabelecimento_w,1)) = coalesce(cd_estabelecimento_w,1) 
	and	coalesce(cd_perfil,coalesce(cd_perfil_w,0)) = coalesce(cd_perfil_w,0) 
	and	ie_situacao = 'A' 
	order by 	coalesce(cd_perfil,0), 
		coalesce(cd_estabelecimento,0);


BEGIN 
 
select 	max(cd_setor_destino), 
	max(cd_pessoa_destino), 
	coalesce(max(ie_tipo_protocolo),'0') 
into STRICT	cd_setor_destino_w, 
	cd_pessoa_destino_w, 
	ie_tipo_protocolo_w 
from 	protocolo_documento 
where 	nr_sequencia = nr_seq_documento_p;
 
if (coalesce(cd_pessoa_destino_w,'0') = '0') then 
	select	max(cd_pessoa_fisica) 
	into STRICT	cd_pessoa_destino_w 
	from	usuario 
	where	nm_usuario = nm_usuario_p;
end if;
 
if (ie_tipo_protocolo_w in ('5','32')) then 
 
	select	wheb_usuario_pck.get_cd_estabelecimento, 
		obter_perfil_ativo 
	into STRICT	cd_estabelecimento_w, 
		cd_perfil_w 
	;
	 
	if (ie_opcao_p = 'E') then 
		ds_texto_etapa_w := Wheb_mensagem_pck.get_Texto(306336); /*'Gerado pelo envio (Protocolo Documento). ';*/
	else 
		ds_texto_etapa_w := Wheb_mensagem_pck.get_Texto(306337); /*'Gerado pelo recebimento (Protocolo Documento). ';*/
	end if;
	 
	select	coalesce(max(ie_regra_restrita_etapa),'N') 
	into STRICT	ie_regra_restrita_etapa_w 
	from	parametro_faturamento 
	where	cd_estabelecimento = cd_estabelecimento_w;
	 
	open C01;
	loop 
	fetch C01 into 
		nr_seq_item_w, 
		nr_interno_conta_w, 
		ds_documento_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin		 
		 
		ie_conta_existe_w := inserir_conta_etapa(	nr_interno_conta_w, nm_usuario_p, nr_seq_etapa_p, cd_setor_destino_w, 0, cd_pessoa_destino_w, ds_texto_etapa_w || ds_documento_w, 0, nr_seq_documento_p, ie_conta_existe_w);
 
		update	protocolo_doc_item 
		set	nr_seq_etapa_conta	= nr_seq_etapa_p 
		where	nr_sequencia		= nr_seq_documento_p 
		and	nr_seq_item		= nr_seq_item_w;
		 
		ie_encontrou_regra_w	:= 'N';
 
		open C04;
		loop 
		fetch C04 into	 
			nr_seq_etapa_w;
		EXIT WHEN NOT FOUND; /* apply on C04 */
			begin 
			ie_encontrou_regra_w	:= 'S';
			 
			if (ie_regra_restrita_etapa_w = 'N') then 
				nr_seq_documento_p := inserir_conta_etapa( 
					nr_interno_conta_w, nm_usuario_p, nr_seq_etapa_w, cd_setor_destino_w, 0, cd_pessoa_destino_w, Wheb_mensagem_pck.get_Texto(306338, 'DS_DOCUMENTO_W='|| DS_DOCUMENTO_W ), /*'Gerado pela regra (Protocolo Documento): ' || ds_documento_w || ' - ', */ 
					0, nr_seq_documento_p);
					 
				update	protocolo_doc_item 
				set	nr_seq_etapa_conta	= nr_seq_etapa_p 
				where	nr_sequencia		= nr_seq_documento_p 
				and	nr_seq_item		= nr_seq_item_w;
			end if;
			end;
		end loop;
		close C04;
		 
		if (ie_regra_restrita_etapa_w = 'S') and (ie_encontrou_regra_w = 'S') then 
			nr_seq_documento_p := inserir_conta_etapa( 
				nr_interno_conta_w, nm_usuario_p, nr_seq_etapa_w, cd_setor_destino_w, 0, cd_pessoa_destino_w, Wheb_mensagem_pck.get_Texto(306338, 'DS_DOCUMENTO_W='|| DS_DOCUMENTO_W ), /*'Gerado pela regra (Protocolo Documento): ' || ds_documento_w || ' - ', */ 
				0, nr_seq_documento_p);
 
			update	protocolo_doc_item 
			set	nr_seq_etapa_conta	= nr_seq_etapa_p 
			where	nr_sequencia		= nr_seq_documento_p 
			and	nr_seq_item		= nr_seq_item_w;
		end if;
		 
		end;
	end loop;
	close C01;
	 
elsif (ie_tipo_protocolo_w in ('2','6')) then 
 
	open C02;
	loop 
	fetch C02 into 
		nr_seq_item_w, 
		nr_atendimento_w, 
		ds_documento_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		 
		open C03;
		loop 
		fetch C03 into	 
			nr_conta_atend_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin 
			if (ie_opcao_p = 'E') then 
				ds_texto_etapa_w := Wheb_mensagem_pck.get_Texto(306336); /*'Gerado pelo envio (Protocolo Documento). ';*/
			else 
				ds_texto_etapa_w := Wheb_mensagem_pck.get_Texto(306337); /*'Gerado pelo recebimento (Protocolo Documento). ';*/
			end if;
			 
			ie_conta_existe_w := inserir_conta_etapa( 
				nr_conta_atend_w, nm_usuario_p, nr_seq_etapa_p, cd_setor_destino_w, 0, cd_pessoa_destino_w, substr(ds_texto_etapa_w || ds_documento_w,1,2000), 0, nr_seq_documento_p, ie_conta_existe_w);
			 
			end;
		end loop;
		close C03;
		 
		update	protocolo_doc_item 
		set	nr_seq_etapa_conta	= nr_seq_etapa_p 
		where	nr_sequencia		= nr_seq_documento_p 
		and	nr_seq_item		= nr_seq_item_w;
		end;
	end loop;
	close C02;
 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_etapa_receb_doc ( nr_seq_documento_p bigint, nr_seq_etapa_p bigint, nm_usuario_p text, ie_opcao_p text default 'R') FROM PUBLIC;

