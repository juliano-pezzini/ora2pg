-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sup_copia_pessoa_adic_estab (cd_cgc_p text, ie_opcao_p bigint, cd_pessoa_adic_old_p bigint, cd_pessoa_adic_new_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* IE_OPCAO_P:
1: Insere
2: Altera
3: Exclui
*/
cd_estabelecimento_w			smallint;
qt_existe_w						bigint;
nr_sequencia_w					bigint;

c01 CURSOR FOR
SELECT	cd_estabelecimento
from	estabelecimento_v
where	cd_estabelecimento <> cd_estabelecimento_p;



BEGIN

open c01;
loop
fetch c01 into
	cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	select	count(*)
	into STRICT	qt_existe_w
	from	pessoa_jur_tipo_adic
	where	cd_estabelecimento 	= cd_estabelecimento_w
	and		cd_cgc				= cd_cgc_p
	and		cd_tipo_pessoa		= cd_pessoa_adic_new_p;


	if (ie_opcao_p = 1) and (qt_existe_w = 0) then
		begin
		select 	nextval('pessoa_jur_tipo_adic_seq')
		into STRICT	nr_sequencia_w
		;

		insert into pessoa_jur_tipo_adic(
						nr_sequencia,
						cd_estabelecimento,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						cd_cgc,
						cd_tipo_pessoa) values (nr_sequencia_w,
											cd_estabelecimento_w,
											clock_timestamp(),
											nm_usuario_p,
											clock_timestamp(),
											nm_usuario_p,
											cd_cgc_p,
											cd_pessoa_adic_new_p);
		end;

	elsif (ie_opcao_p = 2) then
		begin
		update	pessoa_jur_tipo_adic
		set		cd_tipo_pessoa		= cd_pessoa_adic_new_p,
				dt_atualizacao		= clock_timestamp(),
				nm_usuario			= nm_usuario_p
		where	cd_estabelecimento 	= cd_estabelecimento_w
		and		cd_cgc				= cd_cgc_p
		and		cd_tipo_pessoa		= cd_pessoa_adic_old_p;
		end;

	elsif (ie_opcao_p = 3) then
		begin
		delete
		from	pessoa_jur_tipo_adic
		where	cd_estabelecimento 	= cd_estabelecimento_w
		and		cd_cgc				= cd_cgc_p
		and		cd_tipo_pessoa		= cd_pessoa_adic_old_p;
		end;

	end if;
	end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_copia_pessoa_adic_estab (cd_cgc_p text, ie_opcao_p bigint, cd_pessoa_adic_old_p bigint, cd_pessoa_adic_new_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

