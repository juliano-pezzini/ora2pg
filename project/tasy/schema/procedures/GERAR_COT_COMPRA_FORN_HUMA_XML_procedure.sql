-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cot_compra_forn_huma_xml ( nr_cot_compra_p bigint, cd_cnpj_p text, ds_cond_pagto_p text, ds_obs_fornec_p text, dt_prevista_entrega_p text, cd_material_p bigint, nr_doc_externo_p text, qt_material_p text, vl_unit_material_p text, pr_desconto_p text, pr_ipi_p text, nm_usuario_p text, ie_tipo_interface_p bigint, ie_opcao_p bigint, ds_obs_item_p text, ds_marca_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


cd_cnpj_w				varchar(14);
nr_item_cotacao_w				integer;
cd_moeda_w				integer;
cd_condicao_pagto_w			bigint;
cd_estabelecimento_w			smallint;
nr_seq_cot_fornecedor_w			bigint;
nr_seq_fornec_w				bigint;
nr_sequencia_item_w			bigint;
cd_material_w				integer;
ds_forma_pagto_fornec_w			varchar(80);
qt_material_w				double precision;
vl_material_w				double precision;
pr_desconto_w				double precision;
pr_ipi_w					double precision;
qt_dias_entrega_w				double precision;
qt_registro_w				bigint;

c02 CURSOR FOR
SELECT	cd_estabelecimento
from	estabelecimento
where	ie_situacao = 'A';


BEGIN

cd_cnpj_w	:= cd_cnpj_p;
cd_material_w	:= cd_material_p;
qt_material_w	:= replace(qt_material_p,'.',',');
vl_material_w	:= replace(vl_unit_material_p,'.',',');
pr_desconto_w	:= replace(coalesce(pr_desconto_p,0),'.',',');
pr_ipi_w	:= replace(coalesce(pr_ipi_p,0),'.',',');

select	count(*)
into STRICT	qt_registro_w
from	pessoa_juridica
where	cd_cgc = cd_cnpj_w;

if (qt_registro_w = 0) then
	/*'Não possui nenhuma pessoa jurídica cadastrada com o CNPJ= ' || CD_CNPJ_W);*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(192914,'CD_CNPJ_W='||CD_CNPJ_W);
end if;

select	coalesce(max(cd_estabelecimento),cd_estabelecimento_p)
into STRICT	cd_estabelecimento_w
from	cot_compra
where	nr_cot_compra	= nr_cot_compra_p;

select	coalesce(max(cd_moeda_padrao),0),
	max(cd_condicao_pagamento_padrao)
into STRICT	cd_moeda_w,
	cd_condicao_pagto_w
from	parametro_compras
where	cd_estabelecimento	= cd_estabelecimento_w;

if (cd_moeda_w = 0) then
	/*'Informar a moeda padrão nos parâmetros de compras..');*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(186698);
end if;

update	cot_compra
set	ie_tipo_integracao_receb = ie_tipo_interface_p
where	nr_cot_compra = nr_cot_compra_p;

update	cot_compra
set	nr_documento_externo = nr_doc_externo_p
where	nr_cot_compra = nr_cot_compra_p
and	coalesce(nr_documento_externo::text, '') = '';

ds_forma_pagto_fornec_w := '';

select	max(cd_interno)
into STRICT	ds_forma_pagto_fornec_w
from	conversao_meio_externo
where	upper(nm_tabela) = 'CONDICAO_PAGAMENTO'
and	upper(nm_atributo) = 'CD_CONDICAO_PAGAMENTO'
and	ie_sistema_externo = 'B'
and	cd_externo = ds_cond_pagto_p;

select	coalesce(max(cd_condicao_pagamento),cd_condicao_pagto_w)
into STRICT	cd_condicao_pagto_w
from	condicao_pagamento
where	upper(cd_condicao_pagamento) = upper(coalesce(ds_forma_pagto_fornec_w,ds_cond_pagto_p));

if (coalesce(cd_condicao_pagto_w,0) = 0) then
	/*'Não encontrado nenhuma condição de pagamento. Verifique se existe alguma condição padrão nos parâmetros de compras.');*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(192915);
end if;

if (cd_cnpj_w <> '0') and (ie_opcao_p = 0) then
	begin

	select	obter_dias_entre_datas(clock_timestamp(), to_date(dt_prevista_entrega_p,'dd/mm/yyyy'))
	into STRICT	qt_dias_entrega_w
	;

	if (qt_dias_entrega_w < 0) then
		qt_dias_entrega_w := 1;
	end if;

	select	nextval('cot_compra_forn_seq')
	into STRICT	nr_seq_cot_fornecedor_w
	;

	select	count(*)
	into STRICT	qt_registro_w
	from	cot_compra_forn
	where	nr_cot_compra = nr_cot_compra_p
	and	cd_cgc_fornecedor = cd_cnpj_w;

	insert	into cot_compra_forn(
		nr_sequencia,
		nr_cot_compra,
		cd_cgc_fornecedor,
		dt_atualizacao,
		nm_usuario,
		ds_observacao,
		cd_moeda,
		cd_condicao_pagamento,
		ie_frete,
		ie_gerado_bionexo,
		ie_status_envio_email_lib,
		qt_dias_entrega,
		ie_liberada_internet,
		nr_documento_externo)
	values (	nr_seq_cot_fornecedor_w,
		nr_cot_compra_p,
		cd_cnpj_w,
		clock_timestamp(),
		nm_usuario_p,
		ds_obs_fornec_p,
		cd_moeda_w,
		cd_condicao_pagto_w,
		'C',
		'X',
		'N',
		qt_dias_entrega_w,
		'N',
		nr_doc_externo_p);
end;
end if;

if (cd_cnpj_w <> '0') and (ie_opcao_p = 1) then

	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_seq_fornec_w
	from	cot_compra_forn
	where	nr_cot_compra = nr_cot_compra_p
	and	cd_cgc_fornecedor = cd_cnpj_w;

	select	coalesce(min(a.nr_item_cot_compra),0)
	into STRICT	nr_item_cotacao_w
	from	cot_compra_item a
	where	a.nr_cot_compra	= nr_cot_compra_p
	and	a.cd_material = cd_material_p;

	if (nr_item_cotacao_w > 0) and (nr_seq_fornec_w > 0) then

		update	cot_compra_item
		set	ie_situacao = 'A'
		where	nr_cot_compra = nr_cot_compra_p
		and	nr_item_cot_compra = nr_item_cotacao_w
		and	coalesce(ie_situacao,'A') <> 'A';

		select	nextval('cot_compra_forn_item_seq')
		into STRICT	nr_sequencia_item_w
		;

		insert into cot_compra_forn_item(
			nr_sequencia,
			nr_seq_cot_forn,
			nr_cot_compra,
			nr_item_cot_compra,
			cd_cgc_fornecedor,
			qt_material,
			vl_unitario_material,
			dt_atualizacao,
			nm_usuario,
			vl_preco_liquido,
			vl_total_liquido_item,
			ie_situacao,
			cd_material,
			ds_observacao,
			pr_desconto,
			ds_marca,
			ds_marca_fornec)
		values (	nr_sequencia_item_w,
			nr_seq_fornec_w,
			nr_cot_compra_p,
			nr_item_cotacao_w,
			cd_cnpj_w,
			qt_material_w,
			vl_material_w,
			clock_timestamp(),
			nm_usuario_p,
			0,
			0,
			'A',
			cd_material_w,
			substr(ds_obs_item_p,1,255),
			pr_desconto_w,
			substr(ds_marca_p,1,30),
			substr(ds_marca_p,1,30));
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cot_compra_forn_huma_xml ( nr_cot_compra_p bigint, cd_cnpj_p text, ds_cond_pagto_p text, ds_obs_fornec_p text, dt_prevista_entrega_p text, cd_material_p bigint, nr_doc_externo_p text, qt_material_p text, vl_unit_material_p text, pr_desconto_p text, pr_ipi_p text, nm_usuario_p text, ie_tipo_interface_p bigint, ie_opcao_p bigint, ds_obs_item_p text, ds_marca_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

