-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_prescr_hor_sem_lote ( nr_prescricao_p bigint, nr_seq_item_p bigint, cd_perfil_p bigint, nm_usuario_p text, ie_lib_parc_p text default null, nr_seq_horario_p bigint default null) AS $body$
DECLARE


ajustar_disp_hor_farm_w	varchar(1);
sqlerrm_w 		varchar(2000);
ie_gera_nutricao_w	varchar(1);

BEGIN

ie_gera_nutricao_w := obter_param_usuario(924, 545, cd_perfil_p, nm_usuario_p, 0, ie_gera_nutricao_w);

if (coalesce(ie_lib_parc_p,'N') = 'N') then
	update	prescr_mat_hor
	set	dt_lib_horario	= clock_timestamp()
	where	nr_prescricao 	= nr_prescricao_p
	and	coalesce(dt_lib_horario::text, '') = ''
	and	((nr_sequencia	= nr_seq_horario_p) or (coalesce(nr_seq_horario_p,0) = 0))
	and	((nr_seq_material = nr_seq_item_p) or (coalesce(nr_seq_item_p,0) = 0));
else
	update	prescr_mat_hor a
	set	a.dt_lib_horario	= clock_timestamp()
	where	a.nr_prescricao 	= nr_prescricao_p
	and	coalesce(a.dt_lib_horario::text, '') = ''
	and	((nr_seq_material = nr_seq_item_p) or (coalesce(nr_seq_item_p,0) = 0))
	and	((nr_sequencia	= nr_seq_horario_p) or (coalesce(nr_seq_horario_p,0) = 0))
	and	exists (	SELECT	1
				from	prescr_material b
				where	b.nr_prescricao		=	a.nr_prescricao
				and	b.nr_sequencia		=	a.nr_seq_material
				and	coalesce(nr_seq_inconsistencia::text, '') = '')
	and	not exists (	select 	1
				from	prescr_material_incon_farm c
				where	c.nr_prescricao 	= a.nr_prescricao
				and	c.nr_seq_material 	= a.nr_seq_material
				and	coalesce(c.ie_situacao,'A')  = 'A')
	and	not exists (	select	1
				from	prescr_solucao d
				where	d.nr_prescricao		=	a.nr_prescricao
				and	d.nr_seq_solucao	=	a.nr_seq_solucao
				and	(nr_seq_inconsistencia IS NOT NULL AND nr_seq_inconsistencia::text <> ''))
	and	not exists (	select 	1
				from	prescr_material_incon_farm e
				where	e.nr_prescricao 	= a.nr_prescricao
				and	e.nr_seq_solucao 	= a.nr_seq_solucao
				and	coalesce(e.ie_situacao,'A')  = 'A');
end if;


if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

begin
begin
select	coalesce(max(obter_valor_param_usuario(924, 179, cd_perfil_p, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento)),'N')
into STRICT	ajustar_disp_hor_farm_w
;
exception
	when others then
	ajustar_disp_hor_farm_w := 'N';
end;

begin
if (ajustar_disp_hor_farm_w <> 'N') then
	CALL calcular_dispensar_horario(nr_prescricao_p,0);
end if;
exception
	when others then
	ajustar_disp_hor_farm_w := 'N';
end;

begin
	if (ie_gera_nutricao_w = 'S') then
		CALL gerar_servico_nut_pep(nr_prescricao_p,nm_usuario_p,cd_perfil_p);
	end if;
exception
	when others then
	ajustar_disp_hor_farm_w := 'N';
end;

CALL adep_gerar_area_prep(nr_prescricao_p, nr_seq_item_p, nm_usuario_p);
/*
if	(nvl(nr_seq_item_p,0) = 0) then
	Gerar_Lote_Atend_Prescricao(nr_prescricao_p, 0, 0, 'N', nm_usuario_p, 'GPMH');
else
	Gerar_Lote_Atend_Prescricao(nr_prescricao_p, nr_seq_item_p, 0, 'N', nm_usuario_p, 'GPMH');
end if;*/
exception
	when others then
	sqlerrm_w	:= substr(sqlerrm,1,2000);
end;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_prescr_hor_sem_lote ( nr_prescricao_p bigint, nr_seq_item_p bigint, cd_perfil_p bigint, nm_usuario_p text, ie_lib_parc_p text default null, nr_seq_horario_p bigint default null) FROM PUBLIC;

