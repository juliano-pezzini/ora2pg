-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_gerar_base_relatorio (ie_opcao_p text) AS $body$
DECLARE


/*  ie_opção_p
	W - Todos os Relatórios Wheb
	C - Os Clientes Selecionados na Base
*/
nm_tabela_w            	varchar(50)      := null;
nr_sequencia_w		bigint;
ds_comando_w		varchar(2000);
vl_retorno_w		varchar(255);

nm_tablespace_w		varchar(50);


BEGIN

if (ie_opcao_p = 'C') then
	CALL abortar_se_gerando_versao();
end if;

select	' TABLESPACE '||obter_tablespace_tab_temp
into STRICT	nm_tablespace_w
;


CALL Tasy_excluir_base_relatorio('Drop');
if (ie_opcao_p = 'W') then
	ds_comando_w	:=
		'create table w_relatorio '|| nm_tablespace_w ||' as (select * from relatorio ' ||
		'where nr_sequencia in ( ' ||
		'Select nr_sequencia from Relatorio ' ||
		'where substr(cd_classif_relat,1,1) = ' || chr(39) || 'W' || chr(39) || '))';
else
	ds_comando_w	:=
		'create table w_relatorio '|| nm_tablespace_w ||' as ( select * from relatorio ' ||
		'where nr_sequencia in ( ' ||
		'Select nr_sequencia from Relatorio ' ||
		'where ie_gerar_base = ' || chr(39) || 'S' || chr(39) || '))';
end if;

CALL Exec_sql_Dinamico('Relatorio', ds_comando_w);

ds_comando_w	:= 'create table w_Banda_relatorio '|| nm_tablespace_w ||' as ( select * from Banda_relatorio ' ||
		'where nr_seq_relatorio in ( ' ||
		'Select nr_sequencia from w_Relatorio))';
CALL Exec_sql_Dinamico('Relatorio', ds_comando_w);


ds_comando_w	:= 'create table w_Banda_relat_campo '|| nm_tablespace_w ||' as (select * from Banda_relat_campo ' ||
		'where nr_seq_banda in ( ' ||
		'Select nr_sequencia from w_Banda_Relatorio))';
CALL Exec_sql_Dinamico('Relatorio', ds_comando_w);

ds_comando_w	:= 'create table w_banda_relat_campo_longo tablespace users '||
				    ' as (select * from banda_relat_campo_longo ' ||
					' where nr_seq_banda_relat_campo in (select nr_Sequencia from w_Banda_relat_campo)) ';
CALL Exec_sql_Dinamico('Relatorio', ds_comando_w);

ds_comando_w	:= 'create table w_banda_relat_variavel '|| nm_tablespace_w ||' as (select * from banda_relat_variavel ' ||
		'where nr_seq_banda in ( ' ||
		'Select nr_sequencia from w_Banda_Relatorio))';
CALL Exec_sql_Dinamico('Relatorio', ds_comando_w);

ds_comando_w	:= 'create table w_Relatorio_Parametro '|| nm_tablespace_w ||' as ( select * from Relatorio_Parametro ' ||
		'where nr_seq_relatorio in ( ' ||
		'Select nr_sequencia from w_Relatorio))';
CALL Exec_sql_Dinamico('Relatorio', ds_comando_w);

ds_comando_w	:= 'create table w_relatorio_funcao '|| nm_tablespace_w ||' as ( select * from Relatorio_Funcao ' ||
		'where nr_seq_relatorio in ( ' ||
		'Select nr_sequencia from w_Relatorio))';
CALL Exec_sql_Dinamico('Relatorio', ds_comando_w);

ds_comando_w	:= 'create table w_etiqueta '|| nm_tablespace_w ||' as ( select * from etiqueta ' ||
		'where nr_seq_relatorio in ( ' ||
		'Select nr_sequencia from w_Relatorio))';
CALL Exec_sql_Dinamico('Relatorio', ds_comando_w);

ds_comando_w	:= 'create table w_funcao_regra_relat '|| nm_tablespace_w ||' as ( select * from funcao_regra_relat ' ||
		'where nr_seq_relatorio in ( ' ||
		'Select nr_sequencia from w_Relatorio))';
CALL Exec_sql_Dinamico('Relatorio', ds_comando_w);

ds_comando_w	:= 'create table w_relatorio_documentacao '|| nm_tablespace_w ||' as ( select * from relatorio_documentacao ' ||
		'where nr_seq_relatorio in ( ' ||
		'Select nr_sequencia from w_Relatorio))';
CALL Exec_sql_Dinamico('Relatorio', ds_comando_w);

ds_comando_w	:= 'create table w_usuario_relatorio '|| nm_tablespace_w ||' as ( select * from usuario_relatorio ' ||
		'where nr_seq_relatorio in ( ' ||
		'Select nr_sequencia from w_Relatorio))';
CALL Exec_sql_Dinamico('Relatorio', ds_comando_w);

ds_comando_w	:= ' ';
CALL Exec_sql_Dinamico('Relatorio', ds_comando_w);

ds_comando_w	:= 'create index w_banda_relatorio_i1 
			on w_banda_relatorio(nr_seq_relatorio, nr_sequencia)';
CALL Exec_sql_Dinamico('Relatorio', ds_comando_w);

ds_comando_w	:= 'create index w_banda_relat_campo_i1 
			on w_banda_relat_campo (nr_seq_banda, nr_sequencia)';
CALL Exec_sql_Dinamico('Relatorio', ds_comando_w);

ds_comando_w	:= 'create index w_banda_relat_campo_i2 
			on w_banda_relat_variavel (nr_seq_banda, nr_sequencia)';
CALL Exec_sql_Dinamico('Relatorio', ds_comando_w);

ds_comando_w	:= 'create index w_relatorio_funcao_i1 
			on w_relatorio_funcao(nr_seq_relatorio, cd_funcao)';
CALL Exec_sql_Dinamico('Relatorio', ds_comando_w);

ds_comando_w	:= 'create index w_relatorio_parametro_i1 on 
			w_relatorio_parametro(nr_seq_relatorio, nr_sequencia)';
CALL Exec_sql_Dinamico('Relatorio', ds_comando_w);

ds_comando_w	:= 'create index w_etiqueta_i1 
			on w_etiqueta (nr_seq_relatorio, nr_seq_impressora)';
CALL Exec_sql_Dinamico('Relatorio', ds_comando_w);

/********************************************************************

	IMPORTANTE!!!!!!!!!!
	NÃO RETIRAR O COMANDO A SEGUIR DA PROCEDURE
	
	ESSE COMANDO FOI COLOCADO AQUI PARA QUE DURANTE
	A GERAÇÃO DA EXPWHEB O ERRO A SEGUIR:
	
	EXP-00008: ORACLE error 1455 encountered
	ORA-01455: converting column overflows integer datatype
	EXP-00000: Export terminated unsuccessfully

	NÃO OCORRA.
	OS 1329911

*********************************************************************/
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_gerar_base_relatorio (ie_opcao_p text) FROM PUBLIC;

