-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_prescr_proc_eup (nr_prescricao_p bigint, nr_seq_agenda_p bigint, cd_estabelecimento_p bigint, cd_convenio_p bigint, nr_atendimento_p bigint, ie_tipo_pessoa_p text, cd_perfil_p bigint, ie_prescricao_p text, ds_usuario_p text, ds_perfil_p text, ds_mensagem_p text, ds_erro_p INOUT text, qt_prescr_proced_p INOUT bigint, ds_consistencia_p INOUT text, qt_pep_p INOUT bigint, nr_sequencia_p INOUT bigint, ie_agrupa_fleury_p INOUT text, ds_prescr_fleury_p INOUT text, ds_pr_fleury_p INOUT text, ds_evento_pri_p INOUT text, ds_evento_sec_p INOUT text, ds_evento_ter_p INOUT text, ie_autorizacao_p INOUT text, nr_seq_agenda_pac_p INOUT bigint, nr_seq_agenda_cons_p INOUT bigint, ie_tipo_agenda_p INOUT text, ds_imprimir_p INOUT text, nr_seq_avaliacao_p INOUT bigint, nm_usuario_p text) AS $body$
DECLARE

 
ie_gerar_kit_proc_lib_w		varchar(1);
ie_gerar_kit_mat_lib_w		varchar(1);
ie_forma_gerar_aval_exam_w	varchar(1);
ie_dup_proc_bilateral_w		varchar(1);
ie_gerar_conv_lib_w			varchar(1);


BEGIN 
 
ie_gerar_conv_lib_w := Obter_param_Usuario(916, 59, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_gerar_conv_lib_w);
ie_gerar_kit_proc_lib_w := Obter_param_Usuario(916, 291, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_gerar_kit_proc_lib_w);
ie_forma_gerar_aval_exam_w := Obter_param_Usuario(916, 338, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_forma_gerar_aval_exam_w);
ie_gerar_kit_mat_lib_w := Obter_param_Usuario(916, 421, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_gerar_kit_mat_lib_w);
 
ie_dup_proc_bilateral_w := Obter_param_Usuario(924, 734, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_dup_proc_bilateral_w);
 
SELECT * FROM liberar_prescr_proc_abort_eup(nr_prescricao_p, nr_seq_agenda_p, cd_estabelecimento_p, cd_convenio_p, qt_prescr_proced_p, ds_consistencia_p, qt_pep_p, nr_sequencia_p, ie_agrupa_fleury_p, ds_prescr_fleury_p, ds_pr_fleury_p, ds_evento_pri_p, ds_evento_sec_p, ds_evento_ter_p, ie_autorizacao_p, nr_seq_agenda_pac_p, nr_seq_agenda_cons_p, ie_tipo_agenda_p, ds_imprimir_p, nm_usuario_p) INTO STRICT qt_prescr_proced_p, ds_consistencia_p, qt_pep_p, nr_sequencia_p, ie_agrupa_fleury_p, ds_prescr_fleury_p, ds_pr_fleury_p, ds_evento_pri_p, ds_evento_sec_p, ds_evento_ter_p, ie_autorizacao_p, nr_seq_agenda_pac_p, nr_seq_agenda_cons_p, ie_tipo_agenda_p, ds_imprimir_p;
	 
if (ie_gerar_kit_proc_lib_w = 'S') then 
	CALL Gerar_kit_procedimento(cd_estabelecimento_p, nr_prescricao_p, null, nm_usuario_p);
end if;
 
if (ie_gerar_kit_mat_lib_w = 'S') then 
	CALL Gerar_Kit_Prescricao(cd_estabelecimento_p, nr_prescricao_p, null, nm_usuario_p);
end if;
 
ds_erro_p := Liberar_prescricao(	nr_prescricao_p, nr_atendimento_p, ie_tipo_pessoa_p, cd_perfil_p, nm_usuario_p, ie_prescricao_p, ds_erro_p);
 
if (ds_erro_p IS NOT NULL AND ds_erro_p::text <> '') then 
	goto final;
end if;
 
if (ie_forma_gerar_aval_exam_w = 'S') then 
	nr_seq_avaliacao_p := Gerar_Avaliacao_Prescricao(nr_prescricao_p, nm_usuario_p, nr_seq_avaliacao_p);
end if;
 
CALL alterar_dt_entrega_prescr(nr_prescricao_p, cd_perfil_p, nm_usuario_p);
 
if (ie_dup_proc_bilateral_w = 'S') then 
	CALL duplicar_lado_procedimento(nr_prescricao_p);
end if;
 
if (ie_gerar_conv_lib_w = 'S') then 
	Gerar_autorizacao_prescr(nr_prescricao_p, nm_usuario_p);
end if;
 
if (ds_usuario_p <> '' and 
	ds_perfil_p <> '') then 
	CALL Enviar_Comunicacao_Prescr(nr_prescricao_p, ds_usuario_p, ds_perfil_p, nm_usuario_p, ds_mensagem_p);
end if;
 
<<final>> 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_prescr_proc_eup (nr_prescricao_p bigint, nr_seq_agenda_p bigint, cd_estabelecimento_p bigint, cd_convenio_p bigint, nr_atendimento_p bigint, ie_tipo_pessoa_p text, cd_perfil_p bigint, ie_prescricao_p text, ds_usuario_p text, ds_perfil_p text, ds_mensagem_p text, ds_erro_p INOUT text, qt_prescr_proced_p INOUT bigint, ds_consistencia_p INOUT text, qt_pep_p INOUT bigint, nr_sequencia_p INOUT bigint, ie_agrupa_fleury_p INOUT text, ds_prescr_fleury_p INOUT text, ds_pr_fleury_p INOUT text, ds_evento_pri_p INOUT text, ds_evento_sec_p INOUT text, ds_evento_ter_p INOUT text, ie_autorizacao_p INOUT text, nr_seq_agenda_pac_p INOUT bigint, nr_seq_agenda_cons_p INOUT bigint, ie_tipo_agenda_p INOUT text, ds_imprimir_p INOUT text, nr_seq_avaliacao_p INOUT bigint, nm_usuario_p text) FROM PUBLIC;

