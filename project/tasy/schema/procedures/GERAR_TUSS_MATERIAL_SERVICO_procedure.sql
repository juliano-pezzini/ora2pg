-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_tuss_material_servico ( dt_importacao_p timestamp, ie_terminologia_p tuss_material.ie_terminologia%type, nm_usuario_p usuario.nm_usuario%type, nr_sequencia_p INOUT bigint) AS $body$
DECLARE


nr_sequencia_mat_w		tuss_material.nr_sequencia%type;
nr_sequencia_ser_w		tuss_servico.nr_sequencia%type;
nr_sequencia_his_w		tuss_historico.nr_sequencia%type;
cd_versao_w			tuss_material.cd_versao%type;
ds_informacao_w			tuss_material.ds_informacao%type;
qt_reg_w			bigint	:= 0;
ie_proc_mat_w			varchar(1)	:= 'X';
nr_seq_tuss_material_w		tuss_historico.nr_seq_tuss_material%type;
nr_seq_tuss_medicamento_w	tuss_historico.nr_seq_tuss_medicamento%type;
nr_seq_tuss_procedimento_w	tuss_historico.nr_seq_tuss_procedimento%type;
nr_seq_tuss_servico_w		tuss_historico.nr_seq_tuss_servico%type;


BEGIN

cd_versao_w	:= substr(ie_terminologia_p||to_char(dt_importacao_p,'ddmmyy'),1,40);

if (ie_terminologia_p = '18') then
	ds_informacao_w	:= substr('TUSS Diarias Taxas Gases '||to_char(dt_importacao_p,'ddmmyy'),1,120);
	ie_proc_mat_w	:= 'P';
elsif (ie_terminologia_p = '19') then
	ds_informacao_w	:= substr('TUSS Materiais OPME '||to_char(dt_importacao_p,'ddmmyy'),1,120);
	ie_proc_mat_w	:= 'M';
elsif (ie_terminologia_p = '20') then
	ds_informacao_w	:= substr('TUSS Medicamentos '||to_char(dt_importacao_p,'ddmmyy'),1,120);
	ie_proc_mat_w	:= 'M';
elsif (ie_terminologia_p = '22') then
	ds_informacao_w	:= substr('TUSS Procedimentos '||to_char(dt_importacao_p,'ddmmyy'),1,120);
	ie_proc_mat_w	:= 'P';
elsif (ie_terminologia_p = '0') then
	ds_informacao_w	:= substr('TUSS Historicos '||to_char(dt_importacao_p,'ddmmyy'),1,120);
	ie_proc_mat_w	:= 'H';
end if;

if (coalesce(ie_proc_mat_w,'X') = 'M') then
	begin

	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_sequencia_mat_w
	from	tuss_material
	where	cd_versao = cd_versao_w;


	if (coalesce(nr_sequencia_mat_w,0) = 0) then
		begin

		select	nextval('tuss_material_seq')
		into STRICT	nr_sequencia_mat_w
		;

		insert into tuss_material(
			cd_versao,
			ds_informacao,
			dt_atualizacao,
			dt_atualizacao_nrec,
			dt_importacao,
			dt_liberacao,
			ie_terminologia,
			nm_usuario,
			nm_usuario_liberacao,
			nm_usuario_nrec,
			nr_sequencia)
		values (	cd_versao_w,
			ds_informacao_w,
			clock_timestamp(),
			clock_timestamp(),
			dt_importacao_p,
			null,
			ie_terminologia_p,
			nm_usuario_p,
			'',
			nm_usuario_p,
			nr_sequencia_mat_w);

		nr_sequencia_p := nr_sequencia_mat_w;

		end;
	else
		begin

		delete from tuss_material_item
		where	nr_seq_carga_tuss = nr_sequencia_mat_w;

		nr_sequencia_p := nr_sequencia_mat_w;

		end;
	end if;

	end;
elsif (coalesce(ie_proc_mat_w,'X') = 'P') then
	begin

	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_sequencia_ser_w
	from	tuss_servico
	where	cd_versao = cd_versao_w;

	if (coalesce(nr_sequencia_ser_w,0) = 0) then
		begin

		select	nextval('tuss_servico_seq')
		into STRICT	nr_sequencia_ser_w
		;

		insert into tuss_servico(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_versao,
			ds_informacao,
			dt_liberacao,
			nm_usuario_liberacao,
			dt_importacao,
			ie_terminologia)
		values (	nr_sequencia_ser_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_versao_w,
			ds_informacao_w,
			null,
			'',
			dt_importacao_p,
			ie_terminologia_p);

		nr_sequencia_p := nr_sequencia_ser_w;

		end;
	else
		begin

		delete from tuss_servico_item
		where	NR_SEQ_CARGA_TUSS = nr_sequencia_ser_w;

		nr_sequencia_p := nr_sequencia_ser_w;

		end;
	end if;
	end;
elsif (coalesce(ie_proc_mat_w,'X') = 'H') then
	begin

	begin
	select	nr_sequencia
	into STRICT	nr_seq_tuss_servico_w
	from	tuss_servico
	where	cd_versao = substr('18'||to_char(dt_importacao_p,'ddmmyy'),1,40)  LIMIT 1;
	exception
	when others then
		nr_seq_tuss_servico_w := 0;
	end;

	begin
	select	nr_sequencia
	into STRICT	nr_seq_tuss_procedimento_w
	from	tuss_servico
	where	cd_versao = substr('22'||to_char(dt_importacao_p,'ddmmyy'),1,40)  LIMIT 1;
	exception
	when others then
		nr_seq_tuss_procedimento_w := 0;
	end;

	begin
	select	nr_sequencia
	into STRICT	nr_seq_tuss_material_w
	from	tuss_material
	where	cd_versao = substr('19'||to_char(dt_importacao_p,'ddmmyy'),1,40)  LIMIT 1;
	exception
	when others then
		nr_seq_tuss_material_w := 0;
	end;

	begin
	select	nr_sequencia
	into STRICT	nr_seq_tuss_medicamento_w
	from	tuss_material
	where	cd_versao = substr('20'||to_char(dt_importacao_p,'ddmmyy'),1,40)  LIMIT 1;
	exception
	when others then
		nr_seq_tuss_medicamento_w := 0;
	end;

	if (coalesce(nr_seq_tuss_servico_w,0) > 0)  and (coalesce(nr_seq_tuss_procedimento_w,0) > 0)  and (coalesce(nr_seq_tuss_material_w,0) > 0)  and (coalesce(nr_seq_tuss_medicamento_w,0) > 0)  then
		begin

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_sequencia_his_w
		from 	tuss_historico
		where	nr_seq_tuss_material		= nr_seq_tuss_material_w
		and	nr_seq_tuss_medicamento		= nr_seq_tuss_medicamento_w
		and	nr_seq_tuss_procedimento	= nr_seq_tuss_procedimento_w
		and	nr_seq_tuss_servico		= nr_seq_tuss_servico_w;

		if (coalesce(nr_sequencia_his_w,0) = 0) then
			begin

			select	nextval('tuss_historico_seq')
			into STRICT	nr_sequencia_his_w
			;

			insert into tuss_historico(
				ds_versao_historico,
				dt_atualizacao,
				dt_atualizacao_nrec,
				dt_validacao,
				ie_terminologia,
				nm_usuario,
				nm_usuario_nrec,
				nm_usuario_validacao,
				nr_seq_tuss_material,
				nr_seq_tuss_medicamento,
				nr_seq_tuss_procedimento,
				nr_seq_tuss_servico,
				nr_sequencia)
			values (	ds_informacao_w,
				clock_timestamp(),
				clock_timestamp(),
				null,
				ie_terminologia_p,
				nm_usuario_p,
				nm_usuario_p,
				'',
				nr_seq_tuss_material_w,
				nr_seq_tuss_medicamento_w,
				nr_seq_tuss_procedimento_w,
				nr_seq_tuss_servico_w,
				nr_sequencia_his_w);

			nr_sequencia_p := nr_sequencia_his_w;

			end;
		else
			begin

			delete from tuss_historico_item
			where	nr_seq_historico = nr_sequencia_his_w;

			nr_sequencia_p := nr_sequencia_his_w;

			end;
		end if;


		end;
	end if;

	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_tuss_material_servico ( dt_importacao_p timestamp, ie_terminologia_p tuss_material.ie_terminologia%type, nm_usuario_p usuario.nm_usuario%type, nr_sequencia_p INOUT bigint) FROM PUBLIC;

