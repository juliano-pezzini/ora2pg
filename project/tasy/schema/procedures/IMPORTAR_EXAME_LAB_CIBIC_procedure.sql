-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE importar_exame_lab_cibic ( nr_seq_interno_p prescr_procedimento.nr_seq_interno%TYPE, nm_usuario_p exame_lab_result_item.nm_usuario%TYPE, ds_resultado_p exame_lab_result_item.ds_resultado%TYPE, qt_resultado_p exame_lab_result_item.qt_resultado%TYPE, ds_resultado_curto_p exame_lab_result_item.ds_resultado_curto%TYPE, cd_exame_integracao_p exame_laboratorio.cd_exame_integracao%TYPE, nr_prescricao_p prescr_medica.nr_prescricao%TYPE, nr_seq_prescr_proc_p prescr_procedimento.nr_sequencia%TYPE, nr_seq_exame_pai_p prescr_procedimento.nr_seq_exame%TYPE) AS $body$
DECLARE


nr_seq_resultado_w          exame_lab_resultado.nr_seq_resultado%TYPE;
dt_liberacao_w              exame_lab_resultado.dt_liberacao%TYPE;
nr_seq_prescr_w             exame_lab_result_item.nr_seq_prescr%TYPE;
nr_seq_resultado_item_w     exame_lab_result_item.nr_sequencia%TYPE;
nr_seq_exame_w              exame_laboratorio.nr_seq_exame%TYPE;
nr_prescricao_w             prescr_medica.nr_prescricao%TYPE;
cd_pessoa_fisica_w          pessoa_fisica.cd_pessoa_fisica%TYPE;
nr_atendimento_w            prescr_medica.nr_atendimento%TYPE;
cd_medico_w                 prescr_medica.cd_medico%TYPE;
ds_instituicao_resultado_w  exame_lab_resultado.ds_instituicao_resultado%TYPE;
ie_status_aprovacao_res_w   prescr_procedimento.ie_status_atend%TYPE := 30;
nr_seq_interno_w	    prescr_procedimento.nr_seq_interno%type;
nr_seq_exame_atual_w	bigint;
nr_seq_superior_w	bigint;
ds_erro_w		varchar(4000);


c01 CURSOR FOR
    SELECT el.nr_seq_exame, el.nr_seq_superior
    from exame_laboratorio el
    where coalesce(el.cd_exame_integracao, el.cd_exame) = cd_exame_integracao_p
    order by el.nr_seq_exame;

BEGIN


select coalesce(max(IE_STATUS_RECEB),30)
into STRICT 	ie_status_aprovacao_res_w
from	LAB_PARAMETRO
where 	cd_estabelecimento = coalesce(wheb_usuario_pck.get_cd_estabelecimento,0);

for r_c01 in c01 loop
	begin

	nr_seq_exame_atual_w	:= r_c01.nr_seq_exame;
	nr_seq_superior_w	:= r_c01.nr_seq_superior;

	select  max(coalesce(nr_seq_interno, null))
	into STRICT	nr_seq_interno_w
	from	prescr_procedimento
	where	nr_prescricao = nr_prescricao_p
	and	    nr_seq_exame = nr_seq_exame_atual_w
   	and 	nr_sequencia = nr_seq_prescr_proc_p;

	if (coalesce(nr_seq_interno_w::text, '') = '') then

		select	max(coalesce(nr_seq_interno, null))
		into STRICT	nr_seq_interno_w
		from	prescr_procedimento
		where	nr_prescricao = nr_prescricao_p
		  and	nr_seq_exame = nr_seq_superior_w
		  and   nr_sequencia = nr_seq_prescr_proc_p;

		  if (coalesce(nr_seq_interno_w::text, '') = '') then

			select	max(coalesce(nr_seq_interno, null))
			into STRICT	nr_seq_interno_w
			from	prescr_procedimento
			where	nr_prescricao = nr_prescricao_p
			and	    nr_seq_exame = nr_seq_superior_w
			and     nr_sequencia = nr_seq_prescr_proc_p;

		end if;
	end if;

	if (nr_seq_interno_w IS NOT NULL AND nr_seq_interno_w::text <> '') then
		nr_seq_exame_w	:= nr_seq_exame_atual_w;
		exit;
	end if;

	end;
end loop;

if (nr_seq_interno_w IS NOT NULL AND nr_seq_interno_w::text <> '') then

	SELECT  a.nr_prescricao,
		b.nr_sequencia,
		a.cd_pessoa_fisica,
		a.nr_atendimento,
		a.cd_medico,
		substr(obter_dados_lote_externo(b.nr_seq_lote_externo, 2), 1, 80) ds_entidade
	INTO STRICT    nr_prescricao_w,
		nr_seq_prescr_w,
		cd_pessoa_fisica_w,
		nr_atendimento_w,
		cd_medico_w,
		ds_instituicao_resultado_w
	FROM    prescr_medica a,
		prescr_procedimento b
	WHERE   a.nr_prescricao = b.nr_prescricao
	AND     b.nr_seq_interno = nr_seq_interno_w
	AND 	b.nr_sequencia = nr_seq_prescr_proc_p;

    SELECT  MAX(a.nr_seq_resultado),
            MAX(a.dt_liberacao)
    INTO STRICT    nr_seq_resultado_w,
            dt_liberacao_w
    FROM    exame_lab_resultado a
    WHERE   a.nr_prescricao = nr_prescricao_w;

    if (dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '') THEN
        CALL wheb_mensagem_pck.exibir_mensagem_abort(1206221);
    end if;

    	ds_erro_p 		=> ds_erro_w := atualizar_lab_result_item(	nr_prescricao_p		=> nr_prescricao_p, nr_seq_prescr_p 	=> nr_seq_prescr_w, cd_exame_p 		=> cd_exame_integracao_p, qt_resultado_p 		=> qt_resultado_p, pr_resultado_p 		=> null, ds_resultado_p 		=> coalesce(ds_resultado_p,ds_resultado_curto_p), ds_observacao_p 	=> null, cd_material_exame_p 	=> null, ie_reenvio_p 		=> null, nm_usuario_p 		=> nm_usuario_p, dt_coleta_p 		=> null, ds_referencia_p 	=> null, ds_unidade_medida_p 	=> null, nr_doc_lab_p 		=> null, dt_resultado_p 		=> clock_timestamp(), ds_erro_p 		=> ds_erro_w, nr_seq_exame_atualiz_p 	=> null, cd_metodo_p 		=> null, qt_minima_p 		=> null, qt_maxima_p 		=> null, pr_minimo_p 		=> null, pr_maximo_p 		=> null, ds_flag_p 		=> null, cd_comment_ext_p 	=> null);


    UPDATE  prescr_procedimento a
    SET     a.ie_status_atend = ie_status_aprovacao_res_w
    WHERE   a.nr_prescricao = nr_prescricao_w
    AND     a.nr_sequencia = nr_seq_prescr_w;

    SELECT
        MAX(nr_seq_resultado)
    INTO STRICT nr_seq_resultado_w
    FROM
        exame_lab_resultado
    WHERE
        nr_prescricao = nr_prescricao_w;

    CALL atualizar_aprovacao_exame(nr_prescricao_w, nr_seq_prescr_w, nr_seq_resultado_w, NULL, nm_usuario_p);

    COMMIT;
  end if;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importar_exame_lab_cibic ( nr_seq_interno_p prescr_procedimento.nr_seq_interno%TYPE, nm_usuario_p exame_lab_result_item.nm_usuario%TYPE, ds_resultado_p exame_lab_result_item.ds_resultado%TYPE, qt_resultado_p exame_lab_result_item.qt_resultado%TYPE, ds_resultado_curto_p exame_lab_result_item.ds_resultado_curto%TYPE, cd_exame_integracao_p exame_laboratorio.cd_exame_integracao%TYPE, nr_prescricao_p prescr_medica.nr_prescricao%TYPE, nr_seq_prescr_proc_p prescr_procedimento.nr_sequencia%TYPE, nr_seq_exame_pai_p prescr_procedimento.nr_seq_exame%TYPE) FROM PUBLIC;

