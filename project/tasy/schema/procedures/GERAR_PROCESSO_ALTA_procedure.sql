-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_processo_alta ( nr_atendimento_p bigint, cd_processo_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_etapas_w					integer;
nr_sequencia_w				bigint;
ie_responsavel_w				varchar(3);
nr_minutos_prev_w				double precision;
cd_setor_resp_w				integer;
cd_pessoa_fisica_resp_w			varchar(10);
cd_cgc_resp_w				varchar(14);
nm_usuario_resp_w				varchar(15);
dt_fim_prev_w				timestamp;
dt_fim_conta_w				timestamp;
cd_convenio_w				integer;
count_w						bigint;

C000 CURSOR FOR
	SELECT 	nr_sequencia,
			ie_responsavel,
			nr_minutos_prev,
			cd_setor_resp,
			cd_pessoa_fisica_resp,
			cd_cgc_resp,
			nm_usuario_resp
	from Processo_etapa
	where cd_processo = cd_processo_p
	and coalesce(cd_convenio,cd_convenio_w) = cd_convenio_w;


BEGIN

begin
	select count(*)
	into STRICT nr_etapas_w
	from processo_atendimento
	where nr_atendimento = nr_atendimento_p
	  and cd_processo	   = cd_processo_p;

	exception
		when others then
			nr_etapas_w := 0;
end;

select dt_fim_conta,
	coalesce(OBTER_CONVENIO_ATENDIMENTO(NR_ATENDIMENTO),0)
into STRICT 	dt_fim_conta_w,
	cd_convenio_w
from atendimento_paciente
where nr_atendimento = nr_atendimento_p;



if (nr_etapas_w = 0) and (coalesce(dt_fim_conta_w::text, '') = '') then
	begin
	OPEN C000;
	LOOP
	FETCH C000 INTO
		 	nr_sequencia_w,
			ie_responsavel_w,
			nr_minutos_prev_w,
			cd_setor_resp_w,
			cd_pessoa_fisica_resp_w,
			cd_cgc_resp_w,
			nm_usuario_resp_w;
	EXIT WHEN NOT FOUND; /* apply on c000 */
		begin
---------------------	Usuário
		if (ie_responsavel_w = '2') then
			nm_usuario_resp_w	:= nm_usuario_p;
		end if;
---------------------	Médico
		if (ie_responsavel_w = '3') then
			select cd_medico_resp
			into STRICT cd_pessoa_fisica_resp_w
			from atendimento_paciente
			where nr_atendimento = nr_atendimento_p;
		end if;
---------------------	Paciente
		if (ie_responsavel_w = '4') then
			select cd_pessoa_fisica
			into STRICT cd_pessoa_fisica_resp_w
			from atendimento_paciente
			where nr_atendimento = nr_atendimento_p;
		end if;
---------------------	Setor de Atendimento
		if (ie_responsavel_w = '5') then
			begin
			select cd_setor_atendimento
			into STRICT cd_setor_resp_w
			from  paciente_internado_v
			where nr_atendimento		= nr_atendimento_p;
			exception
				when others then
					cd_setor_resp_w := null;
			end;
		end if;

		dt_fim_prev_w := clock_timestamp() + (coalesce(nr_minutos_prev_w,0)	/ 1440);

		select	count(*)
		into STRICT	count_w
		from	Processo_atendimento
		where	NR_ATENDIMENTO 	= nr_atendimento_p
		and		CD_PROCESSO		= cd_processo_p
		and		NR_SEQUENCIA	= nr_sequencia_w;

		if (count_w = 0) then
			insert into Processo_atendimento(NR_ATENDIMENTO,
				CD_PROCESSO    ,
				NR_SEQUENCIA   ,
				IE_STATUS      ,
				NR_MIN_PREV    ,
				DT_FIM_PREV    ,
				DT_ATUALIZACAO ,
				NM_USUARIO     ,
				NM_USUARIO_RESP,
				CD_SETOR_RESP)
			Values (nr_atendimento_p,
				cd_processo_p,
				nr_sequencia_w,
				'P',
				nr_minutos_prev_w,
				dt_fim_prev_w,
				clock_timestamp(),
				nm_usuario_p,
				nm_usuario_resp_w,
				cd_setor_resp_w);
		end if;
		end;
	END LOOP;
	CLOSE C000;

	update atendimento_paciente
	set ie_fim_conta = 'P'
	where nr_atendimento = nr_atendimento_p;

	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
	end;
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_processo_alta ( nr_atendimento_p bigint, cd_processo_p bigint, nm_usuario_p text) FROM PUBLIC;

