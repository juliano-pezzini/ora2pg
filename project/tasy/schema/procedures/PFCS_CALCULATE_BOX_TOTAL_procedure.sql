-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pfcs_calculate_box_total ( nr_seq_indicator_p bigint, cd_estabelecimento_p text, nm_usuario_p text) AS $body$
DECLARE

	c01 CURSOR FOR
		SELECT	x.nr_sequencia cd_group_pa,
			x.ds_grupo ds_group_pa,
			y.nr_sequencia cd_unit_pa,
			y.ds_local ds_unit_pa
		from	pa_grupo_local x,
			pa_local y
		where	x.ie_situacao = 'A'
		and	y.nr_seq_grupo_pa = x.nr_sequencia
		and	y.ie_situacao = 'A'
		and 	x.cd_estabelecimento = (cd_estabelecimento_p)::numeric 
		
union
 
		SELECT 	0 cd_group_pa,
			obter_desc_expressao(344145,null) ds_group_pa,
			nr_sequencia cd_unit_pa,
			ds_local ds_unit_pa
		from 	pa_local
		where 	ie_situacao = 'A'
		and 	coalesce(nr_seq_grupo_pa::text, '') = ''
		and 	cd_estabelecimento = (cd_estabelecimento_p)::numeric;

	c02 CURSOR(cd_unit_pa_p bigint) FOR
	SELECT	
		z.cd_pessoa_fisica id_patient,
		coalesce(get_formatted_person_name(z.cd_pessoa_fisica, 'list'), obter_nome_pf(z.cd_pessoa_fisica)) nm_patient,
		pfcs_obter_lista_dados_classif(z.cd_pessoa_fisica) ds_classification,
		obter_sexo_pf(z.cd_pessoa_fisica, 'D') ds_gender,
		z.dt_nascimento dt_birthdate,
        obter_dados_pf(z.cd_pessoa_fisica, 'I') qt_idade_paciente,
		z.dt_entrada dt_entrance,
		z.nr_atendimento nr_encounter
	from    pa_local y,
		    pep_atendimento_ps_v z
	where   y.nr_sequencia = cd_unit_pa_p
	and	    y.nr_sequencia = z.nr_seq_local_pa
	and     y.ie_situacao = 'A'
	and	    y.cd_estabelecimento = (cd_estabelecimento_p)::numeric 
	and	    get_if_encounter_still_pa(z.nr_atendimento) = 'S'
	and 	coalesce(z.dt_alta::text, '') = '';

	qt_total_w				bigint := 0;
	pfcs_panel_detail_seq_w			pfcs_panel_detail.nr_sequencia%type;
	nr_seq_operational_level_w		pfcs_operational_level.nr_sequencia%type;
	nr_seq_panel_w				pfcs_panel.nr_sequencia%type;
	qt_patients_w				bigint;

	
BEGIN

	nr_seq_operational_level_w := pfcs_get_structure_level(
		cd_establishment_p => cd_estabelecimento_p,
		ie_level_p => 'O',
		ie_info_p => 'C');

	select count(*)
		into STRICT qt_total_w
		from pa_local y
		where y.ie_situacao = 'A'
        and ((coalesce(y.nr_seq_grupo_pa::text, '') = '')
                or (y.nr_seq_grupo_pa in (SELECT nr_sequencia from pa_grupo_local x where x.ie_situacao = 'A'))) 
		and	y.cd_estabelecimento = (cd_estabelecimento_p)::numeric;

	for c01_w in c01 loop

      begin

        select	nextval('pfcs_panel_detail_seq')
        into STRICT	pfcs_panel_detail_seq_w
;

        insert into pfcs_panel_detail(
          nr_sequencia,
          nm_usuario,
          dt_atualizacao,
          nm_usuario_nrec,
          dt_atualizacao_nrec,
          ie_situation,
          nr_seq_indicator,
          nr_seq_operational_level)
        values (
          pfcs_panel_detail_seq_w,
          nm_usuario_p,
          clock_timestamp(),
          nm_usuario_p,
          clock_timestamp(),
          'T',
          nr_seq_indicator_p,
          nr_seq_operational_level_w);

		qt_patients_w := 0;
		for c02_w in c02(c01_w.cd_unit_pa) loop
			begin

			if (qt_patients_w > 0) then

				select	nextval('pfcs_panel_detail_seq')
				into STRICT	pfcs_panel_detail_seq_w
				;

				insert into pfcs_panel_detail(
					nr_sequencia,
					nm_usuario,
					dt_atualizacao,
					nm_usuario_nrec,
					dt_atualizacao_nrec,
					ie_situation,
					nr_seq_indicator,
					nr_seq_operational_level)
				values (pfcs_panel_detail_seq_w,
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					'T',
					nr_seq_indicator_p,
					nr_seq_operational_level_w);
			end if;

			qt_patients_w := qt_patients_w + 1;

			insert into pfcs_detail_patient(
				nr_sequencia,
				nm_usuario,
				dt_atualizacao,
				nm_usuario_nrec,
				dt_atualizacao_nrec,
				nr_seq_detail,
				nr_encounter,
				dt_entrance,
				id_patient,
				nm_patient,
				ds_gender,
				ds_classification,
				dt_birthdate,
                ds_age_range,
				cd_group_pa,
				ds_group_pa,
				ds_unit_pa)
			values (nextval('pfcs_detail_patient_seq'),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				pfcs_panel_detail_seq_w,
				c02_w.nr_encounter,
				c02_w.dt_entrance,
				c02_w.id_patient,
				c02_w.nm_patient,
				c02_w.ds_gender,
				c02_w.ds_classification,
				c02_w.dt_birthdate,
                c02_w.qt_idade_paciente,
				c01_w.cd_group_pa,
				c01_w.ds_group_pa,
				c01_w.ds_unit_pa);

			end;
		end loop;

		if (qt_patients_w = 0) then

			insert into pfcs_detail_patient(
				nr_sequencia,
				nm_usuario,
				dt_atualizacao,
				nm_usuario_nrec,
				dt_atualizacao_nrec,
				nr_seq_detail,
				nr_encounter,
				dt_entrance,
				id_patient,
				nm_patient,
				ds_gender,
				ds_classification,
				dt_birthdate,
                ds_age_range,
				cd_group_pa,
				ds_group_pa,
				ds_unit_pa)
			values (nextval('pfcs_detail_patient_seq'),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				pfcs_panel_detail_seq_w,
				null,
				null,
				null,
				null,
				null,
                null,
				null,
				null,
				c01_w.cd_group_pa,
				c01_w.ds_group_pa,
				c01_w.ds_unit_pa);

		end if;
      end;

    end loop;

    commit;

     := pfcs_pck.pfcs_generate_results(
      vl_indicator_p => qt_total_w, ds_reference_value_p => null, nr_seq_indicator_p => nr_seq_indicator_p, nr_seq_operational_level_p => nr_seq_operational_level_w, nm_usuario_p => nm_usuario_p, nr_seq_panel_p => nr_seq_panel_w);

    CALL pfcs_pck.pfcs_update_detail(
        nr_seq_indicator_p => nr_seq_indicator_p,
        nr_seq_panel_p => nr_seq_panel_w,
        nr_seq_operational_level_p => nr_seq_operational_level_w,
        nm_usuario_p => nm_usuario_p);

    CALL pfcs_pck.pfcs_activate_records(
            nr_seq_indicator_p => nr_seq_indicator_p,
            nr_seq_operational_level_p => nr_seq_operational_level_w,
            nm_usuario_p => nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_calculate_box_total ( nr_seq_indicator_p bigint, cd_estabelecimento_p text, nm_usuario_p text) FROM PUBLIC;

