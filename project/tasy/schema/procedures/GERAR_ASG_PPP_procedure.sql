-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_asg_ppp ((nr_sequencia_p bigint, nm_usuario_p text) is nr_atendimento_w bigint) RETURNS varchar AS $body$
DECLARE


	ie_retorno_w	varchar(15);
	nr_seq_result_escala_w	varchar(15);
	
BEGIN
	
	select	max(f.nr_seq_result_escala)
	into STRICT	nr_seq_result_escala_w
	from	pe_prescricao a,
		pe_prescr_item_result b,
		pe_regra_item_escala c,
		pe_regra_result_escala f
	where	a.nr_sequencia = nr_sequencia_p
	and	a.nr_sequencia = b.nr_seq_prescr
	and	b.nr_seq_item = c.nr_seq_item_sae
	and	c.nr_seq_item_escala = nr_seq_item_escala_p
	and	f.nr_seq_result_sae = b.nr_seq_result
	and	f.nr_seq_regra = c.nr_sequencia;
	
	select 	max(x.vl_result)
	into STRICT	ie_retorno_w
	from	pe_result_item x,
		pe_regra_result_escala f
	where	x.nr_sequencia = nr_seq_result_escala_w;
	
	return ie_retorno_w;
	end;
	
	function obter_descricao_asg_pp( nr_seq_item_escala_p	number) return varchar2 is

	ds_observacao_w	varchar2(80);
	nr_seq_result_escala_w	varchar2(15);
	begin
	
	select	max(b.ds_observacao)
	into STRICT	ds_observacao_w
	from	pe_prescricao a,
		pe_prescr_item_result b,
		pe_regra_item_escala c,
		pe_regra_result_escala f
	where	a.nr_sequencia = nr_sequencia_p
	and	a.nr_sequencia = b.nr_seq_prescr
	and	b.nr_seq_item = c.nr_seq_item_sae
	and	c.nr_seq_item_escala = nr_seq_item_escala_p
	and	f.nr_seq_result_sae = b.nr_seq_result
	and	f.nr_seq_regra = c.nr_sequencia;
	
	return ds_observacao_w;
	end;

begin

select	max(a.cd_prescritor),
	max(a.nr_atendimento)
into STRICT	cd_profissional_w,
	nr_atendimento_w
from	pe_prescricao a,
	pe_prescr_item_result b
where	a.nr_sequencia = b.nr_seq_prescr
and	a.nr_sequencia = nr_sequencia_p;

select	coalesce(max('S'),'N')
into STRICT	ie_possui_registro_w
from 	pe_prescricao a,
	pe_prescr_item_result b,
	pe_regra_item_escala c,
	pe_regra_result_escala d
where	a.nr_sequencia	= b.nr_seq_prescr
and	b.nr_seq_result = d.nr_seq_result_sae
and	b.nr_seq_item	= c.nr_seq_item_sae
and	a.nr_sequencia	= nr_sequencia_p
and	(c.nr_seq_item_escala IS NOT NULL AND c.nr_seq_item_escala::text <> '')
and 	c.ie_escala = 102;

if (ie_possui_registro_w = 'S') then
	begin
	qt_peso_sae_w := obter_descricao_asg_pp(183);
	qt_altura_sae_w := obter_descricao_asg_pp(184);
	qt_peso_mes_w := obter_descricao_asg_pp(179);
	qt_peso_6_mes_w := obter_descricao_asg_pp(180);
	ie_aumento_peso_w := obter_valor_escala(121);
	ie_peso_mes_ant_w := obter_valor_escala(125);
	ie_peso_6_meses_w := obter_valor_escala(127);
	ie_ingestao_mes_w := obter_valor_escala(128);
	ie_comida_normal_menor_w := obter_valor_escala(129);
	ie_comida_normal_pouca_w := obter_valor_escala(130);
	ie_apenas_liquido_w := obter_valor_escala(131);
	ie_apenas_suplemento_w := obter_valor_escala(132);
	ie_pouca_comida_w := obter_valor_escala(133);
	ie_alimento_sonda_w := obter_valor_escala(134);
	ie_sem_problema_alimentar_w := obter_valor_escala(135);
	ie_sem_apetite_w := obter_valor_escala(136);
	ie_nausea_w := obter_valor_escala(137);
	ie_vomito_w := obter_valor_escala(138);
	ie_constipacao_w := obter_valor_escala(139);
	ie_diarreia_w := obter_valor_escala(140);
	ie_ferida_boca_w := obter_valor_escala(141);
	ie_boca_seca_w := obter_valor_escala(142);
	ie_alimento_sem_gosto_w := obter_valor_escala(143);
	ie_cheiro_enjoam_w := obter_valor_escala(144);
	ie_problema_engolir_w := obter_valor_escala(145);
	ie_rapidamente_sat_w := obter_valor_escala(146);
	ie_dor_w := obter_valor_escala(147);
	ds_dor_w := obter_descricao_asg_pp(147);
	ie_outros_w := obter_valor_escala(148);
	ds_outros_sintomas_w := obter_descricao_asg_pp(148);
	ie_atividade_w := obter_valor_escala(150);
	ie_cancer_w := obter_valor_escala(151);
	ie_aids_w := obter_valor_escala(152);
	ie_caqueixa_w := obter_valor_escala(153);
	ie_ulcera_w := obter_valor_escala(154);
	ie_trauma_w := obter_valor_escala(156);
	ie_idade_65_w := obter_valor_escala(157);
	ie_febre_w := obter_valor_escala(158);
	ie_duracao_febre_w := obter_valor_escala(159);
	ie_corticosteroides_w := obter_valor_escala(160);
	ie_reg_peri_orbital_w := obter_valor_escala(161);
	ie_prega_triceps_w := obter_valor_escala(162);
	ie_gordura_costela_w := obter_valor_escala(163);
	ie_geral_def_gordura_w := obter_valor_escala(164);
	ie_temporas_w := obter_valor_escala(165);
	ie_claviculas_w := obter_valor_escala(166);
	ie_ombros_w := obter_valor_escala(167);
	ie_musc_intra_ossea_w := obter_valor_escala(168);
	ie_escapula_w := obter_valor_escala(169);
	ie_coxa_w := obter_valor_escala(170);
	ie_panturrilha_w := obter_valor_escala(171);
	ie_geral_def_musc_w := obter_valor_escala(172);
	ie_edema_tornozelo_w := obter_valor_escala(173);
	ie_edema_sacral_w := obter_valor_escala(174);
	ie_ascite_w := obter_valor_escala(175);
	ie_geral_est_hidratacao_w := obter_valor_escala(176);
	ie_avaliacao_global_w := obter_valor_escala(177);
	ds_observacoes_w := obter_descricao_asg_pp(178);
	end;	
	
	select a.qt_peso,
		a.qt_altura_cm
	into STRICT    qt_peso_sinal_w,
		qt_altura_sinal_cm_w
	from atendimento_sinal_vital a
	where a.nr_sequencia = (SELECT max(b.nr_sequencia)
					  from atendimento_sinal_vital b
					  where b.nr_atendimento = nr_atendimento_w
					  and (b.qt_peso IS NOT NULL AND b.qt_peso::text <> '')
					  and (b.qt_altura_cm IS NOT NULL AND b.qt_altura_cm::text <> '')
					  and (b.qt_imc IS NOT NULL AND b.qt_imc::text <> ''))
	order by dt_sinal_vital desc;
	
	if (coalesce(qt_peso_sae_w::text, '') = '') then
	qt_peso_w := qt_peso_sinal_w;
	else
	qt_peso_w := qt_peso_sae_w;
	end if;

	if (coalesce(qt_altura_sae_w::text, '') = '') then
	qt_altura_cm_w := qt_altura_sinal_cm_w;
	else
	qt_altura_cm_w := qt_altura_sae_w;
	end if;
	
	insert into escala_asg_ppp(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				cd_profissional,
				nr_atendimento,
				dt_avaliacao,
				ie_situacao,
				qt_peso_atual,
				qt_altura_cm,
				qt_peso_mes,
				qt_peso_6_mes,
				ie_aumento_peso,
				ie_peso_mes_ant,
				ie_peso_6_meses,
				ie_ingestao_mes,
				ie_comida_normal_menor,
				ie_comida_normal_pouca,
				ie_apenas_liquido,
				ie_apenas_suplemento,
				ie_pouca_comida,
				ie_alimento_sonda,
				ie_sem_problema_alimentar,
				ie_sem_apetite,
				ie_nausea,
				ie_vomito,
				ie_constipacao,
				ie_diarreia,
				ie_ferida_boca,
				ie_boca_seca,
				ie_alimento_sem_gosto,
				ie_cheiro_enjoam,
				ie_problema_engolir,
				ie_rapidamente_sat,
				ie_dor,
				ds_dor,
				ie_outros,
				ds_outros_sintomas,
				ie_atividade,
				ie_cancer,
				ie_aids,
				ie_caqueixa,
				ie_ulcera,
				ie_trauma,
				ie_idade_65,
				ie_febre,
				ie_duracao_febre,
				ie_corticosteroides,
				ie_reg_peri_orbital,
				ie_prega_triceps,
				ie_gordura_costela,
				ie_geral_def_gordura,
				ie_temporas,
				ie_claviculas,
				ie_ombros,
				ie_musc_intra_ossea,
				ie_escapula,
				ie_coxa,
				ie_panturrilha,
				ie_geral_def_musc,
				ie_edema_tornozelo,
				ie_edema_sacral,
				ie_ascite,
				ie_geral_est_hidratacao,
				ie_avaliacao_global,
				ds_observacao,
				dt_liberacao)
	values (nextval('escala_asg_ppp_seq'),
				clock_timestamp(),
				nm_usuario_p,
				cd_profissional_w,
				nr_atendimento_w,
				clock_timestamp(),
				'A',
				somente_numero_virg_char(coalesce(qt_peso_w,0)),
				somente_numero_virg_char(coalesce(qt_altura_cm_w,0)),
				somente_numero_virg_char(qt_peso_mes_w),
				somente_numero_virg_char(qt_peso_6_mes_w),
				coalesce(ie_aumento_peso_w,'A'),
				coalesce(ie_peso_mes_ant_w,0),
				coalesce(ie_peso_6_meses_w,0),
				coalesce(ie_ingestao_mes_w,'S'),
				coalesce(ie_comida_normal_menor_w,'N'),
				coalesce(ie_comida_normal_pouca_w,'N'),
				coalesce(ie_apenas_liquido_w,'N'),
				coalesce(ie_apenas_suplemento_w,'N'),
				coalesce(ie_pouca_comida_w,'N'),
				coalesce(ie_alimento_sonda_w,'N'),
				coalesce(ie_sem_problema_alimentar_w,'N'),
				coalesce(ie_sem_apetite_w,'N'),
				coalesce(ie_nausea_w,'N'),
				coalesce(ie_vomito_w,'N'),
				coalesce(ie_constipacao_w,'N'),
				coalesce(ie_diarreia_w,'N'),
				coalesce(ie_ferida_boca_w,'N'),
				coalesce(ie_boca_seca_w,'N'),
				coalesce(ie_alimento_sem_gosto_w,'N'),
				coalesce(ie_cheiro_enjoam_w,'N'),
				coalesce(ie_problema_engolir_w,'N'),
				coalesce(ie_rapidamente_sat_w,'N'),
				coalesce(ie_dor_w,'N'),
				ds_dor_w,
				coalesce(ie_outros_w,'N'),
				ds_outros_sintomas_w,
				coalesce(ie_atividade_w,'N'),
				coalesce(ie_cancer_w,'N'),
				coalesce(ie_aids_w,'N'),
				coalesce(ie_caqueixa_w,'N'),
				coalesce(ie_ulcera_w,'N'),
				coalesce(ie_trauma_w,'N'),
				coalesce(ie_idade_65_w,'N'),
				coalesce(ie_febre_w,0),
				coalesce(ie_duracao_febre_w,0),
				coalesce(ie_corticosteroides_w,0),
				coalesce(ie_reg_peri_orbital_w,0),
				coalesce(ie_prega_triceps_w,0),
				coalesce(ie_gordura_costela_w,0),
				coalesce(ie_geral_def_gordura_w,0),
				coalesce(ie_temporas_w,0),
				coalesce(ie_claviculas_w,0),
				coalesce(ie_ombros_w,0),
				coalesce(ie_musc_intra_ossea_w,0),
				coalesce(ie_escapula_w,0),
				coalesce(ie_coxa_w,0),
				coalesce(ie_panturrilha_w,0),
				coalesce(ie_geral_def_musc_w,0),
				coalesce(ie_edema_tornozelo_w,0),
				coalesce(ie_edema_sacral_w,0),
				coalesce(ie_ascite_w,0),
				coalesce(ie_geral_est_hidratacao_w,0),
				ie_avaliacao_global_w,
				ds_observacoes_w,
				clock_timestamp());	
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_asg_ppp ((nr_sequencia_p bigint, nm_usuario_p text) is nr_atendimento_w bigint) FROM PUBLIC;

