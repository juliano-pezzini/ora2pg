-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_execucao_aud_manual ( nr_seq_execucao_p bigint, nr_seq_ocorrencia_p bigint, ie_tipo_p text, ds_historico_p text, nm_usuario_p text) AS $body$
DECLARE

				 
/* 
ie_tipo_p 
 A - quando existe na execucao ocorrências que foram geradas para a mesma 
 M - quando não existe na execução ocorrências geradas 
 
*/
 
				 
nr_seq_auditoria_w		bigint := 0;
nr_seq_grupo_w			bigint;
nr_seq_fluxo_w			bigint;
qt_grupo_w			integer;
nr_seq_requisicao_w		bigint;

C01 CURSOR FOR 
	SELECT 	nr_seq_grupo, 
		nr_seq_fluxo 
	from	pls_ocorrencia_grupo 
	where	nr_seq_ocorrencia	= nr_seq_ocorrencia_p 
	and	ie_requisicao		= 'S';	
				 

BEGIN 
 
CALL pls_gerar_auditoria_execucao(nr_seq_execucao_p,nm_usuario_p,ie_tipo_p);
 
begin 
	select	nr_sequencia 
	into STRICT	nr_seq_auditoria_w 
	from	pls_auditoria 
	where	nr_seq_execucao = nr_seq_execucao_p 
	and	coalesce(dt_liberacao::text, '') = '';
exception 
when others then 
	nr_seq_auditoria_w := 0;
end;
 
if (nr_seq_auditoria_w > 0) then 
	if (coalesce(ie_tipo_p,'A') = 'M') then 
		open C01;
		loop 
		fetch C01 into	 
			nr_seq_grupo_w, 
			nr_seq_fluxo_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin 
			select	count(*) 
			into STRICT	qt_grupo_w 
			from	pls_auditoria_grupo 
			where	nr_seq_auditoria 	= nr_seq_auditoria_w 
			and	nr_seq_grupo 		= nr_seq_grupo_w;
			 
			if (qt_grupo_w = 0) then 
				insert into pls_auditoria_grupo(nr_sequencia, nr_seq_auditoria, nr_seq_grupo, 
					dt_atualizacao, nm_usuario, dt_atualizacao_nrec, 
					nm_usuario_nrec, nr_seq_ordem, ie_status, 
					ie_manual) 
				values (nextval('pls_auditoria_grupo_seq'), nr_seq_auditoria_w, nr_seq_grupo_w, 
					clock_timestamp(), nm_usuario_p, clock_timestamp(), 
					nm_usuario_p, nr_seq_fluxo_w, 'U', 
					'N');
			end if;
			end;
		end loop;
		close C01;
	end if;	
	 
	 
	select	max(nr_seq_requisicao) 
	into STRICT	nr_seq_requisicao_w 
	from	pls_execucao_requisicao 
	where	nr_sequencia = nr_seq_execucao_p;
	 
	insert into pls_requisicao_historico(nr_sequencia, nr_seq_requisicao, ie_tipo_historico, 
		ds_historico, dt_atualizacao, nm_usuario, 
		dt_atualizacao_nrec, nm_usuario_nrec, dt_historico, 
		ie_origem_historico, nr_seq_execucao)    
	values (nextval('pls_requisicao_historico_seq'), nr_seq_requisicao_w, 'L', 
		'O usuário '||obter_nome_usuario(nm_usuario_p)||' enviou a execução para análise.'||chr(13)||chr(13)|| 
		ds_historico_p, clock_timestamp(), nm_usuario_p, 
		clock_timestamp(), nm_usuario_p, clock_timestamp(), 
		'A', nr_seq_execucao_p);
end if;
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_execucao_aud_manual ( nr_seq_execucao_p bigint, nr_seq_ocorrencia_p bigint, ie_tipo_p text, ds_historico_p text, nm_usuario_p text) FROM PUBLIC;

