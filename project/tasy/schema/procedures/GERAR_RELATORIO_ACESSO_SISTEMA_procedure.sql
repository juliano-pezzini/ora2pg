-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_relatorio_acesso_sistema ( dt_inicio_p timestamp, dt_fim_p timestamp) AS $body$
DECLARE


qt_tasy_w		bigint;
qt_tasymed_w		bigint;
qt_tasy_ops_w		bigint;
qt_tasy_prestador_w	bigint;
qt_outros_w		bigint;
dt_acesso_w		timestamp;

C01 CURSOR FOR
SELECT	distinct trunc(dt_acesso)
from	tasy_log_acesso
where	dt_acesso between trunc(dt_inicio_p) and fim_dia(dt_fim_p);


BEGIN

qt_tasy_w := null;


delete from w_acesso_sistema;
commit;

Open C01;
Loop
	Fetch C01 into	dt_acesso_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */

	Select	count(*)
	into STRICT	qt_tasy_w
	from	tasy_log_acesso
	where	dt_acesso between trunc(dt_acesso_w) and fim_dia(dt_acesso_w)
	and	cd_aplicacao_tasy = 'Tasy';

	Select	count(*)
	into STRICT	qt_tasymed_w
	from	tasy_log_acesso
	where	dt_acesso between trunc(dt_acesso_w) and fim_dia(dt_acesso_w)
	and	cd_aplicacao_tasy = 'TasyMed';

	Select	count(*)
	into STRICT	qt_outros_w
	from	tasy_log_acesso
	where	dt_acesso between trunc(dt_acesso_w) and fim_dia(dt_acesso_w)
	and	cd_aplicacao_tasy <> 'Tasy'
	and	cd_aplicacao_tasy <> 'TasyMed';

	Select	count(*)
	into STRICT	qt_tasy_ops_w
	from	funcao f,
		log_acesso_funcao b,
		tasy_log_acesso t
	where	t.nr_sequencia = b.nr_seq_acesso
	and	t.cd_aplicacao_tasy = 'Tasy'
	and	b.cd_funcao = f.cd_funcao
	and	f.ds_aplicacao = 'TasyPLS'
	and	b.cd_funcao <> 1203
	and	t.dt_acesso between trunc(dt_acesso_w) and fim_dia(dt_acesso_w);

	Select	count(*)
	into STRICT	qt_tasy_prestador_w
	from	funcao f,
		log_acesso_funcao b,
		tasy_log_acesso t
	where	t.nr_sequencia = b.nr_seq_acesso
	and	t.cd_aplicacao_tasy = 'Tasy'
	and	b.cd_funcao = f.cd_funcao
	and	f.ds_aplicacao = 'TasyPLS'
	and	b.cd_funcao = 1203
	and	t.dt_acesso between trunc(dt_acesso_w) and fim_dia(dt_acesso_w);

	qt_tasy_w	:= qt_tasy_w - (qt_tasy_ops_w + qt_tasy_prestador_w);

	insert into w_acesso_sistema(	qt_tasy,
					qt_tasymed,
					qt_tasy_ops,
					qt_tasy_prestador,
					qt_outros,
					dt_acesso)
				values (	qt_tasy_w,
					qt_tasymed_w,
					qt_tasy_ops_w,
					qt_tasy_prestador_w,
					qt_outros_w,
					dt_acesso_w);

end Loop;
Close C01;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_relatorio_acesso_sistema ( dt_inicio_p timestamp, dt_fim_p timestamp) FROM PUBLIC;

