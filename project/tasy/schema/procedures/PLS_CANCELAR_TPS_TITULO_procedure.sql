-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_cancelar_tps_titulo (nr_seq_taxa_saude_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
dt_liquidacao_w			timestamp;
vl_saldo_titulo_w		double precision;
nr_titulo_w			bigint;
	
 
C01 CURSOR FOR 
	SELECT	dt_liquidacao, 
		vl_saldo_titulo, 
		nr_titulo	 
	from	titulo_pagar 
	where	nr_seq_taxa_saude = nr_seq_taxa_saude_p;
	

BEGIN 
if (nr_seq_taxa_saude_p IS NOT NULL AND nr_seq_taxa_saude_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then 
	open C01;
	loop 
	fetch C01 into	 
		dt_liquidacao_w, 
		vl_saldo_titulo_w, 
		nr_titulo_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		if (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') and (dt_liquidacao_w IS NOT NULL AND dt_liquidacao_w::text <> '') and (vl_saldo_titulo_w = 0) then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(188963,'NR_TITULO='||nr_titulo_w);
		else	 
			CALL Cancelar_Titulo_Pagar(nr_titulo_w, nm_usuario_p, clock_timestamp());
 
			update	titulo_pagar 
			set	nr_seq_taxa_saude  = NULL 
			where	nr_titulo = nr_titulo_w;
			 
			update	pls_tps 
			set	dt_geracao_titulo  = NULL 
			where	nr_sequencia = nr_seq_taxa_saude_p;
 
			commit;
		end if;
		end;
	end loop;
	close C01;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cancelar_tps_titulo (nr_seq_taxa_saude_p bigint, nm_usuario_p text) FROM PUBLIC;

