-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_prescr_proc_cir ( nr_prescricao_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, dt_entrada_unidade_p timestamp, nr_atendimento_p bigint, nr_seq_proc_interno_p bigint, nm_usuario_p text ) AS $body$
DECLARE


nr_seq_w		bigint;
dt_prescricao_w		timestamp;
qt_procedimento_w	bigint;
cd_setor_atendimento_w	integer;


BEGIN

select	count(*)
into STRICT	qt_procedimento_w
from	prescr_procedimento
where	nr_prescricao		=	nr_prescricao_p
and	cd_procedimento		=	cd_procedimento_p
and	ie_origem_proced	=	ie_origem_proced_p;

if (qt_procedimento_w = 0) and (cd_procedimento_p > 0)	and (ie_origem_proced_p > 0) and (nr_prescricao_p > 0) and (dt_entrada_unidade_p IS NOT NULL AND dt_entrada_unidade_p::text <> '') and (nr_atendimento_p > 0) then

	begin
	select	cd_setor_atendimento
	into STRICT	cd_setor_atendimento_w
	from	atend_paciente_unidade
	where	nr_atendimento		=	nr_atendimento_p
	and	dt_entrada_unidade	=	dt_entrada_unidade_p;
		exception
		when others then
			cd_setor_atendimento_w	:= null;
	end;

	select	coalesce(max(nr_sequencia), 0) + 1
	into STRICT	nr_seq_w
	from	prescr_procedimento
	where	nr_prescricao	= nr_prescricao_p;

	select	dt_prescricao
	into STRICT 	dt_prescricao_w
	from 	prescr_medica
	where 	nr_prescricao 	= nr_prescricao_p;

	insert into prescr_procedimento(
		nr_prescricao,
	      	nr_sequencia,
	      	cd_procedimento,
	      	ie_origem_proced,
	      	qt_procedimento,
	      	ie_urgencia,
	      	ie_suspenso,
	      	dt_prev_execucao,
      		ie_status_atend,
	      	dt_atualizacao,
	     	nm_usuario,
	      	ie_origem_inf,
	      	nr_seq_interno,
	      	ie_avisar_result,
	      	cd_motivo_baixa,
		cd_setor_atendimento,
		nr_seq_proc_interno)
	values (
	      	nr_prescricao_p,
      		nr_seq_w,
	      	cd_procedimento_p,
	      	ie_origem_proced_p,
	      	1, 'N', 'N',
		dt_prescricao_w,
	      	5, clock_timestamp(), nm_usuario_p,
	      	'1',
		nextval('prescr_procedimento_seq'),
	      	'N',
	      	0, cd_setor_atendimento_w,
		nr_seq_proc_interno_p);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_prescr_proc_cir ( nr_prescricao_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, dt_entrada_unidade_p timestamp, nr_atendimento_p bigint, nr_seq_proc_interno_p bigint, nm_usuario_p text ) FROM PUBLIC;

