-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_selecionar_item_contest ( nr_sequencia_p bigint, cd_item_p bigint, ds_tipo_p text, ie_opcao_p text, ie_envio_recebimento_p text, nm_usuario_p text) AS $body$
DECLARE

 
qt_glosada_w		double precision;
vl_glosado_w		pls_conta_proc.vl_unitario%type;

cd_procedimento_w	bigint;
nr_seq_material_w	bigint;
qt_glosada_mat_w	double precision;
vl_glosado_mat_w	pls_conta_mat.vl_unitario%type;

nr_seq_conta_proc_w	pls_conta_proc.nr_sequencia%type := null;
nr_seq_conta_mat_w	pls_conta_mat.nr_sequencia%type := null;
nr_seq_fatura_proc_w	pls_fatura_proc.nr_sequencia%type := null;
nr_seq_fatura_mat_w	pls_fatura_mat.nr_sequencia%type := null;
ie_novo_pos_estab_w	pls_visible_false.ie_novo_pos_estab%type;

/* ie_opcao_p 
'C' - Contestacao 
'D' - Discuss√£o */
 
					 

BEGIN 
select	coalesce(max(ie_novo_pos_estab),'N') 
into STRICT	ie_novo_pos_estab_w 
from	pls_visible_false;
 
if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') and (ie_envio_recebimento_p IS NOT NULL AND ie_envio_recebimento_p::text <> '') then 
	if (ds_tipo_p = 'Procedimentos') then 
		if (ie_envio_recebimento_p = 'E') then 
			select	a.cd_procedimento, 
				CASE WHEN a.qt_procedimento='0' THEN a.qt_procedimento_imp  ELSE a.qt_procedimento END , 
				CASE WHEN a.vl_unitario='0' THEN a.vl_unitario_imp  ELSE a.vl_unitario END , 
				a.nr_sequencia 
			into STRICT	cd_procedimento_w, 
				qt_glosada_w, 
				vl_glosado_w, 
				nr_seq_conta_proc_w 
			from	pls_conta_proc	a 
			where	a.nr_sequencia	= nr_sequencia_p;
			 
			if (ie_opcao_p = 'D') then 
				select	coalesce(a.vl_glosa,0) 
				into STRICT	vl_glosado_w 
				from	pls_conta_proc a 
				where	a.nr_sequencia		= nr_sequencia_p;
			end if;
		else 
			if (ie_novo_pos_estab_w = 'N') then 
				select	substr(pls_obter_cod_proced_conta(b.nr_seq_conta_proc,null),1,255) cd_procedimento, 
					b.qt_item, 
					coalesce(a.vl_faturado,0) + coalesce(a.vl_faturado_ndc,0) + 
						coalesce((	select	sum(p.vl_faturado) + sum(p.vl_faturado_ndc) 
							from	pls_fatura_proc p 
							where	p.nr_seq_conta_pos_estab = a.nr_seq_conta_pos_estab 
							and	p.nr_seq_fatura_conta = a.nr_seq_fatura_conta 
							and	p.ie_tipo_cobranca in ('3','4')),0), 
					a.nr_sequencia, 
					b.nr_seq_conta_proc 
				into STRICT	cd_procedimento_w, 
					qt_glosada_w, 
					vl_glosado_w, 
					nr_seq_fatura_proc_w, 
					nr_seq_conta_proc_w 
				from	pls_conta_pos_estabelecido b, 
					pls_fatura_proc a 
				where	a.nr_seq_conta_pos_estab = b.nr_sequencia 
				and	a.ie_tipo_cobranca not in ('3','4') 
				and	a.nr_sequencia	= nr_sequencia_p;
				 
			elsif (ie_novo_pos_estab_w = 'S') then 
				select	substr(pls_obter_cod_proced_conta(b.nr_seq_conta_proc,null),1,255) cd_procedimento, 
					b.qt_item, 
					coalesce(a.vl_faturado,0) + coalesce(a.vl_faturado_ndc,0) + 
						coalesce((	select	sum(p.vl_faturado) + sum(p.vl_faturado_ndc) 
							from	pls_fatura_proc p 
							where	p.nr_seq_pos_proc = a.nr_seq_pos_proc 
							and	p.nr_seq_fatura_conta = a.nr_seq_fatura_conta 
							and	p.ie_tipo_cobranca in ('3','4')),0), 
					a.nr_sequencia, 
					b.nr_seq_conta_proc 
				into STRICT	cd_procedimento_w, 
					qt_glosada_w, 
					vl_glosado_w, 
					nr_seq_fatura_proc_w, 
					nr_seq_conta_proc_w 
				from	pls_conta_pos_proc b, 
					pls_fatura_proc a 
				where	a.nr_seq_pos_proc = b.nr_sequencia 
				and	a.ie_tipo_cobranca not in ('3','4') 
				and	a.nr_sequencia	= nr_sequencia_p;
			end if;
		end if;
	end if;
 
	if (ds_tipo_p = 'Materiais') then 
		if (ie_envio_recebimento_p = 'E') then 
			select	a.nr_seq_material, 
				CASE WHEN a.qt_material='0' THEN a.qt_material_imp  ELSE a.qt_material END , 
				CASE WHEN a.vl_unitario='0' THEN a.vl_unitario_imp  ELSE a.vl_unitario END , 
				a.nr_sequencia 
			into STRICT	nr_seq_material_w, 
				qt_glosada_mat_w, 
				vl_glosado_mat_w, 
				nr_seq_conta_mat_w 
			from	pls_conta_mat	a 
			where	a.nr_sequencia	= nr_sequencia_p;
			 
			if (ie_opcao_p = 'D') then 
				select	coalesce(a.vl_glosa,0) 
				into STRICT	vl_glosado_mat_w 
				from	pls_conta_mat a 
				where	a.nr_sequencia		= nr_sequencia_p;
			end if;
		else 
			if (ie_novo_pos_estab_w = 'N') then 
				select	substr(pls_obter_dados_conta_mat(b.nr_seq_conta_mat,'C'),1,255) nr_seq_material, 
					b.qt_item, 
					coalesce(a.vl_faturado,0) + coalesce(a.vl_faturado_ndc,0) + 
						coalesce((	select	sum(p.vl_faturado) + sum(p.vl_faturado_ndc) 
							from	pls_fatura_mat p 
							where	p.nr_seq_conta_pos_estab = a.nr_seq_conta_pos_estab 
							and	p.nr_seq_fatura_conta = a.nr_seq_fatura_conta 
							and	p.ie_tipo_cobranca in ('3','4')),0), 
					a.nr_sequencia, 
					b.nr_seq_conta_mat 
				into STRICT	nr_seq_material_w, 
					qt_glosada_mat_w, 
					vl_glosado_mat_w, 
					nr_seq_fatura_mat_w, 
					nr_seq_conta_mat_w 
				from	pls_conta_pos_estabelecido b, 
					pls_fatura_mat a 
				where	a.nr_seq_conta_pos_estab = b.nr_sequencia 
				and	a.nr_sequencia	= nr_sequencia_p;
				 
			elsif (ie_novo_pos_estab_w = 'S') then 
				select	substr(pls_obter_dados_conta_mat(b.nr_seq_conta_mat,'C'),1,255) nr_seq_material, 
					b.qt_item, 
					coalesce(a.vl_faturado,0) + coalesce(a.vl_faturado_ndc,0) + 
						coalesce((	select	sum(p.vl_faturado) + sum(p.vl_faturado_ndc) 
							from	pls_fatura_mat p 
							where	p.nr_seq_pos_mat = a.nr_seq_pos_mat 
							and	p.nr_seq_fatura_conta = a.nr_seq_fatura_conta 
							and	p.ie_tipo_cobranca in ('3','4')),0), 
					a.nr_sequencia, 
					b.nr_seq_conta_mat 
				into STRICT	nr_seq_material_w, 
					qt_glosada_mat_w, 
					vl_glosado_mat_w, 
					nr_seq_fatura_mat_w, 
					nr_seq_conta_mat_w 
				from	pls_conta_pos_mat b, 
					pls_fatura_mat a 
				where	a.nr_seq_pos_mat = b.nr_sequencia 
				and	a.nr_sequencia	= nr_sequencia_p;
			end if;
		end if;			
	end if;
 
	if (cd_procedimento_w IS NOT NULL AND cd_procedimento_w::text <> '') then 
		insert into w_pls_selecao_item_contest(	nr_sequencia, 
						dt_atualizacao, 
						nm_usuario, 
						dt_atualizacao_nrec, 
						nm_usuario_nrec, 
						nr_seq_conta_proc, 
						qt_glosada, 
						vl_glosado, 
						nr_seq_fatura_proc) 
				values (	nextval('w_pls_selecao_item_contest_seq'), 
						clock_timestamp(), 
						nm_usuario_p, 
						clock_timestamp(), 
						nm_usuario_p, 
						nr_seq_conta_proc_w, 
						coalesce(qt_glosada_w,1), 
						vl_glosado_w, 
						nr_seq_fatura_proc_w);
 
	elsif (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') then 
		insert into w_pls_selecao_item_contest(	nr_sequencia, 
						dt_atualizacao, 
						nm_usuario, 
						dt_atualizacao_nrec, 
						nm_usuario_nrec, 
						nr_seq_conta_mat, 
						qt_glosada, 
						vl_glosado, 
						nr_seq_fatura_mat) 
				values (	nextval('w_pls_selecao_item_contest_seq'), 
						clock_timestamp(), 
						nm_usuario_p, 
						clock_timestamp(), 
						nm_usuario_p, 
						nr_seq_conta_mat_w, 
						coalesce(qt_glosada_mat_w,1), 
						vl_glosado_mat_w, 
						nr_seq_fatura_mat_w);
	end if;
	commit;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_selecionar_item_contest ( nr_sequencia_p bigint, cd_item_p bigint, ds_tipo_p text, ie_opcao_p text, ie_envio_recebimento_p text, nm_usuario_p text) FROM PUBLIC;

