-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE validar_funcao_abreviatura ( nr_seq_funcao_schematic_p bigint, nm_usuario_p text, nr_seq_objeto_schematic_p bigint default null) AS $body$
DECLARE


nr_seq_objeto_w			bigint;
nr_seq_dic_objeto_w		bigint;
nm_tabela_w			varchar(50);
nr_seq_visao_w			bigint;
ie_tipo_componente_w		varchar(15);
cd_exp_label_w			bigint;
ds_expressao_br_w		varchar(4000);
ds_abreviatura_w		varchar(255);
nr_seq_abreviatura_w		bigint;
nm_atributo_w			varchar(50);
qt_espaco_w			bigint;

C01 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.nr_seq_dic_objeto,
		a.nm_tabela,
		a.nr_seq_visao,
		a.ie_tipo_componente
	from	objeto_schematic a
	where	a.nr_seq_funcao_schematic = nr_seq_funcao_schematic_p
	and	a.nr_sequencia = CASE WHEN coalesce(nr_seq_objeto_schematic_p::text, '') = '' THEN  nr_sequencia  ELSE nr_seq_objeto_schematic_p END;

C02 CURSOR FOR
	SELECT	cd_exp_label, /* WDBPanel Detalhe */
		nm_atributo
	from	tabela_visao_atributo
	where	nr_sequencia = nr_seq_visao_w
	and	(cd_exp_label IS NOT NULL AND cd_exp_label::text <> '')
	and	(NR_SEQ_APRESENT IS NOT NULL AND NR_SEQ_APRESENT::text <> '')
	and	ie_tipo_componente_w = 'WDBP'
	
union

	SELECT	cd_exp_label_grid, /* WDBPanel Grid */
		nm_atributo
	from	tabela_visao_atributo
	where	nr_sequencia = nr_seq_visao_w
	and	(cd_exp_label_grid IS NOT NULL AND cd_exp_label_grid::text <> '')
	and	(NR_SEQ_APRESENT IS NOT NULL AND NR_SEQ_APRESENT::text <> '')
	and	ie_tipo_componente_w = 'WDBP'
	
union

	select	cd_exp_campo_tela, /* WCPanel */
		nm_campo_base
	from	dic_objeto
	where	nr_seq_obj_sup = nr_seq_dic_objeto_w
	and	ie_tipo_componente_w = 'WCP'
	
union

	select	cd_exp_label, /* WFiltro */
		nm_atributo
	from	dic_objeto_filtro
	where	nr_seq_objeto = nr_seq_dic_objeto_w
	and	ie_tipo_componente_w = 'WF'
	
union

	select	cd_exp_texto, /* WPopUp */
		substr(nm_objeto,1,50)
	from	dic_objeto
	where	nr_seq_obj_sup = nr_seq_dic_objeto_w
	and	ie_tipo_componente_w = 'WPOPUP'
	
union

	select	cd_exp_label, /* WDinamicForm */
		nm_atributo
	from	dic_objeto_filtro
	where	nr_seq_objeto = nr_seq_dic_objeto_w
	and	ie_tipo_componente_w = 'WDF';


BEGIN

delete	FROM abreviatura_schematic
where	nr_seq_funcao_schematic = nr_seq_funcao_schematic_p
and	nr_seq_objeto = CASE WHEN coalesce(nr_seq_objeto_schematic_p::text, '') = '' THEN  nr_seq_objeto  ELSE nr_seq_objeto_schematic_p END;

open C01;
loop
fetch C01 into
	nr_seq_objeto_w,
	nr_seq_dic_objeto_w,
	nm_tabela_w,
	nr_seq_visao_w,
	ie_tipo_componente_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	open C02;
	loop
	fetch C02 into
		cd_exp_label_w,
		nm_atributo_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		select	max(ds_expressao_br)
		into STRICT	ds_expressao_br_w
		from	dic_expressao
		where	cd_expressao = cd_exp_label_w;

		qt_espaco_w := position(' ' in ds_expressao_br_w);
		if (qt_espaco_w = 0) then /* A descrição NÃO possui espaço em branco */
			ds_abreviatura_w := ds_expressao_br_w;
		else
			ds_abreviatura_w := substr(ds_expressao_br_w,1,position(' ' in ds_expressao_br_w)-1);
		end if;

		select	max(nr_sequencia)
		into STRICT	nr_seq_abreviatura_w
		from	dic_abreviatura
		where	upper(ds_abreviatura) = upper(ds_abreviatura_w)
		and	ie_situacao = 'A';

		if (coalesce(nr_seq_abreviatura_w, 0) > 0) then
			insert into abreviatura_schematic(
				nr_sequencia,
				nr_seq_funcao_schematic,
				nr_seq_objeto,
				nr_seq_dic_objeto,
				nm_tabela,
				nm_atributo,
				nr_seq_visao,
				ie_tipo_componente,
				ds_abreviatura,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_dic_abreviatura,
				cd_expressao_original)
			values (nextval('abreviatura_schematic_seq'),
				nr_seq_funcao_schematic_p,
				nr_seq_objeto_w,
				nr_seq_dic_objeto_w,
				nm_tabela_w,
				nm_atributo_w,
				nr_seq_visao_w,
				ie_tipo_componente_w,
				ds_abreviatura_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_abreviatura_w,
				cd_exp_label_w);
		end if;
		end;
	end loop;
	close C02;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE validar_funcao_abreviatura ( nr_seq_funcao_schematic_p bigint, nm_usuario_p text, nr_seq_objeto_schematic_p bigint default null) FROM PUBLIC;

