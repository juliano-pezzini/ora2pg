-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE verifica_dupl_dia_grupo (cd_material_p bigint, nr_prescricao_p bigint, nr_atendimento_p bigint, cd_pessoa_fisica_p text, dt_prescricao_p timestamp, cd_estabelecimento_p bigint, cd_grupo_p bigint, nm_usuario_p text, ds_horarios_p text, ds_retorno_p INOUT text) AS $body$
DECLARE

				
cd_pessoa_fisica_w	atendimento_paciente.cd_pessoa_fisica%type;
dt_prescricao_w		timestamp;
ie_consitir_susp_w	varchar(10);
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
cd_grupo_w	bigint;

C01 CURSOR FOR
SELECT	a.nr_prescricao nr_prescricao,
		substr(obter_nome_pf(m.cd_pessoa_fisica),1,60) nm_medico,
		CASE WHEN a.ie_suspenso='S' THEN UPPER(obter_desc_expressao(298991))  ELSE '' END  ie_suspenso
from	estrutura_material_v c,
		pessoa_fisica m,
		prescr_material	a,
		prescr_medica b
where	a.nr_prescricao		= b.nr_prescricao
and		a.cd_material		= c.cd_material
and		b.cd_medico			= m.cd_pessoa_fisica
and		b.cd_pessoa_fisica	= cd_pessoa_fisica_p
and		b.nr_atendimento	= nr_atendimento_p
and		b.dt_prescricao between establishment_timezone_utils.startofday(dt_prescricao_p) and establishment_timezone_utils.startofday(dt_prescricao_p + 1)
and		b.nr_prescricao		<> nr_prescricao_p
and		c.cd_grupo_material	= cd_grupo_p
and		a.ds_horarios		= ds_horarios_p
and		coalesce(a.ie_modificado,'N') <> 'S'
and		((ie_consitir_susp_w	= 'S') or (coalesce(a.ie_suspenso,'N') = 'N'));

BEGIN

ie_consitir_susp_w := Obter_Param_Usuario(924, 307, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_p, ie_consitir_susp_w);

for r_c01_w in C01
loop
	ds_retorno_p:= substr(ds_retorno_p || r_c01_w.ie_suspenso || ' ' || r_c01_w.nr_prescricao || ' ' || r_c01_w.nm_medico || chr(10) || chr(13),1,255);	
end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE verifica_dupl_dia_grupo (cd_material_p bigint, nr_prescricao_p bigint, nr_atendimento_p bigint, cd_pessoa_fisica_p text, dt_prescricao_p timestamp, cd_estabelecimento_p bigint, cd_grupo_p bigint, nm_usuario_p text, ds_horarios_p text, ds_retorno_p INOUT text) FROM PUBLIC;

