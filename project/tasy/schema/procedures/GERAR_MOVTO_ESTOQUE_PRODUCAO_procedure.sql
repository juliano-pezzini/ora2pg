-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_movto_estoque_producao ( nr_lote_producao_p bigint, nm_usuario_p text, IE_TIPO_P text) AS $body$
DECLARE


/*tipos de geracao
ie_tipo_p = 1   entrada
ie_tipo_p = 2   estorno  */
nr_movimento_estoque_w		bigint;
cd_estabelecimento_w		smallint;
cd_local_estoque_w		smallint;
dt_movimento_estoque_w		timestamp;
cd_operacao_estoque_w		smallint;
cd_acao_w			varchar(1);
cd_material_w			integer;
qt_movimento_w			double precision;
dt_atualizacao_w			timestamp;
ie_origem_documento_w		varchar(3) := '7';
nr_documento_w			integer;
nr_sequencia_item_docto_w		smallint;
nr_sequencia_documento_w		smallint;
cd_unidade_medida_consumo_w	varchar(30);
qt_conv_estoque_consumo_w	double precision;
qt_estoque_w			double precision;
cd_oper_producao_w		smallint;
cd_oper_baixa_producao_w		smallint;
dt_mesano_referencia_w		timestamp;
dt_validade_w			timestamp;
nr_sequencia_comp_w		integer;
nr_lote_producao_w		bigint;
cd_local_estoque_comp_w		smallint;
dt_inicio_w			timestamp;
ie_acao_w			varchar(1);
cd_material_comp_w		integer;
qt_real_w				double precision;
qt_componente_cons_w		double precision;
qt_componente_etq_w		double precision;
cd_unidade_medida_w		varchar(30);
cd_unid_med_cons_w		varchar(30);
cd_unid_med_etq_w		varchar(30);
dt_confirmacao_w			timestamp;
ie_baixa_comp_producao_w		varchar(1);
ie_material_estoque_w		varchar(1);
material_estoque_comp_w		varchar(1);
cd_centro_custo_w			integer;
ie_estoque_lote_w			varchar(1);
ds_retorno_w			varchar(255);
nr_seq_lote_fornec_w		bigint;

/* servicos */

nr_seq_servico_w			bigint;
nr_seq_proc_interno_w		double precision;
vl_item_w				double precision;
qt_item_w			double precision;
vl_original_w			double precision;

vl_servico_w			double precision;
vl_total_servico_w			double precision := 0;
nr_seq_op_opm_w			lote_producao.nr_seq_op_opm%type;
nr_seq_tipo_equip_w		man_equipamento.nr_seq_tipo_equip%type;
nr_seq_planej_w			man_equipamento.nr_seq_planej%type;
nr_seq_trab_w			man_equipamento.nr_seq_trab%type;
nr_seq_local_w			man_equipamento.nr_seq_local%type;
ds_equipamento_w			man_equipamento.ds_equipamento%type;
ie_gerar_equip_prod_opm_w	parametro_estoque.ie_gerar_equip_prod_opm%type;
ie_regra_saldo_consig_w		parametro_estoque.ie_regra_saldo_consig%type;
cd_oper_baixa_prod_consig_w	parametro_estoque.cd_oper_baixa_prod_consig%type;
ie_consignado_comp_w		material.ie_consignado%type;
cd_cgc_fornecedor_w		movimento_estoque.cd_fornecedor%type;
cd_operacao_baixa_w		parametro_estoque.cd_oper_baixa_producao%type;

c02 CURSOR FOR
SELECT	nr_sequencia,
	cd_material,
	cd_unidade_medida,
	cd_unid_med_etq,
	cd_local_estoque,
	coalesce(qt_real,0) + coalesce(qt_perda,0),
	coalesce(qt_estoque,0) + coalesce(qt_perda_etq,0),
	cd_fornecedor,
	nr_seq_lote_fornec
from	lote_producao_comp
where	nr_lote_producao = nr_lote_producao_p
and	ie_baixa_comp_producao_w = 'S';

c03 CURSOR FOR
SELECT	nr_sequencia,
	nr_seq_proc_interno,
	vl_item,
	qt_item,
	vl_original
from	lote_producao_serv
where	nr_lote_producao = nr_lote_producao_p
and	ie_baixa_comp_producao_w = 'S';


BEGIN

ie_acao_w	:= ie_tipo_p;

select	dt_confirmacao,
	cd_estabelecimento,
	nr_seq_op_opm
into STRICT	dt_confirmacao_w,
	cd_estabelecimento_w,
	nr_seq_op_opm_w
from	lote_producao
where	nr_lote_producao = nr_lote_producao_p;

select	coalesce(max(ie_baixa_comp_producao),'S'),
	coalesce(max(ie_regra_saldo_consig), 0)
into STRICT	ie_baixa_comp_producao_w,
	ie_regra_saldo_consig_w
from	parametro_estoque
where	cd_estabelecimento = cd_estabelecimento_w;

if (coalesce(dt_confirmacao_w::text, '') = '') then
	begin
	/* geracao da entrada da producao se for material de estoque */

	select	nr_lote_producao,
		dt_inicio,
		cd_material,
		cd_estabelecimento,
		cd_local_estoque,
		cd_unidade_medida,
		PKG_DATE_UTILS.start_of(dt_mesano_referencia,'month',0),
		coalesce(qt_real,qt_prevista)
	into STRICT	nr_lote_producao_w,
		dt_inicio_w,
		cd_material_w,
		cd_estabelecimento_w,
		cd_local_estoque_w,
		cd_unidade_medida_w,
		dt_mesano_referencia_w,
		qt_real_w
	from	lote_producao
	where	nr_lote_producao = nr_lote_producao_p
	and	coalesce(dt_confirmacao_w::text, '') = '';
	
	ie_estoque_lote_w := obter_se_material_estoque_lote(cd_estabelecimento_w, cd_material_w);
	
	if (ie_estoque_lote_w = 'S') then -- Juan // Somente gerar lote fornecedor na acao tipo 1
		if (ie_acao_w = '1') then
			ds_retorno_w := gerar_lote_fornec(nr_lote_producao_p, nm_usuario_p, ds_retorno_w);
		end if;
		
		select	max(nr_sequencia)
		into STRICT	nr_seq_lote_fornec_w
		from	material_lote_fornec
		where	nr_lote_producao = nr_lote_producao_p;
	end if;

	select	substr(obter_se_material_estoque(cd_estabelecimento_w, 0, cd_material),1,1)
	into STRICT	ie_material_estoque_w
	from	material
	where	cd_material = cd_material_w;

	if (ie_material_estoque_w = 'S') then
		begin
		select	coalesce(max(cd_oper_producao),0),
			coalesce(max(cd_oper_baixa_producao),0),
			coalesce(max(cd_oper_baixa_prod_consig),0)
		into STRICT	cd_oper_producao_w,
			cd_oper_baixa_producao_w,
			cd_oper_baixa_prod_consig_w
		from	parametro_estoque
		where	cd_estabelecimento	= cd_estabelecimento_w;

		if (cd_oper_producao_w = 0) or (cd_oper_baixa_producao_w = 0) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(194310);
			-- falta informar as operacoes de estoque (producao e baixa producao) nos parametros de estoque
		end if;

		select	substr(obter_dados_material_estab(cd_material,cd_estabelecimento_w,'UMS'),1,30) cd_unidade_medida_consumo,
			qt_conv_estoque_consumo
		into STRICT	cd_unidade_medida_consumo_w,
			qt_conv_estoque_consumo_w
		from	material
		where	cd_material = cd_material_w;

		select	nextval('movimento_estoque_seq')
		into STRICT	nr_movimento_estoque_w
		;

		insert into movimento_estoque(
			nr_movimento_estoque,
			cd_estabelecimento,
	 		cd_local_estoque,
 			dt_movimento_estoque,
 			cd_operacao_estoque,
	 		cd_acao,
 			cd_material,
 			dt_mesano_referencia,
	 		qt_movimento,
 			dt_atualizacao,
	 		nm_usuario,
 			ie_origem_documento,
 			nr_documento,
	 		nr_sequencia_item_docto,
 			cd_cgc_emitente,
			cd_serie_nf,
	 		nr_sequencia_documento,
 			vl_movimento,
 			cd_unidade_medida_estoque,
	 		cd_procedimento,
 			cd_setor_atendimento,
 			cd_conta,
	 		dt_contabil,
 			cd_lote_fabricacao,
 			dt_validade,
	 		qt_estoque,
 			dt_processo,
 			cd_local_estoque_destino,
	 		cd_centro_custo,
			cd_unidade_med_mov,
	 		nr_movimento_estoque_corresp,
 			cd_conta_contabil,
 			cd_material_estoque,
	 		ie_origem_proced,
 			cd_fornecedor,
 			nr_lote_contabil,
			ds_observacao,
			nr_seq_lote_fornec,
			nr_lote_producao)
		values (	nr_movimento_estoque_w,
 		 	cd_estabelecimento_w,
	 		cd_local_estoque_w,
			clock_timestamp(),
			cd_oper_producao_w,
			ie_acao_w,
			cd_material_w,
			dt_mesano_referencia_w,
	 		(qt_real_w * qt_conv_estoque_consumo_w),
		 	clock_timestamp(),
			nm_usuario_p,
			ie_origem_documento_w,
			nr_lote_producao_p,
			null,
			null,
			null,
			null,
			null,
			cd_unidade_medida_w,
			null,
			null,
			null,
			null,
			nr_lote_producao_p,
			dt_validade_w,
			qt_real_w,
			null,
			null,
			null,
			cd_unidade_medida_consumo_w,
			null,
			null,
			null,
			null,
			null,
			null,
			CASE WHEN ie_baixa_comp_producao_w='N' THEN  wheb_mensagem_pck.get_texto(310770)  ELSE '' END , /*'Os componentes nao geram movimentos'*/
			nr_seq_lote_fornec_w,
			nr_lote_producao_p);

		/* geracao das saidas para a producao (servicos)  */

		open c03;
		loop
		fetch c03 into
			nr_seq_servico_w,
			nr_seq_proc_interno_w,
			vl_item_w,
			qt_item_w,
			vl_original_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
			begin
			vl_total_servico_w := vl_total_servico_w + vl_item_w;
			end;
		end loop;
		close c03;
		if (vl_total_servico_w > 0) then
			begin

			begin
			insert into movimento_estoque_valor(
				nr_movimento_estoque,
				cd_tipo_valor,
				vl_movimento,
				dt_atualizacao,
				nm_usuario)
			values (nr_movimento_estoque_w,
				16,
				vl_total_servico_w,
				clock_timestamp(),
				nm_usuario_p);
			exception when others then
				null;
			end;

			end;
		end if;

		end;
	else
		CALL wheb_mensagem_pck.exibir_mensagem_abort(194311);
		-- o material do lote nao e material de estoque.
	end if;

	/* geracao das saidas para a producao */

	open c02;
	loop
	fetch c02 into
		nr_sequencia_comp_w,
		cd_material_comp_w,
		cd_unid_med_cons_w,
		cd_unid_med_etq_w,
		cd_local_estoque_comp_w,
		qt_componente_cons_w,
		qt_componente_etq_w,
		cd_cgc_fornecedor_w,
		nr_seq_lote_fornec_w;
      	EXIT WHEN NOT FOUND; /* apply on c02 */
      	begin
	select	substr(obter_se_material_estoque(cd_estabelecimento_w, 0, cd_material),1,1),
		substr(obter_se_material_estoque_lote(cd_estabelecimento_w, cd_material),1,1),
		ie_consignado
	into STRICT	material_estoque_comp_w,
		ie_estoque_lote_w,
		ie_consignado_comp_w
	from	material
	where	cd_material = cd_material_comp_w;

	if (material_estoque_comp_w = 'S') then
		begin
		if (ie_consignado_comp_w = '1') or (ie_consignado_comp_w = '2' and
			coalesce(cd_cgc_fornecedor_w, 'X') <> 'X') then
			cd_operacao_baixa_w := cd_oper_baixa_prod_consig_w;
			
			if (cd_operacao_baixa_w = 0) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(1110064);
				 /* 1110064 - Para finalizar a producao e necessario informar a operacao de baixa producao consignado. */

			end if;
		else
			cd_operacao_baixa_w := cd_oper_baixa_producao_w;
		end if;

		if (ie_consignado_comp_w = '2') and (ie_regra_saldo_consig_w > 0) and (ie_estoque_lote_w = 'N') and (coalesce(cd_cgc_fornecedor_w, 'X') = 'X') then
			/* Necessario realizar a conversao ao inves de simplesmente passar a variavel qt_componente_etq_w
			porque a tela dos itens do Lote producao esta se comportando de forma incorreta, 
			permitindo modificar a quantidade de estoque, sem que a quantidade de consumo seja atualizada.
			Assim sendo, para preservar o funcionamento habitual, precisamos converter a quantidade de consumo para quantidade de estoque.
			Caso o comportamento for ajustado, nao sera necessario conversao, passando diretamente a qt_componente_etq_w. */
			qt_componente_etq_w := obter_quantidade_convertida(
							cd_material_p			=> cd_material_comp_w,
							qt_material_p			=> qt_componente_cons_w,
							cd_unidade_medida_p		=> cd_unid_med_cons_w,
							cd_unidade_medida_retorno_p	=> 'UME');

			CALL gerar_movimento_consig_ambos(
				cd_material_p		=> cd_material_comp_w,
				qt_movimento_p		=> qt_componente_etq_w,
				cd_unidade_medida_p	=> cd_unid_med_etq_w,
				ie_acao_p		=> ie_acao_w,
				cd_local_estoque_p	=> cd_local_estoque_comp_w,
				cd_estabelecimento_p	=> cd_estabelecimento_w,
				ie_rotina_movimento_p	=> 'MEP',
				nm_usuario_p		=> nm_usuario_p,
				nr_seq_lote_fornec_p	=> nr_seq_lote_fornec_w,
				nr_sequencia_p		=> nr_lote_producao_p,
				nr_seq_item_p		=> nr_sequencia_comp_w);
		else
			select	coalesce(max(cd_centro_custo), 0)
			into STRICT	cd_centro_custo_w
			from	local_estoque
			where	cd_local_estoque = cd_local_estoque_w;

			select	nextval('movimento_estoque_seq')
			into STRICT	nr_movimento_estoque_w
			;
			
			insert into movimento_estoque(
				nr_movimento_estoque,
				cd_estabelecimento,
				cd_local_estoque,
				dt_movimento_estoque,
				cd_operacao_estoque,
				cd_acao,
				cd_material,
				dt_mesano_referencia,
				qt_movimento,
				dt_atualizacao,
				nm_usuario,
				ie_origem_documento,
				nr_documento,
				cd_unidade_med_mov,
				cd_unidade_medida_estoque,
				cd_lote_fabricacao,
				dt_validade,
				qt_estoque,
				dt_processo,
				cd_centro_custo,
				cd_fornecedor,
				nr_seq_lote_fornec,
				nr_lote_producao,
				nr_sequencia_item_docto)
			values (	nr_movimento_estoque_w,
				cd_estabelecimento_w,
				cd_local_estoque_comp_w,
				clock_timestamp(),
				cd_operacao_baixa_w,
				ie_acao_w,
				cd_material_comp_w,
				dt_mesano_referencia_w,
				qt_componente_cons_w,
				clock_timestamp(),
				nm_usuario_p,
				ie_origem_documento_w,
				nr_lote_producao_p,
				cd_unid_med_cons_w,
				cd_unid_med_etq_w,
				nr_lote_producao_p,
				dt_validade_w,
				qt_componente_etq_w,
				null,
				CASE WHEN cd_centro_custo_w=0 THEN  null  ELSE cd_centro_custo_w END ,
				cd_cgc_fornecedor_w,
				nr_seq_lote_fornec_w,
				nr_lote_producao_p,
				nr_sequencia_comp_w);
		end if;

		end;
	end if;
	end;
	end loop;
	close c02;	

	if (ie_acao_w = '1') then -- Juan // Somente atualiza data na acao tipo 1
		update lote_producao
		set dt_confirmacao = clock_timestamp()
		where nr_lote_producao = nr_lote_producao_p;
	end if;
	
	select 	ie_gerar_equip_prod_opm
	into STRICT	ie_gerar_equip_prod_opm_w
	from 	parametro_estoque
	where	cd_estabelecimento = cd_estabelecimento_w;
	
	if (nr_seq_op_opm_w > 0 and ie_gerar_equip_prod_opm_w = 'S') and (ie_acao_w = '1') then -- Juan // Somente gera equipamento na acao tipo 1
		begin
		select	max(nr_sequencia)
		into STRICT	nr_seq_tipo_equip_w
		from	man_tipo_equipamento
		where	ds_tipo_equip like 'OPM';
		
		if (coalesce(nr_seq_tipo_equip_w::text, '') = '') then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(457078);
		end if;
		
		select	max(nr_sequencia)
		into STRICT	nr_seq_planej_w
		from	man_grupo_planejamento
		where	substr(obter_se_usuario_grupo_planej(nr_sequencia, nm_usuario_p),1,1) = 'S';
		
		if (coalesce(nr_seq_planej_w::text, '') = '') then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(457079);
		end if;
		
		select	max(nr_sequencia)
		into STRICT	nr_seq_trab_w
		from	man_grupo_trabalho
		where	substr(obter_se_usuario_grupo_trab(nr_sequencia, nm_usuario_p),1,1) = 'S';
		
		if (coalesce(nr_seq_trab_w::text, '') = '')	 then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(457080);
		end if;
		
		select	max(a.nr_sequencia)
		into STRICT	nr_seq_local_w
		from	man_localizacao a,
			estabelecimento b
		where	a.cd_cnpj = b.cd_cgc
		and	b.cd_estabelecimento = cd_estabelecimento_w
		and	a.ie_situacao = 'A';
		
		if (coalesce(nr_seq_local_w::text, '') = '') then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(457092);
		end if;
		
		ds_equipamento_w	:=	substr(wheb_mensagem_pck.get_texto(457077) || nr_seq_op_opm_w || ' - ' || obter_dados_material(cd_material_w,'DR'),1,80);
		
		insert into man_equipamento(
			nr_sequencia,
			ds_equipamento,
			nr_seq_local,
			nr_seq_tipo_equip,
			dt_atualizacao,
			nm_usuario,
			nr_seq_planej,
			nr_seq_trab,
			ie_situacao,
			ie_disponibilidade,
			ie_rotina_seguranca,
			ie_propriedade,
			ie_parado,
			ie_controle_setor)
		values (	nextval('man_equipamento_seq'),
			ds_equipamento_w,
			nr_seq_local_w,
			nr_seq_tipo_equip_w,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_planej_w,
			nr_seq_trab_w,
			'A',
			'N',
			'N',
			'T',
			'N',
			'S');		
		end;
	end if;

	commit;

   if (coalesce(nr_seq_op_opm_w,0) > 0) then
      if (ie_tipo_p = '1') then
         CALL gravar_status_op_opm(nr_seq_op_opm_w,'ACLP',null,nm_usuario_p,cd_estabelecimento_w);
      else
         CALL gravar_status_op_opm(nr_seq_op_opm_w,'AELP',null,nm_usuario_p,cd_estabelecimento_w);
      end if;
   end if;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_movto_estoque_producao ( nr_lote_producao_p bigint, nm_usuario_p text, IE_TIPO_P text) FROM PUBLIC;

