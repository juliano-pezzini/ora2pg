-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_valor_receb_adic (nr_seq_receb_p bigint, nm_usuario_p text) AS $body$
DECLARE



cd_estabelecimento_w		smallint;
nr_lote_contabil_rec_w		bigint;
vl_deposito_w			double precision;
nr_seq_tran_financ_w		bigint;
vl_adicional_w			double precision;
nr_lote_contabil_adic_w		bigint;
ie_vl_conv_rec_adic_w		varchar(1);
vl_despesa_bancaria_w		double precision;
vl_saldo_w			double precision;
ie_status_w			varchar(1);
cd_convenio_w			bigint;
dt_recebimento_w		timestamp;


BEGIN

select 	coalesce((vl_recebimento - obter_baixa_conrece(nr_sequencia))::numeric ,0),
	cd_estabelecimento,
	cd_convenio,
	dt_recebimento
into STRICT	vl_saldo_w,
	cd_estabelecimento_w,
	cd_convenio_w,
	dt_recebimento_w
from	convenio_receb
where	nr_sequencia = nr_seq_receb_p;

select 	coalesce(max(ie_vl_conv_rec_adic),'N')
into STRICT	ie_vl_conv_rec_adic_w
from 	parametro_contas_receber
where 	cd_estabelecimento = cd_estabelecimento_w;

ie_vl_conv_rec_adic_w	:= coalesce(OBTER_SE_ATUALIZA_JUROS_RECEB(cd_convenio_w,dt_recebimento_w), ie_vl_conv_rec_adic_w);

if (ie_vl_conv_rec_adic_w = 'S') then

	ie_status_w	:= 'P';
	if (vl_saldo_w = 0) then
		ie_status_w	:= 'T';
	end if;

	update convenio_receb
	set nm_usuario = nm_usuario_p,
	    ie_status = ie_status_w
	where nr_sequencia = nr_seq_receb_p;

end if;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_valor_receb_adic (nr_seq_receb_p bigint, nm_usuario_p text) FROM PUBLIC;

