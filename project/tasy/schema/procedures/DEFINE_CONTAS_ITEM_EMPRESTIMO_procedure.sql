-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE define_contas_item_emprestimo (nr_seq_nota_p bigint, dt_vigencia_p timestamp, cd_operacao_nf_p bigint, cd_natureza_operacao_p bigint, ie_entrada_saida_p text, cd_moeda_p text) AS $body$
DECLARE


cd_operacao_estoque_w		operacao_nota.cd_operacao_estoque%type;
cd_conta_contabil_w		nota_fiscal_item.cd_conta_contabil%type := null;
cd_centro_custo_w		nota_fiscal_item.cd_centro_custo%type := null;
cd_local_estoque_w		nota_fiscal_item.cd_local_estoque%type;
cd_estabelecimento_w		nota_fiscal_item.cd_estabelecimento%type;
cd_material_w			nota_fiscal_item.cd_material%type;
nr_seq_conta_financ_w		nota_fiscal_item.nr_seq_conta_financ%type := null;
cd_cgc_w			nota_fiscal.cd_cgc%type;
cd_pessoa_fisica_w		nota_fiscal.cd_pessoa_fisica%type;
ie_tipo_local_w			local_estoque.ie_tipo_local%type;
ie_tipo_conta_w			smallint := 3;
nr_item_nf_w			nota_fiscal_item.nr_item_nf%type;


BEGIN

select	cd_operacao_estoque
into STRICT  	cd_operacao_estoque_w
from	operacao_nota
where	cd_operacao_nf	= cd_operacao_nf_p;

select 	max(nr_item_nf)
into STRICT 	nr_item_nf_w
from 	nota_fiscal_item
where 	nr_sequencia = nr_seq_nota_p;

select 	cd_local_estoque,
	cd_estabelecimento,
	cd_material
into STRICT 	cd_local_estoque_w,
	cd_estabelecimento_w,
	cd_material_w
from 	nota_fiscal_item
where 	nr_sequencia = nr_seq_nota_p
and 	nr_item_nf = nr_item_nf_w;

select 	cd_cgc,
	cd_pessoa_fisica
into STRICT 	cd_cgc_w,
	cd_pessoa_fisica_w
from 	nota_fiscal
where 	nr_sequencia = nr_seq_nota_p;

select	coalesce(ie_tipo_local,0)
into STRICT 	ie_tipo_local_w
from	local_estoque
where	cd_local_estoque	= cd_local_estoque_w;

if (ie_tipo_local_w != 8) then
	ie_tipo_conta_w := 2;
end if;

SELECT * FROM define_conta_material(cd_estabelecimento_w, cd_material_w, ie_tipo_conta_w, null, 0, null, 0, 0, 0, null, cd_local_estoque_w, cd_operacao_estoque_w, dt_vigencia_p, cd_conta_contabil_w, cd_centro_custo_w, null, null, null, null, cd_operacao_nf_p, null, cd_natureza_operacao_p) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w;
nr_seq_conta_financ_w := Obter_Conta_Financeira(ie_entrada_saida_p, cd_estabelecimento_w, cd_material_w, null, null, null, null, cd_cgc_w, cd_centro_custo_w, nr_seq_conta_financ_w, null, cd_operacao_nf_p, null, null, null, null, null, cd_pessoa_fisica_w, null, null, null, null, cd_local_estoque_w, null, null, null, null, null, cd_moeda_p);

update 	nota_fiscal_item
set 	cd_local_estoque = cd_local_estoque_w,
	cd_conta_contabil = cd_conta_contabil_w,
	cd_sequencia_parametro = philips_contabil_pck.get_parametro_conta_contabil
where 	nr_sequencia = nr_seq_nota_p
and 	nr_item_nf = nr_item_nf_w;

if (nr_seq_conta_financ_w <> 0) then
	update nota_fiscal_item
	set nr_seq_conta_financ = nr_seq_conta_financ_w
	where nr_sequencia = nr_seq_nota_p
	and 	nr_item_nf = nr_item_nf_w;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE define_contas_item_emprestimo (nr_seq_nota_p bigint, dt_vigencia_p timestamp, cd_operacao_nf_p bigint, cd_natureza_operacao_p bigint, ie_entrada_saida_p text, cd_moeda_p text) FROM PUBLIC;

