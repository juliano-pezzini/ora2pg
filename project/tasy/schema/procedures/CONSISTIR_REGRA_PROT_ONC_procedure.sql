-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_regra_prot_onc ( nr_seq_paciente_p bigint, nm_usuario_p text, nr_seq_regra_p bigint default 0, ie_forma_consistencia_p text default 'X', cd_material_p bigint default null, cd_unid_med_prescr_p text default null, qt_dose_prescr_p bigint default null, ie_via_aplicacao_p text default null, ds_observacao_p text default null, ds_ciclos_aplicacao_p text default null, nr_seq_material_p bigint default 0, qt_dias_util_p bigint default null, ie_local_adm_p text default null, ie_uso_continuo_p text default null, cd_intervalo_p text default null, qt_dose_p bigint default null, ds_justificativa_p bigint default null, ds_dose_diferenciada_p text default null, cd_unid_med_dose_p text default null) AS $body$
DECLARE

nr_seq_material_w	bigint;
nr_seq_procedimento_w	integer;
cd_material_w	bigint;
is_paciente_medic_update_w varchar(1) := 'N';/* valida se as inconsistencias irao partir do registro que esta sendo inserido ou editado. */
C01 CURSOR FOR
	SELECT	nr_seq_material
	from	paciente_protocolo_medic
	where	nr_seq_paciente	= nr_seq_paciente_p;


BEGIN

delete from paciente_atendimento_erro
where nr_seq_paciente = nr_seq_paciente_p
and coalesce(nr_seq_procedimento::text, '') = '';

open C01;
loop
fetch C01 into	
	nr_seq_material_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	if (nr_seq_material_p = nr_seq_material_w) then
		is_paciente_medic_update_w := 'S';
	else
    		is_paciente_medic_update_w := 'N';
	end if;

	CALL CONSISTIR_REGRA_PROT_MEDIC(nr_seq_paciente_p,
				nr_seq_material_w,
				nm_usuario_p,
				nr_seq_regra_p,
				0,
				ie_forma_consistencia_p,
				cd_material_p,
				cd_unid_med_prescr_p,
				qt_dose_prescr_p,
				ie_via_aplicacao_p,
				ds_observacao_p,
				ds_ciclos_aplicacao_p,
				is_paciente_medic_update_w,
				qt_dias_util_p,
				ie_local_adm_p,
				ie_uso_continuo_p,
				cd_intervalo_p,
				qt_dose_p,
				ds_justificativa_p,
        ds_dose_diferenciada_p,
        cd_unid_med_dose_p
				);
	end;
end loop;
close C01;

CALL CONSISTIR_REGRA_PROT_PROCED(nr_seq_paciente_p, nm_usuario_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_regra_prot_onc ( nr_seq_paciente_p bigint, nm_usuario_p text, nr_seq_regra_p bigint default 0, ie_forma_consistencia_p text default 'X', cd_material_p bigint default null, cd_unid_med_prescr_p text default null, qt_dose_prescr_p bigint default null, ie_via_aplicacao_p text default null, ds_observacao_p text default null, ds_ciclos_aplicacao_p text default null, nr_seq_material_p bigint default 0, qt_dias_util_p bigint default null, ie_local_adm_p text default null, ie_uso_continuo_p text default null, cd_intervalo_p text default null, qt_dose_p bigint default null, ds_justificativa_p bigint default null, ds_dose_diferenciada_p text default null, cd_unid_med_dose_p text default null) FROM PUBLIC;

