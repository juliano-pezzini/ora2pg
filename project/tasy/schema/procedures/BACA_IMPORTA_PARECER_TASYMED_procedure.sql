-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_importa_parecer_tasymed ( cd_pessoa_fisica_p text, cd_profissional_p text, nm_usuario_export_p text, nr_atendimento_p bigint default null, nr_seq_pepa_p bigint default null, nr_seq_cliente_p bigint default null) AS $body$
DECLARE

	
c01 CURSOR FOR
	SELECT	a.cd_medico,
			a.cd_pessoa_fisica, 
			b.dt_atualizacao, 
			b.nm_usuario, 
			b.dt_parecer, 
			'' ds_parecer, 
			b.nr_sequencia
	from med_cliente a, MED_PARECER_MEDICO b 
	where a.nr_sequencia = b.nr_seq_cliente
	and	a.cd_pessoa_fisica = cd_pessoa_fisica_p
	and	a.cd_medico = cd_profissional_p
	and  a.nr_sequencia = nr_seq_cliente_p
	and (coalesce(nr_atendimento_p::text, '') = '' or b.nr_atendimento =  nr_atendimento_p or coalesce(b.nr_atendimento::text, '') = '')
	and coalesce(b.ie_exportado,'N') = 'N'
	order by dt_atualizacao;
	
c01_w c01%rowtype;

nr_sequencia_w PARECER_MEDICO_REQ.nr_parecer%type;


BEGIN

if (coalesce(nr_atendimento_p::text, '') = '' or (nr_seq_pepa_p IS NOT NULL AND nr_seq_pepa_p::text <> '')) then

open C01;
loop
	fetch C01 into
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
			
			begin
			
				select 	nextval('parecer_medico_req_seq')
				into STRICT	nr_sequencia_w
				;			
		
				insert into PARECER_MEDICO_REQ(
					nr_parecer,
					cd_pessoa_fisica,
					dt_atualizacao,
					nm_usuario,
					cd_medico,
					dt_liberacao,
					ie_situacao,
					dt_atualizacao_nrec,
					nr_seq_atend_cons_pepa
					) values (
					nr_sequencia_w,
					c01_w.cd_pessoa_fisica,
					c01_w.dt_atualizacao,
					c01_w.nm_usuario,
					c01_w.cd_medico,
					c01_w.dt_atualizacao,
					'A',
					c01_w.dt_atualizacao,
					nr_seq_pepa_p);
					
					CALL copia_campo_long_de_para_novo(
						'MED_PARECER_MEDICO',
						'DS_PARECER',
						' where nr_sequencia = :nr_sequencia ',
						'nr_sequencia='||c01_w.nr_sequencia,
						'PARECER_MEDICO_REQ',
						'DS_MOTIVO_CONSULTA',
						' where nr_parecer = :nr_parecer ',
						'nr_parecer='||nr_sequencia_w,
						'L');
						
					update med_parecer_medico
						set ie_exportado = 'S',
							dt_exportacao = clock_timestamp(),
							nm_usuario_exportacao = nm_usuario_export_p
					where nr_sequencia = c01_w.nr_sequencia;
					
					commit;		
				
				exception when others then
					rollback;
				end;
		
		end;
		
end loop;
close C01;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_importa_parecer_tasymed ( cd_pessoa_fisica_p text, cd_profissional_p text, nm_usuario_export_p text, nr_atendimento_p bigint default null, nr_seq_pepa_p bigint default null, nr_seq_cliente_p bigint default null) FROM PUBLIC;

