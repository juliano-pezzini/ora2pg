-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mprev_efetuar_tranferir_agenda (nr_seq_tranferencia_p bigint, ie_confirmar_p text, nm_usuario_p text, qt_mensagens_erro_p INOUT bigint, qt_mensagens_atencao_p INOUT bigint, qt_mensagens_confirm_p INOUT bigint) AS $body$
DECLARE


--variaveis da transferencia
dt_inicial_w		timestamp;
dt_final_w		timestamp;
cd_agenda_origem_w	mprev_transferencia_agenda.cd_agenda_origem%type;
cd_agenda_destino_w	mprev_transferencia_agenda.cd_agenda_destino%type;

dados_agendamento	mprev_agenda_pck.dados_agendamento;

--variavel com a sequencia da agendamento
nr_sequencia_agend_w	mprev_agendamento.nr_sequencia%type;


c01 CURSOR(nr_seq_transferencia_pc	mprev_transf_agenda_item.nr_seq_transferencia%type) FOR
	SELECT	a.nr_sequencia nr_seq_transf_item,
		b.nr_sequencia nr_seq_agendamento,
		b.dt_agenda
	from	mprev_agendamento b,
		mprev_transf_agenda_item a
	where	a.nr_seq_agendamento_origem = b.nr_sequencia
	and	a.nr_seq_transferencia = nr_seq_transferencia_pc
	and	coalesce(a.ie_status_transferencia, 'XX') <> 'T';

BEGIN

dados_agendamento.nm_usuario	:= nm_usuario_p;
CALL mprev_agenda_pck.limpar_inconsistencias(dados_agendamento);

if (nr_seq_tranferencia_p IS NOT NULL AND nr_seq_tranferencia_p::text <> '') then
	--capta os dados da transferencia
	select 	dt_inicial,
		dt_final,
		cd_agenda_origem,
		cd_agenda_destino
	into STRICT	dt_inicial_w,
		dt_final_w,
		cd_agenda_origem_w,
		cd_agenda_destino_w
	from   	mprev_transferencia_agenda
	where	nr_sequencia = nr_seq_tranferencia_p;

	for	r_C01_w in C01(nr_seq_tranferencia_p) loop

		SELECT * FROM mprev_agenda_pck.transferir_agendamento(r_C01_w.nr_seq_agendamento, cd_agenda_destino_w, r_C01_w.dt_agenda, ie_confirmar_p, nm_usuario_p, qt_mensagens_erro_p, qt_mensagens_atencao_p, qt_mensagens_confirm_p) INTO STRICT qt_mensagens_erro_p, qt_mensagens_atencao_p, qt_mensagens_confirm_p;

		if (qt_mensagens_erro_p = 0) and (qt_mensagens_confirm_p = 0) then

			update	mprev_transf_agenda_item
			set	ie_status_transferencia = 'T'
			where	nr_sequencia = r_C01_w.nr_seq_transf_item;

		end if;
	end loop;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mprev_efetuar_tranferir_agenda (nr_seq_tranferencia_p bigint, ie_confirmar_p text, nm_usuario_p text, qt_mensagens_erro_p INOUT bigint, qt_mensagens_atencao_p INOUT bigint, qt_mensagens_confirm_p INOUT bigint) FROM PUBLIC;

