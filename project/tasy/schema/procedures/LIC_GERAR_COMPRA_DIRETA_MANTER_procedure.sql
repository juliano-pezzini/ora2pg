-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lic_gerar_compra_direta_manter ( cd_estabelecimento_p bigint, nr_cot_compra_p bigint, nm_usuario_p text, ds_observacao_solic_p INOUT text) AS $body$
DECLARE

 
				 
nr_solic_compra_w				bigint;
nr_seq_forma_compra_w			bigint;

c01 CURSOR FOR 
SELECT	distinct  --traz os itens que não tem agrupamento 
	a.nr_solic_compra 
from	cot_compra_item a 
where	a.nr_cot_compra	= nr_cot_compra_p 
and	substr(lic_obter_tipo_compra(a.nr_seq_tipo_compra),1,1) = 'D' 
and	(a.nr_solic_compra IS NOT NULL AND a.nr_solic_compra::text <> '') 

union all
 
SELECT	distinct  --traz somente os itens que tem agrupamento 
	b.nr_solic_compra 
from	cot_compra_solic_agrup b, 
	cot_compra_item a 
where	a.nr_cot_compra		= nr_cot_compra_p 
and	a.nr_cot_compra		= b.nr_cot_compra 
and	a.nr_item_cot_compra	= b.nr_item_cot_compra 
and	substr(lic_obter_tipo_compra(a.nr_seq_tipo_compra),1,1) = 'D' 
order by nr_solic_compra;


BEGIN 
 
select	coalesce(min(nr_sequencia),0) 
into STRICT	nr_seq_forma_compra_w 
from	reg_lic_forma_compra 
where	ie_situacao	= 'A' 
and	ie_forma_compra	= 'P';
 
if (nr_seq_forma_compra_w = 0) then 
	/*'Não existe nenhuma forma de compra cadastrada do tipo: Pesquisa de Preço.' || 
	'Favor verificar em Cadastros Gerais > Suprimentos > Licitação > Formas de compra para solicitação.');*/
 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(193431);
end if;
 
open C01;
loop 
fetch C01 into		 
	nr_solic_compra_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
 
	update	solic_compra 
	set	nr_seq_forma_compra = nr_seq_forma_compra_w 
	where	nr_solic_compra = nr_solic_compra_w;
 
	end;
end loop;
close C01;
 
CALL calcular_cot_compra_liquida(nr_cot_compra_p, nm_usuario_p);
CALL gerar_cot_compra_resumo(nr_cot_compra_p, nm_usuario_p);			
CALL Gerar_Ordem_Compra(nr_cot_compra_p, '', nm_usuario_p, 'N');
	 
update	cot_compra 
set	dt_geracao_ordem_compra	= clock_timestamp() 
where	nr_cot_compra		= nr_cot_compra_p;
 
update	cot_compra 
set	dt_fechamento_lic	= clock_timestamp() 
where	nr_cot_compra	= nr_cot_compra_p;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lic_gerar_compra_direta_manter ( cd_estabelecimento_p bigint, nr_cot_compra_p bigint, nm_usuario_p text, ds_observacao_solic_p INOUT text) FROM PUBLIC;

