-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_protocolo_dialise ( cd_protocolo_dest_p bigint, nr_seq_destino_p bigint, item_hemodialise_p text) AS $body$
DECLARE

 
nm_usuario_w   varchar(255);

nr_sequencia_w   bigint;
nr_seq_protocolo_w    bigint;
tipo_solucao_w   varchar(1);
solucao_total_w   bigint;
temp_solucao_w   bigint;
dosagem_w    bigint;
unid_vel_inf_w   varchar(3);
bomba_infusao_w   varchar(1);
dose_ataque_w   bigint;
orientacao_w   varchar(4000);
nr_seq_hd_prescr_w bigint;

cd_mat_soluc_w   bigint;
qt_dose_soluc_w   bigint;
cd_unid_med_dose_sol_w varchar(3);

ds_log         varchar(4000);

c01 CURSOR FOR 
 SELECT nr_sequencia 
    , nr_seq_protocolo 
    , tipo_solucao 
    , solucao_total 
    , temp_solucao 
    , dosagem 
    , unid_vel_inf 
    , bomba_infusao 
    , dose_ataque 
    , orientacao 
 FROM  cpoe_dialise_solucao_v 
 WHERE nr_sequencia = item_hemodialise_p;

  t RECORD;

BEGIN
 
nm_usuario_w := wheb_usuario_pck.get_nm_usuario;
 
if (item_hemodialise_p IS NOT NULL AND item_hemodialise_p::text <> '') then 
 
 select nextval('protocolo_hd_prescricao_seq') 
 into STRICT nr_seq_hd_prescr_w 
;
 
 -- INFORMACOES PRINCIPAIS -- 
 INSERT INTO protocolo_hd_prescricao(nr_sequencia 
       , dt_atualizacao 
       , nm_usuario 
       , dt_atualizacao_nrec 
       , nm_usuario_nrec 
       , cd_protocolo 
       , nr_seq_protocolo 
       , qt_sessao_sem 
       , qt_hora_sessao 
       , qt_min_sessao 
       , qt_fluxo_sangue 
       , nr_seq_mod_dialisador 
       , ie_ultrafiltracao 
       , qt_ultrafiltracao 
       , ie_tipo_hemodialise 
       , ie_tipo_peritoneal 
       , ie_tipo_dialise 
       , nr_seq_maq_cicladora 
       , nr_seq_diametro_agulha 
       , nr_seq_tipo_agulha 
       , nr_seq_tipo_agulha_art 
       , nr_seq_ultra 
       , nr_seq_perfil_sodio 
       , qt_zero_um 
       , qt_um_dois 
       , qt_dois_tres 
       , qt_tres_quatro 
       , ie_ligar_prime 
       , ds_observacao 
       , ie_categoria 
       , qt_sodio 
       , qt_bicarbonato 
       , qt_zero_um_bic 
       , qt_um_dois_bic 
       , qt_dois_tres_bic 
       , qt_tres_quatro_bic 
       , qt_quatro_cinco_bic 
       , qt_cinco_seis_bic 
       , nr_seq_perfil_bic 
       , qt_quatro_cinco 
       , qt_cinco_seis) 
  SELECT nr_seq_hd_prescr_w 
      , clock_timestamp() 
      , nm_usuario_w 
      , clock_timestamp() 
      , nm_usuario_w 
      , cd_protocolo_dest_p 
      , nr_seq_destino_p 
      , coalesce(qt_sessao_sem, 0) 
      , (Substr(qt_hora_min_sessao, 1, position(':' in qt_hora_min_sessao) - 1))::numeric  
      , (Substr(qt_hora_min_sessao, position(':' in qt_hora_min_sessao)+1))::numeric  
      , qt_fluxo_sangue 
      , nr_seq_mod_dialisador 
      , ie_ultrafiltracao 
      , qt_ultrafiltracao 
      , ie_tipo_hemodialise 
      , ie_tipo_peritoneal 
      , CASE 
       WHEN ie_tipo_dialise = 'DI' THEN 'H' /*Hemodialise*/
 
       WHEN ie_tipo_dialise = 'DP' THEN 'P' /*Dialise Peritonial*/
 
       END 
      , nr_seq_maq_cicladora 
      , nr_seq_diametro_agulha 
      , nr_seq_tipo_agulha 
      , nr_seq_tipo_agulha_art 
      , nr_seq_ultra 
      , nr_seq_perfil_sodio 
      , qt_zero_um 
      , qt_um_dois 
      , qt_dois_tres 
      , qt_tres_quatro 
      , ie_ligar_prime 
      , ds_observacao 
      , ie_categoria 
      , qt_sodio 
      , qt_bicarbonato 
      , qt_zero_um_bic 
      , qt_um_dois_bic 
      , qt_dois_tres_bic 
      , qt_tres_quatro_bic 
      , qt_quatro_cinco_bic 
      , qt_cinco_seis_bic 
      , nr_seq_perfil_bic 
      , qt_quatro_cinco 
      , qt_cinco_seis 
  FROM  cpoe_dialise 
  WHERE nr_sequencia = item_hemodialise_p;
 
 
 -- SOLUCOES -- 
 open c01;
 loop 
 
  fetch c01 into 
   nr_sequencia_w 
   , nr_seq_protocolo_w 
   , tipo_solucao_w 
   , solucao_total_w 
   , temp_solucao_w 
   , dosagem_w 
   , unid_vel_inf_w 
   , bomba_infusao_w 
   , dose_ataque_w 
   , orientacao_w;
 
  EXIT WHEN NOT FOUND; /* apply on c01 */
 
 
  INSERT INTO protocolo_medic_solucao(cd_protocolo 
       , nr_sequencia 
       , nr_seq_solucao 
       , nr_agrupamento 
       , nr_seq_dialise 
       , dt_atualizacao 
       , nm_usuario 
       , ie_tipo_dosagem 
       , qt_dosagem 
       , qt_solucao_total 
       , ie_bomba_infusao 
       , ie_esquema_alternado 
       , ie_calc_aut 
       , ie_acm 
       , ie_hemodialise 
       , ds_solucao 
       , ie_tipo_solucao 
       , qt_temp_solucao) 
  SELECT cd_protocolo_dest_p 
      , nr_seq_destino_p 
      , nr_seq_protocolo_w 
      , obter_agrup_prot_medic_mat(cd_protocolo_dest_p, nr_seq_destino_p, 0) 
      , nr_seq_hd_prescr_w 
      , clock_timestamp() 
      , nm_usuario_w 
      , unid_vel_inf_w 
      , dosagem_w 
      , solucao_total_w 
      , bomba_infusao_w 
      , 'N' 
      , 'S' 
      , 'N' 
      , CASE 
       WHEN ie_tipo_dialise = 'DI' THEN 'S' 
       WHEN ie_tipo_dialise = 'DP' THEN 'P' 
       END 
      , ds_orientacao 
      , tipo_solucao_w 
      , temp_solucao_w 
  FROM  cpoe_dialise 
  WHERE nr_sequencia = item_hemodialise_p;
 
  -- ITENS (MATERIAL) -- 
 
  for t in ( 
   SELECT nr_seq_protocolo 
      , cd_mat_soluc 
      , qt_dose_soluc 
      , cd_unid_med_dose_sol 
   FROM  cpoe_dialise_solucao_item_v 
   WHERE nr_sequencia = item_hemodialise_p 
    AND nr_seq_protocolo = nr_seq_protocolo_w 
   ) 
  loop 
   CALL incluir_prot_derivado_material( 
    cd_protocolo_dest_p 
    , nr_seq_destino_p 
    , t.cd_mat_soluc 
    , null 
    , 13 
    , t.qt_dose_soluc 
    , null 
    , null 
    , t.cd_unid_med_dose_sol 
    , null 
    , null 
    , null 
    , null 
    , 'N' 
    , 'N' 
    , clock_timestamp() 
    , 'N' 
    , 'N' 
    , 'N' 
    , 'N' 
    , null 
    , t.nr_seq_protocolo);
  end loop;
 
 end loop;
 close c01;
end if;
 
COMMIT;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_protocolo_dialise ( cd_protocolo_dest_p bigint, nr_seq_destino_p bigint, item_hemodialise_p text) FROM PUBLIC;

