-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_man_equipamento ( DS_EQUIPAMENTO_W MAN_EQUIPAMENTO.DS_EQUIPAMENTO%TYPE, SERIAL_W MAN_EQUIPAMENTO_BOMBA.DS_NUMERO_SERIAL%TYPE, CHANNEL_W MAN_EQUIPAMENTO_BOMBA.DS_CANAL%TYPE, RESULTADO_ERRO INOUT text, ID_MAN_EQUIPAMENTO_W INOUT integer, ID_MAN_EQUIPAMENTO_BOMBA_W INOUT integer) AS $body$
DECLARE

  ID_MAN_LOCALIZACAO_W MAN_LOCALIZACAO.NR_SEQUENCIA%TYPE;
  ID_MAN_GRUPO_TRABALHO_W MAN_GRUPO_TRABALHO.NR_SEQUENCIA%TYPE;
  ID_MAN_TIPO_EQUIPAMENTO_W MAN_TIPO_EQUIPAMENTO.NR_SEQUENCIA%TYPE;
  ID_MAN_GRUPO_PLANEJAMENTO_W MAN_GRUPO_PLANEJAMENTO.NR_SEQUENCIA%TYPE;

BEGIN
  SELECT MIN(NR_SEQUENCIA) ID
  INTO STRICT ID_MAN_LOCALIZACAO_W
  FROM MAN_LOCALIZACAO
  WHERE IE_SITUACAO        = 'A';
  IF (coalesce(ID_MAN_LOCALIZACAO_W::text, '') = '') THEN
    RESULTADO_ERRO := 'Error when inserting equipment, it is necessary to have an active location record';
    RETURN;
  END IF;
  SELECT MIN(NR_SEQUENCIA) ID
  INTO STRICT ID_MAN_TIPO_EQUIPAMENTO_W
  FROM MAN_TIPO_EQUIPAMENTO
  WHERE IE_SITUACAO             = 'A'
  AND IE_BOMBA_INFUSAO          = 'S';
  IF (coalesce(ID_MAN_TIPO_EQUIPAMENTO_W::text, '') = '') THEN
    RESULTADO_ERRO := 'Error when inserting equipment, it is necessary to have an active equipment type of infusion pump';
    RETURN;
  END IF;
  SELECT MIN(NR_SEQUENCIA) ID
  INTO STRICT ID_MAN_GRUPO_PLANEJAMENTO_W
  FROM MAN_GRUPO_PLANEJAMENTO
  WHERE IE_SITUACAO               = 'A';
  IF (coalesce(ID_MAN_GRUPO_PLANEJAMENTO_W::text, '') = '') THEN
    RESULTADO_ERRO := 'Error when inserting equipment, it is necessary to have an active planing group record';
    RETURN;
  END IF;
  SELECT MIN(NR_SEQUENCIA) ID
  INTO STRICT ID_MAN_GRUPO_TRABALHO_W
  FROM MAN_GRUPO_TRABALHO
  WHERE IE_SITUACAO           = 'A';
  IF (coalesce(ID_MAN_GRUPO_TRABALHO_W::text, '') = '') THEN
    RESULTADO_ERRO := 'Error when inserting equipment, it is necessary to have an active workgroups record';
    RETURN;
  END IF;

  SELECT nextval('man_equipamento_seq')
  INTO STRICT ID_MAN_EQUIPAMENTO_W
;

  INSERT
  INTO MAN_EQUIPAMENTO(
      NR_SEQUENCIA,
      IE_PARADO,
      DS_EQUIPAMENTO,
      NR_SEQ_LOCAL,
      NR_SEQ_TIPO_EQUIP,
      NR_SEQ_PLANEJ,
      NR_SEQ_TRAB,
      IE_PRIORIDADE,
      IE_ROTINA_SEGURANCA,
      IE_DISPONIBILIDADE,
      IE_SITUACAO,
      IE_CONTROLE_SETOR,
      DT_ATUALIZACAO,
      NM_USUARIO,
      IE_PROPRIEDADE
    )
    VALUES (
      ID_MAN_EQUIPAMENTO_W,
      'N',
      DS_EQUIPAMENTO_W,
      ID_MAN_LOCALIZACAO_W,
      ID_MAN_TIPO_EQUIPAMENTO_W,
      ID_MAN_GRUPO_PLANEJAMENTO_W,
      ID_MAN_GRUPO_TRABALHO_W,
      'P',
      'N',
      'N',
      'A',
      'N',
      clock_timestamp(),
      'Tasy',
      'P'
    );

  SELECT nextval('man_equipamento_bomba_seq')
  INTO STRICT ID_MAN_EQUIPAMENTO_BOMBA_W
;

  INSERT
  INTO MAN_EQUIPAMENTO_BOMBA(
      NR_SEQUENCIA,
      DT_ATUALIZACAO,
      NM_USUARIO,
      DS_DESCRICAO,
      NR_EQUIPAMENTO,
      DS_NUMERO_SERIAL,
      DS_CANAL,
      DS_DEVICE
    )
    VALUES (
      ID_MAN_EQUIPAMENTO_BOMBA_W,
      clock_timestamp(),
      'Tasy',
      SERIAL_W,
      ID_MAN_EQUIPAMENTO_W,
      SERIAL_W,
      CHANNEL_W,
      DS_EQUIPAMENTO_W
    );

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_man_equipamento ( DS_EQUIPAMENTO_W MAN_EQUIPAMENTO.DS_EQUIPAMENTO%TYPE, SERIAL_W MAN_EQUIPAMENTO_BOMBA.DS_NUMERO_SERIAL%TYPE, CHANNEL_W MAN_EQUIPAMENTO_BOMBA.DS_CANAL%TYPE, RESULTADO_ERRO INOUT text, ID_MAN_EQUIPAMENTO_W INOUT integer, ID_MAN_EQUIPAMENTO_BOMBA_W INOUT integer) FROM PUBLIC;

