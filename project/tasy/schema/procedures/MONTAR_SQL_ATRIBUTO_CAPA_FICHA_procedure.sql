-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE montar_sql_atributo_capa_ficha ( nr_seq_valor_p bigint) AS $body$
DECLARE


nm_atributo_w		varchar(50);
nm_tabela_w		varchar(50);
ie_filtro_data_w		varchar(30);
nm_atributo_restricao_w	varchar(255);
ie_restricao_w		varchar(15);
ie_opcao_w		varchar(15);
ds_select_w		varchar(255);
ds_from_w		varchar(255);
ds_where_w		varchar(2000);
ds_where_fixo_w		varchar(2000);
ds_sql_w			varchar(4000);
ds_alias_w		varchar(2);
qt_reg_w			bigint;

qt_restricao_w		bigint;
ie_opcao_ww		varchar(15);
ds_filtro_w		varchar(255);

C01 CURSOR FOR
	SELECT	a.ie_restricao,
		max(a.ie_opcao),
		count(*)
	from	ficha_financ_valor_filtro a
	where	a.nr_seq_valor = nr_seq_valor_p
	group by a.ie_restricao
	order by ie_restricao;

c02 CURSOR FOR
	SELECT	a.ie_opcao
	from	ficha_financ_valor_filtro a
	where	a.nr_seq_valor = nr_seq_valor_p
	and	a.ie_restricao = ie_restricao_w
	order by a.ie_opcao;


BEGIN

select	nm_tabela,
	nm_atributo,
	ie_filtro_data
into STRICT	nm_tabela_w,
	nm_atributo_w,
	ie_filtro_data_w
from	ficha_financ_valor
where	nr_sequencia = nr_seq_valor_p;

if (nm_tabela_w <> 'FUNCTION') then


	if (nm_tabela_w = 'TITULO_RECEBER_LIQ') then
		ds_select_w	:= ' select sum(b.' || nm_atributo_w || ')';
		ds_from_w	:= ' from titulo_receber a, titulo_receber_liq b ';
		ds_where_w	:= ' where a.nr_titulo = b.nr_titulo ';
	elsif (nm_tabela_w = 'CONTA_PACIENTE_DESCONTO') then
		ds_select_w	:= ' select sum(b.' || nm_atributo_w || ')';
		ds_from_w	:= ' from conta_paciente a, conta_paciente_desconto b ';
		ds_where_w	:= ' where a.nr_interno_conta = b.nr_interno_conta ';
	elsif (nm_tabela_w = 'MATERIAL_ATEND_PACIENTE') then
		ds_select_w	:= ' select sum(b.' || nm_atributo_w || ')';
		ds_from_w	:= ' from conta_paciente a, material_atend_paciente b ';
		ds_where_w	:= ' where a.nr_interno_conta = b.nr_interno_conta ';
	elsif (nm_tabela_w = 'PROCEDIMENTO_PACIENTE') then
		ds_select_w	:= ' select sum(b.' || nm_atributo_w || ')';
		ds_from_w	:= ' from conta_paciente a, procedimento_paciente b ';
		ds_where_w	:= ' where a.nr_interno_conta = b.nr_interno_conta ';
	elsif (nm_tabela_w = 'TITULO_PAGAR_BAIXA') then
		ds_select_w	:= ' select sum(b.' || nm_atributo_w || ')';
		ds_from_w	:= ' from titulo_pagar a, titulo_pagar_baixa b ';
		ds_where_w	:= ' where a.nr_titulo = b.nr_titulo ';
	elsif (nm_tabela_w = 'PRE_FATUR_PERDA_CONTA') then
		ds_select_w	:= ' select sum(b.' || nm_atributo_w || ')';
		ds_from_w	:= ' from pre_fatur_perda_conta b, pre_fatur_perda a ';
		ds_where_w	:= ' where b.nr_seq_perda = a.nr_sequencia ';
	else
		ds_select_w	:= ' select sum(' || nm_atributo_w || ')';
		ds_from_w	:= 'from ' || LOWER(nm_tabela_w) || ' a ';
		ds_where_w	:= 'where 1=1 ';
	end if;

	if (nm_tabela_w = 'MOVTO_TRANS_FINANC') then
		ds_where_fixo_w := ds_where_fixo_w || ' and ((cd_pessoa_fisica = :cd_pessoa_fisica) or (cd_cgc = :cd_cgc)) ';
	else
		begin
		ds_where_fixo_w	:= 'and exists (select 1 from w_ficha_financ_consulta x ';

		if	((nm_tabela_w = 'TITULO_RECEBER') or (nm_tabela_w = 'TITULO_RECEBER_LIQ')) then
			ds_where_fixo_w := ds_where_fixo_w || 'where x.nr_titulo_cr = a.nr_titulo ';
		elsif (nm_tabela_w in ('CONTA_PACIENTE', 'CONTA_PACIENTE_DESCONTO', 'MATERIAL_ATEND_PACIENTE',
					'PROCEDIMENTO_PACIENTE')) then
			ds_where_fixo_w := ds_where_fixo_w || 'where x.nr_interno_conta = a.nr_interno_conta ';
		elsif (nm_tabela_w = 'PRE_FATUR_PERDA_CONTA') then
			ds_where_fixo_w := ds_where_fixo_w || 'where x.nr_interno_conta = b.nr_interno_conta ';
		elsif (nm_tabela_w = 'ADIANTAMENTO') then
			ds_where_fixo_w := ds_where_fixo_w || 'where x.nr_adiantamento_cr = a.nr_adiantamento ';
		elsif (nm_tabela_w = 'CHEQUE_CR') then
			ds_where_fixo_w := ds_where_fixo_w || 'where x.nr_seq_cheque_cr = a.nr_seq_cheque ';
		elsif	((nm_tabela_w = 'TITULO_PAGAR') or (nm_tabela_w = 'TITULO_PAGAR_BAIXA')) then
			ds_where_fixo_w := ds_where_fixo_w || 'where x.nr_titulo_cp = a.nr_titulo ';
		elsif (nm_tabela_w = 'ADIANTAMENTO_PAGO') then
			ds_where_fixo_w := ds_where_fixo_w || 'where x.nr_adiantamento_cp = a.nr_adiantamento ';
		elsif (nm_tabela_w = 'REPASSE_TERCEIRO') then
			ds_where_fixo_w := ds_where_fixo_w || 'where x.nr_repasse_terceiro = a.nr_repasse_terceiro ';
		elsif (nm_tabela_w = 'NOTA_CREDITO') then
			ds_where_fixo_w := ds_where_fixo_w || 'where x.nr_seq_nota_credito = a.nr_sequencia ';
		elsif (nm_tabela_w = 'PROTOCOLO_CONVENIO') then
			ds_where_fixo_w := ds_where_fixo_w || 'where x.nr_seq_protocolo = a.nr_seq_protocolo ';
		end if;
		ds_where_fixo_w := ds_where_fixo_w || 'and ((x.cd_pessoa_fisica = :cd_pessoa_fisica) or (x.cd_cgc = :cd_cgc)) and x.nm_usuario = :nm_usuario) ';
		end;
	end if;

	if (ie_filtro_data_w IS NOT NULL AND ie_filtro_data_w::text <> '') then
		begin
		ds_alias_w	:= 'a.';

		if	((nm_tabela_w = 'TITULO_RECEBER_LIQ') or (nm_tabela_w =	'CONTA_PACIENTE_DESCONTO') or (nm_tabela_w =	'MATERIAL_ATEND_PACIENTE') or (nm_tabela_w =	'PROCEDIMENTO_PACIENTE') or (nm_tabela_w =	'TITULO_PAGAR_BAIXA')) then
			select	COUNT(*)
			into STRICT	qt_reg_w
			from	capa_ficha_financ_campos_v
			where	nm_tabela	= nm_tabela_w
			and	nm_atributo	= ie_filtro_data_w;

			if (qt_reg_w > 0) then
				ds_alias_w	:= 'b.';
			end if;
		end if;

		ds_where_w	:= ds_where_w || ' and ' || ds_alias_w || ie_filtro_data_w || ' between :dt_ini and :dt_fim';
		end;
	end if;


	open C01;
	loop
	fetch C01 into
		ie_restricao_w,
		ie_opcao_w,
		qt_restricao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		select	MAX(nm_atributo)
		into STRICT	nm_atributo_restricao_w
		from	capa_ficha_financ_campos_res_v
		where 	nm_tabela	= nm_tabela_w
		and	ie_restricao	= ie_restricao_w
		and	ie_opcao	= TO_CHAR(ie_opcao_w);

		ds_filtro_w := null;

		if (nm_atributo_restricao_w = 'ie_vencido') then
			begin
			if (nm_tabela_w = 'TITULO_PAGAR') then
				ds_filtro_w := 'dt_vencimento_atual';
			elsif (nm_tabela_w = 'TITULO_RECEBER') or (nm_tabela_w = 'TITULO_RECEBER_LIQ') then
				ds_filtro_w := 'dt_pagamento_previsto';
			else
				ds_filtro_w := 'dt_vencimento';
			end if;

			if (ie_opcao_w = 'V') then
				ds_where_w := ds_where_w || ' and trunc('|| ds_filtro_w || ',''dd'') < trunc(sysdate,''dd'') ';
			else
				ds_where_w := ds_where_w || ' and trunc('|| ds_filtro_w || ',''dd'') >= trunc(sysdate, ''dd'') ';
			end if;
			end;
		elsif (nm_atributo_restricao_w = 'ie_vencido_cheque') then
			begin
			if (ie_opcao_w = 'V') then
				ds_filtro_w := ' trunc(sysdate,''dd'') > ';
			else
				ds_filtro_w := ' trunc(sysdate,''dd'') <= ';
			end if;

			ds_where_w := ds_where_w || ' and '||ds_filtro_w||' trunc(nvl(a.dt_vencimento_atual, a.dt_vencimento), ''dd'')';
			end;
		elsif (nm_atributo_restricao_w = 'ie_cancelado') then
			begin
			if (ie_opcao_w = 'N') then
				ds_filtro_w := ' is null';
			else
				ds_filtro_w := ' is not null';
			end if;

			ds_where_w := ds_where_w || ' and a.ie_cancelamento ' || ds_filtro_w;
			end;
		elsif (nm_atributo_restricao_w = 'ie_nota_fiscal') then
			begin
			if (ie_opcao_w = 'N') then
				ds_filtro_w := ' is null';
			else
				ds_filtro_w := ' is not null';
			end if;

			ds_where_w := ds_where_w || ' and obter_nf_conta(a.nr_interno_conta, 7) ' || ds_filtro_w;
			end;
		else
			begin
			if (qt_restricao_w > 1) then
				open C02;
				loop
				fetch C02 into
					ie_opcao_ww;
				EXIT WHEN NOT FOUND; /* apply on C02 */
					begin
					ds_filtro_w := ds_filtro_w || ',' || ''''||TO_CHAR(ie_opcao_ww)||'''';
					end;
				end loop;
				close C02;
			end if;

			if (ds_filtro_w IS NOT NULL AND ds_filtro_w::text <> '') then
				begin
				ds_filtro_w := substr(ds_filtro_w,2,255);
				ds_filtro_w := ' in ('||ds_filtro_w||')';
				end;
			else
				ds_filtro_w := ' = ' || ''''||TO_CHAR(ie_opcao_w)||'''';
			end if;

			ds_where_w	:= ds_where_w || ' and ' || nm_atributo_restricao_w || ds_filtro_w;

			if (substr(lower(nm_atributo_restricao_w),1,6) = 'exists') then
				ds_where_w	:= ds_where_w || ')';
			end if;
			end;
		end if;
		end;
	end loop;
	close C01;
else
	begin
	ds_from_w 	:= 'from dual ';
	ds_where_w 	:= '';
	ds_where_fixo_w := '';

	ds_select_w := 'select fin_obter_valor_receb('''||TO_CHAR(nm_atributo_w)||''', :dt_ini, :dt_fim, :cd_pessoa_fisica, :cd_cgc, :cd_estabelecimento, :nm_usuario) ';

	end;
end if;


ds_sql_w := ds_select_w || ' ' || ds_from_w || ' ' || ds_where_w || ' ' || ds_where_fixo_w;

update	ficha_financ_valor
set	ds_sql = SUBSTR(ds_sql_w,1,4000)
where	nr_sequencia = nr_seq_valor_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE montar_sql_atributo_capa_ficha ( nr_seq_valor_p bigint) FROM PUBLIC;

