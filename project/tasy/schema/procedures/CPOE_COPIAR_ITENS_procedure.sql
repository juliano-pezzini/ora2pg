-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_copiar_itens ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, dt_referencia_p timestamp, nm_usuario_p usuario.nm_usuario%type, cd_perfil_p perfil.cd_perfil%type, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type default null, ie_tipo_item_copia_fut_p text default 'N', ie_adep_p text default 'S', dt_inicio_copia_p timestamp default null) AS $body$
DECLARE


_ora2pg_r RECORD;
ds_item_prescricao_w			varchar(4000);
nm_usuario_lib_enf_w			usuario.nm_usuario%type;
cd_farmac_lib_w					cpoe_material.cd_farmac_lib%type;
nr_horas_copia_w				bigint := 0;
ie_inconsistencia_out_w			varchar(2000);
nr_prescricao_w					prescr_medica.nr_prescricao%type;
ie_susp_prescricoes_alta_w		varchar(1);
dt_prim_horario_w				timestamp;
dt_referencia_w					timestamp;
ie_copia_sem_lib_enf_farm_w		varchar(1) := 'N';
cd_setor_atendimento_w			cpoe_material.cd_setor_atendimento%type;
ie_motivo_prescricao_w			prescr_medica.ie_motivo_prescricao%type;
ds_exception_w					varchar(2000);
ds_prescricoes_geradas_w 		varchar(4000);
qt_hors_before_w				smallint;
dt_inicio_regra_w				timestamp;
dt_fim_regra_w					timestamp;
is_antecipated_batch_w			varchar(1);
dt_prox_geracao_w				timestamp;
is_antecipated_item_w			varchar(1);
sql_w               varchar(300);
dt_ref_copia_w				timestamp;

/*LISTAGG e usada para concatenar colunas e linhas em uma unica coluna/linha, alteramos para esse metodo para simplificar a forma antiga. OS 1741732*/


/*NAO DEVE SER UTILIZADO O LISTAGG DEVIDO A LIMITACAO DO ORACLE 10g. CRIADA PACKAGE CPOE_LISTAGG_PCK COMO ALTERNATIVA */

c01 CURSOR FOR
SELECT cpoe_listagg_pck.tab_to_string(cast(collect(ie_tipo_item || ',' || nr_sequencia) as strarray)) ds_itens,
      nm_usuario_lib_enf,
      cd_farmac_lib,
      min(dt_prim_horario) dt_prim_horario,
      cd_setor_atendimento,
      ie_motivo_prescricao,
	  dt_prox_geracao,
	  is_antecipated_item
from	(
		SELECT	'M' ie_tipo_item,
				a.nr_sequencia,
				a.nm_usuario_lib_enf,
				a.cd_farmac_lib,
				get_concatenated_date(dt_referencia_w, a.hr_prim_horario,'M',nr_horas_copia_w, dt_inicio_copia_p, a.cd_intervalo) dt_prim_horario,
				coalesce(a.cd_setor_atendimento, cpoe_obter_setor_atend_prescr(a.nr_atendimento, cd_estabelecimento_p, a.cd_perfil_ativo, a.nm_usuario_nrec)) cd_setor_atendimento,
				a.ie_motivo_prescricao,
				null dt_prox_geracao,
				null is_antecipated_item
		from	cpoe_material a
		where	((CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= (a.dt_prox_geracao + (nr_horas_copia_w/24))) or (CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
		and		a.nm_usuario_nrec = nm_usuario_p
		and		a.dt_prox_geracao between dt_referencia_p - 3 and dt_referencia_p - 1/86400
		and   	coalesce(a.si_dispensation_criteria, 'D') <> 'S'
		and		a.nr_atendimento = nr_atendimento_p
		and		coalesce(a.cd_perfil_ativo, cd_perfil_p) = cd_perfil_p
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		coalesce(a.nr_seq_receita_amb,0) = 0
		and		ie_tipo_item_copia_fut_p = 'N'
		and		coalesce(ie_adep,'S') = coalesce(ie_adep_p,'S')
		and		coalesce(a.ie_retrogrado,'N') = 'N'
		and		((((coalesce(a.ie_evento_unico,'N') = 'N') and (coalesce(a.nr_seq_adicional::text, '') = '') and (coalesce(a.nr_seq_ataque::text, '') = '')) and (coalesce(a.ie_material,'N') = 'N')) or (not exists (	select	1
								from	prescr_medica y,
										prescr_material z
								where	y.nr_prescricao = z.nr_prescricao
								and		y.nr_atendimento = nr_atendimento_p
								and		z.nr_seq_mat_cpoe = a.nr_sequencia )))		
		and 	((ie_susp_prescricoes_alta_w = 'S') or (((coalesce(a.ie_baixado_por_alta, 'N') = 'N') or (coalesce(a.dt_alta_medico, clock_timestamp()) > a.dt_prox_geracao + (nr_horas_copia_w/24)))))
		and		coalesce(a.cd_funcao_origem,2314) = 2314
		and		((cpoe_obter_se_copia_item_term(a.ds_horarios, a.cd_intervalo, a.dt_prox_geracao + (nr_horas_copia_w/24), CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) END ) = 'S') or ((coalesce(a.dt_fim::text, '') = '') and a.ie_duracao = 'C'))
		
union all

		select	'M' ie_tipo_item,
				a.nr_sequencia,
				a.nm_usuario_lib_enf,
				a.cd_farmac_lib,
				get_concatenated_date(dt_referencia_w, a.hr_prim_horario,'M',nr_horas_copia_w, dt_inicio_copia_p, a.cd_intervalo) dt_prim_horario,
				coalesce(a.cd_setor_atendimento, cpoe_obter_setor_atend_prescr(a.nr_atendimento, cd_estabelecimento_p, a.cd_perfil_ativo, a.nm_usuario_nrec)) cd_setor_atendimento,
				a.ie_motivo_prescricao,
				a.dt_prox_geracao,
				'S' is_antecipated_item
		from	cpoe_material a
		where	((CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= (a.dt_prox_geracao + (nr_horas_copia_w/24))) or (CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
		and		a.dt_prox_geracao between dt_inicio_regra_w - (nr_horas_copia_w/24)  and dt_fim_regra_w - (nr_horas_copia_w/24) - 1/86400
		and		dt_referencia_p > (dt_inicio_regra_w - 1)
		and		a.nr_atendimento = nr_atendimento_p
		and 	coalesce(is_antecipated_batch_w, 'N') = 'Y'
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		coalesce(a.nr_seq_receita_amb,0) = 0
		and		ie_tipo_item_copia_fut_p = 'N'
		and		coalesce(ie_adep,'S') = coalesce(ie_adep_p,'S')
		and		coalesce(a.ie_retrogrado,'N') = 'N'
		and		((((coalesce(a.ie_evento_unico,'N') = 'N') and (coalesce(a.nr_seq_adicional::text, '') = '') and (coalesce(a.nr_seq_ataque::text, '') = '')) and (coalesce(a.ie_material,'N') = 'N')) or (not exists (	select	1
								from	prescr_medica y,
										prescr_material z
								where	y.nr_prescricao = z.nr_prescricao
								and		y.nr_atendimento = nr_atendimento_p
								and		z.nr_seq_mat_cpoe = a.nr_sequencia )))		
		and 	((ie_susp_prescricoes_alta_w = 'S') or (((coalesce(a.ie_baixado_por_alta, 'N') = 'N') or (coalesce(a.dt_alta_medico, clock_timestamp()) > a.dt_prox_geracao + (nr_horas_copia_w/24)))))
		and		coalesce(a.cd_funcao_origem,2314) = 2314
		and		((cpoe_obter_se_copia_item_term(a.ds_horarios, a.cd_intervalo, a.dt_prox_geracao + (nr_horas_copia_w/24), CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) END ) = 'S') or ((coalesce(a.dt_fim::text, '') = '') and a.ie_duracao = 'C'))
		
union all

		select	'N' ie_tipo_item,
				a.nr_sequencia,
				a.nm_usuario_lib_enf,
				a.cd_farmac_lib,
				get_concatenated_date(dt_referencia_w, a.hr_prim_horario,'N',nr_horas_copia_w, dt_inicio_copia_p, null) dt_prim_horario,
				coalesce(a.cd_setor_atendimento, cpoe_obter_setor_atend_prescr(a.nr_atendimento, cd_estabelecimento_p, a.cd_perfil_ativo, a.nm_usuario_nrec)) cd_setor_atendimento,
				a.ie_motivo_prescricao,
				null dt_prox_geracao,
				null is_antecipated_item
		from	cpoe_dieta a
		where	((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= (a.dt_prox_geracao + (nr_horas_copia_w/24))) or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
		and		a.nm_usuario_nrec = nm_usuario_p
		and		a.dt_prox_geracao between dt_referencia_p - 3 and dt_referencia_p - 1/86400
		and		a.nr_atendimento = nr_atendimento_p
		and		coalesce(a.cd_perfil_ativo, cd_perfil_p) = cd_perfil_p
		and		((ie_tipo_item_copia_fut_p = 'N') or (a.ie_tipo_dieta = 'O'))
		and		coalesce(ie_adep,'S') = coalesce(ie_adep_p,'S')
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		coalesce(a.ie_retrogrado,'N') = 'N'
		and		((coalesce(a.ie_evento_unico,'N') = 'N') or (not exists (	select	1
								from	prescr_medica y
								where	y.nr_atendimento = nr_atendimento_p
								and		exists (	select	1
													from	prescr_material z
													where	z.nr_prescricao = y.nr_prescricao
													and		z.nr_seq_dieta_cpoe = a.nr_sequencia
													
union

													select	1
													from	prescr_dieta z
													where	z.nr_prescricao = y.nr_prescricao
													and		z.nr_seq_dieta_cpoe = a.nr_sequencia
													
union

													select	1
													from	rep_jejum z
													where	z.nr_prescricao = y.nr_prescricao
													and		z.nr_seq_dieta_cpoe = a.nr_sequencia
													
union

													select	1
													from	prescr_leite_deriv z
													where	z.nr_prescricao = y.nr_prescricao
													and		z.nr_seq_dieta_cpoe = a.nr_sequencia
													
union

													select	1
													from	nut_pac z
													where	z.nr_prescricao = y.nr_prescricao
													and		z.nr_seq_npt_cpoe = a.nr_sequencia))))
		and		coalesce(a.ie_dose_unica,'N') = 'N'
		and 	((ie_susp_prescricoes_alta_w = 'S') or (((coalesce(a.ie_baixado_por_alta, 'N') = 'N') or (coalesce(a.dt_alta_medico, clock_timestamp()) > a.dt_prox_geracao + (nr_horas_copia_w/24)))))
		and		coalesce(a.cd_funcao_origem,2314) = 2314
		and		((cpoe_obter_se_copia_item_term(a.ds_horarios, a.cd_intervalo, a.dt_prox_geracao + (nr_horas_copia_w/24), CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END ) = 'S') or ((coalesce(a.dt_fim::text, '') = '') and a.ie_duracao = 'C'))
		
union all

		select	'R' ie_tipo_item,
				a.nr_sequencia,
				a.nm_usuario_lib_enf,
				a.cd_farmac_lib,
				get_concatenated_date(dt_referencia_w, a.hr_prim_horario,'R',nr_horas_copia_w, dt_inicio_copia_p, null) dt_prim_horario,
				coalesce(a.cd_setor_atendimento, cpoe_obter_setor_atend_prescr(a.nr_atendimento, cd_estabelecimento_p, a.cd_perfil_ativo, a.nm_usuario_nrec)) cd_setor_atendimento,
				a.ie_motivo_prescricao,
				null dt_prox_geracao,
				null is_antecipated_item
		from	cpoe_recomendacao a
		where	((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= (a.dt_prox_geracao + (nr_horas_copia_w/24))) or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
		and		a.nm_usuario_nrec = nm_usuario_p
		and		a.dt_prox_geracao between dt_referencia_p - 3 and dt_referencia_p - 1/86400
		and		a.nr_atendimento = nr_atendimento_p
		and		coalesce(a.cd_perfil_ativo, cd_perfil_p) = cd_perfil_p
		and		ie_tipo_item_copia_fut_p = 'N'
		and		coalesce(ie_adep,'S') = coalesce(ie_adep_p,'S')
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		coalesce(a.ie_retrogrado,'N') = 'N'
		and		((coalesce(a.ie_evento_unico,'N') = 'N') or (not exists (	select	1
								from	prescr_medica y,
										prescr_recomendacao z
								where	y.nr_prescricao = z.nr_prescricao
								and		y.nr_atendimento = nr_atendimento_p
								and		z.nr_seq_rec_cpoe = a.nr_sequencia)))
		and 	((ie_susp_prescricoes_alta_w = 'S') or (((coalesce(a.ie_baixado_por_alta, 'N') = 'N') or (coalesce(a.dt_alta_medico, clock_timestamp()) > a.dt_prox_geracao + (nr_horas_copia_w/24)))))
		and		coalesce(a.cd_funcao_origem,2314) = 2314
		and		((cpoe_obter_se_copia_item_term(a.ds_horarios, a.cd_intervalo, a.dt_prox_geracao + (nr_horas_copia_w/24), CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END ) = 'S') or ((coalesce(a.dt_fim::text, '') = '') and a.ie_duracao = 'C'))
		
union all

		select	'G' ie_tipo_item,
				a.nr_sequencia,
				a.nm_usuario_lib_enf,
				a.cd_farmac_lib,
				get_concatenated_date(dt_referencia_w, a.hr_prim_horario,'G',nr_horas_copia_w, dt_inicio_copia_p, null) dt_prim_horario,
				coalesce(a.cd_setor_atendimento, cpoe_obter_setor_atend_prescr(a.nr_atendimento, cd_estabelecimento_p, a.cd_perfil_ativo, a.nm_usuario_nrec)) cd_setor_atendimento,
				a.ie_motivo_prescricao,
				null dt_prox_geracao,
				null is_antecipated_item
		from	cpoe_gasoterapia a
		where	((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= (a.dt_prox_geracao + (nr_horas_copia_w/24))) or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
		and		a.nm_usuario_nrec = nm_usuario_p
		and		a.dt_prox_geracao between dt_referencia_p - 3 and dt_referencia_p - 1/86400
		and		a.nr_atendimento = nr_atendimento_p
		and		coalesce(a.cd_perfil_ativo, cd_perfil_p) = cd_perfil_p
		and		ie_tipo_item_copia_fut_p = 'N'
		and		coalesce(ie_adep,'S') = coalesce(ie_adep_p,'S')
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		coalesce(a.ie_retrogrado,'N') = 'N'
		and 	((ie_susp_prescricoes_alta_w = 'S') or (((coalesce(a.ie_baixado_por_alta, 'N') = 'N') or (coalesce(a.dt_alta_medico, clock_timestamp()) > a.dt_prox_geracao + (nr_horas_copia_w/24)))))
		and		coalesce(a.cd_funcao_origem,2314) = 2314
		and		((cpoe_obter_se_copia_item_term(a.ds_horarios, a.cd_intervalo, a.dt_prox_geracao + (nr_horas_copia_w/24), CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END ) = 'S') or ((coalesce(a.dt_fim::text, '') = '') and a.ie_duracao = 'C'))
		
union all

		select	'P' ie_tipo_item,
				a.nr_sequencia,
				a.nm_usuario_lib_enf,
				a.cd_farmac_lib,
				get_concatenated_date(dt_referencia_p - (qt_hors_before_w/24), a.hr_prim_horario,'P',nr_horas_copia_w, dt_inicio_copia_p, null) dt_prim_horario,
				coalesce(a.cd_setor_liberacao, a.cd_setor_atendimento, cpoe_obter_setor_atend_prescr(a.nr_atendimento, cd_estabelecimento_p, a.cd_perfil_ativo, a.nm_usuario_nrec)) cd_setor_atendimento,
				a.ie_motivo_prescricao,
				null dt_prox_geracao,
				null is_antecipated_item
		from	cpoe_procedimento a
		where	((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= (a.dt_prox_geracao + (nr_horas_copia_w/24))) or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
		and		a.nm_usuario_nrec = nm_usuario_p
		and		a.dt_prox_geracao between dt_referencia_p - 3 and dt_referencia_p - 1/86400
		and		a.nr_atendimento = nr_atendimento_p
		and		coalesce(a.cd_perfil_ativo, cd_perfil_p) = cd_perfil_p
		and		ie_tipo_item_copia_fut_p = 'N'
		and		coalesce(ie_adep,'S') = coalesce(ie_adep_p,'S')
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		coalesce(a.ie_retrogrado,'N') = 'N'
		and		((coalesce(a.ie_evento_unico,'N') = 'N' and consiste_se_copia_proc_int(a.nr_seq_proc_interno) = 'S') or (not exists (	select	1
								from	prescr_medica y,
										prescr_procedimento z
								where	y.nr_prescricao = z.nr_prescricao
								and		y.nr_atendimento = nr_atendimento_p
								and		z.nr_seq_proc_cpoe = a.nr_sequencia)))
		and 	((ie_susp_prescricoes_alta_w = 'S') or (((coalesce(a.ie_baixado_por_alta, 'N') = 'N') or (coalesce(a.dt_alta_medico, clock_timestamp()) > a.dt_prox_geracao + (nr_horas_copia_w/24)))))
		and		coalesce(a.cd_funcao_origem,2314) = 2314
		and		((cpoe_obter_se_copia_item_term(a.ds_horarios, a.cd_intervalo, a.dt_prox_geracao + (nr_horas_copia_w/24), CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END ) = 'S') or ((coalesce(a.dt_fim::text, '') = '') and a.ie_duracao = 'C'))
		
union all

		select	'D' ie_tipo_item,
				a.nr_sequencia,
				a.nm_usuario_lib_enf,
				a.cd_farmac_lib,
				get_concatenated_date(dt_referencia_w, to_char(a.dt_inicio,'hh24:mi'),'D',nr_horas_copia_w, dt_inicio_copia_p, null) dt_prim_horario,
				coalesce(a.cd_setor_atendimento, cpoe_obter_setor_atend_prescr(a.nr_atendimento, cd_estabelecimento_p, a.cd_perfil_ativo, a.nm_usuario_nrec)) cd_setor_atendimento,
				a.ie_motivo_prescricao,
				null dt_prox_geracao,
				null is_antecipated_item
		from	cpoe_dialise a
		where	((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= (a.dt_prox_geracao + (nr_horas_copia_w/24))) or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
		and		a.nm_usuario_nrec = nm_usuario_p
		and		a.dt_prox_geracao between dt_referencia_p - 3 and dt_referencia_p - 1/86400
		and		a.nr_atendimento = nr_atendimento_p
		and		coalesce(a.cd_perfil_ativo, cd_perfil_p) = cd_perfil_p
		and		ie_tipo_item_copia_fut_p = 'N'
		and		coalesce(ie_adep,'S') = coalesce(ie_adep_p,'S')
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		coalesce(a.ie_retrogrado,'N') = 'N'
		and		((coalesce(a.ie_evento_unico,'N') = 'N') or (not exists (	select	1
								from	prescr_medica y,
										hd_prescricao z
								where	y.nr_prescricao = z.nr_prescricao
								and		y.nr_atendimento = nr_atendimento_p
								and		z.nr_seq_dialise_cpoe = a.nr_sequencia)))
		and 	((ie_susp_prescricoes_alta_w = 'S') or (((coalesce(a.ie_baixado_por_alta, 'N') = 'N') or (coalesce(a.dt_alta_medico, clock_timestamp()) > a.dt_prox_geracao + (nr_horas_copia_w/24)))))
		and		coalesce(a.cd_funcao_origem,2314) = 2314
		and		((cpoe_obter_se_copia_item_term(a.ds_horarios, null, a.dt_prox_geracao + (nr_horas_copia_w/24), CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END ) = 'S') or ((coalesce(a.dt_fim::text, '') = '') and a.ie_duracao = 'C'))) alias336
group by nm_usuario_lib_enf, cd_farmac_lib, cd_setor_atendimento, ie_motivo_prescricao, dt_prox_geracao, is_antecipated_item
order by is_antecipated_item desc, cd_setor_atendimento, nm_usuario_lib_enf, cd_farmac_lib, dt_prim_horario, ie_motivo_prescricao;


procedure adjust_properties_nls is
	;
BEGIN
	EXECUTE 'ALTER SESSION SET NLS_LANGUAGE=''BRAZILIAN PORTUGUESE''';
	EXECUTE 'ALTER SESSION SET NLS_TERRITORY = ''BRAZIL''';
	EXECUTE 'ALTER SESSION SET NLS_NUMERIC_CHARACTERS='',.''';
	EXECUTE 'ALTER SESSION SET NLS_DATE_FORMAT = ''DD/MM/YYYY HH24:MI:SS''';
	end;
	
procedure copia_verif_intera_med is
	ds_item_prescricao_ww			varchar2(4000);
	nr_sequencia_w					number(10);
	begin
	ds_item_prescricao_ww := replace(ds_item_prescricao_w, ' ', '');
	
	for i in 1..length(ds_item_prescricao_ww) loop
		nr_sequencia_w := substr(ds_item_prescricao_ww, position(',' in ds_item_prescricao_ww) + 1, position(';' in ds_item_prescricao_ww) - 3);		
		ds_item_prescricao_ww := substr(ds_item_prescricao_ww, position(';' in ds_item_prescricao_ww ) + 1, length(ds_item_prescricao_ww));
		CALL cpoe_copia_verif_intera_med(nr_sequencia_w,nr_atendimento_p,cd_perfil_p,cd_estabelecimento_p,nm_usuario_p);
	end loop;
		
	exception when others then	
		ds_exception_w := substr(to_char(sqlerrm),1,2000);
		
		CALL gravar_log_cpoe(substr('CPOE_COPIA_VERIF_INTERA_MED EXCEPTION: ' || ds_exception_w ||
				' ds_item_prescricao_ww: ' || ds_item_prescricao_ww ||
				' nr_sequencia_w: ' || nr_sequencia_w ||
				' cd_perfil_p: ' || cd_perfil_p,1,2000),
				nr_atendimento_p);
	end;
		
begin

CALL gravar_log_cpoe('CPOE_COPIAR_ITENS - DT_REFERENCIA_P: '||to_char(dt_referencia_p,'dd/mm/yyyy hh24:mi:ss'), nr_atendimento_p);

adjust_properties_nls;
ie_susp_prescricoes_alta_w := Obter_param_Usuario(3111, 162, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_susp_prescricoes_alta_w);

  begin
      sql_w := 'CALL GET_QT_HOURS_AFTER_COPY_CPOE(:1, :2, :3) INTO :nr_horas_copia_w';
      EXECUTE sql_w USING IN cd_perfil_p,
                                    IN nm_usuario_p,
                                    IN cd_estabelecimento_p,
                                    OUT nr_horas_copia_w;

  exception
    when others then
      nr_horas_copia_w := null;
  end;

  begin
      sql_w := 'CALL GET_QT_HOURS_BEFORE_COPY(:1, :2, :3) INTO :qt_hors_before_w';
      EXECUTE sql_w USING IN cd_perfil_p,
                                    IN nm_usuario_p,
                                    IN cd_estabelecimento_p,
                                    OUT qt_hors_before_w;

  exception
    when others then
      qt_hors_before_w := null;
  end;

  begin
      sql_w := 'CALL OBTER_DATA_REF_COPIA_CPOE_MD(:1, :2, :3) INTO :dt_referencia_w';
      EXECUTE sql_w USING IN dt_referencia_p,
                                    IN qt_hors_before_w,
                                    IN nr_horas_copia_w,
                                    OUT dt_referencia_w;

  exception
    when others then
      dt_referencia_w := null;
  end;

  
  begin
      sql_w := 'CALL OBTER_HORA_REF_COPIA_CPOE_MD(:1, :2) INTO :dt_ref_copia_w';
	  EXECUTE sql_w USING IN dt_referencia_w,	
                                    IN qt_hors_before_w,
                                    OUT dt_ref_copia_w;

  exception
    when others then
      dt_ref_copia_w := null;
  end;


SELECT * FROM cpoe_get_antecipated_batch(dt_ref_copia_w, cd_estabelecimento_p, cd_setor_atendimento_p) INTO STRICT _ora2pg_r;
 is_antecipated_batch_w := _ora2pg_r.si_anticipation_p; dt_inicio_regra_w := _ora2pg_r.dt_inicio_p; dt_fim_regra_w := _ora2pg_r.dt_fim_p;


open c01;
loop
fetch c01 into
	ds_item_prescricao_w,
	nm_usuario_lib_enf_w,
	cd_farmac_lib_w,
	dt_prim_horario_w,
	cd_setor_atendimento_w,
	ie_motivo_prescricao_w,
	dt_prox_geracao_w,
	is_antecipated_item_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	adjust_properties_nls;

	if (ds_item_prescricao_w IS NOT NULL AND ds_item_prescricao_w::text <> '') then		
		copia_verif_intera_med();
		if (coalesce(nm_usuario_lib_enf_w::text, '') = '' and coalesce(cd_farmac_lib_w::text, '') = '') then
			ie_copia_sem_lib_enf_farm_w := 'S';
		end if;
			
		if (coalesce(is_antecipated_item_w, 'N') = 'S') then
			SELECT * FROM gerar_prescr_antecip(
						cd_setor_atendimento_w, dt_prox_geracao_w, dt_inicio_regra_w, dt_fim_regra_w, dt_prox_geracao_w + nr_horas_copia_w/24, nr_atendimento_p, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, ds_item_prescricao_w, ie_inconsistencia_out_w, cd_pessoa_fisica_p, 'S', 'N', ie_motivo_prescricao_w, 'N', nr_prescricao_w, null, null, null, ie_copia_sem_lib_enf_farm_w, ie_adep_p, null, ds_prescricoes_geradas_w, nm_usuario_lib_enf_w, cd_farmac_lib_w) INTO STRICT ie_inconsistencia_out_w, nr_prescricao_w, ds_prescricoes_geradas_w;
		else
			SELECT * FROM cpoe_gerar_prescricao(
							nr_atendimento_p, dt_prim_horario_w, cd_estabelecimento_p, cd_perfil_p, cd_setor_atendimento_w, nm_usuario_p, ds_item_prescricao_w, cd_pessoa_fisica_p, 'S', 'N', ie_motivo_prescricao_w, 'N', null, null, null, ie_copia_sem_lib_enf_farm_w, ie_adep_p, null, nm_usuario_lib_enf_w, cd_farmac_lib_w) INTO STRICT IE_INCONSISTENCIA_OUT_w, nr_prescricao_w, ds_prescricoes_geradas_w;
			
			ie_copia_sem_lib_enf_farm_w := 'N';
			
			
		end if;
		
	end if;
	
end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_copiar_itens ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, dt_referencia_p timestamp, nm_usuario_p usuario.nm_usuario%type, cd_perfil_p perfil.cd_perfil%type, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type default null, ie_tipo_item_copia_fut_p text default 'N', ie_adep_p text default 'S', dt_inicio_copia_p timestamp default null) FROM PUBLIC;

