-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE replicar_ficha_tecnica_estab (nr_ficha_tecnica_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


--Ficha t√©cnica
nr_ficha_tecnica_copia_w            	ficha_tecnica.nr_ficha_tecnica%type;
cd_estabelecimento_ficha_w    	ficha_tecnica.cd_estabelecimento%type;
cd_material_ficha_w               		ficha_tecnica.cd_material%type;
ie_situacao_ficha_w                	ficha_tecnica.ie_situacao%type;
nr_nivel_estrutura_ficha_w		ficha_tecnica.nr_nivel_estrutura%type;
ie_origem_proced_ficha_w		ficha_tecnica.ie_origem_proced%type;
cd_procedimento_ficha_w 		ficha_tecnica.cd_procedimento%type;
qt_lote_padrao_ficha_w    		ficha_tecnica.qt_lote_padrao%type;
cd_centro_controle_ficha_w   	ficha_tecnica.cd_centro_controle%type;
ie_calcula_conta_ficha_w       	ficha_tecnica.ie_calcula_conta%type;
nr_seq_proc_interno_ficha_w  	ficha_tecnica.nr_seq_proc_interno%type;
ds_observacao_ficha_w           	ficha_tecnica.ds_observacao%type;
ie_tipo_ficha_ficha_w             		ficha_tecnica.ie_tipo_ficha%type;
ie_solicita_componente_ficha_w   	ficha_tecnica.ie_solicita_componente%type;
nr_seq_exame_ficha_w                	ficha_tecnica.nr_seq_exame%type;
cd_setor_atendimento_ficha_w     	ficha_tecnica.cd_setor_atendimento%type;
qt_alerta_estabilidade_ficha_w      	ficha_tecnica.qt_alerta_estabilidade%type;
ie_revisado_ficha_w                    	ficha_tecnica.ie_revisado%type;

--Componentes da ficha tecnica
nr_ficha_tecnica_comp_w             ficha_tecnica_componente.nr_ficha_tecnica%type;
cd_material_comp_w                  ficha_tecnica_componente.cd_material%type;
qt_material_comp_w                  ficha_tecnica_componente.qt_material%type;
ie_situacao_comp_w                  ficha_tecnica_componente.ie_situacao%type;
nr_seq_proc_interno_comp_w    ficha_tecnica_componente.nr_seq_proc_interno%type;
ie_tipo_componente_comp_w     ficha_tecnica_componente.ie_tipo_componente%type;
cd_procedimento_comp_w        ficha_tecnica_componente.cd_procedimento%type;
ie_origem_proced_comp_w       ficha_tecnica_componente.ie_origem_proced%type;
cd_centro_controle_comp_w     ficha_tecnica_componente.cd_centro_controle%type;
qt_fixa_comp_w                      ficha_tecnica_componente.qt_fixa%type;
qt_variavel_comp_w                 ficha_tecnica_componente.qt_variavel%type;
pr_quebra_variavel_comp_w     ficha_tecnica_componente.pr_quebra_variavel%type;
qt_dose_comp_w                   ficha_tecnica_componente.qt_dose%type;
cd_unidade_medida_dose_comp_w ficha_tecnica_componente.cd_unidade_medida_dose%type;
ie_necessita_disp_comp_w         ficha_tecnica_componente.ie_necessita_disp%type;
nr_seq_exame_comp_w           ficha_tecnica_componente.nr_seq_exame%type;
dt_inicio_vigencia_comp_w     ficha_tecnica_componente.dt_inicio_vigencia%type;
dt_fim_vigencia_comp_w        ficha_tecnica_componente.dt_fim_vigencia%type;
nr_seq_componente_copia_w  ficha_tecnica_componente.nr_seq_componente%type;
nr_seq_comp_estab_copia_w  ficha_tecnica_componente.nr_seq_componente%type;

--Regra dos componentes da ficha tecnica
cd_estabelecimento_regra_w ficha_tecnica_comp_regra.cd_estabelecimento%type;
cd_pessoa_fisica_regra_w      ficha_tecnica_comp_regra.cd_pessoa_fisica%type;
ie_situacao_regra_w              ficha_tecnica_comp_regra.ie_situacao%type;
cd_perfil_regra_w                 ficha_tecnica_comp_regra.cd_perfil%type;
ie_visualiza_regra_w             ficha_tecnica_comp_regra.ie_visualiza%type;

--Estabelecimento
cd_estabelecimento_copia_w    estabelecimento.cd_estabelecimento%type;

c01 CURSOR FOR
	SELECT   a.cd_estabelecimento cd_estabelecimento_ficha,
               a.cd_material cd_material_ficha,
               a.ie_situacao ie_situacao_ficha,
               coalesce(nr_nivel_estrutura,1) nr_nivel_estrutura_ficha,
               ie_origem_proced ie_origem_proced_ficha,
               cd_procedimento cd_procedimento_ficha,
               coalesce(qt_lote_padrao,1) qt_lote_padrao_ficha,
               cd_centro_controle cd_centro_controle_ficha,
               coalesce(ie_calcula_conta,'S') ie_calcula_conta_ficha,
               nr_seq_proc_interno nr_seq_proc_interno_ficha,
               ds_observacao ds_observacao_ficha,
               coalesce(ie_tipo_ficha,'C') ie_tipo_ficha_ficha,
               coalesce(ie_solicita_componente, 'N') ie_solicita_componente_ficha,
               nr_seq_exame nr_seq_exame_ficha,
               cd_setor_atendimento cd_setor_atendimento_ficha,
               qt_alerta_estabilidade qt_alerta_estabilidade_ficha,
               coalesce(ie_revisado, 'N') ie_revisado_ficha
	from		ficha_tecnica a
	where	a.nr_ficha_tecnica 	 	= nr_ficha_tecnica_p
	and		a.cd_estabelecimento 	= cd_estabelecimento_p;

c02 CURSOR FOR
	SELECT	b.nr_ficha_tecnica nr_ficha_tecnica_comp,
               b.cd_material cd_material_comp,
               b.qt_material qt_material_comp,
               coalesce(b.ie_situacao,'A') ie_situacao_comp,
               b.nr_seq_proc_interno nr_seq_proc_interno_comp,
               coalesce(b.ie_tipo_componente,1) ie_tipo_componente_comp,
               b.cd_procedimento cd_procedimento_comp,
               b.ie_origem_proced ie_origem_proced_comp,
               b.cd_centro_controle cd_centro_controle_comp,
               coalesce(b.qt_fixa,0) qt_fixa_comp,
               coalesce(b.qt_variavel,0) qt_variavel_comp,
               coalesce(b.pr_quebra_variavel,0) pr_quebra_variavel_comp,
               b.qt_dose qt_dose_comp,
               b.cd_unidade_medida_dose cd_unidade_medida_dose_comp,
               coalesce(b.ie_necessita_disp,'S') ie_necessita_disp_comp,
               b.nr_seq_exame nr_seq_exame_comp,
               b.dt_inicio_vigencia dt_inicio_vigencia_comp,
               b.dt_fim_vigencia dt_fim_vigencia_comp,
               b.nr_seq_componente nr_seq_componente_copia
	from		ficha_tecnica_componente b
	where	b.nr_ficha_tecnica = nr_ficha_tecnica_p;

c03 CURSOR FOR
	SELECT	cd_estabelecimento cd_estabelecimento_regra,
               cd_pessoa_fisica	cd_pessoa_fisica_regra,
               coalesce(ie_situacao,'A') ie_situacao_regra,
               cd_perfil cd_perfil_regra,
               ie_visualiza ie_visualiza_regra
	from		ficha_tecnica_comp_regra
	where	nr_ficha_tecnica	     = nr_ficha_tecnica_p
	and		nr_seq_componente = nr_seq_componente_copia_w;

c04 CURSOR FOR
	SELECT	a.cd_estabelecimento
	from	   estabelecimento a
   where   	coalesce(a.ie_situacao, 'A')  = 'A'
   and      cd_estabelecimento <> cd_estabelecimento_p;


BEGIN
open C01;
loop
fetch C01 into
	cd_estabelecimento_ficha_w,
	cd_material_ficha_w,
	ie_situacao_ficha_w,
	nr_nivel_estrutura_ficha_w,
	ie_origem_proced_ficha_w,
	cd_procedimento_ficha_w,
	qt_lote_padrao_ficha_w,
	cd_centro_controle_ficha_w,
	ie_calcula_conta_ficha_w,
	nr_seq_proc_interno_ficha_w,
	ds_observacao_ficha_w,
	ie_tipo_ficha_ficha_w,
	ie_solicita_componente_ficha_w,
	nr_seq_exame_ficha_w,
	cd_setor_atendimento_ficha_w,
	qt_alerta_estabilidade_ficha_w,
	ie_revisado_ficha_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	open C04;
	loop
	fetch C04 into
		cd_estabelecimento_copia_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
		begin
		update	   ficha_tecnica
		set		      ie_situacao				=	   ie_situacao_ficha_w,
                     ds_observacao       =    ds_observacao_ficha_w,
                     dt_atualizacao       =     clock_timestamp(),
                     nm_usuario          =      nm_usuario_p
		where		cd_material				= 	cd_material_ficha_w
		and		   cd_estabelecimento=	   cd_estabelecimento_copia_w;
		if	NOT FOUND then
			select	nextval('ficha_tecnica_seq')
			into STRICT		nr_ficha_tecnica_copia_w
			;

			insert	into	ficha_tecnica(nr_ficha_tecnica,
								cd_estabelecimento,
								nm_usuario,
								dt_atualizacao,
								dt_alteracao,
								ie_situacao,
								nr_nivel_estrutura,
								cd_material,
								ie_origem_proced,
								cd_procedimento,
								qt_lote_padrao,
								cd_centro_controle,
								ie_calcula_conta,
								nr_seq_proc_interno,
								ds_observacao,
								ie_tipo_ficha,
								ie_solicita_componente,
								nr_seq_exame,
								cd_setor_atendimento,
								qt_alerta_estabilidade,
								ie_revisado,
								dt_atualizacao_nrec,
								nm_usuario_nrec)
			values (nr_ficha_tecnica_copia_w,
								cd_estabelecimento_copia_w,
								nm_usuario_p,
								clock_timestamp(),
								clock_timestamp(),
								ie_situacao_ficha_w,
								nr_nivel_estrutura_ficha_w,
								cd_material_ficha_w,
								ie_origem_proced_ficha_w,
								cd_procedimento_ficha_w,
								qt_lote_padrao_ficha_w,
								cd_centro_controle_ficha_w,
								ie_calcula_conta_ficha_w,
								nr_seq_proc_interno_ficha_w,
								ds_observacao_ficha_w,
								ie_tipo_ficha_ficha_w,
								ie_solicita_componente_ficha_w,
								nr_seq_exame_ficha_w,
								cd_setor_atendimento_ficha_w,
								qt_alerta_estabilidade_ficha_w,
								ie_revisado_ficha_w,
								clock_timestamp(),
								nm_usuario_p);
			open C02;
			loop
			fetch C02 into
				nr_ficha_tecnica_comp_w,
				cd_material_comp_w,
				qt_material_comp_w,
				ie_situacao_comp_w,
				nr_seq_proc_interno_comp_w,
				ie_tipo_componente_comp_w,
				cd_procedimento_comp_w,
				ie_origem_proced_comp_w,
				cd_centro_controle_comp_w,
				qt_fixa_comp_w,
				qt_variavel_comp_w,
				pr_quebra_variavel_comp_w,
				qt_dose_comp_w,
				cd_unidade_medida_dose_comp_w,
				ie_necessita_disp_comp_w,
				nr_seq_exame_comp_w,
				dt_inicio_vigencia_comp_w,
				dt_fim_vigencia_comp_w,
				nr_seq_componente_copia_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin
				select	coalesce(max(nr_seq_componente),0) + 1
				into STRICT		nr_seq_comp_estab_copia_w
				from		ficha_tecnica_componente
				where		nr_ficha_tecnica = nr_ficha_tecnica_copia_w;

				insert	into ficha_tecnica_componente(nr_ficha_tecnica,
																		nr_seq_componente,
																		dt_alteracao,
																		cd_estabelecimento,
																		nm_usuario,
																		dt_atualizacao,
																		ie_situacao,
																		ie_tipo_componente,
																		cd_material,
																		cd_procedimento,
																		ie_origem_proced,
																		cd_centro_controle,
																		qt_fixa,
																		qt_variavel,
																		pr_quebra_variavel,
																		qt_dose,
																		cd_unidade_medida_dose,
																		qt_material,
																		ie_necessita_disp,
																		nr_seq_exame,
																		nr_seq_proc_interno,
																		dt_inicio_vigencia,
																		dt_fim_vigencia,
																		dt_atualizacao_nrec,
																		nm_usuario_nrec)
				values (nr_ficha_tecnica_copia_w,
																		nr_seq_comp_estab_copia_w,
																		clock_timestamp(),
																		cd_estabelecimento_copia_w,
																		nm_usuario_p,
																		clock_timestamp(),
																		ie_situacao_comp_w,
																		ie_tipo_componente_comp_w,
																		cd_material_comp_w,
																		cd_procedimento_comp_w,
																		ie_origem_proced_comp_w,
																		cd_centro_controle_comp_w,
																		qt_fixa_comp_w,
																		qt_variavel_comp_w,
																		pr_quebra_variavel_comp_w,
																		qt_dose_comp_w,
																		cd_unidade_medida_dose_comp_w,
																		qt_material_comp_w,
																		ie_necessita_disp_comp_w,
																		nr_seq_exame_comp_w,
																		nr_seq_proc_interno_comp_w,
																		dt_inicio_vigencia_comp_w,
																		dt_fim_vigencia_comp_w,
																		clock_timestamp(),
																		nm_usuario_p);
				if (ie_tipo_componente_comp_w = 1) then
					open C03;
					loop
					fetch C03 into
						cd_estabelecimento_regra_w,
						cd_pessoa_fisica_regra_w,
						ie_situacao_regra_w,
						cd_perfil_regra_w,
						ie_visualiza_regra_w;
					EXIT WHEN NOT FOUND; /* apply on C03 */
						begin
						insert	into ficha_tecnica_comp_regra(nr_sequencia,
																			cd_estabelecimento,
																			dt_atualizacao,
																			nm_usuario,
																			dt_atualizacao_nrec,
																			nm_usuario_nrec,
																			cd_pessoa_fisica,
																			ie_situacao,
																			cd_perfil,
																			nr_ficha_tecnica,
																			nr_seq_componente,
																			ie_visualiza)
						values (nextval('ficha_tecnica_comp_regra_seq'),
																			cd_estabelecimento_copia_w,
																			clock_timestamp(),
																			nm_usuario_p,
																			clock_timestamp(),
																			nm_usuario_p,
																			cd_pessoa_fisica_regra_w,
																			ie_situacao_regra_w,
																			cd_perfil_regra_w,
																			nr_ficha_tecnica_copia_w,
																			nr_seq_comp_estab_copia_w,
																			ie_visualiza_regra_w);

						end;
					end loop;
					close C03;
            end if;
            end;
			end loop;
			close C02;
		else --update C04 found
         select   max(nr_ficha_tecnica)
         into STRICT       nr_ficha_tecnica_copia_w
         from      ficha_tecnica
         where   cd_material				 = 	cd_material_ficha_w
         and		cd_estabelecimento =	cd_estabelecimento_copia_w;
			open C02;
			loop
			fetch C02 into
				nr_ficha_tecnica_comp_w,
				cd_material_comp_w,
				qt_material_comp_w,
				ie_situacao_comp_w,
				nr_seq_proc_interno_comp_w,
				ie_tipo_componente_comp_w,
				cd_procedimento_comp_w,
				ie_origem_proced_comp_w,
				cd_centro_controle_comp_w,
				qt_fixa_comp_w,
				qt_variavel_comp_w,
				pr_quebra_variavel_comp_w,
				qt_dose_comp_w,
				cd_unidade_medida_dose_comp_w,
				ie_necessita_disp_comp_w,
				nr_seq_exame_comp_w,
				dt_inicio_vigencia_comp_w,
				dt_fim_vigencia_comp_w,
				nr_seq_componente_copia_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin
            update	ficha_tecnica_componente
				set		cd_material				   =	  cd_material_comp_w,
							qt_material				   =  qt_material_comp_w,
							ie_situacao				   =  ie_situacao_comp_w,
							nr_seq_proc_interno	=	 nr_seq_proc_interno_comp_w,
							qt_fixa					      =	 qt_fixa_comp_w,
                     qt_dose                   =  qt_dose_comp_w,
                     cd_unidade_medida_dose = cd_unidade_medida_dose_comp_w,
                     dt_atualizacao          =  clock_timestamp(),
                     nm_usuario             = nm_usuario_p
				where		((cd_material			      = 	cd_material_comp_w AND ie_tipo_componente = 1) or
                           (nr_seq_proc_interno	= 	nr_seq_proc_interno_comp_w AND ie_tipo_componente = 2))
            and      nr_ficha_tecnica        = nr_ficha_tecnica_copia_w
				and		cd_estabelecimento	=	cd_estabelecimento_copia_w;

				if	NOT FOUND then
					select	coalesce(max(nr_seq_componente),0) + 1
					into STRICT		nr_seq_comp_estab_copia_w
					from		ficha_tecnica_componente
					where		nr_ficha_tecnica = nr_ficha_tecnica_copia_w;

					insert	into ficha_tecnica_componente(nr_ficha_tecnica,
																			nr_seq_componente,
																			dt_alteracao,
																			cd_estabelecimento,
																			nm_usuario,
																			dt_atualizacao,
																			ie_situacao,
																			ie_tipo_componente,
																			cd_material,
																			cd_procedimento,
																			ie_origem_proced,
																			cd_centro_controle,
																			qt_fixa,
																			qt_variavel,
																			pr_quebra_variavel,
																			qt_dose,
																			cd_unidade_medida_dose,
																			qt_material,
																			ie_necessita_disp,
																			nr_seq_exame,
																			nr_seq_proc_interno,
																			dt_inicio_vigencia,
																			dt_fim_vigencia,
																			dt_atualizacao_nrec,
																			nm_usuario_nrec)
					values (nr_ficha_tecnica_copia_w,
																			nr_seq_comp_estab_copia_w,
																			clock_timestamp(),
																			cd_estabelecimento_copia_w,
																			nm_usuario_p,
																			clock_timestamp(),
																			ie_situacao_comp_w,
																			ie_tipo_componente_comp_w,
																			cd_material_comp_w,
																			cd_procedimento_comp_w,
																			ie_origem_proced_comp_w,
																			cd_centro_controle_comp_w,
																			qt_fixa_comp_w,
																			qt_variavel_comp_w,
																			pr_quebra_variavel_comp_w,
																			qt_dose_comp_w,
																			cd_unidade_medida_dose_comp_w,
																			qt_material_comp_w,
																			ie_necessita_disp_comp_w,
																			nr_seq_exame_comp_w,
																			nr_seq_proc_interno_comp_w,
																			dt_inicio_vigencia_comp_w,
																			dt_fim_vigencia_comp_w,
																			clock_timestamp(),
																			nm_usuario_p);
					if (ie_tipo_componente_comp_w = 1) then
						open C03;
						loop
						fetch C03 into
							cd_estabelecimento_regra_w,
							cd_pessoa_fisica_regra_w,
							ie_situacao_regra_w,
							cd_perfil_regra_w,
							ie_visualiza_regra_w;
						EXIT WHEN NOT FOUND; /* apply on C03 */
							begin
							insert	into ficha_tecnica_comp_regra(nr_sequencia,
																										cd_estabelecimento,
																										dt_atualizacao,
																										nm_usuario,
																										dt_atualizacao_nrec,
																										nm_usuario_nrec,
																										cd_pessoa_fisica,
																										ie_situacao,
																										cd_perfil,
																										nr_ficha_tecnica,
																										nr_seq_componente,
																										ie_visualiza)
							values (nextval('ficha_tecnica_comp_regra_seq'),
																										cd_estabelecimento_copia_w,
																										clock_timestamp(),
																										nm_usuario_p,
																										clock_timestamp(),
																										nm_usuario_p,
																										cd_pessoa_fisica_regra_w,
																										ie_situacao_regra_w,
																										cd_perfil_regra_w,
																										nr_ficha_tecnica_copia_w,
																										nr_seq_comp_estab_copia_w,
																										ie_visualiza_regra_w);
							end;
						end loop;
						close C03;
               end if;
				else --update C02 found
               if (ie_tipo_componente_comp_w = 1) then
						select   max(nr_seq_componente)
                  into STRICT       nr_seq_comp_estab_copia_w
                  from      ficha_tecnica_componente
                  where	((cd_material			      = 	cd_material_comp_w AND ie_tipo_componente = 1) or
                              (nr_seq_proc_interno	= 	nr_seq_proc_interno_comp_w AND ie_tipo_componente = 2))
                  and      nr_ficha_tecnica        = nr_ficha_tecnica_copia_w
                  and		cd_estabelecimento	=	cd_estabelecimento_copia_w;

						open C03;
						loop
						fetch C03 into
							cd_estabelecimento_regra_w,
							cd_pessoa_fisica_regra_w,
							ie_situacao_regra_w,
							cd_perfil_regra_w,
							ie_visualiza_regra_w;
						EXIT WHEN NOT FOUND; /* apply on C03 */
							begin
                  	update	ficha_tecnica_comp_regra
							set		cd_estabelecimento 	= cd_estabelecimento_copia_w,
										cd_pessoa_fisica 		= cd_pessoa_fisica_regra_w,
										ie_situacao 					= ie_situacao_regra_w,
										cd_perfil 						= cd_perfil_regra_w,
										ie_visualiza 					= ie_visualiza_regra_w,
                  	         dt_atualizacao          = clock_timestamp(),
                  	         nm_usuario             = nm_usuario_p
							where	nr_seq_componente  = nr_seq_comp_estab_copia_w
                  	and      nr_ficha_tecnica        = nr_ficha_tecnica_copia_w
							and		cd_estabelecimento   =	cd_estabelecimento_copia_w;

                     if	NOT FOUND then
								insert	into ficha_tecnica_comp_regra(nr_sequencia,
																											cd_estabelecimento,
																											dt_atualizacao,
																											nm_usuario,
																											dt_atualizacao_nrec,
																											nm_usuario_nrec,
																											cd_pessoa_fisica,
																											ie_situacao,
																											cd_perfil,
																											nr_ficha_tecnica,
																											nr_seq_componente,
																											ie_visualiza)
								values (nextval('ficha_tecnica_comp_regra_seq'),
																											cd_estabelecimento_copia_w,
																											clock_timestamp(),
																											nm_usuario_p,
																											clock_timestamp(),
																											nm_usuario_p,
																											cd_pessoa_fisica_regra_w,
																											ie_situacao_regra_w,
																											cd_perfil_regra_w,
																											nr_ficha_tecnica_copia_w,
																											nr_seq_comp_estab_copia_w,
																											ie_visualiza_regra_w);
                     end if; --C03 sql%notfound
							end;
						end loop;
						close C03;
               end if; --ie_tipo_componente_comp_w = 1
				end if;	--C02 sql%notfound
				end;
			end loop;
			close C02;
		end if; --C04 sql%notfound
		end;
	end loop;
	close C04;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE replicar_ficha_tecnica_estab (nr_ficha_tecnica_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

