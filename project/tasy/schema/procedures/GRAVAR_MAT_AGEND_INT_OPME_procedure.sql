-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_mat_agend_int_opme ( cd_material_p bigint, qt_unitaria_p bigint, cd_fornecedor_p text, nr_prescricao_p bigint, nr_seq_prescricao_p bigint, ie_acao_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
nr_seq_agenda_w		prescr_medica.nr_seq_agenda%type;
qt_existe_w		varchar(1);	
nr_seq_opme_w		bigint;					
					

BEGIN

select 	nr_seq_agenda
into STRICT	nr_seq_agenda_w
from	prescr_medica
where 	nr_prescricao =	nr_prescricao_p;	

if (ie_acao_p = 1) then
	begin
	select 	nextval('agenda_pac_opme_seq')
	into STRICT	nr_sequencia_w
	;
	
	insert into agenda_pac_opme(
		cd_cgc,
		cd_cond_pagto, 
		cd_material, 
		ds_observacao, 
		dt_atualizacao, 
		dt_atualizacao_nrec, 
		dt_exclusao, 
		ie_autorizado, 
		ie_gerar_autor, 
		ie_integracao, 
		ie_integracao_util, 
		ie_origem_inf, 
		ie_padrao, 
		nm_usuario, 
		nm_usuario_exclusao, 
		nm_usuario_nrec, 
		nr_seq_agenda, 
		nr_seq_apres, 
		nr_seq_motivo_exclusao, 
		nr_seq_proc_interno, 
		nr_sequencia, 
		qt_material, 
		vl_desconto, 
		vl_unitario_item,
		nr_seq_prescricao,
		nr_prescricao)
	values (cd_fornecedor_p,
		'',
		cd_material_p,
		'',
		clock_timestamp(),
		clock_timestamp(),
		'',
		'P',
		'N',
		'S',
		'',
		'I',
		'S',
		nm_usuario_p,
		'',
		nm_usuario_P,
		nr_seq_agenda_w,
		500,
		null,
		null,
		nr_sequencia_w,
		qt_unitaria_p,
		'',
		'',
		nr_seq_prescricao_p,
		nr_prescricao_p);
	end;
end if;

if (ie_acao_p = 2) then
	begin
	
	update	agenda_pac_opme
	set	qt_material = qt_unitaria_p,
		cd_material = cd_material_p,
		cd_cgc = cd_fornecedor_p
	where	nr_seq_agenda	= nr_seq_agenda_w
	and	nr_seq_prescricao = nr_seq_prescricao_p
	and	coalesce(nr_prescricao, nr_prescricao_p) = nr_prescricao_p;
	
	end;
end if;

if (ie_acao_p = 3) then
	begin

	delete	from agenda_pac_opme
	where	cd_material = cd_material_p
	and	nr_seq_prescricao = nr_seq_prescricao_p
	and   	nr_seq_agenda = nr_seq_agenda_w
	and	coalesce(nr_prescricao, nr_prescricao_p) = nr_prescricao_p;
	
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_mat_agend_int_opme ( cd_material_p bigint, qt_unitaria_p bigint, cd_fornecedor_p text, nr_prescricao_p bigint, nr_seq_prescricao_p bigint, ie_acao_p bigint, nm_usuario_p text) FROM PUBLIC;

