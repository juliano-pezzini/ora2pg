-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE estornar_processo_aprov ( nm_usuario_p text, nr_sequencia_p bigint, nr_seq_proc_aprov_p bigint) AS $body$
DECLARE


ie_aprov_reprov_w	varchar(1);
ie_origem_processo_w	varchar(10);
cd_erro_w		varchar(10);


BEGIN

select 	ie_aprov_reprov
into STRICT	ie_aprov_reprov_w
from 	processo_aprov_compra
where	nr_sequencia		= nr_sequencia_p
and	nr_seq_proc_aprov	= nr_seq_proc_aprov_p;

if (ie_aprov_reprov_w = 'P') then
	/*(-20011,'Este processo já está pendente!');*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(191779);
else
	update	processo_aprov_compra
	set 	dt_definicao		= '',
		ie_aprov_reprov		= 'P',
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp()
	where	nr_sequencia		= nr_sequencia_p
	and	nr_seq_proc_aprov	= nr_seq_proc_aprov_p;

	select	obter_origem_processo_aprov(nr_sequencia_p)
	into STRICT	ie_origem_processo_w
	;

	if (ie_origem_processo_w = 'O') then
		begin
		update	ordem_compra_item
		set	dt_aprovacao		 = NULL,
			dt_aprovacao_orig	= clock_timestamp()
		where	nr_seq_aprovacao	= nr_sequencia_p;

		update	ordem_compra
		set	dt_aprovacao	 = NULL
		where	nr_ordem_compra in (
			SELECT	distinct nr_ordem_compra
			from	ordem_compra_item
			where	nr_seq_aprovacao = nr_sequencia_p);

		exception when others then
			cd_erro_w	:= 0;
		end;

	elsif (ie_origem_processo_w = 'S') then
		begin

		update	solic_compra_item
		set	dt_autorizacao		 = NULL
		where	nr_seq_aprovacao	= nr_sequencia_p;

		update	solic_compra
		set	dt_autorizacao		 = NULL,
			cd_pessoa_autoriza	 = NULL
		where	nr_solic_compra	in (
			SELECT	distinct nr_solic_compra
			from	Solic_compra_item
			where	nr_seq_aprovacao = nr_sequencia_p);
		exception when others then
			cd_erro_w	:= 0;
		end;
	elsif (ie_origem_processo_w = 'N') then
		begin

		update	nota_fiscal_item
		set	dt_aprovacao		 = NULL,
			nm_usuario_aprov	 = NULL
		where	nr_seq_aprovacao	= nr_sequencia_p;

		update	nota_fiscal
		set	dt_aprovacao		 = NULL,
			nm_usuario_aprov	 = NULL
		where	nr_sequencia	in (
			SELECT	distinct nr_sequencia
			from	nota_fiscal_item
			where	nr_seq_aprovacao = nr_sequencia_p);
		exception when others then
			cd_erro_w	:= 0;
		end;

	elsif (ie_origem_processo_w = 'L') then
		begin

		update	reg_lic_item
		set	dt_aprovacao		 = NULL,
			nm_usuario_aprov	 = NULL
		where	nr_seq_aprovacao	= nr_sequencia_p;

		update	reg_licitacao
		set	dt_aprovacao		 = NULL,
			nm_usuario_aprov	 = NULL
		where	nr_sequencia	in (
			SELECT	distinct nr_sequencia
			from	reg_lic_item
			where	nr_seq_aprovacao = nr_sequencia_p);
		exception when others then
			cd_erro_w	:= 0;
		end;

	elsif (ie_origem_processo_w = 'R') then
		begin

		update	item_requisicao_material
		set	dt_aprovacao		 = NULL,
			nm_usuario_aprov	 = NULL
		where	nr_seq_aprovacao	= nr_sequencia_p;

		update	requisicao_material
		set	dt_aprovacao		 = NULL,
			nm_usuario_aprov	 = NULL
		where	nr_requisicao in (
			SELECT	nr_requisicao
			from	item_requisicao_material
			where	nr_seq_aprovacao	= nr_sequencia_p);
		exception when others then
			cd_erro_w	:= 0;
		end;

	elsif (ie_origem_processo_w = 'C') then
		begin
		update	cot_compra_item
		set	dt_aprovacao		= clock_timestamp(),
			nm_usuario_aprov 	= nm_usuario_p
		where	nr_seq_aprovacao	= nr_Sequencia_p;

		update	cot_compra
		set	dt_aprovacao		 = NULL,
			nm_usuario_aprov	 = NULL
		where	nr_cot_compra in (
			SELECT	nr_cot_compra
			from	cot_compra_item
			where	nr_seq_aprovacao = nr_sequencia_p);
		exception when others then
			cd_erro_w	:= 0;
		end;
	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE estornar_processo_aprov ( nm_usuario_p text, nr_sequencia_p bigint, nr_seq_proc_aprov_p bigint) FROM PUBLIC;

