-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_itens_sae_automatico ( nr_prescricao_p bigint, cd_empresa_p bigint, nr_seq_modelo_p bigint, cd_estabelecimento_p bigint, cd_setor_pac_p bigint, ds_varios_modelos_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_tipo_item_w		bigint;
cd_empresa_w		smallint;
nr_seq_item_examinar_w	bigint;
nr_seq_mod_item_w		bigint;
nr_seq_item_result_w	bigint;
ie_topografia_w		varchar(1);
nr_seq_sesult_out_w		bigint;
ie_observacao_w		varchar(1);
ie_regra_w		varchar(1);
ie_sinal_vital_w		pe_item_resultado.ie_sinal_vital%type;
qt_min_considera_sv_w	bigint;
qt_regra_w		bigint;

C01 CURSOR FOR
	SELECT	distinct a.nr_sequencia,
		coalesce(a.cd_empresa,cd_empresa_p)
	FROM pe_item_tipo_item c, pe_tipo_item a, pe_item_examinar b
LEFT OUTER JOIN pe_sae_mod_item d ON (b.nr_sequencia = d.nr_seq_item)
WHERE ((a.cd_empresa = cd_empresa_p)
	or (coalesce(a.cd_empresa::text, '') = '')) and a.nr_sequencia = c.nr_seq_tipo_item and b.nr_sequencia = c.nr_seq_item  and ((coalesce(nr_seq_modelo_p::text, '') = '') or (d.nr_seq_modelo = nr_seq_modelo_p)) and coalesce(a.cd_estabelecimento,coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0) and coalesce(b.cd_estabelecimento,coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0) and ((d.cd_setor_pac = cd_setor_pac_p) or (coalesce(d.cd_setor_pac::text, '') = '')) and ((coalesce(ds_varios_modelos_p::text, '') = '') or ((ds_varios_modelos_p IS NOT NULL AND ds_varios_modelos_p::text <> '') and (obter_se_contido(d.nr_seq_modelo,ds_varios_modelos_p) = 'S'))) and coalesce(a.ie_saps,'N') = 'N' order by	a.nr_sequencia;

C02 CURSOR FOR
	SELECT	a.nr_sequencia nr_seq_item_examinar,
		max(c.nr_sequencia) nr_seq_mod_item
	FROM pe_item_tipo_item b, pe_item_examinar a
LEFT OUTER JOIN pe_sae_mod_item c ON (a.nr_sequencia = c.nr_seq_item)
WHERE a.nr_sequencia = b.nr_seq_item and b.nr_seq_tipo_item = nr_seq_tipo_item_w and ((a.cd_empresa = cd_empresa_p)
	or (coalesce(a.cd_empresa::text, '') = '')) and a.ie_situacao = 'A'  and c.nr_seq_modelo = nr_seq_modelo_p and ((c.cd_setor_pac = coalesce(cd_setor_pac_p, c.cd_setor_pac)) or (coalesce(c.cd_setor_pac::text, '') = '')) group by	a.nr_sequencia
	
union all

	SELECT	a.nr_sequencia nr_seq_item_examinar,
		null nr_seq_mod_item
	from	pe_item_examinar a,
		pe_item_tipo_item b
	where	a.nr_sequencia = b.nr_seq_item
	and	b.nr_seq_tipo_item = nr_seq_tipo_item_w
	and	((a.cd_empresa = cd_empresa_p)
	or (coalesce(a.cd_empresa::text, '') = ''))
	and	a.ie_situacao = 'A'
	and	coalesce(nr_seq_modelo_p::text, '') = ''
	group by	a.nr_sequencia;

C03 CURSOR FOR
	SELECT	a.nr_sequencia
	from	pe_item_resultado a
	where	a.nr_seq_item = nr_seq_item_examinar_w
	and	coalesce(a.ie_situacao,'A') = 'A'
	and	not exists (	SELECT	1
				from	pe_prescr_item_result b
				where	b.nr_seq_prescr = nr_prescricao_p
				and	b.nr_seq_result = a.nr_sequencia)
	and (obter_se_mostra_result(a.nr_sequencia,nr_seq_mod_item_w) = 'S')
	and	obter_se_regra_result_sv(a.nr_sequencia,nr_prescricao_p) = 'S';


BEGIN
qt_min_considera_sv_w := Obter_Param_Usuario(9037, 3, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, qt_min_considera_sv_w);

if (coalesce(qt_min_considera_sv_w,0) > 0) then
	begin
	select	count(*)
	into STRICT	qt_regra_w
	from	pe_regra_resultado;
	
	if (coalesce(qt_regra_w,0) > 0) then
		begin
		open C01;
		loop
		fetch C01 into	
			nr_seq_tipo_item_w,
			cd_empresa_w;	
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			open C02;
			loop
			fetch C02 into	
				nr_seq_item_examinar_w,
				nr_seq_mod_item_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin
				open C03;
				loop
				fetch C03 into	
					nr_seq_item_result_w;
				EXIT WHEN NOT FOUND; /* apply on C03 */
					begin
					SELECT * FROM selecionar_resultado_pe(nr_prescricao_p, nr_seq_item_examinar_w, null, null, nr_seq_item_result_w, ie_topografia_w, nr_seq_sesult_out_w, ie_observacao_w, ie_regra_w, ie_sinal_vital_w, nm_usuario_p) INTO STRICT ie_topografia_w, nr_seq_sesult_out_w, ie_observacao_w, ie_regra_w, ie_sinal_vital_w;
					end;
				end loop;
				close C03;
				end;
			end loop;
			close C02;
			end;
		end loop;
		close C01;
		end;
	end if;	
	end;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_itens_sae_automatico ( nr_prescricao_p bigint, cd_empresa_p bigint, nr_seq_modelo_p bigint, cd_estabelecimento_p bigint, cd_setor_pac_p bigint, ds_varios_modelos_p text, nm_usuario_p text) FROM PUBLIC;

