-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_copiar_antibiotico (cd_microorganismo_origem_p bigint, cd_microorganismo_destino_p bigint, nr_seq_material_origem_p bigint, nr_seq_material_destino_p bigint, cd_medicamentos_p text, nm_usuario_p text) AS $body$
DECLARE


cd_medicamento_w	bigint;
nr_seq_material_w	bigint;
nr_seq_grupo_micro_w	bigint;

C01 CURSOR FOR

SELECT	cd_medicamento,
	nr_seq_material,
	nr_seq_grupo_micro
from	cih_microorg_medic
where	cd_microorganismo = cd_microorganismo_origem_p
and	obter_se_contido_char(cd_medicamento, cd_medicamentos_p) = 'S'
and	nr_seq_material	  = CASE WHEN coalesce(nr_seq_material_origem_p, 0)=0 THEN  nr_seq_material  ELSE nr_seq_material_origem_p END;


BEGIN

delete	from cih_microorg_medic
where	cd_microorganismo = cd_microorganismo_destino_p
and	nr_seq_material	  = CASE WHEN coalesce(nr_seq_material_destino_p, 0)=0 THEN  nr_seq_material  ELSE nr_seq_material_destino_p END;

open c01;
loop
fetch c01 into
	cd_medicamento_w,
	nr_seq_material_w,
	nr_seq_grupo_micro_w;

	EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
		insert into cih_microorg_medic(
		cd_microorganismo,
		nr_seq_material,
		dt_atualizacao,
		nm_usuario,
		cd_medicamento,
		nr_seq_grupo_micro)
	values (cd_microorganismo_destino_p,
		CASE WHEN coalesce(nr_seq_material_destino_p, 0)=0 THEN  nr_seq_material_w  ELSE nr_seq_material_destino_p END ,
		clock_timestamp(),
		nm_usuario_p,
		cd_medicamento_w,
		nr_seq_grupo_micro_w);
	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_copiar_antibiotico (cd_microorganismo_origem_p bigint, cd_microorganismo_destino_p bigint, nr_seq_material_origem_p bigint, nr_seq_material_destino_p bigint, cd_medicamentos_p text, nm_usuario_p text) FROM PUBLIC;

