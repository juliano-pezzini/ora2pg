-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vincula_senha_atend_selec ( nr_seq_senha_p text, cd_pessoa_fisica_p text, nm_usuario_p text, ds_lista_atend_p text) AS $body$
DECLARE
 	
										 
nr_prescricao_w	bigint;
nr_seq_prescr_w	integer;
nr_atendimento_w bigint;
	
C01 CURSOR FOR									 
SELECT a.NR_PRESCRICAO, 
		b.NR_SEQUENCIA 
FROM atendimento_paciente c, prescr_medica a, prescr_procedimento b
LEFT OUTER JOIN proc_interno m ON (B.NR_SEQ_PROC_INTERNO = M.NR_SEQUENCIA)
WHERE A.NR_PRESCRICAO  = B.NR_PRESCRICAO AND A.NR_ATENDIMENTO = C.NR_ATENDIMENTO AND C.NR_ATENDIMENTO = nr_atendimento_w  AND (A.DT_LIBERACAO IS NOT NULL AND A.DT_LIBERACAO::text <> '') AND coalesce(B.IE_SUSPENSO,'N')	<> 'S' AND coalesce(M.IE_EXAME_GESTAO_ENTREGA,'S') = 'S' AND SUBSTR(GEL_OBTER_ENVELOPE_EXAME(B.NR_SEQUENCIA,B.NR_PRESCRICAO,B.NR_SEQ_EXAME,'E'),1,10) IS NULL AND C.CD_PESSOA_FISICA = cd_pessoa_fisica_p ORDER BY 1 DESC;WITH RECURSIVE cte AS (


C02 CURSOR FOR 
SELECT regexp_substr(ds_lista_atend_p, '[^, ]+', 1, LEVEL) 
 
(regexp_substr(ds_lista_atend_p, '[^, ]+', 1, LEVEL) IS NOT NULL AND (regexp_substr(ds_lista_atend_p, '[^, ]+', 1, LEVEL))::text <> '')  UNION ALL

 
C02 CURSOR FOR 
SELECT regexp_substr(ds_lista_atend_p, '[^, ]+', 1, LEVEL) JOIN cte c ON ()

) SELECT * FROM cte;
;


BEGIN 
 
open C02;
loop 
fetch C02 into 
	nr_atendimento_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin 
 
	open C01;
	loop 
	fetch C01 into 
			nr_prescricao_w, 
			nr_seq_prescr_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		/*TO DO*/
 
		 insert into SENHA_RETIRADA_LAUDO(	nr_sequencia,            
											dt_atualizacao,                        
											nr_seq_senha,            
											nm_usuario,             
											nr_prescricao,            
											nr_seq_prescricao)          
								values (	nextval('senha_retirada_laudo_seq'),           
											clock_timestamp(),                         
											nr_seq_senha_p,           
											nm_usuario_p,            
											nr_prescricao_w,            
											nr_seq_prescr_w);
		end;
	end loop;
	close C01;
	end;
end loop;
close C02;
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vincula_senha_atend_selec ( nr_seq_senha_p text, cd_pessoa_fisica_p text, nm_usuario_p text, ds_lista_atend_p text) FROM PUBLIC;

