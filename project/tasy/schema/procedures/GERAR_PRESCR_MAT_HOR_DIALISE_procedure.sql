-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE DoseDiferenciada AS (qt_dose_diferenciada double precision);


CREATE OR REPLACE PROCEDURE gerar_prescr_mat_hor_dialise ( nr_prescricao_p bigint, nr_seq_dialise_p bigint, cd_perfil_p bigint, dt_horario_p timestamp, nm_usuario_p text) AS $body$
DECLARE



ds_horarios_w		varchar(2000);
ds_horarios_padr_w	varchar(2000);
ds_horarios_padr_comp_w	varchar(2000);
ds_hora_w		varchar(2000);
dt_liberacao_w		timestamp;
dt_horario_w		timestamp;
k			integer;
y			integer;
nr_sequencia_w		bigint;
nr_seq_prescr_w		integer;
qt_dose_w		double precision;
qt_total_dispensar_w	double precision;
cd_material_w		integer;
dt_primeiro_horario_w	timestamp;
ie_agrupador_w		smallint;
cd_unidade_medida_w	varchar(30);
cd_unid_med_dose_w	varchar(30);
cd_intervalo_w		varchar(7);
ie_prescricao_dieta_w	varchar(1);
nr_ocorrencia_w		double precision;
ie_esquema_alternado_w	varchar(1);
nr_seq_solucao_w	integer;
nr_atendimento_w	bigint;

ie_agrupador_dil_w	smallint;
nr_sequencia_dil_w	bigint;
qt_dose_dil_w		double precision;
qt_total_disp_dil_w	double precision;
cd_unidade_medida_dil_w	varchar(30);
cd_unid_med_dose_dil_w	varchar(30);
nr_ocorrencia_dil_w	double precision;
cd_material_dil_w	integer;
hr_prim_horario_w	varchar(5);
ie_urgente_w		varchar(1);
qt_conversao_w		double precision;
qt_dose_especial_w	double precision;
hr_dose_especial_w	varchar(5);

/* Rafael em 12/09/06 Funcionalidades da Administração da Prescrição (ATEPAC_PG) */

nr_seq_procedimento_w	integer;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
nr_seq_proc_interno_w	bigint;
nr_ocor_proc_w		double precision;
ie_proc_urgente_w	varchar(1);
dt_prev_execucao_w	timestamp;
ds_hora_proc_w		varchar(2000);
dt_horario_proc_w	timestamp;
ds_horarios_proc_w	varchar(2000);
ds_horarios_padrao_proc_w	varchar(2000);
cd_material_exame_w	varchar(20);

nr_seq_recomendacao_w		integer;
cd_recomendacao_w		bigint;
ds_hora_rec_w			varchar(2000);
dt_horario_rec_w		timestamp;
nr_seq_classif_rec_w		bigint;
ds_horarios_rec_w		varchar(2000);
ds_horarios_padrao_rec_w	varchar(2000);
/* Fim Rafael em 12/09/06 */

/* Rafael em 07/10/2006 Funcionalidades da Administração da Prescrição -> Identificar horários especiais (SN, ACM e sem Horário) */

ie_se_necessario_w		varchar(1);
ie_se_necessario_dil_w		varchar(1);
ie_acm_w			varchar(1);
ie_acm_dil_w			varchar(1);
ie_horario_especial_w		varchar(1) := 'N';
qt_dieta_w			bigint;
cd_setor_atendimento_w		integer;
cd_estabelecimento_w		smallint;
dt_prescricao_w			timestamp;
dt_prescricao_ww		timestamp;
qT_dia_adic_w			bigint := 0;
qt_registro_w			bigint;
dt_inicio_prescr_w		timestamp;

nr_seq_procedimento_novo_w	integer;
nr_seq_exame_w			bigint;
ie_status_atend_w		smallint;
ie_status_execucao_w		varchar(3);
cd_setor_atendimento_proc_w	integer;
cd_setor_coleta_w		integer;
cd_setor_entrega_w        	integer;
cd_setor_exec_fim_w       	integer;
cd_setor_exec_inic_w      	integer;
nr_seq_lab_w			varchar(20);
ie_gerar_proc_intervalo_w	varchar(1);
ie_suspenso_w			varchar(1);
ds_observacao_w			varchar(2000);
ds_dado_clinico_w		varchar(2000);
ds_material_especial_w		varchar(255);
ie_controlado_w			varchar(1);
ie_controlado_dil_w		varchar(1);

nr_seq_prescr_hor_w		integer;
dt_horario_proc_prev_w		timestamp;
ie_proc_atual_w			varchar(1);
qt_min_agora_w			bigint;
qt_min_especial_w		bigint;
ie_classif_urgente_w		varchar(3);
dt_limite_agora_w		timestamp;
dt_limite_especial_w		timestamp;
nr_seq_classif_w		bigint;
dt_liberacao_farmacia_w		timestamp;
ie_momento_lote_w		varchar(15) := 'E';
ajustar_disp_hor_farm_w		varchar(1) := 'N';
ie_padronizado_w		varchar(1);
ie_padronizado_dil_w		varchar(1);
ie_classif_nao_padrao_w		varchar(15);
ie_regra_disp_w			varchar(1);
ie_regra_disp_dil_w		varchar(1);
ie_lib_farm_w			varchar(1);
nr_agrupamento_w		double precision;
nr_agrupamento_dil_w		double precision;
cd_protocolo_w			bigint;
cd_protocolo_dil_w		bigint;
ie_material_adep_w		varchar(1);
ie_gerar_adep_w			varchar(1);
ie_componente_composto_w	varchar(1);
ds_dose_diferenciada_w		varchar(50);
ds_dose_diferenciada_ww		varchar(50);
ie_ctrl_loop_w			smallint := 0;
ie_ctrl_loop_ww			smallint := 0;
h				integer;
w				integer;
qt_dose_diferenciada_w		double precision;
qt_dose_hor_w			double precision;
cd_unid_med_dose_hor_w		varchar(30);

ie_usuario_medico_w		varchar(1);
ie_adep_w			varchar(15);
ie_rep_adep_w			varchar(1);
ie_adep_param_w			varchar(1);
cd_local_estoque_w		smallint;
cd_local_estoque_dil_w		smallint;
nr_seq_lote_w			bigint;
/* varPrescrNaoMedicaADEP_w	varchar2(15); */

VarIdentPrescrADEP_w		varchar(15);
ie_gerar_proc_gedipa_job_w	varchar(1);
type VetorDD is table of DoseDiferenciada index by integer;
vt_dose_diferenciada_w	vetorDD;

C01 CURSOR FOR
SELECT	ie_agrupador,
	nr_sequencia,
	qt_dose,
	qt_total_dispensar,
	cd_unidade_medida,
	cd_unidade_medida_dose,
	nr_ocorrencia,
	cd_material,
	ds_horarios,
	padroniza_horario_prescr(b.ds_horarios, CASE WHEN coalesce(b.qt_dia_prim_hor,0)=0 THEN CASE WHEN substr(Obter_Se_horario_hoje(a.dt_prescricao,a.dt_primeiro_horario,b.hr_prim_horario),1,1)='N' THEN '01/01/2000 23:59:59'  ELSE to_char(coalesce(a.dt_primeiro_horario,a.dt_prescricao),'dd/mm/yyyy hh24:mi:ss') END   ELSE '01/01/2000 23:59:59' END ),
	hr_prim_horario,
	coalesce(ie_urgencia,'N'),
	qt_dose_especial,
	hr_dose_especial,
	coalesce(ie_se_necessario,'N'),
	coalesce(ie_acm,'N'),
	substr(Obter_se_medic_controlado(b.cd_material),1,1),
	substr(obter_se_material_padronizado(a.cd_estabelecimento,b.cd_material),1,1),
	CASE WHEN coalesce(b.ie_regra_disp,'S')='N' THEN 'N'  ELSE 'S' END ,
	b.nr_agrupamento,
	b.cd_protocolo,
	substr(obter_se_componente_composto(b.nr_prescricao, b.nr_sequencia, b.nr_agrupamento),1,1) ie_componente_composto,
	b.ds_dose_diferenciada,
	b.cd_local_estoque
from	prescr_material b,
	prescr_medica a
where	a.nr_prescricao	= b.nr_prescricao
and	a.nr_prescricao	= nr_prescricao_p
and	coalesce(a.dt_suspensao::text, '') = ''
and	b.ie_agrupador not in (3,7,9)
and	coalesce(b.ie_suspenso,'N') <> 'S'
order by
	b.nr_agrupamento, b.nr_sequencia;

C03 CURSOR FOR
SELECT	b.ie_agrupador,
	b.nr_sequencia,
	b.qt_dose,
	b.qt_total_dispensar,
	b.cd_unidade_medida,
	b.cd_unidade_medida_dose,
	b.nr_ocorrencia,
	b.cd_material,
	coalesce(b.ie_se_necessario,'N'),
	coalesce(b.ie_acm,'N'),
	substr(Obter_se_medic_controlado(b.cd_material),1,1),
	substr(obter_se_material_padronizado(cd_estabelecimento_w,b.cd_material),1,1),
	CASE WHEN coalesce(b.ie_regra_disp,'S')='N' THEN 'N'  ELSE 'S' END ,
	b.nr_agrupamento,
	b.cd_protocolo,
	b.cd_local_estoque
from	prescr_material b,
	prescr_medica a
where	a.nr_prescricao		= nr_prescricao_p
and	a.nr_prescricao		= b.nr_prescricao
and	coalesce(a.dt_suspensao::text, '') = ''
and	coalesce(b.ie_suspenso,'N') <> 'S'
and	b.nr_sequencia_diluicao	= nr_seq_prescr_w
and	b.ie_agrupador in (3,7,9);



BEGIN

select	dt_liberacao,
	dt_primeiro_horario,
	cd_setor_atendimento,
	coalesce(cd_estabelecimento,1),
	trunc(dt_prescricao,'mi'),
	dt_inicio_prescr,
	dt_liberacao_farmacia,
	coalesce(ie_lib_farm,'N'),
	coalesce(ie_adep,obter_se_setor_adep(cd_setor_atendimento)),
	ie_adep,
	nr_atendimento
into STRICT	dt_liberacao_w,
	dt_primeiro_horario_w,
	cd_setor_atendimento_w,
	cd_estabelecimento_w,
	dt_prescricao_w,
	dt_inicio_prescr_w,
	dt_liberacao_farmacia_w,
	ie_lib_farm_w,
	ie_rep_adep_w,
	ie_adep_param_w,
	nr_atendimento_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

VarIdentPrescrADEP_w := obter_param_usuario(924, 246, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, VarIdentPrescrADEP_w);

select	coalesce(max(ie_gerar_proc_gedipa_job),'S')
into STRICT	ie_gerar_proc_gedipa_job_w
from	parametros_farmacia
where	cd_estabelecimento	= cd_estabelecimento_w;

open C01;
loop
	fetch C01 into
		ie_agrupador_w,
		nr_seq_prescr_w,
		qt_dose_w,
		qt_total_dispensar_w,
		cd_unidade_medida_w,
		cd_unid_med_dose_w,
		nr_ocorrencia_w,
		cd_material_w,
		ds_horarios_w,
		ds_horarios_padr_w,
		hr_prim_horario_w,
		ie_urgente_w,
		qt_dose_especial_w,
		hr_dose_especial_w,
		ie_se_necessario_w,
		ie_acm_w,
		ie_controlado_w,
		ie_padronizado_w,
		ie_regra_disp_w,
		nr_agrupamento_w,
		cd_protocolo_w,
		ie_componente_composto_w,
		ds_dose_diferenciada_w,
		cd_local_estoque_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */

	ie_ctrl_loop_w	:= 0;
	ie_ctrl_loop_ww	:= 0;

	vt_dose_diferenciada_w.delete;
	if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then
		ds_dose_diferenciada_ww	:= ds_dose_diferenciada_w;
		while(ds_dose_diferenciada_ww IS NOT NULL AND ds_dose_diferenciada_ww::text <> '') and (ie_ctrl_loop_w < 101) LOOP
			begin
			select position('-' in ds_dose_diferenciada_ww) into STRICT h;
			if (h > 0) then
				qt_dose_diferenciada_w	:= replace(substr(ds_dose_diferenciada_ww, 1, h-1),'/',',');
				ds_dose_diferenciada_ww	:= substr(ds_dose_diferenciada_ww, h+1, 50);
			else
				qt_dose_diferenciada_w	:= replace(ds_dose_diferenciada_ww,'/',',');
				ds_dose_diferenciada_ww	:= null;
			end if;
			vt_dose_diferenciada_w[ie_ctrl_loop_w].qt_dose_diferenciada	:= coalesce(qt_dose_diferenciada_w,0);
			ie_ctrl_loop_w							:= ie_ctrl_loop_w + 1;
			end;
		end loop;
	end if;

	qt_dia_adic_w	:= 0;

	dt_prescricao_ww	:= dt_prescricao_w;
	if (ie_urgente_w = 'N') then
		dt_prescricao_ww	:= dt_inicio_prescr_w;
	end if;

	if (qt_dose_especial_w IS NOT NULL AND qt_dose_especial_w::text <> '') then
		select	coalesce(max(qt_conversao),1)
		into STRICT	qt_conversao_w
		from	material_conversao_unidade
		where	cd_material		= cd_material_w
		and	cd_unidade_medida	= cd_unid_med_dose_w;

		qt_dose_especial_w	:= dividir(qt_dose_especial_w, qt_conversao_w);
		qt_total_dispensar_w	:= qt_total_dispensar_w - qt_dose_especial_w;
		dt_horario_w		:= pkg_date_utils.get_time(dt_prescricao_w, hr_dose_especial_w, 0);

		select	nextval('prescr_mat_hor_seq')
		into STRICT	nr_sequencia_w
		;

		hr_dose_especial_w	:= replace(hr_dose_especial_w,'A','');
		ie_horario_especial_w	:= 'N';

		if (dt_horario_w < dt_prescricao_w) then
			dt_horario_w	:= dt_horario_w + 1;
		end if;
		if (coalesce(ie_classif_nao_padrao_w::text, '') = '') or (ie_padronizado_w = 'S') then
			begin
			ie_classif_urgente_w	:= 'N';
			if (dt_horario_w <= dt_limite_agora_w) or (ie_urgente_w = 'S') then
				ie_classif_urgente_w	:= 'A';
			elsif (dt_horario_w <= dt_limite_especial_w) then
				ie_classif_urgente_w	:= 'E';
			end if;
			end;
		else
			ie_classif_urgente_w	:= ie_classif_nao_padrao_w;
		end if;

		if (VarIdentPrescrADEP_w = 'DS') then
			ie_adep_w := ie_rep_adep_w;
		elsif (VarIdentPrescrADEP_w = 'NV') then
			ie_adep_w := 'N';
		elsif (VarIdentPrescrADEP_w = 'SV') then
			ie_adep_w := 'S';
		elsif (VarIdentPrescrADEP_w = 'PV') or (VarIdentPrescrADEP_w = 'PNV') then
			ie_adep_w := ie_adep_param_w;
		end if;

		SELECT * FROM obter_dose_um_horario_pmh(cd_material_w, qt_dose_especial_w, cd_unid_med_dose_w, qt_dose_hor_w, cd_unid_med_dose_hor_w) INTO STRICT qt_dose_hor_w, cd_unid_med_dose_hor_w;

		insert into prescr_mat_hor(
			nr_sequencia,
			nr_seq_digito,
			nr_prescricao,
			nr_seq_material,
			ie_agrupador,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_horario,
			dt_horario,
			qt_dose,
			qt_dispensar,
			cd_unidade_medida,
			cd_unidade_medida_dose,
			cd_material,
			nr_ocorrencia,
			qt_dispensar_hor,
			ie_urgente,
			ie_horario_especial,
			nr_seq_turno,
			ie_aprazado,
			ie_dose_especial,
			ie_controlado,
			ie_padronizado,
			ie_classif_urgente,
			ie_dispensar_farm,
			nr_agrupamento,
			ie_adep,
			qt_horario,
			cd_unid_med_hor,
			nr_seq_dialise,
			dt_lib_horario,
			nr_atendimento)
		values (	nr_sequencia_w,
			calcula_digito('MODULO11',nr_sequencia_w),
			nr_prescricao_p,
			nr_seq_prescr_w,
			ie_agrupador_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			to_char(dt_horario_p,'hh24:mi'),
			dt_horario_p,
			qt_dose_especial_w,
			qt_dose_especial_w,
			cd_unidade_medida_w,
			cd_unid_med_dose_w,
			cd_material_w,
			1,
			qt_dose_especial_w,
			ie_urgente_w,
			coalesce(ie_horario_especial_w,'N'),
			Obter_turno_horario_prescr(cd_estabelecimento_w,cd_setor_atendimento_w,hr_dose_especial_w,cd_local_estoque_w),
			'N',
			'S',
			ie_controlado_w,
			ie_padronizado_w,
			ie_classif_urgente_w,
			ie_regra_disp_w,
			nr_agrupamento_w,
			ie_adep_w,
			qt_dose_hor_w,
			cd_unid_med_dose_hor_w,
			nr_seq_dialise_p,
			clock_timestamp(),
			nr_atendimento_w);

		if (ie_gerar_proc_gedipa_job_w	= 'N') then
			CALL Gedipa_Gerar_Proc_Instantaneo(nr_prescricao_p,null,null,nr_sequencia_w);
		end if;

	end if;

	if (ie_componente_composto_w = 'S') then
		ds_horarios_padr_w	:= ds_horarios_padr_comp_w;
	end if;

	ds_horarios_padr_comp_w	:= null;

	if (hr_prim_horario_w = '  :  ') then
		hr_prim_horario_w := null;
	end if;

	ds_hora_w	:= coalesce(hr_prim_horario_w, substr(to_char(dt_primeiro_horario_w,'dd/mm/yyyy hh24:mi:ss'),12,5));
	dt_horario_w	:= pkg_date_utils.get_time(dt_prescricao_ww, ds_hora_w, 0);

	select	nextval('prescr_mat_hor_seq')
	into STRICT	nr_sequencia_w
	;

	/* Rafael em 07/10/2006 Identificar horários especiais */

	ie_horario_especial_w	:= 'S';

	if (dt_horario_w < dt_prescricao_ww) then
		dt_horario_w	:= dt_horario_w + 1;
	end if;
	if (coalesce(ie_classif_nao_padrao_w::text, '') = '') or (ie_padronizado_w = 'S') then
		begin
		ie_classif_urgente_w	:= 'N';
		if (dt_horario_w <= dt_limite_agora_w) or (ie_urgente_w = 'S') then
			ie_classif_urgente_w	:= 'A';
		elsif (dt_horario_w <= dt_limite_especial_w) then
			ie_classif_urgente_w	:= 'E';
		end if;
		end;
	else
		ie_classif_urgente_w	:= ie_classif_nao_padrao_w;
	end if;

	if (VarIdentPrescrADEP_w = 'DS') then
		ie_adep_w := ie_rep_adep_w;
	elsif (VarIdentPrescrADEP_w = 'NV') then
		ie_adep_w := 'N';
	elsif (VarIdentPrescrADEP_w = 'SV') then
		ie_adep_w := 'S';
	end if;

	SELECT * FROM obter_dose_um_horario_pmh(cd_material_w, qt_dose_w, cd_unid_med_dose_w, qt_dose_hor_w, cd_unid_med_dose_hor_w) INTO STRICT qt_dose_hor_w, cd_unid_med_dose_hor_w;

	insert into prescr_mat_hor(
		nr_sequencia,
		nr_seq_digito,
		nr_prescricao,
		nr_seq_material,
		ie_agrupador,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ds_horario,
		dt_horario,
		qt_dose,
		qt_dispensar,
		cd_unidade_medida,
		cd_unidade_medida_dose,
		cd_material,
		nr_ocorrencia,
		qt_dispensar_hor,
		ie_urgente,
		ie_horario_especial,
		nr_seq_turno,
		ie_aprazado,
		ie_controlado,
		ie_padronizado,
		ie_classif_urgente,
		ie_dispensar_farm,
		nr_agrupamento,
		ie_adep,
		qt_horario,
		cd_unid_med_hor,
		nr_seq_dialise,
		dt_lib_horario,
		nr_atendimento)
	values (	nr_sequencia_w,
		calcula_digito('MODULO11',nr_sequencia_w),
		nr_prescricao_p,
		nr_seq_prescr_w,
		ie_agrupador_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		to_char(dt_horario_p,'hh24:mi'),
		dt_horario_p,
		qt_dose_w,
		qt_total_dispensar_w,
		cd_unidade_medida_w,
		cd_unid_med_dose_w,
		cd_material_w,
		nr_ocorrencia_w,
		qt_total_dispensar_w,
		ie_urgente_w,
		coalesce(ie_horario_especial_w,'S'),
		Obter_turno_horario_prescr(cd_estabelecimento_w,cd_setor_atendimento_w,ds_hora_w,cd_local_estoque_w),
		'N',
		ie_controlado_w,
		ie_padronizado_w,
		ie_classif_urgente_w,
		ie_regra_disp_w,
		nr_agrupamento_w,
		ie_adep_w,
		qt_dose_hor_w,
		cd_unid_med_dose_hor_w,
		nr_seq_dialise_p,
		clock_timestamp(),
		nr_atendimento_w);

		if (ie_gerar_proc_gedipa_job_w	= 'N') then
			CALL Gedipa_Gerar_Proc_Instantaneo(nr_prescricao_p,null,null,nr_sequencia_w);
		end if;

	open C03;
	loop
		fetch C03 into
			ie_agrupador_dil_w,
			nr_sequencia_dil_w,
			qt_dose_dil_w,
			qt_total_disp_dil_w,
			cd_unidade_medida_dil_w,
			cd_unid_med_dose_dil_w,
			nr_ocorrencia_dil_w,
			cd_material_dil_w,
			ie_se_necessario_dil_w,
			ie_acm_dil_w,
			ie_controlado_dil_w,
			ie_padronizado_dil_w,
			ie_regra_disp_dil_w,
			nr_agrupamento_w,
			cd_protocolo_dil_w,
			cd_local_estoque_dil_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */

		select	nextval('prescr_mat_hor_seq')
		into STRICT	nr_sequencia_w
		;

		/* Rafael em 07/10/2006 Identificar horários especiais */

		if (ie_se_necessario_dil_w = 'S') or (ie_acm_dil_w = 'S') then
			ie_horario_especial_w	:= 'S';
		else
			ie_horario_especial_w	:= 'N';
		end if;

		if (dt_horario_w < dt_prescricao_ww) then
			dt_horario_w	:= dt_horario_w + 1;
		end if;

		if (coalesce(ie_classif_nao_padrao_w::text, '') = '') or (ie_padronizado_dil_w = 'S') then
			begin
			ie_classif_urgente_w	:= 'N';
			if (dt_horario_w <= dt_limite_agora_w) or (ie_urgente_w = 'S') then
				ie_classif_urgente_w	:= 'A';
			elsif (dt_horario_w <= dt_limite_especial_w) then
				ie_classif_urgente_w	:= 'E';
			end if;
			end;
		else
			ie_classif_urgente_w	:= ie_classif_nao_padrao_w;
		end if;

		SELECT * FROM obter_dose_um_horario_pmh(cd_material_dil_w, qt_dose_dil_w, cd_unid_med_dose_dil_w, qt_dose_hor_w, cd_unid_med_dose_hor_w) INTO STRICT qt_dose_hor_w, cd_unid_med_dose_hor_w;

		insert into prescr_mat_hor(
			nr_sequencia,
			nr_seq_digito,
			nr_prescricao,
			nr_seq_material,
			ie_agrupador,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_horario,
			dt_horario,
			qt_dose,
			qt_dispensar,
			cd_unidade_medida,
			cd_unidade_medida_dose,
			cd_material,
			nr_ocorrencia,
			qt_dispensar_hor,
			ie_urgente,
			ie_horario_especial,
			nr_seq_turno,
			ie_aprazado,
			ie_controlado,
			ie_padronizado,
			ie_classif_urgente,
			ie_dispensar_farm,
			nr_seq_superior,
			nr_agrupamento,
			ie_adep,
			qt_horario,
			cd_unid_med_hor,
			nr_seq_dialise,
			dt_lib_horario,
			nr_atendimento)
		values (	nr_sequencia_w,
			calcula_digito('MODULO11',nr_sequencia_w),
			nr_prescricao_p,
			nr_sequencia_dil_w,
			ie_agrupador_dil_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			to_char(dt_horario_p,'hh24:mi'),
			dt_horario_p,
			qt_dose_dil_w,
			qt_total_disp_dil_w,
			cd_unidade_medida_dil_w,
			cd_unid_med_dose_dil_w,
			cd_material_dil_w,
			nr_ocorrencia_dil_w,
			qt_total_disp_dil_w,
			ie_urgente_w,
			coalesce(ie_horario_especial_w,'N'),
			Obter_turno_horario_prescr(cd_estabelecimento_w,cd_setor_atendimento_w,ds_hora_w,cd_local_estoque_dil_w),
			'N',
			ie_controlado_dil_w,
			ie_padronizado_dil_w,
			ie_classif_urgente_w,
			ie_regra_disp_dil_w,
			nr_seq_prescr_w,
			nr_agrupamento_w,
			ie_adep_w,
			qt_dose_hor_w,
			cd_unid_med_dose_hor_w,
			nr_seq_dialise_p,
			clock_timestamp(),
			nr_atendimento_w);

		if (ie_gerar_proc_gedipa_job_w	= 'N') then
			CALL Gedipa_Gerar_Proc_Instantaneo(nr_prescricao_p,null,null,nr_sequencia_w);
		end if;

	end loop;
	close C03;
end loop;
close C01;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_prescr_mat_hor_dialise ( nr_prescricao_p bigint, nr_seq_dialise_p bigint, cd_perfil_p bigint, dt_horario_p timestamp, nm_usuario_p text) FROM PUBLIC;

