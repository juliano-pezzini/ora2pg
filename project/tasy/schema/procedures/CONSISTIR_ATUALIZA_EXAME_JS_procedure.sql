-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_atualiza_exame_js ( cd_material_exame_p INOUT text, nr_seq_exame_p bigint, ie_pendente_amostra_p text, nr_prescricao_p bigint, dt_prev_execucao_p timestamp, cd_setor_solicitacao_p bigint, dt_coleta_p timestamp, ie_urgencia_p text, cd_setor_exclusivo_p INOUT bigint, cd_procedimento_p bigint, cd_setor_origem_p bigint, nr_atendimento_p bigint, nr_seq_proc_interno_p bigint, ie_origem_proced_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_origem_proced_user_p bigint, dt_prevista_retorno_p INOUT timestamp, cd_setor_atendimento_p INOUT text, cd_setor_coleta_p INOUT text, cd_setor_entrega_p INOUT text, qt_dia_entrega_p INOUT bigint, ie_emite_mapa_p INOUT text, ds_hora_fixa_p INOUT text, ie_data_resultado_p INOUT text, qt_min_entrega_p INOUT bigint, ie_atualizar_recoleta_p INOUT text, ie_gerar_setor_p INOUT text, ds_msg_info_p INOUT text, ie_exclusao_p text, ie_forma_atual_dt_result_p INOUT text, qt_min_atraso_p INOUT bigint ) AS $body$
DECLARE

 
cd_material_exame_w	varchar(20);
dt_prevista_retorno_w	timestamp;

cd_setor_atendimento_w	varchar(255);
cd_setor_coleta_w	varchar(255);
cd_setor_entrega_w	varchar(255);
qt_dia_entrega_w	smallint;
ie_emite_mapa_w		varchar(1);
ds_hora_fixa_w		varchar(10);
ie_data_resultado_w	varchar(1);
qt_min_entrega_w	bigint;
ie_atualizar_recoleta_w	varchar(1);

cd_setor_exclusivo_w	integer;
ie_gerar_setor_w	varchar(1);
ie_dia_semana_final_w 	bigint;
ie_forma_atual_dt_result_w	exame_lab_regra_setor.ie_atul_data_result%type;


BEGIN 
 
if (cd_material_exame_p <> '')then 
	begin 
	 
	select  b.cd_material_exame 
	into STRICT	 cd_material_exame_w 
	from   material_exame_lab b, 
		 exame_lab_material a 
	where  b.nr_sequencia = a.nr_seq_material 
	and   a.nr_seq_exame = nr_seq_exame_p 
	and	a.ie_situacao = 'A' 
	order by a.ie_prioridade;
	 
	end;
end if;
 
if (nr_seq_exame_p <> 0)then 
	begin 
	 
	dt_prevista_retorno_w := atualiza_dt_realizacao_exame(nr_seq_exame_p, nr_prescricao_p, dt_prev_execucao_p, dt_prevista_retorno_w);
	 
	SELECT * FROM obter_setor_exame_lab_eup(nr_prescricao_p, nr_seq_exame_p, ie_pendente_amostra_p, cd_setor_solicitacao_p, cd_material_exame_p, dt_coleta_p, 'S', cd_setor_atendimento_w, cd_setor_coleta_w, cd_setor_entrega_w, qt_dia_entrega_w, ie_emite_mapa_w, ds_hora_fixa_w, ie_data_resultado_w, qt_min_entrega_w, ie_atualizar_recoleta_w, ie_urgencia_p, ie_dia_semana_final_w, ie_exclusao_p, ie_forma_atual_dt_result_w, qt_min_atraso_p, dt_prev_execucao_p) INTO STRICT cd_setor_atendimento_w, cd_setor_coleta_w, cd_setor_entrega_w, qt_dia_entrega_w, ie_emite_mapa_w, ds_hora_fixa_w, ie_data_resultado_w, qt_min_entrega_w, ie_atualizar_recoleta_w, ie_dia_semana_final_w, ie_forma_atual_dt_result_w, qt_min_atraso_p;
	 
	end;
end if;
 
if (coalesce(cd_setor_exclusivo_p, 0) = 0)then 
	begin 
	 
	cd_setor_exclusivo_w	:= obter_setor_atend_proc_lab(cd_estabelecimento_p, cd_procedimento_p, ie_origem_proced_user_p, somente_numero(cd_setor_atendimento_w), cd_setor_origem_p, nm_usuario_p, nr_seq_exame_p, nr_atendimento_p);
 
	ie_gerar_setor_w	:= obter_se_gerar_setor_rotina(cd_estabelecimento_p, 916, cd_procedimento_p, ie_origem_proced_p, nr_seq_proc_interno_p, nr_seq_exame_p, cd_setor_entrega_p, nm_usuario_p);
	 
	end;
end if;
ds_msg_info_p		:= obter_texto_tasy(119670, wheb_usuario_pck.get_nr_seq_idioma);
cd_material_exame_p	:= cd_material_exame_w;
dt_prevista_retorno_p	:= dt_prevista_retorno_w;
cd_setor_atendimento_p	:= replace(replace(cd_setor_atendimento_w,'(',''),')','');
cd_setor_coleta_p	:= replace(replace(cd_setor_coleta_w,'(',''),')','');
cd_setor_entrega_p	:= replace(replace(cd_setor_entrega_w,'(',''),')','');
qt_dia_entrega_p	:= qt_dia_entrega_w;
ie_emite_mapa_p		:= ie_emite_mapa_w;
ds_hora_fixa_p		:= ds_hora_fixa_w;
ie_data_resultado_p	:= ie_data_resultado_w;
qt_min_entrega_p	:= qt_min_entrega_w;
ie_atualizar_recoleta_p	:= ie_atualizar_recoleta_w;
cd_setor_exclusivo_p	:= cd_setor_exclusivo_w;
ie_gerar_setor_p	:= ie_gerar_setor_w;
ie_forma_atual_dt_result_p := ie_forma_atual_dt_result_w;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_atualiza_exame_js ( cd_material_exame_p INOUT text, nr_seq_exame_p bigint, ie_pendente_amostra_p text, nr_prescricao_p bigint, dt_prev_execucao_p timestamp, cd_setor_solicitacao_p bigint, dt_coleta_p timestamp, ie_urgencia_p text, cd_setor_exclusivo_p INOUT bigint, cd_procedimento_p bigint, cd_setor_origem_p bigint, nr_atendimento_p bigint, nr_seq_proc_interno_p bigint, ie_origem_proced_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_origem_proced_user_p bigint, dt_prevista_retorno_p INOUT timestamp, cd_setor_atendimento_p INOUT text, cd_setor_coleta_p INOUT text, cd_setor_entrega_p INOUT text, qt_dia_entrega_p INOUT bigint, ie_emite_mapa_p INOUT text, ds_hora_fixa_p INOUT text, ie_data_resultado_p INOUT text, qt_min_entrega_p INOUT bigint, ie_atualizar_recoleta_p INOUT text, ie_gerar_setor_p INOUT text, ds_msg_info_p INOUT text, ie_exclusao_p text, ie_forma_atual_dt_result_p INOUT text, qt_min_atraso_p INOUT bigint ) FROM PUBLIC;

