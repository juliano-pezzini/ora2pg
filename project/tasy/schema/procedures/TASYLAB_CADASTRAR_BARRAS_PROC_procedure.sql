-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasylab_cadastrar_barras_proc (nr_seq_proc_material_p bigint, nr_prescricao_p bigint, nr_seq_material_p text, qt_volume_p bigint, qt_tempo_p bigint, qt_minuto_p bigint, cd_barras_p text, nr_amostra_p bigint, nr_seq_externo_p bigint, cd_erro_p INOUT bigint, ds_erro_p INOUT text, nr_sequencia_p INOUT bigint) AS $body$
DECLARE


cd_equipamento_w	equipamento_lab.cd_equipamento%type;

nr_seq_material_w	material_exame_lab.nr_sequencia%type;

nr_sequencia_w		prescr_proc_material.nr_sequencia%type;

ie_base_wheb_w		varchar(1);


BEGIN
--ie_base_wheb_w	:= 'S';
cd_erro_p	:= 0;


if (coalesce(nr_seq_material_p::text, '') = '') then
	cd_erro_p	:= 14;
elsif (coalesce(qt_volume_p::text, '') = '') then
	cd_erro_p	:= 19;
elsif (coalesce(qt_tempo_p::text, '') = '') then
	cd_erro_p	:= 20;
elsif (coalesce(qt_minuto_p::text, '') = '') then
	cd_erro_p	:= 21;
end if;

if (cd_erro_p = 0) then

	select	max(a.cd_equipamento)
	into STRICT	cd_equipamento_w
	from	equipamento_lab a
	where	a.ds_sigla = 'TLAB';

	select	max(v.nr_sequencia)
	into STRICT	nr_seq_material_w
	from	material_exame_lab v,
			material_exame_lab_int x
	where	v.nr_sequencia = x.nr_seq_material
	AND 	x.cd_material_integracao = nr_seq_material_p
	and		x.cd_equipamento = cd_equipamento_w;

	if (coalesce(cd_equipamento_w::text, '') = '') then
		cd_erro_p	:= 16;
	elsif (coalesce(nr_seq_material_w::text, '') = '') then
		cd_erro_p	:= 17;
	end if;

	if (cd_erro_p = 0) then

		select	max(nr_sequencia)
		into STRICT	nr_sequencia_w
		from	prescr_proc_material
		where	nr_prescricao = nr_prescricao_p
		and		cd_barras = CASE WHEN ie_base_wheb_w='S' THEN  cd_barras_p||to_char(nr_sequencia_w)  ELSE cd_barras_p END;

		if (coalesce(nr_sequencia_w::text, '') = '') then

			select	nextval('prescr_proc_material_seq')
			into STRICT	nr_sequencia_w
			;

			begin
			insert into prescr_proc_material(
											nr_sequencia,
											nr_prescricao,
											nr_seq_material,
											qt_volume,
											qt_tempo,
											dt_atualizacao,
											nm_usuario,
											qt_minuto,
											cd_barras,
											nr_amostra)
									values (
											nr_sequencia_w,
											nr_prescricao_p,
											nr_seq_material_w,
											qt_volume_p,
											qt_tempo_p,
											clock_timestamp(),
											'TasyLab-barrasp',
											qt_minuto_p,
											CASE WHEN ie_base_wheb_w='S' THEN  cd_barras_p||to_char(nr_sequencia_w)  ELSE cd_barras_p END ,
											nr_amostra_p
											);
			--OS727249 - Ivan
			--commit;
			nr_sequencia_p	:= nr_sequencia_w;

			exception
			when others then
				cd_erro_p	:= 1;
				ds_erro_p	:= substr('Erro ao registrar o material do procedimento '||sqlerrm,1,2000);
			end;
		else
			nr_sequencia_p	:= nr_sequencia_w;
		end if;

	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasylab_cadastrar_barras_proc (nr_seq_proc_material_p bigint, nr_prescricao_p bigint, nr_seq_material_p text, qt_volume_p bigint, qt_tempo_p bigint, qt_minuto_p bigint, cd_barras_p text, nr_amostra_p bigint, nr_seq_externo_p bigint, cd_erro_p INOUT bigint, ds_erro_p INOUT text, nr_sequencia_p INOUT bigint) FROM PUBLIC;

