-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_mat_prescr_emergencia ( nr_prescricao_p bigint, cd_material_p bigint, qt_material_p bigint, cd_cgc_fornec_p text, nr_seq_lote_fornec_p text, cd_intervalo_p text, nm_usuario_p text) AS $body$
DECLARE




nr_seq_material_w			integer;
cd_unidade_medida_consumo_w		varchar(30);
ie_via_aplicacao_w			varchar(5);
ie_tipo_material_w			varchar(3);
ie_agrupador_w				smallint := 2;
nr_agrupamento_w			double precision;
dt_atual_w					varchar(5) := to_char(clock_timestamp(),'hh24:mi');
cd_intervalo_w				varchar(7);


BEGIN

select	cd_unidade_medida_consumo,
	ie_via_aplicacao,
	ie_tipo_material
into STRICT	cd_unidade_medida_consumo_w,
	ie_via_aplicacao_w,
	ie_tipo_material_w
from	material
where	cd_material = cd_material_p;

if (ie_tipo_material_w in ('2','3','9')) then
	ie_agrupador_w	:= 1;
end if;

select	coalesce(max(nr_agrupamento),0) + 1
into STRICT	nr_agrupamento_w
from	prescr_material
where	nr_prescricao	= nr_prescricao_p
and	ie_agrupador	= ie_agrupador_w;

select	coalesce(max(nr_sequencia),0) + 1
into STRICT	nr_seq_material_w
from	prescr_material
where	nr_prescricao	= nr_prescricao_p;

select 	coalesce(max(cd_intervalo),'0')
into STRICT	cd_intervalo_w
from 	intervalo_prescricao
where 	cd_intervalo = cd_intervalo_p;

if (cd_intervalo_w = '0') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(458517);
end if;

begin

Insert into Prescr_Material(
	nr_prescricao,
	nr_sequencia,
	ie_origem_inf,
	cd_material,
	cd_unidade_medida,
	qt_dose,
	qt_unitaria,
	qt_material,
	dt_atualizacao,
	nm_usuario,
	cd_intervalo,
	ie_via_aplicacao,
	nr_agrupamento,
	cd_motivo_baixa,
	ie_utiliza_kit,
	cd_unidade_medida_dose,
	qt_conversao_dose,
	ie_urgencia,
	nr_ocorrencia,
	qt_total_dispensar,
	ie_medicacao_paciente,
	ie_suspenso,
	ie_agrupador,
	ie_se_necessario,
	ie_bomba_infusao,
	ie_aplic_bolus,
	ie_aplic_lenta,
	ie_acm,
	ie_cultura_cih,
	ie_antibiograma,
	ie_uso_antimicrobiano,
	ie_status_cirurgia,
	ie_recons_diluente_fixo,
	nr_seq_lote_fornec,
	DT_ATUALIZACAO_NREC,
	ds_horarios,
	HR_PRIM_HORARIO)
values (
	nr_prescricao_p,
    	nr_seq_material_w,
 	'E',
 	cd_material_p,
 	cd_unidade_medida_consumo_w,
 	coalesce(qt_material_p,0),
 	coalesce(qt_material_p,0),
 	coalesce(qt_material_p,0),
 	clock_timestamp(),
	nm_usuario_p,
 	cd_intervalo_p,
 	ie_via_aplicacao_w,
      	nr_agrupamento_w,
      	0,
      	'N',
      	cd_unidade_medida_consumo_w,
     	1,
	'S',
      	1,
      	coalesce(qt_material_p,0),
	'N',
	'N',
      	ie_agrupador_w,
	'N',
	'N',
	'N',
	'N',
	'N',
	'N',
	'N',
	'N',
	'PE',
	'N',
	CASE WHEN nr_seq_lote_fornec_p=0 THEN null  ELSE nr_seq_lote_fornec_p END ,
	clock_timestamp(),
	dt_atual_w,
	dt_atual_w);

exception when others then
CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(279778, 'VARIAVEL=' || nr_seq_lote_fornec_p);
end;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_mat_prescr_emergencia ( nr_prescricao_p bigint, cd_material_p bigint, qt_material_p bigint, cd_cgc_fornec_p text, nr_seq_lote_fornec_p text, cd_intervalo_p text, nm_usuario_p text) FROM PUBLIC;

