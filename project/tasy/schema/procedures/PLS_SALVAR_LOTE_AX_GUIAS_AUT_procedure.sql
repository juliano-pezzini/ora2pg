-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_salvar_lote_ax_guias_aut ( nr_seq_lote_anexo_p bigint, nm_usuario_p text, cd_ans_p text, cd_guia_p text, cd_guia_prestador_p text, cd_guia_referencia_p text, dt_solicitacao_p timestamp, cd_senha_p text, dt_autorizacao_p timestamp, cd_usuario_plano_p text, ie_recem_nascido_p text, nm_beneficiario_p text, cd_cnes_p text, ds_biometria_p text, nm_profissional_solic_p text, nr_telef_prof_solic_p text, ds_justificativa_p text, ds_email_prof_solic_p text, ds_especificacao_p text, qt_peso_p bigint, qt_altura_p bigint, qt_superficie_corporal_p bigint, qt_idade_benef_p bigint, ie_sexo_p text, ds_procedimento_cirurgico_p text, dt_real_proc_cirurgico_p timestamp, ds_area_irradiada_p text, dt_radioterapia_p timestamp, nr_ciclo_previsto_p bigint, qt_intervalo_ciclo_p bigint, nr_ciclo_atual_p bigint, ds_quimioterapia_p text, dt_quimioterapia_p timestamp, qt_dose_total_p bigint, qt_dose_dia_p bigint, nr_campos_p bigint, dt_inicio_previsto_p timestamp, qt_dias_previsto_p bigint, nr_seq_guia_p bigint, ie_tipo_anexo_p text, ds_observacao_p text, nr_seq_guia_plano_imp_p pls_guia_plano_imp.nr_sequencia%type, nr_seq_lote_ax_guias_p INOUT bigint, nr_dias_ciclo_atual_p bigint, ie_tipo_ident_benef_p pls_lote_anexo_guias_imp.ie_tipo_ident_benef%type, cd_ident_biometria_benef_p pls_lote_anexo_guias_imp.cd_ident_biometria_benef%type, cd_template_biomet_benef_p pls_lote_anexo_guias_imp.cd_template_biomet_benef%type) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Salvar  as guias no lote de anexo.
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[  ]  Objetos do dicionário [  ] Tasy (Delphi/Java) [  ] Portal [  x]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_lote_guia_w		bigint;
nr_seq_guia_w			pls_guia_plano.nr_sequencia%type;
nr_seq_guia_pricipal_w		pls_lote_anexo_guias_imp.nr_seq_guia_principal%type;
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
nr_seq_requisicao_w		pls_requisicao.nr_sequencia%type;


BEGIN
nr_seq_guia_w := nr_seq_guia_p;

--Verifica se o beneficiário existe beneficiário na base
nr_seq_segurado_w := pls_obter_dados_carteira(null,cd_usuario_plano_p,'S');

if ( (cd_guia_referencia_p IS NOT NULL AND cd_guia_referencia_p::text <> '') and coalesce(nr_seq_guia_p::text, '') = '' ) then

	--Verifica se existe guia não autorizada para ser adicionado o anexo
	select	max(nr_sequencia)
	into STRICT	nr_seq_guia_pricipal_w
	from	pls_guia_plano
	where   cd_guia 	= cd_guia_referencia_p
	and	nr_seq_segurado = nr_seq_segurado_w
	and	ie_status <> '1';
	
	--Caso não encontre a guia pelo CD_GUIA será realizada a busca pelo código da guia do prestador CD_GUIA_PRESTADOR
	if ( coalesce(nr_seq_guia_pricipal_w::text, '') = '' ) then
		select	max(nr_sequencia)
		into STRICT	nr_seq_guia_pricipal_w
		from	pls_guia_plano
		where	cd_guia_prestador 	= cd_guia_referencia_p
		and	nr_seq_segurado 	= nr_seq_segurado_w
		and	ie_status <> '1';
	end if;
		
	nr_seq_guia_w := nr_seq_guia_pricipal_w;
end if;

select	max(nr_seq_requisicao)
into STRICT	nr_seq_requisicao_w
from	pls_guia_plano_imp
where	nr_seq_guia_plano = nr_seq_guia_w;

select	nextval('pls_lote_anexo_guias_imp_seq')
into STRICT	nr_seq_lote_guia_w
;

insert	into	pls_lote_anexo_guias_imp(
	nr_sequencia, nr_seq_lote_anexo, dt_atualizacao,
	nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
	cd_ans, cd_guia, cd_guia_prestador,
	cd_guia_referencia, dt_solicitacao, cd_senha,
	dt_autorizacao, cd_usuario_plano, ie_recem_nascido,
	nm_beneficiario, cd_cnes, ds_biometria,
	nm_profissional_solic, nr_telef_prof_solic, ds_justificativa,
	ds_email_prof_solic, ds_especificacao, qt_peso,
	qt_altura, qt_superficie_corporal, qt_idade_benef,
	ie_sexo, ds_procedimento_cirurgico, dt_real_proc_cirurgico,
	ds_area_irradiada, dt_radioterapia, nr_ciclo_previsto,
	nr_ciclo_atual, qt_intervalo_ciclo, ds_quimioterapia,
	dt_quimioterapia, qt_dose_total, qt_dose_dia,
	nr_campos, dt_inicio_previsto, qt_dias_previsto,
	nr_seq_guia, ie_status,  ie_tipo_anexo, 
	ds_observacao, nr_seq_guia_principal, nr_seq_guia_plano_imp,
	nr_seq_requisicao, nr_dia_ciclo_atual, ie_tipo_ident_benef, 
	cd_ident_biometria_benef, cd_template_biomet_benef)
  values (nr_seq_lote_guia_w, nr_seq_lote_anexo_p, clock_timestamp(),
	nm_usuario_p, clock_timestamp(), nm_usuario_p,
	cd_ans_p, cd_guia_p, cd_guia_prestador_p,
	cd_guia_referencia_p, dt_solicitacao_p, cd_senha_p,
	dt_autorizacao_p, cd_usuario_plano_p, ie_recem_nascido_p,
	nm_beneficiario_p, cd_cnes_p,  ds_biometria_p,
	nm_profissional_solic_p, nr_telef_prof_solic_p, ds_justificativa_p,
	ds_email_prof_solic_p, ds_especificacao_p, qt_peso_p,
	qt_altura_p, qt_superficie_corporal_p, qt_idade_benef_p,
	ie_sexo_p, ds_procedimento_cirurgico_p, dt_real_proc_cirurgico_p,
	ds_area_irradiada_p, dt_radioterapia_p, nr_ciclo_previsto_p,
	nr_ciclo_atual_p, qt_intervalo_ciclo_p, ds_quimioterapia_p,
	dt_quimioterapia_p, qt_dose_total_p, qt_dose_dia_p,
	nr_campos_p, dt_inicio_previsto_p, qt_dias_previsto_p,
	nr_seq_guia_w, '2',  ie_tipo_anexo_p, 
	ds_observacao_p, nr_seq_guia_pricipal_w, nr_seq_guia_plano_imp_p,
	nr_seq_requisicao_w, nr_dias_ciclo_atual_p, ie_tipo_ident_benef_p, 
	cd_ident_biometria_benef_p, cd_template_biomet_benef_p);

nr_seq_lote_ax_guias_p := nr_seq_lote_guia_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_salvar_lote_ax_guias_aut ( nr_seq_lote_anexo_p bigint, nm_usuario_p text, cd_ans_p text, cd_guia_p text, cd_guia_prestador_p text, cd_guia_referencia_p text, dt_solicitacao_p timestamp, cd_senha_p text, dt_autorizacao_p timestamp, cd_usuario_plano_p text, ie_recem_nascido_p text, nm_beneficiario_p text, cd_cnes_p text, ds_biometria_p text, nm_profissional_solic_p text, nr_telef_prof_solic_p text, ds_justificativa_p text, ds_email_prof_solic_p text, ds_especificacao_p text, qt_peso_p bigint, qt_altura_p bigint, qt_superficie_corporal_p bigint, qt_idade_benef_p bigint, ie_sexo_p text, ds_procedimento_cirurgico_p text, dt_real_proc_cirurgico_p timestamp, ds_area_irradiada_p text, dt_radioterapia_p timestamp, nr_ciclo_previsto_p bigint, qt_intervalo_ciclo_p bigint, nr_ciclo_atual_p bigint, ds_quimioterapia_p text, dt_quimioterapia_p timestamp, qt_dose_total_p bigint, qt_dose_dia_p bigint, nr_campos_p bigint, dt_inicio_previsto_p timestamp, qt_dias_previsto_p bigint, nr_seq_guia_p bigint, ie_tipo_anexo_p text, ds_observacao_p text, nr_seq_guia_plano_imp_p pls_guia_plano_imp.nr_sequencia%type, nr_seq_lote_ax_guias_p INOUT bigint, nr_dias_ciclo_atual_p bigint, ie_tipo_ident_benef_p pls_lote_anexo_guias_imp.ie_tipo_ident_benef%type, cd_ident_biometria_benef_p pls_lote_anexo_guias_imp.cd_ident_biometria_benef%type, cd_template_biomet_benef_p pls_lote_anexo_guias_imp.cd_template_biomet_benef%type) FROM PUBLIC;

