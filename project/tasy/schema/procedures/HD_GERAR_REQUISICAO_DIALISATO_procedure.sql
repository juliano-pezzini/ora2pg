-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hd_gerar_requisicao_dialisato () AS $body$
DECLARE



C01 CURSOR FOR
	SELECT	ie_tipo_paciente,
			nr_seq_modelo,
			cd_estabelecimento,
			nr_sequencia
	from	hd_regra_dialisato;

	c01_w				c01%rowtype;	

C02 CURSOR FOR
	SELECT	cd_material,			
			qt_volume,
			qt_material,                    
			ds_formula_quantidade,          
			cd_unidade_medida,         
			cd_operacao_estoque,
			cd_local_estoque,
			cd_local_estoque_destino,
			cd_pessoa_requisitante,
			cd_centro_custo         
	from	hd_calculo_dialisato
	where	nr_seq_regra = c01_w.nr_sequencia
	order by cd_local_estoque,cd_operacao_estoque,cd_pessoa_requisitante,cd_local_estoque_destino,cd_centro_custo;
	c02_w				c02%rowtype;	
	
C03 CURSOR FOR
	SELECT	a.cd_pessoa_fisica
	from	hd_agenda_dialise a,
			hd_pac_renal_cronico b
	where	a.ie_situacao = 'A'
	and		a.cd_pessoa_fisica = b.cd_pessoa_fisica
	and		trunc(a.dt_agenda) = trunc(clock_timestamp() + interval '1 days')
	and		coalesce(b.ie_paciente_agudo,'N') = c01_w.ie_tipo_paciente
	and		a.cd_estabelecimento = c01_w.cd_estabelecimento
	and (exists (SELECT	1
					from	hd_maquina_dialise x
					where	x.nr_seq_ponto = a.nr_seq_ponto_acesso
					and		x.nr_seq_modelo = c01_w.nr_seq_modelo) or coalesce(c01_w.nr_seq_modelo::text, '') = '');

												
				
c03_w				c03%rowtype;		
qt_material_w		hd_calculo_dialisato.qt_material%type;	
ds_comando_w		varchar(255);		
ds_formula_convertida_w	varchar(255);
qt_material_retorno_w	hd_calculo_dialisato.qt_material%type;	
qt_hora_min_sessao_w	cpoe_dialise.qt_hora_min_sessao%type;
qt_dose_solucao_w		cpoe_dialise.QT_DOSE_SOLUC1%type;
qt_dosagem_w			cpoe_dialise.QT_DOSAGEM%type;
nr_requisicao_w			requisicao_material.nr_requisicao%type;
nr_seq_req_item_w		item_requisicao_material.nr_sequencia%type;
cd_unidade_medida_estoque_w	 item_requisicao_material.cd_unidade_medida_estoque%type;
qt_requisicao_estoque_w			item_requisicao_material.qt_estoque%type;
cd_estabelecimento_w	hd_regra_dialisato.cd_estabelecimento%type;
cd_local_estoque_w		hd_calculo_dialisato.cd_local_estoque%type;
cd_operacao_estoque_w	hd_calculo_dialisato.cd_operacao_estoque%type;
cd_pessoa_requisitante_w	hd_calculo_dialisato.cd_pessoa_requisitante%type;
cd_local_estoque_destino_w	hd_calculo_dialisato.cd_local_estoque_destino%type;
cd_centro_custo_w		hd_calculo_dialisato.cd_centro_custo%type;
insere_mesma_req	varchar(1);

BEGIN
open C01;
loop
fetch C01 into	
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	open C02;
	loop
	fetch C02 into	
		c02_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		qt_material_w := 0;
		open C03;
		loop
		fetch C03 into	
			c03_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			select max(a.qt_hora_min_sessao),
					max(c02_w.QT_VOLUME),
					max(CASE WHEN c02_w.cd_material=CD_MAT_SOLUC1 THEN  QT_DOSAGEM WHEN c02_w.cd_material=CD_MAT_SOLUC1_2 THEN  QT_DOSAGEM2 WHEN c02_w.cd_material=CD_MAT_SOLUC1_3 THEN  QT_DOSAGEM3 WHEN c02_w.cd_material=CD_MAT_SOLUC1_4 THEN  QT_DOSAGEM4 WHEN c02_w.cd_material=CD_MAT_SOLUC1_5 THEN  QT_DOSAGEM5 WHEN c02_w.cd_material=CD_MAT_SOLUC2 THEN  QT_DOSAGEM WHEN c02_w.cd_material=CD_MAT_SOLUC2_2 THEN  QT_DOSAGEM2 WHEN c02_w.cd_material=CD_MAT_SOLUC2_3 THEN  QT_DOSAGEM3 WHEN c02_w.cd_material=CD_MAT_SOLUC2_4 THEN  QT_DOSAGEM4 WHEN c02_w.cd_material=CD_MAT_SOLUC2_5 THEN  QT_DOSAGEM5 WHEN c02_w.cd_material=CD_MAT_SOLUC3 THEN  QT_DOSAGEM WHEN c02_w.cd_material=CD_MAT_SOLUC3_2 THEN  QT_DOSAGEM2 WHEN c02_w.cd_material=CD_MAT_SOLUC3_3 THEN  QT_DOSAGEM3 WHEN c02_w.cd_material=CD_MAT_SOLUC3_4 THEN  QT_DOSAGEM4 WHEN c02_w.cd_material=CD_MAT_SOLUC3_5 THEN  QT_DOSAGEM5 WHEN c02_w.cd_material=CD_MAT_SOLUC4 THEN  QT_DOSAGEM WHEN c02_w.cd_material=CD_MAT_SOLUC4_2 THEN  QT_DOSAGEM2 WHEN c02_w.cd_material=CD_MAT_SOLUC4_3 THEN  QT_DOSAGEM3 WHEN c02_w.cd_material=CD_MAT_SOLUC4_4 THEN  QT_DOSAGEM4 WHEN c02_w.cd_material=CD_MAT_SOLUC4_5 THEN  QT_DOSAGEM5 WHEN c02_w.cd_material=CD_MAT_SOLUC5 THEN  QT_DOSAGEM WHEN c02_w.cd_material=CD_MAT_SOLUC5_2 THEN  QT_DOSAGEM2 WHEN c02_w.cd_material=CD_MAT_SOLUC5_3 THEN  QT_DOSAGEM3 WHEN c02_w.cd_material=CD_MAT_SOLUC5_4 THEN  QT_DOSAGEM4 WHEN c02_w.cd_material=CD_MAT_SOLUC5_5 THEN  QT_DOSAGEM5 WHEN c02_w.cd_material=CD_MAT_SOLUC6 THEN  QT_DOSAGEM WHEN c02_w.cd_material=CD_MAT_SOLUC6_2 THEN  QT_DOSAGEM2 WHEN c02_w.cd_material=CD_MAT_SOLUC6_3 THEN  QT_DOSAGEM3 WHEN c02_w.cd_material=CD_MAT_SOLUC6_4 THEN  QT_DOSAGEM4 WHEN c02_w.cd_material=CD_MAT_SOLUC6_5 THEN  QT_DOSAGEM5 WHEN c02_w.cd_material=CD_MAT_SOLUC7 THEN  QT_DOSAGEM WHEN c02_w.cd_material=CD_MAT_SOLUC7_2 THEN  QT_DOSAGEM2 WHEN c02_w.cd_material=CD_MAT_SOLUC7_3 THEN  QT_DOSAGEM3 WHEN c02_w.cd_material=CD_MAT_SOLUC7_4 THEN  QT_DOSAGEM4 WHEN c02_w.cd_material=CD_MAT_SOLUC7_5 THEN  QT_DOSAGEM5 END )
			  into STRICT qt_hora_min_sessao_w,
					qt_dose_solucao_w,
					qt_dosagem_w
			  from cpoe_dialise a
			 where nr_sequencia = (SELECT	max(nr_sequencia)
									 from 	cpoe_dialise b,
											atendimento_paciente c
									where 	b.nr_atendimento = c.nr_atendimento
									  and 	c.cd_pessoa_fisica = c03_w.cd_pessoa_fisica
									  and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
									  and	((CD_MAT_SOLUC1 = c02_w.cd_material and QT_DOSE_SOLUC1 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC1_2 = c02_w.cd_material and QT_DOSE_SOLUC1_2 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC1_3 = c02_w.cd_material and QT_DOSE_SOLUC1_3 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC1_4 = c02_w.cd_material and QT_DOSE_SOLUC1_4 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC1_5 = c02_w.cd_material and QT_DOSE_SOLUC1_5 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC2 = c02_w.cd_material and QT_DOSE_SOLUC2 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC2_2 = c02_w.cd_material and QT_DOSE_SOLUC2_2 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC2_3 = c02_w.cd_material and QT_DOSE_SOLUC2_3 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC2_4 = c02_w.cd_material and QT_DOSE_SOLUC2_4 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC2_5 = c02_w.cd_material and QT_DOSE_SOLUC2_5 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC3 = c02_w.cd_material and QT_DOSE_SOLUC3 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC3_2 = c02_w.cd_material and QT_DOSE_SOLUC3_2 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC3_3 = c02_w.cd_material and QT_DOSE_SOLUC3_3 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC3_4 = c02_w.cd_material and QT_DOSE_SOLUC3_4 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC3_5 = c02_w.cd_material and QT_DOSE_SOLUC3_5 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC4 = c02_w.cd_material and QT_DOSE_SOLUC4 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC4_2 = c02_w.cd_material and QT_DOSE_SOLUC4_2 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC4_3 = c02_w.cd_material and QT_DOSE_SOLUC4_3 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC4_4 = c02_w.cd_material and QT_DOSE_SOLUC4_4 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC4_5 = c02_w.cd_material and QT_DOSE_SOLUC4_5 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC5 = c02_w.cd_material and QT_DOSE_SOLUC5 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC5_2 = c02_w.cd_material and QT_DOSE_SOLUC5_2 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC5_3 = c02_w.cd_material and QT_DOSE_SOLUC5_3 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC5_4 = c02_w.cd_material and QT_DOSE_SOLUC5_4 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC5_5 = c02_w.cd_material and QT_DOSE_SOLUC5_5 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC6 = c02_w.cd_material and QT_DOSE_SOLUC6 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC6_2 = c02_w.cd_material and QT_DOSE_SOLUC6_2 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC6_3 = c02_w.cd_material and QT_DOSE_SOLUC6_3 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC6_4 = c02_w.cd_material and QT_DOSE_SOLUC6_4 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC6_5 = c02_w.cd_material and QT_DOSE_SOLUC6_5 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC7 = c02_w.cd_material and QT_DOSE_SOLUC7 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC7_2 = c02_w.cd_material and QT_DOSE_SOLUC7_2 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC7_3 = c02_w.cd_material and QT_DOSE_SOLUC7_3 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC7_4 = c02_w.cd_material and QT_DOSE_SOLUC7_4 = c02_w.QT_VOLUME)
									  or (CD_MAT_SOLUC7_5 = c02_w.cd_material and QT_DOSE_SOLUC7_5 = c02_w.QT_VOLUME)));
									
									  
			if (c02_w.qt_material IS NOT NULL AND c02_w.qt_material::text <> '') then
				qt_material_w := qt_material_w + c02_w.qt_material;
			else
				select	replace(replace(replace(c02_w.ds_formula_quantidade,'CPOE.DURACAO',((SUBSTR(qt_hora_min_sessao_w,1,2))::numeric *60) + (SUBSTR(qt_hora_min_sessao_w,4,5))::numeric ),'CPOE.MATERIAL.DOSE',qt_dose_solucao_w),'CPOE.MATERIAL.FLUXO',qt_dosagem_w)
				into STRICT	ds_formula_convertida_w
				;
				
				ds_comando_w := 'select #@COMANDO#@ qt from dual';
				
				select	replace(ds_comando_w,'#@COMANDO#@',ds_formula_convertida_w)
				into STRICT	ds_comando_w
				;
				
				select	obter_select_concatenado_bv(ds_comando_w, null, ',')
				into STRICT	qt_material_retorno_w
				;
				
				qt_material_w := qt_material_w + qt_material_retorno_w;								
				
			end if;
						
			end;
		end loop;
		close C03;
		if (coalesce(cd_estabelecimento_w,0) = coalesce(c01_w.cd_estabelecimento,0))
		and (coalesce(cd_local_estoque_w,0) = coalesce(c02_w.cd_local_estoque,0))
		and (coalesce(cd_operacao_estoque_w,0) = coalesce(c02_w.cd_operacao_estoque,0))
		and (coalesce(cd_pessoa_requisitante_w,0) = coalesce(c02_w.cd_pessoa_requisitante,0))
		and (coalesce(cd_local_estoque_destino_w,0) = coalesce(c02_w.cd_local_estoque_destino,0))
		and (coalesce(cd_centro_custo_w, 0) = coalesce(c02_w.cd_centro_custo,0)) then
			insere_mesma_req := 'S';
		else
			insere_mesma_req := 'N';
		end if;
		
		cd_estabelecimento_w := c01_w.cd_estabelecimento;
		cd_local_estoque_w := c02_w.cd_local_estoque;
		cd_operacao_estoque_w := c02_w.cd_operacao_estoque;
		cd_pessoa_requisitante_w := c02_w.cd_pessoa_requisitante;
		cd_local_estoque_destino_w := c02_w.cd_local_estoque_destino;
		cd_centro_custo_w := c02_w.cd_centro_custo;
		if (qt_material_w > 0) then
			if (insere_mesma_req='N')then
				select	nextval('requisicao_seq')
				into STRICT	nr_requisicao_w
				;
				
				insert into requisicao_material(
						nr_requisicao,
						cd_estabelecimento,
						cd_local_estoque,
						dt_solicitacao_requisicao,
						dt_atualizacao,
						nm_usuario,
						cd_operacao_estoque,
						cd_pessoa_requisitante,
						cd_estabelecimento_destino,
						cd_local_estoque_destino,
						ie_urgente,
						cd_centro_custo)
				values (	nr_requisicao_w,
						c01_w.cd_estabelecimento,
						c02_w.cd_local_estoque,
						clock_timestamp(),
						clock_timestamp(),
						'TASY',
						c02_w.cd_operacao_estoque,
						c02_w.cd_pessoa_requisitante,
						c01_w.cd_estabelecimento,
						c02_w.cd_local_estoque_destino,
						'N',
						c02_w.cd_centro_custo);
						
				cd_unidade_medida_estoque_w := obter_dados_material_estab(c02_w.cd_material,c01_w.cd_estabelecimento,'UME');
				qt_requisicao_estoque_w := obter_quantidade_convertida(c02_w.cd_material,qt_material_w,c02_w.cd_unidade_medida,'UME');
			end if;		
			select 	coalesce(max(nr_sequencia),0) + 1
			into STRICT	nr_seq_req_item_w
			from	item_requisicao_material
			where	nr_requisicao	= nr_requisicao_w;
			
			insert into item_requisicao_material(
					nr_requisicao,
					nr_sequencia,
					cd_estabelecimento,
					cd_material,
					qt_material_requisitada,
					qt_material_atendida,
					vl_material,
					dt_atualizacao,
					nm_usuario,
					cd_unidade_medida,
					qt_estoque,
					cd_unidade_medida_estoque,
					ie_acao,
					cd_motivo_baixa)
			values (	nr_requisicao_w,
					nr_seq_req_item_w,
					c01_w.cd_estabelecimento,
					c02_w.cd_material,
					qt_material_w,
					0,
					0,
					clock_timestamp(),
					'TASY',
					c02_w.cd_unidade_medida,
					qt_requisicao_estoque_w,
					cd_unidade_medida_estoque_w,
					'1',
					0);
		end if;
		end;
	end loop;
	close C02;
	
	
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hd_gerar_requisicao_dialisato () FROM PUBLIC;

