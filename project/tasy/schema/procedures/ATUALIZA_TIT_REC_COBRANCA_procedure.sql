-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_tit_rec_cobranca ( nr_seq_cobranca_p bigint, nr_titulo_p bigint, ie_atualiza_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_conta_banco_w	bigint;
cd_banco_w		banco_estabelecimento.cd_banco%type;
cd_agencia_bancaria_w	varchar(8);
cd_conta_w		banco_estabelecimento.cd_conta%type;
ie_digito_conta_w	varchar(2);
nr_seq_conta_titulo_w	bigint;
nr_seq_carteira_cobr_w	bigint;
nr_seq_carteira_tit_w	bigint;
cd_estabelecimento_w	smallint;
ie_alterar_banco_w	varchar(1);
nr_titulo_w		bigint;

c01 CURSOR FOR
SELECT	a.nr_seq_carteira_cobr,
	a.nr_seq_conta_banco,
	a.nr_titulo
from	titulo_receber a
where	a.nr_titulo		= nr_titulo_p
and	ie_atualiza_p		= 'S'

union

SELECT	b.nr_seq_carteira_cobr,
	b.nr_seq_conta_banco,
	b.nr_titulo
from	titulo_receber b,
	titulo_receber_cobr a
where	a.nr_titulo		= b.nr_titulo
and	a.nr_seq_cobranca	= nr_seq_cobranca_p
and	ie_atualiza_p		= 'N';



BEGIN

select	max(a.nr_seq_conta_banco),
	max(a.nr_seq_carteira_cobr),
	max(a.cd_estabelecimento)
into STRICT	nr_seq_conta_banco_w,
	nr_seq_carteira_cobr_w,
	cd_estabelecimento_w
from	cobranca_escritural a
where	a.nr_sequencia	= nr_seq_cobranca_p;

select	max(a.cd_banco),
	max(a.cd_agencia_bancaria),
	max(a.cd_conta),
	coalesce(max(a.ie_digito_conta),'0')
into STRICT	cd_banco_w,
	cd_agencia_bancaria_w,
	cd_conta_w,
	ie_digito_conta_w
from	banco_estabelecimento a
where	a.nr_sequencia	= nr_seq_conta_banco_w;

ie_alterar_banco_w := obter_param_usuario(815, 4, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_alterar_banco_w);

update	titulo_receber_cobr
set	cd_banco		= cd_banco_w,
	cd_agencia_bancaria	= cd_agencia_bancaria_w,
	nr_conta		= cd_conta_w,
	ie_digito_conta		= ie_digito_conta_w,
	nm_usuario		= nm_usuario_p,
	dt_atualizacao		= clock_timestamp()
where (coalesce(cd_banco::text, '') = '' or coalesce(nr_conta::text, '') = '' or coalesce(cd_agencia_bancaria::text, '') = '')
and	nr_seq_cobranca		= nr_seq_cobranca_p;

if (ie_atualiza_p	= 'N') and (coalesce(ie_alterar_banco_w,'N') <> 'N') then

	if (cd_conta_w IS NOT NULL AND cd_conta_w::text <> '') then

		update	titulo_receber_cobr
		set	nr_conta		= cd_conta_w,
			ie_digito_conta		= ie_digito_conta_w,
			nm_usuario		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp()
		where	nr_seq_cobranca		= nr_seq_cobranca_p;

	end if;

	if (cd_agencia_bancaria_w IS NOT NULL AND cd_agencia_bancaria_w::text <> '') then

		update	titulo_receber_cobr
		set	cd_agencia_bancaria	= cd_agencia_bancaria_w,
			nm_usuario		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp()
		where	nr_seq_cobranca		= nr_seq_cobranca_p;

	end if;

end if;

open	c01;
loop
fetch	c01 into
	nr_seq_carteira_tit_w,
	nr_seq_conta_titulo_w,
	nr_titulo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	if	((coalesce(nr_seq_carteira_tit_w::text, '') = '') and (coalesce(nr_seq_conta_titulo_w::text, '') = '')) or (ie_atualiza_p = 'N' and coalesce(ie_alterar_banco_w,'N') in ('S','R','C')) then
		
		if (ie_alterar_banco_w = 'C') then --Somente conta bancaria
		
			update	titulo_receber
			set	nr_seq_conta_banco	= nr_seq_conta_banco_w,				
				nm_usuario		= nm_usuario_p,
				dt_atualizacao		= clock_timestamp()
			where	nr_titulo		= nr_titulo_w;
			
		elsif (ie_alterar_banco_w = 'R') then --Somente carteiroa
		
			update	titulo_receber
			set	nr_seq_carteira_cobr	= nr_seq_carteira_cobr_w,		
				nm_usuario		= nm_usuario_p,
				dt_atualizacao		= clock_timestamp()
			where	nr_titulo		= nr_titulo_w;
			
		else	--Ambos
		
			update	titulo_receber
			set	nr_seq_conta_banco	= nr_seq_conta_banco_w,
				nr_seq_carteira_cobr	= nr_seq_carteira_cobr_w,
				nm_usuario		= nm_usuario_p,
				dt_atualizacao		= clock_timestamp()
			where	nr_titulo		= nr_titulo_w;
		end if;

	end if;

end	loop;
close	c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_tit_rec_cobranca ( nr_seq_cobranca_p bigint, nr_titulo_p bigint, ie_atualiza_p text, nm_usuario_p text) FROM PUBLIC;

