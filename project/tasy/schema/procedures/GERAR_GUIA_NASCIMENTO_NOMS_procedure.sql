-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_guia_nascimento_noms ( dt_inicial_p timestamp, dt_final_p timestamp, ie_sobreescrever_p text) AS $body$
DECLARE


record_w			nom_nascimento%rowtype;
count_linha_w		bigint;
count_nasc_w		bigint;

/*915197 - Dados gerais*/
		
c_consulta_dados CURSOR FOR
	SELECT 	a.nr_atendimento,
			a.cd_pessoa_fisica,
			a.cd_estabelecimento,
			b.nr_sequencia nr_seq_nascimento,
			b.cd_pediatra,
			b.nr_atend_rn,
			b.dt_atualizacao fech_camb,
			b.dt_atualizacao fech_cert,
			'ADMIN' user_alta,
			b.dt_nascimento
	from	atendimento_paciente a,
			nascimento b
	where	a.nr_atendimento = b.nr_atendimento
	and		IE_UNICO_NASC_VIVO  = 'S'
	--and		b.ie_tipo_nascimento in (3,4,10)
	and		b.dt_nascimento between pkg_date_utils.start_of(dt_inicial_p,'MONTH') and pkg_date_utils.end_of(dt_final_p,'MONTH')
	and 	obter_se_atendimento_rn(a.nr_atendimento) = 'S'
	--and		b.nr_dnv is not null
	and		not exists (
			SELECT 1
			from	nom_nascimento x
			where 	x.nr_atendimento = a.nr_atendimento);
				
c_consulta_dados_w c_consulta_dados%rowtype;

c_consulta_pessoa CURSOR FOR
	SELECT 	b.nr_seq_person_name nr_seq_person_name_mae,
			substr(coalesce(b.cd_curp,'SIN INFORMACIÓN'),1,18) C_07,		
			CASE WHEN coalesce(SG_ESTADO_NASC, '')='IN' THEN  n.ie_tipo_pais_nom WHEN coalesce(SG_ESTADO_NASC, '')='' THEN  n.ie_tipo_pais_nom  ELSE (SELECT max(cd_endereco_catalogo)					from end_endereco x					where x.nr_seq_catalogo = obter_catalogo_nom(c_consulta_dados_w.cd_estabelecimento)					and x.ie_informacao = 'ESTADO_PROVINCI'					and (x.sg_estado_tasy = b.sg_estado_nasc or b.sg_estado_nasc = x.cd_endereco_catalogo)) END  C_08,
			CASE WHEN(select max(cd_endereco_catalogo) 					from end_endereco x					where x.nr_seq_catalogo = obter_catalogo_nom(c_consulta_dados_w.cd_estabelecimento)					and x.ie_informacao = 'ESTADO_PROVINCI'					and (x.sg_estado_tasy = b.sg_estado_nasc or b.sg_estado_nasc = x.cd_endereco_catalogo))='99' THEN  '999' WHEN(select max(cd_endereco_catalogo) 					from end_endereco x					where x.nr_seq_catalogo = obter_catalogo_nom(c_consulta_dados_w.cd_estabelecimento)					and x.ie_informacao = 'ESTADO_PROVINCI'					and (x.sg_estado_tasy = b.sg_estado_nasc or b.sg_estado_nasc = x.cd_endereco_catalogo))='33' THEN  '888' WHEN(select max(cd_endereco_catalogo) 					from end_endereco x					where x.nr_seq_catalogo = obter_catalogo_nom(c_consulta_dados_w.cd_estabelecimento)					and x.ie_informacao = 'ESTADO_PROVINCI'					and (x.sg_estado_tasy = b.sg_estado_nasc or b.sg_estado_nasc = x.cd_endereco_catalogo))='34' THEN  '888' WHEN(select max(cd_endereco_catalogo) 					from end_endereco x					where x.nr_seq_catalogo = obter_catalogo_nom(c_consulta_dados_w.cd_estabelecimento)					and x.ie_informacao = 'ESTADO_PROVINCI'					and (x.sg_estado_tasy = b.sg_estado_nasc or b.sg_estado_nasc = x.cd_endereco_catalogo))='35' THEN  '888'  ELSE (select	max(s.CD_CATALOGO_NOM)					from 	sus_municipio s					where 	s.cd_municipio_ibge = b.cd_municipio_ibge) END  C_09,
			b.dt_nascimento C_10,
			obter_idade(b.dt_nascimento,clock_timestamp(),'A') C_11,
			b.ie_considera_indio C_12,
			CASE WHEN coalesce(b.nr_seq_lingua_indigena::text, '') = '' THEN '2'  ELSE '1' END  C_13,
			CASE WHEN b.nr_seq_lingua_indigena='2' THEN  '0000'  ELSE obter_dados_cat_lingua_indig(b.nr_seq_lingua_indigena,'CD_LINGUA_INDIGENA_MF') END  C_14,
			CASE WHEN b.ie_estado_civil='1' THEN '12' WHEN b.ie_estado_civil='2' THEN '11' WHEN b.ie_estado_civil='3' THEN '13' WHEN b.ie_estado_civil='4' THEN '16' WHEN b.ie_estado_civil='5' THEN '14' WHEN b.ie_estado_civil='6' THEN '16' WHEN b.ie_estado_civil='7' THEN '15' WHEN b.ie_estado_civil='9' THEN '88'  ELSE '99' END  C_15,
			substr(get_info_end_endereco(c.nr_seq_pessoa_endereco,'TIPO_LOGRAD','C'),1,2) C_16,
			substr(coalesce(get_info_end_endereco(c.nr_seq_pessoa_endereco,'RUA_VIALIDADE','D'),'SIN INFORMACIÓN'),1,80) C_17,
			substr(coalesce(CASE WHEN get_info_end_endereco(c.nr_seq_pessoa_endereco,'NUMERO','D') ='' THEN  null  ELSE get_info_end_endereco(c.nr_seq_pessoa_endereco,'NUMERO','D') || CASE WHEN get_info_end_endereco(c.nr_seq_pessoa_endereco,'NUM_EXT_ALFA','D')='' THEN  null  ELSE ' ' END  END  || get_info_end_endereco(c.nr_seq_pessoa_endereco,'NUM_EXT_ALFA','D'), '99999999'),1,10) C_18,
			substr(coalesce(CASE WHEN get_info_end_endereco(c.nr_seq_pessoa_endereco,'NUMERO_INT','D') ='' THEN  null  ELSE get_info_end_endereco(c.nr_seq_pessoa_endereco,'NUMERO_INT','D') || CASE WHEN get_info_end_endereco(c.nr_seq_pessoa_endereco,'COMPLEMENTO','D')='' THEN  null  ELSE ' ' END  END  || get_info_end_endereco(c.nr_seq_pessoa_endereco,'COMPLEMENTO','D'), ''),1,20) C_19,
			substr(get_info_end_endereco(c.nr_seq_pessoa_endereco,'TIPO_BAIRRO','C'),1,2) C_20,
			substr(coalesce(get_info_end_endereco(c.nr_seq_pessoa_endereco,'BAIRRO_VILA','D'),'SIN INFORMACIÓN'),1,60) C_21,
			SUBSTR(get_info_end_endereco(c.nr_seq_pessoa_endereco,'CODIGO_POSTAL','D'),1,5) C_22,
			substr(get_info_end_endereco(c.nr_seq_pessoa_endereco,'ESTADO_PROVINCI','C'),1,2) C_23,
			substr(CASE WHEN get_info_end_endereco(c.nr_seq_pessoa_endereco,'ESTADO_PROVINCI','C')='99' THEN  '999'  ELSE get_info_end_endereco(c.nr_seq_pessoa_endereco,'MUNICIPIO','C') END ,1,3) C_24,
			substr(CASE WHEN get_info_end_endereco(c.nr_seq_pessoa_endereco,'ESTADO_PROVINCI','C')='99' THEN  '9999'  ELSE CASE WHEN get_info_end_endereco(c.nr_seq_pessoa_endereco,'MUNICIPIO','C')='999' THEN '9999'  ELSE get_info_end_endereco(c.nr_seq_pessoa_endereco,'LOCALIDADE_AREA','C') END  END , 1,4) C_25,
			substr(trim(both c.nr_ddd_telefone)||trim(both c.nr_telefone),1,15) C_26,
			CASE WHEN obter_convenio_atend_mx(c_consulta_dados_w.nr_atendimento,1,'CD_DER_NACIMIENTO')='07' THEN  ''  ELSE b.nr_spss END  C_41,/*nao utilizado mais*/

			--DECODE(b.ie_grau_instrucao,'1','01','2','03','3','05','4','07','5','10','6','10','7','02','8','05','9','06','10','03','11','01','12','10','13','10','14','88','15','08','99') C_43,
			CASE WHEN b.ie_grau_instrucao='1' THEN '03' WHEN b.ie_grau_instrucao='2' THEN '03' WHEN b.ie_grau_instrucao='3' THEN '05' WHEN b.ie_grau_instrucao='4' THEN '05' WHEN b.ie_grau_instrucao='5' THEN '07' WHEN b.ie_grau_instrucao='6' THEN '07' WHEN b.ie_grau_instrucao='7' THEN '08' WHEN b.ie_grau_instrucao='8' THEN '08' WHEN b.ie_grau_instrucao='9' THEN '10' WHEN b.ie_grau_instrucao='10' THEN '10' WHEN b.ie_grau_instrucao='11' THEN '10' WHEN b.ie_grau_instrucao='12' THEN '10' WHEN b.ie_grau_instrucao='16' THEN '10' WHEN b.ie_grau_instrucao='17' THEN '10' WHEN b.ie_grau_instrucao='18' THEN '03' WHEN b.ie_grau_instrucao='19' THEN '03' WHEN b.ie_grau_instrucao='20' THEN '01' WHEN b.ie_grau_instrucao='14' THEN '88' WHEN b.ie_grau_instrucao='15' THEN '08'  ELSE '99' END  C_43,
			SUBSTR(coalesce(obter_desc_cargo(b.cd_cargo),'SIN INFORMACIÓN'),1,40) C_44,
			b.cd_cargo,
			c.nr_seq_pessoa_endereco,
			c.nr_ddi_telefone
	FROM	pessoa_fisica b,
			compl_pessoa_fisica c,
			nacionalidade n
	WHERE 	b.cd_pessoa_fisica = c_consulta_dados_w.cd_pessoa_fisica
	AND		b.cd_pessoa_fisica = c.cd_pessoa_fisica
	AND		b.cd_nacionalidade = n.cd_nacionalidade
	AND		c.ie_tipo_complemento	= 1;
c_consulta_pessoa_w c_consulta_pessoa%rowtype;

/*Dados nascimento - 926411*/

c_consulta_nascimento CURSOR FOR
	 SELECT b.dt_nascimento,
			lpad(b.nr_dnv,9,'0') FOLIO,
			(CASE WHEN(PKG_DATE_UTILS.extract_field('YEAR', b.dt_nascimento) < 2010) then 'ANTERIOR'
					WHEN(PKG_DATE_UTILS.extract_field('YEAR',b.dt_nascimento) between 2010 and 2014) then '2010'
					else '2015'
				end) TIPO_FORMATO,
			b.dt_nascimento FECH_NACH,
			PKG_DATE_FORMATERS.TO_VARCHAR(b.dt_nascimento,'shortTime', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) HORA_NACH,
			CASE WHEN coalesce(b.ie_sexo,'X')='M' THEN '1' WHEN coalesce(b.ie_sexo,'X')='F' THEN '2'  ELSE '9' END  SEXOH,
			b.qt_sem_ig_total GESTACH,
			coalesce(b.qt_altura,'99') TALLAH,
			coalesce(b.qt_peso_sala_parto, '9999') PESOH,
			coalesce(b.qt_apgar_quinto_min,'99') APGARH,
			--obter_inf_nasc_nom(b.nr_sequencia,b.nr_atendimento,'B') BCG,
			(SELECT 	max(z.ie_cat_nom)
			FROM	atend_vacina_teste x,
					vacina_teste_rn y,
					RESULT_VACINA_TESTE_RN z
			WHERE	x.nr_seq_nascimento = b.nr_sequencia
			AND		x.nr_atendimento = b.nr_atendimento
			AND		y.nr_sequencia = x.nr_seq_teste_vacina
			AND		z.nr_seq_vacina_teste = y.nr_sequencia
			AND		z.nr_sequencia = x.nr_seq_result
				AND		coalesce(y.ie_tipo_vacina,'N') = 'B') BCG,
			--obter_inf_nasc_nom(b.nr_sequencia,b.nr_atendimento,'H') HEP_B,
			(SELECT 	max(ie_cat_nom)
			FROM	atend_vacina_teste x,
					vacina_teste_rn y,
					RESULT_VACINA_TESTE_RN z
			WHERE	x.nr_seq_nascimento = b.nr_sequencia
			AND		x.nr_atendimento = b.nr_atendimento
			AND		y.nr_sequencia = x.nr_seq_teste_vacina
			AND		z.nr_seq_vacina_teste = y.nr_sequencia
			AND		z.nr_sequencia = x.nr_seq_result
				AND		coalesce(y.ie_tipo_vacina,'N') = 'H') HEP_B,
			CASE WHEN b.ie_vitamina_a='S' THEN '1' WHEN b.ie_vitamina_a='N' THEN '2'  ELSE b.ie_vitamina_a END  VIT_A,
			CASE WHEN b.ie_vitamina_k='S' THEN '1' WHEN b.ie_vitamina_k='N' THEN '2'  ELSE b.ie_vitamina_k END  VIT_K,
			'0' TAM_MET,
			CASE WHEN obter_inf_nasc_nom(b.nr_sequencia,b.nr_atendimento,'A')='S' THEN '1'  ELSE '2' END  TAM_AUD,
			coalesce(f.IE_TIPO_PRODUTO,'1') PRODUCTO,
			CASE WHEN obter_inf_doenca_cid_atend(b.nr_atend_rn,1,'MAL')='ANMRN' THEN 'S'  ELSE 'N' END  IE_MALFORMACAO_1,
			CASE WHEN obter_inf_doenca_cid_atend(b.nr_atend_rn,2,'MAL')='ANMRN' THEN 'S'  ELSE 'N' END  IE_MALFORMACAO_2,
			b.ie_parto_normal,
			b.ie_parto_distocico,
			b.ie_parto_forceps,
			b.ie_parto_cesaria,
			CASE WHEN b.ie_parto_forceps='S' THEN '1'  ELSE '2' END  FORCEPS,
			b.ds_outro_tipo_parto ESPECIFIQUE,
			b.ie_local_nasc,
			b.nr_seq_pessoa_endereco,
			f.ie_local_nascimento,
			obter_dados_cat_prof_parto(b.nr_seq_prof_parto,'CD_ATEND_PARTO') ATENDIO,
			b.ds_espec_resp ATEN_OTRO,
			substr(trim(both coalesce(obter_dados_cat_cert_parto(b.nr_seq_cert_parto,'CD_CERT_PARTO'),'9')),1,1) cert_por,
			substr(trim(both CASE WHEN trim(both coalesce(obter_dados_cat_cert_parto(b.nr_seq_cert_parto,'CD_CERT_PARTO'),'9'))=--'1',nvl(obter_nome_pf(nvl(b.cd_pediatra,nvl(f.cd_medico,f.cd_enfermagem))),'SIN INFORMACIÓN'),

					--'7',nvl(obter_nome_pf(nvl(b.cd_pediatra,nvl(f.cd_medico,f.cd_enfermagem))),'SIN INFORMACIÓN'),
					'2' THEN coalesce(b.ds_espec_cert,'SIN INFORMACIÓN') WHEN trim(both coalesce(obter_dados_cat_cert_parto(b.nr_seq_cert_parto,'CD_CERT_PARTO'),'9'))='6' THEN coalesce(b.ds_espec_cert,'SIN INFORMACIÓN')  ELSE --'4',nvl(obter_nome_pf(nvl(b.cd_pediatra,nvl(f.cd_medico,f.cd_enfermagem))),'SIN INFORMACIÓN'),
					'' END ),1,25) otromedico,
			substr(trim(both CASE WHEN trim(both coalesce(obter_dados_cat_cert_parto(b.nr_seq_cert_parto,'CD_CERT_PARTO'),'9'))='1' THEN coalesce(obter_dados_pf(b.cd_pediatra,'CPR'),'SIN INFORMACIÓN') WHEN trim(both coalesce(obter_dados_cat_cert_parto(b.nr_seq_cert_parto,'CD_CERT_PARTO'),'9'))='2' THEN coalesce(b.ds_cedula_prof_cert,'SIN INFORMACIÓN') WHEN trim(both coalesce(obter_dados_cat_cert_parto(b.nr_seq_cert_parto,'CD_CERT_PARTO'),'9'))=--'4',nvl(obter_dados_pf(nvl(b.cd_pediatra,nvl(f.cd_medico,f.cd_enfermagem)),'CPR'),'SIN INFORMACIÓN'),
				'7' THEN coalesce(obter_dados_pf(f.cd_medico,'CPR'),'SIN INFORMACIÓN')  ELSE '' END ),1,20) ced_medc,
			trim(both coalesce(obter_dados_cat_lugar_cert_nac(b.nr_seq_local_cert_nasc,'CD_LUG_CERT_NASC'),'9')) idcaptura,
			coalesce(f.qt_gestacoes,0) +1 C_27,
			coalesce(f.qt_natimortos + (SELECT COUNT(*)
									FROM nascimento n
									WHERE n.ie_unico_nasc_vivo = 'N'
									AND n.nr_atendimento = c_consulta_dados_w.nr_atendimento
									AND n.dt_nascimento < c_consulta_dados_w.dt_nascimento),'99') C_28,
			coalesce((SELECT max(n.dt_nascimento)
				FROM nascimento n
				WHERE n.nr_atendimento = c_consulta_dados_w.nr_atendimento
				AND n.dt_nascimento < c_consulta_dados_w.dt_nascimento),f.DT_ULT_PARTO) C_33,
			b.nr_sequencia NR_SEQ_NASCIMENTO,
			coalesce(f.qt_natimortos + f.qt_filhos_vivos + (SELECT COUNT(*)
														FROM nascimento n
														WHERE n.nr_atendimento = c_consulta_dados_w.nr_atendimento
														AND n.dt_nascimento <= c_consulta_dados_w.dt_nascimento),'1') C_34,
			CASE WHEN f.ie_pre_natal='S' THEN '1' WHEN f.ie_pre_natal='N' THEN '2'  ELSE f.ie_pre_natal END  C_35,
			coalesce(IE_TRIMESTRE_PRE_NAT,'9') C_36,
			CASE WHEN coalesce(f.ie_pre_natal,'N')='N' THEN '0'  ELSE coalesce(f.qt_consultas,0) END  C_37,
			CASE WHEN coalesce(OBTER_DECLARACAO_OBITO(b.nr_atendimento)::text, '') = '' THEN '1'  ELSE '2' END  C_38,
			--substr(NVL(OBTER_DECLARACAO_OBITO(b.nr_atendimento), '999999999'),1,9) C_39,
			CASE WHEN f.ie_sobreviveu_parto='N' THEN substr(coalesce(OBTER_DECLARACAO_OBITO(b.nr_atendimento), '999999999'),1,9)  ELSE null END  C_39,
			lpad(obter_convenio_atend_mx(b.nr_atendimento,1,'CD_DER_NACIMIENTO'),2,0) C_40,
			obter_convenio_atend_mx(b.nr_atendimento,1,'CD_USUARIO_CONVENIO') C_41,
			lpad(CASE WHEN coalesce(obter_convenio_atend_mx(b.nr_atendimento,1,'CD_DER_NACIMIENTO'),'01')='01' THEN '00'  ELSE obter_convenio_atend_mx(b.nr_atendimento,2,'CD_DER_NACIMIENTO') END ,2,0) C_42,
			f.ie_cond_ult_nasc,
			f.ie_ult_filho_vivo,
			b.cd_pediatra,
			f.cd_enfermagem,
			f.cd_medico,
			b.nr_seq_person_cer,
			b.nr_seq_cert_parto,
			CASE WHEN f.ie_sobreviveu_parto='S' THEN '1' WHEN f.ie_sobreviveu_parto='N' THEN '2'  ELSE f.ie_sobreviveu_parto END  ie_sobreviveu_parto,
			b.ie_outro_tipo_parto
	FROM	nascimento b,
			parto f
	WHERE	b.nr_atendimento = f.nr_atendimento
	and		b.nr_atendimento = c_consulta_dados_w.nr_atendimento
	and		b.nr_sequencia = c_consulta_dados_w.nr_seq_nascimento;
c_consulta_nascimento_w c_consulta_nascimento%rowtype;

		
/*Dados certificante - 926448*/

c_consulta_estabelecimento CURSOR FOR
	SELECT	lpad(CASE WHEN c_consulta_nascimento_w.ie_local_nasc='99' THEN 13 WHEN c_consulta_nascimento_w.ie_local_nasc='04' THEN 11 WHEN c_consulta_nascimento_w.ie_local_nasc='03' THEN 12  ELSE coalesce(g.ie_tipo_inst_saude,'99') END ,2,'0') INST_NAC,
			substr(coalesce(CASE WHEN c_consulta_nascimento_w.ie_local_nasc='99' THEN null WHEN c_consulta_nascimento_w.ie_local_nasc='04' THEN null WHEN c_consulta_nascimento_w.ie_local_nasc='03' THEN null  ELSE obter_dados_cat_clues(g.cd_internacional,'DS_ESTAB_SAUDE') END ,'NO ESPECIFICADO'),1,50) UNIMED,
			CASE WHEN c_consulta_nascimento_w.ie_local_nasc='99' THEN '9998' WHEN c_consulta_nascimento_w.ie_local_nasc='04' THEN '9998' WHEN c_consulta_nascimento_w.ie_local_nasc='03' THEN '9998'  ELSE obter_dados_cat_clues(g.cd_internacional,'CD_CLUES') END  CLUES,
			substr(coalesce(CASE WHEN c_consulta_nascimento_w.ie_local_nascimento='99' THEN obter_dados_cat_clues(g.cd_internacional,'DS_ESTAB_SAUDE') WHEN c_consulta_nascimento_w.ie_local_nascimento='04' THEN obter_dados_cat_clues(g.cd_internacional,'DS_ESTAB_SAUDE') WHEN c_consulta_nascimento_w.ie_local_nascimento='03' THEN obter_dados_cat_clues(g.cd_internacional,'DS_ESTAB_SAUDE')  ELSE 'NO APLICA' END ,'NO ESPECIFICADO'),1,50) unimed_33_1,
			CASE WHEN c_consulta_nascimento_w.ie_local_nascimento='99' THEN obter_dados_cat_clues(g.cd_internacional,'CD_CLUES') WHEN c_consulta_nascimento_w.ie_local_nascimento='04' THEN obter_dados_cat_clues(g.cd_internacional,'CD_CLUES') WHEN c_consulta_nascimento_w.ie_local_nascimento='03' THEN obter_dados_cat_clues(g.cd_internacional,'CD_CLUES')  ELSE '9999' END  clues_33_2,
			substr(coalesce(get_info_end_endereco(g.nr_seq_pessoa_endereco,'TIPO_LOGRAD','C'),obter_conversao_catalogo_nom('NACIMIENTOS','TIPO_LOGRAD','R','NO_ESPECIFICADO')),1,2) tipovial_cert,
			substr(get_info_end_endereco(g.nr_seq_pessoa_endereco,'RUA_VIALIDADE','D'),1,80) calle_cert,
			--substr(nvl(get_info_end_endereco(g.nr_seq_pessoa_endereco,'NUMERO','D'),'9999999999'),1,10) numext_cert,

			--substr(get_info_end_endereco(g.nr_seq_pessoa_endereco,'COMPLEMENTO','D'),1,5) numint_cert,
			substr(coalesce(CASE WHEN get_info_end_endereco(g.nr_seq_pessoa_endereco,'NUMERO','D') ='' THEN  null  ELSE get_info_end_endereco(g.nr_seq_pessoa_endereco,'NUMERO','D') || CASE WHEN get_info_end_endereco(g.nr_seq_pessoa_endereco,'NUM_EXT_ALFA','D')='' THEN  null  ELSE ' ' END  END  || get_info_end_endereco(g.nr_seq_pessoa_endereco,'NUM_EXT_ALFA','D'), 'SIN NUMERO'),1,10) numext_cert,
			substr(coalesce(CASE WHEN get_info_end_endereco(g.nr_seq_pessoa_endereco,'NUMERO_INT','D') ='' THEN  null  ELSE get_info_end_endereco(g.nr_seq_pessoa_endereco,'NUMERO_INT','D') || CASE WHEN get_info_end_endereco(g.nr_seq_pessoa_endereco,'COMPLEMENTO','D')='' THEN  null  ELSE ' ' END  END  || get_info_end_endereco(g.nr_seq_pessoa_endereco,'COMPLEMENTO','D'), 'SIN NUMERO'),1,20) numint_cert,

			substr(get_info_end_endereco(g.nr_seq_pessoa_endereco,'TIPO_BAIRRO','C'),1,2) tipoasen_cert,
			substr(coalesce(get_info_end_endereco(g.nr_seq_pessoa_endereco,'BAIRRO_VILA','D'),'SIN INFORMACIÓN'),1,60) nomasen_cert,
			SUBSTR(get_info_end_endereco(g.nr_seq_pessoa_endereco,'CODIGO_POSTAL','D'),1,5) codpos_cert,
			substr(get_info_end_endereco(g.nr_seq_pessoa_endereco,'ESTADO_PROVINCI','C'),1,2) ent_cert,
			substr(get_info_end_endereco(g.nr_seq_pessoa_endereco,'MUNICIPIO','C'),1,3) mpo_cert,
			substr(get_info_end_endereco(g.nr_seq_pessoa_endereco,'LOCALIDADE_AREA','C'),1,4) loc_cert,
			SUBSTR(replace(replace(trim(both g.nr_ddd_telefone)||trim(both g.nr_telefone),'(',''),')',''),1,12) tel_cert,
			g.nr_ddi_telefone,
			/*Direccion nascimento*/

			substr(CASE WHEN c_consulta_nascimento_w.ie_local_nasc='99' THEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'TIPO_LOGRAD','C') WHEN c_consulta_nascimento_w.ie_local_nasc='04' THEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'TIPO_LOGRAD','C') WHEN c_consulta_nascimento_w.ie_local_nasc='03' THEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'TIPO_LOGRAD','C')  ELSE get_info_end_endereco(g.nr_seq_pessoa_endereco,'TIPO_LOGRAD','C') END ,1,2) TIPOVIAL_NAC,
			substr(CASE WHEN c_consulta_nascimento_w.ie_local_nasc='99' THEN  get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'RUA_VIALIDADE','D') WHEN c_consulta_nascimento_w.ie_local_nasc='04' THEN  get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'RUA_VIALIDADE','D') WHEN c_consulta_nascimento_w.ie_local_nasc='03' THEN  get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'RUA_VIALIDADE','D')  ELSE get_info_end_endereco(g.nr_seq_pessoa_endereco,'RUA_VIALIDADE','D') END ,1,80) CALLE_NAC,
			/*substr(nvl(decode(c_consulta_nascimento_w.ie_local_nasc,
					'99', get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'NUMERO','D'),
					'04', get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'NUMERO','D'),
					'03', get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'NUMERO','D'),
					get_info_end_endereco(g.nr_seq_pessoa_endereco,'NUMERO','D')),'9999999999'),1,10)  NUMEXT_NAC,
			substr(decode(c_consulta_nascimento_w.ie_local_nasc,
					'99',get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'COMPLEMENTO','D'),
					'04',get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'COMPLEMENTO','D'),
					'03',get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'COMPLEMENTO','D'),
                    get_info_end_endereco(g.nr_seq_pessoa_endereco,'COMPLEMENTO','D')),1,5) NUMINT_NAC,*/
					substr(CASE WHEN c_consulta_nascimento_w.ie_local_nasc='99' THEN  coalesce(CASE WHEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'NUMERO','D') ='' THEN  null  ELSE get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'NUMERO','D') || CASE WHEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'NUM_EXT_ALFA','D')='' THEN  null  ELSE ' ' END  END  || get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'NUM_EXT_ALFA','D'), 'SIN NUMERO') WHEN c_consulta_nascimento_w.ie_local_nasc='04' THEN  coalesce(CASE WHEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'NUMERO','D') ='' THEN  null  ELSE get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'NUMERO','D') || CASE WHEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'NUM_EXT_ALFA','D')='' THEN  null  ELSE ' ' END  END  || get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'NUM_EXT_ALFA','D'), 'SIN NUMERO') WHEN c_consulta_nascimento_w.ie_local_nasc='03' THEN  coalesce(CASE WHEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'NUMERO','D') ='' THEN  null  ELSE get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'NUMERO','D') || CASE WHEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'NUM_EXT_ALFA','D')='' THEN  null  ELSE ' ' END  END  || get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'NUM_EXT_ALFA','D'), 'SIN NUMERO')  ELSE coalesce(CASE WHEN get_info_end_endereco(g.nr_seq_pessoa_endereco,'NUMERO','D') ='' THEN  null  ELSE get_info_end_endereco(g.nr_seq_pessoa_endereco,'NUMERO','D') || CASE WHEN get_info_end_endereco(g.nr_seq_pessoa_endereco,'NUM_EXT_ALFA','D')='' THEN  null  ELSE ' ' END  END  || get_info_end_endereco(g.nr_seq_pessoa_endereco,'NUM_EXT_ALFA','D'), 'SIN NUMERO') END ,1,10)  NUMEXT_NAC,
			substr(CASE WHEN c_consulta_nascimento_w.ie_local_nasc='99' THEN coalesce(CASE WHEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'NUMERO_INT','D') ='' THEN  null  ELSE get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'NUMERO_INT','D') || CASE WHEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'COMPLEMENTO','D')='' THEN  null  ELSE ' ' END  END  || get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'COMPLEMENTO','D'), 'SIN NUMERO') WHEN c_consulta_nascimento_w.ie_local_nasc='04' THEN coalesce(CASE WHEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'NUMERO_INT','D') ='' THEN  null  ELSE get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'NUMERO_INT','D') || CASE WHEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'COMPLEMENTO','D')='' THEN  null  ELSE ' ' END  END  || get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'COMPLEMENTO','D'), 'SIN NUMERO') WHEN c_consulta_nascimento_w.ie_local_nasc='03' THEN coalesce(CASE WHEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'NUMERO_INT','D') ='' THEN  null  ELSE get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'NUMERO_INT','D') || CASE WHEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'COMPLEMENTO','D')='' THEN  null  ELSE ' ' END  END  || get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'COMPLEMENTO','D'), 'SIN NUMERO')  ELSE coalesce(CASE WHEN get_info_end_endereco(g.nr_seq_pessoa_endereco,'NUMERO_INT','D') ='' THEN  null  ELSE get_info_end_endereco(g.nr_seq_pessoa_endereco,'NUMERO_INT','D') || CASE WHEN get_info_end_endereco(g.nr_seq_pessoa_endereco,'COMPLEMENTO','D')='' THEN  null  ELSE ' ' END  END  || get_info_end_endereco(g.nr_seq_pessoa_endereco,'COMPLEMENTO','D'), 'SIN NUMERO') END ,1,20) NUMINT_NAC,

			substr(coalesce(CASE WHEN c_consulta_nascimento_w.ie_local_nasc='99' THEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'TIPO_BAIRRO','C') WHEN c_consulta_nascimento_w.ie_local_nasc='04' THEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'TIPO_BAIRRO','C') WHEN c_consulta_nascimento_w.ie_local_nasc='03' THEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'TIPO_BAIRRO','C')  ELSE get_info_end_endereco(g.nr_seq_pessoa_endereco,'TIPO_BAIRRO','C') END ,obter_conversao_catalogo_nom('NACIMIENTOS','TIPO_BAIRRO','R','NO_ESPECIFICADO')),1,2) TIPOASEN_NAC,
			substr(coalesce(CASE WHEN c_consulta_nascimento_w.ie_local_nasc='99' THEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'BAIRRO_VILA','D') WHEN c_consulta_nascimento_w.ie_local_nasc='04' THEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'BAIRRO_VILA','D') WHEN c_consulta_nascimento_w.ie_local_nasc='03' THEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'BAIRRO_VILA','D')  ELSE get_info_end_endereco(g.nr_seq_pessoa_endereco,'BAIRRO_VILA','D') END ,'SIN INFORMACIÓN'),1,60) NOMASEN_NAC,
			SUBSTR(coalesce(CASE WHEN c_consulta_nascimento_w.ie_local_nasc='99' THEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'CODIGO_POSTAL','D') WHEN c_consulta_nascimento_w.ie_local_nasc='04' THEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'CODIGO_POSTAL','D') WHEN c_consulta_nascimento_w.ie_local_nasc='03' THEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'CODIGO_POSTAL','D')  ELSE get_info_end_endereco(g.nr_seq_pessoa_endereco,'CODIGO_POSTAL','D') END , '99999'),1,5) CODPOS_NAC,
			substr(CASE WHEN c_consulta_nascimento_w.ie_local_nasc='99' THEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'ESTADO_PROVINCI','C') WHEN c_consulta_nascimento_w.ie_local_nasc='04' THEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'ESTADO_PROVINCI','C') WHEN c_consulta_nascimento_w.ie_local_nasc='03' THEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'ESTADO_PROVINCI','C')  ELSE get_info_end_endereco(g.nr_seq_pessoa_endereco,'ESTADO_PROVINCI','C') END ,1,2)  ENT_NAC,
			substr(coalesce(CASE WHEN c_consulta_nascimento_w.ie_local_nasc='99' THEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'MUNICIPIO','C') WHEN c_consulta_nascimento_w.ie_local_nasc='04' THEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'MUNICIPIO','C') WHEN c_consulta_nascimento_w.ie_local_nasc='03' THEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'MUNICIPIO','C')  ELSE get_info_end_endereco(g.nr_seq_pessoa_endereco,'MUNICIPIO','C') END ,obter_conversao_catalogo_nom('NACIMIENTOS','MUNICIPIO','R','NO_ESPECIFICADO')),1,3) MPO_NAC,			
			substr(coalesce(CASE WHEN c_consulta_nascimento_w.ie_local_nasc='99' THEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'LOCALIDADE_AREA','C') WHEN c_consulta_nascimento_w.ie_local_nasc='04' THEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'LOCALIDADE_AREA','C') WHEN c_consulta_nascimento_w.ie_local_nasc='03' THEN get_info_end_endereco(c_consulta_nascimento_w.nr_seq_pessoa_endereco,'LOCALIDADE_AREA','C')  ELSE get_info_end_endereco(g.nr_seq_pessoa_endereco,'LOCALIDADE_AREA','C') END ,obter_conversao_catalogo_nom('NACIMIENTOS','LOCALIDADE_AREA','R','NO_ESPECIFICADO')),1,4) LOC_NAC,
			obter_dados_cat_clues(g.cd_internacional,'CD_ESTADO') CEDOCVE,
			g.nr_seq_pessoa_endereco,
			f.cd_estabelecimento
	from	estabelecimento f,
			pessoa_juridica g
	where	f.cd_estabelecimento = c_consulta_dados_w.cd_estabelecimento
	and		f.cd_cgc = g.cd_cgc;
c_consulta_estabelecimento_w c_consulta_estabelecimento%rowtype;

c_consulta_pediatra CURSOR FOR
	SELECT	p.nr_seq_person_name
	from	pessoa_fisica p
	where 	p.cd_pessoa_fisica = (SELECT max(CASE WHEN c_consulta_nascimento_w.nr_seq_cert_parto='1' THEN c_consulta_nascimento_w.cd_pediatra WHEN c_consulta_nascimento_w.nr_seq_cert_parto='3' THEN c_consulta_nascimento_w.cd_enfermagem WHEN c_consulta_nascimento_w.nr_seq_cert_parto='7' THEN c_consulta_nascimento_w.cd_medico WHEN c_consulta_nascimento_w.nr_seq_cert_parto='8' THEN null  ELSE c_consulta_nascimento_w.nr_seq_person_cer END )
									);
c_consulta_pediatra_w c_consulta_pediatra%rowtype;

c_doenca_acel CURSOR FOR
	SELECT 	coalesce(obter_desc_cid(n.cd_doenca_superior), null) cid_doenca_superior,
			coalesce(n.cd_doenca_superior, null) cd_doenca_superior,
			coalesce(n.ds_doenca_sup, null) ds_doenca_sup,
			coalesce(obter_desc_cid(n.cd_doenca), null) cid_doenca,
			coalesce(n.cd_doenca, null) cd_doenca,
			coalesce(n.ds_doenca, null) ds_doenca
	FROM nascimento_evento n
LEFT OUTER JOIN cid_doenca c ON (n.cd_doenca_superior = c.cd_doenca_cid)
WHERE n.nr_atendimento 	= c_consulta_dados_w.nr_atendimento  --and		c.ie_doenca_cronica_mx = 'ANMRN'
  and n.ie_malformacao = 'S' and n.nr_seq_nascimento = c_consulta_dados_w.nr_seq_nascimento;
c_doenca_acel_w c_doenca_acel%rowtype;

c_lista_problema_pac CURSOR FOR
	SELECT	ds_problema
	from	lista_problema_pac
	where	nr_atendimento = c_consulta_dados_w.nr_atendimento
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	ie_situacao = 'A'
	and	(ds_problema IS NOT NULL AND ds_problema::text <> '')
	Order by nr_sequencia;
	
c_lista_problema_pac_w c_lista_problema_pac%ROWTYPE;


BEGIN
if (dt_inicial_p IS NOT NULL AND dt_inicial_p::text <> '') and (dt_final_p IS NOT NULL AND dt_final_p::text <> '') then
	begin
	
	if (ie_sobreescrever_p = 'S') then
		delete	from nom_nascimento
		where 	dt_nascimento_nasc between pkg_date_utils.start_of(dt_inicial_p,'MONTH') and pkg_date_utils.end_of(dt_final_p,'MONTH')
		and		coalesce(dt_liberacao::text, '') = '';
		commit;
	end if;
	
	open c_consulta_dados;
	loop
	fetch c_consulta_dados into
		c_consulta_dados_w;
	EXIT WHEN NOT FOUND; /* apply on c_consulta_dados */
		begin

		select	coalesce(max(QT_SILVERMAN_EXAME),'99')
		into STRICT	record_w.qt_qualif_nascido
		FROM	nascimento b
		where	b.nr_atendimento = c_consulta_dados_w.nr_atendimento
		and		b.nr_sequencia = c_consulta_dados_w.nr_seq_nascimento;
		
		select 	coalesce(max(f.qt_filhos_vivos) + count(x.nr_sequencia),'99') num_nacvivo /*C_29*/
		into STRICT	record_w.qt_natvivos
		from	nascimento x,
				parto f
		where	x.nr_atendimento = f.nr_atendimento
		and		f.nr_atendimento = c_consulta_dados_w.nr_atendimento 
		and 	x.ie_unico_nasc_vivo = 'S'
		and		x.dt_nascimento <= c_consulta_dados_w.dt_nascimento;
		
		select	coalesce(max(f.qt_sobreviventes) + count(n.nr_dnv),'99') hijo_sobv /*C_30*/
		into STRICT	record_w.qt_sobreviventes
		from 	nascimento n,
				parto f
		where 	n.nr_atendimento = f.nr_atendimento
		and		n.nr_atendimento = c_consulta_dados_w.nr_atendimento
		and 	coalesce(n.dt_inativacao::text, '') = ''
		and 	(n.dt_liberacao IS NOT NULL AND n.dt_liberacao::text <> '')
		and		n.ie_unico_nasc_vivo = 'S'
		and		n.dt_nascimento <= c_consulta_dados_w.dt_nascimento;
		
		select 	count(*)
		into STRICT	count_nasc_w
		from	nascimento n 
		where 	n.nr_atendimento = c_consulta_dados_w.nr_atendimento 
		and 	n.dt_nascimento < c_consulta_dados_w.dt_nascimento;
				
				
				
		/*select	DECODE((SELECT	max(t.cd_ocupacao_nascimento) 
						FROM	cargo w, 
								cat_ocupacao_hab t 
						WHERE 	w.cd_cargo = b.cd_cargo 
						and 	t.cd_ocupacao = w.cd_externo),
						'01','0','02','0','03','0','04','0', DECODE(b.cd_cargo,NULL,'2','1')) trab_act C_46
		into	record_w.ie_trab_atualmente
		from	pessoa_fisica b
		where	b.cd_pessoa_fisica = c_consulta_dados_w.cd_pessoa_fisica;*/
		
		select 	max(x.ie_trabalha_atual)
		into STRICT	record_w.ie_trab_atualmente
		from 	complemento_mexico x 
		where 	nr_atendimento = c_consulta_dados_w.nr_atendimento;
		
		record_w.DT_CERTIFICADO 		:= c_consulta_dados_w.fech_cert;
		record_w.NM_USUARIO_CERT 		:= c_consulta_dados_w.user_alta;
		record_w.DT_CAPT_CERT			:= c_consulta_dados_w.fech_cert;
		record_w.NM_USUARIO_MODIF 		:= c_consulta_dados_w.user_alta;
		record_w.DT_MODIFICACAO 		:= c_consulta_dados_w.fech_camb;
		record_w.dt_atualizacao 		:= c_consulta_dados_w.fech_camb;
		record_w.nm_usuario 		:= c_consulta_dados_w.user_alta;
		record_w.nr_atendimento 		:= c_consulta_dados_w.nr_atendimento;
		
		open c_consulta_pessoa;
		loop
		fetch c_consulta_pessoa into
			c_consulta_pessoa_w;
		EXIT WHEN NOT FOUND; /* apply on c_consulta_pessoa */	
			begin

			/*select 	nvl(max(t.cd_ocupacao_nascimento),'99') cveocuphab C_45
			into	record_w.cd_ocupacao
			FROM 	cargo w, 
					cat_ocupacao_hab t 
			WHERE 	t.cd_ocupacao = w.cd_externo
			and		w.cd_cargo = c_consulta_pessoa_w.cd_cargo; */
			
			select max(y.cd_ocupacao_nascimento),
					substr(max(y.nm_ocupacao),1,40)
			into STRICT	record_w.cd_ocupacao,
					record_w.DS_OCUPACAO
			from complemento_mexico x,
					cat_ocupacao_hab y
			where nr_atendimento = c_consulta_dados_w.nr_atendimento
			and		x.ie_ocupacao_habitual = y.cd_ocupacao;
			
			SELECT nextval('person_name_seq')
			INTO STRICT record_w.NR_SEQ_PERSON_NAME_MAE
			;
	
			INSERT INTO person_name(nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,ds_type,ds_given_name,ds_family_name,ds_component_name_1,ds_component_name_2,ds_component_name_3)
			SELECT record_w.NR_SEQ_PERSON_NAME_MAE,clock_timestamp(),wheb_usuario_pck.get_nm_usuario,clock_timestamp(),wheb_usuario_pck.get_nm_usuario,ds_type,ds_given_name,ds_family_name,coalesce(ds_component_name_1, 'SIN INFORMACION'),ds_component_name_2,ds_component_name_3
			FROM person_name
			WHERE nr_sequencia = c_consulta_pessoa_w.nr_seq_person_name_mae;
			
			record_w.CD_CURP_MAE	 		:= c_consulta_pessoa_w.C_07;
			record_w.CD_ESTADO_NASC_MAE		:= c_consulta_pessoa_w.C_08;
			record_w.CD_MUNICIPIO_NASC_MAE	:= c_consulta_pessoa_w.C_09;
			record_w.DT_NASCIMENTO_MAE 		:= c_consulta_pessoa_w.C_10;
			record_w.QT_IDADE_MAE 			:= c_consulta_pessoa_w.C_11;
			record_w.IE_INDIGENA	 		:= c_consulta_pessoa_w.C_12;
			record_w.IE_FALA_LINGUA_INDIGENA := c_consulta_pessoa_w.C_13;
			record_w.CD_LINGUA_INDIGENA		:= c_consulta_pessoa_w.C_14;
			record_w.IE_ESTADO_CIVIL_MAE	:= c_consulta_pessoa_w.C_15;
			record_w.CD_TIPO_LOGRAD_RES		:= c_consulta_pessoa_w.C_16;
			record_w.DS_RUA_VIALIDADE_RES	:= c_consulta_pessoa_w.C_17;
			record_w.NR_NUMERO_EXTERNO_RES	:= c_consulta_pessoa_w.C_18;
			record_w.NR_NUMERO_INTERNO_RES	:= c_consulta_pessoa_w.C_19;
			record_w.CD_TIPO_BAIRRO_RES		:= c_consulta_pessoa_w.C_20;
			record_w.DS_TIPO_BAIRRO_RES		:= c_consulta_pessoa_w.C_21;
			record_w.CD_CODIGO_POSTAL_RES	:= c_consulta_pessoa_w.C_22;
			record_w.CD_ESTADO_PROVINCI_RES	:= c_consulta_pessoa_w.C_23;
			record_w.CD_MUNICIPIO_RES		:= c_consulta_pessoa_w.C_24;
			record_w.CD_LOCALIDADE_AREA_RES	:= c_consulta_pessoa_w.C_25;
			record_w.NR_TELEFONE_RES		:= c_consulta_pessoa_w.C_26;
			--record_w.NR_SEGURO_SOCIAL		:= c_consulta_pessoa_w.C_41;
			record_w.IE_GRAU_INSTRUCAO_MAE	:= c_consulta_pessoa_w.C_43;
			--record_w.DS_OCUPACAO			:= c_consulta_pessoa_w.C_44;
			record_w.NR_DDI_TELEFONE_RES		:= c_consulta_pessoa_w.NR_DDI_TELEFONE;
		
		
			if (c_consulta_pessoa_w.nr_seq_pessoa_endereco > 0) then
				begin													
				select	max(b.nr_seq_catalogo)
				into STRICT	record_w.nr_seq_catalogo_res
				from	end_endereco b,
						pessoa_endereco_item a
				where	b.nr_sequencia = a.nr_seq_end_endereco
				and		a.nr_seq_pessoa_endereco = c_consulta_pessoa_w.nr_seq_pessoa_endereco;

				end;						
			end if;	
		
			end;
		end loop;
		close c_consulta_pessoa;		

		open c_consulta_nascimento;
		loop
		fetch c_consulta_nascimento into
			c_consulta_nascimento_w;
		EXIT WHEN NOT FOUND; /* apply on c_consulta_nascimento */	
			begin
			
			if (coalesce(count_nasc_w,0) >= 1) then
		
			select 	CASE WHEN max(n.ie_unico_nasc_vivo)='S' THEN  1  ELSE 2 END
			into STRICT	record_w.ie_cond_ult_nasc
			from 	nascimento n 
			where 	n.nr_atendimento = c_consulta_dados_w.nr_atendimento 
			and 	n.dt_nascimento < c_consulta_dados_w.dt_nascimento 
			order by n.dt_nascimento desc;
			
			select 	CASE WHEN max(n.ie_unico_nasc_vivo)='S' THEN  '1'  ELSE '2' END
			into STRICT	record_w.IE_VIVE_FILHO_ANT
			from 	nascimento n 							
			where 	n.nr_atendimento = c_consulta_dados_w.nr_atendimento 
			and 	n.dt_nascimento < c_consulta_dados_w.dt_nascimento 
			order by n.dt_nascimento desc;
		
			else
				record_w.IE_COND_ULT_NASC 	:= coalesce(c_consulta_nascimento_w.ie_cond_ult_nasc,'9');
				if (c_consulta_nascimento_w.ie_cond_ult_nasc in ('2','3')) then
					record_w.IE_VIVE_FILHO_ANT 	:= '0';
				else
					if (c_consulta_nascimento_w.ie_ult_filho_vivo = 'S') then
						record_w.IE_VIVE_FILHO_ANT 	:= '1';
					elsif (c_consulta_nascimento_w.ie_ult_filho_vivo = 'N') then
						record_w.IE_VIVE_FILHO_ANT 	:= '2';
					else
						record_w.IE_VIVE_FILHO_ANT  := c_consulta_nascimento_w.ie_ult_filho_vivo;
					end if;
				end if;
			end IF;
				
				-- record_w.ie_parto_forceps := '0';
				if (c_consulta_nascimento_w.ie_parto_normal = 'N') then
				--	record_w.ie_parto_forceps := c_consulta_nascimento_	w.forceps;
					record_w.ds_espec_procedimento	:= c_consulta_nascimento_w.especifique;
				end if;
				
				if (c_consulta_nascimento_w.ie_parto_distocico = 'S') then
					if (c_consulta_nascimento_w.ie_parto_forceps = 'S') then
						record_w.ie_parto_forceps := 1;
					elsif (c_consulta_nascimento_w.ie_parto_forceps = 'N') then
						record_w.ie_parto_forceps := 2;
					elsif (coalesce(c_consulta_nascimento_w.ie_parto_forceps::text, '') = '') then
						record_w.ie_parto_forceps := 8;
					elsif (c_consulta_nascimento_w.ie_parto_forceps = 'I') then
						record_w.ie_parto_forceps := 9;
					end	if;	
				else
					record_w.ie_parto_forceps := 0;
				end if;
				-- if (c_consulta_nascimento_w.ie_malformacao_1 = 'S') then

					
					-- if (c_consulta_nascimento_w.ie_malformacao_2 = 'S') then

						-- record_w.CD_DOENCA_ACEL2_RN	:= c_consulta_nascimento_w.CVE_CIE2;

					-- else

						-- record_w.CD_DOENCA_ACEL2_RN		:= '0000';

					-- end if;					

				-- else 

					-- record_w.CD_DOENCA_ACEL2_RN	:= '7777';

				-- end if;

				
			--	if (c_consulta_nascimento_w.ie_parto_normal = 'S') then

			--		record_w.cd_proc_utilizado_nasc := '1';

			--	elsif (c_consulta_nascimento_w.ie_parto_cesaria = 'S') then

			--		record_w.cd_proc_utilizado_nasc := '2';

			--	elsif (c_consulta_nascimento_w.ie_parto_forceps = 'S') then

			--		record_w.cd_proc_utilizado_nasc := '3';

			--	else

			--		record_w.cd_proc_utilizado_nasc := '4';

			--	end if;
				if (c_consulta_nascimento_w.ie_parto_cesaria = 'S') then
					record_w.cd_proc_utilizado_nasc := 2;
				elsif (c_consulta_nascimento_w.ie_parto_normal = 'S') then
					record_w.cd_proc_utilizado_nasc := 1;
				elsif (c_consulta_nascimento_w.ie_parto_distocico = 'S') then
					record_w.cd_proc_utilizado_nasc := 4;
				elsif (c_consulta_nascimento_w.ie_outro_tipo_parto = 'S') then
					record_w.cd_proc_utilizado_nasc := 8;
				else
					record_w.cd_proc_utilizado_nasc := 9;
				end	if;
				
				record_w.NR_FOLIO	 			:= c_consulta_nascimento_w.FOLIO;
				record_w.IE_TIPO_FORMATO	 	:= c_consulta_nascimento_w.TIPO_FORMATO;
				record_w.QT_GESTACOES			:= c_consulta_nascimento_w.C_27;
				record_w.QT_NATIMORTOS			:= c_consulta_nascimento_w.C_28;
				record_w.DT_NASC_FILHO_ANT		:= c_consulta_nascimento_w.C_33;
				record_w.NR_ORDEM_NASC			:= c_consulta_nascimento_w.C_34;
				record_w.NR_SEQ_NASCIMENTO		:= c_consulta_nascimento_w.NR_SEQ_NASCIMENTO;
				record_w.IE_PRE_NATAL			:= c_consulta_nascimento_w.C_35;
				record_w.IE_TRIM_PRIM_PRE_NATAL	:= c_consulta_nascimento_w.C_36;
				record_w.QT_CONSULTAS_OTORG		:= c_consulta_nascimento_w.C_37;
				
				record_w.IE_MAE_SOBREVIVE		:= c_consulta_nascimento_w.ie_sobreviveu_parto;
			/*	if	(c_consulta_nascimento_w.C_39 <> '999999999') and 
					(c_consulta_nascimento_w.C_40 = null) then
					record_w.IE_MAE_SOBREVIVE	:= c_consulta_nascimento_w.C_38;
				end if;	*/
			
				
				record_w.NR_DECLARACAO_OBITO	:= c_consulta_nascimento_w.C_39;
				record_w.CD_DER_NASCIMENTO_1	:= c_consulta_nascimento_w.C_40;
				record_w.NR_SEGURO_SOCIAL		:= substr(c_consulta_nascimento_w.C_41,1,20);
				record_w.CD_DER_NASCIMENTO_2	:= c_consulta_nascimento_w.C_42;	
				record_w.DT_NASCIMENTO			:= c_consulta_nascimento_w.DT_NASCIMENTO;
				record_w.DT_NASCIMENTO_NASC		:= c_consulta_nascimento_w.FECH_NACH;
				record_w.HR_NASCIMENTO_NASC		:= c_consulta_nascimento_w.HORA_NACH;
				record_w.IE_SEXO_NASC			:= c_consulta_nascimento_w.SEXOH;
				record_w.QT_SEM_IG_TOTAL		:= c_consulta_nascimento_w.GESTACH;
				record_w.QT_ALTURA_NASC			:= c_consulta_nascimento_w.TALLAH;
				record_w.QT_PESO_SALA_PARTO		:= c_consulta_nascimento_w.PESOH;
				record_w.QT_QUALIF_NASCIDO_VIVO	:= c_consulta_nascimento_w.APGARH;
				record_w.IE_VACINA_BCG			:= c_consulta_nascimento_w.BCG;
				record_w.IE_VACINA_HEPB			:= c_consulta_nascimento_w.HEP_B;
				record_w.IE_VITAMINA_A			:= c_consulta_nascimento_w.VIT_A;
				record_w.IE_VITAMINA_K			:= c_consulta_nascimento_w.VIT_K;
				record_w.IE_TAMIS_METABOLICO	:= c_consulta_nascimento_w.TAM_MET;
				record_w.IE_TAMIS_AUDITIVO		:= c_consulta_nascimento_w.TAM_AUD;
				record_w.IE_PRODUTO				:= c_consulta_nascimento_w.PRODUCTO;
				record_w.CD_ATEND_PARTO			:= c_consulta_nascimento_w.ATENDIO;
				record_w.IE_OTRO_ATEND_PARTO	:= c_consulta_nascimento_w.ATEN_OTRO;
				record_w.CD_CERT_PARTO			:= c_consulta_nascimento_w.CERT_POR;
				record_w.CD_OUTRO_CERT_PARTO 	:= c_consulta_nascimento_w.OTROMEDICO;
				record_w.CD_PROF_MEDICO 		:= c_consulta_nascimento_w.CED_MEDC;
				record_w.CD_LUG_CERT_NASC		:= c_consulta_nascimento_w.IDCAPTURA;
				
				open c_consulta_estabelecimento;
				loop
				fetch c_consulta_estabelecimento into
					c_consulta_estabelecimento_w;
				EXIT WHEN NOT FOUND; /* apply on c_consulta_estabelecimento */	
					begin
					
					record_w.CD_ESTADO_FED_CAPT	 	:= c_consulta_estabelecimento_w.CEDOCVE;
					record_w.IE_LOCAL_NASCIMENTO	:= c_consulta_estabelecimento_w.INST_NAC;
					record_w.DS_ESTAB_SAUDE			:= c_consulta_estabelecimento_w.UNIMED;
					record_w.CD_CLUES				:= c_consulta_estabelecimento_w.CLUES;
					record_w.CD_TIPO_LOGRAD_NASC	:= c_consulta_estabelecimento_w.TIPOVIAL_NAC;
					record_w.DS_RUA_VIALIDADE_NASC	:= c_consulta_estabelecimento_w.CALLE_NAC;
					record_w.NR_NUMERO_EXTERNO_NASC	:= c_consulta_estabelecimento_w.NUMEXT_NAC;
					record_w.NR_NUMERO_INTERNO_NASC	:= c_consulta_estabelecimento_w.NUMINT_NAC;
					record_w.CD_TIPO_BAIRRO_NASC	:= c_consulta_estabelecimento_w.TIPOASEN_NAC;
					record_w.DS_TIPO_BAIRRO_NASC	:= c_consulta_estabelecimento_w.NOMASEN_NAC;
					record_w.CD_CODIGO_POSTAL_NASC	:= c_consulta_estabelecimento_w.CODPOS_NAC;
					record_w.CD_ESTADO_PROVINCI_NASC := c_consulta_estabelecimento_w.ENT_NAC;
					record_w.CD_MUNICIPIO_NASC		:= c_consulta_estabelecimento_w.MPO_NAC;
					record_w.CD_LOCALIDADE_AREA_NASC := c_consulta_estabelecimento_w.LOC_NAC;
					record_w.DS_ESTAB_SAUDE_CERT	:= c_consulta_estabelecimento_w.UNIMED_33_1;
					record_w.CD_CLUES_UNID_MED 		:= c_consulta_estabelecimento_w.CLUES_33_2;
					record_w.CD_TIPO_LOGRAD_CERT 	:= c_consulta_estabelecimento_w.TIPOVIAL_CERT;
					record_w.DS_RUA_VIALIDADE_CERT	:= c_consulta_estabelecimento_w.CALLE_CERT;
					record_w.NR_NUMERO_EXTERNO_CERT := c_consulta_estabelecimento_w.NUMEXT_CERT;
					record_w.NR_NUMERO_INTERNO_CERT := c_consulta_estabelecimento_w.NUMINT_CERT;
					record_w.CD_TIPO_BAIRRO_CERT	:= c_consulta_estabelecimento_w.TIPOASEN_CERT;
					record_w.DS_TIPO_BAIRRO_CERT 	:= c_consulta_estabelecimento_w.NOMASEN_CERT;
					record_w.CD_CODIGO_POSTAL_CERT 	:= c_consulta_estabelecimento_w.CODPOS_CERT;
					record_w.CD_ESTADO_PROVINCI_CERT := c_consulta_estabelecimento_w.ENT_CERT;
					record_w.CD_MUNICIPIO_CERT 		:= c_consulta_estabelecimento_w.MPO_CERT;
					record_w.CD_LOCALIDADE_AREA_CERT := c_consulta_estabelecimento_w.LOC_CERT;
					record_w.NR_TELEFONE_CERT		:= c_consulta_estabelecimento_w.TEL_CERT;
					record_w.NR_DDI_TELEFONE_CERT		:= c_consulta_estabelecimento_w.NR_DDI_TELEFONE;
					record_w.CD_MUNICIPIO_CAPT 		:= c_consulta_estabelecimento_w.MPO_CERT; /*Verificar??????????????????????????????????????????*/
					
					select	max(nr_seq_catalogo)
					into STRICT	record_w.nr_seq_catalogo_capt
					from	config_nom
					where	cd_estabelecimento = c_consulta_estabelecimento_w.cd_estabelecimento;

					if (c_consulta_estabelecimento_w.nr_seq_pessoa_endereco > 0) then
							begin													
							select	max(b.nr_seq_catalogo)
							into STRICT	record_w.nr_seq_catalogo_cert
							from	end_endereco b,
									pessoa_endereco_item a
							where	b.nr_sequencia = a.nr_seq_end_endereco
							and		a.nr_seq_pessoa_endereco = c_consulta_estabelecimento_w.nr_seq_pessoa_endereco;	
							
							record_w.nr_seq_catalogo_nasc := record_w.nr_seq_catalogo_cert;
							
							end;						
						end if;		

					end;
				end loop;
				close c_consulta_estabelecimento;	
				
			end;
		end loop;
		close c_consulta_nascimento;	
		
		open c_consulta_pediatra;
		loop
		fetch c_consulta_pediatra into
			c_consulta_pediatra_w;
		EXIT WHEN NOT FOUND; /* apply on c_consulta_pediatra */	
			begin
			
			SELECT nextval('person_name_seq')
			INTO STRICT record_w.NR_SEQ_PERSON_NAME_CERT
			;
	
			INSERT INTO person_name(nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,ds_type,ds_given_name,ds_family_name,ds_component_name_1,ds_component_name_2,ds_component_name_3)
			SELECT record_w.NR_SEQ_PERSON_NAME_CERT,clock_timestamp(),wheb_usuario_pck.get_nm_usuario,clock_timestamp(),wheb_usuario_pck.get_nm_usuario,ds_type,ds_given_name,ds_family_name,coalesce(ds_component_name_1, 'NO ESPECIFICADO'),ds_component_name_2,ds_component_name_3
			FROM person_name
			WHERE nr_sequencia = c_consulta_pediatra_w.nr_seq_person_name;
				
			end;
		end loop;
		close c_consulta_pediatra;
		
		open c_doenca_acel;
		loop
		fetch c_doenca_acel into
			c_doenca_acel_w;
			
		EXIT WHEN NOT FOUND; /* apply on c_doenca_acel */	
			begin
			if (c_doenca_acel_w.cid_doenca_superior IS NOT NULL AND c_doenca_acel_w.cid_doenca_superior::text <> '') then
				record_w.DS_DOENCA_ACEL_RN 	:= c_doenca_acel_w.cid_doenca_superior;
				record_w.CD_DOENCA_ACEL_RN	:= c_doenca_acel_w.cd_doenca_superior;
			elsif (c_doenca_acel_w.ds_doenca_sup IS NOT NULL AND c_doenca_acel_w.ds_doenca_sup::text <> '') then
				record_w.DS_DOENCA_ACEL_RN 	:= c_doenca_acel_w.ds_doenca_sup;
				--record_w.CD_DOENCA_ACEL_RN	:= '0000';
			else
				record_w.DS_DOENCA_ACEL_RN 	:= 'NINGUNA APARENTE';
				record_w.CD_DOENCA_ACEL_RN	:= '0000';
			end if;
			
			if (c_doenca_acel_w.cid_doenca IS NOT NULL AND c_doenca_acel_w.cid_doenca::text <> '') then
				record_w.CD_DOENCA_ACEL2_RN	:= c_doenca_acel_w.cd_doenca;
				record_w.DS_DOENCA_ACEL2_RN := c_doenca_acel_w.cid_doenca;
			elsif (c_doenca_acel_w.ds_doenca IS NOT NULL AND c_doenca_acel_w.ds_doenca::text <> '') then
				record_w.DS_DOENCA_ACEL2_RN := c_doenca_acel_w.ds_doenca;
				--record_w.CD_DOENCA_ACEL2_RN	:= '9999';
			else
				record_w.DS_DOENCA_ACEL2_RN := 'NO APLICA';
				record_w.CD_DOENCA_ACEL2_RN	:= '7777';
			end if;
			
			end;
		end loop;
		close c_doenca_acel;
		
		if (coalesce(record_w.DS_DOENCA_ACEL_RN::text, '') = '') then
			record_w.DS_DOENCA_ACEL_RN 	:= 'NINGUNA APARENTE';
				record_w.CD_DOENCA_ACEL_RN	:= '0000';
				record_w.DS_DOENCA_ACEL2_RN := 'NO APLICA';
				record_w.CD_DOENCA_ACEL2_RN	:= '7777';
		end if;
		
		for c_lista_problema_pac_w in c_lista_problema_pac loop
		begin    
			count_linha_w := c_lista_problema_pac%ROWCOUNT;
				
			if (count_linha_w = 1) then
				record_w.DS_PROBLEMA_RN 	:= c_lista_problema_pac_w.ds_problema;
			end if;
			
			if (count_linha_w = 2) then
				record_w.DS_PROBLEMA2_RN 	:= c_lista_problema_pac_w.ds_problema;
			end if;			
			end;
		end loop;
		

		select 	nextval('nom_nascimento_seq')
		into STRICT	record_w.nr_sequencia
		;

		insert into nom_nascimento values (record_w.*);
		record_w := null;
	
		end;
	end loop;
	close c_consulta_dados;
	end;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_guia_nascimento_noms ( dt_inicial_p timestamp, dt_final_p timestamp, ie_sobreescrever_p text) FROM PUBLIC;

