-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE plt_obter_jejum ( cd_estabelecimento_p bigint, cd_setor_usuario_p bigint, cd_perfil_p bigint, nm_usuario_p text, nr_atendimento_p bigint, dt_inicial_horarios_p timestamp, dt_final_horarios_p timestamp, dt_validade_limite_p timestamp, ie_prescr_usuario_p text, nr_seq_regra_p bigint) AS $body$
DECLARE


nr_seq_wadep_w		bigint;
nr_prescricao_w		bigint;
cd_jejum_w		varchar(255);
ds_jejum_w		varchar(255);
ds_vigencia_w		varchar(255);
nr_seq_jejum_w		bigint;
ie_suspenso_w		varchar(1);
ie_lib_pend_rep_w	varchar(1);
ie_liberado_w		varchar(1);
ie_copiar_w		varchar(1);
ds_cor_titulo_w	varchar(20);

c01 CURSOR FOR
SELECT	to_char(c.dt_inicio,'dd/mm/yyyy hh24:mi:ss') || '-' || to_char(c.dt_fim,'dd/mm/yyyy hh24:mi:ss') cd_jejum,
	x.ds_tipo ds_jejum,
	obter_desc_expressao(301700) || to_char(c.dt_inicio,'dd/mm/yyyy hh24:mi:ss') || ' Ã  ' || to_char(c.dt_fim,'dd/mm/yyyy hh24:mi:ss') ds_vigencia,
	c.nr_sequencia,
	CASE WHEN c.ie_suspenso='N' THEN ''  ELSE c.ie_suspenso END ,
	substr(plt_obter_lib_pend_prescr(a.dt_liberacao_medico,a.dt_liberacao,a.dt_liberacao_farmacia),1,1) ie_lib_pend_rep,
	CASE WHEN coalesce(coalesce(a.dt_liberacao,a.dt_liberacao_medico),a.dt_liberacao_farmacia) IS NULL THEN 'N'  ELSE 'S' END  ie_liberado
from	rep_tipo_jejum x,
	rep_jejum c,
	prescr_medica a
where	x.nr_sequencia = c.nr_seq_tipo
and	c.nr_prescricao = a.nr_prescricao
and	a.nr_atendimento = nr_atendimento_p
and	coalesce(a.ie_adep,'S') = 'S'
and	a.dt_validade_prescr > dt_validade_limite_p
and	c.dt_inicio between dt_inicial_horarios_p and dt_final_horarios_p
and	((a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '' AND ie_prescr_usuario_p = 'N') or (a.nm_usuario_original = nm_usuario_p))
group by
	c.dt_inicio,
	c.dt_fim,
	x.ds_tipo,
	c.nr_sequencia,
	c.ie_suspenso,
	a.dt_liberacao_medico,
	a.dt_liberacao,
	a.dt_liberacao_farmacia;


BEGIN

ie_copiar_w 	:= plt_obter_se_item_marcado('J', nr_seq_regra_p);
ds_cor_titulo_w	:= plt_obter_se_item_marcado('J', nr_seq_regra_p);

open c01;
loop
fetch c01 into	cd_jejum_w,
		ds_jejum_w,
		ds_vigencia_w,
		nr_seq_jejum_w,
		ie_suspenso_w,
		ie_lib_pend_rep_w,
		ie_liberado_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	select	nextval('w_rep_t_seq')
	into STRICT	nr_seq_wadep_w
	;

	insert into w_rep_t(
		nr_sequencia,
		nm_usuario,
		ie_tipo_item,
		nr_seq_item,
		cd_item,
		ds_item,
		ds_prescricao,
		nr_agrupamento,
		nr_seq_proc_interno,
		ie_acm_sn,
		ie_status_item,
		ie_pendente_liberacao,
		ie_liberado,
		ie_copiar,
		ds_cor_titulo)
	values (
		nr_seq_wadep_w,
		nm_usuario_p,
		'J',
		nr_seq_jejum_w,
		cd_jejum_w,
		ds_jejum_w,
		ds_vigencia_w,
		0,
		0,
		'N',
		ie_suspenso_w,
		ie_lib_pend_rep_w,
		ie_liberado_w,
		ie_copiar_w,
		ds_cor_titulo_w);
	end;
end loop;
close c01;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE plt_obter_jejum ( cd_estabelecimento_p bigint, cd_setor_usuario_p bigint, cd_perfil_p bigint, nm_usuario_p text, nr_atendimento_p bigint, dt_inicial_horarios_p timestamp, dt_final_horarios_p timestamp, dt_validade_limite_p timestamp, ie_prescr_usuario_p text, nr_seq_regra_p bigint) FROM PUBLIC;

