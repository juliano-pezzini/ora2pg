-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_ficha_tecnica ( nr_ficha_origem_p bigint, nr_ficha_destino_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type := wheb_usuario_pck.get_cd_estabelecimento;

BEGIN

if (nr_ficha_origem_p <> nr_ficha_destino_p)then
	delete from ficha_tecnica_componente
	where	nr_ficha_tecnica = nr_ficha_destino_p;


	insert into ficha_tecnica_componente(
		nr_ficha_tecnica,
		nr_seq_componente,
		dt_alteracao,
		cd_estabelecimento,
		nm_usuario,
		dt_atualizacao,
		ie_situacao,
		ie_tipo_componente,
		cd_material,
		cd_procedimento,
		ie_origem_proced,
		cd_centro_controle,
		qt_fixa,
		qt_variavel,
		pr_quebra_variavel,
		nr_seq_exame,
		nr_seq_proc_interno,
		dt_atualizacao_nrec,
		nm_usuario_nrec)
	SELECT	nr_ficha_destino_p,
		nr_seq_componente,
		dt_alteracao,
		cd_estabelecimento_w,
		nm_usuario_p,
		clock_timestamp(),
		ie_situacao,
		ie_tipo_componente,
		cd_material,
		cd_procedimento,
		ie_origem_proced,
		cd_centro_controle,
		qt_fixa,
		qt_variavel,
		pr_quebra_variavel,
		nr_seq_exame,
		nr_seq_proc_interno,
		clock_timestamp(),
		nm_usuario_p
	from	ficha_tecnica_componente
	where	nr_ficha_tecnica = nr_ficha_origem_p
	and (coalesce(cd_centro_controle::text, '') = '' or cd_estabelecimento = cd_estabelecimento_w);

end if;

/*Adicionada a restrição do centro de controle pois
não poderá copiar de outro estabelecimento, só quando for o estabelecimento logado.*/
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_ficha_tecnica ( nr_ficha_origem_p bigint, nr_ficha_destino_p bigint, nm_usuario_p text) FROM PUBLIC;

