-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_recalc_horarios_kit ( nr_atendimento_p prescr_medica.nr_atendimento%type, nr_prescricao_p prescr_material.nr_prescricao%type, nr_seq_mat_med_p prescr_material.nr_sequencia%type, nr_seq_recomendacao_p prescr_material.nr_seq_recomendacao%type, ds_horarios_p cpoe_material.ds_horarios%type, nr_ocorrencia_p cpoe_material.nr_ocorrencia%type, ie_acm_p intervalo_prescricao.ie_acm%type, ie_sn_p intervalo_prescricao.ie_se_necessario%type, cd_intervalo_p intervalo_prescricao.cd_intervalo%type, ds_horarios_out_p INOUT prescr_material.ds_horarios%type, nr_ocorrencia_out_p INOUT prescr_material.nr_ocorrencia%type ) AS $body$
DECLARE


	nr_seq_cpoe_w		cpoe_material.nr_sequencia%type;
	dt_inicio_w			cpoe_material.dt_inicio%type;
	dt_fim_medic_w		cpoe_material.dt_fim%type;
	ds_horarios_out_w	cpoe_material.ds_horarios%type;
	nr_ocorrencia_out_w	cpoe_material.nr_ocorrencia%type;


BEGIN
	if ((nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_mat_med_p IS NOT NULL AND nr_seq_mat_med_p::text <> '') or (nr_seq_recomendacao_p IS NOT NULL AND nr_seq_recomendacao_p::text <> '') and (ds_horarios_p IS NOT NULL AND ds_horarios_p::text <> '')) then

		if (nr_seq_mat_med_p IS NOT NULL AND nr_seq_mat_med_p::text <> '') then
			/* Kit do medicamento e dieta */

			select max(nr_seq_cpoe),
				   max(dt_inicio_medic),
				   max(dt_fim_medic)
			  into STRICT nr_seq_cpoe_w,
				   dt_inicio_w,
				   dt_fim_medic_w
			  from (
					SELECT a.nr_seq_mat_cpoe nr_seq_cpoe,
						   a.dt_inicio_medic,
						   CASE WHEN coalesce(b.dt_lib_suspensao::text, '') = '' THEN  coalesce(b.dt_fim_cih, b.dt_fim)  ELSE coalesce(b.dt_suspensao, b.dt_fim) END  dt_fim_medic
					  from prescr_material a,
						   cpoe_material b
					 where a.nr_seq_mat_cpoe = b.nr_sequencia
					   and a.nr_prescricao = nr_prescricao_p
					   and a.nr_sequencia = nr_seq_mat_med_p
					   and a.ie_agrupador in (1,4)
					
union all

					SELECT a.nr_seq_dieta_cpoe nr_seq_cpoe,
						   a.dt_inicio_medic,
						   CASE WHEN coalesce(b.dt_lib_suspensao::text, '') = '' THEN  b.dt_fim  ELSE coalesce(b.dt_suspensao, b.dt_fim) END  dt_fim_medic
					  from prescr_material a,
						 cpoe_dieta b
					 where a.nr_seq_dieta_cpoe = b.nr_sequencia
					   and a.nr_prescricao = nr_prescricao_p
					   and a.nr_sequencia = nr_seq_mat_med_p
					   and a.ie_agrupador in (8,12,16)
					) alias16;
		elsif (nr_seq_recomendacao_p IS NOT NULL AND nr_seq_recomendacao_p::text <> '') then
			/* Kit da recomendacao */

			select max(a.nr_seq_rec_cpoe),
				   max(a.dt_inicio),
				   max(CASE WHEN coalesce(b.dt_lib_suspensao::text, '') = '' THEN  b.dt_fim  ELSE coalesce(b.dt_suspensao, b.dt_fim) END ) dt_fim_rec
			  into STRICT nr_seq_cpoe_w,
				   dt_inicio_w,
				   dt_fim_medic_w
			  from prescr_recomendacao a,
				   cpoe_recomendacao b
			 where a.nr_seq_rec_cpoe = b.nr_sequencia
			   and a.nr_prescricao = nr_prescricao_p
			   and a.nr_sequencia = nr_seq_recomendacao_p;
		end if;

		if (dt_fim_medic_w IS NOT NULL AND dt_fim_medic_w::text <> '') then
			ds_horarios_out_w := cpoe_recalcula_horarios_copia(ds_horarios_p, dt_inicio_w, dt_fim_medic_w, ie_acm_p, ie_sn_p, cd_intervalo_p);
			nr_ocorrencia_out_w := obter_ocorrencias_horarios_rep(ds_horarios_out_w);
			
			if (nr_ocorrencia_out_w = 0 and (ie_sn_p = 'S' or ie_acm_p = 'S')) then
				nr_ocorrencia_out_w := nr_ocorrencia_p;
			end if;
		end if;
	end if;

	ds_horarios_out_p := coalesce(ds_horarios_out_w, ds_horarios_p);
	nr_ocorrencia_out_p := coalesce(nr_ocorrencia_out_w, nr_ocorrencia_p);

exception when others then
	CALL gravar_log_cpoe(substr('CPOE_RECALC_HORARIOS_KIT CPOE_RECALCULA_HORARIOS_COPIA EXCEPTION: ' || to_char(sqlerrm)
		|| '-nr_prescricao_p: ' || nr_prescricao_p
		|| '-nr_seq_mat_med_p: ' || nr_seq_mat_med_p
		|| '-ds_horarios_p: ' || ds_horarios_p
		|| '-ie_acm_p: ' || ie_acm_p
		|| '-ie_sn_p: ' || ie_sn_p
		|| '-cd_intervalo_p: ' || cd_intervalo_p, 1, 2000),
		nr_atendimento_p);
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_recalc_horarios_kit ( nr_atendimento_p prescr_medica.nr_atendimento%type, nr_prescricao_p prescr_material.nr_prescricao%type, nr_seq_mat_med_p prescr_material.nr_sequencia%type, nr_seq_recomendacao_p prescr_material.nr_seq_recomendacao%type, ds_horarios_p cpoe_material.ds_horarios%type, nr_ocorrencia_p cpoe_material.nr_ocorrencia%type, ie_acm_p intervalo_prescricao.ie_acm%type, ie_sn_p intervalo_prescricao.ie_se_necessario%type, cd_intervalo_p intervalo_prescricao.cd_intervalo%type, ds_horarios_out_p INOUT prescr_material.ds_horarios%type, nr_ocorrencia_out_p INOUT prescr_material.nr_ocorrencia%type ) FROM PUBLIC;

