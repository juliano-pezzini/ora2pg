-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_lista_espera (ie_urgente_p text, cd_medico_p text, cd_pessoa_fisca_p text, cd_convenio_p text, cd_categoria_p text, cd_plano_p text, nr_seq_proc_interno_p bigint default null, cd_procedimento_p text default null, ie_origem_proced_p text default null, cd_setor_atendimento_p text DEFAULT NULL, dt_desejada_p timestamp DEFAULT NULL, dt_validade_p timestamp default null, nr_seq_cpoe_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL) AS $body$
DECLARE


nr_seq_agenda_int_w		agenda_integrada.nr_sequencia%type;
nr_seq_ageint_item_w	agenda_integrada_item.nr_sequencia%type;		
nr_seq_lista_espera_w	agenda_lista_espera.nr_sequencia%type;	
nr_seq_lista_esp_old_w	agenda_lista_espera.nr_sequencia%type;	
ds_justificativa_w		cpoe_procedimento.ds_justificativa%type;
nr_atendimento_w 		cpoe_procedimento.nr_atendimento%type;
cd_estabelecimento_w    estabelecimento.cd_estabelecimento%type;
qt_registros_w      	bigint := 0;
qt_agendas_lib_w		bigint := 0;


BEGIN

cd_estabelecimento_w := coalesce(wheb_usuario_pck.get_cd_estabelecimento,1);

select	count(1)
into STRICT	qt_registros_w
from	agenda_regra
where	coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
and		nr_seq_proc_interno = nr_seq_proc_interno_p
and		ie_situacao = 'A';

select	max(a.nr_sequencia),
	max(b.nr_sequencia)
into STRICT	nr_seq_agenda_int_w,
	nr_seq_ageint_item_w
from	agenda_integrada_item b,
		agenda_integrada a
where	b.nr_seq_agenda_int = a.nr_sequencia
and	a.cd_pessoa_fisica = cd_pessoa_fisca_p
and	a.dt_inicio_agendamento = dt_desejada_p
and	a.nm_usuario = nm_usuario_p
and	b.nr_seq_proc_interno = nr_seq_proc_interno_p;

select	count(1)
into STRICT	qt_agendas_lib_w
from	ageint_lib_usuario a
where	a.nr_seq_ageint = nr_seq_agenda_int_w
and	a.nr_seq_ageint_item = nr_seq_ageint_item_w;

select	max(nr_seq_lista_espera),
		max(ds_justificativa),
		max(nr_atendimento)
into STRICT	nr_seq_lista_esp_old_w,
		ds_justificativa_w,
		nr_atendimento_w
from	cpoe_procedimento
where	nr_sequencia = nr_seq_cpoe_p;

if (nr_seq_agenda_int_w IS NOT NULL AND nr_seq_agenda_int_w::text <> '') then
	delete	from ageint_horarios_usuario 
	where nr_seq_ageint_lib in (SELECT	nr_sequencia 
				from	ageint_lib_usuario 
				where	nr_seq_ageint = nr_seq_agenda_int_w);

	delete	from ageint_lib_usuario
	where	nr_seq_ageint = nr_seq_agenda_int_w;
	
	delete from ageint_marcacao_usuario
	where	nr_seq_ageint = nr_seq_agenda_int_w;

	delete	from agenda_integrada_item
	where	nr_seq_agenda_int = nr_seq_agenda_int_w;

	delete  from ageint_arq_anexo_email
	where	nr_seq_agenda_int = nr_seq_agenda_int_w;
	
	delete	from agenda_integrada
	where	nr_sequencia = nr_seq_agenda_int_w;
end if;

if (qt_registros_w > 0 and qt_agendas_lib_w > 0) then
	if ((nr_seq_proc_interno_p IS NOT NULL AND nr_seq_proc_interno_p::text <> '')
		or (cd_procedimento_p IS NOT NULL AND cd_procedimento_p::text <> '')
		or (ie_origem_proced_p IS NOT NULL AND ie_origem_proced_p::text <> '')) then
		
		select	nextval('agenda_lista_espera_seq')
		into STRICT	nr_seq_lista_espera_w
		;

		insert into agenda_lista_espera(
			nr_sequencia,
			ie_status_espera,
			ie_urgente,
			cd_medico,
			cd_pessoa_fisica,
			cd_convenio,
			cd_categoria,
			cd_plano,
			nr_seq_proc_interno,
			cd_procedimento,
			ie_origem_proced,
			cd_setor_atendimento,
			dt_desejada,
			dt_agendamento,
			dt_periodo_inicial, 
			dt_periodo_final, 
			nm_usuario_agenda,
			nm_usuario,
			dt_atualizacao,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			ds_observacao,
			nr_atendimento)
		values (
			nr_seq_lista_espera_w,
			'A',
			ie_urgente_p,
			cd_medico_p,
			cd_pessoa_fisca_p,
			cd_convenio_p,
			cd_categoria_p,
			cd_plano_p,
			nr_seq_proc_interno_p,
			cd_procedimento_p,
			ie_origem_proced_p,
			cd_setor_atendimento_p,
			dt_desejada_p,
			clock_timestamp(),
			clock_timestamp(),
			dt_validade_p,
			nm_usuario_p,
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			ds_justificativa_w,
			nr_atendimento_w);

		update	cpoe_procedimento
		set		nr_seq_lista_espera = nr_seq_lista_espera_w
		where	nr_sequencia 		= nr_seq_cpoe_p;
		
		if (nr_seq_lista_esp_old_w IS NOT NULL AND nr_seq_lista_esp_old_w::text <> '') then
			delete from agenda_lista_espera where nr_sequencia = nr_seq_lista_esp_old_w;
		end if;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_lista_espera (ie_urgente_p text, cd_medico_p text, cd_pessoa_fisca_p text, cd_convenio_p text, cd_categoria_p text, cd_plano_p text, nr_seq_proc_interno_p bigint default null, cd_procedimento_p text default null, ie_origem_proced_p text default null, cd_setor_atendimento_p text DEFAULT NULL, dt_desejada_p timestamp DEFAULT NULL, dt_validade_p timestamp default null, nr_seq_cpoe_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL) FROM PUBLIC;

