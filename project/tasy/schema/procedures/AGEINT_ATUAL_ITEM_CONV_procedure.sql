-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ageint_atual_item_conv ( nr_seq_agenda_item_p bigint, nr_seq_ageint_item_adic_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
nr_seq_ageint_w     bigint;
cd_convenio_w      integer;
cd_categoria_w     varchar(10);
cd_estabelecimento_w  smallint;
dt_inicio_agendamento_w timestamp;
cd_plano_w       varchar(10);
cd_usuario_convenio_w  varchar(30);
cd_pessoa_fisica_w   varchar(10);
ie_tipo_atendimento_w  smallint;
nr_seq_ageint_item_w  bigint;
	
qt_exames_assoc_w		bigint;
nr_seq_proc_interno_w	bigint;
qt_idade_pac_w			smallint;
nr_seq_ag_integrada_w	bigint;
nr_seq_grupo_selec_w	bigint;
ds_erro_w				varchar(255);


BEGIN 
 
update agenda_integrada_item 
set   dt_atualizacao = clock_timestamp(), 
    nm_usuario   = nm_usuario_p 
where  nr_sequencia  = nr_seq_agenda_item_p;
 
select a.nr_sequencia, 
    a.cd_convenio, 
    a.cd_categoria, 
    a.cd_estabelecimento, 
    a.dt_inicio_agendamento, 
    a.cd_plano, 
    a.cd_usuario_convenio, 
    a.cd_pessoa_fisica, 
    a.ie_tipo_atendimento 
into STRICT  nr_seq_ageint_w, 
    cd_convenio_w, 
    cd_categoria_w, 
    cd_estabelecimento_w, 
    dt_inicio_agendamento_w, 
    cd_plano_w, 
    cd_usuario_convenio_w, 
    cd_pessoa_fisica_w, 
    ie_tipo_atendimento_w 
from  agenda_integrada a, 
    agenda_integrada_item b 
where  a.nr_sequencia = b.nr_seq_agenda_int 
and   b.nr_sequencia = nr_seq_agenda_item_p;
 
CALL calc_valor_proc_ageint_item( 
            nr_seq_ageint_w,cd_convenio_w,cd_categoria_w,cd_estabelecimento_w,dt_inicio_agendamento_w,cd_plano_w, 
            nm_usuario_p,cd_usuario_convenio_w,cd_pessoa_fisica_w,ie_tipo_Atendimento_w,nr_seq_agenda_item_p,nr_seq_ageint_item_adic_p);
						 
						 
select	max(c.cd_convenio), 
		max(a.qt_idade_pac), 
		max(a.nr_sequencia), 
		max(b.nr_seq_proc_interno), 
		max(b.nr_seq_grupo_selec) 
into STRICT	cd_convenio_w, 
		qt_idade_pac_w, 
		nr_seq_ag_integrada_w, 
		nr_seq_proc_interno_w, 
		nr_seq_grupo_selec_w 
from	agenda_integrada a, 
		agenda_integrada_item b, 
		agenda_integrada_conv_item c 
where	a.nr_sequencia = b.nr_seq_agenda_int 
and		b.nr_sequencia	= c.nr_seq_agenda_item 
and		b.nr_sequencia = nr_seq_agenda_item_p;		
				 
select	coalesce(count(*),0) 
into STRICT	qt_exames_assoc_w 
from	proc_int_proc_prescr 
where	nr_seq_proc_interno	= nr_seq_proc_interno_w 
and 	coalesce(cd_convenio,cd_convenio_w) = cd_convenio_w 
and (coalesce(cd_convenio_excluir::text, '') = '' or cd_convenio_excluir <> cd_convenio_w) 
and		Obter_conv_excluir_proc_assoc(nr_sequencia, cd_convenio_w)	= 'S' 
and		coalesce(ie_somente_agenda_cir,'N') = 'N'		 
and		(((coalesce(qt_idade_pac_w::text, '') = '') or (coalesce(qt_idade_min::text, '') = '' and coalesce(qt_idade_max::text, '') = '')) or 
		((qt_idade_pac_w IS NOT NULL AND qt_idade_pac_w::text <> '') and (qt_idade_pac_w between coalesce(qt_idade_min,qt_idade_pac_w) and 
		coalesce(qt_idade_max,qt_idade_pac_w)))) 
and 	Obter_se_proc_interno_ativo(nr_seq_proc_int_adic) = 'A';		
 
if (qt_exames_assoc_w > 0)then 
	begin 
	CALL ageint_gerar_proc_Assoc(nr_seq_ag_integrada_w, nr_seq_agenda_item_p, nr_seq_proc_interno_w, nm_usuario_p, nr_seq_grupo_selec_w);
	 
	exception 
	when others then 
		ds_erro_w := substr(sqlerrm,1,255);
	end;
end if;						
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageint_atual_item_conv ( nr_seq_agenda_item_p bigint, nr_seq_ageint_item_adic_p bigint, nm_usuario_p text) FROM PUBLIC;

