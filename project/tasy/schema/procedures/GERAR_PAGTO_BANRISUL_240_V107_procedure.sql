-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_pagto_banrisul_240_v107 ( nr_seq_envio_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* PADRAO CNAB 240 VERSAO 107 DE 09/2021 */

subtype date_char is varchar(8);
subtype param_char is varchar(1);
subtype cd_char is varchar(2);
subtype ver_char is varchar(3);

ds_conteudo_w			w_envio_banco.ds_conteudo%type;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
nr_seq_apres_w			w_envio_banco.nr_seq_apres%type;

/* header de arquivo */

cd_agencia_estab_w		agencia_bancaria.cd_agencia_bancaria%type;
cd_cgc_estab_w			estabelecimento.cd_cgc%type;
cd_convenio_banco_w		banco_estabelecimento.cd_convenio_banco%type;
dt_geracao_w			date_char;
hr_geracao_w			date_char;
nm_empresa_w			pessoa_juridica.ds_razao_social%type;
nr_conta_estab_w		banco_estabelecimento.cd_conta%type;
nr_remessa_w			banco_escritural.nr_remessa%type;
ie_digito_estab_w		banco_estabelecimento.ie_digito_conta%type;
ds_banco_w				banco.ds_banco%type;
cd_banco_pagto_w		banco.cd_banco%type;

/* header de lote - DOC */

nr_lote_servico_w		integer;
ie_forma_lanc_w			titulo_pagar_escrit.ie_tipo_pagamento%type;
ie_tipo_pagamento_w		titulo_pagar_escrit.ie_tipo_pagamento%type;
ds_endereco_w			compl_pessoa_fisica.ds_endereco%type;
nr_endereco_w			pessoa_juridica.nr_endereco%type;
ds_complemento_w		pessoa_juridica.ds_complemento%type;
ds_municipio_w			compl_pessoa_fisica.ds_municipio%type;
nr_cep_w				compl_pessoa_fisica.cd_cep%type;
sg_estado_w				compl_pessoa_fisica.sg_estado%type;

c01 CURSOR FOR
SELECT	distinct
	CASE WHEN b.ie_tipo_pagamento='CC' THEN '01' WHEN b.ie_tipo_pagamento='DOC' THEN CASE WHEN cd_banco_pagto_w=b.cd_banco THEN '01'  ELSE '03' END  WHEN b.ie_tipo_pagamento='TED' THEN CASE WHEN cd_banco_pagto_w=b.cd_banco THEN '43'  ELSE '41' END  WHEN b.ie_tipo_pagamento='OP' THEN '30'  ELSE '03' END  ie_forma_lanc,
	b.ie_tipo_pagamento ie_tipo_pagamento
from	titulo_pagar_escrit b,
	banco_escritural a
where	b.ie_tipo_pagamento	in ('DOC','CC','OP','TED')
and	a.nr_sequencia		= b.nr_seq_escrit
and	a.nr_sequencia		= nr_seq_envio_p;

/* detalhe - DOC */

nr_sequencia_w				banco_escritural.nr_sequencia%type;
cd_banco_w					banco.cd_banco%type;
cd_agencia_bancaria_w		agencia_bancaria.cd_agencia_bancaria%type;
nr_conta_w					banco_estabelecimento.cd_conta%type;
dt_remessa_retorno_w		banco_escritural.dt_remessa_retorno%type;
ie_digito_conta_w			titulo_pagar_escrit.ie_digito_conta%type;
qt_favorecido_w				integer;
cd_finalidade_compl_w		cd_char;
cd_finalidade_doc_w			cd_char;
cd_finalidade_ted_w			titulo_pagar_escrit.ie_tipo_servico%type;


c02 CURSOR FOR
SELECT	b.cd_banco cd_banco,
	lpad(substr(coalesce(b.cd_agencia_bancaria,' '),1,4) || substr(coalesce(b.ie_digito_agencia,' '),1,1),6,'0') cd_agencia_bancaria,
	rpad(elimina_caractere_especial(substr(obter_nome_pf_pj(c.cd_pessoa_fisica,c.cd_cgc),1,30)),30,' ') nm_pessoa,
	c.nr_titulo nr_titulo,
	b.vl_escritural vl_escritural,
	b.vl_acrescimo vl_acrescimo,
	b.vl_desconto vl_desconto,
	b.vl_despesa vl_despesa,
	b.nr_conta nr_conta,
	substr(b.ie_digito_conta,1,1) ie_digito_conta,
	b.vl_juros vl_juros,
	b.vl_multa vl_multa,
	c.dt_vencimento_atual dt_vencimento,
	CASE WHEN coalesce(c.cd_pessoa_fisica::text, '') = '' THEN '2'  ELSE '1' END  ie_tipo_inscricao,
  lpad(coalesce(c.cd_cgc,d.nr_cpf),14,'0') nr_inscricao,
	rpad(coalesce(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'R'),1,30),' '),30,' ') ds_endereco_det,
	lpad(coalesce(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'NR'),1,5),'0'),5,'0') nr_endereco_det,
	rpad(coalesce(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'CO'),1,15),' '),15,' ') ds_complemento_det,
	rpad(coalesce(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'CI'),1,20),' '),20,' ') ds_municipio_det,
	lpad(coalesce(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'CEP'),1,8),'0'),8,'0') nr_cep_det,
	rpad(coalesce(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'UF'),1,2),' '),2,' ') sg_estado_det,
	rpad(coalesce(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'B'),1,15),' '),15,' ') ds_bairro_det,
	CASE WHEN b.ie_tipo_pagamento='TED' THEN '018' WHEN b.ie_tipo_pagamento='DOC' THEN '700'  ELSE '010' END  cd_camara,
	CASE WHEN b.ie_tipo_pagamento='TED' THEN '00005' WHEN b.ie_tipo_pagamento='DOC' THEN '00007'  ELSE '00000' END  ie_tipo_pgto
FROM titulo_pagar_escrit b, banco_escritural a, titulo_pagar c
LEFT OUTER JOIN pessoa_fisica d ON (c.cd_pessoa_fisica = d.cd_pessoa_fisica)
WHERE b.nr_titulo		= c.nr_titulo and CASE WHEN b.ie_tipo_pagamento='CC' THEN '01' WHEN b.ie_tipo_pagamento='DOC' THEN CASE WHEN cd_banco_pagto_w=b.cd_banco THEN '01'  ELSE '03' END  WHEN b.ie_tipo_pagamento='TED' THEN CASE WHEN cd_banco_pagto_w=b.cd_banco THEN '43'  ELSE '41' END  WHEN b.ie_tipo_pagamento='OP' THEN '30'  ELSE '03' END  = ie_forma_lanc_w and b.ie_tipo_pagamento	= ie_tipo_pagamento_w and a.nr_sequencia		= b.nr_seq_escrit and (not exists (select	1
	from	darf_titulo_pagar x
	where	x.nr_titulo	= b.nr_titulo) and
	 not exists (select	1
	from	gps_titulo x
	where	x.nr_titulo	= b.nr_titulo)) and a.nr_sequencia		= nr_seq_envio_p;

/* trailer lote - DOC */

vl_sub_total_w		        titulo_pagar_escrit.vl_escritural%type;
vl_total_w		        titulo_pagar_escrit.vl_escritural%type;

/* header de lote - BLQ */

c03 CURSOR FOR
SELECT	distinct
		CASE WHEN(select	count(*)		from	gps_titulo x		where	x.nr_titulo	= b.nr_titulo)=0 THEN 		CASE WHEN(select	count(*)			from	darf_titulo_pagar x			where	x.nr_titulo	= b.nr_titulo)=0 THEN 			CASE WHEN 	b.ie_tipo_pagamento='PC' THEN '11'  ELSE CASE WHEN 	CASE WHEN coalesce(d.cd_banco_externo::text, '') = '' THEN b.cd_banco  ELSE somente_numero(d.cd_banco_externo) END =cd_banco_pagto_w THEN '30'  ELSE CASE WHEN(select	count(*)						from	banco x						where	CASE WHEN coalesce(x.cd_banco_externo::text, '') = '' THEN x.cd_banco  ELSE somente_numero(x.cd_banco_externo) END 	= somente_numero(substr(c.nr_bloqueto,1,3)))=0 THEN '11'  ELSE '31' END  END  END   ELSE CASE WHEN coalesce(c.nr_bloqueto::text, '') = '' THEN '16'  ELSE '11' END  END   ELSE CASE WHEN coalesce(c.nr_bloqueto::text, '') = '' THEN '17'  ELSE '11' END  END  ie_forma_lanc,
	b.ie_tipo_pagamento ie_tipo_pagamento,
  b.ie_tipo_servico ie_tipo_servico
FROM titulo_pagar c, banco_escritural a, titulo_pagar_escrit b
LEFT OUTER JOIN banco d ON (b.cd_banco = d.cd_banco)
WHERE b.nr_titulo		= c.nr_titulo and (b.ie_tipo_pagamento in ('BLQ','PC') or
	exists (select	1
	from	darf_titulo_pagar x
	where	x.nr_titulo	= b.nr_titulo) or
	exists (select	1
	from	gps_titulo x
	where	x.nr_titulo	= b.nr_titulo)) and a.nr_sequencia		= b.nr_seq_escrit and a.nr_sequencia		= nr_seq_envio_p;

/* detalhe - BLQ */

ie_tipo_servico_w	        titulo_pagar_escrit.ie_tipo_servico%type;
IE_TIPO_SERVICO_PAGTO_W   titulo_pagar_escrit.ie_tipo_servico%type;
ie_converte_bloq_w	      param_char;
dt_venc_bloqueto_w	      titulo_pagar.dt_vencimento_atual%type;
dt_apuracao_w		          darf.dt_apuracao%type;
cd_darf_w		              darf.cd_darf%type;
nr_referencia_w		        darf.nr_referencia%type;
cd_pagamento_w		        gps.cd_pagamento%type;
dt_referencia_w		        date_char;
vl_inss_w		              gps.vl_inss%type;
vl_outras_entidades_w	    gps.vl_outras_entidades%type;
nr_versao_w		            ver_char;

c04 CURSOR FOR
SELECT	rpad(elimina_caractere_especial(substr(obter_nome_pf_pj(c.cd_pessoa_fisica,c.cd_cgc),1,30)),30,' ') nm_pessoa,
  c.nr_titulo nr_titulo,
	b.vl_escritural vl_escritural,
	b.vl_acrescimo vl_acrescimo,
	b.vl_desconto vl_desconto,
	b.vl_despesa vl_despesa,
	c.dt_vencimento_atual dt_vencimento,
	b.vl_juros vl_juros,
	b.vl_multa vl_multa,
	rpad(substr(CASE WHEN coalesce(ie_converte_bloq_w,'N')='S' THEN converte_codigo_bloqueto('Lido_Barra',c.nr_bloqueto)  ELSE c.nr_bloqueto END ,1,44),44,' ') nr_bloqueto,
	CASE WHEN coalesce(c.cd_cgc::text, '') = '' THEN '1'  ELSE '2' END  ie_tipo_identificacao,
	lpad(coalesce(c.cd_cgc,d.nr_cpf),14,'0') nr_inscricao
FROM banco_escritural a, titulo_pagar c
LEFT OUTER JOIN pessoa_fisica d ON (c.cd_pessoa_fisica = d.cd_pessoa_fisica)
, titulo_pagar_escrit b
LEFT OUTER JOIN banco e ON (b.cd_banco = e.cd_banco)
WHERE b.nr_titulo		= c.nr_titulo and CASE WHEN(select	count(*)		from	gps_titulo x		where	x.nr_titulo	= b.nr_titulo)=0 THEN 		CASE WHEN(select	count(*)			from	darf_titulo_pagar x			where	x.nr_titulo	= b.nr_titulo)=0 THEN 			CASE WHEN 	b.ie_tipo_pagamento='PC' THEN '11'  ELSE CASE WHEN 	CASE WHEN coalesce(e.cd_banco_externo::text, '') = '' THEN b.cd_banco  ELSE somente_numero(e.cd_banco_externo) END =cd_banco_pagto_w THEN '30'  ELSE CASE WHEN(select	count(*)						from	banco x						where	CASE WHEN coalesce(x.cd_banco_externo::text, '') = '' THEN x.cd_banco  ELSE somente_numero(x.cd_banco_externo) END 	= somente_numero(substr(c.nr_bloqueto,1,3)))=0 THEN '11'  ELSE '31' END  END  END   ELSE CASE WHEN 	coalesce(c.nr_bloqueto::text, '') = '' THEN '16'  ELSE '11' END  END   ELSE CASE WHEN coalesce(c.nr_bloqueto::text, '') = '' THEN '17'  ELSE '11' END  END 	= ie_forma_lanc_w  and (b.ie_tipo_pagamento in ('BLQ','PC') or
	exists (select	1
	from	darf_titulo_pagar x
	where	x.nr_titulo	= b.nr_titulo) or
	exists (select	1
	from	gps_titulo x
	where	x.nr_titulo	= b.nr_titulo)) and a.nr_sequencia		= b.nr_seq_escrit and a.nr_sequencia		= nr_seq_envio_p;

/* trailer do arquivo */

qt_registro_w		integer;
qt_banco_w      integer;
BEGIN

delete	from w_envio_banco
where	nm_usuario	= nm_usuario_p;

/* header de arquivo */

nr_seq_apres_w		:= coalesce(nr_seq_apres_w,0) + 1;

begin
  select	lpad(substr(coalesce(b.cd_cgc,' '),1,14),14,'0'),
    lpad(substr(coalesce(c.cd_convenio_banco,'0'),1,6),6,'0'),
    lpad(substr(d.cd_agencia_bancaria,1,4),5,'0'),
    lpad(somente_numero(c.cd_conta) || coalesce(c.ie_digito_conta,'0'),13,'0'),
    rpad(coalesce(elimina_caractere_especial(substr(obter_nome_estabelecimento(b.cd_estabelecimento),1,30)),' '),30,' '),
    to_char(clock_timestamp(),'ddmmyyyy'),
    to_char(clock_timestamp(),'hhmiss'),
    coalesce(a.nr_remessa,a.nr_sequencia),
    b.cd_estabelecimento,
    a.dt_remessa_retorno,
    rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'R'),1,30),' '),30,' '),
    lpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'NR'),1,5),'0'),5,'0'),
    rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'CO'),1,15),' '),15,' '),
    rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'CI'),1,20),' '),20,' '),
    lpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'CEP'),1,8),'0'),8,'0'),
    rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'UF'),1,2),' '),2,' '),
    coalesce(substr(c.ie_digito_conta,1,1),'0'),
    somente_numero(coalesce(substr(e.cd_banco_externo,1,3),to_char(e.cd_banco))) cd_banco,
    substr(coalesce(e.ds_banco,' '),1,30) ds_banco
  into STRICT	cd_cgc_estab_w,
    cd_convenio_banco_w,
    cd_agencia_estab_w,
    nr_conta_estab_w,
    nm_empresa_w,
    dt_geracao_w,
    hr_geracao_w,
    nr_remessa_w,
    cd_estabelecimento_w,
    dt_remessa_retorno_w,
    ds_endereco_w,
    nr_endereco_w,
    ds_complemento_w,
    ds_municipio_w,
    nr_cep_w,
    sg_estado_w,
    ie_digito_estab_w,
    cd_banco_pagto_w,
    ds_banco_w
  from	banco e,
    agencia_bancaria d,
    banco_estabelecimento c,
    estabelecimento b,
    banco_escritural a
  where	c.cd_banco		= e.cd_banco
  and	c.cd_banco		= d.cd_banco
  and	c.cd_agencia_bancaria	= d.cd_agencia_bancaria
  and	a.nr_seq_conta_banco	= c.nr_sequencia
  and	a.cd_estabelecimento	= b.cd_estabelecimento
  and	a.nr_sequencia		= nr_seq_envio_p;
exception
  when	no_data_found then raise;
  when	too_many_rows then raise;
end;

ie_converte_bloq_w := obter_param_usuario(857, 36, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_converte_bloq_w);

ds_conteudo_w	:=	lpad(cd_banco_pagto_w,3,'0') ||     -- 001|003
			'0000' ||                                   -- 004|007
			'0' ||                                      -- 008|008
			rpad(' ',9,' ') ||                          -- 009|017
			'2' ||                                      -- 018|018
			cd_cgc_estab_w ||                           -- 019|032
			cd_convenio_banco_w ||                      -- 033|038
			rpad(' ',14,' ') ||                         -- 039|052
			cd_agencia_estab_w ||                       -- 053|057
			'0' ||                                      -- 058|058
			nr_conta_estab_w ||                         -- 059|071
			'0' ||                                      -- 072|072
			rpad(upper(nm_empresa_w),30,' ') ||         -- 073|102
			rpad(upper(ds_banco_w),30,' ') ||           -- 103|132
			rpad(' ',10,' ') ||                         -- 133|142
			'1' ||                                      -- 143|143
			dt_geracao_w ||                             -- 144|151
			hr_geracao_w ||                             -- 152|157
			lpad(substr(nr_remessa_w,1,6),6,'0') ||     -- 158|163
			'041' ||                                    -- 164|166
			'00000' ||                                  -- 167|171
			rpad(' ',9,' ') ||                          -- 172|180
			' ' ||                                      -- 181|181
			rpad(' ',10,' ') ||                         -- 182|191
			rpad(' ',20,' ') ||                         -- 192|211
			rpad(' ',29,' ');                           -- 212|240
insert	into w_envio_banco(cd_estabelecimento,
	ds_conteudo,
	dt_atualizacao,
	nm_usuario,
	nr_seq_apres,
	nr_seq_apres_2,
	nr_sequencia)
values (cd_estabelecimento_w,
	ds_conteudo_w,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_apres_w,
	nr_seq_apres_w,
	nextval('w_envio_banco_seq'));

<<reg_lote01_w>>
for reg_lote01_w in C01
loop

  ie_forma_lanc_w := reg_lote01_w.ie_forma_lanc;
  ie_tipo_pagamento_w := reg_lote01_w.ie_tipo_pagamento;

	/* header de lote */

	nr_lote_servico_w	:= coalesce(nr_lote_servico_w,0) + 1;
	nr_seq_apres_w		:= coalesce(nr_seq_apres_w,0) + 1;
	nr_sequencia_w		:= 0;
	vl_total_w		:= 0;

	ds_conteudo_w	:=	lpad(cd_banco_pagto_w,3,'0') ||      -- 001|003
				lpad(nr_lote_servico_w,4,'0') ||             -- 004|007
				'1' ||                                       -- 008|008
				'C' ||                                       -- 009|009
				'20' ||                                      -- 010|011
				lpad(ie_forma_lanc_w,2,'0') ||               -- 012|013
				'041' ||                                     -- 014|016
				' ' ||                                       -- 017|017
				'2' ||                                       -- 018|018
				lpad(cd_cgc_estab_w,14,'0') ||               -- 019|032
				lpad(cd_convenio_banco_w,6,'0') ||           -- 033|038
				rpad(' ',14,' ') ||                          -- 039|052
				lpad(cd_agencia_estab_w,5,'0') ||            -- 053|057
				'0' ||                                       -- 058|058
				lpad(nr_conta_estab_w,13,'0') ||             -- 059|071
				' ' ||                                       -- 072|072
				rpad(nm_empresa_w,30,' ') ||                 -- 073|102
				rpad(' ',40,' ') ||                          -- 103|142
				rpad(ds_endereco_w,30,' ') ||                -- 143|172
				lpad(nr_endereco_w,5,'0') ||                 -- 173|177
				rpad(ds_complemento_w,15,' ') ||             -- 178|192
				rpad(ds_municipio_w,20 ,' ') ||              -- 193|212
				lpad(nr_cep_w,8,'0') ||                      -- 213|220
				substr(sg_estado_w,1,2) ||                   -- 221|222
				rpad(' ',2,' ') ||                           -- 223|224
				rpad(' ',6,' ') ||                           -- 225|230
				rpad(' ',10,' ');                            -- 231|240
	insert	into w_envio_banco(cd_estabelecimento,
		ds_conteudo,
		dt_atualizacao,
		nm_usuario,
		nr_seq_apres,
		nr_seq_apres_2,
		nr_sequencia)
	values (cd_estabelecimento_w,
		ds_conteudo_w,
		clock_timestamp(),
		nm_usuario_p,
    	nr_seq_apres_w,
		nr_seq_apres_w,
		nextval('w_envio_banco_seq'));

  <<reg_lote02_w>>
  for reg_lote02_w in C02
  loop

    cd_banco_w := coalesce(reg_lote02_w.cd_banco,0);
		cd_agencia_bancaria_w := coalesce(reg_lote02_w.cd_agencia_bancaria,0);
		nr_conta_w := coalesce(reg_lote02_w.nr_conta,0);
		ie_digito_conta_w := coalesce(reg_lote02_w.ie_digito_conta,0);

		select	coalesce(max(1),0)
		into STRICT	qt_favorecido_w
		from	titulo_pagar_favorecido a
		where	a.nr_titulo	= reg_lote02_w.nr_titulo;

		if (coalesce(qt_favorecido_w,0)	> 0) then

			select	somente_numero(substr(obter_conta_pessoa(coalesce(a.cd_cgc,a.cd_pessoa_fisica),CASE WHEN coalesce(a.cd_cgc::text, '') = '' THEN 'F'  ELSE 'J' END ,'B'),1,3)) cd_banco,
				lpad(substr(obter_conta_pessoa(coalesce(a.cd_cgc,a.cd_pessoa_fisica),CASE WHEN coalesce(a.cd_cgc::text, '') = '' THEN 'F'  ELSE 'J' END ,'A'),1,5) ||
				substr(obter_conta_pessoa(coalesce(a.cd_cgc,a.cd_pessoa_fisica),CASE WHEN coalesce(a.cd_cgc::text, '') = '' THEN 'F'  ELSE 'J' END ,'DA'),1,1),6,'0') cd_agencia_bancaria,
				substr(obter_conta_pessoa(coalesce(a.cd_cgc,a.cd_pessoa_fisica),CASE WHEN coalesce(a.cd_cgc::text, '') = '' THEN 'F'  ELSE 'J' END ,'C'),1,255) nr_conta,
				coalesce(substr(obter_conta_pessoa(coalesce(a.cd_cgc,a.cd_pessoa_fisica),CASE WHEN coalesce(a.cd_cgc::text, '') = '' THEN 'F'  ELSE 'J' END ,'DC'),1,1),'0') ie_digito_conta
			into STRICT	cd_banco_w,
				cd_agencia_bancaria_w,
				nr_conta_w,
				ie_digito_conta_w
			from	titulo_pagar_favorecido a
			where	a.nr_titulo	= reg_lote02_w.nr_titulo;

		end if;

		/* segmento A */

		nr_sequencia_w	:= coalesce(nr_sequencia_w,0) + 1;
		nr_seq_apres_w	:= coalesce(nr_seq_apres_w,0) + 1;
		qt_registro_w	:= coalesce(qt_registro_w,0) + 1;

    vl_sub_total_w := (coalesce(reg_lote02_w.vl_escritural,0) - coalesce(reg_lote02_w.vl_desconto,0) + coalesce(reg_lote02_w.vl_juros,0)
       + coalesce(reg_lote02_w.vl_multa,0) + coalesce(reg_lote02_w.vl_acrescimo,0) + coalesce(reg_lote02_w.vl_despesa,0));

		vl_total_w	:= coalesce(vl_total_w,0) + vl_sub_total_w;

    if (reg_lote02_w.ie_tipo_pgto = '00007') then /*DOC*/
			cd_finalidade_doc_w := '07';
			cd_finalidade_ted_w := lpad(' ',5,' ');
			cd_finalidade_compl_w := 'CC';
		elsif (reg_lote02_w.ie_tipo_pgto = '00005') then /*TED*/
			cd_finalidade_doc_w := lpad(' ',2,' ');
			cd_finalidade_ted_w	:= '00005';
			cd_finalidade_compl_w := 'CC';
		else
			cd_finalidade_doc_w := lpad(' ',2,' ');
			cd_finalidade_ted_w	:= lpad(' ',5,' ');
			cd_finalidade_compl_w := lpad(' ',2,' ');
		end if;

		ds_conteudo_w	:=	lpad(cd_banco_pagto_w,3,'0') ||                                           -- 001|003
					lpad(nr_lote_servico_w,4,'0') ||                                                  -- 004|007
					'3' ||                                                                            -- 008|008
					substr(lpad(nr_sequencia_w,5,'0'),1,5) ||                                         -- 009|013
					'A' ||                                                                            -- 014|014
					'0' ||                                                                            -- 015|015
					'00' ||                                                                           -- 016|017
					lpad(reg_lote02_w.cd_camara,3,'0') ||                                             -- 018|020
					lpad(cd_banco_w,3,'0') ||                                                         -- 021|023
					substr(cd_agencia_bancaria_w,1,6) ||                                              -- 024|029
					lpad(substr(nr_conta_w||ie_digito_conta_w,1,13),13,'0') ||                        -- 030|042
					' ' ||                                                                            -- 043|043
					substr(rpad(reg_lote02_w.nm_pessoa,30,' '),1,30) ||                               -- 044|073
					lpad(reg_lote02_w.ie_tipo_pgto,5,'0') ||                                          -- 074|078
					lpad(reg_lote02_w.nr_titulo,15,'0') ||                                            -- 079|093
					to_char(dt_remessa_retorno_w,'ddmmyyyy') ||                                       -- 094|101
					'BRL' ||                                                                          -- 102|104
					lpad('0',15,'0') ||                                                               -- 105|119
					lpad(somente_numero(to_char(vl_sub_total_w,'9999999999990.00')),15,'0') ||        -- 120|134
					rpad(' ',20,' ') ||                                                               -- 135|154
					lpad('0',8,'0') ||                                                                -- 155|162
					lpad('0',15,'0') ||                                                               -- 163|177
					rpad(' ',40,' ') ||                                                               -- 178|217
					cd_finalidade_doc_w ||                                                            -- 218|219
					cd_finalidade_ted_w ||                                                            -- 220|224
					cd_finalidade_compl_w ||                                                          -- 225|226
					rpad(' ',3,' ') ||                                                                -- 227|229
					'0' ||                                                                            -- 230|230
					rpad(' ',10,' ');                                                                 -- 231|240
		insert	into w_envio_banco(cd_estabelecimento,
			ds_conteudo,
			dt_atualizacao,
			nm_usuario,
			nr_seq_apres,
			nr_seq_apres_2,
			nr_sequencia)
		values (cd_estabelecimento_w,
			ds_conteudo_w,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_apres_w,
			nr_seq_apres_w,
			nextval('w_envio_banco_seq'));
      
		/* segmento B */

		nr_sequencia_w	:= coalesce(nr_sequencia_w,0) + 1;
		nr_seq_apres_w	:= coalesce(nr_seq_apres_w,0) + 1;
		qt_registro_w	:= coalesce(qt_registro_w,0) + 1;

		ds_conteudo_w	:=	lpad(cd_banco_pagto_w,3,'0') ||                                                        -- 001|003
					lpad(nr_lote_servico_w,4,'0') ||                                                               -- 004|007
					'3' ||                                                                                         -- 008|008
					lpad(nr_sequencia_w,5,'0') ||                                                                  -- 009|013
					'B' ||                                                                                         -- 014|014
					rpad(' ',3,' ') ||                                                                             -- 015|017
					reg_lote02_w.ie_tipo_inscricao ||                                                              -- 018|018
					lpad(coalesce(reg_lote02_w.nr_inscricao,'0'),14,'0') ||                                             -- 019|032
					reg_lote02_w.ds_endereco_det ||                                                                -- 033|062
					reg_lote02_w.nr_endereco_det ||                                                                -- 063|067
					reg_lote02_w.ds_complemento_det ||                                                             -- 068|082
					reg_lote02_w.ds_bairro_det ||                                                                  -- 083|097
					reg_lote02_w.ds_municipio_det ||                                                               -- 098|117
					reg_lote02_w.nr_cep_det ||                                                                     -- 118|125
					substr(reg_lote02_w.sg_estado_det,1,2) ||                                                      -- 126|127
					to_char(reg_lote02_w.dt_vencimento,'ddmmyyyy') ||                                              -- 128|135
					lpad(somente_numero(to_char(coalesce(reg_lote02_w.vl_escritural,0),'9999999999990.00')),15,'0') ||  -- 136|150
					rpad('0',15,'0') ||                                                                            -- 151|165
					lpad(somente_numero(to_char(coalesce(reg_lote02_w.vl_desconto,0),'9999999999990.00')),15,'0') ||    -- 166|180
					lpad(somente_numero(to_char(coalesce(reg_lote02_w.vl_juros,0),'9999999999990.00')),15,'0') ||       -- 181|195
					lpad(somente_numero(to_char(coalesce(reg_lote02_w.vl_multa,0),'9999999999990.00')),15,'0') ||       -- 196|210
					rpad(' ',15,' ') ||                                                                            -- 211|225
					'0' ||                                                                                         -- 226|226
					rpad(' ',6,' ') ||                                                                             -- 227|232
					rpad(' ',8,' ');                                                                               -- 233|240
		insert	into w_envio_banco(cd_estabelecimento,
			ds_conteudo,
			dt_atualizacao,
			nm_usuario,
			nr_seq_apres,
			nr_seq_apres_2,
			nr_sequencia)
		values (cd_estabelecimento_w,
			ds_conteudo_w,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_apres_w,
			nr_seq_apres_w,
			nextval('w_envio_banco_seq'));

	end	loop reg_lote02_w;

	/* trailer de lote */

	nr_seq_apres_w	:= coalesce(nr_seq_apres_w,0) + 1;

	ds_conteudo_w	:=	lpad(cd_banco_pagto_w,3,'0') ||                                       -- 001|003
				lpad(nr_lote_servico_w,4,'0') ||                                                  -- 004|007
				'5' ||                                                                            -- 008|008
				rpad(' ',9,' ') ||                                                                -- 009|017
				lpad(nr_sequencia_w + 2,6,'0') ||                                                 -- 018|023
				lpad(somente_numero(to_char(coalesce(vl_total_w,0),'9999999999999990.00')),18,'0') ||  -- 024|041
				lpad('0',18,'0') ||                                                               -- 042|059
				lpad('0',6,'0') ||                                                                -- 060|065
				lpad(' ',165,' ') ||                                                              -- 066|230
				lpad(' ',10,' ');                                                                 -- 231|240
	insert	into w_envio_banco(cd_estabelecimento,
		ds_conteudo,
		dt_atualizacao,
		nm_usuario,
		nr_seq_apres,
		nr_seq_apres_2,
		nr_sequencia)
	values (cd_estabelecimento_w,
		ds_conteudo_w,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_apres_w,
		nr_seq_apres_w,
		nextval('w_envio_banco_seq'));

end loop reg_lote01;

/*open	c03;
loop
fetch	c03 into
	ie_forma_lanc_w,
	ie_tipo_pagamento_w,
  IE_TIPO_SERVICO_PAGTO_W;
exit	when c03%notfound;*/
<<reg_lote03_w>>
for reg_lote03_w in C03
loop

  ie_forma_lanc_w := reg_lote03_w.ie_forma_lanc;

	/* header de lote - BLQ */

	nr_lote_servico_w	:= coalesce(nr_lote_servico_w,0) + 1;
	nr_seq_apres_w		:= coalesce(nr_seq_apres_w,0) + 1;
	nr_sequencia_w		:= 0;
	vl_total_w		:= 0;
  
	if (ie_forma_lanc_w	= '16') or (ie_forma_lanc_w	= '17') or (ie_forma_lanc_w	= '11') then

		ie_tipo_servico_w	:= '22'; /*Pagamento de Contas, Tributos e Impostos*/
		nr_versao_w		:= '012'; /*/*Versao para header de lote - Segmento O*/
	else
		if (cd_banco_pagto_w	= 237) then
			ie_tipo_servico_w	:= '20'; /*Pagamento Fornecedor*/
		else
			ie_tipo_servico_w	:= '03'; /*Bloqueto Eletronico*/
		end if;
		nr_versao_w	:= '107'; /*Versao para header de lote - Segmento J*/
	end if;
	
	if	((IE_TIPO_SERVICO_PAGTO_W = 00094) or (IE_TIPO_SERVICO_PAGTO_W = 00095) or (IE_TIPO_SERVICO_PAGTO_W = 00100) or (IE_TIPO_SERVICO_PAGTO_W = 00105) or (IE_TIPO_SERVICO_PAGTO_W = 00110) or (IE_TIPO_SERVICO_PAGTO_W = 00115) or (IE_TIPO_SERVICO_PAGTO_W = 00120) or (IE_TIPO_SERVICO_PAGTO_W = 00125) or (IE_TIPO_SERVICO_PAGTO_W = 00130) or (IE_TIPO_SERVICO_PAGTO_W = 00098)) then
		
		ie_tipo_servico_w := '98';
		
	elsif (IE_TIPO_SERVICO_PAGTO_W = 00010 ) then
		ie_tipo_servico_w := '10';
	elsif (IE_TIPO_SERVICO_PAGTO_W = 00020 ) then
		ie_tipo_servico_w := '20';
	elsif (IE_TIPO_SERVICO_PAGTO_W = 00030 ) then
		ie_tipo_servico_w := '30';
	elsif (IE_TIPO_SERVICO_PAGTO_W = 00022 ) then
		ie_tipo_servico_w := '22';
	elsif (IE_TIPO_SERVICO_PAGTO_W = 00050 ) then
		ie_tipo_servico_w := '50';
	elsif (IE_TIPO_SERVICO_PAGTO_W = 00060 ) then
		ie_tipo_servico_w := '60';
	elsif (IE_TIPO_SERVICO_PAGTO_W = 00070 ) then
		ie_tipo_servico_w := '70';	
	elsif (IE_TIPO_SERVICO_PAGTO_W = 00075 ) then
		ie_tipo_servico_w := '75';
	elsif (IE_TIPO_SERVICO_PAGTO_W = 00080 ) then
		ie_tipo_servico_w := '80';
	elsif (IE_TIPO_SERVICO_PAGTO_W = 00090 ) then
		ie_tipo_servico_w := '90';		
	end if;

	ds_conteudo_w	:=	lpad(cd_banco_pagto_w,3,'0') ||      -- 001|003
				lpad(nr_lote_servico_w,4,'0') ||             -- 004|007
				'1' ||                                       -- 008|008
				'C' ||                                       -- 009|009
				lpad(ie_tipo_servico_w,2,'0') ||             -- 010|011
				lpad(ie_forma_lanc_w,2,'0') ||               -- 012|013
				nr_versao_w ||                               -- 014|016
				' ' ||                                       -- 017|017
				'2' ||                                       -- 018|018
				lpad(cd_cgc_estab_w,14,'0') ||               -- 019|032
				lpad(cd_convenio_banco_w,6,'0') ||           -- 033|038
				rpad(' ',14,' ') ||                          -- 039|052
				lpad(cd_agencia_estab_w,5,'0') ||            -- 053|057
				'0' ||                                       -- 058|058
				lpad(nr_conta_estab_w,13,'0') ||             -- 059|071
				' ' ||                                       -- 072|072
				rpad(nm_empresa_w,30,' ') ||                 -- 073|102
				rpad(' ',40,' ') ||                          -- 103|142
				rpad(ds_endereco_w,30,' ') ||                -- 143|172
				lpad(nr_endereco_w,5,'0') ||                 -- 173|177
				rpad(ds_complemento_w,15,' ') ||             -- 178|192
				rpad(ds_municipio_w,20 ,' ') ||              -- 193|212
				lpad(nr_cep_w,8,'0') ||                      -- 213|220
				substr(sg_estado_w,1,2) ||                   -- 221|222
				rpad(' ',2,' ') ||                           -- 223|224
				rpad(' ',6,' ') ||                           -- 225|230
				rpad(' ',10,' ');                            -- 231|240
	insert	into w_envio_banco(cd_estabelecimento,
		ds_conteudo,
		dt_atualizacao,
		nm_usuario,
		nr_seq_apres,
		nr_seq_apres_2,
		nr_sequencia)
	values (cd_estabelecimento_w,
		ds_conteudo_w,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_apres_w,
		nr_seq_apres_w,
		nextval('w_envio_banco_seq'));

	<<reg_lote04_w>>
	for reg_lote04_w in C04
	loop

		nr_sequencia_w	:= coalesce(nr_sequencia_w,0) + 1;
		nr_seq_apres_w	:= coalesce(nr_seq_apres_w,0) + 1;
		qt_registro_w	:= coalesce(qt_registro_w,0) + 1;

		vl_sub_total_w := coalesce(reg_lote04_w.vl_escritural,0) - coalesce(reg_lote04_w.vl_desconto,0) + coalesce(reg_lote04_w.vl_acrescimo,0)
			+ coalesce(reg_lote04_w.vl_despesa,0) + coalesce(reg_lote04_w.vl_juros,0) + coalesce(reg_lote04_w.vl_multa,0);

		vl_total_w	:= coalesce(vl_total_w,0) + vl_sub_total_w;

		select	coalesce(max(1),0)
		into STRICT	qt_banco_w
		from	banco a
		where CASE WHEN coalesce(a.cd_banco_externo::text, '') = '' THEN a.cd_banco  ELSE somente_numero(a.cd_banco_externo) END 	= somente_numero(substr(reg_lote04_w.nr_bloqueto,1,3));

		/* segmento N - DARF normal */

		if (ie_forma_lanc_w	= '16') then

			select	max(b.dt_apuracao) dt_apuracao,
				rpad(substr(coalesce(max(b.cd_darf),'0'),1,6),6,' ') cd_darf,
				lpad(substr(coalesce(max(b.nr_referencia),'0'),1,17),17,'0') nr_referencia
			into STRICT	dt_apuracao_w,
				cd_darf_w,
				nr_referencia_w
			from	darf b,
				darf_titulo_pagar a
			where	a.nr_seq_darf	= b.nr_sequencia
			and	a.nr_titulo	= reg_lote04_w.nr_titulo;

			ds_conteudo_w	:=	lpad(cd_banco_pagto_w,3,'0') ||                                                       -- 001|003
						lpad(nr_lote_servico_w,4,'0') ||                                                              -- 004|007
						'3' ||                                                                                        -- 008|008
						lpad(nr_sequencia_w,5,'0') ||                                                                 -- 009|013
						'N' ||                                                                                        -- 014|014
						'0' ||                                                                                        -- 015|015
						'00' ||                                                                                       -- 016|017
						rpad(reg_lote04_w.nr_titulo,20,' ') ||                                                        -- 018|037
						rpad(' ',20,' ') ||                                                                           -- 038|057
						rpad(nm_empresa_w,30,' ') ||                                                                  -- 058|087
						to_char(dt_remessa_retorno_w,'ddmmyyyy') ||                                                   -- 088|095
						lpad(somente_numero(to_char(vl_sub_total_w,'9999999999990.00')),15,'0') ||                    -- 096|110
						cd_darf_w ||                                                                                  -- 111|116
						'01' ||                                                                                       -- 117|118
						cd_cgc_estab_w ||                                                                             -- 119|132
						'16' ||                                                                                       -- 133|134
						to_char(dt_apuracao_w,'ddmmyyyy') ||                                                          -- 135|142
						nr_referencia_w ||                                                                            -- 143|159
						lpad(somente_numero(to_char(coalesce(reg_lote04_w.vl_escritural,0),'9999999999990.00')),15,'0') || -- 160|174
						lpad(somente_numero(to_char(coalesce(reg_lote04_w.vl_multa,0),'9999999999990.00')),15,'0') ||      -- 175|189
						lpad(somente_numero(to_char(coalesce(reg_lote04_w.vl_juros,0),'9999999999990.00')),15,'0') ||      -- 190|204
						to_char(reg_lote04_w.dt_vencimento,'ddmmyyyy') ||                                             -- 205|212
						rpad(' ',18,' ') ||                                                                           -- 205|230
						rpad(' ',10,' ');                                                                             -- 231|240
		/* segmento N - GPS */

		elsif (ie_forma_lanc_w	= '17') then

			select	to_char(max(b.dt_referencia),'mmyyyy') dt_referencia,
				rpad(substr(coalesce(max(b.cd_pagamento),'0'),1,6),6,' ') cd_pagamento,
				max(b.vl_inss) vl_inss,
				max(b.vl_outras_entidades) vl_outras_entidades
			into STRICT	dt_referencia_w,
				cd_pagamento_w,
				vl_inss_w,
				vl_outras_entidades_w
			from	gps b,
				gps_titulo a
			where	a.nr_seq_gps	= b.nr_sequencia
			and	a.nr_titulo	= reg_lote04_w.nr_titulo;

			ds_conteudo_w	:=	lpad(cd_banco_pagto_w,3,'0') ||                                                  -- 001|003
						lpad(nr_lote_servico_w,4,'0') ||                                                         -- 004|007
						'3' ||                                                                                   -- 008|008
						lpad(nr_sequencia_w,5,'0') ||                                                            -- 009|013
						'N' ||                                                                                   -- 014|014
						'0' ||                                                                                   -- 015|015
						'00' ||                                                                                  -- 016|017
						rpad(reg_lote04_w.nr_titulo,20,' ') ||                                                   -- 018|037
						rpad(' ',20,' ') ||                                                                      -- 038|057
            rpad(nm_empresa_w,30,' ') ||                                                                         -- 058|087
						to_char(dt_remessa_retorno_w,'ddmmyyyy') ||                                              -- 088|095
						lpad(somente_numero(to_char(vl_sub_total_w,'9999999999990.00')),15,'0') ||               -- 096|110
						cd_pagamento_w ||                                                                        -- 111|116
						'01' ||                                                                                  -- 117|118
						cd_cgc_estab_w ||                                                                        -- 119|132
						'17' ||                                                                                  -- 133|134
						dt_referencia_w ||                                                                       -- 135|140
						lpad(somente_numero(to_char(coalesce(vl_inss_w,0),'9999999999990.00')),15,'0') ||             -- 141|155
						lpad(somente_numero(to_char(coalesce(vl_outras_entidades_w,0),'9999999999990.00')),15,'0') || -- 156|170
						lpad('0',15,'0') ||                                                                      -- 171|185
						rpad(' ',45,' ') ||                                                                      -- 186|230
						rpad(' ',10,' ');                                                                        -- 231|240
		/* segmento O */

		elsif (ie_forma_lanc_w	= '11') or (qt_banco_w		= 0) then

			ds_conteudo_w	:=	lpad(cd_banco_pagto_w,3,'0') ||                                     -- 001|003
						lpad(nr_lote_servico_w,4,'0') ||                                            -- 004|007
						'3' ||                                                                      -- 008|008
						lpad(nr_sequencia_w,5,'0') ||                                               -- 009|013
						'O' ||                                                                      -- 014|014
						'0' ||                                                                      -- 015|015
						'00' ||                                                                     -- 016|017
						reg_lote04_w.nr_bloqueto ||                                                 -- 018|061
						rpad(reg_lote04_w.nm_pessoa,30,' ') ||                                      -- 062|091
						to_char(reg_lote04_w.dt_vencimento,'ddmmyyyy') ||                           -- 092|099
						to_char(dt_remessa_retorno_w,'ddmmyyyy') ||                                 -- 100|107
						lpad(somente_numero(to_char(vl_sub_total_w,'9999999999990.00')),15,'0') ||  -- 108|122
						rpad(reg_lote04_w.nr_titulo,20,' ') ||                                      -- 123|142
						rpad(' ',20,' ') ||                                                         -- 143|162
						rpad(' ',68,' ') ||                                                         -- 163|230
						rpad(' ',10,' ');                                                           -- 231|240
		/* segmento J */

		else

			begin
				dt_venc_bloqueto_w	:= to_date('07/10/1997','dd/mm/yyyy') + somente_numero(substr(reg_lote04_w.nr_bloqueto,6,4));
			exception
			when division_by_zero then raise;
			when	others then
				dt_venc_bloqueto_w	:= reg_lote04_w.dt_vencimento;
			end;

			ds_conteudo_w	:=	lpad(cd_banco_pagto_w,3,'0') ||                                                                             -- 001|003
					lpad(nr_lote_servico_w,4,'0') ||                                                                                        -- 004|007
					'3' ||                                                                                                                  -- 008|008
					lpad(nr_sequencia_w,5,'0') ||                                                                                           -- 009|013
					'J' ||                                                                                                                  -- 014|014
					'0' ||                                                                                                                  -- 015|015
					'00' ||                                                                                                                 -- 016|017
					reg_lote04_w.nr_bloqueto ||                                                                                             -- 018|061
					rpad(reg_lote04_w.nm_pessoa,30,' ') ||                                                                                  -- 062|091
					to_char(dt_venc_bloqueto_w,'ddmmyyyy') ||                                                                               -- 092|099
					lpad(somente_numero(to_char(coalesce(reg_lote04_w.vl_escritural,0),'9999999999990.00')),15,'0') ||                           -- 100|114
					lpad(somente_numero(to_char(coalesce(reg_lote04_w.vl_desconto,0),'9999999999990.00')),15,'0') ||                             -- 115|129
					lpad(somente_numero(to_char(coalesce(reg_lote04_w.vl_multa,0) + coalesce(reg_lote04_w.vl_juros,0),'9999999999990.00')),15,'0') || -- 130|144
					to_char(dt_remessa_retorno_w,'ddmmyyyy') ||                                                                             -- 145|152
					lpad(somente_numero(to_char(vl_sub_total_w,'9999999999990.00')),15,'0') ||                                              -- 153|167
					lpad('0',15,'0') ||                                                                                                     -- 168|182
					rpad(reg_lote04_w.nr_titulo,20,' ') ||                                                                                  -- 183|202
					lpad('0',20,'0') ||                                                                                                     -- 203|222
					'09' ||                                                                                                                 -- 223|224
					rpad(' ',6,' ') ||                                                                                                      -- 225|230
					rpad(' ',10,' ');                                                                                                       -- 231|240
					
			insert	into w_envio_banco(cd_estabelecimento,
				ds_conteudo,
				dt_atualizacao,
				nm_usuario,
				nr_seq_apres,
				nr_seq_apres_2,
				nr_sequencia)
			  values (cd_estabelecimento_w,
				ds_conteudo_w,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_apres_w,
				nr_seq_apres_w,
				nextval('w_envio_banco_seq'));
				
			nr_sequencia_w	:= coalesce(nr_sequencia_w,0) + 1;
			nr_seq_apres_w	:= coalesce(nr_seq_apres_w,0) + 1;
			qt_registro_w	:= coalesce(qt_registro_w,0) + 1;

			ds_conteudo_w	:=	lpad(cd_banco_pagto_w,3,'0') ||	      -- 001|003
					lpad(nr_lote_servico_w,4,'0') ||                  -- 004|007
					'3' ||                                            -- 008|008
					lpad(nr_sequencia_w,5,'0') ||                     -- 009|013
					'J' ||                                            -- 014|014
					' ' ||                                            -- 015|015
					'01' ||                                           -- 016|017
					'52' ||                                           -- 018|019
					'2' ||                                            -- 020|020
					lpad(cd_cgc_estab_w,15,'0') ||                    -- 021|035
					rpad(nm_empresa_w,40,' ') ||                      -- 036|075
					substr(reg_lote04_w.ie_tipo_identificacao,1,1) || -- 076|076
					lpad(reg_lote04_w.nr_inscricao,15,'0') ||         -- 077|091
					rpad(reg_lote04_w.nm_pessoa,40,' ') ||            -- 092|131
					'2' ||                                            -- 132|132
					lpad(cd_cgc_estab_w,15,'0') ||                    -- 133|147
					rpad(nm_empresa_w,40,' ') ||                      -- 148|187
					rpad(' ',53,' ');                                 -- 188|240
			
		end if;

		insert	into w_envio_banco(cd_estabelecimento,
			ds_conteudo,
			dt_atualizacao,
			nm_usuario,
			nr_seq_apres,
			nr_seq_apres_2,
			nr_sequencia)
		values (cd_estabelecimento_w,
			ds_conteudo_w,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_apres_w,
			nr_seq_apres_w,
			nextval('w_envio_banco_seq'));

	end	loop reg_lote04_w;	

	/* trailer de lote */

	nr_seq_apres_w	:= coalesce(nr_seq_apres_w,0) + 1;

	ds_conteudo_w	:=	lpad(cd_banco_pagto_w,3,'0') ||                                       -- 001|003
				lpad(nr_lote_servico_w,4,'0') ||                                                  -- 004|007
				'5' ||                                                                            -- 008|008
				rpad(' ',9,' ') ||                                                                -- 009|017
				lpad(nr_sequencia_w + 2,6,'0') ||                                                 -- 018|023
				lpad(somente_numero(to_char(coalesce(vl_total_w,0),'9999999999999990.00')),18,'0') ||  -- 024|041
				lpad('0',18,'0') ||                                                               -- 042|059
				lpad('0',6,'0') ||                                                                -- 060|065
				lpad(' ',165,' ') ||                                                              -- 066|230
				lpad(' ',10,' ');                                                                 -- 231|240
	insert	into w_envio_banco(cd_estabelecimento,
		ds_conteudo,
		dt_atualizacao,
		nm_usuario,
		nr_seq_apres,
		nr_seq_apres_2,
		nr_sequencia)
	values (cd_estabelecimento_w,
		ds_conteudo_w,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_apres_w,
		nr_seq_apres_w,
		nextval('w_envio_banco_seq'));

end loop reg_lote03;

/* trailer de arquivo */

nr_seq_apres_w	:= coalesce(nr_seq_apres_w,0) + 1;

ds_conteudo_w	:=	lpad(cd_banco_pagto_w,3,'0') ||                               -- 001|003
			'9999' ||                                                                 -- 004|007
			'9' ||                                                                    -- 008|008
			rpad(' ',9,' ') ||                                                        -- 009|017
			lpad(nr_lote_servico_w,6,'0') ||                                          -- 018|023
			lpad(coalesce(qt_registro_w,0) + (coalesce(nr_lote_servico_w,0) * 2) + 2,6,'0') ||  -- 024|029
			lpad('0',6,'0') ||                                                        -- 030|035
			rpad(' ',205,' ');                                                        -- 036|240
insert	into w_envio_banco(cd_estabelecimento,
	ds_conteudo,
	dt_atualizacao,
	nm_usuario,
	nr_seq_apres,
	nr_seq_apres_2,
	nr_sequencia)
values (cd_estabelecimento_w,
	ds_conteudo_w,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_apres_w,
	nr_seq_apres_w,
	nextval('w_envio_banco_seq'));

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_pagto_banrisul_240_v107 ( nr_seq_envio_p bigint, nm_usuario_p text) FROM PUBLIC;

