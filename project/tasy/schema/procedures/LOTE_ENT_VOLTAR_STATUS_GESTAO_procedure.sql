-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lote_ent_voltar_status_gestao ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text, nr_seq_resultado_p bigint, ds_result_ant_p text, pr_result_ant_p bigint, qt_result_ant_p bigint, nr_seq_exame_p bigint, nr_seq_ficha_lote_p bigint, nr_seq_material_p bigint, nr_seq_metodo_p bigint, ie_opcao_p text ) AS $body$
DECLARE


nr_sequencia_prox_w	bigint;
cont_repeticoes_w	bigint;	

qt_resultado_w		exame_lab_result_item.qt_resultado%type;
pr_resultado_w		exame_lab_result_item.pr_resultado%type;
ds_resultado_w		exame_lab_result_item.ds_resultado%type;
ie_status_param74_w varchar(10) := wheb_assist_pck.obterParametroFuncao(10060, 74,'');

	

BEGIN

select 	count(*)
into STRICT	cont_repeticoes_w
from	lote_ent_res_ant_repet
where	nr_seq_resultado = nr_seq_resultado_p
and		nr_seq_exame = nr_seq_exame_p
and		nr_prescricao = nr_prescricao_p
and		nr_seq_prescr = nr_seq_prescr_p
and		nr_seq_material = nr_seq_material_p
and		((nr_seq_ficha_lote = nr_seq_ficha_lote_p) or (coalesce(nr_seq_ficha_lote_p,0) = 0));	

cont_repeticoes_w := cont_repeticoes_w + 1;

select	nextval('lote_ent_res_ant_repet_seq')
into STRICT	nr_sequencia_prox_w
;

if (ie_opcao_p = 'R') then

	update	prescr_procedimento
	set		ie_exame_bloqueado = 'R',
			nm_usuario = nm_usuario_p,
			dt_integracao = CASE WHEN ie_status_param74_w='' THEN  dt_integracao  ELSE null END ,
			ie_status_atend = coalesce(ie_status_param74_w, ie_status_atend)
	where	nr_sequencia = nr_seq_prescr_p
	and		nr_prescricao = nr_prescricao_p;

end if;	
	
CALL insere_usuario_repeticao(nr_prescricao_p,nr_seq_prescr_p,nm_usuario_p);

if (ie_opcao_p <> 'R') then
	select  MAX(qt_resultado),
		MAX(pr_resultado),
		MAX(ds_resultado)
	into STRICT	qt_resultado_w,
			pr_resultado_w,
			ds_resultado_w
	from 	exame_lab_result_item
	where	nr_seq_resultado = 	nr_seq_resultado_p
	and		nr_seq_prescr = nr_seq_prescr_p
	and		nr_seq_exame = 	nr_seq_exame_p;

	if (qt_result_ant_p IS NOT NULL AND qt_result_ant_p::text <> '' AND qt_resultado_w <> qt_result_ant_p) then
		
		update exame_lab_result_item
		set	qt_resultado = qt_result_ant_p
		where	nr_seq_resultado = 	nr_seq_resultado_p
		and		nr_seq_prescr = nr_seq_prescr_p
		and		nr_seq_exame = 	nr_seq_exame_p;
		
	elsif (pr_result_ant_p IS NOT NULL AND pr_result_ant_p::text <> '' AND pr_resultado_w <> pr_result_ant_p) then
		
		update exame_lab_result_item
		set	pr_resultado = pr_result_ant_p
		where	nr_seq_resultado = 	nr_seq_resultado_p
		and		nr_seq_prescr = nr_seq_prescr_p
		and		nr_seq_exame = 	nr_seq_exame_p;
		
	elsif (ds_result_ant_p IS NOT NULL AND ds_result_ant_p::text <> '' AND ds_resultado_w <> ds_result_ant_p) then
		
		update exame_lab_result_item
		set	ds_resultado = ds_result_ant_p
		where	nr_seq_resultado = 	nr_seq_resultado_p
		and		nr_seq_prescr = nr_seq_prescr_p
		and		nr_seq_exame = 	nr_seq_exame_p;
		
	end if;



	insert into	lote_ent_res_ant_repet(
			DT_ATUALIZACAO,
			DT_ATUALIZACAO_NREC,
			NM_USUARIO,
			NM_USUARIO_NREC,
			NR_PRESCRICAO,
			NR_REPETICAO,
			NR_SEQ_EXAME,
			NR_SEQ_FICHA_LOTE,
			NR_SEQ_MATERIAL,
			NR_SEQ_METODO,
			NR_SEQ_PRESCR,
			NR_SEQ_RESULTADO,
			NR_SEQUENCIA,
			DS_RESULT_ANT,
			PR_RESULT_ANT,
			QT_RESULT_ANT
	) values (
			clock_timestamp(),
			clock_timestamp(),
			nm_usuario_p,
			nm_usuario_p,
			nr_prescricao_p,
			cont_repeticoes_w,
			nr_seq_exame_p,
			nr_seq_ficha_lote_p,
			nr_seq_material_p,
			nr_seq_metodo_p,
			nr_seq_prescr_p,
			nr_seq_resultado_p,
			nr_sequencia_prox_w,
			ds_result_ant_p,
			pr_result_ant_p,
			qt_result_ant_p
	);
end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lote_ent_voltar_status_gestao ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text, nr_seq_resultado_p bigint, ds_result_ant_p text, pr_result_ant_p bigint, qt_result_ant_p bigint, nr_seq_exame_p bigint, nr_seq_ficha_lote_p bigint, nr_seq_material_p bigint, nr_seq_metodo_p bigint, ie_opcao_p text ) FROM PUBLIC;

