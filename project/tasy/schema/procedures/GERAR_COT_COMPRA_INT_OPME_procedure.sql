-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cot_compra_int_opme ( nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_agenda_p bigint, ie_commit_p text default 'S') AS $body$
DECLARE


			
nr_cot_compra_w		bigint;
cd_comprador_w		varchar(10);
nr_item_w		integer;
cd_material_w		integer;
qt_material_w		double precision;
cd_unidade_medida_w	varchar(30);
dt_retorno_prev_w	timestamp;
qt_dias_w		bigint;
qt_horas_w		bigint;

c01 CURSOR FOR
	SELECT 	cd_material,
		qt_material,
		obter_dados_material(cd_material, 'UMP')
	from 	agenda_pac_opme
	where 	nr_seq_agenda = nr_seq_agenda_p
	  and   ie_origem_inf <> 'E';/* Alteração OS 1815358 - Desconsiderar itens excluídos */
BEGIN

cd_comprador_w	:= obter_comprador_usuario(nm_usuario_p, cd_estabelecimento_p);

if (coalesce(cd_comprador_w,'X') = 'X') then
	select	coalesce(max(cd_comprador_padrao),'X')
	into STRICT	cd_comprador_w
	from	parametro_compras
	where	cd_estabelecimento = cd_estabelecimento_p;
end if;

if (coalesce(cd_comprador_w,'X') = 'X') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(190193);
end if;

select	nextval('cot_compra_seq')
into STRICT	nr_cot_compra_w
;

select	max(Obter_Valor_Param_Usuario(915, 2, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p))
into STRICT	qt_dias_w
;

select	max(Obter_Valor_Param_Usuario(915, 167, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p))
into STRICT	qt_horas_w
;

select	obter_dia_hora_util_periodo(cd_estabelecimento_p, clock_timestamp(), qt_dias_w)
into STRICT	dt_retorno_prev_w
;

select 	dt_retorno_prev_w + (1 /24 * qt_horas_w)
into STRICT 	dt_retorno_prev_w
;

insert into cot_compra(
	nr_cot_compra,
	dt_cot_compra,
	dt_atualizacao,
	cd_comprador,
	nm_usuario,
	cd_pessoa_solicitante,
	cd_estabelecimento,
	dt_retorno_prev,
	nr_seq_agenda_pac,
	ie_finalidade_cotacao)
values ( nr_cot_compra_w,
	clock_timestamp(),
	clock_timestamp(),
	cd_comprador_w,
	nm_usuario_p,
	cd_comprador_w,
	cd_estabelecimento_p,
	dt_retorno_prev_w,
	nr_seq_agenda_p,
	'F');

open C01;
loop
fetch C01 into	
	cd_material_w,
	qt_material_w,
	cd_unidade_medida_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	select	max(nr_item_cot_compra)
	into STRICT	nr_item_w
	from	cot_compra_item
	where	nr_cot_compra = nr_cot_compra_w;
	if (coalesce(nr_item_w::text, '') = '') then
		nr_item_w := 1;
	else
		nr_item_w := nr_item_w + 1;
	end if;
	
	insert into cot_compra_item(
		nr_cot_compra,
		nr_item_cot_compra,
		cd_material,
		qt_material,
		cd_unidade_medida_compra,
		dt_atualizacao,
		dt_limite_entrega,
		nm_usuario,
		ie_situacao)
	values (	nr_cot_compra_w,
		nr_item_w,
		cd_material_w,
		qt_material_w,
		cd_unidade_medida_w,
		clock_timestamp(),
		clock_timestamp(),
		nm_usuario_p,
		'A');

	end;
end loop;
close C01;		
		
if (coalesce(ie_commit_p,'S') = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cot_compra_int_opme ( nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_agenda_p bigint, ie_commit_p text default 'S') FROM PUBLIC;

