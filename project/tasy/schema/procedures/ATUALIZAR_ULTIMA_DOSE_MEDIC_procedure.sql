-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_ultima_dose_medic ( dt_ultima_dose_p timestamp, nr_prescricao_p bigint, ie_status_atual_p bigint, ie_status_p bigint, ds_sql_item_p text, ie_status_ult_dose_p bigint, ie_utilizacao_p text, ie_ultima_dose_p INOUT text ) AS $body$
DECLARE


ds_sep_bv_w		varchar(10);
ds_comando_update_w	varchar(4000);
qt_registro_w		bigint;


BEGIN

ds_sep_bv_w := obter_separador_bv;

if (ie_utilizacao_p = 'M') then

	update	prescr_procedimento c
	set 	c.dt_ult_dose_medic 	= dt_ultima_dose_p
	where 	c.nr_prescricao 	= nr_prescricao_p
	and 	c.nr_seq_exame in (	SELECT	a.nr_seq_exame
					from 	exame_laboratorio a
					where 	c.nr_seq_exame = a.nr_seq_exame
					and 	a.ie_informar_ult_dose = 'S');
	commit;

elsif (ie_utilizacao_p = 'D') then

	ie_ultima_dose_p := 'P';

	if (ie_status_ult_dose_p > 0) and (ie_status_ult_dose_p = ie_status_p) then

		ie_ultima_dose_p := 'N';

		qt_registro_w := obter_valor_dinamico_bv('select	count(*)  ' ||
					' from 		prescr_procedimento c ' ||
					' where 	c.nr_prescricao 	= :nr_prescricao ' ||
					' and 		c.ie_status_atend 	= :ie_status_atual ' ||	ds_sql_item_p ||
					' and 		c.nr_seq_exame in (	select 	a.nr_seq_exame ' ||
					'					from 	exame_laboratorio a '||
					'					where 	c.nr_seq_exame = a.nr_seq_exame '||
					'					and 	a.ie_informar_ult_dose = :ie_informar_ult_dose)'||
					' and 		c.dt_ult_dose_medic is null ', 'nr_prescricao=' || to_char(nr_prescricao_p) || ds_sep_bv_w ||
					'ie_status_atual=' || to_char(ie_status_atual_p) || ds_sep_bv_w ||
					'ie_informar_ult_dose='|| 'S'||ds_sep_bv_w, qt_registro_w);

		if (qt_registro_w > 0) then
			ds_comando_update_w :=	' update	prescr_procedimento c '	||
						' set 		c.dt_ult_dose_medic 	= :dt_ultima_dose '||
						' where 	c.nr_prescricao 	= :nr_prescricao   '||
						' and 		c.ie_status_atend 	= :ie_status_atual '|| ds_sql_item_p ||
						' and 	c.nr_seq_exame in (	select	a.nr_seq_exame '||
						'				from 	exame_laboratorio a '||
						'				where 	c.nr_seq_exame = a.nr_seq_exame '||
						'				and 	a.ie_informar_ult_dose = :ie_informar_ult_dose)';



			CALL exec_sql_dinamico_bv('', ds_comando_update_w, 	'dt_ultima_dose=' || to_char(dt_ultima_dose_p,'dd/mm/yyyy hh24:mi:ss') || ds_sep_bv_w ||
									'nr_prescricao=' || to_char(nr_prescricao_p) || ds_sep_bv_w ||
									'ie_status_atual=' || to_char(ie_status_atual_p) || ds_sep_bv_w||
									'ie_informar_ult_dose=' || 'S'|| ds_sep_bv_w);
			ie_ultima_dose_p := 'S';
		end if;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_ultima_dose_medic ( dt_ultima_dose_p timestamp, nr_prescricao_p bigint, ie_status_atual_p bigint, ie_status_p bigint, ds_sql_item_p text, ie_status_ult_dose_p bigint, ie_utilizacao_p text, ie_ultima_dose_p INOUT text ) FROM PUBLIC;

