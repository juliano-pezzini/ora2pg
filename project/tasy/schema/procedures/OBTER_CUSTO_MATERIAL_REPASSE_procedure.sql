-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_custo_material_repasse (cd_estabelecimento_p bigint, cd_material_p bigint, vl_custo_p INOUT bigint) AS $body$
DECLARE


ie_forma_calculo_w	varchar(255);
qt_compras_w		bigint;
vl_unitario_nf_w	double precision;
vl_retorno_w		double precision;
cont_w			bigint;

c01 CURSOR FOR
SELECT	a.ie_forma_calculo,
	a.qt_compras
from	regra_custo_mat_repasse a
where	a.cd_estabelecimento			= cd_estabelecimento_p
order	by coalesce(a.cd_material, 0),
	coalesce(a.cd_grupo_material, 0),
	coalesce(a.cd_subgrupo_material, 0),
	coalesce(a.cd_classe_material, 0);


BEGIN

vl_retorno_w		:= 0;

ie_forma_calculo_w	:= null;
qt_compras_w		:= 0;
open c01;
loop
fetch c01 into
	ie_forma_calculo_w,
	qt_compras_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
end loop;
close c01;

if (ie_forma_calculo_w = '1') then

	if (qt_compras_w > 0) then
		select	sum(vl_unitario_item_nf),
			count(*)
		into STRICT	vl_unitario_nf_w,
			cont_w
		from (SELECT	distinct CASE WHEN a.cd_unidade_medida_compra=a.cd_unidade_medida_estoque THEN  a.vl_unitario_item_nf  ELSE dividir_sem_round(a.vl_unitario_item_nf, a.qt_item_estoque) END  vl_unitario_item_nf,
				b.dt_entrada_saida
			from	natureza_operacao o,
				nota_fiscal_item a,
				nota_fiscal b
			where	b.nr_sequencia		= a.nr_sequencia
			and	b.ie_acao_nf		= '1'
			and	b.ie_situacao		= '1'
			and	a.cd_estabelecimento	= cd_estabelecimento_p
			and	b.cd_natureza_operacao	= o.cd_natureza_operacao
			and	o.ie_entrada_saida	= 'E'
			and	(b.dt_atualizacao_estoque IS NOT NULL AND b.dt_atualizacao_estoque::text <> '')
			and	a.cd_material		= cd_material_p
			order 	by b.dt_entrada_saida desc) alias6 LIMIT (qt_compras_w);
		vl_retorno_w	:= (dividir_sem_round(vl_unitario_nf_w, cont_w));
	end if;

end if;

vl_custo_p		:= vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_custo_material_repasse (cd_estabelecimento_p bigint, cd_material_p bigint, vl_custo_p INOUT bigint) FROM PUBLIC;

