-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_evolucao_sae_java (( nr_sequencia_p bigint, nm_usuario_p text) is dt_liberacao_w timestamp) RETURNS varchar AS $body$
DECLARE

		
		ie_alinhamento_w	varchar(1);
		ds_conteudo_w		varchar(32000);
		ds_retorno_w		varchar(32000);
		qt_tamanho_w		smallint := qt_tamanho_p * 2;
	
	
BEGIN	
				
	if (ie_alinhamento_p = 'E') then
		ie_alinhamento_w := 'l';
	elsif (ie_alinhamento_p = 'D') then
		ie_alinhamento_w := 'r';
	elsif (ie_alinhamento_p = 'C') then
		ie_alinhamento_w := 'c';
	else	ie_alinhamento_w := 'j';
	end if;

	ds_conteudo_w := replace(ds_conteudo_p,chr(10),chr(13) || chr(10) || '\par ');
	
	ds_retorno_w := '{\rtf1\ansi\ansicpg1252\deff0{\fonttbl{\f0\fnil\fcharset0 ' || ds_fonte_p || ';}}' 	|| chr(13) || chr(10) ||
			'{\colortbl ;\red0\green0\blue;}' 							|| chr(13) || chr(10) ||
				'\viewkind4\uc1\pard\q' || ie_alinhamento_w || '\cf1\lang1046\f0\fs' || qt_tamanho_w || ' ' ||
				ds_conteudo_w || ' \par }' || chr(13) || chr(10);
			
	return	ds_retorno_w;
	
	end;

begin

select coalesce(max('S'),'N')
into STRICT ie_evolucao_existe_w
from evolucao_paciente
where nr_seq_sae = nr_sequencia_p
and	ie_evolucao_clinica = 'SAE';

if (ie_evolucao_existe_w = 'S') then

	CALL gravar_log_tasy(4042, 'Finalizada gerar_evolucao_sae_java. Ja existe uma evolucao com nr_seq_sae: '|| nr_sequencia_p, nm_usuario_p);

else

cd_perfil_ativo_w := obter_perfil_ativo;

select	coalesce(max(nr_atendimento), 0)
into STRICT	nr_atendimento_w
from	pe_prescricao
where	nr_sequencia = nr_sequencia_p;

select	coalesce(max(cd_estabelecimento), 0)
into STRICT	cd_estabelecimento_w
from	atendimento_paciente
where	nr_atendimento = nr_atendimento_w;

ie_libera_sae_w := obter_param_usuario(281, 384, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ie_libera_sae_w);
ie_gera_intervencao_w := obter_param_usuario(281, 835, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ie_gera_intervencao_w);

select	max(cd_prescritor),
		max(cd_pessoa_fisica),
		max(CASE WHEN coalesce(ie_libera_sae_w,'N')='S' THEN  coalesce(dt_liberacao, clock_timestamp())  ELSE null END ),
		max(ie_rn),
		max(nr_Seq_modelo),
		max(DT_PRESCRICAO)
into STRICT	cd_prescritor_w,
	cd_pessoa_fisica_w,
	dt_liberacao_w,
	ie_rn_w,
	nr_Seq_modelo_w,
	dt_sae_w
from	pe_prescricao
where	nr_sequencia = nr_sequencia_p;


select	count(*)
into STRICT	qt_registro_w
from	pe_prescr_item_result
where	nr_seq_prescr = nr_sequencia_p;

select	count(*)
into STRICT	qt_registro_interv_w
from	pe_prescr_proc
where	nr_seq_prescr = nr_sequencia_p;

select	max(QT_TAMANHO_FONTE),
		max(DS_FONTE)
into STRICT 	ds_tam_fonte_w,
		ds_fonte_w
FROM	configuracao_panel_editor
WHERE	coalesce(cd_funcao,coalesce(281,0)) = coalesce(281,0)
AND 	coalesce(UPPER(nm_usuario_config),coalesce(UPPER(nm_usuario_p),0)) = coalesce(UPPER(nm_usuario_p),0)
AND 	coalesce(cd_estabelecimento,coalesce(cd_estabelecimento_w,0))           	= coalesce(cd_estabelecimento_w,0)
AND 	coalesce(cd_perfil,coalesce(cd_perfil_ativo_w,0))           					= coalesce(cd_perfil_ativo_w,0)
AND	coalesce(UPPER(nm_tabela),coalesce(UPPER('EVOLUCAO_PACIENTE'),0)) = coalesce(UPPER('EVOLUCAO_PACIENTE'),0)
ORDER BY
	coalesce(nm_usuario_config,'AAAAAAAA'),
	coalesce(cd_funcao,0),
	coalesce(cd_perfil,0),
	coalesce(cd_estabelecimento,0);
if (qt_registro_w > 0) or (qt_registro_interv_w > 0 AND ie_gera_intervencao_w = 'S') then
	ie_gera_comentario_w := obter_param_usuario(281, 298, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ie_gera_comentario_w);
	ie_gera_diagnostico_w := obter_param_usuario(281, 300, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ie_gera_diagnostico_w);
	ie_gera_sinais_vitais_w := obter_param_usuario(281, 1350, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ie_gera_sinais_vitais_w);
	ie_gera_aspecto_analisado_w := obter_param_usuario(281, 1457, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ie_gera_aspecto_analisado_w);
	if (coalesce(trim(both ds_tam_fonte_w)::text, '') = '') then
		ds_tam_fonte_w := Obter_Param_Usuario(281, 6, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ds_tam_fonte_w);
	end if;
	if (coalesce(trim(both ds_fonte_w)::text, '') = '') then
		ds_fonte_w := Obter_Param_Usuario(281, 5, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ds_fonte_w);
	end if;
	ds_parametro_w := Obter_param_Usuario(281, 619, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ds_parametro_w);
	nr_tam_fonte_w := somente_numero(ds_tam_fonte_w) * 2;

	select	max(ie_tipo_evolucao)
	into STRICT	ie_tipo_evolucao_w
	from	usuario
	where	nm_usuario = nm_usuario_p;
	
	if (coalesce(ie_tipo_evolucao_w::text, '') = '') then
		-- Tipo de evolucao nao informado para este usuario. 
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(264634);
	end if;

	/************************* executar cursor *************************/
	

	ds_modelo_w := substr(obter_desc_mod_sae(nr_Seq_modelo_w), 1, 250);
	
	if (ds_modelo_w IS NOT NULL AND ds_modelo_w::text <> '') then
		ds_modelo_w := '\b ' || '                                                                                  ' || ds_modelo_w || ' \b0 \par \par ';
	end if;
	
	if (ie_gera_aspecto_analisado_w = 'S') then

		open c01;
		loop
			fetch c01 into
				nr_seq_w,
				ds_tipo_item_w,
				nr_seq_apres_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
				ds_aux_w := obter_resultados_concat_sae(nr_seq_w, nr_sequencia_p);
				
				if (coalesce(ds_parametro_w, 'N') = 'S') then
					if (ds_aux_w IS NOT NULL AND ds_aux_w::text <> '') then
						ds_evolucao_w := ds_evolucao_w || ds_aux_w || chr(13) || chr(10);
					end if;
					
					if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
						ds_evolucao_w := ds_evolucao_w || ds_observacao_w || chr(13) || chr(10);
					end if;
					espacamento_w := chr(13) || chr(10);
				end if;
				
				if (coalesce(ds_parametro_w, 'N') = 'N') then
					ds_evolucao_w := ds_evolucao_w || '\b ' || ds_tipo_item_w || ' \b0 ' || chr(13) || chr(10);
					if (ds_aux_w IS NOT NULL AND ds_aux_w::text <> '') then
						ds_evolucao_w := ds_evolucao_w || ds_aux_w || ' ' || chr(13) || chr(10);
					end if;
					
					if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
						ds_evolucao_w := ds_evolucao_w || ds_observacao_w || ' ' || chr(13) || chr(10);
					end if;
				end if;	
				
				if (coalesce(ds_parametro_w, 'N') = 'T') then
					ds_evolucao_w := ds_evolucao_w || '\b ' || ds_tipo_item_w || ' \b0 ' || chr(13) || chr(10);
					
					if (ds_aux_w IS NOT NULL AND ds_aux_w::text <> '') then
					 ds_evolucao_w := ds_evolucao_w || ds_aux_w || ' ' || chr(13) || chr(10);
					end if;
					
					if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
					 ds_evolucao_w := ds_evolucao_w || ds_observacao_w || ' ' || chr(13) || chr(10);
					end if;
				end if;
				
				if (coalesce(ds_parametro_w, 'N') = 'C') then
					ds_evolucao_w := ds_evolucao_w || '\b ' || ds_tipo_item_w || ' \b0 ' || chr(13) || chr(10);
					
					if (ds_aux_w IS NOT NULL AND ds_aux_w::text <> '') then
						ds_evolucao_w := ds_evolucao_w || ds_aux_w || ' ' || chr(13) || chr(10);
					end if;
					
					if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
						ds_evolucao_w := ds_evolucao_w || ds_observacao_w || ' ' || chr(13) || chr(10);
					end if;	
				end if;
				
				if (coalesce(ds_parametro_w, 'N') = 'R') then
					ds_evolucao_w := ds_evolucao_w || ds_aux_w;					
				end if;
				
				if (coalesce(ds_parametro_w, 'N') = 'O') then
					if (ds_aux_w IS NOT NULL AND ds_aux_w::text <> '') then
						ds_evolucao_w := ds_evolucao_w || ds_aux_w;
					end if;
					
					if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
						ds_evolucao_w := ds_evolucao_w || ds_observacao_w || ' ' || chr(13) || chr(10);
					end if;					
				end if;
				
				if (coalesce(ds_parametro_w, 'N') = 'G') then
					if (ds_aux_w IS NOT NULL AND ds_aux_w::text <> '') then
						ds_evolucao_w := ds_evolucao_w || ds_aux_w;
					end if;
					
					if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
						ds_evolucao_w := ds_evolucao_w || ds_observacao_w || ' ' || chr(13) || chr(10);
					end if;	
					
				end if;
				
		end loop;					
		close c01;
	
	end if;
	
	if (ie_gera_diagnostico_w = 'S') then
		open c02;
		loop
		fetch c02 into	
			ds_diagnostico_w,
			ds_evolucao_diag_w,
			nr_seq_diag_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
			if (ds_diagnosticos_w IS NOT NULL AND ds_diagnosticos_w::text <> '') then		
				ds_diagnosticos_w := ds_diagnosticos_w || ', ' || ds_diagnostico_w;
			else
				ds_diagnosticos_w := ds_diagnostico_w;
			end if;
			
			if (ds_evolucao_diag_w IS NOT NULL AND ds_evolucao_diag_w::text <> '') then
				ds_diagnosticos_w := ds_diagnosticos_w || ' - ' || ds_evolucao_diag_w;
			end if;
		end;
		end loop;
		close c02;
		ds_diagnosticos_w := '\b ' || wheb_mensagem_pck.get_texto(340955) || ' : \b0 ' || ds_diagnosticos_w;
		ds_evolucao_w	  := ds_evolucao_w || ds_diagnosticos_w || ' ' || chr(13) || chr(10);
		
	elsif (ie_gera_diagnostico_w = 'A') then
		open C02;
		loop
		fetch C02 into	
			ds_diagnostico_w,
			ds_evolucao_diag_w,
			nr_seq_diag_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
			if (ds_diagnostico_w IS NOT NULL AND ds_diagnostico_w::text <> '') then				
				ds_diagnosticos_w := ds_diagnosticos_w || ' ' || chr(13) || chr(10) || ds_diagnostico_w;

				if (ds_evolucao_diag_w IS NOT NULL AND ds_evolucao_diag_w::text <> '') then
					ds_diagnosticos_w := ds_diagnosticos_w || ' ' || chr(13) || chr(10) || ' - ' || ds_evolucao_diag_w;
				end if;	
				
				if (nr_seq_diag_w > 0) then
					ds_relacionado_w := '\b ' || wheb_mensagem_pck.get_texto(329048) || ' : \b0 ' || ds_relacionado_w;
				
					open C04;
					loop
					fetch C04 into	
						ds_fator_w;
					EXIT WHEN NOT FOUND; /* apply on C04 */
					begin
						ds_relacionado_w := ds_relacionado_w || ' ' || chr(13) || chr(10) || '	' || '	' || ds_fator_w;
					end;
					end loop;
					close C04;
					ds_diagnosticos_w := ds_diagnosticos_w || ' ' || chr(13) || chr(10) || ds_relacionado_w || ' ' || chr(13) || chr(10);
					ds_relacionado_w  := '';
					
					select	count(*)
					into STRICT	qt_evid_w
					from	pe_item_examinar c,
						pe_item_resultado b,
						pe_result_item_diag a,
						pe_diagnostico d,
						pe_prescr_item_result e
					where	a.nr_seq_diag = nr_seq_diag_w
					and	a.nr_seq_result = b.nr_sequencia
					and	a.nr_seq_diag = d.nr_sequencia
					and	d.ie_caract_def <> 'N'
					and	b.nr_seq_item = c.nr_sequencia
					and	b.nr_sequencia = e.nr_seq_result
					and	e.nr_seq_prescr = nr_sequencia_p
					order by 1;					
					
					if (qt_evid_w > 0) then
						ds_evidenciado_w := '\b ' || wheb_mensagem_pck.get_texto(329047) || ' : \b0 ' || ds_evidenciado_w;
						
						open C05;
						loop
						fetch C05 into	
							ds_fator_w,
							ds_observacao_evidencia_w;
						EXIT WHEN NOT FOUND; /* apply on C05 */
						begin
							ds_evidenciado_w := ds_evidenciado_w || ' ' || chr(13) || chr(10) || '		' || ds_fator_w;
							if (ds_observacao_evidencia_w IS NOT NULL AND ds_observacao_evidencia_w::text <> '') then
								ds_evidenciado_w := ds_evidenciado_w || ' - ' || wheb_mensagem_pck.get_texto(307186) || '.: ' || ds_observacao_evidencia_w;
							end if;
						end;
						end loop;
						close C05;
						ds_diagnosticos_w := ds_diagnosticos_w || ' ' || chr(13) || chr(10) || ds_evidenciado_w || ' ' ||chr(13) || chr(10);
						ds_evidenciado_w  := '';
					end if;
				end if;
			end if;		

		end;
		end loop;
		close C02;
		ds_diagnosticos_w := ' ' || chr(13) || chr(10) || '\b ' || wheb_mensagem_pck.get_texto(340955) || ' : \b0 ' || ds_diagnosticos_w;
		ds_evolucao_w	  := ds_evolucao_w || ds_diagnosticos_w || ' ' || chr(13) || chr(10);		
		
	end if;

	if (ie_gera_intervencao_w = 'S') then
		open c03;
		loop
		fetch c03 into	
			ds_intervencao_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
		begin
			if (ds_intervencoes_w IS NOT NULL AND ds_intervencoes_w::text <> '') then
				ds_intervencoes_w := ds_intervencoes_w || ', \par ' || ds_intervencao_w;
			else
				ds_intervencoes_w := ds_intervencao_w;
			end if;
		end;
		end loop;
		close c03;
		ds_intervencoes_w := '\b ' || wheb_mensagem_pck.get_texto(340957) || ' : \b0 ' || ds_intervencoes_w;
		ds_evolucao_w	  := ds_evolucao_w || ds_intervencoes_w || ' ' || chr(13) || chr(10);
	end if;

	if (ie_gera_sinais_vitais_w = 'S') then
		select	MAX(a.qt_pa_sistolica),
			MAX(a.qt_pa_diastolica),
			MAX(a.qt_pam),
			MAX(a.ds_observacao),
			max(qt_temp),
			max(qt_freq_cardiaca),
			max(qt_freq_resp),			
			max(qt_saturacao_o2)			
		into STRICT	qt_pa_max_w,
			qt_pa_min_w,
			qt_pam_w,
			ds_obs_w,
			qt_temp_w,
			qt_freq_cardiaca_w,
			qt_freq_resp_w,
			qt_saturacao_o2_w
		from	atendimento_sinal_vital a
		where	a.nr_atendimento = nr_atendimento_w
		and	a.dt_sinal_vital = (SELECT max(b.dt_sinal_vital) from atendimento_sinal_vital b where a.nr_atendimento = b.nr_atendimento);
		
		ds_sinais_vitais_w := '\b ' || wheb_mensagem_pck.get_texto(303814) || ' : \b0 ' 		|| ds_sinais_vitais_w 	|| ' ' || chr(13) || chr(10);
		ds_sinais_vitais_w := ds_sinais_vitais_w || '\b ' || UPPER(wheb_mensagem_pck.get_texto(275630)) || ': \b0 '  || qt_pa_max_w 	|| ' ' || chr(13) || chr(10);
		ds_sinais_vitais_w := ds_sinais_vitais_w || '\b ' || UPPER(wheb_mensagem_pck.get_texto(340968)) || ': \b0 '  || qt_pa_min_w 	|| ' ' || chr(13) || chr(10);
		ds_sinais_vitais_w := ds_sinais_vitais_w || '\b ' || wheb_mensagem_pck.get_texto(275655) || ': \b0 ' 	|| qt_pam_w 	|| ' ' || chr(13) || chr(10);
		ds_sinais_vitais_w := ds_sinais_vitais_w || '\b ' || wheb_mensagem_pck.get_texto(850076) || ': \b0 '	|| qt_saturacao_o2_w || chr(13) || chr(10);
		ds_sinais_vitais_w := ds_sinais_vitais_w || '\b ' || wheb_mensagem_pck.get_texto(307186) || '.: \b0 ' || ds_obs_w 	|| ' ' || chr(13) || chr(10);
		ds_sinais_vitais_w := ds_sinais_vitais_w || '\b ' || wheb_mensagem_pck.get_texto(1046609) || ': \b0 '	|| qt_temp_w 	|| ' ' || chr(13) || chr(10);
		ds_sinais_vitais_w := ds_sinais_vitais_w || '\b ' || wheb_mensagem_pck.get_texto(340966) || ': \b0 ' || qt_freq_cardiaca_w || ' ' || chr(13) || chr(10);
		ds_sinais_vitais_w := ds_sinais_vitais_w || '\b ' || wheb_mensagem_pck.get_texto(340967) || ': \b0 ' || qt_freq_resp_w 	|| ' ' || chr(13) || chr(10);
		
		ds_evolucao_w	   := ds_evolucao_w || ds_sinais_vitais_w || ' ' || chr(13) || chr(10);
	end if;	

	select	nextval('evolucao_paciente_seq')
	into STRICT	cd_evolucao_w
	;
	
	begin
	select	ds_comentario
	into STRICT	ds_comentario_w
	from	pe_prescr_comentario
	where	nr_seq_prescr = nr_sequencia_p;
	exception
	when others then
		ds_comentario_w := null;
	end;

	if (ie_gera_comentario_w = 'S') and (ds_comentario_w IS NOT NULL AND ds_comentario_w::text <> '') then
		begin
		
		if (position('<html' in ds_comentario_w) > 0) then --registro feito no html
		
			ds_comentario_w := replace(replace(ds_comentario_w, '<p> </p>', chr(10)||chr(13)), '<p>',chr(10));
			ds_comentario_w := regexp_replace(ds_comentario_w, '<((/[A-Za-z])|[A-Za-z])[^>]*>', '');
			ds_comentario_w := replace(replace(replace(ds_comentario_w, chr(38) || 'nbsp;', ' '), chr(38) ||'lt;', '<'), chr(38) ||'gt;', '>');
			
		
		else
		
		
			nr_seq_texto_w := converte_rtf_string('select	ds_comentario from	pe_prescr_comentario where	nr_seq_prescr = :nr_sequencia_p', nr_sequencia_p, nm_usuario_p, nr_seq_texto_w);
			select ds_texto
			into STRICT ds_comentario_w
			from TASY_CONVERSAO_RTF
			where nr_sequencia = nr_seq_texto_w;
		
		end if;
		
		/*inicio substituir os caracteres chr(13) e chr(10) pelo \par que que representa o enter no rtf*/

		qt_controle_chr_w :=0;
			
		while(position(chr(13) in ds_evolucao_w) > 0) and (qt_controle_chr_w < 100) loop
			ds_evolucao_w := replace(ds_evolucao_w, chr(13), '\par ');
			qt_controle_chr_w := qt_controle_chr_w + 1;
		end loop;
		qt_controle_chr_w := 0;

		while(position(chr(10) in ds_evolucao_w) > 0) and (qt_controle_chr_w < 100) loop
			ds_evolucao_w := replace(ds_evolucao_w, chr(10), '');
			qt_controle_chr_w := qt_controle_chr_w + 1;
		end loop;
		/*fim substituir os caracteres chr(13) e chr(10) pelo \par que que representa o enter no rtf*/


		/*pega o cabecalho do rtf*/

		ds_cabecalho_w := '{\rtf1\ansi\deff0{\fonttbl{\f0\fnil\fcharset0 Arial;}{\f1\fnil Arial;}}' ||
					'{\colortbl ;\red0\green0\blue0;}' ||
					'\viewkind4\uc1\pard\cf1\lang1046\fs20  \fs16 \f1 ';
		ds_pos_inicio_rtf_w := position('lang' in ds_cabecalho_w) + 8;
		ds_conteudo_w2 := substr(ds_cabecalho_w, 1, ds_pos_inicio_rtf_w) || 'fs20 ';
		
		/*acrecenta conteudo texto livre*/

		ds_conteudo_w2 := ds_conteudo_w2 || ds_modelo_w || ds_evolucao_w;
		
		/*acrecenta resto do conteudo do rtf*/

		ds_rodape_w    := '}';
		ds_conteudo_w2 := ds_conteudo_w2 || '\par ' || substr(ds_cabecalho_w, ds_pos_inicio_rtf_w, length(ds_cabecalho_w));
		ds_conteudo_w  := ds_conteudo_w2 || '\par ' || '\b' ||Obter_richtext_base_sae(obter_desc_expressao(285523) || ' : \b0 \par ' || ds_comentario_w, 'E', ds_fonte_w, dividir(nr_tam_fonte_w, 2)) ||ds_rodape_w;
		end;
	else
		ds_cabecalho_w := '{\rtf1\ansi\ansicpg1252\deff0\deflang1046{\fonttbl{\f0\fswiss\fcharset0 ' || ds_fonte_w || ';}}' ||
					'{\*\generator Msftedit 5.41.15.1507;}\viewkind4\uc1\pard\f0\fs' || nr_tam_fonte_w || ' ';
		ds_rodape_w    := '}';
		ds_evolucao_w  := replace(ds_evolucao_w, chr(13) || chr(10), ' \par ');
		ds_conteudo_w  := ds_cabecalho_w || ds_modelo_w || ds_evolucao_w || ds_rodape_w;
	end if;

	select	coalesce(max(ie_situacao),'A')
	into STRICT	ie_situacao_w
	from	tipo_evolucao
	where	cd_tipo_evolucao = 'SAE';

	if (nr_atendimento_w <= 0) then
		nr_atendimento_w := null;
	end if;
	
	if (dt_sae_w > clock_timestamp()) then
		dt_sae_w := clock_timestamp();
	end if;

	if (ie_situacao_w = 'A') then /* Evitar que gere uma evolucao SAE quando a mesma esta inativa */
		insert into evolucao_paciente(
			cd_evolucao,
			dt_evolucao,
			ie_tipo_evolucao,
			cd_pessoa_fisica,
			dt_atualizacao,
			nm_usuario,
			nr_atendimento,
			ds_evolucao,
			cd_medico,
			ie_evolucao_clinica,
			ie_recem_nato,
			ie_situacao,
			nr_seq_sae,
			NM_USUARIO_NREC)
		values (cd_evolucao_w,
			dt_sae_w,
			ie_tipo_evolucao_w,
			cd_pessoa_fisica_w,
			clock_timestamp(),
			nm_usuario_p,
			nr_atendimento_w,
			ds_conteudo_w,
			cd_prescritor_w,
			'SAE',
			coalesce(ie_rn_w,'N'),
			'A',
			nr_sequencia_p,
			NM_USUARIO_P);

		if (coalesce(ie_libera_sae_w,'N') = 'S') then
			CALL liberar_informacao('EVOLUCAO_PACIENTE', 'CD_EVOLUCAO', cd_evolucao_w, nm_usuario_p);

			select  max(ie_assinatura)
			into STRICT    ie_should_sign
			from    tasy_proj_assin_perfil
			where   nr_seq_proj = 183
			and     coalesce(cd_perfil, obter_perfil_ativo) = obter_perfil_ativo;

			if ((ie_should_sign IS NOT NULL AND ie_should_sign::text <> '') and ie_should_sign <> 'N') then
				CALL perform_record_signature(nr_atendimento_w,
					cd_pessoa_fisica_w,
					nm_usuario_p,
					183,
					'EVOLUCAO_PACIENTE',
					cd_evolucao_w,
					29796,
					obter_funcao_ativa,
					'L');
			end if;
		end if;
	end if;
end if;

commit;

select 	coalesce(max('S'),'N')
into STRICT	ie_medico_w
from	Medico
where 	cd_pessoa_fisica = cd_prescritor_w;

select 	coalesce(max(ie_regra_libera_evolucao),'M')
into STRICT	ie_regra_libera_evolucao_w
from 	parametro_faturamento
where 	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

select 	coalesce(max(ie_gera_lancto_auto),'N')
into STRICT	ie_gera_lancamento_w
from 	tipo_evolucao
where 	cd_tipo_evolucao = 'SAE';

if	((ie_regra_libera_evolucao_w = 'M' AND ie_medico_w = 'S') or
	 (ie_regra_libera_evolucao_w = 'R' AND ie_gera_lancamento_w = 'S')) then
	CALL gerar_lancamento_automatico(nr_atendimento_w, null, 123, 
		nm_usuario_p, cd_evolucao_w, cd_prescritor_w, null,null,null,null);
end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_evolucao_sae_java (( nr_sequencia_p bigint, nm_usuario_p text) is dt_liberacao_w timestamp) FROM PUBLIC;

