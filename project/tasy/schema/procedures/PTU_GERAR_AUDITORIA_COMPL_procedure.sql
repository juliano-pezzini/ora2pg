-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_gerar_auditoria_compl ( nr_seq_guia_p bigint, nr_seq_requisicao_p bigint, nm_usuario_p text) AS $body$
DECLARE

cd_guia_w			varchar(20);
nr_seq_prestador_w		bigint;
nr_seq_segurado_w		bigint;
ie_tipo_guia_w			varchar(2);
dt_solicitacao_w		timestamp;
cd_medico_solicitante_w		varchar(10);
nr_seq_auditoria_w		bigint;
nr_seq_proc_w			bigint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
qt_solicitada_proc_w		pls_guia_plano_proc.qt_solicitada%type;
nr_seq_mat_w			bigint;
nr_seq_material_w		bigint;
qt_solicitado_mat_w		bigint;
nr_seq_auditoria_item_w		bigint;
ie_tipo_despesa_w		varchar(10);
ie_pacote_w			varchar(1);
nr_seq_grupo_w			bigint;
nr_seq_fluxo_w			bigint;
qt_grupo_w			integer;
qt_fluxo_w			integer;
nr_seq_ordem_atual_w		bigint;
ie_regra_preco_w		varchar(3);
nr_seq_regra_preco_pac_w	bigint;
nr_seq_pacote_w			bigint;
ie_recem_nascido_w		pls_requisicao.ie_recem_nascido%type;
nm_recem_nascido_w		pls_requisicao.nm_recem_nascido%type;
dt_nasc_recem_nascido_w		pls_requisicao.dt_nasc_recem_nascido%type;
vl_material_w			pls_guia_plano_mat.vl_material%type;
vl_procedimento_w		pls_guia_plano_proc.vl_procedimento%type;
ie_tipo_processo_w		pls_requisicao.ie_tipo_processo%type;

C01 CURSOR FOR
	SELECT	nr_sequencia,
		cd_procedimento,
		ie_origem_proced,
		qt_solicitada,
		vl_procedimento
	from	pls_guia_plano_proc
	where	nr_seq_guia	= nr_seq_guia_p
	and	ie_status	= 'A'
	
union

	SELECT	nr_sequencia,
		cd_procedimento,
		ie_origem_proced,
		qt_solicitado,
		vl_procedimento
	from	pls_requisicao_proc
	where	nr_seq_requisicao	= nr_seq_requisicao_p
	and	ie_status	= 'A';
	
C02 CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_material,
		qt_solicitada,
		vl_material
	from	pls_guia_plano_mat
	where	nr_seq_guia	= nr_seq_guia_p
	and	ie_status	= 'A'
	
union

	SELECT	nr_sequencia,
		nr_seq_material,
		qt_solicitado,
		vl_material
	from	pls_requisicao_mat
	where	nr_seq_requisicao	= nr_seq_requisicao_p
	and	ie_status	= 'A';
	
C03 CURSOR FOR
	SELECT 	nr_seq_grupo,
		nr_seq_fluxo
	from	pls_ocorrencia_grupo
	where (nr_seq_ocorrencia(	SELECT	nr_seq_ocorrencia
					from	pls_ocorrencia_benef
					where	nr_seq_guia_plano	= nr_seq_guia_p
					and (nr_seq_proc 		= nr_seq_proc_w
					or	nr_seq_mat 		= nr_seq_mat_w)))
	or (nr_seq_ocorrencia in (	select	nr_seq_ocorrencia
					from	pls_ocorrencia_benef
					where	nr_seq_requisicao	= nr_seq_requisicao_p
					and (nr_seq_proc 		= nr_seq_proc_w
					or	nr_seq_mat 		= nr_seq_mat_w)));
					
C04 CURSOR FOR
	SELECT	nr_seq_grupo,
		nr_seq_fluxo
	from	pls_ocorrencia_grupo
	where (nr_seq_ocorrencia(	SELECT	nr_seq_ocorrencia
					from	pls_ocorrencia_benef
					where	nr_seq_guia_plano	= nr_seq_guia_p
					and	coalesce(nr_seq_proc::text, '') = ''
					and	coalesce(nr_seq_mat::text, '') = ''))
	or (nr_seq_ocorrencia in (	select	nr_seq_ocorrencia
					from	pls_ocorrencia_benef
					where	nr_seq_requisicao	= nr_seq_requisicao_p
					and	coalesce(nr_seq_proc::text, '') = ''
					and	coalesce(nr_seq_mat::text, '') = ''));

BEGIN

if (nr_seq_guia_p IS NOT NULL AND nr_seq_guia_p::text <> '') then
	select	cd_guia,
		nr_seq_prestador,
		nr_seq_segurado,
		ie_tipo_guia,
		dt_solicitacao,
		cd_medico_solicitante,
		ie_recem_nascido,
		nm_recem_nascido,
		dt_nasc_recem_nascido,
		ie_tipo_processo
	into STRICT	cd_guia_w,
		nr_seq_prestador_w,
		nr_seq_segurado_w,
		ie_tipo_guia_w,
		dt_solicitacao_w,
		cd_medico_solicitante_w,
		ie_recem_nascido_w, 
		nm_recem_nascido_w,
		dt_nasc_recem_nascido_w,
		ie_tipo_processo_w
	from	pls_guia_plano
	where	nr_sequencia	= nr_seq_guia_p;
elsif (nr_seq_requisicao_p IS NOT NULL AND nr_seq_requisicao_p::text <> '') then
	select	nr_seq_prestador,
		nr_seq_segurado,
		ie_tipo_guia,
		dt_requisicao,
		cd_medico_solicitante,
		ie_recem_nascido,
		nm_recem_nascido,
		dt_nasc_recem_nascido,
		ie_tipo_processo		
	into STRICT	nr_seq_prestador_w,
		nr_seq_segurado_w,
		ie_tipo_guia_w,
		dt_solicitacao_w,
		cd_medico_solicitante_w,
		ie_recem_nascido_w, 
		nm_recem_nascido_w,
		dt_nasc_recem_nascido_w,
		ie_tipo_processo_w
	from	pls_requisicao
	where	nr_sequencia	= nr_seq_requisicao_p;
end if;

select 	nextval('pls_auditoria_seq')
into STRICT	nr_seq_auditoria_w
;

insert into pls_auditoria(nr_sequencia, dt_auditoria, dt_atualizacao,
	nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
	nr_seq_guia, ie_tipo_auditoria, cd_guia,
	nr_seq_prestador, nr_seq_segurado, ie_tipo_guia,
	dt_solicitacao,	cd_medico_solicitante, ie_status,
	nr_seq_requisicao, ie_recem_nascido, 
	nm_recem_nascido, dt_nasc_recem_nascido, ie_retorno_justific, ie_tipo_processo)
values (	nr_seq_auditoria_w, clock_timestamp(), clock_timestamp(),
	nm_usuario_p, clock_timestamp(), nm_usuario_p,
	nr_seq_guia_p, CASE WHEN coalesce(nr_seq_guia_p::text, '') = '' THEN 'R'  ELSE 'G' END , cd_guia_w,
	nr_seq_prestador_w, nr_seq_segurado_w, ie_tipo_guia_w,
	dt_solicitacao_w, cd_medico_solicitante_w,'A',
	nr_seq_requisicao_p, ie_recem_nascido_w, 
	nm_recem_nascido_w, dt_nasc_recem_nascido_w, 'N', ie_tipo_processo_w);
					
open C04;
loop
fetch C04 into	
	nr_seq_grupo_w,
	nr_seq_fluxo_w;
EXIT WHEN NOT FOUND; /* apply on C04 */
	begin
	select	count(*)
	into STRICT	qt_grupo_w
	from	pls_auditoria_grupo
	where	nr_seq_auditoria 	= nr_seq_auditoria_w
	and	nr_seq_grupo 		= nr_seq_grupo_w;
	
	if (qt_grupo_w = 0) then
		select	count(*)
		into STRICT	qt_fluxo_w
		from	pls_auditoria_grupo
		where	nr_seq_auditoria 	= nr_seq_auditoria_w
		and	nr_seq_ordem 		= nr_seq_fluxo_w;
		
		if (qt_fluxo_w	> 0) then
			select	max(nr_seq_ordem) + 1
			into STRICT	nr_seq_ordem_atual_w
			from	pls_auditoria_grupo
			where	nr_seq_auditoria 	= nr_seq_auditoria_w;
			
			nr_seq_fluxo_w	:= nr_seq_ordem_atual_w;
		end if;
		
		insert into pls_auditoria_grupo(nr_sequencia, nr_seq_auditoria, nr_seq_grupo,
			dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
			nm_usuario_nrec, nr_seq_ordem, ie_status,
			ie_manual)
		values (nextval('pls_auditoria_grupo_seq'), nr_seq_auditoria_w, nr_seq_grupo_w,
			clock_timestamp(), nm_usuario_p, clock_timestamp(),
			nm_usuario_p, nr_seq_fluxo_w, 'U',
			'N');
	end if;
	end;
end loop;
close C04;

nr_seq_grupo_w	:= null;
nr_seq_fluxo_w	:= null;

open C01;
loop
fetch C01 into	
	nr_seq_proc_w,
	cd_procedimento_w,
	ie_origem_proced_w,
	qt_solicitada_proc_w,
	vl_procedimento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	select	nextval('pls_auditoria_item_seq')
	into STRICT	nr_seq_auditoria_item_w
	;
	
	select 	coalesce(max(ie_classificacao),1)
	into STRICT	ie_tipo_despesa_w
	from	procedimento
	where	cd_procedimento		= cd_procedimento_w
	and	ie_origem_proced	= ie_origem_proced_w;

	if (nr_seq_prestador_w	> 0) then
		select	max(nr_sequencia)
		into STRICT	ie_pacote_w
		from	pls_pacote
		where	coalesce(nr_seq_prestador,coalesce(nr_seq_prestador_w,0))	= coalesce(nr_seq_prestador_w,0)
		and	cd_procedimento		= cd_procedimento_w
		and	ie_origem_proced	= ie_origem_proced_w
		and	ie_situacao		= 'A';
		
		if (ie_pacote_w	= 'S') then			
			ie_tipo_despesa_w	:= '4';
		end if;
	end if;
		
	insert into pls_auditoria_item(nr_sequencia, nr_seq_auditoria, cd_procedimento,
		ie_origem_proced, qt_original, nr_seq_proc_origem,
		dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
		nm_usuario_nrec, qt_ajuste, ie_status_solicitacao,
		ie_status, ie_tipo_despesa, vl_original)
	values (nr_seq_auditoria_item_w, nr_seq_auditoria_w, cd_procedimento_w,
		ie_origem_proced_w, qt_solicitada_proc_w, nr_seq_proc_w,
		clock_timestamp(), nm_usuario_p, clock_timestamp(),
		nm_usuario_p, qt_solicitada_proc_w, 'P',
		'P', ie_tipo_despesa_w, vl_procedimento_w);
		
	/* Francisco - 16/05/2012 - OS 447352 */

	if (nr_seq_pacote_w IS NOT NULL AND nr_seq_pacote_w::text <> '') then
		select	coalesce(ie_regra_preco,'N')
		into STRICT	ie_regra_preco_w
		from	pls_pacote a
		where	a.nr_sequencia = nr_seq_pacote_w;
		
		if (ie_regra_preco_w = 'S') then
			SELECT * FROM pls_obter_regra_preco_pacote(cd_procedimento_w, ie_origem_proced_w, 'AA', nr_seq_auditoria_item_w, nm_usuario_p, nr_seq_pacote_w, nr_seq_regra_preco_pac_w) INTO STRICT nr_seq_pacote_w, nr_seq_regra_preco_pac_w;
						
			if (coalesce(nr_seq_pacote_w::text, '') = '') and (ie_tipo_despesa_w = '4') then
				select 	coalesce(max(ie_classificacao),1)
				into STRICT	ie_tipo_despesa_w
				from	procedimento
				where	cd_procedimento		= cd_procedimento_w
				and	ie_origem_proced	= ie_origem_proced_w;
				
				update	pls_auditoria_item
				set	ie_tipo_despesa	= ie_tipo_despesa_w
				where	nr_sequencia	= nr_seq_auditoria_item_w;
			end if;
		end if;
	end if;
				
	nr_seq_mat_w := null;
	open C03;
	loop
	fetch C03 into	
		nr_seq_grupo_w,
		nr_seq_fluxo_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin
		select	count(*)
		into STRICT	qt_grupo_w
		from	pls_auditoria_grupo
		where	nr_seq_auditoria 	= nr_seq_auditoria_w
		and	nr_seq_grupo 		= nr_seq_grupo_w;
					
		if (qt_grupo_w = 0) then
			select	count(*)
			into STRICT	qt_fluxo_w
			from	pls_auditoria_grupo
			where	nr_seq_auditoria 	= nr_seq_auditoria_w
			and	nr_seq_ordem 		= nr_seq_fluxo_w;
			
			if (qt_fluxo_w	> 0) then
				select	max(nr_seq_ordem) + 1
				into STRICT	nr_seq_ordem_atual_w
				from	pls_auditoria_grupo
				where	nr_seq_auditoria 	= nr_seq_auditoria_w;
				
				nr_seq_fluxo_w	:= nr_seq_ordem_atual_w;
			end if;
		
			insert into pls_auditoria_grupo(nr_sequencia, nr_seq_auditoria, nr_seq_grupo,
				dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
				nm_usuario_nrec, nr_seq_ordem, ie_status,
				ie_manual)
			values (nextval('pls_auditoria_grupo_seq'), nr_seq_auditoria_w, nr_seq_grupo_w,
				clock_timestamp(), nm_usuario_p, clock_timestamp(),
				nm_usuario_p, nr_seq_fluxo_w, 'U',
				'N');
		end if;
		end;
	end loop;
	close C03;
	end;
end loop;
close C01;

open C02;
loop
fetch C02 into	
	nr_seq_mat_w,
	nr_seq_material_w,
	qt_solicitado_mat_w,
	vl_material_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin	
	select	nextval('pls_auditoria_item_seq')
	into STRICT	nr_seq_auditoria_item_w
	;
	
	select 	max(ie_tipo_despesa)
	into STRICT	ie_tipo_despesa_w
	from	pls_material
	where	nr_sequencia = nr_seq_material_w;
	
	insert into pls_auditoria_item(nr_sequencia, nr_seq_auditoria, qt_original,
		nr_seq_mat_origem, dt_atualizacao, nm_usuario,
		dt_atualizacao_nrec, nm_usuario_nrec, qt_ajuste,
		nr_seq_material, ie_status_solicitacao, ie_status,
		ie_tipo_despesa, vl_original)
	values (	nr_seq_auditoria_item_w, nr_seq_auditoria_w, qt_solicitado_mat_w,
		nr_seq_mat_w, clock_timestamp(), nm_usuario_p,
		clock_timestamp(), nm_usuario_p, qt_solicitado_mat_w,
		nr_seq_material_w, 'P', 'P',
		ie_tipo_despesa_w, vl_material_w);
	
	nr_seq_proc_w := null;
	open C03;
	loop
	fetch C03 into	
		nr_seq_grupo_w,
		nr_seq_fluxo_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin
		select	count(*)
		into STRICT	qt_grupo_w
		from	pls_auditoria_grupo
		where	nr_seq_auditoria 	= nr_seq_auditoria_w
		and	nr_seq_grupo 		= nr_seq_grupo_w;
		
		if (qt_grupo_w = 0) then
			select	count(*)
			into STRICT	qt_fluxo_w
			from	pls_auditoria_grupo
			where	nr_seq_auditoria 	= nr_seq_auditoria_w
			and	nr_seq_ordem 		= nr_seq_fluxo_w;
			
			if (qt_fluxo_w	> 0) then
				select	max(nr_seq_ordem) + 1
				into STRICT	nr_seq_ordem_atual_w
				from	pls_auditoria_grupo
				where	nr_seq_auditoria 	= nr_seq_auditoria_w;
				
				nr_seq_fluxo_w	:= nr_seq_ordem_atual_w;
			end if;
			
			insert into pls_auditoria_grupo(nr_sequencia, nr_seq_auditoria, nr_seq_grupo,
				dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
				nm_usuario_nrec, nr_seq_ordem, ie_status,
				ie_manual)
			values (nextval('pls_auditoria_grupo_seq'), nr_seq_auditoria_w, nr_seq_grupo_w,
				clock_timestamp(), nm_usuario_p, clock_timestamp(),
				nm_usuario_p, nr_seq_fluxo_w, 'U',
				'N');
		end if;
		end;
	end loop;
	close C03;
	end;
end loop;
close C02;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_gerar_auditoria_compl ( nr_seq_guia_p bigint, nr_seq_requisicao_p bigint, nm_usuario_p text) FROM PUBLIC;

