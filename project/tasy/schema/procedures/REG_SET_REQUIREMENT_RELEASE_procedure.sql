-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reg_set_requirement_release (nr_seq_requirement_p text, ie_requirement_type_p text, ie_release_p text, nm_usuario_p text) AS $body$
DECLARE


  nr_registros_w bigint;


BEGIN

  if (ie_requirement_type_p = 'C') then

    if (ie_release_p = 'S') then
    
      update reg_customer_requirement
         set dt_lancamento = clock_timestamp(), nm_usuario_lancamento = nm_usuario_p
       where nr_sequencia = nr_seq_requirement_p;

    else
    
      update reg_customer_requirement
         set dt_lancamento  = NULL, nm_usuario_lancamento  = NULL
       where nr_sequencia = nr_seq_requirement_p;

    end if;

  elsif (ie_requirement_type_p = 'P') then
  
    if (ie_release_p = 'S') then
    
      select count(*)
        into STRICT nr_registros_w
        from reg_funcao_pr
       where (cd_funcao IS NOT NULL AND cd_funcao::text <> '')
         and nr_seq_product_req = nr_seq_requirement_p;

      if (nr_registros_w > 0) then
      
        select count(*)
          into STRICT nr_registros_w
          from reg_caso_teste
         where nr_seq_product = nr_seq_requirement_p;

        if (nr_registros_w > 0) then
        
          update reg_product_requirement
             set dt_liberacao         = clock_timestamp(),
                 nm_usuario_liberacao = nm_usuario_p
           where nr_sequencia = nr_seq_requirement_p;

          reg_test_plan_pck.add_pendency('D',
                                         null,
                                         nr_seq_requirement_p,
                                         nm_usuario_p);

        else
          CALL wheb_mensagem_pck.exibir_mensagem_abort(1120124);
        end if;

      else
        CALL wheb_mensagem_pck.exibir_mensagem_abort(1026029);
      end if;
    else

      update reg_product_requirement
         set dt_liberacao  = NULL, nm_usuario_liberacao  = NULL
       where nr_sequencia = nr_seq_requirement_p;

    end if;
  end if;

  commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reg_set_requirement_release (nr_seq_requirement_p text, ie_requirement_type_p text, ie_release_p text, nm_usuario_p text) FROM PUBLIC;

