-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE proj_duplicar_cron_etapa ( nr_seq_cron_velha_p bigint, ie_tipo_duplic_cron_p text, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w	bigint;
nr_nova_etapa_w	bigint;
nr_seq_cron_novo_w	bigint;
qt_registro_w	bigint;

C01 CURSOR FOR
	SELECT	a.nr_sequencia
	from	proj_cron_etapa a
	where	a.nr_seq_cronograma = nr_seq_cron_velha_p
	order by	a.nr_sequencia;


BEGIN

select	count(*)
into STRICT	qt_registro_w
from	proj_cronograma
where	nr_sequencia = nr_seq_cron_velha_p;


if (qt_registro_w > 0) then

	select	nextval('proj_cronograma_seq')
	into STRICT	nr_seq_cron_novo_w
	;

	insert into proj_cronograma(	cd_empresa,
				cd_pessoa_cliente,
				ds_objetivo,
				dt_atualizacao,
				dt_inicio,
				ie_estrutura,
				nm_usuario,
				nr_sequencia,
				nr_seq_cliente,
				nr_seq_proj,
				ie_tipo_cronograma,
				ie_situacao)
			SELECT	cd_empresa,
				cd_pessoa_cliente,
				ds_objetivo,
				clock_timestamp(),
				clock_timestamp(),
				ie_estrutura,
				nm_usuario_p,
				nr_seq_cron_novo_w,
				nr_seq_cliente,
				nr_seq_proj,
				ie_tipo_cronograma,
				'A'
			from	proj_cronograma
			where	nr_sequencia = nr_seq_cron_velha_p;

	commit;

	open C01;
	loop
	fetch C01 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		select	nextval('proj_cron_etapa_seq')
		into STRICT	nr_nova_etapa_w
		;

		insert into proj_cron_etapa(	dt_atualizacao,		ie_fase,			ie_modulo,		nm_usuario,
					nr_seq_apres,		nr_seq_cronograma,		nr_sequencia,		pr_etapa,
					qt_hora_prev,		cd_classificacao,		cd_funcao,		ds_atividade,
					ds_etapa,			dt_ativacao,		dt_atualizacao_nrec,	dt_cadastro,
					dt_fim_prev,		dt_fim_real,		dt_final_multiplic,		dt_inicio_prev,
					dt_inicio_real,		dt_liberacao_etapa,		dt_piloto,		ie_aderencia,
					ie_atividade_adicional,	ie_cadastros,		ie_etapa_exec_desenv,	ie_milestone,
					ie_mpo,			ie_obrigatorio,		ie_parametrizacao,		ie_regra_ini_fim,
					ie_situacao,		ie_teste_piloto,		ie_tipo_ativ_met,		ie_tipo_obj_proj_migr,
                                                       		ie_virada,		nm_usuario_nrec,		nr_predecessora,
					nr_seq_estrutura,		nr_seq_etapa,		nr_seq_interno,		nr_seq_ordenacao,
					nr_seq_sub_proj,		nr_seq_superior,		pr_consultoria,		pr_prev_etapa,
					pr_previsto,		qt_hora_real,		qt_hora_saldo,		qt_horas_etapa_adic)
				SELECT	clock_timestamp(),			ie_fase,			ie_modulo,		nm_usuario_p,
					nr_seq_apres,		nr_seq_cron_novo_w,		nr_nova_etapa_w,		pr_etapa,
					qt_hora_prev,		cd_classificacao,		cd_funcao,		ds_atividade,
					ds_etapa,			dt_ativacao,		clock_timestamp(),			dt_cadastro,
					null,			null,			dt_final_multiplic,		null,
					null,			dt_liberacao_etapa,		dt_piloto,		ie_aderencia,
					ie_atividade_adicional,	ie_cadastros,		ie_etapa_exec_desenv,	ie_milestone,
					ie_mpo,			ie_obrigatorio,		ie_parametrizacao,		ie_regra_ini_fim,
					ie_situacao,		ie_teste_piloto,		ie_tipo_ativ_met,		ie_tipo_obj_proj_migr,
                                                       		ie_virada,		nm_usuario_p,		nr_predecessora,
					nr_seq_estrutura,		nr_seq_etapa,		nr_seq_interno,		nr_seq_ordenacao,
					nr_seq_sub_proj,		nr_sequencia,		pr_consultoria,		pr_prev_etapa,
					0,			0,			0,			qt_horas_etapa_adic
				from	proj_cron_etapa
				where	nr_sequencia = nr_sequencia_w;
		end;

		commit;
	end loop;
	close C01;

	update	proj_cron_etapa j
	set	j.nr_seq_superior =	( SELECT	max(b.nr_sequencia)
				from	proj_cron_etapa a,
					proj_cron_etapa d,
					proj_cron_etapa b
				where	a.nr_sequencia = d.nr_seq_superior
				and	a.nr_seq_superior = b.nr_seq_superior
				and	j.nr_sequencia = d.nr_sequencia
				and	a.nr_seq_cronograma = nr_seq_cron_velha_p
				and	d.nr_seq_cronograma = nr_seq_cron_novo_w
				and	b.nr_seq_cronograma = nr_seq_cron_novo_w)
	where	j.nr_seq_cronograma = nr_seq_cron_novo_w;
	commit;

	if (ie_tipo_duplic_cron_p = '1') then
		delete	from	proj_cron_etapa
			where	nr_seq_cronograma = nr_seq_cron_novo_w
			and	pr_etapa = 100;
		commit;
	end if;

	update	proj_cron_etapa
	set 	pr_etapa = 0
	where	nr_seq_cronograma = nr_seq_cron_novo_w;
	commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proj_duplicar_cron_etapa ( nr_seq_cron_velha_p bigint, ie_tipo_duplic_cron_p text, nm_usuario_p text) FROM PUBLIC;

