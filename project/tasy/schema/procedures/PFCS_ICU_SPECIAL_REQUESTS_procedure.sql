-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pfcs_icu_special_requests ( cd_establishment_p bigint, nm_user_p text) AS $body$
DECLARE


-- Cursors
---- Departments' names
c01_dpt CURSOR FOR
SELECT cd_setor_atendimento cd_unit,
    ds_setor_atendimento ds_unit,
    CASE WHEN ie_semi_intensiva='S' THEN  'SD'  ELSE cd_classif_setor END  cd_unit_classification
from setor_atendimento
where cd_classif_setor in ('3', '4')
    and ie_situacao = 'A'
    and cd_estabelecimento_base = cd_establishment_p;


pfcs_panel_seq_w        pfcs_panel.nr_sequencia%type;
qt_requests_w           numeric(20)  := 0;


BEGIN

for c01_w in c01_dpt loop
    select count(v.id_patient)
    into STRICT qt_requests_w
    from (
        SELECT distinct pp.id_patient id_patient
        from pfcs_panel_detail pd,
            pfcs_detail_patient pp,
            pfcs_detail_bed pb
        where  pp.nr_seq_detail = pd.nr_sequencia
            and pb.nr_seq_detail = pd.nr_sequencia
            and (pp.ds_special_request IS NOT NULL AND pp.ds_special_request::text <> '')
            and pd.nr_seq_indicator in (100, 94)
            and isnumber(pb.cd_department) = c01_w.cd_unit
    ) v;

     := pfcs_pck.pfcs_generate_results(
        ds_reference_value_p => c01_w.ds_unit, cd_reference_value_p => c01_w.cd_unit, cd_reference_aux_p => c01_w.cd_unit_classification, vl_indicator_p => qt_requests_w, nr_seq_indicator_p => 95, nr_seq_operational_level_p => cd_establishment_p, nm_usuario_p => nm_user_p, nr_seq_panel_p => pfcs_panel_seq_w);
end loop;

CALL pfcs_pck.pfcs_activate_records(
        nr_seq_indicator_p => 95,
        nr_seq_operational_level_p => cd_establishment_p,
        nm_usuario_p => nm_user_p);

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_icu_special_requests ( cd_establishment_p bigint, nm_user_p text) FROM PUBLIC;

