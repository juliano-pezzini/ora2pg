-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ohkis_obter_regra_estrategia ( nm_tabela_p text, nm_atributo_p text, nr_strategy_p bigint, ie_tipo_componente_p text, ie_retorno_p INOUT text ) AS $body$
DECLARE


ie_regra_w			varchar(1);
ds_atrib_regra_w	strategy_rule.ds_atrib_regra%TYPE;
ie_condicao_w		strategy_rule.ie_condicao%TYPE;
ds_comando_w		varchar(2000);
qt_verdade_w		smallint	:= 1;
ie_componente_w		strategy_rule.ie_componente%TYPE;



C01 CURSOR FOR
SELECT UPPER(ds_atrib_regra) ds_atrib_regra,
	   ie_condicao,
	   ie_componente
FROM   strategy_rule a
WHERE  nr_strategy = nr_strategy_p;


BEGIN

OPEN C01;
LOOP
FETCH C01 INTO
	ds_atrib_regra_w,
	ie_condicao_w,
	ie_componente_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	BEGIN

	ds_comando_w := 'select nvl(max(1),0) from TABELA_ATRIBUTO where nm_tabela = ' || '''' || nm_tabela_p  || '''' || ' and nm_atributo = ' || '''' || nm_atributo_p || '''' || ' and ' || ' nm_atributo ' || ie_condicao_w || ' ' || '''' || ds_atrib_regra_w || '''';

	IF (ie_componente_w = ie_tipo_componente_p) THEN
		qt_verdade_w := 1;
	ELSE
		qt_verdade_w := 0;
	END IF;

	IF (qt_verdade_w = 1) THEN
		EXIT;
	END IF;

	qt_verdade_w := Obter_valor_Dinamico(ds_comando_w, qt_verdade_w);

	IF (qt_verdade_w = 1) THEN
		EXIT;
	END IF;

	END;
END LOOP;
CLOSE C01;

SELECT	CASE WHEN qt_verdade_w=1 THEN 'S'  ELSE 'N' END
INTO STRICT	ie_regra_w
;

ie_retorno_p := ie_regra_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ohkis_obter_regra_estrategia ( nm_tabela_p text, nm_atributo_p text, nr_strategy_p bigint, ie_tipo_componente_p text, ie_retorno_p INOUT text ) FROM PUBLIC;

