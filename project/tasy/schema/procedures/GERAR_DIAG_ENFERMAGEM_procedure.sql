-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_diag_enfermagem ( nr_prescricao_p bigint, nr_seq_diag_p bigint, nm_usuario_p text, qt_pontuacao_p bigint default null, nr_seq_evolucao_diag_p bigint default null) AS $body$
DECLARE


    ie_situacao_w		            varchar(5);
    ie_diag_colab_cp_possible_diag  cp_possible_diag.ie_diag_colab%type;
    nr_ordenacao_pe_prescr_diag     pe_prescr_diag.nr_seq_ordenacao%type;
    ie_recorrencia_w                pe_prescr_diag.ie_recorrencia%type;
    cd_pessoa_fisica_w              pe_prescricao.cd_pessoa_fisica%type;
    dt_prescricao_w                 pe_prescricao.dt_prescricao%type;
    dt_inicio_prescr_w              pe_prescricao.dt_inicio_prescr%type;
    nr_prioridade_w                 pe_prescr_diag.nr_prioridade%TYPE := null;

BEGIN
    select	max(ie_situacao)
    into STRICT	ie_situacao_w
    from	pe_diagnostico
    where	nr_sequencia = nr_seq_diag_p;

    if (ie_situacao_w = 'A') then
        select  coalesce(max(ie_diag_colab),'N')
        into STRICT    ie_diag_colab_cp_possible_diag  
        from    cp_possible_diag
        where   nr_seq_diag = nr_seq_diag_p;

        nr_ordenacao_pe_prescr_diag := obter_num_ordenacao_diag( nr_prescricao_p, nr_seq_diag_p, ie_diag_colab_cp_possible_diag);

        select  cd_pessoa_fisica, dt_prescricao, dt_inicio_prescr
        into STRICT    cd_pessoa_fisica_w, dt_prescricao_w, dt_inicio_prescr_w 
        from    pe_prescricao
        where   nr_sequencia = nr_prescricao_p;

        ie_recorrencia_w := check_diagnosis_is_recurrence(cd_pessoa_fisica_w, nr_prescricao_p, nr_seq_diag_p);

        SELECT COUNT(1)+1 INTO STRICT nr_prioridade_w FROM pe_prescr_diag WHERE nr_seq_prescr = nr_prescricao_p;

        insert into pe_prescr_diag(
            nr_sequencia,
            dt_atualizacao,
            dt_start,
            nm_usuario,
            nr_seq_diag,
            nr_seq_prescr,
            qt_pontuacao,
            nr_seq_evolucao_diag,
            ie_diag_colab,
            nr_seq_ordenacao,
            ie_recorrencia,
            nr_prioridade)
        SELECT	nextval('pe_prescr_diag_seq'),
                dt_prescricao_w,
                dt_inicio_prescr_w,
                nm_usuario_p,
                nr_seq_diag_p,
                nr_prescricao_p,
                qt_pontuacao_p,
                nr_seq_evolucao_diag_p,
                ie_diag_colab_cp_possible_diag,
                nr_ordenacao_pe_prescr_diag,
                ie_recorrencia_w,
                nr_prioridade_w

        where	not exists (SELECT	1
                            from	pe_prescr_diag
                            where	nr_seq_prescr = nr_prescricao_p
                            and	    nr_seq_diag	= nr_seq_diag_p);

        if (obter_param_funcao_html5(281, 1614) = 'N') then
            CALL VINCULAR_DIAG_RESULTS(nr_seq_diag_p,nr_prescricao_p,nm_usuario_p);
        END IF;
                        
        commit;
    end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_diag_enfermagem ( nr_prescricao_p bigint, nr_seq_diag_p bigint, nm_usuario_p text, qt_pontuacao_p bigint default null, nr_seq_evolucao_diag_p bigint default null) FROM PUBLIC;

