-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_prod_financ_cartao_cr (nr_seq_movto_p bigint, nr_seq_classif_p bigint, nr_seq_produto_p bigint, nm_usuario_p text) AS $body$
DECLARE



cd_estabelecimento_w	bigint;
cd_cgc_w		varchar(14);
nr_seq_produto_w	bigint;
nr_seq_grupo_w		bigint;


BEGIN

if (coalesce(nr_seq_produto_p,0) > 0) then

	CALL atualizar_grupo_prod_financ(null,null,nr_seq_movto_p,null,nm_usuario_p,nr_seq_produto_p);

else

	select	max(cd_estabelecimento),
		max(cd_cgc)
	into STRICT	cd_estabelecimento_w,
		cd_cgc_w
	from	movto_cartao_cr a
	where	nr_sequencia	= nr_seq_movto_p;

	SELECT * FROM obter_produto_financeiro(cd_estabelecimento_w, null, cd_cgc_w, nr_seq_produto_w, null, null, nr_seq_grupo_w) INTO STRICT nr_seq_produto_w, nr_seq_grupo_w;

	if (nr_seq_produto_w IS NOT NULL AND nr_seq_produto_w::text <> '') and (coalesce(nr_seq_grupo_w::text, '') = '') then

		select	max(b.nr_seq_grupo_sup)
		into STRICT	nr_seq_grupo_w
		from	produto_financeiro a,
			grupo_prod_financ b
		where	b.nr_sequencia	= a.nr_seq_grupo
		and	a.nr_sequencia	= nr_seq_produto_w;
	end if;

	if (nr_seq_produto_w IS NOT NULL AND nr_seq_produto_w::text <> '') then

		update	movto_cartao_cr_classif
		set	nr_seq_produto	= nr_seq_produto_w,
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp()
		where	nr_seq_movto	= nr_seq_movto_p
		and	nr_sequencia	= nr_seq_classif_p;
	end if;

	if (nr_seq_grupo_w IS NOT NULL AND nr_seq_grupo_w::text <> '') then

		update	movto_cartao_cr
		set	nr_seq_grupo_prod	= nr_seq_grupo_w,
			nm_usuario		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp()
		where	nr_sequencia		= nr_seq_movto_p;
	end if;

	commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_prod_financ_cartao_cr (nr_seq_movto_p bigint, nr_seq_classif_p bigint, nr_seq_produto_p bigint, nm_usuario_p text) FROM PUBLIC;

