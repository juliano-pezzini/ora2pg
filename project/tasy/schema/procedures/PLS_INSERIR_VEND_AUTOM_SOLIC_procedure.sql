-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inserir_vend_autom_solic ( nr_seq_solicitacao_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_commit_p text) AS $body$
DECLARE


nr_seq_regra_w			bigint;
nr_seq_vendedor_w		bigint;
qt_vendedor_w			bigint;
qt_dias_efetivacao_w		bigint;
ie_gerar_vendedor_w		varchar(1);
ie_atualizar_etapa_w		varchar(1);
ie_vincular_canal_sem_escala_w	varchar(1);
ie_gerar_logado_vendedor_w	varchar(10);
nr_seq_vendedor_vinculado_w	bigint;
ie_tipo_vendedor_w		varchar(2);
nr_seq_regra_dias_l_w		bigint;
ie_tipo_contratacao_w		varchar(2);
qt_vidas_w			bigint;
nr_seq_classificacao_w		bigint;

C01 CURSOR FOR
	SELECT	max(nr_sequencia)
	from	pls_solicitacao_regra_vend
	where	ie_tipo_canal_venda	= ie_tipo_vendedor_w
	and	((coalesce(nr_seq_classificacao,nr_seq_classificacao_w)	= nr_seq_classificacao_w
	and	(nr_seq_classificacao IS NOT NULL AND nr_seq_classificacao::text <> ''))
	or	coalesce(nr_seq_classificacao::text, '') = '')
	and	((coalesce(ie_tipo_contratacao,ie_tipo_contratacao_w)	= ie_tipo_contratacao_w
	and	(ie_tipo_contratacao IS NOT NULL AND ie_tipo_contratacao::text <> '')) 
	or	coalesce(ie_tipo_contratacao::text, '') = '')
	and (ie_aplicacao_regra	= 'L'
	or	ie_aplicacao_regra	= 'A')
	and	ie_situacao		= 'A'
	and	((qt_vidas_w between coalesce(qt_vidas,0) and coalesce(qt_vidas_final,qt_vidas_w) and (qt_vidas_w IS NOT NULL AND qt_vidas_w::text <> ''))
	or (coalesce(qt_vidas_w::text, '') = ''))
	order by ie_tipo_contratacao,coalesce(qt_vidas,0);


BEGIN

ie_gerar_vendedor_w		:= coalesce(obter_valor_param_usuario(1237, 20, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_p), 'N');
ie_gerar_logado_vendedor_w	:= coalesce(obter_valor_param_usuario(1237, 55, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_p), 'S');
ie_atualizar_etapa_w		:= 'S';
ie_vincular_canal_sem_escala_w	:= coalesce(obter_valor_param_usuario(1237, 53, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_p), 'N');

select	count(*)
into STRICT	qt_vendedor_w
from	pls_solicitacao_vendedor
where	nr_seq_solicitacao	= nr_seq_solicitacao_p
and	cd_estabelecimento	= cd_estabelecimento_p;


if (qt_vendedor_w = 0) then
	select	coalesce(max(nr_sequencia),0)		
	into STRICT	nr_seq_vendedor_w	
	from	pls_vendedor
	where	cd_pessoa_fisica = cd_pessoa_fisica_p
	and	cd_estabelecimento	= cd_estabelecimento_p
	and	ie_situacao = 'A'
	and	clock_timestamp() between coalesce(dt_inicio_vigencia,clock_timestamp()) and fim_dia(coalesce(dt_fim_vigencia,clock_timestamp()));
	
	if (nr_seq_vendedor_w = 0) then
		select	coalesce(max(b.nr_sequencia),0)
		into STRICT	nr_seq_vendedor_w
		from	pls_vendedor		b,
			pls_vendedor_vinculado	a
		where	a.nr_seq_vendedor	= b.nr_sequencia
		and	a.cd_pessoa_fisica	= cd_pessoa_fisica_p
		and	b.cd_estabelecimento	= cd_estabelecimento_p
		and	a.ie_situacao = 'A'
		and	b.ie_situacao = 'A'
		and	clock_timestamp() between coalesce(b.dt_inicio_vigencia,clock_timestamp()) and fim_dia(coalesce(b.dt_fim_vigencia,clock_timestamp()));
		
		if (nr_seq_vendedor_w	<> 0) then
			select	max(a.nr_sequencia)
			into STRICT	nr_seq_vendedor_vinculado_w
			from	pls_vendedor_vinculado	a
			where	a.nr_seq_vendedor	= nr_seq_vendedor_w
			and	a.cd_pessoa_fisica	= cd_pessoa_fisica_p
			and	a.ie_situacao = 'A';
		end if;
	end if;
	
	if (nr_seq_vendedor_w <> 0) and (ie_gerar_logado_vendedor_w = 'S') then
		
		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_regra_w
		from	pls_solicitacao_regra_aten
		where	nr_seq_vendedor	= nr_seq_vendedor_w
		and	ie_situacao = 'A'
		and (ie_escala = 'S' or ie_vincular_canal_sem_escala_w = 'S')
		and	clock_timestamp() between coalesce(dt_inicio_vigencia,clock_timestamp()) and fim_dia(dt_fim_vigencia)
		and	cd_estabelecimento	= cd_estabelecimento_p;
		
		if (nr_seq_regra_w <> 0) then
			select	nr_seq_classificacao,
				ie_tipo_contratacao,
				coalesce(qt_funcionarios, 0)
			into STRICT	nr_seq_classificacao_w,
				ie_tipo_contratacao_w,
				qt_vidas_w
			from	pls_solicitacao_comercial
			where	nr_sequencia	= nr_seq_solicitacao_p;
			
			select	CASE WHEN coalesce(cd_pessoa_fisica::text, '') = '' THEN 'PJ'  ELSE 'PF' END
			into STRICT	ie_tipo_vendedor_w
			from	pls_vendedor
			where	nr_sequencia = nr_seq_vendedor_w;
			
			open C01;
			loop
			fetch C01 into
				nr_seq_regra_dias_l_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				begin
				nr_seq_regra_dias_l_w	:= nr_seq_regra_dias_l_w;
				end;
			end loop;
			close C01;
			
			if ( nr_seq_regra_dias_l_w <> 0 and (nr_seq_regra_dias_l_w IS NOT NULL AND nr_seq_regra_dias_l_w::text <> '')) then
				select	qt_dias_efetivacao
				into STRICT	qt_dias_efetivacao_w
				from	pls_solicitacao_regra_vend
				where	nr_sequencia	= nr_seq_regra_dias_l_w;
			elsif (nr_seq_regra_dias_l_w = 0 or coalesce(nr_seq_regra_dias_l_w::text, '') = '') then
				qt_dias_efetivacao_w := 0;
			end if;
			
			update	pls_solicitacao_vendedor
			set	dt_fim_vigencia	= clock_timestamp()
			where	nr_seq_solicitacao = nr_seq_solicitacao_p
			and	coalesce(dt_fim_vigencia::text, '') = ''
			and	cd_estabelecimento	= cd_estabelecimento_p;
			
			insert into pls_solicitacao_vendedor(	nr_sequencia,
								cd_estabelecimento,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								nr_seq_solicitacao,
								nr_seq_vendedor_canal,
								dt_inicio_vigencia,
								dt_fim_vigencia,
								nr_seq_cliente,
								qt_dias_efetivacao,
								nr_seq_vendedor_vinculado)
							values (nextval('pls_solicitacao_vendedor_seq'),
								cd_estabelecimento_p,
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								nr_seq_solicitacao_p,
								nr_seq_vendedor_w,
								clock_timestamp(),
								null,
								null,
								qt_dias_efetivacao_w,
								nr_seq_vendedor_vinculado_w);
			
			update	pls_solicitacao_comercial
			set	dt_efetivacao	= clock_timestamp() + qt_dias_efetivacao_w
			where	nr_sequencia	= nr_seq_solicitacao_p;
			
			CALL pls_atualizar_atividades_canal(nr_seq_solicitacao_p,null,'N',nm_usuario_p);
		end if;
	elsif (ie_gerar_vendedor_w = 'S') then
		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_regra_w
		from	pls_solicitacao_regra_aten
		where	ie_situacao = 'A'
		and (ie_escala = 'S' or ie_vincular_canal_sem_escala_w = 'S')
		and	cd_estabelecimento	= cd_estabelecimento_p
		and	clock_timestamp() between coalesce(dt_inicio_vigencia,clock_timestamp()) and fim_dia(dt_fim_vigencia)
		and	dt_solicitacao	= (	SELECT	min(coalesce(dt_solicitacao,to_date('01/01/1900','dd/mm/rrrr')))
						from	pls_solicitacao_regra_aten
						where	ie_situacao	= 'A'
						and	clock_timestamp() between coalesce(dt_inicio_vigencia,clock_timestamp()) and fim_dia(dt_fim_vigencia)
						and (ie_escala = 'S' or ie_vincular_canal_sem_escala_w = 'S')
						and	cd_estabelecimento	= cd_estabelecimento_p);
		
		if (nr_seq_regra_w <> 0) then
			CALL pls_vincular_vendedor_solic(nr_seq_solicitacao_p, nr_seq_regra_w, 2, ie_atualizar_etapa_w,'N', nm_usuario_p, cd_estabelecimento_p);
		end if;
	end if;
	
	if (ie_atualizar_etapa_w = 'S') then
		CALL pls_atualiza_etapa_solicitacao(nr_seq_solicitacao_p, nm_usuario_p);
	end if;
end if;

if (coalesce(ie_commit_p,'S') = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inserir_vend_autom_solic ( nr_seq_solicitacao_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_commit_p text) FROM PUBLIC;

