-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_sus_atividade () AS $body$
DECLARE



cd_procedimento_w		bigint;
ie_origem_proced_w	bigint;
qt_registros_w		bigint;
ie_especialidade_aih_w	smallint;
cd_atividade_prof_bpa_w	smallint;
qt_ativid_diferente_w	integer;


C01 CURSOR FOR
SELECT	cd_procedimento,
		ie_origem_proced
from		procedimento
where		ie_origem_proced 		= 2
and		ie_situacao			= 'A'
and		coalesce(ie_especialidade_aih::text, '') = '';

C011 CURSOR FOR
SELECT	count(*),
		ie_especialidade_aih
from		sus_aih
where		cd_procedimento_solic	= cd_procedimento_w
and		ie_origem_proced		= ie_origem_proced_w
and		dt_emissao			> clock_timestamp() - interval '365 days'
and		(ie_especialidade_aih IS NOT NULL AND ie_especialidade_aih::text <> '')
group by	ie_especialidade_aih
order	by	1;


C02 CURSOR FOR
SELECT	cd_procedimento,
		ie_origem_proced
from		procedimento
where		ie_origem_proced 		= 3
and		ie_situacao			= 'A'
and		coalesce(cd_atividade_prof_bpa::text, '') = '';

C021 CURSOR FOR
SELECT	count(*),
		a.cd_atividade_prof_bpa
from		procedimento_paciente a
where		a.cd_procedimento		= cd_procedimento_w
and		a.ie_origem_proced		= ie_origem_proced_w
and		a.dt_procedimento		> clock_timestamp() - interval '365 days'
and		(a.cd_atividade_prof_bpa IS NOT NULL AND a.cd_atividade_prof_bpa::text <> '')
and exists (	select 1 from sus_atividade_prof_proc b
				where b.cd_procedimento			= a.cd_procedimento
				and	b.ie_origem_proced		= a.ie_origem_proced
				and	b.cd_atividade_profissional	= a.cd_atividade_prof_bpa)
group by	a.cd_atividade_prof_bpa
order	by	1;




BEGIN
/* Inicializa dados na procedimento */

update procedimento
set	 ie_ativ_prof_bpa = 'N'
where	 coalesce(ie_ativ_prof_bpa::text, '') = '';
commit;

/* Define especialidade padrão da AIH */

OPEN C01;
LOOP
FETCH C01 into	cd_procedimento_w,
			ie_origem_proced_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	OPEN C011;
	LOOP
	FETCH C011 into	qt_registros_w,
				ie_especialidade_aih_w;
	EXIT WHEN NOT FOUND; /* apply on C011 */
		begin
		if (qt_registros_w	> 0) then
			begin
			update procedimento
			set	 ie_especialidade_aih	= ie_especialidade_aih_w
			where	 cd_procedimento		= cd_procedimento_w
			and	 ie_origem_proced		= ie_origem_proced_w;
			exception
	      		 when others then
	           		 qt_registros_w := qt_registros_w;
			end;
		end if;
		end;
	END LOOP;
	close c011;
	commit;
	end;
END LOOP;
close c01;


/* Define atividade profissional padrão do BPA */

qt_registros_w	:= 0;
OPEN C02;
LOOP
FETCH C02 into	cd_procedimento_w,
			ie_origem_proced_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	qt_ativid_diferente_w	:= 0;
	OPEN C021;
	LOOP
	FETCH C021 into	qt_registros_w,
				cd_atividade_prof_bpa_w;
	EXIT WHEN NOT FOUND; /* apply on C021 */
		begin
		if (qt_registros_w	> 0) then
			begin
			qt_ativid_diferente_w	:= qt_ativid_diferente_w + 1;
			update procedimento
			set	 cd_atividade_prof_bpa	= cd_atividade_prof_bpa_w,
				 ie_ativ_prof_bpa		= 'P'
			where	 cd_procedimento		= cd_procedimento_w
			and	 ie_origem_proced		= ie_origem_proced_w;
			exception
	      		 when others then
	           		 qt_registros_w := qt_registros_w;
			end;
		end if;
		end;
	END LOOP;
	close c021;
	if (qt_ativid_diferente_w	= 1) then
		begin
		update procedimento
		set	 ie_ativ_prof_bpa		= 'E'
		where	 cd_procedimento		= cd_procedimento_w
		and	 ie_origem_proced		= ie_origem_proced_w;
		exception
	      	 when others then
	      	 qt_registros_w := qt_registros_w;
		end;
	end if;
	commit;
	end;
END LOOP;
close c02;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_sus_atividade () FROM PUBLIC;

