-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alterar_conta ( nr_seq_segurado_p bigint, nr_seq_prestador_exec_p bigint, nr_seq_prestador_solic_p bigint, ie_carater_internacao_p text, nr_seq_saida_int_p bigint, ie_obito_mulher_p text, qt_nasc_mortos_p bigint, qt_nasc_vivos_termo_p bigint, qt_nasc_vivos_prematuros_p bigint, qt_obito_precoce_p bigint, qt_obito_tardio_p bigint, cd_doenca_p text, nr_declaracao_obito_p text, ie_tipo_guia_p text, nr_seq_clinica_p bigint, ie_regime_internacao_p text, ie_indicacao_acidente_p text, nr_seq_tipo_acomodacao_p bigint, nr_seq_saida_spsadt_p bigint, nr_seq_tipo_atendimento_p bigint, ie_tipo_doenca_p text, nr_seq_saida_consulta_p bigint, ie_tipo_consulta_p text, nr_seq_conta_p bigint, cd_estabelecimento_p bigint, dt_atendimento_p text, dt_entrada_p text, dt_alta_p text, cd_senha_externa_p text, cd_senha_p text, cd_medico_executor_p bigint, cd_medico_solicitante_p bigint, cd_doenca_alta_p text, ds_indicacao_clinica_p text, nr_seq_cbo_saude_p bigint, nr_seq_cbo_saude_solic_p bigint, nr_seq_grau_partic_p bigint, nm_usuario_p text, ds_observacao_p text, ie_gestacao_p text, ie_aborto_p text, ie_parto_normal_p text, ie_complicacao_puerperio_p text, ie_complicacao_neonatal_p text, ie_parto_cesaria_p text, ie_baixo_peso_p text, ie_atend_rn_sala_parto_p text, ie_transtorno_p text, ie_origem_conta_p text, nr_seq_analise_p bigint, nr_seq_grupo_p bigint, nr_seq_tipo_conta_p pls_conta.nr_seq_tipo_conta%type, ie_reconsistir_p text, cd_guia_p pls_conta.cd_guia%type, cd_guia_referencia_p pls_conta.cd_guia_referencia%type, cd_guia_prestador_p pls_conta.cd_guia_prestador%type, ie_cobertura_especial_p pls_conta.ie_cobertura_especial%type default null, ie_regime_atendimento_p pls_conta.ie_regime_atendimento%type default null, ie_saude_ocupacional_p pls_conta.ie_saude_ocupacional%type default null) AS $body$
DECLARE

					
/*
ie_origem_conta_p
Define a origem da alteracao se sera OPS - Gestao de contas medicas ou OPS - Analise de conta medicas impacta somente na gravacao do log
A - Analise
C  - Conta medica
*/
					

ds_observacao_w			varchar(4000) := '';
nr_seq_segurado_w		pls_conta.nr_seq_segurado%type;
nr_seq_prestador_exec_w		pls_conta.nr_seq_prestador_exec%type;
nr_seq_prestador_solic_w	pls_conta.nr_seq_prestador%type;
ie_carater_internacao_w		pls_conta.ie_carater_internacao%type;
nr_seq_saida_int_w		pls_conta.nr_seq_saida_int%type;
ie_obito_mulher_w		pls_conta.ie_obito_mulher%type;
qt_nasc_mortos_w		pls_conta.qt_nasc_mortos%type;
qt_nasc_vivos_termo_w		pls_conta.qt_nasc_vivos_termo%type;
qt_nasc_vivos_prematuros_w	pls_conta.qt_nasc_vivos_prematuros%type;
qt_obito_precoce_w		pls_conta.qt_obito_precoce%type;
qt_obito_tardio_w		pls_conta.qt_obito_tardio%type;
cd_doenca_w			varchar(10);
ie_tipo_guia_w			pls_conta.ie_tipo_guia%type;
nr_seq_clinica_w		pls_conta.nr_seq_clinica%type;
ie_regime_internacao_w		pls_conta.ie_regime_internacao%type;
ie_indicacao_acidente_w		pls_conta.ie_indicacao_acidente%type;
nr_seq_tipo_acomodacao_w	pls_conta.nr_seq_tipo_acomodacao%type;
nr_seq_saida_spsadt_w		pls_conta.nr_seq_saida_spsadt%type;
nr_seq_tipo_atendimento_w	pls_conta.nr_seq_tipo_atendimento%type;
ie_tipo_doenca_w		pls_conta.ie_tipo_doenca%type;
nr_seq_saida_consulta_w		pls_conta.nr_seq_saida_consulta%type;
ie_tipo_consulta_w		pls_conta.ie_tipo_consulta%type;
nm_segurado_w			varchar(255);
cd_usuario_plano_w		varchar(255);
nm_prestador_exec_w		varchar(255);
nm_segurado_ww			varchar(255);
cd_usuario_plano_ww		varchar(255);
nm_prestador_exec_ww		varchar(255);
nr_seq_protocolo_alt_w		bigint;
nr_seq_diagostico_w		pls_diagnostico_conta.nr_sequencia%type;
dt_atendimento_w		timestamp;
dt_entrada_w			timestamp;
dt_alta_w			timestamp;
dt_atendimento_ww		pls_conta.dt_atendimento%type;
dt_entrada_ww			pls_conta.dt_entrada%type;
dt_alta_ww			pls_conta.dt_alta%type;
cd_doenca_alta_w		varchar(20);
cd_senha_externa_w		pls_conta.cd_senha_externa%type;
cd_senha_w			pls_conta.cd_senha%type;
cd_medico_executor_w		pls_conta.cd_medico_executor%type;
cd_medico_solicitante_w		pls_conta.cd_medico_solicitante%type;
ds_indicacao_clinica_w		pls_conta.ds_indicacao_clinica%type;
nr_seq_cbo_saude_w		pls_conta.nr_seq_cbo_saude%type;
nr_seq_cbo_saude_solic_w	pls_conta.nr_seq_cbo_saude_solic%type;
ds_observacao_ww		pls_conta.ds_observacao%type;
nm_medico_executor_w		varchar(255);
nm_medico_executor_ww		varchar(255);
nm_medico_solic_w		varchar(255);
nm_medico_solic_ww		varchar(255);
ie_gestacao_w			pls_conta.ie_gestacao%type;
ie_aborto_w			pls_conta.ie_aborto%type;
ie_parto_normal_w		pls_conta.ie_parto_normal%type;
ie_complicacao_puerperio_w	pls_conta.ie_complicacao_puerperio%type;
ie_complicacao_neonatal_w	pls_conta.ie_complicacao_neonatal%type;
ie_parto_cesaria_w		pls_conta.ie_parto_cesaria%type;
ie_baixo_peso_w			pls_conta.ie_baixo_peso%type;
ie_atend_rn_sala_parto_w	pls_conta.ie_atend_rn_sala_parto%type;
ie_transtorno_w			pls_conta.ie_transtorno%type;
nr_seq_grau_partic_w		pls_conta.nr_seq_grau_partic%type;
nr_seq_tipo_conta_w		pls_conta.nr_seq_tipo_conta%type;
cd_guia_w			pls_conta.cd_guia%type;
cd_guia_ref_w			pls_conta.cd_guia_referencia%type;
cd_guia_prestador_w		pls_conta.cd_guia_prestador%type;
cd_guia_ww			pls_conta.cd_guia%type;
cd_guia_ref_ww			pls_conta.cd_guia_referencia%type;
cd_guia_prestador_ww		pls_conta.cd_guia_prestador%type;
ie_cobertura_especial_w	pls_conta.ie_cobertura_especial%type;
ie_regime_atendimento_w	pls_conta.ie_regime_atendimento%type;
ie_saude_ocupacional_w	pls_conta.ie_saude_ocupacional%type;



BEGIN

if (coalesce(ie_tipo_guia_p, 0) = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(179964);
	--'Por favor insira um tipo guia valido.'
end if;

if (coalesce(nr_seq_segurado_p, 0) = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(179965);	
	--'Por favor insira um beneficiario valido.'
end if;

begin
dt_atendimento_w := to_date(dt_atendimento_p,'dd/mm/yyyy hh24:mi:ss');
exception
when others then
	begin
	dt_atendimento_w := to_date(substr(dt_atendimento_p,1,10),'dd/mm/yyyy');
	exception
	when others then
		dt_atendimento_w := null;
	end;
end;

begin
dt_entrada_w := to_date(dt_entrada_p,'dd/mm/yyyy hh24:mi:ss');
exception
when others then
	begin
	dt_entrada_w := to_date(substr(dt_entrada_p,1,10),'dd/mm/yyyy');
	exception
	when others then
		dt_entrada_w := null;
	end;
end;

begin
dt_alta_w := to_date(dt_alta_p,'dd/mm/yyyy hh24:mi:ss');
exception
when others then
	begin
	dt_alta_w := to_date(substr(dt_alta_p,1,10),'dd/mm/yyyy');
	exception
	when others then
		dt_alta_w := null;
	end;
end;

select	nr_seq_segurado,
	nr_seq_prestador_exec,
	nr_seq_prestador,
	qt_nasc_mortos,
	qt_nasc_vivos_termo,
	qt_nasc_vivos_prematuros,
	qt_obito_precoce,
	qt_obito_tardio,
	nr_seq_saida_int,
	nr_seq_tipo_acomodacao,
	nr_seq_saida_spsadt,
	nr_seq_tipo_atendimento,
	nr_seq_clinica,
	nr_seq_saida_consulta,
	ie_carater_internacao,
	ie_obito_mulher,
	ie_tipo_guia,
	ie_regime_internacao,
	ie_indicacao_acidente,
	ie_tipo_doenca,
	ie_tipo_consulta,
	dt_atendimento,
	dt_entrada,
	dt_alta,
	cd_senha_externa,
	cd_senha,
	cd_medico_executor,
	cd_medico_solicitante,
	ds_indicacao_clinica,
	nr_seq_cbo_saude,
	nr_seq_cbo_saude_solic,
	ds_observacao,
	ie_gestacao,
	ie_aborto,
	ie_parto_normal,
	ie_complicacao_puerperio,
	ie_complicacao_neonatal,
	ie_parto_cesaria,
	ie_baixo_peso,
	ie_atend_rn_sala_parto,
	ie_transtorno,
	nr_seq_grau_partic,
	nr_seq_tipo_conta,
	cd_guia,
	cd_guia_referencia,
	cd_guia_prestador,
	ie_cobertura_especial,
	ie_regime_atendimento,
	ie_saude_ocupacional
into STRICT	nr_seq_segurado_w,
	nr_seq_prestador_exec_w,
	nr_seq_prestador_solic_w,
	qt_nasc_mortos_w,
	qt_nasc_vivos_termo_w,
	qt_nasc_vivos_prematuros_w,
	qt_obito_precoce_w,
	qt_obito_tardio_w,
	nr_seq_saida_int_w,
	nr_seq_tipo_acomodacao_w,
	nr_seq_saida_spsadt_w,
	nr_seq_tipo_atendimento_w,
	nr_seq_clinica_w,
	nr_seq_saida_consulta_w,
	ie_carater_internacao_w,
	ie_obito_mulher_w,
	ie_tipo_guia_w,
	ie_regime_internacao_w,
	ie_indicacao_acidente_w,
	ie_tipo_doenca_w,
	ie_tipo_consulta_w,
	dt_atendimento_ww,
	dt_entrada_ww,
	dt_alta_ww,
	cd_senha_externa_w,
	cd_senha_w,
	cd_medico_executor_w,
	cd_medico_solicitante_w,
	ds_indicacao_clinica_w,
	nr_seq_cbo_saude_w,
	nr_seq_cbo_saude_solic_w,
	ds_observacao_ww,
	ie_gestacao_w,
	ie_aborto_w,
	ie_parto_normal_w,
	ie_complicacao_puerperio_w,
	ie_complicacao_neonatal_w,
	ie_parto_cesaria_w,
	ie_baixo_peso_w,
	ie_atend_rn_sala_parto_w,
	ie_transtorno_w,
	nr_seq_grau_partic_w,
	nr_seq_tipo_conta_w,
	cd_guia_w,
	cd_guia_ref_w,
	cd_guia_prestador_w,
	ie_cobertura_especial_w,
	ie_regime_atendimento_w,
	ie_saude_ocupacional_w
from	pls_conta
where	nr_sequencia	= nr_seq_conta_p;

nm_segurado_w		:= pls_obter_dados_segurado(nr_seq_segurado_p, 'N');
cd_usuario_plano_w	:= pls_obter_dados_segurado(nr_seq_segurado_p, 'C');
nm_prestador_exec_w	:= pls_obter_dados_prestador(nr_seq_prestador_exec_p, 'N');

nm_segurado_ww		:= pls_obter_dados_segurado(nr_seq_segurado_w, 'N');
cd_usuario_plano_ww	:= pls_obter_dados_segurado(nr_seq_segurado_w, 'C');
nm_prestador_exec_ww	:= pls_obter_dados_prestador(nr_seq_prestador_exec_w, 'N');

if (cd_guia_w IS NOT NULL AND cd_guia_w::text <> '') and (coalesce(cd_guia_p::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(452202); --Nao e possivel apagar o codigo de guia, guia referencia ou guia prestador.
else
	cd_guia_ww := cd_guia_p;
end if;

if (ie_tipo_guia_w not in ('3','11')) then
	if (cd_guia_ref_w IS NOT NULL AND cd_guia_ref_w::text <> '') and (coalesce(cd_guia_referencia_p::text, '') = '') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(452202); --Nao e possivel apagar o codigo de guia, guia referencia ou guia prestador.
	else
		cd_guia_ref_ww := cd_guia_referencia_p;
	end if;
end if;

if (cd_guia_prestador_w IS NOT NULL AND cd_guia_prestador_w::text <> '') and (coalesce(cd_guia_prestador_p::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(452202); --Nao e possivel apagar o codigo de guia, guia referencia ou guia prestador.
else
	cd_guia_prestador_ww := cd_guia_prestador_p;
end if;

if (ie_tipo_guia_w = '6') then
	update	pls_conta
	set	nr_seq_prestador_exec		= nr_seq_prestador_exec_p,
		nr_seq_segurado			= nr_seq_segurado_p,
		cd_medico_executor		= cd_medico_executor_p,
		nr_seq_cbo_saude		= nr_seq_cbo_saude_p,	
		nr_seq_tipo_acomodacao		= nr_seq_tipo_acomodacao_p,
		nr_seq_grau_partic		= nr_seq_grau_partic_p,
		nr_seq_tipo_conta		= nr_seq_tipo_conta_p,
		cd_senha			= cd_senha_p,
		cd_guia				= cd_guia_ww,
		cd_guia_referencia		= cd_guia_ref_ww,
		cd_guia_prestador		= cd_guia_prestador_ww
	where	nr_sequencia			= nr_seq_conta_p;
	
	if (coalesce(nr_seq_prestador_exec_p,0) <> coalesce(nr_seq_prestador_exec_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Prestador executor: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_dados_prestador(nr_seq_prestador_exec_w,'N')||' - Modificado: '||pls_obter_dados_prestador(nr_seq_prestador_exec_p,'N')||chr(13)||chr(10);
	end if;
	
	if (coalesce(cd_medico_executor_p,0) <> coalesce(cd_medico_executor_w,0)) then			
	
		if (coalesce(cd_medico_executor_w,0) <> 0) then
			nm_medico_executor_w	:= obter_nome_medico(cd_medico_executor_w,'N');
		else
			nm_medico_executor_w	:= '          ';
		end if;
		
		if (coalesce(cd_medico_executor_p,0) <> 0) then
			nm_medico_executor_ww	:= obter_nome_medico(cd_medico_executor_p,'N');
		else
			nm_medico_executor_ww	:= '          ';
		end if;			
		
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Profissional executor: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||nm_medico_executor_w||' - Modificado: '||nm_medico_executor_ww||chr(13)||chr(10);
	end if;
	
	if (coalesce(nr_seq_cbo_saude_p,0) <> coalesce(nr_seq_cbo_saude_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'CBO executor: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||substr(obter_codigo_cbo_saude(nr_seq_cbo_saude_w),1,15)||' - '||substr(obter_cbo_saude(nr_seq_cbo_saude_w),1,80)||' - Modificado: '||substr(obter_codigo_cbo_saude(nr_seq_cbo_saude_p),1,15)||' - '||substr(obter_cbo_saude(nr_seq_cbo_saude_p),1,80)||chr(13)||chr(10);
	end if;
	
	if (coalesce(nr_seq_tipo_acomodacao_p,0) <> coalesce(nr_seq_tipo_acomodacao_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Acomodacao: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_desc_tipo_acomodacao(nr_seq_tipo_acomodacao_w)||' - Modificado: '||pls_obter_desc_tipo_acomodacao(nr_seq_tipo_acomodacao_p)||chr(13)||chr(10);
	end if;
	
	if (coalesce(nr_seq_grau_partic_p,0) <> coalesce(nr_seq_grau_partic_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Grau de participacao: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_ds_grau_participacao(nr_seq_grau_partic_w)||' - Modificado: '||pls_obter_ds_grau_participacao(nr_seq_grau_partic_p)||chr(13)||chr(10);
	end if;
	
	if (coalesce(nr_seq_tipo_conta_p,0) <> coalesce(nr_seq_tipo_conta_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Tipo conta: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||nr_seq_tipo_conta_w||' - Modificado: '||nr_seq_tipo_conta_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(cd_senha_p,'X') <> coalesce(cd_senha_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Senha: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_senha_w||' - Modificado: '||cd_senha_p||chr(13)||chr(10);
	end if;	
	
	if (coalesce(cd_guia_ww,'X') <> coalesce(cd_guia_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Guia: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_guia_w||' - Modificado: '||cd_guia_ww||chr(13)||chr(10);
	end if;	
	
	if (coalesce(cd_guia_ref_ww,'X') <> coalesce(cd_guia_ref_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Guia referencia: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_guia_ref_w||' - Modificado: '||cd_guia_ref_ww||chr(13)||chr(10);
	end if;
	
	if (coalesce(cd_guia_prestador_ww,'X') <> coalesce(cd_guia_prestador_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Guia prestador: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_guia_prestador_w||' - Modificado: '||cd_guia_prestador_ww||chr(13)||chr(10);
	end if;

elsif (ie_tipo_guia_w = '5') then
	
	if (coalesce(cd_doenca_alta_p, 'X') <> 'X') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_diagostico_w
		from	pls_diagnostico_conta	
		where	ie_classificacao		= 'P'
		and	nr_seq_conta			= nr_seq_conta_p;

		select	max(cd_doenca)
		into STRICT	cd_doenca_alta_w
		from	pls_diagnostico_conta	
		where	nr_sequencia			= nr_seq_diagostico_w;

		if (coalesce(nr_seq_diagostico_w,0) > 0) then
			update	pls_diagnostico_conta
			set	cd_doenca			= cd_doenca_alta_p
			where	nr_sequencia			= nr_seq_diagostico_w;
		else
			insert into pls_diagnostico_conta(cd_doenca, ds_diagnostico, dt_atualizacao,
				dt_atualizacao_nrec, ie_classificacao, ie_estagio_complemento,
				ie_indicacao_acidente, ie_tipo_doenca, nm_usuario,
				nm_usuario_nrec, nr_seq_conta, nr_sequencia)
			values (cd_doenca_alta_p, '', clock_timestamp(),
				 clock_timestamp(), 'P', null,
				 null, null, nm_usuario_p,
				 nm_usuario_p, nr_seq_conta_p, nextval('pls_diagnostico_conta_seq'));	
		end if;
	end if;
	
	if (coalesce(nr_declaracao_obito_p,'X') <> 'X') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_diagostico_w
		from	pls_diagnost_conta_obito	
		where	nr_seq_conta			= nr_seq_conta_p;
		
		select	max(cd_doenca)
		into STRICT	cd_doenca_w
		from	pls_diagnost_conta_obito	
		where	nr_sequencia			= nr_seq_diagostico_w;
		
		if (coalesce(nr_seq_diagostico_w,0) > 0) then	
			update	pls_diagnost_conta_obito
			set	cd_doenca			= cd_doenca_p,
				nr_declaracao_obito		= nr_declaracao_obito_p
			where	nr_seq_conta			= nr_seq_conta_p;
		else			
			insert into pls_diagnost_conta_obito(cd_doenca, dt_atualizacao,
				dt_atualizacao_nrec, nm_usuario, nr_declaracao_obito,
				nr_seq_conta, nr_sequencia, nm_usuario_nrec)
			values (cd_doenca_p, clock_timestamp(),
				clock_timestamp(), nm_usuario_p, nr_declaracao_obito_p,
				nr_seq_conta_p, nextval('pls_diagnost_conta_obito_seq'), nm_usuario_p);
		end if;
	end if;

	update	pls_conta
	set	ie_tipo_guia			= ie_tipo_guia_p,
		nr_seq_segurado			= nr_seq_segurado_p,		
		nr_seq_prestador_exec		= nr_seq_prestador_exec_p,
		nr_seq_prestador		= nr_seq_prestador_solic_p,		
		qt_nasc_mortos			= qt_nasc_mortos_p,
		qt_nasc_vivos_termo		= qt_nasc_vivos_termo_p,
		qt_nasc_vivos_prematuros	= qt_nasc_vivos_prematuros_p,
		qt_obito_precoce		= qt_obito_precoce_p,
		qt_obito_tardio			= qt_obito_tardio_p,		
		nr_seq_saida_int		= nr_seq_saida_int_p,
		nr_seq_tipo_acomodacao		= nr_seq_tipo_acomodacao_p,
		ie_carater_internacao		= ie_carater_internacao_p,
		ie_obito_mulher			= ie_obito_mulher_p,
		ie_regime_internacao		= ie_regime_internacao_p,		
		dt_entrada			= dt_entrada_w,
		dt_alta				= dt_alta_w,
		cd_senha_externa		= cd_senha_externa_p,
		cd_senha			= cd_senha_p,
		nr_seq_tipo_atendimento		= nr_seq_tipo_atendimento_p,
		ds_observacao			= ds_observacao_p,
		nr_seq_clinica			= nr_seq_clinica_p,
		ie_gestacao			= ie_gestacao_p,
		ie_aborto			= ie_aborto_p,
		ie_parto_normal			= ie_parto_normal_p,
		ie_complicacao_puerperio	= ie_complicacao_puerperio_p,
		ie_complicacao_neonatal		= ie_Complicacao_neonatal_p,
		ie_parto_cesaria		= ie_parto_cesaria_p,
		ie_baixo_peso			= ie_baixo_peso_p,
		ie_atend_rn_sala_parto		= ie_atend_rn_sala_parto_p,
		ie_transtorno			= ie_transtorno_p,
		nr_seq_tipo_conta		= nr_seq_tipo_conta_p,
		ie_indicacao_acidente		= ie_indicacao_acidente_p,
		cd_guia				= cd_guia_ww,
		cd_guia_referencia		= cd_guia_ref_ww,
		cd_guia_prestador		= cd_guia_prestador_ww,
		ie_cobertura_especial	= ie_cobertura_especial_p,
		ie_regime_atendimento	=	ie_regime_atendimento_p,
		ie_saude_ocupacional	= 	ie_saude_ocupacional_p
	where	nr_sequencia			= nr_seq_conta_p;
	
	update	pls_conta_medica_resumo
	set	nr_seq_segurado	= nr_seq_segurado_p
	where	nr_seq_conta	= nr_seq_conta_p;
	
	if (coalesce(ie_tipo_guia_p,'X') <> coalesce(ie_tipo_guia_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Tipo guia: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||obter_valor_dominio(1746, ie_tipo_guia_w)||' - Modificada: '||obter_valor_dominio(1746, ie_tipo_guia_p);
					
		nr_seq_protocolo_alt_w := pls_alterar_tipo_guia_conta(nr_seq_conta_p, ie_tipo_guia_p, nr_seq_protocolo_alt_w, cd_estabelecimento_p, nm_usuario_p);
					
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					chr(9)||'Conta modificada para constar no protocolo '||nr_seq_protocolo_alt_w||'.';
	end if;	

	if (coalesce(nr_seq_segurado_p,0) <> coalesce(nr_seq_segurado_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Segurado: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_dados_segurado(nr_seq_segurado_w,'N')||' - Modificado: '||pls_obter_dados_segurado(nr_seq_segurado_p,'N')||chr(13)||chr(10);
	end if;
	
	if (coalesce(nr_seq_prestador_exec_p,0) <> coalesce(nr_seq_prestador_exec_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Prestador executor: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_dados_prestador(nr_seq_prestador_exec_w,'N')||' - Modificado: '||pls_obter_dados_prestador(nr_seq_prestador_exec_p,'N')||chr(13)||chr(10);
	end if;

	if (coalesce(nr_seq_prestador_solic_p,0) <> coalesce(nr_seq_prestador_solic_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Prestador solicitante: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_dados_prestador(nr_seq_prestador_solic_w,'N')||' - Modificado: '||pls_obter_dados_prestador(nr_seq_prestador_solic_p,'N')||chr(13)||chr(10);	
	end if;
	
	if (coalesce(qt_nasc_mortos_p,0) <> coalesce(qt_nasc_mortos_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Qt. Nasc. mortos:: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||qt_nasc_mortos_w||' - Modificado: '||qt_nasc_mortos_p||chr(13)||chr(10);
	end if;

	if (coalesce(qt_nasc_vivos_termo_p,0) <> coalesce(qt_nasc_vivos_termo_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Qt. Nasc. vivos a termo: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||qt_nasc_vivos_termo_w||' - Modificado: '||qt_nasc_vivos_termo_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(nr_seq_tipo_conta_p,0) <> coalesce(nr_seq_tipo_conta_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Tipo conta: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||nr_seq_tipo_conta_w||' - Modificado: '||nr_seq_tipo_conta_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(qt_nasc_vivos_prematuros_p,0) <> coalesce(qt_nasc_vivos_prematuros_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Qt. Nasc. vivos prematuro: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||qt_nasc_vivos_prematuros_w||' - Modificado: '||qt_nasc_vivos_prematuros_p||chr(13)||chr(10);
	end if;

	if (coalesce(qt_obito_precoce_p,0) <> coalesce(qt_obito_precoce_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Qt. obito neonatal Precoce: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||qt_obito_precoce_w||' - Modificado: '||qt_obito_precoce_p||chr(13)||chr(10);
	end if;

	if (coalesce(qt_obito_tardio_p,0) <> coalesce(qt_obito_tardio_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Qt. obito neonatal Tardio: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||qt_obito_tardio_w||' - Modificado: '||qt_obito_tardio_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(nr_seq_saida_int_p,0) <> coalesce(nr_seq_saida_int_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Motivo saida: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_desc_mot_saida_int(nr_seq_saida_int_w)||' - Modificado: '||pls_obter_desc_mot_saida_int(nr_seq_saida_int_p)||chr(13)||chr(10);
	end if;
	
	if (coalesce(nr_seq_tipo_acomodacao_p,0) <> coalesce(nr_seq_tipo_acomodacao_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Acomodacao: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_desc_tipo_acomodacao(nr_seq_tipo_acomodacao_w)||' - Modificado: '||pls_obter_desc_tipo_acomodacao(nr_seq_tipo_acomodacao_p)||chr(13)||chr(10);
	end if;

	if (coalesce(nr_seq_tipo_atendimento_p,0) <> coalesce(nr_seq_tipo_atendimento_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Tipo atendimento: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_desc_tipo_atend(nr_seq_tipo_atendimento_w)||' - Modificado: '||pls_obter_desc_tipo_atend(nr_seq_tipo_atendimento_p)||chr(13)||chr(10);
	end if;
	
	if (coalesce(ie_cobertura_especial_p,0) <> coalesce(ie_cobertura_especial_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Cobertura especial: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ie_cobertura_especial_w||' - Modificado: '||ie_cobertura_especial_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(ie_regime_atendimento_p,0) <> coalesce(ie_regime_atendimento_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Regime atendimento: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ie_regime_atendimento_w||' - Modificado: '||ie_regime_atendimento_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(ie_saude_ocupacional_p,0) <> coalesce(ie_saude_ocupacional_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Saude ocupacional: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ie_saude_ocupacional_w||' - Modificado: '||ie_saude_ocupacional_p||chr(13)||chr(10);
	end if;
	
		
	if (coalesce(to_char(dt_entrada_ww, 'dd/mm/yyyy hh24:mi:ss'),'X') <> coalesce(to_char(dt_entrada_w, 'dd/mm/yyyy hh24:mi:ss'),'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Data de entrada: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||to_char(dt_entrada_ww, 'dd/mm/yyyy hh24:mi:ss')||' - Modificado: '||to_char(dt_entrada_w, 'dd/mm/yyyy hh24:mi:ss')||chr(13)||chr(10);
	end if;
		
	if (coalesce(to_char(dt_alta_w, 'dd/mm/yyyy hh24:mi:ss'),'X') <> coalesce(to_char(dt_alta_ww, 'dd/mm/yyyy hh24:mi:ss'),'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Data de alta: '||chr(13)||chr(10)||
					chr(9)	||'Anterior: '||to_char(dt_alta_ww, 'dd/mm/yyyy hh24:mi:ss')||' - Modificado: '||to_char(dt_alta_w, 'dd/mm/yyyy hh24:mi:ss')||chr(13)||chr(10);					
	end if;
	
	if (coalesce(cd_senha_externa_p,'X') <> coalesce(cd_senha_externa_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Senha externa: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_senha_externa_w||' - Modificado: '||cd_senha_externa_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(cd_senha_p,'X') <> coalesce(cd_senha_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Senha: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_senha_w||' - Modificado: '||cd_senha_p||chr(13)||chr(10);
	end if;	
	
	if (coalesce(cd_doenca_alta_p,'X') <> coalesce(cd_doenca_alta_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'CID Alta: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_doenca_alta_w||' - '||obter_desc_cid(cd_doenca_alta_w)||' - Modificado: '||cd_doenca_alta_p||' - '||obter_desc_cid(cd_doenca_alta_p)||chr(13)||chr(10);
	end if;
	
	if (coalesce(cd_doenca_p,'X') <> coalesce(cd_doenca_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'CID obito: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_doenca_w||' - '||obter_desc_cid(cd_doenca_w)||' - Modificado: '||cd_doenca_p||' - '||obter_desc_cid(cd_doenca_p)||chr(13)||chr(10);
	end if;
	
	if (coalesce(ds_observacao_p,'X') <> coalesce(ds_observacao_ww,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Observacao: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||replace(trim(both ds_observacao_ww),chr(13)||chr(10),' ')||''||' - Modificado : '||replace(trim(both ds_observacao_p),chr(13)||chr(10),' ')||chr(13)||chr(10);
	end if;

	if (coalesce(ie_gestacao_p,'X') <> coalesce(ie_gestacao_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Se gestacao: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ie_gestacao_w||' - Modificado: '||ie_gestacao_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(ie_aborto_p,'X') <> coalesce(ie_aborto_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Aborto: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ie_aborto_w||' - Modificado: '||ie_aborto_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(ie_parto_normal_p,'X') <> coalesce(ie_parto_normal_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Parto normal: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ie_parto_normal_w||' - Modificado: '||ie_parto_normal_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(ie_complicacao_puerperio_p,'X') <> coalesce(ie_complicacao_puerperio_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Complic puerperio: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ie_complicacao_puerperio_w||' - Modificado: '||ie_complicacao_puerperio_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(ie_complicacao_neonatal_p,'X') <> coalesce(ie_complicacao_neonatal_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Complic neonatal: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ie_complicacao_neonatal_w||' - Modificado: '||ie_complicacao_neonatal_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(ie_parto_cesaria_p,'X') <> coalesce(ie_parto_cesaria_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Parto cesareo: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ie_parto_cesaria_w||' - Modificado: '||ie_parto_cesaria_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(ie_baixo_peso_p,'X') <> coalesce(ie_baixo_peso_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Baixo peso: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ie_baixo_peso_w||' - Modificado: '||ie_baixo_peso_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(ie_atend_rn_sala_parto_p,'X') <> coalesce(ie_atend_rn_sala_parto_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Atendimento ao RN em sala de parto: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ie_atend_rn_sala_parto_w||' - Modificado: '||ie_atend_rn_sala_parto_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(ie_transtorno_p,'X') <> coalesce(ie_transtorno_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Transtorno materno relac a gravidez: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ie_transtorno_w||' - Modificado: '||ie_transtorno_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(ie_indicacao_acidente_p,'X') <> coalesce(ie_indicacao_acidente_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Ind. acidente: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||obter_valor_dominio(1759,ie_indicacao_acidente_w)||' - Modificada: '||obter_valor_dominio(1759,ie_indicacao_acidente_p)||chr(13)||chr(10);
	end if;
	
	if (coalesce(cd_guia_ww,'X') <> coalesce(cd_guia_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Guia: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_guia_w||' - Modificado: '||cd_guia_ww||chr(13)||chr(10);
	end if;	
	
	if (coalesce(cd_guia_ref_ww,'X') <> coalesce(cd_guia_ref_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Guia referencia: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_guia_ref_w||' - Modificado: '||cd_guia_ref_ww||chr(13)||chr(10);
	end if;
	
	if (coalesce(cd_guia_prestador_ww,'X') <> coalesce(cd_guia_prestador_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Guia prestador: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_guia_prestador_w||' - Modificado: '||cd_guia_prestador_ww||chr(13)||chr(10);
	end if;
	
elsif (ie_tipo_guia_w = '4') then
	
	select	max(nr_sequencia)
	into STRICT	nr_seq_diagostico_w
	from	pls_diagnostico_conta	
	where	ie_classificacao		= 'P'
	and	nr_seq_conta			= nr_seq_conta_p;

	select	max(cd_doenca)
	into STRICT	cd_doenca_alta_w
	from	pls_diagnostico_conta	
	where	nr_sequencia			= nr_seq_diagostico_w;

	if (coalesce(nr_seq_diagostico_w,0) > 0) then
		update	pls_diagnostico_conta
		set	cd_doenca			= cd_doenca_alta_p
		where	nr_sequencia			= nr_seq_diagostico_w;
	else
		insert into pls_diagnostico_conta(cd_doenca, ds_diagnostico, dt_atualizacao,
			dt_atualizacao_nrec, ie_classificacao, ie_estagio_complemento,
			ie_indicacao_acidente, ie_tipo_doenca, nm_usuario,
			nm_usuario_nrec, nr_seq_conta, nr_sequencia)
		values (cd_doenca_alta_p, '', clock_timestamp(),
			 clock_timestamp(), 'P', null,
			 null, null, nm_usuario_p,
			 nm_usuario_p, nr_seq_conta_p, nextval('pls_diagnostico_conta_seq'));	
	end if;
		
	update	pls_conta
	set	nr_seq_segurado			= nr_seq_segurado_p,
		ie_tipo_guia			= ie_tipo_guia_p,
		nr_seq_prestador_exec		= nr_seq_prestador_exec_p,
		nr_seq_prestador		= nr_seq_prestador_solic_p,
		cd_senha_externa		= cd_senha_externa_p,
		cd_senha			= cd_senha_p,
		cd_medico_executor		= cd_medico_executor_p,
		cd_medico_solicitante		= cd_medico_solicitante_p,
		nr_seq_saida_spsadt		= nr_seq_saida_spsadt_p,
		nr_seq_tipo_atendimento		= nr_seq_tipo_atendimento_p,
		ie_carater_internacao		= ie_carater_internacao_p,
		ie_indicacao_acidente		= ie_indicacao_acidente_p,
		ie_tipo_doenca			= ie_tipo_doenca_p,
		ds_indicacao_clinica		= substr(ds_indicacao_clinica_p,1,255),
		dt_atendimento			= dt_atendimento_w,
		nr_seq_cbo_saude		= nr_seq_cbo_saude_p,
		nr_seq_cbo_saude_solic		= nr_seq_cbo_saude_solic_p,
		ds_observacao			= ds_observacao_p,
		nr_seq_grau_partic		= nr_seq_grau_partic_p,
		nr_seq_tipo_conta		= nr_seq_tipo_conta_p,
		cd_guia				= cd_guia_ww,
		cd_guia_referencia		= cd_guia_ref_ww,
		cd_guia_prestador		= cd_guia_prestador_ww,
		ie_tipo_consulta		= ie_tipo_consulta_p,
		ie_cobertura_especial	= ie_cobertura_especial_p,
		ie_regime_atendimento	=	ie_regime_atendimento_p,
		ie_saude_ocupacional	= 	ie_saude_ocupacional_p
	where	nr_sequencia			= nr_seq_conta_p;
	
	update	pls_conta_medica_resumo
	set	nr_seq_segurado	= nr_seq_segurado_p
	where	nr_seq_conta	= nr_seq_conta_p;
	
	if (coalesce(ie_tipo_guia_p,'X') <> coalesce(ie_tipo_guia_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Tipo guia: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||obter_valor_dominio(1746, ie_tipo_guia_w)||' - Modificada: '||obter_valor_dominio(1746, ie_tipo_guia_p)||chr(13)||chr(10);
					
		nr_seq_protocolo_alt_w := pls_alterar_tipo_guia_conta(nr_seq_conta_p, ie_tipo_guia_p, nr_seq_protocolo_alt_w, cd_estabelecimento_p, nm_usuario_p);
					
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					chr(9)||'Conta modificada para constar no protocolo '||nr_seq_protocolo_alt_w||'.'||chr(13)||chr(10);
	end if;	

	if (coalesce(nr_seq_segurado_p,0) <> coalesce(nr_seq_segurado_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Segurado: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_dados_segurado(nr_seq_segurado_w,'N')||' - Modificado: '||pls_obter_dados_segurado(nr_seq_segurado_p,'N')||chr(13)||chr(10);
	end if;
	
	if (coalesce(cd_doenca_p,'X') <> coalesce(cd_doenca_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'CID Principal: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_doenca_w||' - '||obter_desc_cid(cd_doenca_w)||' - Modificado: '||cd_doenca_p||' - '||obter_desc_cid(cd_doenca_p)||chr(13)||chr(10);
	end if;	
	
	if (coalesce(nr_seq_prestador_exec_p,0) <> coalesce(nr_seq_prestador_exec_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Prestador executor: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_dados_prestador(nr_seq_prestador_exec_w,'N')||' - Modificado: '||pls_obter_dados_prestador(nr_seq_prestador_exec_p,'N')||chr(13)||chr(10);
	end if;

	if (coalesce(nr_seq_prestador_solic_p,0) <> coalesce(nr_seq_prestador_solic_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Prestador solicitante: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_dados_prestador(nr_seq_prestador_solic_w,'N')||' - Modificado: '||pls_obter_dados_prestador(nr_seq_prestador_solic_p,'N')||chr(13)||chr(10);	
	end if;
	
	if (coalesce(nr_seq_tipo_conta_p,0) <> coalesce(nr_seq_tipo_conta_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Tipo conta: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||nr_seq_tipo_conta_w||' - Modificado: '||nr_seq_tipo_conta_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(cd_senha_externa_p,'X') <> coalesce(cd_senha_externa_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Senha externa: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_senha_externa_w||' - Modificado: '||cd_senha_externa_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(cd_senha_p,'X') <> coalesce(cd_senha_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Senha: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_senha_w||' - Modificado: '||cd_senha_p||chr(13)||chr(10);
	end if;	

	if (coalesce(cd_medico_executor_p,0) <> coalesce(cd_medico_executor_w,0)) then			
	
		if (coalesce(cd_medico_executor_w,0) <> 0) then
			nm_medico_executor_w	:= obter_nome_medico(cd_medico_executor_w,'N');
		else
			nm_medico_executor_w	:= '          ';
		end if;
		
		if (coalesce(cd_medico_executor_p,0) <> 0) then
			nm_medico_executor_ww	:= obter_nome_medico(cd_medico_executor_p,'N');
		else
			nm_medico_executor_ww	:= '          ';
		end if;			
		
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Profissional executor: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||nm_medico_executor_w||' - Modificado: '||nm_medico_executor_ww||chr(13)||chr(10);
	end if;

	if (coalesce(cd_medico_solicitante_p,0) <> coalesce(cd_medico_solicitante_w,0)) then
		if (coalesce(cd_medico_solicitante_w,0) <> 0) then		
			nm_medico_solic_w	:= obter_nome_medico(cd_medico_solicitante_w,'N');
		else
			nm_medico_solic_w	:= '          ';
		end if;	
		
		if (coalesce(cd_medico_solicitante_p,0) <> 0) then
			nm_medico_solic_ww	:= obter_nome_medico(cd_medico_solicitante_p,'N');
		else
			nm_medico_solic_ww	:= '          ';
		end if;		
		
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Profissional solicitante: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||nm_medico_solic_w||' - Modificado: '||nm_medico_solic_ww||chr(13)||chr(10);
		
	end if;
	
	if (coalesce(nr_seq_saida_spsadt_p,0) <> coalesce(nr_seq_saida_spsadt_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Tipo saida: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_desc_motivo_saida(nr_seq_saida_spsadt_w)||' - Modificado: '||pls_obter_desc_motivo_saida(nr_seq_saida_spsadt_p)||chr(13)||chr(10);
	end if;
	
	if (coalesce(nr_seq_tipo_atendimento_p,0) <> coalesce(nr_seq_tipo_atendimento_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Tipo atendimento: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_desc_tipo_atend(nr_seq_tipo_atendimento_w)||' - Modificado: '||pls_obter_desc_tipo_atend(nr_seq_tipo_atendimento_p)||chr(13)||chr(10);
	end if;
	
	if (coalesce(ie_cobertura_especial_p,0) <> coalesce(ie_cobertura_especial_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Cobertura especial: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ie_cobertura_especial_w||' - Modificado: '||ie_cobertura_especial_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(ie_regime_atendimento_p,0) <> coalesce(ie_regime_atendimento_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Regime atendimento: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ie_regime_atendimento_w||' - Modificado: '||ie_regime_atendimento_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(ie_saude_ocupacional_p,0) <> coalesce(ie_saude_ocupacional_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Saude ocupacional: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ie_saude_ocupacional_w||' - Modificado: '||ie_saude_ocupacional_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(ie_carater_internacao_p,'X') <> coalesce(ie_carater_internacao_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Carater int/solic.: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||obter_valor_dominio(2819,ie_carater_internacao_w)||' - Modificado: '||obter_valor_dominio(2819,ie_carater_internacao_p)||chr(13)||chr(10);
	end if;
	
	if (coalesce(ie_indicacao_acidente_p,'X') <> coalesce(ie_indicacao_acidente_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Ind. acidente: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||obter_valor_dominio(1759,ie_indicacao_acidente_w)||' - Modificada: '||obter_valor_dominio(1759,ie_indicacao_acidente_p)||chr(13)||chr(10);
	end if;
	
	if (coalesce(ie_tipo_doenca_p,'X') <> coalesce(ie_tipo_doenca_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Tipo doenca: '||chr(13)||chr(10)||
					chr(9)||'Tipo doenca anterior: '||obter_valor_dominio(1758,ie_tipo_doenca_w)||' - Modificado: '||obter_valor_dominio(1758,ie_tipo_doenca_p)||chr(13)||chr(10);
	end if;
	
	if (coalesce(cd_doenca_alta_p,'X') <> coalesce(cd_doenca_alta_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'CID Principal: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_doenca_alta_w||' - '||obter_desc_cid(cd_doenca_alta_w)||' - Modificado: '||cd_doenca_alta_w||' - '||obter_desc_cid(cd_doenca_alta_p)||chr(13)||chr(10);
	end if;
	
	if (coalesce(ds_indicacao_clinica_p,'X') <> coalesce(ds_indicacao_clinica_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Indicacao clinica: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||ds_indicacao_clinica_w||chr(13)||chr(10)||chr(9)||'Modificado: '||ds_indicacao_clinica_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(to_char(dt_atendimento_ww, 'dd/mm/yyyy hh24:mi:ss'),'X') <> coalesce(to_char(dt_atendimento_w, 'dd/mm/yyyy hh24:mi:ss'),'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Data de atendimento: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||to_char(dt_atendimento_ww, 'dd/mm/yyyy hh24:mi:ss')||' - Modificado: '||to_char(dt_atendimento_w, 'dd/mm/yyyy hh24:mi:ss')||chr(13)||chr(10);
	end if;
	
	if (coalesce(nr_seq_cbo_saude_p,0) <> coalesce(nr_seq_cbo_saude_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'CBO executor: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||substr(obter_codigo_cbo_saude(nr_seq_cbo_saude_w),1,15)||' - '||substr(obter_cbo_saude(nr_seq_cbo_saude_w),1,80)||' - Modificado: '||substr(obter_codigo_cbo_saude(nr_seq_cbo_saude_p),1,15)||' - '||substr(obter_cbo_saude(nr_seq_cbo_saude_p),1,80)||chr(13)||chr(10);
	end if;
	
	if (coalesce(nr_seq_cbo_saude_solic_p,0) <> coalesce(nr_seq_cbo_saude_solic_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'CBO solicitante: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||substr(obter_codigo_cbo_saude(nr_seq_cbo_saude_solic_w),1,15)||' - '||substr(obter_cbo_saude(nr_seq_cbo_saude_solic_w),1,80)||' - Modificado: '||substr(obter_codigo_cbo_saude(nr_seq_cbo_saude_solic_p),1,15)||' - '||substr(obter_cbo_saude(nr_seq_cbo_saude_solic_p),1,80)||chr(13)||chr(10);
	end if;
	
	if (coalesce(nr_seq_tipo_conta_p,0) <> coalesce(nr_seq_tipo_conta_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Tipo conta: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||nr_seq_tipo_conta_w||' - Modificado: '||nr_seq_tipo_conta_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(ds_observacao_p,'X') <> coalesce(ds_observacao_ww,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Observacao: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||replace(trim(both ds_observacao_ww),chr(13)||chr(10),' ')||''||' - Modificado : '||replace(trim(both ds_observacao_p),chr(13)||chr(10),' ')||chr(13)||chr(10);
	end if;
	
	if (coalesce(cd_guia_ww,'X') <> coalesce(cd_guia_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Guia: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_guia_w||' - Modificado: '||cd_guia_ww||chr(13)||chr(10);
	end if;	
	
	if (coalesce(cd_guia_ref_ww,'X') <> coalesce(cd_guia_ref_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Guia referencia: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_guia_ref_w||' - Modificado: '||cd_guia_ref_ww||chr(13)||chr(10);
	end if;
	
	if (coalesce(cd_guia_prestador_ww,'X') <> coalesce(cd_guia_prestador_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Guia prestador: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_guia_prestador_w||' - Modificado: '||cd_guia_prestador_ww||chr(13)||chr(10);
	end if;
	
	if (coalesce(ie_tipo_consulta_p,'0') <> coalesce(ie_tipo_consulta_w,'0')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Tipo de consulta: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||obter_valor_dominio(3435,ie_tipo_consulta_w)||' - Modificado: '||obter_valor_dominio(3435,ie_tipo_consulta_p)||chr(13)||chr(10);
	end if;
	
--Caso for guia de consulta ou guia de odontologia	
elsif (ie_tipo_guia_w = '3') or (ie_tipo_guia_w = '11')  then

	select	max(nr_sequencia)
	into STRICT	nr_seq_diagostico_w
	from	pls_diagnostico_conta	
	where	ie_classificacao		= 'P'
	and	nr_seq_conta			= nr_seq_conta_p;

	select	max(cd_doenca)
	into STRICT	cd_doenca_alta_w
	from	pls_diagnostico_conta	
	where	nr_sequencia			= nr_seq_diagostico_w;

	if (coalesce(nr_seq_diagostico_w,0) > 0) then
		update	pls_diagnostico_conta
		set	cd_doenca			= cd_doenca_alta_p
		where	nr_sequencia			= nr_seq_diagostico_w;
	else
		insert into pls_diagnostico_conta(cd_doenca, ds_diagnostico, dt_atualizacao,
			dt_atualizacao_nrec, ie_classificacao, ie_estagio_complemento,
			ie_indicacao_acidente, ie_tipo_doenca, nm_usuario,
			nm_usuario_nrec, nr_seq_conta, nr_sequencia)
		values (cd_doenca_alta_p, '', clock_timestamp(),
			 clock_timestamp(), 'P', null,
			 null, null, nm_usuario_p,
			 nm_usuario_p, nr_seq_conta_p, nextval('pls_diagnostico_conta_seq'));	
	end if;
	
	update	pls_conta
	set	ie_tipo_guia			= ie_tipo_guia_p,
		nr_seq_segurado			= nr_seq_segurado_p,
		nr_seq_prestador_exec		= nr_seq_prestador_exec_p,
		nr_seq_prestador		= nr_seq_prestador_solic_p,
		nr_seq_saida_consulta		= nr_seq_saida_consulta_p,		
		dt_atendimento			= dt_atendimento_w,		
		cd_senha_externa		= cd_senha_externa_p,
		cd_senha			= cd_senha_p,
		cd_medico_executor		= cd_medico_executor_p,
		cd_medico_solicitante		= cd_medico_solicitante_p,
		ie_tipo_consulta		= ie_tipo_consulta_p,
		nr_seq_cbo_saude		= nr_seq_cbo_saude_p,
		nr_seq_cbo_saude_solic		= nr_seq_cbo_saude_solic_p,
		ds_observacao			= ds_observacao_p,
		nr_seq_tipo_conta		= nr_seq_tipo_conta_p,
		cd_guia				= cd_guia_ww,
		cd_guia_referencia		= cd_guia_ref_ww,
		cd_guia_prestador		= cd_guia_prestador_ww,
		ie_cobertura_especial	= ie_cobertura_especial_p,
		ie_regime_atendimento	=	ie_regime_atendimento_p,
		ie_saude_ocupacional	= 	ie_saude_ocupacional_p
	where	nr_sequencia			= nr_seq_conta_p;
	
	update	pls_conta_medica_resumo
	set	nr_seq_segurado	= nr_seq_segurado_p
	where	nr_seq_conta	= nr_seq_conta_p;
	
	if (coalesce(ie_tipo_guia_p,'X') <> coalesce(ie_tipo_guia_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Tipo guia: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||obter_valor_dominio(1746, ie_tipo_guia_w)||' - Modificada: '||obter_valor_dominio(1746, ie_tipo_guia_p)||chr(13)||chr(10);
					
		nr_seq_protocolo_alt_w := pls_alterar_tipo_guia_conta(nr_seq_conta_p, ie_tipo_guia_p, nr_seq_protocolo_alt_w, cd_estabelecimento_p, nm_usuario_p);
					
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					chr(9)||'Conta modificada para constar no protocolo '||nr_seq_protocolo_alt_w||'.';
	end if;	

	if (coalesce(nr_seq_segurado_p,0) <> coalesce(nr_seq_segurado_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Segurado: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_dados_segurado(nr_seq_segurado_w,'N')||' - Modificado: '||pls_obter_dados_segurado(nr_seq_segurado_p,'N')||chr(13)||chr(10);
	end if;
	
	if (coalesce(nr_seq_prestador_exec_p,0) <> coalesce(nr_seq_prestador_exec_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Prestador executor: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_dados_prestador(nr_seq_prestador_exec_w,'N')||' - Modificado: '||pls_obter_dados_prestador(nr_seq_prestador_exec_p,'N')||chr(13)||chr(10);
	end if;

	if (coalesce(nr_seq_prestador_solic_p,0) <> coalesce(nr_seq_prestador_solic_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Prestador solicitante: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_dados_prestador(nr_seq_prestador_solic_w,'N')||' - Modificado: '||pls_obter_dados_prestador(nr_seq_prestador_solic_p,'N')||chr(13)||chr(10);	
	end if;
	
	if (coalesce(cd_senha_externa_p,'X') <> coalesce(cd_senha_externa_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Senha externa: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_senha_externa_w||' - Modificado: '||cd_senha_externa_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(cd_senha_p,'X') <> coalesce(cd_senha_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Senha: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_senha_w||' - Modificado: '||cd_senha_p||chr(13)||chr(10);
	end if;	

	if (coalesce(cd_medico_executor_p,0) <> coalesce(cd_medico_executor_w,0)) then
	
		if (coalesce(cd_medico_executor_w,0) <> 0) then
			nm_medico_executor_w	:= obter_nome_medico(cd_medico_executor_w,'N');
		else
			nm_medico_executor_w	:= '          ';
		end if;
		
		if (coalesce(cd_medico_executor_p,0) <> 0) then
			nm_medico_executor_ww	:= obter_nome_medico(cd_medico_executor_p,'N');
		else
			nm_medico_executor_ww	:= '          ';
		end if;			
		
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Profissional executor: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||nm_medico_executor_w||' - Modificado: '||nm_medico_executor_ww||chr(13)||chr(10);
	end if;

	if (coalesce(cd_medico_solicitante_p,0) <> coalesce(cd_medico_solicitante_w,0)) then
		if (coalesce(cd_medico_solicitante_w,0) <> 0) then		
			nm_medico_solic_w	:= obter_nome_medico(cd_medico_solicitante_w,'N');
		else
			nm_medico_solic_w	:= '          ';
		end if;	
		
		if (coalesce(cd_medico_solicitante_p,0) <> 0) then
			nm_medico_solic_ww	:= obter_nome_medico(cd_medico_solicitante_p,'N');
		else
			nm_medico_solic_ww	:= '          ';
		end if;		
		
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Profissional solicitante: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||nm_medico_solic_w||' - Modificado: '||nm_medico_solic_ww||chr(13)||chr(10);
	end if;
	
	if (coalesce(nr_seq_saida_consulta_p,0) <> coalesce(nr_seq_saida_consulta_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Motivo saida: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||pls_obter_desc_mot_saida_con(nr_seq_saida_consulta_w)||' - Modificado: '||pls_obter_desc_mot_saida_con(nr_seq_saida_consulta_p)||chr(13)||chr(10);
	end if;
	
	if (coalesce(to_char(dt_atendimento_ww, 'dd/mm/yyyy hh24:mi:ss'),'X') <> coalesce(to_char(dt_atendimento_w, 'dd/mm/yyyy hh24:mi:ss'),'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Data de atendimento: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||to_char(dt_atendimento_ww, 'dd/mm/yyyy hh24:mi:ss')||' - Modificado: '||to_char(dt_atendimento_w, 'dd/mm/yyyy hh24:mi:ss')||chr(13)||chr(10);
	end if;
	
	if (coalesce(ie_tipo_consulta_p,'0') <> coalesce(ie_tipo_consulta_w,'0')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Tipo de consulta: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||obter_valor_dominio(3435,ie_tipo_consulta_w)||' - Modificado: '||obter_valor_dominio(3435,ie_tipo_consulta_p)||chr(13)||chr(10);
	end if;
	
	if (coalesce(cd_doenca_alta_p,'X') <> coalesce(cd_doenca_alta_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'CID Principal: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_doenca_alta_w||' - '||obter_desc_cid(cd_doenca_alta_w)||' - Modificado: '||cd_doenca_alta_p||' - '||obter_desc_cid(cd_doenca_alta_p)||chr(13)||chr(10);
	end if;
	
	if (coalesce(nr_seq_cbo_saude_p,0) <> coalesce(nr_seq_cbo_saude_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'CBO executor: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||substr(obter_codigo_cbo_saude(nr_seq_cbo_saude_w),1,15)||' - '||substr(obter_cbo_saude(nr_seq_cbo_saude_w),1,80)||' - Modificado: '||substr(obter_codigo_cbo_saude(nr_seq_cbo_saude_p),1,15)||' - '||substr(obter_cbo_saude(nr_seq_cbo_saude_p),1,80)||chr(13)||chr(10);
	end if;
	
	if (coalesce(nr_seq_cbo_saude_solic_p,0) <> coalesce(nr_seq_cbo_saude_solic_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'CBO solicitante: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||substr(obter_codigo_cbo_saude(nr_seq_cbo_saude_solic_w),1,15)||' - '||substr(obter_cbo_saude(nr_seq_cbo_saude_solic_w),1,80)||' - Modificado: '||substr(obter_codigo_cbo_saude(nr_seq_cbo_saude_solic_p),1,15)||' - '||substr(obter_cbo_saude(nr_seq_cbo_saude_solic_p),1,80)||chr(13)||chr(10);
	end if;
	
	if (coalesce(nr_seq_tipo_conta_p,0) <> coalesce(nr_seq_tipo_conta_w,0)) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Tipo conta: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||nr_seq_tipo_conta_w||' - Modificado: '||nr_seq_tipo_conta_p||chr(13)||chr(10);
	end if;
	
	if (coalesce(ds_observacao_p,'X') <> coalesce(ds_observacao_ww,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Observacao: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||replace(trim(both ds_observacao_ww),chr(13)||chr(10),' ')||''||' - Modificado : '||replace(trim(both ds_observacao_p),chr(13)||chr(10),' ')||chr(13)||chr(10);
	end if;
	
	if (coalesce(cd_guia_ww,'X') <> coalesce(cd_guia_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Guia: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_guia_w||' - Modificado: '||cd_guia_ww||chr(13)||chr(10);
	end if;	
	
	if (coalesce(cd_guia_ref_ww,'X') <> coalesce(cd_guia_ref_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Guia referencia: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_guia_ref_w||' - Modificado: '||cd_guia_ref_ww||chr(13)||chr(10);
	end if;
	
	if (coalesce(cd_guia_prestador_ww,'X') <> coalesce(cd_guia_prestador_w,'X')) then
		ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
					'Guia prestador: '||chr(13)||chr(10)||
					chr(9)||'Anterior: '||cd_guia_prestador_w||' - Modificado: '||cd_guia_prestador_ww||chr(13)||chr(10);
	end if;
end if;

if (coalesce(ds_observacao_w,'X') <> 'X') and (coalesce(ie_origem_conta_p,'C') = 'C') then
	insert into	pls_conta_log(	nr_sequencia,dt_atualizacao, nm_usuario,
						dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_conta,
						nr_seq_conta_proc, nr_seq_conta_mat, nm_usuario_alteracao,
						dt_alteracao, ds_alteracao)
			values (	nextval('pls_conta_log_seq'), clock_timestamp(), nm_usuario_p,
						clock_timestamp(), nm_usuario_p, nr_seq_conta_p,
						null,  NULL, nm_usuario_p,
						clock_timestamp(), ds_observacao_w);
elsif (coalesce(ds_observacao_w,'X') <> 'X') and (coalesce(ie_origem_conta_p,'C') = 'A') then
	CALL pls_inserir_hist_analise(nr_seq_conta_p, nr_seq_analise_p,17,
			 null, null, null,
			 null, 'Modificado pelo auditor '||obter_nome_usuario(nm_usuario_p)||'.'|| ds_observacao_w, nr_seq_grupo_p,
			 nm_usuario_p, cd_estabelecimento_p);
end if;

if (ie_reconsistir_p = 'S') then
	/*pls_consistir_conta(nr_seq_conta_p,cd_estabelecimento_p,nm_usuario_p,'N','N','N');*/

	CALL pls_consistir_analise(nr_seq_analise_p,nr_seq_grupo_p,cd_estabelecimento_p,nm_usuario_p);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alterar_conta ( nr_seq_segurado_p bigint, nr_seq_prestador_exec_p bigint, nr_seq_prestador_solic_p bigint, ie_carater_internacao_p text, nr_seq_saida_int_p bigint, ie_obito_mulher_p text, qt_nasc_mortos_p bigint, qt_nasc_vivos_termo_p bigint, qt_nasc_vivos_prematuros_p bigint, qt_obito_precoce_p bigint, qt_obito_tardio_p bigint, cd_doenca_p text, nr_declaracao_obito_p text, ie_tipo_guia_p text, nr_seq_clinica_p bigint, ie_regime_internacao_p text, ie_indicacao_acidente_p text, nr_seq_tipo_acomodacao_p bigint, nr_seq_saida_spsadt_p bigint, nr_seq_tipo_atendimento_p bigint, ie_tipo_doenca_p text, nr_seq_saida_consulta_p bigint, ie_tipo_consulta_p text, nr_seq_conta_p bigint, cd_estabelecimento_p bigint, dt_atendimento_p text, dt_entrada_p text, dt_alta_p text, cd_senha_externa_p text, cd_senha_p text, cd_medico_executor_p bigint, cd_medico_solicitante_p bigint, cd_doenca_alta_p text, ds_indicacao_clinica_p text, nr_seq_cbo_saude_p bigint, nr_seq_cbo_saude_solic_p bigint, nr_seq_grau_partic_p bigint, nm_usuario_p text, ds_observacao_p text, ie_gestacao_p text, ie_aborto_p text, ie_parto_normal_p text, ie_complicacao_puerperio_p text, ie_complicacao_neonatal_p text, ie_parto_cesaria_p text, ie_baixo_peso_p text, ie_atend_rn_sala_parto_p text, ie_transtorno_p text, ie_origem_conta_p text, nr_seq_analise_p bigint, nr_seq_grupo_p bigint, nr_seq_tipo_conta_p pls_conta.nr_seq_tipo_conta%type, ie_reconsistir_p text, cd_guia_p pls_conta.cd_guia%type, cd_guia_referencia_p pls_conta.cd_guia_referencia%type, cd_guia_prestador_p pls_conta.cd_guia_prestador%type, ie_cobertura_especial_p pls_conta.ie_cobertura_especial%type default null, ie_regime_atendimento_p pls_conta.ie_regime_atendimento%type default null, ie_saude_ocupacional_p pls_conta.ie_saude_ocupacional%type default null) FROM PUBLIC;

