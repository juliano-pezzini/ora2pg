-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_rep_gerar_albumina_medic (nr_seq_mat_cpoe_p cpoe_material.nr_sequencia%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nr_seq_material_p prescr_material.nr_sequencia%type) AS $body$
DECLARE


nr_seq_prescr_albu_w		prescr_medica_albumina.nr_sequencia%type;
qt_dia_util_w				prescr_medica_albumina.qt_dia_util%type;
qt_concentracao_w			prescr_medica_albumina.qt_concentracao%type;
ie_base_dose_albumina_w		prescr_medica_albumina.ie_base_dose_albumina%type;
nr_seq_grupo_w				prescr_medica_albu_indic.nr_seq_grupo%type;
nr_seq_indicacao_w			prescr_medica_albu_indic.nr_seq_indicacao%type;
ds_observacao_w				prescr_medica_albu_indic.ds_observacao%type;
qt_count_w					smallint;
ds_comando_update_w			varchar(4000);
ds_sep_bv_w					varchar(50);

c01 CURSOR FOR
SELECT	row_number() OVER () AS rownum,
		nr_seq_grupo,
		nr_seq_indicacao,
		ds_observacao
from	prescr_medica_albu_indic
where	nr_seq_prescr_albu = nr_seq_prescr_albu_w  LIMIT 3;


BEGIN
if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '' AND nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') then

	ds_sep_bv_w	:= obter_separador_bv;

	select	max(nr_sequencia),
			max(qt_dia_util),
			max(qt_concentracao),
			max(ie_base_dose_albumina)
	into STRICT	nr_seq_prescr_albu_w,
			qt_dia_util_w,
			qt_concentracao_w,
			ie_base_dose_albumina_w
	from	prescr_medica_albumina a
	where	nr_prescricao = nr_prescricao_p
	and		nr_seq_material = nr_seq_material_p;

	if (nr_seq_prescr_albu_w IS NOT NULL AND nr_seq_prescr_albu_w::text <> '') then

		update	cpoe_material
		set		qt_dia_util_alb = qt_dia_util_w,
				qt_concentracao_alb = qt_concentracao_w,
				ie_base_dose_albumina = ie_base_dose_albumina_w
		where	nr_sequencia = nr_seq_mat_cpoe_p;

		open c01;
		loop
		fetch c01 into 	qt_count_w,
						nr_seq_grupo_w,
						nr_seq_indicacao_w,
						ds_observacao_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin

			ds_comando_update_w :=	' update	cpoe_material ' ||
									' set		nr_seq_grupo_indic_alb' || to_char(qt_count_w) || ' = :nr_seq_grupo_p, ' ||
									'			nr_seq_indicacao_alb' || to_char(qt_count_w) || ' = :nr_seq_indicacao_p, ' ||
									'			ds_observacao_alb' || to_char(qt_count_w) || ' = :ds_observacao_p ' ||
									' where		nr_sequencia = :nr_seq_mat_cpoe_p ';

			CALL exec_sql_dinamico_bv('',ds_comando_update_w,
								'nr_seq_grupo_p='||to_char(nr_seq_grupo_w) || ds_sep_bv_w ||
								'nr_seq_indicacao_p='||to_char(nr_seq_indicacao_w)|| ds_sep_bv_w ||
								'ds_observacao_p='||to_char(ds_observacao_w)|| ds_sep_bv_w ||
								'nr_seq_mat_cpoe_p='||to_char(nr_seq_mat_cpoe_p)|| ds_sep_bv_w);

			end;
		end loop;
		close c01;

	end if;

end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_rep_gerar_albumina_medic (nr_seq_mat_cpoe_p cpoe_material.nr_sequencia%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nr_seq_material_p prescr_material.nr_sequencia%type) FROM PUBLIC;

