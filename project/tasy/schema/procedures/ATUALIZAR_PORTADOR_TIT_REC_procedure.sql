-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_portador_tit_rec ( ie_evento_p text, nr_seq_cobranca_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w				bigint;
nr_titulo_w				bigint;
cd_tipo_portador_w				bigint;
cd_portador_w				bigint;
cd_portador_atual_w			bigint;
cd_tipo_portador_atual_w			bigint;
cd_motivo_w				bigint;
nr_seq_trans_financ_w			bigint;
nr_seq_conta_banco_w			bigint;
cd_estabelecimento_w			bigint;
vl_despesa_w				double precision;

c01 CURSOR FOR
SELECT	b.nr_titulo,
	b.cd_tipo_portador,
	b.cd_portador
from	titulo_receber b,
	titulo_receber_cobr a
where	a.nr_titulo		= b.nr_titulo
and	a.nr_seq_cobranca	= nr_seq_cobranca_p;

c02 CURSOR FOR
SELECT	cd_portador_atual,
	cd_tipo_portador_atual,
	nr_seq_trans_financ,
	vl_despesa,
	cd_motivo
from	regra_alt_portador
where	coalesce(nr_seq_conta_banco,0)	= coalesce(nr_seq_conta_banco_w, 0)
and	cd_portador_ant		= cd_portador_w
and	cd_tipo_portador_ant	= cd_tipo_portador_w
and	cd_estabelecimento		= cd_estabelecimento_w
and	cd_portador_atual		<> cd_portador_w
and	cd_tipo_portador_atual	<> cd_tipo_portador_w
and	ie_evento			= ie_evento_p
order 	by coalesce(nr_seq_conta_banco, 0),
	coalesce(cd_tipo_portador_ant,0),
	coalesce(cd_portador_ant,0);

BEGIN

if (ie_evento_p = 'RB') then

	select	max(nr_seq_conta_banco),
		max(cd_estabelecimento)
	into STRICT	nr_seq_conta_banco_w,
		cd_estabelecimento_w
	from	cobranca_escritural
	where	nr_sequencia	= nr_seq_cobranca_p;

	open c01;
	loop
	fetch c01 into
		nr_titulo_w,
		cd_tipo_portador_w,
		cd_portador_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		cd_portador_atual_w	:= null;
		cd_tipo_portador_atual_w	:= null;
		open c02;
		loop
		fetch c02 into
			cd_portador_atual_w,
			cd_tipo_portador_atual_w,
			nr_seq_trans_financ_w,
			vl_despesa_w,
			cd_motivo_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
		end loop;
		close c02;

		if (cd_portador_atual_w IS NOT NULL AND cd_portador_atual_w::text <> '') and (cd_tipo_portador_atual_w IS NOT NULL AND cd_tipo_portador_atual_w::text <> '') then

			select	coalesce(max(nr_sequencia),0) + 1
			into STRICT	nr_sequencia_w
			from	alteracao_portador
			where	nr_titulo	= nr_titulo_w;

			insert into ALTERACAO_PORTADOR(NR_TITULO,
				NR_SEQUENCIA,
				DT_ATUALIZACAO,
				NM_USUARIO,
				DT_ALTERACAO,
				CD_MOTIVO,
				CD_PORTADOR_ANT,
				CD_TIPO_PORTADOR_ANT,
				CD_PORTADOR,
				CD_TIPO_PORTADOR,
				VL_DESPESA,
				NR_LOTE_CONTABIL,
				DS_OBSERVACAO,
				NR_SEQ_TRANS_FIN)
			values (nr_titulo_w,
				nr_sequencia_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				cd_motivo_w,
				cd_portador_w,
				cd_tipo_portador_w,
				cd_portador_atual_w,
				cd_tipo_portador_atual_w,
				vl_despesa_w,
				null,
				null,
				nr_seq_trans_financ_w);

			update	titulo_receber
			set	cd_portador	= cd_portador_atual_w,
				cd_tipo_portador	= cd_tipo_portador_atual_w,
				nm_usuario	= nm_usuario_p,
				dt_atualizacao	= clock_timestamp()
			where	nr_titulo		= nr_titulo_w;

			update	cobranca
			set	cd_portador	= cd_portador_atual_w,
				cd_tipo_portador	= cd_tipo_portador_atual_w,
				nm_usuario	= nm_usuario_p,
				dt_atualizacao	= clock_timestamp()
			where	nr_titulo		= nr_titulo_w
			and	ie_status		= 'P';

		end if;
	end loop;
	close c01;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_portador_tit_rec ( ie_evento_p text, nr_seq_cobranca_p bigint, nm_usuario_p text) FROM PUBLIC;

