-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consistir_via_acesso ( cd_procedimento_p bigint, ie_origem_proced_p bigint, ie_via_acesso_p text, nr_seq_prestador_p bigint, qt_procedimento_p bigint, nr_seq_conta_p bigint, cd_medico_executor_p text, nr_seq_grau_partic_p bigint, cd_guia_referencia_p text, nr_seq_conta_proc_p bigint, nm_usuario_p text, ie_tipo_guia_p text, nr_seq_segurado_p bigint, ie_origem_conta_p pls_conta.ie_origem_conta%type, nr_seq_regra_p INOUT bigint, ie_consistido_p INOUT text, ds_retorno_p INOUT text) AS $body$
DECLARE


/* IE_CONSISTIDO_P
	S - A via de acesso está OK
	N - Não foi informada a via de acesso ou foi informada uma via incorreta

*/
ie_origem_proced_w		bigint;
ie_origem_proced_ww		bigint;
cd_grupo_proc_w			bigint;
cd_especialidade_w		bigint;
cd_area_procedimento_w		bigint;
nr_seq_regra_w			bigint;
nr_seq_regra_ww			bigint;
ie_consistido_w			varchar(1)	:= 'S';
ie_via_obrigatoria_w		varchar(1)	:= 'N';
qt_via_acesso_w			bigint;
nr_seq_grupo_servico_w		bigint;
ie_grupo_servico_w		varchar(1)	:= 'S';
ie_glosa_quantidade_proced_w	varchar(1)	:= 'S';
qt_proc_conta_w			double precision	:= 0;
qt_proc_conta_ww		double precision;
cd_procedimento_w		varchar(20);
ie_regra_w			varchar(10);
qt_procedimento_w		bigint;
nr_seq_prestador_w		bigint;
ie_tipo_guia_w			bigint;
qt_medico_w			bigint;
cd_participante_w		varchar(10);
nr_seq_grau_partic_w		bigint;
dt_procedimento_w		timestamp;
dt_inicio_proc_w		varchar(15);
dt_fim_proc_w			varchar(15);
ds_retorno_w			varchar(4000);
nr_seq_conta_w			bigint;
qt_proc_conta_www		bigint;
cd_procedimento_conta_w		bigint;
ie_origem_proced_conta_w	bigint;
cd_proced_ant_w			bigint;
ie_origem_proced_ant_w		bigint;
ie_excecao_w			varchar(1);

C01 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.nr_seq_grupo_servico,
		a.cd_grupo_proc,
		a.cd_especialidade,
		a.cd_area_procedimento,
		a.cd_procedimento,
		a.ie_origem_proced,
		a.ie_regra,
		a.qt_procedimento,
		a.nr_seq_prestador
	from	pls_regra_via_acesso	a
	where	a.ie_situacao	= 'A'
	and	((coalesce(a.nr_seq_prestador::text, '') = '') or (a.nr_seq_prestador = nr_seq_prestador_p))
	and	((coalesce(a.cd_procedimento::text, '') = '') or (a.cd_procedimento	= cd_procedimento_p AND ie_origem_proced	= ie_origem_proced_w))
	and	((coalesce(a.cd_grupo_proc::text, '') = '') or (a.cd_grupo_proc	= cd_grupo_proc_w))
	and	((coalesce(a.cd_especialidade::text, '') = '') or (a.cd_especialidade	= cd_especialidade_w))
	and	((coalesce(a.cd_area_procedimento::text, '') = '') or (a.cd_area_procedimento = cd_area_procedimento_w))
	and	((coalesce(a.ie_tipo_guia::text, '') = '') or (a.ie_tipo_guia 	= ie_tipo_guia_w))
	and	dt_procedimento_w 	>= coalesce(dt_inicio_vigencia,dt_procedimento_w)
	and	dt_procedimento_w 	< coalesce(dt_fim_vigencia,dt_procedimento_w+1)
	and	((coalesce(ie_origem_conta::text, '') = '') or (ie_origem_conta	= ie_origem_conta_p))
	order by a.cd_area_procedimento,
		a.cd_especialidade,
		a.cd_grupo_proc,
		a.cd_procedimento,
		coalesce(a.nr_seq_prestador,0),
		coalesce(a.ie_tipo_guia,'0'),
		coalesce(a.ie_origem_conta,0);

C02 CURSOR FOR
	SELECT	a.cd_medico,
		a.nr_seq_grau_partic
	from	pls_proc_participante	a,
		pls_conta_proc		b
	where	b.nr_sequencia		= a.nr_seq_conta_proc
	and	b.nr_sequencia		= nr_seq_conta_proc_p
	and	b.nr_seq_conta		= nr_seq_conta_p
	and	((coalesce(b.ie_status::text, '') = '') or (b.ie_status	not in ('M','C')));

C03 CURSOR FOR
	SELECT	a.nr_sequencia
	from	pls_conta	a,
		pls_conta_proc	b
	where	a.nr_sequencia		 = b.nr_seq_conta
	and	nr_seq_conta 		!= nr_seq_conta_p
	and	((cd_guia 		= cd_guia_referencia_p) or (cd_guia_referencia 	= cd_guia_referencia_p))
	and	nr_seq_segurado 	= nr_seq_segurado_p
	and	b.cd_procedimento 	= cd_procedimento_p
	and	b.ie_origem_proced 	= ie_origem_proced_p
	and	((coalesce(a.ie_glosa::text, '') = '')or (a.ie_glosa	= 'N'))
	and	trunc(b.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
	and	((ie_regra_w	= 'M'  and a.cd_medico_executor	= cd_medico_executor_p) or
		(ie_regra_w	= 'MP' and a.cd_medico_executor	= cd_medico_executor_p  AND a.nr_seq_grau_partic	= nr_seq_grau_partic_p) or (ie_regra_w	= 'MG' and a.ie_tipo_guia	= ie_tipo_guia_w)or (ie_regra_w 	= 'N'));

C04 CURSOR FOR
	SELECT	sum(a.qt_procedimento_imp),
		cd_procedimento,
		ie_origem_proced
	from	pls_conta	b,
		pls_conta_proc	a
	where	a.nr_seq_conta		= b.nr_sequencia
	and	trunc(a.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
	and	((to_char(a.dt_inicio_proc,'hh24:mi:ss')	= dt_inicio_proc_w)  or
		((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(a.dt_inicio_proc::text, '') = '')))
	and	((to_char(a.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = '') or (coalesce(a.dt_fim_proc::text, '') = ''))
	and	((b.nr_sequencia	= nr_seq_conta_p)
	or (coalesce(b.cd_guia_referencia,b.cd_guia)	= cd_guia_referencia_p))
	and	(a.qt_procedimento_imp IS NOT NULL AND a.qt_procedimento_imp::text <> '')
	and	b.nr_seq_segurado	= nr_seq_segurado_p
	and	((coalesce(a.ie_glosa::text, '') = '') or (a.ie_glosa = 'N'))
	and	pls_se_grupo_preco_servico(nr_seq_grupo_servico_w, a.cd_procedimento, a.ie_origem_proced) = 'S'
	and	((ie_regra_w	= 'M'  and b.cd_medico_executor	= cd_medico_executor_p) or (ie_regra_w	= 'MP' and b.cd_medico_executor	= cd_medico_executor_p
	and 	b.nr_seq_grau_partic	= nr_seq_grau_partic_p) or (ie_regra_w	= 'MG' and b.ie_tipo_guia	in (6,5))or (ie_regra_w	= 'N'))
	group by
		b.nr_sequencia,
		a.cd_procedimento,
		a.ie_origem_proced
	order by
		a.cd_procedimento,
		a.ie_origem_proced;


BEGIN
ds_retorno_w := '';
SELECT * FROM pls_obter_estrut_proc(cd_procedimento_p, ie_origem_proced_p, cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, ie_origem_proced_w) INTO STRICT cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, ie_origem_proced_w;

begin
	select	coalesce(dt_procedimento,clock_timestamp()),
		to_char(dt_inicio_proc,'hh24:mi:ss'),
		to_char(dt_fim_proc,'hh24:mi:ss')
	into STRICT	dt_procedimento_w,
		dt_inicio_proc_w,
		dt_fim_proc_w
	from	pls_conta_proc
	where	nr_sequencia	= nr_seq_conta_proc_p;
exception
when others then
	dt_procedimento_w	:= null;
	dt_inicio_proc_w	:= null;
	dt_fim_proc_w		:= null;
end;

ie_tipo_guia_w := ie_tipo_guia_p;

open C01;
loop
fetch C01 into
	nr_seq_regra_ww,
	nr_seq_grupo_servico_w,
	cd_grupo_proc_w,
	cd_especialidade_w,
	cd_area_procedimento_w,
	cd_procedimento_w,
	ie_origem_proced_ww,
	ie_regra_w,
	qt_procedimento_w,
	nr_seq_prestador_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ie_excecao_w	:= pls_regra_via_acesso_pck.pls_se_excecao_via_acesso(nr_seq_regra_ww, ie_origem_conta_p);

	if (ie_excecao_w	= 'N') then
		ie_glosa_quantidade_proced_w	:= 'S';
		ie_grupo_servico_w		:= 'S';
		if (coalesce(cd_grupo_proc_w,0)	<> 0) then
			/* Obter a quantidade de procedimentos executada por grupo pelo médico */

			if (ie_tipo_guia_w	<> 6) then
				if (ie_tipo_guia_w	<> 5) then
					begin
						select	sum(b.qt_procedimento_imp)
						into STRICT	qt_proc_conta_w
						from		pls_conta	c,
								pls_conta_proc	b,
								procedimento	a
						where	((c.nr_sequencia	= nr_seq_conta_p)
						or (coalesce(c.cd_guia_referencia,c.cd_guia)	= cd_guia_referencia_p))
						and	b.nr_seq_conta		= c.nr_sequencia
						and	a.cd_grupo_proc		= cd_grupo_proc_w
						and	cd_procedimento_p	= a.cd_procedimento
						and	ie_origem_proced_p	= a.ie_origem_proced
						and	cd_procedimento_p	= b.cd_procedimento
						and	ie_origem_proced_p	= b.ie_origem_proced
						and	c.nr_seq_segurado	= nr_seq_segurado_p
						and	coalesce(c.ie_glosa,'N')		<> 'S'
						and	trunc(b.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
						and	((to_char(b.dt_inicio_proc,'hh24:mi:ss')	= dt_inicio_proc_w)  or
							((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(b.dt_inicio_proc::text, '') = '')))
						and	((to_char(b.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
						and	(b.qt_procedimento_imp IS NOT NULL AND b.qt_procedimento_imp::text <> '')
						and	((ie_regra_w	= 'M'  and c.cd_medico_executor	= cd_medico_executor_p) or (ie_regra_w	= 'MP' and c.cd_medico_executor	= cd_medico_executor_p
										and c.nr_seq_grau_partic	= nr_seq_grau_partic_p) or (ie_regra_w	= 'MG' and c.ie_tipo_guia	= ie_tipo_guia_w)or (ie_regra_w	= 'N'));
					exception
					when others then
						qt_proc_conta_w := 0;
					end;
					if (coalesce(qt_proc_conta_w::text, '') = '') then
						qt_proc_conta_w := 0;
					end if;
				elsif (ie_regra_w	= 'MG') then
					begin
					select	sum(b.qt_procedimento_imp)
					into STRICT	qt_proc_conta_w
					from	pls_proc_participante	d,
						pls_conta		c,
						pls_conta_proc		b,
						procedimento		a
					where	((c.nr_sequencia	= nr_seq_conta_p)
					or (coalesce(c.cd_guia_referencia,c.cd_guia)	= cd_guia_referencia_p))
					and	b.nr_seq_conta		= c.nr_sequencia
					and	a.cd_grupo_proc		= cd_grupo_proc_w
					and	b.cd_procedimento	= a.cd_procedimento
					and	b.ie_origem_proced	= a.ie_origem_proced
					and	coalesce(c.ie_glosa,'N')		<> 'S'
					and	trunc(b.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
					and	((to_char(b.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w) or
						((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(b.dt_inicio_proc::text, '') = '')))
					and	((to_char(b.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
					and	(b.qt_procedimento_imp IS NOT NULL AND b.qt_procedimento_imp::text <> '')
					and	c.nr_seq_segurado	= nr_seq_segurado_p
					and	b.nr_sequencia		= d.nr_seq_conta_proc
					and	0			<	(SELECT	count(1)
										from	pls_proc_participante	x,
											pls_conta	g,
											pls_conta_proc	z,
											procedimento	y
										where	z.nr_seq_conta		= g.nr_sequencia
										and	y.cd_grupo_proc		= cd_grupo_proc_w
										and	cd_procedimento_p	= y.cd_procedimento
										and	ie_origem_proced_p	= y.ie_origem_proced
										and	cd_procedimento_p	= z.cd_procedimento
										and	coalesce(g.ie_glosa,'N')		<> 'S'
										and	c.nr_seq_segurado	= nr_seq_segurado_p
										and	ie_origem_proced_p	= z.ie_origem_proced
										and	trunc(z.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
										and	((to_char(z.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w) or
											((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(z.dt_inicio_proc::text, '') = '')))
										and	((to_char(z.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
										and	((g.nr_sequencia	= nr_seq_conta_p)
										or (coalesce(g.cd_guia_referencia,g.cd_guia)	= cd_guia_referencia_p))
										and	z.nr_sequencia		= x.nr_seq_conta_proc
										and	z.nr_sequencia		<> b.nr_sequencia
										and	x.cd_medico		= d.cd_medico
										and	g.ie_tipo_guia		= ie_tipo_guia_w);
					exception
					when others then
							qt_proc_conta_w := 0;
					end;
					if (coalesce(qt_proc_conta_w::text, '') = '') then
							qt_proc_conta_w := 0;
					end if;
				else
					open C02;
					loop
					fetch C02 into
						cd_participante_w,
						nr_seq_grau_partic_w;
					EXIT WHEN NOT FOUND; /* apply on C02 */
						begin
						begin
						select	sum(b.qt_procedimento_imp)
						into STRICT	qt_proc_conta_w
						from	pls_proc_participante	d,
							pls_conta		c,
							pls_conta_proc		b,
							procedimento		a
						where	((c.nr_sequencia	= nr_seq_conta_p)
						or (coalesce(c.cd_guia_referencia,c.cd_guia)	= cd_guia_referencia_p))
						and	b.nr_seq_conta		= c.nr_sequencia
						and	a.cd_grupo_proc		= cd_grupo_proc_w
						and	b.cd_procedimento	= a.cd_procedimento
						and	b.ie_origem_proced	= a.ie_origem_proced
						and	coalesce(c.ie_glosa,'N')		<> 'S'
						and	c.nr_seq_segurado	= nr_seq_segurado_p
						and	trunc(b.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
						and	((to_char(b.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w) or
							((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(b.dt_inicio_proc::text, '') = '')))
						and	((to_char(b.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
						and	(b.qt_procedimento_imp IS NOT NULL AND b.qt_procedimento_imp::text <> '')
						and	b.nr_sequencia		= d.nr_seq_conta_proc
						and	((ie_regra_w	= 'MP'  and d.cd_medico	= cd_participante_w
						and 	d.nr_seq_grau_partic = nr_seq_grau_partic_w)
						or (ie_regra_w	= 'N'))
						and	0		<	(SELECT	count(1)
										from	pls_proc_participante	x,
											pls_conta		g,
											pls_conta_proc		z,
											procedimento		y
										where	z.nr_seq_conta		= g.nr_sequencia
										and	y.cd_grupo_proc		= cd_grupo_proc_w
										and	cd_procedimento_p	= y.cd_procedimento
										and	ie_origem_proced_p	= y.ie_origem_proced
										and	cd_procedimento_p	= z.cd_procedimento
										and	ie_origem_proced_p	= z.ie_origem_proced
										and	coalesce(g.ie_glosa,'N')		<> 'S'
										and	trunc(z.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
										and	((to_char(z.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w)  or
											((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(z.dt_inicio_proc::text, '') = '')))
										and	((to_char(z.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
										and	g.nr_seq_segurado	= nr_seq_segurado_p
										and	((g.nr_sequencia	= nr_seq_conta_p)
										or (coalesce(g.cd_guia_referencia,g.cd_guia)	= cd_guia_referencia_p))
										and	z.nr_sequencia		= x.nr_seq_conta_proc
										and	z.nr_sequencia		<> b.nr_sequencia
										and	((ie_regra_w	= 'M'   and x.cd_medico		 = d.cd_medico) or (ie_regra_w	= 'MP'  and x.cd_medico		 = d.cd_medico
											and x.nr_seq_grau_partic = d.nr_seq_grau_partic) or (ie_regra_w	= 'MG'  and g.ie_tipo_guia	 = ie_tipo_guia_w)or (ie_regra_w	= 'N')));
						exception
						when others then
							qt_proc_conta_w := 0;
						end;
						if (coalesce(qt_proc_conta_w::text, '') = '') then
							qt_proc_conta_w := 0;
						end if;
						end;
					end loop;
					close C02;
				end if;
			elsif (ie_tipo_guia_w	= 6) then
				begin
				select	sum(b.qt_procedimento_imp)
				into STRICT	qt_proc_conta_w
				from	pls_conta	c,
					pls_conta_proc	b,
					procedimento	a
				where	((c.nr_sequencia	= nr_seq_conta_p)
				or (coalesce(c.cd_guia_referencia,c.cd_guia)	= cd_guia_referencia_p))
				and	b.nr_seq_conta		= c.nr_sequencia
				and	a.cd_grupo_proc		= cd_grupo_proc_w
				and	cd_procedimento_p	= a.cd_procedimento
				and	ie_origem_proced_p	= a.ie_origem_proced
				and	cd_procedimento_p	= b.cd_procedimento
				and	ie_origem_proced_p	= b.ie_origem_proced
				and	coalesce(c.ie_glosa,'N')		<> 'S'
				and	c.nr_seq_segurado	= nr_seq_segurado_p
				--and	b.nr_seq_proc_ref	is null
				and	trunc(b.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
				and	((to_char(b.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w)  or
					((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(b.dt_inicio_proc::text, '') = '')))
				and	((to_char(b.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
				and	(b.qt_procedimento_imp IS NOT NULL AND b.qt_procedimento_imp::text <> '')
				--and	c.ie_status		in ('L','F','A'))
				and	((ie_regra_w	= 'M'  and c.cd_medico_executor	= cd_medico_executor_p) or (ie_regra_w	= 'MP' and c.cd_medico_executor	= cd_medico_executor_p
				and 	c.nr_seq_grau_partic	= nr_seq_grau_partic_p) or (ie_regra_w	= 'MG' and c.ie_tipo_guia	in (6,5))or (ie_regra_w	= 'N'));
				exception
				when others then
					qt_proc_conta_w := 0;
				end;

				if (coalesce(qt_proc_conta_w::text, '') = '') then
					qt_proc_conta_w := 0;
				end if;

				/*select	nvl(sum(b.qt_procedimento_imp),0)
				into	qt_proc_conta_ww
				from	pls_conta	c,
					pls_conta_proc	b,
					procedimento	a
				where	b.nr_seq_conta		= c.nr_sequencia
				and	a.cd_grupo_proc		= cd_grupo_proc_w
				and	cd_procedimento_p	= a.cd_procedimento
				and	ie_origem_proced_p	= a.ie_origem_proced
				and	cd_procedimento_p	= b.cd_procedimento
				and	ie_origem_proced_p	= b.ie_origem_proced
				and	trunc(b.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
				and	to_char(b.dt_inicio_proc,'hh24:mi:ss')	= dt_inicio_proc_w
				and	to_char(b.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w
				and	b.nr_seq_proc_ref	is null
				and	nvl(c.cd_guia_referencia,c.cd_guia)	= cd_guia_referencia_p
				and	c.ie_status		in ('L','F','A')
				and	((ie_regra_w	= 'M'  and c.cd_medico_executor	= cd_medico_executor_p) or
					(ie_regra_w	= 'MP' and c.cd_medico_executor	= cd_medico_executor_p
							       and c.nr_seq_grau_partic	= nr_seq_grau_partic_p) or
					(ie_regra_w	= 'MG' and c.ie_tipo_guia	= 5));
				qt_proc_conta_w	:= qt_proc_conta_w + qt_proc_conta_ww;*/
			end if;
			if (qt_proc_conta_w	< qt_procedimento_w) then
				ie_glosa_quantidade_proced_w	:= 'N';
			end if;
		elsif (coalesce(cd_especialidade_w,0)	<> 0) then
			/* Obter a quantidade de procedimentos executada por especialidade pelo médico */

			if (ie_tipo_guia_w	<> 6) then
				if (ie_tipo_guia_w	<> 5) then
					begin
					select	sum(b.qt_procedimento_imp)
					into STRICT	qt_proc_conta_w
					from	pls_conta	c,
						pls_conta_proc	b
					where	((c.nr_sequencia	= nr_seq_conta_p)
					or (coalesce(c.cd_guia_referencia,c.cd_guia)	= cd_guia_referencia_p))
					and	b.nr_seq_conta		= c.nr_sequencia
					--and	b.nr_seq_proc_ref	is null
					and	trunc(b.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
					and	((to_char(b.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w)  or
						((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(b.dt_inicio_proc::text, '') = '')))
					and	coalesce(c.ie_glosa,'N')		<> 'S'
					and	((to_char(b.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
					and	(obter_dados_estrut_proc(cd_procedimento_p,ie_origem_proced_p,'C','E'))::numeric 	= cd_especialidade_w
					and	(b.qt_procedimento_imp IS NOT NULL AND b.qt_procedimento_imp::text <> '')
					and	c.nr_seq_segurado	= nr_seq_segurado_p
					--and	c.ie_status		in ('L','F','A'))
					--and	c.cd_medico_executor	= cd_medico_executor_p
					and	((ie_regra_w	= 'M'  and c.cd_medico_executor	= cd_medico_executor_p) or (ie_regra_w	= 'MP' and c.cd_medico_executor	= cd_medico_executor_p
					and 	c.nr_seq_grau_partic	= nr_seq_grau_partic_p) or (ie_regra_w	= 'MG' and c.ie_tipo_guia	= ie_tipo_guia_w)or (ie_regra_w	= 'N'));
					exception
					when others then
						qt_proc_conta_w := 0;
					end;

					if (coalesce(qt_proc_conta_w::text, '') = '') then
						qt_proc_conta_w := 0;
					end if;
				elsif (ie_regra_w	= 'MG') then
					begin
					select	sum(b.qt_procedimento_imp)
					into STRICT	qt_proc_conta_w
					from	pls_proc_participante	d,
						pls_conta		c,
						pls_conta_proc		b
					where	((c.nr_sequencia	= nr_seq_conta_p)
					or (coalesce(c.cd_guia_referencia,c.cd_guia)	= cd_guia_referencia_p))
					and	b.nr_seq_conta		= c.nr_sequencia
					and	(b.qt_procedimento_imp IS NOT NULL AND b.qt_procedimento_imp::text <> '')
					--and	b.nr_seq_proc_ref	is null
					and	coalesce(c.ie_glosa,'N')		<> 'S'
					and	c.nr_seq_segurado	= nr_seq_segurado_p
					and	trunc(b.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
					and	((to_char(b.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w) or
						((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(b.dt_inicio_proc::text, '') = '')))
					and	((to_char(b.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
					and	(obter_dados_estrut_proc(cd_procedimento,ie_origem_proced,'C','E'))::numeric 	= cd_especialidade_w
					--and	c.ie_status		in ('L','F','A'))
					and	b.nr_sequencia		= d.nr_seq_conta_proc
					and	0			<	(SELECT	count(1)
										from	pls_proc_participante	x,
											pls_conta		g,
											pls_conta_proc		y
										where	y.nr_seq_conta		= g.nr_sequencia
										and	(obter_dados_estrut_proc(cd_procedimento_p,ie_origem_proced_p,'C','E'))::numeric  = cd_especialidade_w
										and	((g.nr_sequencia	= nr_seq_conta_p)
										or (coalesce(g.cd_guia_referencia,g.cd_guia)	= cd_guia_referencia_p))
										--and	g.ie_status		in ('L','F','A'))
										and	y.nr_sequencia		= x.nr_seq_conta_proc
										and	y.nr_sequencia		<> b.nr_sequencia
										and	x.cd_medico		= d.cd_medico
										and	coalesce(g.ie_glosa,'N')		<> 'S'
										and	g.nr_seq_segurado	= nr_seq_segurado_p
										and	g.ie_tipo_guia		= ie_tipo_guia_w
										and	((to_char(y.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w) or
											((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(y.dt_inicio_proc::text, '') = '')))
										and	((to_char(y.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
										--and	y.nr_seq_proc_ref	is null
										and	trunc(y.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd'));
					exception
					when others then
						qt_proc_conta_w := 0;
					end;

					if (coalesce(qt_proc_conta_w::text, '') = '') then
						qt_proc_conta_w := 0;
					end if;
				else
					open C02;
					loop
					fetch C02 into
						cd_participante_w,
						nr_seq_grau_partic_w;
					EXIT WHEN NOT FOUND; /* apply on C02 */
						begin
						begin
						select	sum(b.qt_procedimento_imp)
						into STRICT	qt_proc_conta_w
						from	pls_proc_participante	d,
							pls_conta		c,
							pls_conta_proc		b
						where	((c.nr_sequencia	= nr_seq_conta_p)
						or (coalesce(c.cd_guia_referencia,c.cd_guia)	= cd_guia_referencia_p))
						and	b.nr_seq_conta		= c.nr_sequencia
						--and	b.nr_seq_proc_ref	is null
						and	trunc(b.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
						and	((to_char(b.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w) or
							((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(b.dt_inicio_proc::text, '') = '')))
						and	((to_char(b.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
						and	(obter_dados_estrut_proc(cd_procedimento,ie_origem_proced,'C','E'))::numeric 	= cd_especialidade_w
						and	(b.qt_procedimento_imp IS NOT NULL AND b.qt_procedimento_imp::text <> '')
						and	c.nr_seq_segurado	= nr_seq_segurado_p
						and	coalesce(c.ie_glosa,'N')		<> 'S'
						--and	c.ie_status		in ('L','F','A'))
						and	b.nr_sequencia		= d.nr_seq_conta_proc
						and	((ie_regra_w	= 'MP'  and d.cd_medico	= cd_participante_w
						and 	d.nr_seq_grau_partic = nr_seq_grau_partic_w)
						or (ie_regra_w	= 'N'))
						and	0			<	(SELECT	count(1)
											from	pls_proc_participante	x,
												pls_conta		g,
												pls_conta_proc		y
											where	y.nr_seq_conta		= g.nr_sequencia
											and	(obter_dados_estrut_proc(cd_procedimento_p,ie_origem_proced_p,'C','E'))::numeric  = cd_especialidade_w
											and	((g.nr_sequencia	= nr_seq_conta_p)
											or (coalesce(g.cd_guia_referencia,g.cd_guia)	= cd_guia_referencia_p))
											--and	g.ie_status		in ('L','F','A'))
											and	coalesce(g.ie_glosa,'N')		<> 'S'
											--and	y.nr_seq_proc_ref	is null
											and	trunc(y.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
											and	((to_char(y.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w) or
												((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(y.dt_inicio_proc::text, '') = '')))
											and	((to_char(y.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
											and	y.nr_sequencia		= x.nr_seq_conta_proc
											and	g.nr_seq_segurado	= nr_seq_segurado_p
											and	y.nr_sequencia		<> b.nr_sequencia
											and	((ie_regra_w	= 'M'   and x.cd_medico		 = d.cd_medico) or (ie_regra_w	= 'MP'  and x.cd_medico		 = d.cd_medico
											and 	x.nr_seq_grau_partic = d.nr_seq_grau_partic) or (ie_regra_w	= 'MG'  and g.ie_tipo_guia	 = ie_tipo_guia_w)or (ie_regra_w	= 'N')));
						exception
						when others then
							qt_proc_conta_w := 0;
						end;
						if (coalesce(qt_proc_conta_w::text, '') = '') then
							qt_proc_conta_w := 0;
						end if;

						end;
					end loop;
					close C02;
				end if;
			elsif (ie_tipo_guia_w	= 6) then
				begin
				select	sum(b.qt_procedimento_imp)
				into STRICT	qt_proc_conta_w
				from	pls_conta	c,
					pls_conta_proc	b
				where	((c.nr_sequencia	= nr_seq_conta_p)
				or (coalesce(c.cd_guia_referencia,c.cd_guia)	= cd_guia_referencia_p))
				and	b.nr_seq_conta		= c.nr_sequencia
				--and	b.nr_seq_proc_ref	is null
				and	trunc(b.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
				and	((to_char(b.dt_inicio_proc,'hh24:mi:ss')	= dt_inicio_proc_w)  or
					((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(b.dt_inicio_proc::text, '') = '')))
				and	((to_char(b.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
				and	(obter_dados_estrut_proc(cd_procedimento_p,ie_origem_proced_p,'C','E'))::numeric 	= cd_especialidade_w
				and	(b.qt_procedimento_imp IS NOT NULL AND b.qt_procedimento_imp::text <> '')
				and	c.nr_seq_segurado	= nr_seq_segurado_p
				and	coalesce(c.ie_glosa,'N')		<> 'S'
				--and	c.ie_status		in ('L','F','A'))
				and	c.cd_medico_executor	= cd_medico_executor_p
				and	((ie_regra_w	= 'M'  and c.cd_medico_executor	= cd_medico_executor_p) or (ie_regra_w	= 'MP' and c.cd_medico_executor	= cd_medico_executor_p
				and 	c.nr_seq_grau_partic	= nr_seq_grau_partic_p) or (ie_regra_w	= 'MG' and c.ie_tipo_guia	in (6,5))or (ie_regra_w	= 'N'));
				exception
				when others then
					qt_proc_conta_w := 0;
				end;
				if (coalesce(qt_proc_conta_w::text, '') = '') then
					qt_proc_conta_w := 0;
				end if;

				/*select	nvl(sum(b.qt_procedimento_imp),0)
				into	qt_proc_conta_ww
				from	pls_conta	c,
					pls_conta_proc	b
				where	b.nr_seq_conta		= c.nr_sequencia
				and	b.nr_seq_proc_ref	is null
				and	trunc(b.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
				and	to_char(b.dt_inicio_proc,'hh24:mi:ss')	= dt_inicio_proc_w
				and	to_char(b.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w
				and	to_number(obter_dados_estrut_proc(cd_procedimento_p,ie_origem_proced_p,'C','E'))	= cd_especialidade_w
				and	nvl(c.cd_guia_referencia,c.cd_guia)	= cd_guia_referencia_p
				and	c.ie_status		in ('L','F','A')
				and	((ie_regra_w	= 'M'  and c.cd_medico_executor	= cd_medico_executor_p) or
					(ie_regra_w	= 'MP' and c.cd_medico_executor	= cd_medico_executor_p
							       and c.nr_seq_grau_partic	= nr_seq_grau_partic_p) or
					(ie_regra_w	= 'MG' and c.ie_tipo_guia	= 5));

				qt_proc_conta_w	:= qt_proc_conta_w + qt_proc_conta_ww;*/
			end if;
			if (qt_proc_conta_w	< qt_procedimento_w) then
				ie_glosa_quantidade_proced_w	:= 'N';
			end if;
		elsif (coalesce(cd_area_procedimento_w,0)	<> 0) then
			/* Obter a quantidade de procedimentos executada por área pelo médico */

			if (ie_tipo_guia_w	<> 6) then
				if (ie_tipo_guia_w	<> 5) then
					begin
					select	sum(b.qt_procedimento_imp)
					into STRICT	qt_proc_conta_w
					from	pls_conta	c,
						pls_conta_proc	b
					where	((c.nr_sequencia	= nr_seq_conta_p)
					or (coalesce(c.cd_guia_referencia,c.cd_guia)	= cd_guia_referencia_p))
					and	(b.qt_procedimento_imp IS NOT NULL AND b.qt_procedimento_imp::text <> '')
					and	b.nr_seq_conta		= c.nr_sequencia
					--and	b.nr_seq_proc_ref	is null
					and	coalesce(c.ie_glosa,'N')		<> 'S'
					and	c.nr_seq_segurado	= nr_seq_segurado_p
					and	trunc(b.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
					and	((to_char(b.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w) or
						((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(b.dt_inicio_proc::text, '') = '')))
					and	((to_char(b.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
					and	(obter_dados_estrut_proc(b.cd_procedimento,b.ie_origem_proced,'C','A'))::numeric 	= cd_area_procedimento_w
					--and	c.ie_status		in ('L','F','A'))
					--and	c.cd_medico_executor	= cd_medico_executor_p
					and	((ie_regra_w	= 'M'  and c.cd_medico_executor	= cd_medico_executor_p) or (ie_regra_w	= 'MP' and c.cd_medico_executor	= cd_medico_executor_p
					and 	c.nr_seq_grau_partic	= nr_seq_grau_partic_p) or (ie_regra_w	= 'MG' and c.ie_tipo_guia	= ie_tipo_guia_w)or (ie_regra_w	= 'N'));
					exception
					when others then
						qt_proc_conta_w := 0;
					end;
					if (coalesce(qt_proc_conta_w::text, '') = '') then
						qt_proc_conta_w := 0;
					end if;
				elsif (ie_regra_w	= 'MG') then
					begin
					select	sum(b.qt_procedimento_imp)
					into STRICT	qt_proc_conta_w
					from	pls_proc_participante	d,
						pls_conta		c,
						pls_conta_proc		b
					where	((c.nr_sequencia	= nr_seq_conta_p)
					or (coalesce(c.cd_guia_referencia,c.cd_guia)	= cd_guia_referencia_p))
					and	b.nr_seq_conta	= c.nr_sequencia
					and	(b.qt_procedimento_imp IS NOT NULL AND b.qt_procedimento_imp::text <> '')
					--and	b.nr_seq_proc_ref	is null
					and	coalesce(c.ie_glosa,'N')		<> 'S'
					and	c.nr_seq_segurado	= nr_seq_segurado_p
					and	trunc(b.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
					and	((to_char(b.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w) or
						((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(b.dt_inicio_proc::text, '') = '')))
					and	((to_char(b.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
					and	(obter_dados_estrut_proc(cd_procedimento_p,ie_origem_proced_p,'C','A'))::numeric 	= cd_area_procedimento_w
					--and	c.ie_status		in ('L','F','A'))
					and	b.nr_sequencia	= d.nr_seq_conta_proc
					and	0		<	(SELECT	count(1)
									from	pls_proc_participante	x,
										pls_conta		y,
										pls_conta_proc		g
									where	g.nr_seq_conta		= y.nr_sequencia
									and	(obter_dados_estrut_proc(cd_procedimento_p,ie_origem_proced_p,'C','A'))::numeric 	= cd_area_procedimento_w
									and	((y.nr_sequencia	= nr_seq_conta_p)
									or (coalesce(y.cd_guia_referencia,y.cd_guia)	= cd_guia_referencia_p))
									--and	y.ie_status		in ('L','F','A'))
									and	coalesce(y.ie_glosa,'N')		<> 'S'
									and	y.nr_seq_segurado	= nr_seq_segurado_p
									and	g.nr_sequencia		= x.nr_seq_conta_proc
									and	x.cd_medico		= d.cd_medico
									--and	g.nr_seq_proc_ref	is null
									and	trunc(g.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
									and	((to_char(g.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w) or
										((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(g.dt_inicio_proc::text, '') = '')))
									and	((to_char(g.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
									and	g.nr_sequencia		<> b.nr_sequencia
									and	y.ie_tipo_guia		= ie_tipo_guia_w);
					exception
					when others then
						qt_proc_conta_w := 0;
					end;
					if (coalesce(qt_proc_conta_w::text, '') = '') then
						qt_proc_conta_w := 0;
					end if;
				else
					open C02;
					loop
					fetch C02 into
						cd_participante_w,
						nr_seq_grau_partic_w;
					EXIT WHEN NOT FOUND; /* apply on C02 */
						begin
						begin
						select	sum(b.qt_procedimento_imp)
						into STRICT	qt_proc_conta_w
						from	pls_proc_participante	d,
							pls_conta		c,
							pls_conta_proc		b
						where	((c.nr_sequencia	= nr_seq_conta_p)
						or (coalesce(c.cd_guia_referencia,c.cd_guia)	= cd_guia_referencia_p))
						and	b.nr_seq_conta	= c.nr_sequencia
						--and	b.nr_seq_proc_ref	is null
						and	trunc(b.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
						and	((to_char(b.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w) or
							((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(b.dt_inicio_proc::text, '') = '')))
						and	((to_char(b.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
						and	(obter_dados_estrut_proc(cd_procedimento_p,ie_origem_proced_p,'C','A'))::numeric 	= cd_area_procedimento_w
						and	(b.qt_procedimento_imp IS NOT NULL AND b.qt_procedimento_imp::text <> '')
						and	coalesce(c.ie_glosa,'N')		<> 'S'
						and	c.nr_seq_segurado	= nr_seq_segurado_p
						--and	c.ie_status		in ('L','F','A'))
						and	b.nr_sequencia	= d.nr_seq_conta_proc
						and	((ie_regra_w	= 'MP'  and d.cd_medico	= cd_participante_w
						and 	d.nr_seq_grau_partic = nr_seq_grau_partic_w)
						or (ie_regra_w	= 'N'))
						and	0		<	(SELECT	count(1)
										from	pls_proc_participante	x,
											pls_conta		y,
											pls_conta_proc		g
										where	g.nr_seq_conta		= y.nr_sequencia
										and	(obter_dados_estrut_proc(cd_procedimento_p,ie_origem_proced_p,'C','A'))::numeric 	= cd_area_procedimento_w
										and	((y.nr_sequencia	= nr_seq_conta_p)
										or (coalesce(y.cd_guia_referencia,y.cd_guia)	= cd_guia_referencia_p))
										--and	y.ie_status		in ('L','F','A'))
										and	g.nr_sequencia		= x.nr_seq_conta_proc
										--and	g.nr_seq_proc_ref	is null
										and	trunc(g.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
										and	((to_char(g.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w) or
											((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(g.dt_inicio_proc::text, '') = '')))
										and	((to_char(g.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
										and	g.nr_sequencia		<> b.nr_sequencia
										and	coalesce(y.ie_glosa,'N')		<> 'S'
										and	y.nr_seq_segurado	= nr_seq_segurado_p
										and	((ie_regra_w	= 'M'   and x.cd_medico		 = d.cd_medico) or (ie_regra_w	= 'MP'  and x.cd_medico		 = d.cd_medico
										and 	x.nr_seq_grau_partic = d.nr_seq_grau_partic) or (ie_regra_w	= 'MG'  and y.ie_tipo_guia	 = ie_tipo_guia_w)or (ie_regra_w	= 'N')));
						exception
						when others then
							qt_proc_conta_w := 0;
						end;
						if (coalesce(qt_proc_conta_w::text, '') = '') then
							qt_proc_conta_w := 0;
						end if;
						end;
					end loop;
					close C02;
				end if;
			elsif (ie_tipo_guia_w	= 6) then
				begin
				select	sum(b.qt_procedimento_imp)
				into STRICT	qt_proc_conta_w
				from	pls_conta	c,
					pls_conta_proc	b
				where	((c.nr_sequencia	= nr_seq_conta_p)
				or (coalesce(c.cd_guia_referencia,c.cd_guia)	= cd_guia_referencia_p))
				and	b.nr_seq_conta		= c.nr_sequencia
				--and	b.nr_seq_proc_ref	is null
				and	(b.qt_procedimento_imp IS NOT NULL AND b.qt_procedimento_imp::text <> '')
				and	c.nr_seq_segurado	= nr_seq_segurado_p
				and	trunc(b.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
				and	((to_char(b.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w)  or
					((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(b.dt_inicio_proc::text, '') = '')))
				and	((to_char(b.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
				and	(obter_dados_estrut_proc(b.cd_procedimento,b.ie_origem_proced,'C','A'))::numeric 	= cd_area_procedimento_w
				--and	c.ie_status		in ('L','F','A'))
				and	c.cd_medico_executor	= cd_medico_executor_p
				and	coalesce(c.ie_glosa,'N')		<> 'S'
				and	((ie_regra_w	= 'M'  and c.cd_medico_executor	= cd_medico_executor_p) or (ie_regra_w	= 'MP' and c.cd_medico_executor	= cd_medico_executor_p
				and 	c.nr_seq_grau_partic	= nr_seq_grau_partic_p) or (ie_regra_w	= 'MG' and c.ie_tipo_guia	in (6,5))or (ie_regra_w	= 'N'));
				exception
				when others then
					qt_proc_conta_w := 0;
				end;

				if (coalesce(qt_proc_conta_w::text, '') = '') then
					qt_proc_conta_w := 0;
				end if;

				/*select	nvl(sum(b.qt_procedimento_imp),0)
				into	qt_proc_conta_ww
				from	pls_conta	c,
					pls_conta_proc	b
				where	b.nr_seq_conta		= c.nr_sequencia
				and	b.nr_seq_proc_ref	is null
				and	trunc(b.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
				and	to_char(b.dt_inicio_proc,'hh24:mi:ss')	= dt_inicio_proc_w
				and	to_char(b.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w
				and	to_number(obter_dados_estrut_proc(b.cd_procedimento,b.ie_origem_proced,'C','A'))	= cd_area_procedimento_w
				and	nvl(c.cd_guia_referencia,c.cd_guia)	= cd_guia_referencia_p
				and	c.ie_status		in ('L','F','A')
				and	((ie_regra_w	= 'M'  and c.cd_medico_executor	= cd_medico_executor_p) or
					(ie_regra_w	= 'MP' and c.cd_medico_executor	= cd_medico_executor_p
							       and c.nr_seq_grau_partic	= nr_seq_grau_partic_p) or
					(ie_regra_w	= 'MG' and c.ie_tipo_guia	= 5));

				qt_proc_conta_w	:= qt_proc_conta_w + qt_proc_conta_ww;*/
			end if;
			if (qt_proc_conta_w	< qt_procedimento_w) then
				ie_glosa_quantidade_proced_w	:= 'N';
			end if;
		elsif (coalesce(cd_procedimento_w,0)	<> 0) then
			/* Obter a quantidade de procedimentos executada pelo médico */

			if (ie_tipo_guia_w	<> 6) then
				if (ie_tipo_guia_w	<> 5) then
					begin
					select	sum(a.qt_procedimento_imp)
					into STRICT	qt_proc_conta_w
					from	pls_conta	b,
						pls_conta_proc	a
					where	((b.nr_sequencia	= nr_seq_conta_p)
					or (coalesce(b.cd_guia_referencia,b.cd_guia)	= cd_guia_referencia_p))
					and	a.cd_procedimento	= cd_procedimento_w
					and	a.ie_origem_proced	= ie_origem_proced_ww
					and	a.nr_seq_conta		= b.nr_sequencia
					--and	a.nr_seq_proc_ref	is null
					and	b.nr_seq_segurado	= nr_seq_segurado_p
					and	coalesce(b.ie_glosa,'N')		<> 'S'
					and	trunc(a.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
					and	((to_char(a.dt_inicio_proc,'hh24:mi:ss')	= dt_inicio_proc_w) or
						((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(a.dt_inicio_proc::text, '') = '')))
					and	((to_char(a.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
					and	(a.qt_procedimento_imp IS NOT NULL AND a.qt_procedimento_imp::text <> '')
					--and	b.ie_status		in ('L','F','A'))
					--and	b.cd_medico_executor	= cd_medico_executor_p
					and	((ie_regra_w	= 'M'  and b.cd_medico_executor	= cd_medico_executor_p) or (ie_regra_w	= 'MP' and b.cd_medico_executor	= cd_medico_executor_p
					and 	b.nr_seq_grau_partic	= nr_seq_grau_partic_p) or (ie_regra_w	= 'MG' and b.ie_tipo_guia	= ie_tipo_guia_w)or (ie_regra_w	= 'N'));
					exception
					when others then
						qt_proc_conta_w := 0;
					end;

					if (coalesce(qt_proc_conta_w::text, '') = '') then
						qt_proc_conta_w := 0;
					end if;
				elsif (ie_regra_w	= 'MG') then
					begin
					select	sum(a.qt_procedimento_imp)
					into STRICT	qt_proc_conta_w
					from	pls_proc_participante	d,
						pls_conta		b,
						pls_conta_proc		a
					where	a.nr_seq_conta		= b.nr_sequencia
					--and	a.nr_seq_proc_ref	is null
					and	trunc(a.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
					and	((to_char(a.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w)or
						((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(a.dt_inicio_proc::text, '') = '')))
					and	((to_char(a.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
					and	((b.nr_sequencia	= nr_seq_conta_p)
					or (coalesce(b.cd_guia_referencia,b.cd_guia)	= cd_guia_referencia_p))
					--and	b.ie_status		in ('L','F','A'))
					and	coalesce(b.ie_glosa,'N')		<> 'S'
					and	(a.qt_procedimento_imp IS NOT NULL AND a.qt_procedimento_imp::text <> '')
					and	b.nr_seq_segurado	= nr_seq_segurado_p
					and	a.cd_procedimento	= cd_procedimento_w
					and	a.ie_origem_proced	= ie_origem_proced_ww
					and	a.nr_sequencia		= d.nr_seq_conta_proc
					and	0			<	(SELECT	count(1)
										from	pls_proc_participante	x,
											pls_conta		y,
											pls_conta_proc		g
										where	g.nr_seq_conta		= y.nr_sequencia
										and	((y.nr_sequencia	= nr_seq_conta_p)
										or (coalesce(y.cd_guia_referencia,y.cd_guia)	= cd_guia_referencia_p))
										--and	y.ie_status		in ('L','F','A'))
										and	g.cd_procedimento	= cd_procedimento_w
										and	g.ie_origem_proced	= ie_origem_proced_ww
										and	g.nr_sequencia		= x.nr_seq_conta_proc
										and	x.cd_medico		= d.cd_medico
										and	coalesce(y.ie_glosa,'N')		<> 'S'
										and	y.nr_seq_segurado	= nr_seq_segurado_p
										and	g.nr_sequencia		<> a.nr_sequencia
										and	y.ie_tipo_guia		= ie_tipo_guia_w
										and	((to_char(g.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w)or
											((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(g.dt_inicio_proc::text, '') = '')))
										and	((to_char(g.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
									--	and	g.nr_seq_proc_ref	is null
										and	trunc(g.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd'));
					exception
					when others then
						qt_proc_conta_w := 0;
					end;
					if (coalesce(qt_proc_conta_w::text, '') = '') then
						qt_proc_conta_w := 0;
					end if;
				else
					open C02;
					loop
					fetch C02 into
						cd_participante_w,
						nr_seq_grau_partic_w;
					EXIT WHEN NOT FOUND; /* apply on C02 */
						begin
						begin
						select	sum(a.qt_procedimento_imp)
						into STRICT	qt_proc_conta_w
						from	pls_proc_participante	d,
							pls_conta		b,
							pls_conta_proc		a
						where	a.nr_seq_conta		= b.nr_sequencia
						--and	a.nr_seq_proc_ref	is null
						and	trunc(a.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
						and	((to_char(a.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w)or
							((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(a.dt_inicio_proc::text, '') = '')))
						and	((to_char(a.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
						and	((b.nr_sequencia	= nr_seq_conta_p)
						or (coalesce(b.cd_guia_referencia,b.cd_guia)	= cd_guia_referencia_p))
						--and	b.ie_status		in ('L','F','A'))
						and	coalesce(b.ie_glosa,'N')		<> 'S'
						and	(a.qt_procedimento_imp IS NOT NULL AND a.qt_procedimento_imp::text <> '')
						and	b.nr_seq_segurado	= nr_seq_segurado_p
						and	a.cd_procedimento	= cd_procedimento_w
						and	a.ie_origem_proced	= ie_origem_proced_ww
						and	a.nr_sequencia		= d.nr_seq_conta_proc
						and	((ie_regra_w	= 'MP'  and d.cd_medico	= cd_participante_w
						and 	d.nr_seq_grau_partic = nr_seq_grau_partic_w)
						or (ie_regra_w	= 'N'))
						and	0			<	(SELECT	count(1)
											from	pls_proc_participante	x,
												pls_conta		y,
												pls_conta_proc		g
											where	g.nr_seq_conta		= y.nr_sequencia
											and	((y.nr_sequencia	= nr_seq_conta_p)
											or (coalesce(y.cd_guia_referencia,y.cd_guia)	= cd_guia_referencia_p))
											--and	y.ie_status		in ('L','F','A'))
											and	g.cd_procedimento	= cd_procedimento_w
											and	g.ie_origem_proced	= ie_origem_proced_ww
											--and	g.nr_seq_proc_ref	is null
											and	coalesce(y.ie_glosa,'N')		<> 'S'
											and	y.nr_seq_segurado	= nr_seq_segurado_p
											and	trunc(g.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
											and	((to_char(g.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w)or
												((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(g.dt_inicio_proc::text, '') = '')))
											and	((to_char(g.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
											and	g.nr_sequencia		= x.nr_seq_conta_proc
											and	g.nr_sequencia		<> a.nr_sequencia
											and	((ie_regra_w	= 'M'   and x.cd_medico		 = d.cd_medico) or (ie_regra_w	= 'MP'  and x.cd_medico		 = d.cd_medico
											and 	x.nr_seq_grau_partic = d.nr_seq_grau_partic) or (ie_regra_w	= 'MG'  and y.ie_tipo_guia	 = ie_tipo_guia_w)or (ie_regra_w	= 'N')));
						exception
						when others then
							qt_proc_conta_w := 0;
						end;

						if (coalesce(qt_proc_conta_w::text, '') = '') then
							qt_proc_conta_w := 0;
						end if;

						end;
					end loop;
					close C02;
				end if;
			elsif (ie_tipo_guia_w	= 6) then
				begin
				select	sum(a.qt_procedimento_imp)
				into STRICT	qt_proc_conta_w
				from	pls_conta	b,
					pls_conta_proc	a
				where	a.nr_seq_conta		= b.nr_sequencia
				--and	a.nr_seq_proc_ref	is null
				and	trunc(a.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
				and	((to_char(a.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w) or
					((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(a.dt_inicio_proc::text, '') = '')))
				and	((to_char(a.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
				and	((b.nr_sequencia	= nr_seq_conta_p)
				or (coalesce(b.cd_guia_referencia,b.cd_guia)	= cd_guia_referencia_p))
				--and	b.ie_status		in ('L','F','A'))
				and	coalesce(b.ie_glosa,'N')		<> 'S'
				and	b.nr_seq_segurado	= nr_seq_segurado_p
				and	(a.qt_procedimento_imp IS NOT NULL AND a.qt_procedimento_imp::text <> '')
				and	a.cd_procedimento	= cd_procedimento_w
				and	a.ie_origem_proced	= ie_origem_proced_ww
				and	b.cd_medico_executor	= cd_medico_executor_p
				and	((ie_regra_w	= 'M'  and b.cd_medico_executor	= cd_medico_executor_p) or (ie_regra_w	= 'MP' and b.cd_medico_executor	= cd_medico_executor_p
				and	 b.nr_seq_grau_partic	= nr_seq_grau_partic_p) or (ie_regra_w	= 'MG' and b.ie_tipo_guia	in (6,5))or (ie_regra_w	= 'N'));
				exception
				when others then
					qt_proc_conta_w := 0;
				end;

				if (coalesce(qt_proc_conta_w::text, '') = '') then
					qt_proc_conta_w := 0;
				end if;

				/*select	nvl(sum(a.qt_procedimento_imp),0)
				into	qt_proc_conta_ww
				from	pls_conta	b,
					pls_conta_proc	a
				where	a.nr_seq_conta		= b.nr_sequencia
				and	a.nr_seq_proc_ref	is null
				and	trunc(a.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
				and	to_char(a.dt_inicio_proc,'hh24:mi:ss')	= dt_inicio_proc_w
				and	to_char(a.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w
				and	nvl(b.cd_guia_referencia,b.cd_guia)	= cd_guia_referencia_p
				and	b.ie_status		in ('L','F','A')
				and	a.cd_procedimento	= cd_procedimento_w
				and	a.ie_origem_proced	= ie_origem_proced_ww
				and	((ie_regra_w	= 'M'  and b.cd_medico_executor	= cd_medico_executor_p) or
					(ie_regra_w	= 'MP' and b.cd_medico_executor	= cd_medico_executor_p
							       and b.nr_seq_grau_partic	= nr_seq_grau_partic_p) or
					(ie_regra_w	= 'MG' and b.ie_tipo_guia	= 5));

				qt_proc_conta_w	:= qt_proc_conta_w + qt_proc_conta_ww;*/
			end if;
			if (qt_proc_conta_w	< qt_procedimento_w) then
				ie_glosa_quantidade_proced_w	:= 'N';
			end if;
		elsif (coalesce(nr_seq_grupo_servico_w,0)	<> 0) and (pls_se_grupo_preco_servico(nr_seq_grupo_servico_w, cd_procedimento_p, ie_origem_proced_p) = 'S') then
			/* Obter a quantidade de procedimentos executada por grupo de procedimento pelo médico */

			if (ie_tipo_guia_w	<> 6)  then
				if (ie_tipo_guia_w	<> 5)  then

					cd_proced_ant_w := null;
					ie_origem_proced_ant_w := null;
					open C04;
					loop
					fetch C04 into
						qt_proc_conta_www,
						cd_procedimento_conta_w,
						ie_origem_proced_conta_w;
					EXIT WHEN NOT FOUND; /* apply on C04 */
						begin
							if (coalesce(cd_proced_ant_w,0) = 0) and (coalesce(ie_origem_proced_ant_w,0) = 0) then
								qt_proc_conta_w := coalesce(qt_proc_conta_w,0) + qt_proc_conta_www;
							elsif (cd_proced_ant_w <> cd_procedimento_conta_w) or (ie_origem_proced_ant_w <> ie_origem_proced_conta_w) then
								qt_proc_conta_w := coalesce(qt_proc_conta_w,0) + qt_proc_conta_www;
							elsif (qt_proc_conta_www > 1) then
								qt_proc_conta_w := coalesce(qt_proc_conta_w,0) + qt_proc_conta_www - 1;
							end if;
							cd_proced_ant_w := cd_procedimento_conta_w;
							ie_origem_proced_ant_w:= ie_origem_proced_conta_w;
						end;
					end loop;
					close C04;
					if (coalesce(qt_proc_conta_w,0) = 0) then
						qt_proc_conta_w := 0;
					end if;
					/*begin
					select	sum(a.qt_procedimento_imp)
					into	qt_proc_conta_w
					from	pls_conta	b,
						pls_conta_proc	a
					where	a.nr_seq_conta		= b.nr_sequencia
					--and	a.nr_seq_proc_ref	is null
					and	trunc(a.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
					and	((to_char(a.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w) or
						((dt_inicio_proc_w is null) and (a.dt_inicio_proc is null)))
					and	((to_char(a.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or
						(dt_fim_proc_w is null) or
						(a.dt_fim_proc is null))
					and	((b.nr_sequencia	= nr_seq_conta_p) or
						(b.cd_guia_referencia	= cd_guia_referencia_p) or
						(b.cd_guia		= cd_guia_referencia_p))
					and	a.qt_procedimento_imp is not null
					and	b.nr_seq_segurado	= nr_seq_segurado_p
					--and	b.ie_status		in ('L','F','A'))
					and	b.ie_glosa	<> 'S'
					and	pls_se_grupo_preco_servico(nr_seq_grupo_servico_w, a.cd_procedimento, a.ie_origem_proced) = 'S'
					--and	b.cd_medico_executor	= cd_medico_executor_p
					and	((ie_regra_w	= 'M'  and b.cd_medico_executor	= cd_medico_executor_p) or
						(ie_regra_w	= 'MP' and b.cd_medico_executor	= cd_medico_executor_p
					and 	b.nr_seq_grau_partic	= nr_seq_grau_partic_p) or
						(ie_regra_w	= 'MG' and b.ie_tipo_guia	= ie_tipo_guia_w)or
						(ie_regra_w	= 'N'));
					exception
					when others then
						qt_proc_conta_w := 0;
					end;
					if	(qt_proc_conta_w is null) then
						qt_proc_conta_w := 0;
					end if;*/
				elsif (ie_regra_w	= 'MG') then
					begin
					select	sum(a.qt_procedimento_imp)
					into STRICT	qt_proc_conta_w
					from	pls_proc_participante	d,
						pls_conta		b,
						pls_conta_proc		a
					where	a.nr_seq_conta		= b.nr_sequencia
					--and	a.nr_seq_proc_ref	is null
					and	trunc(a.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
					and	((to_char(a.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w) or
						((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(a.dt_inicio_proc::text, '') = '')))
					and	((to_char(a.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = '') or (coalesce(a.dt_fim_proc::text, '') = ''))
					and	((b.nr_sequencia	= nr_seq_conta_p)
					or (coalesce(b.cd_guia_referencia,b.cd_guia)	= cd_guia_referencia_p))
					and	(a.qt_procedimento_imp IS NOT NULL AND a.qt_procedimento_imp::text <> '')
					and	b.nr_seq_segurado	= nr_seq_segurado_p
					and	coalesce(b.ie_glosa,'N')		<> 'S'
					--and	b.ie_status		in ('L','F','A'))
					and	pls_se_grupo_preco_servico(nr_seq_grupo_servico_w, a.cd_procedimento, a.ie_origem_proced) = 'S'
					and	a.nr_sequencia		= d.nr_seq_conta_proc
					and	0			<	(SELECT	count(1)
										from	pls_proc_participante	x,
											pls_conta		y,
											pls_conta_proc		g
										where	g.nr_seq_conta		= y.nr_sequencia
										and	((y.nr_sequencia	= nr_seq_conta_p)
										or (coalesce(y.cd_guia_referencia,y.cd_guia)	= cd_guia_referencia_p))
										--and	y.ie_status		in ('L','F','A'))
										and	pls_se_grupo_preco_servico(nr_seq_grupo_servico_w, cd_procedimento_p, ie_origem_proced_p) = 'S'
										and	g.nr_sequencia		= x.nr_seq_conta_proc
										and	x.cd_medico		= d.cd_medico
										and	g.nr_sequencia		<> a.nr_sequencia
										and	y.ie_tipo_guia		= ie_tipo_guia_w
										and	coalesce(y.ie_glosa,'N')		<> 'S'
										and	y.nr_seq_segurado	= nr_seq_segurado_p
										--and	g.nr_seq_proc_ref	is null
										and	trunc(g.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
										and	((to_char(g.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w)  or
											((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(g.dt_inicio_proc::text, '') = '')))
										and	((to_char(g.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = '') or (coalesce(g.dt_fim_proc::text, '') = '')));
					exception
					when others then
						qt_proc_conta_w := 0;
					end;
					if (coalesce(qt_proc_conta_w::text, '') = '') then
						qt_proc_conta_w := 0;
					end if;
				else
					cd_proced_ant_w := null;
					ie_origem_proced_ant_w := null;
					open C04;
					loop
					fetch C04 into
						qt_proc_conta_www,
						cd_procedimento_conta_w,
						ie_origem_proced_conta_w;
					EXIT WHEN NOT FOUND; /* apply on C04 */
						begin
							if (coalesce(cd_proced_ant_w,0) = 0) and (coalesce(ie_origem_proced_ant_w,0) = 0) then
								qt_proc_conta_w := coalesce(qt_proc_conta_w,0) + qt_proc_conta_www;
							elsif (cd_proced_ant_w <> cd_procedimento_conta_w) or (ie_origem_proced_ant_w <> ie_origem_proced_conta_w) then
								qt_proc_conta_w := coalesce(qt_proc_conta_w,0) + qt_proc_conta_www;
							elsif (qt_proc_conta_www > 1) then
								qt_proc_conta_w := coalesce(qt_proc_conta_w,0) + qt_proc_conta_www - 1;
							end if;
							cd_proced_ant_w := cd_procedimento_conta_w;
							ie_origem_proced_ant_w:= ie_origem_proced_conta_w;
						end;
					end loop;
					close C04;
					if (coalesce(qt_proc_conta_w,0) = 0) then
						qt_proc_conta_w := 0;
					end if;
					/*open C02;
					loop
					fetch C02 into
						cd_participante_w,
						nr_seq_grau_partic_w;
					exit when C02%notfound;
						begin
						begin
						select	sum(a.qt_procedimento_imp)
						into	qt_proc_conta_w
						from	pls_proc_participante	d,
							pls_conta		b,
							pls_conta_proc		a
						where	a.nr_seq_conta		= b.nr_sequencia
						--and	a.nr_seq_proc_ref	is null
						and	trunc(a.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
						and	((to_char(a.dt_inicio_proc,'hh24:mi:ss')	= dt_inicio_proc_w)  or
							((dt_inicio_proc_w is null) and (a.dt_inicio_proc is null)))
						and	((to_char(a.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or
							(dt_fim_proc_w is null) or
							(a.dt_fim_proc is null))
						and	((b.nr_sequencia	= nr_seq_conta_p)
						or	(nvl(b.cd_guia_referencia,b.cd_guia)	= cd_guia_referencia_p))
						and	a.qt_procedimento_imp is not null
						--and	b.ie_status		in ('L','F','A'))
						and	pls_se_grupo_preco_servico(nr_seq_grupo_servico_w, a.cd_procedimento, a
						and	a.nr_sequencia		= d.nr_seq_conta_proc
						and	b.ie_glosa		<> 'S'
						and	b.nr_seq_segurado	= nr_seq_segurado_p
						and	((ie_regra_w	= 'MP'  and d.cd_medico	= cd_participante_w
						and 	d.nr_seq_grau_partic = nr_seq_grau_partic_w)
						or	(ie_regra_w	<> 'MP'))
						and	0			<	(select	count(1)
											from	pls_proc_participante	x,
												pls_conta		y,
												pls_conta_proc		g
											where	g.nr_seq_conta		= y.nr_sequencia
										--	and	g.nr_seq_proc_ref	is null
											and	trunc(g.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
											and	((to_char(g.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w) or
												((dt_inicio_proc_w is null) and (g.dt_inicio_proc is null)))
											and	((to_char(g.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or
												(dt_fim_proc_w is null) or
												(g.dt_fim_proc is null))
											and	((y.nr_sequencia	= nr_seq_conta_p)
											or	(nvl(y.cd_guia_referencia,y.cd_guia)	= cd_guia_referencia_p))
											--and	y.ie_status		in ('L','F','A'))
											and	y.ie_glosa		<> 'S'
											and	y.nr_seq_segurado	= nr_seq_segurado_p
											and	pls_se_grupo_preco_servico(nr_seq_grupo_servico_w, cd_procedimento
											and	g.nr_sequencia		= x.nr_seq_conta_proc
											and	g.nr_sequencia		<> a.nr_sequencia--
											and	((ie_regra_w	= 'M'   and x.cd_medico		 = d.cd_medico) or
												(ie_regra_w	= 'MP'  and x.cd_medico		 = d.cd_medico
											and 	x.nr_seq_grau_partic = d.nr_seq_grau_partic) or
												(ie_regra_w	= 'MG'  and y.ie_tipo_guia	 = ie_tipo_guia_w)or
												(ie_regra_w	= 'N')));
						exception
						when others then
							qt_proc_conta_w := 0;
						end;
						if	(qt_proc_conta_w is null) then
							qt_proc_conta_w := 0;
						end if;
						end;
					end loop;
					close C02;*/
				end if;
			elsif (ie_tipo_guia_w	= 6) then
				cd_proced_ant_w := null;
				ie_origem_proced_ant_w := null;
				open C04;
				loop
				fetch C04 into
					qt_proc_conta_www,
					cd_procedimento_conta_w,
					ie_origem_proced_conta_w;
				EXIT WHEN NOT FOUND; /* apply on C04 */
					begin
						if (coalesce(cd_proced_ant_w,0) = 0) and (coalesce(ie_origem_proced_ant_w,0) = 0) then
							qt_proc_conta_w := coalesce(qt_proc_conta_w,0) + qt_proc_conta_www;
						elsif (cd_proced_ant_w <> cd_procedimento_conta_w) or (ie_origem_proced_ant_w <> ie_origem_proced_conta_w) then
							qt_proc_conta_w := coalesce(qt_proc_conta_w,0) + qt_proc_conta_www;
						elsif (qt_proc_conta_www > 1) then
							qt_proc_conta_w := coalesce(qt_proc_conta_w,0) + qt_proc_conta_www - 1;
						end if;
						cd_proced_ant_w := cd_procedimento_conta_w;
						ie_origem_proced_ant_w:= ie_origem_proced_conta_w;
					end;
				end loop;
				close C04;
				if (coalesce(qt_proc_conta_w,0) = 0) then
					qt_proc_conta_w := 0;
				end if;
				/*select	nvl(sum(a.qt_procedimento_imp),0)
				into	qt_proc_conta_ww
				from	pls_conta	b,
					pls_conta_proc	a
				where	a.nr_seq_conta		= b.nr_sequencia
				and	a.nr_seq_proc_ref	is null
				and	trunc(a.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
				and	to_char(a.dt_inicio_proc,'hh24:mi:ss')	= dt_inicio_proc_w
				and	to_char(a.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w
				and	((b.nr_sequencia	= nr_seq_conta_p)
				or	(nvl(b.cd_guia_referencia,b.cd_guia)	= cd_guia_referencia_p)
				and	b.ie_status		in ('L','F','A'))
				and	pls_se_grupo_preco_servico(nr_seq_grupo_servico_w, a.cd_procedimento, a.ie_origem_proced) = 'S'
				and	((ie_regra_w	= 'M'  and b.cd_medico_executor	= cd_medico_executor_p) or
					(ie_regra_w	= 'MP' and b.cd_medico_executor	= cd_medico_executor_p
							       and b.nr_seq_grau_partic	= nr_seq_grau_partic_p) or
					(ie_regra_w	= 'MG' and b.ie_tipo_guia	= 5));

			qt_proc_conta_w	:= qt_proc_conta_w + qt_proc_conta_ww;*/
			end if;
			if (qt_proc_conta_w	< qt_procedimento_w) then
				ie_glosa_quantidade_proced_w	:= 'N';
			end if;
		elsif (coalesce(nr_seq_prestador_w,0)	<> 0) then
			/* Obter a quantidade de procedimentos executada por grupo de procedimento pelo médico */

			if (ie_tipo_guia_w	<> 6) then
				if (ie_tipo_guia_w	<> 5) then
					begin
					select	sum(a.qt_procedimento_imp)
					into STRICT	qt_proc_conta_w
					from	pls_conta	b,
						pls_conta_proc	a
					where	a.nr_seq_conta		= b.nr_sequencia
					--and	a.nr_seq_proc_ref	is null
					and	trunc(a.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
					and	((to_char(a.dt_inicio_proc,'hh24:mi:ss')	= dt_inicio_proc_w) or
						((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(a.dt_inicio_proc::text, '') = '')))
					and	((to_char(a.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
					and	((b.nr_sequencia	= nr_seq_conta_p)
					or (coalesce(b.cd_guia_referencia,b.cd_guia)	= cd_guia_referencia_p))
					and	(a.qt_procedimento_imp IS NOT NULL AND a.qt_procedimento_imp::text <> '')
					--and	b.ie_status		in ('L','F','A'))
					and	coalesce(b.ie_glosa,'N')		<> 'S'
					and	b.nr_seq_segurado	= nr_seq_segurado_p
					and	b.nr_seq_prestador_exec	= nr_seq_prestador_w
					--and	b.cd_medico_executor	= cd_medico_executor_p
					and	((ie_regra_w	= 'M'  and b.cd_medico_executor	= cd_medico_executor_p) or (ie_regra_w	= 'MP' and b.cd_medico_executor	= cd_medico_executor_p
					and 	b.nr_seq_grau_partic	= nr_seq_grau_partic_p) or (ie_regra_w	= 'MG' and b.ie_tipo_guia	= ie_tipo_guia_w)or (ie_regra_w	= 'N'));
					exception
					when others then
						qt_proc_conta_w := 0;
					end;
					if (coalesce(qt_proc_conta_w::text, '') = '') then
						qt_proc_conta_w := 0;
					end if;

				elsif (ie_regra_w	= 'MG') then
					begin
					select	sum(a.qt_procedimento_imp)
					into STRICT	qt_proc_conta_w
					from	pls_proc_participante	d,
						pls_conta	b,
						pls_conta_proc	a
					where	a.nr_seq_conta		= b.nr_sequencia
					---and	a.nr_seq_proc_ref	is null
					and	trunc(a.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
					and	((to_char(a.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w) or
						((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(a.dt_inicio_proc::text, '') = '')))
					and	((to_char(a.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
					and	coalesce(b.ie_glosa,'N')		<> 'S'
					and	b.nr_seq_segurado	= nr_seq_segurado_p
					and	((b.nr_sequencia	= nr_seq_conta_p)
					or (coalesce(b.cd_guia_referencia,b.cd_guia)	= cd_guia_referencia_p))
					and	(a.qt_procedimento_imp IS NOT NULL AND a.qt_procedimento_imp::text <> '')
					--and	b.ie_status		in ('L','F','A'))
					and	b.nr_seq_prestador_exec	= nr_seq_prestador_w
					and	a.nr_sequencia		= d.nr_seq_conta_proc
					and	0			<	(SELECT	count(1)
										from	pls_proc_participante	x,
											pls_conta		y,
											pls_conta_proc		g
										where	g.nr_seq_conta		= y.nr_sequencia
										--and	g.nr_seq_proc_ref	is null
										and	((y.nr_sequencia	= nr_seq_conta_p)
										or (coalesce(y.cd_guia_referencia,y.cd_guia)	= cd_guia_referencia_p))
										--and	y.ie_status		in ('L','F','A'))
										and	y.nr_seq_prestador_exec	= nr_seq_prestador_w
										and	g.nr_sequencia		= x.nr_seq_conta_proc
										and	x.cd_medico		= d.cd_medico
										and	g.nr_sequencia		<> a.nr_sequencia
										and	y.ie_tipo_guia		= ie_tipo_guia_w
										and	coalesce(y.ie_glosa,'N')		<> 'S'
										and	y.nr_seq_segurado	= nr_seq_segurado_p
										and	((to_char(g.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w) or
											((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(g.dt_inicio_proc::text, '') = '')))
										and	((to_char(g.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = '')));
					exception
					when others then
							qt_proc_conta_w := 0;
					end;
					if (coalesce(qt_proc_conta_w::text, '') = '') then
						qt_proc_conta_w := 0;
					end if;
				else
					open C02;
					loop
					fetch C02 into
						cd_participante_w,
						nr_seq_grau_partic_w;
					EXIT WHEN NOT FOUND; /* apply on C02 */
						begin
						begin
						select	sum(a.qt_procedimento_imp)
						into STRICT	qt_proc_conta_w
						from	pls_proc_participante	d,
							pls_conta		b,
							pls_conta_proc		a
						where	a.nr_seq_conta		= b.nr_sequencia
						--and	a.nr_seq_proc_ref	is null
						and	trunc(a.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
						and	((to_char(a.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w) or
							((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(a.dt_inicio_proc::text, '') = '')))
						and	((to_char(a.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
						and	((b.nr_sequencia	= nr_seq_conta_p)
						or (coalesce(b.cd_guia_referencia,b.cd_guia)	= cd_guia_referencia_p))
						and	(a.qt_procedimento_imp IS NOT NULL AND a.qt_procedimento_imp::text <> '')
						--and	b.ie_status		in ('L','F','A'))
						and	b.nr_seq_segurado	= nr_seq_segurado_p
						and	b.nr_seq_prestador_exec	= nr_seq_prestador_w
						and	coalesce(b.ie_glosa,'N')		<> 'S'
						and	a.nr_sequencia		= d.nr_seq_conta_proc
						and	((ie_regra_w	= 'MP'  and d.cd_medico	= cd_participante_w
						and	d.nr_seq_grau_partic = nr_seq_grau_partic_w)
						or (ie_regra_w	= 'N'))
						and	0			<	(SELECT	count(1)
											from	pls_proc_participante	x,
												pls_conta		y,
												pls_conta_proc		g
											where	g.nr_seq_conta		= y.nr_sequencia
											--and	g.nr_seq_proc_ref	is null
											and	trunc(g.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
											and	((to_char(g.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w)  or
												((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(g.dt_inicio_proc::text, '') = '')))
											and	((to_char(g.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
											and	((y.nr_sequencia	= nr_seq_conta_p)
											or (coalesce(y.cd_guia_referencia,y.cd_guia)	= cd_guia_referencia_p))
											--and	y.ie_status		in ('L','F','A'))
											and	y.nr_seq_prestador_exec	= nr_seq_prestador_w
											and	coalesce(y.ie_glosa,'N')		<> 'S'
											and	y.nr_seq_segurado	= nr_seq_segurado_p
											and	g.nr_sequencia		= x.nr_seq_conta_proc
											and	g.nr_sequencia		<> a.nr_sequencia
											and	((ie_regra_w	= 'M'   and x.cd_medico		 = d.cd_medico) or (ie_regra_w	= 'MP'  and x.cd_medico		 = d.cd_medico
											and 	x.nr_seq_grau_partic = d.nr_seq_grau_partic) or (ie_regra_w	= 'MG'  and y.ie_tipo_guia	 = ie_tipo_guia_w)or (ie_regra_w	= 'N')));
						exception
						when others then
							qt_proc_conta_w := 0;
						end;
						if (coalesce(qt_proc_conta_w::text, '') = '') then
							qt_proc_conta_w := 0;
						end if;
						end;
					end loop;
					close C02;
				end if;
			elsif (ie_tipo_guia_w	= 6) then
				begin
				select	sum(a.qt_procedimento_imp)
				into STRICT	qt_proc_conta_w
				from	pls_conta	b,
					pls_conta_proc	a
				where	a.nr_seq_conta		= b.nr_sequencia
				--and	a.nr_seq_proc_ref	is null
				and	trunc(a.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
				and	((to_char(a.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w)  or
					((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(a.dt_inicio_proc::text, '') = '')))
				and	((to_char(a.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
				and	((b.nr_sequencia	= nr_seq_conta_p)
				or (coalesce(b.cd_guia_referencia,b.cd_guia)	= cd_guia_referencia_p))
				and	(a.qt_procedimento_imp IS NOT NULL AND a.qt_procedimento_imp::text <> '')
				--and	b.ie_status		in ('L','F','A'))
				and	coalesce(b.ie_glosa,'N')		<> 'S'
				and	b.nr_seq_segurado	= nr_seq_segurado_p
				and	b.nr_seq_prestador_exec	= nr_seq_prestador_w
				and	b.cd_medico_executor	= cd_medico_executor_p
				and	((ie_regra_w	= 'M'  and b.cd_medico_executor	= cd_medico_executor_p) or (ie_regra_w	= 'MP' and b.cd_medico_executor	= cd_medico_executor_p
				and 	b.nr_seq_grau_partic	= nr_seq_grau_partic_p) or (ie_regra_w	= 'MG' and b.ie_tipo_guia	in (6,5))or (ie_regra_w	= 'N'));
				exception
				when others then
					qt_proc_conta_w := 0;
				end;
				if (coalesce(qt_proc_conta_w::text, '') = '') then
					qt_proc_conta_w := 0;
				end if;
				/*select	nvl(sum(a.qt_procedimento_imp),0)
				into	qt_proc_conta_ww
				from	pls_conta	b,
					pls_conta_proc	a
				where	a.nr_seq_conta		= b.nr_sequencia
				and	a.nr_seq_proc_ref	is null
				and	trunc(a.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
				and	to_char(a.dt_inicio_proc,'hh24:mi:ss')	= dt_inicio_proc_w
				and	to_char(a.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w
				and	nvl(b.cd_guia_referencia,b.cd_guia)	= cd_guia_referencia_p
				and	b.ie_status		in ('L','F','A')
				and	b.nr_seq_prestador_exec	= nr_seq_prestador_w
				and	((ie_regra_w	= 'M'  and b.cd_medico_executor	= cd_medico_executor_p) or
					(ie_regra_w	= 'MP' and b.cd_medico_executor	= cd_medico_executor_p
							       and b.nr_seq_grau_partic	= nr_seq_grau_partic_p) or
					(ie_regra_w	= 'MG' and b.ie_tipo_guia	= 5));
				qt_proc_conta_w	:= qt_proc_conta_w + qt_proc_conta_ww;*/
			end if;
			if (qt_proc_conta_w	< qt_procedimento_w) then
				ie_glosa_quantidade_proced_w	:= 'N';
			end if;
		else
			/* Obter a quantidade de procedimentos executada por grupo de procedimento pelo médico */

			if (ie_tipo_guia_w	<> 6) then
				if (ie_tipo_guia_w	<> 5) then
					begin
					select	sum(a.qt_procedimento_imp)
					into STRICT	qt_proc_conta_w
					from	pls_conta		b,
						pls_conta_proc	a
					where	a.nr_seq_conta		= b.nr_sequencia
					--and	a.nr_seq_proc_ref	is null
					and	trunc(a.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
					and	((to_char(a.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w)  or
						((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(a.dt_inicio_proc::text, '') = '')))
					and	((to_char(a.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
					and	((b.nr_sequencia	= nr_seq_conta_p)
					or (coalesce(b.cd_guia_referencia,b.cd_guia)	= cd_guia_referencia_p))
					and	(a.qt_procedimento_imp IS NOT NULL AND a.qt_procedimento_imp::text <> '')
					--and	b.ie_status		in ('L','F','A'))
					--and	b.cd_medico_executor	= cd_medico_executor_p
					and	coalesce(b.ie_glosa,'N')		<> 'S'
					and	b.nr_seq_segurado	= nr_seq_segurado_p
					and	((ie_regra_w	= 'M'  and b.cd_medico_executor	= cd_medico_executor_p) or (ie_regra_w	= 'MP' and b.cd_medico_executor	= cd_medico_executor_p
					and 	b.nr_seq_grau_partic	= nr_seq_grau_partic_p) or (ie_regra_w	= 'MG' and b.ie_tipo_guia	= ie_tipo_guia_w)or (ie_regra_w	= 'N'));
					exception
					when others then
						qt_proc_conta_w := 0;
					end;
					if (coalesce(qt_proc_conta_w::text, '') = '') then
						qt_proc_conta_w := 0;
					end if;
				elsif (ie_regra_w	= 'MG') then
					begin
					select	sum(a.qt_procedimento_imp)
					into STRICT	qt_proc_conta_w
					from	pls_proc_participante	d,
						pls_conta		b,
						pls_conta_proc		a
					where	a.nr_seq_conta		= b.nr_sequencia
					and	trunc(a.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
					and	((to_char(a.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w) or
						((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(a.dt_inicio_proc::text, '') = '')))
					and	((to_char(a.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
					and	((b.nr_sequencia	= nr_seq_conta_p)
					or (coalesce(b.cd_guia_referencia,b.cd_guia)	= cd_guia_referencia_p))
					and	(a.qt_procedimento_imp IS NOT NULL AND a.qt_procedimento_imp::text <> '')
					and	b.nr_seq_segurado	= nr_seq_segurado_p
					--and	b.ie_status		in ('L','F','A'))
					and	coalesce(b.ie_glosa,'N')		<> 'S'
					and	a.nr_sequencia		= d.nr_seq_conta_proc
					and	0			<	(SELECT	count(1)
										from	pls_proc_participante	x,
											pls_conta		y,
											pls_conta_proc		g
										where	g.nr_seq_conta		= y.nr_sequencia
									--	and	g.nr_seq_proc_ref	is null
										and	trunc(g.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
										and	((to_char(g.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w) or
											((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(g.dt_inicio_proc::text, '') = '')))
										and	((to_char(g.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
										and	((y.nr_sequencia	= nr_seq_conta_p)
										or (coalesce(y.cd_guia_referencia,y.cd_guia)	= cd_guia_referencia_p))
										--and	y.ie_status		in ('L','F','A'))
										and	g.nr_sequencia		= x.nr_seq_conta_proc
										and	y.nr_seq_segurado	= nr_seq_segurado_p
										and	x.cd_medico		= d.cd_medico
										and	coalesce(y.ie_glosa,'N')		<> 'S'
										and	g.nr_sequencia		<> a.nr_sequencia
										and	y.ie_tipo_guia		= ie_tipo_guia_w);
					exception
					when others then
						qt_proc_conta_w := 0;
					end;
					if (coalesce(qt_proc_conta_w::text, '') = '') then
						qt_proc_conta_w := 0;
					end if;
				else
					open C02;
					loop
					fetch C02 into
						cd_participante_w,
						nr_seq_grau_partic_w;
					EXIT WHEN NOT FOUND; /* apply on C02 */
						begin
						begin
						select	sum(a.qt_procedimento_imp)
						into STRICT	qt_proc_conta_w
						from	pls_proc_participante	d,
							pls_conta		b,
							pls_conta_proc		a
						where	a.nr_seq_conta		= b.nr_sequencia
						--and	a.nr_seq_proc_ref	is null
						and	trunc(a.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
						and	((to_char(a.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w) or
							((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(a.dt_inicio_proc::text, '') = '')))
						and	((to_char(a.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
						and	((b.nr_sequencia	= nr_seq_conta_p)
						or (coalesce(b.cd_guia_referencia,b.cd_guia)	= cd_guia_referencia_p))
						and	(a.qt_procedimento_imp IS NOT NULL AND a.qt_procedimento_imp::text <> '')
						--and	b.ie_status		in ('L','F','A'))
						and	a.nr_sequencia		= d.nr_seq_conta_proc
						and	b.nr_seq_segurado	= nr_seq_segurado_p
						and	coalesce(b.ie_glosa,'N')		<> 'S'
						and	((ie_regra_w	= 'MP'  and d.cd_medico	= cd_participante_w
						and 	d.nr_seq_grau_partic = nr_seq_grau_partic_w)
						or (ie_regra_w	= 'N'))
						and	0			<	(SELECT	count(1)
											from	pls_proc_participante	x,
												pls_conta		y,
												pls_conta_proc		g
											where	g.nr_seq_conta		= y.nr_sequencia
											--and	g.nr_seq_proc_ref	is null
											and	trunc(g.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
											and	((to_char(g.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w)  or
												((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(g.dt_inicio_proc::text, '') = '')))
											and	((to_char(g.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
											and	((y.nr_sequencia	= nr_seq_conta_p)
											or (coalesce(y.cd_guia_referencia,y.cd_guia)	= cd_guia_referencia_p))
											--and	y.ie_status		in ('L','F','A'))
											and	g.nr_sequencia		= x.nr_seq_conta_proc
											and	g.nr_sequencia		<> a.nr_sequencia
											and	coalesce(y.ie_glosa,'N')		<> 'S'
											and	y.nr_seq_segurado	= nr_seq_segurado_p
											and	((ie_regra_w	= 'M'   and x.cd_medico		 = d.cd_medico) or (ie_regra_w	= 'MP'  and x.cd_medico		 = d.cd_medico
											and	x.nr_seq_grau_partic = d.nr_seq_grau_partic) or (ie_regra_w	= 'MG'  and y.ie_tipo_guia	 = ie_tipo_guia_w)or (ie_regra_w	= 'N')));
						exception
						when others then
							qt_proc_conta_w := 0;
						end;
						if (coalesce(qt_proc_conta_w::text, '') = '') then
							qt_proc_conta_w := 0;
						end if;
						end;
					end loop;
					close C02;
				end if;
			elsif (ie_tipo_guia_w	= 6) then
				begin
				select	sum(a.qt_procedimento_imp)
				into STRICT	qt_proc_conta_w
				from	pls_conta	b,
					pls_conta_proc	a
				where	a.nr_seq_conta		= b.nr_sequencia
				--and	a.nr_seq_proc_ref	is null
				and	trunc(a.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
				and	((to_char(a.dt_inicio_proc,'hh24:mi:ss')= dt_inicio_proc_w) or
					((coalesce(dt_inicio_proc_w::text, '') = '') and (coalesce(a.dt_inicio_proc::text, '') = '')))
				and	((to_char(a.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w) or (coalesce(dt_fim_proc_w::text, '') = ''))
				and	((b.nr_sequencia	= nr_seq_conta_p)
				or (coalesce(b.cd_guia_referencia,b.cd_guia)	= cd_guia_referencia_p))
				and	(a.qt_procedimento_imp IS NOT NULL AND a.qt_procedimento_imp::text <> '')
				--and	b.ie_status		in ('L','F','A'))
				and	coalesce(b.ie_glosa,'N')		<> 'S'
				and	b.nr_seq_segurado	= nr_seq_segurado_p
				and	b.cd_medico_executor	= cd_medico_executor_p
				and	((ie_regra_w	= 'M'  and b.cd_medico_executor	= cd_medico_executor_p) or (ie_regra_w	= 'MP' and b.cd_medico_executor	= cd_medico_executor_p
				and	b.nr_seq_grau_partic	= nr_seq_grau_partic_p) or (ie_regra_w	= 'MG' and b.ie_tipo_guia	in (6,5))or (ie_regra_w	= 'N'));
				exception
				when others then
					qt_proc_conta_w:= 0;
				end;
				if (coalesce(qt_proc_conta_w::text, '') = '') then
						qt_proc_conta_w := 0;
				end if;
				/*select	nvl(sum(a.qt_procedimento_imp),0)
				into	qt_proc_conta_ww
				from	pls_conta	b,
					pls_conta_proc	a
				where	a.nr_seq_conta		= b.nr_sequencia
				and	a.nr_seq_proc_ref	is null
				and	trunc(a.dt_procedimento,'dd')	= trunc(dt_procedimento_w,'dd')
				and	to_char(a.dt_inicio_proc,'hh24:mi:ss')	= dt_inicio_proc_w
				and	to_char(a.dt_fim_proc,'hh24:mi:ss')	= dt_fim_proc_w
				and	nvl(b.cd_guia_referencia,b.cd_guia)	= cd_guia_referencia_p
				and	b.ie_status		in ('L','F','A')
				and	((ie_regra_w	= 'M'  and b.cd_medico_executor	= cd_medico_executor_p) or
					(ie_regra_w	= 'MP' and b.cd_medico_executor	= cd_medico_executor_p
							       and b.nr_seq_grau_partic	= nr_seq_grau_partic_p) or
					(ie_regra_w	= 'MG' and b.ie_tipo_guia	= 5));
				qt_proc_conta_w	:= qt_proc_conta_w + qt_proc_conta_ww;*/
			end if;
			if (qt_proc_conta_w	< qt_procedimento_w) then
				ie_glosa_quantidade_proced_w	:= 'N';
			end if;
		end if;
		--end if;
		/* Grupo de serviços */

		ie_grupo_servico_w	:= 'S';
		if (coalesce(nr_seq_grupo_servico_w,0) > 0) then
			ie_grupo_servico_w	:= pls_se_grupo_preco_servico(nr_seq_grupo_servico_w, cd_procedimento_p, ie_origem_proced_w);
		end if;

		if	(ie_grupo_servico_w		= 'S' AND ie_glosa_quantidade_proced_w	= 'S') then
			nr_seq_regra_w		:= nr_seq_regra_ww;
			open C03;
			loop
			fetch C03 into
				nr_seq_conta_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin
				ds_retorno_w := ds_retorno_w||nr_seq_conta_w||' ,';
				end;
			end loop;
			close C03;
		end if;
	end if;
	end;
end loop;
close C01;
if (coalesce(nr_seq_regra_w,0) > 0) then
	select	coalesce(max(a.ie_via_obrigatoria),'N')
	into STRICT	ie_via_obrigatoria_w
	from	pls_regra_via_acesso	a
	where	a.nr_sequencia	= nr_seq_regra_w;
end if;
select	count(1)
into STRICT	qt_via_acesso_w
from	pls_via_acesso_taxa
where	nr_seq_regra	= nr_seq_regra_w;
if (qt_via_acesso_w <> 0) then
	select	count(1)
	into STRICT	qt_via_acesso_w
	from	pls_via_acesso_taxa
	where	nr_seq_regra	= nr_seq_regra_w
	and		ie_via_acesso	= ie_via_acesso_p;
	if (qt_via_acesso_w = 0) then
		ie_consistido_w	:= 'N';
	end if;
	if (ie_via_obrigatoria_w	= 'N') and (coalesce(ie_via_acesso_p::text, '') = '') then
		ie_consistido_w	:= 'S';
	end if;
end if;
ds_retorno_w := '';
if (ie_via_obrigatoria_w	= 'S') /*and
	(ie_via_acesso_p is null) */
then
	ie_consistido_w	:= 'N';
end if;
ds_retorno_p 		:= ds_retorno_w;
nr_seq_regra_p		:= nr_seq_regra_w;
ie_consistido_p		:= ie_consistido_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consistir_via_acesso ( cd_procedimento_p bigint, ie_origem_proced_p bigint, ie_via_acesso_p text, nr_seq_prestador_p bigint, qt_procedimento_p bigint, nr_seq_conta_p bigint, cd_medico_executor_p text, nr_seq_grau_partic_p bigint, cd_guia_referencia_p text, nr_seq_conta_proc_p bigint, nm_usuario_p text, ie_tipo_guia_p text, nr_seq_segurado_p bigint, ie_origem_conta_p pls_conta.ie_origem_conta%type, nr_seq_regra_p INOUT bigint, ie_consistido_p INOUT text, ds_retorno_p INOUT text) FROM PUBLIC;

