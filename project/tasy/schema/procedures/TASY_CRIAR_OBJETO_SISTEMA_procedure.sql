-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE campos AS (ds		varchar(32760));


CREATE OR REPLACE PROCEDURE tasy_criar_objeto_sistema (nm_objeto_p text, nm_owner_origem_p text) AS $body$
DECLARE

type Vetor is table of  campos index by integer;

ds_script_vetor			Vetor;
ds_sql_w			varchar(32760)	:= '';
ds_comando_w			text;
ds_comando_pck_w		varchar(32760) := '';
vl_retorno_w			double precision	:= 0;
ie_tipo_objeto_w		varchar(15);
c001				integer;
ie_ok_w				varchar(1)	:= 'N';
qt_contador_w			bigint	:= 0;
pos_sep_pck_w			bigint;
qt_registro_w			bigint;
nm_owner_origem_w		varchar(30);
nm_owner_atual_w		varchar(30);
nm_tablespace_w			varchar(50);


BEGIN

ds_script_vetor[1].ds := '';
ds_script_vetor[2].ds := '';
ds_script_vetor[3].ds := '';
ds_script_vetor[4].ds := '';
ds_script_vetor[5].ds := '';

nm_owner_origem_w := nm_owner_origem_p;

select	user
into STRICT	nm_owner_atual_w
;

if ( coalesce(nm_owner_origem_p::text, '') = '' ) or ( nm_owner_origem_p = '' ) or ( nm_owner_atual_w = nm_owner_origem_w ) then
	nm_owner_origem_w := 'TASY_VERSAO';
end if;


select	' TABLESPACE ' || obter_tablespace_tab_temp('W_OBJETO_SISTEMA')
into STRICT	nm_tablespace_w
;

select 	count(*)
into STRICT	qt_registro_w
from	user_tables
where	table_name = 'W_OBJETO_SISTEMA';

if ( qt_registro_w = 0 ) then
	CALL exec_sql_dinamico('','create TABLE w_objeto_sistema( ds_script_criacao clob,ie_tipo_objeto varchar2(15)) '|| nm_tablespace_w);
else
	CALL exec_sql_dinamico('','truncate table w_objeto_sistema');
end if;

if (nm_owner_origem_p = 'WHEB') then
	EXECUTE 'insert into w_objeto_sistema select TO_LOB(ds_script_criacao),ie_tipo_objeto from objeto_sistema where nm_objeto = upper(' || chr(39) || nm_objeto_p || chr(39) ||')';
else
	EXECUTE 'insert into w_objeto_sistema select TO_LOB(ds_script_criacao),ie_tipo_objeto from '|| nm_owner_origem_w ||'.objeto_sistema where nm_objeto = upper(' || chr(39) || nm_objeto_p || chr(39) ||')';
end if;


/*if	(nm_objeto_p in ('AGHOS_CARGA_SOLICITACOES','SOLICITACAO_TASY_AGHOS_INSERT','SUS_LIBERAR_LAUDO_AGHOS','AGHOS_GERAR_AGENDAMENTO','AGHOS_SOLICITACAO_INTERNACAO','AGHOS_AUTORIZA_SOLICIT','SOL_AGHOS_UPDATE','SOLICITACAO_TASY_AGHOS_UPDATE')) then
	insert into logxxxxx_tasy (DT_ATUALIZACAO, NM_USUARIO, CD_LOG, DS_LOG) values (sysdate, 'Anderson', 476, nm_objeto_p);
end	if;*/
commit;

ds_sql_w := ' '||
	' select 	ds_script_criacao, ' ||
	'		ie_tipo_objeto ' ||
	' from 		w_objeto_sistema';

c001 := DBMS_SQL.OPEN_CURSOR;
DBMS_SQL.PARSE(c001, ds_sql_w, dbms_sql.native);

dbms_sql.define_column(c001,1,ds_comando_w);
dbms_sql.define_column(c001,2,ie_tipo_objeto_w,15);

vl_retorno_w := DBMS_SQL.EXECUTE(c001);
vl_retorno_w := DBMS_SQL.fetch_rows(c001);

DBMS_SQL.COLUMN_VALUE(c001, 1, ds_comando_w);
DBMS_SQL.COLUMN_VALUE(c001, 2, ie_tipo_objeto_w);
DBMS_SQL.CLOSE_CURSOR(c001);


ds_comando_w	:= replace(ds_comando_w,chr(13), ' ');
ds_comando_w	:= replace(ds_comando_w,'  ',' ');

if (ie_tipo_objeto_w = 'Package') then
	ds_comando_pck_w := substr(ds_comando_w,1,32000);
	pos_sep_pck_w	 := position('BODY' in upper(ds_comando_pck_w));
	ds_comando_pck_w := substr(ds_comando_w,1,pos_sep_pck_w);
	
	while(ie_ok_w	= 'N') and (qt_contador_w < 100) LOOP
		if (length(ds_comando_pck_w) = 0) or (substr(ds_comando_pck_w, length(ds_comando_pck_w), 1) = ';') then
			ie_ok_w		:= 'S';
		else
			ds_comando_pck_w:= substr(ds_comando_pck_w,1, length(ds_comando_pck_w) -1);
		end if;
		if (substr(upper(ds_comando_pck_w), length(ds_comando_pck_w)-6, 6) = 'CREATE') then
			pos_sep_pck_w := pos_sep_pck_w - qt_contador_w - 7;
		end if;
		qt_contador_w := qt_contador_w + 1;
	END LOOP;
	EXECUTE ds_comando_pck_w;
	ds_comando_w := substr(ds_comando_w,pos_sep_pck_w,length(ds_comando_w));		
	qt_contador_w := 0;
	ie_ok_w := 'N';
end if;

while(ie_ok_w	= 'N') and (qt_contador_w < 100) LOOP
	if (length(ds_comando_w) = 0) or (substr(ds_comando_w, length(ds_comando_w), 1) = ';') then
		ie_ok_w		:= 'S';
	else
		ds_comando_w	:= substr(ds_comando_w,1, length(ds_comando_w) -1);
	end if;
	qt_contador_w := qt_contador_w + 1;
END LOOP;
if (ie_tipo_objeto_w = 'View') or (ie_tipo_objeto_w = 'Sequence') then
	ds_comando_w	:= substr(ds_comando_w,1, length(ds_comando_w) -1);
end if;

ds_script_vetor[1].ds := substr(ds_comando_w,1,32000);
ds_script_vetor[2].ds := substr(ds_comando_w,32001,64000);
ds_script_vetor[3].ds := substr(ds_comando_w,64001,96000);
ds_script_vetor[4].ds := substr(ds_comando_w,96001,128000);
ds_script_vetor[5].ds := substr(ds_comando_w,128001,160000);

EXECUTE ds_script_vetor[1].ds || ds_script_vetor[2].ds || ds_script_vetor[3].ds || ds_script_vetor[4].ds || ds_script_vetor[5].ds;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_criar_objeto_sistema (nm_objeto_p text, nm_owner_origem_p text) FROM PUBLIC;

