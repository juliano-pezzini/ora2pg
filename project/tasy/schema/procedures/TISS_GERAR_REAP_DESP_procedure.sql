-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_gerar_reap_desp ( nr_seq_reap_conta_p bigint, nm_usuario_p text) AS $body$
DECLARE


dt_atualizacao_w		timestamp;
dt_despesa_w		timestamp;
ie_tipo_despesa_w		varchar(3);
cd_item_w		varchar(20);
ds_item_w		varchar(255);
nr_sequencia_w		bigint;
qt_despesa_w		double precision;
tx_reducao_acrescimo_w	double precision;
vl_unitario_w		double precision;
vl_despesa_w		double precision;
ie_tiss_tipo_guia_w		varchar(15);
tx_reducao_acresc_w	double precision;
cd_autorizacao_w		varchar(255);
ds_justificativa_w		varchar(255);
nr_seq_tiss_tabela_w		bigint;
cd_edicao_amb_w			varchar(10);
cd_convenio_w			bigint;
cd_estabelecimento_w		bigint;
ie_digitos_desp_w		varchar(10);
ie_procedimento_w		varchar(10);
cd_proc_envio_w			varchar(20);
ds_proc_envio_w			varchar(255);

c01 CURSOR FOR
SELECT	dt_atualizacao,
	ie_tipo_despesa,
	dt_despesa,
	coalesce(cd_proc_convenio,cd_procedimento),
	substr(obter_descricao_procedimento(cd_procedimento, ie_origem_proced),1,254),
	qt_despesa,
	tx_reducao_acresc,
	vl_unitario,
	vl_despesa,
	coalesce(tx_reducao_acresc,0),
	substr(ds_justificativa_revisao,1,254),
	nr_seq_tiss_tabela,
	'S' ie_procedimento,
	cd_proc_envio,
	ds_proc_envio
from	tiss_reap_desp
where	nr_seq_conta	= nr_seq_reap_conta_p
and	coalesce(cd_material::text, '') = ''

union all

select	dt_atualizacao,
	ie_tipo_despesa,
	dt_despesa,
	coalesce(cd_mat_convenio,cd_material) cd_item,
	substr(obter_desc_material(cd_material),1,254),
	qt_despesa,
	tx_reducao_acresc,
	vl_unitario,
	vl_despesa,
	coalesce(tx_reducao_acresc,0),
	substr(ds_justificativa_revisao,1,254),
	nr_seq_tiss_tabela,
	'N' ie_procedimento,
	cd_proc_envio,
	ds_proc_envio
from	tiss_reap_desp
where	nr_seq_conta	= nr_seq_reap_conta_p
and	coalesce(cd_procedimento::text, '') = '';


BEGIN

select	ie_tiss_tipo_guia,
	cd_autorizacao
into STRICT	ie_tiss_tipo_guia_w,
	cd_autorizacao_w
from	tiss_reap_conta
where	nr_sequencia	= nr_seq_reap_conta_p;

select	max(a.cd_convenio),
	max(a.cd_estabelecimento)
into STRICT	cd_convenio_w,
	cd_estabelecimento_w
from	tiss_reap_lote a,
	tiss_reap_conta b
where	b.nr_seq_lote	= a.nr_sequencia
and	b.nr_sequencia	= nr_seq_reap_conta_p;

select	coalesce(max(ie_digitos_desp), 'N')
into STRICT	ie_digitos_desp_w
from	tiss_parametros_convenio
where	cd_estabelecimento	= cd_estabelecimento_w
and	cd_convenio		= cd_convenio_w;

open c01;
loop
fetch c01 into
	dt_atualizacao_w,
	ie_tipo_despesa_w,
	dt_despesa_w,
	cd_item_w,
	ds_item_w,
	qt_despesa_w,
	tx_reducao_acrescimo_w,
	vl_unitario_w,
	vl_despesa_w,
	tx_reducao_acresc_w,
	ds_justificativa_w,
	nr_seq_tiss_tabela_w,
	ie_procedimento_w,
	cd_proc_envio_w,
	ds_proc_envio_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	/*lhalves OS359212 - em 21/09/2011 - Tratar qtd digitos despesas*/

	if (ie_digitos_desp_w	= 'N') then
		if (length(trim(both cd_item_w)) < 8) then
			cd_item_w	:= lpad(trim(both cd_item_w), 8, '0');
		end if;
	elsif (ie_digitos_desp_w	= 'S') then
		if (length(trim(both cd_item_w)) < 10) then
			cd_item_w	:= lpad(trim(both cd_item_w), 10, '0');
		end if;
	elsif (ie_digitos_desp_w	= 'M') then
		if (length(trim(both cd_item_w)) < 10) then
			if (ie_procedimento_w	= 'N') then
				cd_item_w	:= lpad(trim(both cd_item_w), 10, '0');
			else
				cd_item_w	:= lpad(trim(both cd_item_w), 8, '0');
			end if;
		end if;
	elsif (ie_digitos_desp_w	= 'R') then
		if (length(trim(both cd_item_w)) < 8) then
			cd_item_w	:= substr(lpad(trim(both cd_item_w), 8, '0'),1,8);
		elsif (length(trim(both cd_item_w)) = 9) then
			cd_item_w	:= substr(trim(both cd_item_w),2,8);
		elsif (length(trim(both cd_item_w)) > 9) then
			cd_item_w	:= substr(trim(both cd_item_w),3,8);
		end if;
	elsif (ie_digitos_desp_w	= 'D') then
		if (length(trim(both cd_item_w)) < 10) then
			if (ie_procedimento_w	= 'S') then
				cd_item_w	:= lpad(trim(both cd_item_w), 8, ' ');
			else
				cd_item_w	:= lpad(trim(both cd_item_w), 8, '0');
			end if;
		end if;
	elsif (ie_digitos_desp_w	= 'I') then
		cd_item_w	:= TISS_OBTER_REGRA_CODIGO_DESP(cd_estabelecimento_w,cd_convenio_w,ie_digitos_desp_w,cd_item_w,null,null,null);
	end if;

	cd_item_w	:= coalesce(cd_proc_envio_w,cd_item_w);
	ds_item_w	:= coalesce(ds_proc_envio_w,ds_item_w);

	select	coalesce(max(cd_tabela_xml), '00')
	into STRICT	cd_edicao_amb_w
	from	tiss_tipo_tabela
	where	nr_sequencia	= nr_seq_tiss_tabela_w;

	select  nextval('tiss_conta_desp_seq')
	into STRICT    nr_sequencia_w
	;

	insert into tiss_conta_desp(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		ie_tipo_despesa,
		dt_item,
		cd_procedimento,
		ds_procedimento,
		qt_item,
		vl_unitario,
		vl_item,
		nr_seq_reap_conta,
		ie_tiss_tipo_guia,
		cd_autorizacao,
		vl_reducao_acrescimo,
		ds_justificativa_revisao,
		cd_edicao_amb)
	values (	nr_sequencia_w,
		dt_atualizacao_w,
		nm_usuario_p,
		ie_tipo_despesa_w,
		dt_despesa_w,
		cd_item_w,
		ds_item_w,
		qt_despesa_w,
		vl_unitario_w,
		vl_despesa_w,
		nr_seq_reap_conta_p,
		ie_tiss_tipo_guia_w,
		cd_autorizacao_w,
		tx_reducao_acresc_w,
		ds_justificativa_w,
		cd_edicao_amb_w);

end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_gerar_reap_desp ( nr_seq_reap_conta_p bigint, nm_usuario_p text) FROM PUBLIC;

