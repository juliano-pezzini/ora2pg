-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_gerar_arquivo_sef_edoc ( nr_seq_controle_p bigint ) AS $body$
DECLARE


-- VARIABLES
arq_texto_w		utl_file.file_type;
ds_diretorio_w		varchar(255);
nm_arquivo_w		varchar(255);
qt_contador_w		bigint	:= 0;
ds_erro_w	 	varchar(2000);

-- USUARIO
nm_usuario_w		usuario.nm_usuario%type;

-- FIS_SEF_EDOC_CONTROLE
cd_estabelecimento_w	fis_sef_edoc_controle.cd_estabelecimento%type;
dt_inicio_apuracao_w	fis_sef_edoc_controle.dt_inicio_apuracao%type;
ie_tipo_arquivo_w		fis_sef_edoc_controle.ie_tipo_arquivo%type;

-- FIS_SEF_EDOC_ARQUIVO
ds_arquivo_w			fis_sef_edoc_arquivo.ds_arquivo%type;
ds_arquivo_compl_w		fis_sef_edoc_arquivo.ds_arquivo_compl%type;
cd_registro_w			fis_sef_edoc_arquivo.cd_registro%type;
nr_linha_w		 	fis_sef_edoc_arquivo.nr_linha%type;

C01 CURSOR FOR
SELECT	a.cd_registro,
        a.ds_arquivo,
	a.ds_arquivo_compl,
	a.nr_linha
from	fis_sef_edoc_arquivo a
where	a.nr_seq_controle = nr_seq_controle_p
order by nr_linha;


BEGIN
nm_usuario_w := Obter_Usuario_Ativo;

select	max(cd_estabelecimento),
	max(dt_inicio_apuracao),
	max(ie_tipo_arquivo)
into STRICT	cd_estabelecimento_w,
	dt_inicio_apuracao_w,
	ie_tipo_arquivo_w
from	fis_sef_edoc_controle
where	nr_sequencia = nr_seq_controle_p;

if (ie_tipo_arquivo_w = '1') then
/*Chamada da procedure que gera os dados no arquivo dos registros C dos arquivos  C - SEF II - LFPD 01 - eDoc_Extrato */

nm_arquivo_w := 'Arquivo_eDoc_Extrato_'|| to_char(dt_inicio_apuracao_w,'ddmmyyyy') || '.txt';
elsif (ie_tipo_arquivo_w = '2') then
/*Chamada da procedure que gera os dados no arquivo dos registros E dos arquivos  E - SEF II - LFPD 05 - SEF_LA-ICMS integral*/

nm_arquivo_w := 'Arquivo_SEF_LAICMSintegral_'|| to_char(dt_inicio_apuracao_w,'ddmmyyyy') || '.txt';
elsif (ie_tipo_arquivo_w = '3') then
/*Chamada da procedure que gera os dados no arquivo dos registros G dos arquivos  G - SEF II - LFPD 07 - SEF_GI-ICMS (GIAF-GIAM-GIA)*/

nm_arquivo_w := 'Arquivo_SEF_GI-ICMS_'|| to_char(dt_inicio_apuracao_w,'ddmmyyyy') || '.txt';
elsif (ie_tipo_arquivo_w in ('4','5','6')) then
/*Chamada da procedure que gera os dados no arquivo dos registros F dos arquivos  F - SEF II - LFPD 08 - SEF_RIDF / SEF II - LFPD 09 - SEF_LMC / SEF II - LFPD 10 - SEF_RV*/

nm_arquivo_w := 'Arquivo_SEF_RIDF_'|| to_char(dt_inicio_apuracao_w,'ddmmyyyy') || '.txt';
elsif (ie_tipo_arquivo_w = '7') then
/*Chamada da procedure que gera os dados no arquivo dos registros H dos arquivos   H - SEF II - LFPD 12 - SEF_RI*/

nm_arquivo_w := 'Arquivo_SEF_RI_'|| to_char(dt_inicio_apuracao_w,'ddmmyyyy') || '.txt';
end if;

ds_diretorio_w		:= substr(coalesce(Obter_Valor_Param_Usuario(5500, 14, obter_perfil_ativo, Obter_Usuario_Ativo, cd_estabelecimento_w),''),1,255);
CALL gravar_processo_longo('Carregando informações ' || nm_arquivo_w, 'FIS_GERAR_ARQUIVO_SEF_EDOC', qt_contador_w);

begin
	arq_texto_w := utl_file.fopen(ds_diretorio_w, nm_arquivo_w, 'W');
exception when others then
	ds_erro_w	:= substr(sqlerrm(SQLSTATE),1,2000);
	CALL wheb_mensagem_pck.exibir_mensagem_abort(472074, 'DS_DIRETORIO=' || ds_diretorio_w || ';' ||	'DS_ERRO=' || ds_erro_w);
end;

open C01;
loop
fetch C01 into
	cd_registro_w,
	ds_arquivo_w,
	ds_arquivo_compl_w,
	nr_linha_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	qt_contador_w	:= nr_linha_w;
	CALL gravar_processo_longo('Gerando arquivo' || cd_registro_w || '-' || nm_arquivo_w, 'EFD_GERAR_ARQ_BANCO_ICMSIPI', qt_contador_w);

	utl_file.put_line(arq_texto_w, ds_arquivo_w || ds_arquivo_compl_w || chr(13));
	utl_file.fflush(arq_texto_w);
end loop;
close C01;

utl_file.fclose(arq_texto_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_gerar_arquivo_sef_edoc ( nr_seq_controle_p bigint ) FROM PUBLIC;

