-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_cancelar_nf_prot (nr_seq_protocolo_p bigint, nm_usuario_p text, ds_mensagem_p INOUT text) AS $body$
DECLARE

 
cd_estabelecimento_w		protocolo_convenio.cd_estabelecimento%type;
cd_perfil_w			perfil.cd_perfil%type := wheb_usuario_pck.get_cd_perfil;
qt_dias_cancel_w		varchar(255);
qt_dias_w			bigint;
ie_tipo_dias_cancel_w		varchar(1);
ds_mensagem_w			varchar(4000);
dt_emissao_nf_w			timestamp;
dt_emissao_aux_w		timestamp;
i				integer;
j				integer;


BEGIN 
 
select	cd_estabelecimento 
into STRICT	cd_estabelecimento_w 
from	protocolo_convenio 
where	nr_seq_protocolo	= nr_seq_protocolo_p;
 
qt_dias_cancel_w := Obter_Param_Usuario(85, 249, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, qt_dias_cancel_w);	
ie_tipo_dias_cancel_w := Obter_Param_Usuario(85, 250, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_tipo_dias_cancel_w);
 
ds_mensagem_w	:= null;
 
RAISE NOTICE '0 qt_dias_cancel_w: %', qt_dias_cancel_w;
 
--Consistir dias para cancelar a NF com base na data de emissão 
if (coalesce(qt_dias_cancel_w,'0') > '0') then 
 
	qt_dias_w	:= somente_numero(qt_dias_cancel_w);
 
	--Busca a menor data de todas as NFs vinculadas ao protocolo 
	select	min(dt_emissao) 
	into STRICT	dt_emissao_nf_w 
	from	nota_fiscal 
	where	nr_seq_protocolo	= nr_seq_protocolo_p 
	and	ie_situacao 		= '1';
	 
	RAISE NOTICE '1 dt_emissao_nf_w: %', dt_emissao_nf_w;
	 
	if (dt_emissao_nf_w IS NOT NULL AND dt_emissao_nf_w::text <> '') then 
		 
		if (ie_tipo_dias_cancel_w = 'C') then 
			dt_emissao_aux_w	:= trunc(dt_emissao_nf_w) + qt_dias_w;
			 
		elsif (ie_tipo_dias_cancel_w = 'U') then					 
			i := 0;	
			j := 1;			
			while j <= qt_dias_w loop 
				begin				 
				i := i + 1;
				if (obter_se_dia_util( dt_emissao_nf_w + i, 1) = 'S') then		 
					j := j + 1;	
				end if;
				 
				end;
			end loop;		
			dt_emissao_aux_w	:= dt_emissao_nf_w + i;
		end if;	
			 
		if (dt_emissao_aux_w < trunc(clock_timestamp())) then	 
			--'Não é permitido cancelar notas emitidas até '||qt_dias_w||' dias.' 
			ds_mensagem_w	:= wheb_mensagem_pck.get_texto(308554,'qt_dias_w='||qt_dias_w);		
		end if;
	end if;
	 
	RAISE NOTICE '2 dt_emissao_aux_w: %', dt_emissao_aux_w;
end if;
 
ds_mensagem_p	:= ds_mensagem_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_cancelar_nf_prot (nr_seq_protocolo_p bigint, nm_usuario_p text, ds_mensagem_p INOUT text) FROM PUBLIC;

