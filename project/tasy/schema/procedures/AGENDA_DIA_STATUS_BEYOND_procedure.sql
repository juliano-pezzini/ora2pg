-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE agenda_dia_status_beyond ( cd_estabelecimento_p bigint, cd_agenda_p bigint, dt_Inicial_p timestamp, dt_final_p timestamp, cd_turno_p text, nm_usuario_p text, ie_Status_p INOUT text) AS $body$
DECLARE




ie_Status_w			varchar(4000);
ie_Status_dia_w			varchar(10);
ie_gerado_w				varchar(1);
dt_atual_w			timestamp;
cd_tipo_agenda_w		bigint;
ie_feriado_w			varchar(10);
ie_agenda_feriado_w		varchar(10);
ie_gerar_hor_feriado_w		varchar(10);
ie_dia_feriado_w		varchar(10);
ie_dia_semana_w			varchar(10);
qt_horario_w			bigint;
qt_horario_livre_w		bigint;
qt_regra_horario_w		bigint;
qt_horario_bloqueado_w		bigint;
ds_horarios_w			varchar(255);
ie_bloqueio_w			varchar(10);
ie_gravar_w			varchar(10) := 'N';
ie_sobra_horario_w		varchar(10) := 'S';
ds_retorno_w			varchar(4000) := '';
qt_bloqueio_w			bigint;
qt_horario_ocupado_w		bigint;
ie_gerar_hor_livre_w		varchar(1);
ie_agenda_valida_w		varchar(1) := 'N';
ie_existe_hor_gerado_w		bigint;
qt_dias_fut_w			bigint := 0;
cd_pessoa_usuario_w		varchar(10);
ie_cons_se_leg_dia_nao_lib_w 	varchar(1);
ie_cons_se_leg_dia_nao_lib_ww 	varchar(1);
cd_turno_w			varchar(1);
ie_cons_leg_bloq_fim_sem_w	varchar(1);
nr_minuto_intervalo_w		bigint;
nr_seq_turno_w			bigint;
qt_hor_bloq_per_w		bigint;
qt_total_hor_bloq_per_w		bigint;
ds_erro_w			varchar(255);
qt_bloqueio_sem_horario_w	bigint;
qt_reg_agenda_bloqueio_dia_w	bigint;
qt_dia_inicial_w		bigint;
qt_dia_final_w			bigint;
qt_dia_filtro_ini_w		bigint;
qt_dia_filtro_fim_w		bigint;
ie_dia_sem_w			varchar(10);
hr_inicio_agenda_w		timestamp;		
hr_final_agenda_w		timestamp;
ie_turno_valido_w		varchar(1) 	:= 'N';
ie_gerar_hor_passado_w		varchar(1)	:= 'S';
ie_todos_dias_regra_w		varchar(1)	:= 'N';
nr_seq_esp_w			bigint	:= 0;
ie_horario_adicional_w 		varchar(01) 	:= 'S';
ie_manter_hist_horarios_w	varchar(1) 	:= 'N';
qt_bloqueado_manual_w		bigint;

--Obter qtd. de bloqueios gerados, caso os hor?rios do dia n?o estiverem gerados(utilizado em casos de bloqueios espec?ficos, com hr. inicial e hr. final)
C01 CURSOR FOR
	SELECT	coalesce(((((coalesce(a.hr_final_bloqueio, to_date('31/12/1899 '||'23:59:59', 'dd/mm/yyyy hh24:mi:ss')) - coalesce(a.hr_inicio_bloqueio, to_date('31/12/1899 '||'00:00:00', 'dd/mm/yyyy hh24:mi:ss'))) * 1440) / nr_minuto_intervalo_w)), 0)						
	from	agenda_bloqueio a			
	where  	a.cd_agenda 		= cd_agenda_p
	and		(((a.ie_dia_semana = 9) and (ie_dia_sem_w not in (qt_dia_filtro_ini_w,qt_dia_filtro_fim_w)))
	or		(a.ie_dia_semana <> 9 AND ie_dia_sem_w = a.ie_dia_semana)
	or (coalesce(a.ie_dia_semana::text, '') = ''))
	and		dt_atual_w	between trunc(a.dt_inicial) and fim_dia(trunc(a.dt_final))
	and		coalesce(Obter_Se_Feriado(cd_estabelecimento_p, dt_atual_w),0) = 0;

C02 CURSOR FOR
	SELECT 	to_date(to_char(dt_atual_w, 'dd/mm/yyyy')||' '||to_char(hr_inicial, 'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss'),
			to_date(to_char(dt_atual_w, 'dd/mm/yyyy')||' '||to_char(hr_final, 'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss')
	from   	agenda_horario
	where  	cd_agenda = cd_agenda_p
	and    	((dt_dia_semana = ie_dia_sem_w) or (dt_dia_semana = 9 and ie_dia_sem_w not in (qt_dia_filtro_ini_w,qt_dia_filtro_fim_w)) or (dt_dia_semana in (qt_dia_filtro_ini_w,qt_dia_filtro_fim_w)))
	--and    	((dt_dia_semana is null) or (dt_dia_semana = ie_dia_sem_w) or (dt_dia_semana = 9 and ie_dia_sem_w not in (qt_dia_filtro_ini_w,qt_dia_filtro_fim_w)))
	and		dt_atual_w between dt_inicio_vigencia and dt_final_vigencia;
	

BEGIN

ie_cons_se_leg_dia_nao_lib_w := Obter_Param_Usuario(821, 420, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_cons_se_leg_dia_nao_lib_w);
ie_cons_se_leg_dia_nao_lib_ww := Obter_Param_Usuario(820, 374, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_cons_se_leg_dia_nao_lib_ww);
ie_cons_leg_bloq_fim_sem_w := Obter_Param_Usuario(820, 406, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_cons_leg_bloq_fim_sem_w);
ie_gerar_hor_passado_w := Obter_Param_Usuario(866, 133, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_gerar_hor_passado_w);
ie_todos_dias_regra_w := Obter_Param_Usuario(866, 120, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_todos_dias_regra_w);

if (wheb_usuario_pck.get_cd_funcao = 821) then
	ie_cons_leg_bloq_fim_sem_w := Obter_Param_Usuario(821, 483, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_cons_leg_bloq_fim_sem_w);
end if;

IF	((Dt_final_p - dt_inicial_p) > 255) THEN
	CALL wheb_mensagem_pck.exibir_mensagem_abort(200597);
END IF;

if (coalesce(cd_turno_p::text, '') = '') then
	cd_turno_w := '2';
else
	cd_turno_w := cd_turno_p;
end if;

SELECT	CASE WHEN COUNT(*)=0 THEN 'N'  ELSE 'S' END
INTO STRICT	ie_agenda_valida_w
FROM	agenda
WHERE	cd_agenda = cd_agenda_p;

qt_dia_inicial_w	:= 2;
qt_dia_final_w		:= 6;
qt_dia_filtro_ini_w	:= 7;
qt_dia_filtro_fim_w	:= 1;

IF (ie_agenda_valida_w = 'S') THEN
	BEGIN
	SELECT (MAX(Obter_Valor_Param_Usuario(820, 118, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)))
	INTO STRICT	ie_gerar_hor_livre_w
	;

	SELECT	cd_tipo_agenda,
		ie_feriado
	INTO STRICT	cd_tipo_agenda_w,
		ie_feriado_w
	FROM 	agenda
	WHERE cd_agenda 	= cd_agenda_p;
	
	if	((cd_tipo_agenda_w = 3) or (cd_tipo_agenda_w = 4)) and (ie_cons_se_leg_dia_nao_lib_w = 'S')then
		select	substr(max(nr_dias_fut_agendamento),1,9)
		into STRICT	qt_dias_fut_w
		from	agenda
		where	cd_agenda = cd_agenda_p;
		
		if (coalesce(qt_dias_fut_w::text, '') = '') and (ie_cons_se_leg_dia_nao_lib_w = 'S')then
			SELECT	substr(MAX(Obter_Valor_Param_Usuario(821, 5, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)),1,9)
			INTO STRICT	qt_dias_fut_w
			;
			--substr(obter_param_usuario(821, 5, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, qt_dias_fut_w),1,10);
		end if;
		
		select	max(cd_pessoa_fisica)
		into STRICT	cd_pessoa_usuario_w
		from	usuario
		where	nm_usuario = nm_usuario_p;
		
		if (obter_se_ignorar_dias_fut(cd_pessoa_usuario_w,cd_agenda_p,null) = 'S') then
			qt_dias_fut_w := 0;
		end if;			
	elsif (cd_tipo_agenda_w = 2) and (ie_cons_se_leg_dia_nao_lib_ww = 'S')then
			select	substr(max(nr_dias_fut_agendamento),1,9)
			into STRICT	qt_dias_fut_w
			from	agenda
			where	cd_agenda = cd_agenda_p;
			
			if (coalesce(qt_dias_fut_w::text, '') = '') and (ie_cons_se_leg_dia_nao_lib_ww = 'S')then
				SELECT	substr(MAX(Obter_Valor_Param_Usuario(820, 4, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)),1,9)
				INTO STRICT	qt_dias_fut_w
				;			
			end if;
			
	end if;
	
	ie_status_w					:= '';
	dt_atual_w					:= TRUNC(dt_inicial_p, 'dd');
	WHILE(dt_atual_w	<= TRUNC(dt_final_p,'dd')) LOOP
		BEGIN
		ie_status_dia_w			:= 'X';
		qt_bloqueio_w			:= 0;
		
		ie_dia_semana_w	:= obter_cod_dia_semana(dt_atual_w);
		

		SELECT 	coalesce(MAX('S'),'N')
		into STRICT	ie_dia_feriado_w
		from 	feriado
		where 	cd_estabelecimento 	= cd_estabelecimento_p
		and 	dt_feriado		= dt_atual_w;
				
		SELECT 	COUNT(*)
		INTO STRICT	qt_bloqueio_w
		FROM	agenda_bloqueio
		WHERE	cd_agenda	= cd_agenda_p
		AND 	TRUNC(dt_inicial,'dd')	<= trunc(dt_atual_w,'dd')
		AND 	TRUNC(dt_final,'dd')	>= trunc(dt_atual_w,'dd')
		AND		((coalesce(ie_dia_semana,ie_dia_semana_w) = ie_dia_semana_w) OR
				((ie_dia_semana	= 9) AND (ie_dia_semana_w BETWEEN qt_dia_inicial_w AND qt_dia_final_w) or
				(ie_cons_leg_bloq_fim_sem_w = 'S' AND ie_dia_semana_w BETWEEN qt_dia_filtro_ini_w AND qt_dia_filtro_fim_w)));
		
		qt_horario_w			:= 0;
		qt_horario_livre_w		:= 0;
		qt_total_hor_bloq_per_w	:= 0;
		ie_turno_valido_w := 'N';
		
		/*AGENDA DE CONSULTAS / SERVI?OS*/

		IF (cd_tipo_agenda_w > 2) THEN	
		
				select		coalesce(max(nr_sequencia),0),
							coalesce(max(ie_horario_adicional), 'N')
				into STRICT		nr_seq_esp_w,
							ie_horario_adicional_w
				from		agenda_turno_esp
				where		cd_agenda	= cd_agenda_p
				and			((ie_dia_semana = ie_dia_semana_w) or ((ie_dia_semana = 9) and (ie_dia_Semana_w not in (7,1))) or (coalesce(ie_dia_semana::text, '') = ''))
				and			obter_se_turno_esp_agecons_vig(dt_agenda,dt_agenda_fim,dt_atual_w) = 'S';					
				
				begin
						
					select 'S'
					into STRICT	ie_turno_valido_w
					from	(	SELECT 	1
								from 	agenda_Turno_Esp a
								where 	cd_agenda     	= cd_agenda_p
								and		((ie_dia_semana = ie_dia_semana_w) or ((ie_dia_semana = 9) and (ie_dia_Semana_w not in (qt_dia_filtro_ini_w,qt_dia_filtro_fim_w))) or (coalesce(ie_dia_semana::text, '') = ''))
								and		((obter_se_feriado(cd_estabelecimento_p, dt_atual_w) = 0) or (obter_se_agenda_feriado(cd_agenda_p) = 'S'))
								--and	dt_agenda		= trunc(dt_atual_w,'dd')
								and		obter_se_turno_esp_agecons_vig(dt_agenda,dt_agenda_fim,dt_atual_w) = 'S'
								--and 	hr_inicial 		< hr_final
								and		to_char(hr_inicial,'hh24:mi:ss') < to_char(hr_final,'hh24:mi:ss')
								and		nr_minuto_intervalo	> 0
								and		nr_seq_esp_w		> 0
								
union

								SELECT 	1
								from 	agenda_Turno a
								where 	cd_agenda     		= cd_agenda_p
								and		((ie_dia_semana = ie_dia_semana_w) or ((ie_dia_semana = 9) and (ie_dia_Semana_w not in (qt_dia_filtro_ini_w,qt_dia_filtro_fim_w))))
								--and 	hr_inicial 			< hr_final
								and		to_char(hr_inicial,'hh24:mi:ss') < to_char(hr_final,'hh24:mi:ss')
								and		((coalesce(dt_inicio_vigencia::text, '') = '') or (trunc(dt_inicio_vigencia) <= trunc(dt_atual_w)))
								and		((coalesce(dt_final_vigencia::text, '') = '') or (trunc(dt_final_vigencia) >= trunc(dt_atual_w)))
								and		coalesce(nr_minuto_intervalo,0) > 0
								and		((((ie_feriado_w <> 'S') and (coalesce(ie_feriado,'X') <> 'F')) or (coalesce(ie_feriado,obter_se_agenda_feriado(cd_agenda_p)) = 'S')) or ((ie_feriado = 'F' AND ie_feriado_w = 'S') or (ie_feriado = 'N' AND ie_dia_feriado_w <> 'S')))
								and (nr_seq_esp_w = 0 or ie_horario_adicional_w = 'S')
								and		obter_se_gerar_turno_agecons(dt_inicio_vigencia,ie_frequencia,dt_atual_w) = 'S'
								and		((Obter_Semana_Dia_Agecons(dt_atual_w,ie_dia_semana) = coalesce(ie_semana,0)) or (coalesce(ie_semana,0) = 0))
							) alias57 LIMIT 1;					
				exception
				when others then
					ie_turno_valido_w := 'N';
				end;
				
		end if;
		
		
				
		if (coalesce(ie_turno_valido_w,'N') = 'N') and (ie_dia_Semana_w not in (qt_dia_filtro_ini_w,qt_dia_filtro_fim_w)) and (qt_bloqueio_w = 0)then
			
			ie_status_dia_w	:= 'N';
			
		else
		
			IF (cd_tipo_agenda_w > 2) THEN
				BEGIN

				/*AGENDA DE CONSULTAS*/

				SELECT	/*+ index (a AGECONS_UK) */						SUM(CASE WHEN ie_status_agenda='L' THEN 0  ELSE 1 END ),
						SUM(CASE WHEN ie_status_agenda='L' THEN 1  ELSE CASE WHEN ie_status_agenda='LF' THEN 1  ELSE 0 END  END ),
						SUM(CASE WHEN ie_status_agenda='B' THEN 1  ELSE 0 END ),
						SUM(CASE WHEN coalesce(coalesce(cd_pessoa_fisica, CASE WHEN ie_status_agenda='B' THEN  null  ELSE nm_paciente END )::text, '') = '' THEN CASE WHEN ie_status_agenda='B' THEN  0  ELSE CASE WHEN ie_status_agenda='R' THEN  1  ELSE 0 END  END   ELSE 1 END ),
						SUM(CASE WHEN coalesce(ie_bloqueado_manual, 'N')='N' THEN  0  ELSE 1 END )
				INTO STRICT	qt_horario_w,
						qt_horario_livre_w,
						qt_horario_bloqueado_w,
						qt_horario_ocupado_w,
						qt_bloqueado_manual_w
				FROM 	agenda_consulta
				WHERE 	cd_agenda		= cd_agenda_p
				and	((cd_turno		= cd_turno_w) or (cd_turno_w = '2'))
				AND	dt_agenda between trunc(dt_atual_w) and fim_dia(dt_atual_w)
				AND	ie_status_agenda	<> 'C'
				and ie_status_agenda	<> 'II';		
				
				if (qt_bloqueio_w = 0 AND qt_bloqueado_manual_w = 0) then
					qt_horario_bloqueado_w := 0;
				end if;
				
				SELECT 	COUNT(*)
					INTO STRICT	qt_regra_horario_w
					FROM	agenda_Turno
					WHERE 	cd_agenda     	= cd_agenda_p
					AND		((ie_dia_semana	= ie_dia_semana_w) OR
							(ie_dia_semana	= 9 AND ie_dia_semana_w BETWEEN qt_dia_inicial_w AND qt_dia_final_w))
					AND 	coalesce(dt_final_vigencia,dt_atual_w) >= dt_atual_w
					AND 	coalesce(dt_inicio_vigencia,dt_atual_w) <= dt_atual_w;
				
				
					Select 	coalesce(max('S'),'N')
					into STRICT	ie_gerado_w
					from	agenda_consulta
					where	cd_agenda = cd_agenda_p
					and		dt_agenda between trunc(dt_atual_w) and fim_dia(dt_atual_w);
				
				
									
				
				IF	(ie_gerado_w = 'N' and
					 ((dt_atual_w >= TRUNC(clock_timestamp(), 'dd')) and (coalesce(qt_horario_livre_w,0) = 0)) or (qt_regra_horario_w = 0)) and (cd_tipo_agenda_w <> 5) THEN
					BEGIN

					ds_retorno_w := Horario_Livre_Consulta(
						cd_estabelecimento_p, cd_agenda_p, 'N', dt_atual_w, nm_usuario_p, 'S', ie_sobra_horario_w, 'N', 0, ds_retorno_w);
					qt_horario_livre_w	:= coalesce(LENGTH(ds_retorno_w),0);
					
					END;						
				end if;	/*		
				
				
				/* Bruno */

				select	count(*)
				into STRICT	ie_existe_hor_gerado_w
				from 	agenda_consulta where cd_agenda = cd_agenda_p
				and	((cd_turno		= cd_turno_w) or (cd_turno_w = '2'))
				and	dt_agenda between trunc(dt_atual_w) and fim_dia(dt_atual_w)
				and	ie_status_agenda in ('L','LF');
				
				if (ie_existe_hor_gerado_w <> 0) then
					SELECT	/*+ index (a AGECONS_UK) */						SUM(CASE WHEN ie_status_agenda='L' THEN 1  ELSE CASE WHEN ie_status_agenda='LF' THEN 1  ELSE 0 END  END )
					INTO STRICT	qt_horario_livre_w
					FROM	agenda_consulta
					WHERE	cd_agenda		= cd_agenda_p
					and	((cd_turno		= cd_turno_w) or (cd_turno_w = '2'))
					AND	dt_agenda between trunc(dt_atual_w) and fim_dia(dt_atual_w)
					AND	ie_status_agenda	<> 'C'
					AND	((ie_classif_agenda NOT IN (	SELECT cd_classificacao
										FROM   agenda_classif
										WHERE  ie_nao_considera_mensal = 'S'))
					OR (coalesce(ie_classif_agenda::text, '') = ''	));			
				end if;			
				
			
				if (coalesce(qt_horario_w,0) = 0) or (coalesce(qt_horario_bloqueado_w,0) = 0)then
					begin
					
					ie_dia_sem_w	:= obter_cod_dia_semana(dt_atual_w);
					
					--Busca seq. do turno atual(caso exista mais de 1)
					select	max(coalesce(nr_sequencia,0))
					into STRICT	nr_seq_turno_w
					from	agenda_turno
					where	coalesce(dt_inicio_vigencia, dt_atual_w) <= trunc(dt_atual_w)
					and		coalesce(dt_final_vigencia, dt_atual_w) >= trunc(dt_atual_w)
					and		nr_minuto_intervalo > 0
					and		((ie_dia_semana = ie_dia_sem_w) or ((ie_dia_semana = 9) and (ie_dia_sem_w not in (qt_dia_filtro_ini_w,qt_dia_filtro_fim_w))))
					and		cd_agenda = cd_agenda_p;					
									
					--Se possuir turno, busca os minutos de intervalo dos hor?rios
					if (nr_seq_turno_w > 0)then
						
						select	max(coalesce(a.nr_minuto_intervalo,0))
						into STRICT	nr_minuto_intervalo_w
						from	agenda_turno a							
						where  	a.cd_agenda     	= cd_agenda_p				
						and		a.nr_sequencia		= nr_seq_turno_w
						and		(((a.ie_dia_semana = 9) and (ie_dia_sem_w not in (qt_dia_filtro_ini_w,qt_dia_filtro_fim_w)))
						or		(a.ie_dia_semana <> 9 AND ie_dia_sem_w = a.ie_dia_semana))					
						and		coalesce(Obter_Se_Feriado(cd_estabelecimento_p, dt_atual_w),0) = 0;				
						
						if (nr_minuto_intervalo_w > 0) then
							open C01;
							loop
							fetch C01 into	
								qt_hor_bloq_per_w;
							EXIT WHEN NOT FOUND; /* apply on C01 */
								begin
								qt_total_hor_bloq_per_w		:= qt_hor_bloq_per_w		+ qt_total_hor_bloq_per_w;							
								end;
							end loop;
							close C01;
							
						end if;
						
					end if;		
					if (coalesce(qt_total_hor_bloq_per_w,0) > 0)then
						qt_horario_w 			:= qt_total_hor_bloq_per_w;
					end if;
					
					if (coalesce(qt_total_hor_bloq_per_w,0) > 0)then
						qt_horario_bloqueado_w := qt_total_hor_bloq_per_w;
					end if;
					
					exception
					when others then
						qt_horario_w := 0;
					end;			
				end if;						
				END;			
			END IF;
		
		/* Status por Dia
			L - Existem Livres
			F - Feriado
			B - Bloqueado
			N - N?o tem Agenda Dia
			X - Todos hor?rios Livres
			T - Todos Horarios Lotados
			D - Sabados e Domingos
			R - N?o liberado

		*/
		
					--Apenas fazer o if abaixo se a fun??o aberta for a "Agenda de Exames" e se o dia possuir hor?rios gerados/turno cadastrado
			if (ie_cons_leg_bloq_fim_sem_w = 'S') and (wheb_usuario_pck.get_cd_funcao = 820) and (ie_existe_hor_gerado_w > 0)then
				BEGIN			
				SELECT 	COUNT(*)
				INTO STRICT	qt_bloqueio_w
				FROM	agenda_bloqueio
				WHERE	cd_agenda	= cd_agenda_p
				AND 	TRUNC(dt_inicial,'dd')	<= dt_atual_w
				AND 	TRUNC(dt_final,'dd')	>= dt_atual_w
				AND		((coalesce(ie_dia_semana,ie_dia_semana_w) = ie_dia_semana_w) OR
						((ie_dia_semana	= 9 AND ie_dia_semana_w BETWEEN qt_dia_inicial_w AND qt_dia_final_w) or
						(ie_cons_leg_bloq_fim_sem_w = 'S' AND ie_dia_semana_w BETWEEN qt_dia_filtro_ini_w AND qt_dia_filtro_fim_w)));
				EXCEPTION
					WHEN OTHERS THEN
						ie_bloqueio_w := 'N';
				END;		
				
				IF (qt_bloqueio_w > 0) THEN
					ie_status_dia_w	:= 'B';
				END IF;						
				
			end if;	
			
			ie_dia_sem_w	:= obter_cod_dia_semana(dt_atual_w);


			if (cd_tipo_agenda_w in (1,2))then
				select	max(coalesce(nr_sequencia,0))
				into STRICT	nr_seq_turno_w
				from	agenda_horario
				where	trunc(coalesce(dt_inicio_vigencia, dt_atual_w)) <= trunc(dt_atual_w)
				and		trunc(coalesce(dt_final_vigencia, dt_atual_w)) >= trunc(dt_atual_w)
				and		nr_minuto_intervalo > 0
				and		((dt_dia_semana = ie_dia_sem_w) or ((dt_dia_semana = 9) and (ie_dia_sem_w not in (qt_dia_filtro_ini_w,qt_dia_filtro_fim_w))))
				and		cd_agenda = cd_agenda_p;			
			else
				select	max(coalesce(nr_sequencia,0))
				into STRICT	nr_seq_turno_w
				from	agenda_turno
				where	trunc(coalesce(dt_inicio_vigencia, dt_atual_w)) <= trunc(dt_inicial_p)
				and		trunc(coalesce(dt_final_vigencia, dt_atual_w)) >= trunc(dt_inicial_p)
				and		nr_minuto_intervalo > 0
				and		((ie_dia_semana = ie_dia_sem_w) or ((ie_dia_semana = 9) and (ie_dia_sem_w not in (qt_dia_filtro_ini_w,qt_dia_filtro_fim_w))))
				and		cd_agenda = cd_agenda_p;
			end if;

			--Validar se existe permiss?o de agendaento nos feriados
			if (ie_dia_feriado_w = 'S')then
				begin
				select	max(coalesce(ie_feriado,'N'))
				into STRICT	ie_agenda_feriado_w
				from	agenda
				where	cd_agenda = cd_agenda_p;

				--Busca seq. do turno atual(caso exista mais de 1)				
				if (nr_seq_turno_w > 0)then
					if (cd_tipo_agenda_w = 5) then
						ie_gerar_hor_feriado_w	:= ie_agenda_feriado_w;
					elsif (cd_tipo_agenda_w in (1,2))then
						select	max(ie_feriado)
						into STRICT	ie_gerar_hor_feriado_w
						from	agenda_horario
						where	nr_sequencia = nr_seq_turno_w;
					else
						select	max(ie_feriado)
						into STRICT	ie_gerar_hor_feriado_w
						from	agenda_turno
						where	nr_sequencia = nr_seq_turno_w;
					end if;			
				end if;			
				
				exception
				when others then
					ds_erro_w := substr(sqlerrm,1,255);
				end;
			end if;		
			
			IF (ie_dia_feriado_w = 'S') then			
				ie_status_dia_w	:= 'F';
			elsif	((((coalesce(qt_bloqueio_sem_horario_w,0) > 0) or (coalesce(qt_horario_bloqueado_w, 0) > 0) AND (coalesce(qt_horario_livre_w,0) = 0)) and (ie_dia_semana_w not in (qt_dia_filtro_ini_w,qt_dia_filtro_fim_w)) and (coalesce(qt_horario_ocupado_w,0) = 0)) or
					((coalesce(qt_horario_w,0) > 0) AND (coalesce(qt_horario_livre_w,0) = 0) AND (coalesce(qt_horario_ocupado_w,0) = 0) AND (coalesce(qt_horario_bloqueado_w, 0) > 0) and (coalesce(ie_dia_feriado_w, 'N') <> 'S'))) THEN						
				ie_status_dia_w	:= 'B';		
			elsif (qt_dias_fut_w > 0) and (dt_atual_w > trunc(clock_timestamp() + qt_dias_fut_w)) and (nr_seq_turno_w IS NOT NULL AND nr_seq_turno_w::text <> '')then
				ie_status_dia_w	:= 'R';		
			ELSIF (coalesce(qt_horario_w,0) > 0) and (coalesce(ie_dia_feriado_w, 'N') <> 'S') and
					((coalesce(qt_horario_ocupado_w,0) > 0) or (coalesce(qt_horario_bloqueado_w, 0) > 0)) THEN			
					IF (coalesce(qt_horario_livre_w,0) > 0) THEN
						ie_status_dia_w	:= 'L';
					ELSE
						ie_status_dia_w	:= 'T';
					END IF;			
			ELSIF (coalesce(qt_horario_livre_w,0) > 0) and (coalesce(ie_dia_feriado_w, 'N') <> 'S')THEN
				ie_status_dia_w	:= 'X';		
			elsif	(((ie_dia_semana_w in (qt_dia_filtro_ini_w,qt_dia_filtro_fim_w)) and ((qt_bloqueio_w > 0) or (coalesce(qt_bloqueio_sem_horario_w,0) > 0)) and (ie_cons_leg_bloq_fim_sem_w = 'S') and (coalesce(qt_horario_ocupado_w,0) = 0))) then		
				ie_status_dia_w	:= 'B';			
			ELSIF (ie_dia_semana_w = qt_dia_filtro_fim_w) OR (ie_dia_semana_w = qt_dia_filtro_ini_w) and (ie_cons_leg_bloq_fim_sem_w = 'N')THEN				
				ie_status_dia_w	:= 'D';		
			ELSE
				BEGIN	
				
				if (cd_tipo_agenda_w in (1,2))then
					SELECT 	COUNT(*)
					INTO STRICT	qt_regra_horario_w
					FROM	agenda_horario
					WHERE 	cd_agenda     	= cd_agenda_p
					AND		((dt_dia_semana	= ie_dia_semana_w) OR
							(dt_dia_semana	= 9 AND ie_dia_semana_w BETWEEN qt_dia_inicial_w AND qt_dia_final_w))
					AND 	coalesce(dt_inicio_vigencia,dt_atual_w) >= dt_atual_w
					AND 	coalesce(dt_final_vigencia,dt_atual_w) <= dt_atual_w;							
				elsif (cd_tipo_agenda_w in (3,4,5))then
					SELECT 	COUNT(*)
					INTO STRICT	qt_regra_horario_w
					FROM	agenda_Turno
					WHERE 	cd_agenda     	= cd_agenda_p
					AND		((ie_dia_semana	= ie_dia_semana_w) OR
							(ie_dia_semana	= 9 AND ie_dia_semana_w BETWEEN qt_dia_inicial_w AND qt_dia_final_w))
					AND 	coalesce(dt_final_vigencia,dt_atual_w) >= dt_atual_w
					AND 	coalesce(dt_inicio_vigencia,dt_atual_w) <= dt_atual_w;							
				end if;						
				
				if (qt_regra_horario_w > 0)then
					BEGIN			
					SELECT 	COUNT(*)
					INTO STRICT	qt_bloqueio_w
					FROM	agenda_bloqueio
					WHERE	cd_agenda	= cd_agenda_p
					AND 	TRUNC(dt_inicial,'dd')	<= trunc(dt_atual_w,'dd')
					AND 	TRUNC(dt_final,'dd')	>= trunc(dt_atual_w,'dd')
					AND		((coalesce(ie_dia_semana,ie_dia_semana_w) = ie_dia_semana_w) OR
							((ie_dia_semana	= 9) AND (ie_dia_semana_w BETWEEN qt_dia_inicial_w AND qt_dia_final_w) or (ie_cons_leg_bloq_fim_sem_w = 'S')));
					EXCEPTION
						WHEN OTHERS THEN
							ie_bloqueio_w := 'N';
					END;

					IF (qt_bloqueio_w > 0) THEN
						ie_status_dia_w	:= 'B';
					END IF;										
				end if;							
				IF (qt_regra_horario_w = 0) OR
					((coalesce(qt_horario_livre_w,0) = 0) AND (coalesce(qt_horario_w,0) = 0)) and (ie_status_dia_w <> 'B') then				
					ie_status_dia_w	:= 'N';
				END IF;	
						
				END;							
			END IF;	

		end if;
		

		ie_status_w	:= ie_status_w || ie_status_dia_w;
		dt_atual_w	:= dt_atual_w + 1;
		END;
	END LOOP;
	END;
ELSE
	BEGIN
	ie_status_w 	:= '';
	dt_atual_w 	:= TRUNC(dt_inicial_p,'dd');

	WHILE(dt_atual_w <= TRUNC(dt_final_p,'dd')) LOOP
		BEGIN
		ie_status_w	:= ie_status_w || 'N';
		dt_atual_w	:= dt_atual_w + 1;
		END;
	END LOOP;
	END;
END IF;

ie_status_p := ie_status_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE agenda_dia_status_beyond ( cd_estabelecimento_p bigint, cd_agenda_p bigint, dt_Inicial_p timestamp, dt_final_p timestamp, cd_turno_p text, nm_usuario_p text, ie_Status_p INOUT text) FROM PUBLIC;

