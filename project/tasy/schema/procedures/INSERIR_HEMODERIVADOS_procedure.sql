-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_hemoderivados ( nr_seq_derivado_p bigint, cd_profissional_p text, nr_cirurgia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_pepo_p bigint, nr_sequencia_p INOUT bigint) AS $body$
DECLARE

 
nr_atendimento_w	bigint;
ie_tipo_atendimento_w	smallint;
ie_tipo_convenio_w	smallint;
cd_convenio_w		integer;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
nr_seq_proc_interno_w	bigint;
cd_setor_atendimento_w	integer;
cd_categoria_w		varchar(10);
ie_liberar_w		varchar(1);	
nr_sequencia_w		bigint;


BEGIN 
 
select	--nvl(max(ie_libera_hemoder_pepo),'N') 
	coalesce(max('N'),'N') 
into	ie_liberar_w 
from	parametro_medico 
where	cd_estabelecimento = cd_estabelecimento_p;
 
if (nr_cirurgia_p > 0) then 
	select	nr_atendimento 
	into STRICT	nr_atendimento_w 
	from	cirurgia 
	where	nr_cirurgia	=	nr_cirurgia_p;
elsif (nr_seq_pepo_p > 0) then 
	select	nr_atendimento 
	into STRICT	nr_atendimento_w 
	from	pepo_cirurgia 
	where	nr_sequencia	=	nr_seq_pepo_p;
end if;
 
select	obter_tipo_atendimento(nr_atendimento_w), 
	obter_convenio_atendimento(nr_atendimento_w), 
	obter_tipo_convenio(obter_convenio_atendimento(nr_atendimento_w)), 
	obter_categoria_atendimento(nr_atendimento_w) 
into STRICT	ie_tipo_atendimento_w, 
	cd_convenio_w, 
	ie_tipo_convenio_w, 
	cd_categoria_w
;
 
 
SELECT * FROM Obter_Proced_sangue(0, nr_seq_derivado_p, cd_estabelecimento_p, ie_tipo_atendimento_w, ie_tipo_convenio_w, cd_convenio_w, cd_categoria_w, cd_setor_atendimento_w, cd_procedimento_w, ie_origem_proced_w, nr_seq_proc_interno_w) INTO STRICT cd_setor_atendimento_w, cd_procedimento_w, ie_origem_proced_w, nr_seq_proc_interno_w;
 
select	nextval('cirurgia_agente_anestesico_seq') 
into STRICT	nr_sequencia_w
;
			 
insert into cirurgia_agente_anestesico( 
	nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	nr_cirurgia, 
	cd_profissional, 
	qt_dose, 
	ie_tipo, 
	nr_seq_derivado, 
	cd_procedimento, 
	ie_origem_proced, 
	nr_seq_pepo, 
	ie_situacao, 
	dt_liberacao) 
values (	nr_sequencia_w, 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	CASE WHEN nr_cirurgia_p=0 THEN null  ELSE nr_cirurgia_p END , 
	cd_profissional_p, 
	1, 
	5, 
	nr_seq_derivado_p, 
	cd_procedimento_w, 
	ie_origem_proced_w, 
	nr_seq_pepo_p, 
	'A', 
	CASE WHEN ie_liberar_w='S' THEN clock_timestamp()  ELSE null END );
 
commit;
 
nr_sequencia_p	:= nr_sequencia_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_hemoderivados ( nr_seq_derivado_p bigint, cd_profissional_p text, nr_cirurgia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_pepo_p bigint, nr_sequencia_p INOUT bigint) FROM PUBLIC;

