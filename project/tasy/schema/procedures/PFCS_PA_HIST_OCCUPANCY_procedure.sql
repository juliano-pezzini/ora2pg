-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pfcs_pa_hist_occupancy ( nr_seq_indicator_p bigint, --> 155
 cd_establishment_p bigint, nm_user_p text) AS $body$
DECLARE



pfcs_panel_seq_w        pfcs_panel.nr_sequencia%type;
qt_current_occupied_w   numeric(20) := 0;
qt_total_unit_w         numeric(20) := 0;


c01 CURSOR(qt_current_occupied_p bigint) FOR
SELECT distinct aux.qt_hrs_inc qt_hrs_inc,
    count(hst.nr_seq_location) qt_occupied
from pfcs_patient_loc_hist hst,
    unidade_atendimento uni,
    setor_atendimento sec
    join(WITH RECURSIVE cte AS (
SELECT row_number() OVER () AS qt_hrs_inc  LEVEL <= 12  UNION ALL
SELECT row_number() OVER () AS qt_hrs_inc  LEVEL <= 12 JOIN cte c ON ()

) SELECT * FROM cte;
) aux ON aux.qt_hrs_inc <= 12
where uni.cd_setor_atendimento = sec.cd_setor_atendimento
    and hst.nr_seq_location = uni.nr_seq_location
    and sec.ie_situacao = 'A'
    and sec.cd_classif_setor = '1'
    and uni.ie_situacao = 'A'
    and sec.cd_estabelecimento_base = cd_establishment_p
    and hst.ie_situacao = 'A'
    and hst.si_intent = 'ORDER'
    and (hst.dt_period_start IS NOT NULL AND hst.dt_period_start::text <> '')
    and (clock_timestamp() - dividir(aux.qt_hrs_inc,24)) between hst.dt_period_start and coalesce(hst.dt_period_end, clock_timestamp())
    and (hst.nr_seq_encounter IS NOT NULL AND hst.nr_seq_encounter::text <> '')
group by aux.qt_hrs_inc

union all

select 0 qt_hrs_inc,
    qt_current_occupied_p qt_occupied

order by 1 asc;


BEGIN
select sum(vl_indicator), sum(vl_indicator_help)
into STRICT qt_total_unit_w, qt_current_occupied_w
from pfcs_panel
where nr_seq_indicator = 100
    and cd_reference_aux = '1'
    and nr_seq_operational_level = cd_establishment_p;

-- Occupancy for the last 5 hours
for c01_w in c01(qt_current_occupied_w) loop
    pfcs_pck.pfcs_generate_results(
        cd_reference_value_p => to_char(trunc((clock_timestamp() - ((c01_w.qt_hrs_inc)::numeric )/24), 'hh24'), 'dd/mm/yyyy hh24:mi:ss'),
        ds_reference_value_p => 'rgb(33,185,255)',
        vl_indicator_p => pfcs_get_percentage_value(c01_w.qt_occupied, qt_total_unit_w),
        vl_indicator_help_p => c01_w.qt_hrs_inc,
        cd_reference_aux_p => 'ED',
        nr_seq_indicator_p => nr_seq_indicator_p,
        nr_seq_operational_level_p => cd_establishment_p,
        nm_usuario_p => nm_user_p,
        nr_seq_panel_p => pfcs_panel_seq_w);
end loop;

for qt_hrs_inc in 1 .. 12 loop
    pfcs_pck.pfcs_generate_results(
    cd_reference_value_p => to_char(trunc((clock_timestamp() + ((qt_hrs_inc)::numeric )/24), 'hh24'), 'dd/mm/yyyy hh24:mi:ss'),
    ds_reference_value_p => 'rgb(40,124,166)',
    vl_indicator_p => pfcs_get_percentage_value(
        (pfcs_pck_sim.get_simulation_value(cd_establishment_p, qt_hrs_inc, 'CEN', '1', 'N', null))::numeric ,
        qt_total_unit_w
    ),
    cd_reference_aux_p => 'ED',
    ds_reference_aux_p => 'SIM',
    nr_seq_indicator_p => nr_seq_indicator_p,
    nr_seq_operational_level_p => cd_establishment_p,
    nm_usuario_p => nm_user_p,
    nr_seq_panel_p => pfcs_panel_seq_w);
end loop;

CALL pfcs_pck.pfcs_activate_records(
    nr_seq_indicator_p => nr_seq_indicator_p,
    nr_seq_operational_level_p => cd_establishment_p,
    nm_usuario_p => nm_user_p);

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_pa_hist_occupancy ( nr_seq_indicator_p bigint, cd_establishment_p bigint, nm_user_p text) FROM PUBLIC;

