-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vincular_atend_autorizacao ( nr_sequencia_autor_p text, nr_atendimento_p text, nm_usuario_p text) AS $body$
DECLARE


ds_erro_w       		varchar(255);
nr_prescricao_w			bigint;
nr_seq_paciente_w		bigint;
nr_seq_paciente_setor_w		bigint;
nr_ciclo_w			bigint;
dt_inicio_vigencia_w		timestamp;
dt_final_vigencia_w		timestamp;
ie_gera_historico_w		varchar(5) := 'N';

BEGIN

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '')and (nr_sequencia_autor_p IS NOT NULL AND nr_sequencia_autor_p::text <> '') then


	select	max(dt_inicio_vigencia),
		max(dt_final_vigencia)
	into STRICT	dt_inicio_vigencia_w,
		dt_final_vigencia_w
	from	atend_categoria_convenio
	where	nr_seq_interno  = Obter_Atecaco_atendimento(nr_atendimento_p)
	and	nr_atendimento = nr_atendimento_p;

	select	max(nr_seq_paciente),
		max(nr_seq_paciente_setor),
		max(nr_ciclo)
	into STRICT	nr_seq_paciente_w,
		nr_seq_paciente_setor_w,
		nr_ciclo_w
	from	autorizacao_convenio
	where	nr_sequencia = nr_sequencia_autor_p;


	select	max(nr_prescricao)
	into STRICT	nr_prescricao_w
	from	paciente_atendimento
	where	nr_seq_atendimento = nr_seq_paciente_w;

	if (coalesce(nr_prescricao_w::text, '') = '') then

		select	max(nr_prescricao)
		into STRICT	nr_prescricao_w
		from	paciente_atendimento
		where	nr_seq_paciente = nr_seq_paciente_setor_w
		and	nr_ciclo	= nr_ciclo_w;

	end if;


	if (nr_seq_paciente_w IS NOT NULL AND nr_seq_paciente_w::text <> '') then

		update	paciente_atendimento
		set	nr_atendimento = coalesce(nr_atendimento,nr_atendimento_p),
			nm_usuario     = nm_usuario_p,
			dt_atualizacao = clock_timestamp()
		where	nr_seq_atendimento = nr_seq_paciente_w;


	end if;

	if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then

		update	prescr_medica
		set	nr_atendimento = nr_atendimento_p,
			nm_usuario     = nm_usuario_p,
			dt_atualizacao = clock_timestamp()
		where	coalesce(nr_atendimento::text, '') = ''
		and	nr_prescricao = nr_prescricao_w;

	end if;


        begin
        update  autorizacao_convenio
        set     nr_atendimento  = nr_atendimento_p,
                dt_atualizacao  = clock_timestamp(),
                nm_usuario      = nm_usuario_p,
		nr_prescricao	= coalesce(nr_prescricao,nr_prescricao_w),
		dt_inicio_vigencia = coalesce(dt_inicio_vigencia,dt_inicio_vigencia_w),
		dt_fim_vigencia  = coalesce(dt_fim_vigencia,dt_final_vigencia_w)
        where   nr_sequencia    = nr_sequencia_autor_p
        and     coalesce(nr_atendimento::text, '') = '';
        exception
        when others then
                ds_erro_w := null;
        end;

	begin
	select	'S'
	into STRICT	ie_gera_historico_w
	from	autorizacao_convenio
	where	nr_sequencia = nr_sequencia_autor_p
	and	nr_atendimento = nr_atendimento_p;
	exception
	when others then
		ie_gera_historico_w := 'N';
	end;

	if (ie_gera_historico_w = 'S') then

		insert into autorizacao_convenio_hist(nr_sequencia,
			 dt_atualizacao,
			 nm_usuario,
			 nr_atendimento,
			 ds_historico,
			 nr_sequencia_autor)
		values (nextval('autorizacao_convenio_hist_seq'),
			 clock_timestamp(),
			 nm_usuario_p,
			 nr_atendimento_p,
			 WHEB_MENSAGEM_PCK.get_texto(311690,'NR_ATENDIMENTO_P=' || nr_atendimento_p),
			 nr_sequencia_autor_p);
	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vincular_atend_autorizacao ( nr_sequencia_autor_p text, nr_atendimento_p text, nm_usuario_p text) FROM PUBLIC;

