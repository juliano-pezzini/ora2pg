-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_fracionar_volume (nr_seq_producao_p bigint, nm_usuario_p text, qt_volume_p bigint, dt_validade_p timestamp, cd_perfil_p bigint, cd_estabelecimento_p bigint, ie_sistema_aliquota_p text) AS $body$
DECLARE


qt_volume_w				bigint;
qt_volume_ww				bigint;
cd_pf_realizou_w			varchar(10);
nr_seq_derivado_w			bigint;
nr_sangue_w				varchar(20);
nr_seq_doacao_w				bigint;
ie_filtrado_w				varchar(1);
ie_irradiado_w				varchar(1);
ie_lavado_w				varchar(1);
ie_aliquotado_w				varchar(1);
nr_seq_emp_ent_w			bigint;
dt_inicio_prod_emprestimo_w		timestamp;
dt_liberacao_w				timestamp;
ie_tipo_sangue_w                        varchar(2);
ie_fator_rh_w                           varchar(1);
nm_doador_w				varchar(60);
dt_utilizacao_w				timestamp;
dt_termino_util_w			timestamp;
nr_sec_saude_w				varchar(20);
nm_usuario_lib_w			varchar(15);
nr_seq_equipo_w				bigint;
nr_seq_lote_equipo_w			varchar(20);
dt_val_equipo_w				timestamp;
nr_seq_lote_w				varchar(20);
qt_unidade_derivado_w			bigint;
qt_unidade_deriv_util_w			bigint;
nr_seq_atend_pac_unid_w			bigint;
cd_barras_w				varchar(30);
ie_aferese_w				varchar(1);
nm_usuario_irradiacao_w			varchar(15);
nm_usuario_lavado_w			varchar(15);
qt_peso_bolsa_w				double precision;
qt_peso_bolsa_vazia_w			double precision;
dt_fim_repouso_w			timestamp;
dt_inicio_repouso_w			timestamp;
dt_fim_filtragem_w			timestamp;
dt_inicio_filtragem_w			timestamp;
nr_seq_conservante_w			bigint;
cd_material_w				integer;
dt_validade_conservante_w		timestamp;
dt_fim_alicotagem_w			timestamp;
nm_usuario_fim_alico_w			varchar(15);
dt_recebimento_w			timestamp;
nm_usuario_recebimento_w		varchar(15);
nr_seq_armazenamento_w			bigint;
nm_usuario_ent_estoque_w		varchar(15);
dt_entrada_estoque_w			timestamp;
qt_dose_estoque_w			smallint;
dt_inicio_producao_w			timestamp;
nm_usuario_ini_producao_w		varchar(15);
dt_fim_producao_w			timestamp;
nm_usuario_fim_producao_w		varchar(15);
qt_peso_apos_filtragem_w		double precision;
qt_volume_apos_filtragem_w		smallint;
dt_validade_apos_filtragem_w		timestamp;
dt_fim_prod_emprestimo_w		timestamp;
nm_usuario_ini_prod_emp_w		varchar(15);
nm_usuario_fim_prod_emp_w		varchar(15);
nm_usuario_conferencia_w		varchar(15);
dt_conferencia_w			timestamp;
qt_volume_ant_w				integer;

nr_new_seq_prod_w			bigint;
cd_regional_w				bigint;
nr_seq_emp_ent_ww			bigint;
vl_padrao_barras_hemo_w			varchar(255);
qt_alicotada_w				bigint;
ie_alterar_sangue_w			varchar(1);
cd_divisao_isbt_w			varchar(2);
cd_divisa_isbt_orig_w			varchar(2);
cd_divisa_isbt_novo_w			varchar(2);
ds_alfabeto_w				varchar(255);
ie_pos_char_w				varchar(2);


BEGIN

ie_aliquotado_w		:= obter_valor_param_usuario(450,219, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p);
ie_alterar_sangue_w	:= obter_valor_param_usuario(450,437, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p);
ds_alfabeto_w		:= 'abcdefghijklmnopqrstuvxwyz';
select	qt_volume,
	cd_pf_realizou,
	nr_seq_derivado,
	nr_sangue,
	nr_seq_doacao,
	ie_irradiado,
	ie_lavado,
	ie_filtrado,
	nr_seq_emp_ent,
	dt_inicio_prod_emprestimo,
	dt_liberacao,
	ie_tipo_sangue,
	ie_fator_rh,
	nm_doador,
	dt_utilizacao,
	dt_termino_util,
	nr_sec_saude,
	nm_usuario_lib,
	nr_seq_equipo,
	nr_seq_lote_equipo,
	dt_val_equipo,
	nr_seq_lote,
	qt_unidade_derivado,
	qt_unidade_deriv_util,
	nr_seq_atend_pac_unid,
	cd_barras,
	ie_aferese,
	nm_usuario_irradiacao,
	nm_usuario_lavado,
	qt_peso_bolsa,
	qt_peso_bolsa_vazia,
	dt_fim_repouso,
	dt_inicio_repouso,
	dt_fim_filtragem,
	dt_inicio_filtragem,
	nr_seq_conservante,
	cd_material,
	dt_validade_conservante,
	dt_fim_alicotagem,
	nm_usuario_fim_alico,
	dt_recebimento,
	nm_usuario_recebimento,
	nr_seq_armazenamento,
	nm_usuario_ent_estoque,
	dt_entrada_estoque,
	qt_dose_estoque,
	dt_inicio_producao,
	nm_usuario_ini_producao,
	dt_fim_producao,
	nm_usuario_fim_producao,
	qt_peso_apos_filtragem,
	qt_volume_apos_filtragem,
	dt_validade_apos_filtragem,
	dt_fim_prod_emprestimo,
	nm_usuario_ini_prod_emprestimo,
	nm_usuario_fim_prod_emprestimo,
	nm_usuario_conferencia,
	dt_conferencia,
	coalesce(cd_divisao_isbt,'00')
into STRICT	qt_volume_w,
	cd_pf_realizou_w,
	nr_seq_derivado_w,
	nr_sangue_w,
	nr_seq_doacao_w,
	ie_irradiado_w,
	ie_lavado_w,
	ie_filtrado_w,
	nr_seq_emp_ent_w,
	dt_inicio_prod_emprestimo_w,
	dt_liberacao_w,
	ie_tipo_sangue_w,
	ie_fator_rh_w,
	nm_doador_w,
	dt_utilizacao_w,
	dt_termino_util_w,
	nr_sec_saude_w,
	nm_usuario_lib_w,
	nr_seq_equipo_w,
	nr_seq_lote_equipo_w,
	dt_val_equipo_w,
	nr_seq_lote_w,
	qt_unidade_derivado_w,
	qt_unidade_deriv_util_w,
	nr_seq_atend_pac_unid_w,
	cd_barras_w,
	ie_aferese_w,
	nm_usuario_irradiacao_w,
	nm_usuario_lavado_w,
	qt_peso_bolsa_w,
	qt_peso_bolsa_vazia_w,
	dt_fim_repouso_w,
	dt_inicio_repouso_w,
	dt_fim_filtragem_w,
	dt_inicio_filtragem_w,
	nr_seq_conservante_w,
	cd_material_w,
	dt_validade_conservante_w,
	dt_fim_alicotagem_w,
	nm_usuario_fim_alico_w,
	dt_recebimento_w,
	nm_usuario_recebimento_w,
	nr_seq_armazenamento_w,
	nm_usuario_ent_estoque_w,
	dt_entrada_estoque_w,
	qt_dose_estoque_w,
	dt_inicio_producao_w,
	nm_usuario_ini_producao_w,
	dt_fim_producao_w,
	nm_usuario_fim_producao_w,
	qt_peso_apos_filtragem_w,
	qt_volume_apos_filtragem_w,
	dt_validade_apos_filtragem_w,
	dt_fim_prod_emprestimo_w,
	nm_usuario_ini_prod_emp_w,
	nm_usuario_fim_prod_emp_w,
	nm_usuario_conferencia_w,
	dt_conferencia_w,
	cd_divisao_isbt_w
from  	san_producao
where	nr_sequencia = nr_seq_producao_p;

select (qt_volume_w - qt_volume_p)
into STRICT	qt_volume_ww
;

if (cd_divisao_isbt_w = '00') then
	cd_divisa_isbt_orig_w	:= 'A0';
	cd_divisa_isbt_novo_w	:= 'B0';
else
	if (substr(cd_divisao_isbt_w,2,1) = '0') then
		cd_divisa_isbt_orig_w	:= substr(cd_divisao_isbt_w,1,1)||'a';
		cd_divisa_isbt_novo_w	:= substr(cd_divisao_isbt_w,1,1)||'b';
	else
		select	max(position(substr(cd_divisao_isbt,2,1) in ds_alfabeto_w))
		into STRICT	ie_pos_char_w
		from	san_producao
		where	nr_seq_doacao	= nr_seq_doacao_w
		and	nr_seq_derivado	= nr_seq_derivado_w;

		cd_divisa_isbt_orig_w	:= cd_divisao_isbt_w;
		cd_divisa_isbt_novo_w	:= substr(cd_divisao_isbt_w,1,1)||substr(ds_alfabeto_w, ie_pos_char_w + 1, 1);
	end if;
end if;

update	san_producao
set	qt_volume	=	qt_volume_ww,
	dt_vencimento	= 	CASE WHEN ie_aliquotado_w='S' THEN dt_validade_p  ELSE dt_vencimento END ,
	ie_aliquotado	= 	'S',
	ie_sistema_aliquotagem = ie_sistema_aliquota_p,
	cd_divisao_isbt	= 	cd_divisa_isbt_orig_w
where	nr_sequencia 	=	nr_seq_producao_p;


select	nextval('san_producao_seq')
into STRICT	nr_new_seq_prod_w
;

if (cd_barras_w IS NOT NULL AND cd_barras_w::text <> '') then
	vl_padrao_barras_hemo_w	:= obter_valor_param_usuario(450, 346, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);

	select	coalesce(max(x.cd_regional),0)
	into STRICT	cd_regional_w
	from	san_parametro x;

	select	coalesce(substr(x.nr_seq_emp_ent,1,3),0)
	into STRICT	nr_seq_emp_ent_ww
	from	san_producao x
	where	x.nr_sequencia = nr_seq_producao_p;

	if (vl_padrao_barras_hemo_w = 'C') then
		cd_barras_w := replace(cd_regional_w||to_char(nr_seq_emp_ent_ww ,'000')||to_char(nr_new_seq_prod_w ,'0000000')||to_char(nr_seq_derivado_w ,'00'),' ','');
	end if;
else
	cd_barras_w := null;
end if;

if (ie_alterar_sangue_w = 'S') then

	select	count(*)
	into STRICT	qt_alicotada_w
	from	san_producao
	where	nr_seq_prod_origem = nr_seq_producao_p;

	nr_sangue_w := nr_sangue_w || lpad(qt_alicotada_w + 1,2,0);
end if;

insert	into	san_producao(
			nr_sequencia,
			nr_seq_derivado,
			dt_producao,
			cd_pf_realizou,
			dt_atualizacao,
			nm_usuario,
			dt_vencimento,
			nr_sangue,
			ie_irradiado,
			ie_lavado,
			ie_filtrado,
			ie_aliquotado,
			nr_seq_prod_origem,
			nr_seq_doacao,
			qt_volume,
			dt_inicio_alicotagem,
			nm_usuario_ini_alico,
			nr_seq_emp_ent,
			dt_inicio_prod_emprestimo,
			nm_usuario_ini_prod_emprestimo,
			dt_liberacao,
			nm_doador,
			dt_utilizacao,
			dt_termino_util,
			nr_sec_saude,
			nm_usuario_lib,
			nr_seq_equipo,
			nr_seq_lote_equipo,
			dt_val_equipo,
			nr_seq_lote,
			qt_unidade_derivado,
			qt_unidade_deriv_util,
			nr_seq_atend_pac_unid,
			cd_barras,
			ie_aferese,
			nm_usuario_irradiacao,
			nm_usuario_lavado,
			qt_peso_bolsa,
			qt_peso_bolsa_vazia,
			dt_fim_repouso,
			dt_inicio_repouso,
			dt_fim_filtragem,
			dt_inicio_filtragem,
			nr_seq_conservante,
			cd_material,
			dt_validade_conservante,
			dt_fim_alicotagem,
			nm_usuario_fim_alico,
			dt_recebimento,
			nm_usuario_recebimento,
			nr_seq_armazenamento,
			nm_usuario_ent_estoque,
			dt_entrada_estoque,
			qt_dose_estoque,
			dt_inicio_producao,
			nm_usuario_ini_producao,
			dt_fim_producao,
			nm_usuario_fim_producao,
			qt_peso_apos_filtragem,
			qt_volume_apos_filtragem,
			dt_validade_apos_filtragem,
			dt_fim_prod_emprestimo,
			nm_usuario_fim_prod_emprestimo,
			nm_usuario_conferencia,
			dt_conferencia,
			ie_tipo_sangue,
			ie_fator_rh,
			ie_sistema_aliquotagem,
			cd_divisao_isbt,
			cd_estabelecimento)
		values (
			nr_new_seq_prod_w,
			nr_seq_derivado_w,
			clock_timestamp(),
			cd_pf_realizou_w,
			clock_timestamp(),
			nm_usuario_p,
			dt_validade_p,
			nr_sangue_w,
			ie_irradiado_w,
			ie_lavado_w,
			ie_filtrado_w,
			'S',
			nr_seq_producao_p,
			nr_seq_doacao_w,
			qt_volume_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_emp_ent_w,
			dt_inicio_prod_emprestimo_w,
			nm_usuario_p,
			dt_liberacao_w,
			nm_doador_w,
			dt_utilizacao_w,
			dt_termino_util_w,
			nr_sec_saude_w,
			nm_usuario_lib_w,
			nr_seq_equipo_w,
			nr_seq_lote_equipo_w,
			dt_val_equipo_w,
			nr_seq_lote_w,
			qt_unidade_derivado_w,
			qt_unidade_deriv_util_w,
			nr_seq_atend_pac_unid_w,
			cd_barras_w,
			ie_aferese_w,
			nm_usuario_irradiacao_w,
			nm_usuario_lavado_w,
			qt_peso_bolsa_w,
			qt_peso_bolsa_vazia_w,
			dt_fim_repouso_w,
			dt_inicio_repouso_w,
			dt_fim_filtragem_w,
			dt_inicio_filtragem_w,
			nr_seq_conservante_w,
			cd_material_w,
			dt_validade_conservante_w,
			dt_fim_alicotagem_w,
			nm_usuario_fim_alico_w,
			dt_recebimento_w,
			nm_usuario_recebimento_w,
			nr_seq_armazenamento_w,
			nm_usuario_ent_estoque_w,
			dt_entrada_estoque_w,
			qt_dose_estoque_w,
			dt_inicio_producao_w,
			nm_usuario_ini_producao_w,
			dt_fim_producao_w,
			nm_usuario_fim_producao_w,
			qt_peso_apos_filtragem_w,
			qt_volume_apos_filtragem_w,
			dt_validade_apos_filtragem_w,
			dt_fim_prod_emprestimo_w,
			nm_usuario_fim_prod_emp_w,
			nm_usuario_conferencia_w,
			dt_conferencia_w,
			ie_tipo_sangue_w,
			ie_fator_rh_w,
			ie_sistema_aliquota_p,
			cd_divisa_isbt_novo_w,
			cd_estabelecimento_p);

CALL san_grava_log_producao_alterac(nr_seq_producao_p, qt_volume_w, qt_volume_ww, 'N', nm_usuario_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_fracionar_volume (nr_seq_producao_p bigint, nm_usuario_p text, qt_volume_p bigint, dt_validade_p timestamp, cd_perfil_p bigint, cd_estabelecimento_p bigint, ie_sistema_aliquota_p text) FROM PUBLIC;

