-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vincular_adto_conta_pac ( nr_interno_conta_p bigint, nr_adiantamento_p bigint, vl_adiantamento_p bigint, ie_tipo_adiant_p bigint, nm_usuario_p text) AS $body$
DECLARE

				   
nr_sequencia_w   	bigint := 0;
vl_total_conta_w	double precision := 0;			
vl_imposto_conta_w	double precision := 0;	
nr_atendimento_adiant_w		adiantamento.nr_atendimento%type;
nr_atendimento_conta_w		conta_paciente.nr_atendimento%type;
VL_VINCULADO_W			CONTA_PACIENTE_ADIANT.VL_ADIANTAMENTO%TYPE;
ie_recalcular_adto_conta_w	varchar(1);

BEGIN

select	coalesce(max(nr_sequencia),0) + 1
into STRICT 	nr_sequencia_w
from	conta_paciente_adiant
where	nr_adiantamento = nr_adiantamento_p;

select	coalesce(obter_valor_conta(nr_interno_conta_p,0),0) -- Obter o valor total da conta para vincular ao adto. OS 681330.
into STRICT	vl_total_conta_w
;


if (substr(philips_param_pck.get_cd_pais,1,1) = 2) then

	select	coalesce(sum(x.vl_imposto_conta),0) vl_imposto_conta ----------- ALTERADO/ADICIONADO PARA BUSCAR O VALOR DE IMPOSTO PARA SER CONSIDERADO AO VINCULAR UM ADIANTAMENTO
	into STRICT	vl_imposto_conta_w
	from (SELECT	coalesce(SUM(vl_imposto),0) vl_imposto_conta
		 FROM	matpaci_imposto a,
			material_atend_paciente b
		 WHERE	a.nr_seq_matpaci = b.nr_sequencia
		 AND	b.nr_interno_conta = nr_interno_conta_p
		
union

		 SELECT	coalesce(SUM(vl_imposto),0) vl_imposto_conta
		 FROM	propaci_imposto a,
			procedimento_paciente b
		 WHERE	a.nr_seq_propaci = b.nr_sequencia
		 AND	b.nr_interno_conta = nr_interno_conta_p) x;

	vl_total_conta_w := vl_total_conta_w + vl_imposto_conta_w;	----------- ALTERADO/ADICIONADO PARA BUSCAR O VALOR DE IMPOSTO PARA SER CONSIDERADO AO VINCULAR UM ADIANTAMENTO
end if;


select	coalesce(sum(vl_adiantamento),0)
into STRICT	vl_vinculado_w
from	conta_paciente_adiant
where	nr_interno_conta = nr_interno_conta_p;

ie_recalcular_adto_conta_w	:= obter_valor_param_usuario(67, 744, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo);

if	((vl_vinculado_w - vl_total_conta_w) = 0) and (coalesce(ie_recalcular_adto_conta_w,'N') = 'N') then --Se o parametro for N (padrao), deve continuar consistindo como sempre fez
	
	CALL wheb_mensagem_pck.exibir_mensagem_abort(871954);
	
end if;

if (vl_vinculado_w > 0) and (vl_total_conta_w - vl_vinculado_w > 0) then
	vl_total_conta_w := vl_total_conta_w - vl_vinculado_w;
end if;

if (vl_adiantamento_p < vl_total_conta_w) then -- Se o valor do adiantamento for menor que o valor da conta, vincular o valor total do adiantamneto. 
	vl_total_conta_w := vl_adiantamento_p;	
end if;

if ( nr_sequencia_w > 0 ) then

	insert into conta_paciente_adiant(   DT_ATUALIZACAO,
					     IE_TIPO_ADIANT,
					     NM_USUARIO,
					     NR_ADIANTAMENTO,
					     NR_INTERNO_CONTA,
					     NR_SEQUENCIA,
					     VL_ADIANTAMENTO)
				     VALUES ( clock_timestamp(),
					      2,
					      nm_usuario_p,
					      nr_adiantamento_p,
					      nr_interno_conta_p,
					      nr_sequencia_w,
					      coalesce(vl_total_conta_w,vl_adiantamento_p));	

	/*OS926692a aamfirmo - Verificar se o adiantamento esta vinculado a uma conta paciente*/
						
	select	max(a.nr_atendimento)
	into STRICT	nr_atendimento_adiant_w
	from	adiantamento a
	where	a.nr_adiantamento = nr_adiantamento_p;
	
	/*OS926692a aamfirmo -  Se nao tiver vinculado , pegar o atendimento da conta e vincular no adiantamento*/
	
	if (coalesce(nr_atendimento_adiant_w::text, '') = '') then
	
		select	max(a.nr_atendimento)
		into STRICT	nr_atendimento_conta_w
		from	conta_paciente a
		where	nr_interno_conta	= nr_interno_conta_p;
	
		if (nr_atendimento_conta_w IS NOT NULL AND nr_atendimento_conta_w::text <> '') then

			update	adiantamento
			set		nr_atendimento	= nr_atendimento_conta_w
			where	nr_adiantamento	= nr_adiantamento_p;	
		
		end if;
		
	end if;
						
end if;

--Atualizar_Saldo_Adiantamento(nr_adiantamento_p,nm_usuario_p,null);
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vincular_adto_conta_pac ( nr_interno_conta_p bigint, nr_adiantamento_p bigint, vl_adiantamento_p bigint, ie_tipo_adiant_p bigint, nm_usuario_p text) FROM PUBLIC;

