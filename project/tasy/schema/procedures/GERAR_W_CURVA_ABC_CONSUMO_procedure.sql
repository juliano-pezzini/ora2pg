-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_curva_abc_consumo (( cd_estabelecimento_p bigint, cd_local_estoque_p bigint, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, cd_material_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, vl_curva_a_p bigint default 70, vl_curva_b_p bigint default 20, vl_curva_c_p bigint default 10, ds_lista_grupo_p text default null, ds_lista_subgrupo_p text default null, ds_lista_classe_p text default null, ds_lista_local_p text default null, ds_lista_ccusto_p text default null, ie_vl_qt_p text default 'VL') as nr_sequencia_w bigint) RETURNS varchar AS $body$
DECLARE


ds_opcoes_w	 varchar(4000);


BEGIN
ds_opcoes_w := ds_opcoes_p;
ds_opcoes_w := replace(ds_opcoes_w,'-','');
ds_opcoes_w := replace(ds_opcoes_w,'(','');
ds_opcoes_w := replace(ds_opcoes_w,')','');
ds_opcoes_w := coalesce(ds_opcoes_w,'X');

return ds_opcoes_w;

end;

function obter_filtro_negativo(ds_opcoes_p varchar2)
		return varchar2 is

ie_contido_w	varchar2(5);

begin

ie_contido_w := 'S';

if	((position('-' in coalesce(ds_opcoes_p,'X')) > 0) or (position('NOT' in coalesce(upper(ds_opcoes_p),'X')) > 0)) then
	begin
	ie_contido_w := 'N';
	end;
end if;

return ie_contido_w;
		
end;

begin
if (vl_curva_a_p > 0) then
	vl_curvaa_w := vl_curva_a_p;
end if;
if (vl_curva_b_p > 0) then
	vl_curvab_w := vl_curva_b_p;
end if;
if (vl_curva_c_p > 0) then
	vl_curvac_w := vl_curva_c_p;
end if;

if	((vl_curvaa_w + vl_curvab_w + vl_curvac_w) <> 100)  then
	/*a soma das curvas deve totalizar 100%.*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(269470);
end if;

qt_ano_inicial_w	:= somente_numero(to_char(dt_inicio_p,'yyyy'));
qt_ano_final_w	:= somente_numero(to_char(dt_fim_p,'yyyy'));
qt_mes_inicial_w	:= somente_numero(to_char(dt_inicio_p,'mm'));
qt_mes_final_w	:= somente_numero(to_char(dt_fim_p,'mm'));
qt_meses_w	:= (qt_ano_final_w - qt_ano_inicial_w) * 12;
qt_meses_w	:= (qt_meses_w - qt_mes_inicial_w) + qt_mes_final_w + 1;

delete FROM w_curva_abc_estoque;

ds_comando_w	:= 	
	' insert into w_curva_abc_estoque(' || chr(13) || chr(10) ||
	' 	cd_estabelecimento,' || chr(13) || chr(10) ||
	' 	cd_material,' || chr(13) || chr(10) ||
	' 	qt_estoque,' || chr(13) || chr(10) ||
	' 	vl_estoque)' || chr(13) || chr(10) ||
	' select	:cd_estabelecimento,' || chr(13) || chr(10) ||
	' 	a.cd_material,' || chr(13) || chr(10) ||
	' 	sum (decode(o.ie_consumo,' || chr(13) || chr(10) ||
	' 		''A'', a.qt_estoque,' || chr(13) || chr(10) ||
	' 		''D'', a.qt_estoque * -1, 0)) qt_estoque,' || chr(13) || chr(10) ||
	' 	sum (decode(o.ie_consumo,' || chr(13) || chr(10) ||
	' 		''A'', a.vl_estoque + a.vl_consignado,' || chr(13) || chr(10) ||
	' 		''D'', (a.vl_estoque + a.vl_consignado) * -1, 0)) vl_estoque' || chr(13) || chr(10) ||
	' from	resumo_movto_estoque a,' || chr(13) || chr(10) ||
	' 	operacao_estoque o,' || chr(13) || chr(10) ||
	' 	material m,' || chr(13) || chr(10) ||
	' 	estrutura_material_v e' || chr(13) || chr(10) ||
	' where	a.cd_operacao_estoque   = o.cd_operacao_estoque' || chr(13) || chr(10) ||
	' and	a.cd_material = m.cd_material' || chr(13) || chr(10) ||
	' and	a.cd_material = e.cd_material' || chr(13) || chr(10) ||
	' and	nvl(m.ie_curva_abc,''N'') = ''S''' || chr(13) || chr(10) ||
	' and	a.ie_consignado = ''N''' || chr(13) || chr(10) ||
	' and	a.cd_estabelecimento = :cd_estabelecimento ' || chr(13) || chr(10);

ds_parametro_w	:= 'cd_estabelecimento='||cd_estabelecimento_p||';';
	
if (cd_grupo_material_p > 0) then	
	ds_comando_w	:= ds_comando_w	|| ' and e.cd_grupo_material = :cd_grupo_material ' || chr(13) || chr(10);
	ds_parametro_w	:= ds_parametro_w || 'cd_grupo_material='||cd_grupo_material_p||';';
end if;

if (cd_subgrupo_material_p > 0) then	
	ds_comando_w	:= ds_comando_w	|| ' and e.cd_subgrupo_material = :cd_subgrupo_material ' || chr(13) || chr(10);
	ds_parametro_w	:= ds_parametro_w || 'cd_subgrupo_material='||cd_subgrupo_material_p||';';
end if;

if (cd_classe_material_p > 0) then	
	ds_comando_w	:= ds_comando_w	|| ' and e.cd_classe_material = :cd_classe_material ' || chr(13) || chr(10);
	ds_parametro_w	:= ds_parametro_w || 'cd_classe_material='||cd_classe_material_p||';';
end if;

if (cd_material_p > 0) then	
	ds_comando_w	:= ds_comando_w	|| ' and e.cd_material = :cd_material ' || chr(13) || chr(10);
	ds_parametro_w	:= ds_parametro_w || 'cd_material='||cd_material_p||';';
end if;

if (cd_local_estoque_p > 0) then	
	ds_comando_w	:= ds_comando_w	|| ' and a.cd_local_estoque = :cd_local_estoque ' || chr(13) || chr(10);
	ds_parametro_w	:= ds_parametro_w || 'cd_local_estoque='||cd_local_estoque_p||';';
end if;

if (coalesce(ds_lista_grupo_p,'X') <> 'X') then
	ds_comando_w	:= ds_comando_w	|| ' and obter_se_contido(e.cd_grupo_material, ''' || obter_filtro_tratado(ds_lista_grupo_p) || ''') = '''|| obter_filtro_negativo(ds_lista_grupo_p) ||''' ' || chr(13) || chr(10);
end if;

if (coalesce(ds_lista_subgrupo_p,'X') <> 'X') then
	ds_comando_w	:= ds_comando_w	|| ' and obter_se_contido(e.cd_subgrupo_material, ''' || obter_filtro_tratado(ds_lista_subgrupo_p) || ''') = '''|| obter_filtro_negativo(ds_lista_subgrupo_p) ||''' ' || chr(13) || chr(10);
end if;

if (coalesce(ds_lista_classe_p,'X') <> 'X') then
	ds_comando_w	:= ds_comando_w	|| ' and obter_se_contido(e.cd_classe_material, ''' || obter_filtro_tratado(ds_lista_classe_p) || ''') = '''|| obter_filtro_negativo(ds_lista_classe_p) ||''' ' || chr(13) || chr(10);
end if;

if (coalesce(ds_lista_local_p,'X') <> 'X') then
	ds_comando_w	:= ds_comando_w	|| ' and obter_se_contido(a.cd_local_estoque, ''' || obter_filtro_tratado(ds_lista_local_p) || ''') = ''' || obter_filtro_negativo(ds_lista_local_p) ||''' ' || chr(13) || chr(10);
end if;

if (coalesce(ds_lista_ccusto_p,'X') <> 'X') then
	ds_comando_w  := ds_comando_w	|| ' and obter_se_contido(a.cd_centro_custo, ''' || obter_filtro_tratado(ds_lista_ccusto_p) || ''') = '''|| obter_filtro_negativo(ds_lista_ccusto_p) ||''' ' || chr(13) || chr(10);
end if;

ds_comando_w	:= ds_comando_w	|| ' and a.dt_mesano_referencia between :dt_inicio and :dt_fim ' || chr(13) || chr(10);
ds_parametro_w	:= ds_parametro_w || 'dt_inicio='||to_char(dt_inicio_p,'dd/mm/yyyy hh24:mi:ss')||';';
ds_parametro_w	:= ds_parametro_w || 'dt_fim='||to_char(dt_fim_p,'dd/mm/yyyy hh24:mi:ss')||';';
ds_comando_w	:= ds_comando_w	|| ' group by a.cd_material';

CALL exec_sql_dinamico_bv('gerar_w_curva_abc_consumo', ds_comando_w, ds_parametro_w);

update	w_curva_abc_estoque
set	vl_estoque = dividir(vl_estoque, qt_meses_w),
	qt_estoque = dividir(qt_estoque, qt_meses_w);
	
commit;

vl_estoque_acum_w	:= 0;
pr_estoque_w		:= 0;
pr_acumulado_w		:= 0;

select	sum(vl_estoque)
into STRICT	vl_total_estoque_w
from	w_curva_abc_estoque;

open c01;
loop
fetch c01 into
	cd_estabelecimento_w,
	cd_material_w,
	qt_estoque_w,
	vl_estoque_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	select	coalesce(max(nr_sequencia), 0) + 1
	into STRICT	nr_sequencia_w
	from	w_curva_abc_estoque;

	vl_estoque_acum_w	:= vl_estoque_acum_w + vl_estoque_w;
	pr_estoque_w		:= dividir((vl_estoque_w * 100), vl_total_estoque_w);
	pr_acumulado_w		:= pr_acumulado_w + pr_estoque_w;

	if (pr_acumulado_w <= vl_curvaa_w) then
		ie_curva_w	:= 'A';
	elsif (pr_acumulado_w <= vl_curvaa_w + vl_curvab_w) then
		ie_curva_w	:= 'B';
	else
		ie_curva_w	:= 'C';
	end if;

	update	w_curva_abc_estoque
	set	nr_sequencia	= nr_sequencia_w,
		vl_acumulado	= vl_estoque_acum_w,
		ie_curva		= ie_curva_w,
		pr_estoque	= pr_estoque_w,
		pr_acumulado	= pr_acumulado_w
	where	cd_material	= cd_material_w
	and	cd_estabelecimento = cd_estabelecimento_w;
	end;
end loop;
close c01;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_curva_abc_consumo (( cd_estabelecimento_p bigint, cd_local_estoque_p bigint, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, cd_material_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, vl_curva_a_p bigint default 70, vl_curva_b_p bigint default 20, vl_curva_c_p bigint default 10, ds_lista_grupo_p text default null, ds_lista_subgrupo_p text default null, ds_lista_classe_p text default null, ds_lista_local_p text default null, ds_lista_ccusto_p text default null, ie_vl_qt_p text default 'VL') as nr_sequencia_w bigint) FROM PUBLIC;

