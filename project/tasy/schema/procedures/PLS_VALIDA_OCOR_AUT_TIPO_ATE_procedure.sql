-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_valida_ocor_aut_tipo_ate ( nr_seq_ocor_combinada_p bigint, nr_seq_ocorrencia_p bigint, nr_seq_motivo_glosa_p bigint, nr_seq_guia_p bigint, nr_seq_requisicao_p bigint, nr_seq_execucao_p bigint, ie_utiliza_filtro_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Realizar a validação
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
------------------------------------------------------------------------------------------------------------------
Pontos de atenção:Performance.
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_prestador_w		bigint;
nr_seq_segurado_w		bigint;
nr_seq_requisicao_w		bigint;
nr_seq_regra_w			bigint;
ie_regra_w			varchar(2);
ie_tipo_item_w			bigint;
ie_tipo_ocorrencia_w		varchar(2);
ie_gerar_ocorrencia_w		varchar(2)	:= 'N';
ie_tipo_atendimento_w		pls_requisicao.ie_tipo_atendimento%type;
ie_tipo_guia_w			pls_requisicao.ie_tipo_guia%type;
ie_gerar_ocor_atend_w		varchar(2);
ie_gerou_ocor_cabecalho_w	varchar(2);
nr_seq_oc_benef_w		bigint;
nr_seq_lote_exec_w		pls_execucao_requisicao.nr_seq_lote_exec%type;

C01 CURSOR FOR
	SELECT	ie_exige_tipo_atend
	from	pls_validacao_aut_tipo_ate
	where	nr_seq_ocor_aut_combinada	= nr_seq_ocor_combinada_p
	and	ie_situacao			= 'A';

C02 CURSOR FOR
	SELECT	nr_sequencia,
		cd_procedimento,
		ie_origem_proced
	from	pls_guia_plano_proc
	where	nr_seq_guia		= nr_seq_guia_p;

C03 CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_material
	from	pls_guia_plano_mat
	where	nr_seq_guia		= nr_seq_guia_p;

C04 CURSOR FOR
	SELECT	nr_sequencia,
		cd_procedimento,
		ie_origem_proced
	from	pls_requisicao_proc
	where	nr_seq_requisicao	= nr_seq_requisicao_p;

C05 CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_material
	from	pls_requisicao_mat
	where	nr_seq_requisicao	= nr_seq_requisicao_p;

C06 CURSOR FOR
	SELECT	nr_sequencia,
		cd_procedimento,
		ie_origem_proced
	from	pls_execucao_req_item
	where	nr_seq_execucao		= nr_seq_execucao_p
	and	(cd_procedimento IS NOT NULL AND cd_procedimento::text <> '')
	and	(ie_origem_proced IS NOT NULL AND ie_origem_proced::text <> '');

C07 CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_material
	from	pls_execucao_req_item
	where	nr_seq_execucao		= nr_seq_execucao_p
	and	(nr_seq_material IS NOT NULL AND nr_seq_material::text <> '');
BEGIN
	for r_C01_w in C01 loop
		begin
			if (nr_seq_guia_p IS NOT NULL AND nr_seq_guia_p::text <> '') then
				begin
					select	nr_seq_prestador,
						nr_seq_segurado,
						ie_tipo_atend_tiss,
						ie_tipo_guia
					into STRICT	nr_seq_prestador_w,
						nr_seq_segurado_w,
						ie_tipo_atendimento_w,
						ie_tipo_guia_w
					from	pls_guia_plano
					where	nr_sequencia	= nr_seq_guia_p;
				exception
				when others then
					nr_seq_prestador_w	:= null;
					nr_seq_segurado_w	:= null;
					ie_tipo_atendimento_w	:= null;
					ie_tipo_guia_w		:= null;
				end;

				ie_gerar_ocor_atend_w := 'S';

				if (coalesce(r_C01_w.ie_exige_tipo_atend, 'N') = 'S') and (coalesce(ie_tipo_atendimento_w::text, '') = '') and (ie_tipo_guia_w = '2') then
					ie_gerar_ocor_atend_w := 'S';
				else
					ie_gerar_ocor_atend_w := 'N';
				end if;

				for r_C02_w in C02 loop
					begin
						ie_gerar_ocorrencia_w	:= 'S';

						if (ie_utiliza_filtro_p	= 'S') then
							/* Tratamento para filtros */

							SELECT * FROM pls_gerar_ocor_aut_filtro(	nr_seq_ocor_combinada_p, nr_seq_guia_p, null, null, r_C02_w.nr_sequencia, null, null, null, null, r_C02_w.cd_procedimento, r_C02_w.ie_origem_proced, null, null, nr_seq_prestador_w, null, null, null, null, nm_usuario_p, ie_regra_w, ie_tipo_ocorrencia_w) INTO STRICT ie_regra_w, ie_tipo_ocorrencia_w;

							if (ie_regra_w	= 'S') then
								ie_gerar_ocorrencia_w	:= 'S';
							elsif (ie_regra_w	in ('E','N')) then
								ie_gerar_ocorrencia_w	:= 'N';
							end if;
						end if;

						if (ie_gerar_ocorrencia_w	= 'S') then

							ie_gerar_ocorrencia_w	:= ie_gerar_ocor_atend_w;

							if (ie_gerar_ocorrencia_w	= 'S') then

								nr_seq_oc_benef_w := pls_inserir_ocorrencia(	nr_seq_segurado_w, nr_seq_ocorrencia_p, null, nr_seq_guia_p, null, null, null, nr_seq_ocor_combinada_p, nm_usuario_p, null, nr_seq_motivo_glosa_p, 7, cd_estabelecimento_p, 'N', null, nr_seq_oc_benef_w, null, null, null, null);

								CALL pls_atualizar_status_ocor_comb(	nr_seq_ocorrencia_p, nr_seq_ocor_combinada_p, nr_seq_motivo_glosa_p,
												nr_seq_guia_p, null, null,
												r_C02_w.nr_sequencia, null, null,
												null, null, null,
												nm_usuario_p, cd_estabelecimento_p);
							end if;
						end if;
					end;
				end loop;
				for r_C03_w in C03 loop
					begin
						ie_gerar_ocorrencia_w	:= 'S';

						if (ie_utiliza_filtro_p	= 'S') then
						/* Tratamento para filtros */

							SELECT * FROM pls_gerar_ocor_aut_filtro(	nr_seq_ocor_combinada_p, nr_seq_guia_p, null, null, null, r_C03_w.nr_sequencia, null, null, null, null, null, r_C03_w.nr_seq_material, null, nr_seq_prestador_w, nr_seq_ocorrencia_p, null, null, null, nm_usuario_p, ie_regra_w, ie_tipo_ocorrencia_w) INTO STRICT ie_regra_w, ie_tipo_ocorrencia_w;


							if (ie_regra_w	= 'S') then
								ie_gerar_ocorrencia_w	:= 'S';
							elsif (ie_regra_w	in ('E','N')) then
								ie_gerar_ocorrencia_w	:= 'N';
							end if;
						end if;

						if (ie_gerar_ocorrencia_w	= 'S') then

							ie_gerar_ocorrencia_w	:= ie_gerar_ocor_atend_w;

							if (ie_gerar_ocorrencia_w	= 'S') then
								nr_seq_oc_benef_w := pls_inserir_ocorrencia(	nr_seq_segurado_w, nr_seq_ocorrencia_p, null, nr_seq_guia_p, null, null, null, nr_seq_ocor_combinada_p, nm_usuario_p, null, nr_seq_motivo_glosa_p, 7, cd_estabelecimento_p, 'N', null, nr_seq_oc_benef_w, null, null, null, null);

								CALL pls_atualizar_status_ocor_comb(	nr_seq_ocorrencia_p, nr_seq_ocor_combinada_p, nr_seq_motivo_glosa_p,
												nr_seq_guia_p, null, null,
												null, r_C03_w.nr_sequencia, null,
												null, null, null,
												nm_usuario_p, cd_estabelecimento_p);

							end if;
						end if;
					end;
				end loop;
			elsif (nr_seq_requisicao_p IS NOT NULL AND nr_seq_requisicao_p::text <> '') then
				begin
					select	nr_seq_prestador,
						nr_seq_segurado,
						ie_tipo_atendimento,
						ie_tipo_guia
					into STRICT	nr_seq_prestador_w,
						nr_seq_segurado_w,
						ie_tipo_atendimento_w,
						ie_tipo_guia_w
					from	pls_requisicao
					where	nr_sequencia	= nr_seq_requisicao_p;
					exception
					when others then
						nr_seq_prestador_w	:= null;
						nr_seq_segurado_w	:= null;
						ie_tipo_atendimento_w	:= null;
				end;

				ie_gerar_ocor_atend_w := 'S';

				if (coalesce(r_C01_w.ie_exige_tipo_atend, 'N') = 'S') and (coalesce(ie_tipo_atendimento_w::text, '') = '') and (ie_tipo_guia_w = '2') then
					ie_gerar_ocor_atend_w := 'S';
				else
					ie_gerar_ocor_atend_w := 'N';
				end if;

				for r_C04_w in C04 loop
					begin
						ie_gerar_ocorrencia_w	:= 'S';

						if (ie_utiliza_filtro_p	= 'S') then
						/* Tratamento para filtros */

							SELECT * FROM pls_gerar_ocor_aut_filtro(	nr_seq_ocor_combinada_p, null, nr_seq_requisicao_p, null, null, null, r_C04_w.nr_sequencia, null, null, r_C04_w.cd_procedimento, r_C04_w.ie_origem_proced, null, null, nr_seq_prestador_w, nr_seq_ocorrencia_p, null, null, null, nm_usuario_p, ie_regra_w, ie_tipo_ocorrencia_w) INTO STRICT ie_regra_w, ie_tipo_ocorrencia_w;

							if (ie_regra_w	= 'S') then
								ie_gerar_ocorrencia_w	:= 'S';
							elsif (ie_regra_w	in ('E','N')) then
								ie_gerar_ocorrencia_w	:= 'N';
							end if;
						end if;

						if (ie_gerar_ocorrencia_w	= 'S') then

							ie_gerar_ocorrencia_w	:= ie_gerar_ocor_atend_w;

							if (ie_gerar_ocorrencia_w	= 'S') then
								nr_seq_oc_benef_w := pls_inserir_ocorrencia(	nr_seq_segurado_w, nr_seq_ocorrencia_p, nr_seq_requisicao_p, null, null, null, null, nr_seq_ocor_combinada_p, nm_usuario_p, null, nr_seq_motivo_glosa_p, 9, cd_estabelecimento_p, 'N', null, nr_seq_oc_benef_w, null, null, null, null);

								CALL pls_atualizar_status_ocor_comb(	nr_seq_ocorrencia_p, nr_seq_ocor_combinada_p, nr_seq_motivo_glosa_p,
												null, nr_seq_requisicao_p, null,
												null, null, r_C04_w.nr_sequencia,
												null, null, null,
												nm_usuario_p, cd_estabelecimento_p);
							end if;
						end if;
					end;
				end loop;
				for r_C05_w in C05 loop
					begin
						ie_gerar_ocorrencia_w	:= 'S';

						if (ie_utiliza_filtro_p	= 'S') then
						/* Tratamento para filtros */

							SELECT * FROM pls_gerar_ocor_aut_filtro(	nr_seq_ocor_combinada_p, null, nr_seq_requisicao_p, null, null, null, null, r_C05_w.nr_sequencia, null, null, null, r_C05_w.nr_seq_material, null, nr_seq_prestador_w, nr_seq_ocorrencia_p, null, null, null, nm_usuario_p, ie_regra_w, ie_tipo_ocorrencia_w) INTO STRICT ie_regra_w, ie_tipo_ocorrencia_w;

							if (ie_regra_w	= 'S') then
								ie_gerar_ocorrencia_w	:= 'S';
							elsif (ie_regra_w	in ('E','N')) then
								ie_gerar_ocorrencia_w	:= 'N';
							end if;
						end if;

						if (ie_gerar_ocorrencia_w	= 'S') then

							ie_gerar_ocorrencia_w	:= ie_gerar_ocor_atend_w;

							if (ie_gerar_ocorrencia_w	= 'S') then
								nr_seq_oc_benef_w := pls_inserir_ocorrencia(	nr_seq_segurado_w, nr_seq_ocorrencia_p, nr_seq_requisicao_p, null, null, null, null, nr_seq_ocor_combinada_p, nm_usuario_p, null, nr_seq_motivo_glosa_p, 9, cd_estabelecimento_p, 'N', null, nr_seq_oc_benef_w, null, null, null, null);

								CALL pls_atualizar_status_ocor_comb(	nr_seq_ocorrencia_p, nr_seq_ocor_combinada_p, nr_seq_motivo_glosa_p,
												null, nr_seq_requisicao_p, null,
												null, r_C05_w.nr_sequencia, null,
												null, null, null,
												nm_usuario_p, cd_estabelecimento_p);
							end if;
						end if;
					end;
				end loop;
			elsif (nr_seq_execucao_p IS NOT NULL AND nr_seq_execucao_p::text <> '') then
				begin
					select	nr_seq_prestador,
						nr_seq_requisicao,
						nr_seq_lote_exec
					into STRICT	nr_seq_prestador_w,
						nr_seq_requisicao_w,
						nr_seq_lote_exec_w
					from	pls_execucao_requisicao
					where	nr_sequencia	= nr_seq_execucao_p;
				exception
				when others then
						nr_seq_prestador_w	:= null;
						nr_seq_requisicao_w	:= null;
				end;

				/*begin
				select	ie_tipo_atendimento,
				ie_tipo_guia
				into	ie_tipo_atendimento_w,
				ie_tipo_guia_w
				from	pls_execucao_req_item
				where	nr_seq_execucao	= nr_seq_execucao_p;
				exception
				when others then
				ie_tipo_atendimento_w	:= null;
				ie_tipo_guia_w		:= null;
				end;*/
				--Foram realizados os selects abaixo pois, ao realizar a consulta diretamente na tablea pls_execucao_req_item, as informações ainda não estão presentes na mesma
				begin
					select	nr_seq_segurado,
						ie_tipo_guia
					into STRICT	nr_seq_segurado_w,
						ie_tipo_guia_w
					from	pls_requisicao
					where	nr_sequencia	= nr_seq_requisicao_w;
				exception
				when others then
					nr_seq_segurado_w	:= null;
					ie_tipo_guia_w		:= null;
				end;

				begin
					select	max(ie_tipo_atendimento)
					into STRICT	ie_tipo_atendimento_w
					from	pls_itens_lote_execucao
					where	nr_seq_lote_exec = nr_seq_lote_exec_w;
				exception
				when others then
					ie_tipo_atendimento_w	:= null;
				end;

				if (coalesce(ie_tipo_atendimento_w::text, '') = '') then
					begin
						select	ie_tipo_atendimento
						into STRICT	ie_tipo_atendimento_w
						from	pls_requisicao
						where	nr_sequencia	= nr_seq_requisicao_w;
					exception
					when others then
						ie_tipo_atendimento_w	:= null;
					end;
				end if;

				ie_gerar_ocor_atend_w	:= 'S';

				if (coalesce(r_C01_w.ie_exige_tipo_atend, 'N') = 'S') and (coalesce(ie_tipo_atendimento_w::text, '') = '') and (ie_tipo_guia_w = '2') then
					ie_gerar_ocor_atend_w := 'S';
				else
					ie_gerar_ocor_atend_w := 'N';
				end if;

				for r_C06_w in C06 loop
					begin
						ie_gerar_ocorrencia_w	:= 'S';

						if (ie_utiliza_filtro_p	= 'S') then
							/* Tratamento para filtros */

							SELECT * FROM pls_gerar_ocor_aut_filtro(	nr_seq_ocor_combinada_p, null, null, nr_seq_execucao_p, null, null, null, null, r_C06_w.nr_sequencia, r_C06_w.cd_procedimento, r_C06_w.ie_origem_proced, null, null, nr_seq_prestador_w, nr_seq_ocorrencia_p, null, null, null, nm_usuario_p, ie_regra_w, ie_tipo_ocorrencia_w) INTO STRICT ie_regra_w, ie_tipo_ocorrencia_w;

							if (ie_regra_w	= 'S') then
								ie_gerar_ocorrencia_w	:= 'S';
							elsif (ie_regra_w	in ('E','N')) then
								ie_gerar_ocorrencia_w	:= 'N';
							end if;
						end if;

						if (ie_gerar_ocorrencia_w	= 'S') then

							ie_gerar_ocorrencia_w	:= ie_gerar_ocor_atend_w;

							if (ie_gerar_ocorrencia_w	= 'S') then
								nr_seq_oc_benef_w := pls_inserir_ocorrencia(	nr_seq_segurado_w, nr_seq_ocorrencia_p, null, null, null, null, null, nr_seq_ocor_combinada_p, nm_usuario_p, null, nr_seq_motivo_glosa_p, 10, cd_estabelecimento_p, 'N', nr_seq_execucao_p, nr_seq_oc_benef_w, null, null, null, null);

								CALL pls_atualizar_status_ocor_comb(	nr_seq_ocorrencia_p, nr_seq_ocor_combinada_p, nr_seq_motivo_glosa_p,
												null, null, nr_seq_execucao_p,
												null, null, null,
												null, r_C06_w.nr_sequencia, null,
												nm_usuario_p, cd_estabelecimento_p);
							end if;
						end if;
					end;
				end loop;

				for r_C07_w in C07 loop
					begin
						ie_gerar_ocorrencia_w	:= 'S';

						if (ie_utiliza_filtro_p	= 'S') then
							/* Tratamento para filtros */

							SELECT * FROM pls_gerar_ocor_aut_filtro(	nr_seq_ocor_combinada_p, null, null, nr_seq_execucao_p, null, null, null, null, r_C07_w.nr_sequencia, null, null, r_C07_w.nr_seq_material, ie_gerou_ocor_cabecalho_w, nr_seq_prestador_w, nr_seq_ocorrencia_p, null, null, null, nm_usuario_p, ie_regra_w, ie_tipo_ocorrencia_w) INTO STRICT ie_regra_w, ie_tipo_ocorrencia_w;

							if (ie_regra_w	= 'S') then
								ie_gerar_ocorrencia_w	:= 'S';
							elsif (ie_regra_w	in ('E','N')) then
								ie_gerar_ocorrencia_w	:= 'N';
							end if;
						end if;

						if (ie_gerar_ocorrencia_w	= 'S') then

							ie_gerar_ocorrencia_w	:= ie_gerar_ocor_atend_w;

							if (ie_gerar_ocorrencia_w	= 'S') then
								nr_seq_oc_benef_w := pls_inserir_ocorrencia(	nr_seq_segurado_w, nr_seq_ocorrencia_p, null, null, null, null, null, nr_seq_ocor_combinada_p, nm_usuario_p, null, nr_seq_motivo_glosa_p, 11, cd_estabelecimento_p, 'N', nr_seq_execucao_p, nr_seq_oc_benef_w, null, null, null, null);

								CALL pls_atualizar_status_ocor_comb(	nr_seq_ocorrencia_p, nr_seq_ocor_combinada_p, nr_seq_motivo_glosa_p,
												null, null, nr_seq_execucao_p,
												null, null, null,
												null, null, r_C07_w.nr_sequencia,
												nm_usuario_p, cd_estabelecimento_p);
							end if;
						end if;
					end;
				end loop;
			end if;
		end;
	end loop;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_valida_ocor_aut_tipo_ate ( nr_seq_ocor_combinada_p bigint, nr_seq_ocorrencia_p bigint, nr_seq_motivo_glosa_p bigint, nr_seq_guia_p bigint, nr_seq_requisicao_p bigint, nr_seq_execucao_p bigint, ie_utiliza_filtro_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

