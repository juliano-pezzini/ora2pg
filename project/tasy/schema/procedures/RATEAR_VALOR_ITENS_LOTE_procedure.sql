-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ratear_valor_itens_lote ( nr_seq_item_p bigint, vl_glosa_p bigint, vl_amenor_p bigint, cd_motivo_glosa_p bigint, vl_informado_p bigint, vl_total_p bigint, ie_atualiza_glosa_p text, ie_acao_glosa_p text, ds_observacao_p text, ie_tipo_valor_p text, ie_tipo_glosa_p text, cd_resposta_glosa_p text, cd_setor_responsavel_p bigint, nm_usuario_p text ) AS $body$
BEGIN
	if (ie_tipo_valor_p = 'AR') then
		if (vl_glosa_p IS NOT NULL AND vl_glosa_p::text <> '') and (vl_amenor_p IS NOT NULL AND vl_amenor_p::text <> '') and (nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '') then
			update lote_audit_hist_item
			set vl_glosa       = vl_glosa_p,
				vl_amenor         = vl_amenor_p,
				cd_motivo_glosa   = coalesce(cd_motivo_glosa_p,cd_motivo_glosa),
				ds_observacao     = coalesce(ds_observacao_p,ds_observacao),
				ie_acao_glosa     = coalesce(ie_acao_glosa_p,ie_acao_glosa),
				ie_tipo_glosa	  = coalesce(ie_tipo_glosa_p,ie_tipo_glosa),
				cd_resposta	  = coalesce(cd_resposta_glosa_p,cd_resposta),
				cd_setor_responsavel = coalesce(cd_setor_responsavel_p,cd_setor_responsavel),
				nm_usuario = nm_usuario_p,
				dt_atualizacao = clock_timestamp()
			where nr_sequencia = nr_seq_item_p;
		end if;
	else
		if (vl_informado_p IS NOT NULL AND vl_informado_p::text <> '') and (vl_total_p IS NOT NULL AND vl_total_p::text <> '') and (nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '') then
			if (ie_tipo_valor_p = 'A') then
				update lote_audit_hist_item
				set vl_glosa          = coalesce(dividir_sem_round((vl_informado_p * vl_glosa_informada), vl_total_p),0),
					cd_motivo_glosa      = coalesce(cd_motivo_glosa_p,cd_motivo_glosa),
					ds_observacao        = coalesce(ds_observacao_p,ds_observacao),
					ie_acao_glosa        = coalesce(ie_acao_glosa_p,ie_acao_glosa),
					ie_tipo_glosa	  = coalesce(ie_tipo_glosa_p,ie_tipo_glosa),
					cd_resposta	  = coalesce(cd_resposta_glosa_p,cd_resposta),
					cd_setor_responsavel = coalesce(cd_setor_responsavel_p,cd_setor_responsavel),
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp()
				where nr_sequencia    = nr_seq_item_p;
			elsif (ie_tipo_valor_p = 'R') then
				update lote_audit_hist_item
				set vl_amenor         = coalesce(dividir_sem_round((vl_informado_p * vl_glosa_informada), vl_total_p),0),
					cd_motivo_glosa      = coalesce(cd_motivo_glosa_p,cd_motivo_glosa),
					ds_observacao        = coalesce(ds_observacao_p,ds_observacao),
					ie_acao_glosa        = coalesce(ie_acao_glosa_p,ie_acao_glosa),
					ie_tipo_glosa	  = coalesce(ie_tipo_glosa_p,ie_tipo_glosa),
					cd_resposta	  = coalesce(cd_resposta_glosa_p,cd_resposta),
					cd_setor_responsavel = coalesce(cd_setor_responsavel_p,cd_setor_responsavel),
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp()
				where nr_sequencia    = nr_seq_item_p;
			elsif (ie_tipo_valor_p = 'P') then
				update lote_audit_hist_item
				set vl_pago        = coalesce(dividir_sem_round((vl_informado_p * vl_glosa_informada), vl_total_p),0),
					cd_motivo_glosa   = coalesce(cd_motivo_glosa_p,cd_motivo_glosa),
					ds_observacao     = coalesce(ds_observacao_p,ds_observacao),
					ie_acao_glosa     = coalesce(ie_acao_glosa_p,ie_acao_glosa),
					ie_tipo_glosa	  = coalesce(ie_tipo_glosa_p,ie_tipo_glosa),
					cd_resposta	  = coalesce(cd_resposta_glosa_p,cd_resposta),
					cd_setor_responsavel = coalesce(cd_setor_responsavel_p,cd_setor_responsavel),
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp()
				where nr_sequencia = nr_seq_item_p;
			end if;
			if (ie_atualiza_glosa_p = 'S') then
				update lote_audit_hist_item
				set 	vl_glosa_informada = coalesce(dividir_sem_round((vl_informado_p * vl_glosa_informada), vl_total_p),0),
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp()
				where nr_sequencia     = nr_seq_item_p;
			end if;
		end if;
	end if;
	commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ratear_valor_itens_lote ( nr_seq_item_p bigint, vl_glosa_p bigint, vl_amenor_p bigint, cd_motivo_glosa_p bigint, vl_informado_p bigint, vl_total_p bigint, ie_atualiza_glosa_p text, ie_acao_glosa_p text, ds_observacao_p text, ie_tipo_valor_p text, ie_tipo_glosa_p text, cd_resposta_glosa_p text, cd_setor_responsavel_p bigint, nm_usuario_p text ) FROM PUBLIC;

