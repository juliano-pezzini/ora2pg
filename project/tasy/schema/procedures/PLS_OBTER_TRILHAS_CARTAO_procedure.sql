-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_trilhas_cartao ( nr_seq_segurado_p bigint, ds_trilha1_p INOUT text, ds_trilha2_p INOUT text, ds_trilha3_p INOUT text, ds_trilha_qr_code_p INOUT text, nm_usuario_p text) AS $body$
DECLARE


nm_segurado_w			varchar(60);
ds_beneficiario_w		varchar(17);
ie_abrangencia_w		varchar(1);
ie_tipo_contratacao_w		varchar(1);
cd_cooperativa_w		pls_congenere.cd_cooperativa%type;
cd_usuario_plano_w		pls_segurado_carteira.cd_usuario_plano%type;
cd_tarja_magnetica_w		pls_plano.cd_tarja_magnetica%type;
dt_validade_carteira_w		pls_segurado_carteira.dt_validade_carteira%type;
nr_via_solicitacao_w		varchar(2);
vl_modulo_w			varchar(2);
nr_produto_w			varchar(3);
nr_seq_plano_w			pls_plano.nr_sequencia%type;
sg_rede_referenciada_w		ptu_rede_referenciada.cd_rede%type;
ie_tipo_segurado_w		pls_segurado.ie_tipo_segurado%type;
cd_estabelecimento_w		pls_segurado.cd_estabelecimento%type;
nr_seq_operadora_estab_w	bigint;
nr_protocolo_ans_w		pls_plano.nr_protocolo_ans%type;
nm_abreviado_w			pessoa_fisica.nm_abreviado%type;
nm_social_w			pessoa_fisica.nm_social%type;
dt_nascimento_w			pessoa_fisica.dt_nascimento%type;
nr_cartao_nac_sus_w		pessoa_fisica.nr_cartao_nac_sus%type;
ie_sexo_w			pessoa_fisica.ie_sexo%type;
ds_sexo_w			varchar(255);
nm_social_abreviado_w		varchar(150);
ds_trilha_qr_w			varchar(4000);
ds_atributo_w 			varchar(4000);
nr_seq_regra_qr_code_w		pls_regra_trilha_carteira.nr_sequencia%type;
cd_rede_refer_ptu_w		pls_plano.cd_rede_refer_ptu%type;
cd_scpa_w			pls_plano.cd_scpa%type;

C01 CURSOR(	 nr_seq_regra_pc		pls_regra_trilha_carteira.nr_sequencia%type) FOR
	SELECT	 ie_tipo_informacao,
		 ds_valor_fixo,
		 ds_mascara
	from	 pls_regra_trilha_cart_info
	where	 nr_seq_regra	= nr_seq_regra_pc
	order by nr_ordem;

BEGIN
select	ie_tipo_segurado,
	cd_estabelecimento
into STRICT	ie_tipo_segurado_w,
	cd_estabelecimento_w
from	pls_segurado
where	nr_sequencia	= nr_seq_segurado_p;


if (ie_tipo_segurado_w = 'R') then
	begin
	select	max(c.cd_cooperativa)
	into STRICT	cd_cooperativa_w
	from	pls_segurado	a,
		pls_segurado_repasse	b,
		pls_congenere	c
	where	b.nr_seq_segurado = a.nr_sequencia
	and	b.nr_seq_congenere_atend = c.nr_sequencia
	and	b.ie_tipo_compartilhamento  = 1
	and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
	and (coalesce(b.dt_fim_repasse::text, '') = '' or b.dt_fim_repasse >= clock_timestamp())
	and	a.nr_sequencia		= nr_seq_segurado_p;
	exception
	when others then
	cd_cooperativa_w := null;
	end;
end if;

if (coalesce(cd_cooperativa_w::text, '') = '') then
	select	substr(pls_obter_operadora_estab(cd_estabelecimento_w),1,10)
	into STRICT	nr_seq_operadora_estab_w
	;
	
	begin
	select	max(a.cd_cooperativa)
	into STRICT	cd_cooperativa_w
	from	pls_congenere	a,
		pls_outorgante	b
	where	b.cd_cgc_outorgante	= a.cd_cgc
	and	b.nr_sequencia	= nr_seq_operadora_estab_w;
	exception
	when others then
		cd_cooperativa_w := null;
	end;
end if;

begin
select	d.nm_pessoa_fisica,
	lpad(CASE WHEN c.ie_abrangencia='N' THEN '1' WHEN c.ie_abrangencia='GE' THEN '2' WHEN c.ie_abrangencia='E' THEN '3' WHEN c.ie_abrangencia='GM' THEN '4' WHEN c.ie_abrangencia='M' THEN '5' END ,1,' '),
	lpad(CASE WHEN c.ie_tipo_contratacao='CA' THEN '4' WHEN c.ie_tipo_contratacao='CE' THEN '3' WHEN c.ie_tipo_contratacao='I' THEN '2' END ,1,' '),
	b.cd_usuario_plano,
	substr(pls_calcula_digito_carteira(b.cd_usuario_plano),1,2),
	lpad(to_char(coalesce(cd_tarja_magnetica,0)),3,'0'),
	b.dt_validade_carteira,
	lpad(to_char(coalesce(b.nr_via_solicitacao,0)),2,'0'), --OS 274241 - aaschlote  11/12/2010
	lpad(to_char(coalesce(c.cd_tarja_magnetica,c.nr_sequencia)),3,'0'),
	c.nr_sequencia,
	c.cd_rede_refer_ptu,
	c.nr_protocolo_ans,
	d.nm_abreviado,
	d.nm_social,
	d.dt_nascimento,
	d.nr_cartao_nac_sus,
	d.ie_sexo,
	obter_valor_dominio(4,d.ie_sexo),
  pls_gerar_nome_abreviado(d.nm_social),
	coalesce(e.cd_scpa, c.cd_scpa) cd_scpa
into STRICT	nm_segurado_w,
	ie_abrangencia_w,
	ie_tipo_contratacao_w,
	cd_usuario_plano_w,
	vl_modulo_w,
	cd_tarja_magnetica_w,
	dt_validade_carteira_w,
	nr_via_solicitacao_w,
	nr_produto_w,
	nr_seq_plano_w,
	cd_rede_refer_ptu_w,	
	nr_protocolo_ans_w,
	nm_abreviado_w,
	nm_social_w,
	dt_nascimento_w,
	nr_cartao_nac_sus_w,
	ie_sexo_w,	
	ds_sexo_w,
	nm_social_abreviado_w,
	cd_scpa_w
FROM pessoa_fisica d, pls_plano c, pls_segurado_carteira b, pls_segurado a
LEFT OUTER JOIN pls_contrato e ON (a.nr_seq_contrato = e.nr_sequencia)
WHERE a.cd_pessoa_fisica	= d.cd_pessoa_fisica and b.nr_seq_segurado	= a.nr_Sequencia and a.nr_seq_plano		= c.nr_sequencia and a.nr_sequencia		= nr_seq_segurado_p;
exception
	when others then
	nm_segurado_w := 'X';
end;

sg_rede_referenciada_w	:= cd_rede_refer_ptu_w;
if (coalesce(sg_rede_referenciada_w::text, '') = '') then
	/*aaschlote 30/11/2011 OS - 384433*/

	begin
	sg_rede_referenciada_w	:= pls_obter_rede_ref_produto(nr_seq_plano_w, cd_estabelecimento_w, 'C');
	exception
	when others then
		sg_rede_referenciada_w	:= '0000';
	end;
end if;

if (coalesce(sg_rede_referenciada_w::text, '') = '') then
	sg_rede_referenciada_w	:= '00';
else
	sg_rede_referenciada_w := substr(sg_rede_referenciada_w,length(sg_rede_referenciada_w)-1,length(sg_rede_referenciada_w));
end if;

if (length(cd_cooperativa_w) <> 4) then
	begin
	select	adiciona_zeros_esquerda(cd_cooperativa_w,4)
	into STRICT	cd_cooperativa_w
	;
	exception
	when others then
		cd_cooperativa_w := null;
	end;
end if;

/*aaschlote  04/05/2011 OS - 316043*/

if (nm_segurado_w IS NOT NULL AND nm_segurado_w::text <> '') then
	nm_segurado_w	:= substr(pls_gerar_nome_abreviado(nm_segurado_w),1,25);
	
	if (length(nm_segurado_w) < 25) then
		nm_segurado_w	:= rpad(nm_segurado_w,25,' ');
	end if;
end if;

if (nm_segurado_w <> 'X') then
	/* Lepinski - OS 223220 / Trilhas de acordo com manual de intercambio, versao 3.7B */

	ds_trilha1_p		:= '%' || nm_segurado_w || '?';
	ds_trilha2_p		:= ';' || cd_usuario_plano_w || '=' || nr_via_solicitacao_w || to_char(dt_validade_carteira_w,'yymm') ||
				   '=' || cd_cooperativa_w || nr_produto_w || ie_abrangencia_w || ie_tipo_contratacao_w ||
				   '1' || sg_rede_referenciada_w || '?';
	ds_trilha3_p		:= '';
end if;

select	max(nr_sequencia)
into STRICT	nr_seq_regra_qr_code_w
from	pls_regra_trilha_carteira
where	cd_estabelecimento = cd_estabelecimento_w
and	clock_timestamp() between coalesce(dt_inicio_vigencia,clock_timestamp()) and coalesce(dt_fim_vigencia,clock_timestamp())
and 	ie_tipo_trilha = 1;

ds_trilha_qr_w	:= null;
for r_c01_w in C01(nr_seq_regra_qr_code_w) loop
	begin
	if (r_c01_w.ie_tipo_informacao = 1) then --Valor fixo
		ds_atributo_w	:= r_c01_w.ds_valor_fixo;
	elsif (r_c01_w.ie_tipo_informacao = 2) then --Cartao de identificacao
		ds_atributo_w	:= cd_usuario_plano_w;
	elsif (r_c01_w.ie_tipo_informacao = 3) then --Beneficiario - Nome
		ds_atributo_w	:= nm_segurado_w;
	elsif (r_c01_w.ie_tipo_informacao = 4) then --Beneficiario - Nome abreviado
		ds_atributo_w	:= nm_abreviado_w;
	elsif (r_c01_w.ie_tipo_informacao = 5) then --Beneficiario - Nome social
		ds_atributo_w	:= nm_social_w;
	elsif (r_c01_w.ie_tipo_informacao = 6) then --Beneficiario - Nome social abreviado
		ds_atributo_w	:= nm_social_abreviado_w;
	elsif (r_c01_w.ie_tipo_informacao = 7) then --Beneficiario - Data de nascimento
		ds_atributo_w	:= to_char(dt_nascimento_w, 'dd/mm/rrrr');
	elsif (r_c01_w.ie_tipo_informacao = 8) then --Beneficiario - CNS (Cartao nacional SUS)
		ds_atributo_w	:= nr_cartao_nac_sus_w;
	elsif (r_c01_w.ie_tipo_informacao = 9) then --Beneficiario - Validade do cartao de identificacao
		ds_atributo_w	:= to_char(dt_validade_carteira_w, 'dd/mm/rrrr');
	elsif (r_c01_w.ie_tipo_informacao = 10)then --Beneficiario - Via do cartao de identificacao
		ds_atributo_w	:= nr_via_solicitacao_w;
	elsif (r_c01_w.ie_tipo_informacao = 11)then --Produto - Protocolo ANS
		ds_atributo_w	:= coalesce(nr_protocolo_ans_w, cd_scpa_w);
	elsif (r_c01_w.ie_tipo_informacao = 12)then --Produto - Rede de atendimento
		ds_atributo_w	:= cd_rede_refer_ptu_w;
	elsif (r_c01_w.ie_tipo_informacao = 13)then --Beneficiario - Sexo (Identificador)
		ds_atributo_w	:= ie_sexo_w;
	elsif (r_c01_w.ie_tipo_informacao = 14)then --Beneficiario - Sexo (Descricao)
		ds_atributo_w	:= ds_sexo_w;
	else
		ds_atributo_w	:= null;
	end if;
	
	if (r_c01_w.ds_mascara IS NOT NULL AND r_c01_w.ds_mascara::text <> '') and (r_c01_w.ie_tipo_informacao in (7,9)) then
		begin
		ds_atributo_w	:= to_char(TO_DATE(ds_atributo_w, 'dd/mm/rrrr'),r_c01_w.ds_mascara);
		exception
		when others then		
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1095803);
		end;
	end if;
	
	ds_trilha_qr_w	:= ds_trilha_qr_w || ds_atributo_w;
	
	end;
end loop;

ds_trilha_qr_code_p	:= ds_trilha_qr_w;


end;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_trilhas_cartao ( nr_seq_segurado_p bigint, ds_trilha1_p INOUT text, ds_trilha2_p INOUT text, ds_trilha3_p INOUT text, ds_trilha_qr_code_p INOUT text, nm_usuario_p text) FROM PUBLIC;

