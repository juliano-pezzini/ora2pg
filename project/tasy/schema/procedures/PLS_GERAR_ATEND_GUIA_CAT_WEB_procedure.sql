-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_atend_guia_cat_web ( nr_seq_guia_p bigint, nr_cat_p bigint, nr_seq_segurado_p bigint, nr_seq_prestador_p bigint, dt_atendimento_p text, nm_usuario_p text, dt_alta_prevista_p text, dt_alta_p text, dt_proximo_atendimento_p text, nr_atendimento_p bigint, ds_unidade_compl_p text, ds_unidade_basica_p text, ds_observacao_p text, ie_tipo_atendimento_p text, ie_clinica_p text, nr_seq_quadro_clinico_p bigint, cd_motivo_alta_p bigint, nr_seq_queixa_p bigint, nr_seq_cat_p bigint) AS $body$
DECLARE


/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:   Gerar o atendimento do CAT
----------------------------------------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [ x ] Tasy (Delphi/Java) [ x ] Portal [  ] Relatórios [ ] Outros:
 ----------------------------------------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/nr_seq_segurado_w		bigint;
cd_guia_w			varchar(20);
nr_seq_prestador_w		bigint;
dt_atendimento_w		timestamp;


BEGIN


if (nr_seq_guia_p IS NOT NULL AND nr_seq_guia_p::text <> '') then
	/* Quando gerada a guia */

	select  nr_seq_segurado,
		cd_guia,
		nr_seq_prestador,
		dt_solicitacao
	into STRICT	nr_seq_segurado_w,
		cd_guia_w,
		nr_seq_prestador_w,
		dt_atendimento_w
	from    pls_guia_plano
	where   nr_sequencia = nr_seq_guia_p;

	insert into pls_prestador_atend_cat(nr_sequencia, dt_atualizacao, nm_usuario,
		cd_guia, nr_seq_prestador, dt_atendimento,
		nm_usuario_nrec, dt_atualizacao_nrec, nr_seq_segurado,
		nr_cat)
	values (	nextval('pls_prestador_atend_cat_seq'),clock_timestamp(), nm_usuario_p,
		cd_guia_w, nr_seq_prestador_w, dt_atendimento_w,
		nm_usuario_p, clock_timestamp(),nr_seq_segurado_w,
		nr_cat_p);

else
	/* Quando gerada no atendimento CAT */

	if (coalesce(nr_seq_cat_p::text, '') = '') then

		insert into pls_prestador_atend_cat(nr_sequencia, nr_seq_segurado, nr_seq_prestador,
			dt_atendimento, dt_atualizacao, nm_usuario,
			nm_usuario_nrec, dt_atualizacao_nrec, dt_alta_prevista,
			dt_alta, dt_proximo_atendimento, nr_atendimento,
			ds_unidade_compl, ds_unidade_basica, ds_observacao,
			ie_tipo_atendimento, ie_clinica, nr_seq_quadro_clinico,
			cd_motivo_alta, nr_seq_queixa, nr_cat)
		values (nextval('pls_prestador_atend_cat_seq'), nr_seq_segurado_p, nr_seq_prestador_p,
			dt_atendimento_p, clock_timestamp(), nm_usuario_p,
			nm_usuario_p, clock_timestamp(), dt_alta_prevista_p,
			dt_alta_p, dt_proximo_atendimento_p, nr_atendimento_p,
			ds_unidade_compl_p, ds_unidade_basica_p, ds_observacao_p,
			ie_tipo_atendimento_p, ie_clinica_p, nr_seq_quadro_clinico_p,
			cd_motivo_alta_p, nr_seq_queixa_p, nr_cat_p);

	else

		update pls_prestador_atend_cat
		 set    nr_seq_segurado = nr_seq_segurado_p,
		        dt_atendimento = to_date(dt_atendimento_p, 'dd/mm/yyyy'),
		        nm_usuario = nm_usuario_p,
		        dt_atualizacao = clock_timestamp(),
		        nr_atendimento = nr_atendimento_p,
		        dt_alta_prevista = to_date(dt_alta_prevista_p, 'dd/mm/yyyy'),
		        dt_alta = to_date(dt_alta_p, 'dd/mm/yyyy'),
		        dt_proximo_atendimento = to_date(dt_proximo_atendimento_p, 'dd/mm/yyyy'),
		        ds_unidade_compl = ds_unidade_compl_p,
		        ds_unidade_basica = ds_unidade_basica_p,
		        ds_observacao = ds_observacao_p,
		        ie_tipo_atendimento = ie_tipo_atendimento_p,
		        ie_clinica = ie_clinica_p,
		        nr_seq_quadro_clinico = nr_seq_quadro_clinico_p,
		        cd_motivo_alta = cd_motivo_alta_p,
		        nr_seq_queixa = nr_seq_queixa_p,
		        nr_cat = nr_cat_p
		 where  nr_sequencia = nr_seq_cat_p;

	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_atend_guia_cat_web ( nr_seq_guia_p bigint, nr_cat_p bigint, nr_seq_segurado_p bigint, nr_seq_prestador_p bigint, dt_atendimento_p text, nm_usuario_p text, dt_alta_prevista_p text, dt_alta_p text, dt_proximo_atendimento_p text, nr_atendimento_p bigint, ds_unidade_compl_p text, ds_unidade_basica_p text, ds_observacao_p text, ie_tipo_atendimento_p text, ie_clinica_p text, nr_seq_quadro_clinico_p bigint, cd_motivo_alta_p bigint, nr_seq_queixa_p bigint, nr_seq_cat_p bigint) FROM PUBLIC;

