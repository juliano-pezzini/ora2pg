-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_d301_segmento_pva ( nr_seq_dataset_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_atendimento_w		atendimento_paciente.nr_atendimento%type;
nr_seq_301_sexo_w		d301_segmento_pva.nr_seq_301_sexo%type;
nr_seq_301_tipo_acomod_w	d301_segmento_pva.nr_seq_301_tipo_acomod%type;
ie_sexo_w			pessoa_fisica.ie_sexo%type;
cd_tipo_acomodacao_w		tipo_acomodacao.cd_tipo_acomodacao%type;
cd_convenio_w			convenio.cd_convenio%type;
ie_acompanhante_w		varchar(1);


BEGIN

select	a.nr_atendimento,
	b.cd_convenio
into STRICT	nr_atendimento_w,
	cd_convenio_w
from	d301_dataset_envio a,
	d301_arquivo_envio b
where	a.nr_sequencia 	= nr_seq_dataset_p
and	a.nr_seq_arquivo	= b.nr_sequencia;

select	max(p.ie_sexo),
	max(b.cd_tipo_acomodacao)
into STRICT	ie_sexo_w,
	cd_tipo_acomodacao_w
from	atendimento_paciente a,
	atend_categoria_convenio b,
	pessoa_fisica p
where	a.cd_pessoa_fisica	= p.cd_pessoa_fisica
and	b.nr_atendimento	= a.nr_atendimento
and	b.nr_seq_interno	= obter_atecaco_atend_conv(a.nr_atendimento,cd_convenio_w)
and	a.nr_atendimento	= nr_atendimento_w;

begin
select	'1'
into STRICT	ie_acompanhante_w
from	atendimento_acompanhante
where	nr_atendimento		= nr_atendimento_w
and	(cd_pessoa_fisica IS NOT NULL AND cd_pessoa_fisica::text <> '')  LIMIT 1;
exception
when others then
	ie_acompanhante_w := '0';
end;

select	obter_seq_valor_301('C301_21_SEXO','IE_SEXO',obter_conversao_301('C301_21_SEXO',null,4,ie_sexo_w,'I')),
	coalesce(obter_seq_valor_301('C301_TIPO_ACOMODACAO','IE_ACOMODACAO',obter_conversao_301('C301_TIPO_ACOMODACAO','TIPO_ACOMODACAO',NULL,cd_tipo_acomodacao_w,'I')),0)
into STRICT	nr_seq_301_sexo_w,
	nr_seq_301_tipo_acomod_w
;

insert into d301_segmento_pva(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_seq_dataset,
	nr_seq_301_sexo,
	ie_medico_eletivo,
	nr_seq_301_tipo_acomod,
	ie_medico_familia,
	ie_acompanhante,
	nr_ik_pagador,
	nm_pagador,
	nr_registro)
values (nextval('d301_segmento_pva_seq'),
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_dataset_p,
	nr_seq_301_sexo_w,
	'0', --ie_medico_eletivo
	nr_seq_301_tipo_acomod_w,
	'0', --ie_medico_familia
	ie_acompanhante_w,
	null, --nr_ik_pagador
	null, --nm_pagador
	null); --nr_registro
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_d301_segmento_pva ( nr_seq_dataset_p bigint, nm_usuario_p text) FROM PUBLIC;

