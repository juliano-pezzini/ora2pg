-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE same_transf_estab_armz (cd_estab_p bigint, nr_seq_caixa_p bigint) AS $body$
DECLARE

 
nr_seq_local_w		bigint;
nr_seq_same_w		bigint;	
nr_seq_agrup_w		bigint;	
ie_altera_estab_pront_w	varchar(1);			
				 
C01 CURSOR FOR 
	SELECT	nr_sequencia, 
		nr_seq_agrup 
	from	same_prontuario 
	where	nr_seq_caixa = nr_seq_caixa_p;

BEGIN
if (cd_estab_p IS NOT NULL AND cd_estab_p::text <> '') and (nr_seq_caixa_p IS NOT NULL AND nr_seq_caixa_p::text <> '') then 
	 
	ie_altera_estab_pront_w := obter_param_usuario(941, 208, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_altera_estab_pront_w);
	 
	select	max(nr_sequencia) 
	into STRICT	nr_seq_local_w 
	from	same_local 
	where	cd_estabelecimento = cd_estab_p 
	and	ie_local_base = 'S';
	 
	if (nr_seq_local_w IS NOT NULL AND nr_seq_local_w::text <> '') then 
	 
		update	same_caixa 
		set	cd_estabelecimento = cd_estab_p, 
			nr_seq_local = nr_seq_local_w 
		where	nr_sequencia = nr_seq_caixa_p;
	 
		 
		open C01;
		loop 
		fetch C01 into	 
			nr_seq_same_w, 
			nr_seq_agrup_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin 
			CALL Gestao_Prontuario_Same(nr_seq_same_w,wheb_usuario_pck.get_nm_usuario,'','',nr_seq_local_w,nr_seq_caixa_p,nr_seq_agrup_w,'',9,'','','',wheb_usuario_pck.get_cd_estabelecimento);
			if (ie_altera_estab_pront_w = 'S') then 
				update	same_prontuario 
				set	cd_estabelecimento = cd_estab_p 
				where	nr_sequencia = nr_seq_same_w;
			end if;	
			end;
		end loop;
		close C01;
		 
	 
	else 
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(213691);
	end if;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE same_transf_estab_armz (cd_estab_p bigint, nr_seq_caixa_p bigint) FROM PUBLIC;

