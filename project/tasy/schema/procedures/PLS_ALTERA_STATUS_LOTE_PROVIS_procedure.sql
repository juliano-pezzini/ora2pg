-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_altera_status_lote_provis ( nr_seq_lote_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, qt_erro_p INOUT bigint ) AS $body$
DECLARE


qt_comissao_w		bigint;
nr_seq_repasse_mens_w	bigint;
ie_concil_contab_w	pls_visible_false.ie_concil_contab%type;

C01 CURSOR FOR
	SELECT	c.nr_sequencia
	from	pls_repasse_mens		c,
		pls_mensalidade_segurado	b,
		pls_mensalidade			a
	where	a.nr_sequencia	= b.nr_seq_mensalidade
	and	b.nr_sequencia	= c.nr_seq_mens_seg
	and	coalesce(c.nr_seq_repasse::text, '') = ''
	and	a.nr_seq_lote	= nr_seq_lote_p;


BEGIN
qt_erro_p := 0;
CALL pls_gravar_historico_lote_mens(nr_seq_lote_p, 4, null, nm_usuario_p, 'N');

select	count(*)
into STRICT	qt_comissao_w
from	pls_repasse_mens		c,
	pls_mensalidade_segurado	b,
	pls_mensalidade			a
where	a.nr_sequencia	= b.nr_seq_mensalidade
and	b.nr_sequencia	= c.nr_seq_mens_seg
and	(c.nr_seq_repasse IS NOT NULL AND c.nr_seq_repasse::text <> '')
and	a.nr_seq_lote	= nr_seq_lote_p;

if (coalesce(qt_comissao_w,0) = 0) then
	open C01; --Deletar as comissoes pendentes
	loop
	fetch C01 into
		nr_seq_repasse_mens_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		delete	from	pls_repasse_mens_item
		where	nr_seq_repasse	= nr_seq_repasse_mens_w;
		
		delete	from	pls_repasse_mens
		where	nr_sequencia	= nr_seq_repasse_mens_w;
		end;
	end loop;
	close C01;
	
	delete	from	pls_mensalidade_liberacao
	where	nr_seq_lote	= nr_seq_lote_p;
	
	update	pls_lote_mensalidade
	set	ie_status	= '3',
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp(),
		ie_visualizar_portal = 'N'
	where	nr_sequencia	= nr_seq_lote_p;
else
	qt_erro_p := 1;
	CALL wheb_mensagem_pck.exibir_mensagem_abort(197653, 'NR_SEQ_LOTE=' || nr_seq_lote_p);
end if;

select	coalesce(max(ie_concil_contab), 'N')
into STRICT	ie_concil_contab_w
from	pls_visible_false;

if (ie_concil_contab_w = 'S') then
	CALL pls_ctb_onl_gravar_movto_pck.gravar_movto_lote_mens_provis(nr_seq_lote_p, cd_estabelecimento_p, nm_usuario_p);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_altera_status_lote_provis ( nr_seq_lote_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, qt_erro_p INOUT bigint ) FROM PUBLIC;

