-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_insert_leite_derivados ( nr_prescricao_p bigint, nr_sequencia_p bigint, cd_unidade_medida_dose_p text, ie_via_aplicacao_p text, cd_intervalo_p text, hr_prim_horario_p text, ds_horarios_p text, ie_se_necessario_p text, nr_ocorrencia_p bigint, ds_observacao_p text, qt_vel_infusao_p text, ie_leite_materno_p text, nr_seq_disp_succao_p text, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, ie_origem_inf_p text, ie_urgencia_p text) AS $body$
DECLARE


i integer;
ds_erro_w					varchar(4000);
ds_erro_ex_w				varchar(2000);	

nr_seq_leite_deriv_w			prescr_leite_deriv.nr_sequencia%type;
ie_via_formula_w				prescr_leite_deriv.ie_via_aplicacao%type;
qt_volume_w						prescr_leite_deriv.qt_volume_total%type;
qt_volume_sonda_w				prescr_leite_deriv.qt_volume_sonda%type;
qt_volume_oral_w				prescr_leite_deriv.qt_volume_oral%type;
	
cd_material_w					prescr_material.cd_material%type;
qt_dose_w						prescr_material.qt_dose%type;
nr_agrupamento_w				prescr_material.nr_agrupamento%type;
nr_seq_material_w				prescr_material.nr_sequencia%type;
qt_unitaria_w					prescr_material.qt_unitaria%type;
qt_material_w					prescr_material.qt_material%type;
qt_conversao_dose_w				prescr_material.qt_conversao_dose%type;
qt_total_dispensar_w			prescr_material.qt_total_dispensar%type;
qt_solucao_w					prescr_material.qt_solucao%type;
ie_regra_disp_w					prescr_material.ie_regra_disp%type;
nr_sequencia_diluicao_w			prescr_material.nr_sequencia_diluicao%type;
ds_observacao_w					prescr_material.ds_observacao%type;
	
ie_administracao_w				cpoe_dieta.ie_administracao%type;
hr_prim_horario_w				cpoe_dieta.hr_prim_horario%type;
ie_se_necessario_w				cpoe_dieta.ie_se_necessario%type;
cd_mat_prod1_w					cpoe_dieta.cd_mat_prod1%type;
ie_via_produto_w				cpoe_dieta.ie_via_leite1%type;
qt_dose_prod1_w					cpoe_dieta.qt_dose_prod1%type;
cd_unid_med_prod1_w				cpoe_dieta.cd_unid_med_prod1%type;
cd_mat_dil_w					cpoe_dieta.cd_mat_dil%type;
qt_dose_dil_w					cpoe_dieta.qt_dose_dil%type;
cd_unid_med_dose_dil_w			cpoe_dieta.cd_unid_med_dose_dil%type;
cd_mat_prod_adic1_w				cpoe_dieta.cd_mat_prod_adic1%type;
cd_mat_prod_adic2_w				cpoe_dieta.cd_mat_prod_adic2%type;
cd_mat_prod_adic3_w				cpoe_dieta.cd_mat_prod_adic3%type;
cd_mat_prod_adic4_w				cpoe_dieta.cd_mat_prod_adic4%type;
cd_unid_med_prod_adic1_w		cpoe_dieta.cd_unid_med_prod_adic1%type;
cd_unid_med_prod_adic2_w		cpoe_dieta.cd_unid_med_prod_adic2%type;
cd_unid_med_prod_adic3_w		cpoe_dieta.cd_unid_med_prod_adic3%type;
cd_unid_med_prod_adic4_w		cpoe_dieta.cd_unid_med_prod_adic4%type;
qt_dose_prod_adic1_w			cpoe_dieta.qt_dose_prod_adic1%type;
qt_dose_prod_adic2_w			cpoe_dieta.qt_dose_prod_adic2%type;
qt_dose_prod_adic3_w			cpoe_dieta.qt_dose_prod_adic3%type;
qt_dose_prod_adic4_w			cpoe_dieta.qt_dose_prod_adic4%type;
qt_porcentagem_adic1_w			cpoe_dieta.qt_porcentagem_adic1%type;
qt_porcentagem_adic2_w			cpoe_dieta.qt_porcentagem_adic2%type;
qt_porcentagem_adic3_w			cpoe_dieta.qt_porcentagem_adic3%type;
qt_porcentagem_adic4_w			cpoe_dieta.qt_porcentagem_adic4%type;
ds_justificativa_w				cpoe_dieta.ds_justificativa%type;
ds_justificativa_dieta_w		cpoe_dieta.ds_justificativa%type;
nr_seq_solubilidade_w			cpoe_dieta.nr_seq_solubilidade%type;
nr_seq_temperatura_w			cpoe_dieta.nr_seq_temperatura%type;
nr_atendimento_w				prescr_medica.nr_atendimento%type;

ie_via_aplic_sonda_w		via_aplicacao.ie_via_aplicacao%type;

cd_unidade_medida_w			unidade_medida.cd_unidade_medida%type;

	procedure gerar_diluicao_leite(	cd_material_p				bigint,
									qt_dose_p					bigint,
									cd_unidade_medida_dose_p	text,
									ie_agrupador_p				bigint,
									nr_seq_diluicao_p			bigint,
									ie_checar_adep_p			char ) is

		ds_erro_ww			varchar(4000);
	
BEGIN
		
		nr_seq_material_w	:= nr_seq_material_w + 1;

		cd_unidade_medida_w	:= substr(obter_dados_material_estab(cd_material_p, cd_estabelecimento_p ,'UMS'),1,30);	
		qt_conversao_dose_w	:= coalesce(obter_conversao_unid_med(cd_material_p, cd_unidade_medida_dose_p),0);
		
		if (qt_conversao_dose_w <= 0) then
			qt_conversao_dose_w	:= 1;
		end if;
		
		qt_unitaria_w	:= dividir(qt_dose_p,qt_conversao_dose_w);
		qt_material_w	:= 0;

		SELECT * FROM obter_quant_dispensar(	cd_estabelecimento_p, cd_material_p, nr_prescricao_p, nr_seq_material_w, cd_intervalo_p, ie_via_produto_w, qt_unitaria_w, 0, nr_ocorrencia_p, null, ie_origem_inf_p, cd_unidade_medida_w, 0, qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_ww, ie_se_necessario_w, 'N' ) INTO STRICT qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_ww;
		
		qt_material_w	:= coalesce(qt_material_w, qt_unitaria_w, 1);
		qt_material_w	:= coalesce(qt_material_w,0);
		qt_unitaria_w	:= coalesce(qt_unitaria_w,0);
		
		insert into prescr_material(
				nr_prescricao,
				nr_sequencia,
				cd_material,
				qt_dose,
				cd_unidade_medida_dose,
				cd_unidade_medida,
				ie_via_aplicacao,
				cd_intervalo,
				ie_se_necessario,
				ie_acm,
				ie_urgencia,
				hr_prim_horario,
				ds_horarios,
				ie_origem_inf,
				ie_regra_disp,
				nr_sequencia_diluicao,
				ds_justificativa,
				nr_dia_util,
				qt_hora_aplicacao,
				qt_min_aplicacao,
				ie_aplic_bolus,
				ie_aplic_lenta,
				qt_solucao,
				nm_usuario,
				dt_atualizacao,
				ds_dose_diferenciada,
				cd_perfil_ativo,
				qt_unitaria,
				qt_material,
				qt_total_dispensar,
				ie_agrupador,
				nr_ocorrencia,
				qt_conversao_dose,
				nr_agrupamento,
				ie_ciente,
				ie_modificado,
				ie_novo_ciclo_ccih,
				ie_utiliza_kit,
				ie_antibiograma,
				ie_cultura_cih,
				ie_recons_diluente_fixo,
				ie_supera_limite_uso,
				ie_sem_aprazamento,
				ie_medicacao_paciente,
				ie_dose_espec_agora,
				ie_intervalo_dif,
				ie_pre_medicacao,
				ie_em_protocolo_vanco,
				ie_horario_susp,
				ie_fator_correcao,
				ie_suspenso,
				ie_cobra_paciente,
				ie_permite_substituir,
				ie_permite_alterar,
				ie_alterar_horario,
				ie_gerar_lote,
				ie_aplicar,
				ie_tipo_medic_hd,
				ie_status_cirurgia,
				nr_seq_mat_cpoe,
				qt_baixa_especial,
				qt_baixa_nconta,
				qt_dia_prim_hor,
				ie_erro,
				ie_checar_adep
		) values (
				nr_prescricao_p,
				nr_seq_material_w,
				cd_material_p,
				qt_dose_p,
				cd_unidade_medida_dose_p,
				cd_unidade_medida_w,
				ie_via_produto_w,
				cd_intervalo_p,
				ie_se_necessario_w,
				'N',
				CASE WHEN coalesce(ie_urgencia_p::text, '') = '' THEN 'N'  ELSE 'S' END ,

				hr_prim_horario_w,
				ds_horarios_p,
				ie_origem_inf_p,
				CASE WHEN coalesce(ie_regra_disp_w,'X')='D' THEN  ie_regra_disp_w  ELSE ie_regra_disp_w END ,
				nr_seq_diluicao_p,
				null, ------
				1,
				null,
				null,
				'N',
				'N',
				Obter_conversao_ml(cd_material_p, qt_dose_p, cd_unidade_medida_dose_p),
				nm_usuario_p,
				clock_timestamp(),
				null,
				cd_perfil_p,
				qt_unitaria_w,
				qt_material_w,
				qt_total_dispensar_w,
				3,
				nr_ocorrencia_p,
				qt_conversao_dose_w,
				CASE WHEN coalesce(nr_seq_diluicao_p::text, '') = '' THEN nr_agrupamento_w  ELSE 0 END ,
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'S',
				'S',
				'S',
				'S',
				'S',
				'S',
				'D',
				'GI',
				nr_sequencia_p,
				0,
				0,
				0,
				0,
				ie_checar_adep_p
		);
	end;

	procedure gerar_produtos_leite_deriv(	cd_mat_prod_p number,
											qt_dose_prod_p number,
											cd_unid_med_prod_p varchar2,
											ie_agrupador_p number,
											qt_porcentagem_adic_p number ,
											nr_seq_solubilidade_p number ,
											nr_seq_temperatura_p  number ) is
	begin		
		nr_seq_material_w	:= nr_seq_material_w + 1;

		cd_unidade_medida_w	:= substr(obter_dados_material_estab( cd_mat_prod_p, cd_estabelecimento_p ,'UMS' ),1,30);
		
		qt_conversao_dose_w := coalesce(obter_conversao_unid_med( cd_mat_prod_p, cd_unid_med_prod_p ),0);

		if (qt_conversao_dose_w <= 0) then
			qt_conversao_dose_w := 1;
		end if;
		
		ie_regra_disp_w			:= 'S';
		qt_unitaria_w			:= dividir( qt_dose_prod_p, qt_conversao_dose_w );
		qt_total_dispensar_w	:= qt_unitaria_w * nr_ocorrencia_p;

		if (upper(cd_unidade_medida_dose_p) = upper(obter_unid_med_usua('ml'))) then
			qt_solucao_w		:= qt_dose_prod_p;
		else
			qt_solucao_w		:= obter_conversao_ml( cd_mat_prod_p, qt_dose_prod_p, cd_unidade_medida_dose_p );
		end if;

		qt_material_w	:= qt_unitaria_w;

		SELECT * FROM obter_quant_dispensar(	cd_estabelecimento_p, cd_mat_prod_p, nr_prescricao_p, nr_seq_material_w, cd_intervalo_p, ie_via_aplicacao_p, qt_unitaria_w, 0, nr_ocorrencia_p, null, ie_origem_inf_p, cd_unid_med_prod_p, 0, qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_p, 'N' ) INTO STRICT qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w;

		ds_observacao_w := '';

		if (ie_agrupador_p = 16) then
			nr_sequencia_diluicao_w := null;

			if (coalesce(cd_mat_dil_w, 0) <> 0) then
				begin
				ds_observacao_w := 	
								-- Diluir
								substr(obter_desc_expressao(346577) || ' ' || qt_dose_prod1_w || ' ' || cd_unid_med_prod1_w ||
								-- de
								' ' || obter_desc_expressao(310214) || ' ' || obter_desc_material(cd_mat_prod1_w) || 
								-- em
								' ' || obter_desc_expressao(341615) || ' ' || qt_dose_dil_w || ' ' || cd_unid_med_dose_dil_w ||
								-- de
								' ' || obter_desc_expressao(310214) || ' ' || obter_desc_material(cd_mat_dil_w),1,255);
				end;
			end if;
		end if;
		
		
		ds_justificativa_w 	:= '';
		ds_observacao_w		:= '';
		
		if (ie_agrupador_p = 16) then
			ds_justificativa_w := ds_justificativa_dieta_w;
			ds_observacao_w := ds_observacao_p;
		end if;
		
		insert into prescr_material(
					nr_prescricao,
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					cd_perfil_ativo,
					ie_origem_inf,
					cd_material,
					qt_dose,
					cd_unidade_medida_dose,
					cd_intervalo,
					hr_prim_horario,
					ds_horarios,
					cd_unidade_medida,
					ie_agrupador,
					ie_via_leite,
					ie_via_aplicacao,
					nr_agrupamento,
					qt_conversao_dose,
					nr_ocorrencia,
					nr_dia_util,
					ie_se_necessario,
					ie_acm,
					ie_urgencia,
					nr_seq_leite_deriv,
					qt_material,
					qt_unitaria,
					qt_total_dispensar,
					nr_sequencia_diluicao,
					nr_seq_dieta_cpoe,
					ds_observacao,
					qt_porcentagem,
					ds_justificativa,
					nr_seq_solubilidade,
					nr_seq_temperatura
			) values (
					nr_prescricao_p,
					nr_seq_material_w,
					clock_timestamp(),
					nm_usuario_p,
					cd_perfil_p,
					ie_origem_inf_p,
					cd_mat_prod_p,
					qt_dose_prod_p,
					cd_unid_med_prod_p,
					cd_intervalo_p,
					hr_prim_horario_p,
					ds_horarios_p,
					cd_unidade_medida_w,
					ie_agrupador_p,
					ie_via_formula_w,
					ie_via_produto_w,
					nr_agrupamento_w,
					qt_conversao_dose_w,
					nr_ocorrencia_p,
					1,
					ie_se_necessario_p,
					'N',
					CASE WHEN coalesce(ie_urgencia_p::text, '') = '' THEN 'N'  ELSE 'S' END ,
					nr_seq_leite_deriv_w,
					coalesce(qt_material_w,0),
					qt_unitaria_w,
					qt_total_dispensar_w,
					nr_sequencia_diluicao_w,
					nr_sequencia_p,
					ds_observacao_w,
					qt_porcentagem_adic_p,
					ds_justificativa_w,
					nr_seq_solubilidade_w,
					nr_seq_temperatura_w);

		if (ie_agrupador_p = 16) then		
			nr_sequencia_diluicao_w := nr_seq_material_w;
			if (coalesce(cd_mat_dil_w, 0) <> 0) then
				gerar_diluicao_leite( cd_mat_dil_w, qt_dose_dil_w, cd_unid_med_dose_dil_w, 3, nr_sequencia_diluicao_w, 'S');
			end if;
		end if;
		
		commit;
	end;

begin

select 	nextval('prescr_leite_deriv_seq')
into STRICT	nr_seq_leite_deriv_w
;

select	max(cd_mat_prod1),
		max(ie_via_leite1),
		max(qt_dose_prod1),
		max(cd_unid_med_prod1),
		max(qt_volume),
		max(ie_administracao),
		max(cd_mat_dil),
		max(qt_dose_dil),
		max(cd_unid_med_dose_dil),
		max(cd_mat_prod_adic1),
		max(cd_mat_prod_adic2),
		max(cd_mat_prod_adic3),
		max(cd_mat_prod_adic4),
		max(cd_unid_med_prod_adic1),
		max(cd_unid_med_prod_adic2),
		max(cd_unid_med_prod_adic3),
		max(cd_unid_med_prod_adic4),
		max(qt_dose_prod_adic1),
		max(qt_dose_prod_adic2),
		max(qt_dose_prod_adic3),
		max(qt_dose_prod_adic4),
		max(qt_porcentagem_adic1),
		max(qt_porcentagem_adic2),
		max(qt_porcentagem_adic3),
		max(qt_porcentagem_adic4),
		max(ds_justificativa),
		max(nr_seq_solubilidade),
		max(nr_seq_temperatura)
into STRICT	cd_mat_prod1_w,
		ie_via_produto_w,
		qt_dose_prod1_w	,
		cd_unid_med_prod1_w,
		qt_volume_w,
		ie_administracao_w,
		cd_mat_dil_w,
		qt_dose_dil_w,
		cd_unid_med_dose_dil_w,
		cd_mat_prod_adic1_w,
		cd_mat_prod_adic2_w,
		cd_mat_prod_adic3_w,
		cd_mat_prod_adic4_w,
		cd_unid_med_prod_adic1_w,
		cd_unid_med_prod_adic2_w,
		cd_unid_med_prod_adic3_w,
		cd_unid_med_prod_adic4_w,
		qt_dose_prod_adic1_w,
		qt_dose_prod_adic2_w,
		qt_dose_prod_adic3_w,
		qt_dose_prod_adic4_w,
		qt_porcentagem_adic1_w,
		qt_porcentagem_adic2_w,
		qt_porcentagem_adic3_w,
		qt_porcentagem_adic4_w,
		ds_justificativa_dieta_w,
		nr_seq_solubilidade_w,
		nr_seq_temperatura_w
from	cpoe_dieta
where	nr_sequencia = nr_sequencia_p;

ie_via_formula_w	:= 'O';

if (ie_via_produto_w IS NOT NULL AND ie_via_produto_w::text <> '') then	
	if (obter_se_via_sonda(ie_via_produto_w) = 'S') then
		ie_via_formula_w	:= 'S';
		qt_volume_sonda_w	:= qt_dose_prod1_w;
	else
		ie_via_formula_w	:= 'O';
		qt_volume_oral_w	:= qt_dose_prod1_w;	
	end if;
end if;

if (ie_administracao_w = 'N') then
	hr_prim_horario_w	:= null;
	ie_se_necessario_w	:= 'S';
else
	hr_prim_horario_w 	:= hr_prim_horario_p;
	ie_se_necessario_w	:= ie_se_necessario_p;
end if;

insert into prescr_leite_deriv(
			nr_prescricao,
			nr_sequencia,
			nm_usuario,
			dt_atualizacao,
			hr_prim_horario,
			ds_horarios,
			cd_intervalo,
			ie_via_aplicacao,
			ie_se_necessario,
			nr_seq_disp_succao,
			qt_vel_infusao,
			ie_leite_materno,
			nr_seq_dieta_cpoe,
			qt_volume_total,
			qt_volume_sonda,
			qt_volume_oral				
		) values (
			nr_prescricao_p,
			nr_seq_leite_deriv_w,
			nm_usuario_p,
			clock_timestamp(),
			hr_prim_horario_w,
			ds_horarios_p,
			cd_intervalo_p,
			ie_via_formula_w,
			ie_se_necessario_w,
			nr_seq_disp_succao_p,
			qt_vel_infusao_p,
			ie_leite_materno_p,
			nr_sequencia_p,
			qt_volume_w,
			qt_volume_sonda_w, 
			qt_volume_oral_w
		);
commit;

select	coalesce(max(nr_sequencia),0)
into STRICT	nr_seq_material_w
from	prescr_material
where	nr_prescricao = nr_prescricao_p;

select 	coalesce(max(nr_agrupamento),0) + 1
into STRICT	nr_agrupamento_w
from	prescr_material
where	nr_prescricao = nr_prescricao_p;

if (cd_mat_prod1_w IS NOT NULL AND cd_mat_prod1_w::text <> '')then
	gerar_produtos_leite_deriv( cd_mat_prod1_w, qt_dose_prod1_w, cd_unid_med_prod1_w, 16, null, nr_seq_solubilidade_w, nr_seq_temperatura_w);
	
	if (cd_mat_prod_adic1_w IS NOT NULL AND cd_mat_prod_adic1_w::text <> '') then
		gerar_produtos_leite_deriv(cd_mat_prod_adic1_w, qt_dose_prod_adic1_w, cd_unid_med_prod_adic1_w, 17, qt_porcentagem_adic1_w);
	end if;
	
	if (cd_mat_prod_adic2_w IS NOT NULL AND cd_mat_prod_adic2_w::text <> '') then
		gerar_produtos_leite_deriv(cd_mat_prod_adic2_w, qt_dose_prod_adic2_w, cd_unid_med_prod_adic2_w, 17, qt_porcentagem_adic2_w);
	end if;
	
	if (cd_mat_prod_adic3_w IS NOT NULL AND cd_mat_prod_adic3_w::text <> '') then
		gerar_produtos_leite_deriv(cd_mat_prod_adic3_w, qt_dose_prod_adic3_w, cd_unid_med_prod_adic3_w, 17, qt_porcentagem_adic3_w);
	end if;
	
	if (cd_mat_prod_adic4_w IS NOT NULL AND cd_mat_prod_adic4_w::text <> '') then
		gerar_produtos_leite_deriv(cd_mat_prod_adic4_w, qt_dose_prod_adic4_w, cd_unid_med_prod_adic4_w, 17, qt_porcentagem_adic4_w);
	end if;	
end if;

commit;

exception when others then
	if (coalesce(nr_prescricao_p,0) > 0) then
		select max(nr_atendimento)
		into STRICT nr_atendimento_w
		from prescr_medica
		where nr_prescricao = nr_prescricao_p;
	end if;

	CALL gravar_log_cpoe(substr('CPOE_INSERT_DIETA_SUPLEM EXCEPTION:'|| substr(to_char(sqlerrm),1,2000)
		||'nr_sequencia_p: '||nr_sequencia_p||' nr_prescricao_p :'||nr_prescricao_p
		||'cd_unidade_medida_dose_p:'||cd_unidade_medida_dose_p||'ie_via_aplicacao_p:'||ie_via_aplicacao_p||'cd_intervalo_p:'||cd_intervalo_p
		||'hr_prim_horario_p:'|| hr_prim_horario_p||'ds_horarios_p : '||ds_horarios_p||'ie_se_necessario_p:'||ie_se_necessario_p
		||'nr_ocorrencia_p:'||nr_ocorrencia_p||'ds_observacao_p:'||ds_observacao_p||'qt_vel_infusao_p:'||qt_vel_infusao_p
		||'ie_leite_materno_p:'||ie_leite_materno_p||'nr_seq_disp_succao_p:'||nr_seq_disp_succao_p
		||'cd_estabelecimento_p:'||cd_estabelecimento_p||'cd_perfil_p :'|| cd_perfil_p||'nm_usuario_p:'|| nm_usuario_p||'ie_origem_inf_p:'||ie_origem_inf_p,1,2000),
		nr_atendimento_w, 'N', nr_sequencia_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_insert_leite_derivados ( nr_prescricao_p bigint, nr_sequencia_p bigint, cd_unidade_medida_dose_p text, ie_via_aplicacao_p text, cd_intervalo_p text, hr_prim_horario_p text, ds_horarios_p text, ie_se_necessario_p text, nr_ocorrencia_p bigint, ds_observacao_p text, qt_vel_infusao_p text, ie_leite_materno_p text, nr_seq_disp_succao_p text, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, ie_origem_inf_p text, ie_urgencia_p text) FROM PUBLIC;

