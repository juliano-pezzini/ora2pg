-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_procedimento ( NR_ATENDIMENTO_P bigint, CD_PROCEDIMENTO_P bigint, IE_ORIGEM_PROCED_P bigint, QT_PROCEDIMENTO_P bigint, CD_CONVENIO_P bigint, IE_TIPO_SERVICO_P bigint, IE_TIPO_ATO_P bigint, NR_NF_PRESTADOR_P bigint, CD_MEDICO_EXECUTOR_P text, NR_INTERNO_CONTA_P bigint, DS_ERRO_P INOUT text) AS $body$
DECLARE


DS_ERRO_W         			varchar(255) 		:= '';
ds_proc_requerido_w			varchar(255)		:= '';
ie_obrigatorio_w			varchar(1);
cd_procedimento_w			bigint		:= null;
ie_tipo_serv_partic_w		smallint		:= null;
ie_tipo_ato_partic_w			smallint		:= null;
ds_tipo_laudo_sus_w			varchar(20) 		:= '';
sql_select         	 		varchar(500) 	:= '';
retorno_w				bigint		:= 0;
Guampa					varchar(1)		:= chr(39);
cd_convenio_w				integer		:= 0;
qt_proced_com_preco_w		bigint		:= 0;
qt_proced_sem_ato_w			bigint		:= 0;
qt_proced_sem_serv_w			bigint		:= 0;
qt_proced_sem_medico_w		bigint		:= 0;
qt_proced_com_medico_w		bigint		:= 0;
qt_proced_sem_nf_w			bigint		:= 0;
ie_laudo_obrigatorio_w		varchar(1);
ie_situacao_w				varchar(1);
ie_intercorrencia_w			varchar(1)		:= 'N';
qt_ocor_w				smallint		:= 0;
ds_valor_item_w			varchar(20);
cd_estabelecimento_w			smallint;
ie_exclui_medico_w 			varchar(1) := '';


BEGIN
ds_erro_w				:= '';
cd_procedimento_w			:= cd_procedimento_p;
ie_tipo_serv_partic_w		:= ie_tipo_servico_p;
ie_tipo_ato_partic_w			:= ie_tipo_ato_p;

select	coalesce(max(cd_estabelecimento),1)
into STRICT	cd_estabelecimento_w
from	atendimento_paciente
where	nr_atendimento	= nr_atendimento_p;

select coalesce(ie_situacao, 'A')
into STRICT ie_situacao_w
from procedimento
where cd_procedimento	= cd_procedimento_p
  and ie_origem_proced	= ie_origem_proced_p;

/* proc 99080011 diaria especial de acomp. gerada pelo tasy c/situacao inativa */

/* Este procedimento é gerado somente fechar valores totais do sus c/tasy */

if (ie_situacao_w = 'I') 		and (cd_procedimento_p <> 99080011)	then
	ds_erro_w	:= ds_erro_w || '506 ';
end if;
/* CONSISTENCIA DO PROCEDIMENTO REQUERIDO */

ie_obrigatorio_w := 'N';
SELECT * FROM Define_Proc_Requerido(nr_atendimento_p, cd_convenio_p, cd_procedimento_p, ie_origem_proced_p, ds_proc_requerido_w, ie_obrigatorio_w) INTO STRICT ds_proc_requerido_w, ie_obrigatorio_w;
if (ds_proc_requerido_w = wheb_mensagem_pck.get_texto(306670, null)) then
	ds_erro_w	:= ds_erro_w || '734 ';
end if;
/* CONSISTENCIA PROCEDIMENTO SUS INTERNADOS */

if (ie_origem_proced_p = 2) then
	BEGIN
	/* CONSISTENCIA DO PROC X TIPO SERV. X TIPO ATO */

	if (substr(cd_procedimento_w,1,2) = '17') and (ie_tipo_serv_partic_w not in (3,8)) then
		begin
		if	cd_procedimento_w not in (17007038,17022037) then
			ds_erro_w	:= ds_erro_w ||'731'||'('||to_char(cd_procedimento_w)||') ';
		end if;
		end;
	end if;
	if (substr(cd_procedimento_w,1,2) = '17') and (ie_tipo_ato_partic_w <> 15) then
		ds_erro_w	:= ds_erro_w ||'732'||'('||to_char(cd_procedimento_w)||') ';
	end if;

	if (substr(cd_procedimento_w,1,2) = '21') then
		begin
		if	ie_tipo_serv_partic_w not in (3,8,45) then
			ds_erro_w	:= ds_erro_w ||'731'||'('||to_char(cd_procedimento_w)||') ';
		end if;
		if	ie_tipo_serv_partic_w = 45 	and
			coalesce(cd_medico_executor_p::text, '') = ''	then
			ds_erro_w	:= ds_erro_w ||'730'||'('||to_char(cd_procedimento_w)||') ';
		end if;
		end;
	end if;

/*	if	(cd_procedimento_w in (63001209, 63001594)) and Felipe - OS 53092 - Alterado pois para tipo de serviço 45 sempre deve exportar o CPF */

	if (ie_tipo_serv_partic_w	= 45) and (coalesce(cd_medico_executor_p::text, '') = '') then
			ds_erro_w	:= ds_erro_w ||'730'||'('||to_char(cd_procedimento_w)||') ';
	end if;

	if (substr(cd_procedimento_w,1,2) = '21') and (ie_tipo_ato_partic_w <> 16) and (cd_procedimento_w <> 21006130) and (cd_procedimento_w <> 21001138) and (cd_procedimento_w <> 21002134) and (cd_procedimento_w <> 21014132) and (cd_procedimento_w <> 21005133) and (cd_procedimento_w <> 21010137) and (cd_procedimento_w <> 21009139) and (cd_procedimento_w <> 21008132) and (cd_procedimento_w <> 21001120) and (cd_procedimento_w <> 21003130) and (cd_procedimento_w <> 21004137) and (cd_procedimento_w <> 21005109) and (cd_procedimento_w <> 21007136) and (cd_procedimento_w <> 21009058) and (cd_procedimento_w <> 21013136) and (cd_procedimento_w <> 21015139) and (cd_procedimento_w <> 21016135) and (cd_procedimento_w <> 21017131) then
		ds_erro_w	:= ds_erro_w ||'732'||'('||to_char(cd_procedimento_w)||') ';
	end if;

	if	((cd_procedimento_w = 21006130) or (cd_procedimento_w = 21001138) or (cd_procedimento_w = 21002134) or (cd_procedimento_w = 21014132) or (cd_procedimento_w = 21005133) or (cd_procedimento_w = 21010137) or (cd_procedimento_w = 21009139) or (cd_procedimento_w = 21008132) or (cd_procedimento_w = 21001120) or (cd_procedimento_w = 21003130) or (cd_procedimento_w = 21004137) or (cd_procedimento_w = 21005109) or (cd_procedimento_w = 21007136) or (cd_procedimento_w = 21009058) or (cd_procedimento_w = 21013136) or (cd_procedimento_w = 21015139) or (cd_procedimento_w = 21016135) or (cd_procedimento_w = 21017131)) and (ie_tipo_ato_partic_w <> 57) then
		ds_erro_w	:= ds_erro_w ||'732'||'('||to_char(cd_procedimento_w)||') ';
	end if;

	if (substr(cd_procedimento_w,1,2) = '23') and (ie_tipo_serv_partic_w not in (3,8)) then
		ds_erro_w	:= ds_erro_w ||'731'||'('||to_char(cd_procedimento_w)||') ';
	end if;
	if (substr(cd_procedimento_w,1,2) = '23') and (ie_tipo_ato_partic_w not in (13,11)) then
		ds_erro_w	:= ds_erro_w ||'732'||'('||to_char(cd_procedimento_w)||') ';
	end if;
	if (substr(cd_procedimento_w,1,2) = '25') and (ie_tipo_serv_partic_w not in (7,4,45)) then
		ds_erro_w	:= ds_erro_w ||'731'||'('||to_char(cd_procedimento_w)||') ';
	end if;
	if (substr(cd_procedimento_w,1,2) = '25') and (ie_tipo_ato_partic_w <> 7) then
		ds_erro_w	:= ds_erro_w ||'732'||'('||to_char(cd_procedimento_w)||') ';
	end if;
	if (substr(cd_procedimento_w,1,2) = '10') and (ie_tipo_serv_partic_w not in (3,8)) then
		ds_erro_w	:= ds_erro_w ||'731'||'('||to_char(cd_procedimento_w)||') ';
	end if;
	if (substr(cd_procedimento_w,1,2) = '10') and (ie_tipo_ato_partic_w <> 11) then
		ds_erro_w	:= ds_erro_w ||'732'||'('||to_char(cd_procedimento_w)||') ';
	end if;
	if (substr(cd_procedimento_w,1,2) = '94') and (ie_tipo_serv_partic_w not in (2,8)) then
		ds_erro_w	:= ds_erro_w ||'731'||'('||to_char(cd_procedimento_w)||') ';
	end if;
	if (substr(cd_procedimento_w,1,2) = '94') and (ie_tipo_ato_partic_w <> 12) then
		ds_erro_w	:= ds_erro_w ||'732'||'('||to_char(cd_procedimento_w)||') ';
	end if;
	if (substr(cd_procedimento_w,1,2) = '93') and (ie_tipo_serv_partic_w not in (1,53,55)) then
		ds_erro_w	:= ds_erro_w ||'731'||'('||to_char(cd_procedimento_w)||') ';
	end if;
	if (substr(cd_procedimento_w,1,2) = '93') and (ie_tipo_ato_partic_w <> 19) then
		ds_erro_w	:= ds_erro_w ||'732'||'('||to_char(cd_procedimento_w)||') ';
	end if;
	if (substr(cd_procedimento_w,1,2) = '04') and (ie_tipo_serv_partic_w not in (7,3)) then
		ds_erro_w	:= ds_erro_w ||'731'||'('||to_char(cd_procedimento_w)||') ';
	end if;
	if (substr(cd_procedimento_w,1,2) = '04') and (ie_tipo_ato_partic_w <> 18) then
		ds_erro_w	:= ds_erro_w ||'732'||'('||to_char(cd_procedimento_w)||') ';
	end if;
	/* Excluir procedimento 97220000 da consistencia OS7007 */

	/* Ricardo 15/09/2004 - Incluí os procedimentos (98500015 e 98300016) abaixo para que não entrem na consistência

abaixo */
	qt_ocor_w	:= 0;
	if (cd_procedimento_w	<> 97220000) 			and (cd_procedimento_w	<> 97023000) 			and (cd_procedimento_w	<> 98500015) 			and (cd_procedimento_w	<> 98300016) 			and (substr(cd_procedimento_w,1,2) in ('97','98','92','99')) 	and (ie_tipo_serv_partic_w IS NOT NULL AND ie_tipo_serv_partic_w::text <> '') 			then
		select	count(*)
		into STRICT	qt_ocor_w
		from	sus_proced_tipo_ato
		where 	cd_procedimento		= cd_procedimento_w
		and 	ie_origem_proced	= ie_origem_proced_p
		and	cd_estabelecimento	= cd_estabelecimento_w
		and 	ie_tipo_servico_sus	= ie_tipo_serv_partic_w;
		if (qt_ocor_w = 0) then
			ds_erro_w	:= ds_erro_w ||'731'||'('||to_char(cd_procedimento_w)||') ';
		end if;
	end if;


	/* Adelson 20/12/2004 - Incluí os procedimentos (29003016) Cardiotocografia HSA-Elias */

	if (cd_procedimento_w	= 29003016)	and (ie_tipo_serv_partic_w  not in (3,8)) then
		ds_erro_w	:= ds_erro_w ||'731'||'('||to_char(cd_procedimento_w)||') ';
	end if;

	/* Adelson 20/12/2004 - Incluí os procedimentos (29003016) Cardiotocografia HSA-Elias */

	if (cd_procedimento_w	= 29003016)	and (ie_tipo_ato_partic_w  not in (18)) then
		ds_erro_w	:= ds_erro_w ||'732'||'('||to_char(cd_procedimento_w)||') ';
	end if;


	/* Ricardo 15/09/2004 - Incluí os procedimentos (98500015 e 98300016) na consistência abaixo para consistir

somente no tipo 26 */
	if 	((cd_procedimento_w	= 98500015) 			or (cd_procedimento_w	= 98300016))			and (ie_tipo_serv_partic_w  <> 26) then
		ds_erro_w	:= ds_erro_w ||'731'||'('||to_char(cd_procedimento_w)||') ';
	end if;

	/* Ricardo 15/09/2004 - Incluí os procedimentos (98500015 e 98300016) abaixo para que não entrem na consistência

abaixo */
	qt_ocor_w	:= 0;
	if (cd_procedimento_w	<> 97220000) 			and (cd_procedimento_w	<> 98500015) 			and (cd_procedimento_w	<> 98300016) 			and (substr(cd_procedimento_w,1,2) in ('97','98','92','99')) 	and (ie_tipo_ato_partic_w IS NOT NULL AND ie_tipo_ato_partic_w::text <> '') 			then
		select	count(*)
		into STRICT	qt_ocor_w
		from 	sus_proced_tipo_ato
		where 	cd_procedimento		= cd_procedimento_w
		and 	ie_origem_proced	= ie_origem_proced_p
		and	cd_estabelecimento	= cd_estabelecimento_w
	 	and 	ie_tipo_ato_sus		= ie_tipo_ato_partic_w;
		if (qt_ocor_w = 0) then
			ds_erro_w	:= ds_erro_w ||'732'||'('||to_char(cd_procedimento_w)||') ';
		end if;
	end if;

	/* Ricardo 15/09/2004 - Incluí os procedimentos (98500015 e 98300016) na consistência abaixo para consistir

somente no tipo 38 */
	if 	((cd_procedimento_w	= 98500015) 			or (cd_procedimento_w	= 98300016))			and (ie_tipo_ato_partic_w  <>38) then
		ds_erro_w	:= ds_erro_w ||'732'||'('||to_char(cd_procedimento_w)||') ';
	end if;

	/* Consistencia de procedimentos que não podem ser executados */

	ds_valor_item_w	:= 'S';
	select 	coalesce(max(ds_valor_item),'S')
	into STRICT	ds_valor_item_w
	from 	procedimento_consiste_sus
	where 	cd_procedimento = cd_procedimento_w
	and 	ie_tipo_item = 4
	and 	ie_origem_proced = 2;
	if (ds_valor_item_w	= 'N') then
		ds_erro_w	:= ds_erro_w ||'2175'||'('||to_char(cd_procedimento_w)||') ';
	end if;

	/* Consistencia de procedimentos com quantidade maior de 999 OS6794 */

	if (qt_procedimento_p > 999)	then
		ds_erro_w	:= ds_erro_w ||'2112'||'('||to_char(cd_procedimento_p)||') ';
	end if;

	/* Consistencia de procedimentos que não podem ter quantidade maior que 1 */

	if	((cd_procedimento_w > 31000000 AND cd_procedimento_w < 44999999) or
		 ((cd_procedimento_w > 69000000) and (cd_procedimento_w < 91999999) and (cd_procedimento_w not in (85300780, 85500801))) or (cd_procedimento_w = 48010094)) and (substr(cd_procedimento_w,1,5) <> '76400') and (qt_procedimento_p <> 1) then
		ds_erro_w	:= ds_erro_w ||'735'||'('||to_char(cd_procedimento_w)||') ';
	end if;
	if (Substr(cd_procedimento_w,1,5) = '76400') and (coalesce(ie_tipo_servico_p,0) not in (7,4)) and (qt_procedimento_p <> 1) then
		ds_erro_w	:= ds_erro_w ||'735'||'('||to_char(cd_procedimento_w)||') ';
	end if;
	/* fim */

	if (substr(cd_procedimento_w,1,2) = '99') and (qt_ocor_w = 0)then
		begin
		/* OS 13237 Elias-HSA para 99042010 serv37 e ato47 */

		if (cd_procedimento_w = 99085011) 	and (ie_tipo_ato_partic_w <> 46) 	then
			ds_erro_w	:= ds_erro_w ||'732'||'('||to_char(cd_procedimento_w)||') ';
		end if;
		if (cd_procedimento_w = 99080010) 	and (ie_tipo_ato_partic_w <> 34) 	then
			ds_erro_w	:= ds_erro_w ||'732'||'('||to_char(cd_procedimento_w)||') ';
		end if;
		if (cd_procedimento_w = 99884011) 	and (ie_tipo_ato_partic_w <> 32) 	then
			ds_erro_w	:= ds_erro_w ||'732'||'('||to_char(cd_procedimento_w)||') ';
		end if;
		if (cd_procedimento_w = 99801019) 	and (ie_tipo_ato_partic_w <> 32) 	then
			ds_erro_w	:= ds_erro_w ||'732'||'('||to_char(cd_procedimento_w)||') ';
		end if;
		if (cd_procedimento_w = 99086018) 	and (ie_tipo_ato_partic_w <> 49) 	then
			ds_erro_w	:= ds_erro_w ||'732'||'('||to_char(cd_procedimento_w)||') ';
		end if;
		if (cd_procedimento_w = 99042010) 	and (ie_tipo_ato_partic_w <> 47) 	then
			ds_erro_w	:= ds_erro_w ||'732'||'('||to_char(cd_procedimento_w)||') ';
		end if;
		if (cd_procedimento_w = 99085011) 	and (ie_tipo_serv_partic_w <> 36) 	then
			ds_erro_w	:= ds_erro_w ||'731'||'('||to_char(cd_procedimento_w)||') ';
		end if;
		if (cd_procedimento_w = 99080010) 	and (ie_tipo_serv_partic_w <> 20) 	then
			ds_erro_w	:= ds_erro_w ||'731'||'('||to_char(cd_procedimento_w)||') ';
		end if;
		if (cd_procedimento_w = 99884011) 	and (ie_tipo_serv_partic_w <> 13) 	then
			ds_erro_w	:= ds_erro_w ||'731'||'('||to_char(cd_procedimento_w)||') ';
		end if;
		if (cd_procedimento_w = 99801019) 	and (ie_tipo_serv_partic_w <> 13) 	then
			ds_erro_w	:= ds_erro_w ||'731'||'('||to_char(cd_procedimento_w)||') ';
		end if;
		if (cd_procedimento_w = 99086018) 	and (ie_tipo_serv_partic_w not in (39,40)) 	then
			ds_erro_w	:= ds_erro_w ||'731'||'('||to_char(cd_procedimento_w)||') ';
		end if;
		if (cd_procedimento_w = 99042010) 	and (ie_tipo_serv_partic_w <> 37) 	then
			ds_erro_w	:= ds_erro_w ||'731'||'('||to_char(cd_procedimento_w)||') ';
		end if;
		if (cd_procedimento_w not in (99080010,99801019,99086018,
							99884011,99085011,99042010))	and (ie_tipo_serv_partic_w IS NOT NULL AND ie_tipo_serv_partic_w::text <> '') then
			ds_erro_w	:= ds_erro_w ||'731'||'('||to_char(cd_procedimento_w)||') ';
		end if;
		if (cd_procedimento_w not in (99080010,99801019,99086018,
							99884011,99085011,99042010))	and (ie_tipo_ato_partic_w IS NOT NULL AND ie_tipo_ato_partic_w::text <> '') then
			ds_erro_w	:= ds_erro_w ||'732'||'('||to_char(cd_procedimento_w)||') ';
		end if;
		if (cd_procedimento_w in (95003010,95005013,95006010)) 	and (ie_tipo_ato_partic_w <> 35) 	then
			ds_erro_w	:= ds_erro_w ||'732'||'('||to_char(cd_procedimento_w)||') ';
		end if;
		if (cd_procedimento_w in (95003010,95005013,95006010)) 	and (ie_tipo_serv_partic_w not in (21,22)) 	then
			ds_erro_w	:= ds_erro_w ||'731'||'('||to_char(cd_procedimento_w)||') ';
		end if;
		end;
	end if;

/* Substituido por Marcus em 26/10/2005 OS24994 do HSA pela rotina abaixo
	if	(substr(cd_procedimento_w,1,2) = '96') and
		(ie_tipo_serv_partic_w <> 18) then
		ds_erro_w	:= ds_erro_w ||'731'||'('||to_char(cd_procedimento_w)||') ';
	end if;
	if	(substr(cd_procedimento_w,1,2) = '96') and
		(ie_tipo_ato_partic_w <> 21) then
		ds_erro_w	:= ds_erro_w ||'732'||'('||to_char(cd_procedimento_w)||') ';
	end if;
*/
	if (cd_procedimento_w in (96007010, 96007036, 96007028)) then
		if (ie_tipo_serv_partic_w <> 20) then
			ds_erro_w	:= ds_erro_w ||'731'||'('||to_char(cd_procedimento_w)||') ';
		end if;
		if (ie_tipo_ato_partic_w <> 34) then
			ds_erro_w	:= ds_erro_w ||'732'||'('||to_char(cd_procedimento_w)||') ';
		end if;
	elsif (substr(cd_procedimento_w,1,2) = '96') then
		if (ie_tipo_serv_partic_w <> 18) then
			ds_erro_w	:= ds_erro_w ||'731'||'('||to_char(cd_procedimento_w)||') ';
		end if;
		if (ie_tipo_ato_partic_w <> 21) then
			ds_erro_w	:= ds_erro_w ||'732'||'('||to_char(cd_procedimento_w)||') ';
		end if;
	end if;


	if (substr(cd_procedimento_w,1,2) = '16') and (ie_tipo_serv_partic_w not in (3,8)) then
		ds_erro_w	:= ds_erro_w ||'731'||'('||to_char(cd_procedimento_w)||') ';
	end if;
	if (substr(cd_procedimento_w,1,2) = '16') and (ie_tipo_ato_partic_w <> 8) then
		ds_erro_w	:= ds_erro_w ||'732'||'('||to_char(cd_procedimento_w)||') ';
	end if;

	/* CONSISTENCIA DO PROC X LAUDO */

	/* Ignorar laudo de procedimento de intercorrencia - elias */

	begin
	ie_intercorrencia_w	:= 'N';
	select coalesce(max(ie_intercorrencia),'N')
	into STRICT	 ie_intercorrencia_w
	from	 procedimento_paciente
	where	 nr_atendimento	= nr_atendimento_p
	and	 cd_procedimento	= cd_procedimento_p
	and	 ie_origem_proced	= 2;
	end;

	retorno_w			:= 0;
	ds_tipo_laudo_sus_w	:= '';
	SELECT * FROM Obter_Tipo_Laudo_Sus(cd_procedimento_w, 2, ds_tipo_laudo_sus_w, ie_laudo_obrigatorio_w) INTO STRICT ds_tipo_laudo_sus_w, ie_laudo_obrigatorio_w;
	if (Length(ds_tipo_laudo_sus_w) > 0) then
		begin
		sql_select :=
		'Select count(*) ' ||
		' from sus_laudo_paciente ' ||
		' where nr_atendimento = ' || to_char(nr_atendimento_p) ||
		' and  nr_interno_conta = ' || to_char(nr_interno_conta_p) ||
		' and	cd_procedimento_solic 	= ' || to_char(cd_procedimento_w) ||
		' and	ie_tipo_laudo_sus in ' || '(' || ds_tipo_laudo_sus_w || ')';
		retorno_w := Obter_Valor_Dinamico(sql_select, retorno_w);
		if	retorno_w = 0 then
			begin
			if (ie_intercorrencia_w	= 'N') then
				begin
				if (ie_laudo_obrigatorio_w = 'S') then
					ds_erro_w	:= ds_erro_w ||'742'||'('||to_char(cd_procedimento_w)||') ';
				else
					ds_erro_w	:= ds_erro_w ||'743'||'('||to_char(cd_procedimento_w)||') ';
				end if;
				end;
			end if;
			end;
		end if;
		end;
	end if;

	/* CONSISTENCIA DO PROC SEM ATO */

	begin
	Select	count(*)
	into STRICT 		qt_proced_sem_ato_w
	from 		procedimento_paciente a
	where 	a.nr_atendimento 	= nr_atendimento_p
	and		a.cd_procedimento = cd_procedimento_p
	and		CASE WHEN a.ie_tipo_ato_sus=0 THEN null  ELSE a.ie_tipo_ato_sus coalesce(END::text, '') = ''
	and 		coalesce(a.cd_motivo_exc_conta::text, '') = ''
      and         a.cd_procedimento not in (99080010,99080011)
      and		ie_situacao_w	<> 'S'
	and 		not exists (SELECT x.cd_procedimento_solic
				from sus_laudo_paciente x
				where x.nr_atendimento 		= a.nr_atendimento
				and	x.cd_procedimento_solic = a.cd_procedimento
				and	x.ie_origem_proced	= a.ie_origem_proced);
	exception
			when others then
			qt_proced_sem_ato_w := 0;
	end;
	if (qt_proced_sem_ato_w > 0) then
		ds_erro_w	:= ds_erro_w ||'705'||'('||to_char(cd_procedimento_p)||') ';
	end if;

	/* CONSISTENCIA DO PROC SEM SERVICO */

	begin
	Select	count(*)
	into STRICT 		qt_proced_sem_serv_w
	from 		procedimento_paciente a
	where 	a.nr_atendimento 	= nr_atendimento_p
	and		a.cd_procedimento = cd_procedimento_p
	and 		coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and         	a.cd_procedimento not in (99080010,99080011)
      and		ie_situacao_w	<> 'S'
	and		CASE WHEN a.ie_tipo_servico_sus=0 THEN null  ELSE a.ie_tipo_servico_sus coalesce(END::text, '') = ''
	and 		not exists (SELECT x.cd_procedimento_solic
				from sus_laudo_paciente x
				where x.nr_atendimento 		= a.nr_atendimento
				and	x.cd_procedimento_solic = a.cd_procedimento
				and	x.ie_origem_proced	= a.ie_origem_proced);
	exception
			when others then
			qt_proced_sem_serv_w := 0;
	end;
	if (qt_proced_sem_serv_w > 0) then
		ds_erro_w	:= ds_erro_w ||'706'||'('||to_char(cd_procedimento_p)||') ';
	end if;

	/* CONSISTENCIA PROC. EXIGE MEDICO E ESTA SEM MEDICO */

	if (cd_procedimento_w not in (25001019,35001011,4001010,38008017)) 	and (ie_tipo_servico_p = 7) 						and (coalesce(cd_medico_executor_p::text, '') = '') 					then
		ds_erro_w		:= ds_erro_w ||'730'||'('||to_char(cd_procedimento_w)||') ';
	end if;

	/* CONSISTENCIA PROC. EXIGE MEDICO E ESTA SEM MEDICO - Felipe - 03/05/2006 - OS 32944*/

	if (cd_procedimento_w not in (25001019,35001011,4001010,38008017)) 	and (ie_tipo_servico_p = 4) 						and (coalesce(cd_medico_executor_p::text, '') = '') 					then
		ds_erro_w		:= ds_erro_w ||'774'||'('||to_char(cd_procedimento_w)||') ';
	end if;

	/*VERIFICA SE PROCEDIMENTO EXCLUI MÉDICO*/

	select 	sus_obter_proc_exclui_medico(cd_procedimento_p, ie_origem_proced_p)
	into STRICT	ie_exclui_medico_w
	;

	/* CONSISTENCIA PROC. NAO PERMITE E POSSUI MEDICO */

	if (ie_tipo_servico_p in (8,3,1,18,20))	and (ie_tipo_ato_p	<> 11)			and (ie_exclui_medico_w = 'N')					and (cd_medico_executor_p IS NOT NULL AND cd_medico_executor_p::text <> '')		then
		ds_erro_w		:= ds_erro_w ||'729'||'('||to_char(cd_procedimento_p)||') ';
	end if;

	/* CONSISTENCIA NOTA FISCAL */

	if (substr(cd_procedimento_p,1,2) = '93')	and (coalesce(nr_nf_prestador_p::text, '') = '')			then
		ds_erro_w		:= ds_erro_w ||'728'||'('||to_char(cd_procedimento_p)||') ';
	end if;
	END;

end if;

/* Consistencia para ver se a ultima vigencia tem preço  Marcus 27/07/00 */

if (ie_origem_proced_p = 2) then
	begin
	qt_proced_com_preco_w := 0;
	select count(*)
	into STRICT qt_proced_com_preco_w
	from sus_preco_procaih a
	where a.dt_competencia =
		(SELECT max(b.dt_competencia)
            from sus_preco_procaih b)
  	  and a.cd_procedimento = cd_procedimento_p
  	  and a.ie_origem_proced = ie_origem_proced_p;
	if (qt_proced_com_preco_w = 0) then
		ds_erro_w			:= ds_erro_w ||'767'||'('||to_char(cd_procedimento_p)||') ';
	end if;
	end;
end if;
if (ie_origem_proced_p = 3) then
	begin
	qt_proced_com_preco_w := 0;
	select count(*)
	into STRICT qt_proced_com_preco_w
	from sus_preco_procbpa a
	where a.dt_competencia =
		(SELECT max(b.dt_competencia)
            from sus_preco_procbpa b)
  	and 	a.cd_procedimento = cd_procedimento_p
  	and 	a.ie_origem_proced = ie_origem_proced_p
	and (a.vl_honorario_medico + a.vl_matmed + a.vl_procedimento) > 0;
	if (qt_proced_com_preco_w = 0) then
		ds_erro_w		:= ds_erro_w ||'508'||'('||to_char(cd_procedimento_p)||') ';
	end if;
	end;
end if;


ds_erro_p	:= substr(ds_erro_w,1,80);

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_procedimento ( NR_ATENDIMENTO_P bigint, CD_PROCEDIMENTO_P bigint, IE_ORIGEM_PROCED_P bigint, QT_PROCEDIMENTO_P bigint, CD_CONVENIO_P bigint, IE_TIPO_SERVICO_P bigint, IE_TIPO_ATO_P bigint, NR_NF_PRESTADOR_P bigint, CD_MEDICO_EXECUTOR_P text, NR_INTERNO_CONTA_P bigint, DS_ERRO_P INOUT text) FROM PUBLIC;

