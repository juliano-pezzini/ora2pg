-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_relatorio_modelo ( nr_seq_relatorio_p bigint, nr_seq_modelo_p bigint, nm_tabela_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
nr_campo_w		integer;
nr_seq_apres_banda_w	integer;
nr_seq_apres_w		smallint;
nr_seq_rel_param_w	bigint;
ds_sql_w		varchar(4000);
nm_atributo_w		varchar(30);
ds_prefixo_w		varchar(3);
nr_seq_banda_w		bigint;
nr_seq_campo_w		bigint;
qt_const_w		integer	:= 6;
ds_item_w		varchar(255);
ie_tipo_atributo_w	varchar(10);

c01 CURSOR FOR
	SELECT	nr_seq_pergunta, --nr_sequencia,
		coalesce(ds_item, obter_desc_expressao(346967,'Informar Label')),
		ie_tipo_atributo
	from	modelo_conteudo_v
	where	nr_seq_modelo = nr_seq_modelo_p
	and	ie_componente <> 'Visual'
	order  by nr_seq_apres;


BEGIN

delete
from	banda_relatorio
where	nr_seq_relatorio = nr_seq_relatorio_p;

delete
from	relatorio_parametro
where	nr_seq_relatorio = nr_seq_relatorio_p;

insert into banda_relatorio(
	nr_sequencia, 			ie_tipo_banda,
	ds_banda, 			dt_atualizacao,
	nm_usuario,			qt_altura,
	ds_cor_fundo,			ie_quebra_pagina,
	ie_reimprime_nova_pagina,	ie_alterna_cor_fundo,
	ie_imprime_vazio,		ie_imprime_primeiro,
	ie_borda_sup,			ie_borda_inf,
	ie_borda_esq, 			ie_borda_dir,
	nr_seq_relatorio,        	nr_seq_apresentacao,
	ds_cor_header,			ds_cor_footer,
	ds_cor_quebra,			ie_banda_padrao)
values (nextval('banda_relatorio_seq'), 	'C',
	obter_desc_expressao(486585,'Cabeçalho'),		 	clock_timestamp(),
	'Tasy',				70,
	'clWhite', 			'N',
	'N',				'N',
	'N',				'N',
	'N',				'S',
	'N',				'N',
	nr_seq_relatorio_p, 		1,
	'clSilver',			'clWhite',
	'$00E5E5E5',			'S');

-- Rodapé
insert into banda_relatorio(
	nr_sequencia, 			ie_tipo_banda,
	ds_banda, 			dt_atualizacao,
	nm_usuario,			qt_altura,
	ds_cor_fundo,			ie_quebra_pagina,
	ie_reimprime_nova_pagina,	ie_alterna_cor_fundo,
	ie_imprime_vazio,		ie_imprime_primeiro,
	ie_borda_sup,			ie_borda_inf,
	ie_borda_esq, 			ie_borda_dir,
	nr_seq_relatorio,		nr_seq_apresentacao,
	ds_cor_header,			ds_cor_footer,
	ds_cor_quebra,			ie_banda_padrao)
values (nextval('banda_relatorio_seq'), 	'R',
	obter_desc_expressao(486586,'Rodapé'), 			clock_timestamp(),
	'Tasy',				17,
	'clWhite', 			'N',
	'N',				'N',
	'N',				'N',
	'S',				'N',
	'N',				'N',
	nr_seq_relatorio_p, 		9999,
	'clSilver',			'clWhite',
	'$00E5E5E5',			'S');

nr_campo_w		:= 0;
nr_seq_apres_banda_w	:= 0;
nr_seq_apres_w		:= 0;

commit;

open c01;
loop
     fetch c01 into
     	nr_sequencia_w,
	ds_item_w,
	ie_tipo_atributo_w;
     EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	select	max(nr_seq_apresentacao)
	into STRICT	nr_seq_apres_banda_w
	from	banda_relatorio
	where	nr_seq_relatorio = nr_seq_relatorio_p
	and	nr_seq_apresentacao <> 9999;

	if (nr_seq_apres_w = qt_const_w) then
		nr_seq_apres_w	:= 1;
	else
		nr_seq_apres_w	:= nr_seq_apres_w + 1;
	end	if;

	if (mod(nr_campo_w,qt_const_w) = 0) or (nr_seq_apres_banda_w = 0) then

		if (mod(nr_campo_w,qt_const_w) = 0) and (nr_seq_banda_w > 0) then
			update	banda_relatorio
			set 	ds_sql =	'select	' || substr(ds_sql_w,1,length(ds_sql_w)-1) || 'from dual '
			where	nr_sequencia	= nr_seq_banda_w;
		end	if;

		nr_seq_apres_banda_w	:= nr_seq_apres_banda_w + 1;
		select	nextval('banda_relatorio_seq')
		into STRICT	nr_seq_banda_w
		;

		-- Subdetalhe
		insert into banda_relatorio(
			nr_sequencia, 			ie_tipo_banda,
			ds_banda, 			dt_atualizacao,
			nm_usuario,			qt_altura,
			ds_cor_fundo,			ie_quebra_pagina,
			ie_reimprime_nova_pagina,	ie_alterna_cor_fundo,
			ie_imprime_vazio,		ie_imprime_primeiro,
			ie_borda_sup,			ie_borda_inf,
        		ie_borda_esq, 			ie_borda_dir,
			nr_seq_relatorio,		ds_sql,
			nr_seq_apresentacao,
			ds_cor_header,			ds_cor_footer,
			ds_cor_quebra,			ie_banda_padrao)
		values (nr_seq_banda_w,	 	'S',
			obter_desc_expressao(284236,'Banda'),		 	clock_timestamp(),
			'Tasy',				18,
        		'clWhite', 			'N',
			'N',				'N',
			'N',				'N',
			'N',				'N',
			'N',				'N',
			nr_seq_relatorio_p, 		null,
			nr_seq_apres_banda_w,
			'clSilver',			'clWhite',
			'$00E5E5E5',			'N');

		ds_sql_w := '';

	end	if;

	ds_prefixo_w	:= '';
	if (ie_tipo_atributo_w = 'VARCHAR2') then
		ds_prefixo_w	:= 'ds_';
	elsif (ie_tipo_atributo_w = 'NUMBER') then
		ds_prefixo_w	:= 'vl_';
	elsif (ie_tipo_atributo_w = 'DATE') then
		ds_prefixo_w	:= 'dt_';
	end	if;

	nm_atributo_w	:= ds_prefixo_w || nr_sequencia_w;

	Criar_Campo_Relatorio(	nr_seq_banda_w,	substr(ds_item_w,1,19),
				nr_seq_apres_w, 	0,
				1, 			(((nr_seq_apres_w - 1) * 5) + 5) + ((nr_seq_apres_w - 1) * 100),
				100,			nm_atributo_w,
				'Tasy',
				nr_seq_campo_w);
	update	banda_relat_campo
	set	ds_label = substr(ds_item_w,1,19)
	where	nr_sequencia = nr_seq_campo_w;

	commit;

	ds_sql_w := ds_sql_w || '	substr(modelo_vlr(:nr_seq_declaracao_p,' || nr_sequencia_w || ',' || chr(39) || nm_tabela_p ||chr(39) ||'),1,254) ' || nm_atributo_w || chr(13) || chr(10) || ',';
	nr_campo_w	:= nr_campo_w + 1;

	end;
end loop;
close c01;

if (ds_sql_w IS NOT NULL AND ds_sql_w::text <> '') then
	update	banda_relatorio
	set 	ds_sql =	'select	' || substr(ds_sql_w,1,length(ds_sql_w)-1) || 'from dual '
	where	nr_sequencia	= nr_seq_banda_w;
end	if;


select	nextval('relatorio_parametro_seq')
into STRICT	nr_seq_rel_param_w
;

insert into RELATORIO_PARAMETRO(
	nr_sequencia, cd_parametro,
	ds_parametro, ie_tipo_atributo,
	nr_seq_relatorio, ie_origem_informacao,
	dt_atualizacao, nm_usuario,
	ie_forma_apresent, qt_tamanho_campo, ie_forma_passagem,
	ie_multi_linha,nr_seq_apresent)
values (nextval('relatorio_parametro_seq'), 'NR_SEQ_DECLARACAO_P',
	obter_desc_expressao(312150,'Seq. Registro'), 'NUMBER',
	nr_seq_relatorio_p, 'P',
	clock_timestamp(), 'Tasy',
	'ed', 80, 'P',
	'N', 1);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_relatorio_modelo ( nr_seq_relatorio_p bigint, nr_seq_modelo_p bigint, nm_tabela_p text) FROM PUBLIC;

