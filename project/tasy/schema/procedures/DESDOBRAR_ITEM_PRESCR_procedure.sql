-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desdobrar_item_prescr (nr_prescricao_p bigint, nr_seq_prescr_p bigint, qt_procedimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_procedimento_w	real;
nr_seq_proc_w		bigint;
dt_prescricao_w		timestamp;

BEGIN

select	coalesce(max(qt_procedimento),0)
into STRICT	qt_procedimento_w
from	prescr_procedimento
where	nr_prescricao = nr_prescricao_p
and	nr_sequencia = nr_seq_prescr_p;

select	max(dt_prescricao)
into STRICT	dt_prescricao_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

if (qt_procedimento_p >= qt_procedimento_w) then

	CALL Wheb_mensagem_pck.exibir_mensagem_abort(262613);

end if;

if (qt_procedimento_w > 0) and (qt_procedimento_p > 0) then



	update 	prescr_procedimento
	set	qt_procedimento = (qt_procedimento - qt_procedimento_p)
	where	nr_prescricao = nr_prescricao_p
	and	nr_sequencia = nr_seq_prescr_p;

	select	coalesce(max(nr_sequencia),0) + 1
	into STRICT	nr_seq_proc_w
	from	prescr_Procedimento
	where	nr_prescricao = nr_prescricao_p;

	Insert  into Prescr_Procedimento(
		NR_PRESCRICAO	,
		NR_SEQUENCIA      ,
		NR_AGRUPAMENTO    ,
		IE_EXECUTAR_LEITO ,
		IE_AMOSTRA	  ,
		CD_PROCEDIMENTO   ,
		QT_PROCEDIMENTO   ,
		DT_ATUALIZACAO    ,
		NM_USUARIO        ,
		DS_HORARIOS       ,
		DS_OBSERVACAO     ,
		DS_OBSERVACAO_ENF ,
		CD_MOTIVO_BAIXA   ,
		DT_BAIXA          ,
		CD_PROCEDIMENTO_AIH,
		IE_ORIGEM_PROCED  ,
		CD_INTERVALO      ,
		IE_URGENCIA       ,
		CD_SETOR_ATENDIMENTO,
		DT_EMISSAO_SETOR_ATEND,
		DS_DADO_CLINICO	,
		DT_PREV_EXECUCAO,
		IE_SUSPENSO,
		CD_MATERIAL_EXAME,
		NR_SEQ_EXAME,
		DS_MATERIAL_ESPECIAL,
		IE_STATUS_ATEND,
		IE_ORIGEM_INF,
		IE_SE_NECESSARIO,
		ie_acm,
		nr_ocorrencia,
		nr_seq_interno,
		NR_SEQ_PROC_INTERNO,
		QT_PECA_AP,
		DS_QUALIDADE_PECA_AP,
		DS_DIAG_PROVAVEL_AP,
		DS_EXAME_ANTERIOR_AP,
		NR_SEQ_DERIVADO,
		NR_SEQ_EXAME_SANGUE,
		NR_SEQ_SOLIC_SANGUE,
		CD_UNID_MED_SANGUE,
		CD_PESSOA_COLETA,
		DT_COLETA,
		IE_AVISAR_RESULT,
		qt_vol_hemocomp,
		nr_seq_prot_glic,
		ie_respiracao,
		cd_mod_vent,
		ie_disp_resp_esp,
		qt_fluxo_oxigenio,
		ds_rotina,
		qt_hora_intervalo,
		qt_min_intervalo,
		ie_autorizacao,
		ie_lado)
	SELECT  NR_PRESCRICAO_p,
	      	nr_seq_proc_w,
		coalesce(NR_AGRUPAMENTO,1),
		IE_EXECUTAR_LEITO,
		'N',
		CD_PROCEDIMENTO,
	     	qt_procedimento_p,
 	  	dt_prescricao_w,
	  	NM_USUARIO_P,
 	  	DS_HORARIOS,
 	  	DS_OBSERVACAO,
		DS_OBSERVACAO_ENF,
        	0,
        	null,
        	null,
        	IE_ORIGEM_PROCED,
        	CD_INTERVALO,
        	'N',
        	CD_SETOR_ATENDIMENTO,
	  	NULL,
	  	DS_DADO_CLINICO,
		DT_PREV_EXECUCAO,
	  	'N',
		CD_MATERIAL_EXAME,
		NR_SEQ_EXAME,
		DS_MATERIAL_ESPECIAL,
		5,
		IE_ORIGEM_INF,
		coalesce(IE_SE_NECESSARIO,'N'),
		coalesce(ie_acm,'N'),
		nr_ocorrencia,
		nextval('prescr_procedimento_seq'),
		NR_SEQ_PROC_INTERNO,
		QT_PECA_AP,
		DS_QUALIDADE_PECA_AP,
		DS_DIAG_PROVAVEL_AP,
		DS_EXAME_ANTERIOR_AP,
		NR_SEQ_DERIVADO,
		NR_SEQ_EXAME_SANGUE,
		CASE WHEN coalesce(NR_SEQ_SOLIC_SANGUE::text, '') = '' THEN null  ELSE NR_SEQ_SOLIC_SANGUE END ,
		CD_UNID_MED_SANGUE,
		CD_PESSOA_COLETA,
		null,
		'N',
		qt_vol_hemocomp,
		nr_seq_prot_glic,
		ie_respiracao,
		cd_mod_vent,
		ie_disp_resp_esp,
		qt_fluxo_oxigenio,
		ds_rotina,
		a.qt_hora_intervalo,
		a.qt_min_intervalo,
		'L',
		ie_lado
	From	Prescr_Procedimento a
	where	nr_prescricao = nr_prescricao_p
	and	nr_sequencia = nr_seq_prescr_p;


end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desdobrar_item_prescr (nr_prescricao_p bigint, nr_seq_prescr_p bigint, qt_procedimento_p bigint, nm_usuario_p text) FROM PUBLIC;

