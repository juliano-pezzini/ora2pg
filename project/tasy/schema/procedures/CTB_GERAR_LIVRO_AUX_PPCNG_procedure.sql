-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_livro_aux_ppcng ( nm_usuario_p text, cd_empresa_p text, cd_estabelecimento_p text, dt_inicial_p timestamp, dt_final_p timestamp, dt_liberacao_p timestamp, ie_gerar_arquivo_p text, nr_seq_regra_p bigint) AS $body$
DECLARE


dt_final_w				timestamp;
nr_contador_w				bigint := 0;
vl_rec_antecipado_w			double precision;
vl_rec_cobertura_w			double precision;
ds_observacao_w				varchar(255);
ds_observacao_item_w			varchar(255);
cd_conta_contabil_w			conta_contabil.cd_conta_contabil%type;
ie_gerar_ind_classif_w			ctb_livro_auxiliar.ie_gerar_ind_classif%type;
ie_tipo_segurado_w			pls_segurado.ie_tipo_segurado%type;

/* VARIAVEIS DE GERACAO DO ARQUIVO*/

ds_erro_w				varchar(255);
ds_local_w				varchar(255);
arq_texto_w				utl_file.file_type;
nm_arquivo_w				varchar(255);
ds_nome_livro_w				varchar(255);
ds_periodo_w				varchar(255);

c_linha CURSOR FOR
	SELECT	nr_titulo								   ||';'||
	 	substr(pls_obter_se_corresp_assumida(ie_tipo_segurado,nr_contrato),1,255)  ||';'||
		dt_contrato								   ||';'||
		dt_rescisao								   ||';'||
		ds_tipo_contratacao							   ||';'||
		substr(pls_obter_se_corresp_assumida(ie_tipo_segurado,dt_contratacao),1,255)		||';'||
		ds_segmentacao								   ||';'||
		nm_usuario_principal							   ||';'||
		substr(pls_obter_se_corresp_assumida(ie_tipo_segurado,cd_cpf_cnpj),1,255)  ||';'||
		substr(obter_valor_dominio(6,pls_obter_se_benef_remido(nr_seq_segurado,
			dt_referencia)),1,255)						   ||';'||
		ds_tipo_documento							   ||';'||
		nr_documento								   ||';'||
		dt_emissao								   ||';'||
		nr_parcela								   ||';'||
		dt_baixa								   ||';'||
		dt_vencimento								   ||';'||
		dt_cancelamento						         	   ||';'||
		formata_casas_decimais(vl_parcela,2)					   ||';'||
		dt_inicio_cobertura							   ||';'||
		dt_fim_cobertura							   ||';'||
		formata_casas_decimais(vl_apropriado,2)				           ||';'||
		formata_casas_decimais(vl_antecipado,2)					   ||';'||
		dt_rec_antec								   ||';'||
		formata_casas_decimais(vl_fat_antec,2)					   ||';'||
		formata_casas_decimais(vl_rec_cobertura,2)				   ||';'||
		vl_contrato								   ||';'||
		cd_conta_contabil							   ||';'||
		substr(ctb_obter_classif_conta(cd_conta_contabil, null, dt_final_w),1,255) ||';'||
		cd_conta_cred_encargos							   ||';'||
		substr(ctb_obter_classif_conta(cd_conta_cred_encargos, null, dt_final_w),1,255) ||';'||
		ds_observacao ds_linha
	from	w_ctb_aux_contra_emit
	where	nr_seq_reg_auxiliar = nr_seq_regra_p
	order by (nr_documento)::numeric;

c_titulo CURSOR FOR
	SELECT	*
	from	(
		SELECT	s.nr_seq_contrato,
			(select	c.dt_contrato
			from	pls_contrato c
			where	c.nr_sequencia = s.nr_seq_contrato) dt_contrato,
			(select	c.dt_rescisao_contrato
			from	pls_contrato c
			where	c.nr_sequencia = s.nr_seq_contrato) dt_rescisao_contrato,
			p.ie_tipo_contratacao,
			p.ie_segmentacao,
			substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_usuario_principal,
			(coalesce(substr(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),1,255),
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'CGC'),1,255))) cd_cpf_cnpj,
			'TR' ie_tipo_documento,
			t.nr_titulo nr_documento,
			t.nr_titulo,
			t.dt_emissao,
			to_char(a.nr_parcela) nr_parcela,
			t.dt_vencimento,
			sum(f.vl_classificacao) vl_parcela,
			null dt_inicio_cobertura,
			null dt_fim_cobertura,
			0 vl_apropriado,
			0 vl_antecipado,
			0 vl_rec_antecipado,
			0 vl_rec_cobertura,
			null dt_rec_antecipado,
			f.cd_conta_contabil cd_conta_contabil,
			s.nr_seq_pagador,
			t.vl_titulo,
			0 vl_ato_cooperado,
			0 vl_ato_auxiliar,
			0 vl_ato_nao_cooperado,
			null cd_conta_ato_cooperado,
			null cd_conta_ato_auxiliar,
			null cd_conta_ato_nao_coop,
			null cd_conta_rec,
			null nr_seq_item_mens,
			s.ie_tipo_segurado,
			s.dt_contratacao,
			null dt_cancelamento,
			(select	max(x.dt_recebimento)
			from	titulo_receber_liq x
			where	x.nr_titulo = t.nr_titulo) dt_recebimento,
			s.nr_sequencia nr_seq_segurado
		FROM titulo_receber t, titulo_receber_classif f, titulo_receber_info_aux a, pls_segurado s
LEFT OUTER JOIN pls_plano p ON (s.nr_seq_plano = p.nr_sequencia)
WHERE t.nr_titulo 	= f.nr_titulo and t.nr_titulo 	= a.nr_titulo and s.nr_sequencia 	= a.nr_seq_segurado  and ((coalesce(t.dt_liquidacao::text, '') = '')
		or (t.dt_liquidacao > dt_final_w)) and pkg_date_utils.start_of(t.dt_emissao,'MONTH',0) = pkg_date_utils.start_of(dt_final_w,'MONTH',0) and ((ie_gerar_ind_classif_w <> 'N')
		or	f.cd_conta_contabil in (select	cd_conta_contabil
						from	conta_contabil
						where	substr(ctb_obter_classif_conta(cd_conta_contabil,cd_classificacao,dt_inicio_vigencia),1,7) = '2.1.3.2'
						and	ie_tipo = 'A')) and coalesce(cd_estabelecimento_p, t.cd_estabelecimento) = t.cd_estabelecimento and obter_empresa_estab(t.cd_estabelecimento) = cd_empresa_p and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(s.ie_tipo_segurado,'X'))
		or (coalesce(ie_tipo_segurado_w,'X') = 'X')) group by s.nr_seq_contrato,
			p.ie_tipo_contratacao,
			p.ie_segmentacao,
			substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255),
			(coalesce(substr(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),1,255),
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'CGC'),1,255))),
			'TR',
			a.nr_sequencia,
			t.nr_titulo,
			t.dt_emissao,
			to_char(a.nr_parcela),
			t.dt_vencimento,
			f.cd_conta_contabil,
			s.nr_seq_pagador,
			t.vl_titulo,
			s.ie_tipo_segurado,
			s.nr_sequencia,
			s.dt_contratacao
		
union all

		select 	c.nr_contrato,
			c.dt_contrato,
			c.dt_rescisao_contrato,
			p.ie_tipo_contratacao,
			p.ie_segmentacao,
			substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_usuario_principal,
			(coalesce(substr(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),1,255),
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'CGC'),1,255))) cd_cpf_cnpj,
			'TR' ie_tipo_documento,
			t.nr_titulo nr_documento,
			t.nr_titulo,
			t.dt_emissao,
			substr(pls_obter_parcela_contrato(c.nr_contrato,a.dt_mesano_referencia),1,10) nr_parcela,
			t.dt_vencimento,
			sum(i.vl_item) vl_parcela,
			a.dt_inicio_cobertura,
			a.dt_fim_cobertura,
			sum(CASE WHEN l.ie_cobrar_retroativo='S' THEN  CASE WHEN l.dt_mesano_referencia=a.dt_mesano_referencia THEN  i.vl_pro_rata_dia  ELSE i.vl_item END   ELSE i.vl_pro_rata_dia END ) vl_apropriado,
			sum(CASE WHEN l.ie_cobrar_retroativo='S' THEN CASE WHEN l.dt_mesano_referencia=a.dt_mesano_referencia THEN  i.vl_antecipacao  ELSE 0 END   ELSE i.vl_antecipacao END ) vl_antecipado,
			sum((	select	coalesce(sum(q.vl_recebido),0)
				from	titulo_receber_liq 	q
				where	q.nr_titulo	= t.nr_titulo
				and	pkg_date_utils.start_of(to_date(q.dt_recebimento,'dd/mm/yy'),'MONTH',0) <= pkg_date_utils.add_month(a.dt_inicio_cobertura, -1, 0)) * i.vl_item / t.vl_titulo) vl_rec_antecipado,
			sum((	select	coalesce(sum(q.vl_recebido),0)
				from	titulo_receber_liq 	q
				where	q.nr_titulo	= t.nr_titulo
				and	to_date(q.dt_recebimento,'dd/mm/yy') >= a.dt_inicio_cobertura) * i.vl_item / t.vl_titulo) vl_rec_cobertura,
			((select max(q.dt_recebimento)
			from	titulo_receber_liq 	q
			where	q.nr_titulo	= t.nr_titulo
			and	pkg_date_utils.start_of(to_date(q.dt_recebimento,'dd/mm/yy'),'MONTH',0) <= pkg_date_utils.add_month(a.dt_inicio_cobertura, -1, 0))) dt_rec_antecipado,
			i.cd_conta_contabil_ppcng cd_conta_contabil,
			s.nr_seq_pagador,
			t.vl_titulo,
			i.vl_ato_cooperado,
			i.vl_ato_auxiliar,
			i.vl_ato_nao_cooperado,
			i.cd_conta_ato_cooperado,
			i.cd_conta_ato_auxiliar,
			i.cd_conta_ato_nao_coop,
			i.cd_conta_rec,
			i.nr_sequencia nr_seq_item_mens,
			s.ie_tipo_segurado,
			s.dt_contratacao,
			m.dt_cancelamento,
			(select	max(x.dt_recebimento)
			from	titulo_receber_liq x
			where	x.nr_titulo = t.nr_titulo) dt_recebimento,
			s.nr_sequencia nr_seq_segurado
		from	pls_lote_mensalidade		l,
			pls_mensalidade			m,
			pls_mensalidade_segurado	a,
			pls_mensalidade_seg_item	i,
			titulo_receber			t,
			pls_plano			p,
			pls_contrato			c,
			pls_segurado			s
		where	l.nr_sequencia	= m.nr_seq_lote
		and	a.nr_sequencia 	= i.nr_seq_mensalidade_seg
		and	m.nr_sequencia	= a.nr_seq_mensalidade
		and	m.nr_sequencia	= t.nr_seq_mensalidade
		and	s.nr_sequencia 	= a.nr_seq_segurado
		and	p.nr_sequencia	= s.nr_seq_plano
		and	c.nr_sequencia	= s.nr_seq_contrato
		and	pkg_date_utils.start_of(l.dt_mesano_referencia,'MONTH',0) = pkg_date_utils.start_of(dt_final_w,'MONTH',0)
		and	i.ie_tipo_item not in ('3','6')
		and	((ie_gerar_ind_classif_w <> 'N')
		or	coalesce(i.cd_conta_contabil_ppcng,'X') <> 'X')
		and	t.ie_situacao <> '3'
		and	coalesce(cd_estabelecimento_p, t.cd_estabelecimento) = t.cd_estabelecimento
		and	obter_empresa_estab(t.cd_estabelecimento) = cd_empresa_p
		and	m.vl_mensalidade <> 0
		and	not exists (select	1
					from	titulo_receber_info_aux a
					where	t.nr_titulo = a.nr_titulo)
		and	((coalesce(ie_tipo_segurado_w,'X') = coalesce(s.ie_tipo_segurado,'X'))
		or (coalesce(ie_tipo_segurado_w,'X') = 'X'))
		group by c.nr_contrato,
			c.dt_contrato,
			c.dt_rescisao_contrato,
			p.ie_tipo_contratacao,
			p.ie_segmentacao,
			substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255),
			(coalesce(substr(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),1,255),
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'CGC'),1,255))),
			'TR',
			m.nr_sequencia,
			t.nr_titulo,
			t.dt_emissao,
			substr(pls_obter_parcela_contrato(c.nr_contrato,a.dt_mesano_referencia),1,10),
			t.dt_vencimento,
			a.dt_inicio_cobertura,
			a.dt_fim_cobertura,
			i.cd_conta_contabil_ppcng,
			s.nr_seq_pagador,
			t.vl_titulo,
			i.vl_ato_cooperado,
			i.vl_ato_auxiliar,
			i.vl_ato_nao_cooperado,
			i.cd_conta_ato_cooperado,
			i.cd_conta_ato_auxiliar,
			i.cd_conta_ato_nao_coop,
			i.cd_conta_rec,
			i.nr_sequencia,
			l.ie_cobrar_retroativo,
			s.ie_tipo_segurado,
			s.nr_sequencia,
			s.dt_contratacao,
			m.dt_cancelamento
		
union all

		select 	c.nr_contrato,
			c.dt_contrato,
			c.dt_rescisao_contrato,
			p.ie_tipo_contratacao,
			p.ie_segmentacao,
			substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_usuario_principal,
			(coalesce(substr(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),1,255),
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'CGC'),1,255))) cd_cpf_cnpj,
			'TR' ie_tipo_documento,
			t.nr_titulo nr_documento,
			t.nr_titulo,
			t.dt_emissao,
			substr(pls_obter_parcela_contrato(c.nr_contrato,a.dt_mesano_referencia),1,10) nr_parcela,
			t.dt_vencimento,
			sum(coalesce(f.vl_copartic_mens,f.vl_coparticipacao)) vl_parcela,
			a.dt_inicio_cobertura,
			a.dt_fim_cobertura,
			sum(coalesce(f.vl_copartic_mens,f.vl_coparticipacao)) vl_apropriado,
			0 vl_antecipado,
			sum((	select	coalesce(sum(q.vl_recebido),0)
				from	titulo_receber_liq 	q
				where	q.nr_titulo	= t.nr_titulo
				and	pkg_date_utils.start_of(to_date(q.dt_recebimento,'dd/mm/yy'),'MONTH',0) <= pkg_date_utils.add_month(a.dt_inicio_cobertura, -1, 0)) * coalesce(f.vl_copartic_mens,f.vl_coparticipacao) / t.vl_titulo) vl_rec_antecipado,
			sum((	select	coalesce(sum(q.vl_recebido),0)
				from	titulo_receber_liq 	q
				where	q.nr_titulo	= t.nr_titulo
				and	to_date(q.dt_recebimento,'dd/mm/yy') >= a.dt_inicio_cobertura) * coalesce(f.vl_copartic_mens,f.vl_coparticipacao) / t.vl_titulo) vl_rec_cobertura,
			((select max(q.dt_recebimento)
			from	titulo_receber_liq 	q
			where	q.nr_titulo	= t.nr_titulo
			and	pkg_date_utils.start_of(to_date(q.dt_recebimento,'dd/mm/yy'),'MONTH',0) <= pkg_date_utils.add_month(a.dt_inicio_cobertura, -1, 0))) dt_rec_antecipado,
			f.cd_conta_deb cd_conta_contabil,
			s.nr_seq_pagador,
			t.vl_titulo,
			0 vl_ato_cooperado,
			0 vl_ato_auxiliar,
			0 vl_ato_nao_cooperado,
			null cd_conta_ato_cooperado,
			null cd_conta_ato_auxiliar,
			null cd_conta_ato_nao_coop,
			f.cd_conta_cred,
			i.nr_sequencia nr_seq_item_mens,
			s.ie_tipo_segurado,
			s.dt_contratacao,
			m.dt_cancelamento,
			(select	max(x.dt_recebimento)
			from	titulo_receber_liq x
			where	x.nr_titulo = t.nr_titulo) dt_recebimento,
			s.nr_sequencia nr_seq_segurado
		from	pls_lote_mensalidade		l,
			pls_mensalidade			m,
			pls_mensalidade_segurado	a,
			pls_mensalidade_seg_item	i,
			pls_conta_coparticipacao	f,
			pls_conta			d,
			titulo_receber			t,
			pls_plano			p,
			pls_contrato			c,
			pls_segurado			s
		where	l.nr_sequencia	= m.nr_seq_lote
		and	a.nr_sequencia 	= i.nr_seq_mensalidade_seg
		and	m.nr_sequencia	= a.nr_seq_mensalidade
		and	m.nr_sequencia	= t.nr_seq_mensalidade
		and	d.nr_sequencia	= f.nr_seq_conta
		and	d.nr_sequencia	= i.nr_seq_conta
		and	s.nr_sequencia 	= a.nr_seq_segurado
		and	p.nr_sequencia	= s.nr_seq_plano
		and	c.nr_sequencia	= s.nr_seq_contrato
		and	pkg_date_utils.start_of(l.dt_mesano_referencia,'MONTH',0) = pkg_date_utils.start_of(dt_final_w,'MONTH',0)
		and	i.ie_tipo_item		= '3'
		and	((ie_gerar_ind_classif_w <> 'N')
		or	coalesce(i.cd_conta_contabil_ppcng,'X') <> 'X')
		and	t.ie_situacao <> '3'
		and	coalesce(cd_estabelecimento_p, t.cd_estabelecimento) = t.cd_estabelecimento
		and	obter_empresa_estab(t.cd_estabelecimento) = cd_empresa_p
		and	m.vl_mensalidade <> 0
		and	not exists (select	1
					from	titulo_receber_info_aux a
					where	t.nr_titulo = a.nr_titulo)
		and	((coalesce(ie_tipo_segurado_w,'X') = coalesce(s.ie_tipo_segurado,'X'))
		or (coalesce(ie_tipo_segurado_w,'X') = 'X'))
		and	coalesce(f.ie_status_coparticipacao, 'P') != 'N'
		and	f.ie_status_mensalidade <> 'C'
		and (m.ie_cancelamento in ('C','E')
		or	a.nr_sequencia  = f.nr_seq_mensalidade_seg)
		and	not exists (	select	1
					from	pls_mensalidade_item_conta z
					where	z.nr_seq_conta_copartic = f.nr_sequencia)
		group by c.nr_contrato,
			c.dt_contrato,
			c.dt_rescisao_contrato,
			p.ie_tipo_contratacao,
			p.ie_segmentacao,
			substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255),
			(coalesce(substr(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),1,255),
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'CGC'),1,255))),
			'TR',
			m.nr_sequencia,
			t.nr_titulo,
			t.dt_emissao,
			substr(pls_obter_parcela_contrato(c.nr_contrato,a.dt_mesano_referencia),1,10),
			t.dt_vencimento,
			a.dt_inicio_cobertura,
			a.dt_fim_cobertura,
			f.cd_conta_deb,
			s.nr_seq_pagador,
			t.vl_titulo,
			f.cd_conta_cred,
			i.nr_sequencia,
			l.ie_cobrar_retroativo,
			s.ie_tipo_segurado,
			s.nr_sequencia,
			s.dt_contratacao,
			m.dt_cancelamento
		
union all

		select 	c.nr_contrato,
			c.dt_contrato,
			c.dt_rescisao_contrato,
			p.ie_tipo_contratacao,
			p.ie_segmentacao,
			substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_usuario_principal,
			(coalesce(substr(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),1,255),
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'CGC'),1,255))) cd_cpf_cnpj,
			'TR' ie_tipo_documento,
			t.nr_titulo nr_documento,
			t.nr_titulo,
			t.dt_emissao,
			substr(pls_obter_parcela_contrato(c.nr_contrato,a.dt_mesano_referencia),1,10) nr_parcela,
			t.dt_vencimento,
			sum(j.vl_item) vl_parcela,
			a.dt_inicio_cobertura,
			a.dt_fim_cobertura,
			sum(j.vl_item) vl_apropriado,
			0 vl_antecipado,
			sum((	select	coalesce(sum(q.vl_recebido),0)
				from	titulo_receber_liq 	q
				where	q.nr_titulo	= t.nr_titulo
				and	pkg_date_utils.start_of(to_date(q.dt_recebimento,'dd/mm/yy'),'MONTH',0) <= pkg_date_utils.add_month(a.dt_inicio_cobertura, -1, 0)) * j.vl_item / t.vl_titulo) vl_rec_antecipado,
			sum((	select	coalesce(sum(q.vl_recebido),0)
				from	titulo_receber_liq 	q
				where	q.nr_titulo	= t.nr_titulo
				and	to_date(q.dt_recebimento,'dd/mm/yy') >= a.dt_inicio_cobertura) * j.vl_item / t.vl_titulo) vl_rec_cobertura,
			((select max(q.dt_recebimento)
			from	titulo_receber_liq 	q
			where	q.nr_titulo	= t.nr_titulo
			and	pkg_date_utils.start_of(to_date(q.dt_recebimento,'dd/mm/yy'),'MONTH',0) <= pkg_date_utils.add_month(a.dt_inicio_cobertura, -1, 0))) dt_rec_antecipado,
			f.cd_conta_deb cd_conta_contabil,
			s.nr_seq_pagador,
			t.vl_titulo,
			0 vl_ato_cooperado,
			0 vl_ato_auxiliar,
			0 vl_ato_nao_cooperado,
			null cd_conta_ato_cooperado,
			null cd_conta_ato_auxiliar,
			null cd_conta_ato_nao_coop,
			f.cd_conta_cred,
			i.nr_sequencia nr_seq_item_mens,
			s.ie_tipo_segurado,
			s.dt_contratacao,
			m.dt_cancelamento,
			(select	max(x.dt_recebimento)
			from	titulo_receber_liq x
			where	x.nr_titulo = t.nr_titulo) dt_recebimento,
			s.nr_sequencia nr_seq_segurado
		from	pls_lote_mensalidade		l,
			pls_mensalidade			m,
			pls_mensalidade_segurado	a,
			pls_mensalidade_seg_item	i,
			pls_mensalidade_item_conta	j,
			pls_conta_coparticipacao	f,
			pls_conta			d,
			titulo_receber			t,
			pls_plano			p,
			pls_contrato			c,
			pls_segurado			s
		where	l.nr_sequencia	= m.nr_seq_lote
		and	a.nr_sequencia 	= i.nr_seq_mensalidade_seg
		and	m.nr_sequencia	= a.nr_seq_mensalidade
		and	m.nr_sequencia	= t.nr_seq_mensalidade
		and	f.nr_sequencia	= j.nr_seq_conta_copartic
		and	j.nr_seq_item	= i.nr_sequencia
		and	d.nr_sequencia	= f.nr_seq_conta
		and	d.nr_sequencia	= i.nr_seq_conta
		and	s.nr_sequencia 	= a.nr_seq_segurado
		and	p.nr_sequencia	= s.nr_seq_plano
		and	c.nr_sequencia	= s.nr_seq_contrato
		and	pkg_date_utils.start_of(l.dt_mesano_referencia,'MONTH',0) = pkg_date_utils.start_of(dt_final_w,'MONTH',0)
		and	i.ie_tipo_item		= '3'
		and	coalesce(f.ie_status_coparticipacao, 'P') != 'N'
		and	((ie_gerar_ind_classif_w <> 'N')
		or	coalesce(i.cd_conta_contabil_ppcng,'X') <> 'X')
		and	t.ie_situacao <> '3'
		and	coalesce(cd_estabelecimento_p, t.cd_estabelecimento) = t.cd_estabelecimento
		and	obter_empresa_estab(t.cd_estabelecimento) = cd_empresa_p
		and	m.vl_mensalidade <> 0
		and	not exists (select	1
					from	titulo_receber_info_aux a
					where	t.nr_titulo = a.nr_titulo)
		and	((coalesce(ie_tipo_segurado_w,'X') = coalesce(s.ie_tipo_segurado,'X'))
		or (coalesce(ie_tipo_segurado_w,'X') = 'X'))
		group by c.nr_contrato,
			c.dt_contrato,
			c.dt_rescisao_contrato,
			p.ie_tipo_contratacao,
			p.ie_segmentacao,
			substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255),
			(coalesce(substr(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),1,255),
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'CGC'),1,255))),
			'TR',
			m.nr_sequencia,
			t.nr_titulo,
			t.dt_emissao,
			substr(pls_obter_parcela_contrato(c.nr_contrato,a.dt_mesano_referencia),1,10),
			t.dt_vencimento,
			a.dt_inicio_cobertura,
			a.dt_fim_cobertura,
			f.cd_conta_deb,
			s.nr_seq_pagador,
			t.vl_titulo,
			f.cd_conta_cred,
			i.nr_sequencia,
			l.ie_cobrar_retroativo,
			s.ie_tipo_segurado,
			s.dt_contratacao,
			m.dt_cancelamento,
			s.nr_sequencia
		
union all

		select 	c.nr_contrato,
			c.dt_contrato,
			c.dt_rescisao_contrato,
			p.ie_tipo_contratacao,
			p.ie_segmentacao,
			substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_usuario_principal,
			(coalesce(substr(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),1,255),
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'CGC'),1,255))) cd_cpf_cnpj,
			'TR' ie_tipo_documento,
			t.nr_titulo nr_documento,
			t.nr_titulo,
			t.dt_emissao,
			substr(pls_obter_parcela_contrato(c.nr_contrato,a.dt_mesano_referencia),1,10) nr_parcela,
			t.dt_vencimento,
			sum(f.vl_beneficiario) vl_parcela,
			a.dt_inicio_cobertura,
			a.dt_fim_cobertura,
			sum(f.vl_beneficiario) vl_apropriado,
			0 vl_antecipado,
			sum((	select	coalesce(sum(q.vl_recebido),0)
				from	titulo_receber_liq 	q
				where	q.nr_titulo	= t.nr_titulo
				and	pkg_date_utils.start_of(to_date(q.dt_recebimento,'dd/mm/yy'),'MONTH',0) <= pkg_date_utils.add_month(a.dt_inicio_cobertura, -1, 0)) * f.vl_beneficiario / t.vl_titulo) vl_rec_antecipado,
			sum((	select	coalesce(sum(q.vl_recebido),0)
				from	titulo_receber_liq 	q
				where	q.nr_titulo	= t.nr_titulo
				and	to_date(q.dt_recebimento,'dd/mm/yy') >= a.dt_inicio_cobertura) * f.vl_beneficiario / t.vl_titulo) vl_rec_cobertura,
			((select max(q.dt_recebimento)
			from	titulo_receber_liq 	q
			where	q.nr_titulo	= t.nr_titulo
			and	pkg_date_utils.start_of(to_date(q.dt_recebimento,'dd/mm/yy'),'MONTH',0) <= pkg_date_utils.add_month(a.dt_inicio_cobertura, -1, 0))) dt_rec_antecipado,
			f.cd_conta_deb cd_conta_contabil,
			s.nr_seq_pagador,
			t.vl_titulo,
			0 vl_ato_cooperado,
			0 vl_ato_auxiliar,
			0 vl_ato_nao_cooperado,
			null cd_conta_ato_cooperado,
			null cd_conta_ato_auxiliar,
			null cd_conta_ato_nao_coop,
			f.cd_conta_cred,
			i.nr_sequencia nr_seq_item_mens,
			s.ie_tipo_segurado,
			s.dt_contratacao,
			m.dt_cancelamento,
			(select	max(x.dt_recebimento)
			from	titulo_receber_liq x
			where	x.nr_titulo = t.nr_titulo) dt_recebimento,
			s.nr_sequencia nr_seq_segurado
		from	pls_lote_mensalidade		l,
			pls_mensalidade			m,
			pls_mensalidade_segurado	a,
			pls_mensalidade_seg_item	i,
			pls_conta_pos_estabelecido	f,
			pls_conta			d,
			titulo_receber			t,
			pls_plano			p,
			pls_contrato			c,
			pls_segurado			s
		where	l.nr_sequencia	= m.nr_seq_lote
		and	a.nr_sequencia 	= i.nr_seq_mensalidade_seg
		and	m.nr_sequencia	= a.nr_seq_mensalidade
		and	m.nr_sequencia	= t.nr_seq_mensalidade
		and	d.nr_sequencia	= f.nr_seq_conta
		and	d.nr_sequencia	= i.nr_seq_conta
		and	s.nr_sequencia 	= a.nr_seq_segurado
		and	p.nr_sequencia	= s.nr_seq_plano
		and	c.nr_sequencia	= s.nr_seq_contrato
		and	coalesce(f.ie_situacao,'A') = 'A'
		and	pkg_date_utils.start_of(l.dt_mesano_referencia,'MONTH',0) = pkg_date_utils.start_of(dt_final_w,'MONTH',0)
		and	i.ie_tipo_item	= '6'
		and	((ie_gerar_ind_classif_w <> 'N')
		or	coalesce(i.cd_conta_contabil_ppcng,'X') <> 'X')
		and	t.ie_situacao <> '3'
		and	coalesce(cd_estabelecimento_p, t.cd_estabelecimento) = t.cd_estabelecimento
		and	obter_empresa_estab(t.cd_estabelecimento) = cd_empresa_p
		and	m.vl_mensalidade <> 0
		and	not exists (select	1
					from	titulo_receber_info_aux a
					where	t.nr_titulo = a.nr_titulo)
		and	((coalesce(ie_tipo_segurado_w,'X') = coalesce(s.ie_tipo_segurado,'X'))
		or (coalesce(ie_tipo_segurado_w,'X') = 'X'))
		and (m.ie_cancelamento in ('C','E')
		or	a.nr_sequencia  = f.nr_seq_mensalidade_seg)
		and	not exists (select	1
					from	pls_mensalidade_item_conta	x
					where	i.nr_sequencia	= x.nr_seq_item)
		group by c.nr_contrato,
			c.dt_contrato,
			c.dt_rescisao_contrato,
			p.ie_tipo_contratacao,
			p.ie_segmentacao,
			substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255),
			(coalesce(substr(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),1,255),
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'CGC'),1,255))),
			'TR',
			m.nr_sequencia,
			t.nr_titulo,
			t.dt_emissao,
			substr(pls_obter_parcela_contrato(c.nr_contrato,a.dt_mesano_referencia),1,10),
			t.dt_vencimento,
			a.dt_inicio_cobertura,
			a.dt_fim_cobertura,
			f.cd_conta_deb,
			s.nr_seq_pagador,
			t.vl_titulo,
			f.cd_conta_cred,
			i.nr_sequencia,
			l.ie_cobrar_retroativo,
			s.ie_tipo_segurado,
			s.nr_sequencia,
			s.dt_contratacao,
			m.dt_cancelamento
		
union all

		select 	c.nr_contrato,
			c.dt_contrato,
			c.dt_rescisao_contrato,
			p.ie_tipo_contratacao,
			p.ie_segmentacao,
			substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_usuario_principal,
			(coalesce(substr(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),1,255),
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'CGC'),1,255))) cd_cpf_cnpj,
			'TR' ie_tipo_documento,
			t.nr_titulo nr_documento,
			t.nr_titulo,
			t.dt_emissao,
			substr(pls_obter_parcela_contrato(c.nr_contrato,a.dt_mesano_referencia),1,10) nr_parcela,
			t.dt_vencimento,
			sum(j.vl_item) vl_parcela,
			a.dt_inicio_cobertura,
			a.dt_fim_cobertura,
			sum(j.vl_item) vl_apropriado,
			0 vl_antecipado,
			sum((	select	coalesce(sum(q.vl_recebido),0)
				from	titulo_receber_liq 	q
				where	q.nr_titulo	= t.nr_titulo
				and	pkg_date_utils.start_of(to_date(q.dt_recebimento,'dd/mm/yy'),'MONTH',0) <= pkg_date_utils.add_month(a.dt_inicio_cobertura, -1, 0)) * j.vl_item / t.vl_titulo) vl_rec_antecipado,
			sum((	select	coalesce(sum(q.vl_recebido),0)
				from	titulo_receber_liq 	q
				where	q.nr_titulo	= t.nr_titulo
				and	to_date(q.dt_recebimento,'dd/mm/yy') >= a.dt_inicio_cobertura) * j.vl_item / t.vl_titulo) vl_rec_cobertura,
			((select max(q.dt_recebimento)
			from	titulo_receber_liq 	q
			where	q.nr_titulo	= t.nr_titulo
			and	pkg_date_utils.start_of(to_date(q.dt_recebimento,'dd/mm/yy'),'MONTH',0) <= pkg_date_utils.add_month(a.dt_inicio_cobertura, -1, 0))) dt_rec_antecipado,
			f.cd_conta_deb cd_conta_contabil,
			s.nr_seq_pagador,
			t.vl_titulo,
			0 vl_ato_cooperado,
			0 vl_ato_auxiliar,
			0 vl_ato_nao_cooperado,
			null cd_conta_ato_cooperado,
			null cd_conta_ato_auxiliar,
			null cd_conta_ato_nao_coop,
			f.cd_conta_cred,
			i.nr_sequencia nr_seq_item_mens,
			s.ie_tipo_segurado,
			s.dt_contratacao,
			m.dt_cancelamento,
			(select	max(x.dt_recebimento)
			from	titulo_receber_liq x
			where	x.nr_titulo = t.nr_titulo) dt_recebimento,
			s.nr_sequencia nr_seq_segurado
		from	pls_lote_mensalidade		l,
			pls_mensalidade			m,
			pls_mensalidade_segurado	a,
			pls_mensalidade_seg_item	i,
			pls_mensalidade_item_conta	j,
			pls_conta_pos_estabelecido	f,
			pls_conta			d,
			titulo_receber			t,
			pls_plano			p,
			pls_contrato			c,
			pls_segurado			s
		where	l.nr_sequencia	= m.nr_seq_lote
		and	a.nr_sequencia 	= i.nr_seq_mensalidade_seg
		and	m.nr_sequencia	= a.nr_seq_mensalidade
		and	m.nr_sequencia	= t.nr_seq_mensalidade
		and	f.nr_sequencia	= j.nr_seq_conta_pos_estab
		and	j.nr_seq_item	= i.nr_sequencia
		and	d.nr_sequencia	= f.nr_seq_conta
		and	d.nr_sequencia	= i.nr_seq_conta
		and	s.nr_sequencia 	= a.nr_seq_segurado
		and	p.nr_sequencia	= s.nr_seq_plano
		and	c.nr_sequencia	= s.nr_seq_contrato
		and	coalesce(f.ie_situacao,'A') = 'A'
		and	pkg_date_utils.start_of(l.dt_mesano_referencia,'MONTH',0) = pkg_date_utils.start_of(dt_final_w,'MONTH',0)
		and	i.ie_tipo_item	= '6'
		and	((ie_gerar_ind_classif_w <> 'N')
		or	coalesce(i.cd_conta_contabil_ppcng,'X') <> 'X')
		and	t.ie_situacao <> '3'
		and	coalesce(cd_estabelecimento_p, t.cd_estabelecimento) = t.cd_estabelecimento
		and	obter_empresa_estab(t.cd_estabelecimento) = cd_empresa_p
		and	m.vl_mensalidade <> 0
		and	not exists (select	1
					from	titulo_receber_info_aux a
					where	t.nr_titulo = a.nr_titulo)
		and	((coalesce(ie_tipo_segurado_w,'X') = coalesce(s.ie_tipo_segurado,'X'))
		or (coalesce(ie_tipo_segurado_w,'X') = 'X'))
		group by c.nr_contrato,
			c.dt_contrato,
			c.dt_rescisao_contrato,
			p.ie_tipo_contratacao,
			p.ie_segmentacao,
			substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255),
			(coalesce(substr(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),1,255),
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'CGC'),1,255))),
			'TR',
			m.nr_sequencia,
			t.nr_titulo,
			t.dt_emissao,
			substr(pls_obter_parcela_contrato(c.nr_contrato,a.dt_mesano_referencia),1,10),
			t.dt_vencimento,
			a.dt_inicio_cobertura,
			a.dt_fim_cobertura,
			f.cd_conta_deb,
			s.nr_seq_pagador,
			t.vl_titulo,
			f.cd_conta_cred,
			i.nr_sequencia,
			l.ie_cobrar_retroativo,
			s.ie_tipo_segurado,
			s.nr_sequencia,
			s.dt_contratacao,
			m.dt_cancelamento) alias338
	order by nr_titulo;

vet_titulo			c_titulo%rowtype;

c_valor CURSOR FOR
	-- Valor ato cooperado
	SELECT	'AC' ie_ato_cooperado
	
	where	((vet_titulo.cd_conta_ato_cooperado IS NOT NULL AND vet_titulo.cd_conta_ato_cooperado::text <> '')
	or (vet_titulo.cd_conta_ato_auxiliar IS NOT NULL AND vet_titulo.cd_conta_ato_auxiliar::text <> '')
	or (vet_titulo.cd_conta_ato_nao_coop IS NOT NULL AND vet_titulo.cd_conta_ato_nao_coop::text <> ''))
	
union all

	-- Valor ato auxiliar
	SELECT	'AA' ie_ato_cooperado
	
	where	((vet_titulo.cd_conta_ato_cooperado IS NOT NULL AND vet_titulo.cd_conta_ato_cooperado::text <> '')
	or (vet_titulo.cd_conta_ato_auxiliar IS NOT NULL AND vet_titulo.cd_conta_ato_auxiliar::text <> '')
	or (vet_titulo.cd_conta_ato_nao_coop IS NOT NULL AND vet_titulo.cd_conta_ato_nao_coop::text <> ''))
	
union all

	-- Valor ato nao cooperado
	select	'AN' ie_ato_cooperado
	
	where	((vet_titulo.cd_conta_ato_cooperado IS NOT NULL AND vet_titulo.cd_conta_ato_cooperado::text <> '')
	or (vet_titulo.cd_conta_ato_auxiliar IS NOT NULL AND vet_titulo.cd_conta_ato_auxiliar::text <> '')
	or (vet_titulo.cd_conta_ato_nao_coop IS NOT NULL AND vet_titulo.cd_conta_ato_nao_coop::text <> ''))
	
union all

	-- Sem abertura por ato cooperado
	select	'N' ie_ato_cooperado
	
	where	((coalesce(vet_titulo.cd_conta_ato_cooperado::text, '') = '')
	and (coalesce(vet_titulo.cd_conta_ato_auxiliar::text, '') = '')
	and (coalesce(vet_titulo.cd_conta_ato_nao_coop::text, '') = ''));
	
vet_valor			c_valor%rowtype;

BEGIN

CALL wheb_usuario_pck.set_ie_executar_trigger('N');

select	coalesce(max(a.ie_gerar_ind_classif),'N'),
	max(ie_tipo_segurado)
into STRICT	ie_gerar_ind_classif_w,
	ie_tipo_segurado_w
from	ctb_livro_auxiliar	a
where	a.nr_sequencia	= nr_seq_regra_p;

select	substr(obter_desc_expressao(922923),1,255)
into STRICT	ds_observacao_w
;

dt_final_w := fim_mes(dt_final_p);
	
if (ie_gerar_arquivo_p = 'N') then

	delete	
	from	w_ctb_aux_contra_emit
	where	nr_seq_reg_auxiliar = nr_seq_regra_p;

	commit;

	open c_titulo;
	loop
	fetch c_titulo into
		vet_titulo;
	EXIT WHEN NOT FOUND; /* apply on c_titulo */
		begin
		nr_contador_w 		:= nr_contador_w + 1;
		vl_rec_antecipado_w	:= 0;
		vl_rec_cobertura_w	:= 0;
	
		ds_observacao_item_w	:= null;
		
		if (vet_titulo.ie_tipo_segurado in ('C','I','T')) then
			ds_observacao_item_w	:= ds_observacao_w;
		end if;
			
		open c_valor;
		loop
		fetch c_valor into
			vet_valor;
		EXIT WHEN NOT FOUND; /* apply on c_valor */
			begin
			
			if (vet_valor.ie_ato_cooperado = 'AC') then
				vet_titulo.vl_parcela		:= vet_titulo.vl_ato_cooperado;
				vet_titulo.cd_conta_rec		:= vet_titulo.cd_conta_ato_cooperado;
				
			elsif (vet_valor.ie_ato_cooperado = 'AA') then
				vet_titulo.vl_parcela		:= vet_titulo.vl_ato_auxiliar;
				vet_titulo.cd_conta_rec		:= vet_titulo.cd_conta_ato_auxiliar;
				
			elsif (vet_valor.ie_ato_cooperado = 'AN') then
				vet_titulo.vl_parcela		:= vet_titulo.vl_ato_nao_cooperado;
				vet_titulo.cd_conta_rec		:= vet_titulo.cd_conta_ato_nao_coop;
				
			end if;

			insert into w_ctb_aux_contra_emit(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_contrato,
				dt_contrato,
				dt_rescisao,
				ie_tipo_contratacao,
				ds_tipo_contratacao,
				ie_segmentacao,
				ds_segmentacao,
				nm_usuario_principal,
				cd_cpf_cnpj,
				ie_tipo_documento,
				ds_tipo_documento,
				nr_documento,
				nr_titulo,
				dt_emissao,
				nr_parcela,
				dt_vencimento,
				vl_parcela,
				vl_apropriado,
				vl_antecipado,
				vl_fat_antec,
				vl_rec_cobertura,
				dt_rec_antec,
				dt_inicio_cobertura,
				dt_fim_cobertura,
				nr_seq_pagador,
				dt_referencia,
				ie_tipo_livro,
				cd_conta_contabil,
				cd_conta_cred_encargos,
				nr_seq_reg_auxiliar,
				nr_linha,
				vl_contrato,
				ie_tipo_segurado,
				nr_seq_segurado,
				dt_contratacao,
				dt_cancelamento,
				dt_baixa,
				ds_observacao)
			values ( nextval('w_ctb_aux_contra_emit_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				vet_titulo.nr_seq_contrato,
				vet_titulo.dt_contrato,
				null,
				vet_titulo.ie_tipo_contratacao,
				obter_valor_dominio(1666,vet_titulo.ie_tipo_contratacao),
				vet_titulo.ie_segmentacao,
				obter_valor_dominio(1665,vet_titulo.ie_segmentacao),
				vet_titulo.nm_usuario_principal,
				vet_titulo.cd_cpf_cnpj,
				vet_titulo.ie_tipo_documento,
				obter_valor_dominio(8372,vet_titulo.ie_tipo_documento),
				vet_titulo.nr_documento,
				vet_titulo.nr_titulo,
				vet_titulo.dt_emissao,
				vet_titulo.nr_parcela,
				vet_titulo.dt_vencimento,
				vet_titulo.vl_parcela,
				vet_titulo.vl_apropriado,
				vet_titulo.vl_antecipado,
				vet_titulo.vl_rec_antecipado,
				vet_titulo.vl_rec_cobertura,
				vet_titulo.dt_rec_antecipado,
				vet_titulo.dt_inicio_cobertura,
				vet_titulo.dt_fim_cobertura,
				vet_titulo.nr_seq_pagador,
				dt_final_w,
				7,
				vet_titulo.cd_conta_contabil,
				vet_titulo.cd_conta_rec,
				nr_seq_regra_p,
				nr_contador_w,
				vet_titulo.vl_titulo,
				vet_titulo.ie_tipo_segurado,
				vet_titulo.nr_seq_segurado,
				vet_titulo.dt_contratacao,
				vet_titulo.dt_cancelamento,
				vet_titulo.dt_recebimento,
				ds_observacao_item_w);

			if (mod(nr_contador_w,1000) = 0) then
				commit;
			end if;
			
			end;
		end loop;
		close c_valor;
		
		end;
	end loop;
	close c_titulo;

	update	ctb_livro_auxiliar
	set	qt_registros	= nr_contador_w
	where	nr_sequencia	= nr_seq_regra_p;

	commit;
	
end if;

if (ie_gerar_arquivo_p = 'S') then
	begin
	nm_arquivo_w	:= 'RegAuxControleGerencialPPCNG' || to_char(clock_timestamp(),'ddmmyyyyhh24miss') || nm_usuario_p || '.csv';
	ds_nome_livro_w	:= 'Registro Auxiliar de Controle Gerencial PPCNG';
	ds_periodo_w	:= wheb_mensagem_pck.get_texto(1108452,'DT_FINAL=' || dt_final_w || ';' || 'DT_LIBERACAO=' || dt_liberacao_p);

	SELECT * FROM obter_evento_utl_file(1, null, ds_local_w, ds_erro_w) INTO STRICT ds_local_w, ds_erro_w;

	arq_texto_w := utl_file.fopen(ds_local_w,nm_arquivo_w,'W', 32000);

	utl_file.put_line(arq_texto_w, ds_nome_livro_w);
	utl_file.put_line(arq_texto_w, ds_periodo_w);
	utl_file.put_line(arq_texto_w, substr(obter_desc_expressao(1028996), 1, 4000));
	utl_file.fflush(arq_texto_w);
	for vetl in c_linha loop
		begin
		utl_file.put_line(arq_texto_w,vetl.ds_linha);
		utl_file.fflush(arq_texto_w);
		end;
	end loop;
	end;
end if;

commit;

CALL wheb_usuario_pck.set_ie_executar_trigger('S');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_livro_aux_ppcng ( nm_usuario_p text, cd_empresa_p text, cd_estabelecimento_p text, dt_inicial_p timestamp, dt_final_p timestamp, dt_liberacao_p timestamp, ie_gerar_arquivo_p text, nr_seq_regra_p bigint) FROM PUBLIC;

