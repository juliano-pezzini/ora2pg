-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE confirmar_conv_agenda_tasy (nr_seq_agenda_p bigint, ds_lista_convidados_p text, nm_usuario_p text) AS $body$
DECLARE


ds_lista_convidados_w	varchar(1000);
tam_lista_w		bigint;
ie_pos_virgula_w		smallint;
nm_usuario_w		varchar(17);/* deve ser 17 devido ao chr(39) */
ds_comando_update_w	varchar(4000);


BEGIN
if (ds_lista_convidados_p IS NOT NULL AND ds_lista_convidados_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	ds_lista_convidados_w := ds_lista_convidados_p;

	/* obter usuários convidados */

	while(ds_lista_convidados_w IS NOT NULL AND ds_lista_convidados_w::text <> '') loop
		begin
		tam_lista_w	:= length(ds_lista_convidados_w);
		ie_pos_virgula_w	:= position(',' in ds_lista_convidados_w);

		if (ie_pos_virgula_w <> 0) then
			nm_usuario_w		:= chr(39) || substr(ds_lista_convidados_w,1,(ie_pos_virgula_w - 1)) || chr(39);
			ds_lista_convidados_w	:= substr(ds_lista_convidados_w,(ie_pos_virgula_w + 1),tam_lista_w);
		else
			ds_lista_convidados_w	:= null;
			nm_usuario_w		:= null;
		end if;

		/* confirmar presença */

		if (coalesce(nm_usuario_w,'0') <> '0') then
			ds_comando_update_w	:= ' update	agenda_tasy_convite	' ||
						   ' set		ie_confirmado	=	' || chr(39) || 'S' || chr(39) ||
						   ' ,		dt_confirmacao	= sysdate	' ||
						   ' ,		nm_usuario	= 	' || chr(39) || nm_usuario_p || chr(39) ||
						   ' where	nr_seq_agenda		= 	' || nr_seq_agenda_p ||
						   ' and	nm_usuario_convidado	=	' || nm_usuario_w;
			CALL exec_sql_dinamico('AgendaTasy', ds_comando_update_w);
		end if;
		end;
	end loop;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE confirmar_conv_agenda_tasy (nr_seq_agenda_p bigint, ds_lista_convidados_p text, nm_usuario_p text) FROM PUBLIC;

