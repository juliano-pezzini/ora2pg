-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE excluir_itens_inventario ( nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_material_w			bigint;
cd_material_w			integer;
cd_local_estoque_w		integer;
qt_existe_w			integer;
cd_fornecedor_w			varchar(14);
ie_consignado_w			varchar(1);
ie_bloqueio_w			varchar(1);

c01 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.cd_material,
		b.cd_local_estoque,
		coalesce(a.cd_fornecedor,b.cd_fornecedor),
		b.ie_consignado
	from	inventario b,
		inventario_material a
	where	b.nr_sequencia = a.nr_seq_inventario
	and	coalesce(a.qt_inventario::text, '') = ''
	and	nr_seq_inventario = nr_sequencia_p;

BEGIN

OPEN C01;
LOOP
FETCH C01 into
	nr_seq_material_w,
	cd_material_w,
	cd_local_estoque_w,
	cd_fornecedor_w,
	ie_consignado_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	BEGIN
	CALL alterar_bloqueio_inv_material(nm_usuario_p,cd_estabelecimento_p,cd_material_w,cd_local_estoque_w,cd_fornecedor_w,ie_consignado_w,'N');

	delete	FROM inventario_material
	where	nr_sequencia = nr_seq_material_w;

	commit;
	END;
END LOOP;
close c01;

/*Verifica se ainda existem itens no inventário, se não existir - desbloqueia o inventário*/

select	count(*)
into STRICT	qt_existe_w
from	inventario_material
where	nr_seq_inventario	= nr_sequencia_p;

if (qt_existe_w = 0) then
	update	inventario
	set	dt_bloqueio  = NULL,
		nm_usuario_bloqueio  = NULL
	where	nr_sequencia	= nr_sequencia_p;
end if;

commit;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE excluir_itens_inventario ( nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

