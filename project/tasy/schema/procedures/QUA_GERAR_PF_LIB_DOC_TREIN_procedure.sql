-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qua_gerar_pf_lib_doc_trein ( nr_seq_treinamento_p bigint, cd_liberacao_p text, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE

 
cd_estabelecimento_w			smallint;					
ie_somente_funcionario_w			varchar(01);
cd_pessoa_fisica_w			varchar(10);
cd_setor_atendimento_w			bigint;

C01 CURSOR FOR 
	SELECT	distinct 
		a.cd_pessoa_fisica, 
		a.cd_setor_atendimento 
	from	usuario_perfil b, 
		usuario a		 
	where	b.nm_usuario	= a.nm_usuario 
	and	a.ie_situacao	= 'A' 
	and	b.cd_perfil	= cd_liberacao_p 
	and	(a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '') 
	and (ie_somente_funcionario_w = 'N' or coalesce(substr(obter_dados_pf(a.cd_pessoa_fisica,'F'),1,1),'N') = 'S') 
	and not exists (	SELECT	1 
				from	qua_doc_trein_pessoa x 
				where	x.cd_pessoa_fisica	= a.cd_pessoa_fisica 
				and	x.nr_seq_treinamento	= nr_seq_treinamento_p);
				
C02 CURSOR FOR 
	SELECT	distinct 
		a.cd_pessoa_fisica, 
		a.cd_setor_atendimento 
	from	pessoa_fisica b, 
		usuario a	 
	where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica	 
	and	a.ie_situacao		= 'A' 
	and	b.cd_cargo 		= cd_liberacao_p 
	and	(a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '') 
	and (ie_somente_funcionario_w = 'N' or coalesce(b.ie_funcionario,'N') = 'S') 
	and not exists (	SELECT	1 
				from	qua_doc_trein_pessoa x 
				where	x.cd_pessoa_fisica	= a.cd_pessoa_fisica 
				and	x.nr_seq_treinamento	= nr_seq_treinamento_p);
				
C03 CURSOR FOR 
	SELECT	distinct 
		a.cd_pessoa_fisica, 
		a.cd_setor_atendimento 
	from	usuario a 
	where	a.ie_situacao		= 'A' 
	and	a.cd_setor_atendimento	= cd_liberacao_p 
	and	(a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '') 
	and (ie_somente_funcionario_w = 'N' or coalesce(substr(obter_dados_pf(a.cd_pessoa_fisica,'F'),1,1),'S') = 'S') 
	and not exists (	SELECT	1 
				from	qua_doc_trein_pessoa x 
				where	x.cd_pessoa_fisica	= a.cd_pessoa_fisica 
				and	x.nr_seq_treinamento	= nr_seq_treinamento_p);
				
C04 CURSOR FOR 
	SELECT	distinct 
		a.cd_pessoa_fisica, 
		a.cd_setor_atendimento 
	from	qua_cargo_agrup d, 
		qua_grupo_cargo c, 
		pessoa_fisica b, 
		usuario a	 
	where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica 
	and	c.nr_sequencia		= d.nr_seq_agrup 
	and	b.cd_cargo		= d.cd_cargo 
	and	a.ie_situacao		= 'A' 
	and	c.nr_sequencia 		= cd_liberacao_p 
	and	(a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '') 
	and (ie_somente_funcionario_w = 'N' or coalesce(b.ie_funcionario,'N') = 'S') 
	and not exists (	SELECT	1 
				from	qua_doc_trein_pessoa x 
				where	x.cd_pessoa_fisica	= a.cd_pessoa_fisica 
				and	x.nr_seq_treinamento	= nr_seq_treinamento_p);
				
C05 CURSOR FOR 
	SELECT	distinct 
		a.cd_pessoa_fisica, 
		a.cd_setor_atendimento 
	from	usuario_grupo c, 
		grupo_usuario b, 
		usuario a 
	where	a.nm_usuario		= c.nm_usuario 
	and	b.nr_sequencia		= c.nr_seq_grupo 
	and	a.ie_situacao		= 'A' 
	and	c.ie_situacao		= 'A' 
	and	b.nr_sequencia		= cd_liberacao_p 
	and	(a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '') 
	and (ie_somente_funcionario_w = 'N' or coalesce(substr(obter_dados_pf(a.cd_pessoa_fisica,'F'),1,1),'S') = 'S')	 
	and not exists (	SELECT	1 
				from	qua_doc_trein_pessoa x 
				where	x.cd_pessoa_fisica	= a.cd_pessoa_fisica 
				and	x.nr_seq_treinamento	= nr_seq_treinamento_p);
				
C06 CURSOR FOR 
	SELECT	distinct 
		a.cd_pessoa_fisica, 
		a.cd_setor_atendimento 
	from	grupo_perfil_item d, 
		grupo_perfil c, 
		usuario_perfil b, 
		usuario a		 
	where	b.nm_usuario	= a.nm_usuario 
	and	c.nr_sequencia 	= d.nr_seq_grupo_perfil 
	and	b.cd_perfil	= d.cd_perfil 
	and	a.ie_situacao	= 'A' 
	and	c.nr_sequencia	= cd_liberacao_p 
	and	(a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '') 
	and (ie_somente_funcionario_w = 'N' or coalesce(substr(obter_dados_pf(a.cd_pessoa_fisica,'F'),1,1),'N') = 'S')	 
	and not exists (	SELECT	1 
				from	qua_doc_trein_pessoa x 
				where	x.cd_pessoa_fisica	= a.cd_pessoa_fisica 
				and	x.nr_seq_treinamento	= nr_seq_treinamento_p);


BEGIN 
 
if (coalesce(nr_seq_treinamento_p,0) > 0) and (coalesce(cd_liberacao_p,'X') <> 'X') and (coalesce(ie_opcao_p,'X') <> 'X') then 
	begin	 
	select	cd_estabelecimento 
	into STRICT	cd_estabelecimento_w 
	from	qua_documento 
	where	nr_sequencia = (SELECT	nr_seq_documento 
				from	qua_doc_treinamento 
				where	nr_sequencia = nr_seq_treinamento_p);
 
	select	substr(coalesce(obter_valor_param_usuario(4000, 75, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w),'N'),1,1) 
	into STRICT	ie_somente_funcionario_w 
	;
	 
	if (ie_opcao_p = 'P') then 
		begin 
		open C01;
		loop 
		fetch C01 into	 
			cd_pessoa_fisica_w, 
			cd_setor_atendimento_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin 
			insert into qua_doc_trein_pessoa( 
						nr_sequencia, 
						dt_atualizacao, 
						nm_usuario, 
						nr_seq_treinamento, 
						cd_pessoa_fisica, 
						ie_faltou, 
						cd_setor_atendimento) 
					values (	nextval('qua_doc_trein_pessoa_seq'), 
						clock_timestamp(), 
						nm_usuario_p, 
						nr_seq_treinamento_p, 
						cd_pessoa_fisica_w, 
						'N', 
						cd_setor_atendimento_w);
			end;
		end loop;
		close C01;
		end;
	elsif (ie_opcao_p = 'C') then 
		begin 
		open C02;
		loop 
		fetch C02 into	 
			cd_pessoa_fisica_w, 
			cd_setor_atendimento_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin 
			insert into qua_doc_trein_pessoa( 
						nr_sequencia, 
						dt_atualizacao, 
						nm_usuario, 
						nr_seq_treinamento, 
						cd_pessoa_fisica, 
						ie_faltou, 
						cd_setor_atendimento) 
					values (	nextval('qua_doc_trein_pessoa_seq'), 
						clock_timestamp(), 
						nm_usuario_p, 
						nr_seq_treinamento_p, 
						cd_pessoa_fisica_w, 
						'N', 
						cd_setor_atendimento_w);
			end;
		end loop;
		close C02;
		end;
	elsif (ie_opcao_p = 'U') then 
		begin 
		select	max(a.cd_pessoa_fisica), 
			max(cd_setor_atendimento) 
		into STRICT	cd_pessoa_fisica_w, 
			cd_setor_atendimento_w 
		from	usuario a 
		where	a.nm_usuario = cd_liberacao_p 
		and not exists (	SELECT	1 
					from	qua_doc_trein_pessoa x 
					where	x.cd_pessoa_fisica	= a.cd_pessoa_fisica 
					and	x.nr_seq_treinamento	= nr_seq_treinamento_p);
		 
		if (coalesce(cd_pessoa_fisica_w,'0') <> '0') then 
			insert into qua_doc_trein_pessoa( 
						nr_sequencia, 
						dt_atualizacao, 
						nm_usuario, 
						nr_seq_treinamento, 
						cd_pessoa_fisica, 
						ie_faltou, 
						cd_setor_atendimento) 
					values (	nextval('qua_doc_trein_pessoa_seq'), 
						clock_timestamp(), 
						nm_usuario_p, 
						nr_seq_treinamento_p, 
						cd_pessoa_fisica_w, 
						'N', 
						cd_setor_atendimento_w);
		end if;		
		end;
	elsif (ie_opcao_p = 'S') then 
		begin 
		open C03;
		loop 
		fetch C03 into	 
			cd_pessoa_fisica_w, 
			cd_setor_atendimento_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin 
			insert into qua_doc_trein_pessoa( 
						nr_sequencia, 
						dt_atualizacao, 
						nm_usuario, 
						nr_seq_treinamento, 
						cd_pessoa_fisica, 
						ie_faltou, 
						cd_setor_atendimento) 
					values (	nextval('qua_doc_trein_pessoa_seq'), 
						clock_timestamp(), 
						nm_usuario_p, 
						nr_seq_treinamento_p, 
						cd_pessoa_fisica_w, 
						'N', 
						cd_setor_atendimento_w);
			end;
		end loop;
		close C03;
		end;
	elsif (ie_opcao_p = 'A') then 
		begin 
		open C04;
		loop 
		fetch C04 into	 
			cd_pessoa_fisica_w, 
			cd_setor_atendimento_w;
		EXIT WHEN NOT FOUND; /* apply on C04 */
			begin 
			insert into qua_doc_trein_pessoa( 
						nr_sequencia, 
						dt_atualizacao, 
						nm_usuario, 
						nr_seq_treinamento, 
						cd_pessoa_fisica, 
						ie_faltou, 
						cd_setor_atendimento) 
					values (	nextval('qua_doc_trein_pessoa_seq'), 
						clock_timestamp(), 
						nm_usuario_p, 
						nr_seq_treinamento_p, 
						cd_pessoa_fisica_w, 
						'N', 
						cd_setor_atendimento_w);
			end;
		end loop;
		close C04;
		end;
	elsif (ie_opcao_p = 'GU') then 
		begin 
		open C05;
		loop 
		fetch C05 into	 
			cd_pessoa_fisica_w, 
			cd_setor_atendimento_w;
		EXIT WHEN NOT FOUND; /* apply on C05 */
			begin 
			insert into qua_doc_trein_pessoa( 
						nr_sequencia, 
						dt_atualizacao, 
						nm_usuario, 
						nr_seq_treinamento, 
						cd_pessoa_fisica, 
						ie_faltou, 
						cd_setor_atendimento) 
					values (	nextval('qua_doc_trein_pessoa_seq'), 
						clock_timestamp(), 
						nm_usuario_p, 
						nr_seq_treinamento_p, 
						cd_pessoa_fisica_w, 
						'N', 
						cd_setor_atendimento_w);
			end;
		end loop;
		close C05;
		end;
	elsif (ie_opcao_p = 'GP') then 
		begin 
		open C06;
		loop 
		fetch C06 into	 
			cd_pessoa_fisica_w, 
			cd_setor_atendimento_w;
		EXIT WHEN NOT FOUND; /* apply on C06 */
			begin 
			insert into qua_doc_trein_pessoa( 
						nr_sequencia, 
						dt_atualizacao, 
						nm_usuario, 
						nr_seq_treinamento, 
						cd_pessoa_fisica, 
						ie_faltou, 
						cd_setor_atendimento) 
					values (	nextval('qua_doc_trein_pessoa_seq'), 
						clock_timestamp(), 
						nm_usuario_p, 
						nr_seq_treinamento_p, 
						cd_pessoa_fisica_w, 
						'N', 
						cd_setor_atendimento_w);
			end;
		end loop;
		close C06;
		end;
	end if;
	 
	commit;
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qua_gerar_pf_lib_doc_trein ( nr_seq_treinamento_p bigint, cd_liberacao_p text, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

