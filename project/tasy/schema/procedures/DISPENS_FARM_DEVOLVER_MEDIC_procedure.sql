-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dispens_farm_devolver_medic (nr_atendimento_p bigint, cd_setor_atendimento_p bigint, cd_local_estoque_p bigint, cd_material_p bigint, qt_material_p bigint, cd_barras_p bigint, nm_usuario_p text) AS $body$
DECLARE


ie_baixa_estoq_pac_w			varchar(1);
cd_local_estoque_w				local_estoque.cd_local_estoque%type;
cd_unidade_medida_estoque_w		material.cd_unidade_medida_estoque%type;
cd_estabelecimento_w			estabelecimento.cd_estabelecimento%type;
cd_material_w					integer;
qt_material_ww					double precision;
nr_seq_lote_w					bigint;
nr_seq_lote_agrup_w				bigint;
cd_kit_mat_w					bigint;
ds_validade_w					varchar(255);
ds_material_w					varchar(255);
cd_unid_med_w					varchar(30);
nr_etiqueta_lp_w				varchar(255);
ds_erro_w						varchar(255);


BEGIN
cd_material_w := cd_material_p;
if (cd_barras_p IS NOT NULL AND cd_barras_p::text <> '') then
	SELECT * FROM converte_codigo_barras(	cd_barras_p, cd_estabelecimento_w, null, 'N', cd_material_w, qt_material_ww, nr_seq_lote_w, nr_seq_lote_agrup_w, cd_kit_mat_w, ds_validade_w, ds_material_w, cd_unid_med_w, nr_etiqueta_lp_w, ds_erro_w) INTO STRICT cd_material_w, qt_material_ww, nr_seq_lote_w, nr_seq_lote_agrup_w, cd_kit_mat_w, ds_validade_w, ds_material_w, cd_unid_med_w, nr_etiqueta_lp_w, ds_erro_w;
end if;

if (coalesce(cd_local_estoque_p, 0) = 0) then
	select 	cd_local_estoque
	into STRICT 	cd_local_estoque_w
	from 	setor_atendimento
	where 	cd_setor_atendimento = cd_setor_atendimento_p;
else
	cd_local_estoque_w := cd_local_estoque_p;
end if;

select 	obter_se_baixa_estoque_pac(cd_setor_atendimento_p, cd_material_w, null, 0)
into STRICT	ie_baixa_estoq_pac_w
;

select 	cd_unidade_medida_estoque
into STRICT 	cd_unidade_medida_estoque_w
from 	material
where 	cd_material = cd_material_w;

if (ie_baixa_estoq_pac_w = 'S') and (cd_local_estoque_w IS NOT NULL AND cd_local_estoque_w::text <> '') then
	begin
	CALL gerar_prescricao_estoque(
				null,
				nr_atendimento_p,
				null,
				cd_material_w,
				clock_timestamp(),
				'2',
				cd_local_estoque_w,
				qt_material_p,
				cd_setor_atendimento_p,
				cd_unidade_medida_estoque_w,
				nm_usuario_p,
				'E',
				-null,
				null,
				null,
				null,
				null,
				'',
				null, --:new.nr_seq_lote_fornec, --PRECISO PEGAR O LOTE_FORNECEDOR
				null,
				null,
				null,
				'',
				'',
				'');
	end;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dispens_farm_devolver_medic (nr_atendimento_p bigint, cd_setor_atendimento_p bigint, cd_local_estoque_p bigint, cd_material_p bigint, qt_material_p bigint, cd_barras_p bigint, nm_usuario_p text) FROM PUBLIC;

