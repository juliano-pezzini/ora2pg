-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_gerar_opm_exec ( nr_seq_conta_guia_p bigint, nr_seq_guia_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_opm_w		varchar(20);
vl_opm_w		double precision;
vl_total_opm_w		double precision;
qt_proc_guia_w		bigint;
nr_seq_guia_w		bigint;
ds_opm_w		varchar(255);
ds_fabricante_w		varchar(255);
qt_opm_w		bigint;
nr_seq_apresent_opm_w	bigint;
nr_seq_apres_opm_compl_w 	bigint;
cd_edicao_amb_w		varchar(20);
qt_autorizada_w		double precision;
nr_interno_conta_w		bigint;
cd_convenio_w		integer;
cd_estabelecimento_w	smallint;
cd_barras_w		varchar(255);
cd_opm_gravado_w	varchar(20);
nr_seq_opme_w		bigint;
ie_agrupar_opme_w	varchar(1);
dt_mesano_referencia_w	timestamp;
ds_versao_w		varchar(20);

c01 CURSOR FOR
SELECT	cd_opm,
	cd_tabela,
	ds_opm,
	qt_opm,
	vl_unitario_opm,
	sum(vl_opm),
	cd_barras,
	CASE WHEN ie_agrupar_opme_w='N' THEN nr_sequencia  ELSE null END
from	tiss_conta_opm_exec 
where	nr_seq_guia		= nr_seq_conta_guia_p
and	coalesce(nr_seq_reap_conta::text, '') = ''
group by cd_opm,
	cd_tabela,
	ds_opm,
	qt_opm,
	vl_unitario_opm,
	cd_barras,
	CASE WHEN ie_agrupar_opme_w='N' THEN nr_sequencia  ELSE null END 

union all

SELECT	a.cd_opm,
	a.cd_tabela,
	a.ds_opm,
	a.qt_opm,
	a.vl_unitario_opm,
	sum(a.vl_opm),
	a.cd_barras,
	CASE WHEN ie_agrupar_opme_w='N' THEN a.nr_sequencia  ELSE null END 
from	tiss_conta_opm_exec a,
	tiss_conta_guia b
where	b.nr_seq_reap_conta	= a.nr_seq_reap_conta
and	b.nr_sequencia		= nr_seq_conta_guia_p
and	(a.nr_seq_reap_conta IS NOT NULL AND a.nr_seq_reap_conta::text <> '')
group by cd_opm,
	cd_tabela,
	ds_opm,
	qt_opm,
	vl_unitario_opm,
	cd_barras,
	CASE WHEN ie_agrupar_opme_w='N' THEN a.nr_sequencia  ELSE null END;


BEGIN

select	max(nr_interno_conta)
into STRICT	nr_interno_conta_w
from	tiss_conta_guia
where	nr_sequencia	= nr_seq_conta_guia_p;

select	max(cd_convenio_parametro),
	max(cd_estabelecimento),
	max(dt_mesano_referencia)
into STRICT	cd_convenio_w,
	cd_estabelecimento_w,
	dt_mesano_referencia_w
from	conta_paciente
where	nr_interno_conta	= nr_interno_conta_w;

select	coalesce(max(ie_agrupar_opme),'S')
into STRICT	ie_agrupar_opme_w
from	tiss_parametros_convenio
where	cd_convenio		= cd_convenio_w
and	cd_estabelecimento	= cd_estabelecimento_w;

select	max(tiss_obter_versao(cd_convenio_w, cd_estabelecimento_w,dt_mesano_referencia_w))
into STRICT	ds_versao_w
;

qt_opm_w 		:= 0;
nr_seq_apresent_opm_w	:= 0;
nr_seq_apres_opm_compl_w := 0;

qt_proc_guia_w		:= 0;

--Somente gera OPME se não for da v3 pois na v3 as OPME são geradas na TISS_CONTA_DESP
if (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'N')then

	open c01;
	loop
	fetch c01 into
		cd_opm_w,
		cd_edicao_amb_w,
		ds_opm_w,
		qt_autorizada_w,
		vl_opm_w,
		vl_total_opm_w,
		cd_barras_w,
		nr_seq_opme_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		select	max(cd_opm)
		into STRICT	cd_opm_gravado_w
		from	w_tiss_opm_exec
		where	nm_usuario		= nm_usuario_p
		and	coalesce(vl_unitario,0)	= coalesce(vl_opm_w,0)
		and	nr_interno_conta 	= nr_interno_conta_w
		and	upper(ds_opm)		= upper(ds_opm_w)  /*OS76974.18/12/2007. Tive que incluir esta comparação pois pode haver */
		and	cd_opm			= cd_opm_w
		and	coalesce(ie_agrupar_opme_w,'S') = 'S';	

		if (coalesce(cd_opm_gravado_w,'0') = '0') then		

			qt_opm_w 		:= qt_opm_w + 1;
			nr_seq_apresent_opm_w	:= nr_seq_apresent_opm_w + 1;	
				
			if (qt_opm_w <= 9) then
					insert into w_tiss_opm_exec(nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						nr_seq_guia,
						cd_opm,
						cd_edicao,
						ds_opm,
						qt_solicitada,
						qt_autorizada,
						vl_unitario,
						vl_opm,
						nr_seq_apresentacao,
						cd_barras,
						nr_interno_conta)
					values (nextval('w_tiss_opm_exec_seq'),
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_guia_p,
						cd_opm_w,
						cd_edicao_amb_w,
						ds_opm_w,
						qt_autorizada_w,
						qt_autorizada_w,
						vl_opm_w,
						vl_total_opm_w,
						nr_seq_apresent_opm_w,
						cd_barras_w,
						nr_interno_conta_w);
			else
				qt_proc_guia_w		:= qt_proc_guia_w + 1;
				nr_seq_apres_opm_compl_w := nr_seq_apres_opm_compl_w + 1;

				if (qt_proc_guia_w = 1) then
					nr_seq_guia_w := tiss_gerar_cabecalho_spsadt(nr_seq_conta_guia_p, nr_seq_guia_w, nm_usuario_p);
					CALL TISS_COMPLETAR_GUIA(nr_seq_guia_p, nm_usuario_p);
				end if;

				insert into w_tiss_opm_exec(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_guia,
					cd_opm,
					cd_edicao,
					ds_opm,
					qt_solicitada,
					qt_autorizada,
					vl_unitario,
					vl_opm,
					nr_seq_apresentacao,
					cd_barras,
					nr_interno_conta)
				values (nextval('w_tiss_opm_exec_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w,
					cd_opm_w,
					cd_edicao_amb_w,
					ds_opm_w,
					qt_autorizada_w,
					qt_autorizada_w,
					vl_opm_w,
					vl_total_opm_w,
					nr_seq_apres_opm_compl_w,
					cd_barras_w,
					nr_interno_conta_w);

			end if;
		end if;

	end loop;
	close c01;
end if;

CALL TISS_COMPLETAR_GUIA(nr_seq_guia_w, nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_gerar_opm_exec ( nr_seq_conta_guia_p bigint, nr_seq_guia_p bigint, nm_usuario_p text) FROM PUBLIC;

