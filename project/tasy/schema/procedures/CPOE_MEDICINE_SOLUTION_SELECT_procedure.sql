-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_medicine_solution_select (nr_atendimento_p cpoe_material.nr_atendimento%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, nm_usuario_p cpoe_material.nm_usuario%type, cd_perfil_p bigint, cd_estabelecimento_p bigint, nr_seq_item_gerado_p INOUT bigint, ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_controle_tempo_p cpoe_material.ie_controle_tempo%type DEFAULT NULL, cd_material_p cpoe_material.cd_material%type DEFAULT NULL, nr_seq_cpoe_order_unit_p cpoe_material.nr_seq_cpoe_order_unit%type DEFAULT NULL, nr_seq_cpoe_rp_p cpoe_material.nr_seq_cpoe_rp%type default null, ds_list_components_p text default null, cd_unidade_medida_p cpoe_material.cd_unidade_medida%type default null, qt_dose_p cpoe_material.qt_dose%type default null, ds_dose_diferenciada_p cpoe_material.ds_dose_diferenciada%type default null) AS $body$
DECLARE

cd_material_w               		cpoe_material.cd_material%type;
cd_unidade_medida_w         		cpoe_material.cd_unidade_medida%type;
nr_sequencia_w              		cpoe_material.nr_sequencia%type;
dt_inicio_w                 		cpoe_material.dt_inicio%type;

cd_material_ret_w					material.cd_material%type;
tipo_material_w						bigint;
cd_setor_execucao_w					cpoe_order_unit.cd_setor_execucao%type := null;
ie_use_item_types_w					varchar(1);

ie_via_aplicacao_rp_w             cpoe_rp.ie_via_aplicacao%type := null;
nr_seq_grupo_interval_rp_w        cpoe_rp.nr_seq_grupo_interval%type := null;
nr_seq_subgrupo_interval_rp_w     cpoe_rp.nr_seq_subgrupo_interval%type := null;
cd_intervalo_rp_w                 cpoe_rp.cd_intervalo%type := null;
dt_inicio_rp_w                    cpoe_rp.dt_inicio%type := null;
dt_fim_rp_w                       cpoe_rp.dt_fim%type := null;
ds_horarios_rp_w                  cpoe_rp.ds_horarios%type := null;
ie_segunda_rp_w                   cpoe_rp.ie_segunda%type := null;
ie_terca_rp_w                     cpoe_rp.ie_terca%type := null;
ie_quarta_rp_w                    cpoe_rp.ie_quarta%type := null;
ie_quinta_rp_w                    cpoe_rp.ie_quinta%type := null;
ie_sexta_rp_w                     cpoe_rp.ie_sexta%type := null;
ie_sabado_rp_w                    cpoe_rp.ie_sabado%type := null;
ie_domingo_rp_w                   cpoe_rp.ie_domingo%type := null;
ie_duracao_rp_w                   protocolo_medic_material.ie_duracao%type := null;

ie_urgencia_rp_w                  cpoe_rp.ie_urgencia%type := null;
ie_administracao_rp_w             cpoe_rp.ie_administracao%type := null;
qt_solucao_total_rp_w             cpoe_rp.qt_solucao_total%type := null;
qt_volume_rp_w                    cpoe_rp.qt_volume%type := null;
ie_tipo_analgesia_rp_w            cpoe_rp.ie_tipo_analgesia%type := null;
ie_pca_modo_prog_rp_w             cpoe_rp.ie_pca_modo_prog%type := null;
qt_dose_inicial_pca_rp_w          cpoe_rp.qt_dose_inicial_pca%type := null;
ie_um_dose_inicio_pca_rp_w        cpoe_rp.ie_um_dose_inicio_pca%type := null;
ie_um_fluxo_pca_rp_w              cpoe_rp.ie_um_fluxo_pca%type := null;
qt_vol_infusao_pca_rp_w           cpoe_rp.qt_vol_infusao_pca%type := null;
qt_bolus_pca_rp_w                 cpoe_rp.qt_bolus_pca%type := null;
ie_um_bolus_pca_rp_w              cpoe_rp.ie_um_bolus_pca%type := null;
qt_intervalo_bloqueio_rp_w        cpoe_rp.qt_intervalo_bloqueio%type := null;
qt_limite_quatro_hora_rp_w        cpoe_rp.qt_limite_quatro_hora%type := null;
ie_um_limite_pca_rp_w             cpoe_rp.ie_um_limite_pca%type := null;
qt_limite_uma_hora_rp_w           cpoe_rp.qt_limite_uma_hora%type := null;
ie_um_limite_hora_pca_rp_w        cpoe_rp.ie_um_limite_hora_pca%type := null;
si_rapid_infusion_rp_w            cpoe_rp.si_rapid_infusion%type := null;
qt_final_concentration_rp_w       cpoe_rp.qt_final_concentration%type := null;
ie_incrementar_rp_w               cpoe_rp.ie_incrementar%type := null;
ie_tipo_dosagem_inc_rp_w          cpoe_rp.ie_tipo_dosagem_inc%type := null;
ie_um_final_conc_pca_rp_w         cpoe_rp.ie_um_final_conc_pca%type := null;
qt_dosagem_inc_rp_w               cpoe_rp.qt_dosagem_inc%type := null;
ie_fator_correcao_rp_w            cpoe_rp.ie_fator_correcao%type := null;
qt_dose_terapeutica_rp_w          cpoe_rp.qt_dose_terapeutica%type := null;
ie_evento_unico_w					cpoe_rp.ie_evento_unico%type := null;
ie_acm_w							cpoe_material.ie_acm%type := 'N';
ie_se_necessario_w					cpoe_material.ie_se_necessario%type := 'N';
nr_ocorrencia_w						cpoe_rp.nr_ocorrencia%type;
qt_tempo_aplicacao_w				cpoe_rp.qt_tempo_aplicacao%type;
ie_tipo_solucao_w					cpoe_rp.ie_tipo_solucao%type;
ie_tipo_dosagem_w					cpoe_rp.ie_tipo_dosagem%type;

ie_drip_shot_w						cpoe_rp.ie_drip_shot%type;
ie_ref_calculo_w					cpoe_rp.ie_ref_calculo%type;
qt_hora_fase_w						cpoe_rp.qt_hora_fase%type;
ie_bomba_infusao_w					cpoe_rp.ie_bomba_infusao%type;
nr_etapas_w							cpoe_rp.nr_etapas%type;
qt_dosagem_w						cpoe_rp.qt_dosagem%type;
cd_unid_medic_terap_w				cpoe_rp.cd_unid_medic_terap%type;
  qt_dose_ref_w            cpoe_material.qt_dose%type;
  qt_dose_dia_w            cpoe_material.qt_dose_dia%type;



BEGIN

    cd_material_w := cd_material_p;

    if (coalesce(nr_seq_cpoe_order_unit_p, 0) > 0) then

        select	nextval('cpoe_material_seq')
        into STRICT	nr_sequencia_w
;

        select	max(cd_unidade_medida_consumo)
		into STRICT	cd_unidade_medida_w
		from	material
		where	cd_material = cd_material_w;

        tipo_material_w := obter_tipo_material(cd_material_w, 'C');

        if (tipo_material_w = '3') then
            cd_material_ret_w := obter_regra_subst_gen(NULL, nr_atendimento_p, cd_material_w, wheb_usuario_pck.get_cd_estabelecimento);
        else
            cd_material_ret_w := obter_regra_subst_com(NULL,cd_material_w,nr_atendimento_p);
        end if;

        if (coalesce(cd_material_ret_w,0) = 0) then
            cd_material_ret_w := cpoe_substituir_medic_apres(cd_estabelecimento_p, obter_convenio_atendimento(nr_atendimento_p), cd_material_w);
        end if;


        IF (coalesce(cd_material_ret_w, 0) > 0) THEN
            cd_material_w := cd_material_ret_w;
        end if;

        ie_use_item_types_w := obter_param_usuario(2314, 46, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_use_item_types_w);

        if (coalesce(ie_use_item_types_w, 'N') = 'S') then

			select  cd_setor_execucao
			into STRICT    cd_setor_execucao_w
			from    cpoe_order_unit
			where   nr_sequencia = nr_seq_cpoe_order_unit_p;

			select	ie_via_aplicacao,
					nr_seq_grupo_interval,
					nr_seq_subgrupo_interval,
					cd_intervalo,
					dt_inicio,
					dt_fim,
					ds_horarios,
					ie_segunda,
					ie_terca,
					ie_quarta,
					ie_quinta,
					ie_sexta,
					ie_sabado,
					ie_domingo,
					ie_urgencia,
					ie_administracao,
					qt_solucao_total,
					qt_volume,
					ie_tipo_analgesia,
					ie_pca_modo_prog,
					qt_dose_inicial_pca,
					ie_um_dose_inicio_pca,
					ie_um_fluxo_pca,
					qt_vol_infusao_pca,
					qt_bolus_pca,
					ie_um_bolus_pca,
					qt_intervalo_bloqueio,
					qt_limite_quatro_hora,
					ie_um_limite_pca,
					qt_limite_uma_hora,
					ie_um_limite_hora_pca,
					si_rapid_infusion,
					qt_final_concentration,
					ie_incrementar,
					ie_tipo_dosagem_inc,
					ie_um_final_conc_pca,
					qt_dosagem_inc,
					ie_fator_correcao,
					qt_dose_terapeutica,
					ie_evento_unico,
					nr_ocorrencia,
					qt_tempo_aplicacao,
					ie_tipo_solucao,
					ie_tipo_dosagem,
					ie_drip_shot,
					ie_ref_calculo,
					qt_hora_fase,
					ie_bomba_infusao,
					nr_etapas,
					qt_dosagem,
					cd_unid_medic_terap
			into STRICT	ie_via_aplicacao_rp_w,
					nr_seq_grupo_interval_rp_w,
					nr_seq_subgrupo_interval_rp_w,
					cd_intervalo_rp_w,
					dt_inicio_rp_w,
					dt_fim_rp_w,
					ds_horarios_rp_w,
					ie_segunda_rp_w,
					ie_terca_rp_w,
					ie_quarta_rp_w,
					ie_quinta_rp_w,
					ie_sexta_rp_w,
					ie_sabado_rp_w,
					ie_domingo_rp_w,
					ie_urgencia_rp_w,
					ie_administracao_rp_w,
					qt_solucao_total_rp_w,
					qt_volume_rp_w,
					ie_tipo_analgesia_rp_w,
					ie_pca_modo_prog_rp_w,
					qt_dose_inicial_pca_rp_w,
					ie_um_dose_inicio_pca_rp_w,
					ie_um_fluxo_pca_rp_w,
					qt_vol_infusao_pca_rp_w,
					qt_bolus_pca_rp_w,
					ie_um_bolus_pca_rp_w,
					qt_intervalo_bloqueio_rp_w,
					qt_limite_quatro_hora_rp_w,
					ie_um_limite_pca_rp_w,
					qt_limite_uma_hora_rp_w,
					ie_um_limite_hora_pca_rp_w,
					si_rapid_infusion_rp_w,
					qt_final_concentration_rp_w,
					ie_incrementar_rp_w,
					ie_tipo_dosagem_inc_rp_w,
					ie_um_final_conc_pca_rp_w,
					qt_dosagem_inc_rp_w,
					ie_fator_correcao_rp_w,
					qt_dose_terapeutica_rp_w,
					ie_evento_unico_w,
					nr_ocorrencia_w,
					qt_tempo_aplicacao_w,
					ie_tipo_solucao_w,
					ie_tipo_dosagem_w,
					ie_drip_shot_w,
					ie_ref_calculo_w,
					qt_hora_fase_w,
					ie_bomba_infusao_w,
					nr_etapas_w,
					qt_dosagem_w,
					cd_unid_medic_terap_w				
			from	cpoe_rp
			where	nr_sequencia = nr_seq_cpoe_rp_p;

			ie_duracao_rp_w := 'P';

        end if;

		if (ie_administracao_rp_w = 'C') then
			ie_acm_w := 'S';
		elsif (ie_administracao_rp_w = 'N') then
			ie_se_necessario_w := 'S';
		end if;

    if (obtain_user_locale(nm_usuario_p) = 'ja_JP') then
      qt_dose_ref_w := qt_dose_p;
      SELECT * FROM cpoe_get_dose_or_daily_dose(ie_via_aplicacao_rp_w, cd_intervalo_rp_w, qt_dose_ref_w, qt_dose_dia_w) INTO STRICT qt_dose_ref_w, qt_dose_dia_w;
    end if;

		insert into cpoe_material(
			nr_sequencia,
			nr_atendimento,
			cd_pessoa_fisica,
			nm_usuario,
			dt_atualizacao,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			dt_inicio,
			cd_material,
			cd_unidade_medida,
			ie_controle_tempo,
			cd_perfil_ativo,
			cd_funcao_origem,
			ie_prescritor_aux,
			cd_medico,
			nr_seq_cpoe_order_unit,
			nr_seq_cpoe_rp,
			cd_setor_atendimento,
			ie_via_aplicacao,
			nr_seq_grupo_interval,
			nr_seq_subgrupo_interval,
			cd_intervalo,
			dt_fim,
			ds_horarios,
			ie_segunda,
			ie_terca,
			ie_quarta,
			ie_quinta,
			ie_sexta,
			ie_sabado,
			ie_domingo,
			ie_duracao,
			ie_urgencia,
			ie_administracao,
			qt_solucao_total,
			qt_volume,
			ie_tipo_analgesia,
			ie_pca_modo_prog,
			qt_dose_inicial_pca,
			ie_um_dose_inicio_pca,
			ie_um_fluxo_pca,
			qt_vol_infusao_pca,
			qt_bolus_pca,
			ie_um_bolus_pca,
			qt_intervalo_bloqueio,
			qt_limite_quatro_hora,
			ie_um_limite_pca,
			qt_limite_uma_hora,
			ie_um_limite_hora_pca,
			si_rapid_infusion,
			qt_final_concentration,
			ie_incrementar,
			ie_tipo_dosagem_inc,
			ie_um_final_conc_pca,
			qt_dosagem_inc,
			ie_fator_correcao,
			qt_dose_terapeutica,
			qt_dose,
      qt_dose_dia,
			ie_acm,
			ie_se_necessario,
			ie_evento_unico,
			nr_ocorrencia,
			qt_tempo_aplicacao,
			ie_tipo_solucao,
			ie_tipo_dosagem,
			ie_drip_shot,
			ie_ref_calculo,
			qt_hora_fase,
			ie_bomba_infusao,
			nr_etapas,
			qt_dosagem,
			cd_unid_medic_terap,
            		ds_dose_diferenciada)
		values (
			nr_sequencia_w,
			nr_atendimento_p,
			cd_pessoa_fisica_p,
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			coalesce(dt_inicio_rp_w, dt_inicio_w),
			cd_material_w,
			coalesce(cd_unidade_medida_p, cd_unidade_medida_w),
			ie_controle_tempo_p,
			cd_perfil_p,
			2314,
			ie_prescritor_aux_p,
			cd_medico_p,
			nr_seq_cpoe_order_unit_p,
			nr_seq_cpoe_rp_p,
			cd_setor_execucao_w,
			ie_via_aplicacao_rp_w,
			nr_seq_grupo_interval_rp_w,
			nr_seq_subgrupo_interval_rp_w,
			cd_intervalo_rp_w,
			dt_fim_rp_w,
			ds_horarios_rp_w,
			ie_segunda_rp_w,
			ie_terca_rp_w,
			ie_quarta_rp_w,
			ie_quinta_rp_w,
			ie_sexta_rp_w,
			ie_sabado_rp_w,
			ie_domingo_rp_w,
			ie_duracao_rp_w,
			ie_urgencia_rp_w,
			ie_administracao_rp_w,
			qt_solucao_total_rp_w,
			qt_volume_rp_w,
			ie_tipo_analgesia_rp_w,
			ie_pca_modo_prog_rp_w,
			qt_dose_inicial_pca_rp_w,
			ie_um_dose_inicio_pca_rp_w,
			ie_um_fluxo_pca_rp_w,
			qt_vol_infusao_pca_rp_w,
			qt_bolus_pca_rp_w,
			ie_um_bolus_pca_rp_w,
			qt_intervalo_bloqueio_rp_w,
			qt_limite_quatro_hora_rp_w,
			ie_um_limite_pca_rp_w,
			qt_limite_uma_hora_rp_w,
			ie_um_limite_hora_pca_rp_w,
			si_rapid_infusion_rp_w,
			qt_final_concentration_rp_w,
			ie_incrementar_rp_w,
			ie_tipo_dosagem_inc_rp_w,
			ie_um_final_conc_pca_rp_w,
			qt_dosagem_inc_rp_w,
			ie_fator_correcao_rp_w,
			qt_dose_terapeutica_rp_w,
			qt_dose_p,
      qt_dose_dia_w,
			ie_acm_w,
			ie_se_necessario_w,
			ie_evento_unico_w,
			nr_ocorrencia_w,
			qt_tempo_aplicacao_w,
			ie_tipo_solucao_w,
			ie_tipo_dosagem_w,
			ie_drip_shot_w,
			ie_ref_calculo_w,
			qt_hora_fase_w,
			ie_bomba_infusao_w,
			nr_etapas_w,
			qt_dosagem_w,
			cd_unid_medic_terap_w,
            		ds_dose_diferenciada_p);

		nr_seq_item_gerado_p := nr_sequencia_w;
		CALL cpoe_consis_med_insert(nr_seq_item_gerado_p,nm_usuario_p);
		CALL cpoe_insert_soluc_comp(nr_seq_item_gerado_p, ds_list_components_p);
		CALL cpoe_calc_solution_values_rp(nr_seq_item_gerado_p);

      commit;
    end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_medicine_solution_select (nr_atendimento_p cpoe_material.nr_atendimento%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, nm_usuario_p cpoe_material.nm_usuario%type, cd_perfil_p bigint, cd_estabelecimento_p bigint, nr_seq_item_gerado_p INOUT bigint, ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_controle_tempo_p cpoe_material.ie_controle_tempo%type DEFAULT NULL, cd_material_p cpoe_material.cd_material%type DEFAULT NULL, nr_seq_cpoe_order_unit_p cpoe_material.nr_seq_cpoe_order_unit%type DEFAULT NULL, nr_seq_cpoe_rp_p cpoe_material.nr_seq_cpoe_rp%type default null, ds_list_components_p text default null, cd_unidade_medida_p cpoe_material.cd_unidade_medida%type default null, qt_dose_p cpoe_material.qt_dose%type default null, ds_dose_diferenciada_p cpoe_material.ds_dose_diferenciada%type default null) FROM PUBLIC;

