-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_get_regra_mat_alteracao ( nr_seq_order_unit_p bigint default null, nr_seq_cpoe_rp_p bigint default null, nr_seq_cpoe_material_p bigint default null, nm_usuario_p text DEFAULT NULL, cd_perfil_p bigint DEFAULT NULL, ie_permite_suspender_p INOUT text DEFAULT NULL, ie_cancela_dose_p INOUT text DEFAULT NULL) AS $body$
DECLARE

		
ie_permite_suspender_w 		cpoe_regra_mat_alteracao.ie_permite_suspender%type := 'S';
ie_cancela_dose_w 			cpoe_regra_mat_alteracao.ie_cancela_dose%type := 'S';
nr_seq_order_unit_w 		cpoe_order_unit.nr_sequencia%type := nr_seq_order_unit_p;
si_type_of_prescription_w 	cpoe_order_unit.si_type_of_prescription%type;
cd_perfil_w 				perfil.cd_perfil%type := cd_perfil_p;
dt_liberacao_ordem_w		cpoe_order_unit.dt_liberacao%type;
ie_profissional_w 			usuario.ie_profissional%type;
ie_status_lote_w			ap_lote.ie_status_lote%type;

c_regras CURSOR FOR
	SELECT 	ie_permite_suspender,
			ie_cancela_dose,
            nr_sequencia
	from 	cpoe_regra_mat_alteracao
	where 	coalesce(cd_perfil, cd_perfil_w) = cd_perfil_w
	and	 	coalesce(nm_usuario_regra, nm_usuario_p) = nm_usuario_p
	and 	coalesce(ie_funcao_profissional, ie_profissional_w) = ie_profissional_w
	and		coalesce(si_type_of_prescription, si_type_of_prescription_w) = si_type_of_prescription_w
	and 	((dt_liberacao_ordem_w + qt_min_suspensao/1440) > clock_timestamp() or coalesce(qt_min_suspensao::text, '') = '')
	and		coalesce(ie_status_lote,ie_status_lote_w) = ie_status_lote_w
	and 	ie_situacao = 'A'
	order by
            coalesce(nm_usuario_regra, 'Z') desc,
            coalesce(ie_funcao_profissional, 'Z') desc,
            coalesce(cd_perfil, 9999) desc,
			coalesce(si_type_of_prescription, 'Z') desc,
			coalesce(ie_status_lote, 'Z') desc,
			coalesce(qt_min_suspensao, 9999) desc;

BEGIN

if (coalesce(nr_seq_cpoe_material_p, 0) > 0 or coalesce(nr_seq_cpoe_rp_p, 0) > 0 or coalesce(nr_seq_order_unit_p, 0) > 0) then

	if (nr_seq_cpoe_material_p IS NOT NULL AND nr_seq_cpoe_material_p::text <> '') then
		select	max(nr_seq_cpoe_order_unit)
		into STRICT	nr_seq_order_unit_w
		from    cpoe_material
		where 	nr_sequencia = nr_seq_cpoe_material_p;
	elsif (nr_seq_cpoe_rp_p IS NOT NULL AND nr_seq_cpoe_rp_p::text <> '') then
		select	max(nr_seq_cpoe_order_unit)
		into STRICT	nr_seq_order_unit_w
		from	cpoe_rp
		where	nr_sequencia = nr_seq_cpoe_rp_p;
	elsif (nr_seq_order_unit_p IS NOT NULL AND nr_seq_order_unit_p::text <> '') then
		nr_seq_order_unit_w := nr_seq_order_unit_p;
	end if;

	if (nr_seq_order_unit_w IS NOT NULL AND nr_seq_order_unit_w::text <> '') then
		select	coalesce(max(si_type_of_prescription), 'X'),
				coalesce(max(dt_liberacao), clock_timestamp())
		into STRICT 	si_type_of_prescription_w,
				dt_liberacao_ordem_w
		from	cpoe_order_unit
		where	nr_sequencia = nr_seq_order_unit_w;

		if (coalesce(cd_perfil_w::text, '') = '') then
			cd_perfil_w := wheb_usuario_pck.get_cd_perfil;
		end if;

		select	coalesce(max(ie_profissional),'X')
		into STRICT	ie_profissional_w
		from	usuario
		where	nm_usuario = nm_usuario_p;

		begin
			select	coalesce(max(a.ie_status_lote), 'X')
			into STRICT	ie_status_lote_w
			from    ap_lote a
			where	a.nr_sequencia = (	SELECT 	min(z.nr_seq_lote)
										from    prescr_mat_hor z,
												prescr_material y,
												cpoe_material x
										where	y.nr_seq_mat_cpoe = x.nr_sequencia
										and		z.nr_prescricao = y.nr_prescricao
										and		y.nr_sequencia = z.nr_seq_material
										and (x.nr_sequencia = nr_seq_cpoe_material_p or coalesce(nr_seq_cpoe_material_p::text, '') = '')
										and (x.nr_seq_cpoe_rp = nr_seq_cpoe_rp_p or coalesce(nr_seq_cpoe_rp_p::text, '') = '')
										and (x.nr_seq_cpoe_order_unit = nr_seq_order_unit_p or coalesce(nr_seq_order_unit_p::text, '') = '')
									);
			exception
				when others then
				ie_status_lote_w    := 'X';
		end;
					
		for r_regra in c_regras
		loop
			ie_permite_suspender_w := r_regra.ie_permite_suspender;
			ie_cancela_dose_w := r_regra.ie_cancela_dose;
		end loop;
	end if;
end if;
ie_permite_suspender_p := ie_permite_suspender_w;
ie_cancela_dose_p := ie_cancela_dose_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_get_regra_mat_alteracao ( nr_seq_order_unit_p bigint default null, nr_seq_cpoe_rp_p bigint default null, nr_seq_cpoe_material_p bigint default null, nm_usuario_p text DEFAULT NULL, cd_perfil_p bigint DEFAULT NULL, ie_permite_suspender_p INOUT text DEFAULT NULL, ie_cancela_dose_p INOUT text DEFAULT NULL) FROM PUBLIC;

