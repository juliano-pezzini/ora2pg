-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE contabiliza_controle_bancario (nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text) AS $body$
DECLARE


cd_conta_contabil_w             conta_contabil.cd_conta_contabil%type;
cd_empresa_w                    empresa.cd_empresa%type;
cd_estabelecimento_w            estabelecimento.cd_estabelecimento%type;
nr_documento_w                  varchar(255);
vl_transacao_w                  double precision;
cd_pessoa_fisica_w              pessoa_fisica.cd_pessoa_fisica%type;
cd_cgc_w                        pessoa_juridica.cd_cgc%type;
nr_seq_conta_banco_w            bigint;
nr_seq_trans_fin_w              transacao_financeira.nr_sequencia%type;
nr_seq_agrupamento_w            w_movimento_contabil.nr_seq_agrupamento%type;
nm_atributo_w                   varchar(50);
dt_contabil_w                   timestamp;
cd_convenio_w                   convenio.cd_convenio%type;
nr_seq_baixa_cart_w             lote_baixa_cartao_cr.nr_sequencia%type;
ds_bandeira_cartao_ww           varchar(255);
cd_centro_custo_w               centro_custo.cd_centro_custo%type;
dt_movimento_w                  timestamp;
ie_agrupa_w                     parametro_controle_banc.ie_agrupa_trans_contab%type;
ie_debito_credito_w             varchar(1);
ie_debito_credito_ww            varchar(1);
nr_sequencia_w                  w_movimento_contabil.nr_sequencia%type  := 0;
nr_seq_trans_w                  bigint;
cd_historico_w                  historico_padrao.cd_historico%type;
cd_historico_movto_w            historico_padrao.cd_historico%type;
ds_historico_w                  varchar(255);
ds_erro_w                       varchar(255);
ds_hist_pf_pj_w                 varchar(255);
dt_inicial_w                    timestamp;
dt_final_w                      timestamp;
ie_data_contabil_w              parametro_controle_banc.ie_data_contabil%type;
ie_hist_contabil_w              parametro_controle_banc.ie_hist_contabil%type;
cd_conta_contabil_banco_w       conta_contabil.cd_conta_contabil%type;
ds_banco_conta_w                varchar(255);
ie_contab_w                     varchar(01);
nr_bordero_w                    bordero_pagamento.nr_bordero%type;
vl_cheque_w                     cheque.vl_cheque%type;
nr_cheque_w                     varchar(15);
ie_contab_cp_no_cb_w            parametro_controle_banc.ie_contab_cp_no_cb%type;
ie_contab_cr_no_cb_w            parametro_controle_banc.ie_contab_cr_no_cb%type;
ds_benef_origem_w               varchar(255);
ie_benef_orig_trib_contab_w     parametros_contas_pagar.ie_benef_orig_trib_contab%type;
nr_titulo_w                     bigint;
ie_contab_banco_w               transacao_financeira.ie_contab_banco%type;
ie_contab_bordero_w             parametro_controle_banc.ie_contab_bordero%type;
nr_doc_w                        varchar(80);
nr_adiantamento_w               adiantamento.nr_adiantamento%type;
ie_compl_hist_w                 varchar(3);
cd_tipo_lote_contabil_w         lote_contabil.cd_tipo_lote_contabil%type;
nr_adiant_pago_w                adiantamento_pago.nr_adiantamento%type;
nr_bordero_rec_w                bordero_recebimento.nr_bordero%type;
nr_interno_conta_w              conta_paciente.nr_interno_conta%type;
nr_seq_nota_fiscal_w            nota_fiscal.nr_sequencia%type;
nr_seq_titulo_pagar_w           titulo_pagar.nr_titulo%type;
nr_seq_titulo_receber_w         titulo_receber.nr_titulo%Type;
ds_conteudo_w                   varchar(4000);
ds_compl_historico_w            varchar(1000);
nr_seq_cheque_w                 cheque_cr.nr_seq_cheque%type;
nr_seq_cheque_cp_w              bigint;
cd_banco_cheque_w               banco.cd_banco%Type;
ds_banco_cheque_w               banco.ds_banco%Type;
cd_agencia_cheque_w             varchar(20);
nr_conta_cheque_w               varchar(40);
nr_adiant_cheque_w              bigint;
nm_pf_cheque_w                  pessoa_fisica.nm_pessoa_fisica%Type;
ds_razao_social_cheque_w        pessoa_juridica.ds_razao_social%Type;
ds_banco_w                      varchar(255);
nr_cheque_pago_w                varchar(255);
nr_parcela_w                    bigint;
ds_compl_contab_cp_w            varchar(255);
nr_cheque_adiant_w              varchar(255);
nr_cheque_adiant_pago_w         varchar(255);
cd_estab_movto_w                bigint;
ie_permite_estab_dif_w          varchar(15);
cd_conta_transitoria_w          conta_contabil.cd_conta_contabil%type;
cd_historico_ct_w               historico_padrao.cd_historico%type;
nr_seq_caixa_od_w               bigint;
ds_caixa_od_w                   varchar(40);
nr_cheque_bordero_w             varchar(255);
ds_movto_cartao_w               varchar(255);
nr_cheque_cr_w                  cheque_cr.nr_cheque%Type;
nr_seq_movto_cartao_w           bigint;
nr_seq_banco_od_w               bigint;
ds_banco_od_w                   banco.ds_banco%Type;
nr_conta_od_w                   varchar(255);
ie_compl_historico_banc_w       parametro_controle_banc.ie_compl_historico%type;
ds_pessoa_titulo_w              varchar(400);
nr_cheque_tit_pagar_w           varchar(400);
nr_doc_cheque_w                 varchar(255);
cd_banco_ext_cheque_w           varchar(255);
nr_nota_fiscal_w                varchar(255);
cd_conta_deb_pls_w              conta_contabil.cd_conta_contabil%type;
cd_conta_rec_pls_w              conta_contabil.cd_conta_contabil%type;
cd_historico_pls_w              historico_padrao.cd_historico%type;
nr_seq_produto_w                bigint;
ds_interno_w                    Banco_Estabelecimento.ds_interno%Type;
nr_seq_cheque_dep_w             bigint;
nr_cheque_deposito_w            varchar(255);
ie_contab_trans_fin_baixa_w     varchar(1);
nr_seq_trans_fin_baixa_w        bigint;
nm_pessoa_adiant_pago_w         varchar(255);
ie_estorno_w                    movto_trans_financ.ie_estorno%type;
ds_estorno_w                    varchar(40);
qt_estorno_contab_w             bigint;
nr_seq_movto_orig_w             movto_trans_financ.nr_seq_movto_orig%type;
ie_contab_vl_estorno_w          parametro_controle_banc.ie_contab_vl_estorno%type;
nr_seq_banco_escrit_w           banco_escritural.nr_sequencia%type;
ds_banco_escrit_w               banco.ds_banco%Type;
ds_obs_movto_cartao_baixa_w     movto_cartao_cr_baixa.ds_observacao%Type;
ds_obs_titulo_rec_w             titulo_receber.ds_observacao_titulo%Type;
nr_seq_bandeira_cartao_w        bandeira_cartao_cr.nr_sequencia%type;
vl_antecipacao_mens_w           double precision;
dt_mensalidade_w                timestamp;
ie_contab_baixas_pro_rata_w     pls_parametros_cr.ie_contab_baixas_pro_rata%type;
ie_tipo_lote_pls_w              varchar(1);
dt_contab_lote_w                timestamp;
dt_referencia_pls_mens_w        timestamp;
nr_seq_baixa_w                  integer;
ds_bandeira_cartao_w            varchar(255);
ie_tipo_movto_w                 varchar(1);
ds_obs_adiant_pago_w            varchar(200);
ds_obs_titulo_pagar_w           titulo_pagar.ds_observacao_titulo%Type;
nm_pessoa_caixa_rec_w           varchar(255);
ds_pessoa_rec_cartao_w          varchar(255);
ie_contab_cb_w                  transacao_financeira.ie_contab_cb%Type;
ie_contab_concil_w              varchar(1);
ds_comprovante_w                movto_cartao_cr.ds_comprovante%Type;
nm_estabelecimento_w            varchar(255);
nr_seq_liq_cc_w                 bigint;
nr_seq_proj_rec_w               bigint;
ds_proj_rec_w                   projeto_recurso.ds_projeto%type;
nm_pessoa_adiantamento_w        varchar(200);
ie_lote_pro_rata_w              varchar(3);
ds_cheque_cp_w                  varchar(180);
nr_seq_movto_transf_bco_w       bigint;
ie_agrup_movto_transf_w         varchar(15);
nr_seq_movto_bco_pend_w         bigint;
ds_notas_titulo_unificado_w     varchar(255);
cd_estab_banco_od_w             bigint;
ds_nota_fiscal_cartao_w         varchar(150);
ds_nfe_cartao_w                 varchar(150);
nr_seq_caixa_rec_w              movto_cartao_cr.nr_seq_caixa_rec%type;
ie_contab_transit_cr_w          parametro_controle_banc.ie_contab_transit_cr%type;
ie_contab_transit_w             varchar(1);
nr_seq_parc_cartao_w            movto_cartao_cr_parcela.nr_sequencia%type;
nr_parcela_cartao_w             bigint;
nr_seq_lote_cartao_w            lote_baixa_cartao_cr.nr_sequencia%type;
qt_regra_estab_origem_w         bigint;
nr_seq_cni_w                    bigint;
nr_seq_classif_w                bigint;
ds_macro_w                      varchar(1000);
cd_tributo_w                    tributo.cd_tributo%type;
ds_bordero_w                    bordero_pagamento.ds_bordero%Type;
nm_paciente_adiantamento_w      pessoa_fisica.nm_pessoa_fisica%type;
nr_seq_movto_trans_fin_w        bigint;
cd_estab_inf_movto_w            estabelecimento.cd_estabelecimento%type;
nr_seq_deposito_w               bigint;
ie_contab_transit_tf_w          varchar(1);
ie_contab_classif_mens_w        varchar(1);
cd_tipo_baixa_w                 integer;
cd_transacao_w                  varchar(10);
ds_transacao_w                  varchar(250);
cd_estab_trans_fin_w            smallint;
ie_movto_tf_estab_w             parametro_controle_banc.ie_movto_tf_estab%type;
nr_seq_baixa_cr_w               bigint;
cd_tipo_recebimento_w           titulo_receber_liq.cd_tipo_recebimento%type;
nr_lote_contabil_w              lote_contabil.nr_lote_contabil%type;
nr_titulo_original_w            bigint;
nm_pf_pj_tit_original_w         varchar(80);
nr_seq_perda_w                  bigint;
nr_seq_cobr_escrit_w            bigint;
qt_contador_w                   bigint;
ie_nf_nfe_w                     varchar(15);
nm_tabela_w                     lote_contabil_log.nm_tabela%type;
ie_contab_desp_cartao_w         parametro_contas_receber.ie_contab_desp_cartao%type;
ie_contab_prov_tributo_w        parametros_contas_pagar.ie_contab_prov_tributo%type;
cd_tributo_ww                   tributo.cd_tributo%type;
ie_estorno_ww                   varchar(50);
nr_seq_info_ctb_w               informacao_contabil.nr_sequencia%type;
nr_seq_tab_orig_w               w_movimento_contabil.nr_seq_tab_orig%type;
nr_seq_tab_compl_w              w_movimento_contabil.nr_seq_tab_compl%type;
nr_documento_ww                 w_movimento_contabil.nr_documento%type;
ie_origem_documento_w           w_movimento_contabil.ie_origem_documento%type;
vl_transacao_orig_w             movto_trans_financ.vl_transacao%type;
vl_titulo_banco_w               titulo_pagar_baixa.vl_pago%type;
nr_seq_concil_w                 movto_trans_financ.nr_seq_concil%type;
nm_paciente_cheque_w            varchar(255);
ds_tributo_w                    tributo.ds_tributo%type;
ie_regra_w                      varchar(255);
ds_atributos_w                  varchar(4000);
ie_contab_trans_fin_baix_rec_w  parametro_contas_receber.ie_contab_trans_fin_baixa%type;
qt_parcelas_w                   bigint;
nr_parc_cartao_total_w          varchar(100);
cd_processo_dcomp_w             darf_perdcomp.cd_processo_dcomp%type;
nm_agrupador_w                  varchar(255);
nr_seq_titulo_cheque_w          cheque_cr.nr_titulo%type;
nr_seq_darf_w                   darf.nr_sequencia%type;
cd_moeda_w                      movto_trans_financ.cd_moeda%type;
ie_forma_lanc_lote_cartao_w     parametro_contas_receber.ie_forma_lanc_lote_cartao%type;
nr_nfe_imp_w                    nota_fiscal.nr_nfe_imp%type;
nr_seq_rpa_w                    titulo_pagar.nr_seq_rpa%type;
ie_gera_ctb_transit_w           varchar(1);
/* OS 1968954 - Incluido para validacao Intercompany */

ie_intercompany_w               varchar(1)     := 'N';
/* jjob - OS 2024096 - Incluindo para inserir novo campo cd_estab_intercompany no movimento */

cd_estab_intercompany_w         estabelecimento.cd_estabelecimento%type;
nr_seq_cni_orig_w               movto_trans_financ.nr_seq_movto_orig%type;
cd_estab_intercompany_ori_w     estabelecimento.cd_estabelecimento%type;
ds_estab_intercompany_ori_w     pessoa_juridica.ds_razao_social%type;
cd_estab_intercompany_des_w     estabelecimento.cd_estabelecimento%type;
ds_estab_intercompany_des_w     pessoa_juridica.nm_fantasia%type;
cd_interno_intercompany_ori_w   estabelecimento.cd_interno%type;
cd_interno_intercompany_des_w   estabelecimento.cd_interno%type;
cd_serie_nf_w                   nota_fiscal.cd_serie_nf%type;

C010 CURSOR FOR
        SELECT  coalesce(e.vl_transacao, b.vl_transacao),
                b.nr_seq_trans_financ,
                b.dt_transacao,
                'VL_TRANSACAO',
                b.nr_seq_banco, /* Francisco OS 83427 - 06/03/2008 - Troquei de NR_SEQ_BANCO_OD para NR_SEQ_BANCO */
                substr(obter_compl_trans_fin(b.nr_sequencia, 'PJ'),1,255) cd_cgc,
                b.cd_conta_contabil,
                coalesce(e.cd_centro_custo, b.cd_centro_custo),
                coalesce(b.nr_documento, coalesce(to_char(b.nr_adiantamento),coalesce(to_char(nr_bordero),to_char(nr_interno_conta)))),
                ie_banco,
                CASE WHEN coalesce(d.ie_agrupa_lote_cb,ie_agrupa_w)='N' THEN  b.nr_sequencia  ELSE 0 END ,
                ds_historico,
                substr(obter_compl_trans_fin(b.nr_sequencia, 'PF'),1,255) cd_pessoa_fisica,
                c.cd_conta_contabil,
                d.cd_historico_banco,
                substr(coalesce(c.ds_interno,obter_banco_e_conta(c.nr_sequencia)),1,255) ds_banco_conta,
                substr(obter_compl_trans_fin(b.nr_sequencia, 'N'),1,255) ds_compl_pf_pj,
                substr(obter_se_trans_contab(d.nr_sequencia),1,1) ie_contab,
                coalesce(b.nr_bordero,0),
                0 nr_titulo,
                coalesce(b.nr_documento,''),
                coalesce(b.nr_adiantamento,0),
                b.cd_historico,
                b.nr_adiant_pago,
                b.nr_bordero_rec,
                b.nr_interno_conta,
                (obter_dados_tit_pagar(b.nr_seq_titulo_pagar,'NFSEQ'))::numeric nr_seq_nota_fiscal,
                b.nr_seq_titulo_pagar,
                b.nr_seq_titulo_receber,
                b.nr_seq_cheque,
                c.ds_banco,
                b.nr_seq_cheque_cp,
                substr(obter_descricao_padrao('TITULO_PAGAR','DS_COMPL_CONTAB',b.nr_seq_titulo_pagar),1,255) ds_compl_contab_cp,
                b.cd_estabelecimento cd_estabelecimento,
                b.nr_seq_caixa_od,
                b.nr_seq_movto_cartao,
                b.nr_seq_banco_od,
                substr(coalesce(obter_pessoa_titulo_pagar(b.nr_seq_titulo_pagar), obter_pessoa_titulo_receber(b.nr_seq_titulo_receber)),1,80),
                '' cd_conta_deb_pls,
                '' cd_conta_rec_pls,
                (null)::numeric  cd_historico_pls,
                (null)::numeric  nr_seq_produto,
                (null)::numeric  nr_seq_cheque_dep,
                coalesce(b.ie_estorno,'N') ie_estorno,
                CASE WHEN coalesce(d.ie_agrupa_lote_cb,ie_agrupa_w)='N' THEN  coalesce(b.nr_seq_movto_orig,0)  ELSE 0 END   nr_seq_movto_orig,
                b.nr_seq_banco_escrit,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                null nr_seq_liq_cc,
                b.nr_seq_proj_rec,
                null ie_lote_pro_rata,
                b.nr_seq_movto_transf_bco,
                obter_movto_banco_pend(b.nr_sequencia) nr_seq_movto_banco_pend,
                b.nr_seq_parc_cartao,
                b.nr_seq_lote_cartao,
                substr(obter_movto_banco_pend_orig(b.nr_sequencia),1,10) nr_seq_cni,
                b.nr_sequencia,
                b.nr_seq_deposito,
                null cd_tipo_baixa,
                null nr_seq_baixa_cr,
                b.nr_seq_perda,
                b.nr_seq_cobr_escrit nr_seq_cobr_escrit,
                'MOVTO_TRANS_FINANC',
                null cd_tributo,
                5 nr_seq_info_ctb,
                b.nr_sequencia,
                b.nr_seq_concil,
                b.cd_moeda,
                substr(obter_movto_banco_pend_orig(b.nr_seq_movto_orig), 1, 10) nr_seq_cni_orig
        FROM transacao_financeira d, movto_trans_financ b
LEFT OUTER JOIN movto_trans_financ_cc e ON (b.nr_sequencia = e.nr_seq_movto_trans)
, banco_saldo a
LEFT OUTER JOIN banco_estabelecimento_v c ON (a.nr_seq_conta = c.nr_sequencia)
WHERE b.nr_Lote_contabil      = nr_lote_contabil_p  and a.nr_sequencia                  = b.nr_seq_saldo_banco and (b.nr_seq_trans_financ IS NOT NULL AND b.nr_seq_trans_financ::text <> '') and coalesce(b.nr_seq_caixa::text, '') = '' and ie_banco                in ('D','C','T') and b.nr_seq_trans_financ   = d.nr_sequencia and d.ie_contab_cb          = 'S'
union all

        SELECT  a.vl_transacao,
                a.nr_seq_trans_fin,
                a.dt_baixa dt_transacao,
                a.ds_atributo,
                a.nr_seq_conta_banco,
                b.cd_cgc,
                a.cd_conta_contabil,
                a.cd_centro_custo,
                b.nr_documento || ' (' || to_char(a.nr_titulo) || ')',
                'T',
                CASE WHEN ie_agrupa_w='N' THEN  a.nr_titulo  ELSE a.nr_seq_movto_trans_fin END ,
                ' ' ds_historico,
                b.cd_pessoa_fisica,
                ' ' cd_conta_contabil_banco,
                0 cd_historico_banco,
                substr(coalesce(c.ds_interno,obter_banco_e_conta(c.nr_sequencia)),1,255) ds_banco_conta,
                obter_pessoa_titulo_pagar(a.nr_titulo) ds_hist_pf_pj,
                'S' ie_contab,
                a.nr_bordero,
                a.nr_titulo,
                coalesce(to_char(b.nr_documento),''),
                0 nr_adiantamento,
                null,
                0 nr_adiant_pago,
                0 nr_bordero_rec,
                0 nr_interno_conta,
                b.nr_seq_nota_fiscal,
                b.nr_titulo nr_seq_titulo_pagar,
                0 nr_seq_titulo_receber,
                0 nr_seq_cheque,
                '' ds_banco,
                0 nr_seq_cheque_cp,
                b.ds_compl_contab ds_compl_contab_cp,
                b.cd_estabelecimento,
                0,
                0,
                0,
                obter_pessoa_titulo_pagar(a.nr_titulo),
                '' cd_conta_deb_pls,
                '' cd_conta_rec_pls,
                (null)::numeric  cd_historico_pls,
                (null)::numeric  nr_seq_produto,
                (null)::numeric  nr_seq_cheque_dep,
                '' ie_estorno,
                coalesce(obter_movto_trans_financ_orig(a.nr_seq_movto_trans_fin),0) nr_seq_movto_orig,
                a.nr_seq_escrit nr_seq_banco_escrit,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                a.nr_seq_baixa_cc nr_seq_liq_cc,
                b.nr_seq_proj_rec,
                null ie_lote_pro_rata,
                null,
                null,
                null,
                null nr_seq_lote_cartao,
                to_char(null) nr_seq_cni,
                a.nr_seq_movto_trans_fin nr_seq_movto_trans_fin,
                null nr_seq_deposito,
                a.cd_tipo_baixa,
                a.nr_seq_baixa nr_seq_baixa_cr,
                null nr_seq_perda,
                0 nr_seq_cobr_escrit,
                'TITULO_PAGAR_BAIXA_CONTAB_V',
                null cd_tributo,
                13 nr_seq_info_ctb,
                a.nr_seq_baixa,
                null,
                a.cd_moeda,
                to_char(null) nr_seq_cni_orig
        FROM titulo_pagar b, titulo_pagar_baixa_cc_contab_v a
LEFT OUTER JOIN banco_estabelecimento_v c ON (a.nr_seq_conta_banco = c.nr_sequencia)
WHERE a.nr_Lote_contabil      = nr_lote_contabil_p and (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '') and a.ds_atributo           <> 'VL_PAGO' and ie_contab_cp_no_cb_w    = 'S' and a.nr_titulo             = b.nr_titulo  
union all

        select  a.vl_transacao,
                a.nr_seq_trans_fin,
                a.dt_recebimento dt_transacao,
                a.ds_atributo,
                a.nr_seq_conta_banco,
                b.cd_cgc,
                '' cd_conta_contabil,
                a.cd_centro_custo,
                b.nr_documento || ' (' || to_char(a.nr_titulo) || ')',
                'T',
                CASE WHEN ie_agrupa_w='N' THEN  a.nr_titulo  ELSE a.nr_seq_movto_trans_fin END ,
                ' ' ds_historico,
                b.cd_pessoa_fisica,
                ' ' cd_conta_contabil_banco,
                0 cd_historico_banco,
            substr(coalesce(c.ds_interno,obter_banco_e_conta(c.nr_sequencia)),1,255) ds_banco_conta,
                substr(obter_nome_pf_pj(b.cd_pessoa_fisica,b.cd_cgc),1,255) ds_hist_pf_pj,
                'S' ie_contab,
                obter_bordero_tit_rec(a.nr_titulo) nr_bordero,
                a.nr_titulo,
                coalesce(to_char(b.nr_documento),''),
                0 nr_adiantamento,
                NULL,
                0 nr_adiant_pago,
                0 nr_bordero_rec,
                0 nr_interno_conta,
                0 nr_seq_nota_fiscal,
                0 nr_seq_titulo_pagar, /* b.nr_titulo MATHEUS OS 134222 06/04/2009 Estava trazendo titulo rec no lugar do tit pagar*/
                b.nr_titulo nr_seq_titulo_receber,
                0 nr_seq_cheque,
                '' ds_banco,
                0 nr_seq_cheque_cp,
                '' ds_compl_contab_cp,
                b.cd_estabelecimento,
                0,
                0,
                0,
                obter_pessoa_titulo_receber(b.nr_titulo),
                '' cd_conta_deb_pls,
                '' cd_conta_rec_pls,
                (null)::numeric  cd_historico_pls,
                (null)::numeric  nr_seq_produto,
                (null)::numeric  nr_seq_cheque_dep,
                '' ie_estorno,
                CASE WHEN coalesce(d.ie_agrupa_lote_cb,'S')='N' THEN  coalesce((select    max(x.nr_seq_movto_orig)                                                                from    movto_trans_financ      x                                                                where   x.nr_sequencia  = a.nr_seq_movto_trans_fin),0)  ELSE 0 END  nr_seq_movto_orig,
                0 nr_seq_banco_escrit,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                null nr_seq_liq_cc,
                b.nr_seq_proj_rec,
                null ie_lote_pro_rata,
                null,
                null,
                null,
                null nr_seq_lote_cartao,
                to_char(null) nr_seq_cni,
                a.nr_seq_movto_trans_fin nr_seq_movto_trans_fin,
                null nr_seq_deposito,
                null cd_tipo_baixa,
                a.nr_seq_baixa nr_seq_baixa_cr,
                null nr_seq_perda,
                0 nr_seq_cobr_escrit,
                'TITULO_RECEBER_LIQ_CONTAB_V',
                null cd_tributo,
                14 nr_seq_info_ctb,
                a.nr_seq_baixa,
                null,
                a.cd_moeda,
                to_char(null) nr_seq_cni_orig
        FROM transacao_financeira d, titulo_receber b, titulo_receber_liq_contab_v2 a
LEFT OUTER JOIN banco_estabelecimento_v c ON (a.nr_seq_conta_banco = c.nr_sequencia)
WHERE a.nr_Lote_contabil      = nr_lote_contabil_p and (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '') and d.nr_sequencia          = a.nr_seq_trans_fin and a.ds_atributo not in ('VL_RECEBIDO','VL_RECEBIDO_TESOURARIA') and ie_contab_cr_no_cb_w    = 'S' and a.nr_titulo             = b.nr_titulo  --Teste contabilizacao OPS
 
union all
 /* Matheus contabilizacao analitica dos cheques do deposito*/
        select  g.vl_cheque vl_transacao,
                b.nr_seq_trans_financ,
                b.dt_transacao,
                'VL_CHEQUE_DEPOSITO',
                b.nr_seq_banco, /* Francisco OS 83427 - 06/03/2008 - Troquei de NR_SEQ_BANCO_OD para NR_SEQ_BANCO */
                substr(obter_compl_trans_fin(b.nr_sequencia, 'PJ'),1,255) cd_cgc,
                b.cd_conta_contabil,
                coalesce(e.cd_centro_custo, b.cd_centro_custo),
                coalesce(b.nr_documento, coalesce(to_char(b.nr_adiantamento),coalesce(to_char(nr_bordero),to_char(nr_interno_conta)))),
                ie_banco,
                CASE WHEN coalesce(d.ie_agrupa_lote_cb,ie_agrupa_w)='N' THEN  b.nr_sequencia  ELSE 0 END ,
                ds_historico,
                substr(obter_compl_trans_fin(b.nr_sequencia, 'PF'),1,255) cd_pessoa_fisica,
                c.cd_conta_contabil,
                d.cd_historico_banco,
                substr(coalesce(c.ds_interno,obter_banco_e_conta(c.nr_sequencia)),1,255) ds_banco_conta,
                substr(obter_compl_trans_fin(b.nr_sequencia, 'N'),1,255) ds_compl_pf_pj,
                substr(obter_se_trans_contab(d.nr_sequencia),1,1) ie_contab,
                b.nr_bordero,
                0 nr_titulo,
                coalesce(b.nr_documento,''),
                coalesce(b.nr_adiantamento,0),
                b.cd_historico,
                b.nr_adiant_pago,
                b.nr_bordero_rec,
                b.nr_interno_conta,
                b.nr_seq_nota_fiscal,
                b.nr_seq_titulo_pagar,
                b.nr_seq_titulo_receber,
                f.nr_seq_cheque,
                c.ds_banco,
                b.nr_seq_cheque_cp,
                substr(obter_descricao_padrao('TITULO_PAGAR','DS_COMPL_CONTAB',b.nr_seq_titulo_pagar),1,255) ds_compl_contab_cp,
                0 cd_estabelecimento,
                b.nr_seq_caixa_od,
                b.nr_seq_movto_cartao,
                b.nr_seq_banco_od,
                coalesce(obter_pessoa_titulo_pagar(b.nr_seq_titulo_pagar), obter_pessoa_titulo_receber(b.nr_seq_titulo_receber)),
                '' cd_conta_deb_pls,
                '' cd_conta_rec_pls,
                (null)::numeric  cd_historico_pls,
                (null)::numeric  nr_seq_produto,
                f.nr_seq_cheque nr_seq_cheque_dep,
                coalesce(b.ie_estorno,'N') ie_estorno,
                CASE WHEN coalesce(d.ie_agrupa_lote_cb,ie_agrupa_w)='N' THEN  coalesce(b.nr_seq_movto_orig,0)  ELSE 0 END  nr_seq_movto_orig,
                coalesce(b.nr_seq_banco_escrit,0) nr_seq_banco_escrit,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                null nr_seq_liq_cc,
                b.nr_seq_proj_rec,
                null ie_lote_pro_rata,
                b.nr_seq_movto_transf_bco,
                obter_movto_banco_pend(b.nr_sequencia) nr_seq_movto_banco_pend,
                b.nr_seq_parc_cartao,
                b.nr_seq_lote_cartao,
                substr(obter_movto_banco_pend_orig(b.nr_sequencia),1,10) nr_seq_cni,
                b.nr_sequencia,
                null nr_seq_deposito,
                null cd_tipo_baixa,
                null nr_seq_baixa_cr,
                b.nr_seq_perda,
                b.nr_seq_cobr_escrit nr_seq_cobr_escrit,
                'CHEQUE_CR',--'MOVTO_TRANS_FINANC',
                null cd_tributo,
                5 nr_seq_info_ctb,
                g.nr_seq_cheque,
                b.nr_seq_concil,
                b.cd_moeda,
                substr(obter_movto_banco_pend_orig(b.nr_seq_movto_orig), 1, 10) nr_seq_cni_orig
        FROM cheque_cr g, deposito_cheque f, transacao_financeira d, movto_trans_financ b
LEFT OUTER JOIN movto_trans_financ_cc e ON (b.nr_sequencia = e.nr_seq_movto_trans)
, banco_saldo a
LEFT OUTER JOIN banco_estabelecimento_v c ON (a.nr_seq_conta = c.nr_sequencia)
WHERE b.nr_lote_contabil      = nr_lote_contabil_p  and a.nr_sequencia          = b.nr_seq_saldo_banco and f.nr_seq_cheque         = g.nr_seq_cheque and f.nr_seq_deposito       = b.nr_seq_deposito and b.nr_seq_trans_financ   = d.nr_sequencia  and d.ie_banco              in ('D','C','T') and (b.nr_seq_trans_financ IS NOT NULL AND b.nr_seq_trans_financ::text <> '') and d.ie_contab_cb          = 'S'
         
union all

        select  CASE WHEN a.ie_acao='I' THEN  x.vl_recebido  ELSE x.vl_recebido * -1 END ,
                a.nr_seq_trans_fin,
                a.dt_recebimento,
                'VL_REC_PLS',
                a.nr_seq_conta_banco,
                b.cd_cgc,
                '' cd_conta_contabil,
                x.cd_centro_custo,
                b.nr_documento || ' (' || to_char(a.nr_titulo) || ')',
                'T',
                CASE WHEN ie_agrupa_w='N' THEN  a.nr_titulo  ELSE 0 END ,
                ' ' ds_historico,
                b.cd_pessoa_fisica,
                ' ' cd_conta_contabil_banco,
                0 cd_historico_banco,
                substr(coalesce(c.ds_interno,obter_banco_e_conta(c.nr_sequencia)),1,255) ds_banco_conta,
                substr(obter_nome_pf_pj(b.cd_pessoa_fisica,b.cd_cgc),1,255) ds_hist_pf_pj,
                'S' ie_contab,
                a.nr_bordero nr_bordero,
                a.nr_titulo,
                coalesce(to_char(b.nr_documento),''),
                0 nr_adiantamento,
                null,
                0 nr_adiant_pago,
                0 nr_bordero_rec,
                0 nr_interno_conta,
                0 nr_seq_nota_fiscal,
                0 nr_seq_titulo_pagar,
                b.nr_titulo nr_seq_titulo_receber, /*Matheus 05/05/2009 Troquei estava trazendo TITREC em TITPAG*/
                0 nr_seq_cheque,
                '' ds_banco,
                0 nr_seq_cheque_cp,
                '' ds_compl_contab_cp,
                b.cd_estabelecimento,
                0,
                0,
                0,
                obter_pessoa_titulo_receber(b.nr_titulo),
                x.cd_conta_deb_pls,
                x.cd_conta_rec_pls,
                x.cd_historico_pls,
                x.nr_seq_produto,
                (null)::numeric  nr_seq_cheque_dep,
                '' ie_estorno,
                0 nr_seq_movto_orig,
                0 nr_seq_banco_escrit,
                x.vl_antecipacao_mens,
                'B' ie_lote_antecip_pls,
                a.dt_referencia_pls_mens,
                a.nr_sequencia,
                x.nr_sequencia nr_seq_liq_cc,
                b.nr_seq_proj_rec,
                CASE WHEN x.ie_lote_pro_rata='BA' THEN x.ie_lote_pro_rata  ELSE null END ,
                null,
                null,
                null,
                null,
                to_char(null) nr_seq_cni,
                a.nr_seq_movto_trans_fin nr_seq_movto_trans_fin,
                null nr_seq_deposito,
                null cd_tipo_baixa,
                null nr_seq_baixa_cr,
                null nr_seq_perda,
                0 nr_seq_cobr_escrit,
                'TITULO_REC_LIQ_CC',
                null cd_tributo,
                14 nr_seq_info_ctb,
                x.nr_sequencia,
                null,
                x.cd_moeda,
                to_char(null) nr_seq_cni_orig
        FROM titulo_rec_liq_cc x, titulo_receber b, titulo_receber_liq a
LEFT OUTER JOIN banco_estabelecimento_v c ON (a.nr_seq_conta_banco = c.nr_sequencia)
WHERE a.nr_lote_contabil      = nr_lote_contabil_p and a.vl_recebido           <> 0 and a.nr_titulo             = b.nr_titulo and a.nr_titulo             = x.nr_titulo and a.nr_sequencia          = x.nr_seq_baixa and b.cd_estabelecimento    = cd_estabelecimento_w and coalesce(ie_lib_caixa, 'S')  = 'S' and ie_contab_cr_no_cb_w    = 'S' and (b.nr_seq_mensalidade IS NOT NULL AND b.nr_seq_mensalidade::text <> '') and (ie_contab_classif_mens_w = 'N' or
                not exists (select 1
                                from    pls_titulo_rec_liq_mens z
                                where   z.nr_titulo     = b.nr_titulo
                                and     z.nr_seq_baixa  = a.nr_sequencia))  
union all

        /* Francisco - 26/05/2010 -  220155 */

        select  CASE WHEN a.ie_acao='I' THEN  x.vl_recebido  ELSE x.vl_recebido * -1 END ,
                a.nr_seq_trans_fin,
                a.dt_recebimento,
                'VL_REC_PLS',
                a.nr_seq_conta_banco,
                b.cd_cgc,
                '' cd_conta_contabil,
                x.cd_centro_custo,
                b.nr_documento || ' (' || to_char(a.nr_titulo) || ')',
                'T',
                CASE WHEN ie_agrupa_w='N' THEN  a.nr_titulo  ELSE 0 END ,
                ' ' ds_historico,
                b.cd_pessoa_fisica,
                ' ' cd_conta_contabil_banco,
                0 cd_historico_banco,
                substr(coalesce(c.ds_interno,obter_banco_e_conta(c.nr_sequencia)),1,255) ds_banco_conta,
                substr(obter_nome_pf_pj(b.cd_pessoa_fisica,b.cd_cgc),1,255) ds_hist_pf_pj,
                'S' ie_contab,
                obter_bordero_tit_rec(a.nr_titulo) nr_bordero,
                a.nr_titulo,
                coalesce(to_char(b.nr_documento),''),
                0 nr_adiantamento,
                NULL,
                0 nr_adiant_pago,
                0 nr_bordero_rec,
                0 nr_interno_conta,
                0 nr_seq_nota_fiscal,
                0 nr_seq_titulo_pagar,
                b.nr_titulo nr_seq_titulo_receber, /*Matheus 05/05/2009 Troquei estava trazendo TITREC em TITPAG*/
                0 nr_seq_cheque,
                '' ds_banco,
                0 nr_seq_cheque_cp,
                '' ds_compl_contab_cp,
                b.cd_estabelecimento,
                0,
                0,
                0,
                obter_pessoa_titulo_receber(b.nr_titulo),
                x.cd_conta_deb_pls,
                x.cd_conta_rec_pls,
                x.cd_historico_pls,
                x.nr_seq_produto,
                (null)::numeric  nr_seq_cheque_dep,
                '' ie_estorno,
                0 nr_seq_movto_orig,
                0 nr_seq_banco_escrit,
                x.vl_antecipacao_mens,
                'P' ie_lote_antecip_pls,
                a.dt_referencia_pls_mens,
                a.nr_sequencia,
                x.nr_sequencia nr_seq_liq_cc,
                b.nr_seq_proj_rec,
                CASE WHEN x.ie_lote_pro_rata='PR' THEN x.ie_lote_pro_rata  ELSE null END ,
                null,
                null,
                null,
                null,
                to_char(null) nr_seq_cni,
                a.nr_seq_movto_trans_fin nr_seq_movto_trans_fin,
                null nr_seq_deposito,
                null cd_tipo_baixa,
                null nr_seq_baixa_cr,
                null nr_seq_perda,
                0 nr_seq_cobr_escrit,
                'TITULO_REC_LIQ_CC',
                null cd_tributo,
                14 nr_seq_info_ctb,
                x.nr_sequencia,
                null,
                x.cd_moeda,
                to_char(null) nr_seq_cni_orig
        FROM titulo_rec_liq_cc x, titulo_receber b, titulo_receber_liq a
LEFT OUTER JOIN banco_estabelecimento_v c ON (a.nr_seq_conta_banco = c.nr_sequencia)
WHERE a.nr_lote_contab_pro_rata = nr_lote_contabil_p and a.vl_recebido           <> 0 and a.nr_titulo             = b.nr_titulo and a.nr_titulo             = x.nr_titulo and a.nr_sequencia          = x.nr_seq_baixa and b.cd_estabelecimento    = cd_estabelecimento_w and coalesce(ie_lib_caixa, 'S')  = 'S' and ie_contab_cr_no_cb_w    = 'S' and (b.nr_seq_mensalidade IS NOT NULL AND b.nr_seq_mensalidade::text <> '') and (ie_contab_classif_mens_w = 'N' or
                not exists (select 1
                                from    pls_titulo_rec_liq_mens z
                                where   z.nr_titulo = b.nr_titulo
                                and     z.nr_seq_baixa = a.nr_sequencia))  
union all


        select  CASE WHEN a.ie_acao='I' THEN  x.vl_recebido  ELSE x.vl_recebido * -1 END ,
                a.nr_seq_trans_fin,
                a.dt_recebimento,
                'VL_REC_PLS',
                a.nr_seq_conta_banco,
                b.cd_cgc,
                '' cd_conta_contabil,
                x.cd_centro_custo,
                b.nr_documento || ' (' || to_char(a.nr_titulo) || ')',
                'T',
                CASE WHEN ie_agrupa_w='N' THEN  a.nr_titulo  ELSE 0 END ,
                ' ' ds_historico,
                b.cd_pessoa_fisica,
                ' ' cd_conta_contabil_banco,
                0 cd_historico_banco,
                substr(coalesce(c.ds_interno,obter_banco_e_conta(c.nr_sequencia)),1,255) ds_banco_conta,
                substr(obter_nome_pf_pj(b.cd_pessoa_fisica,b.cd_cgc),1,255) ds_hist_pf_pj,
                'S' ie_contab,
                obter_bordero_tit_rec(a.nr_titulo) nr_bordero,
                a.nr_titulo,
                coalesce(to_char(b.nr_documento),''),
                0 nr_adiantamento,
                null,
                0 nr_adiant_pago,
                0 nr_bordero_rec,
                0 nr_interno_conta,
                0 nr_seq_nota_fiscal,
                0 nr_seq_titulo_pagar,
                b.nr_titulo nr_seq_titulo_receber, /*Matheus 05/05/2009 Troquei estava trazendo TITREC em TITPAG*/
                0 nr_seq_cheque,
                '' ds_banco,
                0 nr_seq_cheque_cp,
                '' ds_compl_contab_cp,
                b.cd_estabelecimento,
                0,
                0,
                0,
                obter_pessoa_titulo_receber(b.nr_titulo),
                x.cd_conta_deb_pls,
                x.cd_conta_rec_pls,
                x.cd_historico_pls,
                x.nr_seq_produto,
                (null)::numeric  nr_seq_cheque_dep,
                '' ie_estorno,
                0 nr_seq_movto_orig,
                0 nr_seq_banco_escrit,
                x.vl_antecipacao_mens,
                'A' ie_lote_antecip_pls,
                a.dt_referencia_pls_mens,
                a.nr_sequencia,
                x.nr_sequencia nr_seq_liq_cc,
                b.nr_seq_proj_rec,
                CASE WHEN x.ie_lote_pro_rata='AN' THEN x.ie_lote_pro_rata  ELSE null END ,
                null,
                null,
                null,
                null,
                to_char(null) nr_seq_cni,
                a.nr_seq_movto_trans_fin nr_seq_movto_trans_fin,
                null nr_seq_deposito,
                null cd_tipo_baixa,
                null nr_seq_baixa_cr,
                null nr_seq_perda,
                0 nr_seq_cobr_escrit,
                'TITULO_REC_LIQ_CC',
                null cd_tributo,
                14 nr_seq_info_ctb,
                x.nr_sequencia,
                null,
                x.cd_moeda,
                to_char(null) nr_seq_cni_orig
        FROM titulo_rec_liq_cc x, titulo_receber b, titulo_receber_liq a
LEFT OUTER JOIN banco_estabelecimento_v c ON (a.nr_seq_conta_banco = c.nr_sequencia)
WHERE a.nr_lote_contab_antecip = nr_lote_contabil_p and a.vl_recebido           <> 0 and a.nr_titulo             = b.nr_titulo and a.nr_titulo             = x.nr_titulo and a.nr_sequencia          = x.nr_seq_baixa and b.cd_estabelecimento    = cd_estabelecimento_w and coalesce(ie_lib_caixa, 'S')  = 'S' and ie_contab_cr_no_cb_w    = 'S' and (b.nr_seq_mensalidade IS NOT NULL AND b.nr_seq_mensalidade::text <> '') and (ie_contab_classif_mens_w = 'N' or
                not exists (select 1
                                from    pls_titulo_rec_liq_mens z
                                where   z.nr_titulo = b.nr_titulo
                                and     z.nr_seq_baixa = a.nr_sequencia))  
union all

        select  CASE WHEN a.ie_acao='I' THEN  c.vl_lancamento  ELSE c.vl_lancamento * -1 END ,
                a.nr_seq_trans_fin,
                a.dt_recebimento,
                'VL_REC_PLS_MENS',
                a.nr_seq_conta_banco,
                b.cd_cgc,
                '' cd_conta_contabil,
                c.cd_centro_custo,
                b.nr_documento || ' (' || to_char(a.nr_titulo) || ')',
                'T',
                CASE WHEN ie_agrupa_w='N' THEN  a.nr_titulo  ELSE a.nr_seq_movto_trans_fin END ,
                ' ' ds_historico,
                b.cd_pessoa_fisica,
                ' ' cd_conta_contabil_banco,
                0 cd_historico_banco,
                substr(coalesce(e.ds_interno,obter_banco_e_conta(e.nr_sequencia)),1,255) ds_banco_conta,
                substr(obter_nome_pf_pj(b.cd_pessoa_fisica,b.cd_cgc),1,255) ds_hist_pf_pj,
                'S' ie_contab,
                obter_bordero_tit_rec(a.nr_titulo) nr_bordero,
                a.nr_titulo,
                coalesce(to_char(b.nr_documento),''),
                0 nr_adiantamento,
                null,
                0 nr_adiant_pago,
                0 nr_bordero_rec,
                0 nr_interno_conta,
                0 nr_seq_nota_fiscal,
                0 nr_seq_titulo_pagar,
                b.nr_titulo nr_seq_titulo_receber,
                0 nr_seq_cheque,
                '' ds_banco,
                0 nr_seq_cheque_cp,
                '' ds_compl_contab_cp,
                b.cd_estabelecimento,
                0,
                0,
                0,
                obter_pessoa_titulo_receber(b.nr_titulo),
                c.cd_conta_debito,
                c.cd_conta_credito,
                c.cd_historico,
                (null)::numeric  nr_seq_produto,
                (null)::numeric  nr_seq_cheque_dep,
                '' ie_estorno,
               	CASE WHEN coalesce(f.ie_agrupa_lote_cb,'S')='N' THEN  coalesce((select    max(x.nr_seq_movto_orig)                                                                from    movto_trans_financ      x                                                                where   x.nr_sequencia  = a.nr_seq_movto_trans_fin),0)  ELSE 0 END  nr_seq_movto_orig,
                0 nr_seq_banco_escrit,
                (null)::numeric  vl_antecipacao_mens,
                'A' ie_lote_antecip_pls,
                CASE WHEN c.ie_tipo_lancamento='EA' THEN  c.dt_contabil  ELSE to_date(null) END   dt_referencia_pls_mens,
                a.nr_sequencia,
                c.nr_sequencia nr_seq_liq_cc,
                b.nr_seq_proj_rec,
                CASE WHEN c.ie_tipo_lancamento='PR' THEN 'AN'  ELSE null END ,
                null,
                null,
                null,
                null,
                to_char(null) nr_seq_cni,
                a.nr_seq_movto_trans_fin nr_seq_movto_trans_fin,
                null nr_seq_deposito,
                null cd_tipo_baixa,
                null nr_seq_baixa_cr,
                null nr_seq_perda,
                0 nr_seq_cobr_escrit,
                'PLS_TITULO_REC_LIQ_MENS',
                null cd_tributo,
                14 nr_seq_info_ctb,
                c.nr_sequencia,
                null,
                b.cd_moeda,
                to_char(null) nr_seq_cni_orig
        FROM pls_mensalidade_seg_item d, pls_titulo_rec_liq_mens c, titulo_receber b, titulo_receber_liq a
LEFT OUTER JOIN transacao_financeira f ON (a.nr_seq_trans_fin = f.nr_sequencia)
LEFT OUTER JOIN banco_estabelecimento_v e ON (a.nr_seq_conta_banco = e.nr_sequencia)
WHERE a.nr_titulo             = b.nr_titulo and a.nr_titulo             = c.nr_titulo and a.nr_sequencia          = c.nr_seq_baixa and c.nr_seq_item_mens      = d.nr_sequencia  and c.nr_lote_contabil      = nr_lote_contabil_p and ie_contab_classif_mens_w        = 'S' and ie_contab_cr_no_cb_w            = 'S'  
union all

        select  a.vl_parcela,
                c.nr_seq_trans_financ,
                a.dt_parcela,
                'VL_PARCELA_CARTAO',
                c.nr_seq_banco nr_seq_conta_banco,
                '' cd_cgc,
                '' cd_conta_contabil,
                null cd_centro_custo,
                '',
                'T',
                0,
                ' ' ds_historico,
                b.cd_pessoa_fisica,
                ' ' cd_conta_contabil_banco,
                0 cd_historico_banco,
                substr(coalesce(d.ds_interno,obter_banco_e_conta(d.nr_sequencia)),1,255) ds_banco_conta,
                '',
                'S' ie_contab,
                null,
                null,
                '',
                0 nr_adiantamento,
                null,
                0 nr_adiant_pago,
                0 nr_bordero_rec,
                0 nr_interno_conta,
                0 nr_seq_nota_fiscal,
                0 nr_seq_titulo_pagar,
                null  nr_seq_titulo_receber,
                0 nr_seq_cheque,
                '' ds_banco,
                0 nr_seq_cheque_cp,
                '' ds_compl_contab_cp,
                b.cd_estabelecimento,
                0,
                c.nr_seq_movto_cartao,
                0,
                null,
                null,
                null,
                null,
                (null)::numeric  nr_seq_produto,
                (null)::numeric  nr_seq_cheque_dep,
                '' ie_estorno,
                0 nr_seq_movto_orig,
                0 nr_seq_banco_escrit,
                (null)::numeric  vl_antecipacao_mens,
                'A' ie_lote_antecip_pls,
                clock_timestamp()  dt_referencia_pls_mens,
                null ,
                null nr_seq_liq_cc,
                c.nr_seq_proj_rec,
                null,
                null,
                null,
                null,
                null,
                to_char(null) nr_seq_cni,
                c.nr_sequencia nr_seq_movto_trans_fin,
                null nr_seq_deposito,
                null cd_tipo_baixa,
                null nr_seq_baixa_cr,
                null nr_seq_perda,
                0 nr_seq_cobr_escrit,
                'MOVTO_CARTAO_CR_PARCELA',
                null cd_tributo,
                5 nr_seq_info_ctb,
                a.nr_sequencia,
                null,
                c.cd_moeda,
                to_char(null) nr_seq_cni_orig
        FROM movto_cartao_cr b, movto_cartao_cr_parcela a, movto_trans_financ c
LEFT OUTER JOIN banco_estabelecimento_v d ON (c.nr_seq_banco = d.nr_sequencia)
WHERE a.nr_seq_movto = b.nr_sequencia --and   b.nr_seq_caixa_rec      is not null
  and (c.nr_seq_movto_cartao IS NOT NULL AND c.nr_seq_movto_cartao::text <> '') and c.nr_seq_movto_cartao = b.nr_sequencia and coalesce(b.nr_seq_caixa_rec::text, '') = '' and a.nr_lote_contabil      = nr_lote_contabil_p and ie_contab_desp_cartao_w = 'S'  
union all

        select  a.vl_despesa,
                c.nr_seq_trans_financ,
                b.dt_transacao,
                'VL_DESPESA_CARTAO',
                c.nr_seq_banco nr_seq_conta_banco,
                '' cd_cgc,
                '' cd_conta_contabil,
                null cd_centro_custo,
                '',
                'T',
                0,
                ' ' ds_historico,
                b.cd_pessoa_fisica,
                ' ' cd_conta_contabil_banco,
                0 cd_historico_banco,
                substr(coalesce(d.ds_interno,obter_banco_e_conta(d.nr_sequencia)),1,255) ds_banco_conta,
                '',
                'S' ie_contab,
                null,
                null,
                '',
                c.nr_adiantamento,
                null,
                c.nr_adiant_pago,
                0 nr_bordero_rec,
                0 nr_interno_conta,
                0 nr_seq_nota_fiscal,
                0 nr_seq_titulo_pagar,
                null  nr_seq_titulo_receber,
                0 nr_seq_cheque,
                '' ds_banco,
                0 nr_seq_cheque_cp,
                '' ds_compl_contab_cp,
                b.cd_estabelecimento,
                0,
                c.nr_seq_movto_cartao,
                0,
                null,
                null,
                null,
                null,
                (null)::numeric  nr_seq_produto,
                (null)::numeric  nr_seq_cheque_dep,
                '' ie_estorno,
                0 nr_seq_movto_orig,
                0 nr_seq_banco_escrit,
                (null)::numeric  vl_antecipacao_mens,
                'A' ie_lote_antecip_pls,
                clock_timestamp()  dt_referencia_pls_mens,
                null ,
                null nr_seq_liq_cc,
                c.nr_seq_proj_rec,
                null,
                null,
                null,
                null,
                null,
                to_char(null) nr_seq_cni,
                c.nr_sequencia nr_seq_movto_trans_fin,
                null nr_seq_deposito,
                null cd_tipo_baixa,
                null nr_seq_baixa_cr,
                null nr_seq_perda,
                0 nr_seq_cobr_escrit,
                'MOVTO_CARTAO_CR_PARCELA',
                null cd_tributo,
                5 nr_seq_info_ctb,
                a.nr_sequencia,
                c.nr_seq_concil,
                c.cd_moeda,
                to_char(null) nr_seq_cni_orig
        FROM movto_cartao_cr b, movto_cartao_cr_parcela a, movto_trans_financ c
LEFT OUTER JOIN banco_estabelecimento_v d ON (c.nr_seq_banco = d.nr_sequencia)
WHERE a.nr_seq_movto = b.nr_sequencia and a.nr_lote_contabil      = nr_lote_contabil_p and coalesce(b.nr_seq_caixa_rec::text, '') = '' and c.nr_seq_movto_cartao = b.nr_sequencia and (c.nr_seq_movto_cartao IS NOT NULL AND c.nr_seq_movto_cartao::text <> '') and ie_contab_desp_cartao_w = 'S' and ie_forma_lanc_lote_cartao_w = 'P'  
union all

        select  a.vl_despesa,
                c.nr_seq_trans_financ,
                b.dt_transacao,
                'VL_DESPESA_CARTAO',
                c.nr_seq_banco nr_seq_conta_banco,
                '' cd_cgc,
                '' cd_conta_contabil,
                null cd_centro_custo,
                '',
                'T',
                0,
                ' ' ds_historico,
                b.cd_pessoa_fisica,
                ' ' cd_conta_contabil_banco,
                0 cd_historico_banco,
                substr(coalesce(e.ds_interno,obter_banco_e_conta(e.nr_sequencia)),1,255) ds_banco_conta,
                '',
                'S' ie_contab,
                null,
                null,
                '',
                c.nr_adiantamento,
                null,
                c.nr_adiant_pago,
                0 nr_bordero_rec,
                0 nr_interno_conta,
                0 nr_seq_nota_fiscal,
                0 nr_seq_titulo_pagar,
                null  nr_seq_titulo_receber,
                0 nr_seq_cheque,
                '' ds_banco,
                0 nr_seq_cheque_cp,
                '' ds_compl_contab_cp,
                b.cd_estabelecimento,
                0,
                c.nr_seq_movto_cartao,
                0,
                null,
                null,
                null,
                null,
                (null)::numeric  nr_seq_produto,
                (null)::numeric  nr_seq_cheque_dep,
                '' ie_estorno,
                0 nr_seq_movto_orig,
                0 nr_seq_banco_escrit,
                (null)::numeric  vl_antecipacao_mens,
                'A' ie_lote_antecip_pls,
                clock_timestamp()  dt_referencia_pls_mens,
                null ,
                null nr_seq_liq_cc,
                c.nr_seq_proj_rec,
                null,
                null,
                null,
                null,
                c.nr_seq_lote_cartao,
                to_char(null) nr_seq_cni,
                c.nr_sequencia nr_seq_movto_trans_fin,
                null nr_seq_deposito,
                null cd_tipo_baixa,
                null nr_seq_baixa_cr,
                null nr_seq_perda,
                0 nr_seq_cobr_escrit,
                'MOVTO_CARTAO_CR_PARCELA',
                null cd_tributo,
                5 nr_seq_info_ctb,
                a.nr_sequencia,
                c.nr_seq_concil,
                c.cd_moeda,
                to_char(null) nr_seq_cni_orig
        FROM lote_baixa_cartao_cr d, movto_cartao_cr b, movto_cartao_cr_parcela a, movto_trans_financ c
LEFT OUTER JOIN banco_estabelecimento_v e ON (c.nr_seq_banco = e.nr_sequencia)
WHERE a.nr_seq_movto = b.nr_sequencia and d.nr_sequencia      = a.nr_seq_lote and d.nr_sequencia      = c.nr_seq_lote_cartao and a.nr_lote_contabil      = nr_lote_contabil_p and coalesce(b.nr_seq_caixa_rec::text, '') = '' and ie_contab_desp_cartao_w = 'S' and ie_forma_lanc_lote_cartao_w = 'L'  
union all

        select  i.vl_imposto,
                b.nr_seq_trans_fin,
                b.dt_baixa,
                'VL_PROV_TRIBUTO',
                null nr_seq_conta_banco,
                r.cd_cgc,
                '' cd_conta_contabil,
                null cd_centro_custo,
                r.nr_documento || ' (' || to_char(r.nr_titulo) || ')',
                'T',
                0,
                ' ' ds_historico,
                r.cd_pessoa_fisica,
                ' ' cd_conta_contabil_banco,
                0 cd_historico_banco,
                ' ' ds_banco_conta,
                obter_pessoa_titulo_pagar(r.nr_titulo) ,
                'S' ie_contab,
                b.nr_bordero,
                r.nr_titulo,
                coalesce(to_char(r.nr_documento),''),
                0 nr_adiantamento,
                null,
                0 nr_adiant_pago,
                0 nr_bordero_rec,
                0 nr_interno_conta,
                r.nr_seq_nota_fiscal nr_seq_nota_fiscal,
                r.nr_titulo nr_seq_titulo_pagar,
                null  nr_seq_titulo_receber,
                0 nr_seq_cheque,
                '' ds_banco,
                0 nr_seq_cheque_cp,
                r.ds_compl_contab ds_compl_contab_cp,
                r.cd_estabelecimento,
                0,
                0,
                0,
                obter_pessoa_titulo_pagar(r.nr_titulo),
                null,
                null,
                null,
                (null)::numeric  nr_seq_produto,
                (null)::numeric  nr_seq_cheque_dep,
                '' ie_estorno,
                0 nr_seq_movto_orig,
                0 nr_seq_banco_escrit,
                (null)::numeric  vl_antecipacao_mens,
                'A' ie_lote_antecip_pls,
                clock_timestamp()  dt_referencia_pls_mens,
                null ,
                null nr_seq_liq_cc,
                r.nr_seq_proj_rec,
                null,
                null,
                null,
                null,
                null,
                to_char(null) nr_seq_cni,
                b.nr_seq_movto_trans_fin nr_seq_movto_trans_fin,
                null nr_seq_deposito,
                null cd_tipo_baixa,
                null nr_seq_baixa_cr,
                null nr_seq_perda,
                0 nr_seq_cobr_escrit,
                'TITULO_PAGAR_IMPOSTO',
                i.cd_tributo,
                59 nr_seq_info_ctb,
                i.nr_sequencia,
                null,
                b.cd_moeda,
                to_char(null) nr_seq_cni_orig
        from    titulo_pagar_baixa      b,
                titulo_pagar r,
                tributo t,
                titulo_pagar_imposto i
        where   i.cd_tributo                    = t.cd_tributo
        and     r.nr_titulo                     = i.nr_titulo
        and     b.nr_titulo                     = r.nr_titulo
        and     i.nr_seq_baixa                  = b.nr_sequencia
        and     i.nr_lote_contabil              = nr_lote_contabil_p
        and     t.ie_contab_prov_cp             = 'S'
        and     ie_contab_prov_tributo_w        = 'S'
        
union all

        /* ***************************************************** */


        /* INICIO - CONTABILIZACAO TRIBUTO PAGAR MEXICO - INICIO */


        /* NULL = varchar2 nulo | to_number(null) = numero nulo | to_date(null) = data nula */


        /* Oracle faz conversao implicita de tipos de dado caso nao feito manualmente, porem pode ocorrer erro se deixar a cargo do banco */


        /* ***************************************************** */

        select  d.vl_baixa,                                                     -- VL_TRANSACAO_W,
                b.nr_seq_trans_fin,                                             -- NR_SEQ_TRANS_FIN_W,
                d.dt_contabil,                                                  -- DT_MOVIMENTO_W,
                'VL_TRIBUTO_PAGAR',                                             -- NM_ATRIBUTO_W,
                b.nr_seq_conta_banco,                                           -- NR_SEQ_CONTA_BANCO_W,
                a.cd_cgc,                                                       -- CD_CGC_W,
                null cd_conta_contabil,                                         -- CD_CONTA_CONTABIL_W,
                null cd_centro_custo,                                           -- CD_CENTRO_CUSTO_W,
                a.nr_documento || ' (' || to_char(a.nr_titulo) || ')',          -- NR_DOCUMENTO_W,
                'T',                                                            -- IE_DEBITO_CREDITO_W,
                0,                                                              -- NR_SEQ_TRANS_W,
                '' ds_historico,                                                -- DS_HISTORICO_W,
                a.cd_pessoa_fisica,                                             -- CD_PESSOA_FISICA_W,
                ' ' cd_conta_contabil_banco,                                    -- CD_CONTA_CONTABIL_BANCO_W,
                0 cd_historico_banco,                                           -- CD_HISTORICO_W,
                '' ds_banco_conta,                                              -- DS_BANCO_CONTA_W,
                substr(obter_pessoa_titulo_pagar(a.nr_titulo),1,255) ,          -- DS_HIST_PF_PJ_W,
                'S' ie_contab,                                                  -- IE_CONTAB_W,
                (null)::numeric ,/* b.nr_bordero,*/
                              -- NR_BORDERO_W,
                a.nr_titulo,                                                    -- NR_TITULO_W,
                to_char(a.nr_documento),                                        -- NR_DOC_W,
                0 nr_adiantamento,                                              -- NR_ADIANTAMENTO_W,
                (null)::numeric ,                                                -- CD_HISTORICO_MOVTO_W,
                0 nr_adiant_pago,                                               -- NR_ADIANT_PAGO_W,
                0 nr_bordero_rec,                                               -- NR_BORDERO_REC_W,
                0 nr_interno_conta,                                             -- NR_INTERNO_CONTA_W,
                a.nr_seq_nota_fiscal nr_seq_nota_fiscal,                        -- NR_SEQ_NOTA_FISCAL_W,
                a.nr_titulo nr_seq_titulo_pagar,                                -- NR_SEQ_TITULO_PAGAR_W,
                (null)::numeric  nr_seq_titulo_receber,                          -- NR_SEQ_TITULO_RECEBER_W,
                0 nr_seq_cheque,                                                -- NR_SEQ_CHEQUE_W,
                null ds_banco,                                                  -- DS_BANCO_W,
                b.nr_seq_cheque_cp nr_seq_cheque_cp,                            -- NR_SEQ_CHEQUE_CP_W,
                a.ds_compl_contab ds_compl_contab_cp,                           -- DS_COMPL_CONTAB_CP_W,
                a.cd_estabelecimento,                                           -- CD_ESTAB_MOVTO_W,
                0,                                                              -- NR_SEQ_CAIXA_OD_W,
                0,                                                              -- NR_SEQ_MOVTO_CARTAO_W,
                0,                                                              -- NR_SEQ_BANCO_OD_W,
                substr(obter_pessoa_titulo_pagar(a.nr_titulo),1,80),            -- DS_PESSOA_TITULO_W,
                null,                                                           -- CD_CONTA_DEB_PLS_W,
                null,                                                           -- CD_CONTA_REC_PLS_W,
                (null)::numeric ,                                                -- CD_HISTORICO_PLS_W,
                (null)::numeric  nr_seq_produto,                                 -- NR_SEQ_PRODUTO_W,
                (null)::numeric  nr_seq_cheque_dep,                              -- NR_SEQ_CHEQUE_DEP_W,
                CASE WHEN b.ie_origem_baixa='ET' THEN 'S'  ELSE null END  ie_estorno,             -- IE_ESTORNO_W,
                0 nr_seq_movto_orig,                                            -- NR_SEQ_MOVTO_ORIG_W,
                0 nr_seq_banco_escrit,                                          -- NR_SEQ_BANCO_ESCRIT_W,
                (null)::numeric  vl_antecipacao_mens,                            -- VL_ANTECIPACAO_MENS_W,
                'A' ie_lote_antecip_pls,                                        -- IE_TIPO_LOTE_PLS_W,
                clock_timestamp()  dt_referencia_pls_mens,                                -- DT_REFERENCIA_PLS_MENS_W,
                (null)::numeric ,                                                -- NR_SEQ_BAIXA_W,
                null nr_seq_liq_cc,                                             -- NR_SEQ_LIQ_CC_W,
                a.nr_seq_proj_rec,                                              -- NR_SEQ_PROJ_REC_W,
                null,                                                           -- IE_LOTE_PRO_RATA_W,
                (null)::numeric ,                                                -- NR_SEQ_MOVTO_TRANSF_BCO_W,
                (null)::numeric ,                                                -- NR_SEQ_MOVTO_BCO_PEND_W,
                (null)::numeric ,                                                -- NR_SEQ_PARC_CARTAO_W,
                (null)::numeric ,                                                -- NR_SEQ_LOTE_CARTAO_W,
                to_char(null) nr_seq_cni,                                       -- NR_SEQ_CNI_W,
                --to_number(null) nr_seq_movto_trans_fin,                       -- NR_SEQ_MOVTO_TRANS_FIN_W,
                b.nr_seq_movto_trans_fin nr_seq_movto_trans_fin,                -- NR_SEQ_MOVTO_TRANS_FIN_W,
                (null)::numeric  nr_seq_deposito,                                -- NR_SEQ_DEPOSITO_W,
                b.cd_tipo_baixa cd_tipo_baixa,                                  -- CD_TIPO_BAIXA_W,
                (null)::numeric  nr_seq_baixa_cr,                                -- NR_SEQ_BAIXA_CR_W,
                (null)::numeric  nr_seq_perda,                                   -- NR_SEQ_PERDA_W,
                0 nr_seq_cobr_escrit,                                           -- NR_SEQ_COBR_ESCRIT_W,
                'TITULO_PAGAR_TRIB_BAIXA',                                      -- NM_TABELA_W,
                c.cd_tributo,                                                   -- CD_TRIBUTO_WW,
                47 nr_seq_info_ctb, /* Titulo a pagar */
                        --  NR_SEQ_INFO_CTB_W,
                d.nr_sequencia,                                                 -- NR_SEQ_TAB_ORIG_W,
                (null)::numeric ,                                                -- NR_SEQ_CONCIL_W,
                b.cd_moeda,
                to_char(null) nr_seq_cni_orig                                    -- CD_MOEDA_W;
        from    titulo_pagar a,
                titulo_pagar_baixa b,
                titulo_pagar_imposto c,
                titulo_pagar_trib_baixa d
        where   a.nr_titulo = b.nr_titulo /* titulo com a baixa */
        and     a.nr_titulo = c.nr_titulo /* titulo com o imposto*/
        and     a.nr_titulo = d.nr_titulo /* titulo com o rateio da baixa */
        and     b.nr_sequencia = d.nr_seq_tit_baixa /* baixa com o rateio do imposto da baixa */
        and     c.nr_sequencia = d.nr_seq_tit_trib /* imposto com o rateio do imposto */

        -- and  b.NR_SEQ_CHEQUE_CP = e.NR_SEQUENCIA /* cheque com a baixa */

        -- and  f.NR_SEQ_CHEQUE_CP = e.NR_SEQUENCIA /* cheque com a trans financ */
        and     d.nr_lote_contabil = nr_lote_contabil_p
        
union all

        select  d.vl_baixa,                                                                                     -- VL_TRANSACAO_W,
                --d.nr_seq_trans_financ,                                                                          -- NR_SEQ_TRANS_FIN_W,
                b.nr_seq_trans_caixa,
                d.dt_contabil dt_transacao,                                                                     -- DT_MOVIMENTO_W,
                'VL_TRIBUTO_RECEBER',                                                                             -- NM_ATRIBUTO_W,
                b.nr_seq_conta_banco,                                                                                -- NR_SEQ_CONTA_BANCO_W,
                a.cd_cgc,                                                                                       -- CD_CGC_W,
                null cd_conta_contabil,                                                                         -- CD_CONTA_CONTABIL_W,
                (null)::numeric ,                                                                                -- CD_CENTRO_CUSTO_W,
                a.nr_documento || ' (' || to_char(c.nr_titulo) || ')',                                          -- NR_DOCUMENTO_W,
                'T',                                                                                            -- IE_DEBITO_CREDITO_W,
                0,                                                                                              -- NR_SEQ_TRANS_W,
                ' ' ds_historico,                                                                               -- DS_HISTORICO_W,
                a.cd_pessoa_fisica,                                                                             -- CD_PESSOA_FISICA_W,
                ' ' cd_conta_contabil_banco,                                                                    -- CD_CONTA_CONTABIL_BANCO_W,
                0 cd_historico_banco,                                                                           -- CD_HISTORICO_W,
                substr(coalesce(e.ds_interno,obter_banco_e_conta(e.nr_sequencia)),1,255) ds_banco_conta,             -- DS_BANCO_CONTA_W,
                substr(obter_nome_pf_pj(a.cd_pessoa_fisica,a.cd_cgc),1,255) ds_hist_pf_pj,                      -- DS_HIST_PF_PJ_W,
                'S' ie_contab,                                                                                  -- IE_CONTAB_W,
                obter_bordero_tit_rec(c.nr_titulo) nr_bordero,                                                  -- NR_BORDERO_W,
                c.nr_titulo,                                                                                    -- NR_TITULO_W,
                to_char(a.nr_documento),                                                                        -- NR_DOC_W,
                0 nr_adiantamento,                                                                              -- NR_ADIANTAMENTO_W,
                (null)::numeric ,                                                                                -- CD_HISTORICO_MOVTO_W,
                0 nr_adiant_pago,                                                                               -- NR_ADIANT_PAGO_W,
                0 nr_bordero_rec,                                                                               -- NR_BORDERO_REC_W,
                0 nr_interno_conta,                                                                             -- NR_INTERNO_CONTA_W,
                0 nr_seq_nota_fiscal,                                                                           -- NR_SEQ_NOTA_FISCAL_W,
                0 nr_seq_titulo_pagar,                                                                          -- NR_SEQ_TITULO_PAGAR_W,
                a.nr_titulo nr_seq_titulo_receber,                                                              -- NR_SEQ_TITULO_RECEBER_W,
                0 nr_seq_cheque,                                                                                -- NR_SEQ_CHEQUE_W,
                null ds_banco,                                                                                  -- DS_BANCO_W,
                0 nr_seq_cheque_cp,                                                                             -- NR_SEQ_CHEQUE_CP_W,
                null ds_compl_contab_cp,                                                                        -- DS_COMPL_CONTAB_CP_W,
                a.cd_estabelecimento,                                                                           -- CD_ESTAB_MOVTO_W,
                0,                                                                                              -- NR_SEQ_CAIXA_OD_W,
                0,                                                                                              -- NR_SEQ_MOVTO_CARTAO_W,
                0,                                                                                              -- NR_SEQ_BANCO_OD_W,
                obter_pessoa_titulo_receber(a.nr_titulo),                                                       -- DS_PESSOA_TITULO_W,
                null cd_conta_deb_pls,                                                                          -- CD_CONTA_DEB_PLS_W,
                null cd_conta_rec_pls,                                                                          -- CD_CONTA_REC_PLS_W,
                (null)::numeric  cd_historico_pls,                                                               -- CD_HISTORICO_PLS_W,
                (null)::numeric  nr_seq_produto,                                                                 -- NR_SEQ_PRODUTO_W,
                (null)::numeric  nr_seq_cheque_dep,                                                              -- NR_SEQ_CHEQUE_DEP_W,
                null ie_estorno,                                                                                -- IE_ESTORNO_W,
                c.nr_sequencia nr_seq_movto_orig,                                                               -- NR_SEQ_MOVTO_ORIG_W,
                0 nr_seq_banco_escrit,                                                                          -- NR_SEQ_BANCO_ESCRIT_W,
                (null)::numeric  vl_antecipacao_mens,                                                            -- VL_ANTECIPACAO_MENS_W,
                to_char(null) ie_lote_antecip_pls,                                                              -- IE_TIPO_LOTE_PLS_W,
                to_date(null) dt_referencia_pls_mens,                                                           -- DT_REFERENCIA_PLS_MENS_W,
                (null)::numeric  nr_seq_baixa,                                                                   -- NR_SEQ_BAIXA_W,
                (null)::numeric  nr_seq_liq_cc,                                                                  -- NR_SEQ_LIQ_CC_W,
                a.nr_seq_proj_rec,                                                                              -- NR_SEQ_PROJ_REC_W,
                null ie_lote_pro_rata,                                                                          -- IE_LOTE_PRO_RATA_W,
                (null)::numeric ,                                                                                -- NR_SEQ_MOVTO_TRANSF_BCO_W,
                (null)::numeric ,                                                                                -- NR_SEQ_MOVTO_BCO_PEND_W,
                (null)::numeric ,                                                                                -- NR_SEQ_PARC_CARTAO_W,
                (null)::numeric  nr_seq_lote_cartao,                                                             -- NR_SEQ_LOTE_CARTAO_W,
                to_char(null) nr_seq_cni,                                                                       -- NR_SEQ_CNI_W,
                null nr_seq_movto_trans_fin,                                                                    -- NR_SEQ_MOVTO_TRANS_FIN_W,
                null nr_seq_deposito,                                                                           -- NR_SEQ_DEPOSITO_W,
                null cd_tipo_baixa,                                                                             -- CD_TIPO_BAIXA_W,
                b.nr_sequencia nr_seq_baixa_cr,                                                                           -- NR_SEQ_BAIXA_CR_W,
                null nr_seq_perda,                                                                              -- NR_SEQ_PERDA_W,
                0 nr_seq_cobr_escrit,                                                                           -- NR_SEQ_COBR_ESCRIT_W,
                'TITULO_RECEBER_TRIB',                                                                          -- NM_TABELA_W,
                c.cd_tributo,                                                                                -- CD_TRIBUTO_WW,
                46 nr_seq_info_ctb, /* Titulo a receber */
                                                              --NR_SEQ_INFO_CTB_W,
                d.nr_sequencia,                                                                                -- NR_SEQ_TAB_ORIG_W,
                (null)::numeric ,                                                                                -- NR_SEQ_CONCIL_W,
                b.cd_moeda,
                to_char(null) nr_seq_cni_orig                                                                                       -- CD_MOEDA_W;
        FROM titulo_receber_trib_baixa d, titulo_receber_trib c, titulo_receber a, titulo_receber_liq b
LEFT OUTER JOIN banco_estabelecimento_v e ON (b.nr_seq_conta_banco = e.nr_sequencia)
WHERE d.nr_Lote_contabil      = nr_lote_contabil_p and a.nr_titulo             = b.nr_titulo and a.nr_titulo             = c.nr_titulo and a.nr_titulo             = d.nr_titulo and d.nr_seq_tit_liq        = b.nr_sequencia and d.nr_seq_tit_trib       = c.nr_sequencia  /* ***************************************************** */


        /* FIM - CONTABILIZACAO TRIBUTO PAGAR MEXICO - FIM */


        /* ***************************************************** */

 
union all

        select  CASE WHEN a.ie_acao='I' THEN  x.vl_recebido  ELSE x.vl_recebido * -1 END ,
                a.nr_seq_trans_fin,
                a.dt_recebimento,
                'VL_FATURAMENTO_OPS',
                a.nr_seq_conta_banco,
                b.cd_cgc,
                '' cd_conta_contabil,
                x.cd_centro_custo,
                b.nr_documento || ' (' || to_char(a.nr_titulo) || ')',
                'T' ie_banco,
                CASE WHEN ie_agrupa_w='N' THEN  a.nr_titulo  ELSE 0 END ,
                ' ' ds_historico,
                b.cd_pessoa_fisica,
                ' ' cd_conta_contabil_banco,
                0 cd_historico_banco,
                substr(coalesce(c.ds_interno,obter_banco_e_conta(c.nr_sequencia)),1,255) ds_banco_conta,
                substr(obter_nome_pf_pj(b.cd_pessoa_fisica,b.cd_cgc),1,255) ds_hist_pf_pj,
                'S' ie_contab,
                obter_bordero_tit_rec(a.nr_titulo) nr_bordero,
                a.nr_titulo,
                coalesce(to_char(b.nr_documento),''),
                0 nr_adiantamento,
                null,
                0 nr_adiant_pago,
                0 nr_bordero_rec,
                0 nr_interno_conta,
                0 nr_seq_nota_fiscal,
                0 nr_seq_titulo_pagar,
                b.nr_titulo nr_seq_titulo_receber,
                0 nr_seq_cheque,
                '' ds_banco,
                0 nr_seq_cheque_cp,
                '' ds_compl_contab_cp,
                b.cd_estabelecimento,
                0,
                0,
                0,
                obter_pessoa_titulo_receber(b.nr_titulo),
                null cd_conta_deb_pls,
                null cd_conta_rec_pls,
                null cd_historico_pls,
                null nr_seq_produto,
                (null)::numeric  nr_seq_cheque_dep,
                '' ie_estorno,
                0 nr_seq_movto_orig,
                0 nr_seq_banco_escrit,
                x.vl_antecipacao_mens,
                null ie_lote_antecip_pls,
                null dt_referencia_pls_mens,
                a.nr_sequencia,
                x.nr_sequencia nr_seq_liq_cc,
                b.nr_seq_proj_rec,
                null,
                null,
                null,
                null,
                null,
                to_char(null) nr_seq_cni,
                a.nr_seq_movto_trans_fin nr_seq_movto_trans_fin,
                null nr_seq_deposito,
                null cd_tipo_baixa,
                null nr_seq_baixa_cr,
                null nr_seq_perda,
                0 nr_seq_cobr_escrit,
                'TITULO_REC_LIQ_CC',
                null cd_tributo,
                14 nr_seq_info_ctb,
                x.nr_sequencia,
                null,
                x.cd_moeda,
                to_char(null) nr_seq_cni_orig
        FROM titulo_rec_liq_cc x, titulo_receber b, titulo_receber_liq a
LEFT OUTER JOIN banco_estabelecimento_v c ON (a.nr_seq_conta_banco = c.nr_sequencia)
WHERE a.nr_lote_contab_antecip = nr_lote_contabil_p and x.vl_recebido           <> 0 and a.nr_titulo             = b.nr_titulo and a.nr_titulo             = x.nr_titulo and a.nr_sequencia          = x.nr_seq_baixa and b.cd_estabelecimento    = cd_estabelecimento_w and ((ie_origem_classif = 'FO') or (b.ie_origem_titulo = 13 and (not exists (select 1 from pls_fatura w where (w.nr_titulo = b.nr_titulo or w.nr_titulo_ndc = b.nr_titulo))))) and coalesce(ie_lib_caixa, 'S')  = 'S'  
union all

        select  a.vl_liquido,
                b.nr_seq_trans_caixa,
                a.dt_parcela,
                'VL_LIQUIDO_CARTAO',
                null nr_seq_conta_banco,
                '' cd_cgc,
                '' cd_conta_contabil,
                null cd_centro_custo,
                '',
                'T',
                0,
                ' ' ds_historico,
                b.cd_pessoa_fisica,
                ' ' cd_conta_contabil_banco,
                0 cd_historico_banco,
                substr(coalesce(d.ds_interno,obter_banco_e_conta(d.nr_sequencia)),1,255) ds_banco_conta,
                '',
                'S' ie_contab,
                null,
                null,
                '',
                0 nr_adiantamento,
                null,
                0 nr_adiant_pago,
                0 nr_bordero_rec,
                0 nr_interno_conta,
                0 nr_seq_nota_fiscal,
                0 nr_seq_titulo_pagar,
                null  nr_seq_titulo_receber,
                0 nr_seq_cheque,
                '' ds_banco,
                0 nr_seq_cheque_cp,
                '' ds_compl_contab_cp,
                b.cd_estabelecimento,
                0,
                c.nr_seq_movto_cartao,
                0,
                null,
                null,
                null,
                null,
                (null)::numeric  nr_seq_produto,
                (null)::numeric  nr_seq_cheque_dep,
                '' ie_estorno,
                0 nr_seq_movto_orig,
                0 nr_seq_banco_escrit,
                (null)::numeric  vl_antecipacao_mens,
                'A' ie_lote_antecip_pls,
                clock_timestamp()  dt_referencia_pls_mens,
                null ,
                null nr_seq_liq_cc,
                c.nr_seq_proj_rec,
                null,
                null,
                null,
                null,
                null,
                to_char(null) nr_seq_cni,
                c.nr_sequencia nr_seq_movto_trans_fin,
                null nr_seq_deposito,
                null cd_tipo_baixa,
                null nr_seq_baixa_cr,
                null nr_seq_perda,
                0 nr_seq_cobr_escrit,
                'MOVTO_CARTAO_CR_PARCELA',
                null cd_tributo,
                5 nr_seq_info_ctb,
                a.nr_sequencia,
                null,
                c.cd_moeda,
                to_char(null) nr_seq_cni_orig
        FROM movto_cartao_cr b, movto_cartao_cr_parcela a, movto_trans_financ c
LEFT OUTER JOIN banco_estabelecimento_v d ON (c.nr_seq_banco = d.nr_sequencia)
WHERE a.nr_seq_movto = b.nr_sequencia and coalesce(b.nr_seq_caixa_rec::text, '') = '' and a.nr_lote_contabil      = nr_lote_contabil_p and c.nr_seq_movto_cartao = b.nr_sequencia and ie_contab_desp_cartao_w = 'S'  
union all

        select  a.vl_liquido,
                b.nr_seq_trans_caixa,
                b.dt_transacao,
                'VL_LIQUIDO_CARTAO_TR',
                null nr_seq_conta_banco,
                '' cd_cgc,
                '' cd_conta_contabil,
                null cd_centro_custo,
                '',
                'T',
                0,
                ' ' ds_historico,
                b.cd_pessoa_fisica,
                ' ' cd_conta_contabil_banco,
                0 cd_historico_banco,
                substr(coalesce(d.ds_interno,obter_banco_e_conta(d.nr_sequencia)),1,255) ds_banco_conta,
                '',
                'S' ie_contab,
                null,
                null,
                '',
                0 nr_adiantamento,
                null,
                0 nr_adiant_pago,
                0 nr_bordero_rec,
                0 nr_interno_conta,
                0 nr_seq_nota_fiscal,
                0 nr_seq_titulo_pagar,
                null  nr_seq_titulo_receber,
                0 nr_seq_cheque,
                '' ds_banco,
                0 nr_seq_cheque_cp,
                '' ds_compl_contab_cp,
                b.cd_estabelecimento,
                0,
                c.nr_seq_movto_cartao,
                0,
                null,
                null,
                null,
                null,
                (null)::numeric  nr_seq_produto,
                (null)::numeric  nr_seq_cheque_dep,
                '' ie_estorno,
                0 nr_seq_movto_orig,
                0 nr_seq_banco_escrit,
                (null)::numeric  vl_antecipacao_mens,
                'A' ie_lote_antecip_pls,
                clock_timestamp()  dt_referencia_pls_mens,
                null ,
                null nr_seq_liq_cc,
                c.nr_seq_proj_rec,
                null,
                null,
                null,
                null,
                null,
                to_char(null) nr_seq_cni,
                c.nr_sequencia nr_seq_movto_trans_fin,
                null nr_seq_deposito,
                null cd_tipo_baixa,
                null nr_seq_baixa_cr,
                null nr_seq_perda,
                0 nr_seq_cobr_escrit,
                'MOVTO_CARTAO_CR_PARCELA',
                null cd_tributo,
                5 nr_seq_info_ctb,
                a.nr_sequencia,
                null,
                c.cd_moeda,
                to_char(null) nr_seq_cni_orig
        FROM movto_cartao_cr b, movto_cartao_cr_parcela a, movto_trans_financ c
LEFT OUTER JOIN banco_estabelecimento_v d ON (c.nr_seq_banco = d.nr_sequencia)
WHERE a.nr_seq_movto = b.nr_sequencia and coalesce(b.nr_seq_caixa_rec::text, '') = '' and a.nr_lote_contabil      = nr_lote_contabil_p and c.nr_seq_movto_cartao = b.nr_sequencia and ie_contab_desp_cartao_w = 'S'  
union all

        select  coalesce(b.vl_transacao_estrang,0),
                b.nr_seq_trans_financ,
                b.dt_transacao,
                'VL_TRANSACAO_ESTRANG',
                b.nr_seq_banco, /* Francisco OS 83427 - 06/03/2008 - Troquei de NR_SEQ_BANCO_OD para NR_SEQ_BANCO */
                substr(obter_compl_trans_fin(b.nr_sequencia, 'PJ'),1,255) cd_cgc,
                b.cd_conta_contabil,
                coalesce(e.cd_centro_custo, b.cd_centro_custo),
                coalesce(b.nr_documento, coalesce(to_char(b.nr_adiantamento),coalesce(to_char(nr_bordero),to_char(nr_interno_conta)))),
                ie_banco,
                CASE WHEN coalesce(d.ie_agrupa_lote_cb,ie_agrupa_w)='N' THEN  b.nr_sequencia  ELSE 0 END ,
                ds_historico,
                substr(obter_compl_trans_fin(b.nr_sequencia, 'PF'),1,255) cd_pessoa_fisica,
                c.cd_conta_contabil,
                d.cd_historico_banco,
                substr(coalesce(c.ds_interno,obter_banco_e_conta(c.nr_sequencia)),1,255) ds_banco_conta,
                substr(obter_compl_trans_fin(b.nr_sequencia, 'N'),1,255) ds_compl_pf_pj,
                substr(obter_se_trans_contab(d.nr_sequencia),1,1) ie_contab,
                coalesce(b.nr_bordero,0),
                coalesce(b.nr_seq_titulo_pagar,b.nr_seq_titulo_receber) nr_titulo,
                coalesce(b.nr_documento,''),
                coalesce(b.nr_adiantamento,0),
                b.cd_historico,
                b.nr_adiant_pago,
                b.nr_bordero_rec,
                b.nr_interno_conta,
                (obter_dados_tit_pagar(b.nr_seq_titulo_pagar,'NFSEQ'))::numeric nr_seq_nota_fiscal,
                b.nr_seq_titulo_pagar,
                b.nr_seq_titulo_receber,
                b.nr_seq_cheque,
                c.ds_banco,
                b.nr_seq_cheque_cp,
                substr(obter_descricao_padrao('TITULO_PAGAR','DS_COMPL_CONTAB',b.nr_seq_titulo_pagar),1,255) ds_compl_contab_cp,
                b.cd_estabelecimento cd_estabelecimento,
                b.nr_seq_caixa_od,
                b.nr_seq_movto_cartao,
                b.nr_seq_banco_od,
                substr(coalesce(obter_pessoa_titulo_pagar(b.nr_seq_titulo_pagar), obter_pessoa_titulo_receber(b.nr_seq_titulo_receber)),1,80),
                '' cd_conta_deb_pls,
                '' cd_conta_rec_pls,
                (null)::numeric  cd_historico_pls,
                (null)::numeric  nr_seq_produto,
                (null)::numeric  nr_seq_cheque_dep,
                coalesce(b.ie_estorno,'N') ie_estorno,
                CASE WHEN coalesce(d.ie_agrupa_lote_cb,ie_agrupa_w)='N' THEN  coalesce(b.nr_seq_movto_orig,0)  ELSE 0 END   nr_seq_movto_orig,
                b.nr_seq_banco_escrit,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                null nr_seq_liq_cc,
                b.nr_seq_proj_rec,
                null ie_lote_pro_rata,
                b.nr_seq_movto_transf_bco,
                obter_movto_banco_pend(b.nr_sequencia) nr_seq_movto_banco_pend,
                b.nr_seq_parc_cartao,
                b.nr_seq_lote_cartao,
                substr(obter_movto_banco_pend_orig(b.nr_sequencia),1,10) nr_seq_cni,
                b.nr_sequencia,
                b.nr_seq_deposito,
                null cd_tipo_baixa,
                null nr_seq_baixa_cr,
                b.nr_seq_perda,
                b.nr_seq_cobr_escrit nr_seq_cobr_escrit,
                'MOVTO_TRANS_FINANC',
                null cd_tributo,
                5 nr_seq_info_ctb,
                b.nr_sequencia,
                b.nr_seq_concil,
                b.cd_moeda,
                substr(obter_movto_banco_pend_orig(b.nr_seq_movto_orig), 1, 10) nr_seq_cni_orig
        FROM transacao_financeira d, banco_estabelecimento_v c, banco_saldo a, movto_trans_financ b
LEFT OUTER JOIN movto_trans_financ_cc e ON (b.nr_sequencia = e.nr_seq_movto_trans)
WHERE b.nr_Lote_contabil              = nr_lote_contabil_p and a.nr_seq_conta                  = c.nr_sequencia and a.nr_sequencia                  = b.nr_seq_saldo_banco and (b.nr_seq_trans_financ IS NOT NULL AND b.nr_seq_trans_financ::text <> '') and coalesce(b.nr_seq_caixa::text, '') = '' and ie_banco                        in ('D','C','T') and b.nr_seq_trans_financ           = d.nr_sequencia and d.ie_contab_cb                  = 'S'  and coalesce(b.vl_transacao_estrang,0)   <> 0 --and   b.cd_conta_contabil             is not null
 
union all

        select  coalesce(b.vl_complemento,0),
                b.nr_seq_trans_financ,
                b.dt_transacao,
                'VL_MOEDA_COMPLEMENTAR',
                b.nr_seq_banco, /* Francisco OS 83427 - 06/03/2008 - Troquei de NR_SEQ_BANCO_OD para NR_SEQ_BANCO */
                substr(obter_compl_trans_fin(b.nr_sequencia, 'PJ'),1,255) cd_cgc,
                b.cd_conta_contabil,
                coalesce(e.cd_centro_custo, b.cd_centro_custo),
                coalesce(b.nr_documento, coalesce(to_char(b.nr_adiantamento),coalesce(to_char(nr_bordero),to_char(nr_interno_conta)))),
                ie_banco,
                CASE WHEN coalesce(d.ie_agrupa_lote_cb,ie_agrupa_w)='N' THEN  b.nr_sequencia  ELSE 0 END ,
                ds_historico,
                substr(obter_compl_trans_fin(b.nr_sequencia, 'PF'),1,255) cd_pessoa_fisica,
                c.cd_conta_contabil,
                d.cd_historico_banco,
                substr(coalesce(c.ds_interno,obter_banco_e_conta(c.nr_sequencia)),1,255) ds_banco_conta,
                substr(obter_compl_trans_fin(b.nr_sequencia, 'N'),1,255) ds_compl_pf_pj,
                substr(obter_se_trans_contab(d.nr_sequencia),1,1) ie_contab,
                coalesce(b.nr_bordero,0),
                coalesce(b.nr_seq_titulo_pagar,b.nr_seq_titulo_receber) nr_titulo,
                coalesce(b.nr_documento,''),
                coalesce(b.nr_adiantamento,0),
                b.cd_historico,
                b.nr_adiant_pago,
                b.nr_bordero_rec,
                b.nr_interno_conta,
                (obter_dados_tit_pagar(b.nr_seq_titulo_pagar,'NFSEQ'))::numeric nr_seq_nota_fiscal,
                b.nr_seq_titulo_pagar,
                b.nr_seq_titulo_receber,
                b.nr_seq_cheque,
                c.ds_banco,
                b.nr_seq_cheque_cp,
                substr(obter_descricao_padrao('TITULO_PAGAR','DS_COMPL_CONTAB',b.nr_seq_titulo_pagar),1,255) ds_compl_contab_cp,
                b.cd_estabelecimento cd_estabelecimento,
                b.nr_seq_caixa_od,
                b.nr_seq_movto_cartao,
                b.nr_seq_banco_od,
                substr(coalesce(obter_pessoa_titulo_pagar(b.nr_seq_titulo_pagar), obter_pessoa_titulo_receber(b.nr_seq_titulo_receber)),1,80),
                '' cd_conta_deb_pls,
                '' cd_conta_rec_pls,
                (null)::numeric  cd_historico_pls,
                (null)::numeric  nr_seq_produto,
                (null)::numeric  nr_seq_cheque_dep,
                coalesce(b.ie_estorno,'N') ie_estorno,
                CASE WHEN coalesce(d.ie_agrupa_lote_cb,ie_agrupa_w)='N' THEN  coalesce(b.nr_seq_movto_orig,0)  ELSE 0 END   nr_seq_movto_orig,
                b.nr_seq_banco_escrit,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                null nr_seq_liq_cc,
                b.nr_seq_proj_rec,
                null ie_lote_pro_rata,
                b.nr_seq_movto_transf_bco,
                obter_movto_banco_pend(b.nr_sequencia) nr_seq_movto_banco_pend,
                b.nr_seq_parc_cartao,
                b.nr_seq_lote_cartao,
                substr(obter_movto_banco_pend_orig(b.nr_sequencia),1,10) nr_seq_cni,
                b.nr_sequencia,
                b.nr_seq_deposito,
                null cd_tipo_baixa,
                null nr_seq_baixa_cr,
                b.nr_seq_perda,
                b.nr_seq_cobr_escrit nr_seq_cobr_escrit,
                'MOVTO_TRANS_FINANC',
                null cd_tributo,
                5 nr_seq_info_ctb,
                b.nr_sequencia,
                b.nr_seq_concil,
                b.cd_moeda,
                substr(obter_movto_banco_pend_orig(b.nr_seq_movto_orig), 1, 10) nr_seq_cni_orig
        FROM transacao_financeira d, banco_estabelecimento_v c, banco_saldo a, movto_trans_financ b
LEFT OUTER JOIN movto_trans_financ_cc e ON (b.nr_sequencia = e.nr_seq_movto_trans)
WHERE b.nr_Lote_contabil                      = nr_lote_contabil_p and a.nr_seq_conta                          = c.nr_sequencia and a.nr_sequencia                          = b.nr_seq_saldo_banco and (b.nr_seq_trans_financ IS NOT NULL AND b.nr_seq_trans_financ::text <> '') and coalesce(b.nr_seq_caixa::text, '') = '' and ie_banco                                in ('D','C','T') and b.nr_seq_trans_financ                   = d.nr_sequencia and d.ie_contab_cb                          = 'S'  and coalesce(b.vl_complemento,0)                 <> 0
         
union all

        select	b.vl_baixa,--
                b.nr_seq_trans_fin,--
                b.dt_baixa,
                'VL_OUTRAS_DESPESAS',--
                null,
                null,
                null cd_conta_contabil,
                null cd_centro_custo,
                null,
                c.ie_banco,--
                null,
                null ds_historico,
                null cd_pessoa_fisica,
                b.cd_conta_contabil,--
                c.cd_historico_banco,--
                null ds_banco_conta,
                null ds_compl_pf_pj,
                null ie_contab,
                null,
                a.nr_titulo,--
                null,
                null,
                null cd_historico,
                null nr_adiant_pago,
                null nr_bordero_rec,
                null nr_interno_conta,
                null nr_seq_nota_fiscal,
                null nr_seq_titulo_pagar,
                null nr_seq_titulo_receber,
                null nr_seq_cheque,
                null ds_banco,
                null nr_seq_cheque_cp,
                null ds_compl_contab_cp,
                null cd_estabelecimento,
                null nr_seq_caixa_od,
                null nr_seq_movto_cartao,
                null nr_seq_banco_od,
                null,
                '' cd_conta_deb_pls,
                '' cd_conta_rec_pls,
                (null)::numeric  cd_historico_pls,
                (null)::numeric  nr_seq_produto,
                (null)::numeric  nr_seq_cheque_dep,
                null ie_estorno,
                null nr_seq_movto_orig,
                null nr_seq_banco_escrit,
                (null)::numeric  vl_antecipacao_mens,
                to_char(null) ie_lote_antecip_pls,
                to_date(null) dt_referencia_pls_mens,
                (null)::numeric  nr_seq_baixa,
                null nr_seq_liq_cc,
                a.nr_seq_proj_rec,--
                null ie_lote_pro_rata,
                null nr_seq_movto_transf_bco,
                null nr_seq_movto_banco_pend,
                null nr_seq_parc_cartao,
                null nr_seq_lote_cartao,
                null nr_seq_cni,
                b.nr_seq_movto_trans_fin,
                null nr_seq_deposito,
                b.cd_tipo_baixa,--
                null nr_seq_baixa_cr,
                null nr_seq_perda,
                null nr_seq_cobr_escrit,
                'TITULO_PAGAR_BAIXA',--
                null cd_tributo,
                13 nr_seq_info_ctb,
                null nr_sequencia,
                null nr_seq_concil,
                null cd_moeda,
                null nr_seq_cni_orig
        from	titulo_pagar a,
                titulo_pagar_baixa b,
                transacao_financeira c
        where 	a.nr_lote_contabil = nr_lote_contabil_p
        and     c.nr_sequencia = a.nr_seq_trans_fin_contab
        and	    a.nr_titulo = b.nr_titulo
        and     ie_contab_cp_no_cb_w = 'S';

c020 CURSOR FOR
        SELECT  nr_cheque,
                vl_cheque
        from    cheque_v
        where   nr_sequencia in (
                SELECT  nr_seq_cheque
                from    cheque_bordero_titulo
                where   nr_bordero      = nr_bordero_w)
        and     coalesce(dt_cancelamento::text, '') = '';

c030 CURSOR FOR
        SELECT  b.nr_cheque
        from    adiantamento_pago_cheque a,
                cheque b
        where   a.nr_adiantamento       = nr_adiant_pago_w
        and     a.nr_seq_cheque         = b.nr_sequencia
        and     coalesce(b.dt_cancelamento::text, '') = ''
        order   by 1;

c04 CURSOR FOR
        SELECT  nr_cheque
        from    cheque_v
        where   nr_sequencia in (
                        SELECT  nr_seq_cheque
                        from    cheque_bordero_titulo
                        where   nr_bordero      = nr_bordero_w
                        and     coalesce(nr_titulo, coalesce(nr_seq_titulo_pagar_w, 0))   = coalesce(nr_seq_titulo_pagar_w, 0))
        and     coalesce(dt_cancelamento::text, '') = '';
        /*and   vl_cheque       =  vl_transacao_w;  Francisco OS 83427 - 06/03/2008 - Comentei esta linha, nao entendi o porque desta restricao */

BEGIN
/*Validacao para impedir a geracao em lotes incorretos */

if (ie_exclusao_p <> 'S') then
        select b.cd_tipo_lote_contabil
        into STRICT cd_tipo_lote_contabil_w
        from lote_contabil b
        where b.nr_lote_contabil = nr_lote_contabil_p;
        if (cd_tipo_lote_contabil_w <> 18) then
                CALL wheb_mensagem_pck.exibir_mensagem_abort(261346);
        end if;
end if;
delete
from    lote_contabil_log
where   nr_lote_contabil = nr_lote_contabil_p
and     cd_log_lote in (9,10);
commit;

select  dt_referencia,
        cd_estabelecimento,
        trunc(dt_referencia,'month'),
        trunc(dt_referencia,'dd') + 86399/86400,
        cd_tipo_lote_contabil
into STRICT    dt_contabil_w,
        cd_estabelecimento_w,
        dt_inicial_w,
        dt_final_w,
        cd_tipo_lote_contabil_w
from    lote_contabil
where   nr_lote_contabil        = nr_lote_contabil_p;

cd_empresa_w    := obter_empresa_estab(cd_estabelecimento_w);

select  max(nm_fantasia_estab)
into STRICT    nm_estabelecimento_w
from    estabelecimento
where   cd_estabelecimento      = cd_estabelecimento_w;

select  substr(coalesce(max(ds_valor_parametro),'A'),1,1)
into STRICT    ie_tipo_movto_w
from    lote_contabil_parametro
where   nr_lote_contabil        = nr_lote_contabil_p
and     nr_seq_parametro        = 1;

select  coalesce(max(vl_parametro),0)
into STRICT    nr_seq_classif_w
from    lote_contabil_parametro
where   nr_lote_contabil        = nr_lote_contabil_p
and     nr_seq_parametro        = 2;

if (ie_tipo_movto_w not in ('P','R','A')) then
        /*'O tipo de movimento do lote deve ser A,P ou R.#@#@'*/

        CALL wheb_mensagem_pck.exibir_mensagem_abort(182492);
end if;

if (nr_seq_classif_w <> 0) then

        select  coalesce(max(nr_sequencia),0)
        into STRICT    nr_seq_classif_w
        from    classif_banco_estab
        where   nr_sequencia    = nr_seq_classif_w;

        if (nr_seq_classif_w = 0) then
        /*A classificacao de conta bancaria informada, nao existe no cadastro!*/

                CALL wheb_mensagem_pck.exibir_mensagem_abort(182494);
        end if;
end if;

dt_contab_lote_w        := dt_contabil_w;

select  max(ie_agrupa_trans_contab),
        max(ie_data_contabil),
        max(ie_hist_contabil),
        max(ie_contab_cp_no_cb),
        max(ie_contab_cr_no_cb),
        max(ie_contab_bordero),
        max(ie_compl_historico),
        coalesce(max(ie_contab_vl_estorno),'N'),
        coalesce(max(ie_contab_concil),'N'),
        coalesce(max(ie_agrup_movto_transf),'N'),
        coalesce(max(ie_contab_transit_cr),'N'),
        coalesce(max(IE_CONTAB_TRANSIT_TF),'N'),
        coalesce(max(ie_movto_tf_estab),'N')
into STRICT    ie_agrupa_w,
        ie_data_contabil_w,
        ie_hist_contabil_w,
        ie_contab_cp_no_cb_w,
        ie_contab_cr_no_cb_w,
        ie_contab_bordero_w,
        ie_compl_historico_banc_w,
        ie_contab_vl_estorno_w,
        ie_contab_concil_w,
        ie_agrup_movto_transf_w,
        ie_contab_transit_cr_w,
        ie_contab_transit_tf_w,
        ie_movto_tf_estab_w
from    parametro_controle_banc
where   cd_estabelecimento      = cd_estabelecimento_w;

select  coalesce(ie_contab_desp_cartao,'N'),
        coalesce(ie_contab_trans_fin_baixa, 'N'),
        coalesce(ie_forma_lanc_lote_cartao, 'P')
into STRICT    ie_contab_desp_cartao_w,
        ie_contab_trans_fin_baix_rec_w,
        ie_forma_lanc_lote_cartao_w
from    parametro_contas_receber
where   cd_estabelecimento      = cd_estabelecimento_w;

select  coalesce(max(ie_benef_orig_trib_contab),'N'),
        coalesce(max(ie_contab_trans_fin_baixa), 'N'),
        coalesce(max(ie_contab_prov_tributo),'N')
into STRICT    ie_benef_orig_trib_contab_w,
        ie_contab_trans_fin_baixa_w,
        ie_contab_prov_tributo_w
from    parametros_contas_pagar
where   cd_estabelecimento      = cd_estabelecimento_w;

select  coalesce(max(a.ie_contab_baixas_pro_rata),'N')
into STRICT    ie_contab_baixas_pro_rata_w
from    pls_parametros_cr a
where   a.cd_estabelecimento    = cd_estabelecimento_w;

select  coalesce(max(a.ie_contab_classif_mens),'N')
into STRICT    ie_contab_classif_mens_w
from    pls_parametro_contabil a
where   a.cd_estabelecimento    = cd_estabelecimento_w;

SELECT * FROM ctb_obter_regra_estab_dif(cd_estabelecimento_w, cd_tipo_lote_contabil_w, null, ie_permite_estab_dif_w, cd_conta_transitoria_w, cd_historico_ct_w) INTO STRICT ie_permite_estab_dif_w, cd_conta_transitoria_w, cd_historico_ct_w;

if (ie_exclusao_p  = 'S') then
        CALL ctb_regras_contabil.comprovante_cache_storage(nr_lote_contabil_p, nm_usuario_p);
        delete  from movimento_contabil
        where   nr_lote_contabil        = nr_lote_contabil_p;
        commit;

        update  lote_contabil
        set     vl_credito      = 0,
                vl_debito       = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  movto_trans_financ
        set     nr_lote_contabil        = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  titulo_pagar_baixa a
        set     nr_lote_contabil        = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  titulo_receber_liq a
        set     nr_lote_contabil        = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        /* Francisco - 03/05/2010 - OS 203923 */

        update  titulo_receber_liq a
        set     nr_lote_contab_antecip  = 0
        where   nr_lote_contab_antecip  = nr_lote_contabil_p;

        /* Francisco - 26/05/2010 -  220155 */

        update  titulo_receber_liq a
        set     nr_lote_contab_pro_rata = 0
        where   nr_lote_contab_pro_rata = nr_lote_contabil_p;

        update  pls_titulo_rec_liq_mens
        set     nr_lote_contabil        = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  movto_cartao_cr_parcela
        set     nr_lote_contabil        = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  titulo_pagar_imposto    a
        set     a.nr_lote_contabil      = 0
        where   a.nr_lote_contabil      = nr_lote_contabil_p;

        update  titulo_pagar_trib_baixa a
        set     a.nr_lote_contabil      = 0
        where   a.nr_lote_contabil      = nr_lote_contabil_p;

        -- update       titulo_receber_trib_baixa a

        -- set  a.nr_lote_contabil      = 0

        -- where        a.nr_lote_contabil      = nr_lote_contabil_p;
else
        delete  FROM w_movimento_contabil
        where   nr_lote_contabil = nr_lote_contabil_p;
        commit;

        update  movto_trans_financ a
        set     nr_lote_contabil        = nr_lote_contabil_p
        where   coalesce(nr_lote_contabil,0) = 0
        and     dt_transacao between dt_inicial_w and dt_final_w
        and     ((ie_contab_concil_w = 'N') or (ie_conciliacao = 'S'))
        and     ((ie_permite_estab_dif_w <> 'N') or (coalesce(a.cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w))
        and     exists (
                SELECT  1
                from    banco_estabelecimento b
                where   a.nr_seq_banco  = b.nr_sequencia
                and             ((coalesce(b.cd_estabelecimento, cd_estabelecimento_w)       = cd_estabelecimento_w)
                or (ie_movto_tf_estab_w = 'S'))
                and (b.nr_seq_classif = nr_seq_classif_w or nr_seq_classif_w = 0)
                and     b.cd_empresa            = cd_empresa_w)
        and     ((ie_tipo_movto_w = 'A') or (substr(obter_acao_banco_trans_fin(nr_seq_trans_financ,'BCTB'),1,1) = ie_tipo_movto_w));
        commit;

        if (ie_contab_desp_cartao_w = 'S') then

                if (ie_forma_lanc_lote_cartao_w = 'P') then

                        update  movto_cartao_cr_parcela a
                        set     nr_lote_contabil = nr_lote_contabil_p
                        where   coalesce(nr_lote_contabil,0) = 0
                        /*and   dt_parcela between dt_inicial_w and dt_final_w*/

                        and     exists ( SELECT  1
                                        from    movto_trans_financ x,
                                                movto_cartao_cr y
                                        where   y.nr_sequencia  = a.nr_seq_movto
                                        and     x.nr_seq_movto_cartao   = y.nr_sequencia
                                        and     y.cd_estabelecimento    = cd_estabelecimento_w
                                        and     coalesce(y.nr_seq_caixa_rec::text, '') = ''
                                        and     x.nr_lote_contabil      = nr_lote_contabil_p
                                        and     (x.nr_seq_banco IS NOT NULL AND x.nr_seq_banco::text <> '')
                                        and     coalesce(x.nr_seq_caixa::text, '') = ''
                                        and     y.dt_transacao between dt_inicial_w and dt_final_w);

                        commit;
                elsif (ie_forma_lanc_lote_cartao_w = 'L') then
                        update  movto_cartao_cr_parcela a
                        set     nr_lote_contabil = nr_lote_contabil_p
                        where   coalesce(nr_lote_contabil,0) = 0
                        and     exists (         SELECT  1
                                                        from    movto_trans_financ x,
                                                                        lote_baixa_cartao_cr y
                                                        where y.nr_sequencia            = a.nr_seq_lote
                                                        and y.nr_sequencia                      = x.nr_seq_lote_cartao
                                                        and     y.cd_estabelecimento    = cd_estabelecimento_w
                                                        and     (y.nr_seq_bandeira IS NOT NULL AND y.nr_seq_bandeira::text <> '')
                                                        and     x.nr_lote_contabil      = nr_lote_contabil_p
                                                        and     (x.nr_seq_banco IS NOT NULL AND x.nr_seq_banco::text <> '')
                                                        and     coalesce(x.nr_seq_caixa::text, '') = ''
                                                        and     x.dt_transacao between dt_inicial_w and dt_final_w);
                        commit;
                end if;
        end if;

        if (ie_contab_cp_no_cb_w = 'S') then
                update  titulo_pagar_baixa a
                set     nr_lote_contabil        = nr_lote_contabil_p
                where   nr_lote_contabil        = 0
                and     trunc(dt_baixa,'month') = trunc(dt_contabil_w, 'month')
                and     trunc(dt_baixa,'dd')    <= trunc(dt_contabil_w, 'dd')
                and     (nr_seq_conta_banco IS NOT NULL AND nr_seq_conta_banco::text <> '')
                and     coalesce(nr_seq_lote_enc_contas::text, '') = '' /* Francisco - 30/10/2010 - Vai entrar em outro lote */
                and     coalesce(nr_seq_pls_lote_camara::text, '') = '' /* Francisco - 30/10/2010 - Vai entrar em outro lote */
                and     exists(
                        SELECT  1
                        from    titulo_pagar t
                        where   a.nr_titulo     = t.nr_titulo
                        and     (((ie_permite_estab_dif_w <> 'N') and (obter_empresa_estab(t.cd_estabelecimento) = cd_empresa_w)) or (t.cd_estabelecimento      = cd_estabelecimento_w)))
                and     exists (
                        SELECT 1
                        from    banco_estabelecimento b
                        where   a.nr_seq_conta_banco    = b.nr_sequencia
                        and     coalesce(b.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
                        and (b.nr_seq_classif = nr_seq_classif_w or nr_seq_classif_w = 0)
                        and     b.cd_empresa            = cd_empresa_w)
                and (nr_bordero in (select  distinct nr_bordero
                                        from    movto_trans_financ x
                                        where   x.nr_lote_contabil      = nr_lote_contabil_p) or
                        nr_titulo in (select  distinct nr_seq_titulo_pagar    /* Francisco - 20/03/2008 - Inclui o or para buscar do titulo tbem*/
                                        from    movto_trans_financ y
                                        where   y.nr_lote_contabil      = nr_lote_contabil_p) or
                        nr_seq_escrit in (select distinct nr_seq_banco_escrit
                                        from    movto_trans_financ z
                                        where   z.nr_lote_contabil      = nr_lote_contabil_p)
                        )
                and     ie_tipo_movto_w in ('A','P');

                if (ie_contab_prov_tributo_w = 'S') then
                        update  titulo_pagar_imposto a
                        set     a.nr_lote_contabil      = nr_lote_contabil_p
                        where   coalesce(a.nr_lote_contabil,0) = 0
                        and     exists ( SELECT  1
                                        from    tributo t
                                        where   t.cd_tributo            = a.cd_tributo
                                        and     t.ie_contab_prov_cp     = 'S')
                        and     exists ( select  1
                                        from    titulo_pagar_baixa y
                                        where   y.nr_titulo             = a.nr_titulo
                                        and     y.nr_sequencia          = a.nr_seq_baixa
                                        and     y.nr_lote_contabil      = nr_lote_contabil_p);
                        commit;
                end if;
                commit;
        end if;

        if (ie_contab_cr_no_cb_w = 'S') then
                update  titulo_receber_liq a
                set     nr_lote_contabil        = nr_lote_contabil_p
                where   nr_lote_contabil        = 0
                and     trunc(dt_recebimento,'month')   = trunc(dt_contabil_w, 'month')
                and     trunc(dt_recebimento,'dd')      <= trunc(dt_contabil_w, 'dd')
                and     coalesce(nr_seq_lote_enc_contas::text, '') = '' /* Francisco - 30/10/2010 - Vai entrar em outro lote */
                and     coalesce(nr_seq_pls_lote_camara::text, '') = '' /* Francisco - 30/10/2010 - Vai entrar em outro lote */
                and     exists (
                        SELECT 1
                        from    banco_estabelecimento b
                        where   a.nr_seq_conta_banco    = b.nr_sequencia
                        and     coalesce(b.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
                        and (b.nr_seq_classif = nr_seq_classif_w or nr_seq_classif_w = 0)
                        and     b.cd_empresa            = cd_empresa_w)
                and     exists(
                        SELECT  1
                        from    titulo_receber t
                        where   a.nr_titulo             = t.nr_titulo
                        and     (((ie_contab_transit_cr_w = 'S') and ((ie_permite_estab_dif_w <> 'N') and (obter_empresa_estab(t.cd_estabelecimento) = cd_empresa_w)))  or (t.cd_estabelecimento        = cd_estabelecimento_w)))
                and     (
                         (nr_seq_conta_banco IS NOT NULL AND nr_seq_conta_banco::text <> '') /* Edgar 27/05/2008, OS 93779, incluido tratamento para contabilizar baixas que entraram no controle bancario */
                         or (nr_bordero in (
                                        select  distinct nr_bordero_rec
                                        from    movto_trans_financ x
                                        where   nr_lote_contabil        = nr_lote_contabil_p))
                         or (nr_seq_cobranca in (  /* Edgar 30/04/2008, OS 90351, incluir baixas feitas atraves do pagamento escritural */
                                        select  distinct nr_seq_cobr_escrit
                                        from    movto_trans_financ x
                                        where   nr_lote_contabil        = nr_lote_contabil_p
                                        and     (nr_seq_saldo_banco IS NOT NULL AND nr_seq_saldo_banco::text <> '')))
                        )
                and     ie_tipo_movto_w in ('A','R');
                commit;

                update  pls_titulo_rec_liq_mens a
                set     nr_lote_contabil        = nr_lote_contabil_p
                where   a.nr_lote_contabil      = 0
                and     trunc(a.dt_contabil, 'month')   = trunc(dt_contabil_w, 'month')
                and     trunc(a.dt_contabil,'dd')       = trunc(dt_contabil_w, 'dd')
                and     exists  (SELECT 1
                                from    titulo_receber  t
                                where   t.nr_titulo     = a.nr_titulo
                                and     ((ie_permite_estab_dif_w <> 'N')
                                or (coalesce(t.cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w)))
                and     (exists (       SELECT  1
                                        from    titulo_receber_liq x
                                        where   x.nr_titulo             = a.nr_titulo
                                        and     x.nr_sequencia          = a.nr_seq_baixa
                                        and     x.nr_lote_contabil      = nr_lote_contabil_p) or
                        exists  (       select  1
                                        from    pls_titulo_rec_liq_mens x,
                                                titulo_receber_liq      y
                                        where   ((x.ie_tipo_lancamento  = 'EA' and
                                                x.nr_lote_contabil      = 0) or (x.nr_lote_contabil     <> a.nr_lote_contabil and
                                                x.nr_lote_contabil      <> 0))
                                        and     x.nr_seq_baixa          = y.nr_sequencia
                                        and     x.nr_seq_baixa          = a.nr_seq_baixa
                                        and     x.nr_titulo             = y.nr_titulo
                                        and     x.nr_titulo             = a.nr_titulo))
                and (not exists (   select  1
                                        from    titulo_rec_liq_cc x
                                        where   x.nr_titulo     = a.nr_titulo
                                        and     x.nr_seq_baixa  = a.nr_sequencia
                                        and     x.vl_contab_pro_rata < 0) or
                        exists (        select  1
                                        from    pls_mensalidade_seg_item x
                                        where   x.ie_tipo_item = '3'
                                        and     x.nr_sequencia = a.nr_seq_item_mens) or (a.ie_tipo_lancamento = 'PR'))
                and     exists (        select  1
                                        from    titulo_receber_liq x
                                        where   x.nr_titulo     = a.nr_titulo
                                        and     x.nr_sequencia  = a.nr_seq_baixa
                                        and     x.dt_recebimento <= fim_dia(dt_contabil_w)
                                        and     ((nr_seq_conta_banco IS NOT NULL AND nr_seq_conta_banco::text <> '') or (nr_bordero in (select  distinct nr_bordero_rec
                                                                from    movto_trans_financ x
                                                                where   nr_lote_contabil        = nr_lote_contabil_p)) or (nr_seq_cobranca in (   select  distinct NR_SEQ_COBR_ESCRIT
                                                                        from    movto_trans_financ x
                                                                        where   nr_lote_contabil        = nr_lote_contabil_p
                                                                        and     (nr_seq_saldo_banco IS NOT NULL AND nr_seq_saldo_banco::text <> ''))))
                                        and     coalesce(nr_seq_lote_enc_contas::text, '') = '' /* Vai entrar em outro lote */
                                        and     coalesce(nr_seq_pls_lote_camara::text, '') = '' /* Vai entrar em outro lote */
)
                and     ie_tipo_movto_w in ('A','R');
                commit;

                if      ((ie_contab_baixas_pro_rata_w = 'S') or (ie_contab_baixas_pro_rata_w = 'A')) then
                        /* Francisco - 28/05/2010 - OS  220155 */

                        update  titulo_receber_liq a
                        set     nr_lote_contab_pro_rata = nr_lote_contabil_p
                        where   coalesce(nr_lote_contab_pro_rata,0)  = 0
                        and     (a.dt_referencia_pls_mens IS NOT NULL AND a.dt_referencia_pls_mens::text <> '')
                        and     trunc(a.dt_referencia_pls_mens,'month') = trunc(dt_contabil_w, 'month')
                        and     trunc(a.dt_referencia_pls_mens,'dd')    <= trunc(dt_contabil_w, 'dd')
                        and     coalesce(nr_seq_lote_enc_contas::text, '') = '' /* Francisco - 30/10/2010 - Vai entrar em outro lote */
                        and     coalesce(nr_seq_pls_lote_camara::text, '') = '' /* Francisco - 30/10/2010 - Vai entrar em outro lote */
                        and     exists(
                                SELECT  1
                                from    titulo_receber t
                                where   a.nr_titulo     = t.nr_titulo
                                and     (((ie_contab_transit_cr_w = 'S') and ((ie_permite_estab_dif_w <> 'N') and (obter_empresa_estab(t.cd_estabelecimento) = cd_empresa_w)))  or (t.cd_estabelecimento        = cd_estabelecimento_w)))
                        and     (
                                 (nr_seq_conta_banco IS NOT NULL AND nr_seq_conta_banco::text <> '') /* Edgar 27/05/2008, OS 93779, incluido tratamento para contabilizar baixas que entraram no controle bancario */
                                 or (nr_bordero in (
                                                SELECT  distinct nr_bordero_rec
                                                from    movto_trans_financ x
                                                where   nr_lote_contabil        = nr_lote_contabil_p))
                                 or (nr_seq_cobranca in (  /* Edgar 30/04/2008, OS 90351, incluir baixas feitas atraves do pagamento escritural */
                                                select  distinct NR_SEQ_COBR_ESCRIT
                                                from    movto_trans_financ x
                                                where   nr_lote_contabil        = nr_lote_contabil_p
                                                and     (nr_seq_saldo_banco IS NOT NULL AND nr_seq_saldo_banco::text <> '')))
                                )
                        and     ie_tipo_movto_w in ('A','R');
                        commit;

                        /* Francisco - 03/05/2010 - OS 203923 */

                        update  titulo_receber_liq a
                        set     nr_lote_contab_antecip  = nr_lote_contabil_p
                        where   (a.dt_antecipacao_pls_mens IS NOT NULL AND a.dt_antecipacao_pls_mens::text <> '')
                        and     coalesce(nr_lote_contab_antecip,0)   = 0
                        and     trunc(dt_antecipacao_pls_mens,'month')  = trunc(dt_contabil_w, 'month')
                        and     trunc(dt_antecipacao_pls_mens,'dd')     <= trunc(dt_contabil_w, 'dd')
                        and     coalesce(nr_seq_lote_enc_contas::text, '') = '' /* Francisco - 30/10/2010 - Vai entrar em outro lote */
                        and     coalesce(nr_seq_pls_lote_camara::text, '') = '' /* Francisco - 30/10/2010 - Vai entrar em outro lote */
                        and     exists(
                                SELECT  1
                                from    titulo_receber t
                                where   a.nr_titulo     = t.nr_titulo
                                and     (((ie_contab_transit_cr_w = 'S') and ((ie_permite_estab_dif_w <> 'N') and (obter_empresa_estab(t.cd_estabelecimento) = cd_empresa_w)))  or (t.cd_estabelecimento        = cd_estabelecimento_w)))
                        and     (
                                 (nr_seq_conta_banco IS NOT NULL AND nr_seq_conta_banco::text <> '') /* Edgar 27/05/2008, OS 93779, incluido tratamento para contabilizar baixas que entraram no controle bancario */
                                 or (nr_bordero in (
                                                SELECT  distinct nr_bordero_rec
                                                from    movto_trans_financ x
                                                where   nr_lote_contabil        = nr_lote_contabil_p))
                                 or (nr_seq_cobranca in (  /* Edgar 30/04/2008, OS 90351, incluir baixas feitas atraves do pagamento escritural */
                                                select  distinct nr_seq_cobr_escrit
                                                from    movto_trans_financ x
                                                where   nr_lote_contabil        = nr_lote_contabil_p
                                                and     (nr_seq_saldo_banco IS NOT NULL AND nr_seq_saldo_banco::text <> '')))
                                )
                        and     ie_tipo_movto_w in ('A','R');
                        commit;
                end if;
        end if;

        if (coalesce(philips_param_pck.get_cd_pais,0) = 2) then
                update  titulo_pagar_trib_baixa a
                set     a.nr_lote_contabil = nr_lote_contabil_p
                where   coalesce(a.nr_lote_contabil,0) = 0
                and     trunc(a.dt_contabil,'month') = trunc(dt_contabil_w,'month')
                and     trunc(a.dt_contabil,'dd') <= trunc(dt_contabil_w, 'dd');

                update  titulo_receber_trib_baixa a
                set     a.nr_lote_contabil = nr_lote_contabil_p
                where   coalesce(a.nr_lote_contabil,0) = 0
                and     trunc(a.dt_contabil,'month') = trunc(dt_contabil_w,'month')
                and     trunc(a.dt_contabil,'dd') <= trunc(dt_contabil_w, 'dd');
                commit;
        end if;

        nm_agrupador_w  := coalesce(trim(both obter_agrupador_contabil(18)),'NR_SEQ_MOVTO_TRANS_FIN');

        select  substr(obter_se_compl_tipo_lote(cd_estabelecimento_w, cd_tipo_lote_contabil),1,1)
        into STRICT    ie_compl_hist_w
        from    lote_contabil
        where   nr_lote_contabil        = nr_lote_contabil_p;
        qt_contador_w := 0;
        open c010;
        loop
        fetch c010 into
                        vl_transacao_w,
                        nr_seq_trans_fin_w,
                        dt_movimento_w,
                        nm_atributo_w,
                        nr_seq_conta_banco_w,
                        cd_cgc_w,
                        cd_conta_contabil_w,
                        cd_centro_custo_w,
                        nr_documento_w,
                        ie_debito_credito_w,
                        nr_seq_trans_w,
                        ds_historico_w,
                        cd_pessoa_fisica_w,
                        cd_conta_contabil_banco_w,
                        cd_historico_w,
                        ds_banco_conta_w,
                        ds_hist_pf_pj_w,
                        ie_contab_w,
                        nr_bordero_w,
                        nr_titulo_w,
                        nr_doc_w,
                        nr_adiantamento_w,
                        cd_historico_movto_w,
                        nr_adiant_pago_w,
                        nr_bordero_rec_w,
                        nr_interno_conta_w,
                        nr_seq_nota_fiscal_w,
                        nr_seq_titulo_pagar_w,
                        nr_seq_titulo_receber_w,
                        nr_seq_cheque_w,
                        ds_banco_w,
                        nr_seq_cheque_cp_w,
                        ds_compl_contab_cp_w,
                        cd_estab_movto_w,
                        nr_seq_caixa_od_w,
                        nr_seq_movto_cartao_w,
                        nr_seq_banco_od_w,
                        ds_pessoa_titulo_w,
                        cd_conta_deb_pls_w,
                        cd_conta_rec_pls_w,
                        cd_historico_pls_w,
                        nr_seq_produto_w,
                        nr_seq_cheque_dep_w,
                        ie_estorno_w,
                        nr_seq_movto_orig_w,
                        nr_seq_banco_escrit_w,
                        vl_antecipacao_mens_w,
                        ie_tipo_lote_pls_w,
                        dt_referencia_pls_mens_w,
                        nr_seq_baixa_w,
                        nr_seq_liq_cc_w,
                        nr_seq_proj_rec_w,
                        ie_lote_pro_rata_w,
                        nr_seq_movto_transf_bco_w,
                        nr_seq_movto_bco_pend_w,
                        nr_seq_parc_cartao_w,
                        nr_seq_lote_cartao_w,
                        nr_seq_cni_w,
                        nr_seq_movto_trans_fin_w,
                        nr_seq_deposito_w,
                        cd_tipo_baixa_w,
                        nr_seq_baixa_cr_w,
                        nr_seq_perda_w,
                        nr_seq_cobr_escrit_w,
                        nm_tabela_w,
                        cd_tributo_ww,
                        nr_seq_info_ctb_w,
                        nr_seq_tab_orig_w,
                        nr_seq_concil_w,
                        cd_moeda_w,
                        nr_seq_cni_orig_w;
        EXIT WHEN NOT FOUND; /* apply on c010 */
                ie_contab_transit_w             := 'S';
                ds_estorno_w                    := '';
                nr_cheque_deposito_w            := '';
                nr_seq_trans_fin_baixa_w        := null;
                qt_estorno_contab_w             := 0;
                ds_cheque_cp_w                  := '';
                ds_nota_fiscal_cartao_w         := '';
                ds_nfe_cartao_w                 := '';
                nr_seq_caixa_rec_w              := null;
                nr_parcela_cartao_w             := null;
                nr_seq_bandeira_cartao_w        := null;
                cd_tributo_w                    := null;
                qt_contador_w                   := qt_contador_w + 1;
                ds_tributo_w                    := '';
                nr_seq_tab_compl_w              := null;
                ds_movto_cartao_w               := '';
                ds_bandeira_cartao_w            := '';
                nm_pessoa_caixa_rec_w           := '';
                if (coalesce(cd_tributo_ww,0) <> 0) then
                        begin
                        select  ds_tributo
                        into STRICT    ds_tributo_w
                        from    tributo
                        where   cd_tributo = cd_tributo_ww;
                        exception when others then
                                ds_tributo_w    := '';
                        end;
                end if;

                if (nm_tabela_w in ('TITULO_PAGAR_BAIXA_CONTAB_V','TITULO_PAGAR_TRIB_BAIXA')) then
                        nr_seq_tab_compl_w      := nr_seq_titulo_pagar_w;
                elsif (nm_tabela_w in ('TITULO_RECEBER_LIQ_CONTAB_V','TITULO_REC_LIQ_CC','TITULO_RECEBER_TRIB_BAIXA')) then
                        nr_seq_tab_compl_w      := nr_seq_titulo_receber_w;
                end if;

                if (ie_contab_vl_estorno_w = 'S') and (ie_estorno_w = 'E') and (nr_seq_movto_orig_w <> 0) then

                        select  count(*)
                        into STRICT    qt_estorno_contab_w
                        from    movto_trans_financ
                        where   nr_sequencia    = nr_seq_movto_orig_w
                        and     nr_lote_contabil > 0
                        and     nr_lote_contabil <> nr_lote_contabil_p;

                        if (qt_estorno_contab_w > 0) then
                                ds_estorno_w    := ' ' || wheb_mensagem_pck.get_texto(799481) || ' ';
                        end if;
                end if;

                if (vl_transacao_w < 0)then
                        ie_estorno_ww   :=      wheb_mensagem_pck.get_texto(799481);
                end if;

                if (coalesce(nr_seq_produto_w,0) = 0) and (coalesce(nr_seq_movto_cartao_w,0) <> 0) then
                        nr_seq_produto_w        := (substr(obter_prod_financ(nr_seq_movto_cartao_w, 'AC','P'),1,10))::numeric;
                elsif (coalesce(nr_seq_produto_w,0) = 0) and (nm_atributo_w = 'VL_TRANSACAO') then
                        nr_seq_produto_w        := (substr(obter_prod_financ(nr_seq_movto_trans_fin_w, 'MV','P'),1,10))::numeric;
                elsif (coalesce(nr_seq_produto_w,0) = 0) and (coalesce(nr_seq_titulo_receber_w,0) <> 0) then
                        nr_seq_produto_w        := (substr(obter_prod_financ(nr_seq_titulo_receber_w, 'TR','P'),1,10))::numeric;
                elsif (coalesce(nr_seq_produto_w,0) = 0) and (coalesce(nr_seq_titulo_pagar_w,0) <> 0) then
                        nr_seq_produto_w        := (substr(obter_prod_financ(nr_seq_titulO_pagar_w, 'TP','P'),1,10))::numeric;
                elsif (coalesce(nr_seq_produto_w,0) = 0) and (coalesce(nr_seq_nota_fiscal_w,0) <> 0) then
                        nr_seq_produto_w        := (substr(obter_prod_financ(nr_seq_nota_fiscal_w, 'NF','P'),1,10))::numeric;
                end if;

                if (nr_seq_trans_fin_w IS NOT NULL AND nr_seq_trans_fin_w::text <> '') then
                        begin
                        select  ie_contab_cb
                        into STRICT    ie_contab_cb_w
                        from    transacao_financeira
                        where   nr_sequencia    = nr_seq_trans_fin_w;
                        exception when others then
                                ie_contab_cb_w := 'N';
                        end;
                end if;

                if (coalesce(cd_historico_w::text, '') = '') and (ie_contab_cb_w = 'N') then
                        /*'Erro Gerar_Contab Conta banco ' ||
                        'Esta faltando o historico. Cadastre nos parametros do controle bancario ' ||
                        nr_documento_w ||  vl_transacao_w||'#@#@');*/
                        ds_macro_w      := substr('nr_documento=' || nr_documento_w || ';vl_transacao=' || vl_transacao_w,1,1000);
                        CALL wheb_mensagem_pck.exibir_mensagem_abort(182499,ds_macro_w);
                end if;

                if (ie_data_contabil_w = 'T') then
                        dt_contabil_w           := trunc(dt_movimento_w,'dd');
                end if;
                ds_obs_titulo_pagar_w   := '';
                nr_seq_rpa_w            := null;
                /* Francisco - OS 55132 - 23/04/07 - gravar parcela */

                if (coalesce(nr_seq_titulo_pagar_w,0) <> 0) then
                        select  coalesce(max(nr_parcelas),0),
                                max(nr_seq_trans_fin_baixa),
                                max(ds_observacao_titulo),
                                max(cd_tributo),
                                max(nr_seq_rpa)
                        into STRICT    nr_parcela_w,
                                nr_seq_trans_fin_baixa_w,
                                ds_obs_titulo_pagar_w,
                                cd_tributo_w,
                                nr_seq_rpa_w
                        from    titulo_pagar
                        where   nr_titulo = nr_seq_titulo_pagar_w;

                        ds_notas_titulo_unificado_w     := substr(fin_obter_notas_tit_pag_unif(nr_seq_titulo_pagar_w,2),1,255);
                end if;

                if (coalesce(nr_seq_titulo_pagar_w,0) <> 0) then

                        select  max(nr_seq_darf)
                        into STRICT    nr_seq_darf_w
                        from    darf_titulo_pagar
                        where   nr_titulo = nr_seq_titulo_pagar_w;

                        cd_processo_dcomp_w :=  substr(fis_obter_dcomp_darf(nr_seq_darf_w),1,255);
                end if;

                if (ie_contab_trans_fin_baixa_w = 'S') then
                        nr_seq_trans_fin_w      := coalesce(nr_seq_trans_fin_baixa_w,nr_seq_trans_fin_w);
                end if;

                if      coalesce(nr_seq_titulo_receber_w,0) > 0 then

                        if (coalesce(nr_Seq_baixa_cr_w, 0) <> 0) then

                                select  max(nr_seq_trans_fin)
                                into STRICT    nr_seq_trans_fin_baixa_w
                                from    titulo_receber_liq
                                where   nr_titulo       = nr_seq_titulo_receber_w
                                and             nr_sequencia = nr_Seq_baixa_cr_w;
                        else
                                select  max(nr_seq_trans_fin)
                                into STRICT    nr_seq_trans_fin_baixa_w
                                from    titulo_receber_liq
                                where   nr_titulo       = nr_seq_titulo_receber_w
                                and             nr_seq_movto_trans_fin = nr_seq_movto_trans_fin_w;
                        end if;

                        if (ie_contab_trans_fin_baix_rec_w = 'S') then
                                 nr_seq_trans_fin_w := coalesce(nr_seq_trans_fin_baixa_w,nr_seq_trans_fin_w);
                        end if;
                end if;

                /*Obter se contabiliza na conta do banco */

                select coalesce(max(ie_contab_banco),'S')
                into STRICT    ie_contab_banco_w
                from    transacao_financeira
                where   nr_sequencia            = nr_seq_trans_fin_w;

                /*Define beneficiario no caso de titulo a pagar */

                ds_benef_origem_w               := '';
                if (ie_benef_orig_trib_contab_w = 'S') and (nr_titulo_w > 0) then
                        ds_benef_origem_w :=    substr(Obter_Benef_Orig_Trib(nr_titulo_w),1,255);
                end if;

                if (ie_contab_vl_estorno_w = 'E') and (nr_seq_movto_orig_w <> 0) then
                        nr_seq_trans_w                  := nr_seq_movto_orig_w;
                        nr_seq_movto_trans_fin_w        := nr_seq_trans_w;
                end if;

                /*Define agrupamento, documento e historico */

                if (nm_agrupador_w = 'NR_SEQ_MOVTO_TRANS_FIN')then
                        nr_seq_agrupamento_w    := nr_seq_movto_trans_fin_w;
                elsif (nm_agrupador_w = 'NR_SEQ_MOVTO_TRANSF_BCO')then
                        nr_seq_agrupamento_w    := nr_seq_movto_transf_bco_w;
                elsif (nm_agrupador_w = 'NR_BORDERO')then
                        nr_seq_agrupamento_w    := nr_bordero_w;
                        if (coalesce(nr_bordero_w,0) = 0) and (coalesce(nr_bordero_rec_w,0) != 0) then
                                nr_seq_agrupamento_w    := nr_bordero_rec_w;
                        end if;
                elsif (nm_agrupador_w = 'NR_SEQ_CHEQUE')then
                        nr_seq_agrupamento_w    := nr_seq_cheque_w;
                elsif (nm_agrupador_w = 'NR_SEQ_CONTA_BANCO')then
                        nr_seq_agrupamento_w    := nr_seq_conta_banco_w;
                        if (coalesce(philips_param_pck.get_cd_pais,0) = 2) and (nm_atributo_w = 'VL_TRIBUTO_RECEBER') then
                                select  max(d.nr_conta)
                                into STRICT    nr_seq_agrupamento_w
                                from    titulo_receber_liq t,
                                                deposito d,
                                                deposito_cheque dc,
                                                cheque_cr c,
                                                caixa_receb cr
                                where   d.nr_sequencia          = dc.nr_seq_deposito
                                and             c.nr_seq_cheque         = dc.nr_seq_cheque
                                and             c.nr_seq_caixa_rec      = cr.nr_sequencia
                                and             t.nr_titulo                     = nr_seq_titulo_receber_w
                                and             t.nr_seq_caixa_rec      = cr.nr_sequencia;
                        end if;
                end if;

                if (ie_agrup_movto_transf_w = 'S') and (coalesce(nr_seq_movto_transf_bco_w,0) <> 0) then
                        nr_seq_agrupamento_w    := nr_seq_movto_transf_bco_w;
                end if;

                if (coalesce(nr_seq_agrupamento_w,0) = 0)    then
                        nr_seq_agrupamento_w    := nr_seq_movto_trans_fin_w;
                end if;

                /*Anderson e Fabio 20/04/2006 - OS 31866 - Incluido parametro no controle bancario para trazer o numero do bordero*/

                if (coalesce(nr_bordero_w,0) <> 0) and (ie_contab_bordero_w = 'S') and (somente_numero(nr_doc_w) <> nr_bordero_w) and (somente_numero(nr_documento_w) <> nr_bordero_w) and (nr_adiantamento_w = 0) then
                        nr_documento_w  := substr(nr_documento_w  || ' {' || nr_bordero_w || '} ',1,255);
                end if;

                if (ds_benef_origem_w IS NOT NULL AND ds_benef_origem_w::text <> '') then
                        nr_documento_w  := substr(nr_documento_w  || ' ' || ds_benef_origem_w,1,255);
                else
                        nr_documento_w  := substr(nr_documento_w  || ' ' || ds_hist_pf_pj_w,1,255);
                end if;
                if (ds_historico_w IS NOT NULL AND ds_historico_w::text <> '') then
                        nr_documento_w  := substr(nr_documento_w  || ' ' || ds_historico_w,1,255);
                end if;
                if (ie_hist_contabil_w = 'S') then
                        nr_documento_w  := substr(nr_documento_w  || ' ' || ds_banco_conta_w,1,255);
                end if;

                if      coalesce(nr_bordero_w,0) <> 0  then  -- Edgar 26/07/2006 OS 37008, incluir o nr_cheque
                        begin
                        select  nr_cheque,
                                ds_bordero
                        into STRICT    nr_cheque_w,
                                ds_bordero_w
                        from    bordero_pagamento
                        where   nr_bordero      = nr_bordero_w;
                        exception
                                when no_data_found then
                                        nr_cheque_w     := null;
                                        ds_bordero_w    := '';
                        end;

                        if (nr_cheque_w IS NOT NULL AND nr_cheque_w::text <> '') then
                                nr_documento_w          := substr(nr_documento_w  || ' Ch:' || nr_cheque_w,1,255);
                        end if;
                end if;

                if (coalesce(nr_seq_titulo_receber_w, 0) <> 0) then
                        select  a.ds_observacao_titulo
                        into STRICT    ds_obs_titulo_rec_w
                        from    titulo_receber a
                        where   a.nr_titulo     = nr_seq_titulo_receber_w;
                end if;

/*              Gerar o lancamento da conta do banco */

                if (ie_contab_banco_w = 'S') and (coalesce(cd_conta_contabil_banco_w::text, '') = '') then
                        /*'Esta faltando a conta contabil no cadastro do banco ' || ds_banco_w || chr(13) ||
                                'Docto= ' || nr_documento_w || ' Valor= ' || vl_transacao_w||'#@#@');*/
                        ds_macro_w := ds_banco_w || ' ' || wheb_mensagem_pck.get_texto(799482) || ' ' || coalesce(nr_documento_w,0) || ' ' || wheb_mensagem_pck.get_texto(799483) || ' '|| to_char(coalesce(vl_transacao_w,0));
                        CALL wheb_mensagem_pck.exibir_mensagem_abort(182507,'DS_ERRO_W=' || ds_macro_w);
                end if;

                if (coalesce(nr_seq_banco_escrit_w,0) <> 0) then

                        begin
                        select  max(a.ds_banco)
                        into STRICT    ds_banco_escrit_w
                        from    banco a,
                                banco_escritural b
                        where   a.cd_banco      = b.cd_banco
                        and     b.nr_sequencia  = nr_seq_banco_escrit_w;
                        exception
                                when others then
                                ds_banco_escrit_w := '';
                        end;
                else
                        nr_seq_banco_escrit_w   := null;
                end if;

                ds_conteudo_w           := '';
                ds_compl_historico_w    := '';
                if (ie_compl_hist_w = 'S') or (ie_compl_historico_banc_w = 'S') then

                        if (ie_compl_historico_banc_w = 'S') then
                                nr_documento_w  := '';
                        end if;

                        cd_banco_cheque_w               := null;
                        cd_banco_ext_cheque_w           := null;
                        ds_banco_cheque_w               := '';
                        cd_agencia_cheque_w             := null;
                        nr_conta_cheque_w               := null;
                        nr_adiant_cheque_w              := null;
                        nm_pf_cheque_w                  := '';
                        ds_razao_social_cheque_w        := '';
                        nr_cheque_cr_w                  := '';

                        if (coalesce(nr_seq_cheque_w,0) > 0) then
                                select  b.cd_banco,
                                        b.ds_banco,
                                        a.cd_agencia_bancaria,
                                        a.nr_conta,
                                        a.nr_adiantamento,
                                        a.nm_pessoa_fisica,
                                        a.ds_razao_social,
                                        a.nr_cheque,
                                        b.cd_banco_externo,
                                        substr(obter_dados_cheque_cr(a.nr_seq_cheque,'NP'),1,255)
                                into STRICT    cd_banco_cheque_w,
                                        ds_banco_cheque_w,
                                        cd_agencia_cheque_w,
                                        nr_conta_cheque_w,
                                        nr_adiant_cheque_w,
                                        nm_pf_cheque_w,
                                        ds_razao_social_cheque_w,
                                        nr_cheque_cr_w,
                                        cd_banco_ext_cheque_w,
                                        nm_paciente_cheque_w
                                from    banco           b,
                                        cheque_cr_v     a
                                where   a.nr_seq_cheque = nr_seq_cheque_w
                                and     a.cd_banco      = b.cd_banco;
                        end if;

                        if (coalesce(nr_seq_movto_cartao_w,0) > 0) then
                                ds_movto_cartao_w       := substr(obter_dados_cartao_cr(nr_seq_movto_cartao_w, 'DM'),1,255);
                                ds_bandeira_cartao_w    := substr(obter_dados_cartao_cr(nr_seq_movto_cartao_w, 'B'),1,255);
                                nm_pessoa_caixa_rec_w   := substr(obter_dados_cartao_cr(nr_seq_movto_cartao_w, 'PR'),1,255);

                                begin
                                select  max(ds_observacao)
                                into STRICT    ds_obs_movto_cartao_baixa_w
                                from    movto_cartao_cr_baixa
                                where   nr_seq_movto    = nr_seq_movto_cartao_w;
                                exception when others then
                                        ds_obs_movto_cartao_baixa_w := '';
                                end;

                                select  max(nr_seq_bandeira),
                                                max(substr(obter_nome_pf_pj(cd_pessoa_fisica, cd_cgc),1,255)),
                                                max(ds_comprovante),
                                                max(nr_seq_caixa_rec),
                                                max(cd_estabelecimento)
                                into STRICT    nr_seq_bandeira_cartao_w,
                                                ds_pessoa_rec_cartao_w,
                                                ds_comprovante_w,
                                                nr_seq_caixa_rec_w,
                                                cd_estab_inf_movto_w
                                from    movto_cartao_cr
                                where   nr_sequencia    = nr_seq_movto_cartao_w;

                                if (nr_seq_caixa_rec_w IS NOT NULL AND nr_seq_caixa_rec_w::text <> '') then
                                        ds_nota_fiscal_cartao_w := substr(obter_nf_caixa_rec(nr_seq_caixa_rec_w),1,150);
                                        ds_nfe_cartao_w := substr(obter_nfes(nr_seq_caixa_rec_w),1,150);
                                end if;

                                if (nr_seq_parc_cartao_w IS NOT NULL AND nr_seq_parc_cartao_w::text <> '') then

                                        nr_parcela_cartao_w     := somente_numero(substr(obter_numero_parcela_cartao(nr_seq_movto_cartao_w, nr_seq_parc_cartao_w),1,10));

                                        select  count(nr_sequencia)
                                        into STRICT    qt_parcelas_w
                                        from    movto_cartao_cr_parcela
                                        where   nr_seq_movto = nr_seq_movto_cartao_w;

                                        if (qt_parcelas_w > 0)then
                                                nr_parc_cartao_total_w  :=      substr(nr_parcela_cartao_w||'/'||qt_parcelas_w,1,40);
                                        end if;
                                end if;
                        end if;

                        if (coalesce(nr_seq_lote_cartao_w,0) <> 0) then
                                if (coalesce(nr_seq_bandeira_cartao_w::text, '') = '') then
                                        select  max(nr_seq_bandeira),
                                                max(nr_sequencia),
                                                max(substr(obter_desc_bandeira_cartao(nr_seq_bandeira),1,255))
                                        into STRICT    nr_seq_bandeira_cartao_w,
                                                nr_seq_baixa_cart_w,
                                                ds_bandeira_cartao_ww
                                        from    lote_baixa_cartao_cr
                                        where   nr_sequencia    = nr_seq_lote_cartao_w;
                                end if;
                        end if;

                        nr_cheque_pago_w        := '';

                        if (coalesce(nr_seq_cheque_cp_w,0) > 0) then
                                select  max(nr_cheque)
                                into STRICT    nr_cheque_pago_w
                                from    cheque
                                where   nr_sequencia    = nr_seq_cheque_cp_w;

                                ds_cheque_cp_w  := substr(obter_dados_cheque_cp(nr_seq_cheque_cp_w, 'DS'), 1,180);
                        end if;

                        if (coalesce(nr_cheque_pago_w,'0') = '0') then
                                nr_cheque_pago_w        := '';
                                open c04;
                                loop
                                fetch c04 into
                                        nr_cheque_bordero_w;
                                EXIT WHEN NOT FOUND; /* apply on c04 */
                                        if (length(nr_cheque_bordero_w || '/' || nr_cheque_pago_w) < 255) then
                                                nr_cheque_pago_w        := nr_cheque_bordero_w || '/' || nr_cheque_pago_w;
                                        end if;
                                end loop;
                                close c04;
                        end if;

                        nr_cheque_tit_pagar_w           := substr(OBTER_CHEQUE_TIT_PAGAR(nr_seq_titulo_pagar_w),1,100);

                        nr_cheque_adiant_pago_w         := '';
                        open c030;
                        loop
                        fetch c030 into
                                nr_cheque_adiant_w;
                        EXIT WHEN NOT FOUND; /* apply on c030 */
                                if (coalesce(nr_cheque_adiant_pago_w::text, '') = '') then
                                        nr_cheque_adiant_pago_w := substr(nr_cheque_adiant_w, 1, 255);
                                else
                                        nr_cheque_adiant_pago_w := substr(nr_cheque_adiant_pago_w || ', ' || nr_cheque_adiant_w, 1, 255);
                                end if;
                        end loop;
                        close c030;

                        if (coalesce(nr_seq_caixa_od_w,0) > 0) then
                                select  max(ds_caixa)
                                into STRICT    ds_caixa_od_w
                                from    caixa
                                where   nr_sequencia = nr_seq_caixa_od_w;
                        end if;

                        ds_banco_od_w   := '';
                        nr_conta_od_w   := '';
                        cd_estab_banco_od_w     := null;
                        cd_estab_intercompany_w := null;

                        if (coalesce(nr_seq_banco_od_w,0) > 0) then
                                select  max(ds_banco),
                                        max(cd_conta),
                                        max(ds_interno),
                                        max(cd_estabelecimento)
                                into STRICT    ds_banco_od_w,
                                                nr_conta_od_w,
                                                ds_interno_w,
                                                cd_estab_banco_od_w
                                from    banco_estabelecimento_v
                                where   nr_sequencia    = nr_seq_banco_od_w;
                                /* OS 1968954 - Inclusao Intercompany da Holding */

                                ie_intercompany_w       := holding_pck.get_se_intercompany(cd_estabelecimento_w, cd_estab_banco_od_w);
                                if (ie_intercompany_w = 'S') then
                                        cd_estab_intercompany_w := cd_estab_banco_od_w;
                                end if;
                        end if;
                        ie_nf_nfe_w             := '';
                        nr_nota_fiscal_w        := '';
                        nr_nfe_imp_w            := '';
			cd_serie_nf_w           := null;

                        if (coalesce(nr_seq_nota_fiscal_w,0) > 0) then
                                select  a.nr_nota_fiscal,
                                        substr('NF' || CASE WHEN coalesce(b.ie_servico,'N')='S' THEN 'S' END  || CASE WHEN coalesce(a.ie_nf_eletronica,'N')='S' THEN 'E' END ,1,15),
                                        a.nr_nfe_imp,
										a.cd_serie_nf
                                into STRICT    nr_nota_fiscal_w,
                                        ie_nf_nfe_w,
                                        nr_nfe_imp_w,
					cd_serie_nf_w
                                from    nota_fiscal a,
                                        operacao_nota b
                                where   a.cd_operacao_nf        = b.cd_operacao_nf
                                and     a.nr_sequencia          = nr_seq_nota_fiscal_w;
                        end if;

                        if (coalesce(nr_seq_nota_fiscal_w,0) = 0) and (coalesce(nr_nota_fiscal_w,'0') = '0') then
                                if (coalesce(nr_nota_fiscal_w,'0') = '0') and (coalesce(nr_seq_titulo_receber_w,0) <> 0)then
                                        nr_nota_fiscal_w        := somente_numero(substr(coalesce(obter_dados_titulo_receber(nr_seq_titulo_receber_w,'NFT'),'0'),1,20));
                                        nr_nfe_imp_w            := substr(coalesce(obter_dados_titulo_receber(nr_seq_titulo_receber_w,'NE'),'0'),1,20);
					cd_serie_nf_w           := substr(coalesce(obter_dados_titulo_receber(nr_seq_titulo_receber_w,'CDS'),'0'),1,20);
                                end if;
                                if (coalesce(nr_nota_fiscal_w,'0') = '0') and (coalesce(nr_seq_titulo_pagar_w,0) <> 0) then
                                        nr_nota_fiscal_w        := somente_numero(substr(coalesce(obter_dados_tit_pagar(nr_seq_titulo_pagar_w,'NF'),'0'),1,20));
                                        nr_nota_fiscal_w        := substr(coalesce(obter_dados_tit_pagar(nr_seq_titulo_pagar_w,'NFE'),'0'),1,20);
                                end if;
                        end if;

                        if (coalesce(nr_nota_fiscal_w, 0) = 0) and (nm_atributo_w in ('VL_TRANSACAO', 'VL_CHEQUE_DEPOSITO')) then
                                nr_seq_titulo_cheque_w := null;
                                if (coalesce(nr_seq_cheque_w, 0) <> 0) then
                                        begin
                                        select  nr_titulo
                                        into STRICT    nr_seq_titulo_cheque_w
                                        from    cheque_cr
                                        where   nr_seq_cheque   = nr_seq_cheque_w;
                                        exception when others then
                                                nr_seq_titulo_cheque_w  := null;
                                        end;
                                end if;
                                if (coalesce(nr_seq_deposito_w, 0) <> 0) and
                                        ((coalesce(nr_seq_cheque_w, 0) = 0) or (coalesce(nr_seq_titulo_cheque_w, 0) = 0)) then
                                        begin
                                        select  a.nr_titulo
                                        into STRICT    nr_seq_titulo_cheque_w
                                        from    cheque_cr a ,
                                                deposito_cheque b
                                        where   a.nr_seq_cheque = b.nr_seq_cheque
                                        and     b.nr_seq_deposito = nr_seq_deposito_w;
                                        exception when others then
                                                nr_seq_titulo_cheque_w  := null;
                                        end;
                                end if;
                                if (coalesce(nr_seq_titulo_cheque_w,0) <> 0) then
                                        nr_nota_fiscal_w        := somente_numero(substr(obter_dados_titulo_receber(nr_seq_titulo_cheque_w,'NFT'),1,100));
                                        nr_nfe_imp_w            := substr(coalesce(obter_dados_titulo_receber(nr_seq_titulo_cheque_w,'NE'),'0'),1,20);
					cd_serie_nf_w           := substr(coalesce(obter_dados_titulo_receber(nr_seq_titulo_cheque_w,'CDS'),'0'),1,20);
                                end if;
                        end if;

                        if (coalesce(nr_seq_titulo_receber_w::text, '') = '') and (nr_seq_perda_w IS NOT NULL AND nr_seq_perda_w::text <> '') then

                                select  max(nr_titulo)
                                into STRICT    nr_seq_titulo_receber_w
                                from    perda_contas_receber
                                where   nr_sequencia    = nr_seq_perda_w;

                        end if;

                        if (coalesce(nr_seq_cheque_dep_w,0) <> 0) then
                                nr_cheque_deposito_w    := substr(obter_dados_cheque_cr(nr_seq_cheque_dep_w,'N'),1,255);
                        end if;

                        nm_pessoa_adiant_pago_w         := '';
                        ds_obs_adiant_pago_w            := '';

                        if (coalesce(nr_adiant_pago_w,0) <> 0) then
                                select  max(substr(obter_nome_pf_pj(cd_pessoa_fisica,cd_cgc),1,255)),
                                        max(substr(ds_observacao,1,200))
                                into STRICT    nm_pessoa_adiant_pago_w,
                                        ds_obs_adiant_pago_w
                                from    adiantamento_pago
                                where   nr_adiantamento = nr_adiant_pago_w;
                        end if;

                        nm_pessoa_adiantamento_w        := '';
                        nm_paciente_adiantamento_w      := '';

                        if (coalesce(nr_adiantamento_w,0) <> 0) then
                                select  max(substr(obter_nome_pf_pj(cd_pessoa_fisica,cd_cgc),1,200)),
                                        max(substr(obter_paciente_adiantamento(nr_adiantamento_w,'N'),1,60))
                                into STRICT    nm_pessoa_adiantamento_w,
                                        nm_paciente_adiantamento_w
                                from    adiantamento
                                where   nr_adiantamento = nr_adiantamento_w;
                        end if;

                        ds_proj_rec_w   := '';

                        if (coalesce(nr_seq_proj_rec_w,0) <> 0) then
                                begin
                                select  ds_projeto
                                into STRICT    ds_proj_rec_w
                                from    projeto_recurso
                                where   nr_sequencia    = nr_seq_proj_rec_w;
                                exception when others then
                                        ds_proj_rec_w   := '';
                                end;
                        end if;

                        nm_pf_pj_tit_original_w := '';

                        if (coalesce(nr_titulo_w,0) <> 0) then
                                begin
                                select  nr_titulo_original
                                into STRICT    nr_titulo_original_w
                                from    titulo_pagar
                                where   nr_titulo       = nr_titulo_w;
                                exception when others then
                                        nr_titulo_original_w := null;
                                end;

                                if (coalesce(nr_titulo_original_w,0) <> 0) then
                                        begin
                                        select  substr(obter_dados_pf_pj(a.cd_pessoa_fisica,a.cd_cgc,'N'),1,80)
                                        into STRICT    nm_pf_pj_tit_original_w
                                        from    titulo_pagar a
                                        where   nr_titulo = nr_titulo_original_w;
                                        exception
                                        when others then
                                                nm_pf_pj_tit_original_w := '';
                                        end;
                                end if;
                        end if;

                        if (nr_nota_fiscal_w = '0') then
                                nr_nota_fiscal_w := null;
                        end if;

                        cd_estab_intercompany_ori_w := null;
                        ds_estab_intercompany_ori_w := null;
                        cd_estab_intercompany_des_w := null;
                        ds_estab_intercompany_des_w := null;
                        cd_interno_intercompany_ori_w := null;
                        cd_interno_intercompany_des_w := null;

                        if holding_pck.get_se_intercompany_btw_estab(cd_estabelecimento_w, cd_estab_banco_od_w) = 'S' then                              
                            cd_estab_intercompany_ori_w := cd_estab_banco_od_w;
                            ds_estab_intercompany_ori_w := substr(obter_nome_estabelecimento(cd_estab_banco_od_w),1,255);
                            cd_estab_intercompany_des_w := cd_estabelecimento_w;
                            ds_estab_intercompany_des_w := nm_estabelecimento_w;

                             begin
                                select cd_interno
                                into STRICT cd_interno_intercompany_ori_w
                                from estabelecimento
                                where cd_estabelecimento = cd_estab_intercompany_ori_w
                                and cd_empresa = obter_empresa_estab(cd_estab_intercompany_ori_w);
                            exception
                                when no_data_found then
                                    cd_interno_intercompany_ori_w := null;
                                when too_many_rows then
                                    cd_interno_intercompany_ori_w := null;
                                when others then
                                    cd_interno_intercompany_ori_w := null;
                            end;

                            begin
                                select cd_interno
                                into STRICT cd_interno_intercompany_des_w
                                from estabelecimento
                                where cd_estabelecimento = cd_estab_intercompany_des_w
                                and cd_empresa = obter_empresa_estab(cd_estab_intercompany_des_w);
                            exception
                                when no_data_found then
                                    cd_interno_intercompany_des_w := null;
                                when too_many_rows then
                                    cd_interno_intercompany_des_w := null;
                                when others then
                                    cd_interno_intercompany_des_w := null;
                            end;
                         end if;

                        ds_conteudo_w   :=      substr(cd_cgc_w                 || '#@' ||
                                                cd_historico_movto_w            || '#@' ||
                                                nr_bordero_w                    || '#@' ||
                                                ds_benef_origem_w               || '#@' ||
                                                ds_hist_pf_pj_w                 || '#@' ||
                                                nr_doc_w                        || '#@' ||
                                                ds_historico_w                  || '#@' ||
                                                ds_banco_conta_w                || '#@' ||
                                                nr_cheque_w                     || '#@' ||
                                                nr_seq_trans_w                  || '#@' ||
                                                nr_adiantamento_w               || '#@' ||
                                                nr_adiant_pago_w                || '#@' ||
                                                nr_bordero_rec_w                || '#@' ||
                                                nr_interno_conta_w              || '#@' ||
                                                nr_seq_nota_fiscal_w            || '#@' ||
                                                nr_seq_titulo_pagar_w           || '#@' ||
                                                nr_seq_titulo_receber_w         || '#@' ||
                                                cd_banco_cheque_w               || '#@' ||
                                                ds_banco_cheque_w               || '#@' ||
                                                cd_agencia_cheque_w             || '#@' ||
                                                nr_conta_cheque_w               || '#@' ||
                                                nr_adiant_cheque_w              || '#@' ||
                                                nm_pf_cheque_w                  || '#@' ||
                                                ds_razao_social_cheque_w        || '#@' ||
                                                ds_banco_w                      || '#@' ||
                                                nr_cheque_pago_w                || '#@' ||
                                                nr_parcela_w                    || '#@' ||
                                                ds_compl_contab_cp_w            || '#@' ||
                                                nr_cheque_adiant_pago_w         || '#@' ||
                                                ds_caixa_od_w                   || '#@' ||
                                                ds_movto_cartao_w               || '#@' ||
                                                nr_cheque_cr_w                  || '#@' ||
                                                ds_banco_od_w                   || '#@' ||
                                                nr_conta_od_w                   || '#@' ||
                                                ds_pessoa_titulo_w              || '#@' ||
                                                nr_nota_fiscal_w                || '#@' ||
                                                nr_cheque_tit_pagar_w           || '#@' ||
                                                cd_banco_ext_cheque_w           || '#@' ||
                                                ds_interno_w                    || '#@' ||
                                                nr_cheque_deposito_w            || '#@' ||
                                                nm_pessoa_adiant_pago_w         || '#@' ||
                                                nr_seq_banco_escrit_w           || '#@' ||
                                                ds_banco_escrit_w               || '#@' ||
                                                ds_obs_movto_cartao_baixa_w     || '#@' ||
                                                ds_obs_titulo_rec_w             || '#@' ||
                                                ds_bandeira_cartao_w            || '#@' ||
                                                ds_obs_adiant_pago_w            || '#@' ||
                                                ds_obs_titulo_pagar_w           || '#@' ||
                                                nm_pessoa_caixa_rec_w           || '#@' ||
                                                ds_pessoa_rec_cartao_w          || '#@' ||
                                                ds_comprovante_w                || '#@' ||
                                                nm_estabelecimento_w            || '#@' ||
                                                nr_seq_proj_rec_w               || '#@' ||
                                                ds_proj_rec_w                   || '#@' ||
                                                nm_pessoa_adiantamento_w        || '#@' ||
                                                ds_cheque_cp_w                  || '#@' ||
                                                nr_seq_movto_bco_pend_w         || '#@' ||
                                                ds_notas_titulo_unificado_w     || '#@' ||
                                                ds_nota_fiscal_cartao_w         || '#@' ||
                                                nr_parcela_cartao_w             || '#@' ||
                                                nr_seq_cni_w                    || '#@' ||
                                                ds_bordero_w                    || '#@' ||
                                                nm_paciente_adiantamento_w      || '#@' ||
                                                nr_seq_deposito_w               || '#@' ||
                                                nr_seq_baixa_cart_w             || '#@' ||
                                                ds_bandeira_cartao_ww           || '#@' ||
                                                nm_pf_pj_tit_original_w         || '#@' ||
                                                nr_seq_cobr_escrit_w            || '#@' ||
                                                ie_nf_nfe_w                     || '#@' ||
                                                ie_estorno_ww                   || '#@' ||
                                                nr_seq_concil_w                 || '#@' ||
                                                nm_paciente_cheque_w            || '#@' ||
                                                ds_tributo_w                    || '#@' ||
                                                nr_parc_cartao_total_w          || '#@' ||
                                                cd_processo_dcomp_w             || '#@' ||
                                                null                            || '#@' ||
                                                nr_nfe_imp_w                    || '#@' ||
                                                ds_nfe_cartao_w                 || '#@' ||
                                                nr_seq_rpa_w                    || '#@' ||
                                                nr_seq_cni_orig_w		        || '#@' ||
                                                cd_estab_intercompany_ori_w     || '#@' ||
                                                ds_estab_intercompany_ori_w     || '#@' ||
                                                cd_estab_intercompany_des_w     || '#@' ||
                                                ds_estab_intercompany_des_w     || '#@' ||
                                                cd_interno_intercompany_ori_w   || '#@' ||
                                                cd_interno_intercompany_des_w   || '#@' ||
						cd_serie_nf_w,1,4000);
												
												
                        select  obter_compl_historico(cd_tipo_lote_contabil_w, cd_Historico_w, ds_conteudo_w)
                        into STRICT    ds_compl_historico_w
;
                end if;

                nr_documento_w  := substr(coalesce(ds_compl_historico_w, nr_documento_w),1,255);
                nr_documento_w  := substr(nr_documento_w || ds_estorno_w,1,255);


                ie_origem_documento_w   := null;
                nr_documento_ww         := null;

                ds_atributos_w  := null;

                begin
                if (coalesce(nr_nota_fiscal_w, 0) <> 0) and (coalesce(nr_seq_nota_fiscal_w,0) = 0) then
                        select  max(nr_sequencia)
                        into STRICT    nr_seq_nota_fiscal_w
                        from    nota_fiscal
                        where   nr_nota_fiscal = nr_nota_fiscal_w
                        and     cd_estabelecimento = cd_estabelecimento_w;

                        if (coalesce(nr_seq_nota_fiscal_w,0) <> 0) then
                                select  nr_nfe_imp,
					cd_serie_nf							
                                into STRICT    nr_nfe_imp_w,
					cd_serie_nf_w
                                from    nota_fiscal
                                where   nr_sequencia = nr_seq_nota_fiscal_w;
                        end if;
                end if;

                exception
                when others then
                        nr_seq_nota_fiscal_w:= null;
                end;

                if (nr_nota_fiscal_w = '0') then
                                nr_nota_fiscal_w := null;
                end if;

                ds_atributos_w  :=      'NR_BORDERO_PAGAR=' || nr_bordero_w || ';' ||
                                        'NR_BORDERO_RECEBER=' || nr_bordero_rec_w || ';' ||
                                        'NR_TITULO_RECEBER=' || nr_seq_titulo_receber_w || ';' ||
                                        'NR_TITULO_PAGAR=' || nr_seq_titulo_pagar_w || ';' ||
                                        'NR_NOTA_FISCAL=' || nr_nota_fiscal_w || ';' ||
                                        'NR_SEQ_NOTA_FISCAL=' || nr_seq_nota_fiscal_w || ';' ||
                                        'NR_SEQ_MOVTO_CONTROLE_BANCARIO=' || nr_seq_movto_trans_fin_w;

                ctb_obter_doc_movto(    cd_tipo_lote_contabil_w,
                                        nm_atributo_w,
                                        'VR',
                                        dt_contabil_w,
                                        null,
                                        null,
                                        ds_atributos_w,
                                        nm_usuario_p,
                                        ie_regra_w,
                                        nr_documento_ww,
                                        ie_origem_documento_w);

                if (coalesce(nr_documento_ww, 0) = 0) then
                        nr_documento_ww:= nr_seq_movto_trans_fin_w;
                        ie_origem_documento_w:= '11';
                end if;

                if (ie_debito_credito_w <> 'T') and (ie_contab_banco_w = 'S') then

                        vl_cheque_w     := 0;

                        if      coalesce(nr_bordero_w,0) <> 0 then
                                select  coalesce(sum(vl_cheque),0)
                                into STRICT    vl_cheque_w
                                from    cheque_v
                                where   nr_sequencia in (
                                        SELECT  nr_seq_cheque
                                        from    cheque_bordero_titulo
                                        where   nr_bordero      = nr_bordero_w)
                                and     coalesce(dt_cancelamento::text, '') = '';
                        end if;

                        /* Francisco - OS 84288 - 22/04/2008 - Inclui o "ABS" abaixo para o estorno contabilizar da mesma forma */

                        if (abs(vl_cheque_w)  = abs(vl_transacao_w)) and
                                coalesce(nr_bordero_w,0) <> 0 then

                                OPEN C020;
                                LOOP
                                FETCH C020 INTO
                                        nr_cheque_w,
                                        vl_cheque_w;
                                EXIT WHEN NOT FOUND; /* apply on c020 */
                                        begin
                                        /* Edgar 05/07/2008, OS 96585, tratar compl nos casos de cheque */

                                        DS_CONTEUDO_W           := '';
                                        ds_compl_historico_w    := '';
                                        if (ie_compl_hist_w = 'S') or (ie_compl_historico_banc_w = 'S') then


                                                if (nr_nota_fiscal_w = '0') then
                                                        nr_nota_fiscal_w := null;
                                                end if;
                                                ds_conteudo_w   :=      substr(cd_cgc_w                 || '#@' ||
                                                                        cd_historico_movto_w            || '#@' ||
                                                                        nr_bordero_w                    || '#@' ||
                                                                        ds_benef_origem_w               || '#@' ||
                                                                        ds_hist_pf_pj_w                 || '#@' ||
                                                                        nr_doc_w                        || '#@' ||
                                                                        ds_historico_w                  || '#@' ||
                                                                        ds_banco_conta_w                || '#@' ||
                                                                        nr_cheque_w                     || '#@' ||
                                                                        nr_seq_trans_w                  || '#@' ||
                                                                        nr_adiantamento_w               || '#@' ||
                                                                        nr_adiant_pago_w                || '#@' ||
                                                                        nr_bordero_rec_w                || '#@' ||
                                                                        nr_interno_conta_w              || '#@' ||
                                                                        nr_seq_nota_fiscal_w            || '#@' ||
                                                                        nr_seq_titulo_pagar_w           || '#@' ||
                                                                        nr_seq_titulo_receber_w         || '#@' ||
                                                                        cd_banco_cheque_w               || '#@' ||
                                                                        ds_banco_cheque_w               || '#@' ||
                                                                        cd_agencia_cheque_w             || '#@' ||
                                                                        nr_conta_cheque_w               || '#@' ||
                                                                        nr_adiant_cheque_w              || '#@' ||
                                                                        nm_pf_cheque_w                  || '#@' ||
                                                                        ds_razao_social_cheque_w        || '#@' ||
                                                                        ds_banco_w                      || '#@' ||
                                                                        nr_cheque_pago_w                || '#@' ||
                                                                        nr_parcela_w                    || '#@' ||
                                                                        ds_compl_contab_cp_w            || '#@' ||
                                                                        nr_cheque_adiant_pago_w         || '#@' ||
                                                                        ds_caixa_od_w                   || '#@' ||
                                                                        ds_movto_cartao_w               || '#@' ||
                                                                        nr_cheque_cr_w                  || '#@' ||
                                                                        ds_banco_od_w                   || '#@' ||
                                                                        nr_conta_od_w                   || '#@' ||
                                                                        ds_pessoa_titulo_w              || '#@' ||
                                                                        nr_nota_fiscal_w                || '#@' ||
                                                                        nr_cheque_tit_pagar_w           || '#@' ||
                                                                        ds_interno_w                    || '#@' ||
                                                                        nr_cheque_deposito_w            || '#@' ||
                                                                        nm_pessoa_adiant_pago_w         || '#@' ||
                                                                        nr_seq_banco_escrit_w           || '#@' ||
                                                                        ds_banco_escrit_w               || '#@' ||
                                                                        ds_obs_movto_cartao_baixa_w     || '#@' ||
                                                                        ds_obs_titulo_rec_w             || '#@' ||
                                                                        ds_bandeira_cartao_w            || '#@' ||
                                                                        ds_obs_adiant_pago_w            || '#@' ||
                                                                        ds_obs_titulo_pagar_w           || '#@' ||
                                                                        nm_pessoa_caixa_rec_w           || '#@' ||
                                                                        ds_pessoa_rec_cartao_w          || '#@' ||
                                                                        ds_comprovante_w                || '#@' ||
                                                                        nm_estabelecimento_w            || '#@' ||
                                                                        nr_seq_proj_rec_w               || '#@' ||
                                                                        ds_proj_rec_w                   || '#@' ||
                                                                        nm_pessoa_adiantamento_w        || '#@' ||
                                                                        ds_cheque_cp_w                  || '#@' ||
                                                                        nr_seq_movto_bco_pend_w         || '#@' ||
                                                                        ds_notas_titulo_unificado_w     || '#@' ||
                                                                        ds_nota_fiscal_cartao_w         || '#@' ||
                                                                        nr_parcela_cartao_w             || '#@' ||
                                                                        nr_seq_cni_w                    || '#@' ||
                                                                        nm_paciente_adiantamento_w      || '#@' ||
                                                                        ds_bordero_w                    || '#@' ||
                                                                        nr_seq_deposito_w               || '#@' ||
                                                                        nm_pf_pj_tit_original_w         || '#@' ||
                                                                        nr_seq_cobr_escrit_w            || '#@' ||
                                                                        ie_nf_nfe_w                     || '#@' ||
                                                                        ie_estorno_ww                   || '#@' ||
                                                                        nr_seq_concil_w                 || '#@' ||
                                                                        nm_paciente_cheque_w            || '#@' ||
                                                                        ds_tributo_w                    || '#@' ||
                                                                        nr_parc_cartao_total_w          || '#@' ||
                                                                        cd_processo_dcomp_w             || '#@' ||
                                                                        null                            || '#@' ||
                                                                        nr_nfe_imp_w                    || '#@' ||
                                                                        ds_nfe_cartao_w                 || '#@' ||
                                                                        nr_seq_rpa_w                    || '#@' ||
                                                                        nr_seq_cni_orig_w               || '#@' ||
                                                                        cd_estab_intercompany_ori_w     || '#@' ||
                                                                        ds_estab_intercompany_ori_w     || '#@' ||
                                                                        cd_estab_intercompany_des_w     || '#@' ||
                                                                        ds_estab_intercompany_des_w     || '#@' ||
                                                                        cd_interno_intercompany_ori_w   || '#@' ||
                                                                        cd_interno_intercompany_des_w   || '#@' ||
									cd_serie_nf_w,1,4000);

                                                ds_compl_historico_w    := obter_compl_historico(cd_tipo_lote_contabil_w, cd_Historico_w, ds_conteudo_w);
                                        end if;
                                        nr_doc_cheque_w         := substr(coalesce(ds_compl_historico_w, nr_documento_w),1,255);

                                        /* Francisco - OS 84288 - 22/04/2008 - Fiz esse tratamento pois senao o estorno
                                        duplicava o valor lancado original, Ex: ao inves de lancar 1 debito e 1 credito, lancava 2 creditos */
                                        if (vl_transacao_w < 0) then
                                                vl_cheque_w     := vl_cheque_w * -1;
                                        end if;
                                        /* Fim alteracao Francisco - 22/04/2008*/

                                        select  coalesce(max(nr_sequencia),0) + 1
                                        into STRICT    nr_sequencia_w
                                        from    w_movimento_contabil
                                        where   nr_lote_contabil        = nr_lote_contabil_p;

                                        if (coalesce(cd_historico_w::text, '') = '')  then
                                                /*'Falta informar o historico do banco no cadastro da Transacao Financeira: ' || chr(13) || chr(10) ||
                                                        nr_seq_trans_fin_w || '#@#@');*/
                                                CALL wheb_mensagem_pck.exibir_mensagem_abort(182516,nr_seq_trans_fin_w);
                                        end if;

                                        insert  into w_movimento_contabil(      nr_lote_contabil,
                                                                                                                nr_sequencia,
                                                                                                                cd_conta_contabil,
                                                                                                                ie_debito_credito,
                                                                                                                cd_historico,
                                                                                                                dt_movimento,
                                                                                                                vl_movimento,
                                                                                                                ds_doc_agrupamento,
                                                                                                                nr_seq_agrupamento,
                                                                                                                cd_centro_custo,
                                                                                                                ds_compl_historico,
                                                                                                                nr_seq_trans_fin,
                                                                                                                nr_documento,
                                                                                                                cd_pessoa_fisica,
                                                                                                                cd_cgc, ie_transitorio,
                                                                                                                nm_tabela,
                                                                                                                nm_atributo,
                                                                                                                nr_seq_info,
                                                                                                                nr_seq_tab_orig,
                                                                                                                nr_seq_tab_compl,
                                                                                                                ie_origem_documento,
                                                                                                                ie_intercompany,
                                                                                                                cd_estab_intercompany)

                                                                                                values ( nr_lote_contabil_p,
                                                                                                                nr_sequencia_w,
                                                                                                                cd_conta_contabil_banco_w,
                                                                                                                ie_debito_credito_w,
                                                                                                                cd_historico_w,
                                                                                                                dt_contabil_w,
                                                                                                                vl_cheque_w,
                                                                                                                nr_seq_agrupamento_w,
                                                                                                                nr_seq_agrupamento_w,
                                                                                                                null,
                                                                                                                nr_doc_cheque_w,
                                                                                                                nr_seq_trans_fin_w,
                                                                                                                nr_documento_ww,
                                                                                                                cd_pessoa_fisica_w,
                                                                                                                cd_cgc_w,
                                                                                                                'N',
                                                                                                                nm_tabela_w,
                                                                                                                nm_atributo_w,
                                                                                                                nr_seq_info_ctb_w,
                                                                                                                nr_seq_tab_orig_w,
                                                                                                                nr_seq_tab_compl_w,
                                                                                                                ie_origem_documento_w,
                                                                                                                ie_intercompany_w,
                                                                                                                cd_estab_intercompany_w);

                                        exception when others then
                                                ds_erro_w       := SQLERRM(SQLSTATE);

                                        ds_macro_w      := substr(
                                                'cd_conta_contabil_w='  || cd_conta_contabil_w  || ';' ||
                                                'nr_documento_w='       || nr_documento_w       || ';' ||
                                                'nr_sequencia_w='       || nr_sequencia_w       || ';' ||
                                                'nr_seq_trans_fin_w='   || nr_seq_trans_fin_w   || ';' ||
                                                'vl_transacao_w='       || vl_transacao_w       || ';' ||
                                                'ds_erro_w='            || ds_erro_w,1,1000);
                                                CALL wheb_mensagem_pck.exibir_mensagem_abort(339442,ds_macro_w);

                                                /*'Erro Gerar_Contab_Trans_Financ ' ||
                                                        ' cta=' || cd_conta_contabil_w || ' doc =' || nr_documento_w || chr(10) ||
                                                        ' seq=' || nr_sequencia_w || ' trans=' || nr_seq_trans_fin_w ||
                                                        ' val=' || vl_transacao_w || chr(10) || ds_erro_w||'#@#@');*/
                                        end;
                                end loop;
                                close c020;
                        elsif (nm_atributo_w <> 'VL_CHEQUE_DEPOSITO') then
                                begin

                                select  coalesce(max(nr_sequencia),0) + 1
                                into STRICT    nr_sequencia_w
                                from    w_movimento_contabil
                                where   nr_lote_contabil        = nr_lote_contabil_p;

                                if (coalesce(cd_historico_w::text, '') = '') then
                                        CALL wheb_mensagem_pck.exibir_mensagem_abort(182516,nr_seq_trans_fin_w);
                                end if;

                                insert into w_movimento_contabil(
                                        nr_lote_contabil,
                                        nr_sequencia,
                                        cd_conta_contabil,
                                        ie_debito_credito,
                                        cd_historico,
                                        dt_movimento,
                                        vl_movimento,
                                        ds_doc_agrupamento,
                                        nr_seq_agrupamento,
                                        cd_centro_custo,
                                        ds_compl_historico,
                                        nr_seq_trans_fin,
                                        nr_documento,
                                        cd_pessoa_fisica,
                                        cd_cgc,
                                        ie_transitorio,
                                        nm_tabela,
                                        nm_atributo,
                                        nr_seq_info,
                                        ie_origem_documento,
                                        nr_seq_tab_orig,
                                        nr_seq_tab_compl,
                                        ie_intercompany,
                                        cd_estab_intercompany)
                                values (
                                        nr_lote_contabil_p,
                                        nr_sequencia_w,
                                        cd_conta_contabil_banco_w,
                                        ie_debito_credito_w,
                                        cd_historico_w,
                                        dt_contabil_w,
                                        vl_transacao_w,
                                        nr_seq_agrupamento_w,
                                        nr_seq_agrupamento_w,
                                        null,
                                        nr_documento_w,
                                        nr_seq_trans_fin_w,
                                        nr_documento_ww,
                                        cd_pessoa_fisica_w,
                                        cd_cgc_w,
                                        'N',
                                        nm_tabela_w,
                                        nm_atributo_w,
                                        nr_seq_info_ctb_w,
                                        ie_origem_documento_w,
                                        nr_seq_tab_orig_w,
                                        nr_seq_tab_compl_w,
                                        ie_intercompany_w,
                                        cd_estab_intercompany_w);

                                exception when others then
                                        ds_erro_w       := SQLERRM(SQLSTATE);

                                        if (nr_seq_trans_fin_w IS NOT NULL AND nr_seq_trans_fin_w::text <> '') then
                                                select  cd_transacao,
                                                        ds_transacao,
                                                        cd_estabelecimento
                                                into STRICT    cd_transacao_w,
                                                        ds_transacao_w,
                                                        cd_estab_trans_fin_w
                                                from    transacao_financeira
                                                where   nr_sequencia = nr_seq_trans_fin_w;
                                        end if;

                                        ds_macro_w      := substr(
                                                        'cd_conta_contabil_w='  || cd_conta_contabil_w  || ';' ||
                                                        'nr_documento_w='       || nr_documento_w       || ';' ||
                                                        'nr_sequencia_w='       || nr_sequencia_w       || ';' ||
                                                        'nr_seq_trans_fin_w='   || nr_seq_trans_fin_w   || ';' ||
                                                        'cd_transacao_w='       || cd_transacao_w       || ';' ||
                                                        'ds_transacao_w='       || ds_transacao_w       || ';' ||
                                                        'cd_estabelecimento_w=' || cd_estabelecimento_w || ';' ||
                                                        'vl_transacao_w='       || vl_transacao_w       || ';' ||
                                                        'ds_erro_w='            || ds_erro_w,1,1000);
                                                        CALL wheb_mensagem_pck.exibir_mensagem_abort(339400,ds_macro_w);

                                        /*'Erro Gerar_Contab_Trans_Financ ' || chr(10) ||
                                                ' cta=' || cd_conta_contabil_w || ' doc =' || nr_documento_w ||  chr(10) ||
                                                ' seq=' || nr_sequencia_w || ' trans=' || nr_seq_trans_fin_w ||
                                                ' val=' || vl_transacao_w || chr(10) || ds_erro_w||'#@#@');*/
                                end;
                        end if;
                end if;
                /*Gerar a contra-partida do lancamento da conta do banco */

                if (ie_contab_w = 'S') then

                        /* Francisco - OS 100412 - 14/08/08 - Contabilizar OPS separadamente */

                        if (nm_atributo_w = 'VL_REC_PLS') Then
                                if (ie_compl_hist_w = 'S') then
                                        select  substr(obter_compl_historico(cd_tipo_lote_contabil_w, cd_Historico_pls_w, ds_conteudo_w),1,255)
                                        into STRICT    ds_compl_historico_w
;
                                end if;

                                if (ie_contab_baixas_pro_rata_w = 'A') then
                                        nr_sequencia_w := pls_contabiliza_pro_rata(nr_lote_contabil_p, cd_tipo_lote_contabil_w, ie_lote_pro_rata_w, dt_contab_lote_w, cd_pessoa_fisica_w, cd_cgc_w, ds_conteudo_w, nr_seq_trans_fin_w, ie_compl_hist_w, nr_titulo_w, nr_seq_baixa_w, nr_seq_liq_cc_w, nm_usuario_p, nr_seq_agrupamento_w, nr_sequencia_w);
                                elsif (ie_contab_baixas_pro_rata_w = 'S') then

                                        nr_sequencia_w := pls_contabiliza_baixa_pro_rata( nr_lote_contabil_p, ie_tipo_lote_pls_w, vl_antecipacao_mens_w, dt_movimento_w, vl_transacao_w, nr_titulo_w, dt_contab_lote_w, cd_conta_rec_pls_w, cd_conta_deb_pls_w, cd_historico_pls_w, nr_seq_trans_fin_w, cd_pessoa_fisica_w, cd_cgc_w, nm_usuario_p, dt_referencia_pls_mens_w, ie_compl_hist_w, ds_conteudo_w, cd_tipo_lote_contabil_w, nr_seq_baixa_w, nr_seq_liq_cc_w, nr_sequencia_w);
                                else
                                        if (cd_conta_deb_pls_w IS NOT NULL AND cd_conta_deb_pls_w::text <> '') and (cd_historico_pls_w IS NOT NULL AND cd_historico_pls_w::text <> '')  then
                                                nr_sequencia_w  := nr_sequencia_w + 1;

                                                begin
                                                insert into w_movimento_contabil(
                                                        nr_lote_contabil,
                                                        nr_sequencia,
                                                        cd_conta_contabil,
                                                        ie_debito_credito,
                                                        cd_historico,
                                                        dt_movimento,
                                                        vl_movimento,
                                                        ds_doc_agrupamento,
                                                        nr_seq_agrupamento,
                                                        cd_centro_custo,
                                                        ds_compl_historico,
                                                        nr_seq_trans_fin,
                                                        nr_documento,
                                                        cd_pessoa_fisica,
                                                        cd_cgc,
                                                        ie_transitorio,
                                                        nm_tabela,
                                                        nm_atributo,
                                                        nr_seq_info,
                                                        nr_seq_tab_orig,
                                                        nr_seq_tab_compl,
                                                        ie_origem_documento,
                                                        ie_intercompany,
                                                        cd_estab_intercompany,
                                                        nr_seq_proj_rec)
                                                values (
                                                        nr_lote_contabil_p,
                                                        nr_sequencia_w,
                                                        cd_conta_deb_pls_w,
                                                        'C',
                                                        cd_historico_pls_w,
                                                        dt_contabil_w,
                                                        vl_transacao_w,
                                                        nr_seq_agrupamento_w,
                                                        nr_seq_agrupamento_w,
                                                        null,
                                                        ds_compl_historico_w,
                                                        nr_seq_trans_fin_w,
                                                        nr_documento_ww,
                                                        cd_pessoa_fisica_w,
                                                        cd_cgc_w,
                                                        'N',
                                                        nm_tabela_w,
                                                        nm_atributo_w,
                                                        nr_seq_info_ctb_w,
                                                        nr_seq_tab_orig_w,
                                                        nr_seq_tab_compl_w,
                                                        ie_origem_documento_w,
                                                        ie_intercompany_w,
                                                        cd_estab_intercompany_w,
                                                        nr_seq_proj_rec_w);
                                                exception
                                                when others then
                                                        ds_erro_w       := sqlerrm(SQLSTATE);

                                                        ds_macro_w      := substr(      'cd_conta_deb_pls_w='   || cd_conta_deb_pls_w   || ';' ||
                                                                                        'nr_titulo_w='          || nr_titulo_w          || ';' ||
                                                                                        'nr_sequencia_w='       || nr_sequencia_w       || ';' ||
                                                                                        'nr_seq_trans_fin_w='   || nr_seq_trans_fin_w   || ';' ||
                                                                                        'vl_transacao='         || vl_transacao_w       || ';' ||
                                                                                        'ds_erro_w='            || ds_erro_w,1,1000);

                                                        CALL wheb_mensagem_pck.exibir_mensagem_abort(182537,ds_macro_w);
                                                end;
                                        end if;
                                end if;
                        elsif (nm_atributo_w = 'VL_REC_PLS_MENS') then
                                if      ((cd_conta_deb_pls_w IS NOT NULL AND cd_conta_deb_pls_w::text <> '') or (cd_conta_rec_pls_w IS NOT NULL AND cd_conta_rec_pls_w::text <> '')) and (cd_historico_pls_w IS NOT NULL AND cd_historico_pls_w::text <> '') then
                                        if (ie_compl_hist_w = 'S') then
                                                select  substr(obter_compl_historico(cd_tipo_lote_contabil_w, cd_historico_pls_w, ds_conteudo_w),1,255)
                                                into STRICT    ds_compl_historico_w
;
                                        end if;

                                        if      ((coalesce(dt_referencia_pls_mens_w::text, '') = '') or
                                                ((dt_referencia_pls_mens_w IS NOT NULL AND dt_referencia_pls_mens_w::text <> '') and (trunc(dt_contab_lote_w, 'month') = trunc(dt_referencia_pls_mens_w, 'month')))) then
                                                nr_sequencia_w  := nr_sequencia_w + 1;
                                                begin
                                                insert into w_movimento_contabil(
                                                        nr_lote_contabil,
                                                        nr_sequencia,
                                                        cd_conta_contabil,
                                                        ie_debito_credito,
                                                        cd_historico,
                                                        dt_movimento,
                                                        vl_movimento,
                                                        ds_doc_agrupamento,
                                                        nr_seq_agrupamento,
                                                        cd_centro_custo,
                                                        ds_compl_historico,
                                                        nr_seq_trans_fin,
                                                        nr_documento,
                                                        cd_pessoa_fisica,
                                                        cd_cgc,
                                                        ie_transitorio,
                                                        nm_tabela,
                                                        nm_atributo,
                                                        nr_seq_info,
                                                        nr_seq_tab_orig,
                                                        nr_seq_tab_compl,
                                                        ie_origem_documento,
                                                        ie_intercompany,
                                                        cd_estab_intercompany)
                                                values (
                                                        nr_lote_contabil_p,
                                                        nr_sequencia_w,
                                                        coalesce(cd_conta_deb_pls_w,cd_conta_rec_pls_w),
                                                        CASE WHEN coalesce(cd_conta_deb_pls_w::text, '') = '' THEN 'C'  ELSE 'D' END ,
                                                        cd_historico_pls_w,
                                                        coalesce(dt_referencia_pls_mens_w,dt_contab_lote_w),
                                                        vl_transacao_w,
                                                        nr_seq_agrupamento_w,
                                                        nr_seq_agrupamento_w,
                                                        null,
                                                        ds_compl_historico_w,
                                                        nr_seq_trans_fin_w,
                                                        nr_documento_ww,
                                                        cd_pessoa_fisica_w,
                                                        cd_cgc_w,
                                                        'N',
                                                        nm_tabela_w,
                                                        nm_atributo_w,
                                                        nr_seq_info_ctb_w,
                                                        nr_seq_tab_orig_w,
                                                        nr_seq_tab_compl_w,
                                                        ie_origem_documento_w,
                                                        ie_intercompany_w,
                                                        cd_estab_intercompany_w);
                                                exception
                                                when others then
                                                        ds_erro_w       := sqlerrm(SQLSTATE);

                                                        ds_macro_w      := substr(      'cd_conta_deb_pls_w='   || coalesce(cd_conta_deb_pls_w,cd_conta_rec_pls_w)   || ';' ||
                                                                                        'nr_titulo_w='          || nr_titulo_w          || ';' ||
                                                                                        'nr_sequencia_w='       || nr_sequencia_w       || ';' ||
                                                                                        'nr_seq_trans_fin_w='   || nr_seq_trans_fin_w   || ';' ||
                                                                                        'vl_transacao='         || vl_transacao_w       || ';' ||
                                                                                        'ds_erro_w='            || ds_erro_w,1,1000);

                                                        CALL wheb_mensagem_pck.exibir_mensagem_abort(182537,ds_macro_w);
                                                end;
                                        else
                                                update  pls_titulo_rec_liq_mens
                                                set     nr_lote_contabil        = 0
                                                where   nr_sequencia            = nr_seq_liq_cc_w
                                                and     nr_titulo               = nr_titulo_w
                                                and     nr_seq_baixa            = nr_seq_baixa_w;
                                        end if;
                                end if;
                        else
                                if (cd_estab_movto_w = 0) then
                                        cd_estab_movto_w        := null;
                                end if;

                                if      (nr_titulo_w <> 0 AND nr_seq_baixa_w <> 0) then
                                        select  cd_tipo_recebimento
                                        into STRICT    cd_tipo_recebimento_w
                                        from    titulo_receber_liq
                                        where   nr_titulo = nr_titulo_w
                                        and     nr_sequencia = nr_seq_baixa_w;
                                end if;

                                if (cd_tributo_ww IS NOT NULL AND cd_tributo_ww::text <> '') then
                                        cd_tributo_w    := cd_tributo_ww;
                                end if;

                                nr_sequencia_w := gerar_contab_trans_financ(
                                        cd_estabelecimento_w, cd_estab_movto_w, nr_lote_contabil_p, nm_usuario_p, cd_conta_contabil_w, cd_centro_custo_w, nr_documento_w, nr_seq_agrupamento_w, dt_contabil_w, vl_transacao_w, nr_seq_trans_fin_w, nr_seq_conta_banco_w, nm_atributo_w, cd_pessoa_fisica_w, cd_cgc_w, 0, cd_convenio_w, nr_documento_ww, cd_historico_movto_w, ds_conteudo_w, null, nr_seq_produto_w, null, cd_tributo_w, nr_seq_titulo_pagar_w, nr_seq_bandeira_cartao_w, cd_tributo_w, null, nr_seq_banco_od_w, null, null, cd_estab_inf_movto_w, cd_tipo_baixa_w, cd_tipo_recebimento_w, nr_sequencia_w, nm_tabela_w, nr_seq_titulo_receber_w, nr_seq_proj_rec_w, ie_origem_documento_w, nr_seq_tab_orig_w, nr_seq_tab_compl_w, nr_seq_info_ctb_w, cd_moeda_w);
                        end if;
                end if;

                /*Gerar lancamentos em conta transitoria para titulos pagos por estabelecimento diferente do pagador */

                select  count(*)
                into STRICT    qt_regra_estab_origem_w
                from    ctb_regra_estab_dif
                where   cd_tipo_lote_contabil   = cd_tipo_lote_contabil_w
                and     cd_estabelecimento      = cd_estabelecimento_w
                and     (cd_estab_origem IS NOT NULL AND cd_estab_origem::text <> '');

                if (ie_permite_estab_dif_w = 'PCCT') and (nm_atributo_w = 'VL_TRANSACAO') and (ie_debito_credito_w <> 'T') and (qt_regra_estab_origem_w > 0) and
                        ((coalesce(cd_estab_banco_od_w, cd_estabelecimento_w) <> cd_estabelecimento_w) or
                        ((coalesce(cd_estab_movto_w,cd_estabelecimento_w) <> cd_estabelecimento_w) and (ie_contab_transit_tf_w = 'S'))) then
                        SELECT * FROM ctb_obter_regra_estab_dif(cd_estabelecimento_w, cd_tipo_lote_contabil_w, cd_estab_banco_od_w, ie_permite_estab_dif_w, cd_conta_transitoria_w, cd_historico_ct_w) INTO STRICT ie_permite_estab_dif_w, cd_conta_transitoria_w, cd_historico_ct_w;
                        if (cd_conta_transitoria_w IS NOT NULL AND cd_conta_transitoria_w::text <> '') then

                                if (ie_debito_credito_w = 'D') then
                                        ie_debito_credito_ww    := 'C';
                                elsif (ie_debito_credito_w = 'C') then
                                        ie_debito_credito_ww    := 'D';
                                end if;


                                        nr_lote_contabil_p := ctb_gerar_movto_conta_transit(
                                        nr_lote_contabil_p, cd_estabelecimento_w, cd_conta_transitoria_w, cd_historico_ct_w);

                                if (ie_contab_transit_tf_w = 'S') then

                                                nr_lote_contabil_p := ctb_gerar_movto_conta_transit(
                                                nr_lote_contabil_p, coalesce(coalesce(cd_estab_movto_w,cd_estabelecimento_w),cd_estabelecimento_w), cd_conta_transitoria_w, cd_historico_ct_w);
                                end if;
                        end if;
                end if;

                if (nm_atributo_w in ('VL_DESCONTOS','VL_DESPESA_BANCARIA','VL_GLOSA','VL_JUROS','VL_MULTA','VL_RECEBIDO_CB','VL_REC_MAIOR','VL_REC_PLS')) then
                        ie_contab_transit_w     := ie_contab_transit_cr_w;
                end if;
                /*              Gerar lancamentos em conta transitoria para titulos pagos por estabelecimento diferente do pagador */

                if (ie_contab_cp_no_cb_w = 'S') and (ie_contab_transit_w = 'S') and (ie_permite_estab_dif_w = 'PCCT') and (coalesce(cd_estab_movto_w,0) <> 0) and (nm_atributo_w <> 'VL_TRANSACAO') and (nm_atributo_w <> 'VL_IMPOSTO_BAIXA') and (nm_atributo_w <> 'VL_PROV_TRIBUTO') and (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') and (cd_conta_transitoria_w IS NOT NULL AND cd_conta_transitoria_w::text <> '') and (cd_estab_movto_w <> cd_estabelecimento_w) then

                        vl_transacao_orig_w     := vl_transacao_w;

                        if (nm_atributo_w = 'VL_BAIXA') and (nm_tabela_w = 'TITULO_PAGAR_BAIXA_CONTAB_V') then
                                begin
                                if (nm_tabela_w = 'TITULO_PAGAR_BAIXA_CONTAB_V') and (coalesce(nr_seq_liq_cc_w,0) <> 0) then
                                        select  coalesce(c.vl_pago,0)
                                        into STRICT    vl_titulo_banco_w
                                        from    titulo_pagar_baixa_cc c,
                                                titulo_pagar_baixa b,
                                                titulo_pagar a
                                        where   a.nr_titulo     = c.nr_titulo
                                        and     a.nr_titulo     = b.nr_titulo
                                        and     a.nr_titulo     = nr_titulo_w
                                        and     b.nr_sequencia  = nr_seq_baixa_cr_w
                                        and     (nr_seq_conta_banco IS NOT NULL AND nr_seq_conta_banco::text <> '')
                                        and     c.nr_sequencia  = nr_seq_liq_cc_w;
                                else
                                        select  coalesce(max(b.vl_pago),0)
                                        into STRICT    vl_titulo_banco_w
                                        from    titulo_pagar_baixa b,
                                                titulo_pagar a
                                        where   a.nr_titulo     = b.nr_titulo
                                        and     a.nr_titulo     = nr_titulo_w
                                        and     b.nr_sequencia  = nr_seq_baixa_cr_w
                                        and     (nr_seq_conta_banco IS NOT NULL AND nr_seq_conta_banco::text <> '')
                                        and     not exists (
                                                        SELECT  1
                                                        from    titulo_pagar_baixa_cc x
                                                        where   b.nr_titulo     = x.nr_titulo
                                                        and     b.nr_sequencia  = x.nr_seq_baixa
                                                         LIMIT 1);
                                end if;
                                exception when others then
                                        vl_titulo_banco_w       := vl_transacao_w;
                                end;

                                if (vl_titulo_banco_w <> vl_transacao_w) then
                                        vl_transacao_w  := vl_titulo_banco_w;
                                end if;
                        end if;

                        ie_gera_ctb_transit_w := 'S';
                        if (nm_atributo_w in ('VL_DESCONTOS','VL_JUROS','VL_MULTA')) and (nm_tabela_w = 'TITULO_PAGAR_BAIXA_CONTAB_V') then
                                select  CASE WHEN coalesce(sum(c.vl_pago),0)=0 THEN 'N'  ELSE 'S' END
                                into STRICT    ie_gera_ctb_transit_w
                                from    titulo_pagar_baixa_cc c,
                                        titulo_pagar_baixa b,
                                        titulo_pagar a
                                where   a.nr_titulo     = c.nr_titulo
                                and     a.nr_titulo     = b.nr_titulo
                                and     a.nr_titulo     = nr_titulo_w
                                and     b.nr_sequencia  = nr_seq_baixa_cr_w
                                and     (nr_seq_conta_banco IS NOT NULL AND nr_seq_conta_banco::text <> '')
                                and     c.nr_sequencia  = nr_seq_liq_cc_w;
                                /*Valor de multa e juros ja esta no VL_TRANSACAO */

                                if (nm_atributo_w in ('VL_MULTA','VL_JUROS')) then
                                        ie_gera_ctb_transit_w   := 'N';
                                end if;
                        end if;
                        ie_gera_ctb_transit_w := coalesce(ie_gera_ctb_transit_w,'S');

                        if (ie_gera_ctb_transit_w = 'S') then

                                        nr_lote_contabil_p := ctb_gerar_movto_conta_transit(
                                        nr_lote_contabil_p, cd_estabelecimento_w, cd_conta_transitoria_w, cd_historico_ct_w);


                                        nr_lote_contabil_p := ctb_gerar_movto_conta_transit(
                                        nr_lote_contabil_p, cd_estab_movto_w, cd_conta_transitoria_w, cd_historico_ct_w);
                        end if;

                        vl_transacao_w  := vl_transacao_orig_w;

                end if;

                if (qt_contador_w >= 100) then
                        commit;
                        qt_contador_w   := 0;
                end if;
                ie_intercompany_w := 'N';
        end loop;
        close c010;

        if (pkg_i18n.get_user_locale = 'es_BO' AND ie_exclusao_p = 'N') then
                BEGIN
                        CALL ctb_regras_contabil.ctb_gerar_cd_controle_banco(nr_lote_contabil_p, nm_usuario_p);
                EXCEPTION WHEN OTHERS THEN
                        CALL ctb_gravar_log_lote(nr_lote_contabil_p, 1, SQLERRM, nm_usuario_p);
                END;
        end if;

        CALL agrupa_movimento_contabil(nr_lote_contabil_p, nm_usuario_p);
end if;

if (coalesce(ds_retorno_p::text, '') = '') then
        update  lote_contabil
        set     ie_situacao = 'A',
                dt_geracao_lote = clock_timestamp()
        where   nr_lote_contabil = nr_lote_contabil_p;
        if (ie_exclusao_p = 'S') then

                ds_retorno_p            := wheb_mensagem_pck.get_texto(165188);
                CALL ctb_gravar_log_lote( nr_lote_contabil_p, 2, '', nm_usuario_p);
        else
                ds_retorno_p            := wheb_mensagem_pck.get_texto(165187);
                CALL ctb_gravar_log_lote( nr_lote_contabil_p, 1, '', nm_usuario_p);
        end if;
        commit;
else
        rollback;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE contabiliza_controle_bancario (nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text) FROM PUBLIC;

