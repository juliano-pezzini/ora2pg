-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_monit_gerar_novo_arquivo (( nr_seq_arquivo_p pls_monitor_tiss_arquivo.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) is nm_arquivo_ref_w pls_monitor_tiss_arquivo.nm_arquivo%type) RETURNS varchar AS $body$
DECLARE


cd_ans_w		pls_monitor_tiss_lote.cd_ans%type;
dt_competencia_w	varchar(6);
qt_zero_w		varchar(6);
ds_retorno_w		pls_monitor_tiss_arquivo.nm_arquivo%type;
ds_seq_arquivo_w	varchar(15);
ds_seq_arq_formatado_w	varchar(4);

BEGIN

if (nr_seq_arquivo_p IS NOT NULL AND nr_seq_arquivo_p::text <> '') then

	select	cd_ans,
		replace(to_char(dt_mes_competencia, 'yyyy/mm'), '/','') mes_ano
	into STRICT	cd_ans_w,
		dt_competencia_w
	from	pls_monitor_tiss_lote
	where	nr_sequencia = nr_seq_lote_p;

	ds_seq_arquivo_w := nr_seq_arquivo_p;
	
	if ( length(ds_seq_arquivo_w) >= 4) then
	
		ds_seq_arq_formatado_w := substr(ds_seq_arquivo_w, length(ds_seq_arquivo_w) - 3, length(ds_seq_arquivo_w));
	else
		ds_seq_arq_formatado_w := ds_seq_arquivo_w;
	end if;
	
	for	i in  1 .. (4 - length(ds_seq_arq_formatado_w)) loop
		qt_zero_w := qt_zero_w||'0';
	end loop;


	ds_retorno_w := cd_ans_w||dt_competencia_w||qt_zero_w||ds_seq_arq_formatado_w||'.XTE';
end if;

return ds_retorno_w;

end;

begin

	select	max(nm_arquivo),
		max(nr_seq_lote_monitor),
		max(nr_arquivo)
	into STRICT	nm_arquivo_ref_w,
		nr_seq_lote_w,
		nr_arquivo_w
	from	pls_monitor_tiss_arquivo
	where 	nr_sequencia = nr_seq_arquivo_p;

	--verifica se tem um retorno importado para o lote que o arquivo origem pertence. Caso exista, deve ser emitida msg com abort
	select	max(nr_sequencia)
	into STRICT	nr_seq_retorno_w
	from	pls_monitor_tiss_lote_com
	where	nr_seq_lote_monitor = nr_seq_lote_w;
	
	--se ja tem retorno importado para esse lote, nao permite gerar segundo arquivo(qualquer que seja o arquivo do lote)
	if (nr_seq_retorno_w IS NOT NULL AND nr_seq_retorno_w::text <> '') then
	
		--expressao 973887 nao e possivel gerar o arquivo. Ja ocorreu importacao do retorno...
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1122080);
	
	end if;
	
	select 	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
	into STRICT	arq_ja_gerado_w
	from	pls_monitor_tiss_arquivo
	where 	nr_seq_lote_monitor = nr_seq_lote_w
	and 	ds_nome_anterior =  nm_arquivo_ref_w;
	
	if ( arq_ja_gerado_w = 'S') then
	
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1122295);
	
	end if;
	
	--gera registro nodo na tabela de arquivo e referencia o antigo
	select 	nextval('pls_monitor_tiss_arquivo_seq')
	into STRICT 	nr_seq_novo_arq_w 
	;
	
	nm_arq_novo_w := obter_nome_arquivo(nr_seq_lote_w, nr_seq_novo_arq_w);
	
	insert into pls_monitor_tiss_arquivo(	cd_protocolo_ans, ds_conteudo, ds_erro,
						ds_nome_anterior, dt_atualizacao, dt_atualizacao_nrec,
						dt_geracao_arquivo, ie_status, nm_arquivo,
						nm_usuario, nm_usuario_nrec, nr_arquivo,
						nr_seq_lote_monitor, nr_sequencia)
	values ( null, null, null,
		nm_arquivo_ref_w, clock_timestamp(), clock_timestamp(),
		clock_timestamp(), 'S', nm_arq_novo_w,
		nm_usuario_p, nm_usuario_p, nr_arquivo_w,
		nr_seq_lote_w, nr_seq_novo_arq_w);
		
	--atualiza as referencias ao novo arquivo.
	update 	pls_monitor_tiss_guia
	set	nr_seq_arq_monitor = nr_seq_novo_arq_w
	where 	nr_seq_arq_monitor = nr_seq_arquivo_p;

	update 	pls_monit_tiss_pre_est
	set	nr_seq_arq_monitor = nr_seq_novo_arq_w
	where 	nr_seq_arq_monitor = nr_seq_arquivo_p;

	commit;
	
	--arquivo xml gerado com sucesso
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1023339);
	
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_monit_gerar_novo_arquivo (( nr_seq_arquivo_p pls_monitor_tiss_arquivo.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) is nm_arquivo_ref_w pls_monitor_tiss_arquivo.nm_arquivo%type) FROM PUBLIC;

