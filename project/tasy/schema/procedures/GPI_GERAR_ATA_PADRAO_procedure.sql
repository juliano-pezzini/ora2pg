-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gpi_gerar_ata_padrao ( nr_seq_ata_p bigint, nm_usuario_p text) AS $body$
DECLARE

		 
nr_seq_proj_gpi_w		bigint;
dt_inicio_prev_w		varchar(20);
dt_fim_prev_w		varchar(20);
cd_pf_gestor_w		varchar(10);
nm_pf_gestor_w		varchar(255);
nm_projeto_w		varchar(255);
ds_objetivo_w		varchar(255);

vl_orcado_w		double precision;
vl_realizado_w		double precision;

ds_orcado_w		varchar(30);
ds_realizado_w		varchar(30);

nr_sequencia_w		bigint;
ds_titulo_w		varchar(80);
ds_conteudo_w		varchar(4000);

/* 
'@dt_inicio_proj		data de inicio do projeto 
'@dt_fim_proj		data fim do projeto 
'@ds_desc_proj		descrição do projeto 
'@nm_gestor_proj		gestor do projeto	 
 
'@ds_obj_cronograma		objetivo do cronograma 
'@vl_orcado_prev		orçamento previsto 
'@vl_orcado_real		orçamento realizado 
*/
 
 
c01 CURSOR FOR 
SELECT	nr_sequencia, 
	ds_titulo, 
	ds_conteudo 
from	proj_ata_conteudo_padrao 
where	ie_situacao = 'A' 
order by nr_sequencia;


BEGIN 
open c01;
loop 
fetch c01 into	 
	nr_sequencia_w, 
	ds_titulo_w, 
	ds_conteudo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
end loop;
close c01;
 
if (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') and (nr_sequencia_w > 0) then 
	begin 
	select	max(nr_seq_proj_gpi) 
	into STRICT	nr_seq_proj_gpi_w 
	from	proj_ata 
	where	nr_sequencia = nr_seq_ata_p;
 
	begin 
	select	to_char(dt_inicio_prev,'dd/mm/yyyy'), 
		to_char(dt_fim_prev,'dd/mm/yyyy'), 
		cd_pf_gestor, 
		nm_projeto 
	into STRICT	dt_inicio_prev_w, 
		dt_fim_prev_w, 
		cd_pf_gestor_w, 
		nm_projeto_w 
	from	gpi_projeto 
	where	nr_sequencia = nr_seq_proj_gpi_w;
	 
	nm_pf_gestor_w	:= substr(obter_nome_pf(cd_pf_gestor_w),1,255);
	exception 
	when others then 
		null;
	end;
 
	select	max(ds_objetivo) 
	into STRICT	ds_objetivo_w 
	from	gpi_cronograma 
	where	nr_seq_projeto = nr_seq_proj_gpi_w;
 
	select	coalesce(sum(vl_orcado),0), 
		coalesce(sum(vl_realizado),0) 
	into STRICT	vl_orcado_w, 
		vl_realizado_w 
	from	gpi_orcamento a, 
		gpi_orc_item b 
	where	b.nr_seq_orcamento = a.nr_sequencia 
	and	a.nr_seq_projeto = nr_seq_proj_gpi_w 
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '');
	 
	ds_orcado_w	:= campo_mascara_virgula(vl_orcado_w);
	ds_realizado_w	:= campo_mascara_virgula(vl_realizado_w);
		 
	ds_conteudo_w	:= substr(replace_macro( ds_conteudo_w, '@DT_INICIO_PROJ', dt_inicio_prev_w ),1,4000);
	ds_conteudo_w	:= substr(replace_macro( ds_conteudo_w, '@DT_FIM_PROJ', dt_fim_prev_w ),1,4000);
	ds_conteudo_w	:= substr(replace_macro( ds_conteudo_w, '@DS_DESC_PROJ', nm_projeto_w ),1,4000);
	ds_conteudo_w	:= substr(replace_macro( ds_conteudo_w, '@NM_GESTOR_PROJ', dt_inicio_prev_w ),1,4000);
	ds_conteudo_w	:= substr(replace_macro( ds_conteudo_w, '@DS_OBJ_CRONOGRAMA', ds_objetivo_w ),1,4000);
	ds_conteudo_w	:= substr(replace_macro( ds_conteudo_w, '@VL_ORCADO_PREV', ds_orcado_w ),1,4000);
	ds_conteudo_w	:= substr(replace_macro( ds_conteudo_w, '@VL_ORCADO_REAL', ds_realizado_w ),1,4000);
	 
	insert into proj_ata_conteudo( 
		nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_seq_ata, 
		ds_conteudo, 
		ds_titulo, 
		nr_seq_apresentacao, 
		nr_seq_pauta) 
	values (	nextval('proj_ata_conteudo_seq'), 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_seq_ata_p, 
		ds_conteudo_w, 
		ds_titulo_w, 
		10, 
		null);
	 
	commit;
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gpi_gerar_ata_padrao ( nr_seq_ata_p bigint, nm_usuario_p text) FROM PUBLIC;

