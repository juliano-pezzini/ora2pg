-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_comunic_cobr_orgao ( nr_seq_orgao_p bigint, qt_dia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
dt_retirada_prev_w	timestamp;
nm_paciente_w		varchar(255);
nr_sequencia_w		bigint;
ds_mensagem_w		varchar(4000);
nm_usuario_w		varchar(15);

c01 CURSOR FOR 
SELECT 	a.nr_sequencia, 
	substr(obter_dados_cobranca(a.nr_sequencia, '2'),1,255), 
	obter_dt_prev_retirada_cobr(b.nr_sequencia), 
	a.nm_usuario 
from	cobranca a, 
	cobranca_orgao b 
where	b.nr_seq_orgao	= nr_seq_orgao_p 
and	b.nr_seq_cobranca	= a.nr_sequencia 
and	trunc(obter_dt_prev_retirada_cobr(b.nr_sequencia), 'dd') = (trunc(clock_timestamp(), 'dd') + qt_dia_p) 
and	a.ie_status	= 'P';

BEGIN
Open C01;
LOOP 
	FETCH c01 into 
		nr_sequencia_w, 
		nm_paciente_w, 
		dt_retirada_prev_w, 
		nm_usuario_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		ds_mensagem_w	:= wheb_mensagem_pck.get_texto(305796) || 
				nr_sequencia_w || wheb_mensagem_pck.get_texto(305797) || to_char(dt_retirada_prev_w,'dd/mm/yyyy') || '.';
 
		CALL gerar_comunic_padrao(clock_timestamp(), 
					wheb_mensagem_pck.get_texto(305818), 
					ds_mensagem_w, 
					'Tasy', 
					'N', 
					nm_usuario_w, 
					'N', 
					null, 
					null, 
					cd_estabelecimento_p, 
					null, 
					clock_timestamp(), 
					null, 
					null);
		end;
END LOOP;
CLOSE C01;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_comunic_cobr_orgao ( nr_seq_orgao_p bigint, qt_dia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

