-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE schematic4test_copyfile (NR_SEQ_SCHEDULE_P bigint, IE_TIPO_ANEXO_P text, DS_ARQUIVO_P text, DS_OBSERVACAO_P text) AS $body$
DECLARE

QTD_W bigint;
QTD_W2 bigint;
QTD_W3 bigint;
NR_SEQ_SCRIPT_W bigint;
NR_SEQ_SCRIPT_W2 bigint;
NR_SEQ_TEST_W bigint;


BEGIN
  --procedure that inset address of files
  IF (NR_SEQ_SCHEDULE_P IS NOT NULL AND NR_SEQ_SCHEDULE_P::text <> '') AND (DS_ARQUIVO_P IS NOT NULL AND DS_ARQUIVO_P::text <> '')  AND (IE_TIPO_ANEXO_P IS NOT NULL AND IE_TIPO_ANEXO_P::text <> '') THEN
      SELECT COUNT(NR_SEQUENCIA) QTD
          INTO STRICT QTD_W
      FROM SCHEM_TEST_SCHEDULE
      WHERE NR_SEQUENCIA = NR_SEQ_SCHEDULE_P;

      IF (QTD_W <> 0) THEN
        INSERT INTO SCHEM_TEST_SCHEDULE_ATTACH(nr_sequencia, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_schedule, ie_tipo_anexo, ds_arquivo, ds_observacao) 
              VALUES (nextval('schem_test_schedule_attach_seq'), clock_timestamp(), 'Auto Robot', clock_timestamp(), 'Auto Robot', NR_SEQ_SCHEDULE_P, IE_TIPO_ANEXO_P, DS_ARQUIVO_P, DS_OBSERVACAO_P);
        COMMIT;
      
        IF (IE_TIPO_ANEXO_P = 'png') THEN
          NR_SEQ_SCRIPT_W := (regexp_replace(trim(both substr(substr(DS_OBSERVACAO_P, position('- Id' in DS_OBSERVACAO_P), length(DS_OBSERVACAO_P)- length(substr(DS_OBSERVACAO_P,position('- Step' in DS_OBSERVACAO_P)))),0,position('- Step' in substr(DS_OBSERVACAO_P, position('- Id' in DS_OBSERVACAO_P), length(DS_OBSERVACAO_P)- length(substr(DS_OBSERVACAO_P,position('- Step' in DS_OBSERVACAO_P))))))), '[^0-9]', ''))::numeric;

          SELECT COUNT(NR_SEQUENCIA) QTD
             INTO STRICT QTD_W2
          FROM SCHEM_TEST_SCRIPT 
          WHERE NR_SEQUENCIA = NR_SEQ_SCRIPT_W;

          IF (QTD_W2 <> 0) THEN             
              UPDATE SCHEM_TEST_SCHEDULE_ATTACH SET NR_SEQ_SCRIPT = NR_SEQ_SCRIPT_W WHERE NR_SEQ_SCHEDULE = NR_SEQ_SCHEDULE_P AND coalesce(NR_SEQ_SCRIPT::text, '') = '' AND IE_TIPO_ANEXO_P = 'png';
              COMMIT;
          END IF;
        ELSE
          IF (IE_TIPO_ANEXO_P = 'html') THEN
            NR_SEQ_TEST_W := (regexp_replace(trim(both substr(DS_OBSERVACAO_P, position('- Id - ' in DS_OBSERVACAO_P), length(DS_OBSERVACAO_P))), '[^0-9]', ''))::numeric;

            SELECT COUNT(NR_SEQUENCIA) QTD
              INTO STRICT QTD_W3
            FROM SCHEM_TEST_SCRIPT WHERE NR_SEQUENCIA = NR_SEQ_TEST_W;

            IF (QTD_W3 <> 0) THEN           
              SELECT NR_SEQUENCIA
                  INTO STRICT NR_SEQ_SCRIPT_W2
              FROM SCHEM_TEST_SCRIPT WHERE NR_SEQUENCIA = NR_SEQ_TEST_W;

              UPDATE SCHEM_TEST_SCHEDULE_ATTACH SET NR_SEQ_SCRIPT = NR_SEQ_SCRIPT_W2 WHERE NR_SEQ_SCHEDULE = NR_SEQ_SCHEDULE_P AND coalesce(NR_SEQ_SCRIPT::text, '') = '' AND IE_TIPO_ANEXO_P = 'html';
              COMMIT;
            END IF;
          END IF;
        END IF;
    END IF;
  END IF;
  EXCEPTION
  WHEN no_data_found THEN
    RAISE NOTICE 'Erro: Data not found';
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE schematic4test_copyfile (NR_SEQ_SCHEDULE_P bigint, IE_TIPO_ANEXO_P text, DS_ARQUIVO_P text, DS_OBSERVACAO_P text) FROM PUBLIC;

