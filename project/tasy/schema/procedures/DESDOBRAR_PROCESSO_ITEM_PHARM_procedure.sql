-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desdobrar_processo_item_pharm ( nr_atendimento_p prescr_medica.nr_atendimento%type, dt_horario_p prescr_mat_hor.dt_horario%type, nr_prescricao_p prescr_mat_hor.nr_prescricao%type, nr_seq_area_prep_p prescr_mat_hor.nr_seq_area_prep%type ) AS $body$
DECLARE


nr_tipo_item_w              smallint;
ds_seq_hor_desdobrar_w      varchar(1000);
nr_seq_processo_w           prescr_mat_hor.nr_seq_processo%type;
nr_seq_processo_ww          prescr_mat_hor.nr_seq_processo%type;
ie_processo_separado_w      adep_area_prep.ie_processo_separado%type;

c01 CURSOR FOR
SELECT  a.nr_seq_processo,
        a.nr_seq_area_prep,
        b.nm_usuario
from    prescr_mat_hor a,
        prescr_medica b
where   a.nr_prescricao = b.nr_prescricao
and     b.nr_atendimento = nr_atendimento_p
and     a.dt_horario = dt_horario_p
and     ((a.nr_prescricao = nr_prescricao_p) or (coalesce(nr_prescricao_p::text, '') = ''))
and     ((a.nr_seq_area_prep = nr_seq_area_prep_p) or (coalesce(nr_seq_area_prep_p::text, '') = ''))
and     a.ie_tipo_item_processo = 'MAP';

c02 CURSOR FOR
SELECT  a.nr_sequencia nr_seq_horario
from    prescr_mat_hor a
where   a.nr_seq_processo = nr_seq_processo_w
and     a.ie_tipo_item_processo = 'MAP';
BEGIN

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '' AND dt_horario_p IS NOT NULL AND dt_horario_p::text <> '') then
    for c01_w in c01 loop
        select coalesce(max(a.ie_processo_separado),'N')
        into STRICT 	ie_processo_separado_w
        from 	adep_area_prep a
        where	a.nr_sequencia = coalesce(nr_seq_area_prep_p, c01_w.nr_seq_area_prep);

        if (ie_processo_separado_w = 'N') then        
            select count(1)
            into STRICT nr_tipo_item_w
            from (  SELECT distinct a.ie_tipo_item_processo
                    from    prescr_mat_hor a,
                            prescr_medica b
                    where   a.nr_prescricao = b.nr_prescricao
                    and     a.nr_seq_processo = c01_w.nr_seq_processo
                    and     a.ie_tipo_item_processo in ('MAP', 'IVC')) z;

            if (nr_tipo_item_w = 2) then
                nr_seq_processo_w := c01_w.nr_seq_processo;
                for c02_w in c02 loop
                    if (coalesce(ds_seq_hor_desdobrar_w::text, '') = '') then
                        ds_seq_hor_desdobrar_w := c02_w.nr_seq_horario;
                    else
                        ds_seq_hor_desdobrar_w := ds_seq_hor_desdobrar_w || ',' || c02_w.nr_seq_horario;
                    end if;
                end loop;
                nr_processo_desdobrado_p => nr_seq_processo_ww := adep_desdobrar_processo(nr_processo_p => c01_w.nr_seq_processo, nr_etiquetas_desdobrar_p => ds_seq_hor_desdobrar_w, nr_seq_area_prep_p => c01_w.nr_seq_area_prep, nm_usuario_p => coalesce(wheb_usuario_pck.get_nm_usuario, c01_w.nm_usuario), nr_processo_desdobrado_p => nr_seq_processo_ww);
            end if;
        end if;
    end loop;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desdobrar_processo_item_pharm ( nr_atendimento_p prescr_medica.nr_atendimento%type, dt_horario_p prescr_mat_hor.dt_horario%type, nr_prescricao_p prescr_mat_hor.nr_prescricao%type, nr_seq_area_prep_p prescr_mat_hor.nr_seq_area_prep%type ) FROM PUBLIC;

