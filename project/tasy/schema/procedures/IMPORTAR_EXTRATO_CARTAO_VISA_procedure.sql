-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE importar_extrato_cartao_visa (nr_seq_extrato_p bigint, nm_usuario_p text) AS $body$
DECLARE

dt_processamento_w	timestamp;
dt_inicial_w		timestamp;
dt_final_w		timestamp;
nr_extrato_w		integer;
nr_resumo_w		varchar(20);
cd_banco_w		smallint;
cd_agencia_w		varchar(8);
cd_conta_w		varchar(15);
nr_seq_conta_banco_w	bigint;
qt_cv_aceito_w		bigint;
qt_cv_rejeitado_w	bigint;
vl_bruto_w		double precision;
vl_comissao_w		double precision;
vl_rejeitado_w		double precision;
vl_liquido_w		double precision;
cd_estabelecimento_w	smallint;
vl_parcela_w		double precision;
dt_compra_w		timestamp;
qt_parcelas_w		bigint;
nr_cartao_w		varchar(20);
nr_autorizacao_w	varchar(40);
ds_comprovante_w	varchar(100);
ds_rejeicao_w		varchar(255);
nr_parcela_w		bigint;
nr_seq_extrato_res_w	bigint;
ie_tipo_registro_w	varchar(2);
nr_sequencia_w		bigint;
dt_min_parcela_w	timestamp;
dt_max_parcela_w	timestamp;
nr_seq_bandeira_w	bigint;
ie_status_w		varchar(2);
ie_debito_w		varchar(1);
ie_resumo_debito_w	varchar(1);

/* Cursor Resumos */

c01 CURSOR FOR
SELECT	nr_sequencia,
	substr(ds_conteudo,1,1) ie_tipo_registro,
	substr(ds_conteudo,37,2) ie_status,
	substr(ds_conteudo,12,7) nr_resumo,
	somente_numero(substr(ds_conteudo,113,4)) cd_banco,
	somente_numero(substr(ds_conteudo,117,5)) cd_agencia,
	somente_numero(substr(ds_conteudo,122,14)) cd_conta,
	substr(ds_conteudo,136,6) qt_cv_aceito,
	substr(ds_conteudo,143,6) qt_cv_rejeitado,
	CASE WHEN substr(ds_conteudo,57,1)='-' THEN -1  ELSE 1 END  * (substr(ds_conteudo,58,11) || ',' || substr(ds_conteudo,69,2))::numeric  vl_bruto,
	CASE WHEN substr(ds_conteudo,71,1)='-' THEN -1  ELSE 1 END  * (substr(ds_conteudo,72,11) || ',' || substr(ds_conteudo,83,2))::numeric  vl_comissao,
	CASE WHEN substr(ds_conteudo,85,1)='-' THEN -1  ELSE 1 END  * (substr(ds_conteudo,86,11) || ',' || substr(ds_conteudo,97,2))::numeric  vl_rejeitado,
	CASE WHEN substr(ds_conteudo,99,1)='-' THEN -1  ELSE 1 END  * (substr(ds_conteudo,100,11) || ',' || substr(ds_conteudo,111,2))::numeric  vl_liquido,
	(null)::numeric  vl_parcela,
	to_date(substr(ds_conteudo,45,6),'yymmdd') dt_compra,
	(null)::numeric  nr_parcela,
	(null)::numeric  qt_parcelas,
	to_char(null) nr_cartao,
	to_char(null) nr_autorizacao,
	to_char(null) ds_comprovante,
	to_char(null) ds_rejeicao,
	CASE WHEN substr(ds_conteudo,142,1)='E' THEN 'S'  ELSE 'N' END  ie_debito
from	w_extrato_cartao_cr
where	nr_seq_extrato			= nr_seq_extrato_p
and	substr(ds_conteudo,1,1) 	= '1' -- Resumo
union all

select	nr_sequencia,
	substr(ds_conteudo,1,1) ie_tipo_registro,
	to_char(null) ie_status,
	to_char(null) nr_resumo,
	(null)::numeric  cd_banco,
	(null)::numeric  cd_agencia,
	(null)::numeric  cd_conta,
	to_char(null) qt_cv_aceito,
	to_char(null) qt_cv_rejeitado,
	(null)::numeric  vl_bruto,
	(null)::numeric  vl_comissao,
	(null)::numeric  vl_rejeitado,
	(null)::numeric  vl_liquido,
	(CASE WHEN substr(ds_conteudo,46,1)='-' THEN -1  ELSE 1 END  * (substr(ds_conteudo,47,11) || ',' || substr(ds_conteudo,58,2))::numeric )::numeric  vl_parcela,
	to_date(substr(ds_conteudo,38,8),'yyyymmdd') dt_compra,
	(substr(ds_conteudo,60,2))::numeric  nr_parcela,
	somente_numero(substr(ds_conteudo,62,2)) qt_parcelas,
	substr(ds_conteudo,19,19) nr_cartao,
	substr(ds_conteudo,94,6) nr_autorizacao,
	substr(ds_conteudo,140,6) ds_comprovante,
	substr(ds_conteudo,64,30) ds_rejeicao,
	to_char(null) ie_debito
from	w_extrato_cartao_cr
where	nr_seq_extrato			= nr_seq_extrato_p
and	substr(ds_conteudo,1,1) 	= '2' --Detalhe
order by nr_sequencia;


BEGIN
select	cd_estabelecimento,
	nr_seq_bandeira
into STRICT	cd_estabelecimento_w,
	nr_seq_bandeira_w
from	extrato_cartao_cr
where	nr_sequencia	= nr_seq_extrato_p;

/* Header */

begin
select	somente_numero(substr(ds_conteudo,39,7)) nr_extrato,
	to_date(substr(ds_conteudo,12,8),'yyyymmdd') dt_processamento,
	to_date(substr(ds_conteudo,20,8),'yyyymmdd') dt_inicial,
	to_date(substr(ds_conteudo,28,8),'yyyymmdd') dt_final
into STRICT	nr_extrato_w,
	dt_processamento_w,
	dt_inicial_w,
	dt_final_w
from	w_extrato_cartao_cr
where	nr_seq_extrato	= nr_seq_extrato_p
and	substr(ds_conteudo,1,1) = '0';
exception
when no_data_found then
	/* Arquivo não importado!
	Verifique se a interface 1340 - "Interface geral de importação extrato operadora cartão (procedure)" está ativa! */
	CALL wheb_mensagem_pck.exibir_mensagem_abort(266885);
end;

open c01;
loop
fetch c01 into
	nr_sequencia_w,
	ie_tipo_registro_w,
	ie_status_w,
	nr_resumo_w,
	cd_banco_w,
	cd_agencia_w,
	cd_conta_w,
	qt_cv_aceito_w,
	qt_cv_rejeitado_w,
	vl_bruto_w,
	vl_comissao_w,
	vl_rejeitado_w,
	vl_liquido_w,
	vl_parcela_w,
	dt_compra_w,
	nr_parcela_w,
	qt_parcelas_w,
	nr_cartao_w,
	nr_autorizacao_w,
	ds_comprovante_w,
	ds_rejeicao_w,
	ie_debito_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	/* Francisco - 03/03/2008 - Só importar o que for crédito, iclui o ie_debito no if abaixo */

	if (ie_tipo_registro_w = '1') then

		ie_resumo_debito_w	:= ie_debito_w;

		/* Liquidacao */

		if (ie_status_w = '14') and (ie_debito_w = 'N') then

			/* Francisco - 14/01/08 - Estava dando problema com dígitos para buscar, resolvi buscar do cadastro da bandeira
			begin
			select	nr_sequencia
			into	nr_seq_conta_banco_w
			from	banco_estabelecimento
			where	cd_banco		= cd_banco_w
			and	cd_agencia_bancaria	= cd_agencia_w
			and	cd_conta		= cd_conta_w
			and	cd_estabelecimento	= cd_estabelecimento_w;
			exception
				when others then

			end;*/
			select	(obter_valor_bandeira_estab(nr_sequencia,cd_estabelecimento_w,'NR_SEQ_CONTA_BANCO'))::numeric
			into STRICT	nr_seq_conta_banco_w
			from	bandeira_cartao_cr
			where	nr_sequencia	= nr_seq_bandeira_w;

			if (coalesce(nr_seq_conta_banco_w::text, '') = '') then
				-- Não foi encontrada a conta bancária de referência no cadastro da bandeira do extrato!
				CALL wheb_mensagem_pck.exibir_mensagem_abort(266884);
			end if;

			select	nextval('extrato_cartao_cr_res_seq')
			into STRICT	nr_seq_extrato_res_w
			;

			insert	into	extrato_cartao_cr_res(nr_sequencia,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				dt_atualizacao,
				nm_usuario,
				nr_seq_extrato,
				nr_resumo,
				nr_seq_conta_banco,
				qt_cv_aceito,
				qt_cv_rejeitado,
				vl_bruto,
				vl_comissao,
				vl_rejeitado,
				vl_liquido,
				dt_prev_pagto)
			values (nr_seq_extrato_res_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_extrato_p,
				nr_resumo_w,
				nr_seq_conta_banco_w,
				qt_cv_aceito_w,
				qt_cv_rejeitado_w,
				vl_bruto_w,
				vl_comissao_w,
				vl_rejeitado_w,
				vl_liquido_w,
				dt_compra_w);

		/* Aluguel de POS (Equipamento) */

		elsif (ie_status_w = '12') and (ie_debito_w = 'N') then

			insert	into	extrato_cartao_cr_desp(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_extrato,
				nr_resumo,
				vl_bruto,
				vl_liquido,
				dt_prev_pagto)
			values (nextval('extrato_cartao_cr_desp_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_extrato_p,
				nr_resumo_w,
				abs(vl_bruto_w),
				abs(vl_liquido_w),
				dt_compra_w);
		end if;

	/* Francisco - 03/03/2008 - Só importar o que for crédito, iclui o ie_debito no if abaixo */

	elsif (ie_tipo_registro_w = '2') and (ie_resumo_debito_w = 'N')  then

		insert	into	extrato_cartao_cr_movto(nr_sequencia,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_atualizacao,
			nm_usuario,
			nr_seq_extrato,
			nr_seq_extrato_res,
			vl_parcela,
			qt_parcelas,
			nr_cartao,
			nr_autorizacao,
			ds_comprovante,
			ds_rejeicao,
			dt_compra,
			nr_parcela,
			ie_pagto_indevido)
		values (nextval('extrato_cartao_cr_movto_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_extrato_p,
			nr_seq_extrato_res_w,
			vl_parcela_w,
			qt_parcelas_w,
			nr_cartao_w,
			nr_autorizacao_w,
			ds_comprovante_w,
			ds_rejeicao_w,
			dt_compra_w,
			nr_parcela_w,
			'N');
	end if;
end loop;
close c01;

select	min(dt_compra),
	max(dt_compra)
into STRICT	dt_min_parcela_w,
	dt_max_parcela_w
from	extrato_cartao_cr_movto
where	nr_seq_extrato	=	nr_seq_extrato_p;

update	extrato_cartao_cr
set	nr_extrato		= nr_extrato_w,
	dt_importacao		= clock_timestamp(),
	dt_processamento	= dt_processamento_w,
	dt_inicial		= dt_min_parcela_w,
	dt_final		= dt_max_parcela_w
where	nr_sequencia		= nr_seq_extrato_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importar_extrato_cartao_visa (nr_seq_extrato_p bigint, nm_usuario_p text) FROM PUBLIC;

