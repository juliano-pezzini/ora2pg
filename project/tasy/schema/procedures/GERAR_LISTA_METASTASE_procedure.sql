-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_lista_metastase ( Dt_metastase_p timestamp, ds_lista_p text, ds_lista_resultado_p INOUT text) AS $body$
DECLARE


lista_informacao_w    varchar(4000);
ds_lista_resultado_w    varchar(4000) := '';
tam_lista_w      bigint;
ie_pos_virgula_w    smallint;
nr_seq_metastase_w    bigint;
ds_metastase_w      varchar(4000);


BEGIN

ds_lista_resultado_p := null;

if (ds_lista_p IS NOT NULL AND ds_lista_p::text <> '') then

    lista_informacao_w  := ds_lista_p;

    while(lista_informacao_w IS NOT NULL AND lista_informacao_w::text <> '') loop
        begin

        tam_lista_w      := length(lista_informacao_w);
        ie_pos_virgula_w  := position(',' in lista_informacao_w);

        /* Obter a sequÃªncia lida */

        if (ie_pos_virgula_w <> 0) then
            nr_seq_metastase_w := substr(lista_informacao_w, 0, ie_pos_virgula_w - 1);
            lista_informacao_w := substr(lista_informacao_w, (ie_pos_virgula_w + 1), tam_lista_w);
        else
            nr_seq_metastase_w := lista_informacao_w;
            lista_informacao_w := null;
        end if;

        If (nr_seq_metastase_w IS NOT NULL AND nr_seq_metastase_w::text <> '') then
                    
            select   max(ds_metastase)
            into STRICT   ds_metastase_w
            from   metastase
            where   nr_sequencia = nr_seq_metastase_w;

            if (ds_lista_resultado_w IS NOT NULL AND ds_lista_resultado_w::text <> '') then
                ds_lista_resultado_w := substr(ds_lista_resultado_w || ', ', 0, 4000);
            end if;

            ds_lista_resultado_w := substr(ds_lista_resultado_w || ds_metastase_w, 0, 4000);
        end if;

        end;
    end loop;

    if (ds_lista_resultado_w IS NOT NULL AND ds_lista_resultado_w::text <> '') then
        ds_lista_resultado_w := substr(ds_lista_resultado_w ||'. Data: '||to_char(coalesce(Dt_metastase_p,clock_timestamp()),'dd/mm/yyyy'), 0, 4000);
    end if;

    ds_lista_resultado_p := substr(ds_lista_resultado_w, 0, 4000);

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_lista_metastase ( Dt_metastase_p timestamp, ds_lista_p text, ds_lista_resultado_p INOUT text) FROM PUBLIC;

