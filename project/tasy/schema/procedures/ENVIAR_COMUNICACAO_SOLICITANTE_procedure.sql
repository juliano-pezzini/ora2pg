-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_comunicacao_solicitante (dt_operacao_p timestamp, nr_prontuario_p bigint, cd_pessoa_fisica_p text, cd_pessoa_solic_p text, ds_tipo_operacao_p text, dt_baixa_p timestamp, nr_atendimento_p bigint, ds_arquivo_morto_p text, ds_observacao_p text, nm_usuario_p text) AS $body$
DECLARE

			 
nm_usuario_w		varchar(15);
ds_campo_w		varchar(2000);
nm_pessoa_fisica_w 	varchar(255);


BEGIN 
 
nm_pessoa_fisica_w := substr(obter_nome_pf(cd_pessoa_fisica_p),1,255);
ds_campo_w := Wheb_mensagem_pck.get_texto(308041) || ' ' /*'Dados da solicitação '*/|| chr(13) || 
		Wheb_mensagem_pck.get_texto(308042) || ': ' /*'Data da operação: '*/|| to_char(dt_operacao_p,'dd/mm/yyyy')|| chr(13) || chr(10)|| 
		Wheb_mensagem_pck.get_texto(308043) || ' ' /*'Prontuário: '*/|| to_char(nr_prontuario_p)|| chr(13) || chr(10)|| 
		Wheb_mensagem_pck.get_texto(308045) || ' ' /*'Pessoa Física: '*/|| nm_pessoa_fisica_w || chr(13) || chr(10)|| 
		Wheb_mensagem_pck.get_texto(308046) || ' ' /*'Operação: '*/|| ds_tipo_operacao_p || chr(13) || chr(10)|| 
		Wheb_mensagem_pck.get_texto(308047) || ' ' /*'Data da baixa: '*/|| to_char(dt_baixa_p,'dd/mm/yyyy') || chr(13) || chr(10)|| 
		Wheb_mensagem_pck.get_texto(308048) || ' ' /*'Atendimento: '*/|| nr_atendimento_p || chr(13) || chr(10)|| 
		Wheb_mensagem_pck.get_texto(308049) || ': ' /*'Arquivo morto: '*/|| ds_arquivo_morto_p || chr(13) || chr(10)|| 
		Wheb_mensagem_pck.get_texto(308050) || ' ' /*'Observação: '*/|| ds_observacao_p;
 
select	max(nm_usuario) 
into STRICT	nm_usuario_w 
from	usuario 
where	cd_pessoa_fisica = cd_pessoa_solic_p;
 
if (nr_prontuario_p IS NOT NULL AND nr_prontuario_p::text <> '') and (nm_usuario_w IS NOT NULL AND nm_usuario_w::text <> '') then 
 
	insert	into comunic_interna( 
		dt_comunicado, 
		ds_titulo, 
		ds_comunicado, 
		nm_usuario, 
		dt_atualizacao, 
		ie_geral, 
		nm_usuario_destino, 
		ie_gerencial, 
		nr_sequencia, 
		dt_liberacao) 
	values ( 
		clock_timestamp(), 
		Wheb_mensagem_pck.get_texto(308052) || ' ' /*'Solicitação do Prontuário nº '*/|| to_char(nr_prontuario_p) ||'.', 
		ds_campo_w, 
		nm_usuario_p, 
		clock_timestamp(), 
		'N', 
		nm_usuario_w, 
		'N', 
		nextval('comunic_interna_seq'), 
		clock_timestamp());
end if;
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_comunicacao_solicitante (dt_operacao_p timestamp, nr_prontuario_p bigint, cd_pessoa_fisica_p text, cd_pessoa_solic_p text, ds_tipo_operacao_p text, dt_baixa_p timestamp, nr_atendimento_p bigint, ds_arquivo_morto_p text, ds_observacao_p text, nm_usuario_p text) FROM PUBLIC;

