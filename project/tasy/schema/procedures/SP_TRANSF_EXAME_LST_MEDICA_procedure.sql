-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sp_transf_exame_lst_medica (PNR_PRESCRICAO bigint, PNR_SEQ_PRESCRICAO bigint, PNR_SEQ_FILA_ATUAL bigint, PDS_OBSERVACAO text) AS $body$
DECLARE

LISTA_ANT_W bigint;

BEGIN
  IF (PNR_PRESCRICAO IS NOT NULL AND PNR_PRESCRICAO::text <> '') AND (PNR_SEQ_PRESCRICAO IS NOT NULL AND PNR_SEQ_PRESCRICAO::text <> '') AND (PNR_SEQ_FILA_ATUAL IS NOT NULL AND PNR_SEQ_FILA_ATUAL::text <> '') AND (PDS_OBSERVACAO IS NOT NULL AND PDS_OBSERVACAO::text <> '') THEN
          SELECT COALESCE(MAX(NR_SEQ_LISTA),0) INTO STRICT LISTA_ANT_W FROM LISTA_EQUIPE_MED_EXEC
          WHERE  NR_PRESCRICAO = PNR_PRESCRICAO AND NR_SEQ_PRESCRICAO = PNR_SEQ_PRESCRICAO;

          IF (LISTA_ANT_W > 0) THEN
            INSERT INTO LISTA_EQUIPE_MED_EXEC_LOG(DT_ATUALIZACAO,
                                                 NM_USUARIO,
                                                 DT_ATUALIZACAO_NREC,
                                                 NM_USUARIO_NREC,
                                                 NR_PRESCRICAO,
                                                 NR_SEQ_PRESCRICAO,
                                                 NR_SEQ_LISTA_ANT,
                                                 NR_SEQ_LISTA_ATUAL,
                                                 DS_OBSERVACAO)
                                         VALUES (clock_timestamp(),
                                                WHEB_USUARIO_PCK.GET_NM_USUARIO,
                                                clock_timestamp(),
                                                WHEB_USUARIO_PCK.GET_NM_USUARIO,
                                                PNR_PRESCRICAO,
                                                PNR_SEQ_PRESCRICAO,
                                                LISTA_ANT_W,
                                                PNR_SEQ_FILA_ATUAL,
                                                PDS_OBSERVACAO);
          END IF;
          IF (LISTA_ANT_W <= 0) THEN
            INSERT INTO LISTA_EQUIPE_MED_EXEC(DT_ATUALIZACAO,
                                               NM_USUARIO,
                                               DT_ATUALIZACAO_NREC,
                                               NM_USUARIO_NREC,
                                               NR_PRESCRICAO,
                                               NR_SEQ_PRESCRICAO,
                                               NR_SEQ_LISTA)
                                      VALUES (clock_timestamp(),
                                               WHEB_USUARIO_PCK.GET_NM_USUARIO,
                                              clock_timestamp(),
                                              WHEB_USUARIO_PCK.GET_NM_USUARIO,
                                              PNR_PRESCRICAO,
                                              PNR_SEQ_PRESCRICAO,
                                              PNR_SEQ_FILA_ATUAL);
         END IF;

          IF (LISTA_ANT_W > 0) THEN
            UPDATE LISTA_EQUIPE_MED_EXEC
              SET  NR_SEQ_LISTA = PNR_SEQ_FILA_ATUAL
            WHERE  NR_PRESCRICAO = PNR_PRESCRICAO AND NR_SEQ_PRESCRICAO = PNR_SEQ_PRESCRICAO;
         END IF;

  END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sp_transf_exame_lst_medica (PNR_PRESCRICAO bigint, PNR_SEQ_PRESCRICAO bigint, PNR_SEQ_FILA_ATUAL bigint, PDS_OBSERVACAO text) FROM PUBLIC;

