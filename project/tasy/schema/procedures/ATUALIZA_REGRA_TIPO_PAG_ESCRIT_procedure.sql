-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_regra_tipo_pag_escrit ( nr_seq_escrit_p bigint, nr_titulo_p bigint, ie_tipo_pessoa_p text) AS $body$
DECLARE


ie_banco_w					integer;
cd_banco_escrit_w			integer;
cd_banco_tit_w				integer;
vl_maximo_w					double precision;
vl_minimo_w					double precision;
vl_saldo_titulo_w			double precision;
ie_tipo_pagamento_w			varchar(3) := null;
ds_retorno_w				varchar(255);
nr_conta_w					varchar(20);
ie_tipo_conta_pf_w			varchar(3);
ie_tipo_conta_pj_w			varchar(3);
vl_liquido_w				double precision;
cd_estabelecimento_w		smallint;
cd_tipo_baixa_neg_w			integer;
nr_seq_regra_tipo_pag_w		bigint;
cd_camara_compensacao_w		varchar(3);
ie_tipo_pagto_baixa_w		titulo_pagar.ie_tipo_pagamento%type;
ie_tipo_titulo_w			titulo_pagar.ie_tipo_titulo%type;	
ie_tipo_pessoa_w			varchar(1) := '';

c01 CURSOR FOR
	SELECT	ie_tipo_pagamento,
		nr_sequencia,
		cd_camara_compensacao
	from	regra_tipo_pag_escrit a
	where	a.cd_estabelecimento	= cd_estabelecimento_w
	and	coalesce(a.cd_tipo_baixa_neg,coalesce(cd_tipo_baixa_neg_w,0))	= coalesce(cd_tipo_baixa_neg_w,0)
	and	coalesce(a.ie_tipo_titulo,coalesce(ie_tipo_titulo_w,0))	= coalesce(ie_tipo_titulo_w,0)
	and	((coalesce(a.ie_valor,'S') = 'S' and (coalesce(vl_maximo,0) = 0 or coalesce(vl_saldo_titulo_w,0) <= vl_maximo) and (coalesce(vl_minimo,0) = 0 or coalesce(vl_saldo_titulo_w,0) >= vl_minimo)) or (coalesce(a.ie_valor,'S') = 'L' and (coalesce(vl_maximo,0) = 0 or coalesce(vl_liquido_w,0) <= vl_maximo) and (coalesce(vl_minimo,0) = 0 or coalesce(vl_liquido_w,0) >= vl_minimo)))
	and	(
				(ie_banco = 'N') or
			(
				(ie_banco = 'M') and
				((cd_banco_tit_w = cd_banco_escrit_w) or (cd_banco_tit_w in (	SELECT	z.cd_banco
											from	REGRA_TIPO_PAG_ESCRIT_BCO z
											where	z.nr_seq_regra	= a.nr_sequencia)))
			) or
			(
				(ie_banco = 'O') and
				((cd_banco_tit_w <> cd_banco_escrit_w)  and
								(cd_banco_tit_w not in (select	y.cd_banco
											from	REGRA_TIPO_PAG_ESCRIT_BCO y,
												regra_tipo_pag_escrit x
											where	y.nr_seq_regra	= x.nr_sequencia
                                            and x.cd_estabelecimento = a.cd_estabelecimento
											and	x.ie_situacao 	= 'A' /* OS  1864406*/
											and	((coalesce(x.vl_maximo,0) = 0) or (coalesce(vl_saldo_titulo_w,0) <= x.vl_maximo))
											and	((coalesce(x.vl_minimo,0) = 0) or (coalesce(vl_saldo_titulo_w,0) >= x.vl_minimo))
											and (x.ie_banco = 'M'))))
			)
		)
	and	ie_situacao = 'A'
	and	coalesce(ie_tipo_pagamento_w::text, '') = ''
	and	((coalesce(ie_tipo_pessoa,'A') = 'A') or (coalesce(ie_tipo_pessoa,'A') = coalesce(ie_tipo_pessoa_w, 'A')))
	and (ie_tipo_pessoa_p = 'PJ' or coalesce(ie_tipo_conta_pf,'T') = 'T' or coalesce(ie_tipo_conta_pf,'T') = coalesce(ie_tipo_conta_pf_w,'T')) 
	and (ie_tipo_pessoa_p = 'PF' or coalesce(ie_tipo_conta_pj,'T') = 'T' or coalesce(ie_tipo_conta_pj,'T') = coalesce(ie_tipo_conta_pj_w,'T'))
	and	( ((a.ie_banco = 'M') and coalesce(a.cd_banco,cd_banco_escrit_w) = cd_banco_escrit_w) or (a.ie_banco in ('N', 'O')) )--Somente se aplica para regra quando for Mesmo Banco, OS 1286883
	order by 	coalesce(cd_tipo_baixa_neg,0),
				coalesce(cd_banco,0),
				coalesce(nr_sequencia,0);


BEGIN

ie_tipo_pagamento_w	:= null;

select	max(a.cd_banco),
	max(a.vl_escritural),
	max(a.nr_conta),
	max(coalesce(a.vl_escritural,0) + coalesce(a.vl_acrescimo,0) - coalesce(a.vl_desconto,0) + coalesce(a.vl_juros,0) + coalesce(a.vl_multa,0) + coalesce(a.vl_despesa,0)) vl_liquido,
	max(b.cd_tipo_baixa_neg),
	max(ie_tipo_titulo)
into STRICT	cd_banco_tit_w,
	vl_saldo_titulo_w,
	nr_conta_w,
	vl_liquido_w,
	cd_tipo_baixa_neg_w,
	ie_tipo_titulo_w
from	titulo_pagar b,
	titulo_pagar_escrit a
where	a.nr_titulo	= b.nr_titulo
and	a.nr_titulo	= nr_titulo_p
and	a.nr_seq_escrit	= nr_seq_escrit_p;

select	max(cd_banco),
	max(cd_estabelecimento)
into STRICT	cd_banco_escrit_w,
	cd_estabelecimento_w
from	banco_escritural
where	nr_sequencia	= nr_seq_escrit_p;

if (ie_tipo_pessoa_p = 'PF') then
	select	max(b.ie_tipo_conta)
	into STRICT	ie_tipo_conta_pf_w
	from	pessoa_fisica_conta 	b,
		pessoa_fisica 		c,
		titulo_pagar 		a
	where	a.cd_pessoa_fisica	= c.cd_pessoa_fisica
	and	c.cd_pessoa_fisica	= b.cd_pessoa_fisica
	and	b.nr_conta		= nr_conta_w
	and	a.nr_titulo		= nr_titulo_p;
else
	select	max(b.ie_tipo_conta)
	into STRICT	ie_tipo_conta_pj_w
	from	pessoa_juridica_conta 	b,
		pessoa_juridica 	c,
		titulo_pagar 		a
	where	a.cd_cgc	= c.cd_cgc
	and	c.cd_cgc	= b.cd_cgc
	and	b.nr_conta	= nr_conta_w
	and	a.nr_titulo 	= nr_titulo_p;
end if;


/*OS 1649001. O tipo_pessoa_p e passado como PF ou PJ. No cursor, onde verifica o tipo de pessoa na tabela, la e apenas P ou J,  enao PF ou PJ. 
Como esse ie_tipo_pesso_p utiliza em outras condicoes do cursor, nao modifiquei as rotinas que chamam essa para passar P ou J, apenas alterado no cursor qdo verifica o ie_tipo_pessoa na regra, em vez de compara com PF ou PJ, compara com J ou F*/
if (ie_tipo_pessoa_p = 'PJ') then
	ie_tipo_pessoa_w := 'J';
elsif (ie_tipo_pessoa_p = 'PF') then
	ie_tipo_pessoa_w := 'F';
end if;

open c01;
loop
fetch c01 into
	ie_tipo_pagamento_w,
	nr_seq_regra_tipo_pag_w,
	cd_camara_compensacao_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
end loop;
close c01;

select	max(a.ie_tipo_pagamento)
into STRICT	ie_tipo_pagto_baixa_w
from	titulo_pagar a
where	a.nr_titulo	= nr_titulo_p;

if (coalesce(ie_tipo_pagamento_w::text, '') = '') and (ie_tipo_pagto_baixa_w IS NOT NULL AND ie_tipo_pagto_baixa_w::text <> '') then
	ie_tipo_pagamento_w := ie_tipo_pagto_baixa_w;
end if;

if (ie_tipo_pagamento_w IS NOT NULL AND ie_tipo_pagamento_w::text <> '') then
	update	titulo_pagar_escrit
	set	ie_tipo_pagamento	= ie_tipo_pagamento_w,
		nr_seq_regra_tipo_pag	= nr_seq_regra_tipo_pag_w,
		cd_camara_compensacao	=  coalesce(cd_camara_compensacao_w,cd_camara_compensacao)
	where	nr_titulo 		= nr_titulo_p
	and	nr_seq_escrit		= nr_seq_escrit_p;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_regra_tipo_pag_escrit ( nr_seq_escrit_p bigint, nr_titulo_p bigint, ie_tipo_pessoa_p text) FROM PUBLIC;

