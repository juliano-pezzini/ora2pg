-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_diaria_uti_sus ( nr_seq_protocolo_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE

 
ds_erro_w    		varchar(2000)	:= '';
dt_vigencia_w		timestamp;
cd_tipo_leito_w		smallint;
qt_leito_w		integer;
dt_vigencia_ant_w		timestamp;
cd_tipo_leito_ant_w		smallint;
dt_referencia_w		timestamp;
qt_dias_mes_w		smallint;
qt_leitos_disp_w		integer;
qt_leitos_util_w		integer;
ds_tipo_leito_w		varchar(40);

 
c01 CURSOR FOR 
	SELECT	a.cd_tipo_leito, 
		a.dt_vigencia, 
		a.qt_leito, 
		substr(b.ds_tipo_leito,1,40) 
	from	sus_tipo_leito b, 
		sus_leito a 
	where  a.cd_tipo_leito	= b.cd_tipo_leito 
	and	a.dt_vigencia 	= 
    		(SELECT max(x.dt_vigencia) 
        		from sus_leito x 
        		where x.dt_vigencia <= dt_referencia_w 
        		and  x.cd_tipo_leito = a.cd_tipo_leito);


BEGIN 
ds_erro_w 	:= '';
 
select	coalesce(max(dt_mesano_referencia),clock_timestamp()) 
into STRICT	dt_referencia_w 
from	protocolo_convenio 
where	nr_seq_protocolo	= nr_seq_protocolo_p;
 
select 	somente_numero(to_char(last_day(dt_referencia_w),'dd')) 
into STRICT	qt_dias_mes_w
;
 
OPEN C01;
LOOP 
FETCH C01 into 
		cd_tipo_leito_w, 
		dt_vigencia_w, 
		qt_leito_w, 
		ds_tipo_leito_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	BEGIN 
	qt_leitos_disp_w	:= (qt_leito_w * qt_dias_mes_w);
	 
	select	sum(qt_diaria) 
	into STRICT	qt_leitos_util_w 
	from	sus_leito_movto a 
	where	trunc(a.dt_referencia,'month')	= trunc(dt_referencia_w,'month') 
	and	a.cd_tipo_leito		= cd_tipo_leito_w;
 
	if (qt_leitos_util_w	> qt_leitos_disp_w) then 
		ds_erro_w := ds_erro_w ||wheb_mensagem_pck.get_texto(281601,'CD_TIPO_LEITO='|| to_char(cd_tipo_leito_w)||';QT_LEITOS_DISP=' 
					|| to_char(qt_leitos_disp_w)||';QT_LEITOS_UTIL='|| to_char(qt_leitos_util_w));
	end if;
	END;
END LOOP;
CLOSE C01;
 
ds_erro_p	:= substr(ds_erro_w,1,205);
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_diaria_uti_sus ( nr_seq_protocolo_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

