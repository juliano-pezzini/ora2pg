-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_item_lote_audit (nr_seq_hist_item_p bigint, cd_motivo_glosa_p bigint, cd_resposta_p bigint, cd_setor_responsavel_p bigint, ie_acao_glosa_p text, vl_glosa_p bigint, ds_observacao_p text, nm_usuario_p text, ie_tipo_glosa_p text, ie_retorno_p INOUT text) AS $body$
DECLARE


/*	ie_retorno_p

S	Alterado
N	NÃ£o alterado

*/
vl_glosa_w		double precision;
vl_amenor_w		double precision;
ie_acao_glosa_w		varchar(1);
cd_motivo_glosa_w	integer;
cd_resposta_w		bigint;
cd_setor_responsavel_w	integer;
ds_observacao_w		varchar(4000);
vl_glosa_informada_w	double precision;
cd_estabelecimento_w	smallint;
vl_saldo_w		double precision;
ie_tipo_glosa_w		varchar(1);

ie_acao_final_w		varchar(1);
ie_tipo_glosa_final_w	varchar(1);
cd_motivo_final_w	integer;
cd_resposta_final_w	bigint;
cd_setor_final_w	integer;
ds_observacao_final_w	varchar(4000);

ie_consistencia_w	varchar(1)	:= 'S';
ie_glosa_maior_w	varchar(1);



BEGIN

select	max(a.vl_glosa),
	max(a.vl_amenor),
	max(a.ie_acao_glosa),
	max(a.cd_motivo_glosa),
	max(a.cd_resposta),
	max(a.cd_setor_responsavel),
	max(a.ds_observacao),
	max(a.vl_glosa_informada),
	max(d.cd_estabelecimento),
	max(a.vl_saldo),
	max(a.ie_tipo_glosa)
into STRICT	vl_glosa_w,
	vl_amenor_w,
	ie_acao_glosa_w,
	cd_motivo_glosa_w,
	cd_resposta_w,
	cd_setor_responsavel_w,
	ds_observacao_w,
	vl_glosa_informada_w,
	cd_estabelecimento_w,
	vl_saldo_w,
	ie_tipo_glosa_w
from	lote_auditoria d,
	lote_audit_hist c,
	lote_audit_hist_guia b,
	lote_audit_hist_item a
where	c.nr_seq_lote_audit	= d.nr_sequencia
and	b.nr_seq_lote_hist	= c.nr_sequencia
and	a.nr_seq_guia		= b.nr_sequencia
and	a.nr_sequencia		= nr_seq_hist_item_p;

ie_acao_final_w	:= ie_acao_glosa_p;

if	/*(ie_acao_final_w	is not null) and
	((cd_motivo_glosa_p	is null) or
	(cd_setor_responsavel_p	is null) or
	((ds_observacao_p is null) and (cd_resposta_p is null)) or*/
	((ie_acao_final_w = 'P') and ((vl_glosa_w = 0) or (vl_amenor_w = 0))) then

	ie_acao_final_w		:= ie_acao_glosa_w;
	ie_consistencia_w	:= 'N';

	if (coalesce(cd_motivo_glosa_p::text, '') = '') then
		cd_motivo_final_w	:= cd_motivo_glosa_w;
	end if;

	if (coalesce(cd_resposta_p::text, '') = '') then
		cd_resposta_final_w	:= cd_resposta_w;
	end if;

	if (coalesce(cd_setor_responsavel_p::text, '') = '') then
		cd_setor_final_w	:= cd_setor_responsavel_w;
	end if;

	if (coalesce(ds_observacao_p::text, '') = '') then
		ds_observacao_final_w	:= ds_observacao_w;
	end if;

	if (coalesce(ie_tipo_glosa_p::text, '') = '') then
		ie_tipo_glosa_final_w	:= ie_tipo_glosa_w;
	end if;


else

	cd_motivo_final_w	:= cd_motivo_glosa_p;
	cd_resposta_final_w	:= cd_resposta_p;
	ie_tipo_glosa_final_w	:= ie_tipo_glosa_p;
	cd_setor_final_w	:= cd_setor_responsavel_p;
	ds_observacao_final_w	:= ds_observacao_p;

end if;

ie_glosa_maior_w := obter_param_usuario(69, 32, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_glosa_maior_w);

if (vl_glosa_p IS NOT NULL AND vl_glosa_p::text <> '') and
	((coalesce(ie_glosa_maior_w,'N') = 'S') or (vl_saldo_w >= vl_glosa_p)) then

	vl_glosa_informada_w	:= vl_glosa_p;

end if;

if (ie_acao_final_w	= 'A') then

	vl_glosa_w		:= vl_glosa_informada_w;
	vl_amenor_w		:= 0;

elsif (ie_acao_final_w	= 'R') then

	vl_glosa_w		:= 0;
	vl_amenor_w		:= vl_glosa_informada_w;

end if;

update	lote_audit_hist_item
set	dt_atualizacao		= clock_timestamp(),
	nm_usuario		= nm_usuario_p,
	vl_glosa_informada	= vl_glosa_informada_w,
	vl_glosa		= vl_glosa_w,
	vl_amenor		= vl_amenor_w,
	ie_acao_glosa		= ie_acao_final_w,
	cd_motivo_glosa		= cd_motivo_final_w,
	cd_resposta		= cd_resposta_final_w,
	ie_tipo_glosa		= ie_tipo_glosa_final_w,
	cd_setor_responsavel	= cd_setor_final_w,
	ds_observacao		= ds_observacao_final_w
where	nr_sequencia		= nr_seq_hist_item_p;

ie_retorno_p	:= ie_consistencia_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_item_lote_audit (nr_seq_hist_item_p bigint, cd_motivo_glosa_p bigint, cd_resposta_p bigint, cd_setor_responsavel_p bigint, ie_acao_glosa_p text, vl_glosa_p bigint, ds_observacao_p text, nm_usuario_p text, ie_tipo_glosa_p text, ie_retorno_p INOUT text) FROM PUBLIC;

