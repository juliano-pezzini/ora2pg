-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_sol_bom_elast_qt ( nr_seq_paciente_p bigint, nr_seq_solucao_p bigint, nm_usuario_p text) AS $body$
DECLARE

/*
ie_cd_ds_p = [D]escrição / [C]ódigo
*/
/* Lê a tabela REGRA_BOMBA_ELASTOMERICA e
retorna a sequencia da  tabela BOMBA_ELASTOMERICA que se aplica a solução*/
ie_tipo_dosagem_w	varchar(3);
qt_solucao_total_w	double precision;
qt_dosagem_w		double precision;
ie_bomba_infusao_w	varchar(1);
nr_seq_bomba_elast_w	bigint := null;
qt_reg_w		bigint;
ds_bomba_w		varchar(255);
qt_tempo_aplicacao_w	double precision;
qt_volume_medic_anc_w	double precision;
nr_seq_regra_bomba_w	bigint;
nr_seq_regra_bomba_final_w	bigint := null;
nr_seq_bomba_elast_final_w	bigint := null;
nr_seq_w		bigint;
qt_capacidade_bomba_w	double precision;
qt_dosagem_bomba_w	double precision;
qt_solucao_w		double precision;
qt_soro_w		double precision;

c01 CURSOR FOR
	/*Select	a.nr_sequencia, b.nr_sequencia
	from	bomba_elastomerica a,
		regra_bomba_elastomerica b
	where	a.nr_sequencia = b.nr_seq_bomba
	and 	nvl(a.ie_situacao,'I') = 'A'
	and 	b.qt_solucao_total =
			(*/
SELECT	d.nr_sequencia, c.nr_sequencia
			from	regra_bomba_elastomerica c,
				bomba_elastomerica d
			where 	c.nr_seq_bomba	= d.nr_sequencia
			and		coalesce(d.ie_situacao,'I') = 'A'
			and (qt_tempo_aplicacao_w * c.qt_dosagem) <= c.qt_solucao_total
			and 	Obter_vel_sol_mlh(c.ie_tipo_dosagem, c.qt_dosagem) >= qt_solucao_total_w / qt_tempo_aplicacao_w
			and		c.qt_solucao_total >= qt_solucao_total_w
	--and 	Obter_vel_sol_mlh(b.ie_tipo_dosagem, b.qt_dosagem) >= qt_solucao_total_w / qt_tempo_aplicacao_w
	order by c.qt_solucao_total asc,
			 Obter_vel_sol_mlh(c.ie_tipo_dosagem, c.qt_dosagem) desc;



BEGIN

Select	count(*)
into STRICT	qt_reg_w
from	regra_bomba_elastomerica;

if (qt_reg_w > 0) then
	Select	max(qt_solucao_total),
		max(ie_tipo_dosagem),
		max(qt_dosagem),
		max(ie_bomba_infusao),
		CASE WHEN coalesce(max(qt_tempo_aplicacao),0)=0 THEN 1  ELSE max(qt_tempo_aplicacao) END
	into STRICT	qt_solucao_total_w,
		ie_tipo_dosagem_w,
		qt_dosagem_w,
		ie_bomba_infusao_w,
		qt_tempo_aplicacao_w
	from	paciente_protocolo_soluc
	where	nr_seq_paciente	= nr_seq_paciente_p
	and	nr_seq_solucao	= nr_seq_solucao_p;

	select	sum(obter_dose_convertida(a.cd_material, a.qt_dose_prescr, a.cd_unid_med_prescr, obter_unid_med_usua('ml')))
	into STRICT	qt_solucao_total_w
	from	paciente_protocolo_medic a,
		material b
	where	b.cd_material 		= a.cd_material
	and	a.nr_seq_paciente	= nr_seq_paciente_p
	and	a.nr_seq_solucao	= nr_seq_solucao_p
	and 	coalesce(b.ie_ancora_solucao,'S') = 'S';


	if (ie_tipo_dosagem_w IS NOT NULL AND ie_tipo_dosagem_w::text <> '') and (qt_dosagem_w IS NOT NULL AND qt_dosagem_w::text <> '') and (qt_solucao_total_w IS NOT NULL AND qt_solucao_total_w::text <> '') and (ie_bomba_infusao_w = 'B') then
		open C01;
		loop
		fetch C01 into
			nr_seq_bomba_elast_w,
			nr_seq_regra_bomba_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			if (coalesce(nr_seq_bomba_elast_final_w::text, '') = '') then
				nr_seq_bomba_elast_final_w := nr_seq_bomba_elast_w;
				nr_seq_regra_bomba_final_w := nr_seq_regra_bomba_w;
			end if;
		end loop;
		close c01;

		if (nr_seq_bomba_elast_w IS NOT NULL AND nr_seq_bomba_elast_w::text <> '') and (nr_seq_regra_bomba_w IS NOT NULL AND nr_seq_regra_bomba_w::text <> '') then

			qt_volume_medic_anc_w	:= qt_solucao_total_w;

			Select	qt_solucao_total,
				Obter_vel_sol_mlh(ie_tipo_dosagem, qt_dosagem) qt_dosagem_bomba_w
			into STRICT	qt_capacidade_bomba_w,
				qt_dosagem_bomba_w
			from	regra_bomba_elastomerica
			where 	nr_sequencia = nr_seq_regra_bomba_final_w;

			qt_solucao_total_w := qt_dosagem_bomba_w * qt_tempo_aplicacao_w;
			qt_dosagem_w	   := qt_dosagem_bomba_w;

			select	max(a.NR_SEQ_MATERIAL)
			into STRICT	nr_seq_w
			from	PACIENTE_PROTOCOLO_MEDIC a,
				material b
			where	a.cd_material		= b.cd_material
			and	a.NR_SEQ_PACIENTE	= nr_seq_paciente_p
			and	a.NR_SEQ_SOLUCAO 	= nr_seq_solucao_p
			and	coalesce(b.ie_ancora_solucao,'N') = 'N';

			select	sum(obter_dose_convertida(a.cd_material, a.qt_dose_prescr, a.cd_unid_med_prescr, obter_unid_med_usua('ml')))
			into STRICT	qt_solucao_w
			from	paciente_protocolo_medic a,
				material b
			where	a.cd_material	= b.cd_material
			and	a.NR_SEQ_PACIENTE	= nr_seq_paciente_p
			and	a.NR_SEQ_SOLUCAO = nr_seq_solucao_p
			and	coalesce(b.ie_ancora_solucao,'N') = 'S';

			qt_soro_w	:= qt_solucao_total_w - qt_solucao_w;

			if (nr_seq_w > 0) then
				--(nvl(qt_soro_w,0) > 0) then
				update	paciente_protocolo_medic
				set	qt_dose_prescr		= qt_soro_w,
					cd_unid_med_prescr	= obter_unid_med_usua('ml'),
					ie_zerado		= CASE WHEN coalesce(qt_soro_w,0)=0 THEN 'S'  ELSE 'N' END
				where	nr_seq_paciente		= nr_seq_paciente_p
				and	nr_seq_solucao		= nr_seq_solucao_p
				and	nr_seq_material		= nr_seq_w;

			end if;

			update	paciente_protocolo_soluc
			set	qt_dosagem		= qt_dosagem_w,
				ie_tipo_dosagem		= 'mlh',
				qt_solucao_total	= qt_solucao_total_w
			where	nr_seq_paciente		= nr_seq_paciente_p
			and	nr_seq_solucao		= nr_seq_solucao_p;

		end if;
	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_sol_bom_elast_qt ( nr_seq_paciente_p bigint, nr_seq_solucao_p bigint, nm_usuario_p text) FROM PUBLIC;

