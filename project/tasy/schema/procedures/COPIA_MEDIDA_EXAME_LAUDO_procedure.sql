-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE campos AS (nr_seq_old bigint, nr_seq_new bigint);


CREATE OR REPLACE PROCEDURE copia_medida_exame_laudo ( cd_procedimento_origem_p bigint, cd_procedimento_destino_p bigint, nm_usuario_p text) AS $body$
DECLARE

type Vetor is table of campos index by integer;

nr_seq_old_w		bigint;
nr_seq_new_w		bigint;
ds_medida_w		varchar(255);
ds_formula_w		varchar(100);
ds_unidade_medida_w	varchar(20);
ie_criar_regua_w      varchar(1);
ie_tabstop_w          varchar(1);
ie_tipo_valor_w       varchar(1);
nr_seq_tipo_medida_w    varchar(10);
nr_seq_apres_w		smallint;
ie_informado_w		varchar(1);
cont_w			integer;
qt_tamanho_w		smallint;
qt_max_length_w		smallint;

i			integer := 1;
Vetor_w			Vetor;


C01 CURSOR FOR
	SELECT	nr_sequencia,
		ds_medida,
		ds_formula,
		ds_unidade_medida,
		nr_seq_apresentacao,
		ie_informado,
		qt_tamanho,
		qt_max_length,
		ie_criar_regua,
		nr_seq_tipo_medida,
		ie_tabstop,
		ie_tipo_valor
	from	medida_exame_laudo
	where	cd_procedimento = cd_procedimento_origem_p
	and	ie_situacao = 'A';


BEGIN

select 	count(*)
into STRICT	cont_w
from	medida_exame_laudo a
where	a.cd_procedimento = cd_procedimento_destino_p;

if (cont_w > 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(281861);
end if;

/*	Edgar 07/05/2003
delete from medida_exame_laudo
where cd_procedimento = cd_procedimento_destino_p;
*/
open c01;
loop
	fetch c01 into	nr_seq_old_w,
				ds_medida_w,
				ds_formula_w,
				ds_unidade_medida_w,
				nr_seq_apres_w,
				ie_informado_w,
				qt_tamanho_w,
				qt_max_length_w,
				ie_criar_regua_w,
				nr_seq_tipo_medida_w,
				ie_tabstop_w,
				ie_tipo_valor_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

	select nextval('medida_exame_laudo_seq')
	into STRICT nr_seq_new_w
	;

	insert into medida_exame_laudo(
			NR_SEQUENCIA,
			CD_PROCEDIMENTO,
			IE_ORIGEM_PROCED,
			DT_ATUALIZACAO,
			NM_USUARIO,
			DS_MEDIDA,
			DS_FORMULA,
			DS_UNIDADE_MEDIDA,
			NR_SEQ_APRESENTACAO,
			IE_INFORMADO,
			IE_SITUACAO,
			QT_TAMANHO,
			qt_max_length,
			IE_CRIAR_REGUA,
			NR_SEQ_TIPO_MEDIDA,
			IE_TABSTOP,
			IE_TIPO_VALOR)
	values (	nr_seq_new_w,
			cd_procedimento_destino_p,
			1,
			clock_timestamp(),
			nm_usuario_p,
			ds_medida_w,
			ds_formula_w,
			ds_unidade_medida_w,
			nr_seq_apres_w,
			ie_informado_w,
			'A',
			qt_tamanho_w,
			qt_max_length_w,
			ie_criar_regua_w,
			nr_seq_tipo_medida_w,
			ie_tabstop_w,
			ie_tipo_valor_w);

	Vetor_w[i].nr_seq_old := nr_seq_old_w;
	Vetor_w[i].nr_seq_new := nr_seq_new_w;
	i := i + 1;
end loop;
close c01;

for i in 1..Vetor_w.count loop
	update medida_exame_laudo
	set ds_formula = replace(ds_formula,'@' || Vetor_w[i].nr_seq_old, '@' || Vetor_w[i].nr_seq_new)
	where cd_procedimento = cd_procedimento_destino_p
	  and (ds_formula IS NOT NULL AND ds_formula::text <> '');
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copia_medida_exame_laudo ( cd_procedimento_origem_p bigint, cd_procedimento_destino_p bigint, nm_usuario_p text) FROM PUBLIC;

