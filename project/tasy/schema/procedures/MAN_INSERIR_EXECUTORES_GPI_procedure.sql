-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_inserir_executores_gpi ( nr_seq_ordem_serv_p bigint, nr_seq_etapa_gpi_p bigint, nm_usuario_p text) AS $body$
DECLARE


C01 CURSOR FOR
	SELECT	nm_usuario
	from	usuario a
	where	ie_situacao = 'A'
	and		not exists (SELECT 1 from man_ordem_servico_exec b where b.nr_seq_ordem = nr_seq_ordem_serv_p and b.nm_usuario_exec = a.nm_usuario)
	and		cd_pessoa_fisica in (	select	b.cd_pessoa_fisica
									from	gpi_cron_etapa_equipe b,
											gpi_cron_etapa a
									where	a.nr_sequencia	= b.nr_seq_etapa
									and		a.nr_sequencia	= nr_seq_etapa_gpi_p
									and		(b.cd_pessoa_fisica IS NOT NULL AND b.cd_pessoa_fisica::text <> '')
									
union all

									select	d.cd_pessoa_fisica
									from	gpi_proj_equipe_membro d,
											gpi_proj_equipe c,
											gpi_cron_etapa_equipe b,
											gpi_cron_etapa a
									where	a.nr_sequencia	= b.nr_seq_etapa
									and	b.nr_seq_equipe	= c.nr_sequencia
									and	c.nr_sequencia	= d.nr_seq_equipe
									and	a.nr_sequencia	= nr_seq_etapa_gpi_p
									and	(b.nr_seq_equipe IS NOT NULL AND b.nr_seq_equipe::text <> ''));

BEGIN

for C01_W in C01 loop
	begin
		insert into
		man_ordem_servico_exec(	nr_sequencia,
									nr_seq_ordem,
									dt_atualizacao,
									nm_usuario,
									nm_usuario_exec)
		values (	nextval('man_ordem_servico_exec_seq'),
									nr_seq_ordem_serv_p,
									clock_timestamp(),
									nm_usuario_p,
									C01_W.nm_usuario);
	end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_inserir_executores_gpi ( nr_seq_ordem_serv_p bigint, nr_seq_etapa_gpi_p bigint, nm_usuario_p text) FROM PUBLIC;

