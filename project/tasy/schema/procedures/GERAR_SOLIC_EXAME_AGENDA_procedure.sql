-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_solic_exame_agenda ( cd_pessoa_fisica_p text, nr_seq_agenda_p bigint, cd_agenda_p bigint, dt_agenda_p timestamp, nm_usuario_p text) AS $body$
DECLARE

 
nr_prontuario_w			bigint;
nr_seq_prontuario_w		bigint;
nr_seq_solic_w			bigint;
cd_setor_atendimento_w		bigint;
cd_estabelecimento_w		bigint;


BEGIN 
select	max(cd_setor_exclusivo), 
	max(cd_estabelecimento) 
into STRICT	cd_setor_atendimento_w, 
	cd_estabelecimento_w 
from	agenda 
where	cd_agenda		= cd_agenda_p;
 
select	coalesce(max(nr_prontuario), 0) 
into STRICT	nr_prontuario_w 
from	pessoa_fisica 
where 	cd_pessoa_fisica	= cd_pessoa_fisica_p;
 
select	coalesce(max(nr_sequencia),0) 
into STRICT	nr_seq_prontuario_w 
from	exame_prontuario 
where	nr_prontuario		= nr_prontuario_w;
 
if (cd_setor_atendimento_w IS NOT NULL AND cd_setor_atendimento_w::text <> '') and (nr_seq_prontuario_w > 0) then 
	begin	 
	select	coalesce(max(nr_sequencia),0) 
	into STRICT	nr_seq_solic_w 
	from	exame_solicitacao 
	where	cd_estabelecimento		= cd_estabelecimento_w 
	and	nr_prontuario			= nr_prontuario_w 
	and	cd_setor_atendimento		= cd_setor_atendimento 
	and	cd_agenda			= cd_agenda_p 
	and	trunc(dt_desejada, 'dd')	= trunc(dt_agenda_p, 'dd');
	 
	if (nr_seq_solic_w = 0) then 
		begin 
		insert 	into exame_solicitacao( 
			nr_sequencia, 
			cd_estabelecimento, 
			nr_prontuario, 
			dt_atualizacao, 
			nm_usuario, 
			nr_seq_agenda, 
			cd_setor_atendimento, 
			dt_solicitacao, 
			dt_desejada, 
			ie_status_solic,     
			nm_usuario_solic, 
			cd_agenda, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec     
		) values ( 
			nextval('exame_solicitacao_seq'), 
			cd_estabelecimento_w, 
			nr_prontuario_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			nr_seq_agenda_p, 
			cd_setor_atendimento_w, 
			clock_timestamp(), 
			dt_agenda_p, 
			'A', 
			nm_usuario_p, 
			cd_agenda_p, 
			clock_timestamp(), 
			nm_usuario_p 
		);
		end;
	end if;
 
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_solic_exame_agenda ( cd_pessoa_fisica_p text, nr_seq_agenda_p bigint, cd_agenda_p bigint, dt_agenda_p timestamp, nm_usuario_p text) FROM PUBLIC;

