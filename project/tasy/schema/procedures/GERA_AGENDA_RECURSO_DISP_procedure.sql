-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gera_agenda_recurso_disp ( nr_seq_agenda_p bigint, cd_agenda_p bigint, nm_usuario_p text, cd_estab_agenda_p INOUT bigint, lista_equip_p INOUT text, lista_cme_p INOUT text) AS $body$
DECLARE

 
cd_equipamento_w	bigint;
nr_seq_conjunto_w	bigint;
cd_estab_agenda_w	smallint := 0;
lista_equip_w		varchar(2000) := '';
lista_cme_w		varchar(2000) := '';

c01 CURSOR FOR 
	SELECT	distinct 
		cd_equipamento, 
		nr_seq_conjunto 
	from	consistencia_agenda_cir 
	where	nr_seq_agenda = nr_seq_agenda_p;
		

BEGIN 
 
open c01;
loop 
fetch c01 into 	cd_equipamento_w, 
		nr_seq_conjunto_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	--restante da rotina que usa os valores do cursor 01 
	if (cd_equipamento_w IS NOT NULL AND cd_equipamento_w::text <> '') then 
		begin 
		lista_equip_w := lista_equip_w || cd_equipamento_w || ',';
		end;
	elsif (nr_seq_conjunto_w IS NOT NULL AND nr_seq_conjunto_w::text <> '') then 
		begin 
		lista_cme_w := lista_cme_w || nr_seq_conjunto_w || ',';
		end;
	end if;
	end; --do begin depois do exitWhen 
end loop;
close c01;
 
--Função 871 - Gestão da agenda cirurgica - AtePac_A6 
--Parâmetro 422 - Gerar os horários disponíveis do recurso conforme estabelecimento da agenda 
if (obter_parametro_funcao(871, 422, nm_usuario_p) = 'S') then 
	begin 
	select	coalesce(max(cd_estabelecimento),0) cd_estab 
	into STRICT	cd_estab_agenda_w 
	from	agenda 
	where	cd_agenda = cd_agenda_p;
	end;
end if;
 
cd_estab_agenda_p := cd_estab_agenda_w;
lista_equip_p := lista_equip_w;
lista_cme_p := lista_cme_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gera_agenda_recurso_disp ( nr_seq_agenda_p bigint, cd_agenda_p bigint, nm_usuario_p text, cd_estab_agenda_p INOUT bigint, lista_equip_p INOUT text, lista_cme_p INOUT text) FROM PUBLIC;

