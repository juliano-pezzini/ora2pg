-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_imp_ressarcimento_proc ( nr_seq_processo_conta_p text, nm_usuario_p text, cd_procedimento_p text, ie_tipo_proced_p text, qt_procedimento_p text, vl_procedimento_p text, ds_incremento_p text) AS $body$
DECLARE


nr_seq_prestador_w      bigint;
cd_estabelecimento_w    smallint;
nr_seq_processo_proc_w  bigint;
nr_seq_processo_w       bigint;
qt_procedimento_w       double precision;
vl_procedimento_w       double precision;
vl_proc_unit_w		double precision;
cd_procedimento_w       bigint;
ie_tipo_proced_w        varchar(1);
ie_origem_proced_w      bigint;
cd_procedimento_imp_w	bigint;
ds_incremento_w		pls_processo_procedimento.ds_incremento%type;
value_w			nls_session_parameters.value%type;


BEGIN

select  max(ie_origem_proced)
into STRICT    ie_origem_proced_w
from    procedimento
where   cd_procedimento = cd_procedimento_p;

ie_tipo_proced_w        := to_char(substr(ie_tipo_proced_p,1,1));
qt_procedimento_w       := (somente_numero(qt_procedimento_p))::numeric;

select 	value
into STRICT	value_w
from 	nls_session_parameters
where	parameter = 'NLS_NUMERIC_CHARACTERS';

if (position(',' in value_w) > 0) then
	vl_procedimento_w       := (replace(vl_procedimento_p,'.',','))::numeric;
else
	vl_procedimento_w       := (vl_procedimento_p)::numeric;
end if;

cd_procedimento_imp_w	:= (somente_numero(cd_procedimento_p))::numeric;
ds_incremento_w		:= to_char(substr(ds_incremento_p,1,4000));

begin
	-- se nao localizar a origem do procedimento, tem que deixar o codigo como null
	if (coalesce(ie_origem_proced_w::text, '') = '') then
		cd_procedimento_w	:= null;
	else
		cd_procedimento_w	:= (somente_numero(cd_procedimento_p))::numeric;
	end if;

	vl_proc_unit_w	:= vl_procedimento_w / qt_procedimento_w;
exception
when others then
	vl_proc_unit_w	:= 0;
end;

insert into pls_processo_procedimento(	nr_sequencia,				nr_seq_conta,			cd_procedimento,
					ie_origem_proced,			qt_procedimento,		vl_procedimento,
					dt_atualizacao,				nm_usuario,			ie_tipo_procedimento,
					vl_unitario,				cd_procedimento_imp,		ds_incremento)
			values ( 	nextval('pls_processo_procedimento_seq'),	nr_seq_processo_conta_p,	cd_procedimento_w,
					ie_origem_proced_w,			qt_procedimento_w,		vl_procedimento_w,
					clock_timestamp(),				nm_usuario_p,			ie_tipo_proced_w,
					vl_proc_unit_w,				cd_procedimento_imp_w,		ds_incremento_w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_imp_ressarcimento_proc ( nr_seq_processo_conta_p text, nm_usuario_p text, cd_procedimento_p text, ie_tipo_proced_p text, qt_procedimento_p text, vl_procedimento_p text, ds_incremento_p text) FROM PUBLIC;

