-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE nota_fiscal_servico (cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, nm_usuario_p text) AS $body$
DECLARE

 
nr_sequencia_w			varchar(10);
cd_serie_nf_w			varchar(10);
nr_nota_fiscal_w		varchar(255);
dt_emissao_documento_w		varchar(8);
cd_participante_w		varchar(15);
vl_total_item_nf_w		varchar(18);
vl_desc_item_nf_w		varchar(18);
vl_aliq_ir_w			varchar(18);
vl_base_ir_w			varchar(18);
vl_valor_ir_w			varchar(18);
vl_base_inss_w			varchar(18);
vl_valor_inss_w			varchar(18);
ie_situacao_cancelamento_w   varchar(18);
cd_estabelecimento_w		varchar(18);
contador_w			bigint;
ds_arquivo_ww			varchar(4000);

c01 CURSOR FOR 
SELECT	n.nr_sequencia													nr_sequencia, 
	rpad(n.cd_serie_nf,5,' ')											nr_serie_nf, 
	lpad(n.nr_nota_fiscal,6,' ')											nr_nota_fiscal, 
	lpad(substr(to_char(n.dt_emissao,'ddmmyyyy'),1,8),8,' ')							dt_emissao_documento, 
	LPAD(coalesce(SUBSTR(CASE WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='E' THEN  	coalesce(n.cd_cgc,obter_cpf_pessoa_fisica(n.cd_pessoa_fisica)) WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='S' THEN CASE WHEN coalesce(n.cd_cgc::text, '') = '' THEN obter_cpf_pessoa_fisica(n.cd_pessoa_fisica)  ELSE coalesce(n.cd_cgc,obter_cpf_pessoa_fisica(n.cd_pessoa_fisica)) END  END ,1,14),' '),14,' ') 	cd_participante, 
	lpad(coalesce(replace(replace(replace(to_char((SELECT sum(vl_total_item_nf) from nota_fiscal_item i where i.nr_sequencia = n.nr_sequencia),'999,999,999,990.00'),',',''),'.',''),' ',''),' '),17,' ')	vl_total_item_nf, 
	lpad(coalesce(to_char((select sum(vl_desconto) from nota_fiscal_item i where i.nr_sequencia = n.nr_sequencia)),' '),17,' ') 		vl_desc_item_nf, 
	lpad(coalesce(replace(replace(replace(to_char(coalesce(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'X', 'IR'),0),'999,999,999,990.00'),',',''),'.',''),' ',''),' '),5,' ')vl_aliq_ir, 
	lpad(coalesce(replace(replace(replace(to_char(coalesce(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'B', 'IR'),0),'999,999,999,990.00'),',',''),'.',''),' ',''),' '),17,' ')vl_base_ir, 
	lpad(coalesce(replace(replace(replace(to_char(coalesce(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'IR'),0),'999,999,999,990.00'),',',''),'.',''),' ',''),' '),17,' ')vl_valor_ir, 
	lpad(coalesce(replace(replace(replace(to_char(coalesce(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'B', 'INSS'),0),'999,999,999,990.00'),',',''),'.',''),' ',''),' '),17,' ')vl_base_inss, 
	lpad(coalesce(replace(replace(replace(to_char(coalesce(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'INSS'),0),'999,999,999,990.00'),',',''),'.',''),' ',''),' '),17,' ')vl_valor_inss, 
	lpad(CASE WHEN n.ie_situacao=1 THEN 'N' WHEN n.ie_situacao=2 THEN 'N' WHEN n.ie_situacao=3 THEN 'S' WHEN n.ie_situacao=9 THEN 'S' END ,1,' ')							ie_situacao_cancelamento, 
	n.cd_estabelecimento 												cd_estabelecimento 
FROM operacao_nota o, nota_fiscal n
LEFT OUTER JOIN nota_fiscal_transportadora t ON (n.nr_sequencia = t.nr_seq_nota)
WHERE o.cd_operacao_nf = n.cd_operacao_nf and o.ie_servico = 'S' and n.ie_tipo_nota in ('SD','SE','SF','ST') and n.cd_estabelecimento = cd_estabelecimento_p and n.dt_emissao between to_date(to_char(dt_inicio_p,'dd/mm/yyyy'),'dd/mm/yyyy') and fim_dia(to_date(to_char(dt_fim_p,'dd/mm/yyyy'),'dd/mm/yyyy')) order by n.nr_sequencia;

BEGIN
 
open c01;
loop 
fetch c01 into 
	nr_sequencia_w, 
	cd_serie_nf_w, 
	nr_nota_fiscal_w, 
	dt_emissao_documento_w, 
	cd_participante_w, 
	vl_total_item_nf_w, 
	vl_desc_item_nf_w, 
	vl_aliq_ir_w, 
	vl_base_ir_w, 
	vl_valor_ir_w, 
	vl_base_inss_w, 
	vl_valor_inss_w, 
	ie_situacao_cancelamento_w, 
	cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	begin 
 
	contador_w := contador_w + 1;
 
	ds_arquivo_ww	:=   	cd_serie_nf_w 			|| 
				nr_nota_fiscal_w		|| 	dt_emissao_documento_w		|| 
				cd_participante_w		|| 	vl_total_item_nf_w       || 
				vl_desc_item_nf_w 		|| 	vl_aliq_ir_w          || 
				vl_base_ir_w 			|| 	vl_valor_ir_w          || 
				vl_base_inss_w 			|| 	vl_valor_inss_w         || 
				ie_situacao_cancelamento_w;
 
insert into w_inss_direp_arquivo( nr_sequencia, 
				cd_estabelecimento, 
				dt_atualizacao, 
				nm_usuario, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				ds_arquivo_w) 
		values (nextval('w_inss_direp_arquivo_seq'), 
				cd_estabelecimento_w, 
				clock_timestamp(), 
				nm_usuario_p, 
				clock_timestamp(), 
				nm_usuario_p, 
				ds_arquivo_ww);
 
	if (mod(contador_w,100) = 0) then 
		commit;
	end if;
 
	end;
 
end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nota_fiscal_servico (cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, nm_usuario_p text) FROM PUBLIC;

