-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_d301_segmento_bnk ( nr_seq_dataset_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_iban_w		d301_segmento_bnk.ds_iban%type;
ds_bic_w		d301_segmento_bnk.ds_bic%type;
cd_estabelecimento_w	atendimento_paciente.cd_estabelecimento%type;


BEGIN

select	max(a.cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	conta_paciente a,
	d301_dataset_envio b
where	a.nr_interno_conta	= b.nr_interno_conta
and	b.nr_sequencia		= nr_seq_dataset_p;

if (cd_estabelecimento_w IS NOT NULL AND cd_estabelecimento_w::text <> '') then

	select	substr(max(ds_iban),1,22),
		max(ds_bic)
	into STRICT	ds_iban_w,
		ds_bic_w
	from	estabelecimento a,
		pessoa_juridica_conta b,
		banco c,
		banco_estabelecimento d
	where	a.cd_estabelecimento	= cd_estabelecimento_w
	and	a.cd_cgc		= b.cd_cgc
	and	b.ie_situacao		= 'A'
	and	c.cd_banco		= b.cd_banco
	and	c.ie_situacao		= 'A'
	and	c.cd_banco		= d.cd_banco
	and	b.cd_agencia_bancaria	= d.cd_agencia_bancaria
	and	b.nr_conta		= d.cd_conta
	and	d.cd_estabelecimento	= a.cd_estabelecimento;

	insert into D301_SEGMENTO_BNK(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_dataset,
		ds_iban,
		ds_bic)
	values (nextval('d301_segmento_bnk_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_dataset_p,
		ds_iban_w,
		ds_bic_w);

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_d301_segmento_bnk ( nr_seq_dataset_p bigint, nm_usuario_p text) FROM PUBLIC;

