-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_clinilab () AS $body$
DECLARE

 
nr_seq_lab_w		bigint;
nr_prescricao_w		bigint;
nr_seq_prescr_w		bigint;
ds_resultado_w		text;

nr_seq_prescr_old_w	bigint := 0;
qt_filhos_w		bigint;

ie_pos_ini_w		integer;
ie_pos_fim_w		integer;

ds_valores_w		varchar(255);
vl_resultado_w		double precision;
vl_minimo_w		double precision;
vl_maximo_w		double precision;

ie_sexo_w		varchar(1);
dt_nascimento_w		timestamp;

nr_seq_resultado_w	bigint;
nr_seq_exame_w		bigint;
nr_seq_material_w	bigint;
nr_sequencia_w		bigint;
ie_forma_resultado_w	varchar(2);

c01 CURSOR FOR 
	SELECT	nr_sequencia, 
		nr_prescricao, 
		nr_seq_prescricao, 
		ds_resultado 
	from	result_laboratorio c 
	where	ie_status_conversao = 0 
	and not exists (SELECT 1 from 
			exame_lab_resultado b, 
			exame_lab_result_item a 
			where a.nr_seq_resultado = b.nr_seq_resultado 
			and b.nr_prescricao = c.nr_prescricao 
			and a.nr_seq_prescr = c.nr_seq_prescricao 
			and (a.nr_seq_material IS NOT NULL AND a.nr_seq_material::text <> '')) 
	and dt_atualizacao > clock_timestamp() - interval '10 days'	 
	order by 2,3;


BEGIN 
 
open C01;
loop 
	fetch C01 into	nr_seq_lab_w, 
			nr_prescricao_w, 
			nr_seq_prescr_w, 
			ds_resultado_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
 
	ie_pos_ini_w	:= position('Calc(' in ds_resultado_w) + 5;
 
	select	nr_seq_exame 
	into STRICT	nr_seq_exame_w 
	from prescr_procedimento 
	where nr_prescricao	= nr_prescricao_w 
	 and nr_sequencia	= nr_seq_prescr_w;
 
	select count(*) 
	into STRICT qt_filhos_w 
	from exame_laboratorio 
	where nr_seq_superior = nr_seq_exame_w;
 
	if (ie_pos_ini_w > 5) and (qt_filhos_w = 0) then 
 
		ie_pos_fim_w	:= position(')' in ds_resultado_w);
		ds_valores_w	:= replace(substr(ds_resultado_w, ie_pos_ini_w, ie_pos_fim_w - ie_pos_ini_w),' ','');
 
		RAISE NOTICE '%', ds_valores_w;
		begin 
		vl_minimo_w	:= (replace(substr(ds_valores_w, 1, position(', 
' in ds_valores_w) - 1),'.',','))::numeric;
 
		exception 
			when others then 
				vl_minimo_w := 0;
		end;
		ds_valores_w	:= substr(ds_valores_w, position(',' in ds_valores_w) + 1, 255);
		begin 
		vl_maximo_w	:= (replace(substr(ds_valores_w, 1, position(', 
' in ds_valores_w) - 1),'.',','))::numeric;
 
		exception 
			when others then 
				vl_maximo_w := 0;
		end;
		begin 
		vl_resultado_w	:= (replace(substr(ds_valores_w,position(',' 
 in ds_valores_w) + 1,255),'.',','))::numeric;
 
		exception 
			when others then 
				vl_resultado_w := 0;
		end;
 
		if (nr_seq_prescr_old_w <> nr_prescricao_w) then 
			nr_seq_prescr_old_w := nr_prescricao_w;
			select	coalesce(b.ie_sexo,'0'), 
				b.dt_nascimento 
			into STRICT	ie_sexo_w, 
				dt_nascimento_w 
			from	atendimento_paciente_v b, 
				prescr_medica a 
			where a.nr_atendimento = b.nr_atendimento 
			 and a.nr_prescricao = nr_prescricao_w;
 
			CALL gera_exame_result_lab(nr_prescricao_w, nr_seq_prescr_w, 'N', 'N', 'N', 'Clini 
Lab');
 
 
			select coalesce(max(nr_seq_resultado),0) 
			into STRICT nr_seq_resultado_w 
			from exame_lab_resultado 
			where nr_prescricao = nr_prescricao_w;
		end if;
 
		if (nr_seq_resultado_w > 0) then 
 
			select	coalesce(max(nr_sequencia),0), 
				coalesce(max(nr_seq_exame),0), 
				coalesce(max(nr_seq_material),0) 
			into STRICT	nr_sequencia_w, 
				nr_seq_exame_w, 
				nr_seq_material_w 
			from exame_lab_result_item 
            where nr_seq_resultado	= nr_seq_resultado_w 
             and nr_seq_prescr	= nr_seq_prescr_w 
             and (nr_seq_material IS NOT NULL AND nr_seq_material::text <> '');
 
 
			if (nr_sequencia_w <> 0) then 
				begin 
				CALL gera_resultado_lab(	nr_seq_resultado_w, nr_prescricao_w, 
							nr_seq_prescr_w, nr_seq_exame_w, 
							nr_seq_material_w, (clock_timestamp() - dt_nascimento_w) / 365.25, 
							ie_sexo_w, 'CliniLab');
				exception 
					when others then 
						nr_sequencia_w := nr_sequencia_w;
				end;
 
				if (nr_sequencia_w <> 0) then 
					select	coalesce(max(nr_sequencia), nr_sequencia_w), 
						coalesce(max(obter_formato_result_exame(nr_seq_exame, nr_seq_material)),'V') 
					into STRICT	nr_sequencia_w, 
						ie_forma_resultado_w 
					from exame_lab_result_item 
					where nr_seq_resultado	= nr_seq_resultado_w 
					 and nr_seq_prescr	= nr_seq_prescr_w 
					 and coalesce(nr_seq_material::text, '') = '';
 
					if (position('V' in ie_forma_resultado_w) > 0) then 
						update exame_lab_result_item 
						set	qt_resultado	= vl_resultado_w, 
							qt_maxima	= vl_maximo_w, 
							qt_minima	= vl_minimo_w 
						where nr_seq_resultado	= nr_seq_resultado_w 
						 and nr_sequencia	= nr_sequencia_w;
					else 
						update exame_lab_result_item 
						set	pr_resultado	= vl_resultado_w, 
							pr_maximo	= vl_maximo_w, 
							pr_minimo	= vl_minimo_w 
						where nr_seq_resultado	= nr_seq_resultado_w 
						 and nr_sequencia	= nr_sequencia_w;
					end if;
				end if;
			end if;
			update result_laboratorio 
			set ie_status_conversao = 1 
			where nr_sequencia = nr_seq_lab_w;
 
			commit;
		end if;
	else 
		update result_laboratorio 
		set ie_status_conversao = 1 
		where nr_sequencia = nr_seq_lab_w;
 
		commit;
	end if;
end loop;
close C01;
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_clinilab () FROM PUBLIC;

