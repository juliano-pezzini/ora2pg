-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_comunic_etapa_conta ( dt_parametro_p timestamp, nm_usuario_p text) AS $body$
DECLARE

 
										 
nr_seq_etapa_w		bigint;			
ds_etapa_w		varchar(80);
ds_titulo_w		varchar(255);
ds_comunicado_w		text;

nr_atendimento_w		bigint;
nr_interno_conta_w		bigint;
nm_paciente_w		varchar(255);
quebra_w			varchar(10) := chr(13)||chr(10);		
QT_HORAS_w		smallint;								
cd_perfil_w		bigint;
ds_perfil_w		varchar(4000);				
C01 CURSOR FOR 
	SELECT	a.nr_sequencia, 
			a.ds_etapa, 
			QT_HORAS 
	from	fatur_etapa a 
	where	a.ie_situacao = 'A' 
	and		coalesce(QT_HORAS,0)	> 0 
	order by 2;
	
 
	 
c02 CURSOR FOR 
	SELECT	b.nr_interno_conta, 
		substr(obter_pessoa_atendimento(a.nr_atendimento,'N') ,1,255) nm_paciente, 
		a.nr_atendimento 
	from	conta_paciente a, 
		conta_paciente_etapa b 
	where	a.nr_interno_conta		= b.nr_interno_conta 
	and	b.nr_seq_etapa			= nr_seq_etapa_w 
	and	dividir(Man_Obter_Min_Com(a.cd_estabelecimento,dt_etapa,dt_parametro_p),60)	>= QT_HORAS_w 
	and	coalesce(b.dt_fim_etapa::text, '') = '' 
	order by nm_paciente;
			
			 
	 
c03 CURSOR FOR 
		SELECT	cd_perfil 
		from	fatur_etapa_comunic 
		where	nr_seq_etapa	= nr_seq_etapa_w;
	
c01_w 	c01%rowtype;

BEGIN
open C01;
loop 
fetch C01 into	 
	nr_seq_etapa_w, 
	ds_etapa_w, 
	QT_HORAS_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	ds_comunicado_w	:= null;
	ds_perfil_w		:= null;
	open C02;
	loop 
	fetch C02 into	 
		nr_interno_conta_w, 
		nm_paciente_w, 
		nr_atendimento_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		ds_comunicado_w	:= substr(ds_comunicado_w || Wheb_mensagem_pck.get_Texto(298799) ||nr_atendimento_w || Wheb_mensagem_pck.get_Texto(298800) || nr_interno_conta_w|| Wheb_mensagem_pck.get_Texto(298801) ||nm_paciente_w||quebra_w,1,4000);
		end;
	end loop;
	close C02;
	 
	if (ds_comunicado_w IS NOT NULL AND ds_comunicado_w::text <> '') then 
		ds_titulo_w	:= Wheb_mensagem_pck.get_Texto(298802) ||ds_etapa_w;
	 
		open C03;
		loop 
		fetch C03 into	 
			cd_perfil_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin 
			ds_perfil_w	:= ds_perfil_w||','||cd_perfil_w;
			end;
		end loop;
		close C03;
		 
		if (ds_perfil_w IS NOT NULL AND ds_perfil_w::text <> '') then 
			INSERT INTO comunic_interna(  
				dt_comunicado, 
				ds_titulo, 
				ds_comunicado, 
				nm_usuario, 
				dt_atualizacao, 
				ie_geral, 
				nm_usuario_destino, 
				nr_sequencia, 
				ie_gerencial, 
				nr_seq_classif, 
				ds_perfil_adicional, 
				cd_setor_destino, 
				cd_estab_destino, 
				ds_setor_adicional, 
				dt_liberacao) 
			VALUES (clock_timestamp(), 
				ds_titulo_w, 
				ds_comunicado_w, 
				nm_usuario_p, 
				clock_timestamp(), 
				'N', 
				null, 
				nextval('comunic_interna_seq'), 
				'N', 
				7, 
				ds_perfil_w, 
				null, 
				null, 
				null, 
				clock_timestamp());
				 
		end if;
	end if;
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_comunic_etapa_conta ( dt_parametro_p timestamp, nm_usuario_p text) FROM PUBLIC;

