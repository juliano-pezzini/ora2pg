-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_proc_pac_ajuste (nr_atendimento_p bigint, nr_interno_conta_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, dt_procedimento_p timestamp, cd_convenio_p bigint, cd_categoria_p text, nr_seq_atepacu_p bigint, nm_usuario_p text, qt_procedimento_p bigint, ie_valor_informado_p text, nr_seq_motivo_p bigint, cd_estabelecimento_p bigint, nr_sequencia_p INOUT bigint, cd_cgc_prestador_p text, cd_medico_executor_p text, nr_seq_proc_interno_p bigint, nr_seq_exame_p bigint, ie_funcao_medico_p text, ie_agrupado_p text, nr_seq_auditoria_p bigint default null) AS $body$
DECLARE

 
nr_sequencia_w     	bigint;
cd_setor_atendimento_w 	integer;
dt_entrada_unidade_w  	timestamp;
cd_unidade_medida_w   	varchar(30);
nr_interno_conta_w		bigint;
nr_seq_proc_interno_w		bigint;
nr_seq_exame_w			bigint;
cd_especialidade_w		procedimento_paciente.cd_especialidade%type;
ie_funcao_medico_w 		procedimento_paciente.ie_funcao_medico%type;
ie_tipo_atendimento_w		atendimento_paciente.ie_tipo_atendimento%type;
ie_clinica_w			atendimento_paciente.ie_clinica%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
cd_estab_logado_w		estabelecimento.cd_estabelecimento%type;
ie_estabelecimento_conta_w	parametro_faturamento.ie_estabelecimento_conta%type;
ie_calcular_mat_auditado_w	parametro_faturamento.ie_calcular_mat_auditado%type;
ie_auditoria_w			material_atend_paciente.ie_auditoria%type;


BEGIN 
 
select cd_setor_Atendimento, 
    dt_entrada_unidade 
into STRICT  cd_setor_atendimento_w, 
    dt_entrada_unidade_w 
from  atend_paciente_unidade 
where  nr_seq_interno = nr_seq_atepacu_p;
 
select	ie_tipo_atendimento, 
	ie_clinica, 
	cd_estabelecimento 
into STRICT	ie_tipo_atendimento_w, 
	ie_clinica_w, 
	cd_estabelecimento_w 
from	atendimento_paciente 
where 	nr_atendimento = nr_atendimento_p;
 
-- Obter a máxima sequencia da procedimento_paciente 
select		nextval('procedimento_paciente_seq') 
into STRICT		nr_sequencia_w
;
 
if (coalesce(nr_seq_proc_interno_p,0) = 0) then 
	nr_seq_proc_interno_w	:= null;
else 
	nr_seq_proc_interno_w	:= nr_seq_proc_interno_p;
end if;
 
if (coalesce(nr_seq_exame_p,0) = 0) then 
	nr_seq_exame_w	:= null;
else 
	nr_seq_exame_w	:= nr_seq_exame_p;
end if;
 
SELECT * FROM OBTER_PROCED_ESPEC_MEDICA(cd_estabelecimento_p, cd_convenio_p, cd_procedimento_p, ie_origem_proced_p, null, null, null, ie_clinica_w, cd_setor_atendimento_w, cd_especialidade_w, ie_funcao_medico_w, cd_medico_executor_p, nr_seq_proc_interno_p, ie_tipo_atendimento_w) INTO STRICT cd_especialidade_w, ie_funcao_medico_w;
		 
select	max(wheb_usuario_pck.get_cd_estabelecimento) 
into STRICT	cd_estab_logado_w
;
 
select	coalesce(max(ie_estabelecimento_conta), 'A') 
into STRICT	ie_estabelecimento_conta_w 
from	parametro_faturamento 
where	cd_estabelecimento = cd_estab_logado_w;
 
if (ie_estabelecimento_conta_w = 'L') then 
	cd_estabelecimento_w := cd_estab_logado_w;
end if;
 
select	coalesce(max(ie_calcular_mat_auditado),'S') 
into STRICT	ie_calcular_mat_auditado_w 
from	parametro_faturamento 
where	cd_estabelecimento = cd_estabelecimento_w;
 
ie_auditoria_w	:= 'S';
 
if (coalesce(ie_calcular_mat_auditado_w,'S') = 'N') then 
	ie_auditoria_w	:= 'N';
end if;
			 
-- inserir na tabela procedimento_paciente 
insert into procedimento_paciente( 
			nr_sequencia, 
			nr_atendimento,	 
			nr_interno_conta, 
			dt_entrada_unidade,		 
			cd_procedimento, 
			dt_procedimento, 
			cd_convenio, 
			cd_categoria, 
			nr_doc_convenio, 
			ie_tipo_guia, 
			cd_senha, 
			ie_auditoria, 
			ie_emite_conta, 
			cd_cgc_prestador, 
			ie_origem_proced, 
			nr_seq_exame, 
			nr_seq_proc_interno, 
			qt_procedimento, 
			cd_setor_atendimento, 
			nr_seq_atepacu, 
			nr_seq_cor_exec, 
			ie_funcao_medico, 
			ie_proc_princ_atend, 
			ie_video, 
			tx_medico, 
			tx_Anestesia, 
			tx_procedimento, 
			ie_valor_informado, 
			ie_guia_informada, 
			cd_situacao_glosa, 
			nm_usuario_original, 
			ds_observacao, 
			dt_atualizacao, 
			nm_usuario, 
			cd_pessoa_fisica, 
			cd_medico_executor, 
			cd_especialidade) 
		values ( 
			nr_sequencia_w, 
			nr_atendimento_p, 
			nr_interno_conta_p, 
			dt_entrada_unidade_w, 
			cd_procedimento_p, 
			coalesce(dt_procedimento_p,clock_timestamp()), 
			cd_convenio_p, 
			cd_categoria_p, 
			null, 
			null, 
			null, 
			ie_auditoria_w, -- Se o parâmetro ie_calcular_proc_auditado_w estiver para 'N', insere primeiramente como Não auditado, para atualizar os valores., 
			null, 
			cd_cgc_prestador_p, 
			ie_origem_proced_p, 
			nr_seq_exame_w, 
			nr_seq_proc_interno_w,				 
			qt_procedimento_p, 
			cd_setor_atendimento_w, 
			nr_seq_atepacu_p, 
			null, 
			coalesce(ie_funcao_medico_p, ie_funcao_medico_w), 
			'N', 
			'N', 
			100, 
			100, 
			100, 
			'N', 
			'N', 
			0, 
			nm_usuario_p, 
			null, 
			clock_timestamp(), 
			nm_usuario_p, 
			null, 
			cd_medico_executor_p, 
			cd_especialidade_w);
 
CALL atualiza_preco_procedimento(nr_sequencia_w, cd_convenio_p, nm_usuario_p);
 
if (ie_auditoria_w	= 'N') then 
	update	procedimento_paciente 
	set	ie_auditoria = 'S' 
	where	nr_sequencia = nr_sequencia_w;
end if;
	 
CALL Atualizar_Lista_Itens_Audit(nr_interno_conta_w, nr_sequencia_w, 2, qt_procedimento_p, nm_usuario_p,nr_seq_motivo_p, nr_seq_auditoria_p, ie_agrupado_p);
nr_sequencia_p := nr_sequencia_w;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_proc_pac_ajuste (nr_atendimento_p bigint, nr_interno_conta_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, dt_procedimento_p timestamp, cd_convenio_p bigint, cd_categoria_p text, nr_seq_atepacu_p bigint, nm_usuario_p text, qt_procedimento_p bigint, ie_valor_informado_p text, nr_seq_motivo_p bigint, cd_estabelecimento_p bigint, nr_sequencia_p INOUT bigint, cd_cgc_prestador_p text, cd_medico_executor_p text, nr_seq_proc_interno_p bigint, nr_seq_exame_p bigint, ie_funcao_medico_p text, ie_agrupado_p text, nr_seq_auditoria_p bigint default null) FROM PUBLIC;

