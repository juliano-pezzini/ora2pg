-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE colunas AS (nm_coluna_w varchar(255));


CREATE OR REPLACE PROCEDURE gerar_horarios_adep (cd_estabelecimento_p bigint, cd_perfil_p bigint, cd_setor_usuario_p bigint, nr_atendimento_p bigint, nr_seq_dialise_p bigint, qt_hora_anterior_p bigint, qt_hora_adicional_p bigint, qt_hora_prescricao_p bigint, ie_horario_realizado_p text, ie_horario_suspenso_p text, ie_proc_setor_user_p text, ie_interv_setor_user_p text, dt_prescricao_p timestamp, ie_sol_continuas_p text, nm_usuario_p text) AS $body$
DECLARE


/* vetor */

type vetor is table of colunas index by integer;

/* globais */

vetor_w				vetor;
ivet				integer;
ind					integer;
nr_seq_adep_w		bigint;
ds_update_w			varchar(1000);
nr_seq_lab_w		varchar(20);
dt_inicial_w		timestamp;
dt_final_w			timestamp;
cd_setor_atend_w	integer;

/* itens */

dt_order_by_w			timestamp;
ds_horario_w			varchar(19);
ie_exibe_suspenso_w		varchar(3);
ie_tipo_item_w			varchar(3);
ie_acm_sn_w				varchar(1);
ie_suspenso_w			varchar(1);
ie_status_item_w		varchar(15);
ie_exibir_ordem_w		varchar(2);
nr_prescricao_w			bigint;
nr_seq_item_w			bigint;
cd_item_w				varchar(255);
ds_item_w				varchar(240);
cd_intervalo_w			varchar(7);
qt_item_w				double precision;
ds_prescricao_w			varchar(240);
ds_diluicao_w			varchar(2000);
nr_dia_util_w			bigint;
ie_diferenciado_w		varchar(1);
ie_classif_adep_w		varchar(15);
nr_seq_proc_interno_w	bigint;

/* horários */

nr_seq_hor_w		bigint;
ie_status_w			varchar(1);
ds_sep_bv_w			varchar(10);
/* evento */

ds_param_proc_w		varchar(2000);

ie_data_proc_w		varchar(15);
ie_agrupar_acm_sn_w	varchar(15);
ie_agrupar_de_w		varchar(15);
ie_verifica_dif_w	varchar(2);

dt_validade_w				timestamp;
ie_exibe_dose_glicemia_w	varchar(2);

ie_data_lib_prescr_w	varchar(15);
ie_exibe_diluicao_w		varchar(1);

dt_prev_prox_etapa_w		timestamp;
nr_seq_proc_w				varchar(1);
ie_agrupa_proc_w			varchar(1);
ie_dieta_sem_horario_w		varchar(1);
ie_pendente_liberacao_w		varchar(2);
ie_exibir_col_pend_w		varchar(1);
ie_medic_controlado_w		varchar(1);
nr_agrupamento_w			double precision;
dt_suspensao_w				timestamp;
ie_adm_associados_proc_w 	varchar(1);
qt_dose_w					double precision;
ie_apelido_exame_w			varchar(1);
cd_setor_pac_w				integer;

/* obter horários itens */

c01 CURSOR FOR
SELECT	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario, /* dieta oral */
	c.dt_horario dt_order_by
from	prescr_dieta_hor c,
	prescr_medica a
where	c.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	c.dt_horario between dt_inicial_w and dt_final_w
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	ie_proc_setor_user_p = 'N'
and	adep_obter_regra_inclusao(	'DO',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								null,
								null,
								null,
								null,
								a.cd_setor_atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	ie_dieta_sem_horario_w = 'S'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
group by
	c.dt_horario

union

select	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario, /* suplemento oral */
	c.dt_horario dt_order_by
from	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	b.ie_agrupador in (12)
and	coalesce(c.ie_situacao,'A') = 'A'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	c.dt_horario between dt_inicial_w and dt_final_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	ie_proc_setor_user_p = 'N'
and	adep_obter_regra_inclusao(	'SO',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								b.cd_material,
								null,
								null,
								null,
								a.cd_setor_atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
group by
	c.dt_horario

union

select	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario, /* medicamentos */
	c.dt_horario dt_order_by
from	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
and	obter_se_prescr_lib_adep(coalesce(a.dt_liberacao_medico, b.dt_lib_material), coalesce(a.dt_liberacao,b.dt_lib_material), coalesce(a.dt_liberacao_farmacia, b.dt_lib_farmacia), ie_data_lib_prescr_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	b.ie_agrupador in (1)
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_adep,'S') = 'S'
and	a.nr_atendimento = nr_atendimento_p
--and	a.dt_liberacao is not null
and	a.dt_validade_prescr > dt_validade_w
and	c.dt_horario between dt_inicial_w and dt_final_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	ie_proc_setor_user_p = 'N'
and	adep_obter_regra_inclusao(	'MED',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								b.cd_material,
								null,
								null,
								null,
								a.cd_setor_atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
group by
	c.dt_horario

union

select	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario, /* medicamentos  - diálise */
	c.dt_horario dt_order_by
from	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	b.ie_agrupador in (14)
and	c.nr_seq_dialise = nr_seq_dialise_p
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_adep,'S') = 'S'
and	a.nr_atendimento = nr_atendimento_p
--and	a.dt_validade_prescr > sysdate - qt_hora_prescricao_p/24
and	c.dt_horario between dt_inicial_w and dt_final_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	ie_proc_setor_user_p = 'N'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
group by
	c.dt_horario

union

select	to_char(b.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario, /* Ordem médica */
	b.dt_horario dt_order_by
from	prescr_medica_ordem a,
	prescr_ordem_hor b
where	a.nr_atendimento = nr_atendimento_p
and	b.nr_seq_ordem	= a.nr_sequencia
and	(((ie_horario_realizado_p = 'N') and (coalesce(a.dt_realizacao::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	ie_exibir_ordem_w	= 'G'
group by b.dt_horario

union

select	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario, /* materiais */
	c.dt_horario dt_order_by
from	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	b.ie_agrupador in (2)
--and	obter_se_material_adep(a.cd_estabelecimento,b.cd_material) = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_adep,'S') = 'S'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	c.dt_horario between dt_inicial_w and dt_final_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	ie_proc_setor_user_p = 'N'
and	adep_obter_regra_inclusao(	'MAT',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								b.cd_material,
								null,
								null,
								null,
								a.cd_setor_atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
group by
	c.dt_horario

union

select	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario, /* procedimentos */
	c.dt_horario dt_order_by
from	prescr_proc_hor c,
	prescr_procedimento b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_procedimento = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
and	(obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '')
and	obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	coalesce(b.nr_seq_solic_sangue::text, '') = ''
and	coalesce(b.nr_seq_derivado::text, '') = ''
and	coalesce(c.ie_situacao,'A') = 'A'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	c.dt_horario between dt_inicial_w and dt_final_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	((ie_proc_setor_user_p = 'N') or (adep_obter_se_setor_proc_user(nm_usuario_p,b.cd_setor_atendimento) = 'S'))
and	((adep_obter_regra_inclusao(	'PROC',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									b.cd_procedimento,
									b.ie_origem_proced,
									b.nr_seq_proc_interno,
									a.cd_setor_atendimento,
									b.cd_setor_atendimento,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									b.nr_seq_exame) = 'S') or  -- nr_seq_exame_p
	 (adep_obter_regra_inclusao(	'LAB',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									b.cd_procedimento,
									b.ie_origem_proced,
									b.nr_seq_proc_interno,
									a.cd_setor_atendimento,
									b.cd_setor_atendimento,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									b.nr_seq_exame) = 'S') or  -- nr_seq_exame_p
	 (adep_obter_regra_inclusao(	'CCG',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									b.cd_procedimento,
									b.ie_origem_proced,
									b.nr_seq_proc_interno,
									a.cd_setor_atendimento,
									b.cd_setor_atendimento,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									b.nr_seq_exame) = 'S') or  -- nr_seq_exame_p
	 (adep_obter_regra_inclusao(	'CIG',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									b.cd_procedimento,
									b.ie_origem_proced,
									b.nr_seq_proc_interno,
									a.cd_setor_atendimento,
									b.cd_setor_atendimento,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									b.nr_seq_exame) = 'S')) -- nr_seq_exame_p
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
group by
	c.dt_horario

union

select	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario, /* recomendacoes */
	c.dt_horario dt_order_by
from	prescr_rec_hor c,
	prescr_recomendacao b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_recomendacao = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	((ie_data_lib_prescr_w = 'F') or (obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'))
and	coalesce(a.ie_adep,'S') = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	c.dt_horario between dt_inicial_w and dt_final_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	ie_proc_setor_user_p = 'N'
and	adep_obter_regra_inclusao(	'REC',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								null,
								null,
								null,
								null,
								a.cd_setor_atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
group by
	c.dt_horario

union

select	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario, /* sae */
	c.dt_horario dt_order_by
from	pe_prescr_proc_hor c,
	pe_prescr_proc b,
	pe_prescricao a
where	c.nr_seq_pe_proc = b.nr_sequencia
and	b.nr_seq_prescr = a.nr_sequencia
and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and	coalesce(b.ie_adep,'N') in ('S','M')
and	coalesce(b.dt_suspensao::text, '') = ''
and	coalesce(c.ie_situacao,'A') = 'A'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	c.dt_horario between dt_inicial_w and dt_final_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
--and	ie_proc_setor_user_p = 'N'
and	obter_se_exibir_interv_adep(ie_proc_setor_user_p,ie_interv_setor_user_p,b.nr_seq_proc,cd_perfil_p,cd_setor_atend_w,nm_usuario_p) = 'S'
and	adep_obter_regra_inclusao(	'SAE',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								null,
								null,
								null,
								null,
								null,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
group by
	c.dt_horario

union

select	to_char(b.dt_status,'dd/mm/yyyy hh24:mi:ss') ds_horario, /* solução */
	b.dt_status dt_order_by
from	prescr_solucao b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
and	coalesce(b.nr_seq_dialise::text, '') = ''
and	b.ie_status = 'N'
--and	a.dt_liberacao is not null
and	obter_se_prescr_lib_adep(coalesce(a.dt_liberacao_medico, b.dt_lib_material), coalesce(a.dt_liberacao, b.dt_lib_material), coalesce(a.dt_liberacao_farmacia, b.dt_lib_farmacia), ie_data_lib_prescr_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	a.nr_atendimento = nr_atendimento_p
--and	((b.dt_status between dt_inicial_w and dt_final_w) or (b.ie_status = 'I' and b.dt_status <= dt_final_w))
and	((b.dt_status between dt_inicial_w and dt_final_w) or (b.ie_status in ('I','INT')))
and	((ie_horario_realizado_p = 'N' AND b.ie_status <> 'T') or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(b.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	ie_proc_setor_user_p = 'N'
and	adep_obter_regra_inclusao(	'SOL',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								null,
								null,
								null,
								null,
								a.cd_setor_atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	((ie_sol_continuas_p = 'S') or
	((ie_sol_continuas_p = 'N') and (Obter_Se_Sol_Continua(a.nr_prescricao, b.nr_seq_solucao, b.ds_solucao) = 'N')))
group by
	b.dt_status

union

select	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario, /*Itens  associados ao procedimento*/
	c.dt_horario dt_order_by
from	prescr_procedimento d,
	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	d.nr_prescricao = b.nr_prescricao
and	b.nr_sequencia_proc = d.nr_sequencia
and	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	b.ie_agrupador in (5)
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_adep,'S') = 'S'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	c.dt_horario between dt_inicial_w and dt_final_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	ie_proc_setor_user_p = 'N'
and	obter_se_ctrl_glic_proc(d.nr_seq_proc_interno) = 'N'
and	((coalesce(b.ie_checar_adep,'N') = 'S') or (ie_adm_associados_proc_w = 'S'))
and	adep_obter_regra_inclusao(	'M',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								b.cd_material,
								null,
								null,
								null,
								a.cd_setor_atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
group by
	c.dt_horario

union

select	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario, /*Hemoterapia */
	c.dt_horario dt_order_by
from	prescr_proc_hor c,
	prescr_procedimento b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_procedimento = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
and	(obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '')
and	obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	(b.nr_seq_solic_sangue IS NOT NULL AND b.nr_seq_solic_sangue::text <> '')
and	(b.nr_seq_derivado IS NOT NULL AND b.nr_seq_derivado::text <> '')
and	coalesce(c.ie_situacao,'A') = 'A'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	c.dt_horario between dt_inicial_w and dt_final_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	((ie_proc_setor_user_p = 'N') or (adep_obter_se_setor_proc_user(nm_usuario_p,b.cd_setor_atendimento) = 'S'))
and	adep_obter_regra_inclusao(	'HM',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								null,
								null,
								null,
								null,
								a.cd_setor_atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								b.nr_seq_exame) = 'S' -- nr_seq_exame_p
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	to_char(b.dt_inicio,'dd/mm/yyyy hh24:mi:ss') ds_horario, /*Jejum horário inicio */
	b.dt_inicio dt_order_by
from	rep_jejum b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	b.dt_inicio between dt_inicial_w and dt_final_w
and	((ie_horario_suspenso_p = 'N' AND b.ie_suspenso = 'N') or (ie_horario_suspenso_p = 'S'))
and	adep_obter_regra_inclusao(	'DO',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								null,
								null,
								null,
								null,
								a.cd_setor_atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	ie_proc_setor_user_p = 'N'

union

select	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario, --Suporte nutricional enterall
	c.dt_horario dt_order_by
from	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	b.ie_agrupador in (8)
and	coalesce(c.ie_situacao,'A') = 'A'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	c.dt_horario between dt_inicial_w and dt_final_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	((ie_horario_realizado_p = 'N' AND b.ie_status <> 'T') or (ie_horario_realizado_p = 'S'))
and	((ie_horario_suspenso_p = 'N' AND b.ie_status <> 'S') or (ie_horario_suspenso_p = 'S'))
and	ie_proc_setor_user_p = 'N'
and	adep_obter_regra_inclusao(	'SNE',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								b.cd_material,
								null,
								null,
								null,
								a.cd_setor_atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
group by
	c.dt_horario
order by
	2;

/* obter itens */

c02 CURSOR FOR
SELECT	ie_tipo_item,
	CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_item,ie_agrupar_acm_sn_w)='N' THEN  nr_prescricao  ELSE null END   ELSE CASE WHEN ie_pendente_liberacao='' THEN  CASE WHEN ie_tipo_item='HM' THEN nr_prescricao  ELSE CASE WHEN ie_tipo_item='G' THEN  nr_prescricao  ELSE CASE WHEN ie_tipo_item='SNE' THEN  nr_prescricao  ELSE null END  END  END   ELSE nr_prescricao END  END  nr_prescricao,
		CASE WHEN ie_agrupa_proc_w='S' THEN  CASE WHEN ie_tipo_item='SNE' THEN  nr_seq_item  ELSE CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_item,ie_agrupar_acm_sn_w)='N' THEN  nr_seq_item  ELSE null END   ELSE null END  END   ELSE CASE WHEN ie_tipo_item='P' THEN  nr_seq_proc  ELSE CASE WHEN ie_tipo_item='HM' THEN  nr_seq_item  ELSE CASE WHEN ie_tipo_item='SNE' THEN  nr_seq_item  ELSE CASE WHEN ie_pendente_liberacao='' THEN  CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_item,ie_agrupar_acm_sn_w)='N' THEN  nr_seq_item  ELSE null END   ELSE null END   ELSE nr_seq_item END  END  END  END  END  nr_seq_item,
	CASE WHEN ie_tipo_item='O' THEN ie_suspenso  ELSE CASE WHEN ie_tipo_item='SNE' THEN  substr(obter_status_solucao_prescr(2, nr_prescricao, nr_seq_item),1,3)  ELSE CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_item,ie_agrupar_acm_sn_w)='N' THEN  CASE WHEN ie_suspenso='S' THEN 'S'  ELSE null END   ELSE null END   ELSE null END  END  END  ie_status_item,
	ie_acm_sn,
	cd_item,
	ds_item,
	cd_intervalo,
	qt_item,
	ds_prescricao,
	CASE WHEN ie_exibe_diluicao_w='S' THEN  CASE WHEN ie_tipo_item='M' THEN  CASE WHEN ie_acm_sn='S' THEN  substr(adep_obter_inf_dil_obs(nr_prescricao,nr_seq_item),1,2000)  ELSE null END  WHEN ie_tipo_item='O' THEN  ds_informacao WHEN ie_tipo_item='D' THEN  obter_inf_dieta_adep(nr_prescricao,null,'DI')  ELSE null END   ELSE null END  ds_diluicao,
	ie_classif_adep,
	nr_seq_proc_interno,
	null,
	ie_pendente_liberacao,
	nr_agrupamento,
	nr_seq_lab
from	(
	SELECT	'D' ie_tipo_item,
		a.nr_prescricao nr_prescricao,
		null nr_seq_item,
		'N' ie_acm_sn,
		c.cd_refeicao cd_item,
		substr(obter_valor_dominio(99,c.cd_refeicao),1,240) ds_item,
		null cd_intervalo,
		null qt_item,
		null ds_prescricao,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		'' ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	prescr_dieta d,
		prescr_dieta_hor c,
		prescr_medica a
	where	c.nr_prescricao = a.nr_prescricao
	--and	a.dt_liberacao is not null
	and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	coalesce(c.ie_situacao,'A') = 'A'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	c.dt_horario between dt_inicial_w and dt_final_w
	and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	ie_proc_setor_user_p = 'N'
	and	adep_obter_regra_inclusao(	'DO',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									null,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									null) = 'S' -- nr_seq_exame_p
	and	a.nr_prescricao = d.nr_prescricao
	and	ie_dieta_sem_horario_w = 'S'
	and	((ie_exibir_col_pend_w = 'N') or (	select	coalesce(max('S'),'N')
			from	prescr_dieta_hor
			where	nr_prescricao = a.nr_prescricao
			and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S') = 'S')
	and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
	group by
		'D',
		a.nr_prescricao,
		null,
		'N',
		c.cd_refeicao,
		0,
		''
	
union

	select	'D' ie_tipo_item, /* dieta oral  pendente farmacia ou enfermagem*/
		a.nr_prescricao nr_prescricao,
		null nr_seq_item,
		'N' ie_acm_sn,
		to_char(d.cd_dieta) cd_item,
		obter_dados_dieta(d.cd_dieta, 'N',null,null,null,null) ds_item,
		null cd_intervalo,
		null qt_item,
		null ds_prescricao,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'E'  ELSE CASE WHEN coalesce(a.dt_liberacao_farmacia::text, '') = '' THEN  'F'  ELSE '' END  END  ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	prescr_dieta d,
		prescr_medica a
	where	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	ie_proc_setor_user_p = 'N'
	and	adep_obter_regra_inclusao(	'DO',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									null,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									null) = 'S' -- nr_seq_exame_p
	and	a.nr_prescricao = d.nr_prescricao
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(d.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	ie_exibir_col_pend_w = 'S'
	and	((	select	coalesce(max('S'),'N')
			from	prescr_dieta_hor
			where	nr_prescricao = a.nr_prescricao
			and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S') = 'N')
	group by
		'D',
		a.nr_prescricao,
		CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'E'  ELSE CASE WHEN coalesce(a.dt_liberacao_farmacia::text, '') = '' THEN  'F'  ELSE '' END  END ,
		null,
		'N',
		d.cd_dieta,
		0,
		''
	
union

	select	'J' ie_tipo_item, /* dieta oral - JEJUM */
		a.nr_prescricao nr_prescricao,
		null nr_seq_item,
		'N' ie_acm_sn,
		--to_char(b.nr_sequencia) cd_item,
		to_char(b.dt_inicio,'dd/mm/yyyy hh24:mi:ss')||'-'||to_char(b.dt_fim,'dd/mm/yyyy hh24:mi:ss') cd_item,
		substr(obter_desc_tipo_jejum(nr_seq_tipo),1,80) ds_item,
		null cd_intervalo,
		null qt_item,
		(obter_desc_expressao(301700)%ORA2PG_COMMENT465118(|': '|| to_char(b.dt_inicio,'dd/mm/yyyy hh24:mi:ss') || ' até ' || to_char(b.dt_fim,'dd/mm/yyyy hh24:mi:ss')) ds_prescricao,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		'' ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	rep_jejum b,
		prescr_medica a
	where	b.nr_prescricao = a.nr_prescricao
	and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	b.dt_inicio between dt_inicial_w and dt_final_w
	and	((ie_horario_suspenso_p = 'N' AND b.ie_suspenso = 'N') or (ie_horario_suspenso_p = 'S'))
	and	adep_obter_regra_inclusao(	'DO',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									null,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									null) = 'S' -- nr_seq_exame_p
	and	ie_proc_setor_user_p = 'N'
	group by 'J',
		a.nr_prescricao,
		substr(obter_desc_tipo_jejum(nr_seq_tipo),1,80),
		(obter_desc_expressao(301700)%ORA2PG_COMMENT465119(|': '|| to_char(b.dt_inicio,'dd/mm/yyyy hh24:mi:ss') || ' até ' || to_char(b.dt_fim,'dd/mm/yyyy hh24:mi:ss')),
		'N',
		--to_char(b.nr_sequencia),
		to_char(b.dt_inicio,'dd/mm/yyyy hh24:mi:ss')||'-'||to_char(b.dt_fim,'dd/mm/yyyy hh24:mi:ss'),
		0,
		''
	
union

	select	'D' ie_tipo_item, /* dieta oral sem horários */
		a.nr_prescricao nr_prescricao,
		null nr_seq_item,
		'N' ie_acm_sn,
		to_char(d.cd_dieta) cd_item,
		obter_nome_dieta(d.cd_dieta) ds_item,
		null cd_intervalo,
		null qt_item,
		null ds_prescricao,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		'' ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	prescr_dieta d,
		prescr_dieta_hor c,
		prescr_medica a
	where	c.nr_prescricao = a.nr_prescricao
	and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	coalesce(c.ie_situacao,'A') = 'A'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	c.dt_horario between dt_inicial_w and dt_final_w
	and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	ie_proc_setor_user_p = 'N'
	and	adep_obter_regra_inclusao(	'DO',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									null,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									null) = 'S' -- nr_seq_exame_p
	and	a.nr_prescricao = d.nr_prescricao
	and	ie_dieta_sem_horario_w = 'N'
	and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
	group by
		'D',
		a.nr_prescricao,
		null,
		'N',
		to_char(d.cd_dieta),
		obter_nome_dieta(d.cd_dieta),
		0,
		''
	
union

	select	'S' ie_tipo_item, /* suplemento oral  pendente farmácia enfermagem*/
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		to_char(b.cd_material) cd_item,
		substr(obter_desc_material(b.cd_material),1,100) ds_item,
		b.cd_intervalo cd_intervalo,
		b.qt_dose qt_item,
		CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100) END  END  ds_prescricao,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'E'  ELSE CASE WHEN coalesce(a.dt_liberacao_farmacia::text, '') = '' THEN  'F'  ELSE '' END  END  ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	prescr_material b,
		prescr_medica a
	where	b.nr_prescricao = a.nr_prescricao
	and	coalesce(a.ie_adep,'S') = 'S'
	and	ie_exibir_col_pend_w = 'S'
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(b.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	b.ie_agrupador in (12)
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	((coalesce(a.dt_liberacao::text, '') = '') or (coalesce(a.dt_liberacao_farmacia::text, '') = ''))
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	ie_proc_setor_user_p = 'N'
	and	adep_obter_regra_inclusao(	'SO',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									b.cd_material,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									null,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									null) = 'S'	 -- nr_seq_exame_p
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(b.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	((	select	coalesce(max('S'),'N')
			from	prescr_mat_hor
			where	nr_prescricao = a.nr_prescricao
			and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S') = 'N')
	group by
		'S',
		CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'E'  ELSE CASE WHEN coalesce(a.dt_liberacao_farmacia::text, '') = '' THEN  'F'  ELSE '' END  END ,
		a.nr_prescricao,
		b.nr_sequencia,
		b.cd_material,
		b.cd_intervalo,
		b.ie_acm,
		b.ie_se_necessario,
		b.cd_intervalo,
		b.qt_dose,
		null,
		0,
		''
	
union

	select	'S' ie_tipo_item, /* suplemento oral */
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		to_char(b.cd_material) cd_item,
		substr(obter_desc_material(b.cd_material),1,100) ds_item,
		b.cd_intervalo cd_intervalo,
		b.qt_dose qt_item,
		CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100) END  END  ds_prescricao,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		'' ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
	where	c.nr_prescricao = b.nr_prescricao
	and	c.nr_seq_material = b.nr_sequencia
	and	b.nr_prescricao = a.nr_prescricao
	and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	b.ie_agrupador in (12)
	and	coalesce(c.ie_situacao,'A') = 'A'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	((c.dt_horario between dt_inicial_w and dt_final_w) or
		(((coalesce(b.ie_acm,'N') = 'S') or (coalesce(b.ie_se_necessario,'N') = 'S')) and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_w,dt_final_w) = 'S')))
	and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	ie_proc_setor_user_p = 'N'
	and	adep_obter_regra_inclusao(	'SO',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									b.cd_material,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									null,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									null) = 'S' -- nr_seq_exame_p
	and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	((ie_exibir_col_pend_w = 'N') or (	select	coalesce(max('S'),'N')
			from	prescr_mat_hor
			where	nr_prescricao = a.nr_prescricao
			and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S') = 'S')
	and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
	group by
		'S',
		a.nr_prescricao,
		b.nr_sequencia,
		b.cd_material,
		b.cd_intervalo,
		b.ie_acm,
		b.ie_se_necessario,
		b.cd_intervalo,
		b.qt_dose,
		null,
		0,
		''
	
union

	select	'SNE' ie_tipo_item, /* Suporte nutricional enteral */
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		to_char(b.cd_material) cd_item,
		substr(obter_desc_material(b.cd_material),1,100) ds_item,
		b.cd_intervalo cd_intervalo,
		b.qt_dose qt_item,
		CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100) END  END  ds_prescricao,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		'' ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	prescr_material b,
		prescr_medica a
	where	b.nr_prescricao = a.nr_prescricao
	and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	b.ie_agrupador in (8)
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	(b.dt_status IS NOT NULL AND b.dt_status::text <> '')
	and	((b.dt_status between dt_inicial_w and dt_final_w) or
		(((coalesce(b.ie_acm,'N') = 'S') or (coalesce(b.ie_se_necessario,'N') = 'S')) and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_w,dt_final_w) = 'S')))
	and	((ie_horario_realizado_p = 'N' AND b.ie_status <> 'T') or (ie_horario_realizado_p = 'S'))
	and	((ie_horario_suspenso_p = 'N' AND b.ie_status <> 'S') or (ie_horario_suspenso_p = 'S'))
	and	ie_proc_setor_user_p = 'N'
	and	adep_obter_regra_inclusao(	'SNE',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									b.cd_material,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									null,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									null) = 'S'	 -- nr_seq_exame_p
	group by
		'S',
		a.nr_prescricao,
		b.nr_sequencia,
		b.cd_material,
		b.cd_intervalo,
		b.ie_acm,
		b.ie_se_necessario,
		b.cd_intervalo,
		b.qt_dose,
		null,
		0,
		''
	
union

	select	'SNE' ie_tipo_item, /* Suporte nutricional enteral  Pendente farmácia ou enfermagem*/
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		to_char(b.cd_material) cd_item,
		substr(obter_desc_material(b.cd_material),1,100) ds_item,
		b.cd_intervalo cd_intervalo,
		b.qt_dose qt_item,
		CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100) END  END  ds_prescricao,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'E'  ELSE CASE WHEN coalesce(a.dt_liberacao_farmacia::text, '') = '' THEN  'F'  ELSE '' END  END  ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	prescr_material b,
		prescr_medica a
	where	b.nr_prescricao = a.nr_prescricao
	and	coalesce(a.ie_adep,'S') = 'S'
	and	b.ie_agrupador in (8)
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	ie_proc_setor_user_p = 'N'
	and	adep_obter_regra_inclusao(	'SNE',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									b.cd_material,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									null,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									null) = 'S'	 -- nr_seq_exame_p
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(b.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	((ie_exibir_col_pend_w = 'S') and (coalesce(b.dt_status::text, '') = ''))
	group by
		'S',
		a.nr_prescricao,
		b.nr_sequencia,
		b.cd_material,
		CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'E'  ELSE CASE WHEN coalesce(a.dt_liberacao_farmacia::text, '') = '' THEN  'F'  ELSE '' END  END ,
		b.cd_intervalo,
		b.ie_acm,
		b.ie_se_necessario,
		b.cd_intervalo,
		b.qt_dose,
		null,
		0,
		''
	
union

	select	'NPN' ie_tipo_item, /*NPT Neonatal */
		a.nr_prescricao nr_prescricao,
		null nr_seq_item,
		'N' ie_acm_sn,
		to_char(b.nr_sequencia) cd_item,
		obter_desc_expressao(305334)%ORA2PG_COMMENT465126(|b.hr_prim_horario ds_item,
		null cd_intervalo,
		null qt_item,
		null  ds_prescricao,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		'' ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	nut_pac b,
		prescr_medica a
	where	b.nr_prescricao = a.nr_prescricao
	and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	(b.dt_status IS NOT NULL AND b.dt_status::text <> '')
	and	((b.dt_status between dt_inicial_w and dt_final_w) or (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_w,dt_final_w) = 'S'))
	and	coalesce(b.ie_npt_adulta,'N') = 'N'
	and	((ie_horario_suspenso_p = 'N' AND b.ie_suspenso = 'N') or (ie_horario_suspenso_p = 'S'))
	and	((ie_horario_realizado_p = 'N' AND b.ie_status <> 'T') or (ie_horario_realizado_p = 'S'))
	and	adep_obter_regra_inclusao(	'NPN',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									null,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									null) = 'S' -- nr_seq_exame_p
	and	ie_proc_setor_user_p = 'N'
	group by 'NPN',
		a.nr_prescricao,
		obter_desc_expressao(305334)%ORA2PG_COMMENT465127(|b.hr_prim_horario,
		'N',
		to_char(b.nr_sequencia),
		0,
		''
	
union

	select	'NPN' ie_tipo_item, /*NPT Neonatal  pendente farmácia ou enfermagem*/
		a.nr_prescricao nr_prescricao,
		null nr_seq_item,
		'N' ie_acm_sn,
		to_char(b.nr_sequencia) cd_item,
		obter_desc_expressao(305334)%ORA2PG_COMMENT465129(|b.hr_prim_horario ds_item,
		null cd_intervalo,
		null qt_item,
		null  ds_prescricao,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'E'  ELSE CASE WHEN coalesce(a.dt_liberacao_farmacia::text, '') = '' THEN  'F'  ELSE '' END  END  ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	nut_pac b,
		prescr_medica a
	where	b.nr_prescricao = a.nr_prescricao
	and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	coalesce(b.ie_npt_adulta,'N') = 'N'
	and	adep_obter_regra_inclusao(	'NPN',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									null,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									null) = 'S' -- nr_seq_exame_p
	and	ie_proc_setor_user_p = 'N'
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(b.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	((ie_exibir_col_pend_w = 'S') and (coalesce(b.dt_status::text, '') = ''))
	group by 'NPN',
		a.nr_prescricao,
		obter_desc_expressao(305334)%ORA2PG_COMMENT465130(|b.hr_prim_horario,
		CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'E'  ELSE CASE WHEN coalesce(a.dt_liberacao_farmacia::text, '') = '' THEN  'F'  ELSE '' END  END ,
		'N',
		to_char(b.nr_sequencia),
		0,
		''
	
union

	select	'NAN' ie_tipo_item, /*NPT Adulto Nova */
		a.nr_prescricao nr_prescricao,
		null nr_seq_item,
		'N' ie_acm_sn,
		to_char(b.nr_sequencia) cd_item,
		CASE WHEN b.ie_forma='P' THEN  obter_desc_expressao(328829)/*'Protocolo '*/||substr(obter_desc_prot_npt(b.nr_seq_protocolo),1,200)  ELSE obter_valor_dominio(1988, b.ie_forma) END  ds_item,
		null cd_intervalo,
		null qt_item,
		null  ds_prescricao,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		'' ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	nut_pac b,
		prescr_medica a
	where	b.nr_prescricao = a.nr_prescricao
	and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	(b.dt_status IS NOT NULL AND b.dt_status::text <> '')
	and	((b.dt_status between dt_inicial_w and dt_final_w) or (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_w,dt_final_w) = 'S'))
	and	coalesce(b.ie_npt_adulta,'N') = 'S'
	and	((ie_horario_suspenso_p = 'N' AND b.ie_suspenso = 'N') or (ie_horario_suspenso_p = 'S'))
	and	((ie_horario_realizado_p = 'N' AND b.ie_status <> 'T') or (ie_horario_realizado_p = 'S'))
	and	adep_obter_regra_inclusao(	'NPA',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									null,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									null) = 'S' -- nr_seq_exame_p
	and	ie_proc_setor_user_p = 'N'
	group by 'NAN',
		a.nr_prescricao,
		CASE WHEN b.ie_forma='P' THEN  obter_desc_expressao(328829)/*'Protocolo '*/||substr(obter_desc_prot_npt(b.nr_seq_protocolo),1,200)  ELSE obter_valor_dominio(1988, b.ie_forma) END ,
		'N',
		to_char(b.nr_sequencia),
		0,
		''
	
union

	select	'NAN' ie_tipo_item, /*NPT Adulto Nova  Pendente farmácia ou enfermagem*/
		a.nr_prescricao nr_prescricao,
		null nr_seq_item,
		'N' ie_acm_sn,
		to_char(b.nr_sequencia) cd_item,
		CASE WHEN b.ie_forma='P' THEN  obter_desc_expressao(328829)/*'Protocolo '*/||substr(obter_desc_prot_npt(b.nr_seq_protocolo),1,200)  ELSE obter_valor_dominio(1988, b.ie_forma) END  ds_item,
		null cd_intervalo,
		null qt_item,
		null  ds_prescricao,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'E'  ELSE CASE WHEN coalesce(a.dt_liberacao_farmacia::text, '') = '' THEN  'F'  ELSE '' END  END  ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	nut_pac b,
		prescr_medica a
	where	b.nr_prescricao = a.nr_prescricao
	and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	coalesce(b.ie_npt_adulta,'N') = 'S'
	and	adep_obter_regra_inclusao(	'NPA',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									null,
									null,  -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									null) = 'S' -- nr_seq_exame_p
	and	ie_proc_setor_user_p = 'N'
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(b.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	((ie_exibir_col_pend_w = 'S') and (coalesce(b.dt_status::text, '') = ''))
	group by 'NAN',
		a.nr_prescricao,
		CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'E'  ELSE CASE WHEN coalesce(a.dt_liberacao_farmacia::text, '') = '' THEN  'F'  ELSE '' END  END ,
		CASE WHEN b.ie_forma='P' THEN  obter_desc_expressao(328829)/*'Protocolo '*/||substr(obter_desc_prot_npt(b.nr_seq_protocolo),1,200)  ELSE obter_valor_dominio(1988, b.ie_forma) END ,
		'N',
		to_char(b.nr_sequencia),
		0,
		''
	
union

	select	'M' ie_tipo_item, -- medicamentos
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		to_char(b.cd_material) cd_item,
		substr(obter_desc_material(b.cd_material),1,100) ds_item,
		b.cd_intervalo cd_intervalo,
		b.qt_dose qt_item,
		CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100) END  END  ds_prescricao,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		CASE WHEN CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END ='S' THEN 				CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao, b.nr_sequencia, ie_agrupar_acm_sn_w)='N' THEN  CASE WHEN b.ie_suspenso='S' THEN 'S'  ELSE null END   ELSE null END   ELSE null END  ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		'' ie_pendente_liberacao,
		CASE WHEN obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material)='S' THEN  b.nr_agrupamento  ELSE 0 END  nr_agrupamento,
		null nr_seq_lab
	from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
	where	c.nr_prescricao = b.nr_prescricao
	and	c.nr_seq_material = b.nr_sequencia
	and	b.nr_prescricao = a.nr_prescricao
	--and	a.dt_liberacao is not null
	and	obter_se_prescr_lib_adep(coalesce(a.dt_liberacao_medico, b.dt_lib_material), coalesce(a.dt_liberacao,b.dt_lib_material), coalesce(a.dt_liberacao_farmacia, b.dt_lib_farmacia), ie_data_lib_prescr_w) = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	b.ie_agrupador in (1)
	and	obter_se_gerar_item_adep('M', b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento,'S') = 'S'
	and	coalesce(c.ie_situacao,'A') = 'A'
	and	coalesce(c.ie_dose_especial,'N') = 'N'
	and	coalesce(c.ie_adep,'S') = 'S'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	((c.dt_horario between dt_inicial_w and dt_final_w) or
		(((coalesce(b.ie_acm,'N') = 'S') or (coalesce(b.ie_se_necessario,'N') = 'S')) and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_w,dt_final_w) = 'S')))
	and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	ie_proc_setor_user_p = 'N'
	and	adep_obter_regra_inclusao(	'MED',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									b.cd_material,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									null,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									null) = 'S' -- nr_seq_exame_p
	and	coalesce(ie_agrupar_de_w,'N') = 'N'
	and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
	group by
		'M',
		a.nr_prescricao,
		b.nr_sequencia,
		b.cd_material,
		b.cd_intervalo,
		b.ie_acm,
		b.ie_se_necessario,
		b.cd_intervalo,
		b.qt_dose,
		null,
		0,
		CASE WHEN CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END ='S' THEN 				CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao, b.nr_sequencia, ie_agrupar_acm_sn_w)='N' THEN  CASE WHEN b.ie_suspenso='S' THEN 'S'  ELSE null END   ELSE null END   ELSE null END ,
		'',
		CASE WHEN obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material)='S' THEN  b.nr_agrupamento  ELSE 0 END 
	
union

	select	'M' ie_tipo_item, -- medicamentos - dose especial
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		'N' ie_acm_sn,
		to_char(b.cd_material) cd_item,
		substr(obter_desc_material(b.cd_material),1,100) ds_item,
		b.cd_intervalo cd_intervalo,
		b.qt_dose qt_item,
		'DE ' || to_char(b.qt_dose_especial) || ' ' || b.cd_unidade_medida_dose,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		'' ie_pendente_liberacao,
		CASE WHEN obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material)='S' THEN  b.nr_agrupamento  ELSE 0 END  nr_agrupamento,
		null nr_seq_lab
	from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
	where	c.nr_prescricao = b.nr_prescricao
	and	c.nr_seq_material = b.nr_sequencia
	and	b.nr_prescricao = a.nr_prescricao
	--and	a.dt_liberacao is not null
	and	obter_se_prescr_lib_adep(coalesce(a.dt_liberacao_medico, b.dt_lib_material), coalesce(a.dt_liberacao,b.dt_lib_material), coalesce(a.dt_liberacao_farmacia, b.dt_lib_farmacia), ie_data_lib_prescr_w) = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	b.ie_agrupador in (1)
	and	obter_se_gerar_item_adep('M', b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento,'S') = 'S'
	and	coalesce(c.ie_situacao,'A') = 'A'
	and	coalesce(c.ie_dose_especial,'N') = 'S'
	and	coalesce(c.ie_adep,'S') = 'S'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	((c.dt_horario between dt_inicial_w and dt_final_w) or
		(((coalesce(b.ie_acm,'N') = 'S') or (coalesce(b.ie_se_necessario,'N') = 'S')) and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_w,dt_final_w) = 'S')))
	and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	ie_proc_setor_user_p = 'N'
	and	adep_obter_regra_inclusao(	'MED',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									b.cd_material,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									null,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									null) = 'S' -- nr_seq_exame_p
	and	coalesce(ie_agrupar_de_w,'N') = 'N'
	and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
	group by
		'M',
		a.nr_prescricao,
		b.nr_sequencia,
		b.cd_material,
		b.cd_intervalo,
		b.ie_acm,
		b.ie_se_necessario,
		b.cd_intervalo,
		b.qt_dose,
		b.qt_dose_especial,
		b.cd_unidade_medida_dose,
		null,
		0,
		'',
		CASE WHEN obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material)='S' THEN  b.nr_agrupamento  ELSE 0 END 
	
union

	select	'M' ie_tipo_item, -- medicamentos
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		to_char(b.cd_material) cd_item,
		substr(obter_desc_material(b.cd_material),1,100) ds_item,
		b.cd_intervalo cd_intervalo,
		b.qt_dose qt_item,
		CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100) END  END  ds_prescricao,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		CASE WHEN CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END ='S' THEN 				CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao, b.nr_sequencia, ie_agrupar_acm_sn_w)='N' THEN  CASE WHEN b.ie_suspenso='S' THEN 'S'  ELSE null END   ELSE null END   ELSE null END  ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		'' ie_pendente_liberacao,
		CASE WHEN obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material)='S' THEN  b.nr_agrupamento  ELSE 0 END  nr_agrupamento,
		null nr_seq_lab
	from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
	where	c.nr_prescricao = b.nr_prescricao
	and	c.nr_seq_material = b.nr_sequencia
	and	b.nr_prescricao = a.nr_prescricao
	--and	a.dt_liberacao is not null
	and	obter_se_prescr_lib_adep(coalesce(a.dt_liberacao_medico, b.dt_lib_material), coalesce(a.dt_liberacao,b.dt_lib_material), coalesce(a.dt_liberacao_farmacia, b.dt_lib_farmacia), ie_data_lib_prescr_w) = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	b.ie_agrupador in (1)
	and	obter_se_gerar_item_adep('M', b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento,'S') = 'S'
	and	coalesce(c.ie_situacao,'A') = 'A'
	--and	nvl(c.ie_dose_especial,'N') = 'N'
	and	coalesce(c.ie_adep,'S') = 'S'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	((c.dt_horario between dt_inicial_w and dt_final_w) or
		(((coalesce(b.ie_acm,'N') = 'S') or (coalesce(b.ie_se_necessario,'N') = 'S')) and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_w,dt_final_w) = 'S')))
	and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	ie_proc_setor_user_p = 'N'
	and	adep_obter_regra_inclusao(	'MED',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									b.cd_material,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									null,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									null) = 'S' -- nr_seq_exame_p
	and	coalesce(ie_agrupar_de_w,'N') = 'S'
	and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
	group by
		'M',
		a.nr_prescricao,
		b.nr_sequencia,
		b.cd_material,
		b.cd_intervalo,
		b.ie_acm,
		b.ie_se_necessario,
		b.cd_intervalo,
		b.qt_dose,
		null,
		0,
		CASE WHEN CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END ='S' THEN 				CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao, b.nr_sequencia, ie_agrupar_acm_sn_w)='N' THEN  CASE WHEN b.ie_suspenso='S' THEN 'S'  ELSE null END   ELSE null END   ELSE null END ,
		'',
		CASE WHEN obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material)='S' THEN  b.nr_agrupamento  ELSE 0 END 
	
union

	select	'ME' ie_tipo_item, -- medicamentos
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		to_char(b.cd_material) cd_item,
		substr(obter_desc_material(b.cd_material),1,100) ds_item,
		b.cd_intervalo cd_intervalo,
		b.qt_dose qt_item,
		CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100) END  END  ds_prescricao,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		CASE WHEN CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END ='S' THEN 				CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao, b.nr_sequencia, ie_agrupar_acm_sn_w)='N' THEN  CASE WHEN b.ie_suspenso='S' THEN 'S'  ELSE null END   ELSE null END   ELSE null END  ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		'' ie_pendente_liberacao,
		CASE WHEN obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material)='S' THEN  b.nr_agrupamento  ELSE 0 END  nr_agrupamento,
		null nr_seq_lab
	from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
	where	c.nr_prescricao = b.nr_prescricao
	and	c.nr_seq_material = b.nr_sequencia
	and	b.nr_prescricao = a.nr_prescricao
	--and	a.dt_liberacao is not null
	and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	b.ie_agrupador in (14)
	and	c.nr_seq_dialise = nr_seq_dialise_p
	and	obter_se_gerar_item_adep('M', b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento,'S') = 'S'
	and	coalesce(c.ie_situacao,'A') = 'A'
	and	coalesce(c.ie_dose_especial,'N') = 'N'
	and	coalesce(c.ie_adep,'S') = 'S'
	and	a.nr_atendimento = nr_atendimento_p
	--and	a.dt_validade_prescr > sysdate - qt_hora_prescricao_p/24
	and	((c.dt_horario between dt_inicial_w and dt_final_w) or
		(((coalesce(b.ie_acm,'N') = 'S') or (coalesce(b.ie_se_necessario,'N') = 'S')) and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_w,dt_final_w) = 'S')))
	and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	ie_proc_setor_user_p = 'N'
	and	coalesce(ie_agrupar_de_w,'N') = 'N'
	and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
	group by
		'ME',
		a.nr_prescricao,
		b.nr_sequencia,
		b.cd_material,
		b.cd_intervalo,
		b.ie_acm,
		b.ie_se_necessario,
		b.cd_intervalo,
		b.qt_dose,
		null,
		0,
		CASE WHEN CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END ='S' THEN 				CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao, b.nr_sequencia, ie_agrupar_acm_sn_w)='N' THEN  CASE WHEN b.ie_suspenso='S' THEN 'S'  ELSE null END   ELSE null END   ELSE null END ,
		'',
		CASE WHEN obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material)='S' THEN  b.nr_agrupamento  ELSE 0 END 
	
union

	select	'ME' ie_tipo_item, -- medicamentos - dose especial
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		'N' ie_acm_sn,
		to_char(b.cd_material) cd_item,
		substr(obter_desc_material(b.cd_material),1,100) ds_item,
		b.cd_intervalo cd_intervalo,
		b.qt_dose qt_item,
		'DE ' || to_char(b.qt_dose_especial) || ' ' || b.cd_unidade_medida_dose,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		'' ie_pendente_liberacao,
		CASE WHEN obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material)='S' THEN  b.nr_agrupamento  ELSE 0 END  nr_agrupamento,
		null nr_seq_lab
	from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
	where	c.nr_prescricao = b.nr_prescricao
	and	c.nr_seq_material = b.nr_sequencia
	and	b.nr_prescricao = a.nr_prescricao
	--and	a.dt_liberacao is not null
	and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	b.ie_agrupador in (14)
	and	c.nr_seq_dialise = nr_seq_dialise_p
	and	obter_se_gerar_item_adep('M', b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento,'S') = 'S'
	and	coalesce(c.ie_situacao,'A') = 'A'
	and	coalesce(c.ie_dose_especial,'N') = 'S'
	and	coalesce(c.ie_adep,'S') = 'S'
	and	a.nr_atendimento = nr_atendimento_p
	--and	a.dt_validade_prescr > sysdate - qt_hora_prescricao_p/24
	and	((c.dt_horario between dt_inicial_w and dt_final_w) or
		(((coalesce(b.ie_acm,'N') = 'S') or (coalesce(b.ie_se_necessario,'N') = 'S')) and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_w,dt_final_w) = 'S')))
	and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	ie_proc_setor_user_p = 'N'
	and	coalesce(ie_agrupar_de_w,'N') = 'N'
	and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
	group by
		'ME',
		a.nr_prescricao,
		b.nr_sequencia,
		b.cd_material,
		b.cd_intervalo,
		b.ie_acm,
		b.ie_se_necessario,
		b.cd_intervalo,
		b.qt_dose,
		b.qt_dose_especial,
		b.cd_unidade_medida_dose,
		null,
		0,
		'',
		CASE WHEN obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material)='S' THEN  b.nr_agrupamento  ELSE 0 END 
	
union

	select	'ME' ie_tipo_item, -- medicamentos
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		to_char(b.cd_material) cd_item,
		substr(obter_desc_material(b.cd_material),1,100) ds_item,
		b.cd_intervalo cd_intervalo,
		b.qt_dose qt_item,
		CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100) END  END  ds_prescricao,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		CASE WHEN CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END ='S' THEN 				CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao, b.nr_sequencia, ie_agrupar_acm_sn_w)='N' THEN  CASE WHEN b.ie_suspenso='S' THEN 'S'  ELSE null END   ELSE null END   ELSE null END  ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		'' ie_pendente_liberacao,
		CASE WHEN obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material)='S' THEN  b.nr_agrupamento  ELSE 0 END  nr_agrupamento,
		null nr_seq_lab
	from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
	where	c.nr_prescricao = b.nr_prescricao
	and	c.nr_seq_material = b.nr_sequencia
	and	b.nr_prescricao = a.nr_prescricao
	--and	a.dt_liberacao is not null
	and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	b.ie_agrupador in (14)
	and	c.nr_seq_dialise = nr_seq_dialise_p
	and	obter_se_gerar_item_adep('M', b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento,'S') = 'S'
	and	coalesce(c.ie_situacao,'A') = 'A'
	--and	nvl(c.ie_dose_especial,'N') = 'N'
	and	coalesce(c.ie_adep,'S') = 'S'
	and	a.nr_atendimento = nr_atendimento_p
	--and	a.dt_validade_prescr > sysdate - qt_hora_prescricao_p/24
	and	((c.dt_horario between dt_inicial_w and dt_final_w) or
		(((coalesce(b.ie_acm,'N') = 'S') or (coalesce(b.ie_se_necessario,'N') = 'S')) and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_w,dt_final_w) = 'S')))
	and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
--	and	ie_proc_setor_user_p = 'N'
	and	adep_obter_regra_inclusao(	'MED',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									b.cd_material,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									null,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									null) = 'S' -- nr_seq_exame_p
	and	coalesce(ie_agrupar_de_w,'N') = 'S'
	and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
	group by
		'ME',
		a.nr_prescricao,
		b.nr_sequencia,
		b.cd_material,
		b.cd_intervalo,
		b.ie_acm,
		b.ie_se_necessario,
		b.cd_intervalo,
		b.qt_dose,
		null,
		0,
		CASE WHEN CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END ='S' THEN 				CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao, b.nr_sequencia, ie_agrupar_acm_sn_w)='N' THEN  CASE WHEN b.ie_suspenso='S' THEN 'S'  ELSE null END   ELSE null END   ELSE null END ,
		'',
		CASE WHEN obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material)='S' THEN  b.nr_agrupamento  ELSE 0 END 
	
union

	select	'MAT' ie_tipo_item, /* materiais */
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		to_char(b.cd_material) cd_item,
		substr(obter_desc_material(b.cd_material),1,100) ds_item,
		b.cd_intervalo cd_intervalo,
		b.qt_dose qt_item,
		CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100) END  END  ds_prescricao,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		'' ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
	where	c.nr_prescricao = b.nr_prescricao
	and	c.nr_seq_material = b.nr_sequencia
	and	b.nr_prescricao = a.nr_prescricao
	--and	a.dt_liberacao is not null
	and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	b.ie_agrupador in (2)
	--and	obter_se_gerar_item_adep('M', b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento) = 'S'
	--and	obter_se_material_adep(a.cd_estabelecimento,b.cd_material) = 'S'
	and	coalesce(c.ie_situacao,'A') = 'A'
	and	coalesce(c.ie_dose_especial,'N') = 'N'
	and	coalesce(c.ie_adep,'S') = 'S'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	((c.dt_horario between dt_inicial_w and dt_final_w) or
		(((coalesce(b.ie_acm,'N') = 'S') or (coalesce(b.ie_se_necessario,'N') = 'S')) and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_w,dt_final_w) = 'S')))
	and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	ie_proc_setor_user_p = 'N'
	and	adep_obter_regra_inclusao(	'MAT',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									b.cd_material,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									null,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									null) = 'S' -- nr_seq_exame_p
	and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
	group by
		'MAT',
		a.nr_prescricao,
		b.nr_sequencia,
		b.cd_material,
		b.cd_intervalo,
		b.ie_acm,
		b.ie_se_necessario,
		b.cd_intervalo,
		b.qt_dose,
		null,
		0,
		''
	
union

	select	'P' ie_tipo_item, /* procedimentos */
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		to_char(b.cd_procedimento) cd_item,
		CASE WHEN ie_apelido_exame_w='N' THEN  substr(obter_desc_prescr_proc(b.cd_procedimento, b.ie_origem_proced, b.nr_seq_proc_interno),1,240)  ELSE coalesce(substr(b.ds_rotina, 1,240), substr(obter_desc_prescr_proc(b.cd_procedimento, b.ie_origem_proced, b.nr_seq_proc_interno),1,240)) END  ds_item,
		b.cd_intervalo cd_intervalo,
		b.qt_procedimento qt_item,
		CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL','S'),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL','S'),1,100)  ELSE substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL','S'),1,100) END  END  ds_prescricao,
		substr(obter_classif_proc_adep(b.nr_seq_proc_interno),1,15) ie_classif_adep,
		coalesce(b.nr_seq_proc_interno,0) nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		CASE WHEN obter_se_associado_dif(a.nr_prescricao, b.nr_sequencia)='N' THEN   (b.nr_sequencia||a.nr_prescricao)::numeric   ELSE b.nr_sequencia END    nr_seq_proc,
		'' ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	prescr_proc_hor c,
		prescr_procedimento b,
		prescr_medica a
	where	c.nr_prescricao = b.nr_prescricao
	and	c.nr_seq_procedimento = b.nr_sequencia
	and	b.nr_prescricao = a.nr_prescricao
	and	(obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '')
	and	obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	coalesce(b.nr_seq_solic_sangue::text, '') = ''
	and	coalesce(b.nr_seq_derivado::text, '') = ''
	and	coalesce(b.nr_seq_exame::text, '') = ''
	and	coalesce(b.nr_seq_prot_glic::text, '') = ''
	and	substr(obter_ctrl_glic_proc(b.nr_seq_proc_interno),1,3) <> 'CIG'
	and	obter_se_proc_IVC(b.nr_seq_proc_interno) <> 'S'
	and	obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'G') <> 'S'
	and	coalesce(c.ie_situacao,'A') = 'A'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	((c.dt_horario between dt_inicial_w and dt_final_w) or
		(((coalesce(b.ie_acm,'N') = 'S') or (coalesce(b.ie_se_necessario,'N') = 'S')) and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_w,dt_final_w) = 'S')))
	and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	((ie_proc_setor_user_p = 'N') or (adep_obter_se_setor_proc_user(nm_usuario_p,b.cd_setor_atendimento) = 'S'))
	and	adep_obter_regra_inclusao(	'PROC',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									b.cd_procedimento,
									b.ie_origem_proced,
									b.nr_seq_proc_interno,
									a.cd_setor_atendimento,
									b.cd_setor_atendimento,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									b.nr_seq_exame) = 'S' -- nr_seq_exame_p
	and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	((ie_exibir_col_pend_w = 'N') or
		((	select	coalesce(max('S'),'N')
			from	prescr_proc_hor
			where 	nr_prescricao = a.nr_prescricao
			and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S') = 'S'))
	and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
	group by
		'P',
		a.nr_prescricao,
		b.nr_sequencia,
		b.cd_procedimento,
		b.ie_origem_proced,
		b.nr_seq_proc_interno,
		b.cd_intervalo,
		b.qt_procedimento,
		substr(b.ds_rotina, 1,240),
		b.ie_acm,
		b.ie_se_necessario,
		b.cd_intervalo,
		CASE WHEN obter_se_associado_dif(a.nr_prescricao, b.nr_sequencia)='N' THEN   (b.nr_sequencia||a.nr_prescricao)::numeric   ELSE b.nr_sequencia END ,
		''
	
union

	select	'P' ie_tipo_item, /* procedimentos  sem liberação da Enfermagem/Farmácia*/
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		to_char(b.cd_procedimento) cd_item,
		substr(obter_desc_prescr_proc(b.cd_procedimento, b.ie_origem_proced, b.nr_seq_proc_interno),1,240) ds_item,
		b.cd_intervalo cd_intervalo,
		b.qt_procedimento qt_item,
		CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL','S'),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL','S'),1,100)  ELSE substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL','S'),1,100) END  END  ds_prescricao,
		substr(obter_classif_proc_adep(b.nr_seq_proc_interno),1,15) ie_classif_adep,
		coalesce(b.nr_seq_proc_interno,0) nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		CASE WHEN obter_se_associado_dif(a.nr_prescricao, b.nr_sequencia)='N' THEN   (b.nr_sequencia||a.nr_prescricao)::numeric   ELSE 1 END    nr_seq_proc,
		CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'E'  ELSE CASE WHEN coalesce(a.dt_liberacao_farmacia::text, '') = '' THEN  'F'  ELSE '' END  END  ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	prescr_procedimento b,
		prescr_medica a
	where	b.nr_prescricao = a.nr_prescricao
	and	obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	ie_exibir_col_pend_w = 'S'
	and	coalesce(b.nr_seq_solic_sangue::text, '') = ''
	and	coalesce(b.nr_seq_derivado::text, '') = ''
	and	coalesce(b.nr_seq_exame::text, '') = ''
	and	coalesce(b.nr_seq_prot_glic::text, '') = ''
	and	substr(obter_ctrl_glic_proc(b.nr_seq_proc_interno),1,3) <> 'CIG'
	and	obter_se_proc_IVC(b.nr_seq_proc_interno) <> 'S'
	and	obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'G') <> 'S'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	((coalesce(a.dt_liberacao::text, '') = '') or (coalesce(a.dt_liberacao_farmacia::text, '') = ''))
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	((ie_proc_setor_user_p = 'N') or (adep_obter_se_setor_proc_user(nm_usuario_p,b.cd_setor_atendimento) = 'S'))
	and	adep_obter_regra_inclusao(	'PROC',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									b.cd_procedimento,
									b.ie_origem_proced,
									b.nr_seq_proc_interno,
									a.cd_setor_atendimento,
									b.cd_setor_atendimento,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									b.nr_seq_exame) = 'S' -- nr_seq_exame_p
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(b.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	((	select	coalesce(max('S'),'N')
			from	prescr_proc_hor
			where	nr_prescricao = a.nr_prescricao
			and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S') = 'N')
	group by
		'P',
		a.nr_prescricao,
		b.nr_sequencia,
		b.cd_procedimento,
		b.ie_origem_proced,
		b.nr_seq_proc_interno,
		b.cd_intervalo,
		b.qt_procedimento,
		b.ie_acm,
		b.ie_se_necessario,
		b.cd_intervalo,
		CASE WHEN obter_se_associado_dif(a.nr_prescricao, b.nr_sequencia)='N' THEN   (b.nr_sequencia||a.nr_prescricao)::numeric   ELSE 1 END ,
		CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'E'  ELSE CASE WHEN coalesce(a.dt_liberacao_farmacia::text, '') = '' THEN  'F'  ELSE '' END  END ,
		''
	
union

	select	'HM' ie_tipo_item, /* Hemoterapia */
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		to_char(b.cd_procedimento) cd_item,
		/*substr(obter_desc_prescr_proc(b.cd_procedimento, b.ie_origem_proced, b.nr_seq_proc_interno),1,240) */

		substr(Obter_desc_san_derivado(b.nr_seq_derivado),1,150) ds_item,
		b.cd_intervalo cd_intervalo,
		b.qt_procedimento qt_item,
		CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL','S'),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL','S'),1,100)  ELSE substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL','S'),1,100) END  END  ds_prescricao,
		substr(obter_classif_proc_adep(b.nr_seq_proc_interno),1,15) ie_classif_adep,
		coalesce(b.nr_seq_proc_interno,0) nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		'' ie_pendente_liberacao,
		0 nr_agrupamento,
		b.nr_seq_lab
	from	prescr_proc_hor c,
		prescr_procedimento b,
		prescr_medica a
	where	c.nr_prescricao = b.nr_prescricao
	and	c.nr_seq_procedimento = b.nr_sequencia
	and	b.nr_prescricao = a.nr_prescricao
	and	(obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '')
	and	obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	(b.nr_seq_solic_sangue IS NOT NULL AND b.nr_seq_solic_sangue::text <> '')
	and	(b.nr_seq_derivado IS NOT NULL AND b.nr_seq_derivado::text <> '')
	and	coalesce(b.nr_seq_exame::text, '') = ''
	and	coalesce(b.nr_seq_prot_glic::text, '') = ''
	and	substr(obter_ctrl_glic_proc(b.nr_seq_proc_interno),1,3) <> 'CIG'
	and	obter_se_proc_IVC(b.nr_seq_proc_interno) <> 'S'
	and	obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'G') <> 'S'
	and	coalesce(c.ie_situacao,'A') = 'A'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	((c.dt_horario between dt_inicial_w and dt_final_w) or
		(((coalesce(b.ie_acm,'N') = 'S') or (coalesce(b.ie_se_necessario,'N') = 'S')) and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_w,dt_final_w) = 'S')))
	and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	((ie_proc_setor_user_p = 'N') or (adep_obter_se_setor_proc_user(nm_usuario_p,b.cd_setor_atendimento) = 'S'))
	and	adep_obter_regra_inclusao(	'HM',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									b.cd_setor_atendimento,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									b.nr_seq_exame) = 'S' -- nr_seq_exame_p
	and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	((ie_exibir_col_pend_w = 'N') or (	select	coalesce(max('S'),'N')
			from	prescr_proc_hor
			where	nr_prescricao = a.nr_prescricao
			and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S') = 'S')
	and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
	group by
		'HM',
		a.nr_prescricao,
		b.nr_sequencia,
		substr(Obter_desc_san_derivado(b.nr_seq_derivado),1,150),
		b.cd_procedimento,
		b.ie_origem_proced,
		b.nr_seq_proc_interno,
		b.cd_intervalo,
		b.qt_procedimento,
		b.ie_acm,
		b.nr_seq_lab,
		b.ie_se_necessario,
		b.cd_intervalo,
		''
	
union

	select	'HM' ie_tipo_item, /* Hemoterapia pendente farmácia ou enfermagem*/
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		to_char(b.cd_procedimento) cd_item,
		substr(Obter_desc_san_derivado(b.nr_seq_derivado),1,150) ds_item,
		b.cd_intervalo cd_intervalo,
		b.qt_procedimento qt_item,
		CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL','S'),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL','S'),1,100)  ELSE substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL','S'),1,100) END  END  ds_prescricao,
		substr(obter_classif_proc_adep(b.nr_seq_proc_interno),1,15) ie_classif_adep,
		coalesce(b.nr_seq_proc_interno,0) nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'E'  ELSE CASE WHEN coalesce(a.dt_liberacao_farmacia::text, '') = '' THEN  'F'  ELSE '' END  END  ie_pendente_liberacao,
		0 nr_agrupamento,
		b.nr_seq_lab
	from	prescr_procedimento b,
		prescr_medica a
	where	b.nr_prescricao = a.nr_prescricao
	and	coalesce(a.ie_adep,'S') = 'S'
	and	(b.nr_seq_solic_sangue IS NOT NULL AND b.nr_seq_solic_sangue::text <> '')
	and	(b.nr_seq_derivado IS NOT NULL AND b.nr_seq_derivado::text <> '')
	and	coalesce(b.nr_seq_exame::text, '') = ''
	and	coalesce(b.nr_seq_prot_glic::text, '') = ''
	and	substr(obter_ctrl_glic_proc(b.nr_seq_proc_interno),1,3) <> 'CIG'
	and	obter_se_proc_IVC(b.nr_seq_proc_interno) <> 'S'
	and	obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'G') <> 'S'
	and	a.nr_atendimento = nr_atendimento_p
	and	ie_exibir_col_pend_w = 'S'
	and	((coalesce(a.dt_liberacao::text, '') = '') or (coalesce(a.dt_liberacao_farmacia::text, '') = ''))
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	a.dt_validade_prescr > dt_validade_w
	and	((ie_proc_setor_user_p = 'N') or (adep_obter_se_setor_proc_user(nm_usuario_p,b.cd_setor_atendimento) = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(b.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	((	select	coalesce(max('S'),'N')
			from	prescr_proc_hor
			where	nr_prescricao = a.nr_prescricao
			and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S') = 'N')
	group by
		'HM',
		a.nr_prescricao,
		b.nr_sequencia,
		substr(Obter_desc_san_derivado(b.nr_seq_derivado),1,150),
		b.cd_procedimento,
		b.ie_origem_proced,
		b.nr_seq_proc_interno,
		b.cd_intervalo,
		b.qt_procedimento,
		b.ie_acm,
		b.ie_se_necessario,
		b.cd_intervalo,
		CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'E'  ELSE CASE WHEN coalesce(a.dt_liberacao_farmacia::text, '') = '' THEN  'F'  ELSE '' END  END ,
		'',
		b.nr_seq_lab
	
union

	select	'O' ie_tipo_item, /* GasoTerapia */
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		'N' ie_acm_sn,
		to_char(b.nr_seq_gas) cd_item,
		substr(obter_descricao_padrao('GAS', 'DS_GAS', b.nr_seq_gas),1,254) ds_item,
		b.cd_intervalo,
		b.qt_gasoterapia qt_item,
		substr((b.qt_gasoterapia || ' ' ||
			obter_valor_dominio(1580,b.ie_unidade_medida) || ' ' ||
				obter_descricao_padrao('INTERVALO_PRESCRICAO', 'DS_INTERVALO', cd_intervalo)),1,255)	ds_prescricao,
		null ie_classif_adep,
		(null)::numeric  nr_seq_proc_interno,
		b.ie_suspenso,
		(CASE WHEN coalesce(b.cd_modalidade_vent::text, '') = '' THEN ''  ELSE obter_desc_expressao(343108)/*'Modalidade vent: '*/ || substr(obter_descricao_padrao('MODALIDADE_VENTILATORIA', 'DS_MODALIDADE', b.cd_modalidade_vent),1,155) || chr(13) END  ||
			CASE WHEN coalesce(b.ie_respiracao::text, '') = '' THEN ''  ELSE obter_desc_expressao(343110)/*'Tipo respiração: '*/ || substr(obter_valor_dominio(1299, b.ie_respiracao),1,200) || chr(13) END  ||
			CASE WHEN coalesce(b.ie_modo_adm::text, '') = '' THEN  ''  ELSE obter_desc_expressao(343112)/*'Modo adm: '*/ || substr(obter_valor_dominio(1568, b.ie_modo_adm),1,200) END ) ds_informacao,
		0 nr_seq_proc,
		'' ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	prescr_gasoterapia b,
		prescr_medica a
	where	b.nr_prescricao = a.nr_prescricao
	and	(obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '')
	and	coalesce(a.ie_adep,'S') = 'S'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	((b.dt_prev_execucao between dt_inicial_w and dt_final_w) or (coalesce(b.dt_prev_execucao::text, '') = ''))
	and	((ie_proc_setor_user_p = 'N') or (adep_obter_se_setor_proc_user(nm_usuario_p, a.cd_setor_atendimento) = 'S'))
	and (adep_obter_regra_inclusao(	'OX',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									null,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									null) = 'S')	 -- nr_seq_exame_p
	and	((ie_exibir_col_pend_w = 'N') or
		(ie_exibir_col_pend_w = 'S' AND a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
	group by
		'O',
		a.nr_prescricao,
		b.nr_sequencia,
		b.cd_intervalo,
		b.ie_suspenso,
		substr((b.qt_gasoterapia || ' ' ||
			obter_valor_dominio(1580,b.ie_unidade_medida) || ' ' ||
				obter_descricao_padrao('INTERVALO_PRESCRICAO', 'DS_INTERVALO', cd_intervalo)),1,255),
		substr(obter_descricao_padrao('GAS', 'DS_GAS', b.nr_seq_gas),1,254),
		b.nr_seq_gas,
		b.qt_gasoterapia,
		b.cd_modalidade_vent,
		b.ie_respiracao,
		b.ie_modo_adm,
		''
	
union

	select	'O' ie_tipo_item, /* GasoTerapia  Pendente farmácia ou enfermagem*/
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		'N' ie_acm_sn,
		to_char(b.nr_seq_gas) cd_item,
		substr(obter_descricao_padrao('GAS', 'DS_GAS', b.nr_seq_gas),1,254) ds_item,
		b.cd_intervalo,
		b.qt_gasoterapia qt_item,
		substr((b.qt_gasoterapia || ' ' ||
			obter_valor_dominio(1580,b.ie_unidade_medida) || ' ' ||
				obter_descricao_padrao('INTERVALO_PRESCRICAO', 'DS_INTERVALO', cd_intervalo)),1,255)	ds_prescricao,
		null ie_classif_adep,
		(null)::numeric  nr_seq_proc_interno,
		b.ie_suspenso,
		(CASE WHEN coalesce(b.cd_modalidade_vent::text, '') = '' THEN ''  ELSE obter_desc_expressao(343108)/*'Modalidade vent: '*/ || substr(obter_descricao_padrao('MODALIDADE_VENTILATORIA', 'DS_MODALIDADE', b.cd_modalidade_vent),1,155) || chr(13) END  ||
			CASE WHEN coalesce(b.ie_respiracao::text, '') = '' THEN ''  ELSE obter_desc_expressao(343110)/*'Tipo respiração: '*/ || substr(obter_valor_dominio(1299, b.ie_respiracao),1,200) || chr(13) END  ||
			CASE WHEN coalesce(b.ie_modo_adm::text, '') = '' THEN  ''  ELSE obter_desc_expressao(343112)/*'Modo adm: '*/ || substr(obter_valor_dominio(1568, b.ie_modo_adm),1,200) END ) ds_informacao,
		0 nr_seq_proc,
		CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'E'  ELSE CASE WHEN coalesce(a.dt_liberacao_farmacia::text, '') = '' THEN  'F'  ELSE '' END  END  ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	prescr_gasoterapia b,
		prescr_medica a
	where	b.nr_prescricao = a.nr_prescricao
	and	coalesce(obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w)::text, '') = ''
	and	ie_exibir_col_pend_w = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	((coalesce(a.dt_liberacao::text, '') = '') or (coalesce(a.dt_liberacao_farmacia::text, '') = ''))
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	coalesce(b.ie_suspenso, 'N') = 'N'
	and	((ie_proc_setor_user_p = 'N') or (adep_obter_se_setor_proc_user(nm_usuario_p, a.cd_setor_atendimento) = 'S'))
	and (adep_obter_regra_inclusao(	'OX',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									null,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									null) = 'S') -- nr_seq_exame_p
	group by
		'O',
		a.nr_prescricao,
		b.nr_sequencia,
		b.cd_intervalo,
		b.ie_suspenso,
		substr((b.qt_gasoterapia || ' ' ||
			obter_valor_dominio(1580,b.ie_unidade_medida) || ' ' ||
				obter_descricao_padrao('INTERVALO_PRESCRICAO', 'DS_INTERVALO', cd_intervalo)),1,255),
		substr(obter_descricao_padrao('GAS', 'DS_GAS', b.nr_seq_gas),1,254),
		b.nr_seq_gas,
		b.qt_gasoterapia,
		b.cd_modalidade_vent,
		b.ie_respiracao,
		b.ie_modo_adm,
		CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'E'  ELSE CASE WHEN coalesce(a.dt_liberacao_farmacia::text, '') = '' THEN  'F'  ELSE '' END  END ,
		''
	
union

	select	'R' ie_tipo_item, /* recomendacoes */
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		CASE WHEN padroniza_horario(b.ds_horarios)='' THEN  'S'  ELSE 'N' END  ie_acm_sn,
		coalesce(to_char(b.cd_recomendacao), b.ds_recomendacao) cd_item,
		substr(obter_rec_prescricao(b.nr_sequencia, a.nr_prescricao),1,240) ds_item,
		b.cd_intervalo cd_intervalo,
		b.qt_recomendacao qt_item,
		substr(obter_desc_intervalo_prescr(b.cd_intervalo),1,100) ds_prescricao,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		'' ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	prescr_rec_hor c,
		prescr_recomendacao b,
		prescr_medica a
	where	c.nr_prescricao = b.nr_prescricao
	and	c.nr_seq_recomendacao = b.nr_sequencia
	and	b.nr_prescricao = a.nr_prescricao
	and	((ie_data_lib_prescr_w = 'F') or (obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'))
	and	coalesce(a.ie_adep,'S') = 'S'
	and	coalesce(c.ie_situacao,'A') = 'A'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	((c.dt_horario between dt_inicial_w and dt_final_w) or
		((coalesce(b.ds_horarios::text, '') = '') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_w,dt_final_w) = 'S')))
	and	((b.ds_horarios IS NOT NULL AND b.ds_horarios::text <> '') or (obter_se_ult_prescr_rec_adep(a.nr_atendimento, a.nr_prescricao,b.cd_recomendacao,b.ds_recomendacao,b.cd_intervalo,b.qt_recomendacao,dt_inicial_w,dt_final_w) = 'S'))
	and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	ie_proc_setor_user_p = 'N'
	and	adep_obter_regra_inclusao(	'REC',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									null,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									null) = 'S' -- nr_seq_exame_p
	and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	((ie_exibir_col_pend_w = 'N') or (	select	coalesce(max('S'),'N')
			from	prescr_rec_hor
			where	nr_prescricao = a.nr_prescricao
			and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S') = 'S')
	and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
	group by
		'R',
		a.nr_prescricao,
		b.nr_sequencia,
		b.cd_recomendacao,
		b.ds_recomendacao,
		b.cd_intervalo,
		b.qt_recomendacao,
		b.ds_horarios,
		b.cd_intervalo,
		null,
		0,
		''
	
union

	select	'R' ie_tipo_item, /* recomendacoes Pendentes farmácia ou enfermagem*/
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		CASE WHEN padroniza_horario(b.ds_horarios)='' THEN  'S'  ELSE 'N' END  ie_acm_sn,
		coalesce(to_char(b.cd_recomendacao), b.ds_recomendacao) cd_item,
		substr(obter_rec_prescricao(b.nr_sequencia, a.nr_prescricao),1,240) ds_item,
		b.cd_intervalo cd_intervalo,
		b.qt_recomendacao qt_item,
		substr(obter_desc_intervalo_prescr(b.cd_intervalo),1,100) ds_prescricao,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'E'  ELSE CASE WHEN coalesce(a.dt_liberacao_farmacia::text, '') = '' THEN  'F'  ELSE '' END  END  ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	prescr_recomendacao b,
		prescr_medica a
	where	b.nr_prescricao = a.nr_prescricao
	and	coalesce(a.ie_adep,'S') = 'S'
	and	ie_exibir_col_pend_w = 'S'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	((coalesce(a.dt_liberacao::text, '') = '') or (coalesce(a.dt_liberacao_farmacia::text, '') = ''))
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	ie_proc_setor_user_p = 'N'
	and	adep_obter_regra_inclusao(	'REC',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									null,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									null) = 'S'	 -- nr_seq_exame_p
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(b.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	((	select	coalesce(max('S'),'N')
			from	prescr_rec_hor
			where	nr_prescricao = a.nr_prescricao
			and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S') = 'N')
	group by
		'R',
		CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'E'  ELSE CASE WHEN coalesce(a.dt_liberacao_farmacia::text, '') = '' THEN  'F'  ELSE '' END  END ,
		a.nr_prescricao,
		b.nr_sequencia,
		b.cd_recomendacao,
		b.ds_recomendacao,
		b.cd_intervalo,
		b.qt_recomendacao,
		b.ds_horarios,
		b.cd_intervalo,
		null,
		0,
		''
	
union

	select	'E' ie_tipo_item, /* sae */
		a.nr_sequencia nr_prescricao,
		b.nr_sequencia nr_seq_item,
		coalesce(b.ie_se_necessario,'N') ie_acm_sn,
		to_char(b.nr_seq_proc) cd_item,
		substr(obter_desc_intervencoes(b.nr_seq_proc),1,240) ds_item,
		b.cd_intervalo cd_intervalo,
		null qt_item,
		CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_desc_intervalo_prescr(b.cd_intervalo),1,80)  ELSE substr(obter_desc_intervalo_prescr(b.cd_intervalo),1,80) END  ds_prescricao,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		'' ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	pe_prescr_proc_hor c,
		pe_prescr_proc b,
		pe_prescricao a
	where	c.nr_seq_pe_proc = b.nr_sequencia
	and	b.nr_seq_prescr = a.nr_sequencia
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	coalesce(b.ie_adep,'N') = 'S'
	and	coalesce(c.ie_situacao,'A') = 'A'
	and	a.nr_atendimento = nr_atendimento_p
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	a.dt_validade_prescr > dt_validade_w
	and	((c.dt_horario between dt_inicial_w and dt_final_w) or
		((coalesce(b.ie_se_necessario,'N') = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_w,dt_final_w) = 'S')))
	and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	--and	ie_proc_setor_user_p = 'N'
	and	obter_se_exibir_interv_adep(ie_proc_setor_user_p,ie_interv_setor_user_p,b.nr_seq_proc,cd_perfil_p,cd_setor_atend_w,nm_usuario_p) = 'S'
	and	adep_obter_regra_inclusao(	'SAE',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									null,
									null,
									null,
									null,
									null,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									null) = 'S' -- nr_seq_exame_p
	and	coalesce(a.ie_situacao, 'A') = 'A'
	group by
		'E',
		a.nr_sequencia,
		b.nr_sequencia,
		b.nr_seq_proc,
		b.cd_intervalo,
		b.ie_se_necessario,
		'N',
		b.cd_intervalo,
		null,
		0,
		''
	
union

	select	'G' ie_tipo_item, /* controle de glicemia */
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		to_char(b.cd_procedimento) cd_item,
		substr(obter_nome_prot_glic(b.nr_seq_prot_glic),1,80) ds_item,
		b.cd_intervalo cd_intervalo,
		b.qt_procedimento qt_item,
		CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL',ie_exibe_dose_glicemia_w),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL',ie_exibe_dose_glicemia_w),1,100)  ELSE substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL',ie_exibe_dose_glicemia_w),1,100) END  END  ds_prescricao,
		null ie_classif_adep,
		coalesce(b.nr_seq_proc_interno,0) nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		'' ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	prescr_proc_hor c,
		prescr_procedimento b,
		prescr_medica a
	where	c.nr_prescricao = b.nr_prescricao
	and	c.nr_seq_procedimento = b.nr_sequencia
	and	b.nr_prescricao = a.nr_prescricao
	and	(obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '')
	and	obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	coalesce(b.nr_seq_solic_sangue::text, '') = ''
	and	coalesce(b.nr_seq_derivado::text, '') = ''
	and	coalesce(b.nr_seq_exame::text, '') = ''
	and	(b.nr_seq_proc_interno IS NOT NULL AND b.nr_seq_proc_interno::text <> '')
	and	(b.nr_seq_prot_glic IS NOT NULL AND b.nr_seq_prot_glic::text <> '')
	and	coalesce(c.ie_situacao,'A') = 'A'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr >= dt_validade_w
	and	((c.dt_horario between dt_inicial_w and dt_final_w) or
		(((coalesce(b.ie_acm,'N') = 'S') or (coalesce(b.ie_se_necessario,'N') = 'S')) and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_w,dt_final_w) = 'S')))
	and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	ie_proc_setor_user_p = 'N'
	and	adep_obter_regra_inclusao(	'CCG',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									b.cd_procedimento,
									b.ie_origem_proced,
									b.nr_seq_proc_interno,
									a.cd_setor_atendimento,
									b.cd_setor_atendimento,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									b.nr_seq_exame) = 'S' -- nr_seq_exame_p
	and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
	group by
		'G',
		a.nr_prescricao,
		b.nr_sequencia,
		b.cd_procedimento,
		b.nr_seq_prot_glic,
		b.cd_intervalo,
		b.qt_procedimento,
		b.ie_acm,
		b.ie_se_necessario,
		b.cd_intervalo,
		null,
		b.nr_seq_proc_interno,
		''
	
union

	select	'C' ie_tipo_item, /* cig */
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		to_char(b.cd_procedimento) cd_item,
		substr(obter_valor_dominio(1903,substr(obter_ctrl_glic_proc(b.nr_seq_proc_interno),1,3)),1,240) ds_item,
		b.cd_intervalo cd_intervalo,
		b.qt_procedimento qt_item,
		CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL',ie_exibe_dose_glicemia_w),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL',ie_exibe_dose_glicemia_w),1,100)  ELSE substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL',ie_exibe_dose_glicemia_w),1,100) END  END  ds_prescricao,
		null ie_classif_adep,
		coalesce(b.nr_seq_proc_interno,0) nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		'' ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	prescr_proc_hor c,
		prescr_procedimento b,
		prescr_medica a
	where	c.nr_prescricao = b.nr_prescricao
	and	c.nr_seq_procedimento = b.nr_sequencia
	and	b.nr_prescricao = a.nr_prescricao
	and	(obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '')
	and	obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	coalesce(b.nr_seq_solic_sangue::text, '') = ''
	and	coalesce(b.nr_seq_derivado::text, '') = ''
	and	coalesce(b.nr_seq_exame::text, '') = ''
	and	(b.nr_seq_proc_interno IS NOT NULL AND b.nr_seq_proc_interno::text <> '')
	and	substr(obter_ctrl_glic_proc(b.nr_seq_proc_interno),1,3) = 'CIG'
	and	coalesce(c.ie_situacao,'A') = 'A'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr >= dt_validade_w
	and	((c.dt_horario between dt_inicial_w and dt_final_w) or
		(((coalesce(b.ie_acm,'N') = 'S') or (coalesce(b.ie_se_necessario,'N') = 'S')) and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_w,dt_final_w) = 'S')))
	and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	ie_proc_setor_user_p = 'N'
	and	adep_obter_regra_inclusao(	'CIG',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									b.cd_procedimento,
									b.ie_origem_proced,
									b.nr_seq_proc_interno,
									a.cd_setor_atendimento,
									b.cd_setor_atendimento,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									b.nr_seq_exame) = 'S' -- nr_seq_exame_p
	and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
	group by
		'C',
		a.nr_prescricao,
		b.nr_sequencia,
		b.cd_procedimento,
		b.nr_seq_proc_interno,
		b.cd_intervalo,
		b.qt_procedimento,
		b.ie_acm,
		b.ie_se_necessario,
		b.cd_intervalo,
		null,
		''
	
union

	select	'I' ie_tipo_item, /* IVC */
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		to_char(b.cd_procedimento) cd_item,
		substr(obter_desc_prescr_proc(b.cd_procedimento, b.ie_origem_proced, b.nr_seq_proc_interno),1,240) ds_item,
		b.cd_intervalo cd_intervalo,
		b.qt_procedimento qt_item,
		CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL','S'),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL','S'),1,100)  ELSE substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL','S'),1,100) END  END  ds_prescricao,
		null ie_classif_adep,
		coalesce(b.nr_seq_proc_interno,0) nr_seq_proc_interno,
		null ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		'' ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	prescr_proc_hor c,
		prescr_procedimento b,
		prescr_medica a
	where	c.nr_prescricao		= b.nr_prescricao
	and	c.nr_seq_procedimento	= b.nr_sequencia
	and	b.nr_prescricao		= a.nr_prescricao
	and	coalesce(a.ie_adep,'S')	= 'S'
	and	coalesce(c.ie_situacao,'A')	= 'A'
	and	ie_proc_setor_user_p	= 'N'
	and	a.nr_atendimento	= nr_atendimento_p
	and	obter_se_proc_IVC(b.nr_seq_proc_interno) = 'S'
	and	(obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '')
	and	obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'
	and	coalesce(b.nr_seq_solic_sangue::text, '') = ''
	and	coalesce(b.nr_seq_derivado::text, '') = ''
	and	coalesce(b.nr_seq_exame::text, '') = ''
	and	(b.nr_seq_proc_interno IS NOT NULL AND b.nr_seq_proc_interno::text <> '')
	and	coalesce(b.nr_seq_prot_glic::text, '') = ''
	and	substr(obter_ctrl_glic_proc(b.nr_seq_proc_interno),1,3) <> 'CIG'
	and	a.dt_validade_prescr	>= dt_validade_w
	and	((c.dt_horario between dt_inicial_w and dt_final_w) or
		(((coalesce(b.ie_acm,'N')	= 'S') or (coalesce(b.ie_se_necessario,'N') = 'S')) and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_w,dt_final_w) = 'S')))
	and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	adep_obter_regra_inclusao(	'IVC',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									b.cd_procedimento,
									b.ie_origem_proced,
									b.nr_seq_proc_interno,
									a.cd_setor_atendimento,
									b.cd_setor_atendimento,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									b.nr_seq_exame) = 'S' -- nr_seq_exame_p
	and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
	group by
		'I',
		a.nr_prescricao,
		b.nr_sequencia,
		b.cd_procedimento,
		b.nr_seq_proc_interno,
		b.cd_intervalo,
		b.qt_procedimento,
		substr(obter_desc_prescr_proc(b.cd_procedimento, b.ie_origem_proced, b.nr_seq_proc_interno),1,240),
		b.ie_acm,
		b.ie_se_necessario,
		b.cd_intervalo,
		null,
		''
	
union

	select	'M' ie_tipo_item, -- medicamentos  Pendentes na farmácia ou enfermafem
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		to_char(b.cd_material) cd_item,
		substr(obter_desc_material(b.cd_material),1,100) ds_item,
		b.cd_intervalo cd_intervalo,
		b.qt_dose qt_item,
		CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100) END  END  ds_prescricao,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		CASE WHEN CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END ='S' THEN 				CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao, b.nr_sequencia, ie_agrupar_acm_sn_w)='N' THEN  CASE WHEN b.ie_suspenso='S' THEN 'S'  ELSE null END   ELSE null END   ELSE null END  ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'E'  ELSE CASE WHEN coalesce(a.dt_liberacao_farmacia::text, '') = '' THEN  'F'  ELSE '' END  END  ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	prescr_material b,
		prescr_medica a
	where	b.nr_prescricao = a.nr_prescricao
	and	ie_exibir_col_pend_w = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	b.ie_agrupador in (1)
	and	obter_se_gerar_item_adep('M', b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento,'S') = 'S'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	((coalesce(a.dt_liberacao::text, '') = '') or (coalesce(a.dt_liberacao_farmacia::text, '') = ''))
	and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
	and	ie_proc_setor_user_p = 'N'
	and	adep_obter_regra_inclusao(	'MED',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									b.cd_material,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									null,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									null) = 'S'	 -- nr_seq_exame_p
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(b.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	((	select	coalesce(max('S'),'N')
			from	prescr_mat_hor
			where	nr_prescricao = a.nr_prescricao
			and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S') = 'N')

	group by
		'M',
		a.nr_prescricao,
		b.nr_sequencia,
		b.cd_material,
		b.cd_intervalo,
		b.ie_acm,
		b.ie_se_necessario,
		b.cd_intervalo,
		b.qt_dose,
		null,
		0,
		CASE WHEN CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END ='S' THEN 				CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao, b.nr_sequencia, ie_agrupar_acm_sn_w)='N' THEN  CASE WHEN b.ie_suspenso='S' THEN 'S'  ELSE null END   ELSE null END   ELSE null END ,
		CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'E'  ELSE CASE WHEN coalesce(a.dt_liberacao_farmacia::text, '') = '' THEN  'F'  ELSE '' END  END 

	
union

	select	'IA' ie_tipo_item, -- Itens associados
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		to_char(b.cd_material) cd_item,
		substr(obter_desc_material(b.cd_material),1,100) ds_item,
		b.cd_intervalo cd_intervalo,
		c.qt_dose qt_item,
		CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100) END  END  ds_prescricao,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		CASE WHEN CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END ='S' THEN 				CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao, b.nr_sequencia, ie_agrupar_acm_sn_w)='N' THEN  CASE WHEN b.ie_suspenso='S' THEN 'S'  ELSE null END   ELSE null END   ELSE null END  ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		'' ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	prescr_procedimento d,
		prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
	where	d.nr_prescricao = b.nr_prescricao
	and	b.nr_sequencia_proc = d.nr_sequencia
	and	c.nr_prescricao = b.nr_prescricao
	and	c.nr_seq_material = b.nr_sequencia
	and	b.nr_prescricao = a.nr_prescricao
	and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	b.ie_agrupador in (5)
	and	obter_se_gerar_item_adep('M', b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento,'S') = 'S'
	and	coalesce(c.ie_situacao,'A') = 'A'
	and	coalesce(c.ie_dose_especial,'N') = 'N'
	and	coalesce(c.ie_adep,'S') = 'S'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	((c.dt_horario between dt_inicial_w and dt_final_w) or
		(((coalesce(b.ie_acm,'N') = 'S') or (coalesce(b.ie_se_necessario,'N') = 'S')) and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_w,dt_final_w) = 'S')))
	and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	ie_proc_setor_user_p = 'N'
	and	adep_obter_regra_inclusao(	'M',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									b.cd_material,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									null,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									d.nr_seq_exame) = 'S' -- nr_seq_exame_p
	and	((coalesce(b.ie_checar_adep,'N') = 'S') or (ie_adm_associados_proc_w = 'S'))
	and	obter_se_ctrl_glic_proc(d.nr_seq_proc_interno) = 'N'
	and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
	group by
		'IA',
		a.nr_prescricao,
		b.nr_sequencia,
		b.cd_material,
		b.cd_intervalo,
		b.ie_acm,
		b.ie_se_necessario,
		b.cd_intervalo,
		c.qt_dose,
		null,
		0,
		CASE WHEN CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END ='S' THEN 				CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao, b.nr_sequencia, ie_agrupar_acm_sn_w)='N' THEN  CASE WHEN b.ie_suspenso='S' THEN 'S'  ELSE null END   ELSE null END   ELSE null END ,
		''
	
union

	select	'IAG' ie_tipo_item, -- Itens associados CCG
		a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
		to_char(b.cd_material) cd_item,
		substr(obter_desc_material(b.cd_material),1,100) ds_item,
		b.cd_intervalo cd_intervalo,
		c.qt_dose qt_item,
		CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(adep_obter_um_dosagem_prescr2(a.nr_prescricao, c.nr_sequencia),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(adep_obter_um_dosagem_prescr2(a.nr_prescricao, c.nr_sequencia),1,100)  ELSE substr(adep_obter_um_dosagem_prescr2(a.nr_prescricao, c.nr_sequencia),1,100) END  END  ds_prescricao,
		null ie_classif_adep,
		0 nr_seq_proc_interno,
		CASE WHEN CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END ='S' THEN 				CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao, b.nr_sequencia, ie_agrupar_acm_sn_w)='N' THEN  CASE WHEN b.ie_suspenso='S' THEN 'S'  ELSE null END   ELSE null END   ELSE null END  ie_suspenso,
		null ds_informacao,
		0 nr_seq_proc,
		'' ie_pendente_liberacao,
		0 nr_agrupamento,
		null nr_seq_lab
	from	prescr_procedimento d,
		prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
	where	d.nr_prescricao = b.nr_prescricao
	and	b.nr_sequencia_proc = d.nr_sequencia
	and	c.nr_prescricao = b.nr_prescricao
	and	c.nr_seq_material = b.nr_sequencia
	and	b.nr_prescricao = a.nr_prescricao
	and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
	and	coalesce(a.ie_adep,'S') = 'S'
	and	b.ie_agrupador in (5)
	and	obter_se_gerar_item_adep('M', b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento,'S') = 'S'
	and	coalesce(c.ie_situacao,'A') = 'A'
	and	coalesce(c.ie_dose_especial,'N') = 'N'
	and	coalesce(c.ie_adep,'S') = 'S'
	and	a.nr_atendimento = nr_atendimento_p
	and	a.dt_validade_prescr > dt_validade_w
	and	((c.dt_horario between dt_inicial_w and dt_final_w) or
		(((coalesce(b.ie_acm,'N') = 'S') or (coalesce(b.ie_se_necessario,'N') = 'S')) and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_w,dt_final_w) = 'S')))
	and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
	and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
	and	ie_proc_setor_user_p = 'N'
	and	adep_obter_regra_inclusao(	'M',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									b.cd_material,
									null,
									null,
									null,
									a.cd_setor_atendimento,
									null,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									d.nr_seq_exame) = 'S' -- nr_seq_exame_p
	and	((coalesce(b.ie_checar_adep,'N') = 'S') or (ie_adm_associados_proc_w = 'S'))
	--and	obter_se_ctrl_glic_proc(d.nr_seq_proc_interno) = 'N'
	and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
	group by
		'IAG',
		a.nr_prescricao,
		b.nr_sequencia,
		b.cd_material,
		b.cd_intervalo,
		c.nr_sequencia,
		b.ie_acm,
		b.ie_se_necessario,
		b.cd_intervalo,
		c.qt_dose,
		null,
		0,
		CASE WHEN CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END ='S' THEN 				CASE WHEN obter_se_agrupar_acm_sn_adep(a.nr_prescricao, b.nr_sequencia, ie_agrupar_acm_sn_w)='N' THEN  CASE WHEN b.ie_suspenso='S' THEN 'S'  ELSE null END   ELSE null END   ELSE null END ,
		''
	order by
		1, 2, 3, 6, 7
	)
group by
	ie_tipo_item,
	CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_item,ie_agrupar_acm_sn_w)='N' THEN  nr_prescricao  ELSE null END   ELSE CASE WHEN ie_pendente_liberacao='' THEN  CASE WHEN ie_tipo_item='HM' THEN nr_prescricao  ELSE CASE WHEN ie_tipo_item='G' THEN  nr_prescricao  ELSE CASE WHEN ie_tipo_item='SNE' THEN  nr_prescricao  ELSE null END  END  END   ELSE nr_prescricao END  END ,
		CASE WHEN ie_agrupa_proc_w='S' THEN  CASE WHEN ie_tipo_item='SNE' THEN  nr_seq_item  ELSE CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_item,ie_agrupar_acm_sn_w)='N' THEN  nr_seq_item  ELSE null END   ELSE null END  END   ELSE CASE WHEN ie_tipo_item='P' THEN  nr_seq_proc  ELSE CASE WHEN ie_tipo_item='HM' THEN  nr_seq_item  ELSE CASE WHEN ie_tipo_item='SNE' THEN  nr_seq_item  ELSE CASE WHEN ie_pendente_liberacao='' THEN  CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_item,ie_agrupar_acm_sn_w)='N' THEN  nr_seq_item  ELSE null END   ELSE null END   ELSE nr_seq_item END  END  END  END  END ,
	CASE WHEN ie_tipo_item='O' THEN ie_suspenso  ELSE CASE WHEN ie_tipo_item='SNE' THEN  substr(obter_status_solucao_prescr(2, nr_prescricao, nr_seq_item),1,3)  ELSE CASE WHEN ie_acm_sn='S' THEN  CASE WHEN obter_se_agrupar_acm_sn_adep(nr_prescricao,nr_seq_item,ie_agrupar_acm_sn_w)='N' THEN  CASE WHEN ie_suspenso='S' THEN 'S'  ELSE null END   ELSE null END   ELSE null END  END  END ,
	ie_acm_sn,
	cd_item,
	ds_item,
	cd_intervalo,
	qt_item,
	ds_prescricao,
	CASE WHEN ie_exibe_diluicao_w='S' THEN  CASE WHEN ie_tipo_item='M' THEN  CASE WHEN ie_acm_sn='S' THEN  substr(adep_obter_inf_dil_obs(nr_prescricao,nr_seq_item),1,2000)  ELSE null END  WHEN ie_tipo_item='O' THEN  ds_informacao WHEN ie_tipo_item='D' THEN  obter_inf_dieta_adep(nr_prescricao,null,'DI')  ELSE null END   ELSE null END ,
	ie_classif_adep,
	nr_seq_proc_interno,
	null,
	nr_seq_lab,
	ie_pendente_liberacao,
	nr_agrupamento

union

select	'E' ie_tipo_item, /* sae */
	a.nr_sequencia nr_prescricao,
	b.nr_sequencia nr_seq_item,
	null ie_status_item,
	coalesce(b.ie_se_necessario,'N') ie_acm_sn,
	to_char(b.nr_seq_proc) cd_item,
	substr(obter_desc_intervencoes(b.nr_seq_proc),1,240) ds_item,
	b.cd_intervalo cd_intervalo,
	null qt_item,
	CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_desc_intervalo_prescr(b.cd_intervalo),1,80)  ELSE substr(obter_desc_intervalo_prescr(b.cd_intervalo),1,80) END  ds_prescricao,
	null ds_diluicao,
	null ie_classif_adep,
	0 nr_seq_proc_interno,
	null,
	'' ie_pendente_liberacao,
	0 nr_agrupamento,
	null nr_seq_lab
from	pe_prescr_proc_hor c,
	pe_prescr_proc b,
	pe_prescricao a
where	c.nr_seq_pe_proc = b.nr_sequencia
and	b.nr_seq_prescr = a.nr_sequencia
and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and	coalesce(b.ie_adep,'N') = 'M'
and	coalesce(c.ie_situacao,'A') = 'A'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	coalesce(b.dt_suspensao::text, '') = ''
and	((c.dt_horario between dt_inicial_w and dt_final_w) or
	((coalesce(b.ie_se_necessario,'N') = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_w,dt_final_w) = 'S')))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
--and	ie_proc_setor_user_p = 'N'
and	obter_se_exibir_interv_adep(ie_proc_setor_user_p,ie_interv_setor_user_p,b.nr_seq_proc,cd_perfil_p,cd_setor_atend_w,nm_usuario_p) = 'S'
and	adep_obter_regra_inclusao(	'SAE',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								null,
								null,
								null,
								null,
								null,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	coalesce(a.ie_situacao, 'A') = 'A'
group by
	'E',
	a.nr_sequencia,
	b.nr_sequencia,
	b.nr_seq_proc,
	b.cd_intervalo,
	b.ie_se_necessario,
	'N',
	b.cd_intervalo,
	null,
	0,
	''

union

select	'B' ie_tipo_item, /* Ordens Médicas */
	a.nr_prescricao nr_prescricao,
	coalesce(a.nr_seq_material, a.nr_seq_solucao) nr_seq_item,
	substr(obter_status_hor_prescr(b.nr_sequencia, 'B'),1,1) ie_status_item,
	'N' ie_acm_sn,
	to_char(b.nr_sequencia) cd_item,
	substr(Obter_Desc_ordem_medica(a.nr_seq_ordem),1,240) ds_item,
	'X' cd_intervalo,
	0 qt_item,
	'Item: ' || substr(coalesce(obter_desc_solucao_adep(a.nr_prescricao,a.nr_seq_solucao), obter_desc_material(obter_dados_material_prescr(a.nr_prescricao, a.nr_seq_material, 'CD_MATERIAL'))),1,255) ds_prescricao,
	substr(a.ds_ordem,1,255) ds_diluicao,
	null ie_classif_adep,
	0 nr_seq_proc_interno,
	null,
	'' ie_pendente_liberacao,
	0 nr_agrupamento,
	null nr_seq_lab
from	prescr_medica_ordem a,
	prescr_ordem_hor b
where	a.nr_atendimento = nr_atendimento_p
and	a.nr_sequencia	= b.nr_seq_ordem
and	(((ie_horario_realizado_p = 'N') and (coalesce(a.dt_realizacao::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	ie_exibir_ordem_w	= 'G'
group by a.nr_prescricao,
	coalesce(a.nr_seq_material, a.nr_seq_solucao),
	substr(obter_status_hor_prescr(b.nr_sequencia, 'B'),1,1),
	to_char(b.nr_sequencia),
	substr(Obter_Desc_ordem_medica(a.nr_seq_ordem),1,240),
	'Item: ' || substr(coalesce(obter_desc_solucao_adep(a.nr_prescricao,a.nr_seq_solucao), obter_desc_material(obter_dados_material_prescr(a.nr_prescricao, a.nr_seq_material, 'CD_MATERIAL'))),1,255),
	substr(a.ds_ordem,1,255)

union

select	'SOL' ie_tipo_item, /* solução */
	a.nr_prescricao nr_prescricao,
	b.nr_seq_solucao nr_seq_item,
	substr(obter_status_solucao_prescr(1, a.nr_prescricao, b.nr_seq_solucao),1,3) ie_status_item,
	--nvl(b.ie_acm,'N') ie_acm_sn,
	CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
	'0' cd_item,
	substr(coalesce(b.ds_solucao,obter_prim_comp_sol(b.nr_prescricao,b.nr_seq_solucao)),1,240) ds_item,
	null cd_intervalo,
	null qt_item,
	--null ds_prescricao,
	CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(Obter_Desc_Vol_Sol_etapa_adep(a.nr_prescricao,b.nr_seq_solucao),1,255)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(Obter_Desc_Vol_Sol_etapa_adep(a.nr_prescricao,b.nr_seq_solucao),1,255)  ELSE substr(Obter_Desc_Vol_Sol_etapa_adep(a.nr_prescricao,b.nr_seq_solucao),1,255) END  END  ds_prescricao,
	substr(obter_componentes_solucao(b.nr_prescricao, b.nr_seq_solucao,'S', nm_usuario_p, cd_estabelecimento_p),1,240) ds_diluicao, /* Dalcastagne em 08/11/2008 OS 114892 */
	null ie_classif_adep,
	0 nr_seq_proc_interno,
	b.dt_prev_prox_etapa,
	'' ie_pendente_liberacao,
	0 nr_agrupamento,
	null nr_seq_lab
from	prescr_solucao b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
and	coalesce(b.nr_seq_dialise::text, '') = ''
and	obter_se_prescr_lib_adep(coalesce(a.dt_liberacao_medico, b.dt_lib_material), coalesce(a.dt_liberacao, b.dt_lib_material), coalesce(a.dt_liberacao_farmacia, b.dt_lib_farmacia), ie_data_lib_prescr_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	a.nr_atendimento = nr_atendimento_p
and	(((b.dt_status between dt_inicial_w and dt_final_w) or (b.ie_status in ('I','INT'))) or
	 ((coalesce(b.ie_se_necessario,'N') = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_w,dt_final_w) = 'S')) or
	 ((coalesce(b.ie_acm,'N') = 'S') and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_w,dt_final_w) = 'S')))
and	ie_proc_setor_user_p = 'N'
and	((ie_horario_realizado_p = 'N' AND b.ie_status <> 'T') or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(b.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	adep_obter_regra_inclusao(	'SOL',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								null,
								null,
								null,
								null,
								a.cd_setor_atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	((ie_sol_continuas_p = 'S') or
	((ie_sol_continuas_p = 'N') and (Obter_Se_Sol_Continua(a.nr_prescricao, b.nr_seq_solucao, b.ds_solucao) = 'N')))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(b.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	((ie_exibir_col_pend_w = 'N') or (	select	coalesce(max('S'),'N')
		from	prescr_mat_hor
		where	nr_prescricao = a.nr_prescricao
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S') = 'S')
group by
	'S',
	a.nr_prescricao,
	b.nr_seq_solucao,
	1,
	b.ie_acm,
	b.ie_se_necessario,
	null,
	substr(coalesce(b.ds_solucao,obter_prim_comp_sol(b.nr_prescricao,b.nr_seq_solucao)),1,240),
	substr(obter_componentes_solucao(b.nr_prescricao, b.nr_seq_solucao,'S', nm_usuario_p, cd_estabelecimento_p),1,240),
	0,
	b.dt_prev_prox_etapa,
	''

union

select	'SOL' ie_tipo_item, /* solução  Pendente liberação enfermagem, farmácia*/
	a.nr_prescricao nr_prescricao,
	b.nr_seq_solucao nr_seq_item,
	substr(obter_status_solucao_prescr(1, a.nr_prescricao, b.nr_seq_solucao),1,3) ie_status_item,
	--nvl(b.ie_acm,'N') ie_acm_sn,
	CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
	'0' cd_item,
	substr(coalesce(b.ds_solucao,obter_prim_comp_sol(b.nr_prescricao,b.nr_seq_solucao)),1,240) ds_item,
	null cd_intervalo,
	null qt_item,
	--null ds_prescricao,
	CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(Obter_Desc_Vol_Sol_etapa_adep(a.nr_prescricao,b.nr_seq_solucao),1,255)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(Obter_Desc_Vol_Sol_etapa_adep(a.nr_prescricao,b.nr_seq_solucao),1,255)  ELSE substr(Obter_Desc_Vol_Sol_etapa_adep(a.nr_prescricao,b.nr_seq_solucao),1,255) END  END  ds_prescricao,
	substr(obter_componentes_solucao(b.nr_prescricao, b.nr_seq_solucao,'S', nm_usuario_p, cd_estabelecimento_p),1,240) ds_diluicao, /* Dalcastagne em 08/11/2008 OS 114892 */
	null ie_classif_adep,
	0 nr_seq_proc_interno,
	b.dt_prev_prox_etapa,
	CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'E'  ELSE CASE WHEN coalesce(a.dt_liberacao_farmacia::text, '') = '' THEN  'F'  ELSE '' END  END  ie_pendente_liberacao,
	0 nr_agrupamento,
	null nr_seq_lab
from	prescr_solucao b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
and	ie_exibir_col_pend_w = 'S'
and	coalesce(b.nr_seq_dialise::text, '') = ''
and	coalesce(a.ie_adep,'S') = 'S'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	((coalesce(a.dt_liberacao::text, '') = '') or (coalesce(a.dt_liberacao_farmacia::text, '') = ''))
and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
and	ie_proc_setor_user_p = 'N'
and	adep_obter_regra_inclusao(	'SOL',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								null,
								null,
								null,
								null,
								a.cd_setor_atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	((ie_sol_continuas_p = 'S') or
	((ie_sol_continuas_p = 'N') and (Obter_Se_Sol_Continua(a.nr_prescricao, b.nr_seq_solucao, b.ds_solucao) = 'N')))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(b.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	((	select	coalesce(max('S'),'N')
		from	prescr_mat_hor
		where	nr_prescricao = a.nr_prescricao
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S') = 'N')
group by
	'S',
	a.nr_prescricao,
	b.nr_seq_solucao,
	1,
	b.ie_acm,
	b.ie_se_necessario,
	null,
	substr(coalesce(b.ds_solucao,obter_prim_comp_sol(b.nr_prescricao,b.nr_seq_solucao)),1,240),
	substr(obter_componentes_solucao(b.nr_prescricao, b.nr_seq_solucao,'S', nm_usuario_p, cd_estabelecimento_p),1,240),
	CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'E'  ELSE CASE WHEN coalesce(a.dt_liberacao_farmacia::text, '') = '' THEN  'F'  ELSE '' END  END ,
	0,
	b.dt_prev_prox_etapa,
	''

union

select	'L' ie_tipo_item, /* coletas */
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	substr(obter_status_item_prescr(a.nr_prescricao, b.nr_sequencia, 'P'),1,2) ie_status_item,
	CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
	to_char(b.cd_procedimento) cd_item,
	CASE WHEN ie_apelido_exame_w='N' THEN  CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_desc_exame_lab(b.nr_seq_exame, null, b.cd_procedimento, b.ie_origem_proced),1,240)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_desc_exame_lab(b.nr_seq_exame, null, b.cd_procedimento, b.ie_origem_proced),1,240)  ELSE substr(obter_desc_exame_lab(b.nr_seq_exame, null, b.cd_procedimento, b.ie_origem_proced),1,240) END  END  WHEN ie_apelido_exame_w=CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(b.ds_rotina,1,240) END  THEN 				CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(b.ds_rotina,1,240) END   ELSE substr(b.ds_rotina,1,240) END  ds_item,
	b.cd_intervalo cd_intervalo,
	b.qt_procedimento qt_item,
	substr(obter_material_exame_lab(null, b.cd_material_exame,3),1,240) ds_prescricao,
	null ds_diluicao,
	null ie_classif_adep,
	coalesce(b.nr_seq_proc_interno,0) nr_seq_proc_interno,
	null,
	'' ie_pendente_liberacao,
	0 nr_agrupamento,
	null nr_seq_lab
from	prescr_proc_hor c,
	prescr_procedimento b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_procedimento = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
and	(obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '')
and	obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(b.nr_seq_solic_sangue::text, '') = ''
and	coalesce(b.nr_seq_derivado::text, '') = ''
and	(b.nr_seq_exame IS NOT NULL AND b.nr_seq_exame::text <> '')
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	((c.dt_horario between dt_inicial_w and dt_final_w) or
	(((coalesce(b.ie_acm,'N') = 'S') or (coalesce(b.ie_se_necessario,'N') = 'S')) and (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_w,dt_final_w) = 'S')))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	ie_proc_setor_user_p = 'N'
and	adep_obter_regra_inclusao(	'LAB',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								null,
								b.cd_procedimento,
								b.ie_origem_proced,
								b.nr_seq_proc_interno,
								a.cd_setor_atendimento,
								b.cd_setor_atendimento,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								b.nr_seq_exame) = 'S' -- nr_seq_exame_p
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	((ie_exibir_col_pend_w = 'N') or (	select	coalesce(max('S'),'N')
		from	prescr_proc_hor
		where	nr_prescricao = a.nr_prescricao
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S') = 'S')
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
group by
	'L',
	a.nr_prescricao,
	b.nr_sequencia,
	b.cd_procedimento,
	b.ie_origem_proced,
	b.cd_material_exame,
	b.nr_seq_exame,
	b.cd_intervalo,
	b.qt_procedimento,
	substr(b.ds_rotina,1,240),
	b.ie_acm,
	b.ie_se_necessario,
	null,
	b.nr_seq_proc_interno,
	''

union

select	'L' ie_tipo_item, /* coletas Pendente liberação enfermagem, farmácia */
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	substr(obter_status_item_prescr(a.nr_prescricao, b.nr_sequencia, 'P'),1,2) ie_status_item,
	CASE WHEN coalesce(b.ie_acm,'N')='S' THEN  'S'  ELSE CASE WHEN coalesce(b.ie_se_necessario,'N')='S' THEN  'S'  ELSE 'N' END  END  ie_acm_sn,
	to_char(b.cd_procedimento) cd_item,
	CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_desc_exame_lab(b.nr_seq_exame, null, b.cd_procedimento, b.ie_origem_proced),1,240)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_desc_exame_lab(b.nr_seq_exame, null, b.cd_procedimento, b.ie_origem_proced),1,240)  ELSE substr(obter_desc_exame_lab(b.nr_seq_exame, null, b.cd_procedimento, b.ie_origem_proced),1,240) END  END  ds_item,
	b.cd_intervalo cd_intervalo,
	b.qt_procedimento qt_item,
	substr(obter_material_exame_lab(null, b.cd_material_exame,3),1,240) ds_prescricao,
	null ds_diluicao,
	null ie_classif_adep,
	coalesce(b.nr_seq_proc_interno,0) nr_seq_proc_interno,
	null,
	CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'E'  ELSE CASE WHEN coalesce(a.dt_liberacao_farmacia::text, '') = '' THEN  'F'  ELSE '' END  END  ie_pendente_liberacao,
	0 nr_agrupamento,
	null nr_seq_lab
from	prescr_procedimento b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
and	((coalesce(a.dt_liberacao::text, '') = '') or (coalesce(a.dt_liberacao_farmacia::text, '') = ''))
and	(a.dt_liberacao_medico IS NOT NULL AND a.dt_liberacao_medico::text <> '')
and	ie_proc_setor_user_p = 'N'
and	ie_exibir_col_pend_w = 'S'
and	obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	coalesce(b.nr_seq_solic_sangue::text, '') = ''
and	coalesce(b.nr_seq_derivado::text, '') = ''
and	(b.nr_seq_exame IS NOT NULL AND b.nr_seq_exame::text <> '')
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	ie_proc_setor_user_p = 'N'
and	adep_obter_regra_inclusao(	'LAB',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								null,
								b.cd_procedimento,
								b.ie_origem_proced,
								b.nr_seq_proc_interno,
								a.cd_setor_atendimento,
								b.cd_setor_atendimento,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								b.nr_seq_exame) = 'S' -- nr_seq_exame_p
and	(((ie_horario_suspenso_p = 'N') and (coalesce(b.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	((	select	coalesce(max('S'),'N')
		from	prescr_proc_hor
		where	nr_prescricao = a.nr_prescricao
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S') = 'N')
group by
	'L',
	a.nr_prescricao,
	b.nr_sequencia,
	CASE WHEN coalesce(a.dt_liberacao::text, '') = '' THEN  'E'  ELSE CASE WHEN coalesce(a.dt_liberacao_farmacia::text, '') = '' THEN  'F'  ELSE '' END  END ,
	b.cd_procedimento,
	b.ie_origem_proced,
	b.cd_material_exame,
	b.nr_seq_exame,
	b.cd_intervalo,
	b.qt_procedimento,
	b.ie_acm,
	b.ie_se_necessario,
	b.nr_seq_proc_interno;

/* obter itens x horários */

c03 CURSOR FOR
SELECT	'D' ie_tipo_item, /* dieta oral */
	a.nr_prescricao nr_prescricao,
	null nr_seq_item,
	c.cd_refeicao cd_item,
	c.nr_sequencia nr_seq_hor,
	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario,
	substr(obter_status_hor_prescr(c.nr_sequencia, 'D'),1,1) ie_status,
	null ds_prescricao,
	'N' ie_diferenciado,
	(obter_inf_dieta_adep(a.nr_prescricao,null,'DI') || ' - Obs: ' || c.ds_observacao) ds_diluicao,
	null nr_dia_util,
	0 nr_seq_proc_interno,
	null cd_intervalo,
	'' ie_medic_controlado,
	0 nr_agrupamento,
	c.dt_suspensao dt_suspensao,
	0 qt_dose
from	prescr_dieta_hor c,
	prescr_medica a
where	c.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	c.dt_horario = to_date(vetor_w[ind].nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
and	ie_proc_setor_user_p = 'N'
and	adep_obter_regra_inclusao(	'DO',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								null,
								null,
								null,
								null,
								a.cd_setor_atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	ie_dieta_sem_horario_w = 'S'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	'D' ie_tipo_item, /* dieta oral  sem horários*/
	a.nr_prescricao nr_prescricao,
	null nr_seq_item,
	to_char(d.cd_dieta) cd_item,
	c.nr_sequencia nr_seq_hor,
	null ds_horario,
	substr(obter_status_hor_prescr(c.nr_sequencia, 'D'),1,1) ie_status,
	null ds_prescricao,
	'N' ie_diferenciado,
	(obter_inf_dieta_adep(a.nr_prescricao,null,'DI')  || ' - Obs: ' || c.ds_observacao) ds_diluicao,
	null nr_dia_util,
	0 nr_seq_proc_interno,
	null cd_intervalo,
	'' ie_medic_controlado,
	0 nr_agrupamento,
	c.dt_suspensao dt_suspensao,
	0 qt_dose
from	prescr_dieta d,
	prescr_dieta_hor c,
	prescr_medica a
where	c.nr_prescricao = a.nr_prescricao
and	a.nr_prescricao = d.nr_prescricao
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	ie_proc_setor_user_p = 'N'
and	adep_obter_regra_inclusao(	'DO',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								null,
								null,
								null,
								null,
								a.cd_setor_atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	ie_dieta_sem_horario_w = 'N'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	'S' ie_tipo_item, /* suplemento oral */
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.cd_material) cd_item,
	c.nr_sequencia nr_seq_hor,
	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario,
	substr(obter_status_hor_prescr(c.nr_sequencia, 'S'),1,1) ie_status,
	CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100) END  END  ds_prescricao,
	'N' ie_diferenciado,
	null ds_diluicao,
	null nr_dia_util,
	0 nr_seq_proc_interno,
	b.cd_intervalo,
	'' ie_medic_controlado,
	0 nr_agrupamento,
	c.dt_suspensao dt_suspensao,
	0 qt_dose
from	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	b.ie_agrupador in (12)
and	coalesce(c.ie_situacao,'A') = 'A'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	c.dt_horario = to_date(vetor_w[ind].nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
and	ie_proc_setor_user_p = 'N'
and	adep_obter_regra_inclusao(	'SO',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								b.cd_material,
								null,
								null,
								null,
								a.cd_setor_atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	'SNE' ie_tipo_item,  --Suporte nutricional enteral
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.cd_material) cd_item,
	c.nr_sequencia nr_seq_hor,
	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario,
	substr(obter_status_solucao_prescr(2, a.nr_prescricao, b.nr_sequencia),1,3) ie_status_item,
	CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100) END  END  ds_prescricao,
	'N' ie_diferenciado,
	null ds_diluicao,
	null nr_dia_util,
	0 nr_seq_proc_interno,
	b.cd_intervalo,
	'' ie_medic_controlado,
	0 nr_agrupamento,
	c.dt_suspensao dt_suspensao,
	b.qt_dose
from	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	b.ie_agrupador in (8)
and	b.ie_status = 'N'
and	coalesce(c.ie_situacao,'A') = 'A'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	((ie_horario_realizado_p = 'N' AND b.ie_status <> 'T') or (ie_horario_realizado_p = 'S'))
and	((ie_horario_suspenso_p = 'N' AND b.ie_status <> 'S') or (ie_horario_suspenso_p = 'S'))
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	c.dt_horario = to_date(vetor_w[ind].nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
and	ie_proc_setor_user_p = 'N'
and	adep_obter_regra_inclusao(	'SNE',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								b.cd_material,
								null,
								null,
								null,
								a.cd_setor_atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	'M' ie_tipo_item, -- medicamentos
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.cd_material) cd_item,
	c.nr_sequencia nr_seq_hor,
	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario,
	substr(obter_status_hor_prescr(c.nr_sequencia, 'M'),1,1) ie_status,
	CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100) END  END  ds_prescricao,
	substr(coalesce(obter_se_item_dif_adep(b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento, 'M',ie_verifica_dif_w, b.ds_observacao),'N'),1,1) ie_diferenciado,
	substr(adep_obter_inf_dil_obs(a.nr_prescricao,b.nr_sequencia),1,2000) ds_diluicao,
	b.nr_dia_util nr_dia_util,
	0 nr_seq_proc_interno,
	b.cd_intervalo,
	c.ie_controlado ie_medic_controlado,
	CASE WHEN obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material)='S' THEN  b.nr_agrupamento  ELSE 0 END  nr_agrupamento,
	c.dt_suspensao dt_suspensao,
	0 qt_dose
from	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	obter_se_prescr_lib_adep(coalesce(a.dt_liberacao_medico, b.dt_lib_material), coalesce(a.dt_liberacao,b.dt_lib_material), coalesce(a.dt_liberacao_farmacia, b.dt_lib_farmacia), ie_data_lib_prescr_w) = 'S'
and	b.ie_agrupador in (1)
and	coalesce(a.ie_adep,'S') = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_dose_especial,'N') = 'N'
and	coalesce(c.ie_adep,'S') = 'S'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	c.dt_horario = to_date(vetor_w[ind].nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
and	ie_proc_setor_user_p = 'N'
and	adep_obter_regra_inclusao(	'MED',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								b.cd_material,
								null,
								null,
								null,
								a.cd_setor_Atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	coalesce(ie_agrupar_de_w,'N') = 'N'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	'M' ie_tipo_item, -- medicamentos - dose especial
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.cd_material) cd_item,
	c.nr_sequencia nr_seq_hor,
	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario,
	substr(obter_status_hor_prescr(c.nr_sequencia, 'M'),1,1) ie_status,
	'DE ' || to_char(b.qt_dose_especial) || ' ' || b.cd_unidade_medida_dose,
	substr(coalesce(obter_se_item_dif_adep(b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento,'M',ie_verifica_dif_w, b.ds_observacao),'N'),1,1) ie_diferenciado,
	substr(adep_obter_inf_dil_obs(a.nr_prescricao,b.nr_sequencia),1,2000) ds_diluicao,
	b.nr_dia_util nr_dia_util,
	0 nr_seq_proc_interno,
	b.cd_intervalo,
	c.ie_controlado ie_medic_controlado,
	CASE WHEN obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material)='S' THEN  b.nr_agrupamento  ELSE 0 END  nr_agrupamento,
	c.dt_suspensao dt_suspensao,
	0 qt_dose
from	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	obter_se_prescr_lib_adep(coalesce(a.dt_liberacao_medico, b.dt_lib_material), coalesce(a.dt_liberacao,b.dt_lib_material), coalesce(a.dt_liberacao_farmacia, b.dt_lib_farmacia), ie_data_lib_prescr_w) = 'S'
and	b.ie_agrupador in (1)
and	coalesce(a.ie_adep,'S') = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_dose_especial,'N') = 'S'
and	coalesce(c.ie_adep,'S') = 'S'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	c.dt_horario = to_date(vetor_w[ind].nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
and	ie_proc_setor_user_p = 'N'
and	adep_obter_regra_inclusao(	'MED',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								b.cd_material,
								null,
								null,
								null,
								a.cd_setor_Atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	coalesce(ie_agrupar_de_w,'N') = 'N'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	'M' ie_tipo_item, -- medicamentos
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.cd_material) cd_item,
	c.nr_sequencia nr_seq_hor,
	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario,
	substr(obter_status_hor_prescr(c.nr_sequencia, 'M'),1,1) ie_status,
	CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100) END  END  ds_prescricao,
	substr(coalesce(obter_se_item_dif_adep(b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento, 'M',ie_verifica_dif_w, b.ds_observacao),'N'),1,1) ie_diferenciado,
	substr(adep_obter_inf_dil_obs(a.nr_prescricao,b.nr_sequencia),1,2000) ds_diluicao,
	b.nr_dia_util nr_dia_util,
	0 nr_seq_proc_interno,
	b.cd_intervalo,
	c.ie_controlado ie_medic_controlado,
	CASE WHEN obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material)='S' THEN  b.nr_agrupamento  ELSE 0 END  nr_agrupamento,
	c.dt_suspensao dt_suspensao,
	0 qt_dose
from	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	obter_se_prescr_lib_adep(coalesce(a.dt_liberacao_medico, b.dt_lib_material), coalesce(a.dt_liberacao,b.dt_lib_material), coalesce(a.dt_liberacao_farmacia, b.dt_lib_farmacia), ie_data_lib_prescr_w) = 'S'
and	b.ie_agrupador in (1)
and	coalesce(a.ie_adep,'S') = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
--and	nvl(c.ie_dose_especial,'N') = 'N'
and	coalesce(c.ie_adep,'S') = 'S'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	c.dt_horario = to_date(vetor_w[ind].nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
and	ie_proc_setor_user_p = 'N'
and	adep_obter_regra_inclusao(	'MED',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								b.cd_material,
								null,
								null,
								null,
								a.cd_setor_Atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	coalesce(ie_agrupar_de_w,'N') = 'S'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	'ME' ie_tipo_item, -- medicamentos
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.cd_material) cd_item,
	c.nr_sequencia nr_seq_hor,
	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario,
	substr(obter_status_hor_prescr(c.nr_sequencia, 'M'),1,1) ie_status,
	CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100) END  END  ds_prescricao,
	substr(coalesce(obter_se_item_dif_adep(b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento, 'M',ie_verifica_dif_w, b.ds_observacao),'N'),1,1) ie_diferenciado,
	substr(adep_obter_inf_dil_obs(a.nr_prescricao,b.nr_sequencia),1,2000) ds_diluicao,
	b.nr_dia_util nr_dia_util,
	0 nr_seq_proc_interno,
	b.cd_intervalo,
	c.ie_controlado ie_medic_controlado,
	CASE WHEN obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material)='S' THEN  b.nr_agrupamento  ELSE 0 END  nr_agrupamento,
	c.dt_suspensao dt_suspensao,
	0 qt_dose
from	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	b.ie_agrupador in (14)
and	c.nr_seq_dialise = nr_seq_dialise_p
and	coalesce(a.ie_adep,'S') = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_dose_especial,'N') = 'N'
and	coalesce(c.ie_adep,'S') = 'S'
and	a.nr_atendimento = nr_atendimento_p
--and	a.dt_validade_prescr > sysdate - qt_hora_prescricao_p/24
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	c.dt_horario = to_date(vetor_w[ind].nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
and	ie_proc_setor_user_p = 'N'
and	coalesce(ie_agrupar_de_w,'N') = 'N'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	'ME' ie_tipo_item, -- medicamentos - dose especial
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.cd_material) cd_item,
	c.nr_sequencia nr_seq_hor,
	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario,
	substr(obter_status_hor_prescr(c.nr_sequencia, 'M'),1,1) ie_status,
	'DE ' || to_char(b.qt_dose_especial) || ' ' || b.cd_unidade_medida_dose,
	substr(coalesce(obter_se_item_dif_adep(b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento,'ME',ie_verifica_dif_w, b.ds_observacao),'N'),1,1) ie_diferenciado,
	substr(adep_obter_inf_dil_obs(a.nr_prescricao,b.nr_sequencia),1,2000) ds_diluicao,
	b.nr_dia_util nr_dia_util,
	0 nr_seq_proc_interno,
	b.cd_intervalo,
	c.ie_controlado ie_medic_controlado,
	CASE WHEN obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material)='S' THEN  b.nr_agrupamento  ELSE 0 END  nr_agrupamento,
	c.dt_suspensao dt_suspensao,
	0 qt_dose
from	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	b.ie_agrupador in (14)
and	c.nr_seq_dialise = nr_seq_dialise_p
and	coalesce(a.ie_adep,'S') = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_dose_especial,'N') = 'S'
and	coalesce(c.ie_adep,'S') = 'S'
and	a.nr_atendimento = nr_atendimento_p
--and	a.dt_validade_prescr > sysdate - qt_hora_prescricao_p/24
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	c.dt_horario = to_date(vetor_w[ind].nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
and	ie_proc_setor_user_p = 'N'
and	coalesce(ie_agrupar_de_w,'N') = 'N'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	'ME' ie_tipo_item, -- medicamentos
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.cd_material) cd_item,
	c.nr_sequencia nr_seq_hor,
	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario,
	substr(obter_status_hor_prescr(c.nr_sequencia, 'M'),1,1) ie_status,
	CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100) END  END  ds_prescricao,
	substr(coalesce(obter_se_item_dif_adep(b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento,'ME',ie_verifica_dif_w, b.ds_observacao),'N'),1,1) ie_diferenciado,
	substr(adep_obter_inf_dil_obs(a.nr_prescricao,b.nr_sequencia),1,2000) ds_diluicao,
	b.nr_dia_util nr_dia_util,
	0 nr_seq_proc_interno,
	b.cd_intervalo,
	c.ie_controlado ie_medic_controlado,
	CASE WHEN obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material)='S' THEN  b.nr_agrupamento  ELSE 0 END  nr_agrupamento,
	c.dt_suspensao dt_suspensao,
	0 qt_dose
from	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	b.ie_agrupador in (14)
and	c.nr_seq_dialise = nr_seq_dialise_p
and	coalesce(a.ie_adep,'S') = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
--and	nvl(c.ie_dose_especial,'N') = 'N'
and	coalesce(c.ie_adep,'S') = 'S'
and	a.nr_atendimento = nr_atendimento_p
--and	a.dt_validade_prescr > sysdate - qt_hora_prescricao_p/24
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	c.dt_horario = to_date(vetor_w[ind].nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
and	ie_proc_setor_user_p = 'N'
and	adep_obter_regra_inclusao(	'MED',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								b.cd_material,
								null,
								null,
								null,
								a.cd_setor_Atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	coalesce(ie_agrupar_de_w,'N') = 'S'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	'MAT' ie_tipo_item, /* materiais */
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.cd_material) cd_item,
	c.nr_sequencia nr_seq_hor,
	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario,
	substr(obter_status_hor_prescr(c.nr_sequencia, 'M'),1,1) ie_status,
	CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100) END  END  ds_prescricao,
	'N' ie_diferenciado,
	null ds_diluicao,
	null nr_dia_util,
	0 nr_seq_proc_interno,
	b.cd_intervalo,
	'' ie_medic_controlado,
	0 nr_agrupamento,
	c.dt_suspensao dt_suspensao,
	0 qt_dose
from	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	b.ie_agrupador in (2)
and	coalesce(a.ie_adep,'S') = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_dose_especial,'N') = 'N'
and	coalesce(c.ie_adep,'S') = 'S'
--and	obter_se_material_adep(a.cd_estabelecimento,b.cd_material) = 'S'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	c.dt_horario = to_date(vetor_w[ind].nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
and	ie_proc_setor_user_p = 'N'
and	adep_obter_regra_inclusao(	'MAT',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								b.cd_material,
								null,
								null,
								null,
								a.cd_setor_Atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	CASE WHEN coalesce(b.nr_seq_exame::text, '') = '' THEN 'P'  ELSE 'L' END  ie_tipo_item, /* procedimentos */
	a.nr_prescricao nr_prescricao,
	CASE WHEN obter_se_associado_dif(a.nr_prescricao, b.nr_sequencia)='N' THEN   (b.nr_sequencia||a.nr_prescricao)::numeric   ELSE b.nr_sequencia END  nr_seq_item,

	to_char(b.cd_procedimento) cd_item,
	c.nr_sequencia nr_seq_hor,
	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario,
	substr(obter_status_hor_prescr(c.nr_sequencia, 'P'),1,1) ie_status,
	CASE WHEN coalesce(b.nr_seq_exame::text, '') = '' THEN CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL','S'),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL','S'),1,100)  ELSE substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL','S'),1,100) END  END   ELSE substr(obter_material_exame_lab(null, b.cd_material_exame,3),1,240) END  ds_prescricao,
	'N' ie_diferenciado,
	substr(obter_mat_med_assoc_proc(a.nr_prescricao,b.nr_sequencia, 'S'),1,2000) ds_diluicao,
	null nr_dia_util,
	coalesce(b.nr_seq_proc_interno,0) nr_seq_proc_interno,
	b.cd_intervalo,
	'' ie_medic_controlado,
	0 nr_agrupamento,
	c.dt_suspensao dt_suspensao,
	0 qt_dose
from	prescr_proc_hor c,
	prescr_procedimento b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_procedimento = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
and	(obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '')
and	obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(b.nr_seq_solic_sangue::text, '') = ''
and	coalesce(b.nr_seq_derivado::text, '') = ''
and	coalesce(b.nr_seq_prot_glic::text, '') = ''
and	substr(obter_ctrl_glic_proc(b.nr_seq_proc_interno),1,3) <> 'CIG'
and	obter_se_proc_IVC(b.nr_seq_proc_interno) <> 'S'
and	obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'G') <> 'S'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	c.dt_horario = to_date(vetor_w[ind].nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
and	((ie_proc_setor_user_p = 'N') or (adep_obter_se_setor_proc_user(nm_usuario_p,b.cd_setor_atendimento) = 'S'))
and	((adep_obter_regra_inclusao(	'PROC',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									b.cd_procedimento,
									b.ie_origem_proced,
									b.nr_seq_proc_interno,
									a.cd_setor_Atendimento,
									b.cd_setor_Atendimento,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									b.nr_seq_exame) = 'S') or  -- nr_seq_exame_p
	 (adep_obter_regra_inclusao(	'LAB',
									cd_estabelecimento_p,
									cd_setor_usuario_p,
									cd_perfil_p,
									null,
									b.cd_procedimento,
									b.ie_origem_proced,
									b.nr_seq_proc_interno,
									a.cd_setor_Atendimento,
									b.cd_setor_Atendimento,
									null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
									b.nr_seq_exame) = 'S')) -- nr_seq_exame_p
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	'HM' ie_tipo_item, /* Hemoterapia */
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.cd_procedimento) cd_item,
	c.nr_sequencia nr_seq_hor,
	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario,
	substr(obter_status_hor_prescr(c.nr_sequencia, 'P'),1,1) ie_status,
	CASE WHEN coalesce(b.nr_seq_exame::text, '') = '' THEN CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL','S'),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL','S'),1,100)  ELSE substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL','S'),1,100) END  END   ELSE substr(obter_material_exame_lab(null, b.cd_material_exame,3),1,240) END  ds_prescricao,
	'N' ie_diferenciado,
	substr(obter_mat_med_assoc_proc(a.nr_prescricao,b.nr_sequencia, 'S'),1,2000) ds_diluicao,
	null nr_dia_util,
	coalesce(b.nr_seq_proc_interno,0) nr_seq_proc_interno,
	b.cd_intervalo,
	'' ie_medic_controlado,
	0 nr_agrupamento,
	c.dt_suspensao dt_suspensao,
	0 qt_dose
from	prescr_proc_hor c,
	prescr_procedimento b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_procedimento = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
and	(obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '')
and	obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
and	(b.nr_seq_solic_sangue IS NOT NULL AND b.nr_seq_solic_sangue::text <> '')
and	(b.nr_seq_derivado IS NOT NULL AND b.nr_seq_derivado::text <> '')
and	coalesce(b.nr_seq_prot_glic::text, '') = ''
and	substr(obter_ctrl_glic_proc(b.nr_seq_proc_interno),1,3) <> 'CIG'
and	obter_se_proc_IVC(b.nr_seq_proc_interno) <> 'S'
and	obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'G') <> 'S'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	c.dt_horario = to_date(vetor_w[ind].nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
and	((ie_proc_setor_user_p = 'N') or (adep_obter_se_setor_proc_user(nm_usuario_p,b.cd_setor_atendimento) = 'S'))
and	adep_obter_regra_inclusao(	'HM',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								null,
								null,
								null,
								null,
								a.cd_setor_Atendimento,
								b.cd_setor_Atendimento,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								b.nr_seq_exame) = 'S' -- nr_seq_exame_p
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	'R' ie_tipo_item, /* recomendacoes */
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	coalesce(to_char(b.cd_recomendacao), b.ds_recomendacao) cd_item,
	c.nr_sequencia nr_seq_hor,
	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario,
	substr(obter_status_hor_prescr(c.nr_sequencia, 'R'),1,1) ie_status,
	substr(obter_desc_intervalo_prescr(b.cd_intervalo),1,100) ds_prescricao,
	'N' ie_diferenciado,
	null ds_diluicao,
	null nr_dia_util,
	0 nr_seq_proc_interno,
	b.cd_intervalo,
	'' ie_medic_controlado,
	0 nr_agrupamento,
	c.dt_suspensao dt_suspensao,
	0 qt_dose
from	prescr_rec_hor c,
	prescr_recomendacao b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_recomendacao = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	((ie_data_lib_prescr_w = 'F') or (obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'))
and	coalesce(a.ie_adep,'S') = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	c.dt_horario = to_date(vetor_w[ind].nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
and	ie_proc_setor_user_p = 'N'
and	adep_obter_regra_inclusao(	'REC',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								null,
								null,
								null,
								null,
								a.cd_setor_Atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	'E' ie_tipo_item, /* sae */
	a.nr_sequencia nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.nr_seq_proc) cd_item,
	c.nr_sequencia nr_seq_hor,
	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario,
	substr(obter_status_hor_prescr(c.nr_sequencia, 'E'),1,1) ie_status,
	CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_desc_intervalo_prescr(b.cd_intervalo),1,80)  ELSE substr(obter_desc_intervalo_prescr(b.cd_intervalo),1,80) END  ds_prescricao,
	'N' ie_diferenciado,
	substr(adep_obter_desc_ativ_interv(b.nr_seq_proc),1,2000) ds_diluicao,
	null nr_dia_util,
	0 nr_seq_proc_interno,
	b.cd_intervalo,
	'' ie_medic_controlado,
	0 nr_agrupamento,
	c.dt_suspensao dt_suspensao,
	0 qt_dose
from	pe_prescr_proc_hor c,
	pe_prescr_proc b,
	pe_prescricao a
where	c.nr_seq_pe_proc = b.nr_sequencia
and	b.nr_seq_prescr = a.nr_sequencia
and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and	coalesce(b.dt_suspensao::text, '') = ''
and	coalesce(b.ie_adep,'N') in ('S','M')
and	coalesce(c.ie_situacao,'A') = 'A'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	c.dt_horario = to_date(vetor_w[ind].nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
--and	ie_proc_setor_user_p = 'N'
and	obter_se_exibir_interv_adep(ie_proc_setor_user_p,ie_interv_setor_user_p,b.nr_seq_proc,cd_perfil_p,cd_setor_atend_w,nm_usuario_p) = 'S'
and	adep_obter_regra_inclusao(	'SAE',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								null,
								null,
								null,
								null,
								null,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	coalesce(a.ie_situacao, 'A') = 'A'

union

select	'G' ie_tipo_item, /* controle de glicemia */
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.cd_procedimento) cd_item,
	c.nr_sequencia nr_seq_hor,
	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario,
	substr(obter_status_hor_prescr(c.nr_sequencia, 'P'),1,1) ie_status,
	CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL',ie_exibe_dose_glicemia_w),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL',ie_exibe_dose_glicemia_w),1,100)  ELSE substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL',ie_exibe_dose_glicemia_w),1,100) END  END  ds_prescricao,
	'N' ie_diferenciado,
	obter_mat_med_assoc_ccg(b.nr_prescricao, b.nr_sequencia, ie_exibe_dose_glicemia_w) ds_diluicao,
	null nr_dia_util,
	coalesce(b.nr_seq_proc_interno,0) nr_seq_proc_interno,
	b.cd_intervalo,
	'' ie_medic_controlado,
	0 nr_agrupamento,
	c.dt_suspensao dt_suspensao,
	0 qt_dose
from	prescr_proc_hor c,
	prescr_procedimento b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_procedimento = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
and	(obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '')
and	obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	coalesce(b.nr_seq_solic_sangue::text, '') = ''
and	coalesce(b.nr_seq_derivado::text, '') = ''
and	coalesce(b.nr_seq_exame::text, '') = ''
and	(b.nr_seq_proc_interno IS NOT NULL AND b.nr_seq_proc_interno::text <> '')
and	(b.nr_seq_prot_glic IS NOT NULL AND b.nr_seq_prot_glic::text <> '')
and	coalesce(c.ie_situacao,'A') = 'A'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr >= dt_validade_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	c.dt_horario = to_date(vetor_w[ind].nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
and	ie_proc_setor_user_p = 'N'
and	adep_obter_regra_inclusao(	'CCG',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								null,
								b.cd_procedimento,
								b.ie_origem_proced,
								b.nr_seq_proc_interno,
								a.cd_setor_Atendimento,
								b.cd_setor_Atendimento,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								b.nr_seq_exame) = 'S' -- nr_seq_exame_p
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	'C' ie_tipo_item, /* cig */
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.cd_procedimento) cd_item,
	c.nr_sequencia nr_seq_hor,
	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario,
	substr(obter_status_hor_prescr(c.nr_sequencia, 'P'),1,1) ie_status,
	CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL',ie_exibe_dose_glicemia_w),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL',ie_exibe_dose_glicemia_w),1,100)  ELSE substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL',ie_exibe_dose_glicemia_w),1,100) END  END  ds_prescricao,
	'N' ie_diferenciado,
	obter_mat_med_assoc_proc(a.nr_prescricao, b.nr_sequencia, ie_exibe_dose_glicemia_w) ds_diluicao,
	null nr_dia_util,
	coalesce(b.nr_seq_proc_interno,0) nr_seq_proc_interno,
	b.cd_intervalo	,
	'' ie_medic_controlado,
	0 nr_agrupamento,
	c.dt_suspensao dt_suspensao,
	0 qt_dose
from	prescr_proc_hor c,
	prescr_procedimento b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_procedimento = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
and	(obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '')
and	obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	coalesce(b.nr_seq_solic_sangue::text, '') = ''
and	coalesce(b.nr_seq_derivado::text, '') = ''
and	coalesce(b.nr_seq_exame::text, '') = ''
and	(b.nr_seq_proc_interno IS NOT NULL AND b.nr_seq_proc_interno::text <> '')
and	substr(obter_ctrl_glic_proc(b.nr_seq_proc_interno),1,3) = 'CIG'
and	coalesce(c.ie_situacao,'A') = 'A'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr >= dt_validade_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	c.dt_horario = to_date(vetor_w[ind].nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
and	ie_proc_setor_user_p = 'N'
and	adep_obter_regra_inclusao(	'CIG',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								null,
								b.cd_procedimento,
								b.ie_origem_proced,
								b.nr_seq_proc_interno,
								a.cd_setor_Atendimento,
								b.cd_setor_Atendimento,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								b.nr_seq_exame) = 'S' -- nr_seq_exame_p
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	'I' ie_tipo_item, /* IVC */
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.cd_procedimento) cd_item,
	c.nr_sequencia nr_seq_hor,
	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario,
	substr(obter_status_hor_prescr(c.nr_sequencia, 'P'),1,1) ie_status,
	CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL','S'),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL','S'),1,100)  ELSE substr(obter_dados_prescr_proc(a.nr_prescricao, b.nr_sequencia, 'QIL','S'),1,100) END  END  ds_prescricao,
	'N' ie_diferenciado,
	null ds_diluicao,
	null nr_dia_util,
	coalesce(b.nr_seq_proc_interno,0) nr_seq_proc_interno,
	b.cd_intervalo,
	'' ie_medic_controlado,
	0 nr_agrupamento,
	c.dt_suspensao dt_suspensao,
	0 qt_dose
from	prescr_proc_hor c,
	prescr_procedimento b,
	prescr_medica a
where	c.nr_prescricao		= b.nr_prescricao
and	c.nr_seq_procedimento	= b.nr_sequencia
and	b.nr_prescricao		= a.nr_prescricao
and	(obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '')
and	obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'
and	coalesce(a.ie_adep,'S')	= 'S'
and	coalesce(c.ie_situacao,'A')	= 'A'
and	ie_proc_setor_user_p	= 'N'
and	a.nr_atendimento	= nr_atendimento_p
and	a.dt_validade_prescr	>= dt_validade_w
and	coalesce(b.nr_seq_solic_sangue::text, '') = ''
and	coalesce(b.nr_seq_derivado::text, '') = ''
and	coalesce(b.nr_seq_exame::text, '') = ''
and	(b.nr_seq_proc_interno IS NOT NULL AND b.nr_seq_proc_interno::text <> '')
and	coalesce(b.nr_seq_prot_glic::text, '') = ''
and	substr(obter_ctrl_glic_proc(b.nr_seq_proc_interno),1,3) <> 'CIG'
and	obter_se_proc_IVC(b.nr_seq_proc_interno) = 'S'
and	((coalesce(c.ie_horario_especial,'N')= 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p	= 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p	= 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	c.dt_horario			= to_date(vetor_w[ind].nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
and	adep_obter_regra_inclusao(	'IVC',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								null,
								b.cd_procedimento,
								b.ie_origem_proced,
								b.nr_seq_proc_interno,
								a.cd_setor_Atendimento,
								b.cd_setor_Atendimento,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								b.nr_seq_exame) = 'S' -- nr_seq_exame_p
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	'SOL' ie_tipo_item, /* solução */
	a.nr_prescricao nr_prescricao,
	b.nr_seq_solucao nr_seq_item,
	'0' cd_item,
	null nr_seq_hor,
	to_char(b.dt_status,'dd/mm/yyyy hh24:mi:ss') ds_horario,
	--'N' ie_status,
	substr(obter_status_hor_sol_processo(b.nr_prescricao, b.nr_seq_solucao, 1),1,15) ie_status,
	--null ds_prescricao,
	CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(Obter_Desc_Vol_Sol_etapa_adep(a.nr_prescricao,b.nr_seq_solucao),1,255)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(Obter_Desc_Vol_Sol_etapa_adep(a.nr_prescricao,b.nr_seq_solucao),1,255)  ELSE substr(Obter_Desc_Vol_Sol_etapa_adep(a.nr_prescricao,b.nr_seq_solucao),1,255) END  END  ds_prescricao,
	'N' ie_diferenciado,
	substr(obter_componentes_solucao(b.nr_prescricao, b.nr_seq_solucao,'S', nm_usuario_p, cd_estabelecimento_p),1,240) ds_diluicao, /* Dalcastagne em 08/11/2008 OS 114892 */
	null nr_dia_util,
	0 nr_seq_proc_interno,
	b.cd_intervalo,
	'' ie_medic_controlado,
	0 nr_agrupamento,
	b.dt_suspensao dt_suspensao,
	0 qt_dose
from	prescr_solucao b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
and	coalesce(b.nr_seq_dialise::text, '') = ''
and	b.ie_status = 'N'
and	obter_se_prescr_lib_adep(coalesce(a.dt_liberacao_medico, b.dt_lib_material), coalesce(a.dt_liberacao,b.dt_lib_material), coalesce(a.dt_liberacao_farmacia, b.dt_lib_farmacia), ie_data_lib_prescr_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	a.nr_atendimento = nr_atendimento_p
and	((b.dt_status between dt_inicial_w and dt_final_w) or (b.ie_status in ('I','INT')))
and	b.dt_status = to_date(vetor_w[ind].nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
and	((ie_horario_realizado_p = 'N' AND b.ie_status <> 'T') or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(b.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	ie_proc_setor_user_p = 'N'
and	adep_obter_regra_inclusao(	'SOL',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								null,
								null,
								null,
								null,
								a.cd_setor_Atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	((ie_sol_continuas_p = 'S') or
	((ie_sol_continuas_p = 'N') and (Obter_Se_Sol_Continua(a.nr_prescricao, b.nr_seq_solucao, b.ds_solucao) = 'N')))

union

select	'IA' ie_tipo_item, -- Itens associados
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.cd_material) cd_item,
	c.nr_sequencia nr_seq_hor,
	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario,
	substr(obter_status_hor_prescr(c.nr_sequencia, 'M'),1,1) ie_status,
	CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100)  ELSE substr(obter_um_dosagem_prescr(a.nr_prescricao, b.nr_sequencia),1,100) END  END  ds_prescricao,
	substr(coalesce(obter_se_item_dif_adep(b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento, 'M',ie_verifica_dif_w, b.ds_observacao),'N'),1,1) ie_diferenciado,
	substr(adep_obter_inf_dil_obs(a.nr_prescricao,b.nr_sequencia),1,2000) ds_diluicao,
	b.nr_dia_util nr_dia_util,
	0 nr_seq_proc_interno,
	b.cd_intervalo,
	c.ie_controlado ie_medic_controlado,
	0 nr_agrupamento,
	c.dt_suspensao dt_suspensao,
	c.qt_dose
from	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	b.ie_agrupador in (5)
and	coalesce(a.ie_adep,'S') = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_dose_especial,'N') = 'N'
and	coalesce(c.ie_adep,'S') = 'S'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	c.dt_horario = to_date(vetor_w[ind].nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
and	ie_proc_setor_user_p = 'N'
and	((coalesce(b.ie_checar_adep,'N') = 'S') or (ie_adm_associados_proc_w = 'S'))
and	adep_obter_regra_inclusao(	'M',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								b.cd_material,
								null,
								null,
								null,
								a.cd_setor_Atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	'IAG' ie_tipo_item, -- Itens associados CCG
	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item,
	to_char(b.cd_material) cd_item,
	c.nr_sequencia nr_seq_hor,
	to_char(c.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario,
	substr(obter_status_hor_prescr(c.nr_sequencia, 'M'),1,1) ie_status,
	CASE WHEN b.ie_se_necessario='S' THEN  'SN ' || substr(adep_obter_um_dosagem_prescr2(a.nr_prescricao, c.nr_sequencia),1,100)  ELSE CASE WHEN b.ie_acm='S' THEN  'ACM ' || substr(adep_obter_um_dosagem_prescr2(a.nr_prescricao, c.nr_sequencia),1,100)  ELSE substr(adep_obter_um_dosagem_prescr2(a.nr_prescricao, c.nr_sequencia),1,100) END  END  ds_prescricao,
	substr(coalesce(obter_se_item_dif_adep(b.nr_prescricao,b.nr_sequencia,b.nr_agrupamento, 'M',ie_verifica_dif_w, b.ds_observacao),'N'),1,1) ie_diferenciado,
	'' ds_diluicao,
	b.nr_dia_util nr_dia_util,
	0 nr_seq_proc_interno,
	b.cd_intervalo,
	c.ie_controlado ie_medic_controlado,
	0 nr_agrupamento,
	c.dt_suspensao dt_suspensao,
	c.qt_dose
from	prescr_mat_hor c,
	prescr_material b,
	prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and	c.nr_seq_material = b.nr_sequencia
and	b.nr_prescricao = a.nr_prescricao
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	b.ie_agrupador in (5)
and	coalesce(a.ie_adep,'S') = 'S'
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(c.ie_dose_especial,'N') = 'N'
and	coalesce(c.ie_adep,'S') = 'S'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	((coalesce(c.ie_horario_especial,'N') = 'N') or (c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> ''))
and	(((ie_horario_realizado_p = 'N') and (coalesce(c.dt_fim_horario::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	(((ie_horario_suspenso_p = 'N') and (coalesce(c.dt_suspensao::text, '') = '')) or (ie_horario_suspenso_p = 'S'))
and	c.dt_horario = to_date(vetor_w[ind].nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
and	ie_proc_setor_user_p = 'N'
and	((coalesce(b.ie_checar_adep,'N') = 'S') or (ie_adm_associados_proc_w = 'S'))
and	adep_obter_regra_inclusao(	'M',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								b.cd_material,
								null,
								null,
								null,
								a.cd_setor_Atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	'B' ie_tipo_item, /* Ordens Médicas */
	a.nr_prescricao nr_prescricao,
	coalesce(a.nr_seq_material, a.nr_seq_solucao) nr_seq_item,
	to_char(b.nr_sequencia) cd_item,
	b.nr_sequencia nr_seq_hor,
	to_char(b.dt_horario,'dd/mm/yyyy hh24:mi:ss') ds_horario,
	substr(obter_status_hor_prescr(b.nr_sequencia, 'B'),1,1) ie_status,
	'Item: ' || substr(coalesce(obter_desc_solucao_adep(nr_prescricao,nr_seq_solucao), obter_desc_material(obter_dados_material_prescr(nr_prescricao, nr_seq_material, 'CD_MATERIAL'))),1,255) ds_prescricao,
	'N' ie_diferenciado,
	substr(ds_ordem,1,255) ds_diluicao,
	0 nr_dia_util,
	0 nr_seq_proc_interno,
	'X' cd_intervalo,
	'N' ie_medic_controlado,
	0 nr_agrupamento,
	b.dt_suspensao dt_suspensao,
	0 qt_dose
from	prescr_medica_ordem a,
	prescr_ordem_hor b
where	a.nr_atendimento = nr_atendimento_p
and	b.nr_seq_ordem	= a.nr_sequencia
and	(((ie_horario_realizado_p = 'N') and (coalesce(a.dt_realizacao::text, '') = '')) or (ie_horario_realizado_p = 'S'))
and	b.dt_horario = to_date(vetor_w[ind].nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
and	ie_exibir_ordem_w	= 'G'

union

select	'J' ie_tipo_item, --Inicio
	a.nr_prescricao nr_prescricao,
	null nr_seq_item,
	to_char(b.dt_inicio,'dd/mm/yyyy hh24:mi:ss')||'-'||to_char(b.dt_fim,'dd/mm/yyyy hh24:mi:ss') cd_item,
	null  nr_seq_hor,
	to_char(b.dt_inicio,'dd/mm/yyyy hh24:mi:ss') ds_horario,
	'' ie_status,
	(obter_desc_expressao(301700)%ORA2PG_COMMENT465170(|': '|| to_char(b.dt_inicio,'dd/mm/yyyy hh24:mi:ss') || ' até ' || to_char(b.dt_fim,'dd/mm/yyyy hh24:mi:ss')) ds_prescricao,
	null ie_diferenciado,
	'' ds_diluicao,
	null nr_dia_util,
	0 nr_seq_proc_interno,
	null cd_intervalo,
	''  ie_medic_controlado,
	0 nr_agrupamento,
	null dt_suspensao,
	0 qt_dose
from	rep_jejum b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	coalesce(a.ie_adep,'S') = 'S'
and	a.nr_atendimento = nr_atendimento_p
and	a.dt_validade_prescr > dt_validade_w
and	b.dt_inicio between dt_inicial_w and dt_final_w
and	((ie_horario_suspenso_p = 'N' AND b.ie_suspenso = 'N') or (ie_horario_suspenso_p = 'S'))
and	adep_obter_regra_inclusao(	'DO',
								cd_estabelecimento_p,
								cd_setor_usuario_p,
								cd_perfil_p,
								null,
								null,
								null,
								null,
								a.cd_setor_Atendimento,
								null,
								null, -- nr_prescricao_p. Passei nulo porque criaram o param na adep_obter_regra_inclusao como default null, e não haviam passado nada
								null) = 'S' -- nr_seq_exame_p
and	ie_proc_setor_user_p = 'N'
and	b.dt_inicio = to_date(vetor_w[ind].nm_coluna_w,'dd/mm/yyyy hh24:mi:ss')
order by dt_suspensao;


BEGIN

ie_data_proc_w := obter_param_usuario(924, 223, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_data_proc_w);
ie_agrupar_acm_sn_w := obter_param_usuario(1113, 74, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_agrupar_acm_sn_w);
ie_agrupar_de_w := obter_param_usuario(1113, 99, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_agrupar_de_w);
ie_verifica_dif_w := obter_param_usuario(1113, 111, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_verifica_dif_w);
ie_exibe_dose_glicemia_w := obter_param_usuario(1113, 114, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_exibe_dose_glicemia_w);
ie_data_lib_prescr_w := obter_param_usuario(1113, 115, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_data_lib_prescr_w);
ie_exibe_suspenso_w := obter_param_usuario(1113, 117, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_exibe_suspenso_w);
ie_exibe_diluicao_w := obter_param_usuario(1113, 41, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_exibe_diluicao_w);
ie_agrupa_proc_w := obter_param_usuario(1113, 139, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_agrupa_proc_w);
ie_dieta_sem_horario_w := obter_param_usuario(1113, 148, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_dieta_sem_horario_w);
ie_exibir_col_pend_w := obter_param_usuario(1113, 154, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_exibir_col_pend_w);
ie_exibir_ordem_w := obter_param_usuario(1113, 172, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_exibir_ordem_w);
ie_adm_associados_proc_w := obter_param_usuario(1113, 180, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_adm_associados_proc_w);
ie_apelido_exame_w := obter_param_usuario(1113, 181, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_apelido_exame_w);

select 	obter_separador_bv
into STRICT	ds_sep_bv_w
;

cd_setor_atend_w	:= obter_setor_atendimento(nr_atendimento_p);

cd_setor_pac_w		:= Obter_Unidade_Atendimento(nr_atendimento_p, 'IA', 'CS');

/* limpar tabela temporária x usuário */

delete	from w_adep
where	nm_usuario = nm_usuario_p;

if (coalesce(dt_prescricao_p::text, '') = '') then

	dt_validade_w		:= clock_timestamp() - qt_hora_prescricao_p / 24;

	/* obter período datas (data inicial) */

	if (qt_hora_anterior_p > 0) then
		select	to_date(to_char(trunc(clock_timestamp() - qt_hora_anterior_p/24, 'hh24'), 'dd/mm/yyyy hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss')
		into STRICT	dt_inicial_w
		;
	else
		select	to_date(to_char(trunc(clock_timestamp(), 'hh24'), 'dd/mm/yyyy hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss')
		into STRICT	dt_inicial_w
		;
	end if;

	/* obter período datas (data final) */

	if (qt_hora_adicional_p > 0) then
		select	to_date(to_char(trunc(clock_timestamp() + qt_hora_adicional_p/24, 'hh24'), 'dd/mm/yyyy hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss')
		into STRICT	dt_final_w
		;
	else
		select	to_date(to_char(trunc(clock_timestamp(), 'hh24'), 'dd/mm/yyyy hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss')
		into STRICT	dt_final_w
		;
	end if;
else

	dt_inicial_w 	:= dt_prescricao_p;
	dt_final_w	:= dt_prescricao_p + (qt_hora_adicional_p/24);
	dt_validade_w   := dt_prescricao_p;

end if;

/* carregar vetor horários */

ivet := 0;
open c01;
loop
fetch c01 into 	ds_horario_w,
		dt_order_by_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	ivet := ivet + 1;
	vetor_w[ivet].nm_coluna_w := ds_horario_w;
	end;
end loop;
close c01;

/* completar vetor horários (se necessário) */

ind := ivet;
while(ind < 40) loop
	begin
	ind := ind + 1;
	vetor_w[ind].nm_coluna_w := null;
	end;
end loop;

/* gerar horários */

select	nextval('w_adep_seq')
into STRICT	nr_seq_adep_w
;

insert into w_adep(
			nr_sequencia,
			nm_usuario,
			ie_tipo_item,
			ie_acm_sn,
			ie_suspenso,
			ie_status_item,
			nr_prescricao,
			nr_seq_item,
			cd_item,
			ds_item,
			ds_prescricao,
			nr_prescricoes,
			ie_pendente_liberacao,
			nr_agrupamento,
			hora1,  hora2,  hora3,  hora4,  hora5,  hora6,  hora7,  hora8,  hora9,  hora10,
			hora11, hora12, hora13, hora14, hora15, hora16, hora17, hora18, hora19, hora20,
			hora21, hora22, hora23, hora24, hora25, hora26, hora27, hora28, hora29, hora30,
			hora31, hora32, hora33, hora34, hora35, hora36, hora37, hora38, hora39, hora40
			)
		values (
			nr_seq_adep_w,
			nm_usuario_p,
			'H',
			'N',
			'N',
			'N',
			1,
			1,
			1,
			'HORÁRIOS',
			'HORÁRIOS',
			'1',
			'',
			'',
			vetor_w[1].nm_coluna_w,
			vetor_w[2].nm_coluna_w,
			vetor_w[3].nm_coluna_w,
			vetor_w[4].nm_coluna_w,
			vetor_w[5].nm_coluna_w,
			vetor_w[6].nm_coluna_w,
			vetor_w[7].nm_coluna_w,
			vetor_w[8].nm_coluna_w,
			vetor_w[9].nm_coluna_w,
			vetor_w[10].nm_coluna_w,
			vetor_w[11].nm_coluna_w,
			vetor_w[12].nm_coluna_w,
			vetor_w[13].nm_coluna_w,
			vetor_w[14].nm_coluna_w,
			vetor_w[15].nm_coluna_w,
			vetor_w[16].nm_coluna_w,
			vetor_w[17].nm_coluna_w,
			vetor_w[18].nm_coluna_w,
			vetor_w[19].nm_coluna_w,
			vetor_w[20].nm_coluna_w,
			vetor_w[21].nm_coluna_w,
			vetor_w[22].nm_coluna_w,
			vetor_w[23].nm_coluna_w,
			vetor_w[24].nm_coluna_w,
			vetor_w[25].nm_coluna_w,
			vetor_w[26].nm_coluna_w,
			vetor_w[27].nm_coluna_w,
			vetor_w[28].nm_coluna_w,
			vetor_w[29].nm_coluna_w,
			vetor_w[30].nm_coluna_w,
			vetor_w[31].nm_coluna_w,
			vetor_w[32].nm_coluna_w,
			vetor_w[33].nm_coluna_w,
			vetor_w[34].nm_coluna_w,
			vetor_w[35].nm_coluna_w,
			vetor_w[36].nm_coluna_w,
			vetor_w[37].nm_coluna_w,
			vetor_w[38].nm_coluna_w,
			vetor_w[39].nm_coluna_w,
			vetor_w[40].nm_coluna_w
			);

/* gerar itens */

open c02;
loop
fetch c02 into
	ie_tipo_item_w,
	nr_prescricao_w,
	nr_seq_item_w,
	ie_status_item_w,
	ie_acm_sn_w,
	cd_item_w,
	ds_item_w,
	cd_intervalo_w,
	qt_item_w,
	ds_prescricao_w,
	ds_diluicao_w,
	ie_classif_adep_w,
	nr_seq_proc_interno_w,
	dt_prev_prox_etapa_w,
	ie_pendente_liberacao_w,
	nr_agrupamento_w,
	nr_seq_lab_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin
	select	nextval('w_adep_seq')
	into STRICT	nr_seq_adep_w
	;

	insert into w_adep(
				nr_sequencia,
				nm_usuario,
				ie_tipo_item,
				ie_acm_sn,
				ie_suspenso,
				ie_status_item,
				nr_prescricao,
				nr_seq_item,
				cd_item,
				ds_item,
				cd_intervalo,
				qt_item,
				ds_prescricao,
				ds_diluicao,
				nr_dia_util,
				nr_prescricoes,
				ie_classif_adep,
				ie_diferenciado,
				nr_seq_proc_interno,
				dt_prev_term,
				ie_pendente_liberacao,
				nr_agrupamento,
				nr_seq_lab
				)
			values (
				nr_seq_adep_w,
				nm_usuario_p,
				ie_tipo_item_w,
				ie_acm_sn_w,
				null,
				CASE WHEN ie_tipo_item_w='SOL' THEN ie_status_item_w WHEN ie_tipo_item_w='L' THEN ie_status_item_w WHEN ie_tipo_item_w='M' THEN ie_status_item_w WHEN ie_tipo_item_w='ME' THEN ie_status_item_w WHEN ie_tipo_item_w='O' THEN ie_status_item_w  ELSE CASE WHEN ie_tipo_item_w='SNE' THEN  ie_status_item_w  ELSE null END  END ,
				nr_prescricao_w,
				nr_seq_item_w,
				cd_item_w,
				ds_item_w,
				cd_intervalo_w,
				qt_item_w,
				ds_prescricao_w,
				ds_diluicao_w,
				null,
				CASE WHEN ie_acm_sn_w='S' THEN nr_prescricao_w  ELSE null END ,
				ie_classif_adep_w,
				CASE WHEN coalesce(ds_diluicao_w::text, '') = '' THEN  'N'  ELSE 'S' END ,
				nr_seq_proc_interno_w,
				dt_prev_prox_etapa_w,
				ie_pendente_liberacao_w,
				nr_agrupamento_w,
				nr_seq_lab_w
				);
	end;
end loop;
close c02;

/* gerar itens x horários */

ind := 0;
while(ind < 40) loop
	begin
	ind := ind + 1;
	open c03;
	loop
	fetch c03 into
		ie_tipo_item_w,
		nr_prescricao_w,
		nr_seq_item_w,
		cd_item_w,
		nr_seq_hor_w,
		ds_horario_w,
		ie_status_w,
		ds_prescricao_w,
		ie_diferenciado_w,
		ds_diluicao_w,
		nr_dia_util_w,
		nr_seq_proc_interno_w,
		cd_intervalo_w,
		ie_medic_controlado_w,
		nr_agrupamento_w,
		dt_suspensao_w,
		qt_dose_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		begin

		if (ie_tipo_item_w not in ('D','J')) then
			if (coalesce(nr_prescricao_w,0) > 0) and (coalesce(nr_seq_item_w,0) > 0) then
			ds_update_w :=' update w_adep	' ||
					' set hora' || to_char(ind) || ' = :vl_hora, ' ||
					' nr_prescricoes = adep_juntar_prescricao(nr_prescricoes,:nr_prescricao), ' ||
					' ie_diferenciado = :ie_diferenciado, ' ||
					' ds_diluicao = :ds_diluicao, ' ||
					' nr_dia_util = :nr_dia_util, ' ||
					' ie_medic_controlado = :ie_medic_controlado ' ||
					' where nm_usuario = :nm_usuario ' ||
					' and ie_tipo_item = :ie_tipo ' ||
					' and cd_item = :cd_item ' ||
					' and nr_seq_proc_interno = :nr_seq_proc_interno ' ||
					' and nvl(cd_intervalo,0) = nvl(:cd_intervalo,0) ' ||
					' and ((ds_prescricao = :ds_prescricao) or (ds_prescricao is null)) ' ||
					' and nvl(nr_prescricao,nvl(:nr_prescricao,0)) = nvl(:nr_prescricao,0) ' ||
					' and nvl(nr_seq_item,nvl(:nr_seq_item,0)) = nvl(:nr_seq_item,0) '||
					' and nvl(nr_agrupamento,nvl(:nr_agrupamento,0)) = nvl(:nr_agrupamento,0) '||
					' and ie_pendente_liberacao is null '||
					' and decode(:ie_tipo,''IA'', nvl(qt_item,0), nvl(:qt_item,0)) = nvl(:qt_item,0)';

			else
			ds_update_w :=' update w_adep	' ||
					' set hora' || to_char(ind) || ' = :vl_hora, ' ||
					' nr_prescricoes = adep_juntar_prescricao(nr_prescricoes,:nr_prescricao), ' ||
					' ie_diferenciado = :ie_diferenciado, ' ||
					' ds_diluicao = :ds_diluicao, ' ||
					' nr_dia_util = :nr_dia_util, ' ||
					' ie_medic_controlado = :ie_medic_controlado ' ||
					' where nm_usuario = :nm_usuario ' ||
					' and ie_tipo_item = :ie_tipo ' ||
					' and cd_item = :cd_item ' ||
					' and nr_seq_proc_interno = :nr_seq_proc_interno ' ||
					' and nvl(cd_intervalo,0) = nvl(:cd_intervalo,0) ' ||
					' and ((ds_prescricao = :ds_prescricao) or (ds_prescricao is null)) ' ||
					' and nvl(nr_seq_item,nvl(:nr_seq_item,0)) = nvl(:nr_seq_item,0) '||
					' and nvl(nr_agrupamento,nvl(:nr_agrupamento,0)) = nvl(:nr_agrupamento,0) '||
					' and decode(:ie_tipo,''IA'', nvl(qt_item,0), nvl(:qt_item,0)) = nvl(:qt_item,0)';
			end if;
		else
			if (ie_dieta_sem_horario_w = 'S') and (ie_tipo_item_w <> 'J') then
				ds_update_w :=	' update w_adep	' ||
						' set hora' || to_char(ind) || ' = :vl_hora, ' ||
						' nr_prescricoes = adep_juntar_prescricao(nr_prescricoes,:nr_prescricao), ' ||
						' ie_diferenciado = :ie_diferenciado, ' ||
						' ds_diluicao = :ds_diluicao, ' ||
						' nr_dia_util = :nr_dia_util, ' ||
						' ie_medic_controlado = :ie_medic_controlado ' ||
						' where nm_usuario = :nm_usuario ' ||
						' and ie_tipo_item = :ie_tipo ' ||
						' and cd_item = :cd_item ';
			else
				ds_update_w :=' update w_adep	' ||
						' set nr_prescricoes = adep_juntar_prescricao(nr_prescricoes,:nr_prescricao), ' ||
						' ie_diferenciado = :ie_diferenciado, ' ||
						' ds_diluicao = :ds_diluicao, ' ||
						' nr_dia_util = :nr_dia_util, ' ||
						' ie_medic_controlado = :ie_medic_controlado ' ||
						' where nm_usuario = :nm_usuario ' ||
						' and ie_tipo_item = :ie_tipo ' ||
						' and cd_item = :cd_item ';


			end if;
		end if;

		if (ie_tipo_item_w not in ('D','J')) then
		CALL exec_sql_dinamico_bv('ADEP', ds_update_w,	'vl_hora=S' || to_char(nr_seq_hor_w) || 'H' || ie_status_w	|| ds_sep_bv_w ||
								'nr_prescricao=' || to_char(nr_prescricao_w)			|| ds_sep_bv_w ||
								'ie_diferenciado=' || ie_diferenciado_w				|| ds_sep_bv_w ||
								'ds_diluicao=' || ds_diluicao_w					|| ds_sep_bv_w ||
								'nr_dia_util=' || to_char(nr_dia_util_w)			|| ds_sep_bv_w ||
								'nm_usuario=' || nm_usuario_p					|| ds_sep_bv_w ||
								'ie_tipo=' || ie_tipo_item_w					|| ds_sep_bv_w ||
								'cd_item=' || cd_item_w						|| ds_sep_bv_w ||
								'nr_seq_proc_interno=' || to_char(nr_seq_proc_interno_w)	|| ds_sep_bv_w ||
								'cd_intervalo=' || cd_intervalo_w				|| ds_sep_bv_w ||
								'ds_prescricao=' || ds_prescricao_w				|| ds_sep_bv_w ||
								'nr_seq_item=' || to_char(nr_seq_item_w)			|| ds_sep_bv_w ||
								'ie_medic_controlado=' || to_char(ie_medic_controlado_w)	|| ds_sep_bv_w ||
								'nr_agrupamento='||to_char(nr_agrupamento_w)			|| ds_sep_bv_w ||
								'qt_item='||to_char(qt_dose_w) || ds_sep_bv_w);
		else
			if (ie_dieta_sem_horario_w = 'S') and (ie_tipo_item_w <> 'J') then
				CALL exec_sql_dinamico_bv('ADEP', ds_update_w,	'vl_hora=S' || to_char(nr_seq_hor_w) || 'H' || ie_status_w	|| ds_sep_bv_w ||
										'nr_prescricao=' || to_char(nr_prescricao_w)			|| ds_sep_bv_w ||
										'ie_diferenciado=' || ie_diferenciado_w				|| ds_sep_bv_w ||
										'ds_diluicao=' || ds_diluicao_w					|| ds_sep_bv_w ||
										'nr_dia_util=' || to_char(nr_dia_util_w)			|| ds_sep_bv_w ||
										'nm_usuario=' || nm_usuario_p					|| ds_sep_bv_w ||
										'ie_tipo=' || ie_tipo_item_w					|| ds_sep_bv_w ||
										'cd_item=' || cd_item_w						|| ds_sep_bv_w ||
										'ie_medic_controlado=' || to_char(ie_medic_controlado_w)	|| ds_sep_bv_w);
			else
				CALL exec_sql_dinamico_bv('ADEP', ds_update_w,	'nr_prescricao=' || to_char(nr_prescricao_w)			|| ds_sep_bv_w ||
										'ie_diferenciado=' || ie_diferenciado_w				|| ds_sep_bv_w ||
										'ds_diluicao=' || ds_diluicao_w					|| ds_sep_bv_w ||
										'nr_dia_util=' || to_char(nr_dia_util_w)			|| ds_sep_bv_w ||
										'nm_usuario=' || nm_usuario_p					|| ds_sep_bv_w ||
										'ie_tipo=' || ie_tipo_item_w					|| ds_sep_bv_w ||
										'cd_item=' || cd_item_w						|| ds_sep_bv_w ||
										'ie_medic_controlado=' || to_char(ie_medic_controlado_w)	|| ds_sep_bv_w);
			end if;
		end if;

		end;
	end loop;
	close c03;
	end;
end loop;

update	w_adep
set	nr_prescricoes	= adep_obter_prescricoes(nr_atendimento_p, ie_tipo_item, cd_item, nr_seq_proc_interno, cd_intervalo, qt_item, ie_data_proc_w, ie_data_lib_prescr_w, ie_exibe_suspenso_w, dt_validade_w,cd_setor_pac_w,null)
where	nm_usuario	= nm_usuario_p
and	coalesce(nr_prescricoes::text, '') = '';

update	w_adep_t
set	ie_prescricao_alta = obter_se_prescr_alta_adep(nr_prescricoes)
where	nm_usuario = nm_usuario_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_horarios_adep (cd_estabelecimento_p bigint, cd_perfil_p bigint, cd_setor_usuario_p bigint, nr_atendimento_p bigint, nr_seq_dialise_p bigint, qt_hora_anterior_p bigint, qt_hora_adicional_p bigint, qt_hora_prescricao_p bigint, ie_horario_realizado_p text, ie_horario_suspenso_p text, ie_proc_setor_user_p text, ie_interv_setor_user_p text, dt_prescricao_p timestamp, ie_sol_continuas_p text, nm_usuario_p text) FROM PUBLIC;

