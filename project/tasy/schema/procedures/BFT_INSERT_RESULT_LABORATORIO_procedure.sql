-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE bft_insert_result_laboratorio ( nr_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_prescr_p bigint, ie_formato_p bigint, ds_resultado_p text, ds_pdf_serial_p text, cd_codigo_externo_p text, nm_usuario_p text, nr_seq_result_p INOUT bigint, nr_seq_result_pdf_p INOUT bigint, dt_collection_p timestamp default null, ie_final_p text default null) AS $body$
DECLARE

						
						
nr_seq_result_lab_w		result_laboratorio.nr_sequencia%type;
nr_prescricao_w			prescr_procedimento.nr_prescricao%type;
nr_seq_prescricao_w		prescr_procedimento.nr_sequencia%type;
nr_seq_result_pdf_w		result_laboratorio_pdf.nr_sequencia%type;
nr_seq_exame_w			prescr_procedimento.nr_seq_exame%type;

nr_seq_prescr_nova_w	  integer;
nr_seq_exame_atual_w	  bigint;
nr_seq_superior_w	      bigint;

C01 CURSOR FOR
SELECT	el.nr_seq_exame
from	  exame_laboratorio el
where   coalesce(el.cd_exame_integracao, el.cd_exame) = cd_codigo_externo_p

union

select	e.nr_seq_exame
from	  exame_laboratorio e
where	  e.nr_seq_exame 	= obter_equip_exame_integracao(cd_codigo_externo_p,'LABEXT',1)
order by 1;



BEGIN

select	max(nr_prescricao),
        max(nr_sequencia)
into STRICT	  nr_prescricao_w,
        nr_seq_prescricao_w
from	  prescr_procedimento
where	  nr_prescricao	= nr_prescricao_p
and	    nr_sequencia 	= nr_seq_prescr_p;


if (coalesce(nr_prescricao_w::text, '') = '') then

	select	max(nr_prescricao)
	into STRICT	  nr_prescricao_w
	from	  prescr_medica
	where	  nr_prescricao = nr_prescricao_p;

end if;

if (coalesce(cd_codigo_externo_p::text, '') = '') then

  select 	MAX(nr_seq_exame)
  into STRICT	  nr_seq_exame_w
  from	  prescr_procedimento
  where	  nr_prescricao	= nr_prescricao_w
  and	    nr_sequencia  = nr_seq_prescricao_w;

else

  open C01;
	loop
	fetch C01 into
		nr_seq_exame_atual_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

    nr_seq_exame_w := nr_seq_exame_atual_w;

    end;
	end loop;
	close C01;

end if;


if (nr_seq_exame_w = 0 ) then

  select 	MAX(nr_seq_exame)
  into STRICT	  nr_seq_exame_w
  from	  prescr_procedimento
  where	  nr_prescricao	= nr_prescricao_w
  and   	nr_sequencia = nr_seq_prescricao_w;

end if;

if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') and (nr_seq_prescricao_w IS NOT NULL AND nr_seq_prescricao_w::text <> '') then

	update	result_laboratorio
	set	    ie_status = 'I'
	where	  nr_prescricao       = nr_prescricao_w
	and   	nr_seq_prescricao   = nr_seq_prescricao_w
	and	    nr_seq_exame	      = nr_seq_exame_w;

	select	nextval('result_laboratorio_seq')
	into STRICT	nr_seq_result_lab_w
	;


	insert into result_laboratorio(
		nr_sequencia,
		ds_resultado,
		nr_prescricao,
		nr_seq_prescricao,
		nm_usuario,
		dt_atualizacao,
		ie_formato_texto,
		ie_cobranca,
		nr_seq_exame,
		dt_coleta,
		ie_final)
		values (nr_seq_result_lab_w,
			coalesce(ds_resultado_p, obter_desc_expressao(621294)),
			nr_prescricao_w,
			nr_seq_prescricao_w,
			nm_usuario_p,
			clock_timestamp(),
			ie_formato_p,
			'N',
			nr_seq_exame_w,
			dt_collection_p,
			ie_final_p);
    
	update	prescr_procedimento
	set	    ie_status_atend = 35,
          nm_usuario = nm_usuario_p
	where	  nr_prescricao	= nr_prescricao_w
	  and 	nr_sequencia	= coalesce(nr_seq_prescr_p,nr_seq_prescricao_w)
	  and	    ie_status_atend < 35;


	if (ds_pdf_serial_p IS NOT NULL AND ds_pdf_serial_p::text <> '') then

			select 	nextval('result_laboratorio_pdf_seq')
			into STRICT	nr_seq_result_pdf_w
			;

			insert into result_laboratorio_pdf(	nr_sequencia,
								nr_prescricao,
								dt_atualizacao, 
								nm_usuario, 
								dt_atualizacao_nrec, 
								nm_usuario_nrec, 
								nr_seq_prescricao, 
								nr_seq_resultado, 
								nr_seq_exame, 
								ds_pdf_serial )
			values (	nr_seq_result_pdf_w,
								nr_prescricao_w,
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								nr_seq_prescricao_w,
								nr_seq_result_lab_w,
								null,
								ds_pdf_serial_p
								);
	end if;

end if;
nr_seq_result_p		:= nr_seq_result_lab_w;
nr_seq_result_pdf_p	:= nr_seq_result_pdf_w;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE bft_insert_result_laboratorio ( nr_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_prescr_p bigint, ie_formato_p bigint, ds_resultado_p text, ds_pdf_serial_p text, cd_codigo_externo_p text, nm_usuario_p text, nr_seq_result_p INOUT bigint, nr_seq_result_pdf_p INOUT bigint, dt_collection_p timestamp default null, ie_final_p text default null) FROM PUBLIC;

