-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_event_avisados ( nr_seq_reg_auxiliar_p ctb_livro_auxiliar.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE

					
dt_contabil_w					timestamp;
dt_liquidacao_w					timestamp;
dt_referencia_month_w				timestamp;
nr_contador_w					bigint := 0;
ie_nao_aplica_recalc_w				varchar(1);
qt_prest_outros_w				bigint;
nr_titulo_w					bigint;
ie_lote_ajuste_prod_w				pls_parametro_contabil.ie_lote_ajuste_prod%type;
ie_forma_contab_taxa_pgto_w			pls_parametro_contabil.ie_forma_contab_taxa_pgto%type;
ie_forma_contab_reembolso_w			pls_parametro_contabil.ie_forma_contab_reembolso%type;
dt_emissao_w					titulo_receber.dt_emissao%type;
dt_vencimento_w					titulo_receber.dt_vencimento%type;
dt_liberacao_w					ctb_livro_auxiliar.dt_liberacao%type;
ie_tipo_protocolo_w				ctb_livro_auxiliar.ie_tipo_protocolo%type;
ie_tipo_segurado_w				ctb_livro_auxiliar.ie_tipo_segurado%type;	
ie_gerar_ind_classif_w				ctb_livro_auxiliar.ie_gerar_ind_classif%type;
ie_tipo_repasse_w				pls_segurado_repasse.ie_tipo_repasse%type;
ie_tipo_compartilhamento_w			pls_segurado_repasse.ie_tipo_compartilhamento%type;
dt_repasse_w					pls_segurado_repasse.dt_repasse%type;
dt_fim_repasse_w				pls_segurado_repasse.dt_fim_repasse%type;
dt_ref_repasse_w				pls_conta_proc.dt_procedimento%type;
ie_data_tipo_segurado_w				pls_parametros.ie_data_tipo_segurado%type;
qt_regra_evento_w                   		bigint;
qt_regra_reemb_taxa_w           		bigint;

/*Variaveis para geracao do arquivo*/

dt_inicial_w					timestamp;
dt_final_w					timestamp;
nr_planilha_w					smallint;
qt_registros_w					bigint;
qt_limite_w					bigint := 999999;
ds_observacao_w					varchar(255);
ds_observacao_item_w				varchar(255);

c_medica CURSOR FOR
	/*PROTOCOLO PROCEDIMENTO*/

	SELECT 	c.nr_sequencia nr_documento,
		e.ie_tipo_protocolo ie_tipo_protocolo,
		null nr_seq_material,
		coalesce(r.cd_procedimento,p.cd_procedimento) cd_procedimento,
		coalesce(r.ie_origem_proced,p.ie_origem_proced) ie_origem_proced,
		p.dt_procedimento dt_ocorrencia,
		e.dt_mes_competencia dt_conhecimento,
		(SELECT	max(t.dt_liquidacao)
		FROM pls_pagamento_prestador p, pls_lote_pagamento l, pls_pag_prest_vencimento v
LEFT OUTER JOIN titulo_pagar t ON (v.nr_titulo = t.nr_titulo)
WHERE l.nr_sequencia		= r.nr_seq_lote_pgto and l.nr_sequencia		= p.nr_seq_lote and p.nr_sequencia		= v.nr_seq_pag_prestador and p.nr_seq_prestador	= r.nr_seq_prestador_pgto  ) dt_liquidacao,
		c.ie_tipo_segurado ie_tipo_segurado,
		'CM' ie_tipo_documento,
		coalesce(r.ie_ato_cooperado,p.ie_ato_cooperado) ie_ato_cooperado,
		y.ie_preco ie_modalidade_contrat,	
		y.ie_regulamentacao ie_regulamentacao,
		y.ie_tipo_contratacao ie_tipo_contratacao,
		y.ie_segmentacao ie_segmentacao,
		pls_obter_valor_prov_resumo(c.nr_sequencia,r.nr_sequencia,r.vl_apresentado,r.vl_calculado,r.vl_liberado,r.vl_taxa_adm,r.vl_taxa_adm_co,r.vl_taxa_adm_mat,ie_forma_contab_taxa_pgto_w,'P') vl_evento,
		pls_obter_valor_prov_resumo(c.nr_sequencia,r.nr_sequencia,r.vl_apresentado,r.vl_calculado,r.vl_liberado,r.vl_taxa_adm,r.vl_taxa_adm_co,r.vl_taxa_adm_mat,ie_forma_contab_taxa_pgto_w,'A') vl_ajuste,
		coalesce(r.vl_liberado, coalesce(p.vl_liberado,0)) vl_pagamento,
		coalesce(r.vl_glosa,0) vl_glosa,
		( 	select 	coalesce(sum(o.vl_coparticipacao * dividir_sem_round(r.vl_liberado,p.vl_liberado)),0)
			from	pls_conta_coparticipacao o
			where   p.nr_sequencia = o.nr_seq_conta_proc
			and	c.nr_sequencia  = o.nr_seq_conta 
			and	o.ie_status_coparticipacao	in ('D','S')
			and o.ie_status_mensalidade <> 'C') vl_coparticipacao,
		coalesce(r.vl_taxa_adm,0) + coalesce(r.vl_taxa_adm_co,0) + coalesce(r.vl_taxa_adm_mat,0) vl_taxa_pgto,
		e.dt_mes_competencia dt_contabilizacao,
		coalesce(r.cd_conta_prov_cred, p.cd_conta_provisao_cred) cd_conta_credito,
		coalesce(r.cd_conta_prov_deb, p.cd_conta_provisao_deb) cd_conta_debito,
		t.nr_contrato nr_contrato,
		r.nr_sequencia nr_seq_resumo,
		CASE WHEN y.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(y.nr_protocolo_ans, y.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia	nr_seq_segurado,
		p.nr_seq_grupo_ans nr_seq_grupo_ans,
		e.nr_sequencia nr_seq_protocolo,
		c.nr_seq_fatura nr_seq_fatura,
		r.nr_sequencia nr_seq_conta_resumo,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		CASE WHEN qt_prest_outros_w=0 THEN  r.nr_seq_prestador_pgto  ELSE coalesce(c.nr_seq_prestador_exec,e.nr_seq_congenere) END  nr_seq_prestador,
		c.nr_sequencia nr_seq_conta,
		t.nr_sequencia nr_seq_contrato,
		k.ie_tipo_grupo_ans,
		CASE WHEN qt_prest_outros_w=0 THEN  r.nr_seq_prestador_pgto  ELSE c.nr_seq_prestador_exec END  nr_seq_prestador_exec,
		e.nr_seq_congenere,
		null vl_deferido,
		null cd_abi,
		null nr_aih
	FROM pls_conta_medica_resumo r, pls_protocolo_conta e, pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_plano y ON (c.nr_seq_plano = y.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
, pls_conta_proc p
LEFT OUTER JOIN ans_grupo_despesa k ON (p.nr_seq_grupo_ans = k.nr_sequencia)
WHERE c.nr_sequencia 		= p.nr_seq_conta and e.nr_sequencia 		= c.nr_seq_protocolo    and p.nr_sequencia 		= r.nr_seq_conta_proc and c.nr_sequencia 		= r.nr_seq_conta  and e.dt_mes_competencia between dt_inicial_w and dt_final_w and (ie_gerar_ind_classif_w <> 'N'
	or	substr(coalesce(r.cd_classif_prov_deb,coalesce(p.cd_classif_prov_deb,p.cd_classif_deb)),1,5) = '4.1.1') and e.ie_tipo_protocolo = 'C' and (c.ie_tipo_segurado = ie_tipo_segurado_w or coalesce(ie_tipo_segurado_w::text, '') = '') and (e.ie_tipo_protocolo = ie_tipo_protocolo_w or coalesce(ie_tipo_protocolo_w::text, '') = '') and r.ie_situacao = 'A' and p.ie_status <> 'D' and c.ie_status <> 'C' /*and	not exists(	select	1
				from	pls_item_recalculo y
				where	y.nr_seq_procedimento = p.nr_sequencia
				and	y.nr_seq_conta_resumo <> r.nr_sequencia)*/
 
union all

	/*PROTOCOLO MATERIAL*/

	select 	c.nr_sequencia nr_documento,
		e.ie_tipo_protocolo ie_tipo_protocolo,
		m.nr_seq_material,
		null cd_procedimento,
		null ie_origem_proced,
		m.dt_atendimento dt_ocorrencia,
		e.dt_mes_competencia dt_conhecimento,
		(select	max(t.dt_liquidacao)
		FROM pls_pagamento_prestador p, pls_lote_pagamento l, pls_pag_prest_vencimento v
LEFT OUTER JOIN titulo_pagar t ON (v.nr_titulo = t.nr_titulo)
WHERE l.nr_sequencia		= r.nr_seq_lote_pgto and l.nr_sequencia		= p.nr_seq_lote and p.nr_sequencia		= v.nr_seq_pag_prestador and p.nr_seq_prestador	= r.nr_seq_prestador_pgto  ) dt_liquidacao,
		c.ie_tipo_segurado ie_tipo_segurado,
		'CM' ie_tipo_documento,
		coalesce(r.ie_ato_cooperado,m.ie_ato_cooperado) ie_ato_cooperado,
		y.ie_preco ie_modalidade_contrat,	
		y.ie_regulamentacao ie_regulamentacao,
		y.ie_tipo_contratacao ie_tipo_contratacao,
		y.ie_segmentacao ie_segmentacao,
		pls_obter_valor_prov_resumo(c.nr_sequencia,r.nr_sequencia,r.vl_apresentado,r.vl_calculado,r.vl_liberado,r.vl_taxa_adm,r.vl_taxa_adm_co,r.vl_taxa_adm_mat,ie_forma_contab_taxa_pgto_w,'P') vl_evento,
		pls_obter_valor_prov_resumo(c.nr_sequencia,r.nr_sequencia,r.vl_apresentado,r.vl_calculado,r.vl_liberado,r.vl_taxa_adm,r.vl_taxa_adm_co,r.vl_taxa_adm_mat,ie_forma_contab_taxa_pgto_w,'A') vl_ajuste,
		coalesce(r.vl_liberado, coalesce(m.vl_liberado,0)) vl_pagamento,
		coalesce(r.vl_glosa,0) vl_glosa,
		( 	select 	coalesce(sum(o.vl_coparticipacao * dividir_sem_round(r.vl_liberado,m.vl_liberado)),0)
			from	pls_conta_coparticipacao o
			where   m.nr_sequencia = o.nr_seq_conta_mat
			and	c.nr_sequencia  = o.nr_seq_conta 
			and	o.ie_status_coparticipacao	in ('D','S')
			and o.ie_status_mensalidade <> 'C') vl_coparticipacao,
		coalesce(r.vl_taxa_adm,0) + coalesce(r.vl_taxa_adm_co,0) + coalesce(r.vl_taxa_adm_mat,0) vl_taxa_pgto,
		e.dt_mes_competencia dt_contabilizacao,
		coalesce(r.cd_conta_prov_cred, m.cd_conta_provisao_cred) cd_conta_credito,
		coalesce(r.cd_conta_prov_deb, m.cd_conta_provisao_deb) cd_conta_debito,
		t.nr_contrato nr_contrato,
		r.nr_sequencia nr_seq_resumo,
		CASE WHEN y.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(y.nr_protocolo_ans, y.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia	nr_seq_segurado,
		m.nr_seq_grupo_ans nr_seq_grupo_ans,
		e.nr_sequencia nr_seq_protocolo,
		c.nr_seq_fatura nr_seq_fatura,
		r.nr_sequencia nr_seq_conta_resumo,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		CASE WHEN qt_prest_outros_w=0 THEN  r.nr_seq_prestador_pgto  ELSE coalesce(c.nr_seq_prestador_exec,e.nr_seq_congenere) END  nr_seq_prestador,
		c.nr_sequencia nr_seq_conta,
		t.nr_sequencia nr_seq_contrato,
		k.ie_tipo_grupo_ans,
		CASE WHEN qt_prest_outros_w=0 THEN  r.nr_seq_prestador_pgto  ELSE c.nr_seq_prestador_exec END  nr_seq_prestador_exec,
		e.nr_seq_congenere,
		null vl_deferido,
		null cd_abi,
		null nr_aih
	FROM pls_conta_medica_resumo r, pls_protocolo_conta e, pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_plano y ON (c.nr_seq_plano = y.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
, pls_conta_mat m
LEFT OUTER JOIN ans_grupo_despesa k ON (m.nr_seq_grupo_ans = k.nr_sequencia)
WHERE c.nr_sequencia 		= m.nr_seq_conta and e.nr_sequencia 		= c.nr_seq_protocolo    and c.nr_sequencia 		= r.nr_seq_conta and m.nr_sequencia 		= r.nr_seq_conta_mat  and e.dt_mes_competencia between dt_inicial_w and dt_final_w and (ie_gerar_ind_classif_w <> 'N'
	or	substr(coalesce(r.cd_classif_prov_deb,coalesce(m.cd_classif_prov_deb,m.cd_classif_deb)),1,5) = '4.1.1') and e.ie_tipo_protocolo = 'C' and (c.ie_tipo_segurado = ie_tipo_segurado_w or coalesce(ie_tipo_segurado_w::text, '') = '') and (e.ie_tipo_protocolo = ie_tipo_protocolo_w or coalesce(ie_tipo_protocolo_w::text, '') = '') and r.ie_situacao = 'A' and m.ie_status <> 'D' and c.ie_status <> 'C' /*and	not exists(	select	1
				from	pls_item_recalculo y
				where	y.nr_seq_material = m.nr_sequencia
				and	y.nr_seq_conta_resumo <> r.nr_sequencia)*/
 
union all

	select 	c.nr_sequencia nr_documento,
		e.ie_tipo_protocolo ie_tipo_protocolo,
		null nr_seq_material,
		p.cd_procedimento cd_procedimento,
		p.ie_origem_proced ie_origem_proced,
		p.dt_procedimento dt_ocorrencia,
		e.dt_mes_competencia dt_conhecimento,
		(select	max(t.dt_liquidacao)
		FROM pls_conta_medica_resumo r, pls_pagamento_prestador p, pls_lote_pagamento l, pls_pag_prest_vencimento v
LEFT OUTER JOIN titulo_pagar t ON (v.nr_titulo = t.nr_titulo)
WHERE l.nr_sequencia		= r.nr_seq_lote_pgto and l.nr_sequencia		= p.nr_seq_lote and p.nr_sequencia		= v.nr_seq_pag_prestador and p.nr_seq_prestador	= r.nr_seq_prestador_pgto  and r.nr_seq_conta		= c.nr_sequencia and r.nr_seq_conta_proc	= p.nr_sequencia ) dt_liquidacao,
		c.ie_tipo_segurado ie_tipo_segurado,
		'CM' ie_tipo_documento,
		p.ie_ato_cooperado ie_ato_cooperado,
		y.ie_preco ie_modalidade_contrat,	
		y.ie_regulamentacao ie_regulamentacao,
		y.ie_tipo_contratacao ie_tipo_contratacao,
		y.ie_segmentacao ie_segmentacao,
		p.vl_procedimento_imp vl_evento,
		coalesce((	select	max(r.vl_liberado)
			from	pls_conta_medica_resumo	r
			where	p.nr_sequencia		= r.nr_seq_conta_proc
			and	c.nr_sequencia		= r.nr_seq_conta),0) - coalesce(p.vl_provisao,0) vl_ajuste,
		coalesce(p.vl_liberado,0) vl_pagamento,
		coalesce(p.vl_glosa,0) vl_glosa,
		( 	select 	sum(coalesce(o.vl_coparticipacao,0))
			from	pls_conta_coparticipacao o
			where   p.nr_sequencia = o.nr_seq_conta_proc
			and	c.nr_sequencia  = o.nr_seq_conta
			and	o.ie_status_coparticipacao in ('D','S')
			and o.ie_status_mensalidade <> 'C') vl_coparticipacao,
		0 vl_taxa_pgto,
		e.dt_mes_competencia dt_contabilizacao,
		p.cd_conta_cred cd_conta_credito,
		p.cd_conta_deb cd_conta_debito,
		t.nr_contrato nr_contrato,
		(select	max(r.nr_sequencia)
		from	pls_conta_medica_resumo	r
		where	p.nr_sequencia		= r.nr_seq_conta_proc
		and	c.nr_sequencia		= r.nr_seq_conta) nr_seq_resumo,
		CASE WHEN y.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(y.nr_protocolo_ans, y.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia	nr_seq_segurado,
		p.nr_seq_grupo_ans nr_seq_grupo_ans,
		e.nr_sequencia nr_seq_protocolo,
		c.nr_seq_fatura nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		coalesce(c.nr_seq_prestador_exec,e.nr_seq_congenere) nr_seq_prestador,
		c.nr_sequencia nr_seq_conta,
		t.nr_sequencia nr_seq_contrato,
		k.ie_tipo_grupo_ans,
		c.nr_seq_prestador_exec nr_seq_prestador_exec,
		e.nr_seq_congenere,
		null vl_deferido,
		null cd_abi,
		null nr_aih
	FROM pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
LEFT OUTER JOIN pls_plano y ON (s.nr_seq_plano = y.nr_sequencia)
, pls_conta_proc p
LEFT OUTER JOIN ans_grupo_despesa k ON (p.nr_seq_grupo_ans = k.nr_sequencia)
, pls_protocolo_conta e
LEFT OUTER JOIN pls_congenere i ON (e.nr_seq_congenere = i.nr_sequencia)
WHERE c.nr_sequencia 		= p.nr_seq_conta and e.nr_sequencia 		= c.nr_seq_protocolo      and ((e.dt_mes_competencia between dt_inicial_w and dt_final_w
	and	((e.ie_tipo_protocolo <> 'R') or ie_forma_contab_reembolso_w = 'C'))
	or	(e.dt_fechamento_contas between dt_inicial_w and dt_final_w
	and	((e.ie_tipo_protocolo = 'R') and ie_forma_contab_reembolso_w = 'L'))
	or	(e.dt_mes_competencia between dt_inicial_w and dt_final_w
	and	((e.ie_tipo_protocolo = 'R') and ie_forma_contab_reembolso_w = 'M'))) and (ie_gerar_ind_classif_w <> 'N'
	or	substr(p.cd_classif_deb,1,5) = '4.1.1') and e.ie_tipo_protocolo in ('I','R','F') and c.ie_status <> 'C' and p.ie_status <> 'D' and (c.ie_tipo_segurado = ie_tipo_segurado_w or coalesce(ie_tipo_segurado_w::text, '') = '') and (e.ie_tipo_protocolo = ie_tipo_protocolo_w or coalesce(ie_tipo_protocolo_w::text, '') = '') and ((qt_regra_evento_w > 0 AND ie_tipo_protocolo = 'I')
	or (ie_tipo_protocolo <> 'I'))
	 
union all

	select 	c.nr_sequencia nr_documento,
		e.ie_tipo_protocolo ie_tipo_protocolo,
		m.nr_seq_material,
		null cd_procedimento,
		null ie_origem_proced,
		m.dt_atendimento dt_ocorrencia,
		e.dt_mes_competencia dt_conhecimento,
		(select	max(t.dt_liquidacao)
		FROM pls_conta_medica_resumo r, pls_pagamento_prestador p, pls_lote_pagamento l, pls_pag_prest_vencimento v
LEFT OUTER JOIN titulo_pagar t ON (v.nr_titulo = t.nr_titulo)
WHERE l.nr_sequencia		= r.nr_seq_lote_pgto and l.nr_sequencia		= p.nr_seq_lote and p.nr_sequencia		= v.nr_seq_pag_prestador and p.nr_seq_prestador	= r.nr_seq_prestador_pgto  and r.nr_seq_conta		= c.nr_sequencia and r.nr_seq_conta_mat	= p.nr_sequencia ) dt_liquidacao,
		c.ie_tipo_segurado ie_tipo_segurado,
		'CM' ie_tipo_documento,
		m.ie_ato_cooperado ie_ato_cooperado,
		y.ie_preco ie_modalidade_contrat,	
		y.ie_regulamentacao ie_regulamentacao,
		y.ie_tipo_contratacao ie_tipo_contratacao,
		y.ie_segmentacao ie_segmentacao,
		m.vl_material_imp vl_evento,
		coalesce((	select	max(r.vl_liberado)
			from	pls_conta_medica_resumo	r
			where	m.nr_sequencia		= r.nr_seq_conta_mat
			and	c.nr_sequencia		= r.nr_seq_conta),0) - coalesce(m.vl_provisao,0) vl_ajuste,
		coalesce(m.vl_liberado,0) vl_pagamento,
		coalesce(m.vl_glosa,0) vl_glosa,
		( 	select 	coalesce(sum(o.vl_coparticipacao),0)
			from	pls_conta_coparticipacao o
			where   m.nr_sequencia = o.nr_seq_conta_mat
			and	c.nr_sequencia  = o.nr_seq_conta 
			and	o.ie_status_coparticipacao	in ('D','S')
			and o.ie_status_mensalidade <> 'C') vl_coparticipacao,
		0 vl_taxa_pgto,
		e.dt_mes_competencia dt_contabilizacao,
		m.cd_conta_cred cd_conta_credito,
		m.cd_conta_deb cd_conta_debito,
		t.nr_contrato nr_contrato,
		(select	max(r.nr_sequencia)
		from	pls_conta_medica_resumo	r
		where	m.nr_sequencia		= r.nr_seq_conta_mat
		and	c.nr_sequencia		= r.nr_seq_conta) nr_seq_resumo,
		CASE WHEN y.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(y.nr_protocolo_ans, y.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia	nr_seq_segurado,
		m.nr_seq_grupo_ans nr_seq_grupo_ans,
		e.nr_sequencia nr_seq_protocolo,
		c.nr_seq_fatura nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		coalesce(c.nr_seq_prestador_exec,e.nr_seq_congenere) nr_seq_prestador,
		c.nr_sequencia nr_seq_conta,
		t.nr_sequencia nr_seq_contrato,
		k.ie_tipo_grupo_ans,
		c.nr_seq_prestador_exec nr_seq_prestador_exec,
		e.nr_seq_congenere,
		null vl_deferido,
		null cd_abi,
		null nr_aih
	FROM pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
LEFT OUTER JOIN pls_plano y ON (s.nr_seq_plano = y.nr_sequencia)
, pls_conta_mat m
LEFT OUTER JOIN ans_grupo_despesa k ON (m.nr_seq_grupo_ans = k.nr_sequencia)
, pls_protocolo_conta e
LEFT OUTER JOIN pls_congenere i ON (e.nr_seq_congenere = i.nr_sequencia)
WHERE c.nr_sequencia 		= m.nr_seq_conta and e.nr_sequencia 		= c.nr_seq_protocolo      and ((e.dt_mes_competencia between dt_inicial_w and dt_final_w
	and	((e.ie_tipo_protocolo <> 'R') or ie_forma_contab_reembolso_w = 'C'))
	or	(e.dt_fechamento_contas between dt_inicial_w and dt_final_w
	and	((e.ie_tipo_protocolo = 'R') and ie_forma_contab_reembolso_w = 'L'))
	or	(e.dt_mes_competencia between dt_inicial_w and dt_final_w
	and	((e.ie_tipo_protocolo = 'R') and ie_forma_contab_reembolso_w = 'M'))) and (ie_gerar_ind_classif_w <> 'N'
	or	substr(m.cd_classif_deb,1,5) = '4.1.1') and e.ie_tipo_protocolo in ('I','R','F') and c.ie_status <> 'C' and m.ie_status <> 'D' and (c.ie_tipo_segurado = ie_tipo_segurado_w or coalesce(ie_tipo_segurado_w::text, '') = '') and (e.ie_tipo_protocolo = ie_tipo_protocolo_w or coalesce(ie_tipo_protocolo_w::text, '') = '') and ((qt_regra_evento_w > 0 AND ie_tipo_protocolo = 'I')
	or (ie_tipo_protocolo <> 'I'))
	 
union all

	select 	c.nr_sequencia nr_documento,
		e.ie_tipo_protocolo ie_tipo_protocolo,
		null nr_seq_material,
		p.cd_procedimento cd_procedimento,
		p.ie_origem_proced ie_origem_proced,
		p.dt_procedimento dt_ocorrencia,
		e.dt_mes_competencia dt_conhecimento,
		(select	max(t.dt_liquidacao)
		FROM pls_conta_medica_resumo r, pls_pagamento_prestador p, pls_lote_pagamento l, pls_pag_prest_vencimento v
LEFT OUTER JOIN titulo_pagar t ON (v.nr_titulo = t.nr_titulo)
WHERE l.nr_sequencia		= r.nr_seq_lote_pgto and l.nr_sequencia		= p.nr_seq_lote and p.nr_sequencia		= v.nr_seq_pag_prestador and p.nr_seq_prestador	= r.nr_seq_prestador_pgto  and r.nr_seq_conta		= c.nr_sequencia and r.nr_seq_conta_proc	= p.nr_sequencia ) dt_liquidacao,
		c.ie_tipo_segurado ie_tipo_segurado,
		'CM' ie_tipo_documento,
		p.ie_ato_cooperado ie_ato_cooperado,
		y.ie_preco ie_modalidade_contrat,	
		y.ie_regulamentacao ie_regulamentacao,
		y.ie_tipo_contratacao ie_tipo_contratacao,
		y.ie_segmentacao ie_segmentacao,
		coalesce(p.vl_procedimento_imp,0) - (coalesce(p.vl_taxa_material_imp,0) + coalesce(p.vl_taxa_servico_imp,0) + coalesce(p.vl_taxa_co_imp,0)) vl_evento,
		0 vl_ajuste,
		coalesce(p.vl_procedimento_imp,0) - (coalesce(p.vl_taxa_material_imp,0) + coalesce(p.vl_taxa_servico_imp,0) + coalesce(p.vl_taxa_co_imp,0)) - coalesce(p.vl_glosa,0) vl_pagamento,
		coalesce(p.vl_glosa,0) vl_glosa,
		( 	select 	sum(coalesce(o.vl_coparticipacao,0))
			from	pls_conta_coparticipacao o
			where   p.nr_sequencia = o.nr_seq_conta_proc
			and	c.nr_sequencia  = o.nr_seq_conta
			and	o.ie_status_coparticipacao in ('D','S')
			and o.ie_status_mensalidade <> 'C') vl_coparticipacao,
		0 vl_taxa_pgto,
		e.dt_mes_competencia dt_contabilizacao,
		p.cd_conta_cred_tx_inter_glosa cd_conta_credito,
		p.cd_conta_deb_tx_inter_glosa cd_conta_debito,
		t.nr_contrato nr_contrato,
		(select	max(r.nr_sequencia)
		from	pls_conta_medica_resumo	r
		where	p.nr_sequencia		= r.nr_seq_conta_proc
		and	c.nr_sequencia		= r.nr_seq_conta) nr_seq_resumo,
		CASE WHEN y.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(y.nr_protocolo_ans, y.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia	nr_seq_segurado,
		p.nr_seq_grupo_ans nr_seq_grupo_ans,
		e.nr_sequencia nr_seq_protocolo,
		c.nr_seq_fatura nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		coalesce(c.nr_seq_prestador_exec,e.nr_seq_congenere) nr_seq_prestador,
		c.nr_sequencia nr_seq_conta,
		t.nr_sequencia nr_seq_contrato,
		k.ie_tipo_grupo_ans,
		c.nr_seq_prestador_exec nr_seq_prestador_exec,
		e.nr_seq_congenere,
		null vl_deferido,
		null cd_abi,
		null nr_aih
	FROM pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
LEFT OUTER JOIN pls_plano y ON (s.nr_seq_plano = y.nr_sequencia)
, pls_conta_proc p
LEFT OUTER JOIN ans_grupo_despesa k ON (p.nr_seq_grupo_ans = k.nr_sequencia)
, pls_protocolo_conta e
LEFT OUTER JOIN pls_congenere i ON (e.nr_seq_congenere = i.nr_sequencia)
WHERE c.nr_sequencia 		= p.nr_seq_conta and e.nr_sequencia 		= c.nr_seq_protocolo      and ((e.dt_mes_competencia between dt_inicial_w and dt_final_w
	and	((e.ie_tipo_protocolo <> 'R') or ie_forma_contab_reembolso_w = 'C'))
	or	(e.dt_fechamento_contas between dt_inicial_w and dt_final_w
	and	((e.ie_tipo_protocolo = 'R') and ie_forma_contab_reembolso_w = 'L'))
	or	(e.dt_mes_competencia between dt_inicial_w and dt_final_w
	and	((e.ie_tipo_protocolo = 'R') and ie_forma_contab_reembolso_w = 'M'))) and (ie_gerar_ind_classif_w <> 'N'
	or	substr(p.cd_classif_tx_glosa_deb,1,5) = '4.1.1') and e.ie_tipo_protocolo = 'I' and c.ie_status <> 'C' and p.ie_status <> 'D' and (c.ie_tipo_segurado = ie_tipo_segurado_w or coalesce(ie_tipo_segurado_w::text, '') = '') and (e.ie_tipo_protocolo = ie_tipo_protocolo_w or coalesce(ie_tipo_protocolo_w::text, '') = '') and qt_regra_reemb_taxa_w > 0
	 
union all

	select 	c.nr_sequencia nr_documento,
		e.ie_tipo_protocolo ie_tipo_protocolo,
		m.nr_seq_material,
		null cd_procedimento,
		null ie_origem_proced,
		m.dt_atendimento dt_ocorrencia,
		e.dt_mes_competencia dt_conhecimento,
		(select	max(t.dt_liquidacao)
		FROM pls_conta_medica_resumo r, pls_pagamento_prestador p, pls_lote_pagamento l, pls_pag_prest_vencimento v
LEFT OUTER JOIN titulo_pagar t ON (v.nr_titulo = t.nr_titulo)
WHERE l.nr_sequencia		= r.nr_seq_lote_pgto and l.nr_sequencia		= p.nr_seq_lote and p.nr_sequencia		= v.nr_seq_pag_prestador and p.nr_seq_prestador	= r.nr_seq_prestador_pgto  and r.nr_seq_conta		= c.nr_sequencia and r.nr_seq_conta_mat	= p.nr_sequencia ) dt_liquidacao,
		c.ie_tipo_segurado ie_tipo_segurado,
		'CM' ie_tipo_documento,
		m.ie_ato_cooperado ie_ato_cooperado,
		y.ie_preco ie_modalidade_contrat,	
		y.ie_regulamentacao ie_regulamentacao,
		y.ie_tipo_contratacao ie_tipo_contratacao,
		y.ie_segmentacao ie_segmentacao,
		coalesce(m.vl_material_imp,0) - coalesce(m.vl_taxa_material_imp,0) vl_evento,
		0 vl_ajuste,
		coalesce(m.vl_material_imp,0) - coalesce(m.vl_taxa_material_imp,0) - coalesce(m.vl_glosa,0) vl_pagamento,
		coalesce(m.vl_glosa,0) vl_glosa,
		( 	select 	coalesce(sum(o.vl_coparticipacao),0)
			from	pls_conta_coparticipacao o
			where   m.nr_sequencia = o.nr_seq_conta_mat
			and	c.nr_sequencia  = o.nr_seq_conta 
			and	o.ie_status_coparticipacao	in ('D','S')
			and o.ie_status_mensalidade <> 'C') vl_coparticipacao,
		0 vl_taxa_pgto,
		e.dt_mes_competencia dt_contabilizacao,
		m.cd_conta_cred_tx_inter_glosa cd_conta_credito,
		m.cd_conta_deb_tx_inter_glosa cd_conta_debito,
		t.nr_contrato nr_contrato,
		(select	max(r.nr_sequencia)
		from	pls_conta_medica_resumo	r
		where	m.nr_sequencia		= r.nr_seq_conta_mat
		and	c.nr_sequencia		= r.nr_seq_conta) nr_seq_resumo,
		CASE WHEN y.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(y.nr_protocolo_ans, y.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia	nr_seq_segurado,
		m.nr_seq_grupo_ans nr_seq_grupo_ans,
		e.nr_sequencia nr_seq_protocolo,
		c.nr_seq_fatura nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		coalesce(c.nr_seq_prestador_exec,e.nr_seq_congenere) nr_seq_prestador,
		c.nr_sequencia nr_seq_conta,
		t.nr_sequencia nr_seq_contrato,
		k.ie_tipo_grupo_ans,
		c.nr_seq_prestador_exec nr_seq_prestador_exec,
		e.nr_seq_congenere,
		null vl_deferido,
		null cd_abi,
		null nr_aih
	FROM pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
LEFT OUTER JOIN pls_plano y ON (s.nr_seq_plano = y.nr_sequencia)
, pls_conta_mat m
LEFT OUTER JOIN ans_grupo_despesa k ON (m.nr_seq_grupo_ans = k.nr_sequencia)
, pls_protocolo_conta e
LEFT OUTER JOIN pls_congenere i ON (e.nr_seq_congenere = i.nr_sequencia)
WHERE c.nr_sequencia 		= m.nr_seq_conta and e.nr_sequencia 		= c.nr_seq_protocolo      and ((e.dt_mes_competencia between dt_inicial_w and dt_final_w
	and	((e.ie_tipo_protocolo <> 'R') or ie_forma_contab_reembolso_w = 'C'))
	or	(e.dt_fechamento_contas between dt_inicial_w and dt_final_w
	and	((e.ie_tipo_protocolo = 'R') and ie_forma_contab_reembolso_w = 'L'))
	or	(e.dt_mes_competencia between dt_inicial_w and dt_final_w
	and	((e.ie_tipo_protocolo = 'R') and ie_forma_contab_reembolso_w = 'M'))) and (ie_gerar_ind_classif_w <> 'N'
	or	substr(m.cd_classif_tx_glosa_deb,1,5) = '4.1.1') and e.ie_tipo_protocolo = 'I' and c.ie_status <> 'C' and m.ie_status <> 'D' and (c.ie_tipo_segurado = ie_tipo_segurado_w or coalesce(ie_tipo_segurado_w::text, '') = '') and (e.ie_tipo_protocolo = ie_tipo_protocolo_w or coalesce(ie_tipo_protocolo_w::text, '') = '') and qt_regra_reemb_taxa_w > 0
	 
union all

	select 	c.nr_sequencia nr_documento,
		e.ie_tipo_protocolo ie_tipo_protocolo,
		null nr_seq_material,
		p.cd_procedimento cd_procedimento,
		p.ie_origem_proced ie_origem_proced,
		p.dt_procedimento dt_ocorrencia,
		e.dt_mes_competencia dt_conhecimento,
		(select	max(t.dt_liquidacao)
		FROM pls_conta_medica_resumo r, pls_pagamento_prestador p, pls_lote_pagamento l, pls_pag_prest_vencimento v
LEFT OUTER JOIN titulo_pagar t ON (v.nr_titulo = t.nr_titulo)
WHERE l.nr_sequencia		= r.nr_seq_lote_pgto and l.nr_sequencia		= p.nr_seq_lote and p.nr_sequencia		= v.nr_seq_pag_prestador and p.nr_seq_prestador	= r.nr_seq_prestador_pgto  and r.nr_seq_conta		= c.nr_sequencia and r.nr_seq_conta_proc	= p.nr_sequencia ) dt_liquidacao,
		c.ie_tipo_segurado ie_tipo_segurado,
		'CM' ie_tipo_documento,
		p.ie_ato_cooperado ie_ato_cooperado,
		y.ie_preco ie_modalidade_contrat,	
		y.ie_regulamentacao ie_regulamentacao,
		y.ie_tipo_contratacao ie_tipo_contratacao,
		y.ie_segmentacao ie_segmentacao,
		coalesce(p.vl_taxa_material_imp,0) + coalesce(p.vl_taxa_servico_imp,0) + coalesce(p.vl_taxa_co_imp,0) vl_evento,
		0 vl_ajuste,
		coalesce(p.vl_taxa_material_imp,0) + coalesce(p.vl_taxa_servico_imp,0) + coalesce(p.vl_taxa_co_imp,0) vl_pagamento,
		0 vl_glosa,
		0 vl_coparticipacao,
		0 vl_taxa_pgto,
		e.dt_mes_competencia dt_contabilizacao,
		p.cd_conta_cred_tx_inter cd_conta_credito,
		p.cd_conta_deb_tx_inter cd_conta_debito,
		t.nr_contrato nr_contrato,
		(select	max(r.nr_sequencia)
		from	pls_conta_medica_resumo	r
		where	p.nr_sequencia		= r.nr_seq_conta_proc
		and	c.nr_sequencia		= r.nr_seq_conta) nr_seq_resumo,
		CASE WHEN y.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(y.nr_protocolo_ans, y.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia	nr_seq_segurado,
		p.nr_seq_grupo_ans nr_seq_grupo_ans,
		e.nr_sequencia nr_seq_protocolo,
		c.nr_seq_fatura nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		coalesce(c.nr_seq_prestador_exec,e.nr_seq_congenere) nr_seq_prestador,
		c.nr_sequencia nr_seq_conta,
		t.nr_sequencia nr_seq_contrato,
		k.ie_tipo_grupo_ans,
		c.nr_seq_prestador_exec nr_seq_prestador_exec,
		e.nr_seq_congenere,
		null vl_deferido,
		null cd_abi,
		null nr_aih
	FROM pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
LEFT OUTER JOIN pls_plano y ON (s.nr_seq_plano = y.nr_sequencia)
, pls_conta_proc p
LEFT OUTER JOIN ans_grupo_despesa k ON (p.nr_seq_grupo_ans = k.nr_sequencia)
, pls_protocolo_conta e
LEFT OUTER JOIN pls_congenere i ON (e.nr_seq_congenere = i.nr_sequencia)
WHERE c.nr_sequencia 		= p.nr_seq_conta and e.nr_sequencia 		= c.nr_seq_protocolo      and ((e.dt_mes_competencia between dt_inicial_w and dt_final_w
	and	((e.ie_tipo_protocolo <> 'R') or ie_forma_contab_reembolso_w = 'C'))
	or	(e.dt_fechamento_contas between dt_inicial_w and dt_final_w
	and	((e.ie_tipo_protocolo = 'R') and ie_forma_contab_reembolso_w = 'L'))
	or	(e.dt_mes_competencia between dt_inicial_w and dt_final_w
	and	((e.ie_tipo_protocolo = 'R') and ie_forma_contab_reembolso_w = 'M'))) and (ie_gerar_ind_classif_w <> 'N'
	or	substr(p.cd_classif_tx_inter_deb,1,5) = '4.1.1') and e.ie_tipo_protocolo = 'I' and c.ie_status <> 'C' and p.ie_status <> 'D' and (c.ie_tipo_segurado = ie_tipo_segurado_w or coalesce(ie_tipo_segurado_w::text, '') = '') and (e.ie_tipo_protocolo = ie_tipo_protocolo_w or coalesce(ie_tipo_protocolo_w::text, '') = '') and qt_regra_reemb_taxa_w > 0
	 
union all

	select 	c.nr_sequencia nr_documento,
		e.ie_tipo_protocolo ie_tipo_protocolo,
		m.nr_seq_material,
		null cd_procedimento,
		null ie_origem_proced,
		m.dt_atendimento dt_ocorrencia,
		e.dt_mes_competencia dt_conhecimento,
		(select	max(t.dt_liquidacao)
		FROM pls_conta_medica_resumo r, pls_pagamento_prestador p, pls_lote_pagamento l, pls_pag_prest_vencimento v
LEFT OUTER JOIN titulo_pagar t ON (v.nr_titulo = t.nr_titulo)
WHERE l.nr_sequencia		= r.nr_seq_lote_pgto and l.nr_sequencia		= p.nr_seq_lote and p.nr_sequencia		= v.nr_seq_pag_prestador and p.nr_seq_prestador	= r.nr_seq_prestador_pgto  and r.nr_seq_conta		= c.nr_sequencia and r.nr_seq_conta_mat	= p.nr_sequencia ) dt_liquidacao,
		c.ie_tipo_segurado ie_tipo_segurado,
		'CM' ie_tipo_documento,
		m.ie_ato_cooperado ie_ato_cooperado,
		y.ie_preco ie_modalidade_contrat,	
		y.ie_regulamentacao ie_regulamentacao,
		y.ie_tipo_contratacao ie_tipo_contratacao,
		y.ie_segmentacao ie_segmentacao,
		m.vl_taxa_material_imp vl_evento,
		0 vl_ajuste,
		m.vl_taxa_material_imp vl_pagamento,
		0 vl_glosa,
		0 vl_coparticipacao,
		0 vl_taxa_pgto,
		e.dt_mes_competencia dt_contabilizacao,
		m.cd_conta_cred_tx_inter cd_conta_credito,
		m.cd_conta_deb_tx_inter cd_conta_debito,
		t.nr_contrato nr_contrato,
		(select	max(r.nr_sequencia)
		from	pls_conta_medica_resumo	r
		where	m.nr_sequencia		= r.nr_seq_conta_mat
		and	c.nr_sequencia		= r.nr_seq_conta) nr_seq_resumo,
		CASE WHEN y.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(y.nr_protocolo_ans, y.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia	nr_seq_segurado,
		m.nr_seq_grupo_ans nr_seq_grupo_ans,
		e.nr_sequencia nr_seq_protocolo,
		c.nr_seq_fatura nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		coalesce(c.nr_seq_prestador_exec,e.nr_seq_congenere) nr_seq_prestador,
		c.nr_sequencia nr_seq_conta,
		t.nr_sequencia nr_seq_contrato,
		k.ie_tipo_grupo_ans,
		c.nr_seq_prestador_exec nr_seq_prestador_exec,
		e.nr_seq_congenere,
		null vl_deferido,
		null cd_abi,
		null nr_aih
	FROM pls_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
LEFT OUTER JOIN pls_plano y ON (s.nr_seq_plano = y.nr_sequencia)
, pls_conta_mat m
LEFT OUTER JOIN ans_grupo_despesa k ON (m.nr_seq_grupo_ans = k.nr_sequencia)
, pls_protocolo_conta e
LEFT OUTER JOIN pls_congenere i ON (e.nr_seq_congenere = i.nr_sequencia)
WHERE c.nr_sequencia 		= m.nr_seq_conta and e.nr_sequencia 		= c.nr_seq_protocolo      and ((e.dt_mes_competencia between dt_inicial_w and dt_final_w
	and	((e.ie_tipo_protocolo <> 'R') or ie_forma_contab_reembolso_w = 'C'))
	or	(e.dt_fechamento_contas between dt_inicial_w and dt_final_w
	and	((e.ie_tipo_protocolo = 'R') and ie_forma_contab_reembolso_w = 'L'))
	or	(e.dt_mes_competencia between dt_inicial_w and dt_final_w
	and	((e.ie_tipo_protocolo = 'R') and ie_forma_contab_reembolso_w = 'M'))) and (ie_gerar_ind_classif_w <> 'N'
	or	substr(m.cd_classif_tx_inter_deb,1,5) = '4.1.1') and e.ie_tipo_protocolo = 'I' and c.ie_status <> 'C' and m.ie_status <> 'D' and (c.ie_tipo_segurado = ie_tipo_segurado_w or coalesce(ie_tipo_segurado_w::text, '') = '') and (e.ie_tipo_protocolo = ie_tipo_protocolo_w or coalesce(ie_tipo_protocolo_w::text, '') = '') and qt_regra_reemb_taxa_w > 0
	 
union all

	select 	c.nr_sequencia nr_documento,
		null ie_tipo_protocolo,
		null nr_seq_material,
		null cd_procedimento,
		null ie_origem_proced,
		c.dt_internacao dt_ocorrencia,
		coalesce(p.dt_recebimento,p.dt_processo) dt_conhecimento,
		t.dt_liquidacao,
		s.ie_tipo_segurado,
		'PC' ie_tipo_documento,
		null ie_ato_cooperado,
		a.ie_preco ie_modalidade_contrat,
		a.ie_regulamentacao ie_regulamentacao,
		a.ie_tipo_contratacao ie_tipo_contratacao,
		a.ie_segmentacao ie_segmentacao,
		coalesce(c.vl_ressarcir, pls_conta_processo_obter_valor(c.nr_sequencia)) vl_evento,
		null vl_ajuste,
		c.vl_ressarcir vl_pagamento,
		null vl_glosa,
		null vl_coparticipacao,
		null vl_taxa_pgto,
		p.dt_processo dt_contabilizacao,
		c.cd_conta_cred cd_conta_credito,
		c.cd_conta_deb cd_conta_debito,
		r.nr_contrato nr_contrato,
		null nr_seq_resumo,
		CASE WHEN a.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia nr_seq_segurado,
		null nr_seq_grupo_ans,
		null nr_seq_protocolo,
		null nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		c.nr_seq_prestador nr_seq_prestador,
		null nr_seq_conta,
		r.nr_sequencia nr_seq_contrato,
		null ie_tipo_grupo_ans,
		c.nr_seq_prestador nr_seq_prestador_exec,
		null nr_seq_congenere,
		coalesce(c.vl_deferido,0) vl_deferido,
		p.cd_abi cd_abi,
		c.nr_aih nr_aih
	FROM pls_processo_gru g, pls_processo p
LEFT OUTER JOIN titulo_pagar t ON (p.nr_sequencia = t.nr_seq_processo)
, pls_processo_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
LEFT OUTER JOIN pls_plano a ON (s.nr_seq_plano = a.nr_sequencia)
WHERE p.nr_sequencia		= c.nr_seq_processo     and t.nr_seq_proc_gru	= g.nr_sequencia and c.nr_seq_proc_gru	= g.nr_sequencia and p.dt_processo between dt_inicial_w and dt_final_w and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and (ie_gerar_ind_classif_w <> 'N'
	or 	substr(c.cd_classif_deb,1,5) = '4.1.1')
	 
union all

	select 	c.nr_sequencia nr_documento,
		null ie_tipo_protocolo,
		null nr_seq_material,
		null cd_procedimento,
		null ie_origem_proced,
		c.dt_internacao dt_ocorrencia,
		coalesce(p.dt_recebimento,p.dt_processo) dt_conhecimento,
		null dt_liquidacao,
		s.ie_tipo_segurado,
		'PC' ie_tipo_documento,
		null ie_ato_cooperado,
		a.ie_preco ie_modalidade_contrat,
		a.ie_regulamentacao,
		a.ie_tipo_contratacao,
		a.ie_segmentacao,
		coalesce(c.vl_ressarcir, pls_conta_processo_obter_valor(c.nr_sequencia)) vl_evento,
		null vl_ajuste,
		c.vl_ressarcir vl_pagamento,
		null vl_glosa,
		null vl_coparticipacao,
		null vl_taxa_pgto,
		p.dt_processo dt_contabilizacao,
		c.cd_conta_cred cd_conta_credito,
		c.cd_conta_deb cd_conta_debito,
		r.nr_contrato,	
		null nr_seq_resumo,
		CASE WHEN a.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia nr_seq_segurado,
		null nr_seq_grupo_ans,
		null nr_seq_protocolo,
		null nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		c.nr_seq_prestador,
		null nr_seq_conta,
		r.nr_sequencia nr_seq_contrato,
		null ie_tipo_grupo_ans,
		c.nr_seq_prestador nr_seq_prestador_exec,
		null nr_seq_congenere,
		coalesce(c.vl_deferido,0) vl_deferido,
		p.cd_abi cd_abi,
		c.nr_aih nr_aih
	FROM pls_processo p, pls_processo_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
LEFT OUTER JOIN pls_plano a ON (s.nr_seq_plano = a.nr_sequencia)
WHERE p.nr_sequencia		= c.nr_seq_processo    and p.dt_processo between dt_inicial_w and dt_final_w and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and coalesce(c.nr_seq_proc_gru::text, '') = '' and (ie_gerar_ind_classif_w <> 'N'
	or 	substr(c.cd_classif_deb,1,5) = '4.1.1')
	 
union all

	select 	c.nr_sequencia nr_documento,
		null ie_tipo_protocolo,
		null nr_seq_material,
		null cd_procedimento,
		null ie_origem_proced,
		c.dt_internacao dt_ocorrencia,
		coalesce(p.dt_recebimento,p.dt_processo) dt_conhecimento,
		t.dt_liquidacao,
		s.ie_tipo_segurado,
		'PR' ie_tipo_documento,
		null ie_ato_cooperado,
		a.ie_preco ie_modalidade_contrat,
		a.ie_regulamentacao,
		a.ie_tipo_contratacao,
		a.ie_segmentacao,
		coalesce(b.vl_provisao, 0) vl_evento,
		null vl_ajuste,
		c.vl_ressarcir vl_pagamento,
		null vl_glosa,
		null vl_coparticipacao,
		null vl_taxa_pgto,
		p.dt_processo dt_contabilizacao,
		b.cd_conta_cred_prov cd_conta_credito,
		b.cd_conta_deb_prov cd_conta_debito,
		r.nr_contrato,
		null nr_seq_resumo,
		CASE WHEN a.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia nr_seq_segurado,
		null nr_seq_grupo_ans,
		null nr_seq_protocolo,
		null nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		c.nr_seq_prestador,
		null nr_seq_conta,
		r.nr_sequencia nr_seq_contrato,
		null ie_tipo_grupo_ans,
		c.nr_seq_prestador nr_seq_prestador_exec,
		null nr_seq_congenere,
		0 vl_deferido,
		p.cd_abi cd_abi,
		c.nr_aih nr_aih
	FROM pls_processo_gru g, pls_processo_competencia d, pls_processo_contas_comp b, pls_processo p
LEFT OUTER JOIN titulo_pagar t ON (p.nr_sequencia = t.nr_seq_processo)
, pls_processo_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
LEFT OUTER JOIN pls_plano a ON (s.nr_seq_plano = a.nr_sequencia)
WHERE p.nr_sequencia		= c.nr_seq_processo     and t.nr_seq_proc_gru	= g.nr_sequencia and c.nr_seq_proc_gru	= g.nr_sequencia and c.nr_sequencia		= b.nr_seq_conta and b.nr_seq_competencia	= d.nr_sequencia and d.dt_competencia between dt_inicial_w and dt_final_w and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and b.ie_tipo_movimentacao = 'P' and coalesce(b.vl_provisao, 0) <> 0 and (ie_gerar_ind_classif_w <> 'N'
	or 	substr(b.cd_classif_deb_prov,1,5) = '4.1.1')
	 
union all

	select 	c.nr_sequencia nr_documento,
		null ie_tipo_protocolo,
		null nr_seq_material,
		null cd_procedimento,
		null ie_origem_proced,
		c.dt_internacao dt_ocorrencia,
		coalesce(p.dt_recebimento,p.dt_processo) dt_conhecimento,
		null dt_liquidacao,
		s.ie_tipo_segurado,
		'PR' ie_tipo_documento,
		null ie_ato_cooperado,
		a.ie_preco ie_modalidade_contrat,
		a.ie_regulamentacao,
		a.ie_tipo_contratacao,
		a.ie_segmentacao,
		coalesce(b.vl_provisao, 0) vl_evento,
		null vl_ajuste,
		c.vl_ressarcir vl_pagamento,
		null vl_glosa,
		null vl_coparticipacao,
		null vl_taxa_pgto,
		p.dt_processo dt_contabilizacao,
		b.cd_conta_cred_prov cd_conta_credito,
		b.cd_conta_deb_prov cd_conta_debito,
		r.nr_contrato,
		null nr_seq_resumo,
		CASE WHEN a.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia nr_seq_segurado,
		null nr_seq_grupo_ans,
		null nr_seq_protocolo,
		null nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		c.nr_seq_prestador,
		null nr_seq_conta,
		r.nr_sequencia nr_seq_contrato,
		null ie_tipo_grupo_ans,
		c.nr_seq_prestador nr_seq_prestador_exec,
		null nr_seq_congenere,
		0 vl_deferido,
		p.cd_abi cd_abi,
		c.nr_aih nr_aih
	FROM pls_processo p, pls_processo_competencia d, pls_processo_contas_comp b, pls_processo_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
LEFT OUTER JOIN pls_plano a ON (s.nr_seq_plano = a.nr_sequencia)
WHERE p.nr_sequencia		= c.nr_seq_processo    and c.nr_sequencia		= b.nr_seq_conta and b.nr_seq_competencia	= d.nr_sequencia and d.dt_competencia between dt_inicial_w and dt_final_w and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and coalesce(c.nr_seq_proc_gru::text, '') = '' and b.ie_tipo_movimentacao = 'P' and (ie_gerar_ind_classif_w <> 'N'
	or 	substr(b.cd_classif_deb_prov,1,5) = '4.1.1')
	 
union all

	select 	c.nr_sequencia nr_documento,
		null ie_tipo_protocolo,
		null nr_seq_material,
		null cd_procedimento,
		null ie_origem_proced,
		c.dt_internacao dt_ocorrencia,
		coalesce(p.dt_recebimento,p.dt_processo) dt_conhecimento,
		t.dt_liquidacao,
		s.ie_tipo_segurado,
		'AJ' ie_tipo_documento,
		null ie_ato_cooperado,
		a.ie_preco ie_modalidade_contrat,
		a.ie_regulamentacao,
		a.ie_tipo_contratacao,
		a.ie_segmentacao,
		coalesce(b.vl_ajuste, 0) vl_evento,
		null vl_ajuste,
		c.vl_ressarcir vl_pagamento,
		null vl_glosa,
		null vl_coparticipacao,
		null vl_taxa_pgto,
		p.dt_processo dt_contabilizacao,
		b.cd_conta_cred_ajuste cd_conta_credito,
		b.cd_conta_deb_ajuste cd_conta_debito,
		r.nr_contrato,
		null nr_seq_resumo,
		CASE WHEN a.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia nr_seq_segurado,
		null nr_seq_grupo_ans,
		null nr_seq_protocolo,
		null nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		c.nr_seq_prestador,
		null nr_seq_conta,
		r.nr_sequencia nr_seq_contrato,
		null ie_tipo_grupo_ans,
		c.nr_seq_prestador nr_seq_prestador_exec,
		null nr_seq_congenere,
		0 vl_deferido,
		p.cd_abi cd_abi,
		c.nr_aih nr_aih
	FROM pls_processo_gru g, pls_processo_competencia d, pls_processo_contas_comp b, pls_processo p
LEFT OUTER JOIN titulo_pagar t ON (p.nr_sequencia = t.nr_seq_processo)
, pls_processo_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
LEFT OUTER JOIN pls_plano a ON (s.nr_seq_plano = a.nr_sequencia)
WHERE p.nr_sequencia		= c.nr_seq_processo     and t.nr_seq_proc_gru	= g.nr_sequencia and c.nr_seq_proc_gru	= g.nr_sequencia and c.nr_sequencia		= b.nr_seq_conta and b.nr_seq_competencia	= d.nr_sequencia and d.dt_competencia between dt_inicial_w and dt_final_w and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and b.ie_tipo_movimentacao = 'P' and (ie_gerar_ind_classif_w <> 'N'
	or 	substr(b.cd_classif_deb_ajuste,1,5) = '4.1.1')
	 
union all

	select 	c.nr_sequencia nr_documento,
		null ie_tipo_protocolo,
		null nr_seq_material,
		null cd_procedimento,
		null ie_origem_proced,
		c.dt_internacao dt_ocorrencia,
		coalesce(p.dt_recebimento,p.dt_processo) dt_conhecimento,
		null dt_liquidacao,
		s.ie_tipo_segurado,
		'AJ' ie_tipo_documento,
		null ie_ato_cooperado,
		a.ie_preco ie_modalidade_contrat,
		a.ie_regulamentacao,
		a.ie_tipo_contratacao,
		a.ie_segmentacao,
		coalesce(b.vl_ajuste, 0) vl_evento,
		null vl_ajuste,
		c.vl_ressarcir vl_pagamento,
		null vl_glosa,
		null vl_coparticipacao,
		null vl_taxa_pgto,
		p.dt_processo dt_contabilizacao,
		b.cd_conta_cred_ajuste cd_conta_credito,
		b.cd_conta_deb_ajuste cd_conta_debito,
		r.nr_contrato,
		null nr_seq_resumo,
		CASE WHEN a.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia nr_seq_segurado,
		null nr_seq_grupo_ans,
		null nr_seq_protocolo,
		null nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		c.nr_seq_prestador,
		null nr_seq_conta,
		r.nr_sequencia nr_seq_contrato,
		null ie_tipo_grupo_ans,
		c.nr_seq_prestador nr_seq_prestador_exec,
		null nr_seq_congenere,
		0 vl_deferido,
		p.cd_abi cd_abi,
		c.nr_aih nr_aih
	FROM pls_processo p, pls_processo_competencia d, pls_processo_contas_comp b, pls_processo_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
LEFT OUTER JOIN pls_plano a ON (s.nr_seq_plano = a.nr_sequencia)
WHERE p.nr_sequencia		= c.nr_seq_processo    and c.nr_sequencia		= b.nr_seq_conta and b.nr_seq_competencia	= d.nr_sequencia and d.dt_competencia between dt_inicial_w and dt_final_w and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and (ie_gerar_ind_classif_w <> 'N'
	or 	substr(b.cd_classif_deb_ajuste,1,5) = '4.1.1') and coalesce(c.nr_seq_proc_gru::text, '') = '' and b.ie_tipo_movimentacao = 'P'	
         
union all

	select 	c.nr_sequencia nr_documento,
		null ie_tipo_protocolo,
		null nr_seq_material,
		null cd_procedimento,
		null ie_origem_proced,
		c.dt_internacao dt_ocorrencia,
		coalesce(p.dt_recebimento,p.dt_processo) dt_conhecimento,
		t.dt_liquidacao,
		s.ie_tipo_segurado,
		'PC' ie_tipo_documento,
		null ie_ato_cooperado,
		a.ie_preco ie_modalidade_contrat,
		a.ie_regulamentacao ie_regulamentacao,
		a.ie_tipo_contratacao ie_tipo_contratacao,
		a.ie_segmentacao ie_segmentacao,
		pls_conta_processo_obter_valor(c.nr_sequencia) vl_evento,
		null vl_ajuste,
		c.vl_ressarcir vl_pagamento,
		null vl_glosa,
		null vl_coparticipacao,
		null vl_taxa_pgto,
		p.dt_processo dt_contabilizacao,
		c.cd_conta_cred_processo cd_conta_credito_processo,
		c.cd_conta_deb_processo cd_conta_debito_processo,
		r.nr_contrato nr_contrato,
		null nr_seq_resumo,
		CASE WHEN a.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia nr_seq_segurado,
		null nr_seq_grupo_ans,
		null nr_seq_protocolo,
		null nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		c.nr_seq_prestador nr_seq_prestador,
		null nr_seq_conta,
		r.nr_sequencia nr_seq_contrato,
		null ie_tipo_grupo_ans,
		c.nr_seq_prestador nr_seq_prestador_exec,
		null nr_seq_congenere,
		coalesce(c.vl_deferido,0) vl_deferido,
		p.cd_abi cd_abi,
		c.nr_aih nr_aih
	FROM pls_processo_gru g, pls_processo p
LEFT OUTER JOIN titulo_pagar t ON (p.nr_sequencia = t.nr_seq_processo)
, pls_processo_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
LEFT OUTER JOIN pls_plano a ON (s.nr_seq_plano = a.nr_sequencia)
WHERE p.nr_sequencia		= c.nr_seq_processo     and t.nr_seq_proc_gru	= g.nr_sequencia and c.nr_seq_proc_gru	= g.nr_sequencia and p.dt_processo between dt_inicial_w and dt_final_w and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and (ie_gerar_ind_classif_w <> 'N'
	or 	substr(c.cd_classif_deb_processo,1,5) = '4.1.1') and pls_conta_processo_obter_valor(c.nr_sequencia) > 0
	 
union all

	select 	c.nr_sequencia nr_documento,
		null ie_tipo_protocolo,
		null nr_seq_material,
		null cd_procedimento,
		null ie_origem_proced,
		c.dt_internacao dt_ocorrencia,
		coalesce(p.dt_recebimento,p.dt_processo) dt_conhecimento,
		null dt_liquidacao,
		s.ie_tipo_segurado,
		'PC' ie_tipo_documento,
		null ie_ato_cooperado,
		a.ie_preco ie_modalidade_contrat,
		a.ie_regulamentacao,
		a.ie_tipo_contratacao,
		a.ie_segmentacao,
		pls_conta_processo_obter_valor(c.nr_sequencia) vl_evento,
		null vl_ajuste,
		c.vl_ressarcir vl_pagamento,
		null vl_glosa,
		null vl_coparticipacao,
		null vl_taxa_pgto,
		p.dt_processo dt_contabilizacao,
		c.cd_conta_cred_processo cd_conta_credito_processo,
		c.cd_conta_deb_processo cd_conta_debito_processo,
		r.nr_contrato,	
		null nr_seq_resumo,
		CASE WHEN a.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
		s.nr_sequencia nr_seq_segurado,
		null nr_seq_grupo_ans,
		null nr_seq_protocolo,
		null nr_seq_fatura,
		null nr_seq_conta_resumo,
		coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
		c.nr_seq_prestador,
		null nr_seq_conta,
		r.nr_sequencia nr_seq_contrato,
		null ie_tipo_grupo_ans,
		c.nr_seq_prestador nr_seq_prestador_exec,
		null nr_seq_congenere,
		coalesce(c.vl_deferido,0) vl_deferido,
		p.cd_abi cd_abi,
		c.nr_aih nr_aih
	FROM pls_processo p, pls_processo_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
LEFT OUTER JOIN pls_plano a ON (s.nr_seq_plano = a.nr_sequencia)
WHERE p.nr_sequencia		= c.nr_seq_processo    and p.dt_processo between dt_inicial_w and dt_final_w and ((coalesce(ie_tipo_segurado_w, 'X')	= coalesce(s.ie_tipo_segurado, 'X'))
	or (coalesce(ie_tipo_segurado_w, 'X')	= 'X')) and coalesce(c.nr_seq_proc_gru::text, '') = '' and (ie_gerar_ind_classif_w <> 'N'
	or 	substr(c.cd_classif_deb_processo,1,5) = '4.1.1') and pls_conta_processo_obter_valor(c.nr_sequencia) > 0 order by nr_documento;
	
vet_medica c_medica%rowtype;
			

BEGIN

CALL wheb_usuario_pck.set_ie_executar_trigger('N');

SELECT 	trunc(dt_inicial,'dd'),
	fim_dia(dt_final),
	ie_tipo_protocolo,
	ie_tipo_segurado,
	ie_gerar_ind_classif
INTO STRICT   	dt_inicial_w,
	dt_final_w,
	ie_tipo_protocolo_w,
	ie_tipo_segurado_w,
	ie_gerar_ind_classif_w
FROM   ctb_livro_auxiliar
WHERE  nr_sequencia = nr_seq_reg_auxiliar_p;

select	max(ie_lote_ajuste_prod),	
	coalesce(max(ie_forma_contab_taxa_pgto),'N')
into STRICT	ie_lote_ajuste_prod_w,
	ie_forma_contab_taxa_pgto_w
from	pls_parametro_contabil
where	cd_estabelecimento = cd_estabelecimento_p;

dt_referencia_month_w	:= trunc(dt_inicial_w,'month');

select	sum(CASE WHEN ie_prestador_codificacao='P' THEN  0  ELSE 1 END ) qt_prest_outros
into STRICT	qt_prest_outros_w
from	pls_esquema_contabil
where	ie_tipo_regra		= 'PP'
and	cd_estabelecimento	= cd_estabelecimento_p
and	dt_referencia_month_w between dt_inicio_vigencia and coalesce(dt_fim_vigencia, dt_referencia_month_w);

select	coalesce(max(ie_forma_contab_reembolso),'C')
into STRICT	ie_forma_contab_reembolso_w
from	pls_parametro_contabil
where	cd_estabelecimento = cd_estabelecimento_p;

select	coalesce(max(a.ie_data_tipo_segurado),'A')
into STRICT	ie_data_tipo_segurado_w
from	pls_parametros a
where	a.cd_estabelecimento = cd_estabelecimento_p;

select	substr(obter_desc_expressao(922923),1,255)
into STRICT	ds_observacao_w
;

select	count(*)
into STRICT	qt_regra_evento_w
from	pls_esquema_contabil a
where	dt_inicial_w between dt_inicio_vigencia and coalesce(dt_fim_vigencia, dt_final_w)
and	ie_tipo_regra = 'IC'
and	coalesce(a.ie_tipo_movimentacao, 11) = 11
and 	a.cd_estabelecimento = cd_estabelecimento_p
and	exists (	SELECT	1
		from	pls_esquema_contabil_seg b
		where	b.nr_seq_regra_esquema = a.nr_sequencia);					

select	count(*)
into STRICT	qt_regra_reemb_taxa_w
from	pls_esquema_contabil a
where	dt_inicial_w between dt_inicio_vigencia and coalesce(dt_fim_vigencia, dt_final_w)
and	ie_tipo_regra = 'IC'
and	coalesce(a.ie_tipo_movimentacao, 33) in (33,34)
and 	a.cd_estabelecimento = cd_estabelecimento_p
and	exists (	SELECT	1
		from	pls_esquema_contabil_seg b
		where	b.nr_seq_regra_esquema = a.nr_sequencia);

delete
from	pls_aux_event_avisados a
where	nr_seq_reg_auxiliar = nr_seq_reg_auxiliar_p;

commit;

ie_nao_aplica_recalc_w := obter_param_usuario(1314, 3, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_nao_aplica_recalc_w);

open c_medica;
loop
fetch c_medica into	
	vet_medica;
EXIT WHEN NOT FOUND; /* apply on c_medica */
	begin

	/* Foi feito este nvl devido aos casos de selects que retornam explicitamente nulo o dt_ocorrencia (05/jul/2019 - O union esta apenas no select do delphi), passando a utilizar o dt_conhecimento */

	if (ie_data_tipo_segurado_w = 'A') then
		dt_ref_repasse_w	:= coalesce(vet_medica.dt_ocorrencia, vet_medica.dt_conhecimento);
	else
		dt_ref_repasse_w	:= vet_medica.dt_conhecimento;
	end if;
	
	SELECT * FROM pls_obter_dados_repasse(	dt_ref_repasse_w, vet_medica.nr_seq_segurado, vet_medica.nr_seq_congenere, ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w) INTO STRICT ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w;

	if (vet_medica.ie_tipo_protocolo = 'C') then
		select max(t.dt_emissao),
			max(t.dt_vencimento_original),
			max(v.nr_titulo)
		into STRICT	dt_emissao_w,
			dt_vencimento_w,
			nr_titulo_w
		from	pls_pagamento_prestador 	a,
			pls_conta_medica_resumo 	r,
			titulo_pagar 			t,
			pls_pag_prest_vencimento 	v,
			pls_lote_pagamento	 	l,
			pls_conta 			c
		where	a.nr_seq_prestador 	= r.nr_seq_prestador_pgto
		and 	a.nr_sequencia      	= v.nr_seq_pag_prestador
		and	v.nr_titulo      	= t.nr_titulo
		and	l.nr_sequencia 		= r.nr_seq_lote_pgto
		and	a.nr_seq_lote		= l.nr_sequencia
		and	r.nr_sequencia 		= vet_medica.nr_seq_conta_resumo
		and	r.nr_seq_conta		= vet_medica.nr_documento
		and	c.nr_sequencia 		= r.nr_seq_conta;
		
	elsif (vet_medica.ie_tipo_protocolo = 'R') then
		select max(t.dt_emissao),
			max(t.dt_vencimento_original),
			coalesce(max(t.nr_titulo),0)
		into STRICT	dt_emissao_w,
			dt_vencimento_w,
			nr_titulo_w
		from	pls_protocolo_conta		p,
			titulo_pagar			t
		where	p.nr_sequencia = t.nr_seq_reembolso
		and	p.nr_sequencia = vet_medica.nr_seq_protocolo;
		
	elsif (vet_medica.ie_tipo_protocolo = 'I') then
		select max(t.dt_emissao),
			max(t.dt_vencimento_original),
			max(t.nr_titulo)
		into STRICT	dt_emissao_w,
			dt_vencimento_w,
			nr_titulo_w
		from   	titulo_pagar t,
			ptu_fatura   f
		where  	f.nr_sequencia = t.nr_titulo
		and	f.nr_sequencia = vet_medica.nr_seq_fatura;
	end if;
		
	nr_contador_w := nr_contador_w + 1;
		
	if (vet_medica.vl_ajuste < 0 or ie_lote_ajuste_prod_w = 'R') then
		vet_medica.vl_ajuste	:= 0;
	end if;
	
	ds_observacao_item_w	:= null;
	
	if (vet_medica.ie_tipo_segurado in ('C', 'I', 'T')) then
		ds_observacao_item_w	:= ds_observacao_w;
	end if;
	
	insert into pls_aux_event_avisados(	nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_protocolo,
			ie_tipo_protocolo,
			nr_documento,
			nr_seq_material,
			cd_procedimento,
			ie_origem_proced,
			dt_realizacao,
			dt_aviso,
			ie_tipo_segurado,
			ie_tipo_documento,
			nr_registro_produto,
			ie_ato_cooperado,
			ie_tipo_modalidade,
			ie_regulamentacao,
			ie_tipo_contratacao,
			ie_segmentacao,
			vl_evento,
			vl_pagamento,
			vl_ajuste,
			vl_glosa,
			vl_coparticipacao,
			vl_taxa_pgto,
			dt_contabil,
			dt_pagamento,
			cd_conta_debito,
			cd_conta_credito,
			nr_contrato,
			nr_seq_reg_auxiliar,
			nr_seq_segurado,
			nr_seq_grupo_ans,
			dt_emissao,
			dt_vencimento,
			nr_titulo,
			nr_seq_pagador,
			nr_seq_prestador,
			nr_seq_conta,
			nr_seq_contrato,
			ie_tipo_vinculo,
			ie_tipo_evento,
			ie_tipo_repasse,
			ie_tipo_compartilhamento,
			dt_inicio_compartilhamento,
			dt_fim_compartilhamento,
			ds_observacao,
			vl_deferido,
			cd_abi,
			nr_aih)
		values (	nextval('pls_aux_event_avisados_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			vet_medica.nr_seq_protocolo,
			vet_medica.ie_tipo_protocolo,
			vet_medica.nr_documento,
			vet_medica.nr_seq_material,
			vet_medica.cd_procedimento,
			vet_medica.ie_origem_proced,
			vet_medica.dt_ocorrencia,
			vet_medica.dt_conhecimento,
			vet_medica.ie_tipo_segurado,
			vet_medica.ie_tipo_documento,
			vet_medica.nr_protocolo_ans,
			vet_medica.ie_ato_cooperado,
			vet_medica.ie_modalidade_contrat,
			vet_medica.ie_regulamentacao,
			vet_medica.ie_tipo_contratacao,
			vet_medica.ie_segmentacao,
			vet_medica.vl_evento,
			vet_medica.vl_pagamento,
			vet_medica.vl_ajuste,
			vet_medica.vl_glosa,
			coalesce(vet_medica.vl_coparticipacao,0),
			vet_medica.vl_taxa_pgto,
			vet_medica.dt_contabilizacao,
			vet_medica.dt_liquidacao,
			vet_medica.cd_conta_debito,
			vet_medica.cd_conta_credito,
			vet_medica.nr_contrato,
			nr_seq_reg_auxiliar_p,
			vet_medica.nr_seq_segurado,
			vet_medica.nr_seq_grupo_ans,
			dt_emissao_w,
			dt_vencimento_w,
			nr_titulo_w,
			vet_medica.nr_seq_titular,
			vet_medica.nr_seq_prestador,
			vet_medica.nr_seq_conta,
			vet_medica.nr_seq_contrato,
			(SELECT	ie_tipo_relacao	
				FROM	pls_prestador 
				WHERE 	nr_sequencia = vet_medica.nr_seq_prestador_exec),
			vet_medica.ie_tipo_grupo_ans,
			ie_tipo_repasse_w,
			ie_tipo_compartilhamento_w,
			dt_repasse_w,
			dt_fim_repasse_w,
			ds_observacao_item_w,
			vet_medica.vl_deferido,
			vet_medica.cd_abi,
			vet_medica.nr_aih);
			
		if (mod(nr_contador_w, 1000) = 0) then
			commit;
		end if;	
				
	end;
end loop;
close c_medica;

update	ctb_livro_auxiliar
set	qt_registros	= nr_contador_w
where	nr_sequencia	= nr_seq_reg_auxiliar_p;

commit;

CALL wheb_usuario_pck.set_ie_executar_trigger('S');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_event_avisados ( nr_seq_reg_auxiliar_p ctb_livro_auxiliar.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

