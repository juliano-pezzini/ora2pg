-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_interf_k315_ecd ( nr_seq_controle_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, cd_empresa_p bigint, cd_conta_contabil_p text, ie_debito_credito_elimin_p text, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) AS $body$
DECLARE


ds_arquivo_w            		varchar(4000);
ds_compl_arquivo_w      		varchar(4000);
ds_linha_w              			varchar(8000);
nr_linha_w              			bigint := qt_linha_p;
nr_seq_registro_w       		bigint := nr_sequencia_p;
sep_w                   			varchar(1) := '|';
tp_registro_w           		varchar(15) := 'K315';
cd_empresa_w            		grupo_emp_estrutura.cd_empresa%type;
vl_eliminacao_w         		ctb_movimento.vl_movimento%type;
ie_debito_credito_elimin_w    		varchar(1);
/* precisa ser type com a classificação, pois pode mudar o formato */

ie_apres_conta_ctb_w  		ctb_regra_sped.ie_apres_conta_ctb%type;
cd_conta_contabil_w		ctb_saldo.cd_classificacao%type;

c01 CURSOR FOR
  SELECT emp2.cd_empresa        cd_empresa,
       'D'                      ie_debito_credito,
       m2.cd_conta_debito       cd_conta_contabil,
       m2.vl_movimento          vl_eliminacao
  from ctb_movimento m,
       ctb_movimento m2,
       empresa emp,
       estabelecimento e,
       estabelecimento e2,
       empresa emp2,
       ctb_mes_ref re
 where m.nr_seq_movto_eliminacao 	= m2.nr_sequencia
   and m.cd_estabelecimento 		= e.cd_estabelecimento
   and m2.cd_estabelecimento 	= e2.cd_estabelecimento
   and emp.cd_empresa 		= e.cd_empresa
   and emp2.cd_empresa 		= e2.cd_empresa
   and re.nr_sequencia 		= m2.nr_seq_mes_ref
   and m2.dt_movimento between dt_inicio_p and dt_fim_p
   and emp.cd_empresa 		= cd_empresa_p  -- controlara
   -- conta_controladora como parametro
   and coalesce(m.cd_conta_debito, m.cd_conta_credito) = cd_conta_contabil_p
   and	ie_debito_credito_elimin_p 	= 'C'
   and (m2.cd_conta_debito IS NOT NULL AND m2.cd_conta_debito::text <> '')

union

SELECT emp2.cd_empresa       cd_empresa,
       'C'                   ie_debito_credito,
       m2.cd_conta_credito   cd_conta_contabil,
       m2.vl_movimento       vl_eliminacao
  from ctb_movimento m,
       ctb_movimento m2,
       empresa emp,
       estabelecimento e,
       estabelecimento e2,
       empresa emp2,
       ctb_mes_ref re
 where m.nr_seq_movto_eliminacao 	= m2.nr_sequencia
   and m.cd_estabelecimento 		= e.cd_estabelecimento
   and m2.cd_estabelecimento 	= e2.cd_estabelecimento
   and emp.cd_empresa 		= e.cd_empresa
   and emp2.cd_empresa 		= e2.cd_empresa
   and re.nr_sequencia 		= m2.nr_seq_mes_ref
   and m2.dt_movimento between dt_inicio_p and dt_fim_p
   and emp.cd_empresa 		= cd_empresa_p  -- controlara
   and coalesce(m.cd_conta_debito, m.cd_conta_credito) = cd_conta_contabil_p  -- conta_controladora
   and	ie_debito_credito_elimin_p = 'D'
   and (m2.cd_conta_credito IS NOT NULL AND m2.cd_conta_credito::text <> '');


BEGIN

  select  coalesce(max(a.ie_apres_conta_ctb),'CD')
  into STRICT  ie_apres_conta_ctb_w
  from   ctb_regra_sped a,
         ctb_sped_controle b
  where  b.nr_seq_regra_sped   	= a.nr_sequencia
  and    b.nr_sequencia    		= nr_seq_controle_p;

open c01;
loop
fetch c01  into
  cd_empresa_w,
  ie_debito_credito_elimin_w,
  cd_conta_contabil_w,
  vl_eliminacao_w;
  EXIT WHEN NOT FOUND; /* apply on c01 */

  if (ie_apres_conta_ctb_w = 'CL') then
    	begin
		      cd_conta_contabil_w	:= substr(ctb_obter_classif_conta(cd_conta_contabil_w,null,dt_fim_p),1,40);
    	end;
 	elsif (ie_apres_conta_ctb_w = 'CP') then
    	begin
	    cd_conta_contabil_w	:= substr(replace(ctb_obter_classif_conta(cd_conta_contabil_w,null,dt_fim_p),'.',''),1,40);
    	end;
 	end if;

  begin
    ds_linha_w  := substr(sep_w 		||
        tp_registro_w      			|| sep_w ||
        cd_empresa_w      			|| sep_w ||
        cd_conta_contabil_w    			|| sep_w ||
        replace(replace(campo_mascara_virgula(vl_eliminacao_w),'.',''),'-','')  || sep_w ||
        ie_debito_credito_elimin_w  	|| sep_w,1,8000);

    ds_arquivo_w    		:= substr(ds_linha_w,1,4000);
    ds_compl_arquivo_w  	:= substr(ds_linha_w,4001,4000);
    nr_seq_registro_w    	:= nr_seq_registro_w + 1;
    nr_linha_w    		:= nr_linha_w + 1;

    insert into ctb_sped_registro(
        nr_sequencia,
        ds_arquivo,
        dt_atualizacao,
        nm_usuario,
        dt_atualizacao_nrec,
        nm_usuario_nrec,
        nr_seq_controle_sped,
        ds_arquivo_compl,
        cd_registro,
        nr_linha)
      values (
        nr_seq_registro_w,
        ds_arquivo_w,
        clock_timestamp(),
        nm_usuario_p,
        clock_timestamp(),
        nm_usuario_p,
        nr_seq_controle_p,
        ds_compl_arquivo_w,
        tp_registro_w,
        nr_linha_w);

  end;
end loop;
close c01;

commit;
qt_linha_p  := nr_linha_w;
nr_sequencia_p  := nr_seq_registro_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_interf_k315_ecd ( nr_seq_controle_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, cd_empresa_p bigint, cd_conta_contabil_p text, ie_debito_credito_elimin_p text, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) FROM PUBLIC;

