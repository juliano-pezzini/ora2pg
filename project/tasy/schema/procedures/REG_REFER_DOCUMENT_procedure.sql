-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reg_refer_document ( nr_seq_document_rev_p reg_documento.nr_sequencia%TYPE, nr_seq_document_ref_p reg_documento.nr_sequencia%TYPE, nm_usuario_p reg_documento.nm_usuario%TYPE ) AS $body$
DECLARE


	nr_seq_revision_w	reg_revisao_documento.nr_sequencia%TYPE;
	nr_seq_approval_test_w	reg_revisao_documento.nr_sequencia%TYPE;


BEGIN
	IF (nr_seq_document_ref_p = nr_seq_document_rev_p) THEN
		CALL wheb_mensagem_pck.exibir_mensagem_abort(795139);-- Um documento n√£o pode referenciar a si mesmo
	END IF;

	SELECT	MAX(r.nr_sequencia)
	INTO STRICT	nr_seq_revision_w
	FROM	reg_revisao_documento r
	WHERE	nr_seq_documento = nr_seq_document_rev_p;

	SELECT	MAX(nr_sequencia)
	INTO STRICT	nr_seq_approval_test_w
	FROM	reg_aprovacao_documento
	WHERE	nr_seq_revisao	= nr_seq_revision_w;

	IF (nr_seq_approval_test_w IS NOT NULL AND nr_seq_approval_test_w::text <> '') THEN
		CALL wheb_mensagem_pck.exibir_mensagem_abort(794841);
	END IF;

	INSERT INTO reg_referencia_documento(nr_sequencia, nr_seq_documento, nr_seq_revisao, dt_atualizacao, dt_atualizacao_nrec, nm_usuario, nm_usuario_nrec)
					VALUES (nextval('reg_referencia_documento_seq'), nr_seq_document_ref_p, nr_seq_revision_w, clock_timestamp(), clock_timestamp(), nm_usuario_p, nm_usuario_p);
	COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reg_refer_document ( nr_seq_document_rev_p reg_documento.nr_sequencia%TYPE, nr_seq_document_ref_p reg_documento.nr_sequencia%TYPE, nm_usuario_p reg_documento.nm_usuario%TYPE ) FROM PUBLIC;

