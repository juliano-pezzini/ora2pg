-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_rateio_tit_rep (nr_titulo_p titulo_pagar.nr_titulo%type, nm_usuario_p text) AS $body$
DECLARE


cd_centro_custo_w               ctb_repasse_centro_custo.cd_centro_custo%type;
cd_estabelecimento_w            estabelecimento.cd_estabelecimento%type;
cd_setor_atendimento_w          setor_atendimento.cd_setor_atendimento%type;
ie_cc_repasse_w                 ctb_param_lote_tit_repasse.ie_cc_repasse%type;
ie_contab_classif_tit_rep_w     ctb_param_lote_tit_repasse.ie_contab_classif_tit_rep%type;
ie_contab_item_rep_liq_w        ctb_param_lote_tit_repasse.ie_contab_item_rep_liq%type;
ie_contab_trib_repasse_cc_w ctb_param_lote_tit_repasse.ie_contab_trib_repasse_cc%type;
ie_rep_contab_vl_liberado_w     ctb_param_lote_tit_repasse.ie_rep_contab_vl_liberado%type;
ie_tipo_transacao_w             varchar(1);
nr_lote_contabil_w              ctb_repasse_centro_custo.nr_lote_contabil%type;
nr_repasse_terceiro_w           ctb_repasse_centro_custo.nr_repasse_terceiro%type;
nr_seq_repasse_centro_custo_w   ctb_repasse_centro_custo.nr_sequencia%type;
nr_seq_trans_fin_w              ctb_repasse_centro_custo.nr_seq_trans_fin%type;
nr_sequencia_w                  ctb_repasse_centro_custo.nr_sequencia%type;
qt_registro_w                   bigint;
vl_glosa_repasse_w              ctb_repasse_centro_custo.vl_glosa_repasse%type;
vl_maior_repasse_w              ctb_repasse_centro_custo.vl_maior_repasse%type;
vl_repasse_liberado_item_w      titulo_pagar.vl_titulo%type;
vl_repasse_liberado_w           titulo_pagar.vl_titulo%type;
vl_repasse_w                    ctb_repasse_centro_custo.vl_repasse%type;
vl_titulo_w                     ctb_repasse_centro_custo.vl_titulo%type;
vl_transacao_w                  titulo_pagar.vl_titulo%type;
vl_tributo_w                    ctb_repasse_centro_custo.vl_tributo%type;
vl_vencimento_w                 ctb_repasse_centro_custo.vl_vencimento%type;

/*
 IE_TIPO:
'G' vl_glosa_repasse    VL_GLOSA_REPASSE
'M' vl_maior_repasse    VL_MAIOR_REPASSE
'T' vl_titulo           VL_TITULO_REPASSE
'V' vl_vencimento_w     VL_REPASSE_VENC
'R' vl_repasse          VL_ITEM_REPASSE
'B' vl_tributo          VL_TRIBUTO_REPASSE
*/
C010 CURSOR FOR
SELECT	'G' ie_tipo,
	d.cd_centro_custo,
        coalesce(sum(somente_positivo(coalesce(vl_repasse,0) - coalesce(vl_liberado,0))  + OBTER_GLOSA_REP_NEGATIVO(b.nr_sequencia, null)),0)
from 	Setor_atendimento d,
        procedimento_paciente c,
        procedimento_repasse b,
        titulo_pagar a
where	a.nr_titulo	        = nr_titulo_p
and	a.nr_repasse_terceiro	= b.nr_repasse_terceiro
and	b.nr_seq_procedimento	= c.nr_sequencia
and	c.cd_setor_atendimento	= d.cd_setor_atendimento
and	coalesce(b.ie_estorno,'N') <> 'S'
group   by 'G', d.cd_centro_custo, d.cd_setor_atendimento, a.nr_repasse_terceiro

union   all

PERFORM	'G' ie_tipo,
        d.cd_centro_custo,
        coalesce(sum(somente_positivo(coalesce(vl_repasse,0) - coalesce(vl_liberado,0)) + OBTER_GLOSA_REP_NEGATIVO(null, b.nr_sequencia)), 0)
from 	Setor_atendimento d,
        material_atend_paciente c,
        material_repasse b,
        titulo_pagar a
where	a.nr_titulo = nr_titulo_p
and	a.nr_repasse_terceiro	= b.nr_repasse_terceiro
and	b.nr_seq_material	= c.nr_sequencia
and	c.cd_setor_atendimento	= d.cd_setor_atendimento
and	coalesce(b.ie_estorno,'N') <> 'S'
group   by 'G', d.cd_centro_custo, d.cd_setor_atendimento, a.nr_repasse_terceiro

union   all

select  'M' ie_tipo,
	d.cd_centro_custo,
        coalesce(sum(somente_positivo(coalesce(vl_liberado,0) - coalesce(vl_repasse,0))),0)
from 	Setor_atendimento d,
        procedimento_paciente c,
        procedimento_repasse b,
        titulo_pagar a
where	a.nr_titulo             = nr_titulo_p
and	a.nr_repasse_terceiro	= b.nr_repasse_terceiro
and	b.nr_seq_procedimento	= c.nr_sequencia
and	c.cd_setor_atendimento	= d.cd_setor_atendimento
and	coalesce(b.ie_estorno,'N') <> 'S'
group   by 'M', d.cd_centro_custo, d.cd_setor_atendimento, a.nr_repasse_terceiro

union	all

select  'M' ie_tipo,
        d.cd_centro_custo,
        coalesce(sum(somente_positivo(coalesce(vl_liberado,0) - coalesce(vl_repasse,0))), 0)
from 	Setor_atendimento d,
        material_atend_paciente c,
        material_repasse b,
        titulo_pagar a
where	a.nr_titulo = nr_titulo_p
and	a.nr_repasse_terceiro	= b.nr_repasse_terceiro
and	b.nr_seq_material	= c.nr_sequencia
and	c.cd_setor_atendimento	= d.cd_setor_atendimento
and	coalesce(b.ie_estorno,'N') <> 'S'
group   by 'M', d.cd_centro_custo, d.cd_setor_atendimento, a.nr_repasse_terceiro

union   all

select	'T' ie_tipo,
        d.cd_centro_custo,
        sum(dividir_sem_round(b.vl_liberado, vl_repasse_liberado_w) * a.vl_titulo)
from 	Setor_atendimento d,
        procedimento_paciente c,
        procedimento_repasse b,
        titulo_pagar a
where	a.nr_titulo		= nr_titulo_p
and	a.nr_repasse_terceiro	= b.nr_repasse_terceiro
and	b.nr_seq_procedimento	= c.nr_sequencia
and	c.cd_setor_atendimento	= d.cd_setor_atendimento
and	ie_cc_repasse_w		= 'S'
and     ie_contab_classif_tit_rep_w = 'N'
group   by 'T', d.cd_centro_custo, d.cd_setor_atendimento, a.nr_repasse_terceiro

union	all

select	'T' ie_tipo,
        d.cd_centro_custo,
        sum(dividir_sem_round(b.vl_liberado, vl_repasse_liberado_w) * a.vl_titulo)
from 	Setor_atendimento d,
	material_atend_paciente c,
	material_repasse b,
	titulo_pagar a
where	a.nr_titulo		= nr_titulo_p
and	a.nr_repasse_terceiro	= b.nr_repasse_terceiro
and	b.nr_seq_material	= c.nr_sequencia
and	c.cd_setor_atendimento	= d.cd_setor_atendimento
and	ie_cc_repasse_w		= 'S'
and     ie_contab_classif_tit_rep_w = 'N'
group   by 'T', d.cd_centro_custo, d.cd_setor_atendimento, a.nr_repasse_terceiro

union	all

select 	'T' ie_tipo,
        a.cd_centro_custo,
        sum(vl_repasse)
from 	repasse_terceiro_item a,
	titulo_pagar b
where	a.nr_repasse_terceiro	= b.nr_repasse_terceiro
and	b.nr_repasse_terceiro	= nr_repasse_terceiro_w
and	b.nr_titulo		= nr_titulo_p
and	a.nr_seq_trans_fin	= nr_seq_trans_fin_w
and	ie_cc_repasse_w		= 'S'
and	ie_contab_item_rep_liq_w = 'S'
and	not exists (select	1
                from	procedimento_repasse y
                where	y.nr_repasse_terceiro	= a.nr_repasse_terceiro
                and	y.nr_repasse_terceiro	= nr_repasse_terceiro_w)
group   by 'T', a.cd_centro_custo, 0, a.nr_repasse_terceiro

union   all

select 	'T' ie_tipo,
        d.cd_centro_custo,
        sum(dividir_sem_round(d.vl_repasse, vl_repasse_liberado_item_w) * a.vl_titulo)
from 	REPASSE_TERCEIRO b,
        titulo_pagar a,
        repasse_terceiro_item d
where	a.nr_repasse_terceiro = b.nr_repasse_terceiro
and 	d.nr_repasse_terceiro  = b.nr_repasse_terceiro
and 	a.nr_repasse_terceiro = nr_repasse_terceiro_w
and 	a.nr_titulo = nr_titulo_p
and 	d.nr_seq_trans_fin	= nr_seq_trans_fin_w
and	ie_cc_repasse_w		= 'S'
and	ie_contab_item_rep_liq_w = 'N'
AND 	NOT EXISTS (SELECT	1
                FROM	procedimento_repasse y
                WHERE	y.nr_repasse_terceiro	= b.nr_repasse_terceiro
                and     y.nr_repasse_terceiro	= nr_repasse_terceiro_w)
group   by 'T', d.cd_centro_custo, 0, a.nr_repasse_terceiro

union   all

select	'T',
	b.cd_centro_custo,
	b.vl_titulo
from    titulo_pagar_classif b,
        titulo_Pagar a
where	a.nr_titulo	= b.nr_titulo
and	a.nr_titulo	= nr_titulo_p
and     ie_cc_repasse_w = 'S'
and     ie_contab_classif_tit_rep_w = 'S'
and	exists (	select 	1
                        from 	procedimento_repasse c
                        where 	c.nr_repasse_terceiro	= a.nr_repasse_terceiro
                        
union all

                        select 	1 
                        from 	material_repasse d
                        where 	d.nr_repasse_terceiro	= a.nr_repasse_terceiro)

union   all

select	'V' ie_tipo,
        d.cd_centro_custo,
        sum(dividir_sem_round(b.vl_liberado, vl_repasse_liberado_w) * (a.vl_titulo + obter_valor_tot_trib_inf(nr_titulo_p)))
from 	Setor_atendimento d,
        procedimento_paciente c,
        procedimento_repasse b,
        titulo_pagar a
where	a.nr_titulo             = nr_titulo_p
and	a.nr_repasse_terceiro	= b.nr_repasse_terceiro
and	b.nr_seq_procedimento	= c.nr_sequencia
and	c.cd_setor_atendimento	= d.cd_setor_atendimento
and	ie_cc_repasse_w		= 'S'
group   by 'V', d.cd_centro_custo, d.cd_setor_atendimento, a.nr_repasse_terceiro

union	all

select	'V' ie_tipo,
        b.cd_centro_custo,
        sum(dividir_sem_round(b.vl_repasse, vl_repasse_liberado_item_w) * (a.vl_titulo + obter_valor_tot_trib_inf(nr_titulo_p)))
from 	repasse_terceiro_item b,
	titulo_pagar a
where	a.nr_titulo             = nr_titulo_p
and	a.nr_repasse_terceiro	= b.nr_repasse_terceiro
and	ie_cc_repasse_w		= 'S'
and	not exists (select 	1
                    from 	procedimento_repasse c
                    where 	c.nr_repasse_terceiro	= b.nr_repasse_terceiro
                    
union all

                    select 	1
                    from 	material_repasse d
                    where 	d.nr_repasse_terceiro	= b.nr_repasse_terceiro)
group   by 'V', b.cd_centro_custo, b.cd_setor_atendimento, a.nr_repasse_terceiro

union	all

select	'V' ie_tipo,
        d.cd_centro_custo,
        sum(dividir_sem_round(b.vl_liberado, vl_repasse_liberado_w) * (a.vl_titulo + obter_valor_tot_trib_inf(nr_titulo_p)))
from 	Setor_atendimento d,
        material_atend_paciente c,
        material_repasse b,
        titulo_pagar a
where	a.nr_titulo		= nr_titulo_p
and	a.nr_repasse_terceiro	= b.nr_repasse_terceiro
and	b.nr_seq_material	= c.nr_sequencia
and	c.cd_setor_atendimento	= d.cd_setor_atendimento
and	ie_cc_repasse_w		= 'S'
group   by 'V', d.cd_centro_custo, d.cd_setor_atendimento, a.nr_repasse_terceiro

union   all

/*
select	'R' ie_tipo,
        d.cd_centro_custo,
        sum(b.vl_repasse) vl_repasse
from 	Setor_atendimento d,
	procedimento_paciente c,
	procedimento_repasse b,
	titulo_pagar a
where	a.nr_titulo		= nr_titulo_p
and	a.nr_repasse_terceiro	= b.nr_repasse_terceiro
and	b.nr_seq_procedimento	= c.nr_sequencia
and	c.cd_setor_atendimento	= d.cd_setor_atendimento
and	ie_cc_repasse_w		= 'S'
and     ie_rep_contab_vl_liberado_w = 'S'
group by 'R', d.cd_centro_custo, d.cd_setor_atendimento, a.nr_repasse_terceiro
union	all
select	'R' ie_tipo,
        d.cd_centro_custo,
        sum(dividir_sem_round(b.vl_liberado, vl_repasse_liberado_w) * a.vl_titulo)
from 	Setor_atendimento d,
        procedimento_paciente c,
        procedimento_repasse b,
        titulo_pagar a
where	a.nr_titulo             = nr_titulo_p
and	a.nr_repasse_terceiro	= b.nr_repasse_terceiro
and	b.nr_seq_procedimento	= c.nr_sequencia
and	c.cd_setor_atendimento	= d.cd_setor_atendimento
and	ie_cc_repasse_w		= 'S'
and     ie_rep_contab_vl_liberado_w = 'N'
group by 'R', d.cd_centro_custo, d.cd_setor_atendimento, a.nr_repasse_terceiro
union all
select	'R' ie_tipo,
        d.cd_centro_custo,
        sum(dividir_sem_round(b.vl_liberado, vl_repasse_liberado_w) * a.vl_titulo)
from 	Setor_atendimento d,
        material_atend_paciente c,
        material_repasse b,
        titulo_pagar a
where	a.nr_titulo		= nr_titulo_p
and     a.nr_repasse_terceiro	= b.nr_repasse_terceiro
and     b.nr_seq_material	= c.nr_sequencia
and     c.cd_setor_atendimento	= d.cd_setor_atendimento
and	ie_cc_repasse_w		= 'S'
group by 'R', d.cd_centro_custo, d.cd_setor_atendimento, a.nr_repasse_terceiro;
union all
*/
select 	'R' ie_tipo,
        a.cd_centro_custo,
        sum(vl_repasse)
from 	repasse_terceiro_item a
where	nr_repasse_terceiro	= nr_repasse_terceiro_w
and     nr_seq_trans_fin	= nr_seq_trans_fin_w
and	ie_cc_repasse_w		= 'S'
and	ie_contab_item_rep_liq_w = 'N'
group   by 'R', a.cd_centro_custo, 0, a.nr_repasse_terceiro

union   all

select	'B' ie_tipo,
	d.cd_centro_custo,
	sum(dividir_sem_round(b.vl_liberado, vl_repasse_liberado_w) * a.vl_titulo)
from 	Setor_atendimento d,
	procedimento_paciente c,
	procedimento_repasse b,
	titulo_pagar a
where	a.nr_titulo             = nr_titulo_p
and	a.nr_repasse_terceiro	= b.nr_repasse_terceiro
and	b.nr_seq_procedimento	= c.nr_sequencia
and	c.cd_setor_atendimento	= d.cd_setor_atendimento
and     ie_contab_classif_tit_rep_w     = 'N'
and	ie_contab_trib_repasse_cc_w     = 'S'
group	by d.cd_centro_custo, d.cd_setor_atendimento

union	all

select	'B' ie_tipo,
	d.cd_centro_custo,
	sum(dividir_sem_round(b.vl_liberado, vl_repasse_liberado_w) * a.vl_titulo)
from 	Setor_atendimento d,
	material_atend_paciente c,
	material_repasse b,
	titulo_pagar a
where	a.nr_titulo             = nr_titulo_p
and	a.nr_repasse_terceiro	= b.nr_repasse_terceiro
and	b.nr_seq_material       = c.nr_sequencia
and	c.cd_setor_atendimento	= d.cd_setor_atendimento
and     ie_contab_classif_tit_rep_w     = 'N'
and	ie_contab_trib_repasse_cc_w     = 'S'
group	by d.cd_centro_custo, d.cd_setor_atendimento

union all
 
select	'B' ie_tipo,
	b.cd_centro_custo,
	b.vl_titulo
from    titulo_pagar_classif b,
        titulo_Pagar a
where	a.nr_titulo	= b.nr_titulo
and	a.nr_titulo	= nr_titulo_p
and     ie_contab_classif_tit_rep_w     = 'S'
and     ie_contab_trib_repasse_cc_w     = 'S'
and	exists (        select 	1 
                        from 	procedimento_repasse c
                        where 	c.nr_repasse_terceiro	= a.nr_repasse_terceiro
                        
union all

                        select 	1 
                        from 	material_repasse d
                        where 	d.nr_repasse_terceiro	= a.nr_repasse_terceiro
                        
union all

                        select 1
                        from 	repasse_terceiro_item e
                        where 	e.nr_repasse_terceiro	= a.nr_repasse_terceiro
                        and     ie_contab_trib_repasse_cc_w     = 'S');


BEGIN

select  nr_seq_trans_fin_contab,
        nr_repasse_terceiro,
        cd_estabelecimento
into STRICT    nr_seq_trans_fin_w,
        nr_repasse_terceiro_w,
        cd_estabelecimento_w
from    titulo_pagar
where   nr_titulo = nr_titulo_p;

vl_repasse_liberado_w		:= coalesce(obter_valor_repasse(nr_repasse_terceiro_w, 'LI'),0);
vl_repasse_liberado_item_w	:= coalesce(obter_valor_repasse(nr_repasse_terceiro_w, 'RI'),0);

select	coalesce(ie_contab_item_rep_liq,'N'),
        coalesce(ie_rep_contab_vl_liberado,'N'),
        ie_cc_repasse,
        coalesce(ie_contab_classif_tit_rep, 'N'),
        coalesce(ie_contab_trib_repasse_cc, 'N')
into STRICT    ie_contab_item_rep_liq_w,
        ie_rep_contab_vl_liberado_w,
        ie_cc_repasse_w,
        ie_contab_classif_tit_rep_w,
        ie_contab_trib_repasse_cc_w
from    ctb_param_lote_tit_repasse
where   cd_empresa = obter_empresa_estab(cd_estabelecimento_w)
and     coalesce(cd_estab_exclusivo, cd_estabelecimento_w) = cd_estabelecimento_w;

open C010;
loop
fetch   C010 into
        ie_tipo_transacao_w,
        cd_centro_custo_w,
        vl_transacao_w;
EXIT WHEN NOT FOUND; /* apply on C010 */

    if (vl_transacao_w <> 0) then

        vl_glosa_repasse_w  := 0;
        vl_maior_repasse_w  := 0;
        vl_repasse_w        := 0;
        vl_titulo_w         := 0;
        vl_vencimento_w     := 0;
        vl_tributo_w        := 0;

        begin
            case ie_tipo_transacao_w
                when 'G' then vl_glosa_repasse_w := vl_transacao_w;
                when 'M' then vl_maior_repasse_w := vl_transacao_w;
                when 'R' then vl_repasse_w       := vl_transacao_w;
                when 'T' then vl_titulo_w        := vl_transacao_w;
                when 'V' then vl_vencimento_w    := vl_transacao_w;
                when 'B' then vl_tributo_w       := vl_transacao_w;
            end case;
        end;

        select 	count(1) qt_registro,
                max(nr_sequencia) nr_sequencia
        into STRICT    qt_registro_w,
                nr_sequencia_w
        from    ctb_repasse_centro_custo
        where   cd_centro_custo     = cd_centro_custo_w
        and     nr_repasse_terceiro = nr_repasse_terceiro_w
        and     nr_seq_trans_fin    = nr_seq_trans_fin_w
        and     nr_titulo           = nr_titulo_p;

        if (qt_registro_w > 0) then
                update  ctb_repasse_centro_custo a
                set     a.vl_glosa_repasse  = a.vl_glosa_repasse + vl_glosa_repasse_w,
                        a.vl_maior_repasse  = a.vl_maior_repasse + vl_maior_repasse_w,
                        a.vl_repasse        = a.vl_repasse + vl_repasse_w,
                        a.vl_titulo         = a.vl_titulo + vl_titulo_w,
                        a.vl_vencimento     = a.vl_vencimento + vl_vencimento_w
                where   a.nr_sequencia      = nr_sequencia_w;
        else
                -- SE NÃO TIVER CENTRO DE CUSTO INFORMADO PARA O SETOR DE ATENDIMENTO DAR UMA MENSAGEM PARA O USUÁRIO
                if (coalesce(cd_centro_custo_w,0) = 0) then
                        CALL wheb_mensagem_pck.exibir_mensagem_abort(1059830);
                end if;

                insert  into    ctb_repasse_centro_custo(
                                nr_sequencia,
                                cd_centro_custo,
                                dt_atualizacao,
                                nm_usuario,
                                nr_repasse_terceiro,
                                nr_titulo,
                                nr_seq_trans_fin,
                                vl_glosa_repasse,
                                vl_maior_repasse,
                                vl_repasse,
                                vl_titulo,
                                vl_vencimento,
                                vl_tributo
                ) values (
                                nextval('ctb_repasse_centro_custo_seq'),
                                cd_centro_custo_w,
                                clock_timestamp(),
                                nm_usuario_p,
                                nr_repasse_terceiro_w,
                                nr_titulo_p,
                                nr_seq_trans_fin_w,
                                vl_glosa_repasse_w,
                                vl_maior_repasse_w,
                                vl_repasse_w,
                                vl_titulo_w,
                                vl_vencimento_w,
                                vl_tributo_w
                );
        end if;
    end if;
end loop;
close C010;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_rateio_tit_rep (nr_titulo_p titulo_pagar.nr_titulo%type, nm_usuario_p text) FROM PUBLIC;

