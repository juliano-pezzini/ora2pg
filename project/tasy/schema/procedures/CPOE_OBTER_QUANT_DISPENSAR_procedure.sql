-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_obter_quant_dispensar (cd_estabelecimento_p bigint, cd_material_p bigint, nr_sequencia_p bigint, cd_intervalo_p text, ie_via_aplicacao_p text, qt_unitaria_p bigint, qt_dose_esp_p bigint, nr_ocorrencia_p bigint, ds_dose_dif_p text, ie_origem_inf_p text, cd_unid_med_dose_p text, qt_dias_p bigint, qt_material_p INOUT bigint, qt_dispensar_p INOUT bigint, ie_regra_disp_p INOUT text, ds_erro_p INOUT text, ie_se_necessario_p text, ie_acm_p text) AS $body$
DECLARE


qt_unitaria_w				double precision 	:= 0;
qt_dose_esp_w				double precision 	:= 0;
qt_dispensar_w				double precision 	:= 0;
qt_material_w				double precision	:= 0;
qt_multiplo_w				double precision	:= 0;
qt_max_pres_w				double precision	:= 0;
nr_multiplo_w				double precision	:= 0;
qt_mat_w					bigint;
cd_unid_med_w				varchar(30);
ie_regra_disp_w				varchar(1);
ie_regra_w					varchar(1);
cd_convenio_w				integer	:= 0;
cd_setor_w					integer	:= 0;
nr_atendimento_w			bigint	:= 0;
qt_conversao_w				double precision	:= 0;
cd_unidade_medida_w			varchar(30);
cd_material_estoque_w       varchar(6);
cd_unidade_medida_estoque_w	varchar(30);
qt_dias_w					integer	:= 1;
ie_usuario_def_disp_w		varchar(1);
cd_perfil_w					bigint;
ie_motivo_prescricao_w		varchar(3);

/*
cd_unidade_medida_dose_w		Varchar2(30);
cd_unid_med_cursor_w		Varchar2(30);
ie_unidade_medida_w		varchar2(1); */
C01 CURSOR FOR
	SELECT	ie_regra,
			ie_regra_disp,
			coalesce(ie_usuario_def_disp,'N')
	from	material_regra_disp
	where	1 = 1
	and		(((coalesce(cd_unid_med_w,cd_unidade_medida) = cd_unidade_medida) and (ie_unidade_medida = 1)) or
			 ((coalesce(cd_unid_med_dose_p,cd_unidade_medida) = cd_unidade_medida) and (ie_unidade_medida = 2)) or
			 ((coalesce(cd_unidade_medida_estoque_w,cd_unidade_medida) = cd_unidade_medida) and (ie_unidade_medida = 3)) or (coalesce(cd_unidade_medida::text, '') = ''))
	and		(((coalesce(ie_acm_sn,'X') = 'N') and (coalesce(ie_acm_p,'N')  = 'N') and (coalesce(ie_se_necessario_p,'N') = 'N')) or
			 ((coalesce(ie_acm_sn,'X') = 'S') and
			  ((coalesce(ie_acm_p,'N') = 'S') or (coalesce(ie_se_necessario_p,'N') = 'S'))) or (coalesce(ie_acm_sn,'X') = 'X'))
	and		coalesce(cd_unid_med_estoque, cd_unidade_medida_estoque_w) = cd_unidade_medida_estoque_w
	and		((coalesce(ie_via_aplicacao::text, '') = '') or (coalesce(ie_via_aplicacao_p, ie_via_aplicacao) = ie_via_aplicacao))
	and		((coalesce(cd_intervalo::text, '') = '') or (coalesce(cd_intervalo_p, cd_intervalo) = cd_intervalo))
	and		coalesce(cd_convenio, cd_convenio_w)		= cd_convenio_w
	and		coalesce(cd_setor_atendimento,cd_setor_w)	= cd_setor_w
	and		(((coalesce(cd_material, cd_material_p)	= cd_material_p) and (coalesce(ie_material_estoque,'N') = 'N')) or
			((coalesce(cd_material, cd_material_estoque_w)	= cd_material_estoque_w) and (coalesce(ie_material_estoque,'N') = 'S')))
	and		coalesce(cd_perfil, cd_perfil_w) = cd_perfil_w
	and		cd_estabelecimento	= cd_estabelecimento_p
	and 	((coalesce(IE_MOTIVO_PRESCRICAO::text, '') = '') or (IE_MOTIVO_PRESCRICAO = IE_MOTIVO_PRESCRICAO_w))
	and		((coalesce(nr_seq_estrut_int::text, '') = '') or (consistir_se_mat_estrutura(nr_seq_estrut_int,cd_material_p) = 'S'))
	order by coalesce(cd_material,0),
		--nvl(ie_unidade_medida,0),
		coalesce(cd_convenio,0),
		coalesce(cd_setor_atendimento,0),
		coalesce(cd_unidade_medida,'zzzz') desc,
		coalesce(ie_via_aplicacao,'zzzz') desc,
		coalesce(nr_seq_estrut_int,0),
		coalesce(cd_intervalo,0);

/* Marcus 15/07/2004 alterou a via de aplicacao e intervalo */

BEGIN

/*   Edilson em 28/11/05 OS 24673 mudei o parâmetro pelo campo ie_unidade_medida no cursor
select	nvl(nvl(vl_parametro, vl_parametro_padrao),'S')
into	ie_unidade_medida_w
from	funcao_parametro
where	cd_funcao = 924
and	nr_sequencia = 63;

cd_unidade_medida_dose_w	:= nvl(cd_unid_med_dose_p,'zzzz'); */
/*
select	nvl(max(cd_unidade_medida_dose),'zzzz')
into	cd_unidade_medida_dose_w
from	prescr_material
where	nr_prescricao		= nr_prescricao_p
and	nr_sequencia		= nr_sequencia_p;
*/
select	count(*)
into STRICT 	qt_mat_w
from	Material
where	cd_material	= cd_material_p;

if (qt_mat_w > 0) and (nr_sequencia_p	> 0) then

	cd_perfil_w		:= coalesce(obter_perfil_ativo,0);

	ds_erro_p		:= '';
	qt_unitaria_w	:= qt_unitaria_p;

	select	coalesce(qt_minimo_multiplo_solic,1),
			coalesce(qt_max_prescricao,0),
			substr(obter_dados_material_estab(cd_material,cd_estabelecimento_p,'UMS'),1,30) cd_unidade_medida_consumo,
			substr(obter_dados_material_estab(cd_material,cd_estabelecimento_p,'UME'),1,30) cd_unidade_medida_estoque,
			substr(obter_dados_material(cd_material_p,'EST'),1,30)
	into STRICT	qt_multiplo_w,
			qt_max_pres_w,
			cd_unid_med_w,
			cd_unidade_medida_estoque_w,
			cd_material_estoque_w
	from	material
	where	cd_material	= cd_material_p;

	if (qt_multiplo_w = 0) then
		qt_multiplo_w := 1;
	end if;


	/* Edilson em 28/11/05 OS 24673
	cd_unid_med_cursor_w	:= cd_unid_med_w;
	if	(ie_unidade_medida_w = 'N') and
		(cd_unidade_medida_dose_w <> 'zzzz') then
		cd_unid_med_cursor_w	:= cd_unidade_medida_dose_w;
	end if; */
	if (qt_dias_p IS NOT NULL AND qt_dias_p::text <> '') and (qt_dias_p > 0) then
		qt_dias_w	:= qt_dias_p;
	end if;

	ie_regra_w		:= 'S';
	select	max(nr_atendimento),
			max('')
	into STRICT	nr_atendimento_w,
			ie_motivo_prescricao_w
	from	cpoe_material
	where	nr_sequencia	= nr_sequencia_p;

	select	coalesce(max(cd_convenio),0),
			coalesce(max(cd_setor_atendimento),0)
	into STRICT	cd_convenio_w,
			cd_setor_w
	from	atendimento_paciente_v
	where	nr_atendimento = nr_atendimento_w;


	open	c01;
	loop
	fetch	c01 into	ie_regra_w,
				ie_regra_disp_w,
				ie_usuario_def_disp_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		ie_regra_w				:= ie_regra_w;
		ie_regra_disp_w			:= ie_regra_disp_w;
		ie_usuario_def_disp_w	:= ie_usuario_def_disp_w;
	end loop;
	close c01;

--	if	(ie_usuario_def_disp_w = 'S') then
--		update	cpoe_material
--		set		ie_regra_disp	= decode(nvl(ie_regra_disp,'X'), 'D', ie_regra_disp, 'U')
--		where	nr_sequencia	= nr_sequencia_p;
--		commit;
--	end if;
	if (ie_regra_w	= 'S') and (trunc(qt_unitaria_w,0) <> qt_unitaria_w) then
		qt_unitaria_w	:= trunc(qt_unitaria_w,0) + 1;
	elsif (ie_regra_w	= 'I') and (trunc(qt_unitaria_w,0) <> qt_unitaria_w) then
		qt_unitaria_w	:= trunc(qt_unitaria_w,0);
	end if;

	if (coalesce(ds_dose_dif_p::text, '') = '') then
		qt_material_w		:= round((qt_unitaria_w * nr_ocorrencia_p)::numeric,3);
		/*
			Round para a seguinte situação:
			Medicameto de 1 FA com 750mg
			prescrito 500mg -> qtUnitario = 0,666667
			ocorrencia = 3
			0,666667 * 3 = 2,000001 --> Ao gerar a dispensasão ele pensa que precisa de 3 pois ja passou de 2, mas isso so por causa do arredondamento,
			pois 500*3 => 1500/750 => 2. Logo 2 basta.
		*/
	elsif (coalesce(qt_material_p,0) = 0) then
		qt_material_w 		:= obter_qt_material_dose_dif(cd_material_p, cd_unid_med_dose_p, ds_dose_dif_p);
	else
		qt_material_w		:= qt_material_p;
	end if;

	if (coalesce(qt_dose_esp_p, 0) > 0) then
		cd_unidade_medida_w	:= coalesce(cd_unid_med_dose_p,'zzzz');

--		select	nvl(max(nvl(cd_unid_med_dose_esp, cd_unid_med_dose_p)),'zzzz')
		select	coalesce(max(coalesce(cd_unidade_medida, cd_unid_med_dose_p)),'zzzz')
		into STRICT	cd_unidade_medida_w
		from	cpoe_material
		where	nr_sequencia		= nr_sequencia_p;

		if (coalesce(cd_unidade_medida_w::text, '') = '') or (cd_unidade_medida_w = 'zzzz') then
			cd_unidade_medida_w	:= coalesce(cd_unid_med_dose_p,'zzzz');
		end if;

		select	coalesce(max(qt_conversao),1)
		into STRICT	qt_conversao_w
		from	material_conversao_unidade
		where	cd_unidade_medida	= cd_unidade_medida_w
		and		cd_material		= cd_material_p;

		qt_dose_esp_w		:= dividir(qt_dose_esp_p, qt_conversao_w);

		if (ie_regra_w	= 'S') and (trunc(qt_dose_esp_w,0) <> qt_dose_esp_w) then
			qt_dose_esp_w	:= trunc(qt_dose_esp_w,0) + 1;
		elsif (ie_regra_w	= 'I') and (trunc(qt_dose_esp_w,0) <> qt_dose_esp_w) then
			qt_dose_esp_w	:= trunc(qt_dose_esp_w,0);
		end if;
		qt_material_w		:= qt_material_w + qt_dose_esp_w;
	end if;

	ie_regra_disp_w		:= coalesce(ie_regra_disp_w,'C');
	/* 	Rotina para definir a dispensação de um material
		C= Sol Min.Cadastro
		M= Mantem a Pedida,
		S= Arredonda Superior */
	if (ie_origem_inf_p = '9') or (ie_regra_disp_w = 'M') then
		qt_dispensar_w		:= qt_material_w;
	elsif (ie_regra_disp_w = 'S') then
		begin
		if (trunc(qt_material_w,0) = qt_material_w) then
			qt_Dispensar_w	:= qt_material_w;
		else
			qt_Dispensar_w	:= trunc(qt_material_w,0) + 1;
		end if;
		end;
	elsif (ie_regra_disp_w = 'I') then
		begin
		if (trunc(qt_material_w,0) = qt_material_w) then
			qt_Dispensar_w	:= qt_material_w;
		else
			qt_Dispensar_w	:= trunc(qt_material_w,0);
		end if;
		end;
	else
		begin

		if (ie_regra_disp_w = 'C') then --Solicitação Min. Cadastro
			if	((trunc(qt_material_w / qt_multiplo_w) * qt_multiplo_w) = qt_material_w) then
				nr_multiplo_w	:= (qt_material_w / qt_multiplo_w);
			else
				nr_multiplo_w   := trunc(qt_material_w / qt_multiplo_w) + 1;
			end if;
			qt_Dispensar_w	:= qt_multiplo_w * nr_multiplo_w;

		else
			--Solicitação Min. Cadastro - Por horário
			if	((trunc(qt_unitaria_w / qt_multiplo_w) * qt_multiplo_w) = qt_unitaria_w) then
				nr_multiplo_w	:= (qt_unitaria_w / qt_multiplo_w);
			else
				nr_multiplo_w   := trunc(qt_unitaria_w / qt_multiplo_w) + 1;
			end if;
			qt_Dispensar_w	:= qt_multiplo_w * nr_multiplo_w;
			qt_Dispensar_w	:= round((qt_Dispensar_w * nr_ocorrencia_p)::numeric,3);

		end if;

		end;
	end if;


	if (qt_max_pres_w > 0) and (qt_Dispensar_w > qt_max_pres_w) then
		ds_erro_p	:= wheb_mensagem_pck.get_texto(277848, 'QT_MAX_PRES_P=' || qt_max_pres_w || ';CD_UNID_MED_P=' || cd_unid_med_w);
	end if;

	qt_material_p	:= qt_dias_w * qt_material_w;
	qt_dispensar_p	:= qt_dias_w * qt_dispensar_w;

	if (ie_usuario_def_disp_w = 'S') then
		ie_regra_disp_p	:= 'U';
	elsif (ie_usuario_def_disp_w = 'K') then
		ie_regra_disp_p	:= 'N';
	elsif (ie_usuario_def_disp_w = 'E') then
		ie_regra_disp_p	:= ie_usuario_def_disp_w;
	else
		ie_regra_disp_p	:= 'S';
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_obter_quant_dispensar (cd_estabelecimento_p bigint, cd_material_p bigint, nr_sequencia_p bigint, cd_intervalo_p text, ie_via_aplicacao_p text, qt_unitaria_p bigint, qt_dose_esp_p bigint, nr_ocorrencia_p bigint, ds_dose_dif_p text, ie_origem_inf_p text, cd_unid_med_dose_p text, qt_dias_p bigint, qt_material_p INOUT bigint, qt_dispensar_p INOUT bigint, ie_regra_disp_p INOUT text, ds_erro_p INOUT text, ie_se_necessario_p text, ie_acm_p text) FROM PUBLIC;

