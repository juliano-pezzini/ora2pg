-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_reg_complaint_decision ( nr_seq_ordem_serv_p bigint, nr_seq_reg_tipo_risco_p bigint, ie_severity_harm_p bigint, ie_probability_harm_p bigint, ds_history_p text, nr_seq_tipo_hist_p bigint, nm_usuario_p text) AS $body$
DECLARE


alterou_info_w 			varchar(1);
ie_plataforma_w 		man_ordem_servico.ie_plataforma%type;
nr_versao_cliente_w 		man_ordem_servico.nr_versao_cliente_abertura%type;
os_duplicadas_w 		varchar(1000);
nr_customer_requirement_w       man_ordem_servico.nr_customer_requirement%type;
nr_seq_estagio_w		man_ordem_servico.nr_seq_estagio%type;
ie_area_gerencia_w 		gerencia_wheb.ie_area_gerencia%type;
nr_seq_estagio_os_w		man_ordem_serv_estagio.nr_sequencia%type;
ie_suporte_w			man_estagio_processo.ie_suporte%type;
ie_desenv_w				man_estagio_processo.ie_desenv%type;


BEGIN

if (nr_seq_ordem_serv_p IS NOT NULL AND nr_seq_ordem_serv_p::text <> '') then	

        update 	man_ordem_servico
        set 	nr_seq_reg_tipo_risco	= nr_seq_reg_tipo_risco_p,
                ie_severity_harm 	= ie_severity_harm_p,
                ie_probability_harm 	= ie_probability_harm_p,
                nm_usuario              = nm_usuario_p,
                dt_atualizacao          = clock_timestamp()
        where 	nr_sequencia = nr_seq_ordem_serv_p;

        insert into man_ordem_serv_tecnico(
                nr_sequencia,
                nr_seq_ordem_serv,
                dt_atualizacao,
                nm_usuario,
                ds_relat_tecnico,
                cd_versao_tasy,
                dt_historico,
                ie_origem,
                nr_seq_tipo,
                nm_usuario_lib,
                dt_liberacao,
                ie_grau_satisfacao)
        values (
                nextval('man_ordem_serv_tecnico_seq'),
                nr_seq_ordem_serv_p,
                clock_timestamp(),
                nm_usuario_p,
                ds_history_p,
                null,
                clock_timestamp(),
                'I',
                nr_seq_tipo_hist_p,
                nm_usuario_p,
                clock_timestamp(),
                null);
        commit;
	
	select	max(nr_sequencia)
	into STRICT	nr_seq_estagio_os_w
	from (
		SELECT	a.nr_sequencia
		from	man_estagio_processo b,
				man_ordem_serv_estagio a
		where	a.nr_seq_ordem 		= nr_seq_ordem_serv_p
		and		b.nr_sequencia 		= a.nr_seq_estagio
		and		b.nr_sequencia not in (2577, 2574)) alias2
	order by nr_sequencia desc;
	
	select	max(a.ie_suporte),
		max(a.ie_desenv)
	into STRICT	ie_suporte_w,
		ie_desenv_w
	from	man_estagio_processo a,
		man_ordem_serv_estagio b
	where	b.nr_sequencia = nr_seq_estagio_os_w
	and	b.nr_seq_estagio = a.nr_sequencia;

	if (ie_suporte_w = 'S') then
		nr_seq_estagio_w := 231;
	elsif (ie_desenv_w = 'S') then
		nr_seq_estagio_w := 1051;
	end if;
		
	select	max(ie_area_gerencia)
	into STRICT	ie_area_gerencia_w
	from	gerencia_wheb a,
			grupo_desenvolvimento b,
			man_ordem_servico c
	where	a.nr_sequencia = b.nr_seq_gerencia
	and		b.nr_sequencia = c.nr_seq_grupo_des
	and		c.nr_sequencia = nr_seq_ordem_serv_p;
		
        if ie_area_gerencia_w = 'TEC' then
		nr_seq_estagio_w := 1731;
        end if;

	if (nr_seq_estagio_w IS NOT NULL AND nr_seq_estagio_w::text <> '' AND nr_seq_ordem_serv_p IS NOT NULL AND nr_seq_ordem_serv_p::text <> '') then
		update 	man_ordem_servico
		set	nr_seq_estagio = nr_seq_estagio_w
		where nr_sequencia = nr_seq_ordem_serv_p;	
		commit;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_reg_complaint_decision ( nr_seq_ordem_serv_p bigint, nr_seq_reg_tipo_risco_p bigint, ie_severity_harm_p bigint, ie_probability_harm_p bigint, ds_history_p text, nr_seq_tipo_hist_p bigint, nm_usuario_p text) FROM PUBLIC;

