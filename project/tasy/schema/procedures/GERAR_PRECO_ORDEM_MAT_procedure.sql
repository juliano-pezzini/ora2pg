-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_preco_ordem_mat (nr_ordem_compra_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_estabelecimento_w	integer;
nr_item_oci_w		integer;
nr_ordem_compra_w	bigint;
cd_pessoa_fisica_w	bigint;
cd_material_w		integer;
qt_conv_comp_estq_w	double precision;
vl_ultima_compra_w	double precision;
cd_um_compra_oci_w	varchar(30);
cd_um_compra_w		varchar(30);
cd_cnpj_w		varchar(14);

c01 CURSOR FOR
SELECT	a.nr_ordem_compra,
	a.nr_item_oci,
	b.cd_cgc_fornecedor,
	b.cd_pessoa_fisica
from	ordem_compra_item a,
	ordem_compra b
where (a.nr_ordem_compra = b.nr_ordem_compra)
and (coalesce(a.ie_situacao,'A') = 'A')
and (b.nr_ordem_compra = nr_ordem_compra_p);


BEGIN

cd_estabelecimento_w	:= cd_estabelecimento_p;

open	c01;
loop
fetch	c01 into
	nr_ordem_compra_w,
	nr_item_oci_w,
	cd_cnpj_w,
	cd_pessoa_fisica_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	select	cd_material,
		cd_unidade_medida_compra,
		obter_dados_material(cd_material,'UMP') cd_unid_compra,
		obter_dados_material(cd_material,'QCE') qt_conv_compra_estoque
	into STRICT	cd_material_w,
		cd_um_compra_oci_w,
		cd_um_compra_w,
		qt_conv_comp_estq_w
	from	ordem_compra_item
	where	nr_ordem_compra = nr_ordem_compra_w
	and	nr_item_oci = nr_item_oci_w;

	if (cd_cnpj_w IS NOT NULL AND cd_cnpj_w::text <> '') then
		select	coalesce(obter_vl_ultima_compra_forn(cd_estabelecimento_w, null, cd_material_w, null, cd_cnpj_w, 'U'),0)
		into STRICT	vl_ultima_compra_w
		;
	else
		select	coalesce(obter_vl_ultima_compra_pf(cd_estabelecimento_w, null, cd_material_w, null, cd_pessoa_fisica_w, 'U'),0)
		into STRICT	vl_ultima_compra_w
		;
	end if;

	if (cd_um_compra_oci_w = cd_um_compra_w) then
		vl_ultima_compra_w := round((vl_ultima_compra_w * qt_conv_comp_estq_w)::numeric,4);
	end if;

	update	ordem_compra_item
	set	vl_unitario_material = vl_ultima_compra_w,
		nm_usuario = nm_usuario_p,
		vl_total_item = round(( qt_material * vl_ultima_compra_w)::numeric,4)
	where	nr_item_oci = nr_item_oci_w
	and	nr_ordem_compra = nr_ordem_compra_w;
	end;
end loop;
close 	c01;

CALL gerar_oc_hist_sem_commit(
	nr_ordem_compra_p,
	'S',
	WHEB_MENSAGEM_PCK.get_texto(297639),
	substr(WHEB_MENSAGEM_PCK.get_texto(301902),1,4000),
	nm_usuario_p);

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_preco_ordem_mat (nr_ordem_compra_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

