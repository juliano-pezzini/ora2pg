-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_prescricao_enf_html5 (nr_prescricao_p prescr_medica.nr_prescricao%type, nr_atendimento_p prescr_medica.nr_atendimento%type, ie_tipo_pessoa_p text, cd_perfil_p perfil.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type, ie_prescricao_p text, ds_erro_p INOUT text, nr_prescricao_erro_p INOUT prescr_medica.nr_prescricao%type) AS $body$
DECLARE


ds_erro_w				varchar(4000);
ds_log_w				varchar(4000);
ds_observacao_copia_w	prescr_medica.ds_observacao_copia%type;
cd_pessoa_fisica_w		prescr_medica.cd_pessoa_fisica%type;
dt_liberacao_enf_w		prescr_medica.dt_liberacao%type;WITH RECURSIVE cte AS (


c01 CURSOR(ds_observacao_copia_pc		 prescr_medica.ds_observacao_copia%type) FOR
SELECT		regexp_substr(ds_observacao_copia_pc, '[A-Z]{1,2},[0-9]+;', 1, level) as ds_item_liberar_w

(regexp_substr(ds_observacao_copia_pc, '[A-Z]{1,2},[0-9]+;', 1, level) IS NOT NULL AND (regexp_substr(ds_observacao_copia_pc, '[A-Z]{1,2},[0-9]+;', 1, level))::text <> '')  UNION ALL


c01 CURSOR(ds_observacao_copia_pc		 prescr_medica.ds_observacao_copia%type) FOR
SELECT		regexp_substr(ds_observacao_copia_pc, '[A-Z]{1,2},[0-9]+;', 1, level) as ds_item_liberar_w

(regexp_substr(ds_observacao_copia_pc, '[A-Z]{1,2},[0-9]+;', 1, level) IS NOT NULL AND (regexp_substr(ds_observacao_copia_pc, '[A-Z]{1,2},[0-9]+;', 1, level))::text <> '') JOIN cte c ON ()

) SELECT * FROM cte;
;

c02 CURSOR(ds_item_liberar_pc		 prescr_medica.ds_observacao_copia%type) FOR
SELECT	a.nr_prescricao
from	prescr_medica a
where	a.nr_prescricao > nr_prescricao_p
and		a.nr_atendimento = nr_atendimento_p
and		a.cd_funcao_origem = 2314
and		coalesce(a.dt_liberacao::text, '') = ''
and		a.ds_observacao_copia like '%' || ds_item_liberar_pc || '%';

c03 CURSOR(ds_item_liberar_pc		 prescr_medica.ds_observacao_copia%type) FOR
SELECT	a.nr_prescricao
from	prescr_medica a
where	a.nr_prescricao > nr_prescricao_p
and		a.cd_pessoa_fisica = cd_pessoa_fisica_w
and		a.cd_funcao_origem = 2314
and		coalesce(a.dt_liberacao::text, '') = ''
and		a.ds_observacao_copia like '%' || ds_item_liberar_pc || '%';
BEGIN

	select	max(a.ds_observacao_copia),
			max(cd_pessoa_fisica),
			max(dt_liberacao)
	into STRICT	ds_observacao_copia_w,
			cd_pessoa_fisica_w,
			dt_liberacao_enf_w
	from	prescr_medica a
	where	a.nr_prescricao = nr_prescricao_p
	and		a.cd_funcao_origem = 2314;

	if (coalesce(dt_liberacao_enf_w::text, '') = '') then

		ds_erro_p => ds_erro_w := liberar_prescricao(nr_prescricao_p => nr_prescricao_p, nr_atendimento_p => nr_atendimento_p, ie_tipo_pessoa_p => ie_tipo_pessoa_p, cd_perfil_p => cd_perfil_p, nm_usuario_p => nm_usuario_p, ie_prescricao_p => ie_prescricao_p, ds_erro_p => ds_erro_w);

		if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
			ds_erro_p := ds_erro_w;
			nr_prescricao_erro_p := nr_prescricao_p;
		end if;
	end if;
	
	if (coalesce(ds_observacao_copia_w::text, '') = '' or
		(ds_erro_w IS NOT NULL AND ds_erro_w::text <> '')) then

		ds_log_w := substr(obter_desc_expressao(942996) || ' / liberar_prescricao_enf_html5 = ' || chr(13)
							|| ' 01 - linha'
							|| ' nr_prescricao_p: '			|| nr_prescricao_p
							|| ' nr_atendimento_p: '		|| nr_atendimento_p
							|| ' ds_observacao_copia_w: '	|| ds_observacao_copia_w
							|| ' ds_erro_w: '				|| ds_erro_w, 1, 4000);

		CALL gerar_log_prescricao(	nr_prescricao_p => nr_prescricao_p,
								nr_seq_item_p => null,
								ie_agrupador_p => null,
								nr_seq_horario_p => null,
								ie_tipo_item_p => null,
								ds_log_p => ds_log_w,
								nm_usuario_p => nm_usuario_p,
								nr_seq_objeto_p => 90457,
								ie_commit_p => 'N');
	end if;

	if ((ds_observacao_copia_w IS NOT NULL AND ds_observacao_copia_w::text <> '') and
		coalesce(ds_erro_w::text, '') = '') then
		for r_c01_w in c01(ds_observacao_copia_w)
		loop
			if (r_c01_w.ds_item_liberar_w IS NOT NULL AND r_c01_w.ds_item_liberar_w::text <> '') then

				ds_log_w := substr(obter_desc_expressao(942996) || ' / liberar_prescricao_enf_html5 = ' || chr(13)
									|| ' 02 - linha'
									|| ' nr_prescricao_p: '		|| nr_prescricao_p
									|| ' nr_atendimento_p: '	|| nr_atendimento_p
									|| ' ds_item_liberar_w: '	|| r_c01_w.ds_item_liberar_w
									|| ' cd_pessoa_fisica_w: '	|| cd_pessoa_fisica_w
									|| ' cd_perfil_p: '			|| cd_perfil_p, 1, 4000);

				CALL gerar_log_prescricao(	nr_prescricao_p => nr_prescricao_p,
										nr_seq_item_p => null,
										ie_agrupador_p => null,
										nr_seq_horario_p => null,
										ie_tipo_item_p => null,
										ds_log_p => ds_log_w,
										nm_usuario_p => nm_usuario_p,
										nr_seq_objeto_p => 90457,
										ie_commit_p => 'N');
				
				if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
					for r_c02_w in c02(r_c01_w.ds_item_liberar_w)
					loop
						ds_erro_p => ds_erro_w := liberar_prescricao(	nr_prescricao_p => r_c02_w.nr_prescricao, nr_atendimento_p => nr_atendimento_p, ie_tipo_pessoa_p => ie_tipo_pessoa_p, cd_perfil_p => cd_perfil_p, nm_usuario_p => nm_usuario_p, ie_prescricao_p => ie_prescricao_p, ds_erro_p => ds_erro_w);

						if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
							ds_erro_p := ds_erro_w;
							nr_prescricao_erro_p := r_c02_w.nr_prescricao;
						end if;
					end loop;
				else
					for r_c03_w in c03(r_c01_w.ds_item_liberar_w)
					loop
						ds_erro_p => ds_erro_w := liberar_prescricao(	nr_prescricao_p => r_c03_w.nr_prescricao, nr_atendimento_p => nr_atendimento_p, ie_tipo_pessoa_p => ie_tipo_pessoa_p, cd_perfil_p => cd_perfil_p, nm_usuario_p => nm_usuario_p, ie_prescricao_p => ie_prescricao_p, ds_erro_p => ds_erro_w);

						if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
							ds_erro_p := ds_erro_w;
							nr_prescricao_erro_p := r_c03_w.nr_prescricao;
						end if;
					end loop;
				end if;
			end if;
		end loop;
	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_prescricao_enf_html5 (nr_prescricao_p prescr_medica.nr_prescricao%type, nr_atendimento_p prescr_medica.nr_atendimento%type, ie_tipo_pessoa_p text, cd_perfil_p perfil.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type, ie_prescricao_p text, ds_erro_p INOUT text, nr_prescricao_erro_p INOUT prescr_medica.nr_prescricao%type) FROM PUBLIC;

