-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_analise_vertical ( nr_seq_demo_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
nr_seq_col_w			bigint;
nr_seq_coluna_w		smallint;
nr_seq_coluna_1_w		smallint;
nr_seq_rubrica_w		bigint;
ds_divisor_w			varchar(4000);
vl_referencia_w		double precision;
vl_dividendo_w		double precision;
vl_divisor_w			double precision;

C01 CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_coluna,
		nr_seq_col_1
	from	ctb_demo_mes
	where	nr_seq_demo	= nr_seq_demo_p
	and	ie_valor	= 'A';

C02 CURSOR FOR
	SELECT	b.nr_sequencia,
		(somente_numero(b.ds_divisor))::numeric
	from	ctb_modelo_rubrica b,
		ctb_demo_rubrica a
	where	a.nr_seq_rubrica	= b.nr_sequencia
	and	a.nr_seq_demo		= nr_seq_demo_p
	and	a.nr_seq_col		= nr_seq_col_w
	and	(b.ds_divisor IS NOT NULL AND b.ds_divisor::text <> '');


BEGIN

OPEN	C01;
LOOP
FETCH	C01
into	nr_seq_col_w,
	nr_seq_coluna_w,
	nr_seq_coluna_1_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	OPEN	C02;
	LOOP
	FETCH	C02
	into	nr_seq_rubrica_w,
		ds_divisor_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		vl_referencia_w		:= 0;

		select	nr_sequencia
		into STRICT	nr_sequencia_w
		from	ctb_demo_mes
		where	nr_seq_demo	= nr_seq_demo_p
		and	nr_seq_coluna	= nr_seq_coluna_1_w;

		select	vl_referencia
		into STRICT	vl_dividendo_w
		from	ctb_demo_rubrica
		where	nr_seq_demo	= nr_seq_demo_p
		and	nr_seq_rubrica	= ds_divisor_w
		and	nr_seq_col	= nr_sequencia_w;

		select	vl_referencia
		into STRICT	vl_divisor_w
		from	ctb_demo_rubrica
		where	nr_seq_demo	= nr_seq_demo_p
		and	nr_seq_rubrica	= nr_seq_rubrica_w
		and	nr_seq_col	= nr_sequencia_w;

		select	nr_sequencia
		into STRICT	nr_sequencia_w
		from	ctb_demo_mes
		where	nr_seq_demo	= nr_seq_demo_p
		and	nr_seq_coluna	= nr_seq_coluna_w;

		update	ctb_demo_rubrica
		set	vl_referencia	= dividir(vl_divisor_w, vl_dividendo_w) * 100
		where	nr_seq_demo	= nr_seq_demo_p
		and	nr_seq_rubrica	= nr_seq_rubrica_w
		and	nr_seq_col	= nr_sequencia_w;

		update	ctb_demo_rubrica
		set	vl_referencia	= 100
		where	nr_seq_demo	= nr_seq_demo_p
		and	nr_seq_rubrica	= ds_divisor_w
		and	nr_seq_col	= nr_sequencia_w;

	end loop;
	close c02;
end loop;
close c01;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_analise_vertical ( nr_seq_demo_p bigint, nm_usuario_p text) FROM PUBLIC;

