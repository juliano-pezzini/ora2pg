-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_log_carta_medica ( nr_seq_carta_p bigint, nm_usuario_p text, nr_seq_nova_carta_p INOUT bigint, cd_medico_responsavel_p text, ie_preliminar_p text default 'S') AS $body$
DECLARE


nr_sequencia_w			carta_medica.nr_sequencia%type;


BEGIN

if (ie_preliminar_p = 'N') then
	update	carta_medica
	set		ie_preliminar = 'N'
	where	nr_sequencia	= nr_seq_carta_p;
end if;

select	nextval('carta_medica_seq')
into STRICT	nr_sequencia_w
;

insert	into carta_medica(NR_SEQUENCIA,
							DT_ATUALIZACAO,
							NM_USUARIO,
							DT_ATUALIZACAO_NREC,
							CD_PESSOA_FISICA,
							CD_MEDICO,
							CD_MEDICO_RESPONSAVEL,
							DT_LIBERACAO_RESPONSAVEL,
							DT_LIBERACAO_PRELIMINAR,
							DT_LIBERACAO,
							NR_ATENDIMENTO,
							IE_LOG,
							NR_VERSAO,
							IE_REVISAO,
							NR_SEQ_CARTA_MAE,
							NM_USUARIO_PRE_LIB,
							NM_USUARIO_ORIGINAL,
							IE_VISUALIZACAO,
							ds_carta,
							ie_liberacao_preliminar,
							ie_liberacao_responsavel,
							ie_preliminar,
							nr_seq_modelo,
							cd_estabelecimento,
							nr_seq_episodio,
							nr_episodio,
							ie_status_aprovacao,
							nm_autor_carta)
			SELECT		nr_sequencia_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						cd_pessoa_fisica,
						cd_medico_responsavel_p,
						cd_medico_responsavel_p,
						CASE WHEN ie_preliminar='A' THEN dt_liberacao_responsavel  ELSE CASE WHEN ie_preliminar_p='S' THEN dt_liberacao_responsavel  ELSE null END  END ,
						CASE WHEN ie_preliminar='A' THEN dt_liberacao_preliminar  ELSE CASE WHEN ie_preliminar_p='S' THEN dt_liberacao_preliminar  ELSE null END  END ,
						CASE WHEN ie_preliminar='A' THEN dt_liberacao  ELSE CASE WHEN ie_preliminar_p='S' THEN dt_liberacao  ELSE null END  END ,
						nr_atendimento,
						'N',
						CASE WHEN coalesce(nr_seq_carta_mae::text, '') = '' THEN 2  ELSE nr_versao + 1 END ,
						'N',
						coalesce(nr_seq_carta_mae,nr_sequencia),
						CASE WHEN ie_preliminar='A' THEN nm_usuario_pre_lib  ELSE CASE WHEN ie_preliminar_p='S' THEN nm_usuario_pre_lib  ELSE null END  END ,
						nm_usuario_original,
						ie_visualizacao,
						ds_carta,
						CASE WHEN ie_preliminar='A' THEN ie_liberacao_preliminar  ELSE CASE WHEN ie_preliminar_p='S' THEN ie_liberacao_preliminar  ELSE null END  END ,
						CASE WHEN ie_preliminar='A' THEN ie_liberacao_responsavel  ELSE CASE WHEN ie_preliminar_p='S' THEN ie_liberacao_responsavel  ELSE null END  END ,
						CASE WHEN ie_preliminar='N' THEN ie_preliminar WHEN ie_preliminar='A' THEN ie_preliminar  ELSE ie_preliminar_p END ,
						nr_seq_modelo,
						cd_estabelecimento,
						nr_seq_episodio,
						nr_episodio,
						ie_status_aprovacao,
						nm_autor_carta
			from	carta_medica
			where	nr_sequencia	= nr_seq_carta_p;
						
update	carta_medica
set		ie_log	= 'S'
where	nr_sequencia	= nr_seq_carta_p;

commit;

nr_seq_nova_carta_p	:= nr_sequencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_log_carta_medica ( nr_seq_carta_p bigint, nm_usuario_p text, nr_seq_nova_carta_p INOUT bigint, cd_medico_responsavel_p text, ie_preliminar_p text default 'S') FROM PUBLIC;

