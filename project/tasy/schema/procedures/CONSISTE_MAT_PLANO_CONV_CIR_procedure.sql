-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_mat_plano_conv_cir ( nr_prescricao_p bigint, cd_material_p bigint, qt_material_p bigint, ie_regra_p INOUT bigint, ds_mensagem_p INOUT text) AS $body$
DECLARE


cd_convenio_w		bigint;
cd_plano_w		varchar(100);
cd_material_w		integer;
nr_atendimento_w	bigint;
cd_setor_atendimento_w	integer;
dt_atendimento_w	timestamp;
nr_seq_agenda_w		        cirurgia.nr_seq_agenda%type;
cd_estabelecimento_w	smallint;
cd_categoria_w		varchar(10);
ie_tipo_atendimento_w	smallint;
ds_retorno_w		varchar(255)	:= '';
ie_bloqueia_agenda_w	varchar(01)	:= 'N';
ie_regra_w		smallint 	:= 0;
nr_seq_regra_w		bigint;
ie_prescr_especial_w	varchar(01)	:= 'N';


BEGIN

if (nr_prescricao_p > 0) then
	
	select	coalesce(max('N'),'S')
	into STRICT	ie_prescr_especial_w
	from	cirurgia
	where	nr_prescricao = nr_prescricao_p;
		
	if (ie_prescr_especial_w = 'S') then
		select	max(a.cd_convenio),
			substr(obter_plano_atendimento(max(a.nr_atendimento),'C'),1,100) cd_plano,
			max(a.nr_atendimento),
			max(a.cd_setor_atendimento),
			to_date(obter_dados_atendimento(max(a.nr_atendimento),'DE'),'dd/mm/yyyy hh24:mi:ss') dt_atendimento,
			max(a.nr_seq_agenda),
			max(a.cd_estabelecimento),
			max(a.cd_categoria),
			obter_tipo_atendimento(max(a.nr_atendimento)) ie_tipo_atendimento
		into STRICT	cd_convenio_w,
			cd_plano_w,
			nr_atendimento_w,
			cd_setor_atendimento_w,
			dt_atendimento_w,
			nr_seq_agenda_w,
			cd_estabelecimento_w,
			cd_categoria_w,
			ie_tipo_atendimento_w
		from	cirurgia a,
			prescr_medica b
		where	a.nr_cirurgia 	= b.nr_cirurgia
		and	b.nr_prescricao = nr_prescricao_p
		and	coalesce(ie_tipo_prescr_cirur,0) <> 2;
	else	
		select		max(a.cd_convenio),
				substr(obter_plano_atendimento(max(a.nr_atendimento),'C'),1,100) cd_plano,
				max(a.nr_atendimento),
				max(a.cd_setor_atendimento),
				to_date(obter_dados_atendimento(max(a.nr_atendimento),'DE'),'dd/mm/yyyy hh24:mi:ss') dt_atendimento,
				max(a.nr_seq_agenda),
				max(a.cd_estabelecimento),
				max(a.cd_categoria),
				obter_tipo_atendimento(max(a.nr_atendimento)) ie_tipo_atendimento
		into STRICT		cd_convenio_w,
				cd_plano_w,
				nr_atendimento_w,
				cd_setor_atendimento_w,
				dt_atendimento_w,
				nr_seq_agenda_w,
				cd_estabelecimento_w,
				cd_categoria_w,
				ie_tipo_atendimento_w
		from		cirurgia a
		where		a.nr_prescricao = nr_prescricao_p;
	end if;	

	if (cd_convenio_w > 0) then
		SELECT * FROM consiste_mat_plano_convenio(cd_convenio_w, cd_plano_w, cd_material_p, nr_atendimento_w, cd_setor_atendimento_w, ds_retorno_w, ie_bloqueia_agenda_w, ie_regra_w, nr_seq_regra_w, qt_material_p, dt_atendimento_w, nr_seq_agenda_w, cd_estabelecimento_w, cd_categoria_w, ie_tipo_atendimento_w) INTO STRICT ds_retorno_w, ie_bloqueia_agenda_w, ie_regra_w, nr_seq_regra_w;
		ie_regra_p	:= ie_regra_w;
		ds_mensagem_p	:= substr(ds_retorno_w,1,255);
	end if;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_mat_plano_conv_cir ( nr_prescricao_p bigint, cd_material_p bigint, qt_material_p bigint, ie_regra_p INOUT bigint, ds_mensagem_p INOUT text) FROM PUBLIC;

