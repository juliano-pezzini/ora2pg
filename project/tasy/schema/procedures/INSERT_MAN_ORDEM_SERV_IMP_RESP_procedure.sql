-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_man_ordem_serv_imp_resp (nr_seq_ordem_serv_p man_ordem_servico.nr_sequencia%type, nr_seq_impacto_p man_ordem_serv_impacto.nr_sequencia%type, nm_usuario_p man_ordem_servico.nm_usuario%type) AS $body$
BEGIN
	if (nr_seq_ordem_serv_p IS NOT NULL AND nr_seq_ordem_serv_p::text <> '' AND nr_seq_impacto_p IS NOT NULL AND nr_seq_impacto_p::text <> '') then
	
		insert into man_ordem_serv_imp_resp(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,	
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_impacto,
			nr_seq_imp_quest,
			nr_seq_sme_equipe,
			ie_resposta,
			ds_racional
		)
		SELECT	nextval('man_ordem_serv_imp_resp_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_impacto_p,
				r.nr_seq_impacto_quest,
				(SELECT	max(q.NR_SEQ_SME_EQUIPE)
				from	MAN_ORDEM_SERV_IMP_QUEST q
				where	q.nr_sequencia = r.nr_seq_impacto_quest) nr_seq_sme_equipe,
				r.ie_resposta,
				r.ds_racional
		from	w_ordem_serv_imp_quest_res r
		where	r.nr_seq_ordem_serv 	= nr_seq_ordem_serv_p
		and 	r.nr_sequencia 		= (
				select 	max(r1.nr_sequencia)
				from 	w_ordem_serv_imp_quest_res r1
				where 	r1.nr_seq_ordem_serv 		= r.nr_seq_ordem_serv
				and 	r1.nr_seq_impacto_quest 	= r.nr_seq_impacto_quest
		);

		commit;
	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_man_ordem_serv_imp_resp (nr_seq_ordem_serv_p man_ordem_servico.nr_sequencia%type, nr_seq_impacto_p man_ordem_serv_impacto.nr_sequencia%type, nm_usuario_p man_ordem_servico.nm_usuario%type) FROM PUBLIC;

