-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE proj_gerar_agenda ( cd_consultor_p text, dt_mes_referencia_p timestamp, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


dt_referencia_w		timestamp;
qt_agenda_w		integer;
nr_seq_canal_w          bigint;

BEGIN

if (coalesce(cd_consultor_p,'0') <> '0') then

	select  min(nr_seq_canal)
	into STRICT    nr_seq_canal_w
	from (
		SELECT  b.nr_seq_canal nr_seq_canal
		from    com_canal a,
			com_canal_consultor b
		where   b.nr_seq_canal = a.nr_sequencia
		  and   b.ie_situacao = 'A'
		  and   a.ie_situacao = 'A'
		  and   b.cd_pessoa_fisica = cd_consultor_p
		order by b.dt_atualizacao desc) alias3 LIMIT 1;

	if (coalesce(nr_seq_canal_w::text, '') = '') then
		/*O consultor informado nao esta cadastrado em nenhum canal. Favor verificar.*/

		CALL wheb_mensagem_pck.exibir_mensagem_abort(1058964);
	end if;

	for i in 0..(round(fim_mes(dt_mes_referencia_p) - trunc(dt_mes_referencia_p,'month')) -1) loop
		begin
		
		select	trunc(dt_mes_referencia_p,'month') + i
		into STRICT	dt_referencia_w
		;
		
		select	count(*)
		into STRICT	qt_agenda_w
		from	proj_agenda
		where	cd_consultor	= cd_consultor_p
		and	trunc(dt_agenda,'dd')	= dt_referencia_w;
		
		if (qt_agenda_w = 0) then
			insert into proj_agenda(	nr_sequencia,
							cd_consultor,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							dt_agenda,
							ie_status,
							ie_dia_todo,
					       		nr_seq_canal)
							values (	nextval('proj_agenda_seq'),
							cd_consultor_p,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							dt_referencia_w,
							'Livre',
							'S',
							nr_seq_canal_w);
							
		end if;		
		end;
	end loop;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proj_gerar_agenda ( cd_consultor_p text, dt_mes_referencia_p timestamp, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

