-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE check_duplicate_event_count ( nr_seq_etapa_p bigint, ds_evento_p text, nr_sequencia_p bigint) AS $body$
DECLARE

  dup_count_w                      bigint;
  nr_seq_proc_int_w                 bigint;
  update_event_count_w              bigint;
  dup_event_count_w                 bigint;


BEGIN
    SELECT nr_seq_protocolo_integrado 
    INTO STRICT   nr_seq_proc_int_w
    FROM   protocolo_integrado_etapa 
    WHERE  nr_sequencia = nr_seq_etapa_p  LIMIT 1;

    SELECT count(c.nr_sequencia)
    INTO STRICT   update_event_count_w
    FROM   protocolo_integrado a,
           protocolo_integrado_etapa b,
           protocolo_integrado_evento c
    WHERE  a.nr_sequencia = b.nr_seq_protocolo_integrado
           AND b.nr_sequencia = c.nr_seq_etapa
           AND a.nr_sequencia = nr_seq_proc_int_w
           and c.nr_sequencia = nr_sequencia_p;

    SELECT count(c.nr_sequencia)
    INTO STRICT   dup_event_count_w
    FROM   protocolo_integrado a,
           protocolo_integrado_etapa b,
           protocolo_integrado_evento c
    WHERE  a.nr_sequencia = b.nr_seq_protocolo_integrado
           AND b.nr_sequencia = c.nr_seq_etapa
           AND a.nr_sequencia = nr_seq_proc_int_w
           and c.nr_sequencia != nr_sequencia_p
           and  c.ds_evento = ds_evento_p;

IF update_event_count_w = 0 then
    SELECT Count(c.nr_sequencia)
    INTO STRICT   dup_count_w 
    FROM   protocolo_integrado a, 
           protocolo_integrado_etapa b, 
           protocolo_integrado_evento c 
    WHERE  a.nr_sequencia = b.nr_seq_protocolo_integrado 
           AND b.nr_sequencia = c.nr_seq_etapa 
           AND a.nr_sequencia = nr_seq_proc_int_w 
           AND c.ds_evento = ds_evento_p;

    IF ( dup_count_w > 0 ) THEN 
      CALL wheb_mensagem_pck.Exibir_mensagem_abort(1147123);
    END IF;

elsif update_event_count_w > 0 and dup_event_count_w > 0 then
  CALL wheb_mensagem_pck.Exibir_mensagem_abort(1147123);
END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE check_duplicate_event_count ( nr_seq_etapa_p bigint, ds_evento_p text, nr_sequencia_p bigint) FROM PUBLIC;

