-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lote_entrada_reg_mat_eluido ( nr_prescricao_p bigint, cd_motivo_baixa_p bigint, nm_usuario_p text, nr_seq_status_p bigint) AS $body$
DECLARE

 
nr_seq_proc_prescr_w	bigint;	
nr_seq_lote_entrada_w	bigint;		
nr_seq_ficha_w			bigint;
cd_pessoa_fisica_w		varchar(10);
nr_seq_exame_w			bigint;
nr_seq_reconvocado_w	bigint;
cd_material_exame_w		varchar(10);
nr_atendimento_w		bigint;
nr_seq_rec_item_w bigint;
	
C01 CURSOR FOR 
	SELECT	nr_sequencia, 
			nr_seq_exame, 
			cd_material_exame 
	from	prescr_procedimento 
	where	nr_prescricao = nr_prescricao_p 
	and		(nr_seq_exame IS NOT NULL AND nr_seq_exame::text <> '');		
 

BEGIN 
 
select	coalesce(max(nr_seq_lote_entrada),0), max(nr_seq_ficha_lote), max(cd_pessoa_fisica) 
into STRICT	nr_seq_lote_entrada_w, nr_seq_ficha_w, cd_pessoa_fisica_w 
from	prescr_medica 
where	nr_prescricao	= nr_prescricao_p;
 
select 	max(nr_atendimento) 
into STRICT	nr_atendimento_w 
from	prescr_medica 
where	nr_prescricao = nr_prescricao_p;
 
if (nr_seq_ficha_w > 0) then 
 
	select 	coalesce(max(nr_sequencia),0) 
	into STRICT	nr_seq_reconvocado_w 
	from	lote_ent_reconvocado 
	where	nr_seq_ficha_lote = nr_seq_ficha_w;	
	 
	update	lote_ent_sec_ficha 
	set	NR_SEQ_MOTIVO_NAO_ELUIDO = cd_motivo_baixa_p 
	where	nr_sequencia = nr_seq_ficha_w;
	 
	 
	if (coalesce(nr_seq_reconvocado_w,0) = 0) then 
 
		select	nextval('lote_ent_reconvocado_seq') 
		into STRICT	nr_seq_reconvocado_w 
		;
 
		insert into lote_ent_reconvocado(nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			cd_pessoa_fisica, 
			nr_seq_lote_sec, 
			nr_seq_ficha_lote, 
			ie_area_busca) 
		values (nr_seq_reconvocado_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			cd_pessoa_fisica_w, 
			nr_seq_lote_entrada_w, 
			nr_seq_ficha_w, 
			'B');
 
	end if;
		 
	update	lote_ent_sec_ficha 
	set		ie_suspenso = 'S' 
	where	nr_sequencia = nr_seq_ficha_w;
		 
	open C01;
	loop 
	fetch C01 into	 
		nr_seq_proc_prescr_w, 
		nr_seq_exame_w, 
		cd_material_exame_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		CALL Suspender_item_Prescricao( 
					nr_prescricao_p, 
					nr_seq_proc_prescr_w, 
					null, 
					null, 
					'PRESCR_PROCEDIMENTO', 
					nm_usuario_p, 
					'S', 
					722);
		--verificar cd_motivo_baixa 
		 
  select coalesce(max(nr_sequencia),0) 
   into STRICT nr_seq_rec_item_w 
   from LOTE_ENT_RECONVOCADO_ITEM   
   where nr_seq_reconvocado = nr_seq_reconvocado_w and 
      nr_prescricao = nr_prescricao_p and 
      nr_seq_prescr = nr_seq_proc_prescr_w;
   
  if (nr_seq_rec_item_w = 0) then 
   insert	into LOTE_ENT_RECONVOCADO_ITEM( 
 			NR_SEQUENCIA, 
  		NR_SEQ_EXAME, 
   	DT_ATUALIZACAO, 
    NM_USUARIO, 
    CD_MATERIAL_EXAME, 
    NR_SEQ_RECONVOCADO, 
    DT_ATUALIZACAO_NREC, 
    NM_USUARIO_NREC, 
    IE_TIPO_BUSCA, 
    NR_SEQ_STATUS_RECONV, 
    nr_prescricao, 
    nr_seq_prescr 
   ) values ( 
 			nextval('lote_ent_reconvocado_item_seq'), 
  		nr_seq_exame_w, 
    clock_timestamp(), 
    nm_usuario_p, 
    cd_material_exame_w, 
    nr_seq_reconvocado_w, 
    clock_timestamp(), 
    nm_usuario_p, 
    'A', 
    nr_seq_status_p, 
    nr_prescricao_p, 
    nr_seq_proc_prescr_w);
  else 
   update LOTE_ENT_RECONVOCADO_ITEM set NR_SEQ_STATUS_RECONV = nr_seq_status_p, DT_ATUALIZACAO = clock_timestamp(), NM_USUARIO = nm_usuario_p 
    where nr_seq_reconvocado = nr_seq_reconvocado_w and 
       nr_prescricao = nr_prescricao_p and 
       nr_seq_prescr = nr_seq_proc_prescr_w;
  end if;
		 
		end;
	end loop;
	close C01;
	commit;
	 
	CALL cancelar_atendimento_paciente(nr_atendimento_w,nm_usuario_p,null,cd_pessoa_fisica_w,'');
	 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lote_entrada_reg_mat_eluido ( nr_prescricao_p bigint, cd_motivo_baixa_p bigint, nm_usuario_p text, nr_seq_status_p bigint) FROM PUBLIC;

