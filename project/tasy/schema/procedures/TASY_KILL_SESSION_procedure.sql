-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_kill_session (pn_sid bigint, pn_serial bigint, ps_geralog text default 'N', pn_cd_tipo_log bigint default 0) AS $body$
DECLARE

DS_LOG		varchar(300);
ds_SID		varchar(20);
ds_SERIAL	varchar(20);
ds_OSUSER	varchar(30);
ds_MACHINE	varchar(64);
ds_USER		varchar(64);
inst_id_w	smallint;
oracle_rac varchar(512);

BEGIN

  if ( ps_geralog = 'S' ) then
        select  SID,
                SERIAL#,
                OSUSER,
                MACHINE,
                REGEXP_SUBSTR(UPPER(CLIENT_INFO),'[^USER=][[:alpha:]]+(;)') USU
        into STRICT    ds_SID,
                ds_SERIAL,
                ds_OSUSER,
                ds_MACHINE,
                ds_USER
        from    v$session
        where sid       = pn_sid
        and serial#     = pn_serial;

        DS_LOG := 'TYPE=TARGET; SID='||ds_SID||'; SERIAL='||ds_SERIAL||'; OSUSER='||ds_OSUSER||'; MACHINE='||ds_MACHINE||'; USER='||ds_USER;

        select  SID,
                SERIAL#,
                OSUSER,
                MACHINE,
                REGEXP_SUBSTR(UPPER(CLIENT_INFO),'[^USER=][[:alpha:]]+(;)') USU
        into STRICT    ds_SID,
                ds_SERIAL,
                ds_OSUSER,
                ds_MACHINE,
                ds_USER
        from    v$session
        where   audsid = (SELECT userenv('sessionid') );

        DS_LOG := DS_LOG||'TYPE=KILLER; SID='||ds_SID||'; SERIAL='||ds_SERIAL||'; OSUSER='||ds_OSUSER||'; MACHINE='||ds_MACHINE||'; USER='||ds_USER;

        CALL gravar_log_tasy(35,DS_LOG,wheb_usuario_pck.get_nm_usuario);

  end if;

  oracle_rac := OBTER_VALOR_DINAMICO_4000_BV('select UPPER(value) from v$parameter where name=:server', 'server=cluster_database', oracle_rac);

  if (oracle_rac = 'TRUE') OR (oracle_rac = '1') then
	select	max(b.inst_id)
	into STRICT	inst_id_w
	from	v$session a,
			gv$session b
	where	a.sid = b.sid
	and	a.serial# = b.serial#
	and	a.audsid = b.audsid
	and	b.audsid = userenv('sessionid');

	EXECUTE 'alter system kill session '''||pn_sid||','||pn_serial||',@'||inst_id_w||''' immediate';
 else
	EXECUTE 'alter system kill session '''||pn_sid||','||pn_serial||''' immediate';
 end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_kill_session (pn_sid bigint, pn_serial bigint, ps_geralog text default 'N', pn_cd_tipo_log bigint default 0) FROM PUBLIC;

