-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_subject_activ ( dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text, cd_estab_p bigint) AS $body$
DECLARE

			
id_w				subject_activity_log.id%type;
qt_reg_w			integer;
qt_reg_cd_estab_w	integer;
ds_sep_bv_w			varchar(50) := obter_separador_bv;

C01 CURSOR FOR
	SELECT	b.id
	from	subject_activity_log b,
		subject a
	where	a.id = b.id_subject
	and (b.cd_establishment = coalesce(cd_estab_p, b.cd_establishment)
        or      coalesce(cd_estab_p::text, '') = '')
        and     obter_dias_entre_datas(b.dt_creation,b.dt_expiration) = 0	
	and	trunc(b.dt_creation) between dt_inicial_p and dt_final_p + 86399/86400;WITH RECURSIVE cte AS (


C02 CURSOR FOR
	SELECT	x.*,x.dt_creation_base + ((1-1) * 10 / 1440) dt_base_log
	from    (SELECT	a.ds_login,
			a.nm_subject,
			cast(b.dt_creation as timestamp) dt_creation,
			cast(b.dt_modification as timestamp) dt_modification,
			cast(b.dt_expiration as timestamp) dt_expiration,
			trunc(b.dt_creation,'hh24') + (trunc(to_char(b.dt_creation,'mi') / 10) * 10) / 1440 dt_creation_base,
			trunc(b.dt_expiration,'mi') dt_expiration_mi,
			b.cd_establishment
		from	subject_activity_log b,	
			subject a
		where	a.id = b.id_subject
		and	b.id = id_w) x
	dt_creation_base + ((level-1) * 10 / 1440) <= dt_expiration_mi  UNION ALL


C02 CURSOR FOR
	SELECT	x.*,x.dt_creation_base + (((c.level+1)-1) * 10 / 1440) dt_base_log
	from    (SELECT	a.ds_login,
			a.nm_subject,
			cast(b.dt_creation as timestamp) dt_creation,
			cast(b.dt_modification as timestamp) dt_modification,
			cast(b.dt_expiration as timestamp) dt_expiration,
			trunc(b.dt_creation,'hh24') + (trunc(to_char(b.dt_creation,'mi') / 10) * 10) / 1440 dt_creation_base,
			trunc(b.dt_expiration,'mi') dt_expiration_mi,
			b.cd_establishment
		from	subject_activity_log b,	
			subject a
		where	a.id = b.id_subject
		and	b.id = id_w) x
	dt_creation_base + ((level-1) * 10 / 1440) <= dt_expiration_mi JOIN cte c ON ()

) SELECT * FROM cte;
;

BEGIN

select	count(1)
into STRICT	qt_reg_w
from	user_tables
where	table_name = 'W_SUBJECT_ACTIV';

if (qt_reg_w = 0) then
	begin
	CALL exec_sql_dinamico('REL-W4488',
	'create table w_subject_activ (			' ||
	'	id		varchar2(36) not null,	' ||
	'	ds_login	varchar2(15) not null,	' ||
	'	nm_subject	varchar2(100) not null,	' ||
	'	dt_creation	date,			' ||
	'	dt_modification	date,			' ||
	'	dt_expiration	date,			' ||
	'	dt_base_log	date,			' ||
	'	dt_atualizacao	date,			' ||
	'	nm_usuario	varchar2(15) not null,	' ||
	'	cd_establishment number)');

	CALL exec_sql_dinamico('REL-W44888','Alter Table W_SUBJECT_ACTIV add ( Constraint WSUBACT_UK Unique (NM_USUARIO, DT_BASE_LOG, DS_LOGIN, CD_ESTABLISHMENT) ) ');
	CALL exec_sql_dinamico('REL-W44888','Create Index WSUBACT_UK on W_SUBJECT_ACTIV(NM_USUARIO, DT_BASE_LOG, DS_LOGIN, CD_ESTABLISHMENT) ');
	CALL exec_sql_dinamico('REL-W44888','Create Index WSUBACT_I1 on W_SUBJECT_ACTIV(NM_USUARIO, DT_BASE_LOG) ');
	end;
else
	begin
	select	count(*)
	into STRICT	qt_reg_w
	from	user_tab_columns
	where	table_name 	= 'W_SUBJECT_ACTIV'
	and	column_name	= 'CD_ESTABLISHMENT';
	
	if (qt_reg_w = 0) then
		begin
		CALL exec_sql_dinamico('REL-W44888', 'Alter Table W_SUBJECT_ACTIV add CD_ESTABLISHMENT NUMBER');
		end;
	end if;

	select	count(1)
	into STRICT	qt_reg_w
	from	user_constraints
	where	constraint_name = 'WSUBACT_UK';
	
	select count(1)
	into STRICT    qt_reg_cd_estab_w
	from user_cons_columns
	where table_name = 'W_SUBJECT_ACTIV'
	and constraint_name = 'WSUBACT_UK'
	and column_name = 'CD_ESTABLISHMENT';
	
	if (qt_reg_w = 0) then
		begin
		CALL exec_sql_dinamico('REL-W44888','Truncate Table W_SUBJECT_ACTIV ');
		CALL exec_sql_dinamico('REL-W44888','Alter Table W_SUBJECT_ACTIV add ( Constraint WSUBACT_UK Unique (NM_USUARIO, DT_BASE_LOG, DS_LOGIN, CD_ESTABLISHMENT) ) ');
		CALL exec_sql_dinamico('REL-W44888','Create Index WSUBACT_UK on W_SUBJECT_ACTIV(NM_USUARIO, DT_BASE_LOG, DS_LOGIN, CD_ESTABLISHMENT) ');
		CALL exec_sql_dinamico('REL-W44888','Create Index WSUBACT_I1 on W_SUBJECT_ACTIV(NM_USUARIO, DT_BASE_LOG) ');
		end;
	elsif (qt_reg_w > 0 and qt_reg_cd_estab_w = 0) then
		begin
		CALL exec_sql_dinamico('REL-W44888','Truncate Table W_SUBJECT_ACTIV ');
		CALL exec_sql_dinamico('REL-W44888','Alter Table W_SUBJECT_ACTIV drop constraint WSUBACT_UK ');
		CALL exec_sql_dinamico('REL-W44888','Alter Table W_SUBJECT_ACTIV add ( Constraint WSUBACT_UK Unique (NM_USUARIO, DT_BASE_LOG, DS_LOGIN, CD_ESTABLISHMENT) ) ');
		CALL exec_sql_dinamico('REL-W44888','Create Index WSUBACT_UK on W_SUBJECT_ACTIV(NM_USUARIO, DT_BASE_LOG, DS_LOGIN, CD_ESTABLISHMENT) ');
		CALL exec_sql_dinamico('REL-W44888','Alter Table W_SUBJECT_ACTIV enable constraint WSUBACT_UK ');
		end;
	else
		CALL exec_sql_dinamico_bv('REL-W44888','delete w_subject_activ where nm_usuario = :nm_usuario','nm_usuario=' || nm_usuario_p || ds_sep_bv_w);
	end if;
	end;
end if;
for c01_w in C01 loop
	begin
	id_w := c01_w.id;	
	for c02_w in C02 loop
		begin
		CALL exec_sql_dinamico_bv(
				'REL-W44888',
				'insert into w_subject_activ (id, ds_login, nm_subject, dt_creation, dt_modification, dt_expiration, dt_base_log, dt_atualizacao, nm_usuario, cd_establishment) ' ||
				'values (:id, :ds_login, :nm_subject, :dt_creation, :dt_modification, :dt_expiration, :dt_base_log, sysdate, :nm_usuario, :cd_establishment)',
				'id=' || c01_w.id || ds_sep_bv_w ||
				'ds_login=' || c02_w.ds_login || ds_sep_bv_w ||
				'nm_subject=' || c02_w.nm_subject || ds_sep_bv_w ||
				'dt_creation=' || to_char(c02_w.dt_creation,'dd/mm/yyyy hh24:mi:ss') || ds_sep_bv_w ||
				'dt_modification=' || to_char(c02_w.dt_modification,'dd/mm/yyyy hh24:mi:ss') || ds_sep_bv_w ||
				'dt_expiration=' || to_char(c02_w.dt_expiration,'dd/mm/yyyy hh24:mi:ss') || ds_sep_bv_w ||
				'dt_base_log=' || to_char(c02_w.dt_base_log,'dd/mm/yyyy hh24:mi:ss') || ds_sep_bv_w ||
				'nm_usuario=' || nm_usuario_p || ds_sep_bv_w ||
				'cd_establishment=' || c02_w.cd_establishment || ds_sep_bv_w);				
		exception
		when others then
			null;
		end;
	end loop;
	end;
end loop;
	
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_subject_activ ( dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text, cd_estab_p bigint) FROM PUBLIC;

