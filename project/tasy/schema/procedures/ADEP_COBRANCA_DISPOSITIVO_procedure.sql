-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE adep_cobranca_dispositivo ( nr_atendimento_p bigint, nr_seq_dispositivo_p bigint, nr_seq_disp_proc_p bigint, nm_usuario_p text, ie_opcao_p text, ie_acao_p text, nr_seq_registro_p bigint default null) AS $body$
DECLARE


cd_setor_Atendimento_w	bigint;
cd_setor_item_w			bigint;
nr_seq_proc_interno_w	bigint;
cd_procedimento_w	bigint;
ie_origem_proc_w	smallint;
cd_categoria_w		varchar(10);
cd_convenio_w		integer;
nr_atendimento_w	bigint;
qt_procedimento_w	bigint;
qt_min_frequencia_w	integer;
qt_minutos_w		bigint;
qt_minutos_aux_w	bigint := 0;
ie_opcao_w		varchar(10);
qt_frequencia_w		bigint;
cd_plano_w		varchar(10);
cd_tipo_acomodacao_w	smallint;

c01 CURSOR FOR
SELECT	cd_procedimento,
	nr_seq_proc_interno,
	qt_procedimento,
	coalesce(qt_min_frequencia,0)
from	regra_cobranca_dispositivo
where	ie_acao 		= ie_opcao_p
and	nr_seq_dispositivo 	= nr_seq_dispositivo_p;


BEGIN

if (coalesce(nr_atendimento_p::text, '') = '') then
	select	nr_atendimento
	into STRICT	nr_atendimento_w
	from	atend_pac_disp_proc b,
		atend_pac_dispositivo c
	where	b.nr_sequencia	= nr_seq_disp_proc_p
	and	c.nr_sequencia	= b.nr_seq_disp_pac;
else
	nr_atendimento_w	:= nr_atendimento_p;
end if;

begin
select	cd_convenio,
	cd_categoria,
	cd_plano_convenio,
	cd_tipo_acomodacao
into STRICT	cd_convenio_w,
	cd_categoria_w,
	cd_plano_w,
	cd_tipo_acomodacao_w
from 	atend_categoria_convenio
where	nr_seq_interno = obter_atecaco_atendimento(nr_atendimento_w)
and 	nr_atendimento = nr_atendimento_w;
exception
when no_data_found then
	-- O atendimento #@NR_ATENDIMENTO#@ não possui convênio definido na Entrada Única!
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(192069,'NR_ATENDIMENTO=' || nr_atendimento_w);
end;

open C01;
loop
fetch C01 into
	cd_procedimento_w,
	nr_seq_proc_interno_w,
	qt_procedimento_w,
	qt_min_frequencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (ie_opcao_p <> 'I') then

		if (coalesce(nr_seq_registro_p, 0) > 0) then
			select	coalesce(obter_min_entre_datas(MAX(dt_instalacao), MAX(dt_retirada), 1),0)
			into STRICT	qt_minutos_w
			from	atend_pac_dispositivo
			where	nr_seq_dispositivo 	= nr_seq_dispositivo_p
			and	(dt_instalacao IS NOT NULL AND dt_instalacao::text <> '')
			and	(dt_retirada IS NOT NULL AND dt_retirada::text <> '')
			and	ie_acao 		= ie_acao_p
			and	nr_atendimento		= nr_atendimento_w
			and nr_sequencia = nr_seq_registro_p;
		else
			select	coalesce(obter_min_entre_datas(MAX(dt_instalacao), MAX(dt_retirada), 1),0)
			into STRICT	qt_minutos_w
			from	atend_pac_dispositivo
			where	nr_seq_dispositivo 	= nr_seq_dispositivo_p
			and	(dt_instalacao IS NOT NULL AND dt_instalacao::text <> '')
			and	(dt_retirada IS NOT NULL AND dt_retirada::text <> '')
			and	ie_acao 		= ie_acao_p
			and	nr_atendimento		= nr_atendimento_w;
		end if;

		if (qt_minutos_w > 0) and (qt_min_frequencia_w > 0) then
			select	ceil(dividir(qt_minutos_w,qt_min_frequencia_w))
			into STRICT	qt_frequencia_w
			;

			qt_procedimento_w :=  coalesce(qt_frequencia_w,0) * qt_procedimento_w;

		end if;
	end if;

	SELECT * FROM obter_proc_tab_interno_conv(nr_seq_proc_interno_w, wheb_usuario_pck.get_cd_estabelecimento, cd_convenio_w, cd_categoria_w, cd_plano_w, cd_setor_atendimento_w, cd_procedimento_w, ie_origem_proc_w, cd_setor_item_w, clock_timestamp(), cd_tipo_acomodacao_w, null, null, null, null, null, null, null) INTO STRICT cd_procedimento_w, ie_origem_proc_w;
	CALL adep_gerar_lancto_dispositivo(nr_seq_proc_interno_w, nr_seq_disp_proc_p, nr_atendimento_w, cd_procedimento_w, ie_origem_proc_w, qt_procedimento_w, nm_usuario_p);

	end;
end loop;
close C01;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE adep_cobranca_dispositivo ( nr_atendimento_p bigint, nr_seq_dispositivo_p bigint, nr_seq_disp_proc_p bigint, nm_usuario_p text, ie_opcao_p text, ie_acao_p text, nr_seq_registro_p bigint default null) FROM PUBLIC;

