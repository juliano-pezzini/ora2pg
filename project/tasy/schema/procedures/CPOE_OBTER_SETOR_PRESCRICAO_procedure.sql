-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_obter_setor_prescricao ( ie_prescr_setor_p text, ie_setores_usuario_p text, cd_setor_atendimento_p bigint, nr_atendimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_setor_atend_p INOUT bigint) AS $body$
DECLARE


cd_setor_atendimento_w			setor_atendimento.cd_setor_atendimento%type;
ie_existe_setor_w				char(1);
nr_atendimento_mae_w			atendimento_paciente.nr_atendimento%type;
ie_usa_setor_mae_w				char(1) := 'N';
qt_setor_exibe_rn_w				integer;
cd_setor_atendimento_mae_w		setor_atendimento.cd_setor_atendimento%type;
cd_setor_atendimento_filho_w	setor_atendimento.cd_setor_atendimento%type;

BEGIN

if (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	select 	coalesce(max(nr_atendimento_mae),0)
	into STRICT	nr_atendimento_mae_w
	from 	atendimento_paciente
	where	nr_atendimento = nr_atendimento_p;

	if (nr_atendimento_mae_w > 0) then
		select	count(cd_setor_atendimento)
		into STRICT	qt_setor_exibe_rn_w
		from	setor_atendimento
		where	ie_rn_mae = 'S'
		and		cd_estabelecimento = obter_estabelecimento_ativo;
	end if;

	if (qt_setor_exibe_rn_w > 0) then
		cd_setor_atendimento_w := coalesce(obter_unidade_atendimento(nr_atendimento_mae_w,'IA','CS'),obter_unidade_atendimento(nr_atendimento_mae_w,'A','CS'));
		select	coalesce(max(ie_rn_mae),'N')
		into STRICT	ie_usa_setor_mae_w
		from	setor_atendimento
		where	cd_setor_atendimento = cd_setor_atendimento_w;
	end if;

	if (ie_usa_setor_mae_w = 'N') then

		--Angular não vamos tratar este valor para o parâmetro
		/*if	(ie_prescr_setor_p = 'C') then
			select	max(cd_setor_atendimento)
			into	cd_setor_atendimento_w
			from	computador
			where	nm_computador_pesquisa  = padronizar_nome(upper(nm_maquina_atual_p));
		els*/
		if (ie_prescr_setor_p = 'R') then
			cd_setor_atendimento_w := (obter_setor_prescr_regra(cd_perfil_p))::numeric;
		elsif (ie_prescr_setor_p = 'U') and (ie_setores_usuario_p = 'S') then
			cd_setor_atendimento_w	:= cd_setor_atendimento_p;
		elsif (ie_prescr_setor_p = 'U') and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_atendimento_P > 0) then
			begin
			select	coalesce(max('S'),'N')
			into STRICT	ie_existe_setor_w
			from	setor_atendimento a,
					atend_paciente_unidade b where		a.cd_setor_atendimento	= b.cd_setor_atendimento
			and		b.nr_atendimento	= nr_atendimento_p
			and		b.cd_setor_atendimento	= cd_setor_atendimento_p LIMIT 1;

			if (ie_existe_setor_w = 'S') then
				cd_setor_atendimento_w	:= cd_setor_atendimento_p;
			end if;
			end;
		elsif (ie_prescr_setor_p = 'A') and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_atendimento_P > 0) then

			cd_setor_atendimento_w	:= coalesce(obter_unidade_atendimento(nr_atendimento_p,'A','CS'), obter_unidade_atendimento(nr_atendimento_p,'IA','CS'));

		elsif (nr_atendimento_p > 0) and (ie_prescr_setor_p <> 'B') then
				cd_setor_atendimento_w	:= coalesce(obter_unidade_atendimento(nr_atendimento_p,'IA','CS'), obter_unidade_atendimento(nr_atendimento_p,'A','CS'));
		end if;
	elsif (ie_prescr_setor_p = 'A') or (ie_prescr_setor_p = 'P') then
			begin
			if (nr_atendimento_mae_w > 0) then
				select	coalesce(max(a.cd_setor_atendimento),0)
				into STRICT	cd_setor_atendimento_w
				from	setor_atendimento a
				where	a.cd_setor_atendimento = obter_unidade_atendimento(nr_atendimento_mae_w,'A','CS')
				and 	a.ie_rn_mae = 'S';

				if (coalesce(cd_setor_atendimento_w::text, '') = '') or (cd_setor_atendimento_w = 0) then
					cd_setor_atendimento_w	:= coalesce(obter_unidade_atendimento(nr_atendimento_p,'IA','CS'), obter_unidade_atendimento(nr_atendimento_p,'A','CS'));
				end if;
			elsif (ie_prescr_setor_p = 'A') then
				cd_setor_atendimento_w := obter_unidade_atendimento(nr_atendimento_p,'A','CS');
			end if;
			end;
	elsif (ie_prescr_setor_p = 'D') then
			begin
				if (nr_atendimento_mae_w > 0) then

					select	coalesce(max(cd_setor_atendimento),0)
					into STRICT 	cd_setor_atendimento_mae_w
					from 	setor_atendimento
					where 	cd_setor_atendimento = obter_unidade_atendimento(nr_atendimento_mae_w,'A','CS')
					and 	ie_rn_mae = 'S';

					select	coalesce(max(a.cd_setor_atendimento),0)
					into STRICT 	cd_setor_atendimento_filho_w
					from 	unidade_atendimento a
					where 	a.nr_seq_interno = (SELECT coalesce(max(b.nr_seq_unidade_rn),0)
												from setor_atendimento b
												where b.cd_setor_atendimento = obter_unidade_atendimento(nr_atendimento_p, 'A', 'CS'));

					if (cd_setor_atendimento_mae_w > 0 AND cd_setor_atendimento_mae_w = cd_setor_atendimento_filho_w) then
						cd_setor_atendimento_w := cd_setor_atendimento_mae_w;
					end if;
				end if;

				if (((coalesce(cd_setor_atendimento_mae_w::text, '') = '') or (cd_setor_atendimento_mae_w = 0)) and (nr_atendimento_p > 0)) then
					cd_setor_atendimento_w := obter_unidade_atendimento(nr_atendimento_p,'A','CS');
				end if;
			end;
	elsif (nr_atendimento_p > 0) and (ie_prescr_setor_p <> 'B') then
			cd_setor_atendimento_w	:= coalesce(obter_unidade_atendimento(nr_atendimento_p,'IA','CS'), obter_unidade_atendimento(nr_atendimento_p,'A','CS'));

	end if;
end if;

commit;

cd_setor_atend_p	:= cd_setor_atendimento_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_obter_setor_prescricao ( ie_prescr_setor_p text, ie_setores_usuario_p text, cd_setor_atendimento_p bigint, nr_atendimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_setor_atend_p INOUT bigint) FROM PUBLIC;

