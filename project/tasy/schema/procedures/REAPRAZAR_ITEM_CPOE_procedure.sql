-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reaprazar_item_cpoe ( nr_sequencia_p bigint, ie_tipo_item_p text, ie_aprazar_interv_p text, dt_horario_p timestamp, dt_reaprazar_p timestamp, nr_seq_motivo_p bigint, ds_justificativa_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ds_inconsistencia_p INOUT text) AS $body$
DECLARE


nr_atendimento_w		bigint;
nr_seq_proc_interno_w		bigint;
cd_item_w			bigint;
cd_intervalo_w			varchar(7);
dt_inicio_w			cpoe_procedimento.dt_inicio%type;
dt_fim_w			cpoe_procedimento.dt_fim%type;
ie_duracao_w		cpoe_procedimento.ie_duracao%type;
qt_item_w			double precision;
nr_prescricao_w			bigint;
nr_seq_item_w			integer;
ie_inconsistencia_w		varchar(1);
ds_inconsistentes_w		varchar(255);
nr_agrupamento_w		integer;
ie_acm_sn_w			varchar(3);
ie_exame_lab_w		varchar(1);

seq_cpoe_w		integer;


BEGIN

nr_prescricao_w	:= obter_prescr_item_cpoe(nr_sequencia_p,ie_tipo_item_p);

if (ie_tipo_item_p	= 'P') then
	select	max(nr_atendimento),
		max(nr_seq_proc_interno),
		max(qt_procedimento),
		CASE WHEN max(ie_administracao)='P' THEN 'N'  ELSE 'S' END ,
		max(cd_intervalo),
		max(dt_inicio),
		max(dt_fim),
		max(ie_duracao)
	into STRICT	nr_atendimento_w,
		nr_seq_proc_interno_w,
		qt_item_w,
		ie_acm_sn_w,
		cd_intervalo_w,
		dt_inicio_w,
		dt_fim_w,
		ie_duracao_w
	from	cpoe_procedimento
	where	nr_sequencia	= nr_sequencia_p;

	select	max(cd_procedimento),
			CASE WHEN coalesce(max(nr_seq_exame_lab)::text, '') = '' THEN 'N'  ELSE 'S' END
	into STRICT	cd_item_w,
			ie_exame_lab_w
	from	proc_interno
	where	nr_sequencia	= nr_seq_proc_interno_w;

	select	max(nr_sequencia)
	into STRICT	nr_seq_item_w
	from	prescr_procedimento
	where	nr_prescricao	= nr_prescricao_w
	and	nr_seq_proc_interno	= nr_seq_proc_interno_w
	and	nr_seq_proc_cpoe = nr_sequencia_p;

	select	max(nr_agrupamento)
	into STRICT	nr_agrupamento_w
	from	prescr_procedimento
	where	nr_prescricao	= nr_prescricao_w
	and	nr_sequencia	= nr_seq_item_w;

elsif (ie_tipo_item_p	= 'M') then

	select	max(nr_atendimento),
		max(cd_material),
		max(cd_intervalo),
		max(qt_Dose),
		CASE WHEN max(ie_administracao)='P' THEN 'N'  ELSE 'S' END ,
		max(dt_inicio),
		max(dt_fim),
		max(ie_duracao)
	into STRICT	nr_atendimento_w,
		cd_item_w,
		cd_intervalo_w,
		qt_item_w,
		ie_acm_sn_w,
		dt_inicio_w,
		dt_fim_w,
		ie_duracao_w
	from	cpoe_material
	where	nr_Sequencia	= nr_sequencia_p;

	select	max(nr_Sequencia)
	into STRICT	nr_Seq_item_w
	from	prescr_material
	where	nr_prescricao	= nr_prescricao_w
	and	nr_Seq_mat_cpoe = nr_sequencia_p
	and	cd_material	= cd_item_w;

end if;

if (coalesce(nr_atendimento_w::text, '') = '') then
	nr_atendimento_w := 0;
end if;

if ((dt_reaprazar_p < dt_inicio_w) or ((dt_fim_w IS NOT NULL AND dt_fim_w::text <> '') and dt_reaprazar_p > dt_fim_w)) then
	/*Não existem prescrições vigentes no momento onde o horário informado possa ser incluído.
	Provavelmente, o mesmo é anterior ao início destas prescrições ou superior a validade das mesmas!*/
	ds_inconsistencia_p := wheb_mensagem_pck.get_texto(29743, null);
end if;

if (coalesce(ds_inconsistencia_p::text, '') = '') then
	begin
		SELECT * FROM reaprazar_horario_item_prescr(	cd_estabelecimento_p, nr_atendimento_w, ie_tipo_item_p, cd_item_w, cd_intervalo_w, qt_item_w, dt_reaprazar_p, dt_horario_p, /*ie_reaprazar_seguintes_p*/
'N', nr_prescricao_w, nr_prescricao_w, nr_seq_item_w, ie_exame_lab_w, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, ds_inconsistentes_w, nr_seq_proc_interno_w, ie_inconsistencia_w, nr_agrupamento_w, ie_acm_sn_w, /*nr_seq_assinatura_p*/
null, /*ie_reaprazar_exame_mat_p*/
null, /*nr_ciclo_p*/
null, /*ie_reaprazar_item_ciclo_p*/
'N', /*cd_unidade_medida_p*/
null, /*ds_componentes_p*/
null, /*ie_via_aplicacao_p*/
null, /*nr_seq_prot_glic_p*/
null, /*ds_item_p*/
'', /*cd_funcao_p*/
null) INTO STRICT ds_inconsistentes_w, ie_inconsistencia_w;

		if (ie_inconsistencia_w IS NOT NULL AND ie_inconsistencia_w::text <> '') then
			ds_inconsistencia_p := ie_inconsistencia_w;
		end if;

	exception when others then
		ds_inconsistencia_p  := to_char(sqlerrm);
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reaprazar_item_cpoe ( nr_sequencia_p bigint, ie_tipo_item_p text, ie_aprazar_interv_p text, dt_horario_p timestamp, dt_reaprazar_p timestamp, nr_seq_motivo_p bigint, ds_justificativa_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ds_inconsistencia_p INOUT text) FROM PUBLIC;

