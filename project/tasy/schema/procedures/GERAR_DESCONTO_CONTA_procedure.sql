-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_desconto_conta ( nr_interno_conta_p bigint, ie_acao_p text, nr_seq_material_p bigint, nr_seq_proc_p bigint, tx_desconto_p bigint, dt_periodo_inicial_p timestamp, dt_periodo_final_p timestamp, cd_medico_executor_p bigint, cd_setor_atendimento_p bigint, nr_doc_convenio_p text, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, cd_material_p bigint, cd_area_procedimento_p bigint, cd_especialidade_p bigint, cd_grupo_proc_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_convenio_p bigint, cd_Categoria_p text, vl_final_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
vl_Proc_w				double precision := 0;
vl_Mat_w				double precision := 0;
vl_desc_Proc_w			double precision := 0;
vl_desc_Mat_w			double precision := 0;
vl_final_Proc_w			double precision := 0;
vl_Final_Mat_w			double precision := 0;
vl_Conta_w				double precision := 0;
tx_desc_mat_w			double precision := 0;
tx_desc_Proc_w			double precision := 0;


BEGIN 
 
select 	coalesce(sum(a.vl_material),0), 
		coalesce(sum(coalesce(b.vl_material,0)),0) 
into STRICT		vl_mat_w, 
		vl_desc_mat_w 
FROM material_atend_paciente a
LEFT OUTER JOIN mat_atend_paciente_valor b ON (a.nr_sequencia = b.nr_seq_material)
WHERE nr_interno_conta 	= nr_interno_conta_p;
 
 
select 	coalesce(sum(a.vl_procedimento),0), 
		coalesce(sum(coalesce(b.vl_procedimento,0)),0) 
into STRICT		vl_proc_w, 
		vl_desc_proc_w 
FROM procedimento_paciente a
LEFT OUTER JOIN proc_paciente_valor b ON (a.nr_sequencia = b.nr_seq_Procedimento)
WHERE nr_interno_conta 	= nr_interno_conta_p   and a.nr_sequencia	<> coalesce(a.nr_seq_proc_pacote,0);
 
vl_conta_w	:= vl_mat_w + vl_proc_w;
 
if (ie_acao_p = 'I') and 
	((vl_desc_mat_w + vl_desc_proc_w) > 0) then 
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(263284);
else 
	begin 
	if (ie_acao_p = 'I') and (coalesce(vl_final_p,0) > 0) then 
		begin 
		vl_final_mat_w		:= vl_final_p * (vl_mat_w / vl_conta_w);
		vl_final_proc_w		:= vl_final_p - vl_final_mat_w;
		if vl_Mat_w > 0 then 
  		  tx_desc_mat_w		:= (vl_mat_w - vl_final_mat_w) * 100 / vl_Mat_w;
		end if;
		if vl_proc_w > 0 then 
		  tx_desc_proc_w		:= (vl_proc_w - vl_final_proc_w) * 100 / vl_proc_w;
		end if;
		end;
	else 
		begin 
		tx_desc_mat_w		:= tx_desconto_p;
		tx_desc_proc_w		:= tx_desconto_p;
		vl_final_mat_w		:= 0;
		vl_final_proc_w		:= 0;
		end;
	end if;
	CALL Gerar_Desconto_Conta_Mat( 
					nr_interno_conta_p, 
					ie_acao_p, 
					nr_seq_material_p, 
					tx_desc_mat_w, 
					dt_periodo_inicial_p, 
					dt_periodo_final_p, 
					cd_setor_atendimento_p, 
					nr_doc_convenio_p, 
					cd_grupo_material_p, 
					cd_subgrupo_material_p, 
					cd_classe_material_p, 
					cd_material_p, 
					cd_convenio_p, 
					cd_Categoria_p, 
					vl_final_mat_w, 
					nm_usuario_p);
 
	CALL Gerar_Desconto_Conta_Proc( 
					nr_interno_conta_p, 
					ie_acao_p, 
					nr_seq_proc_p, 
					tx_desc_proc_w, 
					dt_periodo_inicial_p, 
					dt_periodo_final_p, 
					cd_medico_executor_p, 
					cd_setor_atendimento_p, 
					nr_doc_convenio_p, 
					cd_area_procedimento_p, 
					cd_especialidade_p, 
					cd_grupo_proc_p, 
					cd_procedimento_p, 
					ie_origem_proced_p, 
					cd_convenio_p, 
					cd_Categoria_p, 
					vl_final_Proc_w, 
					nm_usuario_p);
	commit;
	end;
end if;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_desconto_conta ( nr_interno_conta_p bigint, ie_acao_p text, nr_seq_material_p bigint, nr_seq_proc_p bigint, tx_desconto_p bigint, dt_periodo_inicial_p timestamp, dt_periodo_final_p timestamp, cd_medico_executor_p bigint, cd_setor_atendimento_p bigint, nr_doc_convenio_p text, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, cd_material_p bigint, cd_area_procedimento_p bigint, cd_especialidade_p bigint, cd_grupo_proc_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_convenio_p bigint, cd_Categoria_p text, vl_final_p bigint, nm_usuario_p text) FROM PUBLIC;

