-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_definir_motivo_nao_cobra ( nr_seq_orcamento_p bigint, nr_seq_motivo_p bigint, ds_observacao_p text, nm_usuario_p text) AS $body$
DECLARE

 
ds_titulo_w			varchar(255) := Wheb_mensagem_pck.get_texto(488904);
ds_comunic_w			varchar(4000);
ds_email_w			varchar(255);
ds_gerencia_w			varchar(255);
nm_gerente_w			varchar(40);
ds_motivo_w			varchar(255);
nr_seq_ordem_w			bigint;


BEGIN 
if (nr_seq_orcamento_p > 0) and (nr_seq_motivo_p > 0) then 
	begin 
	select	a.nr_seq_ordem, 
		substr(obter_gerencia_grupo_desen(b.nr_seq_grupo_des,'D'),1,255) ds_gerencia, 
		substr(obter_pf_usuario(nm_usuario_p,'N'),1,40), 
		substr(obter_descricao_padrao_pk('MAN_MOTIVO_NCOBR_ORC','DS_MOTIVO','NR_SEQUENCIA', nr_seq_motivo_p),1,255) 
	into STRICT	nr_seq_ordem_w, 
		ds_gerencia_w, 
		nm_gerente_w, 
		ds_motivo_w 
	from	man_ordem_servico_orc a, 
		man_ordem_servico b 
	where	a.nr_sequencia	= nr_seq_orcamento_p 
	and	b.nr_sequencia	= a.nr_seq_ordem;
	 
	update	man_ordem_servico_orc 
	set	nr_seq_motivo_nao_cobra = nr_seq_motivo_p, 
		nm_usuario_nao_cobra	= nm_usuario_p, 
		ds_observacao		= substr(ds_observacao || chr(13) || chr(10) || ds_observacao_p,1,4000) 
	where	nr_sequencia		= nr_seq_orcamento_p;	
	 
	select 	max(a.ds_email) 
	into STRICT 	ds_email_w 
	from 	pessoa_fisica b, 
		usuario a 
	where 	a.cd_pessoa_fisica = b.cd_pessoa_fisica 
	and 	b.cd_cargo = 791;
 
	if (coalesce(ds_email_w,'x') <> 'x') then 
		begin 
		ds_comunic_w := Wheb_mensagem_pck.get_texto( 488902, 'NR_SEQ_ORDEM=' || nr_seq_ordem_w || 
								';DS_GERENCIA=' || ds_gerencia_w || 
								';NM_GERENTE=' || nm_gerente_w || 
								';DS_MOTIVO=' || ds_motivo_w);
	 
		CALL Enviar_Email(ds_titulo_w, ds_comunic_w, null, ds_email_w, nm_usuario_p, 'M');
		end;
	end if;
	 
	commit;
	end;	
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_definir_motivo_nao_cobra ( nr_seq_orcamento_p bigint, nr_seq_motivo_p bigint, ds_observacao_p text, nm_usuario_p text) FROM PUBLIC;

