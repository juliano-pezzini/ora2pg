-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_obter_doc_exec_cnes ( cd_estabelecimento_p bigint, cd_cbo_p text, cd_medico_executor_p text, dt_procedimento_p timestamp, ie_doc_executor_p INOUT bigint) AS $body$
DECLARE


cd_cnes_hospital_w 	integer;
ie_doc_executor_w 	smallint := null;
nr_seq_tipo_vinculo_w	cnes_profissional_vinculo.nr_seq_tipo_vinculo%type;


BEGIN

select 	max(cd_cnes_hospital)
into STRICT 	cd_cnes_hospital_w
from 	sus_parametros_aih
where 	cd_estabelecimento = cd_estabelecimento_p;

if (cd_cnes_hospital_w IS NOT NULL AND cd_cnes_hospital_w::text <> '') then
	select  max(z.ie_doc_executor)
	into STRICT 	ie_doc_executor_w
	from    cnes_profissional y,
		cnes_identificacao x,
		cnes_profissional_vinculo z
	where   y.nr_seq_identificacao  = x.nr_sequencia
	and     x.CD_CNES               = cd_cnes_hospital_w
	and     y.cd_pessoa_fisica      = cd_medico_executor_p
	and     z.nr_seq_profissional   = y.nr_sequencia
	and     cd_cbo 			= cd_cbo_p
	and     ((coalesce(z.dt_vigencia_inicial::text, '') = '') or (pkg_date_utils.get_time(z.dt_vigencia_inicial,0,0,0) <= pkg_date_utils.get_time(dt_procedimento_p,0,0,0)))
	and     ((coalesce(z.dt_vigencia_final::text, '') = '') or (pkg_date_utils.get_time(z.dt_vigencia_final,0,0,0) >= pkg_date_utils.get_time(dt_procedimento_p,0,0,0)))
	and     z.ie_atendimento_sus 	= 'S';
end if;

if (coalesce(ie_doc_executor_w::text, '') = '') then
	begin
	select  max(z.nr_seq_tipo_vinculo)
	into STRICT 	nr_seq_tipo_vinculo_w
	from    cnes_profissional y,
		cnes_identificacao x,
		cnes_profissional_vinculo z
	where   y.nr_seq_identificacao  = x.nr_sequencia
	and     x.CD_CNES               = cd_cnes_hospital_w
	and     y.cd_pessoa_fisica      = cd_medico_executor_p
	and     z.nr_seq_profissional   = y.nr_sequencia
	and     cd_cbo 			= cd_cbo_p
	and     ((coalesce(z.dt_vigencia_inicial::text, '') = '') or (pkg_date_utils.get_time(z.dt_vigencia_inicial,0,0,0) <= pkg_date_utils.get_time(dt_procedimento_p,0,0,0)))
	and     ((coalesce(z.dt_vigencia_final::text, '') = '') or (pkg_date_utils.get_time(z.dt_vigencia_final,0,0,0) >= pkg_date_utils.get_time(dt_procedimento_p,0,0,0)))
	and     z.ie_atendimento_sus 	= 'S';
	end;

	if (nr_seq_tipo_vinculo_w IS NOT NULL AND nr_seq_tipo_vinculo_w::text <> '') then
		begin

		begin
		select	ie_doc_executor
		into STRICT	ie_doc_executor_w
		from	cnes_tipo_vinculo
		where	nr_sequencia = nr_seq_tipo_vinculo_w
		and	ie_situacao = 'A';
		exception
		when others then
			ie_doc_executor_w := null;
		end;

		end;
	end if;
end if;

ie_doc_executor_p := ie_doc_executor_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_obter_doc_exec_cnes ( cd_estabelecimento_p bigint, cd_cbo_p text, cd_medico_executor_p text, dt_procedimento_p timestamp, ie_doc_executor_p INOUT bigint) FROM PUBLIC;

