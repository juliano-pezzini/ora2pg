-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE palm_finalizar_adm_medic ( nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_atend_w	bigint;
cd_profissional_w	varchar(10);
ie_somente_disp_w varchar(1);


BEGIN

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then

ie_somente_disp_w := obter_param_usuario(88, 304, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_somente_disp_w);

	SELECT 	max(a.nr_seq_atendimento)
	into STRICT	nr_seq_atend_w
	FROM	can_ordem_prod a,
		prescr_medica b,
		prescr_material c
	WHERE 	a.nr_prescricao 	= b.nr_prescricao
	AND	 a.nr_sequencia 	= c.nr_seq_ordem_prod
	AND	 a.nr_prescricao 	= nr_prescricao_p
	AND	 a.ie_cancelada 	= 'N'
	AND	 coalesce(c.nr_sequencia_diluicao::text, '') = ''
	AND	 (a.dt_checagem IS NOT NULL AND a.dt_checagem::text <> '')
	AND	 (a.dt_fim_preparo IS NOT NULL AND a.dt_fim_preparo::text <> '')
	and ((a.dt_entrega_setor IS NOT NULL AND a.dt_entrega_setor::text <> '') and (ie_somente_disp_w = 'S') or (ie_somente_disp_w = 'N'))
	AND	 ((c.ie_se_necessario = 'N') OR (c.ie_urgencia = 'S'))
	AND	 c.ie_agrupador = 1
	AND	 EXISTS (	SELECT 1
				FROM   PACIENTE_ATEND_MEDIC_ADM x
				WHERE  x.NR_SEQ_ATENDIMENTO 	= a.nr_seq_atendimento
				AND    coalesce(x.DT_FIM_ADMINISTRACAO::text, '') = '');

	select 	max(cd_pessoa_fisica)
	into STRICT	cd_profissional_w
	from	usuario
	where	nm_usuario = nm_usuario_p;

	if (nr_seq_atend_w IS NOT NULL AND nr_seq_atend_w::text <> '') then
		update	paciente_atend_medic_adm
		set	dt_fim_administracao 	= clock_timestamp(),
			cd_profissional_termino	= cd_profissional_w
		where	nr_seq_atendimento 	= nr_seq_atend_w
		and	coalesce(dt_fim_administracao::text, '') = '';
	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE palm_finalizar_adm_medic ( nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

