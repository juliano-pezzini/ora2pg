-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_prostheses_item_price (cd_billing_p text, cd_category_p bigint, cd_group_p bigint, cd_prior_billing_p text, cd_sub_category_p bigint, cd_sub_group_p bigint, cd_supplier_p text, ie_action_flag_p text, ds_change_explanation_p text, ds_item_description_p text, ds_name_p text, ds_note_p text, ds_size_p text, ds_suffix_p text, dt_cycle_end_p timestamp, dt_cycle_start_p timestamp, ie_item_type_p text, nr_artg_p bigint, qt_human_tissue_p bigint, vl_maximum_benefit_p bigint, vl_minimum_benefit_p bigint, dt_importation_p timestamp, nm_usuario_p text) AS $body$
DECLARE

					
nr_sequencia_w		prostheses_item_price.nr_sequencia%type;
ie_existe_billing_w	bigint;
cd_material_w		material.cd_material%type;

c01 CURSOR FOR
	SELECT	cd_material
	from	material
	where	cd_sistema_ant	= cd_billing_p
	and	ie_situacao = 'A';

BEGIN

select	coalesce(count(*), 0)
into STRICT	ie_existe_billing_w
from	prostheses_item
where	cd_billing	= cd_billing_p;

if (ie_existe_billing_w = 0) then
	insert into prostheses_item(	
			nm_usuario_nrec,
			nm_usuario,
			ie_item_type,
			dt_exclusion,
			dt_atualizacao_nrec,
			dt_atualizacao,
			ds_note,
			ds_name,
			ds_item_description,
			cd_billing)
	values (	nm_usuario_p,
			nm_usuario_p,
			ie_item_type_p,
			CASE WHEN ie_action_flag_p='D' THEN  dt_cycle_end_p  ELSE null END ,
			clock_timestamp(),
			clock_timestamp(),
			ds_note_p,
			ds_name_p,
			ds_item_description_p,
			cd_billing_p);
else
	if (ie_action_flag_p <> 'N') then
		update	prostheses_item
		set	nm_usuario_nrec		= nm_usuario_p,	
			nm_usuario		= nm_usuario_p,
			ie_item_type		= ie_item_type_p,
			dt_exclusion		= CASE WHEN ie_action_flag_p='D' THEN  dt_cycle_end_p  ELSE null END ,
			dt_atualizacao_nrec	= clock_timestamp(),
			dt_atualizacao		= clock_timestamp(),
			ds_note			= ds_note_p,
			ds_name			= ds_name_p,
			ds_item_description	= ds_item_description_p
		where	cd_billing		= cd_billing_p;
	end if;	
end if;

select	coalesce(count(*), 0)
into STRICT	ie_existe_billing_w
from	prostheses_item_material
where	cd_billing	= cd_billing_p;

if (ie_existe_billing_w = 0) then
	
	for r1 in c01 loop	
		select 	nextval('prostheses_item_material_seq')
		into STRICT	nr_sequencia_w
		;
		
		insert into prostheses_item_material(
				nr_sequencia,
				nm_usuario_nrec,
				nm_usuario,
				ie_situacao,
				dt_atualizacao_nrec,
				dt_atualizacao,
				cd_material,
				cd_billing)
		values (	nr_sequencia_w,
				nm_usuario_p,
				nm_usuario_p,
				'A',
				clock_timestamp(),
				clock_timestamp(),
				r1.cd_material,
				cd_billing_p);
	end loop;
	
end if;

select 	nextval('prostheses_item_price_seq')
into STRICT	nr_sequencia_w
;

insert into prostheses_item_price(	nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					dt_importation,
					cd_billing,
					ie_item_type,
					ds_name,
					cd_supplier,
					cd_category,
					cd_sub_category,
					cd_group,
					cd_sub_group,
					vl_minimum_benefit,
					vl_maximum_benefit,
					qt_human_tissue,
					ds_size,
					ds_suffix,
					ie_action_flag,
					ds_change_explanation,
					dt_cycle_start,
					dt_cycle_end,
					ds_item_description,
					ds_note,
					nr_artg,
					cd_prior_billing)
					
			values (	nr_sequencia_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					dt_importation_p,
					cd_billing_p,
					ie_item_type_p,
					ds_name_p,
					cd_supplier_p,
					cd_category_p,
					cd_sub_category_p,
					cd_group_p,
					cd_sub_group_p,
					vl_minimum_benefit_p,
					vl_maximum_benefit_p,
					qt_human_tissue_p,
					ds_size_p,
					ds_suffix_p,
					ie_action_flag_p,
					ds_change_explanation_p,
					dt_cycle_start_p,
					dt_cycle_end_p,
					ds_item_description_p,
					ds_note_p,
					nr_artg_p,
					cd_prior_billing_p);
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_prostheses_item_price (cd_billing_p text, cd_category_p bigint, cd_group_p bigint, cd_prior_billing_p text, cd_sub_category_p bigint, cd_sub_group_p bigint, cd_supplier_p text, ie_action_flag_p text, ds_change_explanation_p text, ds_item_description_p text, ds_name_p text, ds_note_p text, ds_size_p text, ds_suffix_p text, dt_cycle_end_p timestamp, dt_cycle_start_p timestamp, ie_item_type_p text, nr_artg_p bigint, qt_human_tissue_p bigint, vl_maximum_benefit_p bigint, vl_minimum_benefit_p bigint, dt_importation_p timestamp, nm_usuario_p text) FROM PUBLIC;

