-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_registro_aux ( nr_seq_registro_p bigint, ie_tipo_registro_p text, nm_usuario_p text, cd_empresa_p text, cd_estabelecimento_p text, dt_inicial_p timestamp, dt_final_p timestamp, dt_liberacao_p timestamp, ie_gerar_registro_p text, ie_gerar_arquivo_p text, ie_tipo_segurado_p text, ie_tipo_protocolo_p text, ie_gerar_ind_classif_p text, ie_recurso_proprio_p text, ie_status_p text, ie_tipo_data_p text, ie_tipo_livro_p text, ie_classificacao_p text, ie_copartic_faturar_p text, ds_retorno_p INOUT text) AS $body$
DECLARE


dt_geracao_w				timestamp;
qt_registros_w				ctb_livro_auxiliar.qt_registros%type;
ie_status_w				ctb_livro_auxiliar.ie_status%type := 'N';
ie_tipo_data_w				ctb_livro_auxiliar.ie_tipo_data%type := 'E';

	

BEGIN

CALL wheb_usuario_pck.set_ie_executar_trigger('N');

if (ie_gerar_registro_p = 'N') then

	if ie_tipo_registro_p in ('8000','8001','8002','8003','8004','8005','8006','8011','8012','8013','8020','8022','8025', '8029') then
	
		delete
		from	w_ctb_livro_aux_event_liq
		where	nr_seq_reg_auxiliar = nr_seq_registro_p;
	
	elsif ie_tipo_registro_p in ('8007','8008','8009','8010','8014','8016','8018','8024') then
	
		delete
		from	w_ctb_aux_contra_emit
		where	nr_seq_reg_auxiliar = nr_seq_registro_p;
		
	end if;

	delete
	from	ctb_reg_auxiliar_log
	where	nr_seq_reg_auxiliar = nr_seq_registro_p;
	
	commit;
	
end if;

if (ie_gerar_registro_p = 'S') then
	
	
	if (ie_tipo_registro_p = '8008') then
		select	coalesce(max(a.ie_status),'N'),
			coalesce(max(a.ie_tipo_data),'E')
		into STRICT	ie_status_w,
			ie_tipo_data_w
		from	ctb_livro_auxiliar	a
		where	a.nr_sequencia	= nr_seq_registro_p;
	end if;
	
	select	max(a.dt_geracao)
	into STRICT	dt_geracao_w
	from	ctb_livro_auxiliar	a
	where (dt_inicial_p between a.dt_inicial and a.dt_final
	or	dt_final_p between a.dt_inicial and a.dt_final)
	and	a.ie_tipo_reg_auxiliar_ans = ie_tipo_registro_p
	and	a.nr_sequencia <> nr_seq_registro_p
	and 	((a.cd_estab_exclusivo = cd_estabelecimento_p)
		or (coalesce(cd_estabelecimento_p::text, '') = ''))
	and 	((a.ie_tipo_protocolo = ie_tipo_protocolo_p)
		or (coalesce(ie_tipo_protocolo_p::text, '') = ''))
	and 	((a.ie_tipo_segurado = ie_tipo_segurado_p)
		or (coalesce(ie_tipo_segurado_p::text, '') = ''))
	and 	((a.ie_recurso_proprio = ie_recurso_proprio_p)
		or (coalesce(ie_recurso_proprio_p::text, '') = ''))
	and 	((a.ie_copartic_faturar = ie_copartic_faturar_p)
		or (coalesce(ie_copartic_faturar_p::text, '') = ''))
	and 	((a.ie_status = ie_status_p)
		or (coalesce(ie_status_p::text, '') = ''))
	and 	((a.ie_classificacao = ie_classificacao_p)
		or (coalesce(ie_classificacao_p::text, '') = ''));
	
	if (dt_geracao_w IS NOT NULL AND dt_geracao_w::text <> '') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(432990);
	end if;
	
	if (ie_tipo_registro_p = '8000') then
		CALL ctb_gerar_livro_aux_ev_liq_co( 	nm_usuario_p,
						cd_empresa_p,
						cd_estabelecimento_p,
						dt_inicial_p,
						dt_final_p,
						dt_liberacao_p,
						ie_gerar_arquivo_p,
						nr_seq_registro_p);
	/*				
	elsif	(ie_tipo_registro_p = '8001') then
		ctb_gerar_livro_aux_event_liq( 	nm_usuario_p,
						cd_empresa_p,
						cd_estabelecimento_p,
						dt_inicial_p,
						dt_final_p,
						dt_liberacao_p,
						ie_gerar_arquivo_p,
						nr_seq_registro_p);

	elsif	(ie_tipo_registro_p = '8002') then
		ctb_gerar_aux_event_med( 	nm_usuario_p,
						cd_empresa_p,
						cd_estabelecimento_p,
						dt_inicial_p,
						dt_final_p,
						dt_liberacao_p,
						ie_gerar_arquivo_p,
						nr_seq_registro_p);
	
	*/
elsif (ie_tipo_registro_p = '8003') then
		CALL pls_gerar_event_glosa(	nr_seq_registro_p,
					nm_usuario_p,
					cd_estabelecimento_p,
					'D',
					ie_gerar_arquivo_p);					
	
	/*elsif	(ie_tipo_registro_p = '8004') then
		ctb_gerar_aux_event_cop( 	nm_usuario_p,
						cd_empresa_p,
						cd_estabelecimento_p,
						dt_inicial_p,
						dt_final_p,
						dt_liberacao_p,
						ie_gerar_arquivo_p,
	*/
		
	elsif (ie_tipo_registro_p = '8005') then
		CALL ctb_gerar_aux_event_cop_co( 	nm_usuario_p,
						cd_empresa_p,
						cd_estabelecimento_p,
						dt_inicial_p,
						dt_final_p,
						dt_liberacao_p,
						ie_gerar_arquivo_p,
						nr_seq_registro_p,
						ie_tipo_segurado_p,
						ie_tipo_protocolo_p,
						ie_gerar_ind_classif_p,
						ie_copartic_faturar_p);
	
	elsif (ie_tipo_registro_p = '8006') then
		CALL pls_gerar_debitos_nao_relac(	nr_seq_registro_p,
						nm_usuario_p,
						cd_estabelecimento_p,
						'D',
						ie_gerar_arquivo_p);

	/*
	elsif	(ie_tipo_registro_p = '8007') then
		ctb_gerar_contra_emitida( 	nm_usuario_p,
						cd_empresa_p,
						cd_estabelecimento_p,
						dt_inicial_p,
						dt_final_p,
						ie_status_p,
						ie_tipo_data_p,
						dt_liberacao_p,
						ie_gerar_arquivo_p,
						nr_seq_registro_p);
	*/
	elsif (ie_tipo_registro_p = '8008') then
		CALL ctb_gerar_contra_emitida_co( 	nm_usuario_p,
						cd_empresa_p,
						cd_estabelecimento_p,
						dt_inicial_p,
						dt_final_p,
						ie_status_p,
						dt_liberacao_p,
						ie_gerar_arquivo_p,
						nr_seq_registro_p);			
	/*
	elsif	(ie_tipo_registro_p = '8009') then
		ctb_gerar_aux_contrap_rec( 	nm_usuario_p,
						cd_empresa_p,
						cd_estabelecimento_p,
						dt_inicial_p,
						dt_final_p,
						dt_liberacao_p,
						ie_gerar_arquivo_p,
						nr_seq_registro_p);
	*/
			
	elsif (ie_tipo_registro_p = '8010') then
		CALL ctb_gerar_aux_contrap_rec_co( 	nm_usuario_p,
						cd_empresa_p,
						cd_estabelecimento_p,
						dt_inicial_p,
						dt_final_p,
						dt_liberacao_p,
						ie_gerar_arquivo_p,
						nr_seq_registro_p,
						ie_classificacao_p);	
	
	elsif (ie_tipo_registro_p = '8011') then
		CALL ctb_gerar_aux_a_faturar( 	nm_usuario_p,
						cd_empresa_p,
						cd_estabelecimento_p,
						dt_inicial_p,
						dt_final_p,
						dt_liberacao_p,
						ie_gerar_arquivo_p,
						nr_seq_registro_p);
	/*
	elsif	(ie_tipo_registro_p = '8012') then
		ctb_gerar_aux_event_conhec( 	nm_usuario_p,
						cd_empresa_p,
						cd_estabelecimento_p,
						dt_inicial_p,
						dt_final_p,
						dt_liberacao_p,
						ie_gerar_arquivo_p,
						nr_seq_registro_p);
	*/
	elsif (ie_tipo_registro_p = '8013') then
		CALL ctb_gerar_aux_event_conhec_cop( nm_usuario_p,
						cd_empresa_p,
						cd_estabelecimento_p,
						dt_inicial_p,
						dt_final_p,
						dt_liberacao_p,
						ie_gerar_arquivo_p,
						nr_seq_registro_p,
						ie_tipo_segurado_p,
						ie_tipo_protocolo_p,
						ie_gerar_ind_classif_p);
	
	elsif (ie_tipo_registro_p = '8014') then

		CALL pls_gerar_contrap_recebidas(	nr_seq_registro_p,
						nm_usuario_p,
						cd_estabelecimento_p,
						'D',
						ie_gerar_arquivo_p);

	/*					
	elsif	(ie_tipo_registro_p = '8016') then
		ctb_gerar_contra_cancel( 	nm_usuario_p,
						cd_empresa_p,
						cd_estabelecimento_p,
						dt_inicial_p,
						dt_final_p,
						dt_liberacao_p,
						ie_gerar_arquivo_p,
						nr_seq_registro_p);

	elsif	(ie_tipo_registro_p = '8018') then
		ctb_gerar_aux_idade_saldo( 	nm_usuario_p,
						cd_empresa_p,
						cd_estabelecimento_p,
						dt_inicial_p,
						dt_final_p,
						dt_liberacao_p,
						ie_tipo_livro_p,
						ie_gerar_arquivo_p,
						nr_seq_registro_p);

	elsif	(ie_tipo_registro_p = '8020') then
		ctb_gerar_aux_idade_saldo( 	nm_usuario_p,
						cd_empresa_p,
						cd_estabelecimento_p,
						dt_inicial_p,
						dt_final_p,
						dt_liberacao_p,
						ie_tipo_livro_p,
						ie_gerar_arquivo_p,
						nr_seq_registro_p);

	elsif	(ie_tipo_registro_p = '8022') then
		ctb_gerar_livro_aux_pag_subs( 	nm_usuario_p,
						cd_empresa_p,
						cd_estabelecimento_p,
						dt_inicial_p,
						dt_final_p,
						dt_liberacao_p,
						ie_gerar_arquivo_p,
						nr_seq_registro_p);
	*/
	elsif (ie_tipo_registro_p = '8024') then

		CALL pls_gerar_contr_gerencial(	nr_seq_registro_p,
						nm_usuario_p,
						cd_estabelecimento_p,
						'D',
						ie_gerar_arquivo_p);
	
	elsif (ie_tipo_registro_p = '8025') then

		CALL pls_gerar_ress_sus(	nr_seq_registro_p,
					nm_usuario_p,
					cd_estabelecimento_p,
					'D',
					ie_gerar_arquivo_p);

	elsif (ie_tipo_registro_p = '8029') then

		CALL pls_gerar_event_pos_estab(	nr_seq_registro_p,
						nm_usuario_p,
						cd_estabelecimento_p,
						'D',
						ie_gerar_arquivo_p);
	end if;
	
	if (ie_gerar_arquivo_p = 'S') then
		ds_retorno_p		:= wheb_mensagem_pck.get_texto(43671);
	end if;
	
select	sum(qt_registros)
into STRICT	qt_registros_w
from (SELECT	count(*) qt_registros
	from	w_ctb_livro_aux_event_liq	a
	where	a.nr_seq_reg_auxiliar	= nr_seq_registro_p
	
union all

	SELECT	count(*) qt_registros
	from	w_ctb_aux_contra_emit
	where	nr_seq_reg_auxiliar = nr_seq_registro_p) alias3;
	
end if;	

if (coalesce(nr_seq_registro_p,0) <> 0) then

	if (ie_gerar_registro_p = 'S') and (ie_gerar_arquivo_p <> 'S') then
		update	ctb_livro_auxiliar
		set	dt_geracao	= clock_timestamp(),
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p,
			qt_registros	= qt_registros_w
		where	nr_sequencia	= nr_seq_registro_p;
		commit;
		
		ds_retorno_p		:= wheb_mensagem_pck.get_texto(391386);
	end if;

	if (ie_gerar_registro_p = 'N') then
		update	ctb_livro_auxiliar
		set	dt_geracao	 = NULL,
			qt_registros	= 0,
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p
		where	nr_sequencia	= nr_seq_registro_p;
		commit;
		
		ds_retorno_p		:= wheb_mensagem_pck.get_texto(391387);
	end if;

end if;

CALL wheb_usuario_pck.set_ie_executar_trigger('S');

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_registro_aux ( nr_seq_registro_p bigint, ie_tipo_registro_p text, nm_usuario_p text, cd_empresa_p text, cd_estabelecimento_p text, dt_inicial_p timestamp, dt_final_p timestamp, dt_liberacao_p timestamp, ie_gerar_registro_p text, ie_gerar_arquivo_p text, ie_tipo_segurado_p text, ie_tipo_protocolo_p text, ie_gerar_ind_classif_p text, ie_recurso_proprio_p text, ie_status_p text, ie_tipo_data_p text, ie_tipo_livro_p text, ie_classificacao_p text, ie_copartic_faturar_p text, ds_retorno_p INOUT text) FROM PUBLIC;

