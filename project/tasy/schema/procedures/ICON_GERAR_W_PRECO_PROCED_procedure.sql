-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE icon_gerar_w_preco_proced ( cd_convenio_p text, cd_categoria_p text, cd_setor_atendimento_p text, cd_procedimento_p text, cd_especialidade_p text, dt_vigencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
				 
cd_procedimento_w	        estrutura_procedimento_v.cd_procedimento%type;
ds_procedimento_w            PROCEDIMENTO.DS_PROCEDIMENTO%type;
ie_origem_proced_w           estrutura_procedimento_v.ie_origem_proced%type;

cd_convenio_w 		        convenio_amb.cd_convenio%type;
cd_categoria_w 		        convenio_amb.cd_categoria%type;
cd_edicao_amb_w 	        preco_amb.cd_edicao_amb%type;
vl_ch_honorario_w 	        preco_amb.vl_medico%type;

conta_exame_lab_w	        integer;
nr_count_w		        integer;
vl_preco_venda_w	        double precision:=0;
nr_seq_exame_w		        bigint;
nm_exame_w		        varchar(80);
cd_procedimento_tuss_w	        bigint;
ds_valor_dominio_w           valor_dominio.ds_valor_dominio%type;

vl_ch_w		            double precision;
qt_filme_w 	            double precision;
vl_filme_w	            double precision;
vl_proced_w	            double precision;

dt_vigencia_w timestamp;
dt_inicio_vigencia_w          preco_amb.dt_inicio_vigencia%type;

cd_conv_param_w			    varchar(2000);
ie_conv_diferente_w		    varchar(1);

cd_categ_param_w		    varchar(2000);
ie_categ_diferente_w		    varchar(1);

cd_espec_param_w		    varchar(2000);
ie_espec_diferente_w		    varchar(1);

cd_setor_param_w		    varchar(2000);
ie_setor_diferente_w		    varchar(1);

cd_proced_param_w		    varchar(2000);
ie_proced_diferente_w		    varchar(1);
ds_sql_w                varchar(2000) := '';
vl_ch_convenio_w            convenio_amb.vl_ch_honorarios%type;
vl_filme_convenio_w           convenio_amb.vl_filme%type;
ds_categoria_w             categoria_convenio.ds_categoria%type;

C02 CURSOR FOR 
	SELECT	a.cd_convenio, 
        a.cd_categoria, 
		b.vl_medico, 
		b.dt_inicio_vigencia, 
		c.cd_procedimento, 
		c.ds_procedimento, 
        a.vl_ch_honorarios, 
        a.vl_filme, 
        Obter_preco_procedimento(cd_estabelecimento_p, 
                    a.cd_convenio, 
                    a.cd_categoria, 
                    dt_vigencia_p, 
                    c.cd_procedimento, 
                    c.ie_origem_proced, 
                    0, -- cd_tipo_acomodacao_p 
                    0, -- ie_tipo_atendimento_p 
                    c.cd_setor_exclusivo, -- cd_setor_atendimento_p 
                    null, -- cd_medico_p 
                    0, -- cd_funcao_medico_p 
                    null, -- cd_usuario_convenio_p 
                    null, -- cd_plano_p 
                    0, -- ie_clinica_p 
                    0, -- cd_empresa_ref_p 
                    'F')      vl_filme_calc , -- VL FILME 
        Obter_preco_procedimento(cd_estabelecimento_p, 
                    a.cd_convenio, 
                    a.cd_categoria, 
                    dt_vigencia_p, 
                    c.cd_procedimento, 
                    c.ie_origem_proced, 
                    0, -- cd_tipo_acomodacao_p 
                    0, -- ie_tipo_atendimento_p 
                    c.cd_setor_exclusivo, -- cd_setor_atendimento_p 
                    null, -- cd_medico_p 
                    0, -- cd_funcao_medico_p 
                    null, -- cd_usuario_convenio_p 
                    null, -- cd_plano_p 
                    0, -- ie_clinica_p 
                    0, -- cd_empresa_ref_p 
                    'M')      vl_ch_calc, -- VL CH 
        Obter_qt_filme_amb(   b.cd_edicao_amb, 
                    c.cd_procedimento, 
                    c.ie_origem_proced, 
                    dt_vigencia_p) qt_filme_calc -- QT FILME 
	from	convenio_amb  a, 
		preco_amb    b, 
		estrutura_procedimento_v c 
	where	a.cd_edicao_amb = b.cd_edicao_amb 
	and	a.ie_situacao  = 'A' 
	and	a.cd_estabelecimento  = cd_estabelecimento_p 
	and	b.cd_procedimento    = c.cd_procedimento 
	and	b.ie_origem_proced   = c.ie_origem_proced 
	 
    --and   ((dt_vigencia_w between b.dt_inicio_vigencia and b.dt_final_vigencia) or (dt_vigencia_w >= b.dt_inicio_vigencia)) 	-- Filtro por data 
	and 	b.dt_inicio_vigencia = (  SELECT max(b2.dt_inicio_vigencia) 
                    from  preco_amb b2 
                    where  b2.cd_edicao_amb    = b.cd_edicao_amb 
                    and   b2.cd_procedimento   = b.cd_procedimento 
                    and	b2.ie_origem_proced   = b.ie_origem_proced 
                    and   ((dt_vigencia_w between b2.dt_inicio_vigencia and coalesce(b2.dt_final_vigencia,dt_vigencia_w)) 
                        and (dt_vigencia_w >= b2.dt_inicio_vigencia) 
                    ) 
                   ) 
    and   a.dt_inicio_vigencia = (  	select max(a2.dt_inicio_vigencia) 
						from  convenio_amb a2 
						where  a2.cd_categoria 	= a.cd_categoria 
						and 	a2.cd_convenio		= a.cd_convenio 
						and 	a2.ie_situacao = 'A' 
						and   ((dt_vigencia_w between a2.dt_inicio_vigencia and coalesce(a2.dt_final_vigencia,dt_vigencia_w)) 
							and (dt_vigencia_w >= a2.dt_inicio_vigencia)) 
					) 
	and	((coalesce(cd_convenio_p,'0') = '0') 
				or cd_convenio_p like '' 
				or (ie_conv_diferente_w = 'S' and obter_se_contido(a.cd_convenio, cd_conv_param_w) = 'N') 
				or (ie_conv_diferente_w = 'N' and obter_se_contido(a.cd_convenio, cd_conv_param_w) = 'S')) -- Filtro por convÃªnio 
	and	((coalesce(cd_categoria_p,'0') = '0') 
				or cd_categoria_p like '' 
				or (ie_categ_diferente_w = 'S' and obter_se_contido(a.cd_categoria, cd_categ_param_w) = 'N') 
				or (ie_categ_diferente_w = 'N' and obter_se_contido(a.cd_categoria, cd_categ_param_w) = 'S')) -- Filtro por categoria 
	and 	((coalesce(cd_procedimento_p, '0') = '0') 
				or cd_procedimento_p like '' 
				or (ie_proced_diferente_w = 'S' and obter_se_contido(c.cd_procedimento, cd_proced_param_w) = 'N') 
				or (ie_proced_diferente_w = 'N' and obter_se_contido(c.cd_procedimento, cd_proced_param_w) = 'S')) -- Filtro por procedimento 
	and 	((coalesce(cd_setor_atendimento_p, '0') = '0') 
				or cd_setor_atendimento_p like '' 
				or (ie_setor_diferente_w = 'S' and obter_se_contido(c.cd_setor_exclusivo, cd_setor_param_w) = 'N') 
				or (ie_setor_diferente_w = 'N' and obter_se_contido(c.cd_setor_exclusivo, cd_setor_param_w) = 'S')) -- Filtro pro setor atendimento 
	and 	((coalesce(cd_especialidade_p,'0') = '0') 
				or cd_especialidade_p like '' 				 
				or (ie_espec_diferente_w = 'S' and obter_se_contido(c.cd_especialidade, cd_espec_param_w) = 'N') 
				or (ie_espec_diferente_w = 'N' and obter_se_contido(c.cd_especialidade, cd_espec_param_w) = 'S')) --Filtro por especialidade 
	group by 	a.cd_convenio, 
            a.cd_categoria, 
            b.cd_edicao_amb, 
            b.vl_medico, 
            b.dt_inicio_vigencia, 
            c.cd_procedimento, 
            c.ds_procedimento, 
            c.ie_origem_proced, 
            a.vl_ch_honorarios, 
            a.vl_filme, 
            c.cd_setor_exclusivo 
	order by 1;


BEGIN 
 
dt_vigencia_w := to_date(dt_vigencia_p);
 
if (substr(cd_convenio_p,1,1) = '-') then 
	ie_conv_diferente_w := 'S';
else 
	ie_conv_diferente_w := 'N';
end if;
 
if (ie_conv_diferente_w = 'S') then 
	cd_conv_param_w := substr(cd_convenio_p, 2, length(cd_convenio_p));
else 
	cd_conv_param_w := cd_convenio_p;
end if;
 
if (substr(cd_categoria_p,1,1) = '-') then 
	ie_categ_diferente_w := 'S';
else 
	ie_categ_diferente_w := 'N';
end if;
 
if (ie_categ_diferente_w = 'S') then 
	cd_categ_param_w := substr(cd_categoria_p, 2, length(cd_categoria_p));
else 
	cd_categ_param_w := cd_categoria_p;
end if;
 
if (substr(cd_especialidade_p,1,1) = '-') then 
	ie_espec_diferente_w := 'S';
else 
	ie_espec_diferente_w := 'N';
end if;
 
if (ie_espec_diferente_w = 'S') then 
	cd_espec_param_w := substr(cd_especialidade_p, 2, length(cd_especialidade_p));
else 
	cd_espec_param_w := cd_especialidade_p;
end if;
 
if (substr(cd_setor_atendimento_p,1,1) = '-') then 
	ie_setor_diferente_w := 'S';
else 
	ie_setor_diferente_w := 'N';
end if;
 
if (ie_setor_diferente_w = 'S') then 
	cd_setor_param_w := substr(cd_setor_atendimento_p, 2, length(cd_setor_atendimento_p));
else 
	cd_setor_param_w := cd_setor_atendimento_p;
end if;
 
if (substr(cd_procedimento_p,1,1) = '-') then 
	ie_proced_diferente_w := 'S';
else 
	ie_proced_diferente_w := 'N';
end if;
 
if (ie_proced_diferente_w = 'S') then 
	cd_proced_param_w := substr(cd_procedimento_p, 2, length(cd_procedimento_p));
else 
	cd_proced_param_w := cd_procedimento_p;
end if;
 
 
Select	count(table_name) 
into STRICT	nr_count_w 
from	user_tables 
where	upper(table_name) = 'W_REL_PRECO_PROC_CONV_ICON';
 
if (nr_count_w	= 0) then								 
	CALL exec_sql_dinamico(nm_usuario_p,'create table w_rel_preco_proc_conv_icon( 
								nm_usuario		varchar2(15), 
								cd_convenio		Number(5), 
                                cd_categoria      Varchar2(10), 
                                ds_categoria      Varchar2(80), 
								cd_procedimento		Number(15), 
								ds_procedimento		PROCEDIMENTO.DS_PROCEDIMENTO%type, 
								qt_ch		    Number(15,4), 
								vl_ch		    Number(15,4), 
								qt_filme 	    Number(15,4), 
								vl_filme 	    Number(15,4), 
								vl_proced	    Number(15,4), 
								dt_inicio_vigencia   Date, 
                                vl_ch_convenio     number(15,4), 
                                vl_filme_convenio    number(15,4) 
								)');
else 
	CALL exec_sql_dinamico(nm_usuario_p,'delete from w_rel_preco_proc_conv_icon where nm_usuario = ' || chr(39) || nm_usuario_p || chr(39));
end if;
 
open C02;
loop 
fetch C02 into 
	cd_convenio_w, 
    cd_categoria_w, 
	vl_ch_honorario_w, 
	dt_inicio_vigencia_w, 
	cd_procedimento_w, 
	ds_procedimento_w, 
    vl_ch_convenio_w, 
    vl_filme_convenio_w, 
    vl_filme_w, --filme calculado 
    vl_ch_w,  --ch calculado 
    qt_filme_w; --qt filme calculado    
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin 
    vl_proced_w := coalesce(vl_ch_w,0) + coalesce(vl_filme_w,0); --total 
	
    begin 
        select substr(ds_categoria,1,80) 
        into STRICT  ds_categoria_w 
        from  categoria_convenio 
        where  cd_convenio   = cd_convenio_w 
        and   cd_categoria  = cd_categoria_w;
    exception 
    when others then 
        ds_categoria_w := '';
    end;
     
    ds_sql_w := 'insert into w_rel_preco_proc_conv_icon( 
                                nm_usuario, 
                                cd_convenio, 
                                cd_categoria, 
                                ds_categoria, 
                                cd_procedimento, 
                                ds_procedimento, 
                                qt_ch, 
                                vl_ch, 
                                qt_filme, 
                                vl_filme, 
                                vl_proced, 
                                dt_inicio_vigencia, 
                                vl_ch_convenio, 
                                vl_filme_convenio 
                                ) 
     
			values ('	|| chr(39) || nm_usuario_p	 	   || chr(39) ||',' 
					|| cd_convenio_w					||',' 
                    || cd_categoria_w					||',' 
                    || chr(39)||ds_categoria_w||chr(39)			||',' 
					|| cd_procedimento_w					||',' 
					|| chr(39) || ds_procedimento_w	 	   || chr(39) ||',' 
					|| replace(to_char(coalesce(vl_ch_honorario_w,0)),',','.') || ','                     
                    || replace(to_char(coalesce(vl_ch_w,0)),',','.') || ',' 
                    || replace(to_char(coalesce(qt_filme_w,0)),',','.') || ',' 
                    || replace(to_char(coalesce(vl_filme_w,0)),',','.') || ',' 
                    || replace(to_char(coalesce(vl_proced_w,0)),',','.') || ',' 
					|| chr(39) || dt_inicio_vigencia_w || chr(39) || ',' 
                    || replace(to_char(coalesce(vl_ch_convenio_w,0)),',','.') || ',' 
                    || replace(to_char(coalesce(vl_filme_convenio_w,0)),',','.') ||')';
	 
    CALL exec_sql_dinamico( nm_usuario_p,ds_sql_w);
     
	end;
end loop;
close C02;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE icon_gerar_w_preco_proced ( cd_convenio_p text, cd_categoria_p text, cd_setor_atendimento_p text, cd_procedimento_p text, cd_especialidade_p text, dt_vigencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

