-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_estornar_baixa_oc ( nr_ordem_compra_p bigint, nr_item_oci_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE



ie_permite_estornar_com_nf_w		funcao_param_usuario.vl_parametro%type;
qt_existe_w				bigint;


BEGIN

select	max(obter_valor_param_usuario(917, 78, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p))
into STRICT	ie_permite_estornar_com_nf_w
;

if (ie_permite_estornar_com_nf_w = 'N') then

	select	count(*)
	into STRICT	qt_existe_w
	from	nota_fiscal a,
		nota_fiscal_item b
	where	a.nr_sequencia = b.nr_sequencia
	and	b.nr_ordem_compra = nr_ordem_compra_p
	and	a.ie_situacao = '1'
	and	((nr_item_oci_p = 0) or
		(nr_item_oci_p > 0 AND b.nr_item_oci = nr_item_oci_p));

	if (qt_existe_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(252188); /*Sem permissão para estornar a baixa, pois já possui nota fiscal gerada que está vinculada com essa ordem de compra. Verifique o parâmetro [78].*/
	end if;
elsif (ie_permite_estornar_com_nf_w = 'C') then

	select	count(*)
	into STRICT	qt_existe_w
	from	nota_fiscal a,
		nota_fiscal_item b
	where	a.nr_sequencia = b.nr_sequencia
	and	b.nr_ordem_compra = nr_ordem_compra_p
	and	(a.dt_atualizacao_estoque IS NOT NULL AND a.dt_atualizacao_estoque::text <> '')
	and	a.ie_situacao = '1'
	and	((nr_item_oci_p = 0) or
		(nr_item_oci_p > 0 AND b.nr_item_oci = nr_item_oci_p));

	if (qt_existe_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(334861); /*Sem permissão para estornar a baixa, pois já possui nota fiscal gerada e calculada que está vinculada com essa ordem de compra. Verifique o parâmetro [78].*/
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_estornar_baixa_oc ( nr_ordem_compra_p bigint, nr_item_oci_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

