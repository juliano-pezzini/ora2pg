-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inserir_guia_conta ( nr_seq_conta_p bigint, ie_tipo_item_p text, nr_seq_item_p bigint, dt_liberacao_p timestamp, cd_profissional_p text, nr_seq_grau_partic_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_profissional_executor_w	varchar(10);
ie_tipo_despesa_w		varchar(1);
ie_classificacao_proc_w		varchar(1);
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
nr_seq_material_w		bigint;
nr_seq_conta_proc_w		bigint;
nr_seq_protocolo_w		bigint;
nr_seq_grau_partic_w		bigint;
qt_autorizada_proc_w		double precision;
qt_autorizada_mat_w		double precision;
cd_material_w			integer;
nr_seq_prest_fornec_w		pls_guia_plano_mat.nr_seq_prest_fornec%type;
nr_seq_conta_mat_w		pls_conta_mat.nr_sequencia%type;
nr_seq_item_tiss_proc_w		pls_guia_plano_proc.nr_seq_item_tiss%type;
nr_seq_item_tiss_mat_w		pls_guia_plano_mat.nr_seq_item_tiss%type;


BEGIN
if (ie_tipo_item_p = 'P') then
	select	a.cd_procedimento,
		a.ie_origem_proced,
		a.qt_autorizada,
		nr_seq_item_tiss
	into STRICT	cd_procedimento_w,
		ie_origem_proced_w,
		qt_autorizada_proc_w,
		nr_seq_item_tiss_proc_w
	from	pls_guia_plano_proc	a
	where	a.nr_sequencia	= nr_seq_item_p;

	if (coalesce(ie_origem_proced_w::text, '') = '') then
		delete	FROM pls_conta
		where	nr_sequencia	= nr_seq_conta_p;

		commit;

		CALL wheb_mensagem_pck.exibir_mensagem_abort(198932,'CD_PROCEDIMENTO=' || cd_procedimento_w);
		--R aise_application_error(-20011,' NÃ£o informado a origem do procedimento: '||cd_procedimento_w||'#@#@');
	end if;

	select	a.ie_classificacao
	into STRICT	ie_classificacao_proc_w
	from	procedimento	a
	where	a.cd_procedimento	= cd_procedimento_w
	and	a.ie_origem_proced	= ie_origem_proced_w;

	select	nextval('pls_conta_proc_seq')
	into STRICT	nr_seq_conta_proc_w
	;

	insert into pls_conta_proc(nr_sequencia,
		nm_usuario,
		dt_atualizacao,
		cd_procedimento,
		ie_origem_proced,
		qt_procedimento_imp,
		nr_seq_conta,
		ie_tipo_despesa,
		ie_status,
		ie_situacao,
		vl_procedimento_imp,
		vl_unitario_imp,
		vl_unitario,
		qt_procedimento,
		vl_liberado,
		vl_procedimento,
		vl_glosa,
		vl_saldo,
		tx_item,
		dt_procedimento)
	values (nr_seq_conta_proc_w,
		nm_usuario_p,
		clock_timestamp(),
		cd_procedimento_w,
		ie_origem_proced_w,
		qt_autorizada_proc_w,
		nr_seq_conta_p,
		ie_classificacao_proc_w,
		'U',
		'D',
		0,
		0,
		0,
		0,
		0,
		0,
		0,
		0,
		100,
		dt_liberacao_p);
	CALL pls_cta_proc_mat_regra_pck.cria_registro_regra_proc(nr_seq_conta_proc_w, nm_usuario_p);
	CALL pls_cta_proc_mat_regra_pck.atualiza_seq_tiss_proc(nr_seq_conta_proc_w, nr_seq_item_tiss_proc_w, null, nm_usuario_p);


	if (cd_profissional_p IS NOT NULL AND cd_profissional_p::text <> '') then
		CALL pls_gerar_proc_participante(nr_seq_conta_proc_w, cd_profissional_p, nr_seq_grau_partic_p, null, nm_usuario_p);
	end if;
elsif (ie_tipo_item_p = 'M') then
	select	a.nr_seq_material,
		a.qt_autorizada,
		a.nr_seq_prest_fornec,
		nr_seq_item_tiss
	into STRICT	nr_seq_material_w,
		qt_autorizada_mat_w,
		nr_seq_prest_fornec_w,
		nr_seq_item_tiss_mat_w
	from	pls_guia_plano_mat	a
	where	a.nr_sequencia	= nr_seq_item_p;

	select 	coalesce(max(a.ie_tipo_despesa),2)
	into STRICT	ie_tipo_despesa_w
	from	pls_material	a
	where	a.nr_sequencia	= nr_seq_material_w;

	insert into pls_conta_mat(nr_sequencia,
		nm_usuario,
		dt_atualizacao,
		qt_material_imp,
		nr_seq_conta,
		ie_tipo_despesa,
		ie_status,
		ie_situacao,
		vl_unitario_imp,
		vl_unitario,
		qt_material,
		vl_material_imp,
		vl_material,
		vl_liberado,
		vl_saldo,
		vl_glosa,
		dt_atendimento,
		nr_seq_material,
		nr_seq_prest_fornec)
	values (nextval('pls_conta_mat_seq'),
		nm_usuario_p,
		clock_timestamp(),
		qt_autorizada_mat_w,
		nr_seq_conta_p,
		ie_tipo_despesa_w,
		'U',
		'D',
		0,
		0,
		0,
		0,
		0,
		0,
		0,
		0,
		dt_liberacao_p,
		nr_seq_material_w,
		nr_seq_prest_fornec_w) returning nr_sequencia into nr_seq_conta_mat_w;

	CALL pls_cta_proc_mat_regra_pck.cria_registro_regra_mat(nr_seq_conta_mat_w, nm_usuario_p);
	CALL pls_cta_proc_mat_regra_pck.atualiza_seq_tiss_mat(nr_seq_conta_mat_w, nr_seq_item_tiss_mat_w, null, nm_usuario_p);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inserir_guia_conta ( nr_seq_conta_p bigint, ie_tipo_item_p text, nr_seq_item_p bigint, dt_liberacao_p timestamp, cd_profissional_p text, nr_seq_grau_partic_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

