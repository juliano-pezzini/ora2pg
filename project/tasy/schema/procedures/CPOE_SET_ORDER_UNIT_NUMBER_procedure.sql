-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_set_order_unit_number ( nr_seq_cpoe_tipo_pedido_p bigint, si_type_of_prescription_p text, nr_atendimento_p bigint, dt_start_p timestamp, nr_order_unit_p INOUT text) AS $body$
DECLARE


nr_order_unit_w             cpoe_order_unit.nr_order_unit%type := null;
nr_seq_cpoe_rule_slip_w   cpoe_rule_slip_number.nr_sequencia%type  := null;
new_day_w                   varchar(1) := 'N';
nr_current_seq_w      cpoe_rule_slip_number.nr_current_seq%type;
ie_tipo_atendimento_w atendimento_paciente.ie_tipo_atendimento%type;
dt_start_w              cpoe_order_unit.dt_start%type;

C_rule CURSOR FOR
  SELECT  a.nr_sequencia
   FROM cpoe_rule_slip_number a
LEFT OUTER JOIN cpoe_rule_slip_tipo_ped b ON (a.nr_sequencia = b.nr_seq_cpoe_rule_slip)
WHERE coalesce(b.nr_seq_cpoe_tipo_pedido,nr_seq_cpoe_tipo_pedido_p) = nr_seq_cpoe_tipo_pedido_p and coalesce(b.si_type_of_prescription,coalesce(si_type_of_prescription_p,'0')) = coalesce(si_type_of_prescription_p,'0') and coalesce(b.ie_tipo_atendimento,coalesce(ie_tipo_atendimento_w,'0')) = coalesce(ie_tipo_atendimento_w,'0') and clock_timestamp() Between pkg_date_utils.start_of(a.dt_vigencia_ini,'DAY') and coalesce(pkg_date_utils.end_of(a.Dt_vigencia_fim,'DAY'), clock_timestamp()) and b.si_event_type = 'OU' order by
    coalesce(b.nr_seq_cpoe_tipo_pedido,'0'),
    coalesce(b.si_type_of_prescription,'AAAAAAA');


C_Update CURSOR( nr_sequencia_p  bigint) FOR
  SELECT nr_sequencia,
         CD_PREFIXO_SLIP_NUMBER,
         ds_timestamp_format,
         nr_current_seq,
         qt_maximo,
         si_seq_restart_daily,
         dt_last_seq_reset,
         ds_sufixo
   from  cpoe_rule_slip_number
  where nr_sequencia = nr_sequencia_p

for update of dt_last_seq_reset, nr_current_seq;


BEGIN

  select max(ie_tipo_atendimento)
    into STRICT ie_tipo_atendimento_w
    from atendimento_paciente
  where nr_atendimento = nr_atendimento_p;

  for r_c_rule in c_rule loop
    nr_seq_cpoe_rule_slip_w := r_c_rule.nr_sequencia;
  end loop;


  if (nr_seq_cpoe_rule_slip_w IS NOT NULL AND nr_seq_cpoe_rule_slip_w::text <> '') then
    for rLin in C_Update( nr_seq_cpoe_rule_slip_w ) loop
       new_day_w := 'N';
       if (rLin.si_seq_restart_daily = 'S') and
          ( (rLin.dt_last_seq_reset < trunc(clock_timestamp(),'dd')) or (coalesce(rLin.dt_last_seq_reset::text, '') = '') ) then
         new_day_w := 'S';
       end if;
       if new_day_w = 'S' then
          nr_current_seq_w  := 1;
       else
         nr_current_seq_w  := rLin.nr_current_seq + 1;
       end if;
	
	   if (dt_start_p IS NOT NULL AND dt_start_p::text <> '') then
            dt_start_w := dt_start_p;
       else
            dt_start_w := clock_timestamp();
       end if;
	
       nr_order_unit_w := rLin.CD_PREFIXO_SLIP_NUMBER || TO_CHAR(dt_start_w, rLin.ds_timestamp_format)
                 || LPAD(nr_current_seq_w,LENGTH(rLin.qt_maximo), '0')
                 || rLin.ds_sufixo;

       if (new_day_w = 'S') then
          update  cpoe_rule_slip_number
              set nr_current_seq = 0,
                  dt_last_seq_reset = clock_timestamp()
          where current of C_Update;
        end if;

        update  cpoe_rule_slip_number
           set  nr_current_seq = nr_current_seq + 1
         where current of C_Update;
    end loop;
  end if;
  nr_order_unit_p := nr_order_unit_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_set_order_unit_number ( nr_seq_cpoe_tipo_pedido_p bigint, si_type_of_prescription_p text, nr_atendimento_p bigint, dt_start_p timestamp, nr_order_unit_p INOUT text) FROM PUBLIC;

