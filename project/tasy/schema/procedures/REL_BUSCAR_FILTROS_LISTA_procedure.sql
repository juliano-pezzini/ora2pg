-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rel_buscar_filtros_lista (ie_opcao_p text, ds_lista_p text, vl_dominio_p text, cd_perfil_p bigint, cd_funcao_p bigint, ie_perfil_p text, nr_seq_filtro_p bigint, cd_estabelecimento_p bigint, ds_filtro_p text, nm_filtro_p text, nm_usuario_p text) AS $body$
BEGIN


	if (ie_opcao_p = 'S') then

				
			insert into funcao_filtro(	
							nr_sequencia,
							nm_usuario,
							ie_tipo_filtro,
							ie_tipo_campo,
							dt_atualizacao,
							ds_filtro,
							ds_campo,
							cd_funcao,
							nr_seq_filtro,
							nm_usuario_ref,
							cd_perfil ,
							cd_estabelecimento,
							vl_campo,
							nm_filtro,
							dt_atualizacao_nrec,
							nm_usuario_nrec
							)
			values (
							nextval('funcao_filtro_seq'),
							nm_usuario_p,
							'D',
							'N',
							clock_timestamp(),
							coalesce(ds_filtro_p,''),
							SUBSTR(ds_lista_p, 1, 50),
							cd_funcao_p,
							nr_seq_filtro_p,
							nm_usuario_p,
							CASE WHEN ie_perfil_p='N' THEN '' WHEN ie_perfil_p='S' THEN cd_perfil_p WHEN ie_perfil_p='P' THEN cd_perfil_p END ,
							cd_estabelecimento_p,
							vl_dominio_p,
							coalesce(nm_filtro_p,''),
							clock_timestamp(),
							nm_usuario_p
							);
										
		
	elsif (ie_opcao_p = 'E') then
		
		if (ie_perfil_p = 'F') then
			
			delete from funcao_filtro
			where 	nm_usuario   = 	nm_usuario_p
			and  	cd_funcao   =	cd_funcao_p
			and  	nr_seq_filtro   =	nr_seq_filtro_p
			and 	coalesce(nm_filtro::text, '') = ''
			and 	coalesce(cd_perfil::text, '') = '';
			
		elsif (ie_perfil_p = 'A') then
			
			delete from funcao_filtro
			where 	nm_usuario   = 	nm_usuario_p
			and  	cd_funcao   =	cd_funcao_p
			and  	nr_seq_filtro   =	nr_seq_filtro_p;
	
		
		elsif (ie_perfil_p = 'N') then
			
			delete from funcao_filtro
			where 	nm_usuario   = 	nm_usuario_p
			and   	cd_estabelecimento = cd_estabelecimento_p		
			and  	cd_funcao   =	cd_funcao_p
			and 	coalesce(cd_perfil::text, '') = '';
			
		elsif (ie_perfil_p = 'I') then
		
			delete from funcao_filtro
			where 	nm_usuario   = 	nm_usuario_p
			and   	cd_estabelecimento = cd_estabelecimento_p		
			and  	cd_funcao   =	cd_funcao_p
			and 	ds_campo  = ds_lista_p
			and 	nm_filtro	= 	nm_filtro_p
			and 	coalesce(cd_perfil::text, '') = '';
			
		elsif (ie_perfil_p = 'P') then
		
			delete from funcao_filtro
			where 	nm_usuario   = 	nm_usuario_p
			and   	cd_estabelecimento = cd_estabelecimento_p		
			and  	cd_funcao   =	cd_funcao_p
			and 	ds_campo  = ds_lista_p
			and 	nm_filtro	= 	nm_filtro_p
			and 	cd_perfil = cd_perfil_p;
			
		else		
		
			delete from funcao_filtro
			where 	nm_usuario   	= 	nm_usuario_p
			and   	cd_estabelecimento = 	cd_estabelecimento_p		
			and  	cd_funcao   	=	cd_funcao_p
			and 	nm_filtro	= 	nm_filtro_p
			and 	(cd_perfil IS NOT NULL AND cd_perfil::text <> '');
		
		end if;

	end if;
	
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rel_buscar_filtros_lista (ie_opcao_p text, ds_lista_p text, vl_dominio_p text, cd_perfil_p bigint, cd_funcao_p bigint, ie_perfil_p text, nr_seq_filtro_p bigint, cd_estabelecimento_p bigint, ds_filtro_p text, nm_filtro_p text, nm_usuario_p text) FROM PUBLIC;

