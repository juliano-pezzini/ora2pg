-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE spa_duplicar ( nr_seq_spa_p bigint, cd_responsavel_p text, cd_solicitante_p text, cd_centro_custo_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_spa_w		bigint;
nr_seq_movimento_w	bigint;
nr_seq_mov_novo_w	bigint;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	spa_movimento
	where	nr_seq_spa = nr_seq_spa_p;


BEGIN

if (nr_seq_spa_p IS NOT NULL AND nr_seq_spa_p::text <> '') then

	select	nextval('spa_seq')
	into STRICT	nr_seq_spa_w
	;

	insert into spa(
		nr_sequencia, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, dt_spa, cd_responsavel, cd_solicitante,
		cd_centro_custo, ie_tipo_convenio, nr_seq_tipo, nr_seq_motivo, ie_status, ds_observacao, nr_seq_spa_origem)
	SELECT	nr_seq_spa_w, clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p, clock_timestamp(), cd_responsavel_p, cd_solicitante_p,
		cd_centro_custo_p, ie_tipo_convenio, nr_seq_tipo, nr_seq_motivo, 1, ds_observacao, nr_seq_spa_p
	from	spa
	where	nr_sequencia = nr_seq_spa_p;

	open C01;
	loop
	fetch C01 into
		nr_seq_movimento_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		select	nextval('spa_movimento_seq')
		into STRICT	nr_seq_mov_novo_w
		;

		insert into spa_movimento(
			nr_sequencia, nr_seq_spa, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, cd_classificacao, nr_atendimento,
			nr_interno_conta, nr_titulo, nr_nota_fiscal, nr_seq_nf, dt_contabil)
		SELECT	nr_seq_mov_novo_w, nr_seq_spa_w, clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p, cd_classificacao, nr_atendimento,
			nr_interno_conta, nr_titulo, nr_nota_fiscal, nr_seq_nf, dt_contabil
		from	spa_movimento
		where	nr_sequencia = nr_seq_movimento_w;

		insert into spa_movimento_item(
			nr_sequencia, nr_seq_movimento, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_item, ie_tipo_item)
		SELECT	nextval('spa_movimento_item_seq'), nr_seq_mov_novo_w, clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p, nr_seq_item, ie_tipo_item
		from	spa_movimento_item
		where	nr_seq_movimento = nr_seq_movimento_w;

		end;
	end loop;
	close C01;

	insert into spa_negociacao(
		nr_sequencia, nr_seq_spa, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, cd_forma_negociacao,
		vl_negociado, pr_juros)
	SELECT	nextval('spa_negociacao_seq'), nr_seq_spa_w, clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p, cd_forma_negociacao,
		vl_negociado, pr_juros
	from	spa_negociacao
	where	nr_seq_spa = nr_seq_spa_p;
end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE spa_duplicar ( nr_seq_spa_p bigint, cd_responsavel_p text, cd_solicitante_p text, cd_centro_custo_p bigint, nm_usuario_p text) FROM PUBLIC;

