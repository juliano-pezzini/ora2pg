-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rop_gerar_ajuste_inventario ( nr_sequencia_p bigint, cd_local_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_movto_entrada_p INOUT bigint, nr_movto_saida_p INOUT bigint) AS $body$
DECLARE

 
nr_seq_roupa_w		bigint;
qt_contagem_w		integer;
ds_historico_w		varchar(4000);
qt_roupa_w		double precision;
nr_seq_kit_w		bigint;
nr_movto_entrada_w	bigint := 0;
nr_movto_saida_w		bigint := 0;
qt_inventario_w		integer;
cd_operacao_entrada_w	bigint;
cd_operacao_saida_w	bigint;

c01 CURSOR FOR 
SELECT	nr_seq_roupa, 
	sum(qt_contagem) 
from (	SELECT	nr_seq_roupa, 
		qt_contagem 
	from	rop_inv_ajuste_roupa 
	where	nr_seq_inventario = nr_sequencia_p 
	and	(nr_seq_roupa IS NOT NULL AND nr_seq_roupa::text <> '') 
	
union all
 
	select	c.nr_seq_roupa, 
		(a.qt_contagem * c.qt_roupa) 
	from	rop_inv_ajuste_roupa a, 
		rop_kit_rouparia b, 
		rop_componente_kit c 
	where	a.nr_seq_kit = b.nr_sequencia 
	and	c.nr_seq_kit = b.nr_sequencia 
	and	nr_seq_inventario = nr_sequencia_p 
	and	(a.nr_seq_kit IS NOT NULL AND a.nr_seq_kit::text <> '')) alias4 
group by	nr_seq_roupa;


BEGIN 
 
select	coalesce(max(nr_sequencia),0) 
into STRICT	cd_operacao_entrada_w 
from	rop_operacao 
where	ie_situacao = 'A' 
and	ie_entrada_saida = 'E' 
and	ie_tipo_operacao = '2';
 
select	coalesce(max(nr_sequencia),0) 
into STRICT	cd_operacao_saida_w 
from	rop_operacao 
where	ie_situacao = 'A' 
and	ie_entrada_saida = 'S' 
and	ie_tipo_operacao = '2';
 
open C01;
loop 
fetch C01 into	 
	nr_seq_roupa_w, 
	qt_contagem_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	select	coalesce(qt_roupa,0) 
	into STRICT	qt_roupa_w 
	from	rop_roupa 
	where	nr_sequencia = nr_seq_roupa_w;
	 
	if (qt_contagem_w <> qt_roupa_w) then 
	 
		update	rop_roupa 
		set	qt_roupa = qt_contagem_w 
		where	nr_sequencia = nr_seq_roupa_w;
		 
		/*Gera movimento inventario entrada*/
 
		if (qt_contagem_w > qt_roupa_w) and (cd_operacao_entrada_w > 0) and (cd_local_p > 0) then		 
			 
			qt_inventario_w := qt_contagem_w - qt_roupa_w;
 
			nr_movto_entrada_w := rop_gerar_movto_inv_entrada( 
				nr_sequencia_p, nr_seq_roupa_w, qt_inventario_w, cd_local_p, cd_operacao_entrada_w, cd_estabelecimento_p, nm_usuario_p, nr_movto_entrada_w);		
		 
		/*Gera movimento inventario saida*/
 
		elsif (qt_contagem_w < qt_roupa_w) and (cd_operacao_saida_w > 0) and (cd_local_p > 0) then 
			 
			qt_inventario_w := qt_roupa_w - qt_contagem_w;
 
			nr_movto_saida_w := rop_gerar_movto_inv_saida( 
				nr_sequencia_p, nr_seq_roupa_w, qt_inventario_w, cd_local_p, cd_operacao_saida_w, cd_estabelecimento_p, nm_usuario_p, nr_movto_saida_w);		
		 
		 
		end if;		
		 
		ds_historico_w	:= 	substr(wheb_mensagem_pck.get_texto(802069,'NR_SEQUENCIA_P='|| NR_SEQUENCIA_P ||';QT_ROUPA_W='|| coalesce(QT_ROUPA_W,0) || ';QT_CONTAGEM_W='|| QT_CONTAGEM_W),1,4000);
 
		insert into rop_roupa_hist( 
			nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			nr_seq_roupa, 
			dt_historico, 
			ds_titulo, 
			ds_historico, 
			ie_tipo, 
			dt_liberacao, 
			nm_usuario_lib) 
		values (	nextval('rop_roupa_hist_seq'), 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			nr_seq_roupa_w, 
			clock_timestamp(), 
			wheb_mensagem_pck.get_Texto(802104), 
			ds_historico_w, 
			'S', 
			clock_timestamp(), 
			nm_usuario_p);
	end if;	
	end;
end loop;
close C01;
 
update	rop_inventario_ajuste 
set	dt_ajuste		= clock_timestamp(), 
	nm_usuario_ajuste	= nm_usuario_p 
where	nr_sequencia	= nr_sequencia_p;
 
commit;
 
nr_movto_entrada_p	:= coalesce(nr_movto_entrada_w,0);
nr_movto_saida_p	:= coalesce(nr_movto_saida_w,0);
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rop_gerar_ajuste_inventario ( nr_sequencia_p bigint, cd_local_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_movto_entrada_p INOUT bigint, nr_movto_saida_p INOUT bigint) FROM PUBLIC;

