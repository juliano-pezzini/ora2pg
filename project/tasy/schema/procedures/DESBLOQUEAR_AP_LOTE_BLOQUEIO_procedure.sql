-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desbloquear_ap_lote_bloqueio ( nr_seq_lote_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE



nr_sequencia_w		bigint;
ie_pais_w	valor_dominio.vl_dominio%type;
ie_manual_hold_w ap_lote_bloqueio.IE_MANUAL_HOLD_BY_USER%type;

/*
This procedure unlocks the batch for the user.
Used after the user unfolds a batch ... and with that he can use the right mouse to unlock.
In Delphi this action (mandatorily) clears the screen and unlocks the batch for service (NO PDA or Tasy itself)
*/
BEGIN

select	coalesce(max(nr_sequencia), 0)
into STRICT	nr_sequencia_w
from	ap_lote_bloqueio
where	nm_usuario	= nm_usuario_p
and	nr_seq_lote	= nr_seq_lote_p;

if (nr_sequencia_w > 0) then

	delete
	from	ap_lote_bloqueio
	where	nr_sequencia	= nr_sequencia_w;

	commit;

end if;

begin
  ie_pais_w	:=	coalesce(pkg_i18n.get_user_locale, 'pt_BR');

  if (ie_pais_w = 'en_AU') then

    select	coalesce(max(nr_sequencia), 0) , coalesce(max(IE_MANUAL_HOLD_BY_USER),'N')
      into STRICT	nr_sequencia_w, ie_manual_hold_w
      from	ap_lote_bloqueio
      where	nr_seq_lote	= nr_seq_lote_p;

    if (nr_sequencia_w > 0 and ie_manual_hold_w = 'S') then

      delete
        from	ap_lote_bloqueio
        where	nr_sequencia	= nr_sequencia_w;

    commit;

    end if;
  end if;

exception when others then
  null;
end;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desbloquear_ap_lote_bloqueio ( nr_seq_lote_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

