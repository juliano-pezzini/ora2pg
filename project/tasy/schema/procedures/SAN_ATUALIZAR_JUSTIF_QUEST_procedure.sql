-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_atualizar_justif_quest ( nr_seq_doacao_p bigint, nr_seq_impedimento_p bigint, ds_justificativa_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

ie_pergunta_w	varchar(1);
ie_novo_questionario_w	varchar(1) := 'N';


BEGIN

Select 	max(ie_novo_questionario)
into STRICT	ie_novo_questionario_w
from 	san_parametro
where 	cd_estabelecimento = cd_estabelecimento_p;

IF (nr_seq_doacao_p IS NOT NULL AND nr_seq_doacao_p::text <> '') THEN

	if (ie_novo_questionario_w = 'S') then

		update	san_questionario
		set	ds_justificativa 	= ds_justificativa_p
		where	nr_seq_impedimento 	= nr_seq_impedimento_p
		and	nr_seq_doacao		= nr_seq_doacao_p;

	else

		SELECT  coalesce(MAX(ie_pergunta),'N')
		INTO STRICT	ie_pergunta_w
		FROM	san_impedimento
		WHERE	nr_sequencia	= nr_seq_impedimento_p;

		IF (ie_pergunta_w = 'S') THEN

			UPDATE	san_doacao_questionario
			SET	ds_justificativa	= ds_justificativa_p,
				dt_atualizacao		= clock_timestamp(),
				nm_usuario		= nm_usuario_p
			WHERE	nr_seq_pergunta		= nr_seq_impedimento_p
			AND	nr_seq_doacao		= nr_seq_doacao_p;
		ELSE
			UPDATE	san_doacao_impedimento
			SET	ds_justificativa	= ds_justificativa_p,
				dt_atualizacao		= clock_timestamp(),
				nm_usuario		= nm_usuario_p
			WHERE	nr_seq_impedimento	= nr_seq_impedimento_p
			AND	nr_seq_doacao		= nr_seq_doacao_p;
		END IF;
	end if;
END IF;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_atualizar_justif_quest ( nr_seq_doacao_p bigint, nr_seq_impedimento_p bigint, ds_justificativa_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

