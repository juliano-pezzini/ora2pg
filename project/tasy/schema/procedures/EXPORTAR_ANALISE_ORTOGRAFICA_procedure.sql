-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE exportar_analise_ortografica ( nr_seq_lote_p bigint, nm_usuario_p text, ds_diretorio_p text, ds_arquivo_p text) AS $body$
DECLARE


/*

o arquivo é gravado em \\192.168.0.230\UTLFILE\

>10<	Quebra de linha chr(10)
>13<	Quebra de linha chr(13)
>PV<	Ponto-e-vírgula (;)
>CL<	Continua na próxima linha

*/
ds_erro_w		varchar(255);
ds_local_w		varchar(255);
arq_texto_w		utl_file.file_type;
ds_conteudo_w		varchar(32000);
ds_arquivo_w		varchar(255);
ds_inconsistencia_w	varchar(255);
ds_lista_analise_w	varchar(255);
nr_seq_analise_w	bigint;
ds_conteudo_arq_w	varchar(1022);
nr_caracter_w		bigint;

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.nm_tabela_origem || ';' ||
	a.ds_form || ';' ||
	a.ds_campo || ';' ||
	replace(replace(replace(a.ds_conteudo_campo,chr(10),'>10<'),chr(13),'>13<'),';','>PV<') || ';' ||
	a.ds_campo_pai || ';' ||
	a.nm_tabela || ';' ||
	a.nm_atributo || ';' ||
	a.nr_seq_visao || ';' ||
	a.nr_seq_objeto || ';' ||
	a.nr_seq_obj_filtro || ';' ||
	a.nr_seq_cor || ';' ||
	a.cd_dominio || ';' ||
	a.vl_dominio || ';' ||
	a.nm_usuario_origem || ';' ||
	a.nr_seq_lote || ';' ||
	a.cd_funcao || ';' ||
	a.nr_seq_parametro || ';' ||
	a.nr_seq_relatorio || ';' ||
	a.nr_seq_campo_relat || ';' ||
	a.nr_seq_param_relat || ';' ||
	a.ds_classe_objeto || ';' ||
	a.ds_nome_objeto || ';' ||
	a.ds_metodo || ';' ||
	a.nr_parametro || ';' ||
	a.nr_ocorrencia || ';' ||
	a.nr_seq_ind_gestao || ';' ||
	a.nr_seq_ind_gestao_atrib || ';' ||
	a.nr_seq_subind_gestao || ';' ||
	a.nr_seq_subind_gestao_atrib || ';' ||
	a.cd_interface || ';' ||
	a.nr_seq_referencia || ';' ||
	a.cd_tipo_lote_contabil || ';' ||
	a.cd_expressao || ';' ||
	to_char(a.dt_origem,'ddmmyyyyhh24miss')
from	analise_ortografica a
where	a.nr_seq_lote	= nr_seq_lote_p
order by	a.nr_sequencia;


BEGIN

SELECT * FROM obter_evento_utl_file(1, null, ds_local_w, ds_erro_w) INTO STRICT ds_local_w, ds_erro_w;

begin

	if (coalesce(ds_arquivo_p::text, '') = '') then
		ds_arquivo_w	:= 'Lote_' || nr_seq_lote_p || '_' || nm_usuario_p || '_' || to_char(clock_timestamp(),'ddmmyyyy') || '.csv';
	else
		ds_arquivo_w	:= ds_arquivo_p;
	end if;

	arq_texto_w	:= utl_file.fopen(ds_local_w,ds_arquivo_w,'W');

exception
when others then

	CALL wheb_mensagem_pck.exibir_mensagem_abort(251791,'DS_ERRO_W='||ds_erro_w);

end;

open	c01;
loop
fetch	c01 into
	nr_seq_analise_w,
	ds_conteudo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	nr_caracter_w	:= 1;

	/* cada linha suporta, no máximo, 1022 caracteres */

	if (length(ds_conteudo_w) > 1022) then

		while	(coalesce(nr_caracter_w,0)	< (length(ds_conteudo_w) - coalesce(nr_caracter_w,0) - 1)) loop

			ds_conteudo_arq_w	:= substr(ds_conteudo_w,coalesce(nr_caracter_w,0),1018) || '>CL<';

			nr_caracter_w		:= coalesce(nr_caracter_w,0) + 1018;

			utl_file.put_line(arq_texto_w,ds_conteudo_arq_w || chr(13));
			utl_file.fflush(arq_texto_w);

		end loop;

	end if;

	ds_conteudo_arq_w	:= substr(ds_conteudo_w,coalesce(nr_caracter_w,0),length(ds_conteudo_w));

	if ((trim(both ds_conteudo_arq_w) IS NOT NULL AND (trim(both ds_conteudo_arq_w))::text <> '')) then

		utl_file.put_line(arq_texto_w,ds_conteudo_arq_w || chr(13));
		utl_file.fflush(arq_texto_w);

	end if;

end	loop;
close	c01;

update	analise_ortografica_lote
set	ds_arquivo	= CASE WHEN ds_diretorio_p = NULL THEN '\\192.168.0.230\UTLFILE\'  ELSE ds_diretorio_p END  || ds_arquivo_w,
	dt_exportacao	= clock_timestamp(),
	dt_atualizacao	= clock_timestamp(),
	nm_usuario	= nm_usuario_p
where	nr_sequencia	= nr_seq_lote_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE exportar_analise_ortografica ( nr_seq_lote_p bigint, nm_usuario_p text, ds_diretorio_p text, ds_arquivo_p text) FROM PUBLIC;

