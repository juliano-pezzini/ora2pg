-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pagar_glosa_total ( vl_saldo_p bigint, vl_glosa_informada_p bigint, nr_seq_item_p bigint, nm_usuario_p text, cd_motivo_glosa_p bigint default null, ie_acao_glosa_p text default null, ie_remove_motivo_acao_p text default 'N') AS $body$
DECLARE


cd_motivo_tiss_p varchar(10);


BEGIN

if (cd_motivo_glosa_p IS NOT NULL AND cd_motivo_glosa_p::text <> '') then
	select 	max(cd_motivo_tiss)
	into STRICT 	cd_motivo_tiss_p
	from 	tiss_motivo_glosa
	where 	cd_motivo_glosa = cd_motivo_glosa_p;

end if;

if (vl_saldo_p IS NOT NULL AND vl_saldo_p::text <> '') and (vl_glosa_informada_p IS NOT NULL AND vl_glosa_informada_p::text <> '') and (nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '') then
	begin
	update	lote_audit_hist_item
	set	vl_glosa_informada	= vl_glosa_informada_p,
		vl_pago			= vl_saldo_p,
		vl_glosa			= 0,
		vl_amenor		= 0,
		cd_motivo_glosa_tiss	= CASE WHEN ie_remove_motivo_acao_p='S' THEN cd_motivo_tiss_p  ELSE coalesce(cd_motivo_tiss_p,cd_motivo_glosa_tiss) END ,
		cd_motivo_glosa 		= CASE WHEN ie_remove_motivo_acao_p='S' THEN cd_motivo_glosa_p  ELSE coalesce(cd_motivo_glosa_p,cd_motivo_glosa) END ,
		ie_acao_glosa		= CASE WHEN ie_remove_motivo_acao_p='S' THEN ie_acao_glosa_p  ELSE coalesce(ie_acao_glosa_p,ie_acao_glosa) END ,
		nm_usuario		= nm_usuario_p,
		dt_atualizacao 		= clock_timestamp()
	where	nr_sequencia		= nr_seq_item_p;
	end;
end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pagar_glosa_total ( vl_saldo_p bigint, vl_glosa_informada_p bigint, nr_seq_item_p bigint, nm_usuario_p text, cd_motivo_glosa_p bigint default null, ie_acao_glosa_p text default null, ie_remove_motivo_acao_p text default 'N') FROM PUBLIC;

