-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE carregar_filtro_regra_mdx ((ds_plataforma_p text, cd_perfil_p bigint, nm_usuario_p text) is cd_funcao_w bigint DEFAULT null) RETURNS varchar AS $body$
DECLARE
	
	ds_valor_w	varchar(2);

BEGIN
	ds_valor_w := coalesce(dsValor_p, 'S');
	if (upper(ds_plataforma_p) = 'JAVA' or upper(ds_plataforma_p) = 'ANGULAR') then
		return ds_valor_w;
	else
		if (upper(ds_valor_w) = 'S') then
			return '-1';
		else
			return '0';
		end if;
	end if;
end;

function get_severity(dsValor_p varchar2) return varchar is	
begin
	if (upper(ds_plataforma_p) = 'JAVA') then
		return dsValor_p;
	else
		CASE dsValor_p
		WHEN 'CONTRAINDICATED' THEN return '0';
		WHEN 'MAJOR' THEN return '1';
		WHEN 'MODERATE' THEN return '2';
		WHEN 'MINOR' THEN return '3';
		WHEN 'UNKNOWN' THEN return '4';
		ELSE return '4';
		END CASE;
	end if;
end;

function get_documentation(dsValor_p varchar2) return varchar is	
begin
	if (upper(ds_plataforma_p) = 'JAVA') then
		return dsValor_p;
	else
		CASE dsValor_p
		WHEN 'EXCELLENT' THEN return '0';
		WHEN 'GOOD' THEN return '1';
		WHEN 'FAIR' THEN return '2';
		WHEN 'UNKNOWN' THEN return '3';			
		ELSE return '3';
		END CASE;
	end if;
end;

procedure insert_filters is
begin
    CALL inserir_funcao_filtro(cd_funcao_w, 'IE_SEVERITY', ds_filtro_w, nr_seq_filtro_w, get_severity(ie_severity_w), cd_perfil_p, cd_estabelecimento_w, nm_usuario_p);
	CALL inserir_funcao_filtro(cd_funcao_w, 'IE_DOCUMENTATION', ds_filtro_w, nr_seq_filtro_w, get_documentation(ie_documentation_w), cd_perfil_p, cd_estabelecimento_w, nm_usuario_p);
	CALL inserir_funcao_filtro(cd_funcao_w, 'DRUG', ds_filtro_w, nr_seq_filtro_w, get_valor(ie_drug_w), cd_perfil_p, cd_estabelecimento_w, nm_usuario_p);
	CALL inserir_funcao_filtro(cd_funcao_w, 'ETHANOL', ds_filtro_w, nr_seq_filtro_w, get_valor(ie_ethanol_w), cd_perfil_p, cd_estabelecimento_w, nm_usuario_p);
	CALL inserir_funcao_filtro(cd_funcao_w, 'FOOD', ds_filtro_w, nr_seq_filtro_w, get_valor(ie_food_w), cd_perfil_p, cd_estabelecimento_w, nm_usuario_p);
	CALL inserir_funcao_filtro(cd_funcao_w, 'LAB', ds_filtro_w, nr_seq_filtro_w, get_valor(ie_lab_w), cd_perfil_p, cd_estabelecimento_w, nm_usuario_p);
	CALL inserir_funcao_filtro(cd_funcao_w, 'TOBACCO', ds_filtro_w, nr_seq_filtro_w, get_valor(ie_tobacco_w), cd_perfil_p, cd_estabelecimento_w, nm_usuario_p);
	CALL inserir_funcao_filtro(cd_funcao_w, 'DISEASE', ds_filtro_w, nr_seq_filtro_w, get_valor(ie_disease_w), cd_perfil_p, cd_estabelecimento_w, nm_usuario_p);
	CALL inserir_funcao_filtro(cd_funcao_w, 'ALLERGY', ds_filtro_w, nr_seq_filtro_w, get_valor(ie_allergy_w), cd_perfil_p, cd_estabelecimento_w, nm_usuario_p);
	CALL inserir_funcao_filtro(cd_funcao_w, 'PREGNANCY', ds_filtro_w, nr_seq_filtro_w, get_valor(ie_pregnancy_w), cd_perfil_p, cd_estabelecimento_w, nm_usuario_p);
	CALL inserir_funcao_filtro(cd_funcao_w, 'LACTATION', ds_filtro_w, nr_seq_filtro_w, get_valor(ie_lactation_w), cd_perfil_p, cd_estabelecimento_w, nm_usuario_p);
	CALL inserir_funcao_filtro(cd_funcao_w, 'PRECAUTIONS', ds_filtro_w, nr_seq_filtro_w, get_valor(ie_precautions_w), cd_perfil_p, cd_estabelecimento_w, nm_usuario_p);
	CALL inserir_funcao_filtro(cd_funcao_w, 'TC_DUPLICATION', ds_filtro_w, nr_seq_filtro_w, get_valor(ie_tc_duplication_w), cd_perfil_p, cd_estabelecimento_w, nm_usuario_p);
	CALL inserir_funcao_filtro(cd_funcao_w, 'ANTAGONISM', ds_filtro_w, nr_seq_filtro_w, get_valor(ie_antagonism_w), cd_perfil_p, cd_estabelecimento_w, nm_usuario_p);
	CALL inserir_funcao_filtro(cd_funcao_w, 'INGREDIENT_DUPLICATION', ds_filtro_w, nr_seq_filtro_w, get_valor(ie_ingredient_duplication_w), cd_perfil_p, cd_estabelecimento_w, nm_usuario_p);
	CALL inserir_funcao_filtro(cd_funcao_w, 'PROXY_DISEASE', ds_filtro_w, nr_seq_filtro_w, get_valor(ie_proxy_disease_w), cd_perfil_p, cd_estabelecimento_w, nm_usuario_p);
	CALL inserir_funcao_filtro(cd_funcao_w, 'PATIENT_DISEASE', ds_filtro_w, nr_seq_filtro_w, get_valor(ie_patient_disease_w), cd_perfil_p, cd_estabelecimento_w, nm_usuario_p);
end;
begin

if (upper(ds_plataforma_p) = 'JAVA') then
	nr_seq_filtro_w := 351664;
	cd_funcao_w := 6201;
	select count(nr_sequencia)
	into STRICT 	qt_registros_w
	from   funcao_filtro
	where  cd_funcao       = cd_funcao_w  
	and    nr_seq_filtro   = nr_seq_filtro_w
	and    nm_usuario_ref  = nm_usuario_p;
	ds_filtro_w := 'WFILTRO_6201_351664';
else if (upper(ds_plataforma_p) = 'ANGULAR') then
	nr_seq_filtro_w := 1097598;
	cd_funcao_w := 258;
	select count(nr_sequencia)
	into STRICT 	qt_registros_w
	from   funcao_filtro
	where  cd_funcao       = cd_funcao_w
	and    nr_seq_filtro   = nr_seq_filtro_w
	and    nm_usuario_ref  = nm_usuario_p;
	ds_filtro_w := 'WFILTRO_6201_1097598';
else
	cd_funcao_w := 6201;
	select count(nr_sequencia)
	into STRICT 	qt_registros_w
	from   funcao_filtro
	where  cd_funcao       = cd_funcao_w
	and    coalesce(nr_seq_filtro::text, '') = ''
	and    nm_usuario_ref  = nm_usuario_p;
	
	cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
	ds_filtro_w := 'micromedexWF';
end if;
end if;

open c01;
	loop
		fetch c01 into
			ie_severity_w,
			ie_documentation_w,
			ie_drug_w,
			ie_ethanol_w,
			ie_food_w,
			ie_lab_w,
			ie_tobacco_w,
			ie_disease_w,
			ie_allergy_w,
			ie_pregnancy_w,
			ie_lactation_w,
			ie_precautions_w,
			ie_tc_duplication_w,
			ie_antagonism_w,
			ie_ingredient_duplication_w,
			ie_proxy_disease_w,
			ie_patient_disease_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */	
			ie_possui_regra := true;
	end loop;
  close c01;

if (coalesce(qt_registros_w, 0) = 0) then  
	if (ie_possui_regra) then
		insert_filters;
	end if;
 else
  begin
    delete from funcao_filtro where nr_seq_filtro = nr_seq_filtro_w and nm_usuario_ref = nm_usuario_p and cd_funcao = cd_funcao_w;
    insert_filters;
  end;
end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE carregar_filtro_regra_mdx ((ds_plataforma_p text, cd_perfil_p bigint, nm_usuario_p text) is cd_funcao_w bigint DEFAULT null) FROM PUBLIC;

