-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calc_dt_real_etapa_prot_int (nr_seq_etapa_p bigint) AS $body$
DECLARE


dt_inicial_previsto_w timestamp;

dt_inicial_real_w timestamp;

dt_final_real_w timestamp;

dt_real_w timestamp;

nr_intervalo_dias_w bigint;

nr_dias_previsto_w bigint;

nr_dias_atraso_w bigint;

qt_eventos_pendentes_w bigint;

nr_seq_protocolo_int_pac_w bigint;


BEGIN

    select min(DT_REAL)
    into STRICT dt_inicial_real_w
    from PROTOCOLO_INT_PAC_EVENTO
    where nr_seq_prt_int_pac_etapa = nr_seq_etapa_p;

    select max(DT_REAL)
    into STRICT dt_final_real_w
    from PROTOCOLO_INT_PAC_EVENTO
    where nr_seq_prt_int_pac_etapa = nr_seq_etapa_p;

    select count(*)
    into STRICT qt_eventos_pendentes_w
    from PROTOCOLO_INT_PAC_EVENTO
    where coalesce(dt_real::text, '') = ''
    and nr_seq_prt_int_pac_etapa = nr_seq_etapa_p;

    update PROTOCOLO_INT_PAC_ETAPA set dt_inicial_real = dt_inicial_real_w where nr_sequencia = nr_seq_etapa_p;

    select dt_inicial_previsto,
           nr_dias_previsto,
           nr_seq_protocolo_int_pac
    into STRICT dt_inicial_previsto_w,
         nr_dias_previsto_w,
         nr_seq_protocolo_int_pac_w
    from PROTOCOLO_INT_PAC_ETAPA
    where nr_sequencia = nr_seq_etapa_p;

    if (qt_eventos_pendentes_w = 0) then

        if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'ja_JP') then
          nr_intervalo_dias_w := trunc(dt_final_real_w,'dd') - trunc(dt_inicial_real_w,'dd') + 1;
          nr_dias_atraso_w := trunc(dt_inicial_real_w,'dd') - trunc(dt_inicial_previsto_w,'dd');
        else
          nr_intervalo_dias_w := dt_final_real_w - dt_inicial_previsto_w + 1;
          nr_dias_atraso_w := nr_intervalo_dias_w - nr_dias_previsto_w;
        end if;

        update PROTOCOLO_INT_PAC_ETAPA
        set dt_final_real = dt_final_real_w,
            nr_dias_real = nr_intervalo_dias_w,
            nr_dias_atraso = nr_dias_atraso_w
        where nr_sequencia = nr_seq_etapa_p;

    else

        update PROTOCOLO_INT_PAC_ETAPA
        set dt_final_real  = NULL,
            nr_dias_real  = NULL,
            nr_dias_atraso  = NULL
        where nr_sequencia = nr_seq_etapa_p;
    end if;
    commit;
            
    CALL update_dt_real_prot_int_pac(nr_seq_protocolo_int_pac_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calc_dt_real_etapa_prot_int (nr_seq_etapa_p bigint) FROM PUBLIC;

