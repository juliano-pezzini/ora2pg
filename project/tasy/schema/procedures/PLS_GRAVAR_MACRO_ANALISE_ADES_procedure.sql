-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gravar_macro_analise_ades ( nr_seq_entr_analise_p bigint, nr_seq_texto_analise_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_analise_w		bigint;
ds_texto_analise_w		varchar(4000);
ds_texto_w              	text;
ds_texto_alterado_w     	text;
pos_macro_w             	bigint;
ds_macro_w              	varchar(100);
nm_atributo_w           	varchar(50);
pos_fim_macro_w         	bigint;
ds_resultado_macro_w    	varchar(255);



BEGIN

select	nr_seq_analise
into STRICT	nr_seq_analise_w
from	pls_entrevista_analise
where	nr_sequencia	= nr_seq_entr_analise_p;

select	ds_texto
into STRICT	ds_texto_analise_w
from	pls_analise_texto_padrao
where	nr_sequencia = nr_seq_texto_analise_p;

if (ds_texto_analise_w IS NOT NULL AND ds_texto_analise_w::text <> '') then
	ds_texto_w		:= ds_texto_analise_w;
	ds_texto_alterado_w	:= ds_texto_w;
	WHILE(ds_texto_w IS NOT NULL AND ds_texto_w::text <> '') LOOP
                begin

		begin
		PERFORM  replace(replace(ds_texto_w,'\',' '),chr(13) || chr(10),' ') -- ' comentário adicionado para que o restante não fique vermelho
		into    ds_texto_w
		from    dual;
		exception
		when others then
			wheb_mensagem_pck.exibir_mensagem_abort(262319, 'DS_TEXTO=' || length(ds_texto_w));
			/* Mensagem: DS_TEXTO */

		end;

		select  instr(ds_texto_w,'@')
                into    pos_macro_w
                from    dual;

		if (pos_macro_w > 0) then
			select  substr(ds_texto_w,pos_macro_w,length(ds_texto_w))
                        into    ds_texto_w
                        from    dual;

                        select  instr(replace(ds_texto_w,chr(10),' '),' ')
			into    pos_fim_macro_w
			from    dual;

                        select  Elimina_Caracteres_Especiais(substr(ds_texto_w,1,pos_fim_macro_w -1))
                        into    ds_macro_w
                        from    dual;

			ds_macro_w	:= replace(ds_macro_w,'}','');

                        if (nvl(ds_macro_w,null) is not null) then
				begin
				select  nm_atributo
                                into    nm_atributo_w
                                from    PLS_MACRO_ANALISE_ADESAO
                                where   upper(ds_macro) = upper(ds_macro_w);
                                exception
                                when others then
                                        nm_atributo_w := null;
                                end;

                                if (nvl(nm_atributo_w,null) is not null) then

                                        select  pls_subst_macro_analise_adesao(upper(ds_macro_w), nm_atributo_w, nr_seq_analise_w)
					into    ds_resultado_macro_w
					from    dual;

					begin
                                        select  replace(ds_texto_alterado_w, ds_macro_w, ds_resultado_macro_w)
                                        into    ds_texto_alterado_w
                                        from    dual;
					exception
					when others then
						wheb_mensagem_pck.exibir_mensagem_abort(262320, 'DS_TEXTO_ALTERADO=' || length(ds_texto_alterado_w) || ';DS_MACRO=' || length(ds_macro_w) || ';DS_RESULTADO_MACRO=' || length(ds_resultado_macro_w));
						/* Mensagem: DS_TEXTO_ALTERADO DS_MACRO DS_RESULTADO_MACRO */

					end;
                                end if;
                        end if;

                        select  substr(ds_texto_w,pos_fim_macro_w, length(ds_texto_w))
                        into STRICT    ds_texto_w
;
                else
                        ds_texto_w := '';
                end if;
                end;
        END loop;

	if (ds_texto_alterado_w IS NOT NULL AND ds_texto_alterado_w::text <> '') then
		update	pls_entrevista_analise
		set	DS_ANALISE	= ds_texto_alterado_w
		where	nr_sequencia	= nr_seq_entr_analise_p;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gravar_macro_analise_ades ( nr_seq_entr_analise_p bigint, nr_seq_texto_analise_p bigint, nm_usuario_p text) FROM PUBLIC;

