-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_diagnostico_inf_oftalmo ( nr_seq_consulta_p bigint, cd_pessoa_p text, nm_usuario_p text, ie_paciente_p text, cd_profissional_p text, ds_lista_diagnosticos_p text, ie_libera_p text default null, nr_atendimento_p bigint default null) AS $body$
DECLARE


dt_fim_w		timestamp;
dt_inicio_w		timestamp;
nr_seq_diag_w		bigint;
qt_controle_w		bigint;
qt_tam_lista_w		bigint;
ie_pos_sep_atrib_w 	bigint;
ie_pos_separador_w	bigint;
ie_olho_w		varchar(1);
ie_gera_diagnostico_w varchar(1);
ds_observacao_w		varchar(255);
ds_lista_atrib_w	varchar(1000);
ds_lista_diagnosticos_w varchar(10000);
nr_seq_parentesco_w	bigint;


BEGIN
if (nr_seq_consulta_p IS NOT NULL AND nr_seq_consulta_p::text <> '') and (cd_pessoa_p IS NOT NULL AND cd_pessoa_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') and (ie_paciente_p IS NOT NULL AND ie_paciente_p::text <> '') and (cd_profissional_p IS NOT NULL AND cd_profissional_p::text <> '') and (ds_lista_diagnosticos_p IS NOT NULL AND ds_lista_diagnosticos_p::text <> '') then
	begin

	ie_gera_diagnostico_w	:= coalesce(obter_valor_param_usuario(3010,10,obter_perfil_ativo,nm_usuario_p,0),'N');

	ds_lista_diagnosticos_w := ds_lista_diagnosticos_p||'-';
	qt_controle_w		:= 0;
	while(ds_lista_diagnosticos_w IS NOT NULL AND ds_lista_diagnosticos_w::text <> '') and (qt_controle_w < 100) and (length(ds_lista_atrib_w||' ')) < 900 loop
		begin
		qt_controle_w		:= qt_controle_w + 1;
		qt_tam_lista_w 		:= length(ds_lista_diagnosticos_w);
		ie_pos_sep_atrib_w 	:= position('#' in ds_lista_diagnosticos_w);

		if (ie_pos_sep_atrib_w > 0) then
			begin
			ds_lista_atrib_w := substr(ds_lista_diagnosticos_w, 1,(ie_pos_sep_atrib_w - 1));
			ds_lista_diagnosticos_w := substr(ds_lista_diagnosticos_w, (ie_pos_sep_atrib_w + 1), qt_tam_lista_w);
			end;
		else
			begin
			ds_lista_atrib_w := ds_lista_diagnosticos_w;
			ds_lista_diagnosticos_w := null;
			end;
		end if;

		if (ds_lista_atrib_w IS NOT NULL AND ds_lista_atrib_w::text <> '') then
			begin
			qt_tam_lista_w := length(ds_lista_atrib_w);
			--sequência do diagnóstico;
			ie_pos_separador_w := position('-' in ds_lista_atrib_w);

			if (coalesce(ie_pos_separador_w,0) > 0) then
				begin
				nr_seq_diag_w := (substr(ds_lista_atrib_w, 1, (ie_pos_separador_w - 1)))::numeric;
				ds_lista_atrib_w := substr(ds_lista_atrib_w, (ie_pos_separador_w + 1), qt_tam_lista_w);
				qt_tam_lista_w := length(ds_lista_atrib_w);
				--data inicial;
				ie_pos_separador_w := position('-' in ds_lista_atrib_w);

				if (coalesce(ie_pos_separador_w,0) > 0) then
					begin
					if (upper(substr(ds_lista_atrib_w, 1, (ie_pos_separador_w - 1))) <> 'NULL') then
						dt_inicio_w := to_date(substr(ds_lista_atrib_w, 1, (ie_pos_separador_w - 1)), 'dd/mm/yyyy hh24:mi:ss');
					end if;
					ds_lista_atrib_w := substr(ds_lista_atrib_w, (ie_pos_separador_w + 1), qt_tam_lista_w);
					qt_tam_lista_w := length(ds_lista_atrib_w);
					--data final;
					ie_pos_separador_w := position('-' in ds_lista_atrib_w);

					if (coalesce(ie_pos_separador_w,0) > 0) then
						begin
						if (upper(substr(ds_lista_atrib_w, 1, (ie_pos_separador_w - 1))) <> 'NULL') then
							dt_fim_w := to_date(substr(ds_lista_atrib_w, 1, (ie_pos_separador_w - 1)), 'dd/mm/yyyy hh24:mi:ss');
						end if;
						ds_lista_atrib_w := substr(ds_lista_atrib_w, (ie_pos_separador_w + 1), qt_tam_lista_w);
						qt_tam_lista_w := length(ds_lista_atrib_w);
						--olho do diagnóstico;
						ie_pos_separador_w := position('-' in ds_lista_atrib_w);

						if (coalesce(ie_pos_separador_w,0) > 0) then
							begin
							ie_olho_w := substr(ds_lista_atrib_w, 1, (ie_pos_separador_w - 1));
							ds_lista_atrib_w := substr(ds_lista_atrib_w, (ie_pos_separador_w + 1), qt_tam_lista_w);
							qt_tam_lista_w := length(ds_lista_atrib_w);
							--observações;
							ie_pos_separador_w := position('-' in ds_lista_atrib_w);

							if (coalesce(ie_pos_separador_w,0) > 0) then
								begin
								ds_observacao_w := substr(ds_lista_atrib_w, 1, (ie_pos_separador_w - 1));
								ds_lista_atrib_w := substr(ds_lista_atrib_w, (ie_pos_separador_w + 1), qt_tam_lista_w);
								qt_tam_lista_w := length(ds_lista_atrib_w);
								--parentesco;
								ie_pos_separador_w := position('-' in ds_lista_atrib_w);

								if (coalesce(ie_pos_separador_w,0) > 0) then
									begin
									nr_seq_parentesco_w := substr(ds_lista_atrib_w, 1, (ie_pos_separador_w - 1));
									ds_lista_atrib_w := substr(ds_lista_atrib_w, (ie_pos_separador_w + 1), qt_tam_lista_w);
									qt_tam_lista_w := length(ds_lista_atrib_w);

									end;
								end if;
								end;
							end if;
							end;
						end if;
						end;
					end if;
					end;
				end if;
				end;
			end if;



			CALL gerar_diagnostico_oftalmo(
				nr_seq_diag_w,
				dt_inicio_w,
				dt_fim_w,
				ds_observacao_w,
				cd_profissional_p,
				ie_paciente_p,
				nm_usuario_p,
				nr_seq_consulta_p,
				cd_pessoa_p,
				ie_olho_w,
				ie_libera_p,
				nr_atendimento_p,
				nr_seq_parentesco_w,
				ie_gera_diagnostico_w);
			end;
		end if;
		end;
	end loop;
	end;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_diagnostico_inf_oftalmo ( nr_seq_consulta_p bigint, cd_pessoa_p text, nm_usuario_p text, ie_paciente_p text, cd_profissional_p text, ds_lista_diagnosticos_p text, ie_libera_p text default null, nr_atendimento_p bigint default null) FROM PUBLIC;

