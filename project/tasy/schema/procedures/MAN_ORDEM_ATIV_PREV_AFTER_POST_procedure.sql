-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_ordem_ativ_prev_after_post (nr_seq_ativ_prev_p man_ordem_ativ_prev.nr_sequencia%type, cd_setor_atendimento_p bigint, ie_acao_exec_p bigint, nm_usuario_p text, ie_corp_p text, ie_wheb_p text, ie_atualizar_os INOUT text, ie_atualizar_resp_teste INOUT text, ie_atualizar_migracao INOUT text) AS $body$
DECLARE

					 
nr_seq_os_w			man_ordem_servico.nr_sequencia%type;
nr_seq_integracao_w		man_ordem_servico.nr_seq_integracao%type;
cd_estabelecimento_w 		smallint;
qt_w				bigint;
dt_prevista_w			timestamp;
dt_fim_previsto_w		timestamp;
ie_param_w			varchar(2);
ie_exige_hist_anal_w		varchar(2);
nm_usuario_prev_w		man_ordem_ativ_prev.nm_usuario_prev%type;
ie_atualizacao_migracao_w	man_ordem_servico.ie_atualizacao_migracao%type;

BEGIN
	cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
	 
	select	b.nr_sequencia, 
		b.nr_seq_integracao, 
		a.dt_prevista, 
		b.dt_fim_previsto, 
		a.nm_usuario_prev, 
		b.ie_atualizacao_migracao 
	into STRICT 	nr_seq_os_w, 
		nr_seq_integracao_w, 
		dt_prevista_w, 
		dt_fim_previsto_w, 
		nm_usuario_prev_w, 
		ie_atualizacao_migracao_w 
	from	man_ordem_ativ_prev a, 
		man_ordem_servico b 
	where	a.nr_sequencia = nr_seq_ativ_prev_p 
	and	b.nr_sequencia = a.nr_seq_ordem_serv;
	 
	if (dt_fim_previsto_w < dt_prevista_w) then 
		CALL alterar_ativ_prev_man_os(dt_fim_previsto_w,nr_seq_os_w);
		ie_atualizar_os := 'S';
	end if;
	 
	if (coalesce(nr_seq_integracao_w::text, '') = '') then 
		select	count(*) 
		into STRICT	qt_w 
		from	man_ordem_servico 
		where	nr_sequencia = nr_seq_os_w 
		and	(nr_seq_integracao IS NOT NULL AND nr_seq_integracao::text <> '');	
		 
		if (qt_w > 0) then 
			ie_atualizar_os := 'S';
		end if;
	end if;
	 
	if (ie_acao_exec_p <> 3) then 
		CALL man_gerar_previsao_dia(coalesce(dt_prevista_w,to_date('30/12/99','dd/MM/YY')),nm_usuario_prev_w);
		if (ie_atualizacao_migracao_w = 'P') then 
			ie_atualizar_migracao := 'S';
		end if;
		 
	end if;
	 
	if (ie_corp_p = 'S' or ie_wheb_p = 'S') 
	and (cd_setor_atendimento_p not in (4,17)) 
	and (ie_acao_exec_p <> 3) then 
	 
		select count(*) 
		into STRICT qt_w 
		from man_ordem_serv_estagio 
		where nr_seq_ordem = nr_seq_os_w 
		and nr_seq_estagio in (2,41);
		 
		if (qt_w <> 0) then 
			ie_atualizar_resp_teste := 'S';
		end if;
	end if;
	 
	ie_param_w := Obter_param_Usuario(297, 40, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_param_w);
	if (ie_param_w = 'N') then 
		select count(*) 
		into STRICT	qt_w 
		from  man_ordem_servico       
		where  coalesce(ie_exige_aval_cliente::text, '') = '' 
		and   nr_sequencia = nr_seq_os_w;
		 
		if (qt_w > 0) then 
			ie_exige_hist_anal_w := 'S';
		end if;
	end if;
	 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_ordem_ativ_prev_after_post (nr_seq_ativ_prev_p man_ordem_ativ_prev.nr_sequencia%type, cd_setor_atendimento_p bigint, ie_acao_exec_p bigint, nm_usuario_p text, ie_corp_p text, ie_wheb_p text, ie_atualizar_os INOUT text, ie_atualizar_resp_teste INOUT text, ie_atualizar_migracao INOUT text) FROM PUBLIC;

