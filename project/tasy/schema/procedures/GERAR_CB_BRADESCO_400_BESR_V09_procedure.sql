-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cb_bradesco_400_besr_v09 ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

/*	Versão 09 
	Data: 11/03/2010 
	------------------- Sem registro ---------------------- 
*/
 
 
/* Header */
 
ds_conteudo_w			varchar(400);
cd_empresa_w			varchar(20);
nm_empresa_w			varchar(30);
dt_geracao_w			varchar(6);
ds_branco_8_w			varchar(8);
nr_seq_arquivo_w		varchar(7);
ds_brancos_277_w		varchar(277);
nr_seq_registro_w		varchar(10);

/* Transação */
 
ie_digito_agencia_w		varchar(1);
cd_agencia_debito_w		varchar(5);
cd_agencia_bancaria_w		varchar(5);
cd_conta_w			varchar(7);
ie_digito_conta_w		varchar(1);
id_empresa_w			varchar(17);
nr_controle_partic_w		varchar(25);
cd_banco_w			varchar(3);
ie_multa_w			varchar(1);
pr_multa_w			varchar(4);
nr_dig_nosso_numero_w		varchar(1);
vl_desconto_dia_w		varchar(10);
cd_condicao_w			varchar(1);
ie_emite_papeleta_w		varchar(1);
ie_rateio_w			varchar(1);
ie_endereco_w			varchar(1);
ds_brancos_2_w			varchar(2);
ie_ocorrencia_w			varchar(2);
nr_documento_w			varchar(10);
dt_vencimento_w			varchar(6);
vl_titulo_w			varchar(13);
cd_banco_cobranca_w		varchar(3);
cd_agencia_deposito_w		varchar(5);
ie_especie_w			varchar(2);
ie_aceite_w			varchar(1);
dt_emissao_w			varchar(6);
ie_instrucao_1_w		varchar(2);
ie_instrucao_2_w		varchar(2);
vl_acrescimo_w			varchar(13);
dt_desconto_w			varchar(6);
vl_desconto_w			varchar(13);
vl_iof_w			varchar(13);
vl_abatimento_w			varchar(13);
ie_tipo_inscricao_w		varchar(2);
nr_inscricao_w			varchar(14);
nm_sacado_w			varchar(40);
ds_endereco_sacado_w		varchar(40);
nm_avalista_w			varchar(60);
cd_cep_w			varchar(8);
nr_nosso_numero_w		varchar(11);
ds_brancos_10_w			varchar(10);
ds_branco_12_w			varchar(12);
cd_carteira_w			varchar(3);
nr_seq_reg_arquivo_w		bigint	:= 1;
ds_mensagem_1_w			varchar(80);
ds_mensagem_2_w			varchar(80);
ds_mensagem_3_w			varchar(80);
ds_mensagem_4_w			varchar(80);

/* Trailler */
 
ds_brancos_393_w		varchar(393);

/*Contador*/
 
nr_seq_apres_w			bigint	:= 1;
ie_gerar_cob_esc_prim_mens_w	varchar(1) 	:= null;

 
C01 CURSOR FOR 
	SELECT	lpad(x.cd_agencia_bancaria,5, '0') cd_agencia_debito, 
		lpad(substr(pls_obter_dados_pagador_fin(d.nr_seq_pagador,'DA'),1,1),1,' ') ie_digito_agencia, 
		lpad(x.cd_agencia_bancaria,5, '0') cd_agencia_bancaria, 
		lpad(x.cd_conta,7,'0') cd_conta, 
		coalesce(x.ie_digito_conta,'0') ie_digito_conta, 
		'0' || lpad(coalesce(x.cd_carteira,'0'),3,'0') || lpad(x.cd_agencia_bancaria,5,'0') || lpad(x.cd_conta,7,'0') || coalesce(x.ie_digito_conta,'0') id_empresa, 
		lpad(coalesce(b.nr_titulo,'0'),25,'0') nr_controle_partic, 
		lpad(a.cd_banco,3,'0') cd_banco, 
		'0' ie_multa, 
		lpad('0',4,'0') pr_multa, 
		lpad(to_char(b.nr_titulo),11,'0') nr_nosso_numero, 
		CASE WHEN calcula_digito('MODULO11_BRAD',lpad(substr(x.cd_carteira,2,2),2,'0') || lpad(b.nr_titulo,11,'0'))='-1' THEN 'P'  ELSE calcula_digito('MODULO11_BRAD',lpad(substr(x.cd_carteira,2,2),2,'0') || lpad(b.nr_titulo,11,0)) END  nr_dig_nosso_numero, 
		lpad('0',10,'0') vl_desconto_dia, 
		a.ie_emissao_bloqueto cd_condicao, 
		'N' ie_emite_papeleta, 
		' ' ie_rateio, 
		'2' ie_endereco, 
		lpad(coalesce(c.cd_ocorrencia,'1'),2,'0') ie_ocorrencia, 
		lpad(coalesce(b.nr_documento,'0'),10,'0') nr_documento, 
		to_char(coalesce(b.dt_pagamento_previsto, b.dt_vencimento),'ddmmyy') dt_vencimento, 
		replace(to_char(b.vl_titulo, 'fm00000000000.00'),'.','') vl_titulo, 
		lpad('0',3,'0') cd_banco_cobranca, 
		lpad('0',5,'0') cd_agencia_deposito, 
		'12' ie_especie, 
		'N' ie_aceite, 
		to_char(b.dt_emissao,'ddmmyy') dt_emissao, 
		lpad(coalesce(c.cd_instrucao, '0'),2,'0') ie_instrucao1, 
		'00' ie_instrucao2, 
		replace(to_char(coalesce(c.vl_acrescimo,0), 'fm00000000000.00'),'.','') vl_acrescimo, 
		'000000' dt_desconto, 
		replace(to_char(coalesce(c.vl_desconto,0), 'fm00000000000.00'),'.','') vl_desconto, 
		lpad('0',13,'0') vl_iof, 
		lpad('0',13,'0') vl_abatimento, 
		CASE WHEN coalesce(b.cd_cgc::text, '') = '' THEN '01'  ELSE '02' END  ie_tipo_inscricao, 
		lpad(coalesce(b.cd_cgc_cpf,'0'),14, '0') nr_inscricao, 
		rpad(upper(elimina_acentuacao(substr(b.nm_pessoa,1,40))),40, ' ') nm_sacado, 
		rpad(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'E')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'E') END ,1,10) || ' ' || 
		substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'NR')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'NR') END ,1,3) || ' ' || 
		substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CO')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'CO') END ,1,5) || ' ' || 
		substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'B')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'B') END ,1,10) || ' ' || 
		substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CI')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'CI') END ,1,10) || ' ' || 
		substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'UF')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'UF') END ,1,2),40, ' ') ds_endereco_sacado, 
		substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CEP')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'CEP') END ,1,8) cd_cep, 
		lpad(' ',60,' ') nm_avalista, 
		lpad(substr(coalesce(a.nr_sequencia,''),1,6),6,'0') nr_seq_arquivo, 
		lpad(coalesce(x.cd_carteira,'0'),3,'0'), 
		rpad(obter_linha_texto(g.ds_mensagem,1),80, ' ') ds_mensagem_1, 
		rpad(obter_linha_texto(g.ds_mensagem,2),80, ' ') ds_mensagem_2, 
		rpad(obter_linha_texto(g.ds_mensagem,3),80, ' ') ds_mensagem_3, 
		rpad(obter_linha_texto(g.ds_mensagem,4),80, ' ') ds_mensagem_4 
	FROM banco_estabelecimento x, cobranca_escritural a, titulo_receber_v b
LEFT OUTER JOIN pls_mensalidade d ON (b.nr_seq_mensalidade = d.nr_sequencia)
LEFT OUTER JOIN banco_carteira e ON (b.nr_seq_carteira_cobr = e.nr_sequencia)
LEFT OUTER JOIN pls_contrato_pagador f ON (d.nr_seq_pagador = f.nr_sequencia)
LEFT OUTER JOIN pls_lote_mensalidade z ON (d.nr_seq_lote = z.nr_sequencia)
, titulo_receber_cobr c
LEFT OUTER JOIN titulo_receber_mensagem g ON (c.nr_titulo = g.nr_titulo)
WHERE a.nr_sequencia		= c.nr_seq_cobranca and c.nr_titulo		= b.nr_titulo and a.nr_seq_conta_banco	= x.nr_sequencia      and ((coalesce(z.ie_primeira_mensalidade::text, '') = '' or z.ie_primeira_mensalidade = 'N') 
	or	ie_gerar_cob_esc_prim_mens_w = 'S') and a.nr_sequencia		= nr_seq_cobr_escrit_p;


BEGIN 
 
delete from w_envio_banco where nm_usuario = nm_usuario_p;
 
/* Pega o parâmetro para ver se considera os títulos gerados por lotes de primera mensalidade */
 
select	coalesce(max(ie_gerar_cob_esc_prim_mens),'S') 
into STRICT	ie_gerar_cob_esc_prim_mens_w 
from	pls_parametros_cr 
where	cd_estabelecimento = cd_estabelecimento_p;
 
select	lpad(' ',8,' '), 
	lpad(' ',277,' '), 
	lpad(' ',2,' '), 
	lpad(' ',393,' '), 
	lpad(' ',10,' '), 
	lpad(' ',12,' ') 
into STRICT	ds_branco_8_w, 
	ds_brancos_277_w, 
	ds_brancos_2_w, 
	ds_brancos_393_w, 
	ds_brancos_10_w, 
	ds_branco_12_w
;
 
 
/* Header */
 
select	lpad(substr(c.cd_convenio_banco,1,20), 20,'0'), 
	rpad(upper(elimina_acentuacao(substr(obter_nome_pf_pj(null, b.cd_cgc),1,30))),30, ' '), 
	to_char(a.dt_remessa_retorno,'ddmmyy'), 
	lpad(coalesce(to_char(a.nr_remessa),'0'),7,'0') 
into STRICT	cd_empresa_w, 
	nm_empresa_w, 
	dt_geracao_w, 
	nr_seq_arquivo_w 
from	estabelecimento		b, 
	cobranca_escritural	a, 
	banco_estabelecimento	c 
where	a.cd_estabelecimento	= b.cd_estabelecimento 
and	a.nr_seq_conta_banco	= c.nr_sequencia 
and	a.nr_sequencia		= nr_seq_cobr_escrit_p;
 
select	nextval('w_envio_banco_seq') 
into STRICT	nr_seq_registro_w
;
 
ds_conteudo_w	:= 	'01' || 
			'REMESSA' || 
			'01' || 
			'COBRANCA    ' || 
			cd_empresa_w || 
			nm_empresa_w || 
			'237' || 
			'Bradesco    ' || 
			dt_geracao_w || 
			ds_branco_8_w || 
			'MX' || 
			nr_seq_arquivo_w || 
			ds_brancos_277_w || 
			lpad(nr_seq_reg_arquivo_w,6,'0');	
 
nr_seq_apres_w 	:= nr_seq_apres_w + 1;			
insert into w_envio_banco(nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	cd_estabelecimento, 
	ds_conteudo, 
	nr_seq_apres) 
values (nr_seq_registro_w, 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	cd_estabelecimento_p, 
	ds_conteudo_w, 
	nr_seq_apres_w);
/* Fim Header */
 
 
/* Transação */
 
--begin 
open C01;
loop 
fetch C01 into	 
	cd_agencia_debito_w, 
	ie_digito_agencia_w, 
	cd_agencia_bancaria_w, 
	cd_conta_w, 
	ie_digito_conta_w, 
	id_empresa_w, 
	nr_controle_partic_w, 
	cd_banco_w, 
	ie_multa_w, 
	pr_multa_w, 
	nr_nosso_numero_w, 
	nr_dig_nosso_numero_w, 
	vl_desconto_dia_w, 
	cd_condicao_w, 
	ie_emite_papeleta_w, 
	ie_rateio_w, 
	ie_endereco_w, 
	ie_ocorrencia_w, 
	nr_documento_w, 
	dt_vencimento_w, 
	vl_titulo_w, 
	cd_banco_cobranca_w, 
	cd_agencia_deposito_w, 
	ie_especie_w, 
	ie_aceite_w, 
	dt_emissao_w, 
	ie_instrucao_1_w, 
	ie_instrucao_2_w, 
	vl_acrescimo_w, 
	dt_desconto_w, 
	vl_desconto_w, 
	vl_iof_w, 
	vl_abatimento_w, 
	ie_tipo_inscricao_w, 
	nr_inscricao_w, 
	nm_sacado_w, 
	ds_endereco_sacado_w, 
	cd_cep_w, 
	nm_avalista_w, 
	nr_seq_arquivo_w, 
	cd_carteira_w, 
	ds_mensagem_1_w, 
	ds_mensagem_2_w, 
	ds_mensagem_3_w, 
	ds_mensagem_4_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	/*Transação Tipo 1*/
 
	select	nextval('w_envio_banco_seq') 
	into STRICT	nr_seq_registro_w 
	;
	 
	nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;
	 
	ds_conteudo_w	:=	'1' || 
				'00000' || 
				' ' || 
				'00000' || 
				'0000000' || 
				' ' || 
				id_empresa_w || 
				nr_controle_partic_w || 
				cd_banco_w || 
				ie_multa_w || 
				pr_multa_w || 
				nr_nosso_numero_w || 
				nr_dig_nosso_numero_w || 
				vl_desconto_dia_w || 
				cd_condicao_w || 
				ie_emite_papeleta_w || 
				ds_brancos_10_w || 
				ie_rateio_w || 
				ie_endereco_w || 
				ds_brancos_2_w || 
				ie_ocorrencia_w || 
				nr_documento_w || 
				dt_vencimento_w || 
				vl_titulo_w || 
				cd_banco_cobranca_w || 
				cd_agencia_deposito_w || 
				ie_especie_w || 
				ie_aceite_w || 
				dt_emissao_w || 
				ie_instrucao_1_w || 
				ie_instrucao_2_w || 
				vl_acrescimo_w || 
				dt_desconto_w || 
				vl_desconto_w || 
				vl_iof_w || 
				vl_abatimento_w || 
				ie_tipo_inscricao_w || 
				nr_inscricao_w || 
				nm_sacado_w || 
				ds_endereco_sacado_w || 
				rpad(' ',12, ' ') || 
				coalesce(cd_cep_w, '    ') || 
				nm_avalista_w || 
				lpad(nr_seq_reg_arquivo_w,6,'0');
				 
	nr_seq_apres_w 	:= nr_seq_apres_w + 1;
	insert into w_envio_banco(nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		cd_estabelecimento, 
		ds_conteudo, 
		nr_seq_apres) 
	values (nr_seq_registro_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_estabelecimento_p, 
		ds_conteudo_w, 
		nr_seq_apres_w);		
	/*Fim Transação Tipo 1*/
 
 
	/*Transação Tipo 2*/
			 
	select	nextval('w_envio_banco_seq') 
	into STRICT	nr_seq_registro_w 
	;
	 
	nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;
 
	ds_conteudo_w	:=	'2' || 
				rpad(coalesce(ds_mensagem_1_w, ' '), 80, ' ') || 
				rpad(coalesce(ds_mensagem_2_w, ' '), 80, ' ') || 
				rpad(coalesce(ds_mensagem_3_w, ' '), 80, ' ') || 
				rpad(coalesce(ds_mensagem_4_w, ' '), 80, ' ') || 
				rpad(' ', 6, ' ') || 
				rpad(' ', 13, ' ') || 
				rpad(' ', 6, ' ') || 
				rpad(' ', 13, ' ') || 
				rpad(' ', 7, ' ') || 
				cd_carteira_w || 
				cd_agencia_debito_w || 
				cd_conta_w || 
				ie_digito_conta_w || 
				nr_nosso_numero_w || 
				nr_dig_nosso_numero_w || 
				lpad(nr_seq_reg_arquivo_w,6,'0');
				 
	nr_seq_apres_w	:= nr_seq_apres_w + 1;
	insert into w_envio_banco(nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		cd_estabelecimento, 
		ds_conteudo, 
		nr_seq_apres) 
	values (nr_seq_registro_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_estabelecimento_p, 
		ds_conteudo_w, 
		nr_seq_apres_w);
	/*Fim Transação Tipo 2*/
		 
	end;
end loop;
close C01;
/*exception 
when others then 
	Raise_application_error(-20011,nr_dig_nosso_numero_w||'-' || vl_desconto_dia_w||'-' || cd_condicao_w||'-' || 
				ie_emite_papeleta_w||'-' || ie_rateio_w||'-' || ie_endereco_w||'-' || ds_brancos_2_w||'-' || ie_ocorrencia_w ||'-'|| nr_documento_w||'-' || dt_vencimento_w||'-' || 
				vl_titulo_w||'-' || cd_banco_cobranca_w||'-' || cd_agencia_deposito_w||'-' || ie_especie_w ||'-'|| ie_aceite_w||'-' || dt_emissao_w||'-' || ie_instrucao_1_w||'-' || 
				ie_instrucao_2_w||'-' || vl_acrescimo_w||'-' || dt_desconto_w ||'-'|| vl_desconto_w||'-' || vl_iof_w||'-' || vl_abatimento_w||'-' || ie_tipo_inscricao_w||'-' || 
				nr_inscricao_w||'-' || nm_sacado_w||'-' || ds_endereco_sacado_w||'-' || nm_avalista_w||'-' || nr_seq_arquivo_w||'#@#@'); 
end;*/
 
/* Fim Transação */
 
 
/* Trailler */
 
nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;
 
ds_conteudo_w	:= '9' || 
		  ds_brancos_393_w || 
		  lpad(nr_seq_reg_arquivo_w,6,'0');	
 
select	nextval('w_envio_banco_seq') 
into STRICT	nr_seq_registro_w
;
 
 
nr_seq_apres_w	:= nr_seq_apres_w + 1;		
insert into w_envio_banco(nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	cd_estabelecimento, 
	ds_conteudo, 
	nr_seq_apres) 
values (nr_seq_registro_w, 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	cd_estabelecimento_p, 
	ds_conteudo_w, 
	nr_seq_apres_w);
 
 
/* Fim Trailler*/
 
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cb_bradesco_400_besr_v09 ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

