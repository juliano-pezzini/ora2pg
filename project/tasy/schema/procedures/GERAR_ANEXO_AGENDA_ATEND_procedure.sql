-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_anexo_agenda_atend (nr_seq_agendamento_p bigint, nr_atendimento_p bigint, ie_tipo_agenda_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_agenda_int_w	bigint;
qt_anexos_w		    bigint;
ie_anexos_atend_w   varchar(1);


BEGIN

ie_anexos_atend_w := obter_param_usuario(869, 447, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_anexos_atend_w);

if (ie_anexos_atend_w = 'S') then

	if (ie_tipo_agenda_p = 2) then
		select max(ait.nr_seq_agenda_int)
		into STRICT   nr_seq_agenda_int_w
		from   agenda_integrada_item ait
		where  ait.nr_seq_agenda_exame = nr_seq_agendamento_p;
	elsif (ie_tipo_agenda_p in (3, 4, 5)) then
		select max(ait.nr_seq_agenda_int)
		into STRICT   nr_seq_agenda_int_w
		from   agenda_integrada_item ait
		where  ait.nr_seq_agenda_cons = nr_seq_agendamento_p;
	end if;
		
	if (nr_seq_agenda_int_w IS NOT NULL AND nr_seq_agenda_int_w::text <> '') then
		select	count(*)
		into STRICT    qt_anexos_w
		from	ageint_arq_anexo_email
		where	nr_seq_agenda_int = nr_seq_agenda_int_w;
		
		if (qt_anexos_w > 0) then
			insert into atendimento_paciente_anexo(nr_sequencia,
			nr_atendimento,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_arquivo,
			ie_nivel_atencao,
			nr_seq_ageint)
			SELECT nextval('atendimento_paciente_anexo_seq'),
				   nr_atendimento_p,
				   clock_timestamp(),
				   nm_usuario_p,
				   clock_timestamp(),
				   nm_usuario_p,
				   a.ds_arquivo,
				   'T',--default
				   a.nr_seq_agenda_int
			from   ageint_arq_anexo_email a
			where  a.nr_seq_agenda_int = nr_seq_agenda_int_w
			and    not exists (SELECT *
							   from   atendimento_paciente_anexo b
							   where  b.ds_arquivo = a.ds_arquivo
							   and    b.nr_seq_ageint = a.nr_seq_agenda_int);
		end if;		
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_anexo_agenda_atend (nr_seq_agendamento_p bigint, nr_atendimento_p bigint, ie_tipo_agenda_p bigint, nm_usuario_p text) FROM PUBLIC;

