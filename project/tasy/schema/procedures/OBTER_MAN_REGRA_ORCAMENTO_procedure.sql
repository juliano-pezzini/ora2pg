-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_man_regra_orcamento (nr_seq_localizacao_p bigint, cd_cargo_p bigint, cd_setor_p bigint, ie_momento_p text, ie_opcao_p INOUT text, ds_mensagem_p INOUT text) AS $body$
DECLARE


nr_sequencia_regra_w	bigint;


BEGIN

select coalesce(max(z.ie_regra_bloqueio),''),
	   coalesce(max(z.ds_mensagem),''),
	   coalesce(max(z.nr_sequencia),0)
into STRICT	ie_opcao_p,
		ds_mensagem_p,
		nr_sequencia_regra_w
from (	SELECT 	b.ie_regra_bloqueio,
				b.cd_cargo,
				b.cd_setor,
				a.ds_mensagem,
				b.nr_sequencia
		from	man_regra_orcamento a,
				man_regra_orcamento_bloq	b
		where	a.ie_situacao = 'A'
		and		a.nr_sequencia = b.nr_seq_orcamento
		and		a.nr_seq_localizacao = nr_seq_localizacao_p
		and (coalesce(b.cd_cargo,0) = coalesce(cd_cargo_p,0) or coalesce(b.cd_cargo::text, '') = '')
		and (coalesce(b.cd_setor,0) = coalesce(cd_setor_p,0) or coalesce(b.cd_setor::text, '') = '')
		and		a.ie_momento_regra = ie_momento_p
		and		clock_timestamp() between coalesce(a.dt_inicial,clock_timestamp()) and coalesce(a.dt_final,clock_timestamp())
		order by	case
		when	(b.cd_cargo IS NOT NULL AND b.cd_cargo::text <> '') and (b.cd_setor IS NOT NULL AND b.cd_setor::text <> '') then 1
		when	(b.cd_cargo IS NOT NULL AND b.cd_cargo::text <> '') and coalesce(b.cd_setor::text, '') = '' then 2
		when	coalesce(b.cd_cargo::text, '') = '' and (b.cd_setor IS NOT NULL AND b.cd_setor::text <> '') then 3
		else 4 end,
			b.dt_atualizacao desc,
			a.dt_atualizacao desc) z LIMIT 1;

if (coalesce(nr_sequencia_regra_w,0) = 0) then
	ie_opcao_p 		:= 'S';
	ds_mensagem_p	:= '';
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_man_regra_orcamento (nr_seq_localizacao_p bigint, cd_cargo_p bigint, cd_setor_p bigint, ie_momento_p text, ie_opcao_p INOUT text, ds_mensagem_p INOUT text) FROM PUBLIC;

