-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE html_obter_ultima_agenda_turno (cd_agenda_p bigint, nr_seq_turno_p bigint, dt_final_vigencia_p timestamp, ie_possui_agenda_p INOUT text, mensagem_403289_p INOUT text, mensagem_403436_p INOUT text, dt_ultima_agenda_p INOUT timestamp) AS $body$
DECLARE


/*
Procedure cópia da obter_ultima_agenda_turno, com os tratamentos para internacionalização utilizada no HTML5
*/
dt_agenda_w			timestamp;
dif_datas_w			bigint := 0;
ie_consistir_fim_turno_w	parametro_agenda.ie_consistir_fim_turno%type;


BEGIN

ie_possui_agenda_p := 'N';

select 	coalesce(max(ie_consistir_fim_turno),'N')
into STRICT	ie_consistir_fim_turno_w
from	parametro_agenda
where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

if (ie_consistir_fim_turno_w = 'S') then

	select 	max(dt_agenda)
	into STRICT	dt_agenda_w
	from 	agenda_consulta
	where 	cd_agenda 	= cd_agenda_p
	and	nr_seq_turno 	= nr_seq_turno_p
	and	ie_status_agenda NOT IN ('C','LF','F','I','L');

	if (dt_agenda_w IS NOT NULL AND dt_agenda_w::text <> '')then
		dif_datas_w := Obter_Dias_Entre_Datas(trunc(dt_final_vigencia_p),trunc(dt_agenda_w));
	end if;

	dt_ultima_agenda_p := trunc(dt_agenda_w);

	if (dif_datas_w > 0) then
		ie_possui_agenda_p	:= 'S';
		mensagem_403289_p  	:= WHEB_MENSAGEM_PCK.get_texto(403289,'DATA='||PKG_DATE_FORMATERS.TO_VARCHAR(dt_agenda_w, 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.GET_NM_USUARIO));
		mensagem_403436_p  	:= WHEB_MENSAGEM_PCK.get_texto(403436,
						'DATA_INI='||PKG_DATE_FORMATERS.TO_VARCHAR(dt_final_vigencia_p, 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.GET_NM_USUARIO)||
						';DATA_FIN='||PKG_DATE_FORMATERS.TO_VARCHAR(dt_agenda_w, 'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.GET_NM_USUARIO));
	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE html_obter_ultima_agenda_turno (cd_agenda_p bigint, nr_seq_turno_p bigint, dt_final_vigencia_p timestamp, ie_possui_agenda_p INOUT text, mensagem_403289_p INOUT text, mensagem_403436_p INOUT text, dt_ultima_agenda_p INOUT timestamp) FROM PUBLIC;

