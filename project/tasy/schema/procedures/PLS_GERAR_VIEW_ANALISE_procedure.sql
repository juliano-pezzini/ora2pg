-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_view_analise ( nr_seq_regra_visualizacao_p bigint, nr_seq_analise_p bigint ) AS $body$
DECLARE


ds_comando_w		varchar(32000) := '';


BEGIN

ds_comando_w	:=	'create or replace view pls_analise_resumida_v as '||chr(10)||chr(13)||
			'SELECT	0 ie_inserir,'||chr(10)||chr(13)||
				chr(39)||chr(39)||' ie_inserir_check,'||chr(10)||chr(13)||
				'a.ie_ordem,'||chr(10)||chr(13)||
				'a.ie_ordem_titulo,'||chr(10)||chr(13)||
				'a.nr_seq_apres,'||chr(10)||chr(13)||
				'nvl(a.cd_material,a.cd_item)cd_item,'||chr(10)||chr(13)||
				'a.ie_origem_proced,'||chr(10)||chr(13)||
				'a.ds_item_despesa,'||chr(10)||chr(13)||
				'sum(a.qt_apresentado)qt_apresentado,'||chr(10)||chr(13)||
				'sum(a.vl_unitario_apres)vl_unitario_apres,'||chr(10)||chr(13)||
				'sum(a.vl_total_apres)vl_total_apres,'||chr(10)||chr(13)||
				'sum(a.vl_uni_calculado)vl_uni_calculado,'||chr(10)||chr(13)||
				'sum(a.vl_calculado)vl_calculado,'||chr(10)||chr(13)||
				'sum(a.qt_liberado)qt_liberado,'||chr(10)||chr(13)||
				'sum(a.vl_unitario)vl_unitario,'||chr(10)||chr(13)||
				'sum(a.vl_total)vl_total,'||chr(10)||chr(13)||
				'sum((a.vl_total_apres-a.vl_calculado))vl_diferenca,'||chr(10)||chr(13)||
				'a.ie_tipo_despesa,'||chr(10)||chr(13)||
				'a.ie_tipo_item,'||chr(10)||chr(13)||
				'a.nr_seq_analise,'||chr(10)||chr(13)||
				'a.ds_item_despesa_order,'||chr(10)||chr(13)||
				'null ie_valor_base'||chr(10)||chr(13)||
			'from 	pls_resumo_conta_v a'||chr(10)||chr(13)||
			'where 	a.nr_seq_analise='||nr_seq_analise_p||chr(10)||chr(13)||
			'and	(((ie_ordem_titulo=0)and exists(select 1'||chr(10)||chr(13)||
								'from 	pls_resumo_conta_v b'||chr(10)||chr(13)||
								'where 	b.nr_seq_analise=a.nr_seq_analise'||chr(10)||chr(13)||
								'and 	b.ds_tipo_despesa=a.ds_tipo_despesa'||chr(10)||chr(13)||
								'and 	b.ie_ordem_titulo=1'||chr(10)||chr(13)||
								'and 	exists(	select 	1'||chr(10)||chr(13)||
										'from 	pls_analise_conta_modelo x,'||chr(10)||chr(13)||
											'pls_conta_modelo_item y'||chr(10)||chr(13)||
										'where 	x.nr_sequencia=y.nr_seq_modelo'||chr(10)||chr(13)||
										'and 	x.nr_sequencia='||nr_seq_regra_visualizacao_p||chr(10)||chr(13)||
										'and 	y.ie_situacao=''A'''||chr(10)||chr(13)||
										'and 	nvl(y.ie_agrupar,''N'')=''N'''||chr(10)||chr(13)||
										'and    ((x.ie_participante=''S'')or((x.ie_participante=''N'')and((b.ie_tipo_item<>''R'') and (b.ie_tipo_guia <> ''6''))))'||chr(10)||chr(13)||
										'and    ((nvl(y.ie_tipo_despesa,0)=0)or(y.ie_tipo_despesa=decode(replace(b.ds_tipo_despesa,''R'',''P''),''P1'',3,''P2'',4,''P3'',5,''P4'',8,''M'',7,''M2'',1,''M3'',2,''M7'',6)))'||chr(10)||chr(13)||
										'and     ((nvl(y.ie_tipo_guia,0)=0)or(y.ie_tipo_guia=b.ie_tipo_guia)))))or'||chr(10)||chr(13)||
				 '(((ie_ordem_titulo=1)and exists(select 	 1'||chr(10)||chr(13)||
								 'from 		 pls_analise_conta_modelo x,'||chr(10)||chr(13)||
										'pls_conta_modelo_item y'||chr(10)||chr(13)||
								 'where 	x.nr_sequencia=y.nr_seq_modelo'||chr(10)||chr(13)||
								 'and 		x.nr_sequencia='||nr_seq_regra_visualizacao_p||chr(10)||chr(13)||
								 'and 		y.ie_situacao=''A'''||chr(10)||chr(13)||
								 'and 		nvl(y.ie_agrupar,''N'')=''N'''||chr(10)||chr(13)||
								 'and		((x.ie_participante=''S'')or((x.ie_participante=''N'')and((a.ie_tipo_item<>''R'') and (a.ie_tipo_guia <> ''6''))))'||chr(10)||chr(13)||
								 'and		((nvl(y.ie_tipo_despesa,0)=0)or(y.ie_tipo_despesa=decode(replace(a.ds_tipo_despesa,''R'',''P''),''P1'',3,''P2'',4,''P3'',5,''P4'',8,''M1'',7,''M2'',1,''M3'',2,''M7'',6)))'||chr(10)||chr(13)||
								 'and		((nvl(y.ie_tipo_guia,0)=0)or(y.ie_tipo_guia=a.ie_tipo_guia)))) or'||chr(10)||chr(13)||
				'((a.ie_status_item = ''I'') and exists (	select 	1'||chr(10)||chr(13)||
										'from 	pls_resumo_conta_v b'||chr(10)||chr(13)||
										'where 	b.nr_seq_analise=a.nr_seq_analise'||chr(10)||chr(13)||
										'and 	b.ds_tipo_despesa=a.ds_tipo_despesa'||chr(10)||chr(13)||
										'and 	b.ie_ordem_titulo=1'||chr(10)||chr(13)||
										'and    b.ie_tipo_guia = ''6'''||chr(10)||chr(13)||
										'and    b.nr_seq_item_ref = a.nr_seq_item_ref'||chr(10)||chr(13)||
										'and 	exists(	 select  1'||chr(10)||chr(13)||
											        'from 	 pls_analise_conta_modelo x,'||chr(10)||chr(13)||
													'pls_conta_modelo_item y'||chr(10)||chr(13)||
												'where 	 x.nr_sequencia=y.nr_seq_modelo'||chr(10)||chr(13)||
												'and 	 x.nr_sequencia= '||nr_seq_regra_visualizacao_p||chr(10)||chr(13)||
												'and 	 y.ie_situacao=''A'''||chr(10)||chr(13)||
												'and 	 nvl(y.ie_agrupar,''N'')=''N'''||chr(10)||chr(13)||
												'and     ((x.ie_participante=''S'')or((x.ie_participante=''N'')and((b.ie_tipo_item<>''R'') and (b.ie_tipo_guia <> ''6''))))'||chr(10)||chr(13)||
												'and     ((nvl(y.ie_tipo_despesa,0)=0)or(y.ie_tipo_despesa=decode(replace(b.ds_tipo_despesa,''R'',''P''),''P1'',3,''P2'',4,''P3'',5,''P4'',8,''M1'',7,''M2'',1,''M3'',2,''M7'',6)))'||chr(10)||chr(13)||
												'and     ((nvl(y.ie_tipo_guia,0)=0)or(y.ie_tipo_guia=b.ie_tipo_guia)))))))'||chr(10)||chr(13)||
			'group by a.ie_ordem, a.ie_ordem_titulo, a.nr_seq_apres, nvl(a.cd_material,a.cd_item), a.ie_origem_proced, a.ds_item_despesa, a.ie_tipo_despesa, a.ie_tipo_item, a.nr_seq_analise, a.ds_item_despesa_order'||chr(10)||chr(13)||
			'union'||chr(10)||chr(13)||
			'select	0,'||chr(10)||chr(13)||
				chr(39)||chr(39)||','||chr(10)||chr(13)||
				'ie_ordem,'||chr(10)||chr(13)||
				'0,'||chr(10)||chr(13)||
				'null,'||chr(10)||chr(13)||
				'null,'||chr(10)||chr(13)||
				'null,'||chr(10)||chr(13)||
				'substr(pls_obter_desc_item_desp(ds_tipo_despesa,''P''),1,50),'||chr(10)||chr(13)||
				'nvl(sum(qt_apresentado),0),'||chr(10)||chr(13)||
				'nvl(sum(vl_unitario_apres),0),'||chr(10)||chr(13)||
				'nvl(sum(vl_total_apres),0),'||chr(10)||chr(13)||
				'nvl(sum(vl_uni_calculado),0),'||chr(10)||chr(13)||
				'nvl(sum(vl_calculado),0),'||chr(10)||chr(13)||
				'nvl(sum(qt_liberado),0),'||chr(10)||chr(13)||
				'nvl(sum(vl_unitario),0),'||chr(10)||chr(13)||
				'nvl(sum(vl_total),0),'||chr(10)||chr(13)||
				'nvl(sum((vl_total_apres-vl_calculado)),0),'||chr(10)||chr(13)||
				'ie_tipo_despesa,'||chr(10)||chr(13)||
				'null,'||chr(10)||chr(13)||
				'nr_seq_analise,'||chr(10)||chr(13)||
				'null,'||chr(10)||chr(13)||
				'null'||chr(10)||chr(13)||
			'from(	SELECT 	a.ie_ordem,'||chr(10)||chr(13)||
					'replace(a.ds_tipo_despesa,''R'',''P'') ds_tipo_despesa,'||chr(10)||chr(13)||
					'a.qt_apresentado,'||chr(10)||chr(13)||
					'a.vl_unitario_apres,'||chr(10)||chr(13)||
					'a.vl_total_apres,'||chr(10)||chr(13)||
					'a.vl_uni_calculado,'||chr(10)||chr(13)||
					'a.vl_calculado,'||chr(10)||chr(13)||
					'a.qt_liberado,'||chr(10)||chr(13)||
					'a.vl_unitario,'||chr(10)||chr(13)||
					'a.vl_total,'||chr(10)||chr(13)||
					'(a.vl_total_apres-a.vl_calculado) vl_diferenca,'||chr(10)||chr(13)||
					'a.ie_tipo_despesa,'||chr(10)||chr(13)||
					'a.nr_seq_analise'||chr(10)||chr(13)||
				'from 	pls_resumo_conta_v a,'||chr(10)||chr(13)||
					'pls_analise_conta_modelo x,'||chr(10)||chr(13)||
					'pls_conta_modelo_item y'||chr(10)||chr(13)||
				'where 	x.nr_sequencia=y.nr_seq_modelo'||chr(10)||chr(13)||
				'and	a.nr_seq_analise ='||nr_seq_analise_p||chr(10)||chr(13)||
				'and 	x.nr_sequencia   ='||nr_seq_regra_visualizacao_p||chr(10)||chr(13)||
				'and 	nvl(y.ie_agrupar,''N'')=''S'''||chr(10)||chr(13)||
				'and 	a.ie_ordem_titulo=1'||chr(10)||chr(13)||
				'and	((nvl(y.ie_tipo_despesa,0)=0)or(y.ie_tipo_despesa=decode(replace(a.ds_tipo_despesa,''R'',''P''),''P1'',3,''P2'',4,''P3'',5,''P4'',8,''M1'',7,''M2'',1,''M3'',2,''M7'',6)))'||chr(10)||chr(13)||
				'and	((nvl(y.ie_tipo_guia,0)=0)or(y.ie_tipo_guia=a.ie_tipo_guia)))'||chr(10)||chr(13)||
'group by ie_ordem,ds_tipo_despesa,ie_tipo_despesa,nr_seq_analise'||chr(10)||chr(13)||
'ORDER BY ie_ordem ASC,ie_ordem_titulo ASC,ds_item_despesa_order ASC,nr_seq_apres ASC';

CALL exec_sql_dinamico('tasy', ds_comando_w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_view_analise ( nr_seq_regra_visualizacao_p bigint, nr_seq_analise_p bigint ) FROM PUBLIC;

