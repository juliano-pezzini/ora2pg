-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lancar_adm_lote_fornecedor ( nr_atendimento_p bigint, cd_material_p bigint, nr_seq_lote_fornecedor_p bigint, nr_seq_horario_p bigint, nr_prescricao_p bigint, qt_material_p bigint, cd_unidade_medida_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w				bigint;
nr_seq_lote_adm_w			bigint;
cd_unid_med_w				varchar(30);
cd_material_estoque_w       bigint;
nr_seq_horario_w			bigint;
qt_dose_convertida_w		double precision := 0;
qt_total_disp_w				double precision := 0;
cd_unidade_medida_w			prescr_material.cd_unidade_medida%type;
cd_um_disp_w				prescr_material.cd_unidade_medida%type;
qt_material_w				administracao_lote_fornec.qt_material%type;
ie_continua_w				boolean;


BEGIN

if (coalesce(nr_seq_lote_fornecedor_p,0) > 0) then

		cd_unid_med_w				:= substr(obter_dados_material(cd_material_p,'UMC'),1,5);
		cd_material_estoque_w		:= substr(obter_dados_material(cd_material_p,'EST'),1,30);

		select coalesce(max(nr_sequencia),0)
		into STRICT nr_seq_lote_adm_w
		from administracao_lote_fornec
		where nr_prescricao = nr_prescricao_p
		and   nr_seq_lote_fornec = nr_seq_lote_fornecedor_p;

		if (nr_seq_lote_adm_w = 0) then
			select	nextval('administracao_lote_fornec_seq')
			into STRICT	nr_seq_lote_adm_w
			;

			insert into administracao_lote_fornec(
				nr_sequencia,
				nr_atendimento,
				nr_prescricao,
				nr_seq_lote_fornec,
				nr_seq_prescricao,
				cd_material,
				nr_seq_lote_ap,
				dt_atualizacao,
				nm_usuario,
				cd_unidade_medida,
				qt_material)
			values (nr_seq_lote_adm_w,
				nr_atendimento_p,
				nr_prescricao_p,
				nr_seq_lote_fornecedor_p,
				null,
				cd_material_p,
				null,
				clock_timestamp(),
				nm_usuario_p,
				cd_unid_med_w,
				0
			);

		else
			-- Verifica o total que tem pra dispensar neste horário
			select	max(qt_dispensar_hor),
					max(cd_unidade_medida)
			into STRICT	qt_total_disp_w,
					cd_um_disp_w
			from	prescr_mat_hor
			where	nr_sequencia = nr_seq_horario_p;

			--Busca total que já foi lançado para este LF
			select	sum(qt_material),
					max(cd_unidade_medida)
			into STRICT	qt_material_w,
					cd_unidade_medida_w
			from	administracao_lote_item
			where	nr_seq_lote_adm = nr_seq_lote_adm_w
			and		nr_seq_horario = nr_seq_horario_p
			and		ie_situacao = 'S';

		end if;

		ie_continua_w := true;

		--Valida se já foi lançada a quantidade total nesta tabela auxiliar,
		--caso já tenha fechado o total a dispensar, não deixa inserir mais registros.
		if (coalesce(qt_total_disp_w,0) > 0) then

			if (qt_material_w = qt_total_disp_w) and (cd_unidade_medida_w = cd_um_disp_w) then
				ie_continua_w := false;
			end if;

		end if;

		if (ie_continua_w) then

			qt_dose_convertida_w := Obter_dose_convertida(cd_material_p, qt_material_p, cd_unidade_medida_p, cd_unid_med_w);

			select	nextval('administracao_lote_item_seq')
			into STRICT	nr_sequencia_w
			;

			insert into administracao_lote_item(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nr_seq_lote_adm,
				qt_material,
				ie_situacao,
				nr_seq_horario,
				cd_unidade_medida)
			values (nr_sequencia_w,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_lote_adm_w,
				qt_material_p,
				'S',
				nr_seq_horario_p,
				cd_unidade_medida_p
			);

			update 	administracao_lote_fornec
			set 	qt_material = qt_material + qt_dose_convertida_w
			where 	nr_sequencia = nr_seq_lote_adm_w;

		end if;

	commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lancar_adm_lote_fornecedor ( nr_atendimento_p bigint, cd_material_p bigint, nr_seq_lote_fornecedor_p bigint, nr_seq_horario_p bigint, nr_prescricao_p bigint, qt_material_p bigint, cd_unidade_medida_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

