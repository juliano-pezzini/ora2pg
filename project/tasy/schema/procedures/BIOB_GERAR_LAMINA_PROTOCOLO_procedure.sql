-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE biob_gerar_lamina_protocolo ( nr_seq_tubo_p bigint, nr_seq_protocolo_p bigint, cd_profissional_p text, nm_usuario_p text) AS $body$
DECLARE



nr_seq_material_w	bigint;
nr_seq_material_ww	bigint;
nr_seq_superior_w	bigint;
ie_gera_w		varchar(1) := 'N';

C01 CURSOR FOR
	SELECT	a.nr_seq_tipo_mat,
		a.nr_sequencia
	from	biob_prot_coleta_mat a
	where	a.nr_seq_protocolo = nr_seq_protocolo_p
	and	coalesce(a.nr_seq_superior::text, '') = ''
	order by	a.nr_sequencia;

C02 CURSOR FOR
	SELECT	a.nr_seq_tipo_mat
	from	biob_prot_coleta_mat a
	where	a.nr_seq_protocolo = nr_seq_protocolo_p
	and	a.nr_seq_superior = nr_seq_superior_w
	order by	a.nr_sequencia;


BEGIN
open C01;
loop
fetch C01 into
	nr_seq_material_w,
	nr_seq_superior_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ie_gera_w := 'N';

	select	max('S')
	into STRICT	ie_gera_w
	from	biob_tipo_mat_coleta
	where	nr_sequencia = nr_seq_material_w
	and	ie_gera_lamina = 'S';

	if (ie_gera_w = 'S') then
		insert into biob_coleta_lamina(
			nr_sequencia,
			dt_atualizacao,
			dt_atualizacao_nrec,
			nm_usuario,
			nm_usuario_nrec,
			dt_lamina,
			cd_prof_confeccao,
			nr_seq_tipo_mat,
			nr_seq_tubo)
		values (
			nextval('biob_coleta_lamina_seq'),
			clock_timestamp(),
			clock_timestamp(),
			nm_usuario_p,
			nm_usuario_p,
			clock_timestamp(),
			cd_profissional_p,
			nr_seq_material_w,
			nr_seq_tubo_p);
	end if;

	open C02;
	loop
	fetch C02 into
		nr_seq_material_ww;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		ie_gera_w := 'N';

		select	max('S')
		into STRICT	ie_gera_w
		from	biob_tipo_mat_coleta
		where	nr_sequencia = nr_seq_material_ww
		and	ie_gera_lamina = 'S';

		if (ie_gera_w = 'S') then
			insert into biob_coleta_lamina(
				nr_sequencia,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nm_usuario,
				nm_usuario_nrec,
				dt_lamina,
				cd_prof_confeccao,
				nr_seq_tipo_mat,
				nr_seq_tubo)
			values (
				nextval('biob_coleta_lamina_seq'),
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_p,
				nm_usuario_p,
				clock_timestamp(),
				cd_profissional_p,
				nr_seq_material_ww,
				nr_seq_tubo_p);
		end if;
		end;
	end loop;
	close C02;

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE biob_gerar_lamina_protocolo ( nr_seq_tubo_p bigint, nr_seq_protocolo_p bigint, cd_profissional_p text, nm_usuario_p text) FROM PUBLIC;

