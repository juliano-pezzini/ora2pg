-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_gerar_fatura_cedente (nr_seq_fatura_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nm_pagador_w			varchar(60);
ie_tipo_w			varchar(1);
ds_endereco_w			varchar(40);
cd_cep_w			varchar(8);
ds_municipio_w			varchar(30);
sg_estado_w			pessoa_juridica.sg_estado%type;
cd_cgc_cpf_w			varchar(14);
cd_municipio_ibge_w		varchar(20);
ds_complemento_w		varchar(20);
ds_bairro_w			varchar(30);
nr_ddd_telefone_w		smallint;
nr_telefone_w			integer;
ds_fax_w			integer;
cd_pessoa_fisica_w		varchar(15);
cd_ans_w			varchar(10);
cd_unimed_destino_w		varchar(10);
cd_unimed_origem_w		varchar(10);
cd_cgc_destino_w		varchar(14);
cd_cgc_origem_w			varchar(14);
nr_endereco_w			varchar(6);

c01 CURSOR FOR 
	SELECT	substr(upper(ptu_somente_caracter_permitido(obter_nome_pf_pj('',a.cd_cgc),'ANS')),1,60), 
		'1', 
		substr(upper(ptu_somente_caracter_permitido(b.ds_endereco,'ANS')),1,40), 
		substr(b.cd_cep,1,8), 
		substr(upper(ptu_somente_caracter_permitido(coalesce(trim(both b.ds_municipio),trim(both a.ds_municipio)),'ANS')),1,30), 
		substr(b.sg_estado,1,2), 
		substr(a.cd_cgc,1,20), 
		b.cd_municipio_ibge, 
		substr(upper(ptu_somente_caracter_permitido(b.ds_complemento,'ANS')),1,20), 
		substr(upper(ptu_somente_caracter_permitido(b.ds_bairro,'ANS')),1,30), 
		substr(obter_somente_numero(b.nr_ddd_telefone),1,4), 
		substr(obter_somente_numero(b.nr_telefone),1,9), 
		substr(obter_somente_numero(b.nr_fax),1,9), 
		substr(obter_somente_numero(b.nr_endereco),1,6) 
	from	pessoa_juridica		a, 
		pessoa_juridica_compl	b 
	where	a.cd_cgc	= b.cd_cgc 
	and (a.cd_cgc	= cd_cgc_origem_w) 
	and	((b.ie_tipo_complemento	= 2) 
	or	b.nr_sequencia = (SELECT	max(nr_sequencia) 
		from	pessoa_juridica_compl	x 
		where	x.cd_cgc	= a.cd_cgc)) 
	
union
 
	select	substr(upper(ptu_somente_caracter_permitido(obter_nome_pf_pj('',a.cd_cgc),'ANS')),1,60), 
		'2', 
		substr(upper(ptu_somente_caracter_permitido(b.ds_endereco,'ANS')),1,40), 
		substr(b.cd_cep,1,8), 
		substr(upper(ptu_somente_caracter_permitido(coalesce(trim(both b.ds_municipio),trim(both a.ds_municipio)),'ANS')),1,30), 
		substr(b.sg_estado,1,2), 
		substr(a.cd_cgc,1,20), 
		b.cd_municipio_ibge, 
		substr(upper(ptu_somente_caracter_permitido(b.ds_complemento,'ANS')),1,20), 
		substr(upper(ptu_somente_caracter_permitido(b.ds_bairro,'ANS')),1,30), 
		substr(obter_somente_numero(b.nr_ddd_telefone),1,4), 
		substr(obter_somente_numero(b.nr_telefone),1,9), 
		substr(obter_somente_numero(b.nr_fax),1,9), 
		substr(obter_somente_numero(b.nr_endereco),1,6) 
	from	pessoa_juridica		a, 
		pessoa_juridica_compl	b 
	where	a.cd_cgc	= b.cd_cgc 
	and	a.cd_cgc	= cd_cgc_destino_w 
	and	((b.ie_tipo_complemento	= 2) 
	or	b.nr_sequencia = (select	max(nr_sequencia) 
		from	pessoa_juridica_compl	x 
		where	x.cd_cgc	= a.cd_cgc));


BEGIN 
begin 
select	cd_unimed_destino, 
	cd_unimed_origem 
into STRICT	cd_unimed_destino_w, 
	cd_unimed_origem_w 
from	ptu_fatura 
where	nr_sequencia	= nr_seq_fatura_p;
 
select	max(cd_cgc) 
into STRICT	cd_cgc_origem_w 
from	pls_congenere 
where	cd_cooperativa	= cd_unimed_origem_w;
 
select	max(cd_cgc) 
into STRICT	cd_cgc_destino_w 
from	pls_congenere 
where	cd_cooperativa	= cd_unimed_destino_w;
exception 
when others then 
	cd_unimed_destino_w	:= null;
	cd_unimed_origem_w	:= null;
end;
open c01;
loop 
fetch c01 into 
	nm_pagador_w, 
	ie_tipo_w, 
	ds_endereco_w, 
	cd_cep_w, 
	ds_municipio_w, 
	sg_estado_w, 
	cd_cgc_cpf_w, 
	cd_municipio_ibge_w, 
	ds_complemento_w, 
	ds_bairro_w, 
	nr_ddd_telefone_w, 
	nr_telefone_w, 
	ds_fax_w, 
	nr_endereco_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	 
	ds_endereco_w := replace(replace(ds_endereco_w,'รง','c'),'ร','C');
 
	select	substr(max(cd_ans),1,10) 
	into STRICT	cd_ans_w 
	from	pls_outorgante;
 
	insert into ptu_fatura_cedente(nr_sequencia, 
		nr_seq_fatura, 
		ie_tipo, 
		nm_cedente_sacado, 
		ds_endereco, 
		cd_cep, 
		nm_cidade, 
		sg_uf, 
		cd_cgc_cpf, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		cd_ans, 
		ds_complemento, 
		ds_bairro, 
		nr_inscricao_estadual, 
		nr_ddd, 
		nr_telefone, 
		nr_fax, 
		nr_end) 
	values (nextval('ptu_fatura_cedente_seq'), 
		nr_seq_fatura_p, 
		ie_tipo_w, 
		coalesce(nm_pagador_w,' '), 
		coalesce(ds_endereco_w,' '), 
		coalesce(cd_cep_w,' '), 
		coalesce(ds_municipio_w,' '), 
		coalesce(sg_estado_w,' '), 
		coalesce(cd_cgc_cpf_w,' '), 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_ans_w, 
		ds_complemento_w, 
		ds_bairro_w, 
		cd_municipio_ibge_w, 
		nr_ddd_telefone_w, 
		nr_telefone_w, 
		ds_fax_w, 
		coalesce(nr_endereco_w,'S/N'));
	end;
end loop;
close C01;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_gerar_fatura_cedente (nr_seq_fatura_p bigint, nm_usuario_p text) FROM PUBLIC;

