-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE nut_atualizar_desb_jejum ( dt_impressao_p timestamp, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_dieta_hor_w	bigint;
nr_seq_atend_dia_w	bigint;
nr_prescricao_w		bigint;
dt_servico_w		timestamp;
dt_inicio_w		timestamp;
dt_fim_w		timestamp;

C01 CURSOR FOR 
	SELECT	a.nr_sequencia, 
		nr_prescricao, 
		dt_servico 
	from (	SELECT	distinct 
			c.nr_sequencia, 
			p.nr_prescricao, 
			c.dt_servico 
		from	atendimento_paciente b, 
			unidade_atendimento a, 
			setor_atendimento s, 
			nut_atend_serv_dia c, 
			prescr_medica p 
		where	a.cd_setor_atendimento 	= s.cd_setor_atendimento 
		and	a.nr_atendimento 	= b.nr_atendimento 
		and	c.nr_atendimento 	= a.nr_atendimento 
		and	c.cd_setor_atendimento = a.cd_setor_atendimento 
		and	p.nr_atendimento    = a.nr_atendimento 
		and	(coalesce(p.dt_liberacao,p.dt_liberacao_medico) IS NOT NULL AND (coalesce(p.dt_liberacao,p.dt_liberacao_medico))::text <> '') 
		and	coalesce(p.dt_suspensao::text, '') = ''	 
		and	c.dt_servico between dt_inicio_w and dt_fim_w 
		and	p.dt_prescricao	   between clock_timestamp() - interval '7 days' and clock_timestamp() 
		and	substr(nut_obter_se_saida_jejum(c.dt_servico,c.cd_setor_atendimento,c.nr_atendimento,c.nr_seq_servico),1,1) = 'S' 
		and	(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '') 
		and	exists (	select	1 
				from 	prescr_dieta x 
				where	coalesce(x.ie_suspenso,'N') = 'N' 
				and	x.nr_prescricao = p.nr_prescricao 
				
union
 
				select	1 
				from	prescr_material x 
				where	x.ie_agrupador in (8,12) 
				and	coalesce(x.ie_suspenso,'N') = 'N' 
				and	x.nr_prescricao = p.nr_prescricao) 
		) a 
	where	exists (	select	1 
			from 	prescr_dieta x 
			where	coalesce(x.ie_suspenso,'N') = 'N' 
			and	x.nr_prescricao = a.nr_prescricao				 
			and	not exists (select	1 
					  from	 prescr_dieta_hor d, 
						 prescr_medica e 
					  where x.nr_prescricao = d.nr_prescricao 
					  and	 e.nr_prescricao = x.nr_prescricao	 
					  and	 (d.dt_impressao_nutricao IS NOT NULL AND d.dt_impressao_nutricao::text <> '')) 
		 	and	not exists ( 	select 1 
				  		from  nut_impressao_relatorio x 
						where a.nr_prescricao = x.nr_prescricao 
						and  a.nr_sequencia = x.nr_seq_atend_dia					 
				) 
			
union
 
			select	1 
			from	prescr_material x 
			where	x.ie_agrupador in (8,12) 
			and	coalesce(x.ie_suspenso,'N') = 'N' 
			and	x.nr_prescricao = a.nr_prescricao);		
			 
 
 
	/*SELECT	a.nr_sequencia, 
		nr_prescricao, 
		dt_servico 
	FROM (	SELECT	DISTINCT 
			c.nr_sequencia, 
			nut_obter_dados_serv(c.dt_servico, c.nr_atendimento,c.cd_setor_atendimento, c.nr_seq_servico,'P') nr_prescricao, 
			c.dt_servico 
		FROM	atendimento_paciente b, 
			unidade_atendimento a, 
			setor_atendimento s, 
			nut_atend_serv_dia c 
		WHERE	1 = 1 
		AND	a.cd_setor_atendimento = s.cd_setor_atendimento 
		AND	a.nr_atendimento = b.nr_atendimento 
		AND	c.nr_atendimento = a.nr_atendimento 
		AND	c.cd_setor_atendimento = a.cd_setor_atendimento	 
		AND	c.dt_servico BETWEEN dt_inicio_w AND dt_fim_w 
		AND	SUBSTR(nut_obter_se_saida_jejum(c.dt_servico,c.cd_setor_atendimento,c.nr_atendimento,c.nr_seq_servico),1,1) = 'S' 
		AND	a.nr_atendimento IS NOT NULL 
		AND	a.ie_status_unidade IN ('R','L','H', 'G', 'A','O','E','C','P','M','I','S')) a 
	WHERE	EXISTS(	SELECT	1 
			FROM 	prescr_dieta x 
			WHERE	NVL(x.ie_suspenso,'N') = 'N' 
			AND	x.nr_prescricao = a.nr_prescricao				 
			AND	NOT EXISTS(SELECT	1 
					FROM	prescr_dieta_hor d, 
						prescr_medica e 
					WHERE	x.nr_prescricao = d.nr_prescricao 
					AND	e.nr_prescricao = x.nr_prescricao	 
					AND	d.dt_impressao_nutricao IS NOT NULL) 
	AND	NOT EXISTS( 	SELECT 1 
				FROM  nut_impressao_relatorio x 
				WHERE a.nr_prescricao = x.nr_prescricao 
				AND  a.nr_sequencia = x.nr_seq_atend_dia					 
				) 
			UNION 
			SELECT	1 
			FROM	prescr_material x 
			WHERE	x.ie_agrupador IN(8,12) 
			AND	NVL(x.ie_suspenso,'N') = 'N' 
			AND	x.nr_prescricao = a.nr_prescricao) */
 
					 
 

BEGIN 
 
dt_inicio_w 	:= trunc(dt_impressao_p);
dt_fim_w	:= trunc(dt_impressao_p) + 86399/86400;
 
open c01;
loop 
fetch c01 into 	nr_seq_atend_dia_w, 
		nr_prescricao_w, 
		dt_servico_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin 
		 
		--Mantido por causa de relat√≥rios antigos utilizados. 
		select	max(nr_sequencia) 
		into STRICT	nr_seq_dieta_hor_w 
		from	prescr_dieta_hor a 
		where	a.nr_prescricao = nr_prescricao_w 
		and	to_char(dt_servico_w,'dd/mm/yyyy hh24:mi') = to_char(a.dt_horario,'dd/mm/yyyy hh24:mi') 
		and	(a.dt_desbloqueio_dieta IS NOT NULL AND a.dt_desbloqueio_dieta::text <> '') 
		and	((a.dt_desbloqueio_dieta > a.dt_impressao_nutricao) or (coalesce(a.dt_impressao_nutricao::text, '') = ''));
		 
		update	prescr_dieta_hor 
		set	dt_impressao_nutricao = dt_impressao_p 
		where	nr_sequencia = nr_seq_dieta_hor_w;
		 
		 
		insert	into nut_impressao_relatorio( nr_sequencia, 
				nr_prescricao, 
				nr_seq_atend_dia, 
				ie_tipo_relatorio, 
				dt_impressao, 
				dt_atualizacao, 
				dt_atualizacao_nrec,				 
				nm_usuario,				 
				nm_usuario_nrec) 
		values (nextval('nut_impressao_relatorio_seq'), 
				nr_prescricao_w, 
				nr_seq_atend_dia_w, 
				'TJ', 
				dt_impressao_p, 
				clock_timestamp(), 
				clock_timestamp(), 
				nm_usuario_p, 
				nm_usuario_p);
		 
		 
		end;
end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nut_atualizar_desb_jejum ( dt_impressao_p timestamp, nm_usuario_p text) FROM PUBLIC;

