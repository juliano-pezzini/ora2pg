-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE proj_gerar_oc_rat ( cd_estabelecimento_p bigint, nr_seq_rat_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
dt_emissao_w			timestamp;
dt_inicio_w			timestamp;
dt_final_w			timestamp;
vl_rat_w				double precision;
cd_executor_w			varchar(10);
nr_ordem_compra_w		bigint;

ds_cliente_w			varchar(80);
ds_obs_w			varchar(255);
cd_comprador_w			varchar(10);
cd_cnpj_w			varchar(14);
cd_pessoa_fisica_w		varchar(10);
cd_cond_pagto_w			bigint;	
dt_ordem_compra_w		timestamp;
dt_entrega_w			timestamp;
cd_moeda_w			bigint;
cd_material_w			integer;
cd_unidade_w			varchar(30);
vl_hora_pagar_w			double precision;
qt_hora_pagar_w			double precision;
cd_local_estoque_w		bigint;
IE_STATUS_COBRAR_w		varchar(05);


BEGIN 
 
select	nextval('ordem_compra_seq') 
into STRICT	nr_ordem_compra_w
;
 
select	cd_pessoa_fisica 
into STRICT	cd_comprador_w 
from	usuario 
where	nm_usuario	= nm_usuario_p;
 
select	min(cd_moeda) 
into STRICT	cd_moeda_w 
from	moeda 
where	cd_moeda_banco > 0;
 
select	cd_executor, 
	vl_pagar, 
	dt_inicio, 
	dt_final, 
	substr(obter_desc_cliente(nr_seq_cliente,'N'),1,80), 
	dt_prev_nf, 
	vl_hora_pagar, 
	qt_hora_pagar, 
	IE_STATUS_COBRAR 
into STRICT	cd_executor_w, 
	vl_rat_w, 
	dt_inicio_w, 
	dt_final_w, 
	ds_cliente_w, 
	dt_entrega_w, 
	vl_hora_pagar_w, 
	qt_hora_pagar_w, 
	IE_STATUS_COBRAR_w 
from	proj_rat 
where	nr_sequencia		= nr_seq_rat_p;
 
dt_emissao_w		:= trunc(clock_timestamp(),'dd');
ds_obs_w		:= 'RAT: ' || nr_seq_rat_p || ' ' || ds_cliente_w || ' de: ' || to_char(dt_inicio_w,'dd/mm') || 
			' at√©:' || to_char(dt_final_w,'dd/mm/yyyy');
dt_ordem_compra_w	:= clock_timestamp();
 
if (1=1) then 
	begin 
 
	select	max(cd_cnpj), 
		max(cd_material), 
		max(cd_condicao_pagamento) 
	into STRICT	cd_cnpj_w, 
		cd_material_w, 
		cd_cond_pagto_w 
	from	com_canal_consultor 
	where	cd_pessoa_fisica	= cd_executor_w;
	 
	if (cd_cnpj_w IS NOT NULL AND cd_cnpj_w::text <> '') then 
		cd_executor_w	:= null;
	end if;
 
	if (coalesce(cd_material_w,0) = 0) then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(807136);
	end if;
	 
	select	cd_unidade_medida_compra 
	into STRICT	cd_unidade_w 
	from	material 
	where	cd_material		= cd_material_w;
 
	insert	into ordem_compra( 
		nr_ordem_compra, 
		cd_estabelecimento, 
 		cd_cgc_fornecedor, 
		cd_pessoa_fisica, 
 		cd_condicao_pagamento, 
	 	cd_comprador, 
 		dt_ordem_compra, 
	 	dt_atualizacao, 
 		nm_usuario, 
	 	cd_moeda, 
 		ie_situacao, 
	 	dt_inclusao, 
 		cd_pessoa_solicitante, 
	 	ie_frete, 
		vl_despesa_acessoria, 
	 	pr_multa_atraso, 
 		pr_desconto, 
	 	pr_desc_pgto_antec, 
	 	pr_juros_negociado, 
	 	dt_entrega, 
	 	ie_aviso_chegada, 
		ie_emite_obs, 
		ie_urgente, 
		ie_somente_pagto, 
		ds_observacao, 
		ie_tipo_ordem) 
	values ( 
		nr_ordem_compra_w, 
		cd_estabelecimento_p, 
		cd_cnpj_w, 
		cd_executor_w, 
		cd_cond_pagto_w, 
		cd_comprador_w, 
	   	dt_ordem_compra_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_moeda_w, 
		'A', 
		clock_timestamp(), 
		cd_comprador_w, 
		'N', 
		0, 
		0, 
		0, 
		0, 
		0, 
		dt_entrega_w, 
		'N', 
		'N', 
		'N', 
		'N', 
		ds_obs_w, 
		'J');
 
	insert into ordem_compra_item( 
		nr_ordem_compra, 
		nr_item_oci, 
		cd_material, 
		cd_unidade_medida_compra, 
		vl_unitario_material, 
		qt_material, 
		qt_original, 
		dt_atualizacao, 
		nm_usuario, 
		ie_situacao, 
		qt_material_entregue, 
		pr_descontos, 
		cd_local_estoque, 
		ds_material_direto, 
		vl_total_item) 
	values (	nr_ordem_compra_w, 
		1, 
		cd_material_w, 
		cd_unidade_w, 
		vl_hora_pagar_w, 
		qt_hora_pagar_w, 
		qt_hora_pagar_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		'A', 
		0, 
		0, 
		cd_local_estoque_w, 
		ds_obs_w, 
		round((vl_hora_pagar_w * qt_hora_pagar_w)::numeric,4));
	 
	insert	into ordem_compra_item_entrega( 
		nr_sequencia, 
		nr_ordem_compra, 
		nr_item_oci, 
		dt_prevista_entrega, 
		qt_prevista_entrega, 
		dt_atualizacao, 
		nm_usuario) 
	values (	nextval('ordem_compra_item_entrega_seq'), 
		nr_ordem_compra_w, 
		1, 
		dt_entrega_w, 
		qt_hora_pagar_w, 
		clock_timestamp(), 
		nm_usuario_p);
	 
	CALL gerar_ordem_compra_venc( 
		nr_ordem_compra_w, 
		nm_usuario_p);
	calcular_liquido_ordem_compra( 
		nr_ordem_compra_w, 
		nm_usuario_p);
	CALL Gerar_Aprov_Ordem_Compra(nr_ordem_compra_w, null, 'S', nm_usuario_p);
 
	update	proj_rat 
	set	nr_ordem_compra	= nr_ordem_compra_w 
	where	nr_sequencia	= nr_seq_rat_p;
	end;
end if;
 
commit;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proj_gerar_oc_rat ( cd_estabelecimento_p bigint, nr_seq_rat_p bigint, nm_usuario_p text) FROM PUBLIC;

