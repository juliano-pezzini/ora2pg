-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_historico_dil_red_rec (ie_trigger_p text, ie_acao_executada_p bigint, ie_agrupador_p bigint, nr_prescricao_p bigint, nr_seq_diluicao_p bigint, cd_material_antigo_p bigint, cd_material_atual_p bigint, qt_dose_antiga_p bigint, qt_dose_atual_p bigint, qt_solucao_antiga_p bigint, qt_solucao_atual_p bigint, cd_unidade_medida_antiga_p text, cd_unidade_medida_atual_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_pessoa_alteracao_w			varchar(15);
ie_registra_alter_medico_w		varchar(1):='N';
ie_reg_alter_medico_farm_w		varchar(1):='N';
ds_mensagem_w					varchar(255);


BEGIN
if (coalesce(ie_agrupador_p,0) in (3,7,9)) then
	select	max(cd_pessoa_fisica)
	into STRICT	cd_pessoa_alteracao_w
	from	usuario
	where	nm_usuario = nm_usuario_p;

	if (coalesce(ie_acao_executada_p,0) = 2) then
		if (cd_material_antigo_p <> cd_material_atual_p) then
			insert into	prescr_material_alteracao(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_prescricao,
					nr_seq_prescricao,
					ie_acao,
					cd_pessoa_alteracao,
					ds_alteracao
					)
			values (
					nextval('prescr_material_alteracao_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_prescricao_p,
					nr_seq_diluicao_p,
					CASE WHEN ie_agrupador_p=3 THEN 'DA'  ELSE CASE WHEN ie_agrupador_p=7 THEN 'RA'  ELSE 'R' END  END ,
					cd_pessoa_alteracao_w,
					Wheb_mensagem_pck.get_texto(1076376, 'CD_MATERIAL_ANTIGO_P='||cd_material_antigo_p||';CD_MATERIAL_ATUAL_P='||cd_material_atual_p)
					);
		end if;



		if (qt_dose_antiga_p <> qt_dose_atual_p) then
			insert into	prescr_material_alteracao(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_prescricao,
					nr_seq_prescricao,
					ie_acao,
					cd_pessoa_alteracao,
					ds_alteracao
					)
			values (
					nextval('prescr_material_alteracao_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_prescricao_p,
					nr_seq_diluicao_p,
					CASE WHEN ie_agrupador_p=3 THEN 'DA'  ELSE CASE WHEN ie_agrupador_p=7 THEN 'RA'  ELSE 'R' END  END ,
					cd_pessoa_alteracao_w,
					Wheb_mensagem_pck.get_texto(1076380, 'QT_DOSE_ANTIGA_P='||qt_dose_antiga_p||';QT_DOSE_ATUAL_P='||qt_dose_atual_p)
					);
		end if;



		if (cd_unidade_medida_antiga_p <> cd_unidade_medida_atual_p) then
			insert into	prescr_material_alteracao(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_prescricao,
					nr_seq_prescricao,
					ie_acao,
					cd_pessoa_alteracao,
					ds_alteracao
					)
			values (
					nextval('prescr_material_alteracao_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_prescricao_p,
					nr_seq_diluicao_p,
					CASE WHEN ie_agrupador_p=3 THEN 'DA'  ELSE CASE WHEN ie_agrupador_p=7 THEN 'RA'  ELSE 'R' END  END ,
					cd_pessoa_alteracao_w,
					Wheb_mensagem_pck.get_texto(1076381, 'CD_UNIDADE_MEDIDA_ANTIGA_P='||cd_unidade_medida_antiga_p||';CD_UNIDADE_MEDIDA_ATUAL_P='||cd_unidade_medida_atual_p)
					);

		end if;
		if (qt_solucao_antiga_p <> qt_solucao_atual_p) then
			insert into	prescr_material_alteracao(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_prescricao,
					nr_seq_prescricao,
					ie_acao,
					cd_pessoa_alteracao,
					ds_alteracao
					)
			values (
					nextval('prescr_material_alteracao_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_prescricao_p,
					nr_seq_diluicao_p,
					CASE WHEN ie_agrupador_p=3 THEN 'DA'  ELSE CASE WHEN ie_agrupador_p=7 THEN 'RA'  ELSE 'R' END  END ,
					cd_pessoa_alteracao_w,
					Wheb_mensagem_pck.get_texto(1076382, 'QT_SOLUCAO_ANTIGA_P='||qt_solucao_antiga_p||';QT_SOLUCAO_ATUAL_P='||qt_solucao_atual_p)
					);

		end if;

	elsif (coalesce(ie_acao_executada_p,0) = 3) and (coalesce(cd_material_antigo_p,0) > 0) then
		if (ie_agrupador_p = 3) then
			ds_mensagem_w := Wheb_mensagem_pck.get_texto(1076372, 'CD_MATERIAL_ANTIGO_P='||obter_desc_material(cd_material_antigo_p));
		elsif (ie_agrupador_p = 7) then
			ds_mensagem_w := Wheb_mensagem_pck.get_texto(1076373, 'CD_MATERIAL_ANTIGO_P='||obter_desc_material(cd_material_antigo_p));
		elsif (ie_agrupador_p = 9) then
			ds_mensagem_w := Wheb_mensagem_pck.get_texto(1076374, 'CD_MATERIAL_ANTIGO_P='||obter_desc_material(cd_material_antigo_p));
		end if;

		insert into	prescr_material_alteracao(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_prescricao,
				nr_seq_prescricao,
				ie_acao,
				cd_pessoa_alteracao,
				ds_alteracao
				)
		values (
				nextval('prescr_material_alteracao_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_prescricao_p,
				nr_seq_diluicao_p,
				CASE WHEN ie_agrupador_p=3 THEN 'DA'  ELSE CASE WHEN ie_agrupador_p=7 THEN 'RA'  ELSE 'R' END  END ,
				cd_pessoa_alteracao_w,
				ds_mensagem_w);
				
				
	elsif (coalesce(ie_acao_executada_p,0) = 1) and (coalesce(cd_material_atual_p,0) > 0) then
		
		if (ie_agrupador_p = 3) then
			ds_mensagem_w := Wheb_mensagem_pck.get_texto(1076383, 'CD_MATERIAL_ATUAL_P='||obter_desc_material(cd_material_atual_p));
		elsif (ie_agrupador_p = 7) then
			ds_mensagem_w := Wheb_mensagem_pck.get_texto(1076384, 'CD_MATERIAL_ATUAL_P='||obter_desc_material(cd_material_atual_p));
		elsif (ie_agrupador_p = 9) then
			ds_mensagem_w := Wheb_mensagem_pck.get_texto(1076385, 'CD_MATERIAL_ATUAL_P='||obter_desc_material(cd_material_atual_p));
		end if;
		
		begin
		insert into	prescr_material_alteracao(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_prescricao,
					nr_seq_prescricao,
					ie_acao,
					cd_pessoa_alteracao,
					ds_alteracao
					)
		values (
					nextval('prescr_material_alteracao_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_prescricao_p,
					nr_seq_diluicao_p,
					CASE WHEN ie_agrupador_p=3 THEN 'DA'  ELSE CASE WHEN ie_agrupador_p=7 THEN 'RA'  ELSE 'R' END  END ,
					cd_pessoa_alteracao_w,
					ds_mensagem_w);
		exception when others then
		null;
		end;
	end if;
if (ie_trigger_p = 'N') then
	commit;
end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_historico_dil_red_rec (ie_trigger_p text, ie_acao_executada_p bigint, ie_agrupador_p bigint, nr_prescricao_p bigint, nr_seq_diluicao_p bigint, cd_material_antigo_p bigint, cd_material_atual_p bigint, qt_dose_antiga_p bigint, qt_dose_atual_p bigint, qt_solucao_antiga_p bigint, qt_solucao_atual_p bigint, cd_unidade_medida_antiga_p text, cd_unidade_medida_atual_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

