-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_gerar_conta_guia (nr_interno_conta_p bigint, nr_seq_med_fatur_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_atend_med_p bigint, nr_seq_prot_med_p bigint) AS $body$
DECLARE


nr_seq_tipo_acidente_w		bigint;
ie_tipo_acidente_w		varchar(255);
ie_guia_w			varchar(255);
ie_tiss_tipo_guia_w		varchar(255);
cd_medico_atendimento_w		varchar(255);
cd_autorizacao_w		varchar(255);
nr_doc_conv_principal_w		varchar(255);
cd_autorizacao_regra_w		varchar(255);
nr_seq_guia_w			bigint;
qt_union_w			bigint;
cd_ans_w			varchar(255);
cd_ans_aux_w			varchar(255);
ie_tipo_guia_atend_w		varchar(255);
nr_prescricao_w			varchar(4000);
cd_regional_w			varchar(255);
ds_prescricao_w			varchar(4000);
dt_autorizacao_w		timestamp;
dt_validade_senha_w		timestamp;
dt_entrada_w			timestamp;
nr_sequencia_autor_w		bigint;
nr_prontuario_w			bigint;
ie_tipo_saida_w			varchar(255);
ie_tipo_atend_tiss_w		varchar(255);
ie_tipo_atend_tiss_conta_w	varchar(255);
nr_atendimento_w		bigint;
nr_atendimento_med_w		bigint;
cd_convenio_w			bigint;
nr_seq_proc_consulta_w		bigint;
ie_tipo_atendimento_w		bigint;
ie_tipo_atend_conta_w		bigint;
cont_sem_guia_w			bigint;
qt_proced_w			bigint;
cd_categoria_conv_w		varchar(255);
ie_contrat_med_w		varchar(255);
cd_interno_w			varchar(255);
ds_prestador_tiss_w		varchar(255);
cd_medico_prestador_w		varchar(255);
cd_medico_resp_w		varchar(255);
cd_medico_exec_w		varchar(255);
cd_medico_guia_w		varchar(255);
cd_medico_exec_tiss_w		varchar(255);
cd_autorizacao_princ_w		varchar(255);
cd_autor_princ_atend_periodo_w	varchar(255);
cd_cgc_prestador_w		varchar(255);
cd_cgc_prestador_honor_w	varchar(255);
cd_cgc_prest_solic_regra_w	varchar(255);
cd_cgc_prest_solic_tiss_w	varchar(255);
cd_cgc_estab_w			varchar(255);
cd_autorizacao_tag_w		varchar(255);
ie_cancelamento_w		varchar(255);
cd_senha_atend_w		varchar(255);
ie_guia_princ_honor_w		varchar(255);
ie_contrat_exec_hi_w		varchar(255);
ie_mascara_cid_w		varchar(255);
sg_conselho_compl_id_w		varchar(255);
uf_conselho_compl_id_w		varchar(255);
nr_crm_compl_id_w		varchar(255);
ie_regra_exec_honor_w		varchar(255);
cd_prestador_tiss_w		varchar(255);
ie_total_opm_w			varchar(255);
ie_contratado_consulta_w	varchar(255);
ie_mesma_guia_w			varchar(255);
ds_observacao_w			varchar(4000);
ds_observacao_ww		varchar(4000);
ds_observacao_pacote_w		varchar(4000);
ds_observacao_pacote_ww		varchar(4000);
ie_observacao_w			varchar(255);
cd_estabelecimento_w		bigint;
ie_tipo_protocolo_w		bigint;
nr_seq_protocolo_w		bigint;
nr_seq_procedimento_w		bigint;
nr_endereco_w			varchar(255);
ds_versao_w			varchar(255);
cd_setor_entrada_w		bigint;
cd_setor_entrada_pac_w		bigint;
ie_clinica_w			bigint;
cd_senha_w			varchar(255);
cd_senha_regra_w		varchar(255);
dt_fim_vigencia_w		timestamp;
cd_cgc_solic_w			varchar(255);
cd_cgc_prestador_solic_w	varchar(255);
nr_cpf_solic_w			varchar(255);
cd_interno_solic_w		varchar(255);
nm_contratado_solic_w		varchar(255);
cd_cnes_solic_w			varchar(255);
nm_solicitante_w		varchar(255);
sg_conselho_solic_w		varchar(255);
uf_conselho_solic_w		varchar(255);
cd_cbos_solic_w			varchar(255);
ie_conveniado_w			varchar(255);
cd_medico_solicitante_w		varchar(255);
ie_medico_solic_atend_w		varchar(255);
nr_crm_solic_w			varchar(255);
ie_regra_w			varchar(255);
nr_seq_cbo_saude_w		bigint;
nr_seq_conselho_w		bigint;
cd_cgc_exec_w			varchar(255);
nr_cpf_exec_w			varchar(255);
cd_interno_exec_w		varchar(255);
nm_contratado_exec_w		varchar(255);
cd_cnes_exec_w			varchar(255);
nm_exec_compl_w			varchar(255);
sg_conselho_compl_w		varchar(255);
uf_conselho_compl_w		varchar(255);
cd_cbos_compl_w			varchar(255);
cd_cgc_compl_w			varchar(255);
nr_cpf_compl_w			varchar(255);
cd_interno_compl_w		varchar(255);
ie_tipo_acomodacao_w		varchar(255);
ie_tipo_acomod_autor_w		varchar(255);
nr_crm_compl_w			varchar(255);
ds_endereco_w			varchar(255);
ds_municipio_w			varchar(255);
ie_solicitante_w		varchar(255);
cd_municipio_ibge_w		varchar(255);
cd_cep_w			varchar(255);
sg_estado_w			valor_dominio.vl_dominio%type;
ie_envia_cid_w			varchar(255);
nr_doc_convenio_w		varchar(255)	:= null;
cd_cid_w			varchar(255) 	:= null;
cd_cid_2_w			varchar(255) 	:= null;
cd_cid_3_w			varchar(255) 	:= null;
cd_cid_4_w			varchar(255) 	:= null;
cd_cid_obito_w			varchar(255) 	:= null;
cd_tabela_cid_w			varchar(255) 	:= null;
ds_cid_w			varchar(255) 	:= null;
ie_tipo_cid_w			varchar(255) 	:= null;
ie_unidade_tempo_cid_w		varchar(255) 	:= null;
qt_tempo_cid_w			double precision	:= null;
cd_tabela_cid_obito_w		varchar(255) 	:= null;
ds_cid_obito_w			varchar(255)	:= null;
ie_tipo_cid_2_w			varchar(255) 	:= null;
ie_unidade_tempo_cid_2_w	varchar(255) 	:= null;
qt_tempo_cid_2_w		bigint 	:= null;
ds_cid_2_w			varchar(255) 	:= null;
cd_tabela_cid_2_w		varchar(255) 	:= null;
ie_tipo_cid_3_w			varchar(255) 	:= null;
ie_unidade_tempo_cid_3_w	varchar(255) 	:= null;
qt_tempo_cid_3_w		bigint	:= null;
ds_cid_3_w			varchar(255) 	:= null;
cd_tabela_cid_3_w		varchar(255) 	:= null;
ie_tipo_cid_4_w			varchar(255) 	:= null;
ie_unidade_tempo_cid_4_w	varchar(255) 	:= null;
qt_tempo_cid_4_w		bigint 	:= null;
ds_cid_4_w			varchar(255) 	:= null;
cd_tabela_cid_4_w		varchar(255) 	:= null;
cd_doenca_w			varchar(255) 	:= null;
ie_classif_doenca_w		varchar(255) 	:= null;
ie_tipo_doenca_w		varchar(255) 	:= null;
ie_unidade_tempo_w		varchar(255) 	:= null;
qt_tempo_w			bigint 	:= null;
ds_doenca_w			varchar(255) 	:= null;
cd_tabela_doenca_w		varchar(255) 	:= null;
cd_autorizacao_princ_atend_w	varchar(255) 	:= null;
cd_autor_princ_atend_data_w	varchar(255)	:= null;
vl_gases_w			double precision;
vl_alugueis_w			double precision;
vl_medicamentos_w		double precision;
vl_materiais_w			double precision;
vl_taxas_w			double precision;
vl_taxas_alugueis_w		double precision;
vl_diarias_w			double precision;
vl_total_w			double precision;
vl_outras_despesas_w		double precision;
vl_servicos_w			double precision;
vl_opms_w			double precision;
ie_funcao_medico_w		varchar(255);
cd_medico_executor_w		varchar(255);
cd_cnes_compl_w			varchar(255);
ie_exec_spsadt_w		varchar(255);
ie_totalizar_opm_w		varchar(255);
ie_honorario_w			varchar(255);
cont_w				bigint;
ds_indicacao_w			varchar(255);
ds_diagnostico_w		varchar(255);
ie_regra_solic_w		varchar(255);
ie_ri_zerado_w			varchar(255);
nr_guia_prestador_w		varchar(255);
nr_guia_prestador_ww	        conta_paciente.nr_guia_prestador%type;
nr_guia_prest_proc_w		varchar(255);
ie_guia_prestador_w		varchar(255);
ie_regra_guia_princ_w		varchar(255);
ie_desp_tiss_internado_w	varchar(255);
ie_prestador_w			varchar(255);
ie_responsavel_credito_w	varchar(255);
ie_senha_guia_w			varchar(255);
ie_senha_guia_regra_w		varchar(255);
ie_exec_compl_w			varchar(255);
ie_guia_desp_med_w		varchar(255);
ie_dt_emissao_spsadt_w		varchar(255);
ie_dt_emissao_guia_w		varchar(255);
cd_interno_honor_w		varchar(255);
cd_cgc_honor_w			varchar(255);
nr_cpf_honor_w			varchar(255);
nm_contratado_honor_w		varchar(255);
cd_cnes_honor_w			varchar(255);
dt_nascimento_w			varchar(255);
ie_sexo_w			varchar(255);
cd_pessoa_fisica_w		varchar(255);
ie_tipo_atend_tiss_med_w	varchar(255);
ds_data_assin_benef_w		varchar(255);
ds_data_assin_med_w		varchar(255);
dt_emissao_guia_w		timestamp;
cd_med_solic_tasymed_w		varchar(255);
ie_tipo_atend_proc_w		varchar(255);
cd_procedencia_w		bigint;
ds_observacao_conta_w		varchar(255);
cd_medico_solic_tiss_w		varchar(255);
cd_medico_prof_solic_tiss_w	varchar(255);
ie_senha_guia_princ_w		varchar(255);
cd_autor_princ_atend_cons_w	varchar(255)	:= null;
ie_aplica_regra_w		varchar(255);
cd_funcionario_honor_w		varchar(255);
ie_tipo_guia_conta_w		varchar(255);
cd_senha_autor_w		varchar(255);
ds_function_obs_spsadt_w	varchar(255);
ds_adicional_guia_prest_w	varchar(255);
nr_seq_classif_atend_w		bigint;
ds_adicional_crm_w		varchar(255);
cd_prestador_solic_w		varchar(255);
ds_prestador_solic_w		varchar(255);
cd_medico_honor_tiss_w		varchar(255);
ie_crm_w			varchar(100);
ds_function_obs_cosnulta_w	varchar(255);
ie_dt_autor_sadt_w		varchar(255);
ie_origem_acomod_w		varchar(255);
ie_exec_compl_regra_w		varchar(255);
cd_medico_exec_regra_compl_w	varchar(255);
nr_dnv_w			varchar(255);
nr_seq_dnv_w			bigint;
ie_gravar_log_conta_w		varchar(255);
count_guia_w			bigint;
ie_tipo_guia_w			varchar(255);
ie_tipo_atend_guia_w		bigint;
ie_unica_guia_w			varchar(255);
ie_dt_emiss_guia_regra_w	varchar(255);
ie_dt_validade_senha_ri_w	varchar(10);
cd_senha_autor_conta_w		varchar(255);
cd_medico_contrat_solic_w	varchar(255);
ie_dt_autor_ri_w		varchar(10);
ie_tipo_fatur_tiss_w		varchar(10);
ie_tipo_item_w			varchar(2);
ds_mascara_crm_w		varchar(255);
qt_digitos_crm_w		double precision;
nr_crm_mascara_w		varchar(255);
w_40ASADT_w			varchar(255);
w_41SADT_w			varchar(255);
w_40ASADTH_w			varchar(255);
w_41SADTH_w			varchar(255);
w_45ASADT_w			varchar(255);
w_45ASADTH_w			varchar(255);
cd_prestador_solic_tiss_w	varchar(255);
ds_prestador_solic_tiss_w	varchar(255);
ie_codigo_interno_desp_w	varchar(255);
cd_cgc_fonte_pag_w		varchar(255);
ie_fonte_pagadora_w		varchar(255);
ie_mascara_dnv_w		varchar(255);
cd_medico_convenio_proc_w	varchar(255);
cd_medico_referido_w		varchar(255);
cd_interno_honor_regra_w	varchar(255);
nm_exec_honor_regra_w		varchar(255);
cd_cgc_prest_honor_tiss_w	varchar(255);
ie_crm_contrat_solic_w		varchar(255);
cd_medico_regra_solic_tiss_w	varchar(255);
crm_medico_externo_w		varchar(255);
nm_medico_externo_w		varchar(255);
ie_guia_desp_proc_princ_w	varchar(255);
ie_diag_tipo_atend_w		varchar(255);
dt_periodo_inicial_w		timestamp;
ie_proc_princ_atend_w		varchar(255);
ie_ordenacao_spsadt_w		varchar(10);
ie_ordenacao_ri_w		varchar(10);
nr_seq_tiss_conta_proc_w	bigint;
nr_seq_apres_proc_w		bigint := 0;
nr_seq_guia_proc_w		bigint;
nr_seq_conta_partic_w		bigint;
cd_medico_exec_proc_honor_w	varchar(255);
dt_periodo_final_w		timestamp;
ie_tipo_saida_parcial_w		varchar(10);
qt_proc_guia_w			double precision;
qt_regra_obs_w			bigint;
cd_plano_convenio_w		varchar(10);
dt_mesano_referencia_w		timestamp;
ds_indicacao_proc_w		varchar(255);
ie_prest_solic_odonto_w		varchar(10);
ie_contrat_exec_odonto_w	varchar(10);
ie_prof_exec_odonto_w		varchar(10);
ie_tipo_atend_odont_w		varchar(20);
ie_regra_guia_prest_w		varchar(10);
ie_mesma_guia_prest_w		varchar(10);
nr_seq_regra_exec_honor_w	bigint;
nr_guia_operadora_w		varchar(255);
ie_data_entrada_ri_w		varchar(10);
nr_seq_regra_solic_w		bigint;
ie_honor_partic_w		varchar(1);
nr_guia_prestador_ri_w		tiss_conta_guia.nr_guia_prestador%type;
cd_ausencia_cod_valid_w		tiss_conta_guia.cd_ausencia_cod_valid%type;
cd_validacao_tiss_w		tiss_conta_guia.cd_validacao_tiss%type;

c01 CURSOR FOR	
SELECT	nr_sequencia nr_seq_proc_consulta,		/* gerar uma guia para cada procedimento na guia de consulta senao da erro no xml. */
	ie_tiss_tipo_guia,				-- edgar 25/09/2007, os 69498, tratar guia de consulta
	cd_autorizacao,
	cd_cgc_prestador,
	ie_funcao_medico,
	cd_medico_executor,
	cd_cbos cd_cbos_compl,
	ie_honorario,
	ie_responsavel_credito,
	cd_senha,
	cd_prestador_tiss,
	cd_cgc_prest_solic_tiss,
	cd_medico_solic_tiss,
	cd_medico_exec_tiss,
	ds_prestador_tiss,
	ie_contrat_med,
	null ie_tipo_atend_tiss_med,
	null cd_med_solic_tasymed,
	ie_tipo_atend_tiss ie_tipo_atend_proc,
	cd_medico_prof_solic_tiss,
	cd_funcionario_honor,
	cd_prestador_solic_tiss,
	ds_prestador_solic_tiss,
	cd_medico_honor_tiss,
	'P' ie_tipo_item,
	null,
	null,
	null,
	null,
	null,
	null,
	cd_medico_convenio,
	null cd_cgc_prest_honor_tiss,
	null crm_medico_externo,
	null nm_medico_externo,
	null ie_proc_princ,
	null cd_medico_exec_proc_honor,
	null ds_indicacao_proc,
	nr_guia_prestador,
	nr_guia_operadora
from	tiss_conta_proc
where	nr_interno_conta	= nr_interno_conta_p
and	ie_tiss_tipo_guia	= '3'
group 	by ie_tiss_tipo_guia,
	cd_autorizacao,
	cd_cbos,
	cd_medico_executor,
	ie_funcao_medico,
	cd_cgc_prestador,
	nr_sequencia,
	ie_responsavel_credito,
	ie_honorario,
	cd_senha,
	cd_prestador_tiss,
	cd_cgc_prest_solic_tiss,
	cd_medico_solic_tiss,
	cd_medico_exec_tiss,
	ds_prestador_tiss,
	ie_contrat_med,
	ie_tipo_atend_tiss,
	cd_medico_prof_solic_tiss,
	cd_funcionario_honor,
	cd_prestador_solic_tiss,
	ds_prestador_solic_tiss,
	cd_medico_honor_tiss,
	cd_medico_convenio,
	nr_guia_prestador,
	nr_guia_operadora

union

SELECT	0 nr_seq_proc_consulta,
	ie_tiss_tipo_guia,
	cd_autorizacao,
	cd_cgc_prestador,
	ie_funcao_medico,
	cd_medico_executor,
	cd_cbos,
	ie_honorario,
	ie_responsavel_credito,
	cd_senha,
	cd_prestador_tiss,
	cd_cgc_prest_solic_tiss,
	cd_medico_solic_tiss,
	cd_medico_exec_tiss,
	ds_prestador_tiss,
	ie_contrat_med,
	null ie_tipo_atend_tiss_med,
	null,
	ie_tipo_atend_tiss ie_tipo_atend_proc,
	cd_medico_prof_solic_tiss,
	cd_funcionario_honor,
	cd_prestador_solic_tiss,
	ds_prestador_solic_tiss,
	cd_medico_honor_tiss,
	'P' ie_tipo_item,
	null,
	null,
	null,
	null,
	null,
	null,
	cd_medico_convenio,
	cd_cgc_prest_honor_tiss,
	null crm_medico_externo,
	null nm_medico_externo,
	null ie_proc_princ,
	cd_medico_exec_proc_honor,
	null ds_indicacao_proc,
	nr_guia_prestador,
	nr_guia_operadora
from	tiss_conta_proc
where	nr_interno_conta	= nr_interno_conta_p
and	ie_tiss_tipo_guia	= '6'
group 	by ie_tiss_tipo_guia,
	cd_autorizacao,
	cd_cgc_prestador,
	ie_funcao_medico,
	cd_medico_executor,
	cd_cbos,
	ie_responsavel_credito,
	ie_honorario,
	cd_senha,
	cd_prestador_tiss,
	cd_cgc_prest_solic_tiss,
	cd_medico_solic_tiss,
	cd_medico_exec_tiss,
	ds_prestador_tiss,
	ie_contrat_med,
	ie_tipo_atend_tiss,
	cd_medico_prof_solic_tiss,
	cd_funcionario_honor,
	cd_prestador_solic_tiss,
	ds_prestador_solic_tiss,
	cd_medico_honor_tiss,
	cd_medico_convenio,
	cd_cgc_prest_honor_tiss,
	cd_medico_exec_proc_honor,
	nr_guia_prestador,
	nr_guia_operadora

union

select	0 nr_seq_proc_consulta,
	ie_tiss_tipo_guia,
	cd_autorizacao,
	cd_cgc_prestador,
	null ie_funcao_medico,
	null cd_medico_executor,
	null cd_cbos,
	ie_honorario,
	CASE WHEN ie_honorario='S' THEN  ie_responsavel_credito  ELSE 'X' END  ie_responsavel_credito,
	cd_senha,
	cd_prestador_tiss,
	cd_cgc_prest_solic_tiss,
	cd_medico_solic_tiss,
	coalesce(cd_medico_exec_tiss,cd_medico_honor_tiss),
	ds_prestador_tiss,
	ie_contrat_med,
	null ie_tipo_atend_tiss_med,
	null,
	ie_tipo_atend_tiss ie_tipo_atend_proc,
	cd_medico_prof_solic_tiss,
	cd_funcionario_honor,
	cd_prestador_solic_tiss,
	ds_prestador_solic_tiss,
	cd_medico_honor_tiss,
	'P' ie_tipo_item,
	null,
	null,
	null,
	null,
	null,
	null,
	cd_medico_convenio,
	null cd_cgc_prest_honor_tiss,
	null crm_medico_externo,
	null nm_medico_externo,
	CASE WHEN ie_guia_desp_proc_princ_w='S' THEN TISS_OBTER_PROC_PRINC(nr_interno_conta,nr_sequencia)  ELSE null END  ie_proc_princ,
	null cd_medico_exec_proc_honor,
	null ds_indicacao_proc,
	nr_guia_prestador,
	nr_guia_operadora
from	tiss_conta_proc
where	nr_interno_conta	= nr_interno_conta_p
and	ie_tiss_tipo_guia	= '5'
group 	by ie_tiss_tipo_guia,
	cd_autorizacao,
	cd_cgc_prestador,
	ie_honorario,
	cd_senha,
	cd_prestador_tiss,
	ie_responsavel_credito,
	cd_cgc_prest_solic_tiss,
	cd_medico_solic_tiss,
	coalesce(cd_medico_exec_tiss,cd_medico_honor_tiss),
	ds_prestador_tiss,
	ie_contrat_med,
	ie_tipo_atend_tiss,
	cd_medico_prof_solic_tiss,
	cd_funcionario_honor,
	cd_prestador_solic_tiss,
	ds_prestador_solic_tiss,
	cd_medico_honor_tiss,
	cd_medico_convenio,
	CASE WHEN ie_guia_desp_proc_princ_w='S' THEN TISS_OBTER_PROC_PRINC(nr_interno_conta,nr_sequencia)  ELSE null END ,
	nr_guia_prestador,
	nr_guia_operadora

union
 /*lhalves OS 729884 em 10/11/2014 - Incluido union para geracao da guia de Odonto*/
select	0 nr_seq_proc_consulta,
	ie_tiss_tipo_guia,
	cd_autorizacao,
	cd_cgc_prestador,	
	ie_funcao_medico,
	cd_medico_executor,
	cd_cbos,
	ie_honorario,
	CASE WHEN ie_honorario='S' THEN  ie_responsavel_credito  ELSE 'X' END  ie_responsavel_credito,
	cd_senha,
	cd_prestador_tiss,
	cd_cgc_prest_solic_tiss,
	cd_medico_solic_tiss,
	coalesce(cd_medico_exec_tiss,cd_medico_honor_tiss),
	ds_prestador_tiss,
	ie_contrat_med,
	null ie_tipo_atend_tiss_med,
	null,
	ie_tipo_atend_tiss ie_tipo_atend_proc,
	cd_medico_prof_solic_tiss,
	cd_funcionario_honor,
	cd_prestador_solic_tiss,
	ds_prestador_solic_tiss,
	cd_medico_honor_tiss,
	'P' ie_tipo_item,
	null,
	null,
	null,
	null,
	null,
	null,
	cd_medico_convenio,
	null cd_cgc_prest_honor_tiss,
	null crm_medico_externo,
	null nm_medico_externo,
	CASE WHEN ie_guia_desp_proc_princ_w='S' THEN TISS_OBTER_PROC_PRINC(nr_interno_conta,nr_sequencia)  ELSE null END  ie_proc_princ,
	null cd_medico_exec_proc_honor,
	null ds_indicacao_proc,
	nr_guia_prestador,
	nr_guia_operadora
from	tiss_conta_proc
where	nr_interno_conta	= nr_interno_conta_p
and	ie_tiss_tipo_guia	= '11'
group 	by ie_tiss_tipo_guia,
	cd_autorizacao,
	cd_cgc_prestador,
	ie_funcao_medico,
	cd_medico_executor,
	cd_cbos,
	ie_honorario,
	cd_senha,
	cd_prestador_tiss,
	ie_responsavel_credito,
	cd_cgc_prest_solic_tiss,
	cd_medico_solic_tiss,
	coalesce(cd_medico_exec_tiss,cd_medico_honor_tiss),
	ds_prestador_tiss,
	ie_contrat_med,
	ie_tipo_atend_tiss,
	cd_medico_prof_solic_tiss,
	cd_funcionario_honor,
	cd_prestador_solic_tiss,
	ds_prestador_solic_tiss,
	cd_medico_honor_tiss,
	cd_medico_convenio,
	CASE WHEN ie_guia_desp_proc_princ_w='S' THEN TISS_OBTER_PROC_PRINC(nr_interno_conta,nr_sequencia)  ELSE null END ,
	nr_guia_prestador,
	nr_guia_operadora

union

select	0 nr_seq_proc_consulta,
	ie_tiss_tipo_guia,
	cd_autorizacao,
	cd_cgc_prestador,
	CASE WHEN ie_exec_spsadt_w='S' THEN  ie_funcao_medico WHEN ie_exec_spsadt_w='F' THEN  ie_funcao_medico WHEN ie_exec_spsadt_w='N' THEN  ie_funcao_medico WHEN ie_exec_spsadt_w='R' THEN  ie_funcao_medico WHEN ie_exec_spsadt_w='L' THEN  ie_funcao_medico WHEN ie_exec_spsadt_w='C' THEN  null WHEN ie_exec_spsadt_w='MC' THEN  CASE WHEN obter_se_medico_conveniado(cd_estabelecimento_w, cd_medico_executor, cd_convenio_w, null, null,null,null,null,null, null, null)='S' THEN  ie_funcao_medico  ELSE null END   ELSE null END ,
	CASE WHEN ie_exec_spsadt_w='S' THEN  cd_medico_executor WHEN ie_exec_spsadt_w='F' THEN  cd_medico_executor WHEN ie_exec_spsadt_w='N' THEN  cd_medico_executor WHEN ie_exec_spsadt_w='R' THEN  cd_medico_executor WHEN ie_exec_spsadt_w='L' THEN  cd_medico_executor WHEN ie_exec_spsadt_w='C' THEN  null WHEN ie_exec_spsadt_w='MC' THEN  CASE WHEN obter_se_medico_conveniado(cd_estabelecimento_w, cd_medico_executor, cd_convenio_w, null, null,null,null,null,null, null, null)='S' THEN  cd_medico_executor  ELSE null END   ELSE null END ,
	cd_cbos,
	ie_honorario,
	CASE WHEN ie_honorario='S' THEN  ie_responsavel_credito  ELSE null END ,
	cd_senha,
	cd_prestador_tiss,
	cd_cgc_prest_solic_tiss,
	cd_medico_solic_tiss,
	cd_medico_exec_tiss,
	ds_prestador_tiss,
	ie_contrat_med,
	null ie_tipo_atend_tiss_med,
	null,
	ie_tipo_atend_tiss ie_tipo_atend_proc,
	CASE WHEN coalesce(ie_regra_solic_w,'N')='R' THEN cd_medico_prof_solic_tiss  ELSE null END  cd_medico_prof_solic_tiss,
	cd_funcionario_honor,
	cd_prestador_solic_tiss,
	ds_prestador_solic_tiss,
	cd_medico_honor_tiss,
	'P' ie_tipo_item,
	TISS_OBTER_CONTA_PROC_PREST(nr_sequencia,1),
	TISS_OBTER_CONTA_PROC_PREST(nr_sequencia,2),
	CASE WHEN ie_honorario='S' THEN TISS_OBTER_CONTA_PROC_PREST(nr_sequencia,3)  ELSE TISS_OBTER_CONTA_PROC_PREST(nr_sequencia,1) END ,
	CASE WHEN ie_honorario='S' THEN TISS_OBTER_CONTA_PROC_PREST(nr_sequencia,4)  ELSE TISS_OBTER_CONTA_PROC_PREST(nr_sequencia,2) END ,	
	TISS_OBTER_CONTA_PROC_PREST(nr_sequencia,6),
	CASE WHEN ie_honorario='S' THEN TISS_OBTER_CONTA_PROC_PREST(nr_sequencia,5)  ELSE TISS_OBTER_CONTA_PROC_PREST(nr_sequencia,6) END ,
	CASE WHEN ie_exec_spsadt_w='S' THEN  cd_medico_convenio WHEN ie_exec_spsadt_w='F' THEN  cd_medico_convenio WHEN ie_exec_spsadt_w='N' THEN  cd_medico_convenio WHEN ie_exec_spsadt_w='R' THEN  cd_medico_convenio WHEN ie_exec_spsadt_w='L' THEN  cd_medico_convenio WHEN ie_exec_spsadt_w='C' THEN  null WHEN ie_exec_spsadt_w='MC' THEN  CASE WHEN obter_se_medico_conveniado(cd_estabelecimento_w, cd_medico_convenio, cd_convenio_w, null, null,null,null,null,null, null, null)='S' THEN  cd_medico_convenio  ELSE null END   ELSE null END ,
	null cd_cgc_prest_honor_tiss,
	crm_medico_externo,
	nm_medico_externo,
	CASE WHEN ie_guia_desp_proc_princ_w='S' THEN TISS_OBTER_PROC_PRINC(nr_interno_conta,nr_sequencia)  ELSE null END  ie_proc_princ,
	null cd_medico_exec_proc_honor,
	ds_indicacao_proc ,
	nr_guia_prestador,
	nr_guia_operadora
from	tiss_conta_proc
where	nr_interno_conta	= nr_interno_conta_p
and	ie_tiss_tipo_guia	= '4'
group 	by ie_tiss_tipo_guia,
	cd_autorizacao,
	cd_cgc_prestador,
	CASE WHEN ie_exec_spsadt_w='S' THEN  ie_funcao_medico WHEN ie_exec_spsadt_w='F' THEN  ie_funcao_medico WHEN ie_exec_spsadt_w='N' THEN  ie_funcao_medico WHEN ie_exec_spsadt_w='R' THEN  ie_funcao_medico WHEN ie_exec_spsadt_w='L' THEN  ie_funcao_medico WHEN ie_exec_spsadt_w='C' THEN  null WHEN ie_exec_spsadt_w='MC' THEN  CASE WHEN obter_se_medico_conveniado(cd_estabelecimento_w, cd_medico_executor, cd_convenio_w, null, null, null,null,null,null, null, null)='S' THEN  ie_funcao_medico  ELSE null END   ELSE null END ,
	CASE WHEN ie_exec_spsadt_w='S' THEN  cd_medico_executor WHEN ie_exec_spsadt_w='F' THEN  cd_medico_executor WHEN ie_exec_spsadt_w='N' THEN  cd_medico_executor WHEN ie_exec_spsadt_w='R' THEN  cd_medico_executor WHEN ie_exec_spsadt_w='L' THEN  cd_medico_executor WHEN ie_exec_spsadt_w='C' THEN  null WHEN ie_exec_spsadt_w='MC' THEN  CASE WHEN obter_se_medico_conveniado(cd_estabelecimento_w, cd_medico_executor, cd_convenio_w, null, null, null,null,null,null, null, null)='S' THEN  cd_medico_executor  ELSE null END   ELSE null END ,
	cd_cbos,
	ie_honorario,
	CASE WHEN ie_honorario='S' THEN  ie_responsavel_credito  ELSE null END ,
	cd_senha,
	cd_prestador_tiss,
	cd_cgc_prest_solic_tiss,
	cd_medico_solic_tiss,
	cd_medico_exec_tiss,
	ds_prestador_tiss,
	ie_contrat_med,
	ie_tipo_atend_tiss,
	CASE WHEN coalesce(ie_regra_solic_w,'N')='R' THEN cd_medico_prof_solic_tiss  ELSE null END ,
	cd_funcionario_honor,
	cd_prestador_solic_tiss,
	ds_prestador_solic_tiss,
	cd_medico_honor_tiss,
	TISS_OBTER_CONTA_PROC_PREST(nr_sequencia,1),
	TISS_OBTER_CONTA_PROC_PREST(nr_sequencia,2),
	CASE WHEN ie_honorario='S' THEN TISS_OBTER_CONTA_PROC_PREST(nr_sequencia,3)  ELSE TISS_OBTER_CONTA_PROC_PREST(nr_sequencia,1) END ,
	CASE WHEN ie_honorario='S' THEN TISS_OBTER_CONTA_PROC_PREST(nr_sequencia,4)  ELSE TISS_OBTER_CONTA_PROC_PREST(nr_sequencia,2) END ,
	TISS_OBTER_CONTA_PROC_PREST(nr_sequencia,6),
	CASE WHEN ie_honorario='S' THEN TISS_OBTER_CONTA_PROC_PREST(nr_sequencia,5)  ELSE TISS_OBTER_CONTA_PROC_PREST(nr_sequencia,6) END ,
	CASE WHEN ie_exec_spsadt_w='S' THEN  cd_medico_convenio WHEN ie_exec_spsadt_w='F' THEN  cd_medico_convenio WHEN ie_exec_spsadt_w='N' THEN  cd_medico_convenio WHEN ie_exec_spsadt_w='R' THEN  cd_medico_convenio WHEN ie_exec_spsadt_w='L' THEN  cd_medico_convenio WHEN ie_exec_spsadt_w='C' THEN  null WHEN ie_exec_spsadt_w='MC' THEN  CASE WHEN obter_se_medico_conveniado(cd_estabelecimento_w, cd_medico_convenio, cd_convenio_w, null, null,null,null,null,null, null, null)='S' THEN  cd_medico_convenio  ELSE null END   ELSE null END ,
	crm_medico_externo,
	nm_medico_externo,
	CASE WHEN ie_guia_desp_proc_princ_w='S' THEN TISS_OBTER_PROC_PRINC(nr_interno_conta,nr_sequencia)  ELSE null END ,
	ds_indicacao_proc,
	nr_guia_prestador,
	nr_guia_operadora

union

select	0 nr_seq_proc_consulta,
	a.ie_tiss_tipo_guia_desp,
	a.cd_autorizacao,
	a.cd_cgc_prestador,
	null ie_funcao_medico,
	a.cd_medico_executor cd_medico_executor,
	null cd_cbos,
	'N' ie_honorario,
	'X' ie_responsavel_credito,
	a.cd_senha,
	cd_prestador_tiss,
	cd_cgc_prest_solic_tiss,
	null,
	cd_medico_exec_tiss,
	ds_prestador_tiss,
	null ie_contrat_med,
	null ie_tipo_atend_tiss_med,
	null,
	null ie_tipo_atend_proc,
	null cd_medico_prof_solic_tiss,
	null cd_funcionario_honor,
	cd_prestador_solic_tiss,
	ds_prestador_solic_tiss,
	cd_medico_exec_tiss,
	'D' ie_tipo_item,
	null,
	null,
	null,
	null,
	null,
	null,
	null cd_medico_convenio,
	null cd_cgc_prest_honor_tiss,
	null crm_medico_externo,
	null nm_medico_externo,
	null ie_proc_princ,
	null cd_medico_exec_proc_honor,
	null ds_indicacao_proc,
	null nr_guia_prestador,
	null nr_guia_operadora
from	tiss_conta_desp a
where	a.nr_interno_conta	= nr_interno_conta_p
and	not exists
		(select	1
		 from	tiss_conta_proc x
		 where	x.nr_interno_conta		= a.nr_interno_conta
		 and	x.cd_autorizacao		= a.cd_autorizacao
		 and	((ie_guia_desp_med_w = 'S') or (x.cd_cgc_prestador = a.cd_cgc_prestador))
		 and	x.ie_tiss_tipo_guia		= '4'
		 and	x.ie_tiss_tipo_guia		= a.ie_tiss_tipo_guia_desp 		/* os78939. 10/01/2008. */
		 and	((coalesce(x.ie_honorario, 'N')	= coalesce(a.ie_tiss_desp_honor, 'N')) or	/* edgar 19/03/2009, os 133258, vincular despesa a guia de honoratio spsadt */
			 (not exists /*Incluido este exists pois existem casos em que nao existe guia de honorario so que o ie_tiss_desp_honor esta como 'S', assim cria uma nova guia para as despesas*/
				(select	1
				from	tiss_conta_proc y
				where	y.nr_interno_conta		= a.nr_interno_conta
				and	y.cd_autorizacao		= a.cd_autorizacao
				and	y.ie_tiss_tipo_guia		= '4'
				and	y.ie_tiss_tipo_guia		= a.ie_tiss_tipo_guia_desp
				and	coalesce(y.ie_honorario, 'N')	= 'S')))
		 and	((ie_senha_guia_w <> 'PM') or 	coalesce(x.cd_senha,'X') = coalesce(a.cd_senha,'X'))
		
union

		 select	1
		 from	tiss_conta_proc x
		 where	x.nr_interno_conta		= a.nr_interno_conta
		 and	x.cd_autorizacao		= a.cd_autorizacao
		 and	x.cd_cgc_prestador		= a.cd_cgc_prestador
		 and 	((ie_codigo_interno_desp_w	= 'S' AND x.cd_prestador_tiss		= a.cd_prestador_tiss) or (ie_codigo_interno_desp_w	= 'N'))
		 and	x.ie_tiss_tipo_guia		= a.ie_tiss_tipo_guia_desp
		 and	x.ie_tiss_tipo_guia		= '5'
		 and	((ie_senha_guia_w <> 'PM') or 	coalesce(x.cd_senha,'X') = coalesce(a.cd_senha,'X')))
group 	by a.ie_tiss_tipo_guia_desp,
	a.cd_autorizacao,
	a.cd_cgc_prestador,
	a.cd_medico_executor,
	a.cd_senha,
	cd_prestador_tiss,
	cd_cgc_prest_solic_tiss,
	ds_prestador_tiss,
	cd_medico_exec_tiss,
	cd_prestador_solic_tiss,
	ds_prestador_solic_tiss	

union

select	0 nr_seq_proc_consulta,
	a.ie_tiss_tipo_guia_desp,
	a.cd_autorizacao,
	a.cd_cgc_prestador,
	null ie_funcao_medico,
	null cd_medico_executor,
	null cd_cbos,
	'N' ie_honorario,
	'X' ie_responsavel_credito,
	a.cd_senha,
	a.cd_prestador_tiss,
	cd_cgc_prest_solic_tiss,
	null,
	cd_medico_exec_tiss cd_medico_exec_tiss,
	ds_prestador_tiss,
	null ie_contrat_med,
	null ie_tipo_atend_tiss_med,
	null,
	null ie_tipo_atend_proc,
	null,
	null cd_funcionario_honor,
	null,
	null,
	null,
	'D' ie_tipo_item,
	null,
	null,
	null,
	null,
	null,
	null,
	null cd_medico_convenio,
	null cd_cgc_prest_honor_tiss,
	null crm_medico_externo,
	null nm_medico_externo,
	null ie_proc_princ,
	null cd_medico_exec_proc_honor,
	null ds_indicacao_proc,
	null nr_guia_prestador,
	null nr_guia_operadora
from	tiss_conta_opm_exec a
where	a.nr_interno_conta	= nr_interno_conta_p
and	not exists (select	1
		 from	tiss_conta_proc x
		 where	x.nr_interno_conta		= a.nr_interno_conta
		 and	x.cd_autorizacao		= a.cd_autorizacao
		 and	x.cd_cgc_prestador	= a.cd_cgc_prestador
		 and	x.ie_tiss_tipo_guia		= a.ie_tiss_tipo_guia_desp
		 and	x.ie_tiss_tipo_guia		= '4'
		 and	coalesce(x.ie_honorario, 'N')	= 'N'
		 
union

		 select	1
		 from	tiss_conta_proc x
		 where	x.nr_interno_conta		= a.nr_interno_conta
		 and	x.cd_autorizacao		= a.cd_autorizacao
		 and	x.ie_tiss_tipo_guia		= a.ie_tiss_tipo_guia_desp
		 and	x.cd_cgc_prestador	= a.cd_cgc_prestador 		--os81495.01/02/2008 - tratar o prestador quando for opm.
		 and	x.ie_tiss_tipo_guia		= '5')
group 	by a.cd_autorizacao,
	a.cd_cgc_prestador,
	a.ie_tiss_tipo_guia_desp,
	a.cd_senha,
	a.cd_prestador_tiss,
	cd_cgc_prest_solic_tiss,
	cd_medico_exec_tiss,
	ds_prestador_tiss	

union

select	CASE WHEN a.ie_tiss_tipo_guia=3 THEN  nr_sequencia  ELSE 0 END  nr_seq_proc_consulta, /* Edgar / Diego, 16/10/2009, OS 172711, colocado decode para tratar um procedimento pra cada guia de consulta */
	a.ie_tiss_tipo_guia,
	a.cd_autorizacao,
	a.cd_cgc_prestador,
	a.ie_funcao_medico,
	a.cd_medico_executor,
	a.cd_cbos,
	a.ie_honorario,
	a.ie_responsavel_credito,
	a.cd_senha,
	a.cd_prestador_tiss,
	a.cd_cgc_prest_solic_tiss,
	a.cd_medico_solic_tiss,
	a.cd_medico_exec_tiss,
	a.ds_prestador_tiss,
	a.ie_contrat_med,
	a.ie_tipo_atend_tiss ie_tipo_atend_tiss_med,
	a.cd_med_solic_tasymed,
	a.ie_tipo_atend_tiss ie_tipo_atend_proc,
	a.cd_medico_prof_solic_tiss,
	a.cd_funcionario_honor,
	a.cd_prestador_solic_tiss,
	a.ds_prestador_solic_tiss,
	a.cd_medico_honor_tiss,
	'P' ie_tipo_item,
	null,
	null,
	null,
	null,
	null,
	null,
	null cd_medico_convenio,
	null cd_cgc_prest_honor_tiss,
	null crm_medico_externo,
	null nm_medico_externo,
	null ie_proc_princ,
	null cd_medico_exec_proc_honor,
	null ds_indicacao_proc,
	null nr_guia_prestador,
	null nr_guia_operadora
from	tiss_conta_proc a
where	a.nr_atend_med		= nr_atend_med_p
and	a.nr_seq_prot_med	= nr_seq_prot_med_p
and	a.ie_tiss_tipo_guia		in ('2', '3')
group by	a.ie_tiss_tipo_guia,
	a.cd_autorizacao,
	a.cd_cbos,
	a.cd_medico_executor,
	a.ie_funcao_medico,
	a.cd_cgc_prestador,
	a.nr_sequencia,
	a.ie_responsavel_credito,
	a.ie_honorario,
	a.cd_senha,
	a.cd_prestador_tiss,
	a.cd_cgc_prest_solic_tiss,
	a.cd_medico_solic_tiss,
	a.cd_medico_exec_tiss,
	a.ds_prestador_tiss,
	a.ie_contrat_med,
	a.ie_tipo_atend_tiss,
	a.cd_med_solic_tasymed,
	a.ie_tipo_atend_tiss,
	a.cd_medico_prof_solic_tiss,
	CASE WHEN a.ie_tiss_tipo_guia=3 THEN  nr_sequencia  ELSE 0 END ,
	a.cd_funcionario_honor,
	a.cd_prestador_solic_tiss,
	a.ds_prestador_solic_tiss,
	a.cd_medico_honor_tiss

union

select	0 nr_seq_proc_consulta,
	a.ie_tiss_tipo_guia_desp,
	a.cd_autorizacao,
	a.cd_cgc_prestador,
	null ie_funcao_medico,
	null cd_medico_executor,
	null cd_cbos,
	'N' ie_honorario,
	'X' ie_responsavel_credito,
	a.cd_senha,
	a.cd_prestador_tiss,
	null cd_cgc_prest_solic_tiss,
	null,
	cd_medico_exec_tiss,
	a.ds_prestador_tiss,
	a.ie_contrat_med,
	null ie_tipo_atend_tiss_med,
	null,
	null ie_tipo_atend_proc,
	null,
	null cd_funcionario_honor,
	cd_prestador_solic_tiss,
	ds_prestador_solic_tiss,
	null,
	'D' ie_tipo_item,
	null,
	null,
	null,
	null,
	null,
	null,
	null cd_medico_convenio,
	null cd_cgc_prest_honor_tiss,
	null crm_medico_externo,
	null nm_medico_externo,
	null ie_proc_princ,
	null cd_medico_exec_proc_honor,
	null ds_indicacao_proc,
	null nr_guia_prestador,
	null nr_guia_operadora
from	tiss_conta_desp a
where	a.nr_atend_med		= nr_atend_med_p
and	a.nr_seq_prot_med	= nr_seq_prot_med_p
and	a.ie_tiss_tipo_guia_desp	= '2'
and	not exists (	select	1
			from	tiss_conta_proc x
			where	x.nr_atend_med		= a.nr_atend_med
			and	x.nr_seq_prot_med	= a.nr_seq_prot_med
			and	x.ie_tiss_tipo_guia	in ('2', '3'))
group by	a.ie_tiss_tipo_guia_desp,
	a.cd_autorizacao,
	a.cd_cgc_prestador,
	a.nr_sequencia,
	a.cd_prestador_tiss,
	a.cd_senha,
	a.ds_prestador_tiss,
	a.ie_contrat_med,
	a.cd_medico_exec_tiss,
	cd_prestador_solic_tiss,
	ds_prestador_solic_tiss
order by ie_proc_princ desc;

c02 CURSOR FOR
SELECT	x.cd_doenca,
	x.ie_classificacao_doenca,
	x.ie_tipo_doenca,
	x.ie_unidade_tempo,
	x.qt_tempo,
	x.ds_cid,
	x.cd_tabela_cid,
	x.ds_diagnostico
from 	(SELECT	a.cd_doenca cd_doenca,
		a.ie_classificacao_doenca ie_classificacao_doenca,
	--	nvl(a.ie_tipo_doenca, 'A'), os 120595 - 10/12/2008.
		a.ie_tipo_doenca ie_tipo_doenca,
		a.ie_unidade_tempo ie_unidade_tempo,
		a.qt_tempo qt_tempo,
		substr(obter_desc_cid_doenca(a.cd_doenca),1,70) ds_cid,
		'CID-10' cd_tabela_cid,
		substr(TISS_ELIMINAR_CARACTERE(a.ds_diagnostico),1,255) ds_diagnostico,
		a.dt_diagnostico
	from	cid_doenca c,
		diagnostico_medico b,
		diagnostico_doenca a
	where	a.nr_atendimento		= nr_atendimento_w
	and	a.nr_atendimento		= b.nr_atendimento
	and	a.dt_diagnostico		= b.dt_diagnostico
	and	c.cd_doenca_cid			= a.cd_doenca
	and	((ie_diag_tipo_atend_w		= 'N') or (coalesce(b.ie_tipo_atendimento,ie_tipo_atend_conta_w) = ie_tipo_atend_conta_w))
	and	c.ie_situacao			= 'A'
	and	c.ie_cad_interno		= 'N'
	and   	a.dt_diagnostico = (	select 	max(d.dt_diagnostico)
					from 	diagnostico_doenca d
					where 	d.nr_atendimento = a.nr_atendimento
					and   	d.cd_doenca = a.cd_doenca)
	
union
 	 /*lhalves OS261908 - 24/11/2010 - Feito o union para considerar o CID informado apenas pela categoria*/
	select	a.cd_doenca,
		a.ie_classificacao_doenca,
	--	nvl(a.ie_tipo_doenca, 'A'), os 120595 - 10/12/2008.
		a.ie_tipo_doenca,
		a.ie_unidade_tempo,
		a.qt_tempo,
		substr(obter_desc_cid(a.cd_doenca),1,70) ds_cid,
		'CID-10' cd_tabela_cid,
		substr(TISS_ELIMINAR_CARACTERE(a.ds_diagnostico),1,255),
		a.dt_diagnostico
	from	diagnostico_medico b,
		diagnostico_doenca a
	where	a.nr_atendimento		= nr_atendimento_w
	and	a.nr_atendimento		= b.nr_atendimento
	and	((ie_diag_tipo_atend_w		= 'N') or (coalesce(b.ie_tipo_atendimento,ie_tipo_atend_conta_w) = ie_tipo_atend_conta_w))
	and	a.dt_diagnostico		= b.dt_diagnostico
	and   	a.dt_diagnostico = (	select 	max(d.dt_diagnostico)
					from 	diagnostico_doenca d
					where 	d.nr_atendimento = a.nr_atendimento
					and   	d.cd_doenca = a.cd_doenca)) x 
	order 	by x.dt_diagnostico desc;

c03 CURSOR FOR
SELECT	ie_regra,
	cd_medico_solic_tiss
from	tiss_regra_medico_solic
where	cd_estabelecimento					= cd_estabelecimento_w
and	coalesce(cd_convenio, cd_convenio_w)				= cd_convenio_w
and	coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w,0))		= coalesce(ie_tipo_atendimento_w,0)
and	coalesce(ie_clinica, coalesce(ie_clinica_w,0))		= coalesce(ie_clinica_w,0)
and	coalesce(cd_setor_entrada, coalesce(cd_setor_entrada_w,0))		= coalesce(cd_setor_entrada_w,0)
and	coalesce(cd_medico_atend, coalesce(cd_medico_resp_w,'X'))		= coalesce(cd_medico_resp_w,'X')
--and	nvl(ie_autorizacao,'N')					= 'N'
and	coalesce(ie_tipo_atend_conta,coalesce(ie_tipo_atend_conta_w,0))	= coalesce(ie_tipo_atend_conta_w,0)
order by coalesce(cd_setor_entrada,0),
	coalesce(cd_convenio, 0),
	coalesce(ie_tipo_atendimento, 0),
	coalesce(cd_medico_atend,'X'),
	coalesce(ie_tipo_atend_conta,0);

c04 CURSOR FOR
SELECT	ie_regra,
	coalesce(ie_mesma_guia, 'S'),
	coalesce(ie_mesma_guia_prest, 'S')
from	tiss_regra_guia_princ
where	cd_estabelecimento					= cd_estabelecimento_w
and	cd_convenio						= cd_convenio_w
and	coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w,0))	= coalesce(ie_tipo_atendimento_w,0)
and (ie_tiss_tipo_guia					= ie_tiss_tipo_guia_w) /*or
	 (ie_tiss_tipo_guia					= '2'))  nunca passa tipo de guia 2 no ie_tiss_tipo_guia_w
	 RETIRADO POR LHALVES OS 371872 EM 18/11/2011 - ACABAVA CONSIDERANDO A REGRA DO TIPO DE GUIA 2 PARA OUTRA GUIA E NAO DEVERIA,*/
order by coalesce(ie_tipo_atendimento, 0);

c05 CURSOR FOR
SELECT	substr(tiss_eliminar_caractere(coalesce(tiss_obter_desc_proced(a.nr_sequencia, 0, CASE WHEN a.ie_tiss_tipo_guia='4' THEN  'DS_PROC_SPSADT' WHEN a.ie_tiss_tipo_guia='5' THEN  'DS_PROC_RI' END ),
				coalesce(a.ds_proc_tiss, obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced)))), 1, 60)
from	procedimento_paciente a
where	a.nr_seq_proc_pacote	= a.nr_sequencia
and	a.nr_interno_conta		= nr_interno_conta_p;

c06 CURSOR FOR
SELECT	a.ds_observacao
from	autorizacao_convenio a
where	a.nr_atendimento		= nr_atendimento_w
and	a.cd_autorizacao		= cd_autorizacao_w
and	(trim(both a.ds_observacao) IS NOT NULL AND (trim(both a.ds_observacao))::text <> '');

c07 CURSOR FOR
SELECT	coalesce(ie_senha_guia,'N')
from	tiss_regra_senha
where	cd_estabelecimento						= cd_estabelecimento_w
and	coalesce(cd_convenio, coalesce(cd_convenio_w,0))				= coalesce(cd_convenio_w,0)
and	coalesce(ie_tipo_atend_tiss, coalesce(ie_tipo_atend_tiss_conta_w,'X'))	= coalesce(ie_tipo_atend_tiss_conta_w,'X')
and	coalesce(ie_tipo_guia, coalesce(ie_tiss_tipo_guia_w,'X'))			= coalesce(ie_tiss_tipo_guia_w,'X')
order by	coalesce(cd_convenio, 0),
	coalesce(ie_tipo_atend_tiss,'X'),
	coalesce(ie_tipo_guia,'X');

c08 CURSOR FOR
SELECT	ie_tipo_acidente
from	tiss_tipo_acidente
where	nr_seq_acidente			= nr_seq_tipo_acidente_w
and	coalesce(dt_inicio_vigencia, to_date('01/01/1900','dd/mm/yyyy')) <= dt_entrada_w
order 	by coalesce(dt_inicio_vigencia, to_date('01/01/1900','dd/mm/yyyy'));

c09 CURSOR FOR
SELECT	a.cd_senha
from 	estagio_autorizacao b,
	autorizacao_convenio a
where	a.nr_atendimento	= nr_atendimento_w
and	a.ie_tipo_guia		= ie_tipo_guia_conta_w
and	a.nr_seq_estagio	= b.nr_sequencia
and	b.ie_interno		<> '70' --Cancelado
and	a.dt_inicio_vigencia	=
				(SELECT	max(x.dt_inicio_vigencia)
				from	autorizacao_convenio x
				where	x.nr_atendimento	= a.nr_atendimento
				and	(x.cd_senha IS NOT NULL AND x.cd_senha::text <> '')
				and	x.ie_tipo_guia		= a.ie_tipo_guia);

/*lhalves OS 233502- CID do TasyMed*/

c010 CURSOR FOR
SELECT 	f.cd_doenca_cid cd_doenca,
	f.ie_classificacao ie_classificacao_doenca,
	null ie_tipo_doenca,
	null ie_unidade_tempo,
	null qt_tempo,
	substr(obter_desc_cid_doenca(f.cd_doenca_cid),1,70) ds_cid,
	'CID-10' cd_tabela_cid,
	substr(TISS_ELIMINAR_CARACTERE(f.ds_observacao),1,255) ds_diagnostico
from 	med_atendimento d,
	med_pac_cid f
where	d.nr_atendimento	= nr_atend_med_p
and 	d.nr_seq_cliente	= f.nr_seq_cliente
order by ie_classificacao;

c11 CURSOR FOR
SELECT	nr_dnv
from	nascimento
where	nr_atendimento		= nr_atendimento_w
and	(nr_dnv IS NOT NULL AND nr_dnv::text <> '')
and 	coalesce(dt_inativacao::text, '') = '';

c12 CURSOR FOR
SELECT 	a.ie_tiss_tipo_guia,
	c.ie_tipo_atendimento,
	a.nr_sequencia
from 	tiss_conta_guia a,
	conta_paciente b,
	atendimento_paciente c
where	a.nr_interno_conta	= b.nr_interno_conta
and 	b.nr_atendimento	= c.nr_atendimento
and 	a.nr_interno_conta	= nr_interno_conta_p;

c13 CURSOR FOR
SELECT	coalesce(ie_unica_guia,'N'),
	ie_regra
from	tiss_regra_guia_princ
where	cd_estabelecimento					= cd_estabelecimento_w
and	cd_convenio						= cd_convenio_w
and	coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w,0))	= coalesce(ie_tipo_atend_guia_w,0)
and	((ie_tiss_tipo_guia					= ie_tipo_guia_w) or (ie_tiss_tipo_guia					= '2')) /*nunca passa tipo de guia 2 no ie_tiss_tipo_guia_w*/
order by coalesce(ie_tipo_atendimento, 0);

c14 CURSOR FOR
SELECT	distinct nr_prescricao
from	procedimento_paciente
where	nr_interno_conta		= nr_interno_conta_p
and	coalesce(cd_motivo_exc_conta::text, '') = ''
and	(nr_prescricao IS NOT NULL AND nr_prescricao::text <> '');

c15 CURSOR FOR
SELECT	nr_sequencia
from	tiss_conta_proc
where	nr_seq_guia		= nr_seq_guia_w
and	nr_interno_conta	= nr_interno_conta_p
order by CASE WHEN ie_ordenacao_spsadt_w='1' THEN  ie_via_acesso  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='2' THEN  dt_procedimento  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='2' THEN  dt_inicio_cir  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='3' THEN  CASE WHEN TISS_OBTER_SE_PROC_PRINCIPAL(nr_interno_conta_p,cd_procedimento,nr_seq_proc)='S' THEN  1  ELSE 2 END   ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='3' THEN  dt_procedimento  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='3' THEN  dt_inicio_cir  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='3' THEN  cd_procedimento  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='4' THEN  dt_procedimento  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='4' THEN  dt_inicio_cir  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='4' THEN  cd_procedimento  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='5' THEN  TISS_OBTER_SE_PROC_CIRURGICO(nr_interno_conta_p,nr_seq_proc,nr_sequencia)  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='5' THEN  dt_procedimento  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='5' THEN  dt_inicio_cir  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='6' THEN  ie_via_acesso  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='6' THEN  dt_procedimento  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='6' THEN  cd_procedimento  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='6' THEN  vl_procedimento  ELSE 0 END;
	
c16 CURSOR FOR
SELECT	nr_sequencia
from	tiss_conta_proc
where	nr_seq_guia		= nr_seq_guia_w
and	nr_interno_conta	= nr_interno_conta_p
order by CASE WHEN ie_ordenacao_ri_w='1' THEN dt_procedimento  ELSE null END ,
	CASE WHEN ie_ordenacao_ri_w='1' THEN dt_inicio_cir  ELSE null END ,
	CASE WHEN ie_ordenacao_ri_w='2' THEN TISS_OBTER_SE_PROC_CIRURGICO(nr_interno_conta_p,nr_seq_proc,nr_sequencia)  ELSE '' END ,
	CASE WHEN ie_ordenacao_ri_w='2' THEN dt_procedimento  ELSE null END ,
	CASE WHEN ie_ordenacao_ri_w='2' THEN dt_inicio_cir  ELSE null END ,
	CASE WHEN ie_ordenacao_ri_w='3' THEN dt_procedimento  ELSE null END ,
	CASE WHEN ie_ordenacao_ri_w='3' THEN dt_inicio_cir  ELSE null END ,
	CASE WHEN ie_ordenacao_ri_w='3' THEN vl_procedimento  ELSE 0 END  desc,
	CASE WHEN ie_ordenacao_ri_w='4' THEN dt_procedimento  ELSE null END ,
	CASE WHEN ie_ordenacao_ri_w='4' THEN dt_inicio_cir  ELSE null END ,
	CASE WHEN ie_ordenacao_ri_w='4' THEN vl_procedimento  ELSE 0 END  asc,
	CASE WHEN ie_ordenacao_ri_w='5' THEN cd_procedimento  ELSE 0 END  asc,
	CASE WHEN ie_ordenacao_ri_w='6' THEN cd_procedimento  ELSE 0 END  desc,
	CASE WHEN ie_ordenacao_ri_w='7' THEN  ie_via_acesso  ELSE null END ,
	CASE WHEN ie_ordenacao_ri_w='7' THEN  dt_procedimento  ELSE null END ,
	CASE WHEN ie_ordenacao_ri_w='7' THEN  cd_procedimento  ELSE null END ,
	CASE WHEN ie_ordenacao_ri_w='7' THEN vl_procedimento  ELSE 0 END;

c17 CURSOR FOR
SELECT	a.nr_sequencia,
	b.nr_seq_guia
from	tiss_conta_partic a,
	tiss_conta_proc b
where	a.nr_seq_proc		= b.nr_sequencia
and	a.nr_interno_conta	= b.nr_interno_conta
and	b.nr_interno_conta	= nr_interno_conta_p
and	b.ie_tiss_tipo_guia	= ie_tiss_tipo_guia_w;

c18 CURSOR FOR
SELECT	ie_tipo_atend_odont
from	tiss_regra_atend_odont
where	cd_estabelecimento	= cd_estabelecimento_w
and	coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w,0))		= coalesce(ie_tipo_atendimento_w,0)
and	coalesce(nr_seq_classif_atend, coalesce(nr_seq_classif_atend_w,0))	= coalesce(nr_seq_classif_atend_w,0)
and	coalesce(cd_convenio, coalesce(cd_convenio_w,0))				= coalesce(cd_convenio_w,0)
order by coalesce(ie_tipo_atendimento,0),
	coalesce(nr_seq_classif_atend,0),
	coalesce(cd_convenio,0);
	
c19 CURSOR FOR
SELECT	ie_data_entrada
from	tiss_regra_data_int
where	cd_estabelecimento				= cd_estabelecimento_w
and	coalesce(cd_convenio,coalesce(cd_convenio_w,0))		= coalesce(cd_convenio_w,0)
order by 	coalesce(cd_convenio,0);

c20 CURSOR FOR
SELECT	nr_sequencia
from	tiss_conta_proc a
where	a.nr_seq_guia		= nr_seq_guia_w
and	a.nr_interno_conta	= nr_interno_conta_p
order by a.nr_sequencia,
	a.dt_procedimento,
	a.dt_inicio_cir;


BEGIN

CALL tiss_common_vars_pck.reset_item_sequence();

select	max(ie_cancelamento),
	max(nr_seq_protocolo),
	max(ie_tipo_guia),
	max(ie_tipo_atend_conta),
	max(dt_periodo_inicial),
	max(dt_periodo_final),
	max(ie_tipo_fatur_tiss),
	max(nr_guia_prestador)
into STRICT	ie_cancelamento_w,
	nr_seq_protocolo_w,
	ie_tipo_guia_conta_w,
	ie_tipo_atend_conta_w,
	dt_periodo_inicial_w,
	dt_periodo_final_w,
	ie_tipo_fatur_tiss_w,
	nr_guia_prestador_ww
from	conta_paciente
where	nr_interno_conta	= nr_interno_conta_p;

select	max(to_char(dt_entrada,'dd/mm/yyyy')),
	max(to_char(dt_entrada,'dd/mm/yyyy'))
into STRICT	ds_data_assin_benef_w,
	ds_data_assin_med_w
from	tiss_conta_atend
where	nr_interno_conta	= nr_interno_conta_p;


if (coalesce(ie_cancelamento_w::text, '') = '') or
	((coalesce(nr_atend_med_p,0) > 0) and (coalesce(nr_seq_prot_med_p,0) > 0)) then

	if (coalesce(nr_interno_conta_p,0) > 0) then
	
		begin
		select	coalesce(e.cd_ans,c.cd_ans),
			a.ie_tipo_atend_tiss,
			a.nr_atendimento,
			a.cd_convenio_parametro,
			d.cd_medico_resp,
			tiss_obter_guia_principal(a.nr_atendimento, a.cd_convenio_parametro),
			tiss_obter_guia_data(a.nr_atendimento, a.cd_convenio_parametro, a.dt_periodo_inicial, a.dt_periodo_final, 'A'),
			tiss_obter_guia_data(a.nr_atendimento, a.cd_convenio_parametro, a.dt_periodo_inicial, a.dt_periodo_final, 'C'),
			tiss_obter_guia_data(a.nr_atendimento, a.cd_convenio_parametro, a.dt_periodo_inicial, a.dt_periodo_final, 'CH'),
			a.cd_estabelecimento,
			d.ie_tipo_atendimento,
			a.cd_categoria_parametro,
			d.ie_clinica,
			coalesce(d.ds_observacao,a.ds_observacao),
			a.ds_observacao,
			d.cd_pessoa_fisica,
			d.nr_seq_tipo_acidente,
			coalesce(a.dt_entrada_tiss, d.dt_entrada),
			d.cd_procedencia,
			d.nr_seq_classificacao,
			d.cd_medico_referido,
			a.dt_mesano_referencia
		into STRICT	cd_ans_w,
			ie_tipo_atend_tiss_w,
			nr_atendimento_w,
			cd_convenio_w,
			cd_medico_resp_w,
			cd_autorizacao_princ_atend_w,
			cd_autor_princ_atend_data_w,
			cd_autor_princ_atend_cons_w,
			cd_autor_princ_atend_periodo_w,
			cd_estabelecimento_w,
			ie_tipo_atendimento_w,
			cd_categoria_conv_w,
			ie_clinica_w,
			ds_observacao_w,
			ds_observacao_conta_w,
			cd_pessoa_fisica_w,
			nr_seq_tipo_acidente_w,
			dt_entrada_w,
			cd_procedencia_w,
			nr_seq_classif_atend_w,
			cd_medico_referido_w,
			dt_mesano_referencia_w
		from	pessoa_juridica c,
			convenio_estabelecimento e,
			convenio b,
			atendimento_paciente d,
			conta_paciente a
		where	a.cd_convenio_parametro		= b.cd_convenio
		and	a.nr_atendimento		= d.nr_atendimento
		and	b.cd_cgc			= c.cd_cgc
		and	a.nr_interno_conta		= nr_interno_conta_p
		and 	e.cd_convenio			= a.cd_convenio_parametro
		and 	e.cd_estabelecimento		= a.cd_estabelecimento  LIMIT 1;
		exception
		when others then
			cd_estabelecimento_w	:= null;
			cd_convenio_w		:= null;
		end;

		ie_tipo_acidente_w		:= '2';  -- outros
		open c08;
		loop
		fetch c08 into
			ie_tipo_acidente_w;
		EXIT WHEN NOT FOUND; /* apply on c08 */
		end loop;
		close c08;

	elsif	((coalesce(nr_atend_med_p,0) > 0) and (coalesce(nr_seq_prot_med_p,0) > 0)) then

		select	max(c.cd_ans),
			max(a.nr_atendimento),
			max(b.cd_convenio),
			max(x.cd_medico),
			max(a.cd_guia),
			max(cd_estabelecimento_p),
			max(t.cd_pessoa_fisica),
			max(x.ie_tipo_guia),
			coalesce(ie_tipo_atend_tiss_w, max(d.ie_tipo_atend_tiss))
		into STRICT	cd_ans_w,
			nr_atendimento_med_w,
			cd_convenio_w,
			cd_medico_resp_w,
			cd_autorizacao_princ_atend_w,
			cd_estabelecimento_w,
			cd_pessoa_fisica_w,
			ie_tipo_guia_atend_w,
			ie_tipo_atend_tiss_w
		from	pessoa_juridica c,
			convenio b,
			med_prot_convenio x,
			med_cliente t,
			med_atendimento d,
			med_faturamento a
		where	a.nr_atendimento	= d.nr_atendimento
		and	d.cd_convenio	= b.cd_convenio
		and	t.nr_sequencia	= d.nr_seq_cliente
		and	b.cd_cgc		= c.cd_cgc
		and	a.nr_seq_protocolo	= x.nr_sequencia
		and	a.nr_atendimento	= nr_atend_med_p
		and	a.nr_seq_protocolo	= nr_seq_prot_med_p;

	end if;

	if (coalesce(nr_atendimento_w,0) > 0) then
		begin
		select	b.cd_senha,
			b.ie_tipo_guia,
			b.nr_doc_convenio,
			c.nr_prontuario,
			b.cd_plano_convenio
		into STRICT	cd_senha_atend_w,
			ie_tipo_guia_atend_w,
			nr_doc_convenio_w,
			nr_prontuario_w,
			cd_plano_convenio_w
		from	atend_categoria_convenio b,
			atendimento_paciente a,
			pessoa_fisica c
		where	a.nr_atendimento		= b.nr_atendimento
		and	a.cd_pessoa_fisica		= c.cd_pessoa_fisica		
		and	b.nr_seq_interno		= obter_atecaco_atendimento(a.nr_atendimento)
		and	a.nr_atendimento		= nr_atendimento_w  LIMIT 1;
		exception
		when others then
			cd_senha_atend_w	:= null;
			ie_tipo_guia_atend_w	:= null;
			nr_doc_convenio_w	:= null;
			cd_plano_convenio_w	:= null;
		end;

		/*select	max(b.nr_prontuario)
		into	nr_prontuario_w
		from	atendimento_paciente a,
			pessoa_fisica b
		where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
		and	a.nr_atendimento	= nr_atendimento_w;*/
		
		select	max(obter_setor_atendimento(nr_atendimento_w)),
			(max(obter_primeiro_setor_atend(nr_atendimento_w,'C')))::numeric
		into STRICT	cd_setor_entrada_w,
			cd_setor_entrada_pac_w
		;
	end if;

	select	max(tiss_obter_versao(cd_convenio_w, cd_estabelecimento_w,dt_mesano_referencia_w))
	into STRICT	ds_versao_w
	;

	if (coalesce(ds_versao_w, '2.01.02') <> '2.01.01') and (coalesce(ds_versao_w, '2.01.02') <> '2.01.02') then
		ie_tipo_atend_tiss_conta_w	:= ie_tipo_atend_tiss_w;
		ie_tipo_atend_tiss_w	:= lpad(ie_tipo_atend_tiss_w, 2, 0);
	end if;
	
	if (cd_autorizacao_princ_atend_w = wheb_mensagem_pck.get_texto(1097738)) then
		cd_autorizacao_princ_w	:= null;
	end if;

	select	coalesce(max(ie_medico_solic_atend), 'N'),
		coalesce(max(ie_exec_spsadt), 'N'),
		coalesce(max(ie_totalizar_opm), 'N'),
		coalesce(max(ie_medico_solic_atend), 'N'),
		coalesce(max(ie_ri_zerado), 'S'),
		coalesce(max(ie_solicitante),'MC'),
		coalesce(max(ie_guia_prestador),'C'),
		coalesce(max(ie_desp_tiss_internado), '4'),
		coalesce(max(ie_senha_guia),'ACA'),
		coalesce(max(ie_guia_princ_honor), 'GP'),
		coalesce(max(ie_mascara_cid), 'N'),
		coalesce(max(ie_total_opm), 'N'),
		coalesce(max(ie_contratado_consulta), 'MCP'),
		coalesce(max(ie_contrat_exec_hi), 'M'),
		coalesce(max(ie_observacao), 'N'),
		coalesce(max(ie_guia_desp_med),'N'),
		coalesce(max(ie_dt_emissao_guia),'P'),
		coalesce(max(ie_senha_guia_princ),'N'),
		max(ds_adicional_guia_prest),
		max(ds_function_obs_spsadt),
		max(cd_adic_crm),
		coalesce(max(ie_crm),'N'),
		max(ds_function_obs_consulta),
		coalesce(max(ie_dt_autor_sadt),'A'),
		coalesce(max(ie_tipo_acomod), 'ACAP'),
		coalesce(max(ie_gravar_log_conta),'N'),
		coalesce(max(ie_dt_validade_senha_ri),'D'),
		coalesce(max(ie_dt_autor_ri),'D'),
		max(ds_mascara_crm),
		coalesce(max(ie_codigo_interno_desp),'N'),
		coalesce(max(ie_fonte_pagadora),'ANS'),
		coalesce(max(ie_mascara_dnv),'S'),
		coalesce(max(ie_crm_contrat_solic),'N'),
		coalesce(max(ie_guia_desp_proc_princ),'N'),
		coalesce(max(ie_diag_tipo_atend),'N'),
		coalesce(max(ie_ordenacao_spsadt), '0'),
		coalesce(max(ie_ordenacao_ri),'0'),
		coalesce(max(ie_tipo_saida_parcial),'S'),
		coalesce(max(ie_prest_solic_odonto),'ME'),
		coalesce(max(ie_contrat_exec_odonto),'ME'),
		coalesce(max(ie_prof_exec_odonto),'ME'),
		coalesce(max(ie_data_entrada_ri),'E'),
		coalesce(max(ie_honor_partic), 'S')		
	into STRICT	ie_regra_solic_w,
		ie_exec_spsadt_w,
		ie_totalizar_opm_w,
		ie_medico_solic_atend_w,
		ie_ri_zerado_w,
		ie_solicitante_w,
		ie_guia_prestador_w,
		ie_desp_tiss_internado_w,
		ie_senha_guia_w,
		ie_guia_princ_honor_w,
		ie_mascara_cid_w,
		ie_total_opm_w,
		ie_contratado_consulta_w,
		ie_contrat_exec_hi_w,
		ie_observacao_w,
		ie_guia_desp_med_w,
		ie_dt_emissao_guia_w,
		ie_senha_guia_princ_w,
		ds_adicional_guia_prest_w,
		ds_function_obs_spsadt_w,
		ds_adicional_crm_w,
		ie_crm_w,
		ds_function_obs_cosnulta_w,
		ie_dt_autor_sadt_w,
		ie_origem_acomod_w,
		ie_gravar_log_conta_w,
		ie_dt_validade_senha_ri_w,
		ie_dt_autor_ri_w,
		ds_mascara_crm_w,
		ie_codigo_interno_desp_w,
		ie_fonte_pagadora_w,
		ie_mascara_dnv_w,
		ie_crm_contrat_solic_w,
		ie_guia_desp_proc_princ_w,
		ie_diag_tipo_atend_w,
		ie_ordenacao_spsadt_w,
		ie_ordenacao_ri_w,
		ie_tipo_saida_parcial_w,
		ie_prest_solic_odonto_w,
		ie_contrat_exec_odonto_w,
		ie_prof_exec_odonto_w,
		ie_data_entrada_ri_w,
		ie_honor_partic_w
	from	tiss_parametros_convenio
	where	cd_convenio		= cd_convenio_w
	and	cd_estabelecimento	= cd_estabelecimento_w;

	open c01;
	loop
	fetch c01 into
		nr_seq_proc_consulta_w,
		ie_tiss_tipo_guia_w,
		cd_autorizacao_w,
		cd_cgc_prestador_w,
		ie_funcao_medico_w,
		cd_medico_executor_w,
		cd_cbos_compl_w,
		ie_honorario_w,
		ie_responsavel_credito_w,
		cd_senha_w,
		cd_prestador_tiss_w,
		cd_cgc_prest_solic_tiss_w,
		cd_medico_solic_tiss_w,
		cd_medico_exec_tiss_w,
		ds_prestador_tiss_w,
		ie_contrat_med_w,
		ie_tipo_atend_tiss_med_w,
		cd_med_solic_tasymed_w,
		ie_tipo_atend_proc_w,
		cd_medico_prof_solic_tiss_w,
		cd_funcionario_honor_w,
		cd_prestador_solic_w,
		ds_prestador_solic_w,
		cd_medico_honor_tiss_w,
		ie_tipo_item_w,
		w_40ASADT_w,
		w_41SADT_w,
		w_40ASADTH_w,
		w_41SADTH_w,
		w_45ASADT_w,
		w_45ASADTH_w,
		cd_medico_convenio_proc_w,
		cd_cgc_prest_honor_tiss_w,
		crm_medico_externo_w,
		nm_medico_externo_w,
		ie_proc_princ_atend_w,
		cd_medico_exec_proc_honor_w,
		ds_indicacao_proc_w,
		nr_guia_prest_proc_w,
		nr_guia_operadora_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		

		select	coalesce(max(ie_solicitante),'MC')
		into STRICT	ie_solicitante_w
		from	tiss_parametros_convenio
		where	cd_convenio		= cd_convenio_w
		and	cd_estabelecimento	= cd_estabelecimento_w;

		select	nextval('tiss_conta_guia_seq')
		into STRICT	nr_seq_guia_w
		;

		select	coalesce(max(obter_prestador_convenio(cd_cgc_prestador_w, cd_convenio_w,cd_categoria_conv_w)), max(obter_valor_conv_estab(cd_convenio_w, cd_estabelecimento_w, 'CD_INTERNO'))),
			max(obter_valor_conv_estab(cd_convenio_w, cd_estabelecimento_w, 'CD_REGIONAL'))
		into STRICT	cd_interno_w,
			cd_regional_w
		;

		if	((coalesce(nr_atend_med_p,0) > 0) and (coalesce(nr_seq_prot_med_p,0) > 0))  then

			select	coalesce(ie_tipo_atend_tiss_med_w, max(d.ie_tipo_atend_tiss))
			into STRICT	ie_tipo_atend_tiss_w
			from	pessoa_juridica c,
				convenio b,
				med_prot_convenio x,
				med_cliente t,
				med_atendimento d,
				med_faturamento a
			where	a.nr_atendimento		= d.nr_atendimento
			and	d.cd_convenio		= b.cd_convenio
			and	t.nr_sequencia		= d.nr_seq_cliente
			and	b.cd_cgc			= c.cd_cgc
			and	a.nr_seq_protocolo		= x.nr_sequencia
			and	a.nr_atendimento		= nr_atend_med_p
			and	a.nr_seq_protocolo		= nr_seq_prot_med_p;

				if (coalesce(ds_versao_w, '2.01.02') <> '2.01.01') and (coalesce(ds_versao_w, '2.01.02') <> '2.01.02') then
				ie_tipo_atend_tiss_w	:= lpad(ie_tipo_atend_tiss_w, 2, 0);
			end if;


		end if;

		if (ie_guia_prestador_w = 'C') then
			nr_guia_prestador_w	:= to_char(nr_interno_conta_p);
		elsif (ie_guia_prestador_w = 'G') then
			nr_guia_prestador_w	:= cd_autorizacao_w;
		elsif (ie_guia_prestador_w = 'CG') then
			nr_guia_prestador_w	:= to_char(nr_interno_conta_p) || cd_autorizacao_w;
		elsif (ie_guia_prestador_w = 'CGG') then
			nr_guia_prestador_w	:= to_char(nr_interno_conta_p) || cd_autorizacao_w || ie_tiss_tipo_guia_w;
		elsif (ie_guia_prestador_w = 'GT') then
			nr_guia_prestador_w	:= cd_autorizacao_w || ie_tiss_tipo_guia_w;
		elsif (ie_guia_prestador_w = 'SG') then
			nr_guia_prestador_w	:= nr_seq_guia_w;
		elsif (ie_guia_prestador_w = 'S') then
			nr_guia_prestador_w	:= cd_senha_atend_w;
		elsif (ie_guia_prestador_w = 'P') then
			nr_guia_prestador_w	:= cd_interno_w;
		elsif (ie_guia_prestador_w = 'PR') then
			nr_guia_prestador_w	:= nr_prontuario_w;
		elsif (ie_guia_prestador_w = 'GE') then
			nr_guia_prestador_w	:= nr_doc_convenio_w;
		elsif (ie_guia_prestador_w = 'A') then
			nr_guia_prestador_w	:= nr_atendimento_w;
		elsif (ie_guia_prestador_w = 'R') then
		
			SELECT * FROM TISS_OBTER_GUIA_PRESTADOR(cd_estabelecimento_w, cd_convenio_w, ie_tiss_tipo_guia_w, nr_atendimento_w, nr_interno_conta_p, cd_autorizacao_w, nr_seq_guia_w, nr_guia_prestador_w, ie_regra_guia_prest_w) INTO STRICT nr_guia_prestador_w, ie_regra_guia_prest_w;						
			/* 13 - Guia do procedimento na autorizacao (Autorizado)
			     14 - Numero guia da EUP ou Guia do procedimento na autorizacao (Autorizado)
			*/
			if (ie_regra_guia_prest_w in ('13','14','15','16','21')) then
				nr_guia_prestador_w	:= coalesce(nr_guia_prest_proc_w,nr_guia_prestador_w);
			elsif (ie_regra_guia_prest_w = '22') then
                                nr_guia_prestador_w := nr_guia_prestador_ww;
			end if;			
			
		end if;		

		if (ds_adicional_guia_prest_w IS NOT NULL AND ds_adicional_guia_prest_w::text <> '') then
			nr_guia_prestador_w	:= nr_guia_prestador_w || ds_adicional_guia_prest_w;
		end if;

		select	max(tiss_obter_tipo_saida(CASE WHEN ie_tiss_tipo_guia_w='4' THEN 'SPSADT' WHEN ie_tiss_tipo_guia_w='5' THEN 'I' END , nr_interno_conta_p))
		into STRICT	ie_tipo_saida_w
		;

		ie_tipo_saida_w := tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'IE_TIPO_SAIDA', cd_convenio_w, ie_tipo_saida_w, ie_tipo_atendimento_w,
							 cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@');

		if (coalesce(ie_tipo_saida_parcial_w,'S') = 'N') and (ie_tipo_fatur_tiss_w = 'P') then
			ie_tipo_saida_w	:= null;		
		end if;
		

		cd_autorizacao_tag_w		:= coalesce(nr_guia_operadora_w,cd_autorizacao_w);
		if (cd_autorizacao_w = wheb_mensagem_pck.get_texto(1097738)) then
			cd_autorizacao_tag_w	:= null;
		end if;

		ie_regra_guia_princ_w	:= null;
		open c04;
		loop
		fetch c04 into
			ie_regra_guia_princ_w,
			ie_mesma_guia_w,
			ie_mesma_guia_prest_w;
		EXIT WHEN NOT FOUND; /* apply on c04 */
		end loop;
		close c04;

		select	max(a.cd_autorizacao)
		into STRICT	cd_autorizacao_regra_w
		from	autorizacao_convenio a
		where	a.nr_atendimento	= nr_atendimento_w
		and	a.nr_sequencia		=
			(SELECT		max(x.nr_sequencia)
			from		autorizacao_convenio x
			where		x.nr_atendimento	= a.nr_atendimento
			and		x.cd_autorizacao	= a.cd_autorizacao
			and		x.ie_tipo_autorizacao	= '1');

		select	max(cd_senha),
			max(nr_doc_conv_principal)
		into STRICT	cd_senha_regra_w,
			nr_doc_conv_principal_w
		from	atend_categoria_convenio
		where	nr_atendimento	= nr_atendimento_w
		and	cd_convenio	= cd_convenio_w
		and	obter_atecaco_atendimento(nr_atendimento) = nr_seq_interno;

		cd_autorizacao_princ_w			:= '';
		
		
		if (coalesce(ie_regra_guia_princ_w, 'AG') = 'AG') then
			if (cd_autorizacao_princ_atend_w IS NOT NULL AND cd_autorizacao_princ_atend_w::text <> '') then
				cd_autorizacao_princ_w	:= cd_autorizacao_princ_atend_w;
			else
				cd_autorizacao_princ_w	:= cd_autorizacao_tag_w;
			end if;

		elsif (ie_regra_guia_princ_w = 'GP') then
			cd_autorizacao_princ_w	:= cd_autor_princ_atend_data_w;
		elsif (ie_regra_guia_princ_w = 'GC') then
			cd_autorizacao_princ_w	:= cd_autor_princ_atend_cons_w;
		elsif (ie_regra_guia_princ_w = 'GH') then
			cd_autorizacao_princ_w	:= cd_autor_princ_atend_periodo_w;
		elsif (ie_regra_guia_princ_w = 'A') then
			cd_autorizacao_princ_w	:= nr_doc_conv_principal_w;
		elsif (ie_regra_guia_princ_w = 'N') then
			cd_autorizacao_princ_w	:= null;
		elsif (ie_regra_guia_princ_w = 'SI') then
			cd_autorizacao_princ_w	:= cd_autorizacao_regra_w;
		elsif (ie_regra_guia_princ_w = 'S') then
			cd_autorizacao_princ_w	:= cd_senha_regra_w;
		elsif (ie_regra_guia_princ_w = 'AS') then
			cd_autorizacao_princ_w	:= cd_autorizacao_princ_atend_w || cd_senha_regra_w;
		elsif (ie_regra_guia_princ_w = 'G') then
			cd_autorizacao_princ_w	:= cd_autorizacao_w;
		elsif (ie_regra_guia_princ_w = 'PP') then

			select	max(nr_doc_convenio)
			into STRICT	cd_autorizacao_princ_w
			from	procedimento_paciente
			where	nr_interno_conta	= nr_interno_conta_p
			and	ie_proc_princ_atend	= 'S';

			if (coalesce(cd_autorizacao_princ_w::text, '') = '') then
				select	max(coalesce(obter_proc_principal(nr_atendimento_w, cd_convenio_w, ie_tipo_atendimento_w, nr_interno_conta_p, 'SEQ'), 0))
				into STRICT	nr_seq_procedimento_w
				;

				if (coalesce(nr_seq_procedimento_w, 0) <> 0) then
					select	max(nr_doc_convenio)
					into STRICT	cd_autorizacao_princ_w
					from	procedimento_paciente
					where	nr_sequencia		= nr_seq_procedimento_w
					and	coalesce(cd_motivo_exc_conta::text, '') = '';
				end if;
			end if;
		elsif (ie_regra_guia_princ_w = 'SP') then
			select	max(cd_senha)
			into STRICT	cd_autorizacao_princ_w
			from	procedimento_paciente
			where	nr_interno_conta	= nr_interno_conta_p
			and	ie_proc_princ_atend	= 'S';

			if (coalesce(cd_autorizacao_princ_w::text, '') = '') then
				select	max(coalesce(obter_proc_principal(nr_atendimento_w, cd_convenio_w, ie_tipo_atendimento_w, nr_interno_conta_p, 'SEQ'), 0))
				into STRICT	nr_seq_procedimento_w
				;

				if (coalesce(nr_seq_procedimento_w, 0) <> 0) then
					select	max(cd_senha)
					into STRICT	cd_autorizacao_princ_w
					from	procedimento_paciente
					where	nr_sequencia		= nr_seq_procedimento_w
					and	coalesce(cd_motivo_exc_conta::text, '') = '';
				end if;
			end if;
		elsif (ie_regra_guia_princ_w = 'AC') and (coalesce(nr_interno_conta_p,0) > 0) then
			select	max(cd_autorizacao)
			into STRICT	cd_autorizacao_princ_w
			from	conta_paciente
			where	nr_interno_conta	= nr_interno_conta_p;			
		elsif (ie_regra_guia_princ_w = 'PGA') and (coalesce(nr_interno_conta_p,0) > 0) then
			begin
			select	a.nr_doc_convenio
			into STRICT	cd_autorizacao_princ_w
			from	atend_categoria_convenio a
			where	a.nr_atendimento	= nr_atendimento_w
			and	a.cd_convenio		= cd_convenio_w
			and	a.dt_inicio_vigencia	=
				(SELECT	min(x.dt_inicio_vigencia)
				 from	atend_categoria_convenio x
				 where	x.nr_atendimento	= a.nr_atendimento
				 and	x.cd_convenio		= a.cd_convenio)  LIMIT 1;
			exception
			when others then
				cd_autorizacao_princ_w	:= '';
			end;	
		end if;

		
		select	count(*)
		into STRICT	cont_w
		from	autorizacao_convenio a
		where	a.nr_atendimento	= nr_atendimento_w
		and	a.cd_autorizacao	= cd_autorizacao_w;

		dt_autorizacao_w		:= null;
		dt_fim_vigencia_w		:= null;
		ds_indicacao_w			:= null;

		if (cont_w > 0) then
		
			select	CASE WHEN ie_dt_autor_sadt_w='A' THEN max(a.dt_autorizacao) WHEN ie_dt_autor_sadt_w='I' THEN max(a.dt_inicio_vigencia) WHEN ie_dt_autor_sadt_w='D' THEN  max(a.dt_autorizacao) END , /*lhalves OS252412 em 24/09/2010*/
				max(a.dt_fim_vigencia),
				max(a.dt_fim_vigencia),
				trim(both max(substr(a.ds_indicacao,1,255))),
				max(a.cd_ausencia_cod_valid),
				max(a.cd_validacao_tiss)
			into STRICT	dt_autorizacao_w,
				dt_fim_vigencia_w,
				dt_validade_senha_w,
				ds_indicacao_w,
				cd_ausencia_cod_valid_w,
				cd_validacao_tiss_w
			from	autorizacao_convenio a
			where	a.nr_atendimento	= nr_atendimento_w
			and	a.cd_autorizacao	= cd_autorizacao_w
			and	a.nr_sequencia		=
				(SELECT		max(x.nr_sequencia)
				from		autorizacao_convenio x
				where		x.nr_atendimento	= a.nr_atendimento
				and		x.cd_autorizacao	= a.cd_autorizacao);

			if (ie_dt_autor_sadt_w = 'G') then			
				select	max(a.dt_autorizacao)
				into STRICT	dt_autorizacao_w
				from	autorizacao_convenio a
				where	a.nr_atendimento	= nr_atendimento_w
				and	a.cd_autorizacao	= cd_autorizacao_w
				and	a.ie_tipo_guia		= coalesce(ie_tipo_guia_conta_w,a.ie_tipo_guia)
				and	a.nr_sequencia		=
								(SELECT	max(x.nr_sequencia)
								from	autorizacao_convenio x
								where	x.nr_atendimento	= a.nr_atendimento
								and	x.cd_autorizacao	= a.cd_autorizacao
								and	x.ie_tipo_guia		= a.ie_tipo_guia);				
			end if;	

			if (ie_dt_autor_sadt_w = 'H') then --Data da Autorizacao ou data inicio vigencia do atendimento
			
				select	max(a.dt_autorizacao)
				into STRICT	dt_autorizacao_w
				from	autorizacao_convenio a
				where	a.nr_atendimento	= nr_atendimento_w
				and	a.cd_autorizacao	= cd_autorizacao_w
				and	a.nr_sequencia		=
					(SELECT		max(x.nr_sequencia)
					from		autorizacao_convenio x
					where		x.nr_atendimento	= a.nr_atendimento
					and		x.cd_autorizacao	= a.cd_autorizacao);
				
				if (coalesce(dt_autorizacao_w::text, '') = '') then
				
					begin	--Alterado por lhalves na OS810634 em 27/11/2014, para que sempre busque estes dados com base no periodo da conta
					select	a.dt_inicio_vigencia						
					into STRICT	dt_autorizacao_w						
					from	atend_categoria_convenio a
					where	a.nr_atendimento	= nr_atendimento_w
					and	a.cd_convenio		= cd_convenio_w
					and	a.dt_inicio_vigencia	= 
							(SELECT	max(x.dt_inicio_vigencia)
							from	atend_categoria_convenio x
							where	x.nr_atendimento	= a.nr_atendimento
							and	x.cd_convenio		= a.cd_convenio
							and	dt_periodo_inicial_w 	between x.dt_inicio_vigencia 
											and coalesce(x.dt_final_vigencia,ESTABLISHMENT_TIMEZONE_UTILS.endOfDay(dt_periodo_inicial_w))) LIMIT 1;
					exception
					when others then --Se nao encontra, busca como antes
						select	max(dt_inicio_vigencia)
						into STRICT	dt_autorizacao_w
						from	atend_categoria_convenio
						where	nr_atendimento	= nr_atendimento_w
						and	cd_convenio	= cd_convenio_w;
					end;				
				end if;			
			end if;
			
			/*
			if	(ie_dt_autor_sadt_w = 'K') and
				(Nvl(nr_interno_conta_p,0) > 0)then
			
				select 	nvl(max(dt_periodo_inicial),dt_autorizacao_w)
				into 	dt_autorizacao_w
				from 	conta_paciente
				where 	nr_interno_conta 	= nr_interno_conta_p;
				
			end if;
			*/
		end if;
		
		if (coalesce(nr_interno_conta_p,0) > 0) then
			begin
			
			begin	--Alterado por lhalves na OS810634 em 27/11/2014, para que sempre busque estes dados com base no periodo da conta
			select	CASE WHEN ie_dt_autor_sadt_w='D' THEN  dt_autorizacao_w  ELSE coalesce(dt_autorizacao_w,a.dt_inicio_vigencia) END ,
				coalesce(dt_fim_vigencia_w,a.dt_final_vigencia),
				coalesce(dt_fim_vigencia_w,a.dt_final_vigencia)
			into STRICT	dt_autorizacao_w,
				dt_fim_vigencia_w,
				dt_validade_senha_w
			from	atend_categoria_convenio a
			where	a.nr_atendimento	= nr_atendimento_w
			and	a.cd_convenio		= cd_convenio_w
			and	a.dt_inicio_vigencia	= 
				(SELECT	max(x.dt_inicio_vigencia)
				from	atend_categoria_convenio x
				where	x.nr_atendimento	= a.nr_atendimento
				and	x.cd_convenio		= a.cd_convenio
				and	dt_periodo_inicial_w 	between x.dt_inicio_vigencia 
								and coalesce(x.dt_final_vigencia,ESTABLISHMENT_TIMEZONE_UTILS.endOfDay(dt_periodo_inicial_w))) LIMIT 1;
			exception
			when others then --Se nao encontra, busca como antes
				select	CASE WHEN ie_dt_autor_sadt_w='D' THEN  dt_autorizacao_w  ELSE coalesce(dt_autorizacao_w,max(dt_inicio_vigencia)) END ,
					coalesce(dt_fim_vigencia_w,max(dt_final_vigencia)),
					coalesce(dt_fim_vigencia_w,max(dt_final_vigencia))
				into STRICT	dt_autorizacao_w,
					dt_fim_vigencia_w,
					dt_validade_senha_w
				from	atend_categoria_convenio
				where	nr_atendimento	= nr_atendimento_w
				and	cd_convenio	= cd_convenio_w;
			end;
			
			if (ie_dt_autor_sadt_w = 'K') then
			
				select 	coalesce(max(dt_periodo_inicial),dt_autorizacao_w)
				into STRICT 	dt_autorizacao_w
				from 	conta_paciente
				where 	nr_interno_conta 	= nr_interno_conta_p;
			
			elsif (ie_dt_autor_sadt_w = 'J') then
			
				select	coalesce(min(dt_procedimento),dt_autorizacao_w)
				into STRICT	dt_autorizacao_w	
				from	procedimento_paciente
				where	nr_interno_conta	= nr_interno_conta_p
				and	coalesce(cd_motivo_exc_conta::text, '') = '';
				
			end if;				

			end;
		elsif	((coalesce(nr_atend_med_p,0) > 0) and (coalesce(nr_seq_prot_med_p,0) > 0)) then

			select	max(dt_entrada),
				max(dt_entrada),
				max(dt_entrada)
			into STRICT	dt_autorizacao_w,
				dt_fim_vigencia_w,
				dt_validade_senha_w
			from	med_atendimento a
			where	a.nr_atendimento = nr_atendimento_med_w
			and	a.cd_convenio	 = cd_convenio_w;
		end if;
		

		/*Inicio lhalves OS314453 em 28/04/2011 - Gerar no xml conforme relatorio*/

		if (ie_tiss_tipo_guia_w = '5') then
			if (ie_dt_autor_ri_w = 'D') then
				dt_autorizacao_w := dt_autorizacao_w;
			elsif (ie_dt_autor_ri_w = 'E') then
				select 	coalesce(max(dt_entrada),dt_autorizacao_w)
				into STRICT 	dt_autorizacao_w
				from 	atendimento_paciente
				where 	nr_atendimento	= nr_atendimento_w;
			elsif (ie_dt_autor_ri_w = 'I') then
				dt_autorizacao_w	:= coalesce(tiss_obter_data_internacao(nr_atendimento_w), dt_autorizacao_w);
			elsif (ie_dt_autor_ri_w = 'C') then
				select 	coalesce(max(dt_periodo_inicial),dt_autorizacao_w)
				into STRICT 	dt_autorizacao_w
				from 	conta_paciente
				where 	nr_interno_conta 	= nr_interno_conta_p;
			elsif (ie_dt_autor_ri_w = 'PC') then
				select	coalesce(min(dt_procedimento),dt_autorizacao_w)
				into STRICT	dt_autorizacao_w	
				from	procedimento_paciente
				where	nr_interno_conta		= nr_interno_conta_p
				and	coalesce(cd_motivo_exc_conta::text, '') = '';
			elsif (ie_dt_autor_ri_w = 'AT') then
	
				/*select	max(ie_tipo_fatur_tiss)
				into	ie_tipo_fatur_tiss_w
				from 	conta_paciente
				where	nr_interno_conta	= nr_interno_conta_p;*/
	
				if (ie_tipo_fatur_tiss_w = 'T') then
					select	coalesce(max(b.dt_alta), max(a.dt_alta_tiss))
					into STRICT	dt_autorizacao_w
					from 	conta_paciente a,
						atendimento_paciente b
					where	b.nr_atendimento	= a.nr_atendimento
					and	a.nr_interno_conta	= nr_interno_conta_p;
				else
					dt_autorizacao_w	:= dt_autorizacao_w;
				end if;
			elsif (ie_data_entrada_ri_w = 'R') then			
				open c19;
				loop
				fetch c19 into
				ie_dt_autor_ri_w;
				EXIT WHEN NOT FOUND; /* apply on c19 */
				end loop;
				close c19;				
				if (coalesce(ie_dt_autor_ri_w,'E')	= 'IC') then
					select	max(a.dt_periodo_inicial)
					into STRICT	dt_periodo_inicial_w
					from	conta_paciente a
					where	a.nr_atendimento			= nr_atendimento_w
					and	a.cd_convenio_parametro		= cd_convenio_w
					and	exists (SELECT	1
							from	conta_paciente_guia x
							where	x.nr_interno_conta	= a.nr_interno_conta
							and	x.cd_autorizacao		= cd_autorizacao_w);													
				elsif (coalesce(ie_dt_autor_ri_w,'E')	= 'I') then
					dt_periodo_inicial_w	:= coalesce(tiss_obter_data_internacao(nr_atendimento_w), clock_timestamp());
				elsif (coalesce(ie_dt_autor_ri_w,'E')	= 'A') then
					dt_periodo_inicial_w	:= coalesce(to_date(obter_dados_atendimento(nr_atendimento_w,'DA'),'dd/mm/yyyy hh24:mi:ss'), clock_timestamp());
				elsif (coalesce(ie_dt_autor_ri_w,'E')	= 'EA') then					
					select	max(dt_envio)
					into STRICT	dt_periodo_inicial_w
					from	autorizacao_convenio
					where	nr_atendimento	= nr_atendimento_w
					and	cd_autorizacao	= cd_autorizacao_w;
					dt_periodo_inicial_w	:= coalesce(dt_periodo_inicial_w,clock_timestamp());
				end if;
			end if;
		end if;

		if (ie_dt_validade_senha_ri_w = 'D') then
			dt_validade_senha_w	:= dt_validade_senha_w;
			dt_fim_vigencia_w	:= dt_validade_senha_w;

		elsif (ie_dt_validade_senha_ri_w = 'A') then
			dt_validade_senha_w	:= coalesce(Obter_data_alta_Atendimento(nr_atendimento_w),dt_validade_senha_w);
			dt_fim_vigencia_w	:= dt_validade_senha_w;

		elsif (ie_dt_validade_senha_ri_w = 'C') then
			select 	coalesce(max(dt_periodo_final),dt_validade_senha_w)
			into STRICT 	dt_validade_senha_w
			from 	conta_paciente
			where 	nr_interno_conta 	= nr_interno_conta_p;

			dt_fim_vigencia_w	:= dt_validade_senha_w;
		elsif (ie_dt_validade_senha_ri_w = 'DA') then	--lhalves OS 363257 em 23/09/2011				
			if (cont_w = 0) then
				dt_validade_senha_w := null;
			else
				dt_validade_senha_w	:= dt_validade_senha_w;
			end if;			
			dt_fim_vigencia_w	:= dt_validade_senha_w;			
		end if;

		cd_medico_guia_w		:= cd_medico_resp_w;
		if (ie_tiss_tipo_guia_w	in ('6','3')) or
			((ie_tiss_tipo_guia_w	= '4') and (ie_exec_spsadt_w in ('MC', 'S', 'F', 'R','L')))  then
			cd_medico_guia_w	:= coalesce(cd_medico_exec_tiss_w, cd_medico_executor_w);
		end if;

		/*
		lhalves OS257115 em 13/10/2010 - Incluido o if abaixo.
		Para a guia de SP/SADT sem procedimento (referencia das despesas), nao gerava o medico executor complementar conforme a regra,
		pois nao existe o cd_medico_guia_w carregado acima.
		*/
		if	((ie_tiss_tipo_guia_w		= '4') and (ie_exec_spsadt_w 		= 'R') and (coalesce(ie_tipo_item_w,'P') 	= 'D')) then --Somente para despesas
			SELECT * FROM TISS_OBTER_REGRA_EXEC_COMPL(	cd_convenio_w, cd_estabelecimento_p, null, null, null, null, null, ie_tipo_atendimento_w, cd_setor_entrada_w, ie_responsavel_credito_w, ie_tiss_tipo_guia_w, coalesce(cd_medico_exec_tiss_w,cd_medico_resp_w), ie_exec_compl_regra_w, cd_medico_exec_regra_compl_w, cd_setor_entrada_pac_w, null) INTO STRICT ie_exec_compl_regra_w, cd_medico_exec_regra_compl_w;

			if (ie_gravar_log_conta_w = 'S') then
				CALL TISS_GERAR_LOG_CONTA(	nr_interno_conta_p,
							'Regra Exec Comple (Gerar conta guia) > '||
							' Seq Guia: '||nr_seq_guia_w||
							' Guia: '||ie_tiss_tipo_guia_w||
							' Resp Credito: '||ie_responsavel_credito_w||
							' Tipo Item: '||ie_tipo_item_w||
							' Exec SPSADT: '||ie_exec_spsadt_w||
							' Medico Exec TISS: '||cd_medico_exec_tiss_w||
							' Medico Atend '||cd_medico_resp_w||
							' Retorno Regra > '||
							' Exec Compl (IE_REGRA): '||ie_exec_compl_regra_w||
							' Medico Regra: '||cd_medico_exec_regra_compl_w,
							nm_usuario_p);
			end if;

			if (ie_exec_compl_regra_w = 'MA') then --Medico do atendimento
				cd_medico_guia_w	:= cd_medico_resp_w;
			elsif (ie_exec_compl_regra_w = 'IR') then --Informado na regra
				cd_medico_guia_w	:= cd_medico_exec_regra_compl_w;
			elsif (ie_exec_compl_regra_w = 'N') then
				cd_medico_guia_w	:= null;
			elsif (ie_exec_compl_regra_w = 'ME') and --lhalves OS319088 17/06/2011
				(coalesce(cd_medico_exec_tiss_w::text, '') = '') then
				cd_medico_guia_w	:= null;
			end if;
		end if;

		ie_envia_cid_w := tiss_obter_se_gera_cid(nr_interno_conta_p, null, ie_tiss_tipo_guia_w, ie_envia_cid_w, nm_usuario_p);

		if (ie_envia_cid_w = 'S') then

			cd_cid_w			:= null;
			ie_tipo_cid_w			:= null;
			ie_unidade_tempo_cid_w		:= null;
			qt_tempo_cid_w			:= null;
			ds_cid_w			:= null;
			cd_tabela_cid_w			:= null;
			cd_cid_2_w			:= null;
			ie_tipo_cid_2_w			:= null;
			ie_unidade_tempo_cid_2_w	:= null;
			qt_tempo_cid_2_w		:= null;
			ds_cid_2_w			:= null;
			cd_tabela_cid_2_w		:= null;
			cd_cid_3_w			:= null;
			ie_tipo_cid_3_w			:= null;
			ie_unidade_tempo_cid_3_w	:= null;
			qt_tempo_cid_3_w		:= null;
			ds_cid_3_w			:= null;
			cd_tabela_cid_3_w		:= null;
			cd_cid_4_w			:= null;
			ie_tipo_cid_4_w			:= null;
			ie_unidade_tempo_cid_4_w	:= null;
			qt_tempo_cid_4_w		:= null;
			ds_cid_4_w			:= null;
			cd_tabela_cid_4_w		:= null;

			if (coalesce(nr_atend_med_p,0) = 0) then
				open c02;
				loop
				fetch c02 into
					cd_doenca_w,
					ie_classif_doenca_w,
					ie_tipo_doenca_w,
					ie_unidade_tempo_w,
					qt_tempo_w,
					ds_doenca_w,
					cd_tabela_doenca_w,
					ds_diagnostico_w;
				EXIT WHEN NOT FOUND; /* apply on c02 */

					if (coalesce(ds_indicacao_w::text, '') = '') and (ds_diagnostico_w IS NOT NULL AND ds_diagnostico_w::text <> '') then
						ds_indicacao_w	:= trim(both ds_diagnostico_w);
					end if;

					if (coalesce(ds_indicacao_w::text, '') = '') and (coalesce(ds_diagnostico_w::text, '') = '') then
						ds_indicacao_w	:= trim(both ds_doenca_w);
					end if;

					if (ie_mascara_cid_w	= 'S') then
						cd_doenca_w	:= tiss_obter_cid_mascara(cd_doenca_w);
					end if;

					if (coalesce(cd_cid_w::text, '') = '') and (coalesce(ie_classif_doenca_w,'P') = 'P') then --lhalves OS292563 25/02/2011
						cd_cid_w			:= cd_doenca_w;
						ie_tipo_cid_w			:= ie_tipo_doenca_w;
						ie_unidade_tempo_cid_w		:= ie_unidade_tempo_w;
						qt_tempo_cid_w			:= qt_tempo_w;
						ds_cid_w			:= ds_doenca_w;
						cd_tabela_cid_w			:= cd_tabela_doenca_w;
					elsif (coalesce(cd_cid_2_w::text, '') = '') and (coalesce(ie_classif_doenca_w,'S') = 'S') then --lhalves OS292563 25/02/2011
						cd_cid_2_w			:= cd_doenca_w;
						ie_tipo_cid_2_w			:= ie_tipo_doenca_w;
						ie_unidade_tempo_cid_2_w	:= ie_unidade_tempo_w;
						qt_tempo_cid_2_w		:= qt_tempo_w;
						ds_cid_2_w			:= ds_doenca_w;
						cd_tabela_cid_2_w		:= cd_tabela_doenca_w;
					elsif (coalesce(cd_cid_3_w::text, '') = '') then
						cd_cid_3_w			:= cd_doenca_w;
						ie_tipo_cid_3_w			:= ie_tipo_doenca_w;
						ie_unidade_tempo_cid_3_w	:= ie_unidade_tempo_w;
						qt_tempo_cid_3_w		:= qt_tempo_w;
						ds_cid_3_w			:= ds_doenca_w;
						cd_tabela_cid_3_w		:= cd_tabela_doenca_w;
					elsif (coalesce(cd_cid_4_w::text, '') = '') then
						cd_cid_4_w			:= cd_doenca_w;
						ie_tipo_cid_4_w			:= ie_tipo_doenca_w;
						ie_unidade_tempo_cid_4_w	:= ie_unidade_tempo_w;
						qt_tempo_cid_4_w		:= qt_tempo_w;
						ds_cid_4_w			:= ds_doenca_w;
						cd_tabela_cid_4_w		:= cd_tabela_doenca_w;
					end if;
				end loop;
				close c02;
			else
				open c010;
				loop
				fetch c010 into
					cd_doenca_w,
					ie_classif_doenca_w,
					ie_tipo_doenca_w,
					ie_unidade_tempo_w,
					qt_tempo_w,
					ds_doenca_w,
					cd_tabela_doenca_w,
					ds_diagnostico_w;
				EXIT WHEN NOT FOUND; /* apply on c010 */

					if (coalesce(ds_indicacao_w::text, '') = '') and (ds_diagnostico_w IS NOT NULL AND ds_diagnostico_w::text <> '') then
						ds_indicacao_w	:= trim(both ds_diagnostico_w);
					end if;

					if (coalesce(ds_indicacao_w::text, '') = '') and (coalesce(ds_diagnostico_w::text, '') = '') then
						ds_indicacao_w	:= trim(both ds_doenca_w);
					end if;

					if (ie_mascara_cid_w	= 'S') then
						cd_doenca_w	:= tiss_obter_cid_mascara(cd_doenca_w);
					end if;

					if (coalesce(cd_cid_w::text, '') = '') then
						cd_cid_w			:= cd_doenca_w;
						ie_tipo_cid_w			:= ie_tipo_doenca_w;
						ie_unidade_tempo_cid_w		:= ie_unidade_tempo_w;
						qt_tempo_cid_w			:= qt_tempo_w;
						ds_cid_w			:= ds_doenca_w;
						cd_tabela_cid_w			:= cd_tabela_doenca_w;
					elsif (coalesce(cd_cid_2_w::text, '') = '') then
						cd_cid_2_w			:= cd_doenca_w;
						ie_tipo_cid_2_w			:= ie_tipo_doenca_w;
						ie_unidade_tempo_cid_2_w	:= ie_unidade_tempo_w;
						qt_tempo_cid_2_w		:= qt_tempo_w;
						ds_cid_2_w			:= ds_doenca_w;
						cd_tabela_cid_2_w		:= cd_tabela_doenca_w;
					elsif (coalesce(cd_cid_3_w::text, '') = '') then
						cd_cid_3_w			:= cd_doenca_w;
						ie_tipo_cid_3_w			:= ie_tipo_doenca_w;
						ie_unidade_tempo_cid_3_w	:= ie_unidade_tempo_w;
						qt_tempo_cid_3_w		:= qt_tempo_w;
						ds_cid_3_w			:= ds_doenca_w;
						cd_tabela_cid_3_w		:= cd_tabela_doenca_w;
					elsif (coalesce(cd_cid_4_w::text, '') = '') then
						cd_cid_4_w			:= cd_doenca_w;
						ie_tipo_cid_4_w			:= ie_tipo_doenca_w;
						ie_unidade_tempo_cid_4_w	:= ie_unidade_tempo_w;
						qt_tempo_cid_4_w		:= qt_tempo_w;
						ds_cid_4_w			:= ds_doenca_w;
							cd_tabela_cid_4_w		:= cd_tabela_doenca_w;
					end if;
				end loop;
				close c010;
			end if;
		end if;
		
		if (ds_indicacao_proc_w IS NOT NULL AND ds_indicacao_proc_w::text <> '') then --Considerar a indicacao clinica do procedimento na prescricao
			ds_indicacao_w	:= ds_indicacao_proc_w;
		end if;

		select	max(nr_sequencia),
			max(tiss_obter_tipo_acomod(cd_tipo_acomodacao))
		into STRICT	nr_sequencia_autor_w,
			ie_tipo_acomod_autor_w
		from	autorizacao_convenio
		where	nr_atendimento	= nr_atendimento_w
		and	cd_autorizacao	= cd_autorizacao_w;

		if (coalesce(ie_tipo_acomod_autor_w, 'X') <> 'X') and (ie_origem_acomod_w = 'ACAP') then /*lhalves OS250809 29/09/2010 - Fazer o update com o tipo de acomod da autor, se o parametro estiver configurado.*/
			update	tiss_conta_atend
			set	ie_tipo_acomodacao	= ie_tipo_acomod_autor_w
			where	nr_interno_conta	= nr_interno_conta_p;
		end if;

		/*lhalves OS248653 em 13/09/2010*/

		update	tiss_conta_atend
		set 	nr_cartao_nac_sus	= tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'NR_CARTAO_NAC_SUS', cd_convenio_w, nr_cartao_nac_sus, ie_tipo_atendimento_w,
							 	cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			ie_tipo_acidente	= tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'IE_TIPO_ACIDENTE', cd_convenio_w, ie_tipo_acidente, ie_tipo_atendimento_w,
							 	cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			ie_tipo_saida_consulta	= tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'IE_TIPO_SAIDA', cd_convenio_w, ie_tipo_saida_consulta, ie_tipo_atendimento_w,
							 	cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			ie_carater_internacao	= tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'IE_CARATER_SOLIC', cd_convenio_w, ie_carater_internacao, ie_tipo_atendimento_w,
							 	cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			ie_tipo_acomodacao	= substr(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'IE_TIPO_ACOMODACAO', cd_convenio_w, ie_tipo_acomodacao, ie_tipo_atendimento_w,
							 	cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),1,29),
			ie_tipo_consulta	= substr(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'IE_TIPO_CONSULTA', cd_convenio_w, ie_tipo_consulta, ie_tipo_atendimento_w,
							 	cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),1,29)								
		where 	nr_interno_conta	= nr_interno_conta_p;

		if (coalesce(nr_interno_conta_p,0) > 0) then
			if (coalesce(ie_dt_emissao_guia_w,'P') = 'P') then
				select	min(dt_procedimento)
				into STRICT	dt_emissao_guia_w
				from	procedimento_paciente
				where	nr_interno_conta		= nr_interno_conta_p
				and	coalesce(cd_motivo_exc_conta::text, '') = '';
			elsif (coalesce(ie_dt_emissao_guia_w,'P') = 'A') then
				select	max(dt_autorizacao)
				into STRICT	dt_emissao_guia_w
				from	autorizacao_convenio
				where	nr_atendimento		= nr_atendimento_w
				and	cd_autorizacao		= cd_autorizacao_w;

			elsif (coalesce(ie_dt_emissao_guia_w,'P') = 'T') then
				select	max(dt_entrada)
				into STRICT	dt_emissao_guia_w
				from	atendimento_paciente
				where	nr_atendimento		= nr_atendimento_w;
			elsif (coalesce(ie_dt_emissao_guia_w,'P') = 'AA') then
				select	max(dt_autorizacao)
				into STRICT	dt_emissao_guia_w
				from	autorizacao_convenio
				where	nr_atendimento		= nr_atendimento_w
				and	cd_autorizacao		= cd_autorizacao_w;
				if (coalesce(dt_emissao_guia_w::text, '') = '') then
					select	max(dt_autorizacao)
					into STRICT	dt_emissao_guia_w
					from	autorizacao_convenio
					where	nr_atendimento		= nr_atendimento_w;
				end if;
			elsif (coalesce(ie_dt_emissao_guia_w,'P') = 'IA') then
				select	max(dt_inicio_vigencia)
				into STRICT	dt_emissao_guia_w
				from	autorizacao_convenio
				where	nr_atendimento		= nr_atendimento_w
				and	cd_autorizacao		= cd_autorizacao_w;
			elsif (coalesce(ie_dt_emissao_guia_w,'P') = 'IC') then
				select	max(dt_periodo_inicial)
				into STRICT	dt_emissao_guia_w
				from	conta_paciente
				where	nr_interno_conta	= nr_interno_conta_p;
			elsif (coalesce(ie_dt_emissao_guia_w,'P') = 'FC') then
				select	max(dt_periodo_final)
				into STRICT	dt_emissao_guia_w
				from	conta_paciente
				where	nr_interno_conta	= nr_interno_conta_p;
			elsif (coalesce(ie_dt_emissao_guia_w,'P') = 'CR') then /*lhalves OS262797 em 6/11/2010*/
				

				ie_dt_emiss_guia_regra_w	:= TISS_OBTER_REGRA_DATA_GUIA(cd_estabelecimento_p,cd_convenio_w,ie_tiss_tipo_guia_w, ltrim(ie_tipo_atend_tiss_w,'0'),ie_clinica_w);

				if (ie_dt_emiss_guia_regra_w = 'A') then
					select	max(dt_entrada)
					into STRICT	dt_emissao_guia_w
					from	atendimento_paciente
					where	nr_atendimento		= nr_atendimento_w;
				elsif (ie_dt_emiss_guia_regra_w = 'AUSG') then
					select	max(dt_autorizacao)
					into STRICT	dt_emissao_guia_w
					from	autorizacao_convenio
					where	nr_atendimento		= nr_atendimento_w
					and	cd_autorizacao		= cd_autorizacao_w;
					if (coalesce(dt_emissao_guia_w::text, '') = '') then
						select	max(dt_autorizacao)
						into STRICT	dt_emissao_guia_w
						from	autorizacao_convenio
						where	nr_atendimento	= nr_atendimento_w;
					end if;
				elsif (ie_dt_emiss_guia_regra_w = 'IA') then
					select	max(a.dt_inicio_vigencia)
					into STRICT	dt_emissao_guia_w
					from	atend_categoria_convenio a
					where	a.nr_atendimento	= nr_atendimento_w
					and	a.nr_seq_interno	= Obter_Atecaco_Atend_conv(nr_atendimento_w, cd_convenio_w);
				end if;
			end if;

			begin
			select	1
			into STRICT	qt_proced_w
			from	tiss_conta_proc
			where	nr_interno_conta	= nr_interno_conta_p
			and	ie_tiss_tipo_guia	= ie_tiss_tipo_guia_w  LIMIT 1;
			exception
			when others then
				qt_proced_w	:= 0;
			end;

		else
			dt_emissao_guia_w	:= clock_timestamp();

			begin
			select	1
			into STRICT	qt_proced_w
			from	tiss_conta_proc a
			where	a.ie_tiss_tipo_guia	= ie_tiss_tipo_guia_w
			and	a.nr_atend_med		= nr_atend_med_p
			and	a.nr_seq_prot_med	= nr_seq_prot_med_p  LIMIT 1;
			exception
			when others then
				qt_proced_w	:= 0;
			end;
		end if;

		if (coalesce(dt_emissao_guia_w::text, '') = '') and (coalesce(ie_dt_emissao_guia_w,'P') = 'P') then
			select	min(dt_atendimento)
			into STRICT	dt_emissao_guia_w
			from	material_atend_paciente
			where	nr_interno_conta	= nr_interno_conta_p
			and	coalesce(cd_motivo_exc_conta::text, '') = '';
		end if;

		if	((coalesce(nr_atend_med_p,0) > 0) and (coalesce(nr_seq_prot_med_p,0) > 0)) then

			select	max(coalesce(ie_dt_emissao_spsadt,'N'))
			into STRICT	ie_dt_emissao_spsadt_w
			from	med_faturamento a,
				med_atendimento b,
				med_plano c
			where	c.nr_sequencia	= b.nr_seq_plano
			and	a.nr_atendimento	= b.nr_atendimento
			and	a.nr_atendimento	= nr_atend_med_p
			and	a.nr_seq_protocolo	= nr_seq_prot_med_p;

			if (ie_dt_emissao_spsadt_w = 'S') then
				select	max(d.dt_entrada)
				into STRICT	dt_emissao_guia_w
				from	med_atendimento d,
					med_faturamento a
				where	a.nr_atendimento		= d.nr_atendimento
				and	a.nr_atendimento		= nr_atend_med_p
				and	a.nr_seq_protocolo		= nr_seq_prot_med_p;
			end if;
		end if;		

		ie_senha_guia_regra_w	:= null;

		open c07;
		loop
		fetch c07 into
			ie_senha_guia_regra_w;
		EXIT WHEN NOT FOUND; /* apply on c07 */

		end loop;
		close c07;
		
		if (coalesce(cd_senha_w::text, '') = '') and (coalesce(nr_interno_conta_p,0) > 0) and (coalesce(ie_senha_guia_regra_w,'X') <> 'P') and --lhalves OS 578154 em 19/04/2013 - Se a regra esta para senha do procedimento, nao busca a senha do atendimento ou autorizacao
			((coalesce(qt_proced_w,0)	= 0) or (ie_senha_guia_w	= 'ACA')) then
			
			select	max(cd_senha)
			into STRICT	cd_senha_w
			from	autorizacao_convenio a
			where	a.nr_atendimento	= nr_atendimento_w
			and	a.cd_autorizacao	= cd_autorizacao_w;
						
			if (coalesce(cd_senha_w::text, '') = '') then
				select	max(cd_senha)
				into STRICT	cd_senha_w
				from	atend_categoria_convenio
				where	nr_seq_interno	= obter_atecaco_atendimento(nr_atendimento_w);
			end if;
			
		end if;

		if (ie_senha_guia_regra_w = 'N') and (coalesce(nr_interno_conta_p,0) > 0) then
			cd_senha_w	:=null;
		elsif (ie_senha_guia_regra_w = 'ACA') and (coalesce(nr_interno_conta_p,0) > 0) then
			select	max(cd_senha)
			into STRICT	cd_senha_w
			from	atend_categoria_convenio
			where	nr_seq_interno	= obter_atecaco_atendimento(nr_atendimento_w);
		elsif (ie_senha_guia_regra_w = 'ASG') and (coalesce(nr_interno_conta_p,0) > 0) then
			/*lhalves OS204117 em 14/05/2010 - Gerar a senha para a guia da conta, de acordo com o tipo de guia da conta e da autor.*/
			
			cd_senha_w	:= null;
			open c09;
			loop
			fetch c09 into
				cd_senha_autor_w;
			EXIT WHEN NOT FOUND; /* apply on c09 */			
				if (cd_senha_autor_w IS NOT NULL AND cd_senha_autor_w::text <> '') then
					cd_senha_w := cd_senha_autor_w;
				end if;
			end loop;
			close c09;
		elsif (ie_senha_guia_regra_w = 'ATG') and (coalesce(nr_interno_conta_p,0) > 0) then
			/*lhalves OS 373066 em 24/10/2011 - Busca a senha do atendimento conforme cd_autorizacao e tipo de guia*/
		
			select	max(cd_senha)
			into STRICT	cd_senha_w
			from	atend_categoria_convenio
			where	nr_atendimento		= nr_atendimento_w			
			and	ie_tipo_guia		= coalesce(ie_tipo_guia_conta_w,ie_tipo_guia)
			and	nr_doc_convenio		= cd_autorizacao_w;
		elsif (ie_senha_guia_regra_w = 'ATA') and (coalesce(nr_interno_conta_p,0) > 0) then
			/*lhalves OS376948 em 27/10/2011 - Busca a senha da autorizacao conforme tipo de guia. Se nao encontrou, o cd_senha_w permanece com o valor do c01*/

			select	max(a.cd_senha)
			into STRICT	cd_senha_autor_w
			from 	autorizacao_convenio a
			where	a.nr_atendimento	= nr_atendimento_w
			and	a.ie_tipo_guia		= ie_tipo_guia_conta_w;
			
			if (cd_senha_autor_w IS NOT NULL AND cd_senha_autor_w::text <> '') then
				cd_senha_w := cd_senha_autor_w;
			end if;
		elsif (ie_senha_guia_regra_w = 'AP') and (coalesce(nr_interno_conta_p,0) > 0) then
		
			select	max(cd_senha)
			into STRICT	cd_senha_w			
			from	atend_categoria_convenio a
			where	a.nr_atendimento	= nr_atendimento_w
			and	a.cd_convenio		= cd_convenio_w
			and	dt_inicio_vigencia	= (	SELECT	MAX(dt_inicio_vigencia)
			  		from	atend_categoria_convenio
			  		where	nr_atendimento	= nr_atendimento_w
					and	cd_convenio	= cd_convenio_w
					and	dt_periodo_inicial_w between dt_inicio_vigencia and coalesce(dt_final_vigencia,ESTABLISHMENT_TIMEZONE_UTILS.endOfDay(dt_periodo_inicial_w)));
		elsif (ie_senha_guia_regra_w = 'ACG') and (coalesce(nr_interno_conta_p,0) > 0) then
		
			select	max(a.cd_senha)
			into STRICT	cd_senha_w
			from 	estagio_autorizacao b,
				autorizacao_convenio a
			where	a.nr_atendimento	= nr_atendimento_w
			and	a.nr_seq_estagio	= b.nr_sequencia
			and	a.cd_autorizacao	= cd_autorizacao_w
			and	b.ie_interno		<> '70'; --Cancelado
		
		end if;

		-- dsantos OS163448 em 14/10/2009 o ie_senha_guia_regra_w so tem valor se entrar na regra senha guia (C07).

		-- mas se tiver regra, o ie_senha_guia_w precisa do valor do ie_senha_guia_regra_w para fazer o update na tiss_conta_proc
		ie_senha_guia_w	:= coalesce(ie_senha_guia_regra_w, ie_senha_guia_w);

		if (ie_guia_princ_honor_w	 = 'S') and (ie_tiss_tipo_guia_w	= '6') then
			cd_autorizacao_princ_w	:= cd_senha_w;
		end if;

		if (coalesce(ie_mesma_guia_w,'S') = 'N') and (cd_autorizacao_princ_w	  = cd_autorizacao_w) then
			cd_autorizacao_princ_w	:= null;
		end if;
		
		if (coalesce(ie_mesma_guia_prest_w,'S') = 'N') and (cd_autorizacao_princ_w	  = nr_guia_prestador_w) then
			cd_autorizacao_princ_w	:= null;
		end if;

		if (coalesce(nr_seq_protocolo_w,0) > 0) then
			select	max(a.cd_ans),
				max(a.ie_tipo_protocolo)
			into STRICT	cd_ans_aux_w,
				ie_tipo_protocolo_w
			from	protocolo_convenio a
			where	nr_seq_protocolo	= nr_seq_protocolo_w;
		end if;

		if (cd_ans_aux_w IS NOT NULL AND cd_ans_aux_w::text <> '') then
			cd_ans_w	:= substr(cd_ans_aux_w,1,20);
		end if;

		select	max(to_char(dt_nascimento, 'dd/mm/yyyy')),
			max(ie_sexo)
		into STRICT	dt_nascimento_w,
			ie_sexo_w
		from	pessoa_fisica
		where	cd_pessoa_fisica	= cd_pessoa_fisica_w;

		if (ie_honorario_w = 'N') and (ie_tiss_tipo_guia_w = 4) then
			ie_guia_w	:= 'SADT';
		end if;
		if (ie_honorario_w = 'N') and (ie_tiss_tipo_guia_w = 5) then
			ie_guia_w	:= 'RI';
		end if;
		if (ie_honorario_w = 'S') and (ie_tiss_tipo_guia_w = 4) then
			ie_guia_w	:= 'SADTH';
		end if;
		if (ie_honorario_w = 'S') and (ie_tiss_tipo_guia_w = 5) then
			ie_guia_w	:= 'RIH';
		end if;

		ds_observacao_pacote_w		:= null;

		if (ie_observacao_w = 'S') then
			open c05;
			loop
			fetch c05 into
				ds_observacao_pacote_ww;
			EXIT WHEN NOT FOUND; /* apply on c05 */
				ds_observacao_pacote_w := 'Pacote '|| substr(ds_observacao_pacote_ww,1,1999) || ' - ' || substr(ds_observacao_pacote_w,1,1999);
			end loop;
			close c05;
		elsif (ie_observacao_w = 'A') then
			ds_observacao_w	:= null;
			open c06;
			loop
			fetch c06 into
				ds_observacao_ww;
			EXIT WHEN NOT FOUND; /* apply on c06 */
				ds_observacao_w := substr(ds_observacao_ww || chr(13) || ds_observacao_w,1,3900);
			end loop;
			close c06;
		elsif (ie_observacao_w = 'U') then
			ds_observacao_w	:= nm_usuario_p;
		elsif (ie_observacao_w = 'C') then
			ds_observacao_w	:= ds_observacao_conta_w;
		elsif (ie_observacao_w = 'N') then
			ds_observacao_w	:= null;
		elsif (ie_observacao_w = 'D') then
			ds_observacao_w	:= ' Data de alta: ' || obter_dados_atendimento(nr_atendimento_w,'DA');
		elsif (ie_observacao_w = 'O') then
			select	max(ds_observacao)
			into STRICT	ds_observacao_w
			from	prescr_medica
			where	nr_atendimento	= nr_atendimento_w
			and	(ds_observacao IS NOT NULL AND ds_observacao::text <> '');
		elsif (ie_observacao_w = 'T') then
			select 	coalesce(coalesce(max(a.ds_observacao),max(b.ds_observacao)),ds_observacao_w)
			into STRICT	ds_observacao_w
			from 	atend_categoria_convenio b,
				atendimento_paciente a
			where	b.nr_atendimento	= a.nr_atendimento
			and	b.nr_seq_interno		= obter_atecaco_atendimento(nr_atendimento_w)
			and	a.nr_atendimento	= nr_atendimento_w;
		elsif (ie_observacao_w = 'B') then
			select	' Convenio: '||substr(obter_nome_convenio(cd_convenio_w),1,255)
			into STRICT	ds_observacao_w
			;
		end if;
		
		begin
			select	1
			into STRICT	qt_regra_obs_w
			from	tiss_regra_campo_esp a
			where	a.ds_campo		= 'DS_OBSERVACAO'
			and	a.cd_convenio		= cd_convenio_w
			and	a.cd_estabelecimento	= cd_estabelecimento_w  LIMIT 1;		
		exception
		when others then
			qt_regra_obs_w	:= 0;
		end;

		if (qt_regra_obs_w > 0) then --Somente abrir este cursor se existir regra para o campo (performance)
			ds_prescricao_w	:= null;
			open c14;
			loop
			fetch c14 into
				nr_prescricao_w;
			EXIT WHEN NOT FOUND; /* apply on c14 */
				if (coalesce(ds_prescricao_w::text, '') = '') then
					ds_prescricao_w	:= nr_prescricao_w;
				else
					ds_prescricao_w	:= substr((ds_prescricao_w || ', ' || nr_prescricao_w),1,3999);
				end if;
			end loop;
			close c14;
		end if;

		/*select	max(nr_prescricao)
		into	ds_prescricao_w
		from	procedimento_paciente
		where	nr_interno_conta		= nr_interno_conta_p
		and	cd_motivo_exc_conta		is null;*/


		/* Alterado para setar a observacao da guia no final da rotina, depois de vincular os itens as guias
		ds_observacao_w		:= nvl(tiss_obter_campo_esp(	cd_convenio_w,
									cd_estabelecimento_w,
									'DS_OBSERVACAO',
									null,
									null,
									null,
									null,
									ie_funcao_medico_w,
									ie_sexo_w,
									dt_nascimento_w,
									ie_tipo_protocolo_w,
									ie_tipo_guia_atend_w,
									cd_regional_w,
									ie_guia_w,
									null,
									null,
									null,
									ie_tipo_atendimento_w,
									cd_cgc_prestador_w,
									ie_responsavel_credito_w,
									cd_medico_guia_w,
									nr_interno_conta_p, 
									ds_prescricao_w, 
									null, 
									null, 
									null),
						tiss_obter_regra_campo(	ie_tiss_tipo_guia_w, 'DS_OBSERVACAO', cd_convenio_w, ds_observacao_w,
									ie_tipo_atendimento_w, cd_categoria_conv_w,'N', 0,
									cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, 
									ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'));*/
		if (ie_senha_guia_w = 'G') then
			cd_senha_w	:= cd_autorizacao_w;
		end if;

		if (coalesce(ie_senha_guia_princ_w,'N') = 'S') and (ie_tiss_tipo_guia_w = 4) and
			 ((coalesce(cd_autorizacao_w::text, '') = '') or (cd_autorizacao_w <> cd_autorizacao_princ_w)) then
			cd_senha_w	:= null;
		end if;

		/*lhalves OS 282477 em 13/01/2011*/

		if (ie_senha_guia_w = 'ACC') then
			cd_senha_autor_conta_w	:= OBTER_SENHA_AUTOR_CONTA(nr_interno_conta_p);
			if (cd_senha_autor_conta_w IS NOT NULL AND cd_senha_autor_conta_w::text <> '') then
				cd_senha_w	:= cd_senha_autor_conta_w;
			end if;
		end if;

		if (coalesce(ie_fonte_pagadora_w,'ANS') = 'CGC') then
			select	max(cd_cgc)
			into STRICT	cd_cgc_fonte_pag_w
			from	convenio
			where	cd_convenio		= cd_convenio_w;
		end if;
		
		cd_autorizacao_tag_w	:= tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_AUTORIZACAO_TAG', cd_convenio_w, cd_autorizacao_tag_w, ie_tipo_atendimento_w,
							 	cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@');		

		cd_autorizacao_princ_w	:= tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_AUTORIZACAO_PRINC', cd_convenio_w, cd_autorizacao_princ_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@');								
		
		ie_tipo_atend_odont_w	:= null;
		if (ie_tiss_tipo_guia_w = '11') then
		
			open C18;
			loop
			fetch C18 into	
				ie_tipo_atend_odont_w;
			EXIT WHEN NOT FOUND; /* apply on C18 */				
			end loop;
			close C18;	
		end if;		
		
		begin
		insert into tiss_conta_guia(
			nr_sequencia,
			nr_interno_conta,
			ie_tiss_tipo_guia,
			cd_autorizacao,
			dt_atualizacao,
			nm_usuario,
			cd_ans,
			dt_autorizacao,
			cd_senha,
			dt_validade_senha,
			dt_emissao_guia,
			nr_sequencia_autor,
			ie_tipo_saida,
			cd_autorizacao_tag,
			cd_convenio,
			cd_medico_executor,
			cd_cgc_prestador,
			ie_tipo_atend_tiss,
			cd_autorizacao_princ,
			dt_fim_vigencia,
			ie_honorario,
			ds_indicacao,
			cd_cid,
			cd_cid_2,
			cd_cid_3,
			cd_cid_4,
			cd_cid_obito,
			cd_tabela_cid,
			ds_cid,
			ie_tipo_cid,
			ie_unidade_tempo_cid,
			qt_tempo_cid,
			cd_tabela_cid_2,
			ds_cid_2,
			cd_tabela_cid_obito,
			ds_cid_obito,
			nr_guia_prestador,
			ds_observacao,
			nr_seq_med_fatur,
			ds_data_assin_benef,
			ds_data_assin_med,
			nr_atend_med,
			nr_seq_prot_med,
			cd_med_solic_tasymed,
			ie_tipo_acidente,
			cd_cgc_fonte_pag,
			dt_inicio_faturamento,
			dt_fim_faturamento,
			nr_seq_prot_conta,
			cd_ausencia_cod_valid,
			cd_validacao_tiss)
		values (
			nr_seq_guia_w,
			nr_interno_conta_p,
			ie_tiss_tipo_guia_w,
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_AUTORIZACAO', cd_convenio_w, coalesce(nr_guia_operadora_w,cd_autorizacao_w), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			clock_timestamp(),
			nm_usuario_p,
			cd_ans_w,
			to_date(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'DT_SOLICITACAO', cd_convenio_w, to_char(dt_autorizacao_w,'dd/mm/yyyy hh24:mi:ss'), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'), 'dd/mm/yyyy hh24:mi:ss'),
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_SENHA', cd_convenio_w, cd_senha_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'DT_VALIDADE_SENHA', cd_convenio_w, dt_validade_senha_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			coalesce(dt_emissao_guia_w, clock_timestamp()),
			nr_sequencia_autor_w,
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'IE_TIPO_SAIDA', cd_convenio_w, ie_tipo_saida_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),			
			cd_autorizacao_tag_w,
			cd_convenio_w,
			cd_medico_guia_w,
			cd_cgc_prestador_w,
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'IE_TIPO_ATEND_TISS', cd_convenio_w, coalesce(ie_tipo_atend_odont_w,coalesce(ie_tipo_atend_proc_w, ie_tipo_atend_tiss_w)), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),			
			cd_autorizacao_princ_w,
			dt_fim_vigencia_w,
			ie_honorario_w,
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'DS_INDICACAO', cd_convenio_w, ds_indicacao_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_DOENCA_CID', cd_convenio_w, cd_cid_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_CID_2', cd_convenio_w, cd_cid_2_w, ie_tipo_atendimento_w,cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			cd_cid_3_w,
			cd_cid_4_w,
			cd_cid_obito_w,
			cd_tabela_cid_w,
			ds_cid_w,
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'IE_TIPO_CID', cd_convenio_w, ie_tipo_cid_w, ie_tipo_atendimento_w,cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),			
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'IE_UNIDADE_TEMPO_CID', cd_convenio_w, ie_unidade_tempo_cid_w, ie_tipo_atendimento_w,cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'QT_TEMPO_CID', cd_convenio_w, qt_tempo_cid_w, ie_tipo_atendimento_w,cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			cd_tabela_cid_2_w,
			ds_cid_2_w,
			cd_tabela_cid_obito_w,
			ds_cid_obito_w,
			nr_guia_prestador_w,
			null,
			nr_seq_med_fatur_p,
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'DT_ASSIN_BENEF', cd_convenio_w, ds_data_assin_benef_w, ie_tipo_atendimento_w, cd_categoria_conv_w, 'N', 0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'DT_ASSIN_MED', cd_convenio_w, ds_data_assin_med_w, ie_tipo_atendimento_w, cd_categoria_conv_w, 'N', 0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			nr_atend_med_p,
			nr_seq_prot_med_p,
			cd_med_solic_tasymed_w,
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'IE_TIPO_ACIDENTE', cd_convenio_w, ie_tipo_acidente_w, ie_tipo_atendimento_w, cd_categoria_conv_w, 'N', 0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			cd_cgc_fonte_pag_w,
			dt_periodo_inicial_w,
			dt_periodo_final_w,
			nr_seq_protocolo_w,
			cd_ausencia_cod_valid_w,
			cd_validacao_tiss_w);

		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(184055,'sqlerrm='||sqlerrm||
									';cd_cgc_prestador_w='||cd_cgc_prestador_w);
			--r.aise_application_error(-20011, sqlerrm || chr(13) ||

			--			'cd_cgc_prestador_w = ' || cd_cgc_prestador_w);
		end;

		if (ie_tiss_tipo_guia_w = '5') then
			open c11;
			loop
			fetch c11 into
				nr_dnv_w;
			EXIT WHEN NOT FOUND; /* apply on c11 */

				select	nextval('tiss_conta_dn_seq')
				into STRICT	nr_seq_dnv_w
				;

				if (coalesce(ie_mascara_dnv_w,'S') = 'N') then
					nr_dnv_w	:= replace(replace(nr_dnv_w,'-',''),'.','');
				end if;

				insert into TISS_CONTA_DN(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_dnv,
					nr_interno_conta,
					nr_seq_guia)
				values (nr_seq_dnv_w,
					clock_timestamp(),
					nm_usuario_p,
					nr_dnv_w,
					nr_interno_conta_p,
					nr_seq_guia_w);

			end loop;
			close c11;
		end if;

		cd_cgc_solic_w			:= null;
		nr_cpf_solic_w			:= null;
		cd_interno_solic_w			:= null;
		nm_contratado_solic_w		:= null;
		cd_cnes_solic_w			:= null;
		nm_solicitante_w			:= null;
		sg_conselho_solic_w		:= null;
		uf_conselho_solic_w		:= null;
		cd_cbos_solic_w			:= null;

		-- definir solicitante da guia
		cd_medico_solicitante_w		:= null;
		cd_medico_contrat_solic_w	:= null;		

		select	max(cd_cgc)
		into STRICT	cd_cgc_estab_w
		from	estabelecimento
		where	cd_estabelecimento	= cd_estabelecimento_w;
		
		if (coalesce(ie_tipo_item_w,'P') = 'P') then				
		
			if (ie_regra_solic_w = 'R') then
				if (cd_medico_prof_solic_tiss_w IS NOT NULL AND cd_medico_prof_solic_tiss_w::text <> '') then
					cd_medico_solicitante_w	:= cd_medico_prof_solic_tiss_w;				
				end if;			
			else	
				if (ie_regra_solic_w = 'S') then			
					select	max(cd_medico_resp)
					into STRICT	cd_medico_solicitante_w
					from	atendimento_paciente
					where	nr_atendimento	= nr_atendimento_w;			
				end if;	
			
			end if;
		else		
			if (ie_regra_solic_w = 'R') then

				ie_medico_solic_atend_w		:= 'N';
				open c03;
				loop
				fetch c03 into
					ie_medico_solic_atend_w,
					cd_medico_regra_solic_tiss_w;
				EXIT WHEN NOT FOUND; /* apply on c03 */
				end loop;
				close c03;

			end if;
			if (ie_medico_solic_atend_w = 'N') then			
				select	max(nr_sequencia)
				into STRICT	nr_sequencia_autor_w
				from	autorizacao_convenio
				where	nr_atendimento	= nr_atendimento_w
				and	cd_autorizacao	= cd_autorizacao_w;
				if (nr_sequencia_autor_w IS NOT NULL AND nr_sequencia_autor_w::text <> '') then
					select	max(cd_medico_solicitante)
					into STRICT	cd_medico_solicitante_w
					from	autorizacao_convenio
					where	nr_sequencia	= nr_sequencia_autor_w;
				end if;
			end if;
			if (ie_medico_solic_atend_w = 'MR') and (coalesce(cd_medico_solicitante_w::text, '') = '') then
				select	coalesce(max(cd_medico_atendimento), max(cd_medico_resp))
				into STRICT	cd_medico_solicitante_w
				from	atendimento_paciente
				where	nr_atendimento	= nr_atendimento_w;		
			end if;
			if (ie_medico_solic_atend_w = 'MRF') and (coalesce(cd_medico_solicitante_w::text, '') = '') then
				cd_medico_solicitante_w	:= cd_medico_prof_solic_tiss_w;
				select	max(cd_medico_referido)
				into STRICT	cd_medico_solicitante_w
				from	atendimento_paciente
				where	nr_atendimento	= nr_atendimento_w;
			end if;
			if (ie_medico_solic_atend_w = 'MP') and (coalesce(cd_medico_solicitante_w::text, '') = '') then
				cd_medico_solicitante_w	:= cd_medico_prof_solic_tiss_w;
			end if;
			if (ie_medico_solic_atend_w = 'MSP') and (coalesce(cd_medico_solicitante_w::text, '') = '') then
				cd_medico_solicitante_w	:= cd_medico_prof_solic_tiss_w;
			end if;
			if (ie_medico_solic_atend_w = 'MRP') and (coalesce(cd_medico_solicitante_w::text, '') = '') then
				cd_medico_solicitante_w	:= cd_medico_prof_solic_tiss_w;
			end if;
			if (ie_medico_solic_atend_w = 'RMP') and (coalesce(cd_medico_solicitante_w::text, '') = '') then
				cd_medico_solicitante_w	:= cd_medico_prof_solic_tiss_w;
			end if;
			if (ie_medico_solic_atend_w = 'RMA') and (coalesce(cd_medico_solicitante_w::text, '') = '') then
				cd_medico_solicitante_w	:= cd_medico_prof_solic_tiss_w;
			end if;
			if (ie_medico_solic_atend_w = 'PA') and (coalesce(cd_medico_solicitante_w::text, '') = '') then			
				select	max(cd_medico)
				into STRICT	cd_medico_solicitante_w
				from	prescr_medica
				where	nr_atendimento	= nr_atendimento_w
				and 	coalesce(dt_suspensao::text, '') = '';
				if (coalesce(cd_medico_solicitante_w, '0') = '0') then
					select	max(cd_medico_resp)
					into STRICT	cd_medico_solicitante_w
					from	atendimento_paciente
					where	nr_atendimento	= nr_atendimento_w;
				end if;
			end if;
			if (ie_medico_solic_atend_w = 'S') and (coalesce(cd_medico_solicitante_w::text, '') = '') then			
				select	max(cd_medico_resp)
				into STRICT	cd_medico_solicitante_w
				from	atendimento_paciente
				where	nr_atendimento	= nr_atendimento_w;			
			end if;
			if (ie_medico_solic_atend_w = 'E') and (coalesce(cd_medico_solicitante_w::text, '') = '') then			
				cd_medico_solicitante_w	:= cd_medico_prof_solic_tiss_w;
			end if;
			if (ie_medico_solic_atend_w = 'SMC') then
				cd_medico_solicitante_w	:= coalesce(cd_medico_executor_w,cd_medico_exec_tiss_w);
				if (coalesce(cd_medico_solicitante_w::text, '') = '') then
					select	max(cd_medico_resp)
					into STRICT	cd_medico_solicitante_w
					from	atendimento_paciente
					where	nr_atendimento	= nr_atendimento_w;
				end if;
			end if;		
			if (ie_medico_solic_atend_w = 'IR') then
				cd_medico_solicitante_w	:= cd_medico_regra_solic_tiss_w;			
			end if;		
			if (ie_medico_solic_atend_w = 'ME') then		
				select	max(crm_medico_externo),
					max(nm_medico_externo),
					max(cd_medico_resp)			
				into STRICT	crm_medico_externo_w,			
					nm_medico_externo_w,
					cd_medico_solicitante_w
				from	atendimento_paciente
				where	nr_atendimento		= nr_atendimento_w;			
			end if;
		end if;
		
		if (ie_gravar_log_conta_w = 'S') then
			CALL TISS_GERAR_LOG_CONTA(	nr_interno_conta_p,
						'Regra Medico Solicitante (Gerar Conta Guia) > '||
						' Tipo Item: '||ie_tipo_item_w||
						' Retorno Regra: '|| ie_medico_solic_atend_w||
						' Medico Solic TISS: '||cd_medico_solicitante_w||
						' Seq Guia: '||nr_seq_guia_w,
						nm_usuario_p);
		end if;

		if	((coalesce(nr_atend_med_p,0) > 0) and (coalesce(nr_seq_prot_med_p,0) > 0)) then
			cd_medico_solicitante_w	:= coalesce(cd_med_solic_tasymed_w, cd_medico_executor_w);

			if (coalesce(cd_medico_solicitante_w::text, '') = '') then
				select	max(cd_medico)
				into STRICT	cd_medico_solicitante_w
				from	med_faturamento a,
					med_prot_convenio b
				where	a.nr_atendimento	= nr_atend_med_p
				and	a.nr_seq_protocolo	= nr_seq_prot_med_p
				and	a.nr_seq_protocolo	= b.nr_sequencia;
			end if;
		end if;		

		select	coalesce(max(obter_se_medico_conveniado(cd_estabelecimento_w, cd_medico_solicitante_w , cd_convenio_w, null, null, null,null,null,null, null, null)), 'N')
		into STRICT	ie_conveniado_w
		;

		select	max(nm_pessoa_fisica),
			max(nr_seq_cbo_saude),
			max(nr_seq_conselho)
		into STRICT	nm_solicitante_w,
			nr_seq_cbo_saude_w,
			nr_seq_conselho_w
		from	pessoa_fisica
		where	cd_pessoa_fisica		= cd_medico_solicitante_w;

		--if	(ie_conveniado_w = 'S') then lhalves OS 372660 em 26/10/2011
			select	coalesce(max(obter_nome_medico_convenio(cd_estabelecimento_w, cd_medico_solicitante_w, cd_convenio_w, null, null, null,null,ie_tipo_atendimento_w)), nm_solicitante_w)
			into STRICT	nm_solicitante_w
			;
		--end if;
		if (coalesce(cd_cbos_compl_w::text, '') = '') then
			cd_cbos_compl_w	:= tiss_obter_cbos_medico(cd_medico_guia_w, (coalesce(obter_especialidade_medico(cd_medico_guia_w, 'C'),0))::numeric , ds_versao_w, cd_convenio_w);
		end if;

		-- gerava problema de cbos diferentes.
		if (cd_medico_solicitante_w	= cd_medico_guia_w) then
			cd_cbos_solic_w	:= cd_cbos_compl_w;
		else
			select	max(tiss_obter_cbos_medico(cd_medico_solicitante_w, (coalesce(obter_especialidade_medico(cd_medico_solicitante_w, 'C'),0))::numeric , ds_versao_w, cd_convenio_w))
			into STRICT	cd_cbos_solic_w
			;
		end if;

		select	max(coalesce(ie_conselho_prof_tiss,sg_conselho))
		into STRICT	sg_conselho_solic_w
		from	conselho_profissional
		where	nr_sequencia		= nr_seq_conselho_w;

		select	max(uf_crm),
			max(nr_crm)
		into STRICT	uf_conselho_solic_w,
			nr_crm_solic_w
		from	medico
		where	cd_pessoa_fisica	= cd_medico_solicitante_w;
		
		if (coalesce(uf_conselho_solic_w::text, '') = '') then
			select	max(uf_conselho)
			into STRICT	uf_conselho_solic_w
			from	pessoa_fisica
			where	cd_pessoa_fisica	= cd_medico_solicitante_w;
		end if;
		
		if (coalesce(nr_crm_solic_w::text, '') = '') then
			select	max(ds_codigo_prof)
			into STRICT	nr_crm_solic_w
			from	pessoa_fisica
			where	cd_pessoa_fisica	= cd_medico_solicitante_w;
		end if;
		
		if	((crm_medico_externo_w IS NOT NULL AND crm_medico_externo_w::text <> '') or (nm_medico_externo_w IS NOT NULL AND nm_medico_externo_w::text <> '')) then /*lhalves OS387947 em 2/12/2011*/
		
			nr_crm_solic_w 		:= coalesce(crm_medico_externo_w,nr_crm_solic_w);
			nm_solicitante_w	:= coalesce(nm_medico_externo_w,nm_solicitante_w);
			if (crm_medico_externo_w IS NOT NULL AND crm_medico_externo_w::text <> '') then
				sg_conselho_solic_w	:= 'CRM';
			end if;

			select coalesce(max(uf_medico_externo),uf_conselho_solic_w)
            		into STRICT  uf_conselho_solic_w
            		from  atendimento_medico_externo
            		where crm_medico_externo = crm_medico_externo_w
            		and nr_atendimento = nr_atendimento_w;
			
		end if;
			
		cd_medico_prestador_w	:= null;
		cd_medico_solicitante_w	:= coalesce(cd_medico_solic_tiss_w, cd_medico_solicitante_w);

		if (ie_solicitante_w	= 'R') then
			--select	max(nvl(cd_medico_atendimento, cd_medico_resp)) lhalves OS 573734 em 30/04/2013
			select	max(cd_medico_resp)
			into STRICT	cd_medico_atendimento_w
			from	atendimento_paciente
			where	nr_atendimento	= nr_atendimento_w;

			SELECT * FROM tiss_obter_regra_prest_solic(	cd_convenio_w, cd_estabelecimento_w, coalesce(cd_setor_entrada_pac_w,cd_setor_entrada_w), ie_clinica_w, cd_procedencia_w, ie_tipo_atendimento_w, 'N', ie_solicitante_w, cd_cgc_prest_solic_regra_w, cd_medico_atendimento_w, cd_medico_prestador_w, cd_prestador_solic_tiss_w, ds_prestador_solic_tiss_w, cd_medico_referido_w, cd_categoria_conv_w, dt_periodo_inicial_w, ie_tipo_protocolo_w, null, cd_plano_convenio_w, nr_seq_regra_solic_w) INTO STRICT ie_solicitante_w, cd_cgc_prest_solic_regra_w, cd_medico_prestador_w, cd_prestador_solic_tiss_w, ds_prestador_solic_tiss_w, nr_seq_regra_solic_w;
		end if;

		if	((coalesce(cd_med_solic_tasymed_w,'X') <> 'X') or
			((ie_conveniado_w	= 'S' AND ie_solicitante_w		= 'MC') or (coalesce(ie_contrat_med_w,'C') 	= 'M'))) and (coalesce(cd_cgc_prest_solic_tiss_w::text, '') = '') then

			if	((coalesce(nr_atend_med_p,0) > 0) and (coalesce(nr_seq_prot_med_p,0) > 0)) then
				select	max(tiss_obter_codigo_medico(cd_estabelecimento_w, cd_convenio_w, cd_medico_solicitante_w,'CIM')),
					max(tiss_obter_codigo_medico(cd_estabelecimento_w, cd_convenio_w, cd_medico_solicitante_w,'CPF'))
				into STRICT	cd_interno_solic_w,
					nr_cpf_solic_w
				;
			else			
				select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_solicitante_w, null, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
					max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_solicitante_w, null, cd_setor_entrada_w, 'CPF',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
				into STRICT	cd_interno_solic_w,
					nr_cpf_solic_w
				;
			end if;

			select	max(nm_pessoa_fisica),
				max(cd_cnes)
			into STRICT	nm_contratado_solic_w,
				cd_cnes_solic_w
			from	pessoa_fisica
			where	cd_pessoa_fisica	= cd_medico_solicitante_w;

			if (ie_conveniado_w = 'S') then
				select	coalesce(max(obter_nome_medico_convenio(cd_estabelecimento_w, cd_medico_solicitante_w, cd_convenio_w, null, null, null,null,ie_tipo_atendimento_w)), nm_contratado_solic_w)
				into STRICT	nm_contratado_solic_w
				;
			end if;

			if (ie_crm_w = 'P') and (ds_adicional_crm_w IS NOT NULL AND ds_adicional_crm_w::text <> '') then
				cd_interno_solic_w	:= cd_interno_solic_w || ds_adicional_crm_w;
			end if;

		elsif	((ie_solicitante_w = 'M') or (coalesce(ie_contrat_med_w,'C') = 'M')) and (coalesce(cd_cgc_prest_solic_tiss_w::text, '') = '') then

			if	((coalesce(nr_atend_med_p,0) > 0) and (coalesce(nr_seq_prot_med_p,0) > 0)) then
				select	max(tiss_obter_codigo_medico(cd_estabelecimento_w, cd_convenio_w, cd_medico_solicitante_w,'CIM')),
					max(tiss_obter_codigo_medico(cd_estabelecimento_w, cd_convenio_w, cd_medico_solicitante_w,'CPF'))
				into STRICT	cd_interno_solic_w,
					nr_cpf_solic_w
				;
			else
				select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_solicitante_w, null, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
					max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_solicitante_w, null, cd_setor_entrada_w, 'CPF',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
				into STRICT	cd_interno_solic_w,
					nr_cpf_solic_w
				;
			end if;

			select	max(nm_pessoa_fisica),
				max(cd_cnes)
			into STRICT	nm_contratado_solic_w,
				cd_cnes_solic_w
			from	pessoa_fisica
			where	cd_pessoa_fisica	= cd_medico_solicitante_w;

			if (ie_conveniado_w = 'S') then
				select	coalesce(max(obter_nome_medico_convenio(cd_estabelecimento_w, cd_medico_solicitante_w, cd_convenio_w, null, null, null,null,ie_tipo_atendimento_w)), nm_contratado_solic_w)
				into STRICT	nm_contratado_solic_w
				;
			end if;

			if (ie_crm_w = 'P') and (ds_adicional_crm_w IS NOT NULL AND ds_adicional_crm_w::text <> '') then
				cd_interno_solic_w	:= cd_interno_solic_w || ds_adicional_crm_w;
			end if;

		elsif (ie_solicitante_w = 'I') then

			if (coalesce(cd_medico_prestador_w::text, '') = '') then
			
				select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prest_solic_regra_w, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
					max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prest_solic_regra_w, cd_setor_entrada_w, 'CGC',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
				into STRICT	cd_interno_solic_w,
					cd_cgc_solic_w
				;				

				select	max(ds_razao_social),
					max(cd_cnes)
				into STRICT	nm_contratado_solic_w,
					cd_cnes_solic_w
				from	pessoa_juridica
				where	cd_cgc		= cd_cgc_prest_solic_regra_w;
			else
				if	((coalesce(nr_atend_med_p,0) > 0) and (coalesce(nr_seq_prot_med_p,0) > 0)) then
					select	max(tiss_obter_codigo_medico(cd_estabelecimento_w, cd_convenio_w, cd_medico_prestador_w,'CIM')),
						max(tiss_obter_codigo_medico(cd_estabelecimento_w, cd_convenio_w, cd_medico_prestador_w,'CPF'))
					into STRICT	cd_interno_solic_w,
						nr_cpf_solic_w
					;
				else			
					select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_prestador_w, null, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
						max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_prestador_w, null, cd_setor_entrada_w, 'CPF',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
					into STRICT	cd_interno_solic_w,
						nr_cpf_solic_w
					;
				end if;

				select	max(nm_pessoa_fisica),
					max(cd_cnes)
				into STRICT	nm_contratado_solic_w,
					cd_cnes_solic_w
				from	pessoa_fisica
				where	cd_pessoa_fisica	= cd_medico_prestador_w;

				if (ie_conveniado_w = 'S') then
					select	coalesce(max(obter_nome_medico_convenio(cd_estabelecimento_w, cd_medico_prestador_w, cd_convenio_w, null, null, null,null,ie_tipo_atendimento_w)), nm_contratado_solic_w)
					into STRICT	nm_contratado_solic_w
					;
				end if;
			end if;

			if (coalesce(cd_prestador_solic_tiss_w, 'X') <> 'X') then
				cd_interno_solic_w	:= cd_prestador_solic_tiss_w;
			end if;

			if (coalesce(ds_prestador_solic_tiss_w, 'X') <> 'X') then
				nm_contratado_solic_w	:= ds_prestador_solic_tiss_w;
			end if;

		-- se o medico nao for conveniado entao deve gerar o prestador da guia como contratado solicitante
		else
			select	max(cd_cgc)
			into STRICT	cd_cgc_estab_w
			from	estabelecimento
			where	cd_estabelecimento	= cd_estabelecimento_w;

			cd_cgc_prestador_solic_w	:= coalesce(cd_cgc_prest_solic_tiss_w, cd_cgc_estab_w);
			/*if	(cd_prestador_tiss_w is not null) then --Diego/Edgar em 19/10/2009 - OS 172335 o cd_cgc_prest_solic_tiss_w era condicao no if.
			-- mas como nao havia informado na regra prestador, nunca setava o cd_interno_w

				cd_interno_solic_w	:= cd_prestador_tiss_w;
			end if;*/
			if (cd_prestador_solic_w IS NOT NULL AND cd_prestador_solic_w::text <> '') then
				cd_interno_solic_w	:= cd_prestador_solic_w;
			end if;

			/* edgar	31/03/2009, o cd_prestadro_convenio e somente parao cabecalho do arquivo xml, nao deve ser gerado parao prestador solicitante/executante
			select	nvl(cd_interno_solic_w, max(cd_prestador_convenio))
			into	cd_interno_solic_w
			from	protocolo_convenio
			where	nr_seq_protocolo	= nr_seq_protocolo_w;
			*/
			select	max(coalesce(cd_interno_solic_w, tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prestador_solic_w, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_W))),
				max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prestador_solic_w, cd_setor_entrada_w, 'CGC',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
			into STRICT	cd_interno_solic_w,
				cd_cgc_solic_w
			;

			select	max(ds_razao_social),
				max(cd_cnes)
			into STRICT	nm_contratado_solic_w,
				cd_cnes_solic_w
			from	pessoa_juridica
			where	cd_cgc		= cd_cgc_prestador_solic_w;
		end if;

		if (coalesce(cd_interno_solic_w, 'X') <> 'X') then
			cd_cgc_solic_w	:= null;
		end if;

		if (nr_crm_solic_w IS NOT NULL AND nr_crm_solic_w::text <> '') and (ds_adicional_crm_w IS NOT NULL AND ds_adicional_crm_w::text <> '') then
			nr_crm_solic_w	:= nr_crm_solic_w || ds_adicional_crm_w;
		end if;
		
		if (ie_regra_solic_w = 'R') then

			ie_medico_solic_atend_w		:= 'N';
			open c03;
			loop
			fetch c03 into
				ie_medico_solic_atend_w,
				cd_medico_regra_solic_tiss_w;
			EXIT WHEN NOT FOUND; /* apply on c03 */
			end loop;
			close c03;

		end if;

		if (ie_medico_solic_atend_w = 'SMC') then  --lhalves OS280368 em 18/01/2011 - Nao gera o medico como solicitante se for conveniado (nao gera apenas o nome, pois CRM e obrigatorio
			if (obter_se_medico_conveniado(cd_estabelecimento_w,coalesce(cd_medico_solic_tiss_w, cd_medico_solicitante_w), cd_convenio_w, null, null, null,null,null,null, null, null) = 'S') then
				nm_solicitante_w	:= null;
			end if;
		end if;

		if (ds_mascara_crm_w IS NOT NULL AND ds_mascara_crm_w::text <> '') then

			if (length(nr_crm_solic_w) < length(ds_mascara_crm_w)) then
				qt_digitos_crm_w	:= length(ds_mascara_crm_w);
				nr_crm_solic_w		:= lpad(nr_crm_solic_w, qt_digitos_crm_w,0);
			end if;

			begin
			select	TISS_OBTER_COD_USUARIO_MASC(nr_crm_solic_w, ds_mascara_crm_w)
			into STRICT	nr_crm_mascara_w
			;

			exception
			when others then
				nr_crm_mascara_w	:= null;
			end;

			if (nr_crm_mascara_w IS NOT NULL AND nr_crm_mascara_w::text <> '') then
				nr_crm_solic_w	:= nr_crm_mascara_w;
			end if;
		end if;
		/*lhalves OS 369616 em 06/10/2011 - Gerar CRM, SGConselho e UF Conselho, no xml na identificacao do contratado solicitante*/

		if (coalesce(ie_crm_contrat_solic_w,'S') = 'S') and (nr_crm_solic_w IS NOT NULL AND nr_crm_solic_w::text <> '') and
			((ie_solicitante_w = 'MC' and ie_conveniado_w = 'S') or (ie_solicitante_w = 'M')) then
			nr_cpf_solic_w 		:= null;
			cd_interno_solic_w	:= null;			
		end if;
		
		/*Inicio Lhalves - Quando utilizado regra campo para a opcao 'Padrao se diferente do valor gerado'*/

		cd_interno_solic_w	:= tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_INTERNO_SOLIC', cd_convenio_w, cd_interno_solic_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@');
		nr_cpf_solic_w		:= tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'NR_CPF_SOLIC', cd_convenio_w, nr_cpf_solic_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@');
		
		if (coalesce(nr_cpf_solic_w,'0') <> '0') and --Se tem CPF
			(coalesce(cd_interno_solic_w,'0') = '0') then -- Se na regra esta para gerar 0
			cd_interno_solic_w	:= null;			
		end if;
		/*Fim Lhalves*/

		
		if (ie_tiss_tipo_guia_w = '11') then --Odontologia
			
			nm_contratado_solic_w	:= null;
			cd_cgc_solic_w		:= null;
			nr_cpf_solic_w		:= null;
			cd_interno_solic_w	:= null;
			uf_conselho_solic_w	:= null;
			cd_cbos_solic_w		:= null;
			nr_crm_solic_w		:= null;
		
			if (ie_prest_solic_odonto_w = 'ME') then --Medico executor			
				cd_medico_solicitante_w	:= cd_medico_executor_w;			
			elsif (ie_prest_solic_odonto_w = 'MA') then --Medico do atendimento
				cd_medico_solicitante_w	:= cd_medico_resp_w;
			elsif (ie_prest_solic_odonto_w = 'P') then --Prestador
				cd_medico_solicitante_w	:= cd_medico_executor_w;
				cd_cgc_solic_w		:= cd_cgc_prestador_w;				
			elsif (ie_prest_solic_odonto_w = 'N') then --Nao enviar
				cd_medico_solicitante_w	:= null;
				cd_cgc_solic_w		:= null;
			end if;
			
			select	max(uf_crm),
				max(nr_crm)
			into STRICT	uf_conselho_solic_w,
				nr_crm_solic_w
			from	medico
			where	cd_pessoa_fisica	= cd_medico_solicitante_w;
					
			select	max(nm_pessoa_fisica),
				coalesce(uf_conselho_solic_w,max(uf_conselho)),
				coalesce(nr_crm_solic_w,max(ds_codigo_prof)),
				max(nr_cpf)
			into STRICT	nm_contratado_solic_w,
				uf_conselho_solic_w,
				nr_crm_solic_w,
				nr_cpf_solic_w
			from	pessoa_fisica
			where	cd_pessoa_fisica	= cd_medico_solicitante_w;
						
			select	coalesce(max(obter_se_medico_conveniado(cd_estabelecimento_w, cd_medico_solicitante_w , cd_convenio_w, null, null, null,null,null,null, null, null)), 'N')
			into STRICT	ie_conveniado_w
			;

			if (ie_conveniado_w = 'S') then
				select	coalesce(max(obter_nome_medico_convenio(cd_estabelecimento_w, cd_medico_solicitante_w, cd_convenio_w, null, null, null,null,ie_tipo_atendimento_w)), nm_contratado_solic_w)
				into STRICT	nm_contratado_solic_w
				;
			end if;
			
			cd_cbos_solic_w	:= tiss_obter_cbos_medico(cd_medico_solicitante_w, (coalesce(obter_especialidade_medico(cd_medico_solicitante_w, 'C'),0))::numeric , ds_versao_w, cd_convenio_w);
			
			if (cd_cgc_solic_w IS NOT NULL AND cd_cgc_solic_w::text <> '') then
			
				nr_cpf_solic_w	:= null;
			
				select	max(coalesce(cd_interno_solic_w, tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_solic_w, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w))),
					max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_solic_w, cd_setor_entrada_w, 'CGC',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
				into STRICT	cd_interno_solic_w,
					cd_cgc_solic_w
				;

				select	max(ds_razao_social),
					max(cd_cnes)
				into STRICT	nm_contratado_solic_w,
					cd_cnes_solic_w
				from	pessoa_juridica
				where	cd_cgc		= cd_cgc_solic_w;
			
			end if;
		
		end if;

		insert into tiss_conta_contrat_solic(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_guia,
			cd_cgc,
			nr_cpf,
			cd_interno,
			nm_contratado,
			cd_cnes,
			nm_solicitante,
			sg_conselho_solic,
			uf_conselho_solic,
			cd_cbos_solic,
			nr_crm_solic,
			cd_pessoa_fisica)
		values (nextval('tiss_conta_contrat_solic_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_guia_w,
			cd_cgc_solic_w,
			substr(nr_cpf_solic_w,1,14),
			cd_interno_solic_w,
			--tiss_eliminar_caractere(nvl(ds_prestador_tiss_w,nm_contratado_solic_w)),
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'NM_CONTRATADO_SOLIC', cd_convenio_w, tiss_eliminar_caractere(coalesce(ds_prestador_solic_w,nm_contratado_solic_w)) , ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),						
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_CNES', cd_convenio_w, cd_cnes_solic_w , ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),			
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'NM_SOLICITANTE', cd_convenio_w, tiss_eliminar_caractere(nm_solicitante_w) , ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			sg_conselho_solic_w,
			uf_conselho_solic_w,
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_CBOS_SOLIC', cd_convenio_w, cd_cbos_solic_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),

			nr_crm_solic_w,
			cd_medico_solicitante_w);

		-- definir executante da guia
		nr_cpf_exec_w		:= null;
		cd_cgc_exec_w		:= null;
		cd_cnes_exec_w		:= null;
		nm_contratado_exec_w	:= null;
		ie_prestador_w		:= null;
		ie_exec_compl_w		:= 'M';

		if (ie_tiss_tipo_guia_w = '4') and (coalesce(ie_honorario_w, 'N') = 'S') then

			SELECT * FROM tiss_obter_regra_honor_spsadt(cd_convenio_w, cd_estabelecimento_w, ie_responsavel_credito_w, ie_tipo_atendimento_w, cd_setor_entrada_w, ie_prestador_w, ie_exec_compl_w) INTO STRICT ie_prestador_w, ie_exec_compl_w;

			if (cd_cgc_prest_solic_tiss_w IS NOT NULL AND cd_cgc_prest_solic_tiss_w::text <> '') or (ie_prestador_w = 'R') then
				ie_prestador_w := null;
			end if;

			if (ie_gravar_log_conta_w = 'S') then
				CALL TISS_GERAR_LOG_CONTA(	nr_interno_conta_p,
							'Regra Honor SPSADT > '||
							' Seq Guia: '||nr_seq_guia_w||
							' Guia: '||ie_tiss_tipo_guia_w||
							' Resp Credito: '||ie_responsavel_credito_w||
							' Prest Solic: '||cd_cgc_prest_solic_tiss_w||
							' Retorno Regra > '||
							' Prestador Exec: '||ie_prestador_w||
							' Prestador Compl: '||ie_exec_compl_w,
							nm_usuario_p);
			end if;				
			if (ie_prestador_w = 'M') then
				cd_medico_guia_w	:= cd_medico_honor_tiss_w;
			end if;			
		end if;

		if	((coalesce(ie_honorario_w, 'N')	= 'N') or (ie_tiss_tipo_guia_w		= '5') or 	/* os77519. 18/12/2007. inclui esta linha pois estava emitindo o medico como contratado na guia de ri e od. */
			 ((coalesce(ie_honorario_w,'N')	= 'S') and (ie_tiss_tipo_guia_w		= '4') and (coalesce(ie_prestador_w, 'P')	= 'P')) or
			 (ie_tiss_tipo_guia_w		= '3' AND ie_contratado_consulta_w	= 'P')) and -- edgar 18/09/2007, os 68695, forcar o prestador como executante
			(coalesce(ie_contrat_med_w, 'C')	= 'C') and
			((coalesce(cd_medico_exec_tiss_w::text, '') = '') and (coalesce(cd_medico_honor_tiss_w::text, '') = '')) then

			select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prestador_w, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
				max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prestador_w, cd_setor_entrada_w, 'CGC',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
			into STRICT	cd_interno_exec_w,
				cd_cgc_exec_w
			;

			cd_interno_exec_w	:= coalesce(cd_prestador_tiss_w, cd_interno_exec_w);

			select	substr(max(ds_razao_social),1,254),
				substr(max(cd_cnes),1,254),
				substr(max(ds_endereco), 1,254),
				substr(max(ds_municipio),1,254),
				substr(max(cd_municipio_ibge),1,254),
				substr(max(cd_cep),1,254),
				substr(max(sg_estado),1,254),
				substr(max(lpad(coalesce(m.cd_tipo_logradouro, '081'),3,'0')),1,254),
				substr(max(nr_endereco),1,254)
			into STRICT	nm_contratado_exec_w,
				cd_cnes_exec_w,
				ds_endereco_w,
				ds_municipio_w,
				cd_municipio_ibge_w,
				cd_cep_w,
				sg_estado_w,
				ie_tipo_acomodacao_w,
				nr_endereco_w
			FROM pessoa_juridica a
LEFT OUTER JOIN cns_tipo_logradouro m ON (a.nr_seq_tipo_logradouro = m.nr_sequencia)
WHERE cd_cgc				= cd_cgc_prestador_w;
		else
			if	((coalesce(nr_atend_med_p,0) > 0) and (coalesce(nr_seq_prot_med_p,0) > 0)) then
				select	max(tiss_obter_codigo_medico(cd_estabelecimento_w, cd_convenio_w, coalesce(coalesce(cd_medico_exec_tiss_w,cd_medico_honor_tiss_w), cd_medico_guia_w),'CIM')),
					max(tiss_obter_codigo_medico(cd_estabelecimento_w, cd_convenio_w, coalesce(coalesce(cd_medico_exec_tiss_w,cd_medico_honor_tiss_w), cd_medico_guia_w),'CPF'))
				into STRICT	cd_interno_exec_w,
					nr_cpf_exec_w
				;
			else
				select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, coalesce(coalesce(cd_medico_exec_tiss_w,cd_medico_honor_tiss_w), cd_medico_guia_w), null, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
					max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, coalesce(coalesce(cd_medico_exec_tiss_w,cd_medico_honor_tiss_w), cd_medico_guia_w), null, cd_setor_entrada_w, 'CPF',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
				into STRICT	cd_interno_exec_w,
					nr_cpf_exec_w
				;
			end if;

			select	substr(max(nm_pessoa_fisica),1,254),
				substr(max(obter_compl_pf(cd_pessoa_fisica, 1, 'EN')),1,254),
				substr(max(obter_compl_pf(cd_pessoa_fisica, 1, 'CI')),1,254),
				substr(max(obter_compl_pf(cd_pessoa_fisica, 1, 'CDM')),1,254),
				substr(max(obter_compl_pf(cd_pessoa_fisica, 1, 'CEP')),1,254),
				substr(max(obter_compl_pf(cd_pessoa_fisica, 1, 'UF')),1,254),
				substr(max('081'),1,254),
				substr(max(obter_compl_pf(cd_pessoa_fisica, 1, 'NR')),1,254)
			into STRICT	nm_contratado_exec_w,
				ds_endereco_w,
				ds_municipio_w,
				cd_municipio_ibge_w,
				cd_cep_w,
				sg_estado_w,
				ie_tipo_acomodacao_w,
				nr_endereco_w
			from	pessoa_fisica
			where	cd_pessoa_fisica	= coalesce(coalesce(cd_medico_exec_tiss_w,cd_medico_honor_tiss_w), cd_medico_guia_w); /*lhalves OS257743 em 25/11/2010 - Incluido o cd_medico_honor_tiss_w*/
			
			select	coalesce(max(obter_nome_medico_convenio(cd_estabelecimento_w, coalesce(coalesce(cd_medico_exec_tiss_w,cd_medico_honor_tiss_w), cd_medico_guia_w), cd_convenio_w, null, null, null,null,ie_tipo_atendimento_w)), nm_contratado_exec_w)
			into STRICT	nm_contratado_exec_w
			;
						
			select	max(cd_cnes)
			into STRICT	cd_cnes_exec_w
			from	cnes_identificacao
			where	cd_pessoa_fisica	= coalesce(coalesce(cd_medico_exec_tiss_w,cd_medico_honor_tiss_w), cd_medico_guia_w);
			
			if (coalesce(cd_cnes_exec_w::text, '') = '') then
				select	substr(max(cd_cnes),1,254)
				into STRICT	cd_cnes_exec_w
				FROM pessoa_juridica a
LEFT OUTER JOIN cns_tipo_logradouro m ON (a.nr_seq_tipo_logradouro = m.nr_sequencia)
WHERE cd_cgc				= cd_cgc_prestador_w;
			end if;			
			
			if (cd_medico_convenio_proc_w IS NOT NULL AND cd_medico_convenio_proc_w::text <> '') then
				cd_interno_exec_w := cd_medico_convenio_proc_w;
			end if;

		end if;

		if (ie_tiss_tipo_guia_w		= '3') and (ie_contratado_consulta_w	= 'MCP') and (coalesce(ie_contrat_med_w,'M')	= 'M') then

			select	max(obter_se_medico_conveniado(cd_estabelecimento_w, coalesce(cd_medico_exec_tiss_w, cd_medico_guia_w), cd_convenio_w, null, null, null,null,null,null, null, null))
			into STRICT	ie_conveniado_w
			;

			if (ie_conveniado_w = 'S') then
				cd_interno_exec_w	:= null;
				cd_cgc_exec_w		:= null;
				
				if	((coalesce(nr_atend_med_p,0) > 0) and (coalesce(nr_seq_prot_med_p,0) > 0)) then
					select	max(tiss_obter_codigo_medico(cd_estabelecimento_w, cd_convenio_w, coalesce(cd_medico_exec_tiss_w, cd_medico_guia_w),'CIM')),
						max(tiss_obter_codigo_medico(cd_estabelecimento_w, cd_convenio_w, coalesce(cd_medico_exec_tiss_w, cd_medico_guia_w),'CPF')),
						null
					into STRICT	cd_interno_exec_w,
						nr_cpf_exec_w,
						cd_cgc_exec_w
					;
				else
					select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, coalesce(cd_medico_exec_tiss_w, cd_medico_guia_w), null, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
						max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, coalesce(cd_medico_exec_tiss_w, cd_medico_guia_w), null, cd_setor_entrada_w, 'CPF',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
						null
					into STRICT	cd_interno_exec_w,
						nr_cpf_exec_w,
						cd_cgc_exec_w
					;
				end if;

				select	substr(max(nm_pessoa_fisica),1,254),
					substr(max(coalesce((obter_compl_pf(cd_pessoa_fisica, 2, 'EN')),(obter_compl_pf(cd_pessoa_fisica, 1, 'EN')))),1,254),
					substr(max(coalesce((obter_compl_pf(cd_pessoa_fisica, 2, 'CI')),(obter_compl_pf(cd_pessoa_fisica, 1, 'CI')))),1,254),
					substr(max(coalesce((obter_compl_pf(cd_pessoa_fisica, 2, 'CDM')),(obter_compl_pf(cd_pessoa_fisica, 1, 'CDM')))),1,254),
					substr(max(coalesce((obter_compl_pf(cd_pessoa_fisica, 2, 'CEP')),(obter_compl_pf(cd_pessoa_fisica, 1, 'CEP')))),1,254),
					substr(max(coalesce((obter_compl_pf(cd_pessoa_fisica, 2, 'UF')),(obter_compl_pf(cd_pessoa_fisica, 1, 'UF')))),1,254),
					substr(max('081'),1,254),
					substr(max(coalesce((obter_compl_pf(cd_pessoa_fisica, 2, 'NR')),(obter_compl_pf(cd_pessoa_fisica, 1, 'NR')))),1,254)
				into STRICT	nm_contratado_exec_w,
					ds_endereco_w,
					ds_municipio_w,
					cd_municipio_ibge_w,
					cd_cep_w,
					sg_estado_w,
					ie_tipo_acomodacao_w,
					nr_endereco_w
				from	pessoa_fisica
				where	cd_pessoa_fisica	= coalesce(cd_medico_exec_tiss_w, cd_medico_guia_w);

				select	coalesce(max(obter_nome_medico_convenio(cd_estabelecimento_w, coalesce(cd_medico_exec_tiss_w, cd_medico_guia_w), cd_convenio_w, null, null, null,null,ie_tipo_atendimento_w)), nm_contratado_exec_w)
				into STRICT	nm_contratado_exec_w
				;
				
				select	max(cd_cnes)
				into STRICT	cd_cnes_exec_w
				from	cnes_identificacao
				where	cd_pessoa_fisica	= coalesce(coalesce(cd_medico_exec_tiss_w,cd_medico_honor_tiss_w), cd_medico_guia_w);

				if (coalesce(cd_cnes_exec_w::text, '') = '') then
					select	substr(max(cd_cnes),1,254)
					into STRICT	cd_cnes_exec_w
					FROM pessoa_juridica a
LEFT OUTER JOIN cns_tipo_logradouro m ON (a.nr_seq_tipo_logradouro = m.nr_sequencia)
WHERE cd_cgc				= cd_cgc_prestador_w;
				end if;
			end if;
		end if;

		nm_exec_compl_w		:= null;
		nr_seq_conselho_w	:= null;
		cd_cnes_compl_w		:= null;
		sg_conselho_compl_w	:= null;
		uf_conselho_compl_w	:= null;
		nr_crm_compl_w		:= null;
		cd_interno_compl_w	:= null;
		nr_cpf_compl_w		:= null;
		cd_cgc_compl_w		:= null;

		-- definir executante complementar da guia

		-- ie_exec_spsadt_w

		-- 'C' = sem medico
		
		if (ie_exec_spsadt_w <> 'C') or (ie_tiss_tipo_guia_w <> '4') then
			
			if (ie_exec_compl_w = 'R') then
				cd_medico_guia_w	:= cd_medico_executor_w;
			end if;

			-- edgar 15/10/2007, os 71062, so gerar o medico executor se a regra for diferente de "s" - "sem medico"
			if (coalesce(ie_exec_compl_w, 'M') <> 'S') then

				select	max(uf_crm),
					max(nr_crm)
				into STRICT	uf_conselho_compl_w,
					nr_crm_compl_w
				from	medico
				where	cd_pessoa_fisica	= cd_medico_guia_w;
				
				select	max(nm_pessoa_fisica),
					max(nr_seq_conselho),
					max(cd_cnes),
					max(cd_pessoa_fisica),
					coalesce(nr_crm_compl_w,max(ds_codigo_prof))
				into STRICT	nm_exec_compl_w,
					nr_seq_conselho_w,
					cd_cnes_compl_w,
					cd_medico_exec_w,
					nr_crm_compl_w
				from	pessoa_fisica
				where	cd_pessoa_fisica	= cd_medico_guia_w;
				
				if (coalesce(cd_cnes_compl_w::text, '') = '') then
				
					select	max(cd_cnes)
					into STRICT	cd_cnes_compl_w
					from	cnes_identificacao
					where	cd_pessoa_fisica	= cd_medico_guia_w;
					
				end if;

				select	max(coalesce(ie_conselho_prof_tiss,sg_conselho))
				into STRICT	sg_conselho_compl_w
				from	conselho_profissional
				where	nr_sequencia		= nr_seq_conselho_w;

				if (coalesce(uf_conselho_compl_w::text, '') = '') then
					select	max(uf_conselho)
					into STRICT	uf_conselho_compl_w
					from	pessoa_fisica
					where	cd_pessoa_fisica	= cd_medico_guia_w;
				end if;
				
				if	((coalesce(nr_atend_med_p,0) > 0) and (coalesce(nr_seq_prot_med_p,0) > 0)) then
					select	max(tiss_obter_codigo_medico(cd_estabelecimento_w, cd_convenio_w, cd_medico_guia_w,'CIM')),
						max(tiss_obter_codigo_medico(cd_estabelecimento_w, cd_convenio_w, cd_medico_guia_w,'CPF')),
						max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_guia_w, null, cd_setor_entrada_w, 'CRM',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
					into STRICT	cd_interno_compl_w,
						nr_cpf_compl_w,
						nr_crm_compl_id_w
					;
				else
					select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_guia_w, null, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
						max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_guia_w, null, cd_setor_entrada_w, 'CPF',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
						max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_guia_w, null, cd_setor_entrada_w, 'CRM',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
					into STRICT	cd_interno_compl_w,
						nr_cpf_compl_w,
						nr_crm_compl_id_w
					;
				end if;

				if (nr_crm_compl_id_w IS NOT NULL AND nr_crm_compl_id_w::text <> '') then
					uf_conselho_compl_id_w	:= uf_conselho_compl_w;
					sg_conselho_compl_id_w	:= sg_conselho_compl_w;
				end if;
				
				if (cd_medico_guia_w = coalesce(cd_medico_exec_tiss_w, cd_medico_executor_w)) and (cd_medico_convenio_proc_w IS NOT NULL AND cd_medico_convenio_proc_w::text <> '') then
					cd_interno_compl_w	:= cd_medico_convenio_proc_w;
					nr_cpf_compl_w		:= null;
				end if;
			end if;

		end if;

		if (ie_tiss_tipo_guia_w	= '6') then

			cd_medico_exec_tiss_w	:= coalesce(cd_medico_honor_tiss_w, cd_medico_exec_tiss_w);

			if (ie_contrat_exec_hi_w = 'M') then

				cd_interno_honor_w	:= cd_interno_compl_w;
				cd_cgc_honor_w		:= null;
				--nr_cpf_exec_w		:= null;		os94559. 29/05/2008. nao gera cpf para o contratado.
				nr_cpf_honor_w		:= nr_cpf_compl_w;
				nm_contratado_honor_w	:= nm_exec_compl_w;
				cd_cnes_honor_w		:= cd_cnes_compl_w;

			elsif (ie_contrat_exec_hi_w = 'MC') then

				if (obter_se_medico_conveniado(cd_estabelecimento_w, cd_medico_guia_w, cd_convenio_w, cd_cgc_prestador_w, (obter_especialidade_medico(cd_medico_guia_w, 'C'))::numeric , null, cd_setor_entrada_w, null,null, ie_tipo_atendimento_w, null) = 'S') then

					cd_interno_honor_w	:= cd_interno_compl_w;
					if (cd_interno_honor_w IS NOT NULL AND cd_interno_honor_w::text <> '') or (cd_cgc_honor_w IS NOT NULL AND cd_cgc_honor_w::text <> '')  then
						nr_cpf_compl_w		:= null;
						nr_cpf_honor_w		:= null;
						--nr_cpf_exec_w		:= null;
					end if;
					nr_cpf_honor_w		:= nr_cpf_compl_w;
					nm_contratado_honor_w	:= nm_exec_compl_w;
					cd_cnes_honor_w		:= cd_cnes_compl_w;

				else	/* gerar sempre o prestador */
					select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prestador_w, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
						max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prestador_w, cd_setor_entrada_w, 'CGC',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
					into STRICT	cd_interno_exec_w,
						cd_cgc_exec_w
					;

					cd_interno_exec_w	:= coalesce(cd_prestador_tiss_w, cd_interno_exec_w);

					select	substr(max(ds_razao_social),1,254),
						substr(max(cd_cnes),1,254),
						substr(max(ds_endereco), 1,254),
						substr(max(ds_municipio),1,254),
						substr(max(cd_municipio_ibge),1,254),
						substr(max(cd_cep),1,254),
						substr(max(sg_estado),1,254),
						substr(max(lpad(coalesce(m.cd_tipo_logradouro, '081'),3,'0')),1,254),
						substr(max(nr_endereco),1,254)
					into STRICT	nm_contratado_exec_w,
						cd_cnes_exec_w,
						ds_endereco_w,
						ds_municipio_w,
						cd_municipio_ibge_w,
						cd_cep_w,
						sg_estado_w,
						ie_tipo_acomodacao_w,
						nr_endereco_w
					FROM pessoa_juridica a
LEFT OUTER JOIN cns_tipo_logradouro m ON (a.nr_seq_tipo_logradouro = m.nr_sequencia)
WHERE cd_cgc				= cd_cgc_prestador_w;

					cd_interno_honor_w	:= cd_interno_exec_w;
					cd_cgc_honor_w		:= cd_cgc_exec_w;
					nr_cpf_compl_w		:= null;
					nr_cpf_honor_w		:= null;
					--nr_cpf_exec_w		:= null;
					nm_contratado_honor_w	:= nm_contratado_exec_w;
					cd_cnes_honor_w		:= cd_cnes_exec_w;

				end if;

			else			
				SELECT * FROM tiss_obter_regra_exec_honor(	cd_estabelecimento_w, cd_convenio_w, ie_responsavel_credito_w, cd_setor_entrada_w, cd_medico_guia_w, ie_regra_exec_honor_w, cd_cgc_prestador_honor_w, ie_aplica_regra_w, 'N', ie_funcao_medico_w, cd_interno_honor_regra_w, nm_exec_honor_regra_w, nr_seq_regra_exec_honor_w) INTO STRICT ie_regra_exec_honor_w, cd_cgc_prestador_honor_w, ie_aplica_regra_w, cd_interno_honor_regra_w, nm_exec_honor_regra_w, nr_seq_regra_exec_honor_w;

				if (ie_gravar_log_conta_w = 'S') then
					CALL TISS_GERAR_LOG_CONTA(	nr_interno_conta_p,
								'Regra Contratado Honor (Gerar conta guia)  > '||
								' Seq Guia: '||nr_seq_guia_w||
								' Guia: '||ie_tiss_tipo_guia_w||
								' Resp Credito: '||ie_responsavel_credito_w||
								' Medico Guia: '||cd_medico_guia_w||
								' Funcao Medico: '||ie_funcao_medico_w||
								' Retorno Regra > '||
								' Regra Exec: '||ie_regra_exec_honor_w||
								' Aplica Regra: '||ie_aplica_regra_w||
								' CGC Prest Regra: '||cd_cgc_prestador_honor_w||
								' Cod Prestador Regra: '||cd_interno_honor_regra_w||
								' Desc Prestador Regra: '||nm_exec_honor_regra_w,
								nm_usuario_p);
				end if;

				if (coalesce(ie_regra_exec_honor_w,'P') = 'M') then
					select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prestador_w, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
					into STRICT	cd_interno_exec_w
					;

					cd_interno_honor_w	:= cd_interno_compl_w;
					cd_cgc_honor_w		:= null;
					nr_cpf_honor_w		:= nr_cpf_compl_w;
					nm_contratado_honor_w	:= nm_exec_compl_w;
					cd_cnes_honor_w		:= cd_cnes_compl_w;
					cd_cgc_exec_w		:= cd_cgc_prestador_w;

					select	substr(max(ds_razao_social),1,254),
						substr(max(cd_cnes),1,254)
					into STRICT	nm_contratado_exec_w,
						cd_cnes_exec_w
					FROM pessoa_juridica a
LEFT OUTER JOIN cns_tipo_logradouro m ON (a.nr_seq_tipo_logradouro = m.nr_sequencia)
WHERE cd_cgc				= cd_cgc_prestador_w;

				elsif (coalesce(ie_regra_exec_honor_w,'P') = 'P') then

					select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prestador_w, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
						max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prestador_w, cd_setor_entrada_w, 'CGC',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
					into STRICT	cd_interno_exec_w,
						cd_cgc_exec_w
					;

					cd_interno_exec_w	:= coalesce(cd_prestador_tiss_w, cd_interno_exec_w);

					select	substr(max(ds_razao_social),1,254),
						substr(max(cd_cnes),1,254),
						substr(max(ds_endereco), 1,254),
						substr(max(ds_municipio),1,254),
						substr(max(cd_municipio_ibge),1,254),
						substr(max(cd_cep),1,254),
						substr(max(sg_estado),1,254),
						substr(max(lpad(coalesce(m.cd_tipo_logradouro, '081'),3,'0')),1,254),
						substr(max(nr_endereco),1,254)
					into STRICT	nm_contratado_exec_w,
						cd_cnes_exec_w,
						ds_endereco_w,
						ds_municipio_w,
						cd_municipio_ibge_w,
						cd_cep_w,
						sg_estado_w,
						ie_tipo_acomodacao_w,
						nr_endereco_w
					FROM pessoa_juridica a
LEFT OUTER JOIN cns_tipo_logradouro m ON (a.nr_seq_tipo_logradouro = m.nr_sequencia)
WHERE cd_cgc				= cd_cgc_prestador_w;

					cd_interno_honor_w	:= cd_interno_exec_w;
					cd_cgc_honor_w		:= cd_cgc_exec_w;

					if (cd_interno_honor_w IS NOT NULL AND cd_interno_honor_w::text <> '') or (cd_cgc_honor_w IS NOT NULL AND cd_cgc_honor_w::text <> '')  then
						nr_cpf_compl_w		:= null;
						nr_cpf_honor_w		:= null;
						cd_interno_compl_w	:= null;
					end if;

					nm_contratado_honor_w	:= nm_contratado_exec_w;
					cd_cnes_honor_w		:= cd_cnes_exec_w;								

				elsif (coalesce(ie_regra_exec_honor_w,'P') = 'R')  then

					select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prestador_w, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
						max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prestador_w, cd_setor_entrada_w, 'CGC',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
					into STRICT	cd_interno_exec_w,
						cd_cgc_exec_w
					;

					cd_interno_exec_w	:= coalesce(cd_prestador_tiss_w, cd_interno_exec_w);

					select	substr(max(ds_razao_social),1,254),
						substr(max(cd_cnes),1,254)
					into STRICT	nm_contratado_exec_w,
						cd_cnes_exec_w
					FROM pessoa_juridica a
LEFT OUTER JOIN cns_tipo_logradouro m ON (a.nr_seq_tipo_logradouro = m.nr_sequencia)
WHERE cd_cgc				= cd_cgc_prestador_w;

					if (coalesce(cd_cgc_prestador_honor_w::text, '') = '') then
						cd_cgc_prestador_honor_w := cd_cgc_prestador_w;
					end if;

					select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prestador_honor_w, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
						max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prestador_honor_w, cd_setor_entrada_w, 'CGC',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
					into STRICT	cd_interno_honor_w,
						cd_cgc_honor_w
					;

					--cd_interno_honor_w	:= nvl(cd_prestador_tiss_w, cd_interno_honor_w);
					select	substr(max(ds_razao_social),1,254),
						substr(max(cd_cnes),1,254),
						substr(max(ds_endereco), 1,254),
						substr(max(ds_municipio),1,254),
						substr(max(cd_municipio_ibge),1,254),
						substr(max(cd_cep),1,254),
						substr(max(sg_estado),1,254),
						substr(max(lpad(coalesce(m.cd_tipo_logradouro, '081'),3,'0')),1,254),
						substr(max(nr_endereco),1,254)
					into STRICT	nm_contratado_honor_w,
						cd_cnes_honor_w,
						ds_endereco_w,
						ds_municipio_w,
						cd_municipio_ibge_w,
						cd_cep_w,
						sg_estado_w,
						ie_tipo_acomodacao_w,
						nr_endereco_w
					FROM pessoa_juridica a
LEFT OUTER JOIN cns_tipo_logradouro m ON (a.nr_seq_tipo_logradouro = m.nr_sequencia)
WHERE cd_cgc				= cd_cgc_prestador_honor_w;
					
					/*lhalves OS364353 em 21/09/2011*/

					if (cd_interno_honor_regra_w IS NOT NULL AND cd_interno_honor_regra_w::text <> '') then
						cd_interno_honor_w	:= cd_interno_honor_regra_w;
					end if;
					if (nm_exec_honor_regra_w IS NOT NULL AND nm_exec_honor_regra_w::text <> '') then
						nm_contratado_honor_w	:= nm_exec_honor_regra_w;
					end if;	

					if (cd_interno_honor_w IS NOT NULL AND cd_interno_honor_w::text <> '') or (cd_cgc_honor_w IS NOT NULL AND cd_cgc_honor_w::text <> '')  then
						nr_cpf_compl_w		:= null;
						nr_cpf_honor_w		:= null;
						cd_interno_compl_w	:= null;
					end if;

				elsif (coalesce(ie_regra_exec_honor_w,'P') = 'F') then --Lhalves OS 197269 03/03/2010 - Gerar o funcionario na guia de HI
					select	max(nm_pessoa_fisica),
						max(nr_seq_conselho),
						max(cd_cnes),
						max(cd_pessoa_fisica),
						max(nr_cpf)
					into STRICT	nm_exec_compl_w,
						nr_seq_conselho_w,
						cd_cnes_compl_w,
						cd_medico_exec_w,
						nr_cpf_honor_w
					from	pessoa_fisica
					where	cd_pessoa_fisica	= cd_funcionario_honor_w;

					if (coalesce(ie_aplica_regra_w,'A')='A') then --Lhalves - ambos
						cd_interno_honor_w	:= cd_interno_compl_w;
						cd_cgc_honor_w		:= null;
						nr_cpf_honor_w		:= nr_cpf_honor_w;
						nm_contratado_honor_w	:= nm_exec_compl_w;
						cd_cnes_honor_w		:= cd_cnes_compl_w;
						cd_cgc_exec_w		:= cd_cgc_prestador_w;

					elsif (coalesce(ie_aplica_regra_w,'A') = 'C') then --Lhalves - Apenas para o campo 14
						cd_interno_honor_w	:= cd_interno_compl_w;
						cd_cgc_honor_w		:= null;
						nm_contratado_honor_w	:= nm_exec_compl_w;
						cd_cnes_honor_w		:= cd_cnes_compl_w;
						cd_cgc_exec_w		:= cd_cgc_prestador_w;

						select	max(nm_pessoa_fisica),
							max(nr_seq_conselho),
							max(cd_cnes)
						into STRICT	nm_exec_compl_w,
							nr_seq_conselho_w,
							cd_cnes_compl_w
						from	pessoa_fisica
						where	cd_pessoa_fisica	= cd_medico_executor_w;

						cd_medico_exec_w := cd_medico_executor_w;

					elsif (coalesce(ie_aplica_regra_w,'A') = 'P') then -- Lhalves - apenas para o campo 18
						cd_interno_honor_w		:= cd_interno_compl_w;
						cd_cgc_honor_w			:= null;
						nr_cpf_exec_w			:= nr_cpf_honor_w;
						nm_contratado_honor_w	:= nm_exec_compl_w;
						cd_cnes_honor_w			:= cd_cnes_compl_w;
						cd_cgc_exec_w			:= cd_cgc_prestador_w;

						-- lhalves 17/03 OS 197269- Gerar o prestador no campo 14, pois no 18 ira gerar o funcionario
						select	substr(max(ds_razao_social),1,254),
							substr(max(cd_cnes),1,254),
							substr(max(lpad(coalesce(m.cd_tipo_logradouro, '081'),3,'0')),1,254)
						into STRICT	nm_contratado_honor_w,
							cd_cnes_honor_w,
							ie_tipo_acomodacao_w
						FROM pessoa_juridica a
LEFT OUTER JOIN cns_tipo_logradouro m ON (a.nr_seq_tipo_logradouro = m.nr_sequencia)
WHERE cd_cgc				= cd_cgc_prestador_w;

						select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prestador_w, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
							max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prestador_w, cd_setor_entrada_w, 'CGC',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
						into STRICT	cd_interno_exec_w,
							cd_cgc_exec_w
						;

						cd_interno_honor_w	:= coalesce(cd_prestador_tiss_w, cd_interno_exec_w);
						cd_cgc_honor_w		:= cd_cgc_exec_w;
						--gravar informacoes de conselho do funcionario
						select	max(coalesce(ie_conselho_prof_tiss,sg_conselho))
						into STRICT	sg_conselho_compl_w
						from	conselho_profissional
						where	nr_sequencia		= nr_seq_conselho_w;

						select	max(uf_crm),
							max(nr_crm)
						into STRICT	uf_conselho_compl_w,
							nr_crm_compl_w
						from	medico
						where	cd_pessoa_fisica	= cd_funcionario_honor_w;

						if (coalesce(uf_conselho_compl_w::text, '') = '') then
							select	max(uf_conselho)
							into STRICT	uf_conselho_compl_w
							from	pessoa_fisica
							where	cd_pessoa_fisica	= cd_funcionario_honor_w;
						end if;
						
						if (coalesce(nr_crm_compl_w::text, '') = '') then
							select	max(ds_codigo_prof)
							into STRICT	nr_crm_compl_w
							from	pessoa_fisica
							where	cd_pessoa_fisica	= cd_funcionario_honor_w;
						end if;

					end if;
					
				elsif (coalesce(ie_regra_exec_honor_w,'P') = 'E') then
				
					if (coalesce(cd_medico_exec_proc_honor_w,0) > 0) then
				
						select	max(nm_pessoa_fisica),
							max(nr_seq_conselho),
							max(cd_cnes),
							max(cd_pessoa_fisica),
							max(nr_cpf)
						into STRICT	nm_contratado_honor_w,
							nr_seq_conselho_w,
							cd_cnes_honor_w,
							cd_medico_exec_w,
							nr_cpf_honor_w
						from	pessoa_fisica
						where	cd_pessoa_fisica	= cd_medico_exec_proc_honor_w;
						
						cd_interno_honor_w	:= cd_interno_compl_w;
						cd_cgc_honor_w		:= null;						
						cd_cgc_exec_w		:= cd_cgc_prestador_w;

						select	max(nm_pessoa_fisica),
							max(nr_seq_conselho),
							max(cd_cnes)
						into STRICT	nm_exec_compl_w,
							nr_seq_conselho_w,
							cd_cnes_compl_w
						from	pessoa_fisica
						where	cd_pessoa_fisica	= cd_medico_executor_w;
						
						select	substr(max(ds_razao_social),1,254),
							substr(max(cd_cnes),1,254)
						into STRICT	nm_contratado_exec_w,
							cd_cnes_exec_w
						FROM pessoa_juridica a
LEFT OUTER JOIN cns_tipo_logradouro m ON (a.nr_seq_tipo_logradouro = m.nr_sequencia)
WHERE cd_cgc				= cd_cgc_prestador_w;

						cd_medico_exec_w := cd_medico_executor_w;
					else
					
						select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prestador_w, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
						into STRICT	cd_interno_exec_w
						;

						cd_interno_honor_w	:= cd_interno_compl_w;
						cd_cgc_honor_w		:= null;
						nr_cpf_honor_w		:= nr_cpf_compl_w;
						nm_contratado_honor_w	:= nm_exec_compl_w;
						cd_cnes_honor_w		:= cd_cnes_compl_w;
						cd_cgc_exec_w		:= cd_cgc_prestador_w;

						select	substr(max(ds_razao_social),1,254),
							substr(max(cd_cnes),1,254)
						into STRICT	nm_contratado_exec_w,
							cd_cnes_exec_w
						FROM pessoa_juridica a
LEFT OUTER JOIN cns_tipo_logradouro m ON (a.nr_seq_tipo_logradouro = m.nr_sequencia)
WHERE cd_cgc				= cd_cgc_prestador_w;
					
					end if;					
				end if;
			end if;
		end if;		

		select	coalesce(max(obter_nome_medico_convenio(cd_estabelecimento_w, coalesce(cd_medico_exec_tiss_w, cd_medico_guia_w), cd_convenio_w, null, null, null,null,ie_tipo_atendimento_w)), nm_exec_compl_w)
		into STRICT	nm_exec_compl_w
		;

		if (coalesce(cd_interno_exec_w, 'X') <> 'X') then
			cd_cgc_exec_w	:= null;
		end if;

		if (coalesce(cd_interno_exec_w, 'X')	<> 'X') or (coalesce(cd_cgc_exec_w, 'X')	<> 'X') then
			nr_cpf_exec_w	:= null;
		end if;

		if (coalesce(nr_cpf_exec_w, 'X')	<> 'X') then
			select	substr(obter_nome_pf_pj(coalesce(coalesce(cd_medico_exec_tiss_w,cd_medico_honor_tiss_w),cd_medico_guia_w),null),1,254)
			into STRICT	nm_contratado_exec_w
			;
		end if;
		
		if (ie_tiss_tipo_guia_w = '11') then
		
			cd_cgc_exec_w		:= null;
			nr_cpf_exec_w		:= null;
			cd_interno_exec_w	:= null;
			nm_contratado_exec_w	:= null;
			nr_crm_compl_w		:= null;
			uf_conselho_compl_w	:= null;
			cd_cnes_exec_w		:= null;			
			
			/*Parametro "Contratado executante na guia de tratamento odontologico"*/

			if (ie_contrat_exec_odonto_w = 'ME') then
			
				select	max(uf_crm),
					max(nr_crm)
				into STRICT	uf_conselho_compl_w,
					nr_crm_compl_w
				from	medico
				where	cd_pessoa_fisica	= cd_medico_executor_w;
						
				select	max(nm_pessoa_fisica),						
					coalesce(uf_conselho_compl_w,max(uf_conselho)),
					coalesce(nr_crm_compl_w,max(ds_codigo_prof)),
					max(nr_cpf)
				into STRICT	nm_contratado_exec_w,					
					uf_conselho_compl_w,
					nr_crm_compl_w,
					nr_cpf_exec_w
				from	pessoa_fisica
				where	cd_pessoa_fisica	= cd_medico_executor_w;	

				select	max(cd_cnes)
				into STRICT	cd_cnes_exec_w
				from	cnes_identificacao
				where	cd_pessoa_fisica	= cd_medico_executor_w;				
				
				select	coalesce(max(obter_se_medico_conveniado(cd_estabelecimento_w, cd_medico_executor_w , cd_convenio_w, null, null, null,null,null,null, null, null)), 'N')
				into STRICT	ie_conveniado_w
				;

				if (ie_conveniado_w = 'S') then
					select	coalesce(max(obter_nome_medico_convenio(cd_estabelecimento_w, cd_medico_executor_w, cd_convenio_w, null, null, null,null,ie_tipo_atendimento_w)), nm_contratado_exec_w),
						max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_executor_w, null, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
					into STRICT	nm_contratado_exec_w,
						cd_interno_exec_w
					;					
				end if;
			
			elsif (ie_contrat_exec_odonto_w = 'MA') then
				select	max(uf_crm),
					max(nr_crm)
				into STRICT	uf_conselho_compl_w,
					nr_crm_compl_w
				from	medico
				where	cd_pessoa_fisica	= cd_medico_resp_w;
						
				select	max(nm_pessoa_fisica),						
					coalesce(uf_conselho_compl_w,max(uf_conselho)),
					coalesce(nr_crm_compl_w,max(ds_codigo_prof)),
					max(nr_cpf)
				into STRICT	nm_contratado_exec_w,					
					uf_conselho_compl_w,
					nr_crm_compl_w,
					nr_cpf_exec_w
				from	pessoa_fisica
				where	cd_pessoa_fisica	= cd_medico_resp_w;	

				select	max(cd_cnes)
				into STRICT	cd_cnes_exec_w
				from	cnes_identificacao
				where	cd_pessoa_fisica	= cd_medico_resp_w;					
				
				select	coalesce(max(obter_se_medico_conveniado(cd_estabelecimento_w, cd_medico_resp_w , cd_convenio_w, null, null, null,null,null,null, null, null)), 'N')
				into STRICT	ie_conveniado_w
				;

				if (ie_conveniado_w = 'S') then
					select	coalesce(max(obter_nome_medico_convenio(cd_estabelecimento_w, cd_medico_resp_w, cd_convenio_w, null, null, null,null,ie_tipo_atendimento_w)), nm_contratado_exec_w),
						max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_resp_w, null, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
					into STRICT	nm_contratado_exec_w,
						cd_interno_exec_w
					;
				end if;
			
			elsif (ie_contrat_exec_odonto_w = 'P') then
			
				nr_cpf_solic_w	:= null;
			
				select	max(coalesce(cd_interno_solic_w, tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prestador_w, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w))),
					max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prestador_w, cd_setor_entrada_w, 'CGC',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
				into STRICT	cd_interno_exec_w,
					cd_cgc_exec_w
				;

				select	max(ds_razao_social),
					max(cd_cnes)
				into STRICT	nm_contratado_exec_w,
					cd_cnes_exec_w
				from	pessoa_juridica
				where	cd_cgc		= cd_cgc_prestador_w;	

				/*Caso esteja parametrizado para enviar uma PJ, entao o numero do conselho  e UF, enviado do medico executor.*/

				select	max(uf_crm),
					max(nr_crm)
				into STRICT	uf_conselho_compl_w,
					nr_crm_compl_w
				from	medico
				where	cd_pessoa_fisica	= cd_medico_executor_w;
						
				select	coalesce(uf_conselho_compl_w,max(uf_conselho)),
					coalesce(nr_crm_compl_w,max(ds_codigo_prof))
				into STRICT	uf_conselho_compl_w,
					nr_crm_compl_w
				from	pessoa_fisica
				where	cd_pessoa_fisica	= cd_medico_executor_w;			
			
			end if;
			
			cd_cgc_compl_w		:= null;
			nr_cpf_compl_w		:= null;
			cd_interno_compl_w	:= null;
			nm_exec_compl_w		:= null;
			uf_conselho_compl_id_w	:= null;
			nr_crm_compl_id_w	:= null;
			cd_cbos_compl_w		:= null;			
			
			/*Parametro "Profissional executante na guia de tratamento odontologico"*/

			if (ie_prof_exec_odonto_w = 'ME') then
				select	max(uf_crm),
					max(nr_crm)
				into STRICT	uf_conselho_compl_id_w,
					nr_crm_compl_id_w
				from	medico
				where	cd_pessoa_fisica	= cd_medico_executor_w;
						
				select	max(nm_pessoa_fisica),						
					coalesce(uf_conselho_compl_w,max(uf_conselho)),
					coalesce(nr_crm_compl_w,max(ds_codigo_prof)),
					max(nr_cpf)
				into STRICT	nm_exec_compl_w,					
					uf_conselho_compl_id_w,
					nr_crm_compl_id_w,
					nr_cpf_compl_w
				from	pessoa_fisica
				where	cd_pessoa_fisica	= cd_medico_executor_w;		

				cd_cbos_compl_w	:= tiss_obter_cbos_medico(cd_medico_executor_w, (coalesce(obter_especialidade_medico(cd_medico_executor_w, 'C'),0))::numeric , ds_versao_w, cd_convenio_w);
				
				select	coalesce(max(obter_se_medico_conveniado(cd_estabelecimento_w, cd_medico_executor_w , cd_convenio_w, null, null, null,null,null,null, null, null)), 'N')
				into STRICT	ie_conveniado_w
				;

				if (ie_conveniado_w = 'S') then
					select	coalesce(max(obter_nome_medico_convenio(cd_estabelecimento_w, cd_medico_executor_w, cd_convenio_w, null, null, null,null,ie_tipo_atendimento_w)), nm_exec_compl_w)						
					into STRICT	nm_exec_compl_w						
					;
				end if;
				
			elsif (ie_prof_exec_odonto_w = 'MA') then
				select	max(uf_crm),
					max(nr_crm)
				into STRICT	uf_conselho_compl_id_w,
					nr_crm_compl_id_w
				from	medico
				where	cd_pessoa_fisica	= cd_medico_resp_w;
						
				select	max(nm_pessoa_fisica),						
					coalesce(uf_conselho_compl_w,max(uf_conselho)),
					coalesce(nr_crm_compl_w,max(ds_codigo_prof)),
					max(nr_cpf)
				into STRICT	nm_exec_compl_w,					
					uf_conselho_compl_id_w,
					nr_crm_compl_id_w,
					nr_cpf_compl_w
				from	pessoa_fisica
				where	cd_pessoa_fisica	= cd_medico_resp_w;

				cd_cbos_compl_w	:= tiss_obter_cbos_medico(cd_medico_resp_w, (coalesce(obter_especialidade_medico(cd_medico_resp_w, 'C'),0))::numeric , ds_versao_w, cd_convenio_w);				
				
				select	coalesce(max(obter_se_medico_conveniado(cd_estabelecimento_w, cd_medico_resp_w , cd_convenio_w, null, null, null,null,null,null, null, null)), 'N')
				into STRICT	ie_conveniado_w
				;

				if (ie_conveniado_w = 'S') then
					select	coalesce(max(obter_nome_medico_convenio(cd_estabelecimento_w, cd_medico_resp_w, cd_convenio_w, null, null, null,null,ie_tipo_atendimento_w)), nm_exec_compl_w)						
					into STRICT	nm_exec_compl_w						
					;
				end if;
			elsif (ie_prof_exec_odonto_w = 'P') then
				nr_cpf_compl_w	:= null;
			
				select	max(coalesce(cd_interno_solic_w, tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prestador_w, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w))),
					max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prestador_w, cd_setor_entrada_w, 'CGC',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
				into STRICT	cd_interno_compl_w,
					cd_cgc_compl_w
				;

				select	max(ds_razao_social)
				into STRICT	nm_exec_compl_w					
				from	pessoa_juridica
				where	cd_cgc		= cd_cgc_prestador_w;	

				/*Caso esteja parametrizado para enviar uma PJ, entao o numero do conselho  e UF, enviado do medico executor.*/

				select	max(uf_crm),
					max(nr_crm)
				into STRICT	uf_conselho_compl_id_w,
					nr_crm_compl_id_w
				from	medico
				where	cd_pessoa_fisica	= cd_medico_executor_w;
				
				cd_cbos_compl_w	:= tiss_obter_cbos_medico(cd_medico_executor_w, (coalesce(obter_especialidade_medico(cd_medico_executor_w, 'C'),0))::numeric , ds_versao_w, cd_convenio_w);
						
				select	coalesce(uf_conselho_compl_id_w,max(uf_conselho)),
					coalesce(nr_crm_compl_id_w,max(ds_codigo_prof))
				into STRICT	uf_conselho_compl_w,
					nr_crm_compl_id_w
				from	pessoa_fisica
				where	cd_pessoa_fisica	= cd_medico_executor_w;	
			end if;
		
		end if;

		/*lhalves OS231990 em 15/07/2010 - Verificar se existe prestador, para que no xml nao fique em branco*/

		if (ie_tiss_tipo_guia_w	= '6') and
			((coalesce(cd_cgc_exec_w::text, '') = '') and (coalesce(nr_cpf_exec_w::text, '') = '') and (coalesce(cd_interno_exec_w::text, '') = '')) then

			select	max(cd_cnes),
				max(ds_razao_social),
				max(cd_cgc)
			into STRICT	cd_cnes_exec_w,
				nm_contratado_exec_w,
				cd_cgc_exec_w
			from	pessoa_juridica
			where	cd_cgc		= cd_cgc_estab_w;

			select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_exec_w, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
			into STRICT	cd_interno_exec_w
			;

			if (coalesce(cd_interno_exec_w,'X') <> 'X') then
				cd_cgc_exec_w := null;
			end if;
		end if;

		if (ds_mascara_crm_w IS NOT NULL AND ds_mascara_crm_w::text <> '') then

			if (length(nr_crm_compl_w) < length(ds_mascara_crm_w)) then
				qt_digitos_crm_w	:= length(ds_mascara_crm_w);
				nr_crm_compl_w		:= lpad(nr_crm_compl_w, qt_digitos_crm_w,0);
			end if;

			begin
			select	TISS_OBTER_COD_USUARIO_MASC(nr_crm_compl_w, ds_mascara_crm_w)
			into STRICT	nr_crm_mascara_w
			;

			exception
			when others then
				nr_crm_mascara_w	:= null;
			end;

			if (nr_crm_mascara_w IS NOT NULL AND nr_crm_mascara_w::text <> '') then
				nr_crm_compl_w	:= nr_crm_mascara_w;
			end if;
		end if;

		insert	into tiss_conta_contrat_exec(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_guia,
			cd_cgc,
			nr_cpf,
			cd_interno,
			nm_contratado,
			cd_cnes,
			nm_exec_compl,
			sg_conselho_compl,
			uf_conselho_compl,
			cd_cbos_compl,
			cd_cgc_compl,
			nr_cpf_compl,
			cd_interno_compl,
			ie_funcao_medico_compl,
			ie_tipo_acomodacao,
			nr_crm_compl,
			cd_cnes_compl,
			ds_logradouro,
			nm_municipio,
			sg_estado,
			cd_municipio_ibge,
			cd_cep,
			ie_tipo_logradouro,
			nr_endereco,
			sg_conselho_compl_id,
			uf_conselho_compl_id,
			nr_crm_compl_id,
			cd_interno_honor,
			cd_cgc_honor,
			nr_cpf_honor,
			nm_contratado_honor,
			cd_cnes_honor,
			cd_pessoa_fisica)
		values (nextval('tiss_conta_contrat_exec_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_guia_w,
			cd_cgc_exec_w,
			nr_cpf_exec_w,
			substr(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_INTERNO_EXEC', cd_convenio_w, coalesce(CASE WHEN ie_honorario_w='N' THEN  cd_prestador_tiss_w  ELSE null END , cd_interno_exec_w), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),1,30),
			substr(tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'NM_CONTRATADO', cd_convenio_w, tiss_eliminar_caractere(coalesce(ds_prestador_tiss_w, nm_contratado_exec_w)), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),1,70),					
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_CNES', cd_convenio_w, cd_cnes_exec_w , ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'NM_EXECUTOR', cd_convenio_w, tiss_eliminar_caractere(nm_exec_compl_w), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'SG_CONSELHO', cd_convenio_w, sg_conselho_compl_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'UF_CRM', cd_convenio_w, uf_conselho_compl_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_CBOS', cd_convenio_w, cd_cbos_compl_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			cd_cgc_compl_w,
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_INTERNO', cd_convenio_w, nr_cpf_compl_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_INTERNO', cd_convenio_w, cd_interno_compl_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'IE_GRAU_PARTIC', cd_convenio_w, ie_funcao_medico_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			ie_tipo_acomodacao_w,
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'NR_CRM', cd_convenio_w, nr_crm_compl_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w,ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			cd_cnes_compl_w,			
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'DS_ENDERECO', cd_convenio_w, ds_endereco_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w,ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'DS_MUNICIPIO', cd_convenio_w, ds_municipio_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w,ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'SG_ESTADO', cd_convenio_w, sg_estado_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w,ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_MUNICIPIO_IBGE', cd_convenio_w, lpad(cd_municipio_ibge_w, 7, 0), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w,ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_CEP', cd_convenio_w, replace(cd_cep_w, '-',''), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w,ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),			
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'DS_TIPO_LOGRADOURO', cd_convenio_w, ie_tipo_acomodacao_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w,ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),			
			nr_endereco_w,
			sg_conselho_compl_id_w,
			uf_conselho_compl_id_w,
			nr_crm_compl_id_w,
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_INTERNO_HONOR', cd_convenio_w, cd_interno_honor_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),
			cd_cgc_honor_w,
			nr_cpf_honor_w,
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'NM_CONTRATADO_HONOR', cd_convenio_w, tiss_eliminar_caractere(nm_contratado_honor_w), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),			
			tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'CD_CNES_HONOR', cd_convenio_w, cd_cnes_honor_w , ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'),			
			cd_medico_exec_w);
			
		if (coalesce(nr_interno_conta_p,0) > 0) then
				
			update	tiss_conta_proc
			set	nr_seq_guia				= nr_seq_guia_w
			where	nr_interno_conta			= nr_interno_conta_p
			and	ie_tiss_tipo_guia			= ie_tiss_tipo_guia_w
			and	coalesce(nr_guia_operadora,cd_autorizacao)	= coalesce(nr_guia_operadora_w,cd_autorizacao_w)
			and	coalesce(nr_seq_guia::text, '') = ''
			and	((nr_guia_prestador			= nr_guia_prest_proc_w) or (coalesce(nr_guia_prest_proc_w::text, '') = ''))
			and	((cd_cgc_prestador			= cd_cgc_prestador_w) or (cd_medico_exec_tiss			= cd_medico_exec_tiss_w) or (cd_medico_honor_tiss			= cd_medico_honor_tiss_w))
			and	CASE WHEN ie_tiss_tipo_guia_w='3' THEN  nr_sequencia  ELSE nr_seq_proc_consulta_w END  = nr_seq_proc_consulta_w
			and	coalesce(cd_medico_executor,0)		= coalesce(cd_medico_executor_w,0)
			and	((cd_cgc_prest_solic_tiss 		= cd_cgc_prest_solic_tiss_w) or
				 ((coalesce(cd_cgc_prest_solic_tiss::text, '') = '') 	and (coalesce(cd_cgc_prest_solic_tiss_w::text, '') = '')))
			and	((cd_medico_solic_tiss 			= cd_medico_solic_tiss_w) or
				 ((coalesce(cd_medico_solic_tiss::text, '') = '') 	and (coalesce(cd_medico_solic_tiss_w::text, '') = '')))
			and	((coalesce(ie_regra_solic_w,'N') <> 'R') or
				 ((cd_medico_prof_solic_tiss 		= cd_medico_prof_solic_tiss_w) or
				  ((coalesce(cd_medico_prof_solic_tiss::text, '') = '') 	and (coalesce(cd_medico_prof_solic_tiss_w::text, '') = ''))))
			and	((cd_prestador_tiss			= cd_prestador_tiss_w) or
				 ((coalesce(cd_prestador_tiss::text, '') = '')		and (coalesce(cd_prestador_tiss_w::text, '') = '')))
			and	((cd_cgc_prest_honor_tiss		= cd_cgc_prest_honor_tiss_w) or
				 ((coalesce(cd_cgc_prest_honor_tiss::text, '') = '') 	and (coalesce(cd_cgc_prest_honor_tiss_w::text, '') = '')) or (ie_tiss_tipo_guia_w <> '6'))
			and	((ie_tiss_tipo_guia_w <> '4') or (coalesce(ds_indicacao_proc::text, '') = '') or (ds_indicacao_proc = ds_indicacao_w))
			and	coalesce(cd_cbos,coalesce(cd_cbos_compl_w,'0'))	= coalesce(cd_cbos_compl_w,'0')
			and	coalesce(ie_funcao_medico, 'X')		= coalesce(ie_funcao_medico_w, coalesce(ie_funcao_medico, 'X'))
			and	coalesce(CASE WHEN ie_honorario='S' THEN  ie_responsavel_credito END , coalesce(ie_responsavel_credito_w, 'X')) = coalesce(ie_responsavel_credito_w, 'X')
			and	coalesce(ie_honorario, 'N')			= coalesce(ie_honorario_w, 'N')
			and	((coalesce(ie_honorario,'N') = 'S')		
				  or (coalesce(ie_honorario,'N') = 'N' and tiss_obter_se_honor_spsadt(cd_convenio_w, cd_estabelecimento_w, ie_responsavel_credito, ie_tipo_atendimento_w, cd_setor_entrada_w, 'N', ie_honorario) = 'N'))
			and	(
					(coalesce(ie_senha_guia_w,'N') 			in ('ACA', 'N','G','ASG','ACC','ATG','ATA','AP','ACG')) or (coalesce(cd_senha,'X')		= coalesce(cd_senha_w,'X'))
				)
			and	(
					(ie_tiss_tipo_guia <> '5') or (coalesce(vl_procedimento, 0) <> 0) or (ie_ri_zerado_w	in ('S','R','ZX'))
				)
			and	coalesce(ie_tipo_atend_tiss, coalesce(coalesce(ie_tipo_atend_proc_w, ie_tipo_atend_tiss_w), '0')) =  coalesce(coalesce(ie_tipo_atend_proc_w, ie_tipo_atend_tiss_w), '0');
		else
	
			update	tiss_conta_proc
			set	nr_seq_guia				= nr_seq_guia_w
			where	(nr_atend_med				= nr_atend_med_p AND nr_seq_prot_med			= nr_seq_prot_med_p)
			and	ie_tiss_tipo_guia			= ie_tiss_tipo_guia_w
			and	coalesce(nr_guia_operadora,cd_autorizacao)	= coalesce(nr_guia_operadora_w,cd_autorizacao_w)
			and	coalesce(nr_seq_guia::text, '') = ''
			and	((nr_guia_prestador			= nr_guia_prest_proc_w) or (coalesce(nr_guia_prest_proc_w::text, '') = ''))
			and	((cd_cgc_prestador			= cd_cgc_prestador_w) or (cd_medico_exec_tiss			= cd_medico_exec_tiss_w) or (cd_medico_honor_tiss			= cd_medico_honor_tiss_w))
			and	CASE WHEN ie_tiss_tipo_guia_w='3' THEN  nr_sequencia  ELSE nr_seq_proc_consulta_w END  = nr_seq_proc_consulta_w
			and	coalesce(cd_medico_executor,0)		= coalesce(cd_medico_executor_w,0)
			and	coalesce(cd_med_solic_tasymed,0)		= coalesce(cd_med_solic_tasymed_w,0)
			and	((cd_cgc_prest_solic_tiss 		= cd_cgc_prest_solic_tiss_w) or
				 ((coalesce(cd_cgc_prest_solic_tiss::text, '') = '') 	and (coalesce(cd_cgc_prest_solic_tiss_w::text, '') = '')))
			and	((cd_medico_solic_tiss 			= cd_medico_solic_tiss_w) or
				 ((coalesce(cd_medico_solic_tiss::text, '') = '') 	and (coalesce(cd_medico_solic_tiss_w::text, '') = '')))
			and	((coalesce(ie_regra_solic_w,'N') <> 'R') or
				 ((cd_medico_prof_solic_tiss 			= cd_medico_prof_solic_tiss_w) or
				  ((coalesce(cd_medico_prof_solic_tiss::text, '') = '') 		and (coalesce(cd_medico_prof_solic_tiss_w::text, '') = ''))))
			and	((cd_prestador_tiss				= cd_prestador_tiss_w) or
				 ((coalesce(cd_prestador_tiss::text, '') = '')			and (coalesce(cd_prestador_tiss_w::text, '') = '')))
			and	((cd_cgc_prest_honor_tiss			= cd_cgc_prest_honor_tiss_w) or
				 ((coalesce(cd_cgc_prest_honor_tiss::text, '') = '') 		and (coalesce(cd_cgc_prest_honor_tiss_w::text, '') = '')) or (ie_tiss_tipo_guia_w <> '6'))			
			and	coalesce(cd_cbos,coalesce(cd_cbos_compl_w,'0'))	= coalesce(cd_cbos_compl_w,'0')
			and	coalesce(ie_funcao_medico, 'X')			= coalesce(ie_funcao_medico_w, coalesce(ie_funcao_medico, 'X'))
			and	coalesce(CASE WHEN ie_honorario='S' THEN  ie_responsavel_credito END , coalesce(ie_responsavel_credito_w, 'X')) = coalesce(ie_responsavel_credito_w, 'X')
			and	coalesce(ie_honorario, 'N')			= coalesce(ie_honorario_w, 'N')
			and	(
					(coalesce(ie_senha_guia_w,'N') 			in ('ACA', 'N','G','ASG','ACC','ATG','ATA','AP','ACG')) or
					--(nvl(cd_senha, nvl(cd_senha_w, 'X'))		= nvl(cd_senha_w, 'X'))
					(coalesce(cd_senha,'X')		= coalesce(cd_senha_w,'X')) /*lhalves OS 452943 em 07/06/2012 - Desfa forma porque quando a senha e para ser do procedimento, deve gerar uma nova guia caso nao o procedimento nao tenha senha*/
				)
			and	(
					(ie_tiss_tipo_guia <> '5') or		-- edgar 22/08/2007, os 65088, so vincular o procedimento set parametrizado corretamente
					(coalesce(vl_procedimento, 0) <> 0) or (ie_ri_zerado_w	in ('S','R','ZX'))
				)
			and	coalesce(ie_tipo_atend_tiss, coalesce(coalesce(ie_tipo_atend_proc_w, ie_tipo_atend_tiss_w), '0')) =  coalesce(coalesce(ie_tipo_atend_proc_w, ie_tipo_atend_tiss_w), '0');
		end if;

		/*update	tiss_conta_partic
		set	nr_seq_guia				= nr_seq_guia_w
--dsantos		where	((nr_interno_conta				= nr_interno_conta_p) or

--			 (nr_seq_med_fatur			= nr_seq_med_fatur_p))

		where	nr_interno_conta				= nr_interno_conta_p
		and	ie_tiss_tipo_guia				= ie_tiss_tipo_guia_w
		and	cd_autorizacao				= cd_autorizacao_w
		and	nr_seq_guia				is null;*/
		if (ie_tiss_tipo_guia_w	= '5') then
			update	tiss_conta_dn
			set	nr_seq_guia		= nr_seq_guia_w
			where	nr_interno_conta	= nr_interno_conta_p
			and	coalesce(nr_seq_guia::text, '') = '';
		end if;			

		if (ie_tiss_tipo_guia_w = '4') then
			if (coalesce(ie_honorario_w, 'N') = 'N') then		-- edgar 04/08/2007, os 64213, caso a guia seja de honorario, nao deve vindular desp
				update	tiss_conta_desp
				set	nr_seq_guia			= nr_seq_guia_w
				where	ie_tiss_tipo_guia_desp		= '4'
				and	((nr_interno_conta		= nr_interno_conta_p) or
					(nr_atend_med			= nr_atend_med_p AND nr_seq_prot_med		= nr_seq_prot_med_p))
				and	cd_autorizacao			= cd_autorizacao_w
				and	((coalesce(cd_cgc_prestador, 'X')	= coalesce(cd_cgc_prestador_w, 'X')) or (ie_guia_desp_med_w = 'S'))					-- se a guia e de sp/sadt deve tratar o prestador
				and	coalesce(cd_medico_exec_tiss, coalesce(cd_medico_exec_tiss_w, 'X')) = coalesce(cd_medico_exec_tiss_w, 'X')
				and	coalesce(nr_seq_guia::text, '') = ''
				and	(
					(coalesce(ie_senha_guia_w,'N') 			in ('ACA', 'N','G','ASG','ACC','ATG','ATA','AP','ACG')) or (coalesce(cd_senha, coalesce(cd_senha_w, 'X'))		= coalesce(cd_senha_w, 'X'))
					)
				and	((coalesce(ie_guia_desp_proc_princ_w,'N')		= 'N') or (TISS_OBTER_GUIA_PROC_PRINC(nr_interno_conta,nr_seq_guia_w)	= nr_seq_guia_w)); /*lhalves OS 395680 em 16/12/2011*/
			else
				update	tiss_conta_desp
				set	nr_seq_guia			= nr_seq_guia_w
				where	ie_tiss_tipo_guia_desp		= '4'
				and	ie_tiss_desp_honor			= 'S'
				and	((nr_interno_conta			= nr_interno_conta_p) or
					(nr_atend_med			= nr_atend_med_p AND nr_seq_prot_med			= nr_seq_prot_med_p))
				and	cd_autorizacao				= cd_autorizacao_w
				and	cd_cgc_prestador			= cd_cgc_prestador_w
				and	coalesce(cd_medico_exec_tiss, coalesce(cd_medico_exec_tiss_w, 'X')) = coalesce(cd_medico_exec_tiss_w, 'X')
				and	coalesce(nr_seq_guia::text, '') = ''
				and	(
					(coalesce(ie_senha_guia_w,'N') 			in ('ACA', 'N','G','ASG','ACC','ATG','ATA','AP','ACG')) or (coalesce(cd_senha, coalesce(cd_senha_w, 'X'))		= coalesce(cd_senha_w, 'X'))
					)
				and	((coalesce(ie_guia_desp_proc_princ_w,'N')		= 'N') or (TISS_OBTER_GUIA_PROC_PRINC(nr_interno_conta,nr_seq_guia_w)	= nr_seq_guia_w)); /*lhalves OS 395680 em 16/12/2011*/
			end if;

		elsif (ie_tiss_tipo_guia_w = '5') then
			update	tiss_conta_desp
			set	nr_seq_guia			= nr_seq_guia_w
			where	ie_tiss_tipo_guia_desp		= '5'
			and	((nr_interno_conta		= nr_interno_conta_p) or
				(nr_atend_med			= nr_atend_med_p AND nr_seq_prot_med		= nr_seq_prot_med_p))
			and	coalesce(cd_cgc_prestador, 'X')	= coalesce(cd_cgc_prestador_w, 'X')
			and	((coalesce(cd_prestador_tiss,'X')	= coalesce(cd_prestador_tiss_w,'X')) or (ie_codigo_interno_desp_w = 'N'))
			and	cd_autorizacao			= cd_autorizacao_w
			and	coalesce(cd_medico_exec_tiss, coalesce(cd_medico_exec_tiss_w, 'X')) = coalesce(cd_medico_exec_tiss_w, 'X')
			and	coalesce(nr_seq_guia::text, '') = ''		-- se a guia e de resumo nao precisa tratar
			and	(
				(coalesce(ie_senha_guia_w,'N') 			in ('ACA', 'N','G','ASG','ACC','ATG','ATA','AP','ACG')) or (coalesce(cd_senha, coalesce(cd_senha_w, 'X'))		= coalesce(cd_senha_w, 'X'))
				)
			and	((coalesce(ie_guia_desp_proc_princ_w,'N')		= 'N') or (TISS_OBTER_GUIA_PROC_PRINC(nr_interno_conta,nr_seq_guia_w)	= nr_seq_guia_w)); /*lhalves OS 395680 em 16/12/2011*/
		elsif (ie_tiss_tipo_guia_w = '2') then

			update	tiss_conta_desp
			set	nr_seq_guia		= nr_seq_guia_w
			where	ie_tiss_tipo_guia_desp	= '2'
			and	((nr_interno_conta		= nr_interno_conta_p) or
				(nr_atend_med		= nr_atend_med_p AND nr_seq_prot_med		= nr_seq_prot_med_p))
			and	coalesce(cd_medico_exec_tiss, coalesce(cd_medico_exec_tiss_w, 'X')) = coalesce(cd_medico_exec_tiss_w, 'X')
			and	cd_autorizacao		= cd_autorizacao_w
			and	coalesce(nr_seq_guia::text, '') = ''
			and	(
				(coalesce(ie_senha_guia_w,'N') 			in ('ACA', 'N','G','ASG','ACC','ATG','ATA','AP','ACG')) or (coalesce(cd_senha, coalesce(cd_senha_w, 'X'))		= coalesce(cd_senha_w, 'X'))
				);
		end if;

		update	tiss_conta_opm_exec
		set	nr_seq_guia		= nr_seq_guia_w
		where	ie_tiss_tipo_guia_desp	= ie_tiss_tipo_guia_w
		and	nr_interno_conta		= nr_interno_conta_p
		and	cd_autorizacao		= cd_autorizacao_w
		and	coalesce(nr_seq_guia::text, '') = ''
		and	coalesce(cd_cgc_prestador,'X')		= coalesce(cd_cgc_prestador_w,'X') --lhalves OS 200142 18/03/2010 - incluido o nvl para gerar o numero de sequencia mesmo quando nao existe o prestador, devido a regra prestador para PF
		and	(
			(coalesce(ie_senha_guia_w,'N') 			in ('ACA', 'N','G','ASG','ACC','ATG','ATA','AP','PM','ACG')) or (coalesce(cd_senha, coalesce(cd_senha_w, 'X'))		= coalesce(cd_senha_w, 'X'))
			)
		and	((coalesce(ie_guia_desp_proc_princ_w,'N')		= 'N') or (TISS_OBTER_GUIA_PROC_PRINC(nr_interno_conta,nr_seq_guia_w)	= nr_seq_guia_w)); /*lhalves OS 395680 em 16/12/2011*/
		if (w_40ASADT_w IS NOT NULL AND w_40ASADT_w::text <> '') then

			insert	into tiss_conta_guia_prest(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_guia,
				nr_seq_campo_prest,
				ds_conteudo)
			values (nextval('tiss_conta_guia_prest_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_guia_w,
				OBTER_VALOR_CAMPO_SEPARADOR(w_40ASADT_w,1,';'),
				OBTER_VALOR_CAMPO_SEPARADOR(w_40ASADT_w,2,';'));
		end if;

		if (w_41SADT_w IS NOT NULL AND w_41SADT_w::text <> '') then

			insert	into tiss_conta_guia_prest(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_guia,
				nr_seq_campo_prest,
				ds_conteudo)
			values (nextval('tiss_conta_guia_prest_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_guia_w,
				OBTER_VALOR_CAMPO_SEPARADOR(w_41SADT_w,1,';'),
				OBTER_VALOR_CAMPO_SEPARADOR(w_41SADT_w,2,';'));

		end if;

		if (w_40ASADTH_w IS NOT NULL AND w_40ASADTH_w::text <> '') then

			insert	into tiss_conta_guia_prest(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_guia,
				nr_seq_campo_prest,
				ds_conteudo)
			values (nextval('tiss_conta_guia_prest_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_guia_w,
				OBTER_VALOR_CAMPO_SEPARADOR(w_40ASADTH_w,1,';'),
				OBTER_VALOR_CAMPO_SEPARADOR(w_40ASADTH_w,2,';'));
		end if;

		if (w_41SADTH_w IS NOT NULL AND w_41SADTH_w::text <> '') then

			insert	into tiss_conta_guia_prest(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_guia,
				nr_seq_campo_prest,
				ds_conteudo)
			values (nextval('tiss_conta_guia_prest_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_guia_w,
				OBTER_VALOR_CAMPO_SEPARADOR(w_41SADTH_w,1,';'),
				OBTER_VALOR_CAMPO_SEPARADOR(w_41SADTH_w,2,';'));

		end if;
		
		if (w_45ASADT_w IS NOT NULL AND w_45ASADT_w::text <> '') then
			insert	into tiss_conta_guia_prest(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_guia,
				nr_seq_campo_prest,
				ds_conteudo)
			values (nextval('tiss_conta_guia_prest_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_guia_w,
				OBTER_VALOR_CAMPO_SEPARADOR(w_45ASADT_w,1,';'),
				OBTER_VALOR_CAMPO_SEPARADOR(w_45ASADT_w,2,';'));		
		end if;
		
		if (w_45ASADTH_w IS NOT NULL AND w_45ASADTH_w::text <> '') then
			insert	into tiss_conta_guia_prest(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_guia,
				nr_seq_campo_prest,
				ds_conteudo)
			values (nextval('tiss_conta_guia_prest_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_guia_w,
				OBTER_VALOR_CAMPO_SEPARADOR(w_45ASADTH_w,1,';'),
				OBTER_VALOR_CAMPO_SEPARADOR(w_45ASADTH_w,2,';'));		
		end if;

		select	sum(vl_item)
		into STRICT	vl_outras_despesas_w
		from	tiss_conta_desp
		where	nr_seq_guia		= nr_seq_guia_w;

		select	sum(vl_procedimento)
		into STRICT	vl_servicos_w
		from	tiss_conta_proc
		where	nr_seq_guia		= nr_seq_guia_w
		and	coalesce(ie_honorario, 'N')	= coalesce(ie_honorario_w, 'N');
		
		if (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'N') then

			select	sum(CASE WHEN ie_tipo_despesa='1' THEN  vl_item  ELSE 0 END ),
				sum(CASE WHEN ie_tipo_despesa='2' THEN  vl_item  ELSE 0 END ),
				sum(CASE WHEN ie_tipo_despesa='3' THEN  vl_item  ELSE 0 END ),
				sum(CASE WHEN ie_tipo_despesa='4' THEN  vl_item  ELSE 0 END ),
				sum(CASE WHEN ie_tipo_despesa='5' THEN  vl_item  ELSE 0 END ),
				sum(CASE WHEN ie_tipo_despesa='6' THEN  vl_item  ELSE 0 END )
			into STRICT	vl_gases_w,
				vl_medicamentos_w,
				vl_materiais_w,
				vl_taxas_w,
				vl_diarias_w,
				vl_alugueis_w
			from	tiss_conta_desp
			where	nr_seq_guia		= nr_seq_guia_w;

			vl_total_w	:= coalesce(vl_outras_despesas_w,0) + coalesce(vl_servicos_w,0);

			select	sum(vl_opm)
			into STRICT	vl_opms_w
			from	tiss_conta_opm_exec
			where	nr_seq_guia		= nr_seq_guia_w;

			if (ie_totalizar_opm_w = 'S') then

				if (ie_total_opm_w	= 'MAT') then
					vl_materiais_w		:= coalesce(vl_materiais_w,0) + coalesce(vl_opms_w,0);
				elsif (ie_total_opm_w	= 'MED') then
					vl_medicamentos_w	:= coalesce(vl_medicamentos_w, 0) + coalesce(vl_opms_w, 0);
				end if;

				vl_total_w		:= vl_total_w + coalesce(vl_opms_w,0);

			end if;

			vl_taxas_alugueis_w	:= vl_taxas_w + vl_alugueis_w;
			
		else		
			select	sum(CASE WHEN ie_tipo_despesa='1' THEN  vl_item  ELSE 0 END ),
				sum(CASE WHEN ie_tipo_despesa='2' THEN  vl_item  ELSE 0 END ),
				sum(CASE WHEN ie_tipo_despesa='3' THEN  vl_item  ELSE 0 END ),				
				sum(CASE WHEN ie_tipo_despesa='5' THEN  vl_item  ELSE 0 END ),
				sum(CASE WHEN ie_tipo_despesa='7' THEN  vl_item  ELSE 0 END ),
				sum(CASE WHEN ie_tipo_despesa='8' THEN  vl_item  ELSE 0 END )
			into STRICT	vl_gases_w,
				vl_medicamentos_w,
				vl_materiais_w,				
				vl_diarias_w,
				vl_taxas_alugueis_w,
				vl_opms_w
			from	tiss_conta_desp
			where	nr_seq_guia		= nr_seq_guia_w;

			vl_total_w	:= coalesce(vl_outras_despesas_w,0) + coalesce(vl_servicos_w,0);	
		
		end if;

		update	tiss_conta_guia
		set	vl_outras_despesas	= vl_outras_despesas_w,
			vl_servicos		= (tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_TOTAL_PROCEDIMENTO', cd_convenio_w, vl_servicos_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'))::numeric ,
			vl_gases		= (tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_GASES', cd_convenio_w, vl_gases_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'))::numeric ,
			vl_medicamentos		= (tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_MEDICAMENTOS', cd_convenio_w, vl_medicamentos_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'))::numeric ,
			vl_materiais		= (tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_MATERIAIS', cd_convenio_w, vl_materiais_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'))::numeric ,
			vl_taxas		= (tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_TAXAS', cd_convenio_w, vl_taxas_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'))::numeric ,
			vl_diarias		= (tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_DIARIAS', cd_convenio_w, vl_diarias_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'))::numeric ,
			vl_alugueis		= (tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_TAXAS', cd_convenio_w, vl_alugueis_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'))::numeric ,
			vl_total		= (tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_TOTAL', cd_convenio_w, vl_total_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'))::numeric ,
			vl_taxas_alugueis	= (tiss_obter_regra_campo(ie_tiss_tipo_guia_w, 'VL_TAXAS', cd_convenio_w, vl_taxas_alugueis_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'))::numeric ,
			vl_opms			= vl_opms_w
		where	nr_sequencia		= nr_seq_guia_w;
		
		select	sum(qt_procedimento)
		into STRICT	qt_proc_guia_w
		from	tiss_conta_proc
		where	nr_seq_guia	= nr_seq_guia_w;		
		
		ds_observacao_w		:= coalesce(tiss_obter_campo_esp(	cd_convenio_w,
									cd_estabelecimento_w,
									'DS_OBSERVACAO',
									null,
									null,
									null,
									null,
									ie_funcao_medico_w,
									ie_sexo_w,
									dt_nascimento_w,
									ie_tipo_protocolo_w,
									ie_tipo_guia_atend_w,
									cd_regional_w,
									ie_guia_w,
									null,
									null,
									null,
									ie_tipo_atendimento_w,
									cd_cgc_prestador_w,
									ie_responsavel_credito_w,
									cd_medico_guia_w,
									nr_interno_conta_p,
									ds_prescricao_w, 
									null, 
									null, 
									null,
									qt_proc_guia_w),
						tiss_obter_regra_campo(	ie_tiss_tipo_guia_w, 'DS_OBSERVACAO', cd_convenio_w, ds_observacao_w,
									ie_tipo_atendimento_w, cd_categoria_conv_w,'N', 0,
									cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, 
									ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@'));	
		
		if (coalesce(trim(both coalesce(ds_observacao_pacote_w, 'X')),'X') <> 'X' ) then
			update	tiss_conta_guia
			set	ds_observacao	= ds_observacao_pacote_w
			where	nr_sequencia	= nr_seq_guia_w;
		elsif (coalesce(trim(both coalesce(ds_observacao_w,'X')),'X') <> 'X') then
			begin
				update	tiss_conta_guia
				set	ds_observacao	= replace(ds_observacao_w,chr(10),'')
				where	nr_sequencia	= nr_seq_guia_w
;			
			exception
			when others then
				update	tiss_conta_guia
				set	ds_observacao	= ds_observacao_w
				where	nr_sequencia	= nr_seq_guia_w;
			end;
		end if;

		if (coalesce(ds_function_obs_spsadt_w, 'X') <> 'X') and (ie_tiss_tipo_guia_w = '4') then
			ds_observacao_w	:= tiss_obter_obs_guia(cd_estabelecimento_p,nr_interno_conta_p,nr_seq_guia_w,ie_tiss_tipo_guia_w);

			update	tiss_conta_guia
			set	ds_observacao	= ds_observacao_w
			where	nr_sequencia	= nr_seq_guia_w;

		end if;
		/*lhalves OS251309 em 22/09/2010*/

		if (coalesce(ds_function_obs_cosnulta_w, 'X') <> 'X') and (ie_tiss_tipo_guia_w = '3') then
			ds_observacao_w	:= tiss_obter_obs_guia(cd_estabelecimento_p,nr_interno_conta_p,nr_seq_guia_w,ie_tiss_tipo_guia_w);

			update	tiss_conta_guia
			set	ds_observacao	= ds_observacao_w
			where	nr_sequencia	= nr_seq_guia_w;
		end if;		
		
		open C17;
		loop
		fetch C17 into	
			nr_seq_conta_partic_w,
			nr_seq_guia_proc_w;
		EXIT WHEN NOT FOUND; /* apply on C17 */
			begin
			
			update	tiss_conta_partic
			set	nr_seq_guia	= nr_seq_guia_proc_w
			where	nr_sequencia	= nr_seq_conta_partic_w;
			
			end;
		end loop;
		close C17;

		-- edgar 05/03/2009, eliminar guias vazias, os 130204 (tratamento provisorio)
		delete	from tiss_conta_guia a
		where	nr_sequencia		= nr_seq_guia_w
		and	coalesce(a.vl_outras_despesas,0)	= 0
		and	coalesce(a.vl_servicos	,0)	= 0
		and	coalesce(a.vl_gases,0)		= 0
		and	coalesce(a.vl_medicamentos,0)	= 0
		and	coalesce(a.vl_materiais,0)	= 0
		and	coalesce(a.vl_taxas,0)		= 0
		and	coalesce(a.vl_diarias,0)		= 0
		and	coalesce(a.vl_alugueis,0)	= 0
		and	coalesce(a.vl_total,0)		= 0
		and	coalesce(a.vl_taxas_alugueis,0)	= 0
		and	coalesce(a.vl_opms,0)		= 0
		and	not exists (	SELECT	1
					from	tiss_conta_proc x
					where	x.nr_seq_guia	= a.nr_sequencia
					
union

					SELECT	1
					from	tiss_conta_desp x
					where	x.nr_seq_guia	= a.nr_sequencia
					
union

					select	1
					from	tiss_conta_opm_exec x
					where	x.nr_seq_guia	= a.nr_sequencia);
		if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
		
		nr_seq_apres_proc_w	:= tiss_common_vars_pck.get_item_sequence_default;
		
		if (ie_tiss_tipo_guia_w = '4') then		
			open C15;
			loop
			fetch C15 into	
				nr_seq_tiss_conta_proc_w;
			EXIT WHEN NOT FOUND; /* apply on C15 */
				begin
				nr_seq_apres_proc_w	:= nr_seq_apres_proc_w + 1;
				
				update	tiss_conta_proc
				set	nr_seq_apresentacao	= nr_seq_apres_proc_w,
					nr_sequencia_item		= nr_seq_apres_proc_w
				where	nr_sequencia		= nr_seq_tiss_conta_proc_w;
				
				end;
			end loop;
			close C15;
		elsif (ie_tiss_tipo_guia_w = '5') then
			open C16;
			loop
			fetch C16 into	
				nr_seq_tiss_conta_proc_w;
			EXIT WHEN NOT FOUND; /* apply on C16 */
				begin
				nr_seq_apres_proc_w	:= nr_seq_apres_proc_w + 1;
				
				update	tiss_conta_proc
				set	nr_seq_apresentacao	= nr_seq_apres_proc_w,
					nr_sequencia_item		= nr_seq_apres_proc_w
				where	nr_sequencia		= nr_seq_tiss_conta_proc_w;
				
				end;
			end loop;
			close C16;	
		else
			open C20;
			loop
			fetch C20 into	
				nr_seq_tiss_conta_proc_w;
			EXIT WHEN NOT FOUND; /* apply on C20 */
				begin
				nr_seq_apres_proc_w	:= nr_seq_apres_proc_w + 1;
				
				update	tiss_conta_proc
				set	nr_sequencia_item		= nr_seq_apres_proc_w
				where	nr_sequencia		= nr_seq_tiss_conta_proc_w;
				
				end;
			end loop;
			close C20;
		end if;		

	end loop;
	close c01;

	/*lhalves OS262474 4/11/2010 - Caso a guia seja unica da conta, gerar como guia princ a propria guia.
	Verificar as guias e tipo de atendimento
	*/
	open c12;
	loop
	fetch c12 into
		ie_tipo_guia_w,
		ie_tipo_atend_guia_w,
		nr_seq_guia_w;
	EXIT WHEN NOT FOUND; /* apply on c12 */
		cd_autorizacao_princ_w := null;
		/*Busca a regra guia princ*/

		open c13;
		loop
		fetch c13 into
			ie_unica_guia_w,
			ie_regra_guia_princ_w;
		EXIT WHEN NOT FOUND; /* apply on c13 */

			if (ie_unica_guia_w = 'S') then
				select 	count(*)
				into STRICT	count_guia_w
				from 	tiss_conta_guia
				where	nr_interno_conta	= nr_interno_conta_p
				and 	ie_tiss_tipo_guia	= ie_tipo_guia_w;

				if (count_guia_w = 1) then --Existe apenas uma guia para conta com o mesmo tipo
					
					update	tiss_conta_guia
					set 	cd_autorizacao_princ	= cd_autorizacao --propria guia
					where	nr_sequencia	in (SELECT nr_sequencia
								    	from 	tiss_conta_guia
								    	where	nr_interno_conta = nr_interno_conta_p);
				end if;
			elsif	ie_regra_guia_princ_w = 'GPR' and
				ie_tipo_guia_w <> '5' then
				
				select	max(a.nr_guia_prestador)
				into STRICT	nr_guia_prestador_ri_w
				from	tiss_conta_guia a
				where	ie_tiss_tipo_guia = '5'
				and	a.nr_interno_conta = nr_interno_conta_p;
				
				cd_autorizacao_princ_w	:= tiss_obter_regra_campo(ie_tipo_guia_w, 'CD_AUTORIZACAO_PRINC', cd_convenio_w, nr_guia_prestador_ri_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, ie_clinica_w, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'||ie_tipo_atend_proc_w||'#@');
				
				
				update	tiss_conta_guia
				set 	cd_autorizacao_princ	= cd_autorizacao_princ_w
				where	nr_sequencia	 = nr_seq_guia_w;
				
			
			end if;
		end loop;
		close c13;
	end loop;
	close c12;
	/*Fim lhalves OS262474 */

end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_gerar_conta_guia (nr_interno_conta_p bigint, nr_seq_med_fatur_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_atend_med_p bigint, nr_seq_prot_med_p bigint) FROM PUBLIC;

