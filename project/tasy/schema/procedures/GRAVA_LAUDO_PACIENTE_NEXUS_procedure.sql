-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE grava_laudo_paciente_nexus ( id_patient_p text, nr_case_p text, orc3_code_p text, order_date_p text, orc10_code_p text, orc2_code_p text, obx_content_p text) AS $body$
DECLARE

			
nr_laudo_w			    laudo_paciente.nr_laudo%type;
nm_medico_w			    laudo_paciente.nm_medico_solicitante%type;
cd_medico_resp_w		laudo_paciente.cd_medico_resp%type;
nr_atendimento_w    atendimento_paciente.nr_atendimento%type;
		


BEGIN

select obter_atend_episodio_interg(nr_case_p)
into STRICT nr_atendimento_w
;


SELECT	coalesce(MAX(nr_laudo),0) + 1
INTO STRICT	nr_laudo_w
FROM	laudo_paciente
WHERE	nr_atendimento = nr_atendimento_w;

SELECT 	MAX(SUBSTR(obter_nome_pf(cd_medico_resp),1,255)) nm_medico,
	MAX(cd_medico_resp)
INTO STRICT 	nm_medico_w,
	cd_medico_resp_w
FROM 	atendimento_paciente
WHERE 	nr_atendimento = nr_atendimento_w;

INSERT INTO laudo_paciente(nr_sequencia,
			nr_prescricao,
			nr_seq_prescricao,
			nr_seq_proc,
			nm_usuario_digitacao,
			nr_atendimento,
			nr_laudo,
			nm_usuario,
			dt_atualizacao,
			cd_medico_resp,
			qt_imagem,
			ds_titulo_laudo,
			ds_laudo,
			dt_laudo,
			dt_entrada_unidade,
			dt_liberacao,
			dt_exame,
			dt_aprovacao,
			nm_medico_solicitante,
			dt_integracao)
VALUES (
	nextval('laudo_paciente_seq'),
	NULL,
	NULL,
	NULL,
	'Nexus',
	nr_atendimento_w,
	nr_laudo_w,
	'Nexus',
	clock_timestamp(),
	cd_medico_resp_w,
	0,
	OBTER_DESC_EXPRESSAO(945537),--Nexus report - pathology
	obx_content_p,
	clock_timestamp(),
	clock_timestamp(),
	clock_timestamp(),
	clock_timestamp(),
	clock_timestamp(),
	nm_medico_w,
	clock_timestamp());

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE grava_laudo_paciente_nexus ( id_patient_p text, nr_case_p text, orc3_code_p text, order_date_p text, orc10_code_p text, orc2_code_p text, obx_content_p text) FROM PUBLIC;

