-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE manipula_item_quimio ( nr_seq_ordem_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w				bigint;
qt_material_prescr_w			double precision;
ie_medic_diluente_w			varchar(1);
nr_seq_item_prescr_w			bigint;
qt_dose_prescr_w			double precision := 1;
qt_material_manip_w			double precision := 1;
cd_material_w				bigint;	
cd_unidade_medida_w			varchar(30);
cd_unid_med_prescr_w			varchar(30);
nr_seq_lote_fornec_w			bigint;
qt_material_w				double precision;
qt_overfill_w				double precision;
	
C01 CURSOR FOR
	SELECT 	cd_material,
		cd_unidade_medida,
		nr_seq_lote_fornec,
		qt_material
	from 	w_preparo_quimio_lote a
	where 	nr_seq_ordem = nr_seq_ordem_p;
	

BEGIN

open C01;
loop
fetch C01 into	
	cd_material_w,
	cd_unidade_medida_w,
	nr_seq_lote_fornec_w,
	qt_material_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	select 	max(qt_overfill)
	into STRICT 	qt_overfill_w
	from 	material
	where 	cd_material = cd_material_w;
	
	select 	max(CASE WHEN coalesce(nr_sequencia_diluente::text, '') = '' THEN 'M'  ELSE 'D' END ), 	
		max(nr_sequencia),
		max(qt_dose),
		max(cd_unidade_medida)
	into STRICT	ie_medic_diluente_w,
		nr_seq_item_prescr_w,
		qt_dose_prescr_w,
		cd_unid_med_prescr_w
	from 	can_ordem_item_prescr
	where 	nr_seq_ordem = nr_seq_ordem_p 
	and 	obter_ficha_tecnica_medic(cd_material) = obter_ficha_tecnica_medic(cd_material_w);

	qt_material_w := obter_dose_convertida_quimio(cd_material_w, qt_material_w, cd_unidade_medida_w, cd_unid_med_prescr_w);
	
	select 	nextval('can_ordem_prod_mat_seq')
	into STRICT 	nr_sequencia_w
	;	

	insert into can_ordem_prod_mat(
		nr_sequencia,
		cd_material,
		cd_unidade_medida,
		cd_unidade_medida_real,
		dt_atualizacao,
		dt_atualizacao_nrec,
		ie_devolve_cabine,
		nm_usuario,
		nm_usuario_nrec,
		nr_seq_ordem,
		nr_seq_lote_fornec,
		qt_dose,
		qt_dose_real,
		nr_seq_item_prescr,
		ie_medic_diluente,
		qt_perda,
		cd_estabelecimento,
		ie_reaproveitado)
	values (nr_sequencia_w,
		cd_material_w,
		cd_unid_med_prescr_w,
		cd_unid_med_prescr_w,
		clock_timestamp(),
		clock_timestamp(),
		'S',
		nm_usuario_p,
		nm_usuario_p,
		nr_seq_ordem_p,
		nr_seq_lote_fornec_w,
		coalesce(qt_dose_prescr_w,1),
		qt_material_w,
		nr_seq_item_prescr_w,
		coalesce(ie_medic_diluente_w,'N'),
		0,
		wheb_usuario_pck.get_cd_estabelecimento,
		'N');

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE manipula_item_quimio ( nr_seq_ordem_p bigint, nm_usuario_p text) FROM PUBLIC;

