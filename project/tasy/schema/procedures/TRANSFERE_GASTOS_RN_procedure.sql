-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE transfere_gastos_rn ( nr_sequencia_p bigint, ie_proc_mat_p bigint, nr_atend_dest_p bigint, cd_setor_atendimento_p bigint, dt_entrada_unidade_p timestamp, nr_seq_atepacu_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_convenio_w		bigint;
cd_categoria_w		varchar(10);
cd_estabelecimento_w	smallint;	
dt_entrada_w		timestamp;
dt_alta_w			timestamp;		
nr_doc_convenio_w	varchar(20);
dt_acerto_conta_w		timestamp;
nr_interno_conta_w		bigint;
cd_convenio_calculo_w	integer;
cd_categoria_calculo_w	varchar(10);
				

BEGIN 
 
select 	max(cd_estabelecimento), 
	max(dt_entrada), 
	max(dt_alta) 
into STRICT	cd_estabelecimento_w, 
	dt_entrada_w, 
	dt_alta_w 
from 	atendimento_paciente 
where 	nr_atendimento = nr_atend_dest_p;
 
if (ie_proc_mat_p = 1) then --m達e para rn (procedimento) 
 
	/*insert 	into logxxxxxx_tasy 
		(dt_atualizacao, nm_usuario, cd_log, ds_log) 
	values 
		(sysdate, nm_usuario_p, 7009, ' Transf. Gastos RN Seq Proc: ' || nr_sequencia_p || ' Atend: ' || nr_atend_dest_p); */
 
		 
	select 	coalesce(max(cd_convenio),1), 
		coalesce(max(cd_categoria),'1'), 
		max(nr_doc_convenio) 
	into STRICT	cd_convenio_w, 
		cd_categoria_w, 
		nr_doc_convenio_w 
	from 	procedimento_paciente 
	where 	nr_sequencia = nr_sequencia_p;		
	 
	SELECT * FROM obter_conta_paciente(cd_estabelecimento_w, nr_atend_dest_p, cd_convenio_w, cd_categoria_w, nm_usuario_p, clock_timestamp(), dt_entrada_w, dt_alta_w, nr_doc_convenio_w, cd_setor_atendimento_p, null, dt_acerto_conta_w, nr_interno_conta_w, cd_convenio_calculo_w, cd_categoria_calculo_w) INTO STRICT dt_acerto_conta_w, nr_interno_conta_w, cd_convenio_calculo_w, cd_categoria_calculo_w;
	 
	update	procedimento_paciente 
	set	nr_atendimento = nr_atend_dest_p, 
		nr_seq_atepacu = nr_seq_atepacu_p, 
		dt_entrada_unidade = dt_entrada_unidade_p, 
		cd_setor_atendimento = cd_setor_atendimento_p, 
		nr_interno_conta = nr_interno_conta_w, 
		--ds_observacao	= substr(ds_observacao || ' Atend original '|| nr_atendimento ||' Setor Original '||cd_setor_atendimento,1,255), 
		ds_observacao	= substr(ds_observacao || ' ' || WHEB_MENSAGEM_PCK.get_texto(297127) || ' '|| nr_atendimento ||' ' || WHEB_MENSAGEM_PCK.get_texto(297128) || ' '||cd_setor_atendimento,1,255), 
		dt_atualizacao = clock_timestamp(), 
		nm_usuario = nm_usuario_p 
	where	nr_sequencia = nr_sequencia_p;
 
	commit;
 
elsif (ie_proc_mat_p = 2) then --m達e para rn (material) 
 
	/*insert 	into logxxxxxx_tasy 
		(dt_atualizacao, nm_usuario, cd_log, ds_log) 
	values 
		(sysdate, nm_usuario_p, 7009, ' Transf. Gastos RN Seq Mat: ' || nr_sequencia_p || ' Atend: ' || nr_atend_dest_p);*/
 
 
	select 	coalesce(max(cd_convenio),1), 
		coalesce(max(cd_categoria),'1'), 
		max(nr_doc_convenio) 
	into STRICT	cd_convenio_w, 
		cd_categoria_w, 
		nr_doc_convenio_w 
	from 	material_atend_paciente 
	where 	nr_sequencia = nr_sequencia_p;
 
	SELECT * FROM obter_conta_paciente(cd_estabelecimento_w, nr_atend_dest_p, cd_convenio_w, cd_categoria_w, nm_usuario_p, clock_timestamp(), dt_entrada_w, dt_alta_w, nr_doc_convenio_w, cd_setor_atendimento_p, null, dt_acerto_conta_w, nr_interno_conta_w, cd_convenio_calculo_w, cd_categoria_calculo_w) INTO STRICT dt_acerto_conta_w, nr_interno_conta_w, cd_convenio_calculo_w, cd_categoria_calculo_w;
	 
	update	material_atend_paciente 
	set	nr_atendimento = nr_atend_dest_p, 
		nr_seq_atepacu = nr_seq_atepacu_p, 
		dt_entrada_unidade = dt_entrada_unidade_p, 
		cd_setor_atendimento = cd_setor_atendimento_p, 
		nr_interno_conta = nr_interno_conta_w, 
		--ds_observacao	= substr(ds_observacao || ' Atend original '|| nr_atendimento ||' Setor Original '||cd_setor_atendimento,1,255), 
		ds_observacao	= substr(ds_observacao || ' ' || WHEB_MENSAGEM_PCK.get_texto(297127) || ' '|| nr_atendimento ||' ' || WHEB_MENSAGEM_PCK.get_texto(297128) || ' '||cd_setor_atendimento,1,255),		 
		dt_atualizacao = clock_timestamp(), 
		nm_usuario = nm_usuario_p 
	where	nr_sequencia = nr_sequencia_p;
 
	commit;
	 
elsif (ie_proc_mat_p = 3) then -- rn para m達e (procedimento) 
	 
	/*insert 	into logxxxxx_tasy 
		(dt_atualizacao, nm_usuario, cd_log, ds_log) 
	values 
		(sysdate, nm_usuario_p, 7009, ' Transf. Gastos RN Seq Proc: ' || nr_sequencia_p || ' Atend: ' || nr_atend_dest_p); */
 
		 
	select 	coalesce(max(cd_convenio),1), 
		coalesce(max(cd_categoria),'1'), 
		max(nr_doc_convenio) 
	into STRICT	cd_convenio_w, 
		cd_categoria_w, 
		nr_doc_convenio_w 
	from 	procedimento_paciente 
	where 	nr_sequencia = nr_sequencia_p;		
	 
	SELECT * FROM obter_conta_paciente(cd_estabelecimento_w, nr_atend_dest_p, cd_convenio_w, cd_categoria_w, nm_usuario_p, clock_timestamp(), dt_entrada_w, dt_alta_w, nr_doc_convenio_w, cd_setor_atendimento_p, null, dt_acerto_conta_w, nr_interno_conta_w, cd_convenio_calculo_w, cd_categoria_calculo_w) INTO STRICT dt_acerto_conta_w, nr_interno_conta_w, cd_convenio_calculo_w, cd_categoria_calculo_w;
	 
	update	procedimento_paciente 
	set	nr_seq_atepacu = nr_seq_atepacu_p, 
		dt_entrada_unidade = dt_entrada_unidade_p, 
		cd_setor_atendimento = cd_setor_atendimento_p, 
		nr_interno_conta = nr_interno_conta_w, 
		--ds_observacao	= substr(ds_observacao || ' Atend original '|| nr_atendimento ||' Setor Original '||cd_setor_atendimento,1,255), 
		ds_observacao	= substr(ds_observacao || ' ' || WHEB_MENSAGEM_PCK.get_texto(297127) || ' '|| nr_atendimento ||' ' || WHEB_MENSAGEM_PCK.get_texto(297128) || ' '||cd_setor_atendimento,1,255),	 
		dt_atualizacao = clock_timestamp(), 
		nm_usuario = nm_usuario_p 
	where	nr_sequencia = nr_sequencia_p;
 
	commit;
	 
elsif (ie_proc_mat_p = 4) then --rn para m達e(material) 
 
	/*insert 	into logxxxx_tasy 
		(dt_atualizacao, nm_usuario, cd_log, ds_log) 
	values 
		(sysdate, nm_usuario_p, 7009, ' Transf. Gastos RN Seq Mat: ' || nr_sequencia_p || ' Atend: ' || nr_atend_dest_p); */
 
 
	select 	coalesce(max(cd_convenio),1), 
		coalesce(max(cd_categoria),'1'), 
		max(nr_doc_convenio) 
	into STRICT	cd_convenio_w, 
		cd_categoria_w, 
		nr_doc_convenio_w 
	from 	material_atend_paciente 
	where 	nr_sequencia = nr_sequencia_p;
 
	SELECT * FROM obter_conta_paciente(cd_estabelecimento_w, nr_atend_dest_p, cd_convenio_w, cd_categoria_w, nm_usuario_p, clock_timestamp(), dt_entrada_w, dt_alta_w, nr_doc_convenio_w, cd_setor_atendimento_p, null, dt_acerto_conta_w, nr_interno_conta_w, cd_convenio_calculo_w, cd_categoria_calculo_w) INTO STRICT dt_acerto_conta_w, nr_interno_conta_w, cd_convenio_calculo_w, cd_categoria_calculo_w;
	 
	update	material_atend_paciente 
	set	nr_seq_atepacu = nr_seq_atepacu_p, 
		dt_entrada_unidade = dt_entrada_unidade_p, 
		cd_setor_atendimento = cd_setor_atendimento_p, 
		nr_interno_conta = nr_interno_conta_w, 
		--ds_observacao	= substr(ds_observacao || ' Atend original '|| nr_atendimento ||' Setor Original '||cd_setor_atendimento,1,255), 
		ds_observacao	= substr(ds_observacao || ' ' || WHEB_MENSAGEM_PCK.get_texto(297127) || ' '|| nr_atendimento ||' ' || WHEB_MENSAGEM_PCK.get_texto(297128) || ' '||cd_setor_atendimento,1,255),	 
		dt_atualizacao = clock_timestamp(), 
		nm_usuario = nm_usuario_p 
	where	nr_sequencia = nr_sequencia_p;
 
	commit;
	 
end if;
 
commit;			
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE transfere_gastos_rn ( nr_sequencia_p bigint, ie_proc_mat_p bigint, nr_atend_dest_p bigint, cd_setor_atendimento_p bigint, dt_entrada_unidade_p timestamp, nr_seq_atepacu_p bigint, nm_usuario_p text) FROM PUBLIC;

