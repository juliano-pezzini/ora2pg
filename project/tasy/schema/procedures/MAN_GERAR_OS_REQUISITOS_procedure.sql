-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_os_requisitos ( nr_seq_filhas_p text, nr_seq_ordem_serv_pai_p bigint, nm_usuario_p text ) AS $body$
DECLARE


nr_seq_os_w			man_ordem_servico.nr_sequencia%type;
nm_usuario_exec_w		varchar(15 );
nr_seq_localizacao_w		man_ordem_servico.nr_seq_localizacao%type	:= 41;
nr_seq_equipamento_w		man_ordem_servico.nr_seq_equipamento%type	:= 41;
ie_status_ordem_w		man_ordem_servico.ie_status_ordem%type		:= 1;
ie_classificacao_w		man_ordem_servico.ie_classificacao%type		:= 'S';
nr_seq_estagio_w		man_ordem_servico.nr_seq_estagio%type		:= 1051;
nr_seq_severidade_wheb_w	man_ordem_servico.nr_seq_severidade_wheb%type	:= 7;
cd_funcao_w			man_ordem_servico.cd_funcao%type;
nr_seq_grupo_des_w		man_ordem_servico.nr_seq_grupo_des%type;
nr_seq_grupo_sup_w		man_ordem_servico.nr_seq_grupo_sup%type;
ie_tipo_ordem_w			man_ordem_servico.ie_tipo_ordem%type;
ie_prioridade_w			man_ordem_servico.ie_prioridade%type;
ie_exclusiva_w			man_ordem_servico.ie_exclusiva%type;
nr_seq_complex_w		man_ordem_servico.nr_seq_complex%type;
ie_ambiente_w			man_ordem_servico.ie_ambiente%type;
ie_plataforma_w			man_ordem_servico.ie_plataforma%type;
nr_versao_cliente_abertura_w	man_ordem_servico.nr_versao_cliente_abertura%type;
ie_resp_teste_w			man_ordem_servico.ie_resp_teste%type;
nr_seq_severidade_w		man_ordem_servico.nr_seq_severidade%type;
nr_grupo_trabalho_w		man_ordem_servico.nr_grupo_trabalho%type;
nr_grupo_planej_w		man_ordem_servico.nr_grupo_planej%type;
nr_seq_tipo_ordem_w		man_ordem_servico.nr_seq_tipo_ordem%type;
nr_seq_gerencia_w		bigint;
aux_cont			smallint;

c_filhas CURSOR FOR
	SELECT *
	from man_ordem_serv_filha
	where nr_sequencia in (WITH RECURSIVE cte AS (

			SELECT	regexp_substr( nr_seq_filhas_p, '[^,]+', 1, level )
			
			(regexp_substr( nr_seq_filhas_p, '[^,]+', 1, level ) IS NOT NULL AND (regexp_substr( nr_seq_filhas_p, '[^,]+', 1, level ))::text <> '')
		  UNION ALL

			SELECT	regexp_substr( nr_seq_filhas_p, '[^,]+', 1, level ) JOIN cte c ON ()

) SELECT * FROM cte;
)
	and coalesce(nr_seq_ordem_servico_filha::text, '') = '';

c_anexos CURSOR( nr_seq_filha_p bigint ) FOR
	SELECT mosfa.ds_arquivo,
		mosfa.ds_observacao
	from man_ordem_serv_filha_anexo mosfa
	where mosfa.nr_seq_filha = nr_seq_filha_p;

BEGIN
	begin
		select cd_funcao,
			nr_seq_grupo_des,
			nr_seq_grupo_sup,
			coalesce( ie_tipo_ordem, '4' ),
			ie_prioridade,
			ie_exclusiva,
			nr_seq_complex,
			ie_ambiente,
			ie_plataforma,
			nr_versao_cliente_abertura,
			ie_resp_teste,
			nr_seq_severidade,
			nr_grupo_trabalho,
			nr_grupo_planej,
			nr_seq_tipo_ordem
		into STRICT cd_funcao_w,
			nr_seq_grupo_des_w,
			nr_seq_grupo_sup_w,
			ie_tipo_ordem_w,
			ie_prioridade_w,
			ie_exclusiva_w,
			nr_seq_complex_w,
			ie_ambiente_w,
			ie_plataforma_w,
			nr_versao_cliente_abertura_w,
			ie_resp_teste_w,
			nr_seq_severidade_w,
			nr_grupo_trabalho_w,
			nr_grupo_planej_w,
			nr_seq_tipo_ordem_w
		from man_ordem_servico
		where nr_sequencia = nr_seq_ordem_serv_pai_p;
	end;
	begin
		select nr_seq_gerencia
		into STRICT nr_seq_gerencia_w
		from grupo_desenvolvimento
		where nr_sequencia = nr_seq_grupo_des_w;
		select count( 1 )
		into STRICT aux_cont
		from gerencia_wheb
		where nr_sequencia   = nr_seq_gerencia_w
		and ie_area_gerencia = 'TEC';
		if aux_cont          > 0 then
			nr_seq_estagio_w   := 1731;
		end if;
	exception
	when no_data_found then
		nr_seq_estagio_w := 1051;
	end;
	begin
		for r in c_filhas
		loop
			select nextval('man_ordem_servico_seq') into STRICT nr_seq_os_w;
			insert
			into man_ordem_servico(
					nr_sequencia,
					ie_origem_os,
					nr_seq_localizacao,
					nr_seq_equipamento,
					cd_pessoa_solicitante,
					dt_ordem_servico,
					ie_prioridade,
					ie_parado,
					ds_dano_breve,
					dt_atualizacao,
					nm_usuario,
					dt_inicio_desejado,
					dt_conclusao_desejada,
					ds_dano,
					dt_inicio_real,
					dt_fim_real,
					ie_tipo_ordem,
					ie_status_ordem,
					nr_seq_tipo_solucao,
					ds_solucao,
					qt_contador,
					nr_seq_planej,
					nr_seq_tipo_contador,
					nr_seq_estagio,
					cd_projeto,
					nr_seq_etapa_proj,
					dt_reabertura,
					cd_funcao,
					nm_tabela,
					ie_classificacao,
					nr_seq_origem,
					nr_seq_projeto,
					ie_grau_satisfacao,
					nr_seq_indicador,
					nr_seq_causa_dano,
					nr_seq_cliente,
					nr_seq_grupo_des,
					nr_seq_grupo_sup,
					nr_seq_superior,
					ie_eficacia,
					dt_prev_eficacia,
					cd_pf_eficacia,
					nr_seq_nao_conform,
					nr_seq_complex,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					ie_obriga_news,
					nr_seq_meta_pe,
					nr_seq_classif,
					nr_seq_nivel_valor,
					nm_usuario_lib_news,
					dt_libera_news,
					dt_envio_wheb,
					ds_contato_solicitante,
					ie_prioridade_desen,
					ie_prioridade_sup,
					nr_seq_ordem_serv_pai,
					ie_exclusiva,
					ie_ambiente,
					ie_plataforma,
					nr_versao_cliente_abertura,
					ie_resp_teste,
					nr_seq_severidade,
					nr_seq_severidade_wheb,
					nr_grupo_trabalho,
					nr_grupo_planej,
					nr_seq_tipo_ordem
				)
				values
				(
					nr_seq_os_w,								/*--nr_sequencia*/
					1,									/*-- ie_tipo_os*/
					nr_seq_localizacao_w,							/*--nr_seq_localizacao*/
					nr_seq_equipamento_w,							/*--nr_seq_equipamento*/
					obter_pessoa_fisica_usuario( nm_usuario_p, 'C' ),			/*--cd_pessoa_solicitante*/
					clock_timestamp(),								/*--dt_ordem_servico*/
					ie_prioridade_w,							/*--ie_prioridade*/
					'N',									/*--ie_parado*/
					substr( r.ds_descricao_req, 1, 80 ),					/*--ds_dano_breve*/
					clock_timestamp(),								/*--dt_atualizacao*/
					nm_usuario_p,								/*--nm_usuario*/
					clock_timestamp(),								/*--dt_inicio_desejado*/
					( clock_timestamp() + interval '15 days' ),							/*--dt_conclusao_desejada*/
					r.ds_detalhe_req || chr( 13 ) || chr( 10 )
						|| obter_title_req_produto( r.nr_seq_product_requirement ),	/*--ds_dano*/
					clock_timestamp(),								/*--dt_inicio_real*/
					null,									/*--dt_fim_real*/
					ie_tipo_ordem_w,							/*--ie_tipo_ordem*/
					ie_status_ordem_w,							/*--ie_status_ordem*/
					null,									/*--nr_seq_tipo_solucao*/
					null,									/*--ds_solucao*/
					null,									/*--qt_contador*/
					null,									/*--nr_seq_planej*/
					null,									/*--nr_seq_tipo_contador*/
					nr_seq_estagio_w,							/*--nr_seq_estagio*/
					null,									/*--cd_projeto*/
					null,									/*--nr_seq_etapa_proj*/
					null,									/*--dt_reabertura*/
					cd_funcao_w,								/*--cd_funcao*/
					null,									/*--nm_tabela*/
					ie_classificacao_w,							/*--ie_classificacao*/
					null,									/*--nr_seq_origem*/
					null,									/*--nr_seq_projeto*/
					null,									/*--ie_grau_satisfacao*/
					null,									/*--nr_seq_indicador*/
					null,									/*--nr_seq_causa_dano*/
					null,									/*--nr_seq_cliente*/
					nr_seq_grupo_des_w,							/*--nr_seq_grupo_des*/
					nr_seq_grupo_sup_w,							/*--nr_seq_grupo_sup*/
					null,									/*--nr_seq_superior*/
					null,									/*--ie_eficacia*/
					null,									/*--dt_prev_eficacia*/
					null,									/*--cd_pf_eficacia*/
					null,									/*--nr_seq_nao_conform*/
					nr_seq_complex_w,							/*--nr_seq_complex*/
					null,									/*--dt_atualizacao_nrec*/
					nm_usuario_p,								/*--nm_usuario_nrec*/
					null,									/*--ie_obriga_news*/
					null,									/*--nr_seq_meta_pe*/
					null,									/*--nr_seq_classif*/
					null,									/*--nr_seq_nivel_valor*/
					null,									/*--nm_usuario_lib_news*/
					null,									/*--dt_libera_news*/
					null,									/*--dt_envio_wheb*/
					null,									/*--ds_contato_solicitante*/
					null,									/*--ie_prioridade_desen*/
					null,									/*--ie_prioridade_sup*/
					nr_seq_ordem_serv_pai_p,						/*--nr_seq_ordem_serv_pai*/
					ie_exclusiva_w,								/*--ie_exclusiva*/
					ie_ambiente_w,								/*--ie_ambiente*/
					ie_plataforma_w,							/*--ie_plataforma*/
					nr_versao_cliente_abertura_w,						/*--nr_versao_cliente_abertura*/
					ie_resp_teste_w,							/*--ie_resp_teste*/
					nr_seq_severidade_w,							/*--nr_seq_severidade*/
					nr_seq_severidade_wheb_w,						/*--nr_seq_severidade_wheb*/
					nr_grupo_trabalho_w,							/*--nr_grupo_trabalho*/
					nr_grupo_planej_w,								/*--nr_grupo_planej*/
					nr_seq_tipo_ordem_w								/*--nr_seq_tipo_ordem*/
				);
			nm_usuario_exec_w      := r.nm_executor;
			if ( coalesce(nm_usuario_exec_w::text, '') = '' ) then
				nm_usuario_exec_w     := nm_usuario_p;
			end if;
			begin
				insert
				into man_ordem_servico_exec(
						nr_sequencia,
						nr_seq_ordem,
						dt_atualizacao,
						nm_usuario,
						nm_usuario_exec,
						qt_min_prev
					)
					values (
						nextval('man_ordem_servico_exec_seq'),
						nr_seq_os_w,
						clock_timestamp(),
						nm_usuario_p,
						nm_usuario_exec_w,
						r.qt_estimativa
					);
					
				if (r.dt_prevista IS NOT NULL AND r.dt_prevista::text <> '' AND r.nm_usuario_prev IS NOT NULL AND r.nm_usuario_prev::text <> '') then
					begin
						insert
						into man_ordem_ativ_prev(
								nr_sequencia,
								nr_seq_ordem_serv,
								nr_seq_ativ_exec,
								dt_prevista,
								qt_min_prev,
								nm_usuario_prev,
								ie_prioridade_desen,
								ie_prioridade_sup,
								dt_atualizacao,
								nm_usuario
							)
							values (
								nextval('man_ordem_ativ_prev_seq'),
								nr_seq_os_w,
								49,			-- Programacao
								r.dt_prevista,
								r.qt_estimativa,
								r.nm_usuario_prev,
								10,
								10,
								clock_timestamp(),
								nm_usuario_p
							);
					end;
				end if;
			end;
			begin
				update man_ordem_serv_filha
				set nr_seq_ordem_servico_filha = nr_seq_os_w
				where nr_sequencia             = r.nr_sequencia;
			end;
			for reg in c_anexos(r.nr_sequencia)
			loop
				insert
				into man_ordem_serv_arq(
						nr_sequencia,
						nr_seq_ordem,
						dt_atualizacao,
						nm_usuario,
						ds_arquivo,
						ie_anexar_email,
						ie_status_anexo,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						ds_observacao
					)
					values (
						nextval('man_ordem_serv_arq_seq'),
						nr_seq_os_w,
						clock_timestamp(),
						nm_usuario_p,
						reg.ds_arquivo,
						'S',
						'A',
						clock_timestamp(),
						nm_usuario_p,
						reg.ds_observacao
					);
			end loop;
		end loop;
		commit;
	end;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_os_requisitos ( nr_seq_filhas_p text, nr_seq_ordem_serv_pai_p bigint, nm_usuario_p text ) FROM PUBLIC;

