-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_pedido_kit_agenda ( nr_seq_agenda_p bigint, cd_procedimento_old_p bigint, ie_origem_proced_old_p bigint, cd_procedimento_new_p bigint, ie_origem_proced_new_p bigint, nr_seq_proc_interno_p bigint, cd_medico_p text, nm_usuario_p text, cd_estabelecimento_p bigint, cd_agenda_p bigint, cd_pessoa_fisica_p bigint) AS $body$
DECLARE

 
ie_ordem_w		   varchar(1);
cd_procedimento_w	  bigint;
ie_origem_proced_w	bigint;
cd_kit_material_w	  integer;
nr_seq_kit_w		  bigint;	
nr_seq_pedido_w		bigint;
ie_estab_agenda_w	  varchar(1);	
cd_estabelecimento_w	smallint;
ds_erro_w		   varchar(255);
qt_idade_w			  varchar(255);

C01 CURSOR FOR 
	SELECT 1 ie_ordem, 
		b.cd_procedimento, 
		b.ie_origem_proced, 
		b.cd_kit_material 
	from  kit_material k, 
		procedimento b 
	where  b.cd_procedimento  = cd_procedimento_new_p 
	and   b.ie_origem_proced  = ie_origem_proced_new_p 
	and   b.cd_kit_material  = k.cd_kit_material 
	and   k.ie_situacao    = 'A' 
	and   coalesce(nr_seq_proc_interno_p::text, '') = '' 
	
union
 
	SELECT 1 ie_ordem, 
		b.cd_procedimento, 
		b.ie_origem_proced, 
		b.cd_kit_material 
	from  kit_material k, 
		proc_interno b 
	where  b.nr_sequencia	   = nr_seq_proc_interno_p		 
	and   b.cd_kit_material  = k.cd_kit_material 
	and   k.ie_situacao    = 'A' 
	
union
 
	select 1 ie_ordem, 
		b.cd_procedimento, 
		b.ie_origem_proced, 
		c.cd_kit_material 
	from  kit_material k, 
		proc_interno b, 
		proc_interno_kit c 
	where  b.nr_sequencia	   = nr_seq_proc_interno_p		 
	and   c.nr_seq_proc_interno = b.nr_sequencia 
	and   ((c.cd_medico     = cd_medico_p) or (coalesce(c.cd_medico::text, '') = '') or (coalesce(cd_medico_p::text, '') = '')) 
	and   c.cd_kit_material   = k.cd_kit_material 
	and   k.ie_situacao     = 'A' 
	and	c.cd_estabelecimento  = cd_estabelecimento_w 
  and  qt_idade_w       between obter_idade_kit_proced(c.nr_sequencia,'MIN') 
                   and obter_idade_kit_proced(c.nr_sequencia,'MAX');

BEGIN
 
cd_estabelecimento_w := cd_estabelecimento_p;
ie_estab_agenda_w := Obter_Param_Usuario(871, 531, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_estab_agenda_w);
 
if (ie_estab_agenda_w = 'S') then 
	select	max(cd_estabelecimento) 
	into STRICT	cd_estabelecimento_w 
	from	agenda 
	where	cd_agenda = cd_agenda_p;
end if;	
 
 
select	max(nr_sequencia) 
into STRICT	nr_seq_pedido_w 
from	agenda_pac_pedido 
where	nr_seq_agenda = nr_seq_agenda_p 
and	coalesce(dt_liberacao::text, '') = '';
 
begin 
if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then 
  qt_idade_w:= coalesce(obter_idade_pf(cd_pessoa_fisica_p, clock_timestamp(), 'DIA'),0);
end if;
exception 
  when others then 
  qt_idade_w := 0;
end;
 
if (nr_seq_pedido_w IS NOT NULL AND nr_seq_pedido_w::text <> '') then 
	delete	 
	from 	agenda_pac_pedido_kit 
	where	cd_procedimento = cd_procedimento_old_p 
	and	ie_origem_proced= ie_origem_proced_old_p 
	and	nr_seq_pedido	= nr_seq_pedido_w;
		 
	open C01;
	loop 
	fetch C01 into	 
		ie_ordem_w, 
		cd_procedimento_w, 
		ie_origem_proced_w, 
		cd_kit_material_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		 
		ds_erro_w := null;
		ds_erro_w := consistir_pedido_kit(cd_kit_material_w, nm_usuario_p, nr_seq_agenda_p, ds_erro_w);
		 
		if (coalesce(ds_erro_w::text, '') = '') then 
		 
		 
			select	nextval('agenda_pac_pedido_kit_seq') 
			into STRICT	nr_seq_kit_w 
			;
			insert 	into agenda_pac_pedido_kit( 
						nr_sequencia, 
						dt_atualizacao, 
						nm_usuario, 
						dt_atualizacao_nrec, 
						nm_usuario_nrec, 
						nr_seq_pedido, 
						cd_kit_material, 
						cd_procedimento, 
						ie_origem_proced) 
				values (	nr_seq_kit_w, 
						clock_timestamp(), 
						nm_usuario_p, 
						clock_timestamp(), 
						nm_usuario_p, 
						nr_seq_pedido_w, 
						cd_kit_material_w, 
						cd_procedimento_w, 
						ie_origem_proced_w);
		end if;
		end;
	end loop;
	close C01;
end if;	
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_pedido_kit_agenda ( nr_seq_agenda_p bigint, cd_procedimento_old_p bigint, ie_origem_proced_old_p bigint, cd_procedimento_new_p bigint, ie_origem_proced_new_p bigint, nr_seq_proc_interno_p bigint, cd_medico_p text, nm_usuario_p text, cd_estabelecimento_p bigint, cd_agenda_p bigint, cd_pessoa_fisica_p bigint) FROM PUBLIC;

