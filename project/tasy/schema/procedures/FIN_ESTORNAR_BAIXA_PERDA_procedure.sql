-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fin_estornar_baixa_perda ( nr_seq_perda_p bigint, nr_seq_baixa_p bigint, nr_seq_movto_trans_p bigint, dt_baixa_p timestamp, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		integer;
nr_titulo_w		bigint;
nr_Seq_cheque_w		bigint;
cd_estabelecimento_w	smallint;
nr_seq_movto_pend_baixa_w   perda_contas_receb_baixa.nr_seq_movto_pend_baixa%type;
nr_seq_movto_pend_w         perda_contas_receb_baixa.nr_seq_movto_pend%type;
vl_baixa_w                  perda_contas_receb_baixa.vl_baixa%type;


BEGIN
select	max(nr_titulo),
	max(nr_seq_cheque),
	max(cd_estabelecimento)
into STRICT	nr_titulo_w,
	nr_Seq_cheque_w,
	cd_estabelecimento_w
from	perda_contas_receber
where	nr_sequencia = 	nr_seq_perda_p;

select	coalesce(max(nr_sequencia),0) + 1
into STRICT	nr_sequencia_w
from	perda_contas_receb_baixa
where	nr_seq_perda = nr_seq_perda_p;

insert into perda_contas_receb_baixa(
	nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_seq_perda,
	dt_baixa,
	vl_baixa,
	nr_seq_tipo_baixa,
	ie_acao,
	nr_seq_baixa_orig,
	nr_seq_movto_trans_fin,
    nr_seq_movto_pend)
SELECT	nr_sequencia_w,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_perda,
	coalesce(dt_baixa_p, dt_baixa),
	(a.vl_baixa * - 1),
	nr_seq_tipo_baixa,
	2,
	nr_sequencia,
	nr_seq_movto_trans_p,
    nr_seq_movto_pend
from	perda_contas_receb_baixa a
where	nr_seq_perda = nr_seq_perda_p
and	nr_sequencia = nr_seq_baixa_p;

update	perda_contas_receb_baixa
set	ie_acao = 3
where	nr_seq_perda = nr_seq_perda_p
and	nr_sequencia = nr_seq_baixa_p;

CALL fin_atualizar_saldo_perda(nr_seq_perda_p, nm_usuario_p);

CALL atualizar_cobranca(nr_titulo_w, nr_seq_cheque_w, 'N', cd_estabelecimento_w, nm_usuario_p);

select	max(nr_seq_movto_pend_baixa), max(nr_seq_movto_pend), max(vl_baixa)
into STRICT	nr_seq_movto_pend_baixa_w, nr_seq_movto_pend_w, vl_baixa_w
from	perda_contas_receb_baixa
where	nr_seq_perda = nr_seq_perda_p
        and	nr_sequencia = nr_seq_baixa_p;

if (nr_seq_movto_pend_baixa_w IS NOT NULL AND nr_seq_movto_pend_baixa_w::text <> '') then
    CALL baixar_movto_banco_pend(	
        nr_seq_movto_pend_w         -- NR_SEQ_MOVTO_PEND_P	    number,
        ,null                   	-- DT_BAIXA_P		        date default sysdate,
        ,vl_baixa_w * -1            -- VL_BAIXA_P		        number,
        ,null                       -- NR_TITULO_P		        number,
        ,null                       -- NR_SEQ_BAIXA_P		    number,
        ,nm_usuario_p               -- NM_USUARIO_P		        varchar2,
        ,'S'                        -- IE_COMMIT_P		        varchar2,
        ,null                       -- NR_BORDERO_REC_P	        number,
        ,null                       -- NR_SEQ_CONV_RECEB_P	    number,
        ,null                       -- NR_ADIANTAMENTO_P	    number,
        ,null                       -- NR_SEQ_CHEQUE_P		    number,
        ,null                       -- NR_SEQ_MOVTO_BANCO_P	    number,
        ,null                       -- NR_SEQ_MOVTO_CAIXA_P	    number,
        ,null                       -- NR_SEQ_MOVTO_CARTAO_P	number,
        ,null                       -- NR_SEQ_LOTE_CARTAO_P	    number,
        ,nr_seq_movto_pend_baixa_w  -- NR_SEQUENCIA_BAIXA_P	    number default null,        
        ,nr_seq_baixa_p             -- NR_SEQ_PERDA_BAIXA_P     in perda_contas_receb_baixa.nr_sequencia%type default null	
        ,nr_seq_perda_p             -- NR_SEQ_PERDA_P           in perda_contas_receb_baixa.nr_seq_perda%type default null,	
    );
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fin_estornar_baixa_perda ( nr_seq_perda_p bigint, nr_seq_baixa_p bigint, nr_seq_movto_trans_p bigint, dt_baixa_p timestamp, nm_usuario_p text) FROM PUBLIC;

