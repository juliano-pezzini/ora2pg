-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE assumir_paciente_acad ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text) AS $body$
DECLARE

 
cd_setor_atend_regra_w		integer;
cd_especialidade_regra_w	bigint;
cd_medico_regra_w		varchar(10);
nr_sequencia_w			bigint;

cd_setor_atendimento_w		integer;
cd_especialidade_w		bigint;
cd_medico_resp_w		varchar(10);

qt_registro_w			smallint:= 0;
qt_especialidade_w		smallint:= 0;

ie_controle_w			varchar(1):= 'N';

c01 CURSOR FOR 
	SELECT	cd_setor_atendimento, 
		cd_especialidade, 
		cd_medico 
	from	pf_acad_med_regra 
	where	cd_pessoa_fisica = cd_pessoa_fisica_p;


BEGIN 
 
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then 
	select	count(*) 
	into STRICT	qt_registro_w 
	from	atend_pac_academico 
	where	nr_atendimento = nr_atendimento_p 
	and	cd_pessoa_fisica = cd_pessoa_fisica_p;
 
end if;
 
if (qt_registro_w = 0) then 
	select	obter_setor_atendimento(nr_atendimento_p), 
		cd_medico_resp 
	into STRICT	cd_setor_atendimento_w, 
		cd_medico_resp_w 
	from	atendimento_paciente 
	where	nr_atendimento = nr_atendimento_p;
 
	open c01;
	loop 
	fetch c01 into	cd_setor_atend_regra_w, 
			cd_especialidade_regra_w, 
			cd_medico_regra_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
 
	select	count(*) 
	into STRICT	qt_especialidade_w 
	from	medico_especialidade 
	where	cd_pessoa_fisica = cd_medico_resp_w 
	and	cd_especialidade = cd_especialidade_regra_w;
 
	if	((coalesce(cd_setor_atend_regra_w,cd_setor_atendimento_w) = cd_setor_atendimento_w) and 
		((coalesce(cd_especialidade_regra_w::text, '') = '') or (qt_especialidade_w > 0)) and (coalesce(cd_medico_regra_w,cd_medico_resp_w) = cd_medico_resp_w)) then 
		ie_controle_w:= 'S';
		exit;
	end if;
 
	end loop;
	close c01;
 
	if (ie_controle_w = 'S') then 
		select	nextval('atend_pac_academico_seq') 
		into STRICT	nr_sequencia_w 
		;
		 
		insert into atend_pac_academico( 
					nr_sequencia, 
					dt_atualizacao, 
					nm_usuario, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec, 
					cd_pessoa_fisica, 
					nr_atendimento, 
					dt_registro) 
		values ( 
					nr_sequencia_w, 
					clock_timestamp(), 
					nm_usuario_p, 
					clock_timestamp(), 
					nm_usuario_p, 
					cd_pessoa_fisica_p, 
					nr_atendimento_p, 
					clock_timestamp());
	end if;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE assumir_paciente_acad ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text) FROM PUBLIC;

