-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_dados_irpf (vl_base_calculo_p bigint, pr_aliquota_p INOUT bigint, vl_reducao_p INOUT bigint, vl_base_anterior_p bigint, dt_imposto_p timestamp, nr_seq_regra_irpf_p INOUT bigint) AS $body$
DECLARE


pr_aliquota_w			double precision := 0;
vl_reducao_w			double precision := 0;
vl_base_calculo_w		double precision := 0;
nr_seq_regra_irpf_w		regra_calculo_irpf.nr_sequencia%type;

C01 CURSOR FOR
SELECT	tx_aliquota,
	vl_reducao,
	vl_base_calculo,
	nr_sequencia
from	regra_calculo_irpf
where	vl_base_calculo		>= vl_base_calculo_p
and	dt_imposto_p		between coalesce(dt_inicio_vigencia,  dt_imposto_p - 1) and fim_dia(coalesce(dt_fim_vigencia, dt_imposto_p + 1))
order	by vl_base_calculo desc;


BEGIN

open C01;
loop
fetch C01 into
	pr_aliquota_w,
	vl_reducao_w,
	vl_base_calculo_w,
	nr_seq_regra_irpf_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	pr_aliquota_w	:= pr_aliquota_w;
end loop;
close C01;

pr_aliquota_p		:= coalesce(pr_aliquota_w, pr_aliquota_p);
vl_reducao_p		:= coalesce(vl_reducao_w,0);
nr_seq_regra_irpf_p	:= nr_seq_regra_irpf_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_dados_irpf (vl_base_calculo_p bigint, pr_aliquota_p INOUT bigint, vl_reducao_p INOUT bigint, vl_base_anterior_p bigint, dt_imposto_p timestamp, nr_seq_regra_irpf_p INOUT bigint) FROM PUBLIC;

