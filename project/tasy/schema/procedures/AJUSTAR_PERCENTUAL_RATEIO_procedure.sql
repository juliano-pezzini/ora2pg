-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ajustar_percentual_rateio (nr_seq_criterio_p bigint, dt_vigencia_p timestamp) AS $body$
DECLARE


qt_total_w		bigint;
nr_seq_criterio_w	bigint;
qt_rateio_w		bigint;
pr_rateio_w		double precision;
pr_total_rateio_w	double precision;
pr_diferenca_w		double precision;

C01 CURSOR FOR
SELECT	nr_sequencia,
	coalesce(qt_rateio,0)
from	ctb_criterio_rateio_item
where	nr_seq_criterio = nr_seq_criterio_p
and		coalesce(dt_inicio_vigencia,trunc(dt_vigencia_p))	<= trunc(dt_vigencia_p)
and		coalesce(dt_fim_vigencia,trunc(dt_vigencia_p))		>= trunc(dt_vigencia_p)
order by coalesce(qt_rateio,0);


BEGIN

/*update 	ctb_criterio_rateio_item
set	pr_rateio = 0
where	nr_seq_criterio = nr_Seq_criterio_p;*/
select	sum(coalesce(qt_rateio,0))
into STRICT	qt_total_w
from	ctb_criterio_rateio_item
where	nr_seq_criterio = nr_seq_criterio_p
and		coalesce(dt_inicio_vigencia,trunc(dt_vigencia_p))	<= trunc(dt_vigencia_p)
and		coalesce(dt_fim_vigencia,trunc(dt_vigencia_p))		>= trunc(dt_vigencia_p);

if (qt_total_w > 0) then

	pr_total_rateio_w	:= 0;

	open C01;
	loop
	fetch C01 into
		nr_seq_criterio_w,
		qt_rateio_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		pr_rateio_w := (qt_rateio_w * 100)/qt_total_w;
		pr_total_rateio_w	:= pr_total_rateio_w + coalesce(pr_rateio_w,0);

		update 	ctb_criterio_rateio_item
		set	pr_rateio = pr_rateio_w
		where	nr_Sequencia = nr_seq_criterio_w;
		end;
	end loop;
	close C01;
end if;
/*Rotina para ajuste do percentual devido arredondamento */

if (pr_total_rateio_w <> 100) then

	pr_diferenca_w		:= abs(pr_total_rateio_w - 100);

	if (pr_total_rateio_w > 100) then
		update	ctb_criterio_rateio_item
		set	pr_rateio	= pr_rateio - pr_diferenca_w
		where	nr_sequencia	= nr_seq_criterio_w;
	elsif (pr_total_rateio_w < 100) then
		update	ctb_criterio_rateio_item
		set	pr_rateio	= pr_rateio + pr_diferenca_w
		where	nr_sequencia	= nr_seq_criterio_w;
	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ajustar_percentual_rateio (nr_seq_criterio_p bigint, dt_vigencia_p timestamp) FROM PUBLIC;

