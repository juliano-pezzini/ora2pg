-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_retirar_contrato_lote_reaj ( nr_seq_reajuste_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_tabela_reaj_w		bigint;
qt_reaj_copartic_aplicado_w	bigint;
nr_seq_lote_reaj_copartic_w	bigint;
nr_seq_lote_reaj_inscricao_w	bigint;
qt_reaj_inscricao_aplicado_w	bigint;

C01 CURSOR FOR
	SELECT	a.nr_sequencia
	from	pls_reajuste_tabela	a,
		pls_reajuste		b
	where	a.nr_seq_reajuste	= b.nr_sequencia
	and	b.nr_sequencia		= nr_seq_reajuste_p;

C02 CURSOR FOR
	SELECT	a.nr_sequencia
	from	pls_lote_reaj_copartic	a,
		pls_reajuste		b
	where	a.nr_seq_reajuste	= b.nr_sequencia
	and	b.nr_sequencia		= nr_seq_reajuste_p;

C03 CURSOR FOR
	SELECT	a.nr_sequencia
	from	pls_lote_reaj_inscricao	a,
		pls_reajuste		b
	where	a.nr_seq_reajuste	= b.nr_sequencia
	and	b.nr_sequencia		= nr_seq_reajuste_p;


BEGIN

select	count(*)
into STRICT	qt_reaj_copartic_aplicado_w
from	pls_lote_reaj_copartic	a,
	pls_reajuste		b
where	a.nr_seq_reajuste	= b.nr_sequencia
and	b.nr_sequencia		= nr_seq_reajuste_p
and	(a.dt_aplicacao IS NOT NULL AND a.dt_aplicacao::text <> '');

if (qt_reaj_copartic_aplicado_w > 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort( 238962, null );
	/* Não é possível excluir o contrato do lote de reajuste, pois já foi aplicado reajuste de coparticipação. Favor verifique! */

end if;

select	count(*)
into STRICT	qt_reaj_inscricao_aplicado_w
from	pls_lote_reaj_inscricao	a,
	pls_reajuste		b
where	a.nr_seq_reajuste	= b.nr_sequencia
and	b.nr_sequencia		= nr_seq_reajuste_p
and	(a.dt_aplicacao IS NOT NULL AND a.dt_aplicacao::text <> '');

if (qt_reaj_inscricao_aplicado_w > 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort( 238963, null );
	/* Não é possível excluir o contrato do lote de reajuste, pois já foi aplicado reajuste de inscrição. Favor verifique! */

end if;

open C01;
loop
fetch C01 into
	nr_seq_tabela_reaj_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	delete	from	pls_reajuste_tabela
	where	nr_sequencia	= nr_seq_tabela_reaj_w;
	end;
end loop;
close C01;

open C02;
loop
fetch C02 into
	nr_seq_lote_reaj_copartic_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	delete	from	pls_reajuste_copartic
	where	nr_seq_lote	= nr_seq_lote_reaj_copartic_w;

	delete	from	pls_lote_reaj_copartic
	where	nr_sequencia	= nr_seq_lote_reaj_copartic_w;
	end;
end loop;
close C02;

open C03;
loop
fetch C03 into
	nr_seq_lote_reaj_inscricao_w;
EXIT WHEN NOT FOUND; /* apply on C03 */
	begin
	delete	from	pls_reajuste_inscricao
	where	nr_seq_lote	= nr_seq_lote_reaj_inscricao_w;

	delete	from	pls_lote_reaj_inscricao
	where	nr_sequencia	= nr_seq_lote_reaj_inscricao_w;
	end;
end loop;
close C03;

update	pls_prog_reaj_coletivo
set	nr_seq_reajuste  = NULL,
	ie_status	= 'L',
	dt_atualizacao	= clock_timestamp(),
	nm_usuario	= nm_usuario_p
where	nr_seq_reajuste	= nr_seq_reajuste_p;

delete	from	pls_reajuste
where	nr_sequencia	= nr_seq_reajuste_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_retirar_contrato_lote_reaj ( nr_seq_reajuste_p bigint, nm_usuario_p text) FROM PUBLIC;

