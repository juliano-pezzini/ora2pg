-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicate_outdated (nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE

	nr_sequencia_w bigint;
	cd_estabelecimento_w smallint;
	cd_cgc_emitente_w varchar(14);
	cd_serie_nf_w nota_fiscal.cd_serie_nf%type;
	nr_sequencia_nf_w bigint;
	dt_vencimento_w timestamp;
	vl_vencimento_w double precision;
	dt_atualizacao_w timestamp;
	nm_usuario_w varchar(15);
	vl_base_venc_w double precision;
	vl_desconto_w double precision;
	vl_desc_financ_w double precision;
	nr_titulo_pagar_w bigint;
	ds_observacao_w varchar(255);
	nr_nota_fiscal_w varchar(255);
	ie_venc_alt_sistema_w varchar(1);
	ie_conferido_w varchar(1);
	ie_origem_w varchar(1);
	nr_titulo_vinc_w bigint;

	C01 CURSOR FOR
		SELECT 		CD_ESTABELECIMENTO,
					CD_CGC_EMITENTE,
					CD_SERIE_NF,
					NR_SEQUENCIA_NF,
					DT_VENCIMENTO,
					VL_VENCIMENTO,
					DT_ATUALIZACAO,
					NM_USUARIO,
					VL_BASE_VENC,
					VL_DESCONTO,
					VL_DESC_FINANC,
					NR_TITULO_PAGAR,
					DS_OBSERVACAO,
					NR_NOTA_FISCAL,
					IE_VENC_ALT_SISTEMA,
					IE_CONFERIDO,
					IE_ORIGEM,NR_TITULO_VINC
		FROM 		NOTA_FISCAL_VENC
		WHERE 		NR_SEQUENCIA = nr_sequencia_p;

BEGIN
	select MAX(nr_sequencia)+1
		   into STRICT nr_sequencia_w
	FROM NOTA_FISCAL_VENC;

	open C01;
	loop
	fetch C01 into
		cd_estabelecimento_w,
		cd_cgc_emitente_w,
		cd_serie_nf_w,
		nr_sequencia_nf_w,
		dt_vencimento_w,
		vl_vencimento_w,
		dt_atualizacao_w,
		nm_usuario_w,
		vl_base_venc_w,
		vl_desconto_w,
		vl_desc_financ_w,
		nr_titulo_pagar_w,
		ds_observacao_w,
		nr_nota_fiscal_w,
		ie_venc_alt_sistema_w,
		ie_conferido_w,
		ie_origem_w,
		nr_titulo_vinc_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
			INSERT INTO NOTA_FISCAL_VENC(NR_SEQUENCIA, CD_ESTABELECIMENTO, CD_CGC_EMITENTE, CD_SERIE_NF, NR_SEQUENCIA_NF, DT_VENCIMENTO, VL_VENCIMENTO, DT_ATUALIZACAO,
										 NM_USUARIO, VL_BASE_VENC, VL_DESCONTO, VL_DESC_FINANC, NR_TITULO_PAGAR, DS_OBSERVACAO, NR_NOTA_FISCAL, IE_VENC_ALT_SISTEMA,
										 IE_CONFERIDO, IE_ORIGEM, NR_TITULO_VINC)
								  VALUES (nr_sequencia_w, cd_estabelecimento_w , cd_cgc_emitente_w , cd_serie_nf_w , nr_sequencia_nf_w , dt_vencimento_w , vl_vencimento_w , clock_timestamp() ,
										 nm_usuario_p , vl_base_venc_w , vl_desconto_w , vl_desc_financ_w, nr_titulo_pagar_w , ds_observacao_w , nr_nota_fiscal_w , ie_venc_alt_sistema_w ,
										 ie_conferido_w , ie_origem_w , nr_titulo_vinc_w);
		end;
	end loop;
	close C01;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicate_outdated (nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

