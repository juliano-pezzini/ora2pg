-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copia_observacao_enf ( nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE

						
ie_tipo_item_w		char;
nr_sequencia_w		bigint;
nr_sequencia_ww		bigint;
nr_prescricao_ant_w	bigint;
nr_sequencia_ant_w	bigint;
qt_registros_w		bigint;
nr_sequencia_new_w	bigint;

c01 CURSOR FOR
SELECT  'M' tipo, 	
		nr_sequencia,	
		nr_prescricao_anterior,
		nr_sequencia_anterior
from 	prescr_material
		where nr_prescricao = nr_prescricao_p
and (nr_prescricao_anterior IS NOT NULL AND nr_prescricao_anterior::text <> '' AND nr_seq_anterior IS NOT NULL AND nr_seq_anterior::text <> '')

union

SELECT 	'S' tipo, 	
		nr_seq_solucao,	
		nr_prescricao_anterior,
		nr_sequencia_anterior
from 	prescr_solucao	
where	nr_prescricao = nr_prescricao_p
and (nr_prescricao_anterior IS NOT NULL AND nr_prescricao_anterior::text <> '' AND nr_sequencia_anterior IS NOT NULL AND nr_sequencia_anterior::text <> '')

union

select	'G' tipo, 	
		nr_sequencia,	
		nr_prescricao_original nr_prescricao_anterior,
		nr_seq_anterior
from 	prescr_gasoterapia	
where	nr_prescricao = nr_prescricao_p
and (nr_prescricao_original IS NOT NULL AND nr_prescricao_original::text <> '' AND nr_seq_anterior IS NOT NULL AND nr_seq_anterior::text <> '');
	
c02 CURSOR FOR
SELECT 	a.nr_sequencia
from   	prescr_mat_alteracao a,
		adep_tipo_observacao b
where  	a.nr_prescricao = nr_prescricao_ant_w
and	a.nr_seq_prescricao = nr_sequencia_ant_w
and    	a.ie_alteracao = 11
and (coalesce(a.ie_mostra_adep,'S') = 'S' and
         coalesce(a.ie_evento_valido,'S') = 'S')		 
and 	b.nr_sequencia = a.nr_seq_tipo_obs
and		coalesce(b.ie_copia_prescr,'N') = 'S';

c03 CURSOR FOR
SELECT 	a.nr_sequencia
from   	prescr_solucao_evento a,
		adep_tipo_observacao b
where  	a.nr_prescricao = nr_prescricao_ant_w
and		a.nr_seq_solucao = nr_sequencia_ant_w
and    	a.ie_alteracao = 9
and (coalesce(a.ie_mostra_adep,'S') = 'S' and
        coalesce(a.ie_evento_valido,'S') = 'S')		 
and 	b.nr_sequencia = a.nr_seq_tipo_obs
and		coalesce(b.ie_copia_prescr,'N') = 'S';

c04 CURSOR FOR
SELECT 	a.nr_sequencia
from   	prescr_gasoterapia_evento a,
		adep_tipo_observacao b
where  	a.nr_seq_gasoterapia = nr_sequencia_ant_w
and    	a.ie_evento = 'O'
and (coalesce(a.ie_mostra_adep,'S') = 'S' and
         coalesce(a.ie_evento_valido,'S') = 'S')
and 	b.nr_sequencia = a.nr_seq_tipo_obs
and		coalesce(b.ie_copia_prescr,'N') = 'S';


BEGIN
	open c01;
	loop
	fetch c01 into
		ie_tipo_item_w,
		nr_sequencia_w,		
		nr_prescricao_ant_w,
		nr_sequencia_ant_w;			
	EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
		if (ie_tipo_item_w = 'M') then
		begin
			
			open c02;
			loop
			fetch c02 into
				nr_sequencia_ww;
			EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
						
				select nextval('prescr_mat_alteracao_seq')
				into STRICT nr_sequencia_new_w
				;
													
				insert into prescr_mat_alteracao(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_prescricao,
				nr_seq_prescricao,
				dt_alteracao,
				cd_pessoa_fisica,
				ie_alteracao,				
				ds_observacao,
				ie_tipo_item,
				nr_atendimento,
				cd_item,
				ie_acm_sn,
				ie_mostra_adep,
				ie_evento_valido,
				ds_stack,
				cd_funcao,
				nr_seq_tipo_obs)
				SELECT 	nr_sequencia_new_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_prescricao_p,
					nr_sequencia_w,
					clock_timestamp(),
					cd_pessoa_fisica,
					ie_alteracao,					
					CASE WHEN position(obter_desc_expressao(331157) in ds_observacao)=0 THEN substr(obter_desc_expressao(781857)/*'Mantido na copia: '*/
 || ds_observacao,1,2000)  ELSE ds_observacao END ,
					ie_tipo_item,
					nr_atendimento,
					cd_item,
					ie_acm_sn,
					'S',
					'S',
					ds_stack,
					cd_funcao,
					nr_seq_tipo_obs
				from	prescr_mat_alteracao
				where	nr_sequencia = nr_sequencia_ww;				
			--end if;
			end;
			end loop;
			close c02;
		end;
		elsif (ie_tipo_item_w = 'S') then
		begin
			
			open c03;
			loop
			fetch c03 into
				nr_sequencia_ww;
			EXIT WHEN NOT FOUND; /* apply on c03 */			
			begin
							
				select nextval('prescr_solucao_evento_seq')
				into STRICT nr_sequencia_new_w
				;
				
				insert into prescr_solucao_evento(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_prescricao,
				nr_seq_solucao,
				qt_dosagem,
				cd_pessoa_fisica,
				ie_alteracao,
				dt_alteracao,
				ds_observacao,
				ie_evento_valido,
				ie_tipo_solucao,
				nr_atendimento,
				cd_funcao,				
				nr_seq_tipo_obs,
				ie_mostra_adep)
				SELECT 	nr_sequencia_new_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_prescricao_p,
					nr_sequencia_w,
					qt_dosagem,
					cd_pessoa_fisica,
					ie_alteracao,
					clock_timestamp(),					
					CASE WHEN position(obter_desc_expressao(331157) in ds_observacao)=0 THEN substr(obter_desc_expressao(781857)/*'Mantido na copia: '*/
 || ds_observacao,1,2000)  ELSE ds_observacao END ,
					'S',
					ie_tipo_solucao,
					nr_atendimento,
					cd_funcao,					
					nr_seq_tipo_obs,
					'S'
				from	prescr_solucao_evento
				where	nr_sequencia = nr_sequencia_ww;
			
			end;
			end loop;
			close c03;
		end;
		elsif (ie_tipo_item_w = 'G') then
		begin	
			
			open c04;
			loop
			fetch c04 into
				nr_sequencia_ww;
			EXIT WHEN NOT FOUND; /* apply on c04 */
			begin
					
				select nextval('prescr_gasoterapia_evento_seq')
				into STRICT nr_sequencia_new_w
				;
			
				insert into prescr_gasoterapia_evento(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_gasoterapia,
				ie_evento,
				qt_gasoterapia,
				ie_unidade_medida,
				dt_evento,
				ie_evento_valido,
				ds_observacao,
				ie_disp_resp_esp,
				nr_seq_motivo,
				ds_justificativa,
				nr_seq_assinatura,
				nr_etapa_evento,
				nr_seq_horario,
				nr_seq_tipo_obs,
				ie_mostra_adep)
				SELECT	nr_sequencia_new_w,				
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_sequencia_w,
					ie_evento,
					qt_gasoterapia,
					ie_unidade_medida,
					clock_timestamp(),
					ie_evento_valido,					
					CASE WHEN position(obter_desc_expressao(331157) in ds_observacao)=0 THEN substr(/*'Mantido na copia: '*/
obter_desc_expressao(781857) || ds_observacao,1,255)  ELSE ds_observacao END ,
					ie_disp_resp_esp,
					nr_seq_motivo,
					ds_justificativa,
					nr_seq_assinatura,
					nr_etapa_evento,
					nr_seq_horario,
					nr_seq_tipo_obs,
					ie_mostra_adep
				from 	prescr_gasoterapia_evento
				where	nr_sequencia = nr_sequencia_ww;

			end;
			end loop;
			close c04;			
		end;
		end if;
	end;		
	end loop;
	close c01;
	
	commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copia_observacao_enf ( nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

