-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE aprov_rev_idiomas_doc ( nr_sequencia_p bigint, dt_aprovacao_p timestamp, nm_usuario_p text, ie_status_p text) AS $body$
DECLARE


nr_seq_w		bigint;
ds_arquivo_w		varchar(255);
cd_pessoa_aprovacao_w	varchar(10);

c01 CURSOR FOR
	SELECT	nr_sequencia
	from	qua_documento
	where	nr_seq_superior = nr_sequencia_p;


BEGIN
	open c01;
	loop
	fetch c01 into	
		nr_seq_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
			select	max(ds_arquivo)
			into STRICT	ds_arquivo_w
			from	qua_doc_revisao
			where	nr_seq_doc = nr_seq_w
			and	(dt_validacao IS NOT NULL AND dt_validacao::text <> '')
			and	coalesce(dt_aprovacao::text, '') = '';
			
			select	max(cd_pessoa_fisica)
			into STRICT	cd_pessoa_aprovacao_w
			from	usuario
			where	nm_usuario = nm_usuario_p;
			
			update	qua_doc_revisao
			set	dt_atualizacao = clock_timestamp(),
				nm_usuario = nm_usuario_p, 
				dt_aprovacao = clock_timestamp(), 
				nm_usuario_aprovacao = nm_usuario_p,
				cd_pessoa_aprovacao = cd_pessoa_aprovacao_w
			where	nr_seq_doc = nr_seq_w
			and	(dt_validacao IS NOT NULL AND dt_validacao::text <> '')
			and	coalesce(dt_aprovacao::text, '') = ''
			and	coalesce(ie_situacao, 'A') = 'A';
			
			update	qua_documento
			set	ie_status = ie_status_p,
				ds_arquivo = coalesce(ds_arquivo_w, ds_arquivo),
				dt_atualizacao = clock_timestamp(),
				nm_usuario = nm_usuario_p,
				dt_aprovacao = coalesce(dt_aprovacao, clock_timestamp())
			where	nr_sequencia = nr_seq_w;
		end;
	end loop;
	close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE aprov_rev_idiomas_doc ( nr_sequencia_p bigint, dt_aprovacao_p timestamp, nm_usuario_p text, ie_status_p text) FROM PUBLIC;

