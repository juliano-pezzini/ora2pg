-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE loc_obj_obter_filhos ( nr_seq_raiz_p bigint , cd_funcao_p bigint , nm_usuario_p text , ie_marcado_p text ) AS $body$
DECLARE

  x RECORD;

BEGIN
    FOR x IN (WITH RECURSIVE cte AS (
SELECT nr_seq_obj_sup,nr_seq_obj,nr_seq_dic_obj,nr_seq_evt,cd_funcao,nm_usuario,1 as level
              FROM   w_localizador_objetos WHERE Coalesce(nr_seq_obj, nr_seq_dic_obj, nr_seq_evt) = nr_seq_raiz_p
  UNION ALL
SELECT nr_seq_obj_sup,nr_seq_obj,nr_seq_dic_obj,nr_seq_evt,cd_funcao,nm_usuario,(c.level+1)
              FROM   w_localizador_objetos JOIN cte c ON (c.Coalesce(nr_seq_obj, nr_seq_dic_obj, nr_seq_evt) = nr_seq_obj_sup AND c.nm_usuario = nm_usuario AND c.cd_funcao = cd_funcao
              ORDER  BY nr_seq_obj_sup
                        , LEVEL)

) SELECT * FROM cte WHERE cd_funcao = cd_funcao_p
                 AND nm_usuario = nm_usuario_p
                 /*AND LEVEL > 1 */
 /*consider only children*/

;
) LOOP

        IF (x.nr_seq_obj IS NOT NULL AND x.nr_seq_obj::text <> '') THEN /* Object from objeto_schematic */
          UPDATE w_localizador_objetos
          SET    ie_marcado = ie_marcado_p
          WHERE  nr_seq_obj = x.nr_seq_obj
             AND cd_funcao = x.cd_funcao
             AND nm_usuario = x.nm_usuario
             AND nr_seq_obj_sup = x.nr_seq_obj_sup;

        ELSIF (x.nr_seq_dic_obj IS NOT NULL AND x.nr_seq_dic_obj::text <> '') THEN /* Object from dic_objeto */
          UPDATE w_localizador_objetos
          SET    ie_marcado = ie_marcado_p
          WHERE  nr_seq_dic_obj = x.nr_seq_dic_obj
             AND cd_funcao = x.cd_funcao
             AND nm_usuario = x.nm_usuario
             AND nr_seq_obj_sup = x.nr_seq_obj_sup;

        ELSIF (x.nr_seq_evt IS NOT NULL AND x.nr_seq_evt::text <> '') THEN /* Object from obj_schematic_evento */
          UPDATE w_localizador_objetos
          SET    ie_marcado = ie_marcado_p
          WHERE  nr_seq_evt = x.nr_seq_evt
             AND cd_funcao = x.cd_funcao
             AND nm_usuario = x.nm_usuario
             AND nr_seq_obj_sup = x.nr_seq_obj_sup;
        END IF;

    END LOOP;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE loc_obj_obter_filhos ( nr_seq_raiz_p bigint , cd_funcao_p bigint , nm_usuario_p text , ie_marcado_p text ) FROM PUBLIC;

