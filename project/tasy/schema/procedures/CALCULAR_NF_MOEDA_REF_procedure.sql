-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_nf_moeda_ref ( nr_seq_nota_p bigint) AS $body$
DECLARE



cd_moeda_ref_w		integer;
vl_cotacao_w		cotacao_moeda.vl_cotacao%type;
vl_liq_moeda_ref_w	double precision;
nr_item_nf_w		integer;
vl_total_item_nf_w	double precision;
dt_cotacao_w		timestamp;

c01 CURSOR FOR
	SELECT	nr_item_nf
	from	nota_fiscal_item
	where	nr_sequencia = nr_seq_nota_p;


BEGIN

select	coalesce(max(cd_moeda_ref),0)
into STRICT	cd_moeda_ref_w
from	empresa;

if (cd_moeda_ref_w <> 0) then
	begin
	select vl_cotacao
	into STRICT	 vl_cotacao_w
	from   cotacao_moeda
	where  cd_moeda  	= cd_moeda_ref_w
	and  	 dt_cotacao =
 		(SELECT  max(dt_cotacao)
   		from 	cotacao_moeda
  		where cd_moeda = cd_moeda_ref_w
    		and   trunc(dt_cotacao) <=
    			(select trunc(dt_emissao)
   			from  nota_fiscal
   			where  nr_sequencia = nr_seq_nota_p));
	exception when others then
		vl_cotacao_w := 0;
	end;
end if;

OPEN C01;
LOOP
FETCH C01 into
	nr_item_nf_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	BEGIN

	if (vl_cotacao_w <> 0) then
		begin

		select	vl_total_item_nf
		into STRICT	vl_total_item_nf_w
		from	nota_fiscal_item
		where	nr_sequencia	= nr_seq_nota_p
		and	nr_item_nf	= nr_item_nf_w;

		vl_liq_moeda_ref_w	:= vl_total_item_nf_w / vl_cotacao_w;

		update	nota_fiscal_item
		set	vl_liq_moeda_ref = vl_liq_moeda_ref_w
		where	nr_sequencia	= nr_seq_nota_p
		and	nr_item_nf	= nr_item_nf_w;

		commit;
		end;
	end if;
	END;
END LOOP;
close c01;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_nf_moeda_ref ( nr_seq_nota_p bigint) FROM PUBLIC;

