-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_nf_item_dev_resp_consig ( nr_sequencia_resp_consig_p bigint, nr_sequencia_p bigint, nr_sequencia_nf_p bigint, nr_seq_resp_consig_item_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, cd_operacao_nf_p bigint, cd_serie_nf_p text, dt_emissao_p timestamp, nr_nota_fiscal_p text, ie_valor_itens_p text, cd_natureza_operacao_p bigint, qt_material_p bigint, nr_seq_lote_fornec_p bigint, ie_gerar_itens_nota_p text) AS $body$
DECLARE


dt_atualizacao_w			 timestamp := clock_timestamp();
nr_item_nf_w			 integer;
vl_desconto_w			 double precision		:= 0;
vl_desconto_rateio_w		 double precision		:= 0;
vl_despesa_acessoria_w		 double precision		:= 0;
vl_frete_w			 double precision		:= 0;
vl_liquido_w			 double precision		:= 0;
vl_seguro_w			 double precision 		:= 0;
cd_cgc_emitente_w		 varchar(14);
cd_material_w			 integer		:= 0;
cd_material_estoque_w		 integer		:= 0;
cd_unidade_medida_compra_w	 varchar(30);
cd_unidade_medida_estoque_w	 varchar(30);
nr_seq_item_dev_w		 	 bigint;
qt_estoque_w			 double precision;
vl_total_item_nf_w		 	 double precision;
vl_unitario_item_nf_w		 double precision;
cd_local_Estoque_w		 smallint;
ie_tipo_conta_w			 integer;
cd_conta_contabil_w		 varchar(20);
cd_centro_conta_w		 integer;
			

BEGIN

if (ie_gerar_itens_nota_p = 'S') then
	select (coalesce(max(nr_item_nf),0)+1)
	into STRICT	nr_item_nf_w
	from	nota_fiscal_item
	where	nr_sequencia = nr_sequencia_p;

	select	cd_cgc
	into STRICT	cd_cgc_emitente_w
	from	estabelecimento
	where	cd_estabelecimento = cd_estabelecimento_p;
end if;

select	a.cd_material,
	a.cd_material_estoque,
	b.cd_unidade_compra,
	b.cd_unidade_estoque,
	(obter_conversao_material(a.cd_material, 'CE')*qt_material_p) qt_estoque,
	b.cd_local_estoque
into STRICT	cd_material_w,
	cd_material_estoque_w,
	cd_unidade_medida_compra_w,
	cd_unidade_medida_estoque_w,
	qt_estoque_w,
	cd_local_estoque_w
from	material a,
	sup_resp_consig_item b
where	b.nr_sequencia = nr_seq_resp_consig_item_p
and	b.cd_material = a.cd_material;

select	nextval('sup_resp_consig_item_dev_seq')
into STRICT	nr_seq_item_dev_w
;

if (ie_gerar_itens_nota_p = 'S') then
	if (ie_valor_itens_p = '0') then
		vl_unitario_item_nf_w := obter_custo_medio_material(cd_estabelecimento_p, trunc(clock_timestamp(), 'mm'), cd_material_w);
	elsif (ie_valor_itens_p = '1') then
		vl_unitario_item_nf_w := obter_valor_ultima_compra(cd_estabelecimento_p, 99999, cd_material_w, null, 'N');
	end if;
	
	vl_unitario_item_nf_w	:= coalesce(vl_unitario_item_nf_w,0);
	vl_total_item_nf_w := (vl_unitario_item_nf_w * qt_material_p);
	vl_liquido_w := (vl_total_item_nf_w - vl_desconto_w);
	
	ie_tipo_conta_w	:= 2;

	SELECT * FROM define_conta_material(
		cd_estabelecimento_p, cd_material_w, ie_tipo_conta_w, 0, 0, 0, 0, 0, 0, 0, cd_local_estoque_w, cd_operacao_nf_p, trunc(clock_timestamp()), cd_conta_contabil_w, cd_centro_conta_w, null) INTO STRICT cd_conta_contabil_w, cd_centro_conta_w;
end if;
	
insert into sup_resp_consig_item_dev(nr_sequencia,
				     dt_atualizacao,
				     nm_usuario,
				     dt_atualizacao_nrec,
				     nr_seq_resp,
				     nr_seq_item,
				     cd_material,
				     cd_unidade_compra,
				     qt_material,
				     cd_unidade_estoque,
				     qt_estoque,
				     nr_Seq_lote_fornec)
			      values (nr_seq_item_dev_w,
				     clock_timestamp(),
				     nm_usuario_p,
				     clock_timestamp(),
				     nr_sequencia_resp_consig_p,
				     nr_seq_resp_consig_item_p,
				     cd_material_w,
				     cd_unidade_medida_compra_w,
				     qt_material_p,
				     cd_unidade_medida_estoque_w,
				     qt_Estoque_w,
				     CASE WHEN nr_Seq_lote_fornec_p=0 THEN null  ELSE nr_Seq_lote_fornec_p END );
			
if (ie_gerar_itens_nota_p = 'S') then
	insert into nota_fiscal_item(	     cd_estabelecimento,
				     cd_natureza_operacao,
				     dt_atualizacao,
				     nm_usuario,
				     nr_item_nf,
				     nr_sequencia,
				     nr_sequencia_nf,
				     qt_item_nf,
				     qt_item_estoque,
				     vl_desconto,
				     vl_desconto_rateio,
				     vl_despesa_acessoria,
				     vl_frete,
				     vl_liquido,
				     vl_seguro, 
				     vl_total_item_nf,
				     vl_unitario_item_nf,
				     cd_cgc_emitente,
				     cd_material,
				     cd_material_estoque,
				     cd_unidade_medida_compra,
				     cd_unidade_medida_estoque,
				     nr_item_resp_consig,
				     nr_item_resp_consig_dev,
				     nr_nota_fiscal,
				     cd_serie_nf,
				     nr_Seq_lote_fornec,
				     cd_local_estoque,
				     cd_conta_contabil,
					 cd_sequencia_parametro)
			      values (cd_estabelecimento_p,
				     cd_natureza_operacao_p,
				     dt_atualizacao_w,
				     nm_usuario_p,
				     nr_item_nf_w,
				     nr_sequencia_p,
				     nr_sequencia_nf_p,
				     qt_material_p,
				     qt_estoque_w,
				     vl_desconto_w,
				     vl_desconto_rateio_w,
				     vl_despesa_acessoria_w,
				     vl_frete_w,
				     vl_liquido_w,
				     vl_seguro_w,
				     vl_total_item_nf_w,
				     vl_unitario_item_nf_w,
				     cd_cgc_emitente_w,
				     cd_material_w,
				     cd_material_estoque_w,
				     cd_unidade_medida_compra_w,
				     cd_unidade_medida_estoque_w,
				     nr_seq_resp_consig_item_p,
				     nr_seq_item_dev_w,
				     nr_nota_fiscal_p,
				     cd_serie_nf_p,
				     CASE WHEN nr_Seq_lote_fornec_p=0 THEN null  ELSE nr_Seq_lote_fornec_p END ,
				     cd_local_estoque_w,
				     cd_conta_contabil_w,
					 philips_contabil_pck.get_parametro_conta_contabil);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_nf_item_dev_resp_consig ( nr_sequencia_resp_consig_p bigint, nr_sequencia_p bigint, nr_sequencia_nf_p bigint, nr_seq_resp_consig_item_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, cd_operacao_nf_p bigint, cd_serie_nf_p text, dt_emissao_p timestamp, nr_nota_fiscal_p text, ie_valor_itens_p text, cd_natureza_operacao_p bigint, qt_material_p bigint, nr_seq_lote_fornec_p bigint, ie_gerar_itens_nota_p text) FROM PUBLIC;

