-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_rotina_espec_proc ( nr_atendimento_p bigint, nr_seq_rotina_esp_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_setor_atendimento_p bigint, ie_tipo_atendimento_p bigint, cd_convenio_p bigint, ie_tipo_convenio_p bigint, cd_plano_convenio_p text, cd_categoria_convenio_p text, dt_base_proc_p timestamp, cd_paciente_p text, qt_idade_dia_p bigint, qt_idade_mes_p bigint, qt_idade_ano_p bigint, qt_peso_p bigint, cd_prescritor_p text, cd_setor_usuario_p bigint, cd_medico_p text, cd_especialidade_p bigint, ie_gerar_associado_p char, nr_seq_item_gerado_p INOUT text, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, ie_urgencia_p text default null, ie_oncologia_p text default 'N', nr_seq_conclusao_apae_p bigint default null, hr_prim_hor_setor_p text default null, ie_lado_p text default null, nr_seq_material_exame_p text default null, ie_futuro_p text default 'N', ie_dia_seguinte_p text default 'N', ds_dado_clinico_p text default null, nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) AS $body$
DECLARE


ds_lista_proced_p  varchar(2000);
ds_lista_proced_w  varchar(2000);
ds_lista_rotina_w  varchar(2000);
ie_tipo_lista_w    varchar(2000);
ie_pos_virgula_w  bigint;
ie_pos_espaco_w    bigint;
tam_lista_w      bigint;
tam_lista2_w    bigint;
nr_seq_rotina_w    numeric(30);
nr_seq_item_gerado_w  bigint;
ds_mat_rotina_w  varchar(1000);
ds_prescricao_w    varchar(100);
cd_setor_atendimento_w		procedimento_setor_atend.cd_setor_atendimento%type;
nr_seq_proc_interno_w  		proc_interno.nr_sequencia%type;
param493_w	varchar(1);

c01 CURSOR FOR
SELECT  a.nr_sequencia nr_seq_rotina, a.ds_prescricao, a.nr_proc_interno
from  procedimento_rotina a
where  a.nr_seq_rotina  = nr_seq_rotina_esp_p
and    obter_se_proc_int_lib_estab(nr_proc_interno, cd_estabelecimento_p) = 'S'
and    cpoe_obter_se_proc_lib_rot(nr_atendimento_p, a.nr_proc_interno, CASE WHEN coalesce(cd_setor_atendimento_p::text, '') = '' THEN  obter_cd_setor_atend_padrao(a.nr_proc_interno, null, cd_estabelecimento_p, null, nr_atendimento_p)  ELSE cd_setor_atendimento_p END , nm_usuario_p, cd_perfil_p) = 'S';

c02 CURSOR FOR
SELECT  x.nr_sequencia, x.ds_prescricao, x.nr_seq_exame_interno
from  exame_lab_rotina x
where  x.nr_seq_rotina  = nr_seq_rotina_esp_p
and    obter_se_proc_int_lib_estab(nr_seq_exame_interno, cd_estabelecimento_p) = 'S'
and    cpoe_obter_se_proc_lib_rot(nr_atendimento_p, x.nr_seq_exame_interno, CASE WHEN coalesce(cd_setor_atendimento_p::text, '') = '' THEN  obter_cd_setor_atend_padrao(x.nr_seq_exame_interno, x.nr_sequencia, cd_estabelecimento_p, null, nr_atendimento_p)  ELSE cd_setor_atendimento_p END , nm_usuario_p, cd_perfil_p) = 'S';


BEGIN

if (ds_lista_proced_p IS NOT NULL AND ds_lista_proced_p::text <> '') then
  ds_lista_proced_w := ds_lista_proced_p;

  while (ds_lista_proced_w IS NOT NULL AND ds_lista_proced_w::text <> '') loop
    begin
    tam_lista_w      := length(ds_lista_proced_w);
    ie_pos_virgula_w    := position(';' in ds_lista_proced_w);
    ds_lista_rotina_w    := substr(ds_lista_proced_w,1,(ie_pos_virgula_w - 1));
    ie_pos_espaco_w      := position('--' in ds_lista_rotina_w);
    nr_seq_rotina_w      := (substr(ds_lista_rotina_w,1,ie_pos_espaco_w - 1))::numeric;
    ds_lista_rotina_w    := substr(ds_lista_rotina_w,ie_pos_espaco_w + 2,(ie_pos_virgula_w - (ie_pos_espaco_w + 2)));
    if (nr_seq_rotina_esp_p = nr_seq_rotina_w) then
      while (ds_lista_rotina_w IS NOT NULL AND ds_lista_rotina_w::text <> '') loop
        begin
        tam_lista2_w      := length(ds_lista_rotina_w);
        ie_pos_virgula_w    := position(',' in ds_lista_rotina_w);
        nr_seq_rotina_w      := (substr(ds_lista_rotina_w,2,(ie_pos_virgula_w - 2)))::numeric;
        ie_tipo_lista_w      := substr(ds_lista_rotina_w,1,1);
	
        if (ie_tipo_lista_w = 'L') then
	
          nr_seq_item_gerado_w := CPOE_gerar_exame_lab_rotina(  nr_atendimento_p, nr_seq_rotina_w, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, cd_setor_atendimento_p, ie_tipo_atendimento_p, cd_convenio_p, ie_tipo_convenio_p, cd_plano_convenio_p, cd_categoria_convenio_p, dt_base_proc_p, cd_paciente_p, qt_idade_dia_p, qt_idade_mes_p, qt_idade_ano_p, qt_peso_p, cd_prescritor_p, cd_setor_usuario_p, cd_medico_p, cd_especialidade_p, nr_seq_rotina_esp_p, ie_gerar_associado_p, nr_seq_item_gerado_w, nr_seq_transcricao_p, ie_item_alta_p, ie_prescritor_aux_p, ie_retrogrado_p, dt_inicio_p, nr_seq_pepo_p, nr_cirurgia_p, nr_cirurgia_patologia_p, nr_seq_agenda_p, ie_urgencia_p, ie_oncologia_p, nr_seq_conclusao_apae_p, hr_prim_hor_setor_p, ie_lado_p, nr_seq_material_exame_p, ie_futuro_p, ie_dia_seguinte_p, null, ds_dado_clinico_p, null, null, nr_seq_cpoe_order_unit_p);
        else
          nr_seq_item_gerado_w := CPOE_gerar_procedimento_rotina(  nr_atendimento_p, nr_seq_rotina_w, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, cd_setor_atendimento_p, ie_tipo_atendimento_p, cd_convenio_p, ie_tipo_convenio_p, dt_base_proc_p, cd_paciente_p, cd_paciente_p, qt_idade_dia_p, qt_idade_mes_p, qt_idade_ano_p, qt_peso_p, cd_setor_usuario_p, cd_medico_p, cd_especialidade_p, nr_seq_rotina_esp_p, ie_gerar_associado_p, nr_seq_item_gerado_w, nr_seq_transcricao_p, ie_item_alta_p, ie_prescritor_aux_p, ie_retrogrado_p, dt_inicio_p, nr_seq_pepo_p, nr_cirurgia_p, nr_cirurgia_patologia_p, nr_seq_agenda_p, ie_urgencia_p, ie_oncologia_p, nr_seq_conclusao_apae_p, hr_prim_hor_setor_p, ie_futuro_p, ie_dia_seguinte_p, ds_dado_clinico_p, null, null, nr_seq_cpoe_order_unit_p);
        end if;

        if (coalesce(nr_seq_item_gerado_p::text, '') = '') then
          nr_seq_item_gerado_p := nr_seq_item_gerado_w  || ';' || ds_prescricao_w;
        elsif (not coalesce(nr_seq_item_gerado_w::text, '') = '') then
          nr_seq_item_gerado_p := nr_seq_item_gerado_p || ',' || nr_seq_item_gerado_w  || ';' || ds_prescricao_w;
        end if;

        ds_lista_rotina_w  := substr(ds_lista_rotina_w,(ie_pos_virgula_w + 1),tam_lista2_w);
        end;
      end loop;
    end if;

    ds_lista_proced_w  := substr(ds_lista_proced_w,(ie_pos_virgula_w + 1),tam_lista_w);
    end;
  end loop;
else

  param493_w := Obter_param_Usuario(924, 493, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, param493_w);

  open c01;
  loop
  fetch c01 into
    nr_seq_rotina_w,
    ds_prescricao_w,
	nr_seq_proc_interno_w;
	
  EXIT WHEN NOT FOUND; /* apply on c01 */

  cd_setor_atendimento_w := obter_cd_setor_atend_padrao(nr_seq_proc_interno_w, nr_seq_rotina_w, cd_estabelecimento_p, null, nr_atendimento_p);

  if ((coalesce(cd_setor_atendimento_w,0) = 0) or (param493_w = 'S')) and (cd_setor_atendimento_p IS NOT NULL AND cd_setor_atendimento_p::text <> '') then
	cd_setor_atendimento_w := cd_setor_atendimento_p;
  end if;

    nr_seq_item_gerado_w := CPOE_gerar_procedimento_rotina(  nr_atendimento_p, nr_seq_rotina_w, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, coalesce(cd_setor_atendimento_w, cd_setor_atendimento_p), ie_tipo_atendimento_p, cd_convenio_p, ie_tipo_convenio_p, dt_base_proc_p, cd_paciente_p, qt_idade_dia_p, qt_idade_mes_p, qt_idade_ano_p, qt_peso_p, cd_prescritor_p, cd_setor_usuario_p, cd_medico_p, cd_especialidade_p, nr_seq_rotina_esp_p, ie_gerar_associado_p, nr_seq_item_gerado_w, nr_seq_transcricao_p, ie_item_alta_p, ie_prescritor_aux_p, ie_retrogrado_p, dt_inicio_p, nr_seq_pepo_p, nr_cirurgia_p, nr_cirurgia_patologia_p, nr_seq_agenda_p, ie_urgencia_p, ie_oncologia_p, nr_seq_conclusao_apae_p, hr_prim_hor_setor_p, null, null, null, ie_futuro_p, null, ds_dado_clinico_p, null, null, nr_seq_cpoe_order_unit_p);
  if (coalesce(nr_seq_item_gerado_p::text, '') = '') then
    nr_seq_item_gerado_p := nr_seq_item_gerado_w || ';' || ds_prescricao_w;
  elsif (not coalesce(nr_seq_item_gerado_w::text, '') = '') then
    nr_seq_item_gerado_p := nr_seq_item_gerado_p || ',' || nr_seq_item_gerado_w  || ';' || ds_prescricao_w;
  end if;

  end loop;
  close C01;

  --Gerar_Med_Mat_Assoc_rotina(nr_prescricao_p, nr_seq_rotina_esp_p, nm_usuario_p);
  open C02;
  loop
  fetch C02 into
    nr_seq_rotina_w,
    ds_prescricao_w,
	nr_seq_proc_interno_w;
  EXIT WHEN NOT FOUND; /* apply on C02 */

  cd_setor_atendimento_w := obter_cd_setor_atend_padrao(nr_seq_proc_interno_w, nr_seq_rotina_w, cd_estabelecimento_p, null, nr_atendimento_p);

  if ((coalesce(cd_setor_atendimento_w,0) = 0) or (param493_w = 'S')) and (cd_setor_atendimento_p IS NOT NULL AND cd_setor_atendimento_p::text <> '') then
	cd_setor_atendimento_w := cd_setor_atendimento_p;
  end if;

    nr_seq_item_gerado_w := CPOE_gerar_exame_lab_rotina(  nr_atendimento_p, nr_seq_rotina_w, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, coalesce(cd_setor_atendimento_w, cd_setor_atendimento_p), ie_tipo_atendimento_p, cd_convenio_p, ie_tipo_convenio_p, cd_plano_convenio_p, cd_categoria_convenio_p, dt_base_proc_p, cd_paciente_p, qt_idade_dia_p, qt_idade_mes_p, qt_idade_ano_p, qt_peso_p, cd_prescritor_p, cd_setor_usuario_p, cd_medico_p, cd_especialidade_p, nr_seq_rotina_esp_p, ie_gerar_associado_p, nr_seq_item_gerado_w, nr_seq_transcricao_p, ie_item_alta_p, ie_prescritor_aux_p, ie_retrogrado_p, dt_inicio_p, nr_seq_pepo_p, nr_cirurgia_p, nr_cirurgia_patologia_p, nr_seq_agenda_p, ie_urgencia_p, ie_oncologia_p, nr_seq_conclusao_apae_p, hr_prim_hor_setor_p, ie_lado_p, nr_seq_material_exame_p, ie_futuro_p, ie_dia_seguinte_p, null, ds_dado_clinico_p);
  if (coalesce(nr_seq_item_gerado_p::text, '') = '') then
    nr_seq_item_gerado_p := nr_seq_item_gerado_w || ';' || ds_prescricao_w;
  elsif (not coalesce(nr_seq_item_gerado_w::text, '') = '') then
    nr_seq_item_gerado_p := nr_seq_item_gerado_p || ',' || nr_seq_item_gerado_w || ';' || ds_prescricao_w;
  end if;

  end loop;
  close C02;

  ds_mat_rotina_w := CPOE_GERAR_MAT_ROTINA(nr_atendimento_p, nm_usuario_p, cd_perfil_p, nr_seq_rotina_esp_p, dt_inicio_p, cd_paciente_p, ds_mat_rotina_w);

  if (ds_mat_rotina_w IS NOT NULL AND ds_mat_rotina_w::text <> '') then
    if (coalesce(nr_seq_item_gerado_p::text, '') = '') then
      nr_seq_item_gerado_p := ds_mat_rotina_w;
    else
      nr_seq_item_gerado_p := nr_seq_item_gerado_p  || ',' || ds_mat_rotina_w;
    end if;
  end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_rotina_espec_proc ( nr_atendimento_p bigint, nr_seq_rotina_esp_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_setor_atendimento_p bigint, ie_tipo_atendimento_p bigint, cd_convenio_p bigint, ie_tipo_convenio_p bigint, cd_plano_convenio_p text, cd_categoria_convenio_p text, dt_base_proc_p timestamp, cd_paciente_p text, qt_idade_dia_p bigint, qt_idade_mes_p bigint, qt_idade_ano_p bigint, qt_peso_p bigint, cd_prescritor_p text, cd_setor_usuario_p bigint, cd_medico_p text, cd_especialidade_p bigint, ie_gerar_associado_p char, nr_seq_item_gerado_p INOUT text, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, ie_urgencia_p text default null, ie_oncologia_p text default 'N', nr_seq_conclusao_apae_p bigint default null, hr_prim_hor_setor_p text default null, ie_lado_p text default null, nr_seq_material_exame_p text default null, ie_futuro_p text default 'N', ie_dia_seguinte_p text default 'N', ds_dado_clinico_p text default null, nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) FROM PUBLIC;

