-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE nut_registrar_prod_derivado ( nr_Seq_producao_p bigint, cd_material_p bigint, cd_mat_derivado_p bigint, pr_dose_p bigint, cd_material_produzido_p bigint, nr_Seq_lote_fornec_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_item_deriv_w	bigint;
nr_Seq_item_w		bigint;

C01 CURSOR FOR
	SELECT 	d.nr_sequencia,
		a.nr_sequencia
	FROM   	nut_producao_lactario_item a,
		nut_producao_lac_item_adic d
	WHERE   a.nr_sequencia = d.nr_seq_prod_item
	AND	coalesce(a.ie_suspenso,'N') <> 'S'
	AND    	a.nr_seq_prod_lac 	= nr_Seq_producao_p
	AND	a.cd_material		= cd_material_p
	AND	d.cd_material		= cd_mat_derivado_p
	AND	coalesce(d.pr_dose,0)	= pr_dose_p
	and	coalesce(a.dt_producao::text, '') = '';

C02 CURSOR FOR
	SELECT    a.nr_sequencia
	FROM    nut_producao_lactario_item a
	WHERE  a.nr_seq_prod_lac =  nr_Seq_producao_p
	AND	   a.cd_material	 = cd_material_p
	AND	   coalesce(a.ie_suspenso,'N') <> 'S'
	AND	   NOT EXISTS (SELECT 1 FROM nut_producao_lac_item_adic d WHERE a.nr_sequencia = d.nr_seq_prod_item)
	and	coalesce(a.dt_producao::text, '') = '';


BEGIN


if (cd_mat_derivado_p IS NOT NULL AND cd_mat_derivado_p::text <> '') then

	open C01;
	loop
	fetch C01 into
		nr_seq_item_deriv_w,
		nr_Seq_item_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		update	nut_producao_lac_item_adic
		set	NR_SEQ_LOTE_FORNEC	= nr_Seq_lote_fornec_p,
			cd_material_produzido	= cd_material_produzido_p,
			nm_usuario		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp()
		where	nr_sequencia = nr_seq_item_deriv_w;

		update	nut_producao_lactario_item
		set	dt_producao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp()
		where	nr_sequencia 	= nr_Seq_item_w;

		end;
	end loop;
	close C01;
else
	open C02;
	loop
	fetch C02 into
		nr_Seq_item_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		update	nut_producao_lactario_item
		set	dt_producao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp()
		where	nr_sequencia 	= nr_Seq_item_w;

		end;
	end loop;
	close C02;


end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nut_registrar_prod_derivado ( nr_Seq_producao_p bigint, cd_material_p bigint, cd_mat_derivado_p bigint, pr_dose_p bigint, cd_material_produzido_p bigint, nr_Seq_lote_fornec_p bigint, nm_usuario_p text) FROM PUBLIC;

