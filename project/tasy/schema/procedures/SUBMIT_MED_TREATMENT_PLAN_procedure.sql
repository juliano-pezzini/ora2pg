-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE submit_med_treatment_plan ( nr_sequencia_p bigint, nm_usuario_p text ) AS $body$
DECLARE


    exists_phys_att_w  boolean := false;
    exists_disease_w   boolean := false;
    exists_counselor_w boolean := false;
    ie_counselor_required_w   med_treatment_plan_team.si_person_type%type := 'N';

    c01 CURSOR FOR
    SELECT si_person_type AS type_rec
      FROM med_treatment_plan_team
     WHERE nr_seq_med_treat_plan = nr_sequencia_p
       AND si_person_type = '1'

UNION ALL

    SELECT '99' AS type_rec
      FROM med_treatment_plan_disease
    WHERE nr_seq_med_treat_plan = nr_sequencia_p
    
UNION ALL

    SELECT '100' AS type_rec
      FROM med_treatment_plan_team
    WHERE nr_seq_med_treat_plan = nr_sequencia_p
    AND si_person_type = '6';

BEGIN
    select CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END
    into STRICT ie_counselor_required_w
    FROM med_treatment_plan
    WHERE nr_sequencia = nr_sequencia_p
    AND SI_TYPE_FORM = '3';

    FOR r01 IN c01 LOOP
        CASE r01.type_rec
            WHEN 1 THEN
                exists_phys_att_w := true;
            WHEN 99 THEN
                exists_disease_w := true;
            WHEN 100 THEN
                exists_counselor_w := true;
        END CASE;
    END LOOP;

    IF (( exists_phys_att_w = false and ie_counselor_required_w = 'N' ) OR ( exists_disease_w = false  and ie_counselor_required_w = 'N'))THEN
        CALL wheb_mensagem_pck.exibir_mensagem_abort(1142103);
    END IF;

    IF ( exists_counselor_w = false and ie_counselor_required_w = 'S' )THEN
        CALL wheb_mensagem_pck.exibir_mensagem_abort(1192407);
    END IF;

    UPDATE med_treatment_plan
    SET
        dt_liberacao = clock_timestamp(),
        nm_usuario_liberacao = nm_usuario_p
    WHERE
        nr_sequencia = nr_sequencia_p;

    COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE submit_med_treatment_plan ( nr_sequencia_p bigint, nm_usuario_p text ) FROM PUBLIC;

