-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_gerar_tabelas_intercambio ( nr_seq_inter_plano_p bigint, nr_seq_empresa_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nm_tabela_w			varchar(255);
ie_tipo_contratacao_w		varchar(10);
ie_regulamentacao_w		varchar(10);
cd_plano_intercambio_w		varchar(10);
ie_valor_acomodacao_w		varchar(10);	
ie_grau_titularidade_w		varchar(2);
vl_preco_tabela_w		double precision;
nr_seq_intercambio_w		bigint;
nr_seq_plano_w			bigint;
nr_seq_ptu_inter_plano_w	bigint;
nr_seq_regra_tab_inter_w	bigint;
nr_seq_tabela_intercambio_w	bigint;
nr_seq_tabela_w			bigint;
qt_registros_w			bigint;
qt_idade_inicial_w		bigint;
qt_idade_final_w		bigint;
nr_seq_grupo_intercambio_w	bigint;
dt_contrato_w			timestamp;
ie_acomodacao_w			varchar(10);
nm_estipulante_w		varchar(80);

C01 CURSOR FOR 
	SELECT	nr_sequencia 
	from	pls_regra_tabela_interc 
	where	cd_estabelecimento	= cd_estabelecimento_p 
	and	((ie_tipo_contratacao	= ie_tipo_contratacao_w and (ie_tipo_contratacao IS NOT NULL AND ie_tipo_contratacao::text <> '')) or (coalesce(ie_tipo_contratacao::text, '') = '')) 
	and	((ie_regulamentacao	= ie_regulamentacao_w and (ie_regulamentacao IS NOT NULL AND ie_regulamentacao::text <> '')) or (coalesce(ie_regulamentacao::text, '') = '')) 
	and	((ie_tipo_data		= 'E' and dt_contrato_w between coalesce(dt_referencia_inicial,dt_contrato_w) and coalesce(dt_referencia_final,dt_contrato_w)) or (ie_tipo_data		= 'N')) 
	and	((ie_acomodacao		= ie_acomodacao_w) or (ie_acomodacao = 'T')) 
	and	((nr_seq_grupo_intercambio = nr_seq_grupo_intercambio_w) or (coalesce(nr_seq_grupo_intercambio::text, '') = '')) 
	order by 
		coalesce(ie_tipo_contratacao,'-1'), 
		coalesce(ie_regulamentacao,-1), 
		CASE WHEN coalesce(nr_seq_grupo_intercambio::text, '') = '' THEN -1  ELSE 1 END;

C02 CURSOR FOR 
	SELECT	qt_idade_inicial, 
		qt_idade_final, 
		CASE WHEN ie_valor_acomodacao_w='A' THEN vl_preco_inicial WHEN ie_valor_acomodacao_w='E' THEN vl_preco_inicial_enf END , 
		ie_grau_titularidade 
	from	ptu_tabela_inter_preco 
	where	nr_seq_tabela	= nr_seq_tabela_intercambio_w 
	order by 
		qt_idade_inicial;


BEGIN 
select	nr_seq_intercambio, 
	nr_seq_plano 
into STRICT	nr_seq_intercambio_w, 
	nr_seq_plano_w 
from	pls_intercambio_plano 
where	nr_sequencia	= nr_seq_inter_plano_p;
 
select	dt_inclusao, 
	nr_seq_grupo_intercambio, 
	substr(obter_nome_pf_pj(cd_pessoa_fisica,cd_cgc),1,80) 
into STRICT	dt_contrato_w, 
	nr_seq_grupo_intercambio_w, 
	nm_estipulante_w 
from	pls_intercambio 
where	nr_sequencia	= nr_seq_intercambio_w;
 
select	ie_tipo_contratacao, 
	ie_regulamentacao, 
	cd_plano_intercambio, 
	CASE WHEN ie_acomodacao='I' THEN 'A' WHEN ie_acomodacao='C' THEN 'E'  ELSE 'N' END  
into STRICT	ie_tipo_contratacao_w, 
	ie_regulamentacao_w, 
	cd_plano_intercambio_w, 
	ie_acomodacao_w 
from	pls_plano 
where	nr_sequencia	= nr_seq_plano_w;
 
/*Caso não existiro tipo de contratação do produto, busca no A100*/
 
if (coalesce(ie_tipo_contratacao_w::text, '') = '') then 
	select	max(nr_sequencia) 
	into STRICT	nr_seq_ptu_inter_plano_w 
	from	ptu_intercambio_plano 
	where	nr_seq_empresa		= nr_seq_empresa_p 
	and	cd_plano_intercambio	= cd_plano_intercambio_w;
	 
	if (nr_seq_ptu_inter_plano_w IS NOT NULL AND nr_seq_ptu_inter_plano_w::text <> '') then 
		select	CASE WHEN ie_natureza=2 THEN 'I' WHEN ie_natureza=3 THEN 'CE' WHEN ie_natureza=4 THEN 'CA' END  
		into STRICT	ie_tipo_contratacao_w 
		from	ptu_intercambio_plano 
		where	nr_sequencia	= nr_seq_ptu_inter_plano_w;
	end if;
end if;
	 
open C01;
loop 
fetch C01 into	 
	nr_seq_regra_tab_inter_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
end loop;
close C01;
 
if (nr_seq_regra_tab_inter_w IS NOT NULL AND nr_seq_regra_tab_inter_w::text <> '') then 
	select	nr_seq_tabela_interc, 
		ie_valor_acomodacao 
	into STRICT	nr_seq_tabela_intercambio_w, 
		ie_valor_acomodacao_w 
	from	pls_regra_tabela_interc 
	where	nr_sequencia	= nr_seq_regra_tab_inter_w;
	 
	nm_tabela_w	:= substr(pls_obter_desc_tabela_inter(nr_seq_tabela_intercambio_w),1,124);
	 
	nm_tabela_w	:= substr(nm_tabela_w || ' - Tabela para o contrato de intercâmbio ' || to_char(nr_seq_intercambio_w) || ' - ' || nm_estipulante_w,1,255);
	 
	select	nextval('pls_tabela_preco_seq') 
	into STRICT	nr_seq_tabela_w 
	;
	 
	insert into pls_tabela_preco(nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nm_tabela, 
		dt_inicio_vigencia, 
		nr_seq_plano, 
		dt_liberacao, 
		ie_tabela_base, 
		ie_preco_vidas_contrato, 
		ie_calculo_vidas, 
		nr_seq_tabela_interc, 
		nr_seq_contrato_inter) 
	values (nr_seq_tabela_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nm_tabela_w, 
		dt_contrato_w, 
		nr_seq_plano_w, 
		clock_timestamp(), 
		'N', 
		'N', 
		'N', 
		nr_seq_tabela_intercambio_w, 
		nr_seq_intercambio_w);
			 
	open C02;
	loop 
	fetch C02 into	 
		qt_idade_inicial_w, 
		qt_idade_final_w, 
		vl_preco_tabela_w, 
		ie_grau_titularidade_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		insert into pls_plano_preco(nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			nr_seq_tabela, 
			qt_idade_inicial, 
			qt_idade_final, 
			vl_preco_inicial, 
			vl_preco_atual, 
			vl_minimo, 
			tx_acrescimo, 
			ie_grau_titularidade) 
		values (nextval('pls_plano_preco_seq'), 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			nr_seq_tabela_w, 
			qt_idade_inicial_w, 
			qt_idade_final_w, 
			vl_preco_tabela_w, 
			vl_preco_tabela_w, 
			0, 
			0, 
			ie_grau_titularidade_w);
		end;
	end loop;
	close C02;	
 
	if (nr_seq_tabela_w IS NOT NULL AND nr_seq_tabela_w::text <> '') then 
		update	pls_intercambio_plano 
		set	nr_seq_tabela	= nr_seq_tabela_w 
		where	nr_sequencia	= nr_seq_inter_plano_p;
		 
		/*aaschlote 25/05/2012 - Sistema vai criar a tabela para o contrato de intercâmbio acima 
		pls_gerar_tabela_intercambio(nr_seq_intercambio_w,nr_seq_plano_w,nr_seq_tabela_w,cd_estabelecimento_p,nm_usuario_p,'N'); 
		*/
 
	end if;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_gerar_tabelas_intercambio ( nr_seq_inter_plano_p bigint, nr_seq_empresa_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

