-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_solic_hemocomponente (nr_sequencia_p bigint, nr_seq_derivado_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE


ie_hemoglobina_w	varchar(1);
ie_hematocrito_w	varchar(1);
ie_plaquetas_w		varchar(1);
ie_tap_w		varchar(1);
ie_inr_w		varchar(1);
ie_consiste_ambos_w	varchar(1);
ie_obriga_albumina_w	varchar(1);
ie_obriga_calcio_w	varchar(1);
ie_obriga_magnesio_w	varchar(1);
ie_obriga_bili_dir_w	varchar(1);
ie_obriga_bili_ind_w	varchar(1);
ds_coagulopatia_w	varchar(255);
ie_consiste_programado_w	varchar(1);
ie_obriga_hemoglobina_s_w varchar(1);
ie_obriga_coombs_w	varchar(1);
ie_obriga_coagulopatia_w	varchar(1);

qt_plaqueta_w		bigint;
qt_hemoglobina_w	double precision;
qt_tap_w		double precision;
qt_tap_inr_w		double precision;
qt_fibrinogenio_w		double precision;
qt_hematocrito_w	double precision;
qt_ttpa_w		double precision;
qt_ttpa_rel_w		double precision;
ie_tipo_w		bigint;
ie_consiste_extrema_w	varchar(2);
cd_setor_regra_w	integer;
cd_setor_atendimento_w	integer;
ie_consistir_w		varchar(1);
ie_fibrinogenio_w	varchar(10);
nr_prescricao_w		bigint;
count_w			bigint;
ds_erro_w		varchar(2000) := '';
qt_albumina_w		double precision;
qt_calcio_w		double precision;
qt_magnesio_w		double precision;
qt_bilirrubina_dir_w	double precision;
qt_bilirrubina_ind_w	double precision;
qt_hemoglobina_s_w	double precision;
ie_coombs_direto_w	varchar(15);
ie_consiste_urgencia_w	varchar(2);
ie_obriga_ttpa_w	varchar(1);
ie_obriga_ttpa_rel_w	varchar(1);
cd_perfil_w				integer := obter_Perfil_ativo;
ie_consiste_reserva_w	varchar(1);
ie_reserva_w			varchar(1);

c01 CURSOR FOR
SELECT	cd_setor_atendimento,
	coalesce(ie_consistir,'S')
from	regra_san_derivado_setor b,
	san_derivado a
where	a.nr_sequencia 		= b.nr_seq_derivado
and	a.nr_sequencia 		= nr_seq_derivado_p
and	cd_setor_atendimento 	= cd_setor_atendimento_w;


BEGIN

ie_consiste_extrema_w := Obter_Param_Usuario(924, 343, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ie_consiste_extrema_w);
ie_consiste_urgencia_w := Obter_Param_Usuario(924, 632, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ie_consiste_urgencia_w);
ie_consiste_programado_w := Obter_Param_Usuario(924, 942, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ie_consiste_programado_w);
ie_consiste_reserva_w := Obter_Param_Usuario(924, 1111, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ie_consiste_reserva_w);

select	coalesce(max(ie_hemoglobina),'N'),
	coalesce(max(ie_hematocrito),'N'),
	coalesce(max(ie_plaquetas),'N'),
	coalesce(max(ie_tap),'N'),
	coalesce(max(ie_inr),'N'),
	coalesce(max(ie_fibrinogenio),'N'),
	coalesce(max(IE_OBRIGA_AMBOS),'N'),
	coalesce(max(ie_obriga_albumina),'N'),
	coalesce(max(ie_obriga_calcio),'N'),
	coalesce(max(ie_obriga_magnesio),'N'),
	coalesce(max(ie_obriga_bili_dir),'N'),
	coalesce(max(ie_obriga_bili_ind),'N'),
	coalesce(max(ie_obriga_hemoglobina_s),'N'),
	coalesce(max(ie_obriga_coombs),'N'),
	coalesce(max(ie_obriga_coagulopatia),'N'),
	coalesce(max(ie_obriga_ttpa),'N')
into STRICT	ie_hemoglobina_w,
	ie_hematocrito_w,
	ie_plaquetas_w,
	ie_tap_w,
	ie_inr_w,
	ie_fibrinogenio_w,
	ie_consiste_ambos_w,
	ie_obriga_albumina_w,
	ie_obriga_calcio_w,
	ie_obriga_magnesio_w,
	ie_obriga_bili_dir_w,
	ie_obriga_bili_ind_w,
	ie_obriga_hemoglobina_s_w,
	ie_obriga_coombs_w,
	ie_obriga_coagulopatia_w,
	ie_obriga_ttpa_w
from	san_derivado
where	nr_sequencia	= nr_seq_derivado_p;

begin
select	nr_prescricao,
	qt_plaqueta,
	qt_hemoglobina,
	qt_tap,
	qt_tap_inr,
	qt_hematocrito,
	ie_tipo,
	qt_ttpa,
	qt_fibrinogenio,
	qt_albumina,
	qt_calcio,
	qt_magnesio,
	qt_bilirrubina_dir,
	qt_bilirrubina_ind,
	qt_hemoglobina_s,
	ie_coombs_direto,
	ds_coagulopatia,
	qt_ttpa_rel,
	ie_reserva
into STRICT	nr_prescricao_w,
	qt_plaqueta_w,
	qt_hemoglobina_w,
	qt_tap_w,
	qt_tap_inr_w,
	qt_hematocrito_w,
	ie_tipo_w,
	qt_ttpa_w,
	qt_fibrinogenio_w,
	qt_albumina_w,
	qt_calcio_w,
	qt_magnesio_w,
	qt_bilirrubina_dir_w,
	qt_bilirrubina_ind_w,
	qt_hemoglobina_s_w,
	ie_coombs_direto_w,
	ds_coagulopatia_w,
	qt_ttpa_rel_w,
	ie_reserva_w
from	prescr_solic_bco_sangue
where	nr_sequencia	= nr_sequencia_p;
exception
when others then
	qt_plaqueta_w		:= null;
	qt_hemoglobina_w	:= null;
	qt_tap_w		:= null;
	qt_tap_inr_w		:= null;
	qt_hematocrito_w	:= null;
	qt_ttpa_w		:= null;
end;

if	((ie_tipo_w <> 1) or (ie_consiste_programado_w = 'S')) and
	((ie_consiste_extrema_w	= 'S') or (ie_tipo_w		<> 4)) and
	((ie_consiste_urgencia_w = 'S') or (ie_tipo_w		<> 3))  then
	begin

	select	max(cd_setor_atendimento)
	into STRICT	cd_setor_atendimento_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_w;

	select	coalesce(count(*),0)
	into STRICT	count_w
	from	regra_san_derivado_setor b,
		san_derivado a
	where	a.nr_sequencia 		= b.nr_seq_derivado
	and	a.nr_sequencia 		= nr_seq_derivado_p
	and	b.cd_setor_atendimento 	= cd_setor_atendimento_w;

	if (count_w > 0) then

		open C01;
		loop
		fetch C01 into
			cd_setor_regra_w,
			ie_consistir_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin

			if (ie_consistir_w = 'S') then

				if (ie_hemoglobina_w = 'S') and
					((coalesce(ie_reserva_w,'N') = 'N') or (ie_consiste_reserva_w = 'S')) and (coalesce(qt_hemoglobina_w::text, '') = '') then
					ds_erro_w	:= wheb_mensagem_pck.get_texto(278266);
				end if;

				if (ie_hematocrito_w = 'S') and
					((coalesce(ie_reserva_w,'N') = 'N') or (ie_consiste_reserva_w = 'S')) and (coalesce(qt_hematocrito_w::text, '') = '') then
					ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(278267);
				end if;

				if (ie_plaquetas_w = 'S') and
					((coalesce(ie_reserva_w,'N') = 'N') or (ie_consiste_reserva_w = 'S')) and (coalesce(qt_plaqueta_w::text, '') = '') then
					ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(278268);
				end if;

				if (ie_fibrinogenio_w = 'S') and
					((coalesce(ie_reserva_w,'N') = 'N') or (ie_consiste_reserva_w = 'S')) and (coalesce(qt_fibrinogenio_w::text, '') = '') then
					ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(278269);
				end if;

				if (ie_obriga_albumina_w = 'S') and (coalesce(qt_albumina_w::text, '') = '') then
					ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(278270);
				end if;

				if (ie_obriga_calcio_w = 'S') and (coalesce(qt_calcio_w::text, '') = '') then
					ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(278271);
				end if;

				if (ie_obriga_magnesio_w = 'S') and (coalesce(qt_magnesio_w::text, '') = '') then
					ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(278273);
				end if;

				if (ie_obriga_bili_dir_w = 'S') and (coalesce(qt_bilirrubina_dir_w::text, '') = '') then
					ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(278277);
				end if;

				if (ie_obriga_bili_ind_w = 'S') and (coalesce(qt_bilirrubina_ind_w::text, '') = '') then
					ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(278280);
				end if;

				if (ie_obriga_hemoglobina_s_w = 'S') and (coalesce(qt_hemoglobina_s_w::text, '') = '') then
					ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(278284);
				end if;

				if (ie_obriga_coombs_w = 'S') and (coalesce(ie_coombs_direto_w::text, '') = '') then
					ds_erro_w	:= ds_erro_w || chr(13) || chr(10) ||wheb_mensagem_pck.get_texto(278287);
				end if;

				if (ie_obriga_coagulopatia_w = 'S') and (coalesce(ds_coagulopatia_w::text, '') = '') then
					ds_erro_w	:= ds_erro_w || chr(13) || chr(10) ||wheb_mensagem_pck.get_texto(278289);
				end if;

				if (ie_consiste_ambos_w = 'S') and
					((coalesce(ie_reserva_w,'N') = 'N') or (ie_consiste_reserva_w = 'S')) and (coalesce(qt_hematocrito_w::text, '') = '') and (coalesce(qt_hemoglobina_w::text, '') = '') then
					ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(278293);
				end if;

				/*
				if	(((ie_tap_w = 'S') and
					  (qt_tap_w is null) and
					  (qt_tap_inr_w is null) and
					  (qt_ttpa_w is null) and
					  (qt_ttpa_rel_w is null)) or
					 ((ie_inr_w = 'S') and
					  (qt_tap_inr_w is null))) then
					ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(278295);
				end if;
				*/
				if (ie_obriga_ttpa_w = 'S') and
					((coalesce(qt_ttpa_w::text, '') = '') or (coalesce(qt_ttpa_rel_w::text, '') = '')) then
					ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(292785);
				end if;

				if (ie_tap_w = 'S') and
					((coalesce(ie_reserva_w,'N') = 'N') or (ie_consiste_reserva_w = 'S')) and (coalesce(qt_tap_w::text, '') = '') then
					ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(292850);
				end if;


				if (ie_inr_w = 'S') and
					((coalesce(ie_reserva_w,'N') = 'N') or (ie_consiste_reserva_w = 'S')) and (coalesce(qt_tap_inr_w::text, '') = '') then
					ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(292851);
				end if;

				if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
					ds_erro_w	:= wheb_mensagem_pck.get_texto(278297) || ds_erro_w;
				end if;
			end if;

			end;
		end loop;
		close C01;

	else

		if (ie_hemoglobina_w = 'S') and
			((coalesce(ie_reserva_w,'N') = 'N') or (ie_consiste_reserva_w = 'S')) and (coalesce(qt_hemoglobina_w::text, '') = '') then
			ds_erro_w	:= wheb_mensagem_pck.get_texto(278266);
		end if;

		if (ie_hematocrito_w = 'S') and
			((coalesce(ie_reserva_w,'N') = 'N') or (ie_consiste_reserva_w = 'S')) and (coalesce(qt_hematocrito_w::text, '') = '') then
			ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(278267);
		end if;

		if (ie_plaquetas_w = 'S') and (coalesce(qt_plaqueta_w::text, '') = '') then
			ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(278268);
		end if;

		if (ie_fibrinogenio_w = 'S') and
			((coalesce(ie_reserva_w,'N') = 'N') or (ie_consiste_reserva_w = 'S')) and (coalesce(qt_fibrinogenio_w::text, '') = '') then
			ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(278269);
		end if;

		if (ie_obriga_albumina_w = 'S') and (coalesce(qt_albumina_w::text, '') = '') then
			ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(278270);
		end if;

		if (ie_obriga_calcio_w = 'S') and (coalesce(qt_calcio_w::text, '') = '') then
			ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(278271);
		end if;

		if (ie_obriga_magnesio_w = 'S') and (coalesce(qt_magnesio_w::text, '') = '') then
			ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(278273);
		end if;

		if (ie_obriga_bili_dir_w = 'S') and (coalesce(qt_bilirrubina_dir_w::text, '') = '') then
			ds_erro_w	:= ds_erro_w || chr(13) || chr(10) ||wheb_mensagem_pck.get_texto(278277);
		end if;

		if (ie_obriga_bili_ind_w = 'S') and (coalesce(qt_bilirrubina_ind_w::text, '') = '') then
			ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(278280);
		end if;

		if (ie_obriga_hemoglobina_s_w = 'S') and
			((coalesce(ie_reserva_w,'N') = 'N') or (ie_consiste_reserva_w = 'S')) and (coalesce(qt_hemoglobina_s_w::text, '') = '') then
			ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(278284);
		end if;

		if (ie_obriga_coombs_w = 'S') and (coalesce(ie_coombs_direto_w::text, '') = '') then
			ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(278287);
		end if;

		if (ie_obriga_coagulopatia_w = 'S') and (coalesce(DS_COAGULOPATIA_w::text, '') = '') then
			ds_erro_w	:= ds_erro_w|| chr(13) || chr(10) || wheb_mensagem_pck.get_texto(278289);
		end if;

		if (ie_consiste_ambos_w = 'S') and
			((coalesce(ie_reserva_w,'N') = 'N') or (ie_consiste_reserva_w = 'S')) and (coalesce(qt_hematocrito_w::text, '') = '') and (coalesce(qt_hemoglobina_w::text, '') = '') then
			ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(278293);
		end if;
		--
		if (ie_obriga_ttpa_w = 'S') and
			((coalesce(qt_ttpa_w::text, '') = '') or (coalesce(qt_ttpa_rel_w::text, '') = '')) then
			ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(292785);
		end if;

		if (ie_tap_w = 'S') and
			((coalesce(ie_reserva_w,'N') = 'N') or (ie_consiste_reserva_w = 'S')) and (coalesce(qt_tap_w::text, '') = '') then
			ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(292850);
		end if;

		if (ie_inr_w = 'S') and
			((coalesce(ie_reserva_w,'N') = 'N') or (ie_consiste_reserva_w = 'S')) and (coalesce(qt_tap_inr_w::text, '') = '') then
			ds_erro_w	:= ds_erro_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(292851);
		end if;
		--
/*
		if	(((ie_tap_w = 'S') and
			  (qt_tap_w is null) and
			  (qt_tap_inr_w is null) and
			  (qt_ttpa_w is null) and
			  (qt_ttpa_rel_w is null)) or
			 ((ie_inr_w = 'S') and
			  (qt_tap_inr_w is null))) then
			ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(278295);
		end if;*/
		if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
			ds_erro_w	:= wheb_mensagem_pck.get_texto(278297) || ds_erro_w;
		end if;

	end if;

	end;

end if;

ds_erro_p	:= SUBSTR(ds_erro_w,1,510);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_solic_hemocomponente (nr_sequencia_p bigint, nr_seq_derivado_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

