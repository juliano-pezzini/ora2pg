-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qua_gerar_os_nao_conform_causa ( nr_seq_causa_p bigint, ds_dano_breve_p text, ds_dano_p text, nr_seq_ordem_serv_p INOUT bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_nao_conform_w		bigint;
nm_usuario_resp_w		varchar(15);
cd_pessoa_solic_w		varchar(10);
ie_tipo_ordem_w			integer;
ds_dano_breve_w			varchar(80);
ds_dano_w			varchar(4000);
nr_seq_classif_nao_conform_w	bigint;


BEGIN

ds_dano_w		:= substr(ds_dano_p,1,4000);
ds_dano_breve_w		:= substr(ds_dano_breve_p,1,80);

select	nr_seq_nao_conform,
	substr(obter_usuario_pessoa(cd_responsavel),1,15)
into STRICT	nr_seq_nao_conform_w,
	nm_usuario_resp_w
from	qua_nao_conform_causa
where	nr_sequencia = nr_seq_causa_p;

select	max(nr_seq_classificacao)
into STRICT	nr_seq_classif_nao_conform_w
from	qua_nao_conformidade
where	nr_sequencia = nr_seq_nao_conform_w;

select	cd_pessoa_fisica
into STRICT	cd_pessoa_solic_w
from	usuario
where	nm_usuario = nm_usuario_p;

select	nextval('man_ordem_servico_seq')
into STRICT	nr_seq_ordem_serv_p
;

ie_tipo_ordem_w := obter_param_usuario(4000, 202, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_tipo_ordem_w);

insert	into man_ordem_servico(
	nr_sequencia,
	cd_pessoa_solicitante,
	ds_dano,
	ds_dano_breve,
	dt_atualizacao,
	dt_ordem_servico,
	ie_classificacao,
	ie_classificacao_cliente,
	ie_origem_os,
	ie_parado,
	ie_prioridade,
	ie_status_ordem,
	ie_tipo_ordem,
	nm_usuario,
	nr_seq_nao_conform,
	nr_seq_classif_nao_conform)
values (	nr_seq_ordem_serv_p,
	cd_pessoa_solic_w,
	ds_dano_w,
	ds_dano_breve_w,
	clock_timestamp(),
	clock_timestamp(),
	'S',
	'S',
	'6',
	'N',
	'M',
	'1',
	ie_tipo_ordem_w,
	nm_usuario_p,
	nr_seq_nao_conform_w,
	nr_seq_classif_nao_conform_w);

if (nm_usuario_resp_w <> '') then
	insert into man_ordem_servico_exec(	nr_sequencia,
					nr_seq_ordem,
					dt_atualizacao,
					nm_usuario,
					nm_usuario_exec)
				values (	nextval('man_ordem_servico_exec_seq'),
					nr_seq_ordem_serv_p,
					clock_timestamp(),
					nm_usuario_p,
					nm_usuario_resp_w);
end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qua_gerar_os_nao_conform_causa ( nr_seq_causa_p bigint, ds_dano_breve_p text, ds_dano_p text, nr_seq_ordem_serv_p INOUT bigint, nm_usuario_p text) FROM PUBLIC;

