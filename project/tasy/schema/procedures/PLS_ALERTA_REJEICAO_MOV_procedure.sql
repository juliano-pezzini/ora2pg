-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alerta_rejeicao_mov ( nr_seq_segurado_p bigint, nr_seq_inclusao_benef_p bigint, nr_seq_contrato_p bigint, ie_tipo_solicitacao_p bigint, nr_seq_solicitacao_p bigint, nm_usuario_p text) AS $body$
DECLARE

			
ie_situacao_w			pls_regra_geracao_evento.ie_situacao%type;
nr_seq_evento_mens_w		pls_regra_geracao_evento.nr_seq_evento_mens%type;
nr_sequencia_w			pls_regra_geracao_evento.nr_sequencia%type;
ie_tipo_envio_w			pls_alerta_evento_mensagem.ie_tipo_envio%type;
ds_titulo_w			pls_alerta_evento_mensagem.ds_titulo%type;
nr_seq_tipo_evento_w		pls_alerta_evento_mensagem.nr_seq_tipo_evento%type;
ds_remetente_email_w		pls_alerta_evento_mensagem.ds_remetente_email%type;
ie_forma_envio_w		pls_alerta_evento_destino.ie_forma_envio%type;
nr_seq_evento_dest_w		pls_alerta_evento_destino.nr_sequencia%type;
ie_tipo_pessoa_dest_w		pls_alerta_evento_destino.ie_tipo_pessoa_dest%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
ie_situacao_regra_dest_w	pls_alerta_evento_destino.ie_situacao%type;
nr_seq_evento_controle_w	bigint	:= null;
nm_beneficiario_w		varchar(70);
cd_usuario_plano_w		varchar(30);
dt_rescisao_w			varchar(30)	:= null;
nm_usuario_destino_definit_w	varchar(4000);	
nm_usuarios_lista_w		varchar(4000);
ds_mensagem_regra_w		varchar(4000);
ds_email_w			varchar(255);
nr_pos_virgula_w		integer;
qt_macro_regra_w		integer;
nm_usuario_destino_w		varchar(15);
cd_pessoa_fisica_w		varchar(10);
cd_estipulante_w		varchar(80);
ds_estipulante_w		varchar(255);
ds_tipo_solicitacao_w		varchar(80);
nm_usuario_w			pls_inclusao_beneficiario.nm_usuario%type;

C01 CURSOR FOR
	SELECT  nr_seq_evento_mens,
		nr_sequencia
	from	pls_regra_geracao_evento
	where	ie_situacao 			= 'A'
	and	ie_evento_disparo 		= 13;
	
C02 CURSOR FOR
	SELECT	nr_sequencia,
		ie_forma_envio,
		ie_tipo_pessoa_dest
	from	pls_alerta_evento_destino
	where	nr_seq_evento_mens	= nr_seq_evento_mens_w
	and	ie_situacao 		= 'A';
	

BEGIN
if	((coalesce(nr_seq_inclusao_benef_p::text, '') = '') and (coalesce(nr_seq_contrato_p::text, '') = '')) then
	select 	substr(pls_obter_dados_segurado(nr_seq_segurado_p, 'N'),1,70),
		substr(pls_obter_dados_segurado(nr_seq_segurado_p,'CR'),1,20),
		to_char(dt_rescisao,'dd/mm/yyyy')dt_rescisao,
		cd_estabelecimento,
		cd_pessoa_fisica,
		substr(pls_obter_dados_segurado(nr_seq_segurado_p, 'ES'),1,80),
		substr(pls_obter_dados_segurado(nr_seq_segurado_p, 'CE'),1,80)		
	into STRICT	nm_beneficiario_w,
		cd_usuario_plano_w,
		dt_rescisao_w,
		cd_estabelecimento_w,
		cd_pessoa_fisica_w,
		ds_estipulante_w,
		cd_estipulante_w
	from 	pls_segurado
	where 	nr_sequencia 	= nr_seq_segurado_p;	
elsif	((coalesce(nr_seq_contrato_p::text, '') = '') and (coalesce(nr_seq_segurado_p::text, '') = '')) then
	select 	nm_pessoa_fisica,
		cd_pessoa_fisica,
		cd_estabelecimento,
		pls_obter_dados_contrato(nr_seq_contrato,'E'),
		pls_obter_dados_contrato(nr_seq_contrato,'C'),
		upper(nm_usuario_nrec)
	into STRICT	nm_beneficiario_w,
		cd_pessoa_fisica_w,
		cd_estabelecimento_w,
		ds_estipulante_w,
		cd_estipulante_w,
		nm_usuario_w
	from   	pls_inclusao_beneficiario
	where	nr_sequencia	= nr_seq_inclusao_benef_p;
elsif	((coalesce(nr_seq_inclusao_benef_p::text, '') = '') and (coalesce(nr_seq_segurado_p::text, '') = '')) then
	select 	cd_estabelecimento,
		pls_obter_dados_contrato(nr_sequencia,'E'),
		pls_obter_dados_contrato(nr_sequencia,'C')
	into STRICT	cd_estabelecimento_w,
		ds_estipulante_w,
		cd_estipulante_w
	from   	pls_contrato
	where	nr_sequencia	= nr_seq_contrato_p;	
end if;

if (ie_tipo_solicitacao_p = 1) then
	ds_tipo_solicitacao_w := wheb_mensagem_pck.get_texto(1167826);
elsif (ie_tipo_solicitacao_p = 2) then
	ds_tipo_solicitacao_w := wheb_mensagem_pck.get_texto(1167827);
elsif (ie_tipo_solicitacao_p = 3) then
	ds_tipo_solicitacao_w := wheb_mensagem_pck.get_texto(1167828);
elsif (ie_tipo_solicitacao_p = 4) then
	ds_tipo_solicitacao_w := wheb_mensagem_pck.get_texto(1167829);	
end if;	

open C01;
	loop
	fetch C01 into	
		nr_seq_evento_mens_w,
		nr_sequencia_w;	
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		select	ds_mensagem,
			ie_tipo_envio,
			ds_titulo,
			nr_seq_tipo_evento,
			ds_remetente_email
		into STRICT	ds_mensagem_regra_w,
			ie_tipo_envio_w,
			ds_titulo_w,
			nr_seq_tipo_evento_w,
			ds_remetente_email_w
		from	pls_alerta_evento_mensagem
		where 	nr_sequencia	= nr_seq_evento_mens_w;
		exception
		when others then
			ds_mensagem_regra_w	:= null;
			ie_tipo_envio_w		:= null;
			ds_titulo_w		:= null;
			nr_seq_tipo_evento_w	:= null;
		end;			
		if (ie_tipo_envio_w = 'AE') then
			open C02;
			loop
			fetch C02 into
				nr_seq_evento_dest_w,  		
				ie_forma_envio_w,
				ie_tipo_pessoa_dest_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin
				if (ie_forma_envio_w = 'EM') and (ie_tipo_pessoa_dest_w = 'ES') then
					if (coalesce(nr_seq_evento_controle_w::text, '') = '') then		
						select	nextval('pls_alerta_evento_controle_seq')
						into STRICT	nr_seq_evento_controle_w
						;
							
						insert into pls_alerta_evento_controle(nr_sequencia,
							dt_geracao_evento,
							ie_evento_disparo,
							nr_seq_tipo_evento,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							ds_mensagem,
							ds_titulo,
							ie_tipo_envio)
						values (nr_seq_evento_controle_w,
							clock_timestamp(),
							13,
							nr_seq_tipo_evento_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							ds_mensagem_regra_w,
							ds_titulo_w,
							ie_tipo_envio_w);
					end if;	
						
					select	count(1)
					into STRICT	qt_macro_regra_w
					
					where	ds_mensagem_regra_w like '%@%';
						
					if (qt_macro_regra_w > 0) then
						ds_mensagem_regra_w	:= substr(replace_macro(ds_mensagem_regra_w, '@BENEFICIARIO', nm_beneficiario_w), 1, 4000);
						ds_mensagem_regra_w	:= substr(replace_macro(ds_mensagem_regra_w, '@CARTEIRA_BENEFICIARIO', cd_usuario_plano_w), 1, 4000);
						ds_mensagem_regra_w	:= substr(replace_macro(ds_mensagem_regra_w, '@CD_ESTIPULANTE', cd_estipulante_w), 1, 4000);
						ds_mensagem_regra_w	:= substr(replace_macro(ds_mensagem_regra_w, '@DS_ESTIPULANTE', ds_estipulante_w), 1, 4000);
						ds_mensagem_regra_w	:= substr(replace_macro(ds_mensagem_regra_w, '@TIPO_SOLICITACAO_PORTAL', ds_tipo_solicitacao_w), 1, 4000);
						ds_mensagem_regra_w	:= substr(replace_macro(ds_mensagem_regra_w, '@NUMERO_SOLIC_PORTAL', nr_seq_solicitacao_p), 1, 4000);
					end if;		
					
					if (ie_tipo_solicitacao_p = 4) then
						select upper(nm_usuario_nrec)
						into STRICT	nm_usuario_w
						from 	pls_rescisao_contrato
						where	nr_sequencia = nr_seq_solicitacao_p;
					elsif (ie_tipo_solicitacao_p = 3) then
						select upper(nm_usuario_nrec)
						into STRICT	nm_usuario_w
						from 	tasy_solic_alteracao
						where 	nr_sequencia = nr_seq_solicitacao_p;	
					elsif (ie_tipo_solicitacao_p = 2) then
						select 	upper(nm_usuario_nrec)
						into STRICT	nm_usuario_w
						from	pls_segurado_solic_alt
						where 	nr_sequencia = nr_seq_solicitacao_p;
					end if;
					
					select 	max(ds_email)
					into STRICT	ds_email_w
					from 	pls_estipulante_web
					where 	upper(nm_usuario_web) = upper(nm_usuario_w);	
					
					if (coalesce(ds_email_w,'X') = 'X') then						
						select 	max(ds_email)
						into STRICT	ds_email_w
						from 	pessoa_juridica_estab
						where 	cd_cgc = cd_estipulante_w;
					end if;
					
					if (coalesce(ds_email_w,'X') = 'X') then							
						select	max(ds_email)
						into STRICT	ds_email_w
						from   	compl_pessoa_fisica
						where  	cd_pessoa_fisica = cd_estipulante_w 
						and    	ie_tipo_complemento = 1 
						and    	(ds_email IS NOT NULL AND ds_email::text <> '');
					end if;
					
					if (coalesce(ds_email_w,'X') = 'X') then
						select	max(ds_email)
						into STRICT	ds_email_w
						from   	compl_pessoa_fisica
						where  	cd_pessoa_fisica = cd_estipulante_w 
						and    	ie_tipo_complemento = 2
						and    	(ds_email IS NOT NULL AND ds_email::text <> '');
					end if;
					
					if (coalesce(ds_email_w,'X') <> 'X') then
						CALL enviar_email(	ds_titulo_w, ds_mensagem_regra_w, ds_remetente_email_w,
								ds_email_w, nm_usuario_p, 'M');
						
						CALL pls_gerar_destino_evento(	nr_seq_evento_controle_w,
										'E',
										'EM',
										nm_usuario_p,
										cd_pessoa_fisica_w,
										null,
										'E-mail enviado para: '||ds_email_w||' com a mensagem: '||ds_mensagem_regra_w,
										null,
										null);											
					end if;		
				end if;
				end;
			end loop;
			close C02;			
		end if;
	end loop;
close C01;
	
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alerta_rejeicao_mov ( nr_seq_segurado_p bigint, nr_seq_inclusao_benef_p bigint, nr_seq_contrato_p bigint, ie_tipo_solicitacao_p bigint, nr_seq_solicitacao_p bigint, nm_usuario_p text) FROM PUBLIC;

