-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE supplypoint_mov_pac ( nr_atendimento_p bigint, cd_setor_new_p bigint, cd_setor_old_p bigint, nr_opcao_p bigint, nm_usuario_p text) AS $body$
DECLARE


/*
nr_opcao_p
1 - Transfercncia
2 - Alta
3 - Internacao
4 - Admissao do paciente (dispensario)
*/
ie_setor_new_supplypoint_w		varchar(1) := 'N';
ie_setor_old_supplypoint_w		varchar(1) := 'N';
ie_setor_int_supplypoint_w		varchar(1) := 'N';
ie_prescr_vigente_w			varchar(1) := 'N';
ds_param_integ_hl7_w			varchar(4000) := '';
dt_entrada_unidade_w			timestamp;
cd_setor_w				setor_atendimento.cd_setor_atendimento%type;
nr_prescricao_w				prescr_medica.nr_prescricao%type;
cd_setor_function			setor_atendimento.cd_setor_atendimento%type;
nr_seq_atepacu_w            bigint;

c01 CURSOR FOR
	SELECT	nr_prescricao
	from	prescr_medica
	where	dt_validade_prescr > clock_timestamp()
	and	cd_setor_atendimento = cd_setor_old_p
	and	nr_atendimento = nr_atendimento_p;

c02 CURSOR FOR
	SELECT	a.nr_prescricao
	from	prescr_medica a,
		prescr_mat_hor b,
		(SELECT	coalesce(nr_seq_estrut_int,0) nr_seq_estrut_int,
			cd_estabelecimento
		from	parametros_farmacia) c
	where	(b.nr_seq_lote IS NOT NULL AND b.nr_seq_lote::text <> '')
	and	a.dt_validade_prescr > clock_timestamp()
	and	consistir_se_mat_contr_estrut(c.nr_seq_estrut_int,b.cd_material) = 'S'
	and	obter_status_processo(b.nr_seq_processo) in ('G','X')
	and exists ( select 1 from ap_lote x where x.nr_sequencia = b.nr_seq_lote and coalesce(x.dt_atend_farmacia::text, '') = '')
	and	b.qt_dispensar_hor > 0
	and	a.cd_setor_atendimento = cd_setor_old_p
	and	a.nr_atendimento = nr_atendimento_p
	and	a.cd_estabelecimento = c.cd_estabelecimento
	and	a.nr_prescricao = b.nr_prescricao
	group by a.nr_prescricao;


BEGIN
begin
select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
into STRICT	ie_setor_new_supplypoint_w
from	far_setores_integracao
where	nr_seq_empresa_int = 82
and	cd_setor_atendimento = cd_setor_new_p  LIMIT 1;

select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
into STRICT	ie_setor_old_supplypoint_w
from	far_setores_integracao
where	nr_seq_empresa_int = 82
and	cd_setor_atendimento = cd_setor_old_p  LIMIT 1;
exception
when others then
	ie_setor_new_supplypoint_w := 'N';
	ie_setor_old_supplypoint_w := 'N';
end;

if (nr_opcao_p = 1) then --Movimentacao > GERAR_TRANSFERENCIA_PACIENTE
	begin
	-- Supplypoint X Nao supplypoint
	if (ie_setor_old_supplypoint_w = 'S') and (ie_setor_new_supplypoint_w = 'N') then
		select	coalesce(max(nr_seq_interno),0)
		into STRICT	nr_seq_atepacu_w
		from 	atend_paciente_unidade a
		where	a.nr_atendimento 		= nr_atendimento_p
		and 	a.cd_setor_atendimento = cd_setor_old_p;

		ds_param_integ_hl7_w := 'nr_atendimento=' || nr_atendimento_p || obter_separador_bv
							||  'nr_seq_interno=' || nr_seq_atepacu_w || obter_separador_bv;
	
		-- Envio das informacaes do paciente para gerar a alta
		CALL gravar_agend_integracao(435, ds_param_integ_hl7_w);
	end if;
	-- Supplypoint X Nao Supplypoint

	
	-- Supplypoint X Supplypoint
	if (ie_setor_old_supplypoint_w = 'S') and (ie_setor_new_supplypoint_w = 'S') then
		ds_param_integ_hl7_w := 'nr_atendimento=' || nr_atendimento_p || obter_separador_bv;
		CALL gravar_agend_integracao(432, ds_param_integ_hl7_w);
		/*begin
		select	'S'
		into	ie_prescr_vigente_w
		from	prescr_medica a,
			prescr_mat_hor b,
			(select	nvl(nr_seq_estrut_int,0) nr_seq_estrut_int,
				cd_estabelecimento
			from	parametros_farmacia) c
		where	b.nr_seq_lote is not null
		and	a.dt_validade_prescr > sysdate
		and	consistir_se_mat_contr_estrut(c.nr_seq_estrut_int,b.cd_material) = 'S'
		and exists( select 1 from ap_lote x where x.nr_sequencia = b.nr_seq_lote and x.dt_atend_farmacia is null)
		and	b.qt_dispensar_hor > 0
		and	a.cd_setor_atendimento = cd_setor_old_p
		and	a.nr_atendimento = nr_atendimento_p
		and	a.cd_estabelecimento = c.cd_estabelecimento
		and	a.nr_prescricao = b.nr_prescricao
		and	rownum = 1;
		exception
		when others then
			ie_prescr_vigente_w := 'N';
		end;
		
		if	(ie_prescr_vigente_w = 'S') then
			open c02;
			loop
			fetch c02 into	
				nr_prescricao_w;
			exit when c02%notfound;
				begin
				ds_param_integ_hl7_w := 'nr_prescricao=' || nr_prescricao_w || obter_separador_bv;
				
				-- Cancelamento da prescricao

				gravar_agend_integracao(431, ds_param_integ_hl7_w);
				
				ds_param_integ_hl7_w := 'nr_prescricao=' || nr_prescricao_w || obter_separador_bv || 
							'nr_atendimento=' || nr_atendimento_p || obter_separador_bv ||
							'ie_aprazado=' || 'GPMH' || obter_separador_bv ||
							'ie_origem=' || 'SMP' || obter_separador_bv;
				
				-- Geracao da prescricao com os itens pendentes

				gravar_agend_integracao(434, ds_param_integ_hl7_w);
				end;
			end loop;
			close c02;
		else
			-- Envio as informacaes do paciente

			ds_param_integ_hl7_w := 'nr_atendimento=' || nr_atendimento_p || obter_separador_bv;
			gravar_agend_integracao(432, ds_param_integ_hl7_w);
		end if;*/
	end if;
	-- Supplypoint X Supplypoint

	
	-- Nao Supplypoint X Supplypoint
	if (ie_setor_old_supplypoint_w = 'N') and (ie_setor_new_supplypoint_w = 'S') then
		begin
		select	'S'
		into STRICT	ie_prescr_vigente_w
		from	prescr_medica a,
			prescr_mat_hor b,
			(SELECT	coalesce(nr_seq_estrut_int,0) nr_seq_estrut_int,
				cd_estabelecimento
			from	parametros_farmacia) c
		where	(b.nr_seq_lote IS NOT NULL AND b.nr_seq_lote::text <> '')
		and	a.dt_validade_prescr > clock_timestamp()
		and	consistir_se_mat_contr_estrut(c.nr_seq_estrut_int,b.cd_material) = 'S'
		and exists ( select 1 from ap_lote x where x.nr_sequencia = b.nr_seq_lote and coalesce(x.dt_atend_farmacia::text, '') = '')
		and	b.qt_dispensar_hor > 0
		and	a.cd_setor_atendimento = cd_setor_old_p
		and	a.nr_atendimento = nr_atendimento_p
		and	a.cd_estabelecimento = c.cd_estabelecimento
		and	a.nr_prescricao = b.nr_prescricao  LIMIT 1;
		exception
		when others then
			ie_prescr_vigente_w := 'N';
		end;
		
		if (ie_prescr_vigente_w = 'S') then
			open c02;
			loop
			fetch c02 into
				nr_prescricao_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				begin
				ds_param_integ_hl7_w := 'nr_prescricao=' || nr_prescricao_w || obter_separador_bv ||
							'nr_atendimento=' || nr_atendimento_p || obter_separador_bv ||
							'ie_aprazado=' || 'GPMH' || obter_separador_bv ||
							'ie_origem=' || 'SMP' || obter_separador_bv;
				
				-- Geracao da prescricao com os itens pendentes
				CALL gravar_agend_integracao(434, ds_param_integ_hl7_w);
				end;
			end loop;
			close c02;
		end if;
	end if;
	-- Nao Supplypoint X Supplypoint
	end;
elsif (nr_opcao_p = 3) and (ie_setor_old_supplypoint_w = 'N') and (ie_setor_new_supplypoint_w = 'S') then --Internacao > ATEND_PACIENTE_UNIDADE_INSERT
	begin
	begin
	cd_setor_w := obter_setor_atendimento(nr_atendimento_p);
	
	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_setor_old_supplypoint_w
	from	far_setores_integracao
	where	nr_seq_empresa_int = 82
	and	cd_setor_atendimento = cd_setor_w  LIMIT 1;
	exception
	when others then
		ie_setor_old_supplypoint_w := 'N';
	end;
	
	if (ie_setor_old_supplypoint_w = 'N') then
		begin
		select	'S'
		into STRICT	ie_prescr_vigente_w
		from	prescr_medica a,
			prescr_mat_hor b,
			(SELECT	coalesce(nr_seq_estrut_int,0) nr_seq_estrut_int,
				cd_estabelecimento
			from	parametros_farmacia) c
		where	(b.nr_seq_lote IS NOT NULL AND b.nr_seq_lote::text <> '')
		and	a.dt_validade_prescr > clock_timestamp()
		and	consistir_se_mat_contr_estrut(c.nr_seq_estrut_int,b.cd_material) = 'S'
		and exists ( select 1 from ap_lote x where x.nr_sequencia = b.nr_seq_lote and coalesce(x.dt_atend_farmacia::text, '') = '')
		and	b.qt_dispensar_hor > 0
		and	a.cd_setor_atendimento = cd_setor_w
		and	a.nr_atendimento = nr_atendimento_p
		and	a.cd_estabelecimento = c.cd_estabelecimento
		and	a.nr_prescricao = b.nr_prescricao  LIMIT 1;
		exception
		when others then
			ie_prescr_vigente_w := 'N';
		end;
		
		if (ie_prescr_vigente_w = 'N') then
			ds_param_integ_hl7_w := 'nr_atendimento=' || nr_atendimento_p || obter_separador_bv;
			
			-- Envio das informacoes do paciente para gerar a alta
			CALL gravar_agend_integracao(430, ds_param_integ_hl7_w);
		end if;
	end if;
	end;
elsif (nr_opcao_p = 2) then --Alta > GERAR_ESTORNAR_ALTA
	begin
	
	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_setor_int_supplypoint_w
	from	far_setores_integracao
	where	nr_seq_empresa_int = 82
	and		cd_setor_atendimento = Obter_Unidade_Atendimento(nr_atendimento_p, 'IAAP', 'CS')  LIMIT 1;
	
	if (ie_setor_int_supplypoint_w = 'S') then
		select	coalesce(max(nr_seq_interno),0)
		into STRICT	nr_seq_atepacu_w
		from 	atend_paciente_unidade a
		where	a.nr_atendimento 		= nr_atendimento_p
		and 	a.cd_setor_atendimento = cd_setor_old_p;

		ds_param_integ_hl7_w := 'nr_atendimento=' || nr_atendimento_p || obter_separador_bv
							||  'nr_seq_interno=' || nr_seq_atepacu_w || obter_separador_bv;
		-- Envio das informacoes do paciente para gerar a alta
		CALL gravar_agend_integracao(435, ds_param_integ_hl7_w);
			end if;
	end;
elsif (nr_opcao_p = 4) then --Alta > GERAR_ESTORNAR_ALTA
	begin
	ds_param_integ_hl7_w := 'nr_atendimento=' || nr_atendimento_p || obter_separador_bv;
	
	-- Envio das informacoes do paciente para gerar a alta
	CALL gravar_agend_integracao(430, ds_param_integ_hl7_w);
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE supplypoint_mov_pac ( nr_atendimento_p bigint, cd_setor_new_p bigint, cd_setor_old_p bigint, nr_opcao_p bigint, nm_usuario_p text) FROM PUBLIC;

