-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_pac_internado (NM_USUARIO_P text, DT_PARAMETRO_P timestamp) AS $body$
DECLARE

nr_atendimento_w				bigint;
cd_estabelecimento_w			smallint;
dt_entrada_w				timestamp;
ie_tipo_convenio_w			smallint;
ie_tipo_atendimento_w			smallint;
cd_proc_longa_perm_w			bigint;
qt_dia_longa_perm_w			smallint;
qt_perm_sus_calc_w			smallint;
qt_perm_real_calc_w			smallint;
qt_longa_perm_calc_w			smallint;
nr_aih_calc_w				bigint;
C00 CURSOR FOR
	SELECT	e.nr_atendimento, 
   	   	e.dt_entrada, 
		e.cd_estabelecimento, 
		coalesce(e.ie_tipo_convenio,0), 
		e.ie_tipo_atendimento 
	from 	atendimento_paciente e 
	where 	e.dt_entrada  		<= fim_dia(dt_parametro_p) 
	and 	coalesce(e.dt_fim_conta::text, '') = '' 
	and 	coalesce(e.dt_alta::text, '') = '' 
	and	e.dt_entrada > dt_parametro_p - 1 
	and	e.ie_tipo_atendimento 	= 1 
	and	e.ie_tipo_convenio	<> 3 
	and	e.ie_tipo_convenio	<> 10 
	and 	not exists ( 
		SELECT x.nr_atendimento 
		from procedimento_paciente x	 
		where x.nr_atendimento = e.nr_atendimento 
		and	coalesce(x.cd_motivo_exc_conta::text, '') = '' 
		and	x.cd_procedimento in ( 
			select distinct(cd_procedimento) 
			from tipo_acomodacao 
			
union
 
			select distinct(cd_procedimento) 
			from tipo_acomod_convenio) 
		and	to_char(x.dt_procedimento,'dd/mm/yyyy') = to_char(dt_parametro_p,'dd/mm/yyyy'));

BEGIN
/* Calculo de lan√ßamento paciente */
 
OPEN C00;
LOOP 
  	FETCH C00 into 
     	nr_atendimento_w, 
		dt_entrada_w, 
		cd_estabelecimento_w, 
		ie_tipo_convenio_w, 
		ie_tipo_atendimento_w;
  	EXIT WHEN NOT FOUND; /* apply on c00 */
	BEGIN 
 
/* Edilson em 24/03/06 OS 31345 Comentei aqui e coloquei na Calcular_Diaria_Atend_Intern 
	Gerar_lancamento_automatico( 
			nr_atendimento_w, 
			null, 
			82, 
			nm_usuario_p, 
			null,null,null); */
 
 
	CALL Calcular_Diaria_Atend_Intern( 
			cd_estabelecimento_w, 
			nr_atendimento_w, 
			dt_entrada_w, 
			fim_dia(dt_parametro_p), 
			nm_usuario_p, 
			'N', 'N');
	END;
END LOOP;
CLOSE C00;
commit;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_pac_internado (NM_USUARIO_P text, DT_PARAMETRO_P timestamp) FROM PUBLIC;

