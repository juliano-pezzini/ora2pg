-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_gerar_a560_41 ( nr_seq_nota_deb_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_conteudo_w			varchar(4000);
cd_unimed_origem_w		varchar(4);
cd_unimed_destino_w		varchar(4);
nr_fatura_w			varchar(11);
vl_total_fatura_w		varchar(14) := null;
nr_nota_debito_w		varchar(11);
dt_ven_nota_w			varchar(8);
nr_titulo_w			bigint;
nr_seq_conta_banco_w		bigint;
nr_bloqueto_w			varchar(44);
nr_seq_carteira_cobr_w		bigint;
cd_banco_w			varchar(5);
cd_agencia_bancaria_w		varchar(25);
cd_carteira_w			varchar(10);
nr_nosso_numero_w		varchar(20);
vl_titulo_w			varchar(14);
dt_documento_w			timestamp;
dt_processo_w			timestamp;
nr_seq_ptu_fatura_w		bigint;
nr_nota_credito_debito_a500_w	varchar(30);
vl_total_ndc_a500_w		varchar(14);
ie_conclusao_ndc_w		varchar(1);
ds_uso_banco_w			varchar(15);
ds_especie_w			varchar(4);
ds_especie_doc_w		varchar(5);
ds_aceite_w			varchar(2);
ds_local_pagto_w		varchar(60);
ds_obs_local_pagto_w		varchar(60);
nr_seq_nota_deb_bol_w		bigint;
ds_instrucao_w			varchar(60);
ds_observacao_w			varchar(60);
nr_linha_digitavel_w		varchar(60);
cd_barras_w			varchar(44);
qt_registro_w			bigint := 0;
tp_boleto_w			varchar(1);


BEGIN
if (nr_seq_nota_deb_p IS NOT NULL AND nr_seq_nota_deb_p::text <> '') then
	delete from w_ptu_envio_arq
	where  nm_usuario = nm_usuario_p;

	begin
	select	nr_seq_ptu_fatura
	into STRICT	nr_seq_ptu_fatura_w
	from	pls_lote_contestacao	c,
		ptu_camara_contestacao	b,
		ptu_nota_debito	a
	where	b.nr_sequencia	= a.nr_seq_camara_contest
	and	c.nr_sequencia	= b.nr_seq_lote_contest
	and	a.nr_sequencia	= nr_seq_nota_deb_p;
	exception
	when others then
		nr_seq_ptu_fatura_w := null;
	end;

	if (nr_seq_ptu_fatura_w IS NOT NULL AND nr_seq_ptu_fatura_w::text <> '') then
		select	lpad(replace(replace(campo_mascara(pls_obter_dados_ptu_fatura(nr_seq_ptu_fatura_w,'VT'),2),',',''),'.',''),14,'0')
		into STRICT	vl_total_fatura_w
		;
	end if;

	-- HEADER
	begin
	select	lpad(a.cd_unimed_origem,4,'0'),
		lpad(a.cd_unimed_destino,4,'0'),
		lpad(a.nr_fatura,11,'0'),
		CASE WHEN coalesce(vl_total_fatura_w::text, '') = '' THEN lpad(replace(replace(campo_mascara(a.vl_total_fatura,2),',',''),'.',''),14,'0')  ELSE vl_total_fatura_w END ,
		lpad(coalesce(a.nr_nota_debito,'0'),11,'0'),
		lpad(coalesce(trim(both to_char(a.dt_ven_nota,'YYYYMMDD')),' '),8,' '),
		a.nr_nota_debito,
		lpad(coalesce(a.nr_nota_credito_debito_a500,0),11,'0'),
		CASE WHEN coalesce(a.vl_total_ndc_a500::text, '') = '' THEN lpad('0',14,'0')  ELSE lpad(replace(replace(campo_mascara(coalesce(a.vl_total_ndc_a500,0),2),',',''),'.',''),14,'0') END ,
		coalesce(a.ie_conclusao_ndc,' ')
	into STRICT	cd_unimed_origem_w,
		cd_unimed_destino_w,
		nr_fatura_w,
		vl_total_fatura_w,
		nr_nota_debito_w,
		dt_ven_nota_w,
		nr_titulo_w,
		nr_nota_credito_debito_a500_w,
		vl_total_ndc_a500_w,
		ie_conclusao_ndc_w
	from	ptu_nota_debito a
	where	a.nr_sequencia = nr_seq_nota_deb_p;
	exception
	when others then
		null;
	end;

	ds_conteudo_w :=	'00000001' || '561' || cd_unimed_destino_w || cd_unimed_origem_w || nr_fatura_w || vl_total_fatura_w || '03' ||
				nr_nota_credito_debito_a500_w||vl_total_ndc_a500_w;

	insert into w_ptu_envio_arq(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		ds_conteudo)
	values (nextval('w_ptu_envio_arq_seq'),
		clock_timestamp(),
		nm_usuario_p,
		ds_conteudo_w);

	-- DADOS DA NOTA DE DÉBITO DA CONCLUSÃO
	ds_conteudo_w := '00000002' || '562' || nr_nota_debito_w || dt_ven_nota_w || ie_conclusao_ndc_w;

	insert into w_ptu_envio_arq(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		ds_conteudo)
	values (nextval('w_ptu_envio_arq_seq'),
		clock_timestamp(),
		nm_usuario_p,
		ds_conteudo_w);

	select	max(nr_bloqueto)
	into STRICT	nr_bloqueto_w
	from	titulo_receber
	where	nr_titulo	= nr_titulo_w;

	if (nr_bloqueto_w IS NOT NULL AND nr_bloqueto_w::text <> '') then
		select	count(1)
		into STRICT	qt_registro_w
		from	ptu_nota_deb_bol	x
		where	x.nr_seq_nota_debito	= nr_seq_nota_deb_p;

		if (qt_registro_w > 0) then
			SELECT * FROM pls_obter_dados_arq_ndc( nr_seq_nota_deb_p, cd_banco_w, cd_agencia_bancaria_w, nr_nosso_numero_w, ds_uso_banco_w, cd_carteira_w, ds_especie_w, vl_titulo_w, dt_documento_w, ds_especie_doc_w, ds_aceite_w, dt_processo_w, ds_local_pagto_w, ds_obs_local_pagto_w, ds_instrucao_w, ds_observacao_w, nr_linha_digitavel_w, cd_barras_w, tp_boleto_w) INTO STRICT cd_banco_w, cd_agencia_bancaria_w, nr_nosso_numero_w, ds_uso_banco_w, cd_carteira_w, ds_especie_w, vl_titulo_w, dt_documento_w, ds_especie_doc_w, ds_aceite_w, dt_processo_w, ds_local_pagto_w, ds_obs_local_pagto_w, ds_instrucao_w, ds_observacao_w, nr_linha_digitavel_w, cd_barras_w, tp_boleto_w;
		else
			SELECT * FROM pls_obter_dados_arq_ndc_ant( nr_seq_nota_deb_p, cd_banco_w, cd_agencia_bancaria_w, nr_nosso_numero_w, ds_uso_banco_w, cd_carteira_w, ds_especie_w, vl_titulo_w, dt_documento_w, ds_especie_doc_w, ds_aceite_w, dt_processo_w, ds_local_pagto_w, ds_obs_local_pagto_w, ds_instrucao_w, ds_observacao_w, nr_linha_digitavel_w, cd_barras_w, tp_boleto_w) INTO STRICT cd_banco_w, cd_agencia_bancaria_w, nr_nosso_numero_w, ds_uso_banco_w, cd_carteira_w, ds_especie_w, vl_titulo_w, dt_documento_w, ds_especie_doc_w, ds_aceite_w, dt_processo_w, ds_local_pagto_w, ds_obs_local_pagto_w, ds_instrucao_w, ds_observacao_w, nr_linha_digitavel_w, cd_barras_w, tp_boleto_w;
		end if;

		-- BOLETO
		ds_conteudo_w :=	'00000003' ||
					'563' ||
					rpad(coalesce(cd_banco_w,' '),5,' ') ||
					rpad(coalesce(cd_agencia_bancaria_w,' '),25,' ') ||
					rpad(coalesce(nr_nosso_numero_w,' '),20,' ') ||
					lpad(coalesce(ds_uso_banco_w,' '),15,' ') ||
					lpad(coalesce(cd_carteira_w,' '),10,' ') ||
					rpad(coalesce(ds_especie_w,' '),4,' ') ||
					lpad(replace(replace(campo_mascara_virgula(coalesce(vl_titulo_w,0)),'.',''),',',''),14,'0') ||
					rpad(coalesce(to_char(dt_documento_w,'YYYYMMDD'),' '),8,' ') ||
					rpad(coalesce(ds_especie_doc_w,' '),5,' ') ||
					rpad(coalesce(ds_aceite_w,' '),2,' ') ||
					rpad(coalesce(to_char(dt_processo_w,'YYYYMMDD'),' '),8,' ') ||
					rpad(ds_local_pagto_w,60,' ') ||
					rpad(ds_obs_local_pagto_w,60,' ');

		insert into w_ptu_envio_arq(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			ds_conteudo)
		values (nextval('w_ptu_envio_arq_seq'),
			clock_timestamp(),
			nm_usuario_p,
			ds_conteudo_w);

		-- INSTRUÇÕES
		ds_conteudo_w := '00000004' || '564' || lpad(coalesce(ds_instrucao_w,' '),60,' ');

		insert into w_ptu_envio_arq(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			ds_conteudo)
		values (nextval('w_ptu_envio_arq_seq'),
			clock_timestamp(),
			nm_usuario_p,
			ds_conteudo_w);

		-- OBSERVAÇÕES
		ds_conteudo_w := '00000005' || '565' || lpad(coalesce(ds_observacao_w,' '),60,' ');

		insert into w_ptu_envio_arq(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			ds_conteudo)
		values (nextval('w_ptu_envio_arq_seq'),
			clock_timestamp(),
			nm_usuario_p,
			ds_conteudo_w);

		-- LINHA DIGITAVEL
		ds_conteudo_w := '00000006' || '566' || rpad(coalesce(nr_linha_digitavel_w,' '),60,' ') || rpad(coalesce(cd_barras_w,' '),44,' ');

		insert into w_ptu_envio_arq(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			ds_conteudo)
		values (nextval('w_ptu_envio_arq_seq'),
			clock_timestamp(),
			nm_usuario_p,
			ds_conteudo_w);
	end if;

	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_gerar_a560_41 ( nr_seq_nota_deb_p bigint, nm_usuario_p text) FROM PUBLIC;

