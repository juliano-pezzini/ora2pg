-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_orc_detalhe ( nr_seq_cenario_p bigint, nr_seq_orcamento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_centro_custo_w			bigint;
cd_conta_contabil_w		varchar(20);
cd_empresa_w			bigint;
cd_estabelecimento_w		bigint;
cd_pessoa_fisica_w		varchar(14);
cd_cnpj_w			varchar(14);
ds_detalhe_w			varchar(255);
ds_observacao_w			varchar(4000);
dt_inicial_w			timestamp;
dt_final_w			timestamp;
dt_referencia_w			timestamp;
nr_mes_w			bigint;
nr_seq_mes_ref_w			bigint;
vl_orcado_w			double precision;

c02 CURSOR FOR
SELECT	a.cd_pessoa_fisica,
	a.cd_cnpj,
	a.ds_detalhe,
	a.ds_observacao,
	CASE WHEN nr_mes_w=1 THEN  coalesce(sum(a.vl_orcado_1),0) WHEN nr_mes_w=2 THEN  coalesce(sum(a.vl_orcado_2),0) WHEN nr_mes_w=3 THEN  coalesce(sum(a.vl_orcado_3),0) WHEN nr_mes_w=4 THEN  coalesce(sum(a.vl_orcado_4),0) WHEN nr_mes_w=5 THEN  coalesce(sum(a.vl_orcado_5),0) WHEN nr_mes_w=6 THEN  coalesce(sum(a.vl_orcado_6),0) WHEN nr_mes_w=7 THEN  coalesce(sum(a.vl_orcado_7),0) WHEN nr_mes_w=8 THEN  coalesce(sum(a.vl_orcado_8),0) WHEN nr_mes_w=9 THEN  coalesce(sum(a.vl_orcado_9),0) WHEN nr_mes_w=10 THEN  coalesce(sum(a.vl_orcado_10),0) WHEN nr_mes_w=11 THEN  coalesce(sum(a.vl_orcado_11),0) WHEN nr_mes_w=12 THEN  coalesce(sum(a.vl_orcado_12),0) END  vl_orcado
from	ctb_orc_cen_valor_linear a
where	a.nr_seq_cenario	= nr_seq_cenario_p
and	a.cd_estabelecimento	= cd_estabelecimento_w
and	a.cd_centro_custo	= cd_centro_custo_w
and	a.cd_conta_contabil	= cd_conta_contabil_w
group by a.cd_pessoa_fisica,
	a.cd_cnpj,
	a.ds_detalhe,
	a.ds_observacao;

vet02	C02%RowType;


BEGIN

select	nr_seq_mes_ref,
	cd_conta_contabil,
	cd_centro_custo,
	cd_estabelecimento
into STRICT	nr_seq_mes_ref_w,
	cd_conta_contabil_w,
	cd_centro_custo_w,
	cd_estabelecimento_w
from	ctb_orcamento
where	nr_sequencia	= nr_seq_orcamento_p;


select	dt_referencia
into STRICT	dt_referencia_w
from	ctb_mes_ref
where	nr_sequencia	= nr_seq_mes_ref_w;

select	cd_empresa,
	ctb_obter_mes_ref(nr_seq_mes_inicio),
	ctb_obter_mes_ref(nr_seq_mes_fim)
into STRICT	cd_empresa_w,
	dt_inicial_w,
	dt_final_w
from	ctb_orc_cenario
where	nr_sequencia	= nr_seq_cenario_p;

delete	from ctb_orcamento_detalhe
where	nr_seq_orcamento	= nr_seq_orcamento_p
and	vl_realizado	= 0;

nr_mes_w	:= coalesce(trunc(months_between(dt_referencia_w,dt_inicial_w))+1,1);



open C02;
loop
fetch C02 into
	cd_pessoa_fisica_w,
	cd_cnpj_w,
	ds_detalhe_w,
	ds_observacao_w,
	vl_orcado_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin

	if (vl_orcado_w <> 0) then
		insert into ctb_orcamento_detalhe(
			nr_sequencia,
			nm_usuario,
			dt_atualizacao,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			nr_seq_orcamento,
			cd_pessoa_fisica,
			cd_cnpj,
			ds_detalhe,
			ds_observacao,
			vl_orcado,
			vl_original,
			vl_realizado)
		values (	nextval('ctb_orcamento_detalhe_seq'),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nr_seq_orcamento_p,
			cd_pessoa_fisica_w,
			cd_cnpj_w,
			ds_detalhe_w,
			ds_observacao_w,
			vl_orcado_w,
			0,
			0);

	end if;

	end;
end loop;
close C02;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_orc_detalhe ( nr_seq_cenario_p bigint, nr_seq_orcamento_p bigint, nm_usuario_p text) FROM PUBLIC;

