-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_ordem_ressuprimento ( cd_estabelecimento_p bigint, nm_usuario_p text, cd_cgc_fornecedor_p text, ds_pessoa_contato_p text, cd_setor_atendimento_p bigint, ie_tipo_ordem_p text, nr_ordem_compra_p INOUT bigint) AS $body$
DECLARE

 
nr_ordem_compra_w		bigint;
cd_comprador_padrao_w		varchar(10);
cd_moeda_padrao_w		bigint;
cd_pessoa_solicitante_w		varchar(10);
cd_condicao_pagamento_padrao_w	bigint;
tx_desc_ordem_w				double precision;
pr_desc_financeiro_w			double precision;


BEGIN 
select	nextval('ordem_compra_seq') 
into STRICT	nr_ordem_compra_w
;
 
begin 
select	cd_comprador_padrao, 
	cd_moeda_padrao, 
	cd_condicao_pagamento_padrao 
into STRICT	cd_comprador_padrao_w, 
	cd_moeda_padrao_w, 
	cd_condicao_pagamento_padrao_w 
from	parametro_compras 
where	cd_estabelecimento = cd_estabelecimento_p;
exception 
	when no_data_found then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(266023);
		--'Falta informação de comprador, ou moeda no parametro compras'); 
end;
 
begin 
select	coalesce(max(cd_pessoa_fisica),'0') 
into STRICT	cd_pessoa_solicitante_w 
from	usuario 
where	nm_usuario = nm_usuario_p;
if (cd_pessoa_solicitante_w = '0') then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(266018,'NM_USUARIO=' || nm_usuario_p);
	--'Pessoa física não informada no cadastro do usuario ' || nm_usuario_p 
end if;
end;
 
select	obter_dados_pf_pj_estab(cd_estabelecimento_p, null, cd_cgc_fornecedor_p, 'TDO'), 
	obter_dados_pf_pj_estab(cd_estabelecimento_p, null, cd_cgc_fornecedor_p, 'TDF') 
into STRICT	tx_desc_ordem_w, 
	pr_desc_financeiro_w
;
 
 
insert into ordem_compra( 
	nr_ordem_compra, 
	cd_estabelecimento, 
	cd_cgc_fornecedor, 
	cd_condicao_pagamento, 
	cd_comprador, 
	dt_ordem_compra, 
	dt_atualizacao, 
	nm_usuario, 
	cd_moeda, 
	dt_inclusao, 
	cd_pessoa_solicitante, 
	ie_frete, 
	vl_frete, 
	ds_pessoa_contato, 
	dt_entrega, 
	ie_aviso_chegada, 
	ie_emite_obs, 
	ie_urgente, 
	ie_somente_pagto, 
	cd_setor_atendimento, 
	ie_situacao, 
	ie_tipo_ordem, 
	pr_desconto, 
	pr_desc_financeiro) 
values (nr_ordem_compra_w, 
	cd_estabelecimento_p, 
	cd_cgc_fornecedor_p, 
	cd_condicao_pagamento_padrao_w, 
	cd_comprador_padrao_w, 
	trunc(clock_timestamp()), 
	clock_timestamp(), 
	nm_usuario_p, 
	cd_moeda_padrao_w, 
	clock_timestamp(), 
	cd_pessoa_solicitante_w, 
	'C', 
	0, 
	ds_pessoa_contato_p, 
	trunc(clock_timestamp()), 
	'N', 
	'S', 
	'N', 
	'N', 
	cd_setor_atendimento_p, 
	'A', 
	ie_tipo_ordem_p, 
	tx_desc_ordem_w, 
	pr_desc_financeiro_w);
 
nr_ordem_compra_p	:= nr_ordem_compra_w;
 
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_ordem_ressuprimento ( cd_estabelecimento_p bigint, nm_usuario_p text, cd_cgc_fornecedor_p text, ds_pessoa_contato_p text, cd_setor_atendimento_p bigint, ie_tipo_ordem_p text, nr_ordem_compra_p INOUT bigint) FROM PUBLIC;

