-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rxt_gerar_liberacao_plan (nr_seq_fase_trat_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_tipo_trat_p text) AS $body$
DECLARE


nr_seq_plan_fisico_w 		rxt_planejamento_fisico.nr_sequencia%type;
nr_seq_plan_inativo_w		rxt_planejamento_fisico.nr_seq_planejamento_inativacao%type;
nr_seq_campo_w 				rxt_planejamento_fisico.nr_seq_campo%type;
ds_campo_tratamento_w		rxt_planejamento_fisico.ds_campo_tratamento%type;
ie_tipo_x_w 				rxt_planejamento_fisico.ie_tipo_x%type;
ie_tipo_y_w					rxt_planejamento_fisico.ie_tipo_y%type;
qt_tam_x_w 					rxt_planejamento_fisico.qt_tam_x%type;
qt_tam_y_w					rxt_planejamento_fisico.qt_tam_y%type;
qt_x1_w 					rxt_planejamento_fisico.qt_x1%type;
qt_y1_w						rxt_planejamento_fisico.qt_y1%type;
qt_x2_w						rxt_planejamento_fisico.qt_x2%type;
qt_y2_w						rxt_planejamento_fisico.qt_y2%type;
qt_numero_aplicacoes_w 		rxt_planejamento_fisico.qt_numero_aplicacoes%type;
qt_dose_tumor_diaria_w		rxt_planejamento_fisico.qt_dose_tumor_diaria%type;
qt_ssd_w					rxt_planejamento_fisico.qt_ssd%type;
qt_dose_tumor_real_w 		rxt_planejamento_fisico.qt_dose_tumor_real%type;
qt_angulo_gantry_w 			rxt_planejamento_fisico.qt_angulo_gantry%type;
qt_angulo_gantry_final_w	rxt_planejamento_fisico.qt_angulo_gantry_final%type;
qt_angulo_colimador_w		rxt_planejamento_fisico.qt_angulo_colimador%type;
qt_ang_colimador_final_w	rxt_planejamento_fisico.qt_ang_colimador_final%type;
qt_angulo_mesa_w 			rxt_planejamento_fisico.qt_angulo_mesa%type;
qt_unidade_monitor_w 		rxt_planejamento_fisico.qt_unidade_monitor%type;
nr_seq_energia_rad_w 		rxt_planejamento_fisico.nr_seq_energia_rad%type;
nr_seq_ene_fotons_w			rxt_planejamento_fisico.nr_seq_ene_fotons%type;
cd_estabelecimento_w 		rxt_planejamento_fisico.cd_estabelecimento%type;
nm_usuario_w				rxt_planejamento_fisico.nm_usuario%type;
nr_seq_fase_w				rxt_planejamento_fisico.nr_seq_fase%type;
nr_seq_rxt_campo_w			rxt_planejamento_fisico.nr_seq_rxt_campo%type;
nr_seq_max_w				rxt_campo.nr_sequencia%type;
nr_seq_aplic_w				rxt_plan_braqui_fisico.nr_seq_aplic%type;
qt_dose_reto_w				rxt_plan_braqui_fisico.qt_dose_reto%type;
qt_dose_bexiga_w			rxt_plan_braqui_fisico.qt_dose_bexiga%type;
qt_dose_clip_w				rxt_plan_braqui_fisico.qt_dose_clip%type;
qt_v100_w					rxt_plan_braqui_fisico.qt_v100%type;
qt_v150_w					rxt_plan_braqui_fisico.qt_v150%type;
qt_v150_100_w				rxt_plan_braqui_fisico.qt_v150_100%type;
ds_resultado_w				rxt_plan_braqui_fisico.ds_resultado%type;
nr_insercao_w				rxt_plan_braqui_fisico.nr_insercao%type;
qt_atividade_ci_w			rxt_plan_braqui_fisico.qt_atividade_ci%type;
qt_tempo_w					rxt_plan_braqui_fisico.qt_tempo%type;
qt_angulacao_w				rxt_plan_braqui_fisico.qt_angulacao%type;
ie_ponto_av_dose_w			rxt_plan_braqui_fisico.ie_ponto_avaliacao_dose%type;
qt_dose_ponto_av_w			rxt_plan_braqui_fisico.qt_dose_ponto_avaliacao%type;
ie_volume_w					rxt_plan_braqui_fisico.ie_volume%type;
qt_dose_volume_w			rxt_plan_braqui_fisico.qt_dose_volume%type;
nr_seq_aplic_trat_w			rxt_plan_braqui_fisico.nr_seq_braq_aplic_trat%type;
nr_seq_plan_braq_w			rxt_plan_braqui_fisico.nr_sequencia%type;
nr_seq_campo_b_w				rxt_plan_braqui_fisico.nr_seq_campo%type;
ds_observacao_fisico_w		rxt_plan_braqui_fisico.ds_observacao_fisico%type;
nr_seq_p_inativo_w			rxt_plan_braqui_fisico.nr_seq_planejamento_inativacao%type;

c01 CURSOR FOR
    SELECT 	nr_sequencia,
            nr_seq_planejamento_inativacao,
			nr_seq_campo,
			ds_campo_tratamento,
			ie_tipo_x,
			ie_tipo_y,
			qt_tam_x,
			qt_tam_y,
			qt_x1,
			qt_y1,
			qt_x2,
			qt_y2,
			qt_numero_aplicacoes,
			qt_dose_tumor_diaria,
			qt_ssd,
			qt_dose_tumor_real,
			qt_angulo_gantry,
			qt_angulo_gantry_final,
			qt_angulo_colimador,
			qt_ang_colimador_final,
			qt_angulo_mesa,
			qt_unidade_monitor,
			nr_seq_energia_rad,
			nr_seq_ene_fotons,
			nr_seq_fase,
			nr_seq_rxt_campo
    from 	rxt_planejamento_fisico
    where 	ie_situacao = 'A'
    and 	coalesce(dt_liberacao::text, '') = ''
    and 	nr_seq_fase = nr_seq_fase_trat_p;

c02 CURSOR FOR
	SELECT 	nr_sequencia,
			nr_seq_aplic,
			qt_dose_reto,
			qt_dose_bexiga,
			qt_dose_clip,
			qt_v100,
			qt_v150,
			qt_v150_100,
			ds_resultado,
			nr_insercao,
			nr_seq_campo,
			qt_atividade_ci,
			qt_tempo,
			qt_angulacao,
			ie_ponto_avaliacao_dose,
			qt_dose_ponto_avaliacao,
			ie_volume,
			qt_dose_volume,
			nr_seq_braq_aplic_trat,
			ds_observacao_fisico,
			nr_seq_planejamento_inativacao
	from 	rxt_plan_braqui_fisico a
	where 	coalesce(dt_liberacao::text, '') = ''
	and 	ie_situacao = 'A'
	and 	nr_seq_braq_aplic_trat = nr_seq_fase_trat_p;


BEGIN


	if (ie_tipo_trat_p = 'T') then
		open c01;
		loop
		fetch c01 into
			nr_seq_plan_fisico_w,
			nr_seq_plan_inativo_w,
			nr_seq_campo_w,
			ds_campo_tratamento_w,
			ie_tipo_x_w,
			ie_tipo_y_w,
			qt_tam_x_w,
			qt_tam_y_w,
			qt_x1_w,
			qt_y1_w,
			qt_x2_w,
			qt_y2_w,
			qt_numero_aplicacoes_w,
			qt_dose_tumor_diaria_w,
			qt_ssd_w,
			qt_dose_tumor_real_w,
			qt_angulo_gantry_w,
			qt_angulo_gantry_final_w,
			qt_angulo_colimador_w,
			qt_ang_colimador_final_w,
			qt_angulo_mesa_w,
			qt_unidade_monitor_w,
			nr_seq_energia_rad_w,
			nr_seq_ene_fotons_w,
			nr_seq_fase_w,
			nr_seq_rxt_campo_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

			update rxt_planejamento_fisico a
			set a.dt_liberacao = clock_timestamp(),
				a.nm_usuario_lib = nm_usuario_p
			where  a.nr_sequencia = nr_seq_plan_fisico_w;


			if (nr_seq_rxt_campo_w IS NOT NULL AND nr_seq_rxt_campo_w::text <> '') then
				update rxt_campo
				set dt_lib_fisico = clock_timestamp()
				where nr_sequencia = nr_seq_rxt_campo_w;
			else
				update rxt_campo
				set dt_inativacao = clock_timestamp(),
					nm_usuario_inativacao = nm_usuario_p,
					ie_situacao = 'I'
				where nr_sequencia = (SELECT max(nr_seq_rxt_campo)
									  from rxt_planejamento_fisico
									  where nr_sequencia = nr_seq_plan_inativo_w);

				select nextval('rxt_campo_seq')
				into STRICT	nr_seq_max_w
				;

				/*inserindo na rxt_campo o registro alterado e liberado pelo físico*/

				insert into    rxt_campo(nr_sequencia,
										nr_seq_campo,
										ds_campo,
										ie_tipo_x,
										ie_tipo_y,
										qt_tam_x,
										qt_tam_y,
										qt_x1,
										qt_y1,
										qt_x2,
										qt_y2,
										nr_aplicacoes,
										qt_dose_diaria,
										qt_ssd,
										qt_dose_total,
										qt_angulo_gantry,
										qt_angulo_gantry_final,
										qt_angulo_colimador,
										qt_ang_colimador_final,
										qt_angulo_mesa,
										qt_dose_monitor,
										nr_seq_energia_rad,
										nr_seq_ene_fotons,
										dt_atualizacao_nrec,
										nm_usuario_nrec,
										dt_atualizacao,
										nm_usuario,
										nr_seq_fase,
										dt_lib_fisico,
										ie_situacao,
										dt_envio_fisico)
				values (nr_seq_max_w,
										nr_seq_campo_w,
										ds_campo_tratamento_w,
										ie_tipo_x_w,
										ie_tipo_y_w,
										qt_tam_x_w,
										qt_tam_y_w,
										qt_x1_w,
										qt_y1_w,
										qt_x2_w,
										qt_y2_w,
										qt_numero_aplicacoes_w,
										qt_dose_tumor_diaria_w,
										qt_ssd_w,
										qt_dose_tumor_real_w,
										qt_angulo_gantry_w,
										qt_angulo_gantry_final_w,
										qt_angulo_colimador_w,
										qt_ang_colimador_final_w,
										qt_angulo_mesa_w,
										qt_unidade_monitor_w,
										nr_seq_energia_rad_w,
										nr_seq_ene_fotons_w,
										clock_timestamp(),
										nm_usuario_p,
										clock_timestamp(),
										nm_usuario_p,
										nr_seq_fase_w,
										clock_timestamp(),
										'A',
										clock_timestamp());
				commit;

				/*atualizando vínculo com a rxt_campo*/

				update rxt_planejamento_fisico a
				set a.nr_seq_rxt_campo = nr_seq_max_w
				where a.nr_sequencia = nr_seq_plan_fisico_w;

			end if;
		end;
		end loop;
		close c01;
	elsif (ie_tipo_trat_p = 'B') then
		open c02;
		loop
		fetch c02 into
		nr_seq_plan_braq_w,
		nr_seq_aplic_w,
		qt_dose_reto_w,
		qt_dose_bexiga_w,
		qt_dose_clip_w,
		qt_v100_w,
		qt_v150_w,
		qt_v150_100_w,
		ds_resultado_w,
		nr_insercao_w,
		nr_seq_campo_b_w,
		qt_atividade_ci_w,
		qt_tempo_w,
		qt_angulacao_w,
		ie_ponto_av_dose_w,
		qt_dose_ponto_av_w,
		ie_volume_w,
		qt_dose_volume_w,
		nr_seq_aplic_trat_w,
		ds_observacao_fisico_w,
		nr_seq_p_inativo_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
		begin


			update rxt_plan_braqui_fisico a
			set 	a.dt_liberacao = clock_timestamp(),
					a.nm_usuario_lib = nm_usuario_p
			where  	a.nr_sequencia = nr_seq_plan_braq_w;

			if (nr_seq_aplic_w IS NOT NULL AND nr_seq_aplic_w::text <> '') then
				update  rxt_braq_campo_aplic_trat
				set 	dt_lib_fisico = clock_timestamp()
				where 	nr_sequencia = nr_seq_aplic_w;
			else
				update  rxt_braq_campo_aplic_trat
				set 	dt_inativacao = clock_timestamp(),
						nm_usuario_inativacao = nm_usuario_p,
						ie_situacao = 'I'
				where nr_sequencia = (SELECT max(nr_seq_aplic)
									  from rxt_plan_braqui_fisico
									  where nr_sequencia = nr_seq_p_inativo_w);


				select nextval('rxt_braq_campo_aplic_trat_seq')
				into STRICT	nr_seq_max_w
				;

				/*inserindo na rxt_braq_campo_aplic_trat o registro alterado e liberado pelo físico*/

				insert into    rxt_braq_campo_aplic_trat(	nr_sequencia,
															cd_estabelecimento,
															dt_atualizacao,
															nm_usuario,
															dt_atualizacao_nrec,
															nm_usuario_nrec,
															nr_seq_aplic_trat,
															ds_resultado,
															nr_insercao,
															nr_seq_campo,
															ie_situacao,
															qt_atividade_ci,
															qt_tempo,
															qt_angulacao,
															dt_lib_fisico,
															dt_envio_fisico)
				values (	nr_seq_max_w,
															cd_estabelecimento_p,
															clock_timestamp(),
															nm_usuario_p,
															clock_timestamp(),
															nm_usuario_p,
															nr_seq_aplic_trat_w,
															ds_resultado_w,
															nr_insercao_w,
															nr_seq_campo_b_w,
															'A',
															qt_atividade_ci_w,
															qt_tempo_w,
															qt_angulacao_w,
															clock_timestamp(),
															clock_timestamp());
				commit;

				/*atualizando vínculo com a rxt_campo*/

				update rxt_plan_braqui_fisico a
				set a.nr_seq_aplic = nr_seq_max_w
				where a.nr_sequencia = nr_seq_plan_braq_w;

			end if;
		end;
		end loop;
		close c02;
	end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rxt_gerar_liberacao_plan (nr_seq_fase_trat_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_tipo_trat_p text) FROM PUBLIC;

