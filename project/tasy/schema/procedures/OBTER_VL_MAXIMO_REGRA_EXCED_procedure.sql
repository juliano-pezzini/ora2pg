-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_vl_maximo_regra_exced ( cd_moeda_p bigint , dt_referencia_p timestamp, cd_convenio_p bigint, vl_maximo_p INOUT bigint, cd_procedimento_p INOUT bigint, ie_origem_proced_p INOUT bigint) AS $body$
DECLARE

/*
RETORNA O PROCEDIMENTO,ORIGEM E VALOR MÁXIMO DA REGRA DE CONTA EXCEDENTE.
CADASTRO DE CONVÊNIOS PREÇOS E REGRAS\REGRAS
*/
vl_maximo_w 				regra_conta_excedente.vl_max_conta%type;
cd_procedimento_w			regra_conta_excedente.cd_procedimento%type;
ie_origem_proced_w		regra_conta_excedente.ie_origem_proced%type;
cd_estabelecimento_w    regra_conta_excedente.cd_estabelecimento%type;

C01 CURSOR FOR
	SELECT	vl_max_conta,
				cd_procedimento,
				ie_origem_proced
	from 	 	regra_conta_excedente
	where 	cd_moeda = cd_moeda_p
	and 	 	dt_referencia_p   between coalesce(dt_inicio_vigencia,dt_referencia_p) and coalesce(dt_fim_vigencia,dt_referencia_p)
	and 	 	cd_convenio 			= cd_convenio_p
	and 	 	cd_estabelecimento 	= cd_estabelecimento_w
	and 	 coalesce(ie_situacao,'I') 	= 'A'
	order by dt_inicio_vigencia desc; --maior inicio vigencia
BEGIN

vl_maximo_p 	   	:= coalesce(vl_maximo_w,0);
cd_estabelecimento_w := WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO;

open C01;
loop
fetch C01 into
	vl_maximo_w,
	cd_procedimento_w,
	ie_origem_proced_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	vl_maximo_p 	    := coalesce(vl_maximo_w,0);
	cd_procedimento_p  := cd_procedimento_w;
	ie_origem_proced_p := ie_origem_proced_w;
	exit;--somente o inicio vigência mais atual
	end;
end loop;
close C01;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_vl_maximo_regra_exced ( cd_moeda_p bigint , dt_referencia_p timestamp, cd_convenio_p bigint, vl_maximo_p INOUT bigint, cd_procedimento_p INOUT bigint, ie_origem_proced_p INOUT bigint) FROM PUBLIC;

