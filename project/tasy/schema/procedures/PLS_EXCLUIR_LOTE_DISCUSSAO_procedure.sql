-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_excluir_lote_discussao ( nr_seq_lote_discussao_p bigint, nm_usuario_p text) AS $body$
DECLARE


/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Excluir o lote de discussão
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  ]  Objetos do dicionário [X] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/ 

nr_titulo_w			bigint;
nr_seq_lote_contest_w		bigint;
qt_registro_w			integer;
ie_situacao_w			titulo_receber.ie_situacao%type;
qt_monitor_tiss_w			integer;


BEGIN
select	sum(qt_copart)
into STRICT	qt_registro_w
from (SELECT count(1) qt_copart
	from	pls_conta_coparticipacao 	c,
		pls_discussao_mat		d,
		pls_contestacao_discussao	cd
	where	c.nr_seq_disc_mat	= d.nr_sequencia
	and	d.nr_seq_discussao	= cd.nr_sequencia
	and	cd.nr_seq_lote		= nr_seq_lote_discussao_p
	
union

	SELECT  count(1) qt_copart
	from	pls_conta_coparticipacao 	c,
		pls_discussao_proc 		d,
		pls_contestacao_discussao 	cd
	where	c.nr_seq_disc_proc	= d.nr_sequencia
	and	d.nr_seq_discussao	= cd.nr_sequencia
	and	cd.nr_seq_lote		= nr_seq_lote_discussao_p) alias3;

if (qt_registro_w > 0) then
	-- Este lote de discussão não pode ser excluído, pois foi gerada coparticipação para alguns itens.
	CALL wheb_mensagem_pck.exibir_mensagem_abort(357623);
end if;

select 	count(1)
into STRICT	qt_registro_w
from	pls_ajuste_fatura
where	nr_seq_lote_disc = nr_seq_lote_discussao_p;

if (qt_registro_w > 0) then
	-- Este lote de discussão não pode ser excluído, pois contém itens para refaturamento.
	CALL wheb_mensagem_pck.exibir_mensagem_abort(357165);
end if;

select	max(nr_seq_lote_contest)
into STRICT	nr_seq_lote_contest_w
from	pls_lote_discussao
where	nr_sequencia	= nr_seq_lote_discussao_p;

update	ptu_camara_contestacao
set	nr_seq_lote_discussao 	 = NULL,
	nm_usuario		= nm_usuario_p,
	dt_atualizacao		= clock_timestamp()
where	nr_seq_lote_discussao 	= nr_seq_lote_discussao_p;

delete	FROM pls_conta_pos_proc_fat
where	nr_seq_conta_pos_proc	in (	SELECT	nr_sequencia
					from	pls_conta_pos_proc
					where	nr_seq_lote_disc	= nr_seq_lote_discussao_p);

delete	FROM pls_conta_pos_proc
where	nr_seq_lote_disc	= nr_seq_lote_discussao_p;

delete	FROM pls_conta_pos_mat_fat
where	nr_seq_conta_mat_pos	in (	SELECT	nr_sequencia
					from	pls_conta_pos_mat
					where	nr_seq_lote_disc	= nr_seq_lote_discussao_p);

delete	FROM pls_conta_pos_mat
where	nr_seq_lote_disc	= nr_seq_lote_discussao_p;

delete	FROM pls_conta_pos_estabelecido
where	nr_seq_lote_disc	= nr_seq_lote_discussao_p;

delete	FROM pls_discussao_anexo
where	nr_seq_lote_disc = nr_seq_lote_discussao_p;

delete	FROM pls_discussao_item_glosa
where	nr_seq_disc_mat	in (SELECT	nr_sequencia
				from	pls_discussao_mat
				where	nr_seq_discussao in (select	nr_sequencia
								from	pls_contestacao_discussao
								where	nr_seq_lote = nr_seq_lote_discussao_p));
delete	FROM pls_conta_pos_estabelecido p
where	p.nr_seq_disc_mat	in (	SELECT 	nr_sequencia
					from	pls_discussao_mat
					where	nr_seq_discussao in (	select	nr_sequencia
										from	pls_contestacao_discussao
										where	nr_seq_lote = nr_seq_lote_discussao_p));
								
delete	FROM pls_discussao_mat
where	nr_seq_discussao in (SELECT	nr_sequencia
				from	pls_contestacao_discussao
				where	nr_seq_lote = nr_seq_lote_discussao_p);
								
delete	FROM pls_discussao_item_glosa
where	nr_seq_disc_proc in (SELECT	nr_sequencia
				from	pls_discussao_proc
				where	nr_seq_discussao in (select	nr_sequencia
								from	pls_contestacao_discussao
								where	nr_seq_lote = nr_seq_lote_discussao_p));

delete	FROM pls_conta_pos_estabelecido p
where	p.nr_seq_disc_proc	in (	SELECT 	nr_sequencia
					from	pls_discussao_proc
					where	nr_seq_discussao in (	select	nr_sequencia
										from	pls_contestacao_discussao
										where	nr_seq_lote = nr_seq_lote_discussao_p));
			
delete	FROM pls_conta_pos_estabelecido
where	nr_seq_cabecalho	in (SELECT	nr_sequencia
					from	pls_conta_pos_cabecalho
					where	nr_seq_discussao in (select	nr_sequencia
									from	pls_contestacao_discussao
									where	nr_seq_lote = nr_seq_lote_discussao_p));	
			
delete	FROM pls_discussao_proc
where	nr_seq_discussao in (SELECT	nr_sequencia
				from	pls_contestacao_discussao
				where	nr_seq_lote = nr_seq_lote_discussao_p);

delete	FROM pls_conta_pos_cabecalho
where	nr_seq_discussao in (SELECT	nr_sequencia
				from	pls_contestacao_discussao
				where	nr_seq_lote = nr_seq_lote_discussao_p);
				
select	count(1)
into STRICT  	qt_monitor_tiss_w
from   	pls_monitor_tiss_alt_guia a,
	pls_monitor_tiss_cta_val  b,
	pls_monitor_tiss_alt      c,
	pls_contestacao_discussao d
where  	a.nr_seq_cta_val          = b.nr_sequencia
and    	a.nr_seq_cta_alt          = c.nr_sequencia
and    	c.nr_seq_conta_disc       = d.nr_sequencia
and    	d.nr_seq_lote             = nr_seq_lote_discussao_p;


if (qt_monitor_tiss_w > 0) then
	-- Lote de discussão não pode ser excluído pois informações do monitoramento já foram enviadas à ANS.
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1087494);
end if;


delete from pls_monitor_tiss_alt
where  nr_sequencia in (SELECT distinct(a.nr_sequencia)
                        from   pls_monitor_tiss_alt       a, 
                               pls_contestacao_discussao  b 
                        where  a.nr_seq_conta_disc        = b.nr_sequencia 
                        and    b.nr_seq_lote              = nr_seq_lote_discussao_p);
						
				
delete	FROM pls_contestacao_discussao
where	nr_seq_lote = nr_seq_lote_discussao_p;


select	max(nr_titulo)
into STRICT	nr_titulo_w
from	titulo_pagar
where	nr_seq_pls_lote_disc = nr_seq_lote_discussao_p;

if (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then
	CALL cancelar_titulo_pagar(nr_titulo_w,nm_usuario_p,clock_timestamp());
	
	update	titulo_pagar
	set	nr_seq_pls_lote_disc  = NULL
	where	nr_titulo = nr_titulo_w;
end if;

select	max(nr_titulo)
into STRICT	nr_titulo_w
from	titulo_receber
where	nr_seq_pls_lote_disc = nr_seq_lote_discussao_p;

if (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then
	CALL cancelar_titulo_receber(nr_titulo_w,nm_usuario_p,'S');
	
	update	titulo_receber
	set	nr_seq_pls_lote_disc  = NULL
	where	nr_titulo = nr_titulo_w;
end if;

select	max(nr_titulo)
into STRICT	nr_titulo_w
from	titulo_receber_liq
where	nr_seq_pls_lote_disc	= nr_seq_lote_discussao_p;

if (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then
	-- Remover tributo baixa do título de faturamento 
	delete	FROM titulo_receber_trib_baixa
	where	nr_titulo	= nr_titulo_w
	and	nr_seq_tit_liq	in (	SELECT	nr_sequencia
					from	titulo_receber_liq
					where	nr_seq_pls_lote_disc	= nr_seq_lote_discussao_p
					and	nr_titulo		= nr_titulo_w);

	-- Remover baixa do título do faturamento
	delete	FROM titulo_receber_liq
	where	nr_seq_pls_lote_disc = nr_seq_lote_discussao_p;	
	
	-- Atualizar slado do título do faturamento
	CALL atualizar_saldo_tit_rec(nr_titulo_w,nm_usuario_p);
end if;

delete	FROM pls_lote_discussao
where	nr_sequencia = nr_seq_lote_discussao_p;

CALL pls_atualizar_valores_contest(nr_seq_lote_contest_w,'N');

-- Log Exclusão
pls_gerar_contest_log( nr_seq_lote_contest_w, nr_seq_lote_discussao_p, null, null, null, 'PLS_EXCLUIR_LOTE_DISCUSSAO', 'EXLD', 'N', nm_usuario_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_excluir_lote_discussao ( nr_seq_lote_discussao_p bigint, nm_usuario_p text) FROM PUBLIC;

