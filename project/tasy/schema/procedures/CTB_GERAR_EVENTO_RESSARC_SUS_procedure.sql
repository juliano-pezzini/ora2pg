-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_evento_ressarc_sus ( nr_seq_registro_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_gerar_arquivo_p text) AS $body$
DECLARE


dt_inicial_w		timestamp;
dt_final_w		timestamp;
dt_liberacao_w		timestamp;

ds_erro_w		varchar(255);
ds_local_w		varchar(255);
nm_arquivo_w		varchar(255);
arq_texto_w		utl_file.file_type;
ds_nome_livro_w		varchar(255);
ds_periodo_w		varchar(255);	
ie_tipo_segurado_w	pls_segurado.ie_tipo_segurado%type;
ds_rotulo_w		varchar(5000) := 	'Identificação do Evento;Tipo Documento;Nr Carteira;Beneficiário Remido;Beneficiário;Tipo de Beneficiário;CPF/CNPJ Usuário Princ;Usuário Principal;Tipo Segurado;'		||
						'Prestador;Modalidade Contratação;Tipo Regulamentação;Tipo Contratacao;Segmentação;Nr Registro Produto;Nr Contrato;Vl Pagar;Vl Evento;'			||
						'Vl Deferido;Dt Pagamento;Dt Contabilização;Dt Conhecimento;Dt Vencimento;Dt Ocorrência;Nr Título;Conta Débito;Conta Crédito;Tipo de Evento;Nr ABI;Nr AIH;Observação';
ds_observacao_w		varchar(255);
ds_observacao_item_w	varchar(255);	

c_linha CURSOR FOR
	SELECT	nr_documento          				|| ';' ||
		ds_tipo_documento     				|| ';' ||
		cd_beneficiario       				|| ';' ||
		substr(obter_valor_dominio(6,pls_obter_se_benef_remido(a.nr_seq_segurado,
			a.dt_ocorrencia)),1,255)		|| ';' ||
		nm_usuario_evento     				|| ';' ||
		ds_tipo_segurado				|| ';' ||
		substr(pls_obter_se_corresp_assumida(ie_tipo_segurado,nr_cpf_cnpj_adic),
			1,255)  				|| ';' ||
		nm_usuario_princ      				|| ';' ||
		ds_tipo_segurado      				|| ';' ||
		nm_prestador          				|| ';' ||
		ds_modalidade_contrat 				|| ';' ||
		ds_tipo_regulamentacao				|| ';' ||
		ds_tipo_contratacao   				|| ';' ||
		ds_segmentacao        				|| ';' ||
		substr(pls_obter_se_corresp_assumida(
		ie_tipo_segurado,nr_protocolo_ans),1,255)	|| ';' ||
		substr(pls_obter_se_corresp_assumida(
			ie_tipo_segurado,nr_contrato),1,255)	|| ';' ||
		vl_pagar              				|| ';' ||
		vl_evento             				|| ';' ||
		vl_glosa              				|| ';' ||
		dt_pagamento          				|| ';' ||
		dt_contabilizacao     				|| ';' ||
		dt_conhecimento       				|| ';' ||
		dt_vencimento         				|| ';' ||
                dt_ocorrencia                                   || ';' ||
		nr_titulo             				|| ';' ||
		cd_conta_contrapartida				|| ';' ||
		cd_conta_contabil     				|| ';' ||
		substr(obter_valor_dominio(3579,ie_tipo_evento),1,255)		|| ';' ||
		a.cd_material_ops				|| ';' ||
		a.ds_operacao					|| ';' ||
		a.ds_observacao ds_linha			
	from	w_ctb_livro_aux_event_liq a
	where	nr_seq_reg_auxiliar 	= nr_seq_registro_p
	order by (nr_documento)::numeric;

BEGIN

CALL wheb_usuario_pck.set_ie_executar_trigger('N');

select	trunc(max(a.dt_inicial),'dd'),
	fim_dia(max(a.dt_final)),
	max(a.dt_liberacao),
	max(ie_tipo_segurado)
into STRICT	dt_inicial_w,
	dt_final_w,
	dt_liberacao_w,
	ie_tipo_segurado_w
from	ctb_livro_auxiliar	a
where	a.nr_sequencia	= nr_seq_registro_p;

select	substr(obter_desc_expressao(922923),1,255)
into STRICT	ds_observacao_w
;

if (ie_gerar_arquivo_p = 'N') then
	
	insert into w_ctb_livro_aux_event_liq(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_documento,
			cd_beneficiario,
			nm_usuario_evento,
			nr_cpf_cnpj_adic,
			nm_usuario_princ,
			ie_tipo_segurado,
			ds_tipo_segurado,
			nm_prestador,
			ie_tipo_documento,
			ds_tipo_documento,
			ie_preco,
			ds_modalidade_contrat,
			ie_regulamentacao,
			ds_tipo_regulamentacao,
			ie_tipo_contratacao,
			ds_tipo_contratacao,
			ie_segmentacao,
			ds_segmentacao,
			nr_contrato,
			vl_pagar,
			vl_evento,
			vl_glosa,
			dt_pagamento,
			dt_contabilizacao,
			dt_conhecimento,
			dt_vencimento,
                        dt_ocorrencia,
			nr_titulo,
			cd_conta_contrapartida,
			cd_conta_contabil,
			ie_tipo_livro,
			nr_linha,
			nr_seq_reg_auxiliar,
			nr_seq_segurado,
			nr_seq_prestador,
			dt_referencia,
			nr_seq_pagador,
			nr_protocolo_ans,
			ds_observacao,
			cd_material_ops,
			ds_operacao)
		(SELECT	nextval('w_ctb_livro_aux_event_liq_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_documento,
			cd_beneficiario,
			nm_usuario_evento,
			nr_cpf_cnpj_adic,
			nm_pagador,
			ie_tipo_segurado,
			ds_tipo_segurado,
			nm_prestador,
			ie_tipo_documento,
			ds_tipo_documento,
			ie_preco,
			ds_preco,
			ie_regulamentacao,
			ds_regulamentacao,
			ie_tipo_contratacao,
			ds_tipo_contratacao,
			ie_segmentacao,
			ds_segmentacao,
			nr_contrato,
			vl_pagar,
			vl_evento,
			vl_glosa,
			dt_liquidacao,
			dt_contabilizacao,
			dt_conhecimento,
			dt_vencimento,
                        dt_ocorrencia,
			nr_titulo,
			cd_conta_deb,
			cd_conta_cred,
			8,
			row_number() OVER () AS nr_linha,
			nr_seq_registro_p,
			nr_seq_segurado,
			nr_seq_prestador,
			dt_final_w,
			nr_seq_titular,
			nr_protocolo_ans,
			ds_observacao,
			cd_abi,
			nr_aih
		from	(	
			SELECT 	c.nr_sequencia nr_documento,
				substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
				substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_usuario_evento,
				substr(coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')),1,20) nr_cpf_cnpj_adic,
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_pagador,
				s.ie_tipo_segurado,
				obter_valor_dominio(2406,s.ie_tipo_segurado) ds_tipo_segurado,
				pls_obter_desc_prest_processo(c.nr_seq_prestador) nm_prestador,
				'PC' ie_tipo_documento,
				obter_valor_dominio(8372,'PC') ds_tipo_documento,
				a.ie_preco,
				obter_valor_dominio(1669,a.ie_preco) ds_preco,
				a.ie_regulamentacao,
				obter_valor_dominio(2157,a.ie_regulamentacao) ds_regulamentacao,
				a.ie_tipo_contratacao,
				obter_valor_dominio(1666,a.ie_tipo_contratacao) ds_tipo_contratacao,
				a.ie_segmentacao,
				obter_valor_dominio(1665,a.ie_segmentacao) ds_segmentacao,
				r.nr_contrato,
				round((dividir(c.vl_ressarcir, t.vl_titulo) * obter_saldo_titulo_pagar(t.nr_titulo,dt_final_w))::numeric,2) vl_pagar,
				coalesce(c.vl_ressarcir, pls_conta_processo_obter_valor(c.nr_sequencia)) vl_evento,
				coalesce(c.vl_deferido,0) vl_glosa,
				t.dt_liquidacao,
				p.dt_processo dt_contabilizacao,
				coalesce(p.dt_recebimento,p.dt_processo) dt_conhecimento,
				t.dt_vencimento_atual dt_vencimento,
                                c.dt_internacao dt_ocorrencia,
				t.nr_titulo,
				c.cd_conta_deb,
				c.cd_conta_cred,
				s.nr_sequencia nr_seq_segurado,
				c.nr_seq_prestador,
				coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
				CASE WHEN a.ie_tipo_operacao='A' THEN 'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
				CASE WHEN s.ie_tipo_segurado='C' THEN ds_observacao_w WHEN s.ie_tipo_segurado='I' THEN ds_observacao_w WHEN s.ie_tipo_segurado='T' THEN ds_observacao_w  ELSE null END  ds_observacao,
				p.cd_abi cd_abi,
				c.nr_aih nr_aih				
			FROM pls_processo_gru g, pls_processo p
LEFT OUTER JOIN titulo_pagar t ON (p.nr_sequencia = t.nr_seq_processo)
, pls_processo_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
LEFT OUTER JOIN pls_plano a ON (s.nr_seq_plano = a.nr_sequencia)
WHERE p.nr_sequencia		= c.nr_seq_processo     and t.nr_seq_proc_gru	= g.nr_sequencia and c.nr_seq_proc_gru	= g.nr_sequencia and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(s.ie_tipo_segurado,'X'))
			or (coalesce(ie_tipo_segurado_w,'X') = 'X')) and p.dt_processo between dt_inicial_w and dt_final_w
			
union all

			select 	c.nr_sequencia nr_documento,
				substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
				substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_usuario_evento,
				substr(coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')),1,20) nr_cpf_cnpj_adic,
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_pagador,
				s.ie_tipo_segurado,
				obter_valor_dominio(2406,s.ie_tipo_segurado) ds_tipo_segurado,
				pls_obter_desc_prest_processo(c.nr_seq_prestador) nm_prestador,
				'PC' ie_tipo_documento,
				obter_valor_dominio(8372,'PC') ds_tipo_documento,
				a.ie_preco,
				obter_valor_dominio(1669,a.ie_preco) ds_preco,
				a.ie_regulamentacao,
				obter_valor_dominio(2157,a.ie_regulamentacao) ds_regulamentacao,
				a.ie_tipo_contratacao,
				obter_valor_dominio(1666,a.ie_tipo_contratacao) ds_tipo_contratacao,
				a.ie_segmentacao,
				obter_valor_dominio(1665,a.ie_segmentacao) ds_segmentacao,
				r.nr_contrato,
				0 vl_pagar,
				coalesce(c.vl_ressarcir, pls_conta_processo_obter_valor(c.nr_sequencia)) vl_evento,
				coalesce(c.vl_deferido,0) vl_glosa,
				null dt_liquidacao,
				p.dt_processo dt_contabilizacao,
				coalesce(p.dt_recebimento,p.dt_processo) dt_conhecimento,
				null dt_vencimento,
                                c.dt_internacao dt_ocorrencia,
				null nr_titulo,
				c.cd_conta_deb,
				c.cd_conta_cred,
				s.nr_sequencia nr_seq_segurado,
				c.nr_seq_prestador,
				coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
				CASE WHEN a.ie_tipo_operacao='A' THEN 'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
				CASE WHEN s.ie_tipo_segurado='C' THEN ds_observacao_w WHEN s.ie_tipo_segurado='I' THEN ds_observacao_w WHEN s.ie_tipo_segurado='T' THEN ds_observacao_w  ELSE null END  ds_observacao,
				p.cd_abi cd_abi,
				c.nr_aih nr_aih				
			FROM pls_processo p, pls_processo_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
LEFT OUTER JOIN pls_plano a ON (s.nr_seq_plano = a.nr_sequencia)
WHERE p.nr_sequencia		= c.nr_seq_processo    and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(s.ie_tipo_segurado,'X'))
			or (coalesce(ie_tipo_segurado_w,'X') = 'X')) and p.dt_processo between dt_inicial_w and dt_final_w and coalesce(c.nr_seq_proc_gru::text, '') = ''
			 
union all

			select 	c.nr_sequencia nr_documento,
				substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
				substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_usuario_evento,
				substr(coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')),1,20) nr_cpf_cnpj_adic,
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_pagador,
				s.ie_tipo_segurado,
				obter_valor_dominio(2406,s.ie_tipo_segurado) ds_tipo_segurado,
				pls_obter_desc_prest_processo(c.nr_seq_prestador) nm_prestador,
				'PR' ie_tipo_documento,
				obter_valor_dominio(8372,'PR') ds_tipo_documento,
				a.ie_preco,
				obter_valor_dominio(1669,a.ie_preco) ds_preco,
				a.ie_regulamentacao,
				obter_valor_dominio(2157,a.ie_regulamentacao) ds_regulamentacao,
				a.ie_tipo_contratacao,
				obter_valor_dominio(1666,a.ie_tipo_contratacao) ds_tipo_contratacao,
				a.ie_segmentacao,
				obter_valor_dominio(1665,a.ie_segmentacao) ds_segmentacao,
				r.nr_contrato,
				0 vl_pagar,
				coalesce(b.vl_provisao, 0) vl_evento,
				0 vl_glosa,
				t.dt_liquidacao,
				p.dt_processo dt_contabilizacao,
				coalesce(p.dt_recebimento,p.dt_processo) dt_conhecimento,
				t.dt_vencimento_atual dt_vencimento,
                                c.dt_internacao dt_ocorrencia,
				t.nr_titulo,
				b.cd_conta_deb_prov,
				b.cd_conta_cred_prov,
				s.nr_sequencia nr_seq_segurado,
				c.nr_seq_prestador,
				coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
				CASE WHEN a.ie_tipo_operacao='A' THEN 'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
				CASE WHEN s.ie_tipo_segurado='C' THEN ds_observacao_w WHEN s.ie_tipo_segurado='I' THEN ds_observacao_w WHEN s.ie_tipo_segurado='T' THEN ds_observacao_w  ELSE null END  ds_observacao,
				p.cd_abi cd_abi,
				c.nr_aih nr_aih				
			FROM pls_processo_gru g, pls_processo_competencia d, pls_processo_contas_comp b, pls_processo p
LEFT OUTER JOIN titulo_pagar t ON (p.nr_sequencia = t.nr_seq_processo)
, pls_processo_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
LEFT OUTER JOIN pls_plano a ON (s.nr_seq_plano = a.nr_sequencia)
WHERE p.nr_sequencia		= c.nr_seq_processo     and t.nr_seq_proc_gru	= g.nr_sequencia and c.nr_seq_proc_gru	= g.nr_sequencia and b.nr_seq_conta 		= c.nr_sequencia and b.nr_seq_competencia 	= d.nr_sequencia and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(s.ie_tipo_segurado,'X'))
			or (coalesce(ie_tipo_segurado_w,'X') = 'X')) and d.dt_competencia between dt_inicial_w and dt_final_w and b.ie_tipo_movimentacao = 'P' and coalesce(b.vl_provisao, 0) <> 0
			 
union all

			select 	c.nr_sequencia nr_documento,
				substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
				substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_usuario_evento,
				substr(coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')),1,20) nr_cpf_cnpj_adic,
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_pagador,
				s.ie_tipo_segurado,
				obter_valor_dominio(2406,s.ie_tipo_segurado) ds_tipo_segurado,
				pls_obter_desc_prest_processo(c.nr_seq_prestador) nm_prestador,
				'PR' ie_tipo_documento,
				obter_valor_dominio(8372,'PR') ds_tipo_documento,
				a.ie_preco,
				obter_valor_dominio(1669,a.ie_preco) ds_preco,
				a.ie_regulamentacao,
				obter_valor_dominio(2157,a.ie_regulamentacao) ds_regulamentacao,
				a.ie_tipo_contratacao,
				obter_valor_dominio(1666,a.ie_tipo_contratacao) ds_tipo_contratacao,
				a.ie_segmentacao,
				obter_valor_dominio(1665,a.ie_segmentacao) ds_segmentacao,
				r.nr_contrato,
				0 vl_pagar,
				coalesce(b.vl_provisao, 0) vl_evento,
				0 vl_glosa,
				null dt_liquidacao,
				p.dt_processo dt_contabilizacao,
				coalesce(p.dt_recebimento,p.dt_processo) dt_conhecimento,
				null dt_vencimento,
                                c.dt_internacao dt_ocorrencia,
				null nr_titulo,
				b.cd_conta_deb_prov,
				b.cd_conta_cred_prov,
				s.nr_sequencia nr_seq_segurado,
				c.nr_seq_prestador,
				coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
				CASE WHEN a.ie_tipo_operacao='A' THEN 'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
				CASE WHEN s.ie_tipo_segurado='C' THEN ds_observacao_w WHEN s.ie_tipo_segurado='I' THEN ds_observacao_w WHEN s.ie_tipo_segurado='T' THEN ds_observacao_w  ELSE null END  ds_observacao,
				p.cd_abi cd_abi,
				c.nr_aih nr_aih				
			FROM pls_processo p, pls_processo_competencia d, pls_processo_contas_comp b, pls_processo_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
LEFT OUTER JOIN pls_plano a ON (s.nr_seq_plano = a.nr_sequencia)
WHERE p.nr_sequencia		= c.nr_seq_processo    and b.nr_seq_conta 		= c.nr_sequencia and b.nr_seq_competencia 	= d.nr_sequencia and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(s.ie_tipo_segurado,'X'))
			or (coalesce(ie_tipo_segurado_w,'X') = 'X')) and d.dt_competencia between dt_inicial_w and dt_final_w and coalesce(c.nr_seq_proc_gru::text, '') = '' and b.ie_tipo_movimentacao = 'P' and coalesce(b.vl_provisao, 0) <> 0
			 
union all
			
			select 	c.nr_sequencia nr_documento,
				substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
				substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_usuario_evento,
				substr(coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')),1,20) nr_cpf_cnpj_adic,
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_pagador,
				s.ie_tipo_segurado,
				obter_valor_dominio(2406,s.ie_tipo_segurado) ds_tipo_segurado,
				pls_obter_desc_prest_processo(c.nr_seq_prestador) nm_prestador,
				'AJ' ie_tipo_documento,
				obter_valor_dominio(8372,'AJ') ds_tipo_documento,
				a.ie_preco,
				obter_valor_dominio(1669,a.ie_preco) ds_preco,
				a.ie_regulamentacao,
				obter_valor_dominio(2157,a.ie_regulamentacao) ds_regulamentacao,
				a.ie_tipo_contratacao,
				obter_valor_dominio(1666,a.ie_tipo_contratacao) ds_tipo_contratacao,
				a.ie_segmentacao,
				obter_valor_dominio(1665,a.ie_segmentacao) ds_segmentacao,
				r.nr_contrato,
				0 vl_pagar,
				coalesce(b.vl_ajuste, 0) vl_evento,
				0 vl_glosa,
				t.dt_liquidacao,
				p.dt_processo dt_contabilizacao,
				coalesce(p.dt_recebimento,p.dt_processo) dt_conhecimento,
				t.dt_vencimento_atual dt_vencimento,
                                c.dt_internacao dt_ocorrencia,
				t.nr_titulo,
				b.cd_conta_deb_ajuste,
				b.cd_conta_cred_ajuste,
				s.nr_sequencia nr_seq_segurado,
				c.nr_seq_prestador,
				coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
				CASE WHEN a.ie_tipo_operacao='A' THEN 'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
				CASE WHEN s.ie_tipo_segurado='C' THEN ds_observacao_w WHEN s.ie_tipo_segurado='I' THEN ds_observacao_w WHEN s.ie_tipo_segurado='T' THEN ds_observacao_w  ELSE null END  ds_observacao,
				p.cd_abi cd_abi,
				c.nr_aih nr_aih				
			FROM pls_processo_gru g, pls_processo_competencia d, pls_processo_contas_comp b, pls_processo p
LEFT OUTER JOIN titulo_pagar t ON (p.nr_sequencia = t.nr_seq_processo)
, pls_processo_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
LEFT OUTER JOIN pls_plano a ON (s.nr_seq_plano = a.nr_sequencia)
WHERE p.nr_sequencia		= c.nr_seq_processo     and t.nr_seq_proc_gru	= g.nr_sequencia and c.nr_seq_proc_gru	= g.nr_sequencia and b.nr_seq_conta 		= c.nr_sequencia and b.nr_seq_competencia 	= d.nr_sequencia and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(s.ie_tipo_segurado,'X'))
			or (coalesce(ie_tipo_segurado_w,'X') = 'X')) and d.dt_competencia between dt_inicial_w and dt_final_w and coalesce(b.vl_ajuste, 0) <> 0 and b.ie_tipo_movimentacao = 'P'
			 
union all

			select 	c.nr_sequencia nr_documento,
				substr(pls_obter_dados_segurado(s.nr_sequencia,'C'),1,255) cd_beneficiario,
				substr(pls_obter_dados_segurado(s.nr_sequencia,'N'),1,255) nm_usuario_evento,
				substr(coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'),pls_obter_dados_pagador(s.nr_seq_pagador,'CGC')),1,20) nr_cpf_cnpj_adic,
				substr(pls_obter_dados_pagador(s.nr_seq_pagador,'N'),1,255) nm_pagador,
				s.ie_tipo_segurado,
				obter_valor_dominio(2406,s.ie_tipo_segurado) ds_tipo_segurado,
				pls_obter_desc_prest_processo(c.nr_seq_prestador) nm_prestador,
				'PC' ie_tipo_documento,
				obter_valor_dominio(8372,'AJ') ds_tipo_documento,
				a.ie_preco,
				obter_valor_dominio(1669,a.ie_preco) ds_preco,
				a.ie_regulamentacao,
				obter_valor_dominio(2157,a.ie_regulamentacao) ds_regulamentacao,
				a.ie_tipo_contratacao,
				obter_valor_dominio(1666,a.ie_tipo_contratacao) ds_tipo_contratacao,
				a.ie_segmentacao,
				obter_valor_dominio(1665,a.ie_segmentacao) ds_segmentacao,
				r.nr_contrato,
				0 vl_pagar,
				coalesce(b.vl_ajuste, 0) vl_evento,
				0 vl_glosa,
				null dt_liquidacao,
				p.dt_processo dt_contabilizacao,
				coalesce(p.dt_recebimento,p.dt_processo) dt_conhecimento,
				null dt_vencimento,
                                c.dt_internacao dt_ocorrencia,
				null nr_titulo,
				b.cd_conta_deb_ajuste,
				b.cd_conta_cred_ajuste,
				s.nr_sequencia nr_seq_segurado,
				c.nr_seq_prestador,
				coalesce(s.nr_seq_titular,s.nr_sequencia) nr_seq_titular,
				CASE WHEN a.ie_tipo_operacao='A' THEN 'SCA'  ELSE coalesce(a.nr_protocolo_ans, a.cd_scpa) END  nr_protocolo_ans,
				CASE WHEN s.ie_tipo_segurado='C' THEN ds_observacao_w WHEN s.ie_tipo_segurado='I' THEN ds_observacao_w WHEN s.ie_tipo_segurado='T' THEN ds_observacao_w  ELSE null END  ds_observacao,
				p.cd_abi cd_abi,
				c.nr_aih nr_aih				
			FROM pls_processo p, pls_processo_competencia d, pls_processo_contas_comp b, pls_processo_conta c
LEFT OUTER JOIN pls_segurado s ON (c.nr_seq_segurado = s.nr_sequencia)
LEFT OUTER JOIN pls_contrato r ON (s.nr_seq_contrato = r.nr_sequencia)
LEFT OUTER JOIN pls_plano a ON (s.nr_seq_plano = a.nr_sequencia)
WHERE p.nr_sequencia		= c.nr_seq_processo    and b.nr_seq_conta 		= c.nr_sequencia and b.nr_seq_competencia 	= d.nr_sequencia and ((coalesce(ie_tipo_segurado_w,'X') = coalesce(s.ie_tipo_segurado,'X'))
			or (coalesce(ie_tipo_segurado_w,'X') = 'X')) and d.dt_competencia between dt_inicial_w and dt_final_w and coalesce(c.nr_seq_proc_gru::text, '') = '' and coalesce(b.vl_ajuste, 0) <> 0 and b.ie_tipo_movimentacao = 'P' order by nr_documento) alias182);

	commit;
	
elsif (ie_gerar_arquivo_p = 'S') then
	
	nm_arquivo_w	:= 'RegAuxEventosRessarcSUS' || to_char(clock_timestamp(),'ddmmyyyyhh24miss') || nm_usuario_p || '.csv';
	ds_nome_livro_w	:= 'Registro Auxiliar de Eventos Ressarcimento SUS';
	ds_periodo_w	:= 'Período: ' || dt_inicial_w || ' à ' || dt_final_w || ';' || ' Liberação: ' || dt_liberacao_w;
	
	SELECT * FROM obter_evento_utl_file(1, null, ds_local_w, ds_erro_w) INTO STRICT ds_local_w, ds_erro_w;

	arq_texto_w := utl_file.fopen(ds_local_w,nm_arquivo_w,'W'); --arq_texto_w := utl_file.fopen('/srvfs03/FINANCEIRO/TASY/',nm_arquivo_w,'W');
	utl_file.put_line(arq_texto_w, ds_nome_livro_w);
	utl_file.put_line(arq_texto_w, ds_periodo_w);
	utl_file.put_line(arq_texto_w, ds_rotulo_w);
	utl_file.fflush(arq_texto_w);
	for vetl in c_linha loop
		begin
		utl_file.put_line(arq_texto_w,vetl.ds_linha);
		utl_file.fflush(arq_texto_w);
		end;
	end loop;

end if;

CALL wheb_usuario_pck.set_ie_executar_trigger('S');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_evento_ressarc_sus ( nr_seq_registro_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_gerar_arquivo_p text) FROM PUBLIC;

