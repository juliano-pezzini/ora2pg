-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE change_dates_encounter ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, dt_entrada_p atendimento_paciente.dt_entrada%type, nm_usuario_p atendimento_paciente.nm_usuario%type) AS $body$
DECLARE


qt_episodio_paciente_w	integer;


BEGIN

	if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') in ('de_DE', 'de_AT') and
		(nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and
			(dt_entrada_p IS NOT NULL AND dt_entrada_p::text <> ''))then

			update	atend_paciente_unidade apu
			set	apu.dt_entrada_unidade = dt_entrada_p
			where	apu.nr_atendimento = nr_atendimento_p
			and	apu.nr_seq_interno = (	SELECT 	min(apu2.nr_seq_interno)
							from	atend_paciente_unidade apu2
							where	apu2.nr_atendimento = apu.nr_atendimento);

			select 	count(*)
			into STRICT	qt_episodio_paciente_w
			from	atendimento_paciente ap
			where	ap.nr_seq_episodio in (	SELECT  ap2.nr_seq_episodio
							from    atendimento_paciente ap2
							where   ap2.nr_atendimento = nr_atendimento_p);

			if ( qt_episodio_paciente_w = 1 ) then

				update  episodio_paciente
				set	dt_episodio = dt_entrada_p,
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp()
				where	nr_sequencia in ( SELECT  ap.nr_seq_episodio
							  from    atendimento_paciente ap 
							  where   ap.nr_atendimento = nr_atendimento_p);
			end if;
	
			commit;
	end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE change_dates_encounter ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, dt_entrada_p atendimento_paciente.dt_entrada%type, nm_usuario_p atendimento_paciente.nm_usuario%type) FROM PUBLIC;

