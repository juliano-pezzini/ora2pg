-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gera_cobr_msg_itau_400_reg0117 ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_grupo_inst_p bigint) AS $body$
DECLARE


/*===========================================================
	             =>>>>>	A T E N Ç Ã O        <<<<<<=
Versao de Janeiro de 2017 0117

Esta procedure é uma cópia da GERAR_COBRANCA_ITAU_400,
para atender a OS  1180588,
layout anexo nesta OS.

Como se trata de um projeto e não possuímos cliente para validar junto
ao banco, os defeitos devem ser verificados com o analista (Peterson) antes
de serem documentados.
============================================================*/
ds_conteudo_w			varchar(400)	:= null;
nr_seq_reg_arquivo_w		bigint	:= 1;
cd_conta_cobr_w			varchar(5);
cd_agencia_cobr_w		varchar(4);
nm_empresa_w			varchar(30);
dt_geracao_w			varchar(6);
ie_digito_conta_cobr_w		varchar(1);
cd_banco_w			smallint;
nr_seq_carteira_cobr_w		bigint;
nr_carteira_w			varchar(3);

/* detalhe */

ie_tipo_inscricao_w			varchar(2);
nr_inscricao_empresa_w		varchar(14);
cd_agencia_bancaria_w		varchar(4);
cd_conta_w			varchar(6);
nr_nosso_numero_w		varchar(8);
vl_multa_w			double precision;
nr_titulo_w			bigint;
dt_vencimento_w			timestamp;
vl_titulo_w			double precision;
dt_emissao_w			timestamp;
vl_juros_w			double precision;
vl_desconto_w			double precision;
nm_pessoa_w			varchar(40);
ds_endereco_w			varchar(40);
ds_bairro_w			varchar(12);
cd_cep_w			varchar(8);
ds_cidade_w			varchar(15);
sg_estado_w			varchar(15);
tx_juros_w			double precision;
tx_multa_w			double precision;
ds_tipo_juros_w			varchar(255);
ds_tipo_multa_w			varchar(255);
ie_digito_nosso_num_w		varchar(1);
nr_telefone_w			varchar(15);
nr_seq_carteira_cobr_tit_w		titulo_receber.nr_seq_carteira_cobr%type;
cd_flash_w			banco_estabelecimento.cd_flash%type;
nr_inscricao_w			varchar(14);
nr_linha_um_w			bigint;
nr_linha_dois_w			bigint;
nr_linha_tres_w			bigint;

nr_seq_conta_proc_w		pls_conta_proc.nr_sequencia%type;
nr_seq_conta_mat_w		pls_conta_proc.nr_sequencia%type;

ds_mensagem_w			varchar(140);
ds_mensagem_um_w		varchar(140);
ds_mensagem_dois_w		varchar(140);
ds_mensagem_tres_w		varchar(140);
ie_aplicacao_mensagem_w		banco_instrucao_boleto.ie_aplicacao_mensagem%type;
ie_posicao_w			banco_instrucao_boleto.ie_posicao%type;
nr_linha_w			banco_instrucao_boleto.nr_linha%type;
ds_mensagem_concat_w		varchar(4000)	:= '';
nr_linha_anterior_w			banco_instrucao_boleto.nr_linha%type;
qt_reg_w				bigint;
cont_cursor_w			bigint	:= 0;
qt_msg_um_w			bigint;
qt_msg_dois_w			bigint;
ie_mensagem				varchar(1);

nr_seq_grupo_inst_w		bigint;

c01 CURSOR FOR
SELECT	CASE WHEN coalesce(b.cd_pessoa_fisica::text, '') = '' THEN '02'  ELSE '01' END  ie_tipo_inscricao,
	coalesce(c.nr_cpf,b.cd_cgc) nr_inscricao_empresa,
	lpad(a.cd_agencia_bancaria,4,'0') cd_agencia_bancaria,
	lpad(substr(a.nr_conta,1,5) || substr(a.ie_digito_conta,1,1),6,'0') cd_conta,
	lpad(substr(coalesce(b.nr_nosso_numero,'0'),1,8),8,'0') nr_nosso_numero,
	CASE WHEN coalesce(a.vl_multa,0)=0 THEN obter_juros_multa_titulo(b.nr_titulo,clock_timestamp(),'R','M')  ELSE a.vl_multa END ,
	a.nr_titulo,
	b.dt_pagamento_previsto,
	b.vl_saldo_titulo,
	b.dt_emissao,
	CASE WHEN coalesce(a.vl_juros,0)=0 THEN obter_juros_multa_titulo(b.nr_titulo,clock_timestamp(),'R','J')  ELSE a.vl_juros END ,
	a.vl_desconto,
	substr(obter_nome_pf_pj(b.cd_pessoa_fisica,b.cd_cgc),1,40) nm_pessoa,
	rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'E'),1,40),' '),40,' ') ds_endereco,
	rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'B'),1,12),' '),12,' ') ds_bairro,
	lpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'CEP'),1,8),'0'),8,'0') cd_cep,
	rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'CI'),1,15),' '),15,' ') ds_cidade,
	rpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'UF'),1,2),' '),2,' ') sg_estado,
	b.tx_juros,
	b.tx_multa,
	substr(obter_valor_dominio(707,b.cd_tipo_taxa_juro),1,255) ds_tipo_juros,
	substr(obter_valor_dominio(707,b.cd_tipo_taxa_multa),1,255) ds_tipo_multa,
	b.nr_seq_carteira_cobr
FROM titulo_receber_cobr a, titulo_receber b
LEFT OUTER JOIN pessoa_fisica c ON (b.cd_pessoa_fisica = c.cd_pessoa_fisica)
WHERE a.nr_titulo		= b.nr_titulo and a.nr_seq_cobranca	= nr_seq_cobr_escrit_p;

c04 CURSOR FOR
SELECT	f.nr_sequencia nr_seq_conta_proc,
	null nr_seq_conta_mat
from	pls_conta_proc f,
	pls_conta e,
	pls_mensalidade_seg_item a,
	pls_mensalidade_segurado b,
	pls_mensalidade c,
	titulo_receber d
where	b.nr_sequencia	= a.nr_seq_mensalidade_seg
and	c.nr_sequencia	= b.nr_seq_mensalidade
and	e.nr_sequencia	= a.nr_seq_conta
and	e.nr_sequencia	= f.nr_seq_conta
and	(a.nr_seq_conta IS NOT NULL AND a.nr_seq_conta::text <> '')
and	c.nr_sequencia	= d.nr_seq_mensalidade
and	d.nr_titulo	= nr_titulo_w

union all

select	null nr_seq_conta_proc,
	f.nr_sequencia nr_seq_conta_mat
from	pls_conta_mat f,
	pls_conta e,
	pls_mensalidade_seg_item a,
	pls_mensalidade_segurado b,
	pls_mensalidade c,
	titulo_receber d
where	b.nr_sequencia	= a.nr_seq_mensalidade_seg
and	c.nr_sequencia	= b.nr_seq_mensalidade
and	e.nr_sequencia	= a.nr_seq_conta
and	e.nr_sequencia	= f.nr_seq_conta
and	(a.nr_seq_conta IS NOT NULL AND a.nr_seq_conta::text <> '')
and	c.nr_sequencia	= d.nr_seq_mensalidade
and	d.nr_titulo	= nr_titulo_w;

c05 CURSOR FOR
SELECT	substr(obter_instrucao_boleto_tam(nr_titulo_w,cd_banco_w,a.nr_linha,ie_posicao_w,nr_seq_conta_proc_w,nr_seq_conta_mat_w,a.nr_sequencia),1,140) ds_mensagem
from	banco_instrucao_boleto a
where	coalesce(a.ie_posicao,'F')			= ie_posicao_w
and	coalesce(a.ie_aplicacao_mensagem,'T')	= ie_aplicacao_mensagem_w
and	a.cd_banco			= cd_banco_w
and	coalesce(a.nr_linha,0)			= coalesce(nr_linha_w,0)
and	coalesce(a.nr_seq_grupo,0)		= coalesce(nr_seq_grupo_inst_w,coalesce(a.nr_seq_grupo,0))
order by	a.nr_linha;

c06 CURSOR FOR
SELECT	distinct
	coalesce(a.nr_linha,0) nr_linha
from	banco_instrucao_boleto a
where	coalesce(a.ie_posicao,'F')			= coalesce(ie_posicao_w,'X')
and	coalesce(a.ie_aplicacao_mensagem,'T')	= coalesce(ie_aplicacao_mensagem_w,'X')
and	a.cd_banco			= coalesce(cd_banco_w,0)
and	coalesce(a.nr_seq_grupo,0)		= coalesce(nr_seq_grupo_inst_w,coalesce(a.nr_seq_grupo,0))
order by	1;


BEGIN

delete	FROM w_envio_banco
where	nm_usuario = nm_usuario_p;

if (coalesce(nr_seq_grupo_inst_p,0)	= 0) then

	nr_seq_grupo_inst_w	:= null;

else

	nr_seq_grupo_inst_w	:= nr_seq_grupo_inst_p;

end if;

/* header */

select	lpad(coalesce(b.cd_conta,'0'),5,'0'),
	lpad(coalesce(b.cd_agencia_bancaria,'0'),4,'0'),
	substr(coalesce(b.ie_digito_conta,'0'),1,1),
	rpad(substr(obter_nome_estabelecimento(cd_estabelecimento_p),1,30),30,' ') nm_empresa,
	to_char(clock_timestamp(),'DDMMYY'),
	a.nr_seq_carteira_cobr,
	b.cd_banco,
	rpad(coalesce(substr(b.cd_flash,1,3),'LWZ'),3,' ') cd_flash,
	c.cd_cgc nr_inscricao
into STRICT	cd_conta_cobr_w,
	cd_agencia_cobr_w,
	ie_digito_conta_cobr_w,
	nm_empresa_w,
	dt_geracao_w,
	nr_seq_carteira_cobr_w,
	cd_banco_w,
	cd_flash_w,
	nr_inscricao_w
from	estabelecimento c,
	banco_estabelecimento b,
	cobranca_escritural a
where	a.cd_estabelecimento	= c.cd_estabelecimento
and	a.nr_seq_conta_banco	= b.nr_sequencia
and	a.nr_sequencia		= nr_seq_cobr_escrit_p;

select	substr(max(a.cd_carteira),1,3) nr_carteira
into STRICT	nr_carteira_w
from	banco_carteira a
where	a.nr_sequencia 	= nr_seq_carteira_cobr_w
and	a.cd_banco	= cd_banco_w;

select	max(b.nr_telefone)
into STRICT	nr_telefone_w
from	pessoa_juridica b,
	estabelecimento a
where	a.cd_cgc		= b.cd_cgc
and	a.cd_estabelecimento	= cd_estabelecimento_p;

ds_conteudo_w	:= 	'0' 								|| /*Pos 01*/
					'1' 								|| /*Pos 02 */
					'REMESSA' 							|| /*Pos 03 a 09*/
					'01' 								|| /*Pos 10 a 11*/
					rpad('COBRANCA',15,' ') 			|| /*Pos 12 a 26*/
					cd_agencia_cobr_w 					|| /*Pos 27 a 30*/
					'00' 								|| /*Pos 31 a 32*/
					cd_conta_cobr_w 					|| /*Pos 33 a 37*/
					ie_digito_conta_cobr_w 				|| /*Pos 38*/
					rpad(' ',8,' ') 					|| /*Pos 39 a 46*/
					nm_empresa_w 						|| /*Pos 47 a 76*/
					lpad(cd_banco_w,3,'0') 				|| /*Pos 77 a 79*/
					rpad('BANCO ITAU SA',15,' ') 		|| /*Pos 80 a 94*/
					dt_geracao_w 						|| /*Pos 95 a 100*/
					rpad(' ',294,' ') 					|| /*Pos 101 a 394*/
					lpad(nr_seq_reg_arquivo_w,6,'0');      /*Pos 395 a 400*/
insert into w_envio_banco(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	cd_estabelecimento,
	ds_conteudo,
	nr_seq_apres)
values (nextval('w_envio_banco_seq'),
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	cd_estabelecimento_p,
	ds_conteudo_w,
	nr_seq_reg_arquivo_w);

/* detalhe */

open	C01;
loop
fetch	C01 into
	ie_tipo_inscricao_w,
	nr_inscricao_empresa_w,
	cd_agencia_bancaria_w,
	cd_conta_w,
	nr_nosso_numero_w,
	vl_multa_w,
	nr_titulo_w,
	dt_vencimento_w,
	vl_titulo_w,
	dt_emissao_w,
	vl_juros_w,
	vl_desconto_w,
	nm_pessoa_w,
	ds_endereco_w,
	ds_bairro_w,
	cd_cep_w,
	ds_cidade_w,
	sg_estado_w,
	tx_juros_w,
	tx_multa_w,
	ds_tipo_juros_w,
	ds_tipo_multa_w,
	nr_seq_carteira_cobr_tit_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

	if (coalesce(nr_carteira_w::text, '') = '') then

		select	substr(max(a.cd_carteira),1,3) nr_carteira
		into STRICT	nr_carteira_w
		from	banco_carteira a
		where	a.nr_sequencia 	= nr_seq_carteira_cobr_tit_w;

	end if;

	/*
	(3) NOSSO NÚMERO
	Para carteiras com registro:
	Escriturais: é enviado zerado pela empresa e retornado pelo  Itaú  na confirmação  do registro, com
	exceção da carteira 115 e 138cuja faixa de Nosso Número é de livre utilização pelo beneficiário; */
	if (nr_carteira_w not in ('115','138')) then /*Se carteira diferente de 115, vai zerado pro Banco.*/
		nr_nosso_numero_w := lpad('0',8,'0');
	end if;

	nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;

	/* Registro Detalhe (obrigatório) */

	ds_conteudo_w	:=	'1' 																		|| /*Pos 01*/
						'02' 																		|| /*Pos 02 a 03*/
						lpad(coalesce(nr_inscricao_w,'0'),14,'0') 										|| /*Pos 04 a 17*/
						lpad(cd_agencia_bancaria_w,4,'0') 											|| /*Pos 18 a 21*/
						'00' 																		|| /*Pos 22 a 23*/
						lpad(cd_conta_w,6,'0') 														|| /*Pos 24 a 28 e 28 e 29 - Codigo conta e DAC conta*/
						rpad(' ',4,' ')	 															|| /*Pos 30 a 33*/
						'0000' 																		|| /*Pos 34 a 37*/
						lpad(nr_titulo_w,25,'0') 													|| /*Pos 38 a 62*/
						lpad(nr_nosso_numero_w,8,'0') 												|| /*Pos 63 a 70*/
						'0000000000000' 															|| /*Pos 71 a 83*/
						lpad(coalesce(nr_carteira_w,'0'),3,'0') 											|| /*Pos 84 a 86*/
						rpad(' ',21,' ') 															|| /*Pos 87 a 107*/
						'I' 																		|| /*Pos 108*/
						'01' 																		|| /*Pos 109 a 110*/
						rpad(' ',10,' ') 															|| /*Pos 111 a 120*/
						to_char(dt_vencimento_w,'ddmmyy') 											|| /*Pos 121 a 126*/
						lpad(somente_numero(to_char(coalesce(vl_titulo_w,0),'99999999990.00')),13,'0') 	|| /*Pos 127 a 139*/
						lpad(cd_banco_w,3,'0') 														|| /*Pos 140 a 142*/
						'00000' 																	|| /*Pos 143 a 147*/
						'99' 																		|| /*Pos 148 a 149*/
						'A' 																		|| /*Pos 150*/
						to_char(dt_emissao_w,'ddmmyy') 												|| /*Pos 151 a 156*/
						'0505' 																		|| /*Pos 157 a 158 a 159 a 160*/
						lpad(somente_numero(to_char(coalesce(vl_juros_w,0),'99999999990.00')),13,'0') 	|| /*Pos 161 a 173*/
						to_char(dt_vencimento_w,'ddmmyy') 											|| /*Pos 174 a 179*/
						lpad(somente_numero(to_char(coalesce(vl_desconto_w,0),'99999999990.00')),13,'0') || /*Pos 180 a 192*/
						lpad('0',26,'0') 															|| /*Pos 193 a 205 a 206 a 218*/
						ie_tipo_inscricao_w 														|| /*Pos 219 a 220*/
						lpad(coalesce(nr_inscricao_empresa_w,'0'),14,'0') 								|| /*Pos 221 a 234*/
						rpad(nm_pessoa_w,40,' ')											 		|| /*Pos 235 a 264 265 a 274*/
						ds_endereco_w 																|| /*Pos 275 a 314*/
						ds_bairro_w 																|| /*Pos 315 a 326*/
						cd_cep_w 																	|| /*Pos 327 a 334*/
						ds_cidade_w 																|| /*Pos 335 a 349*/
						substr(sg_estado_w,1,2) 													|| /*Pos 350 a 351*/
						rpad(nm_empresa_w,30,' ') 													|| /*Pos 352 a 381*/
						rpad(' ',4,' ') 															|| /*Pos 382 a 385*/
						'000000' 																	|| /*Pos 386 a 391*/
						'00' 																		|| /*Pos 392 a 393*/
						' ' 																		|| /*Pos 394*/
						lpad(nr_seq_reg_arquivo_w,6,'0');											   /*Pos 395 a 400*/
	insert	into w_envio_banco(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_estabelecimento,
		ds_conteudo,
		nr_seq_apres)
	values (nextval('w_envio_banco_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_p,
		ds_conteudo_w,
		nr_seq_reg_arquivo_w);

	nr_linha_um_w	:= 1;
	nr_linha_dois_w	:= 2;
	nr_linha_tres_w	:= 3;

	/* Registro mensagem frente (obrigatório) */

	ie_aplicacao_mensagem_w	:= 'T';
	ie_posicao_w		:= 'F';
	nr_linha_anterior_w	:= null;
	qt_msg_um_w		:= 0;
	qt_msg_dois_w		:= 0;

	open	c06;
	loop
	fetch	c06 into
		nr_linha_w;
	EXIT WHEN NOT FOUND; /* apply on c06 */

		ds_mensagem_concat_w	:= '';
		cont_cursor_w	:= 0;

		select	count(*)
		into STRICT	qt_reg_w
		from	banco_instrucao_boleto a
		where	coalesce(a.ie_posicao,'F')			= ie_posicao_w
		and	coalesce(a.ie_aplicacao_mensagem,'T')	= ie_aplicacao_mensagem_w
		and	a.cd_banco			= cd_banco_w
		and	a.nr_linha				= nr_linha_w
		and	coalesce(a.nr_seq_grupo,0)		= coalesce(nr_seq_grupo_inst_p,coalesce(a.nr_seq_grupo,0));

		open	c05;
		loop
		fetch	c05 into
			ds_mensagem_w;
		EXIT WHEN NOT FOUND; /* apply on c05 */
			cont_cursor_w	:= cont_cursor_w + 1;
			ds_mensagem_concat_w	:= ds_mensagem_concat_w||ds_mensagem_w;
			if (ds_mensagem_concat_w IS NOT NULL AND ds_mensagem_concat_w::text <> '') or (ds_mensagem_concat_w <> '') then

				if	((coalesce(ds_mensagem_um_w::text, '') = '') or (coalesce(nr_linha_anterior_w,nr_linha_w)	= nr_linha_w)) and (qt_msg_um_w	= 0) then

					ds_mensagem_um_w	:= substr(ds_mensagem_concat_w,1,128);
					if (cont_cursor_w 		= qt_reg_w) and (ds_mensagem_um_w IS NOT NULL AND ds_mensagem_um_w::text <> '') then
						qt_msg_um_w	:= 1;
					end if;

				elsif	((coalesce(ds_mensagem_dois_w::text, '') = '') or (coalesce(nr_linha_anterior_w,nr_linha_w)	= nr_linha_w)) and (qt_msg_dois_w	= 0) then

					ds_mensagem_dois_w	:= substr(ds_mensagem_concat_w,1,128);
					if (cont_cursor_w		= qt_reg_w) and (ds_mensagem_dois_w IS NOT NULL AND ds_mensagem_dois_w::text <> '') then
						qt_msg_dois_w	:= 1;
					end if;
				else
					ds_mensagem_tres_w	:= substr(ds_mensagem_concat_w,1,127);
				end if;

			end if;

			if (ds_mensagem_um_w IS NOT NULL AND ds_mensagem_um_w::text <> '') and (ds_mensagem_dois_w IS NOT NULL AND ds_mensagem_dois_w::text <> '') and
				(ds_mensagem_tres_w IS NOT NULL AND ds_mensagem_tres_w::text <> '' AND cont_cursor_w 		= qt_reg_w) then


				nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;
				ds_conteudo_w	:=	'7' ||
							cd_flash_w ||
							lpad(nr_linha_um_w,2,'0') ||
							rpad(coalesce(ds_mensagem_um_w,' '),128,' ') ||
							lpad(nr_linha_dois_w,2,'0') ||
							rpad(coalesce(ds_mensagem_dois_w,' '),128,' ') ||
							lpad(nr_linha_tres_w,2,'0') ||
							rpad(coalesce(ds_mensagem_tres_w,' '),127,' ') ||
							' ' ||
							lpad(nr_seq_reg_arquivo_w,6,'0');

				insert	into w_envio_banco(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					cd_estabelecimento,
					ds_conteudo,
					nr_seq_apres)
				values (nextval('w_envio_banco_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					cd_estabelecimento_p,
					ds_conteudo_w,
					nr_seq_reg_arquivo_w);

				ds_mensagem_um_w	:= null;
				ds_mensagem_dois_w	:= null;
				ds_mensagem_tres_w	:= null;
				nr_linha_um_w		:= coalesce(nr_linha_um_w,0) + 3;
				nr_linha_dois_w		:= coalesce(nr_linha_dois_w,0) + 3;
				nr_linha_tres_w		:= coalesce(nr_linha_tres_w,0) + 3;
				qt_msg_um_w		:= 0;
				qt_msg_dois_w		:= 0;

			end if;
		nr_linha_anterior_w	:= nr_linha_w;
		end	loop;
		close	c05;


	end loop;
	close c06;

	/* Tratar as sobras */

	if (ds_mensagem_um_w IS NOT NULL AND ds_mensagem_um_w::text <> '') then

		nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;


		ds_conteudo_w	:=	'7' ||
					cd_flash_w ||
					lpad(nr_linha_um_w,2,'0') ||
					rpad(coalesce(ds_mensagem_um_w,' '),128,' ') ||
					lpad(nr_linha_dois_w,2,'0') ||
					rpad(coalesce(ds_mensagem_dois_w,' '),128,' ') ||
					lpad(nr_linha_tres_w,2,'0') ||
					rpad(coalesce(ds_mensagem_tres_w,' '),127,' ') ||
					' ' ||
					lpad(nr_seq_reg_arquivo_w,6,'0');

		insert	into w_envio_banco(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_estabelecimento,
			ds_conteudo,
			nr_seq_apres)
		values (nextval('w_envio_banco_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_estabelecimento_p,
			ds_conteudo_w,
			nr_seq_reg_arquivo_w);

		ds_mensagem_um_w	:= null;
		ds_mensagem_dois_w	:= null;
		ds_mensagem_tres_w	:= null;
		nr_linha_um_w		:= coalesce(nr_linha_um_w,0) + 3;
		nr_linha_dois_w		:= coalesce(nr_linha_dois_w,0) + 3;
		nr_linha_tres_w		:= coalesce(nr_linha_tres_w,0) + 3;

	end if;

	ie_aplicacao_mensagem_w	:= 'C';

	qt_msg_um_w		:= 0;
	qt_msg_dois_w		:= 0;
	ie_mensagem			:= 'N';

	open	c04;
	loop
	fetch	c04 into
		nr_seq_conta_proc_w,
		nr_seq_conta_mat_w;
	EXIT WHEN NOT FOUND; /* apply on c04 */
		nr_linha_anterior_w	:= null;
		/* Registro mensagem frente (obrigatório) */

		open	c06;
		loop
		fetch	c06 into
			nr_linha_w;
		EXIT WHEN NOT FOUND; /* apply on c06 */
			ds_mensagem_concat_w	:= '';
			cont_cursor_w	:= 0;

			select	count(*)
			into STRICT	qt_reg_w
			from	banco_instrucao_boleto a
			where	coalesce(a.ie_posicao,'F')			= ie_posicao_w
			and	coalesce(a.ie_aplicacao_mensagem,'T')	= ie_aplicacao_mensagem_w
			and	a.cd_banco				= cd_banco_w
			and	a.nr_linha				= nr_linha_w
			and	coalesce(a.nr_seq_grupo,0)			= coalesce(nr_seq_grupo_inst_p,coalesce(a.nr_seq_grupo,0));

			open	c05;
			loop
			fetch	c05 into
				ds_mensagem_w;
			EXIT WHEN NOT FOUND; /* apply on c05 */
				cont_cursor_w	:= cont_cursor_w + 1;
				ds_mensagem_concat_w	:= ds_mensagem_concat_w||ds_mensagem_w;
				if (ds_mensagem_concat_w IS NOT NULL AND ds_mensagem_concat_w::text <> '') or (ds_mensagem_concat_w <> '') then
					if (coalesce(ds_mensagem_um_w::text, '') = '') or (qt_msg_um_w = 0) then
						ds_mensagem_um_w	:= substr(ds_mensagem_concat_w,1,128);
						if (cont_cursor_w 		= qt_reg_w) and (ds_mensagem_um_w IS NOT NULL AND ds_mensagem_um_w::text <> '') then
							qt_msg_um_w	:= 1;
						end if;
					elsif (coalesce(ds_mensagem_dois_w::text, '') = '') or (qt_msg_dois_w = 0) then
						ds_mensagem_dois_w	:= substr(ds_mensagem_concat_w,1,128);
						if (cont_cursor_w		= qt_reg_w) and (ds_mensagem_dois_w IS NOT NULL AND ds_mensagem_dois_w::text <> '') then
							qt_msg_dois_w	:= 1;
						end if;
					else
						ds_mensagem_tres_w	:= substr(ds_mensagem_concat_w,1,127);

					end if;

				end if;

				if (ds_mensagem_um_w IS NOT NULL AND ds_mensagem_um_w::text <> '') and (ds_mensagem_dois_w IS NOT NULL AND ds_mensagem_dois_w::text <> '') and
					(ds_mensagem_tres_w IS NOT NULL AND ds_mensagem_tres_w::text <> '' AND cont_cursor_w = qt_reg_w) then

					nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;

					ds_conteudo_w	:=	'7' ||
								cd_flash_w ||
								lpad(nr_linha_um_w,2,'0') ||
								rpad(coalesce(ds_mensagem_um_w,' '),128,' ') ||
								lpad(nr_linha_dois_w,2,'0') ||
								rpad(coalesce(ds_mensagem_dois_w,' '),128,' ') ||
								lpad(nr_linha_tres_w,2,'0') ||
								rpad(coalesce(ds_mensagem_tres_w,' '),127,' ') ||
								' ' ||
								lpad(nr_seq_reg_arquivo_w,6,'0');

					insert	into w_envio_banco(nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						cd_estabelecimento,
						ds_conteudo,
						nr_seq_apres)
					values (nextval('w_envio_banco_seq'),
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						cd_estabelecimento_p,
						ds_conteudo_w,
						nr_seq_reg_arquivo_w);

					ie_mensagem			:= 'S';
					ds_mensagem_um_w	:= null;
					ds_mensagem_dois_w	:= null;
					ds_mensagem_tres_w	:= null;
					nr_linha_um_w		:= coalesce(nr_linha_um_w,0) + 3;
					nr_linha_dois_w		:= coalesce(nr_linha_dois_w,0) + 3;
					nr_linha_tres_w		:= coalesce(nr_linha_tres_w,0) + 3;
					qt_msg_um_w		:= 0;
					qt_msg_dois_w		:= 0;

				end if;
			--nr_linha_anterior_w	:= nr_linha_w;
			end	loop;
			close	c05;

		end loop;
		close c06;

	end	loop;
	close	c04;


	/* Tratar as sobras */

	if (ds_mensagem_um_w IS NOT NULL AND ds_mensagem_um_w::text <> '') then

		nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;
		ds_conteudo_w	:=	'7' ||
					cd_flash_w ||
					lpad(nr_linha_um_w,2,'0') ||
					rpad(coalesce(ds_mensagem_um_w,' '),128,' ') ||
					lpad(nr_linha_dois_w,2,'0') ||
					rpad(coalesce(ds_mensagem_dois_w,' '),128,' ') ||
					lpad(nr_linha_tres_w,2,'0') ||
					rpad(coalesce(ds_mensagem_tres_w,' '),127,' ') ||
					' ' ||
					lpad(nr_seq_reg_arquivo_w,6,'0');


		insert	into w_envio_banco(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_estabelecimento,
			ds_conteudo,
			nr_seq_apres)
		values (nextval('w_envio_banco_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_estabelecimento_p,
			ds_conteudo_w,
			nr_seq_reg_arquivo_w);

		ie_mensagem			:= 'S';
		ds_mensagem_um_w	:= null;
		ds_mensagem_dois_w	:= null;
		ds_mensagem_tres_w	:= null;
		nr_linha_um_w		:= coalesce(nr_linha_um_w,0) + 3;
		nr_linha_dois_w		:= coalesce(nr_linha_dois_w,0) + 3;
		nr_linha_tres_w		:= coalesce(nr_linha_tres_w,0) + 3;

	end if;

	if (ie_mensagem = 'N') then

		nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;
		ds_conteudo_w	:=	'7' ||
					cd_flash_w ||
					lpad(nr_linha_um_w,2,'0') ||
					rpad(coalesce(ds_mensagem_um_w,' '),128,' ') ||
					lpad(nr_linha_dois_w,2,'0') ||
					rpad(coalesce(ds_mensagem_dois_w,' '),128,' ') ||
					lpad(nr_linha_tres_w,2,'0') ||
					rpad(coalesce(ds_mensagem_tres_w,' '),127,' ') ||
					' ' ||
					lpad(nr_seq_reg_arquivo_w,6,'0');

		insert	into w_envio_banco(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_estabelecimento,
			ds_conteudo,
			nr_seq_apres)
		values (nextval('w_envio_banco_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_estabelecimento_p,
			ds_conteudo_w,
			nr_seq_reg_arquivo_w);
	end if;

	nr_linha_um_w	:= 1;
	nr_linha_dois_w	:= 2;

	/* Registro mensagem verso (opcional) */

	ie_aplicacao_mensagem_w	:= 'T';
	ie_posicao_w		:= 'V';
	nr_linha_anterior_w	:= null;
	qt_msg_um_w		:= 0;

	open	c06;
	loop
	fetch	c06 into
		nr_linha_w;
	EXIT WHEN NOT FOUND; /* apply on c06 */
		ds_mensagem_concat_w	:= '';
		cont_cursor_w	:= 0;

		select	count(*)
		into STRICT	qt_reg_w
		from	banco_instrucao_boleto a
		where	coalesce(a.ie_posicao,'F')			= ie_posicao_w
		and	coalesce(a.ie_aplicacao_mensagem,'T')	= ie_aplicacao_mensagem_w
		and	a.cd_banco				= cd_banco_w
		and	a.nr_linha				= nr_linha_w
		and	coalesce(a.nr_seq_grupo,0)			= coalesce(nr_seq_grupo_inst_p,coalesce(a.nr_seq_grupo,0));

		open	c05;
		loop
		fetch	c05 into
			ds_mensagem_w;
		EXIT WHEN NOT FOUND; /* apply on c05 */
			cont_cursor_w	:= cont_cursor_w + 1;
			ds_mensagem_concat_w	:= ds_mensagem_concat_w||ds_mensagem_w;
			if (ds_mensagem_concat_w IS NOT NULL AND ds_mensagem_concat_w::text <> '') or (ds_mensagem_concat_w <> '') then
				if	((coalesce(ds_mensagem_um_w::text, '') = '') or (coalesce(nr_linha_anterior_w,nr_linha_w)	= nr_linha_w)) and (qt_msg_um_w = 0) then

					ds_mensagem_um_w	:= ds_mensagem_concat_w;
					if (cont_cursor_w 		= qt_reg_w) and (ds_mensagem_um_w IS NOT NULL AND ds_mensagem_um_w::text <> '') then
						qt_msg_um_w	:= 1;
					end if;
				else
					ds_mensagem_dois_w	:= ds_mensagem_concat_w;

				end if;

			end if;

			if (ds_mensagem_um_w IS NOT NULL AND ds_mensagem_um_w::text <> '') and
				(ds_mensagem_dois_w IS NOT NULL AND ds_mensagem_dois_w::text <> '' AND cont_cursor_w = qt_reg_w) then

				nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;

				ds_conteudo_w	:=	'8' ||
							lpad(nr_linha_um_w,2,'0') ||
							rpad(coalesce(ds_mensagem_um_w,' '),140,' ') ||
							rpad(' ',50,' ') ||
							lpad(nr_linha_dois_w,2,'0') ||
							rpad(coalesce(ds_mensagem_dois_w,' '),140,' ') ||
							rpad(' ',59,' ') ||
							lpad(nr_seq_reg_arquivo_w,6,'0');

				insert	into w_envio_banco(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					cd_estabelecimento,
					ds_conteudo,
					nr_seq_apres)
				values (nextval('w_envio_banco_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					cd_estabelecimento_p,
					ds_conteudo_w,
					nr_seq_reg_arquivo_w);

				ds_mensagem_um_w	:= null;
				ds_mensagem_dois_w	:= null;
				nr_linha_um_w		:= coalesce(nr_linha_um_w,0) + 2;
				nr_linha_dois_w		:= coalesce(nr_linha_dois_w,0) + 2;
				qt_msg_um_w		:= 0;

			end if;
		nr_linha_anterior_w	:= nr_linha_w;
		end	loop;
		close	c05;

	end loop;
	close c06;

	/* Tratar as sobras */

	if (ds_mensagem_um_w IS NOT NULL AND ds_mensagem_um_w::text <> '') then

		nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;

		ds_conteudo_w	:=	'8' ||
					lpad(nr_linha_um_w,2,'0') ||
					rpad(coalesce(ds_mensagem_um_w,' '),140,' ') ||
					rpad(' ',50,' ') ||
					lpad(nr_linha_dois_w,2,'0') ||
					rpad(coalesce(ds_mensagem_dois_w,' '),140,' ') ||
					rpad(' ',59,' ') ||
					lpad(nr_seq_reg_arquivo_w,6,'0');

		insert	into w_envio_banco(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_estabelecimento,
			ds_conteudo,
			nr_seq_apres)
		values (nextval('w_envio_banco_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_estabelecimento_p,
			ds_conteudo_w,
			nr_seq_reg_arquivo_w);

		ds_mensagem_um_w	:= null;
		ds_mensagem_dois_w	:= null;
		nr_linha_um_w		:= coalesce(nr_linha_um_w,0) + 2;
		nr_linha_dois_w		:= coalesce(nr_linha_dois_w,0) + 2;

	end if;

	ie_aplicacao_mensagem_w	:= 'C';

	open	c04;
	loop
	fetch	c04 into
		nr_seq_conta_proc_w,
		nr_seq_conta_mat_w;
	EXIT WHEN NOT FOUND; /* apply on c04 */
		nr_linha_anterior_w	:= null;
		/* Registro mensagem verso (opcional) */

		qt_msg_um_w	:= 0;

		open	c06;
		loop
		fetch	c06 into
			nr_linha_w;
		EXIT WHEN NOT FOUND; /* apply on c06 */
			ds_mensagem_concat_w	:= '';
			cont_cursor_w	:= 0;

			select	count(*)
			into STRICT	qt_reg_w
			from	banco_instrucao_boleto a
			where	coalesce(a.ie_posicao,'F')			= ie_posicao_w
			and	coalesce(a.ie_aplicacao_mensagem,'T')	= ie_aplicacao_mensagem_w
			and	a.cd_banco				= cd_banco_w
			and	a.nr_linha				= nr_linha_w
			and	coalesce(a.nr_seq_grupo,0)			= coalesce(nr_seq_grupo_inst_p,coalesce(a.nr_seq_grupo,0));

			open	c05;
			loop
			fetch	c05 into
				ds_mensagem_w;
			EXIT WHEN NOT FOUND; /* apply on c05 */
				cont_cursor_w	:= cont_cursor_w + 1;
				ds_mensagem_concat_w	:= ds_mensagem_concat_w||ds_mensagem_w;
				if (ds_mensagem_concat_w IS NOT NULL AND ds_mensagem_concat_w::text <> '') or (ds_mensagem_concat_w <> '') then

					if	((coalesce(ds_mensagem_um_w::text, '') = '') or (coalesce(nr_linha_anterior_w,nr_linha_w)	= nr_linha_w)) and (qt_msg_um_w	= 0) then

						ds_mensagem_um_w	:= ds_mensagem_concat_w;
						if (cont_cursor_w 		= qt_reg_w) and (ds_mensagem_um_w IS NOT NULL AND ds_mensagem_um_w::text <> '') then
							qt_msg_um_w	:= 1;
						end if;
					else

						ds_mensagem_dois_w	:= ds_mensagem_concat_w;

					end if;

				end if;

				if (ds_mensagem_um_w IS NOT NULL AND ds_mensagem_um_w::text <> '') and
					(ds_mensagem_dois_w IS NOT NULL AND ds_mensagem_dois_w::text <> '' AND cont_cursor_w = qt_reg_w) then

					nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;

					ds_conteudo_w	:=	'8' ||
								lpad(nr_linha_um_w,2,'0') ||
								rpad(coalesce(ds_mensagem_um_w,' '),140,' ') ||
								rpad(' ',50,' ') ||
								lpad(nr_linha_dois_w,2,'0') ||
								rpad(coalesce(ds_mensagem_dois_w,' '),140,' ') ||
								rpad(' ',59,' ') ||
								lpad(nr_seq_reg_arquivo_w,6,'0');

					insert	into w_envio_banco(nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						cd_estabelecimento,
						ds_conteudo,
						nr_seq_apres)
					values (nextval('w_envio_banco_seq'),
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						cd_estabelecimento_p,
						ds_conteudo_w,
						nr_seq_reg_arquivo_w);

					ds_mensagem_um_w	:= null;
					ds_mensagem_dois_w	:= null;
					nr_linha_um_w		:= coalesce(nr_linha_um_w,0) + 2;
					nr_linha_dois_w		:= coalesce(nr_linha_dois_w,0) + 2;
					qt_msg_um_w		:= 0;

				end if;
			nr_linha_anterior_w	:= nr_linha_w;
			end	loop;
			close	c05;

		end loop;
		close c06;

		/* Tratar as sobras */

		if (ds_mensagem_um_w IS NOT NULL AND ds_mensagem_um_w::text <> '') then

			nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;

			ds_conteudo_w	:=	'8' ||
						lpad(nr_linha_um_w,2,'0') ||
						rpad(coalesce(ds_mensagem_um_w,' '),140,' ') ||
						rpad(' ',50,' ') ||
						lpad(nr_linha_dois_w,2,'0') ||
						rpad(coalesce(ds_mensagem_dois_w,' '),140,' ') ||
						rpad(' ',59,' ') ||
						lpad(nr_seq_reg_arquivo_w,6,'0');

			insert	into w_envio_banco(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				cd_estabelecimento,
				ds_conteudo,
				nr_seq_apres)
			values (nextval('w_envio_banco_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				cd_estabelecimento_p,
				ds_conteudo_w,
				nr_seq_reg_arquivo_w);

			ds_mensagem_um_w	:= null;
			ds_mensagem_dois_w	:= null;
			nr_linha_um_w		:= coalesce(nr_linha_um_w,0) + 2;
			nr_linha_dois_w		:= coalesce(nr_linha_dois_w,0) + 2;

		end if;


	end	loop;
	close	c04;

	nr_seq_conta_proc_w	:= null;
	nr_seq_conta_mat_w	:= null;

end	loop;
close	C01;

/* trailer */

nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;

ds_conteudo_w	:= 	'9' 								|| /*Pos 01*/
					rpad(' ',393,' ')	 				|| /*Pos 02 a 394*/
					lpad(nr_seq_reg_arquivo_w,6,'0');      /*Pos 395 a 400*/
insert	into w_envio_banco(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	cd_estabelecimento,
	ds_conteudo,
	nr_seq_apres)
values (nextval('w_envio_banco_seq'),
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	cd_estabelecimento_p,
	ds_conteudo_w,
	nr_seq_reg_arquivo_w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gera_cobr_msg_itau_400_reg0117 ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_grupo_inst_p bigint) FROM PUBLIC;

