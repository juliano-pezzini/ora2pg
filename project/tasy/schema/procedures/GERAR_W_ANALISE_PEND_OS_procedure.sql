-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_analise_pend_os ( nr_seq_gerencia_p bigint, nr_seq_grupo_des_p bigint, nm_usuario_p text) AS $body$
DECLARE



nr_sequencia_w		bigint;
nm_usuario_exec_w	varchar(15);
nr_seq_gerencia_w		bigint;
nr_seq_grupo_w		bigint;
qt_total_os_w		bigint;
ie_tipo_w			bigint;
qt_min_prev_w		bigint;
dt_ult_prev_w		timestamp;
dt_ult_tempo_w		timestamp;
dt_os_ant_w		timestamp;
ie_inserir_w		varchar(01) := 'S';
ds_usuario_exec_w		varchar(255);
ie_fora_periodo_w		varchar(15) := 'N';
cd_estabelecimento_w	smallint := wheb_usuario_pck.get_cd_estabelecimento;

C01 CURSOR FOR
SELECT	11 ie_tipo,
	c.nm_usuario_prev,
	substr(obter_nome_usuario(c.nm_usuario_prev),1,255) ds_usuario,
	d.nr_seq_gerencia,
	a.nr_seq_grupo_des,
	count(distinct(a.nr_sequencia)) qt,
	sum(c.qt_min_prev),
	max(c.dt_prevista),
	max(c.dt_prevista),
	min(a.dt_ordem_servico)
FROM grupo_desenvolvimento d, man_estagio_processo b, man_ordem_servico a
LEFT OUTER JOIN man_ordem_ativ_prev c ON (a.nr_sequencia = c.nr_seq_ordem_serv)
WHERE a.ie_status_ordem between 1 and 2 and a.nr_seq_estagio = b.nr_sequencia and ((b.ie_desenv  = 'S') or (b.ie_tecnologia = 'S'))  and c.dt_prevista >= trunc(clock_timestamp()) and a.nr_seq_grupo_des = d.nr_sequencia and d.nr_seq_gerencia = nr_seq_gerencia_p and a.nr_seq_grupo_des = nr_seq_grupo_des_p and exists (	select	1
		from	usuario_grupo_des p
		where	p.nr_seq_grupo = a.nr_seq_grupo_des
		and	p.nm_usuario_grupo = coalesce(c.nm_usuario_prev,'Tasy')) group by
	c.nm_usuario_prev,
	d.nr_seq_gerencia,
	a.nr_seq_grupo_des

union

select	21 ie_tipo,
	c.nm_usuario_prev,
	substr(obter_nome_usuario(c.nm_usuario_prev),1,255) ds_usuario,
	d.nr_seq_gerencia,
	a.nr_seq_grupo_des,
	count(distinct(a.nr_sequencia)) qt,
	sum(CASE WHEN coalesce(c.dt_real::text, '') = '' THEN c.qt_min_prev  ELSE 0 END ),
	max(c.dt_prevista),
	max(c.dt_prevista),
	min(a.dt_ordem_servico)
FROM grupo_desenvolvimento d, man_estagio_processo b, man_ordem_servico a
LEFT OUTER JOIN man_ordem_ativ_prev c ON (a.nr_sequencia = c.nr_seq_ordem_serv)
WHERE a.ie_status_ordem between 1 and 2 and a.nr_seq_estagio = b.nr_sequencia and ((b.ie_desenv  = 'S') or (b.ie_tecnologia = 'S'))  and a.nr_seq_grupo_des = d.nr_sequencia and coalesce(c.dt_prevista::text, '') = '' and d.nr_seq_gerencia = nr_seq_gerencia_p and a.nr_seq_grupo_des = nr_seq_grupo_des_p and a.nr_seq_estagio in (
	SELECT	nr_seq_estagio
	from  	man_estagio_usuario
	where 	nm_usuario_acao = coalesce(c.nm_usuario_prev,'Tasy')) and exists (	select	1
		from	usuario_grupo_des p
		where	p.nr_seq_grupo = a.nr_seq_grupo_des
		and	p.nm_usuario_grupo = coalesce(c.nm_usuario_prev,'Tasy')) and exists (	select	1
		from	man_ordem_servico_exec x
		where	x.nr_seq_ordem = a.nr_sequencia
		and	x.nm_usuario_exec = c.nm_usuario_prev
		and	coalesce(x.dt_fim_execucao::text, '') = '') group by
	c.nm_usuario_prev,
	d.nr_seq_gerencia,
	a.nr_seq_grupo_des

union

select	21 ie_tipo,
	e.nm_usuario_exec,
	substr(obter_nome_usuario(e.nm_usuario_exec),1,255) ds_usuario,
	d.nr_seq_gerencia,
	a.nr_seq_grupo_des,
	count(distinct(a.nr_sequencia)) qt,
	0,
	null,
	null,
	min(a.dt_ordem_servico)
from	grupo_desenvolvimento d,
	man_estagio_processo b,
	man_ordem_servico_exec e,
	man_ordem_servico a
where	a.ie_status_ordem between 1 and 2
and	a.nr_seq_estagio = b.nr_sequencia
and	((b.ie_desenv  = 'S') or (b.ie_tecnologia = 'S'))
and	a.nr_seq_grupo_des = d.nr_sequencia
and	e.nr_seq_ordem = a.nr_sequencia
and	coalesce(e.dt_fim_execucao::text, '') = ''
and	d.nr_seq_gerencia = nr_seq_gerencia_p
and	a.nr_seq_grupo_des = nr_seq_grupo_des_p
and	a.nr_seq_estagio in (
	select	nr_seq_estagio
	from  	man_estagio_usuario
	where 	nm_usuario_acao = coalesce(e.nm_usuario_exec,'Tasy'))
and exists (	select	1
		from	usuario_grupo_des p
		where	p.nr_seq_grupo = a.nr_seq_grupo_des
		and	p.nm_usuario_grupo = coalesce(e.nm_usuario_exec,'Tasy'))
and not exists (	select	1
		from	usuario_grupo_des p,
			man_ordem_ativ_prev x
		where	x.nr_seq_ordem_serv = a.nr_sequencia
		and	p.nr_seq_grupo = a.nr_seq_grupo_des
		and	x.nm_usuario_prev = p.nm_usuario_grupo)
group by
	e.nm_usuario_exec,
	d.nr_seq_gerencia,
	a.nr_seq_grupo_des
order by 1;

c02 CURSOR FOR
SELECT	nm_usuario_exec,
	sum(qt_total_os),
	sum(qt_min_prev),
	max(dt_ult_prev),
	max(dt_ult_tempo),
	min(dt_os_ant),
	ds_usuario_exec
from	w_analise_pend_os
where	nm_usuario 	= nm_usuario_p
and	ie_tipo 		= 21
group by nm_usuario_exec,
	ds_usuario_exec;


BEGIN
delete
from	w_analise_pend_os
where	nm_usuario = nm_usuario_p;

select	coalesce(max(nr_sequencia), 0) + 1
into STRICT	nr_sequencia_w
from	w_analise_pend_os;

insert into w_analise_pend_os(
		nr_sequencia,
		nm_usuario,
		nr_seq_gerencia,
		nr_seq_grupo,
		ds_usuario_exec,
		qt_total_os,
		qt_min_prev,
		dt_ult_prev,
		dt_ult_tempo,
		dt_os_ant,
		ie_tipo,
		dt_atualizacao)
	values (	nr_sequencia_w,
		nm_usuario_p,
		nr_seq_gerencia_p,
		nr_seq_grupo_des_p,
		/*'PENDENTES'*/

		wheb_mensagem_pck.get_texto(298036),
		null,
		null,
		null,
		null,
		null,
		10,
		clock_timestamp());

select	coalesce(max(nr_sequencia), 0) + 1
into STRICT	nr_sequencia_w
from	w_analise_pend_os;

insert into w_analise_pend_os(
		nr_sequencia,
		nm_usuario,
		nr_seq_gerencia,
		nr_seq_grupo,
		ds_usuario_exec,
		qt_total_os,
		qt_min_prev,
		dt_ult_prev,
		dt_ult_tempo,
		dt_os_ant,
		ie_tipo,
		dt_atualizacao)
	values (	nr_sequencia_w,
		nm_usuario_p,
		nr_seq_gerencia_p,
		nr_seq_grupo_des_p,
		/*'NÃƒO ANALISADAS'*/

		wheb_mensagem_pck.get_texto(298037),
		null,
		null,
		null,
		null,
		null,
		20,
		clock_timestamp());

select	coalesce(max(nr_sequencia), 0) + 1
into STRICT	nr_sequencia_w
from	w_analise_pend_os;

insert into w_analise_pend_os(
		nr_sequencia,
		nm_usuario,
		nr_seq_gerencia,
		nr_seq_grupo,
		ds_usuario_exec,
		qt_total_os,
		qt_min_prev,
		dt_ult_prev,
		dt_ult_tempo,
		dt_os_ant,
		ie_tipo,
		dt_atualizacao)
	values (	nr_sequencia_w,
		nm_usuario_p,
		nr_seq_gerencia_p,
		nr_seq_grupo_des_p,
		/*'TOTAL'*/

		wheb_mensagem_pck.get_texto(298038),
		null,
		null,
		null,
		null,
		null,
		30,
		clock_timestamp());

OPEN C01;
LOOP
FETCH C01 into
	ie_tipo_w,
	nm_usuario_exec_w,
	ds_usuario_exec_w,
	nr_seq_gerencia_w,
	nr_seq_grupo_w,
	qt_total_os_w,
	qt_min_prev_w,
	dt_ult_prev_w,
	dt_ult_tempo_w,
	dt_os_ant_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	select	coalesce(max(nr_sequencia), 0) + 1
	into STRICT	nr_sequencia_w
	from	w_analise_pend_os;

	ie_fora_periodo_w := 'N';
	select	CASE WHEN coalesce(qt_min_prev_w::text, '') = '' THEN  null  ELSE obter_data_dias_uteis(cd_estabelecimento_w, clock_timestamp(),			dividir(qt_min_prev_w,420)) END
	into STRICT	dt_ult_tempo_w
	;

	if (dt_ult_prev_w > dt_ult_tempo_w) then
		ie_fora_periodo_w	:= 'S';
	end if;

	if (ie_inserir_w = 'S') then
		insert into w_analise_pend_os(
			nr_sequencia,
			nm_usuario,
			nr_seq_gerencia,
			nr_seq_grupo,
			nm_usuario_exec,
			qt_total_os,
			qt_min_prev,
			dt_ult_prev,
			dt_ult_tempo,
			dt_os_ant,
			ie_tipo,
			dt_atualizacao,
			ds_usuario_exec,
			ie_fora_periodo)
		values (	nr_sequencia_w,
			nm_usuario_p,
			nr_seq_gerencia_w,
			nr_seq_grupo_w,
			nm_usuario_exec_w,
			qt_total_os_w,
			qt_min_prev_w,
			dt_ult_prev_w,
			dt_ult_tempo_w,
			dt_os_ant_w,
			ie_tipo_w,
			clock_timestamp(),
			ds_usuario_exec_w,
			ie_fora_periodo_w);
	end if;
	end;
END LOOP;
close c01;

open C02;
loop
fetch C02 into
	nm_usuario_exec_w,
	qt_total_os_w,
	qt_min_prev_w,
	dt_ult_prev_w,
	dt_ult_tempo_w,
	dt_os_ant_w,
	ds_usuario_exec_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	select	coalesce(max(nr_sequencia), 0) + 1
	into STRICT	nr_sequencia_w
	from	w_analise_pend_os;

	insert into w_analise_pend_os(
			nr_sequencia,
			nm_usuario,
			nr_seq_gerencia,
			nr_seq_grupo,
			nm_usuario_exec,
			qt_total_os,
			qt_min_prev,
			dt_ult_prev,
			dt_ult_tempo,
			dt_os_ant,
			ie_tipo,
			dt_atualizacao,
			ds_usuario_exec)
		values (	nr_sequencia_w,
			nm_usuario_p,
			nr_seq_gerencia_p,
			nr_seq_grupo_des_p,
			nm_usuario_exec_w,
			qt_total_os_w,
			qt_min_prev_w,
			dt_ult_prev_w,
			dt_ult_tempo_w,
			dt_os_ant_w,
			22,
			clock_timestamp(),
			ds_usuario_exec_w);
	end;
end loop;
close C02;

delete from w_analise_pend_os
where	ie_tipo = 21
and	nm_usuario = nm_usuario_p;

select	sum(qt_total_os),
	sum(qt_min_prev),
	max(dt_ult_prev),
	max(dt_ult_tempo),
	min(dt_os_ant)
into STRICT	qt_total_os_w,
	qt_min_prev_w,
	dt_ult_prev_w,
	dt_ult_tempo_w,
	dt_os_ant_w
from	w_analise_pend_os
where	nm_usuario 	= nm_usuario_p
and	ie_tipo in (11,22);

update	w_analise_pend_os
set	qt_total_os	= qt_total_os_w,
	qt_min_prev	= qt_min_prev_w,
	dt_ult_prev	= dt_ult_prev_w,
	dt_ult_tempo	= dt_ult_tempo_w,
	dt_os_ant		= dt_os_ant_w
where	nm_usuario	= nm_usuario_p
and	ie_tipo		= 30;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_analise_pend_os ( nr_seq_gerencia_p bigint, nr_seq_grupo_des_p bigint, nm_usuario_p text) FROM PUBLIC;

