-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gera_resultado_digitacao_aprov ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_exame_w		exame_laboratorio.nr_seq_exame%type;
nr_seq_material_w	material_exame_lab.nr_sequencia%type;
nr_seq_resultado_w	exame_lab_resultado.nr_seq_resultado%type;
dt_prescricao_w		timestamp;
dt_nascimento_w		timestamp;
ie_sexo_w		varchar(1);					
					 

BEGIN 
 
select max(a.dt_prescricao), 
	max(obter_nascimento_prescricao(a.nr_prescricao)), 
	max(obter_sexo_prescricao(a.nr_prescricao)), 
	max(b.nr_seq_exame), 
	max(c.nr_sequencia),		 
	max(d.nr_seq_resultado) 
into STRICT	dt_prescricao_w, 
	dt_nascimento_w, 
	ie_sexo_w, 
	nr_seq_exame_w, 
	nr_seq_material_w, 
	nr_seq_resultado_w 
from 	prescr_medica a, 
	prescr_procedimento b, 
	material_exame_lab c, 
	exame_lab_resultado d 
where 	a.nr_prescricao = b.nr_prescricao 
and	b.cd_material_exame = c.cd_material_exame 
and	a.nr_prescricao = d.nr_prescricao 
and	a.nr_prescricao = nr_prescricao_p 
and	b.nr_sequencia 	= nr_seq_prescr_p;
 
 
CALL Gera_Resultado_Lab( nr_seq_resultado_w, 
		nr_prescricao_p, 
		nr_seq_prescr_p	, 
		nr_seq_exame_w, 
		nr_seq_material_w, 
		(dt_prescricao_w - dt_nascimento_w) / 365.25, 
		ie_sexo_w, 
		nm_usuario_p);
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gera_resultado_digitacao_aprov ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text) FROM PUBLIC;

