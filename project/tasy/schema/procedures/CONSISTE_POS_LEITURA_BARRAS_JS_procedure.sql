-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_pos_leitura_barras_js ( cd_material_p bigint, nr_cirurgia_p bigint, cd_pessoa_fisica_p text, cd_pessoa_fisica_aux_p text, cd_estabelecimento_p bigint, ie_regra_int_opme_material_p INOUT text, nr_prescricao_p INOUT bigint, ds_material_p INOUT text, ie_consignado_p INOUT text, ie_mat_lib_profissional_e_p INOUT text, ie_mat_lib_profissional_r_p INOUT text, ie_mat_consignado_p INOUT text, ie_mat_controla_serie_p INOUT text) AS $body$
DECLARE



nr_prescricao_w			bigint;
ie_consignado_w			varchar(10);
ie_mat_lib_profissional_e_w		varchar(255);
ie_mat_lib_profissional_r_w		varchar(255);
ie_mat_consignado_w		varchar(255);
ds_material_w			varchar(255);
ie_regra_opme_w			varchar(255);
ie_mat_controla_serie_w		varchar(255);
ie_regra_int_opme_material_w		varchar(255);



BEGIN

select	max(nr_prescricao)
into STRICT	nr_prescricao_w
from	cirurgia
where	nr_cirurgia		= nr_cirurgia_p;

select	coalesce(max(ie_consignado), '0')
into STRICT	ie_consignado_w
from	material
where	cd_material		= cd_material_p;


begin
	ie_regra_int_opme_material_w		:= obter_regra_int_opme_material(cd_material_p,'04');
	ds_material_w			:= obter_desc_material(cd_material_p);
	ie_mat_lib_profissional_e_w		:= obter_se_mat_lib_profissional(cd_pessoa_fisica_p, cd_material_p, 'E');
	ie_mat_lib_profissional_r_w		:= obter_se_mat_lib_profissional(cd_pessoa_fisica_aux_p, cd_material_p, 'R');
	ie_mat_consignado_w		:= obter_se_mat_consignado(cd_material_p);
	ie_mat_controla_serie_w		:= obter_se_mat_controla_serie(cd_estabelecimento_p,cd_material_p);
	
exception when others then

	ie_regra_int_opme_material_w		:= null;
	ds_material_w			:= null;
	ie_mat_lib_profissional_e_w		:= null;
	ie_mat_lib_profissional_r_w		:= null;
	ie_mat_consignado_w		:= null;
	ie_mat_controla_serie_w		:= null;
end;




ie_regra_int_opme_material_p		:= ie_regra_int_opme_material_w;
nr_prescricao_p			:= nr_prescricao_w;
ds_material_p			:= ds_material_w;
ie_consignado_p			:= ie_consignado_w;
ie_mat_lib_profissional_e_p		:= ie_mat_lib_profissional_e_w;
ie_mat_lib_profissional_r_p		:= ie_mat_lib_profissional_r_w;
ie_mat_consignado_p		:= ie_mat_consignado_w;
ie_mat_controla_serie_p		:= ie_mat_controla_serie_w;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_pos_leitura_barras_js ( cd_material_p bigint, nr_cirurgia_p bigint, cd_pessoa_fisica_p text, cd_pessoa_fisica_aux_p text, cd_estabelecimento_p bigint, ie_regra_int_opme_material_p INOUT text, nr_prescricao_p INOUT bigint, ds_material_p INOUT text, ie_consignado_p INOUT text, ie_mat_lib_profissional_e_p INOUT text, ie_mat_lib_profissional_r_p INOUT text, ie_mat_consignado_p INOUT text, ie_mat_controla_serie_p INOUT text) FROM PUBLIC;

