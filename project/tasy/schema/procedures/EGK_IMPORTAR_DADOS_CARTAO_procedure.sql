-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE egk_importar_dados_cartao ( cd_pessoa_fisica_p text, nr_seq_pessoa_egk_p bigint, nm_usuario_p text, ie_opcao_p text, geburtsdatum_p timestamp, anschriftenzusatz_sa_p text, geschlecht_p text, hausnummer_sa_p text, kostentraeger_kennung_p bigint, nachname_p text, namenszusatz_p text, ort_sa_p text, postleitzahl_sa_p text, strasse_sa_p text, titel_p text, versichertenart_p bigint, versicherten_id_p text, versicherungsschutz_beginn_p timestamp, versicherungsschutz_ende_p timestamp, vorname_p text, vorsatzwort_p text, wohnsitzlaendercode_sa_p bigint, ds_erro_p INOUT text ) AS $body$
DECLARE

			
/* ie_opcao_p
CC - Complemento da Pessoa e Convenio
PF - Atualizar dados PF
C  - Convenio 
*/
pessoa_fisica_egk_w         pessoa_fisica_egk%rowtype;
compl_pessoa_fisica_w       compl_pessoa_fisica%rowtype;
pessoa_titular_convenio_w   pessoa_titular_convenio%rowtype;

nr_seq_regra_conv_w         bigint;
cd_convenio_w               convenio.cd_convenio%type;
nr_seq_person_name_w        person_name.nr_sequencia%type;
nr_seq_forma_trat_w         pessoa_fisica.nr_seq_forma_trat%type;
nr_sequencia_w              pessoa_titular_convenio.nr_sequencia%type;
qt_pais_w                   bigint;
qt_categoria_w              bigint;
cd_categoria_w		    pessoa_titular_convenio.cd_categoria%type;
ds_erro_log_w		    egk_reader_log.ds_log%type;
nr_prioridade_w		    pessoa_titular_convenio.nr_prioridade%type;

	procedure obter_dados_endereco is	
	;
BEGIN

    select  count(*)
    into STRICT    qt_pais_w
    from    pais
    where   nr_sequencia = wohnsitzlaendercode_sa_p;

    if (qt_pais_w = 0) then
        /*
        Nao foi encontrado registro referente ao valor informado/convertido.
        Elemento: 			#@DS_ELEMENTO#@;
        Tag (Atributo): 	#@DS_ATRIBUTO#@;
        Tabela referencia: 	#@NM_TABELA_REFERENCIA#@;
        Valor: 				#@DS_VALOR#@.
        */
        ds_erro_p := obter_desc_expressao(758283);
        ds_erro_p := replace(ds_erro_p, '#@DS_ELEMENTO#@', obter_desc_expressao(295224));
        ds_erro_p := replace(ds_erro_p, '#@DS_ATRIBUTO#@', 'WOHNSITZLAENDERCODE_SA');
        ds_erro_p := replace(ds_erro_p, '#@NM_TABELA_REFERENCIA#@', obter_desc_expressao(295224));
        ds_erro_p := replace(ds_erro_p, '#@DS_VALOR#@', wohnsitzlaendercode_sa_p);
        return;
    end if;
	
	compl_pessoa_fisica_w.ie_tipo_complemento	:= '1';
	compl_pessoa_fisica_w.cd_cep			:= postleitzahl_sa_p;		
	compl_pessoa_fisica_w.ds_endereco		:= strasse_sa_p;
	compl_pessoa_fisica_w.ds_compl_end		:= hausnummer_sa_p;
	compl_pessoa_fisica_w.ds_municipio		:= ort_sa_p;
	compl_pessoa_fisica_w.ds_complemento    := anschriftenzusatz_sa_p;
    compl_pessoa_fisica_w.nr_seq_pais		:= wohnsitzlaendercode_sa_p;
	
	end;
	
	procedure obter_dados_convenio is
	begin
	pessoa_titular_convenio_w.cd_convenio		:= kostentraeger_kennung_p;
	pessoa_titular_convenio_w.dt_inicio_vigencia	:= versicherungsschutz_beginn_p;
	pessoa_titular_convenio_w.dt_fim_vigencia	:= versicherungsschutz_ende_p;
	pessoa_titular_convenio_w.dt_validade_carteira	:= pessoa_fisica_egk_w.versicherungsschutz_ende;
	pessoa_titular_convenio_w.cd_usuario_convenio	:= versicherten_id_p;
	pessoa_titular_convenio_w.ie_tipo_conveniado 	:= versichertenart_p;
	
	end;

begin

begin

	select	max(nr_seq_regra_conv)
	into STRICT	nr_seq_regra_conv_w
	from	regra_leitor_cartao_pac
	where	nr_sequencia = obter_seq_regra_leitor_cartao(nm_usuario_p,wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_cd_estabelecimento);

	select	*
	into STRICT	pessoa_fisica_egk_w
	from	pessoa_fisica_egk
	where	nr_sequencia		= nr_seq_pessoa_egk_p;

	if (ie_opcao_p = 'PF') then --Chamado na opcao de atualizar dados da pessoa
		select	max(nr_seq_person_name)
		into STRICT	nr_seq_person_name_w
		from	pessoa_fisica
		where	cd_pessoa_fisica 	= cd_pessoa_fisica_p;
	
		select  obter_pf_forma_trat_egk(titel_p)
		into STRICT    nr_seq_forma_trat_w
		;
		
		if (nr_seq_forma_trat_w = 0) then
			nr_seq_forma_trat_w := null;
		end if;

		update	person_name
		set	ds_given_name 		= vorname_p,
			ds_family_name 		= nachname_p,
			ds_component_name_1 	= vorsatzwort_p,
			ds_component_name_2 	 = NULL,
			ds_component_name_3 	= namenszusatz_p,
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p
		where	nr_sequencia 		= nr_seq_person_name_w;
		
		update	pessoa_fisica
		set	nm_pessoa_fisica	= pessoa_fisica_egk_w.vorname || ' ' || pessoa_fisica_egk_w.nachname,		
			ie_sexo 		= geschlecht_p,
			dt_nascimento 		= geburtsdatum_p,
			nr_seq_forma_trat	= nr_seq_forma_trat_w,
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p
		where	cd_pessoa_fisica 	= cd_pessoa_fisica_p;

	end if;

	if (ie_opcao_p in ('CC','PF')) then

		begin
		select	*
		into STRICT	compl_pessoa_fisica_w
		from	compl_pessoa_fisica
		where	cd_pessoa_fisica	= cd_pessoa_fisica_p
		and	ie_tipo_complemento	= 1  LIMIT 1;
		exception
		when others then
			compl_pessoa_fisica_w 	:= null;
		end;

		obter_dados_endereco;

		if (coalesce(compl_pessoa_fisica_w.nr_sequencia::text, '') = '') then	

			select 	coalesce(max(nr_sequencia),0) + 1	
			into STRICT 	compl_pessoa_fisica_w.nr_sequencia	
			from 	compl_pessoa_fisica	
			where 	cd_pessoa_fisica = cd_pessoa_fisica_p;
			
			compl_pessoa_fisica_w.cd_pessoa_fisica		:= cd_pessoa_fisica_p;
			compl_pessoa_fisica_w.nm_usuario_nrec 		:= nm_usuario_p;
			compl_pessoa_fisica_w.nm_usuario		:= nm_usuario_p;
			compl_pessoa_fisica_w.dt_atualizacao_nrec	:= clock_timestamp();
			compl_pessoa_fisica_w.dt_atualizacao		:= clock_timestamp();
			
			insert into compl_pessoa_fisica values (compl_pessoa_fisica_w.*);
			
		else
			
			compl_pessoa_fisica_w.nm_usuario		:= nm_usuario_p;
			compl_pessoa_fisica_w.dt_atualizacao		:= clock_timestamp();
			
			update	compl_pessoa_fisica
			set	row			= compl_pessoa_fisica_w
			where	cd_pessoa_fisica	= cd_pessoa_fisica_p
			and	nr_sequencia		= compl_pessoa_fisica_w.nr_sequencia;

		end if;
		
		begin
		select  a.cd_convenio
		into STRICT	cd_convenio_w
		from    convenio a
		where   a.cd_cgc in (	SELECT  b.cd_cgc
					from (select x.cd_cgc,
							length(x.ds_razao_social)
						from    pessoa_juridica x,
							convenio y
						where   x.cd_cgc                    = y.cd_cgc
						and     x.ie_situacao               = 'A'
						and     y.ie_situacao               = 'A'
						and     somente_numero(x.cd_cnes)   = pessoa_fisica_egk_w.abrechnender_kennung
						order by   length(x.ds_razao_social) asc) b LIMIT 1);
		exception
		when others then
			begin
			select	max(a.cd_convenio)
			into STRICT 	cd_convenio_w
			from 	convenio a,
				pessoa_juridica b
			where 	a.ie_situacao 	= 'A'
			and	a.cd_cgc	= b.cd_cgc
			and b.ie_situacao = 'A'
			and	b.cd_cnes	= pessoa_fisica_egk_w.abrechnender_kennung;
			
			if (coalesce(cd_convenio_w::text, '') = '') then
				select	max(c.cd_convenio)
				into STRICT 	cd_convenio_w
				from 	convenio c,
					pessoa_juridica pj
				where 	c.ie_situacao 	= 'A'
				and	c.cd_cgc	= pj.cd_cgc
				and pj.ie_situacao = 'A'
				and	pj.cd_cnes	= pessoa_fisica_egk_w.kostentraeger_kennung;
			end if;

			exception
			when others then
				cd_convenio_w := null;
			end;
		end;
		
		if (cd_convenio_w IS NOT NULL AND cd_convenio_w::text <> '') then

			begin
			
			select	*
			into STRICT	pessoa_titular_convenio_w
			from	pessoa_titular_convenio
			where	cd_pessoa_fisica	= cd_pessoa_fisica_p
			and	cd_convenio		= cd_convenio_w  LIMIT 1;
			exception
			when others then
				pessoa_titular_convenio_w := null;
			end;
				
			PERFORM obter_dados_convenio();	
			
			select 	count(1)
			into STRICT	qt_categoria_w
			from 	categoria_convenio
			where	cd_convenio		= pessoa_titular_convenio_w.cd_convenio
			and	ie_situacao		= 'A';
			
			if (qt_categoria_w = 1) then
			
				select 	cd_categoria
				into STRICT	pessoa_titular_convenio_w.cd_categoria
				from 	categoria_convenio
				where	cd_convenio		= pessoa_titular_convenio_w.cd_convenio
				and	ie_situacao		= 'A';
			else
				pessoa_titular_convenio_w.cd_categoria := null;			
			end if;
			
			begin
			select  nr_sequencia
			into STRICT	nr_sequencia_w
			from	pessoa_titular_convenio
			where 	cd_usuario_convenio		= versicherten_id_p
			and 	cd_pessoa_fisica		= cd_pessoa_fisica_p
			and	cd_convenio			= pessoa_titular_convenio_w.cd_convenio
			and	cd_categoria			= pessoa_titular_convenio_w.cd_categoria
			and	trunc(dt_inicio_vigencia)	= trunc(pessoa_titular_convenio_w.dt_inicio_vigencia)  LIMIT 1;
			exception
			when others then
				ds_erro_log_w	:=	ds_erro_log_w || CHR(10) || substr(dbms_utility.format_error_backtrace || chr(13) || chr(10) || sqlerrm,1,4000);
				begin
				select  nr_sequencia
				into STRICT	nr_sequencia_w
				from	pessoa_titular_convenio
				where 	cd_usuario_convenio		= versicherten_id_p
				and 	cd_pessoa_fisica		= cd_pessoa_fisica_p
				and	cd_convenio			= pessoa_titular_convenio_w.cd_convenio
				and	trunc(dt_inicio_vigencia)	= trunc(pessoa_titular_convenio_w.dt_inicio_vigencia)  LIMIT 1;
				exception
				when others then
					ds_erro_log_w	:=	ds_erro_log_w || CHR(10) || substr(dbms_utility.format_error_backtrace || chr(13) || chr(10) || sqlerrm,1,4000);
					begin
					select  nr_sequencia
					into STRICT	nr_sequencia_w
					from	pessoa_titular_convenio
					where 	cd_usuario_convenio	= versicherten_id_p
					and 	cd_pessoa_fisica	= cd_pessoa_fisica_p
					and	cd_convenio		= pessoa_titular_convenio_w.cd_convenio  LIMIT 1;
					exception
					when others then
						ds_erro_log_w	:=	ds_erro_log_w || CHR(10) || substr(dbms_utility.format_error_backtrace || chr(13) || chr(10) || sqlerrm,1,4000);
						begin
						select  nr_sequencia
						into STRICT	nr_sequencia_w
						from	pessoa_titular_convenio
						where 	cd_usuario_convenio	= versicherten_id_p
						and 	cd_pessoa_fisica	= cd_pessoa_fisica_p
						and	cd_convenio		= kostentraeger_kennung_p  LIMIT 1;
						exception
						when others then
							ds_erro_log_w	:=	ds_erro_log_w || CHR(10) || substr(dbms_utility.format_error_backtrace || chr(13) || chr(10) || sqlerrm,1,4000);
							begin
							select  nr_sequencia
							into STRICT	nr_sequencia_w
							from	pessoa_titular_convenio
							where 	cd_pessoa_fisica	= cd_pessoa_fisica_p
							and	cd_convenio		= pessoa_titular_convenio_w.cd_convenio  LIMIT 1;
							exception
							when others then
								ds_erro_log_w	:=	ds_erro_log_w || CHR(10) || substr(dbms_utility.format_error_backtrace || chr(13) || chr(10) || sqlerrm,1,4000);
								nr_sequencia_w := null;
							end;
						end;
					end;
				end;
			end;
			
			
			if (coalesce(nr_sequencia_w,0) = 0 and pessoa_titular_convenio_w.cd_convenio > 0) then



                if (obter_tipo_convenio(kostentraeger_kennung_p) = 11) then
                    select    min(nr_prioridade)
                    into STRICT        nr_prioridade_w
                    from        pessoa_titular_convenio
                    where    cd_pessoa_fisica = cd_pessoa_fisica_p
                    and        obter_tipo_convenio(cd_convenio) = 11
                    and        cd_convenio <> kostentraeger_kennung_p
                    and        coalesce(dt_fim_vigencia::text, '') = ''
                    and        nr_prioridade <> 0;

                    update    pessoa_titular_convenio
                    set    dt_fim_vigencia = versicherungsschutz_beginn_p -1,
						nr_prioridade = 0
                    where    cd_pessoa_fisica = cd_pessoa_fisica_p
                    and    obter_tipo_convenio(cd_convenio) = 11
                    and    coalesce(dt_fim_vigencia::text, '') = '';
                end if;

                
                select    nextval('pessoa_titular_convenio_seq')
                into STRICT    pessoa_titular_convenio_w.nr_sequencia
;

                pessoa_titular_convenio_w.cd_pessoa_fisica    := cd_pessoa_fisica_p;
                pessoa_titular_convenio_w.nm_usuario_nrec     := nm_usuario_p;
                pessoa_titular_convenio_w.nm_usuario        := nm_usuario_p;
                pessoa_titular_convenio_w.dt_atualizacao_nrec    := clock_timestamp();
                pessoa_titular_convenio_w.dt_atualizacao    := clock_timestamp();
                pessoa_titular_convenio_w.nr_prioridade    := nr_prioridade_w;

                insert into pessoa_titular_convenio values (pessoa_titular_convenio_w.*);

            else
				
				if (obter_tipo_convenio(kostentraeger_kennung_p) = 11) then
					update	pessoa_titular_convenio
					set	dt_fim_vigencia = versicherungsschutz_beginn_p -1,
					nr_prioridade = 0
					where	cd_pessoa_fisica = cd_pessoa_fisica_p
					and	obter_tipo_convenio(cd_convenio) = 11
					and	cd_convenio <> kostentraeger_kennung_p
					and	coalesce(dt_fim_vigencia::text, '') = '';
				end if;
				
				pessoa_titular_convenio_w.nm_usuario		:= nm_usuario_p;
				pessoa_titular_convenio_w.dt_atualizacao	:= clock_timestamp();
				
				begin
					update	pessoa_titular_convenio
					set	
					nm_usuario				= pessoa_titular_convenio_w.nm_usuario,
					dt_atualizacao				= pessoa_titular_convenio_w.dt_atualizacao,
					cd_convenio				= pessoa_titular_convenio_w.cd_convenio,
					dt_inicio_vigencia 			= pessoa_titular_convenio_w.dt_inicio_vigencia,
					dt_fim_vigencia				= pessoa_titular_convenio_w.dt_fim_vigencia,
					dt_validade_carteira 			= pessoa_titular_convenio_w.dt_validade_carteira,
					cd_usuario_convenio 			= pessoa_titular_convenio_w.cd_usuario_convenio,
					ie_tipo_conveniado 			= pessoa_titular_convenio_w.ie_tipo_conveniado,
					cd_categoria				= pessoa_titular_convenio_w.cd_categoria
					where	cd_pessoa_fisica		= cd_pessoa_fisica_p
					and	nr_sequencia			= nr_sequencia_w;
					exception
					when others then
						ds_erro_p := obter_desc_expressao(619362);
				end;
			
			end if;

		end if;
		
	end if;

	if (ie_opcao_p = 'C') then

		if (kostentraeger_kennung_p IS NOT NULL AND kostentraeger_kennung_p::text <> '' AND versicherten_id_p IS NOT NULL AND versicherten_id_p::text <> '') then
			PERFORM obter_dados_convenio();
			
			select 	count(1)
			into STRICT	qt_categoria_w
			from 	categoria_convenio
			where	cd_convenio		= pessoa_titular_convenio_w.cd_convenio
			and	ie_situacao		= 'A';
			
			if (qt_categoria_w = 1) then
			
				select 	cd_categoria
				into STRICT	pessoa_titular_convenio_w.cd_categoria
				from 	categoria_convenio
				where	cd_convenio		= pessoa_titular_convenio_w.cd_convenio
				and	ie_situacao		= 'A';
			else
				pessoa_titular_convenio_w.cd_categoria := null;		
			end if;
			
			begin
			select  nr_sequencia
			into STRICT	nr_sequencia_w
			from	pessoa_titular_convenio
			where 	cd_usuario_convenio		= versicherten_id_p
			and 	cd_pessoa_fisica		= cd_pessoa_fisica_p
			and	cd_convenio			= pessoa_titular_convenio_w.cd_convenio
			and	cd_categoria			= pessoa_titular_convenio_w.cd_categoria
			and	trunc(dt_inicio_vigencia)	= trunc(pessoa_titular_convenio_w.dt_inicio_vigencia)  LIMIT 1;
			exception
			when others then
				ds_erro_log_w	:=	ds_erro_log_w || CHR(10) || substr(dbms_utility.format_error_backtrace || chr(13) || chr(10) || sqlerrm,1,4000);
				begin
				select  nr_sequencia
				into STRICT	nr_sequencia_w
				from	pessoa_titular_convenio
				where 	cd_usuario_convenio		= versicherten_id_p
				and 	cd_pessoa_fisica		= cd_pessoa_fisica_p
				and	cd_convenio			= pessoa_titular_convenio_w.cd_convenio
				and	trunc(dt_inicio_vigencia)	= trunc(pessoa_titular_convenio_w.dt_inicio_vigencia)  LIMIT 1;
				exception
				when others then
					ds_erro_log_w	:=	ds_erro_log_w || CHR(10) || substr(dbms_utility.format_error_backtrace || chr(13) || chr(10) || sqlerrm,1,4000);
					begin
					select  nr_sequencia
					into STRICT	nr_sequencia_w
					from	pessoa_titular_convenio
					where 	cd_usuario_convenio	= versicherten_id_p
					and 	cd_pessoa_fisica	= cd_pessoa_fisica_p
					and	cd_convenio		= pessoa_titular_convenio_w.cd_convenio  LIMIT 1;
					exception
					when others then
						ds_erro_log_w	:=	ds_erro_log_w || CHR(10) || substr(dbms_utility.format_error_backtrace || chr(13) || chr(10) || sqlerrm,1,4000);
						begin
						select  nr_sequencia
						into STRICT	nr_sequencia_w
						from	pessoa_titular_convenio
						where 	cd_usuario_convenio	= versicherten_id_p
						and 	cd_pessoa_fisica	= cd_pessoa_fisica_p
						and	cd_convenio		= kostentraeger_kennung_p  LIMIT 1;
						exception
						when others then
							ds_erro_log_w	:=	ds_erro_log_w || CHR(10) || substr(dbms_utility.format_error_backtrace || chr(13) || chr(10) || sqlerrm,1,4000);
							begin
							select  nr_sequencia
							into STRICT	nr_sequencia_w
							from	pessoa_titular_convenio
							where 	cd_pessoa_fisica	= cd_pessoa_fisica_p
							and	cd_convenio		= pessoa_titular_convenio_w.cd_convenio  LIMIT 1;
							exception
							when others then
								nr_sequencia_w := null;
								ds_erro_log_w	:=	ds_erro_log_w || CHR(10) || substr(dbms_utility.format_error_backtrace || chr(13) || chr(10) || sqlerrm,1,4000);
							end;
						end;
					end;
				end;
			end;
			
			if (coalesce(nr_sequencia_w,0) = 0) then
			
				if (obter_tipo_convenio(kostentraeger_kennung_p) = 11) then
					select    min(nr_prioridade)
                    into STRICT        nr_prioridade_w
                    from        pessoa_titular_convenio
                    where    cd_pessoa_fisica = cd_pessoa_fisica_p
                    and        obter_tipo_convenio(cd_convenio) = 11
                    and        cd_convenio <> kostentraeger_kennung_p
                    and        coalesce(dt_fim_vigencia::text, '') = ''
                    and        nr_prioridade <> 0;
					
					update	pessoa_titular_convenio
					set	dt_fim_vigencia = versicherungsschutz_beginn_p -1,
					nr_prioridade = 0
					where	cd_pessoa_fisica = cd_pessoa_fisica_p
					and	obter_tipo_convenio(cd_convenio) = 11
					and	coalesce(dt_fim_vigencia::text, '') = '';
				end if;
				
				select	nextval('pessoa_titular_convenio_seq')
				into STRICT	pessoa_titular_convenio_w.nr_sequencia
				;
				
				pessoa_titular_convenio_w.cd_pessoa_fisica	:= cd_pessoa_fisica_p;
				pessoa_titular_convenio_w.nm_usuario_nrec 	:= nm_usuario_p;
				pessoa_titular_convenio_w.nm_usuario		:= nm_usuario_p;
				pessoa_titular_convenio_w.dt_atualizacao_nrec	:= clock_timestamp();
				pessoa_titular_convenio_w.dt_atualizacao	:= clock_timestamp();
				pessoa_titular_convenio_w.nr_prioridade    := nr_prioridade_w;
				
				insert into pessoa_titular_convenio values (pessoa_titular_convenio_w.*);			
			else
				if (obter_tipo_convenio(kostentraeger_kennung_p) = 11) then
					update	pessoa_titular_convenio
					set	dt_fim_vigencia = versicherungsschutz_beginn_p -1,
					nr_prioridade = 0
					where	cd_pessoa_fisica = cd_pessoa_fisica_p
					and	obter_tipo_convenio(cd_convenio) = 11
					and	cd_convenio <> kostentraeger_kennung_p
					and	coalesce(dt_fim_vigencia::text, '') = '';
				end if;
				
				pessoa_titular_convenio_w.nm_usuario		:= nm_usuario_p;
				pessoa_titular_convenio_w.dt_atualizacao	:= clock_timestamp();
				
				begin
					update	pessoa_titular_convenio
					set	
					nm_usuario				= pessoa_titular_convenio_w.nm_usuario,
					dt_atualizacao				= pessoa_titular_convenio_w.dt_atualizacao,
					cd_convenio				= pessoa_titular_convenio_w.cd_convenio,
					cd_categoria				= pessoa_titular_convenio_w.cd_categoria,
					dt_inicio_vigencia 			= pessoa_titular_convenio_w.dt_inicio_vigencia,
					dt_fim_vigencia				= pessoa_titular_convenio_w.dt_fim_vigencia,
					dt_validade_carteira 			= pessoa_titular_convenio_w.dt_validade_carteira,
					cd_usuario_convenio 			= pessoa_titular_convenio_w.cd_usuario_convenio,
					ie_tipo_conveniado 			= pessoa_titular_convenio_w.ie_tipo_conveniado
					where	cd_pessoa_fisica		= cd_pessoa_fisica_p
					and	nr_sequencia			= nr_sequencia_w;
				exception
				when others then
					ds_erro_p := obter_desc_expressao(619362);
				end;
			
			end if;
		end if;
		
	end if;

	update	pessoa_fisica_egk
	set	cd_pessoa_fisica	= cd_pessoa_fisica_p,
		dt_atualizacao		= clock_timestamp(),
		nm_usuario		= nm_usuario_p
	where	nr_sequencia		= nr_seq_pessoa_egk_p;

	commit;

exception
when others then
	ds_erro_log_w	:=	ds_erro_log_w || CHR(10) || substr(dbms_utility.format_error_backtrace || chr(13) || chr(10) || sqlerrm,1,4000);
	CALL egk_inserir_log(nm_usuario_p, ds_erro_p);
	ds_erro_p	:=	obter_desc_expressao(619362);
end;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE egk_importar_dados_cartao ( cd_pessoa_fisica_p text, nr_seq_pessoa_egk_p bigint, nm_usuario_p text, ie_opcao_p text, geburtsdatum_p timestamp, anschriftenzusatz_sa_p text, geschlecht_p text, hausnummer_sa_p text, kostentraeger_kennung_p bigint, nachname_p text, namenszusatz_p text, ort_sa_p text, postleitzahl_sa_p text, strasse_sa_p text, titel_p text, versichertenart_p bigint, versicherten_id_p text, versicherungsschutz_beginn_p timestamp, versicherungsschutz_ende_p timestamp, vorname_p text, vorsatzwort_p text, wohnsitzlaendercode_sa_p bigint, ds_erro_p INOUT text ) FROM PUBLIC;

