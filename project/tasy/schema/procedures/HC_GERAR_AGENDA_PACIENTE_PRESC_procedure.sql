-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hc_gerar_agenda_paciente_presc ( nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE

					 
lista_horarios_w		dbms_sql.varchar2_table;
ds_lista_horarios_w		varchar(255);	
ie_paciente_homecare_w	varchar(1);
qt_existe_horario_w		bigint;
ds_horario_gerado_w		varchar(255);
nr_seq_paciente_hc_w	paciente_home_care.nr_sequencia%type;
nr_seq_prof_hc_w		hc_profissional.nr_sequencia%type;
nr_seq_agenda_hc_w		agenda_hc_paciente.nr_sequencia%type;
nr_seq_age_homecare_w	hc_parametro.nr_seq_agenda_prescr%type;
dt_agenda_w				timestamp;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
nr_seq_material_w		prescr_material.nr_sequencia%type;
nr_seq_pac_resp_w		hc_resp_servico_paciente.nr_sequencia%type;
nr_seq_equipe_w			hc_resp_servico_paciente.nr_seq_equipe%type;
ds_observacao_w			prescr_material.ds_observacao%type;
ie_controle_w			varchar(2);
ds_hora_w		varchar(10);
ie_soma_data_w		boolean;


C01 CURSOR FOR	
	SELECT	b.nr_sequencia
	from	hc_regra_gerar_agen a,
			prescr_material b
	where	a.cd_material  = b.cd_material
	and		((coalesce(trim(both b.ds_horarios)::text, '') = '') or (trim(both b.ds_horarios) not like '%SN%') or (trim(both b.ds_horarios) not like '%ACM%'))
	and 	b.nr_prescricao = nr_prescricao_p
	order by 1;
BEGIN



open c01;
loop
fetch c01 into	
	nr_seq_material_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
	select	replace(max(ds_horarios),' ',';')
	into STRICT	ds_lista_horarios_w
	from	prescr_material
	where	nr_prescricao 	= nr_prescricao_p
	and		nr_sequencia = nr_seq_material_w;
	
	if (ds_lista_horarios_w IS NOT NULL AND ds_lista_horarios_w::text <> '') then
			
		select	max(coalesce(dt_inicio_prescr,dt_prescricao)),
				max(cd_pessoa_fisica)
		into STRICT	dt_agenda_w,
				cd_pessoa_fisica_w
		from	prescr_medica
		where	nr_prescricao = nr_prescricao_p;
		
		select	max(nr_sequencia)
		into STRICT	nr_seq_paciente_hc_w
		from	paciente_home_care
		where	cd_pessoa_fisica = cd_pessoa_fisica_w;
		
		select	max(nr_seq_agenda_prescr)
		into STRICT	nr_seq_age_homecare_w
		from	hc_parametro
		where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;
		
		select	max(a.nr_sequencia)
		into STRICT	nr_seq_pac_resp_w
		from	hc_resp_servico_paciente a,
				hc_paciente_servico b
		where	b.nr_seq_pac_home_care = nr_seq_paciente_hc_w
		and		b.nr_sequencia = nr_seq_pac_servico;
		
		select	max(b.nr_sequencia),
				max(a.nr_seq_equipe)
		into STRICT	nr_seq_prof_hc_w,
				nr_seq_equipe_w
		from	hc_resp_servico_paciente a,
				hc_profissional b
		where	a.cd_pessoa_fisica = b.cd_pessoa_fisica
		and		a.nr_Sequencia = nr_seq_pac_resp_w;
		
		select	max(ds_observacao)
		into STRICT	ds_observacao_w
		from	prescr_material
		where	nr_prescricao = nr_prescricao_p;
		
		lista_horarios_w	:= obter_lista_string(Padroniza_horario_prescr(ds_lista_horarios_w,dt_agenda_w),' ');
		
		
		ie_controle_w := 'X';
		ie_soma_data_w := false;
		if (lista_horarios_w IS NOT NULL AND lista_horarios_w::text <> '') and (lista_horarios_w.count > 0) then
			for	i in lista_horarios_w.first..lista_horarios_w.last loop
						
				ds_hora_w := lista_horarios_w(i);
				
				if (substr(upper(ds_hora_w),1,2) = 'AA') then
					ie_controle_w	:= 'AA';
					ds_hora_w    	:= substr(ds_hora_w,3,6)||':00';
					dt_agenda_w 	:= dt_agenda_w + 1;
				elsif (substr(upper(ds_hora_w),1,1) = 'A')  then
					if (ie_controle_w = 'X') then
						dt_agenda_w := dt_agenda_w + 1;
					end if;
					ie_controle_w	  := 'A';
					ds_hora_w    	 := substr(ds_hora_w,2,5)||':00';
				end if;
				
				
				dt_agenda_w	:= ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_agenda_w, ds_hora_w);
							
				select	count(*)
				into STRICT	qt_existe_horario_w
				from	agenda_hc_paciente where		dt_agenda = dt_agenda_w
				and		nr_seq_paciente_hc = nr_seq_paciente_hc_w LIMIT 1;
				
				if (qt_existe_horario_w = 0) then
					begin
					select	nextval('agenda_hc_paciente_seq')
					into STRICT	nr_seq_agenda_hc_w
					;
					
					insert into agenda_hc_paciente(
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							cd_pessoa_fisica,
							dt_agenda,
							ie_status_agenda,
							nr_seq_agenda,
							nr_seq_paciente_hc,
							ds_observacao,
							ie_prescricao,
							nr_prescricao
					) values (
							nr_seq_agenda_hc_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							cd_pessoa_fisica_w,
							dt_agenda_w,
							'A',
							nr_seq_age_homecare_w,
							nr_seq_paciente_hc_w,
							CASE WHEN ds_observacao_w='' THEN '' WHEN ds_observacao_w=OBTER_DESC_EXPRESSAO(329898) || ' '||ds_observacao_w),			-- 329898: 'Recomendacao:'							'S' THEN							nr_prescricao_p END;
							
					insert into hc_agenda_prof(
							nr_sequencia,
							dt_atualizacao,
							nm_usuario, 
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_seq_agenda,
							nr_seq_prof_hc,
							nr_seq_equipe_hc
					) values (
							nextval('hc_agenda_prof_seq'),
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							nr_seq_agenda_hc_w,
							nr_seq_prof_hc_w,
							nr_seq_equipe_w);
					end;
				end if;

			end loop;
		end if;
	end if;
	end;	
end loop;
close C01;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hc_gerar_agenda_paciente_presc ( nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

