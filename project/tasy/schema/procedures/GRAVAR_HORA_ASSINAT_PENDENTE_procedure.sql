-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_hora_assinat_pendente ( nr_atendimento_p bigint, nr_seq_interno_p text, nr_seq_assinatura_p bigint) AS $body$
DECLARE


ora2pg_rowcount int;
nr_seq_horario_w	pep_item_pendente.nr_seq_horario%type;
ie_tipo_item_adep_w	pep_item_pendente.ie_tipo_item_adep%type;
nr_seq_item_adep_w	pep_item_pendente.nr_seq_item_adep%type;
nr_prescricao_w		pep_item_pendente.nr_prescricao%type;
nr_etapa_adep_w		pep_item_pendente.nr_etapa_adep%type;
nm_usuario_nrec_w	pep_item_pendente.nm_usuario_nrec%type;
nr_atendimento_w	atendimento_paciente.nr_atendimento%type;
nr_sequencia_w		numeric(20);
sql_update_w		varchar(4000);
ie_ja_assinou_w		varchar(1);
sql_select_w		varchar(4000);
sql_select_pend_w	varchar(4000);
ds_retorno_w		varchar(10);
ds_retorno_pend_w	varchar(10);
ie_deletou_w		boolean;
qt_reg_pend_w		bigint;
qt_reg_ass_w		bigint;
ds_erro_w			varchar(2000);


BEGIN

if (coalesce(nr_seq_assinatura_p,0) > 0) and (coalesce(nr_seq_interno_p,0) > 0) then

	if (coalesce(nr_atendimento_p,0) > 0) then
		nr_atendimento_w	:= nr_atendimento_p;
	end if;

	Select 	coalesce(max(nr_seq_horario),0),
		trim(both max(ie_tipo_item_adep)),
		coalesce(max(nr_seq_item_adep),0),
		max(nr_prescricao),
		coalesce(max(nr_etapa_adep),0),
		max(nm_usuario_nrec),
		coalesce(nr_atendimento_w,max(nr_atendimento))
	into STRICT	nr_seq_horario_w,
		ie_tipo_item_adep_w,
		nr_seq_item_adep_w,
		nr_prescricao_w,
		nr_etapa_adep_w,
		nm_usuario_nrec_w,
		nr_atendimento_w
	from 	pep_item_pendente
	where  	nr_sequencia = nr_seq_interno_p;


	-- Deve atualizar os eventos independente de estes estarem válidos ou não
	if (coalesce(nr_seq_item_adep_w,0) > 0) or (coalesce(nr_seq_horario_w,0) > 0) then
		if (ie_tipo_item_adep_w = 'O') then
			sql_update_w	:=	' update	prescr_gasoterapia_evento a ' || chr(10) ||
						' set		a.nr_seq_assinatura = ' || coalesce(nr_seq_assinatura_p,0) || chr(10) ||
						' where		obter_data_assinatura_digital(a.nr_seq_assinatura) is null ' || chr(10) ||
						' and		a.nr_sequencia = (	select	max(b.nr_sequencia) ' || chr(10) ||
										'	from	prescr_gasoterapia_evento b ' || chr(10) ||
										'	where	nvl(b.nr_seq_assinatura,0) = 0 ' || chr(10) ||
										'	and		b.nm_usuario_nrec = ''' || nm_usuario_nrec_w || '''' || chr(10) ||
										'	and		b.nr_seq_gasoterapia = ' || coalesce(nr_seq_item_adep_w,0) || ' ) ' || chr(10) ||
						' and 		rownum <= 1 ' || chr(10) ||
						' and		a.nr_seq_gasoterapia = ' || coalesce(nr_seq_item_adep_w,0) || ' ';

			sql_select_w	:= 	'select 	count(nr_sequencia)	' || chr(10) ||
						'from		prescr_gasoterapia 	' || chr(10) ||
						' where		obter_data_assinatura_digital(a.nr_seq_assinatura) is not null ' || chr(10) ||
						' and		a.nr_sequencia = (	select	max(b.nr_sequencia) ' || chr(10) ||
										'	from	prescr_gasoterapia_evento b ' || chr(10) ||
										'	where	nvl(b.nr_seq_assinatura,0) = 0 ' || chr(10) ||
										'	and		b.nm_usuario_nrec = ''' || nm_usuario_nrec_w || '''' || chr(10) ||
										'	and		b.nr_seq_gasoterapia = ' || coalesce(nr_seq_item_adep_w,0) || ' ) ' || chr(10) ||
						' and		a.nr_seq_gasoterapia = ' || coalesce(nr_seq_item_adep_w,0) || ' ';




		elsif (nr_seq_horario_w > 0) then
			sql_update_w	:=	' update	prescr_mat_alteracao ' || chr(10) ||
						' set		nr_seq_assinatura = ' || coalesce(nr_seq_assinatura_p,0) || chr(10) ||
						' where		nvl(ie_tipo_item,''' || ie_tipo_item_adep_w || ''') = ''' || ie_tipo_item_adep_w || '''' || chr(10) ||
						' and		nm_usuario_nrec = ''' || nm_usuario_nrec_w || '''' || chr(10) ||
						' and 		rownum <= 1 ' || chr(10) ||
						' and		obter_data_assinatura_digital(nr_seq_assinatura) is null ' || chr(10);

			--Verificar se o item já foi assinado. (Neste caso a pendência já deveria ter sido excluída)
			sql_select_w	:= 	'select		count(nr_sequencia)	' || chr(10) ||
						' from		prescr_mat_alteracao	' || chr(10) ||
						' where		nvl(ie_tipo_item,''' || ie_tipo_item_adep_w || ''') = ''' || ie_tipo_item_adep_w || '''' || chr(10) ||
						' and		nm_usuario_nrec = ''' || nm_usuario_nrec_w || '''' || chr(10) ||
						' and		obter_data_assinatura_digital(nr_seq_assinatura) is not null ' || chr(10);

			--Verificar se existe algum registro pendente,
			sql_select_pend_w	:= 	'select		count(nr_sequencia)	' || chr(10) ||
						' from		prescr_mat_alteracao	' || chr(10) ||
						' where		nvl(ie_tipo_item,''' || ie_tipo_item_adep_w || ''') = ''' || ie_tipo_item_adep_w || '''' || chr(10) ||
						' and		nm_usuario_nrec = ''' || nm_usuario_nrec_w || '''' || chr(10) ||
						' and		obter_data_assinatura_digital(nr_seq_assinatura) is null ' || chr(10);


			if (ie_tipo_item_adep_w in ('M','MAT','SNE','S','IA','IAG')) then
				sql_update_w		:=	sql_update_w || ' and		nr_seq_horario = ' || nr_seq_horario_w;
				sql_select_w		:=	sql_select_w || ' and		nr_seq_horario = ' || nr_seq_horario_w;
				sql_select_pend_w	:=	sql_select_pend_w || ' and		nr_seq_horario = ' || nr_seq_horario_w;
			elsif (ie_tipo_item_adep_w in ('D','DE')) then
				sql_update_w		:=	sql_update_w || ' and		nr_seq_horario_dieta = ' || nr_seq_horario_w;
				sql_select_w		:= 	sql_select_w || ' and		nr_seq_horario_dieta = ' || nr_seq_horario_w;
				sql_select_pend_w	:=	sql_select_pend_w || ' and		nr_seq_horario_dieta = ' || nr_seq_horario_w;
			elsif (ie_tipo_item_adep_w in ('P','C','L','G')) then
				sql_update_w		:=	sql_update_w || ' and		nr_seq_horario_proc = ' || nr_seq_horario_w;
				sql_select_w		:= 	sql_select_w || ' and		nr_seq_horario_proc = ' || nr_seq_horario_w;
				sql_select_pend_w	:=	sql_select_pend_w || ' and		nr_seq_horario_proc = ' || nr_seq_horario_w;
			elsif (ie_tipo_item_adep_w in ('R')) then
				sql_update_w		:=	sql_update_w || ' and		nr_seq_horario_rec = ' || nr_seq_horario_w;
				sql_select_w		:= 	sql_select_w || ' and		nr_seq_horario_rec = ' || nr_seq_horario_w;
				sql_select_pend_w	:=	sql_select_pend_w || ' and		nr_seq_horario_rec = ' || nr_seq_horario_w;
			elsif (ie_tipo_item_adep_w in ('E')) then
				sql_update_w		:=	sql_update_w || ' and		nr_seq_horario_sae = ' || nr_seq_horario_w;
				sql_select_w		:= 	sql_select_w || ' and		nr_seq_horario_sae = ' || nr_seq_horario_w;
				sql_select_pend_w	:=	sql_select_pend_w || ' and		nr_seq_horario_sae = ' || nr_seq_horario_w;
			elsif (ie_tipo_item_adep_w in ('B')) then
				sql_update_w		:=	sql_update_w || ' and		nr_seq_horario_ordem = ' || nr_seq_horario_w;
				sql_select_w		:= 	sql_select_w || ' and		nr_seq_horario_ordem = ' || nr_seq_horario_w;
				sql_select_pend_w	:=	sql_select_pend_w || ' and		nr_seq_horario_ordem = ' || nr_seq_horario_w;
			else
				if (coalesce(nr_atendimento_w,0) > 0) then
					sql_update_w		:=	sql_update_w || ' and		nr_atendimento = ' || nr_atendimento_w || chr(10);
					sql_select_w		:= 	sql_select_w || ' and		nr_atendimento = ' || nr_atendimento_w || chr(10);
					sql_select_pend_w	:=	sql_select_pend_w || ' and		nr_atendimento = ' || nr_atendimento_w || chr(10);
				end if;

				sql_update_w		:=	sql_update_w || ' and		' || nr_seq_horario_w || ' in (nr_seq_horario, nr_seq_horario_proc, nr_seq_horario_rec, nr_seq_horario_sae, nr_seq_horario_dieta, nr_seq_horario_ordem) ';
				sql_select_w		:= 	sql_select_w || ' and		' || nr_seq_horario_w || ' in (nr_seq_horario, nr_seq_horario_proc, nr_seq_horario_rec, nr_seq_horario_sae, nr_seq_horario_dieta, nr_seq_horario_ordem) ';
				sql_select_pend_w	:=	sql_select_pend_w || ' and		' || nr_seq_horario_w || ' in (nr_seq_horario, nr_seq_horario_proc, nr_seq_horario_rec, nr_seq_horario_sae, nr_seq_horario_dieta, nr_seq_horario_ordem) ';
			end if;

		elsif (ie_tipo_item_adep_w in ('SOL','SNE','HM','NPA','NPN','NAN','NPP')) and (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') and (nr_seq_item_adep_w IS NOT NULL AND nr_seq_item_adep_w::text <> '') and (nr_etapa_adep_w IS NOT NULL AND nr_etapa_adep_w::text <> '') then

			sql_update_w	:=	' update	prescr_solucao_evento ' || chr(10) ||
						' set		nr_seq_assinatura = ' || coalesce(nr_seq_assinatura_p,0) || chr(10) ||
						' where		nm_usuario_nrec = ''' || nm_usuario_nrec_w || '''' || chr(10) ||
						' and		obter_data_assinatura_digital(nr_seq_assinatura) is null ' || chr(10) ||
						' and 		rownum <= 1 ' || chr(10) ||
						' and		nr_prescricao = ' || nr_prescricao_w || chr(10);

			sql_select_w	:= 	'select 	count(nr_sequencia)	' || chr(10) ||
						'from		prescr_solucao_evento 	' || chr(10) ||
						' where		nm_usuario_nrec = ''' || nm_usuario_nrec_w || '''' || chr(10) ||
						' and		obter_data_assinatura_digital(nr_seq_assinatura) is not null ' || chr(10) ||
						' and		nr_prescricao = ' || nr_prescricao_w || chr(10);

			if (coalesce(nr_atendimento_w,0) > 0) then
				sql_update_w	:=	sql_update_w || ' and		nr_atendimento = ' || nr_atendimento_w || chr(10);
				sql_select_w	:= 	sql_select_w || ' and		nr_atendimento = ' || nr_atendimento_w || chr(10);
			end if;

			if (coalesce(nr_etapa_adep_w,0) > 0) then
				sql_update_w	:=	sql_update_w || ' and		nvl(nr_etapa_evento,' || nr_etapa_adep_w || ') = ' || nr_etapa_adep_w || chr(10);
				sql_select_w	:=	sql_select_w || ' and		nvl(nr_etapa_evento,' || nr_etapa_adep_w || ') = ' || nr_etapa_adep_w || chr(10);
			end if;

			if (ie_tipo_item_adep_w = 'SOL') then
				sql_update_w	:=	sql_update_w ||
									' and		ie_tipo_solucao		= 1 ' || chr(10) ||
									' and		nr_seq_solucao		= ' || nr_seq_item_adep_w || chr(10);
				sql_select_w	:=	sql_select_w ||
									' and		ie_tipo_solucao		= 1 ' || chr(10) ||
									' and		nr_seq_solucao		= ' || nr_seq_item_adep_w || chr(10);

			elsif (ie_tipo_item_adep_w = 'SNE') then
				sql_update_w	:=	sql_update_w ||
									' and		ie_tipo_solucao		= 2 ' || chr(10) ||
									' and		nr_seq_material		= ' || nr_seq_item_adep_w || chr(10);
				sql_select_w	:=	sql_select_w ||
									' and		ie_tipo_solucao		= 2 ' || chr(10) ||
									' and		nr_seq_material		= ' || nr_seq_item_adep_w || chr(10);
			elsif (ie_tipo_item_adep_w = 'HM') then
				sql_update_w	:=	sql_update_w ||
									' and		ie_tipo_solucao		= 3 ' || chr(10) ||
									' and		nr_seq_procedimento	= ' || nr_seq_item_adep_w || chr(10);
				sql_select_w	:= 	sql_select_w ||
									' and		ie_tipo_solucao		= 3 ' || chr(10) ||
									' and		nr_seq_procedimento	= ' || nr_seq_item_adep_w || chr(10);
			elsif (ie_tipo_item_adep_w = 'NPA') then
				sql_update_w	:=	sql_update_w ||
									' and		ie_tipo_solucao		= 4 ' || chr(10) ||
									' and		nr_seq_nut	= ' || nr_seq_item_adep_w || chr(10);
				sql_select_w	:=	sql_select_w ||
									' and		ie_tipo_solucao		= 4 ' || chr(10) ||
									' and		nr_seq_nut	= ' || nr_seq_item_adep_w || chr(10);
			elsif (ie_tipo_item_adep_w = 'NPN') then
				sql_update_w	:=	sql_update_w ||
									' and		ie_tipo_solucao		= 5 ' || chr(10) ||
									' and		nr_seq_nut_neo	= ' || nr_seq_item_adep_w || chr(10);
				sql_select_w	:= 	sql_select_w ||
									' and		ie_tipo_solucao		= 5 ' || chr(10) ||
									' and		nr_seq_nut_neo	= ' || nr_seq_item_adep_w || chr(10);
			elsif (ie_tipo_item_adep_w = 'NAN') then
				sql_update_w	:=	sql_update_w ||
									' and		ie_tipo_solucao		= 6 ' || chr(10) ||
									' and		nr_seq_nut_neo	= ' || nr_seq_item_adep_w || chr(10);
				sql_select_w	:=	sql_select_w ||
									' and		ie_tipo_solucao		= 6 ' || chr(10) ||
									' and		nr_seq_nut_neo	= ' || nr_seq_item_adep_w || chr(10);
			elsif (ie_tipo_item_adep_w = 'NPP') then
				sql_update_w	:=	sql_update_w ||
									' and		ie_tipo_solucao		= 7 ' || chr(10) ||
									' and		nr_seq_nut_neo	= ' || nr_seq_item_adep_w || chr(10);
				sql_select_w	:=	sql_select_w ||
									' and		ie_tipo_solucao		= 7 ' || chr(10) ||
									' and		nr_seq_nut_neo	= ' || nr_seq_item_adep_w || chr(10);
			else
				sql_update_w	:=	null;
				sql_select_w	:= 	null;
			end if;
		end if;

		ie_deletou_w	:= false;

		begin
			qt_reg_pend_w 	:= 1;
			qt_reg_ass_w	:= 0;

			if	((sql_select_w IS NOT NULL AND sql_select_w::text <> '') or (sql_select_pend_w IS NOT NULL AND sql_select_pend_w::text <> '')) then
				sql_select_w	:=	sql_select_w || ' and		rownum = 1 '|| chr(10);
				qt_reg_ass_w := Obter_valor_Dinamico(sql_select_w, qt_reg_ass_w);

				sql_select_pend_w	:= 	sql_select_pend_w || ' and		rownum = 1 '|| chr(10);
				qt_reg_pend_w := Obter_valor_Dinamico(sql_select_pend_w, qt_reg_pend_w);

				if	((qt_reg_ass_w = 1) or (qt_reg_pend_w = 0)) then
					CALL delete_pep_item_pendente(nr_prescricao_w, nm_usuario_nrec_w, ie_tipo_item_adep_w, nr_seq_interno_p);
					ie_deletou_w	:= true;
				end if;

			end if;

		exception when others then
			ds_erro_w := substr(sqlerrm, 1,1700);
		end;

		if (sql_update_w IS NOT NULL AND sql_update_w::text <> '') then
			sql_update_w	:=	sql_update_w || ' and		rownum = 1 '|| chr(10);
			RAISE NOTICE '%', sql_update_w;
			EXECUTE sql_update_w;
		end if;

		GET DIAGNOSTICS ora2pg_rowcount = ROW_COUNT;


		if  ( ora2pg_rowcount = 0 AND not ie_deletou_w) then

		/*
			ie_ja_assinou_w	:= 'S';

			if	(ie_tipo_item_adep_w = 'E') then
				select 	coalesce(max('S'), 'N')
				into	ie_ja_assinou_w
				from	prescr_mat_alteracao
				where	nr_seq_horario_sae = nr_seq_horario_w
				and	nm_usuario_nrec = nm_usuario_nrec_w
				and	obter_data_assinatura_digital(nr_seq_assinatura) is not null;
			end if;

		*/
				<<consistencia>>
				--Ocorreu um erro na geração do item #@IE_TIPO_ITEM_ADEP#@
				--    (Prescr.:#@NR_PRESCRICAO#@ / Seq.:#@NR_SEQ_ITEM_ADEP#@ / Hor.:#@NR_SEQ_HORARIO#@ / Etapa:#@NR_ETAPA_ADEP#@)
				Wheb_mensagem_pck.exibir_mensagem_abort(282563,'IE_TIPO_ITEM_ADEP='||ie_tipo_item_adep_w||
															';NR_PRESCRICAO='||nr_prescricao_w||
															';NR_SEQ_ITEM_ADEP='||nr_seq_item_adep_w||
															';NR_SEQ_HORARIO='||nr_seq_horario_w||
															';NR_ETAPA_ADEP='||nr_etapa_adep_w);

		end if;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_hora_assinat_pendente ( nr_atendimento_p bigint, nr_seq_interno_p text, nr_seq_assinatura_p bigint) FROM PUBLIC;

