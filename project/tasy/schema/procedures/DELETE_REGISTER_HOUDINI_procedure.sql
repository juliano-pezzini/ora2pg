-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE delete_register_houdini ( DS_LISTA_SEQUENCIA_P text, NR_NEW_SEQ_ORIGEM_P bigint default null, IE_DELETE_REGISTER text DEFAULT 'N') AS $body$
DECLARE


	nm_tabela_w	w_apap_pac_informacao.nm_tabela%type;
    inactive_register_w CURSOR FOR
        SELECT 
            b.NM_TABELA, a.NR_SEQ_ORIGEM
        FROM W_APAP_PAC_REGISTRO a 
        INNER JOIN w_apap_pac_informacao b ON
            b.nr_sequencia = a.nr_seq_apap_inf
        WHERE 
            a.NR_SEQUENCIA in (SELECT w.nr_registro from table(lista_pck.obter_lista(ds_lista_sequencia_p)) w) AND
            (b.NM_TABELA IS NOT NULL AND b.NM_TABELA::text <> '') AND (a.NR_SEQ_ORIGEM IS NOT NULL AND a.NR_SEQ_ORIGEM::text <> '')
        GROUP BY  b.NM_TABELA, a.NR_SEQ_ORIGEM;
BEGIN
    FOR inactive_register_r IN inactive_register_w LOOP
		nm_tabela_w	:= upper(inactive_register_r.NM_TABELA);
		if (nm_tabela_w = 'EHR_REG_ELEMENTO') then
			nm_tabela_w	:= 'EHR_REGISTRO';
		end if;
		
        CALL inactivate_register_houdini(nm_tabela_w, inactive_register_r.NR_SEQ_ORIGEM , IE_DELETE_REGISTER);

        IF (NR_NEW_SEQ_ORIGEM_P IS NOT NULL AND NR_NEW_SEQ_ORIGEM_P::text <> '') THEN
            UPDATE W_APAP_PAC_REGISTRO
            SET NR_SEQ_ORIGEM = NR_NEW_SEQ_ORIGEM_P
            WHERE
                NR_SEQUENCIA IN ( SELECT 
                                    a.NR_SEQUENCIA 
                                FROM W_APAP_PAC_REGISTRO a 
                                INNER JOIN w_apap_pac_informacao b ON
                                    a.nr_seq_apap_inf = b.NR_SEQUENCIA
                                WHERE 
                                    b.NM_TABELA = inactive_register_r.NM_TABELA AND
                                    a.NR_SEQ_ORIGEM = inactive_register_r.NR_SEQ_ORIGEM AND
                                    (a.IE_STATUS_HOUDINI IS NOT NULL AND a.IE_STATUS_HOUDINI::text <> '') AND
                                    a.NM_USUARIO <> wheb_usuario_pck.get_nm_usuario);
        END IF;
    END LOOP;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE delete_register_houdini ( DS_LISTA_SEQUENCIA_P text, NR_NEW_SEQ_ORIGEM_P bigint default null, IE_DELETE_REGISTER text DEFAULT 'N') FROM PUBLIC;

