-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_concil_santander240_v082 (nr_seq_extrato_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


vl_saldo_inicial_w		double precision;
vl_saldo_final_w		double precision;
dt_saldo_inicial_w		timestamp;
dt_saldo_final_w		timestamp;
cd_agencia_w			varchar(5);
cd_conta_w			varchar(12);
cd_historico_w			varchar(4);
ds_historico_w			varchar(25);
ie_natureza_w			varchar(15);
nr_documento_w			varchar(39);
dt_movto_w			timestamp;
vl_extrato_w			double precision;
ie_deb_cred_w			varchar(1);
cd_categoria_w			varchar(3);
nr_seq_conta_w			bigint;
nr_lote_w			varchar(30);
qt_registro_w			bigint := 0;
nr_seq_dep_ident_item_w		bigint;
cd_banco_w			varchar(3);
nr_seq_banco_extrato_lanc_w	bigint;

c01 CURSOR FOR
	SELECT	substr(ds_conteudo,53,5) cd_agencia,
		substr(ds_conteudo,59,12) cd_conta,
		substr(ds_conteudo,170,3) cd_categoria,
		substr(ds_conteudo,173,4) cd_historico,
		substr(ds_conteudo,177,25) ds_historico,
		somente_numero(substr(ds_conteudo,202,39)) nr_documento,
		substr(ds_conteudo,143,8) dt_movto,
		somente_numero(substr(ds_conteudo,151,16)) || ',' || substr(ds_conteudo,167,2) vl_extrato,
		substr(ds_conteudo,169,1) ie_deb_cred,
		substr(ds_conteudo,4,4) nr_lote
	from	w_interf_concil
	where	substr(ds_conteudo,8,1)		= '3'
	and	substr(ds_conteudo,14,1)	= 'E'
	and	nr_seq_conta			= nr_seq_conta_w;


BEGIN
select	nr_seq_conta
into STRICT	nr_seq_conta_w
from	banco_extrato
where	nr_sequencia	= nr_seq_extrato_p;

select	max((substr(ds_conteudo,151,16) || ',' || substr(ds_conteudo,167,2))::numeric ) vl_extrato,
	max(to_date(substr(ds_conteudo,143,8),'ddmmyyyy')) dt_movto
into STRICT	vl_saldo_inicial_w,
	dt_saldo_inicial_w
from	w_interf_concil
where	substr(ds_conteudo,8,1) = '1';

select	max((substr(ds_conteudo,151,16) || ',' || substr(ds_conteudo,167,2))::numeric ) vl_extrato,
	max(to_date(substr(ds_conteudo,143,8),'ddmmyyyy')) dt_movto,
	max((substr(ds_conteudo,1,3))::numeric ) cd_banco
into STRICT	vl_saldo_final_w,
	dt_saldo_final_w,
	cd_banco_w
from	w_interf_concil
where	substr(ds_conteudo,8,1)		= '5';

select	count(1)
into STRICT	qt_registro_w
from	banco_hist_dep_ident a
where	a.cd_banco	= cd_banco_w;

/* Se houver regra de histórico de depósito identificado */

if (qt_registro_w > 0) then
	select	count(1)
	into STRICT	qt_registro_w
	from	lote_ret_deposito_ident a
	where	a.nr_seq_conta_banco	= nr_seq_conta_w;
end if;

open c01;
loop
fetch c01 into
	cd_agencia_w,
	cd_conta_w,
	cd_categoria_w,
	cd_historico_w,
	ds_historico_w,
	nr_documento_w,
	dt_movto_w,
	vl_extrato_w,
	ie_deb_cred_w,
	nr_lote_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	ie_natureza_w	:= 'D';

	if (coalesce(cd_historico_w,'0') in ('0911','0912','0913','0914','0915','0916','0917','0918','0919')) then
		ie_natureza_w	:= 'B';
	end if;

	select	nextval('banco_extrato_lanc_seq')
	into STRICT	nr_seq_banco_extrato_lanc_w
	;

	insert into banco_extrato_lanc(cd_agencia_origem,
		cd_categoria,
		cd_historico,
		ds_historico,
		dt_atualizacao,
		dt_atualizacao_nrec,
		dt_movimento,
		ie_conciliacao,
		ie_deb_cred,
		nm_usuario,
		nm_usuario_nrec,
		nr_documento,
		nr_seq_extrato,
		nr_sequencia,
		vl_lancamento,
		nr_lote,
		ie_natureza)
	values (cd_agencia_w,
		cd_categoria_w,
		cd_historico_w,
		ds_historico_w,
		clock_timestamp(),
		clock_timestamp(),
		dt_movto_w,
		'N',
		ie_deb_cred_w,
		nm_usuario_p,
		nm_usuario_p,
		nr_documento_w,
		nr_seq_extrato_p,
		nr_seq_banco_extrato_lanc_w,
		vl_extrato_w,
		nr_lote_w,
		ie_natureza_w);

	/* Se houver lote de depósito identificado com a mesma conta bancária */

	if (qt_registro_w > 0) then
		dt_movto_w	:= to_char(dt_movto_w,'dd/mm/yy');

		nr_documento_w := substr(nr_documento_w,length(nr_documento_w) -1,1);

		select	max(b.nr_sequencia)
		into STRICT	nr_seq_dep_ident_item_w
		from	lote_ret_dep_ident_item	b,
			lote_ret_deposito_ident	a
		where	b.nr_seq_lote		= a.nr_sequencia
		and	a.nr_seq_conta_banco	= nr_seq_conta_w
		and	b.cd_identificacao	= nr_documento_w
		and	b.vl_deposito		= vl_extrato_w
		and	b.dt_deposito		= dt_movto_w;

		/* Grava qual depósito identificado */

		if (nr_seq_dep_ident_item_w IS NOT NULL AND nr_seq_dep_ident_item_w::text <> '') then
			update	banco_extrato_lanc
			set	nr_seq_dep_ident_item	= nr_seq_dep_ident_item_w
			where	nr_sequencia		= nr_seq_banco_extrato_lanc_w;
		end if;
	end if;
end loop;
close c01;

update	banco_extrato
set	vl_saldo_inicial	= vl_saldo_inicial_w,
	vl_saldo_final		= vl_saldo_final_w,
	dt_inicio		= dt_saldo_inicial_w,
	dt_final		= dt_saldo_final_w
where	nr_sequencia		= nr_seq_extrato_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_concil_santander240_v082 (nr_seq_extrato_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

