-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_diagnosis_icd_barthel ( nr_atendimento_p bigint, cd_doenca_p text, cd_doenca_superior_p text default null, cd_pessoa_fisica_p text DEFAULT NULL, ds_classifications_p text DEFAULT NULL, nr_cirurgia_p bigint default null, ie_lado_p text default null, ie_classificacao_doenca_p text default null, ie_tipo_diagnostico_p text default null, dt_diagnostico_p INOUT timestamp DEFAULT NULL) AS $body$
BEGIN

    -- Insere o diagnóstico
    CALL gerar_diagnostico_atend(
        nr_atendimento_p,
        cd_doenca_p,
        cd_pessoa_fisica_p,
        Wheb_usuario_pck.get_nm_usuario());

    COMMIT;

    -- Guarda a data do diagnóstico
    select max(dt_diagnostico)
    into STRICT dt_diagnostico_p
    from	diagnostico_medico
    where	pkg_date_utils.start_of(dt_diagnostico,'DD',0)	= pkg_date_utils.start_of(clock_timestamp(),'DD',0)
        and		nr_atendimento		= nr_atendimento_p
        and		cd_medico		    = cd_pessoa_fisica_p;

    -- Atualiza o diagnóstico que acabou de ser inserido
    update  diagnostico_doenca
    set     cd_doenca_superior  = cd_doenca_superior_p,
            nr_cirurgia         = nr_cirurgia_p,
            ie_lado             = ie_lado_p,
            ie_classificacao_doenca = ie_classificacao_doenca_p,
            ie_tipo_diagnostico = ie_tipo_diagnostico_p,
            dt_liberacao		= clock_timestamp()
    where   dt_diagnostico      = dt_diagnostico_p
    and     cd_doenca           = cd_doenca_p;
    COMMIT;

    -- Insere as classificações do diagnóstico
    if (ds_classifications_p IS NOT NULL AND ds_classifications_p::text <> '')then
        CALL inserir_classif_diagnostico(
            ds_classifications_p,
            wheb_usuario_pck.get_cd_estabelecimento(),
            Wheb_usuario_pck.get_nm_usuario(),
            nr_atendimento_p,
            cd_pessoa_fisica_p,
            cd_doenca_p,
            dt_diagnostico_p);
    end if;

    COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_diagnosis_icd_barthel ( nr_atendimento_p bigint, cd_doenca_p text, cd_doenca_superior_p text default null, cd_pessoa_fisica_p text DEFAULT NULL, ds_classifications_p text DEFAULT NULL, nr_cirurgia_p bigint default null, ie_lado_p text default null, ie_classificacao_doenca_p text default null, ie_tipo_diagnostico_p text default null, dt_diagnostico_p INOUT timestamp DEFAULT NULL) FROM PUBLIC;

