-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE verifica_contr_acompanhante ( nr_controle_p text, ds_mensagem_p INOUT text, ds_mensagem1_p INOUT text) AS $body$
DECLARE

 
nr_atendimento_w    bigint;
nr_acompanhante_w    smallint;
nm_acompanhante_w	varchar(40);
ds_msg_w		varchar(255);
qt_acomp_controle_w	bigint;
ds_msg1_w        varchar(255);
					

BEGIN 
ds_msg_w := '';
ds_msg1_w := wheb_mensagem_pck.get_texto(795933);
 
 
if (nr_controle_p IS NOT NULL AND nr_controle_p::text <> '') then 
 
	begin 
	 
	select	count(*) 
	into STRICT	qt_acomp_controle_w 
	from	atendimento_acompanhante 
	where	dt_acompanhante = ( 	SELECT max(dt_acompanhante) 
					from  atendimento_acompanhante 
					where nr_controle = nr_controle_p 
					and  coalesce(dt_saida::text, '') = '') 
	and  nr_controle = nr_controle_p 
	and  coalesce(dt_saida::text, '') = '';	
	 
	exception 
	when others then 
	 
	qt_acomp_controle_w := 0;
	 
	end;
 
	 
	if (coalesce(qt_acomp_controle_w,0) > 0) then 
		 
		begin 
		 
		select nr_acompanhante, 
			coalesce(nr_atendimento,0), 
			substr(coalesce(obter_nome_pf(cd_pessoa_fisica),nm_acompanhante),1,40) 
		into STRICT	nr_acompanhante_w, 
			nr_atendimento_w, 
			nm_acompanhante_w 
		from  atendimento_acompanhante 
		where  dt_acompanhante = ( 	SELECT max(dt_acompanhante) 
						from  atendimento_acompanhante 
						where nr_controle = nr_controle_p 
						and  coalesce(dt_saida::text, '') = '') 
		and  nr_controle = nr_controle_p 
		and  coalesce(dt_saida::text, '') = '';
 
		if (coalesce(nr_atendimento_w,0) > 0) then 
			 
			if (nm_acompanhante_w IS NOT NULL AND nm_acompanhante_w::text <> '') then 
				ds_msg_w := wheb_mensagem_pck.get_texto(795934, 
								'NM_ACOMPANHANTE='||nm_acompanhante_w|| 
								';NR_ATENDIMENTO='||nr_atendimento_w);				       					 					
			else 
				ds_msg_w := wheb_mensagem_pck.get_texto(795935, 
								'NR_ATENDIMENTO='||nr_atendimento_w);					
			end if;
			 
		end if;		
		exception 
		when others then 
		 
		ds_msg_w := '';
		 
		end;		
	end if;
 
end if;
 
ds_mensagem_p := substr(ds_msg_w,1,255);
ds_mensagem1_p := substr(ds_msg1_w,1,255);
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE verifica_contr_acompanhante ( nr_controle_p text, ds_mensagem_p INOUT text, ds_mensagem1_p INOUT text) FROM PUBLIC;

