-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_consist_prot_lote ( ds_protocolos_p text, nm_usuario_p text) AS $body$
DECLARE

 
 
 
nr_atend_mat_sc_w		bigint;
nr_atend_proc_sc_w		bigint;
cd_material_sc_w		bigint;
nr_sequencia_aux_w		bigint;
nr_protocolo_w			varchar(255);
nr_interno_conta_aux_w	bigint;
nr_seq_protocolo_w		bigint;
cd_procedimento_sc_w	bigint;
			
			 
C01 CURSOR FOR 
		SELECT	coalesce(a.nr_atendimento,0) 
		from	material_atend_paciente a, 
				conta_paciente b 
		where	obter_se_contido_char(b.nr_seq_protocolo,ds_protocolos_p) = 'S' 
		and		coalesce(a.cd_conta_contabil::text, '') = '' 
		and		a.nr_interno_conta = b.nr_interno_conta 
		and		coalesce(a.cd_motivo_exc_conta::text, '') = '';
		
C02 CURSOR FOR 
		SELECT	coalesce(a.nr_atendimento,0) 
		from	Procedimento_paciente a, 
				conta_paciente b 
		where	obter_se_contido_char(b.nr_seq_protocolo,ds_protocolos_p) = 'S' 
		and		coalesce(a.cd_conta_contabil::text, '') = '' 
		and		a.nr_interno_conta = b.nr_interno_conta 
		and		coalesce(a.cd_motivo_exc_conta::text, '') = '';	
			 
			 

BEGIN 
 
delete from w_ctb_consiste_prot_conta 
where	nm_usuario	=	nm_usuario_p;
 
open C01;
loop 
fetch C01 into	 
	nr_atend_mat_sc_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	if (nr_atend_mat_sc_w > 0) then 
		select	coalesce(max(nr_sequencia),0) 
		into STRICT	nr_sequencia_aux_w 
		from	material_atend_paciente
		where	nr_atendimento = nr_atend_mat_sc_w 
		and		coalesce(cd_conta_contabil::text, '') = '' 
		and		coalesce(cd_motivo_exc_conta::text, '') = '';
		 
		if (nr_sequencia_aux_w > 0) then 
			select 	cd_material, 
					nr_interno_conta 
			into STRICT	cd_material_sc_w, 
					nr_interno_conta_aux_w 
			from	material_atend_paciente 
			where	nr_sequencia = nr_sequencia_aux_w;
		end if;
 
		select	coalesce(max(c.nr_protocolo), nr_protocolo_w) 
		into STRICT	nr_protocolo_w 
		from	conta_paciente c, 
				material_atend_paciente p 
		where	p.nr_interno_conta = c.nr_interno_conta 
		and		c.nr_atendimento = nr_atend_mat_sc_w 
		and		coalesce(p.cd_conta_contabil::text, '') = '' 
		and		coalesce(p.cd_motivo_exc_conta::text, '') = '';
		 
		select	max(c.nr_seq_protocolo) 
		into STRICT	nr_seq_protocolo_w 
		from	conta_paciente c, 
				material_atend_paciente p 
		where	p.nr_interno_conta = c.nr_interno_conta 
		and		c.nr_atendimento = nr_atend_mat_sc_w 
		and		coalesce(p.cd_conta_contabil::text, '') = '' 
		and		coalesce(p.cd_motivo_exc_conta::text, '') = '';
	end if;
	 
	insert	into w_ctb_consiste_prot_conta(		nr_atend_mat_sc, 
												cd_material_sc, 
												nr_atend_proc_sc, 
												cd_procedimento_sc, 
												nr_seq_protocolo, 
												nr_protocolo, 
												nr_interno_conta_aux, 
												ie_tipo, 
												nm_usuario) 	 
									values (	nr_atend_mat_sc_w, 
												cd_material_sc_w, 
												null, 
												null, 
												nr_seq_protocolo_w, 
												nr_protocolo_w, 
												nr_interno_conta_aux_w, 
												1, -- Material 
												nm_usuario_p);
	 
	end;
end loop;
close C01;
 
open C02;
loop 
fetch C02 into	 
	nr_atend_proc_sc_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin 
	if (nr_atend_proc_sc_w > 0) then 
				 
		select	coalesce(max(cd_procedimento),0) 
		into STRICT	cd_procedimento_sc_w 
		from	Procedimento_paciente
		where	coalesce(cd_conta_contabil::text, '') = '' 
		and		nr_atendimento = nr_atend_proc_sc_w 
		and		coalesce(cd_motivo_exc_conta::text, '') = '';
 
		select	max(c.nr_protocolo) 
		into STRICT	nr_protocolo_w 
		from	conta_paciente c, 
				procedimento_paciente p 
		where	c.nr_interno_conta 	= p.nr_interno_conta 
		and		c.nr_atendimento 	= nr_atend_proc_sc_w 
		and		coalesce(p.cd_conta_contabil::text, '') = '' 
		and		coalesce(p.cd_motivo_exc_conta::text, '') = '';
 
		select	max(c.nr_seq_protocolo), 
				max(c.nr_interno_conta) 
		into STRICT	nr_seq_protocolo_w, 
				nr_interno_conta_aux_w 
		from	conta_paciente c, 
				procedimento_paciente p 
		where	c.nr_interno_conta = p.nr_interno_conta 
		and		c.nr_atendimento = nr_atend_proc_sc_w 
		and		coalesce(p.cd_conta_contabil::text, '') = '' 
		and		coalesce(p.cd_motivo_exc_conta::text, '') = '';
		 
		 
		insert	into w_ctb_consiste_prot_conta(	nr_atend_mat_sc, 
												cd_material_sc, 
												nr_atend_proc_sc, 
												cd_procedimento_sc, 
												nr_seq_protocolo, 
												nr_protocolo, 
												nr_interno_conta_aux, 
												ie_tipo, 
												nm_usuario) 	 
									values (	null, 
												null, 
												nr_atend_proc_sc_w, 
												cd_procedimento_sc_w, 
												nr_seq_protocolo_w, 
												nr_protocolo_w, 
												nr_interno_conta_aux_w, 
												2, -- Procedimento 
												nm_usuario_p);
 
	end if;
	end;
end loop;
close C02;
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_consist_prot_lote ( ds_protocolos_p text, nm_usuario_p text) FROM PUBLIC;

