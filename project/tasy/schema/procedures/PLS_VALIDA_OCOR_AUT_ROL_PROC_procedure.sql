-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_valida_ocor_aut_rol_proc ( nr_seq_ocor_combinada_p bigint, nr_seq_ocorrencia_p bigint, nr_seq_segurado_p bigint, nr_seq_motivo_glosa_p bigint, nr_seq_guia_p bigint, nr_seq_requisicao_p bigint, nr_seq_execucao_p bigint, ie_utiliza_filtro_p text, nr_seq_param1_p bigint, nr_seq_param2_p bigint, nr_seq_param3_p bigint, nr_seq_param4_p bigint, nr_seq_param5_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


qt_registros_dut_w 			bigint;
qt_registros_pac_w 			bigint;
qt_registros_dut_rol_w 		bigint;
qt_registros_pac_rol_w 		bigint;
nr_seq_guia_proc_w 			bigint;
cd_procedimento_w 			bigint;
ie_origem_proced_w			bigint;
ie_tipo_item_w				bigint;
nr_seq_req_proc_w			bigint;
ie_gerou_ocor_cabecalho_w	bigint;
nr_seq_oc_benef_w			bigint;
ie_tipo_ocorrencia_w		varchar(2);
nr_seq_exec_proc_w			bigint;
ie_regra_w					varchar(1);
ie_gerar_ocorrencia_w		varchar(1) 	:= 'N';
dt_inicio_vigencia_w		timestamp;


C01 CURSOR FOR
SELECT	nr_sequencia,
		cd_procedimento,
		ie_origem_proced
from	pls_guia_plano_proc
where	nr_seq_guia		= nr_seq_guia_p;

C02 CURSOR FOR
SELECT	nr_sequencia,
		cd_procedimento,
		ie_origem_proced
from	pls_requisicao_proc
where	nr_seq_requisicao	= nr_seq_requisicao_p;

C03 CURSOR FOR
SELECT	nr_sequencia,
		cd_procedimento,
		ie_origem_proced
from	pls_execucao_req_item
where	nr_seq_execucao		= nr_seq_execucao_p
and		(cd_procedimento IS NOT NULL AND cd_procedimento::text <> '')
and		(ie_origem_proced IS NOT NULL AND ie_origem_proced::text <> '');


BEGIN

select	count(1)
into STRICT	qt_registros_dut_w
from	pls_validacao_aut_rol_proc
where	nr_seq_ocor_aut_combinada	= nr_seq_ocor_combinada_p
and		ie_situacao			= 'A'
and		ie_valida_dut			= 'S';

select	count(1)
into STRICT	qt_registros_pac_w
from	pls_validacao_aut_rol_proc
where	nr_seq_ocor_aut_combinada	= nr_seq_ocor_combinada_p
and		ie_situacao			= 'A'
and		ie_valida_pac			= 'S';

begin
	select	max(dt_inicio_vigencia)
	into STRICT	dt_inicio_vigencia_w
	from	pls_rol
	where  ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_vigencia) <= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp());
exception
when others then
	dt_inicio_vigencia_w := null;
end;

if (nr_seq_guia_p IS NOT NULL AND nr_seq_guia_p::text <> '') then
	open C01;
	loop
	fetch C01 into	
		nr_seq_guia_proc_w,
		cd_procedimento_w,
		ie_origem_proced_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ie_gerar_ocorrencia_w	:= 'N';

		if (qt_registros_dut_w > 0) then
			select	count(1)
			into STRICT	qt_registros_dut_rol_w
			from	pls_rol_procedimento		a,
					pls_rol_grupo_proc		b,
					pls_rol_subgrupo		c,
					pls_rol_grupo			d,
					pls_rol_capitulo		e,
					pls_rol				f
			where	f.nr_sequencia			= e.nr_seq_rol
			and		e.nr_sequencia			= d.nr_seq_capitulo
			and		d.nr_sequencia			= c.nr_seq_grupo
			and		c.nr_sequencia			= b.nr_seq_subgrupo
			and		b.nr_sequencia			= a.nr_seq_rol_grupo
			and		a.cd_procedimento		= cd_procedimento_w
			and		a.ie_origem_proced		= ie_origem_proced_w
			and		b.ie_diretriz_utilizacao	= 'S'
			and		b.ie_situacao			= 'A'
			and		c.ie_situacao			= 'A'
			and		d.ie_situacao			= 'A'
			and		e.ie_situacao			= 'A'
			and		f.dt_inicio_vigencia		= dt_inicio_vigencia_w
			and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(f.dt_inicio_vigencia) <= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp());--DUT
		end if;
		
		if (qt_registros_pac_w > 0) then
		select	count(1)
			into STRICT	qt_registros_pac_rol_w
			from	pls_rol_procedimento		a,
					pls_rol_grupo_proc		b,
					pls_rol_subgrupo		c,
					pls_rol_grupo			d,
					pls_rol_capitulo		e,
					pls_rol				f
			where	f.nr_sequencia			= e.nr_seq_rol
			and		e.nr_sequencia			= d.nr_seq_capitulo
			and		d.nr_sequencia			= c.nr_seq_grupo
			and		c.nr_sequencia			= b.nr_seq_subgrupo
			and		b.nr_sequencia			= a.nr_seq_rol_grupo
			and		a.cd_procedimento		= cd_procedimento_w
			and		a.ie_origem_proced		= ie_origem_proced_w
			and     b.ie_complexidade       	= 'S'
			and		b.ie_situacao			= 'A'
			and		c.ie_situacao			= 'A'
			and		d.ie_situacao			= 'A'
			and		e.ie_situacao			= 'A'		
			and		f.dt_inicio_vigencia		= dt_inicio_vigencia_w
			and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(f.dt_inicio_vigencia) <= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp());--DUT	
		end if;

		
		if (qt_registros_dut_rol_w	> 0) or (qt_registros_pac_rol_w	> 0) then
			ie_gerar_ocorrencia_w	:= 'S';
		end if;

		if (ie_gerar_ocorrencia_w 	= 'S')	and (ie_utiliza_filtro_p 	= 'S') then
			/* Tratamento para filtros */

			SELECT * FROM pls_gerar_ocor_aut_filtro(	nr_seq_ocor_combinada_p, nr_seq_guia_p, null, null, nr_seq_guia_proc_w, null, null, null, null, cd_procedimento_w, ie_origem_proced_w, null, ie_gerou_ocor_cabecalho_w, null, null, null, null, null, nm_usuario_p, ie_regra_w, ie_tipo_ocorrencia_w) INTO STRICT ie_regra_w, ie_tipo_ocorrencia_w;

			if (ie_regra_w	= 'S') then
				ie_gerar_ocorrencia_w	:= 'S';
			elsif (ie_regra_w	in ('E','N')) then
				ie_gerar_ocorrencia_w	:= 'N';
			end if;
		end if;

		if (ie_gerar_ocorrencia_w	= 'S')	then
			ie_tipo_item_w	:= 1;
			
			nr_seq_oc_benef_w := pls_inserir_ocorrencia(	nr_seq_segurado_p, nr_seq_ocorrencia_p, null, nr_seq_guia_p, null, nr_seq_guia_proc_w, null, nr_seq_ocor_combinada_p, nm_usuario_p, null, nr_seq_motivo_glosa_p, ie_tipo_item_w, cd_estabelecimento_p, 'N', nr_seq_execucao_p, nr_seq_oc_benef_w, null, null, null, null);
						
			CALL pls_atualizar_status_ocor_comb(	nr_seq_ocorrencia_p, nr_seq_ocor_combinada_p, nr_seq_motivo_glosa_p,
							nr_seq_guia_p, null, null,
							nr_seq_guia_proc_w, null, null,
							null, null, null,
							nm_usuario_p, cd_estabelecimento_p);
		end if;
		end;
	end loop;
	close c01;
elsif (nr_seq_requisicao_p IS NOT NULL AND nr_seq_requisicao_p::text <> '') then
	open C02;
	loop
	fetch C02 into	
		nr_seq_req_proc_w,
		cd_procedimento_w,
		ie_origem_proced_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		ie_gerar_ocorrencia_w	:= 'N';
		
		if (qt_registros_dut_w > 0) then
			select	count(1)
			into STRICT	qt_registros_dut_rol_w
			from	pls_rol_procedimento		a,
					pls_rol_grupo_proc		b,
					pls_rol_subgrupo		c,
					pls_rol_grupo			d,
					pls_rol_capitulo		e,
					pls_rol				f
			where	f.nr_sequencia			= e.nr_seq_rol
			and		e.nr_sequencia			= d.nr_seq_capitulo
			and		d.nr_sequencia			= c.nr_seq_grupo
			and		c.nr_sequencia			= b.nr_seq_subgrupo
			and		b.nr_sequencia			= a.nr_seq_rol_grupo
			and		a.cd_procedimento		= cd_procedimento_w
			and		a.ie_origem_proced		= ie_origem_proced_w
			and		b.ie_diretriz_utilizacao	= 'S'
			and		b.ie_situacao			= 'A'
			and		c.ie_situacao			= 'A'
			and		d.ie_situacao			= 'A'
			and		e.ie_situacao			= 'A'
			and		f.dt_inicio_vigencia		= dt_inicio_vigencia_w
			and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(f.dt_inicio_vigencia) <= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp());--DUT	
		end if;
		
		if (qt_registros_pac_w > 0) then
		select	count(1)
			into STRICT	qt_registros_pac_rol_w
			from	pls_rol_procedimento		a,
					pls_rol_grupo_proc		b,
					pls_rol_subgrupo		c,
					pls_rol_grupo			d,
					pls_rol_capitulo		e,
					pls_rol				f
			where	f.nr_sequencia			= e.nr_seq_rol
			and		e.nr_sequencia			= d.nr_seq_capitulo
			and		d.nr_sequencia			= c.nr_seq_grupo
			and		c.nr_sequencia			= b.nr_seq_subgrupo
			and		b.nr_sequencia			= a.nr_seq_rol_grupo
			and		a.cd_procedimento		= cd_procedimento_w
			and		a.ie_origem_proced		= ie_origem_proced_w
			and     b.ie_complexidade      		= 'S'
			and		b.ie_situacao			= 'A'
			and		c.ie_situacao			= 'A'
			and		d.ie_situacao			= 'A'
			and		e.ie_situacao			= 'A'
			and		f.dt_inicio_vigencia		= dt_inicio_vigencia_w			
			and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(f.dt_inicio_vigencia) <= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp());--DUT	
		end if;
		
		if (qt_registros_dut_rol_w	> 0) or (qt_registros_pac_rol_w	> 0) then
			ie_gerar_ocorrencia_w	:= 'S';
		end if;

		if (ie_gerar_ocorrencia_w 	= 'S')	and (ie_utiliza_filtro_p 	= 'S') then
			/* Tratamento para filtros */

			SELECT * FROM pls_gerar_ocor_aut_filtro(	nr_seq_ocor_combinada_p, null, nr_seq_requisicao_p, null, null, null, nr_seq_req_proc_w, null, null, cd_procedimento_w, ie_origem_proced_w, null, ie_gerou_ocor_cabecalho_w, null, null, null, null, null, nm_usuario_p, ie_regra_w, ie_tipo_ocorrencia_w) INTO STRICT ie_regra_w, ie_tipo_ocorrencia_w;

			if (ie_regra_w	= 'S') then
				ie_gerar_ocorrencia_w	:= 'S';
			elsif (ie_regra_w	in ('E','N')) then
				ie_gerar_ocorrencia_w	:= 'N';
			end if;
		end if;

		if (ie_gerar_ocorrencia_w	= 'S')	then
			ie_tipo_item_w	:= 5;
			
			nr_seq_oc_benef_w := pls_inserir_ocorrencia(	nr_seq_segurado_p, nr_seq_ocorrencia_p, nr_seq_requisicao_p, null, null, nr_seq_req_proc_w, null, nr_seq_ocor_combinada_p, nm_usuario_p, null, nr_seq_motivo_glosa_p, ie_tipo_item_w, cd_estabelecimento_p, 'N', nr_seq_execucao_p, nr_seq_oc_benef_w, null, null, null, null);
						
			CALL pls_atualizar_status_ocor_comb(	nr_seq_ocorrencia_p, nr_seq_ocor_combinada_p, nr_seq_motivo_glosa_p,
							null, nr_seq_requisicao_p, null,
							null, null, nr_seq_req_proc_w,
							null, null, null,
							nm_usuario_p, cd_estabelecimento_p);			
		end if;
		end;
	end loop;
	close c02;
elsif (nr_seq_execucao_p IS NOT NULL AND nr_seq_execucao_p::text <> '') then
	open C03;
	loop
	fetch C03 into	
		nr_seq_exec_proc_w,
		cd_procedimento_w,
		ie_origem_proced_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin
		ie_gerar_ocorrencia_w	:= 'N';
	
		if (qt_registros_dut_w > 0) then
			select	count(1)
			into STRICT	qt_registros_dut_rol_w
			from	pls_rol_procedimento		a,
					pls_rol_grupo_proc		b,
					pls_rol_subgrupo		c,
					pls_rol_grupo			d,
					pls_rol_capitulo		e,
					pls_rol				f
			where	f.nr_sequencia			= e.nr_seq_rol
			and		e.nr_sequencia			= d.nr_seq_capitulo
			and		d.nr_sequencia			= c.nr_seq_grupo
			and		c.nr_sequencia			= b.nr_seq_subgrupo
			and		b.nr_sequencia			= a.nr_seq_rol_grupo
			and		a.cd_procedimento		= cd_procedimento_w
			and		a.ie_origem_proced		= ie_origem_proced_w
			and		b.ie_diretriz_utilizacao	= 'S'	
			and		b.ie_situacao			= 'A'
			and		c.ie_situacao			= 'A'
			and		d.ie_situacao			= 'A'
			and		e.ie_situacao			= 'A'
			and		f.dt_inicio_vigencia		= dt_inicio_vigencia_w
			and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(f.dt_inicio_vigencia) <= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp());--DUT	
		end if;
		
		if (qt_registros_pac_w > 0) then
		select	count(1)
			into STRICT	qt_registros_pac_rol_w
			from	pls_rol_procedimento		a,
					pls_rol_grupo_proc		b,
					pls_rol_subgrupo		c,
					pls_rol_grupo			d,
					pls_rol_capitulo		e,
					pls_rol				f
			where	f.nr_sequencia			= e.nr_seq_rol
			and		e.nr_sequencia			= d.nr_seq_capitulo
			and		d.nr_sequencia			= c.nr_seq_grupo
			and		c.nr_sequencia			= b.nr_seq_subgrupo
			and		b.nr_sequencia			= a.nr_seq_rol_grupo
			and		a.cd_procedimento		= cd_procedimento_w
			and		a.ie_origem_proced		= ie_origem_proced_w
			and     b.ie_complexidade      		= 'S'	
			and		b.ie_situacao			= 'A'
			and		c.ie_situacao			= 'A'
			and		d.ie_situacao			= 'A'
			and		e.ie_situacao			= 'A'		
			and		f.dt_inicio_vigencia		= dt_inicio_vigencia_w			
			and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(f.dt_inicio_vigencia) <= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp());--DUT	
		end if;
		
		if (qt_registros_dut_rol_w	> 0) or (qt_registros_pac_rol_w	> 0) then
			ie_gerar_ocorrencia_w	:= 'S';
		end if;
		
		if (ie_gerar_ocorrencia_w 	= 'S')	and (ie_utiliza_filtro_p 	= 'S') then
			/* Tratamento para filtros */

			SELECT * FROM pls_gerar_ocor_aut_filtro(	nr_seq_ocor_combinada_p, null, null, nr_seq_execucao_p, null, null, null, null, nr_seq_exec_proc_w, cd_procedimento_w, ie_origem_proced_w, null, ie_gerou_ocor_cabecalho_w, null, null, null, null, null, nm_usuario_p, ie_regra_w, ie_tipo_ocorrencia_w) INTO STRICT ie_regra_w, ie_tipo_ocorrencia_w;
			
			if (ie_regra_w	= 'S') then
				ie_gerar_ocorrencia_w	:= 'S';
			elsif (ie_regra_w	in ('E','N')) then
				ie_gerar_ocorrencia_w	:= 'N';
			end if;
		end if;

		if (ie_gerar_ocorrencia_w	= 'S')	then
			ie_tipo_item_w	:= 10;

			nr_seq_oc_benef_w := pls_inserir_ocorrencia(	nr_seq_segurado_p, nr_seq_ocorrencia_p, null, null, null, nr_seq_exec_proc_w, null, nr_seq_ocor_combinada_p, nm_usuario_p, null, nr_seq_motivo_glosa_p, ie_tipo_item_w, cd_estabelecimento_p, 'N', nr_seq_execucao_p, nr_seq_oc_benef_w, null, null, null, null);
						
			CALL pls_atualizar_status_ocor_comb(	nr_seq_ocorrencia_p, nr_seq_ocor_combinada_p, nr_seq_motivo_glosa_p,
							null, null, nr_seq_execucao_p,
							null, null, null,
							null, nr_seq_exec_proc_w, null,
							nm_usuario_p, cd_estabelecimento_p);
		end if;
		end;
	end loop;
	close c03;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_valida_ocor_aut_rol_proc ( nr_seq_ocor_combinada_p bigint, nr_seq_ocorrencia_p bigint, nr_seq_segurado_p bigint, nr_seq_motivo_glosa_p bigint, nr_seq_guia_p bigint, nr_seq_requisicao_p bigint, nr_seq_execucao_p bigint, ie_utiliza_filtro_p text, nr_seq_param1_p bigint, nr_seq_param2_p bigint, nr_seq_param3_p bigint, nr_seq_param4_p bigint, nr_seq_param5_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

