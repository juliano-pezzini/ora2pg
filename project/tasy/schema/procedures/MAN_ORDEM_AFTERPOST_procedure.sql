-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_ordem_afterpost ( nm_usuario_p text, nr_sequencia_p bigint, obter_acao_p bigint, cd_pessoa_fisica_p text) AS $body$
DECLARE



nr_seq_nao_conform_w  		bigint;
qt_ordem_servico_w	 	bigint;
ie_nao_conformidade_w		varchar(1);
ie_status_w			varchar(255);
ds_mensagem327031	 	varchar(255)	:= obter_texto_tasy(327031,null);
ds_mensagem327030	 	varchar(255)	:= obter_texto_tasy(327030,null);
ie_usuario_solicit_w	 	varchar(1);
nr_grupo_trabalho_w		man_ordem_servico.nr_grupo_trabalho%type;
ie_usuario_grupo_solic_w	varchar(1);


BEGIN
ie_nao_conformidade_w := obter_param_usuario(4000, 247, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_nao_conformidade_w);
ie_usuario_solicit_w := obter_param_usuario(4000, 118, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_usuario_solicit_w);
ie_usuario_grupo_solic_w := obter_param_usuario(4000, 337, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_usuario_grupo_solic_w);

select  coalesce((select  nr_seq_nao_conform
	     from    man_ordem_servico
	     where   nr_sequencia = nr_sequencia_p),0) nr_seq_nao_conform,
        (select	count(*) qt_ordem_servico
         from	man_ordem_servico
         where	ie_status_ordem <> '3'
         and    nr_seq_nao_conform = (select	nr_seq_nao_conform
				      from	man_ordem_servico
				      where	nr_sequencia = nr_sequencia_p)) qt_ordem_servico,
	(select	max(nr_grupo_trabalho)
	from	man_ordem_servico
	where	nr_sequencia = nr_sequencia_p) nr_grupo_trabalho
into STRICT    nr_seq_nao_conform_w,
	qt_ordem_servico_w,
	nr_grupo_trabalho_w
;

if	((obter_acao_p <> 3) and (nr_seq_nao_conform_w <> 0) and (qt_ordem_servico_w = 0)) then
	CALL qua_gerar_envio_comunicacao(	nr_seq_nao_conform_w,
					nr_sequencia_p,
					nm_usuario_p,
					'3',
					wheb_usuario_pck.get_cd_estabelecimento,
					0,
					0,
					'N');

	if (ie_nao_conformidade_w = 'S') THEN
		select ie_status
		into STRICT   ie_status_w
		from   qua_nao_conformidade
		where  nr_sequencia	= nr_seq_nao_conform_w;

		CALL qua_gera_hist_nao_conform(	nr_seq_nao_conform_w,
						ds_mensagem327031,
						ie_status_w,
						ds_mensagem327030,
						cd_pessoa_fisica_p);
	end if;

	UPDATE qua_nao_conformidade
    	SET ie_status      = 'Eficacia',
      		nm_usuario       = nm_usuario_p,
      		dt_atualizacao   = clock_timestamp()
    	WHERE nr_sequencia = nr_seq_nao_conform_w;
end if;


if (ie_usuario_grupo_solic_w <> 'N' and  obter_acao_p = 1) then
	CALL Man_gerar_usuario_exec_prior(
					nr_grupo_trabalho_w,
					nr_sequencia_p,
					ie_usuario_grupo_solic_w,
					nm_usuario_p
				     );

else if (ie_usuario_solicit_w = 'S' and  obter_acao_p = 1) then
	CALL man_gerar_solic_executor(nr_sequencia_p, nr_grupo_trabalho_w, nm_usuario_p);
end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_ordem_afterpost ( nm_usuario_p text, nr_sequencia_p bigint, obter_acao_p bigint, cd_pessoa_fisica_p text) FROM PUBLIC;

