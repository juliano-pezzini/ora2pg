-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ageint_api_sugestao_horario ( --******* agenda_integrada
 cd_pessoa_fisica_p text, nm_paciente_p text, qt_idade_pac_p bigint, qt_peso_p bigint, qt_altura_cm_p bigint, ie_sexo_p text, nr_seq_status_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_plano_p text, cd_estabelecimento_p bigint, nm_usuario_nrec_p text, --****** agenda_integrada_item
 cd_medico_p text, cd_especialidade_p bigint, cd_procedimento_p bigint, nr_minuto_duracao_p bigint, nr_seq_item_selec_p bigint, ie_tipo_agendamento_p text, ie_genero_prof_p text, nr_seq_proc_interno_p bigint, ie_lado_p text, dt_inicio_p timestamp DEFAULT NULL, dt_final_p timestamp DEFAULT NULL) AS $body$
DECLARE


    /*
        --******* agenda_integrada

        cd_pessoa_fisica_p   VARCHAR2(10) := 1020621614;
        nm_paciente_p        VARCHAR2(60) := 'Ary Gabriel Albano Nunes Dias';
        qt_idade_pac_p       NUMBER := 33;
        qt_peso_p            NUMBER := 130;
        qt_altura_cm_p       NUMBER := 180;
        ie_sexo_p            VARCHAR2(1) := 'M';
        nr_seq_status_p      NUMBER := 2;
        cd_convenio_p        NUMBER := NULL;
        cd_categoria_p       VARCHAR2(10) := 632;
        cd_plano_p           VARCHAR2(10) := 'Teste Ary';
        cd_estabelecimento_p NUMBER := 1;
        nm_usuario_nrec_p    VARCHAR2(15) := 'msoliveira';
        --****** agenda_integrada_item

        cd_medico_p           VARCHAR2(10) := '548713';
        cd_especialidade_p    NUMBER := 59;
        cd_procedimento_p     NUMBER := 10014;
        nr_minuto_duracao_p   NUMBER := 20;
        nr_seq_item_selec_p   NUMBER := 270;
        ie_tipo_agendamento_p VARCHAR2(15) := 'C';
        ie_genero_prof_p      VARCHAR2(1) := 'A';
        nr_seq_proc_interno_p NUMBER := 234;
        ie_lado_p             VARCHAR2(1) := 'A';
    */

    --********************
    nr_seq_w      bigint;
    nr_seq_item_w bigint;
    dt_inicio_w   timestamp := coalesce(dt_inicio_p,clock_timestamp());
    dt_final_w    timestamp := coalesce(dt_final_p, dt_inicio_w + 15);
    qt_periodo_w  bigint := trunc(dt_final_w - dt_inicio_w);
    cd_perfil_w   parametro_agenda_integrada.cd_perfil_sugestao%TYPE;


BEGIN

    SELECT coalesce(MAX(cd_perfil_sugestao), 1)
	INTO STRICT cd_perfil_W
	FROM parametro_agenda_integrada
	WHERE coalesce(cd_estabelecimento::text, '') = ''
	AND (cd_perfil_sugestao IS NOT NULL AND cd_perfil_sugestao::text <> '');
	
    ----- Chamada da funcao da Sugestao da Agenda ----
    CALL wheb_usuario_pck.set_nm_usuario(nm_usuario_nrec_p);
    CALL wheb_usuario_pck.set_cd_perfil(cd_perfil_w); -- Perfil da Agenda
    CALL wheb_usuario_pck.set_cd_funcao(869); -- Agenda Integrada
    CALL wheb_usuario_pck.set_cd_estabelecimento(cd_estabelecimento_p);
    ---------------------------------
    SELECT nextval('agenda_integrada_seq') INTO STRICT nr_seq_w;

    --dbms_output.put_line('Agenda:' || nr_seq_w);


    -- Insere AGENDA_INTEGRADA
    INSERT INTO agenda_integrada(nr_sequencia,
         dt_atualizacao,
         nm_usuario,
         dt_atualizacao_nrec,
         nm_usuario_nrec,
         dt_inicio_agendamento,
         cd_pessoa_fisica,
         nm_paciente,
         qt_idade_pac,
         qt_peso,
         qt_altura_cm,
         ie_sexo,
         nr_seq_status,
         cd_convenio,
         cd_categoria,
         cd_plano,
         cd_estabelecimento)
    ---------
    VALUES (nr_seq_w,
         clock_timestamp(),
         nm_usuario_nrec_p,
         clock_timestamp(),
         nm_usuario_nrec_p,
         clock_timestamp(),
         cd_pessoa_fisica_p,
         nm_paciente_p,
         qt_idade_pac_p,
         qt_peso_p,
         qt_altura_cm_p,
         ie_sexo_p,
         nr_seq_status_p,
         cd_convenio_p,
         cd_categoria_p,
         cd_plano_p,
         cd_estabelecimento_p);

    --****************

    -- Pega a sequencia da agenda integrada item que sera criada
    SELECT nextval('agenda_integrada_item_seq') INTO STRICT nr_seq_item_w;

    -- Insere AGENDA_INTEGRADA_ITEM
    INSERT INTO agenda_integrada_item(nr_sequencia,
         nr_seq_agenda_int,
         dt_atualizacao,
         nm_usuario,
         dt_atualizacao_nrec,
         nm_usuario_nrec,
         ie_tipo_agendamento,
         cd_medico,
         cd_especialidade,
         cd_procedimento,
         nr_minuto_duracao,
         nr_seq_item_selec,
         ie_genero_prof,
         nr_seq_proc_interno,
         ie_lado)
    ---------
    VALUES (nr_seq_item_w,
         nr_seq_w,
         clock_timestamp(),
         nm_usuario_nrec_p,
         clock_timestamp(),
         nm_usuario_nrec_p,
         ie_tipo_agendamento_p,
         cd_medico_p,
         cd_especialidade_p,
         cd_procedimento_p,
         nr_minuto_duracao_p,
         nr_seq_item_selec_p,
         ie_genero_prof_p,
         nr_seq_proc_interno_p,
         ie_lado_p);

    --  COMMIT;


/*    IF ie_tipo_agendamento_p = 'C' THEN
        inserir_proc_regra_ageint_cons(cd_especialidade_p   => cd_especialidade_p,
                                       nr_seq_ageint_item_p => nr_seq_item_w,
                                       ie_classif_agenda_p  => NULL \*nvl(ie_classif_agenda_p, ie_classif_agenda_w)*\,
                                       cd_convenio_p        => cd_convenio_p,
                                       cd_categoria_p       => cd_categoria_p,
                                       cd_estabelecimento_p => cd_estabelecimento_p,
                                       nm_usuario_p         => nm_usuario_nrec_p);
    
        gerar_ajust_proc_grupo_ageint(cd_especialidade_p    => cd_especialidade_p,
                                      ie_classif_agenda_p   => NULL \*nvl(ie_classif_agenda_p, ie_classif_agenda_w)*\,
                                      nr_seq_item_ageint_p  => nr_seq_item_w,
                                      nr_seq_ageint_p       => nr_seq_w,
                                      nr_seq_grupo_p        => NULL \*nr_seq_grupo_w*\,
                                      nr_seq_proc_interno_p => NULL \*nr_seq_proc_interno_w *\,
                                      ie_lado_p             => ie_lado_p,
                                      nm_usuario_p          => nm_usuario_nrec_p,
                                      cd_estabelecimento_p  => cd_estabelecimento_p);
    END IF;*/
    COMMIT;

    CALL ageint_sugerir_horarios_pck.clean_cache();
    -- Insere os itens no vetor
    CALL ageint_sugerir_horarios_pck.set_ie_ignora_questionario();
    CALL ageint_sugerir_horarios_pck.iniciar_itens_ageint(nr_seq_ageint_p => nr_seq_w);
    --  info_agenda_horario_w

    -- Gera os horarios do item para o periodo
    CALL ageint_sugerir_horarios_pck.gerar_horarios_itens_vetor(nr_seq_ageint_p => nr_seq_w,
                                                           dt_inicio_ger_p => dt_inicio_w,
                                                           qt_dias_p       => qt_periodo_w);
    -- Gera as sugestoes do item (e os horarios do periodo se precisar junto)
    ageint_sugerir_horarios_pck.gerar_sugestao_horario(nr_seq_combo_p    => 1,
                                                       ie_manha_p        => 'SSSSSSS',
                                                       ie_tarde_p        => 'SSSSSSS',
                                                       ie_noite_p        => 'SSSSSSS',
                                                       ie_ordenacao_p    => 'V', -- ordenacao por (T) Tempo ou (V) Valor
                                                       nr_seq_ageint_p   => nr_seq_w,
                                                       dt_agenda_p       => dt_inicio_w,
                                                       cd_estab_agenda_p => cd_estabelecimento_p,
                                                       qt_periodo_p      => qt_periodo_w);

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageint_api_sugestao_horario ( cd_pessoa_fisica_p text, nm_paciente_p text, qt_idade_pac_p bigint, qt_peso_p bigint, qt_altura_cm_p bigint, ie_sexo_p text, nr_seq_status_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_plano_p text, cd_estabelecimento_p bigint, nm_usuario_nrec_p text,  cd_medico_p text, cd_especialidade_p bigint, cd_procedimento_p bigint, nr_minuto_duracao_p bigint, nr_seq_item_selec_p bigint, ie_tipo_agendamento_p text, ie_genero_prof_p text, nr_seq_proc_interno_p bigint, ie_lado_p text, dt_inicio_p timestamp DEFAULT NULL, dt_final_p timestamp DEFAULT NULL) FROM PUBLIC;

