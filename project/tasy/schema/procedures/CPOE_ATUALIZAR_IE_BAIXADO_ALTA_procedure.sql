-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_atualizar_ie_baixado_alta ( nm_usuario_p text, nr_atendimento_p bigint, dt_alta_p timestamp default null) AS $body$
DECLARE


ie_inativa_item_w			motivo_alta.ie_inativa_item%type;

c00 CURSOR FOR
	SELECT	'N' ie_tipo,
			nr_sequencia
	from	cpoe_dieta
	where	nr_atendimento = nr_atendimento_p
	and 	coalesce(dt_suspensao::text, '') = ''
	and  	coalesce(dt_lib_suspensao::text, '') = ''
	and		((dt_fim > clock_timestamp()) or (coalesce(dt_fim::text, '') = ''))	
	
union all

	SELECT	'M' ie_tipo,
			nr_sequencia
	from	cpoe_material
	where	nr_atendimento = nr_atendimento_p
	and 	coalesce(dt_suspensao::text, '') = ''
	and  	coalesce(dt_lib_suspensao::text, '') = ''
	and		((coalesce(dt_fim_cih, dt_fim) > clock_timestamp()) or ((coalesce(dt_fim::text, '') = '') and (coalesce(dt_fim_cih::text, '') = '')))
	
union all

	select	'G' ie_tipo,
			nr_sequencia
	from	cpoe_gasoterapia
	where	nr_atendimento = nr_atendimento_p
	and 	coalesce(dt_suspensao::text, '') = ''
	and  	coalesce(dt_lib_suspensao::text, '') = ''
	and		((dt_fim > clock_timestamp()) or (coalesce(dt_fim::text, '') = ''))
	
union all

	select	'P' ie_tipo,
			nr_sequencia
	from	cpoe_procedimento
	where	nr_atendimento = nr_atendimento_p
	and 	coalesce(dt_suspensao::text, '') = ''
	and  	coalesce(dt_lib_suspensao::text, '') = ''
	and		((dt_fim > clock_timestamp()) or (coalesce(dt_fim::text, '') = ''))
	
union all

	select	'R' ie_tipo,
			nr_sequencia 
	from	cpoe_recomendacao
	where	nr_atendimento = nr_atendimento_p
	and 	coalesce(dt_suspensao::text, '') = ''
	and  	coalesce(dt_lib_suspensao::text, '') = ''
	and		((dt_fim > clock_timestamp()) or (coalesce(dt_fim::text, '') = ''))
	
union all

	select	'H' ie_tipo,
			nr_sequencia 
	from	cpoe_hemoterapia
	where	nr_atendimento = nr_atendimento_p
	and 	coalesce(dt_suspensao::text, '') = ''
	and  	coalesce(dt_lib_suspensao::text, '') = ''
	and		((dt_fim > clock_timestamp()) or (coalesce(dt_fim::text, '') = ''))
	
union all

	select	'D' ie_tipo,
			nr_sequencia 
	from	cpoe_dialise
	where	nr_atendimento = nr_atendimento_p
	and 	coalesce(dt_suspensao::text, '') = ''
	and  	coalesce(dt_lib_suspensao::text, '') = ''
	and		((dt_fim > clock_timestamp()) or (coalesce(dt_fim::text, '') = ''))
	
union all
	
	select	'AP' ie_tipo,
			nr_sequencia 
	from	cpoe_anatomia_patologica
	where	nr_atendimento = nr_atendimento_p
	and 	coalesce(dt_suspensao::text, '') = ''
	and  	coalesce(dt_lib_suspensao::text, '') = ''
	and		((dt_fim > clock_timestamp()) or (coalesce(dt_fim::text, '') = ''));

BEGIN

select 	max(b.ie_inativa_item)
into STRICT	ie_inativa_item_w
from	atendimento_paciente a,
		motivo_alta b
where	a.cd_motivo_alta = b.cd_motivo_alta
and		a.nr_atendimento = nr_atendimento_p;

	for r_c00_w in c00
	loop
		
		if (r_c00_w.ie_tipo = 'N') then

			update	cpoe_dieta
			set 	ie_baixado_por_alta = 'S',
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp(),
					dt_alta_medico = dt_alta_p
			where nr_sequencia = r_c00_w.nr_sequencia;

		elsif (r_c00_w.ie_tipo = 'M') then

			update	cpoe_material
			set		ie_baixado_por_alta = 'S',
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp(),
					dt_alta_medico = dt_alta_p
			where nr_sequencia = r_c00_w.nr_sequencia;
		
		elsif (r_c00_w.ie_tipo = 'G') then

			update	cpoe_gasoterapia
			set 	ie_baixado_por_alta = 'S',
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp(),
					dt_alta_medico = dt_alta_p
			where nr_sequencia = r_c00_w.nr_sequencia;
		
		elsif (r_c00_w.ie_tipo = 'P') then

			update	cpoe_procedimento
			set 	ie_baixado_por_alta = 'S',
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp(),
					dt_alta_medico = dt_alta_p
			where 	nr_sequencia = r_c00_w.nr_sequencia
			and ((ie_inativa_item_w <> 'E') or ((ie_duracao <> 'P') or (dt_inicio < clock_timestamp())));
		
		elsif (r_c00_w.ie_tipo = 'R') then

			update	cpoe_recomendacao
			set 	ie_baixado_por_alta = 'S',
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp(),
					dt_alta_medico = dt_alta_p
			where nr_sequencia = r_c00_w.nr_sequencia;
		
		elsif (r_c00_w.ie_tipo = 'H') then

			update	cpoe_hemoterapia
			set 	ie_baixado_por_alta = 'S',
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp(),
					dt_alta_medico = dt_alta_p
			where nr_sequencia = r_c00_w.nr_sequencia;
		
		elsif (r_c00_w.ie_tipo = 'D') then

			update	cpoe_dialise
			set 	ie_baixado_por_alta = 'S',
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp(),
					dt_alta_medico = dt_alta_p
			where nr_sequencia = r_c00_w.nr_sequencia;
		
		elsif (r_c00_w.ie_tipo = 'AP') then
		
			update	cpoe_anatomia_patologica
			set 	ie_baixado_por_alta = 'S',
					nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp(),
					dt_alta_medico = dt_alta_p
			where nr_sequencia = r_c00_w.nr_sequencia;
		
		end if;

	end loop;

	commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_atualizar_ie_baixado_alta ( nm_usuario_p text, nr_atendimento_p bigint, dt_alta_p timestamp default null) FROM PUBLIC;

