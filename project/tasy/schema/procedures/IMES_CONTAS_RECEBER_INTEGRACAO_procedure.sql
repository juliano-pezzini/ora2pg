-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE imes_contas_receber_integracao (dt_referencia_p timestamp, ie_tipo_recebimento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
nr_titulo_w		titulo_receber.nr_titulo%type;
ie_tipo_receb_w		varchar(1);
cd_cgc_w		titulo_receber.cd_cgc%type;
dt_vencimento_w		timestamp;
vl_titulo_w		titulo_receber.vl_titulo%type;
ie_tipo_titulo_w	varchar(2);
cd_conta_w		varchar(5);
ds_observacao_titulo_w	varchar(120);
nr_nosso_numero_w	titulo_receber.nr_nosso_numero%type;
vl_saldo_juros_w	titulo_receber.vl_saldo_juros%type;
vl_desconto_w		titulo_receber_classif.vl_desconto%type;
dt_liquidacao_w		timestamp;
cd_tipo_recebimento_w	titulo_receber_liq.cd_tipo_recebimento%type;
cd_integracao_externa_w	varchar(2);
cd_centro_custo_w	varchar(11);
vl_classificacao_w	titulo_receber_classif.vl_classificacao%type;
dt_contabil_w		timestamp;
ie_situacao_w		varchar(2);
cd_trans_externo_w	varchar(6);
dt_liquidacao_b_w	timestamp;
cd_estabelecimento_w	titulo_receber.cd_estabelecimento%type;

dt_referencia_w		timestamp;
dt_referencia_fim_w	timestamp;

ds_conteudo_w		varchar(1200);

c01 CURSOR FOR 
SELECT	nr_titulo, 
	ie_tipo_receb, 
	cd_cgc, 
	dt_vencimento, 
	vl_titulo, 
	ie_tipo_titulo, 
	cd_conta, 
	--nr_titulo, 
	ds_observacao_titulo, 
	nr_nosso_numero, 
	vl_saldo_juros, 
	sum(vl_desconto) vl_desconto, 
	dt_liquidacao, 
	cd_tipo_recebimento, 
	cd_integracao_externa, 
	cd_centro_custo, 
	sum(vl_classificacao) vl_classificacao, 
	dt_contabil, 
	ie_situacao, 
	cd_trans_externo, 
	dt_liquidacao_b 
from	(SELECT	a.nr_titulo, 
		CASE WHEN d.cd_tipo_recebimento='12' THEN '2'  ELSE '1' END  ie_tipo_receb, 
		a.cd_cgc, 
		trunc(a.dt_liquidacao,'dd') dt_vencimento, 
		a.vl_titulo, 
		a.ie_tipo_titulo, 
		CASE WHEN d.cd_tipo_recebimento=12 THEN b.cd_integracao_externa  ELSE 'CT' END  cd_conta, 
		--a.nr_titulo, 
		substr('Ref TÃ­tulo: '||a.nr_titulo||' '||a.ds_observacao_titulo,1,120) ds_observacao_titulo, 
		a.nr_nosso_numero, 
		a.vl_saldo_juros, 
		e.vl_desconto, 
		a.dt_liquidacao, 
		d.cd_tipo_recebimento, 
		CASE WHEN d.cd_tipo_recebimento=12 THEN 'BL' WHEN d.cd_tipo_recebimento=17 THEN 'CH'  ELSE 'CT' END  cd_integracao_externa, 
		c.cd_sistema_contabil cd_centro_custo, 
		e.vl_classificacao + 
		coalesce(obter_valor_classif_tit_rec(e.nr_titulo, e.nr_sequencia, d.vl_juros),0) + 
		coalesce(obter_valor_classif_tit_rec(e.nr_titulo, e.nr_sequencia, d.vl_multa),0) vl_classificacao, 
		a.dt_contabil, 
		CASE WHEN d.cd_tipo_recebimento=12 THEN '01' WHEN d.cd_tipo_recebimento=17 THEN '04'  ELSE '05' END  ie_situacao, 
		f.cd_externo cd_trans_externo, 
		trunc(a.dt_liquidacao,'dd') dt_liquidacao_b, 
		a.cd_estabelecimento 
	FROM banco_estabelecimento b, titulo_receber a
LEFT OUTER JOIN titulo_receber_liq d ON (a.nr_titulo = d.nr_titulo)
LEFT OUTER JOIN transacao_financeira f ON (d.nr_seq_trans_fin = f.nr_sequencia)
, titulo_receber_classif e
LEFT OUTER JOIN centro_custo c ON (e.cd_centro_custo = c.cd_centro_custo)
WHERE a.nr_seq_conta_banco	= b.nr_sequencia and ((coalesce(ie_tipo_recebimento_p,0) = 0 and d.cd_tipo_recebimento not in (12,17,18)) or (ie_tipo_recebimento_p = 1 and d.cd_tipo_recebimento = 12) or (ie_tipo_recebimento_p = 1 and d.cd_tipo_recebimento = 17) or (ie_tipo_recebimento_p = 1 and d.cd_tipo_recebimento = 18))  and a.nr_titulo		= e.nr_titulo and (a.dt_liquidacao IS NOT NULL AND a.dt_liquidacao::text <> '') and d.nr_sequencia		= 
		(select	max(x.nr_sequencia) 
 		from	titulo_receber_liq x 
		where	x.nr_titulo = d.nr_titulo) and a.dt_liquidacao		 between dt_referencia_w and dt_referencia_fim_w ) alias19 
group by	nr_titulo, 
	ie_tipo_receb, 
	cd_cgc, 
	dt_vencimento, 
	vl_titulo, 
	ie_tipo_titulo, 
	cd_conta, 
	nr_titulo, 
	ds_observacao_titulo, 
	nr_nosso_numero, 
	vl_saldo_juros, 
	dt_liquidacao, 
	cd_tipo_recebimento, 
	cd_integracao_externa, 
	cd_centro_custo, 
	dt_contabil, 
	ie_situacao, 
	cd_trans_externo, 
	dt_liquidacao, 
	cd_estabelecimento;


BEGIN 
 
delete	from w_envio_banco 
where	nm_usuario	= nm_usuario_p;
 
dt_referencia_w		:= trunc(dt_referencia_p,'dd');
dt_referencia_fim_w	:= fim_dia(dt_referencia_p);
 
open	c01;
loop 
fetch	c01 into 
	nr_titulo_w, 
	ie_tipo_receb_w, 
	cd_cgc_w, 
	dt_vencimento_w, 
	vl_titulo_w, 
	ie_tipo_titulo_w, 
	cd_conta_w, 
	ds_observacao_titulo_w, 
	nr_nosso_numero_w, 
	vl_saldo_juros_w, 
	vl_desconto_w, 
	dt_liquidacao_w, 
	cd_tipo_recebimento_w, 
	cd_integracao_externa_w, 
	cd_centro_custo_w, 
	vl_classificacao_w, 
	dt_contabil_w, 
	ie_situacao_w, 
	cd_trans_externo_w, 
	dt_liquidacao_b_w;
	 
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	ds_conteudo_w	:=	'001' || 
				'0049719' || 
				'PC ' || 
				'UN' || 
				lpad('Y' || to_char(dt_liquidacao_w,'ddmmyy') || ie_tipo_receb_w,8,'0') || 
				to_char(dt_liquidacao_b_w,'ddmmyy') || 
				to_char(dt_liquidacao_b_w,'ddmmyy') || 
				to_char(dt_liquidacao_b_w,'ddmmyy') || 
				to_char(dt_liquidacao_b_w,'ddmmyy') || 
				'0000000' || 
				lpad('Y' || to_char(dt_liquidacao_w,'ddmmyy') || ie_tipo_receb_w,8,'0') || 
				rpad(' ',9,' ') || 
				rpad('1',11,' ') || 
				rpad(' ',14,' ') || 
				lpad('Y' || to_char(dt_liquidacao_w,'ddmmyy') || ie_tipo_receb_w,8,'0') || 
				'000' || 
				coalesce(cd_trans_externo_w,'   ') || 
				lpad(somente_numero(to_char(coalesce(vl_classificacao_w,0),'99999999999990.00')),16,'0') || 
				'001' || 
				'000000000000000001' || 
				rpad(coalesce(cd_centro_custo_w,' '),11,' ') || 
				rpad(' ',15,' ') || 
				rpad(' ',15,' ') || 
				rpad(' ',80,' ') || 
				rpad(' ',7,' ') || 
				to_char(dt_vencimento_w, 'ddmmyy') || 
				'0000000000000000' || 
				'0000000' || 
				'0000000000000000' || 
				'0000000' || 
				'0000000000000000' || 
				'0000000' || 
				'0000000000000000' || 
				'0000000' || 
				'0000000000000000' || 
				'0000000' || 
				'0000000000000000' || 
				'0000000' || 
				'0000000000000000' || 
				'0000000' || 
				'0000000000000000' || 
				'0000000' || 
				'0000000000000000' || 
				'0000000' || 
				'0000000000000000' || 
				'0000000' || 
				'0000000000000000' || 
				'0000000' || 
				'0000000000000000' || 
				'0000000' || 
				'0000000000000000' || 
				'0000000' || 
				'0000000000000000' || 
				'0000000' || 
				'0000000000000000' || 
				'0000000' || 
				'0000000000000000' || 
				'0000000' || 
				rpad(coalesce(cd_integracao_externa_w,' '),2,' ') || 
				rpad(coalesce(ie_situacao_w,' '),2,' ') || 
				rpad(' ',8,' ') || 
				rpad(coalesce(cd_conta_w,' '),5,' ') || 
				' ' || 
				rpad(coalesce(ds_observacao_titulo_w,' '),120,' ') || 
				' ' || 
				lpad('0',20,'0') || 
				rpad(' ',16,' ') || 
				'1' || 
				'000' || 
				'000' || 
				'000' || 
				'000' || 
				'000' || 
				'000' || 
				'000' || 
				'000' || 
				'000' || 
				'000' || 
				'000' || 
				'000' || 
				'000' || 
				'000' || 
				'000' || 
				'000' || 
				rpad(' ',6,' ') || 
				rpad(' ',6,' ') || 
				rpad(' ',120,' ') || 
				rpad(' ',7,' ') || 
				rpad(' ',14,' ') || 
				rpad(' ',15,' ') || 
				rpad(' ',7,' ') || 
				rpad(' ',14,' ') || 
				' ' || 
				'  ' || 
				rpad(' ',11,' ') || 
				rpad('0',16,'0') || 
				rpad(' ',6,' ') || 
				rpad('0',16,'0') || 
				'0000' || 
				'  '|| 
				rpad(' ',11,' ')|| 
				' ' || 
				rpad(' ',62,' ');
 
	insert	into w_envio_banco(cd_estabelecimento, 
		ds_conteudo, 
		dt_atualizacao, 
		dt_atualizacao_nrec, 
		nm_usuario, 
		nm_usuario_nrec, 
		nr_sequencia) 
	values (cd_estabelecimento_p, 
		ds_conteudo_w, 
		clock_timestamp(), 
		clock_timestamp(), 
		nm_usuario_p, 
		nm_usuario_p, 
		nextval('w_envio_banco_seq'));
 
end	loop;
close	c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE imes_contas_receber_integracao (dt_referencia_p timestamp, ie_tipo_recebimento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

