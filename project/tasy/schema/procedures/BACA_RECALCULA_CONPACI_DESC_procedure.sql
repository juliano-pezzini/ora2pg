-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_recalcula_conpaci_desc (nr_sequencia_p bigint) AS $body$
DECLARE

 
nr_interno_conta_w		bigint;

vl_desc_Proc_w			double precision := 0;
vl_desc_Mat_w			double precision := 0;

nr_sequencia_w			bigint;
pr_desconto_w			real;
vl_desconto_w			double precision;
vl_liquido_w			double precision;
ds_view_w				varchar(30);

C01 CURSOR FOR 
	SELECT	a.nr_sequencia, 
		b.ds_view 
	from	conta_paciente_estrutura b, 
		conta_paciente_desc_item a 
	where	a.cd_estrutura = b.cd_estrutura 
	and	nr_seq_desconto = nr_sequencia_p 
	and	ie_calcula = 'S';


BEGIN 
 
select	nr_interno_conta 
into STRICT	nr_interno_conta_w 
from	conta_paciente_desconto 
where	nr_sequencia = nr_sequencia_p;
 
open C01;
loop 
fetch C01 into	 
	nr_sequencia_w, 
	ds_view_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
 
	if (position('PROCEDIMENTO'  ds_view_w) > 0) or (position('DIARIA' in ds_view_w) > 0) or (position('HONORARIO' in ds_view_w) > 0) then 
		CALL Calcular_ConPaci_Desc_Proc(nr_sequencia_w, 'E', 'Tasy');
	elsif (position('MATERIAL' in ds_view_w) > 0) then 
		CALL Calcular_ConPaci_Desc_Mat(nr_sequencia_w, 'E', 'Tasy');
	end if;
 
end loop;
close C01;
 
CALL Calcular_Conpaci_Desc_Pacote(nr_sequencia_p, 'E', 'Tasy');
 
CALL CALCULAR_CONPACI_DESCONTO(nr_sequencia_p, 'I', 'Tasy');
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_recalcula_conpaci_desc (nr_sequencia_p bigint) FROM PUBLIC;

