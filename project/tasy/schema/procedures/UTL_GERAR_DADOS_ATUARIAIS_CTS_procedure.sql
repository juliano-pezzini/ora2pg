-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE utl_gerar_dados_atuariais_cts ( ie_tipo_registro_p bigint, nm_arquivo_p text) AS $body$
DECLARE


arq_texto_w			utl_file.file_type;
ds_local_w			varchar(255) 		:= null;
ds_erro_w			varchar(255);
file_exist_w			boolean;
size_w				bigint;
block_size_w			bigint;
nr_sequencia_w			pls_atuarial.nr_sequencia%type;
cd_mensalidade_w		pls_atuarial.cd_mensalidade%type;
cd_matricula_secundaria1_w	pls_atuarial.cd_matricula_secundaria_1%type;
vl_contraprestacao_w		pls_atuarial.vl_contraprestacao%type;
dt_mesano_competencia_w		pls_atuarial.dt_mesano_competencia%type;
cd_matricula_principal1_w	pls_atuarial.cd_matricula_principal%type;
cd_prestador_w			pls_atuarial.cd_prestador%type;
ie_tipo_prestador_w		pls_atuarial.ie_tipo_prestador%type;
ie_tipo_rede_w			pls_atuarial.ie_tipo_rede%type;
cd_ibge_w			pls_atuarial.cd_ibge%type;
cd_especialidade_w		pls_atuarial.cd_especialidade%type;
cd_sinistro_w			pls_atuarial.cd_sinistro%type;
cd_matricula_principal2_w	pls_atuarial.cd_matricula_principal_2%type;
cd_matricula_secundaria2_w	pls_atuarial.cd_matricula_secundaria_2%type;
dt_ocorrencia_w			pls_atuarial.dt_ocorrencia%type;
dt_aviso_w			pls_atuarial.dt_aviso%type;
dt_pagamento_w 			pls_atuarial.dt_pagamento%type;
ie_tipo_evento_w		pls_atuarial.ie_tipo_evento%type;
nr_documento_w			pls_atuarial.nr_documento%type;
nr_documento_ww			varchar(255);
cd_classif_sinistro_w		pls_atuarial.cd_classif_sinistro%type;
nr_diarias_w			pls_atuarial.nr_diarias%type;
nr_diarias_uti_w		pls_atuarial.nr_diarias_uti%type;
nm_tabela_w			pls_atuarial.nm_tabela%type;
cd_procedimento_w		pls_atuarial.cd_procedimento%type;
vl_despesa_w			pls_atuarial.vl_despesa%type;
vl_coparticipacao_w		pls_atuarial.vl_coparticipacao%type;
vl_franquia_w			pls_atuarial.vl_franquia%type;
ie_tipo_despesa_w		pls_atuarial.ie_tipo_despesa%type;
cd_prestador_sinistro_w		pls_atuarial.cd_prestador_sinistro%type;
ie_carencia_w			pls_atuarial.ie_carencia%type;
cd_beneficiario_w		pls_atuarial.cd_beneficiario%type;
cd_matricula_principal_w	pls_atuarial.cd_matricula_principal%type;
cd_matricula_secundaria_w	pls_atuarial.cd_matricula_secundaria%type;
dt_nascimento_w			pls_atuarial.dt_nascimento%type;
ie_tipo_beneficiario_w		pls_atuarial.ie_tipo_beneficiario%type;
ie_sexo_w			pls_atuarial.ie_sexo%type;
dt_adesao_w			pls_atuarial.dt_adesao%type;
dt_exclusao_w			pls_atuarial.dt_exclusao%type;
cd_cpt_w			pls_atuarial.cd_cpt%type;
dt_final_cpt_w			pls_atuarial.dt_final_cpt%type;
cd_empresa_w			pls_atuarial.cd_empresa%type;
ie_tipo_patrocinio_w		pls_atuarial.ie_tipo_patrocinio%type;
cd_historico_beneficiario_w	pls_atuarial.cd_historico_beneficiario%type;
cd_interno_w			pls_atuarial.cd_interno%type;
cd_ans_w			pls_atuarial.cd_ans%type;
cd_segmentacao_w		pls_atuarial.cd_segmentacao%type;
cd_acomodacao_w			pls_atuarial.cd_acomodacao%type;
cd_contratacao_w		pls_atuarial.cd_contratacao%type;
cd_abrangencia_w		pls_atuarial.cd_abrangencia%type;
ie_direcionamento_w		varchar(255) 		:=  1;
ie_autorizacao_previa_w		varchar(255) 		:=  1;
ie_porta_entrada_w		varchar(255) 		:=  0;
ie_franquia_w			pls_atuarial.ie_franquia%type;
ie_coparticipacao_w		pls_atuarial.ie_coparticipacao%type;
nm_arquivo_w			varchar(255);

C01 CURSOR FOR
	SELECT  nr_sequencia,
		cd_mensalidade,
		cd_matricula_principal_1,
		cd_matricula_secundaria_1,
		dt_mesano_competencia,
		vl_contraprestacao,
		cd_prestador,
		ie_tipo_prestador,
		ie_tipo_rede,
		cd_ibge,
		cd_especialidade,
		cd_sinistro,
		cd_matricula_principal_2,
		cd_matricula_secundaria_2,
		dt_ocorrencia,
		dt_aviso,
		dt_pagamento ,
		ie_tipo_evento,
		nr_documento,
		cd_classif_sinistro,
		nr_diarias,
		nr_diarias_uti,
		nm_tabela,
		cd_procedimento,
		vl_despesa,
		vl_coparticipacao,
		vl_franquia,
		ie_tipo_despesa,
		cd_prestador_sinistro,
		ie_carencia,
		cd_beneficiario,
		cd_matricula_principal,
		cd_matricula_secundaria,
		dt_nascimento,
		ie_tipo_beneficiario,
		ie_sexo,
		dt_adesao,
		dt_exclusao,
		cd_cpt,
		dt_final_cpt,
		cd_empresa,
		ie_tipo_patrocinio,
		cd_historico_beneficiario,
		cd_interno,
		cd_ans,
		cd_segmentacao,
		cd_acomodacao,
		cd_contratacao,
		cd_abrangencia,
		ie_franquia,
		ie_coparticipacao
	from    pls_atuarial
	where   ie_tipo_registro = ie_tipo_registro_p;


BEGIN
nm_arquivo_w := replace(nm_arquivo_p,'\','');	--' -- comentario pra não deixar o resto do fonte em vermelho
--Obtém os dados do arquivo no diretório
utl_file.fgetattr(ds_local_w,nm_arquivo_w,file_exist_w,size_w,block_size_w);

--Caso existir, remove ele para não criar registros no arquivo já criado
if (file_exist_w) then
	utl_file.fremove(ds_local_w,nm_arquivo_w);
end if;

begin
SELECT * FROM obter_evento_utl_file(14, null, ds_local_w, ds_erro_w) INTO STRICT ds_local_w, ds_erro_w;
exception
when others then
	ds_local_w := null;
end;

if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_erro_w);
end if;

begin
arq_texto_w := utl_file.fopen(ds_local_w,nm_arquivo_w,'W');
exception
when others then
	ds_erro_w := obter_erro_utl_open(SQLSTATE);
	CALL wheb_mensagem_pck.exibir_mensagem_abort('Local: '||ds_local_w||' Nome arquivo: '||nm_arquivo_w||' '||ds_erro_w);
end;

open C01;
loop
fetch C01 into
	nr_sequencia_w,
	cd_mensalidade_w,
	cd_matricula_principal1_w,
	cd_matricula_secundaria1_w,
	dt_mesano_competencia_w,
	vl_contraprestacao_w,
	cd_prestador_w,
	ie_tipo_prestador_w,
	ie_tipo_rede_w,
	cd_ibge_w,
	cd_especialidade_w,
	cd_sinistro_w,
	cd_matricula_principal2_w,
	cd_matricula_secundaria2_w,
	dt_ocorrencia_w,
	dt_aviso_w,
	dt_pagamento_w,
	ie_tipo_evento_w,
	nr_documento_w,
	cd_classif_sinistro_w,
	nr_diarias_w,
	nr_diarias_uti_w,
	nm_tabela_w,
	cd_procedimento_w,
	vl_despesa_w,
	vl_coparticipacao_w,
	vl_franquia_w,
	ie_tipo_despesa_w,
	cd_prestador_sinistro_w,
	ie_carencia_w,
	cd_beneficiario_w,
	cd_matricula_principal_w,
	cd_matricula_secundaria_w,
	dt_nascimento_w,
	ie_tipo_beneficiario_w,
	ie_sexo_w,
	dt_adesao_w,
	dt_exclusao_w,
	cd_cpt_w,
	dt_final_cpt_w,
	cd_empresa_w,
	ie_tipo_patrocinio_w,
	cd_historico_beneficiario_w,
	cd_interno_w,
	cd_ans_w,
	cd_segmentacao_w,
	cd_acomodacao_w,
	cd_contratacao_w,
	cd_abrangencia_w,
	ie_franquia_w,
	ie_coparticipacao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	select 	length(coalesce(nr_documento_w,0))
	into STRICT	nr_documento_ww
	;

	if (nr_documento_ww < 12) then
		nr_documento_ww:= substr(lpad(coalesce(nr_documento_w,0),12,'0'),1,12);
	else
		nr_documento_ww := nr_documento_w;
	end if;

	if (ie_tipo_registro_p = 3) then -- Mensalidades
		utl_file.put_line(arq_texto_w,	substr(rpad(cd_mensalidade_w,13,' '),1,13)||
						' '||
						substr(rpad( cd_matricula_principal1_w,13,' '),1,13)||
						' '||
						substr(rpad(cd_matricula_secundaria1_w,2,' '),1,2)||
						substr(rpad(dt_mesano_competencia_w,6,' '),1,6)||
						substr(lpad(coalesce(vl_contraprestacao_w,0),9,'0'),1,9)
						||chr(13));
		utl_file.fflush(arq_texto_w);

	elsif (ie_tipo_registro_p = 4) then -- Prestador
		utl_file.put_line(arq_texto_w,	substr(lpad(cd_prestador_w,14,'0'),1,14)||
						substr(coalesce(ie_tipo_prestador_w,'0'),1,2)||
						substr(coalesce(ie_tipo_rede_w,'0'),1,1)||
						substr(lpad(coalesce(cd_ibge_w,'0'),7,'0'),1,7)||
						substr(lpad(cd_especialidade_w,8,' '),1,8)
						||chr(13));
		utl_file.fflush(arq_texto_w);

	elsif (ie_tipo_registro_p = 5) then -- Contas Médicas
		utl_file.put_line(arq_texto_w,	substr(rpad(coalesce(cd_sinistro_w,' '),14,' '),1,14)||
						substr(rpad(coalesce(cd_matricula_principal2_w,' '),14,' '),1,14)||
						substr(rpad(cd_matricula_secundaria2_w,3,'0'),1,3)||
						substr(rpad(coalesce(dt_ocorrencia_w,' '),8,' '),1,8)||
						substr(rpad(coalesce(dt_aviso_w,' '),8,' '),1,8)||
						substr(rpad(coalesce(dt_pagamento_w,' '),8,' '),1,8)||
						lpad(coalesce(ie_tipo_evento_w,'0'),1,'0')||
						substr(lpad(coalesce(nr_documento_w,0),10,'0'),1,10)||
						substr(rpad(coalesce(cd_classif_sinistro_w,' '),1,' '),1,1)||
        /*  substr(rpad(nvl(nr_diarias_w,0),3,0),1,3) ||
						substr(rpad(nvl(nr_diarias_uti_w,0),3,0),1,3)||  Alterado pelo Reginaldo Spricigo - OS 605780    */
            /*O Layout da CTS para os campos de diárias apresenta tamanho 3 e deve ser preenchido com '0' a esquerda.*/

						substr(lpad(coalesce(nr_diarias_w,0),3,0),1,3) ||
						substr(lpad(coalesce(nr_diarias_uti_w,0),3,0),1,3)||
						substr(rpad(coalesce(nm_tabela_w,' '),10,' '),1,10)||
						substr(lpad(coalesce(cd_procedimento_w,0),14,0),1,14)||
        /*  substr(lpad(replace(to_char(nvl(vl_despesa_w,'0'), 'fm0000000000.00'),'.',''),9,'0'),1,9)||
						substr(lpad(nvl(elimina_caractere_especial(to_char(vl_coparticipacao_w)),'0'),9,'0'),1,9)||    Alterado pelo Reginaldo Spricigo - OS 605780  */
            /*A forma como estava sendo tratado antes acabava por não formatar corretamente e inserir o valor errado no arquivo.*/

						substr(lpad(elimina_caractere_especial(to_char(vl_despesa_w, 'fm9999999.00')),9,'0'),1,9)||
            substr(lpad(elimina_caractere_especial(to_char(vl_coparticipacao_w, 'fm9999999.00')),9,'0'),1,9)||
						substr(lpad(coalesce(vl_franquia_w,'0'),9,'0'),1,9)||
						coalesce(ie_tipo_despesa_w,0)||substr(lpad(coalesce(cd_prestador_sinistro_w,'0'),14,'0'),1,14)||
						coalesce(ie_carencia_w,'0')
						||chr(13));
		utl_file.fflush(arq_texto_w);

	elsif (ie_tipo_registro_p = 2) then -- Beneficiários
		utl_file.put_line(arq_texto_w,	substr(rpad(coalesce(cd_beneficiario_w,' '),14,' '),1,14)||
						substr(rpad(coalesce(cd_matricula_principal_w,' '),14,' '),1,14)||
						substr(rpad(coalesce(cd_matricula_secundaria_w,' '),3,'0'),1,3) ||
						substr(rpad(coalesce(dt_nascimento_w,'0'),8,'0'),1,8) ||
						coalesce(ie_tipo_beneficiario_w,'0')||
						coalesce(ie_sexo_w,'0') ||
						substr(rpad(coalesce(dt_adesao_w,'0'),8,'0'),1,8) ||
						substr(rpad(coalesce(dt_exclusao_w,'0'),8,'0'),1,8)||
						coalesce(cd_cpt_w,'0')||
						substr(rpad(coalesce(dt_final_cpt_w,'0'),8,'0'),1,8)||
						substr(rpad(coalesce(cd_empresa_w,' '),9,' '),1,9)||
						coalesce(ie_tipo_patrocinio_w,'0')||
						coalesce(cd_historico_beneficiario_w,'0')
						||chr(13));
		utl_file.fflush(arq_texto_w);

	elsif (ie_tipo_registro_p = 1) then -- Produtos
		utl_file.put_line(arq_texto_w,	substr(rpad(coalesce(cd_interno_w,0),14,' '),1,14)||
						substr(lpad(coalesce(replace(replace(replace(cd_ans_w,'/',''),'.',''),'-',''),'0'),9,'0'),1,9)||
						substr(lpad(coalesce(cd_segmentacao_w,'0'),2,'0'),1,2)||
						coalesce(cd_acomodacao_w,'0')||
						coalesce(cd_contratacao_w,'0')||
						coalesce(cd_abrangencia_w,'0')||
						ie_direcionamento_w ||
						ie_autorizacao_previa_w||
						ie_porta_entrada_w||
						coalesce(ie_franquia_w,'0')||
						coalesce(ie_coparticipacao_w,'0')
						||chr(13));
		utl_file.fflush(arq_texto_w);
	end if;
	end;

end loop;
close C01;

utl_file.fclose(arq_texto_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE utl_gerar_dados_atuariais_cts ( ie_tipo_registro_p bigint, nm_arquivo_p text) FROM PUBLIC;

