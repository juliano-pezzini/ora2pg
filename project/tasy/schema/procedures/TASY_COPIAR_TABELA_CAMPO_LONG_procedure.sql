-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_copiar_tabela_campo_long ( nm_owner_origem_p text, nm_coluna_pk_p text, nm_coluna_long_p text, nm_tabela_p text, ds_sql_where_p text, dt_referencia_p timestamp) AS $body$
DECLARE


/*
ESTE OBJETO È UTILIZADO NA ATUALIZAÇÃO DA VERSÃO
COPIA OS CAMPOS LONG DAS TABELAS
O parâmetro ds_sql_where_p deve conter a bind variable :DT_REFERENCIA
Ex:	and a.dt_atualizacao > :dt_referencia
*/
vl_pk_w          	bigint;
nm_owner_origem_w	varchar(15);
c010  			integer;
retorno_w		integer;
ds_comando_cursor_w	varchar(2000);

BEGIN

nm_owner_origem_w := nm_owner_origem_p;

if ( coalesce(nm_owner_origem_p::text, '') = '' ) or ( nm_owner_origem_p = '') then
	nm_owner_origem_w := 'TASY_VERSAO';
end if;

ds_comando_cursor_w	:=
			' select	a.'||nm_coluna_pk_p ||
			' from  	'||nm_owner_origem_w||'.'||nm_tabela_p||' a,'||
			'		'||nm_tabela_p||' b '||
			ds_sql_where_p ||
			' and      	a.'||nm_coluna_pk_p||' = b.'||nm_coluna_pk_p||
			' and        	(a.'||nm_coluna_long_p||' is not null or a.'||nm_coluna_long_p||' is null and b.'||nm_coluna_long_p||' is not null)';



CALL gravar_processo_longo('','TASY_COPIAR_TABELA_LONG',null);

C010 := DBMS_SQL.OPEN_CURSOR;
DBMS_SQL.PARSE(C010, ds_comando_cursor_w, dbms_sql.Native);
DBMS_SQL.DEFINE_COLUMN(C010, 1, vl_pk_w);
DBMS_SQL.BIND_VARIABLE(C010,'DT_REFERENCIA', dt_referencia_p);
retorno_w := DBMS_SQL.execute(c010);
while( DBMS_SQL.FETCH_ROWS(C010) > 0 ) loop

	DBMS_SQL.COLUMN_VALUE(C010, 1, vl_pk_w);

	CALL gravar_processo_longo(nm_coluna_pk_p || ' = ' || vl_pk_w,'COPIA_CAMPO_LONG_DE_PARA',null);

	CALL copia_campo_long_de_para(	nm_owner_origem_p ||'.'||nm_tabela_p ,
					nm_coluna_long_p,
					'where ' || nm_coluna_pk_p  || ' = :'||nm_coluna_pk_p,
					nm_coluna_pk_p||'='||vl_pk_w,
					nm_tabela_p ,
					nm_coluna_long_p,
					'where ' || nm_coluna_pk_p  || ' = :'||nm_coluna_pk_p,
					nm_coluna_pk_p||'='||vl_pk_w);

	commit;
END LOOP;

DBMS_SQL.CLOSE_CURSOR(C010);


END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_copiar_tabela_campo_long ( nm_owner_origem_p text, nm_coluna_pk_p text, nm_coluna_long_p text, nm_tabela_p text, ds_sql_where_p text, dt_referencia_p timestamp) FROM PUBLIC;

