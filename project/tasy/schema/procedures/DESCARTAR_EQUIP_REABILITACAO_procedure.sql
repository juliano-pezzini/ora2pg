-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE descartar_equip_reabilitacao ( nr_seq_equip_reabilitacao_p bigint, nr_seq_equip_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ds_mensagem_p INOUT text) AS $body$
DECLARE




cd_status_descarte_w	bigint;

ds_equipamento_w	varchar(100);

ds_titulo_w		varchar(255);

ds_detalhamento_w	varchar(4000);

nr_ordem_servico_w	bigint;

ds_historico_w		varchar(255);




BEGIN

ds_historico_w := '';



-- Setar ie_propriedade para 'Pr√≥prio' e ie_status para 'Descartado'
select	max(nr_sequencia)

into STRICT	cd_status_descarte_w

from	man_equip_status

where	ie_descarte = 'S'

and	ie_situacao = 'A'

and	cd_estabelecimento = cd_estabelecimento_p;



update	man_equipamento

set	ie_propriedade = 'P',

	nr_seq_status = cd_status_descarte_w,

	cd_cgc_terc  = NULL,

	cd_pessoa_terceiro  = NULL,

	nm_usuario = nm_usuario_p,

	dt_atualizacao = clock_timestamp()

where	nr_sequencia = nr_seq_equip_p;



update	rp_equipamento

set	dt_fim_utilizacao = clock_timestamp(),

	dt_atualizacao = clock_timestamp(),

	nm_usuario = nm_usuario_p

where	nr_sequencia = nr_seq_equip_reabilitacao_p;



ds_equipamento_w := substr(man_obter_dados_equipamento(nr_seq_equip_p,'D'),1,255);

ds_titulo_w 	 := substr(obter_texto_dic_objeto(279800, wheb_usuario_pck.get_nr_seq_idioma, 'EQUIPAMENTO=' || ds_equipamento_w),1,255);

ds_detalhamento_w := substr(obter_texto_dic_objeto(279799, wheb_usuario_pck.get_nr_seq_idioma, 'EQUIPAMENTO=' || ds_equipamento_w),1,4000);



-- Gerar OS de descarte do equipamento
nr_ordem_servico_w := gerar_os_protese_descarte(	nr_seq_equip_reabilitacao_p, ds_titulo_w, ds_detalhamento_w, nm_usuario_p, nr_ordem_servico_w);



ds_historico_w	 := substr(obter_texto_dic_objeto(279795, wheb_usuario_pck.get_nr_seq_idioma, 'ORDEM_SERVICO=' || nr_ordem_servico_w),1,255);



-- Registrar Baixa Definitiva no historico do equipamento:
CALL man_log_equip_hist_evento(	nr_seq_equip_p,

				ds_historico_w,

				'D',

				nm_usuario_p);



commit;



ds_mensagem_p := ds_historico_w;



end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE descartar_equip_reabilitacao ( nr_seq_equip_reabilitacao_p bigint, nr_seq_equip_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ds_mensagem_p INOUT text) FROM PUBLIC;

