-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_versao_criar_indice ( nm_tabela_p text, nm_Indice_p text, ie_oline_p text, ie_enterprise_p text, nr_ordem_p bigint) AS $body$
DECLARE


nm_atributo_w          	varchar(50)    := '';
ie_temporaria_w		varchar(2);
ds_virgula_w		varchar(01)	:= '';
ds_tablespace_ind_w    	varchar(50)    := '';
ie_tipo_w		varchar(02)    := '';
ds_tipo_indice_w	varchar(15)    := '';
ds_comando_w		varchar(2000);
ds_comando_idx_w    varchar(2000);
vl_retorno_w		varchar(255);
qt_tamanho_w		integer;
qt_total_Indice_w	integer;
qt_Initial_w		integer;
qt_next_w		integer;
ds_indice_function_w	varchar(255);
ie_configurar_w		varchar(1);
ie_classificacao_w	varchar(3);
ds_comando_bv_w		varchar(4000);
C010				integer;
retorno_w			integer;
index_name_w		varchar(100);
nm_fase_w           cloud_upgrade_log.nm_fase_atualizacao%type := 'TASY_VERSAO_CRIAR_INDICE';
nm_paralelism_w     varchar(1000);


BEGIN

if (ie_enterprise_p = 'S') then
    nm_paralelism_w := ' parallel ';
end if;

ds_comando_bv_w:= ' select	ie_tipo,  ' ||
						' b.ie_temporaria, ' ||
						' a.ie_classificacao ' ||
				' from	tasy_versao.indice a,  '||
					' 	tasy_versao.tabela_sistema b  '||
				' where	a.nm_tabela = :nm_tabela_p  '||
				' and	a.nm_tabela	= b.nm_tabela  '||
				' and	a.nm_indice	= :nm_indice_p  ';
EXECUTE ds_comando_bv_w
INTO STRICT	ie_tipo_w, ie_temporaria_w, ie_classificacao_w	using nm_tabela_p, nm_indice_p;


EXECUTE 'BEGIN :a := wheb_usuario_pck.get_configurar_tablespace; END;' USING IN OUT ie_configurar_w;

if (ie_configurar_w = 'S') then
	ds_tablespace_ind_w := OBTER_VALOR_DINAMICO_CHAR_BV('select Obter_Tablespace_Index(:nm_Indice_p) from dual', 'nm_indice_p=' || nm_indice_p || ';', ds_tablespace_ind_w);
elsif (ie_temporaria_w <> 'N') then
	ds_tablespace_ind_w := OBTER_VALOR_DINAMICO_CHAR_BV(
		'select nvl(max(nvl(vl_parametro,vl_parametro_padrao)),Obter_Tablespace_Index) '||
		'from 	funcao_parametro '||
		'where	nr_sequencia = 135 ' ||
		'and 	cd_funcao = 0 ', '', ds_tablespace_ind_w);
else
	ds_tablespace_ind_w := OBTER_VALOR_DINAMICO_CHAR_BV('select Obter_Tablespace_Index(:nm_Indice_p) from dual', 'nm_indice_p=' || nm_indice_p || ';', ds_tablespace_ind_w);
end	if;

if (ie_tipo_w in ('PK','UK')) then
	begin
        if (ie_tipo_w = 'PK') then
            ds_tipo_indice_w := 'Primary Key ';
            ds_comando_idx_w := 'Create Index ';
        elsif (ie_tipo_w = 'UK') then
            ds_tipo_indice_w := 'unique ';
            ds_comando_idx_w := 'Create unique Index ';
        end if;
        ds_comando_w := 'alter table ' || nm_tabela_p;
        if (ie_enterprise_p = 'S') then
            ds_comando_w := ds_comando_w || nm_paralelism_w;
        end if;
        ds_comando_w := ds_comando_w || ' add constraint ';
        ds_comando_w := ds_comando_w || nm_Indice_p || ' ' || ds_tipo_indice_w || '(';
        ds_comando_idx_w := ds_comando_idx_w || nm_indice_p || ' ON ' || nm_tabela_p || '(';
	end;
else
	ds_tipo_indice_w := '';
	if (ie_tipo_w = 'IU') then
		ds_tipo_indice_w := ' unique ';
	elsif (ie_tipo_w = 'IB') then
		ds_tipo_indice_w := ' bitmap ';
	end if;

	ds_comando_w	:= 'Create '|| ds_tipo_indice_w ||' Index ' || nm_indice_p || ' ON ' || nm_tabela_p || '(';
end if;
ds_virgula_w	:= '';
qt_total_Indice_w := 0;

ds_comando_bv_w:=  ' SELECT a.nm_atributo, '||
						' nvl(decode(ie_tipo_atributo,'||chr(39)||'DATE'||chr(39)||',5, qt_tamanho),5), '||
						' a.ds_indice_function '||
				' FROM	tasy_versao.tabela_atributo b, '||
				' 		tasy_versao.Indice_Atributo a '||
				' WHERE	b.nm_tabela	= :nm_tabela1_p '||
				' and	a.nm_tabela	= :nm_tabela2_p '||
				' and 	a.nm_indice	= :nm_indice_p '||
				' and 	a.nm_atributo = b.nm_atributo '||
				' order by a.nr_sequencia ';

C010 := dbms_sql.open_cursor;
dbms_sql.parse(C010, ds_comando_bv_w, dbms_sql.native);
dbms_sql.define_column(C010, 1, nm_atributo_w, 50);
dbms_sql.define_column(C010, 2, qt_tamanho_w);
dbms_sql.define_column(C010, 3, ds_indice_function_w, 255);
dbms_sql.bind_variable(C010, 'NM_TABELA1_P', nm_tabela_p,255);
dbms_sql.bind_variable(C010, 'NM_TABELA2_P', nm_tabela_p,255);
dbms_sql.bind_variable(C010, 'NM_INDICE_P', nm_indice_p,255);
retorno_w := dbms_sql.execute(C010);

while( dbms_sql.fetch_rows(C010) > 0 ) loop
	dbms_sql.column_value(C010, 1, nm_atributo_w);
	dbms_sql.column_value(C010, 2, qt_tamanho_w);
	dbms_sql.column_value(C010, 3, ds_indice_function_w);

	if ( ie_tipo_w = 'IF') then
		if (ds_indice_function_w IS NOT NULL AND ds_indice_function_w::text <> '') then
			ds_comando_w	:= ds_comando_w  ||ds_virgula_w||ds_indice_function_w;
			ds_virgula_w	:= ',';
		end if;

	elsif ( ie_tipo_w = 'IU') and (ds_indice_function_w IS NOT NULL AND ds_indice_function_w::text <> '') then
		ds_comando_w	:= ds_comando_w  || ds_indice_function_w;
        if (ds_comando_idx_w IS NOT NULL AND ds_comando_idx_w::text <> '') then
            ds_comando_idx_w := ds_comando_idx_w || ds_virgula_w || ds_indice_function_w;
        end if;
	else
		ds_comando_w	:= ds_comando_w  || ds_virgula_w || nm_atributo_w;
        if (ds_comando_idx_w IS NOT NULL AND ds_comando_idx_w::text <> '') then
            ds_comando_idx_w := ds_comando_idx_w || ds_virgula_w || nm_atributo_w;
        end if;
		ds_virgula_w	:= ',';
	end if;
	qt_total_Indice_w	:= qt_total_Indice_w + qt_tamanho_w;

end loop;
dbms_sql.close_cursor(C010);

qt_Initial_w	:= round(100 * qt_total_indice_w / 1024);
qt_next_w	:= round(qt_initial_w / 10);

/* 	Tratar se indice nulo OS298078
	Exemplo:  Create Index LABIMPE_IX on LAB_IMPORTACAO_EXAME(DT_INTEGRACAO,1); 
*/
if (ie_tipo_w = 'IC') then
	ds_comando_w	:= ds_comando_w	|| ',1';
    ds_comando_idx_w := ds_comando_idx_w || ',1';
end	if;

ds_comando_w	:= ds_comando_w  || ')';

if (ds_comando_idx_w IS NOT NULL AND ds_comando_idx_w::text <> '') then
    ds_comando_idx_w := ds_comando_idx_w || ') tablespace ' || ds_tablespace_ind_w;
end if;

if (ie_tipo_w = 'PK') then
	ds_comando_w	:= ds_comando_w || ' Using Index';
end if;

if (ie_temporaria_w not in ('G','GD')) then

	if (ie_configurar_w = 'S') then
		--ds_tablespace_ind_w	:= Obter_Tablespace_Index(nm_Indice_p);
		ds_tablespace_ind_w := OBTER_VALOR_DINAMICO_CHAR_BV('select Obter_Tablespace_Index(:nm_Indice_p) from dual', 'nm_indice_p=' || nm_indice_p || ';', ds_tablespace_ind_w);
	end	if;

    if (ie_tipo_w <> 'UK') then
        ds_comando_w	:= ds_comando_w || ' STORAGE(INITIAL ' || qt_initial_w || 'K NEXT ';
        ds_comando_w	:= ds_comando_w || qt_next_w || 'K PCTINCREASE 0)';
        ds_comando_w	:= ds_comando_w || ' PCTFREE 10 Tablespace ' || ds_tablespace_ind_w;
    end if;
end	if;

if (ie_enterprise_p = 'S' and not ie_tipo_w in ('PK','UK')) then
    ds_comando_w := ds_comando_w || nm_paralelism_w;
end if;

if (ie_oline_p = 'S' and not ie_tipo_w in ('UK')) then
	ds_comando_w := ds_comando_w || ' ONLINE ';
end if;

if (ds_comando_idx_w IS NOT NULL AND ds_comando_idx_w::text <> '') then
    insert into TABELA_VERSAO_OFFLINE_W(nr_sequencia, nr_ordem, ds_comando) values (nextval('tabela_versao_offline_w_seq'),nr_ordem_p,ds_comando_idx_w);
    commit;
    CALL insert_log_cloud(null,null, 'atualizacao', nm_fase_w||'_LOG', null, nm_fase_w);
end if;

insert into TABELA_VERSAO_OFFLINE_W(nr_sequencia, nr_ordem, ds_comando) values (nextval('tabela_versao_offline_w_seq'),nr_ordem_p,ds_comando_w);
commit;
CALL insert_log_cloud(null,null, 'atualizacao', nm_fase_w||'_LOG', null, nm_fase_w);

CALL gravar_processo_longo(ds_comando_w,'TASY_VERSAO_CRIAR_ALTERAR_TABELA',null);


END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_versao_criar_indice ( nm_tabela_p text, nm_Indice_p text, ie_oline_p text, ie_enterprise_p text, nr_ordem_p bigint) FROM PUBLIC;

