-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reg_consistir_saldo_kit (nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE



nr_seq_kit_estoque_w		bigint;
nr_seq_comp_kit_w			bigint;
nr_seq_comp_w			bigint;
cd_material_w			bigint;
qt_material_w			double precision;
qt_diferenca_w			double precision;
cd_local_estoque_w		bigint;

c01 CURSOR FOR
SELECT	b.nr_sequencia,
	b.cd_local_estoque
from	kit_estoque b,
	kit_estoque_reg c
where	b.nr_seq_reg_kit 		= c.nr_sequencia
and	c.nr_sequencia 		= nr_sequencia_p
and	(b.cd_local_estoque IS NOT NULL AND b.cd_local_estoque::text <> '');

c02 CURSOR FOR
SELECT	a.cd_material,
	sum(a.qt_material)
from	kit_estoque_comp a,
	kit_estoque b
WHERE	a.nr_seq_kit_estoque 	= b.nr_sequencia
and	b.nr_sequencia 		= nr_seq_kit_estoque_w
and	a.ie_gerado_barras 		= 'S'
and	coalesce(a.nr_seq_motivo_exclusao::text, '') = ''
group by a.cd_material;


c03 CURSOR FOR
SELECT	a.nr_sequencia,
	a.cd_material,
	a.qt_material,
	a.nr_seq_lote_fornec
from	kit_estoque_comp a,
	kit_estoque b
WHERE	a.nr_seq_kit_estoque 	= b.nr_sequencia
and	b.nr_sequencia 		= nr_seq_kit_estoque_w
and	a.ie_gerado_barras 		= 'S'
and	coalesce(a.nr_seq_motivo_exclusao::text, '') = '';


BEGIN

open c01;
loop
	fetch 	c01
	into	nr_seq_kit_estoque_w,
		cd_local_estoque_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	open c02;
	loop
	fetch	c02
	into	cd_material_w,
		qt_material_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
	begin
		if (qt_material_w > obter_saldo_disp_estoque(cd_estabelecimento_p,cd_material_w,cd_local_estoque_w,trunc(clock_timestamp(),'mm'))) then
			begin

			qt_diferenca_w	:=	abs(qt_material_w - obter_saldo_disp_estoque(cd_estabelecimento_p,cd_material_w,cd_local_estoque_w,trunc(clock_timestamp(),'mm')));

			select	max(coalesce(nr_sequencia,0)) + 1
			into STRICT	nr_seq_comp_kit_w
			from 	kit_estoque_comp
			where	nr_seq_kit_estoque = nr_seq_kit_estoque_w;

			delete from kit_estoque_comp where cd_material = cd_material_w and nr_seq_kit_estoque = nr_seq_kit_estoque_w;


			insert into kit_estoque_comp(nr_seq_kit_estoque,
						nr_sequencia,
						cd_material,
						dt_atualizacao,
						nm_usuario,
						qt_material,
						ie_gerado_barras)
					values (nr_seq_kit_estoque_w,
						nr_seq_comp_kit_w,
						cd_material_w,
						clock_timestamp(),
						nm_usuario_p,
						qt_diferenca_w,
						'N');
			commit;

			select	max(coalesce(nr_sequencia,0)) + 1
			into STRICT	nr_seq_comp_kit_w
			from 	kit_estoque_comp
			where	nr_seq_kit_estoque = nr_seq_kit_estoque_w;

			qt_diferenca_w	:= (qt_material_w - qt_diferenca_w);

			if (qt_diferenca_w > 0) then
				begin
				insert into kit_estoque_comp(nr_seq_kit_estoque,
							nr_sequencia,
							cd_material,
							dt_atualizacao,
							nm_usuario,
							qt_material,
							ie_gerado_barras)
						values (nr_seq_kit_estoque_w,
							nr_seq_comp_kit_w,
							cd_material_w,
							clock_timestamp(),
							nm_usuario_p,
							(qt_material_w - qt_diferenca_w),
							'S');
				end;
			end if;

			commit;

			end;
		end if;

	end;
	end loop;
	close c02;
end;
end loop;
close c01;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reg_consistir_saldo_kit (nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

