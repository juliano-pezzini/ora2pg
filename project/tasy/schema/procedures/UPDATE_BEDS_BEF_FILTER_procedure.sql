-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE update_beds_bef_filter (cd_setor_atendimento_p bigint, cd_departamento_p bigint, ie_meus_pacientes_p text, ie_todos_setores_p text) AS $body$
DECLARE


nm_usuario_w		usuario.nm_usuario%type;
cd_estab_w		estabelecimento.cd_estabelecimento%type;
ds_erro_w		varchar(2500);

c01 CURSOR(cd_setor_atendimento_p 	bigint,
	cd_departamento_p 		bigint, 
	ie_meus_pacientes_p 		text,
	ie_todos_setores_p		text) FOR
	SELECT	distinct
		cd_setor_atendimento
	from	w_pan_agrup_leito
	where	ie_concluido = 'S'
	and     cd_departamento	= cd_departamento_p
	and (coalesce(cd_setor_atendimento_p::text, '') = '' or cd_setor_atendimento = cd_setor_atendimento_p)
	and	obter_se_usuario_setor(nm_usuario_w, cd_setor_atendimento) = 'S'
	and 	cd_estabelecimento = cd_estab_w
	and	coalesce(ie_meus_pacientes_p,'N') = 'N'
	and 	coalesce(ie_todos_setores_p,'N')  = 'N'
	
union

	SELECT	distinct
		cd_setor_atendimento
	from	w_pan_agrup_leito
	where	ie_concluido = 'S'
	and 	coalesce(cd_departamento_p::text, '') = ''
	and	coalesce(ie_meus_pacientes_p,'N') = 'N'
	and 	coalesce(ie_todos_setores_p,'N')  = 'N'
	and	cd_setor_atendimento = cd_setor_atendimento_p 
	and	obter_se_usuario_setor(nm_usuario_w, cd_setor_atendimento) = 'S'
	and 	cd_estabelecimento = cd_estab_w
	
union

	select	distinct
		cd_setor_atendimento
	from	w_pan_agrup_leito
	where	ie_concluido = 'S'
	and 	coalesce(cd_departamento_p::text, '') = ''
	and (coalesce(cd_setor_atendimento_p::text, '') = '' or cd_setor_atendimento = cd_setor_atendimento_p )
	and	obter_se_usuario_setor(nm_usuario_w, cd_setor_atendimento) = 'S'
	and 	cd_estabelecimento = cd_estab_w
	and	coalesce(ie_meus_pacientes_p,'N') = 'S'
	and 	coalesce(ie_todos_setores_p,'N')  = 'N'
	
union

	select	distinct
		cd_setor_atendimento
	from	w_pan_agrup_leito
	where	ie_concluido = 'S'
	and    	cd_departamento	= cd_departamento_p
	and (coalesce(cd_setor_atendimento_p::text, '') = '' or cd_setor_atendimento = cd_setor_atendimento_p )
	and	obter_se_usuario_setor(nm_usuario_w, cd_setor_atendimento) = 'S'
	and 	cd_estabelecimento = cd_estab_w
	and	coalesce(ie_meus_pacientes_p,'N') = 'S'
	and 	coalesce(ie_todos_setores_p,'N')  = 'N'
	
union

	select	distinct
		cd_setor_atendimento
	from	w_pan_agrup_leito
	where	ie_concluido = 'S'
	and 	(cd_setor_atendimento IS NOT NULL AND cd_setor_atendimento::text <> '')
	and	obter_se_usuario_setor(nm_usuario_w, cd_setor_atendimento) = 'S'
	and 	cd_estabelecimento = cd_estab_w
	and	coalesce(ie_meus_pacientes_p,'N') = 'N'
	and 	coalesce(ie_todos_setores_p,'N')  = 'S'
	order by 1;
	
c02 CURSOR(cd_setor_atendimento_p bigint) FOR
	SELECT nr_seq_interno
	from   unidade_atendimento
	where  cd_setor_atendimento = cd_setor_atendimento_p;
BEGIN
	begin
		nm_usuario_w := coalesce(wheb_usuario_pck.get_nm_usuario, 'Tasy');
		cd_estab_w   := coalesce(wheb_usuario_pck.get_cd_estabelecimento, 1);

		for c01_w in c01(cd_setor_atendimento_p, cd_departamento_p, ie_meus_pacientes_p, ie_todos_setores_p) loop
		    for c02_w in c02(c01_w.cd_setor_atendimento) loop
			CALL panorama_leito_pck.atualizar_w_pan_leito(cd_estab_w, c02_w.nr_seq_interno, nm_usuario_w);
		    end loop c02_w;
		end loop c01_w;
		
	exception when others then
		ds_erro_w := substr(sqlerrm,1,2000);
		CALL gravar_log_tasy(19452, ds_erro_w, 'Tasy');
	end;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE update_beds_bef_filter (cd_setor_atendimento_p bigint, cd_departamento_p bigint, ie_meus_pacientes_p text, ie_todos_setores_p text) FROM PUBLIC;

