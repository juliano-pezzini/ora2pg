-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_dose_medic_edit ( cd_material_p bigint, qt_altura_p bigint, qt_peso_p bigint, qt_sc_p bigint, qt_imc_p bigint, qt_dose_terap_p INOUT bigint, nr_unid_med_terap_p bigint, qt_diluente_p bigint, qt_periodo_hora_p bigint, qt_periodo_min_p bigint, cd_intervalo_p text, qt_dose_p INOUT bigint, cd_unidade_medida_p INOUT text, qt_vel_infusao_p INOUT bigint, ie_unidade_vel_p INOUT text, qt_fator_correcao_p bigint, qt_dose_total_p INOUT bigint, qt_dose_interv_p bigint) AS $body$
DECLARE



qt_vol_total_w			double precision;
qt_concent_med_w		double precision;
qt_concent_med_mg_w		double precision;
qt_concent_med_ml_w		double precision := 1;
qt_concent_dose_total_w		double precision;
qt_velocidade_w			double precision;
qt_dose_w			double precision;
qt_dose_peso_w			double precision;
qt_dose_mg_w			double precision;
qt_dose_direta_w		double precision;
qt_dose_ml_w			double precision;
cd_unid_med_concetracao_w	varchar(30);
cd_unid_med_base_conc_w		varchar(30);
ie_unidade_w			varchar(15);
ie_tempo_w			varchar(15);
ds_abreviacao_w			varchar(255);
ie_peso_w			varchar(15);
nr_ocorrencia_w			double precision;
nr_ocorrencia_dia_w		double precision;
qt_horas_w			double precision;
qt_dose_unid_cons_w		double precision;
qt_conversao_w			double precision;
qt_peso_w			double precision;
qt_dose_terap_w			double precision;
ie_solucao_w			varchar(1);
qt_casas_retorno_w		integer;


BEGIN

if (cd_material_p > 0) then
	begin

	select	coalesce(max(qt_casas),0)
	into STRICT	qt_casas_retorno_w
	from	rep_regra_arredond_dose
	where	qt_peso_p between qt_peso_inicial and qt_peso_final;

	if (qt_casas_retorno_w = 0) then
		qt_casas_retorno_w := obter_param_usuario(1903, 2, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, 0, qt_casas_retorno_w);
	end if;

	select	ie_unidade,
		ie_tempo,
		ie_peso,
		ie_solucao,
		obter_desc_expressao(cd_exp_abreviacao,ds_abreviacao)
	into STRICT	ie_unidade_w,
		ie_tempo_w,
		ie_peso_w,
		ie_solucao_w,
		ds_abreviacao_w
	from	regra_dose_terap
	where	nr_sequencia	= nr_unid_med_terap_p;

	qt_peso_w	:= qt_peso_p;
	if (ie_peso_w = 'G') then
		qt_peso_w	:= qt_peso_p * 1000;
	end if;

	/* Conversão da dose terapêutica para mg ou ml */

	if (ie_unidade_w = 'MG') then
		qt_dose_terap_w	:= qt_dose_terap_p;
	elsif (ie_unidade_w = 'MCG') then
		qt_dose_terap_w	:= dividir(qt_dose_terap_p,1000);
	elsif (ie_unidade_w = 'G') then
		qt_dose_terap_w	:= qt_dose_terap_p * 1000;
	elsif (ie_unidade_w = 'MEQ') then
		select	obter_conversao_unid_med_cons(cd_material_p,upper(obter_unid_med_usua('MEQ')),qt_dose_terap_p)
		into STRICT	qt_dose_unid_cons_w
		;
	elsif (ie_unidade_w = 'UI') then
		select	obter_conversao_unid_med_cons(cd_material_p,upper(obter_unid_med_usua('UI')),qt_dose_terap_p)
		into STRICT	qt_dose_unid_cons_w
		;
	elsif (ie_unidade_w = 'L') then
		qt_dose_terap_w	:= qt_dose_terap_p * 1000;
	elsif (ie_unidade_w = 'ML') then
		qt_dose_terap_w	:= qt_dose_terap_p;
	elsif (ie_unidade_w = 'UE100') then
		qt_dose_terap_w	:= dividir(qt_dose_terap_p,100);
	elsif (ie_unidade_w = 'GTS') then
		qt_dose_terap_w	:= dividir(qt_dose_terap_p,20);
	elsif (ie_unidade_w = 'MCGT') then
		qt_dose_terap_w	:= dividir(qt_dose_terap_p,50);
	end if;

	if (ie_unidade_w in ('MG','MCG','G')) then
		select	obter_conversao_unid_med_cons(cd_material_p,upper(obter_unid_med_usua('MG')),qt_dose_terap_w)
		into STRICT	qt_dose_unid_cons_w
		;
	elsif (ie_unidade_w in ('L','ML','UE100')) then
		select	obter_conversao_unid_med_cons(cd_material_p,upper(obter_unid_med_usua('ML')),qt_dose_terap_w)
		into STRICT	qt_dose_unid_cons_w
		;
	end if;

	select	max(coalesce(qt_conversao_mg,1)),
		max(upper(cd_unid_med_concetracao)),
		max(upper(cd_unid_med_base_conc))
	into STRICT	qt_concent_med_w,
		cd_unid_med_concetracao_w,
		cd_unid_med_base_conc_w
	from	material
	where	cd_material	= cd_material_p;

	select	Obter_ocorrencia_intervalo(cd_intervalo_p,qt_periodo_hora_p,'O'),
		Obter_ocorrencia_intervalo(cd_intervalo_p,24,'O'),
		Obter_ocorrencia_intervalo(cd_intervalo_p,qt_periodo_hora_p,'H')
	into STRICT	nr_ocorrencia_w,
		nr_ocorrencia_dia_w,
		qt_horas_w
	;

	/*Converter concentração para mg/ml*/

	if (cd_unid_med_concetracao_w = 'MG') then
		qt_concent_med_mg_w	:= qt_concent_med_w;
	elsif (cd_unid_med_concetracao_w = 'KG') then
		qt_concent_med_mg_w	:= qt_concent_med_w * 1000 * 1000;
	elsif (cd_unid_med_concetracao_w = 'G') then
		qt_concent_med_mg_w	:= qt_concent_med_w * 1000;
	elsif (cd_unid_med_concetracao_w = 'MCG') then
		qt_concent_med_mg_w	:= dividir(qt_concent_med_w,1000);
	end if;

	if (cd_unid_med_base_conc_w = 'ML') then
		qt_concent_med_ml_w	:= 1;
	elsif (cd_unid_med_base_conc_w = 'L') then
		qt_concent_med_ml_w	:= qt_concent_med_w * 1000;
	elsif (cd_unid_med_base_conc_w = 'UE100') then
		qt_concent_med_ml_w	:= dividir(qt_concent_med_w,100);
	end if;

	if (ie_solucao_w = 'N') then
		begin
		if (coalesce(ie_tempo_w::text, '') = '') then
			if (qt_casas_retorno_w  > 0) then
				--qt_dose_interv_p	:= round(qt_peso_w * qt_dose_terap_p, qt_casas_retorno_w);
				qt_dose_total_p		:= round(dividir((qt_periodo_hora_p * (qt_dose_interv_p * nr_ocorrencia_w)),24), qt_casas_retorno_w);
			else
				--qt_dose_interv_p	:= qt_peso_w * qt_dose_terap_p;
				qt_dose_total_p		:= dividir((qt_periodo_hora_p * (qt_dose_interv_p * nr_ocorrencia_w)),24);
			end if;
		else
			if (qt_casas_retorno_w  > 0) then
				qt_dose_total_p		:= round(dividir((qt_periodo_hora_p * (qt_dose_interv_p * nr_ocorrencia_w)),24),qt_casas_retorno_w);
				--qt_dose_interv_p	:= round(dividir((qt_peso_w * qt_dose_terap_p),nr_ocorrencia_w),qt_casas_retorno_w);
			else
				qt_dose_total_p		:= dividir((qt_periodo_hora_p * (qt_dose_interv_p * nr_ocorrencia_w)),24);
				--qt_dose_interv_p	:= dividir((qt_peso_w * qt_dose_terap_p),nr_ocorrencia_w);
			end if;
			qt_dose_unid_cons_w	:= round((qt_dose_unid_cons_w / nr_ocorrencia_w)::numeric,5);
			if (ie_tempo_w = 'M')  then
				qt_dose_total_p		:= qt_dose_total_p * 1440;
				--qt_dose_interv_p	:= qt_dose_interv_p * 1440;
				qt_dose_unid_cons_w	:= qt_dose_unid_cons_w * 1440;
			elsif (ie_tempo_w = 'H') then
				qt_dose_total_p		:= qt_dose_total_p * 24;
				--qt_dose_interv_p	:= qt_dose_interv_p * 24;
				qt_dose_unid_cons_w	:= qt_dose_unid_cons_w * 24;
			end if;
		end if;

		select	obter_conversao_unid_med(cd_material_p,cd_unidade_medida_p)
		into STRICT	qt_conversao_w
		;

		if (ds_abreviacao_w = obter_desc_expressao(881462)) or (ds_abreviacao_w = obter_desc_expressao(881464)) then
			qt_peso_w	:= qt_sc_p;
		end if;
		if (qt_casas_retorno_w  > 0) then
			qt_dose_p	:= round(qt_dose_unid_cons_w * qt_conversao_w * qt_peso_w, qt_casas_retorno_w);
		else
			qt_dose_p	:= qt_dose_unid_cons_w * qt_conversao_w * qt_peso_w;
		end if;

		--qt_dose_p	:= Ceil(qt_dose_p);
		end;
	elsif (ie_solucao_w = 'S') then
		begin
		qt_dose_w		:= obter_conversao_ml(cd_material_p,qt_dose_p,cd_unidade_medida_p);
		qt_vol_total_w		:= qt_dose_w + qt_diluente_p;
		qt_concent_med_w	:= dividir(qt_concent_med_mg_w,qt_concent_med_ml_w) * qt_dose_w;

		/*Obter a concentração da dose total com base na unidade selecionada pelo médico */

		if (ie_unidade_w = 'MCG') then
			qt_concent_dose_total_w	:= dividir(qt_concent_med_w,qt_vol_total_w) * 1000;
		elsif (ie_unidade_w = 'MG') then
			qt_concent_dose_total_w	:= dividir(qt_concent_med_w,qt_vol_total_w);
		end if;
		if (qt_dose_terap_p > 0) then
			begin

			qt_dose_direta_w	:= qt_dose_terap_p;

			/*Conversão p/ unidade direta do elemento se for por peso*/

			if (ie_peso_w IS NOT NULL AND ie_peso_w::text <> '') then
				qt_dose_direta_w	:= qt_peso_w * qt_dose_terap_p;
			end if;

			qt_dose_ml_w	:= dividir(qt_dose_direta_w,qt_concent_dose_total_w);

			if (ie_tempo_w ='M') or (ie_tempo_w ='H') then
				begin
				/*Transformar em ml/hora */

				if (upper(ie_unidade_vel_p) = 'MLH') then
					if (ie_tempo_w ='M') then
						qt_dose_ml_w	:= qt_dose_ml_w * 60;
					end if;
				end if;

				/*Transformar em gotas/minuto */

				if (upper(ie_unidade_vel_p) = 'GTM') then
					qt_dose_ml_w	:= qt_dose_ml_w * 20;
					if (ie_tempo_w ='H') then
						qt_dose_ml_w	:= dividir(qt_dose_ml_w,60);
					end if;
				end if;

				/*Transformar em microgotas/minuto */

				if (upper(ie_unidade_vel_p) = 'MGM') then
					qt_dose_ml_w	:= qt_dose_ml_w * 60;
					if (ie_tempo_w ='H') then
						qt_dose_ml_w	:= dividir(qt_dose_ml_w,60);
					end if;
				end if;
				qt_vel_infusao_p	:= qt_dose_ml_w;
				end;
			else
				qt_vel_infusao_p	:= qt_dose_ml_w;
			end if;

			end;
		else
			begin
			qt_velocidade_w		:= qt_vel_infusao_p;
			if (upper(ie_unidade_vel_p) = 'GTM') then
				qt_velocidade_w	:= dividir(qt_vel_infusao_p,20) * 60;
			end if;

			qt_dose_terap_p	:= qt_concent_dose_total_w * qt_velocidade_w;
			if (ie_peso_w = 'KG') then
				qt_dose_terap_p	:= dividir(qt_dose_terap_p,qt_peso_p);
			end if;
			if (ie_tempo_w = 'M') then
				qt_dose_terap_p	:= dividir(qt_dose_terap_p,60);
			end if;

			end;
		end if;
		end;
	end if;
	end;
else
	qt_vel_infusao_p	:= null;
end if;


END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_dose_medic_edit ( cd_material_p bigint, qt_altura_p bigint, qt_peso_p bigint, qt_sc_p bigint, qt_imc_p bigint, qt_dose_terap_p INOUT bigint, nr_unid_med_terap_p bigint, qt_diluente_p bigint, qt_periodo_hora_p bigint, qt_periodo_min_p bigint, cd_intervalo_p text, qt_dose_p INOUT bigint, cd_unidade_medida_p INOUT text, qt_vel_infusao_p INOUT bigint, ie_unidade_vel_p INOUT text, qt_fator_correcao_p bigint, qt_dose_total_p INOUT bigint, qt_dose_interv_p bigint) FROM PUBLIC;

