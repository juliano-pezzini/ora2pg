-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cobr_brasil_240_v87_msg ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text ) AS $body$
DECLARE


ds_conteudo_w			varchar(240);
cd_banco_w			varchar(3);
nr_inscricao_w			varchar(15);
cd_convenio_banco_w		varchar(20);
cd_agencia_bancaria_w		varchar(5);
nr_digito_agencia_w		varchar(2);
nr_conta_corrente_w		varchar(15);
nm_empresa_w			varchar(80);
ds_banco_w			varchar(30);
dt_geracao_arquivo_w		varchar(14);
nr_seq_arquivo_w			varchar(6);
ie_tipo_registro_w			varchar(1);
nr_seq_envio_w			varchar(8);
ds_endereco_w			varchar(40);
nr_endereco_w			varchar(5);
ds_bairro_w			varchar(40);
ds_complemento_w			varchar(18);
ds_cidade_w			varchar(20);
cd_cep_w			varchar(8);
sg_uf_w				varchar(2);
dt_gravacao_w			varchar(8);
nr_seq_apres_w			bigint := 0;
qt_reg_arquivo_w			bigint := 0;
vl_liquidacao_w			varchar(18);
dt_vencimento_w			varchar(8);
vl_cobranca_w			varchar(15);
vl_desconto_w			varchar(15);
dt_desconto_w			varchar(8);
vl_mora_w			varchar(15);
dt_pagamento_w			varchar(8);
ds_nosso_numero_w		varchar(20);
nr_nosso_numero_w		varchar(20);
nr_seq_carteira_cobr_w		varchar(1);
nr_documento_cobr_w		varchar(15);
dt_emissao_w			varchar(8);
nr_titulo_w			varchar(25);
nm_pessoa_titulo_w		varchar(40);
ie_codigo_desconto_w		varchar(1);
ie_tipo_inscricao_w			varchar(5);
nr_seq_registro_w			bigint := 0;
sg_estado_w			varchar(15);
cd_mov_remessa_w		varchar(2);
qt_reg_lote_w			bigint := 0;

ds_conteudo_aux_w		varchar(200);
ie_impressao_w			varchar(1);
nr_linha_w			integer;
ds_mensagem_3_w			varchar(40);
ds_mensagem_4_w			varchar(40);

C01 CURSOR FOR
	SELECT	lpad(coalesce(substr(c.cd_ocorrencia,1,2),'01'),2,'0') cd_mov_remessa,
		lpad(c.cd_banco,3,'0') cd_banco,
		substr(a.nr_sequencia,1,5) nr_seq_envio,
		'3' ie_tipo_registro,
		lpad(somente_numero(to_char(c.vl_liquidacao,'9999999999990.00')),15,'0') vl_liqudacao,
		rpad('Banco do Brasil',30,' ') nm_cedente,
		to_char(b.dt_pagamento_previsto,'ddmmyyyy') dt_vencimento,
		lpad(somente_numero(to_char(c.vl_cobranca,'9999999999990.00')),15,'0') vl_cobranca,
		lpad(somente_numero(to_char(c.vl_desconto,'9999999999990.00')),15,'0') vl_desconto,
		CASE WHEN coalesce(c.vl_desconto,0)=0 THEN '00000000'  ELSE to_char(clock_timestamp(),'ddmmyyyy') END  dt_desconto,
		lpad(somente_numero(to_char(coalesce(c.vl_juros,0) + coalesce(c.vl_multa,0),'9999999999990.00')),15,'0') vl_mora,
		to_char(c.dt_liquidacao,'ddmmyyyy') dt_pagamento,
		rpad(coalesce(b.nr_nosso_numero,' '),20,' ') ds_nosso_numero,
		lpad(substr(coalesce(c.cd_agencia_bancaria,'0'),1,5),5,'0') cd_agencia_bancaria,
		rpad(coalesce(calcula_digito('Modulo11',coalesce(c.cd_agencia_bancaria,'0')),'0'),1,'0') nr_digito_agencia,
		lpad(substr(coalesce(e.cd_conta,'0'),1,12),12,'0') || rpad(substr(coalesce(e.ie_digito_conta,'0'),1,1),1,'0') nr_conta_corrente,
		rpad(coalesce(b.nr_nosso_numero,' '),20,' ') nr_nosso_numero,
		lpad(coalesce(b.nr_seq_carteira_cobr,0),1,'0') nr_seq_carteira_cobr,
		rpad(c.nr_titulo,15,' ') nr_documento_cobr,
		to_char(b.dt_emissao,'ddmmyyyy') dt_emissao,
		b.nr_titulo,
		CASE WHEN coalesce(b.cd_pessoa_fisica::text, '') = '' THEN '2'  ELSE '1' END  ie_tipo_inscricao,
		lpad(CASE WHEN coalesce(b.cd_pessoa_fisica::text, '') = '' THEN b.cd_cgc  ELSE (	SELECT	x.nr_cpf								from	pessoa_fisica x								where	x.cd_pessoa_fisica	= b.cd_pessoa_fisica) END ,15,'0') nr_inscricao,
		rpad(upper(coalesce(substr(obter_nome_pf_pj(b.cd_pessoa_fisica,b.cd_cgc),1,40),' ')),40,' ') nm_pessoa_titulo,
		rpad(upper(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'EN'),1,40),' ')),40,' ') ds_endereco,
		rpad(upper(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'B'),1,15),' ')),15,' ') ds_bairro,
		lpad(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'CEP'),1,8),' '),8,'0') cd_cep,
		rpad(upper(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'CI'),1,15),' ')),15,' ') ds_cidade,
		rpad(upper(coalesce(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'UF'),1,2),' ')),2,' ') sg_estado,
		CASE WHEN coalesce(c.vl_desconto,0)=0 THEN '0'  ELSE '1' END  ie_codigo_desconto,
		rpad(coalesce(obter_instrucao_boleto_estab(b.nr_titulo,a.cd_banco,1,coalesce(cd_estabelecimento_p,a.cd_estabelecimento)), ' '),40, ' ') ds_mensagem_3,
		rpad(coalesce(obter_instrucao_boleto_estab(b.nr_titulo,a.cd_banco,2,coalesce(cd_estabelecimento_p,a.cd_estabelecimento)), ' '),40, ' ') ds_mensagem_4
	FROM banco_estabelecimento e, titulo_receber_cobr c, titulo_receber_v b, cobranca_escritural a
LEFT OUTER JOIN banco_carteira d ON (a.nr_seq_carteira_cobr = d.nr_sequencia)
WHERE a.nr_sequencia		= c.nr_seq_cobranca and c.nr_titulo		= b.nr_titulo and a.nr_seq_conta_banco	= e.nr_sequencia  and a.nr_sequencia		= nr_seq_cobr_escrit_p;

C02 CURSOR FOR
	SELECT	ds_mensagem,
		ie_impressao,
		somente_numero(substr(nr_linha,1,2)) nr_linha
	from (SELECT	rpad(substr(obter_instrucao_boleto_estab(nr_titulo_w,cd_banco_w,a.nr_linha,cd_estabelecimento_p),1,100),100,' ') ds_mensagem,
			'1' ie_impressao,
			coalesce(a.nr_linha,0) + 1 nr_linha
		from	banco_instrucao_boleto a
		where	a.cd_banco	= cd_banco_w
		and	a.cd_estabelecimento = cd_estabelecimento_p
		order by	a.nr_linha) alias6
	where	(trim(both ds_mensagem) IS NOT NULL AND (trim(both ds_mensagem))::text <> '')
	order by	nr_linha;


BEGIN

delete	from w_envio_banco
where	nm_usuario	= nm_usuario_p;

/* Header Arquivo*/

select	'0' ie_tipo_registro,
	lpad(c.cd_banco,3,'0') cd_banco,
	to_char(clock_timestamp(),'DDMMYYYYHHMISS') dt_geracao_arquivo,
	rpad('BANCO DO BRASIL S.A.',30,' ') ds_banco,
	lpad(c.cd_agencia_bancaria,5,'0') cd_agencia_bancaria,
	rpad(calcula_digito('Modulo11',c.cd_agencia_bancaria),1,'0') nr_digito_agencia,
	lpad(c.cd_conta,12,'0') || rpad(c.ie_digito_conta,1,'0') nr_conta_corrente,
	rpad(upper(substr(obter_razao_social(b.cd_cgc),1,30)),30,' ') nm_empresa,
	lpad(b.cd_cgc,14,'0') nr_inscricao,
	substr(coalesce(d.cd_convenio_banco,c.cd_convenio_banco),1,20) cd_convenio_banco,
	lpad(a.nr_sequencia,6,'0')
into STRICT	ie_tipo_registro_w,
	cd_banco_w,
	dt_geracao_arquivo_w,
	ds_banco_w,
	cd_agencia_bancaria_w,
	nr_digito_agencia_w,
	nr_conta_corrente_w,
	nm_empresa_w,
	nr_inscricao_w,
	cd_convenio_banco_w,
	nr_seq_arquivo_w
FROM banco_estabelecimento c, estabelecimento b, cobranca_escritural a
LEFT OUTER JOIN banco_carteira d ON (a.nr_seq_carteira_cobr = d.nr_sequencia)
WHERE a.cd_estabelecimento	= b.cd_estabelecimento and a.nr_seq_conta_banco	= c.nr_sequencia  and a.nr_sequencia		= nr_seq_cobr_escrit_p;

ds_conteudo_w	:=	cd_banco_w ||
			'0000' ||
			'0' ||
			rpad(' ',9,' ') ||
			'2' ||
			nr_inscricao_w ||
			lpad(coalesce(cd_convenio_banco_w,'0'),20,'0') ||
			cd_agencia_bancaria_w ||
			nr_digito_agencia_w ||
			nr_conta_corrente_w ||
			' ' ||
			nm_empresa_w ||
			ds_banco_w ||
			rpad(' ',10,' ') ||
			'1' ||
			dt_geracao_arquivo_w ||
			nr_seq_arquivo_w ||
			rpad(' ',5,' ') ||
			'087' ||
			rpad(' ',69,' ');

nr_seq_apres_w	:= nr_seq_apres_w + 1;

insert into w_envio_banco(	nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_estabelecimento,
		ds_conteudo,
		nr_seq_apres)
values (	nextval('w_envio_banco_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_p,
		ds_conteudo_w,
		nr_seq_apres_w);

qt_reg_arquivo_w	:= qt_reg_arquivo_w + 1;
/* Fim Header Arquivo */

/* Header Lote */

select	'1' ie_tipo_registro,
	lpad(c.cd_banco,3,'0') cd_banco,
	lpad(a.nr_sequencia,8,'0') nr_seq_envio,
	lpad(c.cd_agencia_bancaria,5,'0') cd_agencia_bancaria,
	rpad(calcula_digito('Modulo11',c.cd_agencia_bancaria),1,'0') nr_digito_agencia,
	lpad(c.cd_conta,12,'0') || rpad(c.ie_digito_conta,1,'0') nr_conta_corrente,
	rpad(upper(substr(obter_razao_social(b.cd_cgc),1,30)),30,' ') nm_empresa,
	lpad(b.cd_cgc,15,'0') nr_inscricao,
	coalesce(d.cd_convenio_banco,c.cd_convenio_banco) cd_convenio_banco,
	rpad(a.nr_sequencia,6,'0'),
	rpad(obter_dados_pf_pj(null, b.cd_cgc,'EN'),40,' '),
	rpad(obter_dados_pf_pj(null, b.cd_cgc,'NR'),5,' '),
	rpad(obter_dados_pf_pj(null, b.cd_cgc,'CM'),18,' '),
	rpad(obter_dados_pf_pj(null, b.cd_cgc,'MU'),20,' '),
	rpad(obter_dados_pf_pj(null, b.cd_cgc,'CEP'),8,' '),
	rpad(obter_dados_pf_pj(null, b.cd_cgc,'UF'),2,' '),
	to_char(clock_timestamp(),'DDMMYYYY') dt_gravacao
into STRICT	ie_tipo_registro_w,
	cd_banco_w,
	nr_seq_envio_w,
	cd_agencia_bancaria_w,
	nr_digito_agencia_w,
	nr_conta_corrente_w,
	nm_empresa_w,
	nr_inscricao_w,
	cd_convenio_banco_w,
	nr_seq_arquivo_w,
	ds_endereco_w,
	nr_endereco_w,
	ds_complemento_w,
	ds_cidade_w,
	cd_cep_w,
	sg_uf_w,
	dt_gravacao_w
FROM banco_estabelecimento c, estabelecimento b, cobranca_escritural a
LEFT OUTER JOIN banco_carteira d ON (a.nr_seq_carteira_cobr = d.nr_sequencia)
WHERE a.cd_estabelecimento	= b.cd_estabelecimento and a.nr_seq_conta_banco	= c.nr_sequencia  and a.nr_sequencia		= nr_seq_cobr_escrit_p;

ds_conteudo_w	:= 	cd_banco_w ||
			'0001' ||
			'1' ||
			'G0770010 2' ||
			nr_inscricao_w ||
			lpad(coalesce(cd_convenio_banco_w,'0'),20,'0') ||
			cd_agencia_bancaria_w ||
			nr_digito_agencia_w ||
			nr_conta_corrente_w ||
			' ' || nm_empresa_w ||
			'SDS' ||
			lpad('0',6,'0') ||
			rpad(' ',31,' ') ||
			lpad('0',26,'0') ||
			rpad(' ',5,' ') ||
			lpad('0',5,'0') ||
			rpad(' ',60,' ');

nr_seq_apres_w	:= nr_seq_apres_w + 1;
qt_reg_lote_w	:= qt_reg_lote_w + 1;

insert into w_envio_banco(	nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_estabelecimento,
		ds_conteudo,
		nr_seq_apres)
values (	nextval('w_envio_banco_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_p,
		ds_conteudo_w,
		nr_seq_apres_w);

qt_reg_arquivo_w	:= qt_reg_arquivo_w + 1;
/* Fim Header Lote */

/* Detalhe */

open C01;
loop
fetch C01 into
	cd_mov_remessa_w,
	cd_banco_w,
	nr_seq_envio_w,
	ie_tipo_registro_w,
	vl_liquidacao_w,
	ds_banco_w,
	dt_vencimento_w,
	vl_cobranca_w,
	vl_desconto_w,
	dt_desconto_w,
	vl_mora_w,
	dt_pagamento_w,
	ds_nosso_numero_w,
	cd_agencia_bancaria_w,
	nr_digito_agencia_w,
	nr_conta_corrente_w,
	nr_nosso_numero_w,
	nr_seq_carteira_cobr_w,
	nr_documento_cobr_w,
	dt_emissao_w,
	nr_titulo_w,
	ie_tipo_inscricao_w,
	nr_inscricao_w,
	nm_pessoa_titulo_w,
	ds_endereco_w,
	ds_bairro_w,
	cd_cep_w,
	ds_cidade_w,
	sg_estado_w,
	ie_codigo_desconto_w,
	ds_mensagem_3_w,
	ds_mensagem_4_w;
EXIT WHEN NOT FOUND; /* apply on C01 */


	/* Segmento P */

	nr_seq_apres_w		:= nr_seq_apres_w + 1;
	nr_seq_registro_w	:= nr_seq_registro_w + 1;
	qt_reg_lote_w		:= qt_reg_lote_w + 1;

	if (length(coalesce(cd_convenio_banco_w,' ')) = 7) then
		ds_nosso_numero_w	:= cd_convenio_banco_w || lpad(nr_titulo_w,10,'0');
	elsif (length(coalesce(cd_convenio_banco_w,' ')) >= 5) then
		ds_nosso_numero_w	:= lpad(cd_convenio_banco_w,6,'0') || lpad(nr_titulo_w,5,'0');
		ds_nosso_numero_w	:= ds_nosso_numero_w || calcula_digito('MODULO11',ds_nosso_numero_w);
	elsif (length(coalesce(cd_convenio_banco_w,' ')) <= 4) then
		ds_nosso_numero_w	:= lpad(cd_convenio_banco_w,4,'0') || lpad(nr_titulo_w,7,'0');
		ds_nosso_numero_w	:= ds_nosso_numero_w || calcula_digito('MODULO11',ds_nosso_numero_w);
	end if;

	ds_conteudo_w	:=	cd_banco_w ||
				'0001' ||
				'3' ||
				lpad(nr_seq_registro_w,5,'0') ||
				'P' ||
				' ' ||
				'01' ||
				cd_agencia_bancaria_w ||
				nr_digito_agencia_w ||
				nr_conta_corrente_w ||
				' ' ||
				rpad(ds_nosso_numero_w,20,' ') ||
				nr_seq_carteira_cobr_w ||
				'1' ||
				'2' ||
				'2' ||
				'2' ||
				nr_documento_cobr_w ||
				dt_vencimento_w ||
				vl_cobranca_w ||
				'00000' ||
				' ' ||
				'02' ||
				'N' ||
				dt_emissao_w ||
				'1' ||
				'00000000' ||
				vl_mora_w ||
				ie_codigo_desconto_w ||
				dt_desconto_w ||
				vl_desconto_w ||
				'000000000000000' ||
				'000000000000000' ||
				rpad(nr_titulo_w,25,' ') ||
				'3' ||
				'00' ||
				'1' ||
				'000' ||
				'09' ||
				'0000000000' ||
				' ';
	insert into w_envio_banco(	nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_estabelecimento,
			ds_conteudo,
			nr_seq_apres)
	values (	nextval('w_envio_banco_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_estabelecimento_p,
			ds_conteudo_w,
			nr_seq_apres_w);
	/* Fim segmento P */

	/* Segmento Q */

	ds_conteudo_w		:= null;
	nr_seq_apres_w		:= nr_seq_apres_w + 1;
	nr_seq_registro_w 	:= nr_seq_registro_w + 1;
	qt_reg_lote_w		:= qt_reg_lote_w + 1;

	ds_conteudo_w	:= 	cd_banco_w ||
				'0001' ||
				'3' ||
				lpad(nr_seq_registro_w,5,'0') ||
				'Q' ||
				' ' ||
				'01' ||
				rpad(coalesce(ie_tipo_inscricao_w,'0'),1,'0') ||
				rpad(coalesce(nr_inscricao_w,'0'),14,' ') ||
				rpad(coalesce(nm_pessoa_titulo_w,' '),40,' ') ||
				rpad(coalesce(ds_endereco_w,' '),40,' ') ||
				rpad(coalesce(ds_bairro_w,' '),15,' ') ||
				rpad(coalesce(cd_cep_w,'0'),8,'0') ||
				rpad(coalesce(ds_cidade_w,' '),15,' ') ||
				substr(rpad(coalesce(sg_estado_w,' '),2,' '),1,2) ||
				'0' ||
				rpad(' ',55,' ') ||
				'000' ||
				rpad(' ',28,' ');

	insert into w_envio_banco(	nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_estabelecimento,
			ds_conteudo,
			nr_seq_apres)
	values (	nextval('w_envio_banco_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_estabelecimento_p,
			ds_conteudo_w,
			nr_seq_apres_w);

	/* Fim segmento Q */

	qt_reg_arquivo_w	:= qt_reg_arquivo_w + 1;

	/*Inicio Segmento R*/

	if (somente_numero(vl_mora_w) <> 0) then

	ds_conteudo_w		:= null;
	nr_seq_apres_w		:= nr_seq_apres_w + 1;
	nr_seq_registro_w 	:= nr_seq_registro_w + 1;
	qt_reg_lote_w		:= qt_reg_lote_w + 1;

		ds_conteudo_w	:=	cd_banco_w ||
					'0001' ||
					'3' ||
					lpad(nr_seq_registro_w, 5, '0') ||
					'R' ||
					rpad(' ', 1, ' ') ||
					cd_mov_remessa_w ||
					'0' ||
					'00000000' ||
					'000000000000000' ||
					'                        ' ||
					'1' ||
					dt_vencimento_w ||
					vl_mora_w ||
					'          ' ||
					ds_mensagem_3_w ||
					ds_mensagem_4_w ||
					rpad(' ', 61, ' ');

		insert	into w_envio_banco(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_estabelecimento,
			ds_conteudo,
			nr_seq_apres)
		values (nextval('w_envio_banco_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_estabelecimento_p,
			ds_conteudo_w,
			nr_seq_apres_w);

	end if;
/* Fim segmento R */

/*Inicio Segmento S */

	open C02;
	loop
	fetch C02 into
		ds_conteudo_aux_w,
		ie_impressao_w,
		nr_linha_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		/* Segmento S */

		ds_conteudo_w		:= null;
		nr_seq_apres_w		:= nr_seq_apres_w + 1;
		nr_seq_registro_w 	:= nr_seq_registro_w + 1;
		qt_reg_lote_w		:= qt_reg_lote_w + 1;

		if (ie_impressao_w	= '1') then

			ds_conteudo_w	:=	cd_banco_w ||
						'0001' ||
						'3' ||
						lpad(nr_seq_registro_w, 5, '0') ||
						'S' ||
						' ' ||
						cd_mov_remessa_w ||
						ie_impressao_w ||
						lpad(nr_linha_w,2,'0') ||
						'4' ||
						ds_conteudo_aux_w ||
						rpad(' ',119,' ');

		else

			ds_conteudo_w	:=	cd_banco_w ||
						'0001' ||
						'3' ||
						lpad(nr_seq_registro_w, 5, '0') ||
						'S' ||
						' ' ||
						cd_mov_remessa_w ||
						ie_impressao_w ||
						ds_conteudo_aux_w ||
						rpad(' ',22,' ');

		end if;

		insert	into w_envio_banco(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_estabelecimento,
			ds_conteudo,
			nr_seq_apres)
		values (nextval('w_envio_banco_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_estabelecimento_p,
			ds_conteudo_w,
			nr_seq_apres_w);

		/* Fim segmento S */

		end;
	end loop;
	close C02;
end loop;
close C01;

/* Trailler Lote*/

select	'9' ie_tipo_registro,
	'0001' nr_seq_envio,
	somente_numero(to_char(sum(b.vl_liquidacao),'000000000000.00'))
into STRICT	ie_tipo_registro_w,
	nr_seq_envio_w,
	vl_liquidacao_w
from	titulo_receber_cobr b,
	cobranca_escritural a
where	a.nr_sequencia		= b.nr_seq_cobranca
and	a.nr_sequencia		= nr_seq_cobr_escrit_p
group by a.nr_sequencia,
	 a.dt_remessa_retorno,
	 a.dt_remessa_retorno,
	 a.cd_banco,
	a.ie_emissao_bloqueto;

qt_reg_lote_w	:= qt_reg_lote_w + 1;

ds_conteudo_w	:= 	'001' || nr_seq_envio_w || '5' || rpad(' ',9,' ') || lpad(qt_reg_lote_w,6,'0') || lpad(vl_liquidacao_w,18,'0') ||
			'000000000000000000' || rpad(' ',175,' ');

nr_seq_apres_w	:= nr_seq_apres_w + 1;

insert into w_envio_banco(	nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_estabelecimento,
		ds_conteudo,
		nr_seq_apres)
values (	nextval('w_envio_banco_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_p,
		ds_conteudo_w,
		nr_seq_apres_w);

qt_reg_arquivo_w	:= qt_reg_arquivo_w + 1;
/* Fim Trailler Lote*/

/* Trailler Arquivo*/

select	max('9') ie_tipo_registro,
	max('99999') nr_seq_envio
into STRICT	ie_tipo_registro_w,
	nr_seq_envio_w
from	titulo_receber_cobr b,
	cobranca_escritural a
where	a.nr_sequencia		= b.nr_seq_cobranca
and	a.nr_sequencia		= nr_seq_cobr_escrit_p;

qt_reg_lote_w	:= qt_reg_lote_w + 1;
qt_reg_arquivo_w := qt_reg_arquivo_w + 1;

ds_conteudo_w	:=	'001' || '9999' || '9' || rpad(' ',9,' ') || '000001' || lpad(qt_reg_lote_w,6,'0') || '000000' ||
			rpad(' ',205,' ');

nr_seq_apres_w	:= nr_seq_apres_w + 1;

insert into w_envio_banco(	nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_estabelecimento,
		ds_conteudo,
		nr_seq_apres)
values (	nextval('w_envio_banco_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_p,
		ds_conteudo_w,
		nr_seq_apres_w);
/* Fim Trailler Arquivo*/

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cobr_brasil_240_v87_msg ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text ) FROM PUBLIC;

