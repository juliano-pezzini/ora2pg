-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_previsao_migracao ( cd_estabelecimento_p bigint, nr_seq_grupo_desenv_p bigint, dt_referencia_p timestamp, qt_colaboradores_p bigint, qt_horas_colaborador_p bigint, ie_previsao_futura_p text, nr_seq_prev_combinar_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_horas_previstas_w		double precision;
qt_horas_realizadas_w		double precision;
qt_horas_sobra_w		double precision;
qt_horas_desenvolver_w		double precision;
dt_referencia_w			timestamp;
qt_horas_real_prev_w		double precision;
nr_controle_loop_w		smallint := 0;
dt_referencia_fim_mes_w		timestamp;
qt_dias_uteis_mes_w		bigint;
qt_horas_uteis_mes_w		bigint;
qt_horas_possiveis_mes_w	double precision;
pr_previsto_w			real;
nr_seq_hist_prev_w		bigint;
nr_seq_previsao_w		bigint;


BEGIN
if (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') and (nr_seq_grupo_desenv_p IS NOT NULL AND nr_seq_grupo_desenv_p::text <> '') and (dt_referencia_p IS NOT NULL AND dt_referencia_p::text <> '') and (qt_colaboradores_p IS NOT NULL AND qt_colaboradores_p::text <> '') and (qt_horas_colaborador_p IS NOT NULL AND qt_horas_colaborador_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin
	if (ie_previsao_futura_p = 'S') then
		begin
		nr_seq_hist_prev_w := nr_seq_prev_combinar_p;
		end;
	else
		begin
		select	nextval('w_hist_prev_proj_desenv_seq')
		into STRICT	nr_seq_hist_prev_w
		;

		insert into w_hist_prev_proj_desenv(
			nr_sequencia,
			nm_usuario_previsao,
			dt_previsao,
			nr_seq_gerencia,
			nr_seq_grupo_des,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			nm_usuario,
			dt_atualizacao)
		values (
			nr_seq_hist_prev_w,
			nm_usuario_p,
			clock_timestamp(),
			9,
			nr_seq_grupo_desenv_p,
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp());
		end;
	end if;

	select	coalesce(sum(coalesce(proj_obter_qt_total_horas_cron(p.nr_sequencia, 0, 'T', 'E'), 0)), 0),
		coalesce(sum(coalesce(proj_obter_qt_total_horas_cron(p.nr_sequencia, 0, 'R', 'E'), 0)), 0)
	into STRICT	qt_horas_previstas_w,
		qt_horas_realizadas_w
	from	proj_projeto p
	where	p.nr_seq_gerencia = 9
	and	p.nr_seq_classif = 14
	and	p.nr_seq_grupo_des = nr_seq_grupo_desenv_p;

	select	coalesce(sum(coalesce(proj_obter_qt_total_horas_cron(p.nr_sequencia, 0, 'S', 'E'), 0)), 0)
	into STRICT	qt_horas_sobra_w
	from	proj_projeto p
	where	p.nr_seq_gerencia = 9
	and	p.nr_seq_classif = 14
	and	p.nr_seq_grupo_des = nr_seq_grupo_desenv_p
	and	p.nr_seq_estagio in (13, 17);

	select	coalesce(sum(coalesce(proj_obter_qt_total_horas_cron(p.nr_sequencia, 0, 'S', 'E'), 0)), 0)
	into STRICT	qt_horas_desenvolver_w
	from	proj_projeto p
	where	p.nr_seq_gerencia = 9
	and	p.nr_seq_classif = 14
	and	p.nr_seq_grupo_des = nr_seq_grupo_desenv_p
	and	p.nr_seq_estagio in (1, 2, 12);

	delete
	from	w_previsao_proj_desenv
	where	nr_seq_grupo_des = nr_seq_grupo_desenv_p
	and	dt_referencia > dt_referencia_p
	and	nr_seq_hist_prev = nr_seq_hist_prev_w;

	dt_referencia_w		:= pkg_date_utils.start_of(dt_referencia_p,'DD',0);
	qt_horas_real_prev_w	:= qt_horas_realizadas_w;

	while(qt_horas_desenvolver_w > 0) and (nr_controle_loop_w < 100) loop
		begin
		dt_referencia_fim_mes_w		:= PKG_DATE_UTILS.GET_DATETIME(PKG_DATE_UTILS.END_OF(dt_referencia_w, 'MONTH'), coalesce(dt_referencia_w, PKG_DATE_UTILS.GET_TIME('00:00:00')));
		qt_dias_uteis_mes_w		:= obter_dias_uteis_periodo(dt_referencia_w, dt_referencia_fim_mes_w, cd_estabelecimento_p);
		qt_horas_uteis_mes_w		:= qt_dias_uteis_mes_w * 8;
		qt_horas_possiveis_mes_w	:= qt_colaboradores_p * qt_horas_colaborador_p * qt_dias_uteis_mes_w;
		qt_horas_real_prev_w		:= qt_horas_real_prev_w + qt_horas_possiveis_mes_w;
		pr_previsto_w			:= dividir(qt_horas_real_prev_w * 100, qt_horas_previstas_w);

		if (qt_horas_desenvolver_w < qt_horas_possiveis_mes_w) then
			begin
			dt_referencia_fim_mes_w	:= pkg_date_utils.start_of(dt_referencia_w + dividir(dividir(qt_horas_desenvolver_w, 24), qt_colaboradores_p),'DD',0);
			qt_horas_real_prev_w	:= qt_horas_real_prev_w - qt_horas_possiveis_mes_w;
			qt_horas_real_prev_w	:= qt_horas_real_prev_w + qt_horas_desenvolver_w;
			pr_previsto_w		:= dividir((qt_horas_real_prev_w + qt_horas_sobra_w) * 100, qt_horas_previstas_w);
			end;
		elsif (pr_previsto_w > 100) then
			begin
			pr_previsto_w		:= dividir((qt_horas_real_prev_w + qt_horas_sobra_w) * 100, qt_horas_previstas_w);
			end;
		end if;

		select	nextval('w_previsao_proj_desenv_seq')
		into STRICT	nr_seq_previsao_w
		;

		insert into w_previsao_proj_desenv(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_gerencia,
			nr_seq_grupo_des,
			dt_referencia,
			qt_horas_previstas,
			qt_horas_realizadas,
			qt_horas_desenvolver,
			qt_dias_uteis,
			qt_horas_uteis,
			qt_colaboradores,
			qt_horas_colaborador,
			qt_horas_possiveis,
			qt_horas_real_prev,
			qt_percentual_previsto,
			qt_horas_saldo,
			dt_previsao,
			nm_usuario_previsao,
			nr_seq_hist_prev)
		values (
			nr_seq_previsao_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			9,
			nr_seq_grupo_desenv_p,
			dt_referencia_fim_mes_w,
			qt_horas_previstas_w,
			qt_horas_realizadas_w,
			qt_horas_desenvolver_w,
			qt_dias_uteis_mes_w,
			qt_horas_uteis_mes_w,
			qt_colaboradores_p,
			qt_horas_colaborador_p,
			qt_horas_possiveis_mes_w,
			qt_horas_real_prev_w,
			pr_previsto_w,
			qt_horas_sobra_w,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_hist_prev_w);

		qt_horas_desenvolver_w	:= qt_horas_desenvolver_w - qt_horas_possiveis_mes_w;
		dt_referencia_w		:= PKG_DATE_UTILS.start_of(PKG_DATE_UTILS.ADD_MONTH(dt_referencia_w, 1,0), 'MONTH', 0);
		nr_controle_loop_w	:= nr_controle_loop_w + 1;
		end;
	end loop;
	end;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_previsao_migracao ( cd_estabelecimento_p bigint, nr_seq_grupo_desenv_p bigint, dt_referencia_p timestamp, qt_colaboradores_p bigint, qt_horas_colaborador_p bigint, ie_previsao_futura_p text, nr_seq_prev_combinar_p bigint, nm_usuario_p text) FROM PUBLIC;

