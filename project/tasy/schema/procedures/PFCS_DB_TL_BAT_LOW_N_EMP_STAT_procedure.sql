-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pfcs_db_tl_bat_low_n_emp_stat ( nr_seq_indicator_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


pfcs_panel_detail_seq_w		pfcs_panel_detail.nr_sequencia%type;
nr_seq_panel_w				pfcs_panel_detail.nr_seq_panel%type;

c01 CURSOR FOR
  SELECT ds_unit,
		 sum(qt_low_battery_status) low_battery_status,
		 sum(qt_empty_battery_status) empty_battery_status
	from(
		SELECT 	sa.ds_setor_atendimento ds_unit,
			count(ppf.nr_sequencia) qt_low_battery_status,
			0 qt_empty_battery_status
			from pfcs_service_request sr,
				pfcs_patient_flag ppf,
				pfcs_encounter enc,
				pfcs_patient pat,
				pfcs_encounter_location el,
				pfcs_device pd,
				unidade_atendimento uni,
				setor_atendimento sa
			where ((upper(sr.si_status) = 'COMPLETED' and upper(sr.cd_service) = 'E0404')
				 or (upper(sr.si_status) = 'ACTIVE' and upper(sr.cd_service) = 'E0403'))
			and ppf.nr_seq_patient = pat.nr_sequencia
			and ppf.si_status = 'ACTIVE'
			and sr.nr_seq_encounter = enc.nr_sequencia
			and el.nr_seq_encounter = enc.nr_sequencia
			and ppf.cd_flag = 'D0401'
			and pat.nr_sequencia = pd.nr_seq_patient
			and pd.si_status = 'ACTIVE'
			and pd.ds_device_type = 'Monitor'
			and enc.nr_seq_patient = pat.nr_sequencia
			and coalesce(ppf.period_end::text, '') = ''			
			and uni.nr_seq_location = el.nr_seq_location
			and uni.ie_situacao = 'A'
			and uni.cd_setor_atendimento = sa.cd_setor_atendimento
			and sa.ie_situacao = 'A'
			and sa.cd_estabelecimento_base = cd_estabelecimento_p			
			group by sa.ds_setor_atendimento, 0
		
union

			select sa.ds_setor_atendimento ds_unit,
			0 qt_low_battery_status,
			count(ppf.nr_sequencia) qt_empty_battery_status
			from pfcs_service_request sr,
				pfcs_patient_flag ppf,
				pfcs_encounter enc,
				pfcs_patient pat,
				pfcs_encounter_location el,
				pfcs_device pd,
				unidade_atendimento uni,
				setor_atendimento sa
			where ((upper(sr.si_status) = 'COMPLETED' and upper(sr.cd_service) = 'E0404') 
				or (upper(sr.si_status) = 'ACTIVE' and upper(sr.cd_service) = 'E0403'))
			and ppf.nr_seq_patient = pat.nr_sequencia
			and ppf.si_status = 'ACTIVE'
			and sr.nr_seq_encounter = enc.nr_sequencia
			and el.nr_seq_encounter = enc.nr_sequencia
			and ppf.cd_flag = 'D0402'
			and pat.nr_sequencia = pd.nr_seq_patient
			and pd.si_status = 'ACTIVE'
			and pd.ds_device_type = 'Monitor'
			and enc.nr_seq_patient = pat.nr_sequencia
			and coalesce(ppf.period_end::text, '') = ''
			and uni.nr_seq_location = el.nr_seq_location
			and uni.ie_situacao = 'A'
			and uni.cd_setor_atendimento = sa.cd_setor_atendimento
			and sa.ie_situacao = 'A'
			and sa.cd_estabelecimento_base = cd_estabelecimento_p			
			group by sa.ds_setor_atendimento, 0)
		group by ds_unit;

BEGIN

for r_c01 in c01 loop

	select 	nextval('pfcs_panel_detail_seq') into STRICT 	pfcs_panel_detail_seq_w;

      := pfcs_pck_v2.pfcs_generate_results(
        vl_indicator_p => r_c01.low_battery_status, vl_indicator_aux_p => r_c01.empty_battery_status, ds_reference_value_p => r_c01.ds_unit, nr_seq_indicator_p => nr_seq_indicator_p, nr_seq_operational_level_p => cd_estabelecimento_p, nm_usuario_p => nm_usuario_p, nr_seq_panel_p => nr_seq_panel_w);

end loop;

commit;

CALL pfcs_pck_v2.pfcs_activate_records(
		nr_seq_indicator_p => nr_seq_indicator_p,
		nr_seq_operational_level_p => cd_estabelecimento_p,
		nm_usuario_p => nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_db_tl_bat_low_n_emp_stat ( nr_seq_indicator_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

