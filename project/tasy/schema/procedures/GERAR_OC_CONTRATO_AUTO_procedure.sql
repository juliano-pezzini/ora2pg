-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_oc_contrato_auto (nm_usuario_p text) AS $body$
DECLARE



cd_estabelecimento_w			regra_geracao_oc_contrato.cd_estabelecimento%type;
nr_seq_tipo_contrato_w			regra_geracao_oc_contrato.nr_seq_tipo_contrato%type;
nr_seq_subtipo_contrato_w		regra_geracao_oc_contrato.nr_seq_subtipo_contrato%type;
ie_adicionar_aditivos_w			regra_geracao_oc_contrato.ie_adicionar_aditivos%type;
dt_dia_geracao_w				regra_geracao_oc_contrato.dt_dia_geracao%type;
ie_frete_w				        regra_geracao_oc_contrato.ie_frete%type;
cd_local_entrega_w			    regra_geracao_oc_contrato.cd_local_entrega%type;
qt_dias_entrega_w				regra_geracao_oc_contrato.qt_dias_entrega%type;
nr_seq_contrato_w				contrato.nr_sequencia%type;
cd_comprador_w				    contrato.cd_comprador%type;
cd_pessoa_resp_w				contrato.cd_pessoa_resp%type;
cd_cgc_contratado_w			    contrato.cd_cgc_contratado%type;
cd_pessoa_contratada_w			contrato.cd_pessoa_contratada%type;
dt_entrega_w				    ordem_compra.dt_entrega%type;
cd_moeda_padrao_w			    parametro_compras.cd_moeda_padrao%type;
nr_ordem_compra_w			    ordem_compra.nr_ordem_compra%type;
ie_liberados_w				    regra_geracao_oc_contrato.ie_liberados%type;
ie_liberar_oc_w                 parametro_compras.ie_aprovar_oc_contrato%type;

c01 CURSOR FOR
SELECT	cd_estabelecimento,
	coalesce(nr_seq_tipo_contrato,0),
	coalesce(nr_seq_subtipo_contrato,0),
	ie_adicionar_aditivos,
	dt_dia_geracao,
	ie_frete,
	cd_local_entrega,
	qt_dias_entrega,
	coalesce(ie_liberados,'N')
from	regra_geracao_oc_contrato
where	ie_situacao = 'A';

c02 CURSOR FOR
SELECT	a.nr_sequencia,
	a.cd_comprador,
	a.cd_pessoa_resp,
	a.cd_cgc_contratado,
	a.cd_pessoa_contratada	
from	contrato a
where	a.ie_situacao = 'A'
and	a.cd_estabelecimento = cd_estabelecimento_w
and	a.ie_pagar_receber = 'P'
and	((coalesce(a.dt_fim::text, '') = '') or (trunc(a.dt_fim,'dd') > trunc(clock_timestamp(),'dd')))
and	(a.cd_comprador IS NOT NULL AND a.cd_comprador::text <> '')
and	(a.cd_condicao_pagamento IS NOT NULL AND a.cd_condicao_pagamento::text <> '')
and	(a.cd_pessoa_resp IS NOT NULL AND a.cd_pessoa_resp::text <> '')
and	coalesce(a.ie_finalizado,'N') = 'N'
and	((ie_adicionar_aditivos_w = 'N' AND a.ie_classificacao = 'AT') or
	((ie_adicionar_aditivos_w = 'S') and (a.ie_classificacao in ('AT','AD'))))
and	((nr_seq_tipo_contrato_w = 0) or (a.nr_seq_tipo_contrato  = nr_seq_tipo_contrato_w))
and	((nr_seq_subtipo_contrato_w = 0) or (a.nr_seq_subtipo_contrato  = nr_seq_subtipo_contrato_w))
and exists(
	SELECT	1
	from	contrato_regra_nf b
	where	a.nr_sequencia = b.nr_seq_contrato
	and	coalesce(b.ie_tipo_regra,'NF') = 'NF'
	and	((coalesce(b.dt_inicio_vigencia::text, '') = '') or (trunc(b.dt_inicio_vigencia,'dd') <= trunc(clock_timestamp(),'dd')))
	and	((coalesce(b.dt_fim_vigencia::text, '') = '') or (trunc(b.dt_fim_vigencia,'dd') >= trunc(clock_timestamp(),'dd')))
    and (coalesce(b.ie_situacao::text, '') = '' or b.ie_situacao = 'A')
	and	((coalesce(b.cd_estab_regra::text, '') = '') or (b.cd_estab_regra = cd_estabelecimento_w) or (exists (	select 1
													from	contrato_regra_nf_estab x
													where	x.cd_estab_regra = cd_estabelecimento_w
													and	x.nr_seq_regra_nf = b.nr_sequencia))))
and	((ie_liberados_w = 'N') or
	(ie_liberados_w = 'S' AND a.dt_aprovacao IS NOT NULL AND a.dt_aprovacao::text <> ''));


BEGIN


open C01;
loop
fetch C01 into	
	cd_estabelecimento_w,
	nr_seq_tipo_contrato_w,
	nr_seq_subtipo_contrato_w,
	ie_adicionar_aditivos_w,
	dt_dia_geracao_w,
	ie_frete_w,
	cd_local_entrega_w,
	qt_dias_entrega_w,
	ie_liberados_w;	
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	

	select	cd_moeda_padrao
	into STRICT	cd_moeda_padrao_w
	from	parametro_compras
	where	cd_estabelecimento = cd_estabelecimento_w;
	
	if (cd_moeda_padrao_w > 0) and ((dt_dia_geracao_w)::numeric  = (to_char(clock_timestamp(),'dd'))::numeric ) then
		
		select	obter_dia_util_periodo(cd_estabelecimento_w, clock_timestamp(), qt_dias_entrega_w)
		into STRICT	dt_entrega_w
		;

		open C02;
		loop
		fetch C02 into	
			nr_seq_contrato_w,
			cd_comprador_w,
			cd_pessoa_resp_w,
			cd_cgc_contratado_w,
			cd_pessoa_contratada_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin						


			begin
			nr_ordem_compra_w := gerar_oc_contrato(
				cd_comprador_w, clock_timestamp(), clock_timestamp(), dt_entrega_w, nr_seq_contrato_w, cd_estabelecimento_w, null, cd_pessoa_resp_w, cd_pessoa_contratada_w, cd_cgc_contratado_w, ie_frete_w, cd_moeda_padrao_w, 'N', 'N', 'N', nm_usuario_p, cd_local_entrega_w, 'S', 0, null, nr_ordem_compra_w);
			

            select	coalesce(max(ie_aprovar_oc_contrato),'N')
            into STRICT	ie_liberar_oc_w
            from	parametro_compras
            where	cd_estabelecimento = cd_estabelecimento_w;

            if (ie_liberar_oc_w = 'S') then
			CALL gerar_aprov_ordem_compra(	nr_ordem_compra_w,
							null,
							'S',
							nm_usuario_p );
            end if;

			exception
			when others then
				nr_ordem_compra_w := nr_ordem_compra_w;
			end;
			
			
			end;
		end loop;
		close C02;
	end if;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_oc_contrato_auto (nm_usuario_p text) FROM PUBLIC;

