-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_relatorio_entrega_laudo ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_rel_p INOUT bigint) AS $body$
DECLARE

				 
nr_seq_rel_layout_w bigint := 0;
cd_estabelecimento_w bigint := obter_estabelecimento_ativo;	
cd_perfil_w     bigint	:= obter_perfil_ativo;
cd_funcao_w     bigint := obter_funcao_ativa;
nm_usuario_w     usuario.nm_usuario%TYPE := obter_usuario_ativo;
		
 
C01 CURSOR FOR				 
	SELECT	coalesce(b.nr_seq_apresent, 0) nr_seq_apresent, 
		b.nr_sequencia, 
		c.cd_classif_relat, 
		c.cd_relatorio, 
		c.cd_relatorio_wheb, 
		b.qt_copia, 
		b.ie_logo, 
		CASE WHEN A.Ie_Imprimir='A' THEN 'S' WHEN A.Ie_Imprimir='B' THEN 'N'  ELSE CASE WHEN a.ie_liberado_cliente='N' THEN 'N'  ELSE b.ie_imprimir END  END  Ie_Imprimir, 
		b.ie_configurar, 
		b.ie_outputbin, 
		c.ds_titulo, 
		c.ie_etiqueta, 
		c.nr_sequencia nr_seq_relatorio, 
		a.nr_seq_relatorio nr_seq_relatorio_funcao, 
		a.cd_funcao, 
		c.ds_sql, 
		'                                        ' ds_arquivo, 
		b.ds_impressora, 
		'S' ie_destruir, 
		0 nr_seq_regra, 
		b.ie_gravar_log, 
		b.ie_visualizar, 
		b.ie_forma_impressao, 
		c.cd_classif_relat_wheb, 
		'S' ie_botao_imprimir, 
		b.ie_apres_mensagem, 
		coalesce(ie_frente_verso,'N') ie_frente_verso, 
		coalesce(ie_visualiza_qrprinter,'N') ie_visualiza_qrprinter, 
		b.ie_impressora_setor 
	FROM	Relatorio c, 
		relatorio_perfil b, 
		relatorio_funcao a 
	WHERE	b.nr_seq_relatorio = c.nr_sequencia 
	AND	a.nr_seq_relatorio = c.nr_sequencia 
	AND	a.cd_funcao = cd_funcao_w                   
	AND	b.cd_perfil = cd_perfil_w 
	AND	coalesce(b.cd_estab, cd_estabelecimento_w) = cd_estabelecimento_w 
	
UNION
 
	SELECT	0, 
		0, 
		c.cd_classif_relat, 
		c.cd_relatorio, 
		c.cd_relatorio_wheb, 
		a.qt_copia, 
		a.ie_logo, 
		CASE WHEN a.ie_liberado_cliente='N' THEN 'N'  ELSE a.ie_imprimir END  ie_imprimir, 
		CASE WHEN u.ie_configurar='S' THEN 'S'  ELSE a.ie_configurar END  ie_configurar, 
		0 ie_outputbin, 
		c.ds_titulo, 
		c.ie_etiqueta, 
		c.nr_sequencia nr_seq_relatorio, 
		a.nr_seq_relatorio, 
		a.cd_funcao, 
		c.ds_sql, 
		'                                        ' ds_arquivo, 
		'' ds_impressora, 
		'S' ie_destruir, 
		0 nr_seq_regra, 
		'N' ie_gravar_log, 
		'N' ie_visualizar, 
		'' ie_forma_impressao, 
		c.cd_classif_relat_wheb, 
		'S' ie_botao_imprimir, 
		'N' ie_apres_mensagem, 
		'N' ie_frente_verso, 
		'N' ie_visualiza_qrprinter, 
		'N' ie_impressora_setor 
	FROM	Relatorio c, 
		usuario_relatorio u, 
		relatorio_funcao a 
	WHERE	a.nr_seq_relatorio = c.nr_sequencia 
	AND	u.nr_seq_relatorio = c.nr_sequencia 
	AND	a.ie_exige_perfil = 'S' 
	AND	a.cd_funcao = cd_funcao_w 
	AND	u.nm_usuario_ref = nm_usuario_w 
	AND (cd_funcao_w <> 87 OR NOT EXISTS (SELECT	1 
						FROM	relatorio y 
						WHERE	y.cd_relatorio_wheb = c.cd_relatorio)) 
	
UNION
 
	SELECT	0, 
		0, 
		c.cd_classif_relat, 
		c.cd_relatorio, 
		c.cd_relatorio_wheb, 
		a.qt_copia, 
		a.ie_logo, 
		CASE WHEN a.ie_liberado_cliente='N' THEN 'N'  ELSE a.ie_imprimir END  ie_imprimir, 
		a.ie_configurar, 
		0 ie_outputbin, 
		c.ds_titulo, 
		c.ie_etiqueta, 
		c.nr_sequencia nr_seq_relatorio, 
		a.nr_seq_relatorio, 
		a.cd_funcao, 
		c.ds_sql, 
		'                                        ' ds_arquivo, 
		'' ds_impressora, 
		'S' ie_destruir, 
		0 nr_seq_regra, 
	  'N' ie_gravar_log, 
	  'N' ie_visualizar, 
	  '' ie_forma_impressao, 
	  c.cd_classif_relat_wheb, 
	  'S' ie_botao_imprimir, 
	  'N' ie_apres_mensagem, 
	  'N' ie_frente_verso, 
	  'N' ie_visualiza_qrprinter, 
	  'N' ie_impressora_setor 
	FROM	Relatorio c, 
		relatorio_funcao a 
	WHERE	a.nr_seq_relatorio = c.nr_sequencia 
	AND	a.cd_funcao    = cd_funcao_w 
	AND	a.ie_exige_perfil = 'N' 
	AND NOT EXISTS (SELECT	1 
		FROM	relatorio_perfil b 
		WHERE	b.nr_seq_relatorio = c.nr_sequencia 
		AND	b.cd_perfil = cd_perfil_w 
			AND     coalesce(b.cd_estab, cd_estabelecimento_w) = cd_estabelecimento_w) 
	AND (cd_funcao_w <> 87 OR NOT EXISTS (SELECT	1 
						FROM	relatorio y 
						WHERE	y.cd_relatorio_wheb = c.cd_relatorio)) 
	
UNION
 
	SELECT	0, 
		0, 
		c.cd_classif_relat, 
		c.cd_relatorio, 
		c.cd_relatorio_wheb, 
		a.qt_copia, 
		a.ie_logo, 
		a.ie_imprimir, 
		a.ie_configurar, 
		0 ie_outputbin, 
		c.ds_titulo, 
		c.ie_etiqueta, 
		coalesce(a.nr_seq_relatorio_cate,c.nr_sequencia) nr_seq_relatorio, 
		coalesce(a.nr_seq_relatorio_cate,a.nr_seq_relatorio) nr_seq_relatorio, 
		a.cd_funcao, 
		c.ds_sql, 
		'                                        ' ds_arquivo, 
		'' ds_impressora, 
		'S' ie_destruir, 
		0 nr_seq_regra, 
	  'N' ie_gravar_log, 
	  'N' ie_visualizar, 
	  '' ie_forma_impressao, 
	  c.cd_classif_relat_wheb, 
	  'S' ie_botao_imprimir, 
	  'N' ie_apres_mensagem, 
	  'N' ie_frente_verso, 
	  'N' ie_visualiza_qrprinter, 
	  'N' ie_impressora_setor 
	FROM	Relatorio c, 
		onc_relatorio_funcao a 
	WHERE	coalesce(a.nr_seq_relatorio_cate,a.nr_seq_relatorio) = c.nr_sequencia 
	AND	a.cd_funcao = cd_funcao_w 
	ORDER BY 
		1, 
		ds_titulo;
c01_w	C01%ROWTYPE;


BEGIN 
 
select obter_seq_rel_laudo(nr_prescricao_p, nr_seq_prescr_p) into STRICT nr_seq_rel_layout_w;
 
OPEN C01;
LOOP 
FETCH C01 INTO c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	BEGIN 
	 
	IF (c01_w.ie_imprimir = 'S') AND 
	  ((nr_seq_rel_layout_w = c01_w.nr_seq_relatorio) or (nr_seq_rel_layout_w = 0)) THEN 
		nr_seq_rel_p := c01_w.nr_seq_relatorio;
	END IF;
	END;
END LOOP;
CLOSE C01;
 
 
IF (nr_seq_rel_layout_w>0) AND (nr_seq_rel_p = 0) THEN 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(316382,'NR_SEQ_REL='||nr_seq_rel_layout_w);
END IF;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_relatorio_entrega_laudo ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_rel_p INOUT bigint) FROM PUBLIC;

