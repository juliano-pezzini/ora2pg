-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calc_juros_baixa_proporcional ( nr_titulo_p bigint, nr_seq_baixa_p bigint, vl_juros_p INOUT bigint) AS $body$
DECLARE


ie_apropriar_juros_multa_w	titulo_receber_liq.ie_apropriar_juros_multa%type;
vl_recebido_w			titulo_receber_liq.vl_recebido%type;
vl_titulo_w			titulo_receber.vl_saldo_titulo%type;
vl_juros_calc_proporcional_w	double precision;
vl_juros_total_w		double precision;
vl_juros_cobrados_w		double precision;
vl_apropriado_juros_w		double precision;


BEGIN
/*Somente calcular se tiver titulo e sequencia de baixa*/

if (coalesce(nr_titulo_p,0) <> 0) and (coalesce(nr_seq_baixa_p,0) <> 0) then

	select	coalesce(max(a.ie_apropriar_juros_multa),'N'),
		coalesce(max(a.vl_recebido),0),
		max(b.vl_titulo)
	into STRICT	ie_apropriar_juros_multa_w,
		vl_recebido_w,
		vl_titulo_w
	from	titulo_receber_liq a,
		titulo_receber b
	where	a.nr_titulo	= b.nr_titulo
	and	a.nr_titulo	= nr_titulo_p
	and	a.nr_sequencia	= nr_seq_baixa_p;

	/*Se estiver como Sim, significa que o usuario selecionou Sim na hora da baixa e deve calcular proporcional! Somente para baixas com valor recebido, se for desconto nao calcular*/

	if (coalesce(ie_apropriar_juros_multa_w,'N') = 'S') and (vl_recebido_w <> 0) then

		select	coalesce(sum(vl_juros),0)
		into STRICT	vl_juros_cobrados_w
		from	titulo_receber_liq
		where	nr_titulo = nr_titulo_p;

		vl_juros_total_w := obter_valor_juros_tit_integral(nr_titulo_p,nr_seq_baixa_p);

		select	coalesce(sum(a.vl_item), 0)
		into STRICT	vl_apropriado_juros_w
		from	pls_segurado_mensalidade a
		where	a.nr_titulo		= nr_titulo_p
		and	a.ie_tipo_item		= 23
		and	a.ie_situacao		= 'A';

		/*Aqui faz  o calculo proporcional de juros referente ao valor baixado*/

		vl_juros_calc_proporcional_w	:= vl_recebido_w * (vl_juros_total_w/vl_titulo_w);

		if	((vl_apropriado_juros_w+vl_juros_cobrados_w+vl_juros_calc_proporcional_w) > vl_juros_total_w) then
			if	((vl_apropriado_juros_w+vl_juros_cobrados_w) < vl_juros_total_w) then
				vl_juros_calc_proporcional_w := vl_juros_total_w - (vl_apropriado_juros_w+vl_juros_cobrados_w);
			else
				vl_juros_calc_proporcional_w := 0;
			end if;
		elsif	((vl_apropriado_juros_w+vl_juros_cobrados_w) = vl_juros_total_w) then
			vl_juros_calc_proporcional_w := 0;
		end if;
	end if;
end if;

vl_juros_p	:= coalesce(vl_juros_calc_proporcional_w,0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calc_juros_baixa_proporcional ( nr_titulo_p bigint, nr_seq_baixa_p bigint, vl_juros_p INOUT bigint) FROM PUBLIC;

