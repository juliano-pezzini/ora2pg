-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_eme_atendimento ( nr_chamado_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_atendimento_w		bigint;
cd_pessoa_fisica_w		varchar(10);
cd_estabelecimento_w		smallint;
cd_medico_resp_w		varchar(10);
dt_inicio_atendimento_w		timestamp;
ds_queixa_paciente_w		varchar(255);
nr_categoria_convenio_w		bigint;
nr_paciente_unidade_w		bigint;
nr_seq_atepacu_w		bigint;
nr_seq_contrato_w		bigint;
cd_convenio_w			integer;
cd_categoria_w			varchar(10);
nr_seq_veiculo_w		bigint;
cd_setor_atendimento_w		integer;
cd_unidade_basica_w		varchar(10);
cd_unidade_compl_w		varchar(10);
cd_usuario_convenio_w		varchar(30);
cd_tipo_acomod_unidade_w	smallint;
cd_procedencia_w		integer;
dt_chamado_w			timestamp;
nr_seq_interno_w		bigint;

/*ParÃ¢metros*/

var_atend_data_chamado_w	varchar(1);


BEGIN

var_atend_data_chamado_w	:= coalesce(Obter_valor_param_usuario(929, 29, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento),'N');

select	cd_pessoa_fisica,
	cd_estabelecimento,
	coalesce(cd_medico_regulador,cd_medico_resp),
	dt_inicio_atend,
	ds_queixa_paciente,
	nr_seq_contrato,
	nr_seq_veiculo,
	cd_procedencia,
	dt_chamado
into STRICT	cd_pessoa_fisica_w,
	cd_estabelecimento_w,
	cd_medico_resp_w,
	dt_inicio_atendimento_w,
	ds_queixa_paciente_w,
	nr_seq_contrato_w,
	nr_seq_veiculo_w,
	cd_procedencia_w,
	dt_chamado_w
from	eme_chamado
where	nr_sequencia	= nr_chamado_p;

select	max(a.cd_convenio),
	max(a.cd_categoria)
into STRICT	cd_convenio_w,
	cd_categoria_w
from	eme_chamado a
where	a.nr_sequencia = nr_chamado_p;

if 	((coalesce(cd_convenio_w::text, '') = '') or (coalesce(cd_categoria_w::text, '') = '')) then
	select	max(a.cd_convenio),
		max(a.cd_categoria)
	into STRICT	cd_convenio_w,
		cd_categoria_w
	from	eme_contrato a,
		eme_chamado b
	where	a.nr_sequencia = b.nr_seq_contrato
	and	b.nr_sequencia = nr_chamado_p;
end if;

select	max(cd_setor_atendimento)
into STRICT	cd_setor_atendimento_w
from	eme_veiculo
where	nr_sequencia = nr_seq_veiculo_w;

select	max(nr_seq_interno)
into STRICT	nr_seq_interno_w
from	unidade_atend_livre_v
where	cd_setor_atendimento = cd_setor_atendimento_w;

if (coalesce(nr_seq_interno_w,0) > 0) then
	select	max(cd_unidade_basica),
		max(cd_unidade_compl)
	into STRICT	cd_unidade_basica_w,
		cd_unidade_compl_w
	from	unidade_atend_livre_v
	where	cd_setor_atendimento	= cd_setor_atendimento_w
	and	nr_seq_interno		= nr_seq_interno_w;
end if;

if((coalesce(cd_unidade_basica_w::text, '') = '') or (coalesce(cd_unidade_compl_w::text, '') = ''))then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(285057);
end if;

select	max(cd_tipo_acomodacao)
into STRICT	cd_tipo_acomod_unidade_w
from	unidade_atendimento
where	cd_setor_atendimento	= cd_setor_atendimento_w
and	cd_unidade_basica	= cd_unidade_basica_w
and	cd_unidade_compl	= cd_unidade_compl_w;

select	coalesce(max(cd_codigo_convenio),0)
into STRICT	cd_usuario_convenio_w
from	eme_pf_contrato
where	nr_seq_contrato	= nr_seq_contrato_w
and	cd_pessoa_fisica = cd_pessoa_fisica_w;

select	nextval('atendimento_paciente_seq')
into STRICT	nr_atendimento_w
;

select	nextval('atend_categoria_convenio_seq')
into STRICT	nr_categoria_convenio_w
;

select	nextval('atend_paciente_unidade_seq')
into STRICT	nr_paciente_unidade_w
;

select	coalesce(max(nr_sequencia),0) + 1
into STRICT	nr_seq_atepacu_w
from	atend_paciente_unidade
where	nr_atendimento		= nr_atendimento_w;

insert	into atendimento_paciente(
	nr_atendimento,
	cd_pessoa_fisica,
	cd_estabelecimento,
	cd_procedencia,
	dt_entrada,
	nm_usuario,
	dt_atualizacao,
	ie_permite_visita,
	ie_tipo_atendimento,
	cd_medico_resp,
	dt_inicio_atendimento,
	ds_sintoma_paciente,
	ie_responsavel)
values (nr_atendimento_w,
	cd_pessoa_fisica_w,
	cd_estabelecimento_w,
	cd_procedencia_w,
	CASE WHEN var_atend_data_chamado_w='S' THEN coalesce(dt_chamado_w,clock_timestamp())  ELSE clock_timestamp() END ,
	nm_usuario_p,
	clock_timestamp(),
	'S',
	7,
	cd_medico_resp_w,
	dt_inicio_atendimento_w,
	ds_queixa_paciente_w,
	3);


insert	into atend_categoria_convenio(
	nr_seq_interno,
	nr_atendimento,
	cd_convenio,
	cd_categoria,
	cd_usuario_convenio,
	dt_inicio_vigencia,
	dt_atualizacao,
	nm_usuario,
	ie_tipo_guia)
values (nr_categoria_convenio_w,
	nr_atendimento_w,
	cd_convenio_w,
	cd_categoria_w,
	cd_usuario_convenio_w,
	clock_timestamp(),
	clock_timestamp(),
	nm_usuario_p,
	'A');


insert	into atend_paciente_unidade(
	nr_seq_interno,
	nr_atendimento,
	nr_sequencia,
	cd_setor_atendimento,
	cd_tipo_acomodacao,
	cd_unidade_basica,
	cd_unidade_compl,
	dt_entrada_unidade,
	dt_atualizacao,
	nm_usuario,
	nm_usuario_original,
	dt_saida_interno,
	IE_CALCULAR_DIF_DIARIA)
values (nr_paciente_unidade_w,
	nr_atendimento_w,
	nr_seq_atepacu_w,
	cd_setor_atendimento_w,
	cd_tipo_acomod_unidade_w,
	cd_unidade_basica_w,
	cd_unidade_compl_w,
	CASE WHEN var_atend_data_chamado_w='S' THEN coalesce(dt_chamado_w,clock_timestamp())  ELSE clock_timestamp() END ,
	clock_timestamp(),
	nm_usuario_p,
	nm_usuario_p,
	CASE WHEN var_atend_data_chamado_w='S' THEN coalesce(dt_chamado_w,clock_timestamp())  ELSE clock_timestamp() END ,
	'S');


update	eme_chamado
set	nr_atendimento = nr_atendimento_w
where	nr_sequencia 	 = nr_chamado_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_eme_atendimento ( nr_chamado_p bigint, nm_usuario_p text) FROM PUBLIC;

