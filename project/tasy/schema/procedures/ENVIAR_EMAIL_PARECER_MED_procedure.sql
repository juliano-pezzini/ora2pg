-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_email_parecer_med (nr_parecer_p bigint, ie_tipo_p bigint, cd_estabelecimento_p bigint, nr_seq_parecer_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_especialidade_dest_prof_w	integer;
cd_especialidade_dest_w		integer;
cd_medico_parecer_w		bigint;
ds_pos_inicio_rtf_w		bigint;
nr_atendimento_w		bigint;
nr_seq_equipe_w			bigint;
nr_seq_resultado_w		bigint;
nr_seq_rtf_w			bigint;
nr_sequencia_w			bigint;
cd_pessoa_fisica_w		varchar(10);
ds_email_destino_w		varchar(32000);
ds_especialidade_dest_w		varchar(255);
ds_especialidade_origem_w	varchar(255);
ds_leito_w			varchar(255);
ds_motivo_consulta_w		varchar(32000);
ds_parecer_w 			varchar(32000) := '';
ds_parecer_ww			varchar(32000) := '';
ds_seq_equipe_w			varchar(255);
ds_setor_w			varchar(255);
ie_equipe_w			varchar(10);
nm_destino_w			varchar(32000) := '';
nm_medico_consultor_w		varchar(100);
nm_medico_w			varchar(100) := 0;
nm_origem_w			varchar(32000);
nm_paciente_w			varchar(300);
nm_usuario_cad_w		varchar(15) := '';
nm_usuario_w			varchar(15);

c01 CURSOR FOR
	SELECT	substr(obter_usuario_pf(e.cd_pessoa_fisica),1,100)
	from	medico_especialidade e,
        medico m
	where	e.cd_pessoa_fisica = m.cd_pessoa_fisica
  and obter_se_corpo_clinico(e.cd_pessoa_fisica) = 'S'
  and	    coalesce(m.ie_situacao,'A')  = 'A'
	and	e.cd_especialidade = cd_especialidade_dest_w
	and	substr(obter_usuario_pf(e.cd_pessoa_fisica),1,100) is not null
	and	coalesce(cd_medico_parecer_w::text, '') = ''
	and	coalesce(cd_especialidade_dest_prof_w,0) = 0
	
union

	SELECT	substr(obter_usuario_pf(cd_pessoa_fisica),1,100)
	from	profissional_especialidade
	where	cd_especialidade_prof = cd_especialidade_dest_prof_w
	and	substr(obter_usuario_pf(cd_pessoa_fisica),1,100) is not null
	and	coalesce(cd_medico_parecer_w::text, '') = ''
	and	coalesce(cd_especialidade_dest_w,0) = 0
	
union

	select	substr(obter_usuario_pf(cd_medico_parecer_w),1,100)
	
	where	(cd_medico_parecer_w IS NOT NULL AND cd_medico_parecer_w::text <> '')
	
union

	select  substr(obter_usuario_pf(b.cd_pessoa_fisica),1,100)
	from	pf_equipe_partic b,
		pf_equipe a
	where	a.nr_sequencia = b.nr_seq_equipe
	and	a.cd_pessoa_fisica	= cd_medico_parecer_w
	and	coalesce(a.ie_situacao,'A')  = 'A'
	and	(cd_medico_parecer_w IS NOT NULL AND cd_medico_parecer_w::text <> '')
	and	ie_equipe_w	= 'S'
	
union

	select	substr(obter_usuario_pf(b.cd_pessoa_fisica),1,100)
	from	pf_equipe_partic b,
		pf_equipe a
	where	a.nr_sequencia = b.nr_seq_equipe
	and	a.nr_sequencia	= nr_seq_equipe_w
	and	coalesce(a.ie_situacao,'A')  = 'A'
	and	(nr_seq_equipe_w IS NOT NULL AND nr_seq_equipe_w::text <> '')
	
union

	select  substr(obter_usuario_pf(a.cd_pessoa_fisica),1,100)
	from    pf_equipe a
	where	a.nr_sequencia	= nr_seq_equipe_w
	and	coalesce(a.ie_situacao,'A')  = 'A'
	and	(nr_seq_equipe_w IS NOT NULL AND nr_seq_equipe_w::text <> '')
	
union

	select	substr(obter_usuario_pf(b.cd_pessoa_fisica),1,100)
	from	espec_regra_parecer a,
		medico_especialidade b,
    medico m
	where	b.cd_pessoa_fisica = m.cd_pessoa_fisica
  and a.cd_especialidade_dest = b.cd_especialidade
    and	    coalesce(m.ie_situacao,'A')  = 'A'
	and	a.cd_especialidade = cd_especialidade_dest_w
	and	substr(obter_usuario_pf(b.cd_pessoa_fisica),1,100) is not null
	order by	1;

C02 CURSOR FOR
	SELECT	ds_email
	from	regra_email_parecer;	


BEGIN
select	coalesce(cd_especialidade_dest,0),
	coalesce(cd_especialidade_dest_prof,0),
	nr_atendimento,
	obter_nome_pf(cd_pessoa_fisica),
	cd_pessoa_parecer,
	cd_pessoa_fisica,
	nr_seq_equipe_dest,
	substr(OBTER_DESC_PF_EQUIPE(nr_seq_equipe_dest),1,150),
	SUBSTR(Obter_Unidade_Atendimento(nr_atendimento,'A','S'),1,120),
	substr(Obter_Unidade_Atendimento(nr_atendimento,'A','UB')||Obter_Unidade_Atendimento(nr_atendimento,'A','UC'),1,80),
	CASE WHEN coalesce(cd_especialidade::text, '') = '' THEN Obter_Desc_Espec_Profissional(cd_especialidade_prof)  ELSE Obter_Desc_Espec_medica(cd_especialidade) END ,
	CASE WHEN coalesce(cd_especialidade::text, '') = '' THEN obter_desc_espec_profissional(cd_especialidade_dest_prof)  ELSE obter_desc_espec_medica(cd_especialidade_dest) END
into STRICT	cd_especialidade_dest_w,
	cd_especialidade_dest_prof_w,
	nr_atendimento_w,
	nm_paciente_w,
	cd_medico_parecer_w,
	cd_pessoa_fisica_w,
	nr_seq_equipe_w,
	ds_seq_equipe_w,
	ds_setor_w,
	ds_leito_w,
	ds_especialidade_origem_w,
	ds_especialidade_dest_w
from	parecer_medico_req
where	nr_parecer = nr_parecer_p;

begin
nr_seq_rtf_w := converte_rtf_string('select ds_motivo_consulta
		     from   parecer_medico_req
		     where  nr_parecer = :nr_parecer', nr_parecer_p, nm_usuario_p, nr_seq_rtf_w);

select ds_texto
into STRICT   ds_motivo_consulta_w
from   tasy_conversao_rtf
where  nr_sequencia = nr_seq_rtf_w;
exception
when others then
	ds_motivo_consulta_w := '';
end;

if (nr_parecer_p IS NOT NULL AND nr_parecer_p::text <> '') then
	select	nextval('comunic_interna_seq')
	into STRICT	nr_sequencia_w
	;

	if (ie_tipo_p = 1) then
		select	obter_nome_medico(cd_medico,'N'),
			ds_motivo_consulta,
			substr(obter_usuario_pf(cd_medico),1,100)
		into STRICT	nm_medico_w,
			ds_parecer_w,
			nm_usuario_cad_w
		from	parecer_medico_req
		where	nr_parecer = nr_parecer_p;

		if (ds_parecer_w IS NOT NULL AND ds_parecer_w::text <> '') then
			/*ds_pos_inicio_rtf_w := instr(ds_parecer_w,'\lang')+9;
			ds_parecer_ww 	:= substr(ds_parecer_w,1,ds_pos_inicio_rtf_w) || 'fs20 ';*/
			
			if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
				ds_parecer_ww := ds_parecer_ww ||
				wheb_mensagem_pck.get_texto(345021,'NR_ATENDIMENTO_W='||nr_atendimento_w) || chr(13) || chr(10); --'Existe um pedido de parecer referente ao Atendimento: ' || nr_atendimento_w || chr(13) || chr(10);
				ds_parecer_ww := ds_parecer_ww ||
				wheb_mensagem_pck.get_texto(344884,'NM_PACIENTE='||nm_paciente_w) || chr(13) || chr(10); -- 'Paciente: ' || nm_paciente_w || chr(13) || chr(10);
			else
				ds_parecer_ww := ds_parecer_ww ||
				wheb_mensagem_pck.get_texto(344881,'NM_PACIENTE_W='||nm_paciente_w) || chr(13) || chr(10); --'Existe um pedido de parecer para o paciente: ' || nm_paciente_w || chr(13) || chr(10);
			end if;
			ds_parecer_ww := ds_parecer_ww ||wheb_mensagem_pck.get_texto(344942,'SETORW='||ds_setor_w)|| chr(13) || chr(10);  --'Setor : ' || ds_setor_w || chr(13) || chr(10);
			ds_parecer_ww := ds_parecer_ww ||wheb_mensagem_pck.get_texto(344946,'DS_LEITO_W='||ds_leito_w)|| chr(13) || chr(10);  --'Leito\Compl : ' || ds_leito_w || chr(13) || chr(10);
			ds_parecer_ww := ds_parecer_ww ||wheb_mensagem_pck.get_texto(344981,'NM_MEDICO_W='||nm_medico_w)|| chr(13) || chr(10);  --'Profissional requisitante: ' || nm_medico_w || chr(13) || chr(10);
			if (ds_especialidade_origem_w IS NOT NULL AND ds_especialidade_origem_w::text <> '') then
				ds_parecer_ww := ds_parecer_ww || wheb_mensagem_pck.get_texto(344982,'DS_ESPECIALIDADE_ORIGEM_W='||ds_especialidade_origem_w)|| chr(13) || chr(10); --'Especialidade origem: ' || ds_especialidade_origem_w || chr(13) || chr(10);
			end if;

			if (ds_especialidade_dest_w IS NOT NULL AND ds_especialidade_dest_w::text <> '') then
				ds_parecer_ww := ds_parecer_ww ||wheb_mensagem_pck.get_texto(344985,'DS_ESPECIALIDADE_DEST_W='||ds_especialidade_dest_w)|| chr(13) || chr(10);  --'Especialidade destino: ' || ds_especialidade_dest_w || chr(13) || chr(10);
			end if;

			if (ds_seq_equipe_w IS NOT NULL AND ds_seq_equipe_w::text <> '') then
				ds_parecer_ww := ds_parecer_ww || wheb_mensagem_pck.get_texto(344990,'DS_SEQ_EQUIPE_W='||ds_seq_equipe_w)|| chr(13) || chr(10); --'Equipe: ' || ds_seq_equipe_w || chr(13) || chr(10);
			end if;
			
			if (ds_motivo_consulta_w IS NOT NULL AND ds_motivo_consulta_w::text <> '') then
				--ds_parecer_ww := ds_parecer_ww || wheb_mensagem_pck.get_texto(352963,'DS_MOTIVO_CONSULTA_W='||ds_motivo_consulta_w)|| chr(13) || chr(10); -- 'Motivo consulta: ' || ds_motivo_consulta_w || chr(13) || chr(10);
				ds_parecer_ww := ds_parecer_ww || wheb_mensagem_pck.get_texto(352963)||ds_motivo_consulta_w|| chr(13) || chr(10);
			end if;
			ds_parecer_ww := ds_parecer_ww || chr(13) || chr(10) || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(344993); --'Favor verificar no PEP item Parecer Medico';
		end if;
		ie_equipe_w := obter_param_usuario(281, 733, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_equipe_w);

		open C01;
		loop
		fetch C01 into
			nm_usuario_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			select	max(ds_email)
			into STRICT	ds_email_destino_w
			from	usuario
			where	nm_usuario = nm_usuario_w;
			
			if (not coalesce(ds_email_destino_w::text, '') = '') then
				nm_destino_w := nm_destino_w || ds_email_destino_w || ',';
			end if;				
			end;
		end loop;
		close C01;

		open C02;
		loop
		fetch C02 into	
			ds_email_destino_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			nm_destino_w := nm_destino_w || ds_email_destino_w || ',';
			end;
		end loop;
		close C02;

		if (nm_destino_w IS NOT NULL AND nm_destino_w::text <> '') then
			ds_parecer_ww := substr(ds_parecer_ww,1,32000);
			CALL enviar_email(wheb_mensagem_pck.get_texto(344994),--'Pedido de Parecer',
				     ds_parecer_ww,
				     nm_origem_w,
				     nm_destino_w,
				     nm_usuario_p,
				     'B');
		end if;
	end if;

	if (ie_tipo_p = 2) then
		select	obter_nome_medico(cd_medico,'N'),
			ds_parecer,
			substr(obter_usuario_pf(cd_medico),1,100)
		into STRICT	nm_medico_w,
			ds_parecer_w,
			nm_usuario_cad_w
		from	parecer_medico
		where	nr_sequencia = nr_seq_parecer_p
		and	nr_parecer   = nr_parecer_p;

		if (ds_parecer_w IS NOT NULL AND ds_parecer_w::text <> '') then
			/*ds_pos_inicio_rtf_w 	:= instr(ds_parecer_w,'\lang')+9;
			ds_parecer_ww 		:= substr(ds_parecer_w,1,ds_pos_inicio_rtf_w) || 'fs20 ';*/
			
			if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
				ds_parecer_ww := ds_parecer_ww ||
				wheb_mensagem_pck.get_texto(345000,'NR_ATENDIMENTO_W='||nr_atendimento_w)|| chr(13) || chr(10);  --'Existe uma resposta de parecer referente ao Atendimento: ' || nr_atendimento_w || chr(13) || chr(10);
				ds_parecer_ww := ds_parecer_ww ||
				wheb_mensagem_pck.get_texto(344884,'NM_PACIENTE='||nm_paciente_w) || chr(13) || chr(10); -- 'Paciente: ' || nm_paciente_w || chr(13) || chr(10);
			else
				ds_parecer_ww := ds_parecer_ww ||
				wheb_mensagem_pck.get_texto(345019,'NM_PACIENTE_W='||nm_paciente_w)|| chr(13) || chr(10); --'Existe uma resposta de parecer referente o Paciente: ' || nm_paciente_w || chr(13) || chr(10);
			end if;
			ds_parecer_ww := ds_parecer_ww ||wheb_mensagem_pck.get_texto(344942,'SETORW='||ds_setor_w)|| chr(13) || chr(10);  --'Setor : ' || ds_setor_w || chr(13) || chr(10);
			ds_parecer_ww := ds_parecer_ww ||wheb_mensagem_pck.get_texto(344946,'DS_LEITO_W='||ds_leito_w)|| chr(13) || chr(10);  --'Leito\Compl : ' || ds_leito_w || chr(13) || chr(10);
			ds_parecer_ww := ds_parecer_ww ||wheb_mensagem_pck.get_texto(345022,'NM_MEDICO_W='||nm_medico_w)|| chr(13) || chr(10); --'Profissional consultor: ' || nm_medico_w || chr(13) || chr(10);
			if (ds_especialidade_origem_w IS NOT NULL AND ds_especialidade_origem_w::text <> '') then
				ds_parecer_ww := ds_parecer_ww || wheb_mensagem_pck.get_texto(344982,'DS_ESPECIALIDADE_ORIGEM_W='||ds_especialidade_origem_w)|| chr(13) || chr(10); --'Especialidade origem: ' || ds_especialidade_origem_w || chr(13) || chr(10);
			end if;

			if (ds_especialidade_dest_w IS NOT NULL AND ds_especialidade_dest_w::text <> '') then
				ds_parecer_ww := ds_parecer_ww ||wheb_mensagem_pck.get_texto(344985,'DS_ESPECIALIDADE_DEST_W='||ds_especialidade_dest_w)|| chr(13) || chr(10);  --'Especialidade destino: ' || ds_especialidade_dest_w || chr(13) || chr(10);
			end if;
			
			if (ds_motivo_consulta_w IS NOT NULL AND ds_motivo_consulta_w::text <> '') then
				ds_parecer_ww := ds_parecer_ww || wheb_mensagem_pck.get_texto(344992,'DS_MOTIVO_CONSULTA_W='||ds_motivo_consulta_w)|| chr(13) || chr(10); -- 'Motivo consulta: ' || ds_motivo_consulta_w || chr(13) || chr(10);
			end if;
			ds_parecer_ww := ds_parecer_ww || chr(13) || chr(10) || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(344993); --'Favor verificar no PEP item Parecer Medico';
		end if;

		select	substr(obter_usuario_pf(cd_medico),1,100)
		into STRICT	nm_destino_w
		from	parecer_medico_req
		where	nr_parecer = nr_parecer_p;

		select	max(ds_email)
		into STRICT	ds_email_destino_w
		from	usuario
		where	nm_usuario = nm_destino_w;
		
		if (coalesce(ds_email_destino_w::text, '') = '') then
			-- O usuario ' || nm_destino_w || ' nao possui e-mail!'
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(264630,	'NM_DESTINO_W='||NM_DESTINO_W);
		end if;
		ds_parecer_ww := substr(ds_parecer_ww,1,32000);
		CALL enviar_email(wheb_mensagem_pck.get_texto(344999),
			     ds_parecer_ww,
			     null,
			     ds_email_destino_w,
			     nm_usuario_p,
			     'B');		
	end if;
commit;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_email_parecer_med (nr_parecer_p bigint, ie_tipo_p bigint, cd_estabelecimento_p bigint, nr_seq_parecer_p bigint, nm_usuario_p text) FROM PUBLIC;

