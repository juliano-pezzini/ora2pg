-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_solic_compra ( nr_solic_compra_p bigint, nm_usuario_p text, ie_plataforma_p text default 'J') AS $body$
DECLARE

nr_item_solic_compra_w		bigint;
qt_material_w			bigint;
qt_entr_solicitada_w		bigint;
cd_local_estoque_w		integer;
ie_local_direto_w			varchar(1);
cd_centro_custo_w			integer;
nr_solic_compra_w			bigint;
cd_material_w			integer;
qt_itens_pendentes_w		bigint;
cd_estabelecimento_w		smallint;
cd_estab_ccusto_w		smallint;
cd_conta_contabil_w		varchar(20);
cd_conta_plano_gpi_w		varchar(20);
ie_conta_vigencia_w		varchar(1);
dt_solicitacao_compra_w		timestamp;
qt_existe_consitencia_w		bigint;
ds_comunicacao_w			varchar(2000);
ds_titulo_w			varchar(80);
nm_usuario_comprador_w		varchar(255);
nm_usuario_comprador_deleg_w	varchar(255);
ds_destinatario_w			varchar(255);
nr_seq_classif_w			bigint;
nr_sequencia_w			bigint;
qt_existe_w			bigint;
qt_regra_usuario_w			bigint;
nr_seq_regra_w			bigint;
cd_setor_atendimento_w		integer;
ie_forma_consist_w			varchar(1);
ie_urgente_w			varchar(1);
cd_evento_w			smallint;
ie_obriga_forma_w			varchar(1);
nr_seq_forma_compra_w		bigint;
ie_tipo_forma_compra_w		varchar(15);
ie_consistir_estoque_w		varchar(15);
ie_consistir_itens_w			varchar(15);
ie_material_comercial_w		varchar(15);
ie_consiste_regra_aprov_w		varchar(15);
ie_mat_est_centro_custo_w		varchar(15);
ie_consiste_mat_ccusto_w		varchar(15);
ie_permite_sem_data_entrega_w	varchar(15);
ie_tipo_centro_w			varchar(1);
ie_consiste_ccusto_sem_aprov_w	varchar(1);
ds_erro_w			varchar(255) := '';
ie_consiste_conta_gpi_w		varchar(1);
cd_empresa_w			smallint;
cd_perfil_w			bigint;
qt_solic_lib_dia_w			bigint;
ie_consiste_motivo_solic_w		varchar(1);
nr_seq_motivo_solic_w		bigint;
cd_conta_mat_w			varchar(20);
ie_tipo_grupo_w			varchar(1);
nr_seq_proj_gpi_w			bigint;
ie_tipo_servico_w			varchar(15);
ie_consiste_orcado_w		varchar(1);
ie_orcado_w			varchar(1);
ie_perm_cont_dif_w			varchar(1);
nr_seq_conta_gpi_w		bigint;
nr_seq_orc_item_gpi_w		bigint;
dt_vigencia_w			timestamp;
nr_seq_proj_rec_w		projeto_recurso.nr_sequencia%type;
nr_seq_sub_proj_rec_w		projeto_recurso.nr_sequencia%type;
vl_inicio_projeto_w		projeto_recurso.vl_inicio_projeto%type;
vl_comprometido_w		projeto_recurso_saldo.vl_comprometido%type;
vl_total_tit_pagar_liq_w	titulo_pagar.vl_titulo%type;
vl_total_solic_acum_w		solic_compra_item.vl_unit_previsto%type;
vl_total_solic_w		solic_compra_item.vl_unit_previsto%type;

nr_seq_forma_compra_regra_w  		regra_consist_pend_compra.nr_seq_forma_compra%type;
ie_consiste_solic_pend_regra_w  	regra_consist_pend_compra.ie_consiste_solic_pend%type;
ie_consiste_cot_pend_regra_w  		regra_consist_pend_compra.ie_consiste_cot_pend%type;
ie_consiste_oc_pend_regra_w  		regra_consist_pend_compra.ie_consiste_oc_pend%type;
ie_consiste_lic_pend_regra_w 		regra_consist_pend_compra.ie_consiste_lic_pend%type;
ie_acao_salvar_regra_w  		regra_consist_pend_compra.ie_acao_salvar%type;
ie_acao_liberar_regra_w  		regra_consist_pend_compra.ie_acao_liberar%type;
cd_material_regra_w			solic_compra_item.cd_material%type;
ds_material_regra_w			varchar(255);
ds_solic_pend_w						varchar(255);
ds_cot_pend_w						varchar(255);
ds_oc_pend_w						varchar(255);
ds_licitacao_pend_w					varchar(255);
qt_cot_pendente_w					bigint;
qt_oc_pendente_w					bigint;
qt_solic_pendente_w					bigint;
qt_licitacao_pendente_w				bigint;
nr_seq_forma_solic_compra_w			solic_compra.nr_seq_forma_compra%type;
cd_estab_solic_w					solic_compra.cd_estabelecimento%type;
ie_forma_consiste_w					varchar(1);
ie_param_25_w 				varchar(1) := 'N';
ie_considera_vl_compr_saldo_w		varchar(1) := 'N';

ie_vis_motivo_justif_w				varchar(1);
ie_consiste_saldo_orc_mes_w             varchar(1) := 'N';
ie_consiste_saldo_orc_ano_w         varchar(1) := 'N';
ie_consiste_saldo_gpi_w             varchar(1) := 'N';
ie_permite_solic_sem_anexo_w	    varchar(1) := 'S';

ie_consiste_vl_empenho_w	varchar(1);
vl_orcado_w					ctb_orcamento.vl_orcado%type;
vl_empenho_orcamento_w		ctb_orcamento.vl_orcado%type;
vl_empenho_solicitacao_w	solic_compra_item.vl_unit_previsto%type;
nr_seq_mes_ref_w			ctb_mes_ref.nr_sequencia%type;
ds_consistencia_w			requisicao_mat_consist.ds_consistencia%type;
ds_obs_consist_w			requisicao_mat_consist.ds_observacao%type;

c01 CURSOR FOR
	SELECT	nr_item_solic_compra,
		cd_material,
		cd_conta_contabil,
		nr_seq_orc_item_gpi
	from	solic_compra_item
	where	nr_solic_compra	= nr_solic_compra_p;

c02 CURSOR FOR
	SELECT	a.nr_item_solic_compra,
		a.qt_material,
		a.cd_material,
		coalesce(sum(b.qt_entrega_solicitada),0)
	FROM solic_compra_item a
LEFT OUTER JOIN solic_compra_item_entrega b ON (a.nr_solic_compra = b.nr_solic_compra AND a.nr_item_solic_compra = b.nr_item_solic_compra)
WHERE a.nr_solic_compra			= nr_solic_compra_p and ie_permite_sem_data_entrega_w	= 'N' group by a.nr_item_solic_compra,
		a.qt_material,
		a.cd_material
	having a.qt_material <> coalesce(sum(b.qt_entrega_solicitada),0)
	
union

	SELECT	a.nr_item_solic_compra,
		a.qt_material,
		a.cd_material,
		coalesce(sum(b.qt_entrega_solicitada),0)
	from	solic_compra_item_entrega b,
		solic_compra_item a
	where 	a.nr_solic_compra			= b.nr_solic_compra
	and 	a.nr_item_solic_compra 		= b.nr_item_solic_compra
	and 	a.nr_solic_compra			= nr_solic_compra_p
	and	ie_permite_sem_data_entrega_w	= 'S'
	group by a.nr_item_solic_compra,
		a.qt_material,
		a.cd_material
	having a.qt_material <> coalesce(sum(b.qt_entrega_solicitada),0);

c03 CURSOR FOR
	SELECT	b.nr_item_solic_compra,
		b.cd_material
	FROM solic_compra_item_entrega a
LEFT OUTER JOIN solic_compra_item b ON (a.nr_solic_compra = b.nr_solic_compra AND a.nr_item_solic_compra = b.nr_item_solic_compra)
WHERE a.nr_solic_compra 		= nr_solic_compra_p and ((a.dt_entrega_solicitada < trunc(clock_timestamp(),'dd')) or (b.dt_solic_item < trunc(clock_timestamp(),'dd')));

c04 CURSOR FOR
	SELECT	CASE WHEN ie_material_comercial_w='E' THEN  a.cd_material_estoque  ELSE a.cd_material END
	from	material a,
		solic_compra_item b
	where	nr_solic_compra = nr_solic_compra_p
	and	a.cd_material = b.cd_material;

c06 CURSOR FOR
	SELECT	substr(obter_desc_material(cd_material),1,255),
		cd_material
	from	solic_compra a,
		solic_compra_item b
	where	a.nr_solic_compra	= b.nr_solic_compra
	and	a.nr_solic_compra	= nr_solic_compra_p
	and	a.nr_seq_forma_compra	= coalesce(nr_seq_forma_compra_regra_w,a.nr_seq_forma_compra);
	
c07 CURSOR FOR
	SELECT 	nr_sequencia
	from 	projeto_recurso 
	where 	nr_seq_superior = nr_seq_proj_rec_w;
	

BEGIN

delete
from	solic_compra_consist
where	nr_solic_compra = nr_solic_compra_p;
commit;

select	cd_local_estoque,
	cd_setor_atendimento,
	substr(obter_se_local_direto(cd_local_estoque),1,1),
	cd_centro_custo,
	cd_estabelecimento,
	cd_conta_contabil,
	dt_solicitacao_compra,
	ie_urgente,
	nr_seq_forma_compra,
	nr_seq_motivo_solic,
	ie_orcado,
	ie_tipo_servico
into STRICT	cd_local_estoque_w,
	cd_setor_atendimento_w,
	ie_local_direto_w,
	cd_centro_custo_w,
	cd_estabelecimento_w,
	cd_conta_contabil_w,
	dt_solicitacao_compra_w,
	ie_urgente_w,
	nr_seq_forma_compra_w,
	nr_seq_motivo_solic_w,
	ie_orcado_w,
	ie_tipo_servico_w
from 	solic_compra
where 	nr_solic_compra = nr_solic_compra_p;

cd_perfil_w	:= obter_perfil_ativo;

select	coalesce(max(obter_valor_param_usuario(913, 67, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N'),
	coalesce(max(obter_valor_param_usuario(913, 2, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N'),
	coalesce(max(obter_valor_param_usuario(913, 16, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N'),
	coalesce(max(obter_valor_param_usuario(913, 19, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N'),
	coalesce(max(obter_valor_param_usuario(913, 47, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N'),
	coalesce(max(obter_valor_param_usuario(913, 1, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N'),
	coalesce(max(obter_valor_param_usuario(913, 82, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N'),
	coalesce(max(obter_valor_param_usuario(913, 170, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N'),
	coalesce(max(obter_valor_param_usuario(913, 180, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N'),
	coalesce(max(obter_valor_param_usuario(913, 193, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)),'N'),
	coalesce(max(obter_valor_param_usuario(913, 204, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)),-1),
	coalesce(max(obter_valor_param_usuario(913, 213, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)),'N'),
	coalesce(max(obter_valor_param_usuario(913, 227, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)),'N'),
	coalesce(max(obter_valor_param_usuario(913, 229, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)),'C'),
	coalesce(max(obter_valor_param_usuario(913, 73, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)),'N'),
	coalesce(max(obter_valor_param_usuario(913, 300, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)),'N'),
	coalesce(max(obter_valor_param_usuario(913, 301, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)),'N'),
	coalesce(max(obter_valor_param_usuario(913, 303, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)),'S'),
    coalesce(max(obter_valor_param_usuario(913, 305, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)),'N')
into STRICT	ie_obriga_forma_w,
	ie_consistir_estoque_w,
	ie_consistir_itens_w,
	ie_material_comercial_w,
	ie_consiste_regra_aprov_w,
	ie_mat_est_centro_custo_w,
	ie_consiste_mat_ccusto_w,
	ie_permite_sem_data_entrega_w,
	ie_consiste_ccusto_sem_aprov_w,
	ie_consiste_conta_gpi_w,
	qt_solic_lib_dia_w,
	ie_consiste_motivo_solic_w,
	ie_consiste_orcado_w,
	ie_perm_cont_dif_w,
	ie_vis_motivo_justif_w,
	ie_consiste_saldo_orc_mes_w,
	ie_consiste_saldo_gpi_w,
	ie_permite_solic_sem_anexo_w,
    ie_consiste_saldo_orc_ano_w
;

if (ie_consiste_motivo_solic_w = 'S' and
	ie_vis_motivo_justif_w = 'S' and
	coalesce(ie_tipo_servico_w, 'ES') = 'ES' and
	coalesce(nr_seq_motivo_solic_w::text, '') = '') then
	
	CALL gravar_solic_compra_consist(
			nr_solic_compra_p, '0',
			Wheb_mensagem_pck.get_Texto(298896), /*'e obrigatorio a informacao do motivo da solicitacao.'*/
			'C',
			Wheb_mensagem_pck.get_Texto(298897), /*'Verifique o parametro [213].'*/
			nm_usuario_p);
end if;

if (ie_consiste_orcado_w = 'S') and (ie_orcado_w = 'N') then
	CALL gravar_solic_compra_consist(
		nr_solic_compra_p, '0',
		Wheb_mensagem_pck.get_Texto(298899), /*'Esta solicitacaode compras nao passou pela analise de orcamento.',*/
		'C',
		Wheb_mensagem_pck.get_Texto(298900), /*'Verifique o parametro [227].', */
		nm_usuario_p);
	
	
end if;

if (qt_solic_lib_dia_w >= 0) then

	select	count(*)
	into STRICT	qt_existe_w
	from	solic_compra
	where	cd_estabelecimento = cd_estabelecimento_w
	and	nm_usuario_lib = nm_usuario_p
	and	coalesce(dt_baixa::text, '') = ''
	and	trunc(dt_liberacao,'dd') = trunc(clock_timestamp(),'dd');
	
	if (qt_existe_w >= qt_solic_lib_dia_w) then
		CALL gravar_solic_compra_consist(
			nr_solic_compra_p, '0',
			Wheb_mensagem_pck.get_Texto(298901), /*'Voce ja atingiu a quantidade limite de solicitacoes liberadas por dia.',*/
			'C',
			WHEB_MENSAGEM_PCK.get_texto(298903,'QT_SOLIC_LIB_DIA_W='||QT_SOLIC_LIB_DIA_W||';QT_EXISTE_W='||QT_EXISTE_W), /*Limite: #@QT_SOLIC_LIB_DIA_W#@ ja liberadas: #@QT_EXISTE_W#@ Verifique o parametro [204].*/
			nm_usuario_p);
	end if;

end if;

select	coalesce(max(cd_estabelecimento), cd_estabelecimento_w)
into STRICT	cd_estab_ccusto_w
from	centro_custo
where	cd_centro_custo	= cd_centro_custo_w;

if (ie_obriga_forma_w = 'S') and (coalesce(nr_seq_forma_compra_w::text, '') = '') then
	CALL gravar_solic_compra_consist(
			nr_solic_compra_p, '0',
			Wheb_mensagem_pck.get_Texto(298904), /*'Antes de liberar a solicitacao, e necessario preencher a forma de compra',*/
			'C', null, nm_usuario_p);
end if;

if (ie_consiste_ccusto_sem_aprov_w = 'S') and (cd_centro_custo_w > 0) then
	ds_erro_w := consiste_ccusto_sc_sem_aprov(		
		cd_centro_custo_w, cd_estabelecimento_w, cd_setor_atendimento_w, ie_urgente_w, ds_erro_w);
	
	if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
		CALL gravar_solic_compra_consist(
			nr_solic_compra_p, '0',
			ds_erro_w,
			'C', null, nm_usuario_p);
	
	end if;	
end if;

if	((coalesce(cd_local_estoque_w::text, '') = '') and (coalesce(cd_centro_custo_w::text, '') = '')) then
	CALL gravar_solic_compra_consist(
			nr_solic_compra_p, '0',
			Wheb_mensagem_pck.get_Texto(298906), /*'e necessario preencher o local de estoque ou centro de custo',*/
			'C', null, nm_usuario_p);
end if;

if	(cd_local_estoque_w IS NOT NULL AND cd_local_estoque_w::text <> '' AND ie_local_direto_w = 'N' AND cd_centro_custo_w IS NOT NULL AND cd_centro_custo_w::text <> '') then
	CALL gravar_solic_compra_consist(
			nr_solic_compra_p, '0',
			Wheb_mensagem_pck.get_Texto(298907), /*'Preencher somente o local de estoque ou centro de custo',*/
			'C', null, nm_usuario_p);
end if;

if (cd_centro_custo_w IS NOT NULL AND cd_centro_custo_w::text <> '') then
	begin

	select	ie_tipo
	into STRICT	ie_tipo_centro_w
	from	centro_custo
	where	cd_centro_custo = cd_centro_custo_w;

	if (ie_tipo_centro_w = 'T') then
		CALL gravar_solic_compra_consist(
			nr_solic_compra_p, '0',
			Wheb_mensagem_pck.get_Texto(298908), /*'O centro de custo definido e do tipo Titulo',*/
			'C', null, nm_usuario_p);
	end if;

	end;
end if;

select	count(*)
into STRICT	qt_existe_w
from	solic_compra_item b,
	solic_compra a
where	a.nr_solic_compra = b.nr_solic_compra
and	a.nr_solic_compra = nr_solic_compra_p
and	substr(obter_se_material_estoque(a.cd_estabelecimento,a.cd_estabelecimento,b.cd_material),1,1) = 'S'
and	ie_mat_est_centro_custo_w = 'N'
and	(cd_centro_custo IS NOT NULL AND cd_centro_custo::text <> '');

if (qt_existe_w > 0) then
	CALL gravar_solic_compra_consist(
			nr_solic_compra_p, '0',
			Wheb_mensagem_pck.get_Texto(298909),	/*'Sem permissao para solicitar um material de estoque para centro de custo',*/
			'C',
			Wheb_mensagem_pck.get_Texto(298910), /*'Verifique o parametro [1] da funcao.', */
			nm_usuario_p);	
end if;

if (ie_permite_solic_sem_anexo_w = 'N') then
	select	count(*)
	into STRICT	qt_existe_w
	from	solic_compra_item_anexo b,
		solic_compra a
	where	a.nr_solic_compra = b.nr_solic_compra
	and	a.nr_solic_compra = nr_solic_compra_p;
	
	if (qt_existe_w = 0) then
		CALL gravar_solic_compra_consist(
			nr_solic_compra_p, '0',
			Wheb_mensagem_pck.get_Texto(1128243),
			'C', null, nm_usuario_p);
	end if;
end if;

open c02;
loop
fetch c02 into
	nr_item_solic_compra_w,
	qt_material_w,
	cd_material_w,
	qt_entr_solicitada_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin	
	CALL gravar_solic_compra_consist(
			nr_solic_compra_p, '0',
			Wheb_mensagem_pck.get_Texto(298912, 'CD_MATERIAL_W='||CD_MATERIAL_W), /*'A quantidade do material ' || cd_material_w || ' nao confere com a quantidade das entregas',*/
			'C',
			WHEB_MENSAGEM_PCK.get_texto(298914,'QT_MATERIAL_W='||QT_MATERIAL_W||';QT_ENTR_SOLICITADA_W='||QT_ENTR_SOLICITADA_W), /*A soma da quantidade das entregas nao e igual a quantidade do item. Qt. Item = #@QT_MATERIAL_W#@ Qt. Entrega = #@QT_ENTR_SOLICITADA_W#@.*/
			nm_usuario_p);
	end;
end loop;
close c02;

open c03;
loop
fetch c03 into
	nr_item_solic_compra_w,
	cd_material_w;
EXIT WHEN NOT FOUND; /* apply on c03 */
	begin
	CALL gravar_solic_compra_consist(
			nr_solic_compra_p, '0',
			Wheb_mensagem_pck.get_Texto(298916, 'CD_MATERIAL_W='||CD_MATERIAL_W), /*'A data de entrega do material ' || cd_material_w || ' esta menor que a data atual',*/
			'C',
			Wheb_mensagem_pck.get_Texto(298918, 'CD_MATERIAL_W='||CD_MATERIAL_W), /*'A data de entrega do item e menor que a data atual.' || chr(13) || 'Material = ' || cd_material_w,*/
			nm_usuario_p);
	end;
end loop;
close c03;

if (ie_consistir_itens_w = 'S') or (ie_consistir_itens_w = 'E') or (ie_consistir_itens_w = 'M') then
	begin
	open c04;
	loop
	fetch c04 into
		cd_material_w;
	EXIT WHEN NOT FOUND; /* apply on c04 */	
		begin
		select	count(*)
		into STRICT	qt_itens_pendentes_w
		from	compra_pendente_v
		where	nr_documento <>	nr_solic_compra_p
		and	nr_documento <> 0
		and	cd_material_estoque = cd_material_w
		and	cd_estabelecimento = cd_estabelecimento_w
		and	((ie_consistir_itens_w in ('S','M')) or (ie_consistir_itens_w = 'E') and (obter_Se_material_Estoque(cd_estabelecimento_w,cd_estabelecimento_w,cd_material_w) = 'S'));

		if (qt_itens_pendentes_w > 0) then
		
			ie_forma_consist_w		:= 'C';
			if (ie_consistir_itens_w = 'M') then
				ie_forma_consist_w	:= 'M';
			end if;
			
			if (ie_plataforma_p = 'H') then
                CALL gravar_solic_compra_consist(
                        nr_solic_compra_p, '0',
                    	Wheb_mensagem_pck.get_Texto(1119239, 'CD_MATERIAL_W='||CD_MATERIAL_W),
                    	ie_forma_consist_w, null, nm_usuario_p);
            else
                CALL gravar_solic_compra_consist(
                        nr_solic_compra_p, '0',
                    	Wheb_mensagem_pck.get_Texto(298919, 'CD_MATERIAL_W='||CD_MATERIAL_W), /*'O material ' || cd_material_w || ' possui compras pendentes. Consulte (F7)',*/
                    	ie_forma_consist_w, null, nm_usuario_p);
            end if;
		end if;
		end;
	end loop;
	close c04;
	end;

elsif (ie_consistir_itens_w = 'P') then
	
	ds_solic_pend_w 	:= '';
	ds_cot_pend_w		:= '';
	ds_oc_pend_w		:= '';
	ds_licitacao_pend_w	:= '';
	qt_solic_pendente_w	:= 0;
	qt_cot_pendente_w	:= 0;
	qt_oc_pendente_w	:= 0;
	qt_licitacao_pendente_w	:= 0;
	
	select	max(nr_seq_forma_compra),
			max(cd_estabelecimento)
	into STRICT	nr_seq_forma_solic_compra_w,
			cd_estab_solic_w
	from 	solic_compra
	where 	nr_solic_compra = nr_solic_compra_p;
	
	select	max(nr_seq_forma_compra),
			max(coalesce(ie_consiste_solic_pend,'N')),
			max(coalesce(ie_consiste_cot_pend,'N')),
			max(coalesce(ie_consiste_oc_pend,'N')),
			max(coalesce(ie_consiste_lic_pend,'N')),
			max(coalesce(ie_acao_salvar,'N')),
			max(coalesce(ie_acao_liberar,'N'))
	into STRICT	nr_seq_forma_compra_regra_w,
			ie_consiste_solic_pend_regra_w,
			ie_consiste_cot_pend_regra_w,
			ie_consiste_oc_pend_regra_w,
			ie_consiste_lic_pend_regra_w,
			ie_acao_salvar_regra_w,
			ie_acao_liberar_regra_w
	from 	regra_consist_pend_compra
	where 	coalesce(nr_seq_forma_compra,0) 	= coalesce(nr_seq_forma_solic_compra_w,0)
	and 	cd_estabelecimento			= cd_estab_solic_w;

		open c06;
		loop
		fetch c06 into	
			ds_material_regra_w,
			cd_material_regra_w;
		EXIT WHEN NOT FOUND; /* apply on c06 */
			begin
			
			if (ie_consiste_solic_pend_regra_w = 'S') then --solicitacao		
				
				select	count(*)
				into STRICT	qt_solic_pendente_w
				from	compra_pendente_v
				where	ie_informacao		= 2
				and 	cd_material		= cd_material_regra_w
				and 	cd_estabelecimento 	= cd_estabelecimento_w;
		
				if (qt_solic_pendente_w > 0) then
					ds_solic_pend_w := substr(cd_material_regra_w || ' - ' || ds_material_regra_w,1,255);

		end if;
			end if;	

			if (ie_consiste_cot_pend_regra_w = 'S') then --COTACAO		
				
				select	count(*)
				into STRICT	qt_cot_pendente_w
				from	compra_pendente_v
				where	ie_informacao		= 3
				and 	cd_material		= cd_material_regra_w
				and 	cd_estabelecimento 	= cd_estabelecimento_w;
		
				if (qt_cot_pendente_w > 0) then
					ds_cot_pend_w := substr(cd_material_regra_w || ' - ' || ds_material_regra_w,1,255);
				end if;
			end if;	
			
			if (ie_consiste_oc_pend_regra_w = 'S') then --ORDENS		
				
				select	count(*)
				into STRICT	qt_oc_pendente_w
				from	compra_pendente_v
				where	ie_informacao		= 1
				and 	cd_material		= cd_material_regra_w
				and 	cd_estabelecimento 	= cd_estabelecimento_w;
		
				if (qt_oc_pendente_w > 0) then
					ds_oc_pend_w := substr(cd_material_regra_w || ' - ' || ds_material_regra_w,1,255);
				end if;
			end if;	
			
			if (ie_consiste_lic_pend_regra_w = 'S') then --LICITACAO
				select	coalesce(sum(qt_licitacao),0)
				into STRICT	qt_licitacao_pendente_w
				from (
					SELECT	1 qt_licitacao
					from 	reg_licitacao a,
						reg_lic_item b
					where 	a.nr_sequencia 		= b.nr_seq_licitacao
					and 	a.cd_estabelecimento 	= cd_estabelecimento_w
					and 	b.cd_material 		= cd_material_regra_w
					and 	not exists (	SELECT	1
								from	reg_compra z,
									reg_compra_item x
								where 	z.nr_sequencia = x.nr_seq_reg_compra
								and	z.nr_seq_licitacao = a.nr_sequencia
								and	x.cd_material = b.cd_material)
					
union
					
					select 	1
					from	lic_item a,
						lic_licitacao b,
						lic_estagio c
					where	a.nr_seq_licitacao 	= b.nr_sequencia
					and	b.nr_seq_estagio 	= c.nr_sequencia
					and	c.ie_permite_oc 	= 'S'
					and	a.cd_material 		= cd_material_regra_w) alias4;
				
				if (qt_licitacao_pendente_w > 0) then
					ds_licitacao_pend_w := substr(cd_material_regra_w || ' - ' || ds_material_regra_w,1,255);
				end if;									
			end if;
			
			end;
		end loop;
		close c06;

		/*Consistencias*/

		
		if (ie_acao_liberar_regra_w <> 'N')then
		
			select	CASE WHEN ie_acao_liberar_regra_w='S' THEN 'C' WHEN ie_acao_liberar_regra_w='A' THEN 'M' END
			into STRICT	ie_forma_consiste_w
			;
		
			if (qt_solic_pendente_w > 0) then
				CALL gravar_solic_compra_consist(nr_solic_compra_p, '0',Wheb_mensagem_pck.get_Texto(388355,'DS_MATERIAL='||ds_solic_pend_w),ie_forma_consiste_w, null, nm_usuario_p); /*#@DS_MATERIAL#@. Existem solicitacoes pendentes para esse item.*/
				
			end if;
			
			if (qt_cot_pendente_w> 0) then
				CALL gravar_solic_compra_consist(nr_solic_compra_p, '0',Wheb_mensagem_pck.get_Texto(388361,'DS_MATERIAL='||ds_solic_pend_w),ie_forma_consiste_w, null, nm_usuario_p); /*#@DS_MATERIAL#@. Existem cotacoes pendentes para esse item.*/
		
			end if;
			
			if (qt_oc_pendente_w > 0) then
				CALL gravar_solic_compra_consist(nr_solic_compra_p, '0',Wheb_mensagem_pck.get_Texto(388363,'DS_MATERIAL='||ds_solic_pend_w),ie_forma_consiste_w, null, nm_usuario_p); /*#@DS_MATERIAL#@. Existem ordens pendentes para esse item.*/
	
			end if;
			
			if (qt_licitacao_pendente_w > 0) then
				CALL gravar_solic_compra_consist(nr_solic_compra_p, '0',Wheb_mensagem_pck.get_Texto(388365,'DS_MATERIAL='||ds_solic_pend_w),ie_forma_consiste_w, null, nm_usuario_p); /*#@DS_MATERIAL#@. Existem licitacoes pendentes para esse item.*/
		
			end if;

		end if;
end if;

select	count(*)
into STRICT 	nr_solic_compra_w
from 	solic_compra_item
where	nr_solic_compra = nr_solic_compra_p;
if 	nr_solic_compra_w = 0 then
	CALL gravar_solic_compra_consist(
			nr_solic_compra_p, '0',
			Wheb_mensagem_pck.get_Texto(298921),/*'A solicitacaode compra deve ter pelo menos um item',*/
			'C', null, nm_usuario_p);
end if;

/* Consiste se a vigencia da conta contabil */

if (cd_conta_contabil_w IS NOT NULL AND cd_conta_contabil_w::text <> '') then
	select	substr(obter_se_conta_vigente(cd_conta_contabil_w, dt_solicitacao_compra_w),1,1)
	into STRICT	ie_conta_vigencia_w
	;
	if (ie_conta_vigencia_w = 'N') then
		CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '0',
				Wheb_mensagem_pck.get_Texto(298922), /*'A conta contabil esta fora da data de vigencia',*/
				'C', null, nm_usuario_p);
	end if;
end if;

ie_consiste_vl_empenho_w	:= coalesce(obter_valor_param_usuario( 925, 122, Obter_perfil_ativo,
								nm_usuario_p, cd_estabelecimento_w),'N');

/* Consiste se o valor empenho for maior que o orcamento */

if (coalesce(ie_consiste_vl_empenho_w,'N') = 'S') then

	select	max(nr_sequencia)
		into STRICT	nr_seq_mes_ref_w
		from	ctb_mes_ref
		where	trunc(dt_referencia,'month') = trunc(dt_solicitacao_compra_w,'month');
		
	vl_orcado_w :=	coalesce(ctb_obter_valor_orcado( dt_referencia_p => trunc(dt_solicitacao_compra_w,'month'), cd_conta_contabil_p => cd_conta_contabil_w,
							cd_centro_custo_p => cd_centro_custo_w, cd_estabelecimento_p => cd_estabelecimento_w),0);

	vl_empenho_orcamento_w := coalesce(ctb_obter_empenho_orcamento( nr_seq_mes_ref_p => nr_seq_mes_ref_w, cd_conta_contabil_p => cd_conta_contabil_w,
						cd_centro_custo_p => cd_centro_custo_w, cd_estabelecimento_p => cd_estabelecimento_w, 
						dt_inicial_p => null, dt_final_p => null),0);
		
	select
		coalesce(max(sum(coalesce(c.vl_rateio * c.qt_rateio, a.vl_unit_previsto * a.qt_material))),0)
		into STRICT vl_empenho_solicitacao_w
		FROM ctb_grupo_conta e, conta_contabil d, solic_compra b, solic_compra_item a
LEFT OUTER JOIN solic_compra_item_rateio c ON (a.nr_solic_compra = c.nr_solic_compra AND a.nr_item_solic_compra = c.nr_item_solic_compra)
WHERE a.nr_solic_compra	= b.nr_solic_compra   and a.cd_conta_contabil = d.cd_conta_contabil and d.cd_grupo = e.cd_grupo and e.ie_tipo in ('R','D') and e.ie_debito_credito 	= 'D' and b.nr_solic_compra	= nr_solic_compra_p and coalesce(b.dt_baixa::text, '') = '' and coalesce(b.nr_seq_motivo_cancel::text, '') = '' and not exists (	SELECT	1
			from	nota_fiscal_item y
			where	y.nr_solic_compra	= b.nr_solic_compra
			and	y.nr_item_solic_compra	= a.nr_item_solic_compra
			and	y.nr_solic_compra	= nr_solic_compra_p) group by coalesce(c.cd_centro_custo, b.cd_centro_custo),
		a.cd_conta_contabil;
		
		vl_empenho_orcamento_w := vl_empenho_orcamento_w + vl_empenho_solicitacao_w;

	-- Valor de empenho nao pode ser maior que o valor orcado
	if (vl_empenho_orcamento_w > vl_orcado_w) then
		-- O valor de empenho ultrapassou o valor orcado, verifique.
		ds_consistencia_w := substr(wheb_mensagem_pck.get_texto(nr_seq_mensagem_p => 1196401, vl_macros_p => null),1,255);
		ds_obs_consist_w := substr(wheb_mensagem_pck.get_texto(nr_seq_mensagem_p => 1196644,
									vl_macros_p => 'VL_EMPENHO='|| campo_mascara_virgula(vl_empenho_orcamento_w) ||
											';VL_ORCADO='|| campo_mascara_virgula(vl_orcado_w)),1,255);

		CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '0',
				ds_consistencia_w, /*'O valor do empenho ultrapassou o valor orcado. Verifique.',*/
				'C',
				ds_obs_consist_w, /*'O valor do empenho e VL_EMPENHO. O valor orcado e VL_ORCADO.',*/
				nm_usuario_p);
	end if;
end if;

/* Consiste o estabelecimento do centro de custo */

if (cd_estabelecimento_w <> cd_estab_ccusto_w) then
	CALL gravar_solic_compra_consist(
			nr_solic_compra_p, '0',
			Wheb_mensagem_pck.get_Texto(298923), /*'Este centro de custo e de outro e estabelecimento',*/
			'C', null, nm_usuario_p);
end if;

if (ie_perm_cont_dif_w = 'N') then
	select	count(distinct nr_contrato)
	into STRICT	qt_existe_w
	from	solic_compra_item
	where	nr_solic_compra = nr_solic_Compra_p;

	if (qt_existe_w > 1) then
		CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '0',
				Wheb_mensagem_pck.get_Texto(298924), /*'nao e permitido gerar uma solicitacaocom mais de um contrato diferente do outro.',*/
				'C', null, nm_usuario_p);
	end if;
end if;

select	coalesce(max(nr_seq_forma_compra),0)
into STRICT	nr_seq_forma_compra_w
from	solic_compra
where	nr_solic_compra = nr_solic_compra_p;

if (nr_seq_forma_compra_w > 0) then
	
	select	lic_obter_tipo_forma_compra(nr_seq_forma_compra_w)
	into STRICT	ie_tipo_forma_compra_w
	;
	
	if (ie_tipo_forma_compra_w = 'C') then /*Contrato*/
		select	count(*)
		into STRICT	qt_existe_w
		from	solic_compra_item
		where	nr_solic_compra = nr_solic_compra_p
		and	coalesce(nr_contrato::text, '') = '';

		if (qt_existe_w > 0) then
			CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '0',
				Wheb_mensagem_pck.get_Texto(298925), /*'Esta solicitacao de contrato, portanto, todos os itens tambem devem ser de contrato.',*/
				'C', null, nm_usuario_p);
		end if;	
	end if;
	
	if (ie_tipo_forma_compra_w = 'A') then /*Proposta Aquisicao*/
		select	count(*)
		into STRICT	qt_existe_w
		from	solic_compra_proposta
		where	nr_solic_compra = nr_solic_compra_p
		and	(dt_aprovacao IS NOT NULL AND dt_aprovacao::text <> '');

		if (qt_existe_w = 0) then
			CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '0',
				Wheb_mensagem_pck.get_Texto(298926), /*'Esta solicitacaoexige a aprovacao de uma proposta de aquisicao.',*/
				'C', null, nm_usuario_p);
		end if;	
	end if;
end if;

CALL consistir_solic_compra_item(
	nr_solic_compra_p,
	null,
	coalesce(ie_consistir_estoque_w,'N'),
	'N',
	ie_consiste_regra_aprov_w,
	ie_consiste_mat_ccusto_w,
	nm_usuario_p,
	ie_plataforma_p);
	
open c01;
loop
fetch c01 into	
	nr_item_solic_compra_w,
	cd_material_w,
	cd_conta_contabil_w,
	nr_seq_orc_item_gpi_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	ie_tipo_grupo_w	:= 'X';
		
	select	max(coalesce(nr_seq_proj_gpi,0))
	into STRICT	nr_seq_proj_gpi_w
	from	solic_compra
	where	nr_solic_compra = nr_solic_compra_p;
	
	select	max(cd_conta_contabil)
	into STRICT	cd_conta_mat_w
	from	solic_compra_item
	where	nr_item_solic_compra = nr_item_solic_compra_w
	and		nr_solic_compra = nr_solic_compra_p;
	
	if (cd_conta_mat_w <> 'X') then
		
		select	max(g.ie_tipo)
		into STRICT	ie_tipo_grupo_w
		from	ctb_grupo_conta g,
				conta_contabil c
		where	c.cd_grupo = g.cd_grupo
		and		c.cd_conta_contabil = cd_conta_mat_w;
		
	end if;
	
	select	ie_tipo_servico
	into STRICT	ie_tipo_servico_w
	from	solic_compra
	where	nr_solic_compra = nr_solic_compra_p;
	
	if (ie_consiste_conta_gpi_w = 'S') and
		(nr_seq_proj_gpi_w = 0 AND ie_tipo_grupo_w = 'A') and (ie_tipo_servico_w in ('SP','SR','SN')) then
		begin
		CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '0',
				Wheb_mensagem_pck.get_Texto(298928, 'CD_MATERIAL_W='||CD_MATERIAL_W),/*'O material '|| cd_material_w ||' e considerado investimento. A solicitacaodeve ser feita atraves da funcao GPI',*/
				'C', null, nm_usuario_p);
		end;
	end if;
	
	if (ie_consiste_conta_gpi_w = 'C') and (coalesce(nr_seq_orc_item_gpi_w,0) = 0) and (ie_tipo_servico_w in ('SP','SR','SN')) and (cd_conta_contabil_w IS NOT NULL AND cd_conta_contabil_w::text <> '') then
		begin
		
		cd_empresa_w		:= obter_empresa_estab(cd_estabelecimento_w);
		dt_vigencia_w 		:= trunc(clock_timestamp(),'dd');
		
		
		select	count(1)
		into STRICT	qt_existe_w
		from	gpi_plano a
		where	a.cd_empresa = cd_empresa_w
		and	a.ie_situacao = 'A'
		and	a.cd_conta_contabil = cd_conta_contabil_w
		and exists (
			SELECT	1
			from	gpi_regra_plano x
			where	x.nr_seq_conta_gpi = a.nr_sequencia
			and	x.cd_empresa = cd_empresa_w
			and (coalesce(x.dt_inicio_vigencia, dt_vigencia_w) <= dt_vigencia_w and coalesce(dt_fim_vigencia, dt_vigencia_w) >= dt_vigencia_w));
		
		if (qt_existe_w > 0) and (obter_se_lib_mat_solic_gpi(cd_centro_custo_w, cd_conta_contabil_w, cd_material_w, nm_usuario_p) = 'N') then
				CALL gravar_solic_compra_consist(
					nr_solic_compra_p, '0',
					Wheb_mensagem_pck.get_Texto(298929, 'CD_MATERIAL_W='||CD_MATERIAL_W),/*'O material '|| cd_material_w ||' esta vinculado com conta contabil no GPI. A solicitacaodeve ser feita atraves da funcao GPI',*/
					'C', null, nm_usuario_p);
		
		end if;	
			
		end;
	end if;
	
	end;
end loop;
close C01;

/* Verifica se o projeto recurso possui saldo suficiente para atender essa solicitacao*/

CALL projeto_recurso_pck.consistir_sc_proj_rec(nr_solic_compra_p, nm_usuario_p, cd_estabelecimento_w);
/* Verifica se o contrato possui saldo suficiente para atender esta solicitacao*/

CALL gerenciamento_contrato_pck.consistir_sc_contrato(nr_solic_compra_p, nm_usuario_p);
/* Verifica se o orcamento contabil possui saldo suficiente para atender essa solicitacao */

if (ie_consiste_saldo_orc_mes_w = 'S' or ie_consiste_saldo_orc_ano_w = 'S') then
    CALL ctb_consiste_saldo_orc(nr_solic_compra_p, nm_usuario_p,ie_consiste_saldo_orc_mes_w,ie_consiste_saldo_orc_ano_w);
end if;
/* Verifica se o orcamento da GPI possui saldo suficiente para atender essa solicitacao */

if (ie_consiste_saldo_gpi_w = 'S') then
    CALL gpi_consiste_saldo_orc(nr_solic_compra_p, null, nm_usuario_p);
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_solic_compra ( nr_solic_compra_p bigint, nm_usuario_p text, ie_plataforma_p text default 'J') FROM PUBLIC;

