-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_imp_ressarcimento_conta ( nr_processo_p text, nr_seq_processo_p text, nr_seq_processo_conta_p text, cd_cnes_p text, nr_seq_prestador_p text, cd_usuario_plano_p text, nr_seq_segurado_p text, nr_aih_p text, dt_internacao_p text, dt_alta_p text, cd_carater_internacao_p text, nm_usuario_p text, cd_cep_p text, nr_seq_processo_proc_p text, cd_procedimento_p text, ie_origem_proced_p text, qt_procedimento_p text, vl_procedimento_p text, dt_competencia_p text, cd_cco_p text, ie_complexidade_p text) AS $body$
DECLARE


nr_seq_prestador_w		bigint;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type := wheb_usuario_pck.get_cd_estabelecimento;
nr_seq_processo_proc_w		bigint;
nr_seq_processo_w		bigint;
nr_aih_w			bigint;
nr_seq_segurado_w		bigint;
qt_procedimento_w		double precision;
vl_procedimento_w		double precision;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
nr_seq_processo_conta_w		bigint;
cd_usuario_plano_w		varchar(30);
dt_alta_w			timestamp	:= null;
dt_internacao_w			timestamp	:= null;
dt_competencia_w		timestamp	:= null;
cd_carater_internacao_w 	varchar(2);
cd_cco_w			pls_segurado.cd_cco%type;
cd_operadora_origem_w		varchar(255);
cd_usuario_plano_orig_w		varchar(255);


BEGIN

select	coalesce(max(cd_carater_internacao),null)
into STRICT	cd_carater_internacao_w
from	sus_carater_internacao
where	(cd_carater_internacao)::numeric  = cd_carater_internacao_p;

nr_seq_processo_proc_w 	:= (nr_seq_processo_proc_p)::numeric;
nr_seq_processo_conta_w	:= (nr_seq_processo_conta_p)::numeric;
nr_seq_processo_w	:= (nr_seq_processo_p)::numeric;
nr_seq_prestador_w	:= (nr_seq_prestador_p)::numeric;
nr_seq_segurado_w	:= (obter_somente_numero(nr_seq_segurado_p))::numeric;
ie_origem_proced_w	:= (ie_origem_proced_p)::numeric;
cd_procedimento_w	:= (somente_numero(cd_procedimento_p))::numeric;
qt_procedimento_w	:= (somente_numero(qt_procedimento_p))::numeric;
vl_procedimento_w	:= (somente_numero(vl_procedimento_p))::numeric;
cd_usuario_plano_w	:= substr(trim(both cd_usuario_plano_p),1,30);
cd_usuario_plano_orig_w	:= substr(trim(both cd_usuario_plano_p),1,30);
cd_cco_w		:= substr(cd_cco_p, 1, 12);

if (dt_alta_p IS NOT NULL AND dt_alta_p::text <> '') then
	dt_alta_w		:= to_date(substr(dt_alta_p,9,2)||substr(dt_alta_p,6,2)||substr(dt_alta_p,1,4),'dd/mm/yyyy');
end if;
if (dt_internacao_p IS NOT NULL AND dt_internacao_p::text <> '') then
	dt_internacao_w		:= to_date(substr(dt_internacao_p,9,2)||substr(dt_internacao_p,6,2)||substr(dt_internacao_p,1,4),'dd/mm/yyyy');
end if;
if (dt_competencia_p IS NOT NULL AND dt_competencia_p::text <> '') then
	dt_competencia_w	:= to_date(substr(dt_competencia_p,1,2)||substr(dt_competencia_p,3,4),'mm/yyyy');
end if;


if (coalesce(nr_seq_segurado_w::text, '') = '') then
	select 	max(nr_sequencia)
	into STRICT	nr_seq_segurado_w
	from	pls_segurado
	where	cd_cartao_ident_ans_sist_ant = cd_usuario_plano_w;
	
	if (coalesce(nr_seq_segurado_w::text, '') = '') then
		select	max(nr_seq_segurado)
		into STRICT	nr_seq_segurado_w
		from	pls_segurado_carteira
		where	cd_usuario_plano  = cd_usuario_plano_w;
		
		if (coalesce(nr_seq_segurado_w::text, '') = '') then
			begin
			select	max(nr_sequencia)
			into STRICT	nr_seq_segurado_w
			from	pls_segurado
			where	cd_cco	= cd_cco_w;
			exception
			when others then
				nr_seq_segurado_w := null;
			end;
		end if;
		
		if (coalesce(nr_seq_segurado_w::text, '') = '') then
			if (coalesce(nr_seq_segurado_w::text, '') = '') and (length(cd_usuario_plano_w) <= 17) then
				cd_usuario_plano_orig_w := lpad(cd_usuario_plano_w,17,'0');
				
				select	max(nr_seq_segurado)
				into STRICT	nr_seq_segurado_w
				from	pls_segurado_carteira
				where	cd_usuario_plano  = cd_usuario_plano_orig_w;
			end if;
		end if;
	end if;
end if;

if (nr_aih_p IS NOT NULL AND nr_aih_p::text <> '') then
  nr_aih_w		:= (somente_numero(nr_aih_p))::numeric;
end if;

insert into  pls_processo_conta( nr_sequencia,
				nr_seq_processo,
				dt_competencia,
				nr_seq_prestador,
				cd_usuario_plano,
				dt_atualizacao,
				nm_usuario,
				nr_aih,
				dt_internacao,
				dt_alta,
				nr_seq_segurado,
				cd_carater_internacao,
				ie_status_conta,
				nr_cco, 
				ie_digito_cco,
				ie_complexidade,
				cd_cco)
		values (nr_seq_processo_conta_w,
				nr_seq_processo_w,
				dt_competencia_w,
				nr_seq_prestador_w,
				cd_usuario_plano_w,
				clock_timestamp(),
				nm_usuario_p,
				nr_aih_w,
				dt_internacao_w,
				dt_alta_w,
				nr_seq_segurado_w,
				cd_carater_internacao_w,
				'R',
				obter_somente_numero(substr(cd_cco_w,1,10)),
				obter_somente_numero(substr(cd_cco_w,11,2)),
				ie_complexidade_p,
				cd_cco_w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_imp_ressarcimento_conta ( nr_processo_p text, nr_seq_processo_p text, nr_seq_processo_conta_p text, cd_cnes_p text, nr_seq_prestador_p text, cd_usuario_plano_p text, nr_seq_segurado_p text, nr_aih_p text, dt_internacao_p text, dt_alta_p text, cd_carater_internacao_p text, nm_usuario_p text, cd_cep_p text, nr_seq_processo_proc_p text, cd_procedimento_p text, ie_origem_proced_p text, qt_procedimento_p text, vl_procedimento_p text, dt_competencia_p text, cd_cco_p text, ie_complexidade_p text) FROM PUBLIC;

