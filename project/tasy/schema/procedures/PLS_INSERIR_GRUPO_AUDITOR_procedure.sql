-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inserir_grupo_auditor ( nr_seq_grupo_p bigint, nr_seq_auditoria_p bigint, ds_observacao_p text, nm_usuario_p text, nr_ordem_p bigint default null) AS $body$
DECLARE


ds_historico_w			varchar(2000);
nr_seq_ordem_w			bigint;
nr_seq_auditoria_grupo_w	bigint;
nr_seq_grupo_w			bigint;
nr_seq_guia_w			bigint;
nr_seq_requisicao_w		bigint;
nr_seq_execucao_w		bigint;
nr_seq_aud_grupo_w		bigint;
nr_seq_grupo_aud_w		bigint;
qt_grupo_ordem_w		integer;
ie_tipo_auditoria_w		smallint;
nr_seq_grupo_atual_w		bigint;
nr_seq_grupo_auditor_w		bigint;
ds_observacao_w			varchar(2000)	:= null;


BEGIN
begin
nr_seq_grupo_aud_w		:= coalesce(pls_obter_grupo_analise_atual(nr_seq_auditoria_p), 0);
exception
when others then
	nr_seq_grupo_aud_w	:= null;
end;

if (coalesce(nr_ordem_p,0) > 0) then
	select	count(*)
	into STRICT	qt_grupo_ordem_w
	from	pls_auditoria_grupo
	where	nr_seq_ordem		= nr_ordem_p
	and	nr_seq_auditoria	= nr_seq_auditoria_p;

	if (qt_grupo_ordem_w = 0) then
		nr_seq_ordem_w	:= nr_ordem_p;
	else
		nr_seq_ordem_w	:= null;
	end if;
end if;

if (coalesce(nr_seq_ordem_w::text, '') = '') then
	begin
	select	nr_seq_ordem + 1
	into STRICT	nr_seq_ordem_w
	from	pls_auditoria_grupo
	where	nr_sequencia	= nr_seq_grupo_aud_w;
	exception
	when others then
		nr_seq_ordem_w	:= 1;
	end;
end if;

select	nextval('pls_auditoria_grupo_seq')
into STRICT	nr_seq_auditoria_grupo_w
;

insert into pls_auditoria_grupo(nr_sequencia,
	nr_seq_auditoria,
	nr_seq_grupo,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_seq_ordem,
	ie_status,
	ie_manual)
values (nr_seq_auditoria_grupo_w,
	nr_seq_auditoria_p,
	nr_seq_grupo_p,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_ordem_w,
	'U',
	'S');

select	count(*)
into STRICT	qt_grupo_ordem_w
from	pls_auditoria_grupo
where	nr_seq_ordem		= nr_seq_ordem_w
and	nr_seq_auditoria	= nr_seq_auditoria_p;

select	pls_obter_grupo_analise_atual(nr_seq_auditoria_p)
into STRICT	nr_seq_grupo_atual_w
;

select	nr_seq_grupo
into STRICT	nr_seq_grupo_auditor_w
from	pls_auditoria_grupo
where	nr_sequencia = nr_seq_grupo_atual_w;

if (qt_grupo_ordem_w > 1) then
	CALL pls_reorg_ordem_grupos_aud(nr_seq_ordem_w,nr_seq_auditoria_grupo_w,nr_seq_auditoria_p,nm_usuario_p);
end if;

begin
select	nr_seq_guia,
	nr_seq_requisicao,
	nr_seq_execucao
into STRICT	nr_seq_guia_w,
	nr_seq_requisicao_w,
	nr_seq_execucao_w
from	pls_auditoria
where	nr_sequencia	= nr_seq_auditoria_p;
exception
when others then
	nr_seq_guia_w		:= 0;
	nr_seq_requisicao_w	:= 0;
end;

select	max(nr_seq_grupo)
into STRICT	nr_seq_grupo_w
from	pls_auditoria_grupo
where	nr_sequencia	= nr_seq_auditoria_grupo_w;

ds_historico_w	:= 'O auditor ' || pls_obter_nome_usuario(nm_usuario_p) || ' encaminhou a análise para o grupo ' || substr(pls_obter_nome_grupo_auditor(nr_seq_grupo_w), 1, 120);

if	(ds_observacao_p IS NOT NULL AND ds_observacao_p::text <> '') then
	ds_observacao_w := 'Histórico de encaminhamento de auditoria do usuário ' || pls_obter_nome_usuario(nm_usuario_p) || ' :' || chr(13) ||
	ds_observacao_p;
end if;

if (coalesce(nr_seq_guia_w,0) <> 0) then
	CALL pls_guia_gravar_hist_analise(nr_seq_guia_w, nr_seq_grupo_auditor_w, null, ds_historico_w, null, nm_usuario_p);
	if	(ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
		insert	into pls_guia_plano_historico(nr_sequencia, nr_seq_guia, dt_historico,
			dt_atualizacao, nm_usuario, ds_observacao,
			ie_origem_historico, ie_tipo_historico, nr_seq_grupo)
		values (nextval('pls_guia_plano_historico_seq'), nr_seq_guia_w, clock_timestamp(),
			clock_timestamp(), nm_usuario_p, ds_observacao_w,
			'M', 'M', nr_seq_grupo_w);
	end if;
elsif (coalesce(nr_seq_requisicao_w,0) <> 0) then
	CALL pls_req_gravar_hist_analise(nr_seq_requisicao_w, nr_seq_grupo_auditor_w, 'L', ds_historico_w, null, nm_usuario_p);
	if	(ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
		CALL pls_req_gravar_hist_analise(nr_seq_requisicao_w, nr_seq_grupo_auditor_w, 'M', ds_observacao_w, null, nm_usuario_p);
	end if;
elsif (coalesce(nr_seq_execucao_w,0) <> 0) then
	select	nr_seq_requisicao
	into STRICT	nr_seq_requisicao_w
	from	pls_execucao_requisicao
	where	nr_sequencia	= nr_seq_execucao_w;

	CALL pls_req_gravar_hist_analise(nr_seq_requisicao_w, nr_seq_grupo_auditor_w, 'L', ds_historico_w, nr_seq_execucao_w, nm_usuario_p);
	if	(ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
		CALL pls_req_gravar_hist_analise(nr_seq_requisicao_w, nr_seq_grupo_auditor_w, 'M', ds_observacao_w, nr_seq_execucao_w, nm_usuario_p);
	end if;
end if;

begin
select	ie_tipo_auditoria
into STRICT	ie_tipo_auditoria_w
from	pls_grupo_auditor
where	nr_sequencia	= nr_seq_grupo_p;

if (ie_tipo_auditoria_w = 3) then
	update	pls_auditoria
	set	ie_auditoria_estipulante	= 'S'
	where	nr_sequencia 			= nr_seq_auditoria_p;
end if;
exception
when others then
	ie_tipo_auditoria_w	:= null;
end;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inserir_grupo_auditor ( nr_seq_grupo_p bigint, nr_seq_auditoria_p bigint, ds_observacao_p text, nm_usuario_p text, nr_ordem_p bigint default null) FROM PUBLIC;

