-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE send_nas_integration (nr_atendimento_p bigint, nr_sequencia_p bigint, dt_atualizacao_p timestamp, dt_avaliacao_p timestamp, dt_liberacao_p timestamp, ie_situacao_p text, ds_item_1a_p text, ds_item_1b_p text, ds_item_1c_p text, ds_item_2_p text, ds_item_3_p text, ds_item_4a_p text, ds_item_4b_p text, ds_item_4c_p text, ds_item_5_p text, ds_item_6a_p text, ds_item_6b_p text, ds_item_6c_p text, ds_item_7a_p text, ds_item_7b_p text, ds_item_8a_p text, ds_item_8b_p text, ds_item_8c_p text, ds_item_9_p text, ds_item_10_p text, ds_item_11_p text, ds_item_12_p text, ds_item_13_p text, ds_item_14_p text, ds_item_15_p text, ds_item_16_p text, ds_item_17_p text, ds_item_18_p text, ds_item_19_p text, ds_item_20_p text, ds_item_21_p text, ds_item_22_p text, ds_item_23_p text) AS $body$
DECLARE
	
					
client_id_w						escala_nas.nr_sequencia%type;
nm_user_w               		escala_nas.nm_usuario%type;
patient_id_w					atendimento_paciente.cd_pessoa_fisica%type;
hospital_admission_number_w		escala_nas.nr_atendimento%type;
last_update_timestamp_w			varchar(40);
nas_date_w						varchar(40);
message_date_w					varchar(40);
variable_identificator_w		varchar(10);
variable_description_w			varchar(100);
variable_value_w				varchar(5);
aux_identificator_w				varchar(100);
aux_description_w				varchar(2000);
aux_value_w						varchar(100);
delete_w						varchar(5);
separator_w						varchar(1) := '@';
ds_integracao_w					text;
establishment_id_w   smallint;

c01 CURSOR FOR	
	SELECT 	
		case
			when(ds_item_1a_p        = 'N' and
				ds_item_1b_p        = 'N' and
				ds_item_1c_p        = 'N')
			then obter_conversao_externa(null,'ESCALA_NAS','MONITORING_TITRATION', '1')
			when ds_item_1a_p = 'S'
			then obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_1A', ds_item_1a_p)
			when ds_item_1b_p = 'S'
			then obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_1B', ds_item_1b_p)
			when ds_item_1c_p = 'S'
			then obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_1C', ds_item_1c_p)
		end monitoring_titration,
		'Monitoracao e controle'
	
	
union all

	SELECT
		obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_2', ds_item_2_p) laboratory_investigations,
		'Investigacoes laboratoriais'
	
	
union all

	select
		obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_3', ds_item_3_p) medic_not_vasoactive_drugs,
		'Medicacao, exceto drogas vasoativas'
	
	
union all

	select
		case
			when(ds_item_4a_p = 'N' and
				ds_item_4b_p = 'N' and
				ds_item_4c_p = 'N')
			then obter_conversao_externa(null,'ESCALA_NAS','HYGIENE_PROCEDURES', '9')
			when ds_item_4a_p = 'S'
			then obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_4A', ds_item_4a_p)
			when ds_item_4b_p = 'S'
			then obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_4B', ds_item_4b_p)
			when ds_item_4c_p = 'S'
			then obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_4C', ds_item_4c_p)
		end hygiene_procedures,
		'Procedimentos de higiene'
	
	
union all

	select		
		obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_5', ds_item_5_p) care_drains,
		'Cuidados com drenos'
	
	
union all

	select			
		case
			when(ds_item_6a_p = 'N' and
				ds_item_6b_p = 'N' and
				ds_item_6c_p = 'N')
			then obter_conversao_externa(null,'ESCALA_NAS','MOBILIZATION_POSITIONING', '15')
			when ds_item_6a_p = 'S'
			then obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_6A', ds_item_6a_p)
			when ds_item_6b_p = 'S'
			then obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_6B', ds_item_6b_p)
			when ds_item_6c_p = 'S'
			then obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_6C', ds_item_6c_p)
		end mobilization_positioning,
		'Mobilizacao e posicionamento'
	
	
union all

	select			
		case
			when(ds_item_7a_p = 'N' and
				ds_item_7b_p = 'N' )
			then obter_conversao_externa(null,'ESCALA_NAS','SUPPORTCARE_RELATIVE_PATIENT', '19')
			when ds_item_7a_p = 'S'
			then obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_7A', ds_item_7a_p)
			when ds_item_7b_p = 'S'
			then obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_7B', ds_item_7b_p)
		end support_relative_patient,
		'Suporte e cuidados aos familiares e pacientes'
	
	
union all

	select			
		case
			when(ds_item_8a_p = 'N' and
				ds_item_8b_p = 'N' and
				ds_item_8c_p = 'N')
			then obter_conversao_externa(null,'ESCALA_NAS','ADMINISTRATIVE_TASKS', '22')
			when ds_item_8a_p = 'S'
			then obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_8A', ds_item_8a_p)
			when ds_item_8b_p = 'S'
			then obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_8B', ds_item_8b_p)
			when ds_item_8c_p = 'S'
			then obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_8C', ds_item_8c_p)
		end administrative_tasks,
		'Tarefas administrativas e gerenciais'
	
	
union all

	select			
		obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_9', ds_item_9_p) respiratory_support,
		'Suporte ventilatorio'
	
	
union all

	select			
		obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_10', ds_item_10_p) care_artificial_airways,
		'Cuidado com vias aereas artificiais (TOT e TQT)'
	
	
union all

	select			
		obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_11', ds_item_11_p) treatment_improving_lung_fnc,
		'Tratamento para funcao pulmonar'
	
	
union all

	select			
		obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_12', ds_item_12_p) vasoactive_medication,
		'Medicacao vasoativa'
	
	
union all

	select			
		obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_13', ds_item_13_p) iv_replacement_fluid_losses,
		'Reposicao IV de grandes perdas de fluidos'
	
	
union all

	select			
		obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_14', ds_item_14_p) monitoring_pac,
		'Monitoracao com cateter de Swan-Ganz'
	
	
union all

	select			
		obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_15', ds_item_15_p) cpr_in_past_24h,
		'RCP nas ultimas 24 hs'
	
	
union all

	select			
		obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_16', ds_item_16_p) rrt_dialysis_techniques,
		'Tecnicas de suporte renal'
	
	
union all

	select			
		obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_17', ds_item_17_p) urine_output_measurement,
		'Medida do debito urinario'
	
	
union all

	select			
		obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_18', ds_item_18_p) measure_intracranial_pressur,
		'Medida da PIC'
	
	
union all

	select			
		obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_19', ds_item_19_p) treatment_acidosis_alkalosis,
		'Tratamento da acidose - alcalose metabolica'
	
	
union all

	select			
		obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_20', ds_item_20_p) parenteral_nutrition,
		'Nutricao parenteral total'
	
	
union all

	select			
		obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_21', ds_item_21_p) enteral_gastric_feedinng,
		'Nutricao enteral'
	
	
union all

	select			
		obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_22', ds_item_22_p) interventions_icu,
		'Intervencoes especificas na UTI'
	
	
union all

	select			
		obter_conversao_externa(null,'ESCALA_NAS','DS_ITEM_23', ds_item_23_p) interventions_outside_icu_1,
		'Intervencoes especificas fora da UTI'
	;
	

BEGIN

if (obter_setor(obter_setor_atual_paciente(nr_atendimento_p)) is not null) and (dt_liberacao_p IS NOT NULL AND dt_liberacao_p::text <> '') then

	nm_user_w := WHEB_USUARIO_PCK.GET_NM_USUARIO;
	patient_id_w := OBTER_PESSOA_ATENDIMENTO(nr_atendimento_p,'C');
	client_id_w := nr_sequencia_p;
	hospital_admission_number_w := nr_atendimento_p;
	
	select CASE WHEN ie_situacao_p='I' THEN 1  ELSE 0 END
	into STRICT delete_w
	;
	

	open c01;
	loop
	fetch c01 into
		variable_identificator_w,
		variable_description_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (coalesce(aux_identificator_w::text, '') = '') then
		aux_identificator_w := variable_identificator_w;
		aux_description_w := variable_description_w;
	else
		aux_identificator_w := aux_identificator_w||separator_w||variable_identificator_w;
		aux_description_w := aux_description_w||separator_w||variable_description_w;
	end if;

	end;
	end loop;
	close c01;


	if (aux_identificator_w IS NOT NULL AND aux_identificator_w::text <> '') then
    select
      obter_estabelecimento_setor(obter_setor_atual_paciente(nr_atendimento_p))
    into STRICT
      establishment_id_w
;
	
		SELECT BIFROST.SEND_INTEGRATION( 'patientinformation.nas',
									'com.philips.tasy.integration.atepac.patientinformation.nas.Nas',
									'{ "nasDate" : "' || to_char(dt_avaliacao_p, 'yyyymmddhh24miss') ||'" ,'
									||'"patientId" : "' ||patient_id_w || '",'
                  ||'"establishmentId" : "'||establishment_id_w||'",'
									||'"hospitalAdmission" : "' ||hospital_admission_number_w || '",'
									||'"nasId" : "' || nr_sequencia_p ||'",'
									||'"updateTimeStamp" : "' || to_char(dt_atualizacao_p, 'yyyymmddhh24miss') ||'" ,'
									||'"delete" : "' || delete_w ||'" ,'
									||'"nasIdentificator" : "' || aux_identificator_w ||'" ,'
									||'"nasDescription" : "' || aux_description_w ||'"'
									||'}',
									nm_user_w)
		INTO STRICT DS_INTEGRACAO_W
		;

	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE send_nas_integration (nr_atendimento_p bigint, nr_sequencia_p bigint, dt_atualizacao_p timestamp, dt_avaliacao_p timestamp, dt_liberacao_p timestamp, ie_situacao_p text, ds_item_1a_p text, ds_item_1b_p text, ds_item_1c_p text, ds_item_2_p text, ds_item_3_p text, ds_item_4a_p text, ds_item_4b_p text, ds_item_4c_p text, ds_item_5_p text, ds_item_6a_p text, ds_item_6b_p text, ds_item_6c_p text, ds_item_7a_p text, ds_item_7b_p text, ds_item_8a_p text, ds_item_8b_p text, ds_item_8c_p text, ds_item_9_p text, ds_item_10_p text, ds_item_11_p text, ds_item_12_p text, ds_item_13_p text, ds_item_14_p text, ds_item_15_p text, ds_item_16_p text, ds_item_17_p text, ds_item_18_p text, ds_item_19_p text, ds_item_20_p text, ds_item_21_p text, ds_item_22_p text, ds_item_23_p text) FROM PUBLIC;

