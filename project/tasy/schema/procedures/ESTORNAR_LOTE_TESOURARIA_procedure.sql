-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE estornar_lote_tesouraria ( nr_seq_caixa_p bigint, nr_seq_lote_p bigint, nm_usuario_p text, ie_commit_p text, ds_observacao_p text) AS $body$
DECLARE


nr_sequencia_w			bigint;
nr_seq_movto_w			bigint;
nr_seq_movto_orig_w		bigint;
cd_estabelecimento_w		smallint;
nr_seq_lote_w			bigint;
ie_acao_w			smallint;
nr_seq_trans_financ_w		bigint;
ie_inverte_sinal_w		varchar(1):= 'S';
nr_titulo_w			bigint;
nr_seq_baixa_w			integer;
cd_tipo_recebimento_w		integer;
nr_seq_caixa_rec_w		bigint;
vl_transacao_w			double precision;
cd_empresa_w			bigint;
cont_w				bigint;
nr_seq_saldo_caixa_w		bigint;
dt_saldo_caixa_w		timestamp;
dt_recebimento_w		timestamp;
nr_seq_nova_baixa_w		integer;
ie_caixa_w			varchar(2);
nr_seq_movto_transferido_w	bigint;
nr_seq_movto_transf_w		bigint;
nr_seq_trans_dev_adiant_w	bigint;
ie_estorna_transf_w		varchar(255);
nr_seq_movto_pend_w		bigint;
vl_movto_pend_baixa_w		double precision;
nr_seq_trans_dev_receb_w	bigint;
cd_cgc_w			varchar(14);
cd_pessoa_fisica_w		varchar(10);
ie_transf_estornado_w		varchar(1);
nr_documento_w			varchar(22);
cd_centro_custo_w		integer;
dt_transacao_w			timestamp;
nr_seq_caixa_rec_bx_w		titulo_receber_liq.nr_seq_caixa_rec%type;
nr_seq_liq_origem_w		titulo_receber_liq.nr_seq_liq_origem%type;
/* Projeto Multimoeda - Variaveis */

vl_transacao_estrang_w		double precision;
vl_complemento_w		double precision;
vl_cotacao_w			cotacao_moeda.vl_cotacao%type;
cd_moeda_w			integer;
ie_dev_adiant_negativo_w	transacao_financeira.ie_dev_adiant_negativo%type;
qt_transacoes_w			bigint;
ie_estornar_movto_liq_w		varchar(1);
dt_fechamento_w				caixa_saldo_diario.dt_fechamento%type;

c01 CURSOR FOR
SELECT	a.nr_sequencia,
		a.nr_seq_movto_transf
from	transacao_financeira b,
		movto_trans_financ a
where	a.nr_seq_trans_financ	= b.nr_sequencia
and		a.nr_seq_lote  		= nr_seq_lote_p
and		a.nr_seq_caixa 		= nr_seq_caixa_p
and		((b.ie_acao not(1,99) and (a.nr_seq_caixa_rec IS NOT NULL AND a.nr_seq_caixa_rec::text <> '')) or (coalesce(a.nr_seq_caixa_rec::text, '') = ''));

c02 CURSOR FOR
SELECT	nr_titulo,
	nr_sequencia
from	titulo_receber_liq
where	nr_seq_caixa_rec 		= nr_seq_caixa_rec_w;


BEGIN

select	count(*)
into STRICT	cont_w
from	movto_trans_financ
where	nr_seq_lote_origem	= nr_seq_lote_p
and	nr_seq_caixa		= nr_seq_caixa_p;

if (cont_w > 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(217891); /*'Este lote ja foi estornado!'*/
end if;

select	coalesce(max(nr_seq_lote),0) + 1
into STRICT	nr_seq_lote_w
from	movto_trans_financ
where	nr_seq_caixa 		= nr_seq_caixa_p;

select	cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	caixa
where	nr_sequencia		= nr_seq_caixa_p;

select	cd_empresa
into STRICT	cd_empresa_w
from	estabelecimento
where	cd_estabelecimento	= cd_estabelecimento_w;

select	max(nr_seq_caixa_rec),
	max(cd_cgc),
	max(cd_pessoa_fisica),
	max(nr_sequencia)
into STRICT	nr_seq_caixa_rec_w,
	cd_cgc_w,
	cd_pessoa_fisica_w,
	nr_seq_movto_orig_w
from	movto_trans_financ
where	nr_seq_caixa		= nr_seq_caixa_p
and	nr_seq_lote		= nr_seq_lote_p;

/*Inicio tratativa OS 980871 - Nao deixar estornar quando tiver vinculo com movimentos de cartoes e estes estierem liquidados*/

select	count(*)
into STRICT	qt_transacoes_w
from   	movto_trans_financ a,
		transacao_financeira b,
		movto_cartao_cr c
where  	a.nr_seq_trans_financ = b.nr_sequencia
and	   	a.nr_seq_movto_cartao = c.nr_sequencia
and	   	a.nr_seq_lote		 = nr_seq_lote_p
and	   	a.nr_seq_caixa		 = nr_seq_caixa_p
and	   	(a.nr_seq_movto_cartao IS NOT NULL AND a.nr_seq_movto_cartao::text <> '')
and		(c.dt_baixa IS NOT NULL AND c.dt_baixa::text <> '');

ie_estornar_movto_liq_w := obter_param_usuario(813, 204, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_estornar_movto_liq_w);

if (qt_transacoes_w > 0) and (coalesce(ie_estornar_movto_liq_w,'S') = 'N') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(389278); /*Esta transacao nao podera ser estornarda pois o movimento do cartao ja esta liquidado. Parametro [204]*/
end if;
/*Fim OS 980871*/

ie_estorna_transf_w := obter_param_usuario(813, 104, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_estorna_transf_w);
ie_transf_estornado_w := obter_param_usuario(813, 170, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_transf_estornado_w);

open c01;
loop
fetch c01 into
	nr_seq_movto_w,
	nr_seq_movto_transf_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	select 	max(nr_seq_saldo_caixa)
	into STRICT 	nr_seq_saldo_caixa_w
	from 	movto_trans_financ
	where 	nr_sequencia = nr_seq_movto_transf_w;
	
	if (nr_seq_saldo_caixa_w IS NOT NULL AND nr_seq_saldo_caixa_w::text <> '') then
		select 	dt_fechamento
		into STRICT 	dt_fechamento_w
		from 	caixa_saldo_diario
		where 	nr_sequencia = nr_seq_saldo_caixa_w;
		
		if (dt_fechamento_w IS NOT NULL AND dt_fechamento_w::text <> '') then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(135892); /*'Nao foi possivel estornar o lote, o saldo ja foi fechado!'*/
		end if;
	end if;

	ie_inverte_sinal_w	:= 'S';

	select	nextval('movto_trans_financ_seq')
	into STRICT	nr_sequencia_w
	;

	select	b.nr_sequencia,
		b.ie_acao,
		b.ie_caixa,
		b.nr_seq_trans_dev_adiant,
		b.nr_seq_trans_dev_receb,
		coalesce(a.ie_dev_adiant_negativo,'N')
	into STRICT	nr_seq_trans_financ_w,
		ie_acao_w,
		ie_caixa_w,
		nr_seq_trans_dev_adiant_w,
		nr_seq_trans_dev_receb_w,
		ie_dev_adiant_negativo_w
	from	transacao_financeira b,
		movto_trans_financ a
	where	a.nr_seq_trans_financ	= b.nr_sequencia
	and	a.nr_sequencia		= nr_seq_movto_w;

	if (ie_acao_w = 3) then -- francisco - 22/01/07 - estornar adiantamento
		ie_inverte_sinal_w	:= 'N';

		if (coalesce(coalesce(nr_seq_trans_dev_receb_w,nr_seq_trans_dev_adiant_w)::text, '') = '') then

			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_seq_trans_financ_w
			from	transacao_financeira
			where	ie_situacao 		= 'A'
			and	cd_empresa 		= cd_empresa_w
			and (coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w)
			/*and	ie_caixa		= 'D' francisco - 28/10/2008 tem cliente que lanca o recebimento de adiant em mon+doc */

			and	ie_saldo_caixa		= 'S'
			and	ie_acao 		= 4;

			if (nr_seq_trans_financ_w = 0) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(217892); /*'Transacao de devolucao de adiantamento nao cadastrada!'*/
			end if;
		else
			nr_seq_trans_financ_w	:= coalesce(nr_seq_trans_dev_receb_w,nr_seq_trans_dev_adiant_w);
		end if;
		
		/*Essa tratativa foi feita para o Marcio Cunha na OS 892302, para que no cancelamento do recebimento nao seja lancada devolucao do adiantamento
		com transacao diferente e com valor positivo, e sim com a mesma TF e com valor positivo.*/
		if ( coalesce(ie_dev_adiant_negativo_w,'N') = 'S' )  then
		
			ie_inverte_sinal_w := 'S'; /*deve inverter o sinal para lancar a TF com valor negativo.*/
			
			select	max(b.nr_sequencia)
			into STRICT	nr_seq_trans_financ_w
			from	transacao_financeira b,
					movto_trans_financ a
			where	a.nr_seq_trans_financ	= b.nr_sequencia
			and		a.nr_sequencia			= nr_seq_movto_w;
			
		end if;

	end if;

	insert into movto_trans_financ(nr_sequencia,
		dt_transacao,
		nr_seq_trans_financ,
		vl_transacao,
		dt_atualizacao,
		nm_usuario,
		vl_recebido,
		nr_seq_banco,
		nr_seq_caixa,
		cd_pessoa_fisica,
		cd_cgc,
		nr_seq_titulo_pagar,
		nr_seq_titulo_receber,
		nr_bordero,
		nr_adiantamento,
		nr_seq_banco_od,
		nr_seq_caixa_od,
		cd_conta_contabil,
		cd_centro_custo,
		nr_seq_nota_fiscal,
		nr_interno_conta,
		nr_documento,
		ds_historico,
		dt_referencia_saldo,
		nr_seq_lote,
		dt_fechamento_lote,
		cd_tipo_recebimento,
		cd_tipo_baixa_cpa,
		nr_seq_cheque,
		nr_seq_conv_receb,
		nr_seq_deposito,
		nr_seq_saldo_caixa,
		nr_seq_saldo_banco,
		nr_seq_banco_escrit,
		dt_autenticacao,
		nr_lote_contabil,
		nr_seq_concil,
		nr_adiant_pago,
		ie_conciliacao,
		nr_seq_cheque_cp,
		ie_origem_lancamento,
		cd_historico,
		nr_bordero_rec,
		nr_seq_movto_cartao,
		nr_seq_motivo_dev,
		nr_seq_caixa_rec,
		ie_estorno,
		nr_seq_lote_origem,
		ds_observacao,
		cd_conta_financ,
		nr_seq_movto_orig,
		vl_transacao_estrang,
		vl_complemento,
		vl_cotacao,
		cd_moeda,
		ie_dev_adiant_negativo,
    nr_seq_lote_cartao)
	SELECT	nr_sequencia_w,
		dt_transacao,
		nr_seq_trans_financ_w,
		CASE WHEN ie_inverte_sinal_w='S' THEN vl_transacao * -1  ELSE vl_transacao * 1 END ,
		clock_timestamp(),
		nm_usuario_p,
		vl_recebido,
		nr_seq_banco,
		nr_seq_caixa,
		cd_pessoa_fisica,
		cd_cgc,
		nr_seq_titulo_pagar,
		nr_seq_titulo_receber,
		nr_bordero,
		nr_adiantamento,
		nr_seq_banco_od,
		nr_seq_caixa_od,
		cd_conta_contabil,
		cd_centro_custo,
		nr_seq_nota_fiscal,
		nr_interno_conta,
		nr_documento,
		ds_historico,
		dt_referencia_saldo,
		nr_seq_lote_w,
		null,
		cd_tipo_recebimento,
		cd_tipo_baixa_cpa,
		nr_seq_cheque,
		nr_seq_conv_receb,
		nr_seq_deposito,
		nr_seq_saldo_caixa,
		nr_seq_saldo_banco,
		nr_seq_banco_escrit,
		dt_autenticacao,
		nr_lote_contabil,
		nr_seq_concil,
		nr_adiant_pago,
		ie_conciliacao,
		nr_seq_cheque_cp,
		ie_origem_lancamento,
		cd_historico,
		nr_bordero_rec,
		nr_seq_movto_cartao,
		nr_seq_motivo_dev,
		CASE WHEN ie_acao_w=1 THEN nr_seq_caixa_rec  ELSE CASE WHEN ie_caixa_w='M' THEN nr_seq_caixa_rec  ELSE null END  END , -- so deve gravar se for baixa
		'E',
		nr_seq_lote_p,
		ds_observacao_p,
		cd_conta_financ,
		nr_sequencia,
		CASE WHEN coalesce(vl_transacao_estrang,0)=0 THEN null  ELSE CASE WHEN ie_inverte_sinal_w='S' THEN vl_transacao_estrang * -1  ELSE vl_transacao_estrang * 1 END  END ,
		CASE WHEN coalesce(vl_transacao_estrang,0)=0 THEN null  ELSE CASE WHEN ie_inverte_sinal_w='S' THEN vl_complemento * -1  ELSE vl_complemento * 1 END  END ,
		CASE WHEN coalesce(vl_cotacao,0)=0 THEN null  ELSE vl_cotacao END ,
		cd_moeda,
		ie_dev_adiant_negativo_w,
    nr_seq_lote_cartao
	from	movto_trans_financ
	where	nr_sequencia = nr_seq_movto_w;

	if ( coalesce(ie_transf_estornado_w,'N') = 'S') then/*aamfirmo OS 560509 18/03/2013 apresentar novamente a TF para transferencia. */
		update	movto_trans_financ
		set	nr_seq_movto_transf  = NULL
		where	nr_seq_movto_transf = nr_seq_movto_w;
	end if;
	
	/* ahoffelder - os 323609 - 21/06/2011 - para identificar que o movimento foi estornado */

	update	movto_trans_financ
	set	ie_estorno	= 'O'
	where	nr_sequencia	= nr_seq_movto_w;

	select	max(a.nr_seq_movto_pend),
		max(a.vl_baixa)
	into STRICT	nr_seq_movto_pend_w,
		vl_movto_pend_baixa_w
	from	movto_banco_pend_baixa a
	where	a.nr_seq_movto_trans_fin	= nr_seq_movto_w;

	if (nr_seq_movto_pend_w IS NOT NULL AND nr_seq_movto_pend_w::text <> '') then	/* ahoffelder - os 312671 - 25/04/2011 */
		select	max(dt_transacao) /*aamfirmo OS 784391 data do estorno no CNI com a mesma data do estorno no lote da Tesouraria */
		into STRICT	dt_transacao_w
		from	movto_trans_financ
		where	nr_sequencia = nr_seq_movto_w;
		
		CALL baixar_movto_banco_pend(	nr_seq_movto_pend_w,
						coalesce(dt_transacao_w,clock_timestamp()),
						vl_movto_pend_baixa_w * -1,
						null,
						null,
						nm_usuario_p,
						'N',
						null,
						null,
						null,
						null,
						null,
						nr_sequencia_w,
						null,
						null);

	end if;

	if (coalesce(ie_estorna_transf_w, 'N') = 'S') then

		if (nr_seq_movto_transf_w IS NOT NULL AND nr_seq_movto_transf_w::text <> '') then

			select	b.nr_sequencia,
				b.ie_acao,
				b.ie_caixa,
				b.nr_seq_trans_dev_adiant,
				b.nr_seq_trans_dev_receb
			into STRICT	nr_seq_trans_financ_w,
				ie_acao_w,
				ie_caixa_w,
				nr_seq_trans_dev_adiant_w,
				nr_seq_trans_dev_receb_w
			from	transacao_financeira b,
				movto_trans_financ a
			where	a.nr_seq_trans_financ	= b.nr_sequencia
			and	a.nr_sequencia		= nr_seq_movto_transf_w;

			if (ie_acao_w = 3) then -- francisco - 22/01/07 - estornar adiantamento
				ie_inverte_sinal_w	:= 'N';

				if (coalesce(coalesce(nr_seq_trans_dev_receb_w,nr_seq_trans_dev_adiant_w)::text, '') = '') then

					select	coalesce(max(nr_sequencia),0)
					into STRICT	nr_seq_trans_financ_w
					from	transacao_financeira
					where	ie_situacao 		= 'A'
					and	cd_empresa 		= cd_empresa_w
					and (coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w)
					/*and	ie_caixa		= 'D' francisco - 28/10/2008 tem cliente que lanca o recebimento de adiant em mon+doc */

					and	ie_saldo_caixa		= 'S'
					and	ie_acao 		= 4;

					if (nr_seq_trans_financ_w = 0) then
						CALL wheb_mensagem_pck.exibir_mensagem_abort(217892); /*'Transacao de devolucao de adiantamento nao cadastrada!'*/
					end if;
				else
					nr_seq_trans_financ_w	:= coalesce(nr_seq_trans_dev_adiant_w,nr_seq_trans_dev_receb_w);
				end if;
				/*Essa tratativa foi feita para o Marcio Cunha na OS 892302, para que no cancelamento do recebimento nao seja lancada devolucao do adiantamento
				com transacao diferente e com valor positivo, e sim com a mesma TF e com valor positivo.*/
				if ( coalesce(ie_dev_adiant_negativo_w,'N') = 'S' )  then
				
					ie_inverte_sinal_w := 'S'; /*deve inverter o sinal para lancar a TF com valor negativo.*/
					
					select	max(b.nr_sequencia)
					into STRICT	nr_seq_trans_financ_w
					from	transacao_financeira b,
							movto_trans_financ a
					where	a.nr_seq_trans_financ	= b.nr_sequencia
					and		a.nr_sequencia			= nr_seq_movto_w;
					
				end if;
				
			end if;

			select	nextval('movto_trans_financ_seq')
			into STRICT	nr_sequencia_w
			;

			insert into movto_trans_financ(nr_sequencia,
				dt_transacao,
				nr_seq_trans_financ,
				vl_transacao,
				dt_atualizacao,
				nm_usuario,
				vl_recebido,
				nr_seq_banco,
				nr_seq_caixa,
				cd_pessoa_fisica,
				cd_cgc,
				nr_seq_titulo_pagar,
				nr_seq_titulo_receber,
				nr_bordero,
				nr_adiantamento,
				nr_seq_banco_od,
				nr_seq_caixa_od,
				cd_conta_contabil,
				cd_centro_custo,
				nr_seq_nota_fiscal,
				nr_interno_conta,
				nr_documento,
				ds_historico,
				dt_referencia_saldo,
				nr_seq_lote,
				dt_fechamento_lote,
				cd_tipo_recebimento,
				cd_tipo_baixa_cpa,
				nr_seq_cheque,
				nr_seq_conv_receb,
				nr_seq_deposito,
				nr_seq_saldo_caixa,
				nr_seq_saldo_banco,
				nr_seq_banco_escrit,
				dt_autenticacao,
				nr_lote_contabil,
				nr_seq_concil,
				nr_adiant_pago,
				ie_conciliacao,
				nr_seq_cheque_cp,
				ie_origem_lancamento,
				cd_historico,
				nr_bordero_rec,
				nr_seq_movto_cartao,
				nr_seq_motivo_dev,
				nr_seq_caixa_rec,
				ie_estorno,
				nr_seq_lote_origem,
				ds_observacao,
				cd_conta_financ,
				nr_seq_movto_orig,
				vl_transacao_estrang,
				vl_complemento,
				vl_cotacao,
				cd_moeda,
				ie_dev_adiant_negativo,
        nr_seq_lote_cartao)
			SELECT	nr_sequencia_w,
				dt_transacao,
				nr_seq_trans_financ_w,
				CASE WHEN ie_inverte_sinal_w='S' THEN vl_transacao * -1  ELSE vl_transacao * 1 END ,
				clock_timestamp(),
				nm_usuario_p,
				vl_recebido,
				nr_seq_banco,
				nr_seq_caixa,
				cd_pessoa_fisica,
				cd_cgc,
				nr_seq_titulo_pagar,
				nr_seq_titulo_receber,
				nr_bordero,
				nr_adiantamento,
				nr_seq_banco_od,
				nr_seq_caixa_od,
				cd_conta_contabil,
				cd_centro_custo,
				nr_seq_nota_fiscal,
				nr_interno_conta,
				nr_documento,
				ds_historico,
				dt_referencia_saldo,
				nr_seq_lote,
				dt_fechamento_lote,
				cd_tipo_recebimento,
				cd_tipo_baixa_cpa,
				nr_seq_cheque,
				nr_seq_conv_receb,
				nr_seq_deposito,
				nr_seq_saldo_caixa,
				nr_seq_saldo_banco,
				nr_seq_banco_escrit,
				dt_autenticacao,
				nr_lote_contabil,
				nr_seq_concil,
				nr_adiant_pago,
				ie_conciliacao,
				nr_seq_cheque_cp,
				ie_origem_lancamento,
				cd_historico,
				nr_bordero_rec,
				nr_seq_movto_cartao,
				nr_seq_motivo_dev,
				CASE WHEN ie_acao_w=1 THEN nr_seq_caixa_rec  ELSE CASE WHEN ie_caixa_w='M' THEN nr_seq_caixa_rec  ELSE null END  END ,
				'E',
				nr_seq_lote_p,
				ds_observacao_p,
				cd_conta_financ,
				nr_sequencia,
				CASE WHEN coalesce(vl_transacao_estrang,0)=0 THEN null  ELSE CASE WHEN ie_inverte_sinal_w='S' THEN vl_transacao_estrang * -1  ELSE vl_transacao_estrang * 1 END  END ,
				CASE WHEN coalesce(vl_transacao_estrang,0)=0 THEN null  ELSE CASE WHEN ie_inverte_sinal_w='S' THEN vl_complemento * -1  ELSE vl_complemento * 1 END  END ,
				CASE WHEN coalesce(vl_cotacao,0)=0 THEN null  ELSE vl_cotacao END ,
				cd_moeda,
				ie_dev_adiant_negativo_w,
        nr_seq_lote_cartao
			from	movto_trans_financ
			where	nr_sequencia = nr_seq_movto_transf_w;

			if ( coalesce(ie_transf_estornado_w,'N') = 'S') then/*aamfirmo OS 560509 18/03/2013 apresentar novamente a TF para transferencia. */
				update	movto_trans_financ
				set	nr_seq_movto_transf  = NULL
				where	nr_seq_movto_transf = nr_seq_movto_w;
			end if;
			
		else

			select	max(nr_sequencia)
			into STRICT	nr_seq_movto_transferido_w
			from	movto_trans_financ
			where	nr_seq_movto_transf	= nr_seq_movto_w;

			if (nr_seq_movto_transferido_w IS NOT NULL AND nr_seq_movto_transferido_w::text <> '') then

				select	b.nr_sequencia,
					b.ie_acao,
					b.ie_caixa,
					b.nr_seq_trans_dev_adiant,
					b.nr_seq_trans_dev_receb
				into STRICT	nr_seq_trans_financ_w,
					ie_acao_w,
					ie_caixa_w,
					nr_seq_trans_dev_adiant_w,
					nr_seq_trans_dev_receb_w
				from	transacao_financeira b,
					movto_trans_financ a
				where	a.nr_seq_trans_financ	= b.nr_sequencia
				and	a.nr_sequencia		= nr_seq_movto_transferido_w;

				if (ie_acao_w = 3) then -- francisco - 22/01/07 - estornar adiantamento
					ie_inverte_sinal_w	:= 'N';

					if (coalesce(coalesce(nr_seq_trans_dev_receb_w,nr_seq_trans_dev_adiant_w)::text, '') = '') then

						select	coalesce(max(nr_sequencia),0)
						into STRICT	nr_seq_trans_financ_w
						from	transacao_financeira
						where	ie_situacao 		= 'A'
						and	cd_empresa 		= cd_empresa_w
						and (coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w)
						/*and	ie_caixa		= 'D' francisco - 28/10/2008 tem cliente que lanca o recebimento de adiant em mon+doc */

						and	ie_saldo_caixa		= 'S'
						and	ie_acao 		= 4;

						if (nr_seq_trans_financ_w = 0) then
							CALL wheb_mensagem_pck.exibir_mensagem_abort(217892); /*'Transacao de devolucao de adiantamento nao cadastrada!'*/
						end if;
					else
						nr_seq_trans_financ_w	:= coalesce(nr_seq_trans_dev_receb_w,nr_seq_trans_dev_adiant_w);
					end if;
					/*Essa tratativa foi feita para o Marcio Cunha na OS 892302, para que no cancelamento do recebimento nao seja lancada devolucao do adiantamento
					com transacao diferente e com valor positivo, e sim com a mesma TF e com valor positivo.*/
					if ( coalesce(ie_dev_adiant_negativo_w,'N') = 'S' )  then
					
						ie_inverte_sinal_w := 'S'; /*deve inverter o sinal para lancar a TF com valor negativo.*/
						
						select	max(b.nr_sequencia)
						into STRICT	nr_seq_trans_financ_w
						from	transacao_financeira b,
								movto_trans_financ a
						where	a.nr_seq_trans_financ	= b.nr_sequencia
						and		a.nr_sequencia			= nr_seq_movto_w;
						
					end if;
				end if;

				select	nextval('movto_trans_financ_seq')
				into STRICT	nr_sequencia_w
				;

				insert into movto_trans_financ(nr_sequencia,
					dt_transacao,
					nr_seq_trans_financ,
					vl_transacao,
					dt_atualizacao,
					nm_usuario,
					vl_recebido,
					nr_seq_banco,
					nr_seq_caixa,
					cd_pessoa_fisica,
					cd_cgc,
					nr_seq_titulo_pagar,
					nr_seq_titulo_receber,
					nr_bordero,
					nr_adiantamento,
					nr_seq_banco_od,
					nr_seq_caixa_od,
					cd_conta_contabil,
					cd_centro_custo,
					nr_seq_nota_fiscal,
					nr_interno_conta,
					nr_documento,
					ds_historico,
					dt_referencia_saldo,
					nr_seq_lote,
					dt_fechamento_lote,
					cd_tipo_recebimento,
					cd_tipo_baixa_cpa,
					nr_seq_cheque,
					nr_seq_conv_receb,
					nr_seq_deposito,
					nr_seq_saldo_caixa,
					nr_seq_saldo_banco,
					nr_seq_banco_escrit,
					dt_autenticacao,
					nr_lote_contabil,
					nr_seq_concil,
					nr_adiant_pago,
					ie_conciliacao,
					nr_seq_cheque_cp,
					ie_origem_lancamento,
					cd_historico,
					nr_bordero_rec,
					nr_seq_movto_cartao,
					nr_seq_motivo_dev,
					nr_seq_caixa_rec,
					ie_estorno,
					nr_seq_lote_origem,
					ds_observacao,
					cd_conta_financ,
					nr_seq_movto_orig,
					vl_transacao_estrang,
					vl_complemento,
					vl_cotacao,
					cd_moeda,
					ie_dev_adiant_negativo,
          nr_seq_lote_cartao)
				SELECT	nr_sequencia_w,
					dt_transacao,
					nr_seq_trans_financ_w,
					CASE WHEN ie_inverte_sinal_w='S' THEN vl_transacao * -1  ELSE vl_transacao * 1 END ,
					clock_timestamp(),
					nm_usuario_p,
					vl_recebido,
					nr_seq_banco,
					nr_seq_caixa,
					cd_pessoa_fisica,
					cd_cgc,
					nr_seq_titulo_pagar,
					nr_seq_titulo_receber,
					nr_bordero,
					nr_adiantamento,
					nr_seq_banco_od,
					nr_seq_caixa_od,
					cd_conta_contabil,
					cd_centro_custo,
					nr_seq_nota_fiscal,
					nr_interno_conta,
					nr_documento,
					ds_historico,
					dt_referencia_saldo,
					nr_seq_lote,
					dt_fechamento_lote,
					cd_tipo_recebimento,
					cd_tipo_baixa_cpa,
					nr_seq_cheque,
					nr_seq_conv_receb,
					nr_seq_deposito,
					nr_seq_saldo_caixa,
					nr_seq_saldo_banco,
					nr_seq_banco_escrit,
					dt_autenticacao,
					nr_lote_contabil,
					nr_seq_concil,
					nr_adiant_pago,
					ie_conciliacao,
					nr_seq_cheque_cp,
					ie_origem_lancamento,
					cd_historico,
					nr_bordero_rec,
					nr_seq_movto_cartao,
					nr_seq_motivo_dev,
					CASE WHEN ie_acao_w=1 THEN nr_seq_caixa_rec  ELSE CASE WHEN ie_caixa_w='M' THEN nr_seq_caixa_rec  ELSE null END  END , -- so deve gravar se for baixa
					'E',
					nr_seq_lote_p,
					ds_observacao_p,
					cd_conta_financ,
					nr_sequencia,
					CASE WHEN coalesce(vl_transacao_estrang,0)=0 THEN null  ELSE CASE WHEN ie_inverte_sinal_w='S' THEN vl_transacao_estrang * -1  ELSE vl_transacao_estrang * 1 END  END ,
					CASE WHEN coalesce(vl_transacao_estrang,0)=0 THEN null  ELSE CASE WHEN ie_inverte_sinal_w='S' THEN vl_complemento * -1  ELSE vl_complemento * 1 END  END ,
					CASE WHEN coalesce(vl_cotacao,0)=0 THEN null  ELSE vl_cotacao END ,
					cd_moeda,
					ie_dev_adiant_negativo_w,
          nr_seq_lote_cartao
				from	movto_trans_financ
				where	nr_sequencia	= nr_seq_movto_transferido_w;
				
				if ( coalesce(ie_transf_estornado_w,'N') = 'S') then/*aamfirmo OS 560509 18/03/2013 apresentar novamente a TF para transferencia. */
					update	movto_trans_financ
					set	nr_seq_movto_transf  = NULL
					where	nr_seq_movto_transf = nr_seq_movto_w;
				end if;

			end if;
		end if;
	end if;

end loop;
close c01;

/* estornar as baixas e lancar movimentacoes separadamente se for recebimento de caixa */

if (nr_seq_caixa_rec_w IS NOT NULL AND nr_seq_caixa_rec_w::text <> '') then
	select	b.nr_sequencia,
		b.dt_saldo,
		a.dt_recebimento
	into STRICT	nr_seq_saldo_caixa_w,
		dt_saldo_caixa_w,
		dt_recebimento_w
	from	caixa_saldo_diario b,
		caixa_receb a
	where	a.nr_seq_saldo_caixa	= b.nr_sequencia
	and	a.nr_sequencia		= nr_seq_caixa_rec_w;

	open c02;
	loop
	fetch c02 into
		nr_titulo_w,
		nr_seq_baixa_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */

		select	nr_seq_trans_caixa,
			(vl_recebido + coalesce(vl_juros,0) + coalesce(vl_multa,0) + coalesce(vl_despesa_bancaria,0) + coalesce(vl_rec_maior,0)) * -1,
			cd_tipo_recebimento,
			nr_documento,
			cd_centro_custo,
			vl_recebido_estrang,
			vl_cotacao,
			cd_moeda
		into STRICT	nr_seq_trans_financ_w,
			vl_transacao_w,
			cd_tipo_recebimento_w,
			nr_documento_w,
			cd_centro_custo_w,
			vl_transacao_estrang_w,
			vl_cotacao_w,
			cd_moeda_w
		from	titulo_receber_liq
		where	nr_titulo	= nr_titulo_w
		and	nr_sequencia	= nr_seq_baixa_w;

		select	nextval('movto_trans_financ_seq')
		into STRICT	nr_sequencia_w
		;
		
		/* Projeto Multimoeda - Verifica se a baixa e em moeda estrangeira, caso positivo calcula os valores antes de gravar a transacao */

		if (coalesce(vl_transacao_estrang_w,0) <> 0 and coalesce(vl_cotacao_w,0) <> 0) then
			vl_transacao_estrang_w := vl_transacao_estrang_w * -1;
			vl_complemento_w := vl_transacao_w - vl_transacao_estrang_w;
		else
			vl_transacao_estrang_w := null;
			vl_complemento_w := null;
			vl_cotacao_w := null;
			cd_moeda_w := null;
		end if;

		insert	into movto_trans_financ(nr_sequencia,
			dt_transacao,
			nr_seq_trans_financ,
			vl_transacao,
			dt_atualizacao,
			nm_usuario,
			nr_lote_contabil,
			ie_conciliacao,
			nr_seq_caixa_rec,
			nr_seq_caixa,
			nr_seq_saldo_caixa,
			dt_referencia_saldo,
			nr_seq_lote,
			nr_seq_titulo_receber,
			cd_tipo_recebimento,
			nr_seq_lote_origem,
			ds_observacao,
			cd_cgc,
			cd_pessoa_fisica,
			ie_estorno,
			nr_documento,
			cd_centro_custo,
			nr_seq_movto_orig,
			vl_transacao_estrang,
			vl_complemento,
			vl_cotacao,
			cd_moeda,
			ie_dev_adiant_negativo)
		values (nr_sequencia_w,
			dt_recebimento_w,
			nr_seq_trans_financ_w,
			vl_transacao_w,
			clock_timestamp(),
			nm_usuario_p,
			0,
			'N',
			nr_seq_caixa_rec_w,
			nr_seq_caixa_p,
			nr_seq_saldo_caixa_w,
			dt_saldo_caixa_w,
			nr_seq_lote_w,
			nr_titulo_w,
			cd_tipo_recebimento_w,
			nr_seq_lote_p,
			ds_observacao_p,
			cd_cgc_w,
			cd_pessoa_fisica_w,
			'E',
			nr_documento_w,
			cd_centro_custo_w,
			nr_seq_movto_orig_w,
			vl_transacao_estrang_w,
			vl_complemento_w,
			vl_cotacao_w,
			cd_moeda_w,
			ie_dev_adiant_negativo_w);

		CALL estornar_tit_receber_liq(nr_titulo_w,nr_seq_baixa_w,null,nm_usuario_p,'N',null,'S');

		select	max(nr_sequencia)
		into STRICT	nr_seq_nova_baixa_w
		from	titulo_receber_liq
		where	nr_titulo	= nr_titulo_w;
		
		if (nr_seq_nova_baixa_w IS NOT NULL AND nr_seq_nova_baixa_w::text <> '') then
		
				select	max(a.nr_seq_liq_origem)
				into STRICT	nr_seq_liq_origem_w
				from	titulo_receber_liq a
				where	a.nr_titulo	= nr_titulo_w
				and	a.nr_sequencia	= nr_seq_nova_baixa_w;
				
				if (nr_seq_liq_origem_w IS NOT NULL AND nr_seq_liq_origem_w::text <> '') then
		
					select	max(a.nr_seq_caixa_rec)
					into STRICT	nr_seq_caixa_rec_bx_w
					from	titulo_receber_liq a
					where	a.nr_sequencia = nr_seq_liq_origem_w
					and		a.nr_titulo	   = nr_titulo_w;
					
				end if;
		end if;

		update	titulo_receber_liq
		set	nr_seq_movto_trans_fin	= nr_sequencia_w,
			nr_seq_caixa_rec		= CASE WHEN nr_seq_caixa_rec = NULL THEN CASE WHEN nr_seq_caixa_rec_bx_w = NULL THEN null  ELSE nr_seq_caixa_rec_bx_w END  END
		where	nr_titulo			= nr_titulo_w
		and	nr_sequencia			= nr_seq_nova_baixa_w;
		
	end loop;
	close c02;
end if;

CALL atualizar_saldo_caixa(cd_estabelecimento_w,
			 nr_seq_lote_w,
			 nr_seq_caixa_p,
			 nm_usuario_p,
			 'N');

if (ie_commit_p = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE estornar_lote_tesouraria ( nr_seq_caixa_p bigint, nr_seq_lote_p bigint, nm_usuario_p text, ie_commit_p text, ds_observacao_p text) FROM PUBLIC;

