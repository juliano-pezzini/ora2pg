-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE db_sort_workflow_templ_items ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_ordem_w		db_workflow_template_item.nr_seq_ordem%type := 0;

c01 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.nr_seq_doc_template,
		a.ds_prefixo_id,
		a.ie_obrigatorio
	from	db_document_template b,
		db_workflow_template_item a
	where	b.nr_sequencia = a.nr_seq_doc_template
	and	a.nr_seq_wf_template = nr_sequencia_p
	and not exists (SELECT	1
			from	db_wf_templ_item_predec x
			where	x.nr_seq_item = a.nr_sequencia)
	order by a.ie_obrigatorio desc,
		b.ds_template;

procedure db_sort_child_items(
			nr_seq_doc_template_p	bigint) is

c02 CURSOR FOR
	SELECT	distinct a.nr_sequencia,
		a.nr_seq_doc_template,
		a.ds_prefixo_id,
		a.ie_obrigatorio,
		b.ds_template
	from	db_wf_templ_item_predec c,
		db_document_template b,
		db_workflow_template_item a
	where	b.nr_sequencia = a.nr_seq_doc_template
	and	a.nr_sequencia = c.nr_seq_item
	and	c.nr_seq_doc_template = nr_seq_doc_template_p
	and	a.nr_seq_wf_template = nr_sequencia_p
	and	coalesce(a.nr_seq_ordem::text, '') = ''
	and not exists (SELECT	1
			from	db_wf_templ_item_predec y,
				db_workflow_template_item x
			where	y.nr_seq_item = a.nr_sequencia
			and	x.nr_seq_wf_template = a.nr_seq_wf_template
			and	y.nr_seq_doc_template = x.nr_seq_doc_template
			and	coalesce(x.nr_seq_ordem::text, '') = '')
	order by a.ie_obrigatorio desc,
		b.ds_template;
BEGIN

for c02_w in c02 loop
	begin
	nr_seq_ordem_w := nr_seq_ordem_w + 1;

	update	db_workflow_template_item
	set	nr_seq_ordem = nr_seq_ordem_w
	where	nr_sequencia = c02_w.nr_sequencia;

	db_sort_child_items(c02_w.nr_seq_doc_template);
	end;
end loop;

end;

begin

update	db_workflow_template_item
set	nr_seq_ordem  = NULL
where	nr_seq_wf_template = nr_sequencia_p;

for c01_w in c01 loop
	begin
	nr_seq_ordem_w := nr_seq_ordem_w + 1;
	
	update	db_workflow_template_item
	set	nr_seq_ordem = nr_seq_ordem_w
	where	nr_sequencia = c01_w.nr_sequencia;
	end;
end loop;

for c01_w in c01 loop
	db_sort_child_items(c01_w.nr_seq_doc_template);
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE db_sort_workflow_templ_items ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

