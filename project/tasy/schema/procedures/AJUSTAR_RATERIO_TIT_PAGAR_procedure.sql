-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ajustar_raterio_tit_pagar ( nr_titulo_p text) AS $body$
DECLARE


nr_titulo_w		bigint;
nr_sequencia_w		integer;
cd_conta_contabil_w	varchar(20);
cd_centro_custo_w		integer;
nr_seq_conta_financ_w	bigint;
nr_seq_trans_fin_w		bigint;
nr_contrato_w		bigint;
nr_seq_produto_w		bigint;
vl_desconto_w		double precision;
vl_original_w		double precision;
vl_acrescimo_w		double precision;
vl_titulo_w		double precision;

ds_observacao_w		varchar(2000);
ds_observacao_aux_w	varchar(2000);

c01 CURSOR FOR
SELECT	min(nr_sequencia),
	nr_titulo,
	coalesce(cd_conta_contabil,0),
	coalesce(cd_centro_custo,0),
	coalesce(nr_seq_conta_financ,0),
	coalesce(nr_seq_trans_fin,0),
	coalesce(nr_contrato,0),
	coalesce(nr_seq_produto,0),
	sum(vl_desconto),
	sum(vl_original),
	sum(vl_acrescimo),
	sum(vl_titulo)
from	titulo_pagar_classif
where	nr_titulo = nr_titulo_p
group by	nr_titulo,
	cd_conta_contabil,
	cd_centro_custo,
	nr_seq_conta_financ,
	nr_seq_trans_fin,
	nr_contrato,
	nr_seq_produto;

c02 CURSOR FOR
SELECT	ds_observacao
from	titulo_pagar_classif
where	nr_titulo = nr_titulo_w
and	coalesce(cd_conta_contabil,0) = cd_conta_contabil_w
and	coalesce(cd_centro_custo,0) = cd_centro_custo_w
and	coalesce(nr_seq_conta_financ,0) = nr_seq_conta_financ_w
and	coalesce(nr_seq_trans_fin,0) = nr_seq_trans_fin_w
and	coalesce(nr_contrato,0) = nr_contrato_w
and	coalesce(nr_seq_produto,0) = nr_seq_produto_w
and	(ds_observacao IS NOT NULL AND ds_observacao::text <> '');


BEGIN

open c01;
loop
fetch c01 into
	nr_sequencia_w,
	nr_titulo_w,
	cd_conta_contabil_w,
	cd_centro_custo_w,
	nr_seq_conta_financ_w,
	nr_seq_trans_fin_w,
	nr_contrato_w,
	nr_seq_produto_w,
	vl_desconto_w,
	vl_original_w,
	vl_acrescimo_w,
	vl_titulo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	ds_observacao_w := null;

	open c02;
	loop
	fetch c02 into
		ds_observacao_aux_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		ds_observacao_w := substr(ds_observacao_w || chr(13) || chr(10) || ds_observacao_aux_w,1,2000);
		end;
	end loop;
	close c02;

	update	titulo_pagar_classif
	set	vl_desconto = vl_desconto_w,
		vl_original = vl_original_w,
		vl_acrescimo = vl_acrescimo_w,
		vl_titulo = vl_titulo_w,
		ds_observacao = ds_observacao_w
	where	nr_titulo = nr_titulo_w
	and	nr_sequencia = nr_sequencia_w;

	delete	FROM titulo_pagar_classif
	where	nr_titulo = nr_titulo_w
	and	coalesce(cd_conta_contabil,0) = cd_conta_contabil_w
	and	coalesce(cd_centro_custo,0) = cd_centro_custo_w
	and	coalesce(nr_seq_conta_financ,0) = nr_seq_conta_financ_w
	and	coalesce(nr_seq_trans_fin,0) = nr_seq_trans_fin_w
	and	coalesce(nr_contrato,0) = nr_contrato_w
	and	coalesce(nr_seq_produto,0) = nr_seq_produto_w
	and	nr_sequencia > nr_sequencia_w;
	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ajustar_raterio_tit_pagar ( nr_titulo_p text) FROM PUBLIC;

