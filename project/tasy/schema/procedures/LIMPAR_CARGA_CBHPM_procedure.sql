-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE limpar_carga_cbhpm ( dt_vigencia_p timestamp, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE


ds_erro_w		varchar(2000)	:= '';
ie_deleta_w		varchar(1)	:= 'S';

C01 CURSOR FOR
	SELECT	nr_sequencia           ,
		cd_procedimento        ,
		ie_origem_proced       ,
		dt_vigencia            ,
		cd_porte               ,
		tx_porte               ,
		qt_uco                 ,
		nr_porte_anest         ,
		nr_auxiliar            ,
		qt_filme               ,
		qt_incidencia          ,
		ie_unid_ra
	from	cbhpm_preco
	where	dt_vigencia = dt_vigencia_p
	order by nr_sequencia;

c01_w	c01%rowtype;


BEGIN

open C01;
loop
fetch C01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	begin
	insert into w_cbhpm_preco(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		cd_procedimento,
		ie_origem_proced,
		dt_vigencia,
		cd_porte,
		tx_porte,
		qt_uco,
		nr_porte_anest,
		nr_auxiliar,
		qt_filme,
		qt_incidencia,
		ie_unid_ra,
		dt_atualizacao_nrec,
		nm_usuario_nrec)
	values (
		nextval('w_cbhpm_preco_seq'),
		clock_timestamp(),
		nm_usuario_p,
		c01_w.cd_procedimento,
		c01_w.ie_origem_proced,
		dt_vigencia_p,
		c01_w.cd_porte,
		c01_w.tx_porte,
		c01_w.qt_uco,
		c01_w.nr_porte_anest,
		c01_w.nr_auxiliar,
		c01_w.qt_filme,
		c01_w.qt_incidencia,
		c01_w.ie_unid_ra,
		clock_timestamp(),
		nm_usuario_p);
	exception
		when others then
		ds_erro_w	:= substr(sqlerrm(SQLSTATE),1,2000);
		ie_deleta_w	:= 'N';
	end;

	end;

	commit;

end loop;
close C01;

if (ie_deleta_w	= 'S') then

	delete	FROM cbhpm_preco
	where	trunc(dt_vigencia,'dd') = trunc(dt_vigencia_p,'dd');

end if;

ds_erro_p	:= ds_erro_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE limpar_carga_cbhpm ( dt_vigencia_p timestamp, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

