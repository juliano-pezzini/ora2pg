-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicar_justificativa ( nr_sequencia_p bigint, nr_atendimento_p bigint, nm_usuario_p text, nr_seq_saida_p INOUT bigint, ie_obriga_atendimento_p text default 'S') AS $body$
DECLARE


ds_justificativa_w	varchar(32000);
cd_medico_w			varchar(10);


BEGIN

select	ds_justificativa
into STRICT	ds_justificativa_w
from	paciente_justificativa
where	nr_sequencia = nr_sequencia_p;

select	max(cd_pessoa_fisica)
into STRICT	cd_medico_w
from	usuario
where	nm_usuario	= nm_usuario_p;



if (nr_sequencia_p > 0) and ((coalesce(ie_obriga_atendimento_p,'S') = 'N') or (nr_atendimento_p > 0)) then

select	nextval('paciente_justificativa_seq')
into STRICT	nr_seq_saida_p
;

	insert into paciente_justificativa(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_autorizacao,
		nr_atendimento,
		dt_justificativa,
		cd_profissional,
		ie_tipo_justificativa,
		qt_dia_prorrogacao,		
		nr_sequencia_autor,
		ie_situacao,
		cd_pessoa_fisica,
		nr_seq_atend_cons_pepa)
	SELECT	
		nr_seq_saida_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_autorizacao,
		nr_atendimento_p,
		clock_timestamp(),
		coalesce(cd_medico_w,cd_profissional),
		ie_tipo_justificativa,
		qt_dia_prorrogacao,		
		nr_sequencia_autor,
		'A',
		cd_pessoa_fisica,
		CASE WHEN wheb_usuario_pck.get_cd_funcao=381 THEN  nr_seq_atend_cons_pepa  ELSE null END
	from	paciente_justificativa
	where	nr_sequencia	= nr_sequencia_p;
	
	commit;
	
	CALL copia_campo_long_de_para(	'paciente_justificativa',
					'ds_justificativa',
					' where nr_sequencia = :nr_sequencia ',
					'nr_sequencia='||nr_sequencia_p,
					'paciente_justificativa',
					'ds_justificativa',
					' where nr_sequencia = :nr_sequencia',
					'nr_sequencia='||nr_seq_saida_p);
	
	commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_justificativa ( nr_sequencia_p bigint, nr_atendimento_p bigint, nm_usuario_p text, nr_seq_saida_p INOUT bigint, ie_obriga_atendimento_p text default 'S') FROM PUBLIC;

