-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_processo_aprov_cotacao ( nr_cot_compra_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_aprovacao_w			bigint;
cd_material_w				integer;
nr_item_cot_compra_w			integer;
cd_centro_custo_w				bigint;
cd_local_estoque_w			bigint;
cd_estabelecimento_w			smallint;
cd_processo_aprov_w			bigint;
ie_urgente_w				varchar(1);
cd_perfil_ativo_w				bigint;
dt_liberacao_w				timestamp;
nr_sequencia_w				bigint;
ie_responsavel_w				varchar(1);
cd_cargo_w				bigint;
nm_usuario_regra_w			varchar(15);
cd_responsavel_w				varchar(10);
nr_items_sem_aprov_w			bigint;
qt_existe_w				bigint;
cd_conta_contabil_w			varchar(20);
nr_seq_cot_forn_w				bigint;
cd_cgc_fornecedor_w			varchar(14);
cd_pessoa_fisica_w			varchar(10);
ie_teto_aprovacao_w			varchar(1);
nr_seq_proc_email_w			bigint;
nr_nivel_aprovacao_w			bigint;
nr_nivel_aprovacao_w2			bigint;
ie_aprovacao_nivel_w			varchar(1);
dt_cot_compra_w				timestamp;
nr_seq_proj_rec_w			cot_compra_item.nr_seq_proj_rec%type;
vl_minimo_w				processo_aprov_resp.vl_minimo%type;
vl_maximo_w				processo_aprov_resp.vl_maximo%type;
qt_minimo_aprovador_w			processo_aprov_resp.qt_minimo_aprovador%type;
qt_itens_regra_w			processo_aprov_resp.qt_itens_regra%type;
qt_intervalo_regra_w			processo_aprov_resp.qt_intervalo_regra%type;

c01 CURSOR FOR
SELECT	a.nr_seq_aprovacao,
	a.cd_material,
	a.nr_item_cot_compra,
	a.nr_seq_proj_rec,
	b.nr_seq_cot_forn,
	substr(obter_dados_solic_item_cot(a.nr_cot_compra, a.nr_item_cot_compra, 'C'),1,10) cd_centro_custo,
	substr(obter_dados_solic_item_cot(a.nr_cot_compra, a.nr_item_cot_compra, 'L'),1,10) cd_local_estoque,
	substr(obter_dados_solic_item_cot(a.nr_cot_compra, a.nr_item_cot_compra, 'U'),1,1) ie_urgente,
	substr(obter_dados_solic_item_cot(a.nr_cot_compra, a.nr_item_cot_compra, 'CC'),1,20) cd_conta_contabil
from 	cot_compra_item a,
	cot_compra_resumo b,
	estrutura_material_v e
where	a.nr_cot_compra = b.nr_cot_compra
and	a.nr_item_cot_compra = b.nr_item_cot_compra
and	a.cd_material = e.cd_material
and 	coalesce(a.dt_aprovacao::text, '') = ''
and	a.nr_cot_compra = nr_cot_compra_p
order by e.cd_grupo_material,
	e.cd_subgrupo_material,
	e.cd_classe_material,
	e.cd_material;
	
c02 CURSOR FOR
SELECT	nr_sequencia,
	ie_responsavel,
	cd_cargo,
	nm_usuario_regra,
	nr_nivel_aprovacao,
	vl_minimo,
	vl_maximo,
	qt_minimo_aprovador,
	qt_itens_regra,
	qt_intervalo_regra
from	processo_aprov_resp
where	cd_processo_aprov	= cd_processo_aprov_w
and	coalesce(ie_cotacao,'N')	= 'S'
order by	nr_sequencia;

c03 CURSOR FOR
SELECT	distinct nr_seq_aprovacao
from	cot_compra_item
where	nr_cot_compra = nr_cot_compra_p
and	(nr_seq_aprovacao IS NOT NULL AND nr_seq_aprovacao::text <> '');


BEGIN

select	cd_estabelecimento,
	obter_perfil_ativo,
	dt_cot_compra
into STRICT	cd_estabelecimento_w,
	cd_perfil_ativo_w,
	dt_cot_compra_w
from	cot_compra
where	nr_cot_compra = nr_cot_compra_p;

select	coalesce(ie_teto_aprovacao,'N')
into STRICT	ie_teto_aprovacao_w
from	parametro_compras
where	cd_estabelecimento = cd_estabelecimento_w;

open C01;
loop
fetch C01 into	
	nr_seq_aprovacao_w,
	cd_material_w,
	nr_item_cot_compra_w,
	nr_seq_proj_rec_w,
	nr_seq_cot_forn_w,
	cd_centro_custo_w,
	cd_local_estoque_w,
	ie_urgente_w,
	cd_conta_contabil_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	if (coalesce(nr_seq_aprovacao_w::text, '') = '') then
			
		if (coalesce(cd_centro_custo_w::text, '') = '') then
			select	coalesce(max(cd_centro_custo),null)
			into STRICT	cd_centro_custo_w
			from	local_estoque
			where	cd_estabelecimento	= cd_estabelecimento_w
			and	cd_local_estoque		= cd_local_estoque_w;
			
		end if;

		select	cd_cgc_fornecedor,
			cd_pessoa_fisica
		into STRICT	cd_cgc_fornecedor_w,
			cd_pessoa_fisica_w
		from	cot_compra_forn
		where	nr_cot_compra = nr_cot_compra_p
		and	nr_sequencia = nr_seq_cot_forn_w;

		if (cd_cgc_fornecedor_w IS NOT NULL AND cd_cgc_fornecedor_w::text <> '') then
			cd_pessoa_fisica_w	:= null;
		end if;

		cd_processo_aprov_w := obter_processo_aprovacao(
			cd_material_w, cd_centro_custo_w, null, cd_local_estoque_w, null,  -- cd_local_estoque_destino_p - Usado somente na requisicao
			null,  -- cd_operacao_estoque_p       - Usado somente na requisicao
			cd_conta_contabil_w, cd_cgc_fornecedor_w, cd_pessoa_fisica_w, 'C', ie_urgente_w, cd_estabelecimento_w, cd_perfil_ativo_w, nr_seq_proj_rec_w, nr_cot_compra_p, cd_processo_aprov_w);
		
		if (cd_processo_aprov_w IS NOT NULL AND cd_processo_aprov_w::text <> '') then
		
			select	coalesce(max(b.nr_sequencia),0)
			into STRICT 	nr_seq_aprovacao_w
			from 	processo_aprov_compra a,
				processo_compra b
			where 	b.nr_sequencia = a.nr_sequencia
			and 	b.cd_processo_aprov = cd_processo_aprov_w
			and 	a.nr_documento = nr_cot_compra_p
			and 	a.cd_estabelecimento = cd_estabelecimento_w
			and	a.ie_tipo = 'C';
		
			if (nr_seq_aprovacao_w = 0) then
		
				select	nextval('processo_compra_seq')
				into STRICT	nr_seq_aprovacao_w
				;

				insert into processo_compra(
					nr_sequencia,
					cd_processo_aprov, 
					dt_atualizacao, 
					nm_usuario) 
				values (	nr_seq_aprovacao_w, 
					cd_processo_aprov_w, 
					clock_timestamp(), 
					nm_usuario_p);
					
				dt_liberacao_w			:= clock_timestamp();
				
				open c02;
				loop
				fetch c02 into
					nr_sequencia_w,
					ie_responsavel_w,
					cd_cargo_w,
					nm_usuario_regra_w,
					nr_nivel_aprovacao_w,
					vl_minimo_w,
					vl_maximo_w,
					qt_minimo_aprovador_w,
					qt_itens_regra_w,
					qt_intervalo_regra_w;
				EXIT WHEN NOT FOUND; /* apply on c02 */
					begin
				
					cd_responsavel_w	:= '';

					if (coalesce(nr_nivel_aprovacao_w2::text, '') = '') then
						nr_nivel_aprovacao_w2 := nr_nivel_aprovacao_w;
					end if;
				
					if (ie_responsavel_w = 'R') then					
						if (coalesce(cd_centro_custo_w::text, '') = '') then						
							select	coalesce(max(cd_centro_custo),null)
							into STRICT	cd_centro_custo_w
							from	local_estoque
							where	cd_estabelecimento	= cd_estabelecimento_w
							and	cd_local_estoque	= cd_local_estoque_w;
						end if;
					
						select	coalesce(max(b.cd_cargo),null)
						into STRICT	cd_cargo_w
						from	cargo a,
							cargo_centro_custo b
						where	b.cd_centro_custo	= cd_centro_custo_w
						and	b.cd_cargo	= a.cd_cargo
						and	a.ie_situacao	= 'A';	
					end if;
				
					if (ie_responsavel_w <> 'F') then
						
						if (nr_nivel_aprovacao_w IS NOT NULL AND nr_nivel_aprovacao_w::text <> '')
							and (coalesce(dt_liberacao_w::text, '') = '') then
							
							select	obter_se_proc_por_nivel(nr_seq_aprovacao_w, cd_estabelecimento_w)
							into STRICT	ie_aprovacao_nivel_w
							;
							
							if (ie_aprovacao_nivel_w = 'S') and (nr_nivel_aprovacao_w2 = nr_nivel_aprovacao_w) then
								dt_liberacao_w	:= clock_timestamp();
							else
								dt_liberacao_w	:= null;
							end if;
						end if;
						
						insert into processo_aprov_compra(
							nr_sequencia,
							nr_seq_proc_aprov,
							dt_atualizacao,
							nm_usuario,
							nm_usuario_nrec,
							cd_pessoa_fisica,
							cd_cargo,
							dt_liberacao,
							dt_definicao,
							ie_aprov_reprov,
							cd_estabelecimento,
							ie_urgente,
							nr_documento,
							ie_tipo,
							dt_documento,
							nr_nivel_aprovacao,
							cd_processo_aprov,
							ie_responsavel,
							vl_minimo,
							vl_maximo,
							qt_minimo_aprovador,
							nm_usuario_regra,
							qt_itens_regra,
							qt_intervalo_regra)
						values (	nr_seq_aprovacao_w,
							nr_sequencia_w,
							clock_timestamp(),
							nm_usuario_p,
							nm_usuario_p,
							cd_responsavel_w,
							cd_cargo_w,
							dt_liberacao_w,
							CASE WHEN coalesce(cd_cargo_w::text, '') = '' THEN  clock_timestamp()  ELSE null END ,
							'P',
							cd_estabelecimento_w,
							ie_urgente_w,
							nr_cot_compra_p,
							'C',
							dt_cot_compra_w,
							nr_nivel_aprovacao_w,
							cd_processo_aprov_w,
							ie_responsavel_w,
							vl_minimo_w,
							vl_maximo_w,
							qt_minimo_aprovador_w,
							nm_usuario_regra_w,
							qt_itens_regra_w,
							qt_intervalo_regra_w);
						
						if (cd_cargo_w IS NOT NULL AND cd_cargo_w::text <> '') then
							dt_liberacao_w	:= null;
						end if;
					
					elsif (ie_responsavel_w = 'F') then
				
						select	obter_pessoa_fisica_usuario(nm_usuario_regra_w,'C')
						into STRICT	cd_responsavel_w
						;
				
						if (coalesce(cd_responsavel_w::text, '') = '') then
							CALL wheb_mensagem_pck.exibir_mensagem_abort(192347,'NM_USUARIO_REGRA=' || nm_usuario_regra_w);
							/*(-20011,'O usuario aprovador ' || nm_usuario_regra_w || 'nao possui nenhuma pessoa fisica vinculada. Favor ajustar o cadastro deste usuario');*/

						end if;
				
						if (nr_nivel_aprovacao_w IS NOT NULL AND nr_nivel_aprovacao_w::text <> '')
							and (coalesce(dt_liberacao_w::text, '') = '') then
							
							select	obter_se_proc_por_nivel(nr_seq_aprovacao_w, cd_estabelecimento_w)
							into STRICT	ie_aprovacao_nivel_w
							;
							
							if (ie_aprovacao_nivel_w = 'S') and (nr_nivel_aprovacao_w2 = nr_nivel_aprovacao_w) then
								dt_liberacao_w	:= clock_timestamp();
							else
								dt_liberacao_w	:= null;
							end if;
						end if;
				
						insert into processo_aprov_compra(
							nr_sequencia,
							nr_seq_proc_aprov,
							dt_atualizacao,
							nm_usuario,
							nm_usuario_nrec,
							cd_pessoa_fisica,
							cd_cargo,
							dt_liberacao,
							dt_definicao,
							ie_aprov_reprov,
							cd_estabelecimento,
							ie_urgente,
							nr_documento,
							ie_tipo,
							dt_documento,
							nr_nivel_aprovacao,
							cd_processo_aprov,
							ie_responsavel,
							vl_minimo,
							vl_maximo,
							qt_minimo_aprovador,
							nm_usuario_regra,
							qt_itens_regra,
							qt_intervalo_regra)
						values (	nr_seq_aprovacao_w,
							nr_sequencia_w,
							clock_timestamp(),
							nm_usuario_p,
							nm_usuario_p,
							cd_responsavel_w,
							null,
							dt_liberacao_w,
							null,
							'P',
							cd_estabelecimento_w,
							ie_urgente_w,
							nr_cot_compra_p,
							'C',
							dt_cot_compra_w,
							nr_nivel_aprovacao_w,
							cd_processo_aprov_w,
							ie_responsavel_w,
							vl_minimo_w,
							vl_maximo_w,
							qt_minimo_aprovador_w,
							nm_usuario_regra_w,
							qt_itens_regra_w,
							qt_intervalo_regra_w);
							
						if (cd_responsavel_w IS NOT NULL AND cd_responsavel_w::text <> '') then
							dt_liberacao_w	:= null;
						end if;
						
					end if;
					
					if (ie_teto_aprovacao_w = 'S') then
						dt_liberacao_w := null;
					end if;
					
					end;
				end loop;
				close c02;
			end if;
			
			update	cot_compra
			set	dt_calculo_cotacao		= clock_timestamp()
			where	nr_cot_compra		= nr_cot_compra_p
			and	coalesce(dt_calculo_cotacao::text, '') = '';
				
			update	cot_compra_item
			set	nr_seq_aprovacao		= nr_seq_aprovacao_w
			where	nr_cot_compra		= nr_cot_compra_p
			and	nr_item_cot_compra	= nr_item_cot_compra_w;
		end if;
	end if;	
	end;
end loop;
close C01;

select	count(*)
into STRICT	nr_items_sem_aprov_w
from	cot_compra_item
where	coalesce(dt_aprovacao::text, '') = ''
and	nr_cot_compra = nr_cot_compra_p;

if (nr_items_sem_aprov_w > 0) then

	select	coalesce(max(nr_seq_proc_aprov),0)
	into STRICT	nr_seq_proc_email_w
	from	processo_aprov_compra
	where	nr_sequencia = nr_seq_aprovacao_w
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

	CALL envia_email_proximo_aprov_cot(nr_seq_aprovacao_w,nr_seq_proc_email_w,cd_estabelecimento_w,nm_usuario_p);
	
end if;

if (nr_items_sem_aprov_w = 0) then
	update	cot_compra
	set	dt_aprovacao		= clock_timestamp(),
		nm_usuario_aprov		= nm_usuario_p
	where	nr_cot_compra		= nr_cot_compra_p;
end if;
	
open c03;
loop
fetch c03 into
	nr_seq_aprovacao_w;
EXIT WHEN NOT FOUND; /* apply on c03 */
	CALL aprovacao_automatica_req(nr_seq_aprovacao_w, nm_usuario_p);
end loop;
close c03;

commit;

CALL envia_email_gera_aprov_cot(nr_cot_compra_p,cd_estabelecimento_w,nm_usuario_p);

select	count(*)
into STRICT	qt_existe_w
from	regra_envio_comunic_compra a,
	regra_envio_comunic_evento b
where	a.nr_sequencia = b.nr_seq_regra
and	b.cd_evento = 63
and	b.ie_situacao = 'A'
and	a.cd_estabelecimento = 	cd_estabelecimento_w
and	substr(obter_se_envia_ci_regra_compra(b.nr_sequencia,nr_cot_compra_p,'CC',obter_perfil_ativo,nm_usuario_p,null),1,1) = 'S';

if (qt_existe_w > 0) then
	CALL envia_ci_gera_aprov_cot(nr_cot_compra_p,nm_usuario_p);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_processo_aprov_cotacao ( nr_cot_compra_p bigint, nm_usuario_p text) FROM PUBLIC;

