-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE avisar_vencimento_contrato ( cd_estabelecimento_p bigint, ie_comunicar_resp_p text default 'S') AS $body$
DECLARE


/*
ie_comunicar_resp_p: Se habilitado para 'N' apenas as pessoas que possuem liberacao receberao a comunicacao interna/email
*/
					
					
cd_pessoa_responsavel_w		varchar(10);
cd_pessoa_negoc_w		varchar(10);
qt_dias_vencer_w			integer;
nr_sequencia_w			bigint;
nr_seq_classif_w			bigint;
cd_contrato_w			varchar(20);
ds_objeto_contrato_w		varchar(4000);
dt_fim_w				timestamp;
nm_usuario_w			varchar(255) := '';
nm_usuario_neg_w			varchar(15);
nm_contratado_w			varchar(80);
cd_setor_w			integer;
cd_setor_adicional_w		varchar(255);
cd_perfil_w				bigint;
cd_perfil_adicional_w			varchar(4000);
nr_seq_contrato_w			bigint;
nm_usuario_lib_w			varchar(15);
nm_usuario_resp_w			varchar(15);
ie_avisa_venc_setor_w		varchar(1);
ie_aviso_vencimento_usuario_w	varchar(01);
ds_email_destino_w			varchar(2000);
ds_email_w			varchar(2000);
ds_tipo_contrato_w			varchar(200);
dt_inicio_w			timestamp;
ds_forma_renovacao_w		varchar(255);
vl_total_contrato_w			double precision;
ds_mensagem_w			varchar(4000);
ds_email_origem_w			varchar(255);
ds_condicao_pagamento_w		varchar(80);
ds_forma_pagamento_w		varchar(255);
ds_moeda_w			varchar(255);
vl_pagto_w			double precision;
qt_dias_diferenca_w		bigint;
qt_dias_interv_aviso_w		bigint;
ie_intervalo_w			bigint;
ie_gerar_w			varchar(1);
dt_revisao_w			timestamp;
ds_consistencia_w			varchar(2000);
ds_email_origem_estab_w		varchar(255);
ie_email_origem_w			varchar(1);
vl_saldo_total_w			double precision;
nm_pessoa_contratada_w		varchar(80);
ds_titulo_contrato_w		varchar(255);
cd_estabelecimento_w		smallint;

locale_w			bigint;
ds_locale_w			varchar(15);
nm_usuario_envio_email_w	usuario.nm_usuario%type;
cd_responsavel_contratos_w	parametro_compras.cd_responsavel_contratos%type;
cd_empresa_w				empresa_estab_resp.cd_empresa%type;
cd_cgc_estab_w				estabelecimento.cd_cgc%type;
qt_resp_emp_estab_w			bigint;
qt_resp_pessoa_jur_w		bigint;

ds_conta_email_w		varchar(255);
ds_user_id2_w			varchar(255);
ie_autenticar_w			boolean;
ds_parametro_w			varchar(255);


c01 CURSOR FOR
SELECT	cd_pessoa_resp,
	cd_pessoa_negoc,
	trunc(dt_fim - clock_timestamp()),
	cd_contrato,
	ds_objeto_contrato,
	dt_fim,
	substr(obter_razao_social(cd_cgc_contratado),1,80),
	cd_setor,
	nr_sequencia,
	ie_avisa_venc_setor,
	substr(obter_descricao_padrao('TIPO_CONTRATO','DS_TIPO_CONTRATO',nr_seq_tipo_contrato),1,200) ds_tipo_contrato,
	dt_inicio,
	substr(obter_valor_dominio(1061, ie_renovacao),1,255) ds_forma_renovacao,
	vl_total_contrato,
	substr(obter_desc_cond_pagto(cd_condicao_pagamento),1,80) ds_condicao_pagamento,
	coalesce(qt_dias_interv_aviso,0),
	dt_revisao,
	coalesce(ie_email_origem,'E'),
	substr(obter_nome_pf(cd_pessoa_contratada),1,80),
	ds_titulo_contrato
from	contrato
where	ie_situacao = 'A'
and	cd_estabelecimento = cd_estabelecimento_w
and	coalesce(ie_avisa_vencimento,'N') = 'S'
and	trunc(trunc(dt_fim,'dd') - trunc(clock_timestamp(),'dd')) <= coalesce(qt_dias_aviso_venc,0)
and	trunc(dt_fim,'dd') >= trunc(clock_timestamp(),'dd')
and	(cd_pessoa_resp IS NOT NULL AND cd_pessoa_resp::text <> '')
and	coalesce(ie_finalizado,'N') = 'N'
and	ie_classificacao <> 'OR';

c02 CURSOR FOR
SELECT	distinct
	coalesce(nm_usuario_lib,'X'),
	cd_perfil,
	ie_aviso_vencimento
from	contrato_usuario_lib
where	nr_seq_contrato = nr_seq_contrato_w
and	coalesce(ie_aviso_vencimento, 'N') <> 'N';

c03 CURSOR FOR

SELECT	cd_estabelecimento
from 	estabelecimento
where	ie_situacao = 'A'
and 	cd_estabelecimento_p = 0

union all

SELECT	cd_estabelecimento_p

where	cd_estabelecimento_p > 0;


BEGIN
ds_locale_w := pkg_i18n.get_estab_locale();

if (ds_locale_w = '1') then
	ds_locale_w	:= 'pt_BR';
elsif (ds_locale_w = '2') then
	ds_locale_w	:= 'es_MX';
elsif (ds_locale_w = '3') then
	ds_locale_w	:= 'es_CO';
elsif (ds_locale_w = '4') then
	ds_locale_w	:= 'es_AR';
elsif (ds_locale_w = '5') then
	ds_locale_w	:= 'en_US';
elsif (ds_locale_w = '6') then
	ds_locale_w	:= 'en_GB';
elsif (ds_locale_w = '7') then
	ds_locale_w	:= 'de_DE';
elsif (ds_locale_w = '8') then
	ds_locale_w	:= 'ar_SA';
end if;

select	nr_sequencia
into STRICT	locale_w
from 	tasy_idioma 
where	ds_language_tag = ds_locale_w;

begin
CALL wheb_usuario_pck.set_cd_funcao(1200);

open C03;
loop
fetch C03 into	
	cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on C03 */
	begin
	open c01;
	loop
	fetch c01 into
		cd_pessoa_responsavel_w,
		cd_pessoa_negoc_w,
		qt_dias_vencer_w,
		cd_contrato_w,
		ds_objeto_contrato_w,
		dt_fim_w,
		nm_contratado_w,
		cd_setor_w,
		nr_seq_contrato_w,
		ie_avisa_venc_setor_w,
		ds_tipo_contrato_w,
		dt_inicio_w,
		ds_forma_renovacao_w,
		vl_total_contrato_w,
		ds_condicao_pagamento_w,
		qt_dias_interv_aviso_w,
		dt_revisao_w,
		ie_email_origem_w,
		nm_pessoa_contratada_w,
		ds_titulo_contrato_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		ds_email_destino_w := '';
		ds_email_origem_w	:= ds_email_origem_estab_w;
		nm_usuario_envio_email_w := '';
		
		/* Responsavel contrato */

		if (ie_email_origem_w = 'R') then
		begin
			select	max(nm_usuario)
			into STRICT	nm_usuario_envio_email_w
			from	usuario
			where	cd_pessoa_fisica = cd_pessoa_responsavel_w
			and	ie_situacao = 'A';
			
			select	max(ds_email)
			into STRICT	ds_conta_email_w
			from	usuario
			where	nm_usuario = nm_usuario_envio_email_w;
			
			ds_user_id2_w := substr(obter_parametro_funcao(0,38,nm_usuario_envio_email_w),1,60);
			
			/*Valida o ID de autenticacao do email como email de origem - procedure Enviar_Email */

			if (ds_conta_email_w IS NOT NULL AND ds_conta_email_w::text <> '') then
				ds_email_origem_w := ds_conta_email_w;
			elsif (ds_user_id2_w IS NOT NULL AND ds_user_id2_w::text <> '') then
				ds_email_origem_w := ds_user_id2_w;
			else
				ds_user_id2_w := OBTER_VALOR_PARAM_USUARIO(0,38,Obter_perfil_Ativo, nm_usuario_envio_email_w, wheb_usuario_pck.get_cd_estabelecimento);
				
				if (ds_user_id2_w IS NOT NULL AND ds_user_id2_w::text <> '') then
					ds_email_origem_w := ds_user_id2_w;
				else
					ds_email_origem_w := '';
				end if;
			end if;
			
			exception when no_data_found then
				begin
				ds_email_origem_w := '';
				nm_usuario_envio_email_w := '';
				end;
		end;
		/* Responsavel geral contrato */

		elsif (ie_email_origem_w = 'G') then
		begin
			select	cd_responsavel_contratos
			into STRICT	cd_responsavel_contratos_w
			from	parametro_compras
			where	cd_estabelecimento = cd_estabelecimento_w;
			
			select	max(nm_usuario)
			into STRICT	nm_usuario_envio_email_w
			from	usuario
			where	cd_pessoa_fisica = cd_responsavel_contratos_w
			and	ie_situacao = 'A';
			
			select	max(ds_email)
			into STRICT	ds_conta_email_w
			from	usuario
			where	nm_usuario = nm_usuario_envio_email_w;
			
			ds_user_id2_w := substr(obter_parametro_funcao(0,38,nm_usuario_envio_email_w),1,60);
			
			/*Valida o ID de autenticacao do email como email de origem - procedure Enviar_Email */

			if (ds_conta_email_w IS NOT NULL AND ds_conta_email_w::text <> '') then
				ds_email_origem_w := ds_conta_email_w;
			elsif (ds_user_id2_w IS NOT NULL AND ds_user_id2_w::text <> '') then
				ds_email_origem_w := ds_user_id2_w;
			else
				ds_user_id2_w := OBTER_VALOR_PARAM_USUARIO(0,38,Obter_perfil_Ativo, nm_usuario_envio_email_w, wheb_usuario_pck.get_cd_estabelecimento);
				
				if (ds_user_id2_w IS NOT NULL AND ds_user_id2_w::text <> '') then
					ds_email_origem_w := ds_user_id2_w;
				else
					ds_email_origem_w := '';
				end if;
			end if;
			
			exception when no_data_found then
				begin
				ds_email_origem_w := '';
				nm_usuario_envio_email_w := '';
				end;
		end;
		end if;
		
		/* Estabelecimento > ie_email_origem_w = E */

		if (coalesce(ds_email_origem_w,'X') = 'X' or coalesce(nm_usuario_envio_email_w,'X') = 'X') then
		begin
			select	max(cd_empresa),
				max(cd_cgc)
			into STRICT	cd_empresa_w,
				cd_cgc_estab_w
			from	estabelecimento
			where	cd_estabelecimento = cd_estabelecimento_w;
			
			select	u.nm_usuario
			into STRICT	nm_usuario_envio_email_w
			from	empresa_estab_resp e,
				usuario u
			where	e.cd_pessoa_fisica = u.cd_pessoa_fisica
			and 	u.ie_situacao = 'A'
			and	e.cd_empresa = cd_empresa_w
			and (coalesce(e.cd_estab_exclusivo::text, '') = ''
			or 	e.cd_estab_exclusivo = cd_estabelecimento_w)  LIMIT 1;
			
			select	max(ds_email)
			into STRICT	ds_conta_email_w
			from	usuario
			where	nm_usuario = nm_usuario_envio_email_w;
			
			ds_user_id2_w := substr(obter_parametro_funcao(0,38,nm_usuario_envio_email_w),1,60);
			
			/* Valida o ID de autenticacao do email como email de origem - procedure Enviar_Email */

			if (ds_conta_email_w IS NOT NULL AND ds_conta_email_w::text <> '') then
				ds_email_origem_w := ds_conta_email_w;
			elsif (ds_user_id2_w IS NOT NULL AND ds_user_id2_w::text <> '') then
				ds_email_origem_w := ds_user_id2_w;
			else
				ds_user_id2_w := OBTER_VALOR_PARAM_USUARIO(0,38,Obter_perfil_Ativo, nm_usuario_envio_email_w, wheb_usuario_pck.get_cd_estabelecimento);
				
				if (ds_user_id2_w IS NOT NULL AND ds_user_id2_w::text <> '') then
					ds_email_origem_w := ds_user_id2_w;
				else
					ds_email_origem_w := '';
				end if;
			end if;
			
			exception when no_data_found then
				begin
				ds_email_origem_w := '';
				nm_usuario_envio_email_w := '';
				end;
			
			/* Responsavel pelo PJ do estab */

			if (coalesce(ds_email_origem_w,'X') = 'X' or coalesce(nm_usuario_envio_email_w,'X') = 'X') then
			begin
				select	u.nm_usuario
				into STRICT	nm_usuario_envio_email_w
				from	pessoa_jur_resp e,
					usuario u
				where	e.cd_pessoa_fisica = u.cd_pessoa_fisica
				and     u.ie_situacao = 'A'
				and	e.cd_cgc = cd_cgc_estab_w
				and	(e.cd_pessoa_fisica IS NOT NULL AND e.cd_pessoa_fisica::text <> '')
				and	coalesce(e.ie_representante_legal,'N') = 'S'  LIMIT 1;
				
				select	max(ds_email)
				into STRICT	ds_conta_email_w
				from	usuario
				where	nm_usuario = nm_usuario_envio_email_w;
				
				ds_user_id2_w := substr(obter_parametro_funcao(0,38,nm_usuario_envio_email_w),1,60);
				
				/*Valida o ID de autenticacao do email como email de origem - procedure Enviar_Email */

				if (ds_conta_email_w IS NOT NULL AND ds_conta_email_w::text <> '') then
					ds_email_origem_w := ds_conta_email_w;
				elsif (ds_user_id2_w IS NOT NULL AND ds_user_id2_w::text <> '') then
					ds_email_origem_w := ds_user_id2_w;
				else
					ds_user_id2_w := OBTER_VALOR_PARAM_USUARIO(0,38,Obter_perfil_Ativo, nm_usuario_envio_email_w, wheb_usuario_pck.get_cd_estabelecimento);
					
					if (ds_user_id2_w IS NOT NULL AND ds_user_id2_w::text <> '') then
						ds_email_origem_w := ds_user_id2_w;
					else
						ds_email_origem_w := '';
					end if;
				end if;
				
				exception when no_data_found then
					begin
					ds_email_origem_w := '';
					nm_usuario_envio_email_w := '';
					end;
			end;
			end if;
		end;
		end if;
		/* Usuario padrao */

		if (coalesce(ds_email_origem_w,'X') = 'X' or coalesce(nm_usuario_envio_email_w,'X') = 'X') then
		begin
			select	substr(ds_email,1,255),
				nm_usuario
			into STRICT	ds_conta_email_w,
				nm_usuario_envio_email_w
			from	usuario
			where	nm_usuario = 'Aviso_Tasy';
			
			ds_user_id2_w := substr(obter_parametro_funcao(0,38,nm_usuario_envio_email_w),1,60);
				
			/*Valida o ID de autenticacao do email como email de origem - procedure Enviar_Email */

			if (ds_conta_email_w IS NOT NULL AND ds_conta_email_w::text <> '') then
				ds_email_origem_w := ds_conta_email_w;
			elsif (ds_user_id2_w IS NOT NULL AND ds_user_id2_w::text <> '') then
				ds_email_origem_w := ds_user_id2_w;
			else
				ds_user_id2_w := OBTER_VALOR_PARAM_USUARIO(0,38,Obter_perfil_Ativo, nm_usuario_envio_email_w, wheb_usuario_pck.get_cd_estabelecimento);
				
				if (ds_user_id2_w IS NOT NULL AND ds_user_id2_w::text <> '') then
					ds_email_origem_w := ds_user_id2_w;
				else
					ds_email_origem_w := '';
				end if;
			end if;
			
			exception when no_data_found then
				begin
				ds_email_origem_w := '';
				nm_usuario_envio_email_w := '';
				end;
		end;
		end if;
		
		ie_gerar_w		:= 'S';
		qt_dias_diferenca_w	:= trunc(trunc(dt_fim_w,'dd') - trunc(clock_timestamp(),'dd'));
		ie_intervalo_w		:= trunc(mod(qt_dias_diferenca_w, qt_dias_interv_aviso_w));
		
		if (coalesce(qt_dias_interv_aviso_w, 0) <> 0)  and (ie_intervalo_w <> 0) then
	
			ie_gerar_w	:= 'N';
			
		end if;
		
		if (ie_gerar_w = 'S') then
		
			nm_usuario_w		:= '';
			cd_setor_adicional_w	:= '';
			cd_perfil_adicional_w	:= '';
				
			select	coalesce(max(substr(obter_usuario_pessoa(cd_pessoa_responsavel_w),1,15)),'X')
			into STRICT	nm_usuario_resp_w
			from	contrato_usuario_lib
			where	nr_seq_contrato = nr_seq_contrato_w
			and	coalesce(ie_aviso_vencimento, 'N') in ('S','A')
			and	nm_usuario_lib = substr(obter_usuario_pessoa(cd_pessoa_responsavel_w),1,15);
	
			if (nm_usuario_resp_w = 'X') and (ie_comunicar_resp_p = 'S') then
				select	coalesce(max(nm_usuario),'X')
				into STRICT	nm_usuario_resp_w
				from	usuario
				where	cd_pessoa_fisica = cd_pessoa_responsavel_w;
			end if;
				
			select	coalesce(max(substr(obter_usuario_pessoa(cd_pessoa_negoc_w),1,15)),'X')
			into STRICT	nm_usuario_neg_w
			from	contrato_usuario_lib
			where	nr_seq_contrato = nr_seq_contrato_w
			and	coalesce(ie_aviso_vencimento, 'N') in ('S','A')
			and	nm_usuario_lib = substr(obter_usuario_pessoa(cd_pessoa_negoc_w),1,15);
	
			if (nm_usuario_neg_w = 'X') and (ie_comunicar_resp_p = 'S') then
				select	coalesce(max(nm_usuario),'X')
				into STRICT	nm_usuario_neg_w
				from	usuario
				where	cd_pessoa_fisica = cd_pessoa_negoc_w;
			end if;
			
			select	max(substr(obter_valor_dominio(1062, ie_forma),1,255)),
				max(substr(obter_desc_moeda(cd_moeda),1,255)),
				max(vl_pagto)
			into STRICT	ds_forma_pagamento_w,
				ds_moeda_w,
				vl_pagto_w
			from	contrato_regra_pagto
			where	nr_seq_contrato = nr_seq_contrato_w;
			
			select	coalesce(sum(vl_saldo_total),0)
			into STRICT	vl_saldo_total_w
			from	contrato_regra_nf
			where	nr_seq_contrato = nr_seq_contrato_w;		
			
	
			select	coalesce(max(nm_usuario),'X')
			into STRICT	nm_usuario_resp_w
			from	usuario
			where	nm_usuario	= nm_usuario_resp_w
			and	ie_situacao	= 'A';
			
			if (nm_usuario_resp_w <> 'X') then
				nm_usuario_w 		:= substr(nm_usuario_w || ',' || nm_usuario_resp_w,1,255);
			end if;
	
			select	coalesce(max(nm_usuario),'X')
			into STRICT	nm_usuario_neg_w
			from	usuario
			where	nm_usuario	= nm_usuario_neg_w
			and	ie_situacao	= 'A';
			
			if (nm_usuario_neg_w <> 'X') then
				nm_usuario_w		:= substr(nm_usuario_w || ',' || nm_usuario_neg_w,1,255);
			end if;
	
			open c02;
			loop
			fetch c02 into
				nm_usuario_lib_w,
				cd_perfil_w,
				ie_aviso_vencimento_usuario_w;
				EXIT WHEN NOT FOUND; /* apply on c02 */
	
				if (nm_usuario_lib_w <> 'X') then
					select	coalesce(max(nm_usuario),'X')
					into STRICT	nm_usuario_lib_w
					from	usuario
					where	nm_usuario	= nm_usuario_lib_w
					and	ie_situacao	= 'A';
				end if;
				
				if (nm_usuario_lib_w <> 'X') and (position(nm_usuario_lib_w in coalesce(nm_usuario_w,'X')) = 0) then
					if	((ie_aviso_vencimento_usuario_w = 'S') or (ie_aviso_vencimento_usuario_w = 'A')) then
						nm_usuario_w := substr(nm_usuario_w || ',' || nm_usuario_lib_w,1,255);
					end if;
				end if;
				if	((ie_aviso_vencimento_usuario_w = 'E') or (ie_aviso_vencimento_usuario_w = 'A') and (coalesce(nm_usuario_lib_w,'X') <> 'X')) then
					select	substr(obter_dados_usuario_opcao(nm_usuario_lib_w,'E'),1,255)
					into STRICT	ds_email_w
					;
					if (ds_email_w IS NOT NULL AND ds_email_w::text <> '') then
						ds_email_destino_w := substr(ds_email_destino_w || ds_email_w || ';',1,2000);
					end if;
				end if;
				
				if (ie_aviso_vencimento_usuario_w = 'S') and (cd_perfil_w IS NOT NULL AND cd_perfil_w::text <> '') then
					
					if (coalesce(cd_perfil_adicional_w, 'X') = 'X') then
						
						cd_perfil_adicional_w	:= cd_perfil_w;
					else		
						
						cd_perfil_adicional_w	:= substr(cd_perfil_adicional_w || ' ,' || cd_perfil_w, 1, 400);
					end if;
				end if;
				
			end loop;
			close c02;
			
	
			if (cd_setor_w IS NOT NULL AND cd_setor_w::text <> '') and (ie_avisa_venc_setor_w = 'S') and (ie_comunicar_resp_p = 'S') then
				cd_setor_adicional_w	:= cd_setor_w || ', ';
			end if;
	
			
			if	((nm_usuario_w <> 'X') or (coalesce(cd_perfil_adicional_w,'X') <> 'X')) then
			
				begin
				select	nextval('comunic_interna_seq')
				into STRICT	nr_sequencia_w
				;
	
				select	obter_classif_comunic('F')
				into STRICT	nr_seq_classif_w
				;
				
				ds_mensagem_w	:= Substr(obter_desc_exp_idioma(326864,locale_w) || ': ' || nr_seq_contrato_w || chr(10) || ' ' ||
							obter_desc_exp_idioma(645613,locale_w) || ': ' || ds_titulo_contrato_w || chr(10) || ' ' ||
							obter_desc_exp_idioma(286142,locale_w) || ': ' || cd_contrato_w || ' - ' || ds_objeto_contrato_w || chr(10) || chr(10) || ' ' ||
							obter_desc_exp_idioma(286135,locale_w) || ': ' || nm_contratado_w || chr(10) || ' ' ||
							obter_desc_exp_idioma(295799,locale_w) || ': ' || nm_pessoa_contratada_w || chr(10) || ' ' ||
							obter_desc_exp_idioma(299368,locale_w) || ': ' || ds_tipo_contrato_w || chr(10) || ' ' ||
							obter_desc_exp_idioma(294577,locale_w) || ': ' || ds_objeto_contrato_w || chr(10) || ' ' ||
							obter_desc_exp_idioma(286964,locale_w) || ': ' || dt_inicio_w || chr(10) || ' ' ||
							obter_desc_exp_idioma(301609,locale_w) || ': ' || dt_fim_w || chr(10) || ' ' ||
							obter_desc_exp_idioma(347978,locale_w,'QT_DIAS_VENCER='||qt_dias_vencer_w) || chr(10) || ' ' ||
							obter_desc_exp_idioma(290401,locale_w) || ': ' || ds_forma_renovacao_w || chr(10) || ' ' ||
							obter_desc_exp_idioma(300185,locale_w) || ': ' || vl_total_contrato_w || chr(10) || ' ' ||
							obter_desc_exp_idioma(625272,locale_w) || ': ' || ds_condicao_pagamento_w || chr(10) || ' ' ||
							obter_desc_exp_idioma(290387,locale_w) || ': ' || ds_forma_pagamento_w || chr(10) || ' ' ||
							obter_desc_exp_idioma(293407,locale_w) || ': ' || ds_moeda_w || chr(10) || ' ' ||
							obter_desc_exp_idioma(287209,locale_w) || ': ' || dt_revisao_w || chr(10) || ' ' ||
							obter_desc_exp_idioma(302052,locale_w) || ': ' || campo_mascara_virgula_casas(vl_pagto_w,4) || chr(10) || ' ' ||
							obter_desc_exp_idioma(347980,locale_w) || ': ' || campo_mascara_virgula_casas(vl_saldo_total_w,4),1,4000);
				
				insert into comunic_interna(
					dt_comunicado,
					ds_titulo,
					ds_comunicado,
					nm_usuario,
					dt_atualizacao,
					ie_geral,
					nm_usuario_destino,
					nr_sequencia,
					ie_gerencial,
					nr_seq_classif,
					dt_liberacao,
					ds_setor_adicional,
					ds_perfil_adicional)
				values (	clock_timestamp() + interval '1 days'/86400,
					obter_desc_exp_idioma(347981,locale_w),
					ds_mensagem_w,
					'Tasy',
					clock_timestamp(),
					'N',
					nm_usuario_w || ',',
					nr_sequencia_w,
					'N',
					nr_seq_classif_w,
					clock_timestamp(),
					cd_setor_adicional_w,
					cd_perfil_adicional_w);
				end;
				
				if (ds_email_destino_w IS NOT NULL AND ds_email_destino_w::text <> '' AND ds_email_origem_w IS NOT NULL AND ds_email_origem_w::text <> '') then
					begin
					if (substr(ds_email_destino_w,1,1) = ';') then
						ds_email_destino_w := substr(ds_email_destino_w,2,255);
					end if;
					
					begin
					
					CALL enviar_email(	obter_desc_exp_idioma(347981,locale_w),
							ds_mensagem_w,
							ds_email_origem_w,
							ds_email_destino_w,
							nm_usuario_envio_email_w,
							'A');
					exception when others then
						ds_consistencia_w	:= substr(sqlerrm(SQLSTATE),1,2000);
						ds_consistencia_w	:= substr(nr_seq_contrato_w || ' - ' || ds_email_origem_w || ' - ' || ds_email_destino_w || ' - ' || ds_consistencia_w, 1, 2000);
						
					end;
					end;
				end if;
			end if;
		end if;
		end;
	end loop;
	close c01;
	
	end;
end loop;
close C03;

CALL wheb_usuario_pck.set_cd_funcao(null);

exception when others then
	begin
	CALL wheb_usuario_pck.set_cd_funcao(null);
	end;
end;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE avisar_vencimento_contrato ( cd_estabelecimento_p bigint, ie_comunicar_resp_p text default 'S') FROM PUBLIC;

