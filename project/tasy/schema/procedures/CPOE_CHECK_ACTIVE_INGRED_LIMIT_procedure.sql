-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_check_active_ingred_limit (nr_seq_material_prescr_p bigint, nr_atendimento_p bigint, cd_material_p bigint, cd_unidade_medida_p text, ie_tipo_consistencia_p text, ie_dose_out_p INOUT text, cd_unidade_medida_out_p INOUT text, qt_dose_out_p INOUT bigint, ds_mensagem_dose_out_p INOUT text, qt_dose_atend_prescr_out_p INOUT bigint) AS $body$
DECLARE

					
nr_ficha_tecnica_w		medic_ficha_limite.nr_ficha_tecnica%type;
qt_dose_max_w         		medic_ficha_limite.qt_dose_max%type;
cd_unidade_medida_w    		medic_ficha_limite.cd_unidade_medida%type;
ie_dose_limite_w      		medic_ficha_limite.ie_dose_limite%type;
total_prescribed_dose_w		bigint;
final_value_w			bigint;
					
C01 CURSOR FOR
	SELECT	nr_ficha_tecnica,
		qt_dose,
		cd_unidade_medida,
		cd_material
	from	medic_conc_ingrediente
	where	cd_material = cd_material_p;				

BEGIN

for active_ingredients_rule_w in C01 loop
	if (ie_tipo_consistencia_p = 'MAX') then
	
		select	nr_ficha_tecnica,
			ie_dose_limite,
			cd_unidade_medida,
			qt_dose_max
		into STRICT	nr_ficha_tecnica_w,
			ie_dose_limite_w,
			cd_unidade_medida_w,
			qt_dose_max_w
		from	medic_ficha_limite
		where	nr_ficha_tecnica = active_ingredients_rule_w.nr_ficha_tecnica;
		
			select	coalesce(sum(x.dose_total),0)
			into STRICT	total_prescribed_dose_w
			from	(	SELECT	coalesce(sum((check_active_ingred(obter_dose_convertida(cd_material, qt_dose, cd_unidade_medida, cd_unidade_medida_w ),cd_material,
												active_ingredients_rule_w.nr_ficha_tecnica,'CV'))::numeric ),0) dose_total
					from cpoe_material_vig_v
					where	nr_atendimento	= nr_atendimento_p
					and ((dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') or (nm_usuario = wheb_usuario_pck.get_nm_usuario))
					and coalesce(dt_lib_suspensao::text, '') = ''
					and coalesce(dt_suspensao::text, '') = ''
					and check_active_ingred(null,cd_material, active_ingredients_rule_w.nr_ficha_tecnica, 'N') = 'S'
					and to_date(dt_inicio) between to_date(clock_timestamp() - interval '1 days') and to_date(clock_timestamp())
					
union
	
					SELECT	coalesce(sum((check_active_ingred(obter_dose_convertida(b.cd_material, c.qt_dose, c.cd_unidade_medida, cd_unidade_medida_w), b.cd_material,
												active_ingredients_rule_w.nr_ficha_tecnica,'CV'))::numeric ),0) dose_total
						from	prescr_mat_hor c,
							prescr_material b,
							prescr_medica a
					where		a.nr_prescricao		= b.nr_prescricao
					and		a.nr_atendimento	= nr_atendimento_p
					and		b.nr_prescricao		= c.nr_prescricao
					and		b.nr_sequencia		= c.nr_seq_material
					and		coalesce(a.dt_suspensao::text, '') = ''
					and		coalesce(b.ie_suspenso,'N')	= 'N'
					and		coalesce(c.dt_suspensao::text, '') = ''
					and 		check_active_ingred(null,b.cd_material, active_ingredients_rule_w.nr_ficha_tecnica, 'N') = 'S'
					and		to_date(a.dt_inicio_prescr) between to_date(clock_timestamp() - interval '1 days') and to_date(clock_timestamp())) x;
			
			final_value_w := total_prescribed_dose_w;

			if (final_value_w IS NOT NULL AND final_value_w::text <> '') then
				ds_mensagem_dose_out_p := substr(qt_dose_max_w || ' ' || cd_unidade_medida_w || '/' || ie_dose_limite_w, 1, 255);
				ie_dose_out_p := ie_dose_limite_w;
				cd_unidade_medida_out_p := cd_unidade_medida_w;
				qt_dose_out_p := qt_dose_max_w;
				qt_dose_atend_prescr_out_p := final_value_w;
			end if;
	end if;
end loop;



end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_check_active_ingred_limit (nr_seq_material_prescr_p bigint, nr_atendimento_p bigint, cd_material_p bigint, cd_unidade_medida_p text, ie_tipo_consistencia_p text, ie_dose_out_p INOUT text, cd_unidade_medida_out_p INOUT text, qt_dose_out_p INOUT bigint, ds_mensagem_dose_out_p INOUT text, qt_dose_atend_prescr_out_p INOUT bigint) FROM PUBLIC;

