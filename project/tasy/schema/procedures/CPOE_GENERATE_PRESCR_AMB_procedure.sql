-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_generate_prescr_amb ( nr_atendimento_p bigint, ds_lista_seq_itens_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_receita_amb_ant_w		cpoe_material.nr_seq_receita_amb%type;
nr_sequencia_w					fa_receita_farmacia_item.nr_sequencia%type;
nr_dias_receita_w				fa_receita_farmacia_item.nr_dias_receita%type;
ds_texto_w						fa_medic_farmacia_amb.ds_texto_padrao_receita%type;
dt_liberacao_enf_ww  cpoe_material.dt_liberacao_enf%type;
ie_segunda_w 		varchar(2);
ie_terca_w 		varchar(2);
ie_quarta_w		varchar(2);
ie_quinta_w 		varchar(2);
ie_sexta_w		varchar(2);
ie_sabado_w 		varchar(2);
ie_domingo_w 		varchar(2);
ie_dia_w		smallint;
nrDia_w			smallint;
i			smallint;

c01 CURSOR FOR
SELECT	cd_material,
		qt_dose,
		cd_unidade_medida,
		cd_intervalo,
		ie_via_aplicacao,
		ds_dose_diferenciada,
		ie_se_necessario,
		ds_justificativa,
		ds_observacao,
		coalesce(nr_seq_receita_amb,0) nr_seq_receita_amb,
		dt_inicio,
		dt_fim,
		nr_sequencia,
		ie_duracao
from	cpoe_material
where	ds_lista_seq_itens_p like '%' || nr_sequencia || '%'
and		nr_atendimento = nr_atendimento_p
order by nr_seq_receita_amb, nr_sequencia;
BEGIN
nr_seq_receita_amb_ant_w := 0;
for r_c01 in c01 loop
	begin
	if (r_c01.nr_seq_receita_amb > 0) then
		if (nr_seq_receita_amb_ant_w <> r_c01.nr_seq_receita_amb) then
			CALL cpoe_fa_liberar_receita(nr_seq_receita_amb_ant_w, nm_usuario_p);
			nr_seq_receita_amb_ant_w := r_c01.nr_seq_receita_amb;
		end if;

		if (r_c01.dt_fim IS NOT NULL AND r_c01.dt_fim::text <> '') then
			nr_dias_receita_w := obter_tempo_entre_datas(trunc(r_c01.dt_inicio), trunc(r_c01.dt_fim),'D');
		end if;

		select 	coalesce(max(ds_texto_padrao_receita), ' ')
		into STRICT	ds_texto_w
		from 	fa_medic_farmacia_amb
		where 	cd_material = r_c01.cd_material
		and 	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;
		
		ie_segunda_w := 'N';
		ie_terca_w := 'N';
		ie_quarta_w := 'N';
		ie_quinta_w := 'N';
		ie_sexta_w := 'N';
		ie_sabado_w := 'N';
		ie_domingo_w := 'N';
		
		if (r_c01.ie_duracao = 'C') or (coalesce(r_c01.dt_fim::text, '') = '') or (abs(r_c01.dt_inicio - coalesce(r_c01.dt_fim,r_c01.dt_inicio)) > 6) then

			ie_segunda_w := 'S';
			ie_terca_w := 'S';
			ie_quarta_w := 'S';
			ie_quinta_w := 'S';
			ie_sexta_w := 'S';
			ie_sabado_w := 'S';
			ie_domingo_w := 'S';
		else
			
			ie_dia_w := PKG_DATE_UTILS.get_WeekDay(r_c01.dt_inicio);
			
			for i in ie_dia_w..ie_dia_w + abs(trunc(r_c01.dt_inicio) - trunc(r_c01.dt_fim))
			loop
				if (i > 7) then
					nrDia_w := i - 7;
				else
					nrDia_w := i;
				end if;
			
				if (2 = nrDia_w and ie_segunda_w = 'N') then
					ie_segunda_w := 'S';
				end if;
				
				if (3 = nrDia_w and ie_terca_w = 'N') then
					ie_terca_w := 'S';
				end if;
				
				if (4 = nrDia_w and ie_quarta_w = 'N') then
					ie_quarta_w := 'S';
				end if;
				
				if (5 = nrDia_w and ie_quinta_w = 'N') then
					ie_quinta_w := 'S';
				end if;
				
				if (6 = nrDia_w and ie_sexta_w = 'N') then
					ie_sexta_w := 'S';
				end if;
				
				if (7 = nrDia_w and ie_sabado_w = 'N') then
					ie_sabado_w := 'S';
				end if;
				
				if (1 = nrDia_w and ie_domingo_w = 'N') then
					ie_domingo_w := 'S';
				end if;
			end loop;
		end if;

		select	nextval('fa_receita_farmacia_item_seq')
		into STRICT	nr_sequencia_w
		;

		insert	into fa_receita_farmacia_item(
					nr_sequencia,
					nr_seq_receita,
					cd_material,
					qt_dose,
					cd_unidade_medida,
					cd_intervalo,
					ie_via_aplicacao,
					ds_dose_diferenciada,
					ie_se_necessario,
					ds_justificativa,
					ds_observacao,
					dt_atualizacao_nrec,
					dt_atualizacao,
					nm_usuario,
					nm_usuario_nrec,
					dt_inicio_receita,
					dt_validade_receita,
					nr_dias_receita,
					ds_texto_receita,
					ie_segunda,
					ie_terca,
					ie_quarta,
					ie_quinta,
					ie_sexta,
					ie_sabado,
					ie_domingo)
				values (
					nr_sequencia_w,
					r_c01.nr_seq_receita_amb,
					r_c01.cd_material,
					r_c01.qt_dose,
					r_c01.cd_unidade_medida,
					r_c01.cd_intervalo,
					r_c01.ie_via_aplicacao,
					r_c01.ds_dose_diferenciada,
					r_c01.ie_se_necessario,
					r_c01.ds_justificativa,
					r_c01.ds_observacao,
					clock_timestamp(),
					clock_timestamp(),
					nm_usuario_p,
					nm_usuario_p,
					r_c01.dt_inicio,
					r_c01.dt_fim,
					nr_dias_receita_w,
					ds_texto_w,
					ie_segunda_w,
					ie_terca_w,
					ie_quarta_w,
					ie_quinta_w,
					ie_sexta_w,
					ie_sabado_w,
					ie_domingo_w);

		update	cpoe_material
		set		dt_liberacao_enf = clock_timestamp(),
				nm_usuario_lib_enf = nm_usuario_p,
				dt_liberacao_farm = clock_timestamp(),
				nm_usuario_lib_farm = nm_usuario_p
		where	nr_sequencia = r_c01.nr_sequencia;

		select coalesce(max(dt_liberacao_farm),clock_timestamp() - interval '10 days')
		into STRICT 	dt_liberacao_enf_ww
		from 	cpoe_material
		where	nr_sequencia = r_c01.nr_sequencia;

    CALL consistir_regulacao_pep(r_c01.nr_sequencia, 'CPOE_MATERIAL');

		commit;
	end if;
	end;
end loop;

CALL cpoe_fa_liberar_receita(nr_seq_receita_amb_ant_w, nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_generate_prescr_amb ( nr_atendimento_p bigint, ds_lista_seq_itens_p text, nm_usuario_p text) FROM PUBLIC;

