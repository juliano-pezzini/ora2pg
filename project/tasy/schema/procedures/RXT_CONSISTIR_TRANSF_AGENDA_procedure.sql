-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rxt_consistir_transf_agenda ( nr_seq_origem_p bigint, nr_seq_destino_p bigint, ie_acao_p text, cd_estabelecimento_p bigint, nm_usuario_p text, nr_min_duracao_origem_p bigint default 0, ds_erro_p INOUT text DEFAULT NULL) AS $body$
DECLARE



ds_erro_w			varchar(255);
ie_status_agenda_destino_w	varchar(3);

nr_seq_tratamento_w		bigint;
nr_seq_protocolo_w		bigint;
nr_seq_tipo_tratamento_w 		bigint;
qt_registros_w			bigint;
nr_min_duracao_origem_w	 	bigint;
nr_min_duracao_destino_w		bigint;
nr_seq_equipamento_origem_w	bigint;
nr_seq_equipamento_destino_w	bigint;

ie_sobreposicao_w           		varchar(1);
dt_agenda_destino_w  		timestamp;


BEGIN

ds_erro_w		:= null;

-- consulta da origem
select  coalesce(max(a.nr_seq_tratamento),0),
	coalesce(max(b.nr_seq_protocolo),0),
	coalesce(max(c.nr_seq_tipo),0),
	max(a.nr_minuto_duracao),
	max(a.nr_seq_equipamento)
into STRICT    nr_seq_tratamento_w,
	nr_seq_protocolo_w,
	nr_seq_tipo_tratamento_w,
	nr_min_duracao_origem_w,
	nr_seq_equipamento_origem_w
from 	rxt_agenda a,
	rxt_tratamento b,
	rxt_tumor c
where 	a.nr_seq_tratamento = b.nr_sequencia
and 	b.nr_seq_tumor = c.nr_sequencia
and   	a.nr_sequencia = nr_seq_origem_p;


-- consulta do destino
select	max(ie_status_agenda),
	max(nr_minuto_duracao),
	max(nr_seq_equipamento),
	max(dt_agenda)
into STRICT	ie_status_agenda_destino_w,
	nr_min_duracao_destino_w,
	nr_seq_equipamento_destino_w,
	dt_agenda_destino_w
from	rxt_Agenda
where 	nr_sequencia = nr_seq_destino_p;

if (nr_seq_tratamento_w <> 0) then
	if (nr_seq_protocolo_w <> 0) then
		select count(*)
		into STRICT qt_registros_w
		from (SELECT nr_sequencia
		from rxt_protocolo
		where nr_sequencia = nr_seq_protocolo_w
		and nr_seq_equipamento = nr_seq_equipamento_destino_w
		
union

		SELECT nr_seq_protocolo
		from rxt_protocolo_equip
		where nr_seq_protocolo = nr_seq_protocolo_w
		and nr_seq_equipamento = nr_seq_equipamento_destino_w)  a;

		if (qt_registros_w = 0) then
			ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(353484,null);
		end if;
	else
		select count(*)
		into STRICT qt_registros_w
		from rxt_equip_tipo
		where nr_seq_tipo = nr_seq_tipo_tratamento_w
		and nr_seq_equipamento = nr_seq_equipamento_destino_w;
		if (qt_registros_w = 0) then
			ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(353485,null);
		end if;
	end if;

end if;

ie_sobreposicao_w := 'N';

if (nr_min_duracao_origem_p > 0) then
	nr_min_duracao_origem_w := nr_min_duracao_origem_p;
end if;

select  rxt_obter_se_sobrepos_horario(nr_seq_equipamento_destino_w, dt_agenda_destino_w, nr_min_duracao_origem_w)
  into STRICT  ie_sobreposicao_w
;

if (ie_sobreposicao_w = 'S') then
	ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(328607,null);
end if;

-- verifica hor√°rio de destino liberado
if (ie_status_agenda_destino_w <> 'L') then
	ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(279820,null);
end if;

ds_erro_p		:= ds_erro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rxt_consistir_transf_agenda ( nr_seq_origem_p bigint, nr_seq_destino_p bigint, ie_acao_p text, cd_estabelecimento_p bigint, nm_usuario_p text, nr_min_duracao_origem_p bigint default 0, ds_erro_p INOUT text DEFAULT NULL) FROM PUBLIC;

