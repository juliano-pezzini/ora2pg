-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_desfazer_escrit_lote_reemb (nr_seq_lote_reemb_cred_p pls_lote_reemb_credito.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_seq_banco_escrit_w		banco_escritural.nr_sequencia%type;
dt_baixa_w			banco_escritural.dt_baixa%type;
dt_liberacao_w			banco_escritural.dt_liberacao%type;

c01 CURSOR(nr_seq_escrit_pc	titulo_pagar_escrit.nr_seq_escrit%type) FOR
SELECT	a.nr_titulo
from	titulo_pagar_escrit a
where	a.nr_seq_escrit		= nr_seq_escrit_pc;

BEGIN

select	nr_seq_banco_escrit
into STRICT	nr_seq_banco_escrit_w
from	pls_lote_reemb_credito a
where	a.nr_sequencia = nr_seq_lote_reemb_cred_p;

select	max(dt_baixa),
	max(dt_liberacao)
into STRICT	dt_baixa_w,
	dt_liberacao_w
from	banco_escritural
where	nr_sequencia	= nr_seq_banco_escrit_w;

if (dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '') or (dt_baixa_w IS NOT NULL AND dt_baixa_w::text <> '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(343668); -- O pagamento escritural vinculado a este lote de agrupamento já está baixado ou liberado!
end if;

for r_c01_w in c01(nr_seq_banco_escrit_w) loop
	delete	from titulo_pagar_escrit
	where	nr_titulo		= r_c01_w.nr_titulo
	and	nr_seq_escrit		= nr_seq_banco_escrit_w;
end loop;

update 	pls_lote_reemb_credito
set	nr_seq_banco_escrit 	 = NULL,
	dt_geracao_pag_escrit	 = NULL,
	dt_atualizacao		= clock_timestamp(),
	nm_usuario		= nm_usuario_p
where	nr_sequencia		= nr_seq_lote_reemb_cred_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_desfazer_escrit_lote_reemb (nr_seq_lote_reemb_cred_p pls_lote_reemb_credito.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

