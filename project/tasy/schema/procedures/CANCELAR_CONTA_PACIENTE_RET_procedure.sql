-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cancelar_conta_paciente_ret ( nr_interno_conta_p bigint, nm_usuario_p text) AS $body$
DECLARE

	 
nr_sequencia_w		bigint;
nr_seq_protocolo_w		bigint;
vl_nf_w			double precision;
vl_titulo_w			double precision := 0;
ie_situacao_w			varchar(1);
qt_retorno_w			integer;
dt_atualizacao_estoque_w	timestamp;


BEGIN 
 
if (nr_interno_conta_p > 0) then 
	select	coalesce(max(nr_seq_protocolo),0) 
	into STRICT	nr_seq_protocolo_w 
	from	conta_paciente 
	where	nr_interno_conta = nr_interno_conta_p;
 
	begin 
	select	nr_sequencia, 
		ie_situacao, 
		dt_atualizacao_estoque 
	into STRICT	nr_sequencia_w, 
		ie_situacao_w, 
		dt_atualizacao_estoque_w 
	from	nota_fiscal 
	where	nr_interno_conta = nr_interno_conta_p 
	and	ie_situacao = '1';
	exception 
		when no_data_found then 
			nr_sequencia_w := null;
	end;
 
	if (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') then 
		begin 
		select	vl_total_nota 
		into STRICT	vl_nf_w 
		from	nota_fiscal 
		where	nr_sequencia	= nr_sequencia_w 
		and	nr_interno_conta = nr_interno_conta_p;
		exception 
			when others then 
	   			CALL Wheb_mensagem_pck.exibir_mensagem_abort(231032);
		end;
 
		/*Anderson 12/06/2007 OS59658 - Para cancelar as notas que não estejam calculadas, para as calculadas estornar*/
 
		if (dt_atualizacao_estoque_w IS NOT NULL AND dt_atualizacao_estoque_w::text <> '') then 
			CALL estornar_nota_fiscal(nr_sequencia_w,nm_usuario_p);
		else 
			/* 
			cancelar_nf(nr_sequencia_w,nm_usuario_p); 
			*/
 
 
			-- Edgar 07/01/2008, OS 71728, conforme conversado com Fabio, foi tirada a cancelar_nf e colocado update abaixo 
			-- para a nf não perder o vínculo com a conta/protocolo 
 
			update	nota_fiscal 
			set	ie_situacao 		= 9, 
				nr_seq_exportada	 = NULL, 
				ie_status_envio		 = NULL, 
				nm_usuario		= nm_usuario_p, 
				dt_atualizacao		= clock_timestamp() 
			where	nr_sequencia 		= nr_sequencia_w;
 
		end if;
	end if;	
			 
	CALL Cancelar_Titulo_Conta(nr_interno_conta_p, nr_seq_protocolo_w, nm_usuario_p, 'N');
 
	/* Francisco - OS 70878 - 09/10/2007 - Se a conta é cancelada o vínculo com adiantamento deve ser excluído */
 
	delete 	from conta_paciente_adiant 
	where	nr_interno_conta	= nr_interno_conta_p;
 
	 
	CALL Estornar_Conta_Paciente(nr_interno_conta_p, nm_usuario_p);
 
	commit;
 
end if;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cancelar_conta_paciente_ret ( nr_interno_conta_p bigint, nm_usuario_p text) FROM PUBLIC;

