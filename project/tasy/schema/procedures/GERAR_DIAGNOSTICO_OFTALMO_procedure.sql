-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_diagnostico_oftalmo ( nr_seq_diag_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, ds_observacao_p text, cd_profissional_p text, ie_paciente_p text, nm_usuario_p text, nr_seq_consulta_p bigint, cd_pessoa_p text, ie_olho_p text, ie_libera_p text, nr_atendimento_p bigint, nr_seq_parentesco_p bigint, ie_diagnostico_paciente_p text default 'N') AS $body$
DECLARE


cd_doenca_cid_w		varchar(10);


BEGIN

begin
select	cd_doenca_cid
into STRICT	cd_doenca_cid_w
from	oft_tipo_diagnostico
where	nr_sequencia	=	nr_seq_diag_p;
exception
when others then
	cd_doenca_cid_w := null;
end;
if (coalesce(ie_libera_p::text, '') = '') then
	insert into oft_diagnostico(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_profissional,
		dt_registro,
		nr_seq_grau_parentesco,
		nr_seq_diag,
		cd_doenca_cid,
		ie_paciente,
		nr_seq_consulta,
		dt_inicio,
		dt_fim,
		ds_observacao,
		cd_pessoa_fisica,
		ie_olho,
		ie_situacao)
	values (
		nextval('oft_diagnostico_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_profissional_p,
		clock_timestamp(),
		nr_seq_parentesco_p,
		nr_seq_diag_p,
		cd_doenca_cid_w,
		ie_paciente_p,
		nr_seq_consulta_p,
		dt_inicio_p,
		dt_fim_p,
		substr(ds_observacao_p,1,255),
		cd_pessoa_p,
		ie_olho_p,
		'A');
elsif (ie_libera_p = 'L') then
	insert into oft_diagnostico(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_profissional,
		dt_registro,
		nr_seq_grau_parentesco,
		nr_seq_diag,
		cd_doenca_cid,
		ie_paciente,
		nr_seq_consulta,
		dt_inicio,
		dt_fim,
		ds_observacao,
		cd_pessoa_fisica,
		ie_olho,
		dt_liberacao,
		ie_situacao)
	values (
		nextval('oft_diagnostico_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_profissional_p,
		clock_timestamp(),
		nr_seq_parentesco_p,
		nr_seq_diag_p,
		cd_doenca_cid_w,
		ie_paciente_p,
		nr_seq_consulta_p,
		dt_inicio_p,
		dt_fim_p,
		substr(ds_observacao_p,1,255),
		cd_pessoa_p,
		ie_olho_p,
		clock_timestamp(),
		'A');
end if;

if (ie_diagnostico_paciente_p = 'S') then
	CALL gerar_diagn_atend_oftalmo(	nr_seq_diag_p,
							dt_inicio_p,
							dt_fim_p,
							substr(ds_observacao_p,1,255),
							cd_profissional_p,
							ie_paciente_p,
							nm_usuario_p,
							nr_seq_consulta_p,
							cd_pessoa_p		,
							ie_olho_p,
							ie_libera_p	,
							nr_atendimento_p);
end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_diagnostico_oftalmo ( nr_seq_diag_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, ds_observacao_p text, cd_profissional_p text, ie_paciente_p text, nm_usuario_p text, nr_seq_consulta_p bigint, cd_pessoa_p text, ie_olho_p text, ie_libera_p text, nr_atendimento_p bigint, nr_seq_parentesco_p bigint, ie_diagnostico_paciente_p text default 'N') FROM PUBLIC;

