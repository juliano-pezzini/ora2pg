-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicate_event_with_copy (NR_SEQUENCIA_P bigint , NR_SEQ_ETAPA_P bigint , DS_EVENTO_P text ) AS $body$
DECLARE


DUP_COUNT_COPY_W bigint;
DUP_EVENT_COUNT_W bigint;
NEW_EVENT_W varchar(255);


BEGIN

SELECT COUNT(*) INTO STRICT DUP_EVENT_COUNT_W
FROM PROTOCOLO_INTEGRADO_EVENTO
WHERE NR_SEQ_ETAPA = NR_SEQ_ETAPA_P AND 
DS_EVENTO = DS_EVENTO_P || '-' || OBTER_DESC_EXPRESSAO(347811);

IF DUP_EVENT_COUNT_W = 0 THEN 
  NEW_EVENT_W := (DS_EVENTO_P || '-' || OBTER_DESC_EXPRESSAO(347811));

ELSE

  SELECT COUNT(*) INTO STRICT DUP_COUNT_COPY_W
  FROM PROTOCOLO_INTEGRADO_EVENTO
  WHERE NR_SEQ_ETAPA = NR_SEQ_ETAPA_P AND 
  ((DS_EVENTO LIKE(DS_EVENTO_P || '-' || OBTER_DESC_EXPRESSAO(347811) || '%')) AND (DS_EVENTO NOT LIKE(DS_EVENTO_P || '-' || OBTER_DESC_EXPRESSAO(347811)|| '%' || '-' || OBTER_DESC_EXPRESSAO(347811) || '%')));

  NEW_EVENT_W := (DS_EVENTO_P || '-' || OBTER_DESC_EXPRESSAO(347811) || DUP_COUNT_COPY_W);

END IF;

INSERT INTO PROTOCOLO_INTEGRADO_EVENTO(
        NR_SEQUENCIA,
        DT_ATUALIZACAO,
        NM_USUARIO,
        DT_ATUALIZACAO_NREC,
        NM_USUARIO_NREC,
        DS_EVENTO,
        IE_TIPO_EVENTO,
        NR_DIA_EVENTO,
        NR_SEQ_PONTO_VERIFICACAO,
        NR_SEQ_ETAPA,
        DS_EVENTO_PACIENTE,
        IE_TIPO_AGENDAMENTO,
        CD_ESPECIALIDADE,
        IE_OCULTAR_VISAO_PACIENTE,
        IE_TIPO_ATENDIMENTO,
        IE_CLINICA,
        CD_PROCEDIMENTO,
        IE_ORIGEM_PROCED,
        CD_PROTOCOLO,
        NR_SEQ_GRUPO_EXAME_LAB,
        NR_SEQ_PROTOCOLO,
        NR_SEQ_TIPO_CONSULTA,
        NR_DIAS_ANT,
        NR_DIAS_DEP,
        NR_SEQ_DISPOSITIVO,
        NR_SEQ_EVENTO,
        NR_SEQ_ESCALA,
        NR_SEQ_SCORE_FLEX,
        NR_SEQ_SCORE_FLEX_II,
        NR_SEQ_INTERVENCAO,
        NR_SEQ_ORDEM,
        NR_SEQ_CLASSIF,
        IE_ACAO,
        DS_RESULTADO_EVENTO,
        IE_EVENTO_CRITICO,
        NR_SEQ_GRU_EX_NAO_LAB,
        DT_PROV_PARTO,
        CD_CLASSIF_SETOR,
        IE_DOSE,
        NR_SEQ_VACINA,
        DT_AVALIACAO,
        IE_TIPO,
        CD_ESPECIALIDADE_MEDICO,
        IE_EVOLUCAO_CLINICA,
        NR_SEQ_PROGRAMA_SAUDE,
        NR_SEQ_TEMPLATE,
        NR_SEQ_AVALIACAO,
        NR_DIA_PROTOCOLO
    )  
    SELECT 
        nextval('protocolo_integrado_evento_seq'),
        clock_timestamp(),
        WHEB_USUARIO_PCK.GET_NM_USUARIO,
        clock_timestamp(),
        WHEB_USUARIO_PCK.GET_NM_USUARIO,
        NEW_EVENT_W,
        A.IE_TIPO_EVENTO,
        A.NR_DIA_EVENTO,
        A.NR_SEQ_PONTO_VERIFICACAO,
        A.NR_SEQ_ETAPA,
        A.DS_EVENTO_PACIENTE,
        A.IE_TIPO_AGENDAMENTO,
        A.CD_ESPECIALIDADE,
        A.IE_OCULTAR_VISAO_PACIENTE,
        A.IE_TIPO_ATENDIMENTO,
        A.IE_CLINICA,
        A.CD_PROCEDIMENTO,
        A.IE_ORIGEM_PROCED,
        A.CD_PROTOCOLO,
        A.NR_SEQ_GRUPO_EXAME_LAB,
        A.NR_SEQ_PROTOCOLO,
        A.NR_SEQ_TIPO_CONSULTA,
        A.NR_DIAS_ANT,
        A.NR_DIAS_DEP,
        A.NR_SEQ_DISPOSITIVO,
        A.NR_SEQ_EVENTO,
        A.NR_SEQ_ESCALA,
        A.NR_SEQ_SCORE_FLEX,
        A.NR_SEQ_SCORE_FLEX_II,
        A.NR_SEQ_INTERVENCAO,
        A.NR_SEQ_ORDEM,
        A.NR_SEQ_CLASSIF,
        A.IE_ACAO,
        A.DS_RESULTADO_EVENTO,
        A.IE_EVENTO_CRITICO,
        A.NR_SEQ_GRU_EX_NAO_LAB,
        A.DT_PROV_PARTO,
        A.CD_CLASSIF_SETOR,
        A.IE_DOSE,
        A.NR_SEQ_VACINA,
        A.DT_AVALIACAO,
        A.IE_TIPO,
        A.CD_ESPECIALIDADE_MEDICO,
        A.IE_EVOLUCAO_CLINICA,
        A.NR_SEQ_PROGRAMA_SAUDE,
        A.NR_SEQ_TEMPLATE,
        A.NR_SEQ_AVALIACAO,
        A.NR_DIA_PROTOCOLO
    FROM PROTOCOLO_INTEGRADO_EVENTO A
    WHERE A.NR_SEQUENCIA = NR_SEQUENCIA_P;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicate_event_with_copy (NR_SEQUENCIA_P bigint , NR_SEQ_ETAPA_P bigint , DS_EVENTO_P text ) FROM PUBLIC;

