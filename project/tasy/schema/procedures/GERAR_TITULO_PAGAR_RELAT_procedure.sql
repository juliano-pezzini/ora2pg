-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_titulo_pagar_relat (dt_inicial_p timestamp, dt_final_p timestamp, ie_situacao_p text, cd_cgc_p text, ie_tipo_data_p text, ds_quebra_p text) AS $body$
DECLARE
		

ds_comando_w		varchar(32000);
nr_titulo_w		titulo_pagar.nr_titulo%type;
--ds_pessoa_titulo_w	varchar2(255);
cd_pessoa_fisica_w	titulo_pagar.cd_pessoa_fisica%type;
cd_cgc_w		titulo_pagar.cd_cgc%type;
dt_emissao_w		titulo_pagar.dt_emissao%type;
dt_vencimento_atual_w	titulo_pagar.dt_vencimento_atual%type;
dt_liquidacao_w		titulo_pagar.dt_liquidacao%type;
vl_titulo_w		titulo_pagar.vl_titulo%type;
vl_saldo_juros_w	titulo_pagar.vl_saldo_juros%type;
vl_saldo_multa_w	titulo_pagar.vl_saldo_multa%type;
vl_saldo_titulo_w	titulo_pagar.vl_saldo_titulo%type;
ds_quebra_w		varchar(255);
ds_quebra1_w		varchar(255);
ds_quebra2_w		varchar(255);
ds_quebra3_w		varchar(255);
i			integer;
qt_virgula_w		bigint;
ds_sep_bv_w		varchar(50);


c01 CURSOR FOR
	SELECT	coalesce(a.nr_titulo,0),
		--substr(obter_nome_pf_pj(a.cd_pessoa_fisica, a.cd_cgc),1,200) ds_pessoa_titulo, 
		coalesce(a.cd_pessoa_fisica,''),
		coalesce(a.cd_cgc,''),
		to_date(a.dt_emissao,'dd/mm/yyyy'),
		to_date(a.dt_vencimento_atual,'dd/mm/yyyy'),
		to_date(a.dt_liquidacao,'dd/mm/yyyy'),
		coalesce(a.vl_titulo,0),
		coalesce(a.vl_saldo_juros,0),
		coalesce(a.vl_saldo_multa,0),
		coalesce(a.vl_saldo_titulo,0)
	from	titulo_pagar a
	where	1 = 1
	and	((ie_tipo_data_p	= 'E'
	and (a.dt_emissao		between dt_inicial_p and dt_final_p))
	or (ie_tipo_data_p		= 'V'
	and (a.dt_vencimento_atual	between dt_inicial_p and dt_final_p))
	or (ie_tipo_data_p		= 'L'
	and (a.dt_liquidacao	between dt_inicial_p and dt_final_p)))
	and (a.ie_situacao		= ie_situacao_p
	or	coalesce(ie_situacao_p::text, '') = '')
	and (a.cd_cgc		= cd_cgc_p
	or	coalesce(cd_cgc_p::text, '') = '');
	/*order by ds_pessoa_titulo,
		a.dt_emissao,
		a.dt_vencimento_atual,
		a.dt_liquidacao*/
BEGIN

ds_sep_bv_w	:= obter_separador_bv;

if (ds_quebra_p IS NOT NULL AND ds_quebra_p::text <> '') then

	for	i in 1..length(ds_quebra_p) loop

		if (substr(ds_quebra_p, i, 1) = ',') then
			qt_virgula_w	:= coalesce(qt_virgula_w,0) + 1;
		end if;

	end	loop;

end if;

if (qt_virgula_w	> 2) then
	
	CALL wheb_mensagem_pck.exibir_mensagem_abort(296009);

end if;

CALL exec_sql_dinamico('Tasy', 'drop table w_titulo_pagar_relat');

ds_comando_w		:= 'create table w_titulo_pagar_relat (		' ||
				' nr_titulo		number(10,0),	' ||
				' cd_pessoa_fisica	varchar2(10),	' ||
				' cd_cgc		varchar2(14),	' ||
				' dt_emissao		date, 		' ||
				' dt_vencimento_atual	date, 		' ||
				' dt_liquidacao		date, 		' ||
				' vl_titulo		number(15,2), 	' ||
				' vl_saldo_juros	number(15,2), 	' ||
				' vl_saldo_multa	number(15,2), 	' ||
				' vl_saldo_titulo	number(15,2), 	' ||	
				' ds_quebra1 		varchar2(255),	' ||			
				' ds_quebra2 		varchar2(255),	' ||	  
				' ds_quebra3 		varchar2(255))	';

CALL exec_sql_dinamico('Tasy', ds_comando_w);

-- inserir registros
open c01;
loop
fetch c01 into
	nr_titulo_w,
	cd_pessoa_fisica_w,
	cd_cgc_w,
	dt_emissao_w,
	dt_vencimento_atual_w,
	dt_liquidacao_w,
	vl_titulo_w,
	vl_saldo_juros_w,
	vl_saldo_multa_w,
	vl_saldo_titulo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	ds_quebra1_w	:= null;
	ds_quebra2_w	:= null;
	ds_quebra3_w	:= null;

	if (position(', 1,' in replace(replace(ds_quebra_p,'(',', '),')',','))	> 0) then

		ds_quebra1_w	:= obter_nome_pf_pj(cd_pessoa_fisica_w,cd_cgc_w);

	end if;
	
	if (position(', 2,' in replace(replace(ds_quebra_p,'(',', '),')',','))	> 0) then
	
		if (coalesce(ds_quebra1_w::text, '') = '') then

			ds_quebra1_w	:= to_char(dt_vencimento_atual_w,'dd/mm/yyyy');
			
		else

			ds_quebra2_w	:= to_char(dt_vencimento_atual_w,'dd/mm/yyyy');

		end if;
	
	end if;

	if (position(', 3,' in replace(replace(ds_quebra_p,'(',', '),')',','))	> 0) then
		
		if (coalesce(ds_quebra1_w::text, '') = '') then
		
			ds_quebra1_w	:= to_char(dt_emissao_w,'dd/mm/yyyy');
		
		elsif (coalesce(ds_quebra2_w::text, '') = '') then

			ds_quebra2_w 	:= to_char(dt_emissao_w,'dd/mm/yyyy');

		else

			ds_quebra3_w	:= to_char(dt_emissao_w,'dd/mm/yyyy');

		end if;

	end if;
	
	ds_comando_w	:=	'insert into w_titulo_pagar_relat (	' ||
					' nr_titulo, 			' ||
					' cd_pessoa_fisica, 	' ||
					' cd_cgc, 				' ||
					' dt_emissao, 			' ||
					' dt_vencimento_atual, 	' ||
					' dt_liquidacao, 		' ||
					' vl_titulo, 			' ||
					' vl_saldo_juros, 		' ||
					' vl_saldo_multa, 		' ||
					' vl_saldo_titulo, 		' ||
					' ds_quebra1,			' ||
					' ds_quebra2,			' ||
					' ds_quebra3) 			' ||
					' values (				' ||
					' :nr_titulo, 			' ||
					' :cd_pessoa_fisica, 	' ||
					' :cd_cgc, 				' ||
					' :dt_emissao, 			' ||
					' :dt_vencimento_atual, ' ||
					' :dt_liquidacao, 		' ||
					' :vl_titulo, 			' ||
					' :vl_saldo_juros, 		' ||
					' :vl_saldo_multa, 		' ||
					' :vl_saldo_titulo, 	' ||
					' :ds_quebra1,			' ||
					' :ds_quebra2,			' ||
					' :ds_quebra3)';
				
	CALL exec_sql_dinamico_bv('Tasy', ds_comando_w,
					'nr_titulo=' 			|| coalesce(nr_titulo_w,0) 			|| ds_sep_bv_w ||
					'cd_pessoa_fisica=' 	|| coalesce(cd_pessoa_fisica_w,'') 	|| ds_sep_bv_w ||
					'cd_cgc=' 				|| coalesce(cd_cgc_w,'') 			|| ds_sep_bv_w ||
					'dt_emissao=' 			|| dt_emissao_w 				|| ds_sep_bv_w ||
					'dt_vencimento_atual=' 	|| dt_vencimento_atual_w 		|| ds_sep_bv_w ||
					'dt_liquidacao=' 		|| dt_liquidacao_w 				|| ds_sep_bv_w ||
					'vl_titulo=' 			|| coalesce(vl_titulo_w,0) 			|| ds_sep_bv_w ||
					'vl_saldo_juros=' 		|| coalesce(vl_saldo_juros_w,0) 		|| ds_sep_bv_w ||
					'vl_saldo_multa=' 		|| coalesce(vl_saldo_multa_w,0) 		|| ds_sep_bv_w ||
					'vl_saldo_titulo=' 		|| coalesce(vl_saldo_titulo_w,0) 	|| ds_sep_bv_w ||
					'ds_quebra1=' 			|| coalesce(ds_quebra1_w,'') 		|| ds_sep_bv_w ||
					'ds_quebra2=' 			|| coalesce(ds_quebra2_w,'') 		|| ds_sep_bv_w ||
					'ds_quebra3=' 			|| coalesce(ds_quebra3_w,'') 		|| ds_sep_bv_w);
																		
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_titulo_pagar_relat (dt_inicial_p timestamp, dt_final_p timestamp, ie_situacao_p text, cd_cgc_p text, ie_tipo_data_p text, ds_quebra_p text) FROM PUBLIC;

