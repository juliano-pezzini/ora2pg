-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_lab_result_item (nr_prescricao_p bigint, nr_seq_prescr_p bigint, cd_exame_p text, qt_resultado_p bigint, pr_resultado_p bigint, ds_resultado_p text, ds_observacao_p text, cd_material_exame_p text, ie_reenvio_p text, nm_usuario_p text, dt_coleta_p timestamp, ds_referencia_p text, ds_unidade_medida_p text, nr_doc_lab_p text, dt_resultado_p timestamp, ds_erro_p INOUT text, nr_seq_exame_atualiz_p bigint default null, cd_metodo_p text default null, qt_minima_p bigint default null, qt_maxima_p bigint default null, pr_minimo_p bigint default null, pr_maximo_p bigint default null, ds_flag_p text default null, ie_final_p text default null, nr_seq_formato_p bigint default null, ie_result_status_p text default null, cd_comment_ext_p text default null) AS $body$
DECLARE


  nr_atendimento_w   bigint;
  nr_seq_resultado_w bigint;
  nr_seq_exame_w     bigint;
  nr_controla_insert smallint;
  ie_formato_w       varchar(3);

  nr_seq_prescr_w         bigint;
  nr_seq_material_w       bigint;
  nr_seq_material_exame_w bigint := 0;
  nr_seq_metodo_w         exame_lab_result_item.nr_seQ_metodo%type;

  qt_resultado_w double precision;
  pr_resultado_w double precision;

  ds_resultado_w  varchar(4000);
  ds_referencia_w varchar(4000);

  cd_estab_w         integer;
  ie_exige_formato_w varchar(1);
  nr_sequencia_w     smallint;
  ie_inseriu_w       boolean := False;
  ds_erro_w          varchar(4000) := '';

  ie_tasylab_w              varchar(1);
  ie_desaprovar_atualizar_w varchar(1);
  dt_aprovacao_exame_w      timestamp;
  ie_status_atend_w         prescr_procedimento.ie_status_atend%type;
  ie_status_atend_update_w  prescr_procedimento.ie_status_atend%type;
  ie_status_baixa_w         lab_parametro.ie_status_baixa%type;
  ie_retorno_conta_w        varchar(1);

  ds_resultado_ant_w exame_lab_result_item.ds_resultado%type;
  qt_resultado_ant_w double precision;
  pr_resultado_ant_w double precision;

  nr_seq_exame_atual_w bigint;
  nr_seq_superior_w    bigint;
  nr_seq_prescr_nova_w integer;

  nr_seq_exame_prescr_w bigint;
  qt_exame_dep_w        bigint;
  nr_seq_gerada_w       integer;

  ie_aprova_integracao_w  varchar(1);
  ie_primeira_aprovacao_w varchar(1) := 'S';

  ie_atual_ref_ger_laudo_w varchar(1);
  qt_minima_w              bigint;
  qt_maxima_w              bigint;
  pr_minimo_w              bigint;
  pr_maximo_w              bigint;
  nr_sequencia_padrao_w    bigint;
  nr_sequencia_criterio_w  bigint;
  ie_tipo_valor_w          bigint := 0;
  ie_consiste_w            varchar(1);

  ie_formato_resultado_w  exame_laboratorio.ie_formato_resultado%type;
  ds_mensagem_criterio_w  lab_valor_padrao_criterio.ds_mensagem%type;
  ie_acao_criterio_lote_w lab_valor_padrao_criterio.ie_acao_criterio%type;
  ie_acao_criterio_w      lote_ent_patol_exam_crit.ie_acao_criterio%type;

  ie_restringe_analito_w lab_parametro.ie_restringe_analito%type;

  C01 CURSOR FOR
    SELECT	el.nr_seq_exame,
      el.nr_seq_superior
    from	exame_laboratorio el
    where coalesce(el.cd_exame_integracao, el.cd_exame) = cd_exame_p
      and el.IE_SITUACAO = 'A'
    
union

    SELECT	e.nr_seq_exame,
      e.nr_seq_superior
    from	exame_laboratorio e
    where	e.nr_seq_exame 	= obter_equip_exame_integracao(cd_exame_p,'FLEURY',1)  
      and e.IE_SITUACAO = 'A'
    
union

    select	e.nr_seq_exame,
      e.nr_seq_superior
    from	exame_laboratorio e
    where	e.nr_seq_exame 	= obter_equip_exame_integracao(cd_exame_p,'LABEXT',1)  
      and e.IE_SITUACAO = 'A'
    order by 1;


BEGIN

select	cd_estabelecimento, nr_atendimento
into STRICT	cd_estab_w, nr_atendimento_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

ie_tasylab_w := obter_param_usuario(0, 26, 0, nm_usuario_p, cd_estab_w, ie_tasylab_w);

begin
    select	
        ie_exige_formato,
        ie_status_baixa,
        ie_aprova_resultado_integ,
        coalesce(IE_RESTRINGE_ANALITO,'N'),
        coalesce(ie_atualizar_result_aprov,'N'),
        coalesce(ie_atual_ref_ger_laudo,'N')
    into STRICT	
        ie_exige_formato_w,
        ie_status_baixa_w,
        ie_aprova_integracao_w,
        ie_restringe_analito_w,
        ie_desaprovar_atualizar_w,
        ie_atual_ref_ger_laudo_w
    from	lab_parametro
    where	cd_estabelecimento = cd_estab_w;
exception
    when others then
        CALL Wheb_mensagem_pck.exibir_mensagem_abort(1121128);
end;

if (coalesce(nr_seq_exame_atualiz_p,0) = 0) then
	open C01;
	loop
	fetch C01 into
		nr_seq_exame_atual_w,
		nr_seq_superior_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		select max(coalesce(nr_sequencia, null))
		into STRICT	nr_seq_prescr_nova_w
		from	prescr_procedimento
		where	nr_prescricao		= nr_prescricao_p
		  and	nr_seq_exame		= nr_seq_exame_atual_w
		  and	nr_sequencia = coalesce(nr_seq_prescr_p,nr_sequencia);

		if (coalesce(nr_seq_prescr_nova_w::text, '') = '') then

			select	max(coalesce(nr_sequencia, null))
			into STRICT	nr_seq_prescr_nova_w
			from	prescr_procedimento
			where	nr_prescricao = nr_prescricao_p
			  and	ie_status_atend >= 30
			  and	nr_seq_exame = nr_seq_superior_w
			  and	nr_sequencia = coalesce(nr_seq_prescr_p,nr_sequencia);

			  if (coalesce(nr_seq_prescr_nova_w::text, '') = '') then

				select	max(coalesce(nr_sequencia, null))
				into STRICT	nr_seq_prescr_nova_w
				from	prescr_procedimento
				where	nr_prescricao = nr_prescricao_p
				and		nr_seq_exame = nr_seq_superior_w
				and		nr_sequencia = coalesce(nr_seq_prescr_p,nr_sequencia);

			end if;
		end if;

		if (nr_seq_prescr_nova_w IS NOT NULL AND nr_seq_prescr_nova_w::text <> '') then
			if (ie_restringe_analito_w = 'S') then
				nr_seq_exame_w	:= nr_seq_exame_atual_w;
			end if;
			
			exit;
		end if;

		end;
	end loop;
	close C01;
	
	if (ie_restringe_analito_w = 'N') then
		nr_seq_exame_w	:= nr_seq_exame_atual_w;
	end if;
else
	nr_seq_exame_w	:= nr_seq_exame_atualiz_p;
end if;

if	((nr_seq_exame_w = 0) or (coalesce(nr_seq_exame_w::text, '') = '')) then
    if (ie_restringe_analito_w = 'S') then
        ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(1121052,'CD_EXAME='||cd_exame_p);
    else
        ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(277882,'CD_EXAME='||cd_exame_p);
    end if;
else
	select coalesce(max(a.nr_seq_resultado),0),
	coalesce(max(coalesce(nr_seq_prescr_p, nr_seq_prescr)),nr_seq_prescr_p)
	into STRICT	nr_seq_resultado_w,
		nr_seq_prescr_w
	from	exame_lab_result_item b,
		exame_lab_resultado a
	where nr_prescricao		= nr_prescricao_p
	  and a.nr_seq_resultado	= b.nr_seq_resultado
	  and b.nr_seq_prescr		= coalesce(nr_seq_prescr_p, nr_seq_prescr)
	  and b.nr_seq_exame		= nr_seq_exame_w;

	if (nr_seq_resultado_w = 0) then

		if (ie_exige_formato_w = 'S') then

			if (nr_seq_prescr_w = 0) then

				select 	coalesce(min(nr_sequencia),0)
				into STRICT	nr_seq_prescr_w
				from 	prescr_procedimento a
				where 	nr_prescricao		= nr_prescricao_p
				  and 	nr_seq_exame		= nr_seq_exame_w
				  and 	cd_material_exame	= coalesce(cd_material_exame_p, cd_material_exame)
				  and 	nr_sequencia		= coalesce(nr_seq_prescr_p, nr_sequencia)
				  and 	not exists (	SELECT 	1
							from	exame_lab_result_item b,
								exame_lab_resultado c
							where	c.nr_seq_resultado	= b.nr_seq_resultado
							  and	c.nr_prescricao		= a.nr_prescricao
							  and	b.nr_seq_prescr		= a.nr_sequencia);
			end if;

			begin

			if (nr_seq_prescr_w <> 0) then

				select 	max(nr_seq_material)
				into STRICT	nr_seq_material_w
				from 	exame_lab_result_item
				where 	nr_seq_resultado	= nr_seq_resultado_w
				  and nr_seq_prescr		= nr_seq_prescr_w
				  and (nr_seq_material IS NOT NULL AND nr_seq_material::text <> '');
				update	prescr_procedimento
				set	ie_status_atend = 30
				where nr_prescricao	= nr_prescricao_p
				  and nr_sequencia	= nr_seq_prescr_w;

				CALL gera_exame_result_lab(nr_prescricao_p, nr_seq_prescr_w, 'N', 'S', 'S', nm_usuario_p);
			else
				CALL gera_exame_result_lab(nr_prescricao_p, null, 'N', 'N', 'S', nm_usuario_p);
			end if;
			exception
				when others then
					ds_erro_w := ds_erro_w || SQLERRM(SQLSTATE);
			end;

			select coalesce(max(a.nr_seq_resultado),0),
				coalesce(max(b.nr_seq_prescr),0)
			into STRICT	nr_seq_resultado_w,
				nr_seq_prescr_w
			from	exame_lab_result_item b,
				exame_lab_resultado a
			where nr_prescricao = nr_prescricao_p
			  and a.nr_seq_resultado = b.nr_seq_resultado
			  and b.nr_seq_exame = nr_seq_exame_w;

			if (nr_seq_resultado_w = 0) then
				ds_erro_w := ds_erro_w || chr(13) || chr(10) || WHEB_MENSAGEM_PCK.get_texto(277883,'NR_PRESCRICAO='||nr_prescricao_p||';CD_EXAME='||cd_exame_p);
			end if;

		else

			select	coalesce(min(b.nr_sequencia),0)
			into STRICT	nr_seq_material_exame_w
			from	material_exame_lab b,
				prescr_procedimento a
			where	a.nr_prescricao		= nr_prescricao_p
			and	a.nr_sequencia		= nr_seq_prescr_p
			and	a.cd_material_exame	= b.cd_material_exame;

			if (cd_metodo_p IS NOT NULL AND cd_metodo_p::text <> '') then

				select	coalesce(max(nr_seq), 0)
				into STRICT	nr_seq_metodo_w
				from (	SELECT	a.nr_sequencia nr_seq
							from	metodo_exame_lab a,
									exame_lab_metodo b
							where	a.nr_sequencia = b.nr_seq_metodo and
									b.nr_seq_exame = nr_seq_exame_w and
									a.ie_situacao  = 'A' and
									a.cd_integracao = cd_metodo_p
							order by ie_prioridade) alias3 LIMIT 1;

				if (coalesce(nr_seq_metodo_w, 0) = 0) then
					select 	coalesce(max(nr_seq), 0)
					into STRICT 	nr_seq_metodo_w
					from (	SELECT 	max(nr_sequencia) nr_seq,
										count(1) count
								from 	metodo_exame_lab
								where 	ie_situacao = 'A' and
										cd_integracao = cd_metodo_p) alias6
					where 	count = 1;

					if (coalesce(nr_seq_metodo_w, 0) = 0) then
						select	max(obter_metodo_regra_material(nr_prescricao_p,a.nr_seq_exame, nr_seq_material_exame_w))
						into STRICT	nr_seq_metodo_w
						from	prescr_procedimento a
						where	a.nr_prescricao		= nr_prescricao_p
						and		a.nr_sequencia		= nr_seq_prescr_p;
					end if;
				end if;
			else
				select	max(obter_metodo_regra_material(nr_prescricao_p,a.nr_seq_exame, nr_seq_material_exame_w))
				into STRICT	nr_seq_metodo_w
				from	prescr_procedimento a
				where	a.nr_prescricao		= nr_prescricao_p
				and		a.nr_sequencia		= nr_seq_prescr_p;
			end if;


			select 	coalesce(max(nr_seq_resultado),0)
			into STRICT 	nr_seq_resultado_w
			from 	exame_lab_resultado
			where 	nr_prescricao = nr_prescricao_p;

			if (nr_seq_resultado_w = 0) then
				select	coalesce(max(nr_seq_resultado),0) + 1
				into STRICT	nr_seq_resultado_w
				from	exame_lab_resultado;

			insert 	into exame_lab_resultado(
				nr_seq_resultado,
				dt_resultado,
				dt_atualizacao,
				nm_usuario,
				nr_prescricao,
        nr_atendimento
				)
			values (
				nr_seq_resultado_w,
				coalesce(dt_resultado_p,clock_timestamp()),
				clock_timestamp(),
				coalesce(nm_usuario_p,obter_desc_expressao(292158)),
				nr_prescricao_p,
        nr_atendimento_w
				);

		end if;

		select	coalesce(max(nr_sequencia),0) + 1
		into STRICT	nr_sequencia_w
		from 	exame_lab_result_item
		where 	nr_seq_resultado = nr_seq_resultado_w;

		ie_inseriu_w := True;

		if (coalesce(coalesce(nr_seq_prescr_p, nr_seq_prescr_w),0) = 0) then

			nr_seq_prescr_w	:= nr_seq_prescr_nova_w;
			/*select max(nvl(nr_sequencia, null))
			into	nr_seq_prescr_w
			from	prescr_procedimento
			where	nr_prescricao		= nr_prescricao_p
			  and	nr_seq_exame		= nr_seq_exame_w;

			if	(nr_seq_prescr_w is null) then
				select	max(nvl(nr_sequencia, null))
				into	nr_seq_prescr_w
				from	prescr_procedimento
				where	nr_prescricao = nr_prescricao_p
				  and	ie_status_atend >= 30
				  and	nr_seq_exame in (select distinct nr_seq_superior
							 from exame_laboratorio
							 where nr_seq_exame = nr_seq_exame_w);
			end if;*/
		end if;

		select	max(nr_seq_exame)
		into STRICT	nr_seq_exame_prescr_w
		from	prescr_procedimento
		where	nr_sequencia = coalesce(nr_seq_prescr_p, nr_seq_prescr_w)
		and	nr_prescricao = nr_prescricao_p;

		nr_seq_gerada_w	:= null;



		if (nr_seq_exame_w <> nr_seq_exame_prescr_w) then

			select 	count(*)
			into STRICT	qt_exame_dep_w
			from	EXAME_LAB_DEPENDENTE
			where	NR_SEQ_EXAME_DEP = nr_seq_exame_w
			and	nr_seq_exame = nr_seq_exame_prescr_w
			and	IE_GERACAO = 4;


			if (qt_exame_dep_w > 0) then

				nr_seq_gerada_w := lab_duplicar_exame_interf(nr_prescricao_p, coalesce(nr_seq_prescr_p, nr_seq_prescr_w), nr_seq_exame_w, nm_usuario_p, nr_seq_gerada_w);


			end if;
		end if;
		nr_controla_insert := 0;
		while nr_controla_insert < 5
			loop
				begin
					insert into exame_lab_result_item(nr_seq_resultado, nr_sequencia, nr_seq_exame, dt_atualizacao, nm_usuario,
					 				   qt_resultado, ds_resultado, nr_seq_metodo, nr_seq_material, pr_resultado,
					 				   ie_status, dt_aprovacao, nm_usuario_aprovacao, nr_seq_prescr, dt_coleta,
									   ds_observacao, ds_referencia, ds_unidade_medida, qt_minima, qt_maxima, pr_minimo, pr_maximo, ds_flag, ie_final,
                     dt_result_item, nr_seq_formato, ie_result_status, cd_comentario_ext)
					values (nr_seq_resultado_w, nr_sequencia_w, nr_seq_exame_w, clock_timestamp(), coalesce(nm_usuario_p,obter_desc_expressao(292158)),
					 	 qt_resultado_p, ds_resultado_p, nr_seq_metodo_w, CASE WHEN nr_seq_material_exame_w=0 THEN null  ELSE nr_seq_material_exame_w END , pr_resultado_p,
						 '', clock_timestamp(), nm_usuario_p, coalesce(nr_seq_gerada_w,coalesce(nr_seq_prescr_p, nr_seq_prescr_w)), dt_coleta_p,
						 ds_observacao_p, ds_referencia_p, ds_unidade_medida_p, qt_minima_p, qt_maxima_p, pr_minimo_p, pr_maximo_p, ds_flag_p, ie_final_p,
             dt_resultado_p, nr_seq_formato_p, ie_result_status_p, cd_comment_ext_p);
					nr_controla_insert := nr_controla_insert + 5;
				exception
					when unique_violation then
						if nr_controla_insert >= 5 then
							CALL WHEB_MENSAGEM_PCK.exibir_mensagem_abort(277882,'CD_EXAME='||cd_exame_p, 00001);
						else
							nr_controla_insert := nr_controla_insert + 1;
							nr_sequencia_w := nr_sequencia_w + 1;
						end if;
				end;
			end loop;
		end if;
	end if;

	if (not ie_inseriu_w) then

		select coalesce(ie_formato_resultado, 'X')
		into STRICT	ie_formato_w
		from	exame_laboratorio
		where	nr_seq_exame = nr_seq_exame_w;

		pr_resultado_w := pr_resultado_p;
		qt_resultado_w := qt_resultado_p;
		ds_resultado_w := ds_resultado_p;

		if (ie_formato_w = 'P') and (pr_resultado_w = 0) and (qt_resultado_w <> 0) then
			pr_resultado_w := qt_resultado_w;
			qt_resultado_W := 0;
		end if;


		select 	max(dt_aprovacao),
			max(ds_resultado),
			max(qt_resultado),
			max(pr_resultado)
		into STRICT	dt_aprovacao_exame_w,
			ds_resultado_ant_w,
			qt_resultado_ant_w,
			pr_resultado_ant_w
		from 	exame_lab_result_item
		where	nr_seq_resultado 	= nr_seq_resultado_w
		and 	nr_seq_prescr		= coalesce(nr_seq_prescr_p, nr_seq_prescr)
		and 	nr_seq_exame		= nr_seq_exame_w;

		select 	MAX(ie_status_atend)
		into STRICT	ie_status_atend_w
		from 	prescr_procedimento
		where 	nr_prescricao = nr_prescricao_p
		and		nr_sequencia  =  coalesce(nr_seq_prescr_p, nr_seq_prescr_w);

		qt_minima_w     := qt_minima_p;
		qt_maxima_w     := qt_maxima_p;
		pr_minimo_w     := pr_minimo_p;
		pr_maximo_w     := pr_maximo_p;
		ds_referencia_w := ds_referencia_p;

		CALL gravar_log_lab_pragma(47401,substr(WHEB_MENSAGEM_PCK.get_texto(277890,'NR_PRESCRICAO='||nr_prescricao_p||';NR_SEQ_EXAME='||nr_seq_exame_w||';PR_RESULTADO_ANT='||pr_resultado_ant_w||';DS_RESULTADO_ANT='||ds_resultado_ant_w||';QT_RESULTADO_ANT='||qt_resultado_ant_w),1,2000),nm_usuario_p,nr_prescricao_p,'Atualizar_Lab_Result_Item');

		if((ie_atual_ref_ger_laudo_w = 'S') or (ie_atual_ref_ger_laudo_w = 'N') ) then
			SELECT * FROM define_reference_result_values( nr_prescricao_p, nr_seq_prescr_p, nr_seq_resultado_w, qt_resultado_p, pr_resultado_p, ds_resultado_p, nr_seq_exame_w, nr_seq_material_w, nr_seq_metodo_w, qt_minima_w, qt_maxima_w, pr_minimo_w, pr_maximo_w, ds_referencia_w, ie_consiste_w, nr_sequencia_padrao_w, ds_mensagem_criterio_w, ie_acao_criterio_lote_w, nr_sequencia_criterio_w) INTO STRICT qt_minima_w, qt_maxima_w, pr_minimo_w, pr_maximo_w, ds_referencia_w, ie_consiste_w, nr_sequencia_padrao_w, ds_mensagem_criterio_w, ie_acao_criterio_lote_w, nr_sequencia_criterio_w;


            if (ie_atual_ref_ger_laudo_w = 'N') then

                if( (coalesce(qt_minima_w::text, '') = '') or (coalesce(qt_maxima_w::text, '') = ''))then
                  qt_minima_w     := qt_minima_p;
                  qt_maxima_w     := qt_maxima_p;
                end if;

                if((coalesce(pr_minimo_w::text, '') = '') or (coalesce(pr_maximo_w::text, '') = ''))then
                  pr_minimo_w     := pr_minimo_p;
                  pr_maximo_w     := pr_maximo_p;
                end if;

                if (coalesce(ds_referencia_w::text, '') = '')then
                  ds_referencia_w := ds_referencia_p;
                end if;
            end if;

		end if;

        nr_seq_metodo_w := null;
        IF (cd_metodo_p IS NOT NULL AND cd_metodo_p::text <> '') THEN
            BEGIN
                SELECT obter_metodo_integracao(cd_metodo_p, nr_seq_exame_w)
                INTO STRICT nr_seq_metodo_w
;
            EXCEPTION WHEN OTHERS THEN
                nr_seq_metodo_w := null;
            END;
        END IF;

--		Atualizar quando o exame estiver aprovado. OS83721 - 21/02/2008 - Bruna
		if ((ie_desaprovar_atualizar_w = 'S') and ((dt_aprovacao_exame_w IS NOT NULL AND dt_aprovacao_exame_w::text <> '') or (ie_status_atend_w >= 35))) then
			CALL gravar_log_lab(47401,substr(WHEB_MENSAGEM_PCK.get_texto(277890,'NR_PRESCRICAO='||nr_prescricao_p||';NR_SEQ_EXAME='||nr_seq_exame_w||';PR_RESULTADO_ANT='||pr_resultado_ant_w||';DS_RESULTADO_ANT='||ds_resultado_ant_w||';QT_RESULTADO_ANT='||qt_resultado_ant_w),1,2000),nm_usuario_p,nr_prescricao_p,'Atualizar_Lab_Result_Item');
			ie_primeira_aprovacao_w := 'N';
			update	exame_lab_result_item
			set	dt_aprovacao  = NULL,
				cd_comentario_ext = cd_comment_ext_p
			where nr_seq_resultado	= nr_seq_resultado_w
			  and nr_seq_prescr	= coalesce(nr_seq_prescr_p, nr_seq_prescr)
			  and nr_seq_exame	= nr_seq_exame_w;

			update  prescr_procedimento
			set		ie_status_atend = 30,
					nm_usuario		= nm_usuario_p
			where	nr_prescricao =  nr_prescricao_p
			and		nr_sequencia  =  coalesce(nr_seq_prescr_p, nr_seq_prescr_w);

			update exame_lab_result_item
			set	qt_resultado	= qt_resultado_w,
				pr_resultado	= pr_resultado_w,
				ds_resultado	= ds_resultado_w,
				ds_observacao	= ds_observacao_p || WHEB_MENSAGEM_PCK.get_texto(277891,null),
				nm_usuario	= nm_usuario_p,
				dt_atualizacao	= clock_timestamp(),
				ds_referencia	= coalesce(ds_referencia_p, ds_referencia),
				dt_coleta	= coalesce(dt_coleta_p, dt_coleta),
				ds_unidade_medida=coalesce(ds_unidade_medida_p, ds_unidade_medida),
				ie_normalidade	  = NULL,
				dt_aprovacao	= coalesce(dt_aprovacao_exame_w,clock_timestamp()),
				qt_minima 		= qt_minima_w,
				qt_maxima		= qt_maxima_w,
				pr_minimo		= pr_minimo_w,
				pr_maximo		= pr_maximo_w,
				ds_flag			= ds_flag_p,
				nr_seq_metodo	= coalesce(nr_seq_metodo_w, nr_seq_metodo),
				ie_final = ie_final_p,
				dt_result_item = dt_resultado_p,
				nr_seq_formato = coalesce(nr_seq_formato_p, nr_seq_formato),
				ie_result_status = ie_result_status_p,
				cd_comentario_ext = cd_comment_ext_p
			where nr_seq_resultado	= nr_seq_resultado_w
				and nr_seq_prescr	= coalesce(nr_seq_prescr_p, nr_seq_prescr)
				and nr_seq_exame	= nr_seq_exame_w;
		else
			ds_referencia_w := substr(ds_referencia_p,1,4000);

			update exame_lab_result_item
			set	qt_resultado	= qt_resultado_w,
				pr_resultado	= pr_resultado_w,
				ds_resultado	= ds_resultado_w,
				ds_observacao	= ds_observacao_p,
				nm_usuario		= nm_usuario_p,
				dt_atualizacao	= clock_timestamp(),
				ds_referencia	= coalesce(ds_referencia_w, ds_referencia),
				dt_coleta		= coalesce(dt_coleta_p, dt_coleta),
				ds_unidade_medida=coalesce(ds_unidade_medida_p, ds_unidade_medida),
				qt_minima 		= qt_minima_w,
				qt_maxima		= qt_maxima_w,
				pr_minimo		= pr_minimo_w,
				pr_maximo		= pr_maximo_w,
				ds_flag			= ds_flag_p,
				nr_seq_metodo	= coalesce(nr_seq_metodo_w, nr_seq_metodo),
				ie_final = ie_final_p,
				dt_result_item = dt_resultado_p,
				nr_seq_formato = coalesce(nr_seq_formato_p, nr_seq_formato),
				ie_result_status = ie_result_status_p,
				cd_comentario_ext = cd_comment_ext_p
			where nr_seq_resultado	= nr_seq_resultado_w
				and nr_seq_prescr	= coalesce(nr_seq_prescr_p, nr_seq_prescr)
				and nr_seq_exame	= nr_seq_exame_w;

		end if;

		/*if	(nr_seq_material_w is not null) then
			calcular_valores_exame(nr_seq_resultado_w, nr_prescricao_p, nr_seq_prescr_w, nr_seq_material_w,
					nr_seq_exame_w, qt_resultado_w, pr_resultado_w, ds_resultado_w);
		end if; */
	end if;

	if (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') then  -- Bruna, OS38513, 22/09/06, sempre calcular os valores para o exame
		ds_resultado_w := calcular_valores_exame(nr_seq_resultado_w, nr_prescricao_p, nr_seq_prescr_w, nr_seq_material_w, nr_seq_exame_w, qt_resultado_w, pr_resultado_w, ds_resultado_w);

	end if;

	update	prescr_procedimento
	set	ie_status_atend = CASE WHEN ie_exige_formato_w='S' THEN 30  ELSE CASE WHEN ie_tasylab_w='S' THEN  CASE WHEN ie_aprova_integracao_w='S' THEN 35 WHEN ie_aprova_integracao_w='L' THEN 40  ELSE 30 END   ELSE 35 END  END ,
		nm_usuario = nm_usuario_p
	where	nr_prescricao	= nr_prescricao_p
	  and 	nr_sequencia	= coalesce(nr_seq_prescr_p,nr_seq_prescr_w)
	  and	ie_status_atend < CASE WHEN ie_exige_formato_w='S' THEN 30  ELSE CASE WHEN ie_tasylab_w='S' THEN  CASE WHEN ie_aprova_integracao_w='S' THEN 35 WHEN ie_aprova_integracao_w='L' THEN 40  ELSE 30 END   ELSE 35 END  END;

	select  CASE WHEN ie_exige_formato_w='S' THEN 30  ELSE CASE WHEN ie_tasylab_w='S' THEN  CASE WHEN ie_aprova_integracao_w='S' THEN 35 WHEN ie_aprova_integracao_w='L' THEN 40  ELSE 30 END   ELSE 35 END  END
	into STRICT	ie_status_atend_update_w
	;

	if (ie_desaprovar_atualizar_w = 'S') then

		if (ie_status_atend_update_w >= 35) and (nr_seq_resultado_w IS NOT NULL AND nr_seq_resultado_w::text <> '') and (ie_primeira_aprovacao_w = 'S') then

			update exame_lab_result_item
			set dt_aprovacao = clock_timestamp(),
					nm_usuario_aprovacao = nm_usuario_p,
					dt_atualizacao = clock_timestamp(),
					ds_flag = ds_flag_p,
					dt_result_item = dt_resultado_p,
					ie_final = ie_final_p,
					ie_result_status = ie_result_status_p,
					cd_comentario_ext = cd_comment_ext_p
			where 	nr_seq_resultado	= nr_seq_resultado_w
			and 	nr_seq_prescr		= coalesce(nr_seq_prescr_p, nr_seq_prescr)
			and 	nr_seq_exame		= nr_seq_exame_w;

		end if;

	end if;

	if (ie_status_atend_update_w >= ie_status_baixa_w)  then
		begin

		select coalesce(max('S'),'N')
		into STRICT	ie_retorno_conta_w
		from	procedimento_paciente a,
			prescr_procedimento b where	a.nr_prescricao 	   = b.nr_prescricao
		and	a.nr_sequencia_prescricao  = b.nr_sequencia
		and	b.ie_status_execucao 	in (10,15)
		and	b.cd_motivo_baixa 	= 0
		and	b.ie_status_atend	>= ie_status_baixa_w
		and	a.nr_prescricao 	= nr_prescricao_p
		and	a.nr_sequencia_prescricao  = coalesce(nr_seq_prescr_p, nr_seq_prescr_w) LIMIT 1;

		if (ie_retorno_conta_w = 'S')   then

			update 	prescr_procedimento
			set	cd_motivo_baixa  = 1,
				dt_baixa	 = clock_timestamp(),
				nm_usuario 	 = nm_usuario_p
			where 	nr_prescricao 	 = nr_prescricao_p
			and	nr_sequencia  	 = coalesce(nr_seq_prescr_p, nr_seq_prescr_w);


		end if;


		end;

	end if;
end if;

ds_erro_p	:= ds_erro_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_lab_result_item (nr_prescricao_p bigint, nr_seq_prescr_p bigint, cd_exame_p text, qt_resultado_p bigint, pr_resultado_p bigint, ds_resultado_p text, ds_observacao_p text, cd_material_exame_p text, ie_reenvio_p text, nm_usuario_p text, dt_coleta_p timestamp, ds_referencia_p text, ds_unidade_medida_p text, nr_doc_lab_p text, dt_resultado_p timestamp, ds_erro_p INOUT text, nr_seq_exame_atualiz_p bigint default null, cd_metodo_p text default null, qt_minima_p bigint default null, qt_maxima_p bigint default null, pr_minimo_p bigint default null, pr_maximo_p bigint default null, ds_flag_p text default null, ie_final_p text default null, nr_seq_formato_p bigint default null, ie_result_status_p text default null, cd_comment_ext_p text default null) FROM PUBLIC;

