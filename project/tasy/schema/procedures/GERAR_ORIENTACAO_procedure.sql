-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_orientacao ( nr_seq_proc_interno_p bigint, cd_convenio_p bigint, nm_usuario_p text, ds_orientacoes_p INOUT text) AS $body$
DECLARE


ds_orientacoes_w	varchar(4000);
ds_w			varchar(4000) := '';
cd_w			integer;
nr_sequencia_ww		bigint;
nr_seq_rtf_srtring_w	bigint;

expressao1_w	varchar(255) := obter_desc_expressao_idioma(505678, null, wheb_usuario_pck.get_nr_seq_idioma);--Sem orientações informadas.
c01 CURSOR FOR
SELECT  1,
	coalesce(ds_orientacao,' ') ds_orientacao,
	0 nr_sequencia
from    orientacao_cirurgia
where   nr_sequencia         =  (select   max(nr_sequencia)
				from     orientacao_cirurgia)

union

select	2,
	coalesce(ds_orientacao_usuario,' ') ds_orientacao,
	0 nr_sequencia
from	proc_interno
where	nr_sequencia		   =	nr_seq_proc_interno_p

union

select	3,
	coalesce(ds_orientacao,' ') ds_orientacao,
	0 nr_sequencia
from	proc_interno_conv_orient
where	nr_seq_proc_interno	=	nr_seq_proc_interno_p
and	coalesce(cd_convenio::text, '') = ''

union

select	4,
	coalesce(ds_orientacao,' ') ds_orientacao,
	0 nr_sequencia
from	proc_interno_conv_orient
where	nr_seq_proc_interno	=	nr_seq_proc_interno_p
and	cd_convenio 		   =	cd_convenio_p

union

select	5,
	' ' ds_orientacao,
	nr_sequencia
from	convenio_doc_atend
where	cd_convenio		      =	cd_convenio_p
and	ie_documento		   =	'CIR';


BEGIN

open C01;
loop
fetch C01 into
	cd_w,
	ds_w,
	nr_sequencia_ww;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (cd_w = 5) then
		nr_seq_rtf_srtring_w := converte_rtf_string('	select	ds_documento
					from	convenio_doc_atend
					where	nr_sequencia = :nr_sequencia_p', nr_sequencia_ww, nm_usuario_p, nr_seq_rtf_srtring_w);
		select	substr(ds_texto_clob,4000,1)
		into STRICT	ds_w
		from	tasy_conversao_rtf
		where	nr_sequencia = nr_seq_rtf_srtring_w;
	end if;

	ds_orientacoes_w := substr(ds_orientacoes_w || ds_w ||chr(10),1,4000);

	end;
end loop;
close C01;

if (ds_orientacoes_w = '') then
	ds_orientacoes_w := expressao1_w;
end if;

ds_orientacoes_p := ds_orientacoes_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_orientacao ( nr_seq_proc_interno_p bigint, cd_convenio_p bigint, nm_usuario_p text, ds_orientacoes_p INOUT text) FROM PUBLIC;

