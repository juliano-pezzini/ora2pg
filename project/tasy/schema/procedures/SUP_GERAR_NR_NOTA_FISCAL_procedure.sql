-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sup_gerar_nr_nota_fiscal ( nr_sequencia_p bigint, cd_serie_nf_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
qt_registro_w			bigint;
nr_nota_fiscal_w		varchar(255);
ie_numero_nota_w		varchar(1);
cont_w				smallint;
cd_operacao_nf_w		smallint;
ie_estab_serie_nf_w		parametro_compras.ie_estab_serie_nf%type;
cd_cgc_emitente_w		estabelecimento.cd_cgc%type;


BEGIN 
 
lock table serie_nota_fiscal in exclusive mode;
 
select	count(*) 
into STRICT	qt_registro_w 
from	serie_nota_fiscal 
where	cd_serie_nf	 	= cd_serie_nf_p 
and	cd_estabelecimento	 = cd_estabelecimento_p;
 
 
if (qt_registro_w > 0) then 
	begin 
 
	/* obter se será considerado estabelecimento no parâmetro de compras */
 
	select	coalesce(max(ie_estab_serie_nf),'N') 
	into STRICT	ie_estab_serie_nf_w 
	from	parametro_compras 
	where	cd_estabelecimento = cd_estabelecimento_p;
 
	select	max(cd_cgc) 
	into STRICT	cd_cgc_emitente_w 
	from	estabelecimento 
	where	cd_estabelecimento = cd_estabelecimento_p;
 
	select	nr_ultima_nf + 1, 
		ie_numero_nota 
	into STRICT	nr_nota_fiscal_w, 
		ie_numero_nota_w 
	from	serie_nota_fiscal 
	where	cd_serie_nf	  	= cd_serie_nf_p 
	and	cd_estabelecimento		= cd_estabelecimento_p;
 
	/*if	(ie_numero_nota_w = 'T') and 
		(cd_setor_digitacao_w > 0) then 
 
		select	count(*) 
		into	qt_registro_w 
		from	serie_nota_fiscal_setor 
		where	cd_serie_nf = cd_serie_nf_p 
		and	cd_Estabelecimento	= cd_estabelecimento_p 
		and	cd_setor_atendimento 	= cd_setor_digitacao_w; 
 
		if	(qt_registro_w > 0) then 
			select	nr_ultima_nf +1 
			into	nr_nota_fiscal_w 
			from	serie_nota_fiscal_setor 
			where	cd_serie_nf 		= cd_serie_nf_p 
			and	cd_Estabelecimento 	= cd_estabelecimento_p 
			and	cd_setor_atendimento 	= cd_setor_digitacao_w; 
 
		end if; 
	end if;*/
 
 
	select	count(*) 
	into STRICT	cont_w 
	from	nota_fiscal_aidf 
	where	cd_estabelecimento 	= cd_estabelecimento_p 
	and	cd_serie_nf 		= cd_serie_nf_p;
 
	if (cont_w > 0) then 
		select	count(*) 
		into STRICT	cont_w 
		from	nota_fiscal_aidf 
		where	cd_estabelecimento 	= cd_estabelecimento_p 
		and	cd_serie_nf 		= cd_serie_nf_p 
		and	nr_nota_fiscal_w 	>= nr_nota_ini 
		and 	nr_nota_fiscal_w 	<= nr_nota_fim;
 
		if (cont_w = 0) then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(266287,'NR_NOTA_FISCAL=' || nr_nota_fiscal_w);
			--'Sem autorização para informar este número de nota fiscal (' || nr_nota_fiscal_w || '), ' || chr(10) || chr(13) || 
			--'verifique o cadastro de autorizações(AIDF) nos cadastros de estoque.'); 
		end if;
	end if;
 
	begin 
 
	/*if	(ie_numero_nota_w = 'T') then 
		update	serie_nota_fiscal_setor 
		set	nr_ultima_nf 		= nr_nota_fiscal_w 
		where	cd_serie_nf 		= cd_serie_nf_p 
		and	cd_estabelecimento 	= cd_estabelecimento_p 
		and	cd_setor_atendimento	= cd_setor_digitacao_w; 
 
		update	nota_fiscal 
		set	nr_nota_fiscal		= nr_nota_fiscal_w 
		where	nr_sequencia		= nr_sequencia_p;*/
 
 
	if (ie_numero_nota_w = 'S') then 
 
		if (coalesce(ie_estab_serie_nf_w,'N') = 'S') then 
			update	serie_nota_fiscal 
			set	nr_ultima_nf 		= nr_nota_fiscal_w 
			where	cd_serie_nf 		= cd_serie_nf_p 
			and	cd_estabelecimento in (SELECT	z.cd_estabelecimento 
							from	estabelecimento z 
							where	z.cd_cgc = cd_cgc_emitente_w);
		else 
			update	serie_nota_fiscal 
			set	nr_ultima_nf 		= nr_nota_fiscal_w 
			where	cd_serie_nf 		= cd_serie_nf_p 
			and	cd_estabelecimento 	= cd_estabelecimento_p;
		end if;
		 
		update	nota_fiscal 
		set	nr_nota_fiscal		= nr_nota_fiscal_w 
		where	nr_sequencia		= nr_sequencia_p;
 
	elsif (ie_numero_nota_w = 'O') then 
 
		select	cd_operacao_nf 
		into STRICT	cd_operacao_nf_w 
		from	nota_fiscal 
		where	nr_sequencia = nr_sequencia_p;
 
		select	coalesce(max(ie_numero_nota),'S') 
		into STRICT	ie_numero_nota_w 
		from	operacao_nota 
		where	cd_operacao_nf = cd_operacao_nf_w;
 
		if (ie_numero_nota_w = 'S') then 
 
			update	serie_nota_fiscal 
			set	nr_ultima_nf 		= nr_nota_fiscal_w 
			where	cd_serie_nf 		= cd_serie_nf_p 
			and	cd_estabelecimento 	= cd_estabelecimento_p;
 
			update	nota_fiscal 
			set	nr_nota_fiscal		= nr_nota_fiscal_w 
			where	nr_sequencia		= nr_sequencia_p;
		end if;
	end if;
	exception when others then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(266288,'NR_NOTA_FISCAL=' || nr_nota_fiscal_w);
		--'Já existe uma nota fiscal deste emitente cadastrada com o número '|| nr_nota_fiscal_w || chr(10) || 
		--'Verifique o cadastro da série (última nf), pois o número da nota fiscal é atualizado pelo sistema'); 
	end; -- Fim exception 
	end;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_gerar_nr_nota_fiscal ( nr_sequencia_p bigint, cd_serie_nf_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

