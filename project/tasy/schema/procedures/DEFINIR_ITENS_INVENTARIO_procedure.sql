-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE definir_itens_inventario ( nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, cd_marca_p bigint, nr_seq_localizacao_p bigint, nr_seq_localizacao_multi_p text, ds_localizacao_local_p text, ds_loc_local_multi_p text, nr_seq_familia_p bigint, cd_unidade_medida_estoque_p text, cd_cgc_p text, ie_curva_p text, ie_curva_local_p text, ie_curva_xyz_p text, ie_receita_p text, ie_padronizado_p text, ie_somente_com_saldo_p text, ie_padrao_estoque_local_p text, qt_max_sorteio_p text, ie_todos_saldo_estoque_p text, ie_restringe_controlado_p text, ie_data_movimento_p text, nr_seq_estrut_mat_p text, ie_via_aplicacao_p text, dt_movimento_p timestamp, ie_tipo_material_p text, ie_estoque_lote_p text, ie_localizacao_local_p text, ie_custo_med_positivo_p text, ie_classif_custo_p text) AS $body$
DECLARE


ie_tipo_curva_w			varchar(1);
ie_tipo_curva_local_w		varchar(1);
ie_tipo_curva_xyz_w		varchar(1);
cd_material_estoque_w		integer;
cd_local_estoque_w		integer;
cd_fornecedor_w			varchar(14);
nr_sequencia_w			bigint;
qt_saldo_w			double precision;
qt_saldo_consig_w			double precision;
dt_mesano_referencia_w		timestamp;
ie_bloqueio_inventario_w		varchar(1);
ie_local_valido_w			varchar(1);
ie_consignado_w			varchar(1);
qt_existe_w			bigint;
nr_seq_localizacao_w		bigint;
ie_material_estrut_loc_w		varchar(1);
ie_estoque_lote_w		varchar(1);
ie_estoque_lote_ww		varchar(1);
ds_loc_local_multi_w		varchar(255);
nr_seq_localizacao_multi_w	varchar(4000);
vl_custo_medio_w			saldo_estoque.vl_custo_medio%type;
cd_fornecedor_inventario_w  inventario.cd_fornecedor%type;
qt_existe_material_w		bigint;

/*cursor para itens nao consignados e ambos*/

c01 CURSOR FOR
	SELECT	b.cd_material_estoque
	from	estrutura_material_v a,
		material b,
		material_estab c
	where	a.cd_material		= b.cd_material
	and	b.cd_material		= c.cd_material
    and c.ie_classif_custo  = coalesce(ie_classif_custo_p, c.ie_classif_custo)
	and	c.cd_estabelecimento = cd_estabelecimento_p
	and	a.cd_classe_material	= coalesce(cd_classe_material_p, a.cd_classe_material)
	and	a.cd_grupo_material	= coalesce(cd_grupo_material_p, a.cd_grupo_material)
	and	a.cd_subgrupo_material	= coalesce(cd_subgrupo_material_p, a.cd_subgrupo_material)
	and	b.ie_tipo_material	= coalesce(ie_tipo_material_p, b.ie_tipo_material)
	and	(coalesce(nr_seq_localizacao_p, 0) = 0 or ((ie_localizacao_local_p = 'N' and b.nr_seq_localizacao = nr_seq_localizacao_p)
	or (ie_localizacao_local_p = 'S' and obter_se_mat_localizacao(cd_local_estoque_w,b.cd_material_estoque,null,nr_seq_localizacao_p) = 'S')))
	and	((coalesce(nr_seq_localizacao_multi_w::text, '') = '') or ((ie_localizacao_local_p = 'N' and obter_se_contido_char(b.nr_seq_localizacao,upper(nr_seq_localizacao_multi_w)) = 'S')
	or (ie_localizacao_local_p = 'S' and obter_se_mat_localizacao(cd_local_estoque_w,b.cd_material_estoque,null,nr_seq_localizacao_multi_w) = 'S')))
	and	((coalesce(ie_via_aplicacao_p::text, '') = '') or (b.ie_via_aplicacao = ie_via_aplicacao_p))
	and	((coalesce(ds_localizacao_local_p::text, '') = '') or (obter_se_mat_localizacao(cd_local_estoque_w,b.cd_material_estoque,ds_localizacao_local_p,null) = 'S'))
	and	((coalesce(ds_loc_local_multi_w::text, '') = '') or (obter_se_mat_localizacao(cd_local_estoque_w,b.cd_material_estoque,ds_loc_local_multi_w,null) = 'S'))
	and (coalesce(nr_seq_familia_p, 0) = 0 or b.nr_seq_familia = nr_seq_familia_p)
	and	substr(obter_situacao_material(b.cd_material_estoque),1,1) = 'A'
	and	b.ie_situacao = 'A'
	and	b.ie_consignado	in ('0','2')
	and	((ie_restringe_controlado_p = 'N') or (Obter_se_medic_controlado(b.cd_material_estoque) = 'N'))
	and	((ie_tipo_curva_w = 'N') or (substr(obter_curva_abc_estab(cd_estabelecimento_p, b.cd_material, 'N', dt_mesano_referencia_w),1,1) = ie_tipo_curva_w))
	and	((ie_tipo_curva_local_w = 'N') or (obter_curva_abc_local(b.cd_material, null, cd_local_estoque_w, dt_mesano_referencia_w) = ie_tipo_curva_local_w))
	and (ie_tipo_curva_xyz_w = 'N' or substr(coalesce(obter_curva_xyz(cd_estabelecimento_p, b.cd_material),'0'),1,1) = ie_tipo_curva_xyz_w)
	and	((coalesce(cd_unidade_medida_estoque_p::text, '') = '') or (b.cd_unidade_medida_estoque = cd_unidade_medida_estoque_p))
	and	c.ie_material_estoque = 'S'
	and (ie_padronizado_p = 0 or substr(obter_se_material_padronizado(cd_estabelecimento_p, b.cd_material_estoque),1,1) =
		CASE WHEN ie_padronizado_p='1' THEN 'S' WHEN ie_padronizado_p='2' THEN 'N'  ELSE substr(obter_se_material_padronizado(cd_estabelecimento_p, b.cd_material_estoque),1,1) END )
	and	((ie_receita_p = '0') or
		(ie_receita_p = '1' AND b.ie_receita = 'S') or
		(ie_receita_p = '2' AND b.ie_receita = 'N'))
	and	((ie_data_movimento_p = 'N') or exists (	SELECT	1
							from	movimento_estoque x
							where	x.dt_movimento_estoque >= dt_movimento_p
							and	x.cd_material_estoque = b.cd_material_estoque
							and	x.cd_local_estoque = cd_local_estoque_w
							and	x.cd_estabelecimento = cd_estabelecimento_p))
	and	((coalesce(cd_marca_p::text, '') = '') or exists (select	y.cd_material
						from	material_marca y
						where	y.cd_material	= a.cd_material
						and	coalesce(y.ie_situacao,'A') = 'A'
						and	y.nr_sequencia	= cd_marca_p))
	group by b.cd_material_estoque;

/*Cursor para itens Consignados e Ambos*/

c02 CURSOR FOR
	SELECT	b.cd_material_estoque,
		x.cd_fornecedor
	from	fornecedor_mat_consignado x,
		estrutura_material_v a,
		material b,
        material_estab c
	where	a.cd_material		= b.cd_material
	and	a.cd_classe_material	= coalesce(cd_classe_material_p, a.cd_classe_material)
    and	b.cd_material		= c.cd_material
    and c.ie_classif_custo  = coalesce(ie_classif_custo_p, c.ie_classif_custo)
    and	c.cd_estabelecimento = cd_estabelecimento_p
	and	a.cd_grupo_material	= coalesce(cd_grupo_material_p, a.cd_grupo_material)
	and	a.cd_subgrupo_material	= coalesce(cd_subgrupo_material_p, a.cd_subgrupo_material)
	and	b.ie_tipo_material	= coalesce(ie_tipo_material_p, b.ie_tipo_material)
	and	(coalesce(nr_seq_localizacao_p, 0) = 0 or ((ie_localizacao_local_p = 'N' and b.nr_seq_localizacao = nr_seq_localizacao_p)
	or (ie_localizacao_local_p = 'S' and obter_se_mat_localizacao(cd_local_estoque_w,b.cd_material_estoque,null,nr_seq_localizacao_p) = 'S')))
	and	(coalesce(nr_seq_localizacao_multi_w::text, '') = '' or ((ie_localizacao_local_p = 'N' and obter_se_contido_char(b.nr_seq_localizacao,upper(nr_seq_localizacao_multi_w)) = 'S')
	or (ie_localizacao_local_p = 'S' and obter_se_mat_localizacao(cd_local_estoque_w,b.cd_material_estoque,null,nr_seq_localizacao_multi_w) = 'S')))
	and	((coalesce(ie_via_aplicacao_p::text, '') = '') or (b.ie_via_aplicacao = ie_via_aplicacao_p))
	and	((coalesce(ds_localizacao_local_p::text, '') = '') or (obter_se_mat_localizacao(cd_local_estoque_w,b.cd_material_estoque,ds_localizacao_local_p,null) = 'S'))
	and	((coalesce(ds_loc_local_multi_w::text, '') = '') or (obter_se_mat_localizacao(cd_local_estoque_w,b.cd_material_estoque,ds_loc_local_multi_w,null) = 'S'))
	and	((coalesce(nr_seq_familia_p, 0) = 0) or (b.nr_seq_familia = nr_seq_familia_p))
	and	b.ie_situacao = 'A'
	and	substr(obter_situacao_material(b.cd_material_estoque),1,1) = 'A'
	and	b.ie_consignado in ('1','2')
	and (ie_tipo_curva_w = 'N' or substr(obter_curva_abc_estab(cd_estabelecimento_p, b.cd_material, 'N', dt_mesano_referencia_w),1,1) = ie_tipo_curva_w)
	and	((ie_restringe_controlado_p = 'N') or (Obter_se_medic_controlado(b.cd_material_estoque) = 'N'))
	and (ie_tipo_curva_local_w = 'N' or obter_curva_abc_local(b.cd_material, null, cd_local_estoque_w, dt_mesano_referencia_w) = ie_tipo_curva_local_w)
	and (ie_tipo_curva_xyz_w = 'N' or substr(coalesce(obter_curva_xyz(cd_estabelecimento_p, b.cd_material),'0'),1,1) = ie_tipo_curva_xyz_w)
	and	((ie_receita_p = '0') or
		(ie_receita_p = '1' AND b.ie_receita = 'S') or
		(ie_receita_p = '2' AND b.ie_receita = 'N'))
	and (substr(obter_se_material_estoque(cd_estabelecimento_p, 0, b.cd_material),1,1) = 'S')
	and	substr(obter_se_material_padronizado(cd_estabelecimento_p, b.cd_material),1,1) =
			CASE WHEN ie_padronizado_p='1' THEN 'S' WHEN ie_padronizado_p='2' THEN 'N'  ELSE substr(obter_se_material_padronizado(cd_estabelecimento_p, b.cd_material),1,1) END
	and	x.cd_material = b.cd_material
	and	((coalesce(cd_unidade_medida_estoque_p::text, '') = '') or (b.cd_unidade_medida_estoque = cd_unidade_medida_estoque_p))
	and	x.dt_mesano_referencia	= dt_mesano_referencia_w
	and	x.cd_local_estoque	= cd_local_estoque_w
	and	x.cd_estabelecimento	= cd_estabelecimento_p
	and (coalesce(cd_cgc_p::text, '') = '' or x.cd_fornecedor	= cd_cgc_p)
	and	((ie_data_movimento_p = 'N') or exists (
						SELECT	1
						from	movimento_estoque x
						where	x.dt_movimento_estoque >= dt_movimento_p
						and	x.cd_material_estoque = b.cd_material_estoque
						and	x.cd_local_estoque = cd_local_estoque_w
						and	x.cd_estabelecimento = cd_estabelecimento_p))
	and	((coalesce(cd_marca_p::text, '') = '') or exists (
			select	y.cd_material
			from	material_marca y
			where	y.cd_material	= a.cd_material
			and	coalesce(y.ie_situacao,'A') = 'A'
			and	y.nr_sequencia	= cd_marca_p))
	group by b.cd_material_estoque,
		x.cd_fornecedor;

c03 CURSOR FOR
	SELECT	s.cd_material
	from	estrutura_material_v v,
		material m,
		saldo_estoque s,
        material_estab c
	where	v.cd_material = s.cd_material
	and	m.cd_material = v.cd_material
	and	v.cd_classe_material	= coalesce(cd_classe_material_p, v.cd_classe_material)
	and	v.cd_grupo_material	= coalesce(cd_grupo_material_p, v.cd_grupo_material)
    and	m.cd_material		= c.cd_material
    and c.ie_classif_custo  = coalesce(ie_classif_custo_p, c.ie_classif_custo)
    and	c.cd_estabelecimento = cd_estabelecimento_p
	and	v.cd_subgrupo_material	= coalesce(cd_subgrupo_material_p, v.cd_subgrupo_material)
	and	m.ie_tipo_material	= coalesce(ie_tipo_material_p, m.ie_tipo_material)
	and (coalesce(nr_seq_localizacao_p, 0) = 0 or m.nr_seq_localizacao = nr_seq_localizacao_p)
	and (coalesce(nr_seq_localizacao_multi_w::text, '') = '' or (obter_se_contido_char(m.nr_seq_localizacao,upper(nr_seq_localizacao_multi_w)) = 'S'))
	and	((coalesce(ie_via_aplicacao_p::text, '') = '') or (m.ie_via_aplicacao = ie_via_aplicacao_p))
	and	dt_mesano_referencia_w	= s.dt_mesano_referencia
	and (coalesce(nr_seq_familia_p, 0) = 0 or m.nr_seq_familia = nr_seq_familia_p)
	and (ie_tipo_curva_w = 'N' or substr(obter_curva_abc_estab(cd_estabelecimento_p, s.cd_material, 'N', dt_mesano_referencia_w),1,1) = ie_tipo_curva_w)
	and (ie_tipo_curva_local_w = 'N' or obter_curva_abc_local(s.cd_material, null, cd_local_estoque_w, dt_mesano_referencia_w) = ie_tipo_curva_local_w)
	and (ie_tipo_curva_xyz_w = 'N' or substr(coalesce(obter_curva_xyz(cd_estabelecimento_p, s.cd_material),'0'),1,1) = ie_tipo_curva_xyz_w)
	and (substr(obter_se_material_estoque(cd_estabelecimento_p, 0, s.cd_material),1,1) = 'S')
	and	((ie_receita_p = '0') or
		(ie_receita_p = '1' AND m.ie_receita = 'S') or
		(ie_receita_p = '2' AND m.ie_receita = 'N'))
	and	substr(obter_se_material_padronizado(cd_estabelecimento_p, s.cd_material),1,1) =
		CASE WHEN ie_padronizado_p='1' THEN 'S' WHEN ie_padronizado_p='2' THEN 'N'  ELSE substr(obter_se_material_padronizado(cd_estabelecimento_p, s.cd_material),1,1) END
	and	((coalesce(cd_unidade_medida_estoque_p::text, '') = '') or (m.cd_unidade_medida_estoque = cd_unidade_medida_estoque_p))
	and	cd_estabelecimento_p = s.cd_estabelecimento
	and	v.ie_situacao = 'A'
	and	m.ie_consignado in ('0','2')
	and    	s.cd_local_estoque = cd_local_estoque_w
	and	((ie_data_movimento_p = 'N') or exists (
						SELECT	1
						from	movimento_estoque x
						where	x.dt_movimento_estoque >= dt_movimento_p
						and	x.cd_material_estoque = s.cd_material
						and	x.cd_local_estoque = cd_local_estoque_w
						and	x.cd_estabelecimento = cd_estabelecimento_p))
	and	((coalesce(cd_marca_p::text, '') = '') or exists (
		select	y.cd_material
		from	material_marca y
		where	y.cd_material	= s.cd_material
		and	coalesce(y.ie_situacao,'A') = 'A'
		and	y.nr_sequencia	= cd_marca_p))
	group by s.cd_material;


BEGIN

ds_loc_local_multi_w := substr(replace(ds_loc_local_multi_p,', ',','),1,255);
nr_seq_localizacao_multi_w := substr(replace(nr_seq_localizacao_multi_p,', ',','),1,4000);

select	max(dt_mesano_vigente)
into STRICT	dt_mesano_referencia_w
from	parametro_estoque
where	cd_estabelecimento = cd_estabelecimento_p;

select	cd_local_estoque,
	ie_consignado
into STRICT	cd_local_estoque_w,
	ie_consignado_w
from	inventario
where	nr_sequencia = nr_sequencia_p;

if (ie_curva_p = '0') then
	ie_tipo_curva_w	:= 'N';
elsif (ie_curva_p = '1') then
	ie_tipo_curva_w	:= 'A';
elsif (ie_curva_p = '2') then
	ie_tipo_curva_w	:= 'B';
elsif (ie_curva_p = '3') then
	ie_tipo_curva_w	:= 'C';
elsif (ie_curva_p = '4') then
	ie_tipo_curva_w	:= 'X';
end if;

if (ie_curva_local_p = '0') then
	ie_tipo_curva_local_w	:= 'N';
elsif (ie_curva_local_p = '1') then
	ie_tipo_curva_local_w	:= 'A';
elsif (ie_curva_local_p = '2') then
	ie_tipo_curva_local_w	:= 'B';
elsif (ie_curva_local_p = '3') then
	ie_tipo_curva_local_w	:= 'C';
elsif (ie_curva_local_p = '4') then
	ie_tipo_curva_local_w	:= 'X';
end if;

if (ie_curva_xyz_p = '0') then
	ie_tipo_curva_xyz_w	:= 'N';
elsif (ie_curva_xyz_p = '1') then
	ie_tipo_curva_xyz_w	:= 'X';
elsif (ie_curva_xyz_p = '2') then
	ie_tipo_curva_xyz_w	:= 'Y';
elsif (ie_curva_xyz_p = '3') then
	ie_tipo_curva_xyz_w	:= 'Z';
elsif (ie_curva_xyz_p = '4') then
	ie_tipo_curva_xyz_w	:= '0';
end if;

if (ie_estoque_lote_p = '0') then
	ie_estoque_lote_ww := 'A';
elsif (ie_estoque_lote_p = '1') then
	ie_estoque_lote_ww := 'S';
elsif (ie_estoque_lote_p = '2') then
	ie_estoque_lote_ww := 'N';
end if;

if (coalesce(ie_todos_saldo_estoque_p,'N') = 'N') then
	begin

	if (coalesce(ie_consignado_w,'N') = 'N') then
		begin
		open c01;
		loop
		fetch c01 into
			cd_material_estoque_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin

			select	count(*)
			into STRICT	qt_existe_w
			from	inventario_material
			where	nr_seq_inventario	= nr_sequencia_p
			and	cd_material	= cd_material_estoque_w;

			if (qt_existe_w = 0) then
				begin

				ie_material_estrut_loc_w := 'S';
				if (nr_seq_estrut_mat_p > 0) then
					ie_material_estrut_loc_w := substr(obter_se_material_estrut_loc(cd_local_estoque_w, cd_material_estoque_w, nr_seq_estrut_mat_p),1,1);
				end if;

				if (ie_material_estrut_loc_w = 'S') then
					begin
					select	coalesce(sum(qt_estoque), 0),
							coalesce(sum(vl_custo_medio), 0)
					into STRICT	qt_saldo_w,
							vl_custo_medio_w
					from	saldo_estoque
					where	cd_estabelecimento		= cd_estabelecimento_p
					and	cd_local_estoque		= cd_local_estoque_w
					and	cd_material		= cd_material_estoque_w
					and	dt_mesano_referencia	= dt_mesano_referencia_w;

					ie_bloqueio_inventario_w := coalesce(obter_se_material_bloqueio_inv(
									cd_estabelecimento_p,
									cd_material_estoque_w,
									cd_local_estoque_w),'N');

					if (ie_padrao_estoque_local_p = 'S') then
						ie_local_valido_w := obter_local_valido( 	cd_estabelecimento_p, cd_local_estoque_w, cd_material_estoque_w, null, ie_local_valido_w);
					end if;

					if (ie_estoque_lote_ww <> 'A') then
						ie_estoque_lote_w := substr(obter_se_material_estoque_lote(cd_estabelecimento_p,cd_material_estoque_w),1,1);
					end if;

					if	((ie_padrao_estoque_local_p = 'N') or (ie_padrao_estoque_local_p = 'S' AND ie_local_valido_w = 'S')) and
						((qt_saldo_w > 0 AND ie_somente_com_saldo_p = 'S') or (ie_somente_com_saldo_p = 'N')) and
						((vl_custo_medio_w > 0 AND ie_custo_med_positivo_p = 'S') or (ie_custo_med_positivo_p = 'N')) and (coalesce(ie_estoque_lote_ww,'A') = 'A' or ie_estoque_lote_w = ie_estoque_lote_ww) and (ie_bloqueio_inventario_w = 'N') then
						begin
						select	nextval('inventario_material_seq')
						into STRICT	nr_sequencia_w
						;

						insert into inventario_material(
							nr_sequencia,
							nr_seq_inventario,
							dt_atualizacao,
							nm_usuario,
							cd_material,
							ie_status_inventario)
						values (	nr_sequencia_w,
							nr_sequencia_p,
							clock_timestamp(),
							nm_usuario_p,
							cd_material_estoque_w,
							'P');
						end;
					end if;
					end;
				end if;
				end;
			end if;
			end;
		end loop;
		close c01;
		end;
	else
		begin
		open c02;
		loop
		fetch c02 into
			cd_material_estoque_w,
			cd_fornecedor_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin

			select	count(*)
			into STRICT	qt_existe_w
			from	inventario_material
			where	nr_seq_inventario	= nr_sequencia_p
			and	cd_material	= cd_material_estoque_w
			and          cd_fornecedor         = cd_fornecedor_w;

			if (qt_existe_w = 0) then
				begin
				ie_material_estrut_loc_w := 'S';
				if (nr_seq_estrut_mat_p > 0) then
					ie_material_estrut_loc_w := substr(obter_se_material_estrut_loc(cd_local_estoque_w, cd_material_estoque_w, nr_seq_estrut_mat_p),1,1);
				end if;

				if (ie_material_estrut_loc_w = 'S') then
					begin

					select	coalesce(sum(qt_estoque), 0),
							coalesce(sum(vl_custo_medio), 0)
					into STRICT	qt_saldo_consig_w,
							vl_custo_medio_w
					from	fornecedor_mat_consignado
					where	cd_estabelecimento		= cd_estabelecimento_p
					and	cd_local_estoque		= cd_local_estoque_w
					and	cd_material		= cd_material_estoque_w
					and	dt_mesano_referencia	= dt_mesano_referencia_w
					and	cd_fornecedor		= cd_fornecedor_w;

					ie_bloqueio_inventario_w := coalesce(obter_Se_Material_Bloqueio_Inv(
									cd_estabelecimento_p,
									cd_material_estoque_w,
									cd_local_estoque_w),'N');

					if (ie_padrao_estoque_local_p = 'S') then
						ie_local_valido_w := obter_local_valido( cd_estabelecimento_p, cd_local_estoque_w, cd_material_estoque_w, null, ie_local_valido_w);
					end if;

					select	cd_fornecedor
					into STRICT	cd_fornecedor_inventario_w
					from	inventario
					where	nr_sequencia = nr_sequencia_p;

					select	count(*)
					into STRICT	qt_existe_material_w
					from	inventario_material
					where	nr_seq_inventario	= nr_sequencia_p
					and		cd_material	= cd_material_estoque_w;

					if	((ie_padrao_estoque_local_p = 'N') or (ie_padrao_estoque_local_p = 'S' AND ie_local_valido_w = 'S')) and
						((qt_saldo_consig_w > 0 AND ie_somente_com_saldo_p = 'S') or (ie_somente_com_saldo_p = 'N')) and
						((vl_custo_medio_w > 0 AND ie_custo_med_positivo_p = 'S') or (ie_custo_med_positivo_p = 'N')) and (ie_bloqueio_inventario_w = 'N') then
						begin
							select	nextval('inventario_material_seq')
							into STRICT	nr_sequencia_w
							;
					
							if (ie_consignado_w = 'S' and coalesce(cd_fornecedor_inventario_w::text, '') = '' and coalesce(cd_cgc_p::text, '') = '') then
								if (qt_existe_material_w = 0 and  substr(obter_se_material_estoque_lote(cd_estabelecimento_p,cd_material_estoque_w),1,1)  = 'S') then 										
									insert into inventario_material(
										nr_sequencia,
										nr_seq_inventario,
										dt_atualizacao,
										nm_usuario,
										cd_material,
										ie_status_inventario)
									values (	nr_sequencia_w,
										nr_sequencia_p,
										clock_timestamp(),
										nm_usuario_p,
										cd_material_estoque_w,
										'P');											
								end if;
							else
								if (ie_consignado_w = 'S' and coalesce(cd_fornecedor_inventario_w::text, '') = '' and (cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '') and cd_fornecedor_w = cd_cgc_p) then	
									update  inventario  
										set cd_fornecedor = cd_cgc_p
										where 	nr_sequencia = nr_sequencia_p;
												
									insert into inventario_material(
											nr_sequencia,
											nr_seq_inventario,
											dt_atualizacao,
											nm_usuario,
											cd_material,
											cd_fornecedor,
											ie_status_inventario)
									values (	nr_sequencia_w,
											nr_sequencia_p,
											clock_timestamp(),
											nm_usuario_p,
											cd_material_estoque_w,
											cd_cgc_p,
											'P');								
								else
									if (ie_consignado_w = 'S' and (cd_fornecedor_inventario_w IS NOT NULL AND cd_fornecedor_inventario_w::text <> '') and cd_fornecedor_inventario_w = cd_fornecedor_w) then
										insert into inventario_material(
											nr_sequencia,
											nr_seq_inventario,
											dt_atualizacao,
											nm_usuario,
											cd_material,
											cd_fornecedor,
											ie_status_inventario)
										values (	nr_sequencia_w,
											nr_sequencia_p,
											clock_timestamp(),
											nm_usuario_p,
											cd_material_estoque_w,
											cd_fornecedor_w,
											'P');
									end if;
								end if;
							end if;			
						end;
					end if;
					end;
				end if;
				end;
			end if;
			end;
		end loop;
		close c02;
		end;
	end if;
	end;
end if;

if (coalesce(ie_todos_saldo_estoque_p,'N') = 'S') then
	begin
	open c03;
	loop
	fetch c03 into
		cd_material_estoque_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		begin

		select	count(*)
		into STRICT	qt_existe_w
		from	inventario_material
		where	nr_seq_inventario	= nr_sequencia_p
		and	cd_material	= cd_material_estoque_w;

		if (qt_existe_w = 0) then
			begin
			ie_material_estrut_loc_w := 'S';
			if (nr_seq_estrut_mat_p > 0) then
				ie_material_estrut_loc_w := substr(obter_se_material_estrut_loc(cd_local_estoque_w, cd_material_estoque_w, nr_seq_estrut_mat_p),1,1);
			end if;

			if (ie_material_estrut_loc_w = 'S') then
				begin

				select	coalesce(sum(qt_estoque), 0),
						coalesce(sum(vl_custo_medio), 0)
				into STRICT	qt_saldo_w,
						vl_custo_medio_w
				from	saldo_estoque
				where	cd_estabelecimento		= cd_estabelecimento_p
				and	cd_local_estoque		= cd_local_estoque_w
				and	cd_material		= cd_material_estoque_w
				and	dt_mesano_referencia	= dt_mesano_referencia_w;

				ie_bloqueio_inventario_w := coalesce(obter_se_material_bloqueio_inv(
							cd_estabelecimento_p,
							cd_material_estoque_w,
							cd_local_estoque_w),'N');

				if (ie_padrao_estoque_local_p = 'S') then
					ie_local_valido_w := obter_local_valido( 	cd_estabelecimento_p, cd_local_estoque_w, cd_material_estoque_w, null, ie_local_valido_w);
				end if;

				if	((ie_padrao_estoque_local_p = 'N') or (ie_padrao_estoque_local_p = 'S' AND ie_local_valido_w = 'S')) and
					((qt_saldo_w > 0 AND ie_somente_com_saldo_p = 'S') or (ie_somente_com_saldo_p = 'N')) and
					((vl_custo_medio_w > 0 AND ie_custo_med_positivo_p = 'S') or (ie_custo_med_positivo_p = 'N')) and (ie_bloqueio_inventario_w = 'N') then
					begin
					select	nextval('inventario_material_seq')
					into STRICT	nr_sequencia_w
					;

					insert into inventario_material(
						nr_sequencia,
						nr_seq_inventario,
						dt_atualizacao,
						nm_usuario,
						cd_material,
						ie_status_inventario)
					values (	nr_sequencia_w,
						nr_sequencia_p,
						clock_timestamp(),
						nm_usuario_p,
						cd_material_estoque_w,
						'P');
					end;
				end if;
				end;
			end if;
			end;
		end if;
		end;
	end loop;
	close c03;
	end;
end if;

commit;

if (coalesce(qt_max_sorteio_p, 0) > 0) then
	begin

	delete
	from	inventario_material
	where	nr_seq_inventario	= nr_sequencia_p
	and	nr_sequencia	in (
		SELECT	nr_sequencia
		from (
			SELECT	nr_sequencia,
				row_number() OVER () AS linha
			from (
				select	nr_sequencia,
					ie_ordem
				from (
					select	nr_sequencia,
						dbms_random.value(1, 5000) ie_ordem
					from	inventario_material
					where	nr_seq_inventario	= nr_sequencia_p) alias3
				order by	ie_ordem) alias4
			) alias5
		where	linha > qt_max_sorteio_p);
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE definir_itens_inventario ( nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, cd_marca_p bigint, nr_seq_localizacao_p bigint, nr_seq_localizacao_multi_p text, ds_localizacao_local_p text, ds_loc_local_multi_p text, nr_seq_familia_p bigint, cd_unidade_medida_estoque_p text, cd_cgc_p text, ie_curva_p text, ie_curva_local_p text, ie_curva_xyz_p text, ie_receita_p text, ie_padronizado_p text, ie_somente_com_saldo_p text, ie_padrao_estoque_local_p text, qt_max_sorteio_p text, ie_todos_saldo_estoque_p text, ie_restringe_controlado_p text, ie_data_movimento_p text, nr_seq_estrut_mat_p text, ie_via_aplicacao_p text, dt_movimento_p timestamp, ie_tipo_material_p text, ie_estoque_lote_p text, ie_localizacao_local_p text, ie_custo_med_positivo_p text, ie_classif_custo_p text) FROM PUBLIC;

