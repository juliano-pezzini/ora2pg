-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_liber_benef_intercambio ( nr_seq_segurado_p bigint, ie_gerar_carteirinha_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_commit_p text) AS $body$
DECLARE

 
nr_seq_intercambio_w	pls_intercambio.nr_sequencia%type;
nr_seq_suspensao_w	pls_segurado_suspensao.nr_sequencia%type;


BEGIN 
 
select	max(nr_seq_intercambio) 
into STRICT	nr_seq_intercambio_w 
from	pls_segurado 
where	nr_sequencia	= nr_seq_segurado_p;
 
CALL pls_gerar_vl_seg_intercambio(	null, nr_seq_segurado_p, 'L', 
		cd_estabelecimento_p, nm_usuario_p,'S', 
		'S',ie_gerar_carteirinha_p, 'N');
 
/* Lepinski - OS 328203 - Gerar as bonfiicações de lançamentos programados */
 
CALL pls_lanc_bonificacao_plano_sca(nr_seq_segurado_p,0,'3',nm_usuario_p);
 
if (nr_seq_intercambio_w IS NOT NULL AND nr_seq_intercambio_w::text <> '') then 
	select	max(nr_sequencia) 
	into STRICT	nr_seq_suspensao_w 
	from	pls_segurado_suspensao 
	where	nr_seq_intercambio	= nr_seq_intercambio_w 
	and	(dt_inicio_suspensao IS NOT NULL AND dt_inicio_suspensao::text <> '') 
	and	coalesce(dt_fim_suspensao::text, '') = '';
	 
	if (nr_seq_suspensao_w IS NOT NULL AND nr_seq_suspensao_w::text <> '') then 
		update	pls_segurado 
		set	ie_situacao_atend	= 'S', 
			nr_seq_suspensao	= nr_seq_suspensao_w 
		where	nr_sequencia		= nr_seq_segurado_p;
	end if;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_liber_benef_intercambio ( nr_seq_segurado_p bigint, ie_gerar_carteirinha_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_commit_p text) FROM PUBLIC;

