-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dl_gerar_adiant_pago_distrib ( nr_seq_lote_p bigint, nr_seq_trans_fin_p text, nm_usuario_p text) AS $body$
DECLARE

	 
nr_seq_distribuicao_w		bigint;		
cd_pessoa_fisica_socio_w	varchar(10);
cd_estabelecimento_w		smallint;
vl_adiantamento_w        double precision;
cd_moeda_padrao_w		integer;

C01 CURSOR FOR 
	SELECT	a.nr_sequencia, 
		substr(dl_obter_dados_socio(a.nr_seq_socio, 'PF'),1,255) 
	from	dl_distribuicao a 
	where	a.nr_seq_lote	= nr_seq_lote_p 
	and 	coalesce(dl_obter_dados_distribuicao(a.nr_sequencia,'A'),null) is null 
	order by 
		a.nr_sequencia;	
	 

BEGIN 
 
select	a.cd_estabelecimento, 
	coalesce(a.vl_adiantamento,0) 
into STRICT	cd_estabelecimento_w, 
	vl_adiantamento_w 
from	dl_lote_distribuicao a 
where	a.nr_sequencia	= nr_seq_lote_p;
 
select	b.cd_moeda_padrao		 
into STRICT	cd_moeda_padrao_w		 
from	parametros_contas_pagar b		 
where	b.cd_estabelecimento	= cd_estabelecimento_w;	
	 
open C01;
loop 
fetch C01 into	 
	nr_seq_distribuicao_w, 
	cd_pessoa_fisica_socio_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	insert into adiantamento_pago(	 
		nr_adiantamento,             
		cd_estabelecimento,            
		dt_atualizacao,              
		nm_usuario,                
		dt_adiantamento,              
		vl_adiantamento,              
		vl_saldo,                 
		cd_moeda,                 
		cd_pessoa_fisica,                
		cd_cgc,                     
		cd_banco,                    
		nr_lote_contabil,                
		ds_observacao,                  
		dt_baixa,                    
		nr_seq_trans_fin,                
		nr_seq_conta_banco,               
		nr_titulo_original,               
		nr_seq_distribuicao) 
	values (	nextval('adiantamento_pago_seq'),             
		cd_estabelecimento_w,            
		clock_timestamp(),              
		nm_usuario_p,                
		clock_timestamp(),              
		vl_adiantamento_w,              
		vl_adiantamento_w,                 
		cd_moeda_padrao_w,                 
		cd_pessoa_fisica_socio_w,                
		null,                     
		null,                    
		null, 
		null, 
		null, 
		nr_seq_trans_fin_p, 
		null,		 
		null,               
		nr_seq_distribuicao_w);
	 
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dl_gerar_adiant_pago_distrib ( nr_seq_lote_p bigint, nr_seq_trans_fin_p text, nm_usuario_p text) FROM PUBLIC;

