-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_proc_appointment_link (nr_seq_proc_interno_p text, nr_atendimento_p bigint, cd_pessoa_fisica_p text, nr_seq_agenda_p bigint default null) AS $body$
DECLARE


nr_seq_proc_w       varchar(500);
dt_agenda_w         timestamp;
nr_cpoe_link_cnt_w  varchar(1);WITH RECURSIVE cte AS (


c_split_apps CURSOR FOR
SELECT	regexp_substr(nr_seq_proc_interno_p, '[^, ]+', 1, level) nr_seq

(regexp_substr(nr_seq_proc_interno_p, '[^, ]+', 1, level) IS NOT NULL AND (regexp_substr(nr_seq_proc_interno_p, '[^, ]+', 1, level))::text <> '')  UNION ALL


c_split_apps CURSOR FOR
SELECT	regexp_substr(nr_seq_proc_interno_p, '[^, ]+', 1, level) nr_seq
 
(regexp_substr(nr_seq_proc_interno_p, '[^, ]+', 1, level) IS NOT NULL AND (regexp_substr(nr_seq_proc_interno_p, '[^, ]+', 1, level))::text <> '') JOIN cte c ON ()

) SELECT * FROM cte;
;
BEGIN

nr_seq_proc_w := nr_seq_proc_interno_p;
if (nr_seq_proc_interno_p IS NOT NULL AND nr_seq_proc_interno_p::text <> '') then

    if (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') then
        select  dt_agenda
        into STRICT    dt_agenda_w
        from    agenda_consulta
        where   nr_sequencia = nr_seq_agenda_p;


        for r_c_split_apps in c_split_apps loop
            if (r_c_split_apps.nr_seq IS NOT NULL AND r_c_split_apps.nr_seq::text <> '') then
			
			Select coalesce(max('S'), 'N') into STRICT nr_cpoe_link_cnt_w from cpoe_pre_cons_link
			where NR_CPOE_PRE_CONS_EXAM=r_c_split_apps.nr_seq
			and NR_CONSULTA_AGENDA_SEQ=nr_seq_agenda_p
			and NR_PAC_ATENDIMENTO=nr_atendimento_p
			and CD_PESSOA_FISICA=cd_pessoa_fisica_p;
			if (nr_cpoe_link_cnt_w = 'N') then
                insert into cpoe_pre_cons_link(
                    nr_sequencia,
                    nm_usuario,
                    dt_atualizacao,
                    nm_usuario_nrec,
                    dt_atualizacao_nrec,
                    nr_cpoe_pre_cons_exam,
                    nr_consulta_agenda_seq,
                    nr_pac_atendimento,
                    cd_pessoa_fisica
                ) values (
                    nextval('cpoe_pre_cons_link_seq'),
                    wheb_usuario_pck.get_nm_usuario,
                    clock_timestamp(),
                    wheb_usuario_pck.get_nm_usuario,
                    clock_timestamp(),
                    r_c_split_apps.nr_seq,
                    nr_seq_agenda_p,
                    nr_atendimento_p,
                    cd_pessoa_fisica_p
                );
			end if;
                update  cpoe_procedimento
                set     dt_pre_cons_exam = dt_agenda_w
                where   nr_sequencia = r_c_split_apps.nr_seq;
            end if;
        end loop;
    else
        for r_c_split_apps in c_split_apps loop
            if (r_c_split_apps.nr_seq IS NOT NULL AND r_c_split_apps.nr_seq::text <> '') then
                delete
                from    cpoe_pre_cons_link
                where   nr_cpoe_pre_cons_exam = r_c_split_apps.nr_seq;

                update  cpoe_procedimento
                set     dt_pre_cons_exam  = NULL
                where   nr_sequencia = r_c_split_apps.nr_seq;
            end if;
        end loop;
    end if;

    commit;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_proc_appointment_link (nr_seq_proc_interno_p text, nr_atendimento_p bigint, cd_pessoa_fisica_p text, nr_seq_agenda_p bigint default null) FROM PUBLIC;

