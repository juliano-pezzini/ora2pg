-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_orcamento_distribuido (cd_operacao_p bigint) AS $body$
DECLARE


qt_registro_w				bigint;

BEGIN

if (cd_operacao_p = 1) then
	begin

	select	count(*)
	into STRICT	qt_registro_w
	from	user_indexes
	where	index_name	= 'ORCDIST_ORCCUST_FK_I';

	if (qt_registro_w > 0) then
		CALL exec_sql_dinamico('ORCDIST_PK',' drop index ORCDIST_ORCCUST_FK_I ');
	end if;

	select	count(column_name)
	into STRICT	qt_registro_w
	from	user_cons_columns
	where	constraint_name = 'ORCDIST_PK'
	and	column_name	= 'NR_SEQUENCIA';

	if (qt_registro_w = 0) then
		begin
		CALL exec_sql_dinamico('ORCDIST_PK',' alter table orcamento_distribuido drop constraint orcdist_pk ');

		select	count(*)
		into STRICT	qt_registro_w
		from	user_indexes
		where	index_name	= 'ORCDIST_PK';

		if (qt_registro_w > 0) then
			CALL exec_sql_dinamico('ORCDIST_PK',' drop index ORCDIST_PK ');
		end if;

		select	count(*)
		into STRICT	qt_registro_w
		from	user_tab_columns
		where	table_name	= 'ORCAMENTO_DISTRIBUIDO'
		and	column_name	= 'NR_SEQUENCIA';

		if (qt_registro_w = 0) then
			CALL exec_sql_dinamico('ORCDIST_PK',' alter table ORCAMENTO_DISTRIBUIDO add nr_sequencia number(15) ');
			CALL exec_sql_dinamico('ORCDIST_PK',' create sequence ORCAMENTO_DISTRIBUIDO_SEQ minvalue 1 maxvalue 999999999999999 nocycle increment by 1 ');
			CALL exec_sql_dinamico('ORCDIST_PK',' UPDATE ORCAMENTO_DISTRIBUIDO SET NR_SEQUENCIA = orcamento_distribuido_seq.nextval where nr_sequencia is null ');
			commit;
		end if;

		end;
	end if;


	end;
elsif (cd_operacao_p = 2) then
	begin
	qt_registro_w := obter_valor_dinamico('select count(*) from orcamento_distribuido where nr_sequencia is null ', qt_registro_w);

	if (coalesce(qt_registro_w,0) > 0) then
		begin
		CALL exec_sql_dinamico('Matheus','UPDATE ORCAMENTO_DISTRIBUIDO SET NR_SEQUENCIA = orcamento_distribuido_seq.nextval where nr_sequencia is null');
		commit;
		end;
	end if;
	select	count(*)
	into STRICT	qt_registro_w
	from	user_tab_columns
	where	table_name	= 'ORCAMENTO_DISTRIBUIDO'
	and	column_name	= 'NR_SEQUENCIA'
	and	nullable	= 'Y';

	if (qt_registro_w > 0) then
		CALL exec_sql_dinamico('ORCDIST_PK','alter table orcamento_distribuido modify nr_sequencia number(15) not null');
	end if;

	select	count(column_name)
	into STRICT	qt_registro_w
	from	user_cons_columns
	where	constraint_name = 'ORCDIST_PK'
	and	column_name	= 'NR_SEQUENCIA';

	if (qt_registro_w = 0) then
		begin
		CALL exec_sql_dinamico('ORCDIST_PK','alter table orcamento_distribuido add constraint orcdist_pk primary key (NR_SEQUENCIA)');
		end;
	end if;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_orcamento_distribuido (cd_operacao_p bigint) FROM PUBLIC;

