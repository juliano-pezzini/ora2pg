-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_update_retorno_dados_sht (ds_mensagem_retorno_p text, ds_sucesso_p text, nr_seq_item_p bigint, cd_receptor_p text) AS $body$
DECLARE


  ds_mensagem_retorno_w		san_lote_item.ds_mensagem_retorno%type;
  nr_seq_lote_w				san_lote_item.nr_seq_lote%type;
  ie_lote_enviado_w         varchar(1);
  ie_status_envio_w       	san_lote_item.ie_status_envio%type;

BEGIN
    select CASE WHEN upper(ds_sucesso_p)='TRUE' THEN  'S' WHEN upper(ds_sucesso_p)='FALSE' THEN  'N' END
    into STRICT ie_status_envio_w
;

	if (upper(ds_sucesso_p) = 'TRUE') then
		ds_mensagem_retorno_w := coalesce(ds_mensagem_retorno_p, wheb_mensagem_pck.get_texto(1113545));
	else
		ds_mensagem_retorno_w := coalesce(ds_mensagem_retorno_p, wheb_mensagem_pck.get_texto(1113546));
	end if;
	
	if (nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '') then
	
		select nr_seq_lote
		into STRICT nr_seq_lote_w		
		from san_lote_item
		where nr_sequencia = nr_seq_item_p;	
	 
		update san_lote_item
		set ds_mensagem_retorno = ds_mensagem_retorno_w,
			cd_receptor_externo = coalesce(cd_receptor_p,'0'),
            ie_status_envio = ie_status_envio_w
		where nr_sequencia = nr_seq_item_p;
	
	
		select CASE WHEN count(*)=0 THEN  'S'  ELSE 'N' END
		into STRICT ie_lote_enviado_w
		from san_lote_item
		where nr_seq_lote = nr_seq_lote_w 
		and coalesce(ie_status_envio, 'N') = 'N';
	
	end if;

    if (ie_lote_enviado_w = 'S') then 
        update  san_lote_integracao
        set     dt_envio = clock_timestamp()
        where   nr_sequencia = nr_seq_lote_w;
    end if;

	commit;	

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_update_retorno_dados_sht (ds_mensagem_retorno_p text, ds_sucesso_p text, nr_seq_item_p bigint, cd_receptor_p text) FROM PUBLIC;

