-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE check_nut_warning_list (nr_atendimento_p bigint, dt_inicio_p timestamp, nr_warning_p INOUT bigint, ds_message_p INOUT text) AS $body$
DECLARE


function_parameter_list_w varchar(15) := '';
function_parameter_hour_w varchar(15) := '';


BEGIN

    select 	coalesce(max(IE_DEADLINE_LISTA), 'N'),
			coalesce(max(IE_DEADLINE_HORA), 'N')
    into STRICT 	function_parameter_list_w,
			function_parameter_hour_w
    from PARAMETROS_NUTRICAO where CD_ESTABELECIMENTO = wheb_usuario_pck.get_cd_estabelecimento
    order by NR_SEQUENCIA desc LIMIT 1;
	
    if (function_parameter_hour_w = 'S') then
        select
            count(nsh.nr_sequencia) warning,
            '1150697' message
        into STRICT 
            nr_warning_p,
            ds_message_p
        from NUT_SERVICO_HORARIO nsh
        where (nsh.ds_horario_limite IS NOT NULL AND nsh.ds_horario_limite::text <> '')
            and pkg_date_utils.get_DiffDate(dt_inicio_p, nsh.ds_horarios_html, 'HOUR%') <= 0
            and pkg_date_utils.get_DiffDate(dt_inicio_p, nsh.ds_horarios_fim_html, 'HOUR%') >= 0
            and pkg_date_utils.get_DiffDate(dt_inicio_p, nsh.ds_horario_limite, 'HOUR%') < 0;

    end if;

    if (function_parameter_list_w = 'S' and (coalesce(nr_warning_p::text, '') = '' or nr_warning_p = 0)) then
        select 
            count(nasd.nr_sequencia) warning,
            '1150698' message
        into STRICT 
            nr_warning_p,
            ds_message_p
        from NUT_SERVICO_HORARIO nsh,
            nut_atend_serv_dia nasd,
            nut_pac_servico_imp imp
        where pkg_date_utils.get_DiffDate(dt_inicio_p, nsh.ds_horarios_html, 'HOUR%') <= 0
            and pkg_date_utils.get_DiffDate(dt_inicio_p, nsh.ds_horarios_fim_html, 'HOUR%') >= 0
            and nasd.nr_seq_servico = nsh.nr_seq_servico
            and imp.nr_seq_atend_serv_dia = nasd.nr_sequencia
            and nasd.nr_atendimento = nr_atendimento_p;
    end if;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE check_nut_warning_list (nr_atendimento_p bigint, dt_inicio_p timestamp, nr_warning_p INOUT bigint, ds_message_p INOUT text) FROM PUBLIC;

