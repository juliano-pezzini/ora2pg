-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE separar_laudo_pacs_mmed ( ds_lista_exames_p text, nm_usuario_p text) AS $body$
DECLARE




nr_sequencia_prescricao_w	bigint;
nr_prescricao_w			bigint;
ds_arquivo_w			varchar(80);
ds_lista_w			varchar(2000);
tam_lista_w			bigint;
ie_pos_virgula_w		smallint;
nr_seq_proc_pac_w		bigint;
nr_seq_interno_w		bigint;
qt_existe_virgula_w		bigint;

nr_prescr_w			bigint;
nr_sequencia_prescr_w		bigint;
nr_seq_prescr_proc_w		bigint;
nr_laudo_w			bigint;
ie_status_execucao_w		varchar(5);


BEGIN

ds_lista_w := ds_lista_exames_p;

select	position(',' in ds_lista_w)
into STRICT	qt_existe_virgula_w
;

if (qt_existe_virgula_w = 0)  then
	ds_lista_w := ds_lista_w || ',';
end if;

if (ds_lista_w IS NOT NULL AND ds_lista_w::text <> '') then
	begin
	while(ds_lista_w IS NOT NULL AND ds_lista_w::text <> '')  loop
		begin
		tam_lista_w			:= length(ds_lista_w);
		ie_pos_virgula_w		:= position(',' in ds_lista_w);

		if (ie_pos_virgula_w <> 0) then
			nr_seq_interno_w	:= (substr(ds_lista_w,1,(ie_pos_virgula_w - 1)))::numeric;
			ds_lista_w		:= substr(ds_lista_w,(ie_pos_virgula_w + 1),tam_lista_w);
		end if;


		select	max(a.nr_prescricao),
			max(a.nr_sequencia)
		into STRICT	nr_prescricao_w,
			nr_sequencia_prescricao_w
		from	prescr_procedimento a
		where	a.nr_seq_interno 	= nr_seq_interno_w;


		update	procedimento_paciente
		set	nr_laudo		 = NULL,
    		nr_controle  = NULL
		where	nr_prescricao		= nr_prescricao_w
		and	nr_sequencia_prescricao = nr_sequencia_prescricao_w;

		delete from prescr_proc_ditado
		where nr_seq_prescr_proc = nr_seq_interno_w;

		delete from prescr_proc_captura_img
		where nr_prescricao = nr_prescricao_w
		and nr_sequencia_prescricao = nr_sequencia_prescricao_w;

		update	prescr_procedimento
		set	ie_status_execucao 	= 20
		where	nr_prescricao 		= nr_prescricao_w
		and	nr_sequencia 		= nr_sequencia_prescricao_w;

		commit;

		CALL gravar_auditoria_mmed(nr_prescricao_w,nr_sequencia_prescricao_w,nm_usuario_p,24,null);


		end;
	end loop;
	end;
end if;



commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE separar_laudo_pacs_mmed ( ds_lista_exames_p text, nm_usuario_p text) FROM PUBLIC;

