-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_reconst_diluicao_sol ( nr_prescricao_p bigint, nr_sequencia_p bigint, nr_sequencia_solucao_p bigint, ie_opcao_p text) AS $body$
DECLARE

 
 
cd_material_w						integer;
cd_material_sem_apresent_w			integer;
cd_material_generico_w				integer;
cd_mat_generico_sem_apresent_w		integer;
cd_intervalo_w						varchar(7);
cd_intervalo_cad_w					varchar(7);
nr_agrupamento_w					double precision;
cd_unidade_medida_w					varchar(30);
nr_ocorrencia_w						double precision;
nr_seq_acum_w						bigint;
nr_agrup_acum_w						double precision;
nr_sequencia_w						bigint;
qt_conversao_w						double precision;
nm_usuario_w						varchar(15);
ie_gerar_reconstituicao_w			varchar(15);
cd_diluente_w						integer;
qt_diluicao_w						double precision;
cd_unid_med_diluente_w				varchar(30);
ie_reconstituicao_w					varchar(1);
ie_gera_dil_dose_w					varchar(5);
ie_via_aplicacao_w					varchar(5);
ie_via_aplic_order_w				varchar(5);
qt_minuto_aplicacao_w				smallint;
qt_hora_aplicacao_w					smallint;
qt_material_w						double precision;
Qt_total_disp_w						double precision;
qt_unitaria_w						double precision;
ie_gera_diluicao_w					varchar(1) := 'S';
Controle_w							smallint := 0;
Controle_ww							smallint := 0;
ie_regra_w							varchar(1) := 'N';
ie_diluente_w						varchar(1) := 'N';
ie_atualizar_horario_w				varchar(5);
nr_seq_prioridade_w					smallint;
cd_setor_atendimento_w				integer;
cd_setor_w							integer;
cd_estabelecimento_w				smallint;
qt_idade_w							double precision;
qt_idade_min_w						double precision;
qt_idade_max_w						double precision;
cd_motivo_baixa_w					smallint;/* Rafael em 17/11/2007 OS74014 */
ie_cobra_paciente_w					varchar(1);/* Rafael em 17/11/2007 OS74014 */
ds_dose_diferenciada_w				varchar(50);
qt_dispensar_w						double precision;
ie_regra_disp_w						varchar(1);
ds_erro_w							varchar(255);
cd_perfil_w							integer;
nm_usuario_original_w				varchar(15);
ie_atualiza_reconst_w				varchar(1);
qt_peso_w							real;
ie_gerar_diluicao_w					varchar(1);
qt_vol_adic_reconst_w				double precision;
ie_proporcao_w						varchar(15);
qt_referencia_w						double precision;
qt_referencia_aux_w					double precision;
qt_unitaria_medic_w					double precision;
qt_dose_medic_w						double precision;
qt_dose_aux_w						double precision;
cd_unidade_medida_dose_w			varchar(30);
qt_dose_diluicao_w					double precision;
nr_seq_via_acesso_w					bigint;
nr_seq_restricao_w					bigint;
cd_pessoa_fisica_w					varchar(30);
ds_lista_restricao_w				varchar(255);
qt_solucao_w						double precision;
nr_seq_interno_w					bigint;
cd_unid_med_reconst_w				varchar(30);
qt_dose_especial_w					double precision;
qt_dias_util_w						smallint;
ie_gerar_diluicao_ww				varchar(1);
ie_prescr_mat_sem_lib_w				varchar(30);
ie_se_necessario_w					varchar(1);
ie_acm_w							varchar(1);

/* 
ie_opcao_p 
	D Diluição 
	R Reconstituição 
	A Ambos 
*/
	 
 
c01 CURSOR FOR 
SELECT	coalesce(cd_diluente,0), 
		coalesce(qt_diluicao,0), 
		coalesce(cd_unid_med_diluente,obter_unid_med_usua('ml')), 
		coalesce(ie_reconstituicao,'A'), 
		ie_via_aplicacao, 
		coalesce(qt_minuto_aplicacao,0), 
		cd_intervalo, 
		nr_seq_prioridade, 
		cd_setor_atendimento, 
		qt_idade_min, 
		qt_idade_max, 
		coalesce(cd_motivo_baixa,0), 
		coalesce(ie_cobra_paciente,'S'), 
		coalesce(ie_proporcao,'F'), 
		qt_referencia, 
		nr_seq_restricao, 
		nr_seq_interno 
from	material_diluicao 
where	ie_gera_diluicao_w = 'S' 
and		ie_opcao_p in ('A','D') 
and		((cd_setor_atendimento	= cd_setor_atendimento_w) 
or (coalesce(cd_setor_atendimento::text, '') = '')) 
and		((coalesce(cd_setor_excluir::text, '') = '') or (cd_setor_excluir <> cd_setor_atendimento_w)) 
and		obter_se_regra_diluicao_setor(nr_seq_interno, cd_setor_atendimento_w) = 'S' 
and		((coalesce(nr_seq_via_acesso::text, '') = '') or (nr_seq_via_acesso = nr_seq_via_acesso_w)) 
and		cd_estabelecimento	= cd_estabelecimento_w 
and		((obter_se_contido(nr_seq_restricao, ds_lista_restricao_w) = 'S') or (coalesce(nr_seq_restricao::text, '') = '')) 
and		ie_reconstituicao	= 'N' 
and		cd_material		= coalesce(cd_material_sem_apresent_w, cd_material_w) 
and		qt_idade_w between obter_idade_diluicao(cd_material,nr_sequencia,'MIN') and obter_idade_diluicao(cd_material,nr_sequencia,'MAX') 
and		qt_peso_w between coalesce(qt_peso_min,0) and coalesce(qt_peso_max,999999) 
and		((coalesce(cd_unidade_medida::text, '') = '') or (cd_unidade_medida	= cd_unidade_medida_dose_w)) 
and		coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida_dose_w,qt_dose_medic_w),0) between 
		coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida,qt_dose_min),0) and 
		coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida,qt_dose_max),9999999) 
and		((ie_via_aplicacao	= ie_via_aplicacao_w) or (coalesce(ie_via_aplicacao::text, '') = '')) 

union
 
SELECT	coalesce(cd_diluente,0), 
		coalesce(qt_diluicao,0), 
		coalesce(cd_unid_med_diluente,obter_unid_med_usua('ml')), 
		coalesce(ie_reconstituicao,'A'), 
		ie_via_aplicacao, 
		coalesce(qt_minuto_aplicacao,0), 
		cd_intervalo, 
		nr_seq_prioridade, 
		cd_setor_atendimento, 
		qt_idade_min, 
		qt_idade_max, 
		coalesce(cd_motivo_baixa,0), 
		coalesce(ie_cobra_paciente,'S'), 
		coalesce(ie_proporcao,'F'), 
		qt_referencia, 
		nr_seq_restricao, 
		nr_seq_interno 
from	material_diluicao 
where	ie_gera_diluicao_w	= 'S' 
and		ie_opcao_p in ('A','D') 
and		ie_reconstituicao	= 'N' 
and		((cd_setor_atendimento	= cd_setor_atendimento_W) or (coalesce(cd_setor_atendimento::text, '') = '')) 
and		((coalesce(cd_setor_excluir::text, '') = '') or (cd_setor_excluir <> cd_setor_atendimento_w)) 
and		obter_se_regra_diluicao_setor(nr_seq_interno, cd_setor_atendimento_w) = 'S' 
and		((coalesce(nr_seq_via_acesso::text, '') = '') or (nr_seq_via_acesso = nr_seq_via_acesso_w)) 
and		((obter_se_contido(nr_seq_restricao, ds_lista_restricao_w) = 'S') or (coalesce(nr_seq_restricao::text, '') = '')) 
and		cd_estabelecimento	= cd_estabelecimento_w 
and		cd_material		= coalesce(cd_mat_generico_sem_apresent_w, cd_material_generico_w) 
and		qt_idade_w between obter_idade_diluicao(cd_material,nr_sequencia,'MIN') and obter_idade_diluicao(cd_material,nr_sequencia,'MAX') 
and		qt_peso_w between coalesce(qt_peso_min,0) and coalesce(qt_peso_max,999999) 
and		((coalesce(cd_unidade_medida::text, '') = '') or (cd_unidade_medida	= cd_unidade_medida_dose_w)) 
and		coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida_dose_w,qt_dose_medic_w),0) between 
		coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida,qt_dose_min),0) and 
		coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida,qt_dose_max),9999999) 
and		ie_regra_w		= 'G' 
and		((ie_via_aplicacao	= ie_via_aplicacao_w) or (coalesce(ie_via_aplicacao::text, '') = '')) 
order by	 
		ie_via_aplicacao desc, 
		cd_setor_atendimento desc, 
		qt_idade_min desc, 
		qt_idade_max desc, 
		nr_seq_prioridade desc, 
		nr_seq_restricao desc;

c02 CURSOR FOR 
SELECT	coalesce(cd_diluente,0), 
		coalesce(qt_diluicao,0), 
		coalesce(cd_unid_med_diluente,obter_unid_med_usua('ml')), 
		coalesce(ie_reconstituicao,'A'), 
		ie_via_aplicacao, 
		cd_intervalo, 
		nr_seq_prioridade, 
		cd_setor_atendimento, 
		qt_idade_min, 
		qt_idade_max, 
		coalesce(cd_motivo_baixa,0), 
		coalesce(ie_cobra_paciente,'S'), 
		coalesce(qt_minuto_aplicacao,0), 
		qt_volume_adic, 
		coalesce(ie_proporcao,'F'), 
		qt_referencia, 
		nr_seq_restricao, 
		cd_unid_med_reconst 
from	material_diluicao 
where	ie_opcao_p in ('A','R') 
and		cd_material		= cd_material_w 
and		ie_reconstituicao 	= 'S' 
and		ie_gerar_reconstituicao_w	= 'S' 
and		cd_estabelecimento	= cd_estabelecimento_w 
and		((obter_se_contido(nr_seq_restricao, ds_lista_restricao_w) = 'S') or (coalesce(nr_seq_restricao::text, '') = '')) 
and		qt_idade_w between obter_idade_diluicao(cd_material,nr_sequencia,'MIN') and obter_idade_diluicao(cd_material,nr_sequencia,'MAX') 
and		qt_peso_w between coalesce(qt_peso_min,0) and coalesce(qt_peso_max,999999) 
and		((cd_setor_atendimento	= cd_setor_atendimento_W) or (coalesce(cd_setor_atendimento::text, '') = '')) 
and		((coalesce(cd_setor_excluir::text, '') = '') or (cd_setor_excluir <> cd_setor_atendimento_w)) 
and		obter_se_regra_diluicao_setor(nr_seq_interno, cd_setor_atendimento_w) = 'S' 
and		coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida_dose_w, qt_dose_medic_w ),0) between 
		coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida,qt_dose_min),0) and 
		coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida,qt_dose_max),9999999) 
and		((ie_via_aplicacao 	= ie_via_aplicacao_w) or (coalesce(ie_via_aplicacao::text, '') = '')) 
and 	((coalesce(cd_unidade_medida::text, '') = '') or (cd_unidade_medida	= cd_unidade_medida_dose_w)) 

union
 
SELECT	coalesce(cd_diluente,0), 
		coalesce(qt_diluicao,0), 
		coalesce(cd_unid_med_diluente,obter_unid_med_usua('ml')), 
		coalesce(ie_reconstituicao,'A'), 
		ie_via_aplicacao, 
		cd_intervalo, 
		nr_seq_prioridade, 
		cd_setor_atendimento, 
		qt_idade_min, 
		qt_idade_max, 
		coalesce(cd_motivo_baixa,0), 
		coalesce(ie_cobra_paciente,'S'), 
		coalesce(qt_minuto_aplicacao,0), 
		qt_volume_adic, 
		coalesce(ie_proporcao,'F'), 
		qt_referencia, 
		nr_seq_restricao, 
		cd_unid_med_reconst 
from	material_diluicao 
where	ie_opcao_p in ('A','R') 
and		cd_material 		= cd_material_generico_w 
and		cd_estabelecimento	= cd_estabelecimento_w 
and		((obter_se_contido(nr_seq_restricao, ds_lista_restricao_w) = 'S') or (coalesce(nr_seq_restricao::text, '') = '')) 
and		qt_idade_w between obter_idade_diluicao(cd_material,nr_sequencia,'MIN') and obter_idade_diluicao(cd_material,nr_sequencia,'MAX') 
and		qt_peso_w between coalesce(qt_peso_min,0) and coalesce(qt_peso_max,999999) 
and		ie_reconstituicao	= 'S' 
and		ie_gerar_reconstituicao_w	= 'S' 
and		ie_regra_w		= 'G' 
and		((cd_setor_atendimento	= cd_setor_atendimento_W) or (coalesce(cd_setor_atendimento::text, '') = '')) 
and		((coalesce(cd_setor_excluir::text, '') = '') or (cd_setor_excluir <> cd_setor_atendimento_w)) 
and		obter_se_regra_diluicao_setor(nr_seq_interno, cd_setor_atendimento_w) = 'S' 
and		coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida_dose_w,qt_dose_medic_w),0) between 
		coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida,qt_dose_min),0) and 
		coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida,qt_dose_max),9999999) 
and		((ie_via_aplicacao	= ie_via_aplicacao_w) or (coalesce(ie_via_aplicacao::text, '') = '')) 
and 	((coalesce(cd_unidade_medida::text, '') = '') or (cd_unidade_medida	= cd_unidade_medida_dose_w)) 
order by 
		ie_via_aplicacao desc, 
		cd_setor_atendimento desc, 
		qt_idade_min desc, 
		qt_idade_max desc, 
		nr_seq_prioridade desc, 
		nr_seq_restricao desc;
		
c04 CURSOR FOR 
SELECT	coalesce(cd_diluente,0), 
		coalesce(qt_diluicao,0), 
		coalesce(cd_unid_med_diluente,obter_unid_med_usua('ml')), 
		coalesce(ie_reconstituicao,'A'), 
		ie_via_aplicacao, 
		coalesce(qt_minuto_aplicacao,0), 
		cd_intervalo, 
		nr_seq_prioridade, 
		cd_setor_atendimento, 
		qt_idade_min, 
		qt_idade_max, 
		coalesce(cd_motivo_baixa,0), 
		coalesce(ie_cobra_paciente,'S'), 
		coalesce(ie_proporcao,'F'), 
		qt_referencia, 
		nr_seq_restricao, 
		qt_volume 
from	material_diluicao 
where	cd_material		= cd_material_w 
and		cd_estabelecimento	= cd_estabelecimento_w 
and		qt_idade_w between obter_idade_diluicao(cd_material,nr_sequencia,'MIN') and obter_idade_diluicao(cd_material,nr_sequencia,'MAX') 
and		qt_peso_w between coalesce(qt_peso_min,0) and coalesce(qt_peso_max,999) 
and		ie_reconstituicao	= 'R' 
and		ie_gerar_rediluente	= 'S' 
and		(qt_volume IS NOT NULL AND qt_volume::text <> '') 
and		((coalesce(ie_via_aplicacao::text, '') = '') or (ie_via_aplicacao = ie_via_aplicacao_w));
		
c03 CURSOR FOR 
SELECT	nr_seq_restricao 
from	paciente_rep_prescricao a 
where	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
and		cd_pessoa_fisica = cd_pessoa_fisica_w 
and		coalesce(dt_inativacao::text, '') = '' 
and		((coalesce(a.dt_fim::text, '') = '') or (clock_timestamp() between coalesce(a.dt_inicio,clock_timestamp() - interval '1 days') and a.dt_fim + 86399/86400));


BEGIN 
 
/* Fernando */
 
/* Matheus OS 50978 20/03/07 coloquei cd_estabelecimento*/
 
select	max(a.cd_setor_atendimento), 
		max(a.cd_estabelecimento), 
		max(obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'DIA')), 
		max(a.nm_usuario_original), 
		coalesce(max(a.qt_peso),0), 
		max(b.cd_pessoa_fisica) 
into STRICT	cd_setor_atendimento_w, 
		cd_estabelecimento_w, 
		qt_idade_w, 
		nm_usuario_original_w, 
		qt_peso_w, 
		cd_pessoa_fisica_w 
from	pessoa_fisica b, 
		prescr_medica a 
where	a.nr_prescricao		= nr_prescricao_p 
and		a.cd_pessoa_fisica	= b.cd_pessoa_fisica;
 
cd_perfil_w	:= obter_perfil_ativo;
ie_regra_w := Obter_Param_Usuario(924, 78, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_regra_w);
ie_atualiza_reconst_w := Obter_Param_Usuario(924, 214, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_atualiza_reconst_w);
ie_gera_dil_dose_w := Obter_Param_Usuario(924, 347, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_gera_dil_dose_w);
ie_prescr_mat_sem_lib_w := Obter_Param_Usuario(924, 530, cd_perfil_w, nm_usuario_original_w, cd_estabelecimento_w, ie_prescr_mat_sem_lib_w);
 
select	coalesce(max(ie_gerar_diluicao),'S'), 
		coalesce(max(ie_gerar_reconstituicao),'S') 
into STRICT	ie_gerar_diluicao_ww, 
		ie_gerar_reconstituicao_w 
from	setor_atendimento 
where	cd_setor_atendimento	= cd_setor_atendimento_w;
 
if (nr_prescricao_p > 0) and (nr_sequencia_p > 0) and 
	((ie_gerar_diluicao_ww = 'S') or (ie_gerar_reconstituicao_w = 'S')) then 
	 
	select	coalesce(max(nr_sequencia),0), 
			coalesce(max(nr_agrupamento),0) 
	into STRICT	nr_seq_acum_w, 
			nr_agrup_acum_w 
	from	prescr_material 
	where	nr_prescricao = NR_PRESCRICAO_P;
	 
	Select	coalesce(cd_material,0), 
			cd_intervalo, 
			coalesce(nr_agrupamento,0), 
			coalesce(cd_unidade_medida,obter_unid_med_usua('ml')), 
			coalesce(nr_ocorrencia,1), 
			coalesce(nm_usuario,'Tasy'), 
			ie_via_aplicacao, 
			qt_material, 
			qt_total_dispensar, 
			qt_unitaria, 
			cd_mat_sem_apresent, 
			coalesce(ie_gerar_diluicao, 'S'), 
			ds_dose_diferenciada, 
			nr_seq_via_acesso, 
			qt_dose, 
			cd_unidade_medida_dose, 
			qt_dose_especial, 
			qt_dias_util 
	into STRICT	cd_material_w, 
			cd_intervalo_w, 
			nr_agrupamento_w, 
			cd_unidade_medida_w, 
			nr_ocorrencia_w, 
			nm_usuario_w, 
			ie_via_aplicacao_w, 
			qt_material_w, 
			Qt_total_disp_w, 
			qt_unitaria_medic_w, 
			cd_material_sem_apresent_w, 
			ie_gerar_diluicao_w, 
			ds_dose_diferenciada_w, 
			nr_seq_via_acesso_w, 
			qt_dose_medic_w, 
			cd_unidade_medida_dose_w, 
			qt_dose_especial_w, 
			qt_dias_util_w 
	from	prescr_material 
	where	nr_prescricao = nr_prescricao_p 
	and		nr_sequencia = nr_sequencia_p 
	and		(cd_material IS NOT NULL AND cd_material::text <> '');
	 
	open c03;
	loop 
	fetch c03 into	 
		nr_seq_restricao_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		ds_lista_restricao_w	:= nr_seq_restricao_w || ',' || ds_lista_restricao_w;
	end loop;
	close c03;
 
	if (cd_material_sem_apresent_w IS NOT NULL AND cd_material_sem_apresent_w::text <> '') then 
		select	sum(qt_dose) 
		into STRICT	qt_dose_medic_w 
		from	prescr_material 
		where	nr_prescricao		= nr_prescricao_p 
		and		cd_mat_sem_apresent	= cd_material_sem_apresent_w;
	end if;
 
	select	coalesce(max(cd_material_generico),cd_material_w) 
	into STRICT	cd_material_generico_w 
	from	material 
	where	cd_material	= cd_material_w;
 
	select	coalesce(max(cd_material_generico),cd_material_sem_apresent_w) 
	into STRICT	cd_mat_generico_sem_apresent_w 
	from	material 
	where	cd_material	= cd_material_sem_apresent_w;
	 
	/* Inserir o reconstituinte */
 
	open C02;
	loop 
	fetch c02 into 
		cd_diluente_w, 
		qt_diluicao_w, 
		cd_unid_med_diluente_w, 
		ie_reconstituicao_w, 
		ie_via_aplic_order_w, 
		cd_intervalo_cad_w, 
		nr_seq_prioridade_w, 
		cd_setor_w, 
		qt_idade_min_w, 
		qt_idade_max_w, 
		cd_motivo_baixa_w, 
		ie_cobra_paciente_w, 
		qt_minuto_aplicacao_w, 
		qt_vol_adic_reconst_w, 
		ie_proporcao_w, 
		qt_referencia_w, 
		nr_seq_restricao_w, 
		cd_unid_med_reconst_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		ie_diluente_w	:= 'S';
	end loop;	
	close C02;
	 
	if (coalesce(qt_referencia_w,0) > 0) then 
		qt_referencia_w	:= obter_conversao_unid_med_cons(cd_diluente_w,cd_unid_med_diluente_w,qt_referencia_w);
	end if;
	 
	if (ie_diluente_w = 'S') and (coalesce(cd_diluente_w,0) > 0) then 
	 
		nr_sequencia_w	:= nr_seq_acum_w + 1;
 
		select	substr(obter_dados_material_estab(cd_material,cd_estabelecimento_w,'UMS'),1,30) cd_unidade_medida_consumo 
		into STRICT	cd_unidade_medida_w 
		from	material 
		where	cd_material	= cd_diluente_w;
		 
		select	coalesce(max(qt_conversao),1) 
		into STRICT	qt_conversao_w 
		from	material_conversao_unidade 
		where	cd_material		= cd_diluente_w 
		and		cd_unidade_medida	= cd_unid_med_diluente_w;
 
		if (ie_atualiza_reconst_w = 'N') then 
			begin 
			delete	FROM prescr_material 
			where	nr_prescricao = nr_prescricao_p 
			and		ie_agrupador = 4 
			and		nr_sequencia_solucao	= nr_sequencia_solucao_p 
			and		nr_sequencia_diluicao 	= nr_sequencia_p;
			end;
		end if;
		 
		Select	count(*) 
		into STRICT	Controle_w 
		from	prescr_material 
		where	nr_prescricao = nr_prescricao_p 
		and		ie_agrupador = 4 
		and		nr_sequencia_solucao	= nr_sequencia_solucao_p 
		and		nr_sequencia_diluicao = nr_sequencia_p;
 
		qt_unitaria_w	:= dividir(qt_diluicao_w,qt_conversao_w);
 
		if (Controle_w = 0) then 
			begin 
		 
			Select	count(*) 
			into STRICT	Controle_ww 
			from	prescr_material 
			where	nr_prescricao = nr_prescricao_p 
			and		ie_agrupador = 4 
			and		nr_sequencia_solucao	= nr_sequencia_solucao_p 
			and		nr_sequencia_diluicao = nr_sequencia_p;
			 
			if (Controle_ww = 0) then 
				begin 
				if (qt_minuto_aplicacao_w > 0) then 
					if (qt_minuto_aplicacao_w < 60) then 
						qt_hora_aplicacao_w	:= null;
					elsif (qt_minuto_aplicacao_w = 60) then 
						qt_hora_aplicacao_w	:= 1;
						qt_minuto_aplicacao_w	:= null;
					else 
						qt_hora_aplicacao_w	:= trunc(dividir(qt_minuto_aplicacao_w,60));		
						qt_minuto_aplicacao_w	:= (qt_minuto_aplicacao_w - (qt_hora_aplicacao_w * 60));
					end if;
				end if;
				 
				if (qt_minuto_aplicacao_w = 0) then 
					qt_minuto_aplicacao_w	:= null;
				end if;
 
				update	prescr_material 
				set		qt_min_aplicacao	= qt_minuto_aplicacao_w, 
						qt_hora_aplicacao	= qt_hora_aplicacao_w 
				where	nr_prescricao		= nr_prescricao_p 
				and		nr_sequencia		= nr_sequencia_p 
				and		coalesce(qt_min_aplicacao::text, '') = '' 
				and		coalesce(qt_hora_aplicacao::text, '') = '' 
				and		ie_aplic_bolus		= 'N' 
				and		ie_aplic_lenta		= 'N';
				end;
			end if;
		 
			insert into prescr_material( 
				nr_prescricao, 
				nr_sequencia, 
				ie_origem_inf, 
				cd_material, 
				cd_unidade_medida, 
				cd_unidade_medida_dose, 
				qt_dose, 
				qt_unitaria, 
				qt_material, 
				dt_atualizacao, 
				nm_usuario, 
				cd_intervalo, 
				nr_agrupamento, 
				cd_motivo_baixa, 
				nr_sequencia_diluicao, 
				ie_agrupador, 
				qt_conversao_dose, 
				ie_utiliza_kit, 
				ie_urgencia, 
				ie_medicacao_paciente, 
				ie_suspenso, 
				ie_recons_diluente_fixo, 
				nr_ocorrencia, 
				qt_total_dispensar, 
				ie_sem_aprazamento, 
				ie_cobra_paciente, 
				ie_regra_disp, 
				qt_vol_adic_reconst, 
				qt_ref_diluente, 
				nr_sequencia_solucao) 
			values (	 
				nr_prescricao_p, 
				nr_sequencia_w, 
				'1', 
				cd_diluente_w, 
				cd_unidade_medida_w, 
				cd_unid_med_diluente_w, 
				qt_diluicao_w, 
				qt_unitaria_w, 
				qt_unitaria_w * Qt_total_disp_w, 
				clock_timestamp(), 
				nm_usuario_w, 
				null, 
				0, 
				/*0,*/
 
				cd_motivo_baixa_w, 
				nr_sequencia_p, 
				4, 
				qt_conversao_w, 
				'N', 
				'N', 
				'N',	 
				'N', 
				'N', 
				nr_ocorrencia_w, 
				Qt_total_disp_w, 
				'N', 
				ie_cobra_paciente_w, 
				CASE WHEN cd_motivo_baixa_w=0 THEN  null  ELSE 'D' END , 
				qt_vol_adic_reconst_w, 
				CASE WHEN ie_proporcao_w='SC' THEN  qt_referencia_w WHEN ie_proporcao_w='ST' THEN  qt_referencia_w  ELSE null END , 
				nr_sequencia_solucao_p);
				 
				IF (ie_prescr_mat_sem_lib_w = 'S') THEN 
					CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_sequencia_w,cd_perfil_w,'N',nm_usuario_original_w,null);
				END IF;				
				 
			end;
		end if;
	end if;
 
	/* Inserir o Diluente */
 
	if (ie_gerar_diluicao_ww = 'S') then 
		 
		select	coalesce(max(nr_sequencia),0), 
				coalesce(max(nr_agrupamento),0) 
		into STRICT	nr_seq_acum_w, 
				nr_agrup_acum_w 
		from	prescr_material 
		where	nr_prescricao = NR_PRESCRICAO_P;
	 
		if (ie_via_aplicacao_w IS NOT NULL AND ie_via_aplicacao_w::text <> '') then 
			select	max(ie_gera_diluicao) 
			into STRICT	ie_gera_diluicao_w 
			from	via_aplicacao 
			where	ie_via_aplicacao = ie_via_aplicacao_w;
		end if;
 
		ie_diluente_w	:= 'N';
		 
		open C01;
		loop 
		fetch C01 into 
			cd_diluente_w, 
			qt_diluicao_w, 
			cd_unid_med_diluente_w, 
			ie_reconstituicao_w, 
			ie_via_aplic_order_w, 
			qt_minuto_aplicacao_w, 
			cd_intervalo_cad_w, 
			nr_seq_prioridade_w, 
			cd_setor_w, 
			qt_idade_min_w, 
			qt_idade_max_w, 
			cd_motivo_baixa_w, 
			ie_cobra_paciente_w, 
			ie_proporcao_w, 
			qt_referencia_w, 
			nr_seq_restricao_w, 
			nr_seq_interno_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			ie_diluente_w	:= 'S';
		end loop;	
		close C01;
 
		if (ie_diluente_w = 'S') then 
			qt_dose_diluicao_w	:= qt_diluicao_w;
			qt_referencia_aux_w	:= qt_referencia_w;
			if (coalesce(qt_referencia_w,0) > 0) then 
				qt_referencia_w	:= obter_conversao_unid_med_cons(cd_diluente_w,cd_unid_med_diluente_w,qt_referencia_w);
			end if;
		 
			nr_sequencia_w	:= nr_seq_acum_w + 1;
 
			if (coalesce(qt_referencia_w,0) > 0) then 
				if (ie_proporcao_w = 'SC') then 
					qt_diluicao_w	:= qt_unitaria_medic_w * qt_referencia_w;
				elsif (ie_proporcao_w = 'ST') then 
					qt_diluicao_w		:= qt_unitaria_medic_w * qt_referencia_w;
					qt_dose_aux_w		:= obter_conversao_unid_med_cons(cd_material_w, cd_unidade_medida_dose_w, qt_dose_medic_w);
					--qt_referencia_aux_w	:= obter_conversao_unid_med_cons(cd_material_w, cd_unid_med_diluente_w, qt_referencia_aux_w); 
					qt_minuto_aplicacao_w	:= trunc(qt_minuto_aplicacao_w * qt_dose_aux_w);
				end if;
			end if;
			 
			select	substr(obter_dados_material_estab(cd_material,cd_estabelecimento_w,'UMS'),1,30) cd_unidade_medida_consumo 
			into STRICT	cd_unidade_medida_w 
			from	material 
			where	cd_material	= cd_diluente_w;
 
			select	coalesce(max(qt_conversao),1) 
			into STRICT	qt_conversao_w 
			from	material_conversao_unidade 
			where	cd_material		= cd_diluente_w 
			and		cd_unidade_medida	= cd_unid_med_diluente_w;
 
			Select	count(*) 
			into STRICT	Controle_w 
			from	prescr_material 
			where	nr_prescricao = nr_prescricao_p 
			and		ie_agrupador = 3 
			and		nr_sequencia_diluicao = nr_sequencia_p;
			 
			if (Controle_w = 0) then 
 
				if (qt_minuto_aplicacao_w > 0) then 
					if (qt_minuto_aplicacao_w < 60) then 
						qt_hora_aplicacao_w	:= null;
					elsif (qt_minuto_aplicacao_w = 60) then 
						qt_hora_aplicacao_w	:= 1;
						qt_minuto_aplicacao_w	:= null;
					else 
						qt_hora_aplicacao_w	:= trunc(dividir(qt_minuto_aplicacao_w,60));		
						qt_minuto_aplicacao_w	:= (qt_minuto_aplicacao_w - (qt_hora_aplicacao_w * 60));
					end if;
				end if;
				 
				if (qt_minuto_aplicacao_w = 0) then 
					qt_minuto_aplicacao_w	:= null;
				end if;
 
				/* Ivan em 10/07/2007 OS62199 - 
				Inclusão das restrições por bolus e lentamente para não desativar os dois campos ao mesmo tempo */
 
				update	prescr_material 
				set		qt_min_aplicacao	= qt_minuto_aplicacao_w, 
						qt_hora_aplicacao	= qt_hora_aplicacao_w 
				where	nr_prescricao		= nr_prescricao_p 
				and		nr_sequencia		= nr_sequencia_p 
				and		ie_aplic_bolus		= 'N' 
				and		ie_aplic_lenta		= 'N' 
				and		coalesce(qt_min_aplicacao::text, '') = '' 
				and		coalesce(qt_hora_aplicacao::text, '') = '';
				 
				if (coalesce(qt_referencia_w,0) > 0) and (ie_proporcao_w = 'ST') then 
					update	prescr_material 
					set		qt_min_aplicacao	= qt_minuto_aplicacao_w, 
							qt_hora_aplicacao	= qt_hora_aplicacao_w 
					where	nr_prescricao		= nr_prescricao_p 
					and		nr_sequencia		= nr_sequencia_p 
					and		ie_aplic_bolus		= 'N' 
					and		ie_aplic_lenta		= 'N';
				end if;
				 
				if (cd_unid_med_reconst_w IS NOT NULL AND cd_unid_med_reconst_w::text <> '') then 
					begin 
					ie_regra_disp_w := '';
					qt_dispensar_w 	:= 0;
					 
					select 	coalesce(max(ie_se_necessario),'N'), 
							coalesce(max(ie_acm),'N') 
					into STRICT	ie_se_necessario_w, 
							ie_acm_w 
					from 	prescr_material 
					where	nr_prescricao = nr_prescricao_p 
					and		nr_sequencia = nr_sequencia_p;
 
					SELECT * FROM obter_quant_dispensar(cd_estabelecimento_w, cd_material_w, nr_prescricao_p, nr_sequencia_p, cd_intervalo_w, ie_via_aplicacao_w, qt_unitaria_w, qt_dose_especial_w, nr_ocorrencia_w, ds_dose_diferenciada_w, '1', cd_unidade_medida_dose_w, qt_dias_util_w, qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w;
					 
					update	prescr_material 
					set		cd_unidade_medida	= cd_unid_med_reconst_w, 
							qt_material		= qt_material_w, 
							qt_total_dispensar	= qt_dispensar_w 
					where	nr_prescricao		= nr_prescricao_p 
					and		nr_sequencia		= nr_sequencia_p;				
					end;					
				end if;	
				 
				insert into prescr_material( 
					nr_prescricao, 
					nr_sequencia, 
					ie_origem_inf, 
					cd_material, 
					cd_unidade_medida, 
					cd_unidade_medida_dose, 
					qt_dose, 
					qt_solucao, 
					qt_unitaria, 
					qt_material, 
					dt_atualizacao, 
					nm_usuario, 
					cd_intervalo, 
					nr_agrupamento, 
					cd_motivo_baixa, 
					nr_sequencia_diluicao, 
					ie_agrupador, 
					qt_conversao_dose, 
					ie_utiliza_kit, 
					ie_urgencia, 
					ie_medicacao_paciente, 
					ie_suspenso, 
					ie_via_aplicacao, 
					ie_recons_diluente_fixo, 
					ie_sem_aprazamento, 
					nr_ocorrencia, 
					ie_cobra_paciente, 
					ie_regra_disp, 
					qt_ref_diluente, 
					nr_seq_mat_diluicao, 
					nr_sequencia_solucao) 
				values ( 
					nr_prescricao_p, 
					nr_sequencia_w, 
					'1', 
					cd_diluente_w, 
					cd_unidade_medida_w, 
					cd_unid_med_diluente_w, 
					qt_dose_diluicao_w, 
					qt_dose_diluicao_w, 
					dividir(qt_diluicao_w,qt_conversao_w), 
					qt_diluicao_w, 
					clock_timestamp(), 
					nm_usuario_w, 
					coalesce(cd_intervalo_cad_w,cd_intervalo_w), 
					0, 
					cd_motivo_baixa_w, 
					nr_sequencia_p, 
					4, 
					qt_conversao_w, 
					'N', 
					'N', 
					'N', 
					'N', 
					ie_via_aplicacao_w, 
					'N', 
					'N', 
					nr_ocorrencia_w, 
					ie_cobra_paciente_w, 
					CASE WHEN cd_motivo_baixa_w=0 THEN  null  ELSE 'D' END , 
					CASE WHEN ie_proporcao_w='SC' THEN qt_referencia_w WHEN ie_proporcao_w='ST' THEN  qt_referencia_w  ELSE null END , 
					nr_seq_interno_w, 
					nr_sequencia_solucao_p);
				 
				IF (ie_prescr_mat_sem_lib_w = 'S') THEN 
					CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_sequencia_w,cd_perfil_w,'N',nm_usuario_original_w,null);
				END IF;				
				 
				select 	coalesce(max(ie_se_necessario),'N'), 
						coalesce(max(ie_acm),'N') 
				into STRICT	ie_se_necessario_w, 
						ie_acm_w 
				from 	prescr_material 
				where	nr_prescricao = nr_prescricao_p 
				and		nr_sequencia = nr_sequencia_w;
					 
				SELECT * FROM Obter_Quant_Dispensar(1, cd_diluente_w, nr_prescricao_p, nr_sequencia_w, coalesce(cd_intervalo_cad_w,cd_intervalo_w), ie_via_aplicacao_w, dividir(qt_diluicao_w,qt_conversao_w), 0, nr_ocorrencia_w, ds_dose_diferenciada_w, '1', cd_unid_med_diluente_w, 1, qt_diluicao_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_diluicao_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w;
		 
				update	prescr_material 
				set		qt_total_dispensar 	= qt_dispensar_w 
				where 	nr_prescricao 		= nr_prescricao_p 
				and		nr_sequencia 		= nr_sequencia_w;
			elsif (ie_gera_dil_dose_w	= 'S') then 
				update	prescr_material 
				set		qt_dose		= qt_diluicao_w 
				where	nr_prescricao	= nr_prescricao_p 
				and		ie_agrupador	= 4 
				and		nr_sequencia_diluicao = nr_sequencia_p;
			end if;
		end if;
	end if;
	 
	/* inserir o rediluente*/
	 
	if (ie_gerar_diluicao_ww = 'S') then 
		 
		select	coalesce(max(nr_sequencia),0), 
			coalesce(max(nr_agrupamento),0) 
		into STRICT	nr_seq_acum_w, 
			nr_agrup_acum_w 
		from	prescr_material 
		where	nr_prescricao = NR_PRESCRICAO_P;
	 
		if (ie_via_aplicacao_w IS NOT NULL AND ie_via_aplicacao_w::text <> '') then 
			select	max(ie_gera_diluicao) 
			into STRICT	ie_gera_diluicao_w 
			from	via_aplicacao 
			where	ie_via_aplicacao = ie_via_aplicacao_w;
		end if;
 
		ie_diluente_w	:= 'N';
	 
		open C04;
		loop 
		fetch C04 into 
			cd_diluente_w, 
			qt_diluicao_w, 
			cd_unid_med_diluente_w, 
			ie_reconstituicao_w, 
			ie_via_aplic_order_w, 
			qt_minuto_aplicacao_w, 
			cd_intervalo_cad_w, 
			nr_seq_prioridade_w, 
			cd_setor_w, 
			qt_idade_min_w, 
			qt_idade_max_w, 
			cd_motivo_baixa_w, 
			ie_cobra_paciente_w, 
			ie_proporcao_w, 
			qt_referencia_w, 
			nr_seq_restricao_w, 
			qt_solucao_w;
		EXIT WHEN NOT FOUND; /* apply on C04 */
			ie_diluente_w	:= 'S';
		end loop;	
		close C04;
 
		if (ie_diluente_w = 'S') then		 
			qt_dose_diluicao_w	:= qt_diluicao_w;
			if (coalesce(qt_referencia_w,0) > 0) then 
				qt_referencia_w	:= obter_conversao_unid_med_cons(cd_diluente_w,cd_unid_med_diluente_w,qt_referencia_w);
			end if;
		 
			nr_sequencia_w	:= nr_seq_acum_w + 1;
 
			if (coalesce(qt_referencia_w,0) > 0) then 
				if (ie_proporcao_w = 'SC') then 
					qt_diluicao_w	:= qt_unitaria_medic_w * qt_referencia_w;
				elsif (ie_proporcao_w = 'ST') then 
					qt_diluicao_w		:= qt_unitaria_medic_w * qt_referencia_w;
					qt_minuto_aplicacao_w	:= qt_minuto_aplicacao_w * qt_referencia_w;
				end if;
			end if;
			 
			select	substr(obter_dados_material_estab(cd_material,cd_estabelecimento_w,'UMS'),1,30) cd_unidade_medida_consumo 
			into STRICT	cd_unidade_medida_w 
			from	material 
			where	cd_material	= cd_diluente_w;
 
			select	coalesce(max(qt_conversao),1) 
			into STRICT	qt_conversao_w 
			from	material_conversao_unidade 
			where	cd_material		= cd_diluente_w 
			and		cd_unidade_medida	= cd_unid_med_diluente_w;
 
			Select	count(*) 
			into STRICT	Controle_w 
			from	prescr_material 
			where	nr_prescricao = nr_prescricao_p 
			and		ie_agrupador = 7 
			and		nr_sequencia_diluicao = nr_sequencia_p;
			 
			if (Controle_w = 0) then 
 
				if (qt_minuto_aplicacao_w > 0) then 
					if (qt_minuto_aplicacao_w < 60) then 
						qt_hora_aplicacao_w	:= null;
					elsif (qt_minuto_aplicacao_w = 60) then 
						qt_hora_aplicacao_w	:= 1;
						qt_minuto_aplicacao_w	:= null;
					else 
						qt_hora_aplicacao_w	:= trunc(dividir(qt_minuto_aplicacao_w,60));		
						qt_minuto_aplicacao_w	:= (qt_minuto_aplicacao_w - (qt_hora_aplicacao_w * 60));
					end if;
				end if;
				 
				if (qt_minuto_aplicacao_w = 0) then 
					qt_minuto_aplicacao_w	:= null;
				end if;
 
				/* Ivan em 10/07/2007 OS62199 - 
	              Inclusão das restrições por bolus e lentamente para não desativar os dois campos ao mesmo tempo */
 
				update	prescr_material 
				set		qt_min_aplicacao	= qt_minuto_aplicacao_w, 
						qt_hora_aplicacao	= qt_hora_aplicacao_w 
				where	nr_prescricao		= nr_prescricao_p 
				and		nr_sequencia		= nr_sequencia_p 
				and		ie_aplic_bolus		= 'N' 
				and		ie_aplic_lenta		= 'N' 
				and		coalesce(qt_min_aplicacao::text, '') = '' 
				and		coalesce(qt_hora_aplicacao::text, '') = '';
				 
				if (coalesce(qt_referencia_w,0) > 0) and (ie_proporcao_w = 'ST') then 
					update	prescr_material 
					set		qt_min_aplicacao	= qt_minuto_aplicacao_w, 
							qt_hora_aplicacao	= qt_hora_aplicacao_w 
					where	nr_prescricao		= nr_prescricao_p 
					and		nr_sequencia		= nr_sequencia_p 
					and		ie_aplic_bolus		= 'N' 
					and		ie_aplic_lenta		= 'N';
				end if;
 
				insert into prescr_material( 
					nr_prescricao, 
					nr_sequencia, 
					ie_origem_inf, 
					cd_material, 
					cd_unidade_medida, 
					cd_unidade_medida_dose, 
					qt_dose, 
					qt_unitaria, 
					qt_material, 
					dt_atualizacao, 
					nm_usuario, 
					cd_intervalo, 
					nr_agrupamento, 
					cd_motivo_baixa, 
					nr_sequencia_diluicao, 
					ie_agrupador, 
					qt_conversao_dose, 
					ie_utiliza_kit, 
					ie_urgencia, 
					ie_medicacao_paciente, 
					ie_suspenso, 
					ie_via_aplicacao, 
					ie_recons_diluente_fixo, 
					ie_sem_aprazamento, 
					nr_ocorrencia, 
					ie_cobra_paciente, 
					ie_regra_disp, 
					qt_ref_diluente, 
					qt_solucao, 
					nr_sequencia_solucao) 
				values ( 
					nr_prescricao_p, 
					nr_sequencia_w, 
					'1', 
					cd_diluente_w, 
					cd_unidade_medida_w, 
					cd_unid_med_diluente_w, 
					qt_dose_diluicao_w, 
					dividir(qt_diluicao_w,qt_conversao_w), 
					qt_diluicao_w, 
					clock_timestamp(), 
					nm_usuario_w, 
					coalesce(cd_intervalo_cad_w,cd_intervalo_w), 
					0, 
					cd_motivo_baixa_w, 
					nr_sequencia_p, 
					4, 
					qt_conversao_w, 
					'N', 
					'N', 
					'N', 
					'N', 
					ie_via_aplicacao_w, 
					'N', 
					'N', 
					nr_ocorrencia_w, 
					ie_cobra_paciente_w, 
					CASE WHEN cd_motivo_baixa_w=0 THEN  null  ELSE 'D' END , 
					CASE WHEN ie_proporcao_w='SC' THEN qt_referencia_w WHEN ie_proporcao_w='ST' THEN  qt_referencia_w  ELSE null END , 
					qt_solucao_w, 
					nr_sequencia_solucao_p);
					 
					IF (ie_prescr_mat_sem_lib_w = 'S') THEN 
						CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_sequencia_w,cd_perfil_w,'N',nm_usuario_original_w,null);
					END IF;				
				select 	coalesce(max(ie_se_necessario),'N'), 
						coalesce(max(ie_acm),'N') 
				into STRICT	ie_se_necessario_w, 
						ie_acm_w 
				from 	prescr_material 
				where	nr_prescricao = nr_prescricao_p 
				and		nr_sequencia = nr_sequencia_w;
				 
				SELECT * FROM Obter_Quant_Dispensar(1, cd_diluente_w, nr_prescricao_p, nr_sequencia_w, coalesce(cd_intervalo_cad_w,cd_intervalo_w), ie_via_aplicacao_w, dividir(qt_diluicao_w,qt_conversao_w), 0, nr_ocorrencia_w, ds_dose_diferenciada_w, '1', cd_unid_med_diluente_w, 1, qt_diluicao_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_diluicao_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w;
		 
				update	prescr_material 
				set		qt_total_dispensar 	= qt_dispensar_w 
				where 	nr_prescricao 		= nr_prescricao_p 
				and		nr_sequencia 		= nr_sequencia_w;
			end if;
		end if;
	end if;
	 
end if;
 
CALL Ajustar_Dose_Diluente(nr_prescricao_p, nr_sequencia_p);
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_reconst_diluicao_sol ( nr_prescricao_p bigint, nr_sequencia_p bigint, nr_sequencia_solucao_p bigint, ie_opcao_p text) FROM PUBLIC;

