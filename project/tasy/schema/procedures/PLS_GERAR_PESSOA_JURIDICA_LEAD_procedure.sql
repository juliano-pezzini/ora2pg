-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_pessoa_juridica_lead ( nr_seq_solicitacao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, cd_cgc_p INOUT text, ds_erro_p INOUT text) AS $body$
DECLARE


nm_pessoa_fisica_w		pls_solicitacao_comercial.nm_pessoa_fisica%type;
cd_cep_w			pls_solicitacao_comercial.cd_cep%type;
ds_endereco_w			pls_solicitacao_comercial.ds_endereco%type;
nr_endereco_w			pls_solicitacao_comercial.nr_endereco%type;
ds_bairro_w			pls_solicitacao_comercial.ds_bairro%type;
ds_complemento_w		pls_solicitacao_comercial.ds_complemento%type;
ds_municipio_w			pls_solicitacao_comercial.cd_municipio_ibge%type;
ds_uf_w				pessoa_juridica.sg_estado%type;
nr_ddi_w			pls_solicitacao_comercial.nr_ddi%type;
nr_ddd_w			pls_solicitacao_comercial.nr_ddd%type;
nr_telefone_w			pls_solicitacao_comercial.nr_telefone%type;
cd_cgc_w			pls_solicitacao_comercial.cd_cgc%type;
nr_seq_cnae_w			pls_solicitacao_comercial.nr_seq_cnae%type;
cd_tipo_pessoa_w		tipo_pessoa_juridica.cd_tipo_pessoa%type;
nm_cidade_w			varchar(40);
qt_registros_w			bigint;
ds_erro_w			varchar(255);


BEGIN

select	nm_pessoa_fisica,
	cd_cep,
	ds_endereco,
	nr_endereco,
	substr(ds_bairro,1,40),
	ds_complemento,
	cd_municipio_ibge,
	sg_uf_municipio,
	nr_ddi,
	nr_ddd,
	nr_telefone,
	cd_cgc,
	nr_seq_cnae
into STRICT	nm_pessoa_fisica_w,
	cd_cep_w,
	ds_endereco_w,
	nr_endereco_w,
	ds_bairro_w,
	ds_complemento_w,
	ds_municipio_w,
	ds_uf_w,
	nr_ddi_w,
	nr_ddd_w,
	nr_telefone_w,
	cd_cgc_w,
	nr_seq_cnae_w
from	pls_solicitacao_comercial
where	nr_sequencia = nr_seq_solicitacao_p;


select	count(1)
into STRICT	qt_registros_w
from	pessoa_juridica
where	cd_cgc	= cd_cgc_w  LIMIT 1;

if (qt_registros_w > 0) then
	ds_erro_w := wheb_mensagem_pck.get_texto(215608);
	goto final;
end if;

if (coalesce(trim(both cd_cep_w)::text, '') = '') or (trim(both cd_cep_w) < 8) then
	ds_erro_w := wheb_mensagem_pck.get_texto(215609);
        goto final;
end if;

if (coalesce(trim(both ds_endereco_w)::text, '') = '') then
	ds_erro_w := wheb_mensagem_pck.get_texto(215610);
        goto final;
end if;

if (coalesce(trim(both ds_municipio_w)::text, '') = '') then
	ds_erro_w := wheb_mensagem_pck.get_texto(215611);
        goto final;
end if;

if (coalesce(trim(both ds_uf_w)::text, '') = '') then
	ds_erro_w := wheb_mensagem_pck.get_texto(215612);
        goto final;
end if;

nm_cidade_w	:= substr(obter_desc_municipio_ibge(ds_municipio_w),1,40);

select	max(cd_tipo_pessoa)
into STRICT	cd_tipo_pessoa_w
from	tipo_pessoa_juridica
where	ie_comercial_ops	in ('A','O')
and	ie_situacao		= 'A';

insert into pessoa_juridica(	cd_cgc, nm_usuario, dt_atualizacao, dt_atualizacao_nrec, nm_usuario_nrec,
		ds_razao_social, nm_fantasia,cd_cep, ds_endereco, ds_bairro,
		ds_municipio,cd_municipio_ibge, sg_estado,ds_complemento,nr_endereco,
		cd_tipo_pessoa, ie_prod_fabric,ie_situacao,ie_forma_revisao,ie_transporte,
		ie_fornecedor_opme,nr_ddi_telefone,nr_ddd_telefone,nr_telefone,nr_seq_cnae)
values (	cd_cgc_w, nm_usuario_p, clock_timestamp(),clock_timestamp(),nm_usuario_p,
		nm_pessoa_fisica_w, nm_pessoa_fisica_w,cd_cep_w, ds_endereco_w, ds_bairro_w,
		nm_cidade_w,ds_municipio_w,ds_uf_w,ds_complemento_w,nr_endereco_w,
		cd_tipo_pessoa_w,  'S','A','A','N',
		'N',nr_ddi_w,nr_ddd_w,nr_telefone_w,nr_seq_cnae_w);

<<final>>
cd_cgc_p	:= cd_cgc_w;
ds_erro_p	:= ds_erro_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_pessoa_juridica_lead ( nr_seq_solicitacao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, cd_cgc_p INOUT text, ds_erro_p INOUT text) FROM PUBLIC;

