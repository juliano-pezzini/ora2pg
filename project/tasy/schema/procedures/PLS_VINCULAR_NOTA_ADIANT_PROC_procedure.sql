-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_vincular_nota_adiant_proc (nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_nota_fiscal_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_nota_w		integer := 0;
nr_seq_conta_w		pls_conta.nr_sequencia%type;
nr_seq_analise_w	pls_analise_conta.nr_sequencia%type;
ds_observacao_w		pls_hist_analise_conta.ds_observacao%type;
vl_itens_w		double precision;
vl_item_w		pls_conta_proc.vl_procedimento_imp%type;
vl_nota_w		nota_fiscal.vl_total_nota%type;
vl_tributos_descontados_w double precision;


BEGIN

--Valor apresentado dos itens vinculados a nota n?o podem ser superior ao valor da nota. Pega-se o que j? esta vinculado + 

--o valor deste item que esta sendo vinculado nesse momento. Caso ultrapassar o valor da nota, ent?o aborta e alerta.
select 	coalesce(sum(vl_apres), 0)
into STRICT	vl_itens_w
from (	SELECT a.vl_procedimento_imp vl_apres
	from   pls_conta_proc a
	where  a.nr_seq_nota_fiscal = nr_seq_nota_fiscal_p
	
union all

	SELECT a.vl_material_imp vl_apres
	from   pls_conta_mat a
	where  a.nr_seq_nota_fiscal =nr_seq_nota_fiscal_p) alias2;
	
select 	vl_procedimento_imp
into STRICT	vl_item_w
from	pls_conta_proc a
where	a.nr_sequencia = nr_seq_conta_proc_p;

--Soma o valor dos itens que j? est?o vinculados a nota com o valor do item que esta sendo vinculado nesse momento
vl_itens_w := vl_itens_w + vl_item_w;

--Busca o valor da nota
select	a.vl_total_nota
into STRICT	vl_nota_w
from	nota_fiscal a
where	a.nr_sequencia = nr_seq_nota_fiscal_p;

--busca valor dos tributos descontados
select sum(a.vl_tributo)
into STRICT	vl_tributos_descontados_w
from	nota_fiscal_trib a,
	tributo b
where 	a.nr_sequencia = nr_seq_nota_fiscal_p
and	a.cd_tributo = b.cd_tributo
and 	b.ie_soma_diminui = 'D';

--Valor dos itens n?o pode ser maior que o valor da nota
if	( vl_itens_w >  ( vl_nota_w + vl_tributos_descontados_w)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(374811);
end if;

select 	count(1)
into STRICT	qt_nota_w
from	nota_fiscal_adiant_pago	y,
	nota_fiscal		n,
	pls_evento_movimento	w
where	w.nr_adiant_pago	= y.nr_adiantamento
and	n.nr_sequencia		= y.nr_sequencia_nf
and	(w.nr_seq_lote_pgto IS NOT NULL AND w.nr_seq_lote_pgto::text <> '')
and	coalesce(w.ie_cancelamento::text, '') = ''
and	n.nr_sequencia		= nr_seq_nota_fiscal_p;

if (qt_nota_w > 0) then
	-- N?o ? poss?vel vincular a nota selecionada, a nota de adiantamento esta em lote de pagamento de produ??o m?dica.
	CALL wheb_mensagem_pck.exibir_mensagem_abort(333195);
end if;

update	pls_conta_proc
set	nr_seq_nota_fiscal	= nr_seq_nota_fiscal_p
where	nr_sequencia		= nr_seq_conta_proc_p;

select	nr_seq_conta,
	nr_seq_analise
into STRICT	nr_seq_conta_w,
	nr_seq_analise_w
from	pls_conta_proc_v
where	nr_sequencia = nr_seq_conta_proc_p;

	/*Inserindo hist?rico, caso tiver an?lise*/

if (nr_seq_analise_w IS NOT NULL AND nr_seq_analise_w::text <> '') then

	ds_observacao_w := 'Item vinculado a nota fiscal de adiantamento com sequ?ncia ='||nr_seq_nota_fiscal_p;
	CALL pls_inserir_hist_analise(nr_seq_conta_w, nr_seq_analise_w, 15,
				 nr_seq_conta_proc_p, 'P', null,
				 null,ds_observacao_w, null,
				 nm_usuario_p,wheb_usuario_pck.get_cd_estabelecimento);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_vincular_nota_adiant_proc (nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_nota_fiscal_p bigint, nm_usuario_p text) FROM PUBLIC;

