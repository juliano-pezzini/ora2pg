-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_kit_rec_prescricao ( cd_estabelecimento_p bigint, nr_Prescricao_p bigint, nr_seq_item_p bigint, nm_usuario_p text, ie_diluicao_p text default 'N', ie_manual_p text default 'N') AS $body$
DECLARE


nr_sequencia_w			bigint;
nr_seq_mat_med_w			bigint;
cd_recomendacao_w		bigint;
nr_ocorrencia_w			bigint;
nr_agrupamento_w			double precision;
nr_agrup_w			double precision;
nr_agrup_prescr_w			double precision;
cd_material_w			bigint;
cd_material_ant_w			bigint;
cd_material_kit_w			bigint;
nr_seq_recomendacao_w		bigint;
qt_material_kit_w			double precision;
qt_material_w			double precision;
nr_hora_ult_prescr_w		bigint;
qt_dose_min_w			double precision;
qt_dose_max_w			double precision;
nr_atendimento_w			bigint;
nr_horas_validade_kit_w		bigint;
ie_origem_inf_w			varchar(1)	:= 'K';
cd_unidade_medida_w		varchar(30);
cd_unid_med_dose_w		varchar(30);
ie_permite_alterar_w		varchar(7);
cd_intervalo_w			varchar(7);
ie_registra_w			varchar(7);
ie_gerar_kit_setor_w		varchar(1);
ie_urgencia_w			varchar(1);
ie_check_tipo_interv_w	varchar(1);
ie_bomba_infusao_w		varchar(1);
ie_suspenso_w			varchar(1)	:= 'N';
ie_se_necessario_w		varchar(1)	:= 'N';
ie_medicacao_paciente_w		varchar(1)	:= 'N';
nr_seq_proc_w			integer;
cd_kit_rec_w			bigint;
nr_seq_agrupamento_w		bigint;
ie_agrupador_w			smallint;
cd_recem_nato_w			varchar(10);
ie_recem_nato_w			varchar(1);
ie_agrupador_dil_w			smallint;
cd_classe_material_w		integer;
cd_grupo_material_w		smallint;
cd_subgrupo_w			smallint;
ie_considera_w			varchar(1);
ie_duplica_prescr_w		varchar(5);
ie_maior_volume_w			varchar(1);
ds_nao_gera_kit_w			varchar(255);	--Ivan em 10/05/2007 OS54814
ie_acm_w			varchar(1);
qt_dose_especial_w		double precision;   --Ivan em 28/08/2007 OS66990
hr_dose_especial_w		varchar(5);    --Ivan em 28/08/2007 OS66990
cd_material_disp_w			integer;
cd_intervalo_disp_w		varchar(7);
ie_via_aplicacao_disp_w		varchar(5);
qt_unitaria_disp_w			double precision;
qt_material_disp_w			double precision;
qt_dose_especial_disp_w		double precision;
nr_ocorrencia_disp_w		double precision;
ds_dose_diferenciada_disp_w		varchar(50);
ie_origem_inf_disp_w		varchar(1);
cd_unidade_medida_dose_disp_w	varchar(30);
qt_dias_util_disp_w			smallint;
qt_total_dispensar_w		double precision;
ds_erro_disp_w			varchar(2000);
qt_unitaria_w			double precision;
qt_unitaria_dil_w			double precision;
qt_dose_w			double precision;
cd_kit_w				bigint;
nr_seq_via_acesso_w		bigint;
ie_via_aplicacao_w			varchar(05);
ie_via_aplicacao_ww		varchar(5);
qt_volume_w			double precision;
qt_conv_dose_ml_w		double precision;
qt_volume_diluente_w		double precision;
qt_volume_reconstituinte_w		double precision;
cd_material_dil_w			bigint;
qt_dose_dil_w			double precision;
cd_unidade_medida_dose_dil_w	varchar(30);
ds_horarios_w			varchar(2000);
ie_agrupador_ww			smallint;
nr_sequencia_solucao_w		integer;
cd_setor_atendimento_w		integer;
k				integer;
y				integer;
qt_idade_w			integer;
ie_sexo_paciente_w		varchar(1);
ie_gerar_todos_kits_w		varchar(2);
cd_kit_rec_ww				varchar(2000);
cd_kit_rec_www				varchar(2000);

/* Rafael em 08/11/2007 OS73502 variaveis kit */

cd_intervalo_kit_w			varchar(7);
ds_horarios_kit_w			varchar(2000);
ds_horarios_kit_ww			varchar(2000);
hr_prim_horario_w			varchar(5);
cd_estabelecimento_w		smallint;
dt_prescricao_w			timestamp;
dt_prescr_w			timestamp;
dt_primeiro_horario_w		timestamp;
nr_horas_validade_w		integer;
nr_intervalo_w			bigint;
ie_utiliza_cobra_kit_w		varchar(01);
ie_entra_conta_w			varchar(01);
ie_regra_disp_w			varchar(1);/* Rafael em 15/38 OS86206 */
cd_convenio_w			integer;/* Fabricio em 27/05 */
ie_tipo_convenio_w		smallint;
qt_hora_intervalo_w		smallint;
qt_min_intervalo_w			integer;
ie_tipo_atendimento_w		smallint;

qt_idade_paciente_w     		integer;	/*David em 22/07/2008 OS 101425*/
cd_mat_sem_apresent_w		integer;
cd_mat_sem_apresent_ant_w		integer;
qt_dose_medic_w			double precision;
cd_motivo_baixa_w			smallint;
cd_motivo_baixa_ww		smallint;
qt_hora_aplicacao_w		smallint;
qt_min_aplicacao_w		smallint;
nr_seq_atend_medic_w		bigint;
cd_kit_material_w			bigint;
nr_seq_sol_w			bigint;
dt_liberacao_farmacia_w		timestamp;
ie_gerou_kit_w			varchar(1);
ie_item_superior_w			varchar(1);

qt_volume_aux_w			double precision;
ie_via_aplicacao_aux_w		varchar(5);
cd_unidade_medida_aux_w		varchar(40);
cd_setor_atendimento_aux_w		integer;
cd_setor_excluir_aux_w		integer;
ie_recem_nato_ww			varchar(1);
ie_necessita_disp_kit_w		varchar(1);
ie_prescr_mat_sem_lib_w		varchar(255);
ie_ja_existe_w			varchar(1);
qt_peso_w			real;
NR_SEQ_PE_PROC_w	bigint;
ie_check_sn_inter_w			varchar(1);
cd_fornecedor_w			componente_kit.cd_fornecedor%type;
dt_parametro_w		timestamp;

C01 CURSOR FOR
SELECT	nr_agrup_prescr_w + 1,
	'N' ie_urgencia,
	(null)::numeric  cd_material,
	coalesce(a.nr_ocorrencia,1),
	a.cd_intervalo,
	'N' ie_se_necessario,
	coalesce(a.qt_recomendacao,1) qt_unitaria,
	coalesce(a.qt_recomendacao,1) qt_dose,
	null ie_via_aplicacao,
	null cd_unidade_medida,
	null cd_unidade_medida_dose,
	a.nr_sequencia,
	a.ds_horarios,
	(null)::numeric  ie_agrupador,
	(null)::numeric  nr_sequencia_solucao,
	'N' ie_acm,
	(null)::numeric  qt_dose_especial,
	null hr_dose_especial,
	null qt_hora_intervalo,
	null qt_min_intervalo,
	obter_idade_pf(x.cd_pessoa_fisica, clock_timestamp(), 'A') qt_idade,
	(null)::numeric  cd_mat_sem_apresent,
	(null)::numeric  nr_seq_via_acesso,
	(null)::numeric  qt_hora_aplicacao,
	(null)::numeric  qt_min_aplicacao,
	(null)::numeric  nr_agrupamento,
	(null)::numeric  nr_seq_atend_medic,
	null ie_item_superior,
	a.cd_recomendacao,
	(null)::numeric  nr_seq_sol,
	null ie_bomba_infusao,
	a.cd_kit cd_kit_rec,
	null,
	a.hr_prim_horario,
	null
from	prescr_recomendacao a,
	prescr_medica x
where	x.nr_prescricao		= nr_prescricao_p
and	a.nr_sequencia		= nr_seq_item_p
and	x.nr_prescricao		= a.nr_prescricao
and	coalesce(a.ie_kit_gerado, 'N') = 'N'

union

SELECT	nr_agrup_prescr_w + 1,
	'N' ie_urgencia,
	(null)::numeric  cd_material,
	coalesce(a.nr_ocorrencia,1),
	a.cd_intervalo,
	'N' ie_se_necessario,
	coalesce(a.qt_recomendacao,1) qt_unitaria,
	coalesce(a.qt_recomendacao,1) qt_dose,
	null ie_via_aplicacao,
	null cd_unidade_medida,
	null cd_unidade_medida_dose,
	a.nr_sequencia,
	a.ds_horarios,
	(null)::numeric  ie_agrupador,
	(null)::numeric  nr_sequencia_solucao,
	'N' ie_acm,
	(null)::numeric  qt_dose_especial,
	null hr_dose_especial,
	null qt_hora_intervalo,
	null qt_min_intervalo,
	obter_idade_pf(x.cd_pessoa_fisica, clock_timestamp(), 'A') qt_idade,
	(null)::numeric  cd_mat_sem_apresent,
	(null)::numeric  nr_seq_via_acesso,
	(null)::numeric  qt_hora_aplicacao,
	(null)::numeric  qt_min_aplicacao,
	(null)::numeric  nr_agrupamento,
	(null)::numeric  nr_seq_atend_medic,
	null ie_item_superior,
	a.cd_recomendacao,
	(null)::numeric  nr_seq_sol,
	null ie_bomba_infusao,
	coalesce(a.cd_kit,z.cd_kit) cd_kit_rec,
	null,
	a.hr_prim_horario,
	null
from	kit_prescr_recomendacao z,
	prescr_recomendacao a,
	prescr_medica x
where	x.nr_prescricao		= nr_prescricao_p
and	z.nr_prescricao		= a.nr_prescricao
and	a.nr_sequencia		= nr_seq_item_p
and	((a.nr_sequencia = z.nr_seq_recomendacao) or (z.cd_recomendacao = a.cd_recomendacao))
and	x.nr_prescricao		= a.nr_prescricao
and	coalesce(x.dt_suspensao::text, '') = ''
and	coalesce(a.ie_suspenso,'N')	= 'N'
and	coalesce(a.ie_kit_gerado,'N') = 'N'
order by ie_agrupador, /* ATENCAO:  MUITO CUIDADO AO ALTERAR ESTE ORDER BY !!!!!  Daniel Dalcastagne em 21/12/2009 */
	nr_agrupamento,
	ie_item_superior,
	nr_seq_sol,
	nr_sequencia;

C04 CURSOR FOR
	SELECT	a.cd_material,
		a.qt_dose,
		a.cd_unidade_medida_dose,
		a.qt_unitaria,
		Obter_estrutura_material(a.cd_material,'C'),
		Obter_estrutura_material(a.cd_material,'G'),
		Obter_estrutura_material(a.cd_material,'S'),
		a.ie_agrupador
	from	material b,
		prescr_material a
	where	a.nr_prescricao	= nr_prescricao_p
	and	a.cd_material   = b.cd_material
	and	a.nr_sequencia_diluicao = nr_seq_mat_med_w
	and	a.ie_agrupador in (3,7,9);

C02 CURSOR FOR
	SELECT	cd_kit,
		(null)::numeric  qt_volume,
		null ie_via_aplicacao,
		null cd_unidade_medida,
		(null)::numeric  cd_setor_atendimento,
		(null)::numeric  cd_setor_excluir,
		0,
		(null)::numeric  qt_dose_min,
		(null)::numeric  qt_dose_max
	from	kit_mat_recomendacao
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	cd_recomendacao		= cd_recomendacao_w
	and	coalesce(cd_perfil, obter_perfil_ativo) = obter_perfil_ativo
	and	coalesce(cd_setor_atendimento, cd_setor_atendimento_w) = cd_setor_atendimento_w
	and	((coalesce(nr_seq_agrupamento::text, '') = '') or (nr_seq_agrupamento = nr_seq_agrupamento_w))
	and	coalesce(ie_gerar_kit_setor_w,'S')	= 'S'
	and	((coalesce(cd_convenio::text, '') = '') or (cd_convenio = cd_convenio_w))
	and	cd_kit = cd_kit_rec_w
	and	Obter_se_gera_kit_rec_setor(nr_sequencia,cd_setor_atendimento_w) = 'S'
	
union

	SELECT a.cd_kit,
		(null)::numeric  qt_volume,
		null ie_via_aplicacao,
		null cd_unidade_medida,
		(null)::numeric  cd_setor_atendimento,
		(null)::numeric  cd_setor_excluir,
		0,
		(null)::numeric  qt_dose_min,
		(null)::numeric  qt_dose_max
	from  kit_prescr_recomendacao a,
		  prescr_recomendacao b
	where a.nr_prescricao 	= nr_prescricao_p
	and	  a.nr_prescricao	= b.nr_prescricao
	and	  ((a.nr_seq_recomendacao = nr_seq_item_p) or (a.cd_recomendacao = b.cd_recomendacao))
	and	  obter_se_valor_contido(a.cd_kit, coalesce(cd_kit_rec_www, cd_kit_rec_w)) = 'S'
	and	  coalesce(b.ie_kit_gerado, 'N') = 'N'
	order by qt_dose_min desc,
		 qt_dose_max desc,
		 qt_volume desc,
		 ie_via_aplicacao,
		 cd_unidade_medida desc,
		 cd_setor_atendimento,
		 cd_setor_excluir;

C03 CURSOR FOR
	SELECT	c.cd_material,
		CASE WHEN coalesce(c.ie_multiplica_dose,'N')='S' THEN CASE WHEN Obter_qtde_mat_kit_modif(nr_prescricao_p, nr_seq_mat_med_w, cd_recomendacao_w, c.cd_material, cd_kit_w, null)=0 THEN  c.qt_material  ELSE PERFORM Obter_qtde_mat_kit_modif(nr_prescricao_p, nr_seq_mat_med_w, cd_recomendacao_w, c.cd_material, cd_kit_w, null) END  * qt_unitaria_w  ELSE CASE WHEN Obter_qtde_mat_kit_modif(nr_prescricao_p, nr_seq_mat_med_w, cd_recomendacao_w, c.cd_material, cd_kit_w, null)=0 THEN  c.qt_material  ELSE PERFORM Obter_qtde_mat_kit_modif(nr_prescricao_p, nr_seq_mat_med_w, cd_recomendacao_w, c.cd_material, cd_kit_w, null) END  END ,
		coalesce(c.cd_unidade_medida_prescr, substr(obter_dados_material_estab(c.cd_material,cd_estabelecimento_p,'UMS'),1,30)),
		OBTER_CLASSIF_MATERIAL_PROCED(c.cd_material,null,null) ie_agrupador,
		c.cd_intervalo,
		c.ie_entra_conta,
		coalesce(c.ie_duplica_prescr,'S'),
		coalesce(c.cd_motivo_baixa,0),
		a.cd_kit_material,
		c.ie_permite_alterar,
		c.ie_via_aplicacao,
		c.cd_fornecedor
	from	material d,
		componente_kit c,
		kit_material a
	where	a.cd_kit_material	= cd_kit_w
	and	a.cd_kit_material	= c.cd_kit_material
	and	a.ie_situacao		= 'A'
	and	c.ie_situacao		= 'A'
	and	d.ie_situacao		= 'A'
	and	Obter_se_exclui_item_kit(nr_prescricao_p, nr_seq_mat_med_w, cd_recomendacao_w, c.cd_material, a.cd_kit_material,null) <> 'S'
	and	c.cd_material     	= d.cd_material
	and	((coalesce(c.cd_estab_regra::text, '') = '') or (c.cd_estab_regra = cd_estabelecimento_p))
	/*and	not exists (	select	1
				from	prescr_material x
				where	x.nr_prescricao = nr_prescricao_p
				and	x.cd_material = c.cd_material
				and	x.cd_kit_material = c.cd_kit_material)*/
	and	((coalesce(c.ie_via_aplicacao::text, '') = '') or (coalesce(ie_via_aplicacao_w, c.ie_via_aplicacao) = c.ie_via_aplicacao))
	and	(cd_kit_w IS NOT NULL AND cd_kit_w::text <> '')
	and 	coalesce(c.cd_convenio,0) = 	(SELECT coalesce(max(x.cd_convenio), 0)
					from	componente_kit x
					where	x.cd_kit_material = c.cd_kit_material
					and	x.cd_material	  = c.cd_material
					and	x.cd_convenio     = cd_convenio_w
					and	((coalesce(x.cd_estab_regra::text, '') = '') or (x.cd_estab_regra = cd_estabelecimento_p)))
	and 	coalesce(c.ie_tipo_convenio,0) = 	(select coalesce(max(x.ie_tipo_convenio), 0)
					from	componente_kit x
					where	x.cd_kit_material = c.cd_kit_material
					and	x.cd_material	  = c.cd_material
					and	x.ie_tipo_convenio     = ie_tipo_convenio_w
					and	((coalesce(x.cd_estab_regra::text, '') = '') or (x.cd_estab_regra = cd_estabelecimento_p)))
	and	coalesce(c.ie_sexo, coalesce(ie_sexo_paciente_w,0)) = coalesce(ie_sexo_paciente_w,0)
	and	((c.ie_recem_nato =  coalesce(ie_recem_nato_ww, 'A')) or (coalesce(c.ie_recem_nato, 'A') = 'A'))
	and (qt_idade_paciente_w between coalesce(c.qt_idade_minima,-1) and coalesce(c.qt_idade_maxima,999))
	and	((coalesce(c.qt_peso_min::text, '') = '' and coalesce(c.qt_peso_max::text, '') = '') or (qt_peso_w between coalesce(c.qt_peso_min,-1) and coalesce(c.qt_peso_max,999)))
	and	coalesce(c.cd_setor_atendimento, cd_setor_atendimento_w) = cd_setor_atendimento_w;

C05 CURSOR FOR
	SELECT	coalesce(ie_considera,'N'),
		coalesce(ie_maior_volume,'N')
	from	regra_vol_diluente
	where (cd_grupo_material	= cd_grupo_material_w	or coalesce(cd_grupo_material::text, '') = '')
	and (cd_subgrupo_material	= cd_subgrupo_w		or coalesce(cd_subgrupo_material::text, '') = '')
	and (cd_classe_material	= cd_classe_material_w	or coalesce(cd_classe_material::text, '') = '')
	and (cd_material		= cd_material_dil_w	or coalesce(cd_material::text, '') = '')
	order by cd_material,
		cd_classe_material,
		cd_subgrupo_material,
		cd_grupo_material;

C06 CURSOR FOR
	SELECT 	distinct cd_kit
	from 	kit_prescr_recomendacao
	where 	nr_prescricao 	= nr_prescricao_p
	and 	cd_recomendacao = cd_recomendacao_w;


BEGIN

select	max(obter_valor_param_usuario(924, 194, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p))
into STRICT	cd_motivo_baixa_ww
;

select	coalesce(max(IE_COBRA_KIT_PRESCR), 'N')
into STRICT	ie_utiliza_cobra_kit_w
from	parametro_faturamento
where	cd_estabelecimento	= cd_estabelecimento_p;

ds_nao_gera_kit_w 	:= obter_valor_param_usuario(924, 149, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p); --Ivan em 10/05/2007 OS54814
ie_prescr_mat_sem_lib_w := obter_valor_param_usuario(924, 530, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p);
ie_check_tipo_interv_w	:= obter_valor_param_usuario(924, 809, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p);
ie_check_sn_inter_w	:= obter_valor_param_usuario(924, 650, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p);

select	max(nr_agrupamento)
into STRICT	nr_agrup_prescr_w
from	prescr_material
where	nr_prescricao	= nr_prescricao_p;

select	coalesce(max(cd_setor_atendimento), 0),
	coalesce(max(obter_convenio_atendimento(nr_atendimento)),0),
	max(obter_tipo_atendimento(nr_atendimento)),
	max(dt_liberacao_farmacia),
	coalesce(max(ie_gerou_kit),'N'),
	max(cd_recem_nato),
	coalesce(max(ie_recem_nato),'N'),
	coalesce(max(ie_recem_nato), 'A'),
	max(qt_peso)
into STRICT	cd_setor_atendimento_w,
	cd_convenio_w,
	ie_tipo_atendimento_w,
	dt_liberacao_farmacia_w,
	ie_gerou_kit_w,
	cd_recem_nato_w,
	ie_recem_nato_w,
	ie_recem_nato_ww,
	qt_peso_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

if (cd_convenio_w > 0)then
	select	ie_tipo_convenio
	into STRICT	ie_tipo_convenio_w
	from	convenio
	where	cd_convenio = cd_convenio_w;
end if;

select	coalesce(max(ie_gerar_kit),'S'),
	max(nr_seq_agrupamento)
into STRICT	ie_gerar_kit_setor_w,
	nr_seq_agrupamento_w
from	setor_atendimento
where	cd_setor_atendimento	= cd_setor_atendimento_w;

if (coalesce(nr_seq_item_p,0)	> 0) then
	select	max(dt_lib_farmacia)
	into STRICT	dt_liberacao_farmacia_w
	from	prescr_material
	where	nr_prescricao	= nr_prescricao_p
	and	nr_sequencia	= nr_seq_item_p;
end if;

/* Rafael em 08/11/2007 OS73502 x kit */

select	max(cd_estabelecimento),
	max(dt_prescricao),
	max(dt_primeiro_horario),
	max(nr_horas_validade),
	coalesce(max(obter_idade_pf(cd_pessoa_fisica,clock_timestamp(),'A')),0),
	max(substr(obter_sexo_pf(cd_pessoa_fisica, 'C'),1,1)),
	max(nr_atendimento)
into STRICT	cd_estabelecimento_w,
	dt_prescricao_w,
	dt_primeiro_horario_w,
	nr_horas_validade_w,
	qt_idade_paciente_w,
	ie_sexo_paciente_w,
	nr_atendimento_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

select	coalesce(max(ie_gerar_kit),'N')
into STRICT	ie_gerar_todos_kits_w
from	parametro_atendimento;

OPEN C01;
LOOP
FETCH C01 into
	nr_agrupamento_w,
	ie_urgencia_w,
	cd_material_w,
	nr_ocorrencia_w,
	cd_intervalo_w,
	ie_se_necessario_w,
	qt_unitaria_w,
	qt_dose_w,
	ie_via_aplicacao_w,
	cd_unidade_medida_w,
	cd_unid_med_dose_w,
	nr_seq_mat_med_w,
	ds_horarios_w,
	ie_agrupador_ww,
	nr_sequencia_solucao_w,
	ie_acm_w,
	qt_dose_especial_w,
	hr_dose_especial_w,
	qt_hora_intervalo_w,
	qt_min_intervalo_w,
	qt_idade_w,
	cd_mat_sem_apresent_w,
	nr_seq_via_acesso_w,
	qt_hora_aplicacao_w,
	qt_min_aplicacao_w,
	nr_agrup_w,
	nr_seq_atend_medic_w,
	ie_item_superior_w,
	cd_recomendacao_w,
	nr_seq_sol_w,
	ie_bomba_infusao_w,
	cd_kit_rec_w,
	ie_necessita_disp_kit_w,
	hr_prim_horario_w,
	NR_SEQ_PE_PROC_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	open C06;
	loop
	fetch C06 into
			cd_kit_rec_ww;
		EXIT WHEN NOT FOUND; /* apply on C06 */
			begin

			if (cd_kit_rec_ww IS NOT NULL AND cd_kit_rec_ww::text <> '') then
				cd_kit_rec_www := cd_kit_rec_www || cd_kit_rec_ww || ',';
			end if;


			end;
		end loop;
		close C06;

	if (cd_recem_nato_w IS NOT NULL AND cd_recem_nato_w::text <> '') and (ie_recem_nato_w = 'S') then
		select	max(obter_idade_pf(cd_recem_nato_w, clock_timestamp(), 'A'))
		into STRICT	qt_idade_w
		;
	end if;

	if (ie_agrupador_ww = 4) and (nr_sequencia_solucao_w IS NOT NULL AND nr_sequencia_solucao_w::text <> '') then
		begin
		select	max(elimina_acentuacao(ds_horarios)) /* Rafael em 03/03/2007 OS49577 inclui tratamento referente ao elimina acentuacao */
		into STRICT	ds_horarios_w
		from	prescr_solucao
		where	nr_prescricao	= nr_prescricao_p
		and	nr_seq_solucao	= nr_sequencia_solucao_w;

		while	position(' as' in ds_horarios_w) > 0 loop
			k	:= position(' as' in ds_horarios_w);
			y	:= position(';' in ds_horarios_w);
			if (y > 0) then
				ds_horarios_w	:= substr(substr(ds_horarios_w,1,k-1) ||substr(ds_horarios_w,y+1,length(ds_horarios_w)),1,2000);
			else
				ds_horarios_w	:= substr(substr(ds_horarios_w,1,k-1),1,2000);
			end if;
		end loop;

		select	replace(padroniza_horario(ds_horarios_w),'A','')
		into STRICT	ds_horarios_w
		;
		end;
	end if;

	if (coalesce(cd_mat_sem_apresent_w::text, '') = '') or (cd_mat_sem_apresent_w <> coalesce(cd_mat_sem_apresent_ant_w,0)) then

		cd_mat_sem_apresent_ant_w	:= cd_mat_sem_apresent_w;
		cd_material_w			:= coalesce(cd_mat_sem_apresent_w, cd_material_w);

		if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') then
			qt_volume_w	:= obter_conversao_ml(cd_material_w,qt_dose_w,cd_unid_med_dose_w);
		end if;

		ie_considera_w			:= 'N';
		ie_maior_volume_w		:= 'N';
		qt_volume_reconstituinte_w	:= 0;
		qt_volume_diluente_w		:= 0;

		OPEN C04;
		LOOP
		FETCH C04 into
			cd_material_dil_w,
			qt_dose_dil_w,
			cd_unidade_medida_dose_dil_w,
			qt_unitaria_dil_w,
			cd_classe_material_w,
			cd_grupo_material_w,
			cd_subgrupo_w,
			ie_agrupador_dil_w;
		EXIT WHEN NOT FOUND; /* apply on c04 */

			ie_considera_w	:= 'N';
			OPEN C05;
			LOOP
			FETCH C05 into
				ie_considera_w,
				ie_maior_volume_w;
			EXIT WHEN NOT FOUND; /* apply on c05 */
			begin
			ie_considera_w	:= ie_considera_w;
			end;
			END LOOP;
			CLOSE C05;

			if (ie_agrupador_dil_w = 9) then
				qt_volume_reconstituinte_w	:= obter_conversao_ml(cd_material_dil_w,qt_dose_dil_w,cd_unidade_medida_dose_dil_w);
			else
				qt_volume_diluente_w		:= qt_volume_diluente_w + obter_conversao_ml(cd_material_dil_w,qt_dose_dil_w,cd_unidade_medida_dose_dil_w);
			end if;

		END LOOP;
		CLOSE C04;

		if (cd_mat_sem_apresent_w IS NOT NULL AND cd_mat_sem_apresent_w::text <> '') then
			select	sum(qt_dose)
			into STRICT	qt_dose_medic_w
			from	prescr_material
			where	nr_prescricao		= nr_prescricao_p
			and	cd_mat_sem_apresent	= cd_mat_sem_apresent_w;
		end if;

		if (ie_maior_volume_w = 'S') and (qt_volume_w < qt_volume_reconstituinte_w) then
			qt_volume_w	:= qt_volume_reconstituinte_w;
		end if;

		if (ie_considera_w = 'S') then
			qt_volume_w	:= qt_volume_w + qt_volume_diluente_w;
		elsif (ie_considera_w = 'D') then
			qt_volume_w	:= qt_volume_diluente_w;
		end if;

		if (ie_gerar_todos_kits_w = 'N') then
			cd_kit_w		:= null;

			open c02;
			loop
			fetch c02 into
				cd_kit_w,
				qt_volume_aux_w,
				ie_via_aplicacao_aux_w,
				cd_unidade_medida_aux_w,
				cd_setor_atendimento_aux_w,
				cd_setor_excluir_aux_w,
				nr_horas_validade_kit_w,
				qt_dose_min_w,
				qt_dose_max_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				cd_kit_w	:= cd_kit_w;

				if (nr_horas_validade_kit_w	> 0) then
					select	max(a.dt_prescricao)
					into STRICT	dt_prescr_w
					from	prescr_medica a,
						prescr_material b
					where	a.nr_prescricao	= b.nr_prescricao
					and	a.nr_atendimento = nr_atendimento_w
					and	coalesce(a.dt_suspensao::text, '') = ''
					and	coalesce(b.dt_suspensao::text, '') = ''
					and	b.cd_kit_material = cd_kit_w;

					if (dt_prescr_w IS NOT NULL AND dt_prescr_w::text <> '') then
						nr_hora_ult_prescr_w	:= obter_hora_entre_datas(dt_prescr_w, dt_prescricao_w);
						if (nr_hora_ult_prescr_w	< nr_horas_validade_kit_w) then
							cd_kit_w		:= null;
						end if;
					end if;
				end if;

			end loop;
			close c02;


			OPEN C03;
			LOOP
			FETCH C03 into
				cd_material_kit_w,
				qt_material_kit_w,
				cd_unidade_medida_w,
				ie_agrupador_w,
				cd_intervalo_kit_w,
				ie_entra_conta_w,
				ie_duplica_prescr_w,
				cd_motivo_baixa_w,
				cd_kit_material_w,
				ie_permite_alterar_w,
				ie_via_aplicacao_ww,
				cd_fornecedor_w;
			EXIT WHEN NOT FOUND; /* apply on c03 */

				if (ie_duplica_prescr_w	= 'N') then
					select	coalesce(max('N'),'S')
					into STRICT	ie_registra_w
					from	prescr_material
					where	cd_material	= cd_material_kit_w
					and	nr_prescricao	= nr_prescricao_p
					and	coalesce(ie_duplica_prescr_w,'S') = 'N';

				elsif (ie_duplica_prescr_w	= 'C') then
					if (ie_item_superior_w	= 'S') then
						ie_registra_w	:= 'S';
					else
						select	coalesce(max('N'),'S')
						into STRICT	ie_registra_w
						from	prescr_material
						where	cd_material	= cd_material_kit_w
						and	nr_prescricao	= nr_prescricao_p
						and	coalesce(ie_duplica_prescr_w,'S') = 'C'
						and	nr_seq_kit in ( SELECT	nr_sequencia
									  from		prescr_material
									  where		nr_prescricao	= nr_prescricao_p
									  and		ie_agrupador	= ie_agrupador_ww
									  and		nr_agrupamento	= nr_agrup_w);
					end if;
				elsif (ie_duplica_prescr_w	= 'D') then
					select	coalesce(max('N'),'S')
					into STRICT	ie_registra_w
					from	prescr_material
					where	cd_material	= cd_material_kit_w
					and	nr_prescricao	= nr_prescricao_p
					and	coalesce(ie_duplica_prescr_w,'S') = 'D'
					and	cd_kit_material	= cd_kit_material_w
					and	nr_seq_kit in ( SELECT	nr_sequencia
								  from		prescr_material
								  where		nr_prescricao	= nr_prescricao_p
								  and		ie_agrupador	= ie_agrupador_ww
								  and		nr_agrupamento	= nr_agrup_w);
				elsif (ie_duplica_prescr_w	= 'E') then
					select	coalesce(max('N'),'S')
					into STRICT	ie_registra_w
					from	prescr_material
					where	cd_material	= cd_material_kit_w
					and		nr_prescricao	= nr_prescricao_p
					and		coalesce(ie_duplica_prescr_w,'S') = 'E'
					and		cd_kit_material	= cd_kit_material_w;
				elsif (ie_duplica_prescr_w	= 'L') then
					if (ie_agrupador_ww		<> 4) then
						ie_registra_w	:= 'S';
					else
						select	coalesce(max('N'),'S')
						into STRICT	ie_registra_w
						from	prescr_material
						where	cd_material			= cd_material_kit_w
						and	nr_prescricao			= nr_prescricao_p
						and	nr_seq_kit 			in (	SELECT	nr_sequencia
												from	prescr_material
												where	nr_prescricao		= nr_prescricao_p
												and	ie_agrupador		= 4
												and	nr_sequencia_solucao	= nr_sequencia_solucao_w);
					end if;
				else
					ie_registra_w	:= 'S';
				end if;


				if (coalesce(cd_intervalo_kit_w::text, '') = '') or (cd_intervalo_kit_w = '') then
					cd_intervalo_kit_w := cd_intervalo_w;
				end if;

				select	coalesce(max('S'),'N')
				into STRICT	ie_ja_existe_w
				from	prescr_material
				where	nr_seq_recomendacao = nr_seq_mat_med_w
				and		nr_prescricao = nr_prescricao_p
				and		cd_kit_material	= cd_kit_w
				and		cd_material	= cd_material_kit_w
				and		cd_unidade_medida_dose = cd_unidade_medida_w
				and		((cd_intervalo in (cd_intervalo_kit_w,cd_intervalo_w)) or
						 ((coalesce(cd_intervalo::text, '') = '') and (coalesce(cd_intervalo_kit_w::text, '') = '') and (coalesce(cd_intervalo_w::text, '') = '')))
				and		qt_dose	= qt_material_kit_w;

				if (ie_registra_w	= 'S') and (ie_ja_existe_w = 'N') then

					select	coalesce(max(nr_sequencia),0) + 1,
						coalesce(max(nr_agrupamento),0) + 1
					into STRICT	nr_sequencia_w,
						nr_agrupamento_w
					from	prescr_material
					where	nr_prescricao = nr_prescricao_p;

					/*
					--> Rafael em 08/11/2007 OS73502 x kit

					qt_material_w := qt_material_kit_w * nr_ocorrencia_w;
					*/
					if (ie_agrupador_w <> 1) then
						ie_agrupador_w := 1;
					else
						ie_agrupador_w := 2;
					end if;

					if (ie_check_tipo_interv_w = 'S') and ((coalesce(cd_intervalo_kit_w,cd_intervalo_w) IS NOT NULL AND (coalesce(cd_intervalo_kit_w,cd_intervalo_w))::text <> '')) then

						if (coalesce(ie_urgencia_w,'N') = 'N') and (coalesce(ie_acm_w,'N') = 'N') and (coalesce(ie_se_necessario_w,'N') = 'N') then
							Select	coalesce(coalesce(max(ie_agora),ie_urgencia_w),'N'),
									coalesce(coalesce(max(ie_se_necessario), ie_se_necessario_w),'N'),
									coalesce(coalesce(max(ie_acm), ie_acm_w),'N')
							into STRICT	ie_urgencia_w,
									ie_se_necessario_w,
									ie_acm_w
							from	intervalo_prescricao
							where	cd_intervalo = coalesce(cd_intervalo_kit_w,cd_intervalo_w);

							if (ie_check_sn_inter_w = 'N' AND ie_se_necessario_w = 'S')then
								ie_se_necessario_w := 'N';
							end if;

						end if;

					end if;

					/*
					--> Rafael em 08/11/2007 OS73502 x kit <--

					calcular horarios cfe intervalo componente */
					if (cd_intervalo_kit_w IS NOT NULL AND cd_intervalo_kit_w::text <> '') then
						qt_material_w := qt_material_kit_w;
						
						if (coalesce(hr_prim_horario_w::text, '') = '') then
							/* obter primeiro horario */

							select	obter_primeiro_horario(cd_intervalo_kit_w, nr_prescricao_p,cd_material_kit_w,ie_via_aplicacao_ww)
							into STRICT	hr_prim_horario_w
							;
						end if;

						nr_intervalo_w		:= null;
						ds_horarios_kit_w	:= null;
						ds_horarios_kit_ww := null;
						if ((coalesce(hr_prim_horario_w::text, '') = '') or (hr_prim_horario_w = '  :  ')) then
							hr_prim_horario_w	:=	to_char(trunc(dt_primeiro_horario_w,'hh24'),'hh24:mi');
						end if;							
						dt_parametro_w := trunc(ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_primeiro_horario_w, hr_prim_horario_w), 'mi');
						SELECT * FROM calcular_horario_prescricao(nr_prescricao_p, cd_intervalo_kit_w, dt_primeiro_horario_w, dt_parametro_w, nr_horas_validade_w, cd_material_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_intervalo_w, ds_horarios_kit_w, ds_horarios_kit_ww, 'N', null) INTO STRICT nr_intervalo_w, ds_horarios_kit_w, ds_horarios_kit_ww;
						ds_horarios_kit_w := ds_horarios_kit_w || ds_horarios_kit_ww;
					else
						qt_material_w 		:= qt_material_kit_w * nr_ocorrencia_w;
						nr_intervalo_w		:= null;
						ds_horarios_kit_w	:= null;
					end if;



					nr_seq_recomendacao_w	:= null;
					if (cd_recomendacao_w IS NOT NULL AND cd_recomendacao_w::text <> '') then
						nr_seq_recomendacao_w	:= nr_seq_mat_med_w;
					end if;

					insert into prescr_material(
						nr_prescricao,
						nr_sequencia,
						ie_origem_inf,
						cd_material,
						cd_unidade_medida,
						qt_dose,
						qt_unitaria,
						qt_material,
						dt_atualizacao,
						nm_usuario,
						cd_intervalo,
						nr_agrupamento,
						ie_urgencia,
						nr_ocorrencia,
						qt_total_dispensar,
						ie_suspenso,
						cd_unidade_medida_dose,
						ie_se_necessario,
						ie_medicacao_paciente,
						nr_sequencia_proc,
						cd_motivo_baixa,
						ie_agrupador,
						ie_bomba_infusao,
						ie_aplic_bolus,
						ie_aplic_lenta,
						ie_acm,
						ds_horarios,
						nr_seq_kit,
						ie_recons_diluente_fixo,
						cd_kit_material,
						ie_sem_aprazamento,
						qt_dose_especial,
						hr_dose_especial,
						IE_COBRA_PACIENTE,
						nr_seq_recomendacao,
						ie_permite_alterar,
						hr_prim_horario,
						ie_via_aplicacao,
						NR_SEQ_PE_PROC,
						cd_fornec_consignado)
					Values (
						nr_prescricao_p,
						nr_sequencia_w,
						ie_origem_inf_w,
						cd_material_kit_w,
						cd_unidade_medida_w,
						qt_material_kit_w,
						coalesce(qt_material_kit_w,1),
						qt_material_w,
						clock_timestamp(),
						nm_usuario_p,
						coalesce(cd_intervalo_kit_w,cd_intervalo_w),
						nr_agrupamento_w,
						ie_urgencia_w,
						coalesce(nr_intervalo_w,nr_ocorrencia_w),
						qt_material_w,
						ie_suspenso_w,
						cd_unidade_medida_w,
						ie_se_necessario_w,
						ie_medicacao_paciente_w,
						nr_seq_proc_w,
						cd_motivo_baixa_w,
						ie_agrupador_w,
						'N',
						'N',
						'N',
						ie_acm_w,
						coalesce(ds_horarios_kit_w,ds_horarios_w),
						nr_seq_mat_med_w,
						'N',
						cd_kit_w,'N',
						CASE WHEN coalesce(qt_dose_especial_w::text, '') = '' THEN null  ELSE qt_material_kit_w END ,
						hr_dose_especial_w,
						CASE WHEN ie_utiliza_cobra_kit_w='S' THEN  ie_entra_conta_w  ELSE null END ,
						nr_seq_recomendacao_w,
						ie_permite_alterar_w,
						hr_prim_horario_w,
						ie_via_aplicacao_ww,
						NR_SEQ_PE_PROC_w,
						cd_fornecedor_w);

					/*exception when others then
						'Ocorreu um erro na insercao do item de kit '||cd_material_kit_w || '. Verifique se foi informado o intervalo no cadastro deste kit! #@#@');
					end;*/
					if (ie_prescr_mat_sem_lib_w = 'S') then
						CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_sequencia_w,obter_perfil_ativo,'N',nm_usuario_p,null);
					end if;

					select	cd_material,
						cd_intervalo,
						ie_via_aplicacao,
						qt_unitaria,
						qt_material,
						qt_dose_especial,
						nr_ocorrencia,
						ds_dose_diferenciada,
						ie_origem_inf,
						cd_unidade_medida_dose,
						qt_dias_util,
						coalesce(ie_se_necessario,'N'),
						coalesce(ie_acm,'N')
					into STRICT	cd_material_disp_w,
						cd_intervalo_disp_w,
						ie_via_aplicacao_disp_w,
						qt_unitaria_disp_w,
						qt_material_disp_w,
						qt_dose_especial_disp_w,
						nr_ocorrencia_disp_w,
						ds_dose_diferenciada_disp_w,
						ie_origem_inf_disp_w,
						cd_unidade_medida_dose_disp_w,
						qt_dias_util_disp_w,
						ie_se_necessario_w,
						ie_acm_w
					from	prescr_material
					where	nr_prescricao		= nr_prescricao_p
					and	nr_sequencia		= nr_sequencia_w;

					SELECT * FROM obter_quant_dispensar(
						cd_estabelecimento_p, cd_material_disp_w, nr_prescricao_p, nr_sequencia_w, cd_intervalo_disp_w, ie_via_aplicacao_disp_w, qt_unitaria_disp_w, qt_dose_especial_disp_w, nr_ocorrencia_disp_w, ds_dose_diferenciada_disp_w, ie_origem_inf_disp_w, cd_unidade_medida_dose_disp_w, qt_dias_util_disp_w, qt_material_disp_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_disp_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_disp_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_disp_w;

					update	prescr_material
					set	qt_material		= qt_material_disp_w,
						qt_total_dispensar	= qt_total_dispensar_w,
						--ie_regra_disp		= ie_regra_disp_w
						ie_regra_disp		= CASE WHEN ie_necessita_disp_kit_w='N' THEN 'N'  ELSE CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END  END ,
						dt_baixa		= CASE WHEN ie_necessita_disp_kit_w='N' THEN  clock_timestamp()  ELSE dt_baixa END ,
						cd_motivo_baixa		= CASE WHEN ie_necessita_disp_kit_w='N' THEN  cd_motivo_baixa_ww  ELSE cd_motivo_baixa END
					where	nr_prescricao		= nr_prescricao_p
					and	nr_sequencia		= nr_sequencia_w;
				end if;

			END LOOP;
			CLOSE C03;
		else
			cd_kit_w		:= null;


			OPEN C02;
			LOOP
			FETCH C02 into
				cd_kit_w,
				qt_volume_aux_w,
				ie_via_aplicacao_aux_w,
				cd_unidade_medida_aux_w,
				cd_setor_atendimento_aux_w,
				cd_setor_excluir_aux_w,
				nr_horas_validade_kit_w,
				qt_dose_min_W,
				qt_dose_max_W;
			EXIT WHEN NOT FOUND; /* apply on c02 */

				cd_kit_w	:= cd_kit_w;

				if (nr_horas_validade_kit_w	> 0) then
					select	max(a.dt_prescricao)
					into STRICT	dt_prescr_w
					from	prescr_medica a,
						prescr_material b
					where	a.nr_prescricao	= b.nr_prescricao
					and	a.nr_atendimento = nr_atendimento_w
					and	coalesce(a.dt_suspensao::text, '') = ''
					and	coalesce(b.dt_suspensao::text, '') = ''
					and	b.cd_kit_material = cd_kit_w;

					if (dt_prescr_w IS NOT NULL AND dt_prescr_w::text <> '') then
						nr_hora_ult_prescr_w	:= obter_hora_entre_datas(dt_prescr_w, dt_prescricao_w);
						if (nr_hora_ult_prescr_w	< nr_horas_validade_kit_w) then
							cd_kit_w		:= null;
						end if;
					end if;
				end if;

				OPEN C03;
				LOOP
				FETCH C03 into
					cd_material_kit_w,
					qt_material_kit_w,
					cd_unidade_medida_w,
					ie_agrupador_w,
					cd_intervalo_kit_w,
					ie_entra_conta_w,
					ie_duplica_prescr_w,
					cd_motivo_baixa_w,
					cd_kit_material_w,
					ie_permite_alterar_w,
					ie_via_aplicacao_ww,
					cd_fornecedor_w;
				EXIT WHEN NOT FOUND; /* apply on c03 */
				
					if (ie_duplica_prescr_w	= 'N') then
						select	coalesce(max('N'),'S')
						into STRICT	ie_registra_w
						from	prescr_material
						where	cd_material	= cd_material_kit_w
						and	nr_prescricao	= nr_prescricao_p
						and	coalesce(ie_duplica_prescr_w,'S') = 'N';
					elsif (ie_duplica_prescr_w	= 'C') then

						if (cd_material_ant_w	= cd_material_w)  or (ie_item_superior_w	= 'S') then
							ie_registra_w	:= 'S';
						else
							select	coalesce(max('N'),'S')
							into STRICT	ie_registra_w
							from	prescr_material
							where	cd_material	= cd_material_kit_w
							and	nr_prescricao	= nr_prescricao_p
							and	coalesce(ie_duplica_prescr_w,'S') = 'C'
							and	nr_seq_kit in ( SELECT	nr_sequencia
										  from		prescr_material
										  where		nr_prescricao	= nr_prescricao_p
										  and		ie_agrupador	= ie_agrupador_ww
										  and		nr_agrupamento	= nr_agrup_w);
						end if;
					elsif (ie_duplica_prescr_w	= 'D') then
						select	coalesce(max('N'),'S')
						into STRICT	ie_registra_w
						from	prescr_material
						where	cd_material	= cd_material_kit_w
						and	nr_prescricao	= nr_prescricao_p
						and	coalesce(ie_duplica_prescr_w,'S') = 'D'
						and	cd_kit_material	= cd_kit_material_w
						and	nr_seq_kit in ( SELECT	nr_sequencia
									 from		prescr_material
									 where		nr_prescricao	= nr_prescricao_p
									 and		ie_agrupador	= ie_agrupador_ww
									 and		nr_agrupamento	= nr_agrup_w);
					elsif (ie_duplica_prescr_w	= 'E') then
						select	coalesce(max('N'),'S')
						into STRICT	ie_registra_w
						from	prescr_material
						where	cd_material	= cd_material_kit_w
						and		nr_prescricao	= nr_prescricao_p
						and		coalesce(ie_duplica_prescr_w,'S') = 'E'
						and		cd_kit_material	= cd_kit_material_w;
					elsif (ie_duplica_prescr_w	= 'L') then
						if (ie_agrupador_ww		<> 4) then
							ie_registra_w	:= 'S';
						else
							select	coalesce(max('N'),'S')
							into STRICT	ie_registra_w
							from	prescr_material
							where	cd_material			= cd_material_kit_w
							and	nr_prescricao			= nr_prescricao_p
							and	nr_seq_kit 			in (	SELECT	nr_sequencia
													from	prescr_material
													where	nr_prescricao		= nr_prescricao_p
													and	ie_agrupador		= 4
													and	nr_sequencia_solucao	= nr_sequencia_solucao_w);
						end if;
					else
						ie_registra_w	:= 'S';
					end if;

					if (coalesce(cd_intervalo_kit_w::text, '') = '') or (cd_intervalo_kit_w = '') then
						cd_intervalo_kit_w := cd_intervalo_w;
					end if;

					select	coalesce(max('S'),'N')
					into STRICT	ie_ja_existe_w
					from	prescr_material
					where	nr_seq_recomendacao = nr_seq_mat_med_w
					and		nr_prescricao = nr_prescricao_p
					and		cd_kit_material	= cd_kit_w
					and		cd_material	= cd_material_kit_w
					and		cd_unidade_medida_dose = cd_unidade_medida_w
					and		((cd_intervalo in (cd_intervalo_kit_w,cd_intervalo_w)) or
							 ((coalesce(cd_intervalo::text, '') = '') and (coalesce(cd_intervalo_kit_w::text, '') = '') and (coalesce(cd_intervalo_w::text, '') = '')))
					and		qt_dose	= qt_material_kit_w;

					if (ie_registra_w	= 'S') and (ie_ja_existe_w = 'N') then

						select	coalesce(max(nr_sequencia),0) + 1,
							coalesce(max(nr_agrupamento),0) + 1
						into STRICT	nr_sequencia_w,
							nr_agrupamento_w
						from	prescr_material
						where	nr_prescricao = nr_prescricao_p;

						/*
						--> Rafael em 08/11/2007 OS73502 x kit

						qt_material_w := qt_material_kit_w * nr_ocorrencia_w;
						*/
						if (ie_agrupador_w <> 1) then
							ie_agrupador_w := 1;
						else
							ie_agrupador_w := 2;
						end if;

						if (ie_check_tipo_interv_w = 'S') and ((coalesce(cd_intervalo_kit_w,cd_intervalo_w) IS NOT NULL AND (coalesce(cd_intervalo_kit_w,cd_intervalo_w))::text <> '')) then

							if (coalesce(ie_urgencia_w,'N') = 'N') and (coalesce(ie_acm_w,'N') = 'N') and (coalesce(ie_se_necessario_w,'N') = 'N') then
								Select	coalesce(coalesce(max(ie_agora),ie_urgencia_w),'N'),
										coalesce(coalesce(max(ie_se_necessario), ie_se_necessario_w),'N'),
										coalesce(coalesce(max(ie_acm), ie_acm_w),'N')
								into STRICT	ie_urgencia_w,
										ie_se_necessario_w,
										ie_acm_w
								from	intervalo_prescricao
								where	cd_intervalo = coalesce(cd_intervalo_kit_w,cd_intervalo_w);
							end if;
						end if;

						/*
						--> Rafael em 08/11/2007 OS73502 x kit <--

						calcular horarios cfe intervalo componente */
						if (cd_intervalo_kit_w IS NOT NULL AND cd_intervalo_kit_w::text <> '') then
							qt_material_w := qt_material_kit_w;
							
							if (coalesce(hr_prim_horario_w::text, '') = '') then
								/* obter primeiro horario */

								select	obter_primeiro_horario(cd_intervalo_kit_w, nr_prescricao_p, cd_material_kit_w,ie_via_aplicacao_ww)
								into STRICT	hr_prim_horario_w
								;
							end if;

							nr_intervalo_w		:= null;
							ds_horarios_kit_w	:= null;
							ds_horarios_kit_ww := null;
							if ((coalesce(hr_prim_horario_w::text, '') = '') or (hr_prim_horario_w = '  :  ')) then
								hr_prim_horario_w	:=	to_char(trunc(dt_primeiro_horario_w,'hh24'),'hh24:mi');
							end if;							
							dt_parametro_w := trunc(ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_primeiro_horario_w, hr_prim_horario_w),'mi');
							SELECT * FROM calcular_horario_prescricao(nr_prescricao_p, cd_intervalo_kit_w, dt_primeiro_horario_w, dt_parametro_w, nr_horas_validade_w, cd_material_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_intervalo_w, ds_horarios_kit_w, ds_horarios_kit_ww, 'N', null) INTO STRICT nr_intervalo_w, ds_horarios_kit_w, ds_horarios_kit_ww;
							ds_horarios_kit_w := ds_horarios_kit_w || ds_horarios_kit_ww;
						else
							qt_material_w := qt_material_kit_w * nr_ocorrencia_w;
							nr_intervalo_w		:= null;
							ds_horarios_kit_w	:= null;
						end if;						
						
						nr_seq_recomendacao_w	:= null;
						if (cd_recomendacao_w IS NOT NULL AND cd_recomendacao_w::text <> '') then
							nr_seq_recomendacao_w	:= nr_seq_mat_med_w;
						end if;

						insert into prescr_material(
							nr_prescricao,
							nr_sequencia,
							ie_origem_inf,
							cd_material,
							cd_unidade_medida,
							qt_dose,
							qt_unitaria,
							qt_material,
							dt_atualizacao,
							nm_usuario,
							cd_intervalo,
							nr_agrupamento,
							ie_urgencia,
							nr_ocorrencia,
							qt_total_dispensar,
							ie_suspenso,
							cd_unidade_medida_dose,
							ie_se_necessario,
							ie_medicacao_paciente,
							nr_sequencia_proc,
							cd_motivo_baixa,
							ie_agrupador,
							ie_bomba_infusao,
							ie_aplic_bolus,
							ie_aplic_lenta,
							ie_acm,
							ds_horarios,
							nr_seq_kit,
							ie_recons_diluente_fixo,
							cd_kit_material,
							ie_sem_aprazamento,
							qt_dose_especial,
							hr_dose_especial,
							IE_COBRA_PACIENTE,
							nr_seq_recomendacao,
							ie_permite_alterar,
							hr_prim_horario,
							ie_via_aplicacao,
							NR_SEQ_PE_PROC,
							cd_fornec_consignado)
						Values (
							nr_prescricao_p,
							nr_sequencia_w,
							ie_origem_inf_w,
							cd_material_kit_w,
							cd_unidade_medida_w,
							qt_material_kit_w,
							coalesce(qt_material_kit_w,1),
							coalesce(qt_material_w,1),
							clock_timestamp(),
							nm_usuario_p,
							coalesce(cd_intervalo_kit_w,cd_intervalo_w),
							nr_agrupamento_w,
							ie_urgencia_w,
							coalesce(nr_intervalo_w,nr_ocorrencia_w),
							qt_material_w,
							ie_suspenso_w,
							cd_unidade_medida_w,
							ie_se_necessario_w,
							ie_medicacao_paciente_w,
							nr_seq_proc_w,
							cd_motivo_baixa_w,
							ie_agrupador_w,
							'N',
							'N',
							'N',
							ie_acm_w,
							coalesce(ds_horarios_kit_w,ds_horarios_w),
							nr_seq_mat_med_w,

							'N',
							cd_kit_w,'N',
							CASE WHEN coalesce(qt_dose_especial_w::text, '') = '' THEN null  ELSE qt_material_kit_w END ,
							hr_dose_especial_w,
							CASE WHEN ie_utiliza_cobra_kit_w='S' THEN  ie_entra_conta_w  ELSE null END ,
							nr_seq_recomendacao_w,

							ie_permite_alterar_w,
							hr_prim_horario_w,
							ie_via_aplicacao_ww,
							NR_SEQ_PE_PROC_w,
							cd_fornecedor_w);

							if (ie_prescr_mat_sem_lib_w = 'S') then
								CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_sequencia_w,obter_perfil_ativo,'N',nm_usuario_p,null);
							end if;

						select	cd_material,
							cd_intervalo,
							ie_via_aplicacao,
							qt_unitaria,
							qt_material,
							qt_dose_especial,
							nr_ocorrencia,
							ds_dose_diferenciada,
							ie_origem_inf,
							cd_unidade_medida_dose,
							qt_dias_util,
							coalesce(ie_se_necessario,'N'),
							coalesce(ie_acm,'N')
						into STRICT	cd_material_disp_w,
							cd_intervalo_disp_w,
							ie_via_aplicacao_disp_w,
							qt_unitaria_disp_w,
							qt_material_disp_w,
							qt_dose_especial_disp_w,
							nr_ocorrencia_disp_w,
							ds_dose_diferenciada_disp_w,
							ie_origem_inf_disp_w,
							cd_unidade_medida_dose_disp_w,
							qt_dias_util_disp_w,
							ie_se_necessario_w,
							ie_acm_w
						from	prescr_material
						where	nr_prescricao		= nr_prescricao_p
						and	nr_sequencia		= nr_sequencia_w;

						SELECT * FROM obter_quant_dispensar(
							cd_estabelecimento_p, cd_material_disp_w, nr_prescricao_p, nr_sequencia_w, cd_intervalo_disp_w, ie_via_aplicacao_disp_w, qt_unitaria_disp_w, qt_dose_especial_disp_w, nr_ocorrencia_disp_w, ds_dose_diferenciada_disp_w, ie_origem_inf_disp_w, cd_unidade_medida_dose_disp_w, qt_dias_util_disp_w, qt_material_disp_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_disp_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_disp_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_disp_w;

						update	prescr_material
						set	qt_material		= coalesce(qt_material_disp_w,coalesce(qt_material,1)),
							qt_total_dispensar	= qt_total_dispensar_w,
							ie_regra_disp		= CASE WHEN ie_necessita_disp_kit_w='N' THEN 'N'  ELSE CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END  END ,
							dt_baixa		= CASE WHEN ie_necessita_disp_kit_w='N' THEN  clock_timestamp()  ELSE dt_baixa END ,
							cd_motivo_baixa		= CASE WHEN ie_necessita_disp_kit_w='N' THEN  cd_motivo_baixa_ww  ELSE cd_motivo_baixa END
						where	nr_prescricao		= nr_prescricao_p
						and	nr_sequencia		= nr_sequencia_w;
					end if;

					if (coalesce(cd_material_ant_w::text, '') = '') then
						cd_material_ant_w	:= cd_material_w;
					end if;

				END LOOP;
				CLOSE C03;

			END LOOP;
			CLOSE C02;
		end if;
	end if;

END LOOP;
CLOSE C01;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_kit_rec_prescricao ( cd_estabelecimento_p bigint, nr_Prescricao_p bigint, nr_seq_item_p bigint, nm_usuario_p text, ie_diluicao_p text default 'N', ie_manual_p text default 'N') FROM PUBLIC;

