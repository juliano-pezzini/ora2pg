-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gravar_solic_alteracao_web ( vl_campo_old_p text, vl_campo_new_p text, nm_campo_p text, nm_tabela_p text, ds_chave_simples_p text, ds_chave_composta_p text, nm_usuario_p text, ie_tipo_solicitacao_p text, nr_seq_usu_prestador_p bigint, cd_estabelecimento_p bigint, cd_funcao_origem_p bigint, nr_seq_solicitacao_p INOUT bigint) AS $body$
DECLARE


ds_chave_composta_w		varchar(500);
ds_chave_simples_w		varchar(255);
nr_seq_solic_w			bigint;
qt_alteracoes_w			bigint;
nm_usuario_regra_w		varchar(15);
nm_usuario_aux_w		                varchar(4000);
cd_perfil_aux_w			varchar(4000);
cd_perfil_w			integer;

C01 CURSOR FOR
	SELECT	a.nm_usuario_comunic,
		a.cd_perfil
	from	pls_reg_comunic_alt_prest a;


BEGIN

nr_seq_solic_w		:= nr_seq_solicitacao_p;
ds_chave_simples_w	:= ds_chave_simples_p;
ds_chave_composta_w	:= ds_chave_composta_p;

if (coalesce(nr_seq_solic_w::text, '') = '') then
	select	nextval('tasy_solic_alteracao_seq')
	into STRICT	nr_seq_solic_w
	;

	insert into tasy_solic_alteracao(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ie_processo,
		ie_tipo_solicitacao,
		ie_status,
		nm_usuario_solic_web,
		cd_estabelecimento,
		cd_funcao)
	values (nr_seq_solic_w,
		clock_timestamp(),
		substr(nm_usuario_p,1,15),
		clock_timestamp(),
		substr(nm_usuario_p,1,15),
		'W',
		ie_tipo_solicitacao_p,
		'A',
		substr(nm_usuario_p,1,15),
		cd_estabelecimento_p,
		cd_funcao_origem_p);

	CALL pls_gravar_log_acesso_portal( null, null, nr_seq_usu_prestador_p,
			      null, null, null,
			      null, null, '8',
			      'O usuário '||nm_usuario_p||' solicitou alterações nos seus dados cadastrais.', 'Alteração de cadastro do prestador.', 'N');

	commit;
end if;

insert into tasy_solic_alt_campo(nr_sequencia,
	nm_tabela,
	nm_atributo,
	ds_chave_simples,
	ds_chave_composta,
	nr_seq_solicitacao,
	ie_status,
	ds_valor_old,
	ds_valor_new,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	ie_tipo_login_solic)
values (nextval('tasy_solic_alt_campo_seq'),
	upper(nm_tabela_p),
	upper(nm_campo_p),
	ds_chave_simples_w,
	ds_chave_composta_w,
	nr_seq_solic_w,
	'P',
	vl_campo_old_p,
	vl_campo_new_p,
	clock_timestamp(),
	substr(nm_usuario_p,1,15),
	clock_timestamp(),
	substr(nm_usuario_p,1,15),
	'PP');

nr_seq_solicitacao_p := nr_seq_solic_w;

open C01;
loop
fetch C01 into
	nm_usuario_regra_w,
	cd_perfil_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	nm_usuario_aux_w	:= nm_usuario_aux_w || nm_usuario_regra_w || ',';
	cd_perfil_aux_w		:= cd_perfil_aux_w || cd_perfil_w || ',';
	end;
end loop;
close C01;

CALL Gerar_Comunic_Padrao(	clock_timestamp(),
			'Alteração de cadastro do prestador',
			'Foi solicitada a alteração do cadastro do prestador ' || nr_seq_solicitacao_p,
			nm_usuario_p,
			'N',
			nm_usuario_aux_w,
			'N',
			null,
			cd_perfil_aux_w,
			null,
			null,
			clock_timestamp(),
			null,
			null);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gravar_solic_alteracao_web ( vl_campo_old_p text, vl_campo_new_p text, nm_campo_p text, nm_tabela_p text, ds_chave_simples_p text, ds_chave_composta_p text, nm_usuario_p text, ie_tipo_solicitacao_p text, nr_seq_usu_prestador_p bigint, cd_estabelecimento_p bigint, cd_funcao_origem_p bigint, nr_seq_solicitacao_p INOUT bigint) FROM PUBLIC;

