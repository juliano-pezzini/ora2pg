-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_ci_iniciativa_dt_fim ( DATA_P timestamp DEFAULT clock_timestamp(), QT_DIAS_P bigint DEFAULT 1) AS $body$
DECLARE


DT_FIM_PREVISTO_W		timestamp;
NR_SEQUENCIA_W			bigint;
NR_SEQ_INDICADOR_BSC_W	bigint;
CD_PESSOA_SOLICITANTE_W	varchar(10);
CD_PF_RESP_BSC_W		varchar(10);

CD_PF_RESP_BSC_WW		varchar(10);

C01 CURSOR FOR
	SELECT DT_FIM_PREVISTO,
		   NR_SEQUENCIA,
		   NR_SEQ_INDICADOR_BSC BSC_INDICADOR,
		   CD_PESSOA_SOLICITANTE CD_SOLICITANTE,
		   CD_PF_RESP_BSC BSC_RESPONSAVEL
	FROM MAN_ORDEM_SERVICO
	WHERE 1 = 1
	AND	  DT_FIM_PREVISTO BETWEEN INICIO_DIA(DATA_P - QT_DIAS_P) AND FIM_DIA(DATA_P)
	AND	  (NR_SEQ_INDICADOR_BSC IS NOT NULL AND NR_SEQ_INDICADOR_BSC::text <> '');

C02 CURSOR FOR
	SELECT	DISTINCT A.CD_PESSOA_FISICA
	FROM	BSC_IND_RESP A,
		BSC_INDICADOR B,
		MAN_ORDEM_SERVICO C
	WHERE	1 = 1
	AND	B.IE_SITUACAO = 'A'
	AND	B.NR_SEQUENCIA = A.NR_SEQ_INDICADOR
	AND	B.NR_SEQUENCIA = C.NR_SEQ_INDICADOR_BSC
	AND	C.NR_SEQUENCIA = NR_SEQUENCIA_W;



BEGIN

OPEN C01;
LOOP
FETCH C01 INTO
	DT_FIM_PREVISTO_W,
	NR_SEQUENCIA_W,
	NR_SEQ_INDICADOR_BSC_W,
	CD_PESSOA_SOLICITANTE_W,
	CD_PF_RESP_BSC_W;
EXIT WHEN NOT FOUND; /* apply on C01 */
	BEGIN

	INSERT  INTO	COMUNIC_INTERNA(
								DT_LIBERACAO,
								DT_COMUNICADO,
								DS_TITULO,
								DS_COMUNICADO,
								NM_USUARIO,
								DT_ATUALIZACAO,
								NR_SEQUENCIA,
								IE_GERENCIAL,
								NM_USUARIO_DESTINO)
							VALUES (
								clock_timestamp(),
								clock_timestamp(),
								'INICIATIVA PRÓXIMO À DATA DE TÉRMINO PREVISTA.',
								'INICIATIVA Nº:'||NR_SEQUENCIA_W||' VENCIMENTO DIA: '||DT_FIM_PREVISTO_W,
								'TASY',
								clock_timestamp(),
								nextval('comunic_interna_seq'),
								'N',
								OBTER_USUARIO_PESSOA(CD_PESSOA_SOLICITANTE_W)||','||OBTER_USUARIO_PESSOA(CD_PF_RESP_BSC_W));

	OPEN C02;
	LOOP
	FETCH C02 INTO
		CD_PF_RESP_BSC_WW;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		BEGIN
		INSERT  INTO	COMUNIC_INTERNA(
								DT_LIBERACAO,
								DT_COMUNICADO,
								DS_TITULO,
								DS_COMUNICADO,
								NM_USUARIO,
								DT_ATUALIZACAO,
								NR_SEQUENCIA,
								IE_GERENCIAL,
								NM_USUARIO_DESTINO)
							VALUES (
								clock_timestamp(),
								clock_timestamp(),
								'INICIATIVA PRÓXIMO À DATA DE TÉRMINO PREVISTA.',
								'INICIATIVA Nº:'||NR_SEQUENCIA_W||' VENCIMENTO DIA: '||DT_FIM_PREVISTO_W,
								'TASY',
								clock_timestamp(),
								nextval('comunic_interna_seq'),
								'N',
								OBTER_USUARIO_PESSOA(CD_PF_RESP_BSC_WW));
		END;
	END LOOP;
	CLOSE C02;
	END;
END LOOP;
CLOSE C01;


COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_ci_iniciativa_dt_fim ( DATA_P timestamp DEFAULT clock_timestamp(), QT_DIAS_P bigint DEFAULT 1) FROM PUBLIC;

