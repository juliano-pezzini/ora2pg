-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alerta_funcoes_web ( nr_seq_segurado_p bigint, nr_seq_usu_estipulante_p bigint, nr_seq_usu_prestador_p bigint, nr_seq_perfil_web_p bigint, ie_tipo_acesso_p text, nm_usuario_param_p text, cd_estabelecimento_p bigint, nr_seq_usu_gru_cont_p bigint, ie_justifica_prestador_p INOUT text, ie_solicitacoes_pend_estip_p INOUT text, ie_complemento_guia_p INOUT text, ie_comunicado_externo_p INOUT text) AS $body$
DECLARE

 
					 
ie_justifica_prestador_w 	varchar(1) 	:= 'N';
ie_solicitacoes_pend_estip_w	varchar(1) 	:= 'N';
ie_complemento_guia_w		varchar(1) 	:= 'N';
ie_comunicado_externo_w		varchar(1) 	:= 'N';
							
ie_hab_justifica_prestador_w 	varchar(1) 	:= 'N';
ie_hab_solic_pend_estip_w	varchar(1) 	:= 'N';
ie_hab_complemento_guia_w	varchar(1) 	:= 'N';
ie_hab_comunicado_externo_w	varchar(1) 	:= 'N';

qt_registro_w			bigint;
dt_regra_compl_guia_w		varchar(20);
nm_usuario_web_w		varchar(100);
ie_param_sol_est_w		varchar(10);
nr_seq_contrato_w		bigint;
nr_seq_contrato_int_w		bigint;
nr_seq_prestador_usu_w		bigint;
nr_seq_prestador_w		bigint;
cd_pessoa_fisica_w		pls_segurado.cd_pessoa_fisica%type;

C01 CURSOR FOR 
	SELECT 	nr_seq_prestador 
	from 	pls_prestador_usuario_web p 
	where 	p.nr_seq_usuario = nr_seq_usu_prestador_p	 
	and	p.ie_situacao = 'A';
	
C02 CURSOR FOR 
	SELECT 	nr_sequencia     
	from  	pls_guia_plano a           
	where 	a.nr_seq_prestador 	= nr_seq_prestador_w					 
	and	a.ie_tipo_guia 		= '3'             
	and 	a.ie_status 		= '1'     							 
	and	a.dt_autorizacao >= dt_regra_compl_guia_w 
	and	coalesce(a.nr_seq_prestador_web::text, '') = '' 
	and	((0 = (SELECT count(1) from pls_diagnostico b where b.nr_seq_guia = a.nr_sequencia and (b.cd_doenca IS NOT NULL AND b.cd_doenca::text <> '')  LIMIT 1)) or (coalesce(a.ie_tipo_saida::text, '') = ''))					 
	and	a.ie_estagio_complemento <> '1';
	
					 
BEGIN 
 
/* Verifica parâmetros */
 
if (ie_tipo_acesso_p = 'B') then 
	ie_hab_comunicado_externo_w    :=	pls_obter_param_web(1246,28,cd_estabelecimento_p, 
								  nr_seq_usu_prestador_p, nr_seq_perfil_web_p, nr_seq_segurado_p, 
								  nr_seq_usu_estipulante_p, ie_tipo_acesso_p, nm_usuario_param_p, 
								  nr_seq_usu_gru_cont_p);
 
	if (ie_hab_comunicado_externo_w = 'S') then 
		select	max(nr_seq_contrato), 
			max(cd_pessoa_fisica) 
		into STRICT	nr_seq_contrato_w, 
			cd_pessoa_fisica_w 
		from	pls_segurado 
		where	nr_sequencia = nr_seq_segurado_p;
		 
		ie_comunicado_externo_w := pls_obter_cominc_externo_web(nr_seq_perfil_web_p, nr_seq_usu_prestador_p, nm_usuario_web_w, 'B', nr_seq_contrato_w, cd_pessoa_fisica_w);
	end if;
 
elsif (ie_tipo_acesso_p = 'P') then 
	 
	ie_hab_complemento_guia_w    :=	pls_obter_param_web(1246,54,cd_estabelecimento_p, 
								  nr_seq_usu_prestador_p, nr_seq_perfil_web_p, nr_seq_segurado_p, 
								  nr_seq_usu_estipulante_p, ie_tipo_acesso_p, nm_usuario_param_p, 
								  nr_seq_usu_gru_cont_p);
	ie_hab_comunicado_externo_w   :=	pls_obter_param_web(1246,28,cd_estabelecimento_p, 
								  nr_seq_usu_prestador_p, nr_seq_perfil_web_p, nr_seq_segurado_p, 
								  nr_seq_usu_estipulante_p, ie_tipo_acesso_p, nm_usuario_param_p, 
								  nr_seq_usu_gru_cont_p);	
	ie_hab_justifica_prestador_w  :=	pls_obter_param_web(1246,20,cd_estabelecimento_p, 
								  nr_seq_usu_prestador_p, nr_seq_perfil_web_p, nr_seq_segurado_p, 
								  nr_seq_usu_estipulante_p, ie_tipo_acesso_p, nm_usuario_param_p, 
								  nr_seq_usu_gru_cont_p);
 
	if (ie_hab_complemento_guia_w = 'S') then 
		dt_regra_compl_guia_w := pls_obter_regra_compl_guia;
		 
		/** 
		Cuidar no momento de adicionar nova restrição no select, foi criado indice para executar o mesmo 
		*/
 
		select 	count(1)        
		into STRICT  	qt_registro_w 
		from  	pls_guia_plano a           
		where 	a.nr_seq_prestador_web = nr_seq_usu_prestador_p 
		and	a.ie_tipo_guia 		= '3'             
		and 	a.ie_status 		= '1'	 
		and	a.dt_autorizacao >= dt_regra_compl_guia_w		 
		and	((0 = (SELECT count(1) from pls_diagnostico b where b.nr_seq_guia = a.nr_sequencia and (b.cd_doenca IS NOT NULL AND b.cd_doenca::text <> '')  LIMIT 1)) or (coalesce(a.ie_tipo_saida::text, '') = '')) 
		and	a.ie_estagio_complemento <> '1' 
		and not exists (select 1  
				from pls_conta c 
				where c.nr_seq_guia = a.nr_sequencia);
			 
		if (qt_registro_w = 0 ) then 
		 
			for r_c01 in C01 loop 
				begin 
				 
				nr_seq_prestador_w := r_c01.nr_seq_prestador;
				 
				for	r_c02 in C02 loop 
					begin 
					 
					select	count(1) 
					into STRICT	qt_registro_w 
					from	pls_conta 
					where	nr_seq_guia = r_c02.nr_sequencia;
					 
					if (qt_registro_w = 0) then 
						ie_complemento_guia_w := 'S';
						exit;
					end if;
					 
					end;
				end loop;	
				 
				if (ie_complemento_guia_w = 'S') then 
					exit;
				end if;
				 
				end;
			end loop;
			 
		else	 
			ie_complemento_guia_w := 'S';		
		end if;
		 
	end if;
 
	if (ie_hab_comunicado_externo_w = 'S') then 
		select	max(nm_usuario_web) 
		into STRICT	nm_usuario_web_w 
		from	pls_usuario_web 
		where  nr_sequencia = nr_seq_usu_prestador_p;
		 
		ie_comunicado_externo_w := pls_obter_cominc_externo_web(nr_seq_perfil_web_p, nr_seq_usu_prestador_p, nm_usuario_web_w, 'P', null, null);
	end if;
		 
	if (ie_hab_justifica_prestador_w = 'S') then 
        select 	count(1) 
		into STRICT  qt_registro_w 
	    from 	pls_auditoria a 
		where	(((a.nr_seq_guia IS NOT NULL AND a.nr_seq_guia::text <> '')  
		and 	exists( SELECT 1  
				from  pls_guia_plano x 
				where x.nr_sequencia = a.nr_seq_guia 
				and  (x.nr_seq_prestador_web = nr_seq_usu_prestador_p 
				or  ((coalesce(x.nr_seq_prestador_web::text, '') = '' or a.ie_permite_just_prestadores = 'S') 
				and   exists ( select 1 
						from 	pls_prestador_usuario_web y 
						where	y.nr_seq_usuario = nr_seq_usu_prestador_p 
						and	y.ie_situacao = 'A' 
						and	y.nr_seq_prestador = a.nr_seq_prestador))))) 
		or  ((a.nr_seq_requisicao IS NOT NULL AND a.nr_seq_requisicao::text <> '') 
		and  exists( select  1 
			    from	pls_requisicao x 
			    where  x.nr_sequencia = a.nr_seq_requisicao 
			    and   (x.nr_seq_prestador_web = nr_seq_usu_prestador_p  
			    or   ((coalesce(x.nr_seq_prestador_web::text, '') = '' or a.ie_permite_just_prestadores = 'S') 
			    and	exists ( select 1 
						from 	pls_prestador_usuario_web y 
						where	y.nr_seq_usuario = nr_seq_usu_prestador_p 
						and	y.ie_situacao = 'A' 
						and	y.nr_seq_prestador = a.nr_seq_prestador)))))) 
		and  ie_status = 'AJ';
		 
		if (qt_registro_w > 0) then 
			ie_justifica_prestador_w := 'S';
		end if;
	end if;							  					
								   
elsif (ie_tipo_acesso_p = 'E') then 
 
	select 	max(nr_seq_contrato), 
		max(nr_seq_contrato_int) 
	into STRICT	nr_seq_contrato_w, 
		nr_seq_contrato_int_w 
	from	pls_estipulante_web 
	where	nr_sequencia = nr_seq_usu_estipulante_p;
	 
	ie_hab_comunicado_externo_w := pls_obter_param_web(1246,28,cd_estabelecimento_p, 
								  nr_seq_usu_prestador_p, nr_seq_perfil_web_p, nr_seq_segurado_p, 
								  nr_seq_usu_estipulante_p, ie_tipo_acesso_p, nm_usuario_param_p, 
								  nr_seq_usu_gru_cont_p);
	 
	ie_hab_solic_pend_estip_w :=	pls_obter_param_web(1246,20,cd_estabelecimento_p, 
							  nr_seq_usu_prestador_p, nr_seq_perfil_web_p, nr_seq_segurado_p, 
							  nr_seq_usu_estipulante_p, ie_tipo_acesso_p, nm_usuario_param_p, 
							  nr_seq_usu_gru_cont_p);
	 
	if ((nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') and ie_hab_solic_pend_estip_w = 'S') then 
		ie_hab_solic_pend_estip_w :=	pls_obter_param_web(1295,5,cd_estabelecimento_p, 
								  nr_seq_usu_prestador_p, nr_seq_perfil_web_p, nr_seq_segurado_p, 
								  nr_seq_usu_estipulante_p, ie_tipo_acesso_p, nm_usuario_param_p, 
								  nr_seq_usu_gru_cont_p);
	elsif ((nr_seq_contrato_int_w IS NOT NULL AND nr_seq_contrato_int_w::text <> '') and ie_hab_solic_pend_estip_w = 'S') then 
		/* Caso for contrato de intercambio o usuário só vai ter acesso as requsições pendentes de auditoria */
 
		ie_hab_solic_pend_estip_w := '2';
	end if;
	 
	--Comunicados	 
	if (ie_hab_comunicado_externo_w = 'S') then 
		select	max(nm_usuario_web) 
		into STRICT	nm_usuario_web_w 
		from	pls_estipulante_web 
		where  nr_sequencia = nr_seq_usu_estipulante_p;
		 
		ie_comunicado_externo_w := pls_obter_cominc_externo_web(nr_seq_perfil_web_p, nr_seq_usu_prestador_p, nm_usuario_web_w, 'E', null, null);
	end if;
		 
	/* Solicitações pendentes */
 
	if (ie_hab_solic_pend_estip_w = '1') then 
		select count(1) 
		into STRICT	qt_registro_w 
		from  pls_guia_plano a 
		where nr_seq_segurado in (SELECT nr_sequencia 
					  from  pls_segurado 
					  where  nr_seq_contrato = nr_seq_contrato_w) 
		and	ie_estagio = '9' 
		and	ie_status = '2';
		 
		if (qt_registro_w > 0) then 
			ie_solicitacoes_pend_estip_w := 'S';
		end if;		
	elsif (ie_hab_solic_pend_estip_w = '2') then 
		select count(1) 
		into STRICT	qt_registro_w 
		from	pls_auditoria a, 
			pls_requisicao b, 
			pls_segurado c, 
			pls_auditoria_grupo d, 
			pls_grupo_auditor e, 
			pls_membro_grupo_aud f 
		where  a.nr_seq_requisicao = b.nr_sequencia 
		and   b.nr_seq_segurado = c.nr_sequencia 
		and   e.nr_sequencia = d.nr_seq_grupo 
		and 	f.nr_seq_grupo = e.nr_sequencia 
		and   d.nr_sequencia = pls_obter_grupo_analise_atual(a.nr_sequencia) 
		and   ((c.nr_seq_contrato = nr_seq_contrato_w      
		or    c.nr_seq_intercambio = nr_seq_contrato_int_w ) AND (f.nr_seq_contrato  = nr_seq_contrato_w    
		or    f.nr_seq_intercambio = nr_seq_contrato_int_w )) 
		and   e.ie_tipo_auditoria = 3 
		and   a.ie_status = 'AE' 
		--and 	a.ie_auditoria_estipulante = 'S' 
		and   coalesce(d.dt_liberacao::text, '') = ''  LIMIT 1;
		 
		if (qt_registro_w > 0) then 
			ie_solicitacoes_pend_estip_w := 'S';
		end if;
	end if;
	 
end if;
 
ie_justifica_prestador_p 	:= 	ie_justifica_prestador_w;
ie_solicitacoes_pend_estip_p	:=	ie_solicitacoes_pend_estip_w;
ie_complemento_guia_p		:=	ie_complemento_guia_w;
ie_comunicado_externo_p		:=	ie_comunicado_externo_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alerta_funcoes_web ( nr_seq_segurado_p bigint, nr_seq_usu_estipulante_p bigint, nr_seq_usu_prestador_p bigint, nr_seq_perfil_web_p bigint, ie_tipo_acesso_p text, nm_usuario_param_p text, cd_estabelecimento_p bigint, nr_seq_usu_gru_cont_p bigint, ie_justifica_prestador_p INOUT text, ie_solicitacoes_pend_estip_p INOUT text, ie_complemento_guia_p INOUT text, ie_comunicado_externo_p INOUT text) FROM PUBLIC;

