-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_local_estoque ( cd_funcao_p bigint, nr_sequencia_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nm_maquina_atual_p text, cd_setor_atendimento_p bigint, nr_cirurgia_p bigint, nr_prescricao_p bigint default 0, cd_local_estoque_p INOUT bigint DEFAULT NULL) AS $body$
DECLARE


ie_local_estoque_w	varchar(1)	:= 'N';
qt_local_computador_w	integer;
cd_local_estoque_w	bigint;
cd_local_estoque_esp_w  bigint;
ie_vinc_local_mat_esp_w	varchar(1)  := 'N';
ie_prescricao_cir_w	varchar(1);


BEGIN

cd_local_estoque_esp_w := Obter_Param_Usuario(900, 128, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, cd_local_estoque_esp_w);
ie_vinc_local_mat_esp_w := Obter_Param_Usuario(900, 523, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_vinc_local_mat_esp_w);

if (cd_funcao_p IS NOT NULL AND cd_funcao_p::text <> '') and (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') and (cd_perfil_p IS NOT NULL AND cd_perfil_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') and (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') then
	begin
	ie_local_estoque_w := obter_param_usuario(	cd_funcao_p, nr_sequencia_p, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_local_estoque_w);


	if (upper(ie_local_estoque_w) = 'C') and (nm_maquina_atual_p IS NOT NULL AND nm_maquina_atual_p::text <> '') then
		begin
		select	count(*)
		into STRICT	qt_local_computador_w
		from	local_estoque_computador b,
			computador a
		where	a.nr_sequencia  = b.nr_seq_computador
		and	a.nm_computador_pesquisa  = padronizar_nome(upper(nm_maquina_atual_p));
		end;

		if (qt_local_computador_w = 0) then
			begin
			CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(240091); --NÃ£o existe nenhum local de estoque associado a este computador! Verifique o cadastro de Computadores!
			end;
		else
			begin
			select	coalesce(max(b.cd_local_estoque), 0)
			into STRICT	cd_local_estoque_w
			from	local_estoque_computador b,
				computador a
			where	a.nr_sequencia  	= b.nr_seq_computador
			and	a.nm_computador_pesquisa  	= padronizar_nome(upper(nm_maquina_atual_p));
			end;
		end if;

	elsif (upper(ie_local_estoque_w) = 'U') then
		begin
		select	coalesce(max(cd_local_estoque), 0)
		into STRICT	cd_local_estoque_w
		from	setor_atendimento
		where	cd_setor_atendimento = coalesce(cd_setor_atendimento_p, 0);
		end;

	elsif (upper(ie_local_estoque_w) = 'P') then
		begin
		select	coalesce(max(a.cd_local_estoque), 0)
		into STRICT	cd_local_estoque_w
		from	setor_atendimento a,
			cirurgia b
		where 	b.cd_setor_atendimento 	= a.cd_setor_atendimento
		and 	b.nr_cirurgia 		= nr_cirurgia_p;
		end;
	end if;
	end;
end if;

cd_local_estoque_p := cd_local_estoque_w;

if (coalesce(nr_prescricao_p,0) > 0) then

		select 	coalesce(max('S'),'N')
		into STRICT	ie_prescricao_cir_w
		from   	cirurgia
		where  	nr_prescricao = nr_prescricao_p;

		if  ((ie_prescricao_cir_w = 'N') and (ie_vinc_local_mat_esp_w = 'S') and (coalesce(cd_local_estoque_esp_w,0) > 0)) then

			cd_local_estoque_p := cd_local_estoque_esp_w;

		 end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_local_estoque ( cd_funcao_p bigint, nr_sequencia_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nm_maquina_atual_p text, cd_setor_atendimento_p bigint, nr_cirurgia_p bigint, nr_prescricao_p bigint default 0, cd_local_estoque_p INOUT bigint DEFAULT NULL) FROM PUBLIC;

