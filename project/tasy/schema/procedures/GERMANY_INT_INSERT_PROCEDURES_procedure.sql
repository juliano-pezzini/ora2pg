-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE germany_int_insert_procedures ( nr_proc_interno_p text, nr_atendimento_p text, nm_usuario_p text, nm_procedure_p text, ds_name_coding_p text, dt_procedure_p text) AS $body$
DECLARE


cd_proc_w		    procedimento.cd_procedimento%type;
nr_proc_interno_w	procedimento.cd_procedimento_loc%type;
ie_lado_w		    procedimento_pac_medico.ie_lado%type;
setor_atend_w		bigint;
seq_atepacu_w		bigint;
new_proc_w		    bigint;
cd_convenio_w		integer;
cd_categoria_w		varchar(10);
dt_procedure_w      procedimento_paciente.dt_atualizacao%type;
ie_situacao_w		constant varchar(1) := 'A';


BEGIN

    begin
	
	select  replace(nr_proc_interno_p, REGEXP_SUBSTR(nr_proc_interno_p, ' [ R| L| B]$', 1), '') ,
               REGEXP_SUBSTR(nr_proc_interno_p, '[ R| L| B]$', 1)
	into STRICT    nr_proc_interno_w,
			ie_lado_w
	;

    select	max(cd_procedimento)
    into STRICT	cd_proc_w
    from	procedimento 
    where	cd_procedimento_loc = nr_proc_interno_w
	and		ie_origem_proced = 11;

    setor_atend_w := Obter_setor_atendimento(nr_atendimento_p);
    seq_atepacu_w := Obter_atepacu_paciente(nr_atendimento_p, 'A');
    
    SELECT a.cd_convenio, 
           a.cd_categoria 
    INTO STRICT   cd_convenio_w, cd_categoria_w 
    FROM   atend_categoria_convenio a 
    WHERE  a.nr_atendimento = (nr_atendimento_p)::numeric 
    AND a.dt_inicio_vigencia = (SELECT Max(dt_inicio_vigencia) 
                                FROM   atend_categoria_convenio b 
                                WHERE  nr_atendimento = (nr_atendimento_p)::numeric );

    dt_procedure_w	 := to_date(dt_procedure_p, 'yyyymmddhh24miss');

    
    insert into procedimento_pac_medico(
                nr_sequencia,
                dt_atualizacao,
                nm_usuario,
                dt_atualizacao_nrec,
                nm_usuario_nrec,
                ie_situacao,
                nr_atendimento,
                nr_seq_episodio,
                cd_setor_atendimento,
                cd_procedimento,
                dt_procedimento,
                ie_origem_proced,
                nr_seq_proc_interno,
                qt_procedimento,
				dt_liberacao,
				ie_lado
            ) values (
                nextval('procedimento_pac_medico_seq'),
                clock_timestamp(),
                nm_usuario_p,
                clock_timestamp(),
                nm_usuario_p,
                ie_situacao_w,
                nr_atendimento_p,
                obter_episodio_atendimento(nr_atendimento_p),
                setor_atend_w,
                cd_proc_w,
                dt_procedure_w,
                11,
                null,
                1,
				dt_procedure_w,
				CASE WHEN ie_lado_w='B' THEN 'A' WHEN ie_lado_w='R' THEN 'D' WHEN ie_lado_w='L' THEN 'E'  ELSE null END 
            );

    new_proc_w := inserir_procedimento_paciente(	cd_proc_w, 1, null, null, 11, setor_atend_w, nr_atendimento_p, null, nm_usuario_p, null, null, null, seq_atepacu_w, dt_procedure_w, cd_convenio_w, cd_categoria_w, new_proc_w, null, null);
    exception

    when others then
        CALL gravar_log_cdi(7000,dbms_utility.format_error_backtrace,'GERMANY');
    end;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE germany_int_insert_procedures ( nr_proc_interno_p text, nr_atendimento_p text, nm_usuario_p text, nm_procedure_p text, ds_name_coding_p text, dt_procedure_p text) FROM PUBLIC;

