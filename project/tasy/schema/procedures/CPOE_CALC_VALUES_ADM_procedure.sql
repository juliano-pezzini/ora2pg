-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_calc_values_adm (cd_material_p bigint, qt_dose_terap_p INOUT bigint, qt_peso_p bigint, qt_periodo_p bigint, nr_unidade_terap_p bigint, qt_vel_infusao_p bigint, ie_disp_infusao_p text, ie_unidade_vel_p text, qt_corrigido_terap_p INOUT bigint, qt_diluente_p INOUT bigint, qt_corrigido_dilu_p INOUT bigint, qt_total_dose_p INOUT bigint, qt_total_corrigido_p INOUT bigint, qt_micrograma_p INOUT bigint, qt_micro_corrigido_p INOUT bigint, qt_dose_p bigint default null, cd_unidade_medida_p text default null, cd_mat_dil_p bigint default null, qt_dose_dil_p bigint default null, cd_unidade_medida_dil_p text default null) AS $body$
DECLARE


ie_unidade_w			regra_dose_terap.ie_unidade%type;
ie_tempo_w				regra_dose_terap.ie_tempo%type;
ie_peso_w				regra_dose_terap.ie_peso%type;
ie_solucao_w			regra_dose_terap.ie_solucao%type;
qt_equipo_w				rep_dispositivo.qt_equipo%type;

qt_dose_direta_ml_w		double precision;
qt_total_dose_w			double precision;
qt_corrigido_dilu_w		double precision;
qt_periodo_w			bigint;
qt_periodo_convert_w	bigint;
qt_tempo_infusao_w		double precision;
qt_corrigido_w			double precision;
qt_peso_w				double precision;
qt_diluente_w			double precision;
qt_total_corrigido_w	double precision;
qt_vel_infusao_mlh_w	double precision;

qt_tot_micro_corrigido_w	double precision;
cd_unidade_med_dose_terap_w unidade_medida.cd_unidade_medida%type;


BEGIN

select	
    max(ie_unidade),
	max(ie_tempo),
	max(ie_peso),
	max(ie_solucao)
into STRICT	
    ie_unidade_w,
	ie_tempo_w,
	ie_peso_w,
	ie_solucao_w
from	regra_dose_terap
where	nr_sequencia	= nr_unidade_terap_p;

if (ie_solucao_w = 'S') then

	qt_peso_w	:= qt_peso_p;
	if (ie_peso_w = 'G') then
		qt_peso_w	:= qt_peso_p * 1000;
	end if;

	select 	coalesce(max(qt_equipo),0)
	into STRICT	qt_equipo_w
	from	rep_dispositivo
	where	ie_bomba_infusao = ie_disp_infusao_p
	and 	ie_tipo_item 	= 1;

	qt_vel_infusao_mlh_w := Converte_velocidade_infusao(ie_unidade_vel_p, 'mlh', qt_vel_infusao_p);

	if (coalesce(qt_periodo_p::text, '') = '') then
		qt_periodo_w := dividir_sem_round((obter_conversao_ml(cd_material_p, qt_dose_p, cd_unidade_medida_p) + obter_conversao_ml(cd_mat_dil_p, qt_dose_dil_p, cd_unidade_medida_dil_p)), qt_vel_infusao_mlh_w);
	else
		qt_periodo_w := qt_periodo_p;
	end if;

	if (ie_tempo_w = 'M') then
		qt_periodo_convert_w	:= (qt_periodo_w * 60);
	else
		qt_periodo_convert_w	:= qt_periodo_w;
	end if;

	qt_tempo_infusao_w := round((qt_vel_infusao_mlh_w * qt_periodo_w)::numeric, 2);

	select 	max(a.cd_unidade_medida)
	into STRICT	cd_unidade_med_dose_terap_w
	from 	material_conversao_unidade a,
		unidade_medida b
	where	a.cd_material = cd_material_p
	and a.cd_unidade_medida = b.cd_unidade_medida
	and upper(b.ie_unidade_med_inter) = upper(ie_unidade_w);

	if (ie_peso_w IS NOT NULL AND ie_peso_w::text <> '') then
		qt_dose_direta_ml_w := round((qt_dose_terap_p * qt_peso_w) * qt_periodo_convert_w, 2);
	else
		qt_dose_direta_ml_w := qt_dose_terap_p * qt_periodo_convert_w;
	end if;

	qt_dose_direta_ml_w  	:=  obter_conversao_ml(cd_material_p, qt_dose_direta_ml_w, cd_unidade_med_dose_terap_w, 'S');

	qt_corrigido_w  		:=  qt_dose_direta_ml_w * dividir_sem_round((qt_tempo_infusao_w + qt_equipo_w), qt_tempo_infusao_w);
	qt_diluente_w			:=  qt_tempo_infusao_w - qt_dose_direta_ml_w;
	qt_corrigido_dilu_w		:= (qt_tempo_infusao_w + qt_equipo_w) - qt_corrigido_w;
	qt_total_dose_w	    	:=  qt_dose_direta_ml_w + qt_diluente_w;
	qt_total_corrigido_w 	:=  qt_corrigido_w + qt_corrigido_dilu_w;
	qt_tot_micro_corrigido_w:= ((dividir_sem_round(qt_vel_infusao_p, qt_dose_direta_ml_w)) * qt_corrigido_w);
	qt_dose_terap_p		:=  trunc(qt_dose_direta_ml_w,4);
	qt_diluente_p 		:=  trunc(qt_diluente_w,4);
	qt_total_dose_p		:=  trunc(qt_total_dose_w,4);

	qt_corrigido_terap_p 	:=  trunc(qt_corrigido_w,4);
	qt_corrigido_dilu_p  	:=  trunc(qt_corrigido_dilu_w,4);
	qt_total_corrigido_p 	:=  trunc(qt_total_corrigido_w,4);
	qt_micrograma_p		:=  trunc(qt_vel_infusao_p * 1000,4);
	qt_micro_corrigido_p    :=  trunc(qt_tot_micro_corrigido_w * 1000,4);


end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_calc_values_adm (cd_material_p bigint, qt_dose_terap_p INOUT bigint, qt_peso_p bigint, qt_periodo_p bigint, nr_unidade_terap_p bigint, qt_vel_infusao_p bigint, ie_disp_infusao_p text, ie_unidade_vel_p text, qt_corrigido_terap_p INOUT bigint, qt_diluente_p INOUT bigint, qt_corrigido_dilu_p INOUT bigint, qt_total_dose_p INOUT bigint, qt_total_corrigido_p INOUT bigint, qt_micrograma_p INOUT bigint, qt_micro_corrigido_p INOUT bigint, qt_dose_p bigint default null, cd_unidade_medida_p text default null, cd_mat_dil_p bigint default null, qt_dose_dil_p bigint default null, cd_unidade_medida_dil_p text default null) FROM PUBLIC;

