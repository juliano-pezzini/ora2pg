-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_dados_proc_adic ( nr_seq_agenda_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


qt_cme_agenda_w		integer;
nr_seq_conjunto_w		bigint;
ie_obrigatorio_w		varchar(3);
qt_conjunto_w		bigint;
ie_soma_proc_adic_w	varchar(2);
nr_sequencia_proc_w	bigint;
nr_seq_proc_interno_w	bigint;	
cd_pessoa_usuario_w	varchar(10);
cd_procedimento_w	bigint;
ie_origem_proced_w	varchar(10);
cd_medico_w		varchar(10);
ie_lado_w		varchar(1);
cd_convenio_w		integer;
cd_convenio_agenda_w	integer;
cd_categoria_w		varchar(10);
ie_gerar_cme_w		varchar(1) := 'S';
ie_cme_proc_w		varchar(1);
qt_min_proc_w		bigint;

ie_consiste_w		varchar(15);
cd_equipamento_proc_w	bigint;
nr_seq_classif_equip_w	bigint;
ds_erro_equip_w		varchar(255);
ds_erro_w		varchar(255);
nr_sequencia_w		bigint;
cd_equipamento_w		bigint;
qt_equip_class_w		smallint;
nr_seq_classif_equip_ww	bigint;
cd_equipamento_ww	bigint;
ie_equip_adic_w		varchar(1);
ie_classif_equip_w		varchar(15);
ie_gerar_opme_w		varchar(1);
cd_cgc_w		varchar(14);
ie_padrao_w		varchar(1);
qt_material_w		double precision;
cd_material_w		bigint;
ie_tem_medico_w		varchar(1);
ie_GerarCMEIndividualizado_w	varchar(1);	
ie_registra_observacao_w	varchar(1);
ds_observacao_w		varchar(255);
cd_plano_w		varchar(10);
ie_ajusta_tempo_agenda_w	varchar(255);
nr_seq_pedido_w		bigint;
qt_registro_kit_w		bigint;
ie_gera_kit_troca_proced_w	varchar(1);
qt_kit_material_w		bigint;
cd_setor_exclusivo_w	integer;
cd_setor_equipamento_w	integer;
qt_procedimento_w		double precision;
ie_tipo_convenio_w		smallint	:= 0;
cd_perfil_w		integer;
ie_considera_estab_agenda_w	varchar(3);
cd_estab_cme_w		bigint;
ie_gerar_proc_apos_cir_w	varchar(1);
nr_prescricao_w		bigint := 0;
qt_anos_pac_w		smallint;
qt_meses_pac_w		smallint;
qt_total_meses_pac_w	smallint;
ie_consiste_opme_w	         varchar(1);
ie_gera_proc_associado_w      varchar(1) := 'N';
cd_categoria_agenda_w         categoria_convenio.cd_categoria%type;
cd_plano_agenda_w             convenio_plano.cd_plano%type;
nr_seq_proc_interno_princ_w   proc_interno.nr_sequencia%type;
ie_origem_proced_princ_w      proc_interno.ie_origem_proced%type;
cd_medico_exec_w              pessoa_fisica.cd_pessoa_fisica%type;
cd_estab_opme_w					agenda.cd_estabelecimento%type;
cd_estab_agenda_w				   agenda.cd_estabelecimento%type;
ds_observacao_ww         w_agenda_proc_adic.ds_observacao%type;
nr_prescr_mipres_w        prescr_mipres.nr_presc_mipres%type;
dt_validity_mipres_w      prescr_mipres.dt_validity_mipres%type;
nr_seq_prescr_mipres_w    prescr_mipres.nr_sequencia%type;
cd_pac_pessoa_fisica_w    prescr_mipres.cd_pessoa_fisica%type;

c01 CURSOR FOR
	SELECT	nr_seq_proc_interno,
            cd_medico,
            ie_lado,
            cd_convenio,
            cd_categoria,
            cd_procedimento,
            ie_origem_proced,
            coalesce(qt_min_proced,0),
            cd_plano,
            coalesce(qt_procedimento,1),
            coalesce(obter_tipo_convenio(cd_convenio),0),
			ds_observacao,
			nr_prescr_mipres,
			dt_validity_mipres
	from	   w_agenda_proc_adic
	where	   cd_pessoa_fisica	=	cd_pessoa_usuario_w

union

   SELECT	nr_seq_proc_int_adic,
            cd_medico_exec_w,
            null,
            cd_convenio,
            cd_categoria_convenio,
            obter_cd_proc_tab_interno(nr_seq_proc_int_adic,wheb_usuario_pck.get_cd_estabelecimento,cd_convenio,cd_categoria_convenio,'CD'),
            obter_cd_proc_tab_interno(nr_seq_proc_int_adic,wheb_usuario_pck.get_cd_estabelecimento,cd_convenio,cd_categoria_convenio,'O'),
            0,
            cd_plano_convenio,
            coalesce(qt_proc_adic,1),
            coalesce(obter_tipo_convenio(cd_convenio),0),
			null ds_observacao,
			null,
			null
	from	   proc_int_proc_prescr a
	where	   a.nr_seq_proc_interno	= nr_seq_proc_interno_princ_w
	and 	   coalesce(a.cd_convenio,cd_convenio_agenda_w) = cd_convenio_agenda_w
	and		((coalesce(a.cd_estabelecimento::text, '') = '') or (cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento))
	and	   coalesce(a.ie_situacao,'A')	= 'A'
	and		((coalesce(cd_perfil::text, '') = '') or (cd_perfil = cd_perfil_w))
	and	   ((coalesce(a.cd_edicao_amb::text, '') = '') or ((a.cd_procedimento IS NOT NULL AND a.cd_procedimento::text <> '') and (obter_se_proc_edicao2(a.cd_procedimento, a.ie_origem_proced, a.cd_edicao_amb) = 'S')))
	and 	   ((coalesce(a.cd_convenio_excluir::text, '') = '') or (a.cd_convenio_excluir <> cd_convenio_agenda_w))
	and	   ((coalesce(a.cd_categoria_convenio::text, '') = '') or (a.cd_categoria_convenio = cd_categoria_agenda_w))
	and	   ((a.cd_plano_convenio	= cd_plano_agenda_w) or (coalesce(a.cd_plano_convenio::text, '') = ''))
	and	   ((coalesce(a.cd_medico_prescritor::text, '') = '') or (a.cd_medico_prescritor = cd_medico_exec_w))
	and	   ((coalesce(a.cd_medico_excluir::text, '') = '') or (a.cd_medico_excluir <> cd_medico_exec_w))
	and 	   ((a.ie_origem_proc_filtro = ie_origem_proced_princ_w) or (coalesce(a.ie_origem_proc_filtro::text, '') = ''))
	and	   (((coalesce(qt_anos_pac_w::text, '') = '') or (coalesce(a.qt_idade_min::text, '') = '' and coalesce(a.qt_idade_max::text, '') = '')) or
            ((qt_anos_pac_w IS NOT NULL AND qt_anos_pac_w::text <> '') and (qt_anos_pac_w between coalesce(a.qt_idade_min,qt_anos_pac_w) and coalesce(a.qt_idade_max,qt_anos_pac_w))))
	and 	   not exists (	select 	1
                           from	   agenda_paciente_proc d
                           where 	d.nr_sequencia  	   = nr_seq_agenda_p
                           and	   d.ie_origem_proced	= obter_cd_proc_tab_interno(a.nr_seq_proc_int_adic,wheb_usuario_pck.get_cd_estabelecimento,a.cd_convenio,a.cd_categoria_convenio,'O')
                           and	   d.cd_procedimento    = obter_cd_proc_tab_interno(nr_seq_proc_int_adic,wheb_usuario_pck.get_cd_estabelecimento,cd_convenio,cd_categoria_convenio,'CD'))
   and	   coalesce(ie_somente_agenda_int,'N') = 'N'
   and      ie_gera_proc_associado_w = 'S';
	
c02 CURSOR FOR
	SELECT	a.nr_seq_conjunto,
		a.qt_conjunto,
		coalesce(a.ie_obrigatorio,'S'),
		a.ie_soma_proc_adic
	from	proc_interno_cme a,
		cm_conjunto b
	where	a.nr_seq_conjunto 	= b.nr_sequencia
	and	coalesce(b.ie_situacao,'A') 	= 'A'
	and coalesce(qt_total_meses_pac_w,0) between coalesce(b.qt_idade_min,0) and  coalesce(b.qt_idade_max,999)
	and	a.nr_seq_proc_interno	=	nr_seq_proc_interno_w
	and	(a.nr_seq_conjunto IS NOT NULL AND a.nr_seq_conjunto::text <> '')
	and	((coalesce(cd_medico_w,'X') = coalesce(a.cd_medico,'X')) or (coalesce(a.cd_medico::text, '') = ''))
	and	((ie_gerar_cme_w = 'S') or ((ie_gerar_cme_w = 'E') and (not exists ( SELECT 1
										     from agenda_pac_cme x 
										     where x.nr_seq_conjunto = a.nr_seq_conjunto
										     and   x.nr_seq_agenda = nr_seq_agenda_p))))	
	and	ie_GerarCMEIndividualizado_w = 'N'
	and	((coalesce(a.cd_estabelecimento::text, '') = '') or (a.cd_estabelecimento = cd_estab_cme_w))
	
union

	select	a.nr_seq_conjunto,
		a.qt_conjunto,
		coalesce(a.ie_obrigatorio,'S'),
		a.ie_soma_proc_adic
	from	proc_interno_cme a,
		cm_conjunto b
	where	a.nr_seq_conjunto 	= b.nr_sequencia
	and	coalesce(b.ie_situacao,'A') 	= 'A'
	and coalesce(qt_total_meses_pac_w,0) between coalesce(b.qt_idade_min,0) and  coalesce(b.qt_idade_max,999)
	and	a.nr_seq_proc_interno	=	nr_seq_proc_interno_w
	and	(a.nr_seq_conjunto IS NOT NULL AND a.nr_seq_conjunto::text <> '')
	and	((coalesce(cd_medico_w,'X') = coalesce(a.cd_medico,'X')) or (coalesce(a.cd_medico::text, '') = ''))
	and	((ie_gerar_cme_w = 'S') or ((ie_gerar_cme_w = 'E') and (not exists ( select 1 
										     from agenda_pac_cme x 
										     where x.nr_seq_conjunto = a.nr_seq_conjunto
										     and   x.nr_seq_agenda = nr_seq_agenda_p))))	
	and	ie_GerarCMEIndividualizado_w = 'S'
	and	((ie_tem_medico_w = 'S' AND a.cd_medico = cd_medico_w) or
		 ((ie_tem_medico_w = 'N') and (coalesce(a.cd_medico::text, '') = '')))
	and	((coalesce(a.cd_estabelecimento::text, '') = '') or (a.cd_estabelecimento = cd_estab_cme_w));
	

c03 CURSOR FOR
	SELECT	c.nr_sequencia,
		a.qt_conjunto,
		coalesce(a.ie_obrigatorio,'S'),
		ie_soma_proc_adic
	from	cm_grupo_conjunto d,
		proc_interno_cme a,
		CM_GRUPO_CLASSIF b,
		CM_CONJUNTO c
	where	a.nr_seq_proc_interno	= nr_seq_proc_interno_w
	and	a.nr_seq_grupo		= d.nr_sequencia
	and	a.nr_seq_grupo		= b.nr_seq_grupo
	and	c.NR_SEQ_CLASSIF	= b.NR_SEQ_CLASSIFICACAO
	and coalesce(qt_total_meses_pac_w,0) between coalesce(c.qt_idade_min,0) and  coalesce(c.qt_idade_max,999)
	and	(a.nr_seq_grupo IS NOT NULL AND a.nr_seq_grupo::text <> '')
	and	coalesce(a.NR_SEQ_CLASSIF::text, '') = ''
	and	coalesce(a.nr_seq_conjunto::text, '') = ''
	and	d.ie_situacao 		= 'A'
	and	coalesce(c.ie_situacao,'A')	= 'A'
	and	((coalesce(cd_medico_w,'X') = coalesce(a.cd_medico,'X')) or (coalesce(a.cd_medico::text, '') = ''))
	and	((ie_gerar_cme_w = 'S') or ((ie_gerar_cme_w = 'E') and (not exists ( SELECT 1
										     from agenda_pac_cme x 
										     where x.nr_seq_conjunto = c.nr_sequencia
										     and   x.nr_seq_agenda = nr_seq_agenda_p))))	
	and	ie_GerarCMEIndividualizado_w = 'N'
	and	((coalesce(a.cd_estabelecimento::text, '') = '') or (a.cd_estabelecimento = cd_estab_cme_w))
	
union

	select	c.nr_sequencia,
		a.qt_conjunto,
		coalesce(a.ie_obrigatorio,'S'),
		ie_soma_proc_adic
	from	cm_grupo_conjunto d,
		proc_interno_cme a,
		CM_GRUPO_CLASSIF b,
		CM_CONJUNTO c
	where	a.nr_seq_proc_interno	= nr_seq_proc_interno_w
	and	a.nr_seq_grupo		= d.nr_sequencia
	and	a.nr_seq_grupo		= b.nr_seq_grupo
	and	c.NR_SEQ_CLASSIF	= b.NR_SEQ_CLASSIFICACAO
	and coalesce(qt_total_meses_pac_w,0) between coalesce(c.qt_idade_min,0) and  coalesce(c.qt_idade_max,999)
	and	(a.nr_seq_grupo IS NOT NULL AND a.nr_seq_grupo::text <> '')
	and	coalesce(a.NR_SEQ_CLASSIF::text, '') = ''
	and	coalesce(a.nr_seq_conjunto::text, '') = ''
	and	d.ie_situacao 					= 'A'
	and	coalesce(c.ie_situacao,'A')	= 'A'
	and	((coalesce(cd_medico_w,'X') = coalesce(a.cd_medico,'X')) or (coalesce(a.cd_medico::text, '') = ''))
	and	((ie_gerar_cme_w = 'S') or ((ie_gerar_cme_w = 'E') and (not exists ( select 1 
										     from agenda_pac_cme x 
										     where x.nr_seq_conjunto = c.nr_sequencia
										     and   x.nr_seq_agenda = nr_seq_agenda_p))))	
	and	ie_GerarCMEIndividualizado_w = 'S'
	and	((ie_tem_medico_w = 'S' AND a.cd_medico = cd_medico_w) or
		 ((ie_tem_medico_w = 'N') and (coalesce(a.cd_medico::text, '') = '')))
	and	((coalesce(a.cd_estabelecimento::text, '') = '') or (a.cd_estabelecimento = cd_estab_cme_w));


c04 CURSOR FOR
	SELECT	c.nr_sequencia,
			a.qt_conjunto,
			coalesce(a.ie_obrigatorio,'S'),
			ie_soma_proc_adic
	from	proc_interno_cme a,
			CM_CONJUNTO c
	where	a.nr_seq_proc_interno	= nr_seq_proc_interno_w
	and		c.NR_SEQ_CLASSIF	= a.NR_SEQ_CLASSIF
	and 	coalesce(qt_total_meses_pac_w,0) between coalesce(c.qt_idade_min,0) and  coalesce(c.qt_idade_max,999)
	and		((coalesce(cd_medico_w,'X') = coalesce(a.cd_medico,'X')) or (coalesce(a.cd_medico::text, '') = ''))
	and		(a.NR_SEQ_CLASSIF IS NOT NULL AND a.NR_SEQ_CLASSIF::text <> '')
	and		coalesce(a.nr_seq_conjunto::text, '') = ''
	and	coalesce(c.ie_situacao,'A')	= 'A'
	and	((ie_gerar_cme_w = 'S') or ((ie_gerar_cme_w = 'E') and (not exists ( SELECT 1
										     from agenda_pac_cme x 
										     where x.nr_seq_conjunto = c.nr_sequencia
										     and   x.nr_seq_agenda = nr_seq_agenda_p))))	
	and		ie_GerarCMEIndividualizado_w = 'N'
	and		((coalesce(a.cd_estabelecimento::text, '') = '') or (a.cd_estabelecimento = cd_estab_cme_w))
	
union

	select	c.nr_sequencia,
			a.qt_conjunto,
			coalesce(a.ie_obrigatorio,'S'),
			ie_soma_proc_adic
	from	proc_interno_cme a,
			CM_CONJUNTO c
	where	a.nr_seq_proc_interno	= nr_seq_proc_interno_w
	and		c.NR_SEQ_CLASSIF	= a.NR_SEQ_CLASSIF
	and 	coalesce(qt_total_meses_pac_w,0) between coalesce(c.qt_idade_min,0) and  coalesce(c.qt_idade_max,999)
	and		(a.NR_SEQ_CLASSIF IS NOT NULL AND a.NR_SEQ_CLASSIF::text <> '')
	and		coalesce(a.nr_seq_conjunto::text, '') = ''
	and	coalesce(c.ie_situacao,'A')	= 'A'
	and	((ie_gerar_cme_w = 'S') or ((ie_gerar_cme_w = 'E') and (not exists ( select 1 
										     from agenda_pac_cme x 
										     where x.nr_seq_conjunto = c.nr_sequencia
										     and   x.nr_seq_agenda = nr_seq_agenda_p))))	
	and		ie_GerarCMEIndividualizado_w = 'S'
	and		((ie_tem_medico_w = 'S' AND a.cd_medico = cd_medico_w) or
			 ((ie_tem_medico_w = 'N') and (coalesce(a.cd_medico::text, '') = '')))
	and		((coalesce(a.cd_estabelecimento::text, '') = '') or (a.cd_estabelecimento = cd_estab_cme_w));

	
C05 CURSOR FOR
	SELECT	coalesce(a.nr_seq_classif_equip,0),
		coalesce(a.cd_equipamento,0)
	from	proc_interno_equip a
	where	a.nr_seq_proc_interno	=	nr_seq_proc_interno_w
	and 	coalesce(a.cd_medico::text, '') = ''		
	and	((ie_classif_equip_w = 'C' AND nr_seq_classif_equip IS NOT NULL AND nr_seq_classif_equip::text <> '') or (ie_classif_equip_w = 'E' AND cd_equipamento IS NOT NULL AND cd_equipamento::text <> ''))
	and not exists (	SELECT	1
			from	agenda_pac_equip x
			where	x.nr_seq_agenda		= nr_seq_agenda_p
			and (x.nr_seq_classif_equip	= a.nr_seq_classif_equip or x.cd_equipamento = a.cd_equipamento))			
	and	ie_equip_adic_w = 'S'
	and 	exists (select 	1 	
		from    equipamento z
		where 	a.cd_equipamento = z.cd_equipamento
		and 	coalesce(z.cd_setor_atendimento,cd_setor_equipamento_w) = cd_setor_equipamento_w)
	
union
	
	select	coalesce(a.nr_seq_classif_equip,0),
		coalesce(a.cd_equipamento,0)
	from	proc_interno_equip a
	where	a.nr_seq_proc_interno	=	nr_seq_proc_interno_w
	and 	a.cd_medico		= 	cd_medico_w	
	and	((ie_classif_equip_w = 'C' AND nr_seq_classif_equip IS NOT NULL AND nr_seq_classif_equip::text <> '') or (ie_classif_equip_w = 'E' AND cd_equipamento IS NOT NULL AND cd_equipamento::text <> ''))
	and not exists (	select	1
			from	agenda_pac_equip x
			where	x.nr_seq_agenda		=	nr_seq_agenda_p
			and (x.nr_seq_classif_equip	= a.nr_seq_classif_equip or x.cd_equipamento = a.cd_equipamento))
	and	ie_equip_adic_w = 'S'
	and 	exists (select 	1 	
		from    equipamento z
		where 	a.cd_equipamento = z.cd_equipamento
		and 	coalesce(z.cd_setor_atendimento,cd_setor_equipamento_w) = cd_setor_equipamento_w);
	
c06 CURSOR FOR
	SELECT	a.cd_material,
		a.qt_material,
		coalesce(a.ie_padrao,'S'),
		a.cd_cgc,
		a.ds_observacao
	from	proc_interno_opme a
	where	a.nr_seq_proc_interno	=	nr_seq_proc_interno_w
	and	coalesce(a.cd_medico::text, '') = ''
	and	coalesce(a.cd_convenio,coalesce(cd_convenio_w,0))	= coalesce(cd_convenio_w,0)
	and	coalesce(a.ie_tipo_convenio,ie_tipo_convenio_w)	= ie_tipo_convenio_w
	and	coalesce(a.cd_plano, cd_plano_w)	= cd_plano_w
	and	coalesce(a.cd_estabelecimento, cd_estab_opme_w)	= cd_estab_opme_w
	and	((ie_consiste_opme_w = 'N') or 	not exists (	SELECT	1
								from	agenda_pac_opme x
								where	x.nr_seq_agenda		=	nr_seq_agenda_p
								and	x.cd_material		=	a.cd_material))
	and	ie_gerar_opme_w = 'S'						
	
union

	select	a.cd_material,
		a.qt_material,
		coalesce(a.ie_padrao,'S'),
		a.cd_cgc,
		a.ds_observacao
	from	proc_interno_opme a
	where	a.nr_seq_proc_interno	=	nr_seq_proc_interno_w
	and	a.cd_medico		=	cd_medico_w
	and	coalesce(a.cd_convenio,coalesce(cd_convenio_w,0))	= coalesce(cd_convenio_w,0)
	and	coalesce(a.ie_tipo_convenio,ie_tipo_convenio_w)	= ie_tipo_convenio_w
	and	coalesce(a.cd_plano, cd_plano_w)	= cd_plano_w
	and	coalesce(a.cd_estabelecimento, cd_estab_opme_w)	= cd_estab_opme_w	
	and	((ie_consiste_opme_w = 'N') or 	not exists (	select	1
								from	agenda_pac_opme x
								where	x.nr_seq_agenda		=	nr_seq_agenda_p
								and	x.cd_material		=	a.cd_material))
	and	ie_gerar_opme_w = 'S';					


BEGIN

select   max(qt_idade_paciente),
         max(qt_idade_mes),
         max(cd_convenio),
         max(cd_categoria),
         max(cd_plano),
         max(nr_seq_proc_interno),
         max(ie_origem_proced),
         max(coalesce(cd_medico_exec,cd_medico))
into STRICT	   qt_anos_pac_w,	
         qt_meses_pac_w,
         cd_convenio_agenda_w,
         cd_categoria_agenda_w,
         cd_plano_agenda_w,
         nr_seq_proc_interno_princ_w,
         ie_origem_proced_princ_w,
         cd_medico_exec_w
from	   agenda_paciente
where	   nr_sequencia 	= 	nr_seq_agenda_p;

qt_total_meses_pac_w := (qt_anos_pac_w * 12) + qt_meses_pac_w;

select	obter_dados_usuario_opcao(nm_usuario_p,'C')
into STRICT	   cd_pessoa_usuario_w
;


cd_perfil_w	:=	obter_perfil_ativo;

ie_gerar_cme_w := Obter_Param_Usuario(871, 136, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ie_gerar_cme_w);
ie_cme_proc_w := Obter_Param_Usuario(871, 143, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ie_cme_proc_w);
ie_consiste_w := Obter_Param_Usuario(871, 81, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ie_consiste_w);
ie_equip_adic_w := Obter_Param_Usuario(871, 168, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ie_equip_adic_w);
ie_classif_equip_w := Obter_Param_Usuario(871, 100, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ie_classif_equip_w);
ie_gerar_opme_w := Obter_Param_Usuario(871, 260, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ie_gerar_opme_w);
ie_GerarCMEIndividualizado_w := Obter_Param_Usuario(871, 272, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ie_GerarCMEIndividualizado_w);
ie_registra_observacao_w := Obter_Param_Usuario(871, 281, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ie_registra_observacao_w);
ie_ajusta_tempo_agenda_w := Obter_Param_Usuario(871, 321, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ie_ajusta_tempo_agenda_w);
ie_gera_kit_troca_proced_w := Obter_Param_Usuario(871, 373, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ie_gera_kit_troca_proced_w);
if (wheb_usuario_pck.get_cd_funcao = 870) then
   --Para a funcao 871 ja existe a verificacao deste parametro no evento de Post do dbpanel da agenda_paciente
   ie_gera_proc_associado_w := Obter_Param_Usuario(871, 397, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ie_gera_proc_associado_w);
end if;
ie_considera_estab_agenda_w := Obter_Param_Usuario(871, 648, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ie_considera_estab_agenda_w);
ie_gerar_proc_apos_cir_w := Obter_Param_Usuario(900, 542, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ie_gerar_proc_apos_cir_w);

ie_consiste_opme_w := Obter_Param_Usuario(870, 70, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ie_consiste_opme_w);

select 		max(cd_estabelecimento)
into STRICT		cd_estab_agenda_w
from		agenda a,
			agenda_paciente b
where		a.cd_agenda = b.cd_agenda
and		    b.nr_sequencia = nr_seq_agenda_p;

if (ie_considera_estab_agenda_w = 'S') then
	cd_estab_cme_w := cd_estab_agenda_w;	
	cd_estab_opme_w := wheb_usuario_pck.get_cd_estabelecimento;
elsif (ie_considera_estab_agenda_w = 'O') then
	cd_estab_cme_w := wheb_usuario_pck.get_cd_estabelecimento;
	cd_estab_opme_w := cd_estab_agenda_w;
elsif (ie_considera_estab_agenda_w = 'CO') then
	cd_estab_cme_w := cd_estab_agenda_w;
	cd_estab_opme_w := cd_estab_agenda_w;
else
	cd_estab_cme_w := wheb_usuario_pck.get_cd_estabelecimento;
	cd_estab_opme_w := wheb_usuario_pck.get_cd_estabelecimento;
end if;

if (ie_gerar_proc_apos_cir_w = 'S') then
	select	max(b.nr_prescricao)
	into STRICT	nr_prescricao_w
	from	agenda_paciente a,
		cirurgia b
	where	a.nr_cirurgia 	= b.nr_cirurgia
	and	a.nr_sequencia 	= nr_seq_agenda_p
	and	coalesce(b.dt_inicio_real::text, '') = '';
end if;	

open c01;
loop
fetch c01	into
		nr_seq_proc_interno_w,
		cd_medico_w,
		ie_lado_w,
		cd_convenio_w,
		cd_categoria_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		qt_min_proc_w,
		cd_plano_w,
		qt_procedimento_w,
		ie_tipo_convenio_w,
		ds_observacao_ww,
		nr_prescr_mipres_w,
		dt_validity_mipres_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
begin

select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
into STRICT	ie_tem_medico_w
from 	proc_interno_cme 
where	cd_medico		= cd_medico_w
and	nr_seq_proc_interno 	= nr_seq_proc_interno_w;


select	coalesce(max(nr_seq_agenda),0) + 1
into STRICT	nr_sequencia_proc_w
from	agenda_paciente_proc
where	nr_sequencia = nr_seq_agenda_p;

	if (nr_seq_proc_interno_w > 0) then
		--obter_procedimento_tab_interna(nr_seq_proc_interno_w, nvl(cd_convenio_w,cd_convenio_agenda_w), cd_estabelecimento_p, cd_procedimento_w, ie_origem_proced_w);
		SELECT * FROM Obter_Proc_Tab_Interno_Conv(nr_seq_proc_interno_w, cd_estabelecimento_p, coalesce(cd_convenio_w,cd_convenio_agenda_w), cd_categoria_w, cd_plano_w, null, cd_procedimento_w, ie_origem_proced_w, null, clock_timestamp(), null, null, null, null, null, null, null, null) INTO STRICT cd_procedimento_w, ie_origem_proced_w;
	end if;
	
	select 	max(cd_pessoa_fisica)
	into STRICT	cd_pac_pessoa_fisica_w
	from 	agenda_paciente
	where 	nr_sequencia = nr_seq_agenda_p;

	select  max(nr_sequencia)
	into STRICT    nr_seq_prescr_mipres_w
	from    prescr_mipres
	where   nr_presc_mipres = nr_prescr_mipres_w;

  if (coalesce(nr_seq_prescr_mipres_w::text, '') = '' and obtain_user_locale(nm_usuario_p) = 'es_CO') then
    select nextval('prescr_mipres_seq') 
    into STRICT nr_seq_prescr_mipres_w 
;

    insert into prescr_mipres(
                nr_sequencia,
                nm_usuario,
                dt_atualizacao,
                dt_validity_mipres,
                nr_presc_mipres,
				ie_status,
                cd_pessoa_fisica)
    values (    nr_seq_prescr_mipres_w,
                nm_usuario_p,
                clock_timestamp(),
                dt_validity_mipres_w,
                nr_prescr_mipres_w,
				1,
				cd_pac_pessoa_fisica_w);

  end if;

	insert into agenda_paciente_proc(
		nr_sequencia,
		nr_seq_agenda,
		dt_atualizacao,
		nm_usuario,
		cd_procedimento,
		ie_origem_proced,
		nr_seq_proc_interno,
		cd_medico,
		ie_lado,
		cd_convenio,
		cd_categoria,
		qt_min_proc,
		cd_plano,
		qt_procedimento,
		ds_observacao,
		nr_seq_prescr_mipres)
	values (
		nr_seq_agenda_p,
		nr_sequencia_proc_w,
		clock_timestamp(),
		nm_usuario_p,
		cd_procedimento_w,
		ie_origem_proced_w,
		nr_seq_proc_interno_w,
		cd_medico_w,
		ie_lado_w,
		cd_convenio_w,
		cd_categoria_w,
		qt_min_proc_w,
		cd_plano_w,
		qt_procedimento_w,
		ds_observacao_ww,
		nr_seq_prescr_mipres_w);
		
	if (coalesce(nr_prescricao_w,0) > 0) then
		CALL gerar_proc_agenda_cirurgia(nr_seq_agenda_p,nr_prescricao_w,nm_usuario_p);
	end if;	

	
	if (ie_ajusta_tempo_agenda_w = 'S') then
		update	agenda_paciente
		set	nr_minuto_duracao 	= coalesce(nr_minuto_duracao,0) + coalesce(qt_min_proc_w,0)
		where	nr_sequencia 		= nr_seq_agenda_p;
	end if;	

	if (nr_seq_proc_interno_w > 0) then
		CALL gerar_agenda_proc_kit_adic(nr_seq_agenda_p,nr_seq_proc_interno_w,nm_usuario_p);
		
	end if;	
	
	
	open c02;
	loop
	fetch c02	into
			nr_seq_conjunto_w,
			qt_conjunto_w,
			ie_obrigatorio_w,
			ie_soma_proc_adic_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
	begin

		begin
		select	count(*)
		into STRICT	qt_cme_agenda_w
		from	agenda_pac_cme
		where	nr_seq_agenda	=	nr_seq_agenda_p
		and	nr_seq_conjunto	=	nr_seq_conjunto_w;
		exception
			when others then
				qt_cme_agenda_w	:= 0;
		end;		

		if	(qt_cme_agenda_w > 0 AND ie_soma_proc_adic_w = 'S')  then
			begin			
			if (ie_cme_proc_w = 'N') then			
				update	agenda_pac_cme
				set	qt_conjunto		= qt_conjunto + qt_conjunto_w
				where	nr_seq_agenda	= nr_seq_agenda_p
				and	nr_seq_conjunto	= nr_seq_conjunto_w;
			else
				insert into agenda_pac_cme(
					nr_seq_conjunto,
					qt_conjunto,
					nr_sequencia,
					nr_seq_agenda,
					dt_atualizacao,
					nm_usuario,
					ie_origem_inf,
					ie_obrigatorio,
					nr_seq_proc_interno,
					dt_atualizacao_nrec,
					nm_usuario_nrec)
				values (
					nr_seq_conjunto_w,
					qt_conjunto_w,
					nextval('agenda_pac_cme_seq'),
					nr_seq_agenda_p,
					clock_timestamp(),
					nm_usuario_p,
					'I',
					ie_obrigatorio_w,
					nr_seq_proc_interno_w,
					clock_timestamp(),
					nm_usuario_p);				
			end if;
			end;			
		elsif (qt_cme_agenda_w = 0)  then
			begin
			insert into agenda_pac_cme(
				nr_seq_conjunto,
				qt_conjunto,
				nr_sequencia,
				nr_seq_agenda,
				dt_atualizacao,
				nm_usuario,
				ie_origem_inf,
				ie_obrigatorio,
				nr_seq_proc_interno,
				dt_atualizacao_nrec,
				nm_usuario_nrec)
			values (
				nr_seq_conjunto_w,
				qt_conjunto_w,
				nextval('agenda_pac_cme_seq'),
				nr_seq_agenda_p,
				clock_timestamp(),
				nm_usuario_p,
				'I',
				ie_obrigatorio_w,
				nr_seq_proc_interno_w,
				clock_timestamp(),
				nm_usuario_p);
			end;
		end if;
	end;
	end loop;
	close c02;


	open c03;
	loop
	fetch c03	into
			nr_seq_conjunto_w,
			qt_conjunto_w,
			ie_obrigatorio_w,
			ie_soma_proc_adic_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
	begin

		begin
		select	count(*)
		into STRICT	qt_cme_agenda_w
		from	agenda_pac_cme
		where	nr_seq_agenda	=	nr_seq_agenda_p
		and	nr_seq_conjunto	=	nr_seq_conjunto_w;
		exception
			when others then
				qt_cme_agenda_w	:= 0;
		end;		

		if	(qt_cme_agenda_w > 0 AND ie_soma_proc_adic_w = 'S')  then
			begin
			if (ie_cme_proc_w = 'N') then
				update	agenda_pac_cme
				set	qt_conjunto	=	qt_conjunto + qt_conjunto_w
				where	nr_seq_agenda	=	nr_seq_agenda_p
				and	nr_seq_conjunto	=	nr_seq_conjunto_w;
			else
				insert into agenda_pac_cme(
					nr_seq_conjunto,
					qt_conjunto,
					nr_sequencia,
					nr_seq_agenda,
					dt_atualizacao,
					nm_usuario,
					ie_origem_inf,
					ie_obrigatorio,
					nr_seq_proc_interno,
					dt_atualizacao_nrec,
					nm_usuario_nrec)
				values (
					nr_seq_conjunto_w,
					qt_conjunto_w,
					nextval('agenda_pac_cme_seq'),
					nr_seq_agenda_p,
					clock_timestamp(),
					nm_usuario_p,
					'I',
					ie_obrigatorio_w,
					nr_seq_proc_interno_w,
					clock_timestamp(),
					nm_usuario_p);
			end if;
			end;
		elsif (qt_cme_agenda_w = 0)  then
			begin
			insert into agenda_pac_cme(
				nr_seq_conjunto,
				qt_conjunto,
				nr_sequencia,
				nr_seq_agenda,
				dt_atualizacao,
				nm_usuario,
				ie_origem_inf,
				ie_obrigatorio,
				nr_seq_proc_interno,
				dt_atualizacao_nrec,
				nm_usuario_nrec)
			values (
				nr_seq_conjunto_w,
				qt_conjunto_w,
				nextval('agenda_pac_cme_seq'),
				nr_seq_agenda_p,
				clock_timestamp(),
				nm_usuario_p,
				'I',
				ie_obrigatorio_w,
				nr_seq_proc_interno_w,
				clock_timestamp(),
				nm_usuario_p);
			end;
		end if;
	end;
	end loop;
	close c03;

	open c04;
	loop
	fetch c04	into
			nr_seq_conjunto_w,
			qt_conjunto_w,
			ie_obrigatorio_w,
			ie_soma_proc_adic_w;
	EXIT WHEN NOT FOUND; /* apply on c04 */
	begin

		begin
		select	count(*)
		into STRICT	qt_cme_agenda_w
		from	agenda_pac_cme
		where	nr_seq_agenda	=	nr_seq_agenda_p
		and	nr_seq_conjunto	=	nr_seq_conjunto_w;
		exception
			when others then
				qt_cme_agenda_w	:= 0;
		end;		

		if	(qt_cme_agenda_w > 0 AND ie_soma_proc_adic_w = 'S')  then
			begin
			if (ie_cme_proc_w = 'N') then
				update	agenda_pac_cme
				set	qt_conjunto	=	qt_conjunto + qt_conjunto_w
				where	nr_seq_agenda	=	nr_seq_agenda_p
				and	nr_seq_conjunto	=	nr_seq_conjunto_w;
			else
				insert into agenda_pac_cme(
					nr_seq_conjunto,
					qt_conjunto,
					nr_sequencia,
					nr_seq_agenda,
					dt_atualizacao,
					nm_usuario,
					ie_origem_inf,
					ie_obrigatorio,
					nr_seq_proc_interno,
					dt_atualizacao_nrec,
					nm_usuario_nrec)
				values (
					nr_seq_conjunto_w,
					qt_conjunto_w,
					nextval('agenda_pac_cme_seq'),
					nr_seq_agenda_p,
					clock_timestamp(),
					nm_usuario_p,
					'I',
					ie_obrigatorio_w,
					nr_seq_proc_interno_w,
					clock_timestamp(),
					nm_usuario_p);
			end if;			
			end;
		elsif (qt_cme_agenda_w = 0)  then
			begin
			insert into agenda_pac_cme(
				nr_seq_conjunto,
				qt_conjunto,
				nr_sequencia,
				nr_seq_agenda,
				dt_atualizacao,
				nm_usuario,
				ie_origem_inf,
				ie_obrigatorio,
				nr_seq_proc_interno,
				dt_atualizacao_nrec,
				nm_usuario_nrec)
			values (
				nr_seq_conjunto_w,
				qt_conjunto_w,
				nextval('agenda_pac_cme_seq'),
				nr_seq_agenda_p,
				clock_timestamp(),
				nm_usuario_p,
				'I',
				ie_obrigatorio_w,
				nr_seq_proc_interno_w,
				clock_timestamp(),
				nm_usuario_p);
			end;
		end if;
	end;
	end loop;
	close c04;
	
select 		coalesce(MAX(a.cd_setor_exclusivo),0)
into STRICT		cd_setor_equipamento_w
from		agenda a,
		agenda_paciente b
where		a.cd_agenda 	= 	b.cd_agenda
and		b.nr_sequencia	= 	nr_seq_agenda_p;
	
	open c05;
	loop
	fetch c05 into
		nr_seq_classif_equip_w,
		cd_equipamento_proc_w;
	EXIT WHEN NOT FOUND; /* apply on c05 */
		begin
		
		if (ie_consiste_w <> 'N') then
			begin
			if (nr_seq_classif_equip_w > 0) then
				ds_erro_equip_w := obter_se_classif_equip_disp(nr_seq_agenda_p, nr_seq_classif_equip_w, ds_erro_equip_w, nm_usuario_p, cd_estabelecimento_p, 0, 'S');
			elsif (cd_equipamento_proc_w > 0) then
				ds_erro_equip_w := obter_se_equip_disp_cirur(nr_seq_agenda_p, cd_equipamento_proc_w, ds_erro_equip_w, nm_usuario_p, cd_estabelecimento_p, 0, 'S');
			end if;
			if (ds_erro_equip_w IS NOT NULL AND ds_erro_equip_w::text <> '') and (coalesce(ds_erro_w::text, '') = '') then
				ds_erro_w	:= substr(ds_erro_equip_w || chr(13) || chr(10) || ds_erro_w, 1, 255);
			end if;
			end;
		end if;	
		
		if (ie_consiste_w = 'N') or (ie_consiste_w = 'A') or
			((ie_consiste_w = 'S') and (coalesce(ds_erro_equip_w::text, '') = '')) then
			begin
			select	nextval('agenda_pac_equip_seq')
			into STRICT	nr_sequencia_w
			;
			
			cd_equipamento_w	:= null;
			
			select 		a.cd_setor_exclusivo
			into STRICT		cd_setor_exclusivo_w
			from		agenda a,
						agenda_paciente b
			where		a.cd_agenda 	= 	b.cd_agenda
			and			b.nr_sequencia	= 	nr_seq_agenda_p;
					
			if (nr_seq_classif_equip_w > 0) then
				begin
				select	count(*)
				into STRICT	qt_equip_class_w
				from	equipamento
				where	cd_classificacao = nr_seq_classif_equip_w
				and 	coalesce(cd_setor_atendimento,cd_setor_exclusivo_w) = cd_setor_exclusivo_w;		
				
				if (qt_equip_class_w = 1) then
					begin
					select	cd_equipamento
					into STRICT	cd_equipamento_w
					from	equipamento
					where	cd_classificacao = nr_seq_classif_equip_w
					and 	coalesce(cd_setor_atendimento,cd_setor_exclusivo_w) = cd_setor_exclusivo_w;
					end;
				end if;
				end;
			end if;
			
			nr_seq_classif_equip_ww	:= null;		
			if (nr_seq_classif_equip_w > 0) then
				begin
				nr_seq_classif_equip_ww	:= nr_seq_classif_equip_w;
				cd_equipamento_ww	:= cd_equipamento_w;
				end;
			elsif (cd_equipamento_proc_w > 0) then
				cd_equipamento_ww	:= cd_equipamento_proc_w;
			end if;		
			
			if (ie_classif_equip_w = 'C') then
				cd_equipamento_ww	:= null;
			else
				nr_seq_classif_equip_ww	:= null;
			end if;
			
			insert into agenda_pac_equip(
				nr_seq_classif_equip,
				nr_sequencia,
				nr_seq_agenda,
				dt_atualizacao,
				nm_usuario,
				ie_origem_inf,
				cd_equipamento,
				nr_seq_proc_interno,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ie_obrigatorio)
			values (
				nr_seq_classif_equip_ww,
				nr_sequencia_w,
				nr_seq_agenda_p,
				clock_timestamp(),
				nm_usuario_p,
				'I',
				cd_equipamento_ww,
				nr_seq_proc_interno_w,
				clock_timestamp(),
				nm_usuario_p,
				'S');
			end;
		end if;	
		end;	
	end loop;
	close c05;

	open c06;
	loop
		fetch c06	into
			cd_material_w,
			qt_material_w,
			ie_padrao_w,
			cd_cgc_w,
			ds_observacao_w;
		EXIT WHEN NOT FOUND; /* apply on c06 */
		begin

			select	nextval('agenda_pac_opme_seq')
			into STRICT	nr_sequencia_w
			;

			insert into agenda_pac_opme(
				cd_material,
				qt_material,
				nr_sequencia,
				nr_seq_agenda,
				dt_atualizacao,
				nm_usuario,
				nr_seq_apres,
				ie_origem_inf,
				ie_autorizado,
				ie_padrao,
				cd_cgc,
				nr_seq_proc_interno,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_observacao)
			values (
				cd_material_w,
				qt_material_w,
				nr_sequencia_w,
				nr_seq_agenda_p,
				clock_timestamp(),
				nm_usuario_p,
				500,
				'I',
				'P',
				ie_padrao_w,
				cd_cgc_w,
				nr_seq_proc_interno_w,
				clock_timestamp(),
				nm_usuario_p,
				CASE WHEN ie_registra_observacao_w='S' THEN ds_observacao_w  ELSE null END );
				
				CALL gerar_autor_regra(null,
						null,
						null,
						null,
						null,
						null,
						'AP',
						nm_usuario_p,
						nr_seq_agenda_p,	
						null,
						null,
						null,
						nr_sequencia_w,
						null,
						'',
						'',
						'');
				
		end;
	end loop;
	close c06;

	/* Francisco - 18/06/2008 - OS 97120 */

	CALL gerar_autor_regra(null,
			null,
			null,
			null,
			null,
			null,
			'AP',
			nm_usuario_p,
			nr_seq_agenda_p,	
			null,
			null,
			null,
			null,
			nr_sequencia_proc_w,
			'',
			'',
			'');
	/*Fim Francisco - 18/06/2008 - OS 97120 */

	CALL atualizar_agenda_bolsas_sangue(nr_seq_agenda_p, nr_seq_proc_interno_w,nm_usuario_p);
	
		
end;
end loop;
close c01;

delete from w_agenda_proc_adic where cd_pessoa_fisica = cd_pessoa_usuario_w;

if (ie_gera_kit_troca_proced_w = 'S') then

	select	count(*)
	into STRICT	qt_kit_material_w
	from 	proc_interno_kit
	where 	nr_seq_proc_interno = nr_seq_proc_interno_w;	
	
	if (qt_kit_material_w > 0) then
	
		select	max(nr_sequencia)
		into STRICT	nr_seq_pedido_w
		from 	agenda_pac_pedido
		where 	nr_seq_agenda = nr_seq_agenda_p;
	
		select	count(*)
		into STRICT	qt_registro_kit_w
		from 	kit_estoque_reg
		where 	nr_seq_pedido_agenda = nr_seq_pedido_w;
	
		if (qt_registro_kit_w > 0) then
			CALL gerar_reg_kit_estoque_adic(cd_estabelecimento_p,nm_usuario_p, nr_seq_proc_interno_w,nr_seq_agenda_p);
		end if;	
	end if;	
end if;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_dados_proc_adic ( nr_seq_agenda_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

