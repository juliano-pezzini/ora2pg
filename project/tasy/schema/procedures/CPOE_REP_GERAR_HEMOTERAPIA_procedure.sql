-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_rep_gerar_hemoterapia ( nr_prescricao_p prescr_medica.nr_prescricao%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, dt_inicio_prescr_p timestamp, dt_validade_prescr_p timestamp, dt_liberacao_p timestamp, nm_usuario_p usuario.nm_usuario%type, cd_funcao_origem_p funcao.cd_funcao%type, cd_setor_atendimento_p prescr_medica.cd_setor_atendimento%type default null) AS $body$
DECLARE

			
nr_sequencia_w		cpoe_hemoterapia.nr_sequencia%type;
ie_urgencia_w		cpoe_hemoterapia.ie_urgencia%type;
ie_tipo_hemoterap_w	cpoe_hemoterapia.ie_tipo_hemoterap%type;
dt_fim_w			cpoe_hemoterapia.dt_fim%type;
dt_inicio_w			cpoe_hemoterapia.dt_inicio%type;


nr_seq_bco_san_w		prescr_solic_bco_sangue.nr_sequencia%type;
cd_doenca_cid_w			prescr_solic_bco_sangue.cd_doenca_cid%type;
ie_tipo_paciente_w		prescr_solic_bco_sangue.ie_tipo_paciente%type;
ie_tipo_w				prescr_solic_bco_sangue.ie_tipo%type;
ie_porte_cirurgico_w	prescr_solic_bco_sangue.ie_porte_cirurgico%type;	
dt_programada_w			prescr_solic_bco_sangue.dt_programada%type;
dt_programada_w2		prescr_solic_bco_sangue.dt_programada%type;
ie_trans_anterior_w		prescr_solic_bco_sangue.ie_trans_anterior%type;
dt_ultima_transf_w		prescr_solic_bco_sangue.dt_ultima_transf%type;
nr_seq_reacao_w			prescr_solic_bco_sangue.nr_seq_reacao%type;
ie_gravidez_w			prescr_solic_bco_sangue.ie_gravidez%type;
qt_gravidez_w			prescr_solic_bco_sangue.qt_gravidez%type;
qt_aborto_w				prescr_solic_bco_sangue.qt_aborto%type;
dt_cirurgia_w			prescr_solic_bco_sangue.dt_cirurgia%type;
qt_hemoglobina_w		prescr_solic_bco_sangue.qt_hemoglobina%type;
qt_hematocrito_w		prescr_solic_bco_sangue.qt_hematocrito%type;
qt_plaqueta_w			prescr_solic_bco_sangue.qt_plaqueta%type;
qt_tap_w				prescr_solic_bco_sangue.qt_tap%type;
qt_tap_inr_w			prescr_solic_bco_sangue.qt_tap_inr%type;
qt_ttpa_w				prescr_solic_bco_sangue.qt_ttpa%type;
qt_ttpa_rel_w			prescr_solic_bco_sangue.qt_ttpa_rel%type;
qt_fibrinogenio_w		prescr_solic_bco_sangue.qt_fibrinogenio%type;
cd_perfil_ativo_w		prescr_solic_bco_sangue.cd_perfil_ativo%type;
ie_reserva_w			prescr_solic_bco_sangue.ie_reserva%type;
qt_albumina_w			prescr_solic_bco_sangue.qt_albumina%type;
qt_calcio_w				prescr_solic_bco_sangue.qt_calcio%type;
qt_magnesio_w			prescr_solic_bco_sangue.qt_magnesio%type;
qt_bilirrubina_dir_w	prescr_solic_bco_sangue.qt_bilirrubina_dir%type;
qt_bilirrubina_ind_w	prescr_solic_bco_sangue.qt_bilirrubina_ind%type;
qt_hemoglobina_s_w		prescr_solic_bco_sangue.qt_hemoglobina_s%type;
qt_leucocitos_w			prescr_solic_bco_sangue.qt_leucocitos%type;

nr_seq_hemoterapia_w	prescr_procedimento.nr_sequencia%type;
nr_seq_derivado_w		prescr_procedimento.nr_seq_derivado%type;
cd_procedimento_w		prescr_procedimento.cd_procedimento%type;
ie_origem_proced_w		prescr_procedimento.ie_origem_proced%type;
nr_seq_proc_interno_w	prescr_procedimento.nr_seq_proc_interno%type;
ie_via_aplicacao_w		prescr_procedimento.ie_via_aplicacao%type;
ie_aliquotado_w			prescr_procedimento.ie_aliquotado%type;
ie_filtrado_w			prescr_procedimento.ie_filtrado%type;
ie_irradiado_w			prescr_procedimento.ie_irradiado%type;
ie_lavado_w				prescr_procedimento.ie_lavado%type;
ie_se_necessario_w		prescr_procedimento.ie_se_necessario%type;
ie_acm_w				prescr_procedimento.ie_acm%type;
qt_procedimento_w		prescr_procedimento.qt_procedimento%type;
qt_vol_hemocomp_w		prescr_procedimento.qt_vol_hemocomp%type;
qt_veloc_inf_hemo_w		prescr_procedimento.qt_veloc_inf_hemo%type;
ie_unid_med_hemo_w		prescr_procedimento.ie_unid_med_hemo%type;
cd_intervalo_w			prescr_procedimento.cd_intervalo%type;
ds_horarios_w			prescr_procedimento.ds_horarios%type;
qt_hora_infusao_w		prescr_procedimento.qt_hora_infusao%type;
qt_tempo_infusao_w		prescr_procedimento.qt_tempo_infusao%type;
ds_justificativa_w		prescr_procedimento.ds_justificativa%type;
ds_observacao_w			prescr_procedimento.ds_observacao%type;
dt_prev_execucao_w		prescr_procedimento.dt_prev_execucao%type;

nr_seq_indicacao_w		prescr_sol_bs_indicacao.nr_seq_indicacao%type;

ie_retrogrado_w			prescr_medica.ie_prescr_emergencia%type;
cd_pessoa_fisica_w		prescr_medica.cd_pessoa_fisica%type;
nm_usuario_lib_enf_w	prescr_medica.nm_usuario_lib_enf%type;
ie_fenotipado_w				prescr_procedimento.ie_fenotipado%type;
cd_medico_w				prescr_medica.cd_medico%type;

count_w			bigint := 0;
sql_w			varchar(4000);
ds_sep_bv_w		varchar(10);
ds_parametros_w		varchar(2000);
dt_liberacao_enf_w	timestamp;
			
C01 CURSOR FOR
SELECT	nr_sequencia,
	cd_doenca_cid,
	ie_tipo_paciente,
	ie_tipo,
	ie_porte_cirurgico,		
	dt_programada,
	ie_trans_anterior,
	dt_ultima_transf,
	nr_seq_reacao,	
	ie_gravidez,
	qt_gravidez,
	qt_aborto,
	dt_cirurgia,
	qt_hemoglobina,
	qt_hematocrito,
	qt_plaqueta,
	qt_tap,
	qt_tap_inr,
	qt_ttpa,
	qt_ttpa_rel,
	qt_fibrinogenio,
	cd_perfil_ativo,
	coalesce(ie_reserva,'N'),
	qt_albumina,
	qt_calcio, 
	qt_magnesio, 
	qt_bilirrubina_dir, 
	qt_bilirrubina_ind, 
	qt_hemoglobina_s,
	qt_leucocitos
from	prescr_solic_bco_sangue
where	nr_prescricao = nr_prescricao_p;

C02 CURSOR FOR	
SELECT	nr_sequencia,
	nr_seq_derivado,
	cd_procedimento,
	nr_seq_proc_interno,
	ie_origem_proced,
	CASE WHEN coalesce(nr_seq_derivado,0)=0 THEN  '1'  ELSE '0' END ,
	ie_via_aplicacao,
	coalesce(ie_aliquotado,'N'),
	coalesce(ie_filtrado,'N'),
	coalesce(ie_irradiado,'N'),
	coalesce(ie_lavado,'N'),
	coalesce(ie_fenotipado, 'N'),
	qt_procedimento,
	qt_vol_hemocomp,
	qt_veloc_inf_hemo,
	ie_unid_med_hemo,
	cd_intervalo,
	ds_horarios,
	qt_hora_infusao,
	qt_tempo_infusao,
	ds_justificativa,
	ds_observacao,
	coalesce(dt_prev_execucao,dt_inicio_prescr_p)	
from	prescr_procedimento
where	nr_prescricao = nr_prescricao_p
and	nr_seq_solic_sangue = nr_seq_bco_san_w
and (Obter_se_exibe_proced(nr_prescricao,nr_sequencia,ie_tipo_proced,'BSHE') = 'S'
or	Obter_se_exibe_proced(nr_prescricao,nr_sequencia,ie_tipo_proced,'AT') = 'S'
or 	Obter_se_exibe_proced(nr_prescricao,nr_sequencia,ie_tipo_proced,'BS') = 'S');
	
C03 CURSOR FOR
SELECT	nr_seq_indicacao
from	prescr_sol_bs_indicacao
where	nr_seq_solic_bs = nr_seq_bco_san_w  LIMIT 2;


BEGIN

select  max(coalesce(ie_prescr_emergencia,'N')),
		max(cd_pessoa_fisica),
		max(dt_liberacao),
		max(nm_usuario_lib_enf),
		max(cd_medico)
into STRICT	ie_retrogrado_w,
		cd_pessoa_fisica_w,
		dt_liberacao_enf_w,
		nm_usuario_lib_enf_w,
		cd_medico_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;			

open C01;
loop
fetch C01 into	
	nr_seq_bco_san_w,
	cd_doenca_cid_w,
	ie_tipo_paciente_w,
	ie_tipo_w,
	ie_porte_cirurgico_w,		
	dt_programada_w,
	ie_trans_anterior_w,
	dt_ultima_transf_w,
	nr_seq_reacao_w,	
	ie_gravidez_w,
	qt_gravidez_w,
	qt_aborto_w,
	dt_cirurgia_w,
	qt_hemoglobina_w,
	qt_hematocrito_w,
	qt_plaqueta_w,
	qt_tap_w,
	qt_tap_inr_w,
	qt_ttpa_w,
	qt_ttpa_rel_w,
	qt_fibrinogenio_w,
	cd_perfil_ativo_w,
	ie_reserva_w,
	qt_albumina_w,
	qt_calcio_w,
	qt_magnesio_w,
	qt_bilirrubina_dir_w,
	qt_bilirrubina_ind_w,
	qt_hemoglobina_s_w,
	qt_leucocitos_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
		open C02;
		loop
		fetch C02 into
			nr_seq_hemoterapia_w,
			nr_seq_derivado_w,
			cd_procedimento_w,
			nr_seq_proc_interno_w,
			ie_origem_proced_w,
			ie_tipo_hemoterap_w,
			ie_via_aplicacao_w,
			ie_aliquotado_w,
			ie_filtrado_w,
			ie_irradiado_w,
			ie_lavado_w,
			ie_fenotipado_w,
			qt_procedimento_w,
			qt_vol_hemocomp_w,
			qt_veloc_inf_hemo_w,
			ie_unid_med_hemo_w,
			cd_intervalo_w,
			ds_horarios_w,
			qt_hora_infusao_w,
			qt_tempo_infusao_w,
			ds_justificativa_w,
			ds_observacao_w,
			dt_prev_execucao_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
				
				select	nextval('cpoe_hemoterapia_seq')
				into STRICT	nr_sequencia_w
				;
			
				dt_programada_w2 := coalesce(dt_prev_execucao_w,dt_programada_w);
				
				if (qt_hora_infusao_w IS NOT NULL AND qt_hora_infusao_w::text <> '') or (qt_tempo_infusao_w IS NOT NULL AND qt_tempo_infusao_w::text <> '') then
					dt_fim_w :=  dt_programada_w2 + coalesce(qt_hora_infusao_w,0) * 1/24 + coalesce(qt_tempo_infusao_w,0) * 1/1440;
				else
					dt_fim_w :=  dt_programada_w2 + 1;					
				end if;
				
				dt_inicio_w := to_date(dt_programada_w2,'dd/mm/yyyy hh24:mi:ss');
				
				if ((ie_tipo_w = 4) or (ie_urgencia_w = 'S')) then
					ie_urgencia_w		:= '0';
				end if;
							
				insert into cpoe_hemoterapia(
							nr_sequencia,
							nr_atendimento,
							cd_doenca_cid,
							ie_trans_anterior,
							dt_ultima_transf,
							nr_seq_reacao,
							ie_gravidez,
							qt_gravidez,
							qt_aborto,
							ie_tipo_paciente,
							ie_porte_cirurgico,
							dt_cirurgia,
							qt_hemoglobina,
							qt_hematocrito,
							qt_plaqueta,
							qt_tap,
							qt_tap_inr,
							qt_ttpa,
							qt_ttpa_rel,
							qt_fibrinogenio,
							ie_tipo_hemoterap,
							nr_seq_derivado,
							cd_procedimento,
							nr_seq_proc_interno,
							ie_origem_proced,
							ie_via_aplicacao,
							qt_procedimento,
							qt_vol_hemocomp,
							qt_hora_min_infusao,
							qt_veloc_inf_hemo,
							ie_unid_med_hemo,
							cd_intervalo,
							ie_aliquotado,
							ie_filtrado,
							ie_irradiado,
							ie_lavado,
							ds_justificativa,
							ds_observacao_proc,
							ie_tipo,
							dt_programada,
							ds_horarios,
							ie_urgencia,
							ds_observacao,
							nm_usuario,
							nm_usuario_nrec,
							dt_atualizacao,
							dt_atualizacao_nrec,
							cd_perfil_ativo,
							dt_liberacao,
							dt_fim,
							dt_prox_geracao,
							ie_reserva,
							cd_funcao_origem,
							cd_setor_atendimento,
							ie_retrogrado,
							qt_albumina,
							qt_calcio, 
							qt_magnesio, 
							qt_bilirrubina_dir, 
							qt_bilirrubina_ind, 
							qt_hemoglobina_s,
							qt_leucocitos,
							cd_pessoa_fisica,
							dt_liberacao_enf,
							nm_usuario_lib_enf,
							cd_medico
						) values (
							nr_sequencia_w,
							nr_atendimento_p,							
							cd_doenca_cid_w,
							ie_trans_anterior_w,
							dt_ultima_transf_w,
							nr_seq_reacao_w,
							ie_gravidez_w,
							qt_gravidez_w,
							qt_aborto_w,
							CASE WHEN ie_tipo_paciente_w='CL' THEN  'C'  ELSE 'I' END , 
							ie_porte_cirurgico_w,
							dt_cirurgia_w,
							qt_hemoglobina_w,
							qt_hematocrito_w,
							qt_plaqueta_w,
							qt_tap_w,
							qt_tap_inr_w,
							qt_ttpa_w,
							qt_ttpa_rel_w,
							qt_fibrinogenio_w,
							ie_tipo_hemoterap_w,
							nr_seq_derivado_w,
							cd_procedimento_w,
							nr_seq_proc_interno_w,
							ie_origem_proced_w,
							ie_via_aplicacao_w,
							qt_procedimento_w,
							qt_vol_hemocomp_w,
							lpad(substr(coalesce(qt_hora_infusao_w,0),1,2), 2, '0') || ':' ||  lpad(substr(coalesce(qt_tempo_infusao_w,0),1,2), 2, '0'),
							qt_veloc_inf_hemo_w,
							ie_unid_med_hemo_w,
							cd_intervalo_w,
							ie_aliquotado_w,
							ie_filtrado_w,
							ie_irradiado_w,
							ie_lavado_w,
							ds_justificativa_w,
							ds_observacao_w,
							ie_tipo_w,
							dt_programada_w2,
							ds_horarios_w,
							ie_urgencia_w,
							ds_observacao_w,
							nm_usuario_p,
							nm_usuario_p,
							clock_timestamp(),
							clock_timestamp(),
							cd_perfil_ativo_w,
							dt_liberacao_p,
							dt_fim_w,
							dt_inicio_w + 12/24,
							ie_reserva_w,
							cd_funcao_origem_p,
							cd_setor_atendimento_p,
							ie_retrogrado_w,
							qt_albumina_w,
							qt_calcio_w,
							qt_magnesio_w,
							qt_bilirrubina_dir_w,
							qt_bilirrubina_ind_w,
							qt_hemoglobina_s_w,
							qt_leucocitos_w,
							cd_pessoa_fisica_w,
							dt_liberacao_enf_w,
							nm_usuario_lib_enf_w,
							cd_medico_w);
							
				ds_sep_bv_w	:= obter_separador_bv;

				open C03;
				loop
				fetch C03 into	
					nr_seq_indicacao_w;
				EXIT WHEN NOT FOUND; /* apply on C03 */
					begin				
					count_w := count_w + 1;
					
					ds_parametros_w	:= 	'nr_seq_indicacao=' || nr_seq_indicacao_w || ds_sep_bv_w||
										'nr_sequencia=' || nr_sequencia_w || ds_sep_bv_w;
					
					sql_w :='	update	cpoe_hemoterapia '||
							'	set		nr_seq_indicacao'||count_w||' = :nr_seq_indicacao'||
							'  where nr_sequencia = :nr_sequencia';
					
					CALL exec_sql_dinamico_bv('', sql_w, ds_parametros_w);
					
					end;
				end loop;
				close C03;	
				
				count_w := 0;
			
				update	prescr_procedimento
				set	nr_seq_proc_cpoe = nr_sequencia_w
				where	nr_sequencia = nr_seq_hemoterapia_w
				and	nr_prescricao = nr_prescricao_p;
				

	
			end;
		end loop;
		close C02;
	
	end;
end loop;
close C01;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_rep_gerar_hemoterapia ( nr_prescricao_p prescr_medica.nr_prescricao%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, dt_inicio_prescr_p timestamp, dt_validade_prescr_p timestamp, dt_liberacao_p timestamp, nm_usuario_p usuario.nm_usuario%type, cd_funcao_origem_p funcao.cd_funcao%type, cd_setor_atendimento_p prescr_medica.cd_setor_atendimento%type default null) FROM PUBLIC;

