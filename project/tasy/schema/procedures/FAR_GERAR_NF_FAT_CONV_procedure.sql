-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE far_gerar_nf_fat_conv ( nr_seq_faturamento_p bigint, nr_nota_fiscal_p bigint, cd_serie_nf_p text, cd_operacao_nf_p bigint, cd_condicao_pagamento_p bigint, cd_natureza_operacao_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_nf_p INOUT bigint) AS $body$
DECLARE


nr_seq_contrato_w	bigint;
cd_cgc_w		varchar(14);
cd_cgc_emitente_w	varchar(14);
nr_sequencia_w		bigint;

nr_seq_pedido_w		bigint;
vl_total_pedido_w		double precision;
cd_conta_contabil_w	varchar(20);
cd_centro_custo_w	integer;
nr_item_nf_w		bigint;

vl_total_nf_w		double precision;

c01 CURSOR FOR
SELECT	nr_seq_pedido
from	far_pedido_fatur
where	nr_seq_fatur = nr_seq_faturamento_p;


BEGIN

select	nr_seq_contrato
into STRICT	nr_seq_contrato_w
from	far_contrato_fatur
where	nr_sequencia = nr_seq_faturamento_p;

select	cd_cnpj
into STRICT	cd_cgc_w
from	far_contrato_conv a,
	far_convenio_venda b
where	a.nr_sequencia = nr_seq_contrato_w
and	b.nr_sequencia = a.nr_seq_conv_venda;

select	cd_cgc
into STRICT	cd_cgc_emitente_w
from	estabelecimento_v
where	cd_estabelecimento = cd_estabelecimento_p;

select	nextval('nota_fiscal_seq')
into STRICT	nr_sequencia_w
;

insert into nota_fiscal(
	nr_sequencia,
	cd_estabelecimento,
	cd_cgc_emitente,
	cd_serie_nf,
	nr_sequencia_nf,
	cd_operacao_nf,
	dt_emissao,
	dt_entrada_saida,
	ie_acao_nf,
	ie_emissao_nf,
	ie_tipo_frete,
	vl_mercadoria,
	vl_total_nota,
	qt_peso_bruto,
	qt_peso_liquido,
	dt_atualizacao,
	nm_usuario,
	cd_condicao_pagamento,
	cd_cgc,
	vl_descontos,
	vl_frete,
	vl_seguro,
	vl_despesa_acessoria,
	cd_natureza_operacao,
	vl_desconto_rateio,
	ie_situacao,
	nr_lote_contabil,
	ie_entregue_bloqueto,
	ie_tipo_nota,
	nr_nota_fiscal,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	vl_despesa_doc) values (
		nr_sequencia_w,
		cd_estabelecimento_p,
		cd_cgc_emitente_w,
		cd_serie_nf_p,
		1,
		cd_operacao_nf_p,
		trunc(clock_timestamp()),
		clock_timestamp(),
		1,
		0,
		0,
		0,
		0,
		0,
		0,
		clock_timestamp(),
		nm_usuario_p,
		cd_condicao_pagamento_p,
		cd_cgc_w,
		0,
		0,
		0,
		0,
		cd_natureza_operacao_p,
		0,
		1,
		0,
		'N',
		'SE',
		nr_nota_fiscal_p,
		clock_timestamp(),
		nm_usuario_p,
		0);

open c01;
loop
fetch c01 into
	nr_seq_pedido_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	select	max(vl_total)
	into STRICT	vl_total_pedido_w
	from	far_pedido
	where	nr_sequencia = nr_seq_pedido_w;

	SELECT * FROM Define_Conta_Procedimento(	cd_estabelecimento_p, cd_procedimento_p, ie_origem_proced_p, 3, null, null, null, null, null, null, null, clock_timestamp(), cd_conta_contabil_w, cd_centro_custo_w, null, 'N') INTO STRICT cd_conta_contabil_w, cd_centro_custo_w;

	select	coalesce(max(nr_item_nf),0) + 1
	into STRICT	nr_item_nf_w
	from	nota_fiscal_item
	where	nr_sequencia = nr_sequencia_w;

	insert into nota_fiscal_item(
			nr_sequencia,
			cd_estabelecimento,
			cd_cgc_emitente,
			cd_serie_nf,
			nr_sequencia_nf,
			nr_item_nf,
			cd_natureza_operacao,
			qt_item_nf,
			vl_unitario_item_nf,
			vl_total_item_nf,
			dt_atualizacao,
			nm_usuario,
			vl_frete,
			vl_desconto,
			vl_despesa_acessoria,
			cd_procedimento,
			qt_item_estoque,
			cd_conta_contabil,
			cd_centro_custo,
			vl_desconto_rateio,
			vl_seguro,
			vl_liquido,
			pr_desconto,
			pr_desc_financ,
			vl_desc_financ,
			nr_nota_fiscal,
			ds_observacao,
			cd_sequencia_parametro) values (
				nr_sequencia_w,
				cd_estabelecimento_p,
				cd_cgc_emitente_w,
				cd_serie_nf_p,
				1,
				nr_item_nf_w,
				cd_natureza_operacao_p,
				1,
				vl_total_pedido_w,
				vl_total_pedido_w,
				clock_timestamp(),
				nm_usuario_p,
				0,
				0,
				0,
				cd_procedimento_p,
				1,
				cd_conta_contabil_w,
				cd_centro_custo_w,
				0,
				0,
				0,
				0,
				0,
				0,
				nr_nota_fiscal_p,
				WHEB_MENSAGEM_PCK.get_texto(804664) || ' ' || nr_seq_pedido_w,
				philips_contabil_pck.get_parametro_conta_contabil);

	end;
end loop;
close c01;

select	sum(vl_total_item_nf)
into STRICT	vl_total_nf_w
from	nota_fiscal_item
where	nr_sequencia = nr_sequencia_w;

update	nota_fiscal
set	vl_mercadoria = vl_total_nf_w,
	vl_total_nota = vl_total_nf_w
where	nr_sequencia = nr_sequencia_w;

update	far_contrato_fatur
set	nr_seq_nota = nr_sequencia_w
where	nr_sequencia = nr_seq_faturamento_p;

commit;

nr_seq_nf_p	:= nr_sequencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE far_gerar_nf_fat_conv ( nr_seq_faturamento_p bigint, nr_nota_fiscal_p bigint, cd_serie_nf_p text, cd_operacao_nf_p bigint, cd_condicao_pagamento_p bigint, cd_natureza_operacao_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_nf_p INOUT bigint) FROM PUBLIC;

