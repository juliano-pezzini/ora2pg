-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_criar_alterar_jobs (nr_seq_log_erro_p bigint) AS $body$
DECLARE


JOBNO 		 	bigint;
contador_w   	bigint;
ds_comando_w 	varchar(100);
ds_erro_w	 	varchar(512);
nm_job_w		varchar(30);
nr_job_w   		bigint;
nr_job_ww		bigint;
qt_registro_w		bigint;


BEGIN
	begin
	ds_comando_w := 'select nvl(max(job),0) from job_v where upper(comando) like upper(:ds)';

	/*Coelho 03/07/2008 - Criar Job para log Conexao*/

	nm_job_w :='GERAR_LOG_CONEXAO';
	nr_job_w := obter_valor_dinamico_bv(ds_comando_w, 'DS=%'||nm_job_w||'%', nr_job_w);
	if (nr_job_w = 0 ) then
		DBMS_JOB.SUBMIT(JOBNO
                   ,'GERAR_LOG_CONEXAO;'
                   ,clock_timestamp() + (1/24)
                   ,'(SYSDATE + (15/1440))'
                   );
	else
		nr_job_ww := obter_valor_dinamico_bv(ds_comando_w || ' and length(ult_exec) > 1', 'DS=%'||nm_job_w||'%', nr_job_ww);
		if (nr_job_ww = 0 ) then
			DBMS_JOB.CHANGE(nr_job_w
        	           ,'GERAR_LOG_CONEXAO;'
                	   ,clock_timestamp() + (1/24)
	                   ,'(SYSDATE + (15/1440))'
        	           );

		end if;
	end if;

	/*jpweiss 04/06/2014  - Remover Atualizar_indices - OS 744670*/

	nm_job_w :='ATUALIZAR_INDICES';
	nr_job_w := obter_valor_dinamico_bv(ds_comando_w, 'DS=%'||nm_job_w||'%', nr_job_w);
	if (nr_job_w > 0 ) then
		DBMS_JOB.remove(nr_job_w);
	end if;

	/*Coelho 03/07/2008 - Remover JOB VALIDA_OBJETOS_SISTEMA*/

	nm_job_w :='VALIDA_OBJETOS_SISTEMA';
	nr_job_w := obter_valor_dinamico_bv(ds_comando_w, 'DS=%'||nm_job_w||'%', nr_job_w);
	if (nr_job_w > 0 ) then
		DBMS_JOB.remove(nr_job_w);
	end if;

	/*Coelho 24/09/2008 - Remover job GERAR_INF_BASE_CLIENTE*/

	nm_job_w :='GERAR_INF_BASE_CLIENTE';
	nr_job_w := obter_valor_dinamico_bv(ds_comando_w, 'DS='||nm_job_w||'%', nr_job_w);
	if (nr_job_w > 0 ) then
		DBMS_JOB.remove(nr_job_w);
	end if;

	/*Coelho 24/09/2008 - Criar Job para log GERAR_INF_BASE_CLIENTE*/

	nm_job_w :='GERAR_INF_BASE_CLIENTE';
	nr_job_w := obter_valor_dinamico_bv(ds_comando_w, 'DS=%'||nm_job_w||'%', nr_job_w);
	if (nr_job_w = 0 ) then
		DBMS_JOB.SUBMIT(JOBNO
                   ,'declare nr number(10); begin GERAR_INF_BASE_CLIENTE(nr); end;'
                   ,clock_timestamp() + interval '1 days'/1440
                   ,'(trunc(SYSDATE) + 1 + (1/24))'
                   );
	end if;

	/* Fernando 26/10/2011 */

	nm_job_w := 'LIMPAR_TABELA_LOG_TASY';
	nr_job_w := obter_valor_dinamico_bv(ds_comando_w, 'DS=%'||nm_job_w||'%', nr_job_w);
	if (nr_job_w > 0 ) then
		DBMS_JOB.remove(nr_job_w);
	end	if;

	/* Fernando 26/10/2011 */

	nm_job_w := 'LIMPAR_TABELAS';
	nr_job_w := obter_valor_dinamico_bv(ds_comando_w, 'DS=%'||nm_job_w||'%', nr_job_w);
	if (nr_job_w = 0 ) then
		DBMS_JOB.SUBMIT(JOBNO
                   ,'LIMPAR_TABELAS;'
                   ,trunc(clock_timestamp()) + 3/24
                   ,'(trunc(SYSDATE+1) + (3/24))'
                   );
	end if;

	/*Fabrício 14/06/2012 - Criar Job para Atualizar NR_SEQUENCIA da tabela BRASINDICE_PRECO*/

	nm_job_w :='ATUALIZA_SEQ_BRASINDICE_PRECO';
	nr_job_w := obter_valor_dinamico_bv(ds_comando_w, 'DS=%'||nm_job_w||'%', nr_job_w);
	if (nr_job_w = 0 ) then
		DBMS_JOB.SUBMIT(JOBNO
                   ,'ATUALIZA_SEQ_BRASINDICE_PRECO;'
                   ,clock_timestamp()
		   ,'TRUNC(SYSDATE + 1) + 01/24'
                   );
	end if;


	/*Fabrício 20/05/2013 - Criar Job para Limpar a tabela de CONPACI_LOG_ESTORNO  OS 590452 e 593093*/

	nm_job_w :='LIMPAR_CONPACI_LOG_ESTORNO';
	nr_job_w := obter_valor_dinamico_bv(ds_comando_w, 'DS=%'||nm_job_w||'%', nr_job_w);
	if (nr_job_w = 0 ) then
		DBMS_JOB.SUBMIT(JOBNO
                   ,'LIMPAR_CONPACI_LOG_ESTORNO;'
                   ,clock_timestamp()
		   ,'TRUNC(SYSDATE + 1) + 01/24'
                   );
	end if;

	/*lhalves 20/06/2012 - Criar Job para Atualizar DT_AGENDA , CD_PESSOA_FISICA e CD_ESTABELECIMENTO da tabela AUTORIZACAO_CONVENIO*/

	nm_job_w :='ATUALIZAR_CAMPOS_AUTORIZACAO';
	nr_job_w := obter_valor_dinamico_bv(ds_comando_w, 'DS=%'||nm_job_w||'%', nr_job_w);
	IF (nr_job_w = 0 ) THEN
		DBMS_JOB.SUBMIT(JOBNO
                   ,'ATUALIZAR_CAMPOS_AUTORIZACAO;'
                   ,clock_timestamp()
		   ,'TRUNC(SYSDATE + 1) + 02/24'
                   );
	END IF;

	/*Coelho 09/10/2008 - Criar Job para log LIMPAR_LOG_INTEGRACAO_SISTEMAS*/

	/*Verifica se a JOB está invalida, se estiver vai tentar valida*/

	nm_job_w :='LIMPAR_LOG_INTEGRACAO_SISTEMAS';
	nr_job_w := obter_valor_dinamico_bv(ds_comando_w, 'DS=%'||nm_job_w||'%', nr_job_w);

	select	count(*)
	into STRICT	qt_registro_w
	from	job_v
	where	comando = 'LIMPAR_LOG_INTEGRACAO_SISTEMAS;';

	if (qt_registro_w > 0) then
		DBMS_JOB.REMOVE(nr_job_w);
		commit;
	end if;



	if (nr_job_w = 0 ) then
		select	count(*)
		into STRICT	qt_registro_w
		from	objetos_invalidos_v
		where	nm_objeto = 'LIMPAR_LOG_INTEGRACAO_SISTEMAS';

		if (qt_registro_w > 0) then
			CALL exec_sql_dinamico('Everton', 'alter procedure LIMPAR_LOG_INTEGRACAO_SISTEMAS compile '
);
		end if;

	/*Faz a criação da JOB se não estiver invalida*/

		select	count(*)
		into STRICT	qt_registro_w
		from	objetos_invalidos_v
		where	upper(nm_objeto) = 'LIMPAR_LOG_INTEGRACAO_SISTEMAS';
		if (qt_registro_w = 0) then
			DBMS_JOB.SUBMIT(JOBNO
                  		,'limpar_log_integracao_sistemaS;'
                   		, trunc(clock_timestamp() + interval '1 days')+2/24
                   		,'(trunc(SYSDATE+1) + (2/24))'
                   		);
		end if;
	end if;

	exception
	when others then
		ds_erro_w	:= SQLERRM(SQLSTATE);
		CALL GRAVAR_LOG_ATUALIZACAO_ERRO(nr_seq_log_erro_p,'tasy_criar_alterar_jobs',ds_erro_w,'Tasy');
	end;

	commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_criar_alterar_jobs (nr_seq_log_erro_p bigint) FROM PUBLIC;

