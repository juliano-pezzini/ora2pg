-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_proc_autorizado (nr_cirurgia_p bigint, nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
nr_atendimento_w	bigint;
nr_seq_proc_interno_w	bigint;
qt_autorizada_w		double precision;
cd_medico_exec_w		varchar(10);
nr_seq_prescr_procedimento_w  prescr_procedimento.nr_sequencia%type;


BEGIN

if (coalesce(obter_se_usuario_medico(nm_usuario_p),'N') = 'S') then
	cd_medico_exec_w := obter_pessoa_fisica_usuario(nm_usuario_p,'C');
else
	cd_medico_exec_w := obter_medico_cirurgia(nr_cirurgia_p,'C');
end if;	

select	coalesce(max(nr_sequencia), 0) + 1
into STRICT	nr_seq_prescr_procedimento_w
from	prescr_procedimento
where	nr_prescricao	= nr_prescricao_p;
	
insert into prescr_procedimento(
		nr_prescricao,
		nr_sequencia,
		nr_seq_proc_interno,
		cd_procedimento,
		ie_origem_proced,
		cd_medico_exec,
		qt_procedimento,
		ie_urgencia,
		ie_suspenso,
		ie_status_atend,
		dt_atualizacao,
		nm_usuario,
		ie_origem_inf,
		nr_seq_interno,
		ie_avisar_result,
		cd_motivo_baixa)
	(SELECT nr_prescricao_p,
		nr_seq_prescr_procedimento_w,
		a.nr_seq_proc_interno,
		a.cd_procedimento,
		a.ie_origem_proced,
		cd_medico_exec_w,
		coalesce(a.qt_autorizada,0),
		'N',
		'N',
		5,
		clock_timestamp(),
		nm_usuario_p,
		'1',
		nextval('prescr_procedimento_seq'),
		'N',
		0
	from    procedimento_autorizado a,
		autorizacao_convenio b,
		agenda_paciente c,
		cirurgia d
	where 	a.nr_sequencia_autor    = b.nr_sequencia
	and	c.nr_sequencia = b.nr_seq_agenda
	and	d.nr_cirurgia = c.nr_cirurgia
	and	d.nr_cirurgia = nr_cirurgia_p
	and not exists (select	w.cd_procedimento_princ
			from	cirurgia w
			where	w.cd_procedimento_princ = a.cd_procedimento
			and	w.ie_origem_proced		= a.ie_origem_proced
			and	coalesce(w.nr_seq_proc_interno,0)	= coalesce(a.nr_seq_proc_interno,0)
			and	w.nr_cirurgia = nr_cirurgia_p)
	and not exists (select	v.cd_procedimento
			from	prescr_procedimento v
			where	a.cd_procedimento	 	= v.cd_procedimento
			and	a.ie_origem_proced		=  v.ie_origem_proced
			and	coalesce(a.nr_seq_proc_interno,0)	= coalesce(v.nr_seq_proc_interno,0)
			and	d.nr_prescricao = v.nr_prescricao));
	commit;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_proc_autorizado (nr_cirurgia_p bigint, nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

