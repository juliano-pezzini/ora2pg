-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE configurar_cirurgia_flowsheet ( nr_cirurgia_p bigint, nr_seq_pepo_p bigint, nr_seq_modelo_p bigint, nm_usuario_p text) AS $body$
DECLARE

										
c_secao_nova CURSOR FOR
SELECT  coalesce(a.ie_modo_visualizacao, 'VI') ie_modo_visualizacao,
		a.nr_sequencia,
		a.nr_seq_apresentacao,
		a.ds_titulo,
		a.ie_sumarizado,
    a.cd_secao
from 	pepo_modelo_secao a
where 	a.nr_seq_modelo = nr_seq_modelo_p
and not exists (	select 1
				from 	w_flowsheet_config_grupo b 
				where 	b.nr_seq_modelo_secao = a.nr_sequencia
				and		coalesce(b.nr_cirurgia,0) = coalesce(nr_cirurgia_p,0)
				and 	coalesce(b.nr_seq_pepo,0) = coalesce(nr_seq_pepo_p, 0)
				and 	b.nm_usuario  	= nm_usuario_p
				and 	b.nr_seq_modelo = nr_seq_modelo_p
				);

c_scales CURSOR(nr_seq_grupo_p  w_flowsheet_config_escalas.nr_seq_config_grupo%type) FOR 
SELECT vl_max_escala_1,vl_max_escala_2,vl_max_escala_3,vl_max_escala_4,vl_max_escala_padrao,vl_min_escala_1,vl_min_escala_2,vl_min_escala_3
,vl_min_escala_4,vl_min_escala_padrao,vl_intervalo_escala_1,vl_intervalo_escala_2,vl_intervalo_escala_3,vl_intervalo_escala_4
,vl_intervalo_escala_padrao,ds_cor_escala_1,ds_cor_escala_2,ds_cor_escala_3,ds_cor_escala_4,ds_cor_escala_padrao
,ie_eixo_adicional_1,ie_eixo_adicional_2,ie_eixo_adicional_3,ie_eixo_adicional_4 
from pepo_modelo_regra_escala 
where nr_seq_modelo = nr_seq_modelo_p
and not exists (SELECT 1 
                  from w_flowsheet_config_escalas
                  where nr_seq_config_grupo = nr_seq_grupo_p
                  );

nr_seq_config_grupo_w bigint;
nr_seq_grupo_w w_flowsheet_config_grupo.nr_sequencia%type;

type vl_max_escala_1_w            is table of pepo_modelo_regra_escala.vl_max_escala_1%type index by integer;
type vl_max_escala_2_w            is table of pepo_modelo_regra_escala.vl_max_escala_2%type index by integer;
type vl_max_escala_3_w            is table of pepo_modelo_regra_escala.vl_max_escala_3%type index by integer;
type vl_max_escala_4_w            is table of pepo_modelo_regra_escala.vl_max_escala_4%type index by integer;
type vl_max_escala_padrao_w       is table of pepo_modelo_regra_escala.vl_max_escala_padrao%type index by integer;
type vl_min_escala_1_w            is table of pepo_modelo_regra_escala.vl_min_escala_1%type index by integer;
type vl_min_escala_2_w            is table of pepo_modelo_regra_escala.vl_min_escala_2%type index by integer;
type vl_min_escala_3_w            is table of pepo_modelo_regra_escala.vl_min_escala_3%type index by integer;
type vl_min_escala_4_w            is table of pepo_modelo_regra_escala.vl_min_escala_4%type index by integer;
type vl_min_escala_padrao_w       is table of pepo_modelo_regra_escala.vl_min_escala_padrao%type index by integer;
type vl_intervalo_escala_1_w      is table of pepo_modelo_regra_escala.vl_intervalo_escala_1%type index by integer;
type vl_intervalo_escala_2_w      is table of pepo_modelo_regra_escala.vl_intervalo_escala_2%type index by integer;
type vl_intervalo_escala_3_w      is table of pepo_modelo_regra_escala.vl_intervalo_escala_3%type index by integer;
type vl_intervalo_escala_4_w      is table of pepo_modelo_regra_escala.vl_intervalo_escala_4%type index by integer;
type vl_intervalo_escala_padrao_w is table of pepo_modelo_regra_escala.vl_intervalo_escala_padrao%type index by integer;
type ds_cor_escala_1_w            is table of pepo_modelo_regra_escala.ds_cor_escala_1%type index by integer;
type ds_cor_escala_2_w            is table of pepo_modelo_regra_escala.ds_cor_escala_2%type index by integer;
type ds_cor_escala_3_w            is table of pepo_modelo_regra_escala.ds_cor_escala_3%type index by integer;
type ds_cor_escala_4_w            is table of pepo_modelo_regra_escala.ds_cor_escala_4%type index by integer;
type ds_cor_escala_padrao_w       is table of pepo_modelo_regra_escala.ds_cor_escala_padrao%type index by integer;
type ie_eixo_adicional_1_w        is table of pepo_modelo_regra_escala.ie_eixo_adicional_1%type index by integer;
type ie_eixo_adicional_2_w        is table of pepo_modelo_regra_escala.ie_eixo_adicional_2%type index by integer;
type ie_eixo_adicional_3_w        is table of pepo_modelo_regra_escala.ie_eixo_adicional_3%type index by integer;
type ie_eixo_adicional_4_w        is table of pepo_modelo_regra_escala.ie_eixo_adicional_4%type index by integer;

a_vl_max_escala_1            vl_max_escala_1_w;
a_vl_max_escala_2            vl_max_escala_2_w;
a_vl_max_escala_3            vl_max_escala_3_w;
a_vl_max_escala_4            vl_max_escala_4_w;
a_vl_max_escala_padrao       vl_max_escala_padrao_w;
a_vl_min_escala_1            vl_min_escala_1_w;
a_vl_min_escala_2            vl_min_escala_2_w;
a_vl_min_escala_3            vl_min_escala_3_w;
a_vl_min_escala_4            vl_min_escala_4_w;
a_vl_min_escala_padrao       vl_min_escala_padrao_w;
a_vl_intervalo_escala_1      vl_intervalo_escala_1_w;
a_vl_intervalo_escala_2      vl_intervalo_escala_2_w;
a_vl_intervalo_escala_3      vl_intervalo_escala_3_w;
a_vl_intervalo_escala_4      vl_intervalo_escala_4_w;
a_vl_intervalo_escala_padrao vl_intervalo_escala_padrao_w;
a_ds_cor_escala_1            ds_cor_escala_1_w;
a_ds_cor_escala_2            ds_cor_escala_2_w;
a_ds_cor_escala_3            ds_cor_escala_3_w;
a_ds_cor_escala_4            ds_cor_escala_4_w;
a_ds_cor_escala_padrao       ds_cor_escala_padrao_w;
a_ie_eixo_adicional_1        ie_eixo_adicional_1_w;
a_ie_eixo_adicional_2        ie_eixo_adicional_2_w;
a_ie_eixo_adicional_3        ie_eixo_adicional_3_w;
a_ie_eixo_adicional_4        ie_eixo_adicional_4_w;

BEGIN
if (nr_seq_modelo_p IS NOT NULL AND nr_seq_modelo_p::text <> '') then
update  w_flowsheet_config_grupo a
set 	a.ds_titulo		       = (SELECT max(b.ds_titulo) from pepo_modelo_secao b where a.nr_seq_modelo_secao = b.nr_sequencia),
		a.nr_seq_apresentacao  = (select max(b.nr_seq_apresentacao) from pepo_modelo_secao b where a.nr_seq_modelo_secao = b.nr_sequencia),
		a.nm_usuario  	 	   = nm_usuario_p,
		a.dt_atualizacao 	   = clock_timestamp()
where coalesce(a.nr_cirurgia,0) 	 = coalesce(nr_cirurgia_p,0)
and 	coalesce(a.nr_seq_pepo,0) = coalesce(nr_seq_pepo_p, 0)
and 	a.nm_usuario  		 = nm_usuario_p
and 	a.nr_seq_modelo 	 = nr_seq_modelo_p;	

<<read_secao_nova>>
for r_secao_nova in c_secao_nova
	loop
	select   nextval('w_flowsheet_config_grupo_seq')
	into STRICT     nr_seq_config_grupo_w
	;	
	
	insert into w_flowsheet_config_grupo(nr_sequencia,
										dt_atualizacao,
										nm_usuario,
										dt_atualizacao_nrec,
										nm_usuario_nrec,
										nr_cirurgia,
										nr_seq_pepo,
										nr_seq_modelo,
										ie_modo_visualizacao,
										nr_seq_modelo_secao,
										nr_seq_apresentacao,
										ds_titulo,
										ie_sumarizado
										)
	values (nr_seq_config_grupo_w,
										clock_timestamp(),
										nm_usuario_p,
										clock_timestamp(),
										nm_usuario_p,
										nr_cirurgia_p,
										nr_seq_pepo_p,
										nr_seq_modelo_p,
										r_secao_nova.ie_modo_visualizacao,
										r_secao_nova.nr_sequencia,
										r_secao_nova.nr_seq_apresentacao,
										r_secao_nova.ds_titulo,
										r_secao_nova.ie_sumarizado
										);									
end loop read_secao_nova;


select max(b.nr_sequencia) into STRICT nr_seq_grupo_w
				from 	w_flowsheet_config_grupo b, pepo_modelo_secao  p
				where b.nr_seq_modelo_secao = p.nr_sequencia
        and		coalesce(b.nr_cirurgia,0) = coalesce(nr_cirurgia_p,0)
				and 	coalesce(b.nr_seq_pepo,0) = coalesce(nr_seq_pepo_p, 0)
				and 	b.nm_usuario  	= nm_usuario_p
				and 	b.nr_seq_modelo = nr_seq_modelo_p
        and   p.cd_secao = 'SV';

if (nr_seq_grupo_w IS NOT NULL AND nr_seq_grupo_w::text <> '') then

	open c_scales(nr_seq_grupo_w);
	fetch c_scales bulk collect into a_vl_max_escala_1,a_vl_max_escala_2,a_vl_max_escala_3,a_vl_max_escala_4,a_vl_max_escala_padrao,a_vl_min_escala_1,
									 a_vl_min_escala_2,a_vl_min_escala_3,a_vl_min_escala_4,a_vl_min_escala_padrao,a_vl_intervalo_escala_1,a_vl_intervalo_escala_2,
								     a_vl_intervalo_escala_3,a_vl_intervalo_escala_4,a_vl_intervalo_escala_padrao,a_ds_cor_escala_1,a_ds_cor_escala_2,a_ds_cor_escala_3,
									 a_ds_cor_escala_4,a_ds_cor_escala_padrao,a_ie_eixo_adicional_1,a_ie_eixo_adicional_2,a_ie_eixo_adicional_3,a_ie_eixo_adicional_4 limit 1000;
	close c_scales;
	
	forall i in a_vl_max_escala_padrao.first..a_vl_max_escala_padrao.last
		insert into w_flowsheet_config_escalas(NR_SEQUENCIA,
												DT_ATUALIZACAO,
												NM_USUARIO,
												DT_ATUALIZACAO_NREC,
												NM_USUARIO_NREC,
												NR_SEQ_CONFIG_GRUPO,
												VL_MAX_ESCALA_PADRAO,
												VL_MAX_ESCALA_1,
												VL_MAX_ESCALA_2,
												VL_MAX_ESCALA_3,
												VL_MAX_ESCALA_4,
												VL_MIN_ESCALA_PADRAO,
												VL_MIN_ESCALA_1,
												VL_MIN_ESCALA_2,
												VL_MIN_ESCALA_3,
												VL_MIN_ESCALA_4,
												VL_INTERVALO_ESCALA_PADRAO,
												VL_INTERVALO_ESCALA_1,
												VL_INTERVALO_ESCALA_2,
												VL_INTERVALO_ESCALA_3,
												VL_INTERVALO_ESCALA_4,
												DS_COR_ESCALA_PADRAO,
												DS_COR_ESCALA_1,
												DS_COR_ESCALA_2,
												DS_COR_ESCALA_3,
												DS_COR_ESCALA_4,
												IE_EIXO_ADICIONAL_1,
												IE_EIXO_ADICIONAL_2,
												ie_eixo_adicional_3,
												ie_eixo_adicional_4
									) values (nextval('w_flowsheet_config_escalas_seq'),
											  clock_timestamp(),
											  nm_usuario_p,
											  clock_timestamp(),
											  nm_usuario_p,
											  nr_seq_grupo_w,
											  a_vl_max_escala_padrao(i),
											  a_vl_max_escala_1(i),
											  a_vl_max_escala_2(i),
											  a_vl_max_escala_3(i),
											  a_vl_max_escala_4(i),
											  a_vl_min_escala_padrao(i),
											  a_vl_min_escala_1(i),
											  a_vl_min_escala_2(i),
											  a_vl_min_escala_3(i),
											  a_vl_min_escala_4(i),
											  a_vl_intervalo_escala_padrao(i),
											  a_vl_intervalo_escala_1(i),
											  a_vl_intervalo_escala_2(i),
											  a_vl_intervalo_escala_3(i),
											  a_vl_intervalo_escala_4(i),
											  a_ds_cor_escala_padrao(i),
											  a_ds_cor_escala_1(i),
											  a_ds_cor_escala_2(i),
											  a_ds_cor_escala_3(i),
											  a_ds_cor_escala_4(i),
											  a_ie_eixo_adicional_1(i),
											  a_ie_eixo_adicional_2(i),
											  a_ie_eixo_adicional_3(i),
											  a_ie_eixo_adicional_4(i)
									);
end if;
commit;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE configurar_cirurgia_flowsheet ( nr_cirurgia_p bigint, nr_seq_pepo_p bigint, nr_seq_modelo_p bigint, nm_usuario_p text) FROM PUBLIC;

