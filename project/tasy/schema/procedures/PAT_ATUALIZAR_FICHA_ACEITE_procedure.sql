-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pat_atualizar_ficha_aceite ( nr_seq_bem_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_estabelecimento_w		bigint;
cd_pessoa_resp_w			varchar(10);
nr_seq_local_w			bigint;
nr_seq_local_ant_w			bigint;
nr_seq_ficha_w			bigint;
ie_aceite_w			varchar(1);


BEGIN

/*Buscar o local atual(Novo) do patrimônio*/

select	max(nr_seq_local),
	max(cd_estabelecimento)
into STRICT	nr_seq_local_w,
	cd_estabelecimento_w
from	pat_bem
where	nr_sequencia		= nr_seq_bem_p;

/*Pegar a última ficha do bem*/

select	max(nr_sequencia)
into STRICT	nr_seq_ficha_w
from	pat_ficha_aceite
where	nr_seq_bem		= nr_seq_bem_p;

/*Pegar a localização e a situação da ultima ficha*/

select	max(ie_aceite),
	max(nr_seq_local)
into STRICT	ie_aceite_w,
	nr_seq_local_ant_w
from	pat_ficha_aceite
where	nr_sequencia		= nr_seq_ficha_w;

if (nr_seq_ficha_w IS NOT NULL AND nr_seq_ficha_w::text <> '') and (nr_seq_local_w <> nr_seq_local_ant_w) then

	/*Buscar a pessoa responsável pela nova localização*/

	select	max(cd_pf_resp_local)
	into STRICT	cd_pessoa_resp_w
	from	pat_local
	where	nr_sequencia		= nr_seq_local_w;

	if (coalesce(cd_pessoa_resp_w, 'X') <> 'X') then

		if (coalesce(ie_aceite_w, 'X')	= 'X') then

			update	pat_ficha_aceite
			set	nr_seq_local		= nr_seq_local_w,
				cd_pessoa_fisica	= cd_pessoa_resp_w,
				dt_atualizacao		= clock_timestamp(),
				nm_usuario		= nm_usuario_p
			where	nr_sequencia		= nr_seq_ficha_w;

		elsif (coalesce(ie_aceite_w, 'X') = 'R') then

			/*Caso Aprovada ou Reprovada, gerar nova ficha de aceite*/

			CALL pat_gerar_ficha_aceite(	cd_estabelecimento_w,
						nr_seq_bem_p,
						'M',
						'S',
						nm_usuario_p);

		end if;


	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pat_atualizar_ficha_aceite ( nr_seq_bem_p bigint, nm_usuario_p text) FROM PUBLIC;

