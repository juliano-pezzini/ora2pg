-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE agrupar_medicamento_quimio ( nr_seq_paciente_p bigint, nr_seq_atendimento_p bigint, cd_material_agrupar_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


qt_dose_ww		double precision;
qt_dose_prescricao_ww	double precision;
nr_seq_interno_w	bigint;
cd_material_w		integer;
qt_dose_prescricao_w	double precision;
cd_intervalo_w		varchar(7);
cd_intervalo_ww		varchar(7);
ie_bomba_infusao_w	varchar(1);
ds_dias_aplicacao_w	varchar(4000);
ds_dia_agrupar_w	varchar(2);
ds_dia_ciclo_w		varchar(5);
ie_protocolo_livre_w	varchar(1);
cd_intervalo_agrup_w	varchar(7);

C01 CURSOR FOR
	SELECT	cd_material,
		qt_dose_prescricao,
		cd_intervalo
	from	paciente_atend_medic
	where	nr_seq_atendimento	=	nr_seq_atendimento_p
	and	obter_se_contido(cd_material,cd_material_agrupar_p) = 'S';

C02 CURSOR FOR
	SELECT	b.ds_dia_ciclo,
		a.cd_intervalo,
		a.ie_bomba_infusao
	from	paciente_atend_medic a,
		paciente_atendimento b
	where	a.nr_seq_atendimento 	= b.nr_seq_atendimento
	and	b.nr_seq_paciente 	= nr_seq_paciente_p
	and	a.cd_material		= cd_material_w;


BEGIN

if (nr_seq_paciente_p > 0) then

	select	coalesce(max(ie_protocolo_livre),'N')
	into STRICT	ie_protocolo_livre_w
	from	paciente_setor
	where	nr_seq_paciente	=	nr_seq_paciente_p;


	open C01;
	loop
	fetch C01 into
		cd_material_w,
		qt_dose_prescricao_w,
		cd_intervalo_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		/* Obter regra para agrupar */

		if (ie_protocolo_livre_w = 'S') then
			open C02;
			loop
			fetch C02 into
				ds_dia_ciclo_w,
				cd_intervalo_ww,
				ie_bomba_infusao_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin
				if (coalesce(ds_dias_aplicacao_w::text, '') = '') then
					ds_dias_aplicacao_w := ds_dia_ciclo_w;
				else
					ds_dias_aplicacao_w := ds_dias_aplicacao_w || ',' || ds_dia_ciclo_w;
				end if;
				end;
			end loop;
			close C02;

		else
			select	max(cd_intervalo),
				max(ie_bomba_infusao),
				max(ds_dias_aplicacao)
			into STRICT	cd_intervalo_ww,
				ie_bomba_infusao_w,
				ds_dias_aplicacao_w
			from	paciente_protocolo_medic
			where	nr_seq_paciente		= nr_seq_paciente_p
			and	cd_material		= cd_material_w
			and	((cd_intervalo		= cd_intervalo_w) or (coalesce(cd_intervalo_w::text, '') = ''));
		end if;

		select	max(ds_dia_agrupar),
			max(cd_intervalo_agrup)
		into STRICT	ds_dia_agrupar_w,
			cd_intervalo_agrup_w
		from	regra_agrupamento_prep
		where	coalesce(cd_intervalo,coalesce(cd_intervalo_w,'X'))		= coalesce(cd_intervalo_w,'X')
		and	coalesce(ie_bomba_infusao,coalesce(ie_bomba_infusao_w,'X'))	= coalesce(ie_bomba_infusao_w,'X')
		and	coalesce(ds_dias_aplic,coalesce(ds_dias_aplicacao_w,'X'))		= coalesce(ds_dias_aplicacao_w,'X')
		and	coalesce(cd_material,coalesce(cd_material_w,0))			= coalesce(cd_material_w,0);

		/* Fim regra */

		if (ds_dia_agrupar_w IS NOT NULL AND ds_dia_agrupar_w::text <> '') then

			select	max(a.nr_seq_interno)
			into STRICT	nr_seq_interno_w
			from	paciente_atend_medic a,
				paciente_atendimento b
			where	a.nr_seq_atendimento 	= 	b.nr_seq_atendimento
			and	b.nr_seq_paciente	= 	nr_seq_paciente_p
			and	a.cd_material		= 	cd_material_w
			and	a.qt_dose_prescricao	= 	qt_dose_prescricao_w
			and	b.ds_dia_ciclo		= 	ds_dia_agrupar_w;

			select	sum(qt_dose),
				sum(qt_dose_prescricao)
			into STRICT	qt_dose_ww,
				qt_dose_prescricao_ww
			from	paciente_atend_medic
			where	nr_seq_interno 		in (	SELECT	a.nr_seq_interno
									from	paciente_atend_medic a,
										paciente_atendimento b
									where	a.nr_seq_atendimento	=	b.nr_seq_atendimento
									and	b.nr_seq_paciente	=	nr_seq_paciente_p
									and	a.cd_material		=	cd_material_w
									and	a.qt_dose_prescricao	=	qt_dose_prescricao_w
									and	coalesce(a.cd_intervalo,'X')	=	coalesce(cd_intervalo_w,'X'));

			delete	from paciente_atend_medic
			where	nr_seq_interno 		in (	SELECT	a.nr_seq_interno
									from	paciente_atend_medic a,
										paciente_atendimento b
									where	a.nr_seq_atendimento	=	b.nr_seq_atendimento
									and	b.nr_seq_paciente	=	nr_seq_paciente_p
									and	a.cd_material		=	cd_material_w
									and	a.qt_dose_prescricao	=	qt_dose_prescricao_w
									and	coalesce(a.cd_intervalo,'X')	=	coalesce(cd_intervalo_w,'X')
									and	a.nr_seq_interno	<>	nr_seq_interno_w);

			update	paciente_atend_medic
			set	qt_dose			=	qt_dose_ww,
				qt_dose_prescricao	=	qt_dose_prescricao_ww,
				cd_intervalo		=	coalesce(cd_intervalo_agrup_w,cd_intervalo)
			where	nr_seq_interno 		= 	nr_seq_interno_w;

			delete	from paciente_atendimento a
			where	a.nr_seq_paciente		=	nr_seq_paciente_p
			and	not exists (	SELECT	1
						from	paciente_atend_medic x
						where	a.nr_seq_atendimento 	= 	x.nr_seq_atendimento);

			commit;
		end if;

		end;
	end loop;
	close C01;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE agrupar_medicamento_quimio ( nr_seq_paciente_p bigint, nr_seq_atendimento_p bigint, cd_material_agrupar_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

