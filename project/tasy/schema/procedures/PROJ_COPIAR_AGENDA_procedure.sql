-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE proj_copiar_agenda ( nr_seq_agenda_origem_p bigint, cd_consultor_origem_p bigint, dt_mes_referencia_p text, nr_seq_agenda_destino_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, cd_consultor_destino_p text, ie_opcao_p text, cd_estabelecimento_p bigint, nm_usuario_p text, dt_mes_referencia_html_p timestamp default null, ds_msg_out_p INOUT text DEFAULT NULL) AS $body$
DECLARE


/* ie_opcao_p 
	S - Para item selecionado
	P - Periodo
*/
nr_seq_agenda_w		bigint;
dt_agenda_origem_w	timestamp;
nr_seq_agenda_origem_w	bigint;
qt_agendas_w		bigint;
qt_agendas_mes_w		bigint;
cd_consultor_w		varchar(10);
ie_status_w		varchar(15);
ie_dia_todo_w		varchar(1);
cd_hora_inic_w		timestamp;
cd_hora_fim_w		timestamp;
nr_seq_cliente_w		bigint;
nr_seq_canal_w		bigint;
nr_seq_motivo_w		bigint;
nr_seq_proj_w		bigint;
ds_observacao_w		varchar(255);
ds_msg_out_w		varchar(4000) := '';
dt_agenda_w		timestamp;
ds_observacao_origem_w	varchar(255);
nm_consultor_w		varchar(60);
ie_permite_altera_obs_w varchar(1);
ds_nome_curto_cliente_w	varchar(255);
ds_obs_escritorio_w	varchar(4000);
dt_mes_referencia_w 	timestamp;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	proj_agenda
	where	trunc(dt_agenda,'dd') between trunc(dt_inicial_p,'dd') and trunc(dt_final_p,'dd')
	and	cd_consultor = cd_consultor_destino_p
	and	obter_se_dia_util(dt_agenda,cd_estabelecimento_p)	= 'S';
	
C02 CURSOR FOR
	SELECT	nr_sequencia,
		trunc(dt_agenda,'dd')
	from	proj_agenda
	where	cd_consultor	= cd_consultor_origem_p
	and	trunc(dt_agenda,'month') = trunc(dt_mes_referencia_w,'month')
	order by	dt_agenda;
	
C03 CURSOR FOR
	SELECT	nr_sequencia
	from	proj_agenda
	where	trunc(dt_agenda,'dd')	= trunc(dt_agenda_origem_w)
	and	cd_consultor		= cd_consultor_destino_p
	and	obter_se_dia_util(dt_agenda,cd_estabelecimento_p)	= 'S';	


BEGIN


ie_permite_altera_obs_w := Obter_Param_Usuario(993, 144, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_permite_altera_obs_w);


if (ie_opcao_p = 'S') and (coalesce(nr_seq_agenda_destino_p,0) > 0) then
	select	cd_consultor,
		ie_status,
		ie_dia_todo,
		to_date(to_char(dt_agenda,'dd/mm/yyyy') || ' ' || substr(to_char(cd_hora_inic,'dd/mm/yyyy hh24:mi:ss'),12,5) || ':00', 'dd/mm/yyyy hh24:mi:ss') cd_hora_inic,
		to_date(to_char(dt_agenda,'dd/mm/yyyy') || ' ' || substr(to_char(cd_hora_fim,'dd/mm/yyyy hh24:mi:ss'),12,5) || ':00', 'dd/mm/yyyy hh24:mi:ss') cd_hora_fim,
		nr_seq_cliente,
		nr_seq_canal,
		nr_seq_motivo,
		nr_seq_proj,
		ds_observacao,
		ds_nome_curto_cliente,
		ds_obs_escritorio
	into STRICT	cd_consultor_w,
		ie_status_w,
		ie_dia_todo_w,
		cd_hora_inic_w,
		cd_hora_fim_w,
		nr_seq_cliente_w,
		nr_seq_canal_w,
		nr_seq_motivo_w,
		nr_seq_proj_w,
		ds_observacao_w,
		ds_nome_curto_cliente_w,
		ds_obs_escritorio_w
	from	proj_agenda
	where	nr_sequencia = nr_seq_agenda_origem_p;
	
	select	dt_agenda,
		ds_observacao,
		substr(obter_nome_pf(cd_consultor),1,60)
	into STRICT	dt_agenda_w,
		ds_observacao_origem_w,
		nm_consultor_w
	from	proj_agenda
	where	nr_sequencia = nr_seq_agenda_destino_p;
	
	update	proj_agenda
	set	dt_atualizacao	= clock_timestamp(),
		nm_usuario	= nm_usuario_p,
		ie_status		= ie_status_w,
		ie_dia_todo	= ie_dia_todo_w,
		nr_seq_cliente	= nr_seq_cliente_w,
		nr_seq_canal	= nr_seq_canal_w,
		nr_seq_motivo	= nr_seq_motivo_w,
		nr_seq_proj	= nr_seq_proj_w,
		ds_observacao	= CASE WHEN ie_permite_altera_obs_w='S' THEN ds_observacao_w  ELSE CASE WHEN ds_observacao = NULL THEN ds_observacao_w  ELSE ds_observacao END  END ,
		cd_hora_inic	= cd_hora_inic_w,
		cd_hora_fim	= cd_hora_fim_w,
		ds_nome_curto_cliente = ds_nome_curto_cliente_w,
		ds_obs_escritorio = ds_obs_escritorio_w
	where	nr_sequencia	= nr_seq_agenda_destino_p;
	
	if (ds_observacao_origem_w IS NOT NULL AND ds_observacao_origem_w::text <> '') and (ie_permite_altera_obs_w = 'N')	then
		ds_msg_out_w :=	obter_texto_dic_objeto(1055750, wheb_usuario_pck.get_nr_seq_idioma,
								'NR_SEQ_AGENDA=' || nr_seq_agenda_destino_p || ';NM_CONSULTOR=' || nm_consultor_w || ';DT_ALTERACAO=' || dt_agenda_w);
	end if;
		
elsif (ie_opcao_p = 'P') then
	if (coalesce(nr_seq_agenda_origem_p,0) <> 0) then
		
		open C01;
		loop
		fetch C01 into	
			nr_seq_agenda_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			select	ie_status,
				ie_dia_todo,
				to_date(to_char(dt_agenda,'dd/mm/yyyy') || ' ' || substr(to_char(cd_hora_inic,'dd/mm/yyyy hh24:mi:ss'),12,5) || ':00', 'dd/mm/yyyy hh24:mi:ss') cd_hora_inic,
				to_date(to_char(dt_agenda,'dd/mm/yyyy') || ' ' || substr(to_char(cd_hora_fim,'dd/mm/yyyy hh24:mi:ss'),12,5) || ':00', 'dd/mm/yyyy hh24:mi:ss') cd_hora_fim,
				nr_seq_cliente,
				nr_seq_canal,
				nr_seq_motivo,
				nr_seq_proj,
				ds_observacao,
				ds_nome_curto_cliente,
				ds_obs_escritorio
			into STRICT	ie_status_w,
				ie_dia_todo_w,
				cd_hora_inic_w,
				cd_hora_fim_w,
				nr_seq_cliente_w,
				nr_seq_canal_w,
				nr_seq_motivo_w,
				nr_seq_proj_w,
				ds_observacao_w,
				ds_nome_curto_cliente_w,
				ds_obs_escritorio_w
			from	proj_agenda
			where	nr_sequencia = nr_seq_agenda_origem_p;
			
			select	dt_agenda,
					ds_observacao,
					substr(obter_nome_pf(cd_consultor),1,60)
			into STRICT	dt_agenda_w,
					ds_observacao_origem_w,
					nm_consultor_w
			from	proj_agenda
			where	nr_sequencia = nr_seq_agenda_w;
			
			update	proj_agenda
			set	dt_atualizacao	= clock_timestamp(),
				nm_usuario	= nm_usuario_p,
				ie_status	= ie_status_w,
				ie_dia_todo	= ie_dia_todo_w,
				cd_hora_inic	= cd_hora_inic_w,
				cd_hora_fim	= cd_hora_fim_w,
				nr_seq_cliente	= nr_seq_cliente_w,
				nr_seq_canal	= nr_seq_canal_w,
				nr_seq_motivo	= nr_seq_motivo_w,
				nr_seq_proj	= nr_seq_proj_w,
				ds_observacao	= CASE WHEN ie_permite_altera_obs_w='S' THEN ds_observacao_w  ELSE CASE WHEN ds_observacao = NULL THEN ds_observacao_w  ELSE ds_observacao END  END ,
				ds_nome_curto_cliente = ds_nome_curto_cliente_w,
				ds_obs_escritorio = ds_obs_escritorio_w
			where	nr_sequencia	= nr_seq_agenda_w;
			
			if (ds_observacao_origem_w IS NOT NULL AND ds_observacao_origem_w::text <> '') and (ie_permite_altera_obs_w = 'N') then
				ds_msg_out_w :=	obter_texto_dic_objeto(1055750, wheb_usuario_pck.get_nr_seq_idioma,
								'NR_SEQ_AGENDA=' || nr_seq_agenda_w || ';NM_CONSULTOR=' || nm_consultor_w || ';DT_ALTERACAO=' || dt_agenda_w);
			end if;
			end;
		end loop;
		close C01;
	else

		if (dt_mes_referencia_html_p IS NOT NULL AND dt_mes_referencia_html_p::text <> '') then
			dt_mes_referencia_w := dt_mes_referencia_html_p;
		else
			dt_mes_referencia_w := to_date(dt_mes_referencia_p);
		end if;

		select	count(*)
		into STRICT	qt_agendas_mes_w
		from	proj_agenda
		where	cd_consultor	= cd_consultor_destino_p
		and	trunc(dt_agenda,'month') = trunc(dt_mes_referencia_w,'month');
		
		if (qt_agendas_mes_w = 0) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(204115); --Nao existe agenda gerada no mes para o consultor. Verifique!
		end if;
		
		open C02;
		loop
		fetch C02 into	
			nr_seq_agenda_origem_w,
			dt_agenda_origem_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			
			select	cd_consultor,
				ie_status,
				ie_dia_todo,
				to_date(to_char(dt_agenda,'dd/mm/yyyy') || ' ' || substr(to_char(cd_hora_inic,'dd/mm/yyyy hh24:mi:ss'),12,5) || ':00', 'dd/mm/yyyy hh24:mi:ss') cd_hora_inic,
				to_date(to_char(dt_agenda,'dd/mm/yyyy') || ' ' || substr(to_char(cd_hora_fim,'dd/mm/yyyy hh24:mi:ss'),12,5) || ':00', 'dd/mm/yyyy hh24:mi:ss') cd_hora_fim,
				nr_seq_cliente,
				nr_seq_canal,
				nr_seq_motivo,
				nr_seq_proj,
				ds_observacao,
				ds_nome_curto_cliente,
				ds_obs_escritorio
			into STRICT	cd_consultor_w,
				ie_status_w,
				ie_dia_todo_w,
				cd_hora_inic_w,
				cd_hora_fim_w,
				nr_seq_cliente_w,
				nr_seq_canal_w,
				nr_seq_motivo_w,
				nr_seq_proj_w,
				ds_observacao_w,
				ds_nome_curto_cliente_w,
				ds_obs_escritorio_w
			from	proj_agenda
			where	nr_sequencia = nr_seq_agenda_origem_w;
			
			open C03;
			loop
			fetch C03 into	
				nr_seq_agenda_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin
				
				select	dt_agenda,
						ds_observacao,
						substr(obter_nome_pf(cd_consultor),1,60)
				into STRICT	dt_agenda_w,
						ds_observacao_origem_w,
						nm_consultor_w
				from	proj_agenda
				where	nr_sequencia = nr_seq_agenda_w;
				
				update	proj_agenda
				set	dt_atualizacao	= clock_timestamp(),
					nm_usuario	= nm_usuario_p,
					ie_status	= ie_status_w,
					ie_dia_todo	= ie_dia_todo_w,
					cd_hora_inic	= cd_hora_inic_w,
					cd_hora_fim	= cd_hora_fim_w,
					nr_seq_cliente	= nr_seq_cliente_w,
					nr_seq_canal	= nr_seq_canal_w,
					nr_seq_motivo	= nr_seq_motivo_w,
					nr_seq_proj	= nr_seq_proj_w,
					ds_observacao	= CASE WHEN ie_permite_altera_obs_w='S' THEN ds_observacao_w  ELSE CASE WHEN ds_observacao = NULL THEN ds_observacao_w  ELSE ds_observacao END  END ,
					ds_nome_curto_cliente = ds_nome_curto_cliente_w,
					ds_obs_escritorio = ds_obs_escritorio_w
				where	nr_sequencia	= nr_seq_agenda_w;
				
				if (ds_observacao_origem_w IS NOT NULL AND ds_observacao_origem_w::text <> '')and (ie_permite_altera_obs_w = 'N') then
					ds_msg_out_w :=	obter_texto_dic_objeto(1055750, wheb_usuario_pck.get_nr_seq_idioma,
									'NR_SEQ_AGENDA=' || nr_seq_agenda_w || ';NM_CONSULTOR=' || nm_consultor_w || ';DT_ALTERACAO=' || dt_agenda_w);
				end if;
				end;
			end loop;
			close C03;
			end;
		end loop;
		close C02;
	end if;
end if;

ds_msg_out_p := ds_msg_out_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proj_copiar_agenda ( nr_seq_agenda_origem_p bigint, cd_consultor_origem_p bigint, dt_mes_referencia_p text, nr_seq_agenda_destino_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, cd_consultor_destino_p text, ie_opcao_p text, cd_estabelecimento_p bigint, nm_usuario_p text, dt_mes_referencia_html_p timestamp default null, ds_msg_out_p INOUT text DEFAULT NULL) FROM PUBLIC;

