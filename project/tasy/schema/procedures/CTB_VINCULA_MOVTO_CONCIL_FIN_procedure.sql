-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_vincula_movto_concil_fin ( nr_seq_movto_p ctb_movimento.nr_sequencia%type, nm_tabela_p ctb_documento.nm_tabela%type, nm_atributo_p ctb_documento.nm_atributo%type, nr_documento_p ctb_documento.nr_documento%type, nr_seq_doc_compl_p ctb_documento.nr_seq_doc_compl%type, nr_doc_analitico_p ctb_documento.nr_doc_analitico%type, nr_seq_documento_p ctb_documento.nr_sequencia%type, nm_usuario_p text) AS $body$
DECLARE


cd_conta_credito_w	ctb_movimento.cd_conta_credito%type;
cd_conta_debito_w	ctb_movimento.cd_conta_debito%type;
vl_movimento_w		ctb_movimento.vl_movimento%type;
nr_lote_contabil_w	ctb_movimento.nr_lote_contabil%type;
dt_movimento_w		ctb_movimento.dt_movimento%type;
ie_debito_credito_w	varchar(1);


BEGIN

begin

	select	cd_conta_credito,
		cd_conta_debito,
		vl_movimento,
		nr_lote_contabil,
		dt_movimento,
		CASE WHEN coalesce(cd_conta_credito, 'X')='X' THEN  'D'  ELSE 'C' END
	into STRICT	cd_conta_credito_w,
		cd_conta_debito_w,
		vl_movimento_w,
		nr_lote_contabil_w,
		dt_movimento_w,
		ie_debito_credito_w
	from	ctb_movimento
	where	nr_sequencia = nr_seq_movto_p;

exception
when others then
	cd_conta_credito_w:= null;
	cd_conta_debito_w:= null;
	vl_movimento_w:= null;
	nr_lote_contabil_w:= null;
	dt_movimento_w:= null;
	ie_debito_credito_w:= null;
end;

insert into movimento_contabil_doc(	nr_sequencia,
					cd_conta_contabil,
					vl_movimento,
					nr_lote_contabil,
					ie_debito_credito,
					dt_movimento,
					nr_seq_ctb_movto,
					nm_tabela,
					nm_atributo,
					nr_documento,
					nr_seq_doc_compl,
					nr_doc_analitico,
					dt_atualizacao,
					nm_usuario,
					nr_seq_ctb_documento)
			values (	nextval('movimento_contabil_doc_seq'),
					coalesce(cd_conta_credito_w, cd_conta_debito_w),
					vl_movimento_w,
					nr_lote_contabil_w,
					ie_debito_credito_w,
					dt_movimento_w,
					nr_seq_movto_p,
					nm_tabela_p,
					nm_atributo_p,
					nr_documento_p,
					nr_seq_doc_compl_p,
					nr_doc_analitico_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_documento_p
				);

update ctb_documento
set nr_lote_contabil = nr_lote_contabil_w
where nr_sequencia = nr_seq_documento_p;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_vincula_movto_concil_fin ( nr_seq_movto_p ctb_movimento.nr_sequencia%type, nm_tabela_p ctb_documento.nm_tabela%type, nm_atributo_p ctb_documento.nm_atributo%type, nr_documento_p ctb_documento.nr_documento%type, nr_seq_doc_compl_p ctb_documento.nr_seq_doc_compl%type, nr_doc_analitico_p ctb_documento.nr_doc_analitico%type, nr_seq_documento_p ctb_documento.nr_sequencia%type, nm_usuario_p text) FROM PUBLIC;

