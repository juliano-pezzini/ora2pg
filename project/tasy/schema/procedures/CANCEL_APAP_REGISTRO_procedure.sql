-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cancel_apap_registro ( nm_usuario_p w_apap_pac_registro.nm_usuario%type, nr_atendimento_p w_apap_pac.nr_atendimento%type ) AS $body$
BEGIN					
	if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '' AND nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then

		delete
		from     w_apap_pac_registro a
		where    nm_usuario = nm_usuario_p
		and (coalesce(nr_seq_origem::text, '') = '' or ie_status_houdini = 'L')
		and a.nr_seq_apap_inf in (	SELECT x.nr_sequencia
									from w_apap_pac_informacao x,
										 w_apap_pac_grupo y,
										 w_apap_pac z
									where x.nr_seq_apap_grupo = y.nr_sequencia
									and y.nr_seq_mod_apap = z.nr_sequencia
									and z.nr_atendimento = nr_atendimento_p
									and z.nm_usuario = nm_usuario_p);
		
		delete
		from	w_apap_pac_informacao x
		where nr_sequencia in ( SELECT distinct(a.nr_seq_apap_inf)
								from  w_apap_pac_registro a,
									  w_apap_pac_grupo y,
									  w_apap_pac z
								where (coalesce(a.nr_seq_origem::text, '') = '' or a.ie_status_houdini = 'L')
								and a.nm_usuario = nm_usuario_p
								and x.nr_seq_apap_grupo = y.nr_sequencia
								and y.nr_seq_mod_apap = z.nr_sequencia
								and z.nr_atendimento = nr_atendimento_p
								and z.nm_usuario = a.nm_usuario);
							
		delete
		from	w_apap_pac_grupo y
		where nr_sequencia in ( SELECT distinct(x.nr_seq_apap_grupo)
								from  w_apap_pac_registro a,
									  w_apap_pac_informacao x,
									  w_apap_pac z
								where (coalesce(a.nr_seq_origem::text, '') = '' or a.ie_status_houdini = 'L')
								and a.nm_usuario = nm_usuario_p
								and a.nr_seq_apap_inf = x.nr_sequencia
								and y.nr_seq_mod_apap = z.nr_sequencia
								and z.nr_atendimento = nr_atendimento_p
								and z.nm_usuario = a.nm_usuario);
								
		delete
		from	w_apap_pac z
		where z.nr_atendimento = nr_atendimento_p
		and nr_sequencia in (	SELECT distinct(y.nr_seq_mod_apap)
								from  w_apap_pac_registro a,
									  w_apap_pac_informacao x,
									  w_apap_pac_grupo y
								where (coalesce(a.nr_seq_origem::text, '') = '' or a.ie_status_houdini = 'L')
								and a.nm_usuario = nm_usuario_p
								and a.nr_seq_apap_inf = x.nr_sequencia
								and x.nr_seq_apap_grupo = y.nr_sequencia
								and z.nm_usuario = a.nm_usuario);
								
	end if;
		commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cancel_apap_registro ( nm_usuario_p w_apap_pac_registro.nm_usuario%type, nr_atendimento_p w_apap_pac.nr_atendimento%type ) FROM PUBLIC;

