-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE suspender_prescr_mat_hor_adep ( nr_sequencia_p bigint, nr_seq_motivo_susp_p bigint, ds_motivo_susp_p text, nr_prescricao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text ) AS $body$
DECLARE


nr_prescricao_w		bigint;
nr_seq_material_w	integer;
dt_horario_w		timestamp;

ds_erro_w		varchar(2000);


BEGIN
-- Procedure criada para ser utilizada na pasta Gest√£o de conflitos no ADEP - Java
ds_erro_w := '';

ds_erro_w := Consiste_susp_prescr_mat_hor(nr_prescricao_p, nr_sequencia_p, cd_estabelecimento_p, nm_usuario_p, ds_erro_w);

if (coalesce(ds_erro_w::text, '') = '') then
	begin

	update	prescr_mat_hor
	set	dt_suspensao		= clock_timestamp(),
		nm_usuario_susp		= nm_usuario_p,
		nr_seq_motivo_susp	= CASE WHEN nr_seq_motivo_susp_p=0 THEN null  ELSE nr_seq_motivo_susp_p END ,
		ds_motivo_susp          = ds_motivo_susp_p
	where	nr_sequencia 		= nr_sequencia_p
	and	coalesce(dt_fim_horario::text, '') = ''
	and	coalesce(dt_suspensao::text, '') = '';

	select	nr_prescricao,
		nr_seq_material,
		dt_horario
	into STRICT	nr_prescricao_w,
		nr_seq_material_w,
		dt_horario_w
	from	prescr_mat_hor
	where	nr_sequencia = nr_sequencia_p
	and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

	update	prescr_mat_hor
	set	dt_suspensao		= clock_timestamp(),
		nm_usuario_susp		= nm_usuario_p,
		nr_seq_motivo_susp	= CASE WHEN nr_seq_motivo_susp_p=0 THEN null  ELSE nr_seq_motivo_susp_p END ,
		ds_motivo_susp          = ds_motivo_susp_p
	where	nr_prescricao		= nr_prescricao_w
	and	nr_seq_superior		= nr_seq_material_w
	and	dt_horario		= dt_horario_w
	and	coalesce(dt_fim_horario::text, '') = ''
	and	coalesce(dt_suspensao::text, '') = '';

	commit;

	CALL atualiza_ie_horario_susp(nr_prescricao_w, nr_seq_material_w, 'PRESCR_MATERIAL');

	end;
else
	begin
	-- #@DS_ERRO#@
	CALL Wheb_mensagem_pck.exibir_mensagem_abort( 193870 );
	end;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE suspender_prescr_mat_hor_adep ( nr_sequencia_p bigint, nr_seq_motivo_susp_p bigint, ds_motivo_susp_p text, nr_prescricao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text ) FROM PUBLIC;

