-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_plano_mat_proc (cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_plano_p text, cd_material_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_atendimento_p bigint, ie_tipo_atendimento_p bigint, cd_tipo_acomodacao_p bigint, cd_setor_atendimento_p bigint, nr_seq_exame_p bigint, nr_seq_proc_interno_p bigint, ds_retorno_p INOUT text, ie_bloqueia_agenda_p INOUT text, ie_regra_p INOUT text, nr_seq_regra_p INOUT bigint) AS $body$
DECLARE


ie_regra_w		smallint	:= 0;
ie_valor_w		varchar(5);
vl_material_min_w		double precision;
vl_material_max_w		double precision;
nr_seq_regra_w		bigint;
cd_grupo_w		bigint	:= 0;
cd_especialidade_w	bigint	:= 0;
cd_area_w		bigint	:= 0;
cd_grupo_material_w	integer	:= 0;
cd_subgrupo_material_w	integer	:= 0;
cd_classe_material_w	integer	:= 0;
cd_classif_setor_w		varchar(10);
nr_seq_forma_org_w	bigint	:= 0;
nr_seq_grupo_w		bigint	:= 0;
nr_seq_subgrupo_w	bigint	:= 0;
ds_erro_w		varchar(255)	:= null;
ds_retorno_w		varchar(255)	:= null;
cd_pessoa_fisica_w	varchar(10);
ie_glosa_w		regra_ajuste_proc.ie_glosa%type;
nr_seq_regra_preco_w	regra_ajuste_proc.nr_sequencia%type;
--alterada por dsantos e Francisco em 01/10/2009 - OS170119. Esta procedure era totalmente diferente. Verifiacar hist√≥ricos anteriores.
BEGIN

select	max(cd_pessoa_fisica)
into STRICT	cd_pessoa_fisica_w
from	atendimento_paciente
where	nr_atendimento = nr_atendimento_p;

if (cd_procedimento_p IS NOT NULL AND cd_procedimento_p::text <> '') then

	SELECT * FROM consiste_plano_convenio(
			nr_atendimento_p, cd_convenio_p, cd_procedimento_p, ie_origem_proced_p, clock_timestamp(), 1, ie_tipo_atendimento_p, cd_plano_p, null, ds_erro_w, cd_setor_atendimento_p, nr_seq_exame_p, ie_regra_w, null, nr_seq_regra_w, nr_seq_proc_interno_p, cd_categoria_p, cd_estabelecimento_p, null, null, cd_pessoa_fisica_w, ie_glosa_w, nr_seq_regra_preco_w) INTO STRICT ds_erro_w, ie_regra_w, nr_seq_regra_w, ie_glosa_w, nr_seq_regra_preco_w;

elsif (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then

	 SELECT * FROM consiste_mat_plano_convenio(cd_convenio_p, cd_plano_p, cd_material_p, nr_atendimento_p, cd_setor_atendimento_p, ds_retorno_w, ie_bloqueia_agenda_p, ie_regra_w, nr_seq_regra_w, 1, clock_timestamp(), null, cd_estabelecimento_p, cd_categoria_p, ie_tipo_atendimento_p, cd_tipo_acomodacao_p) INTO STRICT ds_retorno_w, ie_bloqueia_agenda_p, ie_regra_w, nr_seq_regra_w;

end if;


ie_regra_p	:= ie_regra_w;
nr_seq_regra_p	:= nr_seq_regra_w;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_plano_mat_proc (cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_plano_p text, cd_material_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_atendimento_p bigint, ie_tipo_atendimento_p bigint, cd_tipo_acomodacao_p bigint, cd_setor_atendimento_p bigint, nr_seq_exame_p bigint, nr_seq_proc_interno_p bigint, ds_retorno_p INOUT text, ie_bloqueia_agenda_p INOUT text, ie_regra_p INOUT text, nr_seq_regra_p INOUT bigint) FROM PUBLIC;

