-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_evento_acesso_pep ( nr_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_evento_w			bigint;
cd_estabelecimento_w	smallint;
cd_pessoa_fisica_w		varchar(10);
qt_idade_w				bigint;
nr_seq_classif_w		bigint;
cd_setor_w				bigint;
cd_procedencia_w		bigint;
ie_sexo_w				varchar(1);
cd_medico_resp_w		varchar(10);

C01 CURSOR FOR 
	SELECT	nr_seq_evento 
	from	regra_envio_sms 
	where	cd_estabelecimento	= cd_estabelecimento_w 
	and		ie_evento_disp		= 'AP' 
	and		qt_idade_w between coalesce(qt_idade_min,0)	and coalesce(qt_idade_max,9999) 
	and		coalesce(cd_setor_atendimento, cd_setor_w) = cd_setor_w 
	and		coalesce(nr_seq_classif,nr_seq_classif_w) = nr_seq_classif_w 
	and		coalesce(cd_procedencia, cd_procedencia_w) = cd_procedencia_w 
	and		coalesce(ie_sexo,ie_sexo_w) = ie_sexo_w 
	and		coalesce(cd_medico,cd_medico_resp_w) = cd_medico_resp_w 
	and		coalesce(ie_situacao,'A') = 'A';


BEGIN 
if (nr_atendimento_p > 0) then 
	select	max(cd_pessoa_fisica), 
			max(cd_estabelecimento), 
			max(cd_procedencia), 
			max(cd_medico_resp) 
	into STRICT	cd_pessoa_fisica_w, 
			cd_estabelecimento_w, 
			cd_procedencia_w, 
			cd_medico_resp_w 
	from	atendimento_paciente 
	where	nr_atendimento	= nr_atendimento_p;
 
	qt_idade_w			:= coalesce(obter_idade_pf(cd_pessoa_fisica_w,clock_timestamp(),'A'),0);
	cd_setor_w 		:= obter_setor_atendimento(nr_atendimento_p);
	nr_seq_classif_w 	:= coalesce(obter_classificacao_pf(cd_pessoa_fisica_w),0);
	ie_sexo_w			:= obter_dados_pf(cd_pessoa_fisica_w,'SE');
 
	open C01;
	loop 
	fetch C01 into	 
		nr_seq_evento_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		 
		CALL gerar_evento_paciente(nr_seq_evento_w,nr_atendimento_p,cd_pessoa_fisica_w,null,nm_usuario_p,null);
 
		end;
	end loop;
	close C01;
	 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_evento_acesso_pep ( nr_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

