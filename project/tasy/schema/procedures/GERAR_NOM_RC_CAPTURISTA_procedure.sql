-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_nom_rc_capturista (nr_seq_cabecalho_p bigint, nm_usuario_p text) AS $body$
DECLARE


						
nr_atendimento_w			atendimento_paciente.nr_atendimento%type;
nr_seq_episodio_w			episodio_paciente.nr_sequencia%type;
cd_pessoa_fisica_w			pessoa_fisica.cd_pessoa_fisica%type;
nm_usuario_w				usuario.nm_usuario%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;

nm_oid_sistema_w				varchar(255);

ds_tipo_w			varchar(255);						

ds_oid_capturista_w					nom_rc_pessoa_fisica.ds_oid_capturista%type;	/*id_137*/
nr_ident_captursita_w				varchar(30);	/*id_138*/
nm_primeiro_nome_w					varchar(255);	/*id_139*/
nm_sobrenome_1_pai_w				varchar(255);	/*id_140*/
nm_sobrenome_2_mae_w    			varchar(255);	/*id_141*/
dt_entrada_w						timestamp;



BEGIN
delete FROM nom_rc_pessoa_fisica where nr_seq_cabecalho = nr_seq_cabecalho_p and ie_tipo = 'CAP';

select	a.nr_atendimento,
		a.nr_seq_episodio,
		a.cd_estabelecimento,
		a.nm_usuario nm_usuario
into STRICT	nr_atendimento_w,
		nr_seq_episodio_w,
		cd_estabelecimento_w,
		nm_usuario_w		
from	nom_rc_cabecalho a
where	a.nr_sequencia	= nr_seq_cabecalho_p;

if	((coalesce(nr_atendimento_w::text, '') = '') and (nr_seq_episodio_w IS NOT NULL AND nr_seq_episodio_w::text <> '')) then
	select	min(nr_atendimento)
	into STRICT	nr_atendimento_w
	from	atendimento_paciente a
	where	a.nr_seq_episodio = nr_seq_episodio_w;
end if;

	ds_oid_capturista_w := get_oid_details(6,'OID_NUMBER','NOM',cd_estabelecimento_w); /*id_137*/
if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then

	select 	b.cd_pessoa_fisica cd_pessoa_fisica,
			z.ds_given_name nm_primeiro_nome, /*id_139*/
			z.ds_family_name nm_sobrenome_pai, /*id_140*/
			coalesce(z.ds_component_name_1, 'SIN INFORMACION') nm_sobrenome_mae, /*id_141*/
			u.nm_usuario nm_usuario /*id_138*/
	into STRICT 	cd_pessoa_fisica_w,
			nm_primeiro_nome_w,
			nm_sobrenome_1_pai_w,
			nm_sobrenome_2_mae_w,
			nr_ident_captursita_w
	FROM usuario u
LEFT OUTER JOIN pessoa_fisica b ON (u.cd_pessoa_fisica = b.cd_pessoa_fisica)
LEFT OUTER JOIN person_name z ON (b.nr_seq_person_name = z.nr_sequencia AND 'main' = z.ds_type)
WHERE u.nm_usuario  = nm_usuario_w;
	
	select	dt_entrada
	into STRICT	dt_entrada_w
	from	atendimento_paciente a
	where	a.nr_atendimento = nr_atendimento_w;

	insert into nom_rc_pessoa_fisica(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ie_tipo,
		dt_captura,
		ds_oid_capturista,
		nr_ident_captursita,
		nm_primeiro_nome,
		nm_sobrenome_1_pai,
		nm_sobrenome_2_mae,
		nr_seq_cabecalho
		)
	values (nextval('nom_rc_pessoa_fisica_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		'CAP',
		clock_timestamp(), /*id_136*/
		ds_oid_capturista_w,
		nr_ident_captursita_w,
		nm_primeiro_nome_w,
		nm_sobrenome_1_pai_w,
		nm_sobrenome_2_mae_w,
		nr_seq_cabecalho_p
	);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_nom_rc_capturista (nr_seq_cabecalho_p bigint, nm_usuario_p text) FROM PUBLIC;

