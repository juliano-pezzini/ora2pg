-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_log_triagem_pa ( nr_atendimento_p bigint default null, ie_opcao_p text DEFAULT NULL, nm_usuario_p text DEFAULT NULL, nr_seq_triagem_p bigint default null, ie_retriagem_p text default 'N', ds_justificativa_p text default null, nr_seq_pa_p bigint default null) AS $body$
DECLARE

        
dt_inicio_w    log_triagem_pa.dt_inicio%type;
dt_fim_w    log_triagem_pa.dt_fim%type;
ie_retriagem_w  log_triagem_pa.ie_retriagem%type;
nr_seq_pa_w    log_triagem_pa.nr_seq_pa%type;
nr_seq_log_w  log_triagem_pa.nr_sequencia%type;

        

BEGIN

if ((nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') or (nr_seq_pa_p IS NOT NULL AND nr_seq_pa_p::text <> '')) then

  nr_seq_pa_w := nr_seq_pa_p;
  ie_retriagem_w := ie_retriagem_p;

  if ( coalesce(nr_seq_pa_w::text, '') = '') then
    
    Select  max(nr_sequencia)
    into STRICT  nr_seq_pa_w  
    from  triagem_pronto_atend
    where   nr_atendimento = nr_atendimento_p;
  
  end if;

  if (nr_seq_pa_w IS NOT NULL AND nr_seq_pa_w::text <> '') then
  
  
    if ( ie_opcao_p = 'I' ) then
    
      dt_inicio_w := clock_timestamp();

    elsif ( ie_opcao_p = 'F' or ie_opcao_p = 'C' ) then
    
      
      if ( ie_opcao_p = 'F' ) then
      
        dt_fim_w := clock_timestamp();

      end if;

      Select   max(nr_sequencia)
      into STRICT  nr_seq_log_w
      FROM  LOG_TRIAGEM_PA
      where   NR_SEQ_PA = nr_seq_pa_w
      and    nm_usuario = nm_usuario_p
      and    (dt_inicio IS NOT NULL AND dt_inicio::text <> '')
      and    coalesce(dt_fim::text, '') = '';
    
    end if;

    if (nr_seq_log_w IS NOT NULL AND nr_seq_log_w::text <> '') then
    
    
       if ( ie_opcao_p = 'F' ) then
    
    
        update    LOG_TRIAGEM_PA
        set    dt_fim = dt_fim_w
        where    nr_sequencia = nr_seq_log_w;

       elsif ( ie_opcao_p = 'C') then
       
       
        update    LOG_TRIAGEM_PA
        set    nr_seq_triagem = nr_seq_triagem_p,
            ds_justificativa = ds_justificativa_p
        where    nr_sequencia = nr_seq_log_w;

       
       end if;
    
    
    
    else
  
    
      insert into  LOG_TRIAGEM_PA(  NR_SEQUENCIA,           
                      DT_ATUALIZACAO,         
                      NM_USUARIO,             
                      DT_ATUALIZACAO_NREC,    
                      NM_USUARIO_NREC,        
                      IE_RETRIAGEM,           
                      DT_INICIO,              
                      DT_FIM,                 
                      DS_JUSTIFICATIVA,       
                      NR_SEQ_TRIAGEM,         
                      NR_SEQ_PA)
                values (  nextval('log_triagem_pa_seq'),
                      clock_timestamp(),
                      nm_usuario_p,
                      clock_timestamp(),
                      nm_usuario_p,
                      ie_retriagem_w,
                      dt_inicio_w,
                      dt_fim_w,
                      ds_justificativa_p,
                      nr_seq_triagem_p,
                      nr_seq_pa_w  );

    end if;

  end if;


end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_log_triagem_pa ( nr_atendimento_p bigint default null, ie_opcao_p text DEFAULT NULL, nm_usuario_p text DEFAULT NULL, nr_seq_triagem_p bigint default null, ie_retriagem_p text default 'N', ds_justificativa_p text default null, nr_seq_pa_p bigint default null) FROM PUBLIC;

