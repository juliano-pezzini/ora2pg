-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_cart_unimed_maringa ( nr_seq_lote_p bigint, cd_interface_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ds_header_w			varchar(4000);
ds_sub_header_w			varchar(4000);
cd_usuario_plano_w		varchar(24);
nm_beneficiario_w		varchar(250);
tp_contratacao_w		varchar(255);
dt_nascimento_w			varchar(12);
dt_validade_carteira_w		varchar(20);
cd_local_cobranca_w		varchar(20);
ds_produto_w			varchar(50);
cd_abrangencia_w		varchar(50);
ds_abrangencia_w		varchar(50);
ds_registro_ans_w		varchar(50);
ds_acomodacao_w			varchar(50);
ds_mensagem_cpt_w		varchar(15);
nm_empresa_w			varchar(50);
ds_rede_atendimento_w		varchar(50);
ds_carencia_w			varchar(4000);
nr_via_solicitacao_w		varchar(255);
ds_regiao_w			varchar(4000);
ds_trilha_1_w			w_pls_interface_carteira.ds_trilha_1%type;
ds_trilha_2_w			w_pls_interface_carteira.ds_trilha_2%type;
nr_protocolo_ans_w		varchar(100);
dt_contratacao_w		timestamp;
ds_mensagem_w			varchar(100);
dt_inclusao_operadora_w		timestamp;
nr_seq_contrato_w		bigint;
ds_mensagem_cart_w		varchar(255);
nr_seq_intercambio_w		bigint;
ds_mens_carencia_w		varchar(255);
ds_abrangencia_aux_w		varchar(255);
cd_cgc_estipulante_w		varchar(20);
cd_pf_estipulante_w		varchar(20);
nr_seq_plano_w			bigint;
nr_seq_regiao_w			bigint;
ie_tipo_segurado_w		varchar(10);
ds_congenere_w			varchar(255);
ie_cpt_1044_w			varchar(1);
ds_tipo_acomodacao_w		varchar(255);
cd_rede_refer_ptu_w		pls_plano.cd_rede_refer_ptu%type;
ds_cns_w			pessoa_fisica.nr_cartao_nac_sus%type;
cd_matricula_familia_w		pls_segurado.cd_matricula_familia%type;
ds_titular_w			varchar(255);
ds_titularidade_w		varchar(255);
ds_pessoa_w			varchar(255);
ie_segmentacao_w		varchar(255);
dt_inicio_vigencia_w		varchar(20);
nm_operadora_repasse_w		w_pls_interface_carteira.nm_operadora_repasse%type;
ds_tipo_repasse_w		w_pls_interface_carteira.ds_tipo_repasse%type;
dt_repasse_w			timestamp;
dt_fim_repasse_w		timestamp;
ie_tipo_rede_min_w		pls_plano.ie_tipo_rede_min%type;

ds_regiao_1_w			varchar(75);
ds_regiao_2_w			varchar(75);
ds_regiao_3_w			varchar(75);
ds_regiao_4_w			varchar(75);
ds_regiao_5_w			varchar(75);

C01 CURSOR(nr_seq_lote_p	pls_lote_carteira.nr_sequencia%type) FOR 
	SELECT	b.nr_sequencia nr_seq_segurado, 
		'C' ie_tipo_contrato 
	from	pls_segurado_carteira	a, 
		pls_segurado		b, 
		pls_carteira_emissao	c, 
		pls_lote_carteira	d, 
		pls_contrato		e 
	where	a.nr_seq_segurado	= b.nr_sequencia 
	and	c.nr_seq_seg_carteira	= a.nr_sequencia 
	and	c.nr_seq_lote		= d.nr_sequencia 
	and	b.nr_seq_contrato	= e.nr_sequencia 
	and	d.nr_sequencia		= nr_seq_lote_p 
	
union all
 
	SELECT	b.nr_sequencia nr_seq_segurado, 
		'I' ie_tipo_contrato 
	from	pls_segurado_carteira	a, 
		pls_segurado		b, 
		pls_carteira_emissao	c, 
		pls_lote_carteira	d, 
		pls_intercambio		e 
	where	a.nr_seq_segurado	= b.nr_sequencia 
	and	c.nr_seq_seg_carteira	= a.nr_sequencia 
	and	c.nr_seq_lote		= d.nr_sequencia 
	and	b.nr_seq_intercambio	= e.nr_sequencia 
	and	d.nr_sequencia		= nr_seq_lote_p;

C02 CURSOR(	nr_seq_plano_p		pls_plano_area.nr_seq_plano%type) FOR 
	SELECT	c.ds_municipio 
	from	pls_plano_area		a, 
		pls_regiao_local	b, 
		sus_municipio		c 
	where	c.cd_municipio_ibge	= b.cd_municipio_ibge 
	and	b.nr_seq_regiao		= a.nr_seq_regiao 
	and	a.nr_seq_plano		= nr_seq_plano_p;

C03 CURSOR(	nr_seq_plano_p		pls_plano_area.nr_seq_plano%type) FOR 
	SELECT	b.sg_uf_municipio 
	from	pls_plano_area		a, 
		pls_regiao_local	b 
	where	b.nr_seq_regiao		= a.nr_seq_regiao 
	and	a.nr_seq_plano		= nr_seq_plano_p;

C04 CURSOR(	nr_seq_contrato_p	pls_contrato_mensagem_cart.nr_seq_contrato%type, 
		nr_seq_intercambio_p	pls_contrato_mensagem_cart.nr_seq_intercambio%type, 
		ie_tipo_contrato_p	text) FOR 
	SELECT	ds_mensagem, 
		dt_fim_vigencia 
	from	pls_contrato_mensagem_cart 
	where	nr_seq_contrato		= nr_seq_contrato_p	 
	and	ie_situacao		= 'A' 
	and	ie_mensagem_carencia 	= 'S' 
	and	ie_tipo_contrato_p	= 'C' 
	and	clock_timestamp()	between dt_inicio_vigencia and fim_dia(dt_fim_vigencia)  
	
union all
 
	SELECT	ds_mensagem, 
		dt_fim_vigencia 
	from	pls_contrato_mensagem_cart 
	where	nr_seq_intercambio	= nr_seq_intercambio_p	 
	and	ie_situacao		= 'A' 
	and	ie_mensagem_carencia 	= 'S' 
	and	ie_tipo_contrato_p 	= 'I' 
	and	clock_timestamp()	between dt_inicio_vigencia and fim_dia(dt_fim_vigencia)  LIMIT 12;
		
BEGIN 
	if (cd_interface_p = 2700) then 
		ds_header_w :=	'"Codigo_Usuario";"Data_Nascimento";"  ";"Acomodacao";"  ";"Data_vigencia";"  ";"Data_Vencimento";"Nome_Usuario";"     ";"Rede_Atend";"Local_atendimento";"   ";"Plano";"   ";"Area_Utilizacao";' || 
				'"  ";"Via_Cartao";"Data_CPT";"  ";"Nome_Empresa";"Segmentacao";"Trilha1";"Trilha2";"Operadora_repasse";"Tipo_repasse";"Dt_repasse";"Dt_fim_repasse"';
	else 
		ds_header_w :=	'"Codigo_Usuario";"Data_Nascimento";"Tipo_Contratacao";"Acomodacao";"Data_Vencimento";"Nome_Usuario";"Rede_Atend";"Codigo_Unimed";"Mensagem_Cartao";"Area_Utilizacao";' || 
				'"Via_Cartao";"Mensagem_CPT";"Nome_Empresa";"Abrangencia_1";"Abrangencia_2";"Abrangencia_3";"Abrangencia_4";"Abrangencia_5";"Carencia_1";"Dt_Carencia_1";"Carencia_2";"Dt_Carencia_2";"Carencia_3";"Dt_Carencia_3";' || 
				'"Carencia_4";"Dt_Carencia_4";"Carencia_5";"Dt_Carencia_5";"Carencia_6";"Dt_Carencia_6";"Carencia_7";"Dt_Carencia_7";"Carencia_8";"Dt_Carencia_8";"Carencia_9";"Dt_Carencia_9";' || 
				'"Carencia_10";"Dt_Carencia_10";"Carencia_11";"Dt_Carencia_11";"Carencia_12";"Dt_Carencia_12";"Cod_Produto_ANS";"Trilha1";"Trilha2";"Tipo_Plano";"Padrao_Acomodacao";'|| 
				'"CNS";"Contato ANS";"Portal Operadora";"Pessoa";"Família";"Titular";"Titularidade"';
	end if;
	delete	FROM w_pls_interface_carteira 
	where	nr_seq_lote	= nr_seq_lote_p;
	 
	insert into w_pls_interface_carteira(nr_sequencia,				dt_atualizacao, dt_atualizacao_nrec,	nm_usuario,	nm_usuario_nrec,	nr_seq_lote,	ds_header,	ie_tipo_reg) 
	values (nextval('w_pls_interface_carteira_seq'),	clock_timestamp(),	clock_timestamp(),		nm_usuario_p,	nm_usuario_p,		nr_seq_lote_p,	ds_header_w,	1);
	 
	for c01_w in C01(nr_seq_lote_p) loop 
		/* Atualizar a trilha do beneficiário */
 
		CALL pls_atualizar_trilha_cartao(c01_w.nr_seq_segurado,nm_usuario_p);
		 
		if (c01_w.ie_tipo_contrato = 'C') then 
			select	c.cd_usuario_plano, 
				substr((CASE WHEN (trim(both nm_abreviado) IS NOT NULL AND (trim(both nm_abreviado))::text <> '') THEN upper(nm_abreviado) ELSE pls_gerar_nome_abreviado(a.nm_pessoa_fisica) END), 1, 25), 
				to_char(a.dt_nascimento, 'dd/mm/yyyy'), 
				substr(coalesce(pls_obter_dados_cart_unimed(b.nr_sequencia, d.nr_sequencia, 'DA', 1), 'NÃO SE APLICA'), 1, 50), 
				to_char(c.dt_validade_carteira, 'dd/mm/yyyy'), 
				to_char(c.dt_inicio_vigencia,'dd/mm/yyyy'), 
				f.cd_cgc_estipulante, 
				CASE WHEN d.ie_tipo_contratacao='I' THEN  'Individual ou Familiar' WHEN d.ie_tipo_contratacao='CA' THEN  'Coletivo por Adesão' WHEN d.ie_tipo_contratacao='CE' THEN  'Coletivo Empresarial' END , 
				CASE WHEN d.ie_regulamentacao='R' THEN  'Não Regulamentado' WHEN d.ie_regulamentacao='P' THEN  'Regulamentado' WHEN d.ie_regulamentacao='A' THEN  'Adaptado' END , 
				d.ie_abrangencia, 
				CASE WHEN d.ie_abrangencia='GE' THEN  'Grupo de Estados' WHEN d.ie_abrangencia='GM' THEN  'Grupo de Municípios'  ELSE Obter_Valor_Dominio(1667, d.ie_abrangencia) END , 
				lpad(to_char(c.nr_via_solicitacao), 2, '0'), 
				d.nr_sequencia, 
				'Cod. Prod. ANS:' || CASE WHEN d.ie_regulamentacao='P' THEN d.nr_protocolo_ans  ELSE d.cd_scpa END , 
				replace(replace(ds_trilha1, ';', ''),'%',''), 
				replace(ds_trilha2, ';', ''), 
				f.cd_pf_estipulante, 
				b.dt_contratacao, 
				b.dt_inclusao_operadora, 
				b.ie_tipo_segurado, 
				f.nr_sequencia, 
				CASE WHEN ie_acomodacao='I' THEN  'Individual'  WHEN ie_acomodacao='C' THEN 'Coletiva'  ELSE 'Não se Aplica' END  ds_tipo_acomodacao, 
				substr(d.ds_carteira_acomodacao, 1, 17) ds_acomodacao, 
				'CNS'||' '|| lpad(coalesce(a.NR_CARTAO_NAC_SUS,'0'),15,'0') ds_cns, 
				lpad(coalesce(b.cd_matricula_familia,'0'),7,'0') ds_matricula_familia, 
				CASE WHEN coalesce(b.nr_seq_titular::text, '') = '' THEN UPPER(obter_nome_pf(b.cd_pessoa_fisica))  ELSE UPPER(substr(pls_obter_dados_segurado(b.nr_seq_titular,'N'),1,255)) END  ds_titular, 
				CASE WHEN coalesce(b.nr_seq_titular::text, '') = '' THEN 'Titular'  ELSE 'Dependente' END ds_titularidade, 
				CASE WHEN coalesce(f.cd_pf_estipulante::text, '') = '' THEN 'JURIDICA'  ELSE 'FISICA' END  ds_pessoa, 
				substr(Obter_Valor_Dominio(1665,d.ie_segmentacao),1,57)ds_segmentacao, 
				substr(d.cd_rede_refer_ptu,1,13) 
			into STRICT	cd_usuario_plano_w, 
				nm_beneficiario_w, 
				dt_nascimento_w, 
				ds_produto_w, 
				dt_validade_carteira_w, 
				dt_inicio_vigencia_w, 
				cd_cgc_estipulante_w, 
				tp_contratacao_w, 
				ds_registro_ans_w, 
				cd_abrangencia_w, 
				ds_abrangencia_w, 
				nr_via_solicitacao_w, 
				nr_seq_plano_w, 
				nr_protocolo_ans_w, 
				ds_trilha_1_w, 
				ds_trilha_2_w, 
				cd_pf_estipulante_w, 
				dt_contratacao_w, 
				dt_inclusao_operadora_w, 
				ie_tipo_segurado_w, 
				nr_seq_contrato_w, 
				ds_tipo_acomodacao_w, 
				ds_acomodacao_w, 
				ds_cns_w, 
				cd_matricula_familia_w, 
				ds_titular_w, 
				ds_titularidade_w, 
				ds_pessoa_w, 
				ie_segmentacao_w, 
				cd_rede_refer_ptu_w 
			from	pls_contrato		f, 
				pls_plano		d, 
				pls_segurado_carteira	c, 
				pls_segurado		b, 
				pessoa_fisica		a 
			where	c.nr_seq_segurado	= b.nr_sequencia 
			and	b.nr_seq_plano		= d.nr_sequencia 
			and	b.cd_pessoa_fisica	= a.cd_pessoa_fisica 
			and	b.nr_seq_contrato	= f.nr_sequencia 
			and	b.nr_sequencia		= c01_w.nr_seq_segurado;
		elsif (c01_w.ie_tipo_contrato = 'I') then 
			select	c.cd_usuario_plano, 
				substr((CASE WHEN (trim(both nm_abreviado) IS NOT NULL AND (trim(both nm_abreviado))::text <> '') THEN upper(nm_abreviado) ELSE pls_gerar_nome_abreviado(a.nm_pessoa_fisica) END), 1, 25), 
				to_char(a.dt_nascimento, 'dd/mm/yyyy'), 
				substr(coalesce(pls_obter_dados_cart_unimed(b.nr_sequencia, d.nr_sequencia, 'DA', 1), 'NÃO SE APLICA'), 1, 50), 
				to_char(c.dt_validade_carteira, 'dd/mm/yyyy'), 
				to_char(c.dt_inicio_vigencia,'dd/mm/yyyy'), 
				f.cd_cgc, 
				CASE WHEN d.ie_tipo_contratacao='I' THEN  'Individual ou Familiar' WHEN d.ie_tipo_contratacao='CA' THEN  'Coletivo por Adesão' WHEN d.ie_tipo_contratacao='CE' THEN  'Coletivo Empresarial' END , 
				CASE WHEN d.ie_regulamentacao='R' THEN  'Não Regulamentado' WHEN d.ie_regulamentacao='P' THEN  'Regulamentado' WHEN d.ie_regulamentacao='A' THEN  'Adaptado' END , 
				d.ie_abrangencia, 
				CASE WHEN d.ie_abrangencia='GE' THEN  'Grupo de Estados' WHEN d.ie_abrangencia='GM' THEN  'Grupo de Municípios'  ELSE Obter_Valor_Dominio(1667, d.ie_abrangencia) END , 
				lpad(to_char(c.nr_via_solicitacao), 2, '0'), 
				d.nr_sequencia, 
				'Cod. Prod. ANS:' || CASE WHEN d.ie_regulamentacao='P' THEN d.nr_protocolo_ans  ELSE d.cd_scpa END , 
				replace(replace(ds_trilha1, ';', ''),'%',''), 
				replace(ds_trilha2, ';', ''), 
				f.cd_pessoa_fisica, 
				b.dt_contratacao, 
				b.dt_inclusao_operadora, 
				b.ie_tipo_segurado, 
				f.nr_sequencia, 
				CASE WHEN ie_acomodacao='I' THEN  'Individual'  WHEN ie_acomodacao='C' THEN 'Coletiva'  ELSE 'Não se Aplica' END  ds_tipo_acomodacao, 
				substr(d.ds_carteira_acomodacao, 1, 17) ds_acomodacao, 
				'CNS'||' '|| lpad(coalesce(a.NR_CARTAO_NAC_SUS,'0'),15,'0') ds_cns, 
				lpad(coalesce(b.cd_matricula_familia,'0'),7,'0') ds_matricula_familia, 
				CASE WHEN coalesce(b.nr_seq_titular::text, '') = '' THEN UPPER(obter_nome_pf(b.cd_pessoa_fisica))  ELSE UPPER(substr(pls_obter_dados_segurado(b.nr_seq_titular,'N'),1,255)) END  ds_titular, 
				CASE WHEN coalesce(b.nr_seq_titular::text, '') = '' THEN 'Titular'  ELSE 'Dependente' END ds_titularidade, 
				CASE WHEN coalesce(f.cd_pessoa_fisica::text, '') = '' THEN 'JURIDICA'  ELSE 'FISICA' END  ds_pessoa, 
				substr(Obter_Valor_Dominio(1665,d.ie_segmentacao),1,57)ds_segmentacao, 
				substr(d.cd_rede_refer_ptu,1,13) 
			into STRICT	cd_usuario_plano_w, 
				nm_beneficiario_w, 
				dt_nascimento_w, 
				ds_produto_w, 
				dt_validade_carteira_w, 
				dt_inicio_vigencia_w, 
				cd_cgc_estipulante_w, 
				tp_contratacao_w, 
				ds_registro_ans_w, 
				cd_abrangencia_w, 
				ds_abrangencia_w, 
				nr_via_solicitacao_w, 
				nr_seq_plano_w, 
				nr_protocolo_ans_w, 
				ds_trilha_1_w, 
				ds_trilha_2_w, 
				cd_pf_estipulante_w, 
				dt_contratacao_w, 
				dt_inclusao_operadora_w, 
				ie_tipo_segurado_w, 
				nr_seq_intercambio_w, 
				ds_tipo_acomodacao_w, 
				ds_acomodacao_w, 
				ds_cns_w, 
				cd_matricula_familia_w, 
				ds_titular_w, 
				ds_titularidade_w, 
				ds_pessoa_w, 
				ie_segmentacao_w, 
				cd_rede_refer_ptu_w 
			from	pls_intercambio		f, 
				pls_plano		d, 
				pls_segurado_carteira	c, 
				pls_segurado		b, 
				pessoa_fisica		a 
			where	c.nr_seq_segurado	= b.nr_sequencia 
			and	b.nr_seq_plano		= d.nr_sequencia 
			and	b.cd_pessoa_fisica	= a.cd_pessoa_fisica 
			and	b.nr_seq_intercambio	= f.nr_sequencia 
			and	b.nr_sequencia		= c01_w.nr_seq_segurado;
		end if;
		 
		if (nr_seq_plano_w IS NOT NULL AND nr_seq_plano_w::text <> '') then 
			select	max(ie_tipo_rede_min) 
			into STRICT	ie_tipo_rede_min_w 
			from	ptu_rede_referenciada 
			where	cd_rede	= cd_rede_refer_ptu_w;
			 
			if (ie_tipo_rede_min_w = 1) then 
				ds_rede_atendimento_w	:= cd_rede_refer_ptu_w || ' Básico';
			else 
				ds_rede_atendimento_w	:= cd_rede_refer_ptu_w || ' '|| substr(pls_obter_rede_ref_produto(nr_seq_plano_w,cd_estabelecimento_p,'DT'), 1, 30);
			end if;
		end if;
		 
		cd_usuario_plano_w	:= substr(cd_usuario_plano_w,1,1)||' '||substr(cd_usuario_plano_w,2,3)||' '||substr(cd_usuario_plano_w,5,12)||' '||substr(cd_usuario_plano_w,17,1);
		ds_carencia_w		:= '';
		 
		declare 
			qt_lida_mensagens_w		bigint := 0;
		begin 
			 
			for c04_w in C04(nr_seq_contrato_w, nr_seq_intercambio_w, c01_w.ie_tipo_contrato) loop 
				if (clock_timestamp() > c04_w.dt_fim_vigencia) then 
					ds_carencia_w	:= ds_carencia_w || rpad(c04_w.ds_mensagem, 22) || ' ' || 'IMEDIATO ;';
				else 
					ds_carencia_w	:= ds_carencia_w || rpad(c04_w.ds_mensagem, 22) || ' ' || to_char(c04_w.dt_fim_vigencia, 'dd/mm/yyyy') ||';';
				end if;
				 
				qt_lida_mensagens_w	:= qt_lida_mensagens_w + 1;
			end loop;
			 
			for i in 1..12-qt_lida_mensagens_w loop 
				if (i < 12-qt_lida_mensagens_w) then 
					ds_carencia_w	:= ds_carencia_w || pls_obter_dados_cart_unimed(c01_w.nr_seq_segurado, nr_seq_plano_w, 'CAM6', i) || ';';
				else 
					ds_carencia_w	:= ds_carencia_w || pls_obter_dados_cart_unimed(c01_w.nr_seq_segurado, nr_seq_plano_w, 'CAM6', i);
				end if;
			end loop;
		end;
		 
		if (coalesce(cd_pf_estipulante_w::text, '') = '') then 
			nm_empresa_w	:= substr(coalesce(obter_dados_pf_pj('',cd_cgc_estipulante_w,'ABV'),obter_dados_pf_pj('',cd_cgc_estipulante_w,'F')),1,18);
		else 
			nm_empresa_w	:= substr(obter_nome_pf(cd_pf_estipulante_w),1,18);
		end if;
		 
		ds_regiao_w	:= '';
		 
		ds_regiao_1_w	:= '';
		ds_regiao_2_w	:= '';
		ds_regiao_3_w	:= '';
		ds_regiao_4_w	:= '';
		ds_regiao_5_w	:= '';
		 
		if (ie_tipo_segurado_w = 'R') then 
			begin 
			select	max(b.nm_fantasia), 
				'Tipo: ' || CASE WHEN c.ie_tipo_repasse='C' THEN 'Custo'  ELSE 'Pré-pagamento' END  ds_tipo_repasse, 
				/*'Dt Repasse: '||*/
to_char(c.dt_repasse,'dd/mm/yyyy') dt_repasse, 
				CASE WHEN c.dt_fim_repasse='' THEN ''  ELSE 'Fim Repasse: '||to_char(c.dt_fim_repasse,'dd/mm/yyyy') END  dt_fim_repasse 
			into STRICT	ds_congenere_w, 
				ds_tipo_repasse_w, 
				dt_repasse_w, 
				dt_fim_repasse_w 
			from	pls_segurado_repasse	c, 
				pessoa_juridica		b, 
				pls_congenere		a 
			where	b.cd_cgc		= a.cd_cgc 
			and	a.nr_sequencia		= c.nr_seq_congenere_atend 
			and	c.nr_seq_segurado	= c01_w.nr_seq_segurado 
			and	(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '') 
			and (coalesce(c.dt_fim_repasse::text, '') = '' or trunc(c.dt_fim_repasse,'month') > trunc(clock_timestamp(),'month')) 
			group by 
				b.nm_fantasia, c.ie_tipo_repasse, c.dt_repasse, c.dt_fim_repasse;
			exception 
			when others then 
				ds_congenere_w		:= null;
				ds_tipo_repasse_w	:= null;
				dt_repasse_w		:= null;
				dt_fim_repasse_w	:= null;
			end;
		 
			ds_regiao_1_w		:= 'REPASSE ATT. ' || ds_congenere_w;
			nm_operadora_repasse_w	:= 'Repasse: ' || ds_congenere_w;
		else 
			if (cd_abrangencia_w = 'GM') then 
				for c02_w in C02(nr_seq_plano_w) loop 
					if (length(ds_regiao_1_w || c02_w.ds_municipio) + 2 <= 42) then 
						ds_regiao_1_w := ' ' || c02_w.ds_municipio || ',' || ds_regiao_1_w;
					elsif (length(ds_regiao_2_w || c02_w.ds_municipio) + 2 <= 75) then 
						ds_regiao_2_w := ' ' || c02_w.ds_municipio || ',' || ds_regiao_2_w;
					elsif (length(ds_regiao_3_w || c02_w.ds_municipio) + 2 <= 75) then 
						ds_regiao_3_w := ' ' || c02_w.ds_municipio || ',' || ds_regiao_3_w;
					elsif (length(ds_regiao_4_w || c02_w.ds_municipio) + 2 <= 75) then 
						ds_regiao_4_w := ' ' || c02_w.ds_municipio || ',' || ds_regiao_4_w;
					elsif (length(ds_regiao_5_w || c02_w.ds_municipio) + 2 <= 75) then 
						ds_regiao_5_w := ' ' || c02_w.ds_municipio || ',' || ds_regiao_5_w;
					end if;
				end loop;
				 
				ds_regiao_1_w := 'Abrangência Grupo de Municípios:' || ds_regiao_1_w;
			elsif (cd_abrangencia_w = 'GE') then 
				for c03_w in C03(nr_seq_plano_w) loop 
					if (length(ds_regiao_1_w || c03_w.sg_uf_municipio) + 2 <= 45) then 
						ds_regiao_1_w := ' ' || c03_w.sg_uf_municipio || ',' || ds_regiao_1_w;
					elsif (length(ds_regiao_2_w || c03_w.sg_uf_municipio) + 2 <= 75) then 
						ds_regiao_2_w := ' ' || c03_w.sg_uf_municipio || ',' || ds_regiao_2_w;
					elsif (length(ds_regiao_3_w || c03_w.sg_uf_municipio) + 2 <= 75) then 
						ds_regiao_3_w := ' ' || c03_w.sg_uf_municipio || ',' || ds_regiao_3_w;
					elsif (length(ds_regiao_4_w || c03_w.sg_uf_municipio) + 2 <= 75) then 
						ds_regiao_4_w := ' ' || c03_w.sg_uf_municipio || ',' || ds_regiao_4_w;
					elsif (length(ds_regiao_5_w || c03_w.sg_uf_municipio) + 2 <= 75) then 
						ds_regiao_5_w := ' ' || c03_w.sg_uf_municipio || ',' || ds_regiao_5_w;
					end if;
				end loop;
				 
				ds_regiao_1_w := 'Abrangência Grupo de Estados: ' || ds_regiao_1_w;
			end if;
		end if;
		 
		if (ds_regiao_5_w IS NOT NULL AND ds_regiao_5_w::text <> '') then 
			if (substr(ds_regiao_5_w, length(ds_regiao_5_w), 1) = ',') then 
				ds_regiao_5_w:= substr(ds_regiao_5_w, 1, length(ds_regiao_5_w) - 1);
			end if;
		elsif (ds_regiao_4_w IS NOT NULL AND ds_regiao_4_w::text <> '') then 
			if (substr(ds_regiao_4_w, length(ds_regiao_4_w), 1) = ',') then 
				ds_regiao_4_w:= substr(ds_regiao_4_w, 1, length(ds_regiao_4_w) - 1);
			end if;
		elsif (ds_regiao_3_w IS NOT NULL AND ds_regiao_3_w::text <> '') then 
			if (substr(ds_regiao_3_w, length(ds_regiao_3_w), 1) = ',') then 
				ds_regiao_3_w:= substr(ds_regiao_3_w, 1, length(ds_regiao_3_w) - 1);
			end if;
		elsif (ds_regiao_2_w IS NOT NULL AND ds_regiao_2_w::text <> '') then 
			if (substr(ds_regiao_2_w, length(ds_regiao_2_w), 1) = ',') then 
				ds_regiao_2_w:= substr(ds_regiao_2_w, 1, length(ds_regiao_2_w) - 1);
			end if;
		else 
			if (substr(ds_regiao_1_w, length(ds_regiao_1_w), 1) = ',') then 
				ds_regiao_1_w:= substr(ds_regiao_1_w, 1, length(ds_regiao_1_w) - 1);
			end if;
		end if;
		 
		ds_regiao_2_w	:= coalesce(substr(ds_regiao_2_w, 2, length(ds_regiao_2_w) - 1), ' ');
		ds_regiao_3_w	:= coalesce(substr(ds_regiao_3_w, 2, length(ds_regiao_3_w) - 1), ' ');
		ds_regiao_4_w	:= coalesce(substr(ds_regiao_4_w, 2, length(ds_regiao_4_w) - 1), ' ');
		ds_regiao_5_w	:= coalesce(substr(ds_regiao_5_w, 2, length(ds_regiao_5_w) - 1), ' ');
		 
		ds_regiao_w	:= rpad(ds_regiao_1_w, 75) || ';' || rpad(ds_regiao_2_w, 75) || ';' || rpad(ds_regiao_3_w, 75) || ';' || rpad(ds_regiao_4_w, 75) || ';' || rpad(ds_regiao_5_w, 75);
		 
		ds_mensagem_cpt_w	:= pls_obter_dados_cart_unimed(c01_w.nr_seq_segurado, nr_seq_plano_w,'DCPT',6);
		 
		if (c01_w.ie_tipo_contrato = 'C') then 
			select	max(ds_mensagem) 
			into STRICT	ds_abrangencia_aux_w 
			from	pls_contrato_mensagem_cart 
			where	nr_seq_contrato			= nr_seq_contrato_w 
			and	coalesce(ie_mensagem_carencia,'N')	= 'N' 
			and	ie_mensagem_abrangencia		= 'S' 
			and	ie_situacao			= 'A' 
			and	clock_timestamp() between coalesce(dt_inicio_vigencia,clock_timestamp()) and coalesce(dt_fim_vigencia,clock_timestamp());
		elsif (c01_w.ie_tipo_contrato = 'I') then 
			select	max(ds_mensagem) 
			into STRICT	ds_abrangencia_aux_w 
			from	pls_contrato_mensagem_cart 
			where	nr_seq_intercambio		= nr_seq_intercambio_w 
			and	coalesce(ie_mensagem_carencia,'N')	= 'N' 
			and	ie_mensagem_abrangencia		= 'S' 
			and	ie_situacao			= 'A' 
			and	clock_timestamp() between coalesce(dt_inicio_vigencia,clock_timestamp()) and coalesce(dt_fim_vigencia,clock_timestamp());
		end if;		
		 
		if ((trim(both ds_abrangencia_aux_w) IS NOT NULL AND (trim(both ds_abrangencia_aux_w))::text <> '')) then 
			ds_abrangencia_w	:= ds_abrangencia_aux_w;
			ds_regiao_w		:= '';
		end if;
		 
		ds_abrangencia_w	:= replace(ds_abrangencia_w,'Í','I');
		nm_beneficiario_w	:= Elimina_Acentuacao(nm_beneficiario_w);
		ds_carencia_w		:= Elimina_Acentuacao(ds_carencia_w);
		ds_regiao_w		:= Elimina_Acentuacao(ds_regiao_w);
		ds_produto_w		:= Elimina_Acentuacao(ds_produto_w);
		 
		cd_local_cobranca_w	:= lpad(pls_obter_area_cobranca(c01_w.nr_seq_segurado,cd_estabelecimento_p),4,'0');
		 
		insert into w_pls_interface_carteira(	nr_sequencia, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_lote, ie_tipo_reg, 
				cd_usuario_plano, dt_nascimento, ds_tipo_contratacao, dt_validade_carteira, nm_beneficiario, cd_local_cobranca, nm_plano, 
				ds_abrangencia, ds_registro_ans, ds_acomodacao, dt_cpt, ds_rede_atendimento, ds_carencia, nr_protocolo_ans, 
				ds_trilha_1, ds_trilha_2, nr_via_cartao, ds_regiao, ds_estipulante, ds_observacao_2,cd_matricula_familiar, ds_cns, 
				ds_pessoa, ds_titular, ds_titularidade, ds_segmentacao, dt_adesao, nm_operadora_repasse, 
				ds_tipo_repasse, dt_repasse, dt_fim_repasse) 
		values (	nextval('w_pls_interface_carteira_seq'), clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p, nr_seq_lote_p, 2, 
				cd_usuario_plano_w, dt_nascimento_w, tp_contratacao_w, dt_validade_carteira_w, nm_beneficiario_w, cd_local_cobranca_w, ds_produto_w, 
				ds_abrangencia_w, ds_registro_ans_w, ds_acomodacao_w, ds_mensagem_cpt_w, ds_rede_atendimento_w, ds_carencia_w, nr_protocolo_ans_w, 
				rpad(ds_trilha_1_w, 50), rpad(ds_trilha_2_w, 50), nr_via_solicitacao_w, ds_regiao_w, nm_empresa_w, ds_tipo_acomodacao_w, cd_matricula_familia_w, ds_cns_w, 
				ds_pessoa_w, ds_titular_w, ds_titularidade_w,ie_segmentacao_w, dt_inicio_vigencia_w, nm_operadora_repasse_w, 
				ds_tipo_repasse_w, dt_repasse_w, dt_fim_repasse_w);
	end loop;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_cart_unimed_maringa ( nr_seq_lote_p bigint, cd_interface_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

