-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_copiar_itens_atend ( dt_referencia_p timestamp, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE


_ora2pg_r RECORD;
dt_ref_copia_w				timestamp;
dt_ref_cop_fut_w			timestamp;
cd_estabelecimento_w			bigint;
nm_usuario_w				usuario.nm_usuario%type;
nr_atendimento_w			atendimento_paciente.nr_atendimento%type;
nr_atendimento_old_w			atendimento_paciente.nr_atendimento%type;
cd_setor_atendimento_w			setor_atendimento.cd_setor_atendimento%type;
cd_perfil_ativo_w			atendimento_paciente.cd_perfil_ativo%type;
cd_pessoa_fisica_w			pessoa_fisica.cd_pessoa_fisica%type;
dt_alta_w				atendimento_paciente.dt_alta%type;
ie_tipo_item_w				cpoe_horas_fut_copia.ie_tipo_item%type;
qt_horas_w				cpoe_horas_fut_copia.qt_horas%type;
qt_hors_copia_w				bigint;
nr_seq_log_w				bigint;
ie_susp_prescricoes_alta_w		varchar(1);
qt_itens_w				bigint;
ie_adep_w				prescr_medica.ie_adep%type;
dt_inicio_copia_w			timestamp;
ie_agrupar_lote_copia_w 		parametros_farmacia.ie_agrupar_lote_copia%type;
qt_hors_before_w			smallint;
dt_inicio_regra_w			timestamp;
dt_fim_regra_w				timestamp;
is_antecipated_batch_w			varchar(1);
ds_locale_w				varchar(20);
sql_w               varchar(300);
ie_exit_loop_w       varchar(1);

c01 CURSOR FOR
SELECT	distinct
		nr_atendimento,
		cd_pessoa_fisica,
		nm_usuario,
		cd_perfil_ativo,
		ie_adep
from	(	SELECT	a.nr_atendimento,
					a.cd_pessoa_fisica,
					a.nm_usuario_nrec nm_usuario,
					a.cd_perfil_ativo,
					coalesce(ie_adep, 'S') ie_adep
			from	cpoe_material a
			where	((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= a.dt_prox_geracao + (qt_hors_copia_w/24)) or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
			and		a.dt_prox_geracao between dt_ref_copia_w - 3 and dt_ref_copia_w - 1/86400
			and		(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '')
			and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			and		coalesce(a.nr_seq_receita_amb,0) = 0
			and		coalesce(a.ie_retrogrado,'N') = 'N'
			and		((((coalesce(a.ie_evento_unico,'N') = 'N') and (coalesce(a.nr_seq_adicional::text, '') = '') and (coalesce(a.nr_seq_ataque::text, '') = '')) and (coalesce(a.ie_material,'N') = 'N')) or (not exists (	select	1
									from	prescr_medica y,
											prescr_material z
									where	y.nr_prescricao = z.nr_prescricao
									and		y.nr_atendimento = a.nr_atendimento
									and		z.nr_seq_mat_cpoe = a.nr_sequencia)))
			and 	((ie_susp_prescricoes_alta_w = 'S') or (((coalesce(a.ie_baixado_por_alta, 'N') = 'N') or (coalesce(a.dt_alta_medico, clock_timestamp()) > a.dt_prox_geracao + (qt_hors_copia_w/24)))))
			and		coalesce(a.ie_material,'N') = 'N'
			and		coalesce(a.cd_funcao_origem,2314) = 2314
			and		((cpoe_obter_se_copia_item_term(a.ds_horarios,
													a.cd_intervalo,
													a.dt_prox_geracao + (qt_hors_copia_w/24),
													CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) END ) = 'S') or
						((coalesce(a.dt_fim::text, '') = '') and a.ie_duracao = 'C'))	
			
union all
 /*weekly dispensation*/
			select	a.nr_atendimento,
					a.cd_pessoa_fisica,
					a.nm_usuario_nrec nm_usuario,
					a.cd_perfil_ativo,
					coalesce(ie_adep, 'S') ie_adep
			from	cpoe_material a
			where	((CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= (a.dt_prox_geracao + (qt_hors_copia_w/24))) or (CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
			and		a.dt_prox_geracao  between dt_inicio_regra_w - (qt_hors_copia_w/24) and dt_fim_regra_w - (qt_hors_copia_w/24) - 1/86400
			and		dt_ref_copia_w > (dt_inicio_regra_w - 1)
			and		(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '')
			and 	coalesce(is_antecipated_batch_w, 'N') = 'Y'
			and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			and		(nr_atendimento IS NOT NULL AND nr_atendimento::text <> '')
			and		coalesce(a.nr_seq_receita_amb,0) = 0
			and		coalesce(a.ie_retrogrado,'N') = 'N'
			and		((((coalesce(a.ie_evento_unico,'N') = 'N') and (coalesce(a.nr_seq_adicional::text, '') = '') and (coalesce(a.nr_seq_ataque::text, '') = '')) and (coalesce(a.ie_material,'N') = 'N')) or (not exists (	select	1
									from	prescr_medica y,
											prescr_material z
									where	y.nr_prescricao = z.nr_prescricao
									and		(y.nr_atendimento IS NOT NULL AND y.nr_atendimento::text <> '')
									and		z.nr_seq_mat_cpoe = a.nr_sequencia )))		
			and 	((ie_susp_prescricoes_alta_w = 'S') or (((coalesce(a.ie_baixado_por_alta, 'N') = 'N') or (coalesce(a.dt_alta_medico, clock_timestamp()) > a.dt_prox_geracao + (qt_hors_copia_w/24)))))
			and		coalesce(a.cd_funcao_origem,2314) = 2314
			and		((cpoe_obter_se_copia_item_term(a.ds_horarios, a.cd_intervalo, a.dt_prox_geracao + (qt_hors_copia_w/24), CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) END ) = 'S') or ((coalesce(a.dt_fim::text, '') = '') and a.ie_duracao = 'C'))
			
union all

			select	a.nr_atendimento,
					a.cd_pessoa_fisica,
					a.nm_usuario_nrec,
					a.cd_perfil_ativo,
					coalesce(ie_adep, 'S') ie_adep
			from	cpoe_dieta a
			where	((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= a.dt_prox_geracao + (qt_hors_copia_w/24)) or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
			and		a.dt_prox_geracao between dt_ref_copia_w - 3 and dt_ref_copia_w - 1/86400
			and		(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '')
			and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			and		coalesce(a.ie_retrogrado,'N') = 'N'
			and		((coalesce(a.ie_evento_unico,'N') = 'N') or (not exists (	select	1
									from	prescr_medica y
									where	y.nr_atendimento = a.nr_atendimento
									and		exists (	select	1
														from	prescr_material z
														where	z.nr_prescricao = y.nr_prescricao
														and		z.nr_seq_dieta_cpoe = a.nr_sequencia
														
union

														select	1
														from	prescr_dieta z
														where	z.nr_prescricao = y.nr_prescricao
														and		z.nr_seq_dieta_cpoe = a.nr_sequencia
														
union

														select	1
														from	rep_jejum z
														where	z.nr_prescricao = y.nr_prescricao
														and		z.nr_seq_dieta_cpoe = a.nr_sequencia
														
union

														select	1
														from	prescr_leite_deriv z
														where	z.nr_prescricao = y.nr_prescricao
														and		z.nr_seq_dieta_cpoe = a.nr_sequencia
														
union

														select	1
														from	nut_pac z
														where	z.nr_prescricao = y.nr_prescricao
														and		z.nr_seq_npt_cpoe = a.nr_sequencia))))
			and 	((ie_susp_prescricoes_alta_w = 'S') or (((coalesce(a.ie_baixado_por_alta, 'N') = 'N') or (coalesce(a.dt_alta_medico, clock_timestamp()) > a.dt_prox_geracao + (qt_hors_copia_w/24)))))
			and		coalesce(a.ie_dose_unica,'N') = 'N'
			and		coalesce(a.cd_funcao_origem,2314) = 2314
			and		((cpoe_obter_se_copia_item_term(a.ds_horarios,
													a.cd_intervalo,
													a.dt_prox_geracao + (qt_hors_copia_w/24),
													CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END ) = 'S') or
						((coalesce(a.dt_fim::text, '') = '') and a.ie_duracao = 'C'))
			
union all

			select	a.nr_atendimento,
					a.cd_pessoa_fisica,
					a.nm_usuario_nrec,
					a.cd_perfil_ativo,
					coalesce(ie_adep, 'S') ie_adep
			from	cpoe_recomendacao a
			where	((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= a.dt_prox_geracao + (qt_hors_copia_w/24)) or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
			and		a.dt_prox_geracao between dt_ref_copia_w - 3 and dt_ref_copia_w - 1/86400
			and		(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '')
			and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			and		coalesce(a.ie_retrogrado,'N') = 'N'
			and		((coalesce(a.ie_evento_unico,'N') = 'N') or (not exists (	select	1
									from	prescr_medica y,
											prescr_recomendacao z
									where	y.nr_prescricao = z.nr_prescricao
									and		y.nr_atendimento = a.nr_atendimento
									and		z.nr_seq_rec_cpoe = a.nr_sequencia)))
			and 	((ie_susp_prescricoes_alta_w = 'S') or (((coalesce(a.ie_baixado_por_alta, 'N') = 'N') or (coalesce(a.dt_alta_medico, clock_timestamp()) > a.dt_prox_geracao + (qt_hors_copia_w/24)))))			
			and		coalesce(a.cd_funcao_origem,2314) = 2314
			and		((cpoe_obter_se_copia_item_term(a.ds_horarios,
													a.cd_intervalo,
													a.dt_prox_geracao + (qt_hors_copia_w/24),
													CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END ) = 'S') or
						((coalesce(a.dt_fim::text, '') = '') and a.ie_duracao = 'C'))
			
union all

			select	a.nr_atendimento,
					a.cd_pessoa_fisica,
					a.nm_usuario_nrec,
					a.cd_perfil_ativo,
					coalesce(ie_adep, 'S') ie_adep
			from	cpoe_gasoterapia a
			where	((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= a.dt_prox_geracao + (qt_hors_copia_w/24)) or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
			and		a.dt_prox_geracao between dt_ref_copia_w - 3 and dt_ref_copia_w - 1/86400
			and		(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '')
			and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			and		coalesce(a.ie_retrogrado,'N') = 'N'
			and 	((ie_susp_prescricoes_alta_w = 'S') or (((coalesce(a.ie_baixado_por_alta, 'N') = 'N') or (coalesce(a.dt_alta_medico, clock_timestamp()) > a.dt_prox_geracao + (qt_hors_copia_w/24)))))
			and		coalesce(a.cd_funcao_origem,2314) = 2314
			and		((cpoe_obter_se_copia_item_term(a.ds_horarios,
													a.cd_intervalo,
													a.dt_prox_geracao + (qt_hors_copia_w/24),
													CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END ) = 'S') or
						((coalesce(a.dt_fim::text, '') = '') and a.ie_duracao = 'C'))
			
union all

			select	a.nr_atendimento,
					a.cd_pessoa_fisica,
					a.nm_usuario_nrec,
					a.cd_perfil_ativo,
					coalesce(ie_adep, 'S') ie_adep
			from	cpoe_procedimento a,
					proc_interno	b
			where	((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= a.dt_prox_geracao + (qt_hors_copia_w/24)) or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
			and		a.nr_seq_proc_interno = b.nr_sequencia
			and		a.dt_prox_geracao between dt_ref_copia_w - 3 and dt_ref_copia_w
			and		(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '')
			and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			and		((coalesce(b.ie_copiar_rep,'S') <> 'C') or (not exists (	select	1
									from	prescr_medica y,
											prescr_procedimento z
									where	y.nr_prescricao = z.nr_prescricao
									and		y.nr_atendimento = a.nr_atendimento
									and		z.nr_seq_proc_cpoe = a.nr_sequencia)))
			and		coalesce(a.ie_retrogrado,'N') = 'N'
			and		((coalesce(a.ie_evento_unico,'N') = 'N') or (not exists (	select	1
									from	prescr_medica y,
											prescr_procedimento z
									where	y.nr_prescricao = z.nr_prescricao
									and		y.nr_atendimento = a.nr_atendimento
									and		z.nr_seq_proc_cpoe = a.nr_sequencia)))
			and 	((ie_susp_prescricoes_alta_w = 'S') or (((coalesce(a.ie_baixado_por_alta, 'N') = 'N') or (coalesce(a.dt_alta_medico, clock_timestamp()) > a.dt_prox_geracao + (qt_hors_copia_w/24)))))
			and		coalesce(a.cd_funcao_origem,2314) = 2314
			and		((cpoe_obter_se_copia_item_term(a.ds_horarios,
													a.cd_intervalo,
													a.dt_prox_geracao + (qt_hors_copia_w/24),
													CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END ) = 'S') or
						((coalesce(a.dt_fim::text, '') = '') and a.ie_duracao = 'C'))
			
union all

			select	a.nr_atendimento,
					a.cd_pessoa_fisica,
					a.nm_usuario_nrec,
					a.cd_perfil_ativo,
					coalesce(ie_adep, 'S') ie_adep
			from	cpoe_dialise a
			where	((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= a.dt_prox_geracao + (qt_hors_copia_w/24)) or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
			and		a.dt_prox_geracao between dt_ref_copia_w - 3 and dt_ref_copia_w - 1/86400
			and		(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '')
			and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			and		coalesce(a.ie_retrogrado,'N') = 'N'
			and 	((ie_susp_prescricoes_alta_w = 'S') or (((coalesce(a.ie_baixado_por_alta, 'N') = 'N') or (coalesce(a.dt_alta_medico, clock_timestamp()) > a.dt_prox_geracao + (qt_hors_copia_w/24)))))
			and		coalesce(a.cd_funcao_origem,2314) = 2314
			and		((cpoe_obter_se_copia_item_term(a.ds_horarios,
													null,
													a.dt_prox_geracao + (qt_hors_copia_w/24),
													CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END ) = 'S') or
						((coalesce(a.dt_fim::text, '') = '') and a.ie_duracao = 'C'))) alias295
order by nr_atendimento;

c02 CURSOR FOR
SELECT	ie_tipo_item,
		qt_horas
from	cpoe_horas_fut_copia
where	coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
and		coalesce(qt_horas,0) > 0;

	procedure adjust_properties_nls is
	;
BEGIN
	
	EXECUTE 'ALTER SESSION SET NLS_LANGUAGE=''BRAZILIAN PORTUGUESE''';
	EXECUTE 'ALTER SESSION SET NLS_TERRITORY = ''BRAZIL''';
	EXECUTE 'ALTER SESSION SET NLS_NUMERIC_CHARACTERS='',.''';
	EXECUTE 'ALTER SESSION SET NLS_DATE_FORMAT = ''DD/MM/YYYY HH24:MI:SS''';
	
	end;

begin

CALL gravar_log_cpoe('CPOE_COPIAR_ITENS_ATEND LOG - DT_REFERENCIA_P: '||to_char(dt_referencia_p,'dd/mm/yyyy hh24:mi:ss'));

commit;

adjust_properties_nls;
ie_susp_prescricoes_alta_w := Obter_param_Usuario(3111, 162, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_susp_prescricoes_alta_w);

 begin
      sql_w := 'CALL GET_QT_HOURS_AFTER_COPY_CPOE(:1, :2, :3) INTO :qt_hors_copia_w';
      EXECUTE sql_w USING IN obter_perfil_ativo,
                                    IN nm_usuario_p,
                                    IN cd_estabelecimento_p,
                                    OUT qt_hors_copia_w;

  exception
    when others then
      qt_hors_copia_w := null;
  end;

  begin
      sql_w := 'CALL GET_QT_HOURS_BEFORE_COPY(:1, :2, :3) INTO :qt_hors_before_w';
      EXECUTE sql_w USING IN obter_perfil_ativo,
                                    IN nm_usuario_p,
                                    IN cd_estabelecimento_p,
                                    OUT qt_hors_before_w;

  exception
    when others then
      qt_hors_before_w := null;
  end;

  begin
      sql_w := 'CALL OBTER_HORA_REF_COPIA_CPOE_MD(:1, :2) INTO :dt_ref_copia_w';
      EXECUTE sql_w USING IN trunc(dt_referencia_p,'hh24'),
                                    IN qt_hors_before_w,
                                    OUT dt_ref_copia_w;

  exception
    when others then
      dt_ref_copia_w := null;
  end;

dt_inicio_copia_w 	:= dt_referencia_p;
nr_atendimento_old_w := 0;

SELECT * FROM cpoe_get_antecipated_batch(dt_ref_copia_w, null, null) INTO STRICT _ora2pg_r;
 is_antecipated_batch_w := _ora2pg_r.si_anticipation_p; dt_inicio_regra_w := _ora2pg_r.dt_inicio_p; dt_fim_regra_w := _ora2pg_r.dt_fim_p;

open c01;
loop
fetch c01 into	nr_atendimento_w,
                cd_pessoa_fisica_w,
                nm_usuario_w,
                cd_perfil_ativo_w,
                ie_adep_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
    begin
    adjust_properties_nls;
    nm_usuario_w			:= coalesce(nm_usuario_w, nm_usuario_p);

    if (coalesce(philips_param_pck.get_nr_seq_idioma::text, '') = '') then
        CALL philips_param_pck.set_nr_seq_idioma(obter_nr_seq_idioma(nm_usuario_w));
	
	select	max(ds_language_tag)
	into STRICT	ds_locale_w
	from	tasy_idioma
	where	nr_sequencia = philips_param_pck.get_nr_seq_idioma;
	
	if (ds_locale_w IS NOT NULL AND ds_locale_w::text <> '') then
		CALL pkg_i18n.set_user_locale(ds_locale_w);
	end if;
	
    end if;

    cd_perfil_ativo_w 		:=coalesce(cd_perfil_ativo_w, cd_perfil_p);
    cd_setor_atendimento_w 	:= obter_unidade_atendimento(nr_atendimento_w,'IA','CS');
    if (coalesce(nr_atendimento_w,0) <> coalesce(nr_atendimento_old_w,0)) or (coalesce(nr_atendimento_old_w,0) = 0) then
        nr_atendimento_old_w	:= nr_atendimento_w;
        begin
        adjust_properties_nls;		
        cd_estabelecimento_w   := obter_estabelecimento_setor(cd_setor_atendimento_w);
        if (coalesce(cd_estabelecimento_w::text, '') = '') then
            select	max(cd_estabelecimento)
            into STRICT	cd_estabelecimento_w
            from	atendimento_paciente
            where	nr_atendimento = nr_atendimento_w;
        end if;
        exception when others then
            cd_setor_atendimento_w := null;
        end;
    end if;

    select	max(dt_alta)
    into STRICT	dt_alta_w
    from	atendimento_paciente
    where	nr_atendimento	= nr_atendimento_w;

    if (coalesce(dt_alta_w::text, '') = '') then
        if (coalesce(cd_estabelecimento_w::text, '') = '') then
            cd_estabelecimento_w := cd_estabelecimento_p;
        end if;
        CALL cpoe_copiar_itens( nr_atendimento_w, dt_ref_copia_w, nm_usuario_w, cd_perfil_ativo_w, null, cd_estabelecimento_w, cd_pessoa_fisica_w, 'N', ie_adep_w, dt_inicio_copia_w);

        dt_ref_cop_fut_w := dt_ref_copia_w;
        open c02;
        loop
        fetch c02 into	ie_tipo_item_w,
                        qt_horas_w;
        EXIT WHEN NOT FOUND; /* apply on c02 */
            begin
            loop
                begin
               
                begin
                    sql_w := 'CALL OBTER_DEF_COP_FUT_CPOE_MD(:1) INTO :dt_ref_cop_fut_w';
                    EXECUTE sql_w USING IN dt_ref_cop_fut_w,
                                                  OUT dt_ref_cop_fut_w;
                exception
                  when others then
                    dt_ref_cop_fut_w := null;
                end;

                CALL cpoe_copiar_itens( nr_atendimento_w, dt_ref_cop_fut_w, nm_usuario_w, cd_perfil_ativo_w, null, cd_estabelecimento_w, cd_pessoa_fisica_w, ie_tipo_item_w, ie_adep_w);
                begin
                    sql_w := 'CALL EXIT_LOOP_DT_REF_COPIA_MD(:1, :2, :3) INTO :ie_exit_loop_w';
                    EXECUTE sql_w USING IN dt_ref_cop_fut_w,
                                                  IN dt_ref_copia_w, 
                                                  IN qt_horas_w,                                   
                                                  OUT ie_exit_loop_w;
                exception
                  when others then
                    ie_exit_loop_w := 'S';
                end;

                exit when(ie_exit_loop_w = 'S');
                --FIM MD 2
                end;
            end loop;
            end;
        end loop;
        close c02;

    end if;	
    end;
end loop;
close c01;

CALL gerar_lote_agrupamento(0,0,cd_estabelecimento_p,nm_usuario_w);

begin

    select	count(*)
    into STRICT	qt_itens_w
    from	prescr_medica
    where	dt_atualizacao between dt_referencia_p and obter_data_maior(clock_timestamp(), dt_ref_copia_w)
    and	(nr_prescricoes IS NOT NULL AND nr_prescricoes::text <> '')
    and	cd_funcao_origem = 2314;

    if (qt_itens_w > 0) then
        CALL gravar_log_cpoe('CPOE_COPIAR_ITENS_ATEND LOG - DT_REFERENCIA_P: '||to_char(dt_referencia_p,'dd/mm/yyyy hh24:mi:ss') || ' Qtd: ' || qt_itens_w);
        commit;
    end if;

    CALL gravar_log_cpoe('CPOE_COPIAR_ITENS_ATEND LOG - IDENTIFICADOR PROCESSO  ', null, null, null, 'JOB');
    commit;

exception
	when others then
	null;
end;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_copiar_itens_atend ( dt_referencia_p timestamp, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

