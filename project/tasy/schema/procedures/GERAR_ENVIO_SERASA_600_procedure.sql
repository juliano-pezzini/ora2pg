-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_envio_serasa_600 ( nr_seq_lote_p bigint, nm_usuario_p text, nr_seq_orgao_cobr_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE


ds_conteudo_w			varchar(4000);
cd_cgc_w			estabelecimento.cd_cgc%type;
nr_ddd_telefone_w			pessoa_juridica.nr_ddd_telefone%type;
nr_telefone_w			pessoa_juridica.nr_telefone%type;
nr_ramal_contato_w		pessoa_juridica.nr_ramal_contato%type;
nm_pessoa_contato_w		pessoa_juridica.nm_pessoa_contato%type;
nr_seq_remessa_w			orgao_cobranca.nr_seq_remessa%type;
ie_tipo_lote_w			lote_orgao_cobranca.ie_tipo_lote%type;
nr_seq_linha_w			integer := 0;
ie_controla_estab_w		varchar(1);
nr_seq_remessa_estab_w		orgao_cobranca.nr_seq_remessa%type;
-- Variavel para envio do estabelecimento no header do arquivo, deve ser varchar pois ira vazio caso nao tenha controle por estab
cd_estab_w			varchar(4);

c01 CURSOR FOR
	SELECT	a.cd_cgc cd_cgc,
		'F' ie_tipo_pessoa,
		a.nr_seq_cheque nr_seq_cheque,
		a.nr_seq_cobranca nr_seq_conranca,
		'2' ie_cgc_cpf,
		f.nr_cpf nr_identidade,
		upper(substr(obter_dados_pf_pj(a.cd_pessoa_fisica,null,'UF'),1,2)) ds_uf,
		upper(f.nm_pessoa_fisica) nm_nome,
		f.dt_nascimento dt_nascimento,
		upper(substr(obter_nome_pai_mae(a.cd_pessoa_fisica,'P'),1,70)) nm_pai,
		upper(substr(obter_nome_pai_mae(a.cd_pessoa_fisica,'M'),1,70)) nm_mae,
		upper(substr(ELIMINA_ACENTOS(obter_dados_pf_pj(a.cd_pessoa_fisica,null,'E')),1,45)) ds_end_completo,
		upper(substr(ELIMINA_ACENTOS(obter_dados_pf_pj(a.cd_pessoa_fisica,null,'B')),1,20)) ds_bairro,
		upper(substr(ELIMINA_ACENTOS(obter_dados_pf_pj(a.cd_pessoa_fisica,null,'CI')),1,25)) ds_municipio,
		lpad(somente_numero(to_char(a.vl_cheque,'9999999999990.00')),15,'0') vl_documento,
		upper(substr(ELIMINA_ACENTOS(obter_dados_pf_pj(a.cd_pessoa_fisica,null,'CO')),1,25)) ds_complemento,
		f.nr_ddd_celular nr_ddd_telefone,
		f.nr_telefone_celular nr_telefone,
		c.dt_vencimento dt_vencimento,
		to_char(c.vl_cheque,'999,999,999,990.00') vl_cheque_cr,
		null nr_nosso_numero,
		substr(ELIMINA_ACENTOS(obter_dados_pf_pj(a.cd_pessoa_fisica,null,'CEP')),1,25) ds_cep
	from	cheque_cr_orgao_cobr a,
		pessoa_fisica f,
		cheque_cr c
	where 	coalesce(a.nr_seq_lote_exc,a.nr_seq_lote) = nr_seq_lote_p /*OS 1389843 - Troquei pra primeiro verificar lote exclusao. A exclusao so ocorre apos inclusao. Da forma anterior, tava pegando o lote de inclusao para compara com o lote de exclusao*/
	and 	a.cd_pessoa_fisica = f.cd_pessoa_fisica
	and	a.nr_seq_cheque = c.nr_seq_cheque
	
union

	SELECT	a.cd_cgc cd_cgc,
		'J' ie_tipo_pessoa,
		a.nr_seq_cheque nr_seq_cheque,
		a.nr_seq_cobranca nr_seq_conranca,
		'1' ie_cgc_cpf,
		a.cd_cgc nr_identidade,
		upper(substr(obter_dados_pf_pj(a.cd_pessoa_fisica,a.cd_cgc,'UF'),1,2)) ds_uf,
		upper(j.nm_fantasia) nm_nome,
		j.dt_criacao dt_nascimento,
		null nm_pai,
		null nm_mae,
		upper(substr(ELIMINA_ACENTOS(obter_dados_pf_pj(null,a.cd_cgc,'E')),1,45)) ds_end_completo,
		upper(substr(ELIMINA_ACENTOS(obter_dados_pf_pj(null,a.cd_cgc,'B')),1,20)) ds_bairro,
		upper(substr(ELIMINA_ACENTOS(obter_dados_pf_pj(null,a.cd_cgc,'CI')),1,25)) ds_municipio,
		lpad(somente_numero(to_char(a.vl_cheque,'9999999999990.00')),15,'0') vl_documento,
		upper(substr(ELIMINA_ACENTOS(obter_dados_pf_pj(null,a.cd_cgc,'CO')),1,25)) ds_complemento,
		j.nr_ddd_telefone nr_ddd_telefone,
		j.nr_telefone nr_telefone,
		c.dt_vencimento dt_vencimento,
		to_char(c.vl_cheque,'999,999,999,990.00') vl_cheque_cr,
		null nr_nosso_numero,
		substr(ELIMINA_ACENTOS(obter_dados_pf_pj(null,a.cd_cgc,'CEP')),1,25) ds_cep
	from	cheque_cr_orgao_cobr a,
		pessoa_juridica j,
		cheque_cr c
	where 	coalesce(a.nr_seq_lote_exc, a.nr_seq_lote) = nr_seq_lote_p /*OS 1389843 - Troquei pra primeiro verificar lote exclusao. A exclusao so ocorre apos inclusao. Da forma anterior, tava pegando o lote de inclusao para compara com o lote de exclusao*/
	and 	a.cd_cgc = j.cd_cgc
	and 	a.nr_seq_cheque = c.nr_seq_cheque
	
union all

	select	b.cd_cgc cd_cgc,
		'F' ie_tipo_pessoa,
		b.nr_titulo nr_seq_cheque,
		b.nr_seq_cobranca nr_seq_cobranca,
		'2' ie_cgc_cpf,
		f.nr_cpf nr_identidade,
		upper(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'UF'),1,2)) ds_uf,
		upper(f.nm_pessoa_fisica) nm_nome,
		f.dt_nascimento dt_nascimento,
		upper(substr(obter_nome_pai_mae(b.cd_pessoa_fisica,'P'),1,70)) nm_pai, 
		upper(substr(obter_nome_pai_mae(b.cd_pessoa_fisica,'M'),1,70)) nm_mae,
		upper(substr(ELIMINA_ACENTOS(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'E')),1,45)) ds_end_completo,
		upper(substr(ELIMINA_ACENTOS(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'B')),1,20)) ds_bairro,
		upper(substr(ELIMINA_ACENTOS(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'CI')),1,25)) ds_municipio,
		lpad(somente_numero(to_char(b.vl_titulo,'9999999999990.00')),15,'0') vl_documento,
		upper(substr(ELIMINA_ACENTOS(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'CO')),1,25)) ds_complemento,
		f.nr_ddd_celular nr_ddd_telefone,
		f.nr_telefone_celular nr_telefone,
		t.dt_vencimento dt_vencimento,
		to_char(t.vl_titulo,'999,999,999,990.00') vl_cheque_cr,
		substr(t.nr_nosso_numero,1,9) nr_nosso_numero,
		substr(ELIMINA_ACENTOS(obter_dados_pf_pj(b.cd_pessoa_fisica,null,'CEP')),1,25) ds_cep
	from 	titulo_receber_orgao_cobr b,
		pessoa_fisica f,
		titulo_receber t
	where 	coalesce(b.nr_seq_lote_exc, b.nr_seq_lote) = nr_seq_lote_p /*OS 1389843 - Troquei pra primeiro verificar lote exclusao. A exclusao so ocorre apos inclusao. Da forma anterior, tava pegando o lote de inclusao para compara com o lote de exclusao*/
	and 	b.cd_pessoa_fisica = f.cd_pessoa_fisica
	and	b.nr_titulo = t.nr_titulo
	and	 ((coalesce(t.vl_saldo_titulo,0) > 0 AND (ie_tipo_lote_w = 'I')) OR (ie_tipo_lote_w = 'E'))--OS 1697874, somente gerar no arquivo se o titulo tiver saldo.
	
union

	select	b.cd_cgc cd_cgc,
		'J' ie_tipo_pessoa,
		b.nr_titulo nr_seq_cheque,
		b.nr_seq_cobranca nr_seq_cobranca,
		'1' ie_cgc_cpf,
		b.cd_cgc nr_identidade,
		upper(substr(obter_dados_pf_pj(b.cd_pessoa_fisica,b.cd_cgc,'UF'),1,2)) ds_uf,
		upper(j.nm_fantasia) nm_nome,
		j.dt_criacao dt_nascimento,
		null nm_pai,
		null nm_mae,
		upper(substr(ELIMINA_ACENTOS(obter_dados_pf_pj(null,b.cd_cgc,'E')),1,45)) ds_end_completo,
		upper(substr(ELIMINA_ACENTOS(obter_dados_pf_pj(null,b.cd_cgc,'B')),1,20)) ds_bairro,
		upper(substr(ELIMINA_ACENTOS(obter_dados_pf_pj(null,b.cd_cgc,'CI')),1,25)) ds_municipio,
		lpad(somente_numero(to_char(b.vl_titulo,'9999999999990.00')),15,'0') vl_documento,	
		upper(substr(ELIMINA_ACENTOS(obter_dados_pf_pj(null,b.cd_cgc,'CO')),1,25)) ds_complemento,
		j.nr_ddd_telefone nr_ddd_telefone,
		j.nr_telefone nr_telefone,
		t.dt_vencimento dt_vencimento,
		to_char(t.vl_titulo,'999,999,999,990.00') vl_cheque_cr,
		substr(t.nr_nosso_numero,1,9) nr_nosso_numero,
		substr(ELIMINA_ACENTOS(obter_dados_pf_pj(null,b.cd_cgc,'CEP')),1,25) ds_cep
	from 	titulo_receber_orgao_cobr b,
		pessoa_juridica j,
		titulo_receber t
	where 	coalesce(b.nr_seq_lote_exc, b.nr_seq_lote) = nr_seq_lote_p /*OS 1389843 - Troquei pra primeiro verificar lote exclusao. A exclusao so ocorre apos inclusao. Da forma anterior, tava pegando o lote de inclusao para compara com o lote de exclusao*/
	and 	b.cd_cgc = j.cd_cgc
	and 	b.nr_titulo = t.nr_titulo
	and	 ((coalesce(t.vl_saldo_titulo,0) > 0 AND (ie_tipo_lote_w = 'I')) OR (ie_tipo_lote_w = 'E')); --OS 1697874, somente gerar no arquivo se o titulo tiver saldo.
		
vet01	c01%rowtype;
	

BEGIN

delete from w_envio_orgao_cobranca where nm_usuario = nm_usuario_p;

select	coalesce(max(a.nr_seq_remessa),0) + 1,
	coalesce(max(ie_controla_estab),'N')
into STRICT	nr_seq_remessa_w,
	ie_controla_estab_w
from	orgao_cobranca a
where	a.nr_sequencia = nr_seq_orgao_cobr_p;

if (ie_controla_estab_w = 'S') then
	
	select 	coalesce(max(nr_seq_remessa),0) + 1
	into STRICT	nr_seq_remessa_estab_w
	from   	lote_orgao_cobranca
	where 	nr_seq_orgao_cobr = nr_seq_orgao_cobr_p
	and 	cd_estabelecimento = cd_estabelecimento_p;
	
	cd_estab_w := lpad(cd_estabelecimento_p,4,'0');
else
	cd_estab_w := rpad(' ',4,' ');
end if;

select	max(a.cd_cgc),
	max(b.nr_ddd_telefone),
	max(somente_numero(b.nr_telefone)),
	max(b.nr_ramal_contato),
	max(c.nm_pessoa_contato)
into STRICT	cd_cgc_w,
	nr_ddd_telefone_w,
	nr_telefone_w,
	nr_ramal_contato_w,
	nm_pessoa_contato_w
from	estabelecimento a,
	pessoa_juridica b,
	pessoa_juridica_estab c
where	a.cd_cgc = b.cd_cgc
and   	b.cd_cgc = c.cd_cgc
and 	a.cd_estabelecimento = cd_estabelecimento_p;

/*Codigo da Operacao: I - inclusao  - E - exclusao*/

select	coalesce(max(ie_tipo_lote),'I')
into STRICT	ie_tipo_lote_w
from	lote_orgao_cobranca
where	nr_sequencia = nr_seq_lote_p;

nr_seq_linha_w := nr_seq_linha_w + 1;

ds_conteudo_w	:= 	'0' || /* Pos 01*/
			lpad(coalesce(obter_cnpj_raiz(cd_cgc_w),'0'),9,'0') || --CNPN Raiz: OS 1297003, historico em 28/12/2016 16:39:22 POS 02 a 10
			lpad(coalesce(to_char(clock_timestamp(),'YYYYMMDD'),'0'),8,'0') || /*Pos 11 a 18*/
			lpad(coalesce(nr_ddd_telefone_w,'0'),4,'0') || /*Pos 19 a 22*/
			lpad(coalesce(nr_telefone_w,'0'),8,'0') || /*Pos 23 a 30*/
			lpad(coalesce(nr_ramal_contato_w,'0'),4,'0') || /*Pos 31 a 34*/
			rpad(coalesce(nm_pessoa_contato_w,' '),70,' ') || /*Pos 35 a  69*/
			'SERASA-CONVEM04' ||
			lpad(coalesce(nr_seq_remessa_estab_w,nr_seq_remessa_w),6,'0') ||
			'E' /*ie_tipo_lote_w*/
 || /*Codigo de envio de arquivo: E - Entrada - R - Retorno. O Tasy so vai ser E, pq o retorno sera gerado pelo Serasa.*/
			cd_estab_w || -- Ja e formatado acima
			rpad(' ',3,' ') ||
			rpad(' ',8,' ') ||
			rpad(' ',392,' ') ||
			rpad(' ',60,' ') ||
			lpad(nr_seq_linha_w,7,'0');
			

insert	into	w_envio_orgao_cobranca(nr_sequencia,
		nr_seq_lote,
		ds_conteudo,        
		dt_atualizacao,
		nm_usuario,
		nr_seq_apres)
	values (nextval('w_envio_orgao_cobranca_seq'),
		nr_seq_lote_p,
		ds_conteudo_w,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_linha_w);	


open c01;
loop
fetch c01 into	
	vet01;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	nr_seq_linha_w := nr_seq_linha_w + 1;
	
	ds_conteudo_w	:= 	'1' ||
				ie_tipo_lote_w || --Codigo da operacao: I inclusao  E exclusao
				lpad(coalesce(substr(cd_cgc_w,9,14),'0'),6,'0') || --Filial e digito do CNPJ da contratante
				lpad(coalesce(to_char(vet01.dt_vencimento,'YYYYMMDD'),'0'),8,'0') || --Data da ocorrencia
				lpad(coalesce(to_char(vet01.dt_vencimento,'YYYYMMDD'),'0'),8,'0') || --Data do termino do contrato
				rpad('DP',3,' ') || --Codigo de natureza da operacao
				lpad('0',4,'0') || --Codigo da praca Embratel
				rpad(coalesce(vet01.ie_tipo_pessoa,' '),1,' ') ||--Tipo de pessoa
				rpad(coalesce(vet01.ie_cgc_cpf,' '),1,' ') || -- Tipo do primeiro docto
				lpad(coalesce(vet01.nr_identidade,'0'),15,'0') || --Primeiro documento do principal
				rpad(' ',2,' ') || --Motivo da baixa
				' ' || --Tipo do segundo documento do principal
				rpad(coalesce(vet01.nr_identidade,' '),15,' ') || --Segundo documento do principal
				rpad(coalesce(vet01.ds_uf,' '),2,' ') || -- UF quando documento for RG,
				rpad(' ',37,' ') || -- campos referente ao coobrigado
				rpad(coalesce(vet01.nm_nome,' '),70,' ') || --Nome do devedor
				lpad(coalesce(to_char(vet01.dt_nascimento,'YYYYMMDD'),'0'),8,'0') || --A data do nascimento
				rpad(coalesce(vet01.nm_pai,' '),70,' ') || --nome pai
				rpad(coalesce(vet01.nm_mae,' '),70,' ') || --nome mae
				rpad(coalesce(vet01.ds_end_completo,' '),45,' ') || --Endereco completo
				rpad(coalesce(vet01.ds_bairro,' '),20,' ') || --bairro 
				rpad(coalesce(vet01.ds_municipio,' '),25,' ') || --Municipio correspondente                                                                   
				rpad(coalesce(vet01.ds_uf,' '),2,' ') || --Sigla Unidade Federativa                                                                     
				lpad(coalesce(vet01.ds_cep,'0'),8,'0') || --Codigo de enderecamento postal completo
				lpad(coalesce(vet01.vl_documento,'0'),15,'0') || --Valor com 2 decimais
				lpad(coalesce(vet01.nr_seq_cheque,'0'),16,'0') || --O numero do contrato
				lpad(coalesce(vet01.nr_nosso_numero,'0'),9,'0') || --Nosso numero
				rpad(coalesce(vet01.ds_complemento,' '),25,' ') || --Complemento do endereco do devedor 
				lpad(coalesce(vet01.nr_ddd_telefone,'0'),4,'0') || --DDD do telefone do devedor.
				lpad(coalesce(vet01.nr_telefone,'0'),9,'0') || --Numero do telefone do devedor
				lpad(coalesce(to_char(vet01.dt_vencimento,'YYYYMMDD'),'0'),8,'0') || ----Data do compromisso assumido pelo devedor
				lpad(coalesce(vet01.vl_documento,'0'),15,'0') || --Valor total do compromisso assumido pelo devedor
				rpad(' ',6,' ') ||
				' ' ||
				rpad(' ',2,' ') ||
				rpad(' ',60,' ') ||
				lpad(nr_seq_linha_w,7,'0');
				
				
	insert	into	w_envio_orgao_cobranca(nr_sequencia,
		nr_seq_lote,
		ds_conteudo,        
		dt_atualizacao,
		nm_usuario,
		nr_seq_apres)
	values (nextval('w_envio_orgao_cobranca_seq'),
		nr_seq_lote_p,
		ds_conteudo_w,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_linha_w);	
	end;
end loop;
close c01;

nr_seq_linha_w := nr_seq_linha_w + 1;

ds_conteudo_w	:=	'9' ||
			lpad(' ',592,' ') ||
			lpad(nr_seq_linha_w,7,'0');

insert	into	w_envio_orgao_cobranca(nr_sequencia,
		nr_seq_lote,
		ds_conteudo,        
		dt_atualizacao,
		nm_usuario,
		nr_seq_apres)
	values (nextval('w_envio_orgao_cobranca_seq'),
		nr_seq_lote_p,
		ds_conteudo_w,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_linha_w);


update	lote_orgao_cobranca
set	nr_seq_remessa = coalesce(nr_seq_remessa_estab_w,nr_seq_remessa_w)
where	nr_sequencia = nr_seq_lote_p;
		
update	orgao_cobranca
set	nr_seq_remessa = nr_seq_remessa_w
where	nr_sequencia = nr_seq_orgao_cobr_p;    		
		
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_envio_serasa_600 ( nr_seq_lote_p bigint, nm_usuario_p text, nr_seq_orgao_cobr_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

