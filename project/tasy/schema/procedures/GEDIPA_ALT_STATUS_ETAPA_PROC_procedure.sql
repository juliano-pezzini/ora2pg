-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gedipa_alt_status_etapa_proc ( nr_seq_etapa_p bigint, nr_seq_item_p bigint, dt_horario_p timestamp, status_p text, nr_seq_processo_p bigint, cd_material_p text) AS $body$
DECLARE


nr_seq_etapa_gedipa_w	bigint := 0;
ie_status_anterior_w	varchar(1);
nr_seq_estagio_w 		bigint;
nr_horas_estab_w 		double precision;
dt_estabilidade_w		timestamp;
cd_material_w 			bigint;
nr_sequencia_etapa_w	gedipa_etapa_hor.nr_sequencia%type;
qt_dose_util_w          w_gedipa_preparo.qt_dose_util%type;

c01 CURSOR FOR
	SELECT	a.nr_sequencia,
			a.ie_status_preparo,
			a.cd_material,
			a.dt_estabilidade
	from 	gedipa_etapa_hor a
	where 	nr_seq_etapa_gedipa = nr_seq_etapa_p
	and 	dt_horario = dt_horario_p
	and 	cd_material in (
				SELECT	x.cd_material
				from	prescr_material x,
						prescr_mat_hor y,
						prescr_procedimento z
				where  	x.nr_prescricao = y.nr_prescricao
				and	   	x.nr_prescricao = z.nr_prescricao
				and	   	y.nr_prescricao = z.nr_prescricao
				and 	x.cd_material = y.cd_material
				and	  	x.nr_sequencia_proc = z.nr_sequencia
				and	  	y.dt_horario = dt_horario_p
				and	 	x.nr_sequencia_proc = nr_seq_item_p
				and 	y.nr_sequencia = a.nr_seq_horario
			);


BEGIN

open c01;
loop
fetch c01 into
	nr_sequencia_etapa_w,
	ie_status_anterior_w,
	cd_material_w,
	dt_estabilidade_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

        select  max(a.qt_dose_util)
        into STRICT    qt_dose_util_w
        from    w_gedipa_preparo a
        where   a.nm_usuario = wheb_usuario_pck.get_nm_usuario
        and     a.cd_material = cd_material_w;

        if (qt_dose_util_w > 0) then
            if (status_p = 'R') and (ie_status_anterior_w <> status_p) then -- caso tenha passado para preparado, seta dt_estabilidade
                begin
                nr_seq_estagio_w := Obter_Param_Usuario(3112, 68, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, nr_seq_estagio_w);

                if (nr_seq_estagio_w IS NOT NULL AND nr_seq_estagio_w::text <> '') and (nr_seq_estagio_w > 0) then
                    begin

                    select	max(converte_estab_hor(ie_tempo_estab, qt_estabilidade))
                    into STRICT	nr_horas_estab_w
                    from	material_armazenamento
                    where	nr_seq_estagio = nr_seq_estagio_w
                    and		cd_material	= cd_material_w;

                    dt_estabilidade_w := clock_timestamp() + (nr_horas_estab_w/24);

                    end;
                end if;
                end;
            end if;

            update 	gedipa_etapa_hor
            set 	ie_status_preparo = status_p,
                    dt_estabilidade = dt_estabilidade_w,
                    nm_usuario_preparo = wheb_usuario_pck.get_nm_usuario
            where 	nr_sequencia = nr_sequencia_etapa_w;

            CALL gedipa_atualizar_status_etapa(nr_seq_etapa_p, wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario);
        end if;
	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gedipa_alt_status_etapa_proc ( nr_seq_etapa_p bigint, nr_seq_item_p bigint, dt_horario_p timestamp, status_p text, nr_seq_processo_p bigint, cd_material_p text) FROM PUBLIC;

