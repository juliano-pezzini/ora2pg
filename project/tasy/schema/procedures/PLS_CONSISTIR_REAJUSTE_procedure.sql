-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consistir_reajuste ( nr_seq_reajuste_p bigint, ie_tipo_consistencia_p text) AS $body$
DECLARE


/*ie_tipo_consistencia_p
	'RP' = Realizado através da função OPS - Reajuste de preço dos beneficiários
	'GC' = Realizado através da função OPS - Gestão de contratos
	'RI' = Reajuste individual
*/
vl_cotacao_w			cotacao_moeda.vl_cotacao%type;
ie_indice_reajuste_contrato_w	bigint;
dt_reajuste_w			timestamp;
nr_seq_contrato_w		bigint;
nr_contrato_w			bigint;


BEGIN

begin
select	ie_indice_reajuste_contrato,
	dt_reajuste
into STRICT	ie_indice_reajuste_contrato_w,
	dt_reajuste_w
from	pls_reajuste
where	nr_sequencia	= nr_seq_reajuste_p;
exception
when others then
	ie_indice_reajuste_contrato_w	:= null;
	dt_reajuste_w			:= null;
end;

if (coalesce(ie_indice_reajuste_contrato_w,0) <> 0) then
	begin
	select	max(vl_cotacao)
	into STRICT	vl_cotacao_w
	from	moeda		a,
		cotacao_moeda	b
	where	a.cd_moeda	= ie_indice_reajuste_contrato_w
	and	a.cd_moeda	= b.cd_moeda
	and	trunc(b.dt_cotacao, 'month')	= trunc(dt_reajuste_w, 'month');
	exception
	when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(213712);
	end;

	if (coalesce(vl_cotacao_w,0) <> 0) then
		update	pls_reajuste
		set	tx_reajuste	= vl_cotacao_w
		where	nr_sequencia	= nr_seq_reajuste_p;
	end if;
end if;


/*aaschlote OS - 278055 28/12/2010 - Incluir a sequencia do contrato logo depois de salvar*/

if (ie_tipo_consistencia_p	= 'RP') then
	begin
	select	max(nr_contrato)
	into STRICT	nr_contrato_w
	from	pls_reajuste
	where	nr_sequencia	= nr_seq_reajuste_p;
	exception
	when others then
		nr_contrato_w	:= null;
	end;


	begin
	select	max(nr_sequencia)
	into STRICT	nr_seq_contrato_w
	from	pls_contrato
	where	nr_contrato	= nr_contrato_w;
	exception
	when others then
		nr_seq_contrato_w	:= null;
	end;

	update	pls_reajuste
	set	nr_seq_contrato	= nr_seq_contrato_w
	where	nr_sequencia	= nr_seq_reajuste_p;

elsif (ie_tipo_consistencia_p = 'GC') then
	begin
	select	max(nr_seq_contrato)
	into STRICT	nr_seq_contrato_w
	from	pls_reajuste
	where	nr_sequencia	= nr_seq_reajuste_p;
	exception
	when others then
		nr_seq_contrato_w	:= 0;
	end;

	if (coalesce(nr_seq_contrato_w,0) <> 0) then
		select	max(nr_contrato)
		into STRICT	nr_contrato_w
		from	pls_contrato
		where	nr_sequencia	= nr_seq_contrato_w;

		if (coalesce(nr_contrato_w,0) <> 0) then
			update	pls_reajuste
			set	nr_contrato	= nr_contrato_w
			where	nr_sequencia	= nr_seq_reajuste_p;
		end if;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consistir_reajuste ( nr_seq_reajuste_p bigint, ie_tipo_consistencia_p text) FROM PUBLIC;

