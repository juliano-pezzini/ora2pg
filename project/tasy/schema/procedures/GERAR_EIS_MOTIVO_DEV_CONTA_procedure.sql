-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_eis_motivo_dev_conta ( cd_estabelecimento_p bigint, dt_mes_referencia_p timestamp, nm_usuario_p text) AS $body$
DECLARE

 
dt_inicial_w			timestamp;
dt_final_w			timestamp;
cd_setor_atendimento_w		bigint;
nr_interno_conta_w			bigint;
dt_etapa_w			timestamp;
nr_atendimento_w			bigint;
nr_seq_etapa_w			bigint;
nr_seq_motivo_dev_w		bigint;
ds_observacao_w			varchar(2000);
cd_pessoa_fisica_w		varchar(10);
nr_sequencia_w			bigint;
nr_seq_w				bigint;
nr_seq_adic_w			bigint;
ds_obs_adic_w			varchar(255);
		
c01 CURSOR FOR 
	SELECT 	to_char(a.dt_etapa,'dd/mm/yyyy') dt_etapa, 
		b.nr_atendimento, 
		a.nr_interno_conta, 
		a.nr_seq_etapa, 
		a.cd_setor_atendimento, 
		a.nr_seq_motivo_dev, 
		a.ds_observacao, 
		a.cd_pessoa_fisica, 
		a.nr_sequencia 
	from 	conta_paciente_etapa a, 
		conta_paciente b 
	where 	a.nr_interno_conta 	= b.nr_interno_conta 
	and	b.cd_estabelecimento 	= cd_estabelecimento_p 
	and	a.dt_etapa between dt_inicial_w and dt_final_w;
	
c02 CURSOR FOR 
	SELECT	a.nr_seq_motivo, 
		substr(a.ds_observacao,1,255) 
	from 	conta_paciente_etapa_dev a 
	where 	a.nr_seq_etapa = nr_seq_w;

 
		 

BEGIN 
 
dt_inicial_w		:= trunc(dt_mes_referencia_p, 'month');
dt_final_w		:= fim_dia(last_day(dt_mes_referencia_p));
 
delete	from eis_motivo_dev_conta 
where	cd_estabelecimento = cd_estabelecimento_p 
and	dt_referencia = dt_inicial_w;
 
open c01;
loop 
fetch 	c01 into	 
	dt_etapa_w, 
	nr_atendimento_w, 
	nr_interno_conta_w, 
	nr_seq_etapa_w, 
	cd_setor_atendimento_w, 
	nr_seq_motivo_dev_w, 
	ds_observacao_w, 
	cd_pessoa_fisica_w, 
	nr_seq_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	 
	select	nextval('eis_motivo_dev_conta_seq') 
	into STRICT	nr_sequencia_w 
	;
	 
	insert into eis_motivo_dev_conta(nr_sequencia, 
		cd_estabelecimento,  
		dt_referencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		dt_etapa, 
		nr_atendimento, 
		nr_interno_conta, 
		nr_seq_etapa, 
		cd_setor_atendimento, 
		nr_seq_motivo_dev, 
		ds_observacao, 
		cd_pessoa_fisica) 
	values (nr_sequencia_w, 
		cd_estabelecimento_p, 
		dt_inicial_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		dt_etapa_w, 
		nr_atendimento_w, 
		nr_interno_conta_w, 
		nr_seq_etapa_w, 
		cd_setor_atendimento_w, 
		nr_seq_motivo_dev_w, 
		null, 
		cd_pessoa_fisica_w);
	 
	open c02;
	loop 
	fetch c02 into	 
		nr_seq_adic_w, 
		ds_obs_adic_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin 
		 
		select	nextval('eis_motivo_dev_conta_seq') 
		into STRICT	nr_sequencia_w 
		;
		 
		insert into eis_motivo_dev_conta(nr_sequencia, 
			cd_estabelecimento,  
			dt_referencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			dt_etapa, 
			nr_atendimento, 
			nr_interno_conta, 
			nr_seq_etapa, 
			cd_setor_atendimento, 
			nr_seq_motivo_dev, 
			ds_observacao, 
			cd_pessoa_fisica) 
		values (nr_sequencia_w, 
			cd_estabelecimento_p, 
			dt_inicial_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			dt_etapa_w, 
			nr_atendimento_w, 
			nr_interno_conta_w, 
			nr_seq_etapa_w, 
			cd_setor_atendimento_w, 
			nr_seq_adic_w, 
			ds_obs_adic_w, 
			cd_pessoa_fisica_w);
		 
		end;
	end loop;
	close c02;
	 
	 
	end;
end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_eis_motivo_dev_conta ( cd_estabelecimento_p bigint, dt_mes_referencia_p timestamp, nm_usuario_p text) FROM PUBLIC;

