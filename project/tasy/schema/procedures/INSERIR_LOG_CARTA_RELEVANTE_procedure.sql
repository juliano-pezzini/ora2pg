-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_log_carta_relevante ( nr_atendimento_p bigint, ie_opcao_p text, cd_chave_p bigint, ds_texto_padrao_p text, nm_usuario_p text, nr_seq_result_p bigint default 0, nr_seq_result_item_p bigint default 0, ie_incluir_aut_p text default 'N', nr_seq_carta_conteudo_p INOUT bigint DEFAULT NULL, ie_tipo_regra_p text default 'N', ie_incluso_p text DEFAULT NULL) AS $body$
DECLARE



ie_possui_carta_w					varchar(1);
ie_inserir_cont_rel_w				varchar(1);
nr_seq_carta_cont_rel_w				carta_conteudo_relevante.nr_sequencia%type;
nr_seq_episodio_w					atendimento_paciente.nr_seq_episodio%type;
ie_incluir_inf_adic_w				carta_medica_regra_item.ie_incluir_inf_adic%type;
ie_inf_adic_w						varchar(1) := 'N';
ie_uso_case_w 						varchar(1);
/*Constantes carta*/

const_alergias_reac_adv_w			constant varchar(2) := 'AL';
const_anamnese_w					constant varchar(2) := 'AN';
const_cirurgias_w					constant varchar(2) := 'CI';
const_comorbidades_w				constant varchar(2) := 'CO';
const_diagnostico_w 				constant varchar(2) := 'DI';
const_exames_nao_lab_w				constant varchar(3) := 'EI';
const_laboratorio_w					constant varchar(3) := 'EL';
const_epicrise_w                   	constant varchar(2) := 'EP';
const_medicamentos_em_uso_w        	constant varchar(2) := 'ME';
const_plano_medicamentos_w         	constant varchar(2) := 'MP';
const_notas_clinicas_w				constant varchar(2) := 'NC';
const_procedimentos_w				constant varchar(2) := 'PR';
const_medicamentos_KV_w				constant varchar(3) := 'RE';
const_medicamentos_cpoe_w			constant varchar(2) := 'MD';
const_diag_paciente_w				constant varchar(2) := 'DP';

C01 CURSOR FOR
	SELECT	nr_sequencia,
			coalesce(nr_seq_carta_mae,nr_sequencia) nr_seq_carta_mae,
			nr_seq_modelo
	from	carta_medica
	where 	coalesce(ie_log,'N') = 'N'
	and		((ie_uso_case_w = 'N' and nr_atendimento = nr_atendimento_p)
	or (ie_uso_case_w = 'S' and nr_seq_episodio = nr_seq_episodio_w));


BEGIN

nr_seq_episodio_w := obter_episodio_atendimento(nr_atendimento_p);
ie_uso_case_w	  := 'N';
if (nr_seq_episodio_w = 0) then
	nr_seq_episodio_w := null;
	ie_uso_case_w	  := 'S';
end if;

if (ie_opcao_p = const_diagnostico_w) then
	if (nr_seq_result_p IS NOT NULL AND nr_seq_result_p::text <> '') then
		ie_inf_adic_w := 'S';
	else
		ie_inf_adic_w := 'N';
	end if;
end if;

select	coalesce(max('N'),'S')
into STRICT	ie_inserir_cont_rel_w
from	carta_conteudo_relevante
where	(( coalesce( nr_seq_cirurgia,nr_seq_alergia,cd_evolucao,nr_seq_medic_uso,nr_seq_comorbidade,nr_seq_procedimento, nr_seq_proc_pac,nr_seq_laudo,nr_seq_kv_item,nr_seq_mat_cpoe,nr_seq_rec_cpoe,NR_SEQ_PLANO_VERSAO_MEDIC ) = cd_chave_p
and ( ie_opcao_p <> const_laboratorio_w and ie_opcao_p <> const_diagnostico_w and ie_opcao_p <> const_diag_paciente_w))
		or ( ie_opcao_p = const_diagnostico_w
and 	(( ie_inf_adic_w = 'N' and nr_seq_diag_doenca = cd_chave_p) or ( ie_inf_adic_w = 'S' and nr_seq_diag_doenca = cd_chave_p and NR_SEQ_DIAG_DOENCA_INF = nr_seq_result_p )))
		or (ie_opcao_p = const_diag_paciente_w
and   	ie_tipo_item = const_diag_paciente_w and nr_seq_diag_doenca = cd_chave_p)
		or ( ie_opcao_p = const_laboratorio_w and nr_prescricao = nr_seq_result_p and nr_seq_prescricao = nr_seq_result_item_p ))
and		((ie_uso_case_w = 'N' and nr_atendimento = nr_atendimento_p)
		or (ie_uso_case_w = 'S' and nr_seq_episodio = nr_seq_episodio_w));

if (ie_inserir_cont_rel_w = 'S') then

	select	nextval('carta_conteudo_relevante_seq')
	into STRICT	nr_seq_carta_cont_rel_w
	;

	insert into carta_conteudo_relevante(
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_seq_diag_doenca,
							cd_evolucao,
							nr_seq_medic_uso,
							nr_seq_comorbidade,
							nr_seq_procedimento,
							ds_texto,
							ie_tipo_item,
							ie_incluir_aut,
							nr_prescricao,
							nr_seq_prescricao,
							nr_seq_resultado_exame,
							nr_seq_resultado_exame_item,
							nr_seq_alergia,
							nr_seq_cirurgia,
							nr_seq_proc_pac,
							nr_seq_laudo,
							nr_seq_kv_item,
							NR_SEQ_MAT_CPOE,
							NR_SEQ_REC_CPOE,
							IE_TIPO_EPICRISE,
							IE_INCLUSO_CARTA,
							NR_SEQ_DIAG_DOENCA_INF,
							NR_ATENDIMENTO,
							NR_SEQ_EPISODIO,
							ie_tipo_nota_clinica,
							NR_SEQ_PLANO_VERSAO_MEDIC)
				values(		nr_seq_carta_cont_rel_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							case when(ie_opcao_p = const_diagnostico_w or ie_opcao_p = const_diag_paciente_w)  then  CASE WHEN cd_chave_p=0 THEN null  ELSE cd_chave_p END  else null end,
							case when ((ie_opcao_p = const_epicrise_w and ie_tipo_regra_p = 'C') or ie_opcao_p = const_anamnese_w or ie_opcao_p = const_notas_clinicas_w)  then  CASE WHEN cd_chave_p=0 THEN null  ELSE cd_chave_p END  else null end,
							case when(ie_opcao_p = const_medicamentos_em_uso_w)  then  CASE WHEN cd_chave_p=0 THEN null  ELSE cd_chave_p END  else null end,
							case when ie_opcao_p = const_comorbidades_w  then  CASE WHEN cd_chave_p=0 THEN null  ELSE cd_chave_p END  else null end,
							case when(ie_opcao_p = 'NA' or ie_opcao_p = const_laboratorio_w) then  CASE WHEN cd_chave_p=0 THEN null  ELSE cd_chave_p END  else null end,
							ds_texto_padrao_p,
							ie_opcao_p,
							ie_incluir_aut_p,
							case when ie_opcao_p = const_laboratorio_w  then  CASE WHEN nr_seq_result_p=0 THEN null  ELSE nr_seq_result_p END  else null end,--NR_PRESCRICAO
							case when ie_opcao_p = const_laboratorio_w  then  CASE WHEN nr_seq_result_item_p=0 THEN null  ELSE nr_seq_result_item_p END  else null end,--NR_SEQ_PRESCRICAO
							null,
							null,
							case when ie_opcao_p = const_alergias_reac_adv_w  then  CASE WHEN cd_chave_p=0 THEN null  ELSE cd_chave_p END  else null end,
							case when ie_opcao_p = const_cirurgias_w  then  CASE WHEN cd_chave_p=0 THEN null  ELSE cd_chave_p END  else null end,
							case when(ie_opcao_p = const_procedimentos_w)  then  CASE WHEN cd_chave_p=0 THEN null  ELSE cd_chave_p END  else null end,
							case when(ie_opcao_p = const_exames_nao_lab_w) then  CASE WHEN cd_chave_p=0 THEN null  ELSE cd_chave_p END  else null end,
							case when(ie_opcao_p = const_medicamentos_KV_w) then  CASE WHEN cd_chave_p=0 THEN null  ELSE cd_chave_p END  else null end,
							case when(ie_opcao_p = const_medicamentos_cpoe_w) then  CASE WHEN cd_chave_p=0 THEN null  ELSE cd_chave_p END  else null end,
							case when(ie_opcao_p = const_epicrise_w and ie_tipo_regra_p = 'R') then  CASE WHEN cd_chave_p=0 THEN null  ELSE cd_chave_p END  else null end,
							case when(ie_opcao_p = const_epicrise_w) then  ie_tipo_regra_p else null end,
							ie_incluso_p,
							case when ie_opcao_p = const_diagnostico_w  then  CASE WHEN nr_seq_result_p=0 THEN null  ELSE nr_seq_result_p END  else null end,
							nr_atendimento_p,
							(SELECT max(NR_SEQ_EPISODIO) from atendimento_paciente where nr_atendimento = nr_atendimento_p),
							ie_tipo_regra_p,
							case when(ie_opcao_p = const_plano_medicamentos_w)  then  CASE WHEN cd_chave_p=0 THEN null  ELSE cd_chave_p END  else null end);

	commit;


	select	coalesce(max('S'),'N')
	into STRICT	ie_possui_carta_w
	from	carta_medica a
	where 	coalesce(ie_log,'N') = 'N'
	and		((ie_uso_case_w = 'N' and nr_atendimento = nr_atendimento_p)
		or (ie_uso_case_w = 'S' and nr_seq_episodio = nr_seq_episodio_w));

	if ( ie_possui_carta_w = 'S') then
		for c01_w in C01 loop
			begin
			ie_incluir_inf_adic_w := 'N';
			if (ie_opcao_p = const_diagnostico_w) then
				select	coalesce(max('S'),'N')
				into STRICT	ie_incluir_inf_adic_w
				from	carta_medica_regra a,
						carta_medica_regra_item b,
						carta_medica_modelo c
				where	a.nr_sequencia 	= b.nr_seq_regra
				and		a.nr_seq_modelo = c.nr_sequencia
				and   	c.nr_sequencia  = c01_w.nr_seq_modelo
				and		coalesce(ie_incluir_inf_adic,'N') = 'S'
				and		exists (SELECT	1
								 from	diagnostico_doenca x
								 where	nr_seq_interno = cd_chave_p
								 and (coalesce(b.ie_classificacao_doenca::text, '') = '' or coalesce(b.ie_classificacao_doenca, x.ie_classificacao_doenca) = x.ie_classificacao_doenca)
								 and (coalesce(b.ie_tipo_diagnostico::text, '') = '' or coalesce(b.ie_tipo_diagnostico, x.ie_tipo_diagnostico) 		= x.ie_tipo_diagnostico));
				if ((ie_incluir_inf_adic_w = 'N' and coalesce(nr_seq_result_p::text, '') = '') or (ie_incluir_inf_adic_w = 'S')) then
					nr_seq_carta_conteudo_p := inserir_log_carta(	c01_w.nr_sequencia, ie_opcao_p, cd_chave_p, ds_texto_padrao_p, nm_usuario_p, nr_seq_result_p, nr_seq_result_item_p, ie_incluir_aut_p, nr_seq_carta_conteudo_p, ie_tipo_regra_p, ie_incluso_p, c01_w.nr_seq_carta_mae, nr_seq_carta_cont_rel_w );
				end if;
			else
				nr_seq_carta_conteudo_p := inserir_log_carta(	c01_w.nr_sequencia, ie_opcao_p, cd_chave_p, ds_texto_padrao_p, nm_usuario_p, nr_seq_result_p, --Aqui
									nr_seq_result_item_p, ie_incluir_aut_p, nr_seq_carta_conteudo_p, ie_tipo_regra_p, ie_incluso_p, c01_w.nr_seq_carta_mae, nr_seq_carta_cont_rel_w );
			end if;
			end;
		end loop;


	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_log_carta_relevante ( nr_atendimento_p bigint, ie_opcao_p text, cd_chave_p bigint, ds_texto_padrao_p text, nm_usuario_p text, nr_seq_result_p bigint default 0, nr_seq_result_item_p bigint default 0, ie_incluir_aut_p text default 'N', nr_seq_carta_conteudo_p INOUT bigint DEFAULT NULL, ie_tipo_regra_p text default 'N', ie_incluso_p text DEFAULT NULL) FROM PUBLIC;

