-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE bl_inicio_fim_preparo ( nr_seq_item_p bigint, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE


nr_prescricao_w		bigint;
nr_seq_prod_lac_w	bigint;
dt_horario_w		timestamp;
nr_seq_item_alterar_w	bigint;
qt_dose_w		double precision;
qt_atendida_w		bigint;
					
C01 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.qt_dose - qt_atendida_w
	from	nut_prod_lac_item a
	where	a.nr_prescricao	= nr_prescricao_w
	and	a.nr_sequencia = nr_seq_prod_lac_w
	and	a.dt_horario	= dt_horario_w
	and not exists (SELECT	1
			from	nutricao_leite_deriv b,
				classif_leite_deriv c
			where	b.cd_material = a.cd_material
			and	b.nr_seq_classif = c.nr_sequencia
			and coalesce(b.ie_situacao,'A') = 'A'
			and	coalesce(c.ie_leite_materno,'N') = 'S')
	order by 1;
					

BEGIN
if (nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '') then

	if (ie_opcao_p = 'I') then
	
		update	nut_prod_lac_item
		set	dt_inicio_preparo 	= clock_timestamp(),
			nm_usuario_ini_preparo	= nm_usuario_p
		where	nr_sequencia = nr_seq_item_p;
		
	elsif (ie_opcao_p = 'F') then
	
		update	nut_prod_lac_item
		set	dt_fim_preparo 		= clock_timestamp(),
			nm_usuario_fim_preparo	= nm_usuario_p
		where	nr_sequencia 		= nr_seq_item_p;
	
		select	nr_prescricao,
			nr_sequencia,
			dt_horario,
			BL_obter_quant_atendida(nr_sequencia)
		into STRICT	nr_prescricao_w,
			nr_seq_prod_lac_w,
			dt_horario_w,
			qt_atendida_w
		from	nut_prod_lac_item
		where	nr_sequencia = nr_seq_item_p;
	
		open C01;
		loop
		fetch C01 into	
			nr_seq_item_alterar_w,
			qt_dose_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			
			if (qt_dose_w < 0) then
				qt_dose_w := 0;
			end if;
			
			CALL nut_alterar_quant_producao(nr_seq_item_alterar_w, qt_dose_w, nm_usuario_p);
			
			end;
		end loop;
		close C01;
		
		update	bl_frasco
		set	ie_situacao_processa = 'N',
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p
		where nr_seq_prod_item = nr_seq_item_p;
		
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE bl_inicio_fim_preparo ( nr_seq_item_p bigint, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

