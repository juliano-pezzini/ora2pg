-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_imp_a1200_70 (ds_conteudo_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


ds_retorno_w			varchar(4000);
nr_seq_pacote_reg_w		bigint;
--201
cd_unimed_origem_pacote_w	varchar(10);
dt_geracao_pacote_w		timestamp;
ie_tipo_carga_pacote_w		varchar(1);
ie_tipo_informacao_pacote_w	varchar(1);
nr_versao_transacao_pacote_w	varchar(2);

--202
nr_sequencia_w			bigint;
cd_pacote_reg_w			varchar(8);
nm_pacote_reg_w			varchar(60);
cd_unimed_prestador_reg_w	varchar(4);
cd_prestador_reg_w		varchar(8);
nm_prestador_reg_w		varchar(40);
dt_negociacao_reg_w		timestamp;
dt_publicacao_reg_w		timestamp;
ie_tipo_acomodacao_reg_w	varchar(2);
ie_tipo_pacote_reg_w		varchar(2);
cd_especialidade_reg_w		varchar(2);
dt_inicio_vigencia_w		ptu_pacote_reg.dt_inicio_vigencia%type;
dt_fim_vigencia_w		ptu_pacote_reg.dt_fim_vigencia%type;
ie_tipo_internacao_w		ptu_pacote_reg.ie_tipo_internacao%type;
vl_tot_taxas_w			ptu_pacote_reg.vl_tot_taxas%type;
vl_tot_diarias_w 		ptu_pacote_reg.vl_tot_diarias%type;
vl_tot_gases_w			ptu_pacote_reg.vl_tot_gases%type;
vl_tot_mat_w			ptu_pacote_reg.vl_tot_mat%type;
vl_tot_med_w			ptu_pacote_reg.vl_tot_med%type;
vl_tot_proc_w			ptu_pacote_reg.vl_tot_proc%type;

--'203'
ds_obs_reg_w			varchar(255);
nr_seq_pacote_w			integer;

--204
ie_tipo_item_serv_w		smallint;
ie_tipo_tabela_serv_w		smallint;
cd_servico_serv_w		integer;
ie_principal_serv_w		smallint;
ie_honorario_serv_w		varchar(1);
ie_tipo_participacao_serv_w	varchar(1);
qt_servico_serv_w		numeric(25);
vl_servico_serv_w		bigint;



BEGIN
ds_retorno_w	:= trim(both substr(ds_conteudo_p,9,3));

if (ds_retorno_w = '201')	then
	select 	trim(both substr(ds_conteudo_p,12,4)),
		--to_date(substr(ds_conteudo_p,22,2)||substr(ds_conteudo_p,20,2)||substr(ds_conteudo_p,16,4),'dd/mm/yyyy'),
		trim(both substr(ds_conteudo_p,24,1)),
		trim(both substr(ds_conteudo_p,25,1)),
		trim(both substr(ds_conteudo_p,26,2))
	into STRICT	cd_unimed_origem_pacote_w,
		--dt_geracao_pacote_w,
		ie_tipo_carga_pacote_w,
		ie_tipo_informacao_pacote_w,
		nr_versao_transacao_pacote_w
	;

	Insert into ptu_pacote(nr_sequencia, cd_unimed_origem, dt_geracao,
		ie_tipo_carga, ie_tipo_informacao , nr_versao_transacao,
		cd_estabelecimento, dt_atualizacao, nm_usuario)
	values (nextval('ptu_pacote_seq'), cd_unimed_origem_pacote_w, clock_timestamp(),
		ie_tipo_carga_pacote_w, ie_tipo_informacao_pacote_w,nr_versao_transacao_pacote_w,
		cd_estabelecimento_p, clock_timestamp(), nm_usuario_p);

elsif (ds_retorno_w = '202') 	then
	select	trim(both substr(ds_conteudo_p,12,8)),
		trim(both substr(ds_conteudo_p,20,60)),
		trim(both substr(ds_conteudo_p,80,4)),
		trim(both substr(ds_conteudo_p,84,8)),
		trim(both substr(ds_conteudo_p,92,40)),
		--to_date(substr(ds_conteudo_p,138,2)||substr(ds_conteudo_p,136,2)||substr(ds_conteudo_p,132,4),'dd/mm/yyyy'),
		--to_date(substr(ds_conteudo_p,146,2)||substr(ds_conteudo_p,144,2)||substr(ds_conteudo_p,140,4),'dd/mm/yyyy'),
		trim(both substr(ds_conteudo_p,148,2)),
		trim(both substr(ds_conteudo_p,150,2)),
		trim(both substr(ds_conteudo_p,152,2)),
		trim(both substr(ds_conteudo_p,170,1)),
		pls_format_valor_imp_ptu(substr(ds_conteudo_p,171,14)),
		pls_format_valor_imp_ptu(substr(ds_conteudo_p,185,14)),
		pls_format_valor_imp_ptu(substr(ds_conteudo_p,199,14)),
		pls_format_valor_imp_ptu(substr(ds_conteudo_p,213,14)),
		pls_format_valor_imp_ptu(substr(ds_conteudo_p,227,14)),
		pls_format_valor_imp_ptu(substr(ds_conteudo_p,241,14))
	into STRICT	cd_pacote_reg_w,
		nm_pacote_reg_w,
		cd_unimed_prestador_reg_w,
		cd_prestador_reg_w,
		nm_prestador_reg_w,
		--dt_negociacao_reg_w,
		--dt_publicacao_reg_w,
		ie_tipo_acomodacao_reg_w,
		ie_tipo_pacote_reg_w,
		cd_especialidade_reg_w,
		ie_tipo_internacao_w,
		vl_tot_taxas_w,
		vl_tot_diarias_w,
		vl_tot_gases_w,
		vl_tot_mat_w,
		vl_tot_med_w,
		vl_tot_proc_w
	;

	begin
	dt_inicio_vigencia_w	:= to_date(substr(ds_conteudo_p,160,2) || substr(ds_conteudo_p,158,2) || substr(ds_conteudo_p,154,4), 'dd/mm/yyyy');
	exception
	when others then
		dt_inicio_vigencia_w	:= null;
	end;

	begin
	dt_fim_vigencia_w	:= to_date(substr(ds_conteudo_p,168,2) || substr(ds_conteudo_p,166,2) || substr(ds_conteudo_p,162,4), 'dd/mm/yyyy');
	exception
	when others then
		dt_fim_vigencia_w	:= null;
	end;

	select 	max(nr_sequencia)
	into STRICT 	nr_seq_pacote_w
	from 	ptu_pacote
	where 	nm_usuario = nm_usuario_p;

	insert into ptu_pacote_reg(nr_sequencia, cd_pacote, nm_pacote,
		cd_unimed_prestador, cd_prestador, nm_prestador,
		dt_negociacao, dt_publicacao, ie_tipo_acomodacao,
		ie_tipo_pacote, cd_especialidade, ds_observacao,
		dt_atualizacao, nm_usuario, nr_seq_pacote,
		ie_tipo_informacao, dt_inicio_vigencia, dt_fim_vigencia,
		ie_tipo_internacao, vl_tot_taxas, vl_tot_diarias,
		vl_tot_gases, vl_tot_mat, vl_tot_med,
		vl_tot_proc)
	values (nextval('ptu_pacote_reg_seq'),cd_pacote_reg_w, nm_pacote_reg_w,
		cd_unimed_prestador_reg_w, cd_prestador_reg_w, nm_prestador_reg_w,
		clock_timestamp(), clock_timestamp(), ie_tipo_acomodacao_reg_w,
		ie_tipo_pacote_reg_w, cd_especialidade_reg_w, ds_obs_reg_w,
		clock_timestamp(), nm_usuario_p,nr_seq_pacote_w,
		1, dt_inicio_vigencia_w, dt_fim_vigencia_w,
		ie_tipo_internacao_w, vl_tot_taxas_w, vl_tot_diarias_w,
		vl_tot_gases_w, vl_tot_mat_w, vl_tot_med_w,
		vl_tot_proc_w);

elsif (ds_retorno_w = '203')	then
	select 	trim(both substr(ds_conteudo_p,12,8)),
		trim(both substr(ds_conteudo_p,21,255))
	into STRICT	cd_pacote_reg_w,
		ds_obs_reg_w
	;

	select 	max(nr_sequencia)
	into STRICT 	nr_seq_pacote_w
	from 	ptu_pacote
	where 	nm_usuario = nm_usuario_p;

	select 	max(nr_sequencia)
	into STRICT 	nr_sequencia_w
	from 	ptu_pacote
	where	nm_usuario = nm_usuario_p;

	update	ptu_pacote_reg
	set 	cd_pacote	= cd_pacote_reg_w,
		ds_observacao	= ds_obs_reg_w,
		nr_seq_pacote	= nr_seq_pacote_w
	where 	nr_sequencia 	= nr_sequencia_w;

elsif (ds_retorno_w = '204')	then

	select 	max(nr_sequencia)
	into STRICT 	nr_seq_pacote_reg_w
	from 	ptu_pacote_reg
	where 	nm_usuario = nm_usuario_p;

	select	coalesce(trim(both CASE WHEN (substr(ds_conteudo_p,12,1))::numeric =0 THEN ''  ELSE (substr(ds_conteudo_p,12,1))::numeric  END ),0),
		coalesce(trim(both CASE WHEN (substr(ds_conteudo_p,13,1))::numeric =0 THEN ''  ELSE (substr(ds_conteudo_p,13,1))::numeric  END ),0),
		coalesce(trim(both CASE WHEN (substr(ds_conteudo_p,14,8))::numeric =0 THEN ''  ELSE (substr(ds_conteudo_p,14,8))::numeric  END ),0),
		trim(both CASE WHEN (substr(ds_conteudo_p,22,1))::numeric =0 THEN ''  ELSE (substr(ds_conteudo_p,22,1))::numeric  END ),
		trim(both substr(ds_conteudo_p,23,1)),
		trim(both substr(ds_conteudo_p,24,1)),
		coalesce(trim(both CASE WHEN (substr(ds_conteudo_p,25,8))::numeric =0 THEN ''  ELSE (substr(ds_conteudo_p,25,8))::numeric  END ),0),
		--jjung OS 524834 - conforme manual do PTU 4.1, o valor de servico não será gravado com vírgula, portanto deve se dividr o registro do arquivo por 100 para que sejam adicionada a vírgula, verificado com Vagner - UL
		(coalesce(trim(both CASE WHEN (substr(ds_conteudo_p,33,12))::numeric =0 THEN ''  ELSE (substr(ds_conteudo_p,33,12))::numeric  END ),0)/100)
	into STRICT	ie_tipo_item_serv_w,
		ie_tipo_tabela_serv_w,
		cd_servico_serv_w,
		ie_principal_serv_w,
		ie_honorario_serv_w,
		ie_tipo_participacao_serv_w,
		qt_servico_serv_w,
		vl_servico_serv_w
	;

	insert 	into ptu_pacote_servico(nr_sequencia,ie_tipo_item, ie_tipo_tabela,
		cd_servico, ie_principal, ie_honorario,
		ie_tipo_participacao,qt_servico, vl_servico,
		dt_atualizacao,nm_usuario,nr_seq_pacote_reg)
	values (nextval('ptu_pacote_servico_seq'),ie_tipo_item_serv_w, ie_tipo_tabela_serv_w,
		cd_servico_serv_w,ie_principal_serv_w, ie_honorario_serv_w,
		ie_tipo_participacao_serv_w,qt_servico_serv_w, vl_servico_serv_w,
		clock_timestamp(),nm_usuario_p, nr_seq_pacote_reg_w);

elsif (ds_retorno_w = '210') then

	select	trim(both substr(ds_conteudo_p,12,4)),
		trim(both substr(ds_conteudo_p,16,8)),
		trim(both substr(ds_conteudo_p,24,40)),
		to_date(substr(ds_conteudo_p,70,2)||substr(ds_conteudo_p,68,2)||substr(ds_conteudo_p,64,4),'dd/mm/yyyy'),
		to_date(substr(ds_conteudo_p,78,2)||substr(ds_conteudo_p,76,2)||substr(ds_conteudo_p,72,4),'dd/mm/yyyy')
	into STRICT	cd_unimed_prestador_reg_w,
		cd_prestador_reg_w,
		nm_prestador_reg_w,
		dt_negociacao_reg_w,
		dt_publicacao_reg_w
	;

	select 	max(nr_sequencia)
	into STRICT 	nr_seq_pacote_w
	from 	ptu_pacote
	where 	nm_usuario = nm_usuario_p;

	insert into ptu_pacote_reg(nr_sequencia, cd_pacote, nm_pacote,
		cd_unimed_prestador, cd_prestador, nm_prestador,
		dt_negociacao, dt_publicacao, ie_tipo_acomodacao,
		ie_tipo_pacote, cd_especialidade, ds_observacao,
		dt_atualizacao, nm_usuario, nr_seq_pacote,
		ie_tipo_informacao, dt_inicio_vigencia, dt_fim_vigencia,
		ie_tipo_internacao, vl_tot_taxas, vl_tot_diarias,
		vl_tot_gases, vl_tot_mat, vl_tot_med,
		vl_tot_proc)
	values (nextval('ptu_pacote_reg_seq'),cd_pacote_reg_w, nm_pacote_reg_w,
		cd_unimed_prestador_reg_w, cd_prestador_reg_w, nm_prestador_reg_w,
		dt_negociacao_reg_w, dt_publicacao_reg_w, null,
		null, null, null,
		clock_timestamp(), nm_usuario_p, nr_seq_pacote_w,
		2, null, null,
		null, 0, 0,
		0, 0, 0,
		0);

elsif (ds_retorno_w = '211')	then

	select	coalesce(trim(both CASE WHEN (substr(ds_conteudo_p,12,1))::numeric =0 THEN ''  ELSE (substr(ds_conteudo_p,12,1))::numeric  END ),0),
		coalesce(trim(both CASE WHEN (substr(ds_conteudo_p,13,1))::numeric =0 THEN ''  ELSE (substr(ds_conteudo_p,13,1))::numeric  END ),0),
		coalesce(trim(both CASE WHEN (substr(ds_conteudo_p,14,8))::numeric =0 THEN ''  ELSE (substr(ds_conteudo_p,14,8))::numeric  END ),0),
		(coalesce(trim(both CASE WHEN (substr(ds_conteudo_p,22,12))::numeric =0 THEN ''  ELSE (substr(ds_conteudo_p,22,12))::numeric  END ),0)/100)
	into STRICT	ie_tipo_item_serv_w,
		ie_tipo_tabela_serv_w,
		cd_servico_serv_w,
		vl_servico_serv_w
	;

	select 	max(nr_sequencia)
	into STRICT 	nr_seq_pacote_reg_w
	from 	ptu_pacote_reg
	where 	nm_usuario = nm_usuario_p;

	insert 	into ptu_pacote_servico(nr_sequencia,ie_tipo_item, ie_tipo_tabela,
		cd_servico, ie_principal, ie_honorario,
		ie_tipo_participacao,qt_servico, vl_servico,
		dt_atualizacao,nm_usuario,nr_seq_pacote_reg)
	values (nextval('ptu_pacote_servico_seq'),ie_tipo_item_serv_w, ie_tipo_tabela_serv_w,
		cd_servico_serv_w,1, null,
		null,0, vl_servico_serv_w,
		clock_timestamp(),nm_usuario_p, nr_seq_pacote_reg_w);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_imp_a1200_70 (ds_conteudo_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

