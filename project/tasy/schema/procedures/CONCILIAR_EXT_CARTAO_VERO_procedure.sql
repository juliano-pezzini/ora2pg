-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE conciliar_ext_cartao_vero ( nr_seq_extrato_arq_p bigint, ds_lista_extrato_movto_fin_p text, ds_lista_extrato_movto_cred_p text, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE


/*	ie_opcao_p

C	Conciliar
D	Desconciliar

*/
nr_seq_parcela_w	bigint;
qt_nao_concil_w		bigint;
vl_parcela_w		double precision;

ds_comprovante_w	varchar(100);
nr_autorizacao_w	varchar(40);
nr_cartao_w		numeric(20);
nr_parcela_w		bigint;
nr_resumo_w		varchar(20);
nr_seq_bandeira_w	bigint;
nr_seq_movto_w		bigint;
nr_seq_parcela_concil_w	bigint;
nr_documento_w		varchar(100);
cd_bandeira_w		varchar(3);
vl_saldo_concil_fin_w	double precision;
nr_seq_grupo_w		bigint;
vl_min_indevido_w	double precision;
vl_max_indevido_w	double precision;

c01 CURSOR FOR
SELECT	b.ds_comprovante,
	b.nr_autorizacao,
	somente_numero(b.nr_cartao),
	b.nr_parcela,
	a.nr_resumo,
	a.nr_seq_bandeira,
	b.nr_seq_parcela,
	b.nr_sequencia,
	b.nr_documento,
	c.cd_bandeira,
	b.vl_saldo_concil_fin
FROM extrato_cartao_cr_movto b, extrato_cartao_cr_res a
LEFT OUTER JOIN bandeira_cartao_cr c ON (a.nr_seq_bandeira = c.nr_sequencia)
WHERE (coalesce(ds_lista_extrato_movto_fin_p::text, '') = '' or ' ' || ds_lista_extrato_movto_fin_p || ' ' like '% ' || b.nr_sequencia || ' %') and coalesce(b.ie_pagto_indevido,'N')	= 'N' and a.nr_sequencia		= b.nr_seq_extrato_res and a.nr_seq_extrato_arq	= nr_seq_extrato_arq_p;


BEGIN

select	max(a.nr_seq_grupo)
into STRICT	nr_seq_grupo_w
from	extrato_cartao_cr a,
	extrato_cartao_cr_arq b
where	b.nr_seq_extrato	= a.nr_sequencia
and	b.nr_sequencia		= nr_seq_extrato_arq_p;

select	max(a.vl_min_indevido),
	max(a.vl_max_indevido)
into STRICT	vl_min_indevido_w,
	vl_max_indevido_w
from	grupo_band_cr_regra a
where	a.nr_seq_grupo	= nr_seq_grupo_w;

open	c01;
loop
fetch	c01 into
	ds_comprovante_w,
	nr_autorizacao_w,
	nr_cartao_w,
	nr_parcela_w,
	nr_resumo_w,
	nr_seq_bandeira_w,
	nr_seq_parcela_concil_w,
	nr_seq_movto_w,
	nr_documento_w,
	cd_bandeira_w,
	vl_saldo_concil_fin_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	if (ie_opcao_p = 'C') and (coalesce(nr_seq_parcela_concil_w::text, '') = '') then

		select	max(b.nr_sequencia)
		into STRICT	nr_seq_parcela_w
		from	bandeira_cartao_cr c,
			movto_cartao_cr_parcela b,
			movto_cartao_cr a
		where	c.cd_bandeira		= coalesce(cd_bandeira_w,c.cd_bandeira)
		and	a.nr_seq_bandeira	= c.nr_sequencia
		and (coalesce(ds_lista_extrato_movto_cred_p::text, '') = '' or ' ' || ds_lista_extrato_movto_cred_p || ' ' like '% ' || b.nr_sequencia || ' %')
		and	not exists (SELECT	1
			from	extrato_cartao_cr_movto x
			where	x.nr_seq_parcela	= b.nr_sequencia)
		and (coalesce(nr_parcela_w,0) = 0 or obter_numero_parcela_cartao(a.nr_sequencia,b.nr_sequencia) = nr_parcela_w)
		and (a.nr_autorizacao = coalesce(nr_resumo_w,a.nr_autorizacao))
		and	a.nr_sequencia		= b.nr_seq_movto
		and	coalesce(a.dt_cancelamento::text, '') = '';

		if (nr_seq_parcela_w IS NOT NULL AND nr_seq_parcela_w::text <> '') then

			select	max(a.vl_parcela)
			into STRICT	vl_parcela_w
			from	movto_cartao_cr_parcela a
			where	a.nr_sequencia	= nr_seq_parcela_w;

			vl_saldo_concil_fin_w	:= coalesce(vl_saldo_concil_fin_w,0) - coalesce(vl_parcela_w,0);

			if (coalesce(vl_saldo_concil_fin_w,0)	>= coalesce(vl_min_indevido_w,0)) or (coalesce(vl_saldo_concil_fin_w,0)	<= coalesce(vl_max_indevido_w,0)) then

				vl_saldo_concil_fin_w	:= 0;

			end if;

			update	extrato_cartao_cr_movto
			set	nr_seq_parcela		= nr_seq_parcela_w,
				vl_saldo_concil_fin	= vl_saldo_concil_fin_w,
				dt_atualizacao		= clock_timestamp(),
				nm_usuario		= nm_usuario_p
			where	nr_sequencia		= nr_seq_movto_w;

		end if;

	elsif (ie_opcao_p = 'D') and (nr_seq_parcela_concil_w IS NOT NULL AND nr_seq_parcela_concil_w::text <> '') then

		select	max(a.vl_parcela)
		into STRICT	vl_parcela_w
		from	movto_cartao_cr_parcela a
		where	a.nr_sequencia	= nr_seq_parcela_concil_w;

		update	extrato_cartao_cr_movto
		set	nr_seq_parcela		 = NULL,
			vl_saldo_concil_fin	= coalesce(vl_saldo_concil_fin,0) + coalesce(vl_parcela_w,0),
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p
		where	nr_sequencia		= nr_seq_movto_w;

	end if;

end	loop;
close	c01;

select	count(*)
into STRICT	qt_nao_concil_w
from	extrato_cartao_cr_movto b,
	extrato_cartao_cr_res a
where	coalesce(b.vl_saldo_concil_fin,0) <> 0
and	a.nr_sequencia		= b.nr_seq_extrato_res
and	a.nr_seq_extrato_arq	= nr_seq_extrato_arq_p;

update	extrato_cartao_cr_arq
set	dt_conciliacao		= CASE WHEN qt_nao_concil_w=0 THEN clock_timestamp()  ELSE null END ,
	dt_atualizacao		= clock_timestamp(),
	nm_usuario		= nm_usuario_p
where	nr_sequencia		= nr_seq_extrato_arq_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE conciliar_ext_cartao_vero ( nr_seq_extrato_arq_p bigint, ds_lista_extrato_movto_fin_p text, ds_lista_extrato_movto_cred_p text, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

