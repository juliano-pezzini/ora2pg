-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_inss_titulo ( nr_titulo_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_pessoa_fisica_w		varchar(10);
dt_emissao_w			timestamp;
nr_sequencia_w			bigint;
vl_titulo_w			double precision;
vl_base_mes_w			double precision;
vl_base_calc_w			double precision;
vl_inss_w			double precision;
cd_tributo_w			bigint;
cd_estabelecimento_w		bigint;
vl_base_teto_w			double precision;
pr_imposto_w			double precision;

C01 CURSOR FOR
SELECT	coalesce(vl_teto_base_calculo,0),
	coalesce(pr_imposto,0)
from	regra_calculo_imposto
where (coalesce(cd_estabelecimento, cd_estabelecimento_w)	= cd_estabelecimento_w)
and	dt_vigencia		<= dt_emissao_w
and	cd_tributo		= cd_tributo_w
and	coalesce(ie_nota_fiscal,'N') = 'S' /* Matheus OS 101021*/
order by dt_vigencia;


BEGIN
select	cd_pessoa_fisica,
	dt_emissao,
	vl_titulo,
	cd_estabelecimento
into STRICT	cd_pessoa_fisica_w,
	dt_emissao_w,
	vl_titulo_w,
	cd_estabelecimento_w
from	titulo_pagar
where	nr_titulo = nr_titulo_p;

select	coalesce(vl_parametro, vl_parametro_padrao)
into STRICT	cd_tributo_w
from	funcao_parametro
where	cd_funcao	= 851
and	nr_sequencia	= 4;

if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
	select coalesce(sum(vl_base_calculo),0)
	into STRICT	vl_base_mes_w
	from	titulo_pagar_imposto
	where	nr_titulo	= nr_titulo_p
	  and	cd_tributo	= cd_tributo_w
	  and	ie_pago_prev	= 'P';
	pr_imposto_w		:= 0;
	open C01;
	loop
	fetch C01 into
		vl_base_teto_w,
		pr_imposto_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		pr_imposto_w	:= pr_imposto_w;
	end loop;
	close C01;
	vl_base_calc_w	:= vl_base_teto_w - vl_base_mes_w;
	if (vl_base_calc_w > vl_titulo_w) then
		vl_base_calc_w	:= vl_titulo_w;
	end if;

	if (pr_imposto_w > 0) and (vl_base_calc_w > 0) then
		vl_inss_w := (vl_base_calc_w * pr_imposto_w / 100);

		delete from titulo_pagar_imposto
		where	nr_titulo	= nr_titulo_p
		  and	ie_pago_prev	= 'V';
		select	nextval('titulo_pagar_imposto_seq')
		into STRICT	nr_sequencia_w
		;
		insert into titulo_pagar_imposto(
			nr_sequencia, nr_titulo, cd_tributo,
			ie_pago_prev, dt_atualizacao, nm_usuario,
			dt_imposto, vl_base_calculo, vl_imposto,
			pr_imposto, vl_nao_retido, ie_vencimento,
			VL_BASE_NAO_RETIDO, VL_TRIB_ADIC, VL_BASE_ADIC,
			dt_atualizacao_nrec,nm_usuario_nrec)
		values (
			nr_sequencia_w, nr_titulo_p, cd_tributo_w,
			'V', clock_timestamp(), nm_usuario_p,
			dt_emissao_w, vl_base_calc_w, trunc(vl_inss_w,2),
			pr_imposto_w, 0, 'V',
			0,0,0,clock_timestamp(),nm_usuario_p);
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_inss_titulo ( nr_titulo_p bigint, nm_usuario_p text) FROM PUBLIC;

