-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_carteira_conv_eup_js ( cd_pessoa_fisica_p text, nr_atendimento_p bigint, cd_usuario_convenio_p text, cd_convenio_p bigint, ie_consistir_dupli_cart_p text, cd_estabelecimento_p bigint, nm_usuario_p text, ds_msg_abort_p INOUT text, ds_msg_alerta_cart_p INOUT text) AS $body$
DECLARE

 
ie_consiste_cart_conv_w	varchar(1);
qt_convenio_w		bigint;
nr_atendimento_w	bigint;
nm_pessoa_fisica_w	varchar(80);
ie_cart_rn_lib_w	varchar(1);					
					 

BEGIN 
 
 
 
if (ie_consistir_dupli_cart_p <> 'N') then 
	 
	select	max(ie_cons_duplic_cod_usu) 
	into STRICT	ie_consiste_cart_conv_w 
	from	convenio_estabelecimento 
    where	cd_convenio = cd_convenio_p 
    and 	cd_estabelecimento = cd_estabelecimento_p;
	 
	if (ie_consiste_cart_conv_w = 'S') then 
	 
		select	count(*) 
		into STRICT	qt_convenio_w 
        from	atend_categoria_convenio a, 
            atendimento_paciente b   
        where	a.nr_atendimento = b.nr_atendimento 
        and  	a.cd_convenio = cd_convenio_p 
        and  	a.cd_usuario_convenio = cd_usuario_convenio_p 
        and  	a.nr_atendimento   <> nr_atendimento_p 
        and  	b.cd_pessoa_fisica  <> cd_pessoa_fisica_p;
	 
		if (coalesce(qt_convenio_w,0) > 0) then 
			 
			select	max(a.nr_atendimento), 
				max(substr(obter_nome_pf(b.cd_pessoa_fisica),1,80)) 
			into STRICT	nr_atendimento_w, 
				nm_pessoa_fisica_w 
            from 	atend_categoria_convenio a, 
                atendimento_paciente b   
            where	a.nr_atendimento = b.nr_atendimento 
            and 	a.cd_convenio = cd_convenio_p 
            and  	a.cd_usuario_convenio = cd_usuario_convenio_p 
            and  	a.nr_atendimento <> nr_atendimento_p 
            and  	b.cd_pessoa_fisica <> cd_pessoa_fisica_p;
			 
			if (ie_consistir_dupli_cart_p = 'S') then 
				ds_msg_abort_p := substr(obter_texto_dic_objeto(296412, wheb_usuario_pck.get_nr_seq_idioma, 'NR_ATEND='||nr_atendimento_w || ';NM_PESSOA='||nm_pessoa_fisica_w),1,255);
			elsif (ie_consistir_dupli_cart_p = 'A') then 
				ds_msg_alerta_cart_p := substr(obter_texto_dic_objeto(296412, wheb_usuario_pck.get_nr_seq_idioma, 'NR_ATEND='||nr_atendimento_w ||';NM_PESSOA='||nm_pessoa_fisica_w),1,255);
			elsif (ie_consistir_dupli_cart_p = 'RN') then 
				ie_cart_rn_lib_w := Obter_nr_carteira_liberado_RN(nr_atendimento_p, cd_usuario_convenio_p, nr_atendimento_w, cd_convenio_p);
				if (ie_cart_rn_lib_w = 'N') then 
					ds_msg_alerta_cart_p := substr(obter_texto_dic_objeto(296412, wheb_usuario_pck.get_nr_seq_idioma, 'NR_ATEND='||nr_atendimento_w || ';NM_PESSOA='||nm_pessoa_fisica_w),1,255);	
				end if;
			else 
				ds_msg_abort_p := substr(obter_texto_dic_objeto(324186, wheb_usuario_pck.get_nr_seq_idioma, 'NR_ATEND='||nr_atendimento_w || ';NM_PESSOA='||nm_pessoa_fisica_w),1,255);
			end if;
		end if;
	end if;
end if;
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_carteira_conv_eup_js ( cd_pessoa_fisica_p text, nr_atendimento_p bigint, cd_usuario_convenio_p text, cd_convenio_p bigint, ie_consistir_dupli_cart_p text, cd_estabelecimento_p bigint, nm_usuario_p text, ds_msg_abort_p INOUT text, ds_msg_alerta_cart_p INOUT text) FROM PUBLIC;

