-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ajusta_hor_padrao_prescr ( nr_prescricao_p bigint, ds_horarios_p text, ds_horarios2_p INOUT text, ds_horarios3_p INOUT text, nr_ocorrencia_p INOUT bigint) AS $body$
DECLARE

dt_inicio_prescricao_w			timestamp;								
qt_caracter_espaco_w			smallint;
ds_caracter_espaco_w			varchar(255);
nr_intervalo_w					bigint;
ds_horarios_w					varchar(2000);
qt_dia_adic_w					bigint := 0;
ds_hora_w						varchar(7);
ds_horarios_fixo_w				varchar(2000);
ie_controle_w					smallint	:= 0;
dt_horario_w					timestamp;
qt_pertence_w					bigint;
dt_validade_prescr_w			timestamp;
k								bigint;
dt_medic_w						timestamp;
dt_Hora_Inicio_w				timestamp;

BEGIN
 
select	max(dt_inicio_prescr), 
		coalesce(max(qt_caracter_espaco),1), 
		max(dt_validade_prescr) 
into STRICT		dt_inicio_prescricao_w, 
		qt_caracter_espaco_w, 
		dt_validade_prescr_w 
from		prescr_medica 
where	nr_prescricao = nr_prescricao_p;
 
if (position(':' in ds_horarios_p) > 0) then 
	dt_Hora_Inicio_w := to_date(to_char(dt_inicio_prescricao_w,'dd/mm/yyyy')||' '||substr(ds_horarios_p,1,5) || ':00','dd/mm/yyyy hh24:mi:ss');
else 
	dt_Hora_Inicio_w := to_date(to_char(dt_inicio_prescricao_w,'dd/mm/yyyy') ||' '||substr(ds_horarios_p,1,2) || ':00:00','dd/mm/yyyy hh24:mi:ss');
end if;
 
ds_caracter_espaco_w	:= ' ';
if (qt_caracter_espaco_w = 2) then 
	ds_caracter_espaco_w	:= ' ';
elsif (qt_caracter_espaco_w = 3) then 
	ds_caracter_espaco_w	:= '  ';
elsif (qt_caracter_espaco_w = 4) then 
	ds_caracter_espaco_w	:= '  ';
elsif (qt_caracter_espaco_w > 4) then 
	ds_caracter_espaco_w	:= '   ';
end if;
select	padroniza_horario_prescr(reordenar_horarios(dt_Hora_Inicio_w,ds_horarios_p), to_char(dt_inicio_prescricao_w,'dd/mm/yyyy hh24:mi:ss')) || ds_caracter_espaco_w 
into STRICT		ds_horarios_w
;
 
nr_intervalo_w	:= 0;
 
while	(ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') LOOP 
	begin 
	 
	select	position(ds_caracter_espaco_w in ds_horarios_w) 
	into STRICT		k 
	;		
	 
	if (k > 1) and ((substr(ds_horarios_w, 1, k -1) IS NOT NULL AND (substr(ds_horarios_w, 1, k -1))::text <> '')) then 
		begin 
		ds_hora_w		:= substr(ds_horarios_w, 1, k-1);
		ds_hora_w		:= replace(ds_hora_w, ds_caracter_espaco_w,'');
		ds_horarios_w		:= substr(ds_horarios_w, k + 1, 2000);
		 
		if (ie_controle_w = 0) and (ds_hora_w < to_char(dt_inicio_prescricao_w,'hh24:mi')) then 
			qt_dia_adic_w	:= 1;
		elsif (position('A' in ds_hora_w) > 0) and (qt_dia_adic_w = 0) then 
			qt_dia_adic_w	:= 1;
		elsif (position('AA' in ds_hora_w) > 0) then 
			qt_dia_adic_w	:= qt_dia_adic_w + 1;
		end if;
		ie_controle_w	:= 1;
		ds_hora_w	:= replace(ds_hora_w,'A','');
		ds_hora_w	:= replace(ds_hora_w,'A','');
		 
		dt_horario_w	:= to_date(to_char(dt_inicio_prescricao_w + qt_dia_adic_w,'dd/mm/yyyy')||' '||replace(ds_hora_w,'A','')||':00','dd/mm/yyyy hh24:mi:ss');
		 
		select	count(*) 
		into STRICT		qt_pertence_w 
		 
		where	dt_horario_w >= dt_inicio_prescricao_w 
		and 		dt_horario_w < dt_validade_prescr_w;
 
		if (qt_pertence_w > 0) then 
			begin 
			ds_horarios_fixo_w	:= ds_horarios_fixo_w || ds_hora_w ||ds_caracter_espaco_w;
			nr_intervalo_w		:= nr_intervalo_w + 1;
			end;
		end if;
 
		end;
	elsif (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then 
		begin 
		ds_horarios_w		:= '';
		end;
	end if;
	end;
END LOOP;
if (nr_intervalo_w < 0) then 
	nr_intervalo_w	:= 0;
end if;
if (nr_intervalo_w = 0) or (coalesce(nr_intervalo_w::text, '') = '') then 
	nr_intervalo_w := 1;
end if;
 
nr_ocorrencia_p	:= nr_intervalo_w;
ds_horarios2_p	:= substr(ds_horarios_fixo_w,1,254);
ds_horarios3_p	:= substr(ds_horarios_fixo_w,255,255);
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ajusta_hor_padrao_prescr ( nr_prescricao_p bigint, ds_horarios_p text, ds_horarios2_p INOUT text, ds_horarios3_p INOUT text, nr_ocorrencia_p INOUT bigint) FROM PUBLIC;

