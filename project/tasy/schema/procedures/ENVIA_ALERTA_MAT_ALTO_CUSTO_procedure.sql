-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE envia_alerta_mat_alto_custo ( cd_material_p bigint, nr_atendimento_p bigint, nr_interno_conta_p bigint, nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_grupo_material_w		bigint;
cd_subgrupo_material_w 		bigint;
cd_classe_material_w		bigint;
ds_grupo_material_w		varchar(255);
ds_subgrupo_material_w 		varchar(255);
ds_classe_material_w		varchar(255);
ds_comunic_solic_w		varchar(500);
nr_seq_classif_w			bigint;
cd_setor_dest_w			bigint;
nm_usuario_dest_w			varchar(255);
cd_grupo_mat_w			bigint;
cd_subgrupo_mat_w	 	bigint;
cd_classe_mat_w			bigint;
cd_mat_w			bigint;
nr_regras_w			bigint;
cd_setor_w			varchar(100);
dt_atendimento_w			varchar(50);
nm_pessoa_fisica_w		varchar(100);
ds_convenio_w			varchar(100);
qt_material_w			double precision;
ds_fornecedor_w			varchar(80);
cd_perfil_w			integer;
ie_ci_lida_w			varchar(1);
nr_seq_comunic_w			bigint;
ds_acao_w			varchar(50);

c01 CURSOR FOR 
	SELECT	cd_grupo_material, 
		cd_subgrupo_material, 
		cd_classe_material, 
		cd_material, 
		cd_setor_atendimento, 
		cd_perfil, 
		ds_usuario_destino, 
		coalesce(ie_ci_lida,'N') 
	from 	regra_aviso_exec_mat 
	where	coalesce(cd_grupo_material, cd_grupo_material_w)		= cd_grupo_material_w 
	and	coalesce(cd_subgrupo_material, cd_subgrupo_material_w)	= cd_subgrupo_material_w 
	and	coalesce(cd_classe_material, cd_classe_material_w)		= cd_classe_material_w 
	and	coalesce(cd_material, cd_material_p)				= cd_material_p 
	and	coalesce(ie_alto_custo_conta,'S')				= 'S' 
	and (coalesce(substr(obter_dados_material_estab(cd_material_p, cd_estabelecimento_p, 'CU'),1,1),'B') = 'A') 
	and	coalesce(cd_funcao, coalesce(obter_funcao_ativa,0)) = coalesce(obter_funcao_ativa,0) 
	order by 
		coalesce(cd_grupo_material, 0), 
		coalesce(cd_subgrupo_material, 0), 
		coalesce(cd_classe_material, 0), 
		coalesce(cd_material, 0), 
		coalesce(cd_funcao,0);


BEGIN 
 
if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') and (cd_material_p > 0) then 
	begin 
 
	select	max(cd_grupo_material), 
		max(cd_subgrupo_material), 
		max(cd_classe_material), 
		substr(max(ds_grupo_material),1,255), 
		substr(max(ds_subgrupo_material),1,255), 
		substr(max(ds_classe_material),1,255) 
	into STRICT	cd_grupo_material_w, 
		cd_subgrupo_material_w, 
		cd_classe_material_w, 
		ds_grupo_material_w, 
		ds_subgrupo_material_w, 
		ds_classe_material_w 
	from	estrutura_material_v 
	where 	cd_material = cd_material_p;
 
 
	select	max(WHEB_MENSAGEM_PCK.get_texto(298788,'CD_MATERIAL_W='||cd_material||';DS_MATERIAL_W='||substr(obter_desc_material(cd_material),1,120))) 
	into STRICT	ds_comunic_solic_w 
	from 	material 
	where 	cd_material	=	cd_material_p;
 
	select	max(obter_classif_comunic('F')) 
	into STRICT	nr_seq_classif_w 
	;
	 
	begin 
	select	to_char(dt_atendimento,'dd/mm/yyyy hh24:mi:ss'), 
		substr(obter_dados_atendimento(nr_atendimento_p, 'NP'),1,100), 
		substr(obter_nome_convenio(cd_convenio),1,100), 
		qt_material, 
		substr(obter_nome_pf_pj(null,cd_cgc_fornecedor),1,80) 
	into STRICT	dt_atendimento_w, 
		nm_pessoa_fisica_w, 
		ds_convenio_w, 
		qt_material_w, 
		ds_fornecedor_w 
	from	material_atend_paciente 
	where	nr_sequencia = nr_sequencia_p;
	exception when no_data_found then 
		dt_atendimento_w	:= '';
		nm_pessoa_fisica_w	:= '';
		ds_convenio_w		:= '';
		qt_material_w		:= '';
		ds_fornecedor_w		:= '';
	end;
	 
	ds_acao_w:= Wheb_mensagem_pck.get_Texto(298789);
	if (qt_material_w < 0) then 
		ds_acao_w:= Wheb_mensagem_pck.get_Texto(298790);
	end if;
	 
	ds_comunic_solic_w	:=	substr(WHEB_MENSAGEM_PCK.get_texto(298791, 
					'NR_INTERNO_CONTA_P='||NR_INTERNO_CONTA_P|| 
					';NR_ATENDIMENTO_P='||NR_ATENDIMENTO_P|| 
					';DS_COMUNIC_SOLIC_W='||DS_COMUNIC_SOLIC_W|| 
					';DT_ATENDIMENTO_W='||DT_ATENDIMENTO_W|| 
					';NM_PESSOA_FISICA_W='||NM_PESSOA_FISICA_W|| 
					';DS_CONVENIO_W='||DS_CONVENIO_W|| 
					';QT_MATERIAL_W='||QT_MATERIAL_W|| 
					';DS_FORNECEDOR_W='||DS_FORNECEDOR_W|| 
					';DS_ACAO_W='||DS_ACAO_W|| 
					';DS_GRUPO_MATERIAL_W='||DS_GRUPO_MATERIAL_W|| 
					';DS_SUBGRUPO_MATERIAL_W='||DS_SUBGRUPO_MATERIAL_W|| 
					';DS_CLASSE_MATERIAL_W='||DS_CLASSE_MATERIAL_W|| 
					';CD_FUNCAO_W='||obter_funcao_ativa|| 
					';DS_FUNCAO_W='||substr(obter_nome_funcao(obter_funcao_ativa),1,200)),1,500);
					/*Material de Alto Custo incluído: 
					Conta : #@NR_INTERNO_CONTA_P#@ 
					Atendimento: #@NR_ATENDIMENTO_P#@ 
					#@DS_COMUNIC_SOLIC_W#@ 
					Data lançamento: #@DT_ATENDIMENTO_W#@ 
					Paciente: #@NM_PESSOA_FISICA_W#@ 
					Convênio: #@DS_CONVENIO_W#@ 
					Qt material: #@QT_MATERIAL_W#@ 
					Fornecedor consignado: #@DS_FORNECEDOR_W#@ 
					Ação: #@DS_ACAO_W#@ 
					Grupo: #@DS_GRUPO_MATERIAL_W#@ 
					Subgrupo: #@DS_SUBGRUPO_MATERIAL_W#@ 
					Classe: #@DS_CLASSE_MATERIAL_W#@ 
					Função: #@CD_FUNCAO_W#@ - #@DS_FUNCAO_W#@*/
 
 
 
 
	select	count(*) 
	into STRICT	nr_regras_w 
	from 	regra_aviso_exec_mat;
 
	if (nr_regras_w > 0) then 
		open	c01;
		loop 
		fetch	c01 into 
			cd_grupo_mat_w, 
			cd_subgrupo_mat_w, 
			cd_classe_mat_w, 
			cd_mat_w, 
			cd_setor_dest_w, 
			cd_perfil_w, 
			nm_usuario_dest_w, 
			ie_ci_lida_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
		end loop;
		close 	c01;	
	 
		if (coalesce(cd_setor_dest_w::text, '') = '') then 
			cd_setor_w:= null;
		else	 
			cd_setor_w:= to_char(cd_setor_dest_w) || ',';
		end if;	
	 
		if	not ((coalesce(cd_setor_w::text, '') = '') and (coalesce(nm_usuario_dest_w::text, '') = '')) then 
			begin 
 
			select	nextval('comunic_interna_seq') 
			into STRICT	nr_seq_comunic_w 
			;
			 
			insert	into comunic_interna( 
					dt_comunicado,	 
					ds_titulo,	 
					ds_comunicado,	 
					nm_usuario, 
					dt_atualizacao,	 
					ie_geral,			 
					nm_usuario_destino,	 
					nr_sequencia, 
					ie_gerencial, 
					nr_seq_classif,				 
					ds_setor_adicional, 
					cd_estab_destino, 
					dt_liberacao, 
					ds_perfil_adicional) 
				values (	clock_timestamp(),	 
					Wheb_mensagem_pck.get_Texto(298797), 
					ds_comunic_solic_w,	 
					nm_usuario_p, 
					clock_timestamp(),	 
					'N',				 
					nm_usuario_dest_w,		 
					nr_seq_comunic_w, 
					'N', 
					nr_seq_classif_w, 
					cd_setor_w, 
					cd_estabelecimento_p,			 
					clock_timestamp(), 
					cd_perfil_w || ',');
 
			if (ie_ci_lida_w = 'S') then 
				insert into comunic_interna_lida( 
					nr_sequencia, 
					nm_usuario, 
					dt_atualizacao) values ( 
						nr_seq_comunic_w, 
						nm_usuario_p, 
						clock_timestamp());
			end if;
 
			end;
		end if;
	end if;
	end;
end if;
	 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE envia_alerta_mat_alto_custo ( cd_material_p bigint, nr_atendimento_p bigint, nr_interno_conta_p bigint, nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

