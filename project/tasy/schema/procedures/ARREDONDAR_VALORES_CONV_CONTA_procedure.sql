-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE arredondar_valores_conv_conta ( nr_interno_conta_p bigint, vl_conta_original_p bigint, vl_base_com_imposto_p bigint, nm_usuario_p text) AS $body$
DECLARE


vl_total_item_w		conta_paciente.vl_conta%type := 0;
vl_conta_novo_w		conta_paciente.vl_conta%type := 0;

vl_medico_dif_w		procedimento_paciente.vl_medico%type;
vl_custo_oper_dif_w	procedimento_paciente.vl_custo_operacional%type;

nr_seq_proc_dif_w	procedimento_paciente.nr_sequencia%type;
nr_seq_proc_ded_dif_w	procedimento_paciente.nr_sequencia%type;
nr_seq_mat_dif_w	material_atend_paciente.nr_sequencia%type;
nr_seq_mat_ded_dif_w	material_atend_paciente.nr_sequencia%type;

vl_total_calculado_w	conta_pac_deducao_conv.vl_calculado%type;

vl_diferenca_w		double precision := 0;
vl_total_rateio_imposto_w	double precision;
ie_desconto_imposto_w	varchar(1);


BEGIN

if (coalesce(nr_interno_conta_p,0) > 0) then

	select	sum(vl_calculado)
	into STRICT	vl_total_calculado_w
	from	conta_pac_deducao_conv
	where	nr_seq_conta_orig = nr_interno_conta_p;

	vl_conta_novo_w	:= coalesce(obter_valor_conta(nr_interno_conta_p,0),0);

	if (vl_conta_novo_w + coalesce(vl_total_calculado_w,0) <> vl_conta_original_p) then

		vl_diferenca_w	:= vl_conta_original_p - vl_conta_novo_w - coalesce(vl_total_calculado_w,0);

		if (coalesce(vl_diferenca_w,0) <> 0) then
			select	coalesce(sum(vl_rateio),0)
			into STRICT	vl_total_rateio_imposto_w
			from (SELECT	a.vl_rateio
					from	conta_pac_ded_conv_item a,
							conta_pac_deducao_conv b
					where	a.nr_seq_deducao_conv = b.nr_sequencia
					and		nr_seq_conta_orig = nr_interno_conta_p
					and		a.nr_seq_propaci_origem > 0
					and		exists (select	1
									from	propaci_imposto y
									where	y.nr_seq_propaci = a.nr_seq_propaci_origem
									and		y.pr_imposto > 0)
					
union all

					SELECT	a.vl_rateio
					from	conta_pac_ded_conv_item a,
							conta_pac_deducao_conv b
					where	a.nr_seq_deducao_conv = b.nr_sequencia
					and		nr_seq_conta_orig = nr_interno_conta_p
					and		a.nr_seq_matpaci_origem > 0
					and		exists (select	1
									from	matpaci_imposto y
									where	y.nr_seq_matpaci = a.nr_seq_matpaci_origem
									and		y.pr_imposto > 0)
					) alias6;

			if (vl_base_com_imposto_p > 0) then
				if (vl_base_com_imposto_p - vl_total_rateio_imposto_w <> 0) then
					ie_desconto_imposto_w	:= 'S';
				else
					ie_desconto_imposto_w	:= 'N';
				end if;
			end if;

			/*Obter o procedimento em que a diferença será gerada*/

			select	max(a.nr_sequencia)
			into STRICT	nr_seq_proc_dif_w
			from 	procedimento_paciente a
			where	a.nr_interno_conta = nr_interno_conta_p
			and		coalesce(a.nr_seq_proc_pacote::text, '') = ''
			and 	a.vl_procedimento > abs(vl_diferenca_w)
			and (exists (SELECT	1
							from	propaci_imposto x
							where	x.nr_seq_propaci = a.nr_sequencia
							and		x.pr_imposto > 0) or ie_desconto_imposto_w = 'N')
			and (not exists (select	1
							from	propaci_imposto x
							where	x.nr_seq_propaci = a.nr_sequencia
							and		x.pr_imposto > 0) or ie_desconto_imposto_w = 'S')
			and (select	sum(qt_procedimento)
				from	procedimento_paciente x
				where	x.cd_procedimento = a.cd_procedimento
				and	x.ie_origem_proced = a.ie_origem_proced
				and	coalesce(x.nr_seq_proc_pacote::text, '') = ''
				and	x.nr_interno_conta = nr_interno_conta_p) <> 0;

			if (coalesce(nr_seq_proc_dif_w,0) > 0) then

				update	procedimento_paciente
				set	vl_procedimento = vl_procedimento + vl_diferenca_w
				where	nr_sequencia = nr_seq_proc_dif_w;

				select	coalesce(sum(vl_custo_operacional),0),
					coalesce(sum(vl_medico),0)
				into STRICT	vl_custo_oper_dif_w,
					vl_medico_dif_w
				from	procedimento_paciente
				where	nr_sequencia = nr_seq_proc_dif_w;

				if (vl_custo_oper_dif_w <> 0) then
					update	procedimento_paciente
					set	vl_custo_operacional = vl_custo_operacional + vl_diferenca_w
					where	nr_sequencia = nr_seq_proc_dif_w;
				elsif (vl_medico_dif_w <> 0) then
					update	procedimento_paciente
					set	vl_medico = vl_medico + vl_diferenca_w
					where	nr_sequencia = nr_seq_proc_dif_w;
				end if;

			else
				/*Caso não tenha procedimentos, obter o material em que a diferença será gerada*/

				select	max(a.nr_sequencia)
				into STRICT	nr_seq_mat_dif_w
				from 	material_atend_paciente a
				where	a.nr_interno_conta = nr_interno_conta_p
				and	coalesce(a.nr_seq_proc_pacote::text, '') = ''
				and 	a.vl_material > abs(vl_diferenca_w)
				and (exists (SELECT	1
							from	matpaci_imposto x
							where	x.nr_seq_matpaci = a.nr_sequencia
							and		x.pr_imposto > 0) or ie_desconto_imposto_w = 'N')
				and (not exists (select	1
								from	matpaci_imposto x
								where	x.nr_seq_matpaci = a.nr_sequencia
								and		x.pr_imposto > 0) or ie_desconto_imposto_w = 'S')
				and (select	sum(qt_material)
					from	material_atend_paciente x
					where	x.cd_material = a.cd_material
					and	coalesce(x.nr_seq_proc_pacote::text, '') = ''
					and	x.nr_interno_conta = nr_interno_conta_p) <> 0;

				if (coalesce(nr_seq_mat_dif_w,0) > 0) then

					update	material_atend_paciente
					set	vl_material = vl_material + vl_diferenca_w
					where	nr_sequencia = nr_seq_mat_dif_w;

				end if;

			end if;

		end if;

	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE arredondar_valores_conv_conta ( nr_interno_conta_p bigint, vl_conta_original_p bigint, vl_base_com_imposto_p bigint, nm_usuario_p text) FROM PUBLIC;

