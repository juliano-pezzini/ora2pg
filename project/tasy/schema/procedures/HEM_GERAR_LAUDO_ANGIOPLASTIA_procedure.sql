-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hem_gerar_laudo_angioplastia ( nr_seq_proc_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_texto_w			varchar(20000);
ds_angioplastia_w			varchar(20000);
ds_segmento_w			varchar(20000);
ds_vaso_w			varchar(20000);
ds_caracteristica_w			varchar(32000);
ds_dispositivo_adj_w		varchar(20000);
ds_dispositivo_utili_w		varchar(20000);
ds_observacao_laudo_w		varchar(20000);
ds_observacao_geral_w		varchar(20000);
ds_seta_w			varchar(20000);
ds_cabecalho_w			varchar(20000);
ds_sql_w				varchar(20000);
ds_obs_laudo_w			varchar(20000);
ds_bifurcacao_w			varchar(255);
ds_seq_reestenose_w		varchar(255);
ds_disseccao_w			varchar(255);
ds_seq_tecnica_w			varchar(255);
ds_kissing_w			varchar(255);
ds_medina_w			varchar(255);
ds_oclusao_cronica_w		varchar(255);
ds_tipo_w			varchar(255);
ie_angio_primaria_w		varchar(5);
C001				integer;
retorno_w				integer;
nr_seq_lesao_w			bigint;
qt_registros_w			bigint;
qt_diametro_w			varchar(20);
qt_comprimento_w			varchar(20);
qt_diam_pre_dilat_w		varchar(20);
qt_comp_pre_dilat_w		varchar(20);
qt_diam_pos_dilat_w		varchar(20);	
qt_comp_pos_dilat_w		varchar(20);
qt_numeros_registros_w		bigint;
dt_entrada_w			timestamp;
ie_qca_w				hem_atc_quant.ie_qca%type;
qt_diametro_lum_pre_w		varchar(20);
qt_diametro_ref_prox_pre_w		varchar(20);
pr_estenose_pre_w			varchar(20);
qt_diametro_lum_pos_w		varchar(20);
qt_diametro_ref_prox_pos_w		varchar(20);
pr_estenose_pos_w			varchar(20);
ds_quantitativa_w			varchar(20000);
ds_conclusao_w			varchar(20000);
ds_conclusao_ww			varchar(20000);
ds_conclusao_agrupada_w		varchar(20000);
nr_seq_disp_w			bigint;
ie_sucesso_w			varchar(1);
ds_sucesso_w			varchar(80);
ds_aux1_w			varchar(1000);
ds_aux2_w			varchar(255);
ds_procedimento_w			varchar(255);
ie_calcificacao_w			hem_cat_lesao.ie_calcificacao%type;
nr_seq_diam_trepano_w		hem_cat_lesao.nr_seq_diam_trepano%type;
ds_trepano_w			varchar(255);
ie_lesao_culpada_w		varchar(255);
ie_placa_ulcerada_w		hem_cat_lesao.ie_placa_ulcerada%type;
ie_trombo_w			hem_cat_lesao.ie_trombo%type;
ie_tortuosidade_w			hem_cat_lesao.ie_tortuosidade%type;
ds_oclusor_w			hem_oclusores.ds_oclusor%type;
ie_disseccao_w			varchar(1);
ds_lesao_w			hem_lesao.ds_lesao%type;
ds_lesao_culpada_w		varchar(100);
ds_vaso_seg_agrupado_w		varchar(2000);
ds_disp_adjunto_w			varchar(255);
ds_medic_agrup_w			varchar(255);
ds_medicamento_w			varchar(255);
ds_acesso_w			varchar(2000);
ds_medic_w			varchar(255);
ie_possui_medic_w		varchar(1) := 'N';

C00 CURSOR FOR
	SELECT	nr_sequencia,
		substr(ds_lesao,1,100),
		substr(Obter_Valor_Dominio(8761,ie_lesao_culpada),1,100),
		ie_lesao_culpada
	from	hem_lesao
	where	nr_seq_proc = nr_seq_proc_p
	order by 1;
	
C01 CURSOR FOR
	SELECT	nr_sequencia,
		substr(obter_desc_hem_vaso(nr_seq_vaso), 1, 100) ds_vaso
	from 	hem_coronariografia
	where 	nr_seq_lesao = nr_seq_lesao_w
	order by 1;

C02 CURSOR FOR
	SELECT	substr(obter_desc_hem_balao(nr_seq_balao), 1, 255),
		hd_somente_numero(trim(both to_char(qt_diametro,'99999999999999D99'))),
		hd_somente_numero(trim(both to_char(qt_comprimento,'99999999999999D99'))),
		hd_somente_numero(trim(both to_char(qt_diam_pre_dilat,'99999999999999D99'))),
		hd_somente_numero(trim(both to_char(qt_comp_pre_dilat,'99999999999999D99'))),
		hd_somente_numero(trim(both to_char(qt_diam_pos_dilat,'99999999999999D99'))),
		hd_somente_numero(trim(both to_char(qt_comp_pos_dilat,'99999999999999D99')))
	from	hem_atc_balao
	where 	nr_seq_lesao = nr_seq_lesao_w;

C03 CURSOR(nr_seq_coron_pc bigint, nr_seq_lesao_pc bigint) FOR
	SELECT 	distinct SUBSTR(Obter_desc_hem_segmento_princ(a.nr_seq_segmento),1,100) ds_segmento
	from	hem_coron_localizacao a,
		hem_coronariografia b
	where	a.nr_seq_coron	= b.nr_sequencia
	and	b.nr_seq_lesao = nr_seq_lesao_pc
	and	b.nr_sequencia = nr_seq_coron_pc
	order by 1;
	
C04 CURSOR FOR
	SELECT	nr_sequencia
	from	hem_atc_balao a
	where 	nr_seq_lesao = nr_seq_lesao_w
	and	(qt_diametro IS NOT NULL AND qt_diametro::text <> '')
	and	(qt_comprimento IS NOT NULL AND qt_comprimento::text <> '');
	
C05 CURSOR FOR
	SELECT 	substr(obter_desc_disp_adjunto(nr_seq_disp_adjunto),1,255) ds_disp_adjunto
	from  	HEM_CORO_DISP_ADJUNTO
	where 	nr_seq_lesao = nr_seq_lesao_w
	order by 1;
	
C06 CURSOR FOR
  SELECT
  CASE WHEN coalesce(nr_seq_medic::text, '') = '' THEN ''  ELSE substr(obter_desc_dado_clinico(nr_seq_medic,'M'),1,255) END  ds_medic_w,
  obter_desc_expressao(301161) || ' ' ||
  CASE WHEN coalesce(nr_seq_medic::text, '') = '' THEN ''  ELSE substr(obter_desc_dado_clinico(nr_seq_medic,'M'),1,255) END  || ' ' ||
  obter_desc_expressao(884673) || ' ' ||
  CASE WHEN coalesce(qt_dose::text, '') = '' THEN ''  ELSE qt_dose||' '||cd_unidade_medida END  || ' ' ||
  obter_desc_expressao(868386)  || ' ' ||
  lower(substr(obter_valor_dominio(14,ie_via_aplicacao),1,255)) || '. '
  from 	hem_proc_medic
	where nr_seq_proc = nr_seq_proc_p
	order by 1;
	
C07 CURSOR FOR
	SELECT	substr(obter_valor_dominio(1489,ie_vaso_acesso),1,255) ds_vaso_acesso,
		substr(obter_valor_dominio(1483,ie_acesso),1,255) ds_acesso,
		CASE WHEN coalesce(ie_lat_acesso::text, '') = '' THEN ' '  ELSE ' '|| substr(obter_valor_dominio(1488,ie_lat_acesso),1,255) ||' ' END  ds_lat_acesso,
		CASE WHEN coalesce(nr_seq_oclusor::text, '') = '' THEN ''  ELSE ' '||substr(hem_obter_desc_oclusor(nr_seq_oclusor),1,255) END  ds_disp_oclusor,
		CASE WHEN coalesce(qt_oclusor::text, '') = '' THEN ''  ELSE ' '||qt_oclusor END  qt_oclusor
	from	hem_acesso
	where	nr_seq_proc = nr_seq_proc_p
	order by nr_sequencia;
	
BEGIN

if (coalesce(nr_seq_proc_p, 0) > 0) then
	
	ds_seta_w	:= 	' {\rtf1\ansi\ansicpg1252\deff0\deflang1046{\fonttbl{\f0\fnil\fcharset0 Calibri;}}'||
				'{\*\generator Msftedit 5.41.21.2510;}\viewkind4\uc1\pard\sa200\sl276\slmult1\lang22\b\f0\fs24\u8594?\b0\fs22'||
				'} ';
	
	ds_cabecalho_w	:=	'{\rtf1\ansi\ansicpg1252\deff0\deflang1046{\fonttbl{\f0\fnil\fcharset0 Arial;}{\f1\fnil\fcharset0 Calibri;}}'||
				'{\colortbl ;\red0\green0\blue0;}';
	
	for c07_r in C07 loop
		begin
		ds_acesso_w := 	ds_acesso_w ||'\par \pard\qj ';		
		ds_acesso_w := 	ds_acesso_w || c07_r.ds_vaso_acesso ||' '|| lower(c07_r.ds_acesso) || lower(c07_r.ds_lat_acesso) ||
				'('||lower(obter_desc_expressao(878849))|| c07_r.qt_oclusor || c07_r.ds_disp_oclusor||').';--'(realizada hemostasia com'		
		end;
	end loop;
	
	select 	dt_entrada,
		CASE WHEN ie_primaria='S' THEN  wheb_mensagem_pck.get_texto(498758)  ELSE wheb_mensagem_pck.get_texto(498759) END ,
		SUBSTR(obter_desc_hem_procedimento(nr_seq_procedimento),1,255)
	into STRICT	dt_entrada_w,
		ie_angio_primaria_w,
		ds_procedimento_w
	from 	hem_proc
	where 	nr_sequencia = nr_seq_proc_p;
		
	qt_numeros_registros_w := 1;
	ds_caracteristica_w := '';
	
	open C00;
	loop
	fetch C00 into	
		nr_seq_lesao_w,
		ds_lesao_w,
		ds_lesao_culpada_w,
		ie_lesao_culpada_w;
	EXIT WHEN NOT FOUND; /* apply on C00 */
		begin
			
			ds_caracteristica_w := ds_caracteristica_w || '\par\i '|| qt_numeros_registros_w || '. ';
			ds_vaso_seg_agrupado_w := null;
			
			for r_C01 in C01 loop
				begin
				ds_texto_w := '';
				
				ds_caracteristica_w := ds_caracteristica_w|| r_C01.ds_vaso || chr(13);
				
				/*Início junção da descrição do VASO com o SEGMENTO*/

				for r_C03 in C03(r_C01.nr_sequencia, nr_seq_lesao_w) loop
					begin
					ds_texto_w := ds_texto_w || r_C03.ds_segmento || ', ';
					end;
				end loop;
				
				ds_texto_w := retirar_string(ds_texto_w, 2);
				ds_caracteristica_w := ds_caracteristica_w ||' '|| ds_texto_w || chr(13) ||'\par \pard\qj ';
				
				if (coalesce(ds_vaso_seg_agrupado_w::text, '') = '') then
					ds_vaso_seg_agrupado_w := ds_vaso_seg_agrupado_w||ds_texto_w||' '||obter_desc_expressao(793044)||' '||r_C01.ds_vaso;
				else
					ds_vaso_seg_agrupado_w := ds_vaso_seg_agrupado_w||' '||obter_desc_expressao(312342)||' '||ds_texto_w||' '||obter_desc_expressao(793044)||' '||r_C01.ds_vaso;
				end if;
				
				/*Fim junção da descrição do VASO com o SEGMENTO*/

				ds_dispositivo_adj_w := '';
				ds_aux1_w := '';
				
				open C04;
				loop
				fetch C04 into	
					nr_seq_disp_w;
				EXIT WHEN NOT FOUND; /* apply on C04 */
					begin

					if (coalesce(ds_aux1_w::text, '') = '') then
						ds_aux1_w := ' '|| lower(obter_desc_expressao(623281)); -- 'com'					
					end if;
					
					select	lower(substr(obter_desc_hem_balao(nr_seq_balao), 1, 255)),
						hd_somente_numero(trim(both to_char(QT_DIAMETRO,'99999999999999D99')))||' x',
						hd_somente_numero(trim(both to_char(QT_COMPRIMENTO,'99999999999999D99')))||' mm'
					into STRICT	ds_dispositivo_adj_w,
						qt_diametro_w,
						qt_comprimento_w
					from	hem_atc_balao
					where	nr_sequencia = nr_seq_disp_w;
			
					ds_aux1_w := substr(ds_aux1_w || ' '||ds_dispositivo_adj_w||' '||qt_diametro_w||' '||qt_comprimento_w||' '||obter_desc_expressao(312342),1,1000); --'e'
					

					end;
				end loop;
				close C04;
				
				end;
			end loop;

			/*Início Medicamento*/
			
			ds_medic_agrup_w := '\viewkind4\uc1\pard\cf1\lang1046\b\fs24 '||UPPER(obter_desc_expressao(10652448))||'\b0\par\par ';
			
			open C06;
			loop
			fetch C06 into	
				ds_medic_w,
				ds_medicamento_w;
			EXIT WHEN NOT FOUND; /* apply on c06 */
				begin
				if (ds_medic_w IS NOT NULL AND ds_medic_w::text <> '') and (upper(trim(both ds_medic_w)) <> upper(trim(both wheb_mensagem_pck.get_texto(1029350)))) then
					ds_medic_agrup_w := ds_medic_agrup_w || ds_medicamento_w||'\par ';
					ie_possui_medic_w := 'S';
				end if;
				end;
			end loop;
			close C06;
			
			if (ie_possui_medic_w = 'S') then
				ds_medic_agrup_w := ds_medic_agrup_w ||'\par';
			else
				ds_medic_agrup_w := null;
			end if;
			/*Fim medicamento*/


			
			/*Início conclusão do Laudo*/

			if (ds_aux1_w IS NOT NULL AND ds_aux1_w::text <> '') then
				ds_aux1_w := retirar_string(ds_aux1_w, 2);
				ds_aux1_w := ds_aux1_w||', ';
			end if;

			select	max(ie_sucesso),
				max((	select	max(ds_sucesso)
					from	hem_sucesso b
					where	a.nr_seq_sucesso = b.nr_sequencia))
			into STRICT	ie_sucesso_w,
				ds_sucesso_w
			from	hem_atc a
			where	nr_seq_lesao = nr_seq_lesao_w;

			select 	CASE WHEN ie_sucesso_w='S' THEN  lower(obter_desc_expressao(793048))||'.' WHEN ie_sucesso_w='I' THEN  lower(obter_desc_expressao(793052))||				CASE WHEN coalesce(ds_sucesso_w::text, '') = '' THEN '. '  ELSE ' ' END ||ds_sucesso_w||				CASE WHEN coalesce(ds_sucesso_w::text, '') = '' THEN ''  ELSE '.' END   ELSE ' '||obter_desc_expressao(793054)||'.' END
			into STRICT	ds_aux2_w
			;
		
     
			if (coalesce(ds_conclusao_w::text, '') = '') then

				ds_conclusao_w := '\viewkind4\uc1\pard\cf1\lang1046\b\fs24 '||upper(obter_desc_expressao(285638))||'\b0\par\par\ '||--'
						qt_numeros_registros_w||' - \pard\ltrpar\fi-360\li360'||' '||ds_procedimento_w||' '||
						ds_vaso_seg_agrupado_w||','||
						ds_aux1_w||ds_aux2_w||
						'\par';
			else 

				ds_conclusao_w := '\viewkind4\uc1\pard\cf1\lang1046\fs24 '||
						qt_numeros_registros_w||' - \pard\ltrpar\fi-360\li360'||ds_procedimento_w||' '||
						ds_vaso_seg_agrupado_w||','||
						ds_aux1_w||ds_aux2_w||
						'\par';
			end if;
			
			ds_conclusao_agrupada_w := ds_conclusao_agrupada_w || ds_conclusao_w;
			/*Fim conclusão laudo*/

				
			qt_numeros_registros_w := qt_numeros_registros_w + 1;
			
			select	max(substr(hem_obter_desc_bifurcacao(ie_bifurcacao), 1, 100)),
				max(substr(obter_desc_hem_reestenose(nr_seq_reestenose), 1, 100)),
				max(substr(Obter_Valor_Dominio(7104, ie_disseccao), 1, 100)),
				max(ie_disseccao),
				max(substr(hem_obter_desc_tecnica(nr_seq_tecnica), 1, 100)),
				max(lower(substr(Obter_Valor_Dominio(8057, ie_kissing), 1, 100))),
				max(substr(Obter_Valor_Dominio(8183, cd_medina), 1, 100)),
				max(ie_oclusao_cronica),
				max(substr(Obter_Valor_Dominio(1486, ie_tipo), 1, 100)),
				nvl(max(ie_calcificacao),'X'),
				max(nr_seq_diam_trepano),
				max(ie_placa_ulcerada),
				max(ie_trombo),
				max(ie_tortuosidade)
			into 	ds_bifurcacao_w,
				ds_seq_reestenose_w,
				ds_disseccao_w,
				ie_disseccao_w,
				ds_seq_tecnica_w,
				ds_kissing_w,
				ds_medina_w,
				ds_oclusao_cronica_w,
				ds_tipo_w,
				ie_calcificacao_w,
				nr_seq_diam_trepano_w,
				ie_placa_ulcerada_w,
				ie_trombo_w,
				ie_tortuosidade_w
			from	hem_cat_lesao
			where	nr_seq_lesao = nr_seq_lesao_w;
			
			ds_texto_w := '\i0';
      if	(nvl(ie_lesao_culpada_w,'N') = 'S') then
				ds_texto_w := ds_texto_w || '	' || obter_desc_expressao(803058) ||'\i0 \par \pard\qj ';
			end if;
			if	(ds_oclusao_cronica_w is not null and upper(ds_oclusao_cronica_w) <> 'N') then
				ds_texto_w := ds_texto_w || '	' || wheb_mensagem_pck.get_texto(499416) || '\i0 \par \pard\qj ';
			end if;
			if	(ie_placa_ulcerada_w is not null and upper(ie_placa_ulcerada_w) <> 'N') then
				ds_texto_w := ds_texto_w || '	' || obter_desc_expressao(295935) || '\i0 \par \pard\qj ';
			end if;
			if	(ie_trombo_w is not null and upper(ie_trombo_w) <> 'N') then
				ds_texto_w := ds_texto_w || '	' || obter_desc_expressao(868439) || '\i0 \par \pard\qj ';
			end if;
			if	(ie_tortuosidade_w is not null and upper(ie_tortuosidade_w) <> 'N') then
				ds_texto_w := ds_texto_w || '	' || obter_desc_expressao(868441) || '\i0 \par \pard\qj ';
			end if;
			if	(ds_seq_reestenose_w is not null and upper(ds_seq_reestenose_w) <> wheb_mensagem_pck.get_texto(341359)) then
				ds_texto_w := ds_texto_w ||  '	' || wheb_mensagem_pck.get_texto(499411) || ' ' || lower(ds_seq_reestenose_w) || '\i0 \par \pard\qj ';
			end if;
			if	(ds_disseccao_w is not null and ie_disseccao_w <> '0') then
				ds_texto_w := ds_texto_w || '	' || obter_desc_expressao(868451) || ' ' || ds_disseccao_w || '\i0 \par \pard\qj ';
			end if;
			
			if	(ie_calcificacao_w = 'A') then

				select 	max(substr(decode(ds_trepano,null,null,' '||ds_trepano||' mm'),1,10))
				into	ds_trepano_w
				from   	hem_diametro_trepano
				where 	nr_sequencia = nr_seq_diam_trepano_w;
			
				ds_texto_w := ds_texto_w || '	' || obter_desc_expressao(868445)||' '||ds_trepano_w||'. '||'\i0 \par \pard\qj ';
			elsif (ie_calcificacao_w = 'S') then
				ds_texto_w := ds_texto_w || '	' || obter_desc_expressao(868447) || '\i0 \par \pard\qj ';
			end if;
			
			if	(upper(ds_bifurcacao_w) = upper(obter_desc_expressao(302711))) then
				ds_texto_w := ds_texto_w || '	' || obter_desc_expressao(302711); -- '	Bifurcação'
				if	(ds_medina_w is not null) then
					ds_texto_w := ds_texto_w || ', ' || lower(obter_desc_expressao(734319)) || ' ' || ds_medina_w; -- ', Medina XXX'
				end if;
				if	(ds_seq_tecnica_w is not null) then
					ds_texto_w := ds_texto_w || ', ' || lower(wheb_mensagem_pck.get_texto(499413)) || ' ' || ds_seq_tecnica_w; --', Técnica XXX'
				end if;
				if	(ds_kissing_w is not null and upper(ds_kissing_w) <> wheb_mensagem_pck.get_texto(341359)) then --  NÃO
					ds_texto_w := ds_texto_w || ', ' || obter_desc_expressao(869936) || ' ' || ds_kissing_w; -- ', realizado kissing XXX'
				end if;
				ds_texto_w := ds_texto_w || '\i0 \par \pard\qj ';
			elsif	(upper(ds_bifurcacao_w) = upper(obter_desc_expressao(617536))) then
				ds_texto_w := ds_texto_w || '	' || obter_desc_expressao(617536); -- '	Trifurcação'
				if	(ds_seq_tecnica_w is not null) then
					ds_texto_w := ds_texto_w || ', ' || lower(wheb_mensagem_pck.get_texto(499413)) || ' ' || ds_seq_tecnica_w; --', Técnica XXX'
				end if;
				if	(ds_kissing_w is not null and upper(ds_kissing_w) <> wheb_mensagem_pck.get_texto(341359)) then --  NÃO
					ds_texto_w := ds_texto_w || ', ' || obter_desc_expressao(869936) || ' ' || ds_kissing_w; -- ', realizado kissing XXX'
				end if;
				ds_texto_w := ds_texto_w || '\i0 \par \pard\qj ';
			end if;

			if	(ds_tipo_w is not null) then
				ds_texto_w := ds_texto_w || '	' || obter_desc_expressao(869938) || ' ' || ds_tipo_w || '\i0 \par \pard\qj '; -- 'Lesão tipo XXX'
			end if;
			
			ds_caracteristica_w := ds_caracteristica_w ||'\par \ ' || ds_texto_w;
			
			select	count(*)
			into	qt_registros_w
			from	hem_atc_balao
			where 	nr_seq_lesao = nr_seq_lesao_w;	
			
			if	(nvl(qt_registros_w, 0) > 0) then
				ds_caracteristica_w := ds_caracteristica_w || '\par \pard\qj '; --||ds_seta_w|| obter_desc_expressao(788272) || '\i0 \par \pard\qj ';
			end if;
			
			open C02;
			loop
			fetch C02 into	
				ds_dispositivo_adj_w,
				qt_diametro_w,
				qt_comprimento_w,
				qt_diam_pre_dilat_w,
				qt_comp_pre_dilat_w,
				qt_diam_pos_dilat_w,
				qt_comp_pos_dilat_w;
			exit when C02%notfound;
				begin
				ds_dispositivo_utili_w	:= '';
				--ds_dispositivo_utili_w := '\b ' || '	' || ds_dispositivo_adj_w || '\b0 ' || '\i0 \par \pard\qj ';
				if	(qt_diam_pre_dilat_w is not null) or
					(qt_comp_pre_dilat_w is not null) then
				
					ds_dispositivo_utili_w := ds_dispositivo_utili_w || '	' || wheb_mensagem_pck.get_texto(502918) || ': ' || qt_diam_pre_dilat_w ||
												' x ' || qt_comp_pre_dilat_w || ' mm' || '\i0 \par \pard\qj ';
				
				end if;
				
				if	(qt_diametro_w is not null) or 
					(qt_comprimento_w is not null) then
					
					ds_dispositivo_utili_w := ds_dispositivo_utili_w || '	' || '\b '|| ds_dispositivo_adj_w || '\b0 ' || ': ' || qt_diametro_w ||
												' x ' || qt_comprimento_w || ' mm' || '\i0 \par \pard\qj ';
					
				end if;
				
				if	(qt_diam_pos_dilat_w is not null) or 
					(qt_comp_pos_dilat_w is not null) then
					
					ds_dispositivo_utili_w := ds_dispositivo_utili_w || '	' || wheb_mensagem_pck.get_texto(503424) || ': ' || qt_diam_pos_dilat_w ||
												' x ' || qt_comp_pos_dilat_w || ' mm' || '\i0 \par \pard\qj ';
					
				end if;
				
				ds_caracteristica_w := ds_caracteristica_w || ds_dispositivo_utili_w;
				end;
			end loop;
			close C02;
						
      /* INICIO - Adiciona os dispositivos adjuntos. */
	
			ds_disp_adjunto_w := null;
			ds_caracteristica_w := ds_caracteristica_w||'\par';
			open C05;
			loop
			fetch C05 into	
				ds_disp_adjunto_w;
			exit when C05%notfound;
				begin
          if(upper(trim(ds_disp_adjunto_w)) <> upper(trim(wheb_mensagem_pck.get_texto(1029350)))) then
            ds_caracteristica_w := ds_caracteristica_w ||'\tab '|| ds_seta_w || wheb_mensagem_pck.get_texto(1029349) || ': ' ||substr(ds_disp_adjunto_w,1,255);
            ds_caracteristica_w := ds_caracteristica_w ||'\par ';
          end if;
				end;
			end loop;
			close C05;
			/*FIM - Adiciona os dispositivos adjuntos. */


			
			/*Observação da lesão*/

			select	decode(max(ds_observacao),null,null,max(replace(ds_observacao,chr(10),'\par'||chr(10))))
			into	ds_obs_laudo_w
			from	hem_lesao
			where	nr_sequencia = nr_seq_lesao_w;
						
			if	(ds_obs_laudo_w is not null) then
				ds_caracteristica_w := ds_caracteristica_w ||'\par \tab '||ds_seta_w;
				ds_caracteristica_w := ds_caracteristica_w ||ds_obs_laudo_w|| '\i0 \par \pard\qj ';
			end if;
			
			select	max(ie_qca),
				decode(max(qt_diametro_lum_pre),null,'0',trim(to_char(max(qt_diametro_lum_pre),'99999999999990D99'))),
				decode(max(qt_diametro_ref_prox_pre),null,'0',trim(to_char(max(qt_diametro_ref_prox_pre),'99999999999990D99'))),
				decode(max(pr_estenose_pre),null,'0',trim(to_char(max(pr_estenose_pre),'99999999999990D99'))),
				decode(max(qt_diametro_lum_pos),null,'0',trim(to_char(max(qt_diametro_lum_pos),'99999999999990D99'))),
				decode(max(qt_diametro_ref_prox_pos),null,'0',trim(to_char(max(qt_diametro_ref_prox_pos),'99999999999990D99'))),
				decode(max(pr_estenose_pos),null,'0',trim(to_char(max(pr_estenose_pos),'99999999999990D99')))				
			into	ie_qca_w,
				qt_diametro_lum_pre_w,
				qt_diametro_ref_prox_pre_w,
				pr_estenose_pre_w,
				qt_diametro_lum_pos_w,
				qt_diametro_ref_prox_pos_w,
				pr_estenose_pos_w
			from	HEM_ATC_QUANT
			where	nr_seq_lesao = nr_seq_lesao_w;
			
			if	(ie_qca_w = 'S') then
				
				ds_quantitativa_w := '\par\viewkind4\uc1\pard\qj\cf1\fs24\tab\b '||obter_desc_expressao(700815)||'\tab\tab\tab\tab\b0'||obter_desc_expressao(305747)||'\tab\tab\ '||obter_desc_expressao(305724)||
										'\par\tab\fs12 ___________________________________________________________________________________\fs24'||
										'\par\tab\tab '||obter_desc_expressao(735240)||':\tab\tab '||lpad(qt_diametro_lum_pre_w,15,' ')||'\tab\ '||lpad(qt_diametro_lum_pos_w,15,' ')||
										'\par\tab\tab '||obter_desc_expressao(735242)||':\tab\tab '||lpad(qt_diametro_ref_prox_pre_w,15,' ')||'\tab\ '||lpad(qt_diametro_ref_prox_pos_w,15,' ')||
										'\par \pard\tab\tab '||obter_desc_expressao(713372)||':\tab\'||lpad(pr_estenose_pre_w,15,' ')||'\tab\ '||lpad(pr_estenose_pos_w,15,' ')||
										'\par\tab\fs12 ___________________________________________________________________________________\fs24'||
										'\par';--'			
				ds_caracteristica_w := ds_caracteristica_w || ds_quantitativa_w;						
			end if;
			
			
			
		end;
		
	end loop;
	close C00;
	
	select	max(replace(ds_observacao_laudo,chr(10),'\par '||chr(10)))
	into	ds_observacao_geral_w
	from	hem_observacao_laudo
	where	nr_seq_proc = nr_seq_proc_p;

	if	(ds_caracteristica_w <> ' ') then
			 
		select	'\viewkind4\uc1\pard\cf1\lang1046\b\fs24'|| UPPER(obter_desc_expressao(decode(qt_numeros_registros_w, 2, 788264, 788266))) ||'\b0'|| 
								'\par \pard\qj' || ds_caracteristica_w  || '\par \pard\qj '
		into	ds_caracteristica_w
		from	dual;
	end if;
	
	if	(ds_observacao_geral_w is not null) then
	
		ds_observacao_geral_w := '\i0 \par \pard\qj '||'\viewkind4\uc1\pard\cf1\lang1046\b\fs24 '|| UPPER(obter_desc_expressao(753406)) ||'\i0 \par \pard\qj '||'\b0 '|| 
								'\par \pard\qj ' || ds_observacao_geral_w  || '\par \pard\qj ';
	
	end if;
	ds_sql_w	:= ' update hem_proc set ds_laudo = DS_LAUDO where nr_sequencia  = '||nr_seq_proc_p;
	
	C001 := DBMS_SQL.OPEN_CURSOR;
	DBMS_SQL.PARSE(C001, ds_sql_w, dbms_sql.Native);
	DBMS_SQL.BIND_VARIABLE(C001, 'DS_LAUDO', ds_cabecalho_w || ds_caracteristica_w || ds_medic_agrup_w|| ds_conclusao_agrupada_w || ds_observacao_geral_w ||' }');
	retorno_w := DBMS_SQL.EXECUTE(c001);
	DBMS_SQL.CLOSE_CURSOR(C001);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hem_gerar_laudo_angioplastia ( nr_seq_proc_p bigint, nm_usuario_p text) FROM PUBLIC;

