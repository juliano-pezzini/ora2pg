-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_inspecao_cont_lote ( nr_seq_registro_p bigint, nr_seq_inspecao_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_material_w			bigint;
cd_estabelecimento_w		bigint	:= wheb_usuario_pck.get_cd_estabelecimento;

/*Primeira Contagem*/

cd_lote_fabricacao_um_w		varchar(20);
cd_barra_material_um_w          	varchar(40);
ds_barras_um_w                  		varchar(4000);
dt_fabricacao_um_w              		varchar(110);
dt_validade_um_w                		varchar(110);

ie_indeterminada_um_w           	varchar(1);
nr_seq_contagem_um_w            	bigint;
nr_seq_marca_um_w              	 	bigint;
ds_marca_um_w			varchar(255);
nr_sequencia_um_w               		bigint;
qt_material_um_w                		double precision;

/*Segunda Contagem*/

cd_lote_fabricacao_dois_w		varchar(20);
cd_barra_material_dois_w        	varchar(40);
ds_barras_dois_w                		varchar(4000);
dt_fabricacao_dois_w            		varchar(110);
dt_validade_dois_w              		varchar(110);

ie_indeterminada_dois_w         	varchar(1);
nr_seq_contagem_dois_w         	bigint;
nr_seq_marca_dois_w             	bigint;
ds_marca_dois_w            		varchar(255);
nr_sequencia_dois_w            	 	bigint;
qt_material_dois_w              		double precision;

ie_consiste_marca_insp_w		varchar(1);
qt_marca_nao_aprov_w		bigint;
cd_perfil_w			bigint;
ie_consiste_barras_DM_w		varchar(1);

ie_lote_gerado_segunda_cont_w	boolean := False;

/*Primeira Contagem*/

C01 CURSOR FOR
	SELECT	a.cd_lote_fabricacao,
	        	coalesce(a.ds_barras, wheb_mensagem_pck.get_texto(312793)) ds_barras,
	        	coalesce(to_char(a.dt_fabricacao, 'dd/mm/yyyy'), wheb_mensagem_pck.get_texto(312793)),
	        	coalesce(to_char(a.dt_validade, 'dd/mm/yyyy'), wheb_mensagem_pck.get_texto(312793)),
	        	coalesce(a.ie_indeterminada, wheb_mensagem_pck.get_texto(312793)) ie_indeterminada,
		substr(coalesce(obter_desc_marca(a.nr_seq_marca),wheb_mensagem_pck.get_texto(312793)),1,255) ds_marca,
	        	coalesce(a.nr_seq_marca,0) nr_seq_marca,
	        	coalesce(a.qt_material,0) qt_material
	from    	inspecao_receb_lote_cont a
	where   	a.nr_seq_contagem = ( 	SELECT  	max(x.nr_sequencia)
						from    	inspecao_contagem x
						where   	x.nr_seq_contagem = 1
						and     	x.nr_seq_inspecao = nr_seq_inspecao_p)
	order   by 1;

/*Segunda Contagem*/

C02 CURSOR FOR
	SELECT	coalesce(a.ds_barras, wheb_mensagem_pck.get_texto(312793)) ds_barras,
	        	coalesce(to_char(a.dt_fabricacao, 'dd/mm/yyyy'), wheb_mensagem_pck.get_texto(312793)),
	        	coalesce(to_char(a.dt_validade, 'dd/mm/yyyy'), wheb_mensagem_pck.get_texto(312793)),
	        	coalesce(a.ie_indeterminada, wheb_mensagem_pck.get_texto(312793)) ie_indeterminada,
		substr(coalesce(obter_desc_marca(a.nr_seq_marca),wheb_mensagem_pck.get_texto(312793)),1,255) ds_marca,
	        	coalesce(a.nr_seq_marca,0) nr_seq_marca,
	        	coalesce(a.qt_material,0) qt_material
	from    	inspecao_receb_lote_cont a
	where   	a.nr_seq_contagem = ( 	SELECT  	max(x.nr_sequencia)
						from    	inspecao_contagem x
						where   	x.nr_seq_contagem = 2
						and     	x.nr_seq_inspecao = nr_seq_inspecao_p)
	and	a.cd_lote_fabricacao = cd_lote_fabricacao_um_w
	order   by 1;

/*Segunda Contagem (Verifica se foi inspecionado o lote na segunda contagem, e na primeira nÃ£o) */

C03 CURSOR FOR
	SELECT	a.cd_lote_fabricacao
	from    inspecao_receb_lote_cont a
	where   a.nr_seq_contagem = ( 		SELECT	max(x.nr_sequencia)
						from    inspecao_contagem x
						where   x.nr_seq_contagem = 2
						and     x.nr_seq_inspecao = nr_seq_inspecao_p)
	and     a.cd_lote_fabricacao not in (	select  y.cd_lote_fabricacao
						from    inspecao_receb_lote_cont y
						where   y.nr_seq_contagem = (	select	x.nr_sequencia
										from    inspecao_contagem x
										where   x.nr_seq_contagem = 1
										and	x.nr_seq_inspecao = nr_seq_inspecao_p))
	order   by 1;


BEGIN

cd_perfil_w	:= obter_perfil_ativo;

begin
	select	max(cd_material)
	into STRICT	cd_material_w
	from   	inspecao_contagem
	where   	nr_seq_inspecao = nr_seq_inspecao_p;
exception when others then
	cd_material_w := 0;
end;

if (cd_material_w > 0) then
	begin

	select	coalesce((max(obter_valor_param_usuario(270, 71, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w))),'N'),
		coalesce((max(obter_valor_param_usuario(270, 88, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w))),'N')
	into STRICT	ie_consiste_marca_insp_w,
		ie_consiste_barras_DM_w
	;

	open C01;
	loop
	fetch C01 into
		cd_lote_fabricacao_um_w,
		ds_barras_um_w,
		dt_fabricacao_um_w,
		dt_validade_um_w,
		ie_indeterminada_um_w,
		ds_marca_um_w,
		nr_seq_marca_um_w,
		qt_material_um_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ie_lote_gerado_segunda_cont_w := False;

		if (nr_seq_marca_um_w <> 0) and (ie_consiste_marca_insp_w = 'S') then
			begin

			select	count(*)
			into STRICT	qt_marca_nao_aprov_w
			from	material_marca
			where	nr_sequencia = nr_seq_marca_um_w
			and	cd_material = cd_material_w
			and	nr_seq_status_aval > 0
			and	obter_tipo_status_aval_marca(nr_seq_status_aval) <> 'A';

			if (qt_marca_nao_aprov_w > 0) then
				CALL grava_inconsistencia_contagem( 	nr_seq_inspecao_p,
								cd_material_w,
								wheb_mensagem_pck.get_texto(312794), --ds_campo_p
								ds_marca_um_w, --ds_contagem_um_p
								'', --ds_contagem_dois_p
								'LMA',
								wheb_mensagem_pck.get_texto(312795,'CD_LOTE_FABRICACAO_UM_W='||cd_lote_fabricacao_um_w), --ds_consistencia_p,
								nm_usuario_p);
			end if;

			end;
		end if;

		open C02;
		loop
		fetch C02 into
			ds_barras_dois_w,
			dt_fabricacao_dois_w,
			dt_validade_dois_w,
		        	ie_indeterminada_dois_w,
			ds_marca_dois_w,
		        	nr_seq_marca_dois_w,
		        	qt_material_dois_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin



			if (ie_consiste_barras_DM_w = 'S') and (ds_barras_um_w <> ds_barras_dois_w) then
				CALL grava_inconsistencia_contagem( nr_seq_inspecao_p,
								cd_material_w,
								wheb_mensagem_pck.get_texto(312797), --ds_campo_p
								ds_barras_um_w,  --ds_contagem_um_p
								ds_barras_dois_w, --ds_contagem_dois_p
								'LBA',
								wheb_mensagem_pck.get_texto(312798,'CD_LOTE_FABRICACAO_UM_W='||cd_lote_fabricacao_um_w), --ds_consistencia_p,
								nm_usuario_p);
			end if;

			if (dt_fabricacao_um_w <> dt_fabricacao_dois_w) then
				CALL grava_inconsistencia_contagem(	nr_seq_inspecao_p,
								cd_material_w,
								wheb_mensagem_pck.get_texto(312800), --ds_campo_p
								dt_fabricacao_um_w, --ds_contagem_um_p
								dt_fabricacao_dois_w, --ds_contagem_dois_p
								'LDF',
								wheb_mensagem_pck.get_texto(312801,'CD_LOTE_FABRICACAO_UM_W='||cd_lote_fabricacao_um_w), --ds_consistencia_p,
								nm_usuario_p);
			end if;

			if (dt_validade_um_w <> dt_validade_dois_w) then
				CALL grava_inconsistencia_contagem( 	nr_seq_inspecao_p,
								cd_material_w,
								wheb_mensagem_pck.get_texto(312802), --ds_campo_p
								dt_validade_um_w, --ds_contagem_um_p
								dt_validade_dois_w, --ds_contagem_dois_p
								'LVA',
								wheb_mensagem_pck.get_texto(312804,'CD_LOTE_FABRICACAO_UM_W='||cd_lote_fabricacao_um_w), --ds_consistencia_p,
								nm_usuario_p);
			end if;

			if (ie_indeterminada_um_w <> ie_indeterminada_dois_w) then
				CALL grava_inconsistencia_contagem( 	nr_seq_inspecao_p,
								cd_material_w,
								wheb_mensagem_pck.get_texto(312805), --ds_campo_p
								ie_indeterminada_um_w, --ds_contagem_um_p
								ie_indeterminada_dois_w, --ds_contagem_dois_p
								'LIN',
								wheb_mensagem_pck.get_texto(312806,'CD_LOTE_FABRICACAO_UM_W='||cd_lote_fabricacao_um_w), --ds_consistencia_p,
								nm_usuario_p);
			end if;

			if (nr_seq_marca_um_w <> nr_seq_marca_dois_w) then
				CALL grava_inconsistencia_contagem( 	nr_seq_inspecao_p,
								cd_material_w,
								wheb_mensagem_pck.get_texto(312794), --ds_campo_p
								ds_marca_um_w, --ds_contagem_um_p
								ds_marca_dois_w, --ds_contagem_dois_p
								'LMA',
								wheb_mensagem_pck.get_texto(312811,'CD_LOTE_FABRICACAO_UM_W='||cd_lote_fabricacao_um_w), --ds_consistencia_p,
								nm_usuario_p);
			end if;

			if (qt_material_um_w <> qt_material_dois_w) then
				CALL grava_inconsistencia_contagem(	nr_seq_inspecao_p,
								cd_material_w,
								wheb_mensagem_pck.get_texto(312813), --ds_campo_p
								qt_material_um_w, --ds_contagem_um_p
								qt_material_dois_w, --ds_contagem_dois_p
								'LQE',
								wheb_mensagem_pck.get_texto(312814,'CD_LOTE_FABRICACAO_UM_W='||cd_lote_fabricacao_um_w), --ds_consistencia_p,
								nm_usuario_p);
			end if;

			if (nr_seq_marca_dois_w <> 0) and (ie_consiste_marca_insp_w = 'S') then
				begin

				select	count(*)
				into STRICT	qt_marca_nao_aprov_w
				from	material_marca
				where	nr_sequencia = nr_seq_marca_dois_w
				and	cd_material = cd_material_w
				and	nr_seq_status_aval > 0
				and	obter_tipo_status_aval_marca(nr_seq_status_aval) <> 'A';

				if (qt_marca_nao_aprov_w > 0) then
					CALL grava_inconsistencia_contagem( 	nr_seq_inspecao_p,
									cd_material_w,
									wheb_mensagem_pck.get_texto(312794), --ds_campo_p
									'', --ds_contagem_um_p
									ds_marca_dois_w, --ds_contagem_dois_p
									'LMA',
									wheb_mensagem_pck.get_texto(312815,'CD_LOTE_FABRICACAO_UM_W='||cd_lote_fabricacao_um_w), --ds_consistencia_p,
									nm_usuario_p);
				end if;

				end;
			end if;

			ie_lote_gerado_segunda_cont_w := True;

			end;
		end loop;
		close C02;

		if (not ie_lote_gerado_segunda_cont_w) then
			CALL grava_inconsistencia_contagem(	nr_seq_inspecao_p,
							cd_material_w,
							wheb_mensagem_pck.get_texto(312820), --ds_campo_p
							wheb_mensagem_pck.get_texto(312822), --ds_contagem_um_p
							wheb_mensagem_pck.get_texto(312821), --ds_contagem_dois_p
							'LGE',
							wheb_mensagem_pck.get_texto(312823,'CD_LOTE_FABRICACAO_UM_W='||cd_lote_fabricacao_um_w), --ds_consistencia_p,
							nm_usuario_p);
		end if;
		end;
	end loop;
	close C01;

	open C03;
	loop
	fetch C03 into
		cd_lote_fabricacao_dois_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin
		CALL grava_inconsistencia_contagem(	nr_seq_inspecao_p,
						cd_material_w,
						wheb_mensagem_pck.get_texto(312820), --ds_campo_p
						wheb_mensagem_pck.get_texto(312821), --ds_contagem_um_p
						wheb_mensagem_pck.get_texto(312822), --ds_contagem_dois_p
						'LNG',
						wheb_mensagem_pck.get_texto(312824,'CD_LOTE_FABRICACAO_DOIS_W='||cd_lote_fabricacao_dois_w), --ds_consistencia_p,
						nm_usuario_p);
		end;
	end loop;
	close C03;

	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_inspecao_cont_lote ( nr_seq_registro_p bigint, nr_seq_inspecao_p bigint, nm_usuario_p text) FROM PUBLIC;

