-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_ame_gerar_mensalidade_hrf ( nr_sequencia_p bigint, ds_local_p text, nm_arquivo_p text) AS $body$
DECLARE


ds_erro_w                    varchar(255);
ds_conteudo_w                varchar(4000);
nm_estipulante_w             varchar(255);
cd_estipulante_w             varchar(255);
arq_texto_w                  utl_file.file_type;
dt_ref_mensalidade_w         timestamp;
nr_seq_mensalidade_seg_w     integer;
nr_contrato_segurado_w       integer;
nr_seq_titular_w             integer;
qt_familia_w                 integer;
qt_titulares_w               integer;
qt_agregados_w               integer;
qt_dependentes_w             integer;
nr_seq_contrato_segurado_w   integer;
qt_emp_titulares_w           integer;
qt_emp_dependentes_w         integer;
qt_emp_agregados_w           integer;
qt_cont_titulares_w          integer;
qt_cont_dependentes_w        integer;
qt_cont_agregados_w          integer;
vl_mensalidade_w             double precision;
vl_coparticipacao_w          double precision;
vl_adicionais_w              double precision;
vl_emp_mensalidade_w         double precision;
vl_emp_coparticipacao_w      double precision;
vl_emp_adicionais_w          double precision;

vl_fam_mensalidade_w         double precision;
vl_fam_coparticipacao_w      double precision;
vl_fam_adicionais_w          double precision;

vl_cont_mensalidade_w        double precision;
vl_cont_coparticipacao_w     double precision;
vl_cont_adicionais_w         double precision;
cd_matricula_estipulante_tit_w  pls_segurado.cd_matricula_estipulante%type;
dt_limite_utilizacao_tit_w  timestamp;
dt_contratacao_tit_w    timestamp;
dt_rescisao_tit_w    timestamp;
qt_idade_tit_w      integer;
ds_parentesco_tit_w    varchar(255);
cd_matricula_estipulante_w  pls_segurado.cd_matricula_estipulante%type;
ie_tipo_parentesco_w    varchar(2);
dt_limite_utilizacao_w    timestamp;
dt_contratacao_w    timestamp;
dt_rescisao_w      timestamp;
qt_idade_w      integer;
ds_parentesco_w      varchar(255);

C01 CURSOR FOR
 SELECT b.nr_contrato                                    nr_contrato_segurado,
         pls_obter_dados_contrato(b.nr_sequencia_con,'E') nm_estipulante,
         pls_obter_dados_contrato(b.nr_sequencia_con,'C') cd_estipulante
    from pls_ame_lote_rem_valor a,
        (SELECT  max(x.nr_sequencia) nr_sequencia_con,
                 max(x.nr_contrato)  nr_contrato,
                 y.nr_sequencia
           from  pls_contrato  x,
                 pls_segurado  y
          where  x.nr_sequencia  = y.nr_seq_contrato
                group by y.nr_sequencia) b
   where  a.nr_seq_lote_rem_arq = nr_sequencia_p
     and  a.nr_seq_segurado     = b.nr_sequencia
       group by b.nr_contrato,
             b.nr_sequencia_con
   order by 1;

C02 CURSOR FOR
  SELECT   nr_seq_mensalidade_seg,
    b.nr_contrato nr_seq_contrato_segurado,
    dt_ref_mensalidade
  from   pls_ame_lote_rem_valor a,
    (SELECT max(x.nr_contrato) nr_contrato,
      y.nr_sequencia
    from   pls_contrato    x,
      pls_segurado    y
    where   x.nr_sequencia  = y.nr_seq_contrato
                group by y.nr_sequencia) b,
    pls_ame_lote_rem_arquivo c,
    pls_ame_lote_rem_destino d,
    pls_ame_lote_remessa  e
  where   a.nr_seq_lote_rem_arq   = nr_sequencia_p
        and   a.nr_seq_segurado       = b.nr_sequencia
  and  c.nr_sequencia = a.nr_seq_lote_rem_arq
  and  c.nr_seq_lote_rem_dest = d.nr_sequencia
  and  d.nr_seq_lote_rem = e.nr_sequencia
        and   b.nr_contrato           = nr_contrato_segurado_w
        and   coalesce(a.nr_seq_titular::text, '') = '';

C03 CURSOR FOR
  SELECT   d.nr_seq_segurado,
    trim(both to_char(pls_obter_dados_segurado(d.nr_seq_segurado,'C'),'99999G000000G000000G00')) carteirinha,
    pls_obter_dados_segurado(d.nr_seq_segurado,'N') nm_segurado,
    regexp_replace(lpad(pls_obter_dados_segurado(d.nr_seq_segurado,'CPF'), 11, '0'), '([0-9]{3})([0-9]{3})([0-9]{3})([0-9]{2})','\1.\2.\3-\4') cd_cpf,
    pls_obter_dados_segurado(d.nr_seq_segurado,'P') ds_plano,
    case when coalesce(d.nr_seq_titular::text, '') = '' then 'T' else 'D' end ie_tipo_segurado,
    'Não Informado' ds_lotacao,
    Obter_Valor_Dominio(1930,a.ie_tipo_item) item,
    to_char(case when a.ie_tipo_item = 1 then a.vl_detalhe else 0 end,'99G990D99') vl_mensalidade,
    --to_char(a.vl_detalhe) vl_mensalidade,
    to_char(case when a.ie_tipo_item = 3 then a.vl_detalhe else 0 end,'99G990D99') vl_coparticipacao,
    to_char(case when a.ie_tipo_item not in (1,3) then a.vl_detalhe else 0 end,'99G990D99') vl_adicionais,
    pls_obter_dados_segurado(d.nr_seq_segurado,'ID')   qt_idade,
    obter_desc_grau_parentesco(seg.nr_seq_parentesco) ds_parentesco,
    to_date(seg.dt_limite_utilizacao,'dd/mm/yyyy') dt_limite,
    to_date(seg.dt_contratacao,'dd/mm/yyyy') dt_inclusao,
    to_date(seg.dt_rescisao,'dd/mm/yyyy') dt_rescisao
  from    pls_ame_lote_rem_valor     d,
          pls_ame_lote_rem_valor_det  a,
          pls_segurado                seg
  where   d.nr_sequencia = a.nr_seq_lote_rem_valor
    and seg.nr_sequencia = d.nr_seq_segurado
  and  d.nr_seq_mensalidade_seg  = nr_seq_mensalidade_seg_w
  and  d.nr_seq_lote_rem_arq = nr_sequencia_p
  and   coalesce(d.nr_seq_titular::text, '') = '';

C04 CURSOR FOR
  SELECT d.nr_seq_segurado,
         trim(both to_char(pls_obter_dados_segurado(d.nr_seq_segurado,'C'),'99999G000000G000000G00')) carteirinha,
         pls_obter_dados_segurado(d.nr_seq_segurado,'N') nm_segurado,
         regexp_replace(lpad(pls_obter_dados_segurado(d.nr_seq_segurado,'CPF'), 11, '0'), '([0-9]{3})([0-9]{3})([0-9]{3})([0-9]{2})','\1.\2.\3-\4') cd_cpf,
         pls_obter_dados_segurado(d.nr_seq_segurado,'P') ds_plano,
         'Não Informado' ds_lotacao,
         Obter_Valor_Dominio(1930,a.ie_tipo_item) item,
         to_char(case when a.ie_tipo_item = 1 then a.vl_detalhe else 0 end,'99G990D99') vl_mensalidade,
         case when coalesce(seg.ie_tipo_parentesco, 1) = 1 then 'D' else 'A' end ie_tipo_segurado,
    --to_char(a.vl_detalhe) vl_mensalidade,
         to_char(case when a.ie_tipo_item = 3 then a.vl_detalhe else 0 end,'99G990D99') vl_coparticipacao,
         to_char(case when a.ie_tipo_item not in (1,3) then a.vl_detalhe else 0 end,'99G990D99') vl_adicionais,
         pls_obter_dados_segurado(d.nr_seq_segurado,'ID')   qt_idade,
         obter_desc_grau_parentesco(seg.nr_seq_parentesco) ds_parentesco,
         to_date(seg.dt_limite_utilizacao,'dd/mm/yyyy') dt_limite,
         to_date(seg.dt_contratacao,'dd/mm/yyyy') dt_inclusao,
         to_date(seg.dt_rescisao,'dd/mm/yyyy') dt_rescisao

    from pls_ame_lote_rem_valor        d,
         pls_ame_lote_rem_valor_det    a,
         pls_segurado                  seg
   where d.nr_sequencia        = a.nr_seq_lote_rem_valor
     and seg.nr_sequencia      = d.nr_seq_segurado
     and d.nr_seq_lote_rem_arq = nr_sequencia_p
     and d.nr_seq_titular      = nr_seq_titular_w;

c05 CURSOR FOR
  SELECT
  distinct  '' nr_segurado,
    '' carteirinha,
    '' nm_segurado,
    '' cd_matricula,
    '' cd_cpf,
    '' ds_plano,
    '' ie_tipo_segurado,
    '' dt_limite,
    '' dt_inclusao,
    '' dt_rescisao,
    '' ds_lotacao,
    'DEVOLUÇÕES EXCLUSÕES E OUTROS LANÇAMENTO PAGADOR' item,
    '' vl_mensalidade, -
    '' vl_coparticipacao,
    men.vl_outros vl_adicionais, --sum(to_char(case when g.ie_tipo_item not in (1,3) then g.vl_item else 0 end,'99G990D99')) vl_adicionais,
    '' qt_idade,
    '' ds_parentesco
        from   pls_segurado                e,
    pls_ame_lote_rem_valor      d,
    pls_ame_lote_rem_arquivo    c,
    pls_ame_lote_rem_destino    b,
    pls_ame_lote_remessa        a,
    pls_mensalidade_segurado    f,
    pls_mensalidade_seg_item     g,
    pls_contrato                 h,
    pls_mensalidade              men
        where   a.nr_sequencia             = b.nr_seq_lote_rem
        and   b.nr_sequencia             = c.nr_seq_lote_rem_dest
        and   c.nr_sequencia             = d.nr_seq_lote_rem_arq
        and   e.nr_sequencia             = d.nr_seq_segurado
        and   g.nr_seq_mensalidade_seg   = d.nr_seq_mensalidade_seg
        and   g.ie_tipo_mensalidade      = 'P'
        and   h.nr_sequencia             = e.nr_seq_contrato
        and   h.nr_contrato              = nr_contrato_segurado_w
        and   g.nr_seq_mensalidade_seg   = f.nr_sequencia
        and men.nr_sequencia             = f.nr_seq_mensalidade
        and   d.nr_seq_lote_rem_arq      = nr_sequencia_p;
BEGIN

begin
select   c.dt_ref_mensalidade
into STRICT   dt_ref_mensalidade_w
from   pls_ame_lote_rem_arquivo   a,
        pls_ame_lote_rem_destino   b,
        pls_ame_lote_remessa        c
where   a.nr_seq_lote_rem_dest     = b.nr_sequencia
and   b.nr_seq_lote_rem          = c.nr_sequencia
and   a.nr_sequencia             = nr_sequencia_p;
exception
when others then
  CALL wheb_mensagem_pck.exibir_mensagem_abort(359678);
end;

begin
arq_texto_w := utl_file.fopen(ds_local_p,nm_arquivo_p,'W');
exception
when others then
  if (SQLSTATE = -29289) then
    ds_erro_w  := 'O acesso ao arquivo foi negado pelo sistema operacional (access_denied).';
  elsif (SQLSTATE = -29298) then
    ds_erro_w  := 'O arquivo foi aberto usando FOPEN_NCHAR,  mas efetuaram-se operações de I/O usando funções nonchar comos PUTF ou GET_LINE (charsetmismatch).';
  elsif (SQLSTATE = -29291) then
    ds_erro_w  := 'Não foi possível apagar o arquivo (delete_failed).';
  elsif (SQLSTATE = -29286) then
    ds_erro_w  := 'Erro interno desconhecido no package UTL_FILE (internal_error).';
  elsif (SQLSTATE = -29282) then
    ds_erro_w  := 'O handle do arquivo não existe (invalid_filehandle).';
  elsif (SQLSTATE = -29288) then
    ds_erro_w  := 'O arquivo com o nome especificado não foi encontrado neste local (invalid_filename).';
  elsif (SQLSTATE = -29287) then
    ds_erro_w  := 'O valor de MAX_LINESIZE para FOPEN() é inválido; deveria estar na faixa de 1 a 32767 (invalid_maxlinesize).';
  elsif (SQLSTATE = -29281) then
    ds_erro_w  := 'O parâmetro open_mode na chamda FOPEN é inválido (invalid_mode).';
  elsif (SQLSTATE = -29290) then
    ds_erro_w  := 'O parâmetro ABSOLUTE_OFFSET para a chamada FSEEK() é inválido; deveria ser maior do que 0 e menor do que o número total de bytes do arquivo (invalid_offset).';
  elsif (SQLSTATE = -29283) then
    ds_erro_w  := 'O arquivo não pôde ser aberto ou operado da forma desejada - ou o caminho não foi encontrado (invalid_operation).';
  elsif (SQLSTATE = -29280) then
    ds_erro_w  := 'O caminho especificado não existe ou não está visível ao Oracle (invalid_path).';
  elsif (SQLSTATE = -29284) then
    ds_erro_w  := 'Não é possível efetuar a leitura do arquivo (read_error).';
  elsif (SQLSTATE = -29292) then
    ds_erro_w  := 'Não é possível renomear o arquivo.';
  elsif (SQLSTATE = -29285) then
    ds_erro_w  := 'Não foi possível gravar no arquivo (write_error).';
  else
    ds_erro_w  := 'Erro desconhecido no package UTL_FILE.';
  end if;
end;
if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
  CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_erro_w);
end if;

vl_cont_mensalidade_w      := 0;
vl_cont_coparticipacao_w    := 0;
vl_cont_adicionais_w      := 0;
qt_cont_titulares_w        := 0;
qt_cont_dependentes_w      := 0;
qt_cont_agregados_w        := 0;

ds_conteudo_w    := 'Demonstrativo Analítico Faturamento';
utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));

ds_conteudo_w    := 'Mensalidade - '||formatar_data_mascara(dt_ref_mensalidade_w,'mm/yyyy');
utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
utl_file.put_line(arq_texto_w,'' || chr(13));
utl_file.put_line(arq_texto_w,'' || chr(13));

utl_file.fflush(arq_texto_w);

for r_c01_w in C01 loop
  begin
  nr_contrato_segurado_w  := r_c01_w.nr_contrato_segurado;
  nm_estipulante_w    := r_c01_w.nm_estipulante;
  cd_estipulante_w    := r_c01_w.cd_estipulante;
  ds_conteudo_w    := 'Contrato:'||to_char(nr_contrato_segurado_w,'000000')||' - '||nm_estipulante_w||'#'||
      formatar_data_mascara(dt_ref_mensalidade_w,'dd/mm/yyyy')||' a '||formatar_data_mascara(last_day(dt_ref_mensalidade_w),'dd/mm/yyyy');
  utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
  utl_file.put_line(arq_texto_w,'' || chr(13));
  ds_conteudo_w    := 'Empresa: '||cd_estipulante_w||' - '||nm_estipulante_w;

  utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
  ds_conteudo_w    := 'Código#Beneficiário#Matrícula#CPF#Plano#Tipo#Idade#Dependência#Data Limite#Data Inclusão#Data Exclusão#Lotacao'||
      '#LCAT#Rubrica#Coparticipação#Outros#PIAC#Mensalidade';
  utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
  qt_emp_titulares_w      := 0;
  qt_emp_dependentes_w    := 0;
  qt_emp_agregados_w      := 0;
  vl_emp_mensalidade_w    := 0;
  vl_emp_coparticipacao_w := 0;
  vl_emp_adicionais_w     := 0;

  for r_c02_w in C02 loop
    begin
    nr_seq_mensalidade_seg_w     := r_c02_w.nr_seq_mensalidade_seg;
    nr_seq_contrato_segurado_w   := r_c02_w.nr_seq_contrato_segurado;
    qt_titulares_w          := 0;
    vl_mensalidade_w        := 0;
    vl_coparticipacao_w     := 0;
    vl_adicionais_w         := 0;

    for r_c03_w in C03 loop
      begin
      select  cd_matricula_estipulante,
        dt_limite_utilizacao,
        dt_contratacao,
        dt_rescisao,
        pls_obter_idade_segurado(nr_sequencia,r_c02_w.dt_ref_mensalidade,'A'),
        obter_desc_grau_parentesco(nr_seq_parentesco)
      into STRICT  cd_matricula_estipulante_tit_w,
        dt_limite_utilizacao_tit_w,
        dt_contratacao_tit_w,
        dt_rescisao_tit_w,
        qt_idade_tit_w,
        ds_parentesco_tit_w
      from  pls_segurado
      where  nr_sequencia = r_c03_w.nr_seq_segurado;

      if (coalesce(r_c03_w.vl_mensalidade,0) <> 0) then
        qt_titulares_w  := qt_titulares_w + 1;
        qt_familia_w    := 1;
      end if;

      vl_mensalidade_w       := vl_mensalidade_w + r_c03_w.vl_mensalidade;
      vl_coparticipacao_w    := vl_coparticipacao_w + r_c03_w.vl_coparticipacao;
      vl_adicionais_w        := vl_adicionais_w + r_c03_w.vl_adicionais;
      ds_conteudo_w          := r_c03_w.carteirinha||'#'||r_c03_w.nm_segurado||'#'||cd_matricula_estipulante_tit_w||'#'||r_c03_w.cd_cpf||'#'||
            r_c03_w.ds_plano||'#'||r_c03_w.ie_tipo_segurado||'#'||r_c03_w.qt_idade||'#'||r_c03_w.ds_parentesco||'#'||
            r_c03_w.dt_limite||'#'||r_c03_w.dt_inclusao||'#'||r_c03_w.dt_rescisao||'#'||r_c03_w.ds_lotacao||'#'||'' ||'#'||
            r_c03_w.item||'#'||trim(both r_c03_w.vl_coparticipacao)||'#'||trim(both r_c03_w.vl_adicionais)||'#'|| '0,00' ||'#'||trim(both r_c03_w.vl_mensalidade);

      utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
      utl_file.fflush(arq_texto_w);
      nr_seq_titular_w    := r_c03_w.nr_seq_segurado;
      qt_dependentes_w    := 0;
      qt_agregados_w      := 0;
      end;
    end loop;

    for r_c04_w in C04 loop
      begin
      select  cd_matricula_estipulante,
        ie_tipo_parentesco,
        dt_limite_utilizacao,
        dt_contratacao,
        dt_rescisao,
        pls_obter_idade_segurado(nr_sequencia,r_c02_w.dt_ref_mensalidade,'A'),
        obter_desc_grau_parentesco(nr_seq_parentesco) ds_parentesco
      into STRICT  cd_matricula_estipulante_w,
        ie_tipo_parentesco_w,
        dt_limite_utilizacao_w,
        dt_contratacao_w,
        dt_rescisao_w,
        qt_idade_w,
        ds_parentesco_w
      from  pls_segurado
      where  nr_sequencia = r_c04_w.nr_seq_segurado;

      if (coalesce(r_c04_w.vl_mensalidade,0) <> 0) then
        if (ie_tipo_parentesco_w = 'D') then
          qt_dependentes_w  := qt_dependentes_w + 1;
        elsif (ie_tipo_parentesco_w = 'A') then
          qt_agregados_w    := qt_agregados_w + 1;
        end if;
        qt_familia_w    := qt_familia_w + 1;
      end if;

      vl_mensalidade_w      := vl_mensalidade_w   + r_c04_w.vl_mensalidade;
      vl_coparticipacao_w   := vl_coparticipacao_w   + r_c04_w.vl_coparticipacao;
      vl_adicionais_w       := vl_adicionais_w   + r_c04_w.vl_adicionais;

      ds_conteudo_w         := r_c04_w.carteirinha||'#'||r_c04_w.nm_segurado||'#'||cd_matricula_estipulante_w||'#'||r_c04_w.cd_cpf||'#'||
              r_c04_w.ds_plano||'#'||r_c04_w.ie_tipo_segurado||'#'||r_c04_w.qt_idade||'#'||r_c04_w.ds_parentesco||'#'||
              r_c04_w.dt_limite||'#'||r_c04_w.dt_inclusao||'#'||r_c04_w.dt_rescisao||'#'||r_c04_w.ds_lotacao||'#'||'' ||'#'||
              r_c04_w.item||'#'||trim(both r_c04_w.vl_coparticipacao)||'#'||trim(both r_c04_w.vl_adicionais)||'#'|| '0,00' ||'#'|| trim(both r_c04_w.vl_mensalidade);
      utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
      utl_file.fflush(arq_texto_w);
            end;
    end loop;

    qt_emp_titulares_w       := qt_emp_titulares_w + qt_titulares_w;
    qt_emp_dependentes_w     := qt_emp_dependentes_w + qt_dependentes_w;
    qt_emp_agregados_w       := qt_emp_agregados_w +  qt_agregados_w;
    vl_emp_mensalidade_w     := vl_emp_mensalidade_w + vl_mensalidade_w;
    vl_emp_coparticipacao_w  := vl_emp_coparticipacao_w + vl_coparticipacao_w;
    vl_emp_adicionais_w      := vl_emp_adicionais_w  + vl_adicionais_w;

    vl_fam_mensalidade_w     := vl_fam_mensalidade_w    + vl_mensalidade_w;
    vl_fam_coparticipacao_w  := vl_fam_coparticipacao_w + vl_coparticipacao_w;
    vl_fam_adicionais_w      := vl_fam_adicionais_w     +   vl_adicionais_w;

    utl_file.put_line(arq_texto_w,'' || chr(13));
    utl_file.fflush(arq_texto_w);
    ds_conteudo_w  := 'Total Familia ('||trim(both to_char(nr_seq_contrato_segurado_w,'000000'))||'):#Titulares: '||to_char(qt_titulares_w)||'#Dependentes: '||to_char(qt_dependentes_w)||
        '#Agregados: '||to_char(qt_agregados_w)||'###########'||trim(both coalesce(to_char(vl_fam_coparticipacao_w,'99G990D99'),'0'))||'#'||
      trim(both coalesce(to_char(vl_fam_adicionais_w,'99G990D99'),'0'))||'#'||'0,00'||'#'||trim(both coalesce(to_char(vl_fam_mensalidade_w,'99G990D99'),'0'));
    utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
--    utl_file.put_line(arq_texto_w,'' || chr(13));
    utl_file.fflush(arq_texto_w);

    vl_fam_mensalidade_w     := 0;
    vl_fam_coparticipacao_w  := 0;
    vl_fam_adicionais_w      := 0;

    end;

/*    utl_file.put_line(arq_texto_w,'' || chr(13));
    utl_file.fflush(arq_texto_w);
    ds_conteudo_w  := 'Total Familia ('||trim(to_char(nr_seq_contrato_segurado_w,'000000'))||'):#Titulares: '||qt_titulares_w||'#Dependentes: '||qt_dependentes_w||
        '#Agregados: '||qt_agregados_w||'###########'||trim(to_char(vl_emp_coparticipacao_w,'99G990D99'))||'#'||
      trim(to_char(vl_emp_adicionais_w,'99G990D99'))||'#'||'0,00'||'#'||trim(to_char(vl_emp_mensalidade_w,'99G990D99'));
    utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
--    utl_file.put_line(arq_texto_w,'' || chr(13));
    utl_file.fflush(arq_texto_w);
    end;    */
     ds_conteudo_w := 'Total Empresa ():#Titulares: '||to_char(qt_emp_titulares_w)||'#Dependentes: '||to_char(qt_emp_dependentes_w)||
      '#Agregados: '||to_char(qt_emp_agregados_w)||'###########'||trim(both coalesce(to_char(vl_emp_coparticipacao_w,'99G990D99'),'0'))||'#'||
      trim(both coalesce(to_char(vl_emp_adicionais_w,'99G990D99'),'0'))||'#'||'0,00'||'#'||/*trim(both coalesce(to_char(*/vl_emp_mensalidade_w/*,'99G990D99'),'0'));*/;
  utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
  utl_file.put_line(arq_texto_w,'' || chr(13));
  utl_file.fflush(arq_texto_w);
--  end;
  end loop;

  for r_c05_w in C05 loop
    begin
    ds_conteudo_w   := r_c05_w.carteirinha||'#'||r_c05_w.nm_segurado||'#'||r_c05_w.cd_matricula||'#'||r_c05_w.cd_cpf||'#'||
              r_c05_w.ds_plano||'#'||r_c05_w.ie_tipo_segurado||'#'||r_c05_w.qt_idade||'#'||r_c05_w.ds_parentesco||'#'||
              r_c05_w.dt_limite||'#'||r_c05_w.dt_inclusao||'#'||r_c05_w.dt_rescisao||'#'||r_c05_w.ds_lotacao||'#'||'' ||'#'||
              r_c05_w.item||'#'||trim(both r_c05_w.vl_coparticipacao)||'#'||trim(both r_c05_w.vl_adicionais)||'#'|| '0,00' ||'#'||trim(both r_c05_w.vl_mensalidade);

    utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
    utl_file.fflush(arq_texto_w);
    end;
  end loop;

  utl_file.put_line(arq_texto_w,' ' || chr(13));
  utl_file.fflush(arq_texto_w);

  vl_cont_mensalidade_w    := vl_cont_mensalidade_w + vl_emp_mensalidade_w;
  vl_cont_coparticipacao_w   := vl_cont_coparticipacao_w + vl_emp_coparticipacao_w;
  vl_cont_adicionais_w       := vl_cont_adicionais_w + vl_emp_adicionais_w;
  qt_cont_titulares_w        := qt_cont_titulares_w + qt_emp_titulares_w;
  qt_cont_dependentes_w      := qt_cont_dependentes_w + qt_emp_dependentes_w;
  qt_cont_agregados_w        := qt_cont_agregados_w + qt_emp_agregados_w;

     ds_conteudo_w := 'Total Empresa ():#Titulares: '||to_char(qt_emp_titulares_w)||'#Dependentes: '||to_char(qt_emp_dependentes_w)||
      '#Agregados: '||to_char(qt_emp_agregados_w)||'###########'||trim(both to_char(vl_emp_coparticipacao_w,'99G990D99'))||'#'||
      trim(both to_char(vl_emp_adicionais_w,'99G990D99'))||'#'||'0,00'||'#'||/*trim(both to_char(*/vl_emp_mensalidade_w/*,'99G990D99'));*/;
  utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
  utl_file.put_line(arq_texto_w,'' || chr(13));
  utl_file.fflush(arq_texto_w);
  end;

end loop;

ds_conteudo_w  := 'Total Contrato ():#Titulares: '||qt_cont_titulares_w||'#Dependentes: '||qt_cont_dependentes_w||
    '#Agregados: '||qt_cont_agregados_w||'###########'||trim(both to_char(vl_cont_coparticipacao_w,'99G990D99'))||'#'||
    trim(both to_char(vl_cont_adicionais_w,'99G990D99'))||'#'||'0,00'||'#'||/*trim(both to_char(*/vl_cont_mensalidade_w/*,'99G990D99'))*/;
utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
utl_file.put_line(arq_texto_w,'' || chr(13));
utl_file.fflush(arq_texto_w);

utl_file.fclose(arq_texto_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ame_gerar_mensalidade_hrf ( nr_sequencia_p bigint, ds_local_p text, nm_arquivo_p text) FROM PUBLIC;

