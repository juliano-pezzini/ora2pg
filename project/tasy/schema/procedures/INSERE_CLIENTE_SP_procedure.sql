-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insere_cliente_sp ( nr_seq_os_p text, cd_service_pack_p text, cd_cnpj_p text, cd_versao_p text, ds_hotfix_p text, nr_pacote_p text, ie_insert_p text, ds_racional_p text default null) AS $body$
DECLARE


ds_destinatario varchar(400);
ds_subject_w varchar(4000);
ds_text_w varchar(4000);
cd_funcao_w varchar(300);
ds_descricao_w varchar(4000);
ds_customer_w varchar(300);
ie_classificacao_w varchar(1);
NR_SEQ_OS_ORIGEM_TESTE_w	bigint;

c_alt CURSOR FOR SELECT mos.cd_funcao, mos.ds_dano_breve DS_ALTERACAO
      from man_ordem_servico mos
      where mos.nr_sequencia = nr_seq_os_p;

row_alt c_alt%rowtype;


BEGIN

  begin
    select ie_classificacao
    into STRICT ie_classificacao_w
    from man_service_pack_versao
    where cd_versao = cd_versao_p
      and coalesce(ds_hotfix, '0') = coalesce(ds_hotfix_p, '0')
      and nr_service_pack = cd_service_pack_p
      and (ie_classificacao IS NOT NULL AND ie_classificacao::text <> '');
    exception
    when no_data_found then
    begin
      ie_classificacao_w := 'S';
    end;
  end;

  begin
    ds_descricao_w := '';
    open c_alt;
    loop
      fetch c_alt into row_alt;
      EXIT WHEN NOT FOUND; /* apply on c_alt */
      cd_funcao_w := row_alt.cd_funcao;
      ds_descricao_w := row_alt.ds_alteracao;
    end loop;

    close c_alt;

    exception
      when no_data_found then
      begin
        cd_funcao_w := null;
        ds_descricao_w := null;
      end;
  end;

  ds_subject_w := Wheb_Mensagem_Pck.Get_Texto(1147267);
  ds_subject_w := replace(ds_subject_w,'@#SP@#',cd_service_pack_p);
  ds_subject_w := replace(ds_subject_w,'@#VERSAO@#',cd_versao_p);

	select	max(a.NR_SEQ_OS_ORIGEM_TESTE)
	into STRICT	NR_SEQ_OS_ORIGEM_TESTE_w
	from	regra_cliente_os_sp a,
			regra_versao_pacote_sp b
	where	b.nr_sequencia = a.NR_SEQ_RGR_VER_PAC
	and		b.cd_versao = cd_versao_p
	and		a.cd_cnpj = cd_cnpj_p
	and		a.nr_seq_os = nr_seq_os_p;
	
    DS_TEXT_W := Wheb_Mensagem_Pck.Get_Texto(1168941);
    DS_TEXT_W := REPLACE(DS_TEXT_W, '#@NR_SERVICE_PACK_P#@', cd_service_pack_p);
    DS_TEXT_W := REPLACE(DS_TEXT_W, '#@NR_SEQ_OS_ORIGEM_TESTE_P#@', NR_SEQ_OS_ORIGEM_TESTE_w);	

	if (ie_insert_p = 'L') then

		insert into MAN_ORDEM_SERV_TECNICO(NR_SEQUENCIA,
						  NR_SEQ_ORDEM_SERV,
						  DT_ATUALIZACAO,
						  NM_USUARIO,
						  DT_HISTORICO,
						  DT_LIBERACAO,
						  NR_SEQ_TIPO,
						  IE_ORIGEM,
						  DS_RELAT_TECNICO)
						  values (nextval('man_ordem_serv_tecnico_seq'),
						  NR_SEQ_OS_P,
						  clock_timestamp(), 
						  'Tasy', 
						  clock_timestamp(),
						  clock_timestamp(),
						  7,
						  'I',
						  DS_TEXT_W);
						
		commit;
		
	end if;

  if (ie_insert_p = 'L') then
    begin

      update regra_cliente_os_sp set
      dt_liberacao = clock_timestamp(),
      ds_racional = ds_racional_p
      where nr_seq_os = nr_seq_os_p
      and cd_cnpj = cd_cnpj_p;

      ds_subject_w := replace(ds_subject_w,'@#IETIPO@#', Wheb_Mensagem_Pck.Get_Texto(1147273));

    end;
  else
    begin
        update regra_cliente_os_sp set
        dt_liberacao  = NULL,
        ds_racional = ds_racional_p
        where nr_seq_os = nr_seq_os_p
        and cd_cnpj = cd_cnpj_p;
        ds_subject_w := replace(ds_subject_w,'@#IETIPO@#', Wheb_Mensagem_Pck.Get_Texto(1147275));
    end;
  end if;

  case ie_classificacao_w
    when 'D' then ds_subject_w := ds_subject_w || ' - ' || Expressao_Pck.Obter_Desc_Expressao(308397);
    when 'S' then ds_subject_w := ds_subject_w || ' - ' || Expressao_Pck.Obter_Desc_Expressao(327907);
    when 'I' then ds_subject_w := ds_subject_w || ' - ' || Expressao_Pck.Obter_Desc_Expressao(492381);
    else ds_subject_w := ds_subject_w;
  end case;

  ds_destinatario := 'grp_build_html5_ci@Philips.onmicrosoft.com, expedition.informatics@philips.com, Johnny.Fusinato@philips.com, LucasSandroRotermel.Franco@philips.com, Andrew.Mikos@philips.com, juan.almeida@philips.com, rafael.correa@philips.com';

  if (cd_funcao_w IS NOT NULL AND cd_funcao_w::text <> '' AND ds_descricao_w IS NOT NULL AND ds_descricao_w::text <> '') then
    ds_customer_w := substr( obter_nome_pj(cd_cnpj_p),1,120) || ' - ' || cd_cnpj_p;
    if (ie_insert_p = 'L') then
      ds_text_w := Wheb_Mensagem_Pck.Get_Texto(1150566);
    else
      ds_text_w := Wheb_Mensagem_Pck.Get_Texto(1150912);
    end if;
    ds_text_w := replace(ds_text_w, '@#CLIENTE@#', ds_customer_w);
    ds_text_w := ds_text_w || chr(13) || chr(10) ||
            'SO: ' || nr_seq_os_p || chr(13) || chr(10) ||
            'Function: ' || obter_nome_funcao(cd_funcao_w) || chr(13) || chr(10) ||
            'Description: ' ||  ds_descricao_w || chr(13) || chr(10) ||
            'Customer: ' || ds_customer_w;
  end if;

  if (ds_subject_w IS NOT NULL AND ds_subject_w::text <> '' AND ds_text_w IS NOT NULL AND ds_text_w::text <> '') then
      CALL enviar_email(ds_subject_w, ds_text_w, 'support.informatics@philips.com', ds_destinatario,'Tasy',null);
  end if;

  commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insere_cliente_sp ( nr_seq_os_p text, cd_service_pack_p text, cd_cnpj_p text, cd_versao_p text, ds_hotfix_p text, nr_pacote_p text, ie_insert_p text, ds_racional_p text default null) FROM PUBLIC;

