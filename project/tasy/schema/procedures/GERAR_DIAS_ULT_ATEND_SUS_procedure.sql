-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_dias_ult_atend_sus (nr_atendimento_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
nr_atendimento_ant_w			bigint;
nr_laudo_sus_w				smallint;
ie_origem_proced_w			bigint;
ie_probabilidade_alta_w			varchar(3);
ie_gerar_prev_alta_w			varchar(1);
cd_procedimento_w			bigint;
cd_pessoa_fisica_w			varchar(15);
qt_dias_internacao_sus_w		integer	:= 0;
dt_entrada_w				timestamp;


BEGIN 
 
select max(ie_gerar_prev_alta) 
into STRICT	ie_gerar_prev_alta_w 
from	parametro_atendimento 
where	cd_estabelecimento = cd_estabelecimento_p;
 
if (ie_gerar_prev_alta_w = 'S') then 
	select max(ie_probabilidade_alta) 
	into STRICT	ie_probabilidade_alta_w 
	from	parametro_atendimento 
	where	cd_estabelecimento = cd_estabelecimento_p;
	 
	if (ie_probabilidade_alta_w IS NOT NULL AND ie_probabilidade_alta_w::text <> '') then 
		 
		select 	max(cd_pessoa_fisica), 
			max(dt_entrada) 
		into STRICT	cd_pessoa_fisica_w, 
			dt_entrada_w 
		from	atendimento_paciente 
		where	nr_atendimento = nr_atendimento_p;
 
		select	max(nr_atendimento) 
		into STRICT	nr_atendimento_ant_w 
		from	atendimento_paciente 
		where	ie_tipo_atendimento in (3,8) 
		and	ie_tipo_convenio = 3 
		and	cd_pessoa_fisica = cd_pessoa_fisica_w 
		and	nr_atendimento <> nr_atendimento_p;
 
		if (coalesce(nr_atendimento_ant_w,0) > 0) then 
			select max(nr_laudo_sus) 
			into STRICT  nr_laudo_sus_w 
			from  sus_laudo_paciente 
			where nr_atendimento = nr_atendimento_ant_w;
			 
			if (coalesce(nr_laudo_sus_w,0) > 0) then 
			 
				select	max(cd_procedimento_solic), 
					max(coalesce(ie_origem_proced,1)) 
				into STRICT	cd_procedimento_w, 
					ie_origem_proced_w 
				from	sus_laudo_paciente 
				where  nr_laudo_sus = nr_laudo_sus_w 
				and	nr_atendimento = nr_atendimento_ant_w;
				 
				if (coalesce(cd_procedimento_w,0) > 0) and (coalesce(ie_origem_proced_w,0) > 0) then 
					 
					qt_dias_internacao_sus_w := obter_qt_dia_internacao_sus(cd_procedimento_w, ie_origem_proced_w);
					 
					if (coalesce(qt_dias_internacao_sus_w,0) > 0) then 
				 
						update	atendimento_paciente 
						set	dt_previsto_alta = trunc(dt_entrada_w + qt_dias_internacao_sus_w), 
							ie_probabilidade_alta = ie_probabilidade_alta_w 
						where	nr_atendimento = nr_atendimento_p;
				 
				 
					end if;
				end if;
			end if;
		end if;
	end if;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_dias_ult_atend_sus (nr_atendimento_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

