-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_pls_ajustar_hist_segurado ( nm_usuario_p text) AS $body$
DECLARE


nr_seq_segurado_w		bigint;
dt_liberacao_w			timestamp;
ds_acao_contrato_w		varchar(255);
qt_registro_w			integer;
nr_seq_historico_w		bigint;
dt_rescisao_w			timestamp;

qt_historico_lib_w		bigint;
dt_historico_lib_w		timestamp;
qt_seg_migrado_w		bigint;

qt_seg_reativacao_w		bigint;
dt_hist_rescisao_w		timestamp;
nr_seq_hist_reativ_w		bigint;
nr_seq_hist_rescisao_w		bigint;
dt_reativacao_w			timestamp;
qt_hist_rescisao_w		bigint;
dt_rescisao_ww			timestamp;

C01 CURSOR FOR
	SELECT	nr_sequencia,
		dt_liberacao,
		substr(obter_valor_dominio(2115, ie_acao_contrato),1,255),
		dt_rescisao,
		dt_reativacao
	from	pls_segurado
	where	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	ie_tipo_segurado in ('A','B');


BEGIN

open C01;
loop
fetch C01 into
	nr_seq_segurado_w,
	dt_liberacao_w,
	ds_acao_contrato_w,
	dt_rescisao_w,
	dt_reativacao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (dt_rescisao_w IS NOT NULL AND dt_rescisao_w::text <> '') then
		select	count(*)
		into STRICT	qt_historico_lib_w
		from 	pls_segurado_historico
		where	nr_seq_segurado		= nr_seq_segurado_w
		and	ie_tipo_historico	= '22';

		/* Se já tiver histórico de liberação */

		if (qt_historico_lib_w	> 0) then
			select	count(*)
			into STRICT	qt_hist_rescisao_w
			from	pls_segurado_historico
			where	nr_seq_segurado	= nr_seq_segurado_w
			and	ie_tipo_historico	= '1';

			if (qt_hist_rescisao_w = 0) then
				select	max(dt_historico)
				into STRICT	dt_historico_lib_w
				from	pls_segurado_historico
				where	nr_seq_segurado		= nr_seq_segurado_w
				and	ie_tipo_historico	= '22';

				CALL pls_gerar_segurado_historico(nr_seq_segurado_w, '1', fim_dia(dt_historico_lib_w),
						ds_acao_contrato_w, 'baca_pls_ajustar_hist_segurado', null,
						null, null, null,
						fim_dia(dt_historico_lib_w), null, null,
						null, null, null,
						null, nm_usuario_p, 'S');
			end if;
		/* Se não tiver histórico de liberação */

		else
			/* Lança um histórico de liberação */

			CALL pls_gerar_segurado_historico(	nr_seq_segurado_w, '22', dt_liberacao_w,
							ds_acao_contrato_w, 'baca_pls_ajustar_hist_segurado', null,
							null, null, null,
							dt_liberacao_w, null, null,
							null, null, null,
							null, nm_usuario_p, 'S');

			/* Verifica se já possui histórico de rescisão */

			select	count(*)
			into STRICT	qt_hist_rescisao_w
			from	pls_segurado_historico
			where	nr_seq_segurado	= nr_seq_segurado_w
			and	ie_tipo_historico	= '1';

			/* Verifica se a data de liberação é menor que a data de rescisão para os casos onde a base é importada e os beneficiários rescindidos são liberados */

			if (dt_liberacao_w < dt_rescisao_w) then
				dt_rescisao_ww	:= dt_rescisao_w;
			else
				dt_rescisao_ww	:= fim_dia(dt_liberacao_w);
			end if;
			/* Lança um histórico de rescisão */

			if (qt_hist_rescisao_w = 0) then
				CALL pls_gerar_segurado_historico(nr_seq_segurado_w, '1', dt_rescisao_ww,
						ds_acao_contrato_w, 'baca_pls_ajustar_hist_segurado', null,
						null, null, null,
						dt_rescisao_ww, null, null,
						null, null, null,
						null, nm_usuario_p, 'S');
			end if;
		end if;
	else
		select	count(*)
		into STRICT	qt_registro_w
		from	pls_segurado_historico
		where	nr_seq_segurado		= nr_seq_segurado_w
		and	ie_tipo_historico	= '22';

		if (qt_registro_w	= 0) then
			CALL pls_gerar_segurado_historico(nr_seq_segurado_w, '22', dt_liberacao_w,
					ds_acao_contrato_w, 'baca_pls_ajustar_hist_segurado', null,
					null, null, null,
					dt_liberacao_w, null, null,
					null, null, null,
					null, nm_usuario_p, 'S');
		end if;

		update	pls_segurado_historico
		set	ie_historico_situacao	= 'N'
		where	nr_seq_segurado		= nr_seq_segurado_w;

		select	max(nr_sequencia)
		into STRICT	nr_seq_historico_w
		from	pls_segurado_historico
		where	nr_seq_segurado	= nr_seq_segurado_w
		and	dt_historico	= (	SELECT	max(dt_historico)
						from 	pls_segurado_historico
						where 	nr_seq_segurado = nr_seq_segurado_w
						and	ie_tipo_historico in ('1','2','5','22'));

		if (coalesce(nr_seq_historico_w,0) > 0) then
			update	pls_segurado_historico
			set	ie_historico_situacao	= 'S'
			where	nr_sequencia		= nr_seq_historico_w;
		end if;

		/* Ajuste nos históricos de migração de 5 para 23 */

		select	count(*)
		into STRICT	qt_seg_migrado_w
		from	pls_segurado a
		where	(a.nr_seq_segurado_ant IS NOT NULL AND a.nr_seq_segurado_ant::text <> '')
		and	coalesce(dt_rescisao::text, '') = ''
		and	a.nr_sequencia	= nr_seq_segurado_w
		and	exists (SELECT	1
				from	pls_segurado_historico x
				where	a.nr_sequencia	= x.nr_seq_segurado
				and	x.ie_tipo_historico = '5');

		if (qt_seg_migrado_w > 0) then
			update	pls_segurado_historico a
			set	a.ie_tipo_historico	= '23'
			where	a.nr_sequencia	in (	SELECT	x.nr_sequencia
							from	pls_segurado_historico x
							where	x.nr_seq_segurado	= nr_seq_segurado_w
							and	x.ie_tipo_historico	= '5')
			and	a.nr_seq_segurado	= nr_seq_segurado_w;
		end if;

		/* Ajuste nos históricos de reativação para ficar sempre depois da rescisão */

		select	count(*)
		into STRICT	qt_seg_reativacao_w
		from	pls_segurado a
		where	(a.dt_reativacao IS NOT NULL AND a.dt_reativacao::text <> '')
		and	coalesce(a.dt_rescisao::text, '') = ''
		and	a.nr_sequencia	= nr_seq_segurado_w
		and	exists (SELECT	1
				from	pls_segurado_historico x
				where	a.nr_sequencia	= x.nr_seq_segurado
				and	x.ie_tipo_historico = '2');

		if (qt_seg_reativacao_w > 0) and (dt_reativacao_w IS NOT NULL AND dt_reativacao_w::text <> '') then
			select	max(dt_historico)
			into STRICT	dt_hist_rescisao_w
			from	pls_segurado_historico
			where	nr_seq_segurado	= nr_seq_segurado_w
			and	ie_tipo_historico	= '1';

			if (trunc(dt_hist_rescisao_w) >= trunc(dt_reativacao_w)) then
				dt_reativacao_w	:= fim_dia(dt_hist_rescisao_w);
			end if;

			select	max(a.nr_sequencia)
			into STRICT	nr_seq_hist_reativ_w
			from	pls_segurado_historico a
			where	a.nr_seq_segurado = nr_seq_segurado_w
			and	a.ie_tipo_historico = '2';

			if (coalesce(nr_seq_hist_reativ_w,0) > 0) then
				update	pls_segurado_historico a
				set	dt_historico	= dt_reativacao_w
				where	a.nr_sequencia	= nr_seq_hist_reativ_w
				and	a.nr_seq_segurado	= nr_seq_segurado_w;
			end if;
		end if;
	end if;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_pls_ajustar_hist_segurado ( nm_usuario_p text) FROM PUBLIC;

