-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ajustar_data_itens_auditoria (nr_sequencia_p bigint, dt_item_p timestamp, ie_tipo_p text, nr_seq_motivo_auditoria_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
dt_entrada_w			timestamp;
nr_atendimento_w		bigint;
nr_interno_conta_w		bigint;
dt_periodo_inicial_w		timestamp;
dt_periodo_final_w		timestamp;
ie_data_conta_valida_w		varchar(2);
nr_seq_auditoria_w		bigint;
ie_consiste_periodo_w		varchar(1);
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type := wheb_usuario_pck.get_cd_estabelecimento;
ie_altera_item_repasse_w	varchar(1) := 'S';	

BEGIN 
 
if (ie_tipo_p	= 'M') then 
	begin 
	select	a.nr_atendimento, 
		c.dt_entrada, 
		d.nr_interno_conta, 
		d.dt_periodo_inicial, 
		d.dt_periodo_final, 
		b.nr_seq_auditoria 
	into STRICT	nr_atendimento_w, 
		dt_entrada_w, 
		nr_interno_conta_w, 
		dt_periodo_inicial_w, 
		dt_periodo_final_w, 
		nr_seq_auditoria_w 
	FROM atendimento_paciente c, auditoria_matpaci b, material_atend_paciente a
LEFT OUTER JOIN conta_paciente d ON (a.nr_interno_conta = d.nr_interno_conta)
WHERE c.nr_atendimento	= a.nr_atendimento  and a.nr_sequencia		= b.nr_seq_matpaci and b.nr_sequencia		= nr_sequencia_p;
	exception 
		when others then 
			dt_entrada_w		:= dt_item_p;
			dt_periodo_inicial_w	:= dt_item_p;
			dt_periodo_final_w	:= dt_item_p;
	end;
elsif (ie_tipo_p	= 'P') then 
	begin 
	select	a.nr_atendimento, 
		c.dt_entrada, 
		d.nr_interno_conta, 
		d.dt_periodo_inicial, 
		d.dt_periodo_final, 
		b.nr_seq_auditoria 
	into STRICT	nr_atendimento_w, 
		dt_entrada_w, 
		nr_interno_conta_w, 
		dt_periodo_inicial_w, 
		dt_periodo_final_w, 
		nr_seq_auditoria_w 
	FROM atendimento_paciente c, auditoria_propaci b, procedimento_paciente a
LEFT OUTER JOIN conta_paciente d ON (a.nr_interno_conta = d.nr_interno_conta)
WHERE c.nr_atendimento	= a.nr_atendimento  and a.nr_sequencia		= b.nr_seq_propaci and b.nr_sequencia		= nr_sequencia_p;
	exception 
		when others then 
			dt_entrada_w		:= dt_item_p;
			dt_periodo_inicial_w	:= dt_item_p;
			dt_periodo_final_w	:= dt_item_p;
 
	end;
end if;
 
select	coalesce(max('S'),'N') 
into STRICT	ie_data_conta_valida_w 
 
where	dt_item_p between coalesce(dt_periodo_inicial_w,dt_item_p) and coalesce(dt_periodo_final_w,dt_item_p);
 
if (dt_item_p	< dt_entrada_w) then 
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(278610);
elsif (ie_data_conta_valida_w		= 'N') then 
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(278616);
end if;
 
ie_consiste_periodo_w:= obter_valor_param_usuario(1116, 20, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w);
ie_altera_item_repasse_w := obter_param_usuario(1116, 189, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_altera_item_repasse_w);
 
if (ie_consiste_periodo_w = 'S') then 
 
	select 	max(dt_periodo_inicial), 
		max(dt_periodo_final) 
	into STRICT	dt_periodo_inicial_w, 
		dt_periodo_final_w 
	from 	auditoria_conta_paciente 
	where 	nr_sequencia = nr_seq_auditoria_w;
 
	select	coalesce(max('S'),'N') 
	into STRICT	ie_data_conta_valida_w 
	 
	where	dt_item_p between coalesce(dt_periodo_inicial_w, dt_item_p) and coalesce(dt_periodo_final_w,dt_item_p);
	 
	if (ie_data_conta_valida_w	= 'N') then 
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(278621);
	end if;
	 
end if;
 
if (ie_tipo_p = 'M') then 
	 
	update	material_Atend_Paciente a 
	set	a.dt_atendimento	= dt_item_p, 
		a.dt_conta	= dt_item_p, 
		a.dt_atualizacao	= clock_timestamp(), 
		a.nm_usuario	= nm_usuario_p 
	where	a.nr_sequencia in (	SELECT 	w.nr_seq_matpaci 
					from 	auditoria_matpaci w 
					where 	w.nr_Sequencia = nr_sequencia_p) 
	and	not exists (	select	1 
				from	material_repasse x 
				where	x.nr_seq_material = a.nr_sequencia 
				and	coalesce(ie_altera_item_repasse_w,'S') = 'N');
					 
	update	auditoria_matpaci a 
	set	a.nr_seq_motivo = coalesce(nr_seq_motivo_auditoria_p,a.nr_seq_motivo), 
		a.dt_atualizacao	= clock_timestamp(), 
		a.nm_usuario	= nm_usuario_p 
	where	a.nr_Sequencia = nr_sequencia_p 
	and	not exists (	SELECT	1 
				from	material_repasse x 
				where	x.nr_seq_material = a.nr_seq_matpaci 
				and	coalesce(ie_altera_item_repasse_w,'S') = 'N');
	 
 
elsif (ie_tipo_p = 'P') then		 
	update	procedimento_paciente a 
	set	a.dt_procedimento	= dt_item_p, 
		a.dt_conta		= dt_item_p, 
		a.dt_atualizacao	= clock_timestamp(), 
		a.nm_usuario		= nm_usuario_p 
	where	a.nr_sequencia in (	SELECT 	w.nr_seq_propaci 
					from 	auditoria_propaci w 
					where 	w.nr_Sequencia = nr_sequencia_p) 
	and	not exists (	select	1 
				from	procedimento_repasse x 
				where	x.nr_seq_procedimento = a.nr_sequencia 
				and	coalesce(ie_altera_item_repasse_w,'S') = 'N');
					 
	update	auditoria_propaci a 
	set	a.nr_seq_motivo = coalesce(nr_seq_motivo_auditoria_p,a.nr_seq_motivo), 
		a.dt_atualizacao	= clock_timestamp(), 
		a.nm_usuario	= nm_usuario_p 
	where	a.nr_Sequencia = nr_sequencia_p 
	and	not exists (	SELECT	1 
				from	procedimento_repasse x 
				where	x.nr_seq_procedimento = a.nr_seq_propaci 
				and	coalesce(ie_altera_item_repasse_w,'S') = 'N');
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ajustar_data_itens_auditoria (nr_sequencia_p bigint, dt_item_p timestamp, ie_tipo_p text, nr_seq_motivo_auditoria_p bigint, nm_usuario_p text) FROM PUBLIC;

