-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE com_aprovar_lead ( nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_cnpj_w			varchar(14);
ds_razao_social_w			pessoa_juridica.ds_razao_social%type;
ie_tipo_w				varchar(03);
ie_fase_venda_w			varchar(03);
nr_seq_canal_w			bigint;
dt_revisao_prevista_w		timestamp;
ie_status_neg_w			varchar(03);
nr_seq_ativ_w			bigint;
ie_classificacao_w			varchar(03);
qt_leito_w			integer;
qt_leito_uti_w			smallint;
ds_endereco_w			varchar(100);
nr_endereco_w			varchar(10);
ds_complemento_w			varchar(20);
ds_bairro_w			varchar(40);
ds_municipio_w			varchar(40);
sg_estado_w			com_solic_lead.sg_estado%type;
cd_cep_w			varchar(15);
nr_telefone_w			varchar(15);
ds_email_w			varchar(80);
nm_pessoa_contato_w		varchar(40);
nm_gestor_negocio_w		varchar(40);
ds_motivo_cadastro_w		varchar(2000);
ds_motivo_reprov_w		varchar(2000);
ie_natureza_w			varchar(01);
nr_seq_compl_w			bigint;
qt_pessoa_w			smallint;
cd_empresa_w			smallint;
nr_sequencia_cliente_w		bigint;
nr_seq_novo_canal_w		bigint;
qt_canal_w			bigint;
cd_pessoa_gestor_w		varchar(10);
ie_produto_w			varchar(15);
cd_estabelecimento_w		smallint;
cd_forma_aquisicao_w		varchar(15);
cd_pessoa_fisica_w		varchar(10);
nm_fantasia_w			varchar(80);
ds_email_gestor_w		varchar(255);
ds_assunto_w			varchar(100);
ds_mensagem_w			varchar(4000);
dt_solicitacao_w		timestamp;
nm_pessoa_fisica_w		varchar(100);
ds_produto_w			varchar(255);
nr_seq_pais_w			bigint;


BEGIN
cd_estabelecimento_w		:= wheb_usuario_pck.get_cd_estabelecimento;

select	cd_cnpj,
	ds_razao_social,
	ie_tipo,
	ie_fase_venda,
	nr_seq_canal,
	dt_revisao_prevista,
	ie_status_neg,
	nr_seq_ativ,
	ie_classificacao,
	qt_leito,
	qt_leito_uti,
	ds_endereco,
	nr_endereco,
	ds_complemento,
	ds_bairro,
	ds_municipio,
	sg_estado,
	cd_cep,
	nr_telefone,
	ds_email,
	nm_pessoa_contato,
	nm_gestor_negocio,
	ds_motivo_cadastro,
	ds_motivo_reprov,
	ie_natureza,
	ie_produto,
	cd_forma_aquisicao,
	cd_pessoa_fisica,
	nm_fantasia,
	obter_valor_dominio(2668,ie_produto),
	dt_solicitacao,
	nr_seq_pais
into STRICT	cd_cnpj_w,
	ds_razao_social_w,
	ie_tipo_w,
	ie_fase_venda_w,
	nr_seq_canal_w,
	dt_revisao_prevista_w,
	ie_status_neg_w,
	nr_seq_ativ_w,
	ie_classificacao_w,
	qt_leito_w,
	qt_leito_uti_w,
	ds_endereco_w,
	nr_endereco_w,
	ds_complemento_w,
	ds_bairro_w,
	ds_municipio_w,
	sg_estado_w,
	cd_cep_w,
	nr_telefone_w,
	ds_email_w,
	nm_pessoa_contato_w,
	nm_gestor_negocio_w,
	ds_motivo_cadastro_w,
	ds_motivo_reprov_w,
	ie_natureza_w,
	ie_produto_w,
	cd_forma_aquisicao_w,
	cd_pessoa_fisica_w,
	nm_fantasia_w,
	ds_produto_w,
	dt_solicitacao_w,
	nr_seq_pais_w
from	com_solic_lead
where	nr_sequencia = nr_sequencia_p;

select	obter_empresa_estab(cd_estabelecimento_p)
into STRICT	cd_empresa_w
;

select	count(*)
into STRICT	qt_pessoa_w
from	pessoa_juridica
where	cd_cgc = cd_cnpj_w;

if (qt_pessoa_w = 0) then
	begin
	insert into pessoa_juridica(
			cd_cgc,
			ds_razao_social,
			nm_fantasia,
			cd_cep,
			ds_endereco,
			ds_bairro,
			ds_municipio,
			sg_estado,
			dt_atualizacao,
			nm_usuario,
			ds_complemento,
			nr_telefone,
			nr_endereco,
			ds_email,
			nm_pessoa_contato,
			ie_situacao,
			cd_tipo_pessoa,
			ie_prod_fabric,
			nr_seq_pais,
			dt_atualizacao_nrec,
			nm_usuario_nrec)
		values (	cd_cnpj_w,
			ds_razao_social_w,
			nm_fantasia_w,
			cd_cep_w,
			ds_endereco_w,
			ds_bairro_w,
			ds_municipio_w,
			sg_estado_w,
			clock_timestamp(),
			nm_usuario_p,
			ds_complemento_w,
			nr_telefone_w,
			nr_endereco_w,
			ds_email_w,
			nm_pessoa_contato_w,
			'A',
			5,
			'N',
			nr_seq_pais_w,
			clock_timestamp(),
			nm_usuario_p);

	insert into pessoa_juridica_estab(
			nr_sequencia,
			cd_cgc,
			cd_estabelecimento,
			dt_atualizacao,
			nm_usuario,
			nm_pessoa_contato,
			ds_email,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ie_conta_dif_nf)
		values (	nextval('pessoa_juridica_estab_seq'),
			cd_cnpj_w,
			cd_estabelecimento_p,
			clock_timestamp(),
			nm_usuario_p,
			nm_pessoa_contato_w,
			ds_email_w,
			clock_timestamp(),
			nm_usuario_p,
			'N');

	select	coalesce(max(nr_sequencia),0) + 1
	into STRICT	nr_seq_compl_w
	from	pessoa_juridica_compl;
			
	insert into pessoa_juridica_compl(
			cd_cgc,
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			ds_endereco,
			nr_endereco,
			ds_complemento,
			ds_bairro,
			ds_municipio,
			sg_estado,
			cd_cep,
			nr_telefone,
			ds_email,
			nm_pessoa_contato,
			ie_tipo_complemento,
			dt_atualizacao_nrec,
			nm_usuario_nrec)
		values (	cd_cnpj_w,
			nr_seq_compl_w,
			clock_timestamp(),
			nm_usuario_p,
			ds_endereco_w,
			nr_endereco_w,
			ds_complemento_w,
			ds_bairro_w,
			ds_municipio_w,
			sg_estado_w,
			cd_cep_w,
			nr_telefone_w,
			ds_email_w,
			nm_pessoa_contato_w,
			1,
			clock_timestamp(),
			nm_usuario_p);
		
	select nextval('com_cliente_seq')
	into STRICT nr_sequencia_cliente_w
	;
	
	insert into com_cliente(
		nr_sequencia,
		cd_empresa,
		dt_atualizacao,
		nm_usuario,
		cd_cnpj,
		ie_situacao,
		ie_natureza,
		ie_fase_venda,
		ie_status_neg,
		ie_classificacao,
		ie_tipo,
		qt_leito,
		qt_leito_uti,
		ie_resp_atend,
		ie_recebe_visita,
		ie_referencia,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		dt_revisao_prevista,
		nr_seq_ativ,
		ie_hosp_escola,
		ie_resp_implantacao,
		ie_resp_coordenacao,
		ie_produto,
		nr_seq_lead,
		ie_inclusao_manual,
		cd_estabelecimento,
		ie_forma_aquisicao,
		ie_acompanha_implantacao)
	values (	nr_sequencia_cliente_w,
		cd_empresa_w,
		clock_timestamp(),
		nm_usuario_p,
		cd_cnpj_w,
		'A',
		ie_natureza_w,
		ie_fase_venda_w,
		ie_status_neg_w,
		'L',
		ie_tipo_w,
		qt_leito_w,
		qt_leito_uti_w,
		'W',
		'N',
		'N',
		clock_timestamp(),
		nm_usuario_p,
		dt_revisao_prevista_w,
		nr_seq_ativ_w,
		'N',
		'W',
		'W',
		ie_produto_w,
		nr_sequencia_p,
		'N',
		cd_estabelecimento_w,
		cd_forma_aquisicao_w,
		'N');
		
	 insert into com_cliente_hist(
		nr_sequencia,
		nr_seq_cliente,
		dt_atualizacao,
		nm_usuario,
		nr_seq_canal,
		nr_seq_tipo,
		dt_historico,
		ds_titulo,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_ativ,
		dt_liberacao,
		nr_seq_classif,
		ds_historico)
	values (nextval('com_cliente_hist_seq'),
		nr_sequencia_cliente_w,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_canal_w,
		2,
		clock_timestamp(),
		'Aprovacao da solicitacao de Lead',
		clock_timestamp(),
		nm_usuario_p,
		null,
		clock_timestamp(),
		null,
		'Motivo cadastro: ' || ds_motivo_cadastro_w);

	select	count(*)
	into STRICT	qt_canal_w
	from	com_canal_cliente
	where	nr_seq_cliente	= nr_sequencia_cliente_w
	and	ie_tipo_atuacao	= 'V'
	and	coalesce(dt_fim_atuacao::text, '') = '';
	
	if (qt_canal_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(223447); -- Ja existe um canal ativo para este cliente. Verifique!
	end if;
	
	select 	nextval('com_canal_cliente_seq')
	into STRICT	nr_seq_novo_canal_w
	;
	
	insert into com_canal_cliente(
		nr_sequencia,
		nr_seq_canal,
		dt_atualizacao,
		nm_usuario,
		nr_seq_cliente,
		ie_tipo_atuacao,
		dt_inicio_atuacao,
		dt_fim_atuacao,
		ie_situacao,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		pr_esforco,
		cd_vendedor)
	values (	nr_seq_novo_canal_w,
		nr_seq_canal_w,
		clock_timestamp(),
		nm_usuario_p,
		nr_sequencia_cliente_w,
		'V',
		clock_timestamp(),
		null,
		'A',
		clock_timestamp(),
		nm_usuario_p,
		null,
		null);

	if (coalesce(cd_pessoa_fisica_w,'X') = 'X') then
		begin
		select	max(cd_pessoa_fisica)
		into STRICT	cd_pessoa_gestor_w
		from	pessoa_fisica	
		where	upper(nm_pessoa_fisica) like upper(nm_gestor_negocio_w);
		cd_pessoa_fisica_w := cd_pessoa_gestor_w;
		end;
	end if;
	
	if (coalesce(cd_pessoa_fisica_w,'0') <> '0') then
		begin
		insert into com_cliente_gestor(	nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_seq_cliente,
						cd_pessoa_fisica,
						dt_inicial,
						dt_final)
					values (	nextval('com_cliente_gestor_seq'),
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_sequencia_cliente_w,
						cd_pessoa_fisica_w,
						clock_timestamp(),
						null);
		end;
	end if;

	update	com_solic_lead
	set	dt_aprov_reprov = clock_timestamp(),
		nm_usuario	= nm_usuario_p,
		ie_status_lead	= 'A',
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_sequencia_p;
	
	select	obter_dados_pf_pj(cd_pessoa_fisica_w,null,'M')
	into STRICT	ds_email_gestor_w
	;

	select	obter_nome_usuario(nm_usuario_p)
	into STRICT	nm_pessoa_fisica_w
	;
	
	ds_assunto_w	:= substr('Solicitacao Lead',1,70);
	ds_mensagem_w	:= substr(('CNPJ: ' || cd_cnpj_w || chr(13) || chr(10) ||
				'Razao Social: ' || ds_razao_social_w || chr(13) || chr(10) ||
				'Produto: ' || ds_produto_w || chr(13) || chr(10) ||
				'Dt. solicitacao: ' || dt_solicitacao_w || chr(13) || chr(10) ||
				'Aprovado em ' || clock_timestamp() || ' por ' || nm_pessoa_fisica_w),1,4000);
	CALL enviar_email(ds_assunto_w, ds_mensagem_w, 'comercial@wheb.com.br', 'comercial@wheb.com.br;' || ds_email_gestor_w, 'Tasy', 'M');
	
	end;
else
	CALL wheb_mensagem_pck.exibir_mensagem_abort(223448); -- Pessoa ja cadastrada!
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE com_aprovar_lead ( nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

