-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sismama_mam_alter_formato_data () AS $body$
DECLARE


qt_registro_w		bigint;


BEGIN

/*

campos a serem alterados de tamanho/tipo da tabela SISMAMA_MAM_ANAMNESE:
dt_ultima_mamografia

*/
/*1º passo, cria uma tabela temporária para não perder as informações*/

CALL exec_sql_dinamico('Anderson', 'create table SISMAMA_MAM_ANAMNESE_BKP as select * from SISMAMA_MAM_ANAMNESE');


/*2º passo, cria todos os campos temporários para armazenar as informações*/

CALL exec_sql_dinamico('Anderson', 'alter table SISMAMA_MAM_ANAMNESE add dt_ultima_mamografia2 varchar2(4)');


/*3º passo, faz update de todos os campos passando as informações no formato yyyy para os novos campos*/

CALL exec_sql_dinamico('Anderson', 	'update SISMAMA_MAM_ANAMNESE ' ||
				'set 	dt_ultima_mamografia2 = to_char(dt_ultima_mamografia,' || chr(39) || 'yyyy' || chr(39) || ')');


/*4º passo, seta todos os campos que serão substituidos para nulo para fazer o modify*/

CALL exec_sql_dinamico('Anderson', 'update SISMAMA_MAM_ANAMNESE set 	 dt_ultima_mamografia = null');


/*5º passo,  fazer o modify dos campos*/

CALL exec_sql_dinamico('Anderson', 'alter table SISMAMA_MAM_ANAMNESE modify dt_ultima_mamografia varchar2(04)');


/*6º passo, seta os valores para os campos corretos*/

CALL exec_sql_dinamico('Anderson', 'update SISMAMA_MAM_ANAMNESE set 	 dt_ultima_mamografia = dt_ultima_mamografia2');


/*7º passo, dropa os campos temporarios*/

--exec_sql_dinamico('Anderson', 'alter table SISMAMA_MAM_ANAMNESE drop column dt_ultima_mamografia2');
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sismama_mam_alter_formato_data () FROM PUBLIC;

