-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_tratar_retorno_aih ( nr_seq_protocolo_p bigint, nm_usuario_p text, ds_erro_p INOUT text, nr_seq_retorno_p INOUT text) AS $body$
DECLARE

 
ds_erro_w		varchar(255);
nr_seq_retorno_w		varchar(255);
vl_parametro_w		varchar(255);
cd_estabelecimento_w	smallint;

 

BEGIN 
 
 
ds_erro_w := Sus_Consistir_Retorno_Aih(nr_seq_protocolo_p, nm_usuario_p, ds_erro_w);
 
select	coalesce(max(cd_estabelecimento),1) 
into STRICT	cd_estabelecimento_w 
from	protocolo_convenio 
where	nr_seq_protocolo	= nr_seq_protocolo_p;
 
if (ds_erro_w	= wheb_mensagem_pck.get_texto(279631)) then -- Processo fechado 
	begin 
	select	coalesce(obter_valor_param_usuario(997, 43, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_w),'N') 
	into STRICT	vl_parametro_w 
	;
 
	if (vl_parametro_w	= 'S') then 
		begin 
		ds_erro_w := Desdobrar_Tit_Processo_Aih(nr_seq_protocolo_p, nm_usuario_p, ds_erro_w);
		if (ds_erro_w	= wheb_mensagem_pck.get_texto(279632)) then -- Processo OK 
			ds_erro_w	:= wheb_mensagem_pck.get_texto(279631);
		else 
			ds_erro_w	:= substr(wheb_mensagem_pck.get_texto(279633, 'DS_ERRO_P=' || ds_erro_w),1,255);
		end if;
		end;
	end if;
	end;
end if;
 
if (ds_erro_w	= wheb_mensagem_pck.get_texto(279631)) then -- Processo fechado 
	begin 
	if (vl_parametro_w	= 'S') then 
		SELECT * FROM Sus_Gerar_Retorno_Aih_desd(nr_seq_protocolo_p, nm_usuario_p, ds_erro_w, nr_seq_retorno_w) INTO STRICT ds_erro_w, nr_seq_retorno_w;
	else 
		SELECT * FROM Sus_Gerar_Retorno_Aih(nr_seq_protocolo_p, nm_usuario_p, ds_erro_w, nr_seq_retorno_w) INTO STRICT ds_erro_w, nr_seq_retorno_w;
	end if;
	end;
end if;
 
ds_erro_p		:= ds_erro_w;
nr_seq_retorno_p	:= nr_seq_retorno_w;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_tratar_retorno_aih ( nr_seq_protocolo_p bigint, nm_usuario_p text, ds_erro_p INOUT text, nr_seq_retorno_p INOUT text) FROM PUBLIC;

