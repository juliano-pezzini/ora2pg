-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_horario_prescr_lista ( nr_sequencia_lista_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ds_msg_p INOUT text, cd_evolucao_p INOUT bigint ) AS $body$
DECLARE


nr_atendimento_w      atendimento_paciente.nr_atendimento%TYPE;
cd_material_w         prescr_material.cd_material%TYPE;
cd_intervalo_w        prescr_material.cd_intervalo%TYPE;
qt_dose_w             prescr_mat_hor.qt_dose%TYPE;
nr_horas_validade_w   prescr_medica.nr_horas_validade%TYPE;
nr_prescricao_w       prescr_material.nr_prescricao%TYPE;
cd_unidade_medida_w   prescr_mat_hor.cd_unidade_medida%TYPE;
ie_via_aplicacao_w    prescr_material.ie_via_aplicacao%TYPE;
ds_material_w         varchar(255);
ds_msg_w              varchar(255);WITH RECURSIVE cte AS (


c_items CURSOR FOR
  SELECT (regexp_substr(nr_sequencia_lista_p, '[^,]+', 1, level))::numeric  nr_sequencia
  (regexp_substr(nr_sequencia_lista_p, '[^,]+', 1, level) IS NOT NULL AND (regexp_substr(nr_sequencia_lista_p, '[^,]+', 1, level))::text <> '')  UNION ALL


c_items CURSOR FOR
  SELECT (regexp_substr(nr_sequencia_lista_p, '[^,]+', 1, level))::numeric  nr_sequencia 
  (regexp_substr(nr_sequencia_lista_p, '[^,]+', 1, level) IS NOT NULL AND (regexp_substr(nr_sequencia_lista_p, '[^,]+', 1, level))::text <> '') JOIN cte c ON ()

) SELECT * FROM cte;
;

BEGIN
  CALL wheb_usuario_pck.set_ie_commit('N');

  FOR item IN c_items LOOP

    SELECT
      i.nr_atendimento,
      m.cd_material,
      m.cd_intervalo,
      i.qt_dose,
      p.nr_horas_validade,
      p.nr_prescricao,
      i.cd_unidade_medida,
      m.ie_via_aplicacao,
      obter_desc_material(i.cd_material) ds_material
    INTO STRICT
      nr_atendimento_w,
      cd_material_w,
      cd_intervalo_w,
      qt_dose_w,
      nr_horas_validade_w,
      nr_prescricao_w,
      cd_unidade_medida_w,
      ie_via_aplicacao_w,
      ds_material_w
    FROM
      cpoe_material c,
      prescr_medica p,
      prescr_material m,
      prescr_mat_hor i
    WHERE c.nr_sequencia = m.nr_seq_mat_cpoe
    AND m.nr_prescricao = p.nr_prescricao
    AND m.nr_prescricao = i.nr_prescricao
    AND m.nr_sequencia = i.nr_seq_material
    AND i.nr_sequencia = item.nr_sequencia;

    SELECT * FROM GERAR_ALTERACAO_HORARIO_PRESCR(
      cd_estabelecimento_p          => cd_estabelecimento_p, nr_atendimento_p              => nr_atendimento_w, ie_tipo_item_p                => 'M', cd_item_p                     => cd_material_w, cd_intervalo_p                => cd_intervalo_w, qt_item_p                     => qt_dose_w, qt_hora_prescricao_p          => nr_horas_validade_w, dt_evento_p                   => clock_timestamp(), nr_seq_horario_p              => item.nr_sequencia, nr_prescr_adm_p               => null, nr_prescricoes_p              => nr_prescricao_w, nr_prescricao_p               => nr_prescricao_w, nr_seq_item_p                 => null, ie_laboratorio_p              => 'N', ie_alteracao_p                => 3, qt_adm_p                      => qt_dose_w, cd_um_qt_adm_p                => cd_unidade_medida_w, ie_satisfacao_p               => null, ie_qualidade_p                => null, ds_justificativa_p            => null, ds_observacao_p               => null, nm_usuario_p                  => nm_usuario_p, ie_gerar_todos_p              => 'N', nr_seq_proc_interno_p         => null, nr_agrupamento_p              => null, nr_seq_motivo_susp_p          => null, ie_acm_sn_p                   => 'N', nr_seq_prot_glic_p            => null, ie_inicia_proced_p            => 'N', cd_medico_solic_p             => null, ie_item_suspenso_p            => 'N', cd_perfil_p                   => obter_perfil_ativo(), cd_funcao_p                   => 1113, ie_susp_mat_prescr_p          => 'N', nr_seq_lote_forncedor_p       => null, ie_proc_regra_p               => null, cd_procedimento_regra_p       => null, ie_origem_proced_regra_p      => null, nr_seq_proc_interno_regra_p   => null, ie_alterou_hor_adep_p         => 'S', nr_seq_assinatura_p           => null, ie_palm_p                     => null, cd_unidade_medida_p           => cd_unidade_medida_w, ds_item_p                     => ds_material_w, ds_componentes_p              => '', ds_observacao_item_p          => '', cd_evolucao_p                 => cd_evolucao_p, ie_via_aplicacao_p            => ie_via_aplicacao_w, nr_seq_motivo_adm_p           => null, ds_msg_p                      => ds_msg_w, nr_seq_topo_lat_p             => null, ie_somente_horario_p          => null, ie_via_aplic_alt_p            => null, nr_seq_part_name_p            => null, ie_procedure_time_p           => null, start_time_p                  => null, end_time_p                    => null, dept_location_p               => null, req_time_p                    => null) INTO STRICT cd_evolucao_p                 => cd_evolucao_p, ds_msg_p                      => ds_msg_w;

  END LOOP;

  CALL wheb_usuario_pck.set_ie_commit('S');

  IF (ds_msg_w IS NOT NULL AND ds_msg_w::text <> '') THEN
    ds_msg_p := ds_msg_w;
  ELSE
    commit;
  END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_horario_prescr_lista ( nr_sequencia_lista_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ds_msg_p INOUT text, cd_evolucao_p INOUT bigint ) FROM PUBLIC;

