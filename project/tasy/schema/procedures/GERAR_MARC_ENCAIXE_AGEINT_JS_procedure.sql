-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_marc_encaixe_ageint_js (cd_estabelecimento_p bigint, cd_agenda_p bigint, dt_agenda_p timestamp, hr_encaixe_p timestamp, cd_pessoa_fisica_p text, cd_convenio_p bigint, cd_categoria_p text, nm_usuario_p text, cd_medico_p text, ds_erro_cons_p INOUT text, ds_aviso_cons_p INOUT text, cd_tipo_agenda_p INOUT bigint, cd_plano_p text default null) AS $body$
DECLARE


dt_encaixe_w			timestamp;
ds_consist_encaixe_turno_w	varchar(255);
ie_permite_classif_w		varchar(1) := 'S';
ie_conv_cancelado_w		varchar(1);
ds_aviso_w			varchar(255);
ds_erro_w			varchar(255);
ie_enc_val_serv_w		varchar(255);
ie_enc_serv_bloq_w		varchar(1);
ie_cons_bloq_dia_w		varchar(1);
ie_encaixe_turno_w		varchar(1);
cd_tipo_Agenda_w		bigint;
ie_dia_semana_w			integer;
ds_param_48_w			varchar(2);
ie_permite_w varchar(1);
ie_consistir_encaixe_w varchar(1);


BEGIN

select 	SUBSTR(Obter_se_Convenio_Cancelado(cd_convenio_p, dt_agenda_p),1,2)				
into STRICT 	ie_conv_cancelado_w
;

if (ie_conv_cancelado_w = 'S') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(857353);
end if;

if (to_char(hr_encaixe_p,'hh24:mi') = '  :  ') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(184601);
end if;

dt_encaixe_w := TO_DATE(TO_CHAR(dt_agenda_p,'dd/mm/yyyy') || ' ' || to_char(hr_encaixe_p,'hh24:mi') || ':00','dd/mm/yyyy hh24:mi:ss');

select  max(cd_tipo_agenda)
into STRICT    cd_tipo_agenda_w
from    agenda
where   cd_agenda = cd_agenda_p;

SELECT * FROM validar_regra_encaixe_agenda(cd_tipo_agenda_p => cd_tipo_agenda_w, dt_encaixe_p => null, hr_encaixe_p => null, dt_hr_encaixe_p => dt_encaixe_w, cd_agenda_p => cd_agenda_p, cd_convenio_p => cd_convenio_p, ie_permite_p => ie_permite_w, ds_erro_p => ds_erro_w) INTO STRICT ie_permite_p => ie_permite_w, ds_erro_p => ds_erro_w;

if ie_permite_w = 'N' then
  if cd_tipo_agenda_w in (3,4) then
    ie_consistir_encaixe_w := obter_param_usuario(821, 51, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_consistir_encaixe_w);
    --somente valida se o parametro for N caso for S vai deixar gerar sem perguntar
    if ie_consistir_encaixe_w = 'N' then
      CALL wheb_mensagem_pck.exibir_mensagem_abort(263024);
    end if;
  elsif cd_tipo_agenda_w = 5 then
    CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_erro_w);
  end if;

  
end if;

cd_tipo_agenda_p := cd_tipo_agenda_w;

select 	obter_cod_dia_semana(dt_agenda_p)
into STRICT	ie_dia_semana_w
;

ie_cons_bloq_dia_w := consiste_bloq_mesmo_dia_turno(cd_agenda_p, dt_encaixe_w);
if (ie_cons_bloq_dia_w = 'S') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(458375);
end if;

if (cd_tipo_agenda_w = 2) then
	CALL consistir_encaixe_agenda_exame(cd_agenda_p, 0, dt_agenda_p, 'N', cd_estabelecimento_p, nm_usuario_p, dt_encaixe_w, cd_convenio_p);
elsif (cd_tipo_agenda_w in (3,4)) then
	SELECT * FROM consistir_encaixe_agecons(cd_agenda_p, 0, dt_agenda_p, 'N', nm_usuario_p, cd_estabelecimento_p, dt_encaixe_w, cd_convenio_p, cd_plano_p, cd_categoria_p, cd_pessoa_fisica_p, ds_aviso_cons_p, ds_erro_cons_p) INTO STRICT ds_aviso_cons_p, ds_erro_cons_p;
	ds_param_48_w := Obter_Param_Usuario(821, 48, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ds_param_48_w);
	if (ds_aviso_cons_p IS NOT NULL AND ds_aviso_cons_p::text <> '') and (ds_param_48_w <> 'S') then
		if (ds_param_48_w = 'Q') then
			ds_aviso_w := wheb_mensagem_pck.get_texto(5061, 'ERRO='||ds_aviso_cons_p);
			ds_aviso_cons_p := ds_aviso_w;
		end if;
	end if;
	if (ds_erro_cons_p IS NOT NULL AND ds_erro_cons_p::text <> '') then
		ds_erro_w := wheb_mensagem_pck.get_texto(1023201, 'DS_ERRO='||ds_erro_cons_p);
		ds_erro_cons_p := ds_erro_w;
	end if;
elsif (cd_tipo_agenda_w = 5) then
	--ie_enc_val_serv_w := obter_se_encaixe_valido (cd_agenda_p, dt_encaixe_w, 1);
	ie_enc_serv_bloq_w := obter_se_encaixe_bloqueio(cd_medico_p, cd_agenda_p);
	if (ie_enc_serv_bloq_w = 'S') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(507532);
	end if;
end if;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_marc_encaixe_ageint_js (cd_estabelecimento_p bigint, cd_agenda_p bigint, dt_agenda_p timestamp, hr_encaixe_p timestamp, cd_pessoa_fisica_p text, cd_convenio_p bigint, cd_categoria_p text, nm_usuario_p text, cd_medico_p text, ds_erro_cons_p INOUT text, ds_aviso_cons_p INOUT text, cd_tipo_agenda_p INOUT bigint, cd_plano_p text default null) FROM PUBLIC;

