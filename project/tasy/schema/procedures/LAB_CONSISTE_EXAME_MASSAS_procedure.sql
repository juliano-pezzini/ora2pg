-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_consiste_exame_massas (nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE
 	

nr_seq_resultado_w			exame_lab_resultado.nr_seq_resultado%type;
nr_seq_prescricao_w			prescr_procedimento.nr_sequencia%type;
ds_valor_padrao_w			lote_ent_exame_massa.ds_valor_padrao%type;
ie_todos_normais_w			varchar(1);
nr_seq_exame_w				exame_laboratorio.nr_seq_exame%type;
nr_seq_exame_ww				exame_laboratorio.nr_seq_exame%type;
ds_resultado_w				exame_lab_result_item.ds_resultado%type;
qt_resultado_w				exame_lab_result_item.ds_resultado%type;
pr_resultado_w				exame_lab_result_item.ds_resultado%type;
nr_seq_metodo_w				exame_lab_result_item.nr_seq_metodo%type;
nr_repeticao_w				lote_ent_res_ant_repet.nr_repeticao%type;
nr_seq_ficha_lote_w 		lote_ent_sec_ficha.nr_sequencia%type;
nr_seq_material_w			material_exame_lab.nr_sequencia%type;	
nr_seq_exame_rep_w			lote_ent_res_ant_repet.nr_seq_exame%type;

ds_resultado_ww				exame_lab_result_item.ds_resultado%type;

C01 CURSOR FOR
 SELECT  SUBSTR(lab_cons_val_lote_massas(k.nr_seq_exame, coalesce(d.qt_resultado,d.pr_resultado), d.ds_resultado, p.nr_sequencia,7, d.nr_seq_resultado, b.nr_sequencia, b.nr_seq_grupo_pat),1,255) IE_ACAO_CRITERIO_MASSAS
 FROM	lab_patologia_exame a,
 	  	lab_patologia b, 
 	  	exame_lab_result_item d, 
 	  	exame_lab_resultado g, 
 	  	prescr_procedimento p, 
 	  	exame_laboratorio w, 
 	  	lote_ent_sec_ficha x, 
 	  	lote_ent_sec_ficha_exam y, 
 	  	exame_laboratorio k, 
        material_exame_lab m 
 WHERE	a.nr_seq_patologia = b.nr_sequencia 
 AND    m.cd_material_exame = p.cd_material_exame 
 AND  	d.nr_seq_exame = k.nr_seq_exame 
 AND  	w.nr_seq_exame = p.nr_seq_exame 
 AND  	d.nr_seq_prescr = p.nr_sequencia 
 AND  	d.nr_seq_resultado = g.nr_seq_resultado 
 AND  	p.nr_prescricao = g.nr_prescricao 
 and  	k.nr_seq_superior = p.nr_seq_exame 
 and  	k.nr_seq_exame = a.nr_seq_exame 
 AND  	x.nr_sequencia = y.nr_seq_ficha 
 AND  	y.nr_seq_exame = p.nr_seq_exame 
 AND  	p.nr_seq_exame = y.nr_seq_exame 
 AND  	p.nr_prescricao = x.nr_prescricao 
 AND    coalesce(p.ie_suspenso,'N') <> 'S' 
 AND  	p.ie_status_atend >= 30 
 AND  	EXISTS (SELECT 	1 
 	   			FROM	LOTE_ENT_EXAME_MASSA l 
 	   			WHERE	l.nr_seq_exame = p.nr_seq_exame 
 	   			AND		l.ie_situacao = 'A')
 AND p.nr_prescricao = nr_prescricao_p;
	
c01_w 	c01%rowtype;	

BEGIN
ie_todos_normais_w := 'S';
select 	MAX(nr_seq_resultado)
into STRICT	nr_seq_resultado_w
from	exame_lab_resultado
where	nr_prescricao = nr_prescricao_p;

select 	MAX(a.nr_sequencia),
		MAX(a.nr_seq_exame),
		MAX(b.nr_sequencia)
into STRICT	nr_seq_prescricao_w,
		nr_seq_exame_w,
		nr_seq_material_w
from	prescr_procedimento a,
		material_exame_lab b
where	a.nr_prescricao = nr_prescricao_p
and		a.cd_material_exame = b.cd_material_exame
and		(Obter_Equipamento_Exame(nr_seq_exame,null,'PERKINMASS') IS NOT NULL AND (Obter_Equipamento_Exame(nr_seq_exame,null,'PERKINMASS'))::text <> '');

select 	MAX(ds_valor_padrao)
into STRICT	ds_valor_padrao_w
from 	lote_ent_exame_massa
where 	nr_seq_exame = nr_seq_exame_w
and		coalesce(ie_situacao,'A') = 'A'
and		coalesce(ie_exame_principal,'N') = 'S';

select 	Max(nr_sequencia)
into STRICT	nr_seq_ficha_lote_w
from	lote_ent_sec_ficha
where	nr_prescricao = nr_prescricao_p;

select 	MAX(qt_resultado),
		MAX(ds_resultado),
		MAX(pr_resultado),
		MAX(nr_seq_metodo)
into STRICT	qt_resultado_w,
		ds_resultado_w,		
		pr_resultado_w,
		nr_seq_metodo_w
from 	exame_lab_result_item
where	nr_seq_resultado = nr_seq_resultado_w
and		nr_seq_exame = nr_seq_exame_w
and		nr_Seq_prescr = nr_seq_prescricao_w
and		(nr_seq_material IS NOT NULL AND nr_seq_material::text <> '');		

if (nr_seq_resultado_w IS NOT NULL AND nr_seq_resultado_w::text <> '') then
	open C01;
	loop
	fetch C01 into	
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (c01_w.ie_acao_criterio_massas IS NOT NULL AND c01_w.ie_acao_criterio_massas::text <> '') or (c01_w.ie_acao_criterio_massas = 0)then
			ie_todos_normais_w := 'N';
		end if;
		end;
	end loop;
	close C01;
	
	if (ie_todos_normais_w = 'S') then
		update 	exame_lab_result_item
		set		ds_resultado = ds_valor_padrao_w,
				dt_atualizacao = clock_timestamp(),
				nm_usuario	=	nm_usuario_p
		where 	nr_seq_resultado = nr_seq_resultado_w
		and		nr_seq_prescr = nr_seq_prescricao_w
		and		nr_seq_exame = nr_seq_exame_w
		and		(nr_seq_material IS NOT NULL AND nr_seq_material::text <> '');
		commit;
	else
		update 	exame_lab_result_item
		set		ds_resultado = obter_texto_dic_objeto(265514,0,''), -- Alterado
				dt_atualizacao = clock_timestamp(),
				nm_usuario	=	nm_usuario_p
		where 	nr_seq_resultado = nr_seq_resultado_w
		and		nr_seq_prescr = nr_seq_prescricao_w
		and		nr_seq_exame = nr_seq_exame_w
		and		(nr_seq_material IS NOT NULL AND nr_seq_material::text <> '');
		commit;
	end if;

	select 	MAX(ds_resultado),
			MAX(nr_seq_exame)
	into STRICT 	ds_resultado_ww,
			nr_seq_exame_ww
	from 	exame_lab_result_item
	where	nr_seq_resultado = nr_seq_resultado_w
	and		nr_seq_prescr = nr_seq_prescricao_w
	and		nr_seq_exame = nr_seq_exame_w
	and		(nr_seq_material IS NOT NULL AND nr_seq_material::text <> '');
	
	select 	MAX(nr_seq_exame),
			MAX(nr_repeticao)
	into STRICT 	nr_seq_exame_rep_w,
			nr_repeticao_w
	from	lote_ent_res_ant_repet
	where 	nr_seq_resultado = nr_seq_resultado_w
	and		nr_seq_prescr = nr_seq_prescricao_w
	and		nr_seq_exame = nr_seq_exame_ww;
	
	/*gravar_log_tasy(30,'1- '||ds_resultado_ww||' 2- '||nr_seq_exame_rep_w ||' resultado antes '||ds_resultado_w,'APAE');
	commit;
	*/
	if (nr_seq_exame_rep_w IS NOT NULL AND nr_seq_exame_rep_w::text <> '') then
		
		update  lote_ent_res_ant_repet
		set 	ds_result_ant = ds_resultado_ww
		where 	nr_seq_resultado = nr_seq_resultado_w
		and		nr_seq_prescr = nr_seq_prescricao_w
		and		nr_seq_exame = nr_seq_exame_ww
		and		nr_repeticao = nr_repeticao_w;
		
		commit;
		
	end if;
	
CALL lab_atualizar_repeticao_massas(nr_seq_resultado_w, nr_prescricao_p, nr_seq_prescricao_w ,nm_usuario_p);
	

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_consiste_exame_massas (nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

