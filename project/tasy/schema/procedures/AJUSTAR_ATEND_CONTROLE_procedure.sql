-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ajustar_atend_controle (cd_pessoa_fisica_p text, nm_usuario_p text, nr_atendimento_p bigint default null, nr_seq_episodio_p bigint default null, ie_acao_p text default 'I') AS $body$
BEGIN

-- IE_ACAO_P
-- I INICIAR
-- T TERMINAR
-- C CANCELAR
if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') and ((nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') or (nr_seq_episodio_p IS NOT NULL AND nr_seq_episodio_p::text <> '')) then
	
		if (ie_acao_p = 'I') then
		   insert into atend_paciente_controle(
				nr_sequencia,
				cd_pessoa_fisica,
				nm_usuario_nrec,
				nm_usuario,
				dt_atualizacao_nrec,
				dt_atualizacao,
				nr_atendimento,
				nr_seq_episodio,
				ie_status_atendimento,
				ie_status_episodio
		   ) values (
				nextval('atend_paciente_controle_seq'),
				cd_pessoa_fisica_p,
				nm_usuario_p,
				nm_usuario_p,
				clock_timestamp(),
				clock_timestamp(),
				coalesce(nr_atendimento_p, null),
				coalesce(nr_seq_episodio_p, null),
				CASE WHEN coalesce(nr_atendimento_p::text, '') = '' THEN  'X'  ELSE 'I' END ,
				CASE WHEN coalesce(nr_seq_episodio_p::text, '') = '' THEN  'X'  ELSE 'I' END 
		   );
		   
		elsif (ie_acao_p = 'T') then
			update atend_paciente_controle
			set	ie_status_atendimento = ie_acao_p,
				dt_atualizacao = clock_timestamp(),
				nm_usuario = nm_usuario_p
			where nr_atendimento = nr_atendimento_p;
			
			update atend_paciente_controle
			set	ie_status_episodio = ie_acao_p,
				dt_atualizacao = clock_timestamp(),
				nm_usuario = nm_usuario_p
			where nr_seq_episodio = nr_seq_episodio_p;
			
			commit;

			CALL generate_info_insurance(nr_seq_episodio_p, nr_atendimento_p, cd_pessoa_fisica_p);
		elsif (ie_acao_p = 'C') then
			update atend_paciente_controle
			set	ie_status_atendimento = ie_acao_p,
				dt_atualizacao = clock_timestamp(),
				nm_usuario = nm_usuario_p
			where nr_atendimento = nr_atendimento_p
			and   ie_status_atendimento <> 'T';
			
			update atend_paciente_controle
			set	ie_status_episodio = ie_acao_p,
				dt_atualizacao = clock_timestamp(),
				nm_usuario = nm_usuario_p
			where nr_seq_episodio = nr_seq_episodio_p
			and   ie_status_episodio <> 'T';
	        end if;

      commit;	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ajustar_atend_controle (cd_pessoa_fisica_p text, nm_usuario_p text, nr_atendimento_p bigint default null, nr_seq_episodio_p bigint default null, ie_acao_p text default 'I') FROM PUBLIC;

