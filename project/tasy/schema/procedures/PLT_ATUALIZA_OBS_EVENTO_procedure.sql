-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE plt_atualiza_obs_evento ( nr_seq_alter_p bigint, ie_tipo_item_p text, ds_observacao_p text, nm_usuario_p text) AS $body$
DECLARE


ie_ds_w				varchar(1);					
cd_estabelecimento_w		integer;
cd_dieta_w			bigint;
nr_prescricao_w			bigint;
nr_sequencia_w			bigint;
nr_seq_alter_w			bigint;
nr_seq_horario_w		bigint;

c01 CURSOR FOR
SELECT	c.nr_sequencia
FROM	prescr_dieta_hor c,
	prescr_medica a
WHERE	c.nr_prescricao = a.nr_prescricao
AND	a.nr_prescricao = nr_prescricao_w
AND	c.nr_seq_dieta = nr_sequencia_w
AND	ie_tipo_item_p = 'D';

c02 CURSOR FOR
SELECT	c.nr_sequencia
FROM	dieta x,
	prescr_dieta d,
	prescr_dieta_hor c,
	prescr_medica a
WHERE	x.cd_dieta = d.cd_dieta
AND	d.nr_prescricao = c.nr_prescricao
AND	d.nr_prescricao	= a.nr_prescricao
AND	c.nr_prescricao = a.nr_prescricao
AND	a.nr_prescricao = nr_prescricao_w
AND	ie_tipo_item_p = 'D'
AND	d.cd_dieta = cd_dieta_w;


BEGIN

select	max(cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	usuario
where	nm_usuario = nm_usuario_p;

ie_ds_w := obter_param_usuario(1113, 148, Obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, ie_ds_w);

if (coalesce(nr_seq_alter_p,0) > 0) and (ds_observacao_p IS NOT NULL AND ds_observacao_p::text <> '') then

	if (ie_tipo_item_p in ('M','S','MAT','P','C','I','G','R','E','LD')) then
	
		update	prescr_mat_alteracao
		set	ds_observacao	= substr(ds_observacao_p,1,2000)
		where	nr_sequencia	= nr_seq_alter_p;
	
	elsif (ie_tipo_item_p in ('NAN','NPN','SNE','SOL','HM')) then		

		update	prescr_solucao_evento
		set	ds_observacao	= substr(ds_observacao_p,1,2000)
		where	nr_sequencia	= nr_seq_alter_p;
	
	elsif (ie_tipo_item_p = 'O') then

		update	prescr_gasoterapia_evento
		set	ds_observacao	= substr(ds_observacao_p,1,255)
		where	nr_sequencia	= nr_seq_alter_p;
	
	elsif (ie_tipo_item_p = 'D') then

		select	a.cd_dieta,
			a.nr_prescricao,
			a.nr_sequencia
		into STRICT	cd_dieta_w,
			nr_prescricao_w,
			nr_sequencia_w
		from	prescr_mat_alteracao c,
			prescr_dieta_hor b,
			prescr_dieta a
		where	c.nr_seq_horario_dieta = b.nr_sequencia
		and	b.nr_prescricao	= a.nr_prescricao
		and	b.nr_seq_dieta	= a.nr_sequencia
		and	c.nr_sequencia	= nr_seq_alter_p;
	
		if (ie_ds_w = 'S') then
		
			open C01;
			loop
			fetch C01 into	
				nr_seq_horario_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				begin

				select	max(nr_sequencia)
				into STRICT	nr_seq_alter_w
				from	prescr_mat_alteracao
				where	nr_prescricao = nr_prescricao_w
				and	nr_seq_horario_dieta = nr_seq_horario_w;
				
				update	prescr_mat_alteracao
				set	ds_observacao = substr(ds_observacao_p,1,2000)
				where	nr_sequencia = nr_seq_alter_w;				
				
				end;
			end loop;
			close C01;		
		
		else
		
			open C02;
			loop
			fetch C02 into	
				nr_seq_horario_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin

				select	max(nr_sequencia)
				into STRICT	nr_seq_alter_w
				from	prescr_mat_alteracao
				where	nr_prescricao = nr_prescricao_w
				and	nr_seq_horario_dieta = nr_seq_horario_w;
				
				update	prescr_mat_alteracao
				set	ds_observacao = substr(ds_observacao_p,1,2000)
				where	nr_sequencia = nr_seq_alter_w;				
				
				end;
			end loop;
			close C02;				
		
		end if;	
	
	end if;
	
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE plt_atualiza_obs_evento ( nr_seq_alter_p bigint, ie_tipo_item_p text, ds_observacao_p text, nm_usuario_p text) FROM PUBLIC;

