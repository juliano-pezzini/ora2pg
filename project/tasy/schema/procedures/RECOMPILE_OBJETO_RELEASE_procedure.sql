-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE recompile_objeto_release ( CD_VERSAO_P text, NR_RELEASE_P bigint, NM_USUARIO_P text) AS $body$
DECLARE


ds_comando_w	    text;
ds_comando_linha_w	text;
nr_index_original_w	bigint;
nr_index_final_w	bigint;
nr_byte_w			bigint;
i					bigint;
i_fim_w				bigint;
c					bigint;
RES                 bigint;
script_list_w       DBMS_SQL.VARCHAR2A;

  CC RECORD;

BEGIN
FOR CC IN (SELECT DS_SCRIPT_OBJETO, NR_SEQUENCIA FROM OBJETO_RELEASE_BKP WHERE CD_VERSAO = CD_VERSAO_P AND NR_RELEASE = NR_RELEASE_P ORDER BY NR_SEQUENCIA) LOOP

    DS_COMANDO_W := CC.DS_SCRIPT_OBJETO;
    ds_comando_w:= replace(ds_comando_w,CHR(13)||CHR(10),CHR(10));
    select (length(ds_comando_w) - length(replace(ds_comando_w, CHR(10),'')))
    into STRICT	i_fim_w
;

    i:= 0;
    nr_byte_w:= 1;
    nr_index_original_w:= 1;

    while(i < i_fim_w+1) loop

        i:= i+1;
        ds_comando_linha_w:= substr(ds_comando_w,nr_index_original_w,1000);
        nr_index_final_w:= position(CHR(10) in ds_comando_linha_w);
        if (nr_index_final_w = 0) and (i = i_fim_w+1) then
            nr_index_final_w:= 1000;
        end if;
        script_list_w(nr_byte_w) := substr(ds_comando_w,nr_index_original_w-1,nr_index_final_w);
        nr_index_original_w:= nr_index_original_w+nr_index_final_w+1;
        nr_byte_w:= nr_byte_w+1;

    end loop;

    c := DBMS_SQL.open_cursor;
    DBMS_SQL.parse(c, script_list_w, 1,nr_byte_w-1, TRUE, DBMS_SQL.NATIVE);
    res := DBMS_SQL.execute(c);
    DBMS_SQL.close_cursor(c);

    UPDATE OBJETO_RELEASE_BKP
       SET NM_USUARIO = NM_USUARIO_P
         , DT_ATUALIZACAO = clock_timestamp()
         , IE_STATUS = 'R'
     WHERE NR_SEQUENCIA = CC.NR_SEQUENCIA;
    COMMIT;
END LOOP;
CALL VALIDA_OBJETOS_SISTEMA();
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE recompile_objeto_release ( CD_VERSAO_P text, NR_RELEASE_P bigint, NM_USUARIO_P text) FROM PUBLIC;

