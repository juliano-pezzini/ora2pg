-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_saldo_adiantamento (nr_adiantamento_p bigint, nm_usuario_p text, nr_titulo_p bigint, vl_cotacao_p bigint default null) AS $body$
DECLARE


/* Projeto Multimoeda - Adicionado o parametro vl_cotacao_p com default null, onde sera passado o valor da cotacao que sera utilizado para converter o saldo em moeda estrangeira.
	Parametro adicionado como default para nao interferir no processo atual, nao sendo necessario passar o parametro quando nao se tratar de operacao em moeda estrangeira,
	as chamadas da procedure onde nao se tratar de transacao multimoeda nao precisa passar o parametro. */
vl_saldo_adiant_w	double precision	:= 0;
dt_baixa_w		timestamp;
ie_utiliza_data_tit_w	varchar(1);
cd_estab_w		smallint;
nr_seq_dev_w		bigint;
ie_utiliza_data_dev_w	varchar(1);
/* Projeto Multimoeda - Variaveis */

cd_moeda_w		integer;
vl_adto_estrang_w	double precision;
vl_saldo_estrang_w	double precision;


BEGIN

select	max(cd_estabelecimento),
	max(vl_adto_estrang),  /* Projeto Multimoeda - busca o valor do adiantamento e a moeda para verificar se e um adiantamento em moeda estrangeira. */
	max(cd_moeda)
into STRICT	cd_estab_w,
	vl_adto_estrang_w,
	cd_moeda_w
from	adiantamento
where	nr_adiantamento = nr_adiantamento_p;

/* Projeto Multimoeda - verifica se o adiantamento e em moeda estrangeira, se sim busca o saldo em moeda estrangeira, se nao mantem o processo atual */

if (coalesce(vl_adto_estrang_w,0) <> 0 and coalesce(vl_cotacao_p,0) <> 0 and (cd_moeda_w IS NOT NULL AND cd_moeda_w::text <> '')) then
	select	obter_saldo_adiantamento(nr_adiantamento_p, clock_timestamp())
	into STRICT	vl_saldo_estrang_w
	;
else
	select	obter_saldo_adiantamento(nr_adiantamento_p, clock_timestamp())
	into STRICT	vl_saldo_adiant_w
	;
end if;

ie_utiliza_data_tit_w	:= obter_valor_param_usuario(801,149,obter_perfil_ativo,nm_usuario_p,cd_estab_w);
ie_utiliza_data_dev_w	:= obter_valor_param_usuario(802,45,obter_perfil_ativo,nm_usuario_p,cd_estab_w);

if ( coalesce(nr_titulo_p,0) <> 0 ) and (ie_utiliza_data_tit_w = 'S') then

	select	max(dt_recebimento)
	into STRICT	dt_baixa_w
	from	titulo_receber_liq a
	where	nr_sequencia	=
		(SELECT	max(x.nr_sequencia)
		from	titulo_receber_liq x
		where	x.nr_adiantamento	= nr_adiantamento_p
		and	x.nr_titulo		= nr_titulo_p)
	and	nr_adiantamento	= nr_adiantamento_p
	and	nr_titulo	= nr_titulo_p;
else
	dt_baixa_w	:= clock_timestamp();
end if;

/* Projeto Multimoeda - Verifica se o adiantamento e em moeda estrangeira, se sim atualiza o saldo em moeda estrangeira e converte para moeda nacional, se nao mantem o processo atual*/

if (coalesce(vl_adto_estrang_w,0) <> 0 and coalesce(vl_cotacao_p,0) <> 0 and (cd_moeda_w IS NOT NULL AND cd_moeda_w::text <> '')) then
	update 	adiantamento
	set	vl_saldo_estrang = vl_saldo_estrang_w,
		vl_saldo	= vl_saldo_estrang_w * vl_cotacao_p,
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp(),
		dt_baixa	= CASE WHEN vl_saldo_estrang_w=0 THEN  coalesce(dt_baixa,dt_baixa_w)  ELSE null END
	where	nr_adiantamento = nr_adiantamento_p;
else
	update	adiantamento
	set 	vl_saldo		= vl_saldo_adiant_w,
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp(),
		dt_baixa		= CASE WHEN vl_saldo_adiant_w=0 THEN  coalesce(dt_baixa, dt_baixa_w)  ELSE null END
	where	nr_adiantamento		= nr_adiantamento_p;
end if;

if (coalesce(ie_utiliza_data_dev_w,'N') in ('S','D')) then

	select	max(nr_sequencia)
	into STRICT	nr_seq_dev_w
	from	adiantamento_dev
	where	nr_adiantamento = nr_adiantamento_p;
	
	if (coalesce(nr_seq_dev_w,0) > 0) then
		CALL atualizar_data_adiantamento(nr_seq_dev_w,nr_adiantamento_p,nm_usuario_p,'N', ie_utiliza_data_dev_w); -- 'N' para o IE_COMMIT.
	end if;

end if;

--commit; Edgar 01/10/2004 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_saldo_adiantamento (nr_adiantamento_p bigint, nm_usuario_p text, nr_titulo_p bigint, vl_cotacao_p bigint default null) FROM PUBLIC;

