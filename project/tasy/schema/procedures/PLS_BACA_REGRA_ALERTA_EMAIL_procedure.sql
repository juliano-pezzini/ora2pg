-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_baca_regra_alerta_email ( nm_usuario_p text) AS $body$
DECLARE



ds_regra_email_w		varchar(255);
ds_assunto_w			varchar(255);
ds_email_w			varchar(4000);
ie_situacao_w			varchar(1);
nr_sequencia_w			bigint;
cd_estabelecimento_w		smallint;
ie_aplicacao_regra_w		varchar(1);
dt_atualizacao_w		timestamp;
nm_usuario_w			varchar(15);
dt_atualizacao_nrec_w		timestamp;
nm_usuario_nrec_w		varchar(15);
nr_seq_alerta_evento_mens_w	bigint;
nr_seq_tipo_alerta_evento_w	bigint;

C01 CURSOR FOR
	SELECT	ds_regra_email,
		ds_assunto,
		ds_email,
		ie_situacao,
		nr_sequencia,
		cd_estabelecimento,
		ie_aplicacao_regra,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec
	from	pls_analise_aut_email;



BEGIN

select	nextval('pls_tipo_alerta_evento_seq')
into STRICT	nr_seq_tipo_alerta_evento_w
;

insert into pls_tipo_alerta_evento(ds_evento, ie_situacao ,nr_sequencia,
	dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
	nm_usuario_nrec)
values ('Auditor externo', 'A', nr_seq_tipo_alerta_evento_w,
	clock_timestamp(), nm_usuario_p, clock_timestamp(),
	nm_usuario_p);

open C01;
loop
fetch C01 into
	ds_regra_email_w,
	ds_assunto_w,
	ds_email_w,
	ie_situacao_w,
	nr_sequencia_w,
	cd_estabelecimento_w,
	ie_aplicacao_regra_w,
	dt_atualizacao_w,
	nm_usuario_w,
	dt_atualizacao_nrec_w,
	nm_usuario_nrec_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	nextval('pls_alerta_evento_mensagem_seq')
	into STRICT	nr_seq_alerta_evento_mens_w
	;

	insert into pls_alerta_evento_mensagem(ds_titulo, ds_mensagem, ie_tipo_envio,
		ds_remetente_sms, ds_remetente_email,ie_situacao,
		nr_sequencia, nr_seq_tipo_evento,dt_atualizacao,
		nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec)
	values (ds_assunto_w, ds_email_w, 'AE',
		null, null, ie_situacao_w,
		nr_seq_alerta_evento_mens_w, nr_seq_tipo_alerta_evento_w,dt_atualizacao_w,
		nm_usuario_w,dt_atualizacao_nrec_w,nm_usuario_nrec_w);

	insert into pls_alerta_evento_destino(nm_usuario_destino,ie_tipo_pessoa_dest,ie_forma_envio,
		ie_situacao,nr_sequencia,nr_seq_evento_mens,
		dt_atualizacao,nm_usuario,dt_atualizacao_nrec,
		nm_usuario_nrec)
	values (null,'AU','EM',
		'A',nextval('pls_alerta_evento_destino_seq'),nr_seq_alerta_evento_mens_w,
		clock_timestamp(),nm_usuario_w,clock_timestamp(),
		nm_usuario_w);

	insert into pls_regra_geracao_evento(ie_tipo_grupo_auditor, nr_seq_evento_mens, ie_situacao,
		nr_sequencia, ie_evento_disparo, dt_atualizacao,
		nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec)
	values (ie_aplicacao_regra_w, nr_seq_alerta_evento_mens_w, 'A',
		nextval('pls_regra_geracao_evento_seq'), 2, clock_timestamp(),
		nm_usuario_w, clock_timestamp(), nm_usuario_w);

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_baca_regra_alerta_email ( nm_usuario_p text) FROM PUBLIC;

