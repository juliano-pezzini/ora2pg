-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_pf_solicitacao_aghos (nr_internacao_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text) AS $body$
DECLARE


cd_pessoa_atend_w	varchar(10);
ds_stack_w		varchar(4000);


BEGIN

begin
	select	cd_pessoa_fisica
	into STRICT	cd_pessoa_atend_w
	from	solicitacao_tasy_aghos
	where	nr_atend_original =    (SELECT	max(nr_atend_original)
					from	solicitacao_tasy_aghos
					where	nr_internacao = nr_internacao_p)  LIMIT 1;
exception
when others then
	cd_pessoa_atend_w := cd_pessoa_fisica_p;
end;

update	solicitacao_tasy_aghos
set	cd_pessoa_fisica = cd_pessoa_fisica_p
where	nr_internacao = nr_internacao_p;

if (cd_pessoa_atend_w <> cd_pessoa_fisica_p) then
	ds_stack_w	:= substr('Internacao: ' || nr_internacao_p || ' --- Stack --- ',1,4000);
	ds_stack_w	:= ds_stack_w || substr(dbms_utility.format_call_stack,1,4000);

	insert into log_mov(DT_ATUALIZACAO, NM_USUARIO, DS_LOG, CD_LOG) values (clock_timestamp(),'LOG_PESSOA_TASY',ds_stack_w,45675);

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_pf_solicitacao_aghos (nr_internacao_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text) FROM PUBLIC;

