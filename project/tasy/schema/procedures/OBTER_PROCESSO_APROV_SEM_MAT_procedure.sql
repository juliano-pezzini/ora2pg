-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_processo_aprov_sem_mat ( cd_centro_custo_p bigint, cd_setor_atendimento_p bigint, cd_local_Estoque_p bigint, ie_tipo_processo_p text, ie_urgente_p text, cd_estabelecimento_p bigint, cd_perfil_ativo_p bigint, nr_seq_proj_rec_p bigint, nr_documento_p bigint, cd_processo_Aprov_p INOUT bigint) AS $body$
DECLARE

 
cd_Processo_Aprov_w		bigint;
ie_tipo_requisicao_w		varchar(3);

/*ATENÇÃO: Esta procedure obriga que a regra possua centro de custo*/
 
 
c01 CURSOR FOR 
	SELECT	a.cd_processo_aprov 
	from	Processo_Aprov_Estrut a, 
		processo_aprovacao b 
	where	a.cd_processo_aprov 					= b.cd_processo_aprov 
	and	b.ie_situacao <> 'I' 
	and	(a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> '') 
	and	a.cd_centro_custo = cd_centro_custo_p 
	and	((coalesce(a.cd_perfil::text, '') = '') or (coalesce(cd_perfil_ativo_p::text, '') = '') or (a.cd_perfil = cd_perfil_ativo_p)) 
	and	coalesce(a.cd_estabelecimento, cd_estabelecimento_p)			= cd_estabelecimento_p 
	and	coalesce(b.cd_estabelecimento, cd_estabelecimento_p)			= cd_estabelecimento_p 
	and	coalesce(a.cd_setor_atendimento,coalesce(cd_setor_atendimento_p,0))	= coalesce(cd_setor_atendimento_p,0) 
	and	coalesce(a.cd_local_estoque,coalesce(cd_local_estoque_p,0))		= coalesce(cd_local_Estoque_p,coalesce(a.cd_local_estoque,0)) 
	and	coalesce(a.nr_seq_proj_rec,coalesce(nr_seq_proj_rec_p,0))			= coalesce(nr_seq_proj_rec_p,0) 
	and	((ie_urgente = 'A') or (ie_urgente = ie_urgente_p)) 
	and	((coalesce(a.vl_compra_mes, 0) = 0) or (coalesce(a.vl_compra_mes, 0) < Obter_vl_compra_mes_proc_aprov(a.nr_sequencia, a.cd_processo_aprov))) 
	and	a.cd_processo_aprov in( 
			SELECT	cd_processo_aprov 
			from	processo_aprov_resp 
			where	ie_solicitacao_compra 	= 'S' 
			and	ie_tipo_processo_p		= 'S'	/*Solicitação*/
 
			
union
 
			select	cd_processo_aprov 
			from	processo_aprov_resp 
			where	ie_solicitacao_pagto 	= 'S' 
			and	ie_tipo_processo_p		= 'P' /*Solicitação pagamento*/
 
			
union
 
			select	cd_processo_aprov 
			from	processo_aprov_resp 
			where	ie_ordem_compra		= 'S' 
			and	ie_tipo_processo_p		= 'O' /*Ordem compra*/
 
			
union
 
			select	cd_processo_aprov 
			from	processo_aprov_resp 
			where	ie_ordem_compra_transf	= 'S' 
			and	ie_tipo_processo_p		= 'T' /*Ordem transferencia*/
 
			
union
 
			select	cd_processo_aprov 
			from	processo_aprov_resp 
			where	coalesce(ie_cotacao,'N')		= 'S' 
			and	ie_tipo_processo_p		= 'C' /*Cotação*/
 
			
union
 
			select	cd_processo_aprov 
			from	processo_aprov_resp 
			where	coalesce(ie_nota_fiscal,'N')		= 'S' 
			and	ie_tipo_processo_p		= 'N' /*Nota fiscal*/
 
			
union
 
			select	x.cd_processo_aprov 
			from	processo_aprov_resp x 
			where	x.ie_requisicao		= 'S' 
			and	ie_tipo_processo_p		= 'R' 
			and	((ie_tipo_requisicao_w	<> '2') or 
				((ie_tipo_requisicao_w	= '2') and (coalesce(x.ie_desconsidera_req_transf,'N') = 'N')))) 
	order by	coalesce(cd_material,0), 
		coalesce(cd_classe_material,0), 
		coalesce(cd_subgrupo_material,0), 
		coalesce(cd_grupo_material,0), 
		coalesce(cd_local_estoque,0), 
		coalesce(cd_centro_custo,0), 
		coalesce(a.cd_setor_atendimento,0), 
		coalesce(a.cd_perfil,0);


BEGIN 
 
if (ie_tipo_processo_p = 'R') and (nr_documento_p > 0) then 
	 
	select	coalesce(max(ie_tipo_requisicao),0) 
	into STRICT	ie_tipo_requisicao_w 
	from	operacao_estoque a, 
		requisicao_material b 
	where	a.cd_operacao_estoque = b.cd_operacao_estoque 
	and	nr_requisicao = nr_documento_p;
end if;
 
open C01;
loop 
	fetch C01 into 
		cd_processo_aprov_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		cd_processo_aprov_p	:= cd_processo_aprov_w;
end loop;
close C01;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_processo_aprov_sem_mat ( cd_centro_custo_p bigint, cd_setor_atendimento_p bigint, cd_local_Estoque_p bigint, ie_tipo_processo_p text, ie_urgente_p text, cd_estabelecimento_p bigint, cd_perfil_ativo_p bigint, nr_seq_proj_rec_p bigint, nr_documento_p bigint, cd_processo_Aprov_p INOUT bigint) FROM PUBLIC;

