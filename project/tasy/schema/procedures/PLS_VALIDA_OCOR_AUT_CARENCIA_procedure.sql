-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_valida_ocor_aut_carencia ( nr_seq_ocor_combinada_p bigint, nr_seq_ocorrencia_p bigint, nr_seq_segurado_p bigint, nr_seq_motivo_glosa_p bigint, nr_seq_guia_p bigint, nr_seq_requisicao_p bigint, nr_seq_execucao_p bigint, ie_utiliza_filtro_p text, nr_seq_param1_p bigint, nr_seq_param2_p bigint, nr_seq_param3_p bigint, nr_seq_param4_p bigint, nr_seq_param5_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint ) AS $body$
DECLARE

 
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade: Atualizar os itens da guia conforme a geração de ocorrência combinada. 
------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[ ] Objetos do dicionário [ X] Tasy (Delphi/Java) [ ] Portal [ ] Relatórios [ ] Outros: 
 ------------------------------------------------------------------------------------------------------------------ 
Pontos de atenção: Performance. 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 
 
ie_gera_ocor_guia_neg_carenc_w		pls_validacao_aut_carencia.ie_gera_ocor_guia_neg_carencia%type;
cd_motivo_tiss_w			tiss_motivo_glosa.cd_motivo_tiss%type;
nr_seq_motivo_glosa_w			pls_guia_glosa.nr_seq_motivo_glosa%type;
ie_carater_internacao_w			pls_guia_plano.ie_carater_internacao%type;
ie_carater_atendimento_w		pls_requisicao.ie_carater_atendimento%type;

nr_seq_oc_benef_w			bigint;
ie_gerou_ocor_cabecalho_w		varchar(2);
ie_tipo_ocorrencia_w			varchar(2);
ie_gerar_ocorrencia_w			varchar(1);
ie_regra_w				varchar(2);
ie_tipo_item_w				bigint;
qt_glosa_proced_w			bigint;
qt_glosa_cabecalho_w			bigint;
qt_glosa_mat_w				bigint;
ie_tipo_guia_w				pls_guia_plano.ie_tipo_guia%type;

 
C01 CURSOR(nr_seq_guia_pc bigint) FOR 
	SELECT 	nr_sequencia, 
		cd_procedimento, 
		ie_origem_proced 
	from 	pls_guia_plano_proc 
	where 	nr_seq_guia 	= nr_seq_guia_pc;

C02 CURSOR(nr_seq_guia_pc bigint) FOR 
	SELECT 	nr_sequencia 
	from	pls_guia_plano_mat 
	where 	nr_seq_guia 	= nr_seq_guia_pc;

C03 CURSOR(nr_seq_guia_proc_pc bigint) FOR 
	SELECT 	nr_seq_motivo_glosa 
	from 	pls_guia_glosa 
	where 	nr_seq_guia_proc 	= nr_seq_guia_proc_pc;	
 
C04 CURSOR(nr_seq_guia_mat_pc bigint) FOR 
	SELECT 	nr_seq_motivo_glosa 
	from 	pls_guia_glosa 
	where 	nr_seq_guia_mat 	= nr_seq_guia_mat_pc;
	
C11 CURSOR(nr_seq_requisicao_pc bigint) FOR 
	SELECT 	nr_sequencia, 
		cd_procedimento, 
		ie_origem_proced 
	from 	pls_requisicao_proc 
	where 	nr_seq_requisicao 	= nr_seq_requisicao_pc;

C12 CURSOR(nr_seq_requisicao_pc bigint) FOR 
	SELECT 	nr_sequencia 
	from	pls_requisicao_mat 
	where 	nr_seq_requisicao 	= nr_seq_requisicao_pc;	
	 
C13 CURSOR(nr_seq_req_proc_pc bigint) FOR 
	SELECT 	nr_seq_motivo_glosa 
	from 	pls_requisicao_glosa 
	where 	nr_seq_req_proc 	= nr_seq_req_proc_pc;	
 
C14 CURSOR(nr_seq_req_mat_pc bigint) FOR 
	SELECT 	nr_seq_motivo_glosa 
	from 	pls_requisicao_glosa 
	where 	nr_seq_req_mat 		= nr_seq_req_mat_pc;

BEGIN 
 
begin 
	select	ie_gera_ocor_guia_neg_carencia 
	into STRICT	ie_gera_ocor_guia_neg_carenc_w 
	from	pls_validacao_aut_carencia 
	where	nr_seq_ocor_aut_combinada 	= nr_seq_ocor_combinada_p 
	and	ie_situacao	= 'A';
exception 
when others then 
	ie_gera_ocor_guia_neg_carenc_w	:= 'N';
end;
 
if (nr_seq_guia_p IS NOT NULL AND nr_seq_guia_p::text <> '') then 
 
	begin 
		select	ie_tipo_guia, 
			ie_carater_internacao 
		into STRICT	ie_tipo_guia_w, 
			ie_carater_internacao_w 
		from 	pls_guia_plano 
		where	nr_sequencia	= nr_seq_guia_p;
	exception 
	when others then 
		ie_carater_internacao_w	:= null;
	end;
	-- Se for guia de prorrogação de internação, busca o ie_carater_internacao da guia princial 
	if (ie_tipo_guia_w = '8') then 
		begin		 
			select	ie_carater_internacao 
			into STRICT	ie_carater_internacao_w 
			from 	pls_guia_plano 
			where	nr_sequencia	= (	SELECT	nr_seq_guia_principal 
							from	pls_guia_plano 
							where	nr_sequencia = nr_seq_guia_p);
		exception 
		when others then 
			ie_carater_internacao_w	:= null;
		end;		
	end if;	
elsif (nr_seq_requisicao_p IS NOT NULL AND nr_seq_requisicao_p::text <> '') then 
	begin 
		select	ie_carater_atendimento 
		into STRICT	ie_carater_atendimento_w 
		from 	pls_requisicao 
		where	nr_sequencia	= nr_seq_requisicao_p;
	exception 
	when others then 
		ie_carater_internacao_w	:= null;
	end;
end if;
 
if (ie_gera_ocor_guia_neg_carenc_w 	= 'S') and (coalesce(ie_carater_internacao_w,ie_carater_atendimento_w) = 'U') then 
	if (nr_seq_guia_p IS NOT NULL AND nr_seq_guia_p::text <> '') then 
		select 	count(1) 
		into STRICT	qt_glosa_cabecalho_w 
		from 	pls_guia_glosa 
		where 	nr_seq_guia = nr_seq_guia_p;
		 
		if (qt_glosa_cabecalho_w = 0) then 
			for r_C01_w in C01(nr_seq_guia_p) loop 
				begin 
				select 	count(1) 
				into STRICT	qt_glosa_proced_w 
				from 	pls_guia_glosa 
				where 	nr_seq_guia_proc 	= r_C01_w.nr_sequencia;
 
				if (qt_glosa_proced_w > 0) then 
					 
					for r_C03_w in C03(r_C01_w.nr_sequencia) loop 
					begin 
						select 	cd_motivo_tiss 
						into STRICT	cd_motivo_tiss_w 
						from 	tiss_motivo_glosa 
						where	nr_sequencia 		= r_C03_w.nr_seq_motivo_glosa;
 
						if (cd_motivo_tiss_w = 1410) then	 
							ie_gerar_ocorrencia_w := 'S';
 
							if (ie_utiliza_filtro_p = 'S') then 
								/* Tratamento para filtros */
 
								SELECT * FROM pls_gerar_ocor_aut_filtro(	nr_seq_ocor_combinada_p, nr_seq_guia_p, null, null, r_C01_w.nr_sequencia, null, null, null, null, r_C01_w.cd_procedimento, r_C01_w.ie_origem_proced, null, ie_gerou_ocor_cabecalho_w, null, nr_seq_ocorrencia_p, null, null, null, nm_usuario_p, ie_regra_w, ie_tipo_ocorrencia_w) INTO STRICT ie_regra_w, ie_tipo_ocorrencia_w;
 
								if (ie_regra_w	= 'S') then 
									ie_gerar_ocorrencia_w	:= 'S';
								elsif (ie_regra_w	in ('E','N')) then 
									ie_gerar_ocorrencia_w	:= 'N';
									exit;
								end if;
							end if;
 
							if (ie_gerar_ocorrencia_w	= 'S')	then 
							 
								ie_tipo_item_w	:= 1;
 
								nr_seq_oc_benef_w := pls_inserir_ocorrencia(	nr_seq_segurado_p, nr_seq_ocorrencia_p, null, nr_seq_guia_p, null, r_C01_w.nr_sequencia, null, nr_seq_ocor_combinada_p, nm_usuario_p, null, nr_seq_motivo_glosa_p, ie_tipo_item_w, cd_estabelecimento_p, 'N', null, nr_seq_oc_benef_w, null, null, null, null);
 
								CALL pls_atualizar_status_ocor_comb(	nr_seq_ocorrencia_p, nr_seq_ocor_combinada_p, nr_seq_motivo_glosa_p, 
												nr_seq_guia_p, null, null, 
												r_C01_w.nr_sequencia, null, null, 
												null, null, null, 
												nm_usuario_p, cd_estabelecimento_p);
							end if;
						end if;
					end;
					end loop;
				end if;
				end;
			end loop;
 
			for r_C02_w in C02(nr_seq_guia_p) loop 
				begin 
				select 	count(1) 
				into STRICT	qt_glosa_mat_w 
				from 	pls_guia_glosa 
				where 	nr_seq_guia_mat 	= r_C02_w.nr_sequencia;
 
				if (qt_glosa_mat_w > 0) then 
				 
					for r_C04_w in C04(r_C02_w.nr_sequencia) loop 
					begin 
						select 	cd_motivo_tiss 
						into STRICT	cd_motivo_tiss_w 
						from 	tiss_motivo_glosa 
						where	nr_sequencia 		= r_C04_w.nr_seq_motivo_glosa;
 
						if (cd_motivo_tiss_w = 1410) then	 
							ie_gerar_ocorrencia_w := 'S';
 
							if (ie_utiliza_filtro_p = 'S') then 
								/* Tratamento para filtros */
 
								SELECT * FROM pls_gerar_ocor_aut_filtro(	nr_seq_ocor_combinada_p, nr_seq_guia_p, null, null, null, r_C02_w.nr_sequencia, null, null, null, null, null, null, ie_gerou_ocor_cabecalho_w, null, nr_seq_ocorrencia_p, null, null, null, nm_usuario_p, ie_regra_w, ie_tipo_ocorrencia_w) INTO STRICT ie_regra_w, ie_tipo_ocorrencia_w;
 
								if (ie_regra_w	= 'S') then 
									ie_gerar_ocorrencia_w	:= 'S';
								elsif (ie_regra_w	in ('E','N')) then 
									ie_gerar_ocorrencia_w	:= 'N';
									exit;
								end if;
							end if;
						end if;
 
						if (ie_gerar_ocorrencia_w	= 'S')	then 
							ie_tipo_item_w	:= 1;
 
							nr_seq_oc_benef_w := pls_inserir_ocorrencia(	nr_seq_segurado_p, nr_seq_ocorrencia_p, null, nr_seq_guia_p, null, null, r_C02_w.nr_sequencia, nr_seq_ocor_combinada_p, nm_usuario_p, null, nr_seq_motivo_glosa_p, ie_tipo_item_w, cd_estabelecimento_p, 'N', null, nr_seq_oc_benef_w, null, null, null, null);
 
							CALL pls_atualizar_status_ocor_comb(	nr_seq_ocorrencia_p, nr_seq_ocor_combinada_p, nr_seq_motivo_glosa_p, 
											nr_seq_guia_p, null, null, 
											null, r_C02_w.nr_sequencia, null, 
											null, null, null, 
											nm_usuario_p, cd_estabelecimento_p);
						end if;						
					end;
					end loop;
				end if;
				end;
			end loop;
		end if;
	elsif (nr_seq_requisicao_p IS NOT NULL AND nr_seq_requisicao_p::text <> '') then 
 
		select 	count(1) 
		into STRICT	qt_glosa_cabecalho_w 
		from 	pls_requisicao_glosa 
		where 	nr_seq_requisicao	= nr_seq_requisicao_p;
 
		if (qt_glosa_cabecalho_w = 0) then 
			for r_C11_w in C11(nr_seq_requisicao_p) loop 
				begin 
				select 	count(1) 
				into STRICT	qt_glosa_proced_w 
				from 	pls_requisicao_glosa 
				where 	nr_seq_req_proc 	= r_C11_w.nr_sequencia;
 
				if (qt_glosa_proced_w > 0) then 
					 
					for r_C13_w in C13(r_C11_w.nr_sequencia) loop 
					begin 
						select 	cd_motivo_tiss 
						into STRICT	cd_motivo_tiss_w 
						from 	tiss_motivo_glosa 
						where	nr_sequencia 		= r_C13_w.nr_seq_motivo_glosa;
 
						if (cd_motivo_tiss_w = 1410) then 
							ie_gerar_ocorrencia_w := 'S';
 
							if (ie_utiliza_filtro_p = 'S') then 
								/* Tratamento para filtros */
 
								SELECT * FROM pls_gerar_ocor_aut_filtro(	nr_seq_ocor_combinada_p, null, nr_seq_requisicao_p, null, null, null, r_C11_w.nr_sequencia, null, null, r_C11_w.cd_procedimento, r_C11_w.ie_origem_proced, null, ie_gerou_ocor_cabecalho_w, null, nr_seq_ocorrencia_p, null, null, null, nm_usuario_p, ie_regra_w, ie_tipo_ocorrencia_w) INTO STRICT ie_regra_w, ie_tipo_ocorrencia_w;
 
								if (ie_regra_w	= 'S') then 
									ie_gerar_ocorrencia_w	:= 'S';
								elsif (ie_regra_w	in ('E','N')) then 
									ie_gerar_ocorrencia_w	:= 'N';
									exit;
								end if;
							end if;
 
							if (ie_gerar_ocorrencia_w	= 'S')	then 
								ie_tipo_item_w	:= 9;
 
								nr_seq_oc_benef_w := pls_inserir_ocorrencia(	nr_seq_segurado_p, nr_seq_ocorrencia_p, nr_seq_requisicao_p, null, null, r_C11_w.nr_sequencia, null, nr_seq_ocor_combinada_p, nm_usuario_p, null, nr_seq_motivo_glosa_p, ie_tipo_item_w, cd_estabelecimento_p, 'N', null, nr_seq_oc_benef_w, null, null, null, null);
 
								CALL pls_atualizar_status_ocor_comb(	nr_seq_ocorrencia_p, nr_seq_ocor_combinada_p, nr_seq_motivo_glosa_p, 
												null, nr_seq_requisicao_p, null, 
												null, null, r_C11_w.nr_sequencia, 
												null, null, null, 
												nm_usuario_p, cd_estabelecimento_p);
							end if;
						end if;						
					end;
					end loop;
				end if;
				end;
			end loop;
 
			for r_C12_w in C12(nr_seq_requisicao_p) loop 
				begin 
				select 	count(1) 
				into STRICT	qt_glosa_mat_w 
				from 	pls_requisicao_glosa 
				where 	nr_seq_req_mat 	= r_C12_w.nr_sequencia;
 
				if (qt_glosa_mat_w > 0) then 
				 
					for r_C14_w in C14(r_C12_w.nr_sequencia) loop 
					begin 
						select 	cd_motivo_tiss 
						into STRICT	cd_motivo_tiss_w 
						from 	tiss_motivo_glosa 
						where	nr_sequencia 		= r_C14_w.nr_seq_motivo_glosa;
 
						if (cd_motivo_tiss_w = 1410) then	 
							ie_gerar_ocorrencia_w := 'S';
 
							if (ie_utiliza_filtro_p = 'S') then 
								/* Tratamento para filtros */
 
								SELECT * FROM pls_gerar_ocor_aut_filtro(	nr_seq_ocor_combinada_p, null, nr_seq_requisicao_p, null, null, null, null, r_C12_w.nr_sequencia, null, null, null, null, ie_gerou_ocor_cabecalho_w, null, nr_seq_ocorrencia_p, null, null, null, nm_usuario_p, ie_regra_w, ie_tipo_ocorrencia_w) INTO STRICT ie_regra_w, ie_tipo_ocorrencia_w;
 
								if (ie_regra_w	= 'S') then 
									ie_gerar_ocorrencia_w	:= 'S';
								elsif (ie_regra_w	in ('E','N')) then 
									ie_gerar_ocorrencia_w	:= 'N';
									exit;
								end if;
							end if;
 
							if (ie_gerar_ocorrencia_w	= 'S')	then 
								ie_tipo_item_w	:= 9;
 
								nr_seq_oc_benef_w := pls_inserir_ocorrencia(	nr_seq_segurado_p, nr_seq_ocorrencia_p, nr_seq_requisicao_p, null, null, null, r_C12_w.nr_sequencia, nr_seq_ocor_combinada_p, nm_usuario_p, null, nr_seq_motivo_glosa_p, ie_tipo_item_w, cd_estabelecimento_p, 'N', null, nr_seq_oc_benef_w, null, null, null, null);
 
								CALL pls_atualizar_status_ocor_comb(	nr_seq_ocorrencia_p, nr_seq_ocor_combinada_p, nr_seq_motivo_glosa_p, 
												null, nr_seq_requisicao_p, null, 
												null, null, null, 
												r_C12_w.nr_sequencia, null, null, 
												nm_usuario_p, cd_estabelecimento_p);
							end if;	
						end if;					
					end;
					end loop;
				end if;
				end;
			end loop;
		end if;	
	end if;	
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_valida_ocor_aut_carencia ( nr_seq_ocor_combinada_p bigint, nr_seq_ocorrencia_p bigint, nr_seq_segurado_p bigint, nr_seq_motivo_glosa_p bigint, nr_seq_guia_p bigint, nr_seq_requisicao_p bigint, nr_seq_execucao_p bigint, ie_utiliza_filtro_p text, nr_seq_param1_p bigint, nr_seq_param2_p bigint, nr_seq_param3_p bigint, nr_seq_param4_p bigint, nr_seq_param5_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint ) FROM PUBLIC;

