-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE toggle_closing_pamec ( nr_seq_qua_pamec_p bigint) AS $body$
DECLARE

        dt_encerramento_w       qua_pamec.dt_encerramento%type;
        ds_historico_w          qua_pamec_historico.ds_historico%type;
        nm_usuario_w            qua_pamec.nm_usuario%type;

BEGIN
        select  max(dt_encerramento)
        into STRICT    dt_encerramento_w
        from    qua_pamec
        where   nr_sequencia = nr_seq_qua_pamec_p;

        nm_usuario_w := wheb_usuario_pck.get_nm_usuario;


        if (coalesce(dt_encerramento_w::text, '') = '') then
                dt_encerramento_w := clock_timestamp();
                ds_historico_w := 502528;
        else
                dt_encerramento_w := null;
                ds_historico_w := 348715;
        end if;


        update  qua_pamec
        set     dt_encerramento = dt_encerramento_w,
                nm_usuario      = nm_usuario_w,
                dt_atualizacao  = clock_timestamp()
        where   nr_sequencia = nr_seq_qua_pamec_p;

        CALL qua_inserir_pamec_historico(nr_seq_qua_pamec_p, ds_historico_w, nm_usuario_w);

        CALL pamec_calculate_actions(nr_seq_qua_pamec_p, dt_encerramento_w, nm_usuario_w);
        commit;
End;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE toggle_closing_pamec ( nr_seq_qua_pamec_p bigint) FROM PUBLIC;

