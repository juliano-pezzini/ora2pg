-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE carrega_horarios_consultorios ( CD_SETOR_ATENDIMENTO_P bigint, CD_ESPECIALIDADE_P bigint, DT_AGENDA_P timestamp, NR_SEQ_SALA_P bigint, CD_MEDICO_P text, IE_SOMENTE_OCUPADOS_P text, CD_ESTABELECIMENTO_P bigint, NM_USUARIO_P text ) AS $body$
DECLARE

 
HR_HORARIO_W		timestamp;
HR_PROX_HORARIO_W	timestamp;	
IE_SOBREPOSTO_W		varchar(1);	
IE_HORARIO_EXISTENTE_W	varchar(1);			
 
C_HORARIOS CURSOR FOR 
	SELECT	TO_DATE('01/01/2000' || TO_CHAR(B.HR_INICIAL, 'HH24:MI'), 'DD/MM/YYYY HH24:MI:SS') HR_INICIAL, 
		TO_DATE('01/01/2000' || TO_CHAR(B.HR_FINAL, 'HH24:MI'), 'DD/MM/YYYY HH24:MI:SS') HR_FINAL, 
		B.NR_MINUTO_INTERVALO, 
		B.NR_SEQ_SALA, 
		C.CD_PESSOA_FISICA, 
		C.CD_AGENDA 
	FROM agenda_sala_consulta a
LEFT OUTER JOIN agenda_turno b ON (A.NR_SEQUENCIA = B.NR_SEQ_SALA)
LEFT OUTER JOIN agenda c ON (B.CD_AGENDA = C.CD_AGENDA)
WHERE (B.NR_SEQ_SALA IS NOT NULL AND B.NR_SEQ_SALA::text <> '') AND (C.CD_PESSOA_FISICA IS NOT NULL AND C.CD_PESSOA_FISICA::text <> '') AND A.IE_SITUACAO = 'A' AND coalesce(A.CD_ESTABELECIMENTO, CD_ESTABELECIMENTO_P) = CD_ESTABELECIMENTO_P AND ((IE_SOMENTE_OCUPADOS_P = 'S' AND B.NR_SEQ_SALA IS NOT NULL AND B.NR_SEQ_SALA::text <> '') OR (IE_SOMENTE_OCUPADOS_P = 'N')) AND (((IE_SOMENTE_OCUPADOS_P = 'S') AND (C.IE_SITUACAO = 'A') AND C.CD_TIPO_AGENDA = 3) OR (IE_SOMENTE_OCUPADOS_P = 'N')) AND ((A.NR_SEQUENCIA = NR_SEQ_SALA_P) OR (NR_SEQ_SALA_P = 0)) AND ((A.CD_SETOR_ATENDIMENTO = CD_SETOR_ATENDIMENTO_P) OR (CD_SETOR_ATENDIMENTO_P = 0)) AND ((C.CD_ESPECIALIDADE = CD_ESPECIALIDADE_P) OR (CD_ESPECIALIDADE_P = 0)) AND ((C.CD_PESSOA_FISICA = CD_MEDICO_P) OR (CD_MEDICO_P = '0')) AND ((OBTER_COD_DIA_SEMANA(DT_AGENDA_P) = B.IE_DIA_SEMANA) OR (B.IE_DIA_SEMANA = '9' AND OBTER_COD_DIA_SEMANA(DT_AGENDA_P) NOT IN ('1','7'))) AND (TRUNC(DT_AGENDA_P) BETWEEN coalesce(B.DT_INICIO_VIGENCIA, TRUNC(DT_AGENDA_P)) AND coalesce(B.DT_FINAL_VIGENCIA, TRUNC(DT_AGENDA_P)));

BEGIN 
 
DELETE 
FROM	W_HORARIOS_CONSULTORIO 
WHERE	NM_USUARIO = NM_USUARIO_P;
 
FOR	R_C_HORARIOS IN C_HORARIOS LOOP 
	HR_HORARIO_W := R_C_HORARIOS.HR_INICIAL;
	 
	WHILE(	HR_HORARIO_W < R_C_HORARIOS.HR_FINAL) LOOP 
		HR_PROX_HORARIO_W := HR_HORARIO_W + R_C_HORARIOS.NR_MINUTO_INTERVALO / 1440;
		 
		IF (R_C_HORARIOS.NR_MINUTO_INTERVALO = 0) THEN 
			HR_PROX_HORARIO_W := HR_HORARIO_W + 1 / 24;
		END IF;
		 
		SELECT	CASE WHEN COUNT(*)=0 THEN 'N'  ELSE 'S' END  
		INTO STRICT	IE_SOBREPOSTO_W 
		FROM agenda_turno a
LEFT OUTER JOIN agenda b ON (A.CD_AGENDA = B.CD_AGENDA)
WHERE (A.NR_SEQ_SALA IS NOT NULL AND A.NR_SEQ_SALA::text <> '') AND B.CD_TIPO_AGENDA = 3 AND B.IE_SITUACAO = 'A' AND A.NR_SEQ_SALA = R_C_HORARIOS.NR_SEQ_SALA AND TO_CHAR(HR_HORARIO_W, 'HH24:MI') BETWEEN TO_CHAR(A.HR_INICIAL, 'HH24:MI') AND TO_CHAR(A.HR_FINAL, 'HH24:MI') AND TO_CHAR(HR_PROX_HORARIO_W, 'HH24:MI') BETWEEN TO_CHAR(A.HR_INICIAL, 'HH24:MI') AND TO_CHAR(A.HR_FINAL, 'HH24:MI') AND ((B.CD_PESSOA_FISICA <> R_C_HORARIOS.CD_PESSOA_FISICA) OR (coalesce(B.CD_PESSOA_FISICA::text, '') = '')) AND ((OBTER_COD_DIA_SEMANA(DT_AGENDA_P) = A.IE_DIA_SEMANA) OR (A.IE_DIA_SEMANA = 9 AND OBTER_COD_DIA_SEMANA(DT_AGENDA_P) NOT IN ('1','7'))) AND TRUNC(DT_AGENDA_P) BETWEEN coalesce(A.DT_INICIO_VIGENCIA, TRUNC(DT_AGENDA_P)) AND coalesce(A.DT_FINAL_VIGENCIA, TRUNC(DT_AGENDA_P));
	 
		SELECT	CASE WHEN COUNT(1)=0 THEN 'N'  ELSE 'S' END  
		INTO STRICT	IE_HORARIO_EXISTENTE_W 
		FROM	W_HORARIOS_CONSULTORIO A 
		WHERE	A.HR_INICIAL = HR_HORARIO_W 
		AND	A.NR_SEQ_SALA = R_C_HORARIOS.NR_SEQ_SALA 
		AND	A.CD_PESSOA_FISICA = R_C_HORARIOS.CD_PESSOA_FISICA 
		AND	A.NM_USUARIO = NM_USUARIO_P;
	 
		IF (IE_HORARIO_EXISTENTE_W = 'N') THEN 
			INSERT INTO W_HORARIOS_CONSULTORIO(	NR_SEQUENCIA, 
								HR_INICIAL, 
								HR_FINAL, 
								NR_SEQ_SALA, 
								CD_PESSOA_FISICA, 
								NM_USUARIO, 
								CD_AGENDA, 
								NR_MINUTO_INTERVALO, 
								IE_SOBREPOSTO) 
			VALUES (nextval('w_horarios_consultorio_seq'), 
				HR_HORARIO_W, 
				HR_PROX_HORARIO_W, 
				R_C_HORARIOS.NR_SEQ_SALA, 
				R_C_HORARIOS.CD_PESSOA_FISICA, 
				NM_USUARIO_P, 
				R_C_HORARIOS.CD_AGENDA, 
				R_C_HORARIOS.NR_MINUTO_INTERVALO, 
				IE_SOBREPOSTO_W);
		END IF;
		 
		HR_HORARIO_W := HR_PROX_HORARIO_W;
	END LOOP;
END LOOP;
 
COMMIT;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE carrega_horarios_consultorios ( CD_SETOR_ATENDIMENTO_P bigint, CD_ESPECIALIDADE_P bigint, DT_AGENDA_P timestamp, NR_SEQ_SALA_P bigint, CD_MEDICO_P text, IE_SOMENTE_OCUPADOS_P text, CD_ESTABELECIMENTO_P bigint, NM_USUARIO_P text ) FROM PUBLIC;

