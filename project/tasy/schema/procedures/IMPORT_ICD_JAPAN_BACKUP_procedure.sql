-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE import_icd_japan_backup ( nm_usuario_p text, return_v INOUT text ) AS $body$
DECLARE


    nm_usuario_w   varchar(15) := nm_usuario_p;
    is_version     bigint;
    nr_seq         bigint;
    is_chapter     bigint;
    is_category    bigint;
    is_code        bigint;

--version
    c0 CURSOR FOR
    SELECT
        MAX(nr_sequencia)
    FROM
        icd_version
    ORDER BY
        nr_sequencia DESC;


BEGIN
    INSERT INTO icd_version(
        nr_sequencia,
        dt_atualizacao,
        nm_usuario,
        dt_atualizacao_nrec,
        nm_usuario_nrec
    ) VALUES (
        nextval('icd_version_seq'),
        clock_timestamp(),
        nm_usuario_w,
        clock_timestamp(),
        nm_usuario_w
    );

    COMMIT;
    IF NOT c0%isopen THEN
        OPEN c0;
        FETCH c0 INTO nr_seq;
        BEGIN
            SELECT
                COUNT(*)
            INTO STRICT is_version
            FROM
                icd_version;

        END;
        IF ( is_version <> 0 OR (is_version IS NOT NULL AND is_version::text <> '') ) THEN
            BEGIN
                SELECT
                    COUNT(*)
                INTO STRICT is_chapter
                FROM
                    cid_especialidade;

                SELECT
                    COUNT(*)
                INTO STRICT is_category
                FROM
                    cid_categoria;

                SELECT
                    COUNT(*)
                INTO STRICT is_code
                FROM
                    cid_doenca;

                IF ( is_chapter <> 0 OR (is_chapter IS NOT NULL AND is_chapter::text <> '') ) THEN
                    INSERT INTO cid_especialidade_backup(
                        cd_especialidade_cid,
                        ds_especialidade_cid,
                        nr_version,
                        dt_atualizacao,
                        nm_usuario,
                        dt_atualizacao_nrec,
                        nm_usuario_nrec,
                        ie_situacao
                    )
                        SELECT
                            e.cd_especialidade_cid,
                            e.ds_especialidade_cid,
                            nr_seq,
                            clock_timestamp(),
                            e.nm_usuario,
                            clock_timestamp(),
                            e.nm_usuario_nrec,
                            e.ie_situacao
                        FROM
                            cid_especialidade e;

                END IF;

                IF ( is_category <> 0 OR (is_category IS NOT NULL AND is_category::text <> '') ) THEN
                    INSERT INTO cid_categoria_backup(
                        cd_categoria_cid,
                        ds_categoria_cid,
                        nr_version,
                        dt_atualizacao,
                        nm_usuario,
                        cd_especialidade,
                        ie_situacao,
                        dt_atualizacao_nrec,
                        nm_usuario_nrec
                    )
                        SELECT
                            c.cd_categoria_cid,
                            c.ds_categoria_cid,
                            nr_seq,
                            clock_timestamp(),
                            c.nm_usuario,
                            c.cd_especialidade,
                            c.ie_situacao,
                            clock_timestamp(),
                            c.nm_usuario_nrec
                        FROM
                            cid_categoria c;

                END IF;

                IF ( is_code <> 0 OR (is_code IS NOT NULL AND is_code::text <> '') ) THEN
                    INSERT INTO cid_doenca_backup(
                        cd_doenca_cid,
                        ds_doenca_cid,
                        nr_version,
                        cd_categoria_cid,
                        dt_atualizacao,
                        nm_usuario,
                        ie_cad_interno,
                        ie_situacao,
                        cd_versao,
                        cd_doenca,
                        ds_descricao_original,
                        dt_atualizacao_nrec,
                        nm_usuario_nrec,
                        nr_chng_segm,
                        nr_disease_number,
                        nr_adopted_category,
                        nr_code_exchange,
                        cd_multiclassif_code,
                        nr_rese_wound_code,
                        ds_disease_name,
                        nr_area_of_use,
                        nr_change_history,
                        dt_update,
                        nr_dstn_disease_number,
                        ie_prohibited_category,
                        ie_out_of_insurance,
                        ds_name_of_cana_disease,
                        nr_disease_name_code
                    )
                        SELECT
                            d.cd_doenca_cid,
                            d.ds_doenca_cid,
                            nr_seq,
                            d.cd_categoria_cid,
                            clock_timestamp(),
                            d.nm_usuario,
                            d.ie_cad_interno,
                            d.ie_situacao,
                            d.cd_versao,
                            d.cd_doenca,
                            d.ds_descricao_original,
                            clock_timestamp(),
                            d.nm_usuario_nrec,
                            d.nr_chng_segm,
                            d.nr_disease_number,
                            d.nr_adopted_category,
                            d.nr_code_exchange,
                            d.cd_multiclassif_code,
                            d.nr_rese_wound_code,
                            d.ds_disease_name,
                            d.nr_area_of_use,
                            d.nr_change_history,
                            d.dt_update,
                            d.nr_dstn_disease_number,
                            d.ie_prohibited_category,
                            d.ie_out_of_insurance,
                            d.ds_name_of_cana_disease,
                            d.nr_disease_name_code
                        FROM
                            cid_doenca d;

                END IF;

                COMMIT;
            END;
        END IF;

    END IF;

    return_v := 'S';
EXCEPTION
    WHEN OTHERS THEN
        return_v := 'N';
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE import_icd_japan_backup ( nm_usuario_p text, return_v INOUT text ) FROM PUBLIC;

