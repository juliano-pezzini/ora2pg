-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_gerar_w_guia_spsadt (nr_sequencia_autor_p bigint, nr_seq_protocolo_p bigint, nr_interno_conta_p bigint, ds_dir_padrao_p text, nr_seq_pedido_exame_p bigint, nr_prescr_tiss_p bigint, nr_seq_med_fatur_p text, nr_atend_conta_tiss_p text, nm_usuario_p text, ie_setor_prescr_p text, nr_seq_prot_med_p bigint, nr_seq_exame_p bigint, nr_atend_med_p bigint, nr_seq_paciente_p bigint, nr_prescricoes_p text, cd_evolucao_p bigint, ie_data_solic_pedido_p text, ie_ultima_prescricao_p text, nr_cirurgia_p bigint, nr_seq_checkup_p bigint, ie_somente_prescr_p text, nr_seq_reap_conta_p bigint, ds_imprimi_procedimento_p text default null, nr_ciclo_p bigint default null, ie_lista_desc_solic_exame_p text default 'ESLIP', ie_considera_dt_cpoe_p text default 'N', dt_inicial_p timestamp default null, dt_final_p timestamp default null, ds_imprimi_patologia_p text default null, ds_imprimi_hemoterapia_p text default null) AS $body$
DECLARE

ds_ret1	varchar(2000);
ds_ret2	varchar(2000);
cd_ans_w			varchar(255);
DT_PREV_EXECUCAO_w		timestamp;
ie_urgencia_w			varchar(255);
ie_obs_urgente_w		varchar(100);
cd_cbos_w			varchar(100);
nr_atendimento_w		bigint;
nr_interno_conta_w		bigint;
cd_autorizacao_w		varchar(100);
cd_autorizacao_ww		varchar(255);
ie_emitir_spsadt_zerado_w 	varchar(020);
ie_spsadt_zerado_w		varchar(020);
cd_procedimento_w		varchar(255);
cd_proc_solic_w			varchar(020);
ie_funcao_w			varchar(020);
qt_proc_guia_w			smallint;
nr_atend_w			bigint;
cd_senha_w			varchar(255);
dt_inicio_vigencia_w		timestamp;
dt_final_vigencia_w		timestamp;
dt_validade_senha_w		timestamp;
dt_emissao_guia_w		timestamp;
nr_seq_guia_w			bigint;
nr_seq_agenda_w			bigint;
nr_cpf_w			varchar(015);
ie_cid_exame_externo_w		varchar(015);
ds_cid_w			varchar(255);
cd_cgc_estab_w			varchar(255);
nm_medico_executor_w		varchar(255);
nm_medico_solic_w		varchar(255);
ds_obs_autor_w			varchar(4000);
sg_conselho_w			varchar(015);
nr_crm_w			varchar(020);
uf_crm_w			varchar(255);
cd_cbo_saude_w			varchar(020);
ie_tipo_atendimento_w		varchar(255);
ie_tipo_saida_w			varchar(020);
ds_inicacao_clinica_w		varchar(2000);
ds_justificativa_w		varchar(4000);
cd_edicao_amb_w			varchar(20);
IE_DESC_PROC_INTERNO_W		varchar(20);
cd_edicao_amb_solic_w		varchar(20);
cd_medico_executor_w		varchar(20);
ds_proced_convenio_w		varchar(255);
ie_tecnica_utilizada_w		varchar(20);
IE_EMITE_HONOR_SADT_PEP_w 	varchar(20);
ie_medico_rep_w			varchar(20);
ie_origem_proced_w		bigint;
qt_procedimento_w		double precision;
vl_reducao_acrescimo_w		double precision;
cd_categoria_conv_w		varchar(20);
vl_procedimento_w		double precision;
VL_TAXAS_w			double precision;
VL_DIARIAS_w			double precision;
VL_MEDICAMENTOS_w		double precision;
VL_MATERIAIS_w			double precision;
nr_seq_tipo_acidente_w		bigint;
VL_GASES_w			double precision;
vl_proc_total_w			double precision;
nr_seq_procedimento_w		bigint;
dt_entrada_w			timestamp;
dt_alta_w		 	timestamp;
ie_via_acesso_w			varchar(20);
vl_unitario_w			double precision;
ds_procedimento_w		varchar(255);
ds_proc_tab_w			varchar(255);
ds_proc_tabela_interno_w	varchar(255);
ds_proc_exame_proc_w		varchar(255);
ds_proc_procedimento_w		varchar(255);
ds_proced_solic_w		varchar(255);
dt_procedimento_w		timestamp;
vl_total_w			double precision	:= 0;
cont_w				integer	:= 0;
ds_razao_social_w		varchar(255);
cd_cnes_w			varchar(255);
cd_cgc_w			varchar(255);
ie_tipo_acidente_w		varchar(10);
ie_trazer_executor_w		varchar(10);
qt_solicitada_w			double precision;
qt_autorizada_w			double precision;
dt_autorizacao_w		timestamp;
cd_doenca_cid_w			varchar(255);
cd_doenca_cid_autor_w		varchar(255);
cd_cid_externo_w		varchar(255);
ds_observacao_w			varchar(255);
ds_observacao_autor_w		varchar(255);
ie_tipo_autorizacao_w		varchar(3);
nr_seq_guia_proc_w		bigint;
ds_arquivo_logo_w		varchar(140);
nr_seq_exame_w			bigint;
cd_medico_w			varchar(255);
dt_solicitacao_w		timestamp;
cd_opm_w			varchar(20);
vl_opm_w			double precision;
vl_opms_w			double precision;
vl_total_opm_w			double precision;
cd_edicao_w			varchar(20);
ds_opm_w			varchar(255);
ds_fabricante_w			varchar(255);
ds_carater_internacao_w		varchar(1);
ie_proc_solic_spsadt_w		varchar(3);
ie_tiss_tipo_guia_w		varchar(50);
cd_setor_atendimento_w		bigint;
cd_setor_execucao_w		bigint;
ie_carater_inter_sus_w		varchar(2);
cd_convenio_w			integer;
cd_medico_convenio_w		varchar(20);
nr_seq_med_fatur_w		bigint;
nr_seq_autor_W			bigint;
nr_seq_apresent_W		bigint;
dt_inicio_cirurgia_w		timestamp;
dt_fim_cirurgia_w		timestamp;
cd_estabelecimento_w		smallint;
cd_interno_w			varchar(20);
nm_contratado_solic_w		varchar(255);
cd_interno_solic_w		varchar(255);
ie_medico_solic_atend_w		varchar(2);
nr_seq_apresentacao_w		bigint;
nr_seq_apresent_proc_w		bigint;
qt_opm_w			bigint;
nr_seq_apres_proc_w		bigint;
nr_seq_apresent_opm_w		bigint;
nr_seq_conta_guia_w		bigint;
dt_atendimento_w		timestamp;
cd_autorizacao_princ_exame_w	varchar(255);
cd_autorizacao_princ_w		varchar(255);
cd_cgc_prestador_w		varchar(255);
ie_agrupar_proc_w		varchar(40);
cd_prestador_convenio_w		varchar(255)	:= '';
dt_ult_atualizacao_w		timestamp;
dt_geracao_tiss_w		timestamp;
ie_status_acerto_w		integer;
ie_honorario_w			varchar(30)	:= '';
ds_assinatura_solic_w		varchar(255);
ds_assinatura_resp_w		varchar(255);
ds_assinatura_exec_w		varchar(255);
ie_assinatura_solic_w		varchar(2);
ie_ordenacao_spsadt_w		varchar(3);
nr_seq_proc_interno_w		bigint;
nr_seq_proc_prescr_w		bigint;
CD_AREA_PROCEDIMENTO_w		bigint;
CD_ESPECIALIDADE_w		bigint;
CD_GRUPO_PROC_w			bigint;
IE_REGRA_W			varchar(100);
ie_lado_w			varchar(255);
ie_lado_rep_w			varchar(5);
cd_tipo_Proc_w			smallint;
ie_quebra_proc_pep_w		varchar(1);
ie_prescr_unica_w		varchar(255);
ie_data_ass_prest_w		varchar(255);
dt_assin_prest_w		timestamp;
ie_solicitante_w		varchar(255);
ie_solicitante_ww		varchar(255);
ie_conveniado_w			varchar(255);
cd_medico_solic_w		varchar(255);
ie_clinica_w			varchar(255);
cd_procedencia_w		varchar(255);
cd_cgc_prest_solic_regra_w	varchar(255);
cd_medico_atendimento_w		varchar(255);
cd_setor_entrada_w		bigint;
cd_cnes_solic_w			varchar(255);
cd_cgc_solic_w			varchar(255);
ds_arquivo_logo_comp_w		varchar(255);
nr_cpf_solic_w			varchar(255);
cd_cgc_solic_regra_w		varchar(20);
ie_gerar_tiss_w			varchar(10);
ie_tipo_atend_tiss_w		varchar(10);
ie_regra_guia_princ_w		varchar(255);
cd_autor_princ_w		varchar(255);
cd_autor_princ_prescr_w		varchar(255);
nr_seq_classif_atend_w		bigint;
cd_setor_prescr_w		integer;
cd_proc_conversao_exame_w	varchar(255);
ds_proc_conversao_exame_w	varchar(255);
ie_proc_tuss_w			varchar(255);
cd_proc_tuss_w			bigint;
ds_proc_tuss_w			varchar(255);
nr_seq_pedido_exame_prescr_w	bigint;
dt_validade_carteira_w		timestamp;
cd_pessoa_fisica_W		varchar(10);
nm_pessoa_fisica_W		varchar(255);
nr_cartao_nac_sus_W		varchar(20);
ds_plano_w			varchar(255);
cd_usuario_convenio_w		varchar(255);
qt_seq_exame_w			bigint;
qt_seq_pedido_exame_w		bigint;
nr_seq_exame_param_w		bigint;
nr_seq_pedido_exame_w		bigint;
nr_seq_tiss_tabela_w		bigint;
vl_item_w			double precision;
vl_total_procedimentos_w	double precision;
vl_total_geral_w		double precision;
ie_desc_exame_ext_w		varchar(255);
ds_irrelevante_w		varchar(255);
ds_exame_w			varchar(255);
ie_prest_spsadt_tasymed_w	varchar(255);
ie_topo_rep_w			varchar(255);
ds_topogradia_w			varchar(255);
ie_dt_emissao_guia_w		varchar(255);
ie_spsadt_atend_retorno_w	varchar(10);
cd_medico_referido_w		varchar(255);
cd_proc_tabela_w		varchar(255);
cd_cid_proc_presc_w		varchar(255);
nr_sequencia_autor_w		bigint;
nr_prescricao_w			bigint;
nr_prescr_autor_w		bigint;
ie_classif_proced_w		varchar(255);
ie_codigo_tuss_w		varchar(2);
ie_desc_tuss_w			varchar(2);
ie_sadt_autor_sem_proc_w	varchar(255);
ie_senha_guia_w			varchar(255);
cd_senha_proc_prescr_w		varchar(20);
nr_seq_exame_lab_w		bigint;
ie_dt_emiss_guia_regra_w	varchar(10);
ie_data_entrada_w		varchar(10);
dt_envio_autor_w		timestamp;
cd_profissional_w		varchar(10);
cd_cgc_exame_w			varchar(14);
ie_medico_solic_exame_w		varchar(255);
cd_medico_solic_tiss_w		varchar(10);
nm_medico_solicitante_w		varchar(255);
cd_medico_atend_w		varchar(10);
cd_medico_solic_autor_w		varchar(10);
ie_regra_med_solic_w		varchar(10);
ds_lado_proc_w			varchar(255);
ds_observacao_proc_prescr_w	varchar(4000);
ie_emitir_hemocomponente_w	varchar(255);
ds_dados_clinicos_w		varchar(255);
ie_quebra_grupo_exame_w		varchar(10);
nr_seq_grupo_w			bigint;
cd_proc_prescr_w		bigint;
ds_cid_externo_w		varchar(255);
ie_ultima_prescricao_w		varchar(10);
cd_prestador_tiss_autor_w	varchar(60);
ie_sexo_w			varchar(1);
nr_seq_conversao_w		bigint;
cd_grupo_proc_conversao_w	varchar(10);
cd_proced_conversao_w		varchar(20);
ie_conversao_sadt_solic_w	varchar(2);/*lhalves OS 485311 em 11/09/2012 - Nao aplicar conversao para as guias de solicitacao SADT*/
nr_atend_conta_tiss_w		bigint;
nr_doc_conv_exame_w		varchar(255);
ie_recem_nato_w			varchar(255);
ie_rn_w				varchar(255);
nr_prescricoes_w		varchar(255);
nr_prescr_w			bigint;
ds_observacao_guia_w		varchar(4000);
ds_horario_w			varchar(255);
ie_quebra_horarios_prescr_w	varchar(10);
cd_prestador_solic_tiss_w	varchar(255);
ds_prestador_solic_tiss_w	varchar(255);
ie_atendimento_rn_w		varchar(1);
ds_versao_w			varchar(20);
nr_cpf_relat_w			varchar(12);
ds_funcao_medico_w		varchar(20);
nr_seq_apres_partic_w		bigint;
nr_seq_apres_proc_anterior_w	bigint;
qt_vias_w			smallint;
qt_vias_proc_w			smallint;
ie_obs_prescr_autor_w		varchar(1);
crm_medico_externo_w		varchar(60);
nm_medico_externo_w		varchar(60);
cd_cgc_exec_w			varchar(14);
ie_prest_exec_pedido_exame_w	varchar(1);
dt_assin_solic_w		timestamp;
ie_dt_assin_solic_w	varchar(255);
cd_setor_origem_w		setor_atendimento.cd_setor_atendimento%type;
cd_medico_prescr_w		varchar(10);
cd_plano_convenio_w		varchar(10);
dt_mesano_referencia_w		timestamp;
nr_guia_prestador_w		varchar(100);
ie_guia_prestador_w		varchar(3);
nr_prontuario_w			bigint;
ie_regra_guia_prest_w		varchar(3);
nm_beneficiario_w		varchar(255);
cd_autorizacao_prest_w		autorizacao_convenio.cd_autorizacao_prest%type;
ds_posicao_w			integer;
ie_tipo_atend_eup_w		atendimento_paciente.ie_tipo_atendimento%type;
nr_prescr_item_autor_w		bigint;
nr_Seq_prescr_item_autor_w	bigint;
nr_seq_proc_int_ext_w		proc_interno.nr_sequencia%type;
nr_seq_regra_solic_w		bigint;
ie_convenio_particular_w	varchar(1);
cd_proced_tuss_w		prescr_procedimento.cd_proced_tuss%type;
nr_seq_protocolo_w 	bigint;
ie_funcao_medico_w		funcao_medico.cd_funcao%type;
im_logo_convenio_w		tiss_logo_convenio.im_logo_convenio%type;
ds_dt_prevista_exec_w		varchar(30);
ie_tipo_atend_guia_w		varchar(3);
ds_imprimi_patologia_w varchar(2000) := ds_imprimi_patologia_p;
ds_cpoe_itens_w prescr_procedimento.ds_observacao%type;
cd_cbo_med_prest_w cbo_saude.cd_cbo%type;

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	b.nr_atendimento,
	a.nr_interno_conta,
	a.cd_autorizacao,
	a.ie_tipo_atend_tiss,
	a.ie_tipo_saida,
	'4' ie_tiss_tipo_guia,
	a.cd_autorizacao_princ,
	a.cd_cgc_prestador,
	a.dt_autorizacao,
	a.cd_senha,
	a.dt_validade_senha,
	a.dt_emissao_guia,
	b.dt_entrada,
	b.ie_carater_internacao,
	a.cd_medico_executor,
	a.ie_honorario,
	a.nr_sequencia_autor,
	ltrim(a.ie_tipo_atend_tiss,'0')
from	tiss_conta_guia a,
	tiss_conta_atend b
where	a.nr_interno_conta	= b.nr_interno_conta
and	a.nr_interno_conta	= nr_interno_conta_p
and	a.ie_tiss_tipo_guia	= '4'

union

SELECT	a.nr_sequencia,
	b.nr_atendimento,
	a.nr_interno_conta,
	a.cd_autorizacao,
	a.ie_tipo_atend_tiss,
	a.ie_tipo_saida,
	'4' ie_tiss_tipo_guia,
	a.cd_autorizacao_princ,
	a.cd_cgc_prestador,
	a.dt_autorizacao,
	a.cd_senha,
	a.dt_validade_senha,
	a.dt_emissao_guia,
	b.dt_entrada,
	b.ie_carater_internacao,
	a.cd_medico_executor,
	a.ie_honorario,
	a.nr_sequencia_autor,
	ltrim(a.ie_tipo_atend_tiss,'0')
from	tiss_conta_guia a,
	TISS_PROTOCOLO_GUIA c,
	tiss_conta_atend b
where	a.nr_interno_conta	= b.nr_interno_conta
and	c.nr_sequencia		= a.nr_seq_prot_guia
and	c.nr_seq_protocolo	= nr_seq_protocolo_w
and	a.ie_tiss_tipo_guia	= '4'

union

select	a.nr_sequencia,
	b.nr_atendimento,
	a.nr_interno_conta,
	a.cd_autorizacao,
	a.ie_tipo_atend_tiss,
	a.ie_tipo_saida,
	'4' ie_tiss_tipo_guia,
	a.cd_autorizacao_princ,
	a.cd_cgc_prestador,
	a.dt_autorizacao,
	a.cd_senha,
	a.dt_validade_senha,
	a.dt_emissao_guia,
	b.dt_entrada,
	b.ie_carater_internacao,
	a.cd_medico_executor,
	a.ie_honorario,
	a.nr_sequencia_autor,
	ltrim(a.ie_tipo_atend_tiss,'0')
from	tiss_conta_guia a,
	tiss_conta_atend b
where	a.nr_interno_conta	= b.nr_interno_conta
and	b.nr_atendimento	= nr_atend_conta_tiss_w
and	a.ie_tiss_tipo_guia	= '4'

union

select	a.nr_sequencia,
	b.nr_atendimento,
	a.nr_interno_conta,
	a.cd_autorizacao,
	a.ie_tipo_atend_tiss,
	a.ie_tipo_saida,
	'4' ie_tiss_tipo_guia,
	a.cd_autorizacao_princ,
	a.cd_cgc_prestador,
	a.dt_autorizacao,
	a.cd_senha,
	a.dt_validade_senha,
	a.dt_emissao_guia,
	b.dt_entrada,
	b.ie_carater_internacao,
	a.cd_medico_executor,
	a.ie_honorario,
	a.nr_sequencia_autor,
	ltrim(a.ie_tipo_atend_tiss,'0')
from	tiss_conta_guia a,
	tiss_conta_atend b
where	a.nr_atend_med		= b.nr_atend_med
and	b.nr_seq_prot_med	= nr_seq_prot_med_p
and	a.ie_tiss_tipo_guia	in ('2', '3');

c02 CURSOR FOR
SELECT	cd_procedimento,
	cd_edicao_amb,
	sum(qt_procedimento),
	vl_reducao_acrescimo,
	sum(vl_procedimento) vl_procedimento,
	ie_via_acesso,
	vl_unitario,
	substr(ds_procedimento,1,255),
	dt_procedimento,
	dt_inicio_cir,
	dt_fim_cir,
	ie_tecnica_utilizada,
	cd_cbos,
	nr_seq_apresentacao,
	nr_seq_proc,
	cd_setor_execucao
from (
	SELECT	a.cd_procedimento,
		a.cd_edicao_amb,
		sum(a.qt_procedimento) qt_procedimento,
		sum(a.vl_reducao_acrescimo) vl_reducao_acrescimo,
		sum(a.vl_procedimento) vl_procedimento,
		a.ie_via_acesso,
		a.vl_unitario,
		a.ds_procedimento,
		trunc(a.dt_procedimento, 'dd') dt_procedimento,
		a.dt_inicio_cir,
		a.dt_fim_cir,
		a.ie_tecnica_utilizada,
		a.cd_cbos,
		CASE WHEN ie_agrupar_proc_w='S' THEN  1  ELSE a.nr_sequencia END  ie_union,
		CASE WHEN ie_agrupar_proc_w='S' THEN  0  ELSE a.nr_seq_apresentacao END  nr_seq_apresentacao,
		CASE WHEN obter_se_projeto_versao(0,13,ds_versao_w,0)='S' THEN a.nr_sequencia  ELSE null END  nr_seq_proc,
		a.cd_setor_execucao
	from	tiss_conta_proc a
	where	nr_seq_guia		= nr_seq_conta_guia_w
	and	ie_tiss_tipo_guia	= '4'
	and (coalesce(ie_somente_prescr_p,'N')	= 'N' or coalesce(nr_prescr_tiss_p,0) <= 0)
	and	coalesce(nr_atend_med::text, '') = ''
	group by a.ie_via_acesso,
		a.vl_unitario,
		a.ds_procedimento,
		trunc(a.dt_procedimento, 'dd'),
		a.dt_inicio_cir,
		a.dt_fim_cir,
		a.cd_procedimento,
		a.cd_cbos,
		a.cd_edicao_amb,
		--decode(ie_agrupar_proc_w, 'S', 1, a.nr_seq_proc), Edgar 07/01/2011, OS 280348, nao agrupar
		CASE WHEN ie_agrupar_proc_w='S' THEN  1  ELSE a.nr_sequencia END ,
		a.ie_tecnica_utilizada,
		CASE WHEN ie_agrupar_proc_w='S' THEN  0  ELSE a.nr_seq_apresentacao END ,
		CASE WHEN obter_se_projeto_versao(0,13,ds_versao_w,0)='S' THEN a.nr_sequencia  ELSE null END ,
		a.cd_setor_execucao
	
union all

	select	a.cd_procedimento,
		a.cd_edicao_amb,
		sum(a.qt_procedimento) qt_procedimento,
		sum(a.vl_reducao_acrescimo) vl_reducao_acrescimo,
		sum(a.vl_procedimento) vl_procedimento,
		a.ie_via_acesso,
		a.vl_unitario,
		a.ds_procedimento,
		trunc(a.dt_procedimento, 'dd') dt_procedimento,
		a.dt_inicio_cir,
		a.dt_fim_cir,
		a.ie_tecnica_utilizada,
		a.cd_cbos,
		CASE WHEN ie_agrupar_proc_w='S' THEN  1  ELSE a.nr_sequencia END  ie_union,
		CASE WHEN ie_agrupar_proc_w='S' THEN  0  ELSE a.nr_seq_apresentacao END  nr_seq_apresentacao,
		CASE WHEN obter_se_projeto_versao(0,13,ds_versao_w,0)='S' THEN a.nr_sequencia  ELSE null END  nr_seq_proc,
		a.cd_setor_execucao
	from	tiss_conta_proc a
	where	nr_seq_guia		= nr_seq_conta_guia_w
	and (coalesce(ie_somente_prescr_p,'N')	= 'N' or coalesce(nr_prescr_tiss_p,0) <= 0)
	and	(nr_atend_med IS NOT NULL AND nr_atend_med::text <> '')
	and	ie_tiss_tipo_guia	in ('2', '3')
	group by a.ie_via_acesso,
		a.vl_unitario,
		a.ds_procedimento,
		trunc(a.dt_procedimento, 'dd'),
		a.dt_inicio_cir,
		a.dt_fim_cir,
		a.cd_procedimento,
		a.cd_cbos,
		a.cd_edicao_amb,
		--decode(ie_agrupar_proc_w, 'S', 1, a.nr_seq_proc), Edgar 07/01/2011, OS 280348, nao agrupar
		CASE WHEN ie_agrupar_proc_w='S' THEN  1  ELSE a.nr_sequencia END ,
		a.ie_tecnica_utilizada,
		CASE WHEN ie_agrupar_proc_w='S' THEN  0  ELSE a.nr_seq_apresentacao END ,
		CASE WHEN obter_se_projeto_versao(0,13,ds_versao_w,0)='S' THEN a.nr_sequencia  ELSE null END ,
		a.cd_setor_execucao
	
union all

	select	null,
		null,
		(null)::numeric ,
		(null)::numeric ,
		(null)::numeric ,
		null,
		(null)::numeric ,
		null,
		to_date(null),
		to_date(null),
		to_date(null),
		null,
		null,
		2 ie_union,
		0 nr_seq_apresentacao,
		null nr_seq_proc,
		null cd_setor_execucao
	from	tiss_conta_desp a
	where	a.nr_seq_guia	= nr_seq_conta_guia_w
	and (coalesce(ie_somente_prescr_p,'N')	= 'N' or coalesce(nr_prescr_tiss_p,0) <= 0)
	and	not exists (	select	1
				from	tiss_conta_proc b
				where	a.nr_seq_guia	= b.nr_seq_guia)
	
union all

	select	null,
		null,
		(null)::numeric ,
		(null)::numeric ,
		(null)::numeric  vl_procedimento,
		null,
		(null)::numeric ,
		null,
		to_date(null),
		to_date(null),
		to_date(null),
		null,
		null,
		3 ie_union,
		0 nr_seq_apresentacao,
		null nr_seq_proc,
		null cd_setor_execucao
	from	tiss_conta_opm_exec a
	where	a.nr_seq_guia	= nr_seq_conta_guia_w
	and (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'N') --No TISS 3, OPME nao gera na SADT, apenas na Outras Despesas
	and (coalesce(ie_somente_prescr_p,'N')	= 'N' or coalesce(nr_prescr_tiss_p,0) <= 0)
	and	not exists (	select	1
				from	tiss_conta_proc b
				where	a.nr_seq_guia	= b.nr_seq_guia)
	
union all
 /*Emitir somente os procedimentos da prescricao selecionada.*/
	select	to_char(coalesce(CASE WHEN a.cd_procedimento_tuss=0 THEN null  ELSE a.cd_procedimento_tuss END ,a.cd_procedimento)) cd_procedimento,
		TISS_OBTER_CODIGO_TABELA(a.nr_seq_tiss_tabela) cd_edicao_amb,
		sum(a.qt_procedimento) qt_procedimento,
		1 vl_reducao_acrescimo,
		sum(a.vl_procedimento) vl_procedimento,
		CASE WHEN a.ie_via_acesso='B' THEN  'U'  ELSE a.ie_via_acesso END  ie_via_acesso,
		a.vl_procedimento,
		substr(tiss_eliminar_caractere(obter_desc_procedimento(a.cd_procedimento,a.ie_origem_proced)),1,255) ds_procedimento,
		trunc(a.dt_procedimento, 'dd') dt_procedimento,
		a.dt_procedimento dt_inicio_cir,
		a.dt_procedimento dt_fim_cir,
		a.ie_tecnica_utilizada,
		null cd_cbos,
		CASE WHEN ie_agrupar_proc_w='S' THEN  1  ELSE a.nr_sequencia END  ie_union,
		0 nr_seq_apresentacao,
		null nr_seq_proc,
		a.cd_setor_atendimento cd_setor_execucao
	from	procedimento_paciente a
	where	nr_atendimento			= nr_atend_conta_tiss_w
	and	nr_prescricao			= nr_prescr_tiss_p
	and	coalesce(ie_somente_prescr_p,'N')	= 'S'
	and	ie_tiss_tipo_guia		= '4'
	and	nr_doc_convenio			= cd_autorizacao_w
	and	coalesce(cd_motivo_exc_conta::text, '') = ''
	group by to_char(coalesce(CASE WHEN a.cd_procedimento_tuss=0 THEN null  ELSE a.cd_procedimento_tuss END ,a.cd_procedimento)),
		TISS_OBTER_CODIGO_TABELA(a.nr_seq_tiss_tabela),
		CASE WHEN a.ie_via_acesso='B' THEN  'U'  ELSE a.ie_via_acesso END ,
		a.vl_procedimento,
		substr(tiss_eliminar_caractere(obter_desc_procedimento(a.cd_procedimento,a.ie_origem_proced)),1,255),
		trunc(a.dt_procedimento, 'dd'),
		a.dt_procedimento,
		a.dt_procedimento,
		a.ie_tecnica_utilizada,
		CASE WHEN ie_agrupar_proc_w='S' THEN  1  ELSE a.nr_sequencia END ,
		a.cd_setor_atendimento) alias68
group	by cd_procedimento,
	cd_edicao_amb,
	vl_reducao_acrescimo,
	ie_via_acesso,
	vl_unitario,
	ds_procedimento,
	dt_procedimento,
	dt_inicio_cir,
	dt_fim_cir,
	ie_tecnica_utilizada,
	cd_cbos,
	CASE WHEN ie_agrupar_proc_w='S' THEN  1  ELSE ie_union END ,
	nr_seq_apresentacao,
	nr_seq_proc,
	cd_setor_execucao
order by coalesce(nr_seq_apresentacao,0),
	CASE WHEN ie_ordenacao_spsadt_w='1' THEN  ie_via_acesso  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='2' THEN  dt_procedimento  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='2' THEN  dt_inicio_cir  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='3' THEN  CASE WHEN TISS_OBTER_SE_PROC_PRINCIPAL(nr_interno_conta_w,cd_procedimento,nr_seq_proc)='S' THEN  1  ELSE 2 END   ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='3' THEN  dt_procedimento  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='3' THEN  dt_inicio_cir  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='3' THEN  cd_procedimento  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='4' THEN  dt_procedimento  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='4' THEN  dt_inicio_cir  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='4' THEN  cd_procedimento  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='6' THEN  ie_via_acesso  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='6' THEN  dt_procedimento  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='6' THEN  cd_procedimento  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='6' THEN  vl_procedimento  ELSE 0 END;

c03 CURSOR FOR
SELECT	coalesce(cd_procedimento_convenio, cd_procedimento),
	tiss_obter_ds_proc_regra(
		coalesce(cd_procedimento_convenio, cd_procedimento),
		ds_procedimento,
		ie_origem_proced, 
		ie_sadt_autor_sem_proc_w, 
		ie_desc_proc_interno_w, 
		ie_conversao_sadt_solic_w, 
		ie_lado_rep_w, 
		ie_topo_rep_w, 
		nr_prescricao, 
		nr_seq_prescricao),
	qt_solicitada,
	qt_autorizada,
	cd_edicao_relat
from	tiss_proc_solicitado_v
where	nr_sequencia_autor	= nr_sequencia_autor_w
and	ds_versao		= '2.01.01'
and	ie_agrupar_proc_w	= 'N' --lhalves OS 790050 em 23/03/2015
union all

SELECT	coalesce(cd_procedimento_convenio, cd_procedimento),
	tiss_obter_ds_proc_regra(
		coalesce(cd_procedimento_convenio, cd_procedimento), 
		ds_procedimento,
		ie_origem_proced, 
		ie_sadt_autor_sem_proc_w, 
		ie_desc_proc_interno_w, 
		ie_conversao_sadt_solic_w, 
		ie_lado_rep_w, 
		ie_topo_rep_w, 
		nr_prescricao, 
		nr_seq_prescricao),
	sum(qt_solicitada),
	sum(qt_autorizada),
	cd_edicao_relat	
from	tiss_proc_solicitado_v
where	nr_sequencia_autor	= nr_sequencia_autor_w
and	ds_versao		= '2.01.01'
and	ie_agrupar_proc_w	= 'S'--lhalves OS 790050 em 23/03/2015
group by 	coalesce(cd_procedimento_convenio, cd_procedimento),
		tiss_obter_ds_proc_regra(
			coalesce(cd_procedimento_convenio, cd_procedimento), 
			ds_procedimento,
			ie_origem_proced, 
			ie_sadt_autor_sem_proc_w, 
			ie_desc_proc_interno_w, 
			ie_conversao_sadt_solic_w, 
			ie_lado_rep_w, 
			ie_topo_rep_w, 
			nr_prescricao, 
			nr_seq_prescricao),	
		cd_edicao_relat

union all

select	null cd_procedimento,
	null ds_procedimento,
	null qt_solicitada,
	null qt_autorizada,
	null cd_edicao_relat	

where	(nr_sequencia_autor_w IS NOT NULL AND nr_sequencia_autor_w::text <> '')
and	ie_sadt_autor_sem_proc_w	= 'S'
and	not exists (select	1
			from 	tiss_proc_solicitado_v x
			where 	x.nr_sequencia_autor = nr_sequencia_autor_w);

c04 CURSOR FOR
SELECT	a.nr_seq_exame,
	coalesce(substr(TISS_OBTER_PROCED_CONVERSAO(e.cd_convenio,a.cd_procedimento,a.ie_origem_proced,'C'),1,50),
		coalesce(coalesce(coalesce(a.cd_procedimento, b.cd_procedimento),
		coalesce(Obter_Cod_Proc_Interno_conv(b.nr_proc_interno, e.cd_convenio, e.cd_categoria, clock_timestamp(), j.cd_estabelecimento),
		    Obter_Cod_Proc_Interno_conv(a.nr_proc_interno, e.cd_convenio, e.cd_categoria, clock_timestamp(), j.cd_estabelecimento))),
	        Lab_Obter_Dados_Exame(a.NR_SEQ_EXAME_LAB, 'P'))),
	substr(coalesce(TISS_OBTER_PROCED_CONVERSAO(e.cd_convenio,a.cd_procedimento,a.ie_origem_proced,'D'),
		coalesce(TISS_Obter_Med_Exame_Externo(a.nr_sequencia, ie_lista_desc_solic_exame_p),
		coalesce(obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced),
		obter_descricao_procedimento(b.cd_procedimento, b.ie_origem_proced)))),1,254) ds_procedimento,
	sum(a.qt_exame) qt_solicitada,
	sum(a.qt_exame) qt_autorizada,
	c.nr_atendimento,
	coalesce(b.cd_medico, j.cd_medico_resp),
	coalesce(coalesce(a.nr_doc_convenio,e.nr_doc_convenio),wheb_mensagem_pck.get_texto(314168)),
	e.cd_senha,
	e.dt_final_vigencia,
	e.dt_inicio_vigencia,
	d.cd_cgc,
	substr(obter_nome_pf_pj(null, d.cd_cgc), 1, 150),
	d.cd_cns,
	j.dt_entrada,
	c.ds_justificativa,
	substr(c.ds_cid,1,6),
	j.ie_tipo_atendimento,
	j.ie_clinica,
	CASE WHEN ie_desc_exame_ext_w='S' THEN TISS_Obter_Med_Exame_Externo(a.nr_sequencia, ie_lista_desc_solic_exame_p)  ELSE null END  ds_exame,
	a.nr_seq_exame_lab,
	c.cd_profissional,
	a.cd_cgc,
	substr(obter_valor_dominio(1372,a.ie_lado),1,255),
	substr(c.ds_dados_clinicos,1,255) ds_dados_clinicos,
	a.nr_seq_apresent,
	a.NR_PROC_INTERNO
FROM convenio n, atendimento_paciente j, atend_categoria_convenio e, estabelecimento d, pedido_exame_externo c, pedido_exame_externo_item a
LEFT OUTER JOIN med_exame_padrao b ON (a.nr_seq_exame = b.nr_sequencia)
WHERE j.nr_atendimento				= e.nr_atendimento and obter_atecaco_atendimento(j.nr_atendimento) 	= e.nr_seq_interno and d.cd_estabelecimento				= j.cd_estabelecimento and n.cd_convenio					= e.cd_convenio and e.nr_atendimento				= c.nr_atendimento and c.nr_sequencia					= a.nr_seq_pedido and coalesce(a.nr_doc_convenio,'X')			= nr_doc_conv_exame_w and c.nr_sequencia					= nr_seq_pedido_exame_w and ((a.cd_cgc = cd_cgc_exec_w) or (cd_cgc_exec_w = 'X' and (ie_prest_exec_pedido_exame_w = 'N' or coalesce(a.cd_cgc::text, '') = ''))) and ((coalesce((obter_tipo_procedimento(
		coalesce(a.cd_procedimento,(Obter_Cod_Proc_Interno_conv(a.nr_proc_interno,Obter_Convenio_Atendimento(c.nr_atendimento),null,c.dt_solicitacao,null))::numeric ),
		coalesce(a.ie_origem_proced,(Obter_origem_Proc_Interno_conv(a.nr_proc_interno,Obter_Convenio_Atendimento(c.nr_atendimento),null,c.dt_solicitacao,null))::numeric )
		,'C'))::numeric ,999)	= cd_tipo_proc_w) or (coalesce(cd_tipo_Proc_w::text, '') = '') ) and (coalesce(b.nr_seq_grupo,9999999)	= nr_seq_grupo_w or coalesce(nr_seq_grupo_w::text, '') = '') group by e.cd_senha,
	coalesce(coalesce(a.nr_doc_convenio,e.nr_doc_convenio),wheb_mensagem_pck.get_texto(314168)),
	e.dt_final_vigencia,
	e.dt_inicio_vigencia,
	a.nr_seq_exame,
	coalesce(substr(TISS_OBTER_PROCED_CONVERSAO(e.cd_convenio,a.cd_procedimento,a.ie_origem_proced,'C'),1,50),
	coalesce(coalesce(coalesce(a.cd_procedimento, b.cd_procedimento),
	coalesce(Obter_Cod_Proc_Interno_conv(b.nr_proc_interno, e.cd_convenio, e.cd_categoria, clock_timestamp(), j.cd_estabelecimento),
	    Obter_Cod_Proc_Interno_conv(a.nr_proc_interno, e.cd_convenio, e.cd_categoria, clock_timestamp(), j.cd_estabelecimento))),
	Lab_Obter_Dados_Exame(a.NR_SEQ_EXAME_LAB, 'P'))),
	e.cd_convenio,
	a.cd_procedimento,
	b.cd_procedimento,
	b.ie_origem_proced,
	a.ie_origem_proced,
	TISS_Obter_Med_Exame_Externo(a.nr_sequencia, ie_lista_desc_solic_exame_p),
	j.cd_medico_resp,
	c.ds_cid,
	c.nr_atendimento,
	b.cd_medico,
	wheb_mensagem_pck.get_texto(1097738),
	d.cd_cgc,
	substr(obter_nome_pf_pj(null, d.cd_cgc), 1, 150),
	j.dt_entrada,
	d.cd_cns,
	c.ds_justificativa,
	j.ie_tipo_atendimento,
	j.ie_clinica,
	CASE WHEN ie_desc_exame_ext_w='S' THEN TISS_Obter_Med_Exame_Externo(a.nr_sequencia, ie_lista_desc_solic_exame_p)  ELSE null END ,
	a.nr_seq_exame_lab,
	c.cd_profissional,
	a.cd_cgc,
	substr(obter_valor_dominio(1372,a.ie_lado),1,255),
	substr(c.ds_dados_clinicos,1,255),
	a.nr_seq_apresent,
	a.NR_PROC_INTERNO
order by nr_seq_apresent,
	ds_procedimento;

c05 CURSOR FOR
SELECT	cd_procedimento_convenio,
	cd_edicao_amb,
	ds_procedimento,
	qt_solicitada,
	qt_autorizada,
--	substr(obter_nome_pf_pj(null,cd_cgc_fabricante),1,255),
	coalesce(ds_fabricante, substr(obter_nome_pf_pj(null,cd_cgc_fabricante),1,255)),
	vl_unitario
from	tiss_opm_solicitado_v
where	ds_versao		= '2.01.01'
and	ie_origem		= 'AC'
and	nr_sequencia_autor	= nr_sequencia_autor_w;

c06 CURSOR FOR
SELECT	distinct
	coalesce(cd_setor_atendimento,0),
	coalesce(nr_doc_convenio,'X'),
	substr(ds_dado_clinico,1,255)
from	prescr_procedimento
where	nr_prescricao			= nr_prescr_tiss_p
and (coalesce(ie_suspenso,'N') 		= 'N')
and	ie_setor_prescr_p		= 'S'
and (coalesce(ie_prescr_unica_w,'N')	= 'N')
and (coalesce(nr_seq_derivado::text, '') = '' or coalesce(ie_emitir_hemocomponente_w,'N') = 'S')
and	coalesce(ds_cpoe_itens_w::text, '') = ''

union

SELECT	distinct
	coalesce(a.cd_setor_atendimento,0),
	coalesce(a.nr_doc_convenio,'X'),
	substr(a.ds_dado_clinico,1,255)
from	prescr_procedimento a,
	table(lista_pck.obter_lista(coalesce(ds_cpoe_itens_w,' '))) k
where	k.nr_registro 		= a.nr_seq_proc_cpoe
and (coalesce(a.ie_suspenso,'N') 		= 'N')
and	ie_setor_prescr_p		= 'S'
and (coalesce(ie_prescr_unica_w,'N')	= 'N')
and (coalesce(a.nr_seq_derivado::text, '') = '' or coalesce(ie_emitir_hemocomponente_w,'N') = 'S')
and	(ds_cpoe_itens_w IS NOT NULL AND ds_cpoe_itens_w::text <> '')
and	(
	(coalesce(ie_considera_dt_cpoe_p,'N') = 'N')
	or (ie_considera_dt_cpoe_p = 'S' and a.dt_prev_execucao between dt_inicial_p and dt_final_p)
	)

union

select	distinct
	-1 cd_setor_atendimento,
	coalesce(nr_doc_convenio,'Y'),
	substr(ds_dado_clinico,1,255)
from	prescr_procedimento
where	nr_prescricao			= nr_prescr_tiss_p
and (coalesce(nr_seq_derivado::text, '') = '' or coalesce(ie_emitir_hemocomponente_w,'N') = 'S')
and (coalesce(ie_suspenso,'N') 		= 'N')
and (coalesce(ie_prescr_unica_w,'N')	= 'N')
and	ie_setor_prescr_p		= 'N'
and	coalesce(ds_cpoe_itens_w::text, '') = ''

union

select	distinct
	-1 cd_setor_atendimento,
	coalesce(a.nr_doc_convenio,'Y'),
	substr(a.ds_dado_clinico,1,255)
from	prescr_procedimento a,
	table(lista_pck.obter_lista(coalesce(ds_cpoe_itens_w,' '))) k
where	k.nr_registro 		= a.nr_seq_proc_cpoe
and (coalesce(a.nr_seq_derivado::text, '') = '' or coalesce(ie_emitir_hemocomponente_w,'N') = 'S')
and (coalesce(a.ie_suspenso,'N') 		= 'N')
and (coalesce(ie_prescr_unica_w,'N')	= 'N')
and	ie_setor_prescr_p		= 'N'
and	(ds_cpoe_itens_w IS NOT NULL AND ds_cpoe_itens_w::text <> '')
and	(
	(coalesce(ie_considera_dt_cpoe_p,'N') = 'N')
	or (ie_considera_dt_cpoe_p = 'S' and a.dt_prev_execucao between dt_inicial_p and dt_final_p)
	)

union
 /*Gerar a guia para todas as prescricoes do atendimento*/
select	distinct
	coalesce(a.cd_setor_atendimento,0),
	coalesce(a.nr_doc_convenio,'X'),
	substr(a.ds_dado_clinico,1,255)
from	prescr_procedimento a,
	prescr_medica b
where	a.nr_prescricao			= b.nr_prescricao
and	b.nr_atendimento		= nr_atendimento_w
and (coalesce(a.ie_suspenso,'N') 		= 'N')
and	ie_setor_prescr_p		= 'S'
and (coalesce(ie_prescr_unica_w,'N')	= 'S')  /*Gerar a guia para todas as prescricoes do atendimento*/
and (coalesce(a.nr_seq_derivado::text, '') = '' or coalesce(ie_emitir_hemocomponente_w,'N') = 'S')

union

select	distinct
	-1 cd_setor_atendimento,
	coalesce(a.nr_doc_convenio,'Y'),
	substr(a.ds_dado_clinico,1,255)
from	prescr_procedimento a,
	prescr_medica b
where	a.nr_prescricao			= b.nr_prescricao
and	b.nr_atendimento		= nr_atendimento_w
and (coalesce(nr_seq_derivado::text, '') = '' or coalesce(ie_emitir_hemocomponente_w,'N') = 'S')
and (coalesce(ie_suspenso,'N') 		= 'N')
and (coalesce(ie_prescr_unica_w,'N')	= 'S')  /*Gerar a guia para todas as prescricoes do atendimento*/
and	ie_setor_prescr_p		= 'N';

c07 CURSOR FOR
SELECT	tiss_obter_tabela(null, cd_estabelecimento_w, cd_convenio_w, cd_categoria_conv_w,
			 clock_timestamp(), 'R', c.ie_classificacao, a.cd_procedimento, a.ie_origem_proced, null, null, b.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_proced_tuss) cd_edicao_amb,
	a.cd_procedimento,
	substr(coalesce(obter_desc_prescr_proc_exam(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno, a.nr_seq_exame), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced)),1,255),
	sum(TISS_OBTER_QTD_PROC_PRESCR(cd_estabelecimento_w, cd_convenio_w,a.nr_prescricao,a.nr_sequencia)),
	sum(TISS_OBTER_QTD_PROC_PRESCR(cd_estabelecimento_w, cd_convenio_w,a.nr_prescricao,a.nr_sequencia)),
	b.dt_prescricao,
	substr(coalesce(a.ds_observacao,coalesce(b.ds_observacao,a.ds_justificativa)) ,1,3999),
	a.ie_origem_proced,
	b.cd_estabelecimento,
	coalesce(cd_convenio_w,a.cd_convenio),
	substr(tiss_eliminar_caractere(obter_desc_prescr_proc_exam(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno, a.nr_seq_exame)), 1, 60) ds_proc_tabela_interno,
	substr(tiss_eliminar_caractere(obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced)), 1, 60) ds_proc_exame_proc,
	substr(tiss_eliminar_caractere(coalesce(TISS_OBTER_DESC_PROCED(a.nr_sequencia, 0, 'DS_PROC_SPSADT'), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced))), 1, 60) ds_proc_procedimento,
	a.ie_urgencia,
	a.DT_PREV_EXECUCAO,
	substr(obter_valor_dominio(1372, a.ie_lado),1,254),
	a.nr_seq_proc_interno,
	a.nr_seq_exame,
	substr(obter_descricao_padrao('TOPOGRAFIA_DOR','DS_TOPOGRAFIA',a.nr_seq_topografia),1,255),
	CASE WHEN ie_senha_guia_w='P' THEN a.cd_senha  ELSE null END ,
	b.ie_recem_nato,
	a.nr_sequencia nr_seq_proc_prescr,
	TISS_OBTER_QTDADE_GUIA_PRESCR(cd_estabelecimento_w, cd_convenio_w, a.cd_procedimento, a.ie_origem_proced),
	a.cd_proced_tuss,
	b.cd_medico cd_medico_solicitante,
	b.nr_prescricao
from	prescr_procedimento a,
	prescr_medica b,
	procedimento c
where	a.nr_prescricao			= b.nr_prescricao
and	a.cd_procedimento		= c.cd_procedimento
and	a.ie_origem_proced		= c.ie_origem_proced
and	b.nr_prescricao 		= nr_prescr_tiss_p
and	coalesce(ds_cpoe_itens_w::text, '') = ''
and	((coalesce(a.cd_setor_atendimento,0)	= cd_setor_atendimento_w) or (cd_setor_atendimento_w		= -1))
and	((coalesce(a.nr_doc_convenio,'X')		= cd_autorizacao_ww) or (cd_autorizacao_ww		= 'Y'))
and	substr(coalesce(a.ds_dado_clinico,'X'),1,255)		= coalesce(ds_inicacao_clinica_w, 'X')
and (coalesce(ie_suspenso,'N') 		= 'N')
and (coalesce(ie_prescr_unica_w,'N')		= 'N')
and 	((coalesce((obter_tipo_procedimento(a.cd_procedimento,a.ie_origem_proced,'C'))::numeric ,999) = cd_tipo_proc_w) or (coalesce(cd_tipo_Proc_w::text, '') = '') )
and (coalesce(nr_seq_derivado::text, '') = '' or coalesce(ie_emitir_hemocomponente_w,'N') = 'S')
and	((position(ds_horario_w in a.ds_horarios)	> 0) or (ds_horario_w = '-1'))
group by tiss_obter_tabela(null, cd_estabelecimento_w, cd_convenio_w, cd_categoria_conv_w,
			 clock_timestamp(), 'R', c.ie_classificacao, a.cd_procedimento, a.ie_origem_proced, null, null, b.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_proced_tuss),
	a.cd_procedimento,
	substr(coalesce(obter_desc_prescr_proc_exam(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno, a.nr_seq_exame), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced)),1,255),
	dt_prescricao,
	substr(coalesce(a.ds_observacao,coalesce(b.ds_observacao,a.ds_justificativa)) ,1,3999),
	a.ie_origem_proced,
	b.cd_estabelecimento,
	coalesce(cd_convenio_w,a.cd_convenio),
	a.nr_seq_proc_interno,
	a.nr_sequencia,
	b.ds_observacao,
	a.ie_urgencia,
	a.DT_PREV_EXECUCAO,
	a.ie_lado,
	a.nr_seq_proc_interno,
	a.nr_seq_exame,
	substr(obter_descricao_padrao('TOPOGRAFIA_DOR','DS_TOPOGRAFIA',a.nr_seq_topografia),1,255),
	CASE WHEN ie_senha_guia_w='P' THEN a.cd_senha  ELSE null END ,
	b.ie_recem_nato,
	TISS_OBTER_QTDADE_GUIA_PRESCR(cd_estabelecimento_w, cd_convenio_w, a.cd_procedimento, a.ie_origem_proced),
	a.cd_proced_tuss,
	b.cd_medico,
	b.nr_prescricao

union all

SELECT	tiss_obter_tabela(null, cd_estabelecimento_w, cd_convenio_w, cd_categoria_conv_w,
			 clock_timestamp(), 'R', c.ie_classificacao, a.cd_procedimento, a.ie_origem_proced, null, null, b.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_proced_tuss) cd_edicao_amb,
	a.cd_procedimento,
	substr(coalesce(obter_desc_prescr_proc_exam(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno, a.nr_seq_exame), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced)),1,255),
	sum(TISS_OBTER_QTD_PROC_PRESCR(cd_estabelecimento_w, cd_convenio_w,a.nr_prescricao,a.nr_sequencia)),
	sum(TISS_OBTER_QTD_PROC_PRESCR(cd_estabelecimento_w, cd_convenio_w,a.nr_prescricao,a.nr_sequencia)),
	b.dt_prescricao,
	substr(coalesce(a.ds_observacao,coalesce(b.ds_observacao,a.ds_justificativa)) ,1,3999),
	a.ie_origem_proced,
	b.cd_estabelecimento,
	coalesce(cd_convenio_w,a.cd_convenio),
	substr(tiss_eliminar_caractere(obter_desc_prescr_proc_exam(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno, a.nr_seq_exame)), 1, 60) ds_proc_tabela_interno,
	substr(tiss_eliminar_caractere(obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced)), 1, 60) ds_proc_exame_proc,
	substr(tiss_eliminar_caractere(coalesce(TISS_OBTER_DESC_PROCED(a.nr_sequencia, 0, 'DS_PROC_SPSADT'), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced))), 1, 60) ds_proc_procedimento,
	a.ie_urgencia,
	a.DT_PREV_EXECUCAO,
	substr(obter_valor_dominio(1372, a.ie_lado),1,254),
	a.nr_seq_proc_interno,
	a.nr_seq_exame,
	substr(obter_descricao_padrao('TOPOGRAFIA_DOR','DS_TOPOGRAFIA',a.nr_seq_topografia),1,255),
	CASE WHEN ie_senha_guia_w='P' THEN a.cd_senha  ELSE null END ,
	b.ie_recem_nato,
	a.nr_sequencia nr_seq_proc_prescr,
	TISS_OBTER_QTDADE_GUIA_PRESCR(cd_estabelecimento_w, cd_convenio_w, a.cd_procedimento, a.ie_origem_proced),
	a.cd_proced_tuss,
	b.cd_medico cd_medico_solicitante,
	b.nr_prescricao
from	prescr_procedimento a,
	prescr_medica b,
	procedimento c,
	table(lista_pck.obter_lista(coalesce(ds_cpoe_itens_w,' '))) k
where	a.nr_prescricao			= b.nr_prescricao
and	a.cd_procedimento		= c.cd_procedimento
and	a.ie_origem_proced		= c.ie_origem_proced
and	k.nr_registro 				= a.nr_seq_proc_cpoe
and	(ds_cpoe_itens_w IS NOT NULL AND ds_cpoe_itens_w::text <> '')
and	(
	(coalesce(ie_considera_dt_cpoe_p,'N') = 'N')
	or (ie_considera_dt_cpoe_p = 'S' and a.dt_prev_execucao between dt_inicial_p and dt_final_p)
	)
and (coalesce(ie_ultima_prescricao_w,'N') = 'N' or b.nr_prescricao 	= obter_nr_prescr_seq_cpoe('P',a.nr_seq_proc_cpoe))
and	((coalesce(a.cd_setor_atendimento,0)	= cd_setor_atendimento_w) or (cd_setor_atendimento_w		= -1))
and	((coalesce(a.nr_doc_convenio,'X')		= cd_autorizacao_ww) or (cd_autorizacao_ww		= 'Y'))
and	substr(coalesce(a.ds_dado_clinico,'X'),1,255)		= coalesce(ds_inicacao_clinica_w, 'X')
and (coalesce(ie_suspenso,'N') 		= 'N')
and (coalesce(ie_prescr_unica_w,'N')		= 'N')
and 	((coalesce((obter_tipo_procedimento(a.cd_procedimento,a.ie_origem_proced,'C'))::numeric ,999) = cd_tipo_proc_w) or (coalesce(cd_tipo_Proc_w::text, '') = '') )
and (coalesce(nr_seq_derivado::text, '') = '' or coalesce(ie_emitir_hemocomponente_w,'N') = 'S')
and	((position(ds_horario_w in a.ds_horarios)	> 0) or (ds_horario_w = '-1'))
group by tiss_obter_tabela(null, cd_estabelecimento_w, cd_convenio_w, cd_categoria_conv_w,
			 clock_timestamp(), 'R', c.ie_classificacao, a.cd_procedimento, a.ie_origem_proced, null, null, b.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_proced_tuss),
	a.cd_procedimento,
	substr(coalesce(obter_desc_prescr_proc_exam(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno, a.nr_seq_exame), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced)),1,255),
	dt_prescricao,
	substr(coalesce(a.ds_observacao,coalesce(b.ds_observacao,a.ds_justificativa)) ,1,3999),
	a.ie_origem_proced,
	b.cd_estabelecimento,
	coalesce(cd_convenio_w,a.cd_convenio),
	a.nr_seq_proc_interno,
	a.nr_sequencia,
	b.ds_observacao,
	a.ie_urgencia,
	a.DT_PREV_EXECUCAO,
	a.ie_lado,
	a.nr_seq_proc_interno,
	a.nr_seq_exame,
	substr(obter_descricao_padrao('TOPOGRAFIA_DOR','DS_TOPOGRAFIA',a.nr_seq_topografia),1,255),
	CASE WHEN ie_senha_guia_w='P' THEN a.cd_senha  ELSE null END ,
	b.ie_recem_nato,
	TISS_OBTER_QTDADE_GUIA_PRESCR(cd_estabelecimento_w, cd_convenio_w, a.cd_procedimento, a.ie_origem_proced),
	a.cd_proced_tuss,
	b.cd_medico,
	b.nr_prescricao

union all
	
select	tiss_obter_tabela(null, cd_estabelecimento_w, cd_convenio_w, cd_categoria_conv_w,
			 clock_timestamp(), 'R', c.ie_classificacao, a.cd_procedimento, a.ie_origem_proced, null, null, b.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_proced_tuss) cd_edicao_amb,
	a.cd_procedimento,
	substr(coalesce(obter_desc_prescr_proc_exam(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno, a.nr_seq_exame), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced)),1,255),
	sum(a.qt_procedimento),
	sum(a.qt_procedimento),
	b.dt_prescricao,
	substr(coalesce(a.ds_observacao,coalesce(b.ds_observacao,a.ds_justificativa)) ,1,3999),
	a.ie_origem_proced,
	b.cd_estabelecimento,
	coalesce(cd_convenio_w,a.cd_convenio),
	substr(tiss_eliminar_caractere(obter_desc_prescr_proc_exam(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno, a.nr_seq_exame)), 1, 60) ds_proc_tabela_interno,
	substr(tiss_eliminar_caractere(obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced)), 1, 60) ds_proc_exame_proc,
	substr(tiss_eliminar_caractere(coalesce(TISS_OBTER_DESC_PROCED(a.nr_sequencia, 0, 'DS_PROC_SPSADT'), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced))), 1, 60) ds_proc_procedimento,
	a.ie_urgencia,
	a.DT_PREV_EXECUCAO,
	substr(obter_valor_dominio(1372, a.ie_lado),1,254),
	a.nr_seq_proc_interno,
	a.nr_seq_exame,
	substr(obter_descricao_padrao('TOPOGRAFIA_DOR','DS_TOPOGRAFIA',a.nr_seq_topografia),1,255),
	CASE WHEN ie_senha_guia_w='P' THEN a.cd_senha  ELSE null END ,
	b.ie_recem_nato,
	a.nr_sequencia nr_seq_proc_prescr,
	TISS_OBTER_QTDADE_GUIA_PRESCR(cd_estabelecimento_w, cd_convenio_w, a.cd_procedimento, a.ie_origem_proced),
	a.cd_proced_tuss,
	b.cd_medico cd_medico_solicitante,
	b.nr_prescricao
from	prescr_procedimento a,
	prescr_medica b,
	procedimento c
where	a.nr_prescricao				= b.nr_prescricao
and	a.cd_procedimento		= c.cd_procedimento
and	a.ie_origem_proced		= c.ie_origem_proced
and	b.nr_atendimento			= nr_atendimento_w  /*Gerar a guia para todas as prescricoes do atendimento*/
and	((coalesce(a.cd_setor_atendimento,0)		= cd_setor_atendimento_w) or (cd_setor_atendimento_w			= -1))
and	((coalesce(a.nr_doc_convenio,'X')			= cd_autorizacao_ww) or (cd_autorizacao_ww			= 'Y'))
and	substr(coalesce(a.ds_dado_clinico,'X'),1,255)			= coalesce(ds_inicacao_clinica_w, 'X')
and (coalesce(ie_suspenso,'N') 			= 'N')
and (coalesce(ie_prescr_unica_w,'N')			= 'S')  /*Gerar a guia para todas as prescricoes do atendimento*/
and 	((coalesce((obter_tipo_procedimento(a.cd_procedimento,a.ie_origem_proced,'C'))::numeric ,999) = cd_tipo_proc_w) or (coalesce(cd_tipo_Proc_w::text, '') = '') )
and (coalesce(nr_seq_derivado::text, '') = '' or coalesce(ie_emitir_hemocomponente_w,'N') = 'S')
and	((position(ds_horario_w in a.ds_horarios)	> 0) or (ds_horario_w = '-1'))
group by tiss_obter_tabela(null, cd_estabelecimento_w, cd_convenio_w, cd_categoria_conv_w,
			 clock_timestamp(), 'R', c.ie_classificacao, a.cd_procedimento, a.ie_origem_proced, null, null, b.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_proced_tuss),
	a.cd_procedimento,
	substr(coalesce(obter_desc_prescr_proc_exam(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno, a.nr_seq_exame), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced)),1,255),
	dt_prescricao,
	substr(coalesce(a.ds_observacao,coalesce(b.ds_observacao,a.ds_justificativa)) ,1,3999),
	a.ie_origem_proced,
	b.cd_estabelecimento,
	coalesce(cd_convenio_w,a.cd_convenio),
	a.nr_seq_proc_interno,
	a.nr_sequencia,
	b.ds_observacao,
	a.ie_urgencia,
	a.DT_PREV_EXECUCAO,
	a.ie_lado,
	a.nr_seq_proc_interno,
	a.nr_seq_exame,
	substr(obter_descricao_padrao('TOPOGRAFIA_DOR','DS_TOPOGRAFIA',a.nr_seq_topografia),1,255),
	CASE WHEN ie_senha_guia_w='P' THEN a.cd_senha  ELSE null END ,
	b.ie_recem_nato,
	TISS_OBTER_QTDADE_GUIA_PRESCR(cd_estabelecimento_w, cd_convenio_w, a.cd_procedimento, a.ie_origem_proced),
	a.cd_proced_tuss,
	b.cd_medico,
	b.nr_prescricao
order by nr_seq_proc_prescr;

c12 CURSOR FOR
SELECT	cd_procedimento_convenio,
	cd_edicao_amb,
	ds_procedimento,
	qt_solicitada,
	qt_autorizada,
	null
from	tiss_opm_solicitado_v
where	ds_versao			= '2.01.01'
and	ie_origem			= 'RE'
and	nr_prescricao		= nr_prescr_tiss_p;

c08 CURSOR FOR
SELECT	a.nr_sequencia,
	a.nr_atendimento,
	coalesce(a.nr_doc_convenio, c.nr_doc_convenio) cd_guia,
	a.cd_medico,
	a.ie_funcao_medico
from	atend_categoria_convenio c,
	atendimento_paciente e,
	pep_med_fatur a
where	c.nr_atendimento	= a.nr_atendimento
and	e.nr_atendimento	= c.nr_atendimento
and	a.nr_sequencia		= nr_seq_med_fatur_p;

c09 CURSOR FOR
SELECT	a.cd_procedimento,
	substr(obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced),1,255),
	a.qt_fatur,
	a.qt_fatur,
	e.dt_entrada,
	e.dt_alta,
	tiss_obter_tabela(null, e.cd_estabelecimento, x.cd_convenio, x.cd_categoria,
	b.dt_faturamento, 'R', y.ie_classificacao, a.cd_procedimento, a.ie_origem_proced, null, null, e.nr_atendimento,a.nr_seq_proc_interno),
	a.dt_procedimento,
	substr(tiss_obter_grau_partic(b.ie_funcao_medico),1,10),
	a.ie_via_acesso,
	a.ie_tecnica_utilizada,
	a.nr_seq_proc_interno,
	a.ie_origem_proced
from	procedimento y,
	atend_categoria_convenio x,
	atendimento_paciente e,
	pep_med_fatur_proc a,
	pep_med_fatur b
where	a.nr_seq_fatur		= b.nr_sequencia
and	e.nr_atendimento	= b.nr_atendimento
and	x.nr_atendimento	= e.nr_atendimento
and	a.cd_procedimento	= y.cd_procedimento
and	a.ie_origem_proced	= y.ie_origem_proced
and	b.nr_sequencia		= nr_seq_med_fatur_p;

c10 CURSOR FOR
SELECT	coalesce(b.cd_procedimento_convenio, b.cd_procedimento),
	b.ds_procedimento,
	sum(b.qt_solicitada),
	sum(b.qt_autorizada),
	b.cd_edicao_relat
from	tiss_proc_solicitado_v b

where	((b.cd_procedimento_convenio	= lpad(cd_procedimento_w, 8, 0)) or (ie_proc_solic_spsadt_w 	= 'AG' and b.cd_autorizacao = cd_autorizacao_w))
and	b.ie_origem			= 'AC'
and	b.ds_versao			= '2.01.01'
and	b.nr_atendimento		= nr_atendimento_w
and	coalesce(ie_proc_solic_spsadt_w,'AC') <> 'AD'
group by
	coalesce(b.cd_procedimento_convenio, b.cd_procedimento),
	b.ds_procedimento,
	b.cd_edicao_relat

union

SELECT	coalesce(b.cd_procedimento_convenio, b.cd_procedimento),
	b.ds_procedimento,
	sum(b.qt_solicitada),
	sum(b.qt_autorizada),
	b.cd_edicao_relat
from	tiss_proc_solicitado_v b
where	b.cd_procedimento_convenio	= lpad(cd_procedimento_w, 8, 0)
and	b.ds_procedimento		= ds_proced_convenio_w  --Se a descricao da view for de 60 posicoes e na conta for maior que isso. teremos que alterar a view para 150 posicoes e tratar os projetos XML que usam 60 posicoes (V 2.0) do TISS.
and	b.ie_origem			= 'AC'
and	b.ds_versao			= '2.01.01'
and	b.nr_atendimento		= nr_atendimento_w
and	coalesce(ie_proc_solic_spsadt_w,'AC')=  'AD'
group by
	coalesce(b.cd_procedimento_convenio, b.cd_procedimento),
	b.ds_procedimento,
	b.cd_edicao_relat;



c11 CURSOR FOR
SELECT	nr_interno_conta
from	conta_paciente
where	((nr_interno_conta	= nr_interno_conta_p) or
		((coalesce(nr_interno_conta_p,0) <= 0) and (nr_atendimento = nr_atend_conta_tiss_w)));

c13 CURSOR FOR
SELECT	ie_emitir_zerado
from	tiss_regra_item_zerado
where	coalesce(cd_convenio, cd_convenio_w)			= cd_convenio_w
and	coalesce(ie_tipo_atendimento, ie_tipo_atendimento_w) = ie_tipo_atendimento_w
and	coalesce(cd_area_procedimento, coalesce(cd_area_procedimento_w,0))	= coalesce(cd_area_procedimento_w,0)
and	coalesce(cd_especialidade, coalesce(cd_especialidade_w,0))		= coalesce(cd_especialidade_w,0)
and	coalesce(cd_grupo_proc, coalesce(cd_grupo_proc_w,0))			= coalesce(cd_grupo_proc_w,0)
and	coalesce(cd_procedimento, coalesce(cd_procedimento_w,0))			= coalesce(cd_procedimento_w,0)
and	ie_proc_solic 	= 'S'
order 	by coalesce(cd_procedimento, 0),
	coalesce(cd_grupo_proc, 0),
	coalesce(cd_especialidade, 0),
	coalesce(cd_area_procedimento, 0),
	coalesce(cd_convenio, 0),
	coalesce(ie_tipo_atendimento, 0);

c14 CURSOR FOR
SELECT	distinct
	coalesce((obter_tipo_procedimento(
		coalesce(a.cd_procedimento,(Obter_Cod_Proc_Interno_conv(a.nr_proc_interno,Obter_Convenio_Atendimento(c.nr_atendimento),null,c.dt_solicitacao,null))::numeric ),
		coalesce(a.ie_origem_proced,(Obter_origem_Proc_Interno_conv(a.nr_proc_interno,Obter_Convenio_Atendimento(c.nr_atendimento),null,c.dt_solicitacao,null))::numeric ),
		'C'))::numeric ,999)
from	pedido_exame_externo c,
	pedido_exame_externo_item a
where	a.nr_seq_pedido 		= c.nr_sequencia
and 	a.nr_seq_pedido			= nr_seq_pedido_exame_w
and	ie_quebra_proc_pep_w		= 'S'
and	((a.cd_cgc = cd_cgc_exec_w) or (cd_cgc_exec_w = 'X'))
and	coalesce(a.nr_doc_convenio,'X')	= coalesce(nr_doc_conv_exame_w,'X')

union

SELECT	null

where	ie_quebra_proc_pep_w		= 'N';

c15 CURSOR FOR
SELECT 	distinct
	coalesce((obter_tipo_procedimento(a.cd_procedimento,a.ie_origem_proced,'C'))::numeric ,999)
from	prescr_procedimento a,
	prescr_medica b,
	table(lista_pck.obter_lista(coalesce(ds_cpoe_itens_w,' '))) k
where	a.nr_prescricao			= b.nr_prescricao
and	(((coalesce(ds_cpoe_itens_w::text, '') = '') and (b.nr_prescricao 	= nr_prescr_tiss_p)) or (k.nr_registro 		= a.nr_seq_proc_cpoe))
and	ie_quebra_proc_pep_w	= 'S'

union

SELECT	null

where	ie_quebra_proc_pep_w	= 'N';

c16 CURSOR FOR
SELECT	ie_regra
from	tiss_regra_guia_princ
where	cd_estabelecimento					= cd_estabelecimento_w
and	cd_convenio						= cd_convenio_w
and	coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w,0))	= coalesce(ie_tipo_atendimento_w,0)
and (ie_tiss_tipo_guia					= '4')
order by coalesce(ie_tipo_atendimento, 0);

c17 CURSOR FOR
SELECT	a.nr_sequencia,
	c.cd_procedimento,
	substr(coalesce(c.ds_exame,obter_desc_procedimento(c.cd_procedimento,c.ie_origem_proced)),1,255),
	b.qt_exame,
	b.qt_exame,
	coalesce(a.nr_atendimento,Med_Obter_Atendimento_Cliente(a.nr_seq_cliente)) nr_atendimento,
	e.cd_pessoa_fisica,
	wheb_mensagem_pck.get_texto(314168),
	null,
	f.dt_inicio_consulta,
	coalesce(f.dt_saida,a.dt_solicitacao) dt_final_vigencia,
	null,
	null,
	null,
	f.dt_inicio_consulta,
	a.ds_dados_clinicos,
	substr(a.ds_cid,1,10),
	f.ie_tipo_atend_tiss,
	null,
	f.cd_usuario_convenio,
	a.ie_carater_solic
from 	med_pedido_exame a,
	med_ped_exame_cod b,
	med_exame_padrao c,
	agenda_consulta_v2 d,
	agenda e,
	med_atendimento f
where	a.nr_sequencia		= b.nr_seq_pedido
and	b.nr_seq_exame		= c.nr_sequencia
and (a.nr_seq_cliente 	= f.nr_seq_cliente or
	a.nr_atendimento	= f.nr_atendimento)
and	f.nr_atendimento	= (SELECT max(x.nr_atendimento) from med_atendimento x where x.nr_seq_cliente = a.nr_seq_cliente)	
and	f.nr_seq_agenda		= d.nr_seq_agenda
and	d.cd_agenda	 	= e.cd_agenda
and	a.nr_sequencia		= nr_seq_exame_param_w;

c18 CURSOR FOR
SELECT	null,
	d.cd_item_convenio,
	substr(c.ds_item,1,255),
	b.qt_item,
	b.qt_item,
	a.nr_atendimento,
	f.cd_pessoa_fisica,
	b.cd_guia,
	null,
	a.dt_inicio_consulta,
	a.dt_saida,
	null,
	null,
	null,
	a.dt_inicio_consulta,
	null,
	null,
	a.ie_tipo_atend_tiss,
	null,
	a.cd_usuario_convenio,
	d.nr_seq_tiss_tabela,
	b.vl_item
from	med_atendimento a,
	med_faturamento b,
	med_item c,
	med_item_convenio d,
	agenda_consulta_v2 e,
	agenda f
where	a.nr_atendimento	= b.nr_atendimento
and	b.nr_seq_item		= c.nr_sequencia
and	c.nr_sequencia		= d.nr_seq_item
and	d.nr_seq_plano		= a.nr_seq_plano
and	a.nr_seq_agenda		= e.nr_seq_agenda
and	e.cd_agenda		= f.cd_agenda
and	a.nr_atendimento	= nr_atend_med_p;

c19 CURSOR FOR
SELECT	distinct
	coalesce(cd_setor_atendimento,0),
	coalesce(nr_doc_convenio,'X'),
	substr(ds_dado_clinico,1,255)
from	prescr_procedimento
where	nr_prescricao		= nr_prescricao_w
and (coalesce(ie_suspenso,'N') 	= 'N')
and	IE_SETOR_PRESCR_p	= 'S'
and (coalesce(nr_seq_derivado::text, '') = '' or coalesce(ie_emitir_hemocomponente_w,'N') = 'S')

union

SELECT	distinct
	-1 cd_setor_atendimento,
	coalesce(nr_doc_convenio,'Y'),
	substr(ds_dado_clinico,1,255)
from	prescr_procedimento
where	nr_prescricao		= nr_prescricao_w
and (coalesce(nr_seq_derivado::text, '') = '' or coalesce(ie_emitir_hemocomponente_w,'N') = 'S')
and (coalesce(ie_suspenso,'N') 	= 'N')
and	IE_SETOR_PRESCR_p	= 'N';

c20 CURSOR FOR
SELECT	tiss_obter_tabela(null, cd_estabelecimento_w, cd_convenio_w, cd_categoria_conv_w,
			 clock_timestamp(), 'R', c.ie_classificacao, a.cd_procedimento, a.ie_origem_proced, null, null, b.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_proced_tuss) cd_edicao_amb,
	a.cd_procedimento,
	substr(coalesce(obter_desc_prescr_proc_exam(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno, a.nr_seq_exame), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced)),1,255),
	sum(TISS_OBTER_QTD_PROC_PRESCR(cd_estabelecimento_w, cd_convenio_w,a.nr_prescricao,a.nr_sequencia)),
	sum(TISS_OBTER_QTD_PROC_PRESCR(cd_estabelecimento_w, cd_convenio_w,a.nr_prescricao,a.nr_sequencia)),
	b.dt_prescricao,
	substr(coalesce(a.ds_observacao,coalesce(b.ds_observacao,a.ds_justificativa)) ,1,255),
	a.ie_origem_proced,
	b.cd_estabelecimento,
	coalesce(cd_convenio_w,a.cd_convenio),
	substr(tiss_eliminar_caractere(obter_desc_prescr_proc_exam(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno, nr_seq_pedido_exame_w)), 1, 60) ds_proc_tabela_interno,
	substr(tiss_eliminar_caractere(obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced)), 1, 60) ds_proc_exame_proc,
	substr(tiss_eliminar_caractere(coalesce(TISS_OBTER_DESC_PROCED(a.nr_sequencia, 0, 'DS_PROC_SPSADT'), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced))), 1, 60) ds_proc_procedimento,
	a.ie_urgencia,
	a.DT_PREV_EXECUCAO,
	substr(obter_valor_dominio(1372, a.ie_lado),1,254),
	a.nr_seq_proc_interno,
	a.nr_seq_exame,
	substr(obter_descricao_padrao('TOPOGRAFIA_DOR','DS_TOPOGRAFIA',a.nr_seq_topografia),1,255),
	a.nr_sequencia nr_seq_proc_prescr,
	substr(coalesce(a.ds_observacao,a.ds_justificativa),1,255),
	TISS_OBTER_QTDADE_GUIA_PRESCR(cd_estabelecimento_w, cd_convenio_w, a.cd_procedimento, a.ie_origem_proced)
from	prescr_procedimento a,
	prescr_medica b,
	procedimento c
where	a.nr_prescricao			= b.nr_prescricao
and	a.cd_procedimento		= c.cd_procedimento
and	a.ie_origem_proced		= c.ie_origem_proced
and	b.nr_prescricao			= nr_prescricao_w
and	((coalesce(a.cd_setor_atendimento,0)	= cd_setor_atendimento_w) or (cd_setor_atendimento_w		= -1))
and	((coalesce(a.nr_doc_convenio,'X')		= cd_autorizacao_ww) or (cd_autorizacao_ww		= 'Y'))
and	substr(coalesce(a.ds_dado_clinico,'X'),1,255)		= coalesce(ds_inicacao_clinica_w, 'X')
and (coalesce(ie_suspenso,'N') 		= 'N')
and (coalesce(ie_prescr_unica_w,'N')		= 'N')
and 	((coalesce((obter_tipo_procedimento(a.cd_procedimento,a.ie_origem_proced,'C'))::numeric ,999) = cd_tipo_proc_w) or (coalesce(cd_tipo_Proc_w::text, '') = '') )
and (coalesce(nr_seq_derivado::text, '') = '' or coalesce(ie_emitir_hemocomponente_w,'N') = 'S')
and	((position(ds_horario_w in a.ds_horarios)	> 0) or (ds_horario_w = '-1'))
group by tiss_obter_tabela(null, cd_estabelecimento_w, cd_convenio_w, cd_categoria_conv_w,
			 clock_timestamp(), 'R', c.ie_classificacao, a.cd_procedimento, a.ie_origem_proced, null, null, b.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_proced_tuss),
	a.cd_procedimento,
	substr(coalesce(obter_desc_prescr_proc_exam(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno, a.nr_seq_exame), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced)),1,255),
	dt_prescricao,
	b.ds_observacao,
	a.ds_observacao,
	a.ds_justificativa,
	a.ie_origem_proced,
	b.cd_estabelecimento,
	coalesce(cd_convenio_w,a.cd_convenio),
	a.nr_seq_proc_interno,
	a.nr_sequencia,
	b.ds_observacao,
	a.ie_urgencia,
	a.DT_PREV_EXECUCAO,
	a.ie_lado,
	a.nr_seq_proc_interno,
	a.nr_seq_exame,
	substr(obter_descricao_padrao('TOPOGRAFIA_DOR','DS_TOPOGRAFIA',a.nr_seq_topografia),1,255),
	substr(coalesce(a.ds_observacao,a.ds_justificativa),1,255),
	TISS_OBTER_QTDADE_GUIA_PRESCR(cd_estabelecimento_w, cd_convenio_w, a.cd_procedimento, a.ie_origem_proced)

union all

SELECT	tiss_obter_tabela(null, cd_estabelecimento_w, cd_convenio_w, cd_categoria_conv_w,
			 clock_timestamp(), 'R', c.ie_classificacao, a.cd_procedimento, a.ie_origem_proced, null, null, b.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_proced_tuss) cd_edicao_amb,
	a.cd_procedimento,
	substr(coalesce(obter_desc_prescr_proc_exam(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno, a.nr_seq_exame), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced)),1,255),
	sum(a.qt_procedimento),
	sum(a.qt_procedimento),
	b.dt_prescricao,
	substr(coalesce(a.ds_observacao,coalesce(b.ds_observacao,a.ds_justificativa)) ,1,255),
	a.ie_origem_proced,
	b.cd_estabelecimento,
	coalesce(cd_convenio_w,a.cd_convenio),
	substr(tiss_eliminar_caractere(obter_desc_prescr_proc_exam(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno, nr_seq_pedido_exame_w)), 1, 60) ds_proc_tabela_interno,
	substr(tiss_eliminar_caractere(obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced)), 1, 60) ds_proc_exame_proc,
	substr(tiss_eliminar_caractere(coalesce(TISS_OBTER_DESC_PROCED(a.nr_sequencia, 0, 'DS_PROC_SPSADT'), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced))), 1, 60) ds_proc_procedimento,
	a.ie_urgencia,
	a.DT_PREV_EXECUCAO,
	substr(obter_valor_dominio(1372, a.ie_lado),1,254),
	a.nr_seq_proc_interno,
	a.nr_seq_exame,
	substr(obter_descricao_padrao('TOPOGRAFIA_DOR','DS_TOPOGRAFIA',a.nr_seq_topografia),1,255),
	a.nr_sequencia nr_seq_proc_prescr,
	substr(coalesce(a.ds_observacao,a.ds_justificativa),1,255),
	TISS_OBTER_QTDADE_GUIA_PRESCR(cd_estabelecimento_w, cd_convenio_w, a.cd_procedimento, a.ie_origem_proced)
from	prescr_procedimento a,
	prescr_medica b,
	procedimento c
where	a.nr_prescricao				= b.nr_prescricao
and	a.cd_procedimento			= c.cd_procedimento
and	a.ie_origem_proced			= c.ie_origem_proced
and	b.nr_prescricao				= nr_prescricao_w
and	((coalesce(a.cd_setor_atendimento,0)		= cd_setor_atendimento_w) or (cd_setor_atendimento_w			= -1))
and	((coalesce(a.nr_doc_convenio,'X')			= cd_autorizacao_ww) or (cd_autorizacao_ww			= 'Y'))
and	substr(coalesce(a.ds_dado_clinico,'X'),1,255)			= coalesce(ds_inicacao_clinica_w, 'X')
and (coalesce(ie_suspenso,'N') 			= 'N')
and (coalesce(ie_prescr_unica_w,'N')			= 'S')
and 	((coalesce((obter_tipo_procedimento(a.cd_procedimento,a.ie_origem_proced,'C'))::numeric ,999) = cd_tipo_proc_w) or (coalesce(cd_tipo_Proc_w::text, '') = '') )
and (coalesce(nr_seq_derivado::text, '') = '' or coalesce(ie_emitir_hemocomponente_w,'N') = 'S')
and	((position(ds_horario_w in a.ds_horarios)	> 0) or (ds_horario_w = '-1'))
group by tiss_obter_tabela(null, cd_estabelecimento_w, cd_convenio_w, cd_categoria_conv_w,
			 clock_timestamp(), 'R', c.ie_classificacao, a.cd_procedimento, a.ie_origem_proced, null, null, b.nr_atendimento,a.nr_seq_proc_interno, a.nr_seq_exame, a.cd_proced_tuss),
	a.cd_procedimento,
	substr(coalesce(obter_desc_prescr_proc_exam(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno, a.nr_seq_exame), obter_descricao_procedimento(a.cd_procedimento, a.ie_origem_proced)),1,255),
	dt_prescricao,
	b.ds_observacao,
	a.ds_observacao,
	a.ds_justificativa,
	a.ie_origem_proced,
	b.cd_estabelecimento,
	coalesce(cd_convenio_w,a.cd_convenio),
	a.nr_seq_proc_interno,
	a.nr_sequencia,
	b.ds_observacao,
	a.ie_urgencia,
	a.DT_PREV_EXECUCAO,
	a.ie_lado,
	a.nr_seq_proc_interno,
	a.nr_seq_exame,
	substr(obter_descricao_padrao('TOPOGRAFIA_DOR','DS_TOPOGRAFIA',a.nr_seq_topografia),1,255),
	substr(coalesce(a.ds_observacao,a.ds_justificativa),1,255),
	TISS_OBTER_QTDADE_GUIA_PRESCR(cd_estabelecimento_w, cd_convenio_w, a.cd_procedimento, a.ie_origem_proced)
order by nr_seq_proc_prescr;

c21 CURSOR FOR
SELECT 	distinct
	coalesce((obter_tipo_procedimento(a.cd_procedimento,a.ie_origem_proced,'C'))::numeric ,999)
from	prescr_procedimento a,
	prescr_medica b
where	a.nr_prescricao			= b.nr_prescricao
and	b.nr_prescricao			= nr_prescricao_w
and	ie_quebra_proc_pep_w	= 'S'

union

SELECT	null

where	ie_quebra_proc_pep_w	= 'N';

c22 CURSOR FOR
SELECT	cd_procedimento_convenio,
	cd_edicao_amb,
	ds_procedimento,
	qt_solicitada,
	qt_autorizada,
	null
from	tiss_opm_solicitado_v
where	ds_versao			= '2.01.01'
and	ie_origem			= 'RE'
and	nr_prescricao		= nr_prescricao_w;

c24 CURSOR FOR
SELECT 	a.ie_codigo_tuss,
	a.ie_desc_tuss
from 	tiss_regra_tuss a
where	a.cd_estabelecimento	= cd_estabelecimento_w
and 	a.cd_convenio		= cd_convenio_w
and 	a.dt_inicio_vigencia	<= dt_autorizacao_w
and (exists (SELECT	1
			from	tiss_regra_tuss_filtro x
			where	x.nr_seq_regra						= a.nr_sequencia
			and	coalesce(x.ie_classif_proced,coalesce(ie_classif_proced_w,'X'))	= coalesce(ie_classif_proced_w,'X')) or
	not exists (select	1
			from	tiss_regra_tuss_filtro x
			where	x.nr_seq_regra				= a.nr_sequencia))
order by a.dt_inicio_vigencia;

c25 CURSOR FOR
SELECT	ie_data_entrada
from	tiss_regra_data_int
where	cd_estabelecimento				= cd_estabelecimento_w
and	coalesce(cd_convenio,coalesce(cd_convenio_w,0))		= coalesce(cd_convenio_w,0)
order by 	coalesce(cd_convenio,0);

c26 CURSOR FOR
SELECT	ie_regra
from	tiss_regra_guia_princ
where	cd_estabelecimento					= cd_estabelecimento_w
and	cd_convenio						= cd_convenio_w
and	coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w,0))	= coalesce(ie_tipo_atendimento_w,0)
and (ie_tiss_tipo_guia					= '2')
order by coalesce(ie_tipo_atendimento, 0);

c27 CURSOR FOR
SELECT	ie_regra,
	cd_medico_solic_tiss
from	tiss_regra_medico_solic
where	cd_estabelecimento						= cd_estabelecimento_w
and	coalesce(cd_convenio, cd_convenio_w)					= cd_convenio_w
and	coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w,0))		= coalesce(ie_tipo_atendimento_w,0)
and	coalesce(ie_clinica, coalesce(ie_clinica_w,0))		= coalesce(ie_clinica_w,0)
and	coalesce(cd_setor_entrada, coalesce(cd_setor_entrada_w,0))		= coalesce(cd_setor_entrada_w,0)
and	coalesce(cd_medico_atend, coalesce(cd_medico_atend_w,'X'))		= coalesce(cd_medico_atend_w,'X')
and	coalesce(cd_medico_solic_autor, coalesce(cd_medico_solic_autor_w,'X'))	= coalesce(cd_medico_solic_autor_w,'X')
and	coalesce(ie_autorizacao,'N')						= 'S'
order by	coalesce(cd_convenio, 0),
	coalesce(ie_tipo_atendimento, 0),
	coalesce(cd_medico_atend,'X'),
	coalesce(cd_medico_solic_autor,'X');

c28 CURSOR FOR
SELECT	distinct
	coalesce(nr_seq_grupo,9999999)
FROM pedido_exame_externo_item a
LEFT OUTER JOIN med_exame_padrao b ON (a.nr_seq_exame = b.nr_sequencia)
WHERE a.nr_seq_pedido				= nr_seq_pedido_exame_w and coalesce(ie_quebra_grupo_exame_w,'N')	= 'S' and coalesce(a.nr_doc_convenio,'X')		= coalesce(nr_doc_conv_exame_w,'X') and ((a.cd_cgc = cd_cgc_exec_w) or (cd_cgc_exec_w = 'X'))

union

SELECT	null

where	coalesce(ie_quebra_grupo_exame_w,'N')	= 'N';

c29 CURSOR FOR
SELECT	distinct
	a.nr_doc_convenio nr_doc_convenio
from	pedido_exame_externo c,
	pedido_exame_externo_item a
where	a.nr_seq_pedido 		= c.nr_sequencia
and 	a.nr_seq_pedido			= nr_seq_pedido_exame_w
and	((a.cd_cgc = cd_cgc_exec_w) or (cd_cgc_exec_w = 'X'))
and	coalesce(a.nr_doc_convenio,'X')	<> 'X'

union

SELECT	'X'
from	pedido_exame_externo c,
	pedido_exame_externo_item a
where	a.nr_seq_pedido 		= c.nr_sequencia
and 	a.nr_seq_pedido			= nr_seq_pedido_exame_w
and	((a.cd_cgc = cd_cgc_exec_w) or (cd_cgc_exec_w= 'X'))
and	coalesce(a.nr_doc_convenio,'X')	= 'X'
order by nr_doc_convenio;

c30 CURSOR FOR
SELECT	a.nr_cirurgia,
	a.nr_atendimento,
	b.nr_doc_convenio,
	a.cd_medico_cirurgiao
from	cirurgia a,
	atend_categoria_convenio b,
	atendimento_paciente e
where	e.nr_atendimento	= a.nr_atendimento
and	e.nr_atendimento	= b.nr_atendimento
and	b.nr_seq_interno	= obter_atecaco_atendimento(a.nr_atendimento)
and	a.nr_cirurgia		= nr_cirurgia_p;

c31 CURSOR FOR
SELECT	a.cd_procedimento_princ,
	substr(coalesce(CASE WHEN 	ie_desc_proc_interno_w='P' THEN  obter_descricao_procedimento(a.cd_procedimento_princ, a.ie_origem_proced) WHEN 	ie_desc_proc_interno_w='N' THEN  obter_descricao_procedimento(a.cd_procedimento_princ, a.ie_origem_proced) WHEN 	ie_desc_proc_interno_w='S' THEN  coalesce(obter_desc_proc_interno(a.nr_seq_proc_interno), obter_descricao_procedimento(a.cd_procedimento_princ, a.ie_origem_proced))		 END , obter_descricao_procedimento(a.cd_procedimento_princ, a.ie_origem_proced)),1,255) ds_procedimento,
	1,
	1,
	e.dt_entrada,
	e.dt_alta,
	tiss_obter_tabela(null, e.cd_estabelecimento, x.cd_convenio, x.cd_categoria,
			  a.dt_inicio_real, 'R', y.ie_classificacao, a.cd_procedimento_princ, a.ie_origem_proced, null, null, e.ie_tipo_atendimento,a.nr_seq_proc_interno, null, a.cd_procedimento_tuss),
	a.dt_inicio_real dt_proc,
	'00',
	null ie_via_acesso,
	null ie_tecnica_utilizada,
	a.nr_seq_proc_interno
from	cirurgia a,
	procedimento y,
	atend_categoria_convenio x,
	atendimento_paciente e
where	a.cd_procedimento_princ	= y.cd_procedimento
and	a.ie_origem_proced	= y.ie_origem_proced
and	e.nr_atendimento	= a.nr_atendimento
and	e.nr_atendimento	= x.nr_atendimento
and	x.nr_seq_interno	= obter_atecaco_atendimento(e.nr_atendimento)
and	a.nr_cirurgia		= nr_cirurgia_p

union all

SELECT	b.cd_procedimento,
	substr(coalesce(CASE WHEN 	ie_desc_proc_interno_w='P' THEN  obter_descricao_procedimento(b.cd_procedimento, b.ie_origem_proced) WHEN 	ie_desc_proc_interno_w='N' THEN  obter_descricao_procedimento(b.cd_procedimento, b.ie_origem_proced) WHEN 	ie_desc_proc_interno_w='S' THEN  coalesce(obter_desc_proc_interno(b.nr_seq_proc_interno), obter_descricao_procedimento(b.cd_procedimento, b.ie_origem_proced))	 END , obter_descricao_procedimento(b.cd_procedimento, b.ie_origem_proced)),1,255) ds_procedimento,
	1,
	1,
	e.dt_entrada,
	e.dt_alta,
	tiss_obter_tabela(null, e.cd_estabelecimento, x.cd_convenio, x.cd_categoria,
			  a.dt_inicio_real, 'R', y.ie_classificacao, b.cd_procedimento, b.ie_origem_proced, null, null, e.ie_tipo_atendimento,b.nr_seq_proc_interno, b.nr_seq_exame, b.cd_proced_tuss),
	a.dt_inicio_real dt_proc,
	'00',
	null ie_via_acesso,
	null ie_tecnica_utilizada,
	b.nr_seq_proc_interno
from	prescr_procedimento b,
	cirurgia a,
	procedimento y,
	atend_categoria_convenio x,
	atendimento_paciente e
where	b.nr_prescricao		= a.nr_prescricao
and	a.cd_procedimento_princ	= y.cd_procedimento
and	a.ie_origem_proced	= y.ie_origem_proced
and	e.nr_atendimento	= a.nr_atendimento
and	e.nr_atendimento	= x.nr_atendimento
and	x.nr_seq_interno	= obter_atecaco_atendimento(e.nr_atendimento)
and	a.nr_cirurgia		= nr_cirurgia_p
and	(b.cd_medico_exec IS NOT NULL AND b.cd_medico_exec::text <> '');

c32 CURSOR FOR
SELECT 	ds_horario
from 	w_tiss_horarios_prescr
where 	nm_usuario 	= nm_usuario_p
and	nr_prescricao	= nr_prescr_tiss_p

union

SELECT	'-1' ds_horario

where	not exists (select	1
	from	w_tiss_horarios_prescr
	where 	nm_usuario 	= nm_usuario_p
	and	nr_prescricao	= nr_prescr_tiss_p)
order by ds_horario;

c33 CURSOR FOR
SELECT	a.nr_sequencia,
	b.nr_atendimento,
	a.nr_interno_conta,
	a.cd_autorizacao,
	a.ie_tipo_atend_tiss,
	a.ie_tipo_saida,
	'4' ie_tiss_tipo_guia,
	a.cd_autorizacao_princ,
	a.cd_cgc_prestador,
	a.dt_autorizacao,
	a.cd_senha,
	a.dt_validade_senha,
	a.dt_emissao_guia,
	b.dt_entrada,
	b.ie_carater_internacao,
	a.cd_medico_executor,
	a.ie_honorario,
	a.nr_sequencia_autor
from	tiss_conta_guia a,
	tiss_conta_atend b
where	a.nr_seq_reap_conta	= b.nr_seq_reap_conta
and	a.nr_seq_reap_conta	= nr_seq_reap_conta_p
and	a.ie_tiss_tipo_guia	= '4';

c34 CURSOR FOR
SELECT	cd_procedimento,
	cd_edicao_amb,
	sum(qt_procedimento),
	vl_reducao_acrescimo,
	sum(vl_procedimento) vl_procedimento,
	ie_via_acesso,
	vl_unitario,
	substr(ds_procedimento,1,255),
	dt_procedimento,
	dt_inicio_cir,
	dt_fim_cir,
	ie_tecnica_utilizada,
	cd_cbos,
	nr_seq_apresentacao,
	cd_setor_execucao
from (
	SELECT	a.cd_procedimento,
		a.cd_edicao_amb,
		sum(a.qt_procedimento) qt_procedimento,
		sum(a.vl_reducao_acrescimo) vl_reducao_acrescimo,
		sum(a.vl_procedimento) vl_procedimento,
		a.ie_via_acesso,
		a.vl_unitario,
		a.ds_procedimento,
		trunc(a.dt_procedimento, 'dd') dt_procedimento,
		a.dt_inicio_cir,
		a.dt_fim_cir,
		a.ie_tecnica_utilizada,
		a.cd_cbos,
		CASE WHEN ie_agrupar_proc_w='S' THEN  1  ELSE a.nr_sequencia END  ie_union,
		CASE WHEN ie_agrupar_proc_w='S' THEN  0  ELSE a.nr_seq_apresentacao END  nr_seq_apresentacao,
		a.cd_setor_execucao
	from	tiss_conta_proc a
	where	nr_seq_reap_conta	= nr_seq_reap_conta_p
	and	ie_tiss_tipo_guia	= '4'
	group by a.ie_via_acesso,
		a.vl_unitario,
		a.ds_procedimento,
		trunc(a.dt_procedimento, 'dd'),
		a.dt_inicio_cir,
		a.dt_fim_cir,
		a.cd_procedimento,
		a.cd_cbos,
		a.cd_edicao_amb,
		--decode(ie_agrupar_proc_w, 'S', 1, a.nr_seq_proc), Edgar 07/01/2011, OS 280348, nao agrupar
		CASE WHEN ie_agrupar_proc_w='S' THEN  1  ELSE a.nr_sequencia END ,
		a.ie_tecnica_utilizada,
		CASE WHEN ie_agrupar_proc_w='S' THEN  0  ELSE a.nr_seq_apresentacao END ,
		a.cd_setor_execucao
	
union all

	select	null,
		null,
		(null)::numeric ,
		(null)::numeric ,
		(null)::numeric ,
		null,
		(null)::numeric ,
		null,
		to_date(null),
		to_date(null),
		to_date(null),
		null,
		null,
		2 ie_union,
		0 nr_seq_apresentacao,
		null
	from	tiss_conta_desp a
	where	a.nr_seq_reap_conta	= nr_seq_reap_conta_p
	and	not exists (	select	1
				from	tiss_conta_proc b
				where	a.nr_seq_reap_conta	= b.nr_seq_reap_conta)
	
union all

	select	null,
		null,
		(null)::numeric ,
		(null)::numeric ,
		(null)::numeric ,
		null,
		(null)::numeric ,
		null,
		to_date(null),
		to_date(null),
		to_date(null),
		null,
		null,
		3 ie_union,
		0 nr_seq_apresentacao,
		null
	from	tiss_conta_opm_exec a
	where	a.nr_seq_reap_conta	= nr_seq_reap_conta_p
	and	not exists (	select	1
				from	tiss_conta_proc b
				where	a.nr_seq_reap_conta	= b.nr_seq_reap_conta)) alias24
group	by cd_procedimento,
	cd_edicao_amb,
	vl_reducao_acrescimo,
	ie_via_acesso,
	vl_unitario,
	ds_procedimento,
	dt_procedimento,
	dt_inicio_cir,
	dt_fim_cir,
	ie_tecnica_utilizada,
	cd_cbos,
	CASE WHEN ie_agrupar_proc_w='S' THEN  1  ELSE ie_union END ,
	nr_seq_apresentacao,
	cd_setor_execucao
order by coalesce(nr_seq_apresentacao,0),
	CASE WHEN ie_ordenacao_spsadt_w='1' THEN  ie_via_acesso  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='2' THEN  dt_procedimento  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='2' THEN  dt_inicio_cir  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='3' THEN  CASE WHEN TISS_OBTER_SE_PROC_PRINCIPAL(nr_interno_conta_w,cd_procedimento,0)='S' THEN  1  ELSE 2 END   ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='3' THEN  dt_procedimento  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='3' THEN  dt_inicio_cir  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='3' THEN  cd_procedimento  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='4' THEN  dt_procedimento  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='4' THEN  dt_inicio_cir  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='4' THEN  cd_procedimento  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='6' THEN  ie_via_acesso  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='6' THEN  dt_procedimento  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='6' THEN  cd_procedimento  ELSE '' END ,
	CASE WHEN ie_ordenacao_spsadt_w='6' THEN  vl_procedimento  ELSE 0 END;

c35 CURSOR FOR
SELECT 	ds_horario
from 	w_tiss_horarios_prescr
where 	nm_usuario 	= nm_usuario_p
and	nr_prescricao	= nr_prescricao_w

union

SELECT	'-1' ds_horario

where	not exists (select	1
	from	w_tiss_horarios_prescr
	where 	nm_usuario 	= nm_usuario_p
	and	nr_prescricao	= nr_prescricao_w)
order by ds_horario;

c36 CURSOR FOR
SELECT	nr_cpf,
	ie_funcao_medico,
	nm_medico_executor,
	sg_conselho,
	nr_crm,
	substr(uf_crm,1,2),
	cd_medico_convenio,
	nr_cpf_relat,
	cd_cbos
from	tiss_conta_partic
where	nr_seq_proc	= nr_seq_procedimento_w
order by ie_funcao_medico;

c37 CURSOR FOR
SELECT	distinct
	coalesce(a.cd_cgc,'X') cd_cgc
from	pedido_exame_externo c,
	pedido_exame_externo_item a
where	a.nr_seq_pedido 		= c.nr_sequencia
and 	a.nr_seq_pedido			= nr_seq_pedido_exame_w
and	ie_prest_exec_pedido_exame_w	= 'E'

union

SELECT	'X'

where	ie_prest_exec_pedido_exame_w	= 'N'
order by cd_cgc desc;

c38 CURSOR FOR
SELECT	ie_tipo_acidente
from	tiss_tipo_acidente
where	nr_seq_acidente			= nr_seq_tipo_acidente_w
and	coalesce(dt_inicio_vigencia, to_date('01/01/1900','dd/mm/yyyy')) <= clock_timestamp()
order 	by coalesce(dt_inicio_vigencia, to_date('01/01/1900','dd/mm/yyyy'));


BEGIN

delete	from w_tiss_guia
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_dados_atendimento
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_beneficiario
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_proc_paciente
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_contratado_exec
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_totais
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_proc_solic
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_solicitacao
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_contratado_solic
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_relatorio
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_opm
where	nm_usuario		= nm_usuario_p;

delete	from w_tiss_opm_exec
where	nm_usuario		= nm_usuario_p;

delete 	from w_tiss_horarios_prescr
where 	nm_usuario 		= nm_usuario_p;

delete 	from w_tiss_proc_partic
where 	nm_usuario 		= nm_usuario_p;

ds_dt_prevista_exec_w := substr(obter_desc_expressao(963934),1,30);

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

begin
nr_atend_conta_tiss_w	:=  (nr_atend_conta_tiss_p)::numeric;
nr_seq_protocolo_w 	:=  (nr_seq_protocolo_p)::numeric;
nr_sequencia_autor_w	:=  (nr_sequencia_autor_p)::numeric;
exception
when others then
	nr_atend_conta_tiss_w	:= null;
end;

if (ds_imprimi_procedimento_p IS NOT NULL AND ds_imprimi_procedimento_p::text <> '')then
    ds_cpoe_itens_w := ds_imprimi_procedimento_p;
end if;

if (ds_imprimi_patologia_w IS NOT NULL AND ds_imprimi_patologia_w::text <> '')then
       ds_cpoe_itens_w := ds_cpoe_itens_w || ds_imprimi_patologia_w;
end if;

if (ds_imprimi_hemoterapia_p IS NOT NULL AND ds_imprimi_hemoterapia_p::text <> '')then
       ds_cpoe_itens_w := ds_cpoe_itens_w || ds_imprimi_hemoterapia_p;
end if;

if (coalesce(cd_evolucao_p,0) > 0) then
	select	max(nr_atendimento)
	into STRICT	nr_atend_conta_tiss_w
	from	evolucao_paciente
	where	cd_evolucao	= cd_evolucao_p;
end if;

if (coalesce(nr_seq_paciente_p,0) > 0) then
	nr_seq_protocolo_w := 0;
	/*Relatorios do PEP usam mesma TAG Seq Protocolo Quimioterapia*/
	
	if (coalesce(nr_sequencia_autor_w,-1) = -1) then	
		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_sequencia_autor_w
		from	autorizacao_convenio
		where	nr_seq_paciente_setor	= nr_seq_paciente_p
		and	ie_tipo_autorizacao	= '3'
		and (coalesce(nr_ciclo,nr_ciclo_p)  = nr_ciclo_p or coalesce(nr_ciclo_p::text, '') = '');
		if (nr_sequencia_autor_w = 0) then
			select	coalesce(max(a.nr_sequencia),0)
			into STRICT	nr_sequencia_autor_w
			from	autorizacao_convenio a
			where	a.nr_seq_paciente_setor	= nr_seq_paciente_p
			and	a.ie_tipo_autorizacao	= '3';
		end if;
	end if;


end if;

select	coalesce(max(ie_tipo_autorizacao),'0')
into STRICT	ie_tipo_autorizacao_w
from	autorizacao_convenio
where	nr_sequencia	= nr_sequencia_autor_w;

if (coalesce(nr_seq_pedido_exame_p,0) > 0) and (coalesce(nr_seq_exame_p,0) > 0) then

	nr_seq_pedido_exame_w	:= nr_seq_pedido_exame_p;
	nr_seq_exame_param_w	:= -1;

elsif (coalesce(nr_seq_pedido_exame_p,0) = -1) and (coalesce(nr_seq_exame_p,0) > 0) then

	nr_seq_pedido_exame_w	:= -1;
	nr_seq_exame_param_w	:= nr_seq_exame_p;

end if;

/* lhalves OS 308094 em 08/04/2011

nr_seq_pedido_exame_w	:= nr_seq_pedido_exame_p;
nr_seq_exame_param_w	:= nr_seq_exame_p;

select	count(*)
into	qt_seq_pedido_exame_w
from	pedido_exame_externo
where	nr_sequencia	= nr_seq_pedido_exame_w;

select	count(*)
into	qt_seq_exame_w
from	pedido_exame_externo
where	nr_sequencia	= nr_seq_exame_param_w;

if	(qt_seq_exame_w > 0) then
	nr_seq_pedido_exame_w	:= nr_seq_exame_param_w;
	nr_seq_exame_param_w	:= -1;
end if;
*/
select	max(a.cd_autorizacao)
into STRICT	cd_autorizacao_princ_exame_w
from	pedido_exame_externo a
where	a.nr_sequencia	= nr_seq_pedido_exame_w;

CALL tiss_convenio_pck.set_dt_referencia_tiss(null);

if (coalesce(nr_seq_protocolo_w,0) > 0) or (coalesce(nr_interno_conta_p,0) > 0) or (coalesce(nr_atend_conta_tiss_w,0) > 0) or (coalesce(nr_seq_prot_med_p,0) > 0) then

	if (coalesce(nr_interno_conta_p,0) > 0) then

		select	max(a.nr_atendimento),
			max(a.cd_convenio_parametro),
			max(a.cd_estabelecimento),
			max(a.dt_mesano_referencia),
			max(obter_setor_atendimento(a.nr_atendimento)),
			max(b.ie_tipo_atendimento),
			max(coalesce(a.ie_tipo_atend_tiss,b.ie_tipo_atend_tiss))
		into STRICT	nr_atendimento_w,
			cd_convenio_w,
			cd_estabelecimento_w,
			dt_mesano_referencia_w,
			cd_setor_entrada_w,
			ie_tipo_atend_eup_w,
			ie_tipo_atend_tiss_w
		from	conta_paciente a,
			atendimento_paciente b
		where	a.nr_interno_conta	= nr_interno_conta_p
		and	a.nr_atendimento	= b.nr_atendimento;

	elsif (coalesce(nr_atend_conta_tiss_w,0) > 0) then

		select	max(nr_atendimento),
			max(cd_convenio_parametro),
			max(cd_estabelecimento),
			max(dt_mesano_referencia)
		into STRICT	nr_atendimento_w,
			cd_convenio_w,
			cd_estabelecimento_w,
			dt_mesano_referencia_w
		from	conta_paciente
		where	nr_atendimento	= nr_atend_conta_tiss_w;

	end if;

	select 	coalesce(max(ie_gerar_tiss), 'S'),
		coalesce(max(ie_spsadt_atend_retorno),'S')
	into STRICT 	ie_gerar_tiss_w,
		ie_spsadt_atend_retorno_w
	from 	tiss_parametros_convenio
	where 	cd_estabelecimento	= cd_estabelecimento_w
	and 	cd_convenio		= cd_convenio_w;


	-- Edgar 01/08/2007, OS 64360, tratamento para recalcular a conta TISS qdo emitir o relatorio
	if (coalesce(ie_gerar_tiss_w,'S') = 'S') and
		((coalesce(ie_spsadt_atend_retorno_w,'S') = 'S') or (coalesce(obter_se_atend_retorno(nr_atendimento_w),'N') = 'N'))then

		open c11;
		loop
		fetch c11 into
			nr_interno_conta_w;
		EXIT WHEN NOT FOUND; /* apply on c11 */

			select	max(dt_atualizacao)
			into STRICT	dt_ult_atualizacao_w
			from (SELECT	dt_atualizacao
				from		procedimento_paciente
				where		nr_interno_conta	= nr_interno_conta_w
				
union

				SELECT	dt_atualizacao
				from		material_atend_paciente
				where		nr_interno_conta	= nr_interno_conta_w) alias1;

			select	coalesce(max(dt_geracao_tiss), dt_ult_atualizacao_w - 1),
				max(ie_status_acerto)
			into STRICT	dt_geracao_tiss_w,
				ie_status_acerto_w
			from	conta_paciente
			where	nr_interno_conta	= nr_interno_conta_w;

			if (ie_status_acerto_w = 1) and (dt_ult_atualizacao_w > dt_geracao_tiss_w ) then
				CALL tiss_atualizar_prot_conta(null, nr_interno_conta_w, null, null, 'N', to_char(Obter_Estab_Conta_Paciente(nr_interno_conta_w)), nm_usuario_p);
			end if;
			if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
		end loop;
		close c11;


		if (coalesce(nr_seq_protocolo_w,0) > 0) then

			select	max(c.cd_ans),
				max(b.ds_arquivo_logo_tiss),
				max(b.cd_convenio),
				max(a.cd_estabelecimento),
				max(a.cd_prestador_convenio),
				max(coalesce(a.dt_referencia_tiss,a.dt_mesano_referencia))
			into STRICT	cd_ans_w,
				ds_arquivo_logo_w,
				cd_convenio_w,
				cd_estabelecimento_w,
				cd_prestador_convenio_w,
				dt_mesano_referencia_w
			from	pessoa_juridica c,
				convenio b,
				protocolo_convenio a
			where	a.cd_convenio		= b.cd_convenio
			and	b.cd_cgc		= c.cd_cgc
			and	a.nr_seq_protocolo	= nr_seq_protocolo_w;

			CALL tiss_convenio_pck.set_dt_referencia_tiss(dt_mesano_referencia_w);

		elsif (coalesce(nr_interno_conta_p,0) > 0) then

			select	max(cd_ans),
				max(b.ds_arquivo_logo_tiss),
				max(b.cd_convenio),
				max(a.cd_estabelecimento),
				max(a.dt_mesano_referencia)
			into STRICT	cd_ans_w,
				ds_arquivo_logo_w,
				cd_convenio_w,
				cd_estabelecimento_w,
				dt_mesano_referencia_w
			from	pessoa_juridica c,
				convenio b,
				conta_paciente a
			where	a.cd_convenio_parametro	= b.cd_convenio
			and	b.cd_cgc		= c.cd_cgc
			and	a.nr_interno_conta	= nr_interno_conta_p;

		elsif (coalesce(nr_atend_conta_tiss_w,0) > 0) then

			ie_convenio_particular_w := 'Z';
			begin
				select	'X'
				into STRICT	ie_convenio_particular_w
				from	conta_paciente a,
					convenio c
				where	a.cd_convenio_parametro = c.cd_convenio
				and	c.ie_tipo_convenio = 1
				and	a.nr_atendimento = nr_atend_conta_tiss_w
				and 	exists (	SELECT	1
						from	conta_paciente x,
							convenio y
						where	x.cd_convenio_parametro = y.cd_convenio
						and	y.ie_tipo_convenio <> 1
						and	x.nr_atendimento = nr_atend_conta_tiss_w);
			exception
			when others then
				ie_convenio_particular_w := 'Z';
			end;

			select	max(cd_ans),
				max(b.ds_arquivo_logo_tiss),
				max(b.cd_convenio),
				max(a.cd_estabelecimento),
				max(a.dt_mesano_referencia)
			into STRICT	cd_ans_w,
				ds_arquivo_logo_w,
				cd_convenio_w,
				cd_estabelecimento_w,
				dt_mesano_referencia_w
			from	pessoa_juridica c,
				convenio b,
				conta_paciente a
			where	a.cd_convenio_parametro	= b.cd_convenio
			and	b.cd_cgc		= c.cd_cgc
			and	a.nr_atendimento	= nr_atend_conta_tiss_w
			and	((ie_convenio_particular_w = 'X' and b.ie_tipo_convenio <> 1) or (ie_convenio_particular_w <> 'X'));

		elsif (coalesce(nr_seq_prot_med_p,0) > 0) then

			select	max(cd_ans),
				max(b.ds_arquivo_logo_tiss),
				max(b.cd_convenio),
				max(wheb_usuario_pck.get_cd_estabelecimento)
			into STRICT	cd_ans_w,
				ds_arquivo_logo_w,
				cd_convenio_w,
				cd_estabelecimento_w
			from	pessoa_juridica c,
				convenio b,
				med_prot_convenio a
			where	a.cd_convenio		= b.cd_convenio
			and	b.cd_cgc		= c.cd_cgc
			and	a.nr_sequencia		= nr_seq_prot_med_p;

		end if;

		select	coalesce(max(ie_data_ass_prest), 'S'),
			max(ds_arquivo_logo_comp)
		into STRICT	ie_data_ass_prest_w,
			ds_arquivo_logo_comp_w
		from	tiss_parametros_convenio
		where	cd_estabelecimento	= cd_estabelecimento_w
		and	cd_convenio		= cd_convenio_w;

		select	tiss_obter_versao(cd_convenio_w,cd_estabelecimento_w,dt_mesano_referencia_w)
		into STRICT	ds_versao_w
		;

		begin
			select	im_logo_convenio
			into STRICT	im_logo_convenio_w
			from	tiss_logo_convenio
			where	cd_convenio	   = cd_convenio_w
			and 	coalesce(ie_situacao,'N') = 'A';
		exception
		when others then
			im_logo_convenio_w := null;
		end;

		if (coalesce(im_logo_convenio_w::text, '') = '') and (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') then
			ds_arquivo_logo_w := tiss_diretorio_logo(ds_arquivo_logo_comp_w, ds_dir_padrao_p) || ds_arquivo_logo_w;
		end if;

		if (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') and (coalesce(im_logo_convenio_w::text, '') = '') then

			insert	into w_tiss_relatorio(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_arquivo_logo,
				im_logo_convenio)
			values (nextval('w_tiss_relatorio_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				ds_arquivo_logo_w,
				null);
		else
			insert	into w_tiss_relatorio(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_arquivo_logo,
				im_logo_convenio)
			values (nextval('w_tiss_relatorio_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				null,
				im_logo_convenio_w);
		end if;

		select	coalesce(max(IE_AGRUPAR_PROC), 'S'),
			coalesce(max(ie_exec_spsadt),'N'),
			coalesce(max(ie_proc_solic_spsadt), 'AC'),
			coalesce(max(ie_ordenacao_spsadt), '0'),
			coalesce(max(ie_obs_urgente), 'N'),
			coalesce(max(ie_quebra_proc_pep), 'N')
		into STRICT	ie_agrupar_proc_w,
			ie_trazer_executor_w,
			ie_proc_solic_spsadt_w,
			ie_ordenacao_spsadt_w,
			ie_obs_urgente_w,
			ie_quebra_proc_pep_w
		from	TISS_PARAMETROS_CONVENIO
		where	cd_estabelecimento	= cd_estabelecimento_w
		and	cd_convenio		= cd_convenio_w;

		open c01;
		loop
		fetch c01 into
			nr_seq_conta_guia_w,
			nr_atendimento_w,
			nr_interno_conta_w,
			cd_autorizacao_w,
			ie_tipo_atendimento_w,
			ie_tipo_saida_w,
			ie_tiss_tipo_guia_w,
			cd_autorizacao_princ_w,
			cd_cgc_prestador_w,
			dt_autorizacao_w,
			cd_senha_w,
			dt_validade_senha_w,
			dt_emissao_guia_w,
			dt_atendimento_w,
			ds_carater_internacao_w,
			cd_medico_executor_w,
			ie_honorario_w,
			nr_seq_autor_W,
			ie_tipo_atend_guia_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */

			qt_proc_guia_w 		:= 0;
			nr_seq_apres_proc_w	:= 0;
			nr_seq_apresent_opm_w	:= 0;


			nr_seq_apresentacao_w	:= 0;
			open c02;
			loop
			fetch c02 into
				cd_procedimento_w,
				cd_edicao_amb_w,
				qt_procedimento_w,
				vl_reducao_acrescimo_w,
				vl_procedimento_w,
				ie_via_acesso_w,
				vl_unitario_w,
				ds_proced_convenio_w,
				dt_procedimento_w,
				dt_inicio_cirurgia_w,
				dt_fim_cirurgia_w,
				ie_tecnica_utilizada_w,
				cd_cbos_w,
				nr_seq_apresent_proc_w,
				nr_seq_procedimento_w,
				cd_setor_execucao_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */

				qt_proc_guia_w		:= qt_proc_guia_w + 1;

				if (qt_proc_guia_w = 1) then
					nr_seq_apres_partic_w	:= 0;
					nr_seq_apres_proc_w	:= 0;
					nr_seq_apresentacao_w	:= 0;
					nr_seq_guia_w := tiss_gerar_cabecalho_spsadt(nr_seq_conta_guia_w, nr_seq_guia_w, nm_usuario_p);
				end if;

				/*select	max(nr_seq_guia)
				into	nr_seq_guia_proc_w
				from	w_tiss_proc_paciente;

				if	(nr_seq_guia_proc_w <> nr_seq_guia_w) then
					nr_seq_apres_proc_w	:= 0;
					nr_seq_apresentacao_w	:= 0;
					nr_seq_apres_partic_w	:= 0;
				end if;*/
				nr_seq_apres_proc_w	:= nr_seq_apres_proc_w + 1;

				insert	into w_tiss_proc_paciente(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_guia,
					cd_procedimento,
					cd_edicao_amb,
					qt_procedimento,
					vl_reducao_acrescimo,
					vl_procedimento,
					dt_entrada,
					dt_alta,
					ie_via_acesso,
					vl_unitario,
					ds_procedimento,
					dt_procedimento,
					dt_inicio_cirurgia,
					dt_fim_cirurgia,
					nr_seq_apresentacao,
					ie_tecnica_utilizada)
				values (nextval('w_tiss_proc_paciente_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w,
					cd_procedimento_w,
					cd_edicao_amb_w,
					qt_procedimento_w,
					vl_reducao_acrescimo_w,
					vl_procedimento_w,
					dt_entrada_w,
					dt_alta_w,
					ie_via_acesso_w,
					vl_unitario_w,
					ds_proced_convenio_w,
					dt_procedimento_w,
					dt_inicio_cirurgia_w,
					dt_fim_cirurgia_w,
					nr_seq_apres_proc_w,
					ie_tecnica_utilizada_w);

				if	((ie_proc_solic_spsadt_w = 'AC') or (ie_proc_solic_spsadt_w = 'AG')) and (coalesce(nr_seq_prot_med_p,0) < 0) then

					open c10;
					loop
					fetch c10 into
						cd_proc_solic_w,
						ds_proced_solic_w,
						qt_solicitada_w,
						qt_autorizada_w,
						cd_edicao_amb_solic_w;
					EXIT WHEN NOT FOUND; /* apply on c10 */

						if (length(cd_proc_solic_w) = 10) then
							if (substr(cd_proc_solic_w, 1,2) = '00') then
								cd_proc_solic_w		:= substr(cd_proc_solic_w, 3, 8);
							end if;
						end if;

						nr_seq_apresentacao_w := nr_seq_apresentacao_w + 1;

						insert into w_tiss_proc_solic(nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							nr_seq_guia,
							cd_procedimento,
							cd_edicao_amb,
							ds_procedimento,
							qt_solicitada,
							qt_autorizada,
							nr_seq_apresentacao)
						values (nextval('w_tiss_proc_solic_seq'),
							clock_timestamp(),
							nm_usuario_p,
							nr_seq_guia_w,
							cd_proc_solic_w,
							cd_edicao_amb_solic_w,
							coalesce(ds_proced_convenio_w, ds_proced_solic_w),
							qt_solicitada_w,
							qt_autorizada_w,
							nr_seq_apresentacao_w);

					end loop;
					close c10;

				else

					insert into w_tiss_proc_solic(nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						nr_seq_guia,
						cd_procedimento,
						cd_edicao_amb,
						ds_procedimento,
						qt_solicitada,
						qt_autorizada,
						nr_seq_apresentacao)
					values (nextval('w_tiss_proc_solic_seq'),
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_guia_w,
						cd_procedimento_w,
						cd_edicao_amb_w,
						coalesce(ds_proced_convenio_w, ds_procedimento_w),
						qt_procedimento_w,
						qt_procedimento_w,
						nr_seq_apres_proc_w);

				end if;

				if (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'S') then

					nr_seq_apres_proc_anterior_w := null;

					open C36;
					loop
					fetch C36 into
						nr_cpf_w,
						ds_funcao_medico_w,
						nm_pessoa_fisica_w,
						sg_conselho_w,
						nr_crm_w,
						uf_crm_w,
						CD_MEDICO_CONVENIO_w,
						nr_cpf_relat_w,
						cd_cbo_saude_w;
					EXIT WHEN NOT FOUND; /* apply on C36 */
						begin

						if	nr_seq_apres_partic_w = 5 then --Se chegou no 5 participante, para o 6 gera uma nova guia
							CALL TISS_COMPLETAR_GUIA(nr_seq_guia_w, nm_usuario_p);
							nr_seq_guia_w := TISS_GERAR_CABECALHO_SPSADT(nr_seq_conta_guia_w, nr_seq_guia_w, nm_usuario_p);

							nr_seq_apres_partic_w		:= 0;
							nr_seq_apres_proc_anterior_w	:= nr_seq_apres_proc_w;
							nr_seq_apres_proc_w		:= 0;
						end if;

						nr_seq_apres_partic_w	:= nr_seq_apres_partic_w + 1;	

						insert	into w_tiss_proc_partic(nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							nr_seq_guia,
							nr_seq_procedimento,
							nr_seq_apresentacao,
							ie_funcao_medico,
							nr_cpf,
							nm_pessoa_fisica,
							sg_conselho,
							nr_crm,
							uf_crm,
							cd_interno,
							nr_cpf_relat,
							cd_cbos)
						values (nextval('w_tiss_proc_partic_seq'),
							clock_timestamp(),
							nm_usuario_p,
							nr_seq_guia_w,
							CASE WHEN  nr_seq_apres_proc_w =0 THEN  nr_seq_apres_proc_anterior_w  ELSE nr_seq_apres_proc_w END ,
							nr_seq_apres_partic_w,
							ds_funcao_medico_w,
							substr(tiss_obter_regra_campo(4, 'CD_IDENTIFICACAO', CD_CONVENIO_W, nr_cpf_w, coalesce(ie_tipo_atend_eup_w,ie_tipo_atendimento_w), cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, coalesce(ie_tipo_atend_guia_w,ie_tipo_atend_tiss_w)||'#@',cd_setor_execucao_w),1,11),
							nm_pessoa_fisica_w,
							sg_conselho_w,
							substr(tiss_obter_regra_campo(4, 'NR_CRM', CD_CONVENIO_W, nr_crm_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, coalesce(ie_tipo_atend_guia_w,ie_tipo_atend_tiss_w)||'#@',cd_setor_execucao_w), 1, 20),

							uf_crm_w,
							tiss_obter_regra_campo(4, 'CD_IDENTIFICACAO', CD_CONVENIO_W, cD_MEDICO_CONVENIO_w, coalesce(ie_tipo_atend_eup_w,ie_tipo_atendimento_w), cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, coalesce(ie_tipo_atend_guia_w,ie_tipo_atend_tiss_w)||'#@',cd_setor_execucao_w),
							nr_cpf_relat_w,
							cd_cbo_saude_w);




						end;
					end loop;
					close C36;
				end if;

				if (qt_proc_guia_w = 5) then
					qt_proc_guia_w		:= 0;
					nr_seq_apres_partic_w	:= 0;
					CALL TISS_GERAR_OPM_EXEC(nr_seq_conta_guia_w, nr_seq_guia_w, nm_usuario_p);
					CALL TISS_COMPLETAR_GUIA(nr_seq_guia_w, nm_usuario_p);
				end if;

			end loop;
			close c02;

			if (qt_proc_guia_w > 0) and (qt_proc_guia_w < 5) then
				CALL TISS_GERAR_OPM_EXEC(nr_seq_conta_guia_w, nr_seq_guia_w, nm_usuario_p);
			end if;

			CALL TISS_COMPLETAR_GUIA(nr_seq_guia_w, nm_usuario_p);

			if (coalesce(ie_somente_prescr_p,'N') = 'S') and (coalesce(nr_prescr_tiss_p,-1) > 0)then --Se marcado o parametro exclui a guia que foi gerada para outro procedimento diferente da prescricao
				Select 	max(a.cd_doenca_cid),
					substr(max(b.ds_dado_clinico),1,255)
				into STRICT	cd_cid_proc_presc_w,
					ds_inicacao_clinica_w
				from	prescr_procedimento_cid a,
					prescr_procedimento b
				where	a.nr_prescricao		= b.nr_prescricao
				and	b.nr_prescricao 	= nr_prescr_tiss_p;

				if (cd_cid_proc_presc_w IS NOT NULL AND cd_cid_proc_presc_w::text <> '') or (ds_inicacao_clinica_w IS NOT NULL AND ds_inicacao_clinica_w::text <> '') then

					update	w_tiss_solicitacao
					set	cd_cid		= coalesce(cd_cid_proc_presc_w,cd_cid),
						ds_indicacao	= coalesce(ds_inicacao_clinica_w,ds_indicacao)
					where	nr_seq_guia	= nr_seq_guia_w;

				end if;

				delete 	from w_tiss_guia a
				where	a.nr_sequencia	= nr_seq_guia_w
				and	not exists
					(SELECT	1
					from	tiss_conta_proc b,
						tiss_conta_guia c,
						procedimento_paciente d
					where	b.nr_seq_guia		= c.nr_sequencia
					and	c.nr_sequencia		= a.nr_seq_conta_guia
					and 	((d.nr_sequencia 	= b.nr_seq_proc) or (somente_numero(d.cd_procedimento_tuss) 	= somente_numero(b.cd_procedimento) or
						  somente_numero(d.cd_procedimento_convenio) 	= somente_numero(b.cd_procedimento) or
						  somente_numero(d.cd_procedimento) 		= somente_numero(b.cd_procedimento)))
					and	c.ie_tiss_tipo_guia	= '4'
					and	d.nr_prescricao		= nr_prescr_tiss_p);
			end if;

		end loop;
		close c01;
	end if;

elsif (coalesce(nr_sequencia_autor_w,0) > 0) and (ie_tipo_autorizacao_w in ('3','5', '4')) then

	select	cd_ans,
		b.ds_arquivo_logo_tiss,
		b.cd_convenio
	into STRICT	cd_ans_w,
		ds_arquivo_logo_w,
		cd_convenio_w
	from	pessoa_juridica c,
		convenio b,
		autorizacao_convenio a
	where	a.cd_convenio		= b.cd_convenio
	and	b.cd_cgc		= c.cd_cgc
	and	a.nr_sequencia		= nr_sequencia_autor_w;

	select	cd_autorizacao,
		TISS_OBTER_DATA_AUTOR(nr_sequencia),
		cd_senha,
		dt_fim_vigencia,
		nr_atendimento,
		ds_observacao,
		cd_setor_origem,
		nr_seq_agenda,
		cd_autorizacao_prest,
		nr_prescricao
	into STRICT	cd_autorizacao_w,
		dt_autorizacao_w,
		cd_senha_w,
		dt_final_vigencia_w,
		nr_atendimento_w,
		ds_obs_autor_w,
		cd_setor_origem_w,
		nr_seq_agenda_w,
		cd_autorizacao_prest_w,
		nr_prescr_autor_w
	from	autorizacao_convenio
	where	nr_sequencia		= nr_sequencia_autor_w;

	if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then

		begin
		select	a.nr_doc_conv_principal,
			a.cd_categoria,
			c.cd_estabelecimento,
			obter_setor_atendimento(a.nr_atendimento)
		into STRICT	cd_autorizacao_princ_w,
			cd_categoria_conv_w,
			cd_estabelecimento_w,
			cd_setor_entrada_w
		from	atend_categoria_convenio a,
			autorizacao_convenio b,
			atendimento_paciente c
		where	b.nr_atendimento	= c.nr_atendimento
		and	a.nr_atendimento	= c.nr_atendimento
		and	a.nr_seq_interno	= obter_atecaco_atend_conv(c.nr_atendimento,cd_convenio_w)
		and	b.nr_sequencia		= nr_sequencia_autor_w;
		exception
		when others then
			select	max(a.cd_autorizacao),
				max(b.cd_categoria),
				max(b.cd_estabelecimento)
			into STRICT	cd_autorizacao_princ_w,
				cd_categoria_conv_w,
				cd_estabelecimento_w
			from	autorizacao_convenio_tiss b,
				autorizacao_convenio a
			where	b.nr_sequencia_autor	= a.nr_sequencia
			and	a.nr_sequencia		= nr_sequencia_autor_w;
		end;

		select	max(tiss_obter_se_atend_rn(nr_atendimento_w))
		into STRICT	ie_atendimento_rn_w
		;
	else
		select	max(a.cd_autorizacao),
			max(b.cd_categoria),
			max(b.cd_estabelecimento),
			max(tiss_obter_se_autor_rn(b.ie_cod_usuario_mae_resp, a.nr_sequencia,a.nr_seq_agenda, a.nr_seq_agenda_consulta))
		into STRICT	cd_autorizacao_princ_w,
			cd_categoria_conv_w,
			cd_estabelecimento_w,
			ie_atendimento_rn_w
		FROM autorizacao_convenio a
LEFT OUTER JOIN autorizacao_convenio_tiss b ON (a.nr_sequencia = b.nr_sequencia_autor)
WHERE a.nr_sequencia		= nr_sequencia_autor_w;

	end if;


	if (coalesce(cd_estabelecimento_w::text, '') = '') then
		select	max(cd_estabelecimento)
		into STRICT	cd_estabelecimento_w
		from	autorizacao_convenio
		where	nr_sequencia	= nr_sequencia_autor_w;
	end if;

	select 	coalesce(max(ie_gerar_tiss), 'S'),
		coalesce(max(ie_spsadt_atend_retorno),'S'),
		coalesce(max(ie_sadt_autor_sem_proc),'N'),
		max(ds_arquivo_logo_comp),
		coalesce(max(ie_conversao_sadt_solic),'S'),
		coalesce(max(ie_solicitante),'H'),
		coalesce(max(ie_lado_rep),'N'),
		coalesce(max(ie_topo_rep),'N')
	into STRICT 	ie_gerar_tiss_w,
		ie_spsadt_atend_retorno_w,
		ie_sadt_autor_sem_proc_w,
		ds_arquivo_logo_comp_w,
		ie_conversao_sadt_solic_w,
		ie_solicitante_w,
		ie_lado_rep_w,
		ie_topo_rep_w
	from 	tiss_parametros_convenio
	where 	cd_estabelecimento	= cd_estabelecimento_w
	and 	cd_convenio		= cd_convenio_w;



	if (coalesce(ie_gerar_tiss_w,'S') = 'S') and
		((coalesce(ie_spsadt_atend_retorno_w,'S') = 'S') or (obter_se_atend_retorno(nr_atendimento_w) = 'N')) then

		 begin
			select	im_logo_convenio
			into STRICT	im_logo_convenio_w
			from	tiss_logo_convenio
			where	cd_convenio	   = cd_convenio_w
			and 	coalesce(ie_situacao,'N') = 'A';
		exception
		when others then
			im_logo_convenio_w := null;
		end;

		if (coalesce(im_logo_convenio_w::text, '') = '') and (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') then
			ds_arquivo_logo_w := tiss_diretorio_logo(ds_arquivo_logo_comp_w, ds_dir_padrao_p) || ds_arquivo_logo_w;
		end if;

		if (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') and (coalesce(im_logo_convenio_w::text, '') = '') then

			insert	into w_tiss_relatorio(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_arquivo_logo,
				im_logo_convenio)
			values (nextval('w_tiss_relatorio_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				ds_arquivo_logo_w,
				null);
		else
			insert	into w_tiss_relatorio(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_arquivo_logo,
				im_logo_convenio)
			values (nextval('w_tiss_relatorio_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				null,
				im_logo_convenio_w);
		end if;

		select	max(a.nr_atendimento),
			max(b.dt_entrada),
			max(b.ie_tipo_atendimento),
			--max(b.cd_estabelecimento),
			max(b.nr_seq_classificacao),
			max(b.ie_tipo_atend_tiss),
			max(b.ie_clinica),
			max(b.cd_medico_resp),
			max(a.cd_medico_solicitante),
			max(a.cd_prestador_tiss),
			max(b.cd_medico_referido),
			max(a.nr_prescricao),
			max(a.ds_prestador_tiss)
		into STRICT	nr_atendimento_w,
			dt_atendimento_w,
			ie_tipo_atendimento_w,
			--cd_estabelecimento_w, Ja pega o estabelecimento antes
			nr_seq_classif_atend_w,
			ie_tipo_atend_tiss_w,
			ie_clinica_w,
			cd_medico_atend_w,
			cd_medico_solic_autor_w,
			cd_prestador_tiss_autor_w,
			cd_medico_referido_w,
			nr_prescricao_w,
			ds_prestador_solic_tiss_w
		FROM autorizacao_convenio a
LEFT OUTER JOIN atendimento_paciente b ON (a.nr_atendimento = b.nr_atendimento)
WHERE a.nr_sequencia		= nr_sequencia_autor_w;


		if (coalesce(nr_seq_agenda_w,0) > 0) and (coalesce(nr_atendimento_w,0) = 0)then

			select	max(a.ie_clinica),
				max(a.cd_procedencia),
				max(a.ie_tipo_atendimento),
				max(a.cd_categoria)
			into STRICT	ie_clinica_w,
				cd_procedencia_w,
				ie_tipo_atendimento_w,
				cd_categoria_conv_w
			from	agenda_paciente a
			where	a.nr_sequencia = nr_seq_agenda_w;

		end if;

		select	coalesce(max(IE_DESC_PROC_INTERNO), 'N'),
			coalesce(max(ie_assinatura_solic), 'N'),
			coalesce(max(ie_dt_emissao_guia),'P'),
			coalesce(max(ie_data_ass_prest),'N')	,
			coalesce(max(ie_data_entrada_ri),'E'),
			coalesce(max(ie_obs_prescr_autor), 'S'),
			coalesce(max(ie_agrupar_proc),'S')
		into STRICT	IE_DESC_PROC_INTERNO_W,
			ie_assinatura_solic_w,
			ie_dt_emissao_guia_w,
			ie_data_ass_prest_w,
			ie_data_entrada_w,
			ie_obs_prescr_autor_w,
			ie_agrupar_proc_w
		from	tiss_parametros_convenio
		where	cd_convenio		= cd_convenio_w
		and	cd_estabelecimento	= cd_estabelecimento_w;

		select	tiss_obter_versao(cd_convenio_w,cd_estabelecimento_w)
		into STRICT	ds_versao_w
		;		

		if (coalesce(ie_obs_prescr_autor_w,'S') = 'S') and (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then /*Se a autorizacao possui prescricao vinculada, busca a observacao do procedimento na prescricao*/
			select	max(a.ds_observacao)
			into STRICT	ds_obs_autor_w
			from	prescr_procedimento a,
				procedimento_autorizado b
			where	a.nr_prescricao		= b.nr_prescricao
			and	a.nr_sequencia		= b.nr_seq_prescricao
			and	b.nr_sequencia_autor	= nr_sequencia_autor_w
			and	a.nr_prescricao		= nr_prescricao_w;
		end if;

		if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then

			open C26;
			loop
			fetch C26 into
				ie_regra_guia_princ_w;
			EXIT WHEN NOT FOUND; /* apply on C26 */
			end loop;
			close C26;

			if (ie_regra_guia_princ_w = 'SI') then

				select	max(a.cd_autorizacao)
				into STRICT	cd_autorizacao_princ_w
				from	autorizacao_convenio a,
					estagio_autorizacao b
				where	a.nr_seq_estagio	= b.nr_sequencia
				and	b.ie_interno		= '10'
				and	a.ie_tipo_autorizacao	= '1'
				and	a.nr_atendimento	= nr_atendimento_w;

			end if;
		end if;

		if (ie_assinatura_solic_w	= 'S') then
			select	max(nm_medico_solicitante)
			into STRICT	ds_assinatura_solic_w
			from	tiss_dados_solicitante_v
			where	nr_sequencia_autor	= nr_sequencia_autor_w
			and	ds_versao		= '2.01.01'
			and	ie_origem		= 'AC';

			if (coalesce(ds_assinatura_solic_w::text, '') = '') then
				ds_assinatura_solic_w		:= '   ____________________________';
			end if;
		else
			ds_assinatura_solic_w		:= coalesce(tiss_obter_regra_campo(4, 'DS_ASSINATURA_SOLIC', cd_convenio_W, ds_assinatura_solic_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_execucao_w), '   ____________________________');
		end if;

		ds_assinatura_resp_w		:= coalesce(tiss_obter_regra_campo(4, 'DS_ASSINATURA_RESP', cd_convenio_W, ds_assinatura_resp_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_execucao_w), '   ____________________________');
		ds_assinatura_exec_w		:= coalesce(tiss_obter_regra_campo(4, 'DS_ASSINATURA_EXEC', cd_convenio_W, ds_assinatura_exec_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_execucao_w), '   ____________________________');

		qt_proc_guia_w 		:= 0;
		nr_seq_apresentacao_w	:= 0;

		open c03;
		loop
		fetch c03 into
			cd_procedimento_w,
			ds_procedimento_w,
			qt_solicitada_w,
			qt_autorizada_w,
			cd_edicao_amb_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */

			/*lhalves OS 356735 em 12/09/2011 - Alterado para cd_proc_tabela_w, pois estava considerando a conversao
			para obter a descricao do procedimento da tabela, e nao o codigo original do procedimento,
			gerando a descricao incorreta*/

			/*if	(ie_desc_proc_interno_w = 'S') then

				select	substr(tiss_eliminar_caractere(nvl(obter_desc_prescr_proc_exam(cd_proc_tabela_w, ie_origem_proced_w, null, null),
									   ds_procedimento_w)), 1, 60)
				into	ds_procedimento_w
				from	dual;

			elseif*/
			qt_proc_guia_w		:= qt_proc_guia_w + 1;

			if (qt_proc_guia_w = 1) then

				select	max(nr_seq_agenda)
				into STRICT	nr_seq_agenda_w
				from	autorizacao_convenio
				where	nr_sequencia	= nr_sequencia_autor_w;

				if (coalesce(cd_autorizacao_w::text, '') = '') or (cd_autorizacao_w = '0') then

					select	max(nr_doc_convenio)
					into STRICT	cd_autorizacao_w
					from	agenda_paciente
					where	nr_sequencia	= nr_seq_agenda_w;

				end if;

				if (coalesce(ie_data_ass_prest_w,'N') = 'S') then
					dt_assin_prest_w	:= dt_atendimento_w;

				elsif (coalesce(ie_data_ass_prest_w,'N') = 'N') then
					dt_assin_prest_w	:= clock_timestamp();
					dt_atendimento_w	:= clock_timestamp();
				elsif (coalesce(ie_data_ass_prest_w,'N') = 'V') then					
					dt_assin_prest_w	:= null;
					dt_atendimento_w	:= null;
				end if;

				/*if	(ie_dt_emissao_guia_w  = 'T') then
					dt_emissao_guia_w	:= dt_atendimento_w;
				else
					dt_emissao_guia_w	:= sysdate;
				end if;*/
				if (coalesce(ie_dt_emissao_guia_w,'P') = 'P') then
					select	min(dt_procedimento)
					into STRICT	dt_emissao_guia_w
					from	procedimento_paciente
					where	nr_atendimento		= nr_atendimento_w
					and	nr_doc_convenio		= cd_autorizacao_w
					and	coalesce(cd_motivo_exc_conta::text, '') = '';
				elsif (coalesce(ie_dt_emissao_guia_w,'P') = 'A') then
					select	max(dt_autorizacao)
					into STRICT	dt_emissao_guia_w
					from	autorizacao_convenio
					where	nr_sequencia		= nr_sequencia_autor_w;
				elsif (coalesce(ie_dt_emissao_guia_w,'P') = 'T') then
					select	max(dt_entrada)
					into STRICT	dt_emissao_guia_w
					from	atendimento_paciente
					where	nr_atendimento		= nr_atendimento_w;
				elsif (coalesce(ie_dt_emissao_guia_w,'P') = 'AA') then
					select	max(dt_autorizacao)
					into STRICT	dt_emissao_guia_w
					from	autorizacao_convenio
					where	nr_sequencia		= nr_sequencia_autor_w;
				elsif (coalesce(ie_dt_emissao_guia_w,'P') = 'IA') then
					select	max(dt_inicio_vigencia)
					into STRICT	dt_emissao_guia_w
					from	autorizacao_convenio
					where	nr_sequencia		= nr_sequencia_autor_w;
				elsif (coalesce(ie_dt_emissao_guia_w,'P') = 'IC') then
					select	max(a.dt_periodo_inicial)
					into STRICT	dt_emissao_guia_w
					from	conta_paciente a
					where	a.nr_atendimento		= nr_atendimento_w
					and	a.cd_convenio_parametro		= cd_convenio_w
					and	exists (SELECT	1
							from	conta_paciente_guia x
							where	x.nr_interno_conta	= a.nr_interno_conta
							and	x.cd_autorizacao	= cd_autorizacao_w);
				elsif (coalesce(ie_dt_emissao_guia_w,'P') = 'FC') then
					select	max(a.dt_periodo_final)
					into STRICT	dt_emissao_guia_w
					from	conta_paciente a
					where	a.nr_atendimento		= nr_atendimento_w
					and	a.cd_convenio_parametro		= cd_convenio_w
					and	exists (SELECT	1
							from	conta_paciente_guia x
							where	x.nr_interno_conta	= a.nr_interno_conta
							and	x.cd_autorizacao	= cd_autorizacao_w);
				elsif (coalesce(ie_dt_emissao_guia_w,'P') = 'CR') then /*lhalves OS262797 em 6/11/2010*/
					ie_dt_emiss_guia_regra_w	:= TISS_OBTER_REGRA_DATA_GUIA(cd_estabelecimento_w,cd_convenio_w,'4', ltrim(ie_tipo_atend_tiss_w,'0'),ie_clinica_w);

					if (ie_dt_emiss_guia_regra_w = 'A') then
						select	max(dt_entrada)
						into STRICT	dt_emissao_guia_w
						from	atendimento_paciente
						where	nr_atendimento		= nr_atendimento_w;
					elsif (ie_dt_emiss_guia_regra_w = 'AUSG') then
						select	max(dt_autorizacao)
						into STRICT	dt_emissao_guia_w
						from	autorizacao_convenio
						where	nr_sequencia		= nr_sequencia_autor_w;
					end if;
				end if;

				if (ie_data_entrada_w = 'R') then
					open c25;
					loop
					fetch c25 into
						ie_data_entrada_w;
					EXIT WHEN NOT FOUND; /* apply on c25 */
					end loop;
					close c25;
				end if;

				if (ie_data_entrada_w	= 'IC') then
					select	max(a.dt_periodo_inicial)
					into STRICT	dt_emissao_guia_w
					from	conta_paciente a
					where	a.nr_atendimento		= nr_atendimento_w
					and	a.cd_convenio_parametro		= cd_convenio_w
					and	exists (SELECT	1
							from	conta_paciente_guia x
							where	x.nr_interno_conta	= a.nr_interno_conta
							and	x.cd_autorizacao	= cd_autorizacao_w);
				elsif (ie_data_entrada_w	= 'I') then
					dt_entrada_w	:= coalesce(tiss_obter_data_internacao(nr_atendimento_w), clock_timestamp());
				elsif (ie_data_entrada_w	= 'A') then
					dt_entrada_w	:= coalesce(to_date(obter_dados_atendimento(nr_atendimento_w,'DA'),'dd/mm/yyyy hh24:mi:ss'), clock_timestamp());
				elsif (ie_data_entrada_w	= 'EA') then
					select	max(dt_envio)
					into STRICT 	dt_envio_autor_w
					from 	autorizacao_convenio
					where	nr_sequencia	= nr_sequencia_autor_w;

					dt_entrada_w	:= coalesce(dt_envio_autor_w,clock_timestamp());
				end if;

				SELECT * FROM TISS_OBTER_GUIA_PRESTADOR( cd_estabelecimento_w, cd_convenio_w, '2', nr_atendimento_w, null, cd_autorizacao_w, nr_sequencia_autor_w, nr_guia_prestador_w, ie_regra_guia_prest_w) INTO STRICT nr_guia_prestador_w, ie_regra_guia_prest_w;

				nr_guia_prestador_w	:= coalesce(nr_guia_prestador_w,to_char(nr_sequencia_autor_w));

				select	nextval('w_tiss_guia_seq')
				into STRICT	nr_seq_guia_w
				;

				insert	into w_tiss_guia(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					cd_ans,
					cd_autorizacao,
					dt_autorizacao,
					cd_senha,
					dt_validade_senha,
					dt_emissao_guia,
					nr_interno_conta,
					nr_seq_protocolo,
					nr_sequencia_autor,
					nr_atendimento,
					cd_autorizacao_princ,
					ds_observacao,
					ie_tiss_tipo_guia,
					dt_entrada,
					ds_assinatura_solic,
					ds_assinatura_resp,
					ds_assinatura_exec,
					DT_ASSIN_PREST,
					dt_assin_solic,
					ie_atendimento_rn,
					nr_guia_prestador,
					ds_versao)
				values (nr_seq_guia_w,
					clock_timestamp(),
					nm_usuario_p,
					cd_ans_w,
					tiss_obter_regra_campo(2, 'CD_AUTORIZACAO', CD_CONVENIO_W, cd_autorizacao_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
					tiss_obter_regra_campo(2, 'DT_AUTORIZACAO', CD_CONVENIO_W, dt_autorizacao_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
					cd_senha_w,
					to_date(tiss_obter_regra_campo(2, 'DT_VALIDADE_SENHA', CD_CONVENIO_W, to_char(dt_final_vigencia_w,'dd/mm/yyyy'), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),'dd/mm/yyyy'),
					coalesce(dt_emissao_guia_w,clock_timestamp()),
					null,
					null,
					nr_sequencia_autor_w,
					nr_atendimento_w,
					tiss_obter_regra_campo(2, 'CD_AUTORIZACAO_PRINC', CD_CONVENIO_W, cd_autorizacao_princ_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
					coalesce(tiss_obter_regra_campo(4, 'DS_OBSERVACAO', CD_CONVENIO_W, replace(ds_obs_autor_w,chr(10),' '), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'), substr(ds_obs_autor_w,1,4000)),
					'2',
					dt_atendimento_w,
					ds_assinatura_solic_w,
					ds_assinatura_resp_w,
					ds_assinatura_exec_w,
					dt_assin_prest_w,
					dt_autorizacao_w,
					ie_atendimento_rn_w,
					coalesce(cd_autorizacao_prest_w, nr_guia_prestador_w),
					ds_versao_w);

				select	max(nr_atendimento)
				into STRICT	nr_atend_w
				from	tiss_dados_paciente_v
				where	nr_atendimento	= nr_atendimento_w;



				if (nr_atend_w IS NOT NULL AND nr_atend_w::text <> '') then

					begin
					select	substr(obter_desc_plano(b.cd_convenio, b.cd_plano_convenio),1,40),
						b.dt_validade_carteira,
						b.cd_usuario_convenio
					into STRICT	ds_plano_w,
						dt_validade_carteira_w,
						cd_usuario_convenio_w
					from	atend_categoria_convenio b,
						atendimento_paciente a
					where	b.nr_seq_interno	= obter_atecaco_atend_conv(b.nr_atendimento,cd_convenio_w)
					and	b.nr_atendimento	= a.nr_atendimento
					and	a.nr_atendimento	= nr_atendimento_w;
					exception
					when others then
						select	max(ds_plano),
							max(dt_validade_carteira),
							max(cd_usuario_convenio)
						into STRICT	ds_plano_w,
							dt_validade_carteira_w,
							cd_usuario_convenio_w
						from	tiss_dados_paciente_v
						where	ds_versao		= '2.01.01'
						and	nr_sequencia_autor	= nr_sequencia_autor_w
						and	ie_origem		= 'AC';
					end;


					insert	into w_tiss_beneficiario(nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						nr_seq_guia,
						cd_pessoa_fisica,
						nm_pessoa_fisica,
						nr_cartao_nac_sus,
						ds_plano,
						dt_validade_carteira,
						cd_usuario_convenio)
					SELECT	nextval('w_tiss_beneficiario_seq'),
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_guia_w,
						c.cd_pessoa_fisica,
						substr(TISS_OBTER_TITULAR_CONV_RN(nr_atendimento_w, null, cd_convenio_w, cd_estabelecimento_w),1,150),
						c.nr_cartao_nac_sus,
						ds_plano_w,
						dt_validade_carteira_w,
						cd_usuario_convenio_w
					from	pessoa_fisica c,
						atendimento_paciente a
					where	a.cd_pessoa_fisica	= c.cd_pessoa_fisica
					and	a.nr_atendimento	= nr_atendimento_w;

				/*lhalves OS305885 em 30/03/2011 - substituido a view pelo select - Performance*/

				else
					select	max(cd_pessoa_fisica),
						max(coalesce(TISS_OBTER_TITULAR_CONV_RN(nr_atendimento_w, null, cd_convenio_w, cd_estabelecimento_w),nm_pessoa_fisica)),
						max(nr_cartao_nac_sus),
						max(ds_plano),
						max(dt_validade_carteira),
						max(cd_usuario_convenio)
					into STRICT	cd_pessoa_fisica_w,
						nm_pessoa_fisica_w,
						nr_cartao_nac_sus_w,
						ds_plano_w,
						dt_validade_carteira_w,
						cd_usuario_convenio_w
					from	tiss_dados_paciente_v
					where	ds_versao		= '2.01.01'
					and	nr_sequencia_autor	= nr_sequencia_autor_w
					and	ie_origem		= 'AC';

					insert	into w_tiss_beneficiario(nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						nr_seq_guia,
						cd_pessoa_fisica,
						nm_pessoa_fisica,
						nr_cartao_nac_sus,
						ds_plano,
						dt_validade_carteira,
						cd_usuario_convenio)
					values (nextval('w_tiss_beneficiario_seq'),
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_guia_w,
						cd_pessoa_fisica_w,
						nm_pessoa_fisica_w,
						nr_cartao_nac_sus_w,
						ds_plano_w,
						dt_validade_carteira_w,
						cd_usuario_convenio_w);
				end if;

				select	max(cd_medico_convenio)
				into STRICT	cd_medico_convenio_w
				from	tiss_dados_solicitante_v
				where	nr_sequencia_autor	= nr_sequencia_autor_w
				and	ds_versao		= '2.01.01'
				and	ie_origem		= 'AC'
				and	cd_convenio		= cd_convenio_w;

				ie_regra_med_solic_w		:= null;
				cd_medico_solic_tiss_w		:= null;
				open C27;
				loop
				fetch C27 into
					ie_regra_med_solic_w,
					cd_medico_solic_tiss_w;
				EXIT WHEN NOT FOUND; /* apply on C27 */
				end loop;
				close C27;

				if (ie_regra_med_solic_w = 'S') then
					cd_medico_solic_tiss_w	:= cd_medico_atend_w;
				elsif (ie_regra_med_solic_w = 'IR') and (cd_medico_solic_tiss_w IS NOT NULL AND cd_medico_solic_tiss_w::text <> '') then
					cd_medico_solic_tiss_w	:= cd_medico_solic_tiss_w;
				elsif (ie_regra_med_solic_w = 'MRF') then
					cd_medico_solic_tiss_w	:= cd_medico_referido_w;
				end if;

				if (cd_medico_solic_tiss_w IS NOT NULL AND cd_medico_solic_tiss_w::text <> '') then

					select	substr(obter_nome_pf_pj(cd_medico_solic_tiss_w,null),1,255) nm_medico,
						substr(OBTER_DADOS_MEDICO(cd_medico_solic_tiss_w,'SGCRM'),1,15),
						substr(OBTER_DADOS_MEDICO(cd_medico_solic_tiss_w,'CRM'),1,15),
						substr(OBTER_DADOS_MEDICO(cd_medico_solic_tiss_w,'UFCRM'),1,2)
					into STRICT	nm_medico_solicitante_w,
						sg_conselho_w,
						nr_crm_w,
						uf_crm_w
					;

				end if;

				/* RETIREI O TRATAMENTO A REGRA PRESTADOR SOLIC JA E CHAMADA NA TISS_ATUALIZAR_AUTORIZACAO

				if	(nvl(ie_solicitante_w,'H') = 'R') then


					tiss_obter_regra_prest_solic( cd_convenio_w, 
									cd_estabelecimento_w, 
									nvl(cd_setor_origem_w,cd_setor_entrada_w),
									ie_clinica_w, 
									cd_procedencia_w, 
									ie_tipo_atendimento_w,
									'N', 
									ie_solicitante_w, --out
									cd_cgc_prest_solic_regra_w, --out
									cd_medico_atendimento_w, 
									cd_medico_solic_w, --out
									cd_prestador_solic_tiss_w , --out
									ds_prestador_solic_tiss_w , --out
									null, 
									cd_categoria_conv_w, 
									sysdate, 
									null);

				end if;




				if 	(nvl(ie_solicitante_w,'H') = 'MC') then

					select	nvl(max(obter_se_medico_conveniado(cd_estabelecimento_w, cd_medico_convenio_w, cd_convenio_w, null, null, null,null,null,null, null, null)), 'N')
					into	ie_conveniado_w
					from	dual;

					if (nvl(ie_conveniado_w,'S') = 'S') then

						cd_cgc_w		:= tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_convenio_w, null, null, 'CI',null,ie_tipo_atendimento_w);
						ds_razao_social_w 	:= substr(obter_nome_pf_pj(cd_medico_convenio_w, null), 1, 150);
						cd_cnes_w		:= null;
					else
						cd_cgc_w 		:= obter_cgc_estabelecimento(cd_estabelecimento_w);
						ds_razao_social_w 	:= substr(obter_nome_pf_pj(null, cd_cgc_w), 1, 150);
					end if;

				elsif 	(nvl(ie_solicitante_w,'H') = 'H') then
					cd_cgc_w 		:= obter_cgc_estabelecimento(cd_estabelecimento_w);
					ds_razao_social_w 	:= substr(obter_nome_pf_pj(null, cd_cgc_w), 1, 150);

				elsif 	(nvl(ie_solicitante_w,'H') = 'M') then
					cd_cgc_w 		:= obter_dados_pf(cd_medico_convenio_w, 'CPF');
					ds_razao_social_w 	:= substr(obter_nome_pf_pj(cd_medico_convenio_w, null), 1, 150);
					cd_cnes_w		:= null;

				elsif 	(nvl(ie_solicitante_w,'H') = 'I') then

					if 	(cd_medico_solic_w is not null) then
						cd_cgc_w		:= nvl ((tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_solic_w, null, null, 'CI',null,ie_tipo_atendimento_w)),
										(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_solic_w, null, null, 'CPF',null,ie_tipo_atendimento_w)));
						ds_razao_social_w 	:= substr(obter_nome_pf_pj(cd_medico_solic_w, null), 1, 150);
						cd_cnes_w		:= null;

					elsif 	(cd_cgc_prest_solic_regra_w is not null) then

						cd_cgc_w		:= nvl ((tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prest_solic_regra_w, null, 'CI',null,ie_tipo_atendimento_w)),
										(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prest_solic_regra_w, null, 'CGC',null,ie_tipo_atendimento_w)));
						ds_razao_social_w 	:= substr(obter_nome_pf_pj(null, cd_cgc_prest_solic_regra_w), 1, 150);
					elsif	(cd_medico_solic_w is null) and
						(cd_cgc_prest_solic_regra_w is null) then

						cd_cgc_w		:= nvl ((tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_w, null, 'CI',null,ie_tipo_atendimento_w)),
										(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_w, null, 'CGC',null,ie_tipo_atendimento_w)));
						select	max(substr(obter_nome_pf_pj(null, cd_cgc_w), 1, 150))
						into	ds_razao_social_w
						from	dual;

					end if;

					if	(nvl(ds_prestador_solic_tiss_w,'X') <> 'X') then
						ds_razao_social_w	:= ds_prestador_solic_tiss_w;
					end if;

					if	(nvl(cd_prestador_solic_tiss_w,'X') <> 'X') then
						cd_cgc_w	:= cd_prestador_solic_tiss_w;
					end if;
				end if;
				*/
				if (cd_medico_convenio_w IS NOT NULL AND cd_medico_convenio_w::text <> '') then

					insert into w_tiss_contratado_solic(nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						nr_seq_guia,
						cd_cgc,
						cd_interno,
						nr_cpf,
						nm_contratado,
						nm_solicitante,
						cd_cnes,
						sg_conselho,
						nr_crm,
						uf_crm,
						cd_cbo_saude)
					SELECT	nextval('w_tiss_contratado_solic_seq'),
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_guia_w,
						nr_cpf,
						cd_medico_convenio_w,
						nr_cpf,
						coalesce(ds_prestador_solic_tiss_w,nm_medico_solicitante),
						tiss_obter_regra_campo(2, 'NM_SOLICITANTE', CD_CONVENIO_W, coalesce(nm_medico_solicitante_w,nm_medico_solicitante), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
						null,
						tiss_obter_regra_campo(2, 'SG_CONSELHO', CD_CONVENIO_W, coalesce(sg_conselho_w,sg_conselho), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
						substr(tiss_obter_regra_campo(2, 'NR_CRM', CD_CONVENIO_W, coalesce(nr_crm_w,nr_crm), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),1,20),
						substr(tiss_obter_regra_campo(2, 'UF_CRM', CD_CONVENIO_W, coalesce(uf_crm_w,uf_crm), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),1,2),
						tiss_obter_regra_campo(2, 'CD_CBO_SAUDE', CD_CONVENIO_W, coalesce(cd_cbo_med_prest_w, cd_cbo_saude), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@')
					from	tiss_dados_solicitante_v
					where	nr_sequencia_autor	= nr_sequencia_autor_w
					and	ds_versao		= '2.01.01'
					and	ie_origem		= 'AC';

				else

					insert into w_tiss_contratado_solic(nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						nr_seq_guia,
						cd_cgc,
						cd_interno,
						nr_cpf,
						nm_contratado,
						nm_solicitante,
						cd_cnes,
						sg_conselho,
						nr_crm,
						uf_crm,
						cd_cbo_saude)
					SELECT	nextval('w_tiss_contratado_solic_seq'),
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_guia_w,
						cd_cgc,
						coalesce(cd_prestador_tiss_autor_w,cd_interno),
						nr_cpf,
						coalesce(ds_prestador_solic_tiss_w,ds_razao_social),
						tiss_obter_regra_campo(2, 'NM_SOLICITANTE', CD_CONVENIO_W, coalesce(nm_medico_solicitante_w,nm_medico_solicitante), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
						cd_cnes,
						tiss_obter_regra_campo(2, 'SG_CONSELHO', CD_CONVENIO_W, coalesce(sg_conselho_w,sg_conselho), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
						tiss_obter_regra_campo(2, 'NR_CRM', CD_CONVENIO_W, coalesce(nr_crm_w,nr_crm), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
						substr(tiss_obter_regra_campo(2, 'UF_CRM', CD_CONVENIO_W, coalesce(uf_crm_w,uf_crm), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),1,2),
						tiss_obter_regra_campo(2, 'CD_CBO_SAUDE', CD_CONVENIO_W, coalesce(cd_cbo_med_prest_w, cd_cbo_saude), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@')
					from	tiss_dados_solicitante_v
					where	nr_sequencia_autor	= nr_sequencia_autor_w
					and	ds_versao		= '2.01.01'
					and	ie_origem		= 'AC';

				end if;

				/*lhalves OS 230225 em 05/08/2010 - verifica se existe CID na autorizacao.*/

				select	max(cd_doenca_cid),
					substr((coalesce(max(ds_diagnostico),max(OBTER_DESC_CID_DOENCA(cd_doenca_cid)))),1,255)
				into STRICT	cd_doenca_cid_autor_w,
					ds_observacao_autor_w
				from	tiss_diagnostico_v
				where	ds_versao		= '2.01.01'
				and	ie_origem		= 'ACD'
				and	nr_sequencia_autor 	= nr_sequencia_autor_w
				and	ie_classificacao_doenca 	= 'P';

				if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then /*Buscar CID e indicacao clinica da prescricao  se a autorizacao possuir prescricao*/
					Select 	max(a.cd_doenca_cid),
						max(b.ds_dado_clinico)
					into STRICT	cd_doenca_cid_autor_w,
						ds_observacao_autor_w
					from	prescr_procedimento_cid a,
						prescr_procedimento b
					where	a.nr_prescricao		= b.nr_prescricao
					and	b.nr_prescricao 	= nr_prescricao_w;

				end if;

				if (coalesce(cd_doenca_cid_autor_w::text, '') = '') then
					select	max(cd_doenca_cid),
						substr(max(ds_diagnostico),1,255)
					into STRICT	cd_doenca_cid_w,
						ds_observacao_w
					from	tiss_diagnostico_v
					where	ds_versao		= '2.01.01'
					and	ie_origem		= 'AC'
					and	nr_sequencia_autor 	= nr_sequencia_autor_w
					and	ie_classificacao_doenca 	= 'P';

					insert into w_tiss_solicitacao(nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						nr_seq_guia,
						dt_solicitacao,
						ie_carater_solic,
						cd_cid,
						ds_indicacao)
					SELECT	nextval('w_tiss_solicitacao_seq'),
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_guia_w,
						to_date(tiss_obter_regra_campo(2, 'DT_SOLICITACAO', CD_CONVENIO_W, to_char(coalesce(dt_entrada_w,dt_autorizacao), 'dd/mm/yyyy hh24:mi:ss'), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'), 'dd/mm/yyyy hh24:mi:ss'),
						ie_carater_inter_sus,
						tiss_obter_regra_campo(2, 'CD_DOENCA_CID', CD_CONVENIO_W, cd_doenca_cid_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
						substr(coalesce(a.ds_indicacao, ds_observacao_w),1,255)
					from	tiss_dados_solicitacao_v a
					where	a.nr_sequencia_autor	= nr_sequencia_autor_w
					and	ie_origem		= 'AC'
					and	ds_versao		= '2.01.01'  LIMIT 1;

				else /*Lhalves OS 573940 em 08/04/2013 - Se tem CID na autorizacao, busca da autorizacao, nao precisa fazer select da view*/
					insert into w_tiss_solicitacao(nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						nr_seq_guia,
						dt_solicitacao,
						ie_carater_solic,
						cd_cid,
						ds_indicacao)
					SELECT	nextval('w_tiss_solicitacao_seq'),
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_guia_w,
						to_date(tiss_obter_regra_campo(2, 'DT_SOLICITACAO', CD_CONVENIO_W, to_char(TISS_OBTER_DATA_AUTOR(a.nr_sequencia), 'dd/mm/yyyy hh24:mi:ss'), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'), 'dd/mm/yyyy hh24:mi:ss'),
						a.ie_carater_int_tiss,
						tiss_obter_regra_campo(2, 'CD_DOENCA_CID', CD_CONVENIO_W, cd_doenca_cid_autor_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
						substr(coalesce(a.ds_indicacao, ds_observacao_autor_w),1,255)
					from	autorizacao_convenio a
					where	a.nr_sequencia	= nr_sequencia_autor_w;

				end if;

			end if;

			nr_seq_apresentacao_w	:= nr_seq_apresentacao_w + 1;			

			insert into w_tiss_proc_solic(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nr_seq_guia,
				cd_procedimento,
				cd_edicao_amb,
				ds_procedimento,
				qt_solicitada,
				qt_autorizada,
				nr_seq_apresentacao)
			values (nextval('w_tiss_proc_solic_seq'),
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_guia_w,
				cd_procedimento_w,
				cd_edicao_amb_w,
				ds_procedimento_w,
				qt_solicitada_w,
				tiss_obter_regra_campo(2, 'QT_AUTORIZADA', CD_CONVENIO_W, qt_autorizada_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_execucao_w),
				nr_seq_apresentacao_w);

			if (qt_proc_guia_w = 5) then

				insert into w_tiss_contratado_exec(NR_SEQUENCIA,
					dt_ATUALIZACAO,
					nm_usUARIO,
					nr_seq_GUIA)
				values (nextval('w_tiss_contratado_exec_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w);

				insert	into w_tiss_totais(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_guia)
				values (nextval('w_tiss_totais_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w);

				qt_proc_guia_w		:= 0;
				nr_seq_apresentacao_w	:= 0;
				CALL TISS_COMPLETAR_GUIA(nr_seq_guia_w, nm_usuario_p);
			end if;

		end loop;
		close c03;

		if (qt_proc_guia_w > 0) and (qt_proc_guia_w < 5) then

			insert into w_tiss_contratado_exec(NR_SEQUENCIA,
				dt_ATUALIZACAO,
				nm_usUARIO,
				nr_seq_GUIA)
			values (nextval('w_tiss_contratado_exec_seq'),
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_guia_w);

			insert	into w_tiss_totais(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nr_seq_guia)
			values (nextval('w_tiss_totais_seq'),
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_guia_w);

		end if;

		if (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') then

			qt_proc_guia_w		:= 0;
			nr_seq_apresentacao_w	:= 0;

			open c05;
			loop
			fetch c05 into
				cd_opm_w,
				cd_edicao_w,
				ds_opm_w,
				qt_solicitada_w,
				qt_autorizada_w,
				ds_fabricante_w,
				vl_opm_w;
			EXIT WHEN NOT FOUND; /* apply on c05 */

				qt_proc_guia_w		:= qt_proc_guia_w + 1;
				nr_seq_apresentacao_w	:= nr_seq_apresentacao_w + 1;
				insert into w_tiss_opm(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_guia,
					cd_opm,
					cd_edicao,
					ds_opm,
					qt_solicitada,
					qt_autorizada,
					ds_fabricante,
					vl_opm,
					nr_seq_apresentacao)
				values (nextval('w_tiss_opm_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w,
					cd_opm_w,
					cd_edicao_w,
					ds_opm_w,
					qt_solicitada_w,
					qt_autorizada_w,
					ds_fabricante_w,
					vl_opm_w,
					nr_seq_apresentacao_w);

			end loop;
			close c05;

		end if;

		CALL TISS_COMPLETAR_GUIA(nr_seq_guia_w, nm_usuario_p);

	end if;

elsif (coalesce(nr_seq_pedido_exame_w,0) > 0 ) then

	qt_proc_guia_w 	:= 0;

	select	max(cd_ans),
		max(b.ds_arquivo_logo_tiss),
		max(b.cd_convenio),
		max(obter_tipo_atendimento(a.nr_atendimento)),
		max(a.cd_categoria),
		max(x.cd_estabelecimento),
		max(j.cd_doenca),
		max(x.nr_seq_classificacao),
		max(obter_setor_atendimento(a.nr_atendimento)),
		max(a.nr_atendimento),
		max(x.cd_medico_referido),
		max(j.dt_solicitacao),
		max(a.cd_plano_convenio),
		max(e.nr_prontuario)
	into STRICT	cd_ans_w,
		ds_arquivo_logo_w,
		cd_convenio_w,
		ie_tipo_atendimento_w,
		cd_categoria_conv_w,
		cd_estabelecimento_w,
		cd_cid_externo_w,
		nr_seq_classif_atend_w,
		cd_setor_entrada_w,
		nr_atendimento_w,
		cd_medico_referido_w,
		dt_solicitacao_w,
		cd_plano_convenio_w,
		nr_prontuario_w
	from	pessoa_juridica c,
		atendimento_paciente x,
		pedido_exame_externo j,
		convenio b,
		atend_categoria_convenio a,
		pessoa_fisica e
	where	a.cd_convenio		= b.cd_convenio
	and	j.nr_atendimento	= a.nr_atendimento
	and	x.nr_atendimento	= a.nr_atendimento
	and	obter_atecaco_atendimento(x.nr_atendimento) 	= a.nr_seq_interno
	and	b.cd_cgc		= c.cd_cgc
	and	x.cd_pessoa_fisica	= e.cd_pessoa_fisica
	and	j.nr_sequencia		= nr_seq_pedido_exame_w;

	select	coalesce(max(ie_cid_solic_externo), 'N'),
		coalesce(max(ie_quebra_proc_pep),'N'),
		coalesce(max(ie_gerar_tiss), 'S'),
		coalesce(max(ie_proc_tuss),'N'),
		coalesce(max(ie_desc_proc_interno),'P'),
		coalesce(max(ie_desc_exame_ext),'N'),
		coalesce(max(ie_spsadt_atend_retorno),'S'),
		coalesce(max(ie_medico_solic_exame),'A'),
		coalesce(max(ie_lado_rep),'N'),
		coalesce(max(ie_quebra_grupo_exame),'N'),
		max(ds_arquivo_logo_comp),
		coalesce(max(ie_prest_exec_pedido_exame),'N'),
		coalesce(max(ie_dt_assin_solic),'N'),
		max(ie_guia_prestador),
		coalesce(max(ie_data_ass_prest),'X')
	into STRICT	ie_cid_exame_externo_w,
		ie_quebra_proc_pep_w,
		ie_gerar_tiss_w,
		ie_proc_tuss_w,
		ie_desc_proc_interno_w,
		ie_desc_exame_ext_w,
		ie_spsadt_atend_retorno_w,
		ie_medico_solic_exame_w,
		ie_lado_rep_w,
		ie_quebra_grupo_exame_w,
		ds_arquivo_logo_comp_w,
		ie_prest_exec_pedido_exame_w,
		ie_dt_assin_solic_w,
		ie_guia_prestador_w,
		ie_data_ass_prest_w
	from	tiss_parametros_convenio
	where	cd_convenio		= cd_convenio_w
	and	cd_estabelecimento	= cd_estabelecimento_w;



	select	tiss_obter_versao(cd_convenio_w,cd_estabelecimento_w)
	into STRICT	ds_versao_w
	;

	if (coalesce(ie_gerar_tiss_w,'S') = 'S') and
		((coalesce(ie_spsadt_atend_retorno_w,'S') = 'S') or (obter_se_atend_retorno(nr_atendimento_w) = 'N')) then

		begin
			select	im_logo_convenio
			into STRICT	im_logo_convenio_w
			from	tiss_logo_convenio
			where	cd_convenio	   = cd_convenio_w
			and 	coalesce(ie_situacao,'N') = 'A';
		exception
		when others then
			im_logo_convenio_w := null;
		end;

		if (coalesce(im_logo_convenio_w::text, '') = '') and (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') then
			ds_arquivo_logo_w := tiss_diretorio_logo(ds_arquivo_logo_comp_w, ds_dir_padrao_p) || ds_arquivo_logo_w;
		end if;

		if (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') and (coalesce(im_logo_convenio_w::text, '') = '') then

			insert	into w_tiss_relatorio(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_arquivo_logo,
				im_logo_convenio)
			values (nextval('w_tiss_relatorio_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				ds_arquivo_logo_w,
				null);
		else
			insert	into w_tiss_relatorio(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_arquivo_logo,
				im_logo_convenio)
			values (nextval('w_tiss_relatorio_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				null,
				im_logo_convenio_w);
		end if;

		nr_seq_apresentacao_w := 0;

		select	nextval('w_tiss_guia_seq')
		into STRICT	nr_seq_guia_w
		;

		open C37;
		loop
		fetch C37 into --Quebra por prestador do item
			cd_cgc_exec_w;
		EXIT WHEN NOT FOUND; /* apply on C37 */

			open C29;
			loop
			fetch C29 into --Quebra pela guia do item
				nr_doc_conv_exame_w;
			EXIT WHEN NOT FOUND; /* apply on C29 */

				open C28;
				loop
				fetch C28 into
					nr_seq_grupo_w; --Quebra pelo grupo do exame
				EXIT WHEN NOT FOUND; /* apply on C28 */

					open c14;
					loop
					fetch c14 into
						cd_tipo_proc_w; --Quebra pelo tipo de procedimento
					EXIT WHEN NOT FOUND; /* apply on c14 */

						qt_proc_guia_w 		:= 0;
						nr_seq_apresentacao_w 	:= 0;

						open c04;
						loop
						fetch c04 into
							nr_seq_exame_w,
							cd_procedimento_w,
							ds_procedimento_w,
							qt_solicitada_w,
							qt_autorizada_w,
							nr_atendimento_w,
							cd_medico_w,
							cd_autorizacao_w,
							cd_senha_w,
							dt_inicio_vigencia_w,
							dt_final_vigencia_w,
							cd_cgc_w,
							ds_razao_social_w,
							cd_cnes_w,
							dt_atendimento_w,
							ds_justificativa_w,
							ds_cid_w,
							ie_tipo_atendimento_w,
							ie_clinica_w,
							ds_exame_w,
							nr_seq_exame_lab_w,
							cd_profissional_w,
							cd_cgc_exame_w,
							ds_lado_proc_w,
							ds_dados_clinicos_w,
							nr_seq_apresent_w,
							nr_seq_proc_int_ext_w;
						EXIT WHEN NOT FOUND; /* apply on c04 */
							cd_proc_tuss_w		:= 0;

							qt_proc_guia_w 		:= qt_proc_guia_w + 1;

							if (qt_proc_guia_w = 1) then
								select	nextval('w_tiss_guia_seq')
								into STRICT	nr_seq_guia_w
								;

								if (coalesce(ie_data_ass_prest_w,'N') = 'S') then
									dt_assin_prest_w	:= dt_atendimento_w;

								elsif (coalesce(ie_data_ass_prest_w,'X') = 'N') then
									dt_assin_prest_w	:= clock_timestamp();
									dt_atendimento_w	:= clock_timestamp();
								elsif (coalesce(ie_data_ass_prest_w,'N') = 'V') then	
									dt_assin_prest_w	:= null;
									dt_atendimento_w	:= null;
								end if;

								select	max(ie_tipo_atend_tiss)
								into STRICT	ie_tipo_atend_tiss_w
								from	atendimento_paciente
								where	nr_atendimento	= nr_atendimento_w;

								/*Alteracao lhalves OS202825 23/03/2010 - Aplicar regra prestador solic nas guias emitida pelo PEP - Solic de exames esternos*/

								select	max(obter_setor_atendimento(nr_atendimento_w))
								into STRICT	cd_setor_entrada_w
								;

								SELECT * FROM tiss_obter_regra_prest_solic(	cd_convenio_w, cd_estabelecimento_w, cd_setor_entrada_w, ie_clinica_w, cd_procedimento_w, ie_tipo_atendimento_w, 'S', ie_solicitante_w, cd_cgc_solic_regra_w, cd_medico_w, cd_medico_solic_w, cd_prestador_solic_tiss_w, ds_prestador_solic_tiss_w, cd_medico_referido_w, cd_categoria_conv_w, clock_timestamp(), null, null, cd_plano_convenio_w, nr_seq_regra_solic_w) INTO STRICT ie_solicitante_w, cd_cgc_solic_regra_w, cd_medico_solic_w, cd_prestador_solic_tiss_w, ds_prestador_solic_tiss_w, nr_seq_regra_solic_w;

								if (coalesce(ie_solicitante_w,'H') = 'MC') then

									select	coalesce(max(obter_se_medico_conveniado(cd_estabelecimento_w, cd_medico_w, cd_convenio_w, null, null, null,null,null,null, null, null)), 'N')
									into STRICT	ie_conveniado_w
									;

									if (coalesce(ie_conveniado_w,'S') = 'S') then

										cd_cgc_w		:= tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_solic_w, null, null, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w);
										ds_razao_social_w 	:= substr(obter_nome_pf_pj(cd_medico_w, null), 1, 150);
										cd_cnes_w		:= null;
									else
										cd_cgc_w 		:= cd_cgc_w;
										ds_razao_social_w 	:= substr(obter_nome_pf_pj(null, cd_cgc_w), 1, 150);
									end if;

								elsif (coalesce(ie_solicitante_w,'H') = 'H') then
									cd_cgc_w 		:= cd_cgc_w;
									ds_razao_social_w 	:= substr(obter_nome_pf_pj(null, cd_cgc_w), 1, 150);

								elsif (coalesce(ie_solicitante_w,'H') = 'M') then
									cd_cgc_w 		:= obter_dados_pf(cd_medico_w, 'CPF');
									ds_razao_social_w 	:= substr(obter_nome_pf_pj(cd_medico_w, null), 1, 150);
									cd_cnes_w		:= null;

								elsif (coalesce(ie_solicitante_w,'H') = 'I') then
									if (cd_medico_solic_w IS NOT NULL AND cd_medico_solic_w::text <> '') then
										cd_cgc_w		:= coalesce((tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_solic_w, null, null, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
														(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_solic_w, null, null, 'CPF',null,ie_tipo_atendimento_w,cd_categoria_conv_w)));
										ds_razao_social_w 	:= substr(obter_nome_pf_pj(cd_medico_solic_w, null), 1, 150);
										cd_cnes_w		:= null;

									elsif (cd_cgc_solic_regra_w IS NOT NULL AND cd_cgc_solic_regra_w::text <> '') then
										cd_cgc_w		:= coalesce((tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_solic_regra_w, null, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
														(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_solic_regra_w, null, 'CGC',null,ie_tipo_atendimento_w,cd_categoria_conv_w)));
										ds_razao_social_w 	:= substr(obter_nome_pf_pj(null, cd_cgc_solic_regra_w), 1, 150);
									elsif (coalesce(cd_medico_solic_w::text, '') = '') and (coalesce(cd_cgc_solic_regra_w::text, '') = '') then
										cd_cgc_w		:= coalesce((tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_w, null, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
														(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_w, null, 'CGC',null,ie_tipo_atendimento_w,cd_categoria_conv_w)));
										select	max(substr(obter_nome_pf_pj(null, cd_cgc_w), 1, 150))
										into STRICT	ds_razao_social_w
										;

									end if;

									if (coalesce(ds_prestador_solic_tiss_w,'X') <> 'X') then
										ds_razao_social_w	:= ds_prestador_solic_tiss_w;
									end if;

									if (coalesce(cd_prestador_solic_tiss_w,'X') <> 'X') then
										cd_cgc_w	:= cd_prestador_solic_tiss_w;
									end if;
								end if;
								/*Fim alteracao lhalves OS202825*/

								if (cd_cgc_exame_w IS NOT NULL AND cd_cgc_exame_w::text <> '') and (ie_prest_exec_pedido_exame_w = 'N')then
									cd_cgc_w		:= coalesce((tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_exame_w, null, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
													(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_exame_w, null, 'CGC',null,ie_tipo_atendimento_w,cd_categoria_conv_w)));
									ds_razao_social_w 	:= substr(obter_nome_pf_pj(null, cd_cgc_exame_w), 1, 150);
									cd_cnes_w		:= substr(obter_dados_pf_pj(null,cd_cgc_w,'CNES'),1,20);
								end if;

								if (cd_autorizacao_princ_exame_w IS NOT NULL AND cd_autorizacao_princ_exame_w::text <> '') then
									cd_autorizacao_w	:= cd_autorizacao_princ_exame_w;
								end if;

								if (coalesce(nr_doc_conv_exame_w,'X') <> 'X') then
									cd_autorizacao_w	:= nr_doc_conv_exame_w;
								end if;

								ie_regra_guia_princ_w	:= null;

								open C26;
								loop
								fetch C26 into
									ie_regra_guia_princ_w;
								EXIT WHEN NOT FOUND; /* apply on C26 */
								end loop;
								close C26;

								if (ie_regra_guia_princ_w = 'AG') then
									if ((TISS_OBTER_GUIA_PRINCIPAL(nr_atendimento_w,cd_convenio_w) IS NOT NULL AND (TISS_OBTER_GUIA_PRINCIPAL(nr_atendimento_w,cd_convenio_w))::text <> '')) then
										cd_autorizacao_princ_w	:= substr(TISS_OBTER_GUIA_PRINCIPAL(nr_atendimento_w,cd_convenio_w),1,100);
									else
										cd_autorizacao_princ_w	:= cd_autorizacao_w;
									end if;
								elsif (ie_regra_guia_princ_w = 'GP') then
									select	max(a.nr_doc_convenio)
									into STRICT	cd_autorizacao_princ_w
									from	atend_categoria_convenio a
									where	a.nr_atendimento		= nr_atendimento_w
									and	a.cd_convenio			= cd_convenio_w
									and	clock_timestamp()			between a.dt_inicio_vigencia and trunc(coalesce(a.dt_final_vigencia,clock_timestamp())) + 89399/89400;
								elsif (ie_regra_guia_princ_w = 'GC') then
									select	max(a.nr_doc_convenio)
									into STRICT	cd_autorizacao_princ_w
									from	atend_categoria_convenio a
									where	a.nr_atendimento		= nr_atendimento_w
									and	a.cd_convenio			= cd_convenio_w
									and	coalesce(a.ie_tipo_guia,'X')		<> 'C'
									and	clock_timestamp()			between a.dt_inicio_vigencia and trunc(coalesce(a.dt_final_vigencia,clock_timestamp())) + 89399/89400;
								elsif (ie_regra_guia_princ_w = 'A') then
									select	max(nr_doc_conv_principal)
									into STRICT	cd_autorizacao_princ_w
									from	atend_categoria_convenio
									where	nr_atendimento			= nr_atendimento_w
									and	cd_convenio			= cd_convenio_w
									and	obter_atecaco_atendimento(nr_atendimento) = nr_seq_interno;
								elsif (ie_regra_guia_princ_w = 'SI') then
									select	max(a.cd_autorizacao)
									into STRICT	cd_autorizacao_princ_w
									from	autorizacao_convenio a
									where	a.nr_atendimento	= nr_atendimento_w
									and	a.nr_sequencia		=
										(SELECT		max(x.nr_sequencia)
										from		autorizacao_convenio x
										where		x.nr_atendimento	= a.nr_atendimento
										and		x.cd_autorizacao	= a.cd_autorizacao);
								elsif (ie_regra_guia_princ_w = 'S') then
									cd_autorizacao_princ_w	:= cd_senha_w;
								elsif (ie_regra_guia_princ_w = 'AS') then
									cd_autorizacao_princ_w	:= substr((TISS_OBTER_GUIA_PRINCIPAL(nr_atendimento_w,cd_convenio_w)||cd_senha_w),1,100);
								elsif (ie_regra_guia_princ_w = 'G') then
									cd_autorizacao_princ_w	:= cd_autorizacao_w;
								elsif (ie_regra_guia_princ_w in ('PP','SP','AC','N')) then
									cd_autorizacao_princ_w	:= null;
								elsif (coalesce(ie_regra_guia_princ_w::text, '') = '') then
									cd_autorizacao_princ_w	:= cd_autorizacao_princ_exame_w;
								end if;

								if (coalesce(ie_data_solic_pedido_p,'N') = 'S') then
									dt_assin_prest_w	:= dt_solicitacao_w;
									dt_atendimento_w	:= dt_solicitacao_w;
									dt_final_vigencia_w	:= dt_solicitacao_w;
									dt_emissao_guia_w	:= dt_solicitacao_w;
								else
									dt_solicitacao_w	:= null;
									dt_emissao_guia_w	:= clock_timestamp();
								end if;

								if (coalesce(ie_dt_assin_solic_w,'N') = 'S') then
									dt_assin_solic_w	:= dt_atendimento_w;
								end if;

								if (ie_guia_prestador_w = 'G') then --Numero da guia
									nr_guia_prestador_w	:= cd_autorizacao_w;									
								elsif (ie_guia_prestador_w = 'GT') then --Numero da guia + Tipo de guia
									nr_guia_prestador_w	:= cd_autorizacao_w||'2';									
								elsif (ie_guia_prestador_w = 'SG') then --Numero de sequencia da guia
									nr_guia_prestador_w 	:= nr_seq_guia_w;
								elsif (ie_guia_prestador_w = 'S') then --Senha do atendimento
									nr_guia_prestador_w 	:= cd_senha_w;
								elsif (ie_guia_prestador_w = 'PR') then --Prontuario do paciente								
									nr_guia_prestador_w	:= nr_prontuario_w;
								elsif (ie_guia_prestador_w = 'GE') then --Numero da guia da EUP
									nr_guia_prestador_w	:= cd_autorizacao_princ_w;
								elsif (ie_guia_prestador_w = 'A') then --Numero do atendimento
									nr_guia_prestador_w	:= nr_atendimento_w;
								elsif (ie_guia_prestador_w = 'R') then
									SELECT * FROM TISS_OBTER_GUIA_PRESTADOR( cd_estabelecimento_w, cd_convenio_w, '2', nr_atendimento_w, null, cd_autorizacao_w, nr_seq_guia_w, nr_guia_prestador_w, ie_regra_guia_prest_w) INTO STRICT nr_guia_prestador_w, ie_regra_guia_prest_w;
								end if;	

								insert	into w_tiss_guia(nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									cd_ans,
									cd_autorizacao,
									dt_autorizacao,
									cd_senha,
									dt_validade_senha,
									dt_emissao_guia,
									nr_atendimento,
									ds_observacao,
									ie_tiss_tipo_guia,
									dt_entrada,
									cd_autorizacao_princ,
									dt_assin_prest,
									dt_assin_solic,
									dt_assin_resp,
									ds_versao,
									nr_guia_prestador)
								values (nr_seq_guia_w,
									clock_timestamp(),
									nm_usuario_p,
									cd_ans_w,
									tiss_obter_regra_campo(2, 'CD_AUTORIZACAO', CD_CONVENIO_W, cd_autorizacao_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),									
									null,
									tiss_obter_regra_campo(2, 'CD_SENHA', CD_CONVENIO_W, cd_senha_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
									to_date(tiss_obter_regra_campo(2, 'DT_VALIDADE_SENHA', CD_CONVENIO_W, to_char(dt_final_vigencia_w,'dd/mm/yyyy'), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),'dd/mm/yyyy'),
									to_date(tiss_obter_regra_campo(2, 'DT_EMISSAO_GUIA', CD_CONVENIO_W, to_char(dt_emissao_guia_w,'dd/mm/yyyy'), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),'dd/mm/yyyy'),
									nr_atendimento_w,
									tiss_obter_regra_campo(4, 'DS_OBSERVACAO', CD_CONVENIO_W, ds_observacao_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
									'2',
									to_date(tiss_obter_regra_campo(2, 'DT_ASSINATURA_RESP', cd_convenio_W, to_char(dt_atendimento_w, 'dd/mm/yyyy hh24:mi:ss'), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),'dd/mm/yyyy hh24:mi:ss'),
									tiss_obter_regra_campo(2, 'CD_AUTORIZACAO_PRINC', CD_CONVENIO_W, cd_autorizacao_princ_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
									to_date(tiss_obter_regra_campo(2, 'DS_ASSINATURA_EXEC', cd_convenio_W, to_char(DT_ASSIN_PREST_w, 'dd/mm/yyyy hh24:mi:ss'), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),'dd/mm/yyyy hh24:mi:ss'),
									to_date(tiss_obter_regra_campo(2, 'DS_ASSINATURA_SOLIC', cd_convenio_W, to_char(dt_assin_solic_w, 'dd/mm/yyyy hh24:mi:ss'), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),'dd/mm/yyyy hh24:mi:ss'),
									to_date(tiss_obter_regra_campo(2, 'DT_ASSINATURA_RESP_AUTOR', cd_convenio_W, null, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),'dd/mm/yyyy hh24:mi:ss'),
									ds_versao_w,
									coalesce(cd_autorizacao_prest_w, nr_guia_prestador_w));

								/*lhalves OS305885 em 30/03/2011 - substituido a view pelo select - Performance*/

								insert	into w_tiss_beneficiario(nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									nr_seq_guia,
									cd_pessoa_fisica,
									nm_pessoa_fisica,
									nr_cartao_nac_sus,
									ds_plano,
									dt_validade_carteira,
									cd_usuario_convenio)
								SELECT	nextval('w_tiss_beneficiario_seq'),
									clock_timestamp(),
									nm_usuario_p,
									nr_seq_guia_w,
									c.cd_pessoa_fisica,
									substr(TISS_OBTER_TITULAR_CONV_RN(nr_atendimento_w, null, cd_convenio_w, cd_estabelecimento_w),1,150),
									c.nr_cartao_nac_sus,
									substr(obter_desc_plano(b.cd_convenio, b.cd_plano_convenio),1,40),
									b.dt_validade_carteira,
									b.cd_usuario_convenio
								from	pessoa_fisica c,
									atend_categoria_convenio b,
									atendimento_paciente a
								where	b.nr_seq_interno	= obter_atecaco_atendimento(b.nr_atendimento)
								and	a.nr_atendimento	= b.nr_atendimento
								and	a.cd_pessoa_fisica	= c.cd_pessoa_fisica
								and	a.nr_atendimento	= nr_atendimento_w;

								if (coalesce(ie_medico_solic_exame_w,'N') = 'P') and (cd_profissional_w IS NOT NULL AND cd_profissional_w::text <> '') then
									cd_medico_w	:= cd_profissional_w;
								end if;

								insert into w_tiss_contratado_solic(nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									nr_seq_guia,
									cd_cgc,
									cd_interno,
									nr_cpf,
									nm_contratado,
									nm_solicitante,
									cd_cnes,
									sg_conselho,
									nr_crm,
									uf_crm,
									cd_cbo_saude)
								SELECT	nextval('w_tiss_contratado_solic_seq'),
									clock_timestamp(),
									nm_usuario_p,
									nr_seq_guia_w,
									cd_cgc_w,
									null,
									substr(obter_dados_pf(cd_pessoa_fisica, 'CPF'), 1, 150),
									ds_razao_social_w,
									obter_nome_medico(cd_pessoa_fisica,'N'),
									tiss_obter_regra_campo(2, 'CD_CNES', CD_CONVENIO_W, cd_cnes_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
									obter_Dados_medico(cd_pessoa_fisica, 'SGCRM'),
									obter_Dados_medico(cd_pessoa_fisica, 'CRM'),
									obter_Dados_medico(cd_pessoa_fisica, 'UFCRM'),
									substr(obter_dados_pf(coalesce(cd_cbo_med_prest_w, cd_pessoa_fisica), 'CBOS'),1,20)
								from	medico
								where	cd_pessoa_fisica = cd_medico_w;

								if (ie_prest_exec_pedido_exame_w = 'E') and (cd_cgc_exec_w <> 'X')  then

									insert	into w_tiss_contratado_exec(nr_sequencia,
										dt_atualizacao,
										nm_usuario,
										nr_seq_guia,
										cd_cgc,
										cd_interno,
										nr_cpf,
										nm_contratado,
										ds_tipo_logradouro,
										ds_logradouro,
										nm_municipio,
										sg_estado,
										cd_municipio_ibge,
										cd_cep,
										cd_cnes)
									SELECT	nextval('w_tiss_contratado_exec_seq'),
										clock_timestamp(),
										nm_usuario_p,
										nr_seq_guia_w,
										cd_cgc_exec_w,
										null,
										null,
										substr(obter_nome_pf_pj(null,cd_cgc_exec_w),1,100),
										'81' ds_tipo_logradouro,
										obter_dados_pf_pj(null,cd_cgc_exec_w,'EC'),
										obter_dados_pf_pj(null,cd_cgc_exec_w,'CI'),
										obter_dados_pf_pj(null,cd_cgc_exec_w,'UF'),
										substr(lpad(somente_numero(obter_dados_pf_pj(null,cd_cgc_exec_w,'CDM')),7,'0'),1,25),
										lpad(to_char(somente_numero(obter_dados_pf_pj(null,cd_cgc_exec_w,'CEP'))),8,'0'),
										obter_dados_pf_pj(null,cd_cgc_exec_w,'CNES')
									from	pessoa_juridica a
									where	a.cd_cgc = cd_cgc_exec_w;
								end if;

								if (ie_cid_exame_externo_w	= 'N') then
									select	max(cd_doenca),
										substr(max(ds_diagnostico),1,255)
									into STRICT	cd_doenca_cid_w,
										ds_observacao_w
									from	diagnostico_doenca a
									where	nr_atendimento		= nr_atendimento_w
									and	ie_classificacao_doenca = 'P';
								else
									cd_doenca_cid_w	:= ds_cid_w;
								end if;

								select	substr(obter_desc_cid(cd_cid_externo_w),1,255)
								into STRICT	ds_cid_externo_w
								;

								insert into w_tiss_solicitacao(nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									nr_seq_guia,
									dt_solicitacao,
									ie_carater_solic,
									cd_cid,
									ds_indicacao)
								SELECT	nextval('w_tiss_solicitacao_seq'),
									clock_timestamp(),
									nm_usuario_p,
									nr_seq_guia_w,
									to_date(tiss_obter_regra_campo(2, 'DT_SOLICITACAO', cd_convenio_W, to_char(dt_solicitacao_w, 'dd/mm/yyyy hh24:mi:ss'), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),'dd/mm/yyyy hh24:mi:ss'),									
									null,
									tiss_obter_regra_campo(2, 'CD_DOENCA_CID', CD_CONVENIO_W, coalesce(cd_cid_externo_w, cd_doenca_cid_w), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
									substr(coalesce(ds_dados_clinicos_w,coalesce(ds_justificativa_w, coalesce(ds_observacao_w,ds_cid_externo_w))),1,255)
								;

							end if;

							nr_seq_apresentacao_w	:= nr_seq_apresentacao_w + 1;

							/*lhalves OS267716 em 23/11/2010 - Proc TUSS para exames padroes */

							if (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') then
								select	max(nr_proc_interno)
								into STRICT	nr_seq_proc_interno_w
								from 	med_exame_padrao
								where	nr_sequencia	= nr_seq_exame_w;

								if (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') then
									select 	max(cd_procedimento_tuss),
										substr(Obter_Descricao_Procedimento(max(cd_procedimento_tuss),8),1,255)
									into STRICT	cd_proc_tuss_w,
										ds_proc_tuss_w
									from 	proc_interno
									where	nr_sequencia = nr_seq_proc_interno_w;

									if (ie_proc_tuss_w in ('S','C')) and (coalesce(cd_proc_tuss_w,0) <> 0) then
										cd_procedimento_w	:= coalesce(cd_proc_tuss_w,cd_procedimento_w);
									end if;

									if (ie_desc_proc_interno_W = 'T') and (coalesce(ds_proc_tuss_w, wheb_mensagem_pck.get_texto(307200)) <> wheb_mensagem_pck.get_texto(307200)) then
										ds_procedimento_w	:= substr(coalesce(ds_proc_tuss_w,ds_procedimento_w),1,255);
									end if;
								end if;
							end if;

							if (nr_seq_exame_lab_w IS NOT NULL AND nr_seq_exame_lab_w::text <> '') then
								select 	max(cd_procedimento_tuss),
									substr(Obter_Descricao_Procedimento(max(cd_procedimento_tuss),8),1,255)
								into STRICT	cd_proc_tuss_w,
									ds_proc_tuss_w
								from 	exame_laboratorio
								where	nr_seq_exame = nr_seq_exame_lab_w;

								if (ie_proc_tuss_w in ('S','C')) and (coalesce(cd_proc_tuss_w,0) <> 0) then
									cd_procedimento_w	:= coalesce(cd_proc_tuss_w,cd_procedimento_w);
								end if;

								if (ie_desc_proc_interno_W = 'T') and (coalesce(cd_proc_tuss_w,0) <> 0) and (coalesce(ds_proc_tuss_w, wheb_mensagem_pck.get_texto(307200)) <> wheb_mensagem_pck.get_texto(307200)) then
									ds_procedimento_w	:= substr(coalesce(ds_proc_tuss_w,ds_procedimento_w),1,255);
								end if;

							end if;

							if (nr_seq_proc_int_ext_w IS NOT NULL AND nr_seq_proc_int_ext_w::text <> '') and (coalesce(cd_proc_tuss_w,0) = 0) and
								((ie_proc_tuss_w in ('S','C')) or (ie_desc_proc_interno_w = 'T')) then
								begin


								select	max(cd_procedimento_tuss)
								into STRICT	cd_proc_tuss_w
								from	proc_interno
								where	nr_sequencia = nr_seq_proc_int_ext_w;


								if (coalesce(cd_proc_tuss_w,0) > 0) then
									begin
									ds_proc_tuss_w := substr(Obter_Descricao_Procedimento(cd_proc_tuss_w,8),1,255);
									end;
								end if;

								if (ie_proc_tuss_w in ('S','C')) and (coalesce(cd_proc_tuss_w,0) <> 0) then
									cd_procedimento_w	:= coalesce(cd_proc_tuss_w,cd_procedimento_w);
								end if;


								end;
							end if;	
							if	((ie_desc_exame_ext_w = 'S') and (coalesce(ds_exame_w,'X') <> 'X')) then
								ds_procedimento_w := substr(ds_exame_w,1,255);
							end if;

							if (ie_lado_rep_w = 'S') and (ds_lado_proc_w IS NOT NULL AND ds_lado_proc_w::text <> '') then
								ds_procedimento_w	:= substr((ds_procedimento_w ||'-'||ds_lado_proc_w),1,255);
							end if;

							/*crhobus - adicionado tratamento de exception pois o parametro cd_procedimento_p da procedure tiss_obter_campo_esp e number
							sendo necesario, e a variavel cd_procedimento_w e varchar2 pelo fato que pode vir caracteres devido as regras de conversao do convenio - visto com lhalves - 23/08/2013*/
							begin
							ds_procedimento_w	:= substr(coalesce(tiss_obter_campo_esp(	cd_convenio_w,
															cd_estabelecimento_w,
															'DS_PROCEDIMENTO',
															ds_procedimento_w,
															null,null,null,null,null,
															null,null,null,null,
															'SADTS',
															cd_procedimento_w,
															null,
                                                            cd_setor_execucao_w,
                                                            null,
															cd_cgc_w,
															null,
															cd_medico_w,
															null, null, ds_lado_proc_w, null, null),ds_procedimento_w),1,255);
							exception
							when others then
								null;
							end;

							insert into w_tiss_proc_solic(nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								nr_seq_guia,
								cd_procedimento,
								cd_edicao_amb,
								ds_procedimento,
								qt_solicitada,
								qt_autorizada,
								nr_seq_apresentacao)
							values (nextval('w_tiss_proc_solic_seq'),
								clock_timestamp(),
								nm_usuario_p,
								nr_seq_guia_w,
								tiss_obter_regra_campo(2, 'CD_PROCEDIMENTO_SOLIC', CD_CONVENIO_W, cd_procedimento_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_execucao_w),
								null,
								ds_procedimento_w,
								qt_solicitada_w,
								tiss_obter_regra_campo(2, 'QT_AUTORIZADA', CD_CONVENIO_W, qt_autorizada_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_execucao_w),
								nr_seq_apresentacao_w);

							if (qt_proc_guia_w = 5) then
								nr_seq_apresentacao_w		:= 0;
								qt_proc_guia_w			:= 0;
								CALL TISS_GERAR_OPM_EXEC(nr_seq_conta_guia_w, nr_seq_guia_w, nm_usuario_p);
								CALL TISS_COMPLETAR_GUIA(nr_seq_guia_w, nm_usuario_p);

							end if;
						end loop;
						close c04;

						if (qt_proc_guia_w > 0) and (qt_proc_guia_w < 5) then
							CALL TISS_GERAR_OPM_EXEC(nr_seq_conta_guia_w, nr_seq_guia_w, nm_usuario_p);
							CALL TISS_COMPLETAR_GUIA(nr_seq_guia_w, nm_usuario_p);
						end if;

					end loop;
					close c14;

				end loop;
				close C28;

			end loop;
			close C29;

		end loop;
		close C37;

	end if;

elsif (coalesce(nr_prescr_tiss_p,0) > 0) or (ds_cpoe_itens_w IS NOT NULL AND ds_cpoe_itens_w::text <> '') then


	if (ds_cpoe_itens_w IS NOT NULL AND ds_cpoe_itens_w::text <> '') then

		select	max(a.nr_atendimento)
		into STRICT	nr_atendimento_w
		from	prescr_medica a,
			prescr_procedimento b,
			table(lista_pck.obter_lista(coalesce(ds_cpoe_itens_w,' '))) k
		where	a.nr_prescricao = b.nr_prescricao
		and	k.nr_registro 	 = b.nr_seq_proc_cpoe;


		select	max(cd_ans),
			max(b.ds_arquivo_logo_tiss),
			max(b.cd_convenio),
			coalesce(max(a.nr_doc_conv),max(t.nr_doc_convenio)) --lhalves OS 403054 em 26/10/2012 - Considerar a guia da prescricao
		into STRICT	cd_ans_w,
			ds_arquivo_logo_w,
			cd_convenio_w,
			cd_autorizacao_w
		from	pessoa_juridica c,
			convenio b,
			atend_categoria_convenio t,
			prescr_medica a
		where	t.cd_convenio					= b.cd_convenio
		and	b.cd_cgc					= c.cd_cgc
		and	t.nr_atendimento				= a.nr_atendimento
		and	obter_atecaco_atendimento(t.nr_atendimento) 	= t.nr_seq_interno
		and	t.nr_atendimento				= nr_atendimento_w;

	else	

		select	max(a.nr_atendimento)
		into STRICT	nr_atendimento_w
		from	prescr_medica a
		where	a.nr_prescricao = nr_prescr_tiss_p;

		select	max(cd_ans),
			max(b.ds_arquivo_logo_tiss),
			max(b.cd_convenio),
			coalesce(max(a.nr_doc_conv),max(t.nr_doc_convenio)) --lhalves OS 403054 em 26/10/2012 - Considerar a guia da prescricao
		into STRICT	cd_ans_w,
			ds_arquivo_logo_w,
			cd_convenio_w,
			cd_autorizacao_w
		from	pessoa_juridica c,
			convenio b,
			atend_categoria_convenio t,
			prescr_medica a
		where	t.cd_convenio					= b.cd_convenio
		and	b.cd_cgc					= c.cd_cgc
		and	t.nr_atendimento				= a.nr_atendimento
		and	obter_atecaco_atendimento(t.nr_atendimento) 	= t.nr_seq_interno
		and	a.nr_prescricao					= nr_prescr_tiss_p;

	end if;


	select	max(b.cd_estabelecimento),
		max(a.cd_convenio),
		max(b.nr_seq_classificacao),
		max(obter_setor_atendimento(b.nr_atendimento)),
		max(a.cd_senha),
		max(a.dt_inicio_vigencia),
		max(a.dt_final_vigencia),
		max(b.dt_entrada),
		max(b.ie_tipo_atendimento),
		max(a.cd_categoria),
		max(ie_clinica),
		max(coalesce(a.nr_doc_conv_principal,a.nr_doc_convenio)),
		max(b.ie_tipo_atend_tiss),
		max(a.cd_plano_convenio),
		max(b.nr_seq_tipo_acidente),
		max(b.nm_medico_externo),
		max(b.crm_medico_externo)		
	into STRICT	cd_estabelecimento_w,
		cd_convenio_w,
		nr_seq_classif_atend_w,
		cd_setor_entrada_w,
		cd_senha_w,
		dt_inicio_vigencia_w,
		dt_final_vigencia_w,
		dt_atendimento_w,
		ie_tipo_atendimento_w,
		cd_categoria_conv_w,
		ie_clinica_w,
		cd_autor_princ_w,
		ie_tipo_atend_tiss_w,
		cd_plano_convenio_w,
		nr_seq_tipo_acidente_w,
		nm_medico_externo_w,
		crm_medico_externo_w		
	from	atendimento_paciente b,
		atend_categoria_convenio a
	where	obter_atecaco_atendimento(a.nr_atendimento) 	= a.nr_seq_interno
	and	b.nr_atendimento				= a.nr_atendimento
	and	b.nr_atendimento				= nr_atendimento_w;

	select	coalesce(max(ie_prescr_unica),'N'),
		coalesce(max(ie_quebra_proc_pep), 'N'),
		coalesce(max(ie_gerar_tiss), 'S'),
		coalesce(max(ie_spsadt_atend_retorno),'S'),
		coalesce(max(ie_senha_guia),'ACA'),
		coalesce(max(ie_emitir_hemocomponente),'N'),
		max(ds_arquivo_logo_comp),
		coalesce(max(ie_quebra_horarios_prescr),'N'),
		max(ie_guia_prestador),
		coalesce(max(ie_assinatura_solic),'N'),
		coalesce(max(ie_ultima_prescricao),'N')
	into STRICT	ie_prescr_unica_w,
		ie_quebra_proc_pep_w,
		ie_gerar_tiss_w,
		ie_spsadt_atend_retorno_w,
		ie_senha_guia_w,
		ie_emitir_hemocomponente_w,
		ds_arquivo_logo_comp_w,
		ie_quebra_horarios_prescr_w,
		ie_guia_prestador_w,
		ie_assinatura_solic_w,
		ie_ultima_prescricao_w
	from	TISS_PARAMETROS_CONVENIO
	where	cd_estabelecimento			= cd_estabelecimento_w
	and	cd_convenio				= cd_convenio_w;

	if (ie_ultima_prescricao_w = 'N') then
		ie_ultima_prescricao_w	:= coalesce(ie_ultima_prescricao_p,'N');
	end if;	


	select	max(tiss_obter_se_atend_rn(nr_atendimento_w))
	into STRICT	ie_atendimento_rn_w
	;

	select	tiss_obter_versao(cd_convenio_w,cd_estabelecimento_w)
	into STRICT	ds_versao_w
	;

	if (coalesce(ie_gerar_tiss_w,'S')= 'S') and
		((coalesce(ie_spsadt_atend_retorno_w,'S') = 'S') or (obter_se_atend_retorno(nr_atendimento_w) = 'N'))then

		 begin
			select	im_logo_convenio
			into STRICT	im_logo_convenio_w
			from	tiss_logo_convenio
			where	cd_convenio	   = cd_convenio_w
			and 	coalesce(ie_situacao,'N') = 'A';
		exception
		when others then
			im_logo_convenio_w := null;
		end;

		if (coalesce(im_logo_convenio_w::text, '') = '') and (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') then
			ds_arquivo_logo_w := tiss_diretorio_logo(ds_arquivo_logo_comp_w, ds_dir_padrao_p) || ds_arquivo_logo_w;
		end if;

		if (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') and (coalesce(im_logo_convenio_w::text, '') = '') then
			insert	into w_tiss_relatorio(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_arquivo_logo,
				im_logo_convenio)
			values (nextval('w_tiss_relatorio_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				ds_arquivo_logo_w,
				null);
		else
			insert	into w_tiss_relatorio(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_arquivo_logo,
				im_logo_convenio)
			values (nextval('w_tiss_relatorio_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				null,
				im_logo_convenio_w);
		end if;

		if (ie_quebra_horarios_prescr_w = 'S') and (coalesce(ds_cpoe_itens_w::text, '') = '')
			then
			CALL TISS_GERAR_W_HORARIOS_PRESCR(nr_prescr_tiss_p,nm_usuario_p);
		end if;

		open C32;
		loop
		fetch C32 into
			ds_horario_w;
		EXIT WHEN NOT FOUND; /* apply on C32 */

			open c06;
			loop
			fetch c06 into
				cd_setor_atendimento_w,
				cd_autorizacao_ww,
				ds_inicacao_clinica_w;
			EXIT WHEN NOT FOUND; /* apply on c06 */

				open c15;
				loop
				fetch c15 into
					cd_tipo_proc_w;
				EXIT WHEN NOT FOUND; /* apply on c15 */

					qt_proc_guia_w 		:= 0;
					nr_seq_apresentacao_w	:= 0;

					qt_vias_w		:= 0;

					open c07;
					loop
					fetch c07 into
						cd_edicao_amb_w,
						cd_procedimento_w,
						ds_procedimento_w,
						qt_solicitada_w,
						qt_autorizada_w,
						dt_autorizacao_w,
						ds_observacao_proc_prescr_w,
						ie_origem_proced_w,
						cd_estabelecimento_w,
						cd_convenio_w,
						ds_proc_tabela_interno_w,
						ds_proc_exame_proc_w,
						ds_proc_procedimento_w,
						ie_urgencia_w,
						DT_PREV_EXECUCAO_w,
						ie_lado_w,
						nr_seq_proc_interno_w,
						nr_seq_pedido_exame_prescr_w,
						ds_topogradia_w,
						cd_senha_proc_prescr_w,
						ie_recem_nato_w,
						nr_seq_proc_prescr_w,
						qt_vias_proc_w,
						cd_proced_tuss_w,
						cd_medico_solic_w,
						nr_prescr_w;
					EXIT WHEN NOT FOUND; /* apply on c07 */

						cd_proc_prescr_w	:= somente_numero(cd_procedimento_w);

						select	cd_procedimento,
							ie_origem_proced,
							cd_grupo_proc,
							cd_especialidade,
							cd_area_procedimento,
							ie_classificacao
						into STRICT	cd_procedimento_w,
							ie_origem_proced_w,
							cd_grupo_proc_w,
							cd_especialidade_w,
							cd_area_procedimento_w,
							ie_classif_proced_w
						from	estrutura_procedimento_v
						where	cd_procedimento		= cd_procedimento_w
						and	ie_origem_proced	= ie_origem_proced_w;

						/*select	max(cd_convenio)
						into	cd_convenio_w
						from	atend_categoria_convenio
						where	nr_atendimento		= obter_atendimento_prescr(nr_prescr_tiss_p);*/
						select 	(max(obter_setor_prescricao(nr_prescr_w,'C')))::numeric
						into STRICT 	cd_setor_prescr_w
						;

						ie_regra_w := TISS_OBTER_REGRA_PROC_PRESCR(	cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, cd_procedimento_w, ie_origem_proced_w, cd_estabelecimento_w, ie_regra_w, cd_convenio_w, ie_tipo_atendimento_w, cd_setor_prescr_w, nr_seq_proc_interno_w);

						select	coalesce(max(ie_spsadt_zerado),'S'),
							coalesce(max(ie_medico_rep),'P'),
							coalesce(max(ie_desc_proc_interno),'P'),
							coalesce(max(ie_obs_urgente), 'N'),
							coalesce(max(ie_lado_rep),'N'),
							coalesce(max(ie_solicitante),'H'),
							coalesce(max(ie_proc_tuss),'N'),
							coalesce(max(ie_topo_rep),'N'),
							coalesce(max(ie_conversao_sadt_solic),'S')
						into STRICT	ie_spsadt_zerado_w,
							ie_medico_rep_w,
							ie_desc_proc_interno_w,
							ie_obs_urgente_w,
							ie_lado_rep_w,
							ie_solicitante_w,
							ie_proc_tuss_w,
							ie_topo_rep_w,
							ie_conversao_sadt_solic_w
						from	tiss_parametros_convenio
						where	cd_estabelecimento	= cd_estabelecimento_w
						and	cd_convenio		= cd_convenio_w;

						if (ie_obs_urgente_w = 'S') and (ie_urgencia_w = 'S') then
							ds_observacao_w			:= substr(ds_dt_prevista_exec_w||': ' || to_char(DT_PREV_EXECUCAO_w, 'dd/mm/yyyy hh24:mi') || chr(13) || ds_observacao_w,1,255);
						end if;

						ds_proc_tuss_w	:= null;
						cd_proc_tuss_w	:= null;

						if (coalesce(cd_proced_tuss_w,0) > 0) then
							cd_proc_tuss_w := cd_proced_tuss_w;
						elsif (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') then
							select 	max(cd_procedimento_tuss)
							into STRICT 	cd_proc_tuss_w
							from 	proc_interno
							where	nr_sequencia	= nr_seq_proc_interno_w;

						elsif (nr_seq_pedido_exame_prescr_w IS NOT NULL AND nr_seq_pedido_exame_prescr_w::text <> '') then
							select 	max(cd_procedimento_tuss)
							into STRICT 	cd_proc_tuss_w
							from 	exame_laboratorio
							where	nr_seq_exame	= nr_seq_pedido_exame_prescr_w;

						end if;


						if (coalesce(cd_proc_tuss_w,0) > 0) then
							ds_proc_tuss_w	:= Obter_Descricao_Procedimento(cd_proc_tuss_w,8);
						end if;


						ds_proced_convenio_w	:= null;
						nr_seq_conversao_w	:= null;
						cd_proced_conversao_w	:= null;

						--lhalves OS275759 em 19/01/11 - tratar conversao.

						/*select 	max(TISS_Obter_Proced_Conversao(cd_convenio_w, cd_procedimento_w, ie_origem_proced_w, 'D'))
						into	ds_proced_convenio_w
						from 	dual;	*/
						select	max(b.ie_sexo),
							max(b.nr_prontuario),
							max(a.cd_procedencia)
						into STRICT	ie_sexo_w,
							nr_prontuario_w,
							cd_procedencia_w
						from	atendimento_paciente a,
							pessoa_fisica b
						where	a.cd_pessoa_fisica = b.cd_pessoa_fisica
						and	a.nr_atendimento = nr_atendimento_w;

						SELECT * FROM converte_proc_convenio(	cd_estabelecimento_w, cd_convenio_w, null, cd_procedimento_w, ie_origem_proced_w, null, null, ie_tipo_atendimento_w, clock_timestamp(), cd_proced_conversao_w, cd_grupo_proc_conversao_w, nr_seq_conversao_w, cd_setor_atendimento_w, null, nr_seq_proc_interno_w, 'A', null, ie_clinica_w, 0, null, null, null, ie_sexo_w, null, null, 0, null, null, null) INTO STRICT cd_proced_conversao_w, cd_grupo_proc_conversao_w, nr_seq_conversao_w;

						select	substr(max(ds_proc_convenio),1,255)
						into STRICT	ds_proced_convenio_w
						from	conversao_proc_convenio
						where	cd_convenio	= cd_convenio_w
						and	nr_sequencia 	= nr_seq_conversao_w;

						if (coalesce(cd_proc_tuss_w,'0') <> '0') then
							open c24;
							loop
							fetch c24 into
								ie_codigo_tuss_w,
								ie_desc_tuss_w;
							EXIT WHEN NOT FOUND; /* apply on c24 */
								ie_proc_tuss_w		:= ie_codigo_tuss_w;
								ie_desc_proc_interno_w	:= ie_desc_tuss_w;
							end loop;
							close c24;
						end if;

						if (coalesce(ie_conversao_sadt_solic_w,'S') = 'N') then
							ds_proced_convenio_w	:= null;
						end if;

						if (ie_desc_proc_interno_w = 'S') then
							ds_procedimento_w 	:= substr(coalesce(ds_proc_tabela_interno_w, ds_procedimento_w),1,255);
						elsif (ie_desc_proc_interno_w = 'P') then
							ds_procedimento_w 	:= substr(coalesce(ds_proced_convenio_w,coalesce(ds_proc_exame_proc_w, ds_procedimento_w)),1,255);
						elsif (ie_desc_proc_interno_w = 'N') then
							ds_procedimento_w 	:= substr(coalesce(ds_proced_convenio_w,coalesce(ds_procedimento_w,ds_proc_procedimento_w)),1,255);
						elsif (ie_desc_proc_interno_w = 'T') then
							ds_procedimento_w 	:= substr(coalesce(ds_proc_tuss_w,ds_procedimento_w),1,255);
						elsif (ie_desc_proc_interno_w = 'C')	then

							select	substr(Obter_Desc_Procedimento(cd_procedimento_w,ie_origem_proced_w),1,255)
							into STRICT	ds_proc_tab_w
							;

							if (ds_proced_convenio_w IS NOT NULL AND ds_proced_convenio_w::text <> '') and (ds_proced_convenio_w <> ds_proc_tab_w) then

								ds_procedimento_w	:= substr(ds_proced_convenio_w,1,255);

							elsif (ds_proc_tuss_w IS NOT NULL AND ds_proc_tuss_w::text <> '') and (coalesce(cd_proc_tuss_w,'0') <> '0') then --Possui proc TUSS
								ds_procedimento_w	:= substr(ds_proc_tuss_w,1,255);
							end if;
						end if;

						if (coalesce(IE_REGRA_W, 'S') = 'S') then

							if (qt_vias_proc_w > qt_vias_w) then
								qt_vias_w	:= qt_vias_proc_w;
							end if;

							qt_proc_guia_w		:= qt_proc_guia_w + 1;

							if (qt_proc_guia_w = 1) then

								ds_observacao_guia_w	:= null;

								select	nextval('w_tiss_guia_seq')
								into STRICT	nr_seq_guia_w
								;

								if (coalesce(ie_data_ass_prest_w,'N') = 'S') then
									dt_assin_prest_w	:= dt_atendimento_w;

								elsif (coalesce(ie_data_ass_prest_w,'N') = 'N') then
									dt_assin_prest_w	:= clock_timestamp();
								elsif (coalesce(ie_data_ass_prest_w,'N') = 'V') then	
									dt_assin_prest_w	:= null;							
								end if;

								/*lhalves OS 226155 em 25/06/2010 - Considerar regra guia princ, ao emitir a guia pelo REP*/

								ie_regra_guia_princ_w	:= null;
								open c16;
								loop
								fetch c16 into
									ie_regra_guia_princ_w;
								EXIT WHEN NOT FOUND; /* apply on c16 */
								end loop;
								close c16;

								if (ie_regra_guia_princ_w = 'AG') then
									if (cd_autor_princ_w IS NOT NULL AND cd_autor_princ_w::text <> '') then
										cd_autor_princ_prescr_w := cd_autor_princ_w;
									else
										select 	CASE WHEN cd_autorizacao_ww='X' THEN  cd_autorizacao_w  ELSE cd_autorizacao_ww END
										into STRICT	cd_autor_princ_prescr_w
										;
									end if;
								elsif (ie_regra_guia_princ_w in ('GP','A')) then
									cd_autor_princ_prescr_w := cd_autor_princ_w;
								elsif (ie_regra_guia_princ_w = 'S') then
									cd_autor_princ_prescr_w	:= cd_senha_w;
								elsif (ie_regra_guia_princ_w = 'AS') then
									cd_autor_princ_prescr_w := cd_autor_princ_w || cd_senha_w;
								elsif (ie_regra_guia_princ_w = 'G') then
									select 	CASE WHEN cd_autorizacao_ww='X' THEN  cd_autorizacao_w  ELSE cd_autorizacao_ww END
									into STRICT	cd_autor_princ_prescr_w
									;
								elsif (ie_regra_guia_princ_w = 'N') then
									cd_autor_princ_prescr_w := null;
								end if;

								if (ie_senha_guia_w = 'P') then
									cd_senha_w	:= coalesce(cd_senha_proc_prescr_w,cd_senha_w);
								end if;


								if (ie_guia_prestador_w = 'G') then --Numero da guia
									select	CASE WHEN cd_autorizacao_ww='X' THEN  cd_autorizacao_w  ELSE cd_autorizacao_ww END
									into STRICT	nr_guia_prestador_w
									;							
								elsif (ie_guia_prestador_w = 'GT') then --Numero da guia + Tipo de guia
									select	CASE WHEN cd_autorizacao_ww='X' THEN  cd_autorizacao_w  ELSE cd_autorizacao_ww END ||'2'
									into STRICT	nr_guia_prestador_w
									;	
								elsif (ie_guia_prestador_w = 'SG') then --Numero de sequencia da guia
									nr_guia_prestador_w 	:= nr_seq_guia_w;
								elsif (ie_guia_prestador_w = 'S') then --Senha do atendimento
									nr_guia_prestador_w 	:= cd_senha_w;
								elsif (ie_guia_prestador_w = 'PR') then --Prontuario do paciente								
									nr_guia_prestador_w	:= nr_prontuario_w;
								elsif (ie_guia_prestador_w = 'GE') then --Numero da guia da EUP
									nr_guia_prestador_w	:= cd_autor_princ_w;
								elsif (ie_guia_prestador_w = 'A') then --Numero do atendimento
									nr_guia_prestador_w	:= nr_atendimento_w;
								elsif (ie_guia_prestador_w = 'R') then
									SELECT * FROM TISS_OBTER_GUIA_PRESTADOR( cd_estabelecimento_w, cd_convenio_w, '2', nr_atendimento_w, null, cd_autorizacao_w, nr_seq_guia_w, nr_guia_prestador_w, ie_regra_guia_prest_w) INTO STRICT nr_guia_prestador_w, ie_regra_guia_prest_w;
								end if;		

								if (ie_assinatura_solic_w	= 'S') then
									select	max(nm_pessoa_fisica)
									into STRICT	ds_assinatura_solic_w
									from	pessoa_fisica
									where	cd_pessoa_fisica = cd_medico_solic_w;

									if (coalesce(ds_assinatura_solic_w::text, '') = '') then
										ds_assinatura_solic_w		:= '   ____________________________';
									end if;
								else
									ds_assinatura_solic_w		:= coalesce(tiss_obter_regra_campo(4, 'DS_ASSINATURA_SOLIC', cd_convenio_W, ds_assinatura_solic_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_execucao_w), '   ____________________________');
								end if;											

								insert	into w_tiss_guia(nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									cd_ans,
									cd_autorizacao,
									cd_autorizacao_princ,
									dt_autorizacao,
									cd_senha,
									dt_validade_senha,
									dt_emissao_guia,
									nr_interno_conta,
									nr_seq_protocolo,
									nr_sequencia_autor,
									ds_observacao,
									ie_tiss_tipo_guia,
									dt_entrada,
									nr_atendimento,
									dt_assin_prest,
									dt_assin_solic,
									ie_atendimento_rn,
									dt_assin_resp,
									ds_versao,
									nr_guia_prestador,
									ds_assinatura_solic)
								values (nr_seq_guia_w,
									clock_timestamp(),
									nm_usuario_p,
									cd_ans_w,
									tiss_obter_regra_campo(2, 'CD_AUTORIZACAO', CD_CONVENIO_W, CASE WHEN cd_autorizacao_ww='X' THEN  cd_autorizacao_w  ELSE cd_autorizacao_ww END , ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
									tiss_obter_regra_campo(2, 'CD_AUTORIZACAO_PRINC', CD_CONVENIO_W, cd_autor_princ_prescr_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
									tiss_obter_regra_campo(2, 'DT_AUTORIZACAO', CD_CONVENIO_W, dt_inicio_vigencia_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
									tiss_obter_regra_campo(2, 'CD_SENHA', CD_CONVENIO_W, cd_senha_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
									to_date(tiss_obter_regra_campo(2, 'DT_VALIDADE_SENHA', CD_CONVENIO_W, to_char(dt_final_vigencia_w,'dd/mm/yyyy'), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),'dd/mm/yyyy'),
									to_date(tiss_obter_regra_campo(2, 'DT_EMISSAO_GUIA', CD_CONVENIO_W, to_char(clock_timestamp(),'dd/mm/yyyy'), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),'dd/mm/yyyy'),
									null,
									null,
									null,
									coalesce(tiss_obter_regra_campo(4, 'DS_OBSERVACAO', CD_CONVENIO_W, ds_observacao_proc_prescr_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'), ds_observacao_w),
									'2',
									tiss_obter_regra_campo(2, 'DT_ASSINATURA_RESP', CD_CONVENIO_W, dt_atendimento_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
									nr_atendimento_w,
									tiss_obter_regra_campo(2, 'DS_ASSINATURA_EXEC', CD_CONVENIO_W, DT_ASSIN_PREST_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
									tiss_obter_regra_campo(2, 'DS_ASSINATURA_SOLIC', CD_CONVENIO_W, dt_autorizacao_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
									ie_atendimento_rn_w,
									to_date(tiss_obter_regra_campo(2, 'DT_ASSINATURA_RESP_AUTOR', cd_convenio_W, null, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),'dd/mm/yyyy hh24:mi:ss'),
									ds_versao_w,
									coalesce(cd_autorizacao_prest_w, nr_guia_prestador_w),
									ds_assinatura_solic_w);

								nm_beneficiario_w	:= TISS_OBTER_TITULAR_CONV_RN(nr_atendimento_w, null, cd_convenio_w, cd_estabelecimento_w);	

								if (ie_recem_nato_w = 'S') and (position('RN de' in nm_beneficiario_w) = 0)  then
									ie_rn_w	:= 'R.N. ';
								else
									ie_rn_w	:= null;
								end if;


								/*lhalves OS305885 em 30/03/2011 - substituido a view pelo select - Performance*/

								insert	into w_tiss_beneficiario(nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									nr_seq_guia,
									cd_pessoa_fisica,
									nm_pessoa_fisica,
									nr_cartao_nac_sus,
									ds_plano,
									dt_validade_carteira,
									cd_usuario_convenio)
								SELECT	nextval('w_tiss_beneficiario_seq'),
									clock_timestamp(),
									nm_usuario_p,
									nr_seq_guia_w,
									c.cd_pessoa_fisica,
									substr(ie_rn_w||nm_beneficiario_w,1,150),
									c.nr_cartao_nac_sus,
									substr(obter_desc_plano(b.cd_convenio, b.cd_plano_convenio),1,40),
									b.dt_validade_carteira,
									b.cd_usuario_convenio
								from	pessoa_fisica c,
									atend_categoria_convenio b,
									atendimento_paciente a
								where	b.nr_seq_interno	= obter_atecaco_atendimento(b.nr_atendimento)
								and	a.nr_atendimento	= b.nr_atendimento
								and	a.cd_pessoa_fisica	= c.cd_pessoa_fisica
								and	a.nr_atendimento	= nr_atendimento_w;

								/*inicio lhalves OS213180 em 07/05/2010 - gravar o tipo atend tiss conforme regras */

								select	max(coalesce(ie_tipo_atend_tiss,'0'))
								into STRICT 	ie_tipo_atend_tiss_w
								from	tiss_tipo_atendimento
								where	cd_estabelecimento						= cd_estabelecimento_w
								and	coalesce(ie_tipo_atendimento,coalesce(ie_tipo_atendimento_w,0))		= coalesce(ie_tipo_atendimento_w,0)
								and	coalesce(ie_clinica, coalesce(ie_clinica_w,0))				= coalesce(ie_clinica_w,0)
								and	coalesce(nr_seq_classif_atend, coalesce(nr_seq_classif_atend_w,0))	= coalesce(nr_seq_classif_atend_w,0)
								and	coalesce(cd_setor_entrada, Obter_Setor_Atendimento(nr_atendimento_w))	= Obter_Setor_Atendimento(nr_atendimento_w)
								and	coalesce(cd_convenio, cd_convenio_w)					= cd_convenio_w
								and	coalesce(cd_procedencia, cd_procedencia_w)				= cd_procedencia_w
								order by
									coalesce(ie_tipo_atendimento,0),
									coalesce(ie_clinica,0),
									coalesce(cd_setor_entrada,0),
									coalesce(cd_convenio,0),
									coalesce(cd_procedencia,0);

								open C38;
								loop
								fetch C38 into	
									ie_tipo_acidente_w;
								EXIT WHEN NOT FOUND; /* apply on C38 */									
								end loop;
								close C38;

								insert into w_tiss_dados_atendimento(nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									nr_seq_guia,
									ie_tipo_atendimento,
									ie_tipo_acidente)
								values (nextval('w_tiss_dados_atendimento_seq'),
									clock_timestamp(),
									nm_usuario_p,
									nr_seq_guia_w,
									tiss_obter_regra_campo(2, 'IE_TIPO_ATENDIMENTO', CD_CONVENIO_W, ie_tipo_atend_tiss_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
									tiss_obter_regra_campo(2, 'IE_TIPO_ACIDENTE', CD_CONVENIO_W, ie_tipo_acidente_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'));
								/*Fim lhalves OS 213180*/

								select	max(obter_nome_medico(cd_medico,'N')),
									substr(max(obter_dados_medico(cd_medico, 'UFCRM')),1,2),
									max(obter_dados_medico(cd_medico, 'SGCRM')),
									max(obter_dados_medico(cd_medico, 'CRM')),
									max(obter_dados_pf(cd_medico, 'CPF')),
									max(substr(obter_nome_pf_pj(null, cd_cgc_solic),1,254)),
									max(cd_cgc_solic),
									max(cd_medico),
									coalesce(max(crm_medico_externo),crm_medico_externo_w),
									coalesce(max(nm_medico_externo),nm_medico_externo_w),
									max(cd_medico)
								into STRICT	nm_medico_solic_w,
									uf_crm_w,
									sg_conselho_w,
									nr_crm_w,
									nr_cpf_w,
									nm_contratado_solic_w,
									cd_interno_solic_w,
									cd_medico_solic_w,
									crm_medico_externo_w,
									nm_medico_externo_w,
									cd_medico_prescr_w
								from	prescr_medica
								where	nr_prescricao	= nr_prescr_w;

							

								select	coalesce(max(obter_nome_medico_convenio(cd_estabelecimento_w, cd_medico_solic_w, cd_convenio_w, null, null, cd_categoria_conv_w,cd_setor_entrada_w,ie_tipo_atendimento_w)), nm_medico_solic_w)
								into STRICT	nm_medico_solic_w
								;

								if (ie_medico_rep_w	= 'A') then
									select	coalesce(max(obter_nome_medico(b.cd_medico_anterior, 'N')), nm_medico_solic_w),
										substr(coalesce(max(obter_dados_medico(b.cd_medico_anterior, 'UFCRM')), uf_crm_w),1,2),
										coalesce(max(obter_dados_medico(b.cd_medico_anterior, 'SGCRM')), sg_conselho_w),
										coalesce(max(obter_dados_medico(b.cd_medico_anterior, 'CRM')), nr_crm_w),
										coalesce(max(obter_dados_pf(b.cd_medico_anterior, 'CPF')), nr_cpf_w),
										coalesce(max(b.cd_medico_anterior),cd_medico_solic_w)
									into STRICT	nm_medico_solic_w,
										uf_crm_w,
										sg_conselho_w,
										nr_crm_w,
										nr_cpf_w,
										cd_medico_solic_w
									from	atendimento_troca_medico b,
										atendimento_paciente a
									where	a.nr_atendimento	= b.nr_atendimento
									and	a.nr_atendimento	= nr_atendimento_w
									and	b.dt_troca = (	SELECT	min(x.dt_troca)
												from	atendimento_troca_medico x
												where	x.nr_atendimento = a.nr_atendimento);
												
									select TISS_OBTER_CBO_MEDICO(cd_medico_solic_w)
									into STRICT cd_cbo_med_prest_w
									;

									select	coalesce(max(obter_nome_medico_convenio(cd_estabelecimento_w, cd_medico_solic_w, cd_convenio_w, null, null, cd_categoria_conv_w,cd_setor_entrada_w,ie_tipo_atendimento_w)), nm_medico_solic_w)
									into STRICT	nm_medico_solic_w
									;

								elsif (ie_medico_rep_w	= 'E') then

									if (nm_medico_externo_w IS NOT NULL AND nm_medico_externo_w::text <> '') or (crm_medico_externo_w IS NOT NULL AND crm_medico_externo_w::text <> '') then

										if (nm_medico_externo_w IS NOT NULL AND nm_medico_externo_w::text <> '') then
											nm_medico_solic_w	:= nm_medico_externo_w;
											nr_cpf_w		:= null;
										end if;
										if (crm_medico_externo_w IS NOT NULL AND crm_medico_externo_w::text <> '') then
											nr_crm_w		:= crm_medico_externo_w;
											sg_conselho_w		:= 'CRM';
										end if;
									else
										select	max(obter_nome_medico(cd_medico,'N')),
											substr(max(obter_dados_medico(cd_medico, 'UFCRM')),1,2),
											max(obter_dados_medico(cd_medico, 'SGCRM')),
											max(obter_dados_medico(cd_medico, 'CRM')),
											max(obter_dados_pf(cd_medico, 'CPF')),
                                            						max(cd_medico)
										into STRICT	nm_medico_solic_w,
											uf_crm_w,
											sg_conselho_w,
											nr_crm_w,
											nr_cpf_w,
                                            						cd_medico_prescr_w
										from	prescr_medica
										where	nr_prescricao	= nr_prescr_w;

										select TISS_OBTER_CBO_MEDICO(cd_medico_prescr_w)
										into STRICT cd_cbo_med_prest_w
										;

										select	coalesce(max(obter_nome_medico_convenio(cd_estabelecimento_w, cd_medico_solic_w, cd_convenio_w, null, null, cd_categoria_conv_w,cd_setor_entrada_w,ie_tipo_atendimento_w)), nm_medico_solic_w)
										into STRICT	nm_medico_solic_w
										;
									end if;
								elsif (ie_medico_rep_w	= 'P') then	
										
										select TISS_OBTER_CBO_MEDICO(cd_medico_prescr_w)
										into STRICT cd_cbo_med_prest_w
										;

								end if;

								select	coalesce(max(obter_se_medico_conveniado(cd_estabelecimento_w, cd_medico_solic_w, cd_convenio_w, null, null, null, cd_setor_atendimento_w,null,null, null, null)), 'N')
								into STRICT	ie_conveniado_w
								;								

								ie_solicitante_ww	:= null;

								if (ie_solicitante_w	= 'R') then

									select	max(d.ie_tipo_atendimento),
										max(d.ie_clinica),
										--max(d.cd_procedencia),
										max(d.cd_medico_referido),
										max(coalesce(cd_medico_atendimento, cd_medico_resp)),
										max(obter_setor_atendimento(nr_atendimento))
									into STRICT	ie_tipo_atendimento_w,
										ie_clinica_w,
										--cd_procedencia_w,
										cd_medico_referido_w,
										cd_medico_atendimento_w,
										cd_setor_entrada_w
									from	atendimento_paciente d
									where	nr_atendimento	= nr_atendimento_w;

									SELECT * FROM tiss_obter_regra_prest_solic( cd_convenio_w, cd_estabelecimento_w, cd_setor_prescr_w, ie_clinica_w, cd_procedencia_w, ie_tipo_atendimento_w, 'N', ie_solicitante_w, cd_cgc_prest_solic_regra_w, cd_medico_atendimento_w, cd_medico_solic_w, cd_prestador_solic_tiss_w, ds_prestador_solic_tiss_w, cd_medico_referido_w, cd_categoria_conv_w, clock_timestamp(), null, cd_medico_prescr_w, cd_plano_convenio_w, nr_seq_regra_solic_w) INTO STRICT ie_solicitante_w, cd_cgc_prest_solic_regra_w, cd_medico_solic_w, cd_prestador_solic_tiss_w, ds_prestador_solic_tiss_w, nr_seq_regra_solic_w;
								end if;

								if (ie_solicitante_w	= 'M') or (ie_solicitante_w	= 'MC' AND ie_conveniado_w	= 'S') then
									ie_solicitante_ww		:= ie_solicitante_w;
									nm_contratado_solic_w		:= nm_medico_solic_w;
									cd_interno_solic_w		:= tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_solic_w, null, cd_setor_prescr_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w);
								elsif (ie_solicitante_w	= 'I') then
									if (coalesce(cd_medico_solic_w::text, '') = '') then
										ie_solicitante_ww		:= ie_solicitante_w;
										select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prest_solic_regra_w, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
											max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prest_solic_regra_w, cd_setor_entrada_w, 'CGC',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
										into STRICT	cd_interno_solic_w,
											cd_cgc_solic_w
										;

										select	substr(max(ds_razao_social),1,255),
											max(cd_cnes)
										into STRICT	nm_contratado_solic_w,
											cd_cnes_solic_w
										from	pessoa_juridica
										where	cd_cgc		= cd_cgc_prest_solic_regra_w;
									else
										ie_solicitante_ww		:= ie_solicitante_w;
										select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_solic_w, null, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
											max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_solic_w, null, cd_setor_entrada_w, 'CPF',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
										into STRICT	cd_interno_solic_w,
											nr_cpf_solic_w
										;

										select	max(nm_pessoa_fisica),
											max(cd_cnes)
										into STRICT	nm_contratado_solic_w,
											cd_cnes_solic_w
										from	pessoa_fisica
										where	cd_pessoa_fisica	= cd_medico_solic_w;

									end if;

									if (coalesce(ds_prestador_solic_tiss_w,'X') <> 'X') then
										nm_contratado_solic_w	:= ds_prestador_solic_tiss_w;
									end if;

									if (coalesce(cd_prestador_solic_tiss_w,'X') <> 'X') then
										cd_interno_solic_w	:= cd_prestador_solic_tiss_w;
									end if;

								end if;

								/*lhalves OS305885 em 30/03/2011 - substituido a view pelo select - Performance*/

								insert into w_tiss_contratado_solic(nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									nr_seq_guia,
									cd_cgc,
									cd_interno,
									nr_cpf,
									nm_contratado,
									nm_solicitante,
									cd_cnes,
									sg_conselho,
									nr_crm,
									uf_crm,
									cd_cbo_saude)
								SELECT	nextval('w_tiss_contratado_solic_seq'),
									clock_timestamp(),
									nm_usuario_p,
									nr_seq_guia_w,
									tiss_obter_regra_campo(2, 'CD_INTERNO_SOLIC', CD_CONVENIO_W, CASE WHEN coalesce(ie_solicitante_ww,'H')='H' THEN  f.cd_cgc  ELSE cd_cgc_solic_w END , ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
									tiss_obter_regra_campo(2, 'CD_INTERNO_SOLIC', CD_CONVENIO_W, CASE WHEN coalesce(ie_solicitante_ww,'H')='H' THEN  coalesce(obter_valor_conv_estab(g.cd_convenio, f.cd_estabelecimento, 'CD_INTERNO'),cd_interno_solic_w)  ELSE cd_interno_solic_w END , ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
									substr(tiss_obter_regra_campo(2, 'CD_INTERNO_SOLIC', CD_CONVENIO_W, coalesce(nr_cpf_solic_w, nr_cpf_w), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),1,11),
									tiss_obter_regra_campo(2, 'NM_CONTRATADO_SOLIC', CD_CONVENIO_W, coalesce(nm_contratado_solic_w, substr(tiss_eliminar_caractere(h.ds_razao_social),1,100)), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
									tiss_obter_regra_campo(2, 'NM_SOLICITANTE', CD_CONVENIO_W, nm_medico_solic_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
									tiss_obter_regra_campo(2, 'CD_CNES', CD_CONVENIO_W, coalesce(cd_cnes_solic_w, coalesce(f.cd_cns, h.cd_cnes)), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),									
									tiss_obter_regra_campo(2, 'SG_CONSELHO', CD_CONVENIO_W, sg_conselho_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
									substr(tiss_obter_regra_campo(2, 'NR_CRM', CD_CONVENIO_W, nr_crm_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),1,20),
									substr(tiss_obter_regra_campo(2, 'UF_CRM', CD_CONVENIO_W, uf_crm_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),1,2),
									tiss_obter_regra_campo(2, 'CD_CBO_SAUDE', CD_CONVENIO_W, coalesce(cd_cbo_med_prest_w, k.cd_cbo), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@')
								FROM pessoa_juridica h, convenio g, estabelecimento f, atend_categoria_convenio c, pessoa_fisica i
LEFT OUTER JOIN cbo_saude k ON (i.nr_seq_cbo_saude = k.nr_sequencia)
, atendimento_paciente a
LEFT OUTER JOIN medico b ON (a.cd_medico_resp = b.cd_pessoa_fisica)
WHERE a.nr_atendimento			= c.nr_atendimento and obter_atecaco_atendimento(a.nr_atendimento) = c.nr_seq_interno  and a.cd_estabelecimento 			= f.cd_estabelecimento and c.cd_convenio				= g.cd_convenio and f.cd_cgc				= h.cd_cgc and b.cd_pessoa_fisica			= i.cd_pessoa_fisica  and a.nr_atendimento			= nr_atendimento_w;

								/*lhalves OS325908 em 21/06/2011 - Alterado o select da view pelo propio select - Performance*/

								SELECT	max(a.cd_doenca) cd_doenca_cid,
									substr(max(a.ds_diagnostico),1,255)
								into STRICT	cd_doenca_cid_w,
									ds_observacao_w
								FROM 	diagnostico_doenca a,
									diagnostico_medico c,
									atendimento_paciente e
								WHERE	c.nr_atendimento		= a.nr_atendimento
								AND	c.dt_diagnostico		= a.dt_diagnostico
								and	c.nr_atendimento		= e.nr_atendimento
								and	a.nr_atendimento		= e.nr_atendimento
								AND	a.ie_classificacao_doenca	= 'P'
								and	e.nr_atendimento		= nr_atendimento_w
								AND	c.dt_diagnostico		=
												(SELECT	MAX(x.dt_diagnostico)
												FROM	diagnostico_doenca y,
													diagnostico_medico x
												WHERE	x.nr_atendimento	= e.nr_atendimento
												AND	x.nr_atendimento	= y.nr_atendimento
												AND	x.dt_diagnostico	= y.dt_diagnostico
												AND	y.ie_classificacao_doenca	= 'P');

								Select 	max(a.CD_DOENCA_CID)
								into STRICT	cd_cid_proc_presc_w
								from	prescr_procedimento_cid a
								where	a.nr_prescricao 	= nr_prescr_w;

								select	max(coalesce(TISS_OBTER_CARATER_INTERN(ie_carater_inter_sus),CASE WHEN ie_carater_inter_sus='1' THEN  'E'  ELSE 'U' END ))
								into STRICT	ie_carater_inter_sus_w
								from	atendimento_paciente a
								where	a.nr_atendimento	= nr_atendimento_w;

								if (ie_quebra_horarios_prescr_w = 'S') and (ds_horario_w <> '-1') then

									select	coalesce(max(TISS_OBTER_HORARIO_PROC_PRESC(nr_prescr_w,nr_seq_proc_prescr_w,ds_horario_w)),dt_autorizacao_w)
									into STRICT	dt_autorizacao_w
									;
								end if;

								insert into w_tiss_solicitacao(nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									nr_seq_guia,
									dt_solicitacao,
									ie_carater_solic,
									cd_cid,
									ds_indicacao)
								values (nextval('w_tiss_solicitacao_seq'),
									clock_timestamp(),
									nm_usuario_p,
									nr_seq_guia_w,
									to_date(tiss_obter_regra_campo(2, 'DT_SOLICITACAO', CD_CONVENIO_W, to_char(dt_autorizacao_w, 'dd/mm/yyyy hh24:mi:ss'), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'), 'dd/mm/yyyy hh24:mi:ss'),
									ie_carater_inter_sus_w,
									coalesce(tiss_obter_regra_campo(2, 'CD_DOENCA_CID', CD_CONVENIO_W, coalesce(cd_cid_proc_presc_w,cd_doenca_cid_w), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),cd_cid_proc_presc_w),
									coalesce(ds_inicacao_clinica_w, ds_observacao_w));

							end if;

							ie_emitir_spsadt_zerado_w	:= ie_spsadt_zerado_w;
							if (ie_spsadt_zerado_w	= 'R') then
								ie_emitir_spsadt_zerado_w		:= 'S';
								open c13;
								loop
								fetch c13 into
									ie_emitir_spsadt_zerado_w;
								EXIT WHEN NOT FOUND; /* apply on c13 */
								end loop;
								close c13;
							end if;

							if (coalesce(qt_solicitada_w,0) <> 0) or (coalesce(qt_autorizada_w,0) <> 0) or (ie_emitir_spsadt_zerado_w in ('S','Q')) then

								nr_seq_apresentacao_w	:= nr_seq_apresentacao_w + 1;

								if (coalesce(ie_lado_rep_w,'N') = 'S') then
									if (ie_lado_w IS NOT NULL AND ie_lado_w::text <> '') then
										ds_procedimento_w := substr(ds_procedimento_w || ' - ' || ie_lado_w,1,255);
									end if;
								end if;

								if (coalesce(ie_topo_rep_w,'N') = 'S') then
									if (ds_topogradia_w IS NOT NULL AND ds_topogradia_w::text <> '') then
										ds_procedimento_w := substr(ds_procedimento_w || ' - ' || ds_topogradia_w,1,255);
									end if;
								end if;

								-- Edgar 05/08/2009, OS 158125, tratar conversao

								--cd_procedimento_w := nvl(TISS_Obter_Proced_Conversao(cd_convenio_w, cd_procedimento_w, ie_origem_proced_w, 'C'), cd_procedimento_w);
								if (coalesce(cd_proced_conversao_w,'0') <> '0') and (coalesce(ie_conversao_sadt_solic_w,'S') = 'S') then
									cd_procedimento_w	:= cd_proced_conversao_w;
								end if;

								if (ie_proc_tuss_w = 'C') and (coalesce(cd_proced_conversao_w,'0') <> '0') then
									cd_procedimento_w	:= cd_proced_conversao_w;

								elsif (ie_proc_tuss_w in ('C','S','P')) and (coalesce(cd_proc_tuss_w,0) > 0) then
									cd_procedimento_w	:= to_char(cd_proc_tuss_w);
								end if;

								ds_procedimento_w	:= substr(coalesce(tiss_obter_campo_esp(	cd_convenio_w,
													cd_estabelecimento_w,
													'DS_PROCEDIMENTO',
													ds_procedimento_w,
													null,null,null,null,null,
													null,null,null,null,
													'SADTS',
													cd_proc_prescr_w,
													null,
                                                    cd_setor_execucao_w,
                                                    null,
													null,
													null,
													cd_medico_solic_w,
													null, null, ie_lado_w, null, null),ds_procedimento_w),1,255);

								insert into w_tiss_proc_solic(nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									nr_seq_guia,
									cd_procedimento,
									cd_edicao_amb,
									ds_procedimento,
									qt_solicitada,
									qt_autorizada,
									nr_seq_apresentacao)
								values (nextval('w_tiss_proc_solic_seq'),
									clock_timestamp(),
									nm_usuario_p,
									nr_seq_guia_w,
									tiss_obter_regra_campo(2, 'CD_PROCEDIMENTO_SOLIC', CD_CONVENIO_W, cd_procedimento_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_execucao_w),
									cd_edicao_amb_w,
									ds_procedimento_w,
									qt_solicitada_w,
									tiss_obter_regra_campo(2, 'QT_AUTORIZADA', CD_CONVENIO_W, qt_autorizada_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_execucao_w),
									nr_seq_apresentacao_w);

								if (ds_observacao_proc_prescr_w IS NOT NULL AND ds_observacao_proc_prescr_w::text <> '') then
									if (coalesce(ds_observacao_guia_w::text, '') = '') then
										ds_observacao_guia_w	:= substr((nr_seq_apresentacao_w ||'-'|| ds_observacao_proc_prescr_w),1,3999);
									else
										ds_observacao_guia_w 	:= substr((ds_observacao_guia_w ||' '|| nr_seq_apresentacao_w ||'-'|| ds_observacao_proc_prescr_w),1,3999);
									end if;
								end if;

								if (qt_proc_guia_w = 5) then

									insert into w_tiss_contratado_exec(nr_sequencia,
										dt_atualizacao,
										nm_usuario,
										nr_seq_guia)
									values (nextval('w_tiss_contratado_exec_seq'),
										clock_timestamp(),
										nm_usuario_p,
										nr_seq_guia_w);

									insert	into w_tiss_totais(nr_sequencia,
										dt_atualizacao,
										nm_usuario,
										nr_seq_guia)
									values (nextval('w_tiss_totais_seq'),
										clock_timestamp(),
										nm_usuario_p,
										nr_seq_guia_w);

									qt_proc_guia_w	:= 0;
									nr_seq_apresentacao_w	:= 0;
									CALL TISS_COMPLETAR_GUIA(nr_seq_guia_w, nm_usuario_p);
								end if;

								update	w_tiss_guia
								set	ds_observacao	= tiss_obter_regra_campo(4, 'DS_OBSERVACAO', CD_CONVENIO_W, ds_observacao_guia_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@')
								where	nr_sequencia 	= nr_seq_guia_w;

							end if;
						end if;

					end loop;
					close c07;

					if (qt_proc_guia_w > 0) and (qt_proc_guia_w < 5) then

						insert into w_tiss_contratado_exec(nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							nr_seq_guia)
						values (nextval('w_tiss_contratado_exec_seq'),
							clock_timestamp(),
							nm_usuario_p,
							nr_seq_guia_w);

						insert	into w_tiss_totais(nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							nr_seq_guia)
						values (nextval('w_tiss_totais_seq'),
							clock_timestamp(),
							nm_usuario_p,
							nr_seq_guia_w);

					end if;

					if (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') then

						qt_proc_guia_w		:= 0;
						nr_seq_apresentacao_w	:= 0;

						open c12;
						loop
						fetch c12 into
							cd_opm_w,
							cd_edicao_w,
							ds_opm_w,
							qt_solicitada_w,
							qt_autorizada_w,
							ds_fabricante_w;
						EXIT WHEN NOT FOUND; /* apply on c12 */

							qt_proc_guia_w		:= qt_proc_guia_w + 1;
							nr_seq_apresentacao_w	:= nr_seq_apresentacao_w + 1;

							insert into w_tiss_opm(nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								nr_seq_guia,
								cd_opm,
								cd_edicao,
								ds_opm,
								qt_solicitada,
								qt_autorizada,
								ds_fabricante,
								vl_opm,
								nr_seq_apresentacao)
							values (nextval('w_tiss_opm_seq'),
								clock_timestamp(),
								nm_usuario_p,
								nr_seq_guia_w,
								cd_opm_w,
								cd_edicao_w,
								ds_opm_w,
								qt_solicitada_w,
								qt_autorizada_w,
								ds_fabricante_w,
								null,
								nr_seq_apresentacao_w);

						end loop;
						close c12;

					end if;

					CALL TISS_COMPLETAR_GUIA(nr_seq_guia_w, nm_usuario_p);

					if (qt_vias_w > 1) then
						CALL TISS_REPLICAR_GUIA_SADT(nr_seq_guia_w, qt_vias_w, nm_usuario_p);
					end if;

				end loop;
				close c15;

			end loop;
			close c06;
		end loop;
		close C32;
	end if;

elsif (coalesce(nr_seq_med_fatur_p,0) > 0) then

	select	max(cd_convenio),
		max(a.cd_categoria),
		max(b.cd_estabelecimento),
		max(tiss_obter_se_atend_rn(a.nr_atendimento))
	into STRICT	cd_convenio_w,
		cd_categoria_conv_w,
		cd_estabelecimento_w,
		ie_atendimento_rn_w
	from	atend_categoria_convenio a,
		pep_med_fatur b
	where	a.nr_atendimento	= b.nr_atendimento
	and	b.nr_sequencia	= nr_seq_med_fatur_p;

	select	coalesce(max(IE_EMITE_HONOR_SADT_PEP), 'N'),
		coalesce(max(ie_proc_tuss),'N'),
		coalesce(max(ie_desc_proc_interno),'N'),
		max(ds_arquivo_logo_comp)
	into STRICT	IE_EMITE_HONOR_SADT_PEP_w,
		ie_proc_tuss_w,
		ie_desc_proc_interno_w,
		ds_arquivo_logo_comp_w
	from	tiss_parametros_convenio
	where	cd_convenio		= cd_convenio_w
	and	cd_estabelecimento	= cd_estabelecimento_w;



	select	tiss_obter_versao(cd_convenio_w,cd_estabelecimento_w)
	into STRICT	ds_versao_w
	;

	select	max(cd_cgc)
	into STRICT	cd_cgc_estab_w
	from	estabelecimento
	where	cd_estabelecimento	= cd_estabelecimento_w;

	select	max(cd_ans),
		max(b.ds_arquivo_logo_tiss)
	into STRICT	cd_ans_w,
		ds_arquivo_logo_w
	from	pessoa_juridica c,
		convenio b
	where	b.cd_cgc		= c.cd_cgc
	and	b.cd_convenio	= cd_convenio_w;

	begin
		select	im_logo_convenio
		into STRICT	im_logo_convenio_w
		from	tiss_logo_convenio
		where	cd_convenio	   = cd_convenio_w
		and 	coalesce(ie_situacao,'N') = 'A';
	exception
	when others then
		im_logo_convenio_w := null;
	end;

	if (coalesce(im_logo_convenio_w::text, '') = '') and (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') then
		ds_arquivo_logo_w := tiss_diretorio_logo(ds_arquivo_logo_comp_w, ds_dir_padrao_p) || ds_arquivo_logo_w;
	end if;

	if (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') and (coalesce(im_logo_convenio_w::text, '') = '') then	

		insert	into w_tiss_relatorio(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_arquivo_logo,
			im_logo_convenio)
		values (nextval('w_tiss_relatorio_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			ds_arquivo_logo_w,
			null);
	else
		insert	into w_tiss_relatorio(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_arquivo_logo,
			im_logo_convenio)
		values (nextval('w_tiss_relatorio_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			null,
			im_logo_convenio_w);
	end if;

	open c08;
	loop
	fetch c08 into
		nr_seq_med_fatur_w,
		nr_atendimento_w,
		cd_autorizacao_w,
		cd_medico_convenio_w,
		ie_funcao_medico_w;
	EXIT WHEN NOT FOUND; /* apply on c08 */

		qt_proc_guia_w 		:= 0;
		nr_seq_apres_proc_w	:= 0;

		open c09;
		loop
		fetch c09 into
			cd_procedimento_w,
			ds_procedimento_w,
			qt_solicitada_w,
			qt_autorizada_w,
			dt_entrada_w,
			dt_alta_w,
			cd_edicao_amb_w,
			dt_procedimento_w,
			ie_funcao_w,
			ie_via_acesso_w,
			ie_tecnica_utilizada_w,
			nr_seq_proc_interno_w,
			ie_origem_proced_w;
		EXIT WHEN NOT FOUND; /* apply on c09 */

			qt_proc_guia_w		:= qt_proc_guia_w + 1;

			if (qt_proc_guia_w = 1) then

				select	max(a.cd_senha),
					max(a.dt_inicio_vigencia),
					max(a.dt_final_vigencia),
					max(b.dt_entrada),
					max(b.ie_tipo_atendimento),
					max(b.ie_tipo_atend_tiss),
					max(obter_setor_atendimento(b.nr_atendimento)),
					max(b.ie_clinica),
					max(c.ie_sexo),
					max(a.cd_plano_convenio)
				into STRICT	cd_senha_w,
					dt_inicio_vigencia_w,
					dt_final_vigencia_w,
					dt_atendimento_w,
					ie_tipo_atendimento_w,
					ie_tipo_atend_tiss_w,
					cd_setor_entrada_w,
					ie_clinica_w,
					ie_sexo_w,
					cd_plano_convenio_w
				from	atend_categoria_convenio a,
					atendimento_paciente b,
					pessoa_fisica c
				where	b.cd_pessoa_fisica				= c.cd_pessoa_fisica
				and	a.nr_atendimento				= nr_atendimento_w
				and	obter_atecaco_atendimento(b.nr_atendimento) 	= a.nr_seq_interno
				and	a.nr_atendimento				= b.nr_atendimento;


				select	nextval('w_tiss_guia_seq')
				into STRICT	nr_seq_guia_w
				;

				if (coalesce(ie_data_ass_prest_w,'N') = 'S') then
					dt_assin_prest_w	:= dt_atendimento_w;

				elsif (coalesce(ie_data_ass_prest_w,'N') = 'N') then
					dt_assin_prest_w	:= clock_timestamp();
				elsif (coalesce(ie_data_ass_prest_w,'N') = 'V') then	
					dt_assin_prest_w	:= null;
				end if;

				insert	into w_tiss_guia(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					cd_ans,
					cd_autorizacao,
					dt_autorizacao,
					cd_senha,
					dt_validade_senha,
					dt_emissao_guia,
					nr_interno_conta,
					nr_seq_protocolo,
					nr_sequencia_autor,
					nr_atendimento,
					ds_observacao,
					ie_tiss_tipo_guia,
					dt_entrada,
					DT_ASSIN_PREST,
					ie_atendimento_rn,
					ds_versao)
				values (nr_seq_guia_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					cd_ans_w,
					cd_autorizacao_w,
					dt_inicio_vigencia_w,
					cd_senha_w,
					dt_final_vigencia_w,
					clock_timestamp(),
					null,
					null,
					null,
					nr_atendimento_w,
					tiss_obter_regra_campo(4, 'DS_OBSERVACAO', CD_CONVENIO_W, ds_observacao_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, null, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
					'4',
					dt_atendimento_w,
					DT_ASSIN_PREST_w,
					ie_atendimento_rn_w,
					ds_versao_w);

				/*lhalves OS305885 em 30/03/2011 - substituido a view pelo select - Performance*/

				insert	into w_tiss_beneficiario(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_guia,
					cd_pessoa_fisica,
					nm_pessoa_fisica,
					nr_cartao_nac_sus,
					ds_plano,
					dt_validade_carteira,
					cd_usuario_convenio)
				SELECT	nextval('w_tiss_beneficiario_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w,
					c.cd_pessoa_fisica,
					substr(TISS_OBTER_TITULAR_CONV_RN(nr_atendimento_w, null, cd_convenio_w, cd_estabelecimento_w),1,150),
					to_char(c.nr_cartao_nac_sus),
					substr(obter_desc_plano(b.cd_convenio, b.cd_plano_convenio),1,40),
					b.dt_validade_carteira,
					b.cd_usuario_convenio
				from	pessoa_fisica c,
					atend_categoria_convenio b,
					atendimento_paciente a
				where	b.nr_seq_interno	= obter_atecaco_atendimento(b.nr_atendimento)
				and	a.nr_atendimento	= b.nr_atendimento
				and	a.cd_pessoa_fisica	= c.cd_pessoa_fisica
				and	a.nr_atendimento	= nr_atendimento_w;

				insert into w_tiss_contratado_solic(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_guia,
					cd_cgc,
					cd_interno,
					nr_cpf,
					nm_contratado,
					nm_solicitante,
					cd_cnes,
					sg_conselho,
					nr_crm,
					uf_crm,
					cd_cbo_saude)
				SELECT	nextval('w_tiss_contratado_solic_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w,
					cd_cgc,
					cd_interno,
					nr_cpf_w,
					ds_razao_social,
					obter_nome_medico(cd_medico_convenio_w, 'N'),
					cd_cnes,
					obter_dados_medico(cd_medico_convenio_w, 'SGCRM'),
					obter_dados_medico(cd_medico_convenio_w, 'CRM'),
					substr(obter_dados_medico(cd_medico_convenio_w, 'UFCRM'),1,2),
					coalesce(cd_cbo_med_prest_w, cd_cbo_saude)
				from	tiss_dados_solicitante_v
				where	nr_atendimento		= nr_atendimento_w
				and	ds_versao		= '2.01.01'
				and	ie_origem		= 'AP';

				insert	into w_tiss_contratado_exec(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_guia,
					cd_cgc,
					cd_interno,
					nr_cpf,
					nm_contratado,
					ds_tipo_logradouro,
					ds_logradouro,
					nm_municipio,
					sg_estado,
					cd_municipio_ibge,
					cd_cep,
					cd_cnes,
					nm_medico_executor,
					sg_conselho,
					nr_crm,
					uf_crm,
					cd_cbo_saude,
					ds_funcao_medico)
				SELECT	nextval('w_tiss_contratado_exec_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w,
					cd_cgc,
					coalesce(cd_prestador_convenio_w, cd_interno),
					tiss_obter_regra_campo(4, 'CD_INTERNO', cd_convenio_w, coalesce(nr_cpf_w, TISS_OBTER_CODIGO_PRESTADOR(cd_convenio_w, cd_estabelecimento_w, cd_medico_convenio_w, null, (null)::numeric , 'CI', null,ie_tipo_atendimento_w,cd_categoria_conv_w,ie_funcao_medico_w)), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, null, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
					substr(ds_razao_social,1,255),
					ds_tipo_logradouro,
					substr((ds_endereco || ' ' || nr_endereco || ' ' || ds_complemento),1,255),
					substr(ds_municipio,1,255),
					sg_estado,
					cd_municipio_ibge,
					cd_cep,
					cd_cnes,
					tiss_obter_regra_campo(4, 'NM_EXECUTOR', cd_convenio_w, obter_nome_medico(cd_medico_convenio_w, 'N'), ie_tipo_atendimento_w,
		cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, null, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
					tiss_obter_regra_campo(4, 'SG_CONSELHO', cd_convenio_w, obter_dados_medico(cd_medico_convenio_w, 'SGCRM'), ie_tipo_atendimento_w,
		cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, null, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
					substr(tiss_obter_regra_campo(4, 'NR_CRM', cd_convenio_w, obter_dados_medico(cd_medico_convenio_w, 'CRM'), ie_tipo_atendimento_w,
		cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, null, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),1,20),


					substr(tiss_obter_regra_campo(4, 'UF_CRM', cd_convenio_w, obter_dados_medico(cd_medico_convenio_w, 'UFCRM'), ie_tipo_atendimento_w,
		cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, null, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),1,2),
					cd_cbo_saude,
					ie_funcao_w
				from	tiss_dados_executante_v a
				where	nr_atendimento		= nr_atendimento_w
				and	((IE_EMITE_HONOR_SADT_PEP_w	= 'N' AND ie_honorario = 'N') or
					 (IE_EMITE_HONOR_SADT_PEP_w	= 'S' AND ie_honorario = 'S'))
				and	ds_versao		= '2.01.01';

			end if;

			select	max(cd_procedimento_tuss)
			into STRICT	cd_proc_tuss_w
			from	proc_interno
			where	nr_sequencia	= nr_seq_proc_interno_w;

			ds_proced_convenio_w	:= null;
			nr_seq_conversao_w	:= null;
			cd_proced_conversao_w	:= null;


			SELECT * FROM converte_proc_convenio(	cd_estabelecimento_w, cd_convenio_w, null, cd_procedimento_w, ie_origem_proced_w, null, null, ie_tipo_atendimento_w, clock_timestamp(), cd_proced_conversao_w, cd_grupo_proc_conversao_w, nr_seq_conversao_w, cd_setor_entrada_w, null, nr_seq_proc_interno_w, 'A', cd_plano_convenio_w, ie_clinica_w, 0, null, null, null, ie_sexo_w, null, null, 0, null, null, null) INTO STRICT cd_proced_conversao_w, cd_grupo_proc_conversao_w, nr_seq_conversao_w;


			select	substr(max(ds_proc_convenio),1,255)
			into STRICT	ds_proced_convenio_w
			from	conversao_proc_convenio
			where	cd_convenio	= cd_convenio_w
			and	nr_sequencia 	= nr_seq_conversao_w;


			if (ie_proc_tuss_w in ('S','F')) and (coalesce(cd_proc_tuss_w,0) > 0) then
				cd_procedimento_w	:= cd_proc_tuss_w;
			elsif (ie_proc_tuss_w = 'C') then

				if (coalesce(cd_proced_conversao_w,0) > 0) then
					cd_procedimento_w := cd_proced_conversao_w;
				elsif (coalesce(cd_proc_tuss_w,0) > 0) then
					cd_procedimento_w := cd_proc_tuss_w;
				end if;

			end if;

			if (ie_desc_proc_interno_w = 'S') and (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') then
				ds_procedimento_w	:= coalesce(substr(obter_desc_proc_interno(nr_seq_proc_interno_w),1,255),ds_procedimento_w);
			elsif (ie_desc_proc_interno_w = 'T') and (coalesce(cd_proc_tuss_w,0) > 0) then
				ds_procedimento_w	:= coalesce(substr(obter_desc_procedimento(cd_proc_tuss_w,8),1,255),ds_procedimento_w);
			elsif (coalesce(ie_desc_proc_interno_w,'X') = 'C')  then

				if (coalesce(ds_proced_convenio_w,'X') <> 'X') then
					ds_procedimento_w := substr(ds_proced_convenio_w,1,255);
				elsif (coalesce(cd_proc_tuss_w,0) > 0) then
					ds_procedimento_w := coalesce(substr(obter_desc_procedimento(cd_proc_tuss_w,8),1,255),ds_procedimento_w);
				end if;

			end if;


			nr_seq_apres_proc_w	:= nr_seq_apres_proc_w + 1;

			insert	into w_tiss_proc_paciente(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nr_seq_guia,
				cd_procedimento,
				cd_edicao_amb,
				qt_procedimento,
				vl_reducao_acrescimo,
				vl_procedimento,
				dt_entrada,
				dt_alta,
				vl_unitario,
				ds_procedimento,
				dt_procedimento,
				nr_seq_apresentacao,
				ie_tecnica_utilizada,
				ie_via_acesso)
			values (nextval('w_tiss_proc_paciente_seq'),
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_guia_w,
				cd_procedimento_w,
				cd_edicao_amb_w,
				qt_autorizada_w,
				null,
				null,
				dt_entrada_w,
				dt_alta_w,
				null,
				ds_procedimento_w,
				dt_procedimento_w,
				nr_seq_apres_proc_w,
				ie_tecnica_utilizada_w,
				ie_via_acesso_w);

			if (qt_proc_guia_w = 5) then

				insert into w_tiss_contratado_exec(NR_SEQUENCIA,
					dt_ATUALIZACAO,
					nm_usUARIO,
					nr_seq_GUIA)
				values (nextval('w_tiss_contratado_exec_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w);

				insert	into w_tiss_totais(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_guia)
				values (nextval('w_tiss_totais_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w);

				qt_proc_guia_w	:= 0;
			end if;

		end loop;
		close c09;

		if (qt_proc_guia_w > 0) and (qt_proc_guia_w < 5) then

			insert	into w_tiss_totais(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nr_seq_guia)
			values (nextval('w_tiss_totais_seq'),
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_guia_w);

		end if;

		CALL TISS_COMPLETAR_GUIA(nr_seq_guia_w, nm_usuario_p);

	end loop;
	close c08;

elsif (coalesce(nr_seq_exame_param_w,0) > 0 ) then


	qt_proc_guia_w 	:= 0;

	select	max(cd_ans),
		max(b.ds_arquivo_logo_tiss),
		max(b.cd_convenio),
		max(wheb_usuario_pck.get_cd_estabelecimento)
	into STRICT	cd_ans_w,
		ds_arquivo_logo_w,
		cd_convenio_w,
		cd_estabelecimento_w
	from	pessoa_juridica c,
		med_atendimento x,
		med_pedido_exame j,
		convenio b
	where	x.cd_convenio		= b.cd_convenio
	and	x.nr_atendimento	= (SELECT max(y.nr_atendimento) from med_atendimento y where y.nr_seq_cliente = j.nr_seq_cliente)
	and	b.cd_cgc		= c.cd_cgc
	and	j.nr_sequencia		= nr_seq_exame_param_w;

	select	coalesce(max(ie_cid_solic_externo), 'N'),
		coalesce(max(ie_quebra_proc_pep),'N'),
		coalesce(max(ie_gerar_tiss), 'S'),
		coalesce(max(ie_proc_tuss),'N'),
		coalesce(max(ie_desc_proc_interno),'P'),
		max(ds_arquivo_logo_comp)
	into STRICT	ie_cid_exame_externo_w,
		ie_quebra_proc_pep_w,
		ie_gerar_tiss_w,
		ie_proc_tuss_w,
		ie_desc_proc_interno_w,
		ds_arquivo_logo_comp_w
	from	tiss_parametros_convenio
	where	cd_convenio		= cd_convenio_w
	and	cd_estabelecimento	= cd_estabelecimento_w;



	select	max(ds_versao)
	into STRICT	ds_versao_w
	from	xml_projeto
	where	nr_sequencia	= tiss_obter_xml_projeto(cd_convenio_w, cd_estabelecimento_w, '6', clock_timestamp());

		begin
			select	im_logo_convenio
			into STRICT	im_logo_convenio_w
			from	tiss_logo_convenio
			where	cd_convenio	   = cd_convenio_w
			and 	coalesce(ie_situacao,'N') = 'A';
		exception
		when others then
			im_logo_convenio_w := null;
		end;

		if (coalesce(im_logo_convenio_w::text, '') = '') and (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') then
			ds_arquivo_logo_w := tiss_diretorio_logo(ds_arquivo_logo_comp_w, ds_dir_padrao_p) || ds_arquivo_logo_w;
		end if;

		if (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') and (coalesce(im_logo_convenio_w::text, '') = '') then
			insert	into w_tiss_relatorio(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_arquivo_logo,
				im_logo_convenio)
			values (nextval('w_tiss_relatorio_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				ds_arquivo_logo_w,
				null);
		else
			insert	into w_tiss_relatorio(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_arquivo_logo,
				im_logo_convenio)
			values (nextval('w_tiss_relatorio_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				null,
				im_logo_convenio_w);
		end if;

		nr_seq_apresentacao_w := 0;

		select	nextval('w_tiss_guia_seq')
		into STRICT	nr_seq_guia_w
		;

		qt_proc_guia_w 		:= 0;
		nr_seq_apresentacao_w 	:= 0;

		open c17;
		loop
		fetch c17 into
			nr_seq_exame_w,
			cd_procedimento_w,
			ds_procedimento_w,
			qt_solicitada_w,
			qt_autorizada_w,
			nr_atendimento_w,
			cd_medico_w,
			cd_autorizacao_w,
			cd_senha_w,
			dt_inicio_vigencia_w,
			dt_final_vigencia_w,
			cd_cgc_w,
			ds_razao_social_w,
			cd_cnes_w,
			dt_atendimento_w,
			ds_justificativa_w,
			ds_cid_w,
			ie_tipo_atend_tiss_w,
			ie_clinica_w,
			cd_usuario_convenio_w,
			ds_carater_internacao_w;
		EXIT WHEN NOT FOUND; /* apply on c17 */

			select	max(tiss_obter_se_atend_rn(nr_atendimento_w))
			into STRICT	ie_atendimento_rn_w
			;

			qt_proc_guia_w 		:= qt_proc_guia_w + 1;

			if (qt_proc_guia_w = 1) then
				select	nextval('w_tiss_guia_seq')
				into STRICT	nr_seq_guia_w
				;

				if (coalesce(ie_data_ass_prest_w,'N') = 'S') then
					dt_assin_prest_w	:= dt_atendimento_w;

				elsif (coalesce(ie_data_ass_prest_w,'N') = 'N') then
					dt_assin_prest_w	:= clock_timestamp();
				elsif (coalesce(ie_data_ass_prest_w,'N') = 'V') then					
					dt_assin_prest_w	:= null;
				end if;

				insert	into w_tiss_guia(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					cd_ans,
					cd_autorizacao,
					dt_autorizacao,
					cd_senha,
					dt_validade_senha,
					dt_emissao_guia,
					nr_atendimento,
					ds_observacao,
					ie_tiss_tipo_guia,
					dt_entrada,
					cd_autorizacao_princ,
					DT_ASSIN_PREST,
					ie_atendimento_rn,
					ds_versao,
					nr_guia_prestador)
				values (nr_seq_guia_w,
					clock_timestamp(),
					nm_usuario_p,
					cd_ans_w,
					cd_autorizacao_princ_exame_w,
					null,
					cd_senha_w,
					dt_final_vigencia_w,
					clock_timestamp(),
					nr_atendimento_w,
					tiss_obter_regra_campo(4, 'DS_OBSERVACAO', CD_CONVENIO_W, ds_observacao_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, null,ie_tipo_atend_tiss_w||'#@'),
					'2',
					dt_atendimento_w,
					cd_autorizacao_princ_exame_w,
					DT_ASSIN_PREST_w,
					ie_atendimento_rn_w,					
					ds_versao_w,
					nr_seq_guia_w); --Solicitado na OS 779925 em 19/09
				select 	b.cd_pessoa_fisica,
					substr(obter_nome_pf_pj(b.cd_pessoa_fisica,null),1,255),
					null,
					c.ds_plano,
					a.dt_validade_carteira
				into STRICT	cd_pessoa_fisica_w,
					nm_pessoa_fisica_w,
					nr_cartao_nac_sus_w,
					ds_plano_w,
					dt_validade_carteira_W
				from	med_atendimento a,
					med_cliente b,
					med_plano c
				where	a.nr_seq_cliente	= b.nr_sequencia
				and	a.nr_Seq_plano		= c.nr_sequencia
				and	a.nr_atendimento	= nr_atendimento_w;

				insert	into w_tiss_beneficiario(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_guia,
					cd_pessoa_fisica,
					nm_pessoa_fisica,
					nr_cartao_nac_sus,
					ds_plano,
					dt_validade_carteira,
					cd_usuario_convenio)
				values (nextval('w_tiss_beneficiario_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w,
					cd_pessoa_fisica_w,
					nm_pessoa_fisica_w,
					null,
					ds_plano_w,
					dt_validade_carteira_w,
					cd_usuario_convenio_w);

				insert into w_tiss_contratado_solic(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_guia,
					cd_cgc,
					cd_interno,
					nr_cpf,
					nm_contratado,
					nm_solicitante,
					cd_cnes,
					sg_conselho,
					nr_crm,
					uf_crm,
					cd_cbo_saude)
				SELECT	nextval('w_tiss_contratado_solic_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w,
					substr(obter_dados_pf(cd_pessoa_fisica, 'CPF'), 1, 150),
					null,
					substr(obter_dados_pf(cd_pessoa_fisica, 'CPF'), 1, 150),
					obter_nome_medico(cd_pessoa_fisica,'N'),
					obter_nome_medico(cd_pessoa_fisica,'N'),
					null,
					obter_Dados_medico(cd_pessoa_fisica, 'SGCRM'),
					obter_Dados_medico(cd_pessoa_fisica, 'CRM'),
					substr(obter_Dados_medico(cd_pessoa_fisica, 'UFCRM'),1,2),
					substr(obter_dados_pf(coalesce(cd_cbo_med_prest_w, cd_pessoa_fisica), 'CBOS'),1,20)
				from	medico
				where	cd_pessoa_fisica = cd_medico_w;

				insert into w_tiss_solicitacao(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_guia,
					dt_solicitacao,
					ie_carater_solic,
					cd_cid,
					ds_indicacao)
				SELECT	nextval('w_tiss_solicitacao_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w,
					null,
					ds_carater_internacao_w,
					tiss_obter_regra_campo(2, 'CD_DOENCA_CID', CD_CONVENIO_W, ds_cid_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, null, ie_tipo_atend_tiss_w||'#@'),
					coalesce(ds_justificativa_w, ds_observacao_w)
				;

				insert into w_tiss_dados_atendimento(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_guia,
					ie_tipo_atendimento)
				values (nextval('w_tiss_dados_atendimento_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w,
					ie_tipo_atend_tiss_w);
			end if;

			nr_seq_apresentacao_w	:= nr_seq_apresentacao_w + 1;

			insert into w_tiss_proc_solic(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nr_seq_guia,
				cd_procedimento,
				cd_edicao_amb,
				ds_procedimento,
				qt_solicitada,
				qt_autorizada,
				nr_seq_apresentacao)
			values (nextval('w_tiss_proc_solic_seq'),
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_guia_w,
				cd_procedimento_w,
				null,
				ds_procedimento_w,
				qt_solicitada_w,
				qt_autorizada_w,
				nr_seq_apresentacao_w);

			if (qt_proc_guia_w = 5) then
				nr_seq_apresentacao_w		:= 0;
				qt_proc_guia_w			:= 0;
				CALL TISS_GERAR_OPM_EXEC(nr_seq_conta_guia_w, nr_seq_guia_w, nm_usuario_p);
				CALL TISS_COMPLETAR_GUIA(nr_seq_guia_w, nm_usuario_p);

			end if;
		end loop;
		close c17;

		if (qt_proc_guia_w > 0) and (qt_proc_guia_w < 5) then
			CALL TISS_GERAR_OPM_EXEC(nr_seq_conta_guia_w, nr_seq_guia_w, nm_usuario_p);
			CALL TISS_COMPLETAR_GUIA(nr_seq_guia_w, nm_usuario_p);
		end if;
	--end if;
elsif (coalesce(nr_atend_med_p,0) > 0 ) then


	qt_proc_guia_w 	:= 0;

	select	max(cd_ans),
		max(b.ds_arquivo_logo_tiss),
		max(b.cd_convenio),
		max(wheb_usuario_pck.get_cd_estabelecimento)
	into STRICT	cd_ans_w,
		ds_arquivo_logo_w,
		cd_convenio_w,
		cd_estabelecimento_w
	from	pessoa_juridica c,
		med_atendimento x,
		convenio b
	where	x.cd_convenio		= b.cd_convenio
	and	b.cd_cgc		= c.cd_cgc
	and	x.nr_atendimento	= nr_atend_med_p;

	select	coalesce(max(ie_cid_solic_externo), 'N'),
		coalesce(max(ie_quebra_proc_pep),'N'),
		coalesce(max(ie_gerar_tiss), 'S'),
		coalesce(max(ie_proc_tuss),'N'),
		coalesce(max(ie_desc_proc_interno),'P'),
		coalesce(max(ie_prest_spsadt_tasymed),'M'),
		max(ds_arquivo_logo_comp)
	into STRICT	ie_cid_exame_externo_w,
		ie_quebra_proc_pep_w,
		ie_gerar_tiss_w,
		ie_proc_tuss_w,
		ie_desc_proc_interno_w,
		ie_prest_spsadt_tasymed_w,
		ds_arquivo_logo_comp_w
	from	tiss_parametros_convenio
	where	cd_convenio		= cd_convenio_w
	and	cd_estabelecimento	= cd_estabelecimento_w;

	select	tiss_obter_versao(cd_convenio_w,cd_estabelecimento_w)
	into STRICT	ds_versao_w
	;

	begin
		select	im_logo_convenio
		into STRICT	im_logo_convenio_w
		from	tiss_logo_convenio
		where	cd_convenio	   = cd_convenio_w
		and 	coalesce(ie_situacao,'N') = 'A';
	exception
	when others then
		im_logo_convenio_w := null;
	end;

	if (coalesce(im_logo_convenio_w::text, '') = '') and (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') then
		ds_arquivo_logo_w := tiss_diretorio_logo(ds_arquivo_logo_comp_w, ds_dir_padrao_p) || ds_arquivo_logo_w;
	end if;

		if (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') and (coalesce(im_logo_convenio_w::text, '') = '') then

			insert	into w_tiss_relatorio(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_arquivo_logo,
				im_logo_convenio)
			values (nextval('w_tiss_relatorio_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				ds_arquivo_logo_w,
				null);
		else
			insert	into w_tiss_relatorio(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_arquivo_logo,
				im_logo_convenio)
			values (nextval('w_tiss_relatorio_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				null,
				im_logo_convenio_w);
		end if;

		nr_seq_apresentacao_w := 0;

		select	nextval('w_tiss_guia_seq')
		into STRICT	nr_seq_guia_w
		;

		qt_proc_guia_w 		:= 0;
		nr_seq_apresentacao_w 	:= 0;

		open c18;
		loop
		fetch c18 into
			nr_seq_exame_w,
			cd_procedimento_w,
			ds_procedimento_w,
			qt_solicitada_w,
			qt_autorizada_w,
			nr_atendimento_w,
			cd_medico_w,
			cd_autorizacao_w,
			cd_senha_w,
			dt_inicio_vigencia_w,
			dt_final_vigencia_w,
			cd_cgc_w,
			ds_razao_social_w,
			cd_cnes_w,
			dt_atendimento_w,
			ds_justificativa_w,
			ds_cid_w,
			ie_tipo_atend_tiss_w,
			ie_clinica_w,
			cd_usuario_convenio_w,
			nr_seq_tiss_tabela_w,
			vl_item_w;
		EXIT WHEN NOT FOUND; /* apply on c18 */

			select	max(tiss_obter_se_atend_rn(nr_atendimento_w))
			into STRICT	ie_atendimento_rn_w
			;

			qt_proc_guia_w 		:= qt_proc_guia_w + 1;

			if (qt_proc_guia_w = 1) then
				select	nextval('w_tiss_guia_seq')
				into STRICT	nr_seq_guia_w
				;

				if (coalesce(ie_data_ass_prest_w,'N') = 'S') then
					dt_assin_prest_w	:= dt_atendimento_w;

				elsif (coalesce(ie_data_ass_prest_w,'N') = 'N') then
					dt_assin_prest_w	:= clock_timestamp();
				elsif (coalesce(ie_data_ass_prest_w,'N') = 'V') then	
					dt_assin_prest_w	:= null;
				end if;

				insert	into w_tiss_guia(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					cd_ans,
					cd_autorizacao,
					dt_autorizacao,
					cd_senha,
					dt_validade_senha,
					dt_emissao_guia,
					nr_atendimento,
					ds_observacao,
					ie_tiss_tipo_guia,
					dt_entrada,
					cd_autorizacao_princ,
					DT_ASSIN_PREST,
					ie_atendimento_rn,
					ds_versao)
				values (nr_seq_guia_w,
					clock_timestamp(),
					nm_usuario_p,
					cd_ans_w,
					cd_autorizacao_w,
					null,
					cd_senha_w,
					dt_final_vigencia_w,
					clock_timestamp(),
					nr_atendimento_w,
					tiss_obter_regra_campo(4, 'DS_OBSERVACAO', CD_CONVENIO_W, ds_observacao_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, null, ie_tipo_atend_tiss_w||'#@'),
					'2',
					dt_atendimento_w,
					cd_autorizacao_princ_exame_w,
					DT_ASSIN_PREST_w,
					ie_atendimento_rn_w,
					ds_versao_w);

				select 	b.cd_pessoa_fisica,
					substr(obter_nome_pf_pj(b.cd_pessoa_fisica,null),1,255),
					null,
					c.ds_plano,
					a.dt_validade_carteira
				into STRICT	cd_pessoa_fisica_w,
					nm_pessoa_fisica_w,
					nr_cartao_nac_sus_w,
					ds_plano_w,
					dt_validade_carteira_W
				from	med_atendimento a,
					med_cliente b,
					med_plano c
				where	a.nr_seq_cliente	= b.nr_sequencia
				and	a.nr_Seq_plano		= c.nr_sequencia
				and	a.nr_atendimento	= nr_atendimento_w;

				insert	into w_tiss_beneficiario(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_guia,
					cd_pessoa_fisica,
					nm_pessoa_fisica,
					nr_cartao_nac_sus,
					ds_plano,
					dt_validade_carteira,
					cd_usuario_convenio)
				values (nextval('w_tiss_beneficiario_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w,
					cd_pessoa_fisica_w,
					nm_pessoa_fisica_w,
					null,
					ds_plano_w,
					dt_validade_carteira_w,
					cd_usuario_convenio_w);

				insert into w_tiss_contratado_solic(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_guia,
					cd_cgc,
					cd_interno,
					nr_cpf,
					nm_contratado,
					nm_solicitante,
					cd_cnes,
					sg_conselho,
					nr_crm,
					uf_crm,
					cd_cbo_saude)
				SELECT	nextval('w_tiss_contratado_solic_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w,
					substr(obter_dados_pf(cd_pessoa_fisica, 'CPF'), 1, 150),
					null,
					substr(obter_dados_pf(cd_pessoa_fisica, 'CPF'), 1, 150),
					obter_nome_medico(cd_pessoa_fisica,'N'),
					obter_nome_medico(cd_pessoa_fisica,'N'),
					cd_cnes_w,
					obter_Dados_medico(cd_pessoa_fisica, 'SGCRM'),
					obter_Dados_medico(cd_pessoa_fisica, 'CRM'),
					substr(obter_Dados_medico(cd_pessoa_fisica, 'UFCRM'),1,2),
					substr(obter_dados_pf(coalesce(cd_cbo_med_prest_w, cd_pessoa_fisica), 'CBOS'),1,20)
				from	medico
				where	cd_pessoa_fisica = cd_medico_w;

				cd_cgc_w	:= null;

				select	max(a.cd_cgc)
				into STRICT	cd_cgc_w
				from	terceiro a
				where	a.ie_situacao		= 'A'
				and	(a.cd_cgc IS NOT NULL AND a.cd_cgc::text <> '')
				and	coalesce(a.cd_pessoa_fisica::text, '') = ''
				and	ie_prest_spsadt_tasymed_w	= 'T'
				and	exists (	SELECT	1
						from	terceiro_pessoa_fisica b
						where	b.nr_seq_terceiro	= a.nr_sequencia
						and	b.cd_pessoa_fisica	= cd_medico_w);

				if (coalesce(cd_cgc_w::text, '') = '') then

					insert	into w_tiss_contratado_exec(nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							nr_seq_guia,
							cd_cgc,
							cd_interno,
							nr_cpf,
							nm_contratado,
							ds_tipo_logradouro,
							ds_logradouro,
							nm_municipio,
							sg_estado,
							cd_municipio_ibge,
							cd_cep,
							cd_cnes,
							nm_medico_executor,
							sg_conselho,
							nr_crm,
							uf_crm,
							cd_cbo_saude,
							ds_funcao_medico)
						SELECT	nextval('w_tiss_contratado_exec_seq'),
							clock_timestamp(),
							nm_usuario_p,
							nr_seq_guia_w,
							null,
							null,
							substr(obter_dados_pf(b.cd_pessoa_fisica, 'CPF'), 1, 150),
							substr(obter_nome_pf(b.cd_pessoa_fisica),1,100),
							'81' ds_tipo_logradouro,
							(obter_compl_pf(b.cd_pessoa_fisica, 1, 'EN') || ' ' || obter_compl_pf(b.cd_pessoa_fisica, 1, 'NR') || ' ' || obter_compl_pf(b.cd_pessoa_fisica, 1, 'CO')),
							obter_compl_pf(b.cd_pessoa_fisica, 1, 'CI'),
							obter_compl_pf(b.cd_pessoa_fisica, 1, 'UF'),
							substr(lpad(OBTER_MUNICIPIO_IBGE(somente_numero(obter_compl_pf(b.cd_pessoa_fisica, 1, 'CEP'))),7,'0'),1,25),
							lpad(to_char(somente_numero(obter_compl_pf(b.cd_pessoa_fisica, 1, 'CEP'))),8,'0'),
							null,
							obter_nome_medico(b.cd_pessoa_fisica, 'N'),
							obter_dados_medico(b.cd_pessoa_fisica, 'SGCRM'),
							obter_dados_medico(b.cd_pessoa_fisica, 'CRM'),
							substr(obter_dados_medico(b.cd_pessoa_fisica, 'UFCRM'),1,2),
							substr(obter_dados_pf(b.cd_pessoa_fisica, 'CBOS'),1,20),
							'00'
						from	medico b
						where	b.cd_pessoa_fisica = cd_medico_w;
				else
					insert	into w_tiss_contratado_exec(nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							nr_seq_guia,
							cd_cgc,
							cd_interno,
							nr_cpf,
							nm_contratado,
							ds_tipo_logradouro,
							ds_logradouro,
							nm_municipio,
							sg_estado,
							cd_municipio_ibge,
							cd_cep,
							cd_cnes,
							nm_medico_executor,
							sg_conselho,
							nr_crm,
							uf_crm,
							cd_cbo_saude,
							ds_funcao_medico)
						SELECT	nextval('w_tiss_contratado_exec_seq'),
							clock_timestamp(),
							nm_usuario_p,
							nr_seq_guia_w,
							cd_cgc_w,
							null,
							substr(obter_dados_pf(b.cd_pessoa_fisica, 'CPF'), 1, 150),
							substr(obter_nome_pf_pj(null,cd_cgc_w),1,100),
							'81' ds_tipo_logradouro,
							obter_dados_pf_pj(null,cd_cgc_w,'EC'),
							obter_dados_pf_pj(null,cd_cgc_w,'CI'),
							obter_dados_pf_pj(null,cd_cgc_w,'UF'),
							substr(lpad(somente_numero(obter_dados_pf_pj(null,cd_cgc_w,'CDM')),7,'0'),1,25),
							lpad(to_char(somente_numero(obter_dados_pf_pj(null,cd_cgc_w,'CEP'))),8,'0'),
							obter_dados_pf_pj(null,cd_cgc_w,'CNES'),
							obter_nome_medico(b.cd_pessoa_fisica, 'N'),
							obter_dados_medico(b.cd_pessoa_fisica, 'SGCRM'),
							obter_dados_medico(b.cd_pessoa_fisica, 'CRM'),
							substr(obter_dados_medico(b.cd_pessoa_fisica, 'UFCRM'),1,2),
							substr(obter_dados_pf(b.cd_pessoa_fisica, 'CBOS'),1,20),
							'00'
						from	medico b
						where	b.cd_pessoa_fisica = cd_medico_w;
				end if;

				if (ie_cid_exame_externo_w	= 'N') then
					select	max(cd_doenca),
						substr(max(ds_diagnostico),1,255)
					into STRICT	cd_doenca_cid_w,
						ds_observacao_w
					from	diagnostico_doenca a
					where	nr_atendimento		= nr_atendimento_w
					and	ie_classificacao_doenca = 'P';
				else
					cd_doenca_cid_w	:= ds_cid_w;
				end if;

				insert into w_tiss_solicitacao(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_guia,
					dt_solicitacao,
					ie_carater_solic,
					cd_cid,
					ds_indicacao)
				SELECT	nextval('w_tiss_solicitacao_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w,
					null,
					'U',
					tiss_obter_regra_campo(2, 'CD_DOENCA_CID', CD_CONVENIO_W, coalesce(cd_cid_externo_w, cd_doenca_cid_w), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, null, ie_tipo_atend_tiss_w||'#@'),
					coalesce(ds_justificativa_w, ds_observacao_w)
				;

				insert into w_tiss_dados_atendimento(nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						nr_seq_guia,
						ie_tipo_atendimento)
					values (nextval('w_tiss_dados_atendimento_seq'),
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_guia_w,
						ie_tipo_atend_tiss_w);
			end if;

			if (nr_seq_tiss_tabela_w IS NOT NULL AND nr_seq_tiss_tabela_w::text <> '') then
				select	coalesce(max(cd_tabela_xml), '00')
				into STRICT	cd_edicao_amb_w
				from	tiss_tipo_tabela
				where	nr_sequencia		= nr_seq_tiss_tabela_w;
			end if;

			nr_seq_apresentacao_w	:= nr_seq_apresentacao_w + 1;

			insert	into w_tiss_proc_paciente(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nr_seq_guia,
				cd_procedimento,
				cd_edicao_amb,
				qt_procedimento,
				vl_reducao_acrescimo,
				vl_procedimento,
				dt_entrada,
				dt_alta,
				vl_unitario,
				ds_procedimento,
				dt_procedimento,
				nr_seq_apresentacao,
				ie_tecnica_utilizada,
				ie_via_acesso,
				dt_inicio_cirurgia,
				dt_fim_cirurgia)
			values (nextval('w_tiss_proc_paciente_seq'),
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_guia_w,
				cd_procedimento_w,
				cd_edicao_amb_w,
				qt_autorizada_w,
				null,
				(qt_autorizada_w * vl_item_w),
				dt_entrada_w,
				dt_alta_w,
				vl_item_w,
				ds_procedimento_w,
				dt_atendimento_w,
				nr_seq_apresentacao_w,
				ie_tecnica_utilizada_w,
				ie_via_acesso_w,
				dt_atendimento_w,
				dt_atendimento_w);

			if (qt_proc_guia_w = 5) then
				nr_seq_apresentacao_w		:= 0;
				qt_proc_guia_w			:= 0;
				CALL TISS_GERAR_OPM_EXEC(nr_seq_conta_guia_w, nr_seq_guia_w, nm_usuario_p);
				CALL TISS_COMPLETAR_GUIA(nr_seq_guia_w, nm_usuario_p);

			end if;
		end loop;
		close c18;

		select	sum(vl_procedimento),
			sum(vl_procedimento)
		into STRICT	vl_total_procedimentos_w,
			vl_total_geral_w
		from	w_tiss_proc_paciente
		where	nr_seq_guia	= nr_seq_guia_w;

		insert	into w_tiss_totais(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nr_seq_guia,
			vl_procedimentos,
			vl_total_geral)
		values (nextval('w_tiss_totais_seq'),
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_guia_w,
			vl_total_procedimentos_w,
			vl_total_geral_w);

		if (qt_proc_guia_w > 0) and (qt_proc_guia_w < 5) then
			CALL TISS_GERAR_OPM_EXEC(nr_seq_conta_guia_w, nr_seq_guia_w, nm_usuario_p);
			CALL TISS_COMPLETAR_GUIA(nr_seq_guia_w, nm_usuario_p);
		end if;
	--end if;
elsif (coalesce(nr_prescricoes_p,'X') <> 'X') then

	if (position(',' in nr_prescricoes_p)	>0)  then
		nr_prescr_w		:= somente_numero(substr(nr_prescricoes_p,1,position(',' in nr_prescricoes_p) ));
	else
		nr_prescr_w		:= somente_numero(nr_prescricoes_p);
	end if;

	select	max(a.nr_atendimento)
	into STRICT	nr_atendimento_w
	from	prescr_medica a
	where	a.nr_prescricao	= nr_prescr_w;

	select	max(a.cd_senha),
		max(a.dt_inicio_vigencia),
		max(a.dt_final_vigencia),
		max(b.dt_entrada),
		max(b.ie_tipo_atendimento),
		max(a.cd_categoria),
		max(ie_clinica),
		max(coalesce(a.nr_doc_conv_principal,a.nr_doc_convenio)),
		max(b.ie_tipo_atend_tiss),
		max(b.cd_estabelecimento),
		max(a.cd_convenio),
		max(b.nr_seq_classificacao),
		max(obter_setor_atendimento(b.nr_atendimento)),
		max(CASE WHEN b.ie_carater_inter_sus='1' THEN  'E'  ELSE 'U' END ),
		max(tiss_obter_se_atend_rn(a.nr_atendimento)),
		max(a.cd_plano_convenio),
		max(b.cd_procedencia)
	into STRICT	cd_senha_w,
		dt_inicio_vigencia_w,
		dt_final_vigencia_w,
		dt_atendimento_w,
		ie_tipo_atendimento_w,
		cd_categoria_conv_w,
		ie_clinica_w,
		cd_autor_princ_w,
		ie_tipo_atend_tiss_w,
		cd_estabelecimento_w,
		cd_convenio_w,
		nr_seq_classif_atend_w,
		cd_setor_entrada_w,
		ie_carater_inter_sus_w,
		ie_atendimento_rn_w,
		cd_plano_convenio_w,
		cd_procedencia_w
	from	atend_categoria_convenio a,
		atendimento_paciente b
	where	obter_atecaco_atendimento(b.nr_atendimento) 	= a.nr_seq_interno
	and	a.nr_atendimento				= b.nr_atendimento
	and	a.nr_atendimento				= nr_atendimento_w;

	select	coalesce(max(ie_prescr_unica),'N'),
		coalesce(max(ie_quebra_proc_pep), 'N'),
		coalesce(max(ie_gerar_tiss), 'S'),
		coalesce(max(ie_spsadt_atend_retorno),'S'),
		coalesce(max(ie_ultima_prescricao),'N'),
		max(ds_arquivo_logo_comp),
		coalesce(max(ie_spsadt_zerado),'S'),
		coalesce(max(ie_medico_rep),'P'),
		coalesce(max(ie_desc_proc_interno),'P'),
		coalesce(max(ie_obs_urgente), 'N'),
		coalesce(max(ie_lado_rep),'N'),
		coalesce(max(ie_solicitante),'H'),
		coalesce(max(ie_proc_tuss),'N'),
		coalesce(max(ie_topo_rep),'N'),
		coalesce(max(ie_quebra_horarios_prescr),'N'),
		coalesce(max(ie_emitir_hemocomponente),'N')
	into STRICT	ie_prescr_unica_w,
		ie_quebra_proc_pep_w,
		ie_gerar_tiss_w,
		ie_spsadt_atend_retorno_w,
		ie_ultima_prescricao_w,
		ds_arquivo_logo_comp_w,
		ie_spsadt_zerado_w,
		ie_medico_rep_w,
		ie_desc_proc_interno_w,
		ie_obs_urgente_w,
		ie_lado_rep_w,
		ie_solicitante_w,
		ie_proc_tuss_w,
		ie_topo_rep_w,
		ie_quebra_horarios_prescr_w,
		ie_emitir_hemocomponente_w
	from	TISS_PARAMETROS_CONVENIO
	where	cd_estabelecimento			= cd_estabelecimento_w
	and	cd_convenio				= cd_convenio_w;

	select	tiss_obter_versao(cd_convenio_w,cd_estabelecimento_w)
	into STRICT	ds_versao_w
	;

	if (ie_ultima_prescricao_w = 'N') then
		ie_ultima_prescricao_w	:= coalesce(ie_ultima_prescricao_p,'N');
	end if;

	select	max(cd_ans),
		max(b.ds_arquivo_logo_tiss),
		max(b.cd_convenio),
		max(t.nr_doc_convenio)
	into STRICT	cd_ans_w,
		ds_arquivo_logo_w,
		cd_convenio_w,
		cd_autorizacao_w
	from	pessoa_juridica c,
		convenio b,
		atend_categoria_convenio t
	where	t.cd_convenio				= b.cd_convenio
	and	b.cd_cgc					= c.cd_cgc
	and	t.nr_atendimento				= nr_atendimento_w
	and	obter_atecaco_atendimento(t.nr_atendimento) 	= t.nr_seq_interno;

	if (coalesce(ie_gerar_tiss_w,'S')= 'S') and
		((coalesce(ie_spsadt_atend_retorno_w,'S') = 'S') or (obter_se_atend_retorno(nr_atendimento_w) = 'N'))then

		 begin
			select	im_logo_convenio
			into STRICT	im_logo_convenio_w
			from	tiss_logo_convenio
			where	cd_convenio	   = cd_convenio_w
			and 	coalesce(ie_situacao,'N') = 'A';
		exception
		when others then
			im_logo_convenio_w := null;
		end;

		if (coalesce(im_logo_convenio_w::text, '') = '') and (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') then
			ds_arquivo_logo_w := tiss_diretorio_logo(ds_arquivo_logo_comp_w, ds_dir_padrao_p) || ds_arquivo_logo_w;
		end if;

		if (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') and (coalesce(im_logo_convenio_w::text, '') = '') then

			insert	into w_tiss_relatorio(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_arquivo_logo,
				im_logo_convenio)
			values (nextval('w_tiss_relatorio_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				ds_arquivo_logo_w,
				null);
		else
			insert	into w_tiss_relatorio(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_arquivo_logo,
				im_logo_convenio)
			values (nextval('w_tiss_relatorio_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				null,
				im_logo_convenio_w);
		end if;

		nr_prescricoes_w	:= nr_prescricoes_p;

		/*Substituido pelo c23, pois o obter_se_contido fica lento demais*/

		while(length(nr_prescricoes_w) > 0) loop
			begin

			if (ie_ultima_prescricao_w = 'N') then
				if (position(',' in nr_prescricoes_w)	>0)  then
					nr_prescricao_w		:= somente_numero(substr(nr_prescricoes_w,1,position(',' in nr_prescricoes_w) ));
					nr_prescricoes_w	:= substr(nr_prescricoes_w,position(',' in nr_prescricoes_w)+1,40000);
				else
					nr_prescricao_w		:= somente_numero(nr_prescricoes_w);
					nr_prescricoes_w	:= null;
				end if;
			else
				nr_prescricao_w		:= PLT_Obter_Max_Nr_Prescricao(nr_prescricoes_w);
				nr_prescricoes_w	:= null;
			end if;

			if (ie_quebra_horarios_prescr_w = 'S') then
				CALL TISS_GERAR_W_HORARIOS_PRESCR(nr_prescricao_w,nm_usuario_p);
			end if;

			open C35;
			loop
			fetch C35 into
				ds_horario_w;
			EXIT WHEN NOT FOUND; /* apply on C35 */

				open c19;
				loop
				fetch c19 into
					cd_setor_atendimento_w,
					cd_autorizacao_ww,
					ds_inicacao_clinica_w;
				EXIT WHEN NOT FOUND; /* apply on c19 */

					open c21;
					loop
					fetch c21 into
						cd_tipo_proc_w;
					EXIT WHEN NOT FOUND; /* apply on c21 */

						qt_proc_guia_w 		:= 0;
						nr_seq_apresentacao_w	:= 0;

						qt_vias_w		:= 0;

						open c20;
						loop
						fetch c20 into
							cd_edicao_amb_w,
							cd_procedimento_w,
							ds_procedimento_w,
							qt_solicitada_w,
							qt_autorizada_w,
							dt_autorizacao_w,
							ds_observacao_w,
							ie_origem_proced_w,
							cd_estabelecimento_w,
							cd_convenio_w,
							ds_proc_tabela_interno_w,
							ds_proc_exame_proc_w,
							ds_proc_procedimento_w,
							ie_urgencia_w,
							DT_PREV_EXECUCAO_w,
							ie_lado_w,
							nr_seq_proc_interno_w,
							nr_seq_pedido_exame_prescr_w,
							ds_topogradia_w,
							nr_seq_proc_prescr_w,
							ds_observacao_proc_prescr_w,
							qt_vias_proc_w;
						EXIT WHEN NOT FOUND; /* apply on c20 */

							select	CD_PROCEDIMENTO,
								IE_ORIGEM_PROCED,
								CD_GRUPO_PROC,
								CD_ESPECIALIDADE,
								CD_AREA_PROCEDIMENTO
							into STRICT	CD_PROCEDIMENTO_w,
								IE_ORIGEM_PROCED_w,
								CD_GRUPO_PROC_w,
								CD_ESPECIALIDADE_w,
								CD_AREA_PROCEDIMENTO_w
							from	estrutura_procedimento_v
							where	cd_procedimento		= cd_procedimento_w
							and	ie_origem_proced	= ie_origem_proced_w;

							/*select	max(cd_convenio)
							into	cd_convenio_w
							from	atend_categoria_convenio
							where	nr_atendimento		= obter_atendimento_prescr(nr_prescricao_w);*/
							select 	(max(obter_setor_prescricao(nr_prescricao_w,'C')))::numeric
							into STRICT 	cd_setor_prescr_w
							;

							IE_REGRA_W := TISS_OBTER_REGRA_PROC_PRESCR(	CD_AREA_PROCEDIMENTO_w, CD_ESPECIALIDADE_w, CD_GRUPO_PROC_w, CD_PROCEDIMENTO_w, IE_ORIGEM_PROCED_w, cd_estabelecimento_w, IE_REGRA_W, cd_convenio_w, ie_tipo_atendimento_w, cd_setor_prescr_w, nr_seq_proc_interno_w);

							/*select	nvl(max(ie_spsadt_zerado),'S'),
								nvl(max(ie_medico_rep),'P'),
								nvl(max(ie_desc_proc_interno),'P'),
								nvl(max(ie_obs_urgente), 'N'),
								nvl(max(ie_lado_rep),'N'),
								nvl(max(ie_solicitante),'H'),
								nvl(max(ie_proc_tuss),'N'),
								nvl(max(ie_topo_rep),'N')
							into	ie_spsadt_zerado_w,
								ie_medico_rep_w,
								ie_desc_proc_interno_w,
								ie_obs_urgente_w,
								ie_lado_rep_w,
								ie_solicitante_w,
								ie_proc_tuss_w,
								ie_topo_rep_w
							from	TISS_PARAMETROS_CONVENIO
							where	cd_estabelecimento	= cd_estabelecimento_w
							and	cd_convenio		= cd_convenio_w;*/
							if (ie_obs_urgente_w = 'S') and (ie_urgencia_w = 'S') then
								ds_observacao_w	:= substr(ds_dt_prevista_exec_w||': ' || to_char(DT_PREV_EXECUCAO_w, 'dd/mm/yyyy hh24:mi') || chr(13) || ds_observacao_w,1,255);
							end if;

							ds_proc_tuss_w 		:= null;
							ds_proced_convenio_w	:= null;

							if (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') then
								select 	max(cd_procedimento_tuss)
								into STRICT 	cd_proc_tuss_w
								from 	proc_interno
								where	nr_sequencia	= nr_seq_proc_interno_w;

								if (coalesce(cd_proc_tuss_w,0) > 0) then
									ds_proc_tuss_w	:= Obter_Descricao_Procedimento(cd_proc_tuss_w,8);
								end if;
							elsif (nr_seq_pedido_exame_prescr_w IS NOT NULL AND nr_seq_pedido_exame_prescr_w::text <> '') then
								select 	max(cd_procedimento_tuss)
								into STRICT 	cd_proc_tuss_w
								from 	exame_laboratorio
								where	nr_seq_exame	= nr_seq_pedido_exame_prescr_w;

								if (coalesce(cd_proc_tuss_w,0) > 0) then
									ds_proc_tuss_w	:= Obter_Descricao_Procedimento(cd_proc_tuss_w,8);
								end if;
							end if;

							--lhalves OS275759 em 19/01/11 - tratar conversao.

							/*select 	max(TISS_Obter_Proced_Conversao(cd_convenio_w, cd_procedimento_w, ie_origem_proced_w, 'D'))
							into	ds_proced_convenio_w
							from 	dual;
							Ronaldo
							*/
							select	max(b.ie_sexo)
							into STRICT	ie_sexo_w
							from	atendimento_paciente a,
								pessoa_fisica b
							where	a.cd_pessoa_fisica = b.cd_pessoa_fisica
							and	a.nr_atendimento = nr_atendimento_w;

							ds_proced_convenio_w		:= null;
							nr_seq_conversao_w		:= null;
							cd_proced_conversao_w		:= null;
							cd_grupo_proc_conversao_w	:= null;

							SELECT * FROM converte_proc_convenio(	cd_estabelecimento_w, cd_convenio_w, null, cd_procedimento_w, ie_origem_proced_w, null, null, ie_tipo_atendimento_w, clock_timestamp(), cd_proced_conversao_w, cd_grupo_proc_conversao_w, nr_seq_conversao_w, cd_setor_atendimento_w, null, nr_seq_proc_interno_w, 'A', null, ie_clinica_w, 0, null, null, null, ie_sexo_w, null, null, 0, null, null, null) INTO STRICT cd_proced_conversao_w, cd_grupo_proc_conversao_w, nr_seq_conversao_w;

							select	substr(max(ds_proc_convenio),1,255)
							into STRICT	ds_proced_convenio_w
							from	conversao_proc_convenio
							where	cd_convenio	= cd_convenio_w
							and	nr_sequencia 	= nr_seq_conversao_w;


							if (ie_desc_proc_interno_w = 'S') then
								ds_procedimento_w := substr(coalesce(ds_proc_tabela_interno_w, ds_procedimento_w),1,255);
							elsif (ie_desc_proc_interno_w = 'P') then
								ds_procedimento_w := substr(coalesce(ds_proced_convenio_w,coalesce(ds_proc_exame_proc_w, ds_procedimento_w)),1,255);
							elsif (ie_desc_proc_interno_w = 'N') then
								ds_procedimento_w := substr(coalesce(ds_proced_convenio_w,coalesce(ds_procedimento_w,ds_proc_procedimento_w)),1,255);
							elsif (ie_desc_proc_interno_w = 'T') then
								ds_procedimento_w := substr(coalesce(ds_proc_tuss_w,ds_procedimento_w),1,255);
							end if;

							if (coalesce(IE_REGRA_W, 'S') = 'S') then

								qt_proc_guia_w		:= qt_proc_guia_w + 1;

								if (qt_vias_proc_w > qt_vias_w) then
									qt_vias_w	:= qt_vias_proc_w;
								end if;

								if (qt_proc_guia_w = 1) then

									select	nextval('w_tiss_guia_seq')
									into STRICT	nr_seq_guia_w
									;

									ds_observacao_guia_w	:= null;

									if (coalesce(ie_data_ass_prest_w,'N') = 'S') then
										dt_assin_prest_w	:= dt_atendimento_w;

									elsif (coalesce(ie_data_ass_prest_w,'N') = 'N') then
										dt_assin_prest_w	:= clock_timestamp();
									elsif (coalesce(ie_data_ass_prest_w,'N') = 'V') then
										dt_assin_prest_w	:= null;
									end if;

									/*lhalves OS 226155 em 25/06/2010 - Considerar regra guia princ, ao emitir a guia pelo REP*/

									ie_regra_guia_princ_w	:= null;
									open c16;
									loop
									fetch c16 into
										ie_regra_guia_princ_w;
									EXIT WHEN NOT FOUND; /* apply on c16 */
									end loop;
									close c16;

									if (ie_regra_guia_princ_w = 'AG') then
										if (cd_autor_princ_w IS NOT NULL AND cd_autor_princ_w::text <> '') then
											cd_autor_princ_prescr_w := cd_autor_princ_w;
										else
											select 	CASE WHEN cd_autorizacao_ww='X' THEN  cd_autorizacao_w  ELSE cd_autorizacao_ww END
											into STRICT	cd_autor_princ_prescr_w
											;
										end if;
									elsif (ie_regra_guia_princ_w in ('GP','A')) then
										cd_autor_princ_prescr_w := cd_autor_princ_w;
									elsif (ie_regra_guia_princ_w = 'S') then
										cd_autor_princ_prescr_w	:= cd_senha_w;
									elsif (ie_regra_guia_princ_w = 'AS') then
										cd_autor_princ_prescr_w := cd_autor_princ_w || cd_senha_w;
									elsif (ie_regra_guia_princ_w = 'G') then
										select 	CASE WHEN cd_autorizacao_ww='X' THEN  cd_autorizacao_w  ELSE cd_autorizacao_ww END
										into STRICT	cd_autor_princ_prescr_w
										;
									elsif (ie_regra_guia_princ_w = 'N') then
										cd_autor_princ_prescr_w := null;
									end if;

									insert	into w_tiss_guia(nr_sequencia,
										dt_atualizacao,
										nm_usuario,
										cd_ans,
										cd_autorizacao,
										cd_autorizacao_princ,
										dt_autorizacao,
										cd_senha,
										dt_validade_senha,
										dt_emissao_guia,
										nr_interno_conta,
										nr_seq_protocolo,
										nr_sequencia_autor,
										ds_observacao,
										ie_tiss_tipo_guia,
										dt_entrada,
										nr_atendimento,
										DT_ASSIN_PREST,
										dt_assin_solic,
										ie_atendimento_rn,
										ds_versao)
									values (nr_seq_guia_w,
										clock_timestamp(),
										nm_usuario_p,
										cd_ans_w,
										tiss_obter_regra_campo(2, 'CD_AUTORIZACAO', CD_CONVENIO_W, CASE WHEN cd_autorizacao_ww='X' THEN  cd_autorizacao_w  ELSE cd_autorizacao_ww END , ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
										cd_autor_princ_prescr_w,
										tiss_obter_regra_campo(2, 'DT_AUTORIZACAO', CD_CONVENIO_W, dt_inicio_vigencia_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
										tiss_obter_regra_campo(2, 'CD_SENHA', CD_CONVENIO_W, cd_senha_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
										dt_final_vigencia_w,
										clock_timestamp(),
										null,
										null,
										null,
										coalesce(tiss_obter_regra_campo(4, 'DS_OBSERVACAO', CD_CONVENIO_W, ds_observacao_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'), ds_observacao_w),
										'2',
										tiss_obter_regra_campo(2, 'DT_ASSINATURA_RESP', CD_CONVENIO_W, dt_atendimento_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
										nr_atendimento_w,
										tiss_obter_regra_campo(2, 'DS_ASSINATURA_EXEC', CD_CONVENIO_W, DT_ASSIN_PREST_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
										tiss_obter_regra_campo(2, 'DS_ASSINATURA_SOLIC', CD_CONVENIO_W, dt_autorizacao_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
										ie_atendimento_rn_w,
										ds_versao_w);

									/*lhalves OS305885 em 30/03/2011 - substituido a view pelo select - Performance*/

									insert	into w_tiss_beneficiario(nr_sequencia,
										dt_atualizacao,
										nm_usuario,
										nr_seq_guia,
										cd_pessoa_fisica,
										nm_pessoa_fisica,
										nr_cartao_nac_sus,
										ds_plano,
										dt_validade_carteira,
										cd_usuario_convenio)
									SELECT	nextval('w_tiss_beneficiario_seq'),
										clock_timestamp(),
										nm_usuario_p,
										nr_seq_guia_w,
										c.cd_pessoa_fisica,
										substr(TISS_OBTER_TITULAR_CONV_RN(nr_atendimento_w, null, cd_convenio_w, cd_estabelecimento_w),1,150),
										c.nr_cartao_nac_sus,
										substr(obter_desc_plano(b.cd_convenio, b.cd_plano_convenio),1,40),
										b.dt_validade_carteira,
										b.cd_usuario_convenio
									from	pessoa_fisica c,
										atend_categoria_convenio b,
										atendimento_paciente a
									where	b.nr_seq_interno	= obter_atecaco_atendimento(b.nr_atendimento)
									and	a.nr_atendimento	= b.nr_atendimento
									and	a.cd_pessoa_fisica	= c.cd_pessoa_fisica
									and	a.nr_atendimento	= nr_atendimento_w;

									/*inicio lhalves OS213180 em 07/05/2010 - gravar o tipo atend tiss conforme regras */

									select	max(coalesce(ie_tipo_atend_tiss,'0'))
									into STRICT 	ie_tipo_atend_tiss_w
									from	tiss_tipo_atendimento
									where	cd_estabelecimento						= cd_estabelecimento_w
									and	coalesce(ie_tipo_atendimento,coalesce(ie_tipo_atendimento_w,0))		= coalesce(ie_tipo_atendimento_w,0)
									and	coalesce(ie_clinica, coalesce(ie_clinica_w,0))				= coalesce(ie_clinica_w,0)
									and	coalesce(cd_setor_entrada, Obter_Setor_Atendimento(obter_atendimento_prescr(nr_prescricao_w)))	= Obter_Setor_Atendimento(obter_atendimento_prescr(nr_prescricao_w))
									and	coalesce(cd_convenio, cd_convenio_w)					= cd_convenio_w
									and	coalesce(cd_procedencia, cd_procedencia_w)				= cd_procedencia_w
									order by
										coalesce(ie_tipo_atendimento,0),
										coalesce(ie_clinica,0),
										coalesce(cd_setor_entrada,0),
										coalesce(cd_convenio,0),
										coalesce(cd_procedencia,0);

									insert into w_tiss_dados_atendimento(nr_sequencia,
										dt_atualizacao,
										nm_usuario,
										nr_seq_guia,
										ie_tipo_atendimento)
									values (nextval('w_tiss_dados_atendimento_seq'),
										clock_timestamp(),
										nm_usuario_p,
										nr_seq_guia_w,
										ie_tipo_atend_tiss_w);
									/*Fim lhalves OS 213180*/

									select	max(obter_nome_medico(cd_medico,'N')),
										substr(max(obter_dados_medico(cd_medico, 'UFCRM')),1,2),
										max(obter_dados_medico(cd_medico, 'SGCRM')),
										max(obter_dados_medico(cd_medico, 'CRM')),
										max(obter_dados_pf(cd_medico, 'CPF')),
										max(substr(obter_nome_pf_pj(null, cd_cgc_solic),1,254)),
										max(cd_cgc_solic),
										max(cd_medico),
										max(cd_medico)
									into STRICT	nm_medico_solic_w,
										uf_crm_w,
										sg_conselho_w,
										nr_crm_w,
										nr_cpf_w,
										nm_contratado_solic_w,
										cd_interno_solic_w,
										cd_medico_solic_w,
										cd_medico_prescr_w
									from	prescr_medica
									where	nr_prescricao	= nr_prescricao_w;

									select TISS_OBTER_CBO_MEDICO(cd_medico_prescr_w)
									into STRICT cd_cbo_med_prest_w
									;

									if (ie_medico_rep_w	= 'A') then
										select	coalesce(max(obter_nome_medico(b.cd_medico_anterior, 'N')), nm_medico_solic_w),
											substr(coalesce(max(obter_dados_medico(b.cd_medico_anterior, 'UFCRM')), uf_crm_w),1,2),
											coalesce(max(obter_dados_medico(b.cd_medico_anterior, 'SGCRM')), sg_conselho_w),
											coalesce(max(obter_dados_medico(b.cd_medico_anterior, 'CRM')), nr_crm_w),
											coalesce(max(obter_dados_pf(b.cd_medico_anterior, 'CPF')), nr_cpf_w)
										into STRICT	nm_medico_solic_w,
											uf_crm_w,
											sg_conselho_w,
											nr_crm_w,
											nr_cpf_w
										from	atendimento_troca_medico b,
											atendimento_paciente a
										where	a.nr_atendimento	= b.nr_atendimento
										and	a.nr_atendimento	= nr_atendimento_w
										and	b.dt_troca = (	SELECT	min(x.dt_troca)
													from	atendimento_troca_medico x
													where	x.nr_atendimento = a.nr_atendimento);
									end if;

									select	coalesce(max(obter_se_medico_conveniado(cd_estabelecimento_w, cd_medico_solic_w, cd_convenio_w, null, null, null, cd_setor_atendimento_w,null,null, null, null)), 'N')
									into STRICT	ie_conveniado_w
									;

									ie_solicitante_ww	:= null;

									if (ie_solicitante_w	= 'R') then

										select	max(d.ie_tipo_atendimento),
											max(d.ie_clinica),
											--max(d.cd_procedencia),
											max(d.cd_medico_referido),
											max(coalesce(cd_medico_atendimento, cd_medico_resp)),
											max(obter_setor_atendimento(nr_atendimento))
										into STRICT	ie_tipo_atendimento_w,
											ie_clinica_w,
											--cd_procedencia_w,
											cd_medico_referido_w,
											cd_medico_atendimento_w,
											cd_setor_entrada_w
										from	atendimento_paciente d
										where	nr_atendimento	= nr_atendimento_w;

										/*select	max(nvl(cd_medico_atendimento, cd_medico_resp))
										into	cd_medico_atendimento_w
										from	atendimento_paciente
										where	nr_atendimento	= nr_atendimento_w;

										select	max(obter_setor_atendimento(obter_atendimento_prescr(nr_prescricao_w)))
										into	cd_setor_entrada_w
										from	dual;*/
										SELECT * FROM tiss_obter_regra_prest_solic(cd_convenio_w, cd_estabelecimento_w, cd_setor_prescr_w, ie_clinica_w, cd_procedencia_w, ie_tipo_atendimento_w, 'N', ie_solicitante_w, cd_cgc_prest_solic_regra_w, cd_medico_atendimento_w, cd_medico_solic_w, cd_prestador_solic_tiss_w, ds_prestador_solic_tiss_w, cd_medico_referido_w, cd_categoria_conv_w, clock_timestamp(), null, cd_medico_prescr_w, cd_plano_convenio_w, nr_seq_regra_solic_w) INTO STRICT ie_solicitante_w, cd_cgc_prest_solic_regra_w, cd_medico_solic_w, cd_prestador_solic_tiss_w, ds_prestador_solic_tiss_w, nr_seq_regra_solic_w;
									end if;

									if (ie_solicitante_w	= 'M') or (ie_solicitante_w	= 'MC' AND ie_conveniado_w	= 'S') then
										ie_solicitante_ww		:= ie_solicitante_w;
										nm_contratado_solic_w		:= nm_medico_solic_w;
										cd_interno_solic_w		:= tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_solic_w, null, cd_setor_prescr_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w);
									elsif (ie_solicitante_w	= 'I') then
										if (coalesce(cd_medico_solic_w::text, '') = '') then
											ie_solicitante_ww		:= ie_solicitante_w;
											select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prest_solic_regra_w, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
												max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_prest_solic_regra_w, cd_setor_entrada_w, 'CGC',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
											into STRICT	cd_interno_solic_w,
												cd_cgc_solic_w
											;

											select	max(ds_razao_social),
												max(cd_cnes)
											into STRICT	nm_contratado_solic_w,
												cd_cnes_solic_w
											from	pessoa_juridica
											where	cd_cgc		= cd_cgc_prest_solic_regra_w;
										else
											ie_solicitante_ww		:= ie_solicitante_w;
											select	max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_solic_w, null, cd_setor_entrada_w, 'CI',null,ie_tipo_atendimento_w,cd_categoria_conv_w)),
												max(tiss_obter_codigo_prestador(cd_convenio_w, cd_estabelecimento_w, cd_medico_solic_w, null, cd_setor_entrada_w, 'CPF',null,ie_tipo_atendimento_w,cd_categoria_conv_w))
											into STRICT	cd_interno_solic_w,
												nr_cpf_solic_w
											;

											select	max(nm_pessoa_fisica),
												max(cd_cnes)
											into STRICT	nm_contratado_solic_w,
												cd_cnes_solic_w
											from	pessoa_fisica
											where	cd_pessoa_fisica	= cd_medico_solic_w;

										end if;

										if (coalesce(ds_prestador_solic_tiss_w,'X') <> 'X') then
											nm_contratado_solic_w	:= ds_prestador_solic_tiss_w;
										end if;

										if (coalesce(cd_prestador_solic_tiss_w,'X') <> 'X') then
											cd_interno_solic_w	:= cd_prestador_solic_tiss_w;
										end if;
									end if;

									/*lhalves OS305885 em 30/03/2011 - substituido a view pelo select - Performance*/

									insert into w_tiss_contratado_solic(nr_sequencia,
										dt_atualizacao,
										nm_usuario,
										nr_seq_guia,
										cd_cgc,
										cd_interno,
										nr_cpf,
										nm_contratado,
										nm_solicitante,
										cd_cnes,
										sg_conselho,
										nr_crm,
										uf_crm,
										cd_cbo_saude)
									SELECT	nextval('w_tiss_contratado_solic_seq'),
										clock_timestamp(),
										nm_usuario_p,
										nr_seq_guia_w,
										CASE WHEN coalesce(ie_solicitante_ww,'H')='H' THEN  f.cd_cgc  ELSE cd_cgc_solic_w END ,
										CASE WHEN coalesce(ie_solicitante_ww,'H')='H' THEN  obter_valor_conv_estab(g.cd_convenio, f.cd_estabelecimento, 'CD_INTERNO')  ELSE cd_interno_solic_w END ,
										coalesce(nr_cpf_solic_w, nr_cpf_w),
										coalesce(nm_contratado_solic_w, substr(tiss_eliminar_caractere(h.ds_razao_social),1,100)),
										tiss_obter_regra_campo(2, 'NM_SOLICITANTE', CD_CONVENIO_W, nm_medico_solic_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
										tiss_obter_regra_campo(2, 'CD_CNES', CD_CONVENIO_W, coalesce(cd_cnes_solic_w, coalesce(f.cd_cns, h.cd_cnes)), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),										
										tiss_obter_regra_campo(2, 'SG_CONSELHO', CD_CONVENIO_W, sg_conselho_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
										substr(tiss_obter_regra_campo(2, 'NR_CRM', CD_CONVENIO_W, nr_crm_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),1,20),
										tiss_obter_regra_campo(2, 'UF_CRM', CD_CONVENIO_W, uf_crm_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
										tiss_obter_regra_campo(2, 'CD_CBO_SAUDE', CD_CONVENIO_W, coalesce(cd_cbo_med_prest_w, coalesce(tiss_obter_cbos_medico(i.cd_pessoa_fisica,obter_especialidade_medico(i.cd_pessoa_fisica,'c'),ds_versao_w,cd_convenio_w),k.cd_cbo)), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@')
                                    					FROM pessoa_juridica h, convenio g, estabelecimento f, atend_categoria_convenio c, pessoa_fisica i
LEFT OUTER JOIN cbo_saude k ON (i.nr_seq_cbo_saude = k.nr_sequencia)
, atendimento_paciente a
LEFT OUTER JOIN medico b ON (a.cd_medico_resp = b.cd_pessoa_fisica)
WHERE a.nr_atendimento			= c.nr_atendimento and obter_atecaco_atendimento(a.nr_atendimento) = c.nr_seq_interno  and a.cd_estabelecimento 			= f.cd_estabelecimento and c.cd_convenio				= g.cd_convenio and f.cd_cgc				= h.cd_cgc and b.cd_pessoa_fisica			= i.cd_pessoa_fisica  and a.nr_atendimento			= nr_atendimento_w;

									/*lhalves OS325908 em 21/06/2011 - Alterado o select da view pelo propio select - Performance*/

									SELECT	max(a.cd_doenca) cd_doenca_cid,
										substr(max(a.ds_diagnostico),2,255)
									into STRICT	cd_doenca_cid_w,
										ds_observacao_w
									FROM 	diagnostico_doenca a,
										diagnostico_medico c,
										atendimento_paciente e
									WHERE	c.nr_atendimento		= a.nr_atendimento
									AND	c.dt_diagnostico		= a.dt_diagnostico
									and	c.nr_atendimento		= e.nr_atendimento
									and	a.nr_atendimento		= e.nr_atendimento
									AND	a.ie_classificacao_doenca	= 'P'
									and	e.nr_atendimento		= nr_atendimento_w
									AND	c.dt_diagnostico		=
													(SELECT	MAX(x.dt_diagnostico)
													FROM	diagnostico_doenca y,
														diagnostico_medico x
													WHERE	x.nr_atendimento	= e.nr_atendimento
													AND	x.nr_atendimento	= y.nr_atendimento
													AND	x.dt_diagnostico	= y.dt_diagnostico
													AND	y.ie_classificacao_doenca	= 'P');

									Select 	max(a.CD_DOENCA_CID)
									into STRICT	cd_cid_proc_presc_w
									from	prescr_procedimento_cid a
									where	a.nr_prescricao 	= nr_prescricao_w;

									/*select	max(decode(ie_carater_inter_sus, '1', 'E', 'U'))
									into	ie_carater_inter_sus_w
									from	atendimento_paciente a
									where	a.nr_atendimento	= obter_atendimento_prescr(nr_prescricao_w);*/
									if (ie_quebra_horarios_prescr_w = 'S') and (ds_horario_w <> '-1') then

										select	coalesce(max(TISS_OBTER_HORARIO_PROC_PRESC(nr_prescricao_w,nr_seq_proc_prescr_w,ds_horario_w)),dt_autorizacao_w)
										into STRICT	dt_autorizacao_w
										;
									end if;

									insert into w_tiss_solicitacao(nr_sequencia,
										dt_atualizacao,
										nm_usuario,
										nr_seq_guia,
										dt_solicitacao,
										ie_carater_solic,
										cd_cid,
										ds_indicacao)
									values (nextval('w_tiss_solicitacao_seq'),
										clock_timestamp(),
										nm_usuario_p,
										nr_seq_guia_w,
										to_date(tiss_obter_regra_campo(2, 'DT_SOLICITACAO', CD_CONVENIO_W, to_char(dt_autorizacao_w, 'dd/mm/yyyy hh24:mi:ss'), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'), 'dd/mm/yyyy hh24:mi:ss'),
										ie_carater_inter_sus_w,
										coalesce(tiss_obter_regra_campo(2, 'CD_DOENCA_CID', CD_CONVENIO_W, coalesce(cd_cid_proc_presc_w,cd_doenca_cid_w), ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),cd_cid_proc_presc_w),
										coalesce(ds_inicacao_clinica_w, ds_observacao_w));

								end if;


								ie_emitir_spsadt_zerado_w	:= ie_spsadt_zerado_w;
								if (ie_spsadt_zerado_w	= 'R') then
									ie_emitir_spsadt_zerado_w		:= 'S';
									open c13;
									loop
									fetch c13 into
										ie_emitir_spsadt_zerado_w;
									EXIT WHEN NOT FOUND; /* apply on c13 */
									end loop;
									close c13;
								end if;

								if (coalesce(qt_solicitada_w,0) <> 0) or (coalesce(qt_autorizada_w,0) <> 0) or (ie_emitir_spsadt_zerado_w in ('S','Q')) then

									nr_seq_apresentacao_w	:= nr_seq_apresentacao_w + 1;

									if (coalesce(ie_lado_rep_w,'N') = 'S') then
										if (ie_lado_w IS NOT NULL AND ie_lado_w::text <> '') then
											ds_procedimento_w := substr(ds_procedimento_w || ' - ' || ie_lado_w,1,255);
										end if;
									end if;

									if (coalesce(ie_topo_rep_w,'N') = 'S') then
										if (ds_topogradia_w IS NOT NULL AND ds_topogradia_w::text <> '') then
											ds_procedimento_w := substr(ds_procedimento_w || ' - ' || ds_topogradia_w,1,255);
										end if;
									end if;

									-- Edgar 05/08/2009, OS 158125, tratar conversao

									--cd_procedimento_w	:= nvl(TISS_Obter_Proced_Conversao(cd_convenio_w, cd_procedimento_w, ie_origem_proced_w, 'C'), cd_procedimento_w);
									if (coalesce(cd_proced_conversao_w,'0') <> '0') then
										cd_procedimento_w := coalesce(cd_proced_conversao_w,cd_procedimento_w);
									end if;

									if (ie_proc_tuss_w in ('S','P')) and (coalesce(cd_proc_tuss_w,0) > 0) then
										cd_procedimento_w	:= to_char(cd_proc_tuss_w);
									end if;

									insert into w_tiss_proc_solic(nr_sequencia,
										dt_atualizacao,
										nm_usuario,
										nr_seq_guia,
										cd_procedimento,
										cd_edicao_amb,
										ds_procedimento,
										qt_solicitada,
										qt_autorizada,
										nr_seq_apresentacao)
									values (nextval('w_tiss_proc_solic_seq'),
										clock_timestamp(),
										nm_usuario_p,
										nr_seq_guia_w,
										tiss_obter_regra_campo(2, 'CD_PROCEDIMENTO_SOLIC', CD_CONVENIO_W, cd_procedimento_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_execucao_w),
										cd_edicao_amb_w,
										ds_procedimento_w,
										qt_solicitada_w,
										tiss_obter_regra_campo(2, 'QT_AUTORIZADA', CD_CONVENIO_W, qt_autorizada_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, nr_seq_classif_atend_w, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@',cd_setor_execucao_w),
										nr_seq_apresentacao_w);

									/*Lhalves OS 576785 em 08/04/2013 - Concatenar a observacao dos procedimentos que serao emitidos na guia*/

									if (ds_observacao_proc_prescr_w IS NOT NULL AND ds_observacao_proc_prescr_w::text <> '') then
										if (coalesce(ds_observacao_guia_w::text, '') = '') then
											ds_observacao_guia_w	:= substr((nr_seq_apresentacao_w ||'-'|| ds_observacao_proc_prescr_w),1,3999);
										else
											ds_observacao_guia_w 	:= substr((ds_observacao_guia_w ||' '|| nr_seq_apresentacao_w ||'-'|| ds_observacao_proc_prescr_w),1,3999);
										end if;
									end if;

									if (qt_proc_guia_w = 5) then

										insert into w_tiss_contratado_exec(nr_sequencia,
											dt_atualizacao,
											nm_usuario,
											nr_seq_guia)
										values (nextval('w_tiss_contratado_exec_seq'),
											clock_timestamp(),
											nm_usuario_p,
											nr_seq_guia_w);

										insert	into w_tiss_totais(nr_sequencia,
											dt_atualizacao,
											nm_usuario,
											nr_seq_guia)
										values (nextval('w_tiss_totais_seq'),
											clock_timestamp(),
											nm_usuario_p,
											nr_seq_guia_w);

										qt_proc_guia_w	:= 0;
										nr_seq_apresentacao_w	:= 0;
										CALL TISS_COMPLETAR_GUIA(nr_seq_guia_w, nm_usuario_p);

									end if;

									update	w_tiss_guia
									set	ds_observacao	= ds_observacao_guia_w
									where	nr_sequencia 	= nr_seq_guia_w;

								end if;
							end if;

						end loop;
						close c20;

						if (qt_proc_guia_w > 0) and (qt_proc_guia_w < 5) then

							insert into w_tiss_contratado_exec(nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								nr_seq_guia)
							values (nextval('w_tiss_contratado_exec_seq'),
								clock_timestamp(),
								nm_usuario_p,
								nr_seq_guia_w);

							insert	into w_tiss_totais(nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								nr_seq_guia)
							values (nextval('w_tiss_totais_seq'),
								clock_timestamp(),
								nm_usuario_p,
								nr_seq_guia_w);

						end if;

						if (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') then

							qt_proc_guia_w		:= 0;
							nr_seq_apresentacao_w	:= 0;

							open c22;
							loop
							fetch c22 into
								cd_opm_w,
								cd_edicao_w,
								ds_opm_w,
								qt_solicitada_w,
								qt_autorizada_w,
								ds_fabricante_w;
							EXIT WHEN NOT FOUND; /* apply on c22 */

								qt_proc_guia_w		:= qt_proc_guia_w + 1;
								nr_seq_apresentacao_w	:= nr_seq_apresentacao_w + 1;

								insert into w_tiss_opm(nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									nr_seq_guia,
									cd_opm,
									cd_edicao,
									ds_opm,
									qt_solicitada,
									qt_autorizada,
									ds_fabricante,
									vl_opm,
									nr_seq_apresentacao)
								values (nextval('w_tiss_opm_seq'),
									clock_timestamp(),
									nm_usuario_p,
									nr_seq_guia_w,
									cd_opm_w,
									cd_edicao_w,
									ds_opm_w,
									qt_solicitada_w,
									qt_autorizada_w,
									ds_fabricante_w,
									null,
									nr_seq_apresentacao_w);

							end loop;
							close c22;

						end if;

						CALL TISS_COMPLETAR_GUIA(nr_seq_guia_w, nm_usuario_p);

						if (qt_vias_w > 1) then
							CALL TISS_REPLICAR_GUIA_SADT(nr_seq_guia_w, qt_vias_w, nm_usuario_p);
						end if;

					end loop;
					close c21;

				end loop;
				close c19;
			end loop;
			close c35;

			end;

		end loop;
	end if;

elsif (coalesce(nr_cirurgia_p,0) > 0) then

	select	max(a.cd_convenio),
		max(b.cd_estabelecimento),
		max(a.cd_categoria),
		max(tiss_obter_se_atend_rn(a.nr_atendimento))
	into STRICT	cd_convenio_w,
		cd_estabelecimento_w,
		cd_categoria_conv_w,
		ie_atendimento_rn_w
	from	atend_categoria_convenio a,
		cirurgia b
	where	a.nr_atendimento				= b.nr_atendimento
	and	obter_atecaco_atendimento(a.nr_atendimento) 	= a.nr_seq_interno
	and	b.nr_cirurgia					= nr_cirurgia_p;

	select	coalesce(max(IE_EMITE_HONOR_SADT_PEP), 'N'),
		coalesce(max(ie_proc_tuss),'N'),
		coalesce(max(ie_desc_proc_interno),'N'),
		max(ds_arquivo_logo_comp),
		coalesce(max(ie_proc_solic_spsadt), 'AC')
	into STRICT	IE_EMITE_HONOR_SADT_PEP_w,
		ie_proc_tuss_w,
		ie_desc_proc_interno_w,
		ds_arquivo_logo_comp_w,
		ie_proc_solic_spsadt_w
	from	tiss_parametros_convenio
	where	cd_convenio		= cd_convenio_w
	and	cd_estabelecimento	= cd_estabelecimento_w;

	select	tiss_obter_versao(cd_convenio_w,cd_estabelecimento_w)
	into STRICT	ds_versao_w
	;

	select	max(cd_cgc)
	into STRICT	cd_cgc_estab_w
	from	estabelecimento
	where	cd_estabelecimento	= cd_estabelecimento_w;

	select	max(cd_ans),
		max(b.ds_arquivo_logo_tiss)
	into STRICT	cd_ans_w,
		ds_arquivo_logo_w
	from	pessoa_juridica c,
		convenio b
	where	b.cd_cgc		= c.cd_cgc
	and	b.cd_convenio		= cd_convenio_w;

	 begin
		select	im_logo_convenio
		into STRICT	im_logo_convenio_w
		from	tiss_logo_convenio
		where	cd_convenio	   = cd_convenio_w
		and 	coalesce(ie_situacao,'N') = 'A';
	exception
	when others then
		im_logo_convenio_w := null;
	end;

	if (coalesce(im_logo_convenio_w::text, '') = '') and (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') then
		ds_arquivo_logo_w := tiss_diretorio_logo(ds_arquivo_logo_comp_w, ds_dir_padrao_p) || ds_arquivo_logo_w;
	end if;

	if (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') and (coalesce(im_logo_convenio_w::text, '') = '') then
		insert	into w_tiss_relatorio(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_arquivo_logo,
			im_logo_convenio)
		values (nextval('w_tiss_relatorio_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			ds_arquivo_logo_w,
			null);
	else
		insert	into w_tiss_relatorio(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_arquivo_logo,
			im_logo_convenio)
		values (nextval('w_tiss_relatorio_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			null,
			im_logo_convenio_w);
	end if;

	open c30;
	loop
	fetch c30 into
		nr_seq_med_fatur_w,
		nr_atendimento_w,
		cd_autorizacao_w,
		cd_medico_convenio_w;
	EXIT WHEN NOT FOUND; /* apply on c30 */

		qt_proc_guia_w 		:= 0;
		nr_seq_apres_proc_w	:= 0;

		open c31;
		loop
		fetch c31 into
			cd_procedimento_w,
			ds_procedimento_w,
			qt_solicitada_w,
			qt_autorizada_w,
			dt_entrada_w,
			dt_alta_w,
			cd_edicao_amb_w,
			dt_procedimento_w,
			ie_funcao_w,
			ie_via_acesso_w,
			ie_tecnica_utilizada_w,
			nr_seq_proc_interno_w;
		EXIT WHEN NOT FOUND; /* apply on c31 */

			qt_proc_guia_w		:= qt_proc_guia_w + 1;

			if (qt_proc_guia_w = 1) then

				select	max(a.cd_senha),
					max(a.dt_inicio_vigencia),
					max(a.dt_final_vigencia),
					max(b.dt_entrada),
					max(b.ie_tipo_atendimento),
					max(b.ie_tipo_atend_tiss)
				into STRICT	cd_senha_w,
					dt_inicio_vigencia_w,
					dt_final_vigencia_w,
					dt_atendimento_w,
					ie_tipo_atendimento_w,
					ie_tipo_atend_tiss_w
				from	atend_categoria_convenio a,
					atendimento_paciente b
				where	a.nr_atendimento				= nr_atendimento_w
				and	obter_atecaco_atendimento(b.nr_atendimento) 	= a.nr_seq_interno
				and	a.nr_atendimento				= b.nr_atendimento;

				select	nextval('w_tiss_guia_seq')
				into STRICT	nr_seq_guia_w
				;

				if (coalesce(ie_data_ass_prest_w,'N') = 'S') then
					dt_assin_prest_w	:= dt_atendimento_w;

				elsif (coalesce(ie_data_ass_prest_w,'N') = 'N') then
					dt_assin_prest_w	:= clock_timestamp();
				elsif (coalesce(ie_data_ass_prest_w,'N') = 'V') then					
					dt_assin_prest_w	:= null;
				end if;

				insert	into w_tiss_guia(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					cd_ans,
					cd_autorizacao,
					dt_autorizacao,
					cd_senha,
					dt_validade_senha,
					dt_emissao_guia,
					nr_interno_conta,
					nr_seq_protocolo,
					nr_sequencia_autor,
					nr_atendimento,
					ds_observacao,
					ie_tiss_tipo_guia,
					dt_entrada,
					DT_ASSIN_PREST,
					ie_atendimento_rn,
					ds_versao)
				values (nr_seq_guia_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					cd_ans_w,
					cd_autorizacao_w,
					dt_inicio_vigencia_w,
					cd_senha_w,
					dt_final_vigencia_w,
					clock_timestamp(),
					null,
					null,
					null,
					nr_atendimento_w,
					tiss_obter_regra_campo(4, 'DS_OBSERVACAO', CD_CONVENIO_W, ds_observacao_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, null, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
					'4',
					dt_atendimento_w,
					DT_ASSIN_PREST_w,
					ie_atendimento_rn_w,
					ds_versao_w);

				/*lhalves OS305885 em 30/03/2011 - substituido a view pelo select - Performance*/

				insert	into w_tiss_beneficiario(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_guia,
					cd_pessoa_fisica,
					nm_pessoa_fisica,
					nr_cartao_nac_sus,
					ds_plano,
					dt_validade_carteira,
					cd_usuario_convenio)
				SELECT	nextval('w_tiss_beneficiario_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w,
					c.cd_pessoa_fisica,
					substr(TISS_OBTER_TITULAR_CONV_RN(nr_atendimento_w, null, cd_convenio_w, cd_estabelecimento_w),1,150),
					to_char(c.nr_cartao_nac_sus),
					substr(obter_desc_plano(b.cd_convenio, b.cd_plano_convenio),1,40),
					b.dt_validade_carteira,
					b.cd_usuario_convenio
				from	pessoa_fisica c,
					atend_categoria_convenio b,
					atendimento_paciente a
				where	b.nr_seq_interno	= obter_atecaco_atendimento(b.nr_atendimento)
				and	a.nr_atendimento	= b.nr_atendimento
				and	a.cd_pessoa_fisica	= c.cd_pessoa_fisica
				and	a.nr_atendimento	= nr_atendimento_w;

				insert into w_tiss_contratado_solic(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_guia,
					cd_cgc,
					cd_interno,
					nr_cpf,
					nm_contratado,
					nm_solicitante,
					cd_cnes,
					sg_conselho,
					nr_crm,
					uf_crm,
					cd_cbo_saude)
				SELECT	nextval('w_tiss_contratado_solic_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w,
					cd_cgc,
					cd_interno,
					nr_cpf_w,
					ds_razao_social,
					obter_nome_medico(cd_medico_convenio_w, 'N'),
					cd_cnes,
					obter_dados_medico(cd_medico_convenio_w, 'SGCRM'),
					obter_dados_medico(cd_medico_convenio_w, 'CRM'),
					substr(obter_dados_medico(cd_medico_convenio_w, 'UFCRM'),1,2),
					coalesce(cd_cbo_med_prest_w, cd_cbo_saude)
				from	tiss_dados_solicitante_v
				where	nr_atendimento		= nr_atendimento_w
				and	ds_versao		= '2.01.01'
				and	ie_origem		= 'AP';

				insert	into w_tiss_contratado_exec(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_guia,
					cd_cgc,
					cd_interno,
					nr_cpf,
					nm_contratado,
					ds_tipo_logradouro,
					ds_logradouro,
					nm_municipio,
					sg_estado,
					cd_municipio_ibge,
					cd_cep,
					cd_cnes,
					nm_medico_executor,
					sg_conselho,
					nr_crm,
					uf_crm,
					cd_cbo_saude,
					ds_funcao_medico)
				SELECT	nextval('w_tiss_contratado_exec_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w,
					cd_cgc_estab_w,
					TISS_OBTER_CODIGO_PRESTADOR(cd_convenio_w, cd_estabelecimento_w, null, cd_cgc_estab_w, (null)::numeric , 'CI', null,ie_tipo_atendimento_w,cd_categoria_conv_w),
					substr(obter_dados_pf(b.cd_pessoa_fisica, 'CPF'), 1, 150),
					substr(obter_nome_pf_pj(null,cd_cgc_estab_w),1,100),
					'81' ds_tipo_logradouro,
					substr(obter_dados_pf_pj(null,cd_cgc_estab_w,'EC'),1,255),
					substr(obter_dados_pf_pj(null,cd_cgc_estab_w,'CI'),1,255),
					obter_dados_pf_pj(null,cd_cgc_estab_w,'UF'),
					substr(lpad(somente_numero(obter_dados_pf_pj(null,cd_cgc_estab_w,'CDM')),7,'0'),1,15),
					lpad(to_char(somente_numero(obter_dados_pf_pj(null,cd_cgc_estab_w,'CEP'))),8,'0'),
					substr(obter_dados_pf_pj(null,cd_cgc_estab_w,'CNES'),1,20),
					substr(obter_nome_medico(b.cd_pessoa_fisica, 'N'),1,255),
					obter_dados_medico(b.cd_pessoa_fisica, 'SGCRM'),
					obter_dados_medico(b.cd_pessoa_fisica, 'CRM'),
					substr(obter_dados_medico(b.cd_pessoa_fisica, 'UFCRM'),1,2),
					substr(obter_dados_pf(b.cd_pessoa_fisica, 'CBOS'),1,20),
					'00'
				from	medico b
				where	b.cd_pessoa_fisica = cd_medico_convenio_w;

			end if;

			select	max(cd_procedimento_tuss)
			into STRICT	cd_proc_tuss_w
			from	proc_interno
			where	nr_sequencia	= nr_seq_proc_interno_w;

			if (ie_proc_tuss_w in ('S','F')) and (coalesce(cd_proc_tuss_w,0) > 0) then
				cd_procedimento_w	:= cd_proc_tuss_w;
			end if;

			if (ie_desc_proc_interno_w = 'S') and (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') then
				ds_procedimento_w	:= coalesce(substr(obter_desc_proc_interno(nr_seq_proc_interno_w),1,255),ds_procedimento_w);
			elsif (ie_desc_proc_interno_w = 'T') and (coalesce(cd_proc_tuss_w,0) > 0) then
				ds_procedimento_w	:= coalesce(substr(obter_desc_procedimento(cd_proc_tuss_w,8),1,255),ds_procedimento_w);
			end if;


			nr_seq_apres_proc_w	:= nr_seq_apres_proc_w + 1;

			insert	into w_tiss_proc_paciente(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nr_seq_guia,
				cd_procedimento,
				cd_edicao_amb,
				qt_procedimento,
				vl_reducao_acrescimo,
				vl_procedimento,
				dt_entrada,
				dt_alta,
				vl_unitario,
				ds_procedimento,
				dt_procedimento,
				nr_seq_apresentacao,
				ie_tecnica_utilizada,
				ie_via_acesso)
			values (nextval('w_tiss_proc_paciente_seq'),
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_guia_w,
				cd_procedimento_w,
				cd_edicao_amb_w,
				qt_autorizada_w,
				null,
				null,
				dt_entrada_w,
				dt_alta_w,
				null,
				ds_procedimento_w,
				dt_procedimento_w,
				nr_seq_apres_proc_w,
				ie_tecnica_utilizada_w,
				ie_via_acesso_w);

			if (ie_proc_solic_spsadt_w = 'PE') then

				insert into w_tiss_proc_solic(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_guia,
					cd_procedimento,
					cd_edicao_amb,
					ds_procedimento,
					qt_solicitada,
					qt_autorizada,
					nr_seq_apresentacao)
				values (nextval('w_tiss_proc_solic_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w,
					cd_procedimento_w,
					cd_edicao_amb_w,
					ds_procedimento_w,
					qt_autorizada_w,
					qt_autorizada_w,
					nr_seq_apres_proc_w);
			end if;

			if (qt_proc_guia_w = 5) then

				insert into w_tiss_contratado_exec(NR_SEQUENCIA,
					dt_ATUALIZACAO,
					nm_usUARIO,
					nr_seq_GUIA)
				values (nextval('w_tiss_contratado_exec_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w);

				insert	into w_tiss_totais(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_guia)
				values (nextval('w_tiss_totais_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w);

				qt_proc_guia_w	:= 0;
			end if;

		end loop;
		close c31;

		if (qt_proc_guia_w > 0) and (qt_proc_guia_w < 5) then

			insert	into w_tiss_totais(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nr_seq_guia)
			values (nextval('w_tiss_totais_seq'),
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_guia_w);

		end if;

		CALL TISS_COMPLETAR_GUIA(nr_seq_guia_w, nm_usuario_p);

	end loop;
	close c30;

elsif (coalesce(nr_seq_checkup_p,0) > 0) then

	select	max(a.cd_convenio),
		max(a.cd_estabelecimento),
		max(a.cd_categoria)
	into STRICT	cd_convenio_w,
		cd_estabelecimento_w,
		cd_categoria_conv_w
	from	checkup a
	where	a.nr_sequencia	= nr_seq_checkup_p;

	select	coalesce(max(IE_EMITE_HONOR_SADT_PEP), 'N'),
		coalesce(max(ie_proc_tuss),'N'),
		coalesce(max(ie_desc_proc_interno),'N'),
		max(ds_arquivo_logo_comp),
		coalesce(max(ie_proc_solic_spsadt), 'AC')
	into STRICT	IE_EMITE_HONOR_SADT_PEP_w,
		ie_proc_tuss_w,
		ie_desc_proc_interno_w,
		ds_arquivo_logo_comp_w,
		ie_proc_solic_spsadt_w
	from	tiss_parametros_convenio
	where	cd_convenio		= cd_convenio_w
	and	cd_estabelecimento	= cd_estabelecimento_w;

	select	tiss_obter_versao(cd_convenio_w,cd_estabelecimento_w)
	into STRICT	ds_versao_w
	;

	select	max(cd_cgc)
	into STRICT	cd_cgc_estab_w
	from	estabelecimento
	where	cd_estabelecimento	= cd_estabelecimento_w;

	select	max(cd_ans),
		max(b.ds_arquivo_logo_tiss)
	into STRICT	cd_ans_w,
		ds_arquivo_logo_w
	from	pessoa_juridica c,
		convenio b
	where	b.cd_cgc		= c.cd_cgc
	and	b.cd_convenio	= cd_convenio_w;

	begin
		select	im_logo_convenio
		into STRICT	im_logo_convenio_w
		from	tiss_logo_convenio
		where	cd_convenio	   = cd_convenio_w
		and 	coalesce(ie_situacao,'N') = 'A';
	exception
	when others then
		im_logo_convenio_w := null;
	end;

	if (coalesce(im_logo_convenio_w::text, '') = '') and (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') then
		ds_arquivo_logo_w := tiss_diretorio_logo(ds_arquivo_logo_comp_w, ds_dir_padrao_p) || ds_arquivo_logo_w;
	end if;

	if (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') and (coalesce(im_logo_convenio_w::text, '') = '') then
		insert	into w_tiss_relatorio(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_arquivo_logo,
			im_logo_convenio)
		values (nextval('w_tiss_relatorio_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			ds_arquivo_logo_w,
			null);
	else
		insert	into w_tiss_relatorio(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_arquivo_logo,
			im_logo_convenio)
		values (nextval('w_tiss_relatorio_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			null,
			im_logo_convenio_w);
	end if;

	cd_senha_w		:= null;
	ie_tipo_atendimento_w	:= null;
	ie_tipo_atend_tiss_w	:= null;

	select	max(a.dt_inicio_real),
		max(a.dt_fim_real),
		max(a.dt_previsto),
		substr(max(a.ds_observacao),1,255)
	into STRICT	dt_inicio_vigencia_w,
		dt_final_vigencia_w,
		dt_atendimento_w,
		ds_observacao_w
	from	checkup a
	where	a.nr_sequencia	= nr_seq_checkup_p;

	select	nextval('w_tiss_guia_seq')
	into STRICT	nr_seq_guia_w
	;

	if (coalesce(ie_data_ass_prest_w,'N') = 'S') then
		dt_assin_prest_w	:= dt_atendimento_w;

	elsif (coalesce(ie_data_ass_prest_w,'N') = 'N') then
		dt_assin_prest_w	:= clock_timestamp();
	elsif (coalesce(ie_data_ass_prest_w,'N') = 'V') then		
		dt_assin_prest_w	:= null;
	end if;

	insert	into w_tiss_guia(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_ans,
		cd_autorizacao,
		dt_autorizacao,
		cd_senha,
		dt_validade_senha,
		dt_emissao_guia,
		nr_interno_conta,
		nr_seq_protocolo,
		nr_sequencia_autor,
		nr_atendimento,
		ds_observacao,
		ie_tiss_tipo_guia,
		dt_entrada,
		DT_ASSIN_PREST,
		ds_versao)
	values (nr_seq_guia_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_ans_w,
		cd_autorizacao_w,
		dt_inicio_vigencia_w,
		cd_senha_w,
		dt_final_vigencia_w,
		clock_timestamp(),
		null,
		null,
		null,
		nr_atendimento_w,
		tiss_obter_regra_campo(4, 'DS_OBSERVACAO', CD_CONVENIO_W, ds_observacao_w, ie_tipo_atendimento_w, cd_categoria_conv_w,'N',0, cd_estabelecimento_w, null, null, cd_setor_entrada_w, ie_tipo_atend_tiss_w||'#@'),
		'4',
		dt_atendimento_w,
		DT_ASSIN_PREST_w,
		ds_versao_w);

	insert	into w_tiss_beneficiario(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		nr_seq_guia,
		cd_pessoa_fisica,
		nm_pessoa_fisica,
		nr_cartao_nac_sus,
		ds_plano,
		dt_validade_carteira,
		cd_usuario_convenio)
	SELECT	nextval('w_tiss_beneficiario_seq'),
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_guia_w,
		c.cd_pessoa_fisica,
		substr(coalesce(tiss_obter_nome_abreviado(a.cd_convenio, a.cd_estabelecimento, c.cd_pessoa_fisica), c.nm_pessoa_fisica),1,150),
		to_char(c.nr_cartao_nac_sus),
		substr(obter_desc_plano(a.cd_convenio, a.cd_plano),1,40),
		null dt_validade_carteira,
		null cd_usuario_convenio
	from	pessoa_fisica c,
		checkup a
	where	a.cd_pessoa_fisica	= c.cd_pessoa_fisica
	and	a.nr_sequencia		= nr_seq_checkup_p;

	insert into w_tiss_contratado_solic(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		nr_seq_guia,
		cd_cgc,
		cd_interno,
		nr_cpf,
		nm_contratado,
		nm_solicitante,
		cd_cnes,
		sg_conselho,
		nr_crm,
		uf_crm,
		cd_cbo_saude)
	SELECT	nextval('w_tiss_contratado_solic_seq'),
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_guia_w,
		cd_cgc_estab_w,
		null,
		null nr_cpf,
		substr(b.ds_razao_social,1,255),
		null nm_solicitante,
		b.cd_cnes,
		null sg_conselho,
		null nr_crm,
		null uf_crm,
		null cd_cbo_saude
	from	estabelecimento a,
		pessoa_juridica b
	where	a.cd_cgc		= b.cd_cgc
	and	a.cd_estabelecimento	= cd_estabelecimento_w;

	insert into w_tiss_solicitacao(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		nr_seq_guia,
		dt_solicitacao,
		ie_carater_solic,
		cd_cid,
		ds_indicacao)
	SELECT	nextval('w_tiss_solicitacao_seq'),
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_guia_w,
		clock_timestamp(),
		'E',
		null,
		ds_observacao_w
	;

	CALL TISS_COMPLETAR_GUIA(nr_seq_guia_w, nm_usuario_p);

elsif (coalesce(nr_seq_reap_conta_p,0) > 0) then

	select	max(a.nr_atendimento),
		max(a.cd_convenio_parametro),
		max(a.cd_estabelecimento),
		max(a.nr_interno_conta)
	into STRICT	nr_atendimento_w,
		cd_convenio_w,
		cd_estabelecimento_w,
		nr_interno_conta_w
	from	conta_paciente a,
		tiss_reap_conta b
	where	a.nr_interno_conta	= b.nr_interno_conta
	and	b.nr_sequencia		= nr_seq_reap_conta_p;

	select 	coalesce(max(ie_gerar_tiss), 'S'),
		coalesce(max(ie_spsadt_atend_retorno),'S')
	into STRICT 	ie_gerar_tiss_w,
		ie_spsadt_atend_retorno_w
	from 	tiss_parametros_convenio
	where 	cd_estabelecimento	= cd_estabelecimento_w
	and 	cd_convenio		= cd_convenio_w;

	if (coalesce(ie_gerar_tiss_w,'S') = 'S') and
		((coalesce(ie_spsadt_atend_retorno_w,'S') = 'S') or (coalesce(obter_se_atend_retorno(nr_atendimento_w),'N') = 'N'))then

		select	max(cd_ans),
			max(b.ds_arquivo_logo_tiss),
			max(b.cd_convenio),
			max(a.cd_estabelecimento)
		into STRICT	cd_ans_w,
			ds_arquivo_logo_w,
			cd_convenio_w,
			cd_estabelecimento_w
		from	pessoa_juridica c,
			convenio b,
			conta_paciente a
		where	a.cd_convenio_parametro	= b.cd_convenio
		and	b.cd_cgc		= c.cd_cgc
		and	a.nr_interno_conta	= nr_interno_conta_w;

		begin
			select	im_logo_convenio
			into STRICT	im_logo_convenio_w
			from	tiss_logo_convenio
			where	cd_convenio	   = cd_convenio_w
			and 	coalesce(ie_situacao,'N') = 'A';
		exception
		when others then
			im_logo_convenio_w := null;
		end;

		if (coalesce(im_logo_convenio_w::text, '') = '') and (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') then
			ds_arquivo_logo_w := tiss_diretorio_logo(ds_arquivo_logo_comp_w, ds_dir_padrao_p) || ds_arquivo_logo_w;
		end if;

		if (ds_arquivo_logo_w IS NOT NULL AND ds_arquivo_logo_w::text <> '') and (coalesce(im_logo_convenio_w::text, '') = '') then

			insert	into w_tiss_relatorio(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_arquivo_logo,
				im_logo_convenio)
			values (nextval('w_tiss_relatorio_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				ds_arquivo_logo_w,
				null);
		else
			insert	into w_tiss_relatorio(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_arquivo_logo,
				im_logo_convenio)
			values (nextval('w_tiss_relatorio_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				null,
				im_logo_convenio_w);
		end if;

		select	coalesce(max(IE_AGRUPAR_PROC), 'S'),
			coalesce(max(ie_exec_spsadt),'N'),
			coalesce(max(ie_proc_solic_spsadt), 'AC'),
			coalesce(max(ie_ordenacao_spsadt), '0'),
			coalesce(max(ie_obs_urgente), 'N'),
			coalesce(max(ie_quebra_proc_pep), 'N')
		into STRICT	ie_agrupar_proc_w,
			ie_trazer_executor_w,
			ie_proc_solic_spsadt_w,
			ie_ordenacao_spsadt_w,
			ie_obs_urgente_w,
			ie_quebra_proc_pep_w
		from	TISS_PARAMETROS_CONVENIO
		where	cd_estabelecimento	= cd_estabelecimento_w
		and	cd_convenio		= cd_convenio_w;

		open c33;
		loop
		fetch c33 into
			nr_seq_conta_guia_w,
			nr_atendimento_w,
			nr_interno_conta_w,
			cd_autorizacao_w,
			ie_tipo_atendimento_w,
			ie_tipo_saida_w,
			ie_tiss_tipo_guia_w,
			cd_autorizacao_princ_w,
			cd_cgc_prestador_w,
			dt_autorizacao_w,
			cd_senha_w,
			dt_validade_senha_w,
			dt_emissao_guia_w,
			dt_atendimento_w,
			ds_carater_internacao_w,
			cd_medico_executor_w,
			ie_honorario_w,
			nr_seq_autor_W;
		EXIT WHEN NOT FOUND; /* apply on c33 */
			begin

			qt_proc_guia_w 		:= 0;
			nr_seq_apres_proc_w	:= 0;
			nr_seq_apresent_opm_w	:= 0;
			nr_seq_apresentacao_w	:= 0;

			open c34;
			loop
			fetch c34 into
				cd_procedimento_w,
				cd_edicao_amb_w,
				qt_procedimento_w,
				vl_reducao_acrescimo_w,
				vl_procedimento_w,
				ie_via_acesso_w,
				vl_unitario_w,
				ds_proced_convenio_w,
				dt_procedimento_w,
				dt_inicio_cirurgia_w,
				dt_fim_cirurgia_w,
				ie_tecnica_utilizada_w,
				cd_cbos_w,
				nr_seq_apresent_proc_w,
				cd_setor_execucao_w;
			EXIT WHEN NOT FOUND; /* apply on c34 */
				begin

				qt_proc_guia_w		:= qt_proc_guia_w + 1;

				if (qt_proc_guia_w = 1) then
					nr_seq_guia_w := tiss_gerar_cabecalho_spsadt(nr_seq_conta_guia_w, nr_seq_guia_w, nm_usuario_p);
				end if;

				select	max(nr_seq_guia)
				into STRICT	nr_seq_guia_proc_w
				from	w_tiss_proc_paciente;

				if (nr_seq_guia_proc_w <> nr_seq_guia_w) then
					nr_seq_apres_proc_w	:= 0;
					nr_seq_apresentacao_w	:= 0;
				end if;

				nr_seq_apres_proc_w	:= nr_seq_apres_proc_w + 1;

				insert	into w_tiss_proc_paciente(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_guia,
					cd_procedimento,
					cd_edicao_amb,
					qt_procedimento,
					vl_reducao_acrescimo,
					vl_procedimento,
					dt_entrada,
					dt_alta,
					ie_via_acesso,
					vl_unitario,
					ds_procedimento,
					dt_procedimento,
					dt_inicio_cirurgia,
					dt_fim_cirurgia,
					nr_seq_apresentacao,
					ie_tecnica_utilizada)
				values (nextval('w_tiss_proc_paciente_seq'),
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_guia_w,
					cd_procedimento_w,
					cd_edicao_amb_w,
					qt_procedimento_w,
					vl_reducao_acrescimo_w,
					vl_procedimento_w,
					dt_entrada_w,
					dt_alta_w,
					ie_via_acesso_w,
					vl_unitario_w,
					ds_proced_convenio_w,
					dt_procedimento_w,
					dt_inicio_cirurgia_w,
					dt_fim_cirurgia_w,
					nr_seq_apres_proc_w,
					ie_tecnica_utilizada_w);

				if	((ie_proc_solic_spsadt_w = 'AC') or (ie_proc_solic_spsadt_w = 'AG')) and (coalesce(nr_seq_prot_med_p,0) < 0) then

					open c10;
					loop
					fetch c10 into
						cd_proc_solic_w,
						ds_proced_solic_w,
						qt_solicitada_w,
						qt_autorizada_w,
						cd_edicao_amb_solic_w;
					EXIT WHEN NOT FOUND; /* apply on c10 */

						if (length(cd_proc_solic_w) = 10) then
							if (substr(cd_proc_solic_w, 1,2) = '00') then
								cd_proc_solic_w		:= substr(cd_proc_solic_w, 3, 8);
							end if;
						end if;

						nr_seq_apresentacao_w := nr_seq_apresentacao_w + 1;

						insert into w_tiss_proc_solic(nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							nr_seq_guia,
							cd_procedimento,
							cd_edicao_amb,
							ds_procedimento,
							qt_solicitada,
							qt_autorizada,
							nr_seq_apresentacao)
						values (nextval('w_tiss_proc_solic_seq'),
							clock_timestamp(),
							nm_usuario_p,
							nr_seq_guia_w,
							cd_proc_solic_w,
							cd_edicao_amb_solic_w,
							coalesce(ds_proced_convenio_w, ds_proced_solic_w),
							qt_solicitada_w,
							qt_autorizada_w,
							nr_seq_apresentacao_w);

					end loop;
					close c10;

				else

					insert into w_tiss_proc_solic(nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						nr_seq_guia,
						cd_procedimento,
						cd_edicao_amb,
						ds_procedimento,
						qt_solicitada,
						qt_autorizada,
						nr_seq_apresentacao)
					values (nextval('w_tiss_proc_solic_seq'),
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_guia_w,
						cd_procedimento_w,
						cd_edicao_amb_w,
						coalesce(ds_proced_convenio_w, ds_procedimento_w),
						qt_procedimento_w,
						qt_procedimento_w,
						nr_seq_apres_proc_w);

				end if;

				if (qt_proc_guia_w = 5) then
					qt_proc_guia_w	:= 0;
					CALL TISS_GERAR_OPM_EXEC(nr_seq_conta_guia_w, nr_seq_guia_w, nm_usuario_p);
					CALL TISS_COMPLETAR_GUIA(nr_seq_guia_w, nm_usuario_p);
				end if;



				end;
			end loop;
			close C34;

			if (qt_proc_guia_w > 0) and (qt_proc_guia_w < 5) then
				CALL TISS_GERAR_OPM_EXEC(nr_seq_conta_guia_w, nr_seq_guia_w, nm_usuario_p);
			end if;

			CALL TISS_COMPLETAR_GUIA(nr_seq_guia_w, nm_usuario_p);

			end;
		end loop;
		close C33;

	end if;

end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_gerar_w_guia_spsadt (nr_sequencia_autor_p bigint, nr_seq_protocolo_p bigint, nr_interno_conta_p bigint, ds_dir_padrao_p text, nr_seq_pedido_exame_p bigint, nr_prescr_tiss_p bigint, nr_seq_med_fatur_p text, nr_atend_conta_tiss_p text, nm_usuario_p text, ie_setor_prescr_p text, nr_seq_prot_med_p bigint, nr_seq_exame_p bigint, nr_atend_med_p bigint, nr_seq_paciente_p bigint, nr_prescricoes_p text, cd_evolucao_p bigint, ie_data_solic_pedido_p text, ie_ultima_prescricao_p text, nr_cirurgia_p bigint, nr_seq_checkup_p bigint, ie_somente_prescr_p text, nr_seq_reap_conta_p bigint, ds_imprimi_procedimento_p text default null, nr_ciclo_p bigint default null, ie_lista_desc_solic_exame_p text default 'ESLIP', ie_considera_dt_cpoe_p text default 'N', dt_inicial_p timestamp default null, dt_final_p timestamp default null, ds_imprimi_patologia_p text default null, ds_imprimi_hemoterapia_p text default null) FROM PUBLIC;

