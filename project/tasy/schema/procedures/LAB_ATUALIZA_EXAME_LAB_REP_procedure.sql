-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_atualiza_exame_lab_rep ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text ) AS $body$
DECLARE



C01 CURSOR FOR
SELECT	c.nr_seq_resultado,
		a.nr_prescricao,
		c.nr_sequencia,
		c.nr_seq_exame,
		c.nm_usuario,
		c.qt_resultado,
		c.ds_resultado,
		c.nr_seq_metodo,
		c.nr_seq_material,
		c.pr_resultado,
		c.ie_status,
		c.nr_seq_prescr,
		c.pr_minimo,
		c.pr_maximo,
		c.qt_minima,
		c.qt_maxima,
		c.ds_observacao,
		c.ds_referencia,
		c.nr_seq_unid_med,
		c.qt_decimais,
		c.dt_coleta,
		c.nr_seq_formato,
		c.ie_consiste,
		c.ie_normalidade,
		c.ie_restringe_resultado,
		c.dt_digitacao,
		c.nr_seq_assinatura,
		c.nr_seq_assinat_inativ,
		c.ie_resultado_referencia,
		c.ie_resultado_critico,
		c.ie_resultado_relevante,
		c.ie_tipo_val_crit
from	prescr_procedimento a,
		exame_lab_resultado b,
		exame_lab_result_item c
where 	a.nr_prescricao 	= b.nr_prescricao
and		b.nr_seq_resultado 	= c.nr_seq_resultado
and		a.nr_sequencia 		= c.nr_seq_prescr
and		a.nr_prescricao 	= nr_prescricao_p
and		a.nr_sequencia 		= nr_seq_prescr_p
order by 1;

c01_w					c01%rowtype;
ie_status_repet_w		lab_parametro.ie_status_repeticao%type;
nr_seq_resultado_rep	exame_lab_result_item_rep.nr_seq_resultado%type;


BEGIN

select 	coalesce(max(a.ie_status_repeticao),0)
into STRICT	ie_status_repet_w
from	lab_parametro a, prescr_medica b
where   b.nr_prescricao = nr_prescricao_p
and 	a.cd_estabelecimento = b.cd_estabelecimento;

if (ie_status_repet_w IS NOT NULL AND ie_status_repet_w::text <> '') then

		select 	max(c.nr_seq_resultado)
		into STRICT 	nr_seq_resultado_rep
		from	prescr_procedimento a,
				exame_lab_resultado b,
				exame_lab_result_item_rep c
		where 	a.nr_prescricao 	= b.nr_prescricao
		and		b.nr_seq_resultado 	= c.nr_seq_resultado
		and		a.nr_prescricao 	= nr_prescricao_p
		and		a.nr_sequencia		= c.nr_seq_prescr
		and		a.nr_sequencia 		= nr_seq_prescr_p;

	open C01;
	loop
	fetch C01 into
	c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */

		if (nr_seq_resultado_rep IS NOT NULL AND nr_seq_resultado_rep::text <> '') then
			update	exame_lab_result_item_rep
			set			nr_seq_resultado		= c01_w.nr_seq_resultado,
						nr_sequencia			= c01_w.nr_sequencia,
						nr_prescricao			= c01_w.nr_prescricao,
						nr_seq_exame			= c01_w.nr_seq_exame,
						nm_usuario				= nm_usuario_p,
						qt_resultado			= c01_w.qt_resultado,
						ds_resultado			= c01_w.ds_resultado,
						nr_seq_metodo			= c01_w.nr_seq_metodo,
						nr_seq_material			= c01_w.nr_seq_material,
						pr_resultado			= c01_w.pr_resultado,
						ie_status				= c01_w.ie_status,
						nr_seq_prescr			= c01_w.nr_seq_prescr,
						pr_minimo				= c01_w.pr_minimo,
						pr_maximo				= c01_w.pr_maximo,
						qt_minima				= c01_w.qt_minima,
						qt_maxima				= c01_w.qt_maxima,
						ds_observacao			= c01_w.ds_observacao,
						ds_referencia			= c01_w.ds_referencia,
						nr_seq_unid_med			= c01_w.nr_seq_unid_med,
						qt_decimais				= c01_w.qt_decimais,
						dt_coleta				= c01_w.dt_coleta,
						nr_seq_formato			= c01_w.nr_seq_formato,
						ie_consiste				= c01_w.ie_consiste,
						ie_normalidade			= c01_w.ie_normalidade,
						ie_restringe_resultado	= c01_w.ie_restringe_resultado,
						dt_digitacao			= c01_w.dt_digitacao,
						nr_seq_assinatura		= c01_w.nr_seq_assinatura,
						nr_seq_assinat_inativ= c01_w.nr_seq_assinat_inativ,
						ie_resultado_referencia	= c01_w.ie_resultado_referencia,
						ie_resultado_critico	= c01_w.ie_resultado_critico,
						ie_resultado_relevante	= c01_w.ie_resultado_relevante,
						ie_tipo_val_crit		= c01_w.ie_tipo_val_crit,
						dt_atualizacao			= clock_timestamp()
			where	nr_seq_resultado = c01_w.nr_seq_resultado
			and		nr_sequencia	 = c01_w.nr_sequencia;
		else
			begin
				insert into exame_lab_result_item_rep(
							nr_seq_resultado,
							nr_prescricao,
							nr_sequencia,
							nr_seq_exame,
							nm_usuario,
							qt_resultado,
							ds_resultado,
							nr_seq_metodo,
							nr_seq_material,
							pr_resultado,
							ie_status,
							nr_seq_prescr,
							pr_minimo,
							pr_maximo,
							qt_minima,
							qt_maxima,
							ds_observacao,
							ds_referencia,
							nr_seq_unid_med,
							qt_decimais,
							dt_coleta,
							nr_seq_formato,
							ie_consiste,
							ie_normalidade,
							ie_restringe_resultado,
							dt_digitacao,
							nr_seq_assinatura,
							nr_seq_assinat_inativ,
							ie_resultado_referencia,
							ie_resultado_critico,
							ie_resultado_relevante,
							ie_tipo_val_crit,
							dt_atualizacao_nrec,
							dt_atualizacao
							)
				values (
							c01_w.nr_seq_resultado,
							c01_w.nr_prescricao,
							c01_w.nr_sequencia,
							c01_w.nr_seq_exame,
							nm_usuario_p,
							c01_w.qt_resultado,
							c01_w.ds_resultado,
							c01_w.nr_seq_metodo,
							c01_w.nr_seq_material,
							c01_w.pr_resultado,
							c01_w.ie_status,
							c01_w.nr_seq_prescr,
							c01_w.pr_minimo,
							c01_w.pr_maximo,
							c01_w.qt_minima,
							c01_w.qt_maxima,
							c01_w.ds_observacao,
							c01_w.ds_referencia,
							c01_w.nr_seq_unid_med,
							c01_w.qt_decimais,
							c01_w.dt_coleta,
							c01_w.nr_seq_formato,
							c01_w.ie_consiste,
							c01_w.ie_normalidade,
							c01_w.ie_restringe_resultado,
							c01_w.dt_digitacao,
							c01_w.nr_seq_assinatura,
							c01_w.nr_seq_assinat_inativ,
							c01_w.ie_resultado_referencia,
							c01_w.ie_resultado_critico,
							c01_w.ie_resultado_relevante,
							c01_w.ie_tipo_val_crit,
							clock_timestamp(),
							clock_timestamp()
						);
			end;
		end if;
end loop;
close C01;
end if;
	commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_atualiza_exame_lab_rep ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text ) FROM PUBLIC;

