-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE excluir_procedimento_executado (nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text) AS $body$
DECLARE



nr_sequencia_w			bigint;
nr_conta_fechada_w		bigint;
ie_flag_ok_w			varchar(01);
nr_laudos_w			bigint;
ie_excluir_mat_med_w		varchar(1);
ie_status_proced_exec_w		varchar(255);
qt_mat_med_w			bigint;
nr_atendimento_w		bigint;
nr_seq_material_w		bigint;
qt_laudo_w			bigint;
qt_status_atend_w		bigint;

c01 CURSOR FOR
	SELECT	nr_sequencia
	from	procedimento_paciente
	where 	nr_prescricao		= nr_prescricao_p
	and	nr_sequencia_prescricao	= nr_seq_prescr_p;

c02 CURSOR FOR
	SELECT	a.nr_sequencia
	from	prescr_material b,
		material_atend_paciente a
	where	a.nr_prescricao			= b.nr_prescricao
	and	a.nr_sequencia_prescricao	= b.nr_sequencia
	and	b.nr_prescricao			= nr_prescricao_p
	and	b.NR_SEQUENCIA_PROC		= nr_seq_prescr_p;


BEGIN

select 	count(*)
into STRICT	qt_status_atend_w
from 	prescr_procedimento
where	nr_prescricao		= nr_prescricao_p
and	nr_sequencia		= nr_seq_prescr_p
and     ie_status_atend >= 35;

if (qt_status_atend_w > 0 )then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(276454,'');
end if;

select	obter_valor_param_usuario(916, 1138, obter_perfil_ativo, nm_usuario_p, obter_estab_atend(nr_atendimento_w))
into STRICT	ie_status_proced_exec_w
;

if (ie_status_proced_exec_w IS NOT NULL AND ie_status_proced_exec_w::text <> '') then
	
	select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_flag_ok_w
	from 	prescr_procedimento
	where	nr_prescricao		= nr_prescricao_p
	and	nr_sequencia	= nr_seq_prescr_p
	and	(nr_seq_exame IS NOT NULL AND nr_seq_exame::text <> '');
	
	if (ie_flag_ok_w = 'S') then
		begin
			select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ie_flag_ok_w
			from 	prescr_procedimento
			where	nr_prescricao		= nr_prescricao_p
			and	nr_sequencia	= nr_seq_prescr_p	
			and	(nr_seq_exame IS NOT NULL AND nr_seq_exame::text <> '')
			and 	obter_se_contido(ie_status_atend,ie_status_proced_exec_w) = 'S';
		exception
		when others then
			ie_flag_ok_w := 'N';
		end;	
		if (ie_flag_ok_w = 'N') then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(389508,'');
		end if;
	end if;
end if;

select	obter_atendimento_prescr(nr_prescricao_p)
into STRICT	nr_atendimento_w
;

select	coalesce(obter_valor_param_usuario(916, 205, obter_perfil_ativo, nm_usuario_p, obter_estab_atend(nr_atendimento_w)),'N')
into STRICT	ie_excluir_mat_med_w
;

select	count(*)
into STRICT	qt_mat_med_w
from	material b,
	material_atend_paciente a
where	b.cd_material           = a.cd_material
and	a.nr_atendimento        = nr_atendimento_w
and	coalesce(a.cd_motivo_exc_conta::text, '') = '';


select 	count(*)
into STRICT	qt_laudo_w
from	procedimento_paciente a
where 	a.nr_prescricao			= nr_prescricao_p
and	a.nr_sequencia_prescricao	= nr_seq_prescr_p
and	(a.nr_laudo IS NOT NULL AND a.nr_laudo::text <> '');

if (qt_laudo_w = 0) then

	select	count(*)
	into STRICT	qt_laudo_w
	from	prescr_proc_ditado b,
		prescr_procedimento a
	where	a.nr_seq_interno	= b.nr_seq_prescr_proc
	and 	a.nr_prescricao		= nr_prescricao_p
	and	a.nr_sequencia		= nr_seq_prescr_p;

end if;

if (ie_excluir_mat_med_w = 'S') and (qt_mat_med_w > 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(231236,'');

elsif (qt_laudo_w > 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(231237,'');
else
	
	open	c01;
	loop
	fetch	c01 into
		nr_sequencia_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
	
		select	count(*)
		into STRICT	nr_laudos_w
		from	laudo_paciente
		where	nr_seq_proc	= nr_sequencia_w;

		if (nr_laudos_w > 0) then	
			CALL wheb_mensagem_pck.exibir_mensagem_abort(231238,'');
		end if;

		begin			

		select	count(*)
		into STRICT	nr_conta_fechada_w
		from	conta_paciente
			where	nr_interno_conta in (
				SELECT	nr_interno_conta
			from	procedimento_paciente
			where	nr_sequencia		= nr_sequencia_w
			
union

			SELECT	nr_interno_conta
			from	procedimento_paciente
			where	nr_seq_proc_princ	= nr_sequencia_w
			
union

			select	nr_interno_conta
			from	material_atend_paciente
			where	nr_seq_proc_princ	= nr_sequencia_w)
		and	ie_status_acerto = 2
		and	coalesce(ie_cancelamento::text, '') = '';		
		
		if (nr_conta_fechada_w > 0) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(231239,'');
		else	
			begin

			delete	from material_atend_paciente a
			where	nr_seq_proc_princ	= nr_sequencia_w
			and	exists (SELECT	1
				from	conta_paciente x
				where 	x.nr_interno_conta	= a.nr_interno_conta
				and	coalesce(x.ie_cancelamento::text, '') = '');

			delete	from procedimento_paciente a
			where	nr_seq_proc_princ	= nr_sequencia_w
			and	exists (SELECT	1
				from	conta_paciente x
				where 	x.nr_interno_conta	= a.nr_interno_conta
				and	coalesce(x.ie_cancelamento::text, '') = '')
			and	not exists (select  1
					    from    prescr_procedimento b
					    where   b.nr_prescricao = a.nr_prescricao
					    and     b.nr_sequencia = a.nr_sequencia_prescricao
					    and     b.ie_status_atend >= 35);

			delete	from procedimento_paciente a
			where	nr_sequencia		= nr_sequencia_w
			and	exists (SELECT	1
				from	conta_paciente x
				where 	x.nr_interno_conta	= a.nr_interno_conta
				and	coalesce(x.ie_cancelamento::text, '') = '')
			and	not exists (select  1
					from    prescr_procedimento b
					    where   b.nr_prescricao = a.nr_prescricao
					    and     b.nr_sequencia = a.nr_sequencia_prescricao
					    and     b.ie_status_atend >= 35);

			
		
			end;
		end if;
		end;
	end loop;
	close c01;

	update	procedimento_paciente a
	set	nr_prescricao		 = NULL,
		nr_sequencia_prescricao  = NULL
	where 	nr_prescricao		= nr_prescricao_p
	and	nr_sequencia_prescricao	= nr_seq_prescr_p;

	delete	from procedimento_autorizado
	where	nr_prescricao		= nr_prescricao_p
	and	nr_seq_prescricao	= nr_seq_prescr_p;

	open	c02;
	loop
	fetch	c02 into
		nr_seq_material_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin

		delete	from material_atend_paciente a
		where	nr_sequencia	= nr_seq_material_w
		and	exists (SELECT	1
			from	conta_paciente x
			where 	x.nr_interno_conta	= a.nr_interno_conta
			and	coalesce(x.ie_cancelamento::text, '') = '');


		end;
	end loop;
	close c02;

	delete	from prescr_proc_mat_item
	where	nr_prescricao		= nr_prescricao_p
	and	nr_seq_prescr		= nr_seq_prescr_p;
	
	delete	from prescr_procedimento_obs
	where	nr_prescricao		= nr_prescricao_p
	and	nr_seq_prescricao	= nr_seq_prescr_p;
	
	delete from prescr_proc_obs_coleta
	where	nr_prescricao	= nr_prescricao_p
	and	nr_seq_prescr	= nr_seq_prescr_p;
	
	delete from PRESCR_PROCED_INF_ADIC
	where nr_prescricao = nr_prescricao_p
	and nr_seq_prescricao = nr_seq_prescr_p;
	
	delete	from prescr_procedimento
	where	nr_prescricao		= nr_prescricao_p
	and	nr_sequencia		= nr_seq_prescr_p
	and     ie_status_atend < 35;

	CALL gravar_log_exclusao('PRESCR_PROCEDIMENTO', nm_usuario_p,
			  'NR_PRESCRICAO=' || nr_prescricao_p ||
			  ' NR_SEQUENCIA=' || nr_seq_prescr_p || ' Excluir_Procedimento_Executado','N');
	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE excluir_procedimento_executado (nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text) FROM PUBLIC;

