-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_prof_escala_per (dt_inicio_p timestamp, dt_final_p timestamp, ie_opcao_p bigint, nr_seq_escala_dia_orig_p bigint, nm_usuario_p text, ds_consistencia_dia_p INOUT text) AS $body$
DECLARE



nr_seq_escala_w		bigint;
cd_pessoa_fisica_w	varchar(10);
dt_inicio_w		timestamp;
dt_fim_w		timestamp;
cd_pessoa_origem_w	varchar(10);
ds_observacao_w		varchar(255);
ie_feriado_w		varchar(1);
qt_min_executado_w	bigint;
qt_escala_w		integer;
nr_seq_escala_diaria_w	bigint;
ds_dia_semana_w		varchar(3);
hr_inicio_w		varchar(7);
hr_fim_w		varchar(7);
ds_consistencia_w	varchar(1000);
ds_consistencia_dia_w	varchar(4000);

/*
ie_opcao_p
1 - todos os dias com o mesmo horario
0 - somente o dia da semana com o mesmo horario
*/
c01 CURSOR FOR
SELECT 	nr_sequencia
from	escala_diaria
where	to_char(dt_fim,'hh24:mi')	= hr_fim_w
and	to_char(dt_inicio,'hh24:mi')	= hr_inicio_w
and	ie_feriado 			= ie_feriado_w
and	(((ie_opcao_p = 0) and (substr(obter_dia_semana(DT_INICIO),1,3) = ds_dia_semana_w)) or (ie_opcao_p = 1))
and	nr_sequencia	<> nr_seq_escala_dia_orig_p
and	nr_seq_escala	= nr_seq_escala_w
and	dt_inicio 	between pkg_date_utils.start_of(dt_inicio_p, 'DD', 0) and pkg_date_utils.end_of(dt_final_p, 'DAY', 0);


BEGIN

select	max(nr_seq_escala),
	max(ie_feriado),
	max(substr(obter_dia_semana(DT_INICIO),1,3)),
	max(to_char(dt_inicio,'hh24:mi')),
	max(to_char(dt_fim,'hh24:mi'))
into STRICT	nr_seq_escala_w,
	ie_feriado_w,
	ds_dia_semana_w,
	hr_inicio_w,
	hr_fim_w
from	escala_diaria
where   nr_sequencia = nr_seq_escala_dia_orig_p;

ds_consistencia_dia_w	:= null;

open c01;
loop
fetch c01 into
	nr_seq_escala_diaria_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	ds_consistencia_w := copiar_profissional_escala(nr_seq_escala_dia_orig_p, nr_seq_escala_diaria_w, nm_usuario_p, ds_consistencia_w);

	if (ds_consistencia_w IS NOT NULL AND ds_consistencia_w::text <> '') and (length(ds_consistencia_dia_w || ds_consistencia_w || chr(10)) < 4000) then

		ds_consistencia_dia_w	:= ds_consistencia_dia_w || ds_consistencia_w;

	end if;

end loop;
close c01;

if (ds_consistencia_dia_w IS NOT NULL AND ds_consistencia_dia_w::text <> '') then
	ds_consistencia_dia_p	:= substr(ds_consistencia_dia_w,1,255);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_prof_escala_per (dt_inicio_p timestamp, dt_final_p timestamp, ie_opcao_p bigint, nr_seq_escala_dia_orig_p bigint, nm_usuario_p text, ds_consistencia_dia_p INOUT text) FROM PUBLIC;

