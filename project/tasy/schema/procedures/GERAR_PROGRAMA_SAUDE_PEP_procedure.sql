-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_programa_saude_pep ( nr_seq_pedido_atend_p bigint ) AS $body$
DECLARE



nr_seq_campanha_w        bigint;
nr_seq_programa_saude_w      bigint;
cd_pessoa_fisica_w        varchar(10);
cd_profissional_w        varchar(10);
ds_observacao_w          varchar(4000);
nr_seq_indicacao_w        bigint;
nr_seq_captacao_w        bigint;
nr_seq_captacao_dest_w      bigint;
nm_usuario_w          varchar(15);



BEGIN

if (nr_seq_pedido_atend_p IS NOT NULL AND nr_seq_pedido_atend_p::text <> '') then

  nm_usuario_w := wheb_usuario_pck.get_nm_usuario;

  Select   max(nr_seq_campanha),
      max(nr_seq_programa_saude),
      max(cd_pessoa_fisica),
      max(obter_pf_usuario(nm_usuario,'C')),
      max(ds_observacao)
  into STRICT  nr_seq_campanha_w,
      nr_seq_programa_saude_w,
      cd_pessoa_fisica_w,
      cd_profissional_w,
      ds_observacao_w
    from  atend_programa_saude
  where  nr_sequencia = nr_seq_pedido_atend_p;


  if (nr_seq_campanha_w IS NOT NULL AND nr_seq_campanha_w::text <> '') or (nr_seq_programa_saude_w IS NOT NULL AND nr_seq_programa_saude_w::text <> '') then
  
  
    Select  nextval('mprev_indicacao_paciente_seq')
    into STRICT  nr_seq_indicacao_w
;

    insert into  mprev_indicacao_paciente(  nr_sequencia,
                        dt_atualizacao,
                        DT_ATUALIZACAO_NREC,
                        DT_INDICACAO,
                        nm_usuario,
                        nm_usuario_nrec,
                        CD_PESSOA_FISICA,
                        CD_PESSOA_INDICANTE,
                        DS_OBSERVACAO,
                        NR_SEQ_PEDIDO_ATEND,
                        cd_estabelecimento_origem) 
                  values (  nr_seq_indicacao_w,
                        clock_timestamp(),
                        clock_timestamp(),
                        clock_timestamp(),
                        nm_usuario_w,
                        nm_usuario_w,
                        cd_pessoa_fisica_w,
                        cd_profissional_w,
                        ds_observacao_w,
                        nr_seq_pedido_atend_p,
                        wheb_usuario_pck.get_cd_estabelecimento);

    commit;

    nr_seq_captacao_w := mprev_gerar_captacao_indicacao(nr_seq_indicacao_w, nm_usuario_w, nr_seq_captacao_w);

    
    Select   nextval('mprev_captacao_destino_seq')
    into STRICT  nr_seq_captacao_dest_w
;


    insert into    mprev_captacao_destino(   nr_sequencia,
                          dt_atualizacao,
                          nm_usuario,
                          dt_atualizacao_nrec,
                          nm_usuario_nrec,
                          nr_seq_captacao,
                          nr_seq_programa,
                          nr_seq_campanha)
                    values (   nr_seq_captacao_dest_w,
                           clock_timestamp(),
                          nm_usuario_w,
                          clock_timestamp(),
                          nm_usuario_w,
                          nr_seq_captacao_w,
                          nr_seq_programa_saude_w,
                          nr_seq_campanha_w);

    commit;

    CALL mprev_confirmar_indicacao(nr_seq_indicacao_w,nm_usuario_w);

    
  
  end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_programa_saude_pep ( nr_seq_pedido_atend_p bigint ) FROM PUBLIC;

