-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE agenda_dia_status_html ( cd_estabelecimento_p bigint, cd_agenda_p bigint, dt_Inicial_p timestamp, dt_final_p timestamp, cd_turno_p text, nm_usuario_p text, ie_Status_p INOUT text, nr_seq_item_p bigint default null, cd_medico_p text default '') AS $body$
DECLARE



/*


							>>>>>>>>>>>>>>>>>ATENCAO<<<<<<<<<<<<<<<<<<<<

CUIDAR AO ALTERAR ESSA ROTINA, A MESMA APLICA AS RESTRICOES PARA A VISUALIZACAO MENSAL DE AGENDAS, NAS FUNCOES:
	- AGENDA DE CONSULTAS;
	- AGENDA DE SERVICOS;
	- AGENDA DE EXAMES;
	- GESTAO DA AGENDA CIRURGICA;

CASO TIVER DUVIDAS NA ALTERACAO, FALAR COM OS RESPONSAVEIS DO GRUPO "AGENDAS", NAO DOCUMENTAR O OBJETO SEM A VALIDACAO DO CLIENTE.

*/
ie_Status_w			varchar(4000);
ie_Status_dia_w			varchar(10);
dt_atual_w			timestamp;
cd_tipo_agenda_w		bigint;
ie_feriado_w			varchar(10);
ie_agenda_feriado_w		varchar(10);
ie_gerar_hor_feriado_w		varchar(10);
ie_dia_feriado_w		varchar(10);
ie_dia_semana_w			varchar(10);
qt_horario_w			bigint;
qt_horario_livre_w		bigint;
qt_regra_horario_w		bigint;
qt_horario_bloqueado_w		bigint;
ds_horarios_w			varchar(255);
ie_bloqueio_w			varchar(10);
ie_gravar_w			varchar(10) := 'N';
ie_sobra_horario_w		varchar(10) := 'S';
ds_retorno_w			varchar(4000) := '';
qt_bloqueio_w			bigint;
qt_horario_ocupado_w		bigint;
ie_gerar_hor_livre_w		varchar(1);
ie_agenda_valida_w		varchar(1) := 'N';
ie_existe_hor_gerado_w		bigint;
qt_dias_fut_w			bigint := 0;
cd_pessoa_usuario_w		varchar(10);
ie_cons_se_leg_dia_nao_lib_w 	varchar(1);
ie_cons_se_leg_dia_nao_lib_ww 	varchar(1);
cd_turno_w			varchar(1);
ie_cons_leg_bloq_fim_sem_w	varchar(1);
nr_minuto_intervalo_w		bigint;
nr_seq_turno_w			bigint;
qt_hor_bloq_per_w		bigint;
qt_total_hor_bloq_per_w		bigint;
ds_erro_w			varchar(255);
qt_bloqueio_sem_horario_w	bigint;
qt_reg_agenda_bloqueio_dia_w	bigint;
nr_dia_sabado_w			bigint;
nr_dia_domingo_w		bigint;
ie_dia_sem_w			varchar(10);
hr_inicio_agenda_w		timestamp;
hr_final_agenda_w		timestamp;
ie_turno_valido_w		varchar(1) 	:= 'N';
ie_gerar_hor_passado_w		varchar(1)	:= 'S';
ie_todos_dias_regra_w		varchar(1)	:= 'N';
nr_seq_esp_w			bigint	:= 0;
ie_horario_adicional_w 		varchar(01) 	:= 'S';
ie_manter_hist_horarios_w	varchar(1) 	:= 'N';
qt_bloqueado_manual_w		bigint;
qt_dia_semana_w			smallint;
ds_dia_semana_w			varchar(3);
ie_classif_item_w		varchar(5);
nr_seq_classif_agenda_item_w	agenda_integrada_item.nr_seq_classif_agenda%type;
cd_procedimento_w	agenda_integrada_item.cd_procedimento%type;
nr_seq_proc_interno_w	bigint;
ie_origem_proced_w	agenda_integrada_item.ie_origem_proced%type;
ds_horario_w				timestamp;
dt_agenda_exame_consulta_w	timestamp;
nr_seq_regra_bloq_w		agenda_bloqueio_geral.nr_sequencia%type;

--Obter qtd. de bloqueios gerados, caso os horarios do dia nao estiverem gerados(utilizado em casos de bloqueios especificos, com hr. inicial e hr. final)
C01 CURSOR FOR
	SELECT	coalesce(((((coalesce(a.hr_final_bloqueio, to_date('31/12/1899 '||'23:59:59', 'dd/mm/yyyy hh24:mi:ss')) - coalesce(a.hr_inicio_bloqueio, to_date('31/12/1899 '||'00:00:00', 'dd/mm/yyyy hh24:mi:ss'))) * 1440) / nr_minuto_intervalo_w)), 0)
	from	agenda_bloqueio a
	where  	a.cd_agenda 		= cd_agenda_p
	and		(((a.ie_dia_semana = 9) and (PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1))
	or		(a.ie_dia_semana <> 9 AND ie_dia_sem_w = a.ie_dia_semana)
	or (coalesce(a.ie_dia_semana::text, '') = ''))
	and		dt_atual_w	between trunc(a.dt_inicial) and fim_dia(trunc(a.dt_final))
	and		coalesce(Obter_Se_Feriado(cd_estabelecimento_p, dt_atual_w),0) = 0;

C02 CURSOR FOR
	SELECT 	to_date(to_char(dt_atual_w, 'dd/mm/yyyy')||' '||to_char(hr_inicial, 'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss'),
			to_date(to_char(dt_atual_w, 'dd/mm/yyyy')||' '||to_char(hr_final, 'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss')
	from   	agenda_horario
	where  	cd_agenda = cd_agenda_p
	and    	((dt_dia_semana = ie_dia_sem_w) or (dt_dia_semana = 9 and (PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1)) or (dt_dia_semana in (nr_dia_sabado_w,nr_dia_domingo_w)))
	and		dt_atual_w between dt_inicio_vigencia and dt_final_vigencia;
	
C03 CURSOR FOR
	SELECT	dt_agenda
	from	agenda_consulta
	where	dt_agenda between trunc(dt_atual_w) and fim_dia(dt_atual_w)
	and 	cd_agenda = cd_agenda_p
	and	ie_status_agenda = 'L'
	order by dt_agenda;
	
C04 CURSOR FOR
	SELECT	hr_inicio
	from	agenda_paciente
	where	dt_agenda between trunc(dt_atual_w) and fim_dia(dt_atual_w)
	and 	cd_agenda = cd_agenda_p
	and	ie_status_agenda = 'L'
	order by hr_inicio;

BEGIN
ie_cons_se_leg_dia_nao_lib_w := Obter_Param_Usuario(821, 420, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_cons_se_leg_dia_nao_lib_w);
ie_cons_se_leg_dia_nao_lib_ww := Obter_Param_Usuario(820, 374, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_cons_se_leg_dia_nao_lib_ww);
ie_cons_leg_bloq_fim_sem_w := Obter_Param_Usuario(820, 406, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_cons_leg_bloq_fim_sem_w);
ie_gerar_hor_passado_w := Obter_Param_Usuario(866, 133, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_gerar_hor_passado_w);
ie_todos_dias_regra_w := Obter_Param_Usuario(866, 120, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_todos_dias_regra_w);

if (wheb_usuario_pck.get_cd_funcao = 821) then
	ie_cons_leg_bloq_fim_sem_w := Obter_Param_Usuario(821, 483, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_cons_leg_bloq_fim_sem_w);
end if;

IF	((Dt_final_p - dt_inicial_p) > 255) THEN
	CALL wheb_mensagem_pck.exibir_mensagem_abort(200597);
END IF;

if (coalesce(cd_turno_p::text, '') = '') then
	cd_turno_w := '2';
else
	cd_turno_w := cd_turno_p;
end if;

SELECT	CASE WHEN COUNT(*)=0 THEN 'N'  ELSE 'S' END
INTO STRICT	ie_agenda_valida_w
FROM	agenda
WHERE	cd_agenda = cd_agenda_p;

qt_dia_semana_w		:= 1;
nr_dia_sabado_w		:= 0;
nr_dia_domingo_w	:= 0;
while	(((nr_dia_sabado_w = 0) or (nr_dia_domingo_w = 0)) and (qt_dia_semana_w <= 7)) loop
	
	select	to_char(next_day(clock_timestamp(),qt_dia_semana_w),'DY','NLS_DATE_LANGUAGE=ENGLISH')
	into STRICT	ds_dia_semana_w
	;
	
	if (ds_dia_semana_w = 'SAT') then
		nr_dia_sabado_w := qt_dia_semana_w;
	elsif (ds_dia_semana_w = 'SUN') then
		nr_dia_domingo_w := qt_dia_semana_w;
	end if;
	
	qt_dia_semana_w := qt_dia_semana_w + 1;
end loop;

if (nr_dia_sabado_w = 0) then
	nr_dia_sabado_w		:= 7;
end if;

if (nr_dia_domingo_w = 0) then
	nr_dia_domingo_w	:= 1;
end if;

IF (ie_agenda_valida_w = 'S') THEN
	BEGIN
	SELECT (MAX(Obter_Valor_Param_Usuario(820, 118, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)))
	INTO STRICT	ie_gerar_hor_livre_w
	;

	SELECT	cd_tipo_agenda,
		ie_feriado
	INTO STRICT	cd_tipo_agenda_w,
		ie_feriado_w
	FROM 	agenda
	WHERE cd_agenda 	= cd_agenda_p;

	if	((cd_tipo_agenda_w = 3) or (cd_tipo_agenda_w = 4)) and (ie_cons_se_leg_dia_nao_lib_w = 'S')then
		select	substr(max(nr_dias_fut_agendamento),1,9)
		into STRICT	qt_dias_fut_w
		from	agenda
		where	cd_agenda = cd_agenda_p;

		if (coalesce(qt_dias_fut_w::text, '') = '') and (ie_cons_se_leg_dia_nao_lib_w = 'S')then
			SELECT	substr(MAX(Obter_Valor_Param_Usuario(821, 5, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)),1,9)
			INTO STRICT	qt_dias_fut_w
			;
			--substr(obter_param_usuario(821, 5, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, qt_dias_fut_w),1,10);
		end if;

		select	max(cd_pessoa_fisica)
		into STRICT	cd_pessoa_usuario_w
		from	usuario
		where	nm_usuario = nm_usuario_p;

		if (obter_se_ignorar_dias_fut(cd_pessoa_usuario_w,cd_agenda_p,null) = 'S') then
			qt_dias_fut_w := 0;
		end if;
	elsif (cd_tipo_agenda_w = 2) and (ie_cons_se_leg_dia_nao_lib_ww = 'S')then
			select	substr(max(nr_dias_fut_agendamento),1,9)
			into STRICT	qt_dias_fut_w
			from	agenda
			where	cd_agenda = cd_agenda_p;

			if (coalesce(qt_dias_fut_w::text, '') = '') and (ie_cons_se_leg_dia_nao_lib_ww = 'S')then
				SELECT	substr(MAX(Obter_Valor_Param_Usuario(820, 4, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)),1,9)
				INTO STRICT	qt_dias_fut_w
				;
			end if;

	end if;

	ie_status_w					:= '';
	dt_atual_w					:= TRUNC(dt_inicial_p, 'dd');
	WHILE(dt_atual_w	<= TRUNC(dt_final_p,'dd')) LOOP
		BEGIN
		ie_status_dia_w			:= 'X';
		qt_bloqueio_w			:= 0;

  
    
		ie_dia_semana_w	:= obter_cod_dia_semana(dt_atual_w);


		SELECT 	coalesce(MAX('S'),'N')
		into STRICT	ie_dia_feriado_w
		from 	feriado
		where 	cd_estabelecimento 	= cd_estabelecimento_p
		and 	dt_feriado		= dt_atual_w;

		SELECT 	COUNT(*)
		INTO STRICT	qt_bloqueio_w
		FROM	agenda_bloqueio
		WHERE	cd_agenda	= cd_agenda_p
		AND 	TRUNC(dt_inicial,'dd')	<= trunc(dt_atual_w,'dd')
		AND 	TRUNC(dt_final,'dd')	>= trunc(dt_atual_w,'dd')
		AND		((coalesce(ie_dia_semana,ie_dia_semana_w) = ie_dia_semana_w) OR
				((ie_dia_semana	= 9) AND (PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1) or --#FIX_I18N 
				((ie_cons_leg_bloq_fim_sem_w = 'S') and (PKG_DATE_UTILS.is_business_day(dt_atual_w) = 0) ))); --#FIX_I18N 
		qt_horario_w			:= 0;
		qt_horario_livre_w		:= 0;
		qt_total_hor_bloq_per_w	:= 0;
		ie_turno_valido_w := 'N';

		/*AGENDA DE CONSULTAS / SERVICOS*/

		IF (cd_tipo_agenda_w > 2) THEN
			if (cd_tipo_agenda_w = 5) then
				begin

				/*AGENDA DE SERVICOS*/

				SELECT	/*+ index (a AGECONS_UK) */						SUM(CASE WHEN ie_status_agenda='L' THEN 0  ELSE 1 END ),
						SUM(CASE WHEN ie_status_agenda='L' THEN 1  ELSE CASE WHEN ie_status_agenda='LF' THEN 1  ELSE 0 END  END ),
						SUM(CASE WHEN ie_status_agenda='B' THEN 1  ELSE 0 END ),
						SUM(CASE WHEN(case ie_status_agenda								WHEN 'L' then null								WHEN 'B' then null								WHEN 'LF' then null								WHEN 'C' then null								WHEN 'R' then '1'								WHEN 'N' then '1'								ELSE coalesce(cd_pessoa_fisica, nm_paciente)							end) IS NULL THEN 0  ELSE 1 END )
				INTO STRICT	qt_horario_w,
						qt_horario_livre_w,
						qt_horario_bloqueado_w,
						qt_horario_ocupado_w
				FROM 	agenda_consulta
				WHERE 	cd_agenda		= cd_agenda_p
				and		((cd_turno		= cd_turno_w) or (cd_turno_w = '2'))
				AND		dt_agenda between trunc(dt_atual_w) and fim_dia(dt_atual_w)
				AND		ie_status_agenda	<> 'C'
				AND		ie_status_agenda	<> 'II';

				--Validar para os casos em que a agenda nao gerar horarios passados, devera ser mantido o historico de agendamento do que ja esta gravado na tabela AGENDA_CONSULTA
				if (qt_horario_w > 0) or (qt_horario_livre_w > 0) or (qt_horario_bloqueado_w > 0) or (qt_horario_ocupado_w > 0) then
					ie_manter_hist_horarios_w	:= 'S';
				else
					ie_manter_hist_horarios_w	:= 'N';
				end if;

				qt_horario_w			:= null;
				qt_horario_livre_w		:= null;
				qt_horario_bloqueado_w	:= null;
				qt_horario_ocupado_w	:= null;

				select	'S'
				into STRICT	ie_turno_valido_w
				from	(	SELECT	1
							FROM 	agenda_Turno a
							WHERE 	cd_agenda	= cd_agenda_p
							AND 	ie_dia_semana	= ie_dia_Semana_w
							AND 	hr_inicial 	< hr_final
							AND		((coalesce(dt_inicio_vigencia::text, '') = '') OR (trunc(dt_inicio_vigencia) <= TRUNC(dt_atual_w)))
							AND		((coalesce(dt_final_vigencia::text, '') = '') OR (trunc(dt_final_vigencia) >= TRUNC(dt_atual_w)))
							--AND	(ie_feriado_w 	<> 'S')
							AND		((ie_dia_feriado_w = 'S' AND ie_feriado_w = 'S') or (ie_dia_feriado_w = 'N'))
							AND		obter_se_gerar_turno_agecons(dt_inicio_vigencia,ie_frequencia,dt_atual_w) = 'S'
							AND (TO_DATE(TO_CHAR(dt_atual_w,'dd/mm/yyyy') || ' ' ||TO_CHAR(hr_inicial,'hh24:mi'),'dd/mm/yyyy hh24:mi:ss') > clock_timestamp() and (ie_gerar_hor_passado_w = 'N')
									or (ie_gerar_hor_passado_w = 'S') or (ie_manter_hist_horarios_w = 'S'))
							and		((Obter_Semana_Dia_Agecons(dt_atual_w,ie_dia_semana) = coalesce(ie_semana,0)) or (coalesce(ie_semana,0) = 0))
							
UNION

							SELECT	1
							FROM 	agenda_Turno
							WHERE 	cd_agenda     	= cd_agenda_p
							AND 	ie_dia_semana	= 9
							AND 	hr_inicial 	< hr_final
							AND		((coalesce(dt_inicio_vigencia::text, '') = '') OR (trunc(dt_inicio_vigencia) <= TRUNC(dt_atual_w)))
							AND		((coalesce(dt_final_vigencia::text, '') = '') OR (trunc(dt_final_vigencia) >= TRUNC(dt_atual_w)))
							AND (PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1)  --#FIX_I18N 
							--AND	(ie_feriado_w 	<> 'S')
							AND		((ie_dia_feriado_w = 'S' AND ie_feriado_w = 'S') or (ie_dia_feriado_w = 'N'))
							AND		obter_se_gerar_turno_agecons(dt_inicio_vigencia,ie_frequencia,dt_atual_w) = 'S'
							and		((Obter_Semana_Dia_Agecons(dt_atual_w,ie_dia_semana) = coalesce(ie_semana,0)) or (coalesce(ie_semana,0) = 0))
							AND (TO_DATE(TO_CHAR(dt_atual_w,'dd/mm/yyyy') || ' ' ||TO_CHAR(hr_inicial,'hh24:mi'),'dd/mm/yyyy hh24:mi:ss') > clock_timestamp() and (ie_gerar_hor_passado_w = 'N')
									or (ie_gerar_hor_passado_w = 'S') or (ie_manter_hist_horarios_w = 'S'))
							AND	NOT EXISTS	(SELECT	1
											FROM 	agenda_Turno
											WHERE 	cd_agenda			= cd_agenda_p
											AND 	ie_dia_semana		= ie_dia_Semana_w
											and		ie_todos_dias_regra_w 	= 'N'
											AND		((coalesce(dt_inicio_vigencia::text, '') = '') OR (trunc(dt_inicio_vigencia) <= TRUNC(dt_atual_w)))
											AND		((coalesce(dt_final_vigencia::text, '') = '') OR (trunc(dt_final_vigencia) >= TRUNC(dt_atual_w)))
											and		((ie_dia_semana	= ie_dia_Semana_w) or ((ie_dia_semana = 9) and (PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1) )) --#FIX_I18N 
											)
						) alias81 LIMIT 1;
				exception
				when others then
					ie_turno_valido_w := 'N';
				end;
			else

				select		coalesce(max(nr_sequencia),0),
							coalesce(max(ie_horario_adicional), 'N')
				into STRICT		nr_seq_esp_w,
							ie_horario_adicional_w
				from		agenda_turno_esp
				where		cd_agenda	= cd_agenda_p
				and			((ie_dia_semana = ie_dia_semana_w) or ((ie_dia_semana = 9) and PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1) or (coalesce(ie_dia_semana::text, '') = '')) --#FIX_I18N 
				and			obter_se_turno_esp_agecons_vig(dt_agenda,dt_agenda_fim,dt_atual_w) = 'S';

				begin

					select 'S'
					into STRICT	ie_turno_valido_w
					from	(	SELECT 	1
								from 	agenda_Turno_Esp a
								where 	cd_agenda     	= cd_agenda_p
								and		((ie_dia_semana = ie_dia_semana_w) or ((ie_dia_semana = 9) and PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1) or (coalesce(ie_dia_semana::text, '') = '')) ---#FIX_I18N 
								and		((obter_se_feriado(cd_estabelecimento_p, dt_atual_w) = 0) or (obter_se_agenda_feriado(cd_agenda_p) = 'S'))
								--and	dt_agenda		= trunc(dt_atual_w,'dd')
								and		obter_se_turno_esp_agecons_vig(dt_agenda,dt_agenda_fim,dt_atual_w) = 'S'
								--and 	hr_inicial 		< hr_final
								and		to_char(hr_inicial,'hh24:mi:ss') < to_char(hr_final,'hh24:mi:ss')
								and		nr_minuto_intervalo	> 0
								and		nr_seq_esp_w		> 0
								
union

								SELECT 	1
								from 	agenda_Turno a
								where 	cd_agenda     		= cd_agenda_p
								and		((ie_dia_semana = ie_dia_semana_w) or ((ie_dia_semana = 9) and PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1)) --#FIX_I18N 
								--and 	hr_inicial 			< hr_final
								and		to_char(hr_inicial,'hh24:mi:ss') < to_char(hr_final,'hh24:mi:ss')
								and		((coalesce(dt_inicio_vigencia::text, '') = '') or (trunc(dt_inicio_vigencia) <= trunc(dt_atual_w)))
								and		((coalesce(dt_final_vigencia::text, '') = '') or (trunc(dt_final_vigencia) >= trunc(dt_atual_w)))
								and		coalesce(nr_minuto_intervalo,0) > 0
								and		((((ie_feriado_w <> 'S') and (coalesce(ie_feriado,'X') <> 'F')) or (coalesce(ie_feriado,obter_se_agenda_feriado(cd_agenda_p)) = 'S')) or ((ie_feriado = 'F' AND ie_feriado_w = 'S') or (ie_feriado = 'N' AND ie_dia_feriado_w <> 'S')))
								and (nr_seq_esp_w = 0 or ie_horario_adicional_w = 'S')
								and		obter_se_gerar_turno_agecons(dt_inicio_vigencia,ie_frequencia,dt_atual_w) = 'S'
								and		((Obter_Semana_Dia_Agecons(dt_atual_w,ie_dia_semana) = coalesce(ie_semana,0)) or (coalesce(ie_semana,0) = 0))
							) alias55 LIMIT 1;
				exception
				when others then
					ie_turno_valido_w := 'N';
				end;
			end if;

		/*AGENDA DE EXAMES*/

		else

			select	coalesce(max(nr_sequencia),0),
					coalesce(max(ie_horario_adicional),'N')
			into STRICT	nr_seq_esp_w,
					ie_horario_adicional_w
			from	agenda_horario_esp
			where	cd_agenda	= cd_agenda_p
			and		((ie_dia_semana = ie_dia_semana_w) or ((ie_dia_semana = 9) and PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1) or (coalesce(ie_dia_semana::text, '') = '')) --#FIX_I18N 
			and		dt_atual_w between pkg_date_utils.start_of(dt_agenda,'DAY') and pkg_date_utils.end_of(coalesce(dt_agenda_fim,dt_agenda),'DAY');

			begin
			select 'S'
			into STRICT	ie_turno_valido_w
			from	(	SELECT 	1
						from 	agenda_Horario a
						where 	cd_agenda     	= cd_agenda_p
						and		((dt_dia_semana = ie_dia_semana_w) or ((dt_dia_semana = 9) and PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1)) --#FIX_I18N 
						and		((nr_seq_esp_w 	= 0) or (ie_horario_adicional_w = 'S'))
						and		((coalesce(dt_final_vigencia::text, '') = '') or (trunc(dt_final_vigencia) >= trunc(dt_atual_w)))
						and		((coalesce(dt_inicio_vigencia::text, '') = '') or (trunc(dt_inicio_vigencia) <= trunc(dt_atual_w)))
						and		to_char(hr_inicial,'hh24:mi:ss') < to_char(hr_final,'hh24:mi:ss')
						and		coalesce(nr_minuto_intervalo,0) > 0
						--AND		(((ie_dia_feriado_w = 'S') and ((ie_feriado_w = 'S') or (obter_se_agenda_feriado(cd_agenda_p) = 'S'))) or (ie_dia_feriado_w = 'N'))
						and		((((ie_feriado_w <> 'S') and (coalesce(ie_feriado,'X') <> 'F')) or (coalesce(ie_feriado,obter_se_agenda_feriado(cd_agenda_p)) = 'S')) or
									((ie_feriado = 'F' AND ie_feriado_w = 'S') or
									(ie_feriado = 'N' AND ie_dia_feriado_w <> 'S')))
						--and	((ie_feriado_w <> 'S') or (obter_se_agenda_feriado(cd_agenda_p) = 'S'))
						and (obter_se_gerar_turno_agecons(dt_inicio_vigencia,ie_frequencia,dt_atual_w) = 'S')
						and 	((Obter_Semana_Dia_Agecons(dt_atual_w,dt_dia_semana) = coalesce(ie_semana,0)) or (coalesce(ie_semana,0) = 0))
						
union

						SELECT 	1
						from 	agenda_Horario_esp a
						where 	hr_inicial < hr_final
						and		coalesce(nr_minuto_intervalo,0) > 0
						and 	cd_agenda	= cd_agenda_p
						and		((ie_dia_semana = ie_dia_semana_w) or ((ie_dia_semana = 9) and PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1) or (coalesce(ie_dia_semana::text, '') = '')) --#FIX_I18N 
						and 	dt_atual_w between pkg_date_utils.start_of(dt_agenda,'DAY') and pkg_date_utils.end_of(coalesce(dt_agenda_fim,dt_agenda),'DAY')
					) alias54 LIMIT 1;
			exception
			when others then
				ie_turno_valido_w := 'N';
			end;

		end if;



		-->> MANTER ESTE IF PARA FINS DE LOG PARA DEBUGAR A ROTINA

		/*if	(to_char(dt_atual_w,'dd/mm/yyyy') = '27/05/2015') then
			R a i s e_application_error(-20011,ie_turno_valido_w || ' - ' || cd_agenda_p || ' - ' || ie_dia_Semana_w || ' - ' || to_char(dt_atual_w,'dd/mm/yyyy') || ' - ' ||
									ie_feriado_w || ' - ' || ie_gerar_hor_passado_w || ' - ' || qt_bloqueio_w);
		end if;*/
		if (coalesce(ie_turno_valido_w,'N') = 'N') and (PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1)  and --#FIX_I18N 
			(qt_bloqueio_w = 0)then

			ie_status_dia_w	:= 'N';

		else

			IF (cd_tipo_agenda_w > 2) THEN
				BEGIN

				/*AGENDA DE CONSULTAS*/

				SELECT	/*+ index (a AGECONS_UK) */						SUM(CASE WHEN ie_status_agenda='L' THEN 0  ELSE 1 END ),
						SUM(CASE WHEN ie_status_agenda='L' THEN 1  ELSE CASE WHEN ie_status_agenda='LF' THEN 1  ELSE 0 END  END ),
						SUM(CASE WHEN ie_status_agenda='B' THEN 1  ELSE 0 END ),
						SUM(CASE WHEN(case ie_status_agenda								WHEN 'L' then null								WHEN 'B' then null								WHEN 'LF' then null								WHEN 'C' then null								WHEN 'R' then '1'								WHEN 'N' then '1'								ELSE coalesce(cd_pessoa_fisica, nm_paciente)							end) IS NULL THEN 0  ELSE 1 END ),
						SUM(CASE WHEN coalesce(ie_bloqueado_manual, 'N')='N' THEN  0  ELSE 1 END )
				INTO STRICT	qt_horario_w,
						qt_horario_livre_w,
						qt_horario_bloqueado_w,
						qt_horario_ocupado_w,
						qt_bloqueado_manual_w
				FROM 	agenda_consulta
				WHERE 	cd_agenda		= cd_agenda_p
				and	((cd_turno		= cd_turno_w) or (cd_turno_w = '2'))
				AND	dt_agenda between trunc(dt_atual_w) and fim_dia(dt_atual_w)
				AND	ie_status_agenda	<> 'C'
				and ie_status_agenda	<> 'II';

				if (qt_bloqueio_w = 0 AND qt_bloqueado_manual_w = 0) then
					qt_horario_bloqueado_w := 0;
				end if;

				SELECT 	COUNT(*)
					INTO STRICT	qt_regra_horario_w
					FROM	agenda_Turno
					WHERE 	cd_agenda     	= cd_agenda_p
					AND		((ie_dia_semana	= ie_dia_semana_w) OR
							((ie_dia_semana	= 9) AND PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1)) --#FIX_I18N 
					AND 	coalesce(dt_final_vigencia,dt_atual_w) >= dt_atual_w
					AND 	coalesce(dt_inicio_vigencia,dt_atual_w) <= dt_atual_w;

				IF	(((coalesce(qt_horario_livre_w,0) = 0) and (cd_tipo_agenda_w = 5)) or
					(qt_regra_horario_w = 0 AND cd_tipo_agenda_w = 5)) THEN
					BEGIN
					CALL Gerar_Horario_Agenda_Servico(
						cd_estabelecimento_p,
						cd_agenda_p,
						dt_atual_w,
						nm_usuario_p);

					SELECT	/*+ index (a AGECONS_UK) */							SUM(CASE WHEN ie_status_agenda='L' THEN 0  ELSE 1 END ),
							SUM(CASE WHEN ie_status_agenda='L' THEN 1  ELSE CASE WHEN ie_status_agenda='LF' THEN 1  ELSE 0 END  END ),
							SUM(CASE WHEN ie_status_agenda='B' THEN 1  ELSE 0 END ),
							SUM(CASE WHEN(case ie_status_agenda								WHEN 'L' then null								WHEN 'B' then null								WHEN 'LF' then null								WHEN 'C' then null								WHEN 'R' then '1'								WHEN 'N' then '1'								ELSE coalesce(cd_pessoa_fisica, nm_paciente)							end) IS NULL THEN 0  ELSE 1 END )
					INTO STRICT	qt_horario_w,
							qt_horario_livre_w,
							qt_horario_bloqueado_w,
							qt_horario_ocupado_w
					FROM 	agenda_consulta
					WHERE 	cd_agenda		= cd_agenda_p
					AND	dt_agenda between trunc(dt_atual_w) and fim_dia(dt_atual_w)
					AND	ie_status_agenda	<> 'C';

					END;
				END IF;

				IF	(((dt_atual_w >= TRUNC(clock_timestamp(), 'dd')) and (coalesce(qt_horario_livre_w,0) = 0)) or (qt_regra_horario_w = 0)) and (cd_tipo_agenda_w <> 5) THEN
					BEGIN
					ds_retorno_w := Horario_Livre_Consulta(
						cd_estabelecimento_p, cd_agenda_p, 'N', dt_atual_w, obter_desc_expressao(314533), ie_gravar_w, ie_sobra_horario_w, 'N', 0, ds_retorno_w);
					qt_horario_livre_w	:= coalesce(length(REGEXP_REPLACE(ds_retorno_w, '[^:]', '')), 0);

					END;
				END IF;



				/* Bruno */

				select	count(*)
				into STRICT	ie_existe_hor_gerado_w
				from 	agenda_consulta where cd_agenda = cd_agenda_p
				and	((cd_turno		= cd_turno_w) or (cd_turno_w = '2'))
				and	dt_agenda between trunc(dt_atual_w) and fim_dia(dt_atual_w)
				and	ie_status_agenda in ('L','LF');

				if (ie_existe_hor_gerado_w <> 0) then
					SELECT	/*+ index (a AGECONS_UK) */						SUM(CASE WHEN ie_status_agenda='L' THEN 1  ELSE CASE WHEN ie_status_agenda='LF' THEN 1  ELSE 0 END  END )
					INTO STRICT	qt_horario_livre_w
					FROM	agenda_consulta
					WHERE	cd_agenda		= cd_agenda_p
					and	((cd_turno		= cd_turno_w) or (cd_turno_w = '2'))
					AND	dt_agenda between trunc(dt_atual_w) and fim_dia(dt_atual_w)
					AND	ie_status_agenda	<> 'C'
					AND	((ie_classif_agenda NOT IN (	SELECT cd_classificacao
										FROM   agenda_classif
										WHERE  ie_nao_considera_mensal = 'S'))
					OR (coalesce(ie_classif_agenda::text, '') = ''	));
				end if;

				/*if	(to_char(dt_atual_w,'dd/mm/yyyy') = '27/05/2015') then
					R a i s e_application_error(-20011,ie_turno_valido_w || ' - ' || cd_agenda_p || ' - ' || ie_dia_Semana_w || ' - ' || to_char(dt_atual_w,'dd/mm/yyyy') || ' - ' ||
									ie_feriado_w || ' - ' || ie_gerar_hor_passado_w || ' - ' || qt_bloqueio_w || ' - ' || qt_horario_livre_w|| ' - ' || qt_horario_bloqueado_w);
				end if;*/


				--O qt_horario_w so e atualizado se os horarios livres estiverem gerados para o dia, caso contrario, atualiza o mesmo com base no bloqueio da agenda, se existir...
				if (nr_seq_item_p > 0) then
				
					select 	max(c.ie_classif_agenda),
						max(c.nr_seq_classif_agenda),
						max(c.cd_procedimento),
						max(c.nr_seq_proc_interno),
						max(c.ie_origem_proced)
					into STRICT	ie_classif_item_w,
						nr_seq_classif_agenda_item_w,
						cd_procedimento_w,
						nr_seq_proc_interno_w,
						ie_origem_proced_w
					from 	agenda_integrada_item c
					WHERE	c.nr_sequencia	= nr_seq_item_p;
					for regra_bloquei_cad_gerais in C03 loop

						dt_agenda_exame_consulta_w := regra_bloquei_cad_gerais.dt_agenda;

						nr_seq_regra_bloq_w := obter_se_bloq_geral_agenda(cd_estabelecimento_p,
												cd_agenda_p,
												ie_classif_item_w,
												nr_seq_classif_agenda_item_w,
												null,
												obter_setor_regras_ageint(cd_tipo_agenda_w,cd_agenda_p,cd_procedimento_w,'N',nm_usuario_p,cd_estabelecimento_p),
												nr_seq_proc_interno_w,
												cd_procedimento_w,
												ie_origem_proced_w,
												cd_medico_p,
												dt_agenda_exame_consulta_w,
												'N',
												'N');
						if (nr_seq_regra_bloq_w > 0) then
							qt_horario_bloqueado_w	:=  qt_horario_bloqueado_w + 1;
							qt_horario_livre_w	:=  qt_horario_livre_w - 1;
							qt_horario_w := greatest(qt_horario_w,1);
						end if;
					
					end loop;
				end if;
				
				if (coalesce(qt_horario_w,0) = 0) or (coalesce(qt_horario_bloqueado_w,0) = 0)then
					begin

					ie_dia_sem_w	:= obter_cod_dia_semana(dt_atual_w);

					--Busca seq. do turno atual(caso exista mais de 1)
					select	max(coalesce(nr_sequencia,0))
					into STRICT	nr_seq_turno_w
					from	agenda_turno
					where	coalesce(dt_inicio_vigencia, dt_atual_w) <= trunc(dt_atual_w)
					and		coalesce(dt_final_vigencia, dt_atual_w) >= trunc(dt_atual_w)
					and		nr_minuto_intervalo > 0
					and		((ie_dia_semana = ie_dia_sem_w) or ((ie_dia_semana = 9) and PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1))
					and		cd_agenda = cd_agenda_p;

					--Se possuir turno, busca os minutos de intervalo dos horarios
					if (nr_seq_turno_w > 0)then

						select	max(coalesce(a.nr_minuto_intervalo,0))
						into STRICT	nr_minuto_intervalo_w
						from	agenda_turno a
						where  	a.cd_agenda     	= cd_agenda_p
						and		a.nr_sequencia		= nr_seq_turno_w
						and		(((a.ie_dia_semana = 9) and PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1)
						or		(a.ie_dia_semana <> 9 AND ie_dia_sem_w = a.ie_dia_semana))
						and		coalesce(Obter_Se_Feriado(cd_estabelecimento_p, dt_atual_w),0) = 0;

						if (nr_minuto_intervalo_w > 0) then
							open C01;
							loop
							fetch C01 into
								qt_hor_bloq_per_w;
							EXIT WHEN NOT FOUND; /* apply on C01 */
								begin
								qt_total_hor_bloq_per_w		:= qt_hor_bloq_per_w		+ qt_total_hor_bloq_per_w;
								end;
							end loop;
							close C01;

						end if;

					end if;
					if (coalesce(qt_total_hor_bloq_per_w,0) > 0)then
						qt_horario_w 			:= qt_total_hor_bloq_per_w;
					end if;

					if (coalesce(qt_total_hor_bloq_per_w,0) > 0)then
						qt_horario_bloqueado_w := qt_total_hor_bloq_per_w;
					end if;

					exception
					when others then
						qt_horario_w := 0;
					end;
				end if;
				END;
			ELSE
				BEGIN
				/*AGENDA DE EXAMES*/

				SELECT	/*+ INDEX(A AGEPACI_UK) */						SUM(CASE WHEN ie_status_agenda='L' THEN 0  ELSE 1 END ),
						SUM(CASE WHEN ie_status_agenda='L' THEN 1  ELSE CASE WHEN ie_status_agenda='LF' THEN 1  ELSE 0 END  END ),
						SUM(CASE WHEN ie_status_agenda='B' THEN 1  ELSE 0 END ),
						SUM(CASE WHEN(case ie_status_agenda								WHEN 'L' then null								WHEN 'B' then null								WHEN 'LF' then null								WHEN 'C' then null								WHEN 'R' then '1'								WHEN 'N' then '1'								ELSE coalesce(cd_pessoa_fisica, nm_paciente)							end) IS NULL THEN 0  ELSE 1 END ) qt_horario_ocupado_w
				INTO STRICT	qt_horario_w,
						qt_horario_livre_w,
						qt_horario_bloqueado_w,
						qt_horario_ocupado_w
				FROM	agenda_Paciente
				WHERE	cd_agenda				= cd_agenda_p
				AND		dt_agenda between trunc(dt_atual_w) and fim_dia(dt_atual_w)
				AND		ie_status_agenda		<> 'C';

				IF	((dt_atual_w >= clock_timestamp()) AND (coalesce(qt_horario_livre_w,0) = 0)) OR
					((ie_gerar_hor_livre_w	= 'S') AND (dt_atual_w <= clock_timestamp()) AND (coalesce(qt_horario_livre_w,0) > 0)) THEN
					BEGIN
					ds_horarios_w
								 := Obter_Horarios_Livres( cd_estabelecimento_p, cd_agenda_p, dt_atual_w, dt_atual_w, 0, NULL, NULL, NULL, 'Tasy', 'N', ds_horarios_w
								);

					qt_horario_livre_w	:= LENGTH(ds_horarios_w);

					END;
				END IF;

				select	count(*)
				into STRICT	ie_existe_hor_gerado_w
				from 	agenda_paciente
				where 	cd_agenda = cd_agenda_p
				and		dt_agenda between trunc(dt_atual_w) and fim_dia(dt_atual_w)
				and		ie_status_agenda in ('L','LF');
				qt_bloqueio_sem_horario_w := 0;

				if (cd_tipo_agenda_w = 2 and ie_existe_hor_gerado_w = 0)then
					CALL Gerar_Horario_Agenda_Exame(cd_estabelecimento_p, cd_agenda_p, dt_atual_w, nm_usuario_p);
				end if;

				if (ie_existe_hor_gerado_w <> 0) then
					SELECT	/*+ INDEX(A AGEPACI_UK) */							SUM(CASE WHEN ie_status_agenda='L' THEN 1  ELSE CASE WHEN ie_status_agenda='LF' THEN 1  ELSE 0 END  END )
					INTO STRICT	qt_horario_livre_w
					FROM	agenda_Paciente
					WHERE	cd_agenda		= cd_agenda_p
					AND		dt_agenda between trunc(dt_atual_w) and fim_dia(dt_atual_w)
					AND		ie_status_agenda	<> 'C'
					AND		((nr_seq_classif_agenda NOT IN (	SELECT	nr_sequencia
																FROM   	agenda_paciente_classif
																WHERE  	ie_agenda_mensal = 'S'))
					OR (coalesce(nr_seq_classif_agenda::text, '') = ''	));

				else

					select  count(*)
					into STRICT	qt_bloqueio_sem_horario_w
					from    agenda_bloqueio
					where   cd_agenda     = cd_agenda_p
					and     dt_atual_w between dt_inicial and dt_final
					AND		((coalesce(ie_dia_semana,ie_dia_semana_w) = ie_dia_semana_w) OR
							((ie_dia_semana	= 9) AND (PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1)) or
							((ie_cons_leg_bloq_fim_sem_w = 'S') and (PKG_DATE_UTILS.is_business_day(dt_atual_w) = 0) ));--#FIX_I18N 
					if (qt_bloqueio_sem_horario_w > 0) then


						ie_dia_sem_w	:= obter_cod_dia_semana(dt_atual_w);


						open C02;
						loop
						fetch C02 into
							hr_inicio_agenda_w,
							hr_final_agenda_w;
						EXIT WHEN NOT FOUND; /* apply on C02 */
							begin
							if (hr_inicio_agenda_w IS NOT NULL AND hr_inicio_agenda_w::text <> '')
								and (hr_final_agenda_w IS NOT NULL AND hr_final_agenda_w::text <> '')
								and (qt_bloqueio_sem_horario_w > 0) then

									select	count(*)
									into STRICT	qt_bloqueio_sem_horario_w
									from    agenda_bloqueio b,
										agenda_horario h
									where   b.cd_agenda    = h.cd_agenda
									and	b.cd_agenda    = cd_agenda_p
									and     dt_atual_w between b.dt_inicial and b.dt_final
									--Caso nao possua dia da semana informado nos bloqueios valida pela data nos horarios cadastrados.
									and	(((coalesce(b.ie_dia_semana::text, '') = '') and
										(h.dt_dia_semana = ie_dia_sem_w or ((h.dt_dia_semana = 9) and (PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1))))
									--Caso possua dia da semana informado faz a validacao;
										or ((b.ie_dia_semana = ie_dia_sem_w) or
										((b.ie_dia_semana = 9) and (PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1))))
									and	((coalesce(b.hr_inicio_bloqueio::text, '') = '' and coalesce(b.hr_final_bloqueio::text, '') = '')
										or (coalesce(b.hr_inicio_bloqueio::text, '') = '' and to_date(to_char(dt_atual_w, 'dd/mm/yyyy')||' '||to_char(b.hr_final_bloqueio, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') >= hr_final_agenda_w)
										or (coalesce(b.hr_final_bloqueio::text, '') = '' and to_date(to_char(dt_atual_w, 'dd/mm/yyyy')||' '||to_char(b.hr_inicio_bloqueio, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') <= hr_inicio_agenda_w)
										or (to_date(to_char(dt_atual_w, 'dd/mm/yyyy')||' '||to_char(b.hr_inicio_bloqueio, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') <= hr_inicio_agenda_w
										and to_date(to_char(dt_atual_w, 'dd/mm/yyyy')||' '||to_char(b.hr_final_bloqueio, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') >= hr_final_agenda_w))
									and	coalesce(Obter_Se_Feriado(cd_estabelecimento_p, dt_atual_w),0) = 0;

							end if;
							end;
						end loop;
						close C02;
					end if;
				end if;



				--O qt_horario_w so e atualizado se os horarios livres estiverem gerados para o dia, caso contrario, atualiza o mesmo com base no bloqueio da agenda, se existir...
				if (nr_seq_item_p > 0) then

					select 	max(c.ie_classif_agenda),
						max(c.nr_seq_classif_agenda),
						max(c.cd_procedimento),
						max(c.nr_seq_proc_interno),
						max(c.ie_origem_proced)
					into STRICT	ie_classif_item_w,
						nr_seq_classif_agenda_item_w,
						cd_procedimento_w,
						nr_seq_proc_interno_w,
						ie_origem_proced_w
					from 	agenda_integrada_item c
					WHERE	c.nr_sequencia	= nr_seq_item_p;

					for regra_bloquei_cad_gerais in C04 loop
						dt_agenda_exame_consulta_w := regra_bloquei_cad_gerais.hr_inicio;
					
						nr_seq_regra_bloq_w := obter_se_bloq_geral_agenda(cd_estabelecimento_p,
												cd_agenda_p,
												ie_classif_item_w,
												nr_seq_classif_agenda_item_w,
												null,
												obter_setor_regras_ageint(cd_tipo_agenda_w,cd_agenda_p,cd_procedimento_w,'N',nm_usuario_p,cd_estabelecimento_p),
												nr_seq_proc_interno_w,
												cd_procedimento_w,
												ie_origem_proced_w,
												cd_medico_p,
												dt_agenda_exame_consulta_w,
												'N',
												'N');
						if (nr_seq_regra_bloq_w > 0) then
							qt_horario_bloqueado_w	:=  qt_horario_bloqueado_w + 1;
							qt_horario_livre_w	:=  qt_horario_livre_w - 1;
							qt_horario_w := greatest(qt_horario_w,1);
						end if;
					
					end loop;
				end if;
				
				if (coalesce(qt_horario_w,0) = 0) or (coalesce(qt_horario_bloqueado_w,0) = 0)then
					begin
					ie_dia_sem_w	:= obter_cod_dia_semana(dt_atual_w);


					--Busca seq. do turno atual(caso exista mais de 1)
					select	max(coalesce(nr_sequencia,0))
					into STRICT	nr_seq_turno_w
					from	agenda_horario
					where	to_char(clock_timestamp(),'hh24:mi:ss') between to_char(hr_inicial,'hh24:mi:ss') and to_char(hr_final,'hh24:mi:ss')
					and		trunc(coalesce(dt_inicio_vigencia, dt_atual_w)) <= trunc(dt_atual_w)
					and		trunc(coalesce(dt_final_vigencia, dt_atual_w)) >= trunc(dt_atual_w)
					and		nr_minuto_intervalo > 0
					and		((dt_dia_semana = ie_dia_sem_w) or ((dt_dia_semana = 9) and (PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1)))
					and		cd_agenda = cd_agenda_p;

					--Se possuir turno, busca os minutos de intervalo dos horarios
					if (nr_seq_turno_w > 0)then

						select	max(coalesce(a.nr_minuto_intervalo,0))
						into STRICT	nr_minuto_intervalo_w
						from	agenda_horario a
						where  	a.cd_agenda     	= cd_agenda_p
						and		a.nr_sequencia		= nr_seq_turno_w
						and		(((a.dt_dia_semana = 9) and (PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1))
						or		(a.dt_dia_semana <> 9 AND ie_dia_sem_w = a.dt_dia_semana)) --dia semana unico
						and		coalesce(Obter_Se_Feriado(cd_estabelecimento_p, dt_atual_w),0) = 0;

						if (nr_minuto_intervalo_w > 0)then
							open C01;
							loop
							fetch C01 into
								qt_hor_bloq_per_w;
							EXIT WHEN NOT FOUND; /* apply on C01 */
								begin
								qt_total_hor_bloq_per_w		:= qt_hor_bloq_per_w		+ qt_total_hor_bloq_per_w;
								end;
							end loop;
							close C01;

						end if;

					end if;
					if (coalesce(qt_total_hor_bloq_per_w,0) > 0)then
						qt_horario_w 			:= qt_total_hor_bloq_per_w;
					end if;

					if (coalesce(qt_total_hor_bloq_per_w,0) > 0)then
						qt_horario_bloqueado_w := qt_total_hor_bloq_per_w;
					end if;

					exception
					when others then
						qt_horario_w := 0;
					end;
				end if;
				END;
			END IF;

		/* Status por Dia
			L - Existem Livres
			F - Feriado
			B - Bloqueado
			N - Nao tem Agenda Dia
			X - Todos horarios Livres
			T - Todos Horarios Lotados
			D - Sabados e Domingos
			R - Nao liberado

		*/


			--Apenas fazer o if abaixo se a funcao aberta for a "Agenda de Exames" e se o dia possuir horarios gerados/turno cadastrado
			if (ie_cons_leg_bloq_fim_sem_w = 'S') and (wheb_usuario_pck.get_cd_funcao = 820) and (ie_existe_hor_gerado_w > 0)then
				BEGIN
				SELECT 	COUNT(*)
				INTO STRICT	qt_bloqueio_w
				FROM	agenda_bloqueio
				WHERE	cd_agenda	= cd_agenda_p
				AND 	TRUNC(dt_inicial,'dd')	<= dt_atual_w
				AND 	TRUNC(dt_final,'dd')	>= dt_atual_w
				AND		((coalesce(ie_dia_semana,ie_dia_semana_w) = ie_dia_semana_w) OR
						(((ie_dia_semana	= 9) AND (PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1)) or --#FIX_I18N 
						((ie_cons_leg_bloq_fim_sem_w = 'S') and (PKG_DATE_UTILS.is_business_day(dt_atual_w) = 0))));--#FIX_I18N 
				EXCEPTION
					WHEN OTHERS THEN
						ie_bloqueio_w := 'N';
				END;

				IF (qt_bloqueio_w > 0) THEN
					ie_status_dia_w	:= 'B';
				END IF;

			end if;

			ie_dia_sem_w	:= obter_cod_dia_semana(dt_atual_w);


			if (cd_tipo_agenda_w in (1,2))then
				select	max(coalesce(nr_sequencia,0))
				into STRICT	nr_seq_turno_w
				from	agenda_horario
				where	trunc(coalesce(dt_inicio_vigencia, dt_atual_w)) <= trunc(dt_atual_w)
				and		trunc(coalesce(dt_final_vigencia, dt_atual_w)) >= trunc(dt_atual_w)
				and		nr_minuto_intervalo > 0
				and		((dt_dia_semana = ie_dia_sem_w) or ((dt_dia_semana = 9) and (PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1)))
				and		cd_agenda = cd_agenda_p;
			else
				select	max(coalesce(nr_sequencia,0))
				into STRICT	nr_seq_turno_w
				from	agenda_turno
				where	trunc(coalesce(dt_inicio_vigencia, dt_atual_w)) <= trunc(dt_inicial_p)
				and		trunc(coalesce(dt_final_vigencia, dt_atual_w)) >= trunc(dt_inicial_p)
				and		nr_minuto_intervalo > 0
				and		((ie_dia_semana = ie_dia_sem_w) or ((ie_dia_semana = 9) and (PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1)))
				and		cd_agenda = cd_agenda_p;
			end if;

			--Validar se existe permissao de agendaento nos feriados
			if (ie_dia_feriado_w = 'S')then
				begin
				select	max(coalesce(ie_feriado,'N'))
				into STRICT	ie_agenda_feriado_w
				from	agenda
				where	cd_agenda = cd_agenda_p;

				--Busca seq. do turno atual(caso exista mais de 1)
				if (nr_seq_turno_w > 0)then
					if (cd_tipo_agenda_w = 5) then
						ie_gerar_hor_feriado_w	:= ie_agenda_feriado_w;
					elsif (cd_tipo_agenda_w in (1,2))then
						select	max(ie_feriado)
						into STRICT	ie_gerar_hor_feriado_w
						from	agenda_horario
						where	nr_sequencia = nr_seq_turno_w;
					else
						select	max(ie_feriado)
						into STRICT	ie_gerar_hor_feriado_w
						from	agenda_turno
						where	nr_sequencia = nr_seq_turno_w;
					end if;
				end if;

				exception
				when others then
					ds_erro_w := substr(sqlerrm,1,255);
				end;
			end if;

			-->> MANTER ESTE IF PARA FINS DE LOG PARA DEBUGAR A ROTINA

			/*if	(to_char(dt_atual_w,'dd/mm/yyyy') = '27/05/2015') then
				R a i s e_application_error(-20011,dt_atual_w||' - '||nr_seq_turno_w || ' - ' || nvl(qt_bloqueio_sem_horario_w,0) || ' - ' || NVL(qt_horario_bloqueado_w, 0) || ' - ' || NVL(qt_horario_livre_w,0)
										|| ' - ' || ie_dia_semana_w || ' - ' || qt_dia_filtro_ini_w || ' - ' || qt_dia_filtro_fim_w || ' - ' || NVL(qt_horario_ocupado_w,0)
										|| ' - ' || NVL(qt_horario_w,0) || ' - ' || ie_dia_feriado_w || ' - ' || qt_bloqueio_w);
			end if;*/


			/*Somente aplicar a cor de feriado se:
			O dia for um feriado efetivamente;
			A agenda nao tenha permissao para agendar nos feriados(check-box da configuracao da agenda) ou o turno da agenda nao esteja configurado para gerar horario nos feriados*/
			IF (ie_dia_feriado_w = 'S') then
				/*((ie_agenda_feriado_w = 'S') or
				(ie_gerar_hor_feriado_w <> 'N'))THEN*/
				ie_status_dia_w	:= 'F';
			elsif	((		((coalesce(qt_bloqueio_sem_horario_w,0) > 0) or (coalesce(qt_horario_bloqueado_w, 0) > 0) AND (coalesce(qt_horario_livre_w,0) = 0)) and (PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1)  and (coalesce(qt_horario_ocupado_w,0) = 0)) or --#FIX_I18N 
					((coalesce(qt_horario_w,0) > 0) AND (coalesce(qt_horario_livre_w,0) = 0) AND (coalesce(qt_horario_ocupado_w,0) = 0) AND (coalesce(qt_horario_bloqueado_w, 0) > 0) and (coalesce(ie_dia_feriado_w, 'N') <> 'S'))) THEN
				ie_status_dia_w	:= 'B';
			elsif (qt_dias_fut_w > 0) and (dt_atual_w > trunc(clock_timestamp() + qt_dias_fut_w)) and (nr_seq_turno_w IS NOT NULL AND nr_seq_turno_w::text <> '')then
				ie_status_dia_w	:= 'R';
			ELSIF (coalesce(qt_horario_w,0) > 0) and (coalesce(ie_dia_feriado_w, 'N') <> 'S') and
					((coalesce(qt_horario_ocupado_w,0) > 0) or (coalesce(qt_horario_bloqueado_w, 0) > 0)) THEN
					IF (coalesce(qt_horario_livre_w,0) > 0) THEN
						ie_status_dia_w	:= 'L';
					ELSE
						ie_status_dia_w	:= 'T';
					END IF;
			ELSIF (coalesce(qt_horario_livre_w,0) > 0) and (coalesce(ie_dia_feriado_w, 'N') <> 'S')THEN
				ie_status_dia_w	:= 'X';
			elsif	(((PKG_DATE_UTILS.is_business_day(dt_atual_w) = 0) and ((qt_bloqueio_w > 0) or (coalesce(qt_bloqueio_sem_horario_w,0) > 0)) and (ie_cons_leg_bloq_fim_sem_w = 'S') and (coalesce(qt_horario_ocupado_w,0) = 0))) then --#FIX_I18N 
				ie_status_dia_w	:= 'B';
			ELSIF (PKG_DATE_UTILS.is_business_day(dt_atual_w) = 0) and --#FIX_I18N 
				(ie_cons_leg_bloq_fim_sem_w = 'N') THEN
				ie_status_dia_w	:= 'D';
			ELSE
				BEGIN

				if (cd_tipo_agenda_w in (1,2))then
					SELECT 	COUNT(*)
					INTO STRICT	qt_regra_horario_w
					FROM	agenda_horario
					WHERE 	cd_agenda     	= cd_agenda_p
					AND		((dt_dia_semana	= ie_dia_semana_w) OR
							((dt_dia_semana	= 9) AND (PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1))) --#FIX_I18N 
					AND 	coalesce(dt_inicio_vigencia,dt_atual_w) >= dt_atual_w
					AND 	coalesce(dt_final_vigencia,dt_atual_w) <= dt_atual_w;
				elsif (cd_tipo_agenda_w in (3,4,5))then
					SELECT 	COUNT(*)
					INTO STRICT	qt_regra_horario_w
					FROM	agenda_Turno
					WHERE 	cd_agenda     	= cd_agenda_p
					AND		((ie_dia_semana	= ie_dia_semana_w) OR
							((ie_dia_semana	= 9) AND (PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1))) --#FIX_I18N 
					AND 	coalesce(dt_final_vigencia,dt_atual_w) >= dt_atual_w
					AND 	coalesce(dt_inicio_vigencia,dt_atual_w) <= dt_atual_w;
				end if;

				if (qt_regra_horario_w > 0)then
					BEGIN
					SELECT 	COUNT(*)
					INTO STRICT	qt_bloqueio_w
					FROM	agenda_bloqueio
					WHERE	cd_agenda	= cd_agenda_p
					AND 	TRUNC(dt_inicial,'dd')	<= trunc(dt_atual_w,'dd')
					AND 	TRUNC(dt_final,'dd')	>= trunc(dt_atual_w,'dd')
					AND		((coalesce(ie_dia_semana,ie_dia_semana_w) = ie_dia_semana_w) OR
							((ie_dia_semana	= 9) AND (PKG_DATE_UTILS.is_business_day(dt_atual_w) = 1) or --#FIX_I18N 
							(ie_cons_leg_bloq_fim_sem_w = 'S')));
					EXCEPTION
						WHEN OTHERS THEN
							ie_bloqueio_w := 'N';
					END;

					IF (qt_bloqueio_w > 0) THEN
						ie_status_dia_w	:= 'B';
					END IF;
				end if;
				
				IF (qt_regra_horario_w = 0) OR
					((coalesce(qt_horario_livre_w,0) = 0) AND (coalesce(qt_horario_w,0) = 0)) and (ie_status_dia_w <> 'B') then
					ie_status_dia_w	:= 'N';
				END IF;

				END;
			END IF;

		end if;

    --#FIX_L10N Se nada funcionar... descomente

    --IF (PKG_DATE_UTILS.is_business_day(dt_atual_w) = 0 ) and

		--			(ie_status_dia_w = 'R' OR 

		--			ie_status_dia_w = 'X') then

    --       ie_status_dia_w	:= 'D';

    --END IF;

    
		-->> MANTER ESTE IF PARA FINS DE LOG PARA DEBUGAR A ROTINA

		/*if	(to_char(dt_atual_w,'dd/mm/yyyy') = '29/04/2015') then
			R a i s e_application_error(-20011,ie_status_dia_w);
		end if;*/
 
		ie_status_w	:= ie_status_w || ie_status_dia_w;
		dt_atual_w	:= dt_atual_w + 1;
		END;
	END LOOP;
	END;
ELSE
	BEGIN
	ie_status_w 	:= '';
	dt_atual_w 	:= TRUNC(dt_inicial_p,'dd');

	WHILE(dt_atual_w <= TRUNC(dt_final_p,'dd')) LOOP
		BEGIN
		ie_status_w	:= ie_status_w || 'N';
		dt_atual_w	:= dt_atual_w + 1;
		END;
	END LOOP;
	END;
END IF;

ie_status_p := ie_status_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE agenda_dia_status_html ( cd_estabelecimento_p bigint, cd_agenda_p bigint, dt_Inicial_p timestamp, dt_final_p timestamp, cd_turno_p text, nm_usuario_p text, ie_Status_p INOUT text, nr_seq_item_p bigint default null, cd_medico_p text default '') FROM PUBLIC;

