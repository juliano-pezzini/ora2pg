-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_venc_titulo_pagar (nr_titulo_p bigint, nr_seq_alteracao_p bigint, nm_usuario_p text) AS $body$
DECLARE


dt_vencimento_w			timestamp;
vl_saldo_juros_venc_w		double precision;
vl_saldo_multa_venc_w		double precision;
tx_juros_venc_w			double precision;
tx_multa_venc_w			double precision;
vl_saldo_juros_w		double precision;
vl_saldo_multa_w		double precision;
tx_juros_w			double precision;
tx_multa_w			double precision;
cd_tipo_taxa_juro_w		bigint;
cd_tipo_taxa_multa_w		bigint;
dt_vencimento_atual_w		timestamp;
dt_vencimento_original_w		timestamp;
vl_saldo_titulo_w		double precision;
qt_dia_venc_w			bigint;

pr_juros_w			double precision;
ie_tipo_taxa_w			varchar(3);
pr_multa_w			double precision;


BEGIN

select	dt_vencimento,
	coalesce(vl_saldo_juros,0),
	coalesce(vl_saldo_multa,0),
	coalesce(tx_juros,0),
	coalesce(tx_multa,0)
into STRICT	dt_vencimento_w,
	vl_saldo_juros_venc_w,
	vl_saldo_multa_venc_w,
	tx_juros_venc_w,
	tx_multa_venc_w
from	titulo_pagar_alt_venc
where	nr_titulo		= nr_titulo_p
and	nr_sequencia		= nr_seq_alteracao_p;

select	vl_saldo_juros,
	vl_saldo_multa,
	tx_juros,
	tx_multa,
	cd_tipo_taxa_juro,
	cd_tipo_taxa_multa,
	dt_vencimento_atual,
	dt_vencimento_original,
	vl_saldo_titulo
into STRICT	vl_saldo_juros_w,
	vl_saldo_multa_w,
	tx_juros_w,
	tx_multa_w,
	cd_tipo_taxa_juro_w,
	cd_tipo_taxa_multa_w,
	dt_vencimento_atual_w,
	dt_vencimento_original_w,
	vl_saldo_titulo_w
from	titulo_pagar
where	nr_titulo		= nr_titulo_p;

qt_dia_venc_w			:= trunc(dt_vencimento_w, 'dd') - trunc(dt_vencimento_atual_w, 'dd');

if (qt_dia_venc_w < 0) then
	qt_dia_venc_w			:= trunc(dt_vencimento_w, 'dd') - trunc(dt_vencimento_original_w, 'dd');
end if;

if (qt_dia_venc_w >= 0) then
	if (tx_juros_venc_w > 0) then

		tx_juros_w		:= tx_juros_venc_w;

		select	ie_tipo_taxa
		into STRICT	ie_tipo_taxa_w
		from	tipo_taxa
		where	cd_tipo_taxa	= cd_tipo_taxa_juro_w;

		if (ie_tipo_taxa_w = 'A') then
			pr_juros_w	:= dividir_sem_round((tx_juros_w)::numeric, 365) * qt_dia_venc_w;
		elsif (ie_tipo_taxa_w = 'M') then
			pr_juros_w	:= dividir_sem_round((tx_juros_w)::numeric, 30) * qt_dia_venc_w;
		elsif (ie_tipo_taxa_w = 'D') then
			pr_juros_w	:= tx_juros_w * qt_dia_venc_w;
		end if;

		vl_saldo_juros_w	:= vl_saldo_titulo_w * (dividir_sem_round((pr_juros_w)::numeric, 100));

	end if;

	if (tx_multa_venc_w > 0) then
		tx_multa_w		:= tx_multa_venc_w;
		vl_saldo_multa_w	:= vl_saldo_titulo_w * (dividir_sem_round((tx_multa_w)::numeric, 100));
	end if;

	if (vl_saldo_juros_venc_w > 0) then
		vl_saldo_juros_w	:= vl_saldo_juros_venc_w;
	end if;

	if (vl_saldo_multa_venc_w > 0) then
		vl_saldo_multa_w	:= vl_saldo_multa_venc_w;
	end if;
end if;

update	titulo_pagar
set	dt_vencimento_atual	= dt_vencimento_w,
	nm_usuario		= nm_usuario_p,
	dt_atualizacao		= clock_timestamp(),
	vl_saldo_juros		= coalesce(vl_saldo_juros_w,0),
	vl_saldo_multa		= coalesce(vl_saldo_multa_w,0),
	tx_juros		= coalesce(tx_juros_w,0),
	tx_multa		= coalesce(tx_multa_w,0)
where	nr_titulo		= nr_titulo_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_venc_titulo_pagar (nr_titulo_p bigint, nr_seq_alteracao_p bigint, nm_usuario_p text) FROM PUBLIC;

