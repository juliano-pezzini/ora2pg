-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_gerar_lote ( nr_seq_lote_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_interface_procergs CONSTANT san_integracao.cd_interface%TYPE := 2446;
integracao_vgs CONSTANT san_integracao.ie_integracao%TYPE := 'V';

dt_inicio_w     san_lote_integracao.DT_INICIO%TYPE;
dt_fim_lote_w       san_lote_integracao.dt_fim_lote%TYPE;
nr_seq_transfusao_w     san_producao.nr_seq_transfusao%TYPE;
nr_seq_inutil_w     san_producao.nr_seq_inutil%TYPE;
nr_seq_emp_w        san_producao.nr_seq_emp_saida%TYPE;
ie_tipo_integracao_w san_lote_integracao.ie_tipo_integracao%TYPE;
cd_interface_w  san_integracao.cd_interface%TYPE;

C01 CURSOR FOR
    SELECT  b.nr_sequencia
    FROM    san_transfusao a,
        san_producao   b
    WHERE   a.nr_sequencia     = b.nr_seq_transfusao
    AND a.dt_transfusao BETWEEN dt_inicio_w AND fim_dia(dt_fim_lote_w)
    AND coalesce(b.nr_seq_inutil::text, '') = ''
    AND ((cd_interface_w = cd_interface_procergs AND a.ie_status = 'F') OR (coalesce(cd_interface_w::text, '') = ''))

UNION

    SELECT  b.nr_sequencia
    FROM    san_inutilizacao a,
        san_producao   b
    WHERE   a.nr_sequencia     = b.nr_seq_inutil
    AND a.dt_inutilizacao   BETWEEN dt_inicio_w AND fim_dia(dt_fim_lote_w)
    
UNION

    SELECT  b.nr_sequencia
    FROM    san_emprestimo a,
        san_producao   b
    WHERE   a.nr_sequencia     = b.nr_seq_emp_saida
    AND a.dt_emprestimo BETWEEN dt_inicio_w AND fim_dia(dt_fim_lote_w)
    AND coalesce(b.nr_seq_inutil::text, '') = ''
    ORDER BY 1;

BEGIN

IF (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') THEN

    SELECT  dt_inicio,
            dt_fim_lote,
            ie_tipo_integracao
    INTO STRICT    dt_inicio_w,
            dt_fim_lote_w,
            ie_tipo_integracao_w
    FROM    san_lote_integracao
    WHERE   nr_sequencia = nr_seq_lote_p;

    SELECT  MAX(cd_interface)
    INTO STRICT    cd_interface_w
    FROM    san_integracao
    WHERE   ie_integracao = ie_tipo_integracao_w
    AND     ie_integracao = integracao_vgs
    AND     clock_timestamp() BETWEEN dt_inicio_vigencia AND fim_dia(dt_fim_vigencia);

    FOR producao_w IN C01 LOOP
        BEGIN
        SELECT  nr_seq_transfusao,
            nr_seq_inutil,
            nr_seq_emp_saida
        INTO STRICT    nr_seq_transfusao_w,
            nr_seq_inutil_w,
            nr_seq_emp_w
        FROM    san_producao
        WHERE   nr_sequencia = producao_w.nr_sequencia;

        INSERT INTO san_lote_item(
                nr_sequencia,        
                nr_seq_lote,       
                dt_atualizacao,         
                nm_usuario,             
                dt_atualizacao_nrec,    
                nm_usuario_nrec,        
                nr_seq_trans,           
                nr_seq_producao,
                nr_seq_emp,
                nr_seq_inutil)
            VALUES (nextval('san_lote_item_seq'),
                nr_seq_lote_p,
                clock_timestamp(),
                nm_usuario_p,
                clock_timestamp(),
                nm_usuario_p,
                nr_seq_transfusao_w,
                producao_w.nr_sequencia,
                nr_seq_emp_w,
                nr_seq_inutil_w);
        END;
    END LOOP;

    IF (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') THEN
    
        UPDATE  san_lote_integracao 
        SET dt_liberacao        = clock_timestamp(),
            nm_usuario_liberacao    = nm_usuario_p
        WHERE   nr_sequencia        = nr_seq_lote_p;

    END IF;
END IF;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_gerar_lote ( nr_seq_lote_p bigint, nm_usuario_p text) FROM PUBLIC;

