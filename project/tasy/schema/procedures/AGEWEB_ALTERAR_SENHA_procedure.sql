-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ageweb_alterar_senha ( ds_login_p text, ds_senha_antiga_p text, ds_senha_p text, ds_senha_cripto_p text, ds_erro_p INOUT text) AS $body$
DECLARE

 
qt_registro_w		bigint;
ds_email_senha_w		varchar(4000);
ds_remetente_w		varchar(255);
ds_titulo_email_senha_w	varchar(255);
ds_email_matricula_w	varchar(255);
nm_pessoa_fisica_w	varchar(255);
cd_pessoa_fisica_w	varchar(10);			
ds_erro_w		varchar(4000);
ds_login_w		varchar(15);
ie_utiliza_login_pront_w	varchar(1);
nr_prontuario_w		pessoa_fisica.nr_prontuario%type;


BEGIN 
 
if (ds_login_p IS NOT NULL AND ds_login_p::text <> '') then 
	begin 
	 
	SELECT max(coalesce(a.ie_utiliza_login_pront,'N')) 
	into STRICT	ie_utiliza_login_pront_w 
	FROM  	parametro_agenda_web a;
 
	if (ie_utiliza_login_pront_w = 'S') then 
		select	max(nr_prontuario) 
		into STRICT	nr_prontuario_w 
		from	pessoa_fisica 
		where	cd_pessoa_fisica = ds_login_p;
	end if;	
	 
 
	if (ie_utiliza_login_pront_w = 'N') then 
		select	count(*) 
		into STRICT	qt_registro_w 
		from	ageweb_login 
		where	ds_login = ds_login_p 
		and	ds_senha = ds_senha_antiga_p;
	else 
		select	count(*) 
		into STRICT	qt_registro_w 
		from	ageweb_login 
		where	ds_login = nr_prontuario_w 
		and	ds_senha = ds_senha_antiga_p;
	end if;
	 
	if (qt_registro_w > 0) then 
		 
		if (ie_utiliza_login_pront_w = 'N') then 
			update	ageweb_login 
			set	ds_senha = ds_senha_cripto_p 
			where	ds_login = ds_login_p;
		else 
			update	ageweb_login 
			set	ds_senha = ds_senha_cripto_p 
			where	ds_login = nr_prontuario_w;
		end if;
		 
		if (ie_utiliza_login_pront_w = 'N') then 
			update	pessoa_fisica 
			set	ds_senha = ds_senha_p 
			where	cd_pessoa_fisica = ds_login_p;
		else 
			update	pessoa_fisica 
			set	ds_senha = ds_senha_p 
			where	nr_prontuario = nr_prontuario_w;
		end if;
 
		if (ie_utiliza_login_pront_w = 'N') then 
			select	max(b.cd_pessoa_fisica), 
				max(substr(obter_nome_pf(b.cd_pessoa_fisica),1,255)) 
			into STRICT	cd_pessoa_fisica_w, 
				nm_pessoa_fisica_w 
			from	ageweb_login a, 
				pessoa_fisica b 
			where	a.cd_pessoa_fisica = b.cd_pessoa_fisica 
			and	a.ds_login = ds_login_p;
		else 
			select	max(b.cd_pessoa_fisica), 
				max(substr(obter_nome_pf(b.cd_pessoa_fisica),1,255)) 
			into STRICT	cd_pessoa_fisica_w, 
				nm_pessoa_fisica_w 
			from	ageweb_login a, 
				pessoa_fisica b 
			where	a.cd_pessoa_fisica = b.cd_pessoa_fisica 
			and	a.ds_login = nr_prontuario_w;			
		end if;
 
		select	max(ds_titulo), 
			max(ds_remetente), 
			max(ds_mensagem) 
		into STRICT	ds_titulo_email_senha_w, 
			ds_remetente_w, 
			ds_email_senha_w 
		from	ageweb_cadastro_email 
		where	ie_tipo_email = 'AS';
 
		select	max(b.ds_email) 
		into STRICT	ds_email_matricula_w 
		from	pessoa_fisica a, 
			compl_pessoa_fisica b 
		where	a.cd_pessoa_fisica 	= b.cd_pessoa_fisica 
		and	b.ie_tipo_complemento 	= 1 
		and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w;
		 
		begin 
			if (ds_email_senha_w IS NOT NULL AND ds_email_senha_w::text <> '') and (ds_remetente_w IS NOT NULL AND ds_remetente_w::text <> '') and (ds_titulo_email_senha_w IS NOT NULL AND ds_titulo_email_senha_w::text <> '') and (ds_email_matricula_w IS NOT NULL AND ds_email_matricula_w::text <> '') then 
				 
				ds_email_senha_w	:= substr(replace_macro(ds_email_senha_w, '@paciente', nm_pessoa_fisica_w),1,4000);
				ds_email_senha_w	:= substr(replace_macro(ds_email_senha_w, '@matricula', ds_login_w),1,4000);
				ds_email_senha_w	:= substr(replace_macro(ds_email_senha_w, '@senha', ds_senha_p),1,4000);
				 
				CALL enviar_email(ds_titulo_email_senha_w, ds_email_senha_w, ds_remetente_w, ds_email_matricula_w, 'Tasy', 'A');
			end if;
			 
			ds_erro_p := WHEB_MENSAGEM_PCK.get_texto(277667,null);
		 
		exception 
		when others then 
 
			ds_erro_w	:= substr(sqlerrm,1,2000);
			ds_erro_w	:= substr(ds_erro_w||'-'||wheb_mensagem_pck.get_texto(799933)||'>'||ds_login_w,1,4000);				
			insert into log_ageweb(dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, ds_log) values (clock_timestamp(),'ageWeb',clock_timestamp(),'ageWeb',ds_erro_w);
	 
			ds_erro_p := wheb_mensagem_pck.get_texto(799931);	
			 
		end;
	else 
		ds_erro_p := WHEB_MENSAGEM_PCK.get_texto(281756,null);
	end if;
	 
commit;
exception 
when others then 
	ds_erro_w	:= substr(sqlerrm,1,2000);
	insert into log_ageweb(dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, ds_log) values (clock_timestamp(),'ageWeb',clock_timestamp(),'ageWeb',ds_erro_w);	
 
end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageweb_alterar_senha ( ds_login_p text, ds_senha_antiga_p text, ds_senha_p text, ds_senha_cripto_p text, ds_erro_p INOUT text) FROM PUBLIC;

