-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_copiar_conta_contabil ( cd_empresa_origem_p bigint, cd_empresa_destino_p bigint, nm_usuario_p text) is /*Variaveis de controle*/

 cd_conta_contabil_w varchar(20) RETURNS varchar AS $body$
DECLARE

		cd_conta_contabil_pk_w varchar(20);
	
BEGIN

		nr_sequencia_w := nr_sequencia_w + 1;

		cd_conta_contabil_pk_w := substr(cd_empresa_destino_p || '.' || nr_sequencia_w,1,20);

		select	max(cd_conta_contabil)
		into STRICT	cd_conta_contabil_new_w
		from	conta_contabil
		where	cd_conta_contabil	= cd_conta_contabil_pk_w;

		/* Se achou PK na conta contabil, chama function novamente */

		if (cd_conta_contabil_new_w IS NOT NULL AND cd_conta_contabil_new_w::text <> '') then
			/* recusividade */

			cd_conta_contabil_pk_w := gera_pk_valida();
		end if;

	return(cd_conta_contabil_pk_w);

	end;
begin

/* Inicia sequenciador interno para contenção de duplicidades de PK*/

nr_sequencia_w := 0;

/* Chamar a copida do grupo conta_contabil , pois é referenciada na conta contabil*/

CALL ctb_copiar_ctb_grupo_conta(	cd_empresa_origem_p,
				cd_empresa_destino_p,
				nm_usuario_p);

open c1;
loop
fetch c1 into r1;
EXIT WHEN NOT FOUND; /* apply on c1 */
	/* Valida conta ja referenciada */

	begin
	select	max(cd_conta_contabil)
	into STRICT	cd_conta_referencia_w
	from	conta_contabil
	where	cd_conta_referencia  =  r1.cd_conta_contabil
	and	cd_empresa    =  cd_empresa_destino_p;
	end;

	/* Evita copia duplicada */

	if (coalesce(cd_conta_referencia_w::text, '') = '') then

		if (length(cd_empresa_destino_p || '.' || r1.cd_conta_contabil) > 20 ) then
			cd_conta_contabil_w := substr(cd_empresa_destino_p || '.' || somente_numero(r1.cd_conta_contabil),1,20);
		else
			cd_conta_contabil_w := substr(cd_empresa_destino_p || '.' || r1.cd_conta_contabil,1,20);
		end if;

		select	max(cd_conta_contabil)
		into STRICT	cd_conta_contabil_new_w
		from	conta_contabil
		where	cd_conta_contabil = cd_conta_contabil_w;

		if (cd_conta_contabil_new_w IS NOT NULL AND cd_conta_contabil_new_w::text <> '') then
			/* Chama função recursiva para garantir PK da nova Conta Contabil*/

			cd_conta_contabil_w := gera_pk_valida();
		end if;

		insert into conta_contabil(	cd_conta_contabil,
						ds_conta_contabil,
						ie_situacao,
						dt_atualizacao,
						nm_usuario,
						ie_centro_custo,
						ie_tipo,
						cd_classificacao,
						cd_grupo,
						cd_empresa,
						cd_centro_custo,
						cd_sistema_contabil,
						cd_plano_ans,
						ds_orientacao,
						ie_compensacao,
						ie_versao_ans,
						dt_inicio_vigencia,
						dt_fim_vigencia,
						cd_classif_superior,
						cd_classif_ecd,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						ie_ecd_reg_dre,
						ie_ecd_reg_bp,
						ie_diops,
						cd_classificacao_atual,
						cd_classif_superior_atual,
						ie_natureza_sped,
						ie_deducao_acomp_orc,
						cd_conta_referencia)
		values (			cd_conta_contabil_w,
						r1.ds_conta_contabil,
						r1.ie_situacao,
						r1.dt_atualizacao,
						r1.nm_usuario,
						r1.ie_centro_custo,
						r1.ie_tipo,
						r1.cd_classificacao,
						r1.cd_grupo,
						r1.cd_empresa,
						r1.cd_centro_custo,
						r1.cd_sistema_contabil,
						r1.cd_plano_ans,
						r1.ds_orientacao,
						r1.ie_compensacao,
						r1.ie_versao_ans,
						r1.dt_inicio_vigencia,
						r1.dt_fim_vigencia,
						r1.cd_classif_superior,
						r1.cd_classif_ecd,
						r1.dt_atualizacao_nrec,
						r1.nm_usuario_nrec,
						r1.ie_ecd_reg_dre,
						r1.ie_ecd_reg_bp,
						r1.ie_diops,
						r1.cd_classificacao_atual,
						r1.cd_classif_superior_atual,
						r1.ie_natureza_sped,
						r1.ie_deducao_acomp_orc,
						r1.cd_conta_contabil);
	end if;
	
	end loop;
	close c1;

	commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_copiar_conta_contabil ( cd_empresa_origem_p bigint, cd_empresa_destino_p bigint, nm_usuario_p text) is  cd_conta_contabil_w varchar(20) FROM PUBLIC;

