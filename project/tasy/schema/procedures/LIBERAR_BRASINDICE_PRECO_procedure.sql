-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_brasindice_preco (dt_vigencia_base_p timestamp, dt_vigencia_ant_p timestamp, pr_inicial_p bigint, pr_final_p bigint, nm_usuario_p text) AS $body$
DECLARE



cd_laboratorio_w	varchar(06);
cd_medicamento_w	varchar(06);
cd_apresentacao_w	varchar(06);


c01 CURSOR FOR
	SELECT	cd_laboratorio,
		cd_apresentacao,
		cd_medicamento
	from	brasindice_preco
	where	obter_valor_preco_brasindice(cd_laboratorio,
			cd_medicamento,
			cd_apresentacao,
			'P', dt_vigencia_base_p,
			dt_vigencia_ant_p) between pr_inicial_p and pr_final_p
	and	dt_inicio_vigencia 	= dt_vigencia_base_p;



BEGIN

open	c01;
loop
fetch	c01 into
	cd_laboratorio_w,
	cd_apresentacao_w,
	cd_medicamento_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	update	brasindice_preco
	set	dt_liberacao		= clock_timestamp(),
	nm_usuario_liberacao		= nm_usuario_p
	where	cd_laboratorio		= cd_laboratorio_w
	and	cd_apresentacao		= cd_apresentacao_w
	and	cd_medicamento		= cd_medicamento_w
	and	dt_inicio_vigencia	= dt_vigencia_base_p;

	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_brasindice_preco (dt_vigencia_base_p timestamp, dt_vigencia_ant_p timestamp, pr_inicial_p bigint, pr_final_p bigint, nm_usuario_p text) FROM PUBLIC;

