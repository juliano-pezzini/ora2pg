-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alterar_item_auditoria ( nr_seq_audit_item_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_material_p bigint, qt_item_proc_p bigint, qt_item_mat_p bigint, vl_material_p bigint, nm_usuario_p text, ie_pacote_ptu_p text, cd_anvisa_p text, cd_ref_fabricante_p text, ie_commit_p text default 'S') AS $body$
DECLARE


/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:   Alterar o item da auditoria
----------------------------------------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  ]  Objetos do dicionario [ x ] Tasy (Delphi/Java) [ x ] Portal [  ] Relatorios [ ] Outros:
 ----------------------------------------------------------------------------------------------------------------------------------------------------

Pontos de atencao:  
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/	

cd_item_w			bigint;
ie_origem_proced_w		bigint;
qt_item_w			double precision;	
nr_seq_auditoria_w		bigint;
nr_seq_guia_w			bigint;
nr_seq_requisicao_w		bigint;
ie_tipo_item_w			varchar(1);
cd_estabelecimento_w		smallint;
vl_item_w			double precision;
cd_procedimento_w		procedimento.cd_procedimento%type;
nr_seq_material_w		pls_material.nr_sequencia%type;
ie_item_alterado_w		varchar(1)	:= 'N';
ie_tipo_processo_w		varchar(2);
ie_tipo_intercambio_w		varchar(2);
ie_origem_solic_w		varchar(2);
nr_seq_item_w			bigint;
nr_seq_anexo_item_w		pls_lote_anexo_mat_aut.nr_sequencia%type;


BEGIN

select	coalesce(cd_procedimento,nr_seq_material),
	qt_original,
	vl_item,
	ie_origem_proced,
	nr_seq_auditoria,
	cd_procedimento,
	nr_seq_material
into STRICT	cd_item_w,
	qt_item_w,
	vl_item_w,
	ie_origem_proced_w,
	nr_seq_auditoria_w,
	cd_procedimento_w,
	nr_seq_material_w
from	pls_auditoria_item
where	nr_sequencia = nr_seq_audit_item_p;

select	nr_seq_guia,
	nr_seq_requisicao,
	cd_estabelecimento
into STRICT	nr_seq_guia_w,
	nr_seq_requisicao_w,
	cd_estabelecimento_w
from	pls_auditoria
where	nr_sequencia = nr_seq_auditoria_w;

if ((nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') or (nr_seq_requisicao_w IS NOT NULL AND nr_seq_requisicao_w::text <> '')) then
	if (cd_procedimento_w IS NOT NULL AND cd_procedimento_w::text <> '') and (cd_procedimento_p IS NOT NULL AND cd_procedimento_p::text <> '') then
		if (cd_procedimento_w	<> cd_procedimento_p) then
			ie_item_alterado_w	:= 'S';
		end if;
	end if;

	if (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') and (nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') then
		if (nr_seq_material_w	<> nr_seq_material_p) then
			ie_item_alterado_w	:= 'S';
		end if;
	end if;
	
	if ((nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') and ie_item_alterado_w = 'S') then
		begin
			select	ie_tipo_processo,
				ie_tipo_intercambio,
				ie_origem_solic
			into STRICT	ie_tipo_processo_w,
				ie_tipo_intercambio_w,
				ie_origem_solic_w
			from	pls_guia_plano
			where	nr_sequencia	= nr_seq_guia_w;
		exception
		when others then
			ie_tipo_processo_w	:= null;
			ie_tipo_intercambio_w	:= null;
		end;

		if (ie_tipo_processo_w	= 'I') and (ie_tipo_intercambio_w	= 'E') then
			-- Voce nao pode realizar esta acao em uma guia recebida via intercambio!
			CALL wheb_mensagem_pck.exibir_mensagem_abort(271396);
		elsif (ie_origem_solic_w	= 'E') then
			-- Voce nao pode realizar esta acao em uma guia recebida eletronicamente!
			CALL wheb_mensagem_pck.exibir_mensagem_abort(676204);
		end if;
	elsif ((nr_seq_requisicao_w IS NOT NULL AND nr_seq_requisicao_w::text <> '') and ie_item_alterado_w	= 'S') then
		begin
			select	ie_tipo_processo,
				ie_tipo_intercambio,
				ie_origem_solic
			into STRICT	ie_tipo_processo_w,
				ie_tipo_intercambio_w,
				ie_origem_solic_w
			from	pls_requisicao
			where	nr_sequencia	= nr_seq_requisicao_w;
		exception
		when others then
			ie_tipo_processo_w	:= null;
			ie_tipo_intercambio_w	:= null;
		end;

		if (ie_tipo_processo_w	= 'I') and (ie_tipo_intercambio_w	= 'E') then
			-- Voce nao pode realizar esta acao em uma requisicao recebida via intercambio!
			CALL wheb_mensagem_pck.exibir_mensagem_abort(358870);
		elsif (ie_origem_solic_w	= 'E') then
			-- Voce nao pode realizar esta acao em uma requisicao recebida eletronicamente!
			CALL wheb_mensagem_pck.exibir_mensagem_abort(676205);
		end if;
	end if;
end if;

if (cd_procedimento_p <> 0) then
	ie_tipo_item_w	:= 'P';
	
	update	pls_auditoria_item
	set	cd_procedimento		= cd_procedimento_p,
		ie_origem_proced	= ie_origem_proced_p,
		qt_ajuste		= CASE WHEN qt_item_proc_p=0 THEN 1  ELSE qt_item_proc_p END ,
		ie_acao_auditor		= 'A',
		ie_pacote_ptu		= coalesce(ie_pacote_ptu_p,'N'),
		dt_atualizacao		= clock_timestamp(),
		nm_usuario		= nm_usuario_p
	where	nr_sequencia		= nr_seq_audit_item_p;

elsif (nr_seq_material_p <> 0) then
	ie_tipo_item_w	:= 'M';
	
	update	pls_auditoria_item
	set	nr_seq_material		= nr_seq_material_p,
		qt_ajuste		= CASE WHEN qt_item_mat_p=0 THEN 1  ELSE qt_item_mat_p END ,
		vl_item			= CASE WHEN vl_material_p=0 THEN vl_item  ELSE vl_material_p END ,
		ie_acao_auditor		= 'A',
		dt_atualizacao		= clock_timestamp(),
		nm_usuario		= nm_usuario_p,
		nr_registro_anvisa	= cd_anvisa_p,
		cd_ref_fabricante_imp	= cd_ref_fabricante_p
	where	nr_sequencia		= nr_seq_audit_item_p;

	select	max(nr_seq_mat_origem)
	into STRICT	nr_seq_item_w
	from	pls_auditoria_item
	where	nr_sequencia		= nr_seq_audit_item_p;
	
	if (nr_seq_requisicao_w	> 0) then
		select	max(nr_sequencia)
		into STRICT	nr_seq_anexo_item_w
		from	pls_lote_anexo_mat_aut
		where	nr_seq_req_mat		= nr_seq_item_w;
	elsif (nr_seq_guia_w	> 0) then
		select	max(nr_sequencia)
		into STRICT	nr_seq_anexo_item_w
		from	pls_lote_anexo_mat_aut
		where	nr_seq_plano_mat	= nr_seq_item_w;
	end if;

	if (nr_seq_anexo_item_w IS NOT NULL AND nr_seq_anexo_item_w::text <> '') then
		update	pls_lote_anexo_mat_aut
		set	nr_seq_material		= nr_seq_material_p,
			nr_registro_anvisa	= cd_anvisa_p,
			cd_ref_fabricante_imp	= cd_ref_fabricante_p,
			nm_usuario		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp()
		where	nr_sequencia		= nr_seq_anexo_item_w;
	end if;
end if;

-- Esta rotina grava log de alteracao tanto nas analises de requisicoes quanto nas analises de guias.
CALL pls_gerar_hist_log_req(nr_seq_audit_item_p,3,nm_usuario_p, cd_item_w, qt_item_w, ie_origem_proced_w, vl_item_w);

if (pls_obter_altera_item_analise = 'S') then
	if (nr_seq_requisicao_w	> 0) then
		CALL pls_consistir_itens_alterados(nr_seq_auditoria_w, nr_seq_audit_item_p, nr_seq_requisicao_w, 0, ie_tipo_item_w, nm_usuario_p,cd_estabelecimento_w);
	elsif (nr_seq_guia_w	> 0) then
		CALL pls_consistir_itens_alterados(nr_seq_auditoria_w, nr_seq_audit_item_p, 0, nr_seq_guia_w, ie_tipo_item_w, nm_usuario_p, cd_estabelecimento_w);
	end if;
end if;

if (ie_commit_p = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alterar_item_auditoria ( nr_seq_audit_item_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_material_p bigint, qt_item_proc_p bigint, qt_item_mat_p bigint, vl_material_p bigint, nm_usuario_p text, ie_pacote_ptu_p text, cd_anvisa_p text, cd_ref_fabricante_p text, ie_commit_p text default 'S') FROM PUBLIC;

