-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_pessoa_resp_cred ( nr_seq_segurado_p pls_segurado.nr_sequencia%type, ie_opcao_p text, cd_pessoa_resp_p INOUT text) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Obter a pessoa responsável pelo crédito do beneficiario de reembolso
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[ ]  Objetos do dicionário [x] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------
Pontos de atenção:

ie_opcao_p
CP - Contratante Principal
E - Estipulante do Beneficiário
P - Pagador
SE - Subestipulante
T - Titular

Alterações:
-------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_ref_w		bigint;
cd_pessoa_resp_w	varchar(255);


BEGIN
if (UPPER(ie_opcao_p) = 'CP') or --Contratante principal
	(UPPER(ie_opcao_p) = 'E') then -- Estipulante
	select	max(b.cd_pf_estipulante)
	into STRICT	cd_pessoa_resp_w
	from	pls_segurado	a,
		pls_contrato	b
	where	a.nr_seq_contrato 	= b.nr_sequencia
	and	a.nr_sequencia 		= nr_seq_segurado_p;

		if (coalesce(cd_pessoa_resp_w,'X') = 'X') then
			select	max(b.cd_cgc_estipulante)
			into STRICT	cd_pessoa_resp_w
			from	pls_segurado	a,
				pls_contrato	b
			where	a.nr_seq_contrato 	= b.nr_sequencia
			and	a.nr_sequencia 		= nr_seq_segurado_p;
		end if;

		if (coalesce(cd_pessoa_resp_w,'X') = 'X') and (UPPER(ie_opcao_p) = 'CP') then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(336955,null); --Não existe contratante principal cadastrado no contrato do segurado.
		elsif (coalesce(cd_pessoa_resp_w,'X') = 'X') and (UPPER(ie_opcao_p) = 'E') then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(336954,null); --Não existe Estipulante cadastrado no contrato do segurado.
		end if;

elsif (UPPER(ie_opcao_p) = 'P') then --Pagador
	select	nr_seq_pagador
	into STRICT	nr_seq_ref_w
	from	pls_segurado
	where	nr_sequencia = nr_seq_segurado_p;

	if (coalesce(nr_seq_ref_w,0) > 0) then
		select	max(cd_pessoa_fisica)
		into STRICT	cd_pessoa_resp_w
		from	pls_contrato_pagador
		where	nr_sequencia = nr_seq_ref_w;
	end if;

		if (coalesce(cd_pessoa_resp_w,'X') = 'X') then
			select	max(cd_cgc)
			into STRICT 	cd_pessoa_resp_w
			from	pls_contrato_pagador
			where	nr_sequencia = nr_seq_ref_w;
		end if;

elsif (UPPER(ie_opcao_p) = 'SE') then	--Subestipulante
	select	nr_seq_subestipulante
	into STRICT	nr_seq_ref_w
	from	pls_segurado
	where	nr_sequencia = nr_seq_segurado_p;

	if (coalesce(nr_seq_ref_w,0) > 0) then
		select	max(cd_pessoa_fisica)
		into STRICT	cd_pessoa_resp_w
		from	pls_sub_estipulante
		where	nr_sequencia = nr_seq_ref_w;
	end if;

		if (coalesce(cd_pessoa_resp_w,'X') = 'X') then
			select	max(cd_cgc)
			into STRICT 	cd_pessoa_resp_w
			from	pls_sub_estipulante
			where	nr_sequencia = nr_seq_ref_w;
		end if;

		if (coalesce(cd_pessoa_resp_w,'X') = 'X') then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(336667,null); --Não existe Subestipulante cadastrado no contrato do segurado.
		end if;

elsif (UPPER(ie_opcao_p) = 'T') then	--Titular
	select	max(nr_seq_titular)
	into STRICT	nr_seq_ref_w
	from	pls_segurado
	where	nr_sequencia = nr_seq_segurado_p;

	if (coalesce(nr_seq_ref_w,0) > 0) then
		select	max(cd_pessoa_fisica)
		into STRICT	cd_pessoa_resp_w
		from	pls_segurado
		where	nr_sequencia = nr_seq_ref_w;
	elsif (coalesce(nr_seq_ref_w,0) = 0) then
		select	max(cd_pessoa_fisica)
		into STRICT	cd_pessoa_resp_w
		from	pls_segurado
		where	nr_sequencia = nr_seq_segurado_p;
	end if;
end if;

if (coalesce(cd_pessoa_resp_w,'X') <> 'X') then
	cd_pessoa_resp_p := cd_pessoa_resp_w;
end if;

--commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_pessoa_resp_cred ( nr_seq_segurado_p pls_segurado.nr_sequencia%type, ie_opcao_p text, cd_pessoa_resp_p INOUT text) FROM PUBLIC;

