-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_comunicacao_cih ( cd_profissional_p text, nr_seq_tipo_p bigint, ds_comunicado_p text, nr_prescricao_p bigint, nr_seq_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_Comunicado_w 		varchar(32500);
ds_Comunicado_CIH_w 	varchar(32500):= '';


BEGIN

ds_Comunicado_w := ds_Comunicado_p;

/*if (instr(ds_Comunicado_w,'{\rtf') = 0) then
	ds_Comunicado_w := wheb_rtf_pck.get_cabecalho ||chr(13)||chr(10)|| replace(ds_comunicado_w, chr(13)||chr(10), chr(13)||chr(10)|| wheb_rtf_pck.get_quebra_linha) ||chr(13)||chr(10)|| wheb_rtf_pck.get_rodape;
end if;
*/
if (obter_parametro_funcao(896, 71, nm_usuario_p) = 'S') then
	ds_Comunicado_CIH_w:= SUBSTR(obter_reprov_lib_comunic_cih(nr_prescricao_p, nr_seq_prescricao_p,nm_usuario_p),1,4000) || CHR(13) || CHR(10) || CHR(13) || CHR(10);
	ds_Comunicado_w:= wheb_rtf_pck.get_cabecalho || chr(13)|| chr(10)|| replace(ds_Comunicado_CIH_w, chr(13)||chr(10), chr(13)||chr(10)|| wheb_rtf_pck.get_quebra_linha) || replace(ds_comunicado_w, chr(13)||chr(10), chr(13)||chr(10)|| wheb_rtf_pck.get_quebra_linha) ||chr(13)||chr(10)|| wheb_rtf_pck.get_rodape;
else
	if (position('{\rtf' in ds_Comunicado_w) = 0) then
		ds_Comunicado_w := wheb_rtf_pck.get_cabecalho ||chr(13)||chr(10)|| replace(ds_comunicado_w, chr(13)||chr(10), chr(13)||chr(10)|| wheb_rtf_pck.get_quebra_linha) ||chr(13)||chr(10)|| wheb_rtf_pck.get_rodape;
	end if;
end if;

	insert into 	prescr_mat_comunic_cih(dt_registro,
			cd_profissional,
			nr_seq_tipo,
			ds_comunicado,
			nm_usuario,
			nm_usuario_nrec,
			dt_atualizacao,
			dt_atualizacao_nrec,
			nr_sequencia,
			nr_prescricao,
			nr_seq_prescricao)
	values (clock_timestamp(),
			cd_profissional_p,
			nr_seq_tipo_p,
			coalesce(ds_Comunicado_w, ' '),
			nm_usuario_p,
			nm_usuario_p,
			clock_timestamp(),
			clock_timestamp(),
			nextval('prescr_mat_comunic_cih_seq'),
			nr_prescricao_p,
			nr_seq_prescricao_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_comunicacao_cih ( cd_profissional_p text, nr_seq_tipo_p bigint, ds_comunicado_p text, nr_prescricao_p bigint, nr_seq_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

