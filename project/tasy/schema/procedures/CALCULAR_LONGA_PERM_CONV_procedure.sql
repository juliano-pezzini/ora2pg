-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_longa_perm_conv ( nr_atendimento_p bigint , nr_interno_conta_p bigint , nm_usuario_p text , cd_procedimento_p INOUT bigint , ie_origem_proced_p INOUT bigint , qt_perm_proc_p INOUT bigint , qt_perm_real_p INOUT bigint , qt_longa_perm_p INOUT bigint ) AS $body$
DECLARE

					 
dt_entrada_w		timestamp;
dt_alta_w			timestamp;
dt_final_w		timestamp;
qt_diarias_w		bigint	:= 0;
qt_permanencia_w		bigint	:= 0;
qt_diarias_uti_w		bigint	:= 0;
qt_longa_perm_total_w	bigint	:= 0;
qt_longa_perm_liq_w	bigint	:= 0;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;

c01 CURSOR FOR 
	SELECT 	cd_procedimento, 
		ie_origem_proced, 
		obter_qt_dia_internacao_sus(cd_procedimento, ie_origem_proced) 
	from	procedimento_paciente 
	where	nr_interno_conta		= nr_interno_conta_p 
	and	coalesce(cd_motivo_exc_conta::text, '') = '' 
	and	ie_proc_princ_atend 	= 'S' 
	order by	obter_qt_dia_internacao_sus(cd_procedimento, ie_origem_proced);


BEGIN 
 
/* Obter dados do procedimento */
 
open c01;
loop 
fetch c01 into	 
	cd_procedimento_w, 
	ie_origem_proced_w, 
	qt_permanencia_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
end loop;
close c01;
 
/* Selecao das datas de entrada e alta do Paciente */
 
Select	dt_entrada, 
	coalesce(dt_alta,clock_timestamp()) 
into STRICT	dt_entrada_w, 
	dt_alta_w 
from 	atendimento_paciente 
where	nr_atendimento	= nr_atendimento_p;
 
/* Identificar se tem permanencia para o procedimento realizado */
 
qt_diarias_w	:= (trunc(dt_alta_w) - trunc(dt_entrada_w));
 
/* Calculo da Longa Permanencia */
 
if (coalesce(qt_diarias_w,0) > 0) and (coalesce(qt_permanencia_w,0) > 0) and (coalesce(cd_procedimento_w,0) <> 0) then 
	begin 
	qt_permanencia_w			:= (qt_permanencia_w * 2);
	qt_longa_perm_total_w		:= qt_diarias_w - qt_permanencia_w;
	qt_longa_perm_liq_w		:= qt_longa_perm_total_w - qt_diarias_uti_w;
	if (qt_longa_perm_liq_w) < 0 then 
		qt_longa_perm_liq_w	:= 0;
	end if;
 
	qt_perm_proc_p			:= qt_permanencia_w;
	qt_perm_real_p			:= qt_diarias_w;
	qt_longa_perm_p			:= qt_longa_perm_liq_w;
	cd_procedimento_p			:= cd_procedimento_w;
	ie_origem_proced_p		:= ie_origem_proced_w;
 
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_longa_perm_conv ( nr_atendimento_p bigint , nr_interno_conta_p bigint , nm_usuario_p text , cd_procedimento_p INOUT bigint , ie_origem_proced_p INOUT bigint , qt_perm_proc_p INOUT bigint , qt_perm_real_p INOUT bigint , qt_longa_perm_p INOUT bigint ) FROM PUBLIC;

