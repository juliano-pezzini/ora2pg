-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_movto_alt_portador (nr_seq_cheque_p bigint, nr_seq_alt_portador_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_cgc_w			varchar(14);
cd_pessoa_fisica_w	varchar(10);
cd_portador_w		bigint;
cd_tipo_portador_w	integer;
ds_mes_alteracao_w	varchar(255);
dt_alteracao_w		timestamp;
nr_seq_conta_banco_w	bigint;
nr_seq_saldo_banco_w	bigint;
nr_seq_trans_financ_w	bigint;
vl_cheque_w		double precision;
/* Projeto Multimoeda - Variáveis */

vl_cheque_estrang_w	double precision;
vl_complemento_w	double precision;
vl_cotacao_w		cotacao_moeda.vl_cotacao%type;
cd_moeda_w		integer;


BEGIN

select	max(b.cd_cgc),
	max(b.cd_pessoa_fisica),
	max(a.cd_portador),
	max(a.cd_tipo_portador),
	max(a.dt_alteracao),
	max(a.nr_seq_conta_banco),
	max(a.nr_seq_trans_financ),
	max(b.vl_cheque),
	max(b.vl_cheque_estrang),
	max(b.vl_cotacao),
	max(b.cd_moeda)
into STRICT	cd_cgc_w,
	cd_pessoa_fisica_w,
	cd_portador_w,
	cd_tipo_portador_w,
	dt_alteracao_w,
	nr_seq_conta_banco_w,
	nr_seq_trans_financ_w,
	vl_cheque_w,
	vl_cheque_estrang_w,
	vl_cotacao_w,
	cd_moeda_w
from	cheque_cr b,
	cheque_cr_alt_portador a
where	a.nr_seq_cheque	= b.nr_seq_cheque
and	a.nr_sequencia	= nr_seq_alt_portador_p
and	a.nr_seq_cheque	= nr_seq_cheque_p;

if (nr_seq_trans_financ_w IS NOT NULL AND nr_seq_trans_financ_w::text <> '') then

	select	max(a.nr_sequencia)
	into STRICT	nr_seq_saldo_banco_w
	from	banco_saldo a
	where	coalesce(a.dt_fechamento::text, '') = ''
	and	trunc(a.dt_referencia,'month')	= trunc(dt_alteracao_w,'month')
	and	a.nr_seq_conta		= nr_seq_conta_banco_w;

	if (coalesce(nr_seq_saldo_banco_w::text, '') = '') then

		ds_mes_alteracao_w	:= substr(obter_data_extenso(dt_alteracao_w,1),1,255);
		/* Não há saldo aberto no Controle Bancário para ds_mes_alteracao_w */

		CALL wheb_mensagem_pck.exibir_mensagem_abort(262739,'DS_MES_ALTERACAO_W='||ds_mes_alteracao_w);

	end if;

	/* Projeto Multimoeda - Verifica se o cheque é em moeda estrangeira para gerar o movimento em moeda estrangeira. */

	if (coalesce(vl_cheque_estrang_w,0) <> 0 and coalesce(vl_cotacao_w,0) <> 0) then
		vl_complemento_w := vl_cheque_w - vl_cheque_estrang_w;
	else
		vl_cheque_estrang_w := null;
		vl_complemento_w := null;
		vl_cotacao_w := null;
		cd_moeda_w := null;
	end if;

	insert	into movto_trans_financ(cd_cgc,
		cd_pessoa_fisica,
		cd_portador,
		cd_tipo_portador,
		dt_atualizacao,
		dt_transacao,
		ie_conciliacao,
		nm_usuario,
		nr_lote_contabil,
		nr_seq_cheque,
		nr_seq_saldo_banco,
		nr_seq_trans_financ,
		nr_sequencia,
		vl_transacao,
		vl_transacao_estrang,
		vl_complemento,
		vl_cotacao,
		cd_moeda)
	values (cd_cgc_w,
		cd_pessoa_fisica_w,
		cd_portador_w,
		cd_tipo_portador_w,
		clock_timestamp(),
		dt_alteracao_w,
		'N',
		nm_usuario_p,
		0,
		nr_seq_cheque_p,
		nr_seq_saldo_banco_w,
		nr_seq_trans_financ_w,
		nextval('movto_trans_financ_seq'),
		vl_cheque_w,
		vl_cheque_estrang_w,
		vl_complemento_w,
		vl_cotacao_w,
		cd_moeda_w);

	commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_movto_alt_portador (nr_seq_cheque_p bigint, nr_seq_alt_portador_p bigint, nm_usuario_p text) FROM PUBLIC;

