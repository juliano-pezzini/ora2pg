-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_acao_protocolo_vanco ( nm_usuario_p text, nr_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_material_p bigint, qt_dose_ataque_sug_p bigint, qt_dose_ataque_adm_p bigint, qt_dose_sug_p bigint, qt_dose_adm_p bigint, cd_unid_med_sug_p text, cd_unid_med_adm_p text, cd_interv_sug_p text, cd_interv_adm_p text, ds_justificativa_p text, nr_regra_serica_p bigint, ie_tipo_evento_p text) AS $body$
DECLARE


cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
nr_prescricao_w			prescr_medica.nr_prescricao%type;
nr_seq_material_w		prescr_material.nr_sequencia%type;
cd_material_w			material.cd_material%type;
qt_dose_sug_w			prescr_material.qt_dose%type;
qt_dose_adm_w			prescr_material.qt_dose%type;
cd_unid_med_sug_w		unidade_medida.cd_unidade_medida%type;
cd_unid_med_adm_w		unidade_medida.cd_unidade_medida%type;
cd_interv_sug_w			intervalo_prescricao.cd_intervalo%type;
cd_interv_adm_w			intervalo_prescricao.cd_intervalo%type;
ds_justificativa_w		prescr_material.ds_justificativa%type;


BEGIN

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') and (ie_tipo_evento_p IS NOT NULL AND ie_tipo_evento_p::text <> '') then

	if (ie_tipo_evento_p = 'S') then
		begin

		select	coalesce(max(a.cd_estabelecimento),1),
				max(b.cd_material)
		into STRICT	cd_estabelecimento_w,
				cd_material_w
		from	prescr_material b,
				prescr_medica a
		where	b.nr_sequencia = nr_seq_material_p
		and		a.nr_prescricao = b.nr_prescricao
		and		a.nr_prescricao = nr_prescricao_p;

		nr_seq_material_w	:= nr_seq_material_p;
		ds_justificativa_w	:= ds_justificativa_p;

		-- Dose de ataque
		if (qt_dose_ataque_sug_p IS NOT NULL AND qt_dose_ataque_sug_p::text <> '') then
			cd_interv_sug_w		:= Obter_interv_acm_sn_agora_lib(cd_estabelecimento_w, 1, 2, 1, cd_material_w, null, nr_prescricao_p, null, null);
			cd_interv_adm_w		:= cd_interv_sug_w;

			qt_dose_sug_w		:= qt_dose_ataque_sug_p;
			qt_dose_adm_w		:= qt_dose_ataque_adm_p;

			cd_unid_med_sug_w	:= cd_unid_med_sug_p;
			cd_unid_med_adm_w	:= cd_unid_med_adm_p;

			if (coalesce(qt_dose_sug_w,0) = coalesce(qt_dose_adm_w,0)) then
				ds_justificativa_w	:= null;

				delete	from rep_dialogo_vancomicina
				where	ie_tipo_evento = 'SA'
				and		nr_seq_material = nr_seq_material_w
				and		nr_prescricao = nr_prescricao_p;
			elsif (coalesce(qt_dose_adm_w::text, '') = '') then
				cd_interv_adm_w		:= null;
				cd_unid_med_adm_w	:= null;
			end if;

			insert into rep_dialogo_vancomicina(
							nr_sequencia,
							nr_atendimento,
							nr_prescricao,
							nr_seq_material,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							cd_intervalo_sugerido,
							cd_intervalo_adm,
							cd_unidade_medida,
							cd_unidade_medida_adm,
							qt_dose_manut_sugerida,
							qt_dose_manut_adm,
							ds_justificativa,
							nr_seq_nivel_serico,
							ie_situacao,
							ie_tipo_evento
						) values (
							nextval('rep_dialogo_vancomicina_seq'),
							nr_atendimento_p,
							nr_prescricao_p,
							nr_seq_material_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							cd_interv_sug_w,
							cd_interv_adm_w,
							cd_unid_med_sug_w,
							cd_unid_med_adm_w,
							qt_dose_sug_w,
							qt_dose_adm_w,
							ds_justificativa_w,
							nr_regra_serica_p,
							'A',
							'SA');
		end if;

		commit;

		ds_justificativa_w	:= ds_justificativa_p;

		-- Dose de manutenção
		if (qt_dose_sug_p IS NOT NULL AND qt_dose_sug_p::text <> '') then
			cd_interv_sug_w		:= cd_interv_sug_p;
			cd_interv_adm_w		:= cd_interv_adm_p;

			qt_dose_sug_w		:= qt_dose_sug_p;
			qt_dose_adm_w		:= qt_dose_adm_p;

			cd_unid_med_sug_w	:= cd_unid_med_sug_p;
			cd_unid_med_adm_w	:= cd_unid_med_adm_p;

			if (coalesce(qt_dose_sug_w,0) = coalesce(qt_dose_adm_w,0)) then
				ds_justificativa_w	:= null;

				delete	from rep_dialogo_vancomicina
				where	ie_tipo_evento = 'SM'
				and		nr_seq_material = nr_seq_material_w
				and		nr_prescricao = nr_prescricao_p;

			elsif (coalesce(qt_dose_adm_w::text, '') = '') then
				cd_interv_adm_w		:= null;
				cd_unid_med_adm_w	:= null;
			end if;

			insert into rep_dialogo_vancomicina(
							nr_sequencia,
							nr_atendimento,
							nr_prescricao,
							nr_seq_material,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							cd_intervalo_sugerido,
							cd_intervalo_adm,
							cd_unidade_medida,
							cd_unidade_medida_adm,
							qt_dose_manut_sugerida,
							qt_dose_manut_adm,
							ds_justificativa,
							nr_seq_nivel_serico,
							ie_situacao,
							ie_tipo_evento
						) values (
							nextval('rep_dialogo_vancomicina_seq'),
							nr_atendimento_p,
							nr_prescricao_p,
							nr_seq_material_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							cd_interv_sug_w,
							cd_interv_adm_w,
							cd_unid_med_sug_w,
							cd_unid_med_adm_w,
							qt_dose_sug_w,
							qt_dose_adm_w,
							ds_justificativa_w,
							nr_regra_serica_p,
							'A',
							'SM');
		end if;

		end;
	else
		ds_justificativa_w	:=	null;
		nr_prescricao_w		:=	null;

		if (ds_justificativa_p IS NOT NULL AND ds_justificativa_p::text <> '') then
			ds_justificativa_w	:=	substr(ds_justificativa_p,1,4000);
		end if;

		insert into rep_dialogo_vancomicina(
						nr_sequencia,
						nr_atendimento,
						nr_prescricao,
						nr_seq_material,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						cd_intervalo_sugerido,
						cd_intervalo_adm,
						cd_unidade_medida,
						cd_unidade_medida_adm,
						qt_dose_manut_sugerida,
						qt_dose_manut_adm,
						ds_justificativa,
						nr_seq_nivel_serico,
						ie_situacao,
						ie_tipo_evento
					) values (
						nextval('rep_dialogo_vancomicina_seq'),
						nr_atendimento_p,
						nr_prescricao_w,
						null,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						null,
						null,
						null,
						null,
						null,
						null,
						ds_justificativa_w,
						null,
						'A',
						ie_tipo_evento_p);

	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_acao_protocolo_vanco ( nm_usuario_p text, nr_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_material_p bigint, qt_dose_ataque_sug_p bigint, qt_dose_ataque_adm_p bigint, qt_dose_sug_p bigint, qt_dose_adm_p bigint, cd_unid_med_sug_p text, cd_unid_med_adm_p text, cd_interv_sug_p text, cd_interv_adm_p text, ds_justificativa_p text, nr_regra_serica_p bigint, ie_tipo_evento_p text) FROM PUBLIC;

