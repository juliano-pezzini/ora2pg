-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_se_prescr_sug_cih (nr_prescricao_p bigint, nr_seq_material_p bigint, nr_prescr_orig_p bigint, nr_prescr_retorno_p INOUT bigint, ie_prescr_sug_p INOUT text) AS $body$
DECLARE


nr_prescricao_w			prescr_medica.nr_prescricao%type;
nr_prescricao_2w		prescr_medica.nr_prescricao%type;
nr_prescr_retorno_w		prescr_medica.nr_prescricao%type := 0;
cd_material_w			prescr_material.cd_material%type;
cd_material_2w			prescr_material.cd_material%type;
nr_dia_util_w			prescr_material.nr_dia_util%type;
cd_estabelecimento_w	bigint;
ie_atb_pessoa_w			varchar(1);
dt_prescricao_w			prescr_medica.dt_prescricao%type;
dt_anterior_w			prescr_medica.dt_prescricao%type;
nr_atendimento_w		prescr_medica.nr_atendimento%type;
cd_pessoa_fisica_w		prescr_medica.cd_pessoa_fisica%type;
ie_prescr_sug_w			varchar(1) := 'N';
count_w					integer   := 0;
qt_sug_paciente_w bigint;

c01 CURSOR FOR
SELECT	nr_prescricao,
	cd_material
from	prescr_material
where	nr_prescricao		 = nr_prescr_orig_p
and	cd_material		= cd_material_w
and 	coalesce(ie_ciclo_reprov,'N') = 'N'
and 	(nr_dia_util IS NOT NULL AND nr_dia_util::text <> '')

union all

SELECT	a.nr_prescricao,
	a.cd_material
from 	prescr_material a,
	prescr_medica b
where  a.nr_prescricao	= b.nr_prescricao
and	b.dt_inicio_prescr between dt_anterior_w and dt_prescricao_w
and 	coalesce(ie_ciclo_reprov,'N') = 'N'	
and	coalesce(ie_atb_pessoa_w,'N') = 'N'
and	b.nr_atendimento	     = nr_atendimento_w
and	a.cd_material  	     = cd_material_w
and a.nr_dia_util 		    <= nr_dia_util_w

union all
                                                                                                                                                                                                                                            
select	a.nr_prescricao,
	a.cd_material
from 	prescr_material a,
	prescr_medica b
where  a.nr_prescricao	= b.nr_prescricao

and	b.dt_prescricao between dt_anterior_w and dt_prescricao_w
and 	coalesce(ie_ciclo_reprov,'N') = 'N'	
and	coalesce(ie_atb_pessoa_w,'N') = 'N'
and	b.nr_atendimento	     = nr_atendimento_w
and	a.cd_material  	     = cd_material_w
and 	a.nr_dia_util 	    <= nr_dia_util_w

union all

select	a.nr_prescricao,
	a.cd_material
from 	prescr_material a,
	prescr_medica b
where 	a.nr_prescricao  = b.nr_prescricao

and	b.dt_inicio_prescr between dt_anterior_w and dt_prescricao_w
and 	coalesce(ie_ciclo_reprov,'N') = 'N'	
and	coalesce(ie_atb_pessoa_w,'N') = 'S'
and 	b.cd_pessoa_fisica	     = cd_pessoa_fisica_w
and	a.cd_material 	     = cd_material_w
and 	a.nr_dia_util 	    <= nr_dia_util_w

union all

select	a.nr_prescricao,
	a.cd_material
from 	prescr_material a,
	prescr_medica b
where 	a.nr_prescricao  = b.nr_prescricao

and	b.dt_prescricao between dt_anterior_w and dt_prescricao_w
and 	coalesce(ie_ciclo_reprov,'N') = 'N'	
and	coalesce(ie_atb_pessoa_w,'N') = 'S'
and 	b.cd_pessoa_fisica	     = cd_pessoa_fisica_w
and	a.cd_material 	     	= cd_material_w
and 	a.nr_dia_util 	    <= nr_dia_util_w
order by 1;


BEGIN
cd_estabelecimento_w	:= coalesce(wheb_usuario_pck.get_cd_estabelecimento,0);

select	max(cd_material),
	max(nr_dia_util)
into STRICT 	cd_material_w,
	nr_dia_util_w
from  	prescr_material                                                                                                                                                                                                                               
where 	nr_sequencia 	= nr_seq_material_p                                                                                                                                                                                                           
and	nr_prescricao 		= nr_prescricao_p;

select 	max(dt_prescricao) + 1/24,
	max(nr_atendimento),
	max(cd_pessoa_fisica)
into STRICT   dt_prescricao_w,
	nr_atendimento_w,
	cd_pessoa_fisica_w
from   	prescr_medica
where  	nr_prescricao = nr_prescricao_p;

select	coalesce(max(ie_atb_pessoa),'N')
into STRICT	ie_atb_pessoa_w
from	parametro_medico
where	cd_estabelecimento	= cd_estabelecimento_w;

if (coalesce(nr_dia_util_w,0) = 0) then
	nr_dia_util_w := 1;
end if;

if (nr_dia_util_w > 7) then /*Problema de performance quando e maior que 7 dias*/
	nr_dia_util_w := 7;
end if;

dt_anterior_w	:= establishment_timezone_utils.startofday(dt_prescricao_w) - nr_dia_util_w;

select count(*)
into STRICT   qt_sug_paciente_w
from   medicamento_cih_sug
where  dt_atualizacao_nrec between dt_anterior_w and dt_prescricao_w
and	 Obter_dados_prescricao(nr_prescricao,'P') = cd_pessoa_fisica_w
and	 cd_material = cd_material_w;

if (qt_sug_paciente_w < 1) then
	select max(nr_sequencia),
		max(cd_material)
	into STRICT   qt_sug_paciente_w,
		cd_material_w
	from   medicamento_cih_sug
	where  dt_atualizacao_nrec between dt_anterior_w and dt_prescricao_w
	and	 Obter_dados_prescricao(nr_prescricao,'P') = cd_pessoa_fisica_w
	and	 cd_material_substituicao = cd_material_w
	and  ie_concordo = 'X';
end if;

ie_prescr_sug_w := 'N';
nr_prescr_retorno_w := 0;

if (qt_sug_paciente_w > 0) then

open C01;
loop
fetch C01 into	
	nr_prescricao_w,
	cd_material_2w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	select coalesce(max(nr_prescricao),0)
	into STRICT nr_prescricao_2w
	from medicamento_cih_sug
	where nr_prescricao = nr_prescricao_w
	and	cd_material 	= cd_material_2w;

	if (nr_prescricao_2w > 0) then
		nr_prescr_retorno_w := nr_prescricao_2w;
		ie_prescr_sug_w		:= 'S';
	end if;
end loop;
close C01;


end if;

ie_prescr_sug_p		:= ie_prescr_sug_w;
nr_prescr_retorno_p := nr_prescr_retorno_w;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_se_prescr_sug_cih (nr_prescricao_p bigint, nr_seq_material_p bigint, nr_prescr_orig_p bigint, nr_prescr_retorno_p INOUT bigint, ie_prescr_sug_p INOUT text) FROM PUBLIC;

