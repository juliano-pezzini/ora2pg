-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gedipa_higienizar_medicamento ( cd_estabelecimento_p bigint, cd_perfil_p bigint, nr_processo_p bigint, Nr_Seq_Frac_p bigint, nr_seq_area_p bigint, ie_higienizar_p text, nm_usuario_p text) AS $body$
DECLARE

				 
nr_sequencia_w		bigint;
ie_processo_sem_area_w	varchar(10);

BEGIN
 
ie_processo_sem_area_w := obter_param_usuario(3112, 23, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_processo_sem_area_w);
 
if (obter_se_todos_higienizado(nr_seq_area_p,nr_processo_p) = 'N') and (Nr_Seq_Frac_p IS NOT NULL AND Nr_Seq_Frac_p::text <> '') then 
	 
	update	adep_processo_item 
	set 	dt_higienizacao = clock_timestamp(), 
		nm_usuario 	= nm_usuario_p 
	where (nr_seq_frac = Nr_Seq_Frac_p) 
	and   ((nr_seq_area_p = 0) or (nr_seq_area_prep = nr_seq_area_p)) 
	and (coalesce(dt_suspensao::text, '') = '');
end if;
 
if	(coalesce((obter_se_todos_higienizado(nr_seq_area_p,nr_processo_p)),'S') = 'S') and (nr_processo_p IS NOT NULL AND nr_processo_p::text <> '') and (nr_seq_area_p IS NOT NULL AND nr_seq_area_p::text <> '') and 
	((nr_seq_area_p	> 0) or (coalesce(ie_processo_sem_area_w,'N') = 'S')) and (ie_higienizar_p IS NOT NULL AND ie_higienizar_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then 
	if (ie_higienizar_p = 'S') then 
	 
		if (coalesce(nr_seq_area_p,0) = 0) then 
			update	adep_processo_area 
			set	dt_higienizacao		= clock_timestamp(), 
				nm_usuario_higienizacao	= nm_usuario_p 
			where	nr_seq_processo		= nr_processo_p 
			and	coalesce(dt_higienizacao::text, '') = '' 
			and	coalesce(nm_usuario_higienizacao::text, '') = '';		
		else 
			update	adep_processo_area 
			set	dt_higienizacao		= clock_timestamp(), 
				nm_usuario_higienizacao	= nm_usuario_p 
			where	nr_seq_processo		= nr_processo_p 
			and	nr_seq_area_prep	= nr_seq_area_p 
			and	coalesce(dt_higienizacao::text, '') = '' 
			and	coalesce(nm_usuario_higienizacao::text, '') = '';
		end if;		
		CALL atualiza_status_processo_adep(nr_processo_p, nr_seq_area_p, 'G', 'H', clock_timestamp(), nm_usuario_p);
 
	else 
		if (coalesce(nr_seq_area_p,0) = 0) then 
			update	adep_processo_area 
			set	dt_higienizacao		 = NULL, 
				nm_usuario_higienizacao	 = NULL 
			where	nr_seq_processo		= nr_processo_p 
			and	(dt_higienizacao IS NOT NULL AND dt_higienizacao::text <> '') 
			and	(nm_usuario_higienizacao IS NOT NULL AND nm_usuario_higienizacao::text <> '');
		else		 
			update	adep_processo_area 
			set	dt_higienizacao		 = NULL, 
				nm_usuario_higienizacao	 = NULL 
			where	nr_seq_processo		= nr_processo_p 
			and	nr_seq_area_prep	= nr_seq_area_p 
			and	(dt_higienizacao IS NOT NULL AND dt_higienizacao::text <> '') 
			and	(nm_usuario_higienizacao IS NOT NULL AND nm_usuario_higienizacao::text <> '');
		end if;
	end if;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gedipa_higienizar_medicamento ( cd_estabelecimento_p bigint, cd_perfil_p bigint, nr_processo_p bigint, Nr_Seq_Frac_p bigint, nr_seq_area_p bigint, ie_higienizar_p text, nm_usuario_p text) FROM PUBLIC;

