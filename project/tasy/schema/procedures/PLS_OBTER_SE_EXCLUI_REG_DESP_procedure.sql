-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_se_exclui_reg_desp ( nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_proc_partic_p pls_proc_participante.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_protocolo_p pls_lote_protocolo_conta.nr_sequencia%type, ie_valida_status_p text default 'D') AS $body$
DECLARE


qt_registro_pagamento_w	integer;
nr_seq_retorno_w	dic_objeto.nr_sequencia%type;
nr_seq_guia_w		pls_guia_plano.nr_sequencia%type;

-- Dados  da PLS_CONTA
C01 CURSOR(nr_seq_conta_p	pls_conta.nr_sequencia%type) FOR
	SELECT	ie_status ie_status,
		nr_sequencia nr_seq_conta
	from	pls_conta
	where	nr_sequencia = nr_seq_conta_p;

-- Dados da PLS_LOTE_PROTOCOLO_CONTA
C02 CURSOR(nr_seq_lote_protocolo_p	pls_lote_protocolo_conta.nr_sequencia%type) FOR
	SELECT	nr_sequencia
	from	pls_lote_protocolo_conta
	where	nr_sequencia = nr_seq_lote_protocolo_p;

-- Protocolos do lote
C03 CURSOR(nr_seq_lote_protocolo_p	pls_lote_protocolo_conta.nr_sequencia%type) FOR
	SELECT	nr_sequencia nr_seq_protocolo
	from	pls_protocolo_conta
	where	nr_seq_lote = nr_seq_lote_protocolo_p;

-- Dados da PLS_PROTOCOLO_CONTA
C04 CURSOR(nr_seq_protocolo_p	pls_protocolo_conta.nr_sequencia%type) FOR
	SELECT	nr_sequencia,
		ie_status,
		ie_situacao
	from	pls_protocolo_conta
	where	nr_sequencia = nr_seq_protocolo_p;

-- Contas do protocolo.
C05 CURSOR(nr_seq_protocolo_p	pls_protocolo_conta.nr_sequencia%type) FOR
	SELECT	nr_sequencia nr_seq_conta
	from	pls_conta
	where	nr_seq_protocolo = nr_seq_protocolo_p;

-- Procedimentos da conta
C06 CURSOR(nr_seq_conta_p	pls_conta.nr_sequencia%type) FOR
	SELECT	nr_sequencia nr_seq_conta_proc,
		nr_seq_conta
	from	pls_conta_proc
	where	nr_seq_conta = nr_seq_conta_p;

-- Materiais da conta
C07 CURSOR(nr_seq_conta_p	pls_conta.nr_sequencia%type) FOR
	SELECT	nr_sequencia nr_seq_conta_mat,
		nr_seq_conta
	from	pls_conta_mat
	where	nr_seq_conta = nr_seq_conta_p;

-- Dados do procedimento da conta PLS_CONTA_PROC
C08 CURSOR(nr_seq_conta_proc_p	pls_conta_proc.nr_sequencia%type) FOR
	SELECT	nr_sequencia,
		nr_seq_conta,
		ie_status
	from	pls_conta_proc
	where	nr_sequencia = nr_seq_conta_proc_p;

-- Participantes do procedimento;
C09 CURSOR(nr_seq_conta_proc_p	pls_conta_proc.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia nr_seq_participante,
		b.nr_seq_conta
	from	pls_conta_proc b,
		pls_proc_participante a
	where	b.nr_sequencia	= nr_seq_conta_proc_p
	and	a.nr_seq_conta_proc = b.nr_sequencia;

-- Dados do participante do procedimento.PLS_PROC_PARTICIPANTE
C10 CURSOR(nr_seq_conta_proc_partic_p	pls_proc_participante.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia,
		a.nr_seq_conta_proc,
		b.nr_seq_conta
	from	pls_proc_participante	a,
		pls_conta_proc		b
	where	a.nr_sequencia = nr_seq_conta_proc_partic_p
	and	b.nr_sequencia = a.nr_seq_conta_proc;

-- Dados do material da conta PLS_CONTA_MAT
C11 CURSOR(nr_seq_conta_mat_p	pls_conta_mat.nr_sequencia%type) FOR
	SELECT	nr_sequencia,
		nr_seq_conta,
		ie_status
	from	pls_conta_mat
	where	nr_sequencia = nr_seq_conta_mat_p;
BEGIN
/* ESTA PROCEDURE É CHAMADA ANTES DE EXCLUIR OS REGISTROS NAS TABELAS INDICADAS NOS PARÂMETROS */

nr_seq_retorno_w := null;

-- Exclusão de lote de protocolos
if (nr_seq_lote_protocolo_p IS NOT NULL AND nr_seq_lote_protocolo_p::text <> '') then
	-- Validação dos dados do Lote
	for	r_C02_w	in C02(nr_seq_lote_protocolo_p) loop
		-- Verificar se os protocolos do lote podem ser excluidos
		for	r_C03_w in C03(nr_seq_lote_protocolo_p) loop
			-- Verifica se o protocolo pode ser excluído.
			CALL pls_obter_se_exclui_reg_desp(null,null,null,null,r_C03_w.nr_seq_protocolo,null,ie_valida_status_p);
		end loop; -- C03
	end loop; -- C02
-- Exclusão de protocolos
elsif (nr_seq_protocolo_p IS NOT NULL AND nr_seq_protocolo_p::text <> '') then
	-- Validação dos dados do protocolo
	for	r_C04_w in C04(nr_seq_protocolo_p) loop

		if (r_C04_w.ie_status = '4') and (r_c04_w.ie_situacao in ('D','T')) then

			-- O status do protocolo #@NR_SEQ_PROTOCOLO#@ é encerrado sem pagamento, por este motivo não pode ser excluído.
			CALL wheb_mensagem_pck.Exibir_mensagem_abort(408130,'NR_SEQ_PROTOCOLO='||nr_seq_protocolo_p||';');
		else

			select	count(1)
			into STRICT	qt_registro_pagamento_w
			from	pls_prot_conta_titulo a,
				pls_lote_protocolo b
			where	a.nr_seq_protocolo = nr_seq_protocolo_p
			and	b.nr_sequencia = a.nr_seq_lote  LIMIT 1;

			if (qt_registro_pagamento_w > 0) then

				-- O protocolo #@NR_SEQ_PROTOCOLO#@ já possui um lote de pagamento gerado, favor verificar na pasta Lote de pagamento.
				CALL wheb_mensagem_pck.Exibir_mensagem_abort(443849,'NR_SEQ_PROTOCOLO='||nr_seq_protocolo_p||';');
			else
				-- Verificar se as contas do protcolo podem ser excluidas
				for	r_C05_w in C05(nr_seq_protocolo_p) loop
					-- Verifica se a conta pode ser excluída.
					CALL pls_obter_se_exclui_reg_desp(r_C05_w.nr_seq_conta,null,null,null,null,null,ie_valida_status_p);
				end loop; -- C05
			end if;
		end if;
	end loop; -- C04
-- Exclusão de contas.
elsif (nr_seq_conta_p IS NOT NULL AND nr_seq_conta_p::text <> '') then
	select	max(nr_seq_guia)
	into STRICT	nr_seq_guia_w
	from	pls_conta
	where	nr_sequencia	= nr_seq_conta_p;
	/*Se estiver excluindo uma guia de apresentação automatica atualiza a mesma para voltar a ser apresentada*/

	if (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') then
		update	pls_guia_plano
		set	ie_pagamento_automatico = 'PA',
			ie_status 		= '1'
		where	nr_sequencia		= nr_seq_guia_w
		and	ie_pagamento_automatico	= 'CG';
	end if;
	-- Validação para dados da conta
	for	r_C01_w in C01(nr_seq_conta_p) loop
		if (r_C01_w.ie_status <> 'U')	and (ie_valida_status_p = 'D')	then
			/*
			A conta não pode ser excluída, já foi executada uma ação de usuário sobre ela.
			Para excluí-la será necessário retorná-la para o status "Usuário aguardando ação".*/
			CALL wheb_mensagem_pck.Exibir_mensagem_abort(240614,'NR_SEQ_CONTA='||nr_seq_conta_p||';');
		end if;

		-- retirado a validação do pagamento a nível de conta pois o correto é descer a nível de item e
		-- ali verificar se algum possuí registro de pagamento
		-- Verificar se os procedimentos da conta podem ser excluídos
		for	r_C06_w in C06(nr_seq_conta_p) loop
			-- Verifica se o procedimento pode ser excluída.
			CALL pls_obter_se_exclui_reg_desp(null,r_C06_w.nr_seq_conta_proc,null,null,null,null,ie_valida_status_p);
		end loop; -- C06
		-- Verificar se os materiais da conta podem ser excluídos
		for	r_C07_w in C07(nr_seq_conta_p) loop
			-- Verifica se o procedimento pode ser excluída.
			CALL pls_obter_se_exclui_reg_desp(null,null,null,r_C07_w.nr_seq_conta_mat,null,null,ie_valida_status_p);
		end loop; -- C07
	end loop; -- C01
-- Exclusão do procedimento da conta
elsif (nr_seq_conta_proc_p IS NOT NULL AND nr_seq_conta_proc_p::text <> '') then
	--Validação dos dados do procedimento da conta
	for	r_C08_w in C08(nr_seq_conta_proc_p) loop
		-- validação para registros de pagamento da Produção Médica.
		qt_registro_pagamento_w := pls_obter_qt_vinc_res_pag(r_C08_w.nr_seq_conta, nr_seq_conta_proc_p,'CP');

		if (qt_registro_pagamento_w > 0) then
			/*Não é possível excluir esta conta.
			Já foram gerados registros de Pagamento da produção médica que não podem ser desfeitos.
			A conta pode ser cancelada , usando a ação de botão direito "Cancelar conta "para a mesma não seja mais utilizada ou contabilizada. */
			CALL wheb_mensagem_pck.Exibir_mensagem_abort(241298,'NR_SEQ_CONTA='||r_C08_w.nr_seq_conta||';'||
									'NR_SEQ_CONTA_PROC='||nr_seq_conta_proc_p||';');
		else
			qt_registro_pagamento_w := 0;
		end if;

		if (r_C08_w.ie_status not in ('U','D','M')) 	and (ie_valida_status_p = 'D')		then
			/*
			A conta não pode ser excluída, já foi executada uma ação de usuário sobre ela.
			Para excluí-la será necessário retorná-la para o status "Usuário aguardando ação".*/
			CALL wheb_mensagem_pck.Exibir_mensagem_abort(241317,'NR_SEQ_CONTA_PROC='||nr_seq_conta_proc_p||';'||
									'NR_SEQ_CONTA='||r_C08_w.nr_seq_conta||';');
		end if;

		-- verificar se os participantes do proceidmento podem ser excluídos.
		for	r_C09_w in C09(nr_seq_conta_proc_p) loop
			-- Verifica se o participante pode ser excluída.
			CALL pls_obter_se_exclui_reg_desp(null,null,r_C09_w.nr_seq_participante,null,null,null,ie_valida_status_p);
		end loop;-- C09
	end loop; -- C08
-- Exclusão do participante do procedimento
elsif (nr_seq_proc_partic_p IS NOT NULL AND nr_seq_proc_partic_p::text <> '') then
	-- Validacao dos dados do participante
	for	r_C10_w in C10(nr_seq_proc_partic_p) loop
		-- validação para registros de pagamento da Produção Médica.
		qt_registro_pagamento_w := pls_obter_qt_vinc_res_pag(r_C10_w.nr_seq_conta, nr_seq_proc_partic_p,'PP');

		if (qt_registro_pagamento_w > 0) then
			/*Não é possível excluir esta conta.
			Já foram gerados registros de Pagamento da produção médica que não podem ser desfeitos.
			A conta pode ser cancelada , usando a ação de botão direito "Cancelar conta "para a mesma não seja mais utilizada ou contabilizada. */
			CALL wheb_mensagem_pck.Exibir_mensagem_abort(241301,'NR_SEQ_CONTA='||r_C10_w.nr_seq_conta||';'||
									'NR_SEQ_CONTA_PROC='||r_C10_w.nr_seq_conta_proc||';'||
									'NR_SEQ_PARTIC='||nr_seq_proc_partic_p||';');
		else
			qt_registro_pagamento_w := 0;
		end if;
	end loop;--C10
-- Exclusão dos materiais da conta
elsif (nr_seq_conta_mat_p IS NOT NULL AND nr_seq_conta_mat_p::text <> '') then
	-- Validacao dos dados do material
	for	r_C11_w in C11(nr_seq_conta_mat_p) loop

		qt_registro_pagamento_w	:= 0;

		if (r_C11_w.ie_status = 'U') then
			-- validação para registros de pagamento da Produção Médica.
			qt_registro_pagamento_w := pls_obter_qt_vinc_res_pag(r_C11_w.nr_seq_conta, nr_seq_conta_mat_p,'CM');

			if (qt_registro_pagamento_w > 0) then
				/*Não é possível excluir esta conta.
				Já foram gerados registros de Pagamento da produção médica que não podem ser desfeitos.
				A conta pode ser cancelada , usando a ação de botão direito "Cancelar conta "para a mesma não seja mais utilizada ou contabilizada. */
				CALL wheb_mensagem_pck.Exibir_mensagem_abort(241303,'NR_SEQ_CONTA='||r_C11_w.nr_seq_conta||';'||
									'NR_SEQ_MATERIAL='||nr_seq_conta_mat_p||';');
			end if;
		end if;

		if (r_C11_w.ie_status not in ('U','D','M'))	and (ie_valida_status_p = 'D')		then
			/*
			A conta não pode ser excluída, já foi executada uma ação de usuário sobre ela.
			Para excluí-la será necessário retorná-la para o status "Usuário aguardando ação".*/
			CALL wheb_mensagem_pck.Exibir_mensagem_abort(241321,'NR_SEQ_CONTA_MAT='||nr_seq_conta_proc_p||';'||
									'NR_SEQ_CONTA='||r_C11_w.nr_seq_conta||';');
		end if;

	end loop;--C11
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_se_exclui_reg_desp ( nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_proc_partic_p pls_proc_participante.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_protocolo_p pls_lote_protocolo_conta.nr_sequencia%type, ie_valida_status_p text default 'D') FROM PUBLIC;

