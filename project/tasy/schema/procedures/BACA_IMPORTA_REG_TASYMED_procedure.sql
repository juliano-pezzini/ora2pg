-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_importa_reg_tasymed ( cd_pessoa_fisica_p text, cd_profissional_p text, nm_usuario_export_p text, nr_atendimento_p bigint default null, nr_seq_pepa_p bigint default null, nr_seq_cliente_p bigint default null) AS $body$
DECLARE


nr_atendimento_w		bigint;

C01 CURSOR FOR
	SELECT	a.nr_atendimento
	from	med_atendimento a,
			med_cliente b
	where	a.nr_seq_cliente = b.nr_sequencia
	and		a.nr_atendimento  = coalesce(nr_atendimento_p,a.nr_atendimento)
	and		b.cd_pessoa_fisica = cd_pessoa_fisica_p
	order by nr_atendimento desc;



BEGIN

if (coalesce(nr_atendimento_p::text, '') = '' or (nr_seq_pepa_p IS NOT NULL AND nr_seq_pepa_p::text <> '')) then

	begin

	CALL wheb_usuario_pck.set_ie_executar_trigger('N');

	open C01;
	loop
	fetch C01 into
		nr_atendimento_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		begin

		/*  Exames nao laboratoriais */

			update  laudo_paciente
			set		ie_nivel_atencao = 'S'
			where	nr_Atendimento = nr_atendimento_w;

		/*Escala e indices */

			update  pac_clereance_creatinina
			set		ie_nivel_atencao = 'S'
			where	nr_atendimento = nr_atendimento_w;

			update  escala_framingham
			set		ie_nivel_atencao = 'S'
			where	nr_atendimento = nr_atendimento_w;


			update  ESCALA_CHADS2
			set		ie_nivel_atencao = 'S'
			where	nr_atendimento = nr_atendimento_w;


			update  ESCALA_CHA2DS2VASC
			set		ie_nivel_atencao = 'S'
			where	nr_atendimento = nr_atendimento_w;


			update  ESCALA_HAS_BLED
			set		ie_nivel_atencao = 'S'
			where	nr_atendimento = nr_atendimento_w;

			update  ESCALA_EPWORTH
			set		ie_nivel_atencao = 'S'
			where	nr_atendimento = nr_atendimento_w;

		/* Cirurgias */

			update  cirurgia
			set		ie_nivel_atencao = 'S',
					nr_seq_atend_cons_pepa = nr_seq_pepa_p
			where	nr_atendimento = nr_atendimento_w;

		/* Receitas */

			update  Med_Receita
			set		ie_nivel_atencao = 'S',
					nr_seq_atend_cons_pepa = nr_seq_pepa_p,
					dt_liberacao = dt_atualizacao
			where	nr_atendimento = nr_atendimento_w;

		/* Avaliacao */
	

			update  MED_AVALIACAO_PACIENTE
			set		ie_nivel_atencao = 'S',
					NR_SEQ_ATEND_CONS_PEPA = nr_seq_pepa_p
			where	nr_atendimento = nr_atendimento_p;


		exception when others then
			rollback;
			CALL wheb_usuario_pck.set_ie_executar_trigger('S');
		end;

		end;

	end loop;
	close C01;

  begin

  		update  Med_Receita
			set		ie_nivel_atencao = 'S',
            dt_liberacao = dt_receita
			where	nr_seq_cliente = nr_seq_cliente_p
      and   cd_medico = cd_profissional_p
      and   ie_situacao = 'A'
      and   coalesce(dt_liberacao::text, '') = '';


      update  cirurgia
			set		ie_nivel_atencao = 'S',
					nr_seq_atend_cons_pepa = nr_seq_pepa_p
			where	nr_atendimento = nr_atendimento_p;

      commit;


  exception when others then
    rollback;
    CALL wheb_usuario_pck.set_ie_executar_trigger('S');
  end;

	commit;

	CALL wheb_usuario_pck.set_ie_executar_trigger('S');

	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_importa_reg_tasymed ( cd_pessoa_fisica_p text, cd_profissional_p text, nm_usuario_export_p text, nr_atendimento_p bigint default null, nr_seq_pepa_p bigint default null, nr_seq_cliente_p bigint default null) FROM PUBLIC;

