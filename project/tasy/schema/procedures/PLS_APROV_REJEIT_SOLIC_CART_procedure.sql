-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_aprov_rejeit_solic_cart ( nr_seq_solic_cart_adic_p bigint, ie_acao_p text, nr_seq_motivo_rejeicao_p bigint, ds_observacao_rejeicao_p text, nm_usuario_p text) AS $body$
DECLARE

 
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade: 
Rejeitar a solicitação de 2ª via da carteirinha 
 
ie_acao_p 
A - Aprovar solicitação 
R - rejeitar solicitação 
------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[ ] Objetos do dicionário [ x] Tasy (Delphi/Java) [  ] Portal [ ] Relatórios [ ] Outros: 
 ------------------------------------------------------------------------------------------------------------------ 
Pontos de atenção: 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 
 
nr_seq_carteira_w		pls_segurado_carteira.nr_sequencia%type;
nr_seq_motivo_via_w		pls_motivo_via_adicional.nr_sequencia%type;
cd_funcao_w			integer;
ie_tipo_processo_w		varchar(1);
ie_criar_lote_via_adic_w	varchar(1);


BEGIN 
if (ie_acao_p = 'A') then 
	select	nr_seq_carteira, 
		nr_seq_motivo_via, 
		cd_funcao, 
		ie_tipo_processo, 
		ie_criar_lote_via_adic 
	into STRICT	nr_seq_carteira_w, 
		nr_seq_motivo_via_w, 
		cd_funcao_w, 
		ie_tipo_processo_w, 
		ie_criar_lote_via_adic_w 
	from	pls_solic_carteira_adic 
	where	nr_sequencia	= nr_seq_solic_cart_adic_p;
 
	CALL pls_gerar_solic_via_cart_web(	nr_seq_carteira_w, nr_seq_motivo_via_w, cd_funcao_w, 
					ie_tipo_processo_w, ie_criar_lote_via_adic_w, nm_usuario_p);
					 
	update	pls_solic_carteira_adic 
	set	dt_aprovacao		= clock_timestamp(), 
		dt_atualizacao		= clock_timestamp(), 
		nm_usuario_aprovador	= nm_usuario_p, 
		nm_usuario		= nm_usuario_p, 
		ie_status		= 1 
	where	nr_sequencia		= nr_seq_solic_cart_adic_p;
	 
elsif (ie_acao_p = 'R') and (nr_seq_motivo_rejeicao_p IS NOT NULL AND nr_seq_motivo_rejeicao_p::text <> '') then 
	update	pls_solic_carteira_adic 
	set	nr_seq_motivo_rejeicao	= nr_seq_motivo_rejeicao_p, 
		ds_observacao_rejeicao	= ds_observacao_rejeicao_p, 
		dt_rejeicao		= clock_timestamp(), 
		dt_atualizacao		= clock_timestamp(), 
		nm_usuario		= nm_usuario_p, 
		ie_status		= 2 
	where	nr_sequencia		= nr_seq_solic_cart_adic_p;
	 
	CALL pls_gerar_comunic_externo_web(nr_seq_solic_cart_adic_p, 6, nm_usuario_p);
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_aprov_rejeit_solic_cart ( nr_seq_solic_cart_adic_p bigint, ie_acao_p text, nr_seq_motivo_rejeicao_p bigint, ds_observacao_rejeicao_p text, nm_usuario_p text) FROM PUBLIC;

