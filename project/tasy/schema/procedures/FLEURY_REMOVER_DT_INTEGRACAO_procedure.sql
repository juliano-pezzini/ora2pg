-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fleury_remover_dt_integracao ( nr_prescricao_p bigint) AS $body$
DECLARE

 
C01 CURSOR FOR 
	SELECT	a.nr_prescricao, 
		a.nr_sequencia 
	from	prescr_procedimento a 
	where	(a.nr_seq_exame IS NOT NULL AND a.nr_seq_exame::text <> '') 
	and 	(obter_sigla_exame_fleury(a.nr_prescricao, a.nr_sequencia) IS NOT NULL AND (obter_sigla_exame_fleury(a.nr_prescricao, a.nr_sequencia))::text <> '') 
	and	a.nr_prescricao = nr_prescricao_p 
	
union
 
	SELECT	a.nr_prescricao, 
		a.nr_sequencia 
	from	prescr_procedimento a 
	where	coalesce(a.nr_seq_exame::text, '') = '' 
	and 	(obter_sigla_exame_fleury_diag(a.nr_prescricao, a.nr_sequencia) IS NOT NULL AND (obter_sigla_exame_fleury_diag(a.nr_prescricao, a.nr_sequencia))::text <> '') 
	and	a.nr_prescricao = nr_prescricao_p;
	
c01_w		c01%rowtype;
nr_seq_log_w	numeric(20);


BEGIN 
 
open c01;
loop 
fetch c01 into c01_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	 
	update	prescr_procedimento 
	set	dt_integracao  = NULL 
	where	nr_prescricao = c01_w.nr_prescricao 
	and	nr_sequencia = c01_w.nr_sequencia;
	 
	nr_seq_log_w := lab_gravar_fleury_log(	'Enviado pela conta paciente: '||to_char(c01_w.nr_prescricao)||' - '||to_char(c01_w.nr_sequencia), ' ', ' ', ' ', wheb_usuario_pck.get_nm_usuario, c01_w.nr_prescricao, '0', nr_seq_log_w);
	end;
end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fleury_remover_dt_integracao ( nr_prescricao_p bigint) FROM PUBLIC;

