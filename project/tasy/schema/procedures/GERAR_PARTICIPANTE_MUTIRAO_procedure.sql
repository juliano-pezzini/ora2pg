-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_participante_mutirao (nr_seq_mutirao_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_material_w			integer;
cd_procedimento_w 		bigint;
nr_seq_proc_interno_w	bigint;	
qt_max_atendimento_w	bigint;		
cd_estabelecimento_w	bigint;
cd_pessoa_fisica_w		bigint;
nr_seq_pac_mut_w		bigint;
count_w			bigint := 0;
nr_seq_lista_espera_w	bigint;
nr_seq_mutirao_w		bigint;
nr_seq_ageint_w		bigint;

C01 CURSOR FOR
	SELECT  a.cd_pessoa_fisica cd_pessoa_fisica,
			a.nr_sequencia 	nr_seq_lista
	from    agenda_lista_espera a
	where   a.ie_status_espera = 'A'
	and     coalesce(a.cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w
	and     ((a.cd_procedimento = cd_procedimento_w and (a.cd_procedimento IS NOT NULL AND a.cd_procedimento::text <> '')) or (a.nr_seq_proc_interno = nr_seq_proc_interno_w and (a.nr_seq_proc_interno IS NOT NULL AND a.nr_seq_proc_interno::text <> '')) or (a.cd_material  = cd_material_w and (a.cd_material IS NOT NULL AND a.cd_material::text <> '')))
	and 	(a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '')
	and		not exists (SELECT 1
						from    paciente_mutirao c, 
								mutirao_lista_espera b 
						where   c.nr_seq_mutirao = b.nr_sequencia
						and     c.nr_seq_lista_espera = a.nr_sequencia)
	order by 	(obter_score_paciente(nr_sequencia, 'T'))::numeric  desc;
	

BEGIN

select  max(cd_procedimento),
		max(nr_seq_proc_interno),
        max(cd_material),
        max(qt_max_atendimento),
		max(cd_estabelecimento),
		max(nr_sequencia)
into STRICT	cd_procedimento_w,
		nr_seq_proc_interno_w,
		cd_material_w,
		qt_max_atendimento_w,
		cd_estabelecimento_w,
		nr_seq_mutirao_w
from    mutirao_lista_espera
where   nr_sequencia = nr_seq_mutirao_p;


 for agenda_lista_espera in C01 loop

		cd_pessoa_fisica_w := agenda_lista_espera.cd_pessoa_fisica;
		nr_seq_lista_espera_w := agenda_lista_espera.nr_seq_lista;
		
		count_w := count_w + 1;	
		
			insert
			into	paciente_mutirao(nr_sequencia,			
				dt_atualizacao,			
				nm_usuario,				
				dt_atualizacao_nrec,		
				nm_usuario_nrec,			
				nr_seq_mutirao,			
				nr_seq_lista_espera,		
				cd_pessoa_fisica,		
				dt_inclusao				
				)
			values (nextval('paciente_mutirao_seq'),
				 clock_timestamp(),
				 nm_usuario_p,
				 clock_timestamp(),
				 nm_usuario_p,
				 nr_seq_mutirao_p,
				 nr_seq_lista_espera_w,
				 cd_pessoa_fisica_w,
				 trunc(clock_timestamp())
				);

		nr_seq_ageint_w := ageint_ger_agend_list_esp_html(nr_seq_lista_espera_w, Obter_Pessoa_Fisica_Usuario(nm_usuario_p, 'C'), wheb_usuario_pck.get_cd_estabelecimento, nm_usuario_p, nr_seq_mutirao_w, nr_seq_ageint_w);
		
		if (count_w >= coalesce(qt_max_atendimento_w, 0))then
			exit;
		end if;

end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_participante_mutirao (nr_seq_mutirao_p bigint, nm_usuario_p text) FROM PUBLIC;

