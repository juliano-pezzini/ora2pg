-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_imp_preco_externo (cd_exame_p text, cd_cnpj_p text, dt_inicio_vigencia_p timestamp, vl_exame_p bigint, nm_usuario_p text) AS $body$
DECLARE

qt_cnpj_w 		bigint;
nr_seq_lab_preco_w 	bigint;
nr_seq_exame_p 	  	bigint;
qt_exame_w		bigint;


BEGIN

select count(*)
into STRICT qt_cnpj_w
from LAB_TAB_PRECO_EXTERNO
where cd_cgc_externo = cd_cnpj_p
and   DT_INICIO_VIGENCIA = dt_inicio_vigencia_p;

if (qt_cnpj_w = 0) then
	insert into LAB_TAB_PRECO_EXTERNO(
		   			NR_SEQUENCIA,
		   			DT_ATUALIZACAO,
					NM_USUARIO,
					DT_ATUALIZACAO_NREC,
					NM_USUARIO_NREC,
					DT_INICIO_VIGENCIA,
					DT_FIM_VIGENCIA,
					CD_CGC_EXTERNO)
	values (
					nextval('lab_tab_preco_externo_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					dt_inicio_vigencia_p,
					null,
					cd_cnpj_p);
	commit;
end if;

select max(NR_SEQUENCIA)
into STRICT nr_seq_lab_preco_w
from LAB_TAB_PRECO_EXTERNO
where cd_cgc_externo = cd_cnpj_p
and   DT_INICIO_VIGENCIA = dt_inicio_vigencia_p;

select max(nr_seq_exame)
into STRICT nr_seq_exame_p
from EXAME_LABORATORIO
where cd_exame = cd_exame_p;

select count(*)
into STRICT qt_exame_w
from LAB_TAB_PRECO_EXTERNO_ITEM
where nr_seq_exame = nr_seq_exame_p
and   NR_SEQ_TAB_PRECO = nr_seq_lab_preco_w;

if (qt_exame_w = 0) then
	insert into LAB_TAB_PRECO_EXTERNO_ITEM( NR_SEQUENCIA,
					        DT_ATUALIZACAO,
						NM_USUARIO,
						DT_ATUALIZACAO_NREC,
						NM_USUARIO_NREC,
						NR_SEQ_EXAME,
						VL_EXAME,
						NR_SEQ_TAB_PRECO,
						DT_INICIO_VIGENCIA,
						DT_FIM_VIGENCIA)
	values (
						nextval('lab_tab_preco_externo_item_seq'),
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_exame_p,
						vl_exame_p,
						nr_seq_lab_preco_w,
						dt_inicio_vigencia_p,
						null);
	commit;
else
      update LAB_TAB_PRECO_EXTERNO_ITEM
      set 		DT_ATUALIZACAO = clock_timestamp(),
			NM_USUARIO = nm_usuario_p,
			DT_INICIO_VIGENCIA = dt_inicio_vigencia_p,
			VL_EXAME = vl_exame_p
      where nr_seq_exame = nr_seq_exame_p
      and   NR_SEQ_TAB_PRECO = nr_seq_lab_preco_w;

      commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_imp_preco_externo (cd_exame_p text, cd_cnpj_p text, dt_inicio_vigencia_p timestamp, vl_exame_p bigint, nm_usuario_p text) FROM PUBLIC;

