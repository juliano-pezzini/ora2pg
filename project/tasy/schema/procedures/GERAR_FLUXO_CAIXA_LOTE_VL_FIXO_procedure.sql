-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_fluxo_caixa_lote_vl_fixo ( nr_seq_lote_fluxo_p bigint, cd_conta_financ_p bigint, nr_dia_fixo_p bigint, vl_fixo_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, cd_empresa_p bigint, nr_seq_regra_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
/*--------------------------------------------------------------- ATENÇÃO ----------------------------------------------------------------*/
 
/* Cuidado ao realizar alterações no fluxo de caixa em lote. Toda e qualquer alteração realizada em qualquer uma */
 
/* das procedures do fluxo de caixa em lote deve ser cuidadosamente verificada e realizada no fluxo de caixa   */
 
/* convencional. Devemos garantir que os dois fluxos de caixa tragam os mesmos valores no resultado, evitando   */
 
 
/* assim que existam diferenças entre os fluxos de caixa.                                                */
 
/*--------------- AO ALTERAR O FLUXO DE CAIXA EM LOTE ALTERAR TAMBÉM O FLUXO DE CAIXA ---------------*/
 
 
ie_tratar_fim_semana_w		varchar(100);
ie_antecipar_dia_util_w		varchar(100);
ie_dia_fixo_w			varchar(100);
ie_dia_diferente_w		varchar(100);
ie_regra_data_w			varchar(3);
vl_deducao_w			double precision;
dt_ref_original_w		timestamp;
dt_referencia_w			timestamp;
dt_mes_w			timestamp;
pr_fluxo_w			regra_fluxo_caixa.pr_fluxo%type;


BEGIN 
select	ie_tratar_fim_semana 
into STRICT	ie_tratar_fim_semana_w 
from	parametro_fluxo_caixa 
where	cd_estabelecimento	= cd_estabelecimento_p;
 
select	coalesce(ie_antecipar_dia_util, 'N'), 
	coalesce(ie_dia_fixo, 'N'), 
	coalesce(ie_regra_data,'F'), 
	coalesce(pr_fluxo,0) 
into STRICT	ie_antecipar_dia_util_w, 
	ie_dia_fixo_w, 
	ie_regra_data_w, 
	pr_fluxo_w 
from	regra_fluxo_caixa 
where	nr_sequencia = nr_seq_regra_p;
 
if	not(coalesce(nr_dia_fixo_p,0) between 1 and 31) then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(195875,'DS_CONTA='||OBTER_DESC_CONTA_FINANC(cd_conta_financ_p));
end if;
 
dt_mes_w	:= pkg_date_utils.start_of(dt_inicial_p,'MONTH', 0);
 
while(dt_mes_w <= pkg_date_utils.start_of(dt_final_p, 'MONTH', 0)) loop 
	ie_dia_diferente_w		:= 'N';
	 
	if (nr_dia_fixo_p > (pkg_date_utils.extract_field('DAY', pkg_date_utils.end_of(dt_mes_w, 'MONTH', 0), 0))::numeric ) then 
		dt_referencia_w		:= pkg_date_utils.get_datetime(pkg_date_utils.end_of(dt_mes_w, 'MONTH', 0), coalesce(dt_mes_w, PKG_DATE_UTILS.GET_TIME('00:00:00')));
		ie_dia_diferente_w	:= 'S';
	else 
		dt_referencia_w		:= pkg_date_utils.get_date(nr_dia_fixo_p, dt_mes_w, 0);
	end if;
 
	if	((ie_dia_fixo_w = 'N') or (ie_dia_diferente_w = 'N')) and (dt_referencia_w between dt_inicial_p and dt_final_p) then 
		dt_ref_original_w	:= dt_referencia_w;
		 
		if (ie_regra_data_w = 'DU') then 
			begin 
			dt_referencia_w	:= obter_dia_util_mes(cd_estabelecimento_p, dt_referencia_w, (pkg_date_utils.extract_field('DAY',dt_referencia_w,0))::numeric );
			 
			if (dt_ref_original_w IS NOT NULL AND dt_ref_original_w::text <> '') and (coalesce(dt_referencia_w::text, '') = '') then 
				CALL wheb_mensagem_pck.exibir_mensagem_abort(195879,'DS_DIA='||pkg_date_utils.extract_field('DAY', dt_ref_original_w, 0) || ';' || 'DS_MES=' || to_char(pkg_date_utils.start_of(dt_ref_original_w,'MONTH',0),'dd/mm/yyyy'));
			end if;
			end;
		else 
			if (ie_tratar_fim_semana_w = 'S') and (ie_antecipar_dia_util_w <> 'U') then 
				dt_referencia_w	:= obter_proximo_dia_util(cd_estabelecimento_p, dt_referencia_w);
			end if;
		end if;
 
		if (ie_antecipar_dia_util_w = 'U') or 
			((ie_antecipar_dia_util_w = 'S') and 
			 ((pkg_date_utils.start_of(dt_referencia_w, 'MONTH',0) > pkg_date_utils.start_of(dt_ref_original_w, 'MONTH',0)) or (obter_se_dia_util(dt_referencia_w, cd_estabelecimento_p) = 'N'))) then 
			dt_referencia_w		:= obter_dia_anterior_util(cd_estabelecimento_p, dt_ref_original_w);
		end if;
 
		if	((ie_dia_fixo_w = 'N') or (dt_ref_original_w = dt_referencia_w)) and (obter_se_fluxo_esp(cd_estabelecimento_p, cd_conta_financ_p, dt_referencia_w) = 'S') and (obter_se_fluxo_caixa_regra(nr_seq_regra_p, dt_referencia_w, cd_estabelecimento_p, 'E') = 'S') then 
 
			vl_deducao_w	:= coalesce(obter_se_fluxo_caixa_regra(nr_seq_regra_p, dt_referencia_w, cd_estabelecimento_p, 'VL'), 0);
			 
			CALL GERAR_FLUXO_CAIXA_LOTE(	dt_referencia_w, 
						cd_conta_financ_p, 
						'', 
						'21', 
						'RE', 
						nm_usuario_p, 
						null, 
						null, 
						null, 
						null, 
						null, 
						null, 
						null, 
						null, 
						nr_seq_lote_fluxo_p, 
						null, 
						null, 
						null, 
						null, 
						nr_seq_regra_p, 
						null, 
						null, 
						coalesce(vl_fixo_p,0) - coalesce(vl_deducao_w,0));
		end if;
	end if;
 
	dt_mes_w	:= PKG_DATE_UTILS.ADD_MONTH(dt_mes_w, 1,0);
end loop;
 
/*NAO COLOCAR COMMIT NESTA PROCEDURE*/
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_fluxo_caixa_lote_vl_fixo ( nr_seq_lote_fluxo_p bigint, cd_conta_financ_p bigint, nr_dia_fixo_p bigint, vl_fixo_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, cd_empresa_p bigint, nr_seq_regra_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

