-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consist_nova_prescr_emergencia ( nr_atendimento_p bigint, cd_setor_atendimento_p bigint, ie_atendimento_encerrado_p INOUT text, cd_setor_retorno_p INOUT bigint, qt_setor_usuario_p INOUT bigint, ds_erro_p INOUT text, cd_estabelecimento_p bigint, nm_usuario_p text, nm_computador_p text) AS $body$
DECLARE


cd_setor_retorno_w			bigint	:= null;
ds_erro_w			varchar(400)	:= ' ';
ie_atendimento_alta_w		varchar(1);
ie_atendimento_encerrado_w		varchar(1);
ie_prescr_setor_usuario_w		varchar(1);
ie_gerar_prescr_alta_w		varchar(1);
qt_prescr_nao_lib_w		bigint	:= 0;
qt_setor_usuario_w			bigint	:= 0;


BEGIN

ie_prescr_setor_usuario_w	:=  coalesce(obter_valor_param_usuario(998, 2, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p), 'P');

if (coalesce(nr_atendimento_p, 0) <> 0) then

		ie_gerar_prescr_alta_w	:=  coalesce(obter_valor_param_usuario(998, 5, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p), 'S');
		if (upper(ie_gerar_prescr_alta_w) = 'N') then

			select	coalesce(max('S'), 'N')
			into STRICT	ie_atendimento_alta_w
			from	atendimento_paciente
			where	nr_atendimento		= nr_atendimento_p
			and	(dt_alta IS NOT NULL AND dt_alta::text <> '');


			if (ie_atendimento_alta_w = 'S') then
				ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(282087,null);

			end if;

		end if;

		ds_erro_w	:=  rtrim(ds_erro_w);

		if (coalesce(ds_erro_w::text, '') = '') then

			/*Verificar se o Atendimento ja foi encerrado*/

			select	coalesce(max('S'), 'N')
			into STRICT	ie_atendimento_encerrado_w
			from	atendimento_paciente
			where	nr_atendimento		= nr_atendimento_p
			and	(dt_fim_conta IS NOT NULL AND dt_fim_conta::text <> '');

			IF (ie_prescr_setor_usuario_w = 'C') THEN
				BEGIN

				SELECT	MAX(cd_setor_atendimento)
				INTO STRICT	cd_setor_retorno_w
				FROM	computador
				WHERE	nm_computador_pesquisa  = padronizar_nome(UPPER(nm_computador_p));

				END;
			else
				if (ie_prescr_setor_usuario_w = 'U') then
				begin

					select	count(*)
					into STRICT	qt_setor_usuario_w
					from	setor_atendimento b,
							atend_paciente_unidade a
					where	a.cd_setor_atendimento	= b.cd_setor_atendimento
					and		a.nr_atendimento		= nr_atendimento_p
					and		b.cd_setor_atendimento	= cd_setor_atendimento_p;

					select	coalesce(obter_unidade_atendimento(nr_atendimento_p, 'IA' , 'CS'), obter_unidade_atendimento(nr_atendimento_p, 'A', 'CS')) --'S'
					into STRICT	cd_setor_retorno_w
					;

				end;
			else
				begin

				select	coalesce(obter_unidade_atendimento(nr_atendimento_p, 'IA' , 'CS'), obter_unidade_atendimento(nr_atendimento_p, 'A', 'CS')) --'S'
				into STRICT	cd_setor_retorno_w
				;

				end;
			end if;
			end if;

		end if;

		/*Vari√°veis para controle externo*/

		ie_atendimento_encerrado_p	:= ie_atendimento_encerrado_w;
		cd_setor_retorno_p		:= cd_setor_retorno_w;
		qt_setor_usuario_p		:= qt_setor_usuario_w;
		ds_erro_p				:= ds_erro_w;


elsif (ie_prescr_setor_usuario_w = 'C') THEN

	SELECT	MAX(cd_setor_atendimento)
	INTO STRICT	cd_setor_retorno_w
	FROM	computador
	WHERE	nm_computador_pesquisa  = padronizar_nome(UPPER(nm_computador_p));

	cd_setor_retorno_p		:= cd_setor_retorno_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consist_nova_prescr_emergencia ( nr_atendimento_p bigint, cd_setor_atendimento_p bigint, ie_atendimento_encerrado_p INOUT text, cd_setor_retorno_p INOUT bigint, qt_setor_usuario_p INOUT bigint, ds_erro_p INOUT text, cd_estabelecimento_p bigint, nm_usuario_p text, nm_computador_p text) FROM PUBLIC;

