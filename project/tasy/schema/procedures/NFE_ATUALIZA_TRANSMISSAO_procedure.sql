-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE nfe_atualiza_transmissao ( nm_usuario_p text, ie_tipo_nota_p text, nr_seq_transmissao_p bigint, ie_status_p text, nr_seq_log_p bigint default null) AS $body$
DECLARE



nr_seq_nota_w			bigint;
ie_tipo_transmissao_w	integer;
nr_seq_inutilizacao_w	nfe_transmissao_nf.nr_seq_inutilizacao%type;
cd_cgc_emitente_w		nota_fiscal.cd_cgc_emitente%type;
cd_serie_w				nota_fiscal.cd_serie_nf%type;
nr_inicio_w				nfe_inutilizacao.nr_inicial%type;
nr_final_w				nfe_inutilizacao.nr_final%type;
qt_lote_w				bigint;
				
C01 CURSOR FOR
	SELECT	a.nr_sequencia,
		t.ie_tipo_transmissao,
		n.nr_seq_inutilizacao
	FROM nfe_transmissao t, nota_fiscal_lote_nfe l, nfe_transmissao_nf n
LEFT OUTER JOIN nota_fiscal a ON (n.nr_seq_nota_fiscal = a.nr_sequencia)
WHERE l.nr_seq_transmissao	= t.nr_sequencia and t.nr_sequencia		= n.nr_seq_transmissao  and t.nr_sequencia 		= nr_seq_transmissao_p;
	
C02 CURSOR FOR
	SELECT	a.nr_sequencia,
		t.ie_tipo_transmissao,
		n.nr_seq_inutilizacao
	FROM nfe_transmissao t, nfe_transmissao_nf n
LEFT OUTER JOIN nota_fiscal a ON (n.nr_seq_nota_fiscal = a.nr_sequencia)
WHERE t.nr_sequencia		= n.nr_seq_transmissao  and t.nr_sequencia 		= nr_seq_transmissao_p;
				

BEGIN

update	nfe_transmissao
set 	ie_status_transmissao	= ie_status_p,
		nm_usuario 				= nm_usuario_p,
		nr_seq_log 				= nr_seq_log_p
where	nr_sequencia			= nr_seq_transmissao_p
and		ie_tipo_nota			= ie_tipo_nota_p;

select 	count(*)
into STRICT	qt_lote_w
from  	nota_fiscal_lote_nfe
where 	nr_seq_transmissao = nr_seq_transmissao_p;

if (qt_lote_w > 0) then
	if (ie_status_p = 'T') then
		open C01;
		loop
		fetch C01 into	
			nr_seq_nota_w,
			ie_tipo_transmissao_w,
			nr_seq_inutilizacao_w;
		commit;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin	
			if (ie_tipo_transmissao_w = 1) then
				begin
				
				update	nota_fiscal
				set	ie_status_envio 	= 'E'
				where	nr_sequencia 	= nr_seq_nota_w;
				
				end;
			end if;
			
			if (ie_tipo_transmissao_w = 2) then
				begin
				
				update	nota_fiscal
				set	ie_status_envio 	= 'C'
				where	nr_sequencia 	= nr_seq_nota_w;
									
				end;
			end if;
			
			if (ie_tipo_transmissao_w = 7) then
				begin
					select	cd_cgc,
						cd_serie_nf,
						nr_inicial,
						nr_final
					into STRICT 	cd_cgc_emitente_w,
						cd_serie_w,
						nr_inicio_w,
						nr_final_w
					from 	nfe_inutilizacao
					where 	nr_sequencia	= nr_seq_inutilizacao_w;
					
					update	nota_fiscal
					set	ie_status_envio = 'X'
					where 	cd_cgc_emitente	= cd_cgc_emitente_w
					and 	cd_serie_nf 	= cd_serie_w
					and 	nr_nota_fiscal 	between nr_inicio_w and nr_final_w;			
				end;
			end if;		
			
			commit;
			
			end;
		end loop;
		close C01;
	end if;
else
	if (ie_status_p = 'E' and ie_tipo_nota_p = 'NFE') then
		open C02;
		loop
		fetch C02 into	
			nr_seq_nota_w,
			ie_tipo_transmissao_w,
			nr_seq_inutilizacao_w;
		commit;
		EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

			if (ie_tipo_transmissao_w = 10) then
				begin

				update	nota_fiscal
				set	ie_status_envio 	= 'D'
				where	nr_sequencia 	= nr_seq_nota_w;
				
				update	nfe_transmissao
				set	ie_status_transmissao 	= 'T'
				where 	nr_sequencia 		= nr_seq_transmissao_p;
				
				end;
			end if;
			
			commit;
			
		end;
		end loop;
		close C02;
	end if;

	if (ie_tipo_nota_p = 'NFSE') then
		open C02;
		loop
		fetch C02 into	
			nr_seq_nota_w,
			ie_tipo_transmissao_w,
			nr_seq_inutilizacao_w;
		commit;
		EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

			if (ie_status_p = 'E') then
				update	nota_fiscal
				set	ie_status_envio 	= 'N'
				where	nr_sequencia 	= nr_seq_nota_w;
			elsif (ie_status_p = 'T') then
				update	nota_fiscal
				set	ie_status_envio 	= 'E'
				where	nr_sequencia 	= nr_seq_nota_w;
			end if;
			
			commit;
		end;
		end loop;
		close C02;
	end if;
	
end if;

if ((nr_seq_nota_w IS NOT NULL AND nr_seq_nota_w::text <> '') and IE_STATUS_P = 'T' and coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'es_MX' and ie_tipo_nota_p in ('SD', 'SF', 'SE')) then
    CALL update_rfc_envio_xml(nr_seq_nota_w, 'S');
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nfe_atualiza_transmissao ( nm_usuario_p text, ie_tipo_nota_p text, nr_seq_transmissao_p bigint, ie_status_p text, nr_seq_log_p bigint default null) FROM PUBLIC;

