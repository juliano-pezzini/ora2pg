-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cme_consite_liberar_req ( nr_requisicao_p bigint, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE



cd_setor_atendimento_w		integer;
cd_estabelecimento_w		smallint;
nr_seq_conjunto_w			bigint;
nm_conjunto_w			varchar(50);
qt_conjunto_req_w			bigint;
qt_conjunto_regra_w		bigint;
qt_conj_req_total_w		bigint;
qt_sem_retorno_w		bigint;
ie_periodo_w			varchar(01);
qt_regra_w			integer;
qt_existe_w			integer;
ds_erro_w			varchar(255) := '';
ie_emprestimo_w			varchar(1);
ie_devolucao_w			varchar(1);
ie_exige_dev_empres_w		varchar(1);
ie_somente_req_lib_w		cm_conjunto_cota.ie_somente_req_lib%type;
ie_sem_dt_retorno_w		cm_conjunto_cota.ie_sem_dt_retorno%type;

c01 CURSOR FOR
SELECT	nr_seq_conjunto,
	sum(qt_conjunto),
	substr(CME_Obter_Nome_Conjunto(nr_seq_conjunto),1,50),
	coalesce(ie_emprestimo,'N'),
	coalesce(ie_devolucao,'N')
from	cm_requisicao_item
where	nr_seq_requisicao = nr_requisicao_p
group by nr_seq_conjunto,
	ie_emprestimo,
	ie_devolucao;


BEGIN

select	count(*)
into STRICT	qt_existe_w
from	cm_requisicao_item
where	nr_seq_requisicao = nr_requisicao_p;
if (qt_existe_w = 0) then
	ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(278959);
end if;

select	cd_setor_atendimento,
	cd_estabelecimento
into STRICT	cd_setor_atendimento_w,
	cd_estabelecimento_w
from	cm_requisicao
where	nr_sequencia = nr_requisicao_p;

select	obter_valor_param_usuario(410, 35, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w)
into STRICT	ie_exige_dev_empres_w
;

open c01;
loop
fetch c01 into
	nr_seq_conjunto_w,
	qt_conjunto_req_w,
	nm_conjunto_w,
	ie_emprestimo_w,
	ie_devolucao_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	if (ie_exige_dev_empres_w = 'S') and (ie_emprestimo_w = 'N') and (ie_devolucao_w = 'N') then
		ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(278960);
	end if;

	select	count(*)
	into STRICT	qt_existe_w
	from	CM_CONJUNTO
	where	nr_sequencia = nr_seq_conjunto_w
	and	ie_situacao = 'I';
	if (qt_existe_w > 0) then
		ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(278962) || nr_seq_conjunto_w || WHEB_MENSAGEM_PCK.get_texto(278963);
	end if;

	select	count(*),
		coalesce(max(qt_conjunto),0),
		coalesce(max(ie_periodo),'D'),
		coalesce(max(ie_somente_req_lib),'N'),
		coalesce(max(ie_sem_dt_retorno),'N')
	into STRICT	qt_regra_w,
		qt_conjunto_regra_w,
		ie_periodo_w,
		ie_somente_req_lib_w,
		ie_sem_dt_retorno_w
	from	cm_conjunto_cota
	where	nr_seq_conjunto 	= nr_seq_conjunto_w
	and	cd_estabelecimento 	= cd_estabelecimento_w
	and	cd_setor_atendimento	= cd_setor_atendimento_w
	and	ie_situacao = 'A';

	if (qt_regra_w > 0) then
		begin
		if (ie_periodo_w = 'D') then

			select	coalesce(sum(b.qt_conjunto),0)
			into STRICT	qt_conj_req_total_w
			from	cm_requisicao_item b,
				cm_requisicao a
			where	a.nr_sequencia 			= b.nr_seq_requisicao
			and	trunc(a.dt_requisicao,'dd')	= trunc(clock_timestamp(),'dd')
			and	a.cd_estabelecimento		= cd_estabelecimento_w
			and	a.cd_setor_atendimento		= cd_setor_atendimento_w
			and	b.nr_seq_conjunto		= nr_seq_conjunto_w
			and	a.nr_sequencia <> nr_requisicao_p
			and ((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or ie_somente_req_lib_w = 'N')
			and (coalesce(a.dt_baixa::text, '') = '' or (exists (SELECT	1
					from	cm_requisicao_conj x
					where	x.nr_seq_item_req = b.nr_sequencia
					and	coalesce(x.dt_retorno::text, '') = '') and (ie_sem_dt_retorno_w = 'S')));
			if	((qt_conj_req_total_w + qt_conjunto_req_w) > qt_conjunto_regra_w) then
				ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(278964) || chr(13) || WHEB_MENSAGEM_PCK.get_texto(278965) || nm_conjunto_w;
			end if;

		elsif (ie_periodo_w = 'M') then

			select	coalesce(sum(b.qt_conjunto),0)
			into STRICT	qt_conj_req_total_w
			from	cm_requisicao_item b,
				cm_requisicao a
			where	a.nr_sequencia 			= b.nr_seq_requisicao
			and	trunc(a.dt_requisicao,'mm')	= trunc(clock_timestamp(),'mm')
			and	a.cd_estabelecimento		= cd_estabelecimento_w
			and	a.cd_setor_atendimento		= cd_setor_atendimento_w
			and	b.nr_seq_conjunto		= nr_seq_conjunto_w
			and	a.nr_sequencia <> nr_requisicao_p
			and ((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or ie_somente_req_lib_w = 'N')
			and (coalesce(a.dt_baixa::text, '') = '' or (exists (SELECT	1
					from	cm_requisicao_conj x
					where	x.nr_seq_item_req = b.nr_sequencia
					and	coalesce(x.dt_retorno::text, '') = '') and (ie_sem_dt_retorno_w = 'S')));

			if	((qt_conj_req_total_w + qt_conjunto_req_w) > qt_conjunto_regra_w) then
				ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(278966) || chr(13) || WHEB_MENSAGEM_PCK.get_texto(278965) || nm_conjunto_w;
			end if;

		elsif (ie_periodo_w = 'F') then

			select	coalesce(sum(b.qt_conjunto),0)
			into STRICT	qt_conj_req_total_w
			from	cm_requisicao_item b,
				cm_requisicao a
			where	a.nr_sequencia 			= b.nr_seq_requisicao
			and	a.cd_estabelecimento		= cd_estabelecimento_w
			and	a.cd_setor_atendimento		= cd_setor_atendimento_w
			and	b.nr_seq_conjunto		= nr_seq_conjunto_w
			and	a.nr_sequencia <> nr_requisicao_p
			and ((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or ie_somente_req_lib_w = 'N')
			and not exists (SELECT	1
					from	cm_requisicao_conj x
					where	x.nr_seq_item_req = b.nr_sequencia);

			select	coalesce(sum(1),0)
			into STRICT	qt_sem_retorno_w
			from	cm_requisicao_conj c,
				(SELECT	b.nr_sequencia
				from	cm_requisicao_item b,
					cm_requisicao a
				where	a.nr_sequencia 			= b.nr_seq_requisicao
				and	a.cd_estabelecimento		= cd_estabelecimento_w
				and	a.cd_setor_atendimento		= cd_setor_atendimento_w
				and	b.nr_seq_conjunto		= nr_seq_conjunto_w
				and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
				and (exists (select	1
						from	cm_requisicao_conj x
						where	x.nr_seq_item_req = b.nr_sequencia
						and	coalesce(x.dt_retorno::text, '') = '') and (ie_sem_dt_retorno_w = 'S'))) d
			where	c.nr_seq_item_req = d.nr_sequencia
			and	coalesce(c.dt_retorno::text, '') = '';

			qt_conj_req_total_w := qt_conj_req_total_w + qt_sem_retorno_w;

			if	((qt_conj_req_total_w + qt_conjunto_req_w) > qt_conjunto_regra_w) then
				ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(278966) || chr(13) || WHEB_MENSAGEM_PCK.get_texto(278965) || nm_conjunto_w;
			end if;

		end if;
		end;
	end if;
	end;
end loop;
close c01;

ds_erro_p	:= substr(ds_erro_w,1,255);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cme_consite_liberar_req ( nr_requisicao_p bigint, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

