-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_regra_ajuste_mat ( cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_material_p bigint, dt_vigencia_p timestamp, cd_tipo_acomodacao_p bigint, ie_tipo_atendimento_p bigint, cd_setor_atendimento_p bigint, qt_idade_p bigint, nr_sequencia_p bigint, cd_plano_p text, cd_proc_referencia_p bigint, ie_origem_proced_p bigint, nr_seq_proc_interno_p bigint, dt_entrada_p timestamp, tx_ajuste_p INOUT bigint, vl_negociado_p INOUT bigint, ie_preco_informado_p INOUT text, ie_glosa_p INOUT text, tx_brasindice_pfb_p INOUT bigint, tx_brasindice_pmc_p INOUT bigint, tx_pmc_neg_p INOUT bigint, tx_pmc_pos_p INOUT bigint, tx_afaturar_p INOUT bigint, tx_simpro_pfb_p INOUT bigint, tx_simpro_pmc_p INOUT bigint, ie_origem_preco_p INOUT text, ie_precedencia_p INOUT text, pr_glosa_p INOUT bigint, vl_glosa_p INOUT bigint, cd_tabela_preco_p INOUT bigint, cd_motivo_exc_conta_p INOUT bigint, nr_seq_regra_p INOUT bigint, ie_autor_particular_p INOUT text, cd_convenio_glosa_p INOUT bigint, cd_categoria_glosa_p INOUT text, ie_atend_retorno_p text, tx_pfb_neg_p INOUT bigint, tx_pfb_pos_p INOUT bigint, ie_ignora_preco_venda_p INOUT text, tx_simpro_pos_pfb_p INOUT bigint, tx_simpro_neg_pfb_p INOUT bigint, tx_simpro_pos_pmc_p INOUT bigint, tx_simpro_neg_pmc_p INOUT bigint, nr_seq_origem_p bigint, nr_seq_cobertura_p bigint, qt_dias_internacao_p bigint, nr_seq_regra_lanc_p bigint, nr_seq_lib_dieta_conv_p bigint, ie_clinica_p bigint, cd_usuario_convenio_p text, nr_seq_classif_atend_p bigint, ie_estrangeiro_p text default null) AS $body$
DECLARE


cd_material_w			integer	:= 0;
dt_inicio_vigencia_w		timestamp;
tx_ajuste_w			double precision	:= NULL;
vl_negociado_w			double precision	:= NULL;
ie_preco_informado_w		varchar(1)	:= NULL;
ie_glosa_w			varchar(1)	:= NULL;
tx_brasindice_pfb_w		REGRA_AJUSTE_MATERIAL.TX_BRASINDICE_PFB%type := null;--number(15,4)	:= NULL;
tx_brasindice_pmc_w		CONVENIO_BRASINDICE.TX_BRASINDICE_PMC%type := null;--number(15,4)	:= NULL;
tx_pmc_neg_w			CONVENIO_BRASINDICE.TX_PMC_NEG%type := null;--number(15,4)	:= NULL;
tx_pmc_pos_w			CONVENIO_BRASINDICE.TX_PMC_POS%type := null;--number(15,4)	:= NULL;
tx_afaturar_w			double precision	:= NULL;
cd_grupo_material_w		smallint	:= 0;
cd_subgrupo_material_w		smallint	:= 0;
cd_classe_material_w		integer	:= 0;
cd_grupo_w			smallint	:= 0;
cd_subgrupo_w			smallint	:= 0;
cd_classe_w			integer	:= 0;
dt_final_vigencia_w		timestamp;
qt_idade_w			bigint;
qt_idade_min_w			bigint;
qt_idade_max_w			bigint;
tx_simpro_pfb_w			double precision;
tx_simpro_pmc_w			double precision;
ie_origem_preco_w		varchar(05);
ie_precedencia_w		varchar(01);
pr_glosa_w			double precision	:= 0;
vl_glosa_w			double precision	:= 0;
ie_tipo_material_w		varchar(03);
nr_atendimento_w		bigint;
cd_tabela_preco_w		bigint;
cd_motivo_exc_conta_w		bigint;
nr_seq_regra_w			bigint;

cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
ie_autor_particular_w		varchar(1)	:= 'N';
cd_convenio_glosa_ww		integer:= 0;
cd_categoria_glosa_ww		varchar(10):= ' ';
dt_vigencia_w			timestamp;
ie_kit_material_w		varchar(1);
cd_kit_material_w		bigint;
nr_seq_proc_interno_w		bigint;
nr_prescricao_w			bigint;
nr_sequencia_prescricao_w	integer;
tx_pfb_neg_w			CONVENIO_BRASINDICE.TX_PFB_NEG%type := null;--number(15,4)	:= NULL;
tx_pfb_pos_w			CONVENIO_BRASINDICE.TX_PFB_POS%type := null;--number(15,4)	:= NULL;
ie_tipo_kit_w			varchar(1):= '0';
nr_seq_familia_w		bigint;
cd_tipo_baixa_w			material_atend_paciente.nr_seq_tipo_baixa%type := 0;
ie_ignora_preco_venda_w		varchar(1);
nr_seq_estrutura_w		bigint;
tx_simpro_pos_pfb_w		double precision;
tx_simpro_neg_pfb_w		double precision;
tx_simpro_pos_pmc_w		double precision;
tx_simpro_neg_pmc_w		double precision;
ie_order_estrangeiro_w 		smallint;
ie_agrupador_w			prescr_material.ie_agrupador%type	:= 0;
dt_vigencia_regra_w		timestamp;
nr_seq_mat_autor_w		MATERIAL_ATEND_PACIENTE.NR_SEQ_MAT_AUTOR%type := null;
ie_tipo_prec_especial_w		MATERIAL_AUTORIZADO.IE_TIPO_PREC_ESPECIAL%type := null;

C01 CURSOR FOR
SELECT	dt_inicio_vigencia,
	cd_grupo_material,
	cd_subgrupo_material,
	cd_classe_material,
	cd_material,
	tx_ajuste,
	vl_negociado,
	ie_preco_informado,
	ie_glosa,
	tx_brasindice_pfb,
	tx_brasindice_pmc,
	tx_pmc_neg,
	tx_pmc_pos,
	tx_afaturar,
	dt_final_vigencia,
	coalesce(qt_idade_min, 0),
	coalesce(qt_idade_max,999),
	tx_simpro_pfb,
	tx_simpro_pmc,
	ie_origem_preco,
	ie_precedencia_preco,
	CASE WHEN ie_glosa='P' THEN pr_glosa  ELSE 0 END ,
	CASE WHEN ie_glosa='R' THEN vl_glosa  ELSE 0 END ,
	cd_tabela_preco,
	cd_motivo_exc_conta,
	nr_sequencia,
	ie_autor_particular,
	coalesce(cd_convenio_glosa,0),
	cd_categoria_glosa,
	tx_pfb_neg,
	tx_pfb_pos,
	tx_simpro_pos_pfb,
	tx_simpro_neg_pfb,
	tx_simpro_pos_pmc,
	tx_simpro_neg_pmc,
	ie_ignora_preco_venda,
	nr_seq_estrutura,	
	CASE WHEN coalesce(ie_estrangeiro,'N')='R' THEN 4 WHEN coalesce(ie_estrangeiro,'N')='E' THEN 3 WHEN coalesce(ie_estrangeiro,'N')='A' THEN 2 WHEN coalesce(ie_estrangeiro,'N')='N' THEN 1 END  ie_order_estrangeiro
from 	regra_ajuste_material x
where 	cd_estabelecimento	= cd_estabelecimento_p
and	cd_convenio		= cd_convenio_p
and	ie_situacao		= 'A'
and	qt_idade_w between coalesce(qt_idade_min, qt_idade_w) and coalesce(qt_idade_max, qt_idade_w)
and	(((dt_vigencia_p between dt_inicio_vigencia and ESTABLISHMENT_TIMEZONE_UTILS.EndOfDay(coalesce(dt_final_vigencia, dt_vigencia_regra_w))) and (coalesce(IE_DATA_REFERENCIA_VIG,'A') = 'A')) or
	((coalesce(dt_entrada_p,dt_vigencia_p) between dt_inicio_vigencia and  ESTABLISHMENT_TIMEZONE_UTILS.EndOfDay(coalesce(dt_final_vigencia, dt_vigencia_regra_w))) and (coalesce(IE_DATA_REFERENCIA_VIG,'A') = 'E')))
and	coalesce(cd_material,cd_material_p)			= cd_material_p
and 	coalesce(cd_classe_material, cd_classe_w)		= cd_classe_w
and 	coalesce(cd_subgrupo_material, cd_subgrupo_w) 		= cd_subgrupo_w
and 	coalesce(cd_grupo_material, cd_grupo_w) 	 	= cd_grupo_w
and	coalesce(cd_categoria, cd_categoria_p)			= cd_categoria_p
and	coalesce(cd_tipo_acomodacao, cd_tipo_acomodacao_p)	= cd_tipo_acomodacao_p	
and	coalesce(ie_tipo_atendimento, ie_tipo_atendimento_p)	= ie_tipo_atendimento_p
and	coalesce(cd_setor_atendimento, coalesce(cd_setor_atendimento_p,0))= coalesce(cd_setor_atendimento_p,0)
and	coalesce(ie_tipo_material, ie_tipo_material_w)	 = ie_tipo_material_w
and	coalesce(CASE WHEN ie_glosa='J' THEN null  ELSE cd_proc_referencia END , cd_procedimento_w)	 = cd_procedimento_w
and	((coalesce(cd_proc_referencia::text, '') = '') or (coalesce(CASE WHEN ie_glosa='J' THEN  null  ELSE ie_origem_proced END , ie_origem_proced_w)	 = ie_origem_proced_w))
and 	coalesce(nr_seq_proc_interno, nr_seq_proc_interno_w)  = nr_seq_proc_interno_w
and	((coalesce(cd_plano::text, '') = '') or (cd_plano = coalesce(cd_plano_p, '0')))
and	((coalesce(cd_cid::text, '') = '') or (coalesce(nr_atendimento_w::text, '') = '') or (obter_se_cid_atendimento(nr_atendimento_w, cd_cid) = 'S'))
and	((coalesce(ie_kit_material,'T')= 'T') or (coalesce(ie_kit_material,ie_kit_material_w) = ie_kit_material_w))
and	coalesce(cd_kit_material,cd_kit_material_w)		= cd_kit_material_w
and	((coalesce(ie_atend_retorno_p::text, '') = '') or (coalesce(ie_atend_retorno,'A') = 'A') or (ie_atend_retorno = ie_atend_retorno_p))
and	coalesce(ie_tipo_kit, coalesce(ie_tipo_kit_w,'0'))	 = coalesce(ie_tipo_kit_w,'0')
--and	(substr(obter_proc_princ_vinculado(nr_sequencia, cd_procedimento_w, ie_origem_proced_w),1,10) = 'S')   -- OS 251296 Performance 9 Muitas Chamadas Recusrsivas
and	coalesce(nr_seq_familia, nr_seq_familia_w)	 = nr_seq_familia_w
and	((coalesce(cd_tipo_baixa::text, '') = '') or (coalesce(cd_tipo_baixa,coalesce(cd_tipo_baixa_w,0)) =coalesce(cd_tipo_baixa_w,0)))
---and	((nr_seq_estrutura is null) or (nvl(nr_seq_estrutura,nvl(nr_seq_estrutura_w,0)) = nvl(nr_seq_estrutura_w,0)))
and	((coalesce(nr_seq_estrutura::text, '') = '') or (CONSISTIR_SE_MAT_ESTRUT_VIG(nr_seq_estrutura,cd_material_p, dt_vigencia_p) = 'S'))	
and	((coalesce(nr_seq_origem::text, '') = '') or (coalesce(nr_seq_origem,coalesce(nr_seq_origem_p,0)) = coalesce(nr_seq_origem_p,0)))
and	((coalesce(nr_seq_cobertura::text, '') = '') or (nr_seq_cobertura = coalesce(nr_seq_cobertura_p,0)))
and	((coalesce(nr_seq_classificacao::text, '') = '') or (nr_seq_classificacao = coalesce(nr_seq_classif_atend_p,0)))
and	coalesce(qt_dias_internacao_p,0) between coalesce(qt_dias_inter_inicio, coalesce(qt_dias_internacao_p,0)) and coalesce(qt_dias_inter_final, coalesce(qt_dias_internacao_p,0))
and	((coalesce(nr_seq_regra_lanc::text, '') = '') or (coalesce(nr_seq_regra_lanc, coalesce(nr_seq_regra_lanc_p,0)) = coalesce(nr_seq_regra_lanc_p,0)))
and	coalesce(nr_seq_lib_dieta_conv, coalesce(nr_seq_lib_dieta_conv_p, 0)) = coalesce(nr_seq_lib_dieta_conv_p, 0)
and	coalesce(ie_clinica, coalesce(ie_clinica_p, 0)) = coalesce(ie_clinica_p, 0)
and	((coalesce(cd_usuario_convenio::text, '') = '') or (cd_usuario_convenio = substr(cd_usuario_convenio_p, qt_pos_inicial, qt_pos_final)))
and 	((not exists (SELECT  1
			from	regra_ajuste_mat_proc_vinc a
			where	a.nr_seq_regra_ajuste = x.nr_sequencia)) or
	((exists (select  1
			from	regra_ajuste_mat_proc_vinc a
			where	a.nr_seq_regra_ajuste = x.nr_sequencia)) and
	(exists 	(select	1
			from	regra_ajuste_mat_proc_vinc a
			where	a.nr_seq_regra_ajuste = x.nr_sequencia
			and	((coalesce(a.cd_procedimento::text, '') = '') or (coalesce(a.cd_procedimento, coalesce(45080194,0)) = coalesce(45080194,0)))
			and	((coalesce(a.ie_origem_proced::text, '') = '') or (coalesce(a.ie_origem_proced, coalesce(1,0)) = coalesce(1,0)))
			and	((coalesce(a.cd_area_procedimento::text, '') = '') or (coalesce(a.cd_area_procedimento, coalesce(4,0)) = coalesce(4,0)))
			and	((coalesce(a.cd_especialidade::text, '') = '') or (coalesce(a.cd_especialidade, coalesce(0,0)) = coalesce(0,0)))
			and	((coalesce(a.cd_grupo_proc::text, '') = '') or (coalesce(a.cd_grupo_proc, coalesce(1,0)) = coalesce(1,0)))))))
and ( (coalesce(ie_estrangeiro,'N') = 'N')
	or((coalesce(ie_estrangeiro,'N') = 'A') and (coalesce(ie_estrangeiro_p,'N') in ('R','E')))
	or (coalesce(ie_estrangeiro,'N') = coalesce(ie_estrangeiro_p,'N')))
and	((coalesce(ie_reconstituinte,'N') = 'N') or (ie_agrupador_w = 9))
and	((coalesce(ie_existe_tabela,'N') = 'N') or (coalesce(x.cd_tabela_preco::text, '') = '') or ((coalesce(ie_existe_tabela,'N') = 'S') and (exists (select	1
									from	preco_material a
									where	a.cd_estabelecimento = x.cd_estabelecimento
									and	a.cd_tab_preco_mat = x.cd_tabela_preco
									and	a.cd_material = cd_material_p
									and	dt_vigencia_p between coalesce(a.dt_inicio_vigencia, dt_vigencia_p) and coalesce(a.dt_final_vigencia, dt_vigencia_p)))))
and (coalesce(ie_tipo_prec_especial_w,'N') = coalesce(ie_tipo_preco_autor,'N'))
order by 		
	coalesce(cd_material,0),
	coalesce(nr_seq_estrutura,0),
	coalesce(nr_seq_familia,0),
	coalesce(cd_classe_material,0),
	coalesce(cd_subgrupo_material,0),
	coalesce(cd_grupo_material,0),
	coalesce(ie_tipo_material,0),
	coalesce(qt_idade_min, 0),
	coalesce(cd_setor_atendimento,0),
	coalesce(cd_cid,' '),
	coalesce(cd_plano,' '),
	coalesce(cd_categoria,'0'),
	coalesce(nr_seq_regra_lanc,0),
	coalesce(dt_inicio_vigencia, clock_timestamp()),
	coalesce(cd_proc_referencia, 0),
	coalesce(cd_tipo_baixa,0),
	coalesce(nr_seq_cobertura,0),	
	coalesce(nr_seq_lib_dieta_conv, 0),
	coalesce(ie_clinica, 0),
	coalesce(cd_usuario_convenio,' '),
	coalesce(nr_seq_classif_atend_p,0),
	ie_order_estrangeiro,
	coalesce(ie_reconstituinte,'N');


C02 CURSOR FOR
      SELECT	 /*+index (a prcmate_pk) */		b.tx_ajuste_tabela_mat
      from 	preco_material a,
		convenio_preco_mat b
      where 	a.cd_estabelecimento  	= cd_estabelecimento_p
	and	a.cd_estabelecimento  	= b.cd_estabelecimento
	and	a.cd_tab_preco_mat	= b.cd_tab_preco_mat
	and	coalesce(cd_tabela_preco_w, a.cd_tab_preco_mat) = a.cd_tab_preco_mat
	and	a.cd_material			= cd_material_p
	and 	((coalesce(cd_grupo_material::text, '') = '') or (cd_grupo_material = cd_grupo_w))
	and 	((coalesce(cd_subgrupo_material::text, '') = '') or (cd_subgrupo_material = cd_subgrupo_w))
	and 	((coalesce(cd_classe_material::text, '') = '') or (cd_classe_material = cd_classe_w))
	--and	a.dt_inicio_vigencia 	<= dt_vigencia_p   -- Subsituido a linha pela linha abaixo, OS 454541
	and	 ESTABLISHMENT_TIMEZONE_UTILS.StartOfDay(dt_vigencia_p) between coalesce( ESTABLISHMENT_TIMEZONE_UTILS.EndOfDay(a.dt_inicio_vigencia), clock_timestamp() - interval '3650 days') and coalesce(a.dt_final_vigencia, dt_vigencia_p)
	and	b.cd_convenio			= cd_convenio_p
	and	coalesce(b.ie_situacao,'A')	= 'A'
	and 	coalesce(a.ie_situacao,'A') = 'A'
	and	b.cd_categoria		= cd_categoria_p
	and	dt_vigencia_w between coalesce(b.dt_inicio_vigencia, dt_vigencia_w)	and coalesce(b.dt_final_vigencia, dt_vigencia_w)
	and	coalesce(a.ie_preco_venda, 'S') = 'S'
	and	exists (	SELECT	1
			from	tabela_preco_material x
			where	x.cd_tab_preco_mat = a.cd_tab_preco_mat
			and	coalesce(x.ie_situacao,'A') = 'A'
			and	x.cd_estabelecimento = cd_estabelecimento_p)
     order by coalesce(b.nr_prioridade,1) desc,
		coalesce(b.ie_tab_adicional,'N') desc,
		coalesce(cd_classe_material,0),
		coalesce(cd_subgrupo_material,0),
		coalesce(cd_grupo_material,0);/*Elemar 24/01/2005 Inclui o order by */
BEGIN

dt_vigencia_regra_w	:= clock_timestamp();
if (dt_vigencia_p > clock_timestamp()) then
	dt_vigencia_regra_w	:= dt_vigencia_p;
end if;

dt_vigencia_w		:=  ESTABLISHMENT_TIMEZONE_UTILS.StartOfDay(dt_vigencia_p);

select	coalesce(cd_proc_referencia_P, 0),
	coalesce(ie_origem_proced_p, 0),
	coalesce(nr_seq_proc_interno_p, 0)
into STRICT	cd_procedimento_w,
	ie_origem_proced_w,
	nr_seq_proc_interno_w
;


select	coalesce(max(a.cd_classe_material),0),
	coalesce(max(b.cd_subgrupo_material),0),
	coalesce(max(c.cd_grupo_material),0),
	max(a.ie_tipo_material),
	coalesce(max(a.nr_seq_familia),0)
into STRICT	cd_classe_w,
	cd_subgrupo_w,
	cd_grupo_w,
	ie_tipo_material_w,
	nr_seq_familia_w
from	material a,
	classe_material b,
	subgrupo_material c
where	a.cd_material          = cd_material_p
	and a.cd_classe_material   = b.cd_classe_material
	and b.cd_subgrupo_material = c.cd_subgrupo_material;
	
select	coalesce(max(nr_seq_estrutura),0)
into STRICT	nr_seq_estrutura_w
from	mat_estrutura_cadastro
where	cd_material = cd_material_p;

qt_idade_w		:= coalesce(qt_idade_p,0);

nr_atendimento_w	:= null;
cd_kit_material_w	:= null;
ie_kit_material_w	:= 'T';

if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then
	select	max(nr_atendimento),
		max(cd_kit_material),
		max(nr_prescricao),
		max(nr_sequencia_prescricao),
		coalesce(max(nr_seq_tipo_baixa),0),
		coalesce(max(nr_seq_mat_autor),0)
	into STRICT	nr_atendimento_w,
		cd_kit_material_w,
		nr_prescricao_w,
		nr_sequencia_prescricao_w,
		cd_tipo_baixa_w,
		nr_seq_mat_autor_w
	from	material_atend_paciente
	where	nr_sequencia	= nr_sequencia_p;
	
	if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') and (nr_sequencia_prescricao_w IS NOT NULL AND nr_sequencia_prescricao_w::text <> '') then
		
		select	coalesce(max(cd_kit_material),cd_kit_material_w),
			coalesce(max(ie_agrupador),0)
		into STRICT	cd_kit_material_w,
			ie_agrupador_w
		from	prescr_material
		where	nr_prescricao		= nr_prescricao_w
		and	nr_sequencia		= nr_sequencia_prescricao_w;
		
	end if;
	
	if (nr_seq_mat_autor_w <> 0) then

		select	coalesce(max(ie_tipo_prec_especial),'N')
		into STRICT	ie_tipo_prec_especial_w
		from	material_autorizado a
		where	a.nr_sequencia = nr_seq_mat_autor_w;

	end if;	
	
	ie_kit_material_w	:= 'N';
	
	if (cd_kit_material_w IS NOT NULL AND cd_kit_material_w::text <> '') then
		ie_kit_material_w	:= 'S';
	end if;
end if;

cd_kit_material_w	:= coalesce(cd_kit_material_w,0);

begin
select	ie_tipo
into STRICT	ie_tipo_kit_w
from	kit_material	
where	cd_kit_material_w = cd_kit_material;
exception when
	others then
	ie_tipo_kit_w:= '0';	
end;
OPEN C01;
LOOP
FETCH C01 into
		dt_inicio_vigencia_w,
		cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w,
		cd_material_w,
		tx_ajuste_w,
		vl_negociado_w,
		ie_preco_informado_w,
		ie_glosa_w,
		tx_brasindice_pfb_w,
		tx_brasindice_pmc_w,
		tx_pmc_neg_w,
		tx_pmc_pos_w,
		tx_afaturar_w,
		dt_final_vigencia_w,
		qt_idade_min_w,
		qt_idade_max_w,
		tx_simpro_pfb_w,
		tx_simpro_pmc_w,
		ie_origem_preco_w,
		ie_precedencia_w,
		pr_glosa_w,
		vl_glosa_w,
		cd_tabela_preco_w,
		cd_motivo_exc_conta_w,
		nr_seq_regra_w,
		ie_autor_particular_w,
		cd_convenio_glosa_ww,
		cd_categoria_glosa_ww,
		tx_pfb_neg_w,
		tx_pfb_pos_w,
		tx_simpro_pos_pfb_w,
		tx_simpro_neg_pfb_w,
		tx_simpro_pos_pmc_w,
		tx_simpro_neg_pmc_w,
		ie_ignora_preco_venda_w,
		nr_seq_estrutura_w,
		ie_order_estrangeiro_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		tx_ajuste_w			:= tx_ajuste_w;
		--dbms_output.put_line(nvl(ie_glosa_w,'L'));
		
END LOOP;
CLOSE C01;

	
if	coalesce(tx_ajuste_w::text, '') = '' then
      	begin
	OPEN C02;
	LOOP
	FETCH C02 into
	 	tx_ajuste_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		tx_ajuste_w		:= tx_ajuste_w;
	END LOOP;
	CLOSE C02;
	end;
end if;

if (coalesce(tx_ajuste_w,0) = 0) then
	tx_ajuste_w := 1;
end if;
if (coalesce(tx_afaturar_w,0) = 0) then
	tx_afaturar_w := 1;
end if;
tx_ajuste_p			:= tx_ajuste_w;
tx_afaturar_p			:= tx_afaturar_w;
vl_negociado_p			:= coalesce(vl_negociado_w,0);
ie_preco_informado_p		:= coalesce(ie_preco_informado_w,'N');
ie_glosa_p			:= coalesce(ie_glosa_w,'L');
tx_brasindice_pfb_p		:= tx_brasindice_pfb_w;
tx_brasindice_pmc_p		:= tx_brasindice_pmc_w;
tx_pmc_neg_p			:= tx_pmc_neg_w;
tx_pmc_pos_p			:= tx_pmc_pos_w;
tx_simpro_pfb_p			:= tx_simpro_pfb_w;
tx_simpro_pmc_p			:= tx_simpro_pmc_w;
ie_origem_preco_p		:= ie_origem_preco_w;
ie_precedencia_p		:= ie_precedencia_w;
pr_glosa_p			:= pr_glosa_w;
vl_glosa_p			:= vl_glosa_w;
cd_tabela_preco_p		:= cd_tabela_preco_w;
cd_motivo_exc_conta_p		:= cd_motivo_exc_conta_w;
nr_seq_regra_p			:= nr_seq_regra_w;
ie_autor_particular_p		:= ie_autor_particular_w;
cd_convenio_glosa_p		:= cd_convenio_glosa_ww;
cd_categoria_glosa_p		:= cd_categoria_glosa_ww;
tx_pfb_neg_p			:= tx_pfb_neg_w;
tx_pfb_pos_p			:= tx_pfb_pos_w;
tx_simpro_pos_pfb_p		:= tx_simpro_pos_pfb_w;
tx_simpro_neg_pfb_p		:= tx_simpro_neg_pfb_w;
tx_simpro_pos_pmc_p		:= tx_simpro_pos_pmc_w;
tx_simpro_neg_pmc_p		:= tx_simpro_neg_pmc_w;
ie_ignora_preco_venda_p		:= ie_ignora_preco_venda_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_regra_ajuste_mat ( cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_material_p bigint, dt_vigencia_p timestamp, cd_tipo_acomodacao_p bigint, ie_tipo_atendimento_p bigint, cd_setor_atendimento_p bigint, qt_idade_p bigint, nr_sequencia_p bigint, cd_plano_p text, cd_proc_referencia_p bigint, ie_origem_proced_p bigint, nr_seq_proc_interno_p bigint, dt_entrada_p timestamp, tx_ajuste_p INOUT bigint, vl_negociado_p INOUT bigint, ie_preco_informado_p INOUT text, ie_glosa_p INOUT text, tx_brasindice_pfb_p INOUT bigint, tx_brasindice_pmc_p INOUT bigint, tx_pmc_neg_p INOUT bigint, tx_pmc_pos_p INOUT bigint, tx_afaturar_p INOUT bigint, tx_simpro_pfb_p INOUT bigint, tx_simpro_pmc_p INOUT bigint, ie_origem_preco_p INOUT text, ie_precedencia_p INOUT text, pr_glosa_p INOUT bigint, vl_glosa_p INOUT bigint, cd_tabela_preco_p INOUT bigint, cd_motivo_exc_conta_p INOUT bigint, nr_seq_regra_p INOUT bigint, ie_autor_particular_p INOUT text, cd_convenio_glosa_p INOUT bigint, cd_categoria_glosa_p INOUT text, ie_atend_retorno_p text, tx_pfb_neg_p INOUT bigint, tx_pfb_pos_p INOUT bigint, ie_ignora_preco_venda_p INOUT text, tx_simpro_pos_pfb_p INOUT bigint, tx_simpro_neg_pfb_p INOUT bigint, tx_simpro_pos_pmc_p INOUT bigint, tx_simpro_neg_pmc_p INOUT bigint, nr_seq_origem_p bigint, nr_seq_cobertura_p bigint, qt_dias_internacao_p bigint, nr_seq_regra_lanc_p bigint, nr_seq_lib_dieta_conv_p bigint, ie_clinica_p bigint, cd_usuario_convenio_p text, nr_seq_classif_atend_p bigint, ie_estrangeiro_p text default null) FROM PUBLIC;

