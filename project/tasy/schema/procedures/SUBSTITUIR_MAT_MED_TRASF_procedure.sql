-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE substituir_mat_med_trasf ( nr_ordem_compra_p bigint, nr_item_oci_p bigint, cd_material_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_material_w			double precision;
cd_local_estoque_w		smallint;
ds_observacao_w			varchar(255);
cd_centro_custo_w		integer;
cd_conta_contabil_w		varchar(20);
cd_unidade_medida_compra_w	varchar(30);
nr_item_oci_w			integer;
dt_prevista_entrega_w		timestamp;
ds_historico_w			varchar(255);
cd_material_w			integer;
dt_aprovacao_w			ordem_compra_item.dt_aprovacao%type;
cd_unidade_medida_param_w	varchar(30);


BEGIN

cd_unidade_medida_param_w := Obter_Param_Usuario(146, 12, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, cd_unidade_medida_param_w);


if (coalesce(cd_unidade_medida_param_w,'X') = 'S') then

select  	substr(obter_dados_material_estab(cd_material_p,wheb_usuario_pck.get_cd_estabelecimento,'UMC'),1,30) 	cd_unidade_medida_compra
into STRICT 		cd_unidade_medida_compra_w
;

elsif (coalesce(cd_unidade_medida_param_w,'X') = 'E') then

select substr(obter_dados_material_estab(cd_material_p,wheb_usuario_pck.get_cd_estabelecimento,'UME'),1,30) cd_unidade_medida_estoque
into STRICT 		cd_unidade_medida_compra_w
;

elsif (coalesce(cd_unidade_medida_param_w,'X') = 'C') then

select substr(obter_dados_material_estab(cd_material_p,wheb_usuario_pck.get_cd_estabelecimento,'UMS'),1,30) cd_unidade_medida_estoque
into STRICT 		cd_unidade_medida_compra_w
;

elsif (coalesce(cd_unidade_medida_param_w,'X') = 'N') then
--Se for N mantem como sempre foi buscando a unidade de medida de compra
select  	substr(obter_dados_material_estab(cd_material_p,wheb_usuario_pck.get_cd_estabelecimento,'UMC'),1,30) 	cd_unidade_medida_compra
into STRICT 		cd_unidade_medida_compra_w
;


end if;

select	cd_material,
	qt_material,
	cd_local_estoque,
	ds_observacao,
	cd_centro_custo,
	cd_conta_contabil,
	dt_aprovacao
into STRICT	cd_material_w,
	qt_material_w,
	cd_local_estoque_w,
	ds_observacao_w,
	cd_centro_custo_w,
	cd_conta_contabil_w,
	dt_aprovacao_w
from	ordem_compra_item
where	nr_ordem_compra = nr_ordem_compra_p
and	nr_item_oci = nr_item_oci_p;


select	coalesce(max(nr_item_oci),0) + 1
into STRICT	nr_item_oci_w
from	ordem_compra_item
where	nr_ordem_compra = nr_ordem_compra_p;
			
insert into ordem_compra_item(
	nr_ordem_compra,
	nr_item_oci,
	cd_material,
	cd_unidade_medida_compra,
	vl_unitario_material,
	qt_material,
	dt_atualizacao,
	nm_usuario,
	ie_situacao,
	pr_descontos,
	cd_local_estoque,
	ds_observacao,
	vl_item_liquido,
	cd_centro_custo,
	cd_conta_contabil,
	qt_original,
	dt_aprovacao,
	vl_total_item)
Values (nr_ordem_compra_p,
	nr_item_oci_w,
	cd_material_p,
	cd_unidade_medida_compra_w,
	0,
	qt_material_w,
	clock_timestamp(),
	nm_usuario_p,
	'A',
	0,
	cd_local_estoque_w,
	ds_observacao_w,
	0,
	cd_centro_custo_w,
	cd_conta_contabil_w,
	qt_material_w,
	dt_aprovacao_w,
	round((0 * qt_material_w)::numeric,4));

select 	max(dt_prevista_entrega)
into STRICT	dt_prevista_entrega_w
from	ordem_compra_item_entrega
where	nr_ordem_compra = nr_ordem_compra_p
and	nr_item_oci = nr_item_oci_p;

insert into ordem_compra_item_entrega(
	nr_sequencia,
	nr_ordem_compra,
	nr_item_oci,
	dt_prevista_entrega,
	qt_prevista_entrega,
	dt_atualizacao,
	nm_usuario)
values (nextval('ordem_compra_item_entrega_seq'),
	nr_ordem_compra_p,
	nr_item_oci_w,
	dt_prevista_entrega_w,
	qt_material_w,
	clock_timestamp(),
	nm_usuario_p);

delete	FROM ordem_compra_item
where	nr_ordem_compra = nr_ordem_compra_p
and	nr_item_oci = nr_item_oci_p;


ds_historico_w := WHEB_MENSAGEM_PCK.get_texto(306692,'CD_MATERIAL_W=' || cd_material_w || ';' || 'CD_MATERIAL_P=' || cd_material_p);
			
CALL inserir_historico_ordem_compra(nr_ordem_compra_p,'S',WHEB_MENSAGEM_PCK.get_texto(306694),ds_historico_w,nm_usuario_p);

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE substituir_mat_med_trasf ( nr_ordem_compra_p bigint, nr_item_oci_p bigint, cd_material_p bigint, nm_usuario_p text) FROM PUBLIC;

