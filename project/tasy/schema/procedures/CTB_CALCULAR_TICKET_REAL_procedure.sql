-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_calcular_ticket_real ( cd_estabelecimento_p bigint, nr_seq_mes_ref_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w				bigint;
cd_centro_custo_w				integer;
nr_seq_metrica_w				bigint;
qt_metrica_real_w				double precision;
vl_realizado_w				double precision;
vl_ticket_medio_real_w			double precision;

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.cd_centro_custo,
	a.nr_seq_metrica,
	a.vl_realizado
from	ctb_orcamento a
where	cd_estabelecimento	= cd_estabelecimento_p
and	nr_seq_mes_ref	= nr_seq_mes_ref_p
order by 1;


BEGIN

open c01;
loop
fetch c01 into
	nr_sequencia_w,
	cd_centro_custo_w,
	nr_seq_metrica_w,
	vl_realizado_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	select	coalesce(max(qt_metrica_real),0)
	into STRICT	qt_metrica_real_w
	from	ctb_metrica_real
	where	nr_seq_mes_ref	= nr_seq_mes_ref_p
	and	cd_estabelecimento	= cd_estabelecimento
	and	nr_seq_metrica	= nr_seq_metrica_w
	and	cd_centro_custo	= cd_centro_custo_w;
	vl_ticket_medio_real_w	:= dividir(vl_realizado_w, qt_metrica_real_w);
	update ctb_orcamento
	set	vl_ticket_medio_real	= vl_ticket_medio_real_w
	where	nr_sequencia		= nr_sequencia_w;
end loop;
close c01;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_calcular_ticket_real ( cd_estabelecimento_p bigint, nr_seq_mes_ref_p bigint, nm_usuario_p text) FROM PUBLIC;

