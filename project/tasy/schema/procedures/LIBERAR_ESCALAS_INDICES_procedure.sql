-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_escalas_indices ( nm_tabela_p text, nm_chave_p text, qt_chave_p bigint, nr_atendimento_p bigint, nr_seq_evento_p bigint, nr_escala_p text, nm_usuario_p text) AS $body$
DECLARE


ds_sep_bv_w		varchar(10);
ds_comando_w	varchar(255);
dt_avaliacao_w	timestamp;
				

BEGIN

select 	obter_separador_bv
into STRICT	ds_sep_bv_w
;

if	((upper(nm_tabela_p)	= 'ESCALA_ASG_PPP') or (upper(nm_tabela_p)	= 'ESCALA_STRONG_KIDS') or (upper(nm_tabela_p)	= 'AVAL_NUTRIC_SUBJETIVA')) then
	begin
	ds_comando_w	:=	' update ' || nm_tabela_p ||
				' set dt_liberacao = sysdate ' ||
				' where ' || nm_chave_p || ' = :qt_valor ' ||
				' and dt_liberacao is null ';				
				
	CALL exec_sql_dinamico_bv(obter_desc_expressao(726973), ds_comando_w, 'qt_valor='|| to_char(qt_chave_p) || ds_sep_bv_w);	
	end;
else
	begin
	ds_comando_w	:=	' update ' || nm_tabela_p ||
				' set dt_liberacao = sysdate ' ||
				' where ' || nm_chave_p || ' = :qt_valor ' ||
				' and nm_usuario = :nm_usuario ' ||
				' and dt_liberacao is null ';
				
	CALL exec_sql_dinamico_bv(obter_desc_expressao(726973), ds_comando_w, 'qt_valor='|| to_char(qt_chave_p) || ds_sep_bv_w ||
								  'nm_usuario='|| nm_usuario_p || ds_sep_bv_w);
	end;
end if;

CALL gerar_lancamento_automatico(nr_atendimento_p,0,nr_seq_evento_p,nm_usuario_p,0,nr_escala_p,null,null,null,null);
	
ds_comando_w	:=	'Select max(dt_avaliacao) ' ||
			' from ' || nm_tabela_p ||
			' where ' || nm_chave_p || ' = :qt_valor';				
dt_avaliacao_w := Obter_valor_Dinamico_date_bv(ds_comando_w, 'qt_valor='||qt_chave_p, dt_avaliacao_w);

CALL wl_gerar_finalizar_tarefa('S','F',nr_atendimento_p,null,nm_usuario_p,null,'S',null,null,null,null,null,null,nr_escala_p,null,null,null,null,dt_avaliacao_w, qt_chave_p);

commit;	

if (upper(nm_tabela_p)	= 'ESCALA_EIF') then
	CALL gerar_evolucao_score_flex(qt_chave_p,nm_usuario_p);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_escalas_indices ( nm_tabela_p text, nm_chave_p text, qt_chave_p bigint, nr_atendimento_p bigint, nr_seq_evento_p bigint, nr_escala_p text, nm_usuario_p text) FROM PUBLIC;

