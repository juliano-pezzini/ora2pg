-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_mat_proc_producao ( nr_seq_conta_p bigint, nr_seq_guia_p bigint, nr_seq_item_p bigint, ie_tipo_item_p text, nm_usuario_p text, cd_estabelecimento_p bigint, dt_servico_p timestamp, dt_inicio_proc_p timestamp, dt_fim_proc_p timestamp, ie_informar_datas_p text) AS $body$
DECLARE


ie_regra_preco_w		varchar(3);
ie_tipo_despesa_w		varchar(2);
ie_pacote_w			varchar(2);
nr_seq_prest_fornec_w		bigint;
cd_procedimento_w		bigint;
qt_autorizada_w			bigint;
nr_seq_material_w		bigint;
qt_autorizada_mat_w		bigint;
ie_origem_proced_w		bigint;
nr_seq_prestador_w		bigint;
nr_seq_conta_proc_w		bigint;
nr_seq_regra_preco_pac_w	bigint;
nr_seq_pacote_w			bigint;
/*dt_emisao_w			date;*/
 -- Alterado para dt_atendimento_ref_w!!!
dt_atendimento_ref_w		timestamp;
dt_servico_w			timestamp;
dt_inicio_proc_w		timestamp;
dt_fim_proc_w			timestamp;
nr_seq_conta_mat_w		pls_conta_mat.nr_sequencia%type;
nr_seq_item_tiss_proc_w		pls_guia_plano_proc.nr_seq_item_tiss%type;
nr_seq_item_tiss_mat_w		pls_guia_plano_mat.nr_seq_item_tiss%type;

/*
ie tipo Item
P   - Procedimentos
M - Materiais

ie_informar_datas_p
S = Sim
N = Não
*/
BEGIN
if (coalesce(nr_seq_conta_p,0) > 0) then
	if (coalesce(ie_informar_datas_p,'N')	= 'S') then
		dt_servico_w		:= dt_servico_p;
		dt_inicio_proc_w	:= dt_inicio_proc_p;
		dt_fim_proc_w		:= dt_fim_proc_p;
	end if;

	select	dt_atendimento_referencia
	into STRICT	dt_atendimento_ref_w
	from	pls_conta
	where	nr_sequencia	= nr_seq_conta_p;

	if (coalesce(dt_servico_w::text, '') = '') then
		dt_servico_w	:= dt_atendimento_ref_w;
	end if;

	if (ie_tipo_item_p = 'P') then
		select	cd_procedimento,
			coalesce(qt_autorizada,1),
			ie_origem_proced,
			nr_seq_item_tiss
		into STRICT	cd_procedimento_w,
			qt_autorizada_w,
			ie_origem_proced_w,
			nr_seq_item_tiss_proc_w
		from	pls_guia_plano_proc
		where	nr_seq_guia	= nr_seq_guia_p
		and	nr_sequencia	= nr_seq_item_p;

		select	nr_seq_prestador
		into STRICT	nr_seq_prestador_w
		from	pls_guia_plano
		where	nr_sequencia = nr_seq_guia_p;

		select 	coalesce(max(ie_classificacao),1)
		into STRICT	ie_tipo_despesa_w
		from	procedimento
		where	cd_procedimento		= cd_procedimento_w
		and	ie_origem_proced	= ie_origem_proced_w;

		if (nr_seq_prestador_w > 0) then
			select	max(nr_sequencia)
			into STRICT	nr_seq_pacote_w
			from	pls_pacote
			where	coalesce(nr_seq_prestador,coalesce(nr_seq_prestador_w,0))	= coalesce(nr_seq_prestador_w,0)
			and	cd_procedimento		= cd_procedimento_w
			and	ie_origem_proced	= ie_origem_proced_w
			and	ie_situacao		= 'A';

			/* Francisco - 16/05/2012 - OS 447352 */

			if (nr_seq_pacote_w IS NOT NULL AND nr_seq_pacote_w::text <> '') then
				select	coalesce(ie_regra_preco,'N')
				into STRICT	ie_regra_preco_w
				from	pls_pacote a
				where	a.nr_sequencia	= nr_seq_pacote_w;

				if (ie_regra_preco_w = 'S') then
					SELECT * FROM pls_obter_regra_preco_pacote(cd_procedimento_w, ie_origem_proced_w, 'G', nr_seq_item_p, nm_usuario_p, nr_seq_pacote_w, nr_seq_regra_preco_pac_w) INTO STRICT nr_seq_pacote_w, nr_seq_regra_preco_pac_w;
				end if;
			end if;

			if (nr_seq_pacote_w IS NOT NULL AND nr_seq_pacote_w::text <> '') then
				ie_tipo_despesa_w	:= '4';
			end if;
		end if;

		select	nextval('pls_conta_proc_seq')
		into STRICT	nr_seq_conta_proc_w
		;

		insert into pls_conta_proc(cd_procedimento, qt_procedimento_imp, nr_seq_conta,
			dt_atualizacao, nm_usuario, nr_sequencia,
			ie_status, ie_situacao, ie_origem_proced,
			ie_tipo_despesa, dt_procedimento,
			dt_inicio_proc, dt_fim_proc, vl_procedimento_imp,
			vl_unitario_imp)
		values (cd_procedimento_w, qt_autorizada_w, nr_seq_conta_p,
			clock_timestamp(), nm_usuario_p, nr_seq_conta_proc_w,
			'U', 'D', ie_origem_proced_w,
			ie_tipo_despesa_w, dt_servico_w,
			dt_inicio_proc_w, dt_fim_proc_w, 0,
			0);

		CALL pls_cta_proc_mat_regra_pck.cria_registro_regra_proc(nr_seq_conta_proc_w, nm_usuario_p);
		CALL pls_cta_proc_mat_regra_pck.atualiza_seq_tiss_proc(nr_seq_conta_proc_w, nr_seq_item_tiss_proc_w, null, nm_usuario_p);

		if (ie_tipo_despesa_w = '1') then /* Atualizar o valor do procedimento */
			CALL pls_atualiza_valor_proc(nr_seq_conta_proc_w, 'N', nm_usuario_p,'S',null,null);
		elsif (ie_tipo_despesa_w in ('2','3')) then /* Atualizar os valores das taxas e diárias */
			CALL pls_atualiza_valor_servico(nr_seq_conta_proc_w, 'N', nm_usuario_p,'S');
		elsif (ie_tipo_despesa_w = '4') then /* Atualizar os valores dos pacotes */
			CALL pls_atualiza_valor_pacote(nr_seq_conta_proc_w, 'C', nm_usuario_p, 'S', 'N');
		end if;
	elsif (ie_tipo_item_p = 'M') then
		select	nr_seq_material,
			coalesce(qt_autorizada,1),
			nr_seq_prest_fornec,
			nr_seq_item_tiss
		into STRICT	nr_seq_material_w,
			qt_autorizada_mat_w,
			nr_seq_prest_fornec_w,
			nr_seq_item_tiss_mat_w
		from	pls_guia_plano_mat
		where	nr_seq_guia = nr_seq_guia_p
		and	nr_sequencia	= nr_seq_item_p;

		select 	max(ie_tipo_despesa)
		into STRICT	ie_tipo_despesa_w
		from	pls_material
		where	nr_sequencia = nr_seq_material_w;

		insert into pls_conta_mat(nr_seq_material, qt_material_imp, nr_seq_conta,
			dt_atualizacao, nm_usuario, nr_sequencia,
			ie_status, ie_situacao, ie_tipo_despesa,
			dt_atendimento, nr_seq_prest_fornec, vl_material_imp,
			vl_unitario_imp)
		values (nr_seq_material_w, qt_autorizada_mat_w, nr_seq_conta_p,
			clock_timestamp(), nm_usuario_p, nextval('pls_conta_mat_seq'),
			'U', 'D', ie_tipo_despesa_w,
			dt_servico_w, nr_seq_prest_fornec_w,0,
			0) returning nr_sequencia into nr_seq_conta_mat_w;

		CALL pls_cta_proc_mat_regra_pck.cria_registro_regra_mat(nr_seq_conta_mat_w, nm_usuario_p);
		CALL pls_cta_proc_mat_regra_pck.atualiza_seq_tiss_mat(nr_seq_conta_mat_w, nr_seq_item_tiss_mat_w, null, nm_usuario_p);
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_mat_proc_producao ( nr_seq_conta_p bigint, nr_seq_guia_p bigint, nr_seq_item_p bigint, ie_tipo_item_p text, nm_usuario_p text, cd_estabelecimento_p bigint, dt_servico_p timestamp, dt_inicio_proc_p timestamp, dt_fim_proc_p timestamp, ie_informar_datas_p text) FROM PUBLIC;

