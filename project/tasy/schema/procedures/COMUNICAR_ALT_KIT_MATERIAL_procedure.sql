-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE comunicar_alt_kit_material ( nm_usuario_p text, cd_kit_material_p bigint, nr_seq_componente_p bigint, ie_acao_p bigint, ds_campos_alterados_p text) AS $body$
DECLARE


/*
1 - Inclusão
2 - Alteração
3 - Exclusão
*/
ds_comunicado_w		varchar(2000);
ds_titulo_w		varchar(80);
ie_ci_lida_w		varchar(1);
nm_usuario_w		varchar(30);
nm_usuarios_adic_w	varchar(255);
cd_perfil_w		integer;
cd_setor_destino_w	integer;
nr_seq_classif_w	bigint;

ds_acao_executada_w	varchar(60);
ds_kit_material_w	varchar(80);
ds_tipo_kit_w		varchar(80);
cd_material_w		integer;
ds_material_w		varchar(255);

C01 CURSOR FOR
	SELECT	b.ds_comunicacao,
		b.ds_titulo,
		b.ie_ci_lida,
		b.nm_usuario,
		b.nm_usuarios_adic,
		b.cd_perfil,
		b.cd_setor_destino
	from	regra_envio_comunic_compra a,
		regra_envio_comunic_evento b
	where	a.cd_funcao = 143
	and	b.nr_seq_regra = a.nr_sequencia
	and	b.cd_evento = 64
	and	coalesce(b.cd_perfil, wheb_usuario_pck.get_cd_perfil) = wheb_usuario_pck.get_cd_perfil
	and	coalesce(b.cd_setor_destino, wheb_usuario_pck.get_cd_setor_atendimento) = wheb_usuario_pck.get_cd_setor_atendimento
	and	coalesce(b.ie_situacao,'A') = 'A';


BEGIN

if (coalesce(nr_seq_componente_p,0) = 0) then
	if (ie_acao_p = 1) then
		ds_acao_executada_w := wheb_mensagem_pck.get_texto(311882);
	elsif (ie_acao_p = 2) then
		ds_acao_executada_w := wheb_mensagem_pck.get_texto(311883);
	elsif (ie_acao_p = 3) then
		ds_acao_executada_w := wheb_mensagem_pck.get_texto(311884);
	end if;
else
	if (ie_acao_p = 1) then
		ds_acao_executada_w := wheb_mensagem_pck.get_texto(311886);
	elsif (ie_acao_p = 2) then
		ds_acao_executada_w := wheb_mensagem_pck.get_texto(311887);
	elsif (ie_acao_p = 3) then
		ds_acao_executada_w := wheb_mensagem_pck.get_texto(311888);
	end if;
end if;

select	a.ds_kit_material,
	substr(obter_valor_dominio(32,a.ie_tipo),1,80)
into STRICT	ds_kit_material_w,
	ds_tipo_kit_w
from	kit_material a
where	a.cd_kit_material = cd_kit_material_p;

if (coalesce(nr_seq_componente_p,0) > 0) then
	select	a.cd_material,
		b.ds_material
	into STRICT	cd_material_w,
		ds_material_w
	from	componente_kit a,
		material b
	where	a.cd_kit_material = cd_kit_material_p
	and	a.nr_sequencia = nr_seq_componente_p
	and	a.cd_material = b.cd_material;
end if;

open C01;
loop
fetch C01 into
	ds_comunicado_w,
	ds_titulo_w,
	ie_ci_lida_w,
	nm_usuario_w,
	nm_usuarios_adic_w,
	cd_perfil_w,
	cd_setor_destino_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	ds_titulo_w := substr(replace_macro(ds_titulo_w, '@DS_ACAO_EXECUTADA', ds_acao_executada_w),1,80);
	ds_titulo_w := substr(replace_macro(ds_titulo_w, '@NM_USUARIO', nm_usuario_p),1,80);
	ds_titulo_w := substr(replace_macro(ds_titulo_w, '@DT_ALTERACAO', to_char(clock_timestamp(),'dd/mm/yyyy hh24:mi:ss')),1,80);
	ds_titulo_w := substr(replace_macro(ds_titulo_w, '@DS_KIT_MATERIAL', ds_kit_material_w),1,80);
	ds_titulo_w := substr(replace_macro(ds_titulo_w, '@DS_TIPO_KIT', ds_tipo_kit_w),1,80);
	ds_titulo_w := substr(replace_macro(ds_titulo_w, '@CD_MATERIAL', cd_material_w),1,80);
	ds_titulo_w := substr(replace_macro(ds_titulo_w, '@DS_MATERIAL', ds_material_w),1,80);

	ds_comunicado_w := substr(replace_macro(ds_comunicado_w, '@DS_ACAO_EXECUTADA', ds_acao_executada_w),1,2000);
	ds_comunicado_w := substr(replace_macro(ds_comunicado_w, '@DS_CAMPOS_ALTERADOS', ds_campos_alterados_p),1,2000);
	ds_comunicado_w := substr(replace_macro(ds_comunicado_w, '@NM_USUARIO', nm_usuario_p),1,2000);
	ds_comunicado_w := substr(replace_macro(ds_comunicado_w, '@DT_ALTERACAO', to_char(clock_timestamp(),'dd/mm/yyyy hh24:mi:ss')),1,2000);
	ds_comunicado_w := substr(replace_macro(ds_comunicado_w, '@DS_KIT_MATERIAL', ds_kit_material_w),1,2000);
	ds_comunicado_w := substr(replace_macro(ds_comunicado_w, '@DS_TIPO_KIT', ds_tipo_kit_w),1,2000);
	ds_comunicado_w := substr(replace_macro(ds_comunicado_w, '@CD_MATERIAL', cd_material_w),1,2000);
	ds_comunicado_w := substr(replace_macro(ds_comunicado_w, '@DS_MATERIAL', ds_material_w),1,2000);

	select	obter_classif_comunic('F')
	into STRICT	nr_seq_classif_w
	;

	insert into comunic_interna(
		cd_perfil,
		cd_setor_destino,
		ds_comunicado,
		ds_titulo,
		dt_atualizacao,
		dt_comunicado,
		ie_gerencial,
		nm_usuario,
		nm_usuario_destino,
		nr_sequencia,
		nr_seq_classif,
		dt_liberacao)
	values (	cd_perfil_w,
		cd_setor_destino_w,
		ds_comunicado_w,
		ds_titulo_w,
		clock_timestamp(),
		clock_timestamp(),
		'N',
		nm_usuario_p,
		nm_usuarios_adic_w,
		nextval('comunic_interna_seq'),
		nr_seq_classif_w,
		clock_timestamp());

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE comunicar_alt_kit_material ( nm_usuario_p text, cd_kit_material_p bigint, nr_seq_componente_p bigint, ie_acao_p bigint, ds_campos_alterados_p text) FROM PUBLIC;

