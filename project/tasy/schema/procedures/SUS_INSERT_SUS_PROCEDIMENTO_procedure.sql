-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_insert_sus_procedimento ( ie_complexidade_p text, cd_procedimento_p bigint, qt_idade_minima_p bigint, qt_idade_maxima_p bigint, ie_tipo_financiamento_p text, ie_sexo_p text, nr_seq_forma_org_p bigint, cd_financiamento_p text default null, cd_rubrica_p text default null, nm_usuario_p text DEFAULT NULL) AS $body$
DECLARE


nr_seq_financiamento_w	sus_financiamento.nr_sequencia%type;
nr_seq_rubrica_w	sus_rubrica.nr_sequencia%type;
qt_form_org_w		bigint;
nr_seq_forma_org_w	sus_forma_organizacao.nr_sequencia%type;
			

BEGIN

select	count(1)
into STRICT	qt_form_org_w
from	sus_forma_organizacao
where	nr_sequencia = nr_seq_forma_org_p
and	cd_forma_organizacao = substr(cd_procedimento_p, 1, 5);

if ( qt_form_org_w = 0 ) then
	begin
	select	nr_sequencia
	into STRICT	nr_seq_forma_org_w
	from	sus_forma_organizacao
	where	cd_forma_organizacao = substr(cd_procedimento_p, 1, 5);
	end;
else

	nr_seq_forma_org_w	:= nr_seq_forma_org_p;

end if;	
	
	if (coalesce(cd_financiamento_p, 'X') <> 'X') then
	
	
		begin
			select	nr_sequencia
			into STRICT	nr_seq_financiamento_w
			from	sus_financiamento
			where	cd_financiamento = cd_financiamento_p  LIMIT 1;
			exception
			when others then
				nr_seq_financiamento_w := 0;
		end;
		
	end if;	
	
	if (coalesce(cd_rubrica_p, 'X') <> 'X') then
	
		begin
			select	nr_sequencia
			into STRICT	nr_seq_rubrica_w
			from	sus_rubrica
			where	cd_rubrica = cd_rubrica_p  LIMIT 1;
			exception
			when others then
				nr_seq_rubrica_w := 0;
		
		end;
		
	end if;	

insert 	into sus_procedimento(cd_procedimento,
		ie_origem_proced,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ie_complexidade,
		qt_idade_minima,
		qt_idade_maxima,
		ie_tipo_financiamento,
		ie_sexo,
		nr_seq_forma_org,
		nr_seq_financiamento,
		nr_seq_rubrica)
values (cd_procedimento_p,
		7,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_P,
		ie_complexidade_p,
		qt_idade_minima_p,
		qt_idade_maxima_p,
		ie_tipo_financiamento_p,
		ie_sexo_p,
		nr_seq_forma_org_w,
		coalesce(nr_seq_financiamento_w, null),
		coalesce(nr_seq_rubrica_w, null));

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_insert_sus_procedimento ( ie_complexidade_p text, cd_procedimento_p bigint, qt_idade_minima_p bigint, qt_idade_maxima_p bigint, ie_tipo_financiamento_p text, ie_sexo_p text, nr_seq_forma_org_p bigint, cd_financiamento_p text default null, cd_rubrica_p text default null, nm_usuario_p text DEFAULT NULL) FROM PUBLIC;

