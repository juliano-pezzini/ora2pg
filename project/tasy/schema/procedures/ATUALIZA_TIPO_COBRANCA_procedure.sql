-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_tipo_cobranca (nr_interno_conta_p bigint) AS $body$
DECLARE

  nr_atendimento_w conta_paciente.nr_atendimento%type;
  nr_seq_tipo_cobranca_w conta_paciente.nr_seq_tipo_cobranca%type;
  nr_interno_conta_w conta_paciente.nr_interno_conta%type;
  dt_periodo_inicial_w conta_paciente.dt_periodo_inicial%type;
  nr_seq_episodio_w episodio_paciente.nr_sequencia%type;
  dt_fim_episodio_w episodio_paciente.dt_fim_episodio%type;
qt_w	bigint;

  count_tipo_cobranca bigint;

BEGIN

select	count(1)
into STRICT	qt_w
from	conta_paciente
where	nr_interno_conta	= nr_interno_conta_p;

if (qt_w > 0) then

	select 	count(*)
	into STRICT 	count_tipo_cobranca
	from 	tipo_cobranca_conta
	where 	ie_situacao = 'A';

	if (count_tipo_cobranca > 0) then

		select 	nr_atendimento,
			nr_seq_tipo_cobranca,
			dt_periodo_inicial
		into STRICT 	nr_atendimento_w,
			nr_seq_tipo_cobranca_w,
			dt_periodo_inicial_w
		from 	conta_paciente
		where 	nr_interno_conta = nr_interno_conta_p;

		if (coalesce(nr_seq_tipo_cobranca_w::text, '') = '') then

			nr_seq_episodio_w := obter_episodio_atendimento(nr_atendimento_w);

			if (nr_seq_episodio_w <> 0) then

				select 	dt_fim_episodio
				into STRICT 	dt_fim_episodio_w
				from 	episodio_paciente
				where 	nr_sequencia = nr_seq_episodio_w;

				if (coalesce(dt_fim_episodio_w::text, '') = '') then

					nr_seq_tipo_cobranca_w := obter_nr_tipo_cobranca_conta('ATE');
				else
					begin
					select	nr_interno_conta
					into STRICT	nr_interno_conta_w
					from (SELECT	nr_interno_conta
						from 	conta_paciente cp
						inner 	join atendimento_paciente ap ON (cp.nr_atendimento = ap.nr_atendimento)
						where 	ap.nr_seq_episodio = nr_seq_episodio_w
						and 	dt_periodo_inicial >= dt_fim_episodio_w
						order by dt_periodo_inicial) alias1 LIMIT 1;
					exception
					when no_data_found then
						nr_interno_conta_w := null;
					end;

					if (nr_interno_conta_w = nr_interno_conta_p) then
						nr_seq_tipo_cobranca_w := obter_nr_tipo_cobranca_conta('PAE');

					elsif (dt_periodo_inicial_w > dt_fim_episodio_w) then
						nr_seq_tipo_cobranca_w := obter_nr_tipo_cobranca_conta('DAE');
					end if;
				end if;
				if (nr_seq_tipo_cobranca_w IS NOT NULL AND nr_seq_tipo_cobranca_w::text <> '') then

					update 	conta_paciente
					set 	nr_seq_tipo_cobranca = nr_seq_tipo_cobranca_w
					where 	nr_interno_conta = nr_interno_conta_p;
					commit;
				end if;
			end if;
		end if;
	  end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_tipo_cobranca (nr_interno_conta_p bigint) FROM PUBLIC;

