-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE regra_alergia AS (nr_seq_tipo 	ageint_regra_alergia.nr_seq_tipo%type,
							  qt_permisoes	ageint_regra_alergia.qt_permissao%type);


CREATE OR REPLACE PROCEDURE consist_quantidade_pac_alergia (cd_agenda_p bigint, dt_agenda_p timestamp, cd_tipo_agenda_p bigint, cd_pessoa_fisica_p text, nr_seq_agenda_p bigint, ds_retorno_p INOUT text) AS $body$
DECLARE


TYPE vetor_regra_alergia IS TABLE OF regra_alergia INDEX BY integer;

qt_regras_alergia_w		integer;
qt_permissoes_alergia_w	integer;
i						bigint;
j						bigint;
vetor_regra_alergia_w	vetor_regra_alergia;
cd_pessoa_fisica_w		varchar(15);
nr_seq_tipo_w			bigint;
ie_bloquear_w			varchar(2) := 'N';
qt_marcacoes_w			integer;

C01 CURSOR FOR
	SELECT 	cd_pessoa_fisica
	from 	agenda_consulta
	where 	cd_agenda = cd_agenda_p
	and 	trunc(dt_agenda) = trunc(dt_agenda_p)
	and 	(cd_pessoa_fisica IS NOT NULL AND cd_pessoa_fisica::text <> '');

C02 CURSOR FOR
	SELECT 	cd_pessoa_fisica
	from 	agenda_paciente
	where 	cd_agenda = cd_agenda_p
	and 	trunc(dt_agenda) = trunc(dt_agenda_p)
	and 	(cd_pessoa_fisica IS NOT NULL AND cd_pessoa_fisica::text <> '');

C03 CURSOR FOR
	SELECT 	DISTINCT b.nr_seq_tipo
	FROM 	paciente_alergia a,
			ageint_regra_alergia b
	WHERE 	a.cd_pessoa_fisica = cd_pessoa_fisica_w
	AND 	a.nr_seq_tipo = b.nr_seq_tipo
	AND		b.ie_situacao = 'A'
	AND		b.ie_somente_prim_hor = 'N'
	AND 	coalesce(b.cd_tipo_agenda, cd_tipo_agenda_p) = cd_tipo_agenda_p
	and 	coalesce(b.cd_agenda, cd_agenda_p) = cd_agenda_p;

C04 CURSOR FOR
	SELECT 	DISTINCT b.nr_seq_tipo
	FROM 	paciente_alergia a,
			ageint_regra_alergia b
	WHERE 	a.cd_pessoa_fisica = cd_pessoa_fisica_p
	AND 	a.nr_seq_tipo = b.nr_seq_tipo
	AND		b.ie_situacao = 'A'
	AND		b.ie_somente_prim_hor = 'N'
	AND 	coalesce(b.cd_tipo_agenda, cd_tipo_agenda_p) = cd_tipo_agenda_p
	and 	coalesce(b.cd_agenda, cd_agenda_p) = cd_agenda_p;
BEGIN

	SELECT 	count(1)
	into STRICT 	qt_regras_alergia_w
	FROM 	paciente_alergia a,
			ageint_regra_alergia b
	WHERE 	a.cd_pessoa_fisica = cd_pessoa_fisica_p
	AND 	a.nr_seq_tipo = b.nr_seq_tipo
	AND		b.ie_situacao = 'A'
	AND		b.ie_somente_prim_hor = 'N'
	AND 	coalesce(b.cd_tipo_agenda, cd_tipo_agenda_p) = cd_tipo_agenda_p
	and 	coalesce(b.cd_agenda, cd_agenda_p) = cd_agenda_p;

	if (qt_regras_alergia_w = 0) then
		goto final;
	end if;

	vetor_regra_alergia_w.delete();
	if (cd_tipo_agenda_p in (3,4,5)) then

		i := 1;
		for agenda in C01 loop
			cd_pessoa_fisica_w := agenda.cd_pessoa_fisica;

			for alergias in C03 loop

				nr_seq_tipo_w := alergias.nr_seq_tipo;

				if (vetor_regra_alergia_w.count = 0) then

					vetor_regra_alergia_w[i].nr_seq_tipo := nr_seq_tipo_w;
					vetor_regra_alergia_w[i].qt_permisoes := 1;

				else
					j := 1;
					for j in 1..vetor_regra_alergia_w.count loop

						if (vetor_regra_alergia_w[j].nr_seq_tipo = nr_seq_tipo_w) then

							vetor_regra_alergia_w[j].qt_permisoes := vetor_regra_alergia_w[j].qt_permisoes + 1;
							goto encontrou;

						end if;

					end loop;

					vetor_regra_alergia_w[i].nr_seq_tipo := nr_seq_tipo_w;
					vetor_regra_alergia_w[i].qt_permisoes := 1;

				end if;

				<<encontrou>>

				i := i + 1;

			end loop;

		end loop;

	elsif (cd_tipo_agenda_p = 2) then

		i := 1;
		for agenda in C02 loop
			cd_pessoa_fisica_w := agenda.cd_pessoa_fisica;

			for alergias in C03 loop

				nr_seq_tipo_w := alergias.nr_seq_tipo;

				if (vetor_regra_alergia_w.count = 0) then

					vetor_regra_alergia_w[i].nr_seq_tipo := nr_seq_tipo_w;
					vetor_regra_alergia_w[i].qt_permisoes := 1;

				else
					j := 1;
					for j in 1..vetor_regra_alergia_w.count loop

						if (vetor_regra_alergia_w[j].nr_seq_tipo = nr_seq_tipo_w) then

							vetor_regra_alergia_w[j].qt_permisoes := vetor_regra_alergia_w[j].qt_permisoes + 1;
							goto encontrou;

						end if;

					end loop;

					vetor_regra_alergia_w[i].nr_seq_tipo := nr_seq_tipo_w;
					vetor_regra_alergia_w[i].qt_permisoes := 1;

				end if;

				<<encontrou>>

				i := i + 1;

			end loop;

		end loop;

	end if;

	if (vetor_regra_alergia_w.count > 0) then

		i := 1;
		for i in 1..vetor_regra_alergia_w.count loop

			nr_seq_tipo_w := vetor_regra_alergia_w[i].nr_seq_tipo;
			qt_permissoes_alergia_w := vetor_regra_alergia_w[i].qt_permisoes;


			SELECT 	COUNT(1)
			into STRICT 	qt_marcacoes_w
			FROM ageint_marcacao_usuario a
LEFT OUTER JOIN agenda c ON (a.cd_agenda = c.cd_agenda)
, agenda_integrada_item b
LEFT OUTER JOIN ageint_marcacao_usuario a ON (b.nr_sequencia = a.nr_seq_ageint_item)
LEFT OUTER JOIN ageint_pri_hor_livre d ON (b.nr_sequencia = d.nr_seq_ageint_item AND b.nr_seq_agenda_int = d.nr_seq_ageint)
WHERE b.nr_seq_agenda_int = 38782     AND coalesce(a.ie_horario_auxiliar,'N') = 'N' AND coalesce(b.ie_regra,0) NOT IN (1,2,5) AND coalesce(b.ie_glosa,'X') NOT IN ('T','E','R','B','Z') AND coalesce(a.nr_Sequencia,0) <> 0 AND c.cd_Agenda = cd_agenda_p;

			select 	max(qt_permissao)
			into STRICT	qt_regras_alergia_w
			from	ageint_regra_alergia
			where 	ie_situacao = 'A'
			and		ie_somente_prim_hor = 'N'
			and 	coalesce(cd_tipo_agenda, cd_tipo_agenda_p) = cd_tipo_agenda_p
			and 	coalesce(cd_agenda, cd_agenda_p) = cd_agenda_p
			and		nr_seq_tipo = nr_seq_tipo_w;

			qt_permissoes_alergia_w := qt_permissoes_alergia_w + qt_marcacoes_w;

			if (qt_permissoes_alergia_w >= qt_regras_alergia_w) then

				ie_bloquear_w := 'S';
				goto final;

			end if;

		end loop;

	else

		SELECT 	COUNT(1)
		into STRICT 	qt_marcacoes_w
		FROM ageint_marcacao_usuario a
LEFT OUTER JOIN agenda c ON (a.cd_agenda = c.cd_agenda)
, agenda_integrada_item b
LEFT OUTER JOIN ageint_marcacao_usuario a ON (b.nr_sequencia = a.nr_seq_ageint_item)
LEFT OUTER JOIN ageint_pri_hor_livre d ON (b.nr_sequencia = d.nr_seq_ageint_item AND b.nr_seq_agenda_int = d.nr_seq_ageint)
WHERE b.nr_seq_agenda_int = nr_seq_agenda_p     AND coalesce(a.ie_horario_auxiliar,'N') = 'N' AND coalesce(b.ie_regra,0) NOT IN (1,2,5) AND coalesce(b.ie_glosa,'X') NOT IN ('T','E','R','B','Z') AND coalesce(a.nr_Sequencia,0) <> 0 AND c.cd_Agenda = cd_agenda_p;


		for alergias in C04 loop

			nr_seq_tipo_w := alergias.nr_seq_tipo;

			select 	max(qt_permissao)
			into STRICT	qt_regras_alergia_w
			from	ageint_regra_alergia
			where 	ie_situacao = 'A'
			and		ie_somente_prim_hor = 'N'
			and 	coalesce(cd_tipo_agenda, cd_tipo_agenda_p) = cd_tipo_agenda_p
			and 	coalesce(cd_agenda, cd_agenda_p) = cd_agenda_p
			and		nr_seq_tipo = nr_seq_tipo_w;

			if (qt_marcacoes_w >= qt_regras_alergia_w) then

				ie_bloquear_w := 'S';
				goto final;

			end if;
		end loop;

	end if;

	<<final>>
	if (ie_bloquear_w = 'S') then
		ds_retorno_p := wheb_mensagem_pck.get_texto(1042742, 'DS_ALERGIA='||Obter_desc_alergeno(nr_seq_tipo_w));
	else
		ds_retorno_p := null;
	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consist_quantidade_pac_alergia (cd_agenda_p bigint, dt_agenda_p timestamp, cd_tipo_agenda_p bigint, cd_pessoa_fisica_p text, nr_seq_agenda_p bigint, ds_retorno_p INOUT text) FROM PUBLIC;

