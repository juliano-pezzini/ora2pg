-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pfcs_calc_brokenorlost_device ( nr_seq_indicator_p bigint, cd_estabelecimento_p text, nm_usuario_p text) AS $body$
DECLARE


qt_total_brkn_pfcs_w        	pfcs_panel.vl_indicator%type := 0;
qt_total_aux                	pfcs_panel.vl_indicator_aux%type := 0;
nr_seq_operational_level_w  	bigint := 0;
nr_seq_panel_w					pfcs_panel_detail.nr_seq_panel%type;
qt_available_beds_w             bigint := 0;
qt_isUse_device_w               bigint := 0;
ds_device_type_w 			    varchar(10) := 'Monitor';

    c01_fhir_status CURSOR FOR
        SELECT 'U' cd_status_fhir
        
union
 SELECT 'I' cd_status_fhir 
        
union
 select 'C' cd_status_fhir 
        
union
 select 'K' cd_status_fhir 
        
union
 select 'H' cd_status_fhir;

BEGIN
	nr_seq_operational_level_w := (cd_estabelecimento_p)::numeric;

    for c01_w in c01_fhir_status loop
        if (pfcs_get_bed_status(c01_w.cd_status_fhir, 'C', cd_estabelecimento_p, 'Y') = 'A') then
            qt_available_beds_w := qt_available_beds_w + pfcs_get_tele_device_intg_v2(ds_device_type_w, replace(c01_w.cd_status_fhir, 'U', 'Unoccupied'), cd_estabelecimento_p);
        end if;
    end loop;

   	qt_isUse_device_w := pfcs_get_tele_device_intg_v2(ds_device_type_w, 'U', cd_estabelecimento_p);
   	qt_total_brkn_pfcs_w :=  pfcs_get_tele_device_intg_v2(ds_device_type_w, 'BorkenLostDevice', cd_estabelecimento_p);
   	qt_total_aux :=  qt_available_beds_w + qt_isUse_device_w + qt_total_brkn_pfcs_w;

	 := pfcs_pck_v2.pfcs_generate_results(
				vl_indicator_p => qt_total_brkn_pfcs_w, vl_indicator_aux_p => qt_total_aux, ds_reference_value_p => '', nr_seq_indicator_p => nr_seq_indicator_p, nr_seq_operational_level_p => nr_seq_operational_level_w, nm_usuario_p => nm_usuario_p, nr_seq_panel_p => nr_seq_panel_w);

	CALL pfcs_pck_v2.pfcs_update_detail(
				nr_seq_indicator_p => nr_seq_indicator_p,
				nr_seq_panel_p => nr_seq_panel_w,
				nr_seq_operational_level_p => nr_seq_operational_level_w,
				nm_usuario_p => nm_usuario_p);
	commit;

	CALL pfcs_pck_v2.pfcs_activate_records(
			nr_seq_indicator_p => nr_seq_indicator_p,
			nr_seq_operational_level_p => nr_seq_operational_level_w,
			nm_usuario_p => nm_usuario_p);
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_calc_brokenorlost_device ( nr_seq_indicator_p bigint, cd_estabelecimento_p text, nm_usuario_p text) FROM PUBLIC;

