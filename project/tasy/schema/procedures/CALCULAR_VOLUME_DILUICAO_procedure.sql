-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_volume_diluicao ( nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE


C01 CURSOR FOR
	SELECT	distinct nr_agrupamento
	from	prescr_material
	where	nr_prescricao	=	nr_prescricao_p
	and		ie_agrupador	=	1
	and		(nr_agrupamento IS NOT NULL AND nr_agrupamento::text <> '');

nr_agrupamento_w		double precision;
nr_sequencia_princ_w		bigint;
nr_seq_mat_diluicao_w		bigint;
ie_subtrair_volume_medic_w	varchar(1);
qt_conversao_ml_w		double precision;
cd_material_dil_w		integer;
qt_dose_dil_w			double precision;
cd_unidade_medida_dose_dil_w	varchar(30);
qt_conversao_ml_dil_w		double precision;
nr_sequencia_dil_w		bigint;
qt_conv_w			double precision;
qt_volume_medic_w		double precision;
ie_ConsisteDoseConsumoMedic_w	varchar(1);
qt_dose_editada_w		double precision;
qt_volume_diluente_w	double precision;
qt_dose_ref_w			double precision;


BEGIN

open C01;
loop
fetch C01 into
	nr_agrupamento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	min(nr_sequencia)
	into STRICT	nr_sequencia_princ_w
	from	prescr_material
	where	ie_agrupador	= 1
	and		ie_item_superior = 'S'
	and		nr_agrupamento	= nr_agrupamento_w
	and		nr_prescricao	= nr_prescricao_p;

	if (coalesce(nr_sequencia_princ_w,0) = 0) then
		select	min(nr_sequencia)
		into STRICT	nr_sequencia_princ_w
		from	prescr_material
		where	ie_agrupador	= 1
		and	nr_agrupamento	= nr_agrupamento_w
		and	nr_prescricao	= nr_prescricao_p;
	end if;

	if (nr_sequencia_princ_w IS NOT NULL AND nr_sequencia_princ_w::text <> '') then

		select	coalesce(max(nr_seq_mat_diluicao),0),
				max(nr_sequencia),
				max(cd_material),
				max(qt_dose),
				max(cd_unidade_medida_dose),
				max(qt_dose_editada)
		into STRICT	nr_seq_mat_diluicao_w,
				nr_sequencia_dil_w,
				cd_material_dil_w,
				qt_dose_dil_w,
				cd_unidade_medida_dose_dil_w,
				qt_dose_editada_w
		from	prescr_material
		where	nr_sequencia_diluicao	=	nr_sequencia_princ_w
		and		ie_agrupador			=	3
		and		nr_prescricao			=	nr_prescricao_p;

		if (nr_seq_mat_diluicao_w > 0) then
			Select 	coalesce(obter_dose_convertida(a.cd_material,a.qt_dose, a.cd_unidade_medida_dose, b.cd_unidade_medida_consumo),0)
			into STRICT	qt_dose_ref_w
			from	prescr_material a,
				material b
			where	a.cd_material = b.cd_material
			and 	a.nr_prescricao = nr_prescricao_p
			and 	a.nr_sequencia	= nr_sequencia_princ_w;

			select	coalesce(max(ie_subtrair_volume_medic),'N'),
					coalesce(max(ie_diluir_inteiro),'N'),
					max(qt_volume_medic),
					coalesce(max(obter_dose_convertida(cd_diluente,CASE WHEN  coalesce(ie_proporcao,'F')='F' THEN  qt_diluicao  ELSE qt_dose_ref_w*qt_referencia END ,cd_unid_med_diluente, cd_unidade_medida_dose_dil_w)),0)
			into STRICT	ie_subtrair_volume_medic_w,
					ie_ConsisteDoseConsumoMedic_w,
					qt_volume_medic_w,
					qt_volume_diluente_w
			from	material_diluicao
			where	nr_seq_interno	=	nr_seq_mat_diluicao_w;

			if (ie_subtrair_volume_medic_w = 'S') and (coalesce(qt_dose_editada_w::text, '') = '') then
				select	coalesce(obter_volume_ml_medic_agrup(nr_prescricao_p,nr_sequencia_princ_w, ie_ConsisteDoseConsumoMedic_w,qt_volume_medic_w),0)
				into STRICT	qt_conversao_ml_w
				;

				select	coalesce(obter_conversao_ml(cd_material_dil_w,coalesce(qt_volume_diluente_w,qt_dose_dil_w),cd_unidade_medida_dose_dil_w),0)
				into STRICT	qt_conversao_ml_dil_w
				;




				if	((qt_conversao_ml_dil_w - qt_conversao_ml_w) > 0) then

						Select	coalesce(MAX(QT_CONVERSAO),1)
						into STRICT	qt_conv_W
						from	unidade_medida_dose_v
						where	cd_material		= cd_material_dil_w
						and		upper(cd_unidade_medida)	= upper(obter_unid_med_usua('ml'));

					update	prescr_material
					set		qt_dose			=	qt_conversao_ml_dil_w - qt_conversao_ml_w,
							cd_unidade_medida_dose	= obter_unid_med_usua('ml'),
							qt_conversao_dose	=	qt_conv_W
					where	nr_sequencia		=	nr_sequencia_dil_w
					and		ie_agrupador		=	3
					and		nr_prescricao		=	nr_prescricao_p;
				end if;

			end if;
		end if;

	end if;

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_volume_diluicao ( nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

