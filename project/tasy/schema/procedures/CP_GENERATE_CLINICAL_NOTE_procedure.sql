-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cp_generate_clinical_note ( nr_seq_prescr_p bigint, nm_usuario_p text, si_assessment_p text default 'Y', si_diagnosis_p text default 'Y', si_care_plan_p text default 'Y', si_patient_progr_p text default 'Y', type_p text default 'ALL') AS $body$
DECLARE


cd_evolucao_w			bigint;
newline_w			text := chr(13) || chr(10);
space_n1_w			varchar(100) := '      ';
space_n2_w			varchar(100) := '            ';
space_n3_w			varchar(100) := '                  ';
ds_fonte_w			varchar(100);
ds_tam_fonte_w			varchar(100);
nr_tam_fonte_w			integer;
cd_perfil_ativo_w		bigint;
cd_estabelecimento_ativo_w	smallint;
ds_cabecalho_w			varchar(32000);
ds_rodape_w			varchar(255);
ie_rn_w				varchar(1);
cd_prescritor_w			varchar(10);
cd_pessoa_fisica_w		varchar(10);
ie_libera_sae_w			varchar(1);
dt_liberacao_w			timestamp;
nr_seq_modelo_w			bigint;
nr_seq_triagem_w		bigint;
nr_atendimento_w		bigint;
ie_tipo_evolucao_w		varchar(3);
cd_estabelecimento_w		smallint;
ie_gera_intervencao_w		varchar(1);
ds_saida_w			evolucao_paciente.ds_evolucao%type;
ds_title_aval_pac_w		varchar(255) := '\b\ul ' || substr(obter_desc_expressao(10652844, null),1,200) || '\b0\ul0 ';
ds_title_care_plan_w		varchar(255) := '\b\ul ' || substr(obter_desc_expressao(784741, null),1,200) || '\b0\ul0 ';
ds_title_Diagnosis_w		varchar(255) := '\b\ul ' || substr(obter_desc_expressao(827065, null),1,200) || '\b0\ul0 ';
ds_title_patient_progress_w	varchar(255) := '\b\ul ' || substr(obter_desc_expressao(954731, null),1,200) || '\b0\ul0 ';
ds_title_progress_w		varchar(255) := '\b ' || substr(obter_desc_expressao(606038, null),1,200) || '\b0 ';
ds_title_obs_w			varchar(255) := '\b ' || substr(obter_desc_expressao(826007, null),1,200) || '\b0 ';
ds_texto_aval_pac_w		varchar(32000);
ds_texto_care_plan_w		varchar(32000);
ds_texto_progress_w		varchar(32000);
ds_texto_Diagnosis_w		varchar(32000);
ds_texto_geral_w		patient_cp_summary.ds_summary%type;
ds_resumo_w			pe_prescr_resumo.ds_resumo%type;
ds_summary_w			patient_cp_summary.ds_summary%type;
ds_progress_w			pe_prescr_cp_progress.ds_progress%type;
ds_obs_progress_w		pe_prescr_cp_progress.ds_justificativa%type;
ds_diagnosis_w			varchar(255);
flag_title_w			boolean;
cd_tipo_evolucao_w		tipo_evolucao.cd_tipo_evolucao%type;
ds_erro_w			varchar(2000);
si_rule_assessment_w		varchar(1) := 'N';
si_rule_care_plan_w		varchar(1) := 'N';
si_rule_patient_prog_w		varchar(1) := 'N';
si_rule_diagnosis_w		varchar(1) := 'N';
si_rule_clinical_goal_w		varchar(1) := 'N';
si_rule_education_goal_w		varchar(1) := 'N';
ds_data_ini_fim_w		varchar(4000);
ie_should_sign_w varchar(10);

/*1 - Exame Fisico*/

c_pe_prescr_resumo CURSOR FOR
SELECT	a.ds_resumo
from	pe_prescr_resumo a
where	a.nr_seq_pe_prescr = nr_seq_prescr_p
and	a.nm_usuario = nm_usuario_p;

/*2 - Diagnosticos*/

c_pe_prescr_item_result_diag CURSOR FOR
SELECT	substr(pe_obter_desc_diag(a.nr_seq_diag, 'DI'), 1, 255) ds
from	pe_prescr_diag a
where	a.nr_seq_prescr = nr_seq_prescr_p
and	a.nm_usuario = nm_usuario_p;

/*3 - Plano de cuidado*/

c_patient_cp_summary CURSOR FOR
SELECT	a.ds_summary
from	patient_cp_summary a
where	a.nr_seq_prescr = nr_seq_prescr_p
and	a.nm_usuario = nm_usuario_p;

/*4 - Progresso do paciente*/

c_pe_prescr_cp_progress CURSOR FOR
SELECT	obter_valor_dominio(9457,si_progress) ds_progress,
	ds_progress ds_justificativa
from	pe_prescr_cp_progress a
where	a.nr_seq_prescr = nr_seq_prescr_p
and	a.nm_usuario = nm_usuario_p
and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and	coalesce(a.dt_suspensao::text, '') = ''
order by nr_Sequencia desc;

c_meta_educacional CURSOR FOR
SELECT distinct c.NR_SEQUENCIA A, c.DS_DISPLAY_NAME, b.* from
            patient_care_plan a
            , patient_cp_goal b
            , cp_goal c
where a.NR_SEQ_PRESCR = nr_seq_prescr_p
  and a.NR_SEQUENCIA = b.NR_SEQ_PAT_CARE_PLAN
  and b.NR_SEQ_CP_GOAL = c.NR_SEQUENCIA
  and c.IE_TYPE_GOAL = 'E'
  and b.SI_SELECTED = 'Y'
  order by DS_DISPLAY_NAME asc;

c_meta_cuidado CURSOR FOR
SELECT distinct c.NR_SEQUENCIA, c.DS_DISPLAY_NAME, b.DT_START, b.DT_END, b.DT_RELEASE
from 
            patient_care_plan a
            , patient_cp_goal b
            , cp_goal c
where a.NR_SEQ_PRESCR = nr_seq_prescr_p
  and a.NR_SEQUENCIA = b.NR_SEQ_PAT_CARE_PLAN
  and b.NR_SEQ_CP_GOAL = c.NR_SEQUENCIA
  and c.IE_TYPE_GOAL = 'C'
  and b.SI_SELECTED = 'Y'
  order by c.DS_DISPLAY_NAME asc;

c_meta_cuidado_indicador CURSOR FOR
SELECT 	e.DS_DISPLAY_NAME, 
		c.NR_SEQUENCIA PAI, 
		d.*,
		obter_dados_mensuracao_atual(d.nr_seq_cp_indicator, nr_seq_prescr_p, 'DSM') ds_cp_measure
from 
            patient_care_plan a
            , patient_cp_goal b
            , cp_goal c
            , patient_cp_indicator d
            , cp_indicator e
where a.NR_SEQ_PRESCR = nr_seq_prescr_p
  and a.NR_SEQUENCIA = b.NR_SEQ_PAT_CARE_PLAN
  and b.NR_SEQ_CP_GOAL = c.NR_SEQUENCIA
  and d.NR_SEQ_PAT_CP_GOAL = b.NR_SEQUENCIA
  and d.NR_SEQ_CP_INDICATOR = e.NR_SEQUENCIA
  and c.IE_TYPE_GOAL = 'C'
  and b.SI_SELECTED = 'Y'
  order by e.DS_DISPLAY_NAME asc;


BEGIN

select	max(cd_tipo_evolucao)
into STRICT 	cd_tipo_evolucao_w
from	tipo_evolucao
where	ie_care_plan = 'S'
and   	ie_situacao = 'A';

if (cd_tipo_evolucao_w IS NOT NULL AND cd_tipo_evolucao_w::text <> '') then

	cd_perfil_ativo_w := obter_perfil_ativo;
	cd_estabelecimento_ativo_w := obter_estabelecimento_ativo;
	ds_fonte_w := obter_param_usuario(281, 5, cd_perfil_ativo_w, nm_usuario_p, cd_perfil_ativo_w, ds_fonte_w);
	ds_tam_fonte_w := obter_param_usuario(281, 6, cd_perfil_ativo_w, nm_usuario_p, cd_perfil_ativo_w, ds_tam_fonte_w);
	ie_libera_sae_w := obter_param_usuario(281, 384, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ie_libera_sae_w);
	ie_gera_intervencao_w := obter_param_usuario(281, 835, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ie_gera_intervencao_w);
	nr_tam_fonte_w := somente_numero(ds_tam_fonte_w) * 2;
	
	SELECT * FROM get_cp_clinical_note_rule(nm_usuario_p, cd_perfil_ativo_w, cd_estabelecimento_ativo_w, si_rule_assessment_w, si_rule_diagnosis_w, si_rule_care_plan_w, si_rule_patient_prog_w, si_rule_clinical_goal_w, si_rule_education_goal_w) INTO STRICT si_rule_assessment_w, si_rule_diagnosis_w, si_rule_care_plan_w, si_rule_patient_prog_w, si_rule_clinical_goal_w, si_rule_education_goal_w;
    /*DEBUG*/


    /*si_rule_assessment_w := 'Y';
    si_rule_diagnosis_w := 'Y';
    si_rule_care_plan_w := 'Y';
    si_rule_patient_prog_w := 'Y';
    si_rule_clinical_goal_w := 'Y';
    si_rule_education_goal_w := 'N';*/

    /*DEBUG*/

	select	max(ie_tipo_evolucao)
	into STRICT	ie_tipo_evolucao_w
	from	usuario
	where	nm_usuario = nm_usuario_p;

	select	max(nr_atendimento)
	into STRICT	nr_atendimento_w
	from	pe_prescricao
	where	nr_sequencia = nr_seq_prescr_p;

	select	max(cd_prescritor), 
		max(cd_pessoa_fisica),
		coalesce(max(dt_liberacao), clock_timestamp()),
		max(ie_rn),
		max(nr_seq_modelo),
		max(nr_seq_triagem)
	into STRICT	cd_prescritor_w,
		cd_pessoa_fisica_w,
		dt_liberacao_w,
		ie_rn_w,
		nr_seq_modelo_w,
		nr_seq_triagem_w
	from	pe_prescricao
	where	nr_sequencia = nr_seq_prescr_p;

if (type_p = 'ALL' or type_p = 'PRESCRICAO') then
	/*1 - Exame fisico*/

	if (si_rule_assessment_w = 'Y') and (si_assessment_p = 'Y') then
		
		CALL gerar_resumo_exame_fis(nr_seq_prescr_p, nm_usuario_p,'N');		
		flag_title_w := false;
		
		open c_pe_prescr_resumo;
		loop
		fetch c_pe_prescr_resumo into
			ds_resumo_w;
		EXIT WHEN NOT FOUND; /* apply on c_pe_prescr_resumo */
			begin
			if (flag_title_w = false ) then
				ds_texto_geral_w := space_n3_w || ds_title_aval_pac_w;
			end if;
			ds_texto_aval_pac_w := ds_texto_aval_pac_w || newline_w || ds_resumo_w;
			flag_title_w := true;
			end;
		end loop;
		close c_pe_prescr_resumo;
	
		if (ds_resumo_w IS NOT NULL AND ds_resumo_w::text <> '') then
			ds_texto_geral_w := ds_texto_geral_w || newline_w || ds_texto_aval_pac_w || newline_w;
		end if;
	end if;
	
	
	/*2 - Diagnosticos*/
	
	if (si_rule_diagnosis_w = 'Y') and (si_diagnosis_p = 'Y') then
		flag_title_w := false;
		open c_pe_prescr_item_result_diag;
		loop
		fetch c_pe_prescr_item_result_diag into
		    ds_diagnosis_w;
		EXIT WHEN NOT FOUND; /* apply on c_pe_prescr_item_result_diag */
			begin			
			if (flag_title_w = false ) then
				if (ds_texto_geral_w IS NOT NULL AND ds_texto_geral_w::text <> '') then
					ds_texto_geral_w := ds_texto_geral_w || newline_w || space_n3_w || ds_title_Diagnosis_w;
				else
					ds_texto_geral_w := ds_texto_geral_w || space_n3_w || ds_title_Diagnosis_w;
				end if;
			end if;		
			
			ds_texto_Diagnosis_w := ds_texto_Diagnosis_w || newline_w || '\u9643    ' || ds_diagnosis_w;
			flag_title_w := true;
			end;
		end loop;
		close c_pe_prescr_item_result_diag;
		
		if (ds_diagnosis_w IS NOT NULL AND ds_diagnosis_w::text <> '') then
			ds_texto_geral_w := ds_texto_geral_w || newline_w || ds_texto_Diagnosis_w || newline_w;
			ds_texto_geral_w := ds_texto_geral_w || newline_w;
		end if;
	end if;


	/*3 - Plano de Cuidado*/
	
	if (si_rule_care_plan_w = 'Y') and (si_care_plan_p = 'Y') then

		CALL cp_generate_summary(nr_seq_prescr_p, nm_usuario_p, 'N', 'N','N');		
		flag_title_w := false;
		
		open c_patient_cp_summary;
		loop
		fetch c_patient_cp_summary into
			ds_summary_w;
		EXIT WHEN NOT FOUND; /* apply on c_patient_cp_summary */
			begin
			if (flag_title_w = false ) then
				if (ds_texto_geral_w IS NOT NULL AND ds_texto_geral_w::text <> '') then
					ds_texto_geral_w := ds_texto_geral_w || newline_w || space_n3_w || ds_title_care_plan_w;
				else
					ds_texto_geral_w := ds_texto_geral_w || space_n3_w || ds_title_care_plan_w;
				end if;
			end if;

			ds_texto_care_plan_w := ds_texto_care_plan_w || newline_w || ds_summary_w;
			flag_title_w := true;
		end;
		end loop;
		close c_patient_cp_summary;

		if (ds_summary_w IS NOT NULL AND ds_summary_w::text <> '') then
			ds_texto_geral_w := ds_texto_geral_w || newline_w || ds_texto_care_plan_w || newline_w;		
			ds_texto_geral_w := ds_texto_geral_w || newline_w;
		end if;
	end if;

end if;

if (type_p = 'ALL' OR type_p = 'PROGRESSO') then
	/*4 - Progresso do paciente*/
	
	if (si_rule_patient_prog_w = 'Y') and (si_patient_progr_p = 'Y') then
		flag_title_w := false;
		open c_pe_prescr_cp_progress;
		loop
		fetch c_pe_prescr_cp_progress into
		    ds_progress_w,
		    ds_obs_progress_w;
		EXIT WHEN NOT FOUND; /* apply on c_pe_prescr_cp_progress */
			begin
			if (flag_title_w = false ) then
				if (ds_texto_geral_w IS NOT NULL AND ds_texto_geral_w::text <> '') then
					ds_texto_geral_w := ds_texto_geral_w || newline_w || space_n3_w || ds_title_patient_progress_w;
				else
					ds_texto_geral_w := ds_texto_geral_w || space_n3_w || ds_title_patient_progress_w;
				end if;
			end if;		
			
			select	ds_texto_progress_w 	||
				newline_w 		|| 
				CASE WHEN coalesce(ds_progress_w::text, '') = '' THEN null  ELSE ds_title_progress_w || ': ' || ds_progress_w END  		||
				newline_w 		||
				CASE WHEN coalesce(ds_obs_progress_w::text, '') = '' THEN null  ELSE ds_title_obs_w || ': ' || ds_obs_progress_w END 	||
				newline_w
			into STRICT	ds_texto_progress_w
			;
			
			flag_title_w := true;
			exit;
			end;
		end loop;
		close c_pe_prescr_cp_progress;

		if (ds_progress_w IS NOT NULL AND ds_progress_w::text <> '') then
			ds_texto_geral_w := ds_texto_geral_w || newline_w || ds_texto_progress_w || newline_w;
			ds_texto_geral_w := ds_texto_geral_w || newline_w;
		end if;
	end if;

    ds_texto_geral_w := ds_texto_geral_w || cp_generate_goals(nr_seq_prescr_p, 'Y', si_rule_clinical_goal_w, si_rule_education_goal_w) || newline_w;
end if;

	if (ds_texto_geral_w IS NOT NULL AND ds_texto_geral_w::text <> '') then
		
	
		ds_cabecalho_w := '{\rtf1\ansi\ansicpg1252\deff0\deflang1046{\fonttbl{\f0\fswiss\fcharset0 '
			      || ds_fonte_w
			      || ';}}'
			      || '{\*\generator msftedit 5.41.15.1507;}\viewkind4\uc1\pard\f0\fs'
			      || nr_tam_fonte_w
			      || ' ';

		ds_rodape_w := '}';
		
		ds_saida_w := ds_cabecalho_w || replace(ds_texto_geral_w, chr(13) || chr(10), ' \par ') || ds_rodape_w;	
	
	
		select	nextval('evolucao_paciente_seq')
		into STRICT	cd_evolucao_w
		;
		
		
		insert into evolucao_paciente(
			cd_evolucao,
			dt_evolucao,
			ie_tipo_evolucao,
			cd_pessoa_fisica,
			dt_atualizacao,
			nm_usuario,
			nr_atendimento,
			ds_evolucao,
			cd_medico,
			dt_liberacao,
			ie_evolucao_clinica,
			ie_recem_nato,
			ie_situacao,
			nr_seq_sae)
		values (	cd_evolucao_w,
			clock_timestamp(),--dt_liberacao_w,
			ie_tipo_evolucao_w,
			cd_pessoa_fisica_w,
			clock_timestamp(),
			nm_usuario_p,
			nr_atendimento_w,
			ds_saida_w,
			cd_prescritor_w,
			dt_liberacao_w,
			cd_tipo_evolucao_w,
			coalesce(ie_rn_w, 'N'),
			'A',
			nr_seq_prescr_p);

		select  max(ie_assinatura)
		into STRICT    ie_should_sign_w
		from    tasy_proj_assin_perfil
		where   nr_seq_proj = 183
		and     cd_perfil = obter_perfil_ativo;

		if ((ie_should_sign_w IS NOT NULL AND ie_should_sign_w::text <> '') and ie_should_sign_w <> 'N') then
			CALL perform_record_signature(nr_atendimento_w,
				cd_pessoa_fisica_w,
				nm_usuario_p,
				183,
				'EVOLUCAO_PACIENTE',
				cd_evolucao_w,
				29796,
				obter_funcao_ativa,
				'L');
		end if;
	end if;
else
	select obter_desc_expressao(959722,null)
	into STRICT ds_erro_w 
	;

	CALL Wheb_mensagem_pck.exibir_mensagem_abort(ds_erro_w);
end if;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cp_generate_clinical_note ( nr_seq_prescr_p bigint, nm_usuario_p text, si_assessment_p text default 'Y', si_diagnosis_p text default 'Y', si_care_plan_p text default 'Y', si_patient_progr_p text default 'Y', type_p text default 'ALL') FROM PUBLIC;

