-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sup_validar_formula_planej ( ds_formula_p text, ie_erro_p INOUT text) AS $body$
DECLARE


c001			integer;
vl_retorno_atrib_w		varchar(17);
vl_coluna_w		varchar(17);

ds_formula_orig_w		varchar(4000);
ie_erro_w		varchar(1);
tam_formula_w		bigint;
ie_ponto_virgula_w		bigint;
ds_linha_analise_w		varchar(4000);
ie_tipo_analise_w		varchar(1);
ie_pos_separador_w	bigint;
ds_informacao_w		varchar(2000);
ds_formula_w		varchar(4000);
ds_sql_w			varchar(4000);


BEGIN

ie_erro_w	:= 'N';

if (ds_formula_p IS NOT NULL AND ds_formula_p::text <> '') then
	begin

	ds_formula_orig_w	:= upper(ds_formula_p) || ';';

	ds_formula_orig_w	:= replace(ds_formula_orig_w,'RAIZ','SQRT');
	ds_formula_orig_w := replace(ds_formula_orig_w,'TRUNCAR','TRUNC');
	ds_formula_orig_w := replace(ds_formula_orig_w,'ARREDONDAR','ROUND');
	ds_formula_orig_w	:= replace(ds_formula_orig_w,'POTENCIA','POWER');
	ds_formula_orig_w	:= replace(ds_formula_orig_w,'DIAS',to_char(1));
	ds_formula_orig_w	:= replace(ds_formula_orig_w,'LOTE','');
	ds_formula_orig_w	:= replace(replace(ds_formula_orig_w,chr(13),';'),chr(10),'');

	while(ds_formula_orig_w IS NOT NULL AND ds_formula_orig_w::text <> '') and (ie_erro_w = 'N') loop
		begin

		tam_formula_w		:= length(ds_formula_orig_w);
		ie_ponto_virgula_w		:= position(';' in ds_formula_orig_w);

		ds_linha_analise_w		:= substr(ds_formula_orig_w,1,ie_ponto_virgula_w - 1);

		ds_formula_orig_w		:= substr(ds_formula_orig_w,ie_ponto_virgula_w + 1,tam_formula_w);

		ds_linha_analise_w		:= ltrim(ds_linha_analise_w);

		if (substr(ds_linha_analise_w,1,2) = 'SE') then
			ie_tipo_analise_w	:= 'C';
		else
			ie_tipo_analise_w	:= 'F';
		end if;

		ds_linha_analise_w		:= replace(ds_linha_analise_w,'SE','');
		ds_linha_analise_w		:= replace(ds_linha_analise_w,'ENTAO','');

		ds_formula_w		:= '';

		while(ds_linha_analise_w IS NOT NULL AND ds_linha_analise_w::text <> '') loop
			begin

			/* Desmonta a f√≥rmula para pegar palavra por palavra e substituir por seus valores */

			tam_formula_w			:= length(ds_linha_analise_w);
			ie_pos_separador_w		:= position(' ' in ds_linha_analise_w);

			if (ie_pos_separador_w <> 0) then
				ds_informacao_w		:= substr(ds_linha_analise_w,1,(ie_pos_separador_w));
				ds_linha_analise_w		:= substr(ds_linha_analise_w,(ie_pos_separador_w + 1),tam_formula_w);
			else
				ds_informacao_w		:= ds_linha_analise_w;
				ds_linha_analise_w		:= '';
			end if;

			if (substr(ds_informacao_w,1,3) = '#A_') or (substr(ds_informacao_w,1,3) = '#F_') then
				ds_informacao_w	:= '1 ';
			end if;

			ds_formula_w	:= ds_formula_w || ds_informacao_w;

			end;
		end loop; /*END WHILE*/
		if (ie_tipo_analise_w	= 'C') then
			ds_sql_w	:= 'select 1 from dual where 1 = 1 and ' || ds_formula_w;
		else
			ds_sql_w	:= 'select ' || ds_formula_w || ' from dual';
		end if;

		begin

		c001	:= dbms_sql.open_cursor;
		dbms_sql.parse(c001,ds_sql_w,dbms_sql.native);
		dbms_sql.define_column(c001, 1, vl_coluna_w, 17);
		vl_retorno_atrib_w	:= dbms_sql.execute(c001);
		vl_retorno_atrib_w	:= dbms_sql.fetch_rows(c001);
		dbms_sql.column_value(c001, 1, vl_coluna_w);
		dbms_sql.close_cursor(c001);

		exception
		when others then
			ie_erro_w	:= 'S';
		end;

		end;
	end loop;

	end;
end if;

ie_erro_p	:= ie_erro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_validar_formula_planej ( ds_formula_p text, ie_erro_p INOUT text) FROM PUBLIC;

