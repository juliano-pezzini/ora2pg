-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_baca_vinc_event_antig () AS $body$
DECLARE


nr_seq_lote_pgto_w	pls_lote_pagamento.nr_sequencia%type;

c01 CURSOR FOR
	SELECT distinct a.nr_sequencia nr_sequencia
	from	pls_evento_movimento 	b,
		pls_lote_evento		a
	where	coalesce(b.nr_seq_lote_pgto::text, '') = ''
	and	a.nr_sequencia = b.nr_seq_lote
	and	coalesce(a.nr_seq_lote_pgto_apropr::text, '') = ''
	and	a.ie_origem = 'M'
	and 	a.dt_competencia < to_date('01/01/2015')
	and	(b.nr_seq_prestador IS NOT NULL AND b.nr_seq_prestador::text <> '')
	and	(b.nr_seq_evento IS NOT NULL AND b.nr_seq_evento::text <> '')
	and	not exists (	SELECT	1
				from	pls_pagamento_prestador	b,
					pls_pagamento_item	c
				where	c.nr_seq_pagamento	= b.nr_sequencia
				and	b.nr_seq_prestador	= b.nr_seq_prestador
				and	c.nr_seq_evento		= b.nr_seq_evento
				and (c.nr_tit_pagar_origem	= b.nr_tit_pagar_vinculado
					or c.nr_tit_receber_origem = b.nr_tit_rec_vinculado));

BEGIN

select	min(nr_sequencia)
into STRICT	nr_seq_lote_pgto_w
from	pls_lote_pagamento;

for r_c01_w in c01 loop

	update	pls_evento_movimento
	set	nr_seq_lote_pgto = coalesce(nr_seq_lote_pgto, nr_seq_lote_pgto_w),
		nm_usuario = 'TasyBaca'
	where	nr_seq_lote = r_c01_w.nr_sequencia;

	update	pls_lote_evento
	set	ie_origem = 'A',
		nm_usuario = 'TasyBaca'
	where	nr_sequencia = r_c01_w.nr_sequencia;

	commit;
end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_baca_vinc_event_antig () FROM PUBLIC;

