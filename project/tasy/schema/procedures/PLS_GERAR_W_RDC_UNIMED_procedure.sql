-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_w_rdc_unimed ( dt_mes_referencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_usuario_plano_w		varchar(30);
nr_seq_parentesco_w		smallint;
ie_tipo_contratacao_w		smallint;
ie_segmentacao_w		smallint;
ie_abrangencia_w		smallint;
nr_seq_tipo_acomodacao_w	smallint;
ds_plano_w			varchar(255);
tx_co_participacao_amb_w	smallint;
vl_co_participacao_int_w	integer;
dt_nascimento_w			timestamp;
qt_idade_w			smallint;
nr_faixa_etaria_w		varchar(2);
ie_sexo_w			varchar(1);
dt_inclusao_operadora_w		timestamp;
dt_rescisao_w			timestamp;
qt_eventos_consulta_w  		smallint;
vl_custo_consulta_w    		double precision;
vl_copartic_consulta_w 		double precision;
qt_carencia_consulta_w 		smallint;
qt_consulta_pa_w       		smallint;
vl_consulta_pa_w       		double precision;
vl_copartic_consulta_p_w	double precision;
qt_carencia_consulta_p_w	smallint;
qt_exame_g1_w			smallint;
vl_exame_g1_w			double precision;
vl_copartic_exame_g1_w		double precision;
qt_carencia_exame_g1_w		smallint;
qt_exame_g2_w			smallint;
vl_exame_g2_w			double precision;
vl_copartic_exame_g2_w		double precision;
qt_carencia_exame_g2_w		smallint;
qt_terapia_g1_w			smallint;
vl_terapia_g1_w			double precision;
vl_copartic_terapia_g1_w	double precision;
qt_carencia_terapia_g1_w	smallint;
qt_terapia_g2_w			smallint;
vl_terapia_g2_w			double precision;
vl_copartic_terapia_g2_w	double precision;
qt_carencia_terapia_g2_w	smallint;
qt_out_at_amb_w			smallint;
vl_out_at_amb_w			double precision;
vl_copartic_out_at_am_w		double precision;
qt_carencia_out_at_amb_w	smallint;
qt_internacao_w			smallint;
vl_internacao_w			double precision;
vl_copartic_internacao_w	double precision;
qt_carencia_internacao_w	smallint;
qt_demais_w			smallint;
vl_demais_w			double precision;
vl_copartic_demais_w		double precision;
qt_carencia_dem_w		smallint;
dt_fim_ano_w			timestamp;
dt_inicio_ano_w			timestamp;

C01 CURSOR FOR
	SELECT	Somente_Numero(Elimina_Caracteres_Especiais(substr(h.cd_usuario_plano,1,15))),
		CASE WHEN f.nr_seq_parentesco='' THEN 01 WHEN f.nr_seq_parentesco=41 THEN 03 WHEN f.nr_seq_parentesco=4 THEN 04 WHEN f.nr_seq_parentesco=4 THEN 05 WHEN f.nr_seq_parentesco=64 THEN 06 WHEN f.nr_seq_parentesco=64 THEN 07 WHEN f.nr_seq_parentesco=2 THEN 08 WHEN f.nr_seq_parentesco=3 THEN 09 WHEN f.nr_seq_parentesco=125 THEN 10 WHEN f.nr_seq_parentesco=63 THEN 10  ELSE 10 END ,
		CASE WHEN a.ie_tipo_contratacao='CA' THEN 2 WHEN a.ie_tipo_contratacao='CE' THEN 4 WHEN a.ie_tipo_contratacao='I' THEN 1 END ,
		a.ie_segmentacao,
		CASE WHEN a.ie_abrangencia='E' THEN 2 WHEN a.ie_abrangencia='GE' THEN 3 WHEN a.ie_abrangencia='GM' THEN 5 WHEN a.ie_abrangencia='M' THEN 4 WHEN a.ie_abrangencia='N' THEN 1 END ,
		1 nr_seq_tipo_acomodacao,
		substr(a.ds_plano,1,255),
		substr(pls_coparticapaco_rdc_unimed(a.nr_sequencia,'T'),1,2),
		substr(pls_coparticapaco_rdc_unimed(a.nr_sequencia,'V'),1,5),
		to_char(g.dt_nascimento,'dd/mm/yyyy'),
		substr(Obter_Idade(g.dt_nascimento,clock_timestamp(),'A'),1,3),
		pls_faixa_etaria_rdc_unimed(Obter_Idade(g.dt_nascimento,clock_timestamp(),'A'),'C'),
		substr(coalesce(g.ie_sexo,'I'),1,1),
		to_char(f.dt_inclusao_operadora,'dd/mm/yyyy'),
		to_char(f.dt_rescisao,'dd/mm/yyyy'),
		0 qt_eventos_consulta,
		0 vl_custo_consulta,
		0 vl_copartic_consulta,
		0 qt_carencia_consulta,
		0 qt_consulta_pa,
		0 vl_consulta_pa,
		0 vl_copartic_consulta_p,
		0 qt_carencia_consulta_p,
		0 qt_exame_g1,
		0 vl_exame_g1,
		0 vl_copartic_exame_g1,
		0 qt_carencia_exame_g1,
		0 qt_exame_g2,
		0 vl_exame_g2,
		0 vl_copartic_exame_g2,
		0 qt_carencia_exame_g2,
		0 qt_terapia_g1,
		0 vl_terapia_g1,
		0 vl_copartic_terapia_g1,
		0 qt_carencia_terapia_g1,
		0 qt_terapia_g2,
		0 vl_terapia_g2,
		0 vl_copartic_terapia_g2,
		0 qt_carencia_terapia_g2,
		0 qt_out_at_amb,
		0 vl_out_at_amb,
		0 vl_copartic_out_at_amb,
		0 qt_carencia_out_at_amb,
		0 qt_internacao,
		0 vl_internacao,
		0 vl_copartic_internacao,
		0 qt_carencia_internacao,
		0 qt_demais,
		0 vl_demais,
		0 vl_copartic_demais,
		0 qt_carencia_demais
	from	pls_segurado_carteira		h,
		pessoa_fisica			g,
		pls_segurado			f,
		
		pls_contrato			b,
		pls_plano			a
	where	h.nr_seq_segurado		= f.nr_sequencia
	and	f.cd_pessoa_fisica		= g.cd_pessoa_fisica
	and	f.nr_seq_contrato		= b.nr_sequencia
	--and	d.nr_seq_plano(+)		= a.nr_sequencia
	and	f.nr_seq_plano			= a.nr_sequencia
	and	trunc(b.dt_contrato,'yyyy')	= trunc(dt_mes_referencia_p,'yyyy');


BEGIN

dt_inicio_ano_w	:= trunc(dt_mes_referencia_p,'yyyy');
dt_fim_ano_w	:= to_date('31/12/'|| to_char(dt_mes_referencia_p,'yyyy'));

open C01;
loop
fetch C01 into
	cd_usuario_plano_w,
	nr_seq_parentesco_w,
	ie_tipo_contratacao_w,
	ie_segmentacao_w,
	ie_abrangencia_w,
	nr_seq_tipo_acomodacao_w,
	ds_plano_w,
	tx_co_participacao_amb_w,
	vl_co_participacao_int_w,
	dt_nascimento_w,
	qt_idade_w,
	nr_faixa_etaria_w,
	ie_sexo_w,
	dt_inclusao_operadora_w,
	dt_rescisao_w,
	qt_eventos_consulta_w,
	vl_custo_consulta_w,
	vl_copartic_consulta_w,
	qt_carencia_consulta_w,
	qt_consulta_pa_w,
	vl_consulta_pa_w,
	vl_copartic_consulta_p_w,
	qt_carencia_consulta_p_w,
	qt_exame_g1_w,
	vl_exame_g1_w,
	vl_copartic_exame_g1_w,
	qt_carencia_exame_g1_w,
	qt_exame_g2_w,
	vl_exame_g2_w,
	vl_copartic_exame_g2_w,
	qt_carencia_exame_g2_w,
	qt_terapia_g1_w,
	vl_terapia_g1_w,
	vl_copartic_terapia_g1_w,
	qt_carencia_terapia_g1_w,
	qt_terapia_g2_w,
	vl_terapia_g2_w,
	vl_copartic_terapia_g2_w,
	qt_carencia_terapia_g2_w,
	qt_out_at_amb_w,
	vl_out_at_amb_w,
	vl_copartic_out_at_am_w,
	qt_carencia_out_at_amb_w,
	qt_internacao_w,
	vl_internacao_w,
	vl_copartic_internacao_w,
	qt_carencia_internacao_w,
	qt_demais_w,
	vl_demais_w,
	vl_copartic_demais_w,
	qt_carencia_dem_w
	;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	insert into w_pls_rdc_unimed(	nr_sequencia,cd_estabelecimento,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
		dt_inicio_apuracao,dt_fim_apuracao,cd_usuario,cd_vinculo,ie_tipo_contratacao,ie_segmentacao,
		ie_abrangencia,ie_acomodacao,nm_plano,tx_coparticipacao_amb,tx_coparticipacao_inter,dt_nascimento,
		qt_idade,ie_faixa_etaria,ie_sexo,dt_inclusao,dt_exclusao,qt_eventos_consulta,
		vl_custo_consulta,vl_copartic_consulta,qt_carencia_consulta,qt_consulta_pa,vl_consulta_pa,vl_copartic_consulta_pa,
		qt_carencia_consulta_pa,qt_exame_g1,vl_exame_g1,vl_copartic_exame_g1,qt_carencia_exame_g1,qt_exame_g2,
		vl_exame_g2,vl_copartic_exame_g2,qt_carencia_exame_g2,qt_terapia_g1,vl_terapia_g1,vl_copartic_terapia_g1,
		qt_carencia_terapia_g1,qt_terapia_g2,vl_terapia_g2,vl_copartic_terapia_g2,qt_carencia_terapia_g2,qt_out_at_amb,
		vl_out_at_amb,vl_copartic_out_at_amb,qt_carencia_out_at_amb,qt_internacao,vl_internacao,vl_copartic_internacao,
		qt_carencia_internacao,qt_demais,vl_demais,vl_copartic_demais,qt_carencia_demais
	)
	values (	nextval('w_pls_rdc_unimed_seq'),cd_estabelecimento_p,clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
		dt_inicio_ano_w,dt_fim_ano_w,cd_usuario_plano_w,nr_seq_parentesco_w,ie_tipo_contratacao_w,ie_segmentacao_w,
		ie_abrangencia_w,nr_seq_tipo_acomodacao_w,ds_plano_w,tx_co_participacao_amb_w,vl_co_participacao_int_w,dt_nascimento_w,
		qt_idade_w,nr_faixa_etaria_w,ie_sexo_w,dt_inclusao_operadora_w,dt_rescisao_w,qt_eventos_consulta_w,
		vl_custo_consulta_w,vl_copartic_consulta_w,qt_carencia_consulta_w,qt_consulta_pa_w,vl_consulta_pa_w,vl_copartic_consulta_p_w,
		qt_carencia_consulta_p_w,qt_exame_g1_w,vl_exame_g1_w,vl_copartic_exame_g1_w,qt_carencia_exame_g1_w,qt_exame_g2_w,
		vl_exame_g2_w,vl_copartic_exame_g2_w,qt_carencia_exame_g2_w,qt_terapia_g1_w,vl_terapia_g1_w,vl_copartic_terapia_g1_w,
		qt_carencia_terapia_g1_w,qt_terapia_g2_w,vl_terapia_g2_w,vl_copartic_terapia_g2_w,qt_carencia_terapia_g2_w,qt_out_at_amb_w,
		vl_out_at_amb_w,vl_copartic_out_at_am_w,qt_carencia_out_at_amb_w,qt_internacao_w,vl_internacao_w,vl_copartic_internacao_w,
		qt_carencia_internacao_w,qt_demais_w,vl_demais_w,vl_copartic_demais_w,qt_carencia_dem_w
	);

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_w_rdc_unimed ( dt_mes_referencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

