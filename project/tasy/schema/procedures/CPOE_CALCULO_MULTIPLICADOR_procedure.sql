-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_calculo_multiplicador ( nr_sequencia_p bigint, qt_multiplicador_p bigint, qt_multiplicador_old_p bigint) AS $body$
DECLARE


ds_sql_w					varchar(4000);
ds_parametros_w				varchar(4000);
ds_erro_w					varchar(4000);
qt_dose_w					cpoe_npt_produto.qt_dose%type;
qt_volume_w					cpoe_npt_produto.qt_volume%type;
qt_vol_1_fase_w				cpoe_npt_produto.qt_vol_1_fase%type;
qt_vol_2_fase_w				cpoe_npt_produto.qt_vol_2_fase%type;
qt_vol_3_fase_w				cpoe_npt_produto.qt_vol_3_fase%type;
qt_vol_4_fase_w				cpoe_npt_produto.qt_vol_4_fase%type;
qt_diaria_w					cpoe_npt_elemento.qt_diaria%type;
qt_elem_kg_dia_w			cpoe_npt_elemento.qt_elem_kg_dia%type;
qt_kcal_w					cpoe_npt_elemento.qt_kcal%type;
qt_grama_nitrogenio_w		cpoe_npt_elemento.qt_grama_nitrogenio%type;
qt_volume_diario_w			cpoe_dieta.qt_volume_diario%type;
qt_kcal_kg_w				cpoe_dieta.qt_kcal_kg%type;
qt_kcal_total_w				cpoe_dieta.qt_kcal_total%type;
qt_kcal_proteina_w			cpoe_dieta.qt_kcal_proteina%type;
pr_conc_proteina_solucao_w	cpoe_dieta.pr_conc_proteina_solucao%type;
qt_kcal_lipidio_w			cpoe_dieta.qt_kcal_lipidio%type;
pr_conc_lipidio_solucao_w	cpoe_dieta.pr_conc_lipidio_solucao%type;
qt_kcal_carboidrato_w		cpoe_dieta.qt_kcal_carboidrato%type;
pr_conc_glic_solucao_w		cpoe_dieta.pr_conc_glic_solucao%type;
qt_grama_proteina_kg_dia_w	cpoe_dieta.qt_grama_proteina_kg_dia%type;
qt_grama_nitro_dieta_w		cpoe_dieta.qt_grama_nitrogenio%type;
qt_rel_cal_nit_w			cpoe_dieta.qt_rel_cal_nit%type;
qt_vel_inf_glicose_w		cpoe_dieta.qt_vel_inf_glicose%type;
qt_kcal_proteico_w			cpoe_dieta.qt_kcal_proteico%type;
qt_kcal_nao_proteico_w		cpoe_dieta.qt_kcal_nao_proteico%type;
nr_seq_dieta_w				cpoe_dieta.nr_sequencia%type;

c01 CURSOR FOR
SELECT	qt_dose,
		qt_volume,
		qt_vol_1_fase,
		qt_vol_2_fase,
		qt_vol_3_fase,
		qt_vol_4_fase
from	cpoe_npt_produto
where	nr_seq_npt_cpoe	= nr_sequencia_p;

c02 CURSOR FOR
SELECT	qt_diaria,
		qt_elem_kg_dia,
		qt_kcal,
		qt_grama_nitrogenio
from	cpoe_npt_elemento
where	nr_seq_npt_cpoe	= nr_sequencia_p;

c03 CURSOR FOR
SELECT	nr_sequencia,
		qt_kcal_kg,
		qt_kcal_total,
		qt_kcal_proteina,
		pr_conc_proteina_solucao,
		qt_kcal_lipidio,
		pr_conc_lipidio_solucao,
		qt_kcal_carboidrato,
		pr_conc_glic_solucao,
		qt_grama_proteina_kg_dia,
		qt_grama_nitrogenio,
		qt_rel_cal_nit,
		qt_vel_inf_glicose,
		qt_kcal_proteico,
		qt_kcal_nao_proteico
from	cpoe_dieta
where	nr_sequencia = nr_sequencia_p;
BEGIN

	if (qt_multiplicador_p IS NOT NULL AND qt_multiplicador_p::text <> '') and (coalesce(qt_multiplicador_p,0) <> coalesce(qt_multiplicador_old_p,0))   then
		
		for r_c01_w in C01
		loop
			qt_dose_w := r_c01_w.qt_dose;
			qt_volume_w	:= r_c01_w.qt_volume;
			qt_vol_1_fase_w := r_c01_w.qt_vol_1_fase;
			qt_vol_2_fase_w := r_c01_w.qt_vol_2_fase;		
			qt_vol_3_fase_w	:= r_c01_w.qt_vol_3_fase;
			qt_vol_4_fase_w := r_c01_w.qt_vol_4_fase;
			
			begin
				ds_sql_w := 'begin cpoe_multiplicador_produto_md (:1, :2, :3, :4, :5, :6, :7); end;';
				EXECUTE ds_sql_w using in qt_multiplicador_p,
												 in out qt_dose_w,
												 in out qt_volume_w,
												 in out qt_vol_1_fase_w,
												 in out qt_vol_2_fase_w,
												 in out qt_vol_3_fase_w,
												 in out qt_vol_4_fase_w;
			exception
				when others then
					ds_erro_w := substr(sqlerrm, 1, 4000);
					ds_parametros_w :=	substr('qt_multiplicador_p: '||qt_multiplicador_p||'-qt_dose_w: '||qt_dose_w||'-qt_volume_w: '||qt_volume_w||
										'-qt_vol_1_fase_w: '||qt_vol_1_fase_w||'-qt_vol_2_fase_w: '||qt_vol_2_fase_w||'-qt_vol_3_fase_w: '||qt_vol_3_fase_w||'-qt_vol_4_fase_w: '||qt_vol_4_fase_w, 1, 4000);
					CALL gravar_log_medical_device('CPOE_CALCULO_MULTIPLICADOR','CPOE_MULTIPLICADOR_PRODUTO_MD',ds_parametros_w,ds_erro_w,wheb_usuario_pck.get_nm_usuario,'S');
					qt_dose_w := r_c01_w.qt_dose;
					qt_volume_w	:= r_c01_w.qt_volume;
					qt_vol_1_fase_w := r_c01_w.qt_vol_1_fase;
					qt_vol_2_fase_w := r_c01_w.qt_vol_2_fase;		
					qt_vol_3_fase_w	:= r_c01_w.qt_vol_3_fase;
					qt_vol_4_fase_w := r_c01_w.qt_vol_4_fase;
			end;
			
			update	cpoe_npt_produto
			set		qt_dose       = qt_dose_w,
					qt_volume     = qt_volume_w,
					qt_vol_1_fase = qt_vol_1_fase_w,
					qt_vol_2_fase = qt_vol_2_fase_w,
					qt_vol_3_fase = qt_vol_3_fase_w,
					qt_vol_4_fase = qt_vol_4_fase_w
			where	nr_seq_npt_cpoe	= nr_sequencia_p;
											
		end loop;
		
		for r_c02_w in C02
		loop
			qt_diaria_w := r_c02_w.qt_diaria;
			qt_elem_kg_dia_w := r_c02_w.qt_elem_kg_dia;
			qt_kcal_w := r_c02_w.qt_kcal;
			qt_grama_nitrogenio_w := r_c02_w.qt_grama_nitrogenio;
			
			begin
				ds_sql_w := 'begin cpoe_multiplicador_elemento_md(:1, :2, :3, :4, :5); end;';
				EXECUTE ds_sql_w using in qt_multiplicador_p,
												 in out qt_diaria_w,
												 in out qt_elem_kg_dia_w,
												 in out qt_kcal_w,
												 in out qt_grama_nitrogenio_w;
			exception
				when others then
					ds_erro_w := substr(sqlerrm, 1, 4000);
					ds_parametros_w :=	substr('qt_multiplicador_p: '||qt_multiplicador_p||'-qt_diaria_w: '||qt_diaria_w||'-qt_elem_kg_dia_w: '||qt_elem_kg_dia_w||
										'-qt_kcal_w: '||qt_kcal_w||'-qt_grama_nitrogenio_w: '||qt_grama_nitrogenio_w, 1, 4000);								
					CALL gravar_log_medical_device('CPOE_CALCULO_MULTIPLICADOR', 'CPOE_MULTIPLICADOR_ELEMENTO_MD', ds_parametros_w, ds_erro_w, wheb_usuario_pck.get_nm_usuario, 'S');
					qt_diaria_w := r_c02_w.qt_diaria;
					qt_elem_kg_dia_w := r_c02_w.qt_elem_kg_dia;
					qt_kcal_w := r_c02_w.qt_kcal;
					qt_grama_nitrogenio_w := r_c02_w.qt_grama_nitrogenio;
			end;
			
			update	cpoe_npt_elemento
			set		qt_diaria	    	= qt_diaria_w,
					qt_elem_kg_dia	    = qt_elem_kg_dia_w,
					qt_kcal		    	= qt_kcal_w,
					qt_grama_nitrogenio = qt_grama_nitrogenio_w			
			where	nr_seq_npt_cpoe	= nr_sequencia_p;
											
		end loop;
		
		commit;
		
		for r_c03_w in C03
		loop
			select 	coalesce(sum(qt_volume),0) volume
			into STRICT 	qt_volume_diario_w
			from 	cpoe_npt_produto
			where	nr_seq_npt_cpoe	= r_c03_w.nr_sequencia;
			

			qt_kcal_kg_w := r_c03_w.qt_kcal_kg;
			qt_kcal_total_w := r_c03_w.qt_kcal_total;
			qt_kcal_proteina_w := r_c03_w.qt_kcal_proteina;
			pr_conc_proteina_solucao_w := r_c03_w.pr_conc_proteina_solucao;
			qt_kcal_lipidio_w := r_c03_w.qt_kcal_lipidio;
			pr_conc_lipidio_solucao_w := r_c03_w.pr_conc_lipidio_solucao;
			qt_kcal_carboidrato_w := r_c03_w.qt_kcal_carboidrato;
			pr_conc_glic_solucao_w := r_c03_w.pr_conc_glic_solucao;
			qt_grama_proteina_kg_dia_w := r_c03_w.qt_grama_proteina_kg_dia;
			qt_grama_nitro_dieta_w := r_c03_w.qt_grama_nitrogenio;
			qt_rel_cal_nit_w := r_c03_w.qt_rel_cal_nit;
			qt_vel_inf_glicose_w := r_c03_w.qt_vel_inf_glicose;
			qt_kcal_proteico_w := r_c03_w.qt_kcal_proteico;
			qt_kcal_nao_proteico_w := r_c03_w.qt_kcal_nao_proteico;
			
			
			
			begin
				ds_sql_w := 'begin cpoe_multiplicador_dieta_md (:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, :11, :12, :13, :14, :15); end;';
				EXECUTE ds_sql_w using in qt_multiplicador_p,
												 in out qt_kcal_kg_w,
												 in out qt_kcal_total_w,
												 in out qt_kcal_proteina_w,
												 in out pr_conc_proteina_solucao_w,
												 in out qt_kcal_lipidio_w,
												 in out pr_conc_lipidio_solucao_w,
												 in out qt_kcal_carboidrato_w,
												 in out pr_conc_glic_solucao_w,
												 in out qt_grama_proteina_kg_dia_w,
												 in out qt_grama_nitrogenio_w,
												 in out qt_rel_cal_nit_w,
												 in out qt_vel_inf_glicose_w,
												 in out qt_kcal_proteico_w,
												 in out qt_kcal_nao_proteico_w;
			exception
				when others then
					ds_erro_w := substr(sqlerrm, 1, 4000);
					ds_parametros_w :=	substr('nr_sequencia_p: '||nr_sequencia_p||'-qt_multiplicador_p: '||qt_multiplicador_p||'-qt_kcal_kg_w: '||qt_kcal_kg_w||'-qt_kcal_total_w: '||qt_kcal_total_w||'-qt_kcal_proteina_w: '||qt_kcal_proteina_w||
											   '-pr_conc_proteina_solucao_w: '||pr_conc_proteina_solucao_w||'-qt_kcal_lipidio_w: '||qt_kcal_lipidio_w||'-pr_conc_lipidio_solucao_w: '||pr_conc_lipidio_solucao_w||'-qt_kcal_carboidrato_w: '||qt_kcal_carboidrato_w||
											   '-pr_conc_glic_solucao_w: '||pr_conc_glic_solucao_w||'-qt_grama_proteina_kg_dia_w: '||qt_grama_proteina_kg_dia_w||'-qt_grama_nitro_dieta_w: '||qt_grama_nitro_dieta_w||'-qt_rel_cal_nit_w: '||qt_rel_cal_nit_w||
											   '-qt_vel_inf_glicose_w: '||qt_vel_inf_glicose_w||'-qt_kcal_proteico_w: '||qt_kcal_proteico_w||'-qt_kcal_nao_proteico_w: '||qt_kcal_nao_proteico_w, 1, 4000);								
					CALL gravar_log_medical_device('CPOE_CALCULO_MULTIPLICADOR','CPOE_MULTIPLICADOR_PRODUTO_MD',ds_parametros_w,ds_erro_w,wheb_usuario_pck.get_nm_usuario,'S');
					qt_kcal_kg_w := r_c03_w.qt_kcal_kg;
					qt_kcal_total_w := r_c03_w.qt_kcal_total;
					qt_kcal_proteina_w := r_c03_w.qt_kcal_proteina;
					pr_conc_proteina_solucao_w := r_c03_w.pr_conc_proteina_solucao;
					qt_kcal_lipidio_w := r_c03_w.qt_kcal_lipidio;
					pr_conc_lipidio_solucao_w := r_c03_w.pr_conc_lipidio_solucao;
					qt_kcal_carboidrato_w := r_c03_w.qt_kcal_carboidrato;
					pr_conc_glic_solucao_w := r_c03_w.pr_conc_glic_solucao;
					qt_grama_proteina_kg_dia_w := r_c03_w.qt_grama_proteina_kg_dia;
					qt_grama_nitro_dieta_w := r_c03_w.qt_grama_nitrogenio;
					qt_rel_cal_nit_w := r_c03_w.qt_rel_cal_nit;
					qt_vel_inf_glicose_w := r_c03_w.qt_vel_inf_glicose;
					qt_kcal_proteico_w := r_c03_w.qt_kcal_proteico;
					qt_kcal_nao_proteico_w := r_c03_w.qt_kcal_nao_proteico;
			end;
				
			update 	cpoe_dieta
			set		qt_volume_diario		 = qt_volume_diario_w,
					qt_gotejo_npt 			 = qt_volume_diario_w / 24,
					ie_modificado 			 = 'S',
					qt_kcal_kg			 	 = qt_kcal_kg_w,
					qt_kcal_total			 = qt_kcal_total_w,
					qt_kcal_proteina		 = qt_kcal_proteina_w,
					pr_conc_proteina_solucao = pr_conc_proteina_solucao_w,
					qt_kcal_lipidio		 	 = qt_kcal_lipidio_w,
					pr_conc_lipidio_solucao  = pr_conc_lipidio_solucao_w,
					qt_kcal_carboidrato	     = qt_kcal_carboidrato_w,
					pr_conc_glic_solucao	 = pr_conc_glic_solucao_w,
					qt_grama_proteina_kg_dia = qt_grama_proteina_kg_dia_w,
					qt_grama_nitrogenio	     = qt_grama_nitro_dieta_w,
					qt_rel_cal_nit		     = qt_rel_cal_nit_w,
					qt_vel_inf_glicose	     = qt_vel_inf_glicose_w,
					qt_kcal_proteico	     = qt_kcal_proteico_w,
					qt_kcal_nao_proteico	 = qt_kcal_nao_proteico_w
			where 	nr_sequencia = nr_sequencia_p;
		end  loop;
		
		commit;
	end if;	

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_calculo_multiplicador ( nr_sequencia_p bigint, qt_multiplicador_p bigint, qt_multiplicador_old_p bigint) FROM PUBLIC;

