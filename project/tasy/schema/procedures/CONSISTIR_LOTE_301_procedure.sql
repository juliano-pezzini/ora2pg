-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_lote_301 (nr_seq_lote_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_erro_w		bigint;
qt_alerta_w		bigint;
qt_arquivo_w		bigint;

c00 CURSOR FOR
SELECT	a.nr_sequencia,
	a.nr_seq_estrut_arq
from	d301_arquivo_envio a
where	a.nr_seq_lote_envio 	= nr_seq_lote_p;

c00_w	c00%rowtype;

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.ie_dataset
from	d301_dataset_envio a
where	a.nr_seq_arquivo 	= c00_w.nr_sequencia;

c01_w	c01%rowtype;


BEGIN

update	d301_lote_envio
set	DT_INICIO_CONSISTENCIA = clock_timestamp()
where	nr_sequencia	= nr_seq_lote_p;

open C00;
loop
fetch C00 into
	c00_w;
EXIT WHEN NOT FOUND; /* apply on C00 */

	open C01;
	loop
	fetch C01 into
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */

		delete 	from d301_dataset_inconsist
		where	nr_seq_dataset = c01_w.nr_sequencia;

		CALL CONSISTIR_DATASET_301(c00_w.nr_seq_estrut_arq, c01_w.nr_sequencia,c01_w.ie_dataset,nm_usuario_p);

	end loop;
	close C01;

	begin
	select	1
	into STRICT	qt_erro_w
	from	d301_dataset_envio
	where	nr_seq_arquivo		= c00_w.nr_sequencia
	and	IE_STATUS_VALIDACAO 	= 'E'  LIMIT 1;
	exception
	when others then
		qt_erro_w := 0;
	end;

	begin
	select	1
	into STRICT	qt_alerta_w
	from	d301_dataset_envio
	where	nr_seq_arquivo		= c00_w.nr_sequencia
	and	IE_STATUS_VALIDACAO 	= 'A'  LIMIT 1;
	exception
	when others then
		qt_alerta_w := 0;
	end;

	if (qt_erro_w > 0) then
		update	d301_arquivo_envio
		set	ie_status_validacao 	= 'E'
		where	nr_sequencia		= c00_w.nr_sequencia;
	elsif (qt_alerta_w > 0) then
		update	d301_arquivo_envio
		set	ie_status_validacao 	= 'A'
		where	nr_sequencia		= c00_w.nr_sequencia;
	else
		update	d301_arquivo_envio
		set	ie_status_validacao 	= 'V',
			ie_status_envio		= 'P'
		where	nr_sequencia		= c00_w.nr_sequencia;
	end if;

end loop;
close C00;

qt_alerta_w 	:= 0;
qt_erro_w	:= 0;

begin
select	1
into STRICT	qt_arquivo_w
from	d301_arquivo_envio
where	nr_seq_lote_envio      	= nr_seq_lote_p  LIMIT 1;
exception
when others then
	qt_arquivo_w := 0;
end;

begin
select	1
into STRICT	qt_erro_w
from	d301_arquivo_envio
where	nr_seq_lote_envio      	= nr_seq_lote_p
and	IE_STATUS_VALIDACAO 	= 'E'  LIMIT 1;
exception
when others then
	qt_erro_w := 0;
end;

begin
select	1
into STRICT	qt_alerta_w
from	d301_arquivo_envio
where	nr_seq_lote_envio      	= nr_seq_lote_p
and	IE_STATUS_VALIDACAO 	= 'A'  LIMIT 1;
exception
when others then
	qt_alerta_w := 0;
end;

if (qt_erro_w > 0) then
	update	d301_lote_envio
	set	ie_status_validacao 	= 'E'
	where	nr_sequencia		= nr_seq_lote_p;
elsif (qt_alerta_w > 0) then
	update	d301_lote_envio
	set	ie_status_validacao 	= 'A'
	where	nr_sequencia		= nr_seq_lote_p;
elsif (qt_arquivo_w > 0) then
	update	d301_lote_envio
	set	ie_status_validacao 	= 'V',
		ie_status_envio		= 'P'
	where	nr_sequencia		= nr_seq_lote_p;
else
	update	d301_lote_envio
	set	ie_status_validacao 	= 'P'
	where	nr_sequencia		= nr_seq_lote_p;
end if;

update	d301_lote_envio
set	DT_FIM_CONSISTENCIA = clock_timestamp()
where	nr_sequencia	= nr_seq_lote_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_lote_301 (nr_seq_lote_p bigint, nm_usuario_p text) FROM PUBLIC;

