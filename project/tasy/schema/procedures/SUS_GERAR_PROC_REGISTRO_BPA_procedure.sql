-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_gerar_proc_registro_bpa ( cd_procedimento_p procedimento.cd_procedimento%type, ie_origem_proced_p procedimento.ie_origem_proced%type, cd_registro_p sus_registro.cd_registro%type, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE


cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type := coalesce(wheb_usuario_pck.get_cd_estabelecimento,0);
ie_tipo_reg_estab_w	sus_parametros_bpa.ie_tipo_reg_estab%type;
qt_reg_w		bigint := 0;


BEGIN

if (coalesce(cd_procedimento_p,0) <> 0) then
	begin

	begin
	select	coalesce(ie_tipo_reg_estab,'N')
	into STRICT	ie_tipo_reg_estab_w
	from	sus_parametros_bpa
	where	cd_estabelecimento = cd_estabelecimento_w  LIMIT 1;
	exception
	when others then
		ie_tipo_reg_estab_w := 'N';
	end;

	if (ie_tipo_reg_estab_w = 'N') then
		begin

		begin
		select	count(1)
		into STRICT	qt_reg_w
		from	sus_proc_registro_bpa
		where 	cd_procedimento = cd_procedimento_p
		and	ie_origem_proced = ie_origem_proced_p  LIMIT 1;
		exception
		when others then
			qt_reg_w := 0;
		end;

		end;
	else
		begin

		begin
		select	count(1)
		into STRICT	qt_reg_w
		from	sus_proc_registro_bpa
		where 	cd_procedimento = cd_procedimento_p
		and	ie_origem_proced = ie_origem_proced_p
		and	coalesce(cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w  LIMIT 1;
		exception
		when others then
			qt_reg_w := 0;
		end;

		end;
	end if;

	if	((ie_opcao_p = 'I') or (qt_reg_w = 0)) then
		begin
		insert into sus_proc_registro_bpa(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_procedimento,
			ie_origem_proced,
			cd_registro,
			cd_estabelecimento)
		values (	nextval('sus_proc_registro_bpa_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_procedimento_p,
			ie_origem_proced_p,
			cd_registro_p,
			cd_estabelecimento_w);

		end;
	elsif (ie_opcao_p = 'A') then
		begin

		update	sus_proc_registro_bpa
		set	cd_registro 	= cd_registro_p,
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp()
		where 	cd_procedimento = cd_procedimento_p
		and	ie_origem_proced = ie_origem_proced_p
		and	coalesce(cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w;

		end;
	end if;

	commit;

	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_gerar_proc_registro_bpa ( cd_procedimento_p procedimento.cd_procedimento%type, ie_origem_proced_p procedimento.ie_origem_proced%type, cd_registro_p sus_registro.cd_registro%type, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

