-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_limite_int ( nr_seq_prestador_p bigint, dt_mes_competencia_p timestamp, ie_origem_protocolo_p text, dt_protocolo_p timestamp, dt_recebimento_p timestamp, dt_aceite_p timestamp, ie_tipo_guia_p text, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, dt_limite_integracao_p INOUT bigint, ie_referencia_p INOUT text, ie_tipo_data_base_p INOUT text, ie_ultimo_dia_mes_p INOUT text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type default null, ie_tipo_aplicacao_regra_p text default 'C', ie_rec_glosa_p text default 'N') AS $body$
DECLARE


dt_limite_integracao_w		bigint;
dt_limite_integracao_ww		bigint;
ie_referencia_w			varchar(10);
ie_referencia_ww		varchar(10);
nr_seq_grupo_prestador_w	bigint;
nr_seq_classificacao_w		bigint;
ie_grupo_prestador_w		varchar(1)	:= 'S';
nr_seq_tipo_prestador_w		bigint;
ie_tipo_data_base_w		varchar(10);
ie_tipo_data_base_ww		varchar(10);
ie_cad_conta_medica_w		pls_controle_estab.ie_cad_conta_medica%type := 'N';
ie_ultimo_dia_mes_w			pls_regra_prest_integracao.ie_ultimo_dia_mes%type := 'n';
ie_ultimo_dia_mes_ww		pls_regra_prest_integracao.ie_ultimo_dia_mes%type := 'n';
nm_usuario_w			pls_lote_protocolo_conta.nm_usuario%type;
ie_webservice_w			varchar(2);

C01 CURSOR FOR
	SELECT	t.dt_limite_integracao,
		t.ie_referencia,
		t.nr_seq_grupo_prestador,
		t.ie_tipo_data_base,
		t.ie_ultimo_dia_mes
	from (	-- primeiro uinon ? para qunado n?o filtro por estabelecimento
		SELECT	dt_limite_integracao,
			ie_referencia,
			nr_seq_grupo_prestador,
			coalesce(ie_tipo_data_base,'C') ie_tipo_data_base,
			nr_seq_prestador,
			nr_seq_classificacao,
			nr_seq_tipo_prestador,
			dt_inicio_vigencia,
			ie_ultimo_dia_mes
		from	pls_regra_prest_integracao
		where	((coalesce(nr_seq_prestador::text, '') = '') or (nr_seq_prestador = nr_seq_prestador_p))
		and	ie_situacao = 'A'
		and 	((coalesce(ie_tipo_data_base,'C')	= 'C') and trunc(dt_mes_competencia_p) between trunc(coalesce(dt_inicio_vigencia,dt_mes_competencia_p-1)) and fim_dia(coalesce(dt_fim_vigencia,dt_mes_competencia_p+1))
		or (coalesce(ie_tipo_data_base,'C')	= 'P') and trunc(dt_protocolo_p) between trunc(coalesce(dt_inicio_vigencia,dt_protocolo_p-1)) and fim_dia(coalesce(dt_fim_vigencia,dt_protocolo_p+1))
		or (coalesce(ie_tipo_data_base,'C')	= 'R') and trunc(dt_recebimento_p) between trunc(coalesce(dt_inicio_vigencia,dt_recebimento_p-1)) and fim_dia(coalesce(dt_fim_vigencia,dt_recebimento_p+1))
		or (coalesce(ie_tipo_data_base,'C')	= 'F') and trunc(dt_aceite_p) between trunc(coalesce(dt_inicio_vigencia,dt_aceite_p-1)) and fim_dia(coalesce(dt_fim_vigencia,dt_aceite_p+1)))
		and	((coalesce(ie_origem_protocolo::text, '') = '') or (ie_origem_protocolo	= ie_origem_protocolo_p))
		and	((coalesce(nr_seq_classificacao::text, '') = '') or (nr_seq_classificacao = nr_seq_classificacao_w))
		and	((coalesce(nr_seq_tipo_prestador::text, '') = '') or (nr_seq_tipo_prestador = nr_seq_tipo_prestador_w))
		and	((coalesce(ie_tipo_guia::text, '') = '') or (ie_tipo_guia = ie_tipo_guia_p))
		and	((ie_considera_webservice	= 'S') or (coalesce(ie_considera_webservice::text, '') = '') or (ie_considera_webservice = 'N' AND ie_webservice_w = 'N'))
		and	ie_cad_conta_medica_w	= 'N'
		and (coalesce(ie_rec_glosa::text, '') = '' or ie_rec_glosa = 'A' or coalesce(ie_rec_glosa_p::text, '') = '' or ( ie_rec_glosa = ie_rec_glosa_p))
		-- segundo union ? para quando filtra por estab
		
union all

		select	dt_limite_integracao,
			ie_referencia,
			nr_seq_grupo_prestador,
			coalesce(ie_tipo_data_base,'C') ie_tipo_data_base,
			nr_seq_prestador,
			nr_seq_classificacao,
			nr_seq_tipo_prestador,
			dt_inicio_vigencia,
			ie_ultimo_dia_mes
		from	pls_regra_prest_integracao
		where	((coalesce(nr_seq_prestador::text, '') = '') or (nr_seq_prestador = nr_seq_prestador_p))
		and	ie_situacao = 'A'
		and 	((coalesce(ie_tipo_data_base,'C')	= 'C') and trunc(dt_mes_competencia_p) between trunc(coalesce(dt_inicio_vigencia,dt_mes_competencia_p-1)) and fim_dia(coalesce(dt_fim_vigencia,dt_mes_competencia_p+1))
		or (coalesce(ie_tipo_data_base,'C')	= 'P') and trunc(dt_protocolo_p) between trunc(coalesce(dt_inicio_vigencia,dt_protocolo_p-1)) and fim_dia(coalesce(dt_fim_vigencia,dt_protocolo_p+1))
		or (coalesce(ie_tipo_data_base,'C')	= 'R') and trunc(dt_recebimento_p) between trunc(coalesce(dt_inicio_vigencia,dt_recebimento_p-1)) and fim_dia(coalesce(dt_fim_vigencia,dt_recebimento_p+1))
		or (coalesce(ie_tipo_data_base,'C')	= 'F') and trunc(dt_aceite_p) between trunc(coalesce(dt_inicio_vigencia,dt_aceite_p-1)) and fim_dia(coalesce(dt_fim_vigencia,dt_aceite_p+1)))
		and	((coalesce(ie_origem_protocolo::text, '') = '') or (ie_origem_protocolo	= ie_origem_protocolo_p))
		and	((coalesce(nr_seq_classificacao::text, '') = '') or (nr_seq_classificacao = nr_seq_classificacao_w))
		and	((coalesce(nr_seq_tipo_prestador::text, '') = '') or (nr_seq_tipo_prestador = nr_seq_tipo_prestador_w))
		and	((coalesce(ie_tipo_guia::text, '') = '') or (ie_tipo_guia = ie_tipo_guia_p))
		and	((ie_considera_webservice	= 'S') or (coalesce(ie_considera_webservice::text, '') = '') or (ie_considera_webservice = 'N' AND ie_webservice_w = 'N'))
		and	ie_cad_conta_medica_w	= 'S'
		and	cd_estabelecimento	= cd_estabelecimento_p
		and (coalesce(ie_rec_glosa::text, '') = '' or ie_rec_glosa = 'A' or coalesce(ie_rec_glosa_p::text, '') = '' or ( ie_rec_glosa = ie_rec_glosa_p))
		) t
		order by t.dt_inicio_vigencia desc,
			 coalesce(t.nr_seq_prestador,0),
			 coalesce(t.nr_seq_grupo_prestador,0),
			 coalesce(t.nr_seq_classificacao,0),
			 coalesce(t.nr_seq_tipo_prestador,0);

BEGIN

if (coalesce(ie_tipo_aplicacao_regra_p,'C') = 'R') then
	select	coalesce(max(r.nm_usuario),'Tasy')
	into STRICT	nm_usuario_w
	from	pls_rec_glosa_protocolo p,
		pls_rec_glosa_lote r
	where	p.nr_sequencia 	=  nr_seq_protocolo_p
	and	r.nr_sequencia	= p.nr_seq_lote;
else

	select	max(l.nm_usuario)
	into STRICT	nm_usuario_w
	from	pls_protocolo_conta		p,
		pls_lote_protocolo_conta	l
	where	p.nr_sequencia	= nr_seq_protocolo_p
	and	l.nr_sequencia	= p.nr_seq_lote_conta;

end if;

if (nm_usuario_w	= 'WebService') then
	ie_webservice_w := 'S';
else
	ie_webservice_w := 'N';
end if;

select	max(nr_seq_classificacao),
	max(nr_seq_tipo_prestador)
into STRICT	nr_seq_classificacao_w,
	nr_seq_tipo_prestador_w
from	pls_prestador
where	nr_sequencia	= nr_seq_prestador_p;

if (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') then	
	ie_cad_conta_medica_w := pls_obter_se_controle_estab('CM');
else
	ie_cad_conta_medica_w := 'N';
end if;


open C01;
loop
fetch C01 into	
	dt_limite_integracao_ww,
	ie_referencia_ww,
	nr_seq_grupo_prestador_w,
	ie_tipo_data_base_ww,
	ie_ultimo_dia_mes_ww;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ie_grupo_prestador_w		:= 'S';
	/* Grupo de prestadores */

	if (coalesce(nr_seq_grupo_prestador_w,0) > 0) then
		ie_grupo_prestador_w	:= pls_se_grupo_preco_prestador(nr_seq_grupo_prestador_w, nr_seq_prestador_p, nr_seq_classificacao_w);
	end if;	
	
	if (ie_grupo_prestador_w	= 'S') then
		ie_referencia_w		:= ie_referencia_ww;
		dt_limite_integracao_w	:= dt_limite_integracao_ww;
		ie_tipo_data_base_w	:= ie_tipo_data_base_ww;
		ie_ultimo_dia_mes_w := ie_ultimo_dia_mes_ww;
	end if;
	end;
end loop;
close C01;

dt_limite_integracao_p	:= dt_limite_integracao_w;
ie_referencia_p		:= ie_referencia_w;
ie_tipo_data_base_p	:= ie_tipo_data_base_w;
ie_ultimo_dia_mes_p := ie_ultimo_dia_mes_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_limite_int ( nr_seq_prestador_p bigint, dt_mes_competencia_p timestamp, ie_origem_protocolo_p text, dt_protocolo_p timestamp, dt_recebimento_p timestamp, dt_aceite_p timestamp, ie_tipo_guia_p text, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, dt_limite_integracao_p INOUT bigint, ie_referencia_p INOUT text, ie_tipo_data_base_p INOUT text, ie_ultimo_dia_mes_p INOUT text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type default null, ie_tipo_aplicacao_regra_p text default 'C', ie_rec_glosa_p text default 'N') FROM PUBLIC;

