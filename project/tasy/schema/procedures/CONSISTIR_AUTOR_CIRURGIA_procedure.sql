-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_autor_cirurgia (nr_sequencia_p bigint, cd_estabelecimento_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE


cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
ds_material_w			varchar(255);
cd_material_w			bigint;
qt_minimo_w			double precision;
qt_maximo_w			double precision;
qt_material_w			double precision;
ie_obrigatorio_w			varchar(1);
erro_w				varchar(254);

c01 CURSOR FOR
	SELECT	substr(obter_desc_material(cd_material),1,255) ds_material,
		cd_material,
		qt_minimo,
		qt_maximo,
		ie_obrigatorio
	from	regra_autor_proc_mat
	where	cd_estabelecimento = cd_estabelecimento_p
	and	cd_procedimento = cd_procedimento_w
	and	ie_origem_proced = ie_origem_proced_w;


BEGIN
select	cd_procedimento,
	ie_origem_proced
into STRICT	cd_procedimento_w,
	ie_origem_proced_w
from	autorizacao_cirurgia
where	nr_sequencia = nr_sequencia_p;

erro_w := '';

open c01;
loop
fetch c01 into
	ds_material_w,
	cd_material_w,
	qt_minimo_w,
	qt_maximo_w,
	ie_obrigatorio_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	select	qt_material
	into STRICT	qt_material_w
	from	material_autor_cirurgia
	where	nr_seq_autorizacao = nr_sequencia_p
	and	cd_material = cd_material_w;
	if not(qt_material_w >= qt_minimo_w AND qt_material_w <= qt_maximo_w) then
		erro_w := substr(erro_w || wheb_mensagem_pck.get_texto(279668, 'CD_MATERIAL_P=' || to_char(cd_material_w) ||
										';DS_MATERIAL_P=' || trim(both ds_material_w)),1,254);
	end if;
	exception
		when no_data_found then
			if (ie_obrigatorio_w = 'S') then
				erro_w := substr(erro_w || wheb_mensagem_pck.get_texto(279670, 'CD_MATERIAL_P=' || to_char(cd_material_w) ||
												';DS_MATERIAL_P=' || trim(both ds_material_w)),1,254);
			end if;
	end;
end loop;
close c01;

ds_erro_p := erro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_autor_cirurgia (nr_sequencia_p bigint, cd_estabelecimento_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

