-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_relat_compras_vendas ( cd_estabelecimento_p bigint, dt_mesano_referencia_p timestamp, cd_convenio_p bigint, cd_categoria_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_material_w			bigint;
vl_compra_1_w			double precision;
vl_compra_2_w			double precision;
vl_compra_3_w			double precision;
vl_compra_4_w			double precision;
vl_compra_5_w			double precision;
vl_compra_6_w			double precision;
dt_mes_1_w			timestamp;
dt_mes_2_w			timestamp;
dt_mes_3_w			timestamp;
dt_mes_4_w			timestamp;
dt_mes_5_w			timestamp;
dt_mes_6_w			timestamp;
vl_custo_medio_w			double precision;
ds_marca_compra_w		varchar(255);
cd_cnpj_w			varchar(14);
vl_preco_venda_w			double precision;
vl_brasind_simpro_w		double precision;
ds_marca_venda_w		varchar(255);
ds_versao_w			varchar(255);
					
c01 CURSOR FOR 
SELECT	cd_material 
from	material 
where	ie_situacao = 'A' 
and	ie_consignado <> '1';


BEGIN 
 
delete from w_rel_valor_compras_vendas 
where nm_usuario = nm_usuario_p;
 
dt_mes_1_w	:= dt_mesano_referencia_p;
dt_mes_2_w	:= PKG_DATE_UTILS.ADD_MONTH(dt_mesano_referencia_p,-1,0);
dt_mes_3_w	:= PKG_DATE_UTILS.ADD_MONTH(dt_mesano_referencia_p,-2,0);
dt_mes_4_w	:= PKG_DATE_UTILS.ADD_MONTH(dt_mesano_referencia_p,-3,0);
dt_mes_5_w	:= PKG_DATE_UTILS.ADD_MONTH(dt_mesano_referencia_p,-4,0);
dt_mes_6_w	:= PKG_DATE_UTILS.ADD_MONTH(dt_mesano_referencia_p,-5,0);
 
open C01;
loop 
fetch C01 into	 
	cd_material_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	vl_preco_venda_w		:= 0;
	ds_marca_venda_w		:= '';
	ds_versao_w			:= '';
	 
	select	coalesce(obter_dados_maior_compra_mes(cd_estabelecimento_p, cd_material_w, dt_mes_1_w, 'VU'),0) vl_compra_1, 
		coalesce(obter_dados_maior_compra_mes(cd_estabelecimento_p, cd_material_w, dt_mes_2_w, 'VU'),0) vl_compra_2, 
		coalesce(obter_dados_maior_compra_mes(cd_estabelecimento_p, cd_material_w, dt_mes_3_w, 'VU'),0) vl_compra_3, 
		coalesce(obter_dados_maior_compra_mes(cd_estabelecimento_p, cd_material_w, dt_mes_4_w, 'VU'),0) vl_compra_4, 
		coalesce(obter_dados_maior_compra_mes(cd_estabelecimento_p, cd_material_w, dt_mes_5_w, 'VU'),0) vl_compra_5, 
		coalesce(obter_dados_maior_compra_mes(cd_estabelecimento_p, cd_material_w, dt_mes_6_w, 'VU'),0) vl_compra_6, 
		obter_desc_marca(obter_dados_maior_compra_mes(cd_estabelecimento_p, cd_material_w, dt_mes_1_w, 'MA')) ds_marca_compra, 
		obter_dados_maior_compra_mes(cd_estabelecimento_p, cd_material_w, dt_mes_1_w, 'PJ') cd_cnpj, 
		obter_custo_medio_mat_mes_ref(cd_estabelecimento_p, 6, dt_mesano_referencia_p, cd_material_w) 
	into STRICT	vl_compra_1_w, 
		vl_compra_2_w, 
		vl_compra_3_w, 
		vl_compra_4_w, 
		vl_compra_5_w, 
		vl_compra_6_w, 
		ds_marca_compra_w, 
		cd_cnpj_w, 
		vl_custo_medio_w 
	;
	 
	if (cd_convenio_p > 0) and (cd_categoria_p > 0) then 
	 
		select	obter_preco_material(cd_estabelecimento_p, cd_convenio_p, cd_categoria_p, dt_mesano_referencia_p, cd_material_w, 0, 0, 0, null, null, null) vl_brasind_simpro, 
			obter_dados_brasindice2(cd_estabelecimento_p, cd_material_w, dt_mesano_referencia_p, cd_convenio_p, 'DLAB', cd_categoria_p, null, null) ds_marca_venda, 
			obter_dados_brasindice2(cd_estabelecimento_p, cd_material_w, dt_mesano_referencia_p, cd_convenio_p, 'VER', cd_categoria_p, null, null) ds_versao 
		into STRICT	vl_preco_venda_w, 
			ds_marca_venda_w, 
			ds_versao_w 
		;
		 
		if (coalesce(ds_marca_venda_w::text, '') = '') then 
			select	obter_fabric_mat_simpro_estab2(cd_estabelecimento_p, cd_material_w, dt_mesano_referencia_p) 
			into STRICT	ds_marca_venda_w 
			;
		end if;
		 
		if (coalesce(ds_versao_w::text, '') = '') then 
			select	obter_versao_simpro(cd_material_w, cd_convenio_p, cd_estabelecimento_p, dt_mesano_referencia_p) 
			into STRICT	ds_versao_w 
			;
		end if;			
	end if;
 
	insert into w_rel_valor_compras_vendas( 
		cd_material, 
		cd_cnpj, 
		ds_marca_compra, 
		vl_compra_1, 
		vl_compra_2, 
		vl_compra_3, 
		vl_compra_4, 
		vl_compra_5, 
		vl_compra_6, 
		vl_custo_medio, 
		vl_preco_venda, 
		ds_versao, 
		ds_marca_venda, 
		dt_atualizacao, 
		nm_usuario) 
	values (	cd_material_w, 
		cd_cnpj_w, 
		ds_marca_compra_w, 
		vl_compra_1_w, 
		vl_compra_2_w, 
		vl_compra_3_w, 
		vl_compra_4_w, 
		vl_compra_5_w, 
		vl_compra_6_w, 
		vl_custo_medio_w, 
		vl_preco_venda_w, 
		ds_versao_w, 
		ds_marca_venda_w, 
		clock_timestamp(), 
		nm_usuario_p);
	 
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_relat_compras_vendas ( cd_estabelecimento_p bigint, dt_mesano_referencia_p timestamp, cd_convenio_p bigint, cd_categoria_p bigint, nm_usuario_p text) FROM PUBLIC;

