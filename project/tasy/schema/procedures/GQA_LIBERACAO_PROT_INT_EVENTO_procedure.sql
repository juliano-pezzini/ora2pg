-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gqa_liberacao_prot_int_evento (nr_sequencia_p protocolo_int_pac_evento.nr_sequencia%type, nm_usuario_p gqa_pendencia_pac.nm_usuario%type, nr_atendimento_p gqa_pendencia_pac.nr_atendimento%type default null, ds_nr_seq_pend_pac_p INOUT text DEFAULT NULL) AS $body$
DECLARE



ds_nr_seq_pend_pac_w        varchar(1000);	
nr_atendimento_w            bigint;
nr_sequencia_w              bigint;
cd_pessoa_fisica_w          varchar(10);
cd_setor_atendimento_w      bigint;
qt_idade_dias_w             integer;
qt_peso_gramas_w            double precision;
qt_idade_w                  bigint;

C01 CURSOR FOR
    SELECT  a.nr_sequencia
    from    gqa_pendencia_regra a,
            gqa_pendencia       b,
            protocolo_int_pac_evento c
    where   b.nr_sequencia	    = a.nr_seq_pendencia
    and	    c.nr_sequencia = nr_sequencia_p
    and	    c.nr_seq_plano = a.nr_sequencia
    and	    b.ie_tipo_pendencia	= 12
    and	    b.ie_situacao 		= 'A'
    and	    a.ie_situacao		= 'A'
    and	    obter_se_gqa_regra_liberada(a.nr_sequencia) = 'S'
    and     qt_idade_w       between coalesce(a.qt_idade_min,0) and coalesce(a.qt_idade_max,999)
    and     qt_idade_dias_w  between coalesce(a.qt_dias_min ,0) and coalesce(a.qt_dias_max ,99999)
    and     qt_peso_gramas_w between coalesce(a.qt_peso_gramas_min,0) and coalesce(a.qt_peso_gramas_max,999999999)
    and     coalesce(a.cd_setor_atendimento,coalesce(cd_setor_atendimento_w,0))	= coalesce(cd_setor_atendimento_w,0);

BEGIN

ds_nr_seq_pend_pac_w    := '';
nr_atendimento_w        := nr_Atendimento_p;
cd_pessoa_fisica_w      := obter_pessoa_atendimento(nr_atendimento_w,'C');
cd_setor_atendimento_w  := obter_setor_atendimento(nr_atendimento_w);
qt_idade_w              := obter_idade_pf(cd_pessoa_fisica_w,clock_timestamp(),'A');
qt_idade_dias_w         := obter_idade_pf(cd_pessoa_fisica_w, clock_timestamp(), 'DIA');
qt_peso_gramas_w        := (coalesce(obter_peso_pf(cd_pessoa_fisica_w),0) * 1000);


  FOR c01_w IN C01 LOOP

      begin

      select	nextval('gqa_pendencia_pac_seq')
      into STRICT	nr_sequencia_w
;

      insert into gqa_pendencia_pac(
                      nr_sequencia,
                      dt_atualizacao,
                      nm_usuario,
                      dt_atualizacao_nrec,
                      nm_usuario_nrec,
                      cd_pessoa_fisica,
                      nr_atendimento,
                      NR_SEQ_PROTOCOLO_INT_PAC_EVEN,
                      NR_SEQ_PEND_REGRA)
      values (	nr_sequencia_w,
                      clock_timestamp(),
                      nm_usuario_p,
                      clock_timestamp(),
                      nm_usuario_p,
                      cd_pessoa_fisica_w,
                      nr_atendimento_w,
                      nr_sequencia_p,
                      c01_w.nr_sequencia);

      ds_nr_seq_pend_pac_w := concat(ds_nr_seq_pend_pac_w,nr_sequencia_w||',');

      commit;

      CALL gerar_consulta_reg_mentor(nm_usuario_p, 'PROTOCOLO_INT_PAC_EVENTO', c01_w.nr_sequencia, nr_sequencia_p, nr_sequencia_w);
      CALL GQA_GERAR_ACAO_REGRA(c01_w.nr_sequencia,nr_sequencia_w,nr_atendimento_w,cd_pessoa_fisica_w,nm_usuario_p);

      end;

  end loop;


commit;

ds_nr_seq_pend_pac_p := rtrim(ds_nr_seq_pend_pac_w,',');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gqa_liberacao_prot_int_evento (nr_sequencia_p protocolo_int_pac_evento.nr_sequencia%type, nm_usuario_p gqa_pendencia_pac.nm_usuario%type, nr_atendimento_p gqa_pendencia_pac.nr_atendimento%type default null, ds_nr_seq_pend_pac_p INOUT text DEFAULT NULL) FROM PUBLIC;

