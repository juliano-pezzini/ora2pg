-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_integrar_lote_anexo ( nr_seq_lote_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ie_status_lote_w		varchar(2);	
nr_seq_lote_anexo_w		bigint;
		

BEGIN 
 
select	max(ie_status_lote) 
into STRICT	ie_status_lote_w 
from	pls_lote_anexo_aut 
where	nr_sequencia = nr_seq_lote_p;
 
--Verifica se o status do lote é 'Consistido sem glosa', se sim permite sua integração 
if ( ie_status_lote_w = 'CS' ) then 
	--Gerar os itens de anexo, conforme os itens já existentes na guia 
	nr_seq_lote_anexo_w := pls_gerar_lote_ax_guias_aut(null, nr_seq_lote_p, null, nm_usuario_p, nr_seq_lote_anexo_w);
	--pls_gerar_guia_lote_anexo(nr_seq_lote_p, nm_usuario_p);	 
	 
	--Atualiza o lote para integrado após gerar os anexos nas guias 
	update	pls_lote_anexo_aut 
	set	ie_status_lote 	= 'I', 
		nm_usuario 	= nm_usuario_p, 
		dt_atualizacao	= clock_timestamp() 
	where	nr_sequencia	= nr_seq_lote_p;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_integrar_lote_anexo ( nr_seq_lote_p bigint, nm_usuario_p text) FROM PUBLIC;

