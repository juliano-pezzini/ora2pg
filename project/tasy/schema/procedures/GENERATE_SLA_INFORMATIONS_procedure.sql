-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE generate_sla_informations ( dt_inicio_p text, dt_fim_p text ) AS $body$
DECLARE

  /*outros parametros*/

  dt_atual_w      varchar(100);
  qt_dia_atual_w  bigint;
  dt_dias_total_w double precision;
  ds_dia_w        varchar(10);
  qt_registros    bigint;

  dt_atual_dia_w timestamp; -- truncated to day
  dt_atual_mes_w timestamp; -- truncated to month
  c01 CURSOR FOR
    /* Begin Script de localizacao dos dados*/

SELECT
to_date(extract_date, 'dd/mm/rrrr hh24:mi:ss') extract_date,
customer,
so_number,
so_description,
customer_classification,
philips_classification,
customer_severity,
philips_severity,
so_sla,
development_group,
develop_management_id,
develop_management,
develop_manager,
support_group,
support_management,
support_manager,
sla_id,
sla_detail,
sla_target,
sla_description,
target_response,
target_resolution,
to_date(so_open_time, 'dd/mm/rrrr hh24:mi:ss') so_open_time,
to_date(so_open_month_year, 'dd/mm/rrrr hh24:mi:ss') so_open_month_year,
to_date(so_close_time, 'dd/mm/rrrr hh24:mi:ss') so_close_time,
to_date(so_close_month_year, 'dd/mm/rrrr hh24:mi:ss') so_close_month_year,
to_date(response_finish_in, 'dd/mm/rrrr hh24:mi:ss') response_finish_in,
to_date(resolution_finish_in, 'dd/mm/rrrr hh24:mi:ss') resolution_finish_in,
to_date(work_start, 'dd/mm/rrrr hh24:mi:ss') work_start,
aging,
actual_stage,
doc_defect,
to_date(last_update_philips, 'dd/mm/rrrr hh24:mi:ss') last_update_philips,
days_without_update_philips,
to_date(last_update_customer, 'dd/mm/rrrr hh24:mi:ss') last_update_customer,
so_response_time,
so_resolution_time,
customer_time,
sla_resolution_remaining,
sla_resolution_breached,
to_date(sla_resolution_breached_in, 'dd/mm/rrrr hh24:mi:ss') sla_resolution_breached_in,
sla_response_remaining,
sla_response_breached,
to_date(so_reclassification_time, 'dd/mm/rrrr hh24:mi:ss') SO_RECLASSIFICATION_TIME,
so_worked,
status_sla_resolution,
localization,
status_sla_response from (
/*OSs ABERTAS*/

select REL2.*
      ,CASE
        WHEN REL2.SLA_RESPONSE_BREACHED = 'S' THEN
          'Breached'
        WHEN REL2.SLA_RESOLUTION_REMAINING <= 60 THEN
          'Critical'
        WHEN REL2.SLA_RESOLUTION_REMAINING > 60 and REL2.SLA_RESOLUTION_REMAINING <= 480 THEN
          'Warning'
        WHEN REL2.SLA_RESOLUTION_REMAINING > 480 THEN
          'Good'
        ELSE
          NULL
      END
      STATUS_SLA_RESPONSE
from (
SELECT CASE WHEN dt_atual_w=trunc(clock_timestamp()) THEN  to_char(clock_timestamp(),'dd/mm/yyyy hh24:mi:ss')  ELSE dt_atual_w || ' 23:59:59' END  EXTRACT_DATE
       ,REL1.CUSTOMER
       ,REL1.SO_NUMBER
       ,REL1.SO_DESCRIPTION
       ,REL1.CUSTOMER_CLASSIFICATION
       ,REL1.PHILIPS_CLASSIFICATION
       ,REL1.CUSTOMER_SEVERITY
       ,REL1.PHILIPS_SEVERITY
       ,REL1.SO_SLA
       ,REL1.DEVELOPMENT_GROUP
       ,REL1.DEVELOP_MANAGEMENT_ID
       ,REL1.DEVELOP_MANAGEMENT
       ,REL1.DEVELOP_MANAGER
       ,REL1.SUPPORT_GROUP
       ,REL1.SUPPORT_MANAGEMENT
       ,REL1.SUPPORT_MANAGER
       ,REL1.SLA_ID
       ,REL1.SLA_DETAIL
       ,REL1.SLA_TARGET
       ,REL1.SLA_DESCRIPTION
       ,REL1.TARGET_RESPONSE
       ,REL1.TARGET_RESOLUTION
       ,REL1.SO_OPEN_TIME
       ,REL1.SO_OPEN_MONTH_YEAR
       ,REL1.SO_CLOSE_TIME
       ,REL1.SO_CLOSE_MONTH_YEAR
       ,REL1.RESPONSE_FINISH_IN
       ,REL1.RESOLUTION_FINISH_IN
       ,REL1.WORK_START
       ,REL1.AGING
       ,REL1.ACTUAL_STAGE
       ,REL1.DOC_DEFECT
       ,REL1.LAST_UPDATE_PHILIPS
       ,REL1.DAYS_WITHOUT_UPDATE_PHILIPS
       ,REL1.LAST_UPDATE_CUSTOMER
       ,REL1.SO_RESPONSE_TIME
       ,REL1.SO_RESOLUTION_TIME
       ,REL1.CUSTOMER_TIME
       ,REL1.SLA_RESOLUTION_REMAINING
       ,REL1.SLA_RESOLUTION_BREACHED
       ,CASE WHEN  REL1.TARGET_RESOLUTION=0 THEN NULL  ELSE CASE                      WHEN REL1.IE_TEMPO='COR' THEN                         TO_CHAR(TO_DATE(REL1.SO_OPEN_TIME,'DD/MM/YYYY HH24:MI:SS') + (REL1.TARGET_RESOLUTION/1440),'DD/MM/YYYY HH24:MI:SS')                      ELSE (    SELECT to_char(man_obter_hor_com(ml.cd_estabelecimento                                                                  ,CASE                                                                    WHEN msr.QT_MIN_TERMINO > REL1.SO_RESOLUTION_TIME  THEN                                                                      max(mose.DT_ATUALIZACAO)                                                                    ELSE                                                                      min(mose.DT_ATUALIZACAO)                                                                   END                                                                  ,CASE                                                                    WHEN msr.QT_MIN_TERMINO > REL1.SO_RESOLUTION_TIME  THEN (msr.QT_MIN_TERMINO - REL1.SO_RESOLUTION_TIME)                                                                    ELSE                                                                      msr.QT_MIN_TERMINO                                                                   END                                                                  )                                          ,'DD/MM/YYYY HH24:MI:SS') SLA_RESOLUTION_BREACHED_IN                             from MAN_SLA ms                                  ,MAN_SLA_REGRA msr                                  ,MAN_SLA_LOC msl                                  ,MAN_LOCALIZACAO ml                                  ,man_ordem_servico mos                                  ,man_ordem_serv_estagio mose                                  ,man_estagio_processo mep                            where ms.IE_SITUACAO='A'                              and trunc(ms.DT_VIGENCIA) <= dt_atual_w                              and ms.NR_SEQUENCIA = msr.NR_SEQ_SLA                              and msr.NR_SEQ_SLA = msl.NR_SEQ_SLA                              and ml.NR_SEQUENCIA = msl.NR_SEQ_LOCAL                              and msr.IE_PRIORIDADE = mos.IE_PRIORIDADE /*FILTRO PRIORIDADE DA OS = PRIORIDADE DO CADASTRO DE SLA*/
                              and mos.nr_seq_localizacao = ml.nr_sequencia                              and mos.nr_sequencia = mose.NR_SEQ_ORDEM                              and mose.nr_seq_estagio = mep.nr_sequencia                              and mos.nr_sequencia = REL1.SO_NUMBER			      and ml.ie_terceiro = 'S'                /* Desconsiderar estágios abaixo
                  2 Cliente (Teste)
                  261 Desenv aguardando cliente
                  1341  Aguardando Inf. do Cliente - Suporte
                  1511  Cliente (Teste) - OK
                  1902  Tec aguardando definição cliente
                  511 Encerramento solicitado pelo Cliente
                  9 OK - Cliente - Encerrado
                  121-Aguardando Conexão
                  41 Aguardando Informações do Cliente
                */
                              and mep.nr_sequencia not in (2,261,1341,1511,1902,511,9,121,41)                         group by msr.QT_MIN_TERMINO,ml.cd_estabelecimento )                   END END 
        SLA_RESOLUTION_BREACHED_IN
       ,(REL1.TARGET_RESPONSE - REL1.SO_RESPONSE_TIME) SLA_RESPONSE_REMAINING
       ,CASE
          WHEN(REL1.TARGET_RESPONSE - REL1.SO_RESPONSE_TIME) > 0 THEN
           'N'
          ELSE
           'S'
        END SLA_RESPONSE_BREACHED
       ,CASE
           WHEN TO_DATE(REL1.SO_OPEN_TIME,'DD/MM/YYYY HH24:MI:SS') > TO_DATE('17/07/2015', 'DD/MM/YYYY HH24:MI:SS') THEN
            TO_CHAR((select MAX(most.DT_ATUALIZACAO)
                                 from MAN_ORDEM_SERV_TECNICO most
                                where most.NR_SEQ_TIPO = 148 /* 148=Mudança de Histórico*/
                                  and most.NR_SEQ_ORDEM_SERV = REL1.SO_NUMBER),'DD/MM/YYYY HH24:MI:SS')
          WHEN REL1.SO_SLA = 'N' THEN
            '17/07/2015 08:00:00'
        END
        SO_RECLASSIFICATION_TIME
       ,CASE
          WHEN( select count(mosa.NR_SEQUENCIA)
                   from MAN_ORDEM_SERV_ATIV mosa
                  where mosa.NR_SEQ_ORDEM_SERV= REL1.SO_NUMBER
                    and mosa.NR_SEQ_FUNCAO in (select mtf.nr_SEQUENCIA from man_tipo_funcao mtf where mtf.NR_SEQ_GRUPO_TRAB = 1)
                    and trunc(mosa.DT_ATIVIDADE) = dt_atual_w) > 0 THEN
          'S'
        ELSE
          'N'
        END
        SO_WORKED
        ,CASE
          WHEN REL1.SLA_RESOLUTION_BREACHED = 'S' THEN
            'Breached'
          WHEN(REL1.TARGET_RESOLUTION - REL1.SO_RESOLUTION_TIME) <= 390 THEN
            'Critical'
          WHEN(REL1.TARGET_RESOLUTION - REL1.SO_RESOLUTION_TIME) between 390 and 1440 THEN
            'Warning'
          WHEN(REL1.TARGET_RESOLUTION - REL1.SO_RESOLUTION_TIME) > 1440 THEN
            'Good'
          ELSE
            NULL
        END
        STATUS_SLA_RESOLUTION
       ,CASE
          WHEN UPPER(REL1.ACTUAL_STAGE) IN (
              'CLIENTE (TESTE)'
              ,'AGUARDANDO INFORMAÇÕES DO CLIENTE'
              ,'AGUARDANDO INF. DO CLIENTE - SUPORTE'
              ,'CLIENTE (TESTE) - OK'
              ,'TEC AGUARDANDO DEFINIÇÃO CLIENTE'
              ,'DESENV AGUARDANDO CLIENTE'
              ,'AGUARDANDO CONEXÃO') THEN
           'CUSTOMER'
          ELSE
           'PHILIPS'
        END LOCALIZATION
FROM (
        SELECT /*REL.* */
               REL.CUSTOMER
               ,REL.SO_NUMBER
               ,REL.SO_DESCRIPTION
               ,REL.CUSTOMER_CLASSIFICATION
               ,REL.PHILIPS_CLASSIFICATION
               ,REL.CUSTOMER_SEVERITY
               ,REL.PHILIPS_SEVERITY
               ,REL.SO_SLA
               ,REL.DEVELOPMENT_GROUP
               ,REL.DEVELOP_MANAGEMENT_ID
               ,REL.DEVELOP_MANAGEMENT
               ,REL.DEVELOP_MANAGER
               ,REL.SUPPORT_GROUP
               ,REL.SUPPORT_MANAGEMENT
               ,REL.SUPPORT_MANAGER
               ,REL.SLA_ID
               ,REL.SLA_DETAIL
               ,REL.SLA_TARGET
               ,REL.SLA_DESCRIPTION
               ,REL.TARGET_RESPONSE
               ,REL.TARGET_RESOLUTION
               ,REL.SO_OPEN_TIME
               ,REL.SO_OPEN_MONTH_YEAR
               ,REL.SO_CLOSE_TIME
               ,null SO_CLOSE_MONTH_YEAR /* NÃO PEGAR DATA DE ENCERRAMENTO PORQUE A OS AINDA ESTÁ ABERTA*/
               ,REL.RESPONSE_FINISH_IN
               ,CASE WHEN REL.TARGET_RESOLUTION=0 THEN NULL  ELSE CASE                      WHEN REL.IE_TEMPO='COR' THEN                         TO_CHAR(TO_DATE(REL.SO_OPEN_TIME,'DD/MM/YYYY HH24:MI:SS') + (REL.TARGET_RESOLUTION/1440),'DD/MM/YYYY HH24:MI:SS')                      ELSE                         TO_CHAR(man_obter_hor_com(REL.cd_estabelecimento                                                        ,TO_DATE(REL.SO_OPEN_TIME,'DD/MM/YYYY HH24:MI:SS')                                                        ,REL.TARGET_RESOLUTION                                ),'DD/MM/YYYY HH24:MI:SS')                    END END 
                RESOLUTION_FINISH_IN
               ,REL.WORK_START
               ,REL.AGING
               ,CASE WHEN trunc(clock_timestamp())                       =trunc(to_date(dt_atual_w)) THEN REL.ACTUAL_STAGE                         ELSE (  select max(b.ds_estagio)                             from man_ordem_serv_estagio a, man_estagio_processo b                            where a.nr_seq_estagio = b.nr_sequencia                              and a.nr_seq_ordem  = REL.SO_NUMBER                              and a.dt_atualizacao = (select max(c.dt_atualizacao)                                                        from man_ordem_serv_estagio c                                                       where c.nr_seq_ordem = a.nr_seq_ordem                                                         and trunc(c.dt_atualizacao) <= dt_atual_w)) END 
                ACTUAL_STAGE
               ,REL.DOC_DEFECT
               ,REL.LAST_UPDATE_PHILIPS
               ,CASE
                  WHEN trunc(to_date(REL.LAST_UPDATE_PHILIPS,'dd/mm/yyyy hh24:mi:ss')) < trunc(TO_DATE(dt_atual_w)) THEN
                    round(trunc(TO_DATE(dt_atual_w)) - trunc(to_date(REL.LAST_UPDATE_PHILIPS,'dd/mm/yyyy hh24:mi:ss')))
                  ELSE
                    0
                END
                DAYS_WITHOUT_UPDATE_PHILIPS
               ,REL.LAST_UPDATE_CUSTOMER
               ,coalesce(Man_Obter_Min_com(REL.cd_estabelecimento
                                 ,TO_DATE(REL.SO_OPEN_TIME,'DD/MM/YYYY HH24:MI:SS')
                                 ,TO_DATE(REL.WORK_START,'DD/MM/YYYY HH24:MI:SS')
                                 ),0) SO_RESPONSE_TIME
               ,REL.SO_RESOLUTION_TIME
               ,REL.CUSTOMER_TIME
               ,CASE WHEN REL.TARGET_RESOLUTION=0 THEN NULL  ELSE (REL.TARGET_RESOLUTION-REL.SO_RESOLUTION_TIME) END  SLA_RESOLUTION_REMAINING
               ,CASE
                  WHEN(REL.TARGET_RESOLUTION > 0 and (REL.TARGET_RESOLUTION - REL.SO_RESOLUTION_TIME) > 0) THEN
                    'N'
                  WHEN(REL.TARGET_RESOLUTION > 0 and (REL.TARGET_RESOLUTION - REL.SO_RESOLUTION_TIME) <= 0) THEN
                    'S'
                  ELSE
                    NULL
                END SLA_RESOLUTION_BREACHED
               /*obtem se houve encerramento automático pela job de cancelamento quando não já retorno do cliente */

               ,(select a.nr_seq_tipo
                   from (  select most.nr_seq_tipo, most.NR_SEQ_ORDEM_SERV
                             from MAN_ORDEM_SERV_TECNICO most
                            where trunc(most.DT_HISTORICO) < trunc(to_date(dt_atual_w))
                         order by most.dt_atualizacao desc
                        )a
                  where a.NR_SEQ_ORDEM_SERV = REL.SO_NUMBER  LIMIT 1)
                HAS_AUTOMATIC_CLOSE
               ,REL.IE_TEMPO
        FROM (
           select ml.DS_LOCALIZACAO "CUSTOMER"
                  ,CASE
                    WHEN mos.ie_classificacao_cliente ='E'  THEN
                      'Defeito'
                    WHEN mos.ie_classificacao_cliente ='S'  THEN
                      'Solicitação'
                    WHEN mos.ie_classificacao_cliente ='D'  THEN
                      'Dúvida'
                  END
                  CUSTOMER_CLASSIFICATION
                  ,CASE
                    WHEN mos.ie_classificacao ='E'  THEN
                      'Defeito'
                    WHEN mos.ie_classificacao ='S'  THEN
                      'Solicitação'
                    WHEN mos.ie_classificacao ='D'  THEN
                      'Dúvida'
                  END
                  PHILIPS_CLASSIFICATION
                  ,mos.nr_sequencia SO_NUMBER
                  ,mos.ds_dano_breve SO_DESCRIPTION
                  ,mos.ie_prioridade PHILIPS_SEVERITY
                  ,mos.ie_prioridade_cliente CUSTOMER_SEVERITY
                  ,man_obter_se_os_sla(mos.NR_SEQUENCIA) SO_SLA
                  ,gd.DS_GRUPO DEVELOPMENT_GROUP
                  ,gwd.NR_SEQUENCIA "DEVELOP_MANAGEMENT_ID"
                  ,gwd.DS_GERENCIA "DEVELOP_MANAGEMENT"
                  ,obter_nome_pf_pj(gwd.cd_responsavel,null) "DEVELOP_MANAGER"
                  ,gs.DS_GRUPO SUPPORT_GROUP
                  ,gws.DS_GERENCIA "SUPPORT_MANAGEMENT"
                  ,obter_nome_pf_pj(gws.cd_responsavel,null) "SUPPORT_MANAGER"
                  ,ms.NR_SEQUENCIA SLA_ID
                  ,(
                    SELECT CASE
                            /* 1 Contrato com multa*/

                            WHEN(msr1.IE_TIPO_SLA = 1) AND (msr1.IE_TIPO_SLA_TERMINO = 1) THEN
                              'CSFP' /* Customer Start Finish with Penalty'*/
                            /* 1 Contrato com multa*/

                            WHEN (msr1.IE_TIPO_SLA = 1) AND (msr1.IE_TIPO_SLA_TERMINO in (1,3)) THEN
                              'COSP' /* Customer Only Finish with Penalty'*/
                            /* 2 Contrato sem multa*/

                            WHEN(msr1.IE_TIPO_SLA = 2) AND (msr1.IE_TIPO_SLA_TERMINO = 2) THEN
                              'CSFNP' /* Customer Start Finish No Penalty'*/
                            /* 2 Contrato sem multa*/

                            WHEN (msr1.IE_TIPO_SLA = 2) AND (msr1.IE_TIPO_SLA_TERMINO = 3) THEN
                              'COSNP' /* Customer Only Start No Penalty'*/
                            /*  3 Sem Contrato */

                            WHEN(msr1.IE_TIPO_SLA = 3) AND (msr1.IE_TIPO_SLA_TERMINO = 3) THEN
                              'PSFNP' /* Philips Start Finish No Penalty'*/
                           END
                           SLA_DETAIL
                     from MAN_SLA ms1
                          ,MAN_SLA_REGRA msr1
                    where ms1.IE_SITUACAO='A'
                      and ms1.NR_SEQUENCIA = msr1.NR_SEQ_SLA
                      and msr1.IE_PRIORIDADE = msr.IE_PRIORIDADE
                      and ms1.nr_sequencia = ms.nr_sequencia
                   )
                   SLA_DETAIL
                  ,(1- DECODE(ms.PR_DESVIO,0,0,ms.PR_DESVIO/100)) SLA_TARGET
                  ,ms.DS_TITULO SLA_DESCRIPTION
                  ,msr.QT_MIN_INICIO TARGET_RESPONSE
                  ,msr.QT_MIN_TERMINO TARGET_RESOLUTION
                  ,msr.IE_TEMPO
                  ,TO_CHAR(mos.dt_ordem_servico, 'DD/MM/YYYY HH24:MI:SS') SO_OPEN_TIME
                  ,trunc(mos.dt_ordem_servico, 'month') SO_OPEN_MONTH_YEAR
                  ,NULL SO_CLOSE_TIME
                  ,CASE
                     WHEN msr.IE_TEMPO='COR' THEN
                        TO_CHAR(mos.dt_ordem_servico + (msr.QT_MIN_INICIO/1440),'DD/MM/YYYY HH24:MI:SS')
                     /*Tratamento de final de semana porque a função está com problema*/

                     WHEN Obter_Cod_Dia_Semana(mos.dt_ordem_servico) = 1 THEN
                        TO_CHAR(man_obter_hor_com(ml.cd_estabelecimento,trunc(mos.dt_ordem_servico + 1,'dd') + 8/24,msr.QT_MIN_INICIO),'DD/MM/YYYY HH24:MI:SS')
                     WHEN Obter_Cod_Dia_Semana(mos.dt_ordem_servico) = 7 THEN
                        TO_CHAR(man_obter_hor_com(ml.cd_estabelecimento,trunc(mos.dt_ordem_servico + 2,'dd') + 8/24,msr.QT_MIN_INICIO),'DD/MM/YYYY HH24:MI:SS')
                     /*Tratamento de final de semana porque a função está com problema*/

                     ELSE
                        TO_CHAR(man_obter_hor_com(ml.cd_estabelecimento, mos.dt_ordem_servico, msr.QT_MIN_INICIO),'DD/MM/YYYY HH24:MI:SS')
                   END
                   RESPONSE_FINISH_IN
                  ,TO_CHAR(trunc(to_date(dt_atual_w)) - trunc(mos.dt_ordem_servico),'9999') AGING
                  ,(    SELECT TO_CHAR(MOSE.dt_atualizacao,'DD/MM/YYYY HH24:MI:SS') WORK_START
                          FROM man_estagio_processo MEP1
                               ,Man_ordem_serv_estagio MOSE
                         WHERE MOSE.nr_seq_ordem      =  MOS.NR_SEQUENCIA
                           AND MEP1.IE_AGUARDA_CLIENTE='N'
                           AND MEP1.nr_sequencia        = MOSE.nr_seq_estagio
                           AND MOSE.NR_SEQUENCIA = (SELECT Min(MOSE.nr_sequencia)
                                                      FROM Man_ordem_serv_estagio MOSE
                                                     WHERE MOSE.nr_seq_ordem      =  MOS.NR_SEQUENCIA
                            /* desconsidera estágios iniciais da abertura da OS
                              231  Aguardando Triagem
                              1712  Aguardando Triagem (Customização)
                              1051  Desenv aguardando triagem
                              1731  Tec aguardando triagem
                            */
                                                       AND MOSE.nr_seq_estagio NOT IN (231,1712,1051,1731)
                                                    )
                   ) WORK_START
                  ,( select TO_CHAR(max(most.DT_HISTORICO),'DD/MM/YYYY HH24:MI:SS') LAST_UPDATE_PHILIPS
                       from MAN_ORDEM_SERV_TECNICO most
                      where most.NR_SEQ_ORDEM_SERV= MOS.NR_SEQUENCIA
                        and most.NM_USUARIO <> 'WebService') LAST_UPDATE_PHILIPS
                  ,( select TO_CHAR(max(most.DT_HISTORICO),'DD/MM/YYYY HH24:MI:SS') LAST_UPDATE_CUSTOMER
                       from MAN_ORDEM_SERV_TECNICO most
                      where most.NR_SEQ_ORDEM_SERV= MOS.NR_SEQUENCIA
                        and most.NM_USUARIO = 'WebService') LAST_UPDATE_CUSTOMER
                  ,(
                  /*calculo tempo da OS*/

                     select sum(man_obter_tempo_com(
                               ml.cd_estabelecimento
                               ,mose.dt_atualizacao
                               ,nvl((select min(a.dt_atualizacao)
                                       from man_ordem_serv_estagio a
                                      where a.nr_seq_ordem  = mos1.nr_sequencia
                                        and a.dt_atualizacao > mose.dt_atualizacao),decode(dt_atual_w, trunc(sysdate),sysdate, to_date(dt_atual_w ||' 23:59:59','dd/mm/yyyy hh24:mi:ss' )))
                               ,'MC'))QT_MINUTOS_SLA
                       from MAN_SLA ms
                            ,MAN_SLA_REGRA msr
                            ,MAN_SLA_LOC msl
                            ,MAN_LOCALIZACAO ml
                            ,man_ordem_servico mos1
                            ,man_ordem_serv_estagio mose
                            ,man_estagio_processo mep
                      where ms.IE_SITUACAO='A'
                        and trunc(ms.DT_VIGENCIA) <= dt_atual_w
                        and ms.NR_SEQUENCIA = msr.NR_SEQ_SLA
                        and msr.NR_SEQ_SLA = msl.NR_SEQ_SLA
                        and ml.NR_SEQUENCIA = msl.NR_SEQ_LOCAL
                        and msr.IE_PRIORIDADE = mos1.IE_PRIORIDADE_CLIENTE /*FILTRO PRIORIDADE DA OS = PRIORIDADE DO CADASTRO DE SLA*/
                        and mos1.nr_seq_localizacao = ml.nr_sequencia
                        and mos1.nr_sequencia = mose.NR_SEQ_ORDEM
                        and mose.nr_seq_estagio = mep.nr_sequencia
                        and mos1.nr_sequencia = MOS.NR_SEQUENCIA
			and ml.ie_terceiro = 'S'
                        /* Desconsidera os estágios abaixo
                         2 Cliente (Teste)
                         261 Desenv aguardando cliente
                         1341  Aguardando Inf. do Cliente - Suporte
                         1511  Cliente (Teste) - OK
                         1902  Tec aguardando definição cliente
                         511 Encerramento solicitado pelo Cliente
                         9 OK - Cliente - Encerrado
                         121- Aguardando Conexão
                         41 Aguardando Informações do Cliente
                        */
                        and mep.nr_sequencia not in (2,261,1511,1902, 1341,511,9,121,41)
                   )
                   SO_RESOLUTION_TIME
                  ,NVL((SELECT SUM(MAN_OBTER_MIN_COM(1,MOSE1.DT_ATUALIZACAO
                                                  ,(select NVL(min(a.dt_atualizacao),dt_atual_w)
                                                      from man_ordem_serv_estagio a
                                                     where a.nr_seq_ordem = MOSE1.NR_SEQ_ORDEM
                                                       and a.dt_atualizacao > MOSE1.dt_atualizacao)
                                                 )) CUSTOMER_TIME
                      FROM man_estagio_processo MEP2
                           ,Man_ordem_serv_estagio MOSE1
                     WHERE MOSE1.nr_seq_ordem = MOS.NR_SEQUENCIA
                       AND ( MEP2.IE_AGUARDA_CLIENTE='S'
                            OR MEP2.NR_SEQUENCIA IN (1664, 261, 1591)) /*Estagios aguardando cliente no desenvolvimento (não considerado no calculo de sla)*/
                       AND MEP2.nr_sequencia = MOSE1.nr_seq_estagio),0) CUSTOMER_TIME
                  ,ml.cd_estabelecimento
                  ,mep.ds_estagio ACTUAL_STAGE
                  ,(
                      select decode(o1.ie_classificacao
                                     ,'E'
                                     ,(select decode(d.ie_origem_erro,'C','CUSTOMER','PHILIPS')DOC_DEFECT
                                         from man_doc_erro d
                                        where d.NR_SEQ_ORDEM = o1.NR_SEQUENCIA
                                          and d.dt_liberacao is not null
                      and d.nr_sequencia = (select max(x.nr_sequencia) from man_doc_erro x where x.NR_SEQ_ORDEM = o1.NR_SEQUENCIA))
                                     ,null)DOC_DEFECT
                       from man_ordem_servico o1
                      where o1.NR_SEQuencia = mos.NR_SEQUENCIA
                  ) DOC_DEFECT
             from MAN_SLA ms
                  ,MAN_SLA_REGRA msr
                  ,MAN_SLA_LOC msl
                  ,MAN_LOCALIZACAO ml
                  ,man_ordem_servico mos
                  ,grupo_desenvolvimento gd
                  ,grupo_suporte gs
                  ,(select gw.* from gerencia_wheb gw) gwd
                  ,(select gw.* from gerencia_wheb gw) gws
                  ,man_estagio_processo mep
            where ms.IE_SITUACAO='A'
              and trunc(ms.DT_VIGENCIA) <= dt_atual_w
              and ms.NR_SEQUENCIA = msr.NR_SEQ_SLA
              and msr.NR_SEQ_SLA = msl.NR_SEQ_SLA
              and ml.NR_SEQUENCIA = msl.NR_SEQ_LOCAL
              and msr.IE_PRIORIDADE = mos.IE_PRIORIDADE /*FILTRO PRIORIDADE DA OS = PRIORIDADE DO CADASTRO DE SLA*/
              and mos.nr_seq_grupo_des = gd.nr_sequencia
              and gd.nr_seq_gerencia = gwd.nr_sequencia
              and mos.nr_seq_grupo_sup = gs.nr_sequencia (+)
              and gs.nr_seq_gerencia_sup = gws.nr_sequencia (+)
              and mos.nr_seq_estagio = mep.nr_sequencia
              and mos.nr_seq_localizacao = ml.nr_sequencia
              and mos.ie_classificacao_cliente = 'E' /* Só defeito aberto pelo cliente*/
	      and ml.ie_terceiro = 'S'
              /*TRATAR AQUI A QUESTÃO DE OS QUE NÂO ESTAVA ENCERRADA NA DATA QUE ESTÁ SENDO FEITA A EXTRAÇÃO*/

              and ( /*Não encerrados */
                    (mos.nr_seq_estagio <> 9  /*9-OK - Cliente - Encerrado */
                     and mos.ie_status_ordem <> 3  /*3-Encerrado*/
                     and  mos.DT_FIM_REAL is null)  /*Fim não informado*/
                    /* Encerrados posterior à data do parametro */

                    or
                     trunc(mos.DT_FIM_REAL) > trunc(to_date(dt_atual_w))  /*Fim maior que a data do relatorio*/
                    or
                    mos.DT_FIM_REAL is null
                  )
              and trunc(mos.dt_ordem_servico) <= trunc(to_date(dt_atual_w))
        ) REL
    /*WHERE REL.SLA_ID = :P_SLA_ID*/

) REL1
WHERE (REL1.HAS_AUTOMATIC_CLOSE is null or REL1.HAS_AUTOMATIC_CLOSE <> 111) /*nao houve fechamento automático pela job, quando está sem retorno do cliente
                                        and REL1.SO_NUMBER=:SO_NUMBER*/
) REL2
/* ********************************************************************************************************************************************************************************************* */

UNION ALL
/*OSs ENCERRADAS*/

select REL2.*
      ,CASE
        WHEN REL2.SLA_RESPONSE_BREACHED = 'S' THEN
          'Breached'
        WHEN REL2.SLA_RESOLUTION_REMAINING <= 60 THEN
          'Critical'
        WHEN REL2.SLA_RESOLUTION_REMAINING > 60 and REL2.SLA_RESOLUTION_REMAINING <= 480 THEN
          'Warning'
        WHEN REL2.SLA_RESOLUTION_REMAINING > 480 THEN
          'Good'
        ELSE
          NULL
      END
      STATUS_SLA_RESPONSE
from (
SELECT decode(dt_atual_w, trunc(sysdate), to_char(sysdate,'dd/mm/yyyy hh24:mi:ss'), dt_atual_w || ' 23:59:59') EXTRACT_DATE
       ,REL1.*
       ,(REL1.TARGET_RESPONSE - REL1.SO_RESPONSE_TIME) SLA_RESPONSE_REMAINING
       ,CASE
          WHEN (REL1.TARGET_RESPONSE - REL1.SO_RESPONSE_TIME) > 0 THEN
           'N'
          ELSE
           'S'
        END SLA_RESPONSE_BREACHED
       ,CASE
           WHEN TO_DATE(REL1.SO_OPEN_TIME,'DD/MM/YYYY HH24:MI:SS') > TO_DATE('17/07/2015', 'DD/MM/YYYY HH24:MI:SS') THEN
            TO_CHAR((select MAX(most.DT_ATUALIZACAO)
                                 from MAN_ORDEM_SERV_TECNICO most
                                where most.NR_SEQ_TIPO = 148 /* 148=Mudança de Histórico*/
                                  and most.NR_SEQ_ORDEM_SERV = REL1.SO_NUMBER),'DD/MM/YYYY HH24:MI:SS')
          WHEN REL1.SO_SLA = 'N' THEN
            '17/07/2015 08:00:00'
        END
        SO_RECLASSIFICATION_TIME
       ,CASE
          WHEN ( select count(mosa.NR_SEQUENCIA)
                   from MAN_ORDEM_SERV_ATIV mosa
                  where mosa.NR_SEQ_ORDEM_SERV= REL1.SO_NUMBER
                    and mosa.NR_SEQ_FUNCAO in (select mtf.nr_SEQUENCIA from man_tipo_funcao mtf where mtf.NR_SEQ_GRUPO_TRAB = 1)
                    and trunc(mosa.DT_ATIVIDADE) = dt_atual_w) > 0 THEN
          'S'
        ELSE
          'N'
        END
        SO_WORKED
       ,CASE
          WHEN REL1.SLA_RESOLUTION_BREACHED = 'S' THEN
            'Breached'
          WHEN (REL1.TARGET_RESOLUTION - REL1.SO_RESOLUTION_TIME) <= 390 THEN
            'Critical'
          WHEN (REL1.TARGET_RESOLUTION - REL1.SO_RESOLUTION_TIME) between 390 and 1440 THEN
            'Warning'
          WHEN (REL1.TARGET_RESOLUTION - REL1.SO_RESOLUTION_TIME) > 1440 THEN
            'Good'
        END
        STATUS_SLA_RESOLUTION
       ,CASE
          WHEN UPPER(REL1.ACTUAL_STAGE) IN (
              'CLIENTE(TESTE)'
              ,'AGUARDANDO INFORMAÇÕES DO CLIENTE'
              ,'AGUARDANDO INF. DO CLIENTE - SUPORTE'
              ,'CLIENTE(TESTE) - OK'
              ,'TEC AGUARDANDO DEFINIÇÃO CLIENTE'
              ,'DESENV AGUARDANDO CLIENTE'
              ,'AGUARDANDO CONEXÃO') THEN
           'CUSTOMER'
          ELSE
           'PHILIPS'
        END LOCALIZATION
FROM (
        SELECT /*REL.* */
               REL.CUSTOMER
               ,REL.SO_NUMBER
               ,REL.SO_DESCRIPTION
               ,REL.CUSTOMER_CLASSIFICATION
               ,REL.PHILIPS_CLASSIFICATION
               ,REL.CUSTOMER_SEVERITY
               ,REL.PHILIPS_SEVERITY
               ,REL.SO_SLA
               ,REL.DEVELOPMENT_GROUP
               ,REL.DEVELOP_MANAGEMENT_ID
               ,REL.DEVELOP_MANAGEMENT
               ,REL.DEVELOP_MANAGER
               ,REL.SUPPORT_GROUP
               ,REL.SUPPORT_MANAGEMENT
               ,REL.SUPPORT_MANAGER
               ,REL.SLA_ID
               ,REL.SLA_DETAIL
               ,REL.SLA_TARGET
               ,REL.SLA_DESCRIPTION
               ,REL.TARGET_RESPONSE
               ,REL.TARGET_RESOLUTION
               ,REL.SO_OPEN_TIME
               ,REL.SO_OPEN_MONTH_YEAR
               ,to_char(REL.SO_CLOSE_TIME,'dd/mm/yyyy hh24:mi:ss') SO_CLOSE_TIME
               ,trunc(REL.SO_CLOSE_TIME,'month') SO_CLOSE_MONTH_YEAR
               ,REL.RESPONSE_FINISH_IN
               ,DECODE(REL.TARGET_RESOLUTION,0,NULL,
                   CASE
                      WHEN REL.IE_TEMPO='COR' THEN
                         TO_CHAR(TO_DATE(REL.SO_OPEN_TIME,'DD/MM/YYYY HH24:MI:SS') + (REL.TARGET_RESOLUTION/1440),'DD/MM/YYYY HH24:MI:SS')
                      ELSE
                         TO_CHAR(man_obter_hor_com(REL.cd_estabelecimento
                                                        ,TO_DATE(REL.SO_OPEN_TIME,'DD/MM/YYYY HH24:MI:SS')
                                                        ,REL.TARGET_RESOLUTION
                                ),'DD/MM/YYYY HH24:MI:SS')
                    END )
                RESOLUTION_FINISH_IN
               ,REL.WORK_START
               ,REL.AGING
               ,DECODE(trunc(sysdate)
                       ,trunc(to_date(dt_atual_w))
                       ,REL.ACTUAL_STAGE
                       ,(  select max(b.ds_estagio)
                             from man_ordem_serv_estagio a, man_estagio_processo b
                            where a.nr_seq_estagio = b.nr_sequencia
                              and a.nr_seq_ordem  = REL.SO_NUMBER
                              and a.dt_atualizacao = (select max(c.dt_atualizacao)
                                                        from man_ordem_serv_estagio c
                                                       where c.nr_seq_ordem = a.nr_seq_ordem
                                                         and trunc(c.dt_atualizacao) <= dt_atual_w))
                      )
                ACTUAL_STAGE
               ,REL.DOC_DEFECT
               ,REL.LAST_UPDATE_PHILIPS
               ,CASE
                  WHEN trunc(to_date(REL.LAST_UPDATE_PHILIPS,'dd/mm/yyyy hh24:mi:ss')) < trunc(TO_DATE(dt_atual_w)) THEN
                    round(trunc(TO_DATE(dt_atual_w)) - trunc(to_date(REL.LAST_UPDATE_PHILIPS,'dd/mm/yyyy hh24:mi:ss')))
                  ELSE
                    0
                END
                DAYS_WITHOUT_UPDATE_PHILIPS
               ,REL.LAST_UPDATE_CUSTOMER
               ,NVL(Man_Obter_Min_com(REL.cd_estabelecimento
                                 ,TO_DATE(REL.SO_OPEN_TIME,'DD/MM/YYYY HH24:MI:SS')
                                 ,TO_DATE(REL.WORK_START,'DD/MM/YYYY HH24:MI:SS')
                                 ),0) SO_RESPONSE_TIME
               ,REL.SO_RESOLUTION_TIME
               ,REL.CUSTOMER_TIME
               ,DECODE(REL.TARGET_RESOLUTION,0,NULL,(REL.TARGET_RESOLUTION-REL.SO_RESOLUTION_TIME)) SLA_RESOLUTION_REMAINING
               ,CASE
                  WHEN (REL.TARGET_RESOLUTION > 0 and (REL.TARGET_RESOLUTION - REL.SO_RESOLUTION_TIME) > 0) THEN
                    'N'
                  WHEN (REL.TARGET_RESOLUTION > 0 and (REL.TARGET_RESOLUTION - REL.SO_RESOLUTION_TIME) <= 0) THEN
                    'S'
                  ELSE
                    NULL
                END SLA_RESOLUTION_BREACHED
               ,DECODE( REL.TARGET_RESOLUTION,0,NULL,

                        CASE
                          WHEN REL.IE_TEMPO='COR' THEN
                            TO_CHAR(TO_DATE(REL.SO_OPEN_TIME,'DD/MM/YYYY HH24:MI:SS') + (REL.TARGET_RESOLUTION/1440),'DD/MM/YYYY HH24:MI:SS')
                          ELSE
                            (   select to_char(man_obter_hor_com(ml.cd_estabelecimento
                                                                       ,CASE
                                                                          WHEN msr.QT_MIN_TERMINO > REL.SO_RESOLUTION_TIME  THEN
                                                                             max(mose.DT_ATUALIZACAO)
                                                                           ELSE
                                                                             min(mose.DT_ATUALIZACAO)
                                                                          END
                                                                         ,CASE
                                                                            WHEN msr.QT_MIN_TERMINO > REL.SO_RESOLUTION_TIME  THEN
                                                                              (msr.QT_MIN_TERMINO - REL.SO_RESOLUTION_TIME)
                                                                            ELSE
                                                                              msr.QT_MIN_TERMINO
                                                                          END
                                                                         )
                                                  ,'DD/MM/YYYY HH24:MI:SS') SLA_RESOLUTION_BREACHED_IN
                                     from MAN_SLA ms
                                          ,MAN_SLA_REGRA msr
                                          ,MAN_SLA_LOC msl
                                          ,MAN_LOCALIZACAO ml
                                          ,man_ordem_servico mos
                                          ,man_ordem_serv_estagio mose
                                          ,man_estagio_processo mep
                                    where ms.IE_SITUACAO='A'
                                      and trunc(ms.DT_VIGENCIA) <= dt_atual_w
                                      and ms.NR_SEQUENCIA = msr.NR_SEQ_SLA
                                      and msr.NR_SEQ_SLA = msl.NR_SEQ_SLA
                                      and ml.NR_SEQUENCIA = msl.NR_SEQ_LOCAL
                                      and msr.IE_PRIORIDADE = mos.IE_PRIORIDADE /*FILTRO PRIORIDADE DA OS = PRIORIDADE DO CADASTRO DE SLA */
                                      and mos.nr_seq_localizacao = ml.nr_sequencia
                                      and mos.nr_sequencia = mose.NR_SEQ_ORDEM
                                      and mose.nr_seq_estagio = mep.nr_sequencia
                                      and mos.nr_sequencia = REL.SO_NUMBER
				      and ml.ie_terceiro = 'S'
                                      and mep.nr_sequencia not in (2,261,1511,1902, 1341,511,9,121,41)/* 2  Cliente (Teste); 261  Desenv aguardando cliente; 1341 Aguardando Inf. do Cliente - Suporte; 1511  Cliente (Teste) - OK; 1902  Tec aguardando definição cliente; 511 Encerramento solicitado pelo Cliente; 9 OK - Cliente - Encerrado;121 - Aguardando Conexão; 41 Aguardando Informações do Cliente*/
                                 group by msr.QT_MIN_TERMINO,ml.cd_estabelecimento
                                 )
                            END
                   )
                SLA_RESOLUTION_BREACHED_IN
        FROM (
           select ml.DS_LOCALIZACAO "CUSTOMER"
                  ,CASE
                    WHEN mos.ie_classificacao_cliente ='E'  THEN
                      'Defeito'
                    WHEN mos.ie_classificacao_cliente ='S'  THEN
                      'Solicitação'
                    WHEN mos.ie_classificacao_cliente ='D'  THEN
                      'Dúvida'
                  END
                  CUSTOMER_CLASSIFICATION
                  ,CASE
                    WHEN mos.ie_classificacao ='E'  THEN
                      'Defeito'
                    WHEN mos.ie_classificacao ='S'  THEN
                      'Solicitação'
                    WHEN mos.ie_classificacao ='D'  THEN
                      'Dúvida'
                  END
                  PHILIPS_CLASSIFICATION
                  ,mos.nr_sequencia SO_NUMBER
                  ,mos.ds_dano_breve SO_DESCRIPTION
                  ,mos.ie_prioridade PHILIPS_SEVERITY
                  ,mos.ie_prioridade_cliente CUSTOMER_SEVERITY
                  ,man_obter_se_os_sla(mos.NR_SEQUENCIA) SO_SLA
                  ,gd.DS_GRUPO DEVELOPMENT_GROUP
                  ,gwd.NR_SEQUENCIA "DEVELOP_MANAGEMENT_ID"
                  ,gwd.DS_GERENCIA "DEVELOP_MANAGEMENT"
                  ,obter_nome_pf_pj(gwd.cd_responsavel,null) "DEVELOP_MANAGER"
                  ,gs.DS_GRUPO SUPPORT_GROUP
                  ,gws.DS_GERENCIA "SUPPORT_MANAGEMENT"
                  ,obter_nome_pf_pj(gws.cd_responsavel,null) "SUPPORT_MANAGER"
                  ,ms.NR_SEQUENCIA SLA_ID
                  ,(
                    SELECT CASE
                            /* 1 Contrato com multa*/

                            WHEN (msr1.IE_TIPO_SLA = 1) AND (msr1.IE_TIPO_SLA_TERMINO = 1) THEN
                              'CSFP' /* Customer Start Finish with Penalty'*/
                            /* 1 Contrato com multa*/

                            WHEN(msr1.IE_TIPO_SLA = 1) AND (msr1.IE_TIPO_SLA_TERMINO in (1,3)) THEN
                              'COSP' /* Customer Only Finish with Penalty'*/
                            /* 2 Contrato sem multa*/

                            WHEN (msr1.IE_TIPO_SLA = 2) AND (msr1.IE_TIPO_SLA_TERMINO = 2) THEN
                              'CSFNP' /* Customer Start Finish No Penalty'*/
                            /* 2 Contrato sem multa*/

                            WHEN(msr1.IE_TIPO_SLA = 2) AND (msr1.IE_TIPO_SLA_TERMINO = 3) THEN
                              'COSNP' /* Customer Only Start No Penalty'*/
                            /*  3 Sem Contrato*/

                            WHEN (msr1.IE_TIPO_SLA = 3) AND (msr1.IE_TIPO_SLA_TERMINO = 3) THEN
                              'PSFNP' /* Philips Start Finish No Penalty'*/
                           END
                           SLA_DETAIL
                     from MAN_SLA ms1
                          ,MAN_SLA_REGRA msr1
                    where ms1.IE_SITUACAO='A'
                      and ms1.NR_SEQUENCIA = msr1.NR_SEQ_SLA
                      and msr1.IE_PRIORIDADE = msr.IE_PRIORIDADE
                      and ms1.nr_sequencia = ms.nr_sequencia
                   )
                   SLA_DETAIL
                  ,(1- CASE WHEN ms.PR_DESVIO=0 THEN 0  ELSE ms.PR_DESVIO/100 END ) SLA_TARGET
                  ,ms.DS_TITULO SLA_DESCRIPTION
                  ,msr.QT_MIN_INICIO TARGET_RESPONSE
                  ,msr.QT_MIN_TERMINO TARGET_RESOLUTION
                  ,msr.IE_TEMPO
                  ,TO_CHAR(mos.dt_ordem_servico, 'DD/MM/YYYY HH24:MI:SS') SO_OPEN_TIME
                  ,trunc(mos.dt_ordem_servico, 'month') SO_OPEN_MONTH_YEAR
                  ,mos.SO_CLOSE_TIME
                  ,CASE
                     WHEN msr.IE_TEMPO='COR' THEN
                        TO_CHAR(mos.dt_ordem_servico + (msr.QT_MIN_INICIO/1440),'DD/MM/YYYY HH24:MI:SS')
                     /*Tratamento de final de semana porque a função está com problema*/

                     WHEN Obter_Cod_Dia_Semana(mos.dt_ordem_servico) = 1 THEN
                        TO_CHAR(man_obter_hor_com(ml.cd_estabelecimento,trunc(mos.dt_ordem_servico + 1,'dd') + 8/24,msr.QT_MIN_INICIO),'DD/MM/YYYY HH24:MI:SS')
                     WHEN Obter_Cod_Dia_Semana(mos.dt_ordem_servico) = 7 THEN
                        TO_CHAR(man_obter_hor_com(ml.cd_estabelecimento,trunc(mos.dt_ordem_servico + 2,'dd') + 8/24,msr.QT_MIN_INICIO),'DD/MM/YYYY HH24:MI:SS')
                     /*Tratamento de final de semana porque a função está com problema*/

                     ELSE
                        TO_CHAR(man_obter_hor_com(ml.cd_estabelecimento, mos.dt_ordem_servico, msr.QT_MIN_INICIO),'DD/MM/YYYY HH24:MI:SS')
                   END
                   RESPONSE_FINISH_IN
                  ,TO_CHAR(trunc(to_date(dt_atual_w)) - trunc(mos.dt_ordem_servico),'9999') aging
                  ,(    SELECT TO_CHAR(MOSE.dt_atualizacao,'DD/MM/YYYY HH24:MI:SS') WORK_START
                          FROM man_estagio_processo MEP1
                               ,Man_ordem_serv_estagio MOSE
                         WHERE MOSE.nr_seq_ordem      =  MOS.NR_SEQUENCIA
                           AND MEP1.IE_AGUARDA_CLIENTE='N'
                           AND MEP1.nr_sequencia        = MOSE.nr_seq_estagio
                           AND MOSE.NR_SEQUENCIA = (SELECT Min(MOSE.nr_sequencia)
                                                      FROM Man_ordem_serv_estagio MOSE
                                                     WHERE MOSE.nr_seq_ordem      =  MOS.NR_SEQUENCIA
                          /* desconsidera estágios iniciais da abertura da OS
                            231  Aguardando Triagem
                            1712  Aguardando Triagem (Customização)
                            1051  Desenv aguardando triagem
                            1731  Tec aguardando triagem*/
                                                       and MOSE.nr_seq_estagio NOT IN (231,1712,1051,1731)
                                                    )
                   ) WORK_START
                  ,( select TO_CHAR(max(most.DT_HISTORICO),'DD/MM/YYYY HH24:MI:SS') LAST_UPDATE_PHILIPS
                       from MAN_ORDEM_SERV_TECNICO most
                      where most.NR_SEQ_ORDEM_SERV= MOS.NR_SEQUENCIA
                        and most.NM_USUARIO <> 'WebService') LAST_UPDATE_PHILIPS
                  ,( select TO_CHAR(max(most.DT_HISTORICO),'DD/MM/YYYY HH24:MI:SS') LAST_UPDATE_CUSTOMER
                       from MAN_ORDEM_SERV_TECNICO most
                      where most.NR_SEQ_ORDEM_SERV= MOS.NR_SEQUENCIA
                        and most.NM_USUARIO = 'WebService') LAST_UPDATE_CUSTOMER
                  ,(
                     select sum(man_obter_tempo_com(
                               ml.cd_estabelecimento
                               ,mose.dt_atualizacao
                               ,coalesce((select min(a.dt_atualizacao)
                                       from man_ordem_serv_estagio a
                                      where a.nr_seq_ordem  = mos1.nr_sequencia
                                        and a.dt_atualizacao > mose.dt_atualizacao),CASE WHEN dt_atual_w=trunc(clock_timestamp()) THEN clock_timestamp()  ELSE to_date(dt_atual_w ||' 23:59:59','dd/mm/yyyy hh24:mi:ss' ) END )
                               ,'MC'))QT_MINUTOS_SLA
                       from MAN_SLA ms
                            ,MAN_SLA_REGRA msr
                            ,MAN_SLA_LOC msl
                            ,MAN_LOCALIZACAO ml
                            ,man_ordem_servico mos1
                            ,man_ordem_serv_estagio mose
                            ,man_estagio_processo mep
                      where ms.IE_SITUACAO='A'
                          and trunc(ms.DT_VIGENCIA) <= dt_atual_w
                          and ms.NR_SEQUENCIA = msr.NR_SEQ_SLA
                          and msr.NR_SEQ_SLA = msl.NR_SEQ_SLA
                          and ml.NR_SEQUENCIA = msl.NR_SEQ_LOCAL
                          and msr.IE_PRIORIDADE = mos1.IE_PRIORIDADE_CLIENTE /*FILTRO PRIORIDADE DA OS = PRIORIDADE DO CADASTRO DE SLA*/
                          and mos1.nr_seq_localizacao = ml.nr_sequencia
                          and mos1.nr_sequencia = mose.NR_SEQ_ORDEM
                          and mose.nr_seq_estagio = mep.nr_sequencia
                          and mos1.nr_sequencia = MOS.NR_SEQUENCIA
			  and ml.ie_terceiro = 'S'
                          and mep.nr_sequencia not in (2,261,1511,1902, 1341,511,9,121,41) /* 2 Cliente (Teste); 261  Desenv aguardando cliente; 1341 Aguardando Inf. do Cliente - Suporte; 1511  Cliente (Teste) - OK; 1902  Tec aguardando definição cliente; 511 Encerramento solicitado pelo Cliente; 9 OK - Cliente - Encerrado; 121-Aguardando Conexão; 41 Aguardando Informações do Cliente*/
                   )
                   SO_RESOLUTION_TIME
                  ,coalesce((SELECT SUM(MAN_OBTER_MIN_COM(1,MOSE1.DT_ATUALIZACAO
                                                  ,(select coalesce(min(a.dt_atualizacao),dt_atual_w)
                                                      from man_ordem_serv_estagio a
                                                     where a.nr_seq_ordem = MOSE1.NR_SEQ_ORDEM
                                                       and a.dt_atualizacao > MOSE1.dt_atualizacao)
                                                 )) CUSTOMER_TIME
                      FROM man_estagio_processo MEP2
                           ,Man_ordem_serv_estagio MOSE1
                     WHERE MOSE1.nr_seq_ordem = MOS.NR_SEQUENCIA
                       AND ( MEP2.IE_AGUARDA_CLIENTE='S'
                            OR MEP2.NR_SEQUENCIA IN (1664, 261, 1591)) /*Estagios aguardando cliente no desenvolvimento (n¿o considerado no calculo de sla)*/
                       AND MEP2.nr_sequencia = MOSE1.nr_seq_estagio),0)
                   CUSTOMER_TIME
                  ,ml.cd_estabelecimento
                  ,mep.ds_estagio ACTUAL_STAGE
                  ,(
                      select CASE WHEN o1.ie_classificacao                                     ='E' THEN (select CASE WHEN d.ie_origem_erro='C' THEN 'CUSTOMER'  ELSE 'PHILIPS' END DOC_DEFECT                                         from man_doc_erro d                                        where d.NR_SEQ_ORDEM = o1.NR_SEQUENCIA                                          and (d.dt_liberacao IS NOT NULL AND d.dt_liberacao::text <> ''))                                       ELSE null END DOC_DEFECT
                       from man_ordem_servico o1
                      where o1.NR_SEQuencia = mos.NR_SEQUENCIA
                  ) DOC_DEFECT
             FROM man_sla_regra msr, man_sla_loc msl, man_sla ms, man_localizacao ml, man_estagio_processo mep, (select gw.* from gerencia_wheb gw) gwd, grupo_desenvolvimento gd, ( select os.* from (
                      select mos1.*
                            ,CASE WHEN(/*OBTEM DATA SE FOI ENCERRADO PELA JOB DE CANCELAMENTO*/
                                  select trunc(max(most.DT_HISTORICO))                                    from MAN_ORDEM_SERV_TECNICO most                                   where most.NR_SEQ_ORDEM_SERV = mos1.nr_sequencia                                     and trunc(most.DT_HISTORICO) = dt_atual_w                                     and most.NR_SEQ_TIPO = 111                                )                               =trunc(to_date(dt_atual_w)) THEN (/*OBTEM DATA SE FOI ENCERRADO PELA JOB DE CANCELAMENTO*/
                                  select max(most.DT_HISTORICO)                                    from MAN_ORDEM_SERV_TECNICO most                                   where most.NR_SEQ_ORDEM_SERV = mos1.nr_sequencia                                     and trunc(most.DT_HISTORICO) = dt_atual_w                                     and most.NR_SEQ_TIPO = 111                                )                                 ELSE (/*OBTEM DATA SE ENCERRADA PELO CLIENTE*/
                                  select max(mose.DT_ATUALIZACAO)                                    from MAN_ORDEM_SERV_ESTAGIO mose                                   where mose.NR_SEQ_ORDEM = mos1.nr_sequencia                                     and trunc(mose.DT_ATUALIZACAO) = dt_atual_w                                     and mose.NR_SEQ_ESTAGIO=9                                ) END  SO_CLOSE_TIME
                      from man_ordem_servico mos1 )os
                     where TRUNC(os.SO_CLOSE_TIME) = dt_atual_w
                       and os.ie_status_ordem = 3  /*3-Encerrado*/
                   ) mos
LEFT OUTER JOIN grupo_suporte gs ON (mos.nr_seq_grupo_sup = gs.nr_sequencia)
LEFT OUTER JOIN (select gw.* from gerencia_wheb gw) gws ON (gs.nr_seq_gerencia_sup = gws.nr_sequencia)
WHERE ms.IE_SITUACAO='A' and trunc(ms.DT_VIGENCIA) <= dt_atual_w and ms.NR_SEQUENCIA = msr.NR_SEQ_SLA and msr.NR_SEQ_SLA = msl.NR_SEQ_SLA and ml.NR_SEQUENCIA = msl.NR_SEQ_LOCAL and msr.IE_PRIORIDADE = mos.IE_PRIORIDADE /*FILTRO PRIORIDADE DA OS = PRIORIDADE DO CADASTRO DE SLA*/
  and mos.nr_seq_grupo_des = gd.nr_sequencia and gd.nr_seq_gerencia = gwd.nr_sequencia   and mos.nr_seq_estagio  = mep.nr_sequencia and mos.nr_seq_localizacao = ml.nr_sequencia and ml.ie_terceiro = 'S' /* Somente Defeitos abertos pelo cliente que a Philips assumiu como defeito*/

  and mos.ie_classificacao = 'E' and mos.ie_classificacao_cliente = 'E' /*Somente Defeitos abertos pelo cliente que a Philips assumiu como defeito*/

 ) REL
    /*FILTRO CLIENTE ESPECIFICO
    where REL.SLA_ID = :P_SLA_ID*/
) REL1
/*WHERE   REL1.SO_NUMBER=:SO_NUMBER*/

) rel2
) VIEW1
where (/*trazer somente abertos no dia      */
      trunc(to_date(VIEW1.SO_OPEN_TIME,'DD/MM/YYYY hh24:mi:ss')) = dt_atual_w
)
OR ( /*trazer somente sla_resolution "breached" no dia     */
      VIEW1.SO_OPEN_MONTH_YEAR = to_char(trunc(to_date(dt_atual_w,'DD/MM/YYYY hh24:mi:ss'),'MM'))
  and VIEW1.PHILIPS_CLASSIFICATION = 'Defeito'
);

/* End Script de localizacao dos dados*/

	
C02 CURSOR FOR
SELECT (SELECT CASE WHEN DT_ATUAL_DIA_W=TRUNC(clock_timestamp()) THEN  clock_timestamp()  ELSE pkg_date_utils.end_of(DT_ATUAL_DIA_W, ' DAY') END  ) extract_date,
  (SELECT Obter_desc_man_localizacao(so_location) ) customer,
  so_number,
  so_description,
  CASE WHEN customer_classification='T' THEN  NULL  ELSE PERFORM Man_obter_desc_classificacao(customer_classification) END  customer_classification,
  CASE WHEN philips_classification='T' THEN  NULL  ELSE PERFORM Man_obter_desc_classificacao(philips_classification) END  philips_classification,
  customer_severity,
  philips_severity,
  so_sla,
  (SELECT Obter_desc_grupo_desen(development_group_id) ) development_group,
  (SELECT Obter_gerencia_grupo_desen(development_group_id, 'C') ) develop_management_id,
  (SELECT Obter_gerencia_grupo_desen(development_group_id, 'D') ) develop_management ,
  (SELECT Obter_nome_pf_pj(Obter_responsavel_gerencia( Obter_gerencia_grupo_desen( development_group_id , 'C') ), NULL)) develop_manager,
  (SELECT Obter_desc_grupo_suporte(support_group_id) ) support_group,
  (SELECT Obter_gerencia_grupo_sup(support_group_id, 'D') ) support_management ,
  (SELECT Obter_nome_pf_pj(Obter_responsavel_gerencia( Obter_gerencia_grupo_sup( support_group_id, 'C') ), NULL) ) support_manager,
  sla_id,
  'PSOTR' sla_detail,--FIXO
  sla_target,
  sla_description,
  target_response,
  target_resolution,
  so_open_time,
  TRUNC(so_open_time, 'month') so_open_month_year ,
  so_close_time,
  TRUNC(so_close_time, 'month') so_close_month_year,
  response_finish_in,
  resolution_finish_in,
  work_start,
  TO_date(DT_ATUAL_DIA_W) - TRUNC(so_open_time) AGING,
  (SELECT Obter_desc_estagio_proc(actual_stage_id)) actual_stage,
  CASE WHEN customer_classification='E' THEN  CASE WHEN  Man_obter_origem_defeito(so_number)='C' THEN  'CUSTOMER'  ELSE 'PHILIPS' END   ELSE NULL END  doc_defect,
  last_update_philips,
  CASE
    WHEN TRUNC(last_update_philips) < DT_ATUAL_DIA_W
    THEN ROUND(TO_Date(DT_ATUAL_DIA_W)) - TRUNC(last_update_philips)
    ELSE 0  END DAYS_WITHOUT_UPDATE_PHILIPS,
  last_update_customer,
  so_response_time,
  so_resolution_time,
  customer_time,
  sla_resolution_remaining,
  sla_resolution_breached,
  sla_resolution_breached_in,
  sla_response_remaining,
  sla_response_breached,
  so_reclassification_time,
  so_worked,
  status_sla_resolution,
  status_sla_response,
  (select CASE
		--( 'CLIENTE (TESTE)' ,'AGUARDANDO INFORMAÇÕES DO CLIENTE' ,'AGUARDANDO INF. DO CLIENTE - SUPORTE' ,'CLIENTE (TESTE) - OK' ,'TEC AGUARDANDO DEFINIÇÃO CLIENTE' ,'DESENV AGUARDANDO CLIENTE' ,'AGUARDANDO CONEXÃO')
            WHEN actual_stage_id IN (2, 41, 1341, 1511, 1902, 261, 121)THEN 'CUSTOMER'
            ELSE 'PHILIPS' END ) localization
FROM
  (SELECT CASE WHEN sla_resolution_breached='S' THEN  'Breached'  ELSE CASE      WHEN( target_resolution - so_resolution_time ) <= 390 THEN 'Critical'      WHEN( target_resolution - so_resolution_time ) BETWEEN 390 AND 1440 THEN 'Warning'      WHEN( target_resolution - so_resolution_time ) > 1440 THEN 'Good'      ELSE NULL END END  status_sla_resolution,
    CASE WHEN sla_response_breached='S' THEN  'Breached'  ELSE CASE      WHEN sla_resolution_remaining <= 60 THEN 'Critical'      WHEN sla_resolution_remaining > 60 AND sla_resolution_remaining <= 480 THEN 'Warning'      WHEN sla_resolution_remaining > 480 THEN 'Good'      ELSE NULL END END  status_sla_response,
    sel4.*
  FROM
    (SELECT ( target_response - so_response_time ) SLA_RESPONSE_REMAINING,
      CASE
        WHEN( target_response - so_response_time ) > 0 THEN 'N'
        ELSE 'S' END SLA_RESPONSE_BREACHED,
      sel3.*
    FROM
      (SELECT coalesce(Man_obter_min_com(so_establishment, so_open_time, work_start ), 0) so_response_time,
        CASE WHEN target_resolution=0 THEN  NULL  ELSE ( target_resolution - so_resolution_time ) END  sla_resolution_remaining,
        CASE
          WHEN( target_resolution > 0 AND ( target_resolution - so_resolution_time ) > 0 ) THEN 'N'
          WHEN( target_resolution > 0 AND ( target_resolution - so_resolution_time ) <= 0 ) THEN 'S'
          ELSE NULL END sla_resolution_breached,
        CASE WHEN target_resolution=0 THEN  NULL  ELSE CASE          WHEN ie_tempo = 'COR'          THEN To_date(so_open_time, 'DD/MM/YYYY HH24:MI:SS') + ( target_resolution / 1440 )          ELSE (SELECT Man_obter_hor_com(so_establishment ,              CASE                WHEN msr.qt_min_termino > so_resolution_time                THEN MAX(mose.dt_atualizacao)                ELSE MIN(mose.dt_atualizacao)              END,              CASE                WHEN msr.qt_min_termino > so_resolution_time                THEN ( msr.qt_min_termino - so_resolution_time )                ELSE msr.qt_min_termino              END) SLA_RESOLUTION_BREACHED_IN            FROM man_sla ms,              man_sla_regra msr,                            man_ordem_servico mos,              man_ordem_serv_estagio mose            WHERE ms.ie_situacao       = 'A'            AND TRUNC(ms.dt_vigencia) <= DT_ATUAL_DIA_W            AND ms.nr_sequencia        = msr.nr_seq_sla                        AND msr.ie_prioridade      = mos.ie_prioridade            and ms.nr_sequencia = 239              /*FILTRO PRIORIDADE DA OS = PRIORIDADE DO CADASTRO DE SLA */
                        AND mos.nr_sequencia         = mose.nr_seq_ordem            AND mos.nr_sequencia         = so_number                        AND mose.nr_seq_estagio NOT IN ( 2, 261 , 1511, 1902, 1341, 511, 9, 121, 41 )              /* 2  Cliente (Teste); 261  Desenv aguardando cliente; 1341 Aguardando Inf. do Cliente - Suporte; 1511  Cliente (Teste) - OK; 1902  Tec aguardando definição cliente; 511 Encerramento solicitado pelo Cliente; 9 OK - Cliente - Encerrado;121 - Aguardando Conexão; 41 Aguardando Informações do Cliente*/

            GROUP BY msr.qt_min_termino,              so_establishment            )        END END  SLA_RESOLUTION_BREACHED_IN,
        sel2.*
      FROM
        (SELECT sel1.*,
          CASE WHEN ie_tempo='COR' THEN  so_open_time + ( target_response / 1400 )  ELSE Man_obter_hor_com( so_establishment, TRUNC(so_open_time, 'dd' ) + 8 / 24, target_response ) END  RESPONSE_FINISH_IN,
          CASE WHEN ie_tempo='COR' THEN  so_open_time + ( target_resolution / 1400 )  ELSE Man_obter_hor_com( so_establishment, TRUNC(so_open_time, 'dd' ) + 8 / 24, target_resolution ) END  resolution_finish_in,
          (SELECT MOSE.dt_atualizacao
          FROM man_estagio_processo MEP1,
            man_ordem_serv_estagio MOSE
          WHERE MOSE.nr_seq_ordem     = so_number
          AND MEP1.ie_aguarda_cliente = 'N'
          AND MEP1.nr_sequencia       = MOSE.nr_seq_estagio
          AND MOSE.nr_sequencia       =
            (SELECT MIN(MOSE.nr_sequencia)
            FROM man_ordem_serv_estagio MOSE
            WHERE MOSE.nr_seq_ordem = so_number
              /* desconsidera estágios iniciais da abertura da OS
              231  Aguardando Triagem
              1712  Aguardando Triagem (Customização)
              1051  Desenv aguardando triagem
              1731  Tec aguardando triagem
              */
            AND MOSE.nr_seq_estagio NOT IN ( 231, 1712, 1051, 1731 )
            )
          ) WORK_START,
          (SELECT MAX(most.dt_historico)
          FROM man_ordem_serv_tecnico most
          WHERE most.nr_seq_ordem_serv = so_number
          AND most.nm_usuario         <> 'WebService'
          ) LAST_UPDATE_PHILIPS,
          (SELECT MAX(most.dt_historico)
          FROM man_ordem_serv_tecnico most
          WHERE most.nr_seq_ordem_serv = so_number
          AND most.nm_usuario          = 'WebService'
          ) LAST_UPDATE_CUSTOMER,
          (SELECT SUM(Man_obter_tempo_com( so_establishment, mose.dt_atualizacao, coalesce(
            (SELECT MIN(a.dt_atualizacao)
            FROM man_ordem_serv_estagio a
            WHERE a.nr_seq_ordem = mos1.nr_sequencia
            AND a.dt_atualizacao > mose.dt_atualizacao
            ), CASE WHEN DT_ATUAL_DIA_W=TRUNC( clock_timestamp()) THEN  clock_timestamp()  ELSE pkg_date_utils.end_of(DT_ATUAL_DIA_W,'DAY') END ), 'MC')) QT_MINUTOS_SLA
          FROM man_ordem_servico mos1,
            man_ordem_serv_estagio mose          
                   
          where mos1.nr_sequencia        = mose.nr_seq_ordem
          AND mos1.nr_sequencia        = so_number          
          AND mose.nr_seq_estagio NOT IN ( 2, 261, 1511, 1902, 1341, 511, 9, 121, 41 )
            /* 2 Cliente (Teste); 261  Desenv aguardando cliente; 1341 Aguardando Inf. do Cliente - Suporte; 1511  Cliente (Teste) - OK; 1902  Tec aguardando definição cliente; 511 Encerramento solicitado pelo Cliente; 9 OK - Cliente - Encerrado; 121-Aguardando Conexão; 41 Aguardando Informações do Cliente*/

          ) SO_RESOLUTION_TIME,
          coalesce(
          (SELECT SUM(Man_obter_min_com(1, MOSE1.dt_atualizacao,
            (SELECT coalesce(MIN(a.dt_atualizacao), DT_ATUAL_DIA_W)
            FROM man_ordem_serv_estagio a
            WHERE a.nr_seq_ordem = MOSE1.nr_seq_ordem
            AND a.dt_atualizacao > MOSE1.dt_atualizacao
            ))) CUSTOMER_TIME
          FROM man_estagio_processo MEP2,
            man_ordem_serv_estagio MOSE1
          WHERE MOSE1.nr_seq_ordem      = so_number
          AND ( MEP2.ie_aguarda_cliente = 'S'
          OR MEP2.nr_sequencia         IN ( 1664, 261, 1591 ) )
            /*Estagios aguardando cliente no desenvolvimento (não considerado no calculo de sla)*/

          AND MEP2.nr_sequencia = MOSE1.nr_seq_estagio
          ), 0) CUSTOMER_TIME,
          CASE
            WHEN so_open_time > To_date('17/07/2015', 'DD/MM/YYYY HH24:MI:SS')
            THEN (SELECT MAX(most.dt_atualizacao)
              FROM man_ordem_serv_tecnico most
              WHERE most.nr_seq_tipo = 148
                /* 148=Mudança de Histórico*/

              AND most.nr_seq_ordem_serv = so_number
              )
            WHEN so_sla = 'N'
            THEN To_date('17/07/2015 08:00:00', 'DD/MM/YYYY HH24:MI:SS')
          END SO_RECLASSIFICATION_TIME,
          CASE
            WHEN(SELECT COUNT(mosa.nr_sequencia)
              FROM man_ordem_serv_ativ mosa
              WHERE mosa.nr_seq_ordem_serv = so_number
              AND mosa.nr_seq_funcao      IN (SELECT mtf.nr_sequencia
                FROM man_tipo_funcao mtf
                WHERE mtf.nr_seq_grupo_trab = 1
                )
              AND TRUNC(mosa.dt_atividade) = DT_ATUAL_DIA_W) > 0
            THEN 'S'
            ELSE 'N'
          END SO_WORKED
        FROM
          (SELECT mosx.nr_sequencia SO_NUMBER,
            mosx.dt_ordem_servico so_open_time,
            mosx.nr_seq_grupo_des development_group_id,
            mosx.nr_seq_grupo_sup support_group_id,
            mosx.ie_classificacao_cliente customer_classification,
            mosx.ie_classificacao philips_classification,
            mosx.nr_seq_estagio actual_stage_id,
            mosx.nr_seq_localizacao SO_location,
            mosx.ds_dano_breve so_description,
            mosx.nr_seq_severidade customer_severity,
            mosx.nr_seq_severidade_wheb philips_severity,
            NULL SO_CLOSE_TIME,
            msx.nr_sequencia sla_id,
            msx.pr_desvio sla_target,
            msx.ds_titulo sla_description,
            msrx.qt_min_inicio target_response,
            msrx.qt_min_termino target_resolution,
            msrx.ie_tempo ie_tempo,
            mlx.cd_estabelecimento so_establishment,
            'N' so_sla
          FROM man_sla msx,
            man_sla_regra msrx,
            man_ordem_servico mosx,
            man_localizacao mlx
          WHERE mosx.ie_prioridade    = msrx.ie_prioridade
          AND msx.nr_sequencia        = msrx.nr_seq_sla
          AND mosx.nr_seq_localizacao = mlx.nr_sequencia
            --Retrições para não pegar OSs que caiam na regras de sla com localização--
          AND msx.nr_sequencia = 239
            --FIXO para evitar problemas
          AND NOT EXISTS (SELECT 1 FROM man_sla_loc msxl WHERE msxl.nr_seq_sla = msx.nr_sequencia
            )
          AND mosx.nr_sequencia NOT IN
            (SELECT mos.nr_sequencia
            FROM man_sla ms,
              man_sla_regra msr,
              man_sla_loc msl,
              man_localizacao ml,
              man_ordem_servico mos
            WHERE ms.ie_situacao       = 'A'
            AND TRUNC(ms.dt_vigencia) <= DT_ATUAL_DIA_W
            AND ms.nr_sequencia        = msr.nr_seq_sla
            AND msr.nr_seq_sla         = msl.nr_seq_sla
            AND ml.nr_sequencia        = msl.nr_seq_local
            AND msr.ie_prioridade      = mos.ie_prioridade
              /*FILTRO PRIORIDADE DA OS = PRIORIDADE DO CADASTRO DE SLA*/

            AND mos.nr_seq_localizacao       = ml.nr_sequencia
            AND mos.ie_classificacao_cliente = 'E'
              /* Só defeito aberto pelo cliente*/

            AND ml.ie_terceiro = 'S'
              /*TRATAR AQUI A QUESTÃO DE OS QUE NÂO ESTAVA ENCERRADA NA DATA QUE ESTÁ SENDO FEITA A EXTRAÇÃO*/

            AND (
              /*Não encerrados */

              ( mos.nr_seq_estagio <> 9
              /*9-OK - Cliente - Encerrado */

            AND mos.ie_status_ordem <> 3
              /*3-Encerrado*/

            AND coalesce(mos.dt_fim_real::text, '') = '' )
              /*Fim não informado*/

              /* Encerrados posterior à data do parametro */

            OR TRUNC(mos.dt_fim_real) > DT_ATUAL_DIA_W
              /*Fim maior que a data do relatorio*/

            OR coalesce(mos.dt_fim_real::text, '') = '' )
            AND TRUNC(mos.dt_ordem_servico) <= DT_ATUAL_DIA_W
            )
            --Restrições das ordem de serviço e sla--
          AND TRUNC(msx.dt_vigencia)       <= DT_ATUAL_DIA_W
          AND msx.ie_situacao               = 'A'
          AND mosx.ie_classificacao_cliente = 'E'
          AND TRUNC(mosx.dt_ordem_servico) <= DT_ATUAL_DIA_W
          
UNION

          SELECT mosx.nr_sequencia SO_NUMBER,
            mosx.dt_ordem_servico so_open_time,
            mosx.nr_seq_grupo_des development_group_id,
            mosx.nr_seq_grupo_sup support_group_id,
            mosx.ie_classificacao_cliente customer_classification,
            mosx.ie_classificacao philips_classification,
            mosx.nr_seq_estagio actual_stage_id,
            mosx.nr_seq_localizacao SO_location,
            mosx.ds_dano_breve so_description,
            mosx.nr_seq_severidade customer_severity,
            mosx.nr_seq_severidade_wheb philips_severity,
            mosx.so_close_time SO_CLOSE_TIME,
            msx.nr_sequencia sla_id,
            msx.pr_desvio sla_target,
            msx.ds_titulo sla_description,
            msrx.qt_min_inicio target_response,
            msrx.qt_min_termino target_resolution,
            msrx.ie_tempo ie_tempo,
            mlx.cd_estabelecimento so_establishment,
            'N' so_sla
          FROM man_sla msx,
            man_sla_regra msrx,
            (SELECT os.*
            FROM (SELECT mos1.*,
                CASE WHEN(                /*OBTEM DATA SE FOI ENCERRADO PELA JOB DE CANCELAMENTO*/

                SELECT TRUNC(MAX(most.dt_historico)) FROM man_ordem_serv_tecnico most WHERE most.nr_seq_ordem_serv = mos1.nr_sequencia                AND TRUNC(most.dt_historico)                                                                       = DT_ATUAL_DIA_W                AND most.nr_seq_tipo                                                                               = 111                )=DT_ATUAL_DIA_W THEN (                /*OBTEM DATA SE FOI ENCERRADO PELA JOB DE CANCELAMENTO*/

                SELECT MAX(most.dt_historico)                FROM man_ordem_serv_tecnico most                WHERE most.nr_seq_ordem_serv = mos1.nr_sequencia                AND TRUNC(most.dt_historico) = DT_ATUAL_DIA_W                AND most.nr_seq_tipo         = 111                )  ELSE (                /*OBTEM DATA SE ENCERRADA PELO CLIENTE*/

                SELECT MAX(mose.dt_atualizacao)                FROM man_ordem_serv_estagio mose                WHERE mose.nr_seq_ordem        = mos1.nr_sequencia                AND TRUNC(mose.dt_atualizacao) = DT_ATUAL_DIA_W                AND mose.nr_seq_estagio        = 9                ) END  SO_CLOSE_TIME
              FROM man_ordem_servico mos1
              )os
            WHERE TRUNC(os.so_close_time) = DT_ATUAL_DIA_W
            AND os.ie_status_ordem        = 3
              /*3-Encerrado*/

            ) mosx,
            man_localizacao mlx
          WHERE mosx.ie_prioridade    = msrx.ie_prioridade
          AND msx.nr_sequencia        = msrx.nr_seq_sla
          AND mosx.nr_seq_localizacao = msx.nr_sequencia
          AND mosx.nr_seq_localizacao = mlx.nr_sequencia
            --Retrições para não pegar OSs que caiam na regras de sla com localização--
          AND msx.nr_sequencia = 239
            --FIXO para evitar problemas
          AND NOT EXISTS (SELECT 1 FROM man_sla_loc msxl WHERE msxl.nr_seq_sla = msx.nr_sequencia
            )
          AND mosx. nr_sequencia NOT IN
            (SELECT mos.nr_sequencia
            FROM man_sla ms,
              man_sla_regra msr,
              man_sla_loc msl,
              man_localizacao ml,
              (SELECT os.*
              FROM (SELECT mos1.*,
                  CASE WHEN(                  /*OBTEM DATA SE FOI ENCERRADO PELA JOB DE CANCELAMENTO*/

                  SELECT TRUNC(MAX(most.dt_historico)) FROM man_ordem_serv_tecnico most WHERE most.nr_seq_ordem_serv = mos1.nr_sequencia                  AND TRUNC(most.dt_historico)                                                                       = DT_ATUAL_DIA_W                  AND most.nr_seq_tipo                                                                               = 111                  )=DT_ATUAL_DIA_W THEN (                  /*OBTEM DATA SE FOI ENCERRADO PELA JOB DE CANCELAMENTO*/

                  SELECT MAX(most.dt_historico)                  FROM man_ordem_serv_tecnico most                  WHERE most.nr_seq_ordem_serv = mos1.nr_sequencia                  AND TRUNC(most.dt_historico) = DT_ATUAL_DIA_W                  AND most.nr_seq_tipo         = 111                  )  ELSE (                  /*OBTEM DATA SE ENCERRADA PELO CLIENTE*/

                  SELECT MAX(mose.dt_atualizacao)                  FROM man_ordem_serv_estagio mose                  WHERE mose.nr_seq_ordem        = mos1.nr_sequencia                  AND TRUNC(mose.dt_atualizacao) = DT_ATUAL_DIA_W                  AND mose.nr_seq_estagio        = 9                  ) END  SO_CLOSE_TIME
                FROM man_ordem_servico mos1
                )os
              WHERE TRUNC(os.so_close_time) = DT_ATUAL_DIA_W
              AND os.ie_status_ordem        = 3
                /*3-Encerrado*/

              ) mos,
              man_estagio_processo mep
            WHERE ms.ie_situacao       = 'A'
            AND TRUNC(ms.dt_vigencia) <= DT_ATUAL_DIA_W
            AND ms.nr_sequencia        = msr.nr_seq_sla
            AND msr.nr_seq_sla         = msl.nr_seq_sla
            AND ml.nr_sequencia        = msl.nr_seq_local
            AND msr.ie_prioridade      = mos.ie_prioridade
              /*FILTRO PRIORIDADE DA OS = PRIORIDADE DO CADASTRO DE SLA*/

            AND mos.nr_seq_estagio     = mep.nr_sequencia
            AND mos.nr_seq_localizacao = ml.nr_sequencia
            AND ml.ie_terceiro         = 'S'
              /* Somente Defeitos abertos pelo cliente que a Philips assumiu como defeito*/

            AND mos.ie_classificacao         = 'E'
            AND mos.ie_classificacao_cliente = 'E'
              /*Somente Defeitos abertos pelo cliente que a Philips assumiu como defeito*/

            )
            --Restrições das ordem de serviço e sla--
          AND msx.ie_situacao               = 'A'
          AND mosx.ie_classificacao         = 'E'
          AND mosx.ie_classificacao_cliente = 'E'
          )sel1
        ) sel2
      )sel3
    )sel4
  )Sel
  WHERE (
      /*trazer somente abertos no dia      */

      TRUNC(Sel.SO_OPEN_TIME) = dt_atual_dia_w )
    OR (
      /*trazer somente sla_resolution "breached" no dia     */

      trunc(Sel.SO_OPEN_TIME, 'MM')       = dt_atual_mes_w
    AND Sel.PHILIPS_CLASSIFICATION in ('Defeito', 'E'));
	

BEGIN
    BEGIN
      dt_atual_w := dt_inicio_p;
	  dt_atual_dia_w := to_date(dt_atual_w, 'DD/MM/yyyy');
	  dt_atual_mes_w := trunc(dt_atual_dia_w, 'MONTH');
      SELECT coalesce(to_date(dt_fim_p),clock_timestamp()) - coalesce(to_date(dt_inicio_p),clock_timestamp())
      INTO STRICT dt_dias_total_w
;
	  	
      qt_dia_atual_w        := 0;
      WHILE(qt_dia_atual_w <= dt_dias_total_w)
      LOOP
        BEGIN
          for rs_w in C01 loop
            BEGIN
              SELECT COUNT(so_number)
              INTO STRICT qt_registros
              FROM sla_informations
              WHERE so_number  = rs_w.so_number;
              IF (qt_registros > 0) THEN
                BEGIN
                  DELETE FROM sla_informations WHERE so_number = rs_w.so_number;
                  COMMIT;
                END;
              END IF;
                  INSERT
                  INTO sla_informations(
                      nr_sequencia,
                      extract_date,
                      customer,
                      so_number,
                      so_description,
                      customer_classification,
                      philips_classification,
                      customer_severity,
                      philips_severity,
                      so_sla,
                      develop_group,
                      develop_management_id,
                      develop_management,
                      develop_manager,
                      support_group,
                      support_management,
                      support_manager,
                      sla_id,
                      sla_detail,
                      sla_target,
                      sla_description,
                      target_response,
                      target_resolution,
                      so_open_time,
                      so_open_month_year,
                      so_close_time,
                      so_close_month_year,
                      response_finish_in,
                      resolution_finish_in,
                      work_start,
                      aging,
                      actual_stage,
                      doc_defect,
                      last_update_philips,
                      days_without_update_philips,
                      last_update_customer,
                      so_response_time,
                      so_resolution_time,
                      customer_time,
                      sla_resolution_remaining,
                      sla_resolution_breached,
                      sla_resolution_breached_in,
                      sla_response_remaining,
                      sla_response_breached,
                      so_reclassification_time,
                      so_worked,
                      status_sla_resolution,
                      localization,
                      status_sla_response
                    )
                    VALUES (
                      nextval('sla_informations_seq'),
                      rs_w.extract_date,
                      rs_w.customer,
                      rs_w.so_number,
                      rs_w.so_description,
                      rs_w.customer_classification,
                      rs_w.philips_classification,
                      rs_w.customer_severity,
                      rs_w.philips_severity,
                      rs_w.so_sla,
                      rs_w.development_group,
                      rs_w.develop_management_id,
                      rs_w.develop_management,
                      rs_w.develop_manager,
                      rs_w.support_group,
                      rs_w.support_management,
                      rs_w.support_manager,
                      rs_w.sla_id,
                      rs_w.sla_detail,
                      rs_w.sla_target,
                      rs_w.sla_description,
                      rs_w.target_response,
                      rs_w.target_resolution,
                      rs_w.so_open_time,
                      rs_w.so_open_month_year,
                      rs_w.so_close_time,
                      rs_w.so_close_month_year,
                      rs_w.response_finish_in,
                      rs_w.resolution_finish_in,
                      rs_w.work_start,
                      rs_w.aging,
                      rs_w.actual_stage,
                      rs_w.doc_defect,
                      rs_w.last_update_philips,
                      rs_w.days_without_update_philips,
                      rs_w.last_update_customer,
                      rs_w.so_response_time,
                      rs_w.so_resolution_time,
                      rs_w.customer_time,
                      rs_w.sla_resolution_remaining,
                      rs_w.sla_resolution_breached,
                      rs_w.sla_resolution_breached_in,
                      rs_w.sla_response_remaining,
                      rs_w.sla_response_breached,
                      rs_w.so_reclassification_time,
                      rs_w.so_worked,
                      rs_w.status_sla_resolution,
                      rs_w.localization,
                      rs_w.status_sla_response
                    );
                  COMMIT;
            END;
          END LOOP;
						
			for rs_w in C02 loop                      
            BEGIN
              SELECT COUNT(so_number)
              INTO STRICT qt_registros
              FROM sla_informations
              WHERE so_number  = rs_w.so_number;
              IF (qt_registros > 0) THEN
                BEGIN
                  DELETE FROM sla_informations WHERE so_number = rs_w.so_number;
                  COMMIT;
                END;
              END IF;
                  INSERT
                  INTO sla_informations(
                      nr_sequencia,
                      extract_date,
                      customer,
                      so_number,
                      so_description,
                      customer_classification,
                      philips_classification,
                      customer_severity,
                      philips_severity,
                      so_sla,
                      develop_group,
                      develop_management_id,
                      develop_management,
                      develop_manager,
                      support_group,
                      support_management,
                      support_manager,
                      sla_id,
                      sla_detail,
                      sla_target,
                      sla_description,
                      target_response,
                      target_resolution,
                      so_open_time,
                      so_open_month_year,
                      so_close_time,
                      so_close_month_year,
                      response_finish_in,
                      resolution_finish_in,
                      work_start,
                      aging,
                      actual_stage,
                      doc_defect,
                      last_update_philips,
                      days_without_update_philips,
                      last_update_customer,
                      so_response_time,
                      so_resolution_time,
                      customer_time,
                      sla_resolution_remaining,
                      sla_resolution_breached,
                      sla_resolution_breached_in,
                      sla_response_remaining,
                      sla_response_breached,
                      so_reclassification_time,
                      so_worked,
                      status_sla_resolution,
                      localization,
                      status_sla_response
                    )
                    VALUES (
                      nextval('sla_informations_seq'),
                      rs_w.extract_date,
                      rs_w.customer,
                      rs_w.so_number,
                      rs_w.so_description,
                      rs_w.customer_classification,
                      rs_w.philips_classification,
                      rs_w.customer_severity,
                      rs_w.philips_severity,
                      rs_w.so_sla,
                      rs_w.development_group,
                      rs_w.develop_management_id,
                      rs_w.develop_management,
                      rs_w.develop_manager,
                      rs_w.support_group,
                      rs_w.support_management,
                      rs_w.support_manager,
                      rs_w.sla_id,
                      rs_w.sla_detail,
                      rs_w.sla_target,
                      rs_w.sla_description,
                      rs_w.target_response,
                      rs_w.target_resolution,
                      rs_w.so_open_time,
                      rs_w.so_open_month_year,
                      rs_w.so_close_time,
                      rs_w.so_close_month_year,
                      rs_w.response_finish_in,
                      rs_w.resolution_finish_in,
                      rs_w.work_start,
                      rs_w.aging,
                      rs_w.actual_stage,
                      rs_w.doc_defect,
                      rs_w.last_update_philips,
                      rs_w.days_without_update_philips,
                      rs_w.last_update_customer,
                      rs_w.so_response_time,
                      rs_w.so_resolution_time,
                      rs_w.customer_time,
                      rs_w.sla_resolution_remaining,
                      rs_w.sla_resolution_breached,
                      rs_w.sla_resolution_breached_in,
                      rs_w.sla_response_remaining,
                      rs_w.sla_response_breached,
                      rs_w.so_reclassification_time,
                      rs_w.so_worked,
                      rs_w.status_sla_resolution,
                      rs_w.localization,
                      rs_w.status_sla_response
                    );
                  COMMIT;
            END;
          END LOOP;
		  
          qt_dia_atual_w := qt_dia_atual_w +1;
		
          dt_atual_w     := TO_CHAR((to_date(dt_atual_w,'DD/MM/rrrr') + 1),'DD/MM/rrrr');
		  dt_atual_dia_w := to_date(dt_atual_w, 'DD/MM/yyyy');
		  dt_atual_mes_w := trunc(dt_atual_dia_w, 'MONTH');
        END;
      END LOOP;
    END;
    COMMIT;
  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE generate_sla_informations ( dt_inicio_p text, dt_fim_p text ) FROM PUBLIC;

