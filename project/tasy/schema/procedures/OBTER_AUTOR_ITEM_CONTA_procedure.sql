-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_autor_item_conta (nr_seq_propaci_p bigint, nr_seq_matpaci_p bigint, nr_sequencia_autor_p INOUT bigint, nr_seq_proc_autor_p INOUT bigint, nr_seq_mat_autor_p INOUT bigint, cd_autorizacao_p INOUT text, cd_senha_p INOUT text, ie_autorizado_p INOUT text, ie_doc_autorizacao_p text default null, ie_autor_qtde_p text default 'N') AS $body$
DECLARE


nr_sequencia_autor_w		bigint	:= null;
cd_autorizacao_w		varchar(20)	:= null;
cd_senha_w			varchar(20)	:= null;
nr_seq_estagio_w		bigint	:= null;
ie_autorizado_w			varchar(1)	:= null;
nr_seq_proc_autor_w		bigint	:= null;
nr_seq_mat_autor_w		bigint	:= null;
nr_cirurgia_w			bigint	:= null;
nr_interno_conta_w		bigint	:= null;
cd_mat_conta_w			bigint	:= null;
nr_prescricao_w			bigint	:= null;
nr_sequencia_prescricao_w	bigint	:= null;
cd_material_kit_w		bigint	:= null;
ie_doc_autorizacao_w		varchar(10);


C01 CURSOR FOR
SELECT  x.ie_prioridade, x.nr_seq_proced, x.nr_sequencia_autor, x.nr_seq_proc_conta, x.cd_senha, x.cd_autorizacao, x.cd_senha_item, x.cd_autorizacao_item,x.nr_prescricao
	from	(SELECT	d.nr_sequencia nr_seq_proced,
			c.nr_sequencia nr_sequencia_autor,
			1 ie_prioridade, /*Para os casos onde a prescr e seq sao iguais na conta e autorizacao*/
			b.nr_sequencia nr_seq_proc_conta,
			coalesce(c.cd_senha,	'0') cd_senha,
			coalesce(c.cd_autorizacao, '0') cd_autorizacao,
			b.cd_senha cd_senha_item,
			b.nr_doc_convenio cd_autorizacao_item,
			b.nr_prescricao,
			c.nr_seq_autorizacao
		from	procedimento_autorizado d,
			procedimento_paciente b,
			autorizacao_convenio c,
			estagio_autorizacao e
		where	b.cd_procedimento		= d.cd_procedimento
		and	b.ie_origem_proced		= d.ie_origem_proced
		and	coalesce(d.nr_seq_proc_interno,0)	= coalesce(b.nr_seq_proc_interno,0)
		and	b.nr_prescricao			= d.nr_prescricao
		and	b.nr_sequencia_prescricao 	= d.nr_seq_prescricao
		and	c.nr_sequencia			= d.nr_sequencia_autor
		and	e.nr_sequencia			= c.nr_seq_estagio
		and	b.nr_sequencia			= nr_seq_propaci_p
		and	b.dt_procedimento	between coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(c.dt_inicio_vigencia),b.dt_procedimento) and coalesce(c.dt_fim_vigencia,b.dt_procedimento)
		and	e.ie_interno not in ('70','90')
		and 	((ie_autor_qtde_p = 'N') or (coalesce(d.qt_autorizada,0) > 0))
		
union

		select	d.nr_sequencia nr_seq_proced,
			c.nr_sequencia nr_sequencia_autor,
			2 ie_prioridade, /*Para os casos onde a prescr ao iguais na conta e autorizacao, porem sem seq prescricao em ambas*/
			b.nr_sequencia nr_seq_proc_conta,
			coalesce(c.cd_senha,	'0') cd_senha,
			coalesce(c.cd_autorizacao, '0') cd_autorizacao,
			b.cd_senha cd_senha_item, 
			b.nr_doc_convenio cd_autorizacao_item,
			coalesce(b.nr_prescricao,0) nr_prescricao,
			c.nr_seq_autorizacao
		from	procedimento_autorizado d, 
			procedimento_paciente b,
			autorizacao_convenio c,
			estagio_autorizacao e
		where	b.cd_procedimento		= d.cd_procedimento
		and	b.ie_origem_proced		= d.ie_origem_proced
		and	coalesce(d.nr_seq_proc_interno,0)	= coalesce(b.nr_seq_proc_interno,0)
		and	b.nr_prescricao			= d.nr_prescricao
		and	coalesce(b.nr_sequencia_prescricao::text, '') = ''
		and 	coalesce(d.nr_seq_prescricao::text, '') = ''
		and	c.nr_sequencia			= d.nr_sequencia_autor
		and	e.nr_sequencia			= c.nr_seq_estagio
		and	b.nr_sequencia			= nr_seq_propaci_p
		and	b.dt_procedimento	between coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(c.dt_inicio_vigencia),b.dt_procedimento) and coalesce(c.dt_fim_vigencia,b.dt_procedimento)
		and	e.ie_interno not in ('70','90')
		and	c.nr_sequencia 	= (	select	max(w.nr_sequencia)
						from	autorizacao_convenio w
						where	w.nr_prescricao = c.nr_prescricao
						and	w.nr_atendimento = c.nr_atendimento
						and	(w.cd_senha IS NOT NULL AND w.cd_senha::text <> '') and (w.cd_autorizacao IS NOT NULL AND w.cd_autorizacao::text <> ''))
		and 	((ie_autor_qtde_p = 'N') or (coalesce(d.qt_autorizada,0) > 0))
		
union

		select	b.nr_sequencia nr_seq_proced,
			c.nr_sequencia nr_sequencia_autor,
			3 ie_prioridade, /*Para os casos onde a comparacao e apenas pelo codigo do proced*/
			d.nr_sequencia nr_seq_proc_conta,
			coalesce(c.cd_senha,	'0') cd_senha,
			coalesce(c.cd_autorizacao, '0') cd_autorizacao,
			d.cd_senha cd_senha_item, 
			d.nr_doc_convenio cd_autorizacao_item,
			coalesce(d.nr_prescricao,0) nr_prescricao,
			c.nr_seq_autorizacao
		from	autorizacao_convenio c,
			procedimento_autorizado b,
			procedimento_paciente d,
			estagio_autorizacao e
		where	b.nr_sequencia_autor	= c.nr_sequencia
		and	d.nr_atendimento	= c.nr_atendimento
		and	d.cd_procedimento	= b.cd_procedimento
		and	d.ie_origem_proced   	= b.ie_origem_proced
		and	coalesce(d.nr_seq_proc_interno,0)	= coalesce(b.nr_seq_proc_interno,0)
		and	e.nr_sequencia		= c.nr_seq_estagio
		and	e.ie_interno not in ('70','90')
		and	d.nr_sequencia			= nr_seq_propaci_p
		and	d.dt_procedimento	between coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(c.dt_inicio_vigencia),d.dt_procedimento) and coalesce(c.dt_fim_vigencia,d.dt_procedimento)
		and	coalesce(b.nr_prescricao::text, '') = ''
		and	(d.nr_prescricao IS NOT NULL AND d.nr_prescricao::text <> '')
		and	not exists (select	1
				   from		procedimento_paciente x
				   where	x.nr_sequencia <> nr_seq_propaci_p
				   and		x.nr_prescricao 	= d.nr_prescricao
				   and		x.cd_procedimento	= d.cd_procedimento
				   and		x.ie_origem_proced	= d.ie_origem_proced
				   and		x.nr_atendimento	= c.nr_atendimento
				   and		coalesce(x.nr_seq_proc_interno,0)	= coalesce(b.nr_seq_proc_interno,0)
				   and		x.cd_senha		= c.cd_senha
				   and		x.nr_doc_convenio	= c.cd_autorizacao)
		and 	((ie_autor_qtde_p = 'N') or (coalesce(b.qt_autorizada,0) > 0))
		
union

		select	b.nr_sequencia nr_seq_proced,
			c.nr_sequencia nr_sequencia_autor,
			4 ie_prioridade, /*Para os casos onde a comparacao e apenas pelo codigo do proced*/
			d.nr_sequencia nr_seq_proc_conta,
			coalesce(c.cd_senha,	'0') cd_senha,
			coalesce(c.cd_autorizacao, '0') cd_autorizacao,
			d.cd_senha cd_senha_item, 
			d.nr_doc_convenio cd_autorizacao_item,
			coalesce(d.nr_prescricao,0) nr_prescricao,
			c.nr_seq_autorizacao
		from	autorizacao_convenio c,
			procedimento_autorizado b,
			procedimento_paciente d,
			estagio_autorizacao e
		where	b.nr_sequencia_autor	= c.nr_sequencia
		and	d.nr_atendimento	= c.nr_atendimento
		and	d.cd_procedimento	= b.cd_procedimento
		and	d.ie_origem_proced   	= b.ie_origem_proced
		and	coalesce(d.nr_seq_proc_interno,0)	= coalesce(b.nr_seq_proc_interno,0)
		and	e.nr_sequencia		= c.nr_seq_estagio
		and	e.ie_interno not in ('70','90')
		and	d.nr_sequencia			= nr_seq_propaci_p
		and	d.dt_procedimento	between coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(c.dt_inicio_vigencia),d.dt_procedimento) and coalesce(c.dt_fim_vigencia,d.dt_procedimento)
		and	coalesce(b.nr_prescricao::text, '') = ''
		and	coalesce(d.nr_prescricao::text, '') = ''
		and	not exists (select	1
				   from		procedimento_paciente x
				   where	x.nr_sequencia <> nr_seq_propaci_p
				   and		coalesce(x.nr_prescricao::text, '') = ''
				   and		x.cd_procedimento	= d.cd_procedimento
				   and		x.nr_atendimento	= c.nr_atendimento
				   and		x.ie_origem_proced	= d.ie_origem_proced
				   and		coalesce(x.nr_seq_proc_interno,0)	= coalesce(b.nr_seq_proc_interno,0)
				   and		x.cd_senha		= c.cd_senha
				   and		x.nr_doc_convenio	= c.cd_autorizacao)
		and 	((ie_autor_qtde_p = 'N') or (coalesce(b.qt_autorizada,0) > 0))
		
union

		select	b.nr_sequencia nr_seq_proced,
			c.nr_sequencia nr_sequencia_autor,
			5 ie_prioridade, /*Para os casos onde e o proprio procedimento na conta, na conta nao tem prescricao mas na autorizacao tem*/
			d.nr_sequencia nr_seq_proc_conta,
			coalesce(c.cd_senha,	'0') cd_senha,
			coalesce(c.cd_autorizacao, '0') cd_autorizacao,
			d.cd_senha cd_senha_item, 
			d.nr_doc_convenio cd_autorizacao_item,
			coalesce(d.nr_prescricao,0) nr_prescricao,
			c.nr_seq_autorizacao
		from	autorizacao_convenio c,
			procedimento_autorizado b,
			procedimento_paciente d,
			estagio_autorizacao e
		where	b.nr_sequencia_autor	= c.nr_sequencia
		and	d.nr_atendimento	= c.nr_atendimento
		and	d.cd_procedimento	= b.cd_procedimento
		and	d.ie_origem_proced   	= b.ie_origem_proced
		and	coalesce(d.nr_seq_proc_interno,0)	= coalesce(b.nr_seq_proc_interno,0)
		and	e.nr_sequencia		= c.nr_seq_estagio
		and	e.ie_interno not in ('70','90')
		and	d.nr_sequencia			= nr_seq_propaci_p
		and	d.dt_procedimento	between coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(c.dt_inicio_vigencia),d.dt_procedimento) and coalesce(c.dt_fim_vigencia,d.dt_procedimento)
		and	coalesce(d.nr_prescricao::text, '') = ''
		AND	EXISTS (	SELECT  x.nr_prescricao
				FROM 	procedimento_paciente x,
					atendimento_pacote y
				WHERE	x.nr_sequencia 		  = y.nr_seq_proc_origem
				AND	x.nr_seq_proc_pacote 	  = d.nr_seq_proc_pacote
				and	x.nr_atendimento	  = c.nr_atendimento
				AND	x.nr_prescricao		  = b.nr_prescricao
				AND	x.nr_sequencia_prescricao = b.nr_seq_prescricao)
		and 	((ie_autor_qtde_p = 'N') or (coalesce(b.qt_autorizada,0) > 0))
		
union

		select	b.nr_sequencia nr_seq_proced,
			c.nr_sequencia nr_sequencia_autor,
			6 ie_prioridade, /*Para os casos onde e o proprio procedimento na conta, na conta nao tem prescricao mas na autorizacao tem*/
			d.nr_sequencia nr_seq_proc_conta,
			coalesce(c.cd_senha,	'0') cd_senha,
			coalesce(c.cd_autorizacao, '0') cd_autorizacao,
			d.cd_senha cd_senha_item, 
			d.nr_doc_convenio cd_autorizacao_item,
			coalesce(d.nr_prescricao,0) nr_prescricao,
			c.nr_seq_autorizacao
		from	autorizacao_convenio c,
			procedimento_autorizado b,
			procedimento_paciente d,
			estagio_autorizacao e
		where	b.nr_sequencia_autor	= c.nr_sequencia
		and	d.nr_atendimento	= c.nr_atendimento
		and	d.cd_procedimento	= b.cd_procedimento
		and	d.ie_origem_proced   	= b.ie_origem_proced
		and	coalesce(d.nr_seq_proc_interno,0)	= coalesce(b.nr_seq_proc_interno,0)
		and	e.nr_sequencia		= c.nr_seq_estagio
		and	e.ie_interno not in ('70','90')
		and	d.nr_sequencia			= nr_seq_propaci_p
		and	d.dt_procedimento	between coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(c.dt_inicio_vigencia),d.dt_procedimento) and coalesce(c.dt_fim_vigencia,d.dt_procedimento)
		and	coalesce(d.nr_prescricao::text, '') = ''
		and	coalesce(d.nr_seq_proc_pacote::text, '') = ''
		and 	((ie_autor_qtde_p = 'N') or (coalesce(b.qt_autorizada,0) > 0))
		
union

		select	b.nr_sequencia nr_seq_proced,
			c.nr_sequencia nr_sequencia_autor,
			7 ie_prioridade, /*Para os casos onde e o proprio procedimento na conta, na conta tem prescricao mas na autorizacao nao tem*/
			d.nr_sequencia nr_seq_proc_conta,
			coalesce(c.cd_senha,	'0') cd_senha,
			coalesce(c.cd_autorizacao, '0') cd_autorizacao,
			d.cd_senha cd_senha_item, 
			d.nr_doc_convenio cd_autorizacao_item,
			coalesce(d.nr_prescricao,0) nr_prescricao,
			c.nr_seq_autorizacao
		from	autorizacao_convenio c,
			procedimento_autorizado b,
			procedimento_paciente d,
			estagio_autorizacao e
		where	b.nr_sequencia_autor	= c.nr_sequencia
		and	d.nr_atendimento	= c.nr_atendimento
		and	d.cd_procedimento	= b.cd_procedimento
		and	d.ie_origem_proced   	= b.ie_origem_proced
		and	coalesce(d.nr_seq_proc_interno,0)	= coalesce(b.nr_seq_proc_interno,0)
		and	e.nr_sequencia		= c.nr_seq_estagio
		and	e.ie_interno not in ('70','90')
		and	d.nr_sequencia			= nr_seq_propaci_p
		and	d.dt_procedimento	between coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(c.dt_inicio_vigencia),d.dt_procedimento) and coalesce(c.dt_fim_vigencia,d.dt_procedimento)
		and	coalesce(b.nr_prescricao::text, '') = ''
		and 	((ie_autor_qtde_p = 'N') or (coalesce(b.qt_autorizada,0) > 0))
		order by ie_prioridade desc, cd_senha, cd_autorizacao, nr_seq_autorizacao, nr_prescricao,nr_seq_proc_conta, nr_seq_proced)x
	where	1 = 1;
c01_w	c01%rowtype;

BEGIN

if (nr_seq_propaci_p IS NOT NULL AND nr_seq_propaci_p::text <> '') then

	select	coalesce(ie_doc_autorizacao_p,coalesce(max(obter_valor_conv_estab(a.cd_convenio_parametro, a.cd_estabelecimento, 'IE_DOC_AUTORIZACAO')),'N'))
	into STRICT	ie_doc_autorizacao_w
	from	conta_paciente a,
		procedimento_paciente b
	where	a.nr_interno_conta	= b.nr_interno_conta
	and	b.nr_sequencia		= nr_seq_propaci_p;
	
	if (coalesce(ie_doc_autorizacao_w,'N') = 'S') then

		select	max(d.nr_sequencia_autor),
			max(d.nr_sequencia)
		into STRICT	nr_sequencia_autor_w,
			nr_seq_proc_autor_w
		from	procedimento_autorizado d,
			procedimento_paciente b,
			autorizacao_convenio c
		where	b.cd_procedimento		= d.cd_procedimento
		and	b.ie_origem_proced		= d.ie_origem_proced
		and	b.nr_prescricao			= d.nr_prescricao
		and	b.nr_sequencia_prescricao	= d.nr_seq_prescricao
		and	c.nr_sequencia			= d.nr_sequencia_autor
		and	b.nr_sequencia			= nr_seq_propaci_p
		and	b.dt_procedimento	between coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(c.dt_inicio_vigencia),b.dt_procedimento) and coalesce(c.dt_fim_vigencia,b.dt_procedimento)
		and 	((ie_autor_qtde_p = 'N') or (coalesce(d.qt_autorizada,0) > 0));

		if (coalesce(nr_seq_proc_autor_w::text, '') = '') then

			select	max(nr_cirurgia)
			into STRICT	nr_cirurgia_w
			from	procedimento_paciente
			where	nr_sequencia	= nr_seq_propaci_p;

			if (nr_cirurgia_w IS NOT NULL AND nr_cirurgia_w::text <> '') then
				select	max(b.nr_sequencia_autor),
					max(b.nr_sequencia)
				into STRICT	nr_sequencia_autor_w,
					nr_seq_proc_autor_w
				from	agenda_paciente d,
					autorizacao_convenio c,
					procedimento_autorizado b,
					procedimento_paciente a
				where	a.cd_procedimento	= b.cd_procedimento
				and	a.ie_origem_proced	= b.ie_origem_proced
				and	b.nr_sequencia_autor	= c.nr_sequencia
				and	c.nr_seq_agenda		= d.nr_sequencia
				and	d.nr_cirurgia		= a.nr_cirurgia
				and	a.nr_sequencia		= nr_seq_propaci_p
				and	a.dt_procedimento	between coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(c.dt_inicio_vigencia),a.dt_procedimento) and coalesce(c.dt_fim_vigencia,a.dt_procedimento)
				and 	((ie_autor_qtde_p = 'N') or (coalesce(b.qt_autorizada,0) > 0));
			end if;
			
			
		end if;
	else
		
		open C01;
		loop
		fetch C01 into	
			c01_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			nr_seq_proc_autor_w 	:= c01_w.nr_seq_proced;
			nr_sequencia_autor_w 	:= c01_w.nr_sequencia_autor;
			end;
		end loop;
		close C01;
			

	end if;

elsif (nr_seq_matpaci_p IS NOT NULL AND nr_seq_matpaci_p::text <> '') then

	select	coalesce(ie_doc_autorizacao_p,coalesce(max(obter_valor_conv_estab(a.cd_convenio_parametro, a.cd_estabelecimento, 'IE_DOC_AUTORIZACAO')),'N')),
		max(b.nr_prescricao),
		max(b.nr_sequencia_prescricao)
	into STRICT	ie_doc_autorizacao_w,
		nr_prescricao_w,
		nr_sequencia_prescricao_w
	from	conta_paciente a,
		material_atend_paciente b
	where	a.nr_interno_conta	= b.nr_interno_conta
	and	b.nr_sequencia		= nr_seq_matpaci_p;

	begin
	select	coalesce(obter_material_conta(c.cd_estabelecimento, b.cd_convenio,b.cd_categoria, b.cd_material, b.cd_material, b.cd_material, null,
							b.cd_setor_atendimento, clock_timestamp(), b.cd_local_estoque, b.nr_prescricao),0)
	into STRICT	cd_mat_conta_w
	from	material_atend_paciente b,
		conta_paciente c
	where	c.nr_interno_conta = b.nr_interno_conta
	and	b.nr_sequencia	   = nr_seq_matpaci_p;
	exception
	when others then
		cd_mat_conta_w := 0;
	end;

	if (coalesce(ie_doc_autorizacao_w,'N') = 'S') then

		select	max(d.nr_sequencia_autor),
			max(d.nr_sequencia)
		into STRICT	nr_sequencia_autor_w,
			nr_seq_mat_autor_w
		from	material_autorizado d,
			material_atend_paciente b,
			autorizacao_convenio c
		where	((b.cd_material			= d.cd_material) or (b.cd_material = cd_mat_conta_w))
		and	b.nr_prescricao			= d.nr_prescricao
		and	b.nr_sequencia_prescricao	= d.nr_seq_prescricao
		and	c.nr_sequencia			= d.nr_sequencia_autor
		and	b.nr_sequencia			= nr_seq_matpaci_p
		and	b.dt_atendimento	between coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(c.dt_inicio_vigencia),b.dt_atendimento) and coalesce(c.dt_fim_vigencia,b.dt_atendimento)
		and 	((ie_autor_qtde_p = 'N') or (coalesce(d.qt_autorizada,0) > 0));
	else
	
		if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then
			
			begin
			select	a.cd_material
			into STRICT	cd_material_kit_w
			from	prescr_material a
			where	a.nr_prescricao		= nr_prescricao_w
			and	coalesce(a.cd_kit_material::text, '') = ''
			and	a.nr_sequencia		=
					(SELECT	max(b.nr_seq_kit)
					from	prescr_material b
					where	b.nr_prescricao		= nr_prescricao_w
					and	(b.cd_kit_material IS NOT NULL AND b.cd_kit_material::text <> '')
					and	b.nr_sequencia		= nr_sequencia_prescricao_w)  LIMIT 1;			
			exception
			when others then
				cd_material_kit_w	:= null;
			end;
			
		end if;

		select	max(x.nr_sequencia_autor),
			max(x.nr_sequencia)
		into STRICT	nr_sequencia_autor_w,
			nr_seq_mat_autor_w
		from	(SELECT	max(d.nr_sequencia_autor) nr_sequencia_autor, /* Consistencia somente pelo codigo onde nao ha vinculo com a prescr*/
				max(d.nr_sequencia) nr_sequencia
			from	autorizacao_convenio c,
				material_autorizado d,
				material_atend_paciente b,
				estagio_autorizacao e
			where	d.nr_sequencia_autor	= c.nr_sequencia
			and	c.nr_atendimento	= b.nr_atendimento
			and	b.cd_material		= d.cd_material
			and	e.nr_sequencia		= c.nr_seq_estagio
			and	e.ie_interno 		not in ('70','90')
			and	b.nr_sequencia		= nr_seq_matpaci_p
			and	b.dt_atendimento	between coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(c.dt_inicio_vigencia),b.dt_atendimento) and coalesce(c.dt_fim_vigencia,b.dt_atendimento)
			and	coalesce(d.nr_prescricao::text, '') = ''
			and 	((ie_autor_qtde_p = 'N') or (coalesce(d.qt_autorizada,0) > 0))
			
union

			SELECT	max(d.nr_sequencia_autor) nr_sequencia_autor,  /* Consistencia somente pelo codigo material exec onde nao ha vinculo */
				max(d.nr_sequencia) nr_sequencia
			from	autorizacao_convenio c,
				material_autorizado d,
				material_atend_paciente b,
				estagio_autorizacao e
			where	c.nr_sequencia		= d.nr_sequencia_autor
			and	c.nr_atendimento	= b.nr_atendimento
			and	e.nr_sequencia		= c.nr_seq_estagio
			and	e.ie_interno 		not in ('70','90')
			and	d.cd_material		= b.cd_material_exec			
			and	b.nr_sequencia		= nr_seq_matpaci_p
			and	b.dt_atendimento	between coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(c.dt_inicio_vigencia),b.dt_atendimento) and coalesce(c.dt_fim_vigencia,b.dt_atendimento)
			and	coalesce(d.nr_prescricao::text, '') = ''
			and 	((ie_autor_qtde_p = 'N') or (coalesce(d.qt_autorizada,0) > 0))
			
union

			select	max(d.nr_sequencia_autor) nr_sequencia_autor, --Se o KIT possui autorizacao, os itens gerados deste KIT devem assumir o mesmo numero de guia
				max(d.nr_sequencia) nr_sequencia
			from	autorizacao_convenio c,
				material_autorizado d,
				material_atend_paciente b,
				estagio_autorizacao e
			where	c.nr_sequencia		= d.nr_sequencia_autor
			and	c.nr_atendimento	= b.nr_atendimento
			and	e.nr_sequencia		= c.nr_seq_estagio
			and	e.ie_interno 		not in ('70','90')
			and	d.cd_material		= cd_material_kit_w
			and	(cd_material_kit_w IS NOT NULL AND cd_material_kit_w::text <> '')
			and	b.nr_sequencia		= nr_seq_matpaci_p
			and	b.dt_atendimento	between coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(c.dt_inicio_vigencia),b.dt_atendimento) and coalesce(c.dt_fim_vigencia,b.dt_atendimento)
			and 	((ie_autor_qtde_p = 'N') or (coalesce(d.qt_autorizada,0) > 0))
			
union

			select	max(d.nr_sequencia_autor), /* Consistencia somente pelo codigo e prescr e seq prescri*/
				max(d.nr_sequencia)
			from	material_autorizado d,
				material_atend_paciente b,
				autorizacao_convenio c
			where	((b.cd_material			= d.cd_material) or (b.cd_material 			= cd_mat_conta_w) or (d.cd_material			= b.cd_material_exec))
			and	b.nr_prescricao			= d.nr_prescricao
			and	b.nr_sequencia_prescricao	= d.nr_seq_prescricao
			and	b.nr_sequencia			= nr_seq_matpaci_p
			and	c.nr_sequencia			= d.nr_sequencia_autor
			and	b.dt_atendimento	between coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(c.dt_inicio_vigencia),b.dt_atendimento) and coalesce(c.dt_fim_vigencia,b.dt_atendimento)
			and 	((ie_autor_qtde_p = 'N') or (coalesce(d.qt_autorizada,0) > 0))
			
union

			select	max(d.nr_sequencia_autor), /* Consistencia somente pelo codigo e prescricao Ocorre quando ha RLA ou itens adicionais da autorizacao*/
				max(d.nr_sequencia)
			from	material_autorizado d,
				material_atend_paciente b,
				autorizacao_convenio c
			where	((b.cd_material			= d.cd_material) or (b.cd_material 			= cd_mat_conta_w) or (d.cd_material			= b.cd_material_exec))
			and	b.nr_prescricao			= d.nr_prescricao
			and	coalesce(b.nr_sequencia_prescricao::text, '') = ''
			and	coalesce(d.nr_seq_prescricao::text, '') = ''
			and	b.nr_sequencia			= nr_seq_matpaci_p
			and	c.nr_sequencia			= d.nr_sequencia_autor
			and	b.dt_atendimento	between coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(c.dt_inicio_vigencia),b.dt_atendimento) and coalesce(c.dt_fim_vigencia,b.dt_atendimento)
			and 	((ie_autor_qtde_p = 'N') or (coalesce(d.qt_autorizada,0) > 0)))x;
	end if;
end if;

if (nr_sequencia_autor_w IS NOT NULL AND nr_sequencia_autor_w::text <> '') then
	select	cd_autorizacao,
		cd_senha,
		nr_seq_estagio
	into STRICT	cd_autorizacao_w,
		cd_senha_w,
		nr_seq_estagio_w
	from	autorizacao_convenio
	where	nr_sequencia	= nr_sequencia_autor_w;

	if (coalesce(nr_sequencia_autor_w::text, '') = '') then

		select	max(b.nr_sequencia_autor),
			max(b.nr_sequencia)
		into STRICT	nr_sequencia_autor_w,
			nr_seq_proc_autor_w
		from	autorizacao_convenio c,
			material_autorizado b,
			material_atend_paciente d
		where	b.nr_sequencia_autor	= c.nr_sequencia
		and	d.nr_sequencia		= nr_seq_matpaci_p
		and	d.cd_material	= b.cd_material
		and	d.dt_atendimento	between coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(c.dt_inicio_vigencia),d.dt_atendimento) and coalesce(c.dt_fim_vigencia,d.dt_atendimento)
		and 	((ie_autor_qtde_p = 'N') or (coalesce(b.qt_autorizada,0) > 0));

	end if;

	if (nr_seq_estagio_w IS NOT NULL AND nr_seq_estagio_w::text <> '') then
		select	CASE WHEN ie_interno='10' THEN 'S'  ELSE 'N' END
		into STRICT	ie_autorizado_w
		from	estagio_autorizacao
		where	nr_sequencia	= nr_seq_estagio_w;
	end if;

end if;

nr_sequencia_autor_p	:= nr_sequencia_autor_w;
nr_seq_proc_autor_p	:= nr_seq_proc_autor_w;
nr_seq_mat_autor_p	:= nr_seq_mat_autor_w;
cd_autorizacao_p	:= cd_autorizacao_w;
cd_senha_p		:= cd_senha_w;
ie_autorizado_p		:= ie_autorizado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_autor_item_conta (nr_seq_propaci_p bigint, nr_seq_matpaci_p bigint, nr_sequencia_autor_p INOUT bigint, nr_seq_proc_autor_p INOUT bigint, nr_seq_mat_autor_p INOUT bigint, cd_autorizacao_p INOUT text, cd_senha_p INOUT text, ie_autorizado_p INOUT text, ie_doc_autorizacao_p text default null, ie_autor_qtde_p text default 'N') FROM PUBLIC;

