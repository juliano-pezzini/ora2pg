-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_kit_material_orc (nr_seq_orcamento_p bigint, qt_lancamento_p bigint, CD_KIT_MATERIAL_P bigint, nr_Seq_proc_princ_p bigint, NM_USUARIO_P text, ie_adicional_p text, nr_seq_orcamento_padrao_p bigint default null, cd_setor_orcamento_P bigint default null) AS $body$
DECLARE



CD_MATERIAL_w			integer;
NR_SEQ_ORCAMENTO_PADRAO_w			integer;
QT_MATERIAL_w			double precision;
CD_UNIDADE_MEDIDA_CONSUMO_w	varchar(30);
IE_VIA_APLICACAO_w		varchar(10);
CD_CATEGORIA_W			varchar(10);
NR_DOC_CONVENIO_W		varchar(20);
IE_TIPO_GUIA_W			varchar(2);
IE_ESTOQUE_DISP_w		varchar(1);
cd_estabelecimento_W		integer;
qt_reg_existe_w			smallint:= 0;
ie_consiste_duplicidade_w	varchar(1);
ie_reg_existe_w			varchar(1):= 'N';

C001 CURSOR FOR
	SELECT 	A.CD_MATERIAL,
			A.QT_MATERIAL,
			substr(obter_dados_material_estab(b.cd_material,cd_estabelecimento_w,'UMS'),1,30) CD_UNIDADE_MEDIDA_CONSUMO,
			B.IE_VIA_APLICACAO
	FROM	MATERIAL B, COMPONENTE_KIT A
	WHERE (A.CD_MATERIAL = B.CD_MATERIAL)
	AND 	A.CD_KIT_MATERIAL = CD_KIT_MATERIAL_P
	AND 	A.IE_SITUACAO = 'A'
	AND 	B.IE_SITUACAO = 'A'
	AND	((coalesce(A.CD_ESTAB_REGRA::text, '') = '') OR (A.CD_ESTAB_REGRA = cd_estabelecimento_w));


BEGIN

cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;

ie_consiste_duplicidade_w := coalesce(obter_valor_param_usuario(106, 85, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento),'N');

if (ie_consiste_duplicidade_w = 'S') then

	select	coalesce(max('S'), 'N')	
	into STRICT	ie_reg_existe_w
	from	orcamento_paciente_mat
	where	nr_sequencia_orcamento = nr_seq_orcamento_p
	and	cd_material = CD_KIT_MATERIAL_P;

end if;	



if	((ie_consiste_duplicidade_w = 'N') or
	(ie_consiste_duplicidade_w = 'S' AND ie_reg_existe_w = 'N')) then
	OPEN C001;
	LOOP
		FETCH C001 INTO
			CD_MATERIAL_w,
			QT_MATERIAL_w,
			CD_UNIDADE_MEDIDA_CONSUMO_w,
			IE_VIA_APLICACAO_w;
		EXIT WHEN NOT FOUND; /* apply on c001 */
			begin		
			
			if (ie_consiste_duplicidade_w = 'S') then
			
				select	coalesce(max('S'), 'N')	
				into STRICT	ie_reg_existe_w
				from	orcamento_paciente_mat
				where	nr_sequencia_orcamento = nr_seq_orcamento_p
				and	cd_material = cd_material_w;
			end if;		

				insert into orcamento_paciente_mat(
					NR_SEQUENCIA_ORCAMENTO        ,
					CD_MATERIAL                    ,
					QT_MATERIAL                    ,
					VL_MATERIAL                    ,
					DT_ATUALIZACAO                 ,
					NM_USUARIO                     ,
					VL_DESCONTO                    ,
					IE_VALOR_INFORMADO             ,
					NR_SEQ_REGRA_LANC              ,
					NR_SEQUENCIA,
					nr_seq_proc_princ,
					ie_adicional,
					NR_SEQ_ORCAMENTO_PADRAO,
					CD_SETOR_ATENDIMENTO,
					CD_KIT_MAT_EXEC
					)
				values (
					nr_seq_orcamento_p,
					cd_material_w,
					QT_MATERIAL_w * coalesce(qt_lancamento_p,1),
					0,
					clock_timestamp(),
					nm_usuario_p,
					0, 'N', null,
					nextval('orcamento_paciente_mat_seq'),
					nr_Seq_proc_princ_p,
					ie_adicional_p,
					nr_seq_orcamento_padrao_p,
					cd_setor_orcamento_P,
					cd_kit_material_p
					);
		
		
			end;

	END LOOP;
	CLOSE C001;
end if;	
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_kit_material_orc (nr_seq_orcamento_p bigint, qt_lancamento_p bigint, CD_KIT_MATERIAL_P bigint, nr_Seq_proc_princ_p bigint, NM_USUARIO_P text, ie_adicional_p text, nr_seq_orcamento_padrao_p bigint default null, cd_setor_orcamento_P bigint default null) FROM PUBLIC;

