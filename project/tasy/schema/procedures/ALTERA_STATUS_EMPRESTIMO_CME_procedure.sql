-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE altera_status_emprestimo_cme ( nr_sequencia_p bigint, nr_seq_status_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


ie_gera_recurso_w		varchar(1);
nr_seq_conjunto_w 		bigint;
nr_seq_conjunto_agenda_w	bigint;
nr_seq_agenda_w			agenda_pac_cme.nr_seq_agenda%type;
qt_conjunto_w			bigint;
ie_reprovado_w			varchar(1);
nr_seq_evento_w			bigint;


BEGIN

if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') and (nr_seq_status_p IS NOT NULL AND nr_seq_status_p::text <> '') then

	select	max(nr_seq_conjunto),
		max(nr_seq_agenda),
		max(nr_seq_conjunto_agenda)
	into STRICT	nr_seq_conjunto_w,
		nr_seq_agenda_w,
		nr_seq_conjunto_agenda_w
	from	reserva_agenda_cme
	where	nr_sequencia = nr_sequencia_p;

	select	coalesce(max(ie_gera_recurso),'N'),
		coalesce(max(ie_reprovado),'N')
	into STRICT	ie_gera_recurso_w,
		ie_reprovado_w
	from	status_res_agenda_recurso
	where	nr_sequencia = nr_seq_status_p
	and	coalesce(ie_situacao,'A') = 'A';

	if (nr_seq_agenda_w IS NOT NULL AND nr_seq_agenda_w::text <> '') then
		if (ie_gera_recurso_w = 'S') and (nr_seq_conjunto_w IS NOT NULL AND nr_seq_conjunto_w::text <> '') then

			select	count(*)
			into STRICT	qt_conjunto_w
			from	agenda_pac_cme
			where	nr_seq_conjunto = nr_seq_conjunto_w
			and	coalesce(ie_origem_inf,'I') = 'I'
			and	nr_seq_agenda = nr_seq_agenda_w;

			if (qt_conjunto_w = 0) then
				insert	into	agenda_pac_cme(
						nr_sequencia,
						nr_seq_agenda,
						dt_atualizacao,
						nm_usuario,
						nr_seq_conjunto,
						qt_conjunto,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						ie_origem_inf,
						ie_obrigatorio,
						ie_status_cme
						)
				values (nextval('agenda_pac_cme_seq'),
						nr_seq_agenda_w,
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_conjunto_w,
						1,
						clock_timestamp(),
						nm_usuario_p,
						'I',
						'S',
						'E');
				update	agenda_pac_cme
				set	ie_origem_inf = 'E'
				where	nr_seq_conjunto = nr_seq_conjunto_agenda_w
				and	nr_seq_agenda	= nr_seq_agenda_w;
				
				select	max(nr_seq_evento)
				into STRICT	nr_seq_evento_w
				from	regra_envio_sms
				where	cd_estabelecimento		= cd_estabelecimento_p
				and	ie_evento_disp			= 'AECME'
				and	coalesce(ie_situacao,'A') 		= 'A';
				if (nr_seq_evento_w IS NOT NULL AND nr_seq_evento_w::text <> '') then
					CALL gerar_evento_agenda_cirurgica(nr_seq_evento_w,nr_seq_agenda_w,nr_seq_conjunto_w,0,nm_usuario_p,cd_estabelecimento_p,'N');
				end if;	
			end if;
		elsif (ie_reprovado_w = 'S') and (nr_seq_conjunto_w IS NOT NULL AND nr_seq_conjunto_w::text <> '') then
			select	max(nr_seq_evento)
			into STRICT	nr_seq_evento_w
			from	regra_envio_sms
			where	cd_estabelecimento		= cd_estabelecimento_p
			and	ie_evento_disp			= 'RECME'
			and	coalesce(ie_situacao,'A') 		= 'A';
			if (nr_seq_evento_w IS NOT NULL AND nr_seq_evento_w::text <> '') then
				CALL gerar_evento_agenda_cirurgica(nr_seq_evento_w,nr_seq_agenda_w,nr_seq_conjunto_w,0,nm_usuario_p,cd_estabelecimento_p,'N');
			end if;	
		end if;
		update	reserva_agenda_cme
		set	nr_seq_status 	= nr_seq_status_p
		where	nr_sequencia 	= nr_sequencia_p;
		commit;
	end if;
end if;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE altera_status_emprestimo_cme ( nr_sequencia_p bigint, nr_seq_status_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

