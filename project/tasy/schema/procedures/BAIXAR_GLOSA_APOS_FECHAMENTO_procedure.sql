-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baixar_glosa_apos_fechamento ( nr_sequencia_p bigint, vl_glosado_p bigint, vl_amenor_p bigint, dt_baixa_p timestamp, nm_usuario_p text) AS $body$
DECLARE

 
cd_autorizacao_w		numeric(20);
nr_interno_conta_w		bigint;
nr_atendimento_w		bigint;
nr_seq_protocolo_w		bigint;
nr_titulo_w			bigint;
nr_seq_retorno_w		bigint;

cd_moeda_w			integer;
dt_receb_w			timestamp;
nr_seq_trans_w		bigint;
cd_banco_w			integer;
cd_agencia_w			varchar(8);

vl_saldo_w			double precision;
dt_vencimento_w		timestamp;
ie_ordem_w			integer;

nr_sequencia_w		bigint;

cd_estabelecimento_w		bigint;

ie_baixou_w			varchar(1) := 'N';

C001 CURSOR FOR 
	SELECT distinct 
		ie_ordem, 
		nr_titulo, 
		dt_vencimento, 
		vl_saldo_titulo 
	from (SELECT 1 ie_ordem, 
			nr_titulo, 
			dt_vencimento, 
	   	 vl_saldo_titulo 
		from titulo_receber 
		where nr_interno_conta = nr_interno_conta_w 
		 and nr_documento = cd_autorizacao_w 
		
union
 
		select 2, 
			nr_titulo, 
			dt_vencimento, 
	   	 vl_saldo_titulo 
		from titulo_receber 
		where coalesce(nr_documento,0) = 0 
		 and nr_interno_conta = nr_interno_conta_w 
		
union
 
		select 3, 
			nr_titulo, 
			dt_vencimento, 
	   	 vl_saldo_titulo 
		from titulo_receber 
		where coalesce(nr_interno_conta,0) = 0 
	 	 and nr_seq_protocolo = nr_seq_protocolo_w 
		
union
 
		select 4, 
			nr_titulo, 
			dt_vencimento, 
	   	 vl_saldo_titulo 
		from titulo_receber 
		where nr_atendimento = nr_atendimento_w 
		 and coalesce(nr_interno_conta::text, '') = '' 
		
union
 
		select 5, 
			nr_titulo, 
			dt_vencimento, 
	   	 vl_saldo_titulo 
		from titulo_receber 
		where coalesce(nr_interno_conta,0) = 0 
		 and coalesce(nr_seq_protocolo,0) = 0 
	 	 and nr_titulo = nr_titulo_w) alias5 
	order by ie_ordem, dt_vencimento;


BEGIN 
 
update Convenio_Retorno_Item 
set	vl_glosado = vl_glosado + vl_glosado_p, 
	vl_amenor = vl_amenor_p, 
	ie_glosa = CASE WHEN vl_glosado_p=0 THEN 'N'  ELSE CASE WHEN vl_amenor_p=0 THEN 'S'  ELSE 'P' END  END , 
	nm_usuario = nm_usuario_p, 
	dt_atualizacao = clock_timestamp() 
where nr_sequencia = nr_sequencia_p;
 
select a.nr_seq_protocolo, 
	nr_interno_conta, 
	cd_autorizacao, 
	nr_titulo, 
	nr_seq_retorno, 
	nr_atendimento, 
	cd_estabelecimento 
into STRICT	nr_seq_protocolo_w, 
	nr_interno_conta_w, 
	cd_autorizacao_w, 
	nr_titulo_w, 
	nr_seq_retorno_w, 
	nr_atendimento_w, 
	cd_estabelecimento_w 
from convenio_retorno b, 
	(SELECT b.nr_seq_protocolo, 
		 b.nr_interno_conta, 
		 somente_numero(a.cd_autorizacao) cd_autorizacao, 
		 0 nr_titulo, 
		 a.nr_seq_retorno, 
		 b.nr_atendimento 
	from	conta_paciente b, 
		convenio_retorno_item a 
	where a.nr_interno_conta = b.nr_interno_conta 
	 and a.nr_sequencia = nr_sequencia_p 
	 and (a.nr_interno_conta IS NOT NULL AND a.nr_interno_conta::text <> '') 
	
union
 
	SELECT 0, 
		 0, 
		 0, 
		 nr_titulo, 
		 nr_seq_retorno, 
		 0 
	from	convenio_retorno_item 
	where nr_sequencia = nr_sequencia_p 
	 and coalesce(nr_interno_conta::text, '') = '') a 
where b.nr_sequencia = a.nr_seq_retorno;
 
select cd_moeda_padrao 
into STRICT cd_moeda_w 
from parametro_contas_receber 
where cd_estabelecimento = cd_estabelecimento_w;
 
select coalesce(dt_baixa_p, coalesce(max(d.dt_baixa_cr),clock_timestamp())), 
	 max(b.nr_seq_trans_fin), 
	 max(c.cd_banco), 
	 max(c.cd_agencia_bancaria) 
into STRICT	dt_receb_w, 
	nr_seq_trans_w, 
	cd_banco_w, 
	cd_agencia_w 
FROM convenio_retorno d, convenio_ret_receb a, convenio_receb b
LEFT OUTER JOIN banco_estabelecimento c ON (b.nr_seq_conta_banco = c.nr_sequencia)
WHERE a.nr_seq_receb = b.nr_sequencia  and a.nr_seq_retorno = d.nr_sequencia and a.nr_seq_retorno = nr_seq_retorno_w;
 
ie_baixou_w := 'N';
open C001;
loop 
	fetch C001 into ie_ordem_w, 
				nr_titulo_w, 
				dt_vencimento_w, 
				vl_saldo_w;
	EXIT WHEN NOT FOUND; /* apply on C001 */
 
	select coalesce(max(nr_sequencia),0) + 1 
	into STRICT nr_sequencia_w 
	from titulo_receber_liq 
	where nr_titulo = nr_titulo_w;
 
	insert into titulo_receber_liq(nr_titulo, nr_sequencia, 
		dt_recebimento, 
		vl_recebido, 
		vl_descontos, 
		vl_juros, 
		vl_multa, 
		cd_moeda, 
		dt_atualizacao, 
		nm_usuario, 
		cd_tipo_recebimento, 
		ie_acao, 
		cd_serie_nf_devol, 
		nr_nota_fiscal_devol, 
		cd_banco, 
		cd_agencia_bancaria, 
		nr_documento, 
		nr_lote_banco, 
		cd_cgc_emp_cred, 
		nr_cartao_cred, 
		nr_adiantamento, 
		nr_lote_contabil, 
		nr_seq_trans_fin, 
		vl_rec_maior, 
		vl_glosa, 
		nr_seq_ret_item, 
		nr_seq_retorno, 
		ie_lib_caixa, 
		nr_lote_contab_antecip, 
		nr_lote_contab_pro_rata) 
	values (nr_titulo_w, 
		nr_sequencia_w, 
		dt_receb_w, 
		0, 
		0, 
		0, 
		0, 
		cd_moeda_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		1, 
		'I', 
		null, 
		null, 
		cd_banco_w, 
		cd_agencia_w, 
		cd_autorizacao_w, 
		null, 
		null, 
		null, 
		null, 
		0, 
		nr_seq_trans_w, 
		0, 
		vl_glosado_p, 
		nr_sequencia_p, 
		nr_seq_retorno_w, 
		'S', 
		0, 
		0);
 
	-- Edgar 11/01/2006, OS 27445, gravar log de onde est√° vindo a baixa 
	/*if	(sysdate < to_date('01/03/2006','dd/mm/yyyy')) then 
 
		insert into logxxxx_tasy 
			(DT_ATUALIZACAO, 
			NM_USUARIO, 
			CD_LOG, 
			DS_LOG) 
		values	(sysdate, 
			nm_usuario_p, 
			55557, 
			'NR_TITULO = ' || nr_titulo_w || ' NR_SEQUENCIA = ' || nr_sequencia_w || 
			' NR_SEQ_RETORNO = ' || nr_seq_retorno_w || ' vl_glosado_p = ' || vl_glosado_p || 
			' Baixar_Glosa_Apos_Fechamento'); 
 
	end if;*/
 
 
	CALL atualizar_saldo_tit_rec(nr_titulo_w, nm_usuario_p);
 
	ie_baixou_w := 'S';
 
end loop;
close C001;
 
if (ie_baixou_w = 'S') then 
	commit;
else 
	rollback;
	CALL wheb_mensagem_pck.exibir_mensagem_abort(256035, 'CD_AUTORIZACAO_W=' || cd_autorizacao_w);
end if;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baixar_glosa_apos_fechamento ( nr_sequencia_p bigint, vl_glosado_p bigint, vl_amenor_p bigint, dt_baixa_p timestamp, nm_usuario_p text) FROM PUBLIC;

