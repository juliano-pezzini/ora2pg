-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_cartao_cr_parcela ( nr_seq_forma_pagto_p bigint, nr_seq_bandeira_p bigint, ie_tipo_cartao_p text, qt_parcelas_p bigint, vl_transacao_p bigint, nm_usuario_p text) AS $body$
DECLARE


tx_administracao_w	double precision;
nr_sequencia_w		bigint;
vl_minimo_parcela_w	double precision;
vl_parcela_w		double precision;	
cd_estabelecimento_w	bigint;


BEGIN

cd_estabelecimento_w := obter_estabelecimento_ativo;

select	max(a.nr_sequencia)
into STRICT	nr_sequencia_w
from	forma_pagto_regra a
where	a.nr_seq_forma			= nr_seq_forma_pagto_p
and	a.nr_seq_bandeira		= nr_seq_bandeira_p
and	a.ie_tipo_cartao		= ie_tipo_cartao_p
and 	coalesce(a.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
and	a.dt_inicio_vigencia	< clock_timestamp()
and	qt_parcelas_p 		between coalesce(a.nr_parcela_inicio,1) and coalesce(a.nr_parcela_fim,999)
and	vl_transacao_p		between coalesce(a.vl_transacao_inicio,-999999999999999) and coalesce(a.vl_transacao_fim,999999999999999)
and	a.dt_inicio_vigencia	= 	(SELECT	max(x.dt_inicio_vigencia)
				 	from	forma_pagto_regra x
				 	where	x.nr_seq_forma		= a.nr_seq_forma
					and	x.nr_seq_bandeira		= a.nr_seq_bandeira
					and	x.ie_tipo_cartao		= a.ie_tipo_cartao
					and 	coalesce(x.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
					and	qt_parcelas_p 		between coalesce(x.nr_parcela_inicio,1) and coalesce(x.nr_parcela_fim,999));

if (coalesce(nr_sequencia_w::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(169339);
/* Se achou, verificar o valor mÃ­nimo permitido para as parcelas */

else
	select	vl_minimo_parcela
	into STRICT	vl_minimo_parcela_w
	from	forma_pagto_regra
	where	nr_sequencia	= nr_sequencia_w;

	if (vl_minimo_parcela_w IS NOT NULL AND vl_minimo_parcela_w::text <> '') then

		vl_parcela_w	:=	round((dividir_sem_round(vl_transacao_p,qt_parcelas_p))::numeric,2);

		if (vl_parcela_w < vl_minimo_parcela_w) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(169343,'VL_PARCELA_W='||vl_parcela_w||';'||
									'VL_MINIMO_PARCELA_W='||vl_minimo_parcela_w);
		end if;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_cartao_cr_parcela ( nr_seq_forma_pagto_p bigint, nr_seq_bandeira_p bigint, ie_tipo_cartao_p text, qt_parcelas_p bigint, vl_transacao_p bigint, nm_usuario_p text) FROM PUBLIC;

