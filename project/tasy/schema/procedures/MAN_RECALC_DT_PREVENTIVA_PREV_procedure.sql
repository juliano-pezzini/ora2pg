-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_recalc_dt_preventiva_prev ( nr_sequencia_p bigint, nr_seq_planej_prev_p bigint, qt_dia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_equipamento_w		bigint;
qt_controle_loop_w			integer := 2;
cd_estabelecimento_w		smallint := wheb_usuario_pck.get_cd_estabelecimento;
ds_sep_bv_w			varchar(50);
ie_dia_util_w			varchar(15):= 'S';
dt_prevista_ant_w			timestamp;
dt_prevista_atual_w			timestamp;
dt_prev_w2			timestamp;
dt_prev_w3			timestamp;
dt_prev_w4			timestamp;
dt_prev_w5			timestamp;
dt_prev_w6			timestamp;
dt_prev_w7			timestamp;
dt_prev_w8			timestamp;
dt_prev_w9			timestamp;
dt_prev_w10			timestamp;
dt_prev_w11			timestamp;
dt_prev_w12			timestamp;
dt_prev_w13			timestamp;
dt_prev_w14			timestamp;
dt_prev_w15			timestamp;
dt_prev_w16			timestamp;
dt_prev_w17			timestamp;
dt_prev_w18			timestamp;
dt_prev_w19			timestamp;
dt_prev_w20			timestamp;
dt_prev_w21			timestamp;
dt_prev_w22			timestamp;
dt_prev_w23			timestamp;
dt_prev_w24			timestamp;


BEGIN

if (coalesce(nr_sequencia_p,0) > 0) and (coalesce(nr_seq_planej_prev_p,0) > 0) and (coalesce(qt_dia_p,0) <> 0) and (coalesce(nm_usuario_p,'X') <> 'X') then
	begin
	ds_sep_bv_w := obter_separador_bv;

	select	nr_seq_equipamento,
		trunc(dt_prevista2),
		trunc(dt_prevista3),
		trunc(dt_prevista4),
		trunc(dt_prevista5),
		trunc(dt_prevista6),
		trunc(dt_prevista7),
		trunc(dt_prevista8),
		trunc(dt_prevista9),
		trunc(dt_prevista10),
		trunc(dt_prevista11),
		trunc(dt_prevista12),
		trunc(dt_prevista13),
		trunc(dt_prevista14),
		trunc(dt_prevista15),
		trunc(dt_prevista16),
		trunc(dt_prevista17),
		trunc(dt_prevista18),
		trunc(dt_prevista19),
		trunc(dt_prevista20),
		trunc(dt_prevista21),
		trunc(dt_prevista22),
		trunc(dt_prevista23),
		trunc(dt_prevista24)
	into STRICT	nr_seq_equipamento_w,
		dt_prev_w2,
		dt_prev_w3,
		dt_prev_w4,
		dt_prev_w5,
		dt_prev_w6,
		dt_prev_w7,
		dt_prev_w8,
		dt_prev_w9,
		dt_prev_w10,
		dt_prev_w11,
		dt_prev_w12,
		dt_prev_w13,
		dt_prev_w14,
		dt_prev_w15,
		dt_prev_w16,
		dt_prev_w17,
		dt_prev_w18,
		dt_prev_w19,
		dt_prev_w20,
		dt_prev_w21,
		dt_prev_w22,
		dt_prev_w23,
		dt_prev_w24
	from	man_planej_data_prev
	where	nr_sequencia = nr_sequencia_p;

	while(qt_controle_loop_w <= 24) loop
		begin
		if (qt_controle_loop_w = 2) then
			dt_prevista_ant_w	:= dt_prev_w2;
		elsif (qt_controle_loop_w = 3) then
			dt_prevista_ant_w	:= dt_prev_w3;
		elsif (qt_controle_loop_w = 4) then
			dt_prevista_ant_w	:= dt_prev_w4;
		elsif (qt_controle_loop_w = 5) then
			dt_prevista_ant_w	:= dt_prev_w5;
		elsif (qt_controle_loop_w = 6) then
			dt_prevista_ant_w	:= dt_prev_w6;
		elsif (qt_controle_loop_w = 7) then
			dt_prevista_ant_w	:= dt_prev_w7;
		elsif (qt_controle_loop_w = 8) then
			dt_prevista_ant_w	:= dt_prev_w8;
		elsif (qt_controle_loop_w = 9) then
			dt_prevista_ant_w	:= dt_prev_w9;
		elsif (qt_controle_loop_w = 10) then
			dt_prevista_ant_w	:= dt_prev_w10;
		elsif (qt_controle_loop_w = 11) then
			dt_prevista_ant_w	:= dt_prev_w11;
		elsif (qt_controle_loop_w = 12) then
			dt_prevista_ant_w	:= dt_prev_w12;
		elsif (qt_controle_loop_w = 13) then
			dt_prevista_ant_w	:= dt_prev_w13;
		elsif (qt_controle_loop_w = 14) then
			dt_prevista_ant_w	:= dt_prev_w14;
		elsif (qt_controle_loop_w = 15) then
			dt_prevista_ant_w	:= dt_prev_w15;
		elsif (qt_controle_loop_w = 16) then
			dt_prevista_ant_w	:= dt_prev_w16;
		elsif (qt_controle_loop_w = 17) then
			dt_prevista_ant_w	:= dt_prev_w17;
		elsif (qt_controle_loop_w = 18) then
			dt_prevista_ant_w	:= dt_prev_w18;
		elsif (qt_controle_loop_w = 19) then
			dt_prevista_ant_w	:= dt_prev_w19;
		elsif (qt_controle_loop_w = 20) then
			dt_prevista_ant_w	:= dt_prev_w20;
		elsif (qt_controle_loop_w = 21) then
			dt_prevista_ant_w	:= dt_prev_w21;
		elsif (qt_controle_loop_w = 22) then
			dt_prevista_ant_w	:= dt_prev_w22;
		elsif (qt_controle_loop_w = 23) then
			dt_prevista_ant_w	:= dt_prev_w23;
		elsif (qt_controle_loop_w = 24) then
			dt_prevista_ant_w	:= dt_prev_w24;
		end if;

		dt_prevista_atual_w	:= dt_prevista_ant_w + qt_dia_p;
		ie_dia_util_w		:= substr(obter_se_dia_util(dt_prevista_atual_w, cd_estabelecimento_w),1,15);

		CALL exec_sql_dinamico_bv('','update man_planej_data_prev set dt_prevista' || qt_controle_loop_w || ' = :dt_prevista, ' ||
					'ie_dia_util' ||  qt_controle_loop_w || ' = :ie_dia_util, dt_atualizacao = sysdate, nm_usuario = :nm_usuario where nr_sequencia = :nr_seq',
					'dt_prevista=' || to_char(dt_prevista_atual_w,'dd/mm/yyyy') || ds_sep_bv_w ||
					'ie_dia_util=' || ie_dia_util_w || ds_sep_bv_w ||
					'nm_usuario=' || nm_usuario_p || ds_sep_bv_w ||
					'nr_seq=' || nr_sequencia_p || ds_sep_bv_w);

		if (mod(qt_controle_loop_w,2) <> 0) then
			update	man_regra_data_frequencia
			set	dt_geracao		= dt_prevista_atual_w,
				dt_atualizacao		= clock_timestamp(),
				nm_usuario		= nm_usuario_p
			where	ie_data_hora		= 'D'
			and	nr_seq_planej_prev	= nr_seq_planej_prev_p
			and	nr_seq_equipamento	= nr_seq_equipamento_w
			and	dt_geracao		= dt_prevista_ant_w;
		elsif (mod(qt_controle_loop_w,2) = 0) then
			update	man_regra_data_frequencia
			set	dt_inicio_desejado	= dt_prevista_atual_w,
				dt_atualizacao		= clock_timestamp(),
				nm_usuario		= nm_usuario_p
			where	ie_data_hora		= 'D'
			and	nr_seq_planej_prev	= nr_seq_planej_prev_p
			and	nr_seq_equipamento	= nr_seq_equipamento_w
			and	dt_inicio_desejado	= dt_prevista_ant_w;
		end if;

		CALL man_gerar_planej_preventivo(nm_usuario_p, nr_seq_equipamento_w, nr_seq_planej_prev_p, dt_prevista_ant_w, dt_prevista_atual_w);

		qt_controle_loop_w := qt_controle_loop_w + 1;
		end;
	end loop;
	commit;
	exception
	when others then
		null;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_recalc_dt_preventiva_prev ( nr_sequencia_p bigint, nr_seq_planej_prev_p bigint, qt_dia_p bigint, nm_usuario_p text) FROM PUBLIC;

