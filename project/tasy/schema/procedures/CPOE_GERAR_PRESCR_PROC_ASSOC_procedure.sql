-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_prescr_proc_assoc ( nr_sequencia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

									
nr_sequencia_w				cpoe_procedimento.nr_sequencia%type;
cd_estabelecimento_w		smallint;
qt_idade_pac_w				double precision;
ie_sexo_prescr_w			varchar(1);
ds_mat_adic_proc_w			varchar(20) := 'X';			
qt_idade_mes_w				double precision;
qt_idade_dia_w				double precision;
nr_seq_proc_int_adic_w 		proc_int_proc_prescr.nr_seq_proc_int_adic%type;
ie_origen_proced_w			bigint;
qt_proc_adic_w				double precision;
nm_usuario_w				varchar(15);
ie_agenda_integrada_w		varchar(7);
cd_intervalo_w				varchar(7);
cd_intervalo_padr_w			varchar(7);
ds_dado_clinico_w			cpoe_procedimento.ds_dado_clinico%type;
cd_material_exame_w			cpoe_procedimento.cd_material_exame%type;
cd_plano_w					varchar(20);
ie_urgencia_w				cpoe_procedimento.ie_urgencia%type;
cd_edicao_amb_w				bigint;
ds_horarios_w				cpoe_procedimento.ds_horarios%type;
nr_ocorrencia_w				cpoe_procedimento.nr_ocorrencia%type;
nr_atendimento_w			cpoe_procedimento.nr_atendimento%type;
dt_prev_execucao_w			cpoe_procedimento.dt_prev_execucao%type;
cd_convenio_w				integer;
ie_origem_proc_filtro_w		bigint;
ie_tipo_atendimento_w		smallint;
ie_tipo_convenio_w			smallint;
cd_categoria_w				varchar(10);
cd_medico_w					cpoe_procedimento.cd_medico%type;
cd_setor_prescr_proc_w		integer;
ie_proced_vinculado_w		varchar(1);
ie_lado_w					cpoe_procedimento.ie_lado%type;
ds_observacao_w				cpoe_procedimento.ds_observacao%type;
ie_cobra_paciente_w			varchar(1);
nr_seq_contraste_w			cpoe_procedimento.nr_seq_contraste%type;
ds_justificativa_w			cpoe_procedimento.ds_justificativa%type;
ie_anestesia_w				cpoe_procedimento.ie_anestesia%type;
cd_pessoa_fisica_w 			cpoe_procedimento.cd_pessoa_fisica%type;	

dt_inicio_w					cpoe_procedimento.dt_inicio%type;
ie_duracao_w				cpoe_procedimento.ie_duracao%type;
ie_se_necessario_w			cpoe_procedimento.ie_se_necessario%type;
ie_acm_w					cpoe_procedimento.ie_acm%type;
hr_prim_horario_w			cpoe_procedimento.hr_prim_horario%type;
cd_perfil_ativo_w			cpoe_procedimento.cd_perfil_ativo%type;
dt_atualizacao_nrec_w		cpoe_procedimento.dt_atualizacao_nrec%type;
nm_usuario_nrec_w			cpoe_procedimento.nm_usuario_nrec%type;
ie_futuro_w					cpoe_procedimento.ie_futuro%type;
ie_nivel_atencao_w			cpoe_procedimento.ie_nivel_atencao%type;	
ie_oncologia_w				cpoe_procedimento.ie_oncologia%type;
ie_item_alta_w				cpoe_procedimento.ie_item_alta%type;
cd_funcao_origem_w			cpoe_procedimento.cd_funcao_origem%type;
ie_retrogrado_w				cpoe_procedimento.ie_retrogrado%type;
dt_fim_w					cpoe_procedimento.dt_fim%type;
ie_administracao_w    		cpoe_procedimento.ie_administracao%type;
ie_evento_unico_w     		cpoe_procedimento.ie_evento_unico%type;
nr_seq_cpoe_order_unit_w	cpoe_procedimento.nr_seq_cpoe_order_unit%type;
ie_segunda_w				cpoe_procedimento.ie_segunda%type;
ie_terca_w					cpoe_procedimento.ie_terca%type;
ie_quarta_w					cpoe_procedimento.ie_quarta%type;
ie_quinta_w					cpoe_procedimento.ie_quinta%type;
ie_sexta_w					cpoe_procedimento.ie_sexta%type;
ie_sabado_w					cpoe_procedimento.ie_sabado%type;
ie_domingo_w				cpoe_procedimento.ie_domingo%type;

C01 CURSOR FOR
	SELECT	
			a.nr_seq_proc_int_adic,
			coalesce(a.qt_proc_adic, p.qt_procedimento),
			p.nm_usuario,
			p.cd_intervalo,
			p.ds_dado_clinico,
			m.cd_material_exame,
			p.ds_horarios,
			p.nr_ocorrencia,
			coalesce(a.ie_cobra_paciente,'S'),
			p.dt_prev_execucao,
			a.ie_origem_proced,
			p.cd_medico,
			p.cd_setor_atendimento,
			a.ie_proced_vinculado,
			p.ie_lado,
			substr(a.ds_observacao || '  ' || p.ds_observacao,1,255),
			a.cd_intervalo,
			p.ie_urgencia,
			a.ie_agenda_integrada,
			p.nr_seq_contraste,
			p.ds_justificativa,
			p.ie_anestesia,
			p.ie_duracao
	FROM cpoe_procedimento p, proc_int_proc_prescr a
LEFT OUTER JOIN material_exame_lab m ON (a.nr_seq_material = m.nr_sequencia)
WHERE 1 = 1  and ((coalesce(a.cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_w)) and ((coalesce(a.ie_permite_duplicado,'N')	= 'S') or 
			 (not exists(	SELECT	1
							from	cpoe_procedimento b
							where	1 = 1
							and		((coalesce(a.nr_seq_proc_int_adic,0) = 0) or (b.nr_seq_proc_interno = a.nr_seq_proc_int_adic))	
							and		p.nm_usuario =  nm_usuario_p					   
							and		coalesce(b.dt_liberacao::text, '') = ''
							and		b.nr_atendimento =  nr_atendimento_w))) and (((coalesce(qt_idade_pac_w::text, '') = '') or (coalesce(a.qt_idade_min::text, '') = '' and coalesce(a.qt_idade_max::text, '') = '')) or
			 ((qt_idade_pac_w IS NOT NULL AND qt_idade_pac_w::text <> '') and (qt_idade_pac_w between coalesce(a.qt_idade_min,qt_idade_pac_w) and coalesce(a.qt_idade_max,qt_idade_pac_w)))) and ( ((coalesce(qt_idade_mes_w::text, '') = '') or (coalesce(a.qt_idade_mes_min::text, '') = '' and coalesce(a.qt_idade_mes_max::text, '') = '')) or (qt_idade_mes_w between coalesce(a.qt_idade_min,qt_idade_pac_w) * 12 + coalesce(a.qt_idade_mes_min,qt_idade_mes_w) and coalesce(a.qt_idade_max,qt_idade_pac_w) * 12 + coalesce(a.qt_idade_mes_max,qt_idade_mes_w))) and ((ie_sexo = ie_sexo_prescr_w) or (coalesce(ie_sexo::text, '') = '')) and coalesce(a.cd_convenio,cd_convenio_w) = cd_convenio_w and ((coalesce(a.cd_edicao_amb::text, '') = '') or (a.cd_edicao_amb = cd_edicao_amb_w)) and ((coalesce(a.cd_convenio_excluir::text, '') = '') or (a.cd_convenio_excluir <> cd_convenio_w)) and ((coalesce(a.cd_categoria_convenio::text, '') = '') or (a.cd_categoria_convenio = cd_categoria_w)) and ((a.cd_plano_convenio	= cd_plano_w) or (coalesce(a.cd_plano_convenio::text, '') = '')) and ((coalesce(a.cd_medico_prescritor::text, '') = '') or (a.cd_medico_prescritor = p.cd_medico)) and ((coalesce(a.cd_medico_excluir::text, '') = '') or (a.cd_medico_excluir <> p.cd_medico)) and ((a.ie_origem_proc_filtro = ie_origem_proc_filtro_w) or (coalesce(a.ie_origem_proc_filtro::text, '') = '')) and obter_conv_excluir_proc_assoc(a.nr_sequencia, cd_convenio_w, cd_edicao_amb_w, ie_origem_proc_filtro_w) = 'S' and ((coalesce(cd_perfil::text, '') = '') or (cd_perfil = obter_perfil_ativo)) and coalesce(a.ie_situacao,'A')	= 'A' and coalesce(a.ie_somente_agenda_int,'N') = 'N' and coalesce(a.ie_somente_agenda_cir,'N') = 'N' and a.nr_seq_proc_interno	= p.nr_seq_proc_interno and p.nr_sequencia		= nr_sequencia_p and coalesce(a.ie_tipo_convenio,ie_tipo_convenio_w)      = ie_tipo_convenio_w and allow_generate_assoc_amount(p.nr_atendimento,a.NR_SEQ_PROC_INT_ADIC,a.QT_PRESCRICAO_MAX)='S';
	
	
	
BEGIN
	
		cd_estabelecimento_w := cd_estabelecimento_p;
		
		
		select	nr_atendimento,
				dt_inicio,
				ie_se_necessario,
				ie_acm,
				hr_prim_horario,
				cd_perfil_ativo,
				cd_pessoa_fisica,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ie_futuro,
				ie_nivel_atencao,
				ie_oncologia,
				ie_item_alta,
				cd_funcao_origem,
				ie_retrogrado,
				dt_fim,
				ie_administracao,
				ie_evento_unico,
				nr_seq_cpoe_order_unit,
				ie_segunda,
				ie_terca,
				ie_quarta,
				ie_quinta,
				ie_sexta,
				ie_sabado,
				ie_domingo
		into STRICT	nr_atendimento_w,
				dt_inicio_w,
				ie_se_necessario_w,
				ie_acm_w,
				hr_prim_horario_w,
				cd_perfil_ativo_w,
				cd_pessoa_fisica_w,
				dt_atualizacao_nrec_w,
				nm_usuario_nrec_w,
				ie_futuro_w,
				ie_nivel_atencao_w,
				ie_oncologia_w,
				ie_item_alta_w,
				cd_funcao_origem_w,
				ie_retrogrado_w,
				dt_fim_w,
				ie_administracao_w,
				ie_evento_unico_w,
				nr_seq_cpoe_order_unit_w,
				ie_segunda_w,
				ie_terca_w,	
				ie_quarta_w,	
				ie_quinta_w,	
				ie_sexta_w,	
				ie_sabado_w,	
				ie_domingo_w
		from	cpoe_procedimento
		where	nr_sequencia = nr_sequencia_p;

		
		select	coalesce((obter_idade(dt_nascimento, clock_timestamp(), 'A'))::numeric ,0) qt_idade_ano,
				coalesce((obter_idade(dt_nascimento, clock_timestamp(), 'M'))::numeric ,0) qt_idade_mes,
				coalesce((obter_idade(dt_nascimento, clock_timestamp(), 'DIA'))::numeric ,0) qt_idade_dia
		into STRICT	qt_idade_pac_w,
				qt_idade_mes_w,
				qt_idade_dia_w
		from	pessoa_fisica
		where	cd_pessoa_fisica = cd_pessoa_fisica_w;
		
		select 	coalesce(max(obter_convenio_atendimento(nr_atendimento_w)),0),
				coalesce(max(obter_categoria_atendimento(nr_atendimento_w)),0)
		into STRICT	cd_convenio_w,
				cd_categoria_w
		;

		select	max(Obter_Plano_Atendimento(nr_atendimento_w,'C'))
		into STRICT	cd_plano_w
		;

		select 	max(ie_tipo_convenio)
		into STRICT	ie_tipo_convenio_w
		from 	convenio
		where 	cd_convenio = cd_convenio_w;
		
		select 	max(ie_tipo_atendimento)
		into STRICT	ie_tipo_atendimento_w
		from 	atendimento_paciente
		where 	nr_atendimento = nr_atendimento_w;

		ie_origem_proc_filtro_w:= Obter_Origem_Proced_Cat(cd_estabelecimento_w, ie_tipo_atendimento_w, ie_tipo_convenio_w, cd_convenio_w, cd_categoria_w);
		
		select	coalesce(max(cd_edicao_amb),0)
		into STRICT	cd_edicao_amb_w
		from 	convenio_amb
		where (cd_estabelecimento     = cd_estabelecimento_w)
		and (cd_convenio            = cd_convenio_w)
		and (coalesce(ie_situacao,'A')   = 'A')
		and		((coalesce(cd_categoria_w,'0') = '0') or (cd_categoria = cd_categoria_w))
		and 	(dt_inicio_vigencia     =
				(SELECT	max(dt_inicio_vigencia)
				from 	convenio_amb a	
				where (a.cd_estabelecimento  	= cd_estabelecimento_w)
				and (a.cd_convenio         	= cd_convenio_w)
				and (coalesce(a.ie_situacao,'A')	= 'A')
				and	((coalesce(cd_categoria_w,'0') = '0') or (a.cd_categoria = cd_categoria_w))
				and (a.dt_inicio_vigencia 	<=  clock_timestamp())));
		
		open C01;
		loop
		fetch C01 into		
			nr_seq_proc_int_adic_w,
			qt_proc_adic_w,
			nm_usuario_w,
			cd_intervalo_w,
			ds_dado_clinico_w,
			cd_material_exame_w,
			ds_horarios_w,
			nr_ocorrencia_w,
			ie_cobra_paciente_w,
			dt_prev_execucao_w,
			ie_origen_proced_w,
			cd_medico_w,
			cd_setor_prescr_proc_w,
			ie_proced_vinculado_w,
			ie_lado_w,
			ds_observacao_w,
			cd_intervalo_padr_w,
			ie_urgencia_w,
			ie_agenda_integrada_w,
			nr_seq_contraste_w,
			ds_justificativa_w,
			ie_anestesia_w,
			ie_duracao_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
		
		begin
		
		
		
			select	nextval('cpoe_procedimento_seq')
			into STRICT	nr_sequencia_w
			;
																	
			insert	into cpoe_procedimento(
					nr_sequencia,
					nr_seq_proc_interno,
					qt_procedimento,
					dt_atualizacao,
					nm_usuario,
					dt_prev_execucao,
					ie_se_necessario,
					ie_acm,
					nr_ocorrencia,
					cd_medico,
					ie_lado,
					ds_observacao,
					ds_justificativa,
					ie_duracao,
					ds_horarios,
					nr_atendimento,
					dt_inicio,
					hr_prim_horario,
					cd_perfil_ativo,
					cd_pessoa_fisica,
					ds_dado_clinico,
					nr_seq_contraste,
					cd_intervalo,
					ie_urgencia,
					nm_usuario_nrec,
					dt_atualizacao_nrec,
					ie_anestesia,
					cd_material_exame,
					cd_setor_atendimento,
					nr_seq_proc_princ,
					ie_exame_assoc,
					ie_cobra_paciente,
					ie_futuro,
					ie_nivel_atencao,
					ie_oncologia,
					ie_item_alta,
					cd_funcao_origem,
					ie_retrogrado,
					dt_fim,
					ie_administracao,
					ie_evento_unico,
					nr_seq_cpoe_order_unit,
					ie_segunda,
					ie_terca,
					ie_quarta,
					ie_quinta,
					ie_sexta,
					ie_sabado,
					ie_domingo
					)
				values (
					nr_sequencia_w,
					nr_seq_proc_int_adic_w,
					qt_proc_adic_w,
					clock_timestamp(),
					nm_usuario_w,
					dt_prev_execucao_w,
					ie_se_necessario_w,
					ie_acm_w,
					nr_ocorrencia_w,
					cd_medico_w,
					ie_lado_w,
					ds_observacao_w,
					ds_justificativa_w,
					ie_duracao_w,
					ds_horarios_w,
					nr_atendimento_w,
					dt_inicio_w,
					hr_prim_horario_w,
					cd_perfil_ativo_w,
					cd_pessoa_fisica_w,
					ds_dado_clinico_w,
					nr_seq_contraste_w,
					coalesce(cd_intervalo_padr_w, cd_intervalo_w),
					ie_urgencia_w,
					nm_usuario_nrec_w,
					dt_atualizacao_nrec_w,
					ie_anestesia_w,
					cd_material_exame_w,
					cd_setor_prescr_proc_w,
					CASE WHEN ie_proced_vinculado_w='S' THEN  nr_sequencia_p  ELSE null END ,
					CASE WHEN ie_agenda_integrada_w='S' THEN  'A'  ELSE 'S' END ,
					ie_cobra_paciente_w,
					ie_futuro_w,
					ie_nivel_atencao_w,
					ie_oncologia_w,
					ie_item_alta_w,
					cd_funcao_origem_w,
					ie_retrogrado_w,
					dt_fim_w,
					ie_administracao_w,
					ie_evento_unico_w,
					nr_seq_cpoe_order_unit_w,
					ie_segunda_w,
					ie_terca_w,
					ie_quarta_w,
					ie_quinta_w,
					ie_sexta_w,
					ie_sabado_w,
					ie_domingo_w
					);
									
				ds_mat_adic_proc_w := cpoe_gerar_med_mat_assoc(	nr_atendimento_w, nr_sequencia_w, nr_seq_proc_int_adic_w, ie_origen_proced_w, nr_seq_proc_int_adic_w, cd_estabelecimento_w, cd_perfil_ativo_w, nm_usuario_p, cd_pessoa_fisica_w, qt_idade_dia_w, qt_idade_mes_w, qt_idade_pac_w, cd_setor_prescr_proc_w, ie_tipo_atendimento_w, cd_convenio_w, cd_medico_w, dt_prev_execucao_w, coalesce(cd_intervalo_padr_w, cd_intervalo_w), ie_urgencia_w, 0, 0, ds_horarios_w, nr_ocorrencia_w, ds_mat_adic_proc_w, 0);
			
			

		end;
		end loop;
		close C01;	
	commit;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_prescr_proc_assoc ( nr_sequencia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

