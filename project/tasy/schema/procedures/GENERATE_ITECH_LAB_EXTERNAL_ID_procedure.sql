-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE generate_itech_lab_external_id ( nr_prescricao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_external_order_w			varchar(20);
nr_serial_w					varchar(20) := 0;
nr_seq_interno_w			bigint;
qt_exist_integration_w		bigint;


c01 CURSOR FOR
SELECT	a.nr_seq_interno
from	prescr_procedimento a,
		cpoe_procedimento b,
		cpoe_order_unit c,
		cpoe_tipo_pedido d
where	a.nr_prescricao 			=  nr_prescricao_p
and		b.nr_sequencia      		= a.nr_seq_proc_cpoe
and		c.nr_sequencia				= b.nr_seq_cpoe_order_unit
and		c.nr_seq_cpoe_tipo_pedido   = d.nr_sequencia
and		d.nr_seq_sub_grp            in ('L','B','P');


BEGIN

select	coalesce(max(1),0)
into STRICT	qt_exist_integration_w
from 	regra_controle_prescr where   	cd_estabelecimento = cd_estabelecimento_p
and   	nr_seq_interf_equip = 7575 --ITECH
and   	coalesce(ie_integracao,'N') = 'S' LIMIT 1;

if (qt_exist_integration_w = 1) then
	begin	
	
	open c01;
	loop
	fetch c01 into
		nr_seq_interno_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

	if (nr_serial_w = 0) then
		nr_serial_w := generate_int_serial_number(0, 'ITECH_ORDER', cd_estabelecimento_p, nm_usuario_p, nr_serial_w, 940); --940 - ITECH - Sample Order Information
	end if;
	
	select 	x.ie_sample || x.ie_origin || x.dt_year || x.dt_month || x.dt_day || x.nr_serial || x.ie_preliminary
	into STRICT 	nr_external_order_w
	from (
	SELECT 'E0' ie_sample,
			CASE WHEN existe_login_usuario(upper(b.nm_usuario))='S' THEN 2  ELSE 1 END  ie_origin,
			to_char(clock_timestamp(),'YY') dt_year,
			to_char(clock_timestamp(),'MM') dt_month,
			to_char(clock_timestamp(),'DD') dt_day,
			lpad(nr_serial_w,4,'0') nr_serial,
			'00' ie_preliminary
	from 	prescr_medica b
	where 	b.nr_prescricao = nr_prescricao_p) x;
		
	
	if (length(nr_external_order_w) = 15) then
		begin
		
		update	prescr_medica
		set		nr_controle_lab = nr_external_order_w
		where	nr_prescricao 	= nr_prescricao_p;


		select	x.dt_month || x.dt_day || x.nr_serial || x.nr_load_number || x.cd_collection || x.nr_check_digit
		into STRICT	nr_external_order_w
		from (
		SELECT  to_char(clock_timestamp(),'MM') dt_month,
				to_char(clock_timestamp(),'DD') dt_day,
				lpad(nr_serial_w,4,'0') nr_serial,
				'00' nr_load_number,
				'000' cd_collection,
				b.nr_sequencia nr_check_digit
		from  	prescr_procedimento b
		where 	b.nr_seq_interno = nr_seq_interno_w) x;

		update	prescr_procedimento
		set		nr_seq_lab_ext	= nr_external_order_w
		where	nr_seq_interno	= nr_seq_interno_w;
		
			end;
		end if;
	end loop;
	close c01;
		
	commit;

	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE generate_itech_lab_external_id ( nr_prescricao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

