-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicar_laudo_compl_peca ( nr_seq_laudo_p bigint, ds_lista_p text, nm_usuario_p text, nr_seq_laudo_novo_p INOUT text) AS $body$
DECLARE



nr_seq_laudo_novo_w	bigint;
nr_seq_peca_w		bigint;
ds_lista_w		varchar(255);

ie_pos_virgula_w	bigint;
tam_lista_w		bigint;



BEGIN

select 	nextval('laudo_paciente_seq')
into STRICT 	nr_seq_laudo_novo_w
;

insert into laudo_paciente(	nr_sequencia,
				nr_atendimento,
				dt_entrada_unidade,
				nr_laudo,
				nm_usuario,
				dt_atualizacao,
				cd_medico_resp,
				ds_titulo_laudo,
				dt_laudo,
				cd_laudo_padrao,
				ie_normal,
				dt_exame,
				nr_prescricao,
				ds_laudo,
				cd_protocolo,
				cd_projeto,
				nr_seq_proc,
				nr_seq_prescricao,
				dt_prev_entrega,
				dt_real_entrega,
				qt_imagem,
				nr_seq_superior,
				nr_exame)
				SELECT	nr_seq_laudo_novo_w,
					nr_atendimento,
					dt_entrada_unidade,
					nr_seq_laudo_novo_w,
					nm_usuario_p,
					clock_timestamp(),
					cd_medico_resp,
					ds_titulo_laudo,
					dt_laudo,
					cd_laudo_padrao,
					ie_normal,
					dt_exame,
					nr_prescricao,
					null,
					cd_protocolo,
					cd_projeto,
					nr_seq_proc,
					nr_seq_prescricao,
					dt_prev_entrega,
					dt_real_entrega,
					qt_imagem,
					nr_seq_laudo_p,
					nr_exame
				from laudo_paciente
				where nr_sequencia = nr_seq_laudo_p;

CALL Vincular_Procedimento_Laudo(nr_seq_laudo_novo_w,'N',nm_usuario_p);



ds_lista_w := ds_lista_p;
while(ds_lista_w IS NOT NULL AND ds_lista_w::text <> '')  loop
	begin

	tam_lista_w	 := length(ds_lista_w);
	ie_pos_virgula_w := position(',' in ds_lista_w);

	if (ie_pos_virgula_w <> 0) then
		nr_seq_peca_w	:= (substr(ds_lista_w,1,(ie_pos_virgula_w - 1)))::numeric;
		ds_lista_w	:= substr(ds_lista_w,(ie_pos_virgula_w + 1),tam_lista_w);
	end if;

	if (nr_seq_peca_w IS NOT NULL AND nr_seq_peca_w::text <> '') then


		insert into 	prescr_proc_peca_laudo(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_peca,
				nr_seq_laudo
				)
		values (
				nextval('prescr_proc_peca_laudo_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_peca_w,
				nr_seq_laudo_novo_w
				);


	end if;

	end;
	end loop;


nr_seq_laudo_novo_p := nr_seq_laudo_novo_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_laudo_compl_peca ( nr_seq_laudo_p bigint, ds_lista_p text, nm_usuario_p text, nr_seq_laudo_novo_p INOUT text) FROM PUBLIC;

