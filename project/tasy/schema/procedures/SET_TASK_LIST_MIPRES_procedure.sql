-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE set_task_list_mipres ( ie_acao_p WL_ITEM.CD_CATEGORIA%TYPE, nr_atendimento_p WL_WORKLIST.NR_ATENDIMENTO%TYPE, nr_prescricao_p WL_WORKLIST.NR_PRESCRICAO%TYPE, nr_seq_prescr_mipres_p WL_WORKLIST.NR_SEQ_PRESCR_MIPRES%TYPE, nm_usuario_p WL_WORKLIST.NM_USUARIO%TYPE) AS $body$
DECLARE


count_rules_w   WL_ITEM.NR_SEQUENCIA%TYPE;
qt_tempo_pa_w   WL_REGRA_ITEM.QT_TEMPO_NORMAL%TYPE;
nr_seq_regra_wl_pa_w  WL_REGRA_ITEM.NR_SEQUENCIA%TYPE;
cd_paciente_w   ATENDIMENTO_PACIENTE.CD_PESSOA_FISICA%TYPE;
nr_seq_tipo_adm_fat_atd_w ATENDIMENTO_PACIENTE.NR_SEQ_TIPO_ADMISSAO_FAT%TYPE;
ie_tipo_atendimento_w ATENDIMENTO_PACIENTE.IE_TIPO_ATENDIMENTO%TYPE;
nr_seq_episodio_w ATENDIMENTO_PACIENTE.NR_SEQ_EPISODIO%TYPE;


BEGIN
    SELECT
        coalesce(max(b.qt_tempo_normal),0),
        coalesce(max(b.nr_sequencia), 0)
    INTO STRICT
        qt_tempo_pa_w,
        nr_seq_regra_wl_pa_w
    FROM  wl_regra_worklist a,
        wl_regra_item b
    WHERE a.nr_sequencia = b.nr_seq_regra
    AND   b.ie_situacao = 'A'
    AND   a.nr_seq_item = ( SELECT  max(x.nr_sequencia)
                  from  wl_item x
                  WHERE x.nr_sequencia = a.nr_seq_item
                  AND   x.cd_categoria = 'PM'
                  AND   x.ie_situacao = 'A');


    select  max(cd_pessoa_fisica),
            max(nr_seq_tipo_admissao_fat),
            max(ie_tipo_atendimento),
            max(nr_seq_episodio)
    into STRICT    cd_paciente_w,
            nr_seq_tipo_adm_fat_atd_w,
            ie_tipo_atendimento_w,
            nr_seq_episodio_w
    from    atendimento_paciente
    where   nr_atendimento = nr_atendimento_p;

    IF (nr_seq_regra_wl_pa_w IS NOT NULL AND nr_seq_regra_wl_pa_w::text <> '') THEN
      IF (obter_se_regra_geracao(nr_seq_regra_wl_pa_w,nr_seq_episodio_w,nr_seq_tipo_adm_fat_atd_w) = 'S') THEN
        CALL wl_gerar_finalizar_tarefa(
            'PM',
            ie_acao_p,
            nr_atendimento_p,
            cd_paciente_w,
            nm_usuario_p,
            clock_timestamp()+(qt_tempo_pa_w/24),
            'N',
            null,null,null,
            nr_prescricao_p,
            null,null,null,null,null,
            nr_seq_regra_wl_pa_w,
            null,null,null,null,null,null,null,
            clock_timestamp(),
            nr_seq_episodio_w,
            null,
            obter_pf_usuario(wheb_usuario_pck.get_nm_usuario(), 'C'),
            null,null,null,null,null,null,
            nr_seq_prescr_mipres_p);
      END IF;
    END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE set_task_list_mipres ( ie_acao_p WL_ITEM.CD_CATEGORIA%TYPE, nr_atendimento_p WL_WORKLIST.NR_ATENDIMENTO%TYPE, nr_prescricao_p WL_WORKLIST.NR_PRESCRICAO%TYPE, nr_seq_prescr_mipres_p WL_WORKLIST.NR_SEQ_PRESCR_MIPRES%TYPE, nm_usuario_p WL_WORKLIST.NM_USUARIO%TYPE) FROM PUBLIC;

