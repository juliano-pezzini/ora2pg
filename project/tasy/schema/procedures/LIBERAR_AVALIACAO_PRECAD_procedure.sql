-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_avaliacao_precad (nr_seq_avaliacao_p bigint, nr_seq_processo_precad_p bigint, ie_tipo_pre_cadastro_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


qtd_regras_aprovadas_w		smallint := null;
qtd_regras_disponiveis_w	smallint := null;
ie_tipo_pessoa_w			smallint := null;
													

BEGIN							

	
	update pre_cad_avaliacao set dt_liberacao = clock_timestamp(), nm_usuario_lib = nm_usuario_p where nr_sequencia = nr_seq_avaliacao_p;

	select coalesce(obter_tipo_pessoa_fis_precad(nr_seq_processo_precad_p, ie_tipo_pre_cadastro_p, nm_usuario_p), 0)
	into STRICT ie_tipo_pessoa_w
	;
				
	
   select obter_qtd_niveis_regra_pre_cad(ie_tipo_pre_cadastro_p, ie_tipo_pessoa_w, nm_usuario_p)
   into STRICT qtd_regras_disponiveis_w
;
	
	if (ie_tipo_pre_cadastro_p = 'FPF') then
		select count(*)
		into STRICT qtd_regras_aprovadas_w
		from pre_cad_avaliacao
		where nr_seq_precad_pf = nr_seq_processo_precad_p
        	  and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') and coalesce(dt_reprovacao::text, '') = '';
	elsif (ie_tipo_pre_cadastro_p = 'FPJ') then
		select count(*)
		into STRICT qtd_regras_aprovadas_w
		from pre_cad_avaliacao 
		where nr_seq_precad_pj = nr_seq_processo_precad_p 
		      and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') and coalesce(dt_reprovacao::text, '') = '';
	else
		select count(*)
		into STRICT qtd_regras_aprovadas_w
		from pre_cad_avaliacao 
		where nr_seq_precad_mat = nr_seq_processo_precad_p 
		      and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') and coalesce(dt_reprovacao::text, '') = '';
	end if;
	
	if ((qtd_regras_aprovadas_w IS NOT NULL AND qtd_regras_aprovadas_w::text <> '' AND qtd_regras_disponiveis_w IS NOT NULL AND qtd_regras_disponiveis_w::text <> '') and qtd_regras_aprovadas_w <> qtd_regras_disponiveis_w) then
	
		CALL criar_avaliacao_pre_cadastro(nr_seq_processo_precad_p,
							ie_tipo_pre_cadastro_p,
							'N',
							cd_estabelecimento_p,
							nm_usuario_p);
	
	end if;
	
	commit;
			
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_avaliacao_precad (nr_seq_avaliacao_p bigint, nr_seq_processo_precad_p bigint, ie_tipo_pre_cadastro_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

