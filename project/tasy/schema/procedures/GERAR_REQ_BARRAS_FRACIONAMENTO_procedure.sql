-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_req_barras_fracionamento ( nr_requisicao_p requisicao_material.nr_requisicao%type, cd_barras_frac_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_seq_etiqueta_w		adep_processo_frac.nr_sequencia%type;
nr_sequencia_w		item_requisicao_material.nr_sequencia%type;
cd_material_w		material.cd_material%type;
qt_dispensar_hor_w		prescr_mat_hor.qt_dispensar_hor%type;
cd_unidade_medida_consumo_w	varchar(30);
cd_unidade_medida_estoque_w	varchar(30);
qt_existe_w			bigint;

C01 CURSOR FOR
	SELECT	cd_material,
		qt_dispensar_hor,
		substr(obter_dados_material_estab(cd_material,cd_estabelecimento_p,'UMS'),1,30) cd_unidade_medida_consumo,
		substr(obter_dados_material_estab(cd_material,cd_estabelecimento_p,'UME'),1,30) cd_unidade_medida_estoque
	from	prescr_mat_hor
	where	(nr_seq_etiqueta IS NOT NULL AND nr_seq_etiqueta::text <> '')
	and	nr_seq_etiqueta = nr_seq_etiqueta_w
	and	qt_dispensar_hor > 0;

BEGIN

nr_seq_etiqueta_w := substr(cd_barras_frac_p, 2, 10);

if (nr_requisicao_p IS NOT NULL AND nr_requisicao_p::text <> '') then
	open C01;
	loop
	fetch C01 into
		cd_material_w,
		qt_dispensar_hor_w,
		cd_unidade_medida_consumo_w,
		cd_unidade_medida_estoque_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		select	coalesce(max(nr_sequencia),0) +1
		into STRICT	nr_sequencia_w
		from	item_requisicao_material
		where	nr_requisicao = nr_requisicao_p;

		insert into item_requisicao_material(nr_requisicao,
			nr_sequencia,
			cd_estabelecimento,
			cd_material,
			qt_material_requisitada,
			qt_material_atendida,
			vl_material,
			dt_atualizacao,
			nm_usuario,
			cd_unidade_medida,
			qt_estoque,
			cd_unidade_medida_estoque,
			ie_acao,
			cd_motivo_baixa,
			cd_barras)
		values (	nr_requisicao_p,
			nr_sequencia_w,
			cd_estabelecimento_p,
			cd_material_w,
			qt_dispensar_hor_w,
			0,
			0,
			clock_timestamp(),
			nm_usuario_p,
			cd_unidade_medida_consumo_w,
			0,
			cd_unidade_medida_estoque_w,
			'1',
			0,
			cd_barras_frac_p);
		end;
	end loop;
	close C01;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_req_barras_fracionamento ( nr_requisicao_p requisicao_material.nr_requisicao%type, cd_barras_frac_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

