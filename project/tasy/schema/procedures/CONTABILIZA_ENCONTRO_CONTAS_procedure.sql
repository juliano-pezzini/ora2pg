-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE contabiliza_encontro_contas (nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text) AS $body$
DECLARE


ds_compl_historico_w                    w_movimento_contabil.ds_compl_historico%type;
cd_conta_deb_pls_w                      w_movimento_contabil.cd_conta_contabil%type;
cd_conta_contabil_w                     w_movimento_contabil.cd_conta_contabil%type := null;
cd_cgc_w                                w_movimento_contabil.cd_cgc%type;
cd_pessoa_fisica_w                      w_movimento_contabil.cd_pessoa_fisica%type;
vl_movimento_w                          w_movimento_contabil.vl_movimento%type;
nr_seq_lote_enc_contas_w                lote_encontro_contas.nr_sequencia%type;
nr_seq_agrupamento_w                    w_movimento_contabil.nr_seq_agrupamento%type;
nr_tit_rec_gerado_w                     titulo_receber.nr_titulo%type;
nr_tit_rec_baixado_w                    titulo_receber.nr_titulo%type;
nr_tit_pagar_gerado_w                   titulo_pagar.nr_titulo%type;
nr_tit_pagar_baixado_w                  titulo_pagar.nr_titulo%type;
nr_seq_mensalidade_w                    pls_mensalidade.nr_sequencia%type;
nr_sequencia_w                          w_movimento_contabil.nr_sequencia%type;
cd_historico_pls_w                      w_movimento_contabil.cd_historico%type;
cd_centro_custo_w                       w_movimento_contabil.cd_centro_custo%type;
cd_tipo_baixa_w                         titulo_pagar_baixa.cd_tipo_baixa%type;
cd_tipo_recebimento_w                   titulo_receber_liq.cd_tipo_recebimento%type;
cd_estab_movto_w                        w_movimento_contabil.cd_estabelecimento%type;
cd_estabelecimento_w                    estabelecimento.cd_estabelecimento%type;
cd_tipo_lote_contabil_w                 lote_contabil.cd_tipo_lote_contabil%type;
nr_seq_conta_banco_w                    titulo_receber.nr_seq_conta_banco%type;
ie_contab_classif_mens_w                pls_parametro_contabil.ie_contab_classif_mens%type;
cd_empresa_w                            empresa.cd_empresa%type;
nr_documento_ww                         movimento_contabil.nr_documento%type;
ie_origem_documento_w                   movimento_contabil.ie_origem_documento%type;
nr_seq_info_ctb_w                       informacao_contabil.nr_sequencia%type;
nm_tabela_w                             w_movimento_contabil.nm_tabela%type;
nm_atributo_w                           w_movimento_contabil.nm_atributo%type;
nr_seq_tab_orig_w                       w_movimento_contabil.nr_seq_tab_orig%type;
nr_seq_tab_compl_w                      w_movimento_contabil.nr_seq_tab_compl%type;
nr_pls_lote_camara_w                    pls_lote_camara_comp.nr_sequencia%type;
ie_origem_titulo_w                      titulo_receber.ie_origem_titulo%type;
ie_processo_camara_w                    pls_parametros_camara.ie_processo_camara%type;
nr_seq_nota_credito_w                   nota_credito.nr_sequencia%type;
ds_conteudo_w                           varchar(4000);
ds_atributos_w                          varchar(4000);
nm_agrupador_w                          varchar(255);
ds_erro_w                               varchar(255);
ie_regra_w                              varchar(255);
ds_pessoa_w                             varchar(80);
ie_permite_estab_dif_w                  varchar(15);
cd_conta_transitoria_w                  varchar(20);
ie_receber_pagar_w                      varchar(1);
ie_compl_hist_w                         varchar(1) := 'S';
vl_retorno_w                            double precision;
nr_titulo_w                             bigint;
nr_seq_trans_financ_w                   bigint;
cd_historico_ct_w                       bigint;
dt_contab_w                             timestamp;
dt_contabil_w                           timestamp;
ie_debito_credito_w                     w_movimento_contabil.ie_debito_credito%type;
nr_titulo_pagar_w                       titulo_receber_liq.nr_tit_pagar%type;
ie_tipo_lancamento_w                    pls_titulo_rec_liq_mens.ie_tipo_lancamento%type;

c01 CURSOR FOR
        SELECT  a.nr_titulo,
                'R' ie_receber_pagar,
                'VL_RECEBIDO_EC' nm_atributo,
                c.vl_recebido vl_movimento,
                a.dt_recebimento dt_contab,
                a.nr_seq_trans_fin,
                b.cd_estabelecimento,
                null nr_seq_mensalidade,
                null cd_conta_deb_pls,
                null cd_historico_pls,
                null cd_tipo_baixa,
                a.cd_tipo_recebimento,
                a.nr_seq_lote_enc_contas,
                c.cd_conta_contabil,
                a.nr_seq_conta_banco,
                b.cd_cgc,
                b.cd_pessoa_fisica,
                'TITULO_REC_LIQ_CC' nm_tabela,
                14 nr_seq_info_ctb,
                a.nr_sequencia nr_seq_tab_orig,
                a.nr_titulo nr_seq_tab_compl,
                null ie_debito_credito,
                b.ie_origem_titulo,
                coalesce(a.nr_seq_pls_lote_camara,b.nr_seq_pls_lote_camara),
                a.nr_tit_pagar
        from    titulo_receber_liq      a,
                titulo_receber          b,
                titulo_rec_liq_cc       c
        where   a.nr_titulo             = b.nr_titulo
        and     a.nr_titulo             = c.nr_titulo
        and     a.nr_sequencia          = c.nr_seq_baixa
        and     a.nr_lote_contabil      = nr_lote_contabil_p
        and     coalesce(a.ie_lib_caixa,'N') = 'S'
        and     coalesce(b.nr_seq_mensalidade::text, '') = ''
        and     coalesce(b.ie_pls,'N')       = 'N'

union all

        SELECT  a.nr_titulo,
                'R' ie_receber_pagar,
                'VL_FATURAMENTO_OPS_EC' nm_atributo,
                c.vl_recebido vl_movimento,
                a.dt_recebimento dt_contab,
                a.nr_seq_trans_fin,
                b.cd_estabelecimento,
                null nr_seq_mensalidade,
                null cd_conta_deb_pls,
                null cd_historico_pls,
                null cd_tipo_baixa,
                a.cd_tipo_recebimento,
                a.nr_seq_lote_enc_contas,
                c.cd_conta_contabil,
                a.nr_seq_conta_banco,
                b.cd_cgc,
                b.cd_pessoa_fisica,
                'TITULO_REC_LIQ_CC' nm_tabela,
                14 nr_seq_info_ctb,
                a.nr_sequencia nr_seq_tab_orig,
                a.nr_titulo nr_seq_tab_compl,
                null ie_debito_credito,
                b.ie_origem_titulo,
                coalesce(a.nr_seq_pls_lote_camara,b.nr_seq_pls_lote_camara),
                a.nr_tit_pagar
        from    titulo_receber_liq      a,
                titulo_receber          b,
                titulo_rec_liq_cc       c
        where   a.nr_titulo             = b.nr_titulo
        and     a.nr_titulo             = c.nr_titulo
        and     a.nr_sequencia          = c.nr_seq_baixa
        and     a.nr_lote_contabil      = nr_lote_contabil_p
        and     coalesce(a.ie_lib_caixa,'N') = 'S'
        and     ((ie_origem_classif = 'FO') or (b.ie_origem_titulo = 13 and (not exists (select 1 from pls_fatura w where (w.nr_titulo = b.nr_titulo or w.nr_titulo_ndc = b.nr_titulo)
        ))))
        
union all

        select  a.nr_titulo,
                'R' ie_receber_pagar,
                'VL_RECEBIDO_EC' nm_atributo,
                a.vl_recebido vl_movimento,
                a.dt_recebimento dt_contab,
                a.nr_seq_trans_fin,
                b.cd_estabelecimento,
                null nr_seq_mensalidade,
                null cd_conta_deb_pls,
                null cd_historico_pls,
                null cd_tipo_baixa,
                a.cd_tipo_recebimento,
                a.nr_seq_lote_enc_contas,
                null cd_conta_contabil,
                a.nr_seq_conta_banco,
                b.cd_cgc,
                b.cd_pessoa_fisica,
                'TITULO_RECEBER_LIQ' nm_tabela,
                14 nr_seq_info_ctb,
                a.nr_sequencia nr_seq_tab_orig,
                a.nr_titulo nr_seq_tab_compl,
                null ie_debito_credito,
                b.ie_origem_titulo,
                coalesce(a.nr_seq_pls_lote_camara,b.nr_seq_pls_lote_camara),
                a.nr_tit_pagar
        from    titulo_receber_liq      a,
                titulo_receber          b
        where   a.nr_titulo             = b.nr_titulo
        and     a.nr_lote_contabil      = nr_lote_contabil_p
        and     not exists (select 1
                                from    titulo_rec_liq_cc       c
                                where   a.nr_titulo             = c.nr_titulo)
        and     coalesce(a.ie_lib_caixa,'N') = 'S'
        and     coalesce(b.nr_seq_mensalidade::text, '') = ''
        and     ((coalesce(b.ie_pls,'N')     = 'N') or (b.nr_seq_lote_enc_contas IS NOT NULL AND b.nr_seq_lote_enc_contas::text <> ''))
        
union all

        select  b.nr_titulo,
                'R' ie_receber_pagar,
                'VL_RECEBIDO_EC' nm_atributo,
                a.vl_classificacao vl_movimento,
                b.dt_liquidacao dt_contab,
                b.nr_seq_trans_fin_baixa,
                b.cd_estabelecimento,
                null nr_seq_mensalidade,
                a.cd_conta_contabil cd_conta_deb_pls,
                null cd_historico_pls,
                null cd_tipo_baixa,
                null cd_tipo_recebimento,
                b.nr_seq_lote_enc_contas,
                null cd_conta_contabil,
                b.nr_seq_conta_banco,
                b.cd_cgc,
                b.cd_pessoa_fisica,
                'TITULO_RECEBER_CLASSIF' nm_tabela,
                65 nr_seq_info_ctb,
                a.nr_sequencia nr_seq_tab_orig,
                a.nr_titulo nr_seq_tab_compl,
                null ie_debito_credito,
                b.ie_origem_titulo,
                b.nr_seq_pls_lote_camara,
                null nr_tit_pagar
        from    titulo_receber_classif  a,
                titulo_receber          b
        where   a.nr_titulo             = b.nr_titulo
        and     b.nr_lote_contabil      = nr_lote_contabil_p
        and     coalesce(b.nr_seq_mensalidade::text, '') = ''
        and     b.ie_pls                = 'S'
        
union all

        select  a.nr_titulo,
                'R' ie_receber_pagar,
                'VL_RECEBIDO_EC' nm_atributo,
                sum(c.vl_recebido) vl_movimento,
                a.dt_recebimento dt_contab,
                a.nr_seq_trans_fin,
                b.cd_estabelecimento,
                b.nr_seq_mensalidade,
                coalesce(c.cd_conta_deb_pls, cd_conta_rec_pls),
                c.cd_historico_pls,
                null cd_tipo_baixa,
                a.cd_tipo_recebimento,
                a.nr_seq_lote_enc_contas,
                null cd_conta_contabil,
                a.nr_seq_conta_banco,
                b.cd_cgc,
                b.cd_pessoa_fisica,
                'TITULO_REC_LIQ_CC' nm_tabela,
                14 nr_seq_info_ctb,
                c.nr_sequencia nr_seq_tab_orig,
                c.nr_titulo nr_seq_tab_compl,
                'C' ie_debito_credito,
                b.ie_origem_titulo,
                coalesce(a.nr_seq_pls_lote_camara,b.nr_seq_pls_lote_camara),
                a.nr_tit_pagar
        from    titulo_rec_liq_cc       c,
                titulo_receber_liq      a,
                titulo_receber          b
        where   a.nr_titulo             = b.nr_titulo
        and     b.nr_titulo             = c.nr_titulo
        and     a.nr_sequencia          = c.nr_seq_baixa
        and     a.nr_lote_contabil      = nr_lote_contabil_p
        and     coalesce(a.ie_lib_caixa,'N') = 'S'
        and     (b.nr_seq_mensalidade IS NOT NULL AND b.nr_seq_mensalidade::text <> '')
        and     ie_contab_classif_mens_w        = 'N'
        group by
                a.nr_titulo,
                a.dt_recebimento,
                a.nr_seq_trans_fin,
                b.cd_estabelecimento,
                b.nr_seq_mensalidade,
                coalesce(c.cd_conta_deb_pls, cd_conta_rec_pls),
                c.cd_historico_pls,
                b.nr_seq_lote_enc_contas,
                a.cd_tipo_recebimento,
                a.nr_seq_lote_enc_contas,
                a.nr_seq_conta_banco,
                b.cd_cgc,
                b.cd_pessoa_fisica,
                c.nr_sequencia,
                c.nr_titulo,
                b.ie_origem_titulo,
                coalesce(a.nr_seq_pls_lote_camara,b.nr_seq_pls_lote_camara),
                a.nr_tit_pagar
        
union all

        select  a.nr_titulo,
                'R' ie_receber_pagar,
                'VL_RECEBIDO_EC' nm_atributo,
                sum(c.vl_lancamento) vl_movimento,
                c.dt_contabil dt_contab,
                a.nr_seq_trans_fin,
                b.cd_estabelecimento,
                b.nr_seq_mensalidade,
                c.cd_conta_debito,
                c.cd_historico,
                null cd_tipo_baixa,
                a.cd_tipo_recebimento,
                a.nr_seq_lote_enc_contas,
                null cd_conta_contabil,
                a.nr_seq_conta_banco,
                b.cd_cgc,
                b.cd_pessoa_fisica,
                'PLS_TITULO_REC_LIQ_MENS' nm_tabela,
                14 nr_seq_info_ctb,
                c.nr_sequencia nr_seq_tab_orig,
                c.nr_titulo nr_seq_tab_compl,
                'D' ie_debito_credito,
                b.ie_origem_titulo,
                coalesce(a.nr_seq_pls_lote_camara,b.nr_seq_pls_lote_camara),
                a.nr_tit_pagar
        from    pls_titulo_rec_liq_mens c,
                titulo_receber_liq      a,
                titulo_receber          b
        where   a.nr_titulo             = b.nr_titulo
        and     b.nr_titulo             = c.nr_titulo
        and     a.nr_sequencia          = c.nr_seq_baixa
        and     c.nr_lote_contabil      = nr_lote_contabil_p
        and     coalesce(a.ie_lib_caixa,'N') = 'S'
        and     (b.nr_seq_mensalidade IS NOT NULL AND b.nr_seq_mensalidade::text <> '')
        and     ((c.cd_conta_debito IS NOT NULL AND c.cd_conta_debito::text <> '')
        or (c.ie_tipo_lancamento = 'BA')
        or (not exists (    select  1
                                from    pls_titulo_rec_liq_mens z
                                where   b.nr_titulo             = z.nr_titulo
                                and     a.nr_sequencia          = z.nr_seq_baixa
                                and     z.ie_tipo_lancamento    = 'BA')))
        and     ie_contab_classif_mens_w        = 'S'
        group by
                a.nr_titulo,
                c.dt_contabil,
                a.nr_seq_trans_fin,
                b.cd_estabelecimento,
                b.nr_seq_mensalidade,
                c.cd_conta_debito,
                c.cd_historico,
                b.nr_seq_lote_enc_contas,
                a.cd_tipo_recebimento,
                a.nr_seq_lote_enc_contas,
                a.nr_seq_conta_banco,
                b.cd_cgc,
                b.cd_pessoa_fisica,
                c.nr_sequencia,
                c.nr_titulo,
                b.ie_origem_titulo,
                coalesce(a.nr_seq_pls_lote_camara,b.nr_seq_pls_lote_camara),
                a.nr_tit_pagar
        
union all

        select  a.nr_titulo,
                'R' ie_receber_pagar,
                'VL_RECEBIDO_EC' nm_atributo,
                sum(c.vl_lancamento) vl_movimento,
                c.dt_contabil dt_contab,
                a.nr_seq_trans_fin,
                b.cd_estabelecimento,
                b.nr_seq_mensalidade,
                c.cd_conta_credito,
                c.cd_historico,
                null cd_tipo_baixa,
                a.cd_tipo_recebimento,
                a.nr_seq_lote_enc_contas,
                null cd_conta_contabil,
                a.nr_seq_conta_banco,
                b.cd_cgc,
                b.cd_pessoa_fisica,
                'PLS_TITULO_REC_LIQ_MENS' nm_tabela,
                14 nr_seq_info_ctb,
                c.nr_sequencia nr_seq_tab_orig,
                c.nr_titulo nr_seq_tab_compl,
                'C' ie_debito_credito,
                b.ie_origem_titulo,
                coalesce(a.nr_seq_pls_lote_camara,b.nr_seq_pls_lote_camara),
                a.nr_tit_pagar
        from    pls_titulo_rec_liq_mens c,
                titulo_receber_liq      a,
                titulo_receber          b
        where   a.nr_titulo             = b.nr_titulo
        and     b.nr_titulo             = c.nr_titulo
        and     a.nr_sequencia          = c.nr_seq_baixa
        and     c.nr_lote_contabil      = nr_lote_contabil_p
        and     coalesce(a.ie_lib_caixa,'N') = 'S'
        and     (b.nr_seq_mensalidade IS NOT NULL AND b.nr_seq_mensalidade::text <> '')
        and     (c.cd_conta_credito IS NOT NULL AND c.cd_conta_credito::text <> '')
        and     ie_contab_classif_mens_w        = 'S'
        group by
                a.nr_titulo,
                c.dt_contabil,
                a.nr_seq_trans_fin,
                b.cd_estabelecimento,
                b.nr_seq_mensalidade,
                c.cd_conta_credito,
                c.cd_historico,
                b.nr_seq_lote_enc_contas,
                a.cd_tipo_recebimento,
                a.nr_seq_lote_enc_contas,
                a.nr_seq_conta_banco,
                b.cd_cgc,
                b.cd_pessoa_fisica,
                c.nr_sequencia,
                c.nr_titulo,
                b.ie_origem_titulo,
                coalesce(a.nr_seq_pls_lote_camara,b.nr_seq_pls_lote_camara),
                a.nr_tit_pagar
        
union all

        select  a.nr_titulo,
                'P' ie_receber_pagar,
                'VL_PAGO_EC' nm_atributo,
                coalesce(c.vl_baixa,a.vl_baixa) vl_movimento,
                a.dt_baixa dt_contab,
                a.nr_seq_trans_fin,
                b.cd_estabelecimento,
                null nr_seq_mensalidade,
                c.cd_conta_contabil cd_conta_deb_pls,
                null cd_historico_pls,
                a.cd_tipo_baixa,
                null,
                a.nr_seq_lote_enc_contas,
                c.cd_conta_contabil cd_conta_contabil,
                a.nr_seq_conta_banco,
                b.cd_cgc,
                b.cd_pessoa_fisica,
                'TITULO_PAGAR_BAIXA' nm_tabela,
                13 nr_seq_info_ctb,
                a.nr_sequencia nr_seq_tab_orig,
                a.nr_titulo nr_seq_tab_compl,
                null ie_debito_credito,
                'X' ie_origem_titulo,
                coalesce(a.nr_seq_pls_lote_camara,b.nr_seq_pls_lote_camara),
                b.nr_titulo nr_tit_pagar
        FROM titulo_pagar b, titulo_pagar_baixa a
LEFT OUTER JOIN titulo_pagar_baixa_cc c ON (a.nr_titulo = c.nr_titulo AND a.nr_sequencia = c.nr_seq_baixa)
WHERE a.nr_titulo             = b.nr_titulo   and a.nr_lote_contabil      = nr_lote_contabil_p
         
union all

        select  a.nr_titulo,
                'P' ie_receber_pagar,
                CASE WHEN c.ie_origem='E' THEN  'VL_EVENTO_OPS_EC' WHEN c.ie_origem='P' THEN  'VL_PAGAMENTO_OPS_EC' WHEN c.ie_origem='I' THEN  'VL_INTERCAMBIO_EC' WHEN c.ie_origem='R' THEN  'VL_REEMBOLSO_EC' WHEN c.ie_origem='C' THEN  'VL_COPARTICIPACAO_EC' END  nm_atributo,
                c.vl_movimento,
                a.dt_baixa dt_contab,
                a.nr_seq_trans_fin,
                b.cd_estabelecimento,
                null nr_seq_mensalidade,
                null cd_conta_deb_pls,
                null cd_historico_pls,
                a.cd_tipo_baixa,
                null,
                a.nr_seq_lote_enc_contas,
                c.cd_conta_contabil,
                a.nr_seq_conta_banco,
                b.cd_cgc,
                b.cd_pessoa_fisica,
                'TITULO_PAGAR_BAIXA_OPS' nm_tabela,
                13 nr_seq_info_ctb,
                c.nr_sequencia nr_seq_tab_orig,
                a.nr_sequencia nr_seq_tab_compl,
                null ie_debito_credito,
                'X' ie_origem_titulo,
                coalesce(a.nr_seq_pls_lote_camara,b.nr_seq_pls_lote_camara),
                b.nr_titulo nr_tit_pagar
        from    titulo_pagar_baixa_ops  c,
                titulo_pagar            b,
                titulo_pagar_baixa      a
        where   a.nr_titulo             = b.nr_titulo
        and     b.nr_titulo             = c.nr_titulo
        and     a.nr_sequencia          = c.nr_seq_baixa
        and     c.nr_lote_contabil      = nr_lote_contabil_p
        
union all

        select  a.nr_titulo,
                'R' ie_receber_pagar,
                'VL_TITULO_RECEBER_EC' nm_atributo,
                a.vl_titulo vl_movimento,
                a.dt_emissao dt_contab,
                a.nr_seq_trans_fin_contab,
                a.cd_estabelecimento,
                null nr_seq_mensalidade,
                null cd_conta_deb_pls,
                null cd_historico_pls,
                null cd_tipo_baixa,
                null,
                a.nr_seq_lote_enc_contas,
                null cd_conta_contabil,
                a.nr_seq_conta_banco,
                a.cd_cgc,
                a.cd_pessoa_fisica,
                'TITULO_RECEBER' nm_tabela,
                46 nr_seq_info_ctb,
                a.nr_titulo nr_seq_tab_orig,
                null nr_seq_tab_compl,
                null ie_debito_credito,
                a.ie_origem_titulo,
                a.nr_seq_pls_lote_camara,
                null nr_tit_pagar
        from    titulo_receber  a
        where   a.nr_lote_contabil      = nr_lote_contabil_p
        
union all

        select  a.nr_titulo,
                'P' ie_receber_pagar,
                'VL_TITULO_PAGAR_EC' nm_atributo,
                a.vl_titulo vl_movimento,
                a.dt_emissao dt_contab,
                a.nr_seq_trans_fin_contab,
                a.cd_estabelecimento,
                null nr_seq_mensalidade,
                null cd_conta_deb_pls,
                null cd_historico_pls,
                null cd_tipo_baixa,
                null,
                a.nr_seq_lote_enc_contas,
                null cd_conta_contabil,
                null nr_seq_conta_banco,
                a.cd_cgc,
                a.cd_pessoa_fisica,
                'TITULO_PAGAR' nm_tabela,
                47 nr_seq_info_ctb,
                a.nr_titulo nr_seq_tab_orig,
                null nr_seq_tab_compl,
                null ie_debito_credito,
                'X' ie_origem_titulo,
                a.nr_seq_pls_lote_camara,
                a.nr_titulo nr_tit_pagar
        from    titulo_pagar    a
        where   a.nr_lote_contabil      = nr_lote_contabil_p
        
union all

        select  a.nr_titulo,
                'R' ie_receber_pagar,
                'VL_TRIB_TIT_REC_EC' nm_atributo,
                c.vl_baixa vl_movimento,
                a.dt_recebimento,
                c.nr_seq_trans_financ,
                b.cd_estabelecimento,
                null nr_seq_mensalidade,
                null cd_conta_deb_pls,
                null cd_historico_pls,
                null cd_tipo_baixa,
                a.cd_tipo_recebimento,
                a.nr_seq_lote_enc_contas,
                null cd_conta_contabil,
                a.nr_seq_conta_banco,
                b.cd_cgc,
                b.cd_pessoa_fisica,
                'TITULO_RECEBER_TRIB_BAIXA' nm_tabela,
                14 nr_seq_info_ctb,
                c.nr_sequencia nr_seq_tab_orig,
                c.nr_titulo nr_seq_tab_compl,
                null ie_debito_credito,
                'X' ie_origem_titulo,
                coalesce(a.nr_seq_pls_lote_camara,b.nr_seq_pls_lote_camara),
                a.nr_tit_pagar
        from    titulo_receber_trib_baixa       c,
                titulo_receber                  b,
                titulo_receber_liq              a
        where   a.nr_lote_contabil              = nr_lote_contabil_p
        and     a.nr_titulo                     = b.nr_titulo
        and     a.nr_titulo                     = c.nr_titulo
        and     a.nr_sequencia                  = c.nr_seq_tit_liq
        and     coalesce(a.ie_lib_caixa, 'S')        = 'S'
        and     (c.nr_seq_trans_financ IS NOT NULL AND c.nr_seq_trans_financ::text <> '')
        
union all

        select  b.nr_titulo,
                'R' ie_receber_pagar,
                'VL_JUROS_EC' nm_atributo,
                CASE WHEN a.ie_acao='I' THEN  a.vl_juros  ELSE a.vl_juros * -1 END  vl_movimento,
                a.dt_recebimento,
                a.nr_seq_trans_fin,
                b.cd_estabelecimento,
                null nr_seq_mensalidade,
                null cd_conta_deb_pls,
                null cd_historico_pls,
                null cd_tipo_baixa,
                a.cd_tipo_recebimento,
                a.nr_seq_lote_enc_contas,
                null cd_conta_contabil,
                a.nr_seq_conta_banco,
                b.cd_cgc,
                b.cd_pessoa_fisica,
                'TITULO_RECEBER_LIQ' nm_tabela,
                14 nr_seq_info_ctb,
                a.nr_sequencia nr_seq_tab_orig,
                a.nr_titulo nr_seq_tab_compl,
                null ie_debito_credito,
                b.ie_origem_titulo,
                coalesce(a.nr_seq_pls_lote_camara,b.nr_seq_pls_lote_camara),
                a.nr_tit_pagar
        from    titulo_receber          b,
                titulo_receber_liq      a
        where   a.nr_lote_contabil      = nr_lote_contabil_p
        and     a.nr_titulo             = b.nr_titulo
        and     a.vl_juros <> 0
        and     (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
        and     coalesce(ie_lib_caixa, 'S') = 'S'
        
union all

        select  b.nr_titulo,
                'R' ie_receber_pagar,
                'VL_MULTA_EC' nm_atributo,
                CASE WHEN a.ie_acao='I' THEN  a.vl_multa  ELSE a.vl_multa * -1 END  vl_movimento,
                a.dt_recebimento,
                a.nr_seq_trans_fin,
                b.cd_estabelecimento,
                null nr_seq_mensalidade,
                null cd_conta_deb_pls,
                null cd_historico_pls,
                null cd_tipo_baixa,
                a.cd_tipo_recebimento,
                a.nr_seq_lote_enc_contas,
                null cd_conta_contabil,
                a.nr_seq_conta_banco,
                b.cd_cgc,
                b.cd_pessoa_fisica,
                'TITULO_RECEBER_LIQ' nm_tabela,
                14 nr_seq_info_ctb,
                a.nr_sequencia nr_seq_tab_orig,
                a.nr_titulo nr_seq_tab_compl,
                null ie_debito_credito,
                b.ie_origem_titulo,
                coalesce(a.nr_seq_pls_lote_camara,b.nr_seq_pls_lote_camara),
                a.nr_tit_pagar
        from    titulo_receber          b,
                titulo_receber_liq      a
        where   a.nr_lote_contabil      = nr_lote_contabil_p
        and     a.nr_titulo             = b.nr_titulo
        and     a.vl_multa <> 0
        and     (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
        and     coalesce(ie_lib_caixa, 'S')  = 'S'
        
union all

        select  a.nr_titulo,
                'P' ie_receber_pagar,
                'VL_JUROS_EC' nm_atributo,
                obter_juros_multa_titulo(a.nr_titulo, clock_timestamp(),'P','J') vl_movimento,
                a.dt_emissao dt_contab,
                a.nr_seq_trans_fin_contab,
                a.cd_estabelecimento,
                null nr_seq_mensalidade,
                null cd_conta_deb_pls,
                null cd_historico_pls,
                null cd_tipo_baixa,
                null,
                a.nr_seq_lote_enc_contas,
                null cd_conta_contabil,
                null nr_seq_conta_banco,
                a.cd_cgc,
                a.cd_pessoa_fisica,
                'TITULO_PAGAR' nm_tabela,
                47 nr_seq_info_ctb,
                a.nr_titulo nr_seq_tab_orig,
                null nr_seq_tab_compl,
                null ie_debito_credito,
                'X' ie_origem_titulo,
                a.nr_seq_pls_lote_camara,
                a.nr_titulo nr_tit_pagar
        from    titulo_pagar    a
        where   a.nr_lote_contabil      = nr_lote_contabil_p
        
union all

        select  a.nr_titulo,
                'P' ie_receber_pagar,
                'VL_MULTA_EC' nm_atributo,
                obter_juros_multa_titulo(a.nr_titulo, clock_timestamp(),'P','M') vl_movimento,
                a.dt_emissao dt_contab,
                a.nr_seq_trans_fin_contab,
                a.cd_estabelecimento,
                null nr_seq_mensalidade,
                null cd_conta_deb_pls,
                null cd_historico_pls,
                null cd_tipo_baixa,
                null,
                a.nr_seq_lote_enc_contas,
                null cd_conta_contabil,
                null nr_seq_conta_banco,
                a.cd_cgc,
                a.cd_pessoa_fisica,
                'TITULO_PAGAR' nm_tabela,
                47 nr_seq_info_ctb,
                a.nr_titulo nr_seq_tab_orig,
                null nr_seq_tab_compl,
                null ie_debito_credito,
                'X' ie_origem_titulo,
                a.nr_seq_pls_lote_camara,
                a.nr_titulo nr_tit_pagar
        from    titulo_pagar    a
        where   a.nr_lote_contabil      = nr_lote_contabil_p;


BEGIN
/*Validacao para impedir a geracao em lotes incorretos */

if (ie_exclusao_p <> 'S') then
        select b.cd_tipo_lote_contabil
        into STRICT cd_tipo_lote_contabil_w
        from lote_contabil b
        where b.nr_lote_contabil = nr_lote_contabil_p;
        if (cd_tipo_lote_contabil_w <> 30) then
                CALL wheb_mensagem_pck.exibir_mensagem_abort(261346);
        end if;
end if;
select  dt_referencia,
        cd_estabelecimento,
        cd_tipo_lote_contabil
into STRICT    dt_contabil_w,
        cd_estabelecimento_w,
        cd_tipo_lote_contabil_w
from    lote_contabil
where   nr_lote_contabil        = nr_lote_contabil_p;

select  max(coalesce(ie_processo_camara,'CO'))
into STRICT    ie_processo_camara_w
from    pls_parametros_camara
where   cd_estabelecimento = cd_estabelecimento_w;

cd_empresa_w    := obter_empresa_estab(cd_estabelecimento_w);

delete
from    lote_contabil_log
where   nr_lote_contabil = nr_lote_contabil_p
and     cd_log_lote in (9,10);

commit;

cd_centro_custo_w       := 0;

if (ie_exclusao_p = 'S') then
        CALL wheb_usuario_pck.set_ie_lote_contabil('S');

        delete  from movimento_contabil
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  lote_contabil
        set     vl_credito              = 0,
                vl_debito               = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  titulo_pagar_baixa a
        set     nr_lote_contabil        = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  titulo_receber_liq a
        set     nr_lote_contabil        = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  titulo_receber
        set     nr_lote_contabil        = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  titulo_pagar
        set     nr_lote_contabil        = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  pls_titulo_rec_liq_mens
        set     nr_lote_contabil        = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  titulo_pagar_baixa_ops  a
        set     a.nr_lote_contabil      = 0
        where   a.nr_lote_contabil      = nr_lote_contabil_p;

        CALL wheb_usuario_pck.set_ie_lote_contabil('N');
else
        CALL wheb_usuario_pck.set_ie_lote_contabil('S');

        ie_permite_estab_dif_w  := 'N';

        SELECT * FROM ctb_obter_regra_estab_dif(      cd_estabelecimento_w, cd_tipo_lote_contabil_w, null, ie_permite_estab_dif_w, cd_conta_transitoria_w, cd_historico_ct_w) INTO STRICT ie_permite_estab_dif_w, cd_conta_transitoria_w, cd_historico_ct_w;

        --Obter_Valor_Dinamico('Truncate Table W_Movimento_Contabil', vl_retorno_w);
        delete  FROM w_movimento_contabil
        where   nr_lote_contabil = nr_lote_contabil_p;

        /* Encontro de contas */


        /* Baixas geradas pelo EC */

        update  titulo_receber_liq a
        set     nr_lote_contabil        = nr_lote_contabil_p
        where   trunc(dt_recebimento,'month')   = trunc(dt_contabil_w, 'month')
        and     trunc(dt_recebimento,'dd')      <= trunc(dt_contabil_w, 'dd')
        and     ((nr_seq_lote_enc_contas IS NOT NULL AND nr_seq_lote_enc_contas::text <> '')
        or (exists (SELECT 1
                                from    titulo_receber t
                                where   a.nr_titulo = t.nr_titulo
                                and     t.ie_origem_titulo = '6'
                                and     ie_processo_camara_w = 'CA')))
        and     not exists (select 1
                                from    lote_encontro_contas    w
                                where   w.nr_sequencia  = a.nr_seq_lote_enc_contas
                                and     (w.dt_cancelamento IS NOT NULL AND w.dt_cancelamento::text <> ''))
        and     nr_lote_contabil        = 0
        and     exists  (select 1
                        from    estabelecimento e,
                                titulo_receber  t
                        where   a.nr_titulo             = t.nr_titulo
                        and     t.cd_estabelecimento    = e.cd_estabelecimento
                        and     e.cd_empresa            = cd_empresa_w
                        and     ((ie_permite_estab_dif_w <> 'N') or (e.cd_estabelecimento       = cd_estabelecimento_w))
                        and (t.ie_situacao  <> '3'));

        update  pls_titulo_rec_liq_mens a
        set     nr_lote_contabil        = nr_lote_contabil_p
        where   trunc(a.dt_contabil,'month')    = trunc(dt_contabil_w, 'month')
        and     trunc(a.dt_contabil,'dd')       <= trunc(dt_contabil_w, 'dd')
        and     exists  (SELECT 1
                        from    titulo_receber_liq      x
                        where   x.nr_titulo     = a.nr_titulo
                        and     x.nr_sequencia  = a.nr_seq_baixa
                        and     ((not exists (select 1
                                                from    lote_encontro_contas w
                                                where   w.nr_sequencia = x.nr_seq_lote_enc_contas
                                                and     (w.dt_cancelamento IS NOT NULL AND w.dt_cancelamento::text <> ''))
                        and     (x.nr_seq_lote_enc_contas IS NOT NULL AND x.nr_seq_lote_enc_contas::text <> ''))
                        or      (x.nr_seq_pls_lote_camara IS NOT NULL AND x.nr_seq_pls_lote_camara::text <> '')))
        and     a.nr_lote_contabil      = 0
        and     exists (select 1
                        from    titulo_receber t,
                                estabelecimento e
                        where   a.nr_titulo             = t.nr_titulo
                        and     t.cd_estabelecimento    = e.cd_estabelecimento
                        and     ((ie_permite_estab_dif_w <> 'N') or (e.cd_estabelecimento       = cd_estabelecimento_w))
                        and (t.ie_situacao  <> '3'));

        update  titulo_pagar_baixa a
        set     nr_lote_contabil        = nr_lote_contabil_p
        where   trunc(dt_baixa,'month') = trunc(dt_contabil_w, 'month')
        and     trunc(dt_baixa,'dd')    <= trunc(dt_contabil_w, 'dd')
        and     ((nr_seq_lote_enc_contas IS NOT NULL AND nr_seq_lote_enc_contas::text <> '')
        or (exists (SELECT 1
                                from    titulo_pagar t
                                where   a.nr_titulo = t.nr_titulo
                                and     t.ie_origem_titulo = '15'
                                and     ie_processo_camara_w = 'CA')))
        and     nr_lote_contabil        = 0
        and     not exists (select 1
                                from    lote_encontro_contas w
                                where   w.nr_sequencia = a.nr_seq_lote_enc_contas
                                and     (w.dt_cancelamento IS NOT NULL AND w.dt_cancelamento::text <> ''))
        and     exists  (select 1
                from    titulo_pagar t,
                        estabelecimento e
                where   a.nr_titulo             = t.nr_titulo
                and     t.cd_estabelecimento    = e.cd_estabelecimento
                and     ((ie_permite_estab_dif_w <> 'N') or (e.cd_estabelecimento       = cd_estabelecimento_w))
                and (t.ie_situacao  <> 'C'));
        /* Fim baixas geradas pelo EC */



        /* Titulos que compoem EC */

        update  titulo_receber a
        set     nr_lote_contabil                = nr_lote_contabil_p
        where   trunc(dt_emissao,'month')       = trunc(dt_contabil_w, 'month')
        and     trunc(dt_emissao,'dd')          <= trunc(dt_contabil_w, 'dd')
        and     (nr_seq_lote_enc_contas IS NOT NULL AND nr_seq_lote_enc_contas::text <> '')
        and     ((ie_situacao   <> '3') or ((exists (   SELECT  1
                                                        from    PESSOA_ENCONTRO_CONTAS p
                                                        where   a.nr_titulo = p.nr_titulo_receber))
                                             and (a.nr_seq_segurado_mens IS NOT NULL AND a.nr_seq_segurado_mens::text <> '')))
        and     nr_lote_contabil        = 0
        and     not exists (SELECT 1
                                from    lote_encontro_contas    w
                                where   w.nr_sequencia  = a.nr_seq_lote_enc_contas
                                and     (w.dt_cancelamento IS NOT NULL AND w.dt_cancelamento::text <> ''))
        and             exists  (select 1
                                from    estabelecimento e
                                where   e.cd_estabelecimento    = a.cd_estabelecimento
                                and     e.cd_empresa            = cd_empresa_w
                                and     ((ie_permite_estab_dif_w <> 'N') or (e.cd_estabelecimento       = cd_estabelecimento_w)));

        update  titulo_pagar    a
        set     nr_lote_contabil                = nr_lote_contabil_p
        where   trunc(dt_emissao,'month')       = trunc(dt_contabil_w, 'month')
        and     trunc(dt_emissao,'dd')          <= trunc(dt_contabil_w, 'dd')
        and     (nr_seq_lote_enc_contas IS NOT NULL AND nr_seq_lote_enc_contas::text <> '')
        and     ((ie_situacao   <> 'C') or ((exists (   SELECT  1
                                                        from    pessoa_encontro_contas p
                                                        where   a.nr_titulo = p.nr_titulo_pagar))
                                             and (a.nr_seq_segurado_mens IS NOT NULL AND a.nr_seq_segurado_mens::text <> '')))
        and     nr_lote_contabil        = 0
        and     not exists (SELECT 1
                                from    lote_encontro_contas w
                                where   w.nr_sequencia = a.nr_seq_lote_enc_contas
                                and     (w.dt_cancelamento IS NOT NULL AND w.dt_cancelamento::text <> ''))
        and     exists  (select 1
                        from    estabelecimento e
                        where   e.cd_estabelecimento    = a.cd_estabelecimento
                        and     e.cd_empresa            = cd_empresa_w
                        and     ((ie_permite_estab_dif_w <> 'N') or (e.cd_estabelecimento       = cd_estabelecimento_w)));

        /* Fim titulos que compoem EC */


        /* Fim encontro de contas */



        /* Camara de compensacao */

        update  titulo_receber_liq a
        set     nr_lote_contabil                = nr_lote_contabil_p
        where   trunc(dt_recebimento,'month')   = trunc(dt_contabil_w, 'month')
        and     trunc(dt_recebimento,'dd')      <= trunc(dt_contabil_w, 'dd')
        and     ((nr_seq_pls_lote_camara IS NOT NULL AND nr_seq_pls_lote_camara::text <> '')
        or (exists (SELECT 1
                                from    titulo_receber t
                                where   a.nr_titulo = t.nr_titulo
                                and     t.ie_origem_titulo = '6'
                                and     ie_processo_camara_w = 'CA')))
        and     nr_lote_contabil                = 0;
        update  titulo_pagar_baixa a
        set     nr_lote_contabil        = nr_lote_contabil_p
        where   trunc(dt_baixa,'month') = trunc(dt_contabil_w, 'month')
        and     trunc(dt_baixa,'dd')    <= trunc(dt_contabil_w, 'dd')
        and     ((nr_seq_pls_lote_camara IS NOT NULL AND nr_seq_pls_lote_camara::text <> '')
        or (exists (SELECT 1
                                from    titulo_pagar t
                                where   a.nr_titulo = t.nr_titulo
                                and     t.ie_origem_titulo = '15'
                                and     ie_processo_camara_w = 'CA')))
        and     nr_lote_contabil        = 0;

        update  titulo_receber
        set     nr_lote_contabil                = nr_lote_contabil_p
        where   trunc(dt_emissao,'month')       = trunc(dt_contabil_w, 'month')
        and     trunc(dt_emissao,'dd')          <= trunc(dt_contabil_w, 'dd')
        and     (nr_seq_pls_lote_camara IS NOT NULL AND nr_seq_pls_lote_camara::text <> '')
        and     ie_situacao != '3'
        and     nr_lote_contabil                = 0;

        update  titulo_pagar
        set     nr_lote_contabil                = nr_lote_contabil_p
        where   trunc(dt_emissao,'month')       = trunc(dt_contabil_w, 'month')
        and     trunc(dt_emissao,'dd')          <= trunc(dt_contabil_w, 'dd')
        and     (nr_seq_pls_lote_camara IS NOT NULL AND nr_seq_pls_lote_camara::text <> '')
        and     nr_lote_contabil                = 0;

        update  titulo_pagar a
        set     nr_lote_contabil                = nr_lote_contabil_p
        where   trunc(dt_emissao,'month')       = trunc(dt_contabil_w, 'month')
        and     trunc(dt_emissao,'dd')          <= trunc(dt_contabil_w, 'dd')
        and     nr_lote_contabil                = 0
        and     exists (SELECT 1
                        from    pls_lote_camara_comp    x
                        where   x.nr_tit_pagar_taxa     = a.nr_titulo);

        update  titulo_pagar_baixa_ops  a
        set     a.nr_lote_contabil              = nr_lote_contabil_p
        where   coalesce(a.nr_lote_contabil,0)       = 0
        and     exists (SELECT 1
                        from    titulo_pagar_baixa      x
                        where   x.nr_titulo     = a.nr_titulo
                        and     x.nr_lote_contabil = nr_lote_contabil_p
                        and     x.nr_sequencia  = a.nr_seq_baixa);
        /* Fim camara de compensacao */

        CALL wheb_usuario_pck.set_ie_lote_contabil('N');

        begin
        ie_compl_hist_w := obter_se_compl_tipo_lote(cd_estabelecimento_w, cd_tipo_lote_contabil_w);
        exception
        when others then
                ie_compl_hist_w := 'N';
        end;

        nm_agrupador_w := coalesce(trim(both obter_agrupador_contabil(cd_tipo_lote_contabil_w)),'NR_TITULO');

        select  coalesce(max(ie_contab_classif_mens),'N')
        into STRICT    ie_contab_classif_mens_w
        from    pls_parametro_contabil
        where   cd_estabelecimento = cd_estabelecimento_w;

        open C01;
        loop
        fetch C01 into
                nr_titulo_w,
                ie_receber_pagar_w,
                nm_atributo_w,
                vl_movimento_w,
                dt_contab_w,
                nr_seq_trans_financ_w,
                cd_estab_movto_w,
                nr_seq_mensalidade_w,
                cd_conta_deb_pls_w,
                cd_historico_pls_w,
                cd_tipo_baixa_w,
                cd_tipo_recebimento_w,
                nr_seq_lote_enc_contas_w,
                cd_conta_contabil_w,
                nr_seq_conta_banco_w,
                cd_cgc_w,
                cd_pessoa_fisica_w,
                nm_tabela_w,
                nr_seq_info_ctb_w,
                nr_seq_tab_orig_w,
                nr_seq_tab_compl_w,
                ie_debito_credito_w,
                ie_origem_titulo_w,
                nr_pls_lote_camara_w,
                nr_titulo_pagar_w;
        EXIT WHEN NOT FOUND; /* apply on C01 */
                nr_tit_rec_baixado_w    := null;
                nr_tit_rec_gerado_w     := null;
                nr_tit_pagar_baixado_w  := null;
                nr_tit_pagar_gerado_w   := null;
                nr_seq_nota_credito_w   := null;

                if (ie_receber_pagar_w = 'R') then
                        if (nm_atributo_w in ('VL_RECEBIDO_EC', 'VL_TRIB_TIT_REC_EC', 'VL_JUROS_EC', 'VL_MULTA_EC', 'VL_FATURAMENTO_OPS_EC','VL_EVENTO_OPS_EC', 'VL_PAGAMENTO_OPS_EC', 'VL_INTERCAMBIO_EC', 'VL_REEMBOLSO_EC', 'VL_COPARTICIPACAO_EC')) then
                                nr_tit_rec_baixado_w    := nr_titulo_w;
                        elsif (nm_atributo_w = 'VL_TITULO_RECEBER_EC') then
                                nr_tit_rec_gerado_w     := nr_titulo_w;
                        end if;

                        select  substr(obter_nome_pf_pj(a.cd_pessoa_fisica, a.cd_cgc),1,80)
                        into STRICT    ds_pessoa_w
                        from    titulo_receber a
                        where   a.nr_titulo     = nr_titulo_w;

                elsif (ie_receber_pagar_w = 'P') then
                        if (nm_atributo_w in ('VL_PAGO_EC', 'VL_JUROS_EC', 'VL_MULTA_EC','VL_EVENTO_OPS_EC', 'VL_PAGAMENTO_OPS_EC', 'VL_INTERCAMBIO_EC', 'VL_REEMBOLSO_EC', 'VL_COPARTICIPACAO_EC')) then
                                nr_tit_pagar_baixado_w  := nr_titulo_w;
                        elsif (nm_atributo_w = 'VL_TITULO_PAGAR_EC') then
                                nr_tit_pagar_gerado_w   := nr_titulo_w;
                        end if;

                        select  substr(obter_nome_pf_pj(a.cd_pessoa_fisica, a.cd_cgc),1,80),
                                a.cd_pessoa_fisica,
                                a.cd_cgc,
                                a.nr_seq_nota_credito
                        into STRICT    ds_pessoa_w,
                                cd_pessoa_fisica_w,
                                cd_cgc_w,
                                nr_seq_nota_credito_w
                        from    titulo_pagar a
                        where   a.nr_titulo     = nr_titulo_w;
                end if;

                /* ebcabral - 11/03/2013 - OS 557556 - Definir o agrupador contabil */

                if (nm_agrupador_w = 'NR_SEQ_LOTE_ENC_CONTAS') then
                        nr_seq_agrupamento_w := 0;

                        if (coalesce(nr_seq_lote_enc_contas_w, 0) > 0) then
                                nr_seq_agrupamento_w    :=      nr_seq_lote_enc_contas_w;
                        elsif (coalesce(nr_pls_lote_camara_w,0) > 0) then
                                nr_seq_agrupamento_w    :=      nr_pls_lote_camara_w;
                        end if;

                elsif (nm_agrupador_w = 'NR_TITULO')then
                        nr_seq_agrupamento_w    :=      nr_titulo_w;
                elsif (nm_agrupador_w = 'NR_TITULO_PAGAR')then
                        nr_seq_agrupamento_w    :=      nr_titulo_pagar_w;
                else
                        nr_seq_agrupamento_w    := null;
                end if;

                if (coalesce(nr_seq_agrupamento_w,0) = 0)then
                        nr_seq_agrupamento_w    :=      nr_titulo_w;
                end if;

                ds_conteudo_w   := '';

                if (ie_compl_hist_w = 'S') then
                        ds_conteudo_w   := substr(      nr_tit_rec_baixado_w     ||'#@'||
                                                                                nr_tit_pagar_baixado_w   ||'#@'||
                                                                                nr_tit_rec_gerado_w      ||'#@'||
                                                                                nr_tit_pagar_gerado_w    ||'#@'||
                                                                                ds_pessoa_w              ||'#@'||
                                                                                nr_seq_lote_enc_contas_w ||'#@'||
                                                                                nr_pls_lote_camara_w     ||'#@'||
                                                                                nr_seq_nota_credito_w, 1, 4000);

                        begin
                        ds_compl_historico_w    := substr(obter_compl_historico(cd_tipo_lote_contabil_w, cd_historico_pls_w, ds_conteudo_w),1,255);
                        exception
                        when others then
                                ds_compl_historico_w    := null;
                        end;
                end if;

                ds_atributos_w  := null;

                ds_atributos_w  :=      'NR_TITULO_RECEBER_GERADO=' || nr_tit_rec_gerado_w || ';' ||
                                        'NR_TITULO_PAGAR_GERADO=' || nr_tit_pagar_gerado_w || ';' ||
                                        'NR_TITULO_RECEBER_BAIXADO=' || nr_tit_rec_baixado_w || ';' ||
                                        'NR_TITULO_PAGAR_BAIXADO=' || nr_tit_pagar_baixado_w;

                ctb_obter_doc_movto(    cd_tipo_lote_contabil_w,
                                        nm_atributo_w,
                                        'VR',
                                        dt_contabil_w,
                                        null,
                                        null,
                                        ds_atributos_w,
                                        nm_usuario_p,
                                        ie_regra_w,
                                        nr_documento_ww,
                                        ie_origem_documento_w);

                ie_tipo_lancamento_w    := null;

                if (nm_tabela_w = 'PLS_TITULO_REC_LIQ_MENS') then
                        select  max(ie_tipo_lancamento)
                        into STRICT    ie_tipo_lancamento_w
                        from    pls_titulo_rec_liq_mens
                        where   nr_sequencia    = nr_seq_tab_orig_w
                        and     nr_titulo       = nr_titulo_w;
                end if;

                if (nm_atributo_w = 'VL_RECEBIDO_EC') and (nr_seq_mensalidade_w IS NOT NULL AND nr_seq_mensalidade_w::text <> '') and (ie_debito_credito_w = 'C' or ie_tipo_lancamento_w = 'EA') then
                        select  coalesce(max(nr_sequencia),0) + 1
                        into STRICT    nr_sequencia_w
                        from    w_movimento_contabil
                        where   nr_lote_contabil        = nr_lote_contabil_p;
                        begin
                        insert  into w_movimento_contabil(nr_lote_contabil,
                                nr_sequencia,
                                cd_conta_contabil,
                                ie_debito_credito,
                                cd_historico,
                                dt_movimento,
                                vl_movimento,
                                ds_doc_agrupamento,
                                nr_seq_agrupamento,
                                cd_centro_custo,
                                ds_compl_historico,
                                nr_seq_trans_fin,
                                nr_documento,
                                cd_pessoa_fisica,
                                cd_cgc,
                                ie_transitorio,
                                ie_origem_documento,
                                nm_tabela,
                                nr_seq_info,
                                nr_seq_tab_orig,
                                nr_seq_tab_compl,
                                nm_atributo)
                        values (nr_lote_contabil_p,
                                nr_sequencia_w,
                                cd_conta_deb_pls_w,
                                ie_debito_credito_w,
                                cd_historico_pls_w,
                                coalesce(dt_contab_w, dt_contabil_w), -- ebcabral - OS 557556 - 11/03/2013 - Alterado para que os movimentos contabeis sejam gerados com a data da baixa */
                                vl_movimento_w,
                                null,
                                nr_seq_agrupamento_w,
                                null,
                                ds_compl_historico_w,
                                nr_seq_trans_financ_w,
                                nr_documento_ww,
                                cd_pessoa_fisica_w,
                                cd_cgc_w,
                                'N',
                                ie_origem_documento_w,
                                nm_tabela_w,
                                nr_seq_info_ctb_w,
                                nr_seq_tab_orig_w,
                                nr_seq_tab_compl_w,
                                nm_atributo_w);
                        exception
                        when others then
                                ds_erro_w       := sqlerrm(SQLSTATE);
                                null;
                                CALL wheb_mensagem_pck.exibir_mensagem_abort(182537,'CD_CONTA_DEB_PLS_W=' || cd_conta_deb_pls_w ||
                                                                        ';NR_TITULO_W=' || nr_titulo_w ||
                                                                        ';NR_SEQUENCIA_W=' || nr_sequencia_w ||
                                                                        ';NR_SEQ_TRANS_FIN_W=' || nr_seq_trans_financ_w ||
                                                                        ';VL_TRANSACAO_W=' || vl_movimento_w ||
                                                                        ';DS_ERRO_W=' ||ds_erro_w);
                        end;
                else
                        if (ie_receber_pagar_w = 'P') then
                                nr_titulo_pagar_w       := nr_titulo_w;
                                nr_titulo_w             := null;
                        else
                                nr_titulo_pagar_w       := null;
                        end if;

                        nr_sequencia_w := gerar_contab_trans_financ(      cd_estabelecimento_w, cd_estab_movto_w, nr_lote_contabil_p, nm_usuario_p, cd_conta_contabil_w, cd_centro_custo_w, null, nr_seq_agrupamento_w, dt_contabil_w, vl_movimento_w, nr_seq_trans_financ_w, nr_seq_conta_banco_w, nm_atributo_w, cd_pessoa_fisica_w, cd_cgc_w, 0, null, nr_documento_ww, cd_historico_pls_w, ds_conteudo_w, null, null, null, null, nr_titulo_pagar_w, null, null, ie_origem_titulo_w, --
                                                        null, null, null, null, cd_tipo_baixa_w, cd_tipo_recebimento_w, nr_sequencia_w, nm_tabela_w, nr_titulo_w, null, ie_origem_documento_w, nr_seq_tab_orig_w, nr_seq_tab_compl_w, nr_seq_info_ctb_w);
                end if;
        end loop;
        close C01;

        CALL agrupa_movimento_contabil(      nr_lote_contabil_p,
                                        nm_usuario_p);
end if;

if (coalesce(ds_retorno_p::text, '') = '') then
        update  lote_contabil
        set     ie_situacao             = 'A',
                dt_geracao_lote         = CASE WHEN ie_exclusao_p='N' THEN clock_timestamp() WHEN ie_exclusao_p='S' THEN null END
        where   nr_lote_contabil        = nr_lote_contabil_p;

        if (ie_exclusao_p = 'S') then
                ds_retorno_p    := wheb_mensagem_pck.get_texto(165188);

                CALL ctb_gravar_log_lote(    nr_lote_contabil_p,
                                        2,
                                        '',
                                        nm_usuario_p);
        else
                ds_retorno_p    := wheb_mensagem_pck.get_texto(165187);

                CALL ctb_gravar_log_lote(    nr_lote_contabil_p,
                                        1,
                                        '',
                                        nm_usuario_p);
        end if;
        commit;
else
        rollback;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE contabiliza_encontro_contas (nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text) FROM PUBLIC;

