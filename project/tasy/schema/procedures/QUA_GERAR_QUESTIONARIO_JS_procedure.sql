-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qua_gerar_questionario_js ( nr_seq_documento_p bigint, ds_pergunta_um_p INOUT text, ds_pergunta_dois_p INOUT text, ds_pergunta_tres_p INOUT text, nr_seq_perg_um_p INOUT bigint, nr_seq_perg_dois_p INOUT bigint, nr_seq_perg_tres_p INOUT bigint) AS $body$
DECLARE


nr_seq_perg_um_w	bigint;
nr_seq_perg_dois_w	bigint;
nr_seq_perg_tres_w	bigint;
ds_msg_erro_w		varchar(255);
ds_pergunta_um_w	varchar(4000);
ds_pergunta_dois_w	varchar(4000);
ds_pergunta_tres_w	varchar(4000);
qt_perguntas_w		bigint;


BEGIN




if (coalesce(nr_seq_documento_p,0) > 0) then

	select	count(*)
	into STRICT	qt_perguntas_w
	from	qua_doc_questionario
	where	nr_seq_documento = nr_seq_documento_p
	and	ie_situacao <> 'I';

	if (qt_perguntas_w < 3) then

		ds_msg_erro_w := substr(wheb_mensagem_pck.get_texto(322108, null),1,255);
		goto final;
	else

		nr_seq_perg_um_w := gerar_perguntas_aleatorias(nr_seq_documento_p);

		nr_seq_perg_dois_w := gerar_perguntas_aleatorias(nr_seq_documento_p);

		while(coalesce(nr_seq_perg_um_w,0) = coalesce(nr_seq_perg_dois_w,0)) loop
			begin
			nr_seq_perg_dois_w := gerar_perguntas_aleatorias(nr_seq_documento_p);
			end;
		end loop;

		nr_seq_perg_tres_w := gerar_perguntas_aleatorias(nr_seq_documento_p);

		while(coalesce(nr_seq_perg_um_w,0) = coalesce(nr_seq_perg_tres_w,0)) or (coalesce(nr_seq_perg_dois_w,0) = coalesce(nr_seq_perg_tres_w,0)) loop
			begin
			nr_seq_perg_tres_w := gerar_perguntas_aleatorias(nr_seq_documento_p);
			end;
		end loop;

		ds_pergunta_um_w := qua_obter_desc_pergunta_js(coalesce(nr_seq_perg_um_w,0), nr_seq_documento_p);
		ds_pergunta_dois_w := qua_obter_desc_pergunta_js(nr_seq_perg_dois_w, nr_seq_documento_p);
		ds_pergunta_tres_w := qua_obter_desc_pergunta_js(nr_seq_perg_tres_w, nr_seq_documento_p);
	end if;
end if;

ds_pergunta_um_p := ds_pergunta_um_w;
nr_seq_perg_um_p := nr_seq_perg_um_w;
ds_pergunta_dois_p := ds_pergunta_dois_w;
nr_seq_perg_dois_p := nr_seq_perg_dois_w;
ds_pergunta_tres_p := ds_pergunta_tres_w;
nr_seq_perg_tres_p := nr_seq_perg_tres_w;

<<final>>

if (ds_msg_erro_w IS NOT NULL AND ds_msg_erro_w::text <> '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(322196,'ERRO='||ds_msg_erro_w);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qua_gerar_questionario_js ( nr_seq_documento_p bigint, ds_pergunta_um_p INOUT text, ds_pergunta_dois_p INOUT text, ds_pergunta_tres_p INOUT text, nr_seq_perg_um_p INOUT bigint, nr_seq_perg_dois_p INOUT bigint, nr_seq_perg_tres_p INOUT bigint) FROM PUBLIC;

