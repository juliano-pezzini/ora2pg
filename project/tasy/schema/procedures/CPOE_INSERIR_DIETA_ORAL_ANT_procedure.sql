-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_inserir_dieta_oral_ant ( nr_atendimento_p prescr_medica.nr_atendimento%type, nr_atendimento_ant_p prescr_medica.nr_atendimento%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nr_sequencia_p prescr_dieta.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_perfil_p bigint, cd_estabelecimento_p bigint, cd_paciente_p cpoe_dieta.cd_pessoa_fisica%type, nr_seq_item_gerado_p INOUT bigint, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, nr_seq_conclusao_apae_p bigint default null, ie_futuro_p text default 'S', nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) AS $body$
DECLARE


-- Duplicata da procedure CPOE_REP_GERAR_DIETA_ORAL
						
cd_dieta_w				prescr_dieta.cd_dieta%type;
cd_intervalo_w			prescr_dieta.cd_intervalo%type;
ds_horarios_w			prescr_dieta.ds_horarios%type;
ds_justificativa_w		prescr_dieta.ds_justificativa%type;
ds_observacao_w			prescr_dieta.ds_observacao%type;
hr_prim_horario_w		prescr_dieta.hr_prim_horario%type;
ie_via_aplicacao_w		prescr_dieta.ie_via_aplicacao%type;
qt_parametro_w			prescr_dieta.qt_parametro%type;
nr_seq_dieta_w			prescr_dieta.nr_sequencia%type;

nr_ocorrencia_w			prescr_material.nr_ocorrencia%type;
ie_urgencia_w			cpoe_dieta.ie_urgencia%type:='';
ds_horarios_aux_w		cpoe_material.ds_horarios%type:='';

qt_min_intervalo_w 		intervalo_prescricao.qt_min_intervalo%type;

dt_prim_horario_w		cpoe_dieta.dt_inicio%type;
ie_duracao_w			cpoe_dieta.ie_duracao%type := 'C';

ie_prescr_alta_agora_w	varchar(1);
dt_fim_w				cpoe_dieta.dt_fim%type := null;

c01 CURSOR FOR
SELECT	cd_dieta,
		cd_intervalo,
		ds_horarios,
		ds_justificativa,
		ds_observacao,
		hr_prim_horario,
		ie_via_aplicacao,
		qt_parametro,
		nr_sequencia
from	prescr_dieta
where	nr_prescricao = nr_prescricao_p
and		nr_sequencia = nr_sequencia_p;


BEGIN
ie_prescr_alta_agora_w := obter_param_usuario(924, 409, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_prescr_alta_agora_w);

open c01;
loop
fetch c01 into	cd_dieta_w,
				cd_intervalo_w,
				ds_horarios_w,
				ds_justificativa_w,
				ds_observacao_w,
				hr_prim_horario_w,
				ie_via_aplicacao_w,
				qt_parametro_w,
				nr_seq_dieta_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
	if (coalesce(ie_prescr_alta_agora_w,'N') = 'S') and (coalesce(ie_item_alta_p,'N') = 'S')	then
	
		ie_urgencia_w := 0;
		
		select	max(qt_min_intervalo)
		into STRICT	qt_min_intervalo_w
		from	intervalo_prescricao
		where	cd_intervalo = cd_intervalo_w;

		SELECT * FROM cpoe_calcular_horario_prescr(nr_atendimento_p, cd_intervalo_w, null, clock_timestamp(), 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;
		
		ds_horarios_w	:= ds_horarios_w || ds_horarios_aux_w;
	
		hr_prim_horario_w	:= obter_prim_dshorarios(ds_horarios_w);
		dt_prim_horario_w	:= to_date(to_char(clock_timestamp(),'dd/mm/yyyy ') || hr_prim_horario_w, 'dd/mm/yyyy hh24:mi');
	
		if (dt_prim_horario_w < clock_timestamp()) then
			dt_prim_horario_w := dt_prim_horario_w + 1;
		end if;
	else	
		ie_urgencia_w := '';
		SELECT * FROM cpoe_atualizar_periodo_vig_ant(ds_horarios_w, hr_prim_horario_w, dt_prim_horario_w) INTO STRICT ds_horarios_w, hr_prim_horario_w, dt_prim_horario_w;
	end if;	
	
	if (ie_retrogrado_p = 'S' or ie_futuro_p = 'S') then -- retrograde/backward item
		dt_prim_horario_w := dt_inicio_p;
		dt_fim_w := (dt_prim_horario_w + 1) - 1/1440;
		ie_duracao_w := 'P';
		ie_urgencia_w  := null;	
		nr_ocorrencia_w		:= 0;
		ds_horarios_w		:= '';	
		ds_horarios_aux_w	:= '';
		
		select	max(qt_min_intervalo)
		into STRICT	qt_min_intervalo_w
		from	intervalo_prescricao
		where	cd_intervalo = cd_intervalo_w;
		
		SELECT * FROM cpoe_calcular_horario_prescr(nr_atendimento_p, cd_intervalo_w, null, dt_prim_horario_w, 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;
									
		ds_horarios_w	:= substr(ds_horarios_w || ds_horarios_aux_w,1,4000);
		hr_prim_horario_w	:= obter_prim_dshorarios(ds_horarios_w);
	end if;
	
	select	nextval('cpoe_dieta_seq')
	into STRICT	nr_seq_item_gerado_p
	;
	
	insert into	cpoe_dieta(
			nr_sequencia,
			nr_atendimento,
			ie_tipo_dieta,
			ie_administracao,
			ie_duracao,
			dt_inicio,
			dt_fim,
			cd_dieta,
			cd_intervalo,
			ds_horarios,
			ds_justificativa,
			ds_observacao,
			hr_prim_horario,
			ie_urgencia,
			ie_via_aplicacao,
			qt_parametro,
			nm_usuario,
			nm_usuario_nrec,
			dt_atualizacao,
			dt_atualizacao_nrec,
			cd_perfil_ativo,
			cd_pessoa_fisica,
			cd_funcao_origem,
			nr_seq_transcricao,
			ie_item_alta,
			ie_prescritor_aux,
			cd_medico,
			ie_retrogrado,
			nr_seq_pepo,
			nr_cirurgia,
			nr_cirurgia_patologia,
			nr_seq_agenda,
			nr_seq_conclusao_apae,
			ie_futuro,
			nr_seq_cpoe_order_unit)
		values (
			nr_seq_item_gerado_p,
			nr_atendimento_p,
			'O',
			'P',
			ie_duracao_w,
			dt_prim_horario_w,
			dt_fim_w,
			cd_dieta_w,
			cd_intervalo_w,
			ds_horarios_w,
			ds_justificativa_w,
			ds_observacao_w,
			hr_prim_horario_w,
			ie_urgencia_w,
			ie_via_aplicacao_w,
			qt_parametro_w,
			nm_usuario_p,
			nm_usuario_p,
			clock_timestamp(),
			clock_timestamp(),
			cd_perfil_p,
			cd_paciente_p,
			2314,
			nr_seq_transcricao_p,
			ie_item_alta_p,
			ie_prescritor_aux_p,
			cd_medico_p,
			ie_retrogrado_p,
			nr_seq_pepo_p,
			nr_cirurgia_p,
			nr_cirurgia_patologia_p,
			nr_seq_agenda_p,
			nr_seq_conclusao_apae_p,
			ie_futuro_p,
			nr_seq_cpoe_order_unit_p);
	
	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_inserir_dieta_oral_ant ( nr_atendimento_p prescr_medica.nr_atendimento%type, nr_atendimento_ant_p prescr_medica.nr_atendimento%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nr_sequencia_p prescr_dieta.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_perfil_p bigint, cd_estabelecimento_p bigint, cd_paciente_p cpoe_dieta.cd_pessoa_fisica%type, nr_seq_item_gerado_p INOUT bigint, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, nr_seq_conclusao_apae_p bigint default null, ie_futuro_p text default 'S', nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) FROM PUBLIC;

