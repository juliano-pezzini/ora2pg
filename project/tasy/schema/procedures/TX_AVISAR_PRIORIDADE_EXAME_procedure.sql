-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tx_avisar_prioridade_exame (nm_usuario_p text) AS $body$
DECLARE

 
cd_pessoa_fisica_w		varchar(10);
nm_pessoa_fisica_w		varchar(255);
cd_perfil_w			integer;
nr_seq_prior_w			bigint;

c01 CURSOR FOR 
	SELECT	cd_pessoa_fisica, 
		substr(obter_nome_pf(cd_pessoa_fisica),1,80), 
		a.nr_sequencia		 
	from	tx_receptor_prioridade	a, 
		tx_receptor b 
	where	a.nr_seq_receptor = b.nr_sequencia 
	and (coalesce(dt_ultimo_aviso::text, '') = '' or (dt_ultimo_aviso + 72/24) < clock_timestamp()) 
	and	tx_obter_se_paciente_ativo(b.nr_sequencia) = 'S' 
	and	cd_perfil_w > 0;

	 

BEGIN 
 
begin 
select	cd_perfil_prior 
into STRICT	cd_perfil_w 
from	tx_parametros;
exception 
	when others then 
	cd_perfil_w	:= 0;
end;
 
open c01;
	loop 
	fetch c01 into 
		cd_pessoa_fisica_w, 
		nm_pessoa_fisica_w, 
		nr_seq_prior_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	 
	insert into comunic_interna( 
		dt_comunicado, 
		ds_titulo, 
		ds_comunicado, 
		nm_usuario, 
		dt_atualizacao, 
		ie_geral, 
		nm_usuario_destino, 
		ds_perfil_adicional, 
		nr_sequencia, 
		ie_gerencial, 
		dt_liberacao, 
		cd_estab_destino 
	) values ( 
		clock_timestamp(), 
		wheb_mensagem_pck.get_texto(798733) || ' ', 
		wheb_mensagem_pck.get_texto(798762, 
					'CD_PESSOA_FISICA='||cd_pessoa_fisica_w|| 
					';NM_PESSOA_FISICA='||nm_pessoa_fisica_w), 
		nm_usuario_p, 
		clock_timestamp(), 
		'N', 
		'', 
		cd_perfil_w||', ', 
		nextval('comunic_interna_seq'), 
		'N', 
		clock_timestamp(), 
		null 
	);
 
	update 	tx_receptor_prioridade 
	set 	dt_ultimo_aviso = clock_timestamp() 
	where 	nr_sequencia = nr_seq_prior_w;
 
	end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tx_avisar_prioridade_exame (nm_usuario_p text) FROM PUBLIC;

