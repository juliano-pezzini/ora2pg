-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_senha_fila_visualizacao (nr_seq_pac_senha_fila_p bigint, nr_seq_local_chamada_p bigint, nm_usuario_p text) AS $body$
DECLARE

nr_sequencia_w			fila_visualizacao_senha.nr_sequencia%type;
nr_seq_monitor_w		fila_visualizacao_senha.nr_seq_monitor%type;
param_99_w				varchar(1);
CD_ESTABELECIMENTO_W 	bigint;
	jobno 				bigint;
/* Cursor para a busca dos paineis para visualizar senha */

c01 CURSOR FOR
	SELECT b.nr_seq_comp_monitor
	  from maquina_local_senha b
	 where b.nr_sequencia = nr_seq_local_chamada_p
	   and (b.nr_seq_comp_monitor IS NOT NULL AND b.nr_seq_comp_monitor::text <> '')
	
union

	SELECT c.nr_seq_comp_monitor
	  from maquina_monitor_adicional c
	 where c.nr_seq_local = nr_seq_local_chamada_p;
	


BEGIN
CD_ESTABELECIMENTO_W := wheb_usuario_pck.get_cd_estabelecimento;
param_99_w := Obter_param_Usuario(10021, 99, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, param_99_w);

	open c01;
	loop
	fetch c01 into nr_seq_monitor_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		select nextval('fila_visualizacao_senha_seq')
		  into STRICT nr_sequencia_w
		;
		
		CALL limpar_fila_visualizacao_senha(nr_seq_monitor_w, nr_seq_pac_senha_fila_p, 0);
		insert into	fila_visualizacao_senha(	nr_sequencia,
			nr_seq_pac_senha_fila, 
			nr_seq_monitor, 
			nr_seq_local_chamada, 
			dt_atualizacao, 
			nm_usuario, 
			ie_situacao)
		values (	nr_sequencia_w, 
			nr_seq_pac_senha_fila_p, 
			nr_seq_monitor_w, 
			nr_seq_local_chamada_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			'A'
		);

		if (param_99_w = 'T')then
			dbms_job.submit(jobno, 'PREENCHE_DADOS_VISU_SENHA(' || to_char(nr_sequencia_w) || ' , ' || to_char(nr_seq_pac_senha_fila_p) || ' , ' || to_char(nr_seq_local_chamada_p) || ' , ' || chr(39) || to_char(nm_usuario_p) || chr(39) || ' ); ');
		end if;
		
	end loop;
	close c01;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_senha_fila_visualizacao (nr_seq_pac_senha_fila_p bigint, nr_seq_local_chamada_p bigint, nm_usuario_p text) FROM PUBLIC;

