-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_regra_cenario ( cd_estabelecimento_p bigint, nr_seq_cenario_p bigint, ie_regra_p bigint, cd_centro_custo_p bigint, nr_seq_metrica_p bigint, cd_conta_contabil_p text, dt_referencia_p timestamp, dt_refer_final_p timestamp, vl_mes_p bigint, ie_sobrepor_p text, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE


dt_refer_final_w			timestamp;
nr_seq_regra_w			bigint	:= 1;
ie_sobrepor_w			varchar(1);
vl_mes_w				double precision;
ie_periodo_w			bigint;


BEGIN

dt_refer_final_w		:= dt_refer_final_p;
if (coalesce(dt_refer_final_p::text, '') = '') then
	dt_refer_final_w	:= pkg_date_utils.add_month(dt_referencia_p,11,0);
end if;

ie_sobrepor_w		:= coalesce(ie_sobrepor_p, 'N');

if (coalesce(ie_opcao_p, 0) = 0) then

	vl_mes_w		:= vl_mes_p;
else
	ie_periodo_w	:= abs(months_between(dt_referencia_p, dt_refer_final_w)) +1;
	vl_mes_w		:= dividir(vl_mes_p, ie_periodo_w);

end if;
if (ie_regra_p = 0) then /* Regra MÃ©trica*/
	begin
	/* Matheus comentei esta rotina em 08/10/2008 OS 111947
	select	nvl(max(nr_seq_regra),0) + 5
	into	nr_seq_regra_w
	from	ctb_regra_metrica
	where	nr_seq_cenario	= nr_seq_cenario_p;*/
	if (coalesce(cd_centro_custo_p,0) <> 0) and (coalesce(nr_seq_metrica_p,0) <> 0) then
		begin
		insert into ctb_regra_metrica(
			nr_sequencia,
			cd_estabelecimento,
			nr_seq_cenario,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_regra,
			nr_seq_metrica,
			nr_seq_mes_ref,
			cd_centro_custo,
			dt_mes_inic,
			dt_mes_fim,
			ie_regra,
			pr_aplicar,
			ie_sobrepor,
			qt_fixa)
		values (	nextval('ctb_regra_metrica_seq'),
			cd_estabelecimento_p,
			nr_seq_cenario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_regra_w,
			nr_seq_metrica_p,
			null,
			cd_centro_custo_p,
			dt_referencia_p,
			dt_refer_final_w,
			'QF',
			null,
			ie_sobrepor_w,
			vl_mes_w);
		end;
	else
		CALL wheb_mensagem_pck.exibir_mensagem_abort(241166);
	end if;

	end;
elsif (ie_regra_p = 1) then /* Regra ticket medio*/
	begin


	insert into ctb_regra_ticket_medio(
		nr_sequencia,
		cd_estabelecimento,
		nr_seq_cenario,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_regra,
		nr_seq_metrica,
		nr_seq_mes_ref,
		cd_centro_custo,
		cd_conta_contabil,
		dt_mes_inic,
		dt_mes_fim,
		ie_regra,
		pr_aplicar,
		ie_sobrepor,
		vl_fixo)
	values (	nextval('ctb_regra_ticket_medio_seq'),
		cd_estabelecimento_p,
		nr_seq_cenario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_regra_w,
		nr_seq_metrica_p,
		null,
		cd_centro_custo_p,
		cd_conta_contabil_p,
		dt_referencia_p,
		dt_refer_final_w,
		'VF',
		null,
		ie_sobrepor_w,
		vl_mes_w);
	end;
elsif (ie_regra_p = 2) then /*Regra valor */
	begin

	insert into ctb_orc_cen_regra(
		nr_sequencia,
		cd_estabelecimento,
		nr_seq_cenario,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_regra,
		nr_seq_mes_ref_orig,
		cd_centro_custo,
		cd_conta_contabil,
		cd_classif_conta,
		cd_classif_centro,
		nr_seq_criterio_rateio,
		dt_mes_inic,
		dt_mes_fim,
		cd_centro_origem,
		cd_conta_origem,
		ie_regra_valor,
		pr_aplicar,
		ie_sobrepor,
		vl_fixo)
	values (	nextval('ctb_orc_cen_regra_seq'),
		cd_estabelecimento_p,
		nr_seq_cenario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_regra_w,
		null,
		cd_centro_custo_p,
		cd_conta_contabil_p,
		null,
		null,
		null,
		dt_referencia_p,
		dt_refer_final_w,
		null,
		null,
		'VF',
		null,
		ie_sobrepor_w,
		vl_mes_w);
	end;
end if;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_regra_cenario ( cd_estabelecimento_p bigint, nr_seq_cenario_p bigint, ie_regra_p bigint, cd_centro_custo_p bigint, nr_seq_metrica_p bigint, cd_conta_contabil_p text, dt_referencia_p timestamp, dt_refer_final_p timestamp, vl_mes_p bigint, ie_sobrepor_p text, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

