-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE delete_med_guidance_prescr ( nr_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

cd_evolucao_w bigint;
ie_gerar_clinical_notes_w varchar(1) := 'N';
nr_sequencia_w bigint;
count_w bigint :=0;


BEGIN
ie_gerar_clinical_notes_w := obter_param_usuario(281, 1630, Obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, coalesce(wheb_usuario_pck.get_cd_estabelecimento, 1), ie_gerar_clinical_notes_w);

select count(NR_SEQ_MED_GUID)
into STRICT count_w
from MED_GUIDANCE_PRESCR
where  nr_atendimento 	= nr_atendimento_p
and     nm_usuario 		= nm_usuario_p;

if (ie_gerar_clinical_notes_w='S' and count_w > 0)then
 select NR_SEQ_MED_GUID
into STRICT nr_sequencia_w
from MED_GUIDANCE_PRESCR
where  nr_atendimento 	= nr_atendimento_p
and     nm_usuario 		= nm_usuario_p;

   select cd_evolucao
   into STRICT cd_evolucao_w
   from MED_GUIDANCE_PRESCR a, MEDICAL_GUIDANCE_ORDER b
   where a.NR_SEQ_MED_GUID = nr_sequencia_w
   and a.NR_SEQ_MED_GUID=b.nr_sequencia;

if (coalesce(cd_evolucao_w ,0) > 0) then
    delete from clinical_note_soap_data where cd_evolucao = cd_evolucao_w  and ie_med_rec_type = 'MED_GUIDANCE' and ie_stage = 1 and ie_soap_type = 'P' and nr_seq_med_item=nr_sequencia_w;
	CALL clinical_notes_pck.soap_data_after_delete(cd_evolucao_w);
	end if;
    end if;
delete
from    med_guidance_prescr
where   nr_atendimento 	= nr_atendimento_p
and     nm_usuario 		= nm_usuario_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE delete_med_guidance_prescr ( nr_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

