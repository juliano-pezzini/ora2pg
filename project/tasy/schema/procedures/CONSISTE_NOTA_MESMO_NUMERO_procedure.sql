-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_nota_mesmo_numero ( cd_estabelecimento_p bigint, cd_cnpj_p text, cd_pessoa_fisica_p text, cd_serie_nf_p text, nr_nota_fiscal_p text, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		nota_fiscal.nr_sequencia%type := 0;
cd_perfil_w		perfil.cd_perfil%type;
ie_param_108_w		varchar(15);


BEGIN

cd_perfil_w	:= Obter_perfil_ativo;

select	substr(coalesce(obter_valor_param_usuario(270,108, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p),'N'),1,1)
into STRICT	ie_param_108_w
;

if (ie_param_108_w = 'S') then
	begin

	if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
		begin
		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_sequencia_w
		from	nota_fiscal
		where	ie_situacao = 1
		and	(dt_atualizacao_estoque IS NOT NULL AND dt_atualizacao_estoque::text <> '')
		and	cd_estabelecimento	= cd_estabelecimento_p
		and	cd_cgc_emitente		= cd_cnpj_p
		and	cd_cgc			= cd_cnpj_p
		and	cd_pessoa_fisica	= cd_pessoa_fisica_p
		and	cd_serie_nf		= cd_serie_nf_p
		and	nr_nota_fiscal		= nr_nota_fiscal_p;
		end;
	else
		begin
		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_sequencia_w
		from	nota_fiscal
		where	ie_situacao = 1
		and	(dt_atualizacao_estoque IS NOT NULL AND dt_atualizacao_estoque::text <> '')
		and	cd_estabelecimento	= cd_estabelecimento_p
		and	cd_cgc_emitente		= cd_cnpj_p
		and	cd_cgc			= cd_cnpj_p
		and	cd_serie_nf		= cd_serie_nf_p
		and	nr_nota_fiscal		= nr_nota_fiscal_p;
		end;
	end if;
	end;
end if;

if (nr_sequencia_w > 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(653494,'NR_SEQUENCIA_W='||nr_sequencia_w);
	/*Já existe a nota fiscal (Seq: #@NR_SEQUENCIA_W#@) com o mesmo número para o mesmo CNPJ, mesmo estabelecimento e mesma série. Verifique!*/

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_nota_mesmo_numero ( cd_estabelecimento_p bigint, cd_cnpj_p text, cd_pessoa_fisica_p text, cd_serie_nf_p text, nr_nota_fiscal_p text, nm_usuario_p text) FROM PUBLIC;

