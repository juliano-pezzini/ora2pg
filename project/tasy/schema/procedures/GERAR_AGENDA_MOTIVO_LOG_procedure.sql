-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_agenda_motivo_log (CD_AGENDA_p bigint, cd_agenda_origem_p bigint, nr_seq_motivo_p bigint, DT_AGENDA_ORIGEM_p timestamp, DT_AGENDA_DESTINO_p timestamp, NM_PACIENTE_p text, CD_CONVENIO_p bigint, CD_PROCEDIMENTO_p bigint, IE_ORIGEM_PROCED_p bigint, CD_MEDICO_p text, cd_pessoa_fisica_p text, nr_seq_agenda_orig_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_log_w		bigint;
cd_agenda_w		bigint	:= null;
cd_convenio_w		bigint	:= null;
cd_procedimento_w	bigint	:= null;
ie_origem_proced_w	bigint	:= null;
cd_medico_w		varchar(10)	:= null;
nm_paciente_w		varchar(80)	:= null;
cd_pessoa_fisica_w	varchar(10)	:= null;
nm_pessoa_fisica_w	varchar(80)	:= null;
cd_tipo_agenda_w	bigint;
nr_telefone_w		varchar(80);


BEGIN 
 
select	coalesce(max(cd_tipo_agenda),0) 
into STRICT	cd_tipo_agenda_w 
from	agenda 
where	cd_agenda	= cd_agenda_p;
 
if (nr_seq_agenda_orig_p > 0) then 
	begin 
	if (cd_tipo_agenda_w <> 3) then 
		select	max(cd_agenda), 
			max(cd_convenio), 
			max(cd_procedimento), 
			max(ie_origem_proced), 
			max(cd_medico), 
			max(nm_paciente), 
			max(cd_pessoa_fisica), 
			substr(max(nr_telefone),1,80) 
		into STRICT	cd_agenda_w, 
			cd_convenio_w, 
			cd_procedimento_w, 
			ie_origem_proced_w, 
			cd_medico_w, 
			nm_paciente_w, 
			cd_pessoa_fisica_w, 
			nr_telefone_w 
		from	agenda_paciente 
		where	nr_sequencia	= nr_seq_agenda_orig_p;
	else 
		select	max(cd_agenda), 
			max(cd_convenio), 
			max(nm_paciente), 
			max(cd_pessoa_fisica), 
			max(nr_telefone) 
		into STRICT	cd_agenda_w, 
			cd_convenio_w, 
			nm_paciente_w, 
			cd_pessoa_fisica_w, 
			nr_telefone_w 
		from	agenda_consulta 
		where	nr_sequencia	= nr_seq_agenda_orig_p;
	end if;
	end;
end if;	
 
 
select	MAX(SUBSTR(OBTER_NOME_PF(CD_PESSOA_FISICA),1,60))--max(nm_pessoa_fisica) 
into STRICT	nm_pessoa_fisica_w 
from	pessoa_fisica 
where	cd_pessoa_fisica	= coalesce(cd_pessoa_fisica_w, cd_pessoa_fisica_p);
 
 
select	nextval('agenda_motivo_log_seq') 
into STRICT	nr_seq_log_w
;
 
insert	into agenda_motivo_log( 
	NR_SEQUENCIA      , 
	CD_AGENDA       , 
	DT_ACAO        , 
	DT_AGENDA_ORIGEM    , 
	DT_ATUALIZACAO     , 
	NM_USUARIO       , 
	DT_AGENDA_DESTINO   , 
	NM_PACIENTE      , 
	CD_CONVENIO      , 
	CD_PROCEDIMENTO    , 
	IE_ORIGEM_PROCED    , 
	CD_MEDICO       , 
	nr_seq_motivo, 
	cd_agenda_destino, 
	nr_telefone) 
values (nr_seq_log_w, 
	coalesce(cd_agenda_w, CD_AGENDA_p), 
	clock_timestamp(), 
	DT_AGENDA_ORIGEM_p, 
	clock_timestamp(), 
	nm_usuario_p	, 
	DT_AGENDA_DESTINO_p, 
	substr(coalesce(nm_pessoa_fisica_w, coalesce(nm_paciente_W, NM_PACIENTE_p)),1,40), 
	coalesce(cd_convenio_w, CD_CONVENIO_p), 
	coalesce(cd_procedimento_w, CD_PROCEDIMENTO_p), 
	coalesce(IE_ORIGEM_PROCED_w, IE_ORIGEM_PROCED_p), 
	coalesce(cd_medico_w, CD_MEDICO_p), nr_seq_motivo_p, cd_agenda_p, nr_telefone_w);
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_agenda_motivo_log (CD_AGENDA_p bigint, cd_agenda_origem_p bigint, nr_seq_motivo_p bigint, DT_AGENDA_ORIGEM_p timestamp, DT_AGENDA_DESTINO_p timestamp, NM_PACIENTE_p text, CD_CONVENIO_p bigint, CD_PROCEDIMENTO_p bigint, IE_ORIGEM_PROCED_p bigint, CD_MEDICO_p text, cd_pessoa_fisica_p text, nr_seq_agenda_orig_p bigint, nm_usuario_p text) FROM PUBLIC;

