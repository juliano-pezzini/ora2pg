-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_alter_hor_prescr_adep ( nr_atendimento_p bigint, ie_tipo_item_p text, cd_item_p text, nr_prescricao_p bigint, nr_seq_item_p bigint, nr_seq_horario_p bigint, dt_horario_p timestamp, ie_alteracao_p bigint, ds_justificativa_p text, ds_observacao_p text, nr_seq_motivo_susp_p bigint, nm_usuario_p text, dt_alteracao_p timestamp default null, nr_seq_cpoe_p bigint default null) AS $body$
DECLARE


nr_seq_alter_w			bigint;
dt_atualizacao_w		timestamp := clock_timestamp();
nr_seq_proc_interno_w		bigint;
nr_seq_prot_glic_w 		bigint;
ie_param716_w       	varchar(1);
ie_susp_nurse_w       	varchar(1);
ie_acm_sn_w             varchar(1);
qt_dose_w               prescr_mat_hor.qt_dose%type;
cd_unid_med_dose_w      prescr_mat_hor.cd_unidade_medida_dose%type;


BEGIN
if (coalesce(nr_atendimento_p,0) > 0) and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') and (cd_item_p IS NOT NULL AND cd_item_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '') and (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') and (dt_horario_p IS NOT NULL AND dt_horario_p::text <> '') and (ie_alteracao_p IS NOT NULL AND ie_alteracao_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then

	select	nextval('prescr_mat_alteracao_seq')
	into STRICT	nr_seq_alter_w
	;


	if (ie_tipo_item_p in ('M','S','MAT','LD','IAG','IA', 'IAH')) then
	
		select a.qt_dose, a.cd_unidade_medida_dose, obter_se_acm_sn(b.ie_acm, b.ie_se_necessario)
		into STRICT qt_dose_w, cd_unid_med_dose_w, ie_acm_sn_w
		from prescr_mat_hor a,
             prescr_material b
		where a.nr_prescricao = b.nr_prescricao
        and   a.nr_seq_material = b.nr_sequencia
        and   a.nr_sequencia = nr_seq_horario_p;
	
		insert into prescr_mat_alteracao(
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_prescricao,
							nr_seq_prescricao,
							nr_seq_horario,
							dt_alteracao,
							cd_pessoa_fisica,
							ie_alteracao,
							ds_justificativa,
							ie_tipo_item,
							dt_horario,
							nr_atendimento,
							cd_item,
							nr_seq_motivo_susp,
							ds_observacao,
                            ie_acm_sn)
						values (
							nr_seq_alter_w,
							dt_atualizacao_w,
							nm_usuario_p,
							dt_atualizacao_w,
							nm_usuario_p,
							nr_prescricao_p,
							nr_seq_item_p,
							nr_seq_horario_p,
							coalesce(dt_alteracao_p, dt_atualizacao_w),
							obter_dados_usuario_opcao(nm_usuario_p,'C'),
							ie_alteracao_p,
							ds_justificativa_p,
							ie_tipo_item_p,
							dt_horario_p,
							nr_atendimento_p,
							cd_item_p,
							nr_seq_motivo_susp_p,
							ds_observacao_p,
                            ie_acm_sn_w);
			
		if (ie_tipo_item_p = 'M') and (ie_alteracao_p = 12) then
			CALL gerar_susp_adep_processo_hor(nr_seq_horario_p,'5',nm_usuario_p);
		end if;
	elsif (ie_tipo_item_p in ('P','C','G')) then
	
		select	max(b.nr_seq_proc_interno),
				max(b.nr_seq_prot_glic)
		into STRICT	nr_seq_proc_interno_w,
				nr_seq_prot_glic_w
		from	prescr_proc_hor a,
			prescr_procedimento b
		where	a.nr_sequencia		= nr_seq_horario_p
		and	a.nr_prescricao		= b.nr_prescricao
		and	a.nr_seq_procedimento	= b.nr_sequencia;	
	
		insert into prescr_mat_alteracao(
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_prescricao,
							nr_seq_procedimento,
							nr_seq_horario_proc,
							dt_alteracao,
							cd_pessoa_fisica,
							ie_alteracao,
							ds_justificativa,
							ie_tipo_item,
							dt_horario,
							nr_atendimento,
							cd_item,
							nr_Seq_proc_interno,
							ds_observacao,
							nr_seq_prot_glic
							)
						values (
							nr_seq_alter_w,
							dt_atualizacao_w,
							nm_usuario_p,
							dt_atualizacao_w,
							nm_usuario_p,
							nr_prescricao_p,
							nr_seq_item_p,
							nr_seq_horario_p,
							dt_atualizacao_w,
							obter_dados_usuario_opcao(nm_usuario_p,'C'),
							ie_alteracao_p,
							ds_justificativa_p,
							ie_tipo_item_p,
							dt_horario_p,
							nr_atendimento_p,
							cd_item_p,
							nr_Seq_proc_interno_w,
							ds_observacao_p,
							nr_seq_prot_glic_w
							);
	elsif (ie_tipo_item_p = 'R') then
		insert into prescr_mat_alteracao(
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_prescricao,
							nr_seq_recomendacao,
							nr_seq_horario_rec,
							dt_alteracao,
							cd_pessoa_fisica,
							ie_alteracao,
							ds_justificativa,
							ie_tipo_item,
							dt_horario,
							nr_atendimento,
							cd_item
							)
						values (
							nr_seq_alter_w,
							dt_atualizacao_w,
							nm_usuario_p,
							dt_atualizacao_w,
							nm_usuario_p,
							nr_prescricao_p,
							nr_seq_item_p,
							nr_seq_horario_p,
							dt_atualizacao_w,
							obter_dados_usuario_opcao(nm_usuario_p,'C'),
							ie_alteracao_p,
							ds_justificativa_p,
							ie_tipo_item_p,
							dt_horario_p,
							nr_atendimento_p,
							cd_item_p
							);
	elsif (ie_tipo_item_p = 'E') then
		insert into prescr_mat_alteracao(
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_prescricao,
							nr_seq_item_sae,
							nr_seq_horario_sae,
							dt_alteracao,
							cd_pessoa_fisica,
							ie_alteracao,
							ds_justificativa,
							ie_tipo_item,
							dt_horario,
							nr_atendimento,
							cd_item
							)
						values (
							nr_seq_alter_w,
							dt_atualizacao_w,
							nm_usuario_p,
							dt_atualizacao_w,
							nm_usuario_p,
							nr_prescricao_p,
							nr_seq_item_p,
							nr_seq_horario_p,
							dt_atualizacao_w,
							obter_dados_usuario_opcao(nm_usuario_p,'C'),
							ie_alteracao_p,
							ds_justificativa_p,
							ie_tipo_item_p,
							dt_horario_p,
							nr_atendimento_p,
							cd_item_p
							);
	elsif (ie_tipo_item_p = 'D') then
		insert into prescr_mat_alteracao(
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_prescricao,
							nr_seq_horario_dieta,
							dt_alteracao,
							cd_pessoa_fisica,
							ie_alteracao,
							nr_seq_qualidade,
							ds_justificativa,
							ds_observacao,
							ie_tipo_item,
							dt_horario,
							nr_atendimento,
							cd_item
							)
						values (
							nr_seq_alter_w,
							dt_atualizacao_w,
							nm_usuario_p,
							dt_atualizacao_w,
							nm_usuario_p,
							nr_prescricao_p,
							nr_seq_horario_p,
							dt_atualizacao_w,
							obter_dados_usuario_opcao(nm_usuario_p,'C'),
							ie_alteracao_p,
							null,
							ds_justificativa_p,
							ds_observacao_p,
							ie_tipo_item_p,
							dt_horario_p,
							nr_atendimento_p,
							cd_item_p
							);
	end if;
end if;

ie_param716_w := obter_param_usuario(1113, 716, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo(), ie_param716_w);

if (ie_param716_w <> 'N') then
    ie_susp_nurse_w := 'N';
    if (ie_alteracao_p = 4) then
        ie_susp_nurse_w := 'S';
    end if;
	CALL generate_nurse_ack(ie_susp_nurse_w, ie_tipo_item_p, nr_atendimento_p, nr_seq_cpoe_p, cd_item_p);
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_alter_hor_prescr_adep ( nr_atendimento_p bigint, ie_tipo_item_p text, cd_item_p text, nr_prescricao_p bigint, nr_seq_item_p bigint, nr_seq_horario_p bigint, dt_horario_p timestamp, ie_alteracao_p bigint, ds_justificativa_p text, ds_observacao_p text, nr_seq_motivo_susp_p bigint, nm_usuario_p text, dt_alteracao_p timestamp default null, nr_seq_cpoe_p bigint default null) FROM PUBLIC;

