-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qt_obter_datas_calendario ( nr_seq_paciente_p bigint, nr_seq_pend_agenda_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, dt_min_p INOUT timestamp, dt_max_p INOUT timestamp, qt_duracao_p INOUT bigint) AS $body$
DECLARE


dt_min_w		timestamp;
dt_max_w		timestamp;
qt_duracao_w	bigint;
ie_adm_final_w	varchar(1);
ie_dias_fut_w	varchar(1);


BEGIN

ie_adm_final_w	:=	Obter_Valor_Param_Usuario(865, 104, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p);

ie_dias_fut_w	:=	Obter_Valor_Param_Usuario(865, 114, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p);

if (nr_seq_paciente_p IS NOT NULL AND nr_seq_paciente_p::text <> '') then
	select 	min(coalesce(dt_real,dt_prevista)),
			max(coalesce(dt_real,dt_prevista)),
			months_between(trunc(max(coalesce(dt_real,dt_prevista)),'month'),trunc(min(coalesce(dt_real,dt_prevista)),'month'))+1
	into STRICT	dt_min_w,
			dt_max_w,
			qt_duracao_w
	from 	paciente_atendimento_sim
	where 	nr_seq_paciente 	= nr_seq_paciente_p;

else
	if (ie_adm_final_w	= 'N') then
		select	min(coalesce(a.dt_real,a.dt_prevista)),
				max(coalesce(a.dt_real,a.dt_prevista)),
				months_between(trunc(max(coalesce(a.dt_real,a.dt_prevista)),'month'),trunc(min(coalesce(a.dt_real,a.dt_prevista)),'month'))+1
		into STRICT	dt_min_w,
				dt_max_w,
				qt_duracao_w
		from 	paciente_atendimento a
		where 	a.nr_seq_pend_Agenda	= nr_seq_pend_agenda_p
		and (coalesce(a.dt_fim_adm::text, '') = ''
		or		exists (SELECT 1 from agenda_quimio b where a.nr_seq_atendimento = b.nr_seq_Atendimento))
		and	((ie_dias_fut_w = 'S') and ((coalesce(dt_real, dt_prevista) > clock_timestamp()) or (not exists (select 1 from agenda_quimio y where y.nr_seq_atendimento = a.nr_seq_atendimento and ie_status_agenda not in ('S','C','F'))))
		or (ie_dias_fut_w = 'N'));
	else
		select	min(coalesce(a.dt_real,a.dt_prevista)),
				max(coalesce(a.dt_real,a.dt_prevista)),
				months_between(trunc(max(coalesce(a.dt_real,a.dt_prevista)),'month'),trunc(min(coalesce(a.dt_real,a.dt_prevista)),'month'))+1
		into STRICT	dt_min_w,
				dt_max_w,
				qt_duracao_w
		from 	paciente_atendimento a
		where 	a.nr_seq_pend_Agenda	= nr_seq_pend_agenda_p
		and	((ie_dias_fut_w = 'S') and ((coalesce(dt_real, dt_prevista) > clock_timestamp()) or (not exists (SELECT 1 from agenda_quimio y where y.nr_seq_atendimento = a.nr_seq_atendimento and ie_status_agenda <> 'S')))
		or (ie_dias_fut_w = 'N'));
	end if;
end if;

dt_min_p		:= dt_min_w;
dt_max_p		:= dt_max_w;
qt_duracao_p	:= qt_duracao_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qt_obter_datas_calendario ( nr_seq_paciente_p bigint, nr_seq_pend_agenda_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, dt_min_p INOUT timestamp, dt_max_p INOUT timestamp, qt_duracao_p INOUT bigint) FROM PUBLIC;

