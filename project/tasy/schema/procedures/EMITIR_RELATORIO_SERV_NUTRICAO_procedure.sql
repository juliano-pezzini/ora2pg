-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE emitir_relatorio_serv_nutricao ( ds_tipos_p text, nr_seq_nut_serv_dia_p bigint, ie_serv_lib_impressao_p text, ie_reimpressao_p text, nr_seq_servico_p bigint, cd_setor_atendimento_p bigint, dt_servico_p timestamp, ie_atualiza_item_extra_p text, nm_usuario_p text, cd_relatorio_lista_p INOUT text) AS $body$
DECLARE


cd_relatorio_w	integer;
nr_seq_tipo_w	bigint;
nr_seq_tipo_temp_w	bigint;
cd_relatorio_lista_w	varchar(4000);

C01 CURSOR FOR
	SELECT	distinct c.cd_relatorio,
		b.nr_sequencia nr_seq_tipo
	from	nut_relatorio_tipo a,
		nut_tipo_servico_imp b,
		relatorio c
	where	c.nr_sequencia = a.nr_seq_relatorio
	and	a.nr_seq_tipo_imp = b.nr_sequencia
	and	position(',' || b.nr_sequencia || ','  ',' || ds_tipos_p) > 0
	order by	nr_seq_tipo;


BEGIN

open C01;
loop
fetch C01 into	
	cd_relatorio_w,
	nr_seq_tipo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	if (coalesce(cd_relatorio_lista_w::text, '') = '') then
		cd_relatorio_lista_w	:= cd_relatorio_w;
	else
		cd_relatorio_lista_w	:= cd_relatorio_lista_w || ',' || cd_relatorio_w;
	end if;
	

	if (coalesce(nr_seq_tipo_temp_w::text, '') = '') or (nr_seq_tipo_temp_w <> nr_seq_tipo_w) then
		begin
		CALL nut_gravar_impressao_servicos(
			nr_seq_nut_serv_dia_p,
			ie_serv_lib_impressao_p,
			ie_reimpressao_p,
			nr_seq_servico_p,
			cd_setor_atendimento_p,
			dt_servico_p,
			nr_seq_tipo_w,
			nm_usuario_p);

		nr_seq_tipo_temp_w	:= nr_seq_tipo_w;
		end;
	end if;
	end;
end loop;
close C01;

if (ie_atualiza_item_extra_p = 'S') then
	CALL nut_atual_data_imp_item_extra(nr_seq_nut_serv_dia_p, nm_usuario_p);
end if;

cd_relatorio_lista_p	:= cd_relatorio_lista_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE emitir_relatorio_serv_nutricao ( ds_tipos_p text, nr_seq_nut_serv_dia_p bigint, ie_serv_lib_impressao_p text, ie_reimpressao_p text, nr_seq_servico_p bigint, cd_setor_atendimento_p bigint, dt_servico_p timestamp, ie_atualiza_item_extra_p text, nm_usuario_p text, cd_relatorio_lista_p INOUT text) FROM PUBLIC;

