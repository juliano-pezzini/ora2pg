-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE recebe_inpat_admiss ( nr_sequencia_p bigint, xml_p xml) AS $body$
DECLARE

 
ie_conversao_w			intpd_eventos_sistema.ie_conversao%type;
nr_seq_projeto_xml_w		intpd_eventos_sistema.nr_seq_projeto_xml%type;
nr_seq_sistema_w			intpd_eventos_sistema.nr_seq_sistema%type;
ie_sistema_externo_w		varchar(15);
reg_integracao_w			gerar_int_padrao.reg_integracao_conv;
nr_seq_regra_w			intpd_eventos_sistema.nr_seq_regra_conv%type;
ds_erro_w			varchar(4000);
i				integer;

pessoa_fisica_w			pessoa_fisica%rowtype;
compl_pessoa_fisica_w		compl_pessoa_fisica%rowtype;
qt_ant_w				bigint;
ie_atualizou_w			varchar(1) := 'N';

cd_pk_w				pessoa_fisica.cd_sistema_ant%type;

c01 CURSOR FOR 
SELECT	* 
from	xmltable('/STRUCTURE/InpatAdmissData' passing xml_p columns 
	ds_client					varchar(3)	path		'Client', 
	ds_institution				varchar(4)	path		'Institution', 
	ds_inststext				varchar(15)	path		'InstStext', 
	ds_patcaseid				varchar(10)	path		'Patcaseid', 
	ie_chkdigitcase				varchar(1)	path		'Chkdigitcase', 
	ie_casetype				varchar(1)	path		'Casetype', 
	ie_casetypeext				varchar(30)	path		'CasetypeExt', 
	ds_casetypestext				varchar(14)	path		'CasetypeStext', 
	ds_patientid				varchar(10)	path		'Patientid', 
	ie_billingstatus				varchar(1)	path		'BillingStatus', 
	ds_billstext				varchar(60)	path		'BillStext', 
	ie_restricted				varchar(1)	path		'Restricted', 
	ds_geograrea				varchar(9)	path		'GeogrArea', 
	ds_geograreatext				varchar(40)	path		'GeogrAreaText', 
	ds_casecomment				varchar(30)	path		'CaseComment', 
	ie_casestatus				varchar(1)	path		'CaseStatus', 
	cd_casestatstext				varchar(60)	path		'CaseStatStext', 
	ie_emergadm				varchar(1)	path		'EmergAdm', 
	ie_quickadm				varchar(1)	path		'QuickAdm', 
	ds_startdate				varchar(10)	path		'StartDate', 
	ds_enddate				varchar(10)	path		'EndDate', 
	ie_BillBlock				varchar(1)	path		'BillBlock', 
	ds_billblockstext 				varchar(60)	path		'BillBlockStext', 
	nr_prevtreatdays				smallint		path		'Prevtreatdays', 
	ie_StatstcBlock				varchar(1)	path		'StatstcBlock', 
	ie_pparelev				varchar(1)	path		'PpaRelev', 
	ds_recorder				varchar(12)	path		'RecOrder', 
	nr_previousdays				smallint		path		'PreviousDays', 
	ds_objectno				varchar(22)	path		'ObjectNo', 
	ie_nonresident				varchar(1)	path		'NonResident', 
	ds_children				varchar(2)	path		'Children', 
	ie_foreigncase				varchar(1)	path		'ForeignCase', 
	ds_casecategory				varchar(2)	path		'CaseCategory', 
	ds_casecategorystext			varchar(25)	path		'CaseCategoryStext', 
	ds_employeetype				varchar(2)	path		'EmployeeType', 
	ds_employeetypestext			varchar(20)	path		'EmployeeTypeStext', 
	ds_cantontariff				varchar(3)	path		'CantonTariff', 
	ds_cantontariffstext				varchar(25)	path		'CantonTariffStext', 
	ds_cantonconvtn				varchar(3)	path		'CantonConvtn', 
	dt_cantonconvtnstext			varchar(25)	path		'CantonConvtnStext', 
	ds_srvgento				varchar(10)	path		'SrvGenTo', 
	ds_healeddate				varchar(10)	path		'HealedDate', 
	ds_applstatus				varchar(2)	path		'Applstatus', 
	ds_applstatusstext				varchar(40)	path		'ApplstatusStext', 
	ds_specialty				varchar(4)	path		'Specialty', 
	ds_specialtystext				varchar(40)	path		'SpecialtyStext', 
	ds_caseendtype				varchar(2)	path		'Caseendtype', 
	ds_caseendtypestext			varchar(25)	path		'CaseendtypeStext', 
	ds_doctype				varchar(2)	path		'DocType', 
	ds_doctypetext				varchar(15)	path		'DocTypeText', 
	ds_docno					varchar(30)	path		'DocNo', 
	ie_choicecl				varchar(1)	path		'ChoiceCl', 
	ds_choicecltext				varchar(25)	path		'ChoiceClText', 
	nr_patweight				double precision	path		'PatWeight', 
	nr_weightunit				smallint		path		'WeightUnit', 
	ds_weightunitiso				varchar(3)	path		'WeightUnitIso', 
	nr_patheight				real	path		'PatHeight', 
	nr_heightunit				smallint		path		'HeightUnit', 
	ds_heightunitiso				varchar(3)	path		'HeightUnitIso', 
	nr_movemntseqno				integer		path		'MovemntSeqno', 
	ie_movemntctgry				varchar(1)	path		'MovemntCtgry', 
	ds_movemntctgrytext			varchar(15)	path		'MovemntCtgryText', 
	ds_movemnttype				varchar(2)	path		'MovemntType', 
	ds_movemnttypetext			varchar(15)	path		'MovemntTypeText', 
	ds_movemntreas1				varchar(2)	path		'MovemntReas1', 
	ds_movemntreas1text			varchar(15)	path		'MovemntReas1Text', 
	ds_movemntreas2				varchar(2)	path		'MovemntReas2', 
	ds_movemntreas2text			varchar(15)	path		'MovemntReas2Text', 
	ds_movemntdate				varchar(10)	path		'MovemntDate', 
	ds_movemnttime				varchar(10)	path		'MovemntTime', 
	ie_statusind				varchar(1)	path		'StatusInd', 
	ds_statusindtext				varchar(60)	path		'StatusIndText', 
	ds_movemntenddate			varchar(10)	path		'MovemntEnddate', 
	ds_movemntendtime			varchar(10)	path		'MovemntEndtime', 
	ds_treatmcategory				varchar(6)	path		'Treatmcategory', 
	ds_treatmctgrystext				varchar(15)	path		'TreatmctgryStext', 
	nr_treatmctgrytext				varchar(30)	path		'TreatmctgryText', 
	ds_class					varchar(4)	path		'Class', 
	ds_classstext				varchar(15)	path		'ClassStext', 
	ds_classtext				varchar(30)	path		'ClassText', 
	ds_movemntspec				varchar(4)	path		'MovemntSpec', 
	ds_movemntspecstext			varchar(30)	path		'MovemntSpecStext', 
	ds_admittdept				varchar(8)	path		'AdmittDept', 
	ds_admittdeptstext				varchar(12)	path		'AdmittDeptStext', 
	ds_department				varchar(8)	path		'Department', 
	ds_departmentstext				varchar(12)	path		'DepartmentStext', 
	ds_nurstreatou				varchar(8)	path		'NursTreatOu', 
	ds_nurstreatoustext				varchar(12)	path		'NursTreatOuStext', 
	ds_room					varchar(8)	path		'Room', 
	ds_roomidentifier				varchar(8)	path		'RoomIdentifier', 
	ds_bed					varchar(8)	path		'Bed', 
	ds_bedidentifier				varchar(8)	path		'BedIdentifier', 
	ie_roomstatusind				varchar(1)	path		'RoomStatusInd', 
	ds_roomstatusindtext			varchar(60)	path		'RoomStatusIndText', 
	ds_phoneno				varchar(16)	path		'Phoneno', 
	ie_tv					varchar(1)	path		'Tv', 
	nr_lengthofstay				integer		path		'LengthOfStay', 
	ds_refpsttrttype				varchar(2)	path		'RefPsttrtType', 
	ds_refpsttrttypetext				varchar(15)	path		'RefPsttrtTypeText', 
	ds_refhospital				varchar(10)	path		'RefHospital', 
	ds_waitlistprio		    		varchar(2)	path		'WaitlistPrio', 
	ds_waitlistpriotext				varchar(15)	path		'WaitlistPrioText', 
	ds_latestadm				varchar(10)	path		'LatestAdm', 
	ds_waitlisttype				varchar(6)	path		'WaitlistType', 
	ds_waitlisttypetext				varchar(25)	path		'WaitlistTypeText', 
	ds_waitlistdeldat				varchar(10)	path		'WaitlistDeldat', 
	ds_waitlistdelreas		  		varchar(3)	path		'WaitlistDelreas', 
	ds_waitlistdelreastext			varchar(60)	path		'WaitlistDelreasText', 
	ds_waitliststatus				varchar(2)	path		'WaitlistStatus', 
	ds_waitliststatustext				varchar(20)	path		'WaitlistStatusText', 
	ds_waitlisthosp				varchar(10)	path		'WaitlistHosp', 
	ds_waitlistinclon		  		varchar(10)	path		'WaitlistInclon', 
	ie_treatcode				varchar(1)	path		'TreatCode', 
	ds_treatcodetext				varchar(25)	path		'TreatCodeText', 
	ie_emergcase				varchar(1)	path		'EmergCase', 
	ds_accident				varchar(3)	path		'Accident', 
	ds_accidenttext				varchar(15)	path		'AccidentText', 
	ds_accidentdate		    		varchar(10)	path		'AccidentDate', 
	ds_accidenttime				varchar(10)	path		'AccidentTime', 
	ds_accidentno				varchar(12)	path		'AccidentNo', 
	ds_accidentloc				varchar(25)	path		'AccidentLoc', 
	ds_accidentemsvce		  		varchar(15)	path		'AccidentEmsvce', 
	ie_accident3rdpty				varchar(1)	path		'Accident3rdpty', 
	ds_accidentemstyp				varchar(4)	path		'AccidentEmstyp', 
	ds_accidentemstyptext			varchar(20)	path		'AccidentEmstypText', 
	ds_arrivalmode				varchar(2)	path		'ArrivalMode', 
	ds_arrivalmodetext		  		varchar(20)	path		'ArrivalModeText', 
	ds_creationdate				varchar(10)	path		'CreationDate', 
	ds_creationuser				varchar(12)	path		'CreationUser', 
	ds_updatedate				varchar(10)	path		'UpdateDate', 
	ds_updateuser				varchar(12)	path		'UpdateUser', 
	ie_cancelind				varchar(1)	path		'CancelInd', 
	ds_canceldate		    		varchar(10)	path		'CancelDate', 
	ds_canceluser				varchar(12)	path		'CancelUser', 
	ds_cancelreason		    		varchar(3)	path		'CancelReason', 
	ds_cancelreasontext			varchar(15)	path		'CancelReasonText', 
	qt_cancelreasontext			varchar(10)	path		'CreationTime', 
	nr_respiration				integer		path		'Respiration', 
	ds_extcaseid				varchar(20)	path		'ExtCaseId', 
	ds_extmovementid		  		varchar(20)	path		'ExtMovementId', 
	ds_refphys				varchar(10)	path		'RefPhys', 
	ds_famphys				varchar(10)	path		'FamPhys', 
	ds_attphys				varchar(10)	path		'AttPhys', 
	ds_admphys				varchar(10)	path		'AdmPhys', 
	nr_nobilldays				smallint		path		'NobillDays', 
	ds_plsno		    			varchar(20)	path		'PlsNo', 
	ie_invoicecopy		    		varchar(1)	path		'InvoiceCopy', 
	ds_refphysbsnr				varchar(9)	path		'RefPhysBsnr', 
	ds_refphyslanr				varchar(9)	path		'RefPhysLanr', 
	ds_attphyslanr				varchar(9)	path		'AttPhysLanr', 
	ds_refhospitalname2			varchar(35)	path		'refhospitalname2', 
	ds_refhospitalname3		  	varchar(35)	path		'RefHospitalName3', 
	ie_mentalhealthlegalstatus			varchar(1)	path		'MentalHealthLegalStatus', 
	ie_mentalhealthlegalstatustxt			varchar(40)	path		'MentalHealthLegalStatusTxt', 
	ds_postdisphys				varchar(10)	path		'PostDisPhys', 
	ie_readmission				varchar(1)	path		'Readmission', 
	ds_lastmenstrualperiod			varchar(10)	path		'LastMenstrualPeriod', 
	nr_weeksatdelivery		    		smallint		path		'WeeksAtDelivery');
	
c01_w	c01%rowtype;
	
c02 CURSOR FOR 
SELECT	* 
from	xmltable('/COMPLEMENT/InpatAdmissDataAt' passing xml_p columns 
	nr_weekofpregnancy			smallint		path		'WeekOfPregnancy', 
	ie_caretickettype				varchar(1)	path		'CareTicketType', 
	ds_reasonoftreatment			varchar(2)	path		'ReasonOfTreatment', 
	ie_admissiontype2				varchar(1)	path		'AdmissionType2', 
	ds_ereferralcode				varchar(5)	path		'EreferralCode', 
	ds_ereferralnumber				varchar(20)	path		'EreferralNumber');
	
c02_w	c02%rowtype;
	

BEGIN 
update	intpd_fila_transmissao 
set	ie_status = 'R' 
where	nr_sequencia = nr_sequencia_p;
 
commit;
 
begin 
select	coalesce(b.ie_conversao,'I'), 
	nr_seq_sistema, 
	nr_seq_projeto_xml, 
	nr_seq_regra_conv 
into STRICT	ie_conversao_w, 
	nr_seq_sistema_w, 
	nr_seq_projeto_xml_w, 
	nr_seq_regra_w 
from	intpd_fila_transmissao a, 
	intpd_eventos_sistema b 
where	a.nr_seq_evento_sistema = b.nr_sequencia 
and	a.nr_sequencia = nr_sequencia_p;
 
 
open c01;
loop 
fetch c01 into	 
	c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	 
		if (ie_atualizou_w = 'S')	then 
			update	intpd_fila_transmissao 
			set	ie_status		= 'S', 
				nr_seq_documento	= pessoa_fisica_w.cd_pessoa_fisica 
			where	nr_sequencia		= nr_sequencia_p;
		end if;		
	end;
end loop;
close c01;
exception 
when others then 
	begin 
	ds_erro_w	:=	substr(sqlerrm,1,4000);
	rollback;
	update	intpd_fila_transmissao 
	set	ie_status = 'E', 
		ds_log = ds_erro_w 
	where	nr_sequencia = nr_sequencia_p;
	end;
end;
 
open c02;
loop 
fetch c02 into	 
	c02_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin 
		if (ie_atualizou_w = 'S')	then 
			update	intpd_fila_transmissao 
			set	ie_status		= 'S', 
				nr_seq_documento	= pessoa_fisica_w.cd_pessoa_fisica 
			where	nr_sequencia		= nr_sequencia_p;
		end if;				
	end;
end loop;
close c02;
	 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE recebe_inpat_admiss ( nr_sequencia_p bigint, xml_p xml) FROM PUBLIC;

