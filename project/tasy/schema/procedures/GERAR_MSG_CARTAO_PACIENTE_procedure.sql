-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_msg_cartao_paciente ( cd_pessoa_fisica_p text, ds_msg_pac_p INOUT text, ds_msg_pac_class_p INOUT text) AS $body$
DECLARE


ds_cartao_w		varchar(60);
ds_obs_cadastro_w	varchar(255);
ds_observacao_w		varchar(255);
ds_classificacao_w	varchar(80);

ds_mensagem_w		varchar(2000);
ds_mensagem_class_w	varchar(2000);


c01 CURSOR FOR
SELECT	a.ds_cartao,
	a.ds_observacao ds_obs_cadastro,
	b.ds_observacao
from   	cartao_fidelidade a, pf_cartao_fidelidade b
where  	a.nr_sequencia = b.nr_seq_cartao
and    	a.ie_situacao = 'A'
and    	cd_pessoa_fisica = cd_pessoa_fisica_p;



c02 CURSOR FOR
SELECT	a.ds_classificacao,
	a.ds_observacao ds_obs_cadastro,
	b.ds_observacao
from	classif_pessoa a, pessoa_classif b
where	a.nr_sequencia = b.nr_seq_classif
and	a.ie_situacao = 'A'
and	obter_se_mostra_alerta_classif(988, a.nr_sequencia) = 'S'
and	b.cd_pessoa_fisica = cd_pessoa_fisica_p;


BEGIN

open c01;
loop
fetch c01 into
	ds_cartao_w,
	ds_obs_cadastro_w,
	ds_observacao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

	ds_mensagem_w := substr(ds_mensagem_w || '-> '|| ds_cartao_w || '\n',1,2000);

	if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
		ds_mensagem_w := substr(ds_mensagem_w || '    ' || wheb_mensagem_pck.get_texto(316142, 'DS_OBSERVACAO='||ds_observacao_w) || '\n',1,2000);
	end if;

	if (ds_obs_cadastro_w IS NOT NULL AND ds_obs_cadastro_w::text <> '') then
		ds_mensagem_w := substr(ds_mensagem_w || '    ' || wheb_mensagem_pck.get_texto(316144, 'DS_OBSERVACAO='||ds_obs_cadastro_w) || '\n',1,2000);
	end if;

end loop;

close c01;



open c02;
loop
fetch c02 into
	ds_classificacao_w,
	ds_obs_cadastro_w,
	ds_observacao_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin

	ds_mensagem_class_w := substr(ds_mensagem_class_w || '-> '|| ds_classificacao_w || '\n',1,2000);

	if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
		ds_mensagem_class_w := substr(ds_mensagem_class_w || '    ' || wheb_mensagem_pck.get_texto(316142, 'DS_OBSERVACAO='||ds_observacao_w) || '\n',1,2000);
	end if;

	if (ds_obs_cadastro_w IS NOT NULL AND ds_obs_cadastro_w::text <> '') then
		ds_mensagem_class_w := substr(ds_mensagem_class_w || '    ' || wheb_mensagem_pck.get_texto(316144, 'DS_OBSERVACAO='||ds_obs_cadastro_w) || '\n',1,2000);
	end if;
	end;
end loop;
close c02;


ds_msg_pac_p		:= ds_mensagem_w;
ds_msg_pac_class_p	:= ds_mensagem_class_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_msg_cartao_paciente ( cd_pessoa_fisica_p text, ds_msg_pac_p INOUT text, ds_msg_pac_class_p INOUT text) FROM PUBLIC;

