-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_exame_lab_dependente ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, ie_opcao_p bigint, nr_atendimento_p bigint, nm_usuario_p text, nr_seq_exame_dep_p bigint, nr_seq_result_item_p bigint default null, qt_proced_dependente_p bigint default null) AS $body$
DECLARE



    ie_laboratorio_w			smallint;
    nr_seq_w					bigint;
    nr_seq_exame_w				bigint;
    nr_seq_exame_princ_w		bigint;
    cd_convenio_w				integer;
    cd_categoria_convenio_w     varchar(10);
    cd_procedimento_w			bigint;
    nr_seq_Proc_interno_w		exame_laboratorio.nr_seq_Proc_interno%type;
    ie_origem_proced_w			bigint;
    QT_PROCED_W					double precision;
    DS_HORARIOS_w				varchar(255);
    DS_OBSERVACAO_w				varchar(2000);
    CD_PROCEDIMENTO_AIH_w		varchar(8);
    CD_INTERVALO_w				varchar(7);
    IE_URGENCIA_w				varchar(1);
    CD_SETOR_ATENDIMENTO_w		integer;
    CD_SETOR_ATENDIMENTO_ww		prescr_medica.cd_setor_atendimento%type;
    DT_EMISSAO_SETOR_ATEND_w	timestamp;
    DS_DADO_CLINICO_w			varchar(2000);
    DT_PREV_EXECUCAO_w			timestamp;
    IE_SUSPENSO_w				varchar(1);
    CD_MATERIAL_original_w		varchar(20);
    CD_MATERIAL_EXAME_w			varchar(20);
    DS_MATERIAL_ESPECIAL_w		varchar(255);
    IE_AMOSTRA_w				varchar(1);
    IE_STATUS_ATEND_w			smallint;
    CD_MOTIVO_BAIXA_W			smallint;
    IE_EMITE_MAPA_W				varchar(1);
    nr_sequencia_w				bigint;
    nr_seq_material_w			bigint;
    nr_seq_material_prescr_w	bigint;
    qt_exame_prescr_w			double precision;
    qt_tot_exame_prescr_w		double precision;
    qt_exame_regra_prescr_w		double precision;

    cd_setor_atual_usuario_w	integer;/* Oraci em 10/10/2007 OS70724 */
    cd_setor_atend_w			varchar(255);
    cd_setor_col_w				varchar(255);
    cd_setor_entrega_w			varchar(255):= null;
    qt_dia_entrega_w			numeric(20);
    ie_emite_mapa_set_w			varchar(255);
    ds_hora_fixa_w				varchar(255);
    ie_data_resultado_w			varchar(255);
    ie_atualizar_recoleta_w		varchar(255);
    dt_resultado_w				timestamp;
    qt_min_entrega_w			bigint;

    nr_seq_exame_ant_w			bigint;
    nr_seq_exame_presc_w		bigint;
    qt_exame_dep_w				smallint;
    dt_coleta_w					timestamp;

    ie_status_lote_ext_w		smallint;
    ie_atualizar_lote_ext_w		varchar(1);
    ie_material_exame_princ_w 	varchar(1);
    nr_seq_lote_externo_w		bigint;
    cd_estabelecimento_w		integer;
    nr_interno_conta_w			bigint;
    nr_seq_prescr_w				integer;
    cd_motivo_baixa_exame_w		smallint;
    ie_amostra_dep_w			varchar(1);
    cd_setor_coleta_w			integer;

    cd_setor_atendimento_prescr_w	integer;
    ie_dia_semana_final_w 	bigint;
    ie_dia_semana_upd_w	smallint;
    contador_w		integer;
    ie_restringe_dep_w	varchar(1);
    ie_baixa_prescr_w	varchar(1);
    cd_plano_convenio_w	varchar(10);
    ie_tipo_convenio_w	smallint;
    ie_tipo_atendimento_w	smallint;
    cd_categoria_w		varchar(10);
    ie_origem_proced_sus_w	bigint;
    ie_prioridade_edicao_w	varchar(01);
    cd_edicao_amb_w		bigint;
    dt_vigencia_w		timestamp;
    ie_origem_proced_cursor_w	bigint;
    vl_ch_honorarios_w	double precision	:= 1;
    vl_ch_custo_oper_w	double precision	:= 1;
    vl_m2_filme_w		double precision	:= 0;
    tx_ajuste_geral_w	double precision	:= 1;
    dt_inicio_vigencia_w	timestamp;
    dt_prescricao_w		timestamp;
    nr_seq_cbhpm_edicao_w	bigint;
    ie_data_exame_lab_w	varchar(1);
    nr_seq_grupo_imp_w	bigint;
    nr_seq_lab_w		varchar(20);
    nr_agrupamento_w	bigint;
    qt_min_atraso_w		bigint;
    qt_microorg_w			smallint;
    i					smallint;
    nr_seq_grupo_micro_w	cih_microorganismo.nr_seq_grupo%type;
    cd_cgc_laboratorio_w		prescr_procedimento.cd_cgc_laboratorio%type;
    cd_cgc_laboratorio_depend_w	prescr_procedimento.cd_cgc_laboratorio%type;
    ie_lab_exame_princ_w		exame_lab_dependente.ie_lab_exame_princ%type;

    ie_forma_atual_dt_result_w	exame_lab_regra_setor.ie_atul_data_result%type;
    cd_funcao_origem_w			prescr_procedimento.cd_funcao_origem%type;
    dt_inicio_prescr_w			timestamp;
    dt_validade_prescr_w		timestamp;
    dt_liberacao_w				timestamp;
    cd_pessoa_fisica_w			prescr_medica.cd_pessoa_fisica%type;

    ie_considera_micro_conta_w	exame_lab_dependente.ie_considera_micro_conta%type;
    ie_situacao_proc_interno_w  proc_interno.ie_situacao%type;
	 ds_erro_w					   varchar(2000);
    nr_seq_proc_interno_w_p   bigint;
    ie_medico_executor_w		varchar(10);
    cd_cgc_prest_regra_w		varchar(14);
    cd_medico_executor_w		pessoa_fisica.cd_pessoa_fisica%type;
    cd_pessoa_fisica_consite_w pessoa_fisica.cd_pessoa_fisica%type;
    cd_medico_exec_w          pessoa_fisica.cd_pessoa_fisica%type;
    cd_medico_prescr_w        pessoa_fisica.cd_pessoa_fisica%type;
    nr_seq_classificacao_w		bigint;
    ie_origem_inf_w			   varchar(1);
    cd_setor_prescricao_w     integer;


C01 CURSOR FOR
	SELECT a.QT_PROCEDIMENTO,
		 a.DS_HORARIOS,
		 a.DS_OBSERVACAO,
		 a.CD_PROCEDIMENTO_AIH,
		 a.CD_INTERVALO,
		 a.IE_URGENCIA,
		 a.CD_SETOR_ATENDIMENTO,
		 a.DT_EMISSAO_SETOR_ATEND,
		 a.DS_DADO_CLINICO,
		 a.DT_PREV_EXECUCAO,
		 a.IE_SUSPENSO,
		 a.CD_MATERIAL_EXAME,
		 a.NR_SEQ_EXAME,
		 a.DS_MATERIAL_ESPECIAL,
		 a.IE_AMOSTRA,
		 a.IE_STATUS_ATEND,
		 a.CD_MOTIVO_BAIXA,
		 a.IE_EMITE_MAPA,
		 a.IE_ORIGEM_PROCED,
		 a.nr_sequencia,
		 a.cd_setor_coleta,
		 a.cd_cgc_laboratorio,
       coalesce(a.cd_pessoa_coleta, a.cd_medico_exec),
       b.cd_medico,
       c.nr_seq_classificacao,
       a.ie_origem_inf,
       b.cd_setor_atendimento
	from	prescr_procedimento a,
         prescr_medica b,
         atendimento_paciente c
	where a.nr_prescricao = b.nr_prescricao
     and b.nr_atendimento = c.nr_atendimento
     and a.nr_prescricao	= nr_prescricao_p
	  and (a.nr_seq_exame IS NOT NULL AND a.nr_seq_exame::text <> '')
	  and ie_opcao_p = 0
	
union

	  SELECT a.QT_PROCEDIMENTO,
		 a.DS_HORARIOS,
		 a.DS_OBSERVACAO,
		 a.CD_PROCEDIMENTO_AIH,
		 a.CD_INTERVALO,
		 a.IE_URGENCIA,
		 a.CD_SETOR_ATENDIMENTO,
		 a.DT_EMISSAO_SETOR_ATEND,
		 a.DS_DADO_CLINICO,
		 a.DT_PREV_EXECUCAO,
		 a.IE_SUSPENSO,
		 a.CD_MATERIAL_EXAME,
		 a.NR_SEQ_EXAME,
		 a.DS_MATERIAL_ESPECIAL,
		 a.IE_AMOSTRA,
		 a.IE_STATUS_ATEND,
		 a.CD_MOTIVO_BAIXA,
		 a.IE_EMITE_MAPA,
		 a.IE_ORIGEM_PROCED,
		 a.nr_sequencia,
		 a.cd_setor_coleta,
		 a.cd_cgc_laboratorio,
       coalesce(a.cd_pessoa_coleta, a.cd_medico_exec),
       b.cd_medico,
       c.nr_seq_classificacao,
       a.ie_origem_inf,
       b.cd_setor_atendimento
	from	prescr_procedimento a,
         prescr_medica b,
         atendimento_paciente c
	where a.nr_prescricao = b.nr_prescricao
   and   b.nr_atendimento = c.nr_atendimento
   and   a.nr_prescricao	= nr_prescricao_p
	and	a.nr_sequencia = nr_seq_prescr_p
	  and (a.nr_seq_exame IS NOT NULL AND a.nr_seq_exame::text <> '')
	  and ie_opcao_p in (6,10)
	order by nr_seq_exame;

C02 CURSOR FOR
	SELECT  distinct
		a.nr_seq_exame_dep,
		coalesce(b.cd_procedimento,c.cd_procedimento),
		coalesce(b.ie_origem_proced,c.ie_origem_proced),
		a.nr_seq_material,
		a.nr_seq_exame,
		a.ie_material_exame_princ,
		a.cd_motivo_baixa,
		coalesce(a.cd_setor_atendimento,cd_setor_atendimento_w),
		coalesce(a.cd_convenio,cd_convenio_w),
        coalesce(a.cd_categoria,cd_categoria_convenio_w),
		a.ie_amostra,
		coalesce(a.ie_baixa_prescr,'N'),
		coalesce(a.ie_lab_exame_princ,'N'),
		coalesce(a.ie_considera_micro_conta, 'N'),
      c.nr_seq_proc_interno
	FROM exame_laboratorio c, exame_lab_dependente a
LEFT OUTER JOIN exame_lab_convenio b ON (a.nr_seq_exame_dep = b.nr_seq_exame AND ie_origem_proced_w = b.ie_origem_proced)
WHERE a.nr_seq_exame = nr_seq_exame_presc_w and coalesce(a.cd_convenio,cd_convenio_w) = cd_convenio_w and coalesce(a.cd_setor_atendimento,cd_setor_atendimento_w) = cd_setor_atendimento_w   and a.nr_seq_exame_dep = c.nr_seq_exame  and a.ie_geracao = ie_opcao_p and coalesce(a.cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w and coalesce(a.cd_setor_prescricao,cd_setor_atendimento_prescr_w) = cd_setor_atendimento_prescr_w and coalesce(a.nr_seq_material_regra,nr_seq_material_prescr_w) = nr_seq_material_prescr_w and coalesce(c.ie_situacao,'A') = 'A' and ((ie_opcao_p in (0,6)) or
	       (((ie_opcao_p = 1) or (ie_opcao_p = 5)) and (coalesce(a.nr_seq_grupo_micro,nr_seq_grupo_micro_w) = nr_seq_grupo_micro_w)
		and not exists (SELECT 1 from procedimento_paciente x
				where x.nr_prescricao	= nr_prescricao_p
				  and x.nr_seq_exame	= a.nr_seq_exame_dep
				  and ((coalesce(a.ie_agrupa_conta,'S') = 'S') or (x.nr_sequencia_prescricao = nr_seq_prescr_p)))))      and ((((ie_origem_proced_sus_w	not in (2,3))  or (b.ie_origem_proced = ie_origem_proced_sus_w)) and (coalesce(b.ie_origem_proced_regra::text, '') = '')) or
		(b.ie_origem_proced_regra IS NOT NULL AND b.ie_origem_proced_regra::text <> '' AND b.ie_origem_proced_regra = ie_origem_proced_cursor_w))     order by coalesce(a.cd_convenio,cd_convenio_w), coalesce(a.cd_setor_atendimento,cd_setor_atendimento_w), a.nr_seq_exame_dep;

C02_10 CURSOR FOR
	SELECT  distinct
		a.nr_seq_exame_dep,
		coalesce(b.cd_procedimento,c.cd_procedimento),
		coalesce(b.ie_origem_proced,c.ie_origem_proced),
		a.nr_seq_material,
		a.nr_seq_exame,
		a.ie_material_exame_princ,
		a.cd_motivo_baixa,
		coalesce(a.cd_setor_atendimento,cd_setor_atendimento_w),
		coalesce(a.cd_convenio,cd_convenio_w),
		a.ie_amostra,
		coalesce(a.ie_baixa_prescr,'N'),
		coalesce(a.ie_lab_exame_princ,'N'),
		coalesce(a.ie_considera_micro_conta, 'N')
	FROM exame_laboratorio c, exame_lab_dependente a
LEFT OUTER JOIN exame_lab_convenio b ON (a.nr_seq_exame_dep = b.nr_seq_exame AND ie_origem_proced_w = b.ie_origem_proced)
WHERE a.nr_seq_exame = nr_seq_exame_presc_w and coalesce(a.cd_convenio,cd_convenio_w) = cd_convenio_w and coalesce(a.cd_setor_atendimento,cd_setor_atendimento_w) = cd_setor_atendimento_w   and a.nr_seq_exame_dep = c.nr_seq_exame  and a.ie_geracao = ie_opcao_p and coalesce(a.cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w and coalesce(a.cd_setor_prescricao,cd_setor_atendimento_prescr_w) = cd_setor_atendimento_prescr_w and coalesce(a.nr_seq_material_regra,nr_seq_material_prescr_w) = nr_seq_material_prescr_w and coalesce(c.ie_situacao,'A') = 'A' and ie_opcao_p = 10 and coalesce(a.cd_categoria, cd_categoria_w)	= cd_categoria_w      and ((((ie_origem_proced_sus_w	not in (2,3))  or (b.ie_origem_proced = ie_origem_proced_sus_w)) and (coalesce(b.ie_origem_proced_regra::text, '') = '')) or
		(b.ie_origem_proced_regra IS NOT NULL AND b.ie_origem_proced_regra::text <> '' AND b.ie_origem_proced_regra = ie_origem_proced_cursor_w))     and not exists (SELECT 1 from prescr_procedimento x where x.nr_prescricao = nr_prescricao_p and x.nr_seq_superior = nr_seq_prescr_p and x.nr_seq_exame = a.nr_seq_exame_dep) order by coalesce(a.cd_convenio,cd_convenio_w), coalesce(a.cd_setor_atendimento,cd_setor_atendimento_w), a.nr_seq_exame_dep;

c03 CURSOR FOR
	SELECT distinct a.qt_procedimento,
		 a.ds_horarios,
		 a.ds_observacao,
		 a.cd_procedimento_aih,
		 a.cd_intervalo,
		 a.ie_urgencia,
		 a.cd_setor_atendimento,
		 a.dt_emissao_setor_atend,
		 a.ds_dado_clinico,
		 a.dt_prev_execucao,
		 a.ie_suspenso,
		 a.cd_material_exame,
		 a.nr_seq_exame,
		 a.ds_material_especial,
		 a.ie_amostra,
		 coalesce(b.ie_status_exame,a.ie_status_atend),
		 a.cd_motivo_baixa,
		 a.ie_emite_mapa,
		 b.nr_seq_exame_dep,
		 coalesce(d.cd_procedimento,c.cd_procedimento),
		 coalesce(d.ie_origem_proced,c.ie_origem_proced),
		 b.nr_seq_material,
		 a.dt_coleta,
		 a.nr_sequencia,
		 b.cd_motivo_baixa,
		 a.cd_setor_coleta
	FROM exame_laboratorio c, prescr_procedimento a, exame_lab_dependente b
LEFT OUTER JOIN exame_lab_convenio d ON (b.nr_seq_exame_dep = d.nr_seq_exame AND ie_origem_proced_w = d.ie_origem_proced)
WHERE coalesce(b.cd_setor_atendimento,a.cd_setor_atendimento) = a.cd_setor_atendimento and coalesce(b.cd_convenio,cd_convenio_w) = cd_convenio_w   and (((b.nr_seq_exame_dep = c.nr_seq_exame) and (coalesce(nr_seq_exame_dep_p::text, '') = '')) or
			((nr_seq_exame_dep_p IS NOT NULL AND nr_seq_exame_dep_p::text <> '') and (b.nr_seq_exame_dep = nr_seq_exame_dep_p) and (b.nr_seq_exame_dep = c.nr_seq_exame)))  and coalesce(b.cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w and a.nr_seq_exame = b.nr_seq_exame and a.nr_prescricao	= nr_prescricao_p and a.nr_sequencia = nr_seq_prescr_p and b.ie_geracao in (3,ie_opcao_p,9) and coalesce(c.ie_situacao,'A') = 'A' and coalesce(b.nr_seq_material_regra,nr_seq_material_prescr_w) = nr_seq_material_prescr_w  and (((coalesce(b.ie_restringe_dep,'N') = 'S') and (not exists (SELECT 1 from prescr_procedimento e
	  	  	  where e.nr_seq_exame =  b.nr_seq_exame_dep
			    and   e.nr_prescricao = a.nr_prescricao
			    and ie_origem_inf = 'L'))) or (coalesce(b.ie_restringe_dep,'N') = 'N')
				or ( (coalesce(b.ie_restringe_dep,'N') = 'E') and (not exists (	select  1
									from 	prescr_procedimento z
									where 	z.nr_prescricao = a.nr_prescricao
									and 	z.nr_seq_superior = a.nr_sequencia
									and		z.nr_seq_exame = b.nr_seq_exame_dep))))      and coalesce(b.nr_seq_grupo_micro,nr_seq_grupo_micro_w) = nr_seq_grupo_micro_w and ((((ie_origem_proced_sus_w	not in (2,3))  or (d.ie_origem_proced = ie_origem_proced_sus_w)) and (coalesce(d.ie_origem_proced_regra::text, '') = '')) or
		(d.ie_origem_proced_regra IS NOT NULL AND d.ie_origem_proced_regra::text <> '' AND d.ie_origem_proced_regra = ie_origem_proced_cursor_w))    order by b.nr_seq_exame_dep;

	procedure considerar_micro_conta(
		cd_convenio_w_p				in out 	bigint,
        cd_categoria_convenio_w_p   in      text,
		cd_procedimento_w_p 		in out 	bigint,
		cd_setor_atendimento_w_p 	in out 	bigint,
		ie_origem_proced_w_p 		in out 	bigint,
		nm_usuario_p_p 				in 		text,
		nr_seq_exame_w_p	 		in out 	bigint,
		nr_sequencia_w_p 			in out 	bigint
		) is

		ie_status_acerto_w 			integer;
      nr_sequencia_w             bigint;
	
BEGIN

      select nextval('procedimento_paciente_seq')
      into STRICT nr_sequencia_w
;

      insert into Procedimento_paciente(
         nr_sequencia, nr_atendimento, dt_entrada_unidade, cd_procedimento,
         dt_procedimento, qt_procedimento, dt_atualizacao, nm_usuario,
         cd_medico, cd_convenio, cd_categoria, cd_pessoa_fisica, dt_prescricao,
         ds_observacao, vl_procedimento, vl_medico, vl_anestesista,
         vl_materiais, cd_edicao_amb, cd_tabela_servico, dt_vigencia_preco,
         cd_procedimento_princ, dt_procedimento_princ, dt_acerto_conta,
         dt_acerto_convenio, dt_acerto_medico, vl_auxiliares, vl_custo_operacional,
         tx_medico, tx_anestesia, nr_prescricao, nr_sequencia_prescricao,
         cd_motivo_exc_conta, ds_compl_motivo_excon, cd_acao, qt_devolvida,
         cd_motivo_devolucao, nr_cirurgia, nr_doc_convenio, cd_medico_executor,
         ie_cobra_pf_pj, nr_laudo, dt_conta, cd_setor_atendimento,
         cd_conta_contabil, cd_procedimento_aih, ie_origem_proced, nr_aih,
         ie_responsavel_credito, tx_procedimento, cd_equipamento, ie_valor_informado,
         cd_estabelecimento_custo, cd_tabela_custo, cd_situacao_glosa,
         nr_lote_contabil, cd_procedimento_convenio, nr_seq_autorizacao,
         ie_tipo_servico_sus, ie_tipo_ato_sus, cd_cgc_prestador, nr_nf_prestador,
         cd_atividade_prof_bpa, nr_interno_conta, nr_seq_proc_princ, ie_guia_informada,
         dt_inicio_procedimento, ie_emite_conta, ie_funcao_medico, ie_classif_sus,
         cd_especialidade, nm_usuario_original, nr_seq_proc_pacote, ie_tipo_proc_sus,
         cd_setor_receita, vl_adic_plant, qt_porte_anestesico, tx_hora_extra,
         ie_emite_conta_honor, nr_seq_atepacu, ie_proc_princ_atend,
         cd_medico_req, ie_tipo_guia, ie_video, ie_auditoria, nr_seq_exame,nr_seq_aih,nr_seq_proc_interno, nr_seq_material,
         ie_via_acesso, ie_tecnica_utilizada)
      SELECT
         nr_sequencia_w, nr_atendimento, dt_entrada_unidade, cd_procedimento_w_p,
         dt_procedimento + 3/86400, qt_procedimento, clock_timestamp(), nm_usuario_p,
         cd_medico, cd_convenio_w_p, cd_categoria_convenio_w_p , cd_pessoa_fisica, dt_prescricao,
         ds_observacao, vl_procedimento, vl_medico, vl_anestesista,
         vl_materiais, cd_edicao_amb, cd_tabela_servico, dt_vigencia_preco,
         cd_procedimento_princ, dt_procedimento_princ, dt_acerto_conta,
         dt_acerto_convenio, dt_acerto_medico, vl_auxiliares, vl_custo_operacional,
         tx_medico, tx_anestesia, nr_prescricao, nr_sequencia_prescricao,
         cd_motivo_exc_conta, ds_compl_motivo_excon, cd_acao, qt_devolvida,
         cd_motivo_devolucao, nr_cirurgia, nr_doc_convenio, cd_medico_executor,
         ie_cobra_pf_pj, nr_laudo, dt_conta, cd_setor_atendimento,
         cd_conta_contabil, null /*cd_procedimento_aih*/
, ie_origem_proced_w_p, nr_aih,
         ie_responsavel_credito, tx_procedimento, cd_equipamento, ie_valor_informado,
         cd_estabelecimento_custo, cd_tabela_custo, cd_situacao_glosa,
         nr_lote_contabil, null/* cd_procedimento_convenio*/
, nr_seq_autorizacao,
         ie_tipo_servico_sus, ie_tipo_ato_sus, cd_cgc_prestador, nr_nf_prestador,
         cd_atividade_prof_bpa, nr_interno_conta, nr_seq_proc_princ, ie_guia_informada,
         dt_inicio_procedimento, ie_emite_conta, ie_funcao_medico, ie_classif_sus,
         cd_especialidade, nm_usuario_original, nr_seq_proc_pacote, ie_tipo_proc_sus,
         cd_setor_receita, vl_adic_plant, qt_porte_anestesico, tx_hora_extra,
         ie_emite_conta_honor, nr_seq_atepacu, ie_proc_princ_atend,
         cd_medico_req, ie_tipo_guia, ie_video, ie_auditoria, nr_seq_exame_w_p,nr_seq_aih,nr_seq_proc_interno_w_p, nr_seq_material,
         ie_via_acesso, ie_tecnica_utilizada
      from 	procedimento_paciente
      where 	nr_sequencia = nr_sequencia_w_p;


      select	max(a.ie_status_acerto)
      into STRICT	ie_status_acerto_w
      from	conta_paciente a,
            procedimento_paciente b
      where	a.nr_interno_conta		= b.nr_interno_conta
      and	b.nr_sequencia			= nr_sequencia_w;

      if (ie_Status_acerto_w	= 2) then
         begin
         update	procedimento_paciente
         set	nr_interno_conta	 = NULL
         where	nr_sequencia	= nr_sequencia_w;

         end;
      end if;

      CALL atualiza_preco_procedimento(nr_sequencia_w, cd_convenio_w_p, nm_usuario_p_p);

	end;

procedure add_dependencies is
    begin

    cd_cgc_laboratorio_depend_w := null;

    cd_material_exame_w := null;

    if (ie_opcao_p = 0 and ie_lab_exame_princ_w = 'S') then
    	cd_cgc_laboratorio_depend_w := cd_cgc_laboratorio_w;
    end if;

    if (coalesce(nr_seq_material_w::text, '') = '') then
    	if (coalesce(ie_material_exame_princ_w,'N') = 'S') then
    		begin
    		select	b.cd_material_exame
    		into STRICT	cd_material_exame_w
    		from	material_exame_lab b,
    			exame_lab_material a
    		where	a.nr_seq_material	= b.nr_sequencia
    		and	a.nr_seq_exame		= nr_seq_exame_princ_w
    		and	b.cd_material_exame	= CD_MATERIAL_original_w
    		and	a.ie_situacao 		= 'A';
    		exception
    			when no_data_found then
    				select	coalesce(max(cd_material_exame),'')
    				into STRICT	cd_material_exame_w
    				from (	SELECT	b.cd_material_exame
    					from	material_exame_lab b,
    						exame_lab_material a
    					where	a.nr_seq_material	= b.nr_sequencia
    					and	a.nr_seq_exame		= nr_seq_exame_princ_w
    					and	a.ie_situacao		= 'A'
    					order by a.ie_prioridade) alias2 LIMIT 1;
    				if (cd_material_exame_w = '') then
    					CALL wheb_mensagem_pck.exibir_mensagem_abort(195427, 'NR_SEQ_EXAME='|| nr_seq_exame_w);
    				end if;
    		end;

		-- Se o material do exame princial esta entre os materiais do exame dependente, entao lanca o material do exame dependente.
    		select	max(b.cd_material_exame)
    		into STRICT	cd_material_exame_w
    		from	material_exame_lab b,
    			exame_lab_material a
    		where	a.nr_seq_material	= b.nr_sequencia
    		and	a.nr_seq_exame		= nr_seq_exame_w
    		and	b.cd_material_exame	= cd_material_exame_w
    		and	a.ie_situacao 		= 'A';

    	else

    		begin
    		select b.cd_material_exame
    		into STRICT	cd_material_exame_w
    		from	material_exame_lab b,
    			exame_lab_material a
    		where a.nr_seq_material	= b.nr_sequencia
    		  and a.nr_seq_exame		= nr_seq_exame_w
    		  and b.cd_material_exame	= CD_MATERIAL_original_w
    		  and a.ie_situacao 		= 'A';
    		exception
    			when no_data_found then
    				select coalesce(max(cd_material_exame),'')
    				into STRICT	cd_material_exame_w
    				from (	SELECT b.cd_material_exame
    					from	material_exame_lab b,
    						exame_lab_material a
    					where a.nr_seq_material	= b.nr_sequencia
    					  and a.nr_seq_exame		= nr_seq_exame_w
    					  and a.ie_situacao		= 'A'
    					order by a.ie_prioridade) alias2 LIMIT 1;
    				if (cd_material_exame_w = '') then
    					CALL wheb_mensagem_pck.exibir_mensagem_abort(195427, 'NR_SEQ_EXAME='|| nr_seq_exame_w);
    				end if;
    		end;
    	end if;
    else
    	select	cd_material_exame
    	into STRICT	cd_material_exame_w
    	from	material_exame_lab
    	where	nr_sequencia = nr_seq_material_w;
    end if;

    begin

    if (cd_material_exame_w IS NOT NULL AND cd_material_exame_w::text <> '') then
    	if (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') then
    		select 	coalesce(sum(qt_procedimento),0)
    		into STRICT	qt_exame_prescr_w
    		from 	material_exame_lab y,
    				prescr_procedimento x
    		where 	x.nr_prescricao		= nr_prescricao_p
    		and 	x.nr_seq_exame		= nr_seq_exame_w
    		and 	x.cd_material_exame	= y.cd_material_exame
    		and		x.cd_material_exame	= cd_material_exame_w
    		and 	y.nr_sequencia		= nr_seq_material_w
    		and 	x.ie_origem_inf 	<> 'L';
    	else
    		select 	coalesce(sum(qt_procedimento),0)
    		into STRICT	qt_exame_prescr_w
    		from 	material_exame_lab y,
    				prescr_procedimento x
    		where 	x.nr_prescricao		= nr_prescricao_p
    		and 	x.nr_seq_exame		= nr_seq_exame_w
    		and 	x.cd_material_exame	= y.cd_material_exame
    		and		x.cd_material_exame	= cd_material_exame_w
    		and 	x.ie_origem_inf 	<> 'L';
    	end if;
    else
    	qt_exame_prescr_w := 0;
    end if;
    exception
    when others then
    	qt_exame_prescr_w := 0;
    end;

    qt_tot_exame_prescr_w := 0;
    begin
    if (cd_material_exame_w IS NOT NULL AND cd_material_exame_w::text <> '') then
    	if (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') then
    		select 	count(*)
    		into STRICT	qt_tot_exame_prescr_w
    		from 	material_exame_lab y, prescr_procedimento x
    		where 	x.nr_prescricao	= nr_prescricao_p
    		and 	x.nr_seq_exame		= nr_seq_exame_w
    		and 	x.cd_material_exame	= y.cd_material_exame
    		and		x.cd_material_exame	= cd_material_exame_w
    		and 	y.nr_sequencia		= nr_seq_material_w;
    	else
    		select 	count(*)
    		into STRICT	qt_tot_exame_prescr_w
    		from 	material_exame_lab y, prescr_procedimento x
    		where 	x.nr_prescricao	= nr_prescricao_p
    		and 	x.nr_seq_exame		= nr_seq_exame_w
    		and 	x.cd_material_exame	= y.cd_material_exame
    		and		x.cd_material_exame	= cd_material_exame_w;
    	end if;
    end if;

    exception
    when others then
    	qt_exame_prescr_w := 0;
    end;


    qt_exame_regra_prescr_w := 0;
    begin
    if (cd_material_exame_w IS NOT NULL AND cd_material_exame_w::text <> '') then
    	if (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') then
    		select 	count(*)
    		into STRICT	qt_exame_regra_prescr_w
    		from 	material_exame_lab y, prescr_procedimento x
    		where 	x.nr_prescricao	= nr_prescricao_p
    		and 	x.nr_seq_exame		= nr_seq_exame_w
    		and 	x.cd_material_exame	= y.cd_material_exame
    		and		x.cd_material_exame	= cd_material_exame_w
    		and 	y.nr_sequencia		= nr_seq_material_w
    		and 	x.ie_origem_inf 	= 'L';
    	else
    		select 	count(*)
    		into STRICT	qt_exame_regra_prescr_w
    		from 	material_exame_lab y, prescr_procedimento x
    		where 	x.nr_prescricao	= nr_prescricao_p
    		and 	x.nr_seq_exame		= nr_seq_exame_w
    		and 	x.cd_material_exame	= y.cd_material_exame
    		and		x.cd_material_exame	= cd_material_exame_w
    		and 	x.ie_origem_inf 	= 'L';
    	end if;
    end if;

    exception
    when others then
    	qt_exame_regra_prescr_w := 0;
    end;

    if (qt_exame_regra_prescr_w > 0) then
    	qt_tot_exame_prescr_w	:= qt_exame_regra_prescr_w;

    end if;

    nr_seq_w := nr_seq_w + 1;

    if ((QT_PROCED_w > qt_exame_prescr_w) or (qt_exame_dep_w > qt_tot_exame_prescr_w)) then
    	if (qt_exame_dep_w > qt_tot_exame_prescr_w) then
    	qt_exame_prescr_w := 0;

    	end if;
    	select	obter_setor_usuario(nm_usuario_p)
    	into STRICT	cd_setor_atual_usuario_w
    	;

    	SELECT * FROM obter_setor_exame_lab(	nr_prescricao_p, nr_seq_exame_w, cd_setor_atual_usuario_w, coalesce(cd_material_exame_w, cd_material_original_w), null, 'S', cd_setor_atend_w, cd_setor_col_w, cd_setor_entrega_w, qt_dia_entrega_w, ie_emite_mapa_set_w, ds_hora_fixa_w, ie_data_resultado_w, qt_min_entrega_w, ie_atualizar_recoleta_w, ie_urgencia_w, ie_dia_semana_final_w, ie_forma_atual_dt_result_w, qt_min_atraso_w) INTO STRICT cd_setor_atend_w, cd_setor_col_w, cd_setor_entrega_w, qt_dia_entrega_w, ie_emite_mapa_set_w, ds_hora_fixa_w, ie_data_resultado_w, qt_min_entrega_w, ie_atualizar_recoleta_w, ie_dia_semana_final_w, ie_forma_atual_dt_result_w, qt_min_atraso_w;

    	dt_resultado_w	:= null;

    	if (ds_hora_fixa_w IS NOT NULL AND ds_hora_fixa_w::text <> '') then
    		select	(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(coalesce(dt_entrada_unidade,dt_prescricao)) + (ds_hora_fixa_w/24)) + qt_dia_entrega_w + (CASE WHEN qt_min_entrega_w=0 THEN 0  ELSE qt_min_entrega_w/1440 END )
    		into STRICT	dt_resultado_w
    		from	prescr_medica
    		where 	nr_prescricao = nr_prescricao_p;
    	else
    		select	coalesce(dt_entrada_unidade,dt_prescricao) + qt_dia_entrega_w  + (CASE WHEN qt_min_entrega_w=0 THEN 0  ELSE qt_min_entrega_w/1440 END )
    		into STRICT	dt_resultado_w
    		from 	prescr_medica
    		where 	nr_prescricao = nr_prescricao_p;
    	end if;

    	if (ie_dia_semana_final_w > 0) then
    		select	pkg_date_utils.get_WeekDay(dt_resultado_w)
    		into STRICT	ie_dia_semana_upd_w
    		;

    		while(ie_dia_semana_upd_w <> ie_dia_semana_final_w) loop
    			dt_resultado_w := dt_resultado_w + 1;

    			select	pkg_date_utils.get_WeekDay(dt_resultado_w)
    			into STRICT	ie_dia_semana_upd_w
    			;
    		end loop;
    	end if;

    	contador_w := 0;
    	select	coalesce(max(ie_restringe_dep),'N')
    	into STRICT	ie_restringe_dep_w
    	from	exame_lab_dependente
    	where	nr_seq_exame_dep = nr_seq_exame_w
    	and		nr_seq_exame = nr_seq_exame_princ_w
    	and		coalesce(cd_convenio,cd_convenio_w) = cd_convenio_w
    	and 	ie_geracao = 0;

    	if (ie_restringe_dep_w = 'S') then
    		select 	count(*)
    		into STRICT	contador_w
    		from	prescr_procedimento
    		where 	nr_seq_exame = nr_seq_exame_w
    		and	nr_prescricao = nr_prescricao_p;
    	end if;

    	if (ie_opcao_p = 6) then

    		SELECT 	MAX(coalesce(lab_obter_grupo_imp_estab(cd_estabelecimento_w,a.nr_seq_exame, cd_convenio_w),a.nr_seq_grupo_imp))
    		INTO STRICT	nr_seq_grupo_imp_w
    		FROM	exame_laboratorio a
    		WHERE	a.nr_seq_exame =  nr_seq_exame_w;

    		SELECT 	MIN(nr_seq_lab)
    		INTO STRICT	nr_seq_lab_w
    		FROM prescr_procedimento b, exame_laboratorio a
LEFT OUTER JOIN exame_lab_grupo_imp c ON (a.nr_seq_exame = c.nr_seq_exame AND cd_estabelecimento_w = c.cd_estabelecimento AND cd_convenio_w = c.cd_convenio)
WHERE a.nr_seq_exame = b.nr_seq_exame    AND b.cd_material_exame = coalesce(cd_material_exame_w, cd_material_original_w) AND coalesce(c.nr_seq_grupo_imp,a.nr_seq_grupo_imp) = nr_seq_grupo_imp_w AND nr_prescricao 	= nr_prescricao_p;

    		if (ie_status_atend_w > 20) then
    			ie_status_atend_w := 20;
    		end if;

    	end if;

    	select	max(nr_sequencia),
                coalesce(max(ie_situacao), 'A')
    	into STRICT	nr_seq_proc_interno_w,
                ie_situacao_proc_interno_w
    	from	proc_interno
    	where	nr_seq_exame_lab = nr_seq_exame_w;

    	if (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') then
    		select	max(cd_procedimento),
    				max(ie_origem_proced)
    		into STRICT	cd_procedimento_w,
    				ie_origem_proced_w
    		from	proc_interno
    		where	nr_sequencia = nr_seq_proc_interno_w;
    	end if;

    	begin

	if (ie_situacao_proc_interno_w <> 'A') then
		nr_seq_proc_interno_w    := null;
	end if;

	CALL gravar_log_lab_pragma(7446,
	'ie_opcao_p=' || ie_opcao_p || CHR(10) ||
	'contador_w=' || contador_w,
	nm_usuario_p);

	if (contador_w = 0) then

            SELECT * FROM consiste_medico_executor(cd_estabelecimento_w, cd_convenio_w, cd_setor_atendimento_w, cd_procedimento_w, ie_origem_proced_w, ie_tipo_atendimento_w, nr_seq_exame_w, nr_seq_proc_interno_w, ie_medico_executor_w, cd_cgc_prest_regra_w, cd_medico_executor_w, cd_pessoa_fisica_consite_w, coalesce(cd_medico_exec_w,cd_medico_prescr_w), clock_timestamp(), nr_seq_classificacao_w, ie_origem_inf_w, cd_cgc_laboratorio_w, cd_setor_prescricao_w, 'S') INTO STRICT ie_medico_executor_w, cd_cgc_prest_regra_w, cd_medico_executor_w, cd_pessoa_fisica_consite_w;

				insert into prescr_procedimento(NR_PRESCRICAO,
						NR_SEQUENCIA,
						CD_PROCEDIMENTO,
						nr_seq_Proc_interno,
						QT_PROCEDIMENTO,
						DT_ATUALIZACAO,
						NM_USUARIO,
						DS_HORARIOS,
						DS_OBSERVACAO,
						CD_PROCEDIMENTO_AIH,
						IE_ORIGEM_PROCED,
						CD_INTERVALO,
						IE_URGENCIA,
						CD_SETOR_ATENDIMENTO,
						DT_EMISSAO_SETOR_ATEND,
						DS_DADO_CLINICO,
						DT_PREV_EXECUCAO,
						IE_SUSPENSO,
						CD_MATERIAL_EXAME,
						NR_SEQ_EXAME,
						DS_MATERIAL_ESPECIAL,
						IE_AMOSTRA,
						IE_STATUS_ATEND,
						IE_ORIGEM_INF,
						CD_MOTIVO_BAIXA,
						IE_EMITE_MAPA,
						nr_seq_interno,
						ie_avisar_result,
						dt_resultado,
						nr_Seq_superior,
						cd_motivo_baixa_exame,
						cd_setor_coleta,
						ie_baixa_dep_lab,
						nr_seq_lab,
						cd_cgc_laboratorio,
                  cd_medico_exec
                  )
				values ( nr_prescricao_p,
						nr_seq_w,
						cd_procedimento_w,
						nr_seq_Proc_interno_w,
						coalesce(qt_proced_dependente_p, qt_proced_w - qt_exame_prescr_w),
						clock_timestamp(),
					--'Tasy',
						nm_usuario_p,
						ds_horarios_w,
						--decode(ie_opcao_p,6,'Procedimento dependente adicional incluido por '||nm_usuario_p||' em '||PKG_DATE_FORMATERS.TO_VARCHAR(sysdate,'timestamp', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.get_nm_usuario),null),
						CASE WHEN ie_opcao_p=6 THEN WHEB_MENSAGEM_PCK.get_texto(457118,'nm_usuario_p='|| nm_usuario_p ||';dt_inclusao_p='|| PKG_DATE_FORMATERS.TO_VARCHAR(clock_timestamp(),'timestamp', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, nm_usuario_p))  ELSE null END ,
						cd_procedimento_aih_w,
						ie_origem_proced_w,
						cd_intervalo_w,
						ie_urgencia_w,
						cd_setor_atendimento_w,
						dt_emissao_setor_atend_w,
						ds_dado_clinico_w,
						dt_prev_execucao_w,
						ie_suspenso_w,
						coalesce(cd_material_exame_w, cd_material_original_w),
						nr_seq_exame_w,
						ds_material_especial_w,
						coalesce(ie_amostra_dep_w,ie_amostra_w),
						CASE WHEN ie_amostra_dep_w='N' THEN 10  ELSE ie_status_atend_w END ,
						'L',
						cd_motivo_baixa_w,
						ie_emite_mapa_w,
						nextval('prescr_procedimento_seq'),
						'N',
						dt_resultado_w,
						nr_seq_prescr_w,
						cd_motivo_baixa_exame_w,
						cd_setor_coleta_w,
						ie_baixa_prescr_w,
						nr_seq_lab_w,
						cd_cgc_laboratorio_depend_w,
                  cd_medico_exec_w);

				CALL gravar_log_lab_pragma(7446,
				'nr_prescricao_p=' || nr_prescricao_p || CHR(10) ||
				'nr_seq_w=' || nr_seq_w || CHR(10) ||
				'cd_procedimento_w=' || cd_procedimento_w || CHR(10) ||
				'nr_seq_Proc_interno_w=' || nr_seq_Proc_interno_w || CHR(10) ||
				'qt_proced_dependente_p=' || qt_proced_dependente_p || CHR(10) ||
				'qt_proced_w=' || qt_proced_w || CHR(10) ||
				'qt_exame_prescr_w=' || qt_exame_prescr_w || CHR(10) ||
				'ds_horarios_w=' || ds_horarios_w || CHR(10) ||
				'cd_procedimento_aih_w=' || cd_procedimento_aih_w || CHR(10) ||
				'ie_origem_proced_w=' || ie_origem_proced_w || CHR(10) ||
				'cd_intervalo_w=' || cd_intervalo_w || CHR(10) ||
				'ie_urgencia_w=' || ie_urgencia_w || CHR(10) ||
				'cd_setor_atendimento_w=' || cd_setor_atendimento_w || CHR(10) ||
				'dt_emissao_setor_atend_w=' || dt_emissao_setor_atend_w || CHR(10) ||
				'ds_dado_clinico_w=' || ds_dado_clinico_w || CHR(10) ||
				'dt_prev_execucao_w=' || dt_prev_execucao_w || CHR(10) ||
				'ie_suspenso_w=' || ie_suspenso_w || CHR(10) ||
				'cd_material_exame_w=' || cd_material_exame_w || CHR(10) ||
				'cd_material_original_w=' || cd_material_original_w || CHR(10) ||
				'nr_seq_exame_w=' || nr_seq_exame_w || CHR(10) ||
				'ds_material_especial_w=' || ds_material_especial_w || CHR(10) ||
				'ie_amostra_dep_w=' || ie_amostra_dep_w || CHR(10) ||
				'ie_amostra_w=' || ie_amostra_w || CHR(10) ||
				'ie_status_atend_w=' || ie_status_atend_w || CHR(10) ||
				'cd_motivo_baixa_w=' || cd_motivo_baixa_w || CHR(10) ||
				'ie_emite_mapa_w=' || ie_emite_mapa_w || CHR(10) ||
				'dt_resultado_w=' || dt_resultado_w || CHR(10) ||
				'nr_seq_prescr_w=' || nr_seq_prescr_w || CHR(10) ||
				'cd_motivo_baixa_exame_w=' || cd_motivo_baixa_exame_w || CHR(10) ||
				'cd_setor_coleta_w=' || cd_setor_coleta_w || CHR(10) ||
				'ie_baixa_prescr_w=' || ie_baixa_prescr_w || CHR(10) ||
				'nr_seq_lab_w=' || nr_seq_lab_w || CHR(10) ||
				'cd_cgc_laboratorio_depend_w=' || cd_cgc_laboratorio_depend_w || CHR(10) ||
				'cd_medico_exec_w=' || cd_medico_exec_w,
				nm_usuario_p);

				select	dt_inicio_prescr,
						dt_validade_prescr,
						coalesce(dt_liberacao,dt_liberacao_medico),
						cd_pessoa_fisica,
						cd_setor_atendimento,
						cd_funcao_origem
				into STRICT	dt_inicio_prescr_w,
						dt_validade_prescr_w,
						dt_liberacao_w,
						cd_pessoa_fisica_w,
						cd_setor_atendimento_ww,
						cd_funcao_origem_w
				from	prescr_medica
				where	nr_prescricao = nr_prescricao_p;
			end if;
		exception when others then
			ds_erro_w	:= 'nr_seq_exame='||nr_seq_exame_w||';nr_prescricao='||nr_prescricao_p||';cd_procedimento_w='||cd_procedimento_w||';nr_seq_Proc_interno_w='||nr_seq_Proc_interno_w||';Erro='||substr(sqlerrm,1,1800);
			CALL gravar_log_tasy(33, ds_erro_w, nm_usuario_p);
		end;
    end if;
end;

begin
    select obter_convenio_atendimento(nr_atendimento_p)
    into STRICT	cd_convenio_w
;

    select  coalesce(MAX(c.nr_Seq_grupo),0)
    into STRICT	nr_seq_grupo_micro_w
    from	exame_lab_result_antib a,
    		exame_lab_resultado b,
    		exame_lab_dependente e,
    		prescr_procedimento d,
    		cih_microorganismo c
    where 	a.cd_microorganismo = c.cd_microorganismo
    and		a.nr_seq_resultado = b.nr_seq_resultado
    and		d.nr_prescricao = b.nr_prescricao
    and		e.nr_seq_exame = d.nr_seq_exame
    and		e.nr_seq_grupo_micro = c.nr_Seq_grupo
    and		b.nr_prescricao = nr_prescricao_p
    and		a.nr_seQ_result_item =  nr_seq_result_item_p;

    select	coalesce(max(ie_status_lote_ext),99),
    	coalesce(max(ie_atualizar_lote_ext),'N')
    into STRICT	ie_status_lote_ext_w,
    	ie_atualizar_lote_ext_w
    from lab_parametro;

    select 	max(cd_estabelecimento)
    into STRICT	cd_estabelecimento_w
    from 	prescr_medica
    where	nr_prescricao = nr_prescricao_p;

    select	coalesce(max(cd_setor_atendimento),0)
    into STRICT	cd_setor_atendimento_prescr_w
    from  	prescr_medica
    where	nr_prescricao = nr_prescricao_p;

    select	coalesce(max(b.nr_sequencia),0)
    into STRICT	nr_seq_material_prescr_w
    from	prescr_procedimento a,
    		material_exame_lab b
    where	a.cd_material_exame = b.cd_material_exame
    and		a.nr_prescricao = nr_prescricao_p
    and		a.nr_sequencia = nr_seq_prescr_p;

    select	obter_plano_conv_atend(nr_atendimento_p)
    into STRICT	cd_plano_convenio_w
;

    select	obter_categoria_atendimento(nr_atendimento_p)
    into STRICT	cd_categoria_w
;

    select	obter_tipo_atendimento(nr_atendimento_p)
    into STRICT	ie_tipo_atendimento_w
;

    dt_vigencia_w	:= clock_timestamp();

    select 	max(ie_tipo_convenio)
    into STRICT	ie_tipo_convenio_w
    from	convenio
    where	cd_convenio = cd_convenio_w;

    select	coalesce(max(ie_prioridade_edicao_amb), 'N')
    into STRICT	ie_prioridade_edicao_w
    from	parametro_faturamento
    where	cd_estabelecimento	= cd_estabelecimento_w;

    ie_origem_proced_sus_w		:= obter_origem_proced_cat(cd_estabelecimento_w, ie_tipo_atendimento_w, ie_tipo_convenio_w, cd_convenio_w, cd_categoria_w);

    if (ie_prioridade_edicao_w = 'N') then

    	select	coalesce(max(cd_edicao_amb),0)
    	into STRICT	cd_edicao_amb_w
    	from convenio_amb
    	where (cd_estabelecimento     = cd_estabelecimento_w)
    	  and (cd_convenio            = cd_convenio_w)
           	  and (cd_categoria	      = cd_categoria_w)
    	  and (coalesce(ie_situacao,'A')   = 'A')
    	  and (dt_inicio_vigencia     = (SELECT max(dt_inicio_vigencia)
    				        from convenio_amb a
    					where (a.cd_estabelecimento  = cd_estabelecimento_w)
    				        and (a.cd_convenio         = cd_convenio_w)
    				        and (a.cd_categoria        = cd_categoria_w)
    					and (coalesce(a.ie_situacao,'A')= 'A')
    					and (a.dt_inicio_vigencia <=  dt_vigencia_w)));

    else
    	SELECT * FROM obter_edicao_proc_conv(cd_estabelecimento_w, cd_convenio_w, cd_categoria_w, dt_vigencia_w, cd_procedimento_w, cd_edicao_amb_w, vl_ch_honorarios_w, vl_ch_custo_oper_w, vl_m2_filme_w, dt_inicio_vigencia_w, tx_ajuste_geral_w, nr_seq_cbhpm_edicao_w) INTO STRICT cd_edicao_amb_w, vl_ch_honorarios_w, vl_ch_custo_oper_w, vl_m2_filme_w, dt_inicio_vigencia_w, tx_ajuste_geral_w, nr_seq_cbhpm_edicao_w;
    end if;

    select	max(ie_origem_proced)
    into STRICT	ie_origem_proced_cursor_w
    from	edicao_amb
    where	cd_edicao_amb	= cd_edicao_amb_w;

    if (coalesce(ie_origem_proced_cursor_w::text, '') = '') then
    	ie_origem_proced_cursor_w := ie_origem_proced_sus_w;
    end if;

    select	coalesce(max(ie_data_exame_lab),'N')
    into STRICT	ie_data_exame_lab_w
    from	parametro_faturamento
    where	cd_estabelecimento = cd_estabelecimento_w;

    if (ie_data_exame_lab_w = 'S') then
    	dt_vigencia_w	:= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(coalesce(DT_PREV_EXECUCAO_w, clock_timestamp()));
    end if;

    nr_seq_exame_ant_w := '';

	CALL gravar_log_lab_pragma(7446,
	'ie_opcao_p=' || ie_opcao_p || CHR(10) ||
	'nr_atendimento_p=' || nr_atendimento_p,
	nm_usuario_p);

    if (ie_opcao_p in (0,6,10)) then
    	if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then

    		select count(*)
    		into STRICT	ie_laboratorio_w
    		from prescr_procedimento
    		where nr_prescricao = nr_prescricao_p
    		  and ie_origem_inf = 'L'
    		  and ie_opcao_p = 0;

    		if (ie_laboratorio_w = 0) then
    			select obter_convenio_atendimento(nr_atendimento_p)
    			into STRICT	cd_convenio_w
    			;

    			select coalesce(max(nr_sequencia),0)
    			into STRICT nr_seq_w
    			from prescr_procedimento
    			where nr_prescricao = nr_prescricao_p;

    			open C01;
    			loop
    			fetch C01 into	QT_PROCED_w,
    					DS_HORARIOS_w,
    					DS_OBSERVACAO_w,
    					CD_PROCEDIMENTO_AIH_w,
    					CD_INTERVALO_w,
    					IE_URGENCIA_w,
    					CD_SETOR_ATENDIMENTO_w,
    					DT_EMISSAO_SETOR_ATEND_w,
    					DS_DADO_CLINICO_w,
    					DT_PREV_EXECUCAO_w,
    					IE_SUSPENSO_w,
    					CD_MATERIAL_original_w,
    					nr_seq_exame_presc_w,
    					DS_MATERIAL_ESPECIAL_w,
    					IE_AMOSTRA_w,
    					IE_STATUS_ATEND_w,
    					CD_MOTIVO_BAIXA_W,
    					IE_EMITE_MAPA_W,
    					IE_ORIGEM_PROCED_W,
    					nr_seq_prescr_w,
    					cd_setor_coleta_w,
    					cd_cgc_laboratorio_w,
                  cd_medico_exec_w,
                  cd_medico_prescr_w,
                  nr_seq_classificacao_w,
                  ie_origem_inf_w,
                  cd_setor_prescricao_w;
    			EXIT WHEN NOT FOUND; /* apply on C01 */

    				if (nr_seq_exame_ant_w <> nr_seq_exame_presc_w) or (coalesce(nr_seq_exame_ant_w::text, '') = '') then
    					qt_exame_dep_w	   := 0;

    				end if;

    				nr_seq_exame_ant_w := nr_seq_exame_presc_w;
    				qt_exame_dep_w	:= coalesce(qt_exame_dep_w,0) + 1;

    				select	coalesce(max(b.nr_sequencia),0)
    				into STRICT	nr_seq_material_prescr_w
    				from	prescr_procedimento a, material_exame_lab b
    				where	a.cd_material_exame = b.cd_material_exame
    				and		a.nr_prescricao = nr_prescricao_p
    				and		a.nr_sequencia = nr_seq_prescr_w;

    				if (ie_opcao_p in (0,6)) then

    					open C02;
    					loop
    					fetch C02 into 	nr_seq_exame_w,
    							cd_procedimento_w,
    							ie_origem_proced_w,
    							nr_seq_material_w,
    							nr_seq_exame_princ_w,
    							ie_material_exame_princ_w,
    							cd_motivo_baixa_exame_w,
    							cd_setor_atendimento_w,
    							cd_convenio_w,
                                cd_categoria_convenio_w,
    							ie_amostra_dep_w,
    							ie_baixa_prescr_w,
    							ie_lab_exame_princ_w,
    							ie_considera_micro_conta_w,
                        nr_Seq_proc_interno_w_p;
    					EXIT WHEN NOT FOUND; /* apply on C02 */
							CALL gravar_log_lab_pragma(7446, 'chamando metodo - add_dependencies', nm_usuario_p);
    						add_dependencies;
    					end loop;
    					close C02;
    				elsif (ie_opcao_p = 10) then
    					open C02_10;
    					loop
    					fetch C02_10 into 	nr_seq_exame_w,
    							cd_procedimento_w,
    							ie_origem_proced_w,
    							nr_seq_material_w,
    							nr_seq_exame_princ_w,
    							ie_material_exame_princ_w,
    							cd_motivo_baixa_exame_w,
    							cd_setor_atendimento_w,
    							cd_convenio_w,
    							ie_amostra_dep_w,
    							ie_baixa_prescr_w,
    							ie_lab_exame_princ_w,
    							ie_considera_micro_conta_w;
    					EXIT WHEN NOT FOUND; /* apply on C02_10 */
							CALL gravar_log_lab_pragma(7446, 'chamando metodo - add_dependencies', nm_usuario_p);
    						add_dependencies;
    					end loop;
    					close C02_10;
    				end if;

    				if (cd_funcao_origem_w = 2314) then
						CALL gravar_log_lab_pragma(7446, 'chamando procedure da cpoe'
, nm_usuario_p);
    					CALL cpoe_rep_gerar_procedimento(	nr_prescricao_p, nr_atendimento_p, dt_inicio_prescr_w, dt_validade_prescr_w,
    												dt_liberacao_w, nm_usuario_p, cd_pessoa_fisica_w, cd_funcao_origem_w,
    												cd_setor_atendimento_ww, 'L', nr_seq_prescr_w);
    				end if;
				CALL gravar_log_lab_pragma(7446, 'finalizou processo', nm_usuario_p);
    			end loop;
    			close C01;
    		end if;
    	end if;
    elsif ((ie_opcao_p = 1) or (ie_opcao_p = 5)) then
    	select	coalesce(max(nr_sequencia),0)
    	into STRICT	nr_sequencia_w
    	from procedimento_paciente
    	where nr_prescricao = nr_prescricao_p
    	  and nr_sequencia_prescricao = nr_seq_prescr_p;

    	if (nr_sequencia_w > 0) then
    		select	cd_setor_atendimento,
    			cd_convenio,
                cd_categoria,
    			nr_seq_exame,
    			ie_origem_proced
    		into STRICT	cd_setor_atendimento_w,
    			cd_convenio_w,
                cd_categoria_convenio_w,
    			nr_seq_exame_presc_w,
    			ie_origem_proced_w
    		from procedimento_paciente
    		where nr_sequencia = nr_sequencia_w;

    		select	coalesce(max(b.nr_sequencia),0)
    		into STRICT	nr_seq_material_prescr_w
    		from	prescr_procedimento a, material_exame_lab b
    		where	a.cd_material_exame = b.cd_material_exame
    		and		a.nr_prescricao = nr_prescricao_p
    		and		a.nr_sequencia = nr_seq_prescr_p;

    		open C02;
    		loop
    		fetch C02 into 	nr_seq_exame_w,
    				cd_procedimento_w,
    				ie_origem_proced_w,
    				nr_seq_material_w,
    				nr_seq_exame_princ_w,
    				ie_material_exame_princ_w,
    				cd_motivo_baixa_exame_w,
    				cd_setor_atendimento_w,
    				cd_convenio_w,
                    cd_categoria_convenio_w,
    				ie_amostra_dep_w,
    				ie_baixa_prescr_w,
    				ie_lab_exame_princ_w,
    				ie_considera_micro_conta_w,
               nr_seq_proc_interno_w_p;
    		EXIT WHEN NOT FOUND; /* apply on C02 */
    			if (ie_considera_micro_conta_w = 'N') then
    				considerar_micro_conta(cd_convenio_w, cd_categoria_convenio_w, cd_procedimento_w, cd_setor_atendimento_w, ie_origem_proced_w, nm_usuario_p, nr_seq_exame_w, nr_sequencia_w);
    			else
    				begin
    					i := 0;

    					select	count(cd_microorganismo)
    					into STRICT	qt_microorg_w
    					from (	SELECT	cd_microorganismo
    								from	exame_lab_result_antib a,
    										exame_lab_resultado b
    								where 	a.nr_seq_resultado = b.nr_seq_resultado
    								and		b.nr_prescricao = nr_prescricao_p
    								and		a.nr_seq_result_item =  nr_seq_result_item_p
    								group by cd_microorganismo) alias1;

    					for i in 1..qt_microorg_w loop
    						considerar_micro_conta(cd_convenio_w, cd_categoria_convenio_w, cd_procedimento_w, cd_setor_atendimento_w, ie_origem_proced_w, nm_usuario_p, nr_seq_exame_w, nr_sequencia_w);
    					end loop;
    				end;
    			end if;
    		end loop;
    		close c02;
    	end if;

    elsif (ie_opcao_p in (3,7,11)) then

    	select 	ie_origem_proced
    	into STRICT	ie_origem_proced_w
    	from 	prescr_procedimento
    	where 	nr_prescricao = nr_prescricao_p
     	and 	nr_sequencia = nr_seq_prescr_p;

    	select obter_convenio_atendimento(nr_atendimento_p)
    	into STRICT	cd_convenio_w
    	;

    	select (coalesce(max(nr_sequencia),0) + 1),
    		   (coalesce(max(nr_agrupamento),0) + 1)
    	into STRICT nr_seq_w,
    		 nr_agrupamento_w
    	from prescr_procedimento
    	where nr_prescricao = nr_prescricao_p;

    	select	coalesce(max(b.nr_sequencia),0)
    	into STRICT	nr_seq_material_prescr_w
    	from	prescr_procedimento a, material_exame_lab b
    	where	a.cd_material_exame = b.cd_material_exame
    	and		a.nr_prescricao = nr_prescricao_p
    	and		a.nr_sequencia = nr_seq_prescr_p;

    	open c03;
    	loop
    	fetch c03 into  QT_PROCED_w,
    			DS_HORARIOS_w,
    			DS_OBSERVACAO_w,
    			CD_PROCEDIMENTO_AIH_w,
    			CD_INTERVALO_w,
    			IE_URGENCIA_w,
    			CD_SETOR_ATENDIMENTO_w,
    			DT_EMISSAO_SETOR_ATEND_w,
    			DS_DADO_CLINICO_w,
    			DT_PREV_EXECUCAO_w,
    			IE_SUSPENSO_w,
    			CD_MATERIAL_original_w,
    			nr_seq_exame_presc_w,
    			DS_MATERIAL_ESPECIAL_w,
    			IE_AMOSTRA_w,
    			IE_STATUS_ATEND_w,
    			CD_MOTIVO_BAIXA_W,
    			IE_EMITE_MAPA_W,
    			nr_seq_exame_w,
    			cd_procedimento_w,
    			ie_origem_proced_w,
    			nr_seq_material_w,
    			dt_coleta_w,
    			nr_seq_prescr_w,
    			cd_motivo_baixa_exame_w,
    			cd_setor_coleta_w;
    	EXIT WHEN NOT FOUND; /* apply on C03 */

    		cd_material_exame_w := null;

    		if (coalesce(nr_seq_material_w::text, '') = '') then
    			begin
    			select b.cd_material_exame
    			into STRICT	cd_material_exame_w
    			from	material_exame_lab b,
    				exame_lab_material a
    			where a.nr_seq_material	= b.nr_sequencia
    			  and a.nr_seq_exame		= nr_seq_exame_w
    			  and b.cd_material_exame	= CD_MATERIAL_original_w
    			  and a.ie_situacao 		= 'A';
    			exception
    			when no_data_found then
    				select coalesce(max(cd_material_exame),'')
    				into STRICT	cd_material_exame_w
    				from (	SELECT b.cd_material_exame
    					from	material_exame_lab b,
    						exame_lab_material a
    					where a.nr_seq_material	= b.nr_sequencia
    					  and a.nr_seq_exame		= nr_seq_exame_w
    					  and a.ie_situacao		= 'A'
    					order by a.ie_prioridade) alias2 LIMIT 1;
    				if (cd_material_exame_w = '') then
    					CALL wheb_mensagem_pck.exibir_mensagem_abort(195427, 'NR_SEQ_EXAME='|| nr_seq_exame_w);
    				end if;
    			end;
    		else
    			select	cd_material_exame
    			into STRICT	cd_material_exame_w
    			from	material_exame_lab
    			where	nr_sequencia = nr_seq_material_w;
    		end if;

    		if (cd_procedimento_w IS NOT NULL AND cd_procedimento_w::text <> '') then

    			if (ie_opcao_p in (3,11)) then

    				SELECT 	MAX(coalesce(lab_obter_grupo_imp_estab(cd_estabelecimento_w,a.nr_seq_exame, cd_convenio_w),a.nr_seq_grupo_imp))
    				INTO STRICT	nr_seq_grupo_imp_w
    				FROM	exame_laboratorio a
    				WHERE	a.nr_seq_exame =  nr_seq_exame_w;

    				SELECT 	MIN(nr_seq_lab)
    				INTO STRICT	nr_seq_lab_w
    				FROM prescr_procedimento b, exame_laboratorio a
LEFT OUTER JOIN exame_lab_grupo_imp c ON (a.nr_seq_exame = c.nr_seq_exame AND cd_estabelecimento_w = c.cd_estabelecimento AND cd_convenio_w = c.cd_convenio)
WHERE a.nr_seq_exame = b.nr_seq_exame    AND b.cd_material_exame = coalesce(cd_material_exame_w, cd_material_original_w) AND coalesce(c.nr_seq_grupo_imp,a.nr_seq_grupo_imp) = nr_seq_grupo_imp_w AND nr_prescricao 	= nr_prescricao_p;

    				CALL gravar_log_lab(33, obter_desc_expressao(330985) ||' seq_lab '||nr_seq_lab_w||', seq_exame '||nr_seq_exame_w,nm_usuario_p,nr_prescricao_p);

    			end if;

    			if (ie_opcao_p = 7) then

    				begin
    				select	obter_setor_usuario(nm_usuario_p)
    				into STRICT	cd_setor_atual_usuario_w
    				;

    				SELECT * FROM obter_setor_exame_lab(	nr_prescricao_p, nr_seq_exame_w, cd_setor_atual_usuario_w, coalesce(cd_material_exame_w, cd_material_original_w), null, 'S', cd_setor_atend_w, cd_setor_col_w, cd_setor_entrega_w, qt_dia_entrega_w, ie_emite_mapa_set_w, ds_hora_fixa_w, ie_data_resultado_w, qt_min_entrega_w, ie_atualizar_recoleta_w, ie_urgencia_w, ie_dia_semana_final_w, ie_forma_atual_dt_result_w, qt_min_atraso_w) INTO STRICT cd_setor_atend_w, cd_setor_col_w, cd_setor_entrega_w, qt_dia_entrega_w, ie_emite_mapa_set_w, ds_hora_fixa_w, ie_data_resultado_w, qt_min_entrega_w, ie_atualizar_recoleta_w, ie_dia_semana_final_w, ie_forma_atual_dt_result_w, qt_min_atraso_w;

    				dt_resultado_w	:= null;

    				if (ds_hora_fixa_w IS NOT NULL AND ds_hora_fixa_w::text <> '') then
    					select	(trunc(coalesce(dt_entrada_unidade,dt_prescricao)) + (ds_hora_fixa_w/24)) + qt_dia_entrega_w + (CASE WHEN qt_min_entrega_w=0 THEN 0  ELSE qt_min_entrega_w/1440 END )
    					into STRICT	dt_resultado_w
    					from	prescr_medica
    					where 	nr_prescricao = nr_prescricao_p;
    				else
    					select	coalesce(dt_entrada_unidade,dt_prescricao) + qt_dia_entrega_w  + (CASE WHEN qt_min_entrega_w=0 THEN 0  ELSE qt_min_entrega_w/1440 END )
    					into STRICT	dt_resultado_w
    					from 	prescr_medica
    					where 	nr_prescricao = nr_prescricao_p;
    				end if;

    				if (ie_dia_semana_final_w > 0) then
    					select	pkg_date_utils.get_WeekDay(dt_resultado_w)
    					into STRICT	ie_dia_semana_upd_w
    					;

    					while(ie_dia_semana_upd_w <> ie_dia_semana_final_w) loop
    						dt_resultado_w := dt_resultado_w + 1;

    						select	pkg_date_utils.get_WeekDay(dt_resultado_w)
    						into STRICT	ie_dia_semana_upd_w
    						;
    					end loop;
    				end if;
    				exception
    				when others then
    					CALL gravar_log_lab(33, obter_desc_expressao(289744) || ' dt_resultado: '||substr(SQLERRM(SQLSTATE),1,1500)||', nr_seq_exame:'||nr_seq_exame_w,nm_usuario_p,nr_prescricao_p);
--					gravar_log_lab(39, obter_desc_expressao(289744) || ' dt_resultado: '||substr(SQLERRM(SQLCode),1,1500)||', nr_seq_exame:'||nr_seq_exame_w,nm_usuario_p,nr_prescricao_p);
    				end;

    			end if;

    			nr_seq_w := nr_seq_w + 1;
    			insert into prescr_procedimento(NR_PRESCRICAO,
    							 NR_SEQUENCIA,
    							 CD_PROCEDIMENTO,
    							 QT_PROCEDIMENTO,
    							 DT_ATUALIZACAO,
    							 NM_USUARIO,
    							 DS_HORARIOS,
    							 DS_OBSERVACAO,
    							 CD_PROCEDIMENTO_AIH,
    							 IE_ORIGEM_PROCED,
    							 CD_INTERVALO,
    							 IE_URGENCIA,
    							 CD_SETOR_ATENDIMENTO,
    							 DT_EMISSAO_SETOR_ATEND,
    							 DS_DADO_CLINICO,
    							 DT_PREV_EXECUCAO,
    							 IE_SUSPENSO,
    							 CD_MATERIAL_EXAME,
    							 NR_SEQ_EXAME,
    							 DS_MATERIAL_ESPECIAL,
    							 IE_AMOSTRA,
    							 IE_STATUS_ATEND,
    							 IE_ORIGEM_INF,
    							 CD_MOTIVO_BAIXA,
    							 IE_EMITE_MAPA,
    							 nr_seq_interno,
    							 ie_avisar_result,
    							 dt_coleta,
    							 nr_Seq_superior,
    							 cd_motivo_baixa_exame,
    							 cd_setor_coleta,
    							 nr_agrupamento,
    							 nr_seq_lab,
    							 dt_resultado)
    			values (NR_PRESCRICAO_p,
    				nr_seq_w,
    				cd_procedimento_w,
    				coalesce(qt_proced_dependente_p, QT_PROCED_w),
    				clock_timestamp(),
				--'Tasy',
    				nm_usuario_p,
    				ds_horarios_w,
    				null,
    				cd_procedimento_aih_w,
    				ie_origem_proced_w,
    				cd_intervalo_w,
    				ie_urgencia_w,
    				cd_setor_atendimento_w,
    				dt_emissao_setor_atend_w,
    				ds_dado_clinico_w,
    				dt_prev_execucao_w,
    				ie_suspenso_w,
    				coalesce(cd_material_exame_w, cd_material_original_w),
    				nr_seq_exame_w,
    				ds_material_especial_w,
    				coalesce(ie_amostra_dep_w,ie_amostra_w),
    				ie_status_atend_w,
    				'L',
    				0,
    				ie_emite_mapa_w,
    				nextval('prescr_procedimento_seq'),
    				'N',
    				dt_coleta_w,
    				nr_seq_prescr_w,
    				cd_motivo_baixa_exame_w,
    				cd_setor_coleta_w,
    				nr_agrupamento_w,
    				nr_seq_lab_w,
    				dt_resultado_w);


    			if (ie_status_atend_w > ie_status_lote_ext_w) then
    				nr_seq_lote_externo_w := lab_obter_lote_externo(nr_seq_exame_w, nm_usuario_p, cd_estabelecimento_w, nr_seq_lote_externo_w, NULL, nr_prescricao_p, nr_seq_w, coalesce(cd_material_exame_w, cd_material_original_w));
    			end if;

    			if (nr_seq_lote_externo_w IS NOT NULL AND nr_seq_lote_externo_w::text <> '') then
    				update prescr_procedimento
    				set nr_seq_lote_externo = nr_seq_lote_externo_w
    				where nr_prescricao = nr_prescricao_p
    				and   nr_sequencia = nr_seq_w;
    			end if;
    		end if;
    	end loop;
    	close c03;

    end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_exame_lab_dependente ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, ie_opcao_p bigint, nr_atendimento_p bigint, nm_usuario_p text, nr_seq_exame_dep_p bigint, nr_seq_result_item_p bigint default null, qt_proced_dependente_p bigint default null) FROM PUBLIC;

