-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baixar_estoque_cmiv ( nr_seq_ordem_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_seq_prescr_w		bigint;
nr_seq_mat_atend_w	bigint;
nr_atendimento_w	bigint;
cd_setor_atendimento_w	integer;
cd_setor_atendimento_ww integer;
cd_material_w		integer;
dt_entrada_unidade_w	timestamp;
cd_unidade_medida_w	varchar(30);
qt_material_w		double precision;
cd_convenio_w		integer;
cd_categoria_w		varchar(10);
nr_doc_convenio_w	varchar(20);
ie_tipo_guia_w		varchar(2);
dt_prescricao_w		timestamp;
ie_via_aplicacao_w	varchar(5);
cd_fornec_consignado_w	varchar(14);
nr_seq_lote_fornec_w	bigint;
nr_seq_atepacu_w	bigint;
nr_prescricao_w		bigint;
cd_local_estoque_w	smallint;
cd_local_estoque_ww	smallint;
cd_motivo_baixa_w	varchar(1);
nr_seq_cabine_w		bigint;
cd_estabelecimento_w	smallint;
cd_estab_estoque_w	smallint;
dt_inicio_preparo_w	timestamp;
ie_estoque_w		varchar(1);
ds_material_w		varchar(255);
cd_oper_perda_etq_w	smallint;
ie_consignado_w 	varchar(1);
cd_cgc_fornec_w		varchar(14);
ie_lote_consignado_w    varchar(1);
cd_oper_consumo_consig_w integer;
cd_operacao_estoque_w   integer;
ds_setor_atendimento_w	varchar(100);
nm_prescritor_w		varchar(60);
cd_senha_w		varchar(20);
ie_generico_w		varchar(1);
dt_entrada_w		timestamp;
VarRegraLocalEstoque_w 	varchar(1);
ie_controlador_estoque_w varchar(1);
nr_seq_item_prescr_w	bigint;
cd_material_prescr_w	integer;
ie_consiste_ficha_tecnica_w	varchar(1);
ie_utiliza_estoq_trans_w	varchar(1);
ie_realiza_passagem_w		varchar(1);
ie_baixa_estoq_pac_w	varchar(1);
ds_lote_fornec_w	varchar(20);
dt_validade_w		timestamp;
ds_entrada_w		varchar(4000);
ds_log_w		varchar(4000);
ds_texto_w		varchar(255);

c01 CURSOR FOR
SELECT	coalesce(a.nr_atendimento,c.nr_atendimento),
	b.cd_material,
	b.cd_unidade_medida_real,
	--b.qt_dose_real,
	obter_conversao_unid_med_cons(b.cd_material, b.cd_unidade_medida_real, b.qt_dose_real) qt_dose_real,
	c.dt_prescricao,
	a.nr_prescricao,
	c.cd_motivo_baixa,
	c.cd_setor_atendimento,
	b.nr_seq_lote_fornec,
	a.ie_via_aplicacao,
	b.nr_seq_item_prescr
from	prescr_medica c,
	can_ordem_prod_mat b,
	can_ordem_prod a
where	a.nr_sequencia	= nr_seq_ordem_p
and coalesce(a.dt_entrega_setor::text, '') = ''
and	a.nr_prescricao	= c.nr_prescricao
and	a.nr_sequencia	= b.nr_seq_ordem
and	coalesce(a.ie_medic_paciente,'N') = 'N'
and	((coalesce(get_if_patient_medic(nr_seq_ordem_p, b.cd_material)::text, '') = '') or (get_if_patient_medic(nr_seq_ordem_p, b.cd_material) <> b.cd_material));


BEGIN
ds_entrada_w := '1';

select	max(c.cd_local_estoque),
	max(b.nr_seq_cabine),
	coalesce(max(b.cd_estab_destino),max(a.cd_estabelecimento)),
	max(a.dt_inicio_preparo)
into STRICT	cd_local_estoque_w,
	nr_seq_cabine_w,
	cd_estabelecimento_w,
	dt_inicio_preparo_w
from	far_cabine_seg_biol c,
	far_etapa_producao b,
	can_ordem_prod a
where	a.nr_sequencia	= nr_seq_ordem_p
and	b.nr_sequencia	= a.nr_seq_etapa_prod
and	b.nr_seq_cabine	= c.nr_sequencia;

ie_generico_w := Obter_Param_Usuario(3130, 149, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_generico_w);
VarRegraLocalEstoque_w := Obter_Param_Usuario(3130, 158, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, VarRegraLocalEstoque_w);
ie_controlador_estoque_w := Obter_Param_Usuario(3130, 167, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_controlador_estoque_w);
ie_consiste_ficha_tecnica_w := Obter_Param_Usuario(3130, 225, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_consiste_ficha_tecnica_w);
ie_utiliza_estoq_trans_w := Obter_Param_Usuario(3130, 234, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_utiliza_estoq_trans_w);
ie_realiza_passagem_w := Obter_Param_Usuario(3130, 281, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_realiza_passagem_w);

open c01;
loop
fetch	c01 into
	nr_atendimento_w,
	cd_material_w,
	cd_unidade_medida_w,
	qt_material_w,
	dt_prescricao_w,
	nr_prescricao_w,
	cd_motivo_baixa_w,
	cd_setor_atendimento_w,
	nr_seq_lote_fornec_w,
	ie_via_aplicacao_w,
	nr_seq_item_prescr_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin	
	ds_entrada_w := substr(ds_entrada_w || ',2',1,4000);
	cd_material_prescr_w	:= cd_material_w;
	if (nr_seq_item_prescr_w > 0) then
		ds_entrada_w := substr(ds_entrada_w || ',3',1,4000);
		select	cd_material
		into STRICT	cd_material_prescr_w
		from	can_ordem_item_prescr
		where	nr_sequencia	= nr_seq_item_prescr_w;
	end if;
	
	select	coalesce(max(nr_seq_interno),0)
	into STRICT	nr_seq_atepacu_w
	from	atend_paciente_unidade
	where	nr_atendimento		= nr_atendimento_w
	and	cd_setor_atendimento	= cd_setor_atendimento_w;
		
	if (nr_seq_atepacu_w = 0) then
		ds_entrada_w := substr(ds_entrada_w || ',4',1,4000);
		select 	max(dt_entrada)
		into STRICT	dt_entrada_w
		from	atendimento_paciente
		where	nr_atendimento = nr_atendimento_w;

		if (ie_realiza_passagem_w = 'S') then
			if (dt_entrada_w <= dt_prescricao_w) then
				ds_entrada_w := substr(ds_entrada_w || ',5',1,4000);
				CALL Gerar_Passagem_Setor_Atend(nr_atendimento_w, cd_setor_atendimento_w, dt_entrada_w, 'N', nm_usuario_p);			
			else
				ds_entrada_w := substr(ds_entrada_w || ',6',1,4000);
				CALL Gerar_Passagem_Setor_Atend(nr_atendimento_w, cd_setor_atendimento_w, dt_prescricao_w, 'N', nm_usuario_p);
			end if;
		end if;
		
		select	coalesce(max(nr_seq_interno),0)
		into STRICT	nr_seq_atepacu_w
		from	atend_paciente_unidade
		where	nr_atendimento		= nr_atendimento_w
		and	cd_setor_atendimento	= cd_setor_atendimento_w;

		/* Rafael em 05/01/2007 OS47601 => gerar mensagem usuario */

		if (ie_realiza_passagem_w <> 'N') and (coalesce(nr_seq_atepacu_w,0) = 0) then
			ds_entrada_w := substr(ds_entrada_w || ',7',1,4000);
			/* obter dados setor */

			select	substr(obter_desc_expressao(max(cd_exp_setor_atend),max(ds_setor_atendimento)),1,100)
			into STRICT	ds_setor_atendimento_w
			from	setor_atendimento
			where	cd_setor_atendimento = cd_setor_atendimento_w;

			/* obter dados prescritor */

			select SUBSTR(OBTER_NOME_PF(a.cd_pessoa_fisica), 0, 60) as nm_pessoa_fisica
			into STRICT	nm_prescritor_w
			from	pessoa_fisica a,
				prescr_medica b
			where	a.cd_pessoa_fisica = b.cd_prescritor
			and	b.nr_prescricao = nr_prescricao_w;

			CALL wheb_mensagem_pck.exibir_mensagem_abort(184942,'DS_SETOR_ATENDIMENTO_W='||ds_setor_atendimento_w||';NR_PRESCRICAO_W='||nr_prescricao_w||';NM_PRESCRITOR_W='||nm_prescritor_w);
		end if;
	end if;
	ds_entrada_w := substr(ds_entrada_w || ',8',1,4000);
	update	prescr_material
	set	dt_baixa		= clock_timestamp(),
		nm_usuario	= nm_usuario_p,
		cd_motivo_baixa	= 1
	where	nr_prescricao	= nr_prescricao_w
	and 	nr_sequencia = nr_seq_item_prescr_w
	and	((cd_material	= cd_material_w) or
		((cd_material_w = obter_material_generico(cd_material)) and (ie_generico_w = 'S')) or
		((obter_ficha_tecnica_medic(cd_material) = obter_ficha_tecnica_medic(cd_material_w)) and (coalesce(ie_consiste_ficha_tecnica_w,'N') = 'S' )) or 
		((Obter_controlador_estoque(cd_material_w) = Obter_controlador_estoque(cd_material)) and (ie_controlador_estoque_w = 'S')));

		
	select	coalesce(max(dt_entrada_unidade),clock_timestamp())
	into STRICT	dt_entrada_unidade_w
	from 	atend_paciente_unidade
	where 	nr_seq_interno = nr_seq_atepacu_w;

	SELECT * FROM obter_convenio_execucao(	nr_atendimento_w, clock_timestamp(), cd_convenio_w, cd_categoria_w, nr_doc_convenio_w, ie_tipo_guia_w, cd_senha_w) INTO STRICT cd_convenio_w, cd_categoria_w, nr_doc_convenio_w, ie_tipo_guia_w, cd_senha_w;

	select 	obter_setor_atendimento(nr_atendimento_w)
	into STRICT 	cd_setor_atendimento_w
	;
	
	select	max(cd_local_estoque),
            max(cd_oper_consumo_etq) ,
            max(cd_setor_atendimento),
        	max(cd_oper_consumo_consig)
	into STRICT	cd_local_estoque_w,
            cd_oper_perda_etq_w,
            cd_setor_atendimento_ww,
            cd_oper_consumo_consig_w
	from	far_cabine_seg_biol
	where	nr_sequencia = nr_seq_cabine_w;

	ds_entrada_w := substr(ds_entrada_w || ',9',1,4000);
	
	if (ie_utiliza_estoq_trans_w = 'S') then
		ds_entrada_w := substr(ds_entrada_w || ',10',1,4000);
		select	coalesce(max(c.cd_local_estoque),cd_local_estoque_w)
		into STRICT	cd_local_estoque_w
		from	transf_ordem_prod a,
			nota_fiscal b,
			nota_fiscal_item c
		where	b.nr_sequencia = c.nr_sequencia
		and	a.nr_ordem_compra = b.nr_ordem_compra
		and	a.nr_seq_ordem_prod = nr_seq_ordem_p
		and	substr(obter_se_nota_entrada_saida(b.nr_sequencia),1,1) = 'E'
		and 	cd_material = cd_material_w;
	end if;


	if (VarRegraLocalEstoque_w  = 'S') then
		ds_entrada_w := substr(ds_entrada_w || ',11',1,4000);
		select	max(nr_sequencia)
		into STRICT 	nr_seq_prescr_w
		from 	prescr_material 
		where	nr_prescricao	= nr_prescricao_w
		and	((cd_material	= cd_material_w) or ((cd_material_w = obter_material_generico(cd_material)) 
		and (ie_generico_w = 'S')));

		cd_local_estoque_ww := obter_local_disp_prescr(nr_prescricao_w, nr_seq_prescr_w, obter_perfil_ativo, nm_usuario_p);
		
		if (cd_local_estoque_ww IS NOT NULL AND cd_local_estoque_ww::text <> '') then
			cd_local_estoque_w := cd_local_estoque_ww;
		end if;
		
	end if;

    
    select 	obter_se_mat_consignado(cd_material_w)
    into STRICT	ie_consignado_w
;
    ds_entrada_w := substr(ds_entrada_w || ',13',1,4000);

    cd_cgc_fornec_w := null;

    select	coalesce(max('S'), 'N')
    into STRICT	ie_lote_consignado_w
    from	fornecedor_mat_consig_lote
    where	cd_estabelecimento 	= cd_estabelecimento_p
    and	cd_local_estoque 	= cd_local_estoque_w
    and	cd_material 		= cd_material_w
    and	dt_mesano_referencia	= trunc(clock_timestamp(), 'mm')
    and	nr_seq_lote 		= nr_seq_lote_fornec_w;

    if (ie_consignado_w = '1') or
        (ie_consignado_w = '2' AND ie_lote_consignado_w = 'S') then
	ds_entrada_w := substr(ds_entrada_w || ',14',1,4000);
        select	max(cd_cgc_fornec)
        into STRICT	cd_cgc_fornec_w
        from	material_lote_fornec
        where	cd_material = cd_material_w
        and	nr_sequencia = nr_seq_lote_fornec_w;
    end if;

    select 	max(cd_estabelecimento)
    into STRICT	cd_estab_estoque_w
    from	local_estoque
    where	cd_local_estoque = cd_local_estoque_w;

    if (cd_estab_estoque_w <> cd_estabelecimento_w) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(270545);
    end if;
    ds_entrada_w := substr(ds_entrada_w || ',15',1,4000);
    if	(ie_consignado_w = '2' AND ie_lote_consignado_w = 'N') then
        begin
	ds_entrada_w := substr(ds_entrada_w || ',16',1,4000);
        ie_estoque_w := Obter_Disp_estoque(
            cd_material_w, cd_local_estoque_w, cd_estabelecimento_w, 0, qt_material_w, null, ie_estoque_w);

        if (ie_estoque_w = 'S') then
		ds_entrada_w := substr(ds_entrada_w || ',17',1,4000);
            cd_cgc_fornec_w := null;
        else
		ds_entrada_w := substr(ds_entrada_w || ',18',1,4000);
            ie_estoque_w := Obter_Disp_estoque(
                cd_material_w, cd_local_estoque_w, cd_estabelecimento_w, 0, qt_material_w, cd_cgc_fornec_w, ie_estoque_w);
        end if;
        end;
    else
	ds_entrada_w := substr(ds_entrada_w || ',19',1,4000);
        ie_estoque_w := Obter_Disp_estoque(
            cd_material_w, cd_local_estoque_w, cd_estabelecimento_w, 0, qt_material_w, cd_cgc_fornec_w, ie_estoque_w);
    end if;

    if (cd_cgc_fornec_w IS NOT NULL AND cd_cgc_fornec_w::text <> '') then
	ds_entrada_w := substr(ds_entrada_w || ',20',1,4000);
        cd_operacao_estoque_w := cd_oper_consumo_consig_w;
    else
	ds_entrada_w := substr(ds_entrada_w || ',21',1,4000);
        cd_operacao_estoque_w := cd_oper_perda_etq_w;
    end if;
	
	/*Obter_Disp_estoque(	cd_material_w,
				cd_local_estoque_w,
				cd_estabelecimento_w,
				0,
				qt_material_w,
				'',
				ie_estoque_w);*/
				
	Select obter_se_baixa_estoque_pac(cd_setor_atendimento_w, cd_material_w,null,nr_seq_cabine_w)
	into STRICT	ie_baixa_estoq_pac_w
	;
	
	select	max(dt_validade),
		max(ds_lote_fornec)
	into STRICT	dt_validade_w,
		ds_lote_fornec_w
	from	material_lote_fornec
	where	nr_sequencia = nr_seq_lote_fornec_w;
	ds_entrada_w := substr(ds_entrada_w || ',22',1,4000);	
	if (ie_estoque_w = 'S') and (coalesce(ie_baixa_estoq_pac_w,'S') = 'S') then
		begin
		ds_entrada_w	:= substr(ds_entrada_w || ',23',1,4000);
		ds_texto_w 	:= substr(wheb_mensagem_pck.get_texto(303104),1,255);--Ordem
		insert into movimento_estoque(
			nr_movimento_estoque,		cd_estabelecimento,
			cd_local_estoque,			dt_movimento_estoque,
			cd_operacao_estoque,		cd_acao,
			cd_material,			cd_unidade_med_mov,
			qt_movimento,			dt_mesano_referencia,
			dt_atualizacao,			nm_usuario,
			ie_origem_documento,		nr_documento,
			cd_unidade_medida_estoque,	cd_setor_atendimento,
			qt_estoque,			ds_observacao,
			nr_atendimento,			nr_prescricao,
			nr_seq_lote_fornec,		cd_lote_fabricacao,
			dt_validade,cd_fornecedor)
		values (nextval('movimento_estoque_seq'),	cd_estabelecimento_w,
			cd_local_estoque_w,		dt_inicio_preparo_w,
			cd_operacao_estoque_w,		'1',
			cd_material_w,			cd_unidade_medida_w,
			qt_material_w,			dt_inicio_preparo_w,
			clock_timestamp(),				nm_usuario_p,
			'10',				nr_seq_ordem_p,
			cd_unidade_medida_w,		coalesce(cd_setor_atendimento_w,cd_setor_atendimento_ww),
			qt_material_w,			'Gerar_movto_Estoque_ordem - '|| ds_texto_w || ' ' || nr_seq_ordem_p,
			nr_atendimento_w,			nr_prescricao_w,
			nr_seq_lote_fornec_w,		ds_lote_fornec_w,
			dt_validade_w,cd_cgc_fornec_w);
			
		end;
	elsif (coalesce(ie_baixa_estoq_pac_w,'S') = 'S') then
		ds_entrada_w := substr(ds_entrada_w || ',24',1,4000);
		select	ds_material
		into STRICT	ds_material_w
		from	material
		where	cd_material = cd_material_w;
		
		
		CALL wheb_mensagem_pck.exibir_mensagem_abort(184944,'DS_MATERIAL_W='||ds_material_w );

	end if;
	end;
end loop;
close c01;
ds_entrada_w := substr(ds_entrada_w || ',25',1,4000);
update	can_ordem_prod
set	dt_entrega_setor 	= clock_timestamp(),
	nm_usuario_disp		= nm_usuario_p,
	dt_devolucao		 = NULL,
	nm_usuario_devol	 = NULL
where	nr_sequencia		= nr_seq_ordem_p;

commit;

update 	material_atend_paciente
set 	cd_local_estoque 	= cd_local_estoque_w,
	dt_atualizacao_estoque 	= clock_timestamp()
where 	nr_seq_ordem_prod	= nr_seq_ordem_p;

ds_log_w := substr( '1: BAIXAR_ESTOQUE_CMIV Entradas = '   || ds_entrada_w 	     		     || CHR(10) || CHR(13) ||
			'nr_seq_prescr_w'                  || nr_seq_prescr_w                        || CHR(10) || CHR(13) ||
			'nr_seq_mat_atend_w'               || nr_seq_mat_atend_w                     || CHR(10) || CHR(13) ||
			'nr_atendimento_w'                 || nr_atendimento_w                       || CHR(10) || CHR(13) ||
			'cd_setor_atendimento_w'           || cd_setor_atendimento_w                 || CHR(10) || CHR(13) ||
			'cd_setor_atendimento_ww'          || cd_setor_atendimento_ww                || CHR(10) || CHR(13) ||
			'cd_material_w'                    || cd_material_w                          || CHR(10) || CHR(13) ||
			'dt_entrada_unidade_w'             || dt_entrada_unidade_w                   || CHR(10) || CHR(13) ||
			'cd_unidade_medida_w'              || cd_unidade_medida_w                    || CHR(10) || CHR(13) ||
			'qt_material_w'                    || qt_material_w                          || CHR(10) || CHR(13) ||
			'cd_convenio_w'                    || cd_convenio_w                          || CHR(10) || CHR(13) ||
			'cd_categoria_w'                   || cd_categoria_w                         || CHR(10) || CHR(13) ||
			'nr_doc_convenio_w'                || nr_doc_convenio_w                      || CHR(10) || CHR(13) ||
			'ie_tipo_guia_w'                   || ie_tipo_guia_w                         || CHR(10) || CHR(13) ||
			'dt_prescricao_w'                  || dt_prescricao_w                        || CHR(10) || CHR(13) ||
			'ie_via_aplicacao_w'               || ie_via_aplicacao_w                     || CHR(10) || CHR(13) ||
			'cd_fornec_consignado_w'           || cd_fornec_consignado_w                 || CHR(10) || CHR(13) ||
			'nr_seq_lote_fornec_w'             || nr_seq_lote_fornec_w                   || CHR(10) || CHR(13) ||
			'nr_seq_atepacu_w'                 || nr_seq_atepacu_w                       || CHR(10) || CHR(13) ||
			'nr_prescricao_w'                  || nr_prescricao_w                        || CHR(10) || CHR(13) ||
			'cd_local_estoque_w'               || cd_local_estoque_w                     || CHR(10) || CHR(13) ||
			'cd_local_estoque_ww'              || cd_local_estoque_ww                    || CHR(10) || CHR(13) ||
			'cd_motivo_baixa_w'                || cd_motivo_baixa_w                      || CHR(10) || CHR(13) ||
			'nr_seq_cabine_w'                  || nr_seq_cabine_w                        || CHR(10) || CHR(13) ||
			'cd_estabelecimento_w'             || cd_estabelecimento_w                   || CHR(10) || CHR(13) ||
			'cd_estab_estoque_w'               || cd_estab_estoque_w                     || CHR(10) || CHR(13) ||
			'dt_inicio_preparo_w'              || dt_inicio_preparo_w                    || CHR(10) || CHR(13) ||
			'ie_estoque_w'                     || ie_estoque_w                           || CHR(10) || CHR(13) ||
			'ds_material_w'                    || ds_material_w                          || CHR(10) || CHR(13) ||
			'cd_oper_perda_etq_w'              || cd_oper_perda_etq_w                    || CHR(10) || CHR(13) ||
			'ie_consignado_w'                  || ie_consignado_w                        || CHR(10) || CHR(13) ||
			'cd_cgc_fornec_w'                  || cd_cgc_fornec_w                        || CHR(10) || CHR(13) ||
			'ie_lote_consignado_w'             || ie_lote_consignado_w                   || CHR(10) || CHR(13) ||
			'cd_oper_consumo_consig_w'         || cd_oper_consumo_consig_w               || CHR(10) || CHR(13) ||
			'cd_operacao_estoque_w'            || cd_operacao_estoque_w                  || CHR(10) || CHR(13) ||
			'ds_setor_atendimento_w'           || ds_setor_atendimento_w                 || CHR(10) || CHR(13) ||
			'nm_prescritor_w'                  || nm_prescritor_w                        || CHR(10) || CHR(13) ||
			'cd_senha_w'                       || cd_senha_w                             || CHR(10) || CHR(13) ||
			'ie_generico_w'                    || ie_generico_w                          || CHR(10) || CHR(13) ||
			'dt_entrada_w'                     || dt_entrada_w                           || CHR(10) || CHR(13) ||
			'VarRegraLocalEstoque_w'           || VarRegraLocalEstoque_w                 || CHR(10) || CHR(13) ||
			'ie_controlador_estoque_w'         || ie_controlador_estoque_w               || CHR(10) || CHR(13) ||
			'nr_seq_item_prescr_w'             || nr_seq_item_prescr_w                   || CHR(10) || CHR(13) ||
			'cd_material_prescr_w'             || cd_material_prescr_w                   || CHR(10) || CHR(13) ||
			'ie_consiste_ficha_tecnica_w'      || ie_consiste_ficha_tecnica_w            || CHR(10) || CHR(13) ||
			'ie_utiliza_estoq_trans_w'         || ie_utiliza_estoq_trans_w               || CHR(10) || CHR(13) ||
			'ie_realiza_passagem_w'            || ie_realiza_passagem_w                  || CHR(10) || CHR(13) ||
			'ie_baixa_estoq_pac_w'             || ie_baixa_estoq_pac_w                   || CHR(10) || CHR(13) ||
			'ds_lote_fornec_w'                 || ds_lote_fornec_w                       || CHR(10) || CHR(13) ||
			'dt_validade_w'                    || dt_validade_w                          || CHR(10) || CHR(13),1,4000);
	CALL gerar_log_quimio(nr_seq_ordem_p,
			nr_prescricao_w,
			nr_seq_item_prescr_w,
			ds_log_w,
			'D',
			nm_usuario_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baixar_estoque_cmiv ( nr_seq_ordem_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

