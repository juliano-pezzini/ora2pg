-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_status_vaga_acomod ( nr_atendimento_p bigint, cd_setor_atendimento_p bigint, cd_tipo_acomodacao_p bigint) AS $body$
DECLARE


nr_seq_vaga_w		bigint;	
cd_classif_setor_internacao_w	varchar(10);
ie_altera_data_acomodacao_w		varchar(1);
cd_unid_basica_atual_w		gestao_vaga.cd_unid_basica_atual%type;
cd_unid_compl_atual_w		gestao_vaga.cd_unid_compl_atual%type;
				

BEGIN

ie_altera_data_acomodacao_w := obter_param_usuario(1002, 138, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_altera_data_acomodacao_w);

select	coalesce(max(nr_sequencia),0)
into STRICT	nr_seq_vaga_w
from	gestao_vaga
where	nr_atendimento = nr_atendimento_p;

select	cd_classif_setor
into STRICT	cd_classif_setor_internacao_w
from	setor_atendimento
where	cd_setor_atendimento = cd_setor_atendimento_p;

select substr(obter_unidade_atendimento(nr_atendimento_p,'IAA','UB'),1,40)
into STRICT 	cd_unid_basica_atual_w
;
				
select substr(obter_unidade_atendimento(nr_atendimento_p,'IAA','UC'),1,40)
into STRICT 	cd_unid_compl_atual_w
;

if (nr_seq_vaga_w > 0) and
	((cd_classif_setor_internacao_w = 3) or (cd_classif_setor_internacao_w = 4))	then
	
	update	gestao_vaga
	set		cd_setor_atual = cd_setor_atendimento_p,	
			cd_tipo_acomod_atual = cd_tipo_acomodacao_p,
			ie_status = 'F',
			dt_acomodacao = CASE WHEN ie_altera_data_acomodacao_w='S' THEN clock_timestamp()  ELSE null END ,
			cd_unid_basica_atual = cd_unid_basica_atual_w,
			cd_unid_compl_atual  = cd_unid_compl_atual_w
	where	nr_sequencia = nr_seq_vaga_w;
	
end if;
if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_status_vaga_acomod ( nr_atendimento_p bigint, cd_setor_atendimento_p bigint, cd_tipo_acomodacao_p bigint) FROM PUBLIC;

