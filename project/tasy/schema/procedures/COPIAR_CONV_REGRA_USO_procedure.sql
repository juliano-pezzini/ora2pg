-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_conv_regra_uso ( nr_sequencia_p bigint, cd_convenio_orig_p bigint, cd_convenio_dest_p text, ie_convenio_p text, ie_tabela_p text, ie_excluir_p text, ie_excluir_estrutura_p text, nm_usuario_p text) AS $body$
DECLARE


/*
ie_tabela_p
	P    - tabela CONVENIO_REGRA_QTDE_PROC
	M  - tabela CONVENIO_REGRA_QTDE_MAT
*/
cd_convenio_dest_w		integer;
cd_classe_material_w           	integer;
cd_grupo_material_w            	smallint;
cd_material_w                  	integer;
cd_subgrupo_material_w         	smallint;
cd_area_procedimento_w          bigint;
cd_especialidade_w              bigint;
cd_grupo_proc_w                 bigint;
cd_procedimento_w               bigint;
ie_origem_proced_w		bigint;

c01 CURSOR FOR
	SELECT	coalesce(cd_convenio,0)
	from	convenio
	where	(((ie_convenio_p = '1') and (obter_se_contido(cd_convenio, substr(elimina_aspas(cd_convenio_dest_p),1,200)) = 'S')) or
		((ie_convenio_p = '2') and (not obter_se_contido(cd_convenio, substr(elimina_aspas(cd_convenio_dest_p),1,200)) = 'S')));


BEGIN

open C01;
loop
fetch C01 into
	cd_convenio_dest_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (cd_convenio_dest_w > 0) and
		((ie_convenio_p = '1') or (ie_convenio_p = '2' AND cd_convenio_dest_w <> cd_convenio_orig_p)) then

		if (ie_excluir_p = 'S') and (ie_tabela_p = 'P') then
			delete from convenio_regra_qtde_proc
			where cd_convenio = cd_convenio_dest_w;
		end if;

		if (ie_excluir_p = 'S') and (ie_tabela_p = 'M') then
			delete from convenio_regra_qtde_mat
			where cd_convenio = cd_convenio_dest_w;
		end if;

		if (ie_excluir_estrutura_p = 'S') and (ie_tabela_p = 'P') then

			select	max(cd_area_procedimento),
				max(cd_especialidade),
				max(cd_grupo_proc),
				max(cd_procedimento),
				max(ie_origem_proced)
			into STRICT	cd_area_procedimento_w,
				cd_especialidade_w,
				cd_grupo_proc_w,
				cd_procedimento_w,
				ie_origem_proced_w
			from	convenio_regra_qtde_proc
			where	nr_sequencia = nr_sequencia_p;

			delete 	from convenio_regra_qtde_proc
			where 	cd_convenio = cd_convenio_dest_w
			and	coalesce(cd_area_procedimento,coalesce(cd_area_procedimento_w,0))		= coalesce(cd_area_procedimento_w,0)
			and	coalesce(cd_especialidade,coalesce(cd_especialidade_w,0))			= coalesce(cd_especialidade_w,0)
			and	coalesce(cd_procedimento,coalesce(cd_procedimento_w,0))			= coalesce(cd_procedimento_w,0)
			and	coalesce(cd_grupo_proc,coalesce(cd_grupo_proc_w,0))			= coalesce(cd_grupo_proc_w,0)
			and	coalesce(ie_origem_proced,coalesce(ie_origem_proced_w,0))			= coalesce(ie_origem_proced_w,0);
		end if;

		if (ie_excluir_estrutura_p = 'S') and (ie_tabela_p = 'M') then

			select	max(cd_classe_material),
				max(cd_grupo_material),
				max(cd_material),
				max(cd_subgrupo_material)
			into STRICT	cd_classe_material_w,
				cd_grupo_material_w,
				cd_material_w,
				cd_subgrupo_material_w
			from	convenio_regra_qtde_mat
			where	nr_sequencia = nr_sequencia_p;

			delete 	from convenio_regra_qtde_mat
			where 	cd_convenio = cd_convenio_dest_w
			and	coalesce(cd_classe_material,coalesce(cd_classe_material_w,0))		= coalesce(cd_classe_material_w,0)
			and	coalesce(cd_grupo_material,coalesce(cd_grupo_material_w,0))		= coalesce(cd_grupo_material_w,0)
			and	coalesce(cd_material,coalesce(cd_material_w,0))				= coalesce(cd_material_w,0)
			and	coalesce(cd_subgrupo_material,coalesce(cd_subgrupo_material_w,0))		= coalesce(cd_subgrupo_material_w,0);
		end if;

		if (ie_tabela_p = 'P') then

		insert into convenio_regra_qtde_proc(
			cd_area_procedimento,
			cd_categoria,
			cd_convenio,
			cd_especialidade,
			cd_estabelecimento,
			cd_grupo_proc,
			cd_medico,
			cd_plano,
			cd_procedimento,
			cd_proced_referencia,
			cd_setor_atendimento,
			cd_tipo_acomodacao,
			ds_mensagem,
			ds_observacao,
			dt_atualizacao,
			ie_acao_excesso,
			ie_complexidade,
			ie_origem_proced,
			ie_origem_proc_ref,
			ie_situacao,
			ie_tipo_atendimento,
			ie_tipo_financiamento,
			ie_tipo_qtde,
			ie_tipo_setor,
			ie_tipo_uso,
			ie_via_acesso,
			nm_usuario,
			nr_seq_exame,
			nr_seq_forma_org,
			nr_seq_grupo,
			nr_seq_proc_interno,
			nr_seq_subgrupo,
			nr_sequencia,
			pr_permitida,
			qt_ano_max,
			qt_ano_max_dia,
			qt_ano_max_mes,
			qt_ano_min,
			qt_ano_min_dia,
			qt_ano_min_mes,
			qt_dias_inter_final,
			qt_dias_inter_inicio,
			qt_horas_intervalo,
			qt_permitida,
			cd_perfil)
		SELECT	cd_area_procedimento,
			cd_categoria,
			cd_convenio_dest_w,
			cd_especialidade,
			cd_estabelecimento,
			cd_grupo_proc,
			cd_medico,
			cd_plano,
			cd_procedimento,
			cd_proced_referencia,
			cd_setor_atendimento,
			cd_tipo_acomodacao,
			ds_mensagem,
			ds_observacao,
			clock_timestamp(),
			ie_acao_excesso,
			ie_complexidade,
			ie_origem_proced,
			ie_origem_proc_ref,
			ie_situacao,
			ie_tipo_atendimento,
			ie_tipo_financiamento,
			ie_tipo_qtde,
			ie_tipo_setor,
			ie_tipo_uso,
			ie_via_acesso,
			nm_usuario_p,
			nr_seq_exame,
			nr_seq_forma_org,
			nr_seq_grupo,
			nr_seq_proc_interno,
			nr_seq_subgrupo,
			nextval('convenio_regra_qtde_proc_seq'),
			pr_permitida,
			qt_ano_max,
			qt_ano_max_dia,
			qt_ano_max_mes,
			qt_ano_min,
			qt_ano_min_dia,
			qt_ano_min_mes,
			qt_dias_inter_final,
			qt_dias_inter_inicio,
			qt_horas_intervalo,
			qt_permitida,
			cd_perfil
		from	convenio_regra_qtde_proc
		where	nr_sequencia	= nr_sequencia_p
		and	cd_convenio	= cd_convenio_orig_p;

		end if;

		if (ie_tabela_p = 'M') then

		insert into convenio_regra_qtde_mat(
			cd_categoria,
			cd_cgc_fornecedor,
			cd_cgc_prestador,
			cd_classe_material,
			cd_convenio,
			cd_estabelecimento,
			cd_grupo_material,
			cd_material,
			cd_plano,
			cd_setor_atendimento,
			cd_subgrupo_material,
			cd_tipo_acomodacao,
			ds_mensagem,
			ds_observacao,
			dt_atualizacao,
			ie_acao_excesso,
			ie_situacao,
			ie_tipo_atendimento,
			ie_tipo_qtde,
			nm_usuario,
			nr_sequencia,
			qt_horas_intervalo,
			qt_ano_max,
			qt_ano_max_dia,
			qt_ano_max_mes,
			qt_ano_min,
			qt_ano_min_dia,
			qt_ano_min_mes,
			qt_minutos_intervalo,
			qt_permitida,
			cd_perfil,
			ie_paciente_isolado)
		SELECT	cd_categoria,
			cd_cgc_fornecedor,
			cd_cgc_prestador,
			cd_classe_material,
			cd_convenio_dest_w,
			cd_estabelecimento,
			cd_grupo_material,
			cd_material,
			cd_plano,
			cd_setor_atendimento,
			cd_subgrupo_material,
			cd_tipo_acomodacao,
			ds_mensagem,
			ds_observacao,
			clock_timestamp(),
			ie_acao_excesso,
			ie_situacao,
			ie_tipo_atendimento,
			ie_tipo_qtde,
			nm_usuario_p,
			nextval('convenio_regra_qtde_mat_seq'),
			qt_horas_intervalo,
			qt_ano_max,
			qt_ano_max_dia,
			qt_ano_max_mes,
			qt_ano_min,
			qt_ano_min_dia,
			qt_ano_min_mes,
			qt_minutos_intervalo,
			qt_permitida,
			cd_perfil,
			ie_paciente_isolado
		from	convenio_regra_qtde_mat
		where	nr_sequencia	= nr_sequencia_p
		and	cd_convenio	= cd_convenio_orig_p;

		end if;
	end if;

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_conv_regra_uso ( nr_sequencia_p bigint, cd_convenio_orig_p bigint, cd_convenio_dest_p text, ie_convenio_p text, ie_tabela_p text, ie_excluir_p text, ie_excluir_estrutura_p text, nm_usuario_p text) FROM PUBLIC;

