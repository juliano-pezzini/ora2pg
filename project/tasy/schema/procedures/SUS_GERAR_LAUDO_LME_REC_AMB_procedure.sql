-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_gerar_laudo_lme_rec_amb ( nr_atendimento_p bigint, nr_seq_receita_p text, cd_pessoa_fisica_p text, cd_medico_p text, nm_usuario_p text, ds_erro_p INOUT text, nr_seq_interno_p INOUT bigint) AS $body$
DECLARE


cd_material_w			bigint;
cd_cid_principal_w			varchar(10);
cd_cid_secundario_w		varchar(10);
cd_procedimento_w		bigint;
nr_laudo_w			smallint;
ie_laudo_w			varchar(1) := 'S';
nr_sequencia_w			bigint;
qt_dose_w			double precision;
ie_via_aplicacao_w			varchar(5);
cd_intervalo_w			varchar(7);
ie_cid_procedimento_w		varchar(15) := 'N';
cd_estab_usuario_w		integer;
ds_retorno_w			varchar(255) := 'X';
nr_seq_mat_opm_w		sus_material_opm.nr_sequencia%type;
nr_seq_proc_interno_w		sus_material_opm.nr_seq_proc_interno%type;
ie_tipo_laudo_apac_w		sus_material_opm.ie_tipo_laudo_apac%type;

c01 CURSOR FOR
	SELECT	cd_material,
		coalesce((fa_obter_qtd_disp_dia_periodo(nr_seq_receita,dt_inicio_receita,dt_validade_receita,cd_material,'N'))::numeric ,1),
		ie_via_aplicacao,
		cd_intervalo
	from	fa_receita_farmacia_item
	where	nr_seq_receita	= nr_seq_receita_p
	order by 1;


BEGIN

begin
cd_estab_usuario_w := wheb_usuario_pck.get_cd_estabelecimento;
exception
when others then
	cd_estab_usuario_w := 0;	
end;
ie_cid_procedimento_w := obter_valor_param_usuario(1124,94,obter_perfil_ativo,nm_usuario_p,cd_estab_usuario_w);

open c01;
loop
fetch c01 into
	cd_material_w,
	qt_dose_w,
	ie_via_aplicacao_w,
	cd_intervalo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	select	max(nr_sequencia)
	into STRICT	nr_seq_mat_opm_w
	from	sus_material_opm
	where	cd_material		= cd_material_w
	and	ie_origem_proced	= 7;

	if (nr_seq_mat_opm_w > 0) then

		select	cd_procedimento,
			nr_seq_proc_interno,
			ie_tipo_laudo_apac
		into STRICT	cd_procedimento_w,
			nr_seq_proc_interno_w,
			ie_tipo_laudo_apac_w
		from	sus_material_opm
		where	nr_sequencia	= nr_seq_mat_opm_w;

	end if;
	
	select	Obter_Cid_Atendimento(nr_atendimento_p,'P'),
		Obter_Cid_Atendimento(nr_atendimento_p,'S')
	into STRICT	cd_cid_principal_w,
		cd_cid_secundario_w
	;	
	
	if (coalesce(cd_cid_principal_w,'X') = 'X') then
		begin
		select	obter_cid_pf(obter_pessoa_atendimento(nr_atendimento_p,'C'),'C')
		into STRICT	cd_cid_principal_w
		;		
		exception
		when others then
			cd_cid_principal_w := 'X';
		end;
	end if;

	if (coalesce(cd_procedimento_w,0) <> 0) and (coalesce(cd_cid_principal_w,'X') <> 'X') then
		begin

		if (coalesce(ie_laudo_w,'N') = 'S') then
			begin

			select	coalesce(MAX(nr_laudo_sus),0) + 1
			into STRICT	nr_laudo_w
			from	sus_laudo_paciente
			where	nr_atendimento	= nr_atendimento_p;

			select	nextval('sus_laudo_paciente_seq')
			into STRICT	nr_sequencia_w
			;

			insert into sus_laudo_paciente(
						nr_seq_interno,
						nr_laudo_sus,
						ie_classificacao,
						ie_tipo_laudo_sus,
						ie_tipo_laudo_apac,
						ie_diaria_acomp,
						dt_emissao,
						nm_usuario,
						dt_atualizacao,
						cd_medico_responsavel,
						nr_atendimento,
						nr_seq_proc_interno)
					values (	nr_sequencia_w,
						nr_laudo_w,
						14,
						0,
						coalesce(ie_tipo_laudo_apac_w, 12),
						'N',
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						cd_medico_p,
						nr_atendimento_p,
						nr_seq_proc_interno_w);

			ie_laudo_w := 'N';
			nr_seq_interno_p := nr_sequencia_w;
			end;
		end if;
		
		if (coalesce(ie_cid_procedimento_w,'N') = 'S') then
			cd_cid_principal_w	:= coalesce(obter_cid_procedimento(cd_procedimento_w,7,'P'),cd_cid_principal_w);
			cd_cid_secundario_w	:= coalesce(obter_cid_procedimento(cd_procedimento_w,7,'S'),cd_cid_secundario_w);
		end if;	
		
		ds_retorno_w := sus_consiste_regra_laudo(cd_estab_usuario_w, cd_procedimento_w, 7, ds_retorno_w);
				
		if (coalesce(ds_retorno_w,'X') = 'X') then
			begin
			
			insert into sus_laudo_medicamento(
						nr_sequencia,
						nr_seq_laudo_sus,
						cd_procedimento,
						ie_origem_proced,
						cd_cid_principal,
						cd_cid_secundario,
						qt_proced_1_mes,
						nm_usuario,
						dt_atualizacao,
						ie_via_aplicacao,
						cd_intervalo_prescr)
					values (	nextval('sus_laudo_medicamento_seq'),
						nr_sequencia_w,
						cd_procedimento_w,
						7,
						cd_cid_principal_w,
						cd_cid_secundario_w,
						qt_dose_w,
						nm_usuario_p,
						clock_timestamp(),
						ie_via_aplicacao_w,
						cd_intervalo_w);
			end;
		end if;
		
		end;
	elsif (coalesce(cd_procedimento_w,0) = 0) then
		ds_erro_p := WHEB_MENSAGEM_PCK.get_texto(281039)||cd_material_w||WHEB_MENSAGEM_PCK.get_texto(281040);
	elsif (coalesce(cd_cid_principal_w,'X') = 'X') then
		ds_erro_p := WHEB_MENSAGEM_PCK.get_texto(281041);
	end if;

	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_gerar_laudo_lme_rec_amb ( nr_atendimento_p bigint, nr_seq_receita_p text, cd_pessoa_fisica_p text, cd_medico_p text, nm_usuario_p text, ds_erro_p INOUT text, nr_seq_interno_p INOUT bigint) FROM PUBLIC;

