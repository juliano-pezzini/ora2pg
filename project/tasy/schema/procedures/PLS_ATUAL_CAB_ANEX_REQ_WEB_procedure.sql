-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atual_cab_anex_req_web ( ie_tipo_anexo_p text, nr_seq_requisicao_p bigint, qt_dose_dia_p bigint, qt_dose_total_p bigint, qt_dias_previsto_p bigint, dt_inicio_previsto_p text, ds_procedimento_cirurgico_p text, dt_real_proc_cirurgico_p text, ds_quimioterapia_p text, dt_quimioterapia_p text, nm_profissional_solic_p text, nr_telef_prof_solic_p text, ds_email_prof_solic_p text, ds_observacao_p text, qt_altura_p bigint, qt_peso_p bigint, qt_superficie_corporal_p bigint, nr_ciclo_atual_p bigint, dt_radioterapia_p text, ds_area_irradiada_p text, nr_seq_guia_p bigint, ds_especificacao_p text, ds_justificativa_p text, dt_diagnostico_p timestamp, cd_doenca_p text, ie_estadia_tumor_p text, cd_finalidade_p text, ie_tipo_quimioterapia_p text, ds_diagnostico_p text, ds_observacao_diag_p text, ie_capacidade_funcional_p text, nm_usuario_p text, cd_estabelecimento_p bigint, nr_ciclo_previsto_p bigint, qt_intervalo_ciclo_p bigint, nr_campos_p bigint, cd_senha_p text, cd_diagnostico_imagem_p text, ds_plano_terapeutico_p text, ie_reconsistir_p text, nr_dia_ciclo_atual_p bigint, ie_tumor_p text, ie_nodulo_p text, ie_metastases_p text) AS $body$
DECLARE

											 
nr_sequencia_w		pls_lote_anexo_guias_aut.nr_sequencia%type;
nr_sequencia_diag_w 	pls_lote_anexo_diag_aut.nr_sequencia%type;
ie_tipo_diagnostico_w	pls_lote_anexo_diag_aut.ie_tipo_diagnostico%type;


BEGIN 
 
select	max(nr_sequencia) 
into STRICT	nr_sequencia_w 
from	pls_lote_anexo_guias_aut 
where	nr_seq_requisicao = nr_seq_requisicao_p 
and	ie_tipo_anexo = ie_tipo_anexo_p;
 
if (coalesce(nr_sequencia_w::text, '') = '') then 
	nr_sequencia_w := pls_gerar_cab_anexo_req_web(nr_seq_requisicao_p, ie_tipo_anexo_p, nm_usuario_p, nr_sequencia_w);
end if;
 
 
if (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') then 
	update	pls_lote_anexo_guias_aut 
	set	qt_dose_dia 		= qt_dose_dia_p, 
		qt_dose_total 		= qt_dose_total_p, 
		qt_dias_previsto 	= qt_dias_previsto_p, 
		dt_inicio_previsto	= to_date(dt_inicio_previsto_p,'dd/mm/yyyy'), 
		ds_procedimento_cirurgico = ds_procedimento_cirurgico_p, 
		dt_real_proc_cirurgico 	= to_date(dt_real_proc_cirurgico_p,'dd/mm/yyyy'), 
		ds_quimioterapia 	= ds_quimioterapia_p, 
		dt_quimioterapia 	= to_date(dt_quimioterapia_p,'dd/mm/yyyy'), 
		nm_profissional_solic 	= coalesce(nm_profissional_solic_p,nm_profissional_solic), 
		nr_telef_prof_solic 	= coalesce(nr_telef_prof_solic_p,nr_telef_prof_solic), 
		ds_email_prof_solic 	= coalesce(ds_email_prof_solic_p,ds_email_prof_solic), 
		ds_observacao 		= ds_observacao_p, 
		qt_altura 		= qt_altura_p, 
		qt_peso 		= qt_peso_p, 
		qt_superficie_corporal 	= qt_superficie_corporal_p, 
		nr_ciclo_atual 		= nr_ciclo_atual_p, 
		dt_radioterapia 	= to_date(dt_radioterapia_p,'dd/mm/yyyy'), 
		ds_area_irradiada 	= ds_area_irradiada_p, 
		ds_especificacao 	= ds_especificacao_p, 
		ds_justificativa 	= ds_justificativa_p, 
		nm_usuario 		= nm_usuario_p, 
		dt_atualizacao 		= clock_timestamp(), 
		nr_ciclo_previsto 	= nr_ciclo_previsto_p, 
		qt_intervalo_ciclo 	= qt_intervalo_ciclo_p, 
		nr_campos 		= nr_campos_p, 
		cd_senha 		= cd_senha_p, 
		nr_dia_ciclo_atual	= nr_dia_ciclo_atual_p 
	where	nr_sequencia 		= nr_sequencia_w;
	 
	 
	/* Verifica se existe registro com doença cadastrado, se não existir gera um novo */
 
	if (cd_doenca_p IS NOT NULL AND cd_doenca_p::text <> '') then 
		ie_tipo_diagnostico_w := 'DD';
		 
		select	max(nr_sequencia) 
		into STRICT	nr_sequencia_diag_w 
		from	pls_lote_anexo_diag_aut 
		where	nr_seq_lote_anexo_guia = nr_sequencia_w 
		and	ie_tipo_diagnostico = 'DD';
		 
		 
		if ( coalesce(nr_sequencia_diag_w::text, '') = '' ) then		 
			insert	into	pls_lote_anexo_diag_aut(nr_sequencia, nr_seq_lote_anexo_guia, cd_doenca, 
								nm_usuario, dt_atualizacao,dt_atualizacao_nrec, 
								nm_usuario_nrec, ie_tipo_diagnostico) 
						values (	nextval('pls_lote_anexo_diag_aut_seq'), nr_sequencia_w, cd_doenca_p, 
								nm_usuario_p, clock_timestamp(),	clock_timestamp(), 
								nm_usuario_p, ie_tipo_diagnostico_w);
		else 
			update 	pls_lote_anexo_diag_aut 
			set	cd_doenca 		= cd_doenca_p,				 
				dt_atualizacao 		= clock_timestamp(), 
				ie_tipo_diagnostico 	= ie_tipo_diagnostico_w, 
				nm_usuario 		= nm_usuario_p 
			where	nr_sequencia 		= nr_sequencia_diag_w;
			 
		end if;
		 
	end if;
	 
	/* Verifica se existe registro com dados do tratamento gerado, se não exisitir gera um novo */
 
	if ( (ie_tipo_quimioterapia_p IS NOT NULL AND ie_tipo_quimioterapia_p::text <> '') or (cd_finalidade_p IS NOT NULL AND cd_finalidade_p::text <> '') or (ie_estadia_tumor_p IS NOT NULL AND ie_estadia_tumor_p::text <> '') or (ie_capacidade_funcional_p IS NOT NULL AND ie_capacidade_funcional_p::text <> '') ) then		 
		ie_tipo_diagnostico_w := 'DT';
		 
		select	max(nr_sequencia) 
		into STRICT	nr_sequencia_diag_w 
		from	pls_lote_anexo_diag_aut 
		where	nr_seq_lote_anexo_guia = nr_sequencia_w 
		and	ie_tipo_diagnostico = 'DT';
		 
		 
		if ( coalesce(nr_sequencia_diag_w::text, '') = '' ) then 
			insert	into	pls_lote_anexo_diag_aut(	nr_sequencia, nr_seq_lote_anexo_guia, dt_diagnostico, 
									ie_estadia_tumor, cd_finalidade_tratamento, 
									ie_tipo_quimioterapia, ds_diagnostico, ds_observacao, 
									ie_capacidade_funcional, nm_usuario, dt_atualizacao, 
									dt_atualizacao_nrec, nm_usuario_nrec, ie_tipo_diagnostico, 
									cd_diagnostico_imagem, ds_plano_terapeutico, ie_tumor, 
									ie_nodulo, ie_metastases) 
							values (	nextval('pls_lote_anexo_diag_aut_seq'), nr_sequencia_w, dt_diagnostico_p, 
									ie_estadia_tumor_p, cd_finalidade_p, 
									ie_tipo_quimioterapia_p, ds_diagnostico_p, ds_observacao_diag_p, 
									ie_capacidade_funcional_p, nm_usuario_p, clock_timestamp(), 
									clock_timestamp(),nm_usuario_p, ie_tipo_diagnostico_w, 
									cd_diagnostico_imagem_p, ds_plano_terapeutico_p, ie_tumor_p, 
									ie_nodulo_p, ie_metastases_p);					
		else			 
			update 	pls_lote_anexo_diag_aut 
			set	dt_diagnostico 		= dt_diagnostico_p,			 
				ie_estadia_tumor 	= ie_estadia_tumor_p, 
				cd_finalidade_tratamento = cd_finalidade_p, 
				ie_tipo_quimioterapia	= ie_tipo_quimioterapia_p, 
				ds_diagnostico 		= ds_diagnostico_p, 
				ds_observacao 		= ds_observacao_diag_p, 
				ie_capacidade_funcional = ie_capacidade_funcional_p, 
				ie_tipo_diagnostico 	= ie_tipo_diagnostico_w, 
				dt_atualizacao 		= clock_timestamp(), 
				nm_usuario		= nm_usuario_p, 
				cd_diagnostico_imagem 	= cd_diagnostico_imagem_p, 
				ds_plano_terapeutico 	= ds_plano_terapeutico_p, 
				ie_tumor		= ie_tumor_p, 
				ie_nodulo		= ie_nodulo_p,	 
				ie_metastases		= ie_metastases_P 
			where	nr_sequencia 		= nr_sequencia_diag_w;
		end if;
	end if;
	 
end if;
 
if (ie_reconsistir_p = 'S') then 
	CALL pls_req_desfazer_consistir( nr_seq_requisicao_p,nm_usuario_p);
	CALL pls_consistir_requisicao(nr_seq_requisicao_p, cd_estabelecimento_p,nm_usuario_p);
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atual_cab_anex_req_web ( ie_tipo_anexo_p text, nr_seq_requisicao_p bigint, qt_dose_dia_p bigint, qt_dose_total_p bigint, qt_dias_previsto_p bigint, dt_inicio_previsto_p text, ds_procedimento_cirurgico_p text, dt_real_proc_cirurgico_p text, ds_quimioterapia_p text, dt_quimioterapia_p text, nm_profissional_solic_p text, nr_telef_prof_solic_p text, ds_email_prof_solic_p text, ds_observacao_p text, qt_altura_p bigint, qt_peso_p bigint, qt_superficie_corporal_p bigint, nr_ciclo_atual_p bigint, dt_radioterapia_p text, ds_area_irradiada_p text, nr_seq_guia_p bigint, ds_especificacao_p text, ds_justificativa_p text, dt_diagnostico_p timestamp, cd_doenca_p text, ie_estadia_tumor_p text, cd_finalidade_p text, ie_tipo_quimioterapia_p text, ds_diagnostico_p text, ds_observacao_diag_p text, ie_capacidade_funcional_p text, nm_usuario_p text, cd_estabelecimento_p bigint, nr_ciclo_previsto_p bigint, qt_intervalo_ciclo_p bigint, nr_campos_p bigint, cd_senha_p text, cd_diagnostico_imagem_p text, ds_plano_terapeutico_p text, ie_reconsistir_p text, nr_dia_ciclo_atual_p bigint, ie_tumor_p text, ie_nodulo_p text, ie_metastases_p text) FROM PUBLIC;

