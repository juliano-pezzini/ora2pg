-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_exame_atend_individual ( nr_atendimento_p prescr_medica.nr_atendimento%type, cd_medico_p prescr_medica.cd_medico%type, nr_seq_atend_individual_p esus_atend_ind_exame.nr_seq_atend_ind%type ) AS $body$
DECLARE


esus_atend_ind_exame_w      esus_atend_ind_exame%rowtype;

nr_sequencia_w              esus_atend_ind_exame.nr_sequencia%type;

obtem_exames_solicitados CURSOR FOR
    SELECT      prpro.cd_procedimento,
                prpac.ie_origem_proced
    from        prescr_procedimento prpro,
                prescr_medica prmed,
                procedimento_paciente prpac
    where       prpro.nr_prescricao = prmed.nr_prescricao
    and         prpac.nr_atendimento = prmed.nr_atendimento
    and         prmed.nr_atendimento = nr_atendimento_p
    and         prmed.cd_medico = cd_medico_p
    and         prpro.cd_procedimento not in (
                                                    SELECT      1
                                                    from        esus_atend_ind_exame atexa,
                                                                esus_atend_individual atind
                                                    where       atexa.nr_seq_atend_ind = atind.nr_sequencia
                                                    and         atexa.cd_procedimento = prpro.cd_procedimento
                                                    and         atexa.ie_solicitado = 'S'
                                                )
    order by    prpro.dt_atualizacao desc;


BEGIN

    esus_atend_ind_exame_w.dt_atualizacao := clock_timestamp();
    esus_atend_ind_exame_w.nm_usuario := obter_usuario_ativo();
    esus_atend_ind_exame_w.dt_atualizacao_nrec := clock_timestamp();
    esus_atend_ind_exame_w.nm_usuario_nrec := obter_usuario_ativo();
    esus_atend_ind_exame_w.ie_solicitado := 'S';
    esus_atend_ind_exame_w.ie_avaliado := 'N';
    esus_atend_ind_exame_w.nr_seq_atend_ind := nr_seq_atend_individual_p;

    <<obtem_exames_solicitados_esus>>
    for	exame in obtem_exames_solicitados loop

        select      nextval('esus_atend_ind_exame_seq')
        into STRICT        nr_sequencia_w
;

        esus_atend_ind_exame_w.nr_sequencia := nr_sequencia_w;
        esus_atend_ind_exame_w.cd_procedimento := exame.cd_procedimento;
        esus_atend_ind_exame_w.ie_origem_proced := exame.ie_origem_proced;

        insert into esus_atend_ind_exame(
            nr_sequencia,
            dt_atualizacao,
            nm_usuario,
            dt_atualizacao_nrec,
            nm_usuario_nrec,
            cd_procedimento,
            ie_origem_proced,
            ie_avaliado,
            nr_seq_atend_ind,
            ie_solicitado
        )
        values (
            esus_atend_ind_exame_w.nr_sequencia,
            esus_atend_ind_exame_w.dt_atualizacao,
            esus_atend_ind_exame_w.nm_usuario,
            esus_atend_ind_exame_w.dt_atualizacao_nrec,
            esus_atend_ind_exame_w.nm_usuario_nrec,
            esus_atend_ind_exame_w.cd_procedimento,
            esus_atend_ind_exame_w.ie_origem_proced,
            esus_atend_ind_exame_w.ie_avaliado,
            esus_atend_ind_exame_w.nr_seq_atend_ind,
            esus_atend_ind_exame_w.ie_solicitado
        );

    end loop obtem_exames_solicitados_esus;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_exame_atend_individual ( nr_atendimento_p prescr_medica.nr_atendimento%type, cd_medico_p prescr_medica.cd_medico%type, nr_seq_atend_individual_p esus_atend_ind_exame.nr_seq_atend_ind%type ) FROM PUBLIC;

