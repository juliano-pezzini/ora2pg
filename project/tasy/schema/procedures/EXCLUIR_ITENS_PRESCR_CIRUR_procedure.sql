-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE excluir_itens_prescr_cirur ( nr_prescricao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_sequencia_w		bigint;
cd_kit_material_w	integer;
nr_atendimento_w	bigint;
cd_material_w		integer;
qt_material_w		double precision;
cd_local_estoque_w	bigint;
nr_seq_kit_estoque_w	bigint;
nr_cirurgia_w		bigint;
ds_module_log_w		varchar(255);
ie_log_incl_excl_w	varchar(1);

c01 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.cd_kit_material,
		b.nr_atendimento,
		a.cd_material,
		a.qt_material,
		a.cd_local_estoque,
		a.nr_seq_kit_estoque,
		b.nr_cirurgia
	from	prescr_material a,
		prescr_medica b
	where	a.nr_prescricao = b.nr_prescricao
	and	a.nr_prescricao	= nr_prescricao_p;


BEGIN

ie_log_incl_excl_w	:= coalesce(obter_valor_param_usuario(900, 205, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento),'N');

if (ie_log_incl_excl_w = 'S') then

	select	substr(max(module||' - ' || machine||' - ' || program|| ' - ' || osuser|| ' - ' || terminal),1,255)
	into STRICT	ds_module_log_w
	from	v$session
	where	audsid = (SELECT userenv('sessionid') );

	open C01;
	loop
	fetch C01 into
		nr_sequencia_w,
		cd_kit_material_w,
		nr_atendimento_w,
		cd_material_w,
		qt_material_w,
		cd_local_estoque_w,
		nr_seq_kit_estoque_w,
		nr_cirurgia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		insert	into mat_atend_pac_log(
			nr_sequencia,
			nr_seq_mat,
			dt_atualizacao,
			nm_usuario,
			ds_module,
			nr_atendimento,
			cd_material,
			ie_acao,
			qt_material,
			cd_perfil,
			cd_funcao,
			cd_setor_atendimento,
			dt_entrada_unidade,
			nr_prescricao,
			cd_local_estoque,
			nr_seq_kit_estoque,
			cd_material_kit,
			nr_cirurgia)
		values (nextval('mat_atend_pac_log_seq'),
			nr_sequencia_w,
			clock_timestamp(),
			wheb_usuario_pck.get_nm_usuario,
			ds_module_log_w,
			nr_atendimento_w,
			cd_material_w,
			'E',
			qt_material_w,
			wheb_usuario_pck.get_cd_perfil,
			wheb_usuario_pck.get_cd_funcao,
			null,
			null,
			nr_prescricao_p,
			cd_local_estoque_w,
			nr_seq_kit_estoque_w,
			cd_kit_material_w,
			nr_cirurgia_w);
		end;
	end loop;
	close C01;

	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE excluir_itens_prescr_cirur ( nr_prescricao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

