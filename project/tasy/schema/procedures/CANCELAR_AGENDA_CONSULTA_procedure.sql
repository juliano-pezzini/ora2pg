-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cancelar_agenda_consulta ( nr_seq_agenda_p bigint, nm_usuario_p text) AS $body$
DECLARE

dt_cancelamento_w		timestamp;
dt_atual_w				timestamp;
dt_canc_nova_w			timestamp;
cd_agenda_w				bigint;
nr_seq_opm_w            bigint;
qt_segundos_ajuste_w	bigint := 0;
ie_existe_uk_w		varchar(1) := 'S';
qt_loop_w		smallint := 0;
nr_conta_w				bigint;




BEGIN

select	dt_agenda,
		cd_agenda,
        nr_seq_opm
into STRICT	dt_atual_w,
		cd_agenda_w,
        nr_seq_opm_w
from 	agenda_consulta
where	nr_sequencia	= nr_seq_agenda_p;


select	/*+ INDEX(AGENDA_CONSULTA AGECONS_I4) */		max(coalesce(dt_atual_w, dt_agenda))
into STRICT	dt_cancelamento_w
from	agenda_consulta
where	trunc(dt_agenda, 'mi') = trunc(dt_atual_w, 'mi')
and		dt_agenda between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_atual_w) and ESTABLISHMENT_TIMEZONE_UTILS.endOfDay(dt_atual_w);

--Verificar se ja existe outro registro com a mesma data(AGECONS_UK)

/*select	count(*)
into	qt_segundos_ajuste_w
from	agenda_consulta
where	cd_agenda = cd_agenda_w
and		to_char(dt_agenda, 'dd/mm/yyyy hh24:mi')	= to_char(dt_cancelamento_w, 'dd/mm/yyyy hh24:mi')
and		dt_agenda between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_cancelamento_w) and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_cancelamento_w) + (86399/86400)
and		ie_status_agenda	= 'C';

select	dt_cancelamento_w + (qt_segundos_ajuste_w + 1)/86400
into	dt_canc_nova_w
from	dual;*/


--Validar caso passar de 1 minuto para o proximo agendamento
select	coalesce(max(1), 0)
into STRICT	qt_segundos_ajuste_w
from	agenda_consulta
where	cd_agenda = cd_agenda_w
and		trunc(dt_agenda,'mi') = trunc(dt_cancelamento_w,'mi')
and		dt_agenda between trunc(dt_cancelamento_w) and trunc(dt_cancelamento_w) + (86399/86400)
and		ie_status_agenda	= 'C';

while(qt_segundos_ajuste_w > 0) and (qt_loop_w < 60) loop
	begin
	dt_cancelamento_w := dt_cancelamento_w + 1/86400;
	qt_loop_w := qt_loop_w+1;
	select	coalesce(max(1), 0)
	into STRICT	qt_segundos_ajuste_w
	from	agenda_consulta
	where	cd_agenda = cd_agenda_w
	and		dt_agenda = dt_cancelamento_w
	and		dt_agenda between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_cancelamento_w) and ESTABLISHMENT_TIMEZONE_UTILS.endOfDay(dt_cancelamento_w)
	and		ie_status_agenda	= 'C';	
	end;	
end loop;

dt_canc_nova_w := dt_cancelamento_w;

update	agenda_consulta
set	ie_status_agenda	= 'C',
	dt_agenda			= dt_canc_nova_w, -- + (qt_segundos_ajuste_w + 1)/86400,
	nm_usuario			= nm_usuario_p,	
	dt_atualizacao		= clock_timestamp(),
	dt_cancelamento		= clock_timestamp()
where	nr_sequencia	= nr_seq_agenda_p;

exception
when others then
	update	agenda_consulta
	set	ie_status_agenda	= 'C',
		dt_agenda			= dt_canc_nova_w + (1/1440) + (qt_segundos_ajuste_w + 1)/86400,
		nm_usuario			= nm_usuario_p,
		dt_atualizacao		= clock_timestamp(),
		dt_cancelamento		= clock_timestamp()
	where	nr_sequencia	= nr_seq_agenda_p;

if (nr_seq_opm_w > 0) then	
	select count(*)
	  into STRICT nr_conta_w
	  from agenda_consulta ac
	where ac.IE_STATUS_AGENDA <> 'C'
	  and ac.NR_SEQ_OPM = nr_seq_opm_w
	  and trunc(ac.dt_Agenda) = trunc(dt_atual_w)
	  and ac.nr_sequencia = nr_seq_agenda_p;
	if (nr_conta_w = 0) then
		CALL gravar_status_op_opm(nr_seq_opm_w,'CAA',cd_agenda_w ,nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cancelar_agenda_consulta ( nr_seq_agenda_p bigint, nm_usuario_p text) FROM PUBLIC;

