-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_conta_mat ( nr_seq_conta_p bigint, nr_seq_prestador_p bigint, nr_seq_segurado_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_situacao_protocolo_p INOUT text, cd_versao_tiss_p text, nr_seq_prestador_prot_p bigint) AS $body$
DECLARE


nr_seq_conta_mat_w              bigint;
cd_material_imp_w               varchar(20)    := null;
cd_material_imp_ww              numeric(20);
dt_atendimento_imp_w            timestamp;
dt_fim_atend_imp_w              timestamp;
dt_inicio_atend_imp_w           timestamp;
dados_tipo_conv_tiss_w		pls_cta_valorizacao_pck.dados_tipo_conv_tiss;
ie_tipo_despesa_imp_w           varchar(2);
ie_tipo_despesa_ww              varchar(2);
tx_reducao_acrescimo_imp_w      double precision;
ds_material_imp_w               varchar(255);
nr_seq_material_w               bigint;
nr_seq_tiss_tabela_mat_w        bigint      := null;
cd_brasindice_w                 varchar(15);
cd_simpro_w                     bigint;
ie_situacao_protocolo_w         varchar(3)     := 'A';
ie_tipo_relacao_w               varchar(2);
ie_material_rede_propria_w      varchar(1);
ie_importacao_material_w        varchar(1)     := 'N';
ie_tipo_material_w              varchar(3)     := 'S';
ie_material_ops_w               varchar(1)     := 'N';
ie_regra_campo_w                varchar(10);
nr_seq_segurado_w               bigint;
nr_seq_material_ww              bigint      := null;
cd_material_envio_w             varchar(30);
ds_material_envio_w             varchar(255);
cd_guia_w                       varchar(30);
cd_guia_plano_imp_w             varchar(30);
cd_usuario_plano_imp_w          varchar(30);
ds_erro_w                       varchar(255)   := null;
cd_procedimento_imp_w           bigint;
ie_origem_proced_w              bigint;
qt_material_imp_w               double precision;
vl_material_imp_w               double precision;
vl_unitario_imp_w               double precision;
nr_seq_regra_conversao_w        bigint;
ie_mat_ativo_w                  varchar(1);
ie_tipo_tabela_conv_w		smallint;
dt_entrada_w			timestamp;
dt_atendimento_w		timestamp;
dt_ref_material_w		timestamp;
nr_seq_regra_conv_w		bigint;
cd_unidade_medida_imp_w		pls_conta_mat.cd_unidade_medida_imp%type;
nr_registro_anvisa_imp_w	pls_conta_mat.nr_registro_anvisa_imp%type;
cd_ref_fabricante_imp_w		pls_conta_mat.cd_ref_fabricante_imp%type;
ds_aut_funcionamento_imp_w	pls_conta_mat.ds_aut_funcionamento_imp%type;
qt_glosa_w			bigint;

/* Variaveis utilizadas na conversao de material TUSS */

cd_material_tuss_w		tuss_material_item.cd_material_tuss%type;
nr_seq_mat_tuss_w		tuss_material_item.nr_sequencia%type;
ds_observacao_ww		varchar(255);
ie_somente_codigo_w		pls_conversao_proc.ie_somente_codigo%type;
ie_tipo_tabela_w		pls_material.ie_tipo_tabela%type;
ie_material_tuss_w		pls_param_importacao_conta.ie_material_tuss%type;
nr_seq_tipo_atendimento_w	pls_conta.nr_seq_tipo_atendimento%type;
nr_seq_guia_w			pls_conta.nr_seq_guia%type;
nr_seq_prest_exec_imp_ref_w	pls_conta.nr_seq_prestador_exec_imp_ref%type;
qt_saldo_w			double precision;
qt_utilizada_w			double precision;
qt_autorizada_w			double precision;
qt_solicitada_w			double precision;
qt_lanc_glosa_w			double precision;
qt_utilizada_glosa_w		double precision;
ie_liberar_item_autor_w		varchar(3);
ie_existe_regra_w		varchar(3);
nr_seq_regra_autor_w		bigint;
ie_restringe_tp_desp_w		pls_param_importacao_conta.ie_restringe_tp_desp%type;
ie_gerar_grupo_ans_w		pls_parametro_contabil.ie_consitencia_grupo_ans%type;
ie_tipo_guia_w			pls_conta.ie_tipo_guia%type;
cd_medico_executor_w		pls_conta.cd_medico_executor%type;
ie_regime_internacao_w		pls_conta.ie_regime_internacao%type;
nr_seq_grupo_ans_w		pls_conta_mat.nr_seq_grupo_ans%type;
nr_seq_conselho_w		pessoa_fisica.nr_seq_conselho%type;

C01 CURSOR FOR
        SELECT  nr_sequencia,
                cd_material_imp,
                dt_atendimento_imp,
                dt_fim_atend_imp,
                dt_inicio_atend_imp,
                ie_origem_preco_imp,
                ie_tipo_despesa_imp,
                tx_reducao_acrescimo_imp,
                ds_material_imp,
                qt_material_imp,
                vl_material_imp,
                vl_unitario_imp,
		cd_unidade_medida_imp,
		nr_registro_anvisa_imp,
		cd_ref_fabricante_imp,
		ds_aut_funcionamento_imp
        from    pls_conta_mat
        where   nr_seq_conta    = nr_seq_conta_p;


BEGIN
/* Obter dados do prestador */

select  coalesce(max(ie_tipo_relacao),'')
into STRICT    ie_tipo_relacao_w
from    pls_prestador
where   nr_sequencia    = nr_seq_prestador_p;

select	coalesce(max(ie_consitencia_grupo_ans), 'S')
into STRICT	ie_gerar_grupo_ans_w
from	pls_parametro_contabil
where	cd_estabelecimento	= cd_estabelecimento_p;

/* Obter dados dos parametros do plano */

begin
select  /*nvl(ie_material_rede_propria,'N'),
	nvl(ie_material_ops,'N'),*/
        coalesce(ie_importacao_material,'N'),
        coalesce(ie_tipo_material,'S'),/*(S,H,C,R)(Sequencia do material,Material do hospital,Codigo do material,Conforme regra)*/
	coalesce(ie_material_tuss,'A'),
	coalesce(ie_restringe_tp_desp,'N')
into STRICT    /*ie_material_rede_propria_w,
		ie_material_ops_w,*/
        ie_importacao_material_w,
        ie_tipo_material_w,
	ie_material_tuss_w,
	ie_restringe_tp_desp_w
from    pls_param_importacao_conta
where   cd_estabelecimento      = cd_estabelecimento_p;
exception
when others then
        ie_material_rede_propria_w      := 'N';
        ie_importacao_material_w        := 'N';
end;

select	max(a.dt_entrada_imp),
	max(a.dt_atendimento_imp),
	max(a.nr_seq_tipo_atendimento),
	max(a.nr_seq_guia),
	max(nr_seq_prestador_exec_imp_ref),
	max(ie_tipo_guia),
	max(cd_medico_executor_w),
	max(ie_regime_internacao)
into STRICT	dt_entrada_w,
	dt_atendimento_w,
	nr_seq_tipo_atendimento_w,
	nr_seq_guia_w,
	nr_seq_prest_exec_imp_ref_w,
	ie_tipo_guia_w,
	cd_medico_executor_w,
	ie_regime_internacao_w
from	pls_conta a
where	a.nr_sequencia	= nr_seq_conta_p;

select	max(nr_seq_conselho)
into STRICT	nr_seq_conselho_w
from	pessoa_fisica
where	cd_pessoa_fisica = cd_medico_executor_w;

/*begin*/

open C01;
loop
fetch C01 into
        nr_seq_conta_mat_w,
        cd_material_imp_w,
        dt_atendimento_imp_w,
        dt_fim_atend_imp_w,
        dt_inicio_atend_imp_w,
        dados_tipo_conv_tiss_w.ie_tipo_tabela,
        ie_tipo_despesa_imp_w,
        tx_reducao_acrescimo_imp_w,
        ds_material_imp_w,
        qt_material_imp_w,
        vl_material_imp_w,
        vl_unitario_imp_w,
	cd_unidade_medida_imp_w,		
	nr_registro_anvisa_imp_w,	
	cd_ref_fabricante_imp_w,		
	ds_aut_funcionamento_imp_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
        begin
        nr_seq_material_w       := null;
	ds_observacao_ww	:= null;
	dt_ref_material_w	:= coalesce(coalesce(dt_atendimento_imp_w,dt_entrada_w),dt_atendimento_w);
		/* Sestari - Conversao do tipo de despesa no TISS 3.00.00 - OS 576907 */

	if ( cd_versao_tiss_p >= '3.01.00' ) then
		if (dados_tipo_conv_tiss_w.ie_tipo_tabela not in (0,18, 19, 20)) then
			ds_observacao_ww	:= 'Codigo da tabela enviada nao e compativel com a versao TISS '||cd_versao_tiss_p||'.';
		end if;
		if (ie_tipo_despesa_imp_w = '8') then  /* OPME */
			ie_tipo_despesa_imp_w := '7'; /* OPME */
		elsif (ie_tipo_despesa_imp_w = '7') then /* Taxas e alugueis */
			ie_tipo_despesa_imp_w := '4'; /* Taxas diversas */
		end if;
	end if;

	 begin
	cd_material_imp_ww      := (cd_material_imp_w)::numeric;
        exception
        when others then
                cd_material_imp_ww      := cd_material_imp_w;
        end;
	
        dados_tipo_conv_tiss_w   := pls_obter_conversao_tab_tiss(lpad(dados_tipo_conv_tiss_w.ie_tipo_tabela,2,'0'), cd_estabelecimento_p, null,
		ie_tipo_despesa_imp_w, 'C', nr_seq_prestador_p, 
		ie_tipo_despesa_imp_w, cd_material_imp_ww);

        /*tratamento realizado para caso exista regra de conversao ro material para procedimento OS 484208 Diogo */

	SELECT * FROM pls_obter_proced_conversao(	null, null, nr_seq_prestador_p, cd_estabelecimento_p, 2, null, null, null, null, null, null, cd_material_imp_ww, null, cd_procedimento_imp_w, ie_origem_proced_w, nr_seq_regra_conversao_w, ie_somente_codigo_w, clock_timestamp(), nr_seq_tipo_atendimento_w, null, null) INTO STRICT cd_procedimento_imp_w, ie_origem_proced_w, nr_seq_regra_conversao_w, ie_somente_codigo_w;
        /*Caso existir regra de conversao devera ser criada a conta proc respectiva e excluida a conta mat*/

        select  max(nr_sequencia)
        into STRICT    nr_seq_tiss_tabela_mat_w
        from    tiss_tipo_tabela
        where   cd_tabela_xml   = dados_tipo_conv_tiss_w.ie_tipo_tabela;

        if (coalesce(nr_seq_tiss_tabela_mat_w,0) = 0) or (coalesce(cd_material_imp_w,'0') = '0') then
                if (ie_tipo_despesa_imp_w = '2') then
                        CALL pls_gravar_conta_glosa('2101', null, null,
                                                nr_seq_conta_mat_w, 'N', 'Medicamento ou tipo da tabela nao informado',
                                                nm_usuario_p, 'A', 'IA',
                                                nr_seq_prestador_p, cd_estabelecimento_p, '', null);
                elsif (ie_tipo_despesa_imp_w = '3') then
                        CALL pls_gravar_conta_glosa('2001', null, null,
                                                nr_seq_conta_mat_w, 'N', 'Material ou tipo da tabela nao informado',
                                                nm_usuario_p, 'A', 'IA',
                                                nr_seq_prestador_p, cd_estabelecimento_p, '', null);
				elsif (ie_tipo_despesa_imp_w = '7')	then
						CALL pls_gravar_conta_glosa('2201', null, null,
                                                nr_seq_conta_mat_w, 'N', 'OPM ou tipo da tabela nao informado',
                                                nm_usuario_p, 'A', 'IA',
                                                nr_seq_prestador_p, cd_estabelecimento_p, '', null);
                end if;
	elsif (ds_observacao_ww IS NOT NULL AND ds_observacao_ww::text <> '') then
		CALL pls_gravar_conta_glosa('9905', null, null,
                                        nr_seq_conta_mat_w, 'N', ds_observacao_ww,
                                        nm_usuario_p, 'A', 'IA',
                                        nr_seq_prestador_p, cd_estabelecimento_p, '', null);
        elsif (dados_tipo_conv_tiss_w.ie_tipo_tabela = 5) then
                select  coalesce(max(cd_tiss),'0')
                into STRICT    cd_brasindice_w
                from    brasindice_preco
                where   cd_tiss = cd_material_imp_w;

                if (cd_brasindice_w = '0') then
			--tratamento realizado Marico Cunha OS 828974, retirados os 0s a esquerda
			select  coalesce(max(cd_tiss),'0')
			into STRICT    cd_brasindice_w
			from    brasindice_preco
			where   (cd_tiss)::numeric  = cd_material_imp_ww;
                end if;
		if (cd_brasindice_w <> '0') then
			select  max(nr_sequencia)
			into STRICT    nr_seq_material_w
			from    pls_material
			where   cd_tiss_brasindice      = cd_brasindice_w
			and	ie_situacao		= 'A'
			and (coalesce(dt_inclusao::text, '') = '' or dt_inclusao <= dt_ref_material_w)
			and (coalesce(dt_exclusao::text, '') = '' or dt_exclusao >= dt_ref_material_w);
			
			if (coalesce(nr_seq_material_w::text, '') = '') then
				
				select  max(nr_sequencia)
				into STRICT    nr_seq_material_w
				from    pls_material
				where   cd_tiss_brasindice      = cd_brasindice_w;
			end if;
		end if;
        elsif (dados_tipo_conv_tiss_w.ie_tipo_tabela = 12) then
	
                select  coalesce(max(cd_simpro),0)
                into STRICT    cd_simpro_w
                from    simpro_cadastro
                where   cd_simpro       = cd_material_imp_ww;

                if (cd_simpro_w > 0) then
			select  max(nr_sequencia)
			into STRICT    nr_seq_material_w
			from    pls_material
			where   cd_simpro       = cd_simpro_w
			and	cd_material_ops	= cd_simpro_w
			and	ie_situacao	= 'A'
			and (coalesce(dt_inclusao::text, '') = '' or dt_inclusao <= dt_ref_material_w)
			and (coalesce(dt_exclusao::text, '') = '' or dt_exclusao >= dt_ref_material_w);
				
			if (coalesce(nr_seq_material_w::text, '') = '') then
			
				select  max(nr_sequencia)
				into STRICT    nr_seq_material_w
				from    pls_material
				where   cd_simpro       = cd_simpro_w
				and	ie_situacao	= 'A'
				and (coalesce(dt_inclusao::text, '') = '' or dt_inclusao <= dt_ref_material_w)
				and (coalesce(dt_exclusao::text, '') = '' or dt_exclusao >= dt_ref_material_w);
				
				if (coalesce(nr_seq_material_w::text, '') = '') then
					
					select  max(nr_sequencia)
					into STRICT    nr_seq_material_w
					from    pls_material
					where   cd_simpro      = cd_simpro_w;
				end if;
			end if;
                end if;
        elsif (dados_tipo_conv_tiss_w.ie_tipo_tabela in (0,18, 19, 20, 90, 98, 99) )then
		
		if (dados_tipo_conv_tiss_w.ie_tipo_tabela in (18,19,20)) and (ie_material_tuss_w in ('T', 'A', 'V')) then
 
			nr_seq_material_w := pls_converte_codigo_tuss_mat(cd_material_imp_w,cd_versao_tiss_p,dt_ref_material_w);
		end if;
		
		if (coalesce(nr_seq_material_w::text, '') = '') and (ie_material_tuss_w in ('C','A','V')) then
			if (ie_tipo_material_w     = 'R') then
			
				nr_seq_material_w       := pls_obter_material_imp(nr_seq_conta_mat_w, ie_tipo_relacao_w, cd_material_imp_ww, dt_atendimento_imp_w,ie_material_tuss_w);
				
			elsif (ie_tipo_material_w             = 'H') then
				if (ie_restringe_tp_desp_w = 'N') then
					 nr_seq_material_w := pls_obter_mat_tiss_vigente( nr_seq_material_w, dt_ref_material_w, cd_material_imp_ww, 'M', 'S', cd_versao_tiss_p);
					
					if (coalesce(nr_seq_material_w::text, '') = '') then
						 nr_seq_material_w := pls_obter_mat_tiss_vigente( nr_seq_material_w, dt_ref_material_w, cd_material_imp_ww, 'M', 'N', cd_versao_tiss_p);
					end if;
				else
					 nr_seq_material_w := pls_obter_mat_vigente_desp( nr_seq_material_w, dt_ref_material_w, cd_material_imp_ww, 'M', 'S', cd_versao_tiss_p, ie_tipo_despesa_imp_w);
					
					if (coalesce(nr_seq_material_w::text, '') = '') then
						 nr_seq_material_w := pls_obter_mat_vigente_desp( nr_seq_material_w, dt_ref_material_w, cd_material_imp_ww, 'M', 'N', cd_versao_tiss_p, ie_tipo_despesa_imp_w);
					end if;
				end if;
				
			elsif (ie_tipo_material_w     = 'C') then /* Felipe - OS 294001 - 28/02/2011 */
			
				if (ie_restringe_tp_desp_w = 'N') then
					 nr_seq_material_w := pls_obter_mat_tiss_vigente( nr_seq_material_w, dt_ref_material_w, cd_material_imp_ww, 'O', 'S', cd_versao_tiss_p);
					
					if (coalesce(nr_seq_material_w::text, '') = '') then
						 nr_seq_material_w := pls_obter_mat_tiss_vigente( nr_seq_material_w, dt_ref_material_w, cd_material_imp_ww, 'O', 'N', cd_versao_tiss_p);
					end if;
				else
					 nr_seq_material_w := pls_obter_mat_vigente_desp( nr_seq_material_w, dt_ref_material_w, cd_material_imp_ww, 'O', 'S', cd_versao_tiss_p, ie_tipo_despesa_imp_w);
					
					if (coalesce(nr_seq_material_w::text, '') = '') then
						 nr_seq_material_w := pls_obter_mat_vigente_desp( nr_seq_material_w, dt_ref_material_w, cd_material_imp_ww, 'O', 'N', cd_versao_tiss_p, ie_tipo_despesa_imp_w);
					end if;
				end if;
			else
				if (ie_restringe_tp_desp_w	= 'N') then
					 nr_seq_material_w := pls_obter_mat_tiss_vigente( nr_seq_material_w, dt_ref_material_w, cd_material_imp_ww, 'S', 'S', cd_versao_tiss_p);
					
					if (coalesce(nr_seq_material_w::text, '') = '') then
						 nr_seq_material_w := pls_obter_mat_tiss_vigente( nr_seq_material_w, dt_ref_material_w, cd_material_imp_ww, 'S', 'N', cd_versao_tiss_p);
					end if;
				else
					 nr_seq_material_w := pls_obter_mat_vigente_desp( nr_seq_material_w, dt_ref_material_w, cd_material_imp_ww, 'S', 'S', cd_versao_tiss_p, ie_tipo_despesa_imp_w);
					
					if (coalesce(nr_seq_material_w::text, '') = '') then
						 nr_seq_material_w := pls_obter_mat_vigente_desp( nr_seq_material_w, dt_ref_material_w, cd_material_imp_ww, 'S', 'N', cd_versao_tiss_p, ie_tipo_despesa_imp_w);
					end if;
				end if;
			end if;
		end if;
        else
	      CALL pls_gravar_conta_glosa('9905', null, null,
                                        nr_seq_conta_mat_w, 'N', 'Tipo de tabela invalido',
                                        nm_usuario_p, 'A', 'IA',
                                        nr_seq_prestador_p, cd_estabelecimento_p, '', null);
        end if;
	
	/*Verifica se o material possui cobertura - OS 847290*/

	if (ie_importacao_material_w = 'S') then
		qt_glosa_w := pls_consistir_cobertura_mat(	nr_seq_segurado_p, '', nr_seq_conta_mat_w, nr_seq_material_w, '', cd_estabelecimento_p, 0, nm_usuario_p, 'IA', qt_glosa_w, 'C');
	end if;

        /*Converte o codigo do material, para a sequencia do material cadastrada na regra de conversao*/

        SELECT * FROM pls_obter_mat_conversao(cd_material_imp_w, ie_tipo_despesa_imp_w, nm_usuario_p, 'R', null, null, nr_seq_prestador_p, nr_seq_material_ww, cd_material_envio_w, ds_material_envio_w, ie_tipo_tabela_conv_w, nr_seq_regra_conv_w, null) INTO STRICT nr_seq_material_ww, cd_material_envio_w, ds_material_envio_w, ie_tipo_tabela_conv_w, nr_seq_regra_conv_w;

        if (nr_seq_material_ww IS NOT NULL AND nr_seq_material_ww::text <> '') then
                nr_seq_material_w       := nr_seq_material_ww;
        end if;
	
        /* Felipe - 17/08/2010 - OS 241291 */
	
        if (ie_importacao_material_w = 'S') and (coalesce(nr_seq_material_w,0) = 0) and (coalesce(cd_material_imp_w,'0') <> '0') then
		if (ie_tipo_despesa_imp_w = '1') then
			 CALL pls_gravar_conta_glosa('2301', null, null,
                                                nr_seq_conta_mat_w, 'N', 'Gas medicinal nao existente na base da operadora',
                                                nm_usuario_p, 'A', 'IA',
                                                nr_seq_prestador_p, cd_estabelecimento_p, '', null);
                elsif (ie_tipo_despesa_imp_w = '2') then
                        CALL pls_gravar_conta_glosa('2101', null, null,
                                                nr_seq_conta_mat_w, 'N', 'Medicamento informado nao existente na base da operadora',
                                                nm_usuario_p, 'A', 'IA',
                                                nr_seq_prestador_p, cd_estabelecimento_p, '', null);
                elsif (ie_tipo_despesa_imp_w = '3') then
                        CALL pls_gravar_conta_glosa('2001', null, null,
                                                nr_seq_conta_mat_w, 'N', 'Material informado nao existente na base da operadora',
                                                nm_usuario_p, 'A', 'IA',
                                                nr_seq_prestador_p, cd_estabelecimento_p, '', null);
				elsif (ie_tipo_despesa_imp_w = '7')	then
						CALL pls_gravar_conta_glosa('2201', null, null,
                                                nr_seq_conta_mat_w, 'N', 'OPM informado nao existente na base da operadora',
                                                nm_usuario_p, 'A', 'IA',
                                                nr_seq_prestador_p, cd_estabelecimento_p, '', null);
                end if;
                if (ie_tipo_despesa_imp_w in ('1','2', '3','7')) then
                        ie_situacao_protocolo_w := 'RE';
                end if;
        end if;
	
        /*dgkorz realiza a atualizacao do campo ie_tipo_despesa segundo o cadastro da tabela pls_material OS 373336*/

        select  max(ie_tipo_despesa),
		max(ie_tipo_tabela)
        into STRICT    ie_tipo_despesa_ww,
		ie_tipo_tabela_w
        from    pls_material
        where   nr_sequencia = nr_seq_material_w;

	if (ie_tipo_tabela_w IS NOT NULL AND ie_tipo_tabela_w::text <> '') then
		
		if (ie_tipo_tabela_w	!= dados_tipo_conv_tiss_w.ie_tipo_tabela) then
			CALL pls_gravar_conta_glosa('9905', null, null,
						nr_seq_conta_mat_w, 'N', 'Tabela enviada nao condiz com a tabela permitida para o material',
						nm_usuario_p, 'A', 'IA',
						nr_seq_prestador_p, cd_estabelecimento_p, '', null);
		end if;
	end if;
        if (ie_tipo_despesa_ww     > 0) then
                ie_tipo_despesa_imp_w   := ie_tipo_despesa_ww;
        end if;

        ie_mat_ativo_w := pls_obter_se_mat_ativo(nr_seq_material_w,dt_ref_material_w);

        if ( ie_mat_ativo_w = 'N' ) then
                CALL pls_gravar_conta_glosa('9920', nr_seq_conta_p, null,
                                        nr_seq_conta_mat_w, 'N', 'O material nao esta ativo.',
                                        nm_usuario_p, 'A', 'IA',
                                        nr_seq_prestador_p, cd_estabelecimento_p, '', null);
        elsif ( ie_mat_ativo_w = 'D' ) then
                CALL pls_gravar_conta_glosa('9920', nr_seq_conta_p, null,
                                        nr_seq_conta_mat_w, 'N', 'O material esta fora da data de vigencia.',
                                        nm_usuario_p, 'A', 'IA',
                                        nr_seq_prestador_p, cd_estabelecimento_p, '' , null);
        end if;
	
	/*Tratamento para quando nao tiver data no material pegar a data de atendimento ou entrada da conta*/

	if (coalesce(dt_atendimento_imp_w::text, '') = '')	then
		dt_atendimento_imp_w := dt_ref_material_w;
	end if;
	
	/* Eder - 15/07/2013 - Tratamento para converter materiais PROPRIO para TUSS,  OS 588350 */
		
	if (cd_versao_tiss_p >= '3.01.00') then
		if (dados_tipo_conv_tiss_w.ie_tipo_tabela	= 00 and ie_tipo_despesa_imp_w  in ('1','2','3','7')) then
			SELECT * FROM pls_converte_codigo_mat_tuss(nr_seq_material_w, cd_material_tuss_w, nr_seq_mat_tuss_w) INTO STRICT cd_material_tuss_w, nr_seq_mat_tuss_w;
		end if;
	end if;
	
	if (ie_gerar_grupo_ans_w = 'S') then

	nr_seq_grupo_ans_w := pls_obter_grupo_ans(	null, null, nr_seq_conselho_w,
							nr_seq_tipo_atendimento_w, ie_tipo_guia_w, ie_regime_internacao_w, 
							ie_tipo_despesa_imp_w, 'G', cd_estabelecimento_p, nr_seq_conta_p);
	end if;

        update  pls_conta_mat
        set     nr_seq_material			= nr_seq_material_w,
                dt_atendimento          	= dt_atendimento_imp_w,
                dt_fim_atend            	= dt_fim_atend_imp_w,
                dt_inicio_atend         	= dt_inicio_atend_imp_w,
                ie_origem_preco         	= dados_tipo_conv_tiss_w.ie_tipo_tabela,
                ie_tipo_despesa         	= ie_tipo_despesa_imp_w,
                tx_reducao_acrescimo    	= tx_reducao_acrescimo_imp_w,
                qt_material             	= 0,
                vl_material             	= 0,
                vl_unitario             	= 0,
                vl_liberado             	= 0,
                nm_usuario              	= nm_usuario_p,
                nr_seq_tiss_tabela      	= nr_seq_tiss_tabela_mat_w,
		cd_unidade_medida		= cd_unidade_medida_imp_w,		
		nr_registro_anvisa		= nr_registro_anvisa_imp_w,	
		cd_ref_fabricante		= cd_ref_fabricante_imp_w,		
		ds_aut_funcionamento 		= ds_aut_funcionamento_imp_w,
		nr_seq_grupo_ans		= nr_seq_grupo_ans_w
        where   nr_sequencia            	= nr_seq_conta_mat_w;

        CALL pls_tiss_consistir_material(nr_seq_conta_mat_w, 'CM', 'IA',
                null, null, '',
                nm_usuario_p, cd_estabelecimento_p);


        if (ie_tipo_despesa_imp_w = '7') then
                CALL pls_tiss_consistir_opm(nr_seq_conta_mat_w, 'CM', 'IA',
                        null, null, '',
                        nm_usuario_p, cd_estabelecimento_p);
	else
		select 	coalesce(max(qt_saldo),0),
			coalesce(max(qt_utilizada),0),
			coalesce(max(qt_autorizada),0)
		into STRICT	qt_saldo_w,
			qt_utilizada_w,
			qt_autorizada_w
		from 	table(pls_conta_autor_pck.obter_dados(nr_seq_guia_w,'M', cd_estabelecimento_p, null, null, nr_seq_material_w));

		SELECT * FROM pls_consiste_mat_autor(	nr_seq_conta_p, nr_seq_conta_mat_w, nm_usuario_p, cd_estabelecimento_p, nr_seq_prest_exec_imp_ref_w, ie_liberar_item_autor_w, ie_existe_regra_w, nr_seq_regra_autor_w) INTO STRICT ie_liberar_item_autor_w, ie_existe_regra_w, nr_seq_regra_autor_w;
		
		if (ie_liberar_item_autor_w = 'S') then

			if (nr_seq_guia_w <> 0) then
				
				if (qt_utilizada_w = 0) then

					qt_utilizada_w := qt_solicitada_w;
				end if;

				/*So ira verificar se o material nao estiver glosado*/
		
				if	(qt_saldo_w < 0 AND qt_utilizada_w > 0) or (qt_autorizada_w = 0) then

					CALL pls_gravar_conta_glosa(	'2009',null,null,
								nr_seq_conta_mat_w, 'N', '[1] Quantidade de materiais utilizados excede a quantidade de materiais autorizados. '||
											'Autorizada: '||qt_autorizada_w||' Utilizada: '||qt_utilizada_w || '. Regra de autorizacao: ' || nr_seq_regra_autor_w,
								nm_usuario_p, 'A', 'DC',
								nr_seq_prest_exec_imp_ref_w, cd_estabelecimento_p, '',
								null);
		
				end if;		
			else
				if (coalesce(qt_solicitada_w,0) > 0) then

					CALL pls_gravar_conta_glosa('2009',null,null,
								nr_seq_conta_mat_w,'N','[2] Quantidade de materiais utilizados excede a quantidade de materiais autorizados. '||
								'Autorizada: 0 Utilizada: '||qt_solicitada_w || '. Regra de autorizacao: ' || nr_seq_regra_autor_w,
								nm_usuario_p,'A','DC',
								nr_seq_prest_exec_imp_ref_w, cd_estabelecimento_p, '', null);
			

				end if;
			end if;	
		end if;
        end if;

        if (ie_tipo_despesa_imp_w = '2') then
                CALL pls_tiss_consistir_medicamento(nr_seq_conta_mat_w, 'CM', 'IA',
                        null, null, '',
                        nm_usuario_p, cd_estabelecimento_p);
        end if;

	-- 9908 - Procedimento/material nao compativel com o tipo de atendimento da conta 
	if (coalesce(nr_seq_grupo_ans_w::text, '') = '') and (ie_gerar_grupo_ans_w = 'S') then

		CALL pls_gravar_conta_glosa(	'9908', null, null,
					nr_seq_conta_mat_w, 'N', 'Verificar as regras de materiais X Grupo ANS',
					nm_usuario_p, 'A', 'IA',
					nr_seq_prestador_p, cd_estabelecimento_p, null,
					null);
	end if;

        CALL pls_tiss_consistir_autorizacao(nr_seq_conta_mat_w, 'CM', 'IA',
                        nr_seq_prestador_p, null, '',
                        nm_usuario_p, cd_estabelecimento_p,null);

        CALL pls_gerar_campo_esp(null, nr_seq_conta_mat_w);


        <<final>>
        null;
        end;
end loop;
close C01;

ie_situacao_protocolo_p := ie_situacao_protocolo_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_conta_mat ( nr_seq_conta_p bigint, nr_seq_prestador_p bigint, nr_seq_segurado_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_situacao_protocolo_p INOUT text, cd_versao_tiss_p text, nr_seq_prestador_prot_p bigint) FROM PUBLIC;

