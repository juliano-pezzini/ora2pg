-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_grafico_pep_teste ( ds_imagem_p text, ds_titulo_p text, nr_atendimento_p bigint, nr_seq_grafico_p bigint, nm_usuario_p text, ds_imagem_blob_p bytea default null) AS $body$
DECLARE


v_amount	integer := 32767;
v_text_pos	integer := 1;
v_raww		bytea;
v_raw		bytea;
v_length	integer;


BEGIN

if (coalesce(ds_imagem_blob_p::text, '') = '') then

	insert into w_grafico_pep(
			ds_imagem,
			ds_titulo,
			nr_atendimento,
			nr_seq_grafico,
			dt_atualizacao,
			nm_usuario)
		values (	ds_imagem_p,
			ds_titulo_p,
			nr_atendimento_p,
			nr_seq_grafico_p,
			clock_timestamp(),
			nm_usuario_p);


else

	v_length	:= coalesce(octet_length(ds_imagem_blob_p),0);

	if (v_length > 0) and (v_length <= 32767) then
		loop
			begin
			DBMS_LOB.READ(ds_imagem_blob_p, v_amount, v_text_pos, v_raww);

			v_raw		:= utl_raw.concat(v_raw, v_raww);
			v_text_pos	:= v_text_pos + v_amount;

			EXCEPTION
			WHEN OTHERS THEN
				begin
				goto final;
				end;
			end;
		end loop;

	end if;

	<<final>>

	insert into w_grafico_pep(
			ds_imagem,
			ds_titulo,
			nr_atendimento,
			nr_seq_grafico,
			dt_atualizacao,
			nm_usuario,
			ds_imagem_blob)
		values (	ds_imagem_p,
			ds_titulo_p,
			nr_atendimento_p,
			nr_seq_grafico_p,
			clock_timestamp(),
			nm_usuario_p,
			v_raw);


end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_grafico_pep_teste ( ds_imagem_p text, ds_titulo_p text, nr_atendimento_p bigint, nr_seq_grafico_p bigint, nm_usuario_p text, ds_imagem_blob_p bytea default null) FROM PUBLIC;

