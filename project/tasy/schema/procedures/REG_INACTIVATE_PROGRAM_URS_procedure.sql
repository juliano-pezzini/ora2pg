-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reg_inactivate_program_urs ( nr_seq_requirement_p bigint, ds_reason_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_reg_program_w 	reg_program_urs.nr_seq_reg_program%type;
nr_customer_requirement_w 	reg_program_urs.nr_customer_requirement%type;

C01 CURSOR FOR
	SELECT 	b.nr_sequencia nr_seq_caso_teste
	from 	reg_program_urs a,
		reg_caso_teste b
	where 	a.nr_sequencia 	= nr_seq_requirement_p
	and 	b.nr_seq_customer 	= a.nr_customer_requirement;


C02 CURSOR FOR
	SELECT 	nr_sequencia
	from 	reg_program_prs 
	where 	nr_seq_reg_program = nr_seq_reg_program_w
	and	nr_seq_product_requirement in (
			SELECT 	nr_sequencia 
			from 	reg_product_requirement 
			where 	nr_customer_requirement = nr_customer_requirement_w
		);

BEGIN

	update	reg_program_urs
	set	ie_situacao 		= 'I', 
		ds_justificativa_inativacao 	= ds_reason_p, 
		nm_usuario 		= nm_usuario_p, 
		dt_atualizacao 		= clock_timestamp()
	where	nr_sequencia = nr_seq_requirement_p;

	commit;
	
	select 	max(nr_seq_reg_program),
		max(nr_customer_requirement)
	into STRICT 	nr_seq_reg_program_w,
		nr_customer_requirement_w
	from 	reg_program_urs
	where 	nr_sequencia = nr_seq_requirement_p;
	
	for C01_w in C01 loop
		CALL reg_inactivate_program_cts(
			nr_seq_reg_program_p	=> nr_seq_reg_program_w,
			nr_seq_caso_teste_p 	=> C01_w.nr_seq_caso_teste,
			ds_reason_p		=> ds_reason_p,
			ie_opcao_p 		=> 'URS',
			nm_usuario_p		=> nm_usuario_p
		);
	end loop;

	for C02_w in C02 loop
		CALL reg_inactivate_program_prs(C02_w.nr_sequencia, ds_reason_p, nm_usuario_p);
	end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reg_inactivate_program_urs ( nr_seq_requirement_p bigint, ds_reason_p text, nm_usuario_p text) FROM PUBLIC;

