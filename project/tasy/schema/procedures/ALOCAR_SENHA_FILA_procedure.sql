-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alocar_senha_fila ( nr_seq_fila_nova_p bigint, nr_seq_fila_atual_p bigint, cd_senha_p bigint, nr_seq_senha_p bigint, dt_hora_p timestamp, ds_erro_p INOUT text, ie_abort_erro_p text default null) AS $body$
DECLARE


nr_seq_fila_senha_w		bigint;
cd_estabelecimento_w		bigint;
dt_inicio_atend_w			timestamp;


BEGIN
cd_estabelecimento_w := obter_estabelecimento_ativo;

select    max(nr_sequencia)
into STRICT    nr_seq_fila_senha_w
from     paciente_senha_fila
where     cd_senha_gerada      = cd_senha_p
and     coalesce(nr_seq_fila_senha,nr_seq_fila_senha_origem)  = nr_seq_fila_atual_p
and     (nr_seq_senha_p <> 0 AND nr_sequencia  = nr_seq_senha_p)
and        ((((coalesce(dt_vinculacao_senha::text, '') = '') or ((dt_inicio_atendimento IS NOT NULL AND dt_inicio_atendimento::text <> '') and (dt_vinculacao_senha IS NOT NULL AND dt_vinculacao_senha::text <> '') and (coalesce(dt_fim_atendimento::text, '') = ''))) and (coalesce(pkg_i18n.get_user_locale, 'pt_BR') <> 'ja_JP')) or
        ((coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'ja_JP') and ((dt_vinculacao_senha IS NOT NULL AND dt_vinculacao_senha::text <> '') and (coalesce(dt_fim_atendimento::text, '') = ''))))
and     coalesce(dt_inutilizacao::text, '') = ''
and    cd_estabelecimento = cd_estabelecimento_w;

select	max(dt_inicio_atendimento)
into STRICT	dt_inicio_atend_w	
from	atendimentos_senha
where	nr_seq_pac_senha_fila = nr_seq_senha_p;
if (nr_seq_fila_senha_w > 0) and
	((coalesce(dt_inicio_atend_w::text, '') = '') or (dt_inicio_atend_w < dt_hora_p)) then
	update 	paciente_senha_fila
	set 	nr_seq_fila_senha  = nr_seq_fila_nova_p,
		dt_entrada_fila	= clock_timestamp() + interval '1 days'/86400,
		dt_inicio_atendimento  = NULL,
		dt_fim_atendimento  = NULL,
		dt_chamada   = NULL,
		ds_maquina_chamada   = NULL,
		nr_seq_local_senha   = NULL,		
		dt_primeira_chamada   = NULL,
		qt_chamadas   = NULL,
		nm_usuario_chamada  = NULL			
	where 	nr_sequencia   = nr_seq_fila_senha_w;	
elsif (nr_seq_fila_senha_w < 0) then
	ds_erro_p := WHEB_MENSAGEM_PCK.get_texto(279909,null);
elsif (dt_inicio_atend_w > dt_hora_p) then
	ds_erro_p := WHEB_MENSAGEM_PCK.get_texto(281348,null);
end if;

if (ie_abort_erro_p	= 'S') and (ds_erro_p IS NOT NULL AND ds_erro_p::text <> '') then
	CALL WHEB_MENSAGEM_PCK.EXIBIR_MENSAGEM_ABORT(ds_erro_p);
end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alocar_senha_fila ( nr_seq_fila_nova_p bigint, nr_seq_fila_atual_p bigint, cd_senha_p bigint, nr_seq_senha_p bigint, dt_hora_p timestamp, ds_erro_p INOUT text, ie_abort_erro_p text default null) FROM PUBLIC;

