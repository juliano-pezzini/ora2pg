-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_contas_baca ( dt_prescricao_inicio_p prescr_medica.dt_prescricao%TYPE, dt_prescricao_final_p prescr_medica.dt_prescricao%TYPE ) AS $body$
DECLARE

    nr_prescricao_w             prescr_procedimento.nr_prescricao%TYPE;
    nr_sequencia_w              prescr_procedimento.nr_sequencia%TYPE;
    ds_resultado_w              result_laboratorio.ds_resultado%TYPE;

    get_exames_no_periodo CURSOR FOR
    SELECT
        a.nr_sequencia,
        a.nr_prescricao
    FROM
        prescr_procedimento a
    INNER JOIN prescr_medica b ON a.nr_prescricao = b.nr_prescricao
    INNER JOIN result_laboratorio c ON a.nr_prescricao = c.nr_prescricao AND a.nr_sequencia = c.nr_seq_prescricao
    WHERE
        b.dt_prescricao BETWEEN dt_prescricao_inicio_p AND dt_prescricao_final_p AND
        a.ie_status_atend <> 40 AND
        (c.ds_resultado IS NOT NULL AND c.ds_resultado::text <> '');

BEGIN
    OPEN get_exames_no_periodo;
    LOOP
        FETCH get_exames_no_periodo INTO nr_sequencia_w,
            nr_prescricao_w;
        EXIT WHEN NOT FOUND; /* apply on get_exames_no_periodo */
        BEGIN
            CALL gravar_log_lab_pragma(24022, 'nr_prescricao_w='||nr_prescricao_w||' - nr_sequencia_w='||nr_sequencia_w, 'tasy', nr_prescricao_w);
            update prescr_procedimento set ie_status_atend = 40 where nr_prescricao = nr_prescricao_w AND nr_sequencia = nr_sequencia_w;
            commit;
        END;
    END LOOP;
    CLOSE get_exames_no_periodo;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_contas_baca ( dt_prescricao_inicio_p prescr_medica.dt_prescricao%TYPE, dt_prescricao_final_p prescr_medica.dt_prescricao%TYPE ) FROM PUBLIC;

