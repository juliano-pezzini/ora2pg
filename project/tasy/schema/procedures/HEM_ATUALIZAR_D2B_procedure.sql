-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hem_atualizar_d2b ( nr_seq_proc_p bigint, nm_usuario_p text, qt_d2b_p INOUT bigint) AS $body$
DECLARE


is_d2b_nulo_w	varchar(1);
qt_d2b_w	hem_proc.qt_d2b%type;
ie_primaria_w	hem_proc.ie_primaria%type;
dt_entrada_w	timestamp;
dt_insuflacao_ini_w	timestamp;


BEGIN
if (coalesce(nr_seq_proc_p,0) > 0) then

	-- verifica se a angioplastia é primária
	select	coalesce(ie_primaria,'N')
	into STRICT	ie_primaria_w
	from	hem_proc
	where	nr_sequencia = nr_seq_proc_p;

	if (ie_primaria_w = 'S') then

		-- verifica se a data de entrada e de início de insuflação não são nulas
		select	max(dt_entrada),
				max(dt_prim_insulf)
		into STRICT	dt_entrada_w,
				dt_insuflacao_ini_w
		from	hem_proc
		where	nr_sequencia		= nr_seq_proc_p;

		if	(dt_entrada_w IS NOT NULL AND dt_entrada_w::text <> '' AND dt_insuflacao_ini_w IS NOT NULL AND dt_insuflacao_ini_w::text <> '') then

			-- obtem a diferença em minutos entre a data de entrada do paciente e a data de início de insuflação do balão (Door-to-balloon Time)
			select	(substr(obter_dif_data(dt_entrada_w, dt_insuflacao_ini_w, 'TM'),1,15))::numeric
			into STRICT	qt_d2b_w
			;

			if (coalesce(qt_d2b_w,0) > 0) then

				-- Atualiza no HEM_PROC.QT_D2B
				update	hem_proc
				set		qt_d2b			= qt_d2b_w,
						dt_atualizacao	= clock_timestamp(),
						nm_usuario		= nm_usuario_p
				where	nr_sequencia	= nr_seq_proc_p;

			end if;
		end if;
	end if;
end if;
qt_d2b_p := qt_d2b_w;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hem_atualizar_d2b ( nr_seq_proc_p bigint, nm_usuario_p text, qt_d2b_p INOUT bigint) FROM PUBLIC;

