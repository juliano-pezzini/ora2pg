-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_dados_paciente_cons_vaga ( nr_atendimento_p bigint, cd_setor_atendimento_p bigint, cd_unidade_basica_p text, cd_unidade_compl_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ds_tipo_acomodacao_p INOUT text, nm_pessoa_fisica_p INOUT text, ds_setor_atendimento_p INOUT text, ds_leito_p INOUT text, ds_ramal_p INOUT text, qt_max_visitante_p INOUT bigint, qt_visita_acompanhante_p INOUT bigint) AS $body$
DECLARE

 
titulo_atend_setor_w	varchar(1);
ie_forma_tipo_acomod_w	varchar(1);
qt_max_visitante_w		bigint := 0;
qt_visita_acompanhante_w	bigint := 0;
cd_setor_atendimento_w	bigint;
cd_unidade_basica_w	varchar(10);
cd_unidade_compl_w	varchar(10);
ie_forma_titulo_atend_setor_w varchar(5);

BEGIN
 
if ((nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and 
	nr_atendimento_p <> 0) then 
	begin 
	-- Controle de Visitas - Parâmetro [53] - Permite visualizar o setor no título da entrada do paciente 
	titulo_atend_setor_w := obter_param_usuario(8014, 53, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, titulo_atend_setor_w);
	-- Controle de Visitas - Parâmetro [117] - Forma de considerar o tipo de acomodação 
	ie_forma_tipo_acomod_w := obter_param_usuario(8014, 117, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_forma_tipo_acomod_w);
	-- Controle de Visitas - Parâmetro [121] - Forma de exibição dos dados do setor no título da entrada do paciente 
	ie_forma_titulo_atend_setor_w := obter_param_usuario(8014, 121, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_forma_titulo_atend_setor_w);
 
	select	CASE WHEN ie_forma_tipo_acomod_w='A' THEN  substr(obter_tipo_acomod_atual(nr_atendimento_p, 'DTA'), 1,100)  ELSE substr(obter_tipo_acomod_atend(nr_atendimento_p, 'D'), 1,100) END , 
		substr(obter_pessoa_atendimento(nr_atendimento_p, 'N'), 1,100), 
		CASE WHEN titulo_atend_setor_w='S' THEN  substr(obter_nome_setor(obter_unidade_atendimento(nr_atendimento_p, ie_forma_titulo_atend_setor_w, 'CS')), 1,100)  ELSE '' END , 
		substr(obter_unidade_atendimento(nr_atendimento_p, ie_forma_titulo_atend_setor_w, 'U'),1,10), 
		SUBSTR(obter_unidade_atendimento(nr_atendimento_p, ie_forma_titulo_atend_setor_w, 'RA'),1,40) 
	into STRICT	ds_tipo_acomodacao_p, 
		nm_pessoa_fisica_p, 
		ds_setor_atendimento_p, 
		ds_leito_p, 
		ds_ramal_p 
	;
	end;
end if;
 
 
if (coalesce(cd_setor_atendimento_p,0) > 0) then 
	cd_setor_atendimento_w	:=	cd_setor_atendimento_p;
	cd_unidade_basica_w		:= 	cd_unidade_basica_p;
	cd_unidade_compl_w		:= 	cd_unidade_compl_p;
else	 
	select obter_setor_atendimento(nr_atendimento_p), 
			obter_unidade_atendimento(nr_atendimento_p, 'A', 'UB'), 
			obter_unidade_atendimento(nr_atendimento_p, 'A', 'UC') 
	into STRICT	cd_setor_atendimento_w, 
			cd_unidade_basica_w, 
			cd_unidade_compl_w 
	;
end if;
	 
	 
 
if (cd_setor_atendimento_w IS NOT NULL AND cd_setor_atendimento_w::text <> '') then 
	 
	select	qt_max_visitante 
	into STRICT	qt_max_visitante_w 
	from	unidade_atendimento 
	where	cd_setor_atendimento = cd_setor_atendimento_w 
	and		cd_unidade_basica = cd_unidade_basica_w 
	and		cd_unidade_compl = cd_unidade_compl_w;
	 
	select (qt_max_visitante + qt_max_acomp) 
	into STRICT	qt_visita_acompanhante_w 
	from 	unidade_atendimento 
	where 	cd_setor_atendimento = cd_setor_atendimento_w 
	and 	cd_unidade_basica = cd_unidade_basica_w 
	and 	cd_unidade_compl = cd_unidade_compl_w;
 
end if;	
 
qt_max_visitante_p		:= qt_max_visitante_w;
qt_visita_acompanhante_p	:= qt_visita_acompanhante_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_dados_paciente_cons_vaga ( nr_atendimento_p bigint, cd_setor_atendimento_p bigint, cd_unidade_basica_p text, cd_unidade_compl_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ds_tipo_acomodacao_p INOUT text, nm_pessoa_fisica_p INOUT text, ds_setor_atendimento_p INOUT text, ds_leito_p INOUT text, ds_ramal_p INOUT text, qt_max_visitante_p INOUT bigint, qt_visita_acompanhante_p INOUT bigint) FROM PUBLIC;

