-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicar_formulario_furtran ( nr_sequencia_p formulario_furtran.nr_sequencia%TYPE, ie_inativar_p text, ds_justificativa_p formulario_furtran.ds_justificativa%TYPE) AS $body$
DECLARE


TYPE fv_tbl IS TABLE OF furtran_vitima%ROWTYPE;

nr_sequencia_w formulario_furtran.nr_sequencia%TYPE;
ds_justificativa_w formulario_furtran.ds_justificativa%TYPE;
fv_tbl_w fv_tbl;

c01 CURSOR FOR
	SELECT
		nextval('furtran_vitima_seq') nr_sequencia,
		clock_timestamp() dt_atualizacao,
		obter_usuario_ativo nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_sequencia_w nr_seq_form_furtran,
		nr_seq_pessoa_vitima
	FROM
		furtran_vitima
	WHERE
		nr_seq_form_furtran = nr_sequencia_p;


BEGIN

SELECT
	nextval('formulario_furtran_seq')
INTO STRICT
	nr_sequencia_w
;

INSERT INTO
	formulario_furtran(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		dt_liberacao,
		dt_inativacao,
		nm_usuario_inativacao,
		ds_justificativa,
		ds_justificativa_alteracao,
		ie_situacao,
		dt_entrega,
		ie_glosa,
		nr_radicado,
		nr_radicado_ant,
		ds_transportador,
		cd_habilitacao_transp,
		cd_pessoa_fisica_transp,
		ie_tipo_servico,
		nr_seq_tipo_servico,
		ie_outro_servico,
		ds_servico,
		ds_placa_transp,
		ds_endereco_transp,
		nr_seq_endereco_transp,
		nr_seq_classif_acidente,
		nr_seq_tipo_acidente,
		ie_outro_acidente,
		ds_acidente,
		ds_endereco_local,
		nr_seq_endereco_local,
		dt_transferencia)
SELECT
		nr_sequencia_w,
		clock_timestamp(),
		obter_usuario_ativo,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		null,
		null,
		null,
		null,
		ds_justificativa_p,
		'A',
		dt_entrega,
		ie_glosa,
		nr_radicado,
		nr_radicado_ant,
		ds_transportador,
		cd_habilitacao_transp,
		cd_pessoa_fisica_transp,
		ie_tipo_servico,
		nr_seq_tipo_servico,
		ie_outro_servico,
		ds_servico,
		ds_placa_transp,
		ds_endereco_transp,
		nr_seq_endereco_transp,
		nr_seq_classif_acidente,
		nr_seq_tipo_acidente,
		ie_outro_acidente,
		ds_acidente,
		ds_endereco_local,
		nr_seq_endereco_local,
		dt_transferencia
FROM
	formulario_furtran
WHERE
	nr_sequencia = nr_sequencia_p;
	
OPEN c01;
LOOP
	FETCH c01 BULK COLLECT INTO fv_tbl_w;
	
	FORALL x IN fv_tbl_w.FIRST..fv_tbl_w.LAST
	INSERT INTO furtran_vitima VALUES fv_tbl_w(x);

	EXIT WHEN NOT FOUND; /* apply on c01 */
END LOOP;
CLOSE c01;

IF (ie_inativar_p = 'S') THEN
	SELECT
		max(ds_justificativa)
	INTO STRICT
		ds_justificativa_w
	FROM
		formulario_furtran
	WHERE
		nr_sequencia = nr_sequencia_p;

	CALL inativar_informacao('FORMULARIO_FURTRAN',
						'NR_SEQUENCIA',
						nr_sequencia_p,
						coalesce(ds_justificativa_w, ds_justificativa_p),
						obter_usuario_ativo);
END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_formulario_furtran ( nr_sequencia_p formulario_furtran.nr_sequencia%TYPE, ie_inativar_p text, ds_justificativa_p formulario_furtran.ds_justificativa%TYPE) FROM PUBLIC;

