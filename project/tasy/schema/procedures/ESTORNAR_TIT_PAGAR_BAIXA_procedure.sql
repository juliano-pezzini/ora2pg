-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE estornar_tit_pagar_baixa ( nr_titulo_p bigint, nr_seq_baixa_p bigint, dt_baixa_p timestamp, nm_usuario_p text, ie_commit_p text default 'S') AS $body$
DECLARE


nr_seq_baixa_w			integer;
cd_moeda_baixa_w		integer;
cd_moeda_titulo_w		integer;
vl_cotacao_moeda_w		double precision	:= null;
cd_estabelecimento_w		smallint;
ie_estorno_classif_w		varchar(1);
ie_estornar_baixa_w		varchar(1);
--ie_estornar_baixa_bordero_w	varchar2(1); Retirado conforme OS 1409873 e 1394506. Parâmetro inativado.
nr_lote_contabil_w		bigint;
nr_seq_movto_trans_fin_w	titulo_pagar_baixa.nr_seq_movto_trans_fin%type;
ie_conciliacao_w		movto_trans_financ.ie_conciliacao%type;
nr_seq_concil_w			movto_trans_financ.nr_seq_concil%type;
/* Projeto Multimoeda - Variáveis */

vl_baixa_estrang_w		double precision;
vl_cotacao_w			cotacao_moeda.vl_cotacao%type;
ie_baixa_estrang_w		varchar(1);
nr_bordero_w        		bigint;
nr_bordero_tit_w    		bigint;
qt_baixa_ops_w			integer;
ie_estornar_concil_w	varchar(1);



BEGIN

ie_estornar_baixa_w := obter_param_usuario(851, 202, obter_perfil_ativo, nm_usuario_p, 0, ie_estornar_baixa_w);
ie_estornar_concil_w := Obter_Param_Usuario(814, 100, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, obter_estabelecimento_ativo, ie_estornar_concil_w);

if (ie_estornar_baixa_w = 'N') then
	select 	nr_lote_contabil
	into STRICT	nr_lote_contabil_w
	from	titulo_pagar
	where	nr_titulo = nr_titulo_p;
	
	if (nr_lote_contabil_w IS NOT NULL AND nr_lote_contabil_w::text <> '') and (nr_lote_contabil_w <> 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(223502,'NR_LOTE_CONTABIL_W='||nr_lote_contabil_w);
	else
		select	nr_lote_contabil
		into STRICT	nr_lote_contabil_w
		from	titulo_pagar_baixa
		where	nr_sequencia = nr_seq_baixa_p
		and	nr_titulo = nr_titulo_p;
		
		if (nr_lote_contabil_w IS NOT NULL AND nr_lote_contabil_w::text <> '') and (nr_lote_contabil_w <> 0) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(223502,'NR_LOTE_CONTABIL_W='||nr_lote_contabil_w);
		end if;
	end if;
end if;

select	coalesce(max(nr_sequencia),0) + 1
into STRICT	nr_seq_baixa_w
from	titulo_pagar_baixa
where	nr_titulo = nr_titulo_p;

if (nr_seq_baixa_w IS NOT NULL AND nr_seq_baixa_w::text <> '') then

	select	b.cd_moeda,
		a.cd_moeda,
		b.cd_estabelecimento,
		a.nr_seq_movto_trans_fin,
		a.vl_baixa_estrang,
		a.vl_cotacao
	into STRICT	cd_moeda_titulo_w,
		cd_moeda_baixa_w,
		cd_estabelecimento_w,
		nr_seq_movto_trans_fin_w,
		vl_baixa_estrang_w,
		vl_cotacao_w
	from	titulo_pagar b,
		titulo_pagar_baixa a
	where	a.nr_titulo	= b.nr_titulo
	and	a.nr_titulo	= nr_titulo_p
	and	a.nr_sequencia	= nr_seq_baixa_p;

	/* francisco - os 168616 - 23/12/2009 - tratar para gravar a cotacao do dia, quando a moeda for diferente */

	if (cd_moeda_titulo_w <> cd_moeda_baixa_w) and (coalesce(vl_baixa_estrang_w,0) = 0 and coalesce(vl_cotacao_w,0) = 0) then
		vl_cotacao_moeda_w	:= obter_conversao_moeda(1,cd_moeda_titulo_w,dt_baixa_p,'EN');
	end if;
	/* Projeto Multimoeda - Verifica se a baixa é em moeda estrangeira para inverter os valores no estorno*/

	if (coalesce(vl_baixa_estrang_w,0) <> 0 and coalesce(vl_cotacao_w,0) <> 0) then
		ie_baixa_estrang_w := 'S';
	end if;
	
	if ( coalesce(nr_seq_movto_trans_fin_w,0) <> 0 ) then -- AAMFIRMO OS 667298 - Não permitir estornar baixas que movimentaram o banco e que já foram conciliados.
	
		select	max(a.ie_conciliacao),
			max(a.nr_seq_concil)
		into STRICT	ie_conciliacao_w,
			nr_seq_concil_w
		from	movto_trans_financ a
		where	a.nr_sequencia		= nr_seq_movto_trans_fin_w;
		
		if	(( coalesce(ie_conciliacao_w,'N') = 'S' ) or (nr_seq_concil_w IS NOT NULL AND nr_seq_concil_w::text <> '')) and (coalesce(ie_estornar_concil_w,'S') = 'N') then
			/* O lançamento a ser estornado já foi conciliado! Não é possível estorná-lo. */

			CALL wheb_mensagem_pck.exibir_mensagem_abort(238696);
		end if;
	
	end if;
end if;

CALL projeto_recurso_pck.consistir_tit_pag_rec_proj_rec(nr_titulo_p, 'P');

insert into titulo_pagar_baixa(nr_titulo,
	nr_sequencia,
	dt_baixa,
	cd_moeda,
	dt_atualizacao,
	nm_usuario,
	cd_tipo_baixa,
	ie_acao,
	vl_baixa,
	vl_descontos,
	vl_outras_deducoes,
	vl_juros,
	vl_multa,
	vl_outros_acrescimos,
	vl_pago,
	cd_banco,
	nr_lote_contabil,
	vl_devolucao,
	nr_seq_devolucao,
	/*nr_bordero, francisco - 29/04/2008 - tirei pois quando e estornado manualmente nao deve gravar */

	nr_seq_trans_fin,
	vl_ir,
	nr_seq_conta_banco,
	nr_seq_escrit,
	vl_moeda_orig,
	vl_imposto_munic,
	vl_inss,
	cd_conta_contabil,
	cd_centro_custo,
	vl_imposto,
	nr_seq_baixa_origem,
	vl_cotacao_moeda,
	nr_tit_receber,
	nr_seq_baixa_rec,
	vl_outras_despesas,
	nr_seq_lote_enc_contas,
	vl_glosa,
	vl_glosa_ato_coop_aux,
	vl_glosa_ato_coop_princ,
	vl_glosa_ato_nao_coop,
	nr_seq_pls_lote_camara,
	vl_baixa_estrang,
	vl_complemento,
	vl_cotacao,
	vl_cambial_passivo,
	vl_cambial_ativo,
	cd_cgc_destino,
	cd_banco_destino,       
	cd_agencia_destino,     
	nr_conta_destino,       
	cd_pessoa_fisica_dest,  
	ie_digito_conta_dest,   
	ie_digito_agencia_dest,
	nr_seq_cheque_cp)
SELECT	nr_titulo,
	nr_seq_baixa_w,
	coalesce(dt_baixa_p,dt_baixa),
	cd_moeda,
	clock_timestamp(),
	nm_usuario_p,
	cd_tipo_baixa,
	ie_acao,
	(vl_baixa * -1),
	(vl_descontos * -1),
	(vl_outras_deducoes * -1),
	(vl_juros * -1),
	(vl_multa * -1),
	(vl_outros_acrescimos * -1),
	(vl_pago * -1),
	cd_banco,
	0,
	(vl_devolucao * -1),
	nr_seq_devolucao,
	/*nr_bordero, - 29/04/2008 - tirei pois quando e estornado manualmente nao deve gravar */

	nr_seq_trans_fin,
	(vl_ir * -1),
	nr_seq_conta_banco,
	nr_seq_escrit,
	(vl_moeda_orig * -1),
	(vl_imposto_munic * -1),
	(vl_inss * -1),
	cd_conta_contabil,
	cd_centro_custo,
	(vl_imposto * -1),
	nr_seq_baixa_p,
	vl_cotacao_moeda_w,
	nr_tit_receber,
	nr_seq_baixa_rec,
	(vl_outras_despesas * -1),
	nr_seq_lote_enc_contas,
	vl_glosa * -1,
	vl_glosa_ato_coop_aux * -1,
	vl_glosa_ato_coop_princ * -1,
	vl_glosa_ato_nao_coop * -1,
	nr_seq_pls_lote_camara,
	CASE WHEN ie_baixa_estrang_w='S' THEN vl_baixa_estrang * -1  ELSE null END ,
	CASE WHEN ie_baixa_estrang_w='S' THEN vl_complemento * -1  ELSE null END ,
	CASE WHEN ie_baixa_estrang_w='S' THEN vl_cotacao  ELSE null END ,
	(coalesce(vl_cambial_passivo,0) * -1),
	(coalesce(vl_cambial_ativo,0) * -1),
	cd_cgc_destino,         
	cd_banco_destino,       
	cd_agencia_destino,     
	nr_conta_destino,       
	cd_pessoa_fisica_dest,  
	ie_digito_conta_dest,   
	ie_digito_agencia_dest,
	nr_seq_cheque_cp
from	titulo_pagar_baixa
where	nr_titulo	= nr_titulo_p
and	nr_sequencia	= nr_seq_baixa_p;

insert into titulo_pagar_imposto(nr_sequencia,
	nr_titulo,
	cd_tributo,
	ie_pago_prev,
	dt_atualizacao,
	nm_usuario,
	dt_imposto,
	vl_base_calculo,
	vl_imposto,
	ds_emp_retencao,
	pr_imposto,
	cd_beneficiario,
	cd_conta_financ,
	nr_seq_trans_reg,
	nr_seq_trans_baixa,
	cd_cond_pagto,
	vl_nao_retido,
	ie_vencimento,
	vl_base_nao_retido,
	vl_trib_adic,
	vl_base_adic,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	vl_reducao,
	vl_desc_base,
	cd_darf,
	cd_variacao,
	ie_periodicidade,
	nr_seq_baixa)
SELECT	nextval('titulo_pagar_imposto_seq'),
	nr_titulo,
	cd_tributo,
	ie_pago_prev,
	clock_timestamp(),
	nm_usuario_p,
	dt_imposto,
	vl_base_calculo * -1,
	vl_imposto * -1,
	ds_emp_retencao,
	pr_imposto,
	cd_beneficiario,
	cd_conta_financ,
	nr_seq_trans_reg,
	nr_seq_trans_baixa,
	cd_cond_pagto,
	vl_nao_retido * -1,
	ie_vencimento,
	vl_base_nao_retido * -1,
	vl_trib_adic * -1,
	vl_base_adic * -1,
	clock_timestamp(),
	nm_usuario_p,
	vl_reducao * -1,
	vl_desc_base * -1,
	cd_darf,
	cd_variacao,
	ie_periodicidade,
	nr_seq_baixa_w
from	titulo_pagar_imposto
where	nr_titulo	= nr_titulo_p
and	nr_seq_baixa	= nr_seq_baixa_p;

select	count(1)
into STRICT	qt_baixa_ops_w
from	titulo_pagar_baixa_ops
where	nr_titulo	= nr_titulo_p
and	nr_seq_baixa 	= nr_seq_baixa_p  LIMIT 1;

if (qt_baixa_ops_w > 0) then
	insert into titulo_pagar_baixa_ops(nr_sequencia,
		nr_titulo,
		nr_seq_baixa,
		cd_conta_contabil,
		ie_debito_credito,
		cd_historico,
		nr_lote_contabil,
		vl_movimento,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ie_origem)
	(SELECT	nextval('titulo_pagar_baixa_ops_seq'),
		nr_titulo_p,
		nr_seq_baixa_w,
		cd_conta_contabil,
		ie_debito_credito,
		cd_historico,
		0,
		vl_movimento * -1,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		ie_origem
	from	titulo_pagar_baixa_ops
	where	nr_titulo	= nr_titulo_p
	and	nr_seq_baixa	= nr_seq_baixa_p);
end if;

/* Retirado conforme OS 1409873 e 1394506. Parâmetro inativado.
obter_param_usuario(851,255, obter_perfil_ativo, nm_usuario_p, 0, ie_estornar_baixa_bordero_w);

if (nvl(ie_estornar_baixa_bordero_w,'S') = 'S') then
	select max(nr_bordero)
	into   nr_bordero_w
	from   titulo_pagar
	where nr_titulo = nr_titulo_p;

	select max(nr_bordero)
	into  nr_bordero_tit_w
	from  bordero_tit_pagar
	where nr_titulo = nr_titulo_p;

	if (nr_bordero_w is not null or nr_bordero_tit_w is not null) then

		update bordero_pagamento
		set dt_real_pagamento = null
		where nr_bordero = nvl(nr_bordero_w,nr_bordero_tit_w);
	   
	end if;
end if;
*/
CALL ratear_baixa_tit_pagar_nc(nr_titulo_p,nr_seq_baixa_w,nm_usuario_p);

CALL cancelar_tit_pagar_imposto(nr_titulo_p, nr_seq_baixa_p, nm_usuario_p);

CALL atualizar_saldo_tit_pagar(nr_titulo_p, nm_usuario_p);
CALL gerar_w_tit_pag_imposto(nr_titulo_p, nm_usuario_p);

-- francisco - os 43353 25/10/06
CALL gerar_movto_tit_baixa(	nr_titulo_p,
			nr_seq_baixa_w,
			'P',
			nm_usuario_p,'N');
			
CALL gerar_alerta_baixa_tit_pagar(nr_titulo_p,nr_seq_baixa_w,cd_estabelecimento_w,nm_usuario_p);

/*AAMFIRMO OS 549019 26/02/2013*/

ie_estorno_classif_w := Obter_Param_Usuario(851, 198, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_estorno_classif_w);
if ( coalesce(ie_estorno_classif_w,'N') = 'S' ) then
	CALL GERAR_TITULO_PAGAR_BAIXA_CC(nr_titulo_p,
				    nr_seq_baixa_w,
				    'N',
				    nm_usuario_p);
end if;

if (coalesce(ie_commit_p,'S') = 'S') then	
	commit;
end if;	

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE estornar_tit_pagar_baixa ( nr_titulo_p bigint, nr_seq_baixa_p bigint, dt_baixa_p timestamp, nm_usuario_p text, ie_commit_p text default 'S') FROM PUBLIC;

