-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_prescricao_nutricao ( nr_prescricao_p bigint, nr_seq_serv_rep_p bigint, nr_seq_serv_dia_p bigint, ie_tipo_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_serv_rep_w				bigint;
ie_prescr_oral_w				varchar(1);
ie_prescr_jejum_w				varchar(1);
ie_prescr_compl_w				varchar(1);
ie_prescr_enteral_w				varchar(1);
ie_prescr_npt_adulta_w			varchar(1);
ie_prescr_npt_neo_w			varchar(1);
ie_prescr_npt_ped_w			varchar(1);
ie_status_Adep_w			varchar(30);
nr_seq_def_rep_w			varchar(30);
/*
ie_tipo_p :
T - Todas
DO - Dieta oral
JE - Jejum
SO - Suplemento
NE - Enteral
NA - NPT Adulto
NN - NPT Neonatal
NP - NPT Pediatrica
LD - Leites e derivados
*/
BEGIN
if (nr_seq_Serv_rep_p <> 0) then

	nr_seq_serv_rep_w := nr_seq_Serv_rep_p;

	if (ie_tipo_p = 'T') then

		delete	FROM nut_atend_serv_dia_rep
		where	nr_sequencia = nr_seq_serv_rep_w
                and     nr_prescricao_p in (NR_PRESCR_ENTERAL, NR_PRESCR_ORAL, NR_PRESCR_NPT_ADULTA, NR_PRESCR_NPT_NEO, NR_PRESCR_NPT_PED, NR_PRESCR_COMPL, NR_PRESCR_JEJUM,NR_PRESCR_LEITE_DERIV);

	else

		update 	nut_atend_serv_dia_rep
		set 	nr_prescr_oral = CASE WHEN ie_tipo_p='DO' THEN null  ELSE nr_prescr_oral END ,
				nr_prescr_jejum = CASE WHEN ie_tipo_p='JE' THEN null  ELSE nr_prescr_jejum END ,
				nr_prescr_compl = CASE WHEN ie_tipo_p='SO' THEN null  ELSE nr_prescr_compl END ,
				nr_prescr_enteral = CASE WHEN ie_tipo_p='NE' THEN null  ELSE nr_prescr_enteral END ,
				nr_prescr_npt_adulta = CASE WHEN ie_tipo_p='NA' THEN null  ELSE nr_prescr_npt_adulta END ,
				nr_prescr_npt_neo = CASE WHEN ie_tipo_p='NN' THEN null  ELSE nr_prescr_npt_neo END ,
				nr_prescr_npt_ped = CASE WHEN ie_tipo_p='NP' THEN null  ELSE nr_prescr_npt_ped END ,
				NR_PRESCR_LEITE_DERIV = CASE WHEN ie_tipo_p='LD' THEN null  ELSE NR_PRESCR_LEITE_DERIV END ,
			nm_usuario = nm_usuario_p,
		    dt_atualizacao = clock_timestamp()
		where	nr_sequencia = nr_seq_serv_rep_w;

	end if;
	
	delete from  nut_pac_opcao_rec where  nr_seq_servico_dia = nr_seq_serv_dia_p;

/*Log ao desfazer o registro:*/

	select	    nextval('nut_definicao_prescr_log_seq')
	into STRICT		nr_seq_def_rep_w
	;

	insert into nut_definicao_prescr_log(  NR_SEQUENCIA,
                                        DT_ATUALIZACAO,
                                        NM_USUARIO,
                                        DT_ATUALIZACAO_NREC,
                                        NM_USUARIO_NREC,
                                        IE_DEFINIR,
                                        NR_PRESCRICAO,
                                        IE_TIPO_DEFINICAO)
                                values ( nr_seq_def_rep_w,
                                        clock_timestamp(),
                                        nm_usuario_p,
                                        clock_timestamp(),
                                        NM_USUARIO_p,
                                        'Z',
                                        nr_prescricao_p,
                                        ie_tipo_p);

	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_prescricao_nutricao ( nr_prescricao_p bigint, nr_seq_serv_rep_p bigint, nr_seq_serv_dia_p bigint, ie_tipo_p text, nm_usuario_p text) FROM PUBLIC;

