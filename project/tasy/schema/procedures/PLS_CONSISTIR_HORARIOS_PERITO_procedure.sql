-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consistir_horarios_perito ( nr_seq_perito_p bigint, dt_horario_analise_p timestamp, ie_horario_valido_p INOUT text) AS $body$
DECLARE


ie_dia_semana_w		varchar(10);
hr_inicial_w		timestamp;
hr_final_w		timestamp;
ie_dia_semana_perito_w	bigint;
ie_horario_valido_w	varchar(10);
dt_inicio_w		timestamp;
dt_fim_w		timestamp;


BEGIN

ie_horario_valido_w	:= 'N';

ie_dia_semana_w	:= obter_cod_dia_semana(dt_horario_analise_p);

dt_inicio_w	:= null;
dt_fim_w	:= null;

select	hr_inicial,
	hr_final,
	ie_dia_semana
into STRICT	hr_inicial_w,
	hr_final_w,
	ie_dia_semana_perito_w
from	pls_analise_perito
where	nr_sequencia	= nr_seq_perito_p;

if (hr_inicial_w IS NOT NULL AND hr_inicial_w::text <> '') then
	dt_inicio_w	:=	to_date(to_char(dt_horario_analise_p,'dd/mm/yyyy')||' ' || to_char(hr_inicial_w,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
end if;

if (hr_final_w IS NOT NULL AND hr_final_w::text <> '') then
	dt_fim_w	:=	to_date(to_char(dt_horario_analise_p,'dd/mm/yyyy')||' ' || to_char(hr_final_w,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
end if;

/*Consistir o dia da semana*/

if	((ie_dia_semana_perito_w IS NOT NULL AND ie_dia_semana_perito_w::text <> '') and
		((ie_dia_semana_perito_w = ie_dia_semana_w) or (ie_dia_semana_perito_w	= 9 and  ie_dia_semana_w not in (1,7))) or (coalesce(ie_dia_semana_perito_w::text, '') = '')) then
	/*Consistir o horário inicial*/

	if	(((dt_inicio_w IS NOT NULL AND dt_inicio_w::text <> '') and to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss') <= to_char(dt_horario_analise_p,'dd/mm/yyyy hh24:mi:ss')) or (coalesce(dt_inicio_w::text, '') = '')) then
		/*Consistir o horário final*/

		if	(((dt_fim_w IS NOT NULL AND dt_fim_w::text <> '') and to_char(dt_fim_w,'dd/mm/yyyy hh24:mi:ss') >= to_char(dt_horario_analise_p,'dd/mm/yyyy hh24:mi:ss')) or (coalesce(dt_fim_w::text, '') = '')) then
			ie_horario_valido_w	:= 'S';
		end if;
	end if;
end if;
ie_horario_valido_p	:= ie_horario_valido_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consistir_horarios_perito ( nr_seq_perito_p bigint, dt_horario_analise_p timestamp, ie_horario_valido_p INOUT text) FROM PUBLIC;

