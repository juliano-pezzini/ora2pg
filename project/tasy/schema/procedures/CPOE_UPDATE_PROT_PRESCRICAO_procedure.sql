-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_update_prot_prescricao ( nr_prescricao_p bigint, itens_liberar_p text) AS $body$
DECLARE
	

nr_seq_reg_item_w			bigint;
nr_seq_rep_w				bigint;	
ie_opcao_prescr_w			varchar(255);
ie_opcao_prescr_ww			varchar(4000);
item_w						varchar(255);
cd_protocolo_w				cpoe_material.cd_protocolo%type;
nr_seq_protocolo_w			cpoe_material.nr_seq_protocolo%type;
nr_atendimento_w			prescr_medica.nr_atendimento%type;
nr_seq_interno_w PROTOCOLO_MEDICACAO.nr_seq_interna%type := 0;
cd_pessoa_fisica_w pessoa_fisica.cd_pessoa_fisica%type := 0;


BEGIN

if (itens_liberar_p IS NOT NULL AND itens_liberar_p::text <> '') then
	ie_opcao_prescr_ww := itens_liberar_p;

	for i in 1..length(ie_opcao_prescr_ww) loop

		if (length(ie_opcao_prescr_ww) > 1) then
			-- R,12;M,12345;D,1233;M,2312;
			item_w := substr(ie_opcao_prescr_ww, 1, position(';' in ie_opcao_prescr_ww) - 1);
			ie_opcao_prescr_w := substr(item_w, 1, position(',' in item_w) - 1);		
			nr_seq_reg_item_w := (substr(item_w, position(',' in item_w) + 1, length(item_w)))::numeric;
			ie_opcao_prescr_ww := substr(ie_opcao_prescr_ww, position(';' in ie_opcao_prescr_ww) + 1, length(ie_opcao_prescr_ww));
			
			if (ie_opcao_prescr_w = 'DI') or (ie_opcao_prescr_w = 'DP') then
				ie_opcao_prescr_w := 'D';
			end if;
			
			nr_seq_rep_w := 0;
			
			if ((ie_opcao_prescr_w IS NOT NULL AND ie_opcao_prescr_w::text <> '') and (ie_opcao_prescr_w not in ('D','AP'))) then
					if (ie_opcao_prescr_w = 'R') then
						select	max(cd_protocolo),
								max(nr_seq_protocolo)
						into STRICT	cd_protocolo_w,
								nr_seq_protocolo_w
						from	cpoe_recomendacao
						where 	nr_sequencia = nr_seq_reg_item_w
						and		ie_forma_geracao = 'P';
					elsif ( ie_opcao_prescr_w = 'N') then
						select	max(cd_protocolo),
								max(nr_seq_protocolo)
						into STRICT	cd_protocolo_w,
								nr_seq_protocolo_w
						from	cpoe_dieta
						where 	nr_sequencia = nr_seq_reg_item_w
						and		ie_forma_geracao = 'P';
					elsif ( ie_opcao_prescr_w in ('M', 'MA')) then
						select	max(cd_protocolo),
								max(nr_seq_protocolo)
						into STRICT	cd_protocolo_w,
								nr_seq_protocolo_w
						from	cpoe_material
						where 	nr_sequencia = nr_seq_reg_item_w
						and		ie_forma_geracao = 'P';
					elsif ( ie_opcao_prescr_w = 'P') then
						select	max(cd_protocolo),
								max(nr_seq_protocolo)
						into STRICT	cd_protocolo_w,
								nr_seq_protocolo_w
						from	cpoe_procedimento
						where 	nr_sequencia = nr_seq_reg_item_w
						and		ie_forma_geracao = 'P';
					elsif ( ie_opcao_prescr_w = 'G') then			
						select	max(cd_protocolo),
								max(nr_seq_protocolo)
						into STRICT	cd_protocolo_w,
								nr_seq_protocolo_w
						from	cpoe_gasoterapia
						where 	nr_sequencia = nr_seq_reg_item_w
						and		ie_forma_geracao = 'P';
					elsif ( ie_opcao_prescr_w = 'H') then
						select	max(cd_protocolo),
								max(nr_seq_protocolo)
						into STRICT	cd_protocolo_w,
								nr_seq_protocolo_w
						from	cpoe_hemoterapia
						where 	nr_sequencia = nr_seq_reg_item_w
						and		ie_forma_geracao = 'P';
					end if;
			end if;
		
		if (cd_protocolo_w IS NOT NULL AND cd_protocolo_w::text <> '' AND nr_seq_protocolo_w IS NOT NULL AND nr_seq_protocolo_w::text <> '') then
			update	prescr_medica
			set		cd_protocolo = cd_protocolo_w,
					nr_seq_protocolo = nr_seq_protocolo_w
			where	nr_prescricao = nr_prescricao_p;
			
			commit;

			ie_opcao_prescr_ww := '';

      if (cd_protocolo_w != 0 and nr_seq_protocolo_w != 0) then
        select  coalesce(max(NR_SEQ_INTERNA), 0)
        into STRICT  nr_seq_interno_w
        from  PROTOCOLO_MEDICACAO
        where cd_protocolo = cd_protocolo_w
          and nr_sequencia = nr_seq_protocolo_w;
      end if;
      select coalesce(max(cd_pessoa_fisica), 0)
      into STRICT cd_pessoa_fisica_w
      from prescr_medica
      where nr_prescricao = nr_prescricao_p;
      if (cd_pessoa_fisica_w != 0) then
        CALL ATUALIZAR_EV_LINHA_CUIDADO('CP', 'PRESCR_MEDICA', nr_prescricao_p,
          'cd_protocolo_w='||cd_protocolo_w||';nr_seq_protocolo_w='||nr_seq_interno_w||';', cd_pessoa_fisica_w, wheb_usuario_pck.get_nm_usuario);
      end if;
		end if;
		
		end if;
	end loop;
end if;
exception when others then
	if (coalesce(nr_prescricao_p,0) > 0) then
		select	max(nr_atendimento)
		into STRICT	nr_atendimento_w
		from	prescr_medica
		where	nr_prescricao = nr_prescricao_p;
	end if;

	CALL gravar_log_cpoe(substr('CPOE_UPDATE_PROT_PRESCRICAO EXCEPTION:' || substr(to_char(sqlerrm),1,2000)
		   ||'//nr_prescricao_p: '|| nr_prescricao_p
		   ||'itens_liberar_p : '|| itens_liberar_p,1,2000),
			nr_atendimento_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_update_prot_prescricao ( nr_prescricao_p bigint, itens_liberar_p text) FROM PUBLIC;

