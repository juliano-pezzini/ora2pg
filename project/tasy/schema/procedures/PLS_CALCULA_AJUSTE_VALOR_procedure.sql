-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_calcula_ajuste_valor ( qt_liberada_p pls_conta_proc.qt_procedimento%type, vl_unitario_p pls_conta_proc.vl_unitario%type, vl_liberado_p pls_conta_proc.vl_liberado%type, vl_liberado_co_p pls_conta_proc.vl_liberado_co%type, vl_liberado_hi_p pls_conta_proc.vl_liberado_hi%type, vl_liberado_material_p pls_conta_proc.vl_liberado_material%type, vl_lib_taxa_co_p pls_conta_proc.vl_lib_taxa_co%type, vl_lib_taxa_material_p pls_conta_proc.vl_lib_taxa_material%type, vl_lib_taxa_servico_p pls_conta_proc.vl_lib_taxa_servico%type, tx_intercambio_imp_p pls_conta_proc.tx_intercambio_imp%type, nr_seq_item_p pls_conta_proc.nr_sequencia%type, ie_tipo_item_p text, ie_opcao_p text, ie_intercambio_p text, nm_usuario_p text, vl_unitario_out_p INOUT pls_conta_proc.vl_unitario%type, vl_liberado_out_p INOUT pls_conta_proc.vl_liberado%type, vl_liberado_co_out_p INOUT pls_conta_proc.vl_liberado_co%type, vl_liberado_hi_out_p INOUT pls_conta_proc.vl_liberado_hi%type, vl_liberado_material_out_p INOUT pls_conta_proc.vl_liberado_material%type, vl_lib_taxa_co_out_p INOUT pls_conta_proc.vl_lib_taxa_co%type, vl_lib_taxa_material_out_p INOUT pls_conta_proc.vl_lib_taxa_material%type, vl_lib_taxa_servico_out_p INOUT pls_conta_proc.vl_lib_taxa_servico%type) AS $body$
DECLARE

 
/*ie_opcao_p 
1 - Saída quantidade 
2 - Saída valor liberado 
3 - Saída Valores liberados proc 
4 - Saída valores liberados Co 
5 - Saída valores liberados mat 
6 - Saída valores taxa hi 
7 - Saída valores taxa Co 
8 - Saída valores taxa mat 
 
ie_tipo_item_p 
 
P - Procedimento 
M - Material*/
 
 
qt_liberada_w				pls_conta_proc.qt_procedimento%type		:= 0;
qt_apresentada_w			pls_conta_proc.qt_procedimento%type		:= 0;
vl_unitario_w				pls_conta_proc.vl_unitario%type			:= 0;
vl_unitario_item_w			pls_conta_proc.vl_unitario%type			:= 0;
vl_liberado_w				pls_conta_proc.vl_liberado%type			:= 0;
vl_liberado_co_w   			pls_conta_proc.vl_liberado_co%type		:= 0;
vl_liberado_hi_w    		pls_conta_proc.vl_liberado_hi%type		:= 0;
vl_liberado_material_w			pls_conta_proc.vl_liberado_material%type	:= 0;
vl_menor_co_w   			pls_conta_proc.vl_liberado_co%type		:= 0;
vl_menor_hi_w	    		pls_conta_proc.vl_liberado_hi%type		:= 0;
vl_menor_material_w			pls_conta_proc.vl_liberado_material%type	:= 0;
vl_lib_taxa_co_w   			pls_conta_proc.vl_lib_taxa_co%type		:= 0;
vl_lib_taxa_material_w			pls_conta_proc.vl_lib_taxa_material%type	:= 0;
vl_lib_taxa_servico_w  		pls_conta_proc.vl_lib_taxa_servico%type		:= 0;
vl_material_ptu_imp_w			pls_conta_proc.vl_material_ptu_imp%type		:= 0;
vl_procedimento_ptu_imp_w		pls_conta_proc.vl_procedimento_ptu_imp%type	:= 0;
vl_co_ptu_imp_w				pls_conta_proc.vl_co_ptu_imp%type		:= 0;
vl_liberado_co_item_w 			pls_conta_proc.vl_liberado_co%type		:= 0;
vl_liberado_hi_item_w    		pls_conta_proc.vl_liberado_hi%type		:= 0;
vl_liberado_material_item_w		pls_conta_proc.vl_liberado_material%type	:= 0;
vl_taxa_co_w       		pls_conta_proc.vl_taxa_co%type			:= 0;
vl_taxa_co_imp_w     		pls_conta_proc.vl_taxa_co_imp%type		:= 0;
vl_taxa_material_w    		pls_conta_proc.vl_taxa_material%type		:= 0;
vl_taxa_material_imp_w   		pls_conta_proc.vl_taxa_material_imp%type	:= 0;
vl_taxa_servico_w     		pls_conta_proc.vl_taxa_servico%type		:= 0;
vl_taxa_servico_imp_w   		pls_conta_proc.vl_taxa_servico_imp%type		:= 0;
qt_liberada_item_w			pls_conta_mat_v.qt_material%type		:= 0;
vl_liberado_item_w			pls_conta_mat_v.vl_liberado%type		:= 0;

BEGIN
 
qt_liberada_w		:= coalesce(qt_liberada_p,0);
vl_unitario_w		:= coalesce(vl_unitario_p,0);
vl_liberado_w		:= coalesce(vl_liberado_p,0);
vl_lib_taxa_co_w   	:= coalesce(vl_lib_taxa_co_p,0);
vl_lib_taxa_material_w	:= coalesce(vl_lib_taxa_material_p,0);
vl_lib_taxa_servico_w  := coalesce(vl_lib_taxa_servico_p,0);
vl_liberado_material_w	:= coalesce(vl_liberado_material_p,0);
vl_liberado_co_w   	:= coalesce(vl_liberado_co_p,0);
vl_liberado_hi_w    := coalesce(vl_liberado_hi_p,0);
 
if (ie_tipo_item_p	= 'P') then 
	select	qt_procedimento_imp, 
		vl_liberado_hi, 
		vl_liberado_material, 
		vl_liberado_co, 
		obter_valor_menor(a.vl_co_ptu_imp, a.vl_calc_co_util) vl_menor_co, 
		obter_valor_menor(a.vl_procedimento_ptu_imp, a.vl_calc_hi_util) vl_menor_hi, 
		obter_valor_menor(a.vl_material_ptu_imp, a.vl_calc_mat_util) vl_menor_mat, 
		vl_unitario, 
		vl_material_ptu_imp, 
		vl_procedimento_ptu_imp, 
		vl_co_ptu_imp, 
		vl_taxa_co, 
		vl_taxa_co_imp, 
		vl_taxa_material, 
		vl_taxa_material_imp, 
		vl_taxa_servico, 
		vl_taxa_servico_imp 
	into STRICT	qt_apresentada_w,  
		vl_liberado_hi_item_w, 
		vl_liberado_material_item_w, 
		vl_liberado_co_item_w, 
		vl_menor_co_w, 
		vl_menor_hi_w, 
		vl_menor_material_w, 
		vl_unitario_item_w, 
		vl_material_ptu_imp_w, 
		vl_procedimento_ptu_imp_w, 
		vl_co_ptu_imp_w, 
		vl_taxa_co_w, 
		vl_taxa_co_imp_w, 
		vl_taxa_material_w, 
		vl_taxa_material_imp_w, 
		vl_taxa_servico_w, 
		vl_taxa_servico_imp_w 
	from	pls_conta_proc_v	a 
	where	nr_sequencia	= nr_seq_item_p;
	 
	if (qt_liberada_w	> qt_apresentada_w) then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(256822);
	end if;
	/*Calculo quando da saída do campo quantidade*/
 
	if (ie_opcao_p	= '1') then 
		 
		vl_liberado_material_w	:= vl_liberado_material_item_w;
		vl_liberado_co_w   	:= vl_liberado_co_item_w;
		vl_liberado_hi_w    := vl_liberado_hi_item_w;
		 
		if (qt_liberada_w	= 0) then 
			vl_unitario_w	:= 0;
		end if;
		vl_liberado_w	:= vl_unitario_w * qt_liberada_w;
		if (ie_intercambio_p	= 'S') then 
			vl_unitario_w	:= vl_unitario_item_w;
			vl_liberado_w	:= vl_unitario_item_w * qt_liberada_w;
			 
			if (vl_liberado_hi_w = 0) then 
				vl_liberado_hi_w	:= vl_menor_hi_w;
			end if;
			 
			if (vl_liberado_material_w = 0) then 
				vl_liberado_material_w	:= vl_menor_material_w;
			end if;
			 
			if (vl_liberado_co_w = 0) then 
				vl_liberado_co_w	:= vl_menor_co_w;
			end if;
			 
			vl_lib_taxa_co_w   	:= dividir_sem_round((vl_liberado_co_w * tx_intercambio_imp_p),qt_liberada_w) * qt_liberada_w;
			vl_lib_taxa_material_w	:= dividir_sem_round((vl_liberado_material_w * tx_intercambio_imp_p),qt_liberada_w) * qt_liberada_w;
			vl_lib_taxa_servico_w  := dividir_sem_round((vl_liberado_hi_w * tx_intercambio_imp_p),qt_liberada_w) * qt_liberada_w;
		end if;
		if (qt_liberada_w	= 0) then 
			vl_unitario_w	:= 0;
		end if;
	/*Calculo quando da saída do campo valor total liberado */
 
	elsif (ie_opcao_p	= '2') then 
		vl_unitario_w	:= dividir_sem_round(vl_liberado_w,qt_liberada_w);
	elsif (ie_opcao_p	= '3') then 
		if (vl_liberado_hi_p > vl_procedimento_ptu_imp_w) then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(256926);
		end if;
		vl_lib_taxa_servico_w  := dividir_sem_round(dividir_sem_round((vl_liberado_hi_w * tx_intercambio_imp_p)::numeric,100),qt_liberada_w) * qt_liberada_w;
	elsif (ie_opcao_p	= '4') then 
		if (vl_liberado_co_p > vl_co_ptu_imp_w) then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(256929);
		end if;
		vl_lib_taxa_co_w   	:= dividir_sem_round(dividir_sem_round((vl_liberado_co_w * tx_intercambio_imp_p)::numeric,100),qt_liberada_w) * qt_liberada_w;
	elsif (ie_opcao_p	= '5') then 
		 
		if (vl_liberado_material_p > vl_material_ptu_imp_w) then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(256927);
		end if;
		vl_lib_taxa_material_w	:= dividir_sem_round(dividir_sem_round((vl_liberado_material_w * tx_intercambio_imp_p)::numeric,100),qt_liberada_w) * qt_liberada_w;
	elsif (ie_opcao_p	= '6') then 
		if (vl_lib_taxa_servico_w > vl_taxa_servico_w) and (vl_lib_taxa_servico_w > vl_taxa_servico_imp_w) then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(256941);
		end if;
		 
		if (vl_lib_taxa_servico_w < 0) then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(256950);
		end if;		
	elsif (ie_opcao_p	= '7') then 
		if (vl_lib_taxa_co_w > vl_taxa_co_w) and (vl_lib_taxa_co_w > vl_taxa_co_imp_w) then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(256942);
		end if;
		 
		if (vl_lib_taxa_co_w < 0) then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(256950);
		end if;
	elsif (ie_opcao_p	= '8') then 
		if (vl_lib_taxa_material_w > vl_taxa_material_w) and (vl_lib_taxa_material_w > vl_taxa_material_imp_w) then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(256945);
		end if;
		 
		if (vl_lib_taxa_material_w < 0) then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(256950);
		end if;
	end if;	
	 
	if (ie_opcao_p	in ('3','4','5','6','7','8','9')) then 
		 
		vl_liberado_w	:= 	vl_lib_taxa_servico_w + vl_lib_taxa_co_w + vl_lib_taxa_material_w + 
					vl_liberado_hi_w + vl_liberado_co_w + vl_liberado_material_w;
		if (qt_liberada_w	= 0 ) and (vl_liberado_w	> 0) then 
			vl_liberado_w	:= 0;
		end if;
	end if;
elsif (ie_tipo_item_p	= 'M') then 
	select	qt_material_imp, 
		qt_material, 
		vl_liberado 
	into STRICT	qt_apresentada_w, 
		qt_liberada_item_w, 
		vl_liberado_item_w 
	from	pls_conta_mat_v	a 
	where	nr_sequencia	= nr_seq_item_p;
	 
	if (qt_liberada_w	> qt_apresentada_w) then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(256822);
	end if;
	/*Calculo quando da saída do campo quantidade*/
 
	if (ie_opcao_p	= '1') then 
 
		if (qt_liberada_w	= 0) then 
			vl_unitario_w	:= 0;
		end if;
		vl_liberado_w	:= vl_unitario_w * qt_liberada_w;
		if (ie_intercambio_p	= 'S') then		 
			vl_lib_taxa_material_w	:= dividir_sem_round((vl_liberado_w * tx_intercambio_imp_p),qt_liberada_w) * qt_liberada_w;
			vl_liberado_material_w	:= vl_liberado_w -vl_lib_taxa_material_w;
		end if;
	/*Calculo quando da saída do campo valor total liberado */
 
	elsif (ie_opcao_p	= '2') then 
		vl_unitario_w	:= dividir_sem_round(vl_liberado_w,qt_liberada_w);
		if (ie_intercambio_p	= 'S') then		 
			vl_lib_taxa_material_w	:= dividir_sem_round((vl_liberado_w * tx_intercambio_imp_p),qt_liberada_w) * qt_liberada_w;
			vl_liberado_material_w	:= vl_liberado_w -vl_lib_taxa_material_w;
		end if;
	elsif (ie_opcao_p	= '5') then 
 
		if (vl_liberado_material_p < 0) then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(256950);
		end if;
		vl_lib_taxa_material_w	:= dividir_sem_round(dividir_sem_round((vl_liberado_material_w * tx_intercambio_imp_p)::numeric,100),qt_liberada_w) * qt_liberada_w;
		vl_liberado_w	:= vl_lib_taxa_material_w + vl_liberado_material_w;
		 
		 
	elsif (ie_opcao_p	= '8') then 
		if (vl_lib_taxa_material_w > vl_taxa_material_w) and (vl_lib_taxa_material_w > vl_taxa_material_imp_w) then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(256945);
		end if;
		 
		if (vl_lib_taxa_material_w < 0) then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(256950);
		end if;
		vl_liberado_w	:= dividir_sem_round(vl_lib_taxa_material_w,tx_intercambio_imp_p) * 100;
		vl_liberado_material_w	:= vl_liberado_w - vl_lib_taxa_material_w;
		 
	end if;
end if;
 
if (vl_liberado_w < 0) then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(256950);
end if;
 
vl_unitario_out_p		:= coalesce(vl_unitario_w,0);
vl_liberado_out_p		:= coalesce(vl_liberado_w,0);
vl_liberado_co_out_p   	:= coalesce(vl_liberado_co_w,0);
vl_liberado_hi_out_p    	:= coalesce(vl_liberado_hi_w,0);
vl_liberado_material_out_p	:= coalesce(vl_liberado_material_w,0);
vl_lib_taxa_co_out_p   	:= coalesce(vl_lib_taxa_co_w,0);
vl_lib_taxa_material_out_p	:= coalesce(vl_lib_taxa_material_w,0);
vl_lib_taxa_servico_out_p  	:= coalesce(vl_lib_taxa_servico_w,0);
					 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_calcula_ajuste_valor ( qt_liberada_p pls_conta_proc.qt_procedimento%type, vl_unitario_p pls_conta_proc.vl_unitario%type, vl_liberado_p pls_conta_proc.vl_liberado%type, vl_liberado_co_p pls_conta_proc.vl_liberado_co%type, vl_liberado_hi_p pls_conta_proc.vl_liberado_hi%type, vl_liberado_material_p pls_conta_proc.vl_liberado_material%type, vl_lib_taxa_co_p pls_conta_proc.vl_lib_taxa_co%type, vl_lib_taxa_material_p pls_conta_proc.vl_lib_taxa_material%type, vl_lib_taxa_servico_p pls_conta_proc.vl_lib_taxa_servico%type, tx_intercambio_imp_p pls_conta_proc.tx_intercambio_imp%type, nr_seq_item_p pls_conta_proc.nr_sequencia%type, ie_tipo_item_p text, ie_opcao_p text, ie_intercambio_p text, nm_usuario_p text, vl_unitario_out_p INOUT pls_conta_proc.vl_unitario%type, vl_liberado_out_p INOUT pls_conta_proc.vl_liberado%type, vl_liberado_co_out_p INOUT pls_conta_proc.vl_liberado_co%type, vl_liberado_hi_out_p INOUT pls_conta_proc.vl_liberado_hi%type, vl_liberado_material_out_p INOUT pls_conta_proc.vl_liberado_material%type, vl_lib_taxa_co_out_p INOUT pls_conta_proc.vl_lib_taxa_co%type, vl_lib_taxa_material_out_p INOUT pls_conta_proc.vl_lib_taxa_material%type, vl_lib_taxa_servico_out_p INOUT pls_conta_proc.vl_lib_taxa_servico%type) FROM PUBLIC;

