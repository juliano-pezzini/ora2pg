-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pcs_gerar_log_substituicao_mat ( nm_tabela_p text, nm_atributo_p text, ds_valor_ant_p text, ds_valor_novo_p text, ds_operacao_p bigint, nr_sequencia_p bigint, nr_seq_regra_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
ds_alteracao_w		varchar(255);
ie_situacao_ant_w	varchar(10);
ie_situacao_novo_w	varchar(10);
ds_material_ant_w	varchar(255);
ds_material_novo_w	varchar(255);
ds_acao_w			varchar(10);
ds_material_w		varchar(255);
nr_prioridade_w		bigint;


BEGIN

/*operacao
1 = Alterado
2 = Incluído
3 = Excluído
*/
ds_alteracao_w	:= null;
ds_acao_w		:= null;

if (ds_operacao_p = 1) then
	begin
	if (nm_atributo_p = 'IE_SITUACAO' ) then
		begin
		--select	decode(NVL(ds_valor_ant_p,'A'),'A','Ativo','I','Inativo'),
		--	decode(nvl(ds_valor_novo_p,'A'),'A','Ativo','I','Inativo')
		select	CASE WHEN coalesce(ds_valor_ant_p,'A')='A' THEN wheb_mensagem_pck.get_texto(310207) WHEN coalesce(ds_valor_ant_p,'A')='I' THEN wheb_mensagem_pck.get_texto(310208) END ,
			CASE WHEN coalesce(ds_valor_novo_p,'A')='A' THEN wheb_mensagem_pck.get_texto(310207) WHEN coalesce(ds_valor_novo_p,'A')='I' THEN wheb_mensagem_pck.get_texto(310208) END
		into STRICT	ie_situacao_ant_w,
			ie_situacao_novo_w
		;

		if (nm_tabela_p = 'PCS_MATERIAL_SUBSTITUTO') then
			select	substr(to_char(a.cd_material) || ' - ' || b.ds_material,1,255)
			into STRICT	ds_material_w
			from	pcs_material_substituto a,
				material b
			where	a.cd_material = b.cd_material
			and	(a.cd_material IS NOT NULL AND a.cd_material::text <> '')
			and	a.nr_sequencia = nr_sequencia_p;
		elsif (nm_tabela_p = 'PCS_SUBSTITUICAO_MATERIAL') then
			select	substr(to_char(a.cd_material) || ' - ' || b.ds_material,1,255)
			into STRICT	ds_material_w
			from	pcs_substituicao_material a,
				material b
			where	a.cd_material = b.cd_material
			and	(a.cd_material IS NOT NULL AND a.cd_material::text <> '')
			and	a.nr_sequencia = nr_seq_regra_p;
		end if;

		--ds_alteracao_w := 'Alterada a situação do material ' || ds_material_w ||  ' de ' || ie_situacao_ant_w || ' para ' || ie_situacao_novo_w || ' . Tabela ' || nm_tabela_p;
		ds_alteracao_w := wheb_mensagem_pck.get_texto(310209, 	'DS_MATERIAL=' || ds_material_w ||  ';' ||
									'IE_SITUACAO_ANT=' || ie_situacao_ant_w || ';' ||
									'IE_SITUACAO_NOVO=' || ie_situacao_novo_w || ';' ||
									'NM_TABELA=' || nm_tabela_p);

		end;
	elsif (nm_atributo_p = 'CD_MATERIAL' ) then

		select	substr(ds_valor_ant_p || ' - ' || obter_desc_material(ds_valor_ant_p),1,255),
			substr(ds_valor_novo_p || ' - ' || obter_desc_material(ds_valor_novo_p),1,255)
		into STRICT	ds_material_ant_w,
			ds_material_novo_w
		;

		--ds_alteracao_w := substr('Alterado o material de ' || ds_material_ant_w || ' para ' || ds_material_novo_w || ' na tabela ' || nm_tabela_p,1,255);
		ds_alteracao_w := wheb_mensagem_pck.get_texto(310210, 	'DS_MATERIAL_ANT=' || ds_material_ant_w ||  ';' ||
									'DS_MATERIAL_NOVO=' || ds_material_novo_w || ';' ||
									'NM_TABELA=' || nm_tabela_p);

	elsif (nm_atributo_p = 'NR_PRIORIDADE' ) then

		select	substr(to_char(a.cd_material) || ' - ' || b.ds_material,1,255)
		into STRICT	ds_material_w
		from	pcs_material_substituto a,
				material b
		where	a.cd_material = b.cd_material
		and		a.nr_sequencia = nr_sequencia_p;

		--ds_alteracao_w := 'Alterada a prioridade do material ' || ds_material_w || ' de ' || ds_valor_ant_p || ' para ' || ds_valor_novo_p || ' . Tabela ' || nm_tabela_p;
		ds_alteracao_w := wheb_mensagem_pck.get_texto(310211, 	'DS_MATERIAL=' || ds_material_w ||  ';' ||
									'DS_VALOR_ANT=' || ds_valor_ant_p || ';' ||
									'DS_VALOR_NOVO=' || ds_valor_novo_p || ';' ||
									'NM_TABELA=' || nm_tabela_p);
	end if;
	end;
end if;

if (ds_operacao_p = 2) then
	begin
		if (nm_tabela_p = 'PCS_MATERIAL_SUBSTITUTO') then
			select	substr(to_char(a.cd_material) || ' - ' || b.ds_material,1,255),
				coalesce(nr_prioridade,0)
			into STRICT	ds_material_w,
				nr_prioridade_w
			from	pcs_material_substituto a,
				material b
			where	a.cd_material = b.cd_material
			and	(a.cd_material IS NOT NULL AND a.cd_material::text <> '')
			and	a.nr_sequencia = nr_sequencia_p
			and	a.nr_seq_regra = nr_seq_regra_p;
		elsif (nm_tabela_p = 'PCS_SUBSTITUICAO_MATERIAL') then
			select	substr(to_char(a.cd_material) || ' - ' || b.ds_material,1,255)
			into STRICT	ds_material_w
			from	pcs_substituicao_material a,
				material b
			where	a.cd_material = b.cd_material
			and	(a.cd_material IS NOT NULL AND a.cd_material::text <> '')
			and	a.nr_sequencia = nr_seq_regra_p;
		end if;

		--ds_alteracao_w := 'Incluído o material ' || ds_material_w || ' com prioridade ' || to_char(nr_prioridade_w) ||  '. Tabela ' || nm_tabela_p;
		ds_alteracao_w := wheb_mensagem_pck.get_texto(310212, 	'DS_MATERIAL=' || ds_material_w ||  ';' ||
									'NR_PRIORIDADE=' ||  to_char(nr_prioridade_w) || ';' ||
									'NM_TABELA=' || nm_tabela_p);
	end;
end if;

if (ds_operacao_p = 3) then
	begin
		if (nm_tabela_p = 'PCS_MATERIAL_SUBSTITUTO') then

			select	substr(to_char(a.cd_material) || ' - ' || b.ds_material,1,255)
			into STRICT	ds_material_w
			from	pcs_material_substituto a,
				material b
			where	a.cd_material = b.cd_material
			and	(a.cd_material IS NOT NULL AND a.cd_material::text <> '')
			and	a.nr_sequencia = nr_sequencia_p
			and	a.nr_seq_regra = nr_seq_regra_p;
		end if;

		--ds_alteracao_w := substr('Excluído o material ' || ds_material_w || '. Tabela ' || nm_tabela_p,1,255);
		ds_alteracao_w := wheb_mensagem_pck.get_texto(310213, 	'DS_MATERIAL=' || ds_material_w ||  ';' ||
									'NM_TABELA=' || nm_tabela_p);
	end;
end if;

if (ds_alteracao_w IS NOT NULL AND ds_alteracao_w::text <> '') then
	begin
	select	nextval('pcs_log_substituicao_mat_seq')
	into STRICT	nr_sequencia_w
	;

	insert into pcs_log_substituicao_mat(	nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_seq_regra,
						ds_alteracao )
			values (		nr_sequencia_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_regra_p,
						substr(ds_alteracao_w,1,255));

	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pcs_gerar_log_substituicao_mat ( nm_tabela_p text, nm_atributo_p text, ds_valor_ant_p text, ds_valor_novo_p text, ds_operacao_p bigint, nr_sequencia_p bigint, nr_seq_regra_p bigint, nm_usuario_p text) FROM PUBLIC;

