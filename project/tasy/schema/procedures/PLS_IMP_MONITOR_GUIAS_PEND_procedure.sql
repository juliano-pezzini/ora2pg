-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_imp_monitor_guias_pend ( nr_seq_lote_p INOUT pls_lot_monit_tiss_confer.nr_sequencia%type, ds_conteudo_p text, nm_arquivo_p text, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE



ds_conteudo_w			text;
ds_valor_w				varchar(255);
index_w					integer;
nr_seq_lote_w			pls_lot_monit_tiss_confer.nr_sequencia%type;
nr_seq_lote_arquivo_w	pls_lot_monit_tiss_confer.nr_sequencia%type;
cd_operadora_ans_w 		pls_monit_tiss_cta_pen.cd_operadora_ans%type;
cd_cpf_cgc_prest_exec_w pls_monit_tiss_cta_pen.cd_cpf_cgc_prest_exec%type;
cd_guia_prestador_w 	pls_monit_tiss_cta_pen.cd_guia_prestador%type;
cd_guia_operadora_w 	pls_monit_tiss_cta_pen.cd_guia_operadora%type;
cd_reembolso_w 			pls_monit_tiss_cta_pen.cd_reembolso%type;
cd_cnes_prest_w			pls_monit_tiss_cta_pen.cd_cnes_prest_exec%type;




BEGIN

--Essa rotina é chamada múltiplas vezes via aplicação, na primeira, estará passando nr_seq_lote_p null e então verificará
-- Verificado ainda nessa primeira etapa, se já foi importado arquivo com esse nome.
if (coalesce(nr_seq_lote_p::text, '') = '') then

	if (coalesce(nr_seq_lote_w::text, '') = '') then

		-- verifica  se há algum que tenha mesmo nome do arquivo que está sendo importado,
		--barrando a importação e exibindo mensagem  em caso afirmativo. Essa rotina é chamada para cada linha do arquivo à partir de
		--loop no Delphi e então essa verificação somente deve ororrer quando não está passando o nr_seq_lote_p pois quer dizer que é a primeira
		--iteração, se passar pela primeira iteração significa que o arquivo ainda não foi importado com esse nome, então deve permitir a iteração
		-- sobre as demais linhas do arquivo.
		select	max(nr_sequencia)
		into STRICT 	nr_seq_lote_arquivo_w
		from	pls_lot_monit_cta_pe
		where	nm_arquivo = nm_arquivo_p;

		if (nr_seq_lote_arquivo_w IS NOT NULL AND nr_seq_lote_arquivo_w::text <> '') then
			--wheb_mensagem_pck.exibir_mensagem_abort(1029520);
			nr_seq_lote_p := -1;
		else
			insert	into	pls_lot_monit_cta_pe(	nr_sequencia, dt_atualizacao, dt_atualizacao_nrec,
						nm_usuario, nm_usuario_nrec, nm_arquivo)
			values (	nextval('pls_lot_monit_cta_pe_seq'), clock_timestamp(), clock_timestamp(),
						nm_usuario_p, nm_usuario_p, nm_arquivo_p)
			returning nr_sequencia into nr_seq_lote_w;
		end if;

	end if;
else
	nr_seq_lote_w := nr_seq_lote_p;
end if;


if ( coalesce(nr_seq_lote_p,0) != -1) then
	ds_conteudo_w := ds_conteudo_p;
	index_w := 0;

	while(ds_conteudo_w IS NOT NULL AND ds_conteudo_w::text <> '') loop

		if (position(',' in ds_conteudo_w) = 0) then
			ds_valor_w	:= ds_conteudo_w;
			ds_conteudo_w	:= null;
		else
			ds_valor_w := substr(ds_conteudo_w, 1, position(',' in ds_conteudo_w) -1);
			ds_conteudo_w := substr(ds_conteudo_w,position(',' in ds_conteudo_w) + 1,length(ds_conteudo_w));
		end if;

		index_w := index_w + 1;

		--CNES Prestador, CNPJ/CPF Prestador, Guia Prestador, Guia Operadora, Reembolso
		if (index_w = 1) then
			cd_operadora_ans_w := ds_valor_w;
		elsif (index_w = 2) then
			cd_cnes_prest_w := ds_valor_w;
		elsif (index_w = 3) then
			cd_cpf_cgc_prest_exec_w := ds_valor_w;
		elsif (index_w = 4) then
			cd_guia_prestador_w := ds_valor_w;
		elsif (index_w = 5) then
			cd_guia_operadora_w := ds_valor_w;
		elsif (index_w = 6) then
			cd_reembolso_w := ds_valor_w;
		end if;

	end loop;

	insert	into	pls_monit_tiss_cta_pen(	cd_cnes_prest_exec, cd_cpf_cgc_prest_exec, cd_guia_operadora,
		    cd_guia_prestador, cd_operadora_ans, cd_reembolso,
		    dt_atualizacao, dt_atualizacao_nrec, nm_usuario,
		    nm_usuario_nrec, nr_seq_lote, nr_sequencia
		)
	values (cd_cnes_prest_w, cd_cpf_cgc_prest_exec_w, cd_guia_operadora_w,
			cd_guia_prestador_w, cd_operadora_ans_w, cd_reembolso_w,
			clock_timestamp(), clock_timestamp(), nm_usuario_p,
			nm_usuario_p, nr_seq_lote_w, nextval('pls_monit_tiss_cta_pen_seq'));

	nr_seq_lote_p := nr_seq_lote_w;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_imp_monitor_guias_pend ( nr_seq_lote_p INOUT pls_lot_monit_tiss_confer.nr_sequencia%type, ds_conteudo_p text, nm_arquivo_p text, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

