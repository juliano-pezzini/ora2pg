-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_verificar_proc_req_web ( nr_seq_requisicao_p pls_requisicao.nr_sequencia%type, cd_proc_mat_p bigint, ie_tipo_p text, ie_origem_proc_p bigint, dt_prevista_p pls_lote_anexo_proc_aut.dt_prev_realizacao%type, ie_tipo_anexo_p pls_requisicao_proc.ie_tipo_anexo%type, nr_sequencia_p INOUT bigint, qt_proc_mat_p INOUT bigint) AS $body$
DECLARE


/*
	ie_tipo_p
	P - Procedimentos
	M- Materiais
*/
nr_seq_proc_mat_w	pls_requisicao_proc.nr_sequencia%type;
qt_proc_mat_w		pls_requisicao_proc.qt_procedimento%type;
ie_tipo_anexo_w		pls_requisicao_proc.ie_tipo_anexo%type;
qt_anexo_w		integer;
ds_ret_regra_w		varchar(10);


BEGIN

--Procedimento
if (ie_tipo_p = 'P') then

	begin
		select	nr_sequencia,
			qt_solicitado,
			ie_tipo_anexo
		into STRICT	nr_seq_proc_mat_w,
			qt_proc_mat_w,
			ie_tipo_anexo_w
		from    pls_requisicao_proc
		where	nr_seq_requisicao 	= nr_seq_requisicao_p
		and	cd_procedimento 	= cd_proc_mat_p
		and	ie_origem_proced	= ie_origem_proc_p  LIMIT 1;
	exception
	when others then
		nr_seq_proc_mat_w := null;
		qt_proc_mat_w	  := null;
		ie_tipo_anexo_w	  := null;
	end;
else
--Material
	begin
		select	nr_sequencia,
			qt_solicitado,
			ie_tipo_anexo
		into STRICT	nr_seq_proc_mat_w,
			qt_proc_mat_w,
			ie_tipo_anexo_w
		from    pls_requisicao_mat
		where	nr_seq_requisicao 	= nr_seq_requisicao_p
		and	nr_seq_material 	= cd_proc_mat_p  LIMIT 1;
	exception
	when others then
		nr_seq_proc_mat_w := null;
		qt_proc_mat_w	  := null;
		ie_tipo_anexo_w	  := null;
	end;
end if;

--Tratamento utilizado para verificar se a Data Prevista do item que esta sendo inserido é diferente  da Data Prevista do item já existente na base
--Se for diferente permite e inclusão de item duplicado na Requisição
if (nr_seq_proc_mat_w IS NOT NULL AND nr_seq_proc_mat_w::text <> '' AND ie_tipo_anexo_w IS NOT NULL AND ie_tipo_anexo_w::text <> '') then

	--Radioterapia
	if ( ie_tipo_anexo_w = 'RA' ) then

		select	count(1)
		into STRICT	qt_anexo_w
		from	pls_lote_anexo_proc_aut
		where	dt_prev_realizacao 	= dt_prevista_p
		and	nr_seq_req_proc 	= nr_seq_proc_mat_w;

	--Quimioterapia
	elsif ( ie_tipo_anexo_w = 'QU' ) then

		select	count(1)
		into STRICT	qt_anexo_w
		from	pls_lote_anexo_mat_aut
		where	dt_prevista 		= dt_prevista_p
		and	nr_seq_req_mat 		= nr_seq_proc_mat_w;
	end if;

	--Se não existir nenhum anexo com a mesma data prevista será, criado um novo item na requisição
	if ( qt_anexo_w = 0 ) then
		nr_seq_proc_mat_w 	:= null;
		qt_proc_mat_w 		:= null;
	end if;
end if;

--  caso seja um pro/mat genérico, deve ser criado um novo item  OS 786774
if (nr_seq_proc_mat_w IS NOT NULL AND nr_seq_proc_mat_w::text <> '') then
	if (ie_tipo_p = 'M') then
		ds_ret_regra_w := pls_obter_se_item_regra_ptu(null,null,cd_proc_mat_p);
	else
		ds_ret_regra_w := pls_obter_se_item_regra_ptu(cd_proc_mat_p,ie_origem_proc_p,null);
	end if;

	if (ds_ret_regra_w = 'S') then
		nr_seq_proc_mat_w 	:= null;
		qt_proc_mat_w 		:= null;
	end if;
end if;


nr_sequencia_p := nr_seq_proc_mat_w;

if (coalesce(qt_proc_mat_w::text, '') = '') then
	qt_proc_mat_w := 0;
end if;

qt_proc_mat_p  := qt_proc_mat_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_verificar_proc_req_web ( nr_seq_requisicao_p pls_requisicao.nr_sequencia%type, cd_proc_mat_p bigint, ie_tipo_p text, ie_origem_proc_p bigint, dt_prevista_p pls_lote_anexo_proc_aut.dt_prev_realizacao%type, ie_tipo_anexo_p pls_requisicao_proc.ie_tipo_anexo%type, nr_sequencia_p INOUT bigint, qt_proc_mat_p INOUT bigint) FROM PUBLIC;

