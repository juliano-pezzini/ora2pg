-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_inserir_exame_proc_rotina ( nr_atendimento_p bigint, nr_seq_rotina_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_setor_atendimento_p bigint, ie_tipo_atendimento_p bigint, cd_convenio_p bigint, ie_tipo_convenio_p bigint, dt_base_proc_p timestamp, cd_paciente_p text, qt_idade_dia_p bigint, qt_idade_mes_p bigint, qt_idade_ano_p bigint, qt_peso_p bigint, cd_prescritor_p text, cd_setor_usuario_p bigint, cd_medico_p text, cd_medico_exec_p text, cd_especialidade_p bigint, nr_seq_rotina_esp_p bigint, nr_seq_proc_interno_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_exame_p bigint, cd_setor_exclusivo_p bigint, cd_material_exame_p text, ds_material_especial_p text, cd_intervalo_p text, ds_obs_adic_p text, ds_justificativa_p text, qt_procedimento_p bigint, ie_agora_p char, ie_acm_p char, ie_se_necessario_p char, ie_lado_p text, qt_hora_intervalo_p bigint, qt_min_intervalo_p bigint, ie_gerar_associado_p char, ie_horario_prescr_p char, nr_seq_item_gerado_p INOUT bigint, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, ie_oncologia_p text default 'N', nr_seq_conclusao_apae_p bigint default null, hr_prim_hor_setor_p text default null, ds_indicacao_clinica_p text default null, nr_seq_condicao_p bigint default null, ie_duracao_p text default null, nr_seq_contraste_p bigint default null, nr_seq_material_exame_p text default null, ie_futuro_p text default 'N', ie_dia_seguinte_p text default 'N', ie_amostra_p text default null, nr_seq_proc_rotina_p bigint default null, lst_cd_kit_material_p text default null, cd_microorganismo_p bigint default null, nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) AS $body$
DECLARE


cd_procedimento_w      procedimento.cd_procedimento%type;
ie_origem_proced_w      procedimento.ie_origem_proced%type;
ie_disp_resp_esp_w		procedimento_rotina.ie_disp_resp_esp%type;

qt_procedimento_w      prescr_procedimento.qt_procedimento%type;
ds_observacao_w        prescr_procedimento.ds_observacao%type;

cd_material_exame_w      material_exame_lab.cd_material_exame%type;

cd_setor_exclusivo_w    setor_atendimento.cd_setor_atendimento%type;

cd_intervalo_w        intervalo_prescricao.cd_intervalo%type;
cd_intervalo_agora_w    intervalo_prescricao.cd_intervalo%type;
qt_min_intervalo_w      intervalo_prescricao.qt_min_intervalo%type;
ie_dose_unica_cpoe_w    intervalo_prescricao.ie_dose_unica_cpoe%type;

cd_pessoa_coleta_w      pessoa_fisica.cd_pessoa_fisica%type;
cd_medico_exec_w      pessoa_fisica.cd_pessoa_fisica%type;
cd_setor_entrega_w      cpoe_procedimento.cd_setor_entrega%type;

nr_seq_prot_glic_w      pep_protocolo_glicemia.nr_sequencia%type;

ie_excluir_proc_princ_w    proc_interno.ie_excluir_proc_princ%type;
ie_tipo_proc_interno_w    proc_interno.ie_tipo%type;
ie_ctrl_glic_w        proc_interno.ie_ctrl_glic%type;
ds_obs_aux_w        proc_interno.ds_observacao%type;
ie_copiar_rep_w        proc_interno.ie_copiar_rep%type;
nr_seq_exame_lab_w      proc_interno.nr_seq_exame_lab%type;

nr_sequencia_w        cpoe_procedimento.nr_sequencia%type;
ie_duracao_w        cpoe_procedimento.ie_duracao%type;
dt_fim_w          cpoe_procedimento.dt_fim%type;
hr_prim_horario_w	cpoe_procedimento.hr_prim_horario%type;

ds_observacao_contraste_w proc_interno_contraste.ds_observacao%type;

ie_regra_intervalo_out_w    prescr_proc_quant.ie_lado%type;
ie_regra_lado_out_w         prescr_proc_quant.ie_lado%type;
qt_procedimento_out_w       prescr_proc_quant.qt_procedimento%type;
ie_permite_edicao_out_w     prescr_proc_quant.ie_permite_edicao%type;

nr_ocorrencia_w        double precision;
nr_doc_convenio_w      bigint;
ie_recalcular_hor_w      char(1):='N';
ie_guia_w          varchar(20);
hr_prev_execucao_w      varchar(5);
ie_interv_agora_w      char(1);
ie_agora_w          char(1);
ie_agora_exame_w char(1);
ie_acm_w          char(1);
ie_se_necessario_w      char(1);
ie_acm_sn_w          char(1);
ie_urgencia_w        char(1);
ie_permite_w        char(2);
qt_hora_intervalo_w      bigint;
ds_horarios_w        varchar(4000);
ds_horarios_aux_w      varchar(2000);
ds_mat_adic_proc_w      varchar(14);
dt_prescricao_w        timestamp;
dt_prev_execucao_w      timestamp;
dt_validade_prescr_w    timestamp;
dt_coleta_w          timestamp;
ie_admin_proc_w        char(1);
qt_dias_adicionar_w      bigint := 0;
qt_peca_ap_w        bigint;
dt_primeiro_horario_w    timestamp;
ie_operacao_w        intervalo_prescricao.ie_operacao%type;
ie_prescr_alta_agora_w    varchar(1);
ie_param8_cpoe_w      varchar(1);
ie_exibe_w      intervalo_prescricao.CD_INTERVALO%type;

ie_dia_seguinte_w varchar(1);
ie_obter_dados_exames_lab_rep		varchar(20);
ie_param734_cpoe_w	varchar(1);

c_itens_kits CURSOR FOR
    SELECT nr_registro from table(lista_pck.obter_lista(lst_cd_kit_material_p,','));

BEGIN

ie_param8_cpoe_w := obter_param_usuario(2314, 8, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_param8_cpoe_w);
ie_prescr_alta_agora_w := obter_param_usuario(924, 409, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_prescr_alta_agora_w);
ie_param734_cpoe_w := obter_param_usuario(924, 734, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_param734_cpoe_w);

ie_dia_seguinte_w := ie_dia_seguinte_p;

if (coalesce(nr_seq_proc_interno_p::text, '') = '') then
  return;
end if;

cd_procedimento_w    := cd_procedimento_p;
ie_origem_proced_w    := ie_origem_proced_p;
dt_prev_execucao_w    := dt_base_proc_p;
qt_procedimento_w    := coalesce(qt_procedimento_p,1);
cd_intervalo_w      := cd_intervalo_p;
cd_material_exame_w    := cd_material_exame_p;
ie_agora_w        := ie_agora_p;
ie_acm_w        := ie_acm_p;
ie_se_necessario_w    := ie_se_necessario_p;

dt_prescricao_w      := clock_timestamp();

if ((nr_seq_exame_p IS NOT NULL AND nr_seq_exame_p::text <> '') and coalesce(ie_agora_w, 'N') = 'S') then
  select  coalesce(ie_agora, 'N')
  into STRICT  ie_agora_exame_w
  from  exame_laboratorio
  where  nr_seq_exame = nr_seq_exame_p;

  if (ie_agora_exame_w = 'N') then
    ie_agora_w := 'N';
  end if;
end if;

if (coalesce(ie_dia_seguinte_w, 'N') = 'S')then
    ie_agora_w        := 'N';
end if;

if (ie_horario_prescr_p IS NOT NULL AND ie_horario_prescr_p::text <> '') and (coalesce(ie_dia_seguinte_w, 'N') <> 'S') then
  if (ie_horario_prescr_p = '5') then
    dt_prev_execucao_w  := obter_horario_exec_prescr( dt_prev_execucao_w, '2', nm_usuario_p, cd_estabelecimento_p);
  else
    dt_prev_execucao_w  := obter_horario_exec_prescr( dt_prev_execucao_w, ie_horario_prescr_p, nm_usuario_p, cd_estabelecimento_p);
  end if;
end if;

SELECT * FROM Obter_proc_tab_interno( nr_seq_proc_interno_p, null, nr_atendimento_p, 0, cd_procedimento_w, ie_origem_proced_w, null, null) INTO STRICT cd_procedimento_w, ie_origem_proced_w;

select  coalesce(max(cd_setor_exclusivo), cd_setor_exclusivo_p)
into STRICT  cd_setor_exclusivo_w
from  procedimento
where  cd_procedimento    = cd_procedimento_w
and    ie_origem_proced  = ie_origem_proced_w;

if (coalesce(cd_setor_exclusivo_w::text, '') = '') then
  cd_setor_exclusivo_w  := obter_setor_atend_proc(  cd_estabelecimento_p, cd_procedimento_w, ie_origem_proced_w, null,
                            cd_setor_atendimento_p, null, nr_seq_proc_interno_p, nr_atendimento_p);

  if (coalesce(cd_setor_exclusivo_w::text, '') = '') and (nr_seq_exame_p IS NOT NULL AND nr_seq_exame_p::text <> '') then
    cd_setor_exclusivo_w  := obter_setor_atend_proc_lab(  cd_estabelecimento_p, cd_procedimento_w, ie_origem_proced_w, null,
                                cd_setor_atendimento_p, null, nr_seq_exame_p);
  end if;
end if;

qt_procedimento_w    := coalesce( Obter_Param_Prescr_Proc_Int(nr_seq_proc_interno_p,cd_setor_atendimento_p, 'Q', nr_atendimento_p), qt_procedimento_w );

cd_intervalo_w    := coalesce(  Obter_Param_Prescr_Proc_Int(nr_seq_proc_interno_p,cd_setor_atendimento_p, 'I', nr_atendimento_p),
                  obter_dados_exame_lab_rep(cd_perfil_p, cd_especialidade_p, cd_setor_atendimento_p, nr_seq_exame_p, cd_estabelecimento_p, 'I'),
                  obter_param_proced_prescr(cd_procedimento_w, ie_origem_proced_w,cd_setor_atendimento_p,cd_perfil_p,'I',nr_seq_proc_interno_p,nr_seq_exame_p),
                  cd_intervalo_p);

select  max(ie_tipo),
    coalesce(max(ie_ctrl_glic),'NC'),
    coalesce(max(ie_excluir_proc_princ),'N'),
    max(ds_observacao),
    max(nr_seq_prot_glic),
    coalesce(max(ie_copiar_rep),'S'),
    max(nr_seq_exame_lab)
into STRICT  ie_tipo_proc_interno_w,
    ie_ctrl_glic_w,
    ie_excluir_proc_princ_w,
    ds_obs_aux_w,
    nr_seq_prot_glic_w,
    ie_copiar_rep_w,
    nr_seq_exame_lab_w
from  proc_interno
where  nr_sequencia = nr_seq_proc_interno_p;

if (nr_seq_prot_glic_w IS NOT NULL AND nr_seq_prot_glic_w::text <> '') then
  cd_intervalo_w := coalesce(obter_intervalo_ccg(nr_seq_prot_glic_w), cd_intervalo_w);
  ie_agora_w := obter_se_intervalo_agora(cd_intervalo_w);
end if;

if (coalesce(obter_se_marca_agora(cpoe_obter_setor_atend_prescr(nr_atendimento_p, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p)),'N') = 'S') then
  cd_intervalo_agora_w := cpoe_busca_intervalo_agora(nr_atendimento_p,'P',cd_estabelecimento_p,cd_perfil_p, nm_usuario_p);
  if (cd_intervalo_agora_w IS NOT NULL AND cd_intervalo_agora_w::text <> '') then

    cd_intervalo_w := cd_intervalo_agora_w;
    ie_agora_w := 'S';
  end if;

end if;

select  coalesce(max(ie_agora),'N'),
    max(ie_operacao),
    coalesce(max(ie_dose_unica_cpoe),'N')
into STRICT  ie_interv_agora_w,
    ie_operacao_w,
    ie_dose_unica_cpoe_w
from  intervalo_prescricao
where  cd_intervalo  = cd_intervalo_w;


if (ie_interv_agora_w = 'S') then
  dt_prev_execucao_w := clock_timestamp() + interval '1 days'/1440;
  ie_agora_w := 'S';
end if;

if (nr_seq_exame_p IS NOT NULL AND nr_seq_exame_p::text <> '') then
  dt_prev_execucao_w := atualiza_dt_realizacao_exame(nr_seq_exame_p, 0, dt_prev_execucao_w, dt_prev_execucao_w);
end if;

if (obter_se_gerar_setor_rotina( cd_estabelecimento_p, 2314, cd_procedimento_w, ie_origem_proced_w, nr_seq_proc_interno_p, nr_seq_exame_p, cd_setor_atendimento_p, nm_usuario_p ) = 'N') then
  cd_setor_exclusivo_w := null;
end if;

if (ie_agora_w = 'N') then
  ie_agora_w := coalesce(obter_se_proc_urgente( cd_setor_atendimento_p, cd_procedimento_w, ie_origem_proced_w, nr_seq_proc_interno_p, nr_seq_exame_p, ie_tipo_atendimento_p, 'S', cd_perfil_p, cd_medico_p ), 'N' );
end if;

if (ie_agora_w = 'S') then
  cd_intervalo_w    := Obter_interv_acm_sn_agora_lib( cd_estabelecimento_p, 1, 2, 'P', cd_procedimento_w, cd_intervalo_w, 0, ie_origem_proced_w, null, null, null,
													  nr_atendimento_p, cd_perfil_p, nm_usuario_p );
  dt_prev_execucao_w  := clock_timestamp() + interval '1 days'/1440;
  ds_horarios_w    := to_char(clock_timestamp() + interval '1 days'/1440,'hh24:mi');

	select	max(ie_operacao),
			coalesce(max(ie_dose_unica_cpoe),'N')
	into STRICT	ie_operacao_w,
			ie_dose_unica_cpoe_w
	from	intervalo_prescricao
	where	cd_intervalo = cd_intervalo_w;

end if;

SELECT * FROM tiss_obter_guia(  4, null, nr_doc_convenio_w, 'N', null, null, null, null, null, ie_guia_w, null, 0, null, cd_setor_exclusivo_w, null, 0, null, null, null, null, null, null, cd_procedimento_w, ie_origem_proced_w, null) INTO STRICT nr_doc_convenio_w, ie_guia_w;

ds_observacao_w  := substr(obter_dados_exame_lab_rep(cd_perfil_p, cd_especialidade_p, cd_setor_exclusivo_w, nr_seq_exame_p, cd_estabelecimento_p, 'O'),1,2000);

if (coalesce(ds_observacao_w::text, '') = '') then
  begin
    select  substr(ds_observacao,1,2000)
    into STRICT  ds_observacao_w
    from  procedimento_prescricao
    where  cd_procedimento    = cd_procedimento_w
    and    ie_origem_proced  = ie_origem_proced_w
    and    coalesce(ie_somente_alerta,'N') = 'N';
  exception when others then
    null;
  end;
end if;

if (ds_obs_aux_w IS NOT NULL AND ds_obs_aux_w::text <> '') then
  if (coalesce(ds_observacao_w::text, '') = '') then
    ds_observacao_w  := substr(ds_obs_aux_w,1,2000);
  else
    ds_observacao_w  := substr(ds_observacao_w || chr(10) || ds_obs_aux_w,1,2000);
  end if;
end if;

if (ds_obs_adic_p IS NOT NULL AND ds_obs_adic_p::text <> '') then
  if (coalesce(ds_observacao_w::text, '') = '') then
    ds_observacao_w  := substr(ds_obs_adic_p,1,2000);
  else
    ds_observacao_w  := substr(ds_observacao_w || chr(10)  || ds_obs_adic_p,1,2000);
  end if;
end if;

  if ((nr_seq_proc_interno_p IS NOT NULL AND nr_seq_proc_interno_p::text <> '') and nr_seq_contraste_p > 0) then
		select max(b.ds_observacao)
		into STRICT ds_observacao_contraste_w
		from proc_interno a,
			proc_interno_contraste b
		where a.nr_sequencia = nr_seq_proc_interno_p
		and a.nr_sequencia = b.nr_seq_proc_interno
		and b.nr_sequencia = nr_seq_contraste_p
		and b.ie_situacao = 'A'
		and a.ie_iodo = 'S';
	

	  if ((ds_observacao_contraste_w IS NOT NULL AND ds_observacao_contraste_w::text <> '') or ds_observacao_contraste_w <> '') then
		if ((ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') or ds_observacao_w <> '') then
			ds_observacao_w := substr(ds_observacao_w||' '||ds_observacao_contraste_w,1,2000);
		else
			ds_observacao_w := substr(ds_observacao_contraste_w,1,2000);
		end if;
	  end if;
  end if;

if (qt_procedimento_w = 1) then
  qt_procedimento_w  := coalesce(Obter_quantidade_prescr_proced( cd_intervalo_w, ie_lado_p, cd_procedimento_w, ie_origem_proced_w, nr_seq_proc_interno_p, nr_atendimento_p ),1);
end if;

cd_pessoa_coleta_w  := null;
dt_coleta_w      := null;
qt_peca_ap_w    := null;

if (ie_tipo_proc_interno_w in ('AP','APH','APC')) then
  cd_pessoa_coleta_w  := cd_prescritor_p;
  dt_coleta_w      := clock_timestamp() + interval '1 days'/1440;
  qt_peca_ap_w    := 1;
end if;

if (ie_ctrl_glic_w = 'CIG') then
  ds_horarios_w  := to_char(dt_prev_execucao_w,'hh24:mi');
else
  ds_horarios_w  := Obter_Param_Prescr_Proc_Int( nr_seq_proc_interno_p, cd_setor_atendimento_p, 'H', nr_atendimento_p );

  if (ie_ctrl_glic_w = 'CCG') and (coalesce(nr_seq_prot_glic_w::text, '') = '') then
    cd_intervalo_w  := '';
  end if;
end if;

ie_acm_sn_w  := obter_info_proced( 0, cd_procedimento_w );
if (ie_acm_sn_w = 'N') or (ie_se_necessario_w = 'S') then
  ie_se_necessario_w  := 'S';
  ie_acm_w      := 'N';
  ds_horarios_w    := '';
elsif (ie_acm_sn_w = 'A') or (ie_acm_w = 'S') then
  ie_acm_w      := 'S';
  ie_se_necessario_w  := 'N';
  ie_agora_w      := 'N';
  ds_horarios_w    := '';
end if;

ie_admin_proc_w  := 'P';
if (ie_agora_w = 'S') then
  ie_urgencia_w    := 0;
  ie_se_necessario_w  := 'N';
  ie_acm_w      := 'N';
else
  ie_urgencia_w  := null;
  if (ie_se_necessario_w = 'S') then
    ie_admin_proc_w    := 'N';
    ie_acm_w      := 'N';
  elsif (ie_acm_w = 'S') then
    ie_admin_proc_w    := 'C';
    ie_se_necessario_w  := 'N';
  end if;
end if;

SELECT * FROM obter_regra_cpoe_quant_proced(cd_intervalo_p, ie_lado_p, nr_seq_proc_interno_p, nr_atendimento_p, ie_regra_intervalo_out_w, ie_regra_lado_out_w, qt_procedimento_out_w, ie_permite_edicao_out_w) INTO STRICT ie_regra_intervalo_out_w, ie_regra_lado_out_w, qt_procedimento_out_w, ie_permite_edicao_out_w;
if (qt_procedimento_out_w IS NOT NULL AND qt_procedimento_out_w::text <> '') then
    qt_procedimento_w := qt_procedimento_out_w;
end if;

if (ie_lado_p = 'A') then
	if (ie_param734_cpoe_w = 'N') and (qt_procedimento_w <=1) then
		qt_procedimento_w := 2;
		
	elsif (qt_procedimento_w < 1) then
			qt_procedimento_w  := 1;
	end if;
end if;

if (cd_medico_exec_p IS NOT NULL AND cd_medico_exec_p::text <> '') then
  cd_medico_exec_w := cd_medico_exec_p;
end if;

if (coalesce(cd_medico_exec_w::text, '') = '') then
  cd_medico_exec_w  := obter_medico_exec_cpoe( null, null, null, nr_seq_proc_rotina_p, nr_seq_rotina_p, nr_seq_proc_interno_p);
end if;

cd_setor_entrega_w := obter_setor_entrega_proc(cd_procedimento_w, nr_seq_proc_interno_p);

if (ie_agora_w = 'S' or ie_interv_agora_w = 'S') then
  ds_horarios_w := to_char(clock_timestamp() + interval '1 days'/1440,'hh24:mi');
elsif (hr_prim_hor_setor_p IS NOT NULL AND hr_prim_hor_setor_p::text <> '') then
  dt_prev_execucao_w := to_date(to_char(clock_timestamp(), 'dd/mm/yyyy ') || hr_prim_hor_setor_p,'dd/mm/yyyy hh24:mi:ss');
  if (dt_prev_execucao_w < clock_timestamp()) then
    dt_prev_execucao_w := dt_prev_execucao_w + 1;
  end if;
else
    if (coalesce(ie_dia_seguinte_w, 'N') = 'S')then
      dt_primeiro_horario_w  := Obter_data_prev_exec( dt_prev_execucao_w, null, cd_setor_atendimento_p, 0, 'A' );
    else
      --ORIGINAL
      dt_primeiro_horario_w  := Obter_data_prev_exec( dt_prescricao_w, null, cd_setor_atendimento_p, 0, 'A' );
    end if;

  hr_prev_execucao_w  := obter_dados_exame_lab_rep(cd_perfil_p, cd_especialidade_p, cd_setor_atendimento_p, nr_seq_exame_p, cd_estabelecimento_p, 'H');

  if (hr_prev_execucao_w IS NOT NULL AND hr_prev_execucao_w::text <> '') then
    dt_prev_execucao_w  := to_date(to_char(dt_prev_execucao_w,'dd/mm/yyyy ') || hr_prev_execucao_w,'dd/mm/yyyy hh24:mi');

    if (dt_prev_execucao_w < dt_prescricao_w) then
      dt_prev_execucao_w := dt_prev_execucao_w + 1;
    elsif (dt_prev_execucao_w > dt_validade_prescr_w) then
      dt_prev_execucao_w := dt_prescricao_w;
    end if;
    ds_horarios_w  := to_char(dt_prev_execucao_w,'hh24:mi');
  elsif (dt_primeiro_horario_w IS NOT NULL AND dt_primeiro_horario_w::text <> '') and (coalesce(ie_operacao_w, 'XPTO') <> 'F') then
        dt_prev_execucao_w := dt_primeiro_horario_w;
    end if;
end if;

if (nr_seq_exame_p IS NOT NULL AND nr_seq_exame_p::text <> '') then
  ie_permite_w := valida_exame_dia_semana( nr_seq_exame_p, cd_material_exame_w, coalesce(dt_prev_execucao_w,dt_prescricao_w), nm_usuario_p, cd_estabelecimento_p, ie_permite_w);

  if (ie_permite_w = 'N')  then
    return;
  end if;
end if;

ie_obter_dados_exames_lab_rep := obter_dados_exame_lab_rep(
    cd_perfil_p,
    0,
    cd_setor_atendimento_p,
    nr_seq_exame_p,
    cd_estabelecimento_p,
    'N'
  );

if ( ie_obter_dados_exames_lab_rep = 'V' ) then
    cd_material_exame_w := '';
  elsif ( ie_obter_dados_exames_lab_rep = 'PL' ) then
    select max(cd_material_exame)
		into STRICT cd_material_exame_w
		from material_exame_lab b,
			exame_lab_material a
		where a.nr_seq_material = b.nr_sequencia
		and a.nr_seq_exame      = nr_seq_exame_p
		and a.ie_situacao       = 'A'
		and coalesce(obter_se_mat_exam_estab(cd_estabelecimento_p,a.nr_seq_exame,a.nr_seq_material),'S') = 'S'
		and ie_prioridade       =
			(SELECT min(ie_prioridade)
			from exame_lab_material x
			where nr_seq_exame = nr_seq_exame_p
			and x.ie_situacao  = 'A');
  else
select  max(b.cd_material_exame)
into STRICT  cd_material_exame_w
from  material_exame_lab b,
    exame_lab_material a
where  a.nr_seq_material = b.nr_sequencia
and    a.nr_seq_exame = coalesce(nr_seq_exame_p, nr_seq_exame_lab_w)
and    a.ie_situacao = 'A'
and    (cd_material_exame_w IS NOT NULL AND cd_material_exame_w::text <> '')
and    b.cd_material_exame  = coalesce(cd_material_exame_w, b.cd_material_exame);
  end if;

if (dt_prev_execucao_w < dt_prescricao_w) then
  dt_prev_execucao_w := trunc((dt_prev_execucao_w + 1/1440),'mi');
end if;

if (coalesce(ie_prescr_alta_agora_w,'N') = 'S') and (coalesce(ie_item_alta_p,'N') = 'S')  then
  ie_urgencia_w := '0';
  dt_prev_execucao_w := clock_timestamp() + interval '1 days'/1440;
  ie_recalcular_hor_w := 'S';
end if;

if (coalesce(trim(both ds_horarios_w)::text, '') = '') or (ie_recalcular_hor_w = 'S') then
  select   max(coalesce(qt_min_intervalo,0))
  into STRICT   qt_min_intervalo_w
  from   intervalo_prescricao
  where   cd_intervalo = cd_intervalo_w;

  nr_ocorrencia_w  := 0;
  if (obter_se_eh_cig(nr_seq_proc_interno_p) = 'S') then
    nr_ocorrencia_w := 1;
  end if;
  SELECT * FROM cpoe_calcular_horario_prescr(  nr_atendimento_p, cd_intervalo_w, null, dt_prev_execucao_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null, null, cd_procedimento_w, ie_origem_proced_w, nr_seq_proc_interno_p) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;

  ds_horarios_w  := ds_horarios_w || ds_horarios_aux_w;

  if (ie_acm_w = 'S') or (ie_se_necessario_w = 'S') then
    ds_horarios_w     := '';
    hr_prim_horario_w := '';
  end if;
else
  begin
    nr_ocorrencia_w  := obter_ocorrencias_horarios_rep(ds_horarios_w);
  exception when others then
    nr_ocorrencia_w  := 1;
  end;
end if;

if (ie_operacao_w = 'F' AND ie_admin_proc_w = 'P')  then
  if (to_date(to_char(dt_prev_execucao_w, 'dd/mm/yyyy') || ' ' || Obter_prim_DsHorarios(ds_horarios_w), 'dd/mm/yyyy hh24:mi:ss') < clock_timestamp()) then
    dt_prev_execucao_w := to_date(to_char(clock_timestamp() + interval '1 days', 'dd/mm/yyyy') || ' ' || Obter_prim_DsHorarios(ds_horarios_w), 'dd/mm/yyyy hh24:mi:ss');
  else
    dt_prev_execucao_w := to_date(to_char(dt_prev_execucao_w, 'dd/mm/yyyy') || ' ' || Obter_prim_DsHorarios(ds_horarios_w), 'dd/mm/yyyy hh24:mi:ss');
  end if;
elsif (ie_operacao_w = 'V' and ie_admin_proc_w = 'P')  then
	begin
		hr_prim_horario_w := obter_prim_dshorarios(replace(padroniza_horario_prescr(cpoe_reordenar_horarios(clock_timestamp(), ds_horarios_w),NULL),'A',''));

		if (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') then
			if (to_date(to_char(dt_prev_execucao_w, 'dd/mm/yyyy') || ' ' || hr_prim_horario_w, 'dd/mm/yyyy hh24:mi:ss') < clock_timestamp()) then
				dt_prev_execucao_w := to_date(to_char(clock_timestamp() + interval '1 days', 'dd/mm/yyyy') || ' ' || hr_prim_horario_w, 'dd/mm/yyyy hh24:mi:ss');
			else
				dt_prev_execucao_w := to_date(to_char(dt_prev_execucao_w, 'dd/mm/yyyy') || ' ' || hr_prim_horario_w, 'dd/mm/yyyy hh24:mi:ss');
			end if;
		end if;	
	exception when others then
		CALL gravar_log_cpoe(substr('CPOE_INSERIR_EXAME_PROC_ROTINA EXCEPTION: ' || to_char(sqlerrm)
			|| ' nr_seq_rotina_p: ' || nr_seq_rotina_p
			|| ' cd_estabelecimento_p: ' || cd_estabelecimento_p
			|| ' cd_perfil_p: ' || cd_perfil_p
			|| ' nm_usuario_p: ' || nm_usuario_p
			|| ' cd_setor_atendimento_p: ' || cd_setor_atendimento_p
			|| ' cd_convenio_p: ' || cd_convenio_p
			|| ' nr_seq_rotina_esp_p: ' || nr_seq_rotina_esp_p
			|| ' nr_seq_proc_interno_p: ' || nr_seq_proc_interno_p
			|| ' cd_procedimento_p: ' || cd_procedimento_p
			|| ' ie_origem_proced_p: ' || ie_origem_proced_p
			|| ' nr_seq_exame_p: ' || nr_seq_exame_p
			|| ' ds_horarios_w: ' || ds_horarios_w
			|| ' dt_prev_execucao_w: ' || to_char(dt_prev_execucao_w, 'dd/mm/yyyy hh24:mi:ss')
			|| ' hr_prim_horario_w: ' || hr_prim_horario_w
			|| ' cd_intervalo_p: ' || cd_intervalo_p,1, 2000), nr_atendimento_p);
	end;
end if;

select  nextval('cpoe_procedimento_seq')
into STRICT  nr_sequencia_w
;

nr_seq_item_gerado_p := nr_sequencia_w;
ie_duracao_w := coalesce(ie_duracao_p,'C');


if (coalesce(ie_dose_unica_cpoe_w, 'N') = 'S') then
  ie_duracao_w := 'P';
  ie_se_necessario_w := 'N';
  ie_acm_w := 'N';
  ie_admin_proc_w := 'P';
end if;

if ((ie_copiar_rep_w = 'C') or (ie_duracao_w = 'P')) then
  ie_duracao_w := 'P';
  if (position('A' in CPOE_Padroniza_horario_prescr(ds_horarios_w,dt_prev_execucao_w)) > 0 ) then
    qt_dias_adicionar_w := 1;
  end if;

  if (ie_param8_cpoe_w = 'F') then
    dt_fim_w := fim_dia(dt_prev_execucao_w + qt_dias_adicionar_w);
  else
    dt_fim_w := (dt_prev_execucao_w + 1) - 1/1440;
  end if;
end if;
if (ie_retrogrado_p = 'S' or ie_futuro_p = 'S') then -- retrograde/backward item
  dt_prev_execucao_w := dt_inicio_p;

  if (position('A' in CPOE_Padroniza_horario_prescr(ds_horarios_w,dt_prev_execucao_w)) > 0 ) then
    qt_dias_adicionar_w := 1;
  end if;

  if (ie_param8_cpoe_w = 'F') then
    dt_fim_w := fim_dia(dt_prev_execucao_w + qt_dias_adicionar_w);
  else
    dt_fim_w := (dt_prev_execucao_w + 1) - 1/1440;
  end if;

	ie_urgencia_w	:= null;
	ie_duracao_w	:= 'P';
	nr_ocorrencia_w	:= 0;
	ds_horarios_w	:= '';
	ds_horarios_aux_w	:= '';

	select	max(qt_min_intervalo)
	into STRICT	qt_min_intervalo_w
	from	intervalo_prescricao
	where	cd_intervalo = cd_intervalo_w;

	SELECT * FROM cpoe_calcular_horario_prescr(  nr_atendimento_p, cd_intervalo_w, null, dt_prev_execucao_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null, null, cd_procedimento_w, ie_origem_proced_w, nr_seq_proc_interno_p) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;

	ds_horarios_w	:= ds_horarios_w || ds_horarios_aux_w;

end if;

  if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '')then
  -- esse select deve ser o mesmo que ta ativando o lookup de intervalo, qualquer alteracao aqui deve ser replicada para o looup e vice-versa
      SELECT coalesce(MAX(cd_intervalo),'N')
      INTO STRICT ie_exibe_w
      FROM intervalo_prescricao
      WHERE   cd_intervalo = cd_intervalo_w
      AND   ie_situacao = 'A'
      and  Obter_se_intervalo(cd_intervalo_w,'P') = 'S'
      and  cpoe_obter_se_exibe_interv(NR_ATENDIMENTO_P, cd_estabelecimento_p,CD_INTERVALO_W, cd_perfil_p, nm_usuario_p) = 'S'
      and  ((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_p))
      and  ((coalesce(ie_so_retrograda,'N') = 'N') or (coalesce(ie_retrogrado_p,'N') = 'N'));

      if (ie_exibe_w = 'N')then
        cd_intervalo_w := null;
      end if;
  end if;

  if (coalesce(cd_intervalo_w::text, '') = '')  or (cd_intervalo_w = '') then
    ds_horarios_w  := '';
  end if;

  if (nr_seq_material_exame_p IS NOT NULL AND nr_seq_material_exame_p::text <> '') then
    cd_material_exame_w := nr_seq_material_exame_p;
  end if;

  select coalesce(max(ie_disp_resp_esp ),'') 
  into STRICT	ie_disp_resp_esp_w 
  from 	procedimento_rotina
  where	nr_sequencia = nr_seq_proc_rotina_p;
 
  insert into cpoe_procedimento(
    nr_sequencia,
    qt_procedimento,
    ds_horarios,
    ds_observacao,
    dt_atualizacao, --
    nm_usuario,
    cd_intervalo,
    dt_atualizacao_nrec,
    nm_usuario_nrec,
    ie_urgencia, --
    dt_prev_execucao,
    cd_material_exame,
    ds_material_especial,
    nr_atendimento,
    ie_se_necessario, --
    ie_acm,
    nr_ocorrencia,
    nr_seq_proc_interno,
    ie_lado,
    nr_seq_topografia,
    nr_seq_prot_glic, --
    ie_duracao,
    ie_periodo,
    dt_inicio,
    dt_fim,
    ds_justificativa, --
    hr_prim_horario,
    dt_liberacao,
    ie_administracao,
    ie_evento_unico,
    nr_seq_cpoe_anterior,
    cd_perfil_ativo,
    cd_pessoa_fisica,
    cd_funcao_origem,
    nr_seq_transcricao,
    ie_item_alta,
    ie_prescritor_aux,
    cd_medico,
    ie_retrogrado,
    nr_seq_pepo,
    nr_cirurgia,
    nr_cirurgia_patologia,
    nr_seq_agenda,
    ie_oncologia,
    nr_seq_conclusao_apae,
    ds_dado_clinico,
    nr_seq_condicao,
    nr_seq_contraste,
    nr_seq_rotina,
    nr_seq_rotina_especial,
    ie_futuro,
	cd_setor_atendimento,
    ie_amostra,
	nr_seq_proc_rotina,
	cd_medico_exec,
	cd_setor_entrega,
	ie_disp_resp_esp,
	cd_microorganismo,
	nr_seq_cpoe_order_unit)
  values (
    nr_sequencia_w,
    qt_procedimento_w,
    ds_horarios_w,
    ds_observacao_w,
    clock_timestamp(),
    nm_usuario_p,
    cd_intervalo_w,
    clock_timestamp(),
    nm_usuario_p,
    ie_urgencia_w,
    dt_prev_execucao_w,
    cd_material_exame_w,
    ds_material_especial_p,
    nr_atendimento_p,
    ie_se_necessario_w, --
    ie_acm_w,
    nr_ocorrencia_w,
    nr_seq_proc_interno_p,
    ie_lado_p,
    null,
    nr_seq_prot_glic_w, --
    ie_duracao_w,
    null,
    dt_prev_execucao_w,--OS 903755
    dt_fim_w,
    ds_justificativa_p, --
    to_char(dt_prev_execucao_w,'hh24:mi'),
    null,
    ie_admin_proc_w,
    ie_dose_unica_cpoe_w,
    null,
    cd_perfil_p,
    cd_paciente_p,
    2314,
    nr_seq_transcricao_p,
    ie_item_alta_p,
    ie_prescritor_aux_p,
    cd_medico_p,
    ie_retrogrado_p,
    nr_seq_pepo_p,
    nr_cirurgia_p,
    nr_cirurgia_patologia_p,
    nr_seq_agenda_p,
    ie_oncologia_p,
    nr_seq_conclusao_apae_p,
    ds_indicacao_clinica_p,
    nr_seq_condicao_p,
    nr_seq_contraste_p,
    nr_seq_rotina_p,
  nr_seq_rotina_esp_p,
  ie_futuro_p,
  cd_setor_atendimento_p,
  ie_amostra_p,
  nr_seq_proc_rotina_p,
  cd_medico_exec_w,
  CASE WHEN cd_setor_entrega_w=0 THEN null  ELSE cd_setor_entrega_w END ,
  ie_disp_resp_esp_w,
  cd_microorganismo_p,
  nr_seq_cpoe_order_unit_p);

  CALL cpoe_copy_order_unit_fields(nr_sequencia_w,'P', nr_seq_cpoe_order_unit_p);

commit;

  CALL cpoe_consis_proced_insert(nr_sequencia_w,nm_usuario_p);


if (nr_seq_prot_glic_w IS NOT NULL AND nr_seq_prot_glic_w::text <> '') then
  CALL cpoe_gerar_proc_glic( nr_sequencia_w, nr_seq_prot_glic_w, nm_usuario_p, nr_atendimento_p, cd_paciente_p, 'S', nr_seq_proc_interno_p);
  CALL cpoe_gerar_proc_glic_assoc(nr_atendimento_p,nr_sequencia_w,nr_seq_prot_glic_w,nm_usuario_p);
end if;

if (ie_gerar_associado_p = 'S') then
  ds_mat_adic_proc_w  := 'X';
  ds_mat_adic_proc_w := CPOE_Gerar_med_mat_assoc(  nr_atendimento_p, nr_sequencia_w, cd_procedimento_w, ie_origem_proced_w, nr_seq_proc_interno_p, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, cd_paciente_p, qt_idade_dia_p, qt_idade_mes_p, qt_idade_ano_p, cd_setor_atendimento_p, ie_tipo_atendimento_p, cd_convenio_p, cd_medico_p, dt_prev_execucao_w, cd_intervalo_w, ie_urgencia_w, qt_hora_intervalo_p, qt_min_intervalo_p, ds_horarios_w, nr_ocorrencia_w, ds_mat_adic_proc_w, nr_seq_contraste_p, nr_seq_cpoe_order_unit_p);
end if;

CALL cpoe_gerar_prescr_proc_assoc(nr_sequencia_w, nm_usuario_p, cd_estabelecimento_p);

CALL CPOE_Gerar_Exame_Lab_Dep(nr_sequencia_w, nr_atendimento_p, cd_estabelecimento_p, cd_setor_atendimento_p, '10,', nm_usuario_p, null, null);

if (lst_cd_kit_material_p IS NOT NULL AND lst_cd_kit_material_p::text <> '')then
    for c_itens_kits_w in c_itens_kits
    loop
        CALL CPOE_Gerar_kit_proced_manual(
            CD_CPOE_PROCEDIMENTO_P => nr_sequencia_w,
            CD_KIT_MATERIAL_P => c_itens_kits_w.nr_registro, 
            CD_ESTABELECIMENTO_P => cd_estabelecimento_p, 
            CD_PERFIL_P => cd_perfil_p, 
            CD_CONVENIO_P => cd_convenio_p
        );
    end loop;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_inserir_exame_proc_rotina ( nr_atendimento_p bigint, nr_seq_rotina_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_setor_atendimento_p bigint, ie_tipo_atendimento_p bigint, cd_convenio_p bigint, ie_tipo_convenio_p bigint, dt_base_proc_p timestamp, cd_paciente_p text, qt_idade_dia_p bigint, qt_idade_mes_p bigint, qt_idade_ano_p bigint, qt_peso_p bigint, cd_prescritor_p text, cd_setor_usuario_p bigint, cd_medico_p text, cd_medico_exec_p text, cd_especialidade_p bigint, nr_seq_rotina_esp_p bigint, nr_seq_proc_interno_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_exame_p bigint, cd_setor_exclusivo_p bigint, cd_material_exame_p text, ds_material_especial_p text, cd_intervalo_p text, ds_obs_adic_p text, ds_justificativa_p text, qt_procedimento_p bigint, ie_agora_p char, ie_acm_p char, ie_se_necessario_p char, ie_lado_p text, qt_hora_intervalo_p bigint, qt_min_intervalo_p bigint, ie_gerar_associado_p char, ie_horario_prescr_p char, nr_seq_item_gerado_p INOUT bigint, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, ie_oncologia_p text default 'N', nr_seq_conclusao_apae_p bigint default null, hr_prim_hor_setor_p text default null, ds_indicacao_clinica_p text default null, nr_seq_condicao_p bigint default null, ie_duracao_p text default null, nr_seq_contraste_p bigint default null, nr_seq_material_exame_p text default null, ie_futuro_p text default 'N', ie_dia_seguinte_p text default 'N', ie_amostra_p text default null, nr_seq_proc_rotina_p bigint default null, lst_cd_kit_material_p text default null, cd_microorganismo_p bigint default null, nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) FROM PUBLIC;

