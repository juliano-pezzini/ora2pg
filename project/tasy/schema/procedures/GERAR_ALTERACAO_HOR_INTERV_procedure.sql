-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_alteracao_hor_interv ( nr_prescricao_p text, nr_seq_horario_p bigint, cd_item_p text, nr_atendimento_p bigint, ie_tipo_alteracao_p text, nm_usuario_p text, dt_alteracao_p timestamp) AS $body$
DECLARE

 
nr_seq_alteracao_w	bigint;
nr_prescricao_w		bigint;
nr_seq_pe_proc_w  bigint;


BEGIN 
 
if (ie_tipo_alteracao_p = 56) THEN 
 
	update	pe_prescr_proc_hor 
	set		dt_fim_horario	= clock_timestamp(), 
			nm_usuario_adm	= nm_usuario_p 
	where	nr_sequencia	= nr_seq_horario_p 
	and		coalesce(dt_fim_horario::text, '') = '' 
	and		coalesce(dt_suspensao::text, '') = '';
 
end if;
 
select	max(nr_seq_pe_prescr), max(nr_seq_pe_proc) 
into STRICT	nr_prescricao_w, nr_seq_pe_proc_w 
from	pe_prescr_proc_hor 
where	nr_sequencia	= nr_seq_horario_p;
 
select	nextval('prescr_mat_alteracao_seq') 
into STRICT	nr_seq_alteracao_w
;
 
insert into prescr_mat_alteracao(nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	nr_prescricao, 
	nr_seq_horario_sae, 
	dt_alteracao, 
	cd_pessoa_fisica, 
	ie_alteracao, 
	ie_tipo_item, 
	dt_horario, 
	nr_atendimento, 
	cd_item, 
	nr_seq_item_sae 
	) 
values ( 
	nr_seq_alteracao_w, 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	nr_prescricao_w, 
	nr_seq_horario_p, 
	dt_alteracao_p, 
	obter_dados_usuario_opcao(nm_usuario_p,'C'), 
	ie_tipo_alteracao_p, 
	'E', 
	dt_alteracao_p, 
	nr_atendimento_p, 
	cd_item_p, 
	nr_seq_pe_proc_w 
	);
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_alteracao_hor_interv ( nr_prescricao_p text, nr_seq_horario_p bigint, cd_item_p text, nr_atendimento_p bigint, ie_tipo_alteracao_p text, nm_usuario_p text, dt_alteracao_p timestamp) FROM PUBLIC;

