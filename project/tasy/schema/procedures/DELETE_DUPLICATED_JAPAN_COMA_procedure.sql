-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE delete_duplicated_japan_coma ( nr_atendimento_p atendimento_paciente.nr_atendimento%TYPE, dt_registro_p w_apap_pac_registro.dt_registro%TYPE ) AS $body$
DECLARE

    nr_count_w bigint := 0;
    nr_seq_registro_w w_apap_pac_registro.NR_SEQUENCIA%TYPE := null;
    nm_usuario_w usuario.nm_usuario%TYPE := NULL;

BEGIN
    nm_usuario_w := wheb_usuario_pck.get_nm_usuario();

    SELECT
        COUNT(1), MIN(d.NR_SEQUENCIA)
    INTO STRICT nr_count_w, nr_seq_registro_w
    FROM w_apap_pac A 
    INNER JOIN w_apap_pac_grupo b ON 
        A.nr_sequencia = b.nr_seq_mod_apap AND
        b.nr_seq_linked_data = 563
    INNER JOIN w_apap_pac_informacao C ON
        C.nr_seq_apap_grupo = b.nr_sequencia AND
        C.nm_atributo_tabela = 'DS_SCORE'
    INNER JOIN w_apap_pac_registro D ON
        d.nr_seq_apap_inf = c.NR_SEQUENCIA AND
        d.nm_usuario = nm_usuario_w AND
        d.dt_registro = TRUNC(dt_registro_p, 'MI')
    WHERE
        A.nr_atendimento = nr_atendimento_p AND 
        A.nm_usuario = nm_usuario_w;

    IF (nr_count_w = 1 ) THEN
        
            DELETE FROM w_apap_pac_registro WHERE NR_SEQUENCIA = nr_seq_registro_w;

    END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE delete_duplicated_japan_coma ( nr_atendimento_p atendimento_paciente.nr_atendimento%TYPE, dt_registro_p w_apap_pac_registro.dt_registro%TYPE ) FROM PUBLIC;

