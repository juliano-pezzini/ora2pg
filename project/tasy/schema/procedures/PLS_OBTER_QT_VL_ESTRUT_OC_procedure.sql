-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_qt_vl_estrut_oc ( nr_seq_conta_p bigint, nr_seq_protocolo_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_grupo_servico_p bigint, cd_area_procedimento_p bigint, cd_especialidade_p bigint, cd_grupo_proc_p bigint, nr_seq_proc_tipo_atend_p bigint, nr_seq_material_p bigint, nr_seq_estrut_mat_p bigint, cd_estabelecimento_p bigint, ie_somar_conta_protocolo_p text, qt_retorno_p INOUT bigint, vl_retorno_p INOUT bigint ) AS $body$
DECLARE


cd_area_procedimento_w		bigint;
cd_especialidade_w		bigint;
cd_grupo_proc_w			bigint;
ie_origem_proced_w		bigint;
qt_retorno_w			bigint;
vl_retorno_w			double precision;
nr_seq_tipo_atend_regra_w	bigint;
nr_seq_tipo_atend_w		bigint;
ie_tipo_atendimento_imp_w	varchar(10);
nr_seq_estrut_mat_w		numeric(30);
qt_registros_w 			numeric(30);


BEGIN

if (coalesce(cd_procedimento_p,0) > 0) or (coalesce(nr_seq_grupo_servico_p,0) > 0) or (coalesce(cd_area_procedimento_p,0) > 0) or (coalesce(cd_especialidade_p,0) > 0) or (coalesce(cd_grupo_proc_p,0) > 0) or (coalesce(nr_seq_proc_tipo_atend_p,0) > 0) then

	select	max(ie_tipo_atendimento_imp)
	into STRICT	ie_tipo_atendimento_imp_w
	from	pls_conta
	where	nr_sequencia = nr_seq_conta_p;

	select 	max(z.nr_sequencia)
	into STRICT	nr_seq_tipo_atend_w
	from   	pls_tipo_atendimento z
	where 	z.ie_situacao = 'A'
	and 	z.cd_estabelecimento = cd_estabelecimento_p
	and	z.cd_tiss = ie_tipo_atendimento_imp_w;

	select	max(nr_seq_tipo_atendimento)
	into STRICT	nr_seq_tipo_atend_regra_w
	from	pls_oc_proc_atendimento
	where	nr_sequencia = nr_seq_proc_tipo_atend_p;

	SELECT * FROM pls_obter_estrut_proc(	cd_procedimento_p, ie_origem_proced_p, cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, ie_origem_proced_w) INTO STRICT cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, ie_origem_proced_w;

	select	sum(a.qt_procedimento_imp),
		sum(a.vl_procedimento_imp),
		count(1)
	into STRICT	qt_retorno_w,
		vl_retorno_w,
		qt_registros_w
	from	pls_conta_proc a,
		estrutura_procedimento_v b
	where	nr_seq_conta = nr_seq_conta_p
	and	a.cd_procedimento 	= b.cd_procedimento
	and	a.ie_origem_proced	= b.ie_origem_proced
	and	((a.cd_procedimento = cd_procedimento_p AND a.ie_origem_proced = ie_origem_proced_p) or (coalesce(cd_procedimento_p,0) 		= 0))
	and	 ((coalesce(b.cd_area_procedimento,0)	= cd_area_procedimento_p)			 or (coalesce(cd_area_procedimento_p,0) 	= 0))
	and	 ((coalesce(b.cd_especialidade,0)		= cd_especialidade_p)				 or (coalesce(cd_especialidade_p,0) 		= 0))
	and	 ((coalesce(b.cd_grupo_proc,0)		= cd_grupo_proc_p)				 or (coalesce(cd_grupo_proc_p,0) 		= 0))
	and	(((nr_seq_tipo_atend_w = nr_seq_tipo_atend_regra_w) and (pls_obter_se_proc_atend(a.cd_procedimento, a.ie_origem_proced, nr_seq_proc_tipo_atend_p) = 'S')) or (coalesce(nr_seq_proc_tipo_atend_p,0) = 0))
	and	((pls_se_grupo_preco_servico(nr_seq_grupo_servico_p, a.cd_procedimento, a.ie_origem_proced) = 'S') 	or (coalesce(nr_seq_grupo_servico_p,0) = 0));
elsif (coalesce(nr_seq_material_p,0) > 0) or (coalesce(nr_seq_estrut_mat_p,0) > 0)or (coalesce(nr_seq_proc_tipo_atend_p,0) > 0) then

	--jjung OS 491904 07/09/2012  -  obter dados do atendimento e verificar as regras de tipo de atendimento para material tambÃ©m.
	select	coalesce(max(ie_tipo_atendimento_imp),0)
	into STRICT	ie_tipo_atendimento_imp_w
	from	pls_conta
	where	nr_sequencia = nr_seq_conta_p;

	select 	coalesce(max(z.nr_sequencia),0)
	into STRICT	nr_seq_tipo_atend_w
	from   	pls_tipo_atendimento z
	where 	z.ie_situacao = 'A'
	and 	z.cd_estabelecimento = cd_estabelecimento_p
	and	z.cd_tiss = ie_tipo_atendimento_imp_w;

	select	coalesce(max(nr_seq_tipo_atendimento),0)
	into STRICT	nr_seq_tipo_atend_regra_w
	from	pls_oc_proc_atendimento
	where	nr_sequencia = nr_seq_proc_tipo_atend_p;

	select	sum(qt_material_imp),
		sum(vl_material_imp),
		count(1)
	into STRICT	qt_retorno_w,
		vl_retorno_w,
		qt_registros_w
	from	pls_conta_mat
	where	nr_seq_conta = nr_seq_conta_p
	and	((nr_seq_material = nr_seq_material_p) 	or (coalesce(nr_seq_material_p,0) > 0))
	and	((pls_obter_se_mat_estrutura(nr_seq_material, nr_seq_estrut_mat_p) = 'S') or (coalesce(nr_seq_estrut_mat_p,0) > 0))
	and	((nr_seq_tipo_atend_w = nr_seq_tipo_atend_regra_w) and (pls_obter_se_mat_atend(nr_seq_material, nr_seq_proc_tipo_atend_p) = 'S') or (coalesce(nr_seq_proc_tipo_atend_p,0) = 0));
end if;

qt_retorno_p := qt_retorno_w;
vl_retorno_p := vl_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_qt_vl_estrut_oc ( nr_seq_conta_p bigint, nr_seq_protocolo_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_grupo_servico_p bigint, cd_area_procedimento_p bigint, cd_especialidade_p bigint, cd_grupo_proc_p bigint, nr_seq_proc_tipo_atend_p bigint, nr_seq_material_p bigint, nr_seq_estrut_mat_p bigint, cd_estabelecimento_p bigint, ie_somar_conta_protocolo_p text, qt_retorno_p INOUT bigint, vl_retorno_p INOUT bigint ) FROM PUBLIC;

