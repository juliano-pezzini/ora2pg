-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_regra_classif_proced (ie_classificacao_p text, cd_convenio_p bigint, cd_procedimento_p INOUT bigint, ie_origem_proced_p INOUT bigint, nr_seq_proc_interno_p INOUT bigint, nr_seq_estagio_p INOUT bigint, nr_seq_classif_p INOUT bigint) AS $body$
DECLARE


cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;

c_reg CURSOR FOR
    SELECT	cd_procedimento,
		ie_origem_proced,
		nr_seq_proc_interno,
		nr_seq_estagio,
		nr_seq_classif
    from	regra_proc_remun_diag
    where	cd_convenio = cd_convenio_p
    and	    	ie_classif_remun_diag = ie_classificacao_p
    and	   	 clock_timestamp() between coalesce(dt_inicio_vigencia,clock_timestamp()) and coalesce(dt_fim_vigencia,clock_timestamp() + interval '999 days')
    and (cd_estabelecimento = cd_estabelecimento_w or coalesce(cd_estabelecimento_w::text, '') = '')
    and 	ie_situacao = 'A'
    order by coalesce(nr_seq_proc_interno,0),
        coalesce(cd_procedimento,0),
        coalesce(nr_seq_estagio,0),
        coalesce(nr_seq_classif,0);

c_reg_w		c_reg%rowtype;


BEGIN

cd_estabelecimento_w	:= wheb_usuario_pck.get_cd_estabelecimento;

for c_reg_w in c_reg loop
	begin
	if (c_reg_w.nr_seq_proc_interno IS NOT NULL AND c_reg_w.nr_seq_proc_interno::text <> '') and (coalesce(c_reg_w.cd_procedimento::text, '') = '') then
		begin

		SELECT * FROM Obter_Proc_Tab_Interno(c_reg_w.nr_seq_proc_interno, null, null, null, c_reg_w.cd_procedimento, c_reg_w.ie_origem_proced, null, null, cd_convenio_p) INTO STRICT c_reg_w.cd_procedimento, c_reg_w.ie_origem_proced;
		end;
	end if;

	cd_procedimento_p  	    := c_reg_w.cd_procedimento;
	ie_origem_proced_p 	    := c_reg_w.ie_origem_proced;
	nr_seq_proc_interno_p 	    := c_reg_w.nr_seq_proc_interno;
	nr_seq_estagio_p 	    := c_reg_w.nr_seq_estagio;
	nr_seq_classif_p	    := c_reg_w.nr_seq_classif;

	end;
end loop;



end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_regra_classif_proced (ie_classificacao_p text, cd_convenio_p bigint, cd_procedimento_p INOUT bigint, ie_origem_proced_p INOUT bigint, nr_seq_proc_interno_p INOUT bigint, nr_seq_estagio_p INOUT bigint, nr_seq_classif_p INOUT bigint) FROM PUBLIC;

