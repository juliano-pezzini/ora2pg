-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_prescr_antecip ( cd_setor_atendimento_p cpoe_week_dispens_rule.cd_setor_atendimento%type, dt_prox_geracao_p timestamp, dt_inicio_regra_p timestamp, dt_fim_regra_p timestamp, dt_prim_horario_p timestamp, nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type, itens_liberar_p text, ie_inconsistencia_out_p INOUT text, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type default null, ie_copia_diaria_p char default 'N', ie_interv_farmacia_p text default 'N', ie_motivo_prescr_p text default null, ie_liberacao_ang_p text default 'N', nr_prescricao_out_p INOUT bigint DEFAULT NULL, nr_prescricao_lib_p bigint default null, nr_seq_consulta_oft_p bigint default null, nr_seq_pend_pac_acao_p bigint default null, ie_copia_sem_lib_enf_farm_p text default 'N', ie_adep_p text default 'S', nm_usuario_validacao_p text default null, ds_prescricoes_geradas_out_p INOUT text DEFAULT NULL, nm_usuario_lib_enf_p cpoe_material.nm_usuario_lib_enf%type default null, cd_farmac_lib_p cpoe_material.cd_farmac_lib%type default null) AS $body$
DECLARE

					
ds_itens_w						varchar(32767);
dt_prim_horario_w				timestamp;
nr_horas_copia_w				bigint := 0;
nr_sequencia_w					cpoe_material.nr_sequencia%type;
nr_count_w						bigint := 0;

c01 CURSOR FOR
SELECT	cpoe_listagg_pck.tab_to_string(cast(collect('M' || ',' || nr_sequencia) as strarray)) ds_itens_liberar
from	cpoe_material
where	obter_se_contido(nr_sequencia, cpoe_obter_itens_liberar(itens_liberar_p)) = 'S'
and		nr_atendimento = nr_atendimento_p;

BEGIN

for rc01 in c01
loop
	if (rc01.ds_itens_liberar IS NOT NULL AND rc01.ds_itens_liberar::text <> '' AND dt_prox_geracao_p IS NOT NULL AND dt_prox_geracao_p::text <> '') then
			
		nr_horas_copia_w := get_qt_hours_after_copy_cpoe(cd_perfil_p, nm_usuario_p, cd_estabelecimento_p);	

		select	substr(cpoe_listagg_pck.tab_to_string(cast(collect('M' || ',' || nr_sequencia) as strarray)), 1, 32767) ds_itens,
				max(dt_prox_geracao) + nr_horas_copia_w/24,
				max(nr_sequencia)
		into STRICT	ds_itens_w,
				dt_prim_horario_w,
				nr_sequencia_w
		from	cpoe_material
		where	obter_se_contido(nr_sequencia, cpoe_obter_itens_liberar(rc01.ds_itens_liberar)) = 'S'
		and		((CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  coalesce(dt_fim_cih,dt_fim)  ELSE coalesce(dt_suspensao,dt_fim) END  > dt_prox_geracao_p) or (CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  coalesce(dt_fim_cih,dt_fim)  ELSE coalesce(dt_suspensao,dt_fim) coalesce(END::text, '') = ''));
		
		while(dt_prim_horario_w >= dt_inicio_regra_p) and (dt_prim_horario_w <= dt_fim_regra_p) and (dt_prim_horario_w < cpoe_obter_termino_item(nr_sequencia_w, 'M') or coalesce(cpoe_obter_termino_item(nr_sequencia_w, 'M')::text, '') = '') and (nr_count_w < 10) loop

			SELECT * FROM cpoe_gerar_prescricao(
						nr_atendimento_p, dt_prim_horario_w, cd_estabelecimento_p, cd_perfil_p, cd_setor_atendimento_p, nm_usuario_p, ds_itens_w, cd_pessoa_fisica_p, ie_copia_diaria_p, ie_interv_farmacia_P, ie_motivo_prescr_p, ie_liberacao_ang_p, nr_prescricao_lib_p, nr_seq_consulta_oft_p, nr_seq_pend_pac_acao_p, 'N', ie_adep_p, nm_usuario_validacao_p, nm_usuario_lib_enf_p, cd_farmac_lib_p, null, 'S') INTO STRICT ie_inconsistencia_out_p, nr_prescricao_out_p, ds_prescricoes_geradas_out_p;
			
			CALL gerar_prescr_medica_compl( nr_prescricao_out_p, null, null, null, 'W');
			
			select 	max(dt_prox_geracao) + nr_horas_copia_w/24
			into STRICT	dt_prim_horario_w
			from	cpoe_material 
			where	nr_sequencia = nr_sequencia_w;
			
			nr_count_w := nr_count_w + 1;

		end loop;
	end if;
end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_prescr_antecip ( cd_setor_atendimento_p cpoe_week_dispens_rule.cd_setor_atendimento%type, dt_prox_geracao_p timestamp, dt_inicio_regra_p timestamp, dt_fim_regra_p timestamp, dt_prim_horario_p timestamp, nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type, itens_liberar_p text, ie_inconsistencia_out_p INOUT text, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type default null, ie_copia_diaria_p char default 'N', ie_interv_farmacia_p text default 'N', ie_motivo_prescr_p text default null, ie_liberacao_ang_p text default 'N', nr_prescricao_out_p INOUT bigint DEFAULT NULL, nr_prescricao_lib_p bigint default null, nr_seq_consulta_oft_p bigint default null, nr_seq_pend_pac_acao_p bigint default null, ie_copia_sem_lib_enf_farm_p text default 'N', ie_adep_p text default 'S', nm_usuario_validacao_p text default null, ds_prescricoes_geradas_out_p INOUT text DEFAULT NULL, nm_usuario_lib_enf_p cpoe_material.nm_usuario_lib_enf%type default null, cd_farmac_lib_p cpoe_material.cd_farmac_lib%type default null) FROM PUBLIC;

