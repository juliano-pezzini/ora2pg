-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_painel_desenv (nr_seq_gerencia_p bigint, dt_referencia_p timestamp, nm_usuario_p text) AS $body$
DECLARE


dt_referencia_w			timestamp;
dt_referencia_ww			timestamp		:= trunc(clock_timestamp());
nr_seq_gerencia_w			bigint	:= coalesce(nr_seq_gerencia_p,0);
nr_seq_gerencia_ww			bigint;
pr_os_antiga_prev_w		double precision;
qt_sla_pendente_total_w		bigint;
qt_sla_prevista_total_w		bigint;
qt_os_prev_total_w			bigint;
qt_os_exec_total_w			bigint;
qt_total_os_ant_prev_w		bigint;
qt_total_def_pendente_w		bigint;
qt_total_os_ger_w		bigint;


c01 CURSOR FOR
SELECT 	substr(coalesce(obter_desc_expressao(c.cd_exp_grupo), c.ds_grupo),1,255) ds_grupo,
	c.nr_sequencia,
	a.pr_defeito,
	a.pr_os_antiga,
	a.pr_satisfacao,
	a.qt_total_os,
	a.qt_os_antiga,
	Obter_Qt_Sla_Pendente( b.nr_sequencia, 	c.nr_sequencia,	null,	'S',	'N', 'GRU') QT_SLA_PENDENTE,
	Obter_Qt_Sla_Pendente( b.nr_sequencia,	c.nr_sequencia,	null,'S', 'N', 'GRUP') QT_SLA_PREVISTA,
	Obter_Qt_Os_Painel(b.nr_sequencia, c.nr_sequencia, 3) qt_total_os_ant_prev,
	somente_numero(Man_Obter_Ordens_Dia(clock_timestamp(),'T',b.nr_sequencia, c.nr_sequencia,'T', nm_usuario_p)) qt_os_prev,
	somente_numero(Man_Obter_Ordens_Dia(clock_timestamp(),'ET',b.nr_sequencia, c.nr_sequencia,'T', nm_usuario_p)) qt_os_exec,
	somente_numero(Man_Obter_Ordens_Dia(clock_timestamp(),'DP',b.nr_sequencia, c.nr_sequencia,'', nm_usuario_p)) qt_defeito_pendente,
	a.qt_encerrada_pessoa,
	a.qt_total_pessoas,
	a.qt_pessoa_ausente
from	grupo_desenvolvimento c,
	gerencia_wheb b,
	w_indicador_desenv_apres a
where	b.nr_sequencia = a.nr_seq_gerencia
and	c.nr_sequencia = a.nr_seq_grupo
and	b.nr_sequencia = c.nr_seq_gerencia
and	a.dt_referencia = dt_referencia_w
and	a.IE_ABRANGENCIA = 'GRU'
and	coalesce(c.ie_gerencia,'N') = 'N'
and	coalesce(a.qt_total_pessoas,0) > 0
and	c.ie_situacao = 'A'
and	b.nr_sequencia	= nr_seq_gerencia_w
order by 1;

vet01	c01%RowType;

c02 CURSOR FOR
SELECT	substr(coalesce(obter_desc_expressao(b.cd_exp_gerencia), b.ds_gerencia),1,255) ds_gerencia,
	b.nr_sequencia,
	a.pr_defeito,
	a.pr_os_antiga,
	a.pr_satisfacao,
	a.qt_total_os,
	a.qt_os_antiga,
	a.qt_encerrada_pessoa,
	a.qt_total_pessoas,
	a.qt_pessoa_ausente
from 	gerencia_wheb b,
	w_indicador_desenv_apres a
where	b.nr_sequencia = a.nr_seq_gerencia
and	a.dt_referencia = dt_referencia_w
and	a.IE_ABRANGENCIA = 'GER'
and	b.nr_sequencia = nr_seq_gerencia_w
and	nr_seq_gerencia_w <> 17
and	coalesce(a.qt_total_pessoas,0) > 0
and	b.ie_situacao = 'A'
and	b.nr_sequencia = nr_seq_gerencia_w;

vet02	c02%RowType;

c03 CURSOR FOR
SELECT	substr(coalesce(obter_desc_expressao(b.cd_exp_gerencia), b.ds_gerencia),1,255) ds_gerencia,
	b.nr_sequencia,
	a.pr_defeito,
	a.pr_os_antiga,
	a.pr_satisfacao,
	a.qt_total_os,
	a.qt_os_antiga,
	Obter_Qt_Sla_Pendente( b.nr_sequencia, 	null,	null,	'S',	'N', 'GER') QT_SLA_PENDENTE,
	Obter_Qt_Sla_Pendente( b.nr_sequencia,	null,	null,'S', 'N', 'GERP') QT_SLA_PREVISTA,
	Obter_Qt_Os_Painel(b.nr_sequencia, null, 3) qt_total_os_ant_prev,
	somente_numero(Man_Obter_Ordens_Dia(clock_timestamp(),'T',b.nr_sequencia, null,'T', nm_usuario_p)) qt_os_prev,
	somente_numero(Man_Obter_Ordens_Dia(clock_timestamp(),'ET',b.nr_sequencia, null,'T', nm_usuario_p)) qt_os_exec,
	somente_numero(Man_Obter_Ordens_Dia(clock_timestamp(),'DP',b.nr_sequencia, null,'', nm_usuario_p)) qt_defeito_pendente,
	a.qt_encerrada_pessoa,
	a.qt_total_pessoas,
	a.qt_pessoa_ausente
from 	gerencia_wheb b,
	w_indicador_desenv_apres a
where	b.nr_sequencia = a.nr_seq_gerencia
and	a.dt_referencia = dt_referencia_w
and	a.ie_abrangencia = 'GER'
and	b.ie_area_gerencia = 'DES';

vet03	c03%RowType;


BEGIN

dt_referencia_w	:= trunc(coalesce(dt_referencia_p,clock_timestamp())-1,'dd');

qt_sla_pendente_total_w	:= 0;
qt_sla_prevista_total_w	:= 0;
qt_os_prev_total_w	:= 0;
qt_os_exec_total_w	:= 0;
qt_total_os_ant_prev_w	:= 0;
qt_total_def_pendente_w	:= 0;

delete from w_painel_ind_desenv
where	dt_referencia	= dt_referencia_ww
and	nm_usuario	= nm_usuario_p;

open C01;
loop
fetch C01 into
	vet01;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	begin
	pr_os_antiga_prev_w	:= coalesce(round((Dividir((vet01.qt_os_antiga - vet01.qt_total_os_ant_prev) , (vet01.qt_total_os - vet01.qt_total_os_ant_prev))  * 100)::numeric,1),0);
	exception when others then
		pr_os_antiga_prev_w	:= 0;
	end;

	if (pr_os_antiga_prev_w < 0) then
		pr_os_antiga_prev_w	:= 0;
	end if;

		vet01.pr_defeito	:= round((Obter_informacao_os_grupo(trunc(clock_timestamp()),vet01.nr_sequencia,'PREX',null))::numeric,1);
		vet01.pr_os_antiga	:= Obter_informacao_os_grupo(trunc(clock_timestamp()),vet01.nr_sequencia,'PRANTIGA',null);
		vet01.qt_total_os	:= Obter_informacao_os_grupo(trunc(clock_timestamp()),vet01.nr_sequencia,'QTBACKLOG',null);
		vet01.pr_satisfacao 	:= (100 - Obter_informacao_os_grupo(trunc(clock_timestamp()),vet01.nr_sequencia,'PRY',null));
		vet01.qt_encerrada_pessoa := (Obter_informacao_os_grupo(trunc(clock_timestamp()),vet01.nr_sequencia,'EN',null) / (vet01.qt_total_pessoas - Obter_informacao_os_grupo(trunc(clock_timestamp()),vet01.nr_sequencia,'QAUSEN','E')));


	insert into w_painel_ind_desenv(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		nr_seq_grupo,
		nr_seq_gerencia,
		ds_informacao,
		pr_defeito,
		pr_os_antiga,
		pr_os_antiga_prev,
		pr_satisfacao,
		dt_referencia,
		ie_abrangencia,
		qt_total_os,
		qt_sla_pendente,
		qt_sla_prevista,
		qt_os_prev,
		qt_os_exec,
		qt_defeito_pendente,
		qt_media_encerrada)
	values (	nextval('w_painel_ind_desenv_seq'),
		clock_timestamp(),
		nm_usuario_p,
		vet01.nr_sequencia,
		nr_seq_gerencia_w,
		vet01.ds_grupo,
		vet01.pr_defeito,
		vet01.pr_os_antiga,
		pr_os_antiga_prev_w,
		vet01.pr_satisfacao,
		dt_referencia_ww,
		'GRU',
		vet01.qt_total_os,
		vet01.qt_sla_pendente,
		vet01.qt_sla_prevista,
		vet01.qt_os_prev,
		vet01.qt_os_exec,
		vet01.qt_defeito_pendente,
		vet01.qt_encerrada_pessoa);

	qt_sla_pendente_total_w	:= qt_sla_pendente_total_w + vet01.qt_sla_pendente;
	qt_sla_prevista_total_w	:= qt_sla_prevista_total_w + vet01.qt_sla_prevista;
	qt_os_prev_total_w	:= qt_os_prev_total_w	+ vet01.qt_os_prev;
	qt_os_exec_total_w	:= qt_os_exec_total_w + vet01.qt_os_exec;
	qt_total_os_ant_prev_w	:= qt_total_os_ant_prev_w + vet01.qt_total_os_ant_prev;
	qt_total_def_pendente_w	:= qt_total_def_pendente_w + vet01.qt_defeito_pendente;
	end;
end loop;
close C01;

pr_os_antiga_prev_w	:= 0;

open C02;
loop
fetch C02 into
	vet02;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin

	pr_os_antiga_prev_w	:= round((Dividir((vet02.qt_os_antiga - qt_total_os_ant_prev_w) , (vet02.qt_total_os - qt_total_os_ant_prev_w))  * 100)::numeric,1);

	if (pr_os_antiga_prev_w < 0) then
		pr_os_antiga_prev_w	:= 0;
	end if;

		vet02.pr_defeito	:= round((obter_informacao_os_gerencia(trunc(clock_timestamp()),nr_seq_gerencia_w,'PREX',null))::numeric,1);
		vet02.pr_os_antiga	:= obter_informacao_os_gerencia(trunc(clock_timestamp()),nr_seq_gerencia_w,'PRANTIGA',null);
		vet02.pr_satisfacao	:= (100 - obter_informacao_os_gerencia(trunc(clock_timestamp()),nr_seq_gerencia_w,'PRI',null));
		vet02.qt_encerrada_pessoa := (obter_informacao_os_gerencia(trunc(clock_timestamp()),nr_seq_gerencia_w,'EN',null) / (vet02.qt_total_pessoas - vet02.qt_pessoa_ausente));
		vet02.qt_total_os 	:= obter_informacao_os_gerencia(trunc(clock_timestamp()),nr_seq_gerencia_w,'QTBACKLOG',null);

		insert into w_painel_ind_desenv(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nr_seq_grupo,
			nr_seq_gerencia,
			ds_informacao,
			pr_defeito,
			pr_os_antiga,
			pr_os_antiga_prev,
			pr_satisfacao,
			dt_referencia,
			ie_abrangencia,
			qt_total_os,
			qt_sla_pendente,
			qt_sla_prevista,
			qt_os_prev,
			qt_os_exec,
			qt_defeito_pendente,
			qt_media_encerrada)
		values (	nextval('w_painel_ind_desenv_seq'),
			clock_timestamp(),
			nm_usuario_p,
			null,
			nr_seq_gerencia_w,
			vet02.ds_gerencia,
			vet02.pr_defeito,
			vet02.pr_os_antiga,
			pr_os_antiga_prev_w,
			vet02.pr_satisfacao,
			trunc(clock_timestamp()),
			'GER',
			vet02.qt_total_os,
			qt_sla_pendente_total_w,
			qt_sla_prevista_total_w,
			qt_os_prev_total_w,
			qt_os_exec_total_w,
			qt_total_def_pendente_w,
			vet02.qt_encerrada_pessoa);

	end;
end loop;
close C02;

/*VisÃ£o gerencial/diretoria*/

if (nr_seq_gerencia_w = 0) then
	begin
	open C03;
	loop
	fetch C03 into
		vet03;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin
		nr_seq_gerencia_w	:= vet03.nr_sequencia;
		pr_os_antiga_prev_w	:= round((Dividir((vet02.qt_os_antiga - qt_total_os_ant_prev_w) , (vet02.qt_total_os - qt_total_os_ant_prev_w))  * 100)::numeric,1);
		qt_sla_pendente_total_w	:= vet03.QT_SLA_PENDENTE;
		qt_sla_prevista_total_w	:= vet03.QT_SLA_PREVISTA;
		qt_os_prev_total_w	:= vet03.qt_os_prev;
		qt_os_exec_total_w	:= vet03.qt_os_exec;
		qt_total_def_pendente_w	:= vet03.qt_defeito_pendente;

		if (pr_os_antiga_prev_w < 0) then
			pr_os_antiga_prev_w	:= 0;
		end if;

		insert into w_painel_ind_desenv(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nr_seq_grupo,
			nr_seq_gerencia,
			ds_informacao,
			pr_defeito,
			pr_os_antiga,
			pr_os_antiga_prev,
			pr_satisfacao,
			dt_referencia,
			ie_abrangencia,
			qt_total_os,
			qt_sla_pendente,
			qt_sla_prevista,
			qt_os_prev,
			qt_os_exec,
			qt_defeito_pendente,
			qt_media_encerrada)
		values (	nextval('w_painel_ind_desenv_seq'),
			clock_timestamp(),
			nm_usuario_p,
			null,
			nr_seq_gerencia_w,
			vet03.ds_gerencia,
			vet03.pr_defeito,
			vet03.pr_os_antiga,
			pr_os_antiga_prev_w,
			vet03.pr_satisfacao,
			trunc(clock_timestamp()),
			'GER',
			vet03.qt_total_os,
			qt_sla_pendente_total_w,
			qt_sla_prevista_total_w,
			qt_os_prev_total_w,
			qt_os_exec_total_w,
			qt_total_def_pendente_w,
			vet03.qt_encerrada_pessoa);
		end;
	end loop;
	close c03;
	end;
end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_painel_desenv (nr_seq_gerencia_p bigint, dt_referencia_p timestamp, nm_usuario_p text) FROM PUBLIC;

