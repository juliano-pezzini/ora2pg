-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_produtividade_vv (dt_referencia_p timestamp, nm_usuario_p text) AS $body$
DECLARE

 
nm_usuario_grupo_w		varchar(100);
cd_pessoa_grupo_w		varchar(20);
nr_sequencia_w			bigint;
dt_referencia_w			timestamp;
qt_casos_teste_w		double precision;
qt_base_cliente_w		double precision;
qt_build_w			double precision;
qt_automacao_w			double precision;
qt_internos_w			double precision;
qt_prp_w			double precision;
dt_inicial_w			timestamp;
dt_final_w			timestamp;

c01 CURSOR FOR 
	SELECT	c.nm_usuario_grupo, 
		obter_pf_usuario(c.nm_usuario_grupo, 'C') 
	from 	gerencia_wheb_grupo a, 
		gerencia_wheb_grupo_usu c 
	where 	c.nr_seq_grupo	= a.nr_sequencia 
	and 	a.ie_situacao	= 'A' 
	and	a.nr_seq_gerencia = 12;


BEGIN 
 
dt_referencia_w		:= trunc(dt_referencia_p, 'dd');
dt_inicial_w		:= trunc(dt_referencia_p, 'month');
dt_final_w		:= dt_referencia_w + 1439/1440;
 
delete	from w_produtividade_vv 
where 	dt_referencia	= dt_referencia_w;
 
open c01;
loop 
fetch c01 into 
	nm_usuario_grupo_w, 
	cd_pessoa_grupo_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin 
	 
		select	nextval('w_produtividade_vv_seq') 
		into STRICT	nr_sequencia_w 
		;
 
		/* Quantidade de casos de testes executados */
 
		select 	count(distinct a.nr_sequencia) 
		into STRICT	qt_casos_teste_w 
		from 	man_ordem_servico a, 
			man_ordem_serv_ativ b 
		where 	a.nr_seq_equipamento 	= 2897 
		and  	a.nr_sequencia 		= b.nr_seq_ordem_serv 
		and  	b.dt_atividade between dt_inicial_w and dt_final_w 
		and	b.nm_usuario_exec	= nm_usuario_grupo_w;
 
 
		/* Quantidade de testes em clientes/projetos especiais */
 
		select 	count(distinct a.nr_sequencia) 
		into STRICT	qt_base_cliente_w 
		from 	man_ordem_servico a, 
			man_ordem_serv_ativ b 
		where 	a.nr_seq_equipamento 	= 7260 
		and  	a.nr_sequencia 		= b.nr_seq_ordem_serv 
		and  	b.dt_atividade between dt_inicial_w and dt_final_w 
		and	b.nm_usuario_exec	= nm_usuario_grupo_w;
 
 
		/* Quantidade de testes em builds */
 
		select 	count(distinct a.nr_sequencia) 
		into STRICT	qt_build_w 
		from 	man_ordem_servico a, 
			man_ordem_serv_ativ b 
		where 	a.nr_seq_equipamento 	= 7261 
		and  	a.nr_sequencia 		= b.nr_seq_ordem_serv 
		and  	b.dt_atividade between dt_inicial_w and dt_final_w 
		and	b.nm_usuario_exec	= nm_usuario_grupo_w;
 
		/* Quantidade de testes em automação */
 
		select 	count(distinct a.nr_sequencia) 
		into STRICT	qt_automacao_w 
		from 	man_ordem_servico a, 
			man_ordem_serv_ativ b 
		where 	a.nr_seq_equipamento 	= 7262 
		and  	a.nr_sequencia 		= b.nr_seq_ordem_serv 
		and  	b.dt_atividade between dt_inicial_w and dt_final_w 
		and	b.nm_usuario_exec	= nm_usuario_grupo_w;
 
		/* Quantidade de ordens internas */
 
		select 	count(distinct a.nr_sequencia) 
		into STRICT	qt_internos_w 
		from 	man_ordem_servico a, 
			man_ordem_serv_ativ b 
		where 	a.nr_seq_equipamento 	= 7263 
		and  	a.nr_sequencia 		= b.nr_seq_ordem_serv 
		and  	b.dt_atividade between dt_inicial_w and dt_final_w 
		and	b.nm_usuario_exec	= nm_usuario_grupo_w;
		 
		/* Quantidade de testes em projetos PRP/NPI */
 
		select 	count(distinct a.nr_sequencia) 
		into STRICT	qt_prp_w 
		from 	man_ordem_servico a, 
			man_ordem_serv_ativ b 
		where 	a.nr_seq_equipamento 	= 7259 
		and  	a.nr_sequencia 		= b.nr_seq_ordem_serv 
		and  	b.dt_atividade between dt_inicial_w and dt_final_w 
		and	b.nm_usuario_exec	= nm_usuario_grupo_w;
 
 
		insert	into w_produtividade_vv(NR_SEQUENCIA     , 
			DT_ATUALIZACAO     , 
			DT_ATUALIZACAO_NREC  , 
			NM_USUARIO       , 
			NM_USUARIO_NREC    , 
			DT_REFERENCIA     , 
			CD_PESSOA_FISICA    , 
			QT_CASOS_TESTE     , 
			QT_BASE_CLIENTE    , 
			QT_BUILD        , 
			QT_AUTOMACAO      , 
			QT_INTERNOS      , 
			QT_PRP) 
		values (nr_sequencia_w, 
			clock_timestamp(), 
			clock_timestamp(), 
			nm_usuario_p, 
			nm_usuario_p, 
			dt_referencia_w, 
			cd_pessoa_grupo_w, 
			qt_casos_teste_w, 
			qt_base_cliente_w, 
			qt_build_w, 
			qt_automacao_w, 
			qt_internos_w, 
			qt_prp_w);
 
		end;
end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_produtividade_vv (dt_referencia_p timestamp, nm_usuario_p text) FROM PUBLIC;

