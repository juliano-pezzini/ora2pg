-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vincular_atend_quimioterapia ( nr_sequencia_p bigint, nr_atendimento_p bigint) AS $body$
DECLARE


nr_prescricao_w  bigint;
nr_prescricao_ww bigint;
dt_liberacao_w  timestamp;
dt_tratamento_w     timestamp;
cd_pessoa_fisica_w varchar(15);
ie_substituir_w  varchar(1);
Vinc_todos_atend_w varchar(1);
cd_estab_w			bigint;
exec_mat_med_prescr_w varchar(1);
ie_verifica_regras_disp_w	varchar(1);
erro_w			varchar(2000);

C01 CURSOR FOR
	SELECT  nr_prescricao
	from    paciente_atendimento
	where   OBTER_CODIGO_PACIENTE_SETOR(nr_seq_paciente) = cd_pessoa_fisica_w
	and	coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_real), ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prevista)) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_tratamento_w);
	
C02 CURSOR FOR
	SELECT	
		a.nr_sequencia		
	from	material b,
	intervalo_prescricao d,
		prescr_material a,
		prescr_medica c
	where	a.cd_material		= b.cd_material
	and 	b.ie_tipo_material 	IN (2,3,6,1)
	and	coalesce(a.nr_sequencia_proc::text, '') = ''
	and 	a.cd_intervalo		= d.cd_intervalo
	and	a.nr_prescricao		= c.nr_prescricao
	and	a.nr_prescricao 	= nr_prescricao_w
	and	a.ie_agrupador NOT IN (3,7,9);
	
BEGIN

ie_substituir_w := obter_param_usuario(3130, 150, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_substituir_w);
Vinc_todos_atend_w := obter_param_usuario(3130, 344, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, Vinc_todos_atend_w);
exec_mat_med_prescr_w := obter_param_usuario(3130, 431, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, exec_mat_med_prescr_w);
ie_verifica_regras_disp_w := obter_param_usuario(3130, 504, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_verifica_regras_disp_w);

update	paciente_atendimento
set	nr_atendimento	= nr_atendimento_p
where	nr_seq_atendimento = nr_sequencia_p;

select	max(nr_prescricao),
	max(coalesce(dt_real,dt_prevista)),
	max(OBTER_CODIGO_PACIENTE_SETOR(nr_seq_paciente))
into STRICT	nr_prescricao_w,
	dt_tratamento_w,
	cd_pessoa_fisica_w
from	paciente_atendimento
where	nr_seq_atendimento = nr_sequencia_p;

if (Vinc_todos_atend_w = 'S') then

	update	paciente_atendimento
	set	nr_atendimento = nr_atendimento_p
	where	OBTER_CODIGO_PACIENTE_SETOR(nr_seq_paciente) = cd_pessoa_fisica_w
	and	coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_real), ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prevista)) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_tratamento_w);


end if;

if	((nr_prescricao_w > 0) and (nr_atendimento_p > 0) and (ie_substituir_w = 'S')) then

	select max(cd_estabelecimento)
	into STRICT	cd_estab_w
	from	atendimento_paciente
	where 	nr_atendimento =  nr_atendimento_p;

	update	prescr_medica
	set	nr_atendimento	= nr_atendimento_p,
		cd_estabelecimento = cd_estab_w
	where	nr_prescricao	= nr_prescricao_w;

    update prescr_mat_hor
    set	nr_atendimento	= nr_atendimento_p
	where	nr_prescricao	= nr_prescricao_w;

	
	/* regras dispensacao */

	if (ie_verifica_regras_disp_w = 'S') then
	begin		
		for c_02_w in C02 
		loop
		Begin		
			CALL ajustar_prescr_material(nr_prescricao_w, c_02_w.nr_sequencia);
			EXCEPTION WHEN OTHERS THEN
				erro_w	:= SQLERRM;
		End;	
		end loop;
	end;
	end if;

  CALL CPOE_Desvincular_atend_prescr(nr_prescricao_w, wheb_usuario_pck.get_nm_usuario);
  CALL CPOE_Vincular_atend_prescr(nr_prescricao_w, nr_atendimento_p, wheb_usuario_pck.get_nm_usuario);

	if (Vinc_todos_atend_w = 'S') then

		open C01;
		loop
		fetch C01 into
			nr_prescricao_ww;
		EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
			update prescr_medica
			set  nr_atendimento = nr_atendimento_p
			where nr_prescricao = nr_prescricao_ww;
            
            update prescr_mat_hor
            set	nr_atendimento	= nr_atendimento_p
            where	nr_prescricao	= nr_prescricao_w;

      CALL CPOE_Desvincular_atend_prescr(nr_prescricao_ww, wheb_usuario_pck.get_nm_usuario);
      CALL CPOE_Vincular_atend_prescr(nr_prescricao_ww, nr_atendimento_p, wheb_usuario_pck.get_nm_usuario);

		end;
		end loop;
		close C01;

	end if;

end if;

commit;

if	((nr_prescricao_w > 0) and (nr_atendimento_p > 0) and (exec_mat_med_prescr_w = 'S')) then

	CALL Executar_material_lib_prescr(nr_prescricao_w, wheb_usuario_pck.get_nm_usuario,'S','S');

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vincular_atend_quimioterapia ( nr_sequencia_p bigint, nr_atendimento_p bigint) FROM PUBLIC;

