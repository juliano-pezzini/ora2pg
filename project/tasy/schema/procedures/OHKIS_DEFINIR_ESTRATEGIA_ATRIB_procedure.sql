-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ohkis_definir_estrategia_atrib ( nm_tabela_p text, nm_atributo_p text, ie_informacao_sensivel_p text, nr_sequencia_p INOUT bigint) AS $body$
DECLARE


nm_tabela_w			tabela_atributo.nm_tabela%type;
nm_atributo_w		tabela_atributo.nm_atributo%type;
ie_obrigatorio_w	tabela_atributo.ie_obrigatorio%type;
ie_tipo_atributo_w	tabela_atributo.ie_tipo_atributo%type;
qt_tamanho_w		tabela_atributo.qt_tamanho%type;
ie_componente_w		tabela_atributo.IE_COMPONENTE%type;
ie_condicao_w		varchar(4);
ie_integridade_w	smallint;
ie_pk_w			smallint;
ie_uk_w			smallint;
ie_flag_w		varchar(1) := 'N';
nr_sequencia_w		bigint;



ds_valor_w 			varchar(2000);
ds_sep_bv_w			varchar(20);
qt_verdade_w		bigint;
ds_comando_w		varchar(2000);
ds_parametro_w  	varchar(2000);



C01 CURSOR FOR
SELECT  a.nm_tabela,
	    a.nm_atributo,
	    a.ie_obrigatorio,
	    a.ie_tipo_atributo,
		a.qt_tamanho,
		coalesce((select max(1) from integridade_atributo c where c.nm_tabela = a.nm_tabela and c.nm_atributo = a.nm_atributo),0) ie_integridade,
		coalesce((SELECT MAX(1) FROM INDICE_ATRIBUTO b, INDICE d WHERE d.nm_tabela = b.nm_tabela AND d.nm_indice = b.nm_indice AND d.nm_tabela = a.nm_tabela AND b.nm_atributo = a.nm_atributo AND d.IE_TIPO in ('PK')),0) ie_pk,
		coalesce((SELECT MAX(1) FROM INDICE_ATRIBUTO b, INDICE d WHERE d.nm_tabela = b.nm_tabela AND d.nm_indice = b.nm_indice AND d.nm_tabela = a.nm_tabela AND b.nm_atributo = a.nm_atributo AND d.IE_TIPO in ('UK')),0) ie_uk,
		ie_componente
from	tabela_atributo a,
	tabela_sistema b
where	a.nm_tabela = b.nm_tabela
and	b.ie_temporaria not in ('G','GD')
and (a.ie_informacao_sensivel = 'S' or ie_informacao_sensivel_p = 'S')
and	a.nm_tabela = nm_tabela_p
and	a.nm_atributo = nm_atributo_p
order	by a.nm_tabela, a.nm_atributo;


BEGIN

open C01;
loop
fetch C01 into
	nm_tabela_w,
	nm_atributo_w,
	ie_obrigatorio_w,
	ie_tipo_atributo_w,
	qt_tamanho_w,
	ie_integridade_w,
	ie_pk_w,
	ie_uk_w,
	ie_componente_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	/*
	SUB_RD /  Substituição - Datas Aleatórias
	*/
	if (ie_tipo_atributo_w = 'DATE') and -- Para campos DATE que não sejam FK ou PK da tabela
		(ie_flag_w = 'N') and (ie_pk_w = 0) and (ie_integridade_w = 0) then
		begin

		select	max(nr_sequencia)
		into STRICT	nr_sequencia_w
		from	decharacterization_rule
		where	nr_strategy = 15
		and 	ie_situacao = 'A';

		ie_flag_w := 'S';

		end;
	end if;
	/*
	NULL / Anulação
	*/
	--verifica_regra_descaracte(nm_tabela_p,nm_atributo_p,23,ie_componente_w,ie_condicao_w);
	ie_condicao_w := OHKIS_obter_regra_estrategia(nm_tabela_p, nm_atributo_p, 23, ie_componente_w, ie_condicao_w);

	if (ie_tipo_atributo_w in ('VARCHAR2','NUMBER','LONG RAW','BLOB','CLOB','LONG')) and (ie_obrigatorio_w = 'N') and -- Não seta nulo para campos obrigatórios
		(ie_pk_w = 0) and -- Não seta nulo para campos que são pks
		(ie_uk_w = 0) and -- Não seta nulo para campos que são uks
		(ie_integridade_w = 0) and -- Não seta nulo para campo que são integridade
		(ie_condicao_w = 'S') and -- Verifica se o atributo está na regra
		(ie_flag_w = 'N')	then
		begin

		select	max(nr_sequencia)
		into STRICT	nr_sequencia_w
		from	decharacterization_rule
		where	nr_strategy = 23
		and 	ie_situacao = 'A';

		ie_flag_w := 'S';
		ie_condicao_w := 'N';

		end;
	end if;
	/*
	SHUFFLE / Embaralhamento / Normal
	*/
	ie_condicao_w := OHKIS_obter_regra_estrategia(nm_tabela_p, nm_atributo_p, 24, ie_componente_w, ie_condicao_w);

	if  ((ie_tipo_atributo_w = 'VARCHAR2') or (ie_tipo_atributo_w = 'NUMBER') or (ie_tipo_atributo_w = 'DATE')) and
		((ie_condicao_w = 'S') or
		(ie_tipo_atributo_w = 'VARCHAR2' AND qt_tamanho_w < 50)) and (ie_integridade_w = 0) and -- Para integridades,  manter o sistema usual
		(ie_pk_w = 0) and (ie_uk_w = 0) and (ie_flag_w = 'N')  then
		begin

		select	max(a.nr_sequencia)
		into STRICT	nr_sequencia_w
		from	decharacterization_rule a
		where	a.nr_strategy = 24
		and 	a.ie_situacao = 'A'
		and 	exists (SELECT 1 from decharacterization_param b where a.nr_sequencia = b.nr_dechar_rule and b.DS_NAME = 'cascadeReferences' and DS_VALUE = 'false');

		ie_flag_w := 'S';
		ie_condicao_w := 'N';

		end;
	end if;
	/*
	SHUFFLE / Embaralhamento / Cascade
	*/
	if	((ie_tipo_atributo_w = 'VARCHAR2') or (ie_tipo_atributo_w = 'NUMBER') or (ie_tipo_atributo_w = 'DATE')) and
		((ie_pk_w = 1) or
		(ie_uk_w = 1 AND ie_tipo_atributo_w <> 'DATE')or (ie_integridade_w = 1)) and -- Somente para PKS e FKs
		(ie_flag_w = 'N')  then
		begin

		select	max(a.nr_sequencia)
		into STRICT	nr_sequencia_w
		from	decharacterization_rule a
		where	a.nr_strategy = 24
		and 	a.ie_situacao = 'A'
		and 	exists (SELECT 1 from decharacterization_param b where a.nr_sequencia = b.nr_dechar_rule and b.DS_NAME = 'cascadeReferences' and DS_VALUE = 'true');

		ie_flag_w := 'S';

		end;
	end if;
	/*
	SUB_RB / Substituição - Boleanos Aleatórios
	*/
	/*
	SUB_RN / Substituição - Números Aleatórios
	*/
	if (ie_tipo_atributo_w = 'NUMBER') AND (ie_pk_w = 0) and -- Não pode primary key
		(ie_uk_w = 0) and -- Não pode primary key
		(ie_integridade_w = 0) and -- Não pode gerar para integridades
		(ie_flag_w = 'N')  then --Não pode campo que tem integridade
		begin


		if (qt_tamanho_w < 9) then

			select	max(a.nr_sequencia)
			into STRICT	nr_sequencia_w
			from	decharacterization_rule a
			where	a.nr_strategy = 14
			and 	a.ie_situacao = 'A'
			and 	exists (SELECT 1 from decharacterization_param b where a.nr_sequencia = b.nr_dechar_rule and b.DS_NAME = 'maxValue' and DS_VALUE = '9');

		else

			select	max(a.nr_sequencia)
			into STRICT	nr_sequencia_w
			from	decharacterization_rule a
			where	a.nr_strategy = 14
			and 	a.ie_situacao = 'A'
			and 	exists (SELECT 1 from decharacterization_param b where a.nr_sequencia = b.nr_dechar_rule and b.DS_NAME = 'maxValue' and DS_VALUE = '99999');

		end if;


		ie_flag_w := 'S';


		end;
	end if;
	/*
	CUSTOM / Algoritmo customizado
	*/
	ie_condicao_w := OHKIS_obter_regra_estrategia(nm_tabela_p, nm_atributo_p, 16, ie_componente_w, ie_condicao_w);

	if (ie_tipo_atributo_w in ('LONG RAW','BLOB')) and (ie_pk_w = 0) and -- Não pode gerar para PKs
		(ie_uk_w = 0) and -- Não pode gerar para UKs
		(ie_integridade_w = 0) and -- Não pode gerar para integridades
		(ie_obrigatorio_w = 'S') and (ie_condicao_w = 'S') and (ie_flag_w = 'N')  then
		begin

		select	max(a.nr_sequencia)
		into STRICT	nr_sequencia_w
		from	decharacterization_rule a
		where	a.nr_strategy = 16
		and 	a.ie_situacao = 'A';

		end;
	end if;
	/*
	SUB_RC / Substituição - Caracteres Aleatórios
	*/
	if (ie_tipo_atributo_w in ('VARCHAR2','LONG','CLOB')) and (ie_pk_w = 0) and -- Não pode gerar para PKs
		(ie_uk_w = 0) and -- Não pode gerar para UKs
		(ie_integridade_w = 0) and -- Não pode gerar para integridades
		(ie_flag_w = 'N')  then
		begin


		if (qt_tamanho_w <= 255) then

			select	max(a.nr_sequencia)
			into STRICT	nr_sequencia_w
			from	decharacterization_rule a
			where	a.nr_strategy = 13
			and 	a.ie_situacao = 'A'
			and 	exists (SELECT 1 from decharacterization_param b where a.nr_sequencia = b.nr_dechar_rule and b.DS_NAME = 'maxChars' and DS_VALUE = '50');

		elsif (qt_tamanho_w <= 1000) then

			select	max(a.nr_sequencia)
			into STRICT	nr_sequencia_w
			from	decharacterization_rule a
			where	a.nr_strategy = 13
			and 	a.ie_situacao = 'A'
			and 	exists (SELECT 1 from decharacterization_param b where a.nr_sequencia = b.nr_dechar_rule and b.DS_NAME = 'maxChars' and DS_VALUE = '255');

		elsif (qt_tamanho_w <= 2000) then

			select	max(a.nr_sequencia)
			into STRICT	nr_sequencia_w
			from	decharacterization_rule a
			where	a.nr_strategy = 13
			and 	a.ie_situacao = 'A'
			and 	exists (SELECT 1 from decharacterization_param b where a.nr_sequencia = b.nr_dechar_rule and b.DS_NAME = 'maxChars' and DS_VALUE = '1000');

		elsif	((qt_tamanho_w <= 4000) or (ie_tipo_atributo_w in ('LONG','CLOB'))) then

			select	max(a.nr_sequencia)
			into STRICT	nr_sequencia_w
			from	decharacterization_rule a
			where	a.nr_strategy = 13
			and 	a.ie_situacao = 'A'
			and 	exists (SELECT 1 from decharacterization_param b where a.nr_sequencia = b.nr_dechar_rule and b.DS_NAME = 'maxChars' and DS_VALUE = '4000');

		end if;

		ie_flag_w := 'S';

		end;
	end if;

	ie_flag_w := 'N';
	end;
end loop;
close C01;

nr_sequencia_p :=  nr_sequencia_w;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ohkis_definir_estrategia_atrib ( nm_tabela_p text, nm_atributo_p text, ie_informacao_sensivel_p text, nr_sequencia_p INOUT bigint) FROM PUBLIC;

