-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_curva_fornecedor_mat (dt_inicio_p timestamp, dt_final_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, cd_material_p bigint, cd_operacao_nf_p bigint) AS $body$
DECLARE

 
cd_cnpj_w  		varchar(14);
vl_total_nota_w  	double precision := 0;
nr_sequencia_w  	bigint;
vl_acumulado_w  	double precision := 0;
vl_total_gerar_notas_w double precision;
pr_valor_w  		double precision := 0;
pr_acumulado_w  	double precision := 0;
cd_tipo_pessoa_w 	smallint;
cd_grupo_material_w 	bigint;
cd_subgrupo_material_w bigint;
cd_classe_material_w 	bigint;
cd_material_w  	bigint;
dt_final_w		timestamp;
cd_operacao_nf_w 	bigint;

 
c01 CURSOR FOR 
SELECT a.cd_cgc_emitente, 
 sum(b.vl_liquido) vl_total, 
 substr(obter_dados_pf_pj(null,a.cd_cgc_emitente,'TP'),1,3) 
from nota_fiscal a, 
 nota_fiscal_item b, 
 estrutura_material_v e 
where a.nr_sequencia = b.nr_sequencia 
and b.cd_material = e.cd_material 
and a.dt_emissao between dt_inicio_p and dt_final_w 
and a.cd_estabelecimento = cd_estabelecimento_p 
and (e.cd_grupo_material = cd_grupo_material_w or cd_grupo_material_w = 0) 
and (e.cd_subgrupo_material = cd_subgrupo_material_w or cd_subgrupo_material_w = 0) 
and (e.cd_classe_material = cd_classe_material_w or cd_classe_material_w = 0) 
and (e.cd_material = cd_material_w or cd_material_w = 0) 
and (a.cd_operacao_nf = cd_operacao_nf_w or cd_operacao_nf_w = 0) 
and a.ie_situacao = '1' 
and a.ie_tipo_nota = 'EN' 
and b.vl_liquido > 0 
group by a.cd_cgc_emitente 
order by vl_total desc;


BEGIN 
cd_grupo_material_w := coalesce(cd_grupo_material_p,0);
cd_subgrupo_material_w := coalesce(cd_subgrupo_material_p,0);
cd_classe_material_w := coalesce(cd_classe_material_p,0);
cd_material_w  := coalesce(cd_material_p,0);
dt_final_w	:= (trunc(coalesce(dt_final_p,clock_timestamp()),'dd') + 86399/86400);
cd_operacao_nf_w :=	coalesce(cd_operacao_nf_p,0);
 
 
delete from w_gerar_curva_fornec_mat;
 
 
select	sum(b.vl_liquido) vl_total 
into STRICT	vl_total_gerar_notas_w 
from	nota_fiscal a, 
	nota_fiscal_item b, 
	estrutura_material_v e 
where	a.nr_sequencia = b.nr_sequencia 
and	b.cd_material = e.cd_material 
and	a.dt_emissao between dt_inicio_p and dt_final_w 
and	a.cd_estabelecimento = cd_estabelecimento_p 
and	a.ie_situacao = '1' 
and (e.cd_grupo_material = cd_grupo_material_w or cd_grupo_material_w = 0) 
and (e.cd_subgrupo_material = cd_subgrupo_material_w or cd_subgrupo_material_w = 0) 
and (e.cd_classe_material = cd_classe_material_w or cd_classe_material_w = 0) 
and (e.cd_material = cd_material_w or cd_material_w = 0) 
and (a.cd_operacao_nf = cd_operacao_nf_w or cd_operacao_nf_w = 0) 
and	a.ie_tipo_nota = 'EN' 
and	b.vl_liquido > 0 
order by	b.nr_item_nf;
 
open C01;
loop 
fetch C01 into 
	cd_cnpj_w, 
	vl_total_nota_w, 
	cd_tipo_pessoa_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
begin 
vl_acumulado_w	:= vl_acumulado_w + vl_total_nota_w;
pr_valor_w	:= dividir((vl_total_nota_w * 100),vl_total_gerar_notas_w);
pr_acumulado_w	:= dividir((vl_acumulado_w * 100),vl_total_gerar_notas_w);
 
insert into w_gerar_curva_fornec_mat( 
	nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	cd_cnpj, 
	vl_total_item, 
	vl_acumulado, 
	pr_valor, 
	pr_acumulado, 
	cd_tipo_pessoa) 
 values ( nextval('w_gerar_curva_fornec_mat_seq'), 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	cd_cnpj_w, 
	vl_total_nota_w, 
	vl_acumulado_w, 
	pr_valor_w, 
	pr_acumulado_w, 
	cd_tipo_pessoa_w);
 
end;
end loop;
close C01;
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_curva_fornecedor_mat (dt_inicio_p timestamp, dt_final_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, cd_material_p bigint, cd_operacao_nf_p bigint) FROM PUBLIC;

