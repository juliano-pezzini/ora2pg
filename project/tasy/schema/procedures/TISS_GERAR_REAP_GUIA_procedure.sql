-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_gerar_reap_guia ( nr_seq_conta_reap_p bigint, nm_usuario_p text) AS $body$
DECLARE


dt_atualizacao_w			timestamp;
dt_autorizacao_w			timestamp;
dt_validade_senha_w		timestamp;
dt_emissao_guia_w			timestamp;
dt_fim_vigencia_w			timestamp;
ie_honorario_w			varchar(3);
ie_tiss_tipo_guia_w			varchar(3);
ie_tipo_atend_tiss_w		varchar(5);
nm_usuario_w			varchar(15);
cd_autorizacao_w			varchar(20);
nr_guia_prestador_w		varchar(40);
cd_senha_autor_w			varchar(40);
ds_indicacao_clinica_w		varchar(255);
ds_observacao_w			varchar(4000);
cd_convenio_w			integer;
nr_seq_conta_guia_w		bigint;
nr_interno_conta_w			bigint;
cd_pessoa_exec_w			varchar(50);
cd_pessoa_exec_compl_w		varchar(50);
cd_pessoa_solic_w			varchar(50);
cd_pessoa_solic_compl_w		varchar(50);
cd_cgc_solic_w			varchar(50);
nr_seq_contrat_w			bigint;
nr_seq_contrat_solic_w		bigint;
nm_contratado_w			varchar(255);
nr_cpf_w				varchar(255);
nr_cpf_compl_w			varchar(255);
nm_contratado_compl_w		varchar(255);
cd_cgc_exec_w			varchar(255);
nr_cpf_solic_w			varchar(255);
nm_solicitante_W			varchar(255);
cd_cnes_exec_w			varchar(255);
nr_atendimento_w			bigint;
nr_seq_tipo_acidente_w		bigint;
dt_entrada_w			timestamp;
ie_tipo_acidente_w			varchar(255);
cd_doenca_w			varchar(30) 	:= null;
ie_classif_doenca_w		varchar(30) 	:= null;
ie_tipo_doenca_w			varchar(30) 	:= null;
ie_unidade_tempo_w		varchar(30) 	:= null;
qt_tempo_w			bigint 	:= null;
ds_doenca_w			varchar(255) 	:= null;
cd_tabela_doenca_w		varchar(30) 	:= null;		
ds_diagnostico_w			varchar(255);
ie_tipo_acomodacao_w		varchar(255);
ds_endereco_w			varchar(255);
nr_endereco_w			varchar(255);
cd_municipio_ibge_w		varchar(255);
ds_municipio_w			varchar(255);
sg_estado_w			varchar(255);
cd_cep_w			varchar(255);
nm_contratado_solic_w		varchar(255);
sg_conselho_w			varchar(255);
uf_conselho_solic_w		varchar(255);
nr_crm_solic_w			varchar(255);
nr_Seq_conselho_w		bigint;
sg_conselho_solic_W		varchar(255);
nr_seq_conselho_exec_w		bigint;
ie_tipo_saida_w			varchar(255);
uf_conselho_exec_w		varchar(255);		
nr_crm_exec_w			varchar(255);
sg_conselho_exec_w		varchar(255);
ie_grau_partic_tiss_w		varchar(255);
ds_complemento_w		varchar(255);
cd_ans_w			varchar(255);
cd_interno_solic_w			varchar(255);
cd_interno_exec_w			varchar(255);
cd_cid_reap_w			varchar(10);
ie_tipo_doenca_reap_w		varchar(2);
ie_unidade_tempo_reap_w		varchar(2);
qt_tempo_reap_w			bigint;
ie_mascara_cid_w			varchar(10);
ds_doenca_reap_w			varchar(255) 	:= null;
nr_seq_tipo_saida_spsadt_w		bigint;
cd_autorizacao_princ_w			varchar(20);

c01 CURSOR FOR
SELECT	a.cd_doenca,
	a.ie_classificacao_doenca,
	a.ie_tipo_doenca,
	a.ie_unidade_tempo,
	a.qt_tempo,
	substr(OBTER_DESC_CID_DOENCA(a.CD_DOENCA),1,70) ds_cid,
	'CID-10' cd_tabela_cid,
	substr(a.ds_diagnostico,1,255)
from	cid_doenca c,
	diagnostico_medico b,
	diagnostico_doenca a
where	a.nr_atendimento		= nr_atendimento_w
and	a.nr_atendimento		= b.nr_atendimento
and	a.dt_diagnostico		= b.dt_diagnostico
and	c.cd_doenca_cid		= a.cd_doenca
and	c.ie_situacao		= 'A'
and	c.ie_cad_interno		= 'N'
order by a.dt_diagnostico desc;

c02 CURSOR FOR
SELECT	ie_tipo_acidente
from	tiss_tipo_acidente
where	nr_seq_acidente		= nr_seq_tipo_acidente_w
and	coalesce(dt_inicio_vigencia, to_date('01/01/1900','dd/mm/yyyy')) <= dt_entrada_w
order by coalesce(dt_inicio_vigencia, to_date('01/01/1900','dd/mm/yyyy'));


BEGIN

select	a.nr_interno_conta,
	b.ie_tiss_tipo_guia,
	a.cd_autorizacao,
	a.dt_atualizacao,
	a.nm_usuario,
	a.dt_autorizacao,
	cd_senha_autor,
	a.dt_validade_senha,
	a.dt_emissao_guia,
	b.cd_convenio,
	lpad(a.ie_tipo_atend_tiss,2,0),
	'N' ie_honorario,
	a.ds_indicacao_clinica,
	a.nr_guia_prestador,
	a.ds_observacao,
	a.cd_pessoa_exec,
	a.cd_pessoa_exec_compl,
	a.cd_pessoa_solic,
	a.cd_pessoa_solic_compl,
	a.cd_cgc_exec,
	a.cd_cgc_solic,
	a.ie_grau_partic_tiss,
	a.cd_interno_solic,
	a.cd_interno_exec,
	a.nr_seq_tipo_saida_spsadt,
	a.nr_guia_principal
into STRICT	nr_interno_conta_w,
	ie_tiss_tipo_guia_w,
	cd_autorizacao_w,
	dt_atualizacao_w,
	nm_usuario_w,
	dt_autorizacao_w,
	cd_senha_autor_w,
	dt_validade_senha_w,
	dt_emissao_guia_w,
	cd_convenio_w,
	ie_tipo_atend_tiss_w,
	ie_honorario_w,
	ds_indicacao_clinica_w,
	nr_guia_prestador_w,
	ds_observacao_w,
	cd_pessoa_exec_w,
	cd_pessoa_exec_compl_w,
	cd_pessoa_solic_w,
	cd_pessoa_solic_compl_w,
	cd_cgc_exec_w,
	cd_cgc_solic_w,
	ie_grau_partic_tiss_w,
	cd_interno_solic_w,
	cd_interno_exec_w,
	nr_seq_tipo_saida_spsadt_w,
	cd_autorizacao_princ_w
from	tiss_reap_conta a,
	tiss_reap_lote b
where	a.nr_seq_lote		= b.nr_sequencia
and	a.nr_sequencia		= nr_seq_conta_reap_p;

select	max(a.nr_atendimento),
	max(d.nr_seq_tipo_acidente),
	coalesce(max(a.dt_entrada_tiss), max(d.dt_entrada))
into STRICT	nr_atendimento_w,
	nr_seq_tipo_acidente_w,
	dt_entrada_w
from	pessoa_juridica c,
	convenio b,
	atendimento_paciente d,
	conta_paciente a
where	a.cd_convenio_parametro	= b.cd_convenio
and	a.nr_atendimento		= d.nr_atendimento
and	b.cd_cgc			= c.cd_cgc
and	a.nr_interno_conta		= nr_interno_conta_w;

select	coalesce(max(b.ie_mascara_cid), 'N')
into STRICT	ie_mascara_cid_w
from	tiss_parametros_convenio b,
	conta_paciente a
where	a.cd_convenio_parametro	= b.cd_convenio
and	a.cd_estabelecimento	= b.cd_estabelecimento
and	a.nr_interno_conta	= nr_interno_conta_w;


ie_tipo_acidente_w		:= '2';  -- Outros
open c02;
loop
fetch c02 into
	ie_tipo_acidente_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
end loop;
close c02;

open c01;
loop
fetch c01 into
	cd_doenca_w,
	ie_classif_doenca_w,
	ie_tipo_doenca_w,
	ie_unidade_tempo_w,
	qt_tempo_w,
	ds_doenca_w,
	cd_tabela_doenca_w,
	ds_diagnostico_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
end loop;
close c01;

select	max(cd_doenca),
	max(ie_tipo_doenca),
	max(ie_unidade_tempo),
	max(qt_tempo),
	max(substr(OBTER_DESC_CID_DOENCA(cd_doenca),1,70))
into STRICT	cd_cid_reap_w,
	ie_tipo_doenca_reap_w,
	ie_unidade_tempo_reap_w,
	qt_tempo_reap_w,
	ds_doenca_reap_w
from	tiss_reap_diag
where	nr_seq_conta	= nr_seq_conta_reap_p;

if (ie_mascara_cid_w	= 'S') then
	cd_cid_reap_w	:= tiss_obter_cid_mascara(cd_cid_reap_w);
end if;
	

select	nextval('tiss_conta_guia_seq'),
	nextval('tiss_conta_contrat_solic_seq'),
	nextval('tiss_conta_contrat_exec_seq')
into STRICT	nr_seq_conta_guia_w,
	nr_seq_contrat_solic_w,
	nr_seq_contrat_w
;

select	obter_cpf_pessoa_fisica(cd_pessoa_exec_w),
	obter_cpf_pessoa_fisica(cd_pessoa_exec_compl_w),
	substr(obter_nome_pf_pj(cd_pessoa_exec_compl_w,null),1,254)
into STRICT	nr_cpf_w,
	nr_cpf_compl_w,
	nm_contratado_compl_w
;

select	obter_cpf_pessoa_fisica(coalesce(cd_pessoa_solic_w,cd_pessoa_solic_compl_w)),
	substr(obter_nome_pf_pj(coalesce(cd_pessoa_solic_w,cd_pessoa_solic_compl_w),null),1,254),
	substr(obter_nome_pf_pj(null,cd_cgc_solic_w),1,254)
into STRICT	nr_cpf_solic_w,
	nm_solicitante_w,
	nm_contratado_solic_w
;

-- Dados profissionais do solicitante
select	max(nr_seq_conselho)
into STRICT	nr_seq_conselho_w
from	pessoa_fisica
where	cd_pessoa_fisica	= coalesce(cd_pessoa_solic_w,cd_pessoa_solic_compl_w);

select	max(sg_conselho)
into STRICT	sg_conselho_solic_w
from	conselho_profissional
where	nr_sequencia		= nr_seq_conselho_w;

select	max(uf_crm),
	max(nr_crm)
into STRICT	uf_conselho_solic_w,
	nr_crm_solic_w
from	medico
where	cd_pessoa_fisica	= coalesce(cd_pessoa_solic_w,cd_pessoa_solic_compl_w);

-- Dados profissionais do executante
select	max(nr_seq_conselho)
into STRICT	nr_seq_conselho_exec_w
from	pessoa_fisica
where	cd_pessoa_fisica	= cd_pessoa_exec_w;

select	max(sg_conselho)
into STRICT	sg_conselho_exec_w
from	conselho_profissional
where	nr_sequencia		= nr_seq_conselho_exec_w
and	(sg_conselho IS NOT NULL AND sg_conselho::text <> '');

select	max(uf_crm),
	max(nr_crm)
into STRICT	uf_conselho_exec_w,
	nr_crm_exec_w
from	medico
where	cd_pessoa_fisica	= cd_pessoa_exec_w;

select	max(tiss_obter_tipo_saida(CASE WHEN ie_tiss_tipo_guia_w='4' THEN 'SPSADT' WHEN ie_tiss_tipo_guia_w='5' THEN 'I' END , nr_interno_conta_w))
into STRICT	ie_tipo_saida_w
;

select	substr(max(ds_razao_social),1,70),
	substr(max(cd_cnes),1,254),
	substr(max(ds_endereco), 1,254),
	substr(max(ds_municipio),1,254),
	substr(max(lpad(coalesce(cd_municipio_ibge, 0),7,0)),1,254),
	substr(max(cd_cep),1,254),
	substr(max(sg_estado),1,254),
	substr(max(lpad(coalesce(m.cd_tipo_logradouro, '081'),3,'0')),1,254),
	substr(max(nr_endereco),1,254),
	substr(max(ds_complemento),1,254)
into STRICT	nm_contratado_w,
	cd_cnes_exec_w,
	ds_endereco_w,
	ds_municipio_w,
	cd_municipio_ibge_w,
	cd_cep_w,
	sg_estado_w,
	ie_tipo_acomodacao_w,
	nr_endereco_w,
	ds_complemento_w
FROM pessoa_juridica a
LEFT OUTER JOIN cns_tipo_logradouro m ON (a.nr_seq_tipo_logradouro = m.nr_sequencia)
WHERE cd_cgc			= cd_cgc_exec_w;

if (coalesce(cd_cgc_solic_w,0) > 0) then
	nr_cpf_solic_w	:= null;
end if;

if (coalesce(cd_cgc_exec_w,0) > 0) then
	nr_cpf_w	:= null;
end if;

select	max(a.cd_ans)
into STRICT	cd_ans_w
from	pessoa_juridica a
where	a.cd_cgc	= obter_cgc_convenio(cd_convenio_w);

insert into tiss_conta_guia(
	nr_sequencia,
	nr_interno_conta,
	ie_tiss_tipo_guia,
	dt_atualizacao,
	cd_autorizacao,
	nm_usuario,
	dt_autorizacao,
	cd_senha,
	dt_validade_senha,
	dt_emissao_guia,
	cd_convenio,
	ie_tipo_atend_tiss,
	ie_honorario,
	ds_indicacao,
	nr_guia_prestador,
	ds_observacao,
	nr_seq_reap_conta,
	ie_tipo_acidente,
	ie_tipo_cid,
	cd_tabela_cid,
	cd_cid,
	ds_cid,
	ie_tipo_saida,
	cd_autorizacao_princ,
	cd_ans,
	ie_unidade_tempo_cid,
	qt_tempo_cid)
values (	nr_seq_conta_guia_w,
	nr_interno_conta_w,
	ie_tiss_tipo_guia_w,
	clock_timestamp(),
	cd_autorizacao_w,
	nm_usuario_w,
	dt_autorizacao_w,
	cd_senha_autor_w,
	dt_validade_senha_w,
	dt_emissao_guia_w,
	cd_convenio_w,
	ie_tipo_atend_tiss_w,
	ie_honorario_w,
	ds_indicacao_clinica_w,
	nr_guia_prestador_w,
	ds_observacao_w,
	nr_seq_conta_reap_p,
	ie_tipo_acidente_w,
	coalesce(ie_tipo_doenca_reap_w,ie_tipo_doenca_w),
	'CID-10',
	coalesce(cd_cid_reap_w,cd_doenca_w),
	coalesce(ds_doenca_reap_w,ds_doenca_w),
	coalesce(nr_seq_tipo_saida_spsadt_w,ie_tipo_saida_w),
	cd_autorizacao_princ_w,
	cd_ans_w,
	coalesce(ie_unidade_tempo_reap_w,ie_unidade_tempo_w),
	coalesce(qt_tempo_reap_w,qt_tempo_w));

insert into tiss_conta_contrat_exec(
	nr_seq_guia,
	dt_atualizacao,
	nm_usuario,
	nr_sequencia,
	nm_contratado,
	nr_cpf,
	nr_cpf_compl,
	nm_exec_compl,
	cd_cgc,
	cd_cnes,
	ie_tipo_logradouro,
	ds_logradouro,
	nr_endereco,
	ds_complemento,
	cd_municipio_ibge,
	nm_municipio,
	sg_estado,
	cd_cep,
	uf_conselho_compl,
	sg_conselho_compl,
	nr_crm_compl,
	ie_funcao_medico_compl,
	cd_interno)
values (	nr_seq_conta_guia_w,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_contrat_w,
	nm_contratado_w,
	nr_cpf_w,
	nr_cpf_compl_w,
	nm_contratado_compl_w,
	--decode(cd_interno_exec_w, 'X', cd_cgc_exec_w),
	cd_cgc_exec_w,
	cd_cnes_exec_w,
	ie_tipo_acomodacao_w,
	ds_endereco_w,
	nr_endereco_w,
	ds_complemento_w,
	cd_municipio_ibge_w,
	ds_municipio_w,
	sg_estado_w,
	cd_cep_w,
	uf_conselho_exec_w,
	sg_conselho_exec_w,
	nr_crm_exec_w,
	ie_grau_partic_tiss_w,
	cd_interno_exec_w);
	
insert into tiss_conta_contrat_solic(
	nr_seq_guia,
	dt_atualizacao,
	nm_usuario,
	nr_sequencia,
	nr_cpf,
	nm_solicitante,
	nm_contratado,
	cd_cgc,
	sg_conselho_solic,
	uf_conselho_solic,
	nr_crm_solic,
	cd_interno)
values (	nr_seq_conta_guia_w,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_contrat_solic_w,
	nr_cpf_solic_w,
	nm_solicitante_w,
	nm_contratado_solic_w,
	--decode(cd_interno_solic_w, 'X', cd_cgc_solic_w),
	cd_cgc_solic_w,
	sg_conselho_solic_w,
	uf_conselho_solic_w,
	nr_crm_solic_w,
	cd_interno_solic_w);		

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_gerar_reap_guia ( nr_seq_conta_reap_p bigint, nm_usuario_p text) FROM PUBLIC;

