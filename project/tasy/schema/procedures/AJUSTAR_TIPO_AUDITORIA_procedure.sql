-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ajustar_tipo_auditoria ( nr_seq_auditoria_p bigint, cd_item_p bigint, cd_setor_atendimento_p bigint, dt_conta_p timestamp, vl_unitario_p bigint, nm_usuario_p text, ie_tipo_item_p bigint, ie_tipo_ajuste_p text, cd_material_tiss_p text Default Null, nr_seq_motivo_p bigint default null) AS $body$
DECLARE


nr_seq_item_w	material_atend_paciente.nr_sequencia%type;

C01 CURSOR FOR
	SELECT	b.nr_sequencia
	from 	auditoria_matpaci a,
		material_atend_paciente b
	where	a.nr_seq_matpaci = b.nr_sequencia
	and	a.nr_seq_auditoria = nr_seq_auditoria_p
	and	b.cd_material = cd_item_p
	and	coalesce((SELECT max(x.cd_setor_atendimento) from atend_paciente_unidade x where x.nr_seq_interno = a.nr_seq_atepacu_ajuste),b.cd_setor_atendimento) = cd_setor_atendimento_p
	and	trunc(b.dt_conta) = trunc(dt_conta_p);

C02 CURSOR FOR
	SELECT	b.nr_sequencia
	from 	auditoria_propaci a,
		procedimento_paciente b
	where	a.nr_seq_propaci = b.nr_sequencia
	and	a.nr_seq_auditoria = nr_seq_auditoria_p
	and	b.cd_procedimento = cd_item_p
	and	coalesce((SELECT max(x.cd_setor_atendimento) from atend_paciente_unidade x where x.nr_seq_interno = a.nr_seq_atepacu_ajuste),b.cd_setor_atendimento) = cd_setor_atendimento_p
	and	trunc(b.dt_conta) = trunc(dt_conta_p);

C03 CURSOR FOR
	SELECT	b.nr_sequencia
	from 	auditoria_matpaci a,
		material_atend_paciente b
	where	a.nr_seq_matpaci = b.nr_sequencia
	and	a.nr_seq_auditoria = nr_seq_auditoria_p
	and	b.cd_material = cd_item_p
	and	coalesce((SELECT max(x.cd_setor_atendimento) from atend_paciente_unidade x where x.nr_seq_interno = a.nr_seq_atepacu_ajuste),b.cd_setor_atendimento) = cd_setor_atendimento_p
	and	b.vl_unitario = vl_unitario_p
	and	((b.cd_material_tiss = cd_material_tiss_p) or (coalesce(cd_material_tiss_p::text, '') = ''));

C04 CURSOR FOR
	SELECT	b.nr_sequencia
	from 	auditoria_propaci a,
		procedimento_paciente b
	where	a.nr_seq_propaci = b.nr_sequencia
	and	a.nr_seq_auditoria = nr_seq_auditoria_p
	and	b.cd_procedimento = cd_item_p
	and	coalesce((SELECT max(x.cd_setor_atendimento) from atend_paciente_unidade x where x.nr_seq_interno = a.nr_seq_atepacu_ajuste),b.cd_setor_atendimento) = cd_setor_atendimento_p;


BEGIN

if (coalesce(ie_tipo_ajuste_p,'DIA') = 'DIA') then

	if (ie_tipo_item_p = 1) then
		open C01;
		loop
		fetch C01 into
			nr_seq_item_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			update	auditoria_matpaci
			set	ie_tipo_auditoria = 'D',
				nm_usuario 	 = nm_usuario_p,
				dt_atualizacao 	 = clock_timestamp(),
				nr_seq_motivo	 = CASE WHEN coalesce(nr_seq_motivo_p,0)=0 THEN nr_seq_motivo  ELSE nr_seq_motivo_p END
			where	nr_seq_auditoria = nr_seq_auditoria_p
			and	nr_seq_matpaci = nr_seq_item_w;
			end;
		end loop;
		close C01;
	elsif (ie_tipo_item_p = 2) then
		open C02;
		loop
		fetch C02 into
			nr_seq_item_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			update	auditoria_propaci
			set	ie_tipo_auditoria = 'D',
				nm_usuario = nm_usuario_p,
				dt_atualizacao 	 = clock_timestamp(),
				nr_seq_motivo	 = CASE WHEN coalesce(nr_seq_motivo_p,0)=0 THEN nr_seq_motivo  ELSE nr_seq_motivo_p END
			where	nr_seq_auditoria = nr_seq_auditoria_p
			and	nr_seq_propaci = nr_seq_item_w;
			end;
		end loop;
		close C02;
	end if;

elsif (coalesce(ie_tipo_ajuste_p,'DIA') = 'SETOR') then

	if (ie_tipo_item_p = 1) then
		open C03;
		loop
		fetch C03 into
			nr_seq_item_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			update	auditoria_matpaci
			set	ie_tipo_auditoria = 'D',
				nm_usuario = nm_usuario_p,
				dt_atualizacao = clock_timestamp(),
				nr_seq_motivo	 = CASE WHEN coalesce(nr_seq_motivo_p,0)=0 THEN nr_seq_motivo  ELSE nr_seq_motivo_p END
			where	nr_seq_auditoria = nr_seq_auditoria_p
			and	nr_seq_matpaci = nr_seq_item_w;
			end;
		end loop;
		close C03;
	elsif (ie_tipo_item_p = 2) then
		open C04;
		loop
		fetch C04 into
			nr_seq_item_w;
		EXIT WHEN NOT FOUND; /* apply on C04 */
			begin
			update	auditoria_propaci
			set	ie_tipo_auditoria = 'D',
				nm_usuario = nm_usuario_p,
				dt_atualizacao = clock_timestamp(),
				nr_seq_motivo	 = CASE WHEN coalesce(nr_seq_motivo_p,0)=0 THEN nr_seq_motivo  ELSE nr_seq_motivo_p END
			where	nr_seq_auditoria = nr_seq_auditoria_p
			and	nr_seq_propaci = nr_seq_item_w;
			end;
		end loop;
		close C04;
	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ajustar_tipo_auditoria ( nr_seq_auditoria_p bigint, cd_item_p bigint, cd_setor_atendimento_p bigint, dt_conta_p timestamp, vl_unitario_p bigint, nm_usuario_p text, ie_tipo_item_p bigint, ie_tipo_ajuste_p text, cd_material_tiss_p text Default Null, nr_seq_motivo_p bigint default null) FROM PUBLIC;

