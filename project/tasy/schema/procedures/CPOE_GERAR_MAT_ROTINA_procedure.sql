-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_mat_rotina ( nr_atendimento_p bigint, nm_usuario_p text, cd_perfil_p bigint, nr_seq_rotina_p bigint, dt_inicio_p timestamp default null, cd_paciente_p text DEFAULT NULL, ds_mat_rotina_p INOUT text  DEFAULT NULL) AS $body$
DECLARE


nr_sequencia_w          cpoe_material.nr_sequencia%type;
cd_material_w           cpoe_material.cd_material%type;
cd_unidade_medida_w     cpoe_material.cd_unidade_medida%type;
qt_dose_w               cpoe_material.qt_dose%type;
cd_intervalo_w          cpoe_material.cd_intervalo%type;
ds_horarios_w           cpoe_material.ds_horarios%type;
ie_via_aplicacao_w      cpoe_material.ie_via_aplicacao%type;
ie_urgencia_w           cpoe_material.ie_urgencia%type;
ie_separado_adep_w      cpoe_material.ie_separado_adep%type;
ie_tipo_assoc_w         cpoe_material.ie_tipo_assoc%type;

ds_stack_w        log_cpoe.ds_stack%type;
ds_log_cpoe_w      log_cpoe.ds_log%type;

nr_seq_acum_w           bigint;
hr_prim_horario_w       char(5);
dt_inicio_w             timestamp;
cd_setor_atendimento_w  bigint;
qt_idade_pac_w          real;
dt_fim_w                timestamp;
ie_intervalo_fixo_w	    varchar(1);
cd_motivo_baixa_w	    smallint;
ds_observacao_w		    varchar(255);

C01 CURSOR FOR
SELECT a.cd_setor_atendimento,
    a.cd_material,
    a.cd_unidade_medida,
    a.qt_dose,
    a.cd_intervalo,
    a.ie_via_aplicacao,
    a.ds_horarios,
    coalesce(a.ie_intervalo_fixo,'N'),
    a.cd_motivo_baixa,
    a.ds_observacao,
    coalesce(a.ie_checar_adep,'N')
from
    mat_prescr_rotina a
where
    a.nr_seq_rotina = nr_seq_rotina_p
    and (
        (cd_setor_atendimento_w = a.cd_setor_atendimento)
        or (coalesce(a.cd_setor_atendimento::text, '') = '')
    )
    and (
        (
            (coalesce(qt_idade_pac_w::text, '') = '')
            or (
                coalesce(a.qt_idade_min::text, '') = ''
                and coalesce(a.qt_idade_max::text, '') = ''
            )
        )
        or ( 
            (qt_idade_pac_w IS NOT NULL AND qt_idade_pac_w::text <> '')
            and (
                qt_idade_pac_w between coalesce(a.qt_idade_min, qt_idade_pac_w)
                and coalesce(a.qt_idade_max, qt_idade_pac_w)
            )
        )
    );


BEGIN

SELECT obter_idade(a.dt_nascimento, clock_timestamp(), 'A')
into STRICT qt_idade_pac_w
FROM PESSOA_FISICA a, ATENDIMENTO_PACIENTE b
WHERE a.cd_pessoa_fisica = b.cd_pessoa_fisica
AND b.nr_atendimento = nr_atendimento_p;

open C01;
loop fetch C01 into
    cd_setor_atendimento_w,
    cd_material_w,
    cd_unidade_medida_w,
    qt_dose_w,
    cd_intervalo_w,
    ie_via_aplicacao_w,
    ds_horarios_w,
    ie_intervalo_fixo_w,
    cd_motivo_baixa_w,
    ds_observacao_w,
    ie_separado_adep_w;
EXIT WHEN NOT FOUND; /* apply on C01  */

select	nextval('cpoe_material_seq')
		into STRICT	nr_sequencia_w
		;

dt_inicio_w := obter_prox_hora_cheia_gpt(clock_timestamp());

hr_prim_horario_w := to_char(dt_inicio_w, 'hh24:mi');

dt_fim_w := (dt_inicio_w + 1) - (1 / 86400);

if (coalesce(ds_mat_rotina_p::text, '') = '') then
  ds_mat_rotina_p := nr_sequencia_w || ';' || obter_desc_material(cd_material_w) || ';MA';
else
  ds_mat_rotina_p := nr_sequencia_w || ';' || obter_desc_material(cd_material_w)|| ';MA' || ',' || ds_mat_rotina_p;
end if;

insert into
    cpoe_material(
        nr_sequencia,
        nr_atendimento,
        cd_material,
        qt_dose,
        cd_unidade_medida,
        ie_via_aplicacao,
        cd_intervalo,
        hr_prim_horario,
        ds_horarios,
        nm_usuario,
        nm_usuario_nrec,
        dt_atualizacao,
        dt_atualizacao_nrec,
        cd_perfil_ativo,
        cd_pessoa_fisica,
        cd_funcao_origem,
        qt_unitaria,
        nr_ocorrencia,
        dt_inicio,
        ie_separado_adep,
        ie_material,
        ie_forma_geracao,
        ie_administracao,
        ie_duracao
    )
values (
    nr_sequencia_w,
    nr_atendimento_p,
    cd_material_w,
    qt_dose_w,
    cd_unidade_medida_w,
    ie_via_aplicacao_w,
    cd_intervalo_w,
    hr_prim_horario_w,
    ds_horarios_w,
    nm_usuario_p,
    nm_usuario_p,
    clock_timestamp(),
    clock_timestamp(),
    cd_perfil_p,
    cd_paciente_p,
    2314,
    obter_conversao_unid_med_cons(cd_material_w, cd_unidade_medida_w, qt_dose_w),
    obter_ocorrencias_horarios_rep(ds_horarios_w),
    dt_inicio_p,
    ie_separado_adep_w,
    'S',
    'P',
    'P',
    'P'
);

end loop;

close C01;

commit;

exception
   when others then
  rollback;

  ds_stack_w  := substr('Backtrace: '|| dbms_utility.format_error_backtrace ||
			' CallStack: '|| dbms_utility.format_call_stack,1,2000);

  ds_log_cpoe_w := substr('CPOE_GERAR_MAT_ROTINA '
    || chr(13) || ' - nr_atendimento_p: ' || nr_atendimento_p
    || chr(13) || ' - nr_seq_rotina_p: ' || nr_seq_rotina_p
    || chr(13) || ' - cd_perfil_p: ' || cd_perfil_p
    || chr(13) || ' - cd_paciente_p: ' || cd_paciente_p
    || chr(13) || ' - nm_usuario_p: ' || nm_usuario_p
    || chr(13) || ' - dt_inicio_p: ' || to_char(dt_inicio_p,'dd/mm/yyyy hh24:mi:ss')
    || chr(13) || ' - ERRO: ' || sqlerrm
    || chr(13) || ' - FUNCAO('||to_char(obter_funcao_ativa)||'); PERFIL('||to_char(obter_perfil_ativo)||')'
    ,1,2000);

  insert into log_cpoe(
    nr_sequencia,
    nr_atendimento,
    dt_atualizacao,
    nm_usuario,
    ds_log,
    ds_stack)
  values (
    nextval('log_cpoe_seq'),
    nr_atendimento_p,
    clock_timestamp(),
    nm_usuario_p,
    ds_log_cpoe_w,
    ds_stack_w);

  commit;

  CALL wheb_mensagem_pck.exibir_mensagem_abort(sqlerrm);

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_mat_rotina ( nr_atendimento_p bigint, nm_usuario_p text, cd_perfil_p bigint, nr_seq_rotina_p bigint, dt_inicio_p timestamp default null, cd_paciente_p text DEFAULT NULL, ds_mat_rotina_p INOUT text  DEFAULT NULL) FROM PUBLIC;

