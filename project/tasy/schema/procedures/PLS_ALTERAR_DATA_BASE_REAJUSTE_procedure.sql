-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alterar_data_base_reajuste ( nr_seq_contrato_p bigint, ie_reajuste_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


ie_reajuste_w		varchar(255);
ie_reajuste_ww		pls_contrato.ie_reajuste%type;
dt_reajuste_contrato_w	timestamp;


BEGIN
select	CASE WHEN ie_reajuste='C' THEN 'Reajuste do contrato' WHEN ie_reajuste='A' THEN 'Reajuste do beneficiário' END ,
	ie_reajuste,
	coalesce(dt_reajuste, dt_contrato)
into STRICT	ie_reajuste_w,
	ie_reajuste_ww,
	dt_reajuste_contrato_w
from	pls_contrato
where	nr_sequencia = nr_seq_contrato_p;

if (ie_reajuste_ww <> ie_reajuste_p) then
	update	pls_contrato
	set	ie_reajuste		= ie_reajuste_p,
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp()
	where	nr_sequencia		= nr_seq_contrato_p;

	CALL pls_atualizar_mes_reaj_pck.alterar_dt_base_reajuste(nr_seq_contrato_p, ie_reajuste_p, (to_char(dt_reajuste_contrato_w,'mm'))::numeric , nm_usuario_p, cd_estabelecimento_p);

	insert into pls_contrato_historico(	nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_estabelecimento,
			nr_seq_contrato,
			dt_historico,
			ie_tipo_historico,
			ds_historico,
			ds_observacao)
		values (	nextval('pls_contrato_historico_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_estabelecimento_p,
			nr_seq_contrato_p,
			clock_timestamp(),
			'27',
			'Alteração do campo : ' || ie_reajuste_w || ' para : ' || CASE WHEN ie_reajuste_p='C' THEN 'Reajuste do contrato' WHEN ie_reajuste_p='A' THEN 'Reajuste do beneficiário' END ,'pls_alterar_data_base_reajuste');
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alterar_data_base_reajuste ( nr_seq_contrato_p bigint, ie_reajuste_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

