-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_retorno_lote_audit ( nr_seq_retorno_p bigint, nr_lote_p text, dt_baixa_cr_p timestamp, nr_seq_hist_audit_p bigint, nr_seq_conta_banco_p bigint, ie_acao_historico_p bigint, ie_baixar_lote_p text, nm_usuario_p text) AS $body$
DECLARE

cd_convenio_w		integer;
cd_estabelecimento_w	integer;
dt_inicial_w		timestamp;
dt_final_w		timestamp;
nr_seq_lote_w		bigint;


BEGIN 
 
select	max(a.cd_convenio), 
	max(a.cd_estabelecimento) 
into STRICT	cd_convenio_w, 
	cd_estabelecimento_w 
from	convenio_retorno a 
where	a.nr_sequencia	= nr_seq_retorno_p;
 
select	min(b.dt_historico), 
	max(b.dt_historico) 
into STRICT	dt_inicial_w, 
	dt_final_w 
from	conta_paciente e, 
	conta_paciente_retorno d, 
	hist_audit_conta_paciente c, 
	conta_paciente_ret_hist b, 
	convenio_retorno_item a 
where	e.cd_estabelecimento	= cd_estabelecimento_w 
and	d.nr_interno_conta	= e.nr_interno_conta 
and	d.cd_convenio		= cd_convenio_w 
and	b.nr_seq_conpaci_ret	= d.nr_sequencia 
and	c.ie_acao		= coalesce(ie_acao_historico_p,c.ie_acao) 
and	b.nr_seq_hist_audit	= c.nr_sequencia 
and	b.nr_seq_hist_audit	= coalesce(nr_seq_hist_audit_p,b.nr_seq_hist_audit) 
and	coalesce(b.nr_seq_lote_audit::text, '') = '' 
and	a.nr_sequencia		= b.nr_seq_ret_item 
and	a.nr_seq_retorno	= nr_seq_retorno_p 
and	not exists (SELECT	1 
	from	titulo_receber_liq x 
	where	coalesce(x.vl_glosa,0)	> 0 
	and	x.nr_seq_ret_item	= a.nr_sequencia 
	and	coalesce(a.vl_amenor,0)	= 0);
 
if (coalesce(dt_inicial_w::text, '') = '') then 
	/* Não foi localizado nenhum histórico pendente na auditoria */
 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(187590);
end if;
 
select	nextval('lote_audit_tit_rec_seq') 
into STRICT	nr_seq_lote_w
;
 
insert	into lote_audit_tit_rec(cd_convenio, 
	cd_estabelecimento, 
	dt_atualizacao, 
	dt_atualizacao_nrec, 
	dt_baixa_cr, 
	dt_final, 
	dt_inicial, 
	ie_acao_historico, 
	nm_usuario, 
	nm_usuario_nrec, 
	nr_lote, 
	nr_seq_conta_banco, 
	nr_seq_hist_audit, 
	nr_seq_retorno, 
	nr_sequencia) 
values (cd_convenio_w, 
	cd_estabelecimento_w, 
	clock_timestamp(), 
	clock_timestamp(), 
	coalesce(dt_baixa_cr_p,clock_timestamp()), 
	dt_final_w, 
	dt_inicial_w, 
	ie_acao_historico_p, 
	nm_usuario_p, 
	nm_usuario_p, 
	coalesce(nr_lote_p,nr_seq_lote_w), 
	nr_seq_conta_banco_p, 
	nr_seq_hist_audit_p, 
	nr_seq_retorno_p, 
	nr_seq_lote_w);
 
CALL gerar_lote_audit_tit_rec(nr_seq_lote_w,nm_usuario_p);
 
if (coalesce(ie_baixar_lote_p,'S') = 'S') then 
	CALL baixar_lote_audit_tit_rec(nr_seq_lote_w,nm_usuario_p,'I');
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_retorno_lote_audit ( nr_seq_retorno_p bigint, nr_lote_p text, dt_baixa_cr_p timestamp, nr_seq_hist_audit_p bigint, nr_seq_conta_banco_p bigint, ie_acao_historico_p bigint, ie_baixar_lote_p text, nm_usuario_p text) FROM PUBLIC;

