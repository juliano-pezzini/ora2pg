-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_inserir_procedimento_fav ( nr_atendimento_p cpoe_procedimento.nr_atendimento%type, nr_sequencia_p cpoe_fav_procedimento.nr_sequencia%type, nm_usuario_p cpoe_fav_procedimento.nm_usuario%type, cd_perfil_p bigint, cd_estabelecimento_p bigint, cd_pessoa_fisica_p cpoe_procedimento.cd_pessoa_fisica%type, nr_seq_item_gerado_p INOUT bigint, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, ie_oncologia_p text default 'N', nr_seq_conclusao_apae_p bigint default null, ie_futuro_p text default 'N', cd_setor_atendimento_p bigint default null, nr_seq_cpoe_rp_p cpoe_rp.nr_sequencia%type default null, nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) AS $body$
DECLARE

						
nr_sequencia_w					cpoe_procedimento.nr_sequencia%type;
nr_seq_proc_interno_w			cpoe_procedimento.nr_seq_proc_interno%type;
qt_procedimento_w				cpoe_procedimento.qt_procedimento%type;
nr_seq_topografia_w				cpoe_procedimento.nr_seq_topografia%type;
ds_observacao_w					cpoe_procedimento.ds_observacao%type;
cd_intervalo_w					cpoe_procedimento.cd_intervalo%type;
cd_intervalo_agora_w			cpoe_procedimento.cd_intervalo%type;
ie_urgencia_w					cpoe_procedimento.ie_urgencia%type;
ie_urgencia_mat1_w				cpoe_procedimento.ie_urgencia_mat1%type;
ie_urgencia_mat2_w				cpoe_procedimento.ie_urgencia_mat2%type;
ie_urgencia_mat3_w				cpoe_procedimento.ie_urgencia_mat3%type;
ie_urgencia_mat4_w				cpoe_procedimento.ie_urgencia_mat4%type;
ie_urgencia_mat5_w				cpoe_procedimento.ie_urgencia_mat5%type;
ie_urgencia_mat6_w				cpoe_procedimento.ie_urgencia_mat6%type;
ie_urgencia_mat7_w				cpoe_procedimento.ie_urgencia_mat7%type;
cd_material_exame_w				cpoe_procedimento.cd_material_exame%type;
ds_material_especial_w			cpoe_procedimento.ds_material_especial%type;
ie_se_necessario_w				cpoe_procedimento.ie_se_necessario%type;
ie_acm_w						cpoe_procedimento.ie_acm%type;
ie_lado_w						cpoe_procedimento.ie_lado%type;
ie_duracao_w					cpoe_procedimento.ie_duracao%type;
ie_periodo_w					cpoe_procedimento.ie_periodo%type;
cd_mat_proc1_w					cpoe_procedimento.cd_mat_proc1%type;
cd_mat_proc2_w					cpoe_procedimento.cd_mat_proc2%type;
cd_mat_proc3_w					cpoe_procedimento.cd_mat_proc3%type;
cd_mat_proc4_w					cpoe_procedimento.cd_mat_proc4%type;
cd_mat_proc5_w					cpoe_procedimento.cd_mat_proc5%type;
cd_mat_proc6_w					cpoe_procedimento.cd_mat_proc6%type;
cd_mat_proc7_w					cpoe_procedimento.cd_mat_proc7%type;
ie_administracao_w				cpoe_procedimento.ie_administracao%type;
ie_via_mat_proc1_w				cpoe_procedimento.ie_via_mat_proc1%type;
ie_via_mat_proc2_w				cpoe_procedimento.ie_via_mat_proc2%type;
ie_via_mat_proc3_w				cpoe_procedimento.ie_via_mat_proc3%type;
ie_via_mat_proc4_w				cpoe_procedimento.ie_via_mat_proc4%type;
ie_via_mat_proc5_w				cpoe_procedimento.ie_via_mat_proc5%type;
ie_via_mat_proc6_w				cpoe_procedimento.ie_via_mat_proc6%type;
ie_via_mat_proc7_w				cpoe_procedimento.ie_via_mat_proc7%type;
ie_adm_mat1_w					cpoe_procedimento.ie_adm_mat1%type;
ie_adm_mat2_w 					cpoe_procedimento.ie_adm_mat2%type;
ie_adm_mat3_w					cpoe_procedimento.ie_adm_mat3%type;
ie_adm_mat4_w					cpoe_procedimento.ie_adm_mat4%type;
ie_adm_mat5_w					cpoe_procedimento.ie_adm_mat5%type;
ie_adm_mat6_w					cpoe_procedimento.ie_adm_mat6%type;
ie_adm_mat7_w					cpoe_procedimento.ie_adm_mat7%type;
ie_evento_unico_w				cpoe_procedimento.ie_evento_unico%type;
qt_dose_mat1_w					cpoe_procedimento.qt_dose_mat1%type;
qt_dose_mat2_w					cpoe_procedimento.qt_dose_mat2%type;
qt_dose_mat3_w					cpoe_procedimento.qt_dose_mat3%type;
qt_dose_mat4_w					cpoe_procedimento.qt_dose_mat4%type;
qt_dose_mat5_w					cpoe_procedimento.qt_dose_mat5%type;
qt_dose_mat6_w					cpoe_procedimento.qt_dose_mat6%type;
qt_dose_mat7_w					cpoe_procedimento.qt_dose_mat7%type;
cd_unid_medida_dose_mat1_w		cpoe_procedimento.cd_unid_medida_dose_mat1%type;
cd_unid_medida_dose_mat2_w		cpoe_procedimento.cd_unid_medida_dose_mat2%type;
cd_unid_medida_dose_mat3_w		cpoe_procedimento.cd_unid_medida_dose_mat3%type;
cd_unid_medida_dose_mat4_w		cpoe_procedimento.cd_unid_medida_dose_mat4%type;
cd_unid_medida_dose_mat5_w		cpoe_procedimento.cd_unid_medida_dose_mat5%type;
cd_unid_medida_dose_mat6_w		cpoe_procedimento.cd_unid_medida_dose_mat6%type;
cd_unid_medida_dose_mat7_w		cpoe_procedimento.cd_unid_medida_dose_mat7%type;
nr_seq_prot_glic_w				cpoe_procedimento.nr_seq_prot_glic%type;
cd_interv_proc1_w				cpoe_procedimento.cd_interv_proc1%type;
cd_interv_proc2_w				cpoe_procedimento.cd_interv_proc2%type;
cd_interv_proc3_w 				cpoe_procedimento.cd_interv_proc3%type;
cd_interv_proc4_w 				cpoe_procedimento.cd_interv_proc4%type;
cd_interv_proc5_w 				cpoe_procedimento.cd_interv_proc5%type;
cd_interv_proc6_w 				cpoe_procedimento.cd_interv_proc6%type;
cd_interv_proc7_w 				cpoe_procedimento.cd_interv_proc7%type;
ie_dur_proc1_w					cpoe_procedimento.ie_dur_proc1%type;
ie_dur_proc2_w					cpoe_procedimento.ie_dur_proc2%type;
ie_dur_proc3_w					cpoe_procedimento.ie_dur_proc3%type;
ie_dur_proc4_w					cpoe_procedimento.ie_dur_proc4%type;
ie_dur_proc5_w					cpoe_procedimento.ie_dur_proc5%type;
ie_dur_proc6_w					cpoe_procedimento.ie_dur_proc6%type;
ie_dur_proc7_w					cpoe_procedimento.ie_dur_proc7%type;
ds_obser_proc1_w				cpoe_procedimento.ds_obser_proc1%type;
ds_obser_proc2_w				cpoe_procedimento.ds_obser_proc2%type;
ds_obser_proc3_w				cpoe_procedimento.ds_obser_proc3%type;
ds_obser_proc4_w				cpoe_procedimento.ds_obser_proc4%type;
ds_obser_proc5_w				cpoe_procedimento.ds_obser_proc5%type;
ds_obser_proc6_w				cpoe_procedimento.ds_obser_proc6%type;
ds_obser_proc7_w				cpoe_procedimento.ds_obser_proc7%type;
ie_assoc_adep1_w				cpoe_procedimento.ie_assoc_adep1%type;
ie_assoc_adep2_w				cpoe_procedimento.ie_assoc_adep2%type;
ie_assoc_adep3_w				cpoe_procedimento.ie_assoc_adep3%type;
ie_assoc_adep4_w				cpoe_procedimento.ie_assoc_adep4%type;
ie_assoc_adep5_w				cpoe_procedimento.ie_assoc_adep5%type;
ie_assoc_adep6_w				cpoe_procedimento.ie_assoc_adep6%type;
ie_assoc_adep7_w				cpoe_procedimento.ie_assoc_adep7%type;
dt_inicio_w						cpoe_procedimento.dt_inicio%type;
dt_prev_execucao_w				cpoe_procedimento.dt_prev_execucao%type;
hr_prim_horario_w				cpoe_procedimento.hr_prim_horario%type;
ds_horarios_w					cpoe_procedimento.ds_horarios%type;
ds_horarios_aux_w				cpoe_procedimento.ds_horarios%type;
dt_fim_w						cpoe_procedimento.dt_fim%type;
ds_hor_proc_w					cpoe_procedimento.ds_hor_proc1%type;
dt_inicio_proc_w				cpoe_procedimento.dt_inicio_proc1%type;
hr_prim_hor_proc_w       		cpoe_procedimento.hr_prim_hor_proc1%type;
nr_seq_condicao_w				cpoe_procedimento.nr_seq_condicao%type;
ds_dado_clinico_w				cpoe_procedimento.ds_dado_clinico%type;
cd_pessoa_fisica_w				cpoe_procedimento.cd_pessoa_fisica%type;
ie_anestesia_w					cpoe_procedimento.ie_anestesia%type;
nr_seq_contraste_w				cpoe_procedimento.nr_seq_contraste%type;
cd_setor_entrega_w				cpoe_procedimento.cd_setor_entrega%type;
cd_medico_exec_w				cpoe_procedimento.cd_medico_exec%type;

cd_setor_atend_prescr_w		    setor_atendimento.cd_setor_atendimento%type;

qt_min_intervalo_w				intervalo_prescricao.qt_min_intervalo%type;
ie_dose_unica_cpoe_w			intervalo_prescricao.ie_dose_unica_cpoe%type;

cd_procedimento_w				prescr_procedimento.cd_procedimento%type;
ie_origem_proced_w				prescr_procedimento.ie_origem_proced%type;
nr_ocorrencia_w					prescr_procedimento.nr_ocorrencia%type;

nr_seq_mat_w					cpoe_material.nr_sequencia%type;

ie_possuir_hor_dia_seguinte_w 	char(1):='N';
dt_primeiro_horario_w	        timestamp;
ie_prescr_alta_agora_w			varchar(1);

c01 CURSOR FOR						
SELECT	nr_seq_proc_interno,
		qt_procedimento,
		nr_seq_topografia,
		ds_observacao,
		cd_intervalo,
		ie_urgencia,
		ie_urgencia_mat1,
		ie_urgencia_mat2,
		ie_urgencia_mat3,
		ie_urgencia_mat4,
		ie_urgencia_mat5,
		ie_urgencia_mat6,
		ie_urgencia_mat7,
		cd_material_exame,
		ds_material_especial,
		ie_se_necessario,
		ie_acm,
		ie_lado,
		ie_duracao,
		ie_periodo,
		cd_mat_proc1,
		cd_mat_proc2,
		cd_mat_proc3,
		cd_mat_proc4,
		cd_mat_proc5,
		cd_mat_proc6,
		cd_mat_proc7,
		ie_administracao,
		ie_via_mat_proc1,
		ie_via_mat_proc2,
		ie_via_mat_proc3,
		ie_via_mat_proc4,
		ie_via_mat_proc5,
		ie_via_mat_proc6,
		ie_via_mat_proc7,
		ie_adm_mat1,
		ie_adm_mat2,
		ie_adm_mat3,
		ie_adm_mat4,
		ie_adm_mat5,
		ie_adm_mat6,
		ie_adm_mat7,
		ie_evento_unico,
		qt_dose_mat1,
		qt_dose_mat2,
		qt_dose_mat3,
		qt_dose_mat4,
		qt_dose_mat5,
		qt_dose_mat6,
		qt_dose_mat7,
		cd_unid_medida_dose_mat1,
		cd_unid_medida_dose_mat2,
		cd_unid_medida_dose_mat3,
		cd_unid_medida_dose_mat4,
		cd_unid_medida_dose_mat5,
		cd_unid_medida_dose_mat6,
		cd_unid_medida_dose_mat7,
		nr_seq_prot_glic,
		cd_interv_proc1,
		cd_interv_proc2,
		cd_interv_proc3,
		cd_interv_proc4,
		cd_interv_proc5,
		cd_interv_proc6,
		cd_interv_proc7,
		ie_dur_proc1,
		ie_dur_proc2,
		ie_dur_proc3,
		ie_dur_proc4,
		ie_dur_proc5,
		ie_dur_proc6,
		ie_dur_proc7,
		ds_obser_proc1,
		ds_obser_proc2,
		ds_obser_proc3,
		ds_obser_proc4,
		ds_obser_proc5,
		ds_obser_proc6,
		ds_obser_proc7,
		ie_assoc_adep1,
		ie_assoc_adep2,
		ie_assoc_adep3,
		ie_assoc_adep4,
		ie_assoc_adep5,
		ie_assoc_adep6,
		ie_assoc_adep7,
		nr_seq_condicao,
		ds_dado_clinico,
		ie_anestesia,
		nr_seq_contraste,
		cd_setor_entrega,
		cd_medico_exec
from	cpoe_fav_procedimento
where	nr_sequencia = nr_sequencia_p;

/*
Cursor C02 is
	select	--nr_sequencia,
			--nr_atendimento,

			cd_material,
			qt_dose,
			cd_unidade_medida,
			ie_via_aplicacao,
			cd_intervalo,
			hr_prim_horario,
			ds_horarios,
			dt_inicio,
			ie_urgencia,
			ie_duracao,
			ie_administracao
			--dt_fim

	from	cpoe_material
	where	ie_material = 'S'
	and nr_seq_procedimento = nr_sequencia_p;

	c02_w c02%rowtype;						
	*/
procedure gerar_item_assoc_proced(
						ie_material_p		 			bigint,
						nr_sequencia_p					cpoe_procedimento.nr_sequencia%type,
						cd_mat_proc_p					cpoe_procedimento.cd_mat_proc1%type,
						qt_dose_mat_p					cpoe_procedimento.qt_dose_mat1%type,
						cd_unid_medida_dose_mat_p		cpoe_procedimento.cd_unid_medida_dose_mat1%type,
						ie_via_mat_proc_p				cpoe_procedimento.ie_via_mat_proc1%type,
						ie_adm_mat_p					cpoe_procedimento.ie_adm_mat1%type,
						cd_interv_proc_p				cpoe_procedimento.cd_interv_proc1%type,
						ie_urgencia_mat_p				cpoe_procedimento.ie_urgencia_mat1%type,
						ie_dur_proc_p					cpoe_procedimento.ie_dur_proc1%type,
						ds_obser_proc_p					cpoe_procedimento.ds_obser_proc1%type,
						ie_assoc_adep_p					cpoe_procedimento.ie_assoc_adep1%type) is
	;
BEGIN
	ds_hor_proc_w 		:= '';
	dt_inicio_proc_w 	:= dt_inicio_w;
	ds_horarios_aux_w	:= '';
	hr_prim_hor_proc_w 	:= '';
	if (ie_adm_mat_p IS NOT NULL AND ie_adm_mat_p::text <> '') and (ie_adm_mat_p = 'P') then
		
		if (coalesce(ie_urgencia_mat_p::text, '') = '') then
			dt_inicio_proc_w := trunc(dt_inicio_proc_w,'hh24') + 1/24;
		elsif (ie_urgencia_mat_p = '0') then
			dt_inicio_proc_w := trunc(dt_inicio_proc_w,'hh24') + 1/1440;
		elsif (ie_urgencia_mat_p = '5') then
			dt_inicio_proc_w := trunc(dt_inicio_proc_w,'hh24') + 5/1440;
		elsif (ie_urgencia_mat_p = '10') then
			dt_inicio_proc_w := trunc(dt_inicio_proc_w,'hh24') + 10/1440;
		elsif (ie_urgencia_mat_p = '15') then
			dt_inicio_proc_w := trunc(dt_inicio_proc_w,'hh24') + 15/1440;
		end if;
		
		hr_prim_hor_proc_w := to_char(dt_inicio_proc_w,'hh24:mi');
		
		nr_ocorrencia_w	:= 0;
		SELECT * FROM cpoe_calcular_horario_prescr(	nr_atendimento_p, cd_interv_proc_p, cd_mat_proc_p, dt_inicio_proc_w, 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_hor_proc_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null) INTO STRICT nr_ocorrencia_w, ds_hor_proc_w, ds_horarios_aux_w;
		ds_hor_proc_w	:= ds_hor_proc_w || ds_horarios_aux_w;
	end if;
		
	CALL exec_sql_dinamico_bv(
		'CPOE',
			' update	cpoe_procedimento ' ||
			' set		cd_mat_proc'||ie_material_p||' = :cd_mat_proc_w, ' ||
			' 			ie_via_mat_proc'||ie_material_p||' = :ie_via_mat_proc_w, ' ||
			' 			qt_dose_mat'||ie_material_p||' = :qt_dose_mat_w, ' ||
			' 			cd_unid_medida_dose_mat'||ie_material_p||' = :cd_unid_medida_dose_mat_w, ' ||
			' 			cd_interv_proc'||ie_material_p||' = :cd_interv_proc_w, ' ||
			' 			ds_hor_proc'||ie_material_p||' = :ds_hor_proc_w, ' ||
			' 			dt_inicio_proc'||ie_material_p||' = :dt_inicio_proc_w, ' ||
			' 			hr_prim_hor_proc'||ie_material_p||' = :hr_prim_hor_proc_w, ' ||
			' 			ds_obser_proc'||ie_material_p||' = :ds_obser_proc_w, ' ||
			' 			ie_urgencia_mat'||ie_material_p||' = :ie_urgencia_mat_w, ' ||
			' 			ie_adm_mat'||ie_material_p||' = :ie_adm_mat_w, ' ||
			' 			ie_dur_proc'||ie_material_p||' = :ie_dur_proc_w, ' ||
			' 			ie_assoc_adep'||ie_material_p||' = :ie_assoc_adep_w ' ||
			' where		nr_sequencia = :nr_sequencia_p ',
		'cd_mat_proc_w='||cd_mat_proc_p||
		'#@#@ie_via_mat_proc_w='||ie_via_mat_proc_p||
		'#@#@qt_dose_mat_w='||qt_dose_mat_p||
		'#@#@cd_unid_medida_dose_mat_w='||cd_unid_medida_dose_mat_p||
		'#@#@cd_interv_proc_w='||cd_interv_proc_p||
		'#@#@ds_hor_proc_w='||ds_hor_proc_w||
		'#@#@dt_inicio_proc_w='||trunc(dt_inicio_proc_w)||
		'#@#@hr_prim_hor_proc_w='||hr_prim_hor_proc_w||
		'#@#@ds_obser_proc_w='||ds_obser_proc_p||
		'#@#@ie_urgencia_mat_w='||ie_urgencia_mat_p||
		'#@#@ie_adm_mat_w='||ie_adm_mat_p||
		'#@#@ie_dur_proc_w='||ie_dur_proc_p||
		'#@#@ie_assoc_adep_w='||ie_assoc_adep_p||
		'#@#@nr_sequencia_p='||nr_sequencia_p||
		'#@#@');
	commit;
		
	end;
	
begin

ie_prescr_alta_agora_w := obter_param_usuario(924, 409, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_prescr_alta_agora_w);
open c01;
loop
fetch c01 into	nr_seq_proc_interno_w,
				qt_procedimento_w,
				nr_seq_topografia_w,
				ds_observacao_w,
				cd_intervalo_w,
				ie_urgencia_w,
				ie_urgencia_mat1_w,
				ie_urgencia_mat2_w,
				ie_urgencia_mat3_w,
				ie_urgencia_mat4_w,
				ie_urgencia_mat5_w,
				ie_urgencia_mat6_w,
				ie_urgencia_mat7_w,
				cd_material_exame_w,
				ds_material_especial_w,
				ie_se_necessario_w,
				ie_acm_w,
				ie_lado_w,
				ie_duracao_w,
				ie_periodo_w,
				cd_mat_proc1_w,
				cd_mat_proc2_w,
				cd_mat_proc3_w,
				cd_mat_proc4_w,
				cd_mat_proc5_w,
				cd_mat_proc6_w,
				cd_mat_proc7_w,
				ie_administracao_w,
				ie_via_mat_proc1_w,
				ie_via_mat_proc2_w,
				ie_via_mat_proc3_w,
				ie_via_mat_proc4_w,
				ie_via_mat_proc5_w,
				ie_via_mat_proc6_w,
				ie_via_mat_proc7_w,
				ie_adm_mat1_w,
				ie_adm_mat2_w,
				ie_adm_mat3_w,
				ie_adm_mat4_w,
				ie_adm_mat5_w,
				ie_adm_mat6_w,
				ie_adm_mat7_w,
				ie_evento_unico_w,
				qt_dose_mat1_w,
				qt_dose_mat2_w,
				qt_dose_mat3_w,
				qt_dose_mat4_w,
				qt_dose_mat5_w,
				qt_dose_mat6_w,
				qt_dose_mat7_w,
				cd_unid_medida_dose_mat1_w,
				cd_unid_medida_dose_mat2_w,
				cd_unid_medida_dose_mat3_w,
				cd_unid_medida_dose_mat4_w,
				cd_unid_medida_dose_mat5_w,
				cd_unid_medida_dose_mat6_w,
				cd_unid_medida_dose_mat7_w,
				nr_seq_prot_glic_w,
				cd_interv_proc1_w,
				cd_interv_proc2_w,
				cd_interv_proc3_w,
				cd_interv_proc4_w,
				cd_interv_proc5_w,
				cd_interv_proc6_w,
				cd_interv_proc7_w,
				ie_dur_proc1_w,
				ie_dur_proc2_w,
				ie_dur_proc3_w,
				ie_dur_proc4_w,
				ie_dur_proc5_w,
				ie_dur_proc6_w,
				ie_dur_proc7_w,
				ds_obser_proc1_w,
				ds_obser_proc2_w,
				ds_obser_proc3_w,
				ds_obser_proc4_w,
				ds_obser_proc5_w,
				ds_obser_proc6_w,
				ds_obser_proc7_w,
				ie_assoc_adep1_w,
				ie_assoc_adep2_w,
				ie_assoc_adep3_w,
				ie_assoc_adep4_w,
				ie_assoc_adep5_w,
				ie_assoc_adep6_w,
				ie_assoc_adep7_w,
				nr_seq_condicao_w,
				ds_dado_clinico_w,
				ie_anestesia_w,
				nr_seq_contraste_w,
				cd_setor_entrega_w,
				cd_medico_exec_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
	SELECT * FROM Obter_Proc_Tab_Interno( nr_seq_proc_interno_w, 0, 0, 0, cd_procedimento_w, ie_origem_proced_w, null, null) INTO STRICT cd_procedimento_w, ie_origem_proced_w;
	
	dt_inicio_w			:= clock_timestamp();
	ds_horarios_w 		:= '';
	nr_ocorrencia_w		:= 0;
	ds_horarios_aux_w	:= '';
	hr_prim_horario_w	:= '';
	
	
	if (coalesce(obter_se_marca_agora(cpoe_obter_setor_atend_prescr(nr_atendimento_p, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p)),'N') = 'S') then
		cd_intervalo_agora_w := cpoe_busca_intervalo_agora(nr_atendimento_p,'P',cd_estabelecimento_p,cd_perfil_p, nm_usuario_p);

		if (cd_intervalo_agora_w IS NOT NULL AND cd_intervalo_agora_w::text <> '') then
			cd_intervalo_w := cd_intervalo_agora_w;
			ie_urgencia_w  := 0;	
		end if;
	
	end if;	
	
	select	coalesce(max(qt_min_intervalo),0),
			coalesce(max(ie_dose_unica_cpoe), 'N')
	into STRICT	qt_min_intervalo_w,
			ie_dose_unica_cpoe_w
	from	intervalo_prescricao
	where	cd_intervalo = cd_intervalo_w;		
	
	if (coalesce(ie_dose_unica_cpoe_w, 'N') = 'S') then
		ie_administracao_w := 'P';
		ie_duracao_w := 'P';
		ie_evento_unico_w 	:= 'S';
		ie_se_necessario_w 	:= 'N';
		ie_acm_w			:= 'N';
	end if;
	
	if (coalesce(ie_prescr_alta_agora_w,'N') = 'S') and (coalesce(ie_item_alta_p,'N') = 'S') and (ie_dose_unica_cpoe_w <> 'S')then	

		ie_urgencia_w := 0;		

		SELECT * FROM cpoe_calcular_horario_prescr(nr_atendimento_p, cd_intervalo_w, null, clock_timestamp(), 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;

		ds_horarios_w	:= ds_horarios_w || ds_horarios_aux_w;
		hr_prim_horario_w	:= obter_prim_dshorarios(ds_horarios_w);
		dt_inicio_w	:= to_date(to_char(clock_timestamp(),'dd/mm/yyyy ') || hr_prim_horario_w, 'dd/mm/yyyy hh24:mi');
		if (dt_inicio_w < clock_timestamp()) then
			dt_inicio_w := dt_inicio_w + 1;
		end if;
	elsif (ie_dose_unica_cpoe_w <> 'N') then
		dt_inicio_w			:= clock_timestamp();
		SELECT * FROM cpoe_atualizar_periodo_vig_ant(ds_horarios_w, hr_prim_horario_w, dt_inicio_w) INTO STRICT ds_horarios_w, hr_prim_horario_w, dt_inicio_w;
	end if;
	
	if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') and (obter_operacao_intervalo(cd_intervalo_w) = 'D') then
		dt_inicio_w := obter_proxima_dose_medic(dt_inicio_w, cd_intervalo_w, null, 'N');
	end if;
	
	if (coalesce(ie_administracao_w,'P') = 'P') then
		if (coalesce(ie_urgencia_w::text, '') = '') then
			dt_prev_execucao_w := trunc(dt_inicio_w,'hh24') + 1/24;

			hr_prim_horario_w  := substr(cpoe_obter_primeiro_horario( nr_atendimento_p, cd_intervalo_w, null, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, cd_pessoa_fisica_p),1,5);

			if (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') then
				dt_prev_execucao_w	:= to_date(to_char(dt_prev_execucao_w,'dd/mm/yyyy ')  || hr_prim_horario_w, 'dd/mm/yyyy hh24:mi');				
			end if;
		elsif (ie_urgencia_w = '0') then
			dt_prev_execucao_w := dt_inicio_w + 1/1440;
		elsif (ie_urgencia_w = '5') then
			dt_prev_execucao_w := dt_inicio_w + 5/1440;
		elsif (ie_urgencia_w = '10') then
			dt_prev_execucao_w := dt_inicio_w + 10/1440;
		elsif (ie_urgencia_w = '15') then
			dt_prev_execucao_w := dt_inicio_w + 15/1440;
		end if;
		
		if (dt_prev_execucao_w < clock_timestamp()) then
			dt_prev_execucao_w := dt_prev_execucao_w + 1;
		end if;
		
		hr_prim_horario_w := to_char(dt_prev_execucao_w,'hh24:mi');
		
		if (obter_ctrl_glic_proc(nr_seq_proc_interno_w) = 'CIG') then
			nr_ocorrencia_w	:= 1;
			ds_horarios_w 	:= to_char(dt_prev_execucao_w,'hh24:mi');
		else			
			SELECT * FROM cpoe_calcular_horario_prescr(	nr_atendimento_p, cd_intervalo_w, null, dt_prev_execucao_w, 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null, null, cd_procedimento_w, ie_origem_proced_w, nr_seq_proc_interno_w) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;
			ds_horarios_w	:= ds_horarios_w || ds_horarios_aux_w;
		end if;	
	end if;
	
	dt_fim_w := null;
	
	
	if (ie_duracao_w = 'P') or (ie_retrogrado_p = 'S') or (ie_futuro_p = 'S') then
		
		if (ie_retrogrado_p = 'S' or ie_futuro_p = 'S') then -- retrograde/backward item
			dt_prev_execucao_w := dt_inicio_p;
		end if;
	
		if (position('A' in CPOE_Padroniza_horario_prescr(ds_horarios_w,dt_prev_execucao_w)) > 0 ) then
			ie_possuir_hor_dia_seguinte_w := 'S';
		end if;   	
		
		if (coalesce(ie_possuir_hor_dia_seguinte_w,'N') = 'N') then
			dt_fim_w := fim_dia(dt_prev_execucao_w);
		else
			dt_fim_w := fim_dia(dt_prev_execucao_w+1);
		end if;	
		
		if (ie_retrogrado_p = 'S' or ie_futuro_p = 'S') then -- retrograde/backward item
			select	coalesce(max(qt_min_intervalo),0)
			into STRICT	qt_min_intervalo_w
			from	intervalo_prescricao
			where	cd_intervalo = cd_intervalo_w;
			
			ie_duracao_w 		:= 'P';
			nr_ocorrencia_w 	:= 0;
			ie_urgencia_w 		:= null;		
			ds_horarios_w		:= '';
			ds_horarios_aux_w	:= '';
			SELECT * FROM cpoe_calcular_horario_prescr(	nr_atendimento_p, cd_intervalo_w, null, dt_prev_execucao_w, 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null, null, cd_procedimento_w, ie_origem_proced_w, nr_seq_proc_interno_w) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;
										
			ds_horarios_w		:= ds_horarios_w || ds_horarios_aux_w;
			hr_prim_horario_w	:= obter_prim_dshorarios(ds_horarios_w);
		end if;
	end if;
	
	if (coalesce(dt_prev_execucao_w::text, '') = '' and (ie_se_necessario_w = 'S' or ie_acm_w = 'S')) then
		dt_prev_execucao_w := clock_timestamp();
	end if;
	
		
	select	nextval('cpoe_procedimento_seq')
	into STRICT	nr_sequencia_w
	;
	
	insert into	cpoe_procedimento(
				nr_sequencia,
				nr_atendimento,
				nr_seq_proc_interno,
				nr_seq_topografia,
				nr_seq_prot_glic,
				ie_administracao,
				ie_duracao,
				ie_periodo,
				ie_evento_unico,
				dt_inicio,
				dt_prev_execucao,
				dt_fim,
				hr_prim_horario,
				ds_horarios,
				qt_procedimento,
				ie_urgencia,
				ie_acm,
				ie_se_necessario,
				nr_ocorrencia,
				ie_lado,
				ds_observacao,
				cd_material_exame,
				ds_material_especial,
				nm_usuario,
				dt_atualizacao,
				nm_usuario_nrec,
				dt_atualizacao_nrec,
				cd_perfil_ativo,
				nr_seq_condicao,
				ds_dado_clinico,
				cd_pessoa_fisica,
                cd_intervalo,
				cd_funcao_origem,
				nr_seq_transcricao,
				ie_item_alta,
				ie_prescritor_aux,
				cd_medico,
				ie_retrogrado,
				nr_seq_pepo,
				nr_cirurgia,
				nr_cirurgia_patologia,
				nr_seq_agenda,
				ie_oncologia,
				nr_seq_conclusao_apae,
				ie_anestesia,
				nr_seq_contraste,
				ie_futuro,
				cd_setor_atendimento,
				cd_setor_entrega,
				cd_medico_exec,
				nr_seq_cpoe_order_unit)
			values (
				nr_sequencia_w,
				nr_atendimento_p,
				nr_seq_proc_interno_w,
				nr_seq_topografia_w,
				nr_seq_prot_glic_w,
				ie_administracao_w,
				ie_duracao_w,
				ie_periodo_w,
				ie_evento_unico_w,
				dt_prev_execucao_w,
				dt_prev_execucao_w,
				dt_fim_w,
				hr_prim_horario_w,
				ds_horarios_w,
				qt_procedimento_w,
				ie_urgencia_w,
				ie_acm_w,
				ie_se_necessario_w,
				nr_ocorrencia_w,
				ie_lado_w,
				ds_observacao_w,
				cd_material_exame_w,
				ds_material_especial_w,
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				cd_perfil_p,
				nr_seq_condicao_w,
				ds_dado_clinico_w,
				cd_pessoa_fisica_p,
                cd_intervalo_w,
				2314,
				nr_seq_transcricao_p,
				ie_item_alta_p,
				ie_prescritor_aux_p,
				cd_medico_p,
				ie_retrogrado_p,
				nr_seq_pepo_p,
				nr_cirurgia_p,
				nr_cirurgia_patologia_p,
				nr_seq_agenda_p,
				ie_oncologia_p,
				nr_seq_conclusao_apae_p,
				ie_anestesia_w,
				nr_seq_contraste_w,
				ie_futuro_p,
				cd_setor_atendimento_p,
				cd_setor_entrega_w,
				cd_medico_exec_w,
				nr_seq_cpoe_order_unit_p);
				
	commit;

	  CALL cpoe_consis_proced_insert(nr_sequencia_w,nm_usuario_p);

	if (nr_seq_prot_glic_w IS NOT NULL AND nr_seq_prot_glic_w::text <> '') then
		CALL cpoe_gerar_proc_glic( nr_sequencia_w, nr_seq_prot_glic_w, nm_usuario_p, nr_atendimento_p,cd_pessoa_fisica_p);
	end if;
	
	
	if (cd_mat_proc1_w IS NOT NULL AND cd_mat_proc1_w::text <> '') then
		gerar_item_assoc_proced( 1, nr_sequencia_w, cd_mat_proc1_w, qt_dose_mat1_w, cd_unid_medida_dose_mat1_w, ie_via_mat_proc1_w, ie_adm_mat1_w, cd_interv_proc1_w, ie_urgencia_mat1_w, ie_dur_proc1_w, ds_obser_proc1_w, ie_assoc_adep1_w);
	end if;
	
	if (cd_mat_proc2_w IS NOT NULL AND cd_mat_proc2_w::text <> '') then
		gerar_item_assoc_proced( 2, nr_sequencia_w, cd_mat_proc2_w, qt_dose_mat2_w, cd_unid_medida_dose_mat2_w, ie_via_mat_proc2_w, ie_adm_mat2_w, cd_interv_proc2_w, ie_urgencia_mat2_w, ie_dur_proc2_w, ds_obser_proc2_w, ie_assoc_adep2_w);
	end if;
	
	if (cd_mat_proc3_w IS NOT NULL AND cd_mat_proc3_w::text <> '') then
		gerar_item_assoc_proced( 3, nr_sequencia_w, cd_mat_proc3_w, qt_dose_mat3_w, cd_unid_medida_dose_mat3_w, ie_via_mat_proc3_w, ie_adm_mat3_w, cd_interv_proc3_w, ie_urgencia_mat3_w, ie_dur_proc3_w, ds_obser_proc3_w, ie_assoc_adep3_w);
	end if;
	
	if (cd_mat_proc4_w IS NOT NULL AND cd_mat_proc4_w::text <> '') then
		gerar_item_assoc_proced( 4, nr_sequencia_w, cd_mat_proc4_w, qt_dose_mat4_w, cd_unid_medida_dose_mat4_w, ie_via_mat_proc4_w, ie_adm_mat4_w, cd_interv_proc4_w, ie_urgencia_mat4_w, ie_dur_proc4_w, ds_obser_proc4_w, ie_assoc_adep4_w);
	end if;
	
	if (cd_mat_proc5_w IS NOT NULL AND cd_mat_proc5_w::text <> '') then
		gerar_item_assoc_proced( 5, nr_sequencia_w, cd_mat_proc5_w, qt_dose_mat5_w, cd_unid_medida_dose_mat5_w, ie_via_mat_proc5_w, ie_adm_mat5_w, cd_interv_proc5_w, ie_urgencia_mat5_w, ie_dur_proc5_w, ds_obser_proc5_w, ie_assoc_adep5_w);
	end if;

	if (cd_mat_proc6_w IS NOT NULL AND cd_mat_proc6_w::text <> '') then
		gerar_item_assoc_proced( 6, nr_sequencia_w, cd_mat_proc6_w, qt_dose_mat6_w, cd_unid_medida_dose_mat6_w, ie_via_mat_proc6_w, ie_adm_mat6_w, cd_interv_proc6_w, ie_urgencia_mat6_w, ie_dur_proc6_w, ds_obser_proc6_w, ie_assoc_adep6_w);
	end if;
	
	if (cd_mat_proc7_w IS NOT NULL AND cd_mat_proc7_w::text <> '') then
		gerar_item_assoc_proced( 7, nr_sequencia_w, cd_mat_proc7_w, qt_dose_mat7_w, cd_unid_medida_dose_mat7_w, ie_via_mat_proc7_w, ie_adm_mat7_w, cd_interv_proc7_w, ie_urgencia_mat7_w, ie_dur_proc7_w, ds_obser_proc7_w, ie_assoc_adep7_w);
	end if;
	
	CALL cpoe_gerar_prescr_proc_assoc(nr_sequencia_w, nm_usuario_p, cd_estabelecimento_p);
	
	CALL CPOE_Gerar_Exame_Lab_Dep(nr_sequencia_w, nr_atendimento_p, cd_estabelecimento_p, cd_setor_atendimento_p, '10,', nm_usuario_p, null, null);

    nr_seq_item_gerado_p := nr_sequencia_w;

	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_inserir_procedimento_fav ( nr_atendimento_p cpoe_procedimento.nr_atendimento%type, nr_sequencia_p cpoe_fav_procedimento.nr_sequencia%type, nm_usuario_p cpoe_fav_procedimento.nm_usuario%type, cd_perfil_p bigint, cd_estabelecimento_p bigint, cd_pessoa_fisica_p cpoe_procedimento.cd_pessoa_fisica%type, nr_seq_item_gerado_p INOUT bigint, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, ie_oncologia_p text default 'N', nr_seq_conclusao_apae_p bigint default null, ie_futuro_p text default 'N', cd_setor_atendimento_p bigint default null, nr_seq_cpoe_rp_p cpoe_rp.nr_sequencia%type default null, nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) FROM PUBLIC;

