-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_balancete_ifrs ( nr_seq_mes_ref_p ctb_saldo_ifrs.nr_seq_mes_ref%type, cd_estabelecimento_p ctb_saldo_ifrs.cd_estabelecimento%type, nm_usuario_p ctb_saldo_ifrs.nm_usuario%type) AS $body$
DECLARE


nr_sequencia_w		    ctb_saldo_ifrs.nr_sequencia%type;
nr_seq_mes_dest_w	    ctb_mes_ref.nr_sequencia%type;
cd_empresa_w		    ctb_mes_ref.cd_empresa%type;
dt_referencia_w		    ctb_mes_ref.dt_referencia%type;
qt_mes_fim_exerc_w	    empresa.qt_mes_fim_exercicio%type;
dt_referencia_dest_w	ctb_mes_ref.dt_referencia%type;

C01 CURSOR FOR
SELECT	a.cd_estabelecimento,
        b.nr_seq_conta_ifrs,
        a.cd_centro_custo,
        a.vl_debito,
        a.vl_credito,
        a.vl_saldo,
        a.vl_movimento,
        a.vl_encerramento,
        a.cd_classificacao,
        a.cd_classif_sup,
        a.nr_nivel_conta
from	conta_contabil_ifrs b,
        ctb_saldo a
where	a.nr_seq_mes_ref		= nr_seq_mes_ref_p
and	    a.cd_conta_contabil		= b.cd_conta_contabil
and	    ((b.ie_situacao 		= 'A') or (a.vl_saldo <> 0))
and	    ((a.cd_estabelecimento 	= cd_estabelecimento_p) or (coalesce(cd_estabelecimento_p,0) = 0));
c01w                C01%ROWTYPE;


BEGIN
delete from ctb_saldo_ifrs
where nr_seq_mes_ref = nr_seq_mes_ref_p;

begin
select	cd_empresa,
        dt_referencia
into STRICT	cd_empresa_w,
        dt_referencia_w
from	ctb_mes_ref
where	nr_sequencia	= nr_seq_mes_ref_p;
exception   when no_data_found then
            cd_empresa_w	:= null;
            dt_referencia_w	:= null;
            when too_many_rows then
            cd_empresa_w	:= null;
            dt_referencia_w	:= null;
end;

begin
select	qt_mes_fim_exercicio
into STRICT	qt_mes_fim_exerc_w
from	empresa
where	cd_empresa	= cd_empresa_w;
exception   when no_data_found then
            qt_mes_fim_exerc_w	:= null;
            when too_many_rows then
            qt_mes_fim_exerc_w	:= null;
end;

select	coalesce(max(nr_sequencia),0)
into STRICT	nr_seq_mes_dest_w
from	ctb_mes_ref
where	cd_empresa	= cd_empresa_w
and	pkg_date_utils.start_of(dt_referencia,'MONTH',0) = pkg_date_utils.start_of(pkg_date_utils.add_month(dt_referencia_w, 1,0), 'MONTH',0)
and	(dt_abertura IS NOT NULL AND dt_abertura::text <> '')
and	coalesce(dt_fechamento::text, '') = '';

if (nr_seq_mes_dest_w = 0) then
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(203781);
end if;

begin
select	dt_referencia
into STRICT	dt_referencia_dest_w
from	ctb_mes_ref
where	nr_sequencia	= nr_seq_mes_dest_w;
exception   when no_data_found then
            dt_referencia_dest_w	:= null;
            when too_many_rows then
            dt_referencia_dest_w	:= null;
end;

OPEN C01;
LOOP
FETCH C01 into c01w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_sequencia_w
	from	ctb_saldo_ifrs
	where	nr_seq_mes_ref		= nr_seq_mes_dest_w
	and	    cd_estabelecimento	= c01w.cd_estabelecimento
	and	    nr_seq_conta_ifrs	= c01w.nr_seq_conta_ifrs
	and	    coalesce(cd_centro_custo,0) 	= coalesce(c01w.cd_centro_custo,0);

	if (nr_sequencia_w > 0) then
		update	ctb_saldo_ifrs
		SET	vl_saldo	= vl_saldo + c01w.vl_saldo
		where	nr_sequencia	= nr_sequencia_w;
	else
		select	nextval('ctb_saldo_seq')
		into STRICT	nr_sequencia_w
		;
		insert into ctb_saldo_ifrs(
			nr_sequencia,	
			nr_seq_mes_ref,
			dt_atualizacao,
			nm_usuario,
			cd_estabelecimento,
			nr_seq_conta_ifrs,
			vl_debito,
			vl_debito_origem,
			vl_credito,			
			vl_credito_origem,			
			vl_saldo,
			vl_saldo_origem,
			vl_movimento,
			vl_movimento_origem,
			cd_centro_custo,
			vl_encerramento,
			cd_classificacao,
			cd_classif_sup,
			nr_nivel_conta)
		values ( nr_sequencia_w,
			nr_seq_mes_dest_w,
			clock_timestamp(),
			nm_usuario_p,
			c01w.cd_estabelecimento,
			c01w.nr_seq_conta_ifrs,
			c01w.vl_debito,
			c01w.vl_debito,
			c01w.vl_credito,
			c01w.vl_credito,
			c01w.vl_saldo,
			c01w.vl_saldo,
			c01w.vl_movimento,
			c01w.vl_movimento,
			c01w.cd_centro_custo,
			c01w.vl_encerramento,
			c01w.cd_classificacao,
			c01w.cd_classif_sup,
			c01w.nr_nivel_conta);

	end if;
	end;
END LOOP;
CLOSE C01;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_balancete_ifrs ( nr_seq_mes_ref_p ctb_saldo_ifrs.nr_seq_mes_ref%type, cd_estabelecimento_p ctb_saldo_ifrs.cd_estabelecimento%type, nm_usuario_p ctb_saldo_ifrs.nm_usuario%type) FROM PUBLIC;

