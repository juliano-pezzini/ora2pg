-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_ausencia_operador (nr_seq_operador_p bigint, nr_seq_motivo_p bigint, nm_usuario_p text, retorno_filas_p INOUT text, ds_motivo_p INOUT text, tipo_evento_p INOUT bigint) AS $body$
DECLARE


nr_seq_ausencia_nova_w    bigint;
nr_seq_ausencia_registrada_w    bigint;
nr_ausencia_w    bigint:=0;
cd_estabelecimento_w bigint:= wheb_usuario_pck.get_cd_estabelecimento;
cd_pausa_central_w varchar(1);

nr_seq_max_ausencia_w    bigint;

  i RECORD;

BEGIN

  select a.ie_tipo_evento, a.ds_motivo
  into STRICT tipo_evento_p, ds_motivo_p
  from pls_atend_motivo_ausencia a
  where a.nr_sequencia = nr_seq_motivo_p;

  if (tipo_evento_p = 1 or tipo_evento_p = 2) then

    select max(a.nr_sequencia)
    into STRICT nr_seq_max_ausencia_w
    from pls_atendimento_ausencia a
    where a.nr_seq_operador = nr_seq_operador_p;

    for i in (SELECT a.ds_fila || ';' ds_fila
    from pls_filas_call_center a, pls_operador_filas b
    where a.nr_sequencia = b.nr_seq_fila
    and b.ie_situacao = 'A' and b.nr_seq_operador = nr_seq_operador_p)
    loop
      retorno_filas_p:=retorno_filas_p || i.ds_fila;
    end loop;

  begin
    select a.nr_sequencia
      into STRICT nr_seq_ausencia_registrada_w
    from pls_atendimento_ausencia a
      where a.nr_sequencia = nr_seq_max_ausencia_w
      and coalesce(a.dt_fim::text, '') = '';
  exception
    when no_data_found then
        nr_seq_ausencia_registrada_w:=0;
  end;

  begin
    select a.nr_sequencia
    into STRICT nr_ausencia_w
    from pls_atendimento_ausencia a
    where a.nr_sequencia = nr_seq_max_ausencia_w
    and coalesce(a.dt_fim::text, '') = '';
  exception
    when no_data_found then

      select  nextval('pls_atendimento_ausencia_seq')
      into STRICT  nr_seq_ausencia_nova_w
;

      insert  into pls_atendimento_ausencia(nr_sequencia, nr_seq_motivo, dt_inicio,
      dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
      nm_usuario_nrec, nr_seq_operador,
      cd_estabelecimento)
      values (nr_seq_ausencia_nova_w, nr_seq_motivo_p, clock_timestamp(),
      clock_timestamp(),nm_usuario_p, clock_timestamp(),
      nm_usuario_p,nr_seq_operador_p,
      cd_estabelecimento_w);

  end;

      if (tipo_evento_p = 1) then
         cd_pausa_central_w:='N';
      elsif (tipo_evento_p = 2) then
         cd_pausa_central_w:='S';
      end if;

      for i in (SELECT a.nr_sequencia nr_sequencia from pls_operador_controle a
               where a.nr_seq_operador = nr_seq_operador_p and coalesce(a.dt_saida::text, '') = '')
        loop

        update pls_operador_controle set dt_saida = clock_timestamp(),
        dt_atualizacao = clock_timestamp(),
        nm_usuario = nm_usuario_p,
        ie_pausa_central = cd_pausa_central_w,
        nr_seq_ausencia = nr_seq_ausencia_registrada_w
        where nr_sequencia = i.nr_sequencia
        and coalesce(dt_saida::text, '') = '';

        end loop;

  end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ausencia_operador (nr_seq_operador_p bigint, nr_seq_motivo_p bigint, nm_usuario_p text, retorno_filas_p INOUT text, ds_motivo_p INOUT text, tipo_evento_p INOUT bigint) FROM PUBLIC;

