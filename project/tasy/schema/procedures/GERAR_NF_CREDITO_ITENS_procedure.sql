-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_nf_credito_itens ( nr_seq_nf_credito_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w			nf_credito_item.nr_sequencia%type;
cd_material_w			nf_credito_item.cd_material%type;
cd_procedimento_w		nf_credito_item.cd_procedimento%type;
ie_origem_proced_w		nf_credito_item.ie_origem_proced%type;
qt_item_nf_w			nf_credito_item.qt_item_nf%type;
vl_com_imposto_w		nf_credito_item.vl_itens_imposto%type;
vl_sem_imposto_w		nf_credito_item.vl_itens_sem_imposto%type;
vl_imposto_w			nf_credito_item.vl_imposto%type;
vl_trib_nao_retido_w		nf_credito_item.vl_imposto_nao_retido%type;
vl_com_imposto_ww		nf_credito_item.vl_itens_imposto%type;
vl_sem_imposto_ww		nf_credito_item.vl_itens_sem_imposto%type;
vl_imposto_ww		        nf_credito_item.vl_imposto%type;
vl_imposto_mat_w		nf_credito_item.vl_imposto%type;
vl_imposto_mat_n_retido_w	nf_credito_item.vl_imposto%type;
vl_imposto_proc_w		nf_credito_item.vl_imposto%type;
ie_acao_nf_credito_w		NF_CREDITO.IE_ACAO%type;
vl_imposto_proc_n_retido_w	nf_credito_item.vl_imposto%type;
nr_seq_nf_orig_w		nf_credito_item.nr_seq_nf_orig%type;
nr_item_nf_orig_w		nf_credito_item.nr_item_nf_orig%type;
nr_item_nf_w			nf_credito_item.nr_item_nf%type;
nr_interno_conta_w		nota_fiscal.nr_interno_conta%type;
nr_seq_protocolo_w		nota_fiscal.nr_seq_protocolo%type;
qt_nf_item_atend_w		bigint;
nr_seq_matpaci_w		nota_fiscal_item_atend.nr_seq_matpaci%type;
nr_seq_propaci_w		nota_fiscal_item_atend.nr_seq_propaci%type;
vl_material_sem_imposto_w	material_atend_paciente.vl_material%type;
vl_material_com_imposto_w	material_atend_paciente.vl_material%type;
vl_proc_sem_imposto_w		procedimento_paciente.vl_procedimento%type;
vl_proc_com_imposto_w		procedimento_paciente.vl_procedimento%type;
ie_considera_apenas_nf_w	varchar(1);
qtd_w                           bigint;
ie_acao_w                       nf_credito.ie_acao%type;
vl_total_trib_item_w            nota_fiscal_item.vl_total_item_nf%type;
trib_item_w             	nota_fiscal_item_trib.vl_tributo%type;
vl_total_trib_item_n_ret_w      nota_fiscal_item_trib.vl_tributo%type;
trib_item_n_ret_w             	nota_fiscal_item_trib.vl_tributo%type;
cd_moeda_w     		 	nf_credito.cd_moeda%type;
vl_cotacao_w                    cotacao_moeda.vl_cotacao%type;
vl_liquido_w                    nota_fiscal_item.vl_liquido%type;
vl_liquido_ref_w		nota_fiscal_item.vl_liquido%TYPE;
nr_sequencia_nf_ref_w		nota_fiscal.nr_sequencia%type;
ie_sinal_operacao_w 		varchar(1);
ie_forma_aplicacao_w		nf_credito.ie_forma_aplicacao%type;
vl_unitario_liquido_w		double precision;
vl_liquido_nf_w          	nota_fiscal_item.vl_liquido%type;

/*Quantidade de notas de credito*/

qt_nf_cred_w				bigint;

c01 CURSOR FOR
SELECT	a.cd_material,
	a.cd_procedimento,
	a.ie_origem_proced,
	a.qt_item_nf,
	a.nr_sequencia,
	a.nr_item_nf,
	a.vl_liquido
from	nota_fiscal_item a,
	nf_credito b
where	b.nr_sequencia = nr_seq_nf_credito_p
and	a.nr_sequencia = b.nr_seq_nf_orig
and	((b.ie_aplicacao_itens = 'T') or (b.ie_aplicacao_itens = 'C' and exists (SELECT	1
						 from 	nota_fiscal_item_trib x
						 where  x.nr_item_nf  = a.nr_item_nf
						 and	x.nr_sequencia = a.nr_sequencia)) or (b.ie_aplicacao_itens = 'S' and not exists (select 1 
						    from   nota_fiscal_item_trib x
						    where  x.nr_item_nf  = a.nr_item_nf
						    and	   x.nr_sequencia = a.nr_sequencia)))
and	b.ie_situacao = '1';

c02 CURSOR FOR
SELECT	nr_interno_conta
from	conta_paciente
where	nr_seq_protocolo = nr_seq_protocolo_w;

c03 CURSOR FOR
SELECT	nr_seq_matpaci,
	nr_seq_propaci
from	nota_fiscal_item_atend
where	nr_seq_nota = nr_seq_nf_orig_w
and	nr_item_nf = nr_item_nf_orig_w;

c04 CURSOR FOR
SELECT 	a.nr_sequencia
from 	nota_fiscal a
where 	a.nr_sequencia_ref = nr_seq_nf_orig_w
and     coalesce(a.nr_seq_baixa_tit::text, '') = ''
and     a.ie_situacao = '1';


BEGIN
EXECUTE 'ALTER SESSION SET NLS_NUMERIC_CHARACTERS= ''.,'' ';

ie_considera_apenas_nf_w := obter_valor_param_usuario(7504, 3, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento);

if (nr_seq_nf_credito_p IS NOT NULL AND nr_seq_nf_credito_p::text <> '') then
	begin
	
select coalesce(ie_acao,'D'),
       cd_moeda,
       coalesce(vl_cotacao,0)
into STRICT   ie_acao_w,
       cd_moeda_w,
       vl_cotacao_w
from   nf_credito
where  nr_sequencia = nr_seq_nf_credito_p;

	open c01;
	loop
	fetch c01
	into	cd_material_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		qt_item_nf_w,		
		nr_seq_nf_orig_w,
		nr_item_nf_orig_w,
		vl_liquido_nf_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		
		vl_com_imposto_w	:= 0;
		vl_sem_imposto_w	:= 0;
		vl_imposto_w		:= 0;
		/*Quando a nota tem vinculo com a nota_fiscal_item_atend, independente se e da conta ou do protocolo*/

		select	count(*)
		into STRICT		qt_nf_item_atend_w
		from		nota_fiscal_item_atend
		where	nr_sequencia = nr_seq_nf_orig_w
		and	nr_item_nf = nr_item_nf_orig_w;			
			
		if	(qt_nf_item_atend_w > 0 AND ie_considera_apenas_nf_w <> '1') then
			
			open C03;
			loop
			fetch C03 into	
				nr_seq_matpaci_w,
				nr_seq_propaci_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin
				
				vl_material_sem_imposto_w	:= 0;
				vl_material_com_imposto_w	:= 0;
				vl_proc_sem_imposto_w	:= 0;
				vl_proc_com_imposto_w	:= 0;
				vl_imposto_mat_w		:= 0;
				vl_imposto_mat_n_retido_w :=0;
				vl_imposto_proc_w		:= 0;
				vl_imposto_proc_n_retido_w	:= 0;
				
				if (nr_seq_matpaci_w > 0) then
				
					select	coalesce(sum(a.vl_material),0)
					into STRICT	vl_material_sem_imposto_w
					from	material_atend_paciente a
					where	a.nr_sequencia = nr_seq_matpaci_w
					and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
					and	a.nr_sequencia <> coalesce(a.nr_seq_proc_pacote,0)
					and not exists (
						SELECT	1
						from	matpaci_imposto b
						where	a.nr_sequencia = b.nr_seq_matpaci);
						
					select	coalesce(sum(a.vl_material),0)
					into STRICT	vl_material_com_imposto_w
					from	material_atend_paciente a
					where	a.nr_sequencia = nr_seq_matpaci_w
					and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
					and	a.nr_sequencia <> coalesce(a.nr_seq_proc_pacote,0)
					and exists (
						SELECT	1
						from	matpaci_imposto b
						where	a.nr_sequencia = b.nr_seq_matpaci);
						
					select	obter_tributo_item_credito(nr_seq_matpaci_w,null,'D','MAPA',null),
								obter_tributo_item_credito(nr_seq_matpaci_w,null,'S','MAPA',null)
					into STRICT 		vl_imposto_mat_w,
								vl_imposto_mat_n_retido_w
					;	
				
				elsif (nr_seq_propaci_w > 0) then
					
					select	coalesce(sum(a.vl_procedimento),0)
					into STRICT	vl_proc_sem_imposto_w
					from	procedimento_paciente a
					where	a.nr_sequencia = nr_seq_propaci_w
					and	coalesce(a.cd_motivo_exc_conta::text, '') = ''						
					and	a.nr_sequencia <> coalesce(a.nr_seq_proc_pacote,0)
					and not exists (
						SELECT	1
						from	propaci_imposto b
						where	a.nr_sequencia = b.nr_seq_propaci);
					
					select	coalesce(sum(a.vl_procedimento),0)
					into STRICT	vl_proc_com_imposto_w
					from	procedimento_paciente a
					where	a.nr_sequencia = nr_seq_propaci_w
					and	coalesce(a.cd_motivo_exc_conta::text, '') = ''						
					and	a.nr_sequencia <> coalesce(a.nr_seq_proc_pacote,0)
					and exists (
						SELECT	1
						from	propaci_imposto b
						where	a.nr_sequencia = b.nr_seq_propaci);
					
					select	obter_tributo_item_credito(nr_seq_propaci_w,null,'D','PPA',null),
								obter_tributo_item_credito(nr_seq_propaci_w,null,'S','PPA',null)
					into STRICT 		vl_imposto_proc_w,
								vl_imposto_proc_n_retido_w
					;
				
				end if;
				
				vl_sem_imposto_w	:= vl_sem_imposto_w + vl_material_sem_imposto_w + vl_proc_sem_imposto_w;
				vl_com_imposto_w	:= vl_com_imposto_w + vl_material_com_imposto_w + vl_proc_com_imposto_w;
				
				vl_imposto_w			:= vl_imposto_w + vl_imposto_mat_w + vl_imposto_proc_w;
				vl_trib_nao_retido_w	:= vl_trib_nao_retido_w + vl_imposto_mat_n_retido_w + vl_imposto_proc_n_retido_w;
				
				end;
			end loop;
			close C03;
		else
				
			select	coalesce(max(nr_interno_conta),0),
				coalesce(max(nr_seq_protocolo),0)
			into STRICT	nr_interno_conta_w,
				nr_seq_protocolo_w
			from	nota_fiscal
			where	nr_sequencia = nr_seq_nf_orig_w;
				
			/*Quando a nota e da conta paciente*/

			if	(nr_interno_conta_w > 0 AND ie_considera_apenas_nf_w <> '1') then
			
				vl_material_sem_imposto_w	:= 0;
				vl_material_com_imposto_w	:= 0;
				vl_proc_sem_imposto_w		:= 0;
				vl_proc_com_imposto_w		:= 0;
				vl_imposto_mat_w		:= 0;
				vl_imposto_mat_n_retido_w		:= 0;
				vl_imposto_proc_w		:= 0;
				vl_imposto_proc_n_retido_w := 0;

				if (cd_material_w > 0) then					
					
					select	coalesce(sum(a.vl_material),0)
					into STRICT	vl_material_sem_imposto_w
					from	material_atend_paciente a
					where	coalesce(a.cd_motivo_exc_conta::text, '') = ''
					and	a.nr_sequencia <> coalesce(a.nr_seq_proc_pacote,0)					
					and	a.nr_interno_conta = nr_interno_conta_w
					and	a.cd_material = cd_material_w
					and not exists (
						SELECT	1
						from	matpaci_imposto b
						where	a.nr_sequencia = b.nr_seq_matpaci);
						
					select	coalesce(sum(a.vl_material),0)
					into STRICT	vl_material_com_imposto_w
					from	material_atend_paciente a
					where	coalesce(a.cd_motivo_exc_conta::text, '') = ''
					and	a.nr_sequencia <> coalesce(a.nr_seq_proc_pacote,0)					
					and	a.nr_interno_conta = nr_interno_conta_w
					and	a.cd_material = cd_material_w
					and exists (
						SELECT	1
						from	matpaci_imposto b
						where	a.nr_sequencia = b.nr_seq_matpaci);
						
					select	obter_tributo_item_credito(nr_interno_conta_w,cd_material_w,'D','MAPCP',null),
								obter_tributo_item_credito(nr_interno_conta_w,cd_material_w,'S','MAPCP',null)
					into STRICT 		vl_imposto_mat_w,
								vl_imposto_mat_n_retido_w
					;
				
				elsif (cd_procedimento_w > 0) then
					
					select	coalesce(sum(a.vl_procedimento),0)
					into STRICT	vl_proc_sem_imposto_w
					from	procedimento_paciente a
					where	coalesce(a.cd_motivo_exc_conta::text, '') = ''
					and	a.nr_sequencia <> coalesce(a.nr_seq_proc_pacote,0)
					and	a.nr_interno_conta = nr_interno_conta_w
					and	a.cd_procedimento = cd_procedimento_w
					and	a.ie_origem_proced = ie_origem_proced_w
					and not exists (
						SELECT	1
						from	propaci_imposto b
						where	a.nr_sequencia = b.nr_seq_propaci);
					
					select	coalesce(sum(a.vl_procedimento),0)
					into STRICT	vl_proc_com_imposto_w
					from	procedimento_paciente a
					where	coalesce(a.cd_motivo_exc_conta::text, '') = ''
					and	a.nr_sequencia <> coalesce(a.nr_seq_proc_pacote,0)
					and	a.nr_interno_conta = nr_interno_conta_w
					and	a.cd_procedimento = cd_procedimento_w
					and	a.ie_origem_proced = ie_origem_proced_w
					and exists (
						SELECT	1
						from	propaci_imposto b
						where	a.nr_sequencia = b.nr_seq_propaci);
					
					select	obter_tributo_item_credito(nr_interno_conta_w,cd_procedimento_w,'D','PPCP',ie_origem_proced_w),
							obter_tributo_item_credito(nr_interno_conta_w,cd_procedimento_w,'S','PPCP',ie_origem_proced_w)
					into STRICT 	vl_imposto_proc_w,
							vl_imposto_proc_n_retido_w
					;

				end if;
				
				vl_sem_imposto_w	:= vl_sem_imposto_w + vl_material_sem_imposto_w + vl_proc_sem_imposto_w;
				vl_com_imposto_w	:= vl_com_imposto_w + vl_material_com_imposto_w + vl_proc_com_imposto_w;

				vl_imposto_w			:= vl_imposto_w + vl_imposto_mat_w + vl_imposto_proc_w;
				vl_trib_nao_retido_w	:= vl_trib_nao_retido_w + vl_imposto_mat_n_retido_w + vl_imposto_proc_n_retido_w;
			/*FIM - Quando a nota e da conta paciente*/

		

			elsif	(nr_seq_protocolo_w > 0 AND ie_considera_apenas_nf_w <> '1') then			
			/*Quando a nota e do protocolo convenio*/
			
			--aqui
				vl_material_sem_imposto_w	:= 0;
				vl_material_com_imposto_w	:= 0;
				vl_proc_sem_imposto_w	:= 0;
				vl_proc_com_imposto_w	:= 0;
				vl_imposto_mat_w		:= 0;
				vl_imposto_mat_n_retido_w := 0;
				vl_imposto_proc_w		:= 0;
				vl_imposto_proc_n_retido_w	:= 0;
				
				open C02;
				loop
				fetch C02 into	
					nr_interno_conta_w;
				EXIT WHEN NOT FOUND; /* apply on C02 */
					begin
					
					if (cd_material_w > 0) then					
					
						select	coalesce(sum(a.vl_material),0)
						into STRICT	vl_material_sem_imposto_w
						from	material_atend_paciente a
						where	coalesce(a.cd_motivo_exc_conta::text, '') = ''
						and	a.nr_sequencia <> coalesce(a.nr_seq_proc_pacote,0)					
						and	a.nr_interno_conta = nr_interno_conta_w
						and	a.cd_material = cd_material_w
						and not exists (
							SELECT	1
							from	matpaci_imposto b
							where	a.nr_sequencia = b.nr_seq_matpaci);
							
						select	coalesce(sum(a.vl_material),0)
						into STRICT	vl_material_com_imposto_w
						from	material_atend_paciente a
						where	coalesce(a.cd_motivo_exc_conta::text, '') = ''
						and	a.nr_sequencia <> coalesce(a.nr_seq_proc_pacote,0)					
						and	a.nr_interno_conta = nr_interno_conta_w
						and	a.cd_material = cd_material_w
						and exists (
							SELECT	1
							from	matpaci_imposto b
							where	a.nr_sequencia = b.nr_seq_matpaci);
						
						select	obter_tributo_item_credito(nr_interno_conta_w,cd_material_w,'D','MAPPC',null),
								obter_tributo_item_credito(nr_interno_conta_w,cd_material_w,'S','MAPPC',null)
						into STRICT 	vl_imposto_mat_w,
								vl_imposto_mat_n_retido_w
						;
					
					elsif (cd_procedimento_w > 0) then
						
						select	coalesce(sum(a.vl_procedimento),0)
						into STRICT	vl_proc_sem_imposto_w
						from	procedimento_paciente a
						where	coalesce(a.cd_motivo_exc_conta::text, '') = ''
						and	a.nr_sequencia <> coalesce(a.nr_seq_proc_pacote,0)
						and	a.nr_interno_conta = nr_interno_conta_w
						and	a.cd_procedimento = cd_procedimento_w
						and	a.ie_origem_proced = ie_origem_proced_w
						and not exists (
							SELECT	1
							from	propaci_imposto b
							where	a.nr_sequencia = b.nr_seq_propaci);
						
						select	coalesce(sum(a.vl_procedimento),0)
						into STRICT	vl_proc_com_imposto_w
						from	procedimento_paciente a
						where	coalesce(a.cd_motivo_exc_conta::text, '') = ''
						and	a.nr_sequencia <> coalesce(a.nr_seq_proc_pacote,0)
						and	a.nr_interno_conta = nr_interno_conta_w
						and	a.cd_procedimento = cd_procedimento_w
						and	a.ie_origem_proced = ie_origem_proced_w
						and exists (
							SELECT	1
							from	propaci_imposto b
							where	a.nr_sequencia = b.nr_seq_propaci);
						
					select	obter_tributo_item_credito(nr_interno_conta_w,cd_procedimento_w,'D','PPCP',ie_origem_proced_w),
							obter_tributo_item_credito(nr_interno_conta_w,cd_procedimento_w,'S','PPCP',ie_origem_proced_w)
					into STRICT 	vl_imposto_proc_w,
							vl_imposto_proc_n_retido_w
					;

						select	coalesce(sum(b.vl_imposto),0)
						into STRICT	vl_imposto_proc_w
						from	procedimento_paciente a,
							propaci_imposto b
						where	a.nr_sequencia = b.nr_seq_propaci
						and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
						and	a.nr_sequencia <> coalesce(a.nr_seq_proc_pacote,0)
						and	a.nr_interno_conta = nr_interno_conta_w
						and	a.cd_procedimento = cd_procedimento_w
						and	a.ie_origem_proced = ie_origem_proced_w;
					
					end if;
					
					vl_sem_imposto_w	:= vl_sem_imposto_w + vl_material_sem_imposto_w + vl_proc_sem_imposto_w;
					vl_com_imposto_w	:= vl_com_imposto_w + vl_material_com_imposto_w + vl_proc_com_imposto_w;

					vl_imposto_w			:= vl_imposto_w + vl_imposto_mat_w + vl_imposto_proc_w;
					vl_trib_nao_retido_w	:= vl_trib_nao_retido_w + vl_imposto_mat_n_retido_w + vl_imposto_proc_n_retido_w;

					end;
				end loop;
				close C02;
			
			
			elsif	((nr_seq_protocolo_w = 0 AND nr_interno_conta_w = 0) or (ie_considera_apenas_nf_w = '1')) then
				
				/*Quando a nota nao e da conta e nem do protocolo*/
			
				select	coalesce(sum(a.vl_liquido),0)
				into STRICT	vl_sem_imposto_w
				from	nota_fiscal_item a
				where	a.nr_sequencia = nr_seq_nf_orig_w
				and	a.nr_item_nf = nr_item_nf_orig_w
				and not exists (
					SELECT	1
					from	nota_fiscal_item_trib b
					where	a.nr_sequencia = b.nr_sequencia
					and	a.nr_item_nf = b.nr_item_nf);
				
				select	coalesce(sum(a.vl_liquido),0)
				into STRICT	vl_com_imposto_w
				from	nota_fiscal_item a
				where	a.nr_sequencia = nr_seq_nf_orig_w
				and	a.nr_item_nf = nr_item_nf_orig_w
				and exists (
					SELECT	1
					from	nota_fiscal_item_trib b
					where	a.nr_sequencia = b.nr_sequencia
					and	a.nr_item_nf = b.nr_item_nf);
				
				select	obter_tributo_item_credito(nr_seq_nf_orig_w,nr_item_nf_orig_w,'D','NF',null),
					obter_tributo_item_credito(nr_seq_nf_orig_w,nr_item_nf_orig_w,'S','NF',null)
				into STRICT 	vl_imposto_w,
					vl_trib_nao_retido_w
				;		
			
			end if;
		end if;
		/*FIM - Quando a nota e do protocolo convenio*/

		
		select	nextval('nf_credito_item_seq')
		into STRICT	nr_sequencia_w
		;
	
		select (coalesce(max(nr_item_nf),0)+1)
		into STRICT		nr_item_nf_w
		from		nf_credito_item
		where	nr_seq_nf_credito = nr_seq_nf_credito_p;
		
		select	coalesce(obter_tributo_item_credito(nr_seq_nf_orig_w, nr_item_nf_orig_w,'D','NF',null),0),
			coalesce(obter_tributo_item_credito(nr_seq_nf_orig_w, nr_item_nf_orig_w,'S','NF',null),0)
		into STRICT    trib_item_w,
			trib_item_n_ret_w
		;
				
		vl_liquido_w 			:= 0;
		vl_total_trib_item_w 		:= 0;
		vl_total_trib_item_n_ret_w	:= 0;
		vl_unitario_liquido_w 		:= vl_liquido_nf_w/qt_item_nf_w;
		trib_item_w 			:= trib_item_w/qt_item_nf_w;
		trib_item_n_ret_w 		:= trib_item_n_ret_w/qt_item_nf_w;

		OPEN	c04;
		LOOP	
		FETCH	c04
		INTO 	nr_sequencia_nf_ref_w;
		EXIT WHEN NOT FOUND; /* apply on c04 */
			BEGIN
				select	count(*)
				into STRICT 	qt_nf_cred_w
				from 	nf_credito
				where 	nr_seq_nf_gerada = nr_sequencia_nf_ref_w;
				
				if (qt_nf_cred_w > 0) then		
					select 	coalesce(max(ie_acao),'D'),
						ie_forma_aplicacao
					into STRICT 	ie_acao_nf_credito_w,
						ie_forma_aplicacao_w
					from 	nf_credito
					where 	nr_seq_nf_gerada = nr_sequencia_nf_ref_w
					group by ie_forma_aplicacao;

					ie_sinal_operacao_w := '-';

					if (ie_acao_nf_credito_w = 'A') then
						ie_sinal_operacao_w := '+';
					end if;
					
					if (ie_forma_aplicacao_w = 'Q') then
						select	coalesce(qt_aplicacao,0)
						into STRICT	vl_liquido_ref_w
						from 	nf_credito_item a,
							nf_credito b
						where 	b.nr_sequencia = a.nr_seq_nf_credito
						and 	b.nr_seq_nf_gerada = nr_sequencia_nf_ref_w
						and	a.nr_item_nf_orig = nr_item_nf_orig_w;

						EXECUTE 'select ' || vl_total_trib_item_w || ' ' || ie_sinal_operacao_w || '(' || vl_liquido_ref_w || '*' || trib_item_w || ')' || ' from dual'
						into STRICT vl_total_trib_item_w;
						
						EXECUTE 'select ' || vl_total_trib_item_n_ret_w || ' ' || ie_sinal_operacao_w || '(' || vl_liquido_ref_w || '*' || trib_item_n_ret_w || ')' || ' from dual'
						into STRICT vl_total_trib_item_n_ret_w;
						
						EXECUTE 'select ' || vl_liquido_w || ' ' || ie_sinal_operacao_w || '(' || vl_liquido_ref_w || '*' || vl_unitario_liquido_w || ')' || ' from dual'
						into STRICT vl_liquido_w;
					else
						select	coalesce(max(a.vl_liquido),0)
						into STRICT 	vl_liquido_ref_w
						from	nota_fiscal_item a
						where	a.nr_sequencia = nr_sequencia_nf_ref_w
						and	a.nr_item_nf = nr_item_nf_orig_w;

						select	coalesce(obter_tributo_item_credito(nr_sequencia_nf_ref_w, nr_item_nf_orig_w,'D','NF',null),0),
							coalesce(obter_tributo_item_credito(nr_sequencia_nf_ref_w, nr_item_nf_orig_w,'S','NF',null),0)
						into STRICT    trib_item_w,
							trib_item_n_ret_w
						;
						
						EXECUTE 'select ' || vl_total_trib_item_w || ' ' || ie_sinal_operacao_w || trib_item_w || ' from dual'
						into STRICT vl_total_trib_item_w;
						
						EXECUTE 'select ' || vl_total_trib_item_n_ret_w || ' ' || ie_sinal_operacao_w || trib_item_n_ret_w || ' from dual'
						into STRICT vl_total_trib_item_n_ret_w;

						EXECUTE 'select ' || vl_liquido_w || ' ' || ie_sinal_operacao_w || vl_liquido_ref_w || ' from dual'
						into STRICT vl_liquido_w;
					end if;
				end if;
			END;
		END LOOP;
		CLOSE C04;
		
		if (coalesce(vl_com_imposto_w,0) > 0) then
			vl_com_imposto_ww := (vl_com_imposto_w + vl_liquido_w);			
		end if;
	
		if (coalesce(vl_sem_imposto_w,0) > 0) then
			vl_sem_imposto_ww := (vl_sem_imposto_w + vl_liquido_w);
		end if;

		if (vl_imposto_w > 0) then	
		    vl_imposto_w := (vl_imposto_w + vl_total_trib_item_w);				
		end if;

		if (vl_trib_nao_retido_w > 0) then		
		    vl_trib_nao_retido_w := (vl_trib_nao_retido_w + vl_total_trib_item_n_ret_w);				
		end if;
		
		insert into nf_credito_item(	
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_nf_credito,
			nr_item_nf,
			cd_material,
			cd_procedimento,
			ie_origem_proced,
			qt_item_nf,
			vl_itens_imposto,
			vl_itens_sem_imposto,
			vl_imposto,
			vl_imposto_nao_retido,
			nr_seq_nf_orig,
			nr_item_nf_orig,
			vl_itens_sem_imposto_orig,
			vl_itens_imposto_orig,
			vl_imposto_orig,
			vl_imposto_nao_retido_orig)
		values (	nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_nf_credito_p,
			nr_item_nf_w,
			cd_material_w,
			cd_procedimento_w,
			ie_origem_proced_w,
			qt_item_nf_w,
			coalesce(vl_com_imposto_ww,coalesce(vl_com_imposto_w,0)),
			coalesce(vl_sem_imposto_ww,coalesce(vl_sem_imposto_w,0)),
			coalesce(vl_imposto_w,0),		-- valor tributo retido
			coalesce(vl_trib_nao_retido_w,0), 	-- valor tributo n retido
			nr_seq_nf_orig_w,
			nr_item_nf_orig_w,
			coalesce(vl_sem_imposto_ww,coalesce(vl_sem_imposto_w,0)),
			coalesce(vl_com_imposto_ww,coalesce(vl_com_imposto_w,0)),
			coalesce(vl_imposto_w,0),		-- valor original gravado retido
			coalesce(vl_trib_nao_retido_w,0)); 	-- valor original gravado n retido
	
			
		vl_imposto_w := 0;
		vl_trib_nao_retido_w := 0;
		vl_sem_imposto_ww := null;
		vl_com_imposto_ww := null;
		
		end;
		
		commit;
	end loop;
	close c01;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_nf_credito_itens ( nr_seq_nf_credito_p bigint, nm_usuario_p text) FROM PUBLIC;

