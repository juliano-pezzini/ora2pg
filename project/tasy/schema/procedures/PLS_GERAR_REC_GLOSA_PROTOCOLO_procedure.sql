-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_rec_glosa_protocolo ( nr_seq_lote_p pls_rec_glosa_lote.nr_sequencia%type, nr_seq_xml_arquivo_p pls_rec_glosa_protocolo.nr_seq_xml_arquivo%type, nm_usuario_p usuario.nm_usuario%type, ie_origem_solic_p pls_rec_glosa_protocolo.ie_origem_solic%type default 'M', nr_seq_usuario_p pls_usuario_web.nr_sequencia%type DEFAULT NULL, nr_seq_protocolo_p INOUT pls_rec_glosa_protocolo.nr_sequencia%type DEFAULT NULL, nm_arquivo_p pls_rec_glosa_protocolo.ds_arquivo%type default null, ds_hash_p text default null, ie_prot_duplicado_p text default 'N',--parametro 12 opsw - rec glosa
 ds_mensagem_erro_p INOUT text  DEFAULT NULL) AS $body$
DECLARE


nr_seq_protocolo_w		bigint;
nr_seq_prestador_w		bigint := null;
dt_apresentacao_w		timestamp;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type := pls_obter_cd_estab_ops;
nr_seq_prot_imp_w	pls_rec_glosa_protocolo.nr_sequencia%type;
qt_reg_w			integer := 0;


BEGIN

--ds_mensagem_erro_p. Mensagem de retorno caso encontre duplicidade de importacao do arquivo, para portal tratar exibicao da mesma ao usuario.



/*----------------------------------------------------------------------------------------------------
		OS 874282 --- Edson (ekjunior)
    Comentado, pois com esse trecho ao importar um XML, o prestador que estava
    sendo gravado no protocolo era o logado no Portal quando deveria ser o 
    pretador informado no XML, caso fosse importado via WebService n?o era 
    passado nenhum prestador e o campo era gravado nulo.
/*----------------------------------------------------------------------------------------------------
select	max(a.nr_seq_prestador)
into	nr_seq_prestador_w
from	pls_usuario_web a,
	pls_rec_glosa_lote b
where	a.nr_sequencia	= b.nr_seq_prestador_web
and	b.nr_sequencia	= nr_seq_lote_p;
*/
if ( ie_prot_duplicado_p = 'S') then

	-- se existe algum registro(que nao e esse que esteja como recebido)
	select 	max(nr_sequencia)
	into STRICT 	nr_seq_prot_imp_w
	from	pls_rec_glosa_protocolo
	where	ds_hash = ds_hash_p --apenas os nao integrados
	and 	ie_situacao != 'T'
	and 	nr_seq_lote != nr_seq_lote_p;

end if;


-- Apenas retornara a mensagem caso tenha prot em importacao(rejeitado ou nao) com mesmo hash que o que esta sendo importado. Se jah for integrado, quem contra-la eh

--a glosa 1308. Essa tratativa aqui apenas para evitar casos onde o prestador fica importando varias vezes o mesmo arquivo por nao entender que a primeira importacao ainda esta sendo processada.
if ( nr_seq_prot_imp_w > 0) then

	--Arquivo em importacao ou rejeitado
	ds_mensagem_erro_p := substr(wheb_mensagem_pck.get_texto(1182112),1,255);
	
end if;

select	max(a.dt_envio_lote)
into STRICT	dt_apresentacao_w
from	pls_rec_glosa_lote a
where	a.nr_sequencia = nr_seq_lote_p;

select	nextval('pls_rec_glosa_protocolo_seq')
into STRICT	nr_seq_protocolo_w
;

insert	into pls_rec_glosa_protocolo(	nr_sequencia, nr_seq_lote, dt_atualizacao,
					nm_usuario,dt_atualizacao_nrec, nm_usuario_nrec,
					nr_seq_xml_arquivo, ie_status, nr_seq_prestador,
					ie_origem_solic,dt_apresentacao_lote, dt_competencia_lote,
					cd_estabelecimento, ds_arquivo, nr_seq_usuario,
					ds_hash)
			values (	nr_seq_protocolo_w, nr_seq_lote_p, clock_timestamp(),
					nm_usuario_p, clock_timestamp(), nm_usuario_p,
					nr_seq_xml_arquivo_p, '1', nr_seq_prestador_w,
					ie_origem_solic_p,dt_apresentacao_w, dt_apresentacao_w,
					cd_estabelecimento_w, substr(nm_arquivo_p,1,255), nr_seq_usuario_p,
					ds_hash_p);

nr_seq_protocolo_p := 	nr_seq_protocolo_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_rec_glosa_protocolo ( nr_seq_lote_p pls_rec_glosa_lote.nr_sequencia%type, nr_seq_xml_arquivo_p pls_rec_glosa_protocolo.nr_seq_xml_arquivo%type, nm_usuario_p usuario.nm_usuario%type, ie_origem_solic_p pls_rec_glosa_protocolo.ie_origem_solic%type default 'M', nr_seq_usuario_p pls_usuario_web.nr_sequencia%type DEFAULT NULL, nr_seq_protocolo_p INOUT pls_rec_glosa_protocolo.nr_sequencia%type DEFAULT NULL, nm_arquivo_p pls_rec_glosa_protocolo.ds_arquivo%type default null, ds_hash_p text default null, ie_prot_duplicado_p text default 'N', ds_mensagem_erro_p INOUT text  DEFAULT NULL) FROM PUBLIC;

