-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_intercambio_web ( nr_seq_guia_p bigint, nr_seq_req_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ds_transacao_p text, ds_observacao_p text, nr_seq_execucao_p INOUT bigint, ds_diretorio_p INOUT text, ie_tipo_transacao_p INOUT text, ds_arquivo_p INOUT text) AS $body$
DECLARE

 
/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade:  Gerar guia de intercâmbio no portal web 
---------------------------------------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[ ] Objetos do dicionário [ ] Tasy (Delphi/Java) [ x ] Portal [ ] Relatórios [ ] Outros: 
 ---------------------------------------------------------------------------------------------------------------------------------------------------- 
Pontos de atenção:  
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
 
Retorno 
I - Intercâmbio 
N - Normal 
 
*/				 
 
cd_usuario_plano_w		varchar(30);
nr_via_w			varchar(5);
nr_seq_segurado_w		bigint;
dt_validade_w			varchar(20);
cd_pessoa_fisica_w		varchar(10);
cd_cooperativa_w		varchar(10) := '';
cd_operadora_usuario_w		varchar(10);
nr_seq_emissor_w		bigint;
ie_tipo_transacao_w		varchar(10) := 'N';
ds_diretorio_w			varchar(255);
ds_hora_w			varchar(15);
ie_tipo_trans_w			varchar(4);
nr_seq_execucao_w		bigint;
nr_seq_origem_w			bigint;

 

BEGIN 
 
if (nr_seq_guia_p IS NOT NULL AND nr_seq_guia_p::text <> '') then 
	select	substr(pls_obter_dados_segurado(nr_seq_segurado,'CR'),1,255), 
		replace(to_char(clock_timestamp(), 'hh24:mi:ss'), ':', '') 
	into STRICT	cd_usuario_plano_w, 
		ds_hora_w 
	from	pls_guia_plano 
	where	nr_sequencia = nr_seq_guia_p;
 
	ie_tipo_trans_w	:= '01';
 
elsif (nr_seq_req_p IS NOT NULL AND nr_seq_req_p::text <> '') then 
	CALL pls_finalizar_requisicao_web(nr_seq_req_p, nm_usuario_p);
	 
	select	substr(pls_obter_dados_segurado(nr_seq_segurado,'CR'),1,255), 
		replace(to_char(clock_timestamp(), 'hh24:mi:ss'), ':', '') 
	into STRICT	cd_usuario_plano_w, 
		ds_hora_w 
	from	pls_requisicao 
	where	nr_sequencia = nr_seq_req_p;
 
	ie_tipo_trans_w	:= '04';
end if;
 
if (cd_usuario_plano_w IS NOT NULL AND cd_usuario_plano_w::text <> '') then 
	/*pls_obter_dados_codigo_barras(cd_usuario_plano_w, nm_beneficiario_w, nr_via_w, nr_seq_segurado_w, dt_validade_w, nr_digito_w, cd_pessoa_fisica_w, cd_estabelecimento_p, nm_usuario_p);*/
 
 
	select	max(nr_seq_emissor) 
	into STRICT	nr_seq_emissor_w 
	from	pls_parametros 
	where	cd_estabelecimento	= cd_estabelecimento_p;
 
	select	pls_obter_campos_carteira(cd_usuario_plano_w,nr_seq_emissor_w,'CM') 
	into STRICT	cd_cooperativa_w 
	;
 
	cd_operadora_usuario_w := coalesce(pls_obter_unimed_estab(cd_estabelecimento_p), '0');
 
	if ((cd_operadora_usuario_w)::numeric  <> (cd_cooperativa_w)::numeric ) then 
		ie_tipo_transacao_w 		:= 	'I';
 
		select 	max(coalesce(ds_diretorio_saida_web, ds_diretorio_saida_cli)) ds_diretorio 
		into STRICT	ds_diretorio_w 
		from 	pls_parametros_scs;
 
		/* Pedido autorização 00500 - PTU 3.5 
		   Pedido audotiração 00600 - PTU 4.0 
		   Cancelamento 00211 - PTU 3.5 
		   Cancelamento 00311 - PTU 4.0 
		   Resposta auditoria 00404 - PTU 4.0 
		   Pedido de Complementação de Autorização 00605 - PTU 4.0/PTU 5.0 
		*/
 
		if (ds_transacao_p = '00600' ) then 
			CALL ptu_gestao_envio_pedido_autor(nr_seq_req_p,nr_seq_guia_p, cd_estabelecimento_p,nm_usuario_p);
			--ptu_gerar_pedido_autorizacao(nr_seq_req_p,nr_seq_guia_p, cd_estabelecimento_p,nm_usuario_p); 
		elsif (ds_transacao_p = '00311' ) then 
			nr_seq_execucao_w := ptu_gestao_envio_cancelamento(nr_seq_guia_p, nr_seq_req_p, null, ds_observacao_p, nr_seq_execucao_w, nm_usuario_p);
			--ptu_gerar_cancelamento(nr_seq_guia_p,nr_seq_req_p, null, nr_seq_execucao_w, nm_usuario_p); 
			nr_seq_execucao_p := nr_seq_execucao_w;
		elsif (ds_transacao_p = '00404' ) then 
			nr_seq_origem_w := ptu_gestao_env_resp_auditoria(	null, nr_seq_req_p, null, null, cd_estabelecimento_p, nm_usuario_p, nr_seq_origem_w);
		 
			CALL pls_valid_regr_incons_ptu_web(nr_seq_req_p, nm_usuario_p, cd_estabelecimento_p);
		elsif (ds_transacao_p = '00605' ) then 
			CALL ptu_gestao_envio_ped_compl_aut(	nr_seq_guia_p, nr_seq_req_p, cd_estabelecimento_p, nm_usuario_p);
		end if;
	end if;
end if;
 
if ((cd_cooperativa_w IS NOT NULL AND cd_cooperativa_w::text <> '') and length(cd_cooperativa_w) = 3) then 
	cd_cooperativa_w 	:=	'0'||cd_cooperativa_w;
end if;
 
ie_tipo_transacao_p 		:= 	ie_tipo_transacao_w;
ds_diretorio_p			:= 	ds_diretorio_w;
ds_arquivo_p			:=	cd_cooperativa_w||'_'||ds_transacao_p||'_'||coalesce(nr_seq_guia_p,nr_seq_req_p)||ie_tipo_trans_w||ds_hora_w||'.1in';
 
if (ds_transacao_p = '00600' and (ds_diretorio_w IS NOT NULL AND ds_diretorio_w::text <> '')) then 
	if (nr_seq_guia_p IS NOT NULL AND nr_seq_guia_p::text <> '') then 
		update ptu_pedido_autorizacao 
		set   ds_arquivo_pedido = ds_arquivo_p 
		where  nr_seq_guia    = nr_seq_guia_p;
	elsif (nr_seq_req_p IS NOT NULL AND nr_seq_req_p::text <> '')then 
		update ptu_pedido_autorizacao 
		set   ds_arquivo_pedido = ds_arquivo_p 
		where  nr_seq_requisicao = nr_seq_req_p;
	end if;
	commit;
elsif (ds_transacao_p = '00311' and (ds_diretorio_w IS NOT NULL AND ds_diretorio_w::text <> '')) then 
	if (nr_seq_guia_p IS NOT NULL AND nr_seq_guia_p::text <> '') then 
		update ptu_cancelamento 
		set   ds_arquivo_pedido = ds_arquivo_p 
		where  nr_seq_guia    = nr_seq_guia_p;
	elsif (nr_seq_req_p IS NOT NULL AND nr_seq_req_p::text <> '')then 
		update ptu_cancelamento 
		set   ds_arquivo_pedido = ds_arquivo_p 
		where  nr_seq_requisicao = nr_seq_req_p;
	end if;
	commit;
elsif (ds_transacao_p = '00605' and (ds_diretorio_w IS NOT NULL AND ds_diretorio_w::text <> '')) then 
	if (nr_seq_guia_p IS NOT NULL AND nr_seq_guia_p::text <> '') then 
		update ptu_pedido_compl_aut 
		set   ds_arquivo_pedido = ds_arquivo_p 
		where  nr_seq_guia    = nr_seq_guia_p;
	elsif (nr_seq_req_p IS NOT NULL AND nr_seq_req_p::text <> '')then 
		update ptu_pedido_compl_aut 
		set   ds_arquivo_pedido = ds_arquivo_p 
		where  nr_seq_requisicao = nr_seq_req_p;
	end if;
	commit;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_intercambio_web ( nr_seq_guia_p bigint, nr_seq_req_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ds_transacao_p text, ds_observacao_p text, nr_seq_execucao_p INOUT bigint, ds_diretorio_p INOUT text, ie_tipo_transacao_p INOUT text, ds_arquivo_p INOUT text) FROM PUBLIC;

