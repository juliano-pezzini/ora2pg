-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_bolsa_bipada_hm ( nr_seq_horario_p bigint, nm_usuario_p text, cd_bolsa_p text default null, cd_hemocomponente_p text default null) AS $body$
DECLARE


ora2pg_rowcount int;
nr_prescricao_w			prescr_medica.nr_prescricao%type;
nr_seq_procedimento_w	prescr_proc_hor.nr_seq_procedimento%type;
nr_sequencia_w			prescr_proc_hor.nr_sequencia%type;
					

BEGIN

select	max(nr_prescricao),
		max(nr_seq_procedimento)
into STRICT	nr_prescricao_w,
		nr_seq_procedimento_w
from	prescr_proc_hor
where	nr_sequencia = nr_seq_horario_p;

select	max(nr_sequencia)
into STRICT	nr_sequencia_w
from	prescr_proc_hor
where	nr_prescricao = nr_prescricao_w
and		nr_seq_procedimento = nr_seq_procedimento_w
and		(dt_inicio_horario IS NOT NULL AND dt_inicio_horario::text <> '');

if	((coalesce(cd_bolsa_p, 'XPTO') <> 'XPTO') and (coalesce(cd_hemocomponente_p, 'XPTO') <> 'XPTO')) then

	update	prescr_proc_bolsa a
	set		ie_bipado  = 'S',
			nm_usuario = nm_usuario_p
	where	cd_bolsa = cd_bolsa_p
	and		nr_bolsa_isbt = cd_hemocomponente_p;

else

	update	prescr_proc_bolsa a
	set		ie_bipado  = 'S',
			nm_usuario = nm_usuario_p
	where	nr_seq_horario = nr_sequencia_w;
	
end if;

GET DIAGNOSTICS ora2pg_rowcount = ROW_COUNT;


if ( ora2pg_rowcount = 0) then
	
	CALL gravar_log_tasy(16574, 'Atualizar_bolsa_bipada_hm'||chr(10)||
	'nr_seq_horario_p = '||nr_seq_horario_p||chr(10)||
	'nm_usuario_p = '||nm_usuario_p||chr(10)||
	'cd_bolsa_p = '||cd_bolsa_p||chr(10)||
	'cd_hemocomponente_p = '||cd_hemocomponente_p||chr(10)||
	'nr_prescricao_w = '||nr_prescricao_w||chr(10)||
	'nr_seq_procedimento_w = '||nr_seq_procedimento_w||chr(10)||
	'nr_sequencia_w = '||nr_sequencia_w, wheb_usuario_pck.get_nm_usuario);

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_bolsa_bipada_hm ( nr_seq_horario_p bigint, nm_usuario_p text, cd_bolsa_p text default null, cd_hemocomponente_p text default null) FROM PUBLIC;

