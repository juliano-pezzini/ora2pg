-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baixar_movto_banco_pend (nr_seq_movto_pend_p bigint, dt_baixa_p timestamp, vl_baixa_p bigint, nr_titulo_p bigint, nr_seq_baixa_p bigint, nm_usuario_p text, ie_commit_p text, nr_bordero_rec_p bigint, nr_seq_conv_receb_p bigint, nr_adiantamento_p bigint, nr_seq_cheque_p bigint, nr_seq_movto_banco_p bigint, nr_seq_movto_caixa_p bigint, nr_seq_movto_cartao_p bigint, nr_seq_lote_cartao_p bigint, nr_sequencia_baixa_p bigint default null, nr_seq_perda_baixa_p perda_contas_receb_baixa.nr_sequencia%type default null, nr_seq_perda_p perda_contas_receb_baixa.nr_seq_perda%type default null, nr_seq_trans_financ_baixa_p movto_banco_pend_baixa.nr_seq_trans_financ_baixa%type default null) AS $body$
DECLARE


/* tipo de baixa - ie_tipo_baixa_w

1	Titulo a receber
2	Bordero de recebimento
3	Recebimento de convenio
4	Adiantamento
5	Cheque
6	Recuperacao de perdas
7	Movimentacao bancaria
8	Movimentacao de tesouraria

*/
ie_tipo_baixa_w			bigint;
nr_seq_tipo_baixa_w		bigint;
nr_seq_conta_banco_od_w		bigint;
nr_seq_baixa_w			bigint;
vl_juros_w			double precision;
vl_multa_w			double precision;
cd_estabelecimento_w		smallint;
nr_seq_trans_financ_baixa_w	bigint;
nr_seq_baixa_origem_w		movto_banco_pend_baixa.nr_seq_baixa%type;
/* Porjeto Multimoeda - Variaveis */

vl_credito_estrang_w		double precision;
vl_baixa_estrang_w		double precision;
vl_complemento_w		double precision;
vl_cotacao_w			cotacao_moeda.vl_cotacao%type;
cd_moeda_w			integer;
cd_moeda_cred_w			integer;
cd_moeda_empresa_w		integer;
ie_estorno_bordero_w	varchar(1) := 'N';
movto_banco_pend_baixa_seq_w movto_banco_pend_baixa.nr_sequencia%type;


BEGIN

if (nr_seq_movto_pend_p IS NOT NULL AND nr_seq_movto_pend_p::text <> '') then

    if (nr_seq_trans_financ_baixa_p IS NOT NULL AND nr_seq_trans_financ_baixa_p::text <> '') then
        nr_seq_trans_financ_baixa_w := nr_seq_trans_financ_baixa_p;
    end if;
	
	if (nr_seq_perda_baixa_p IS NOT NULL AND nr_seq_perda_baixa_p::text <> '') then ie_tipo_baixa_w := 6; end if;
	nr_seq_baixa_w	:= nr_seq_baixa_p;
	
	/* Projeto Multimoeda - Busca valor em moeda estrangeira no movto pendente para identificar se eh movto em moeda estrangeira. */

	select coalesce(max(vl_credito_estrang),0),
		max(cd_moeda)
	into STRICT vl_credito_estrang_w,
		cd_moeda_cred_w
	from movto_banco_pend
	where nr_sequencia = nr_seq_movto_pend_p;

	if (nr_titulo_p IS NOT NULL AND nr_titulo_p::text <> '') then
		if (nr_seq_baixa_p IS NOT NULL AND nr_seq_baixa_p::text <> '') then
			ie_tipo_baixa_w	:= 1;
		else
			ie_tipo_baixa_w	:= 6;
		end if;

		select	max(a.cd_estabelecimento)
		into STRICT	cd_estabelecimento_w
		from	titulo_receber a
		where	a.nr_titulo		= nr_titulo_p;
		
		/* Projeto Multimoeda - Busca os dados da baixa relacionada com o titulo quando se tratar de movto em moeda estrangeira. */

		if (coalesce(vl_credito_estrang_w,0) <> 0 and (nr_seq_baixa_p IS NOT NULL AND nr_seq_baixa_p::text <> '')) then
			select max(b.vl_recebido_estrang),
				max(b.vl_cotacao),
				max(b.cd_moeda)
			into STRICT vl_baixa_estrang_w,
				vl_cotacao_w,
				cd_moeda_w
			from titulo_receber_liq b
			where b.nr_titulo = nr_titulo_p
			  and b.nr_sequencia = nr_seq_baixa_p;
		end if;

	elsif (nr_bordero_rec_p IS NOT NULL AND nr_bordero_rec_p::text <> '') then
		ie_tipo_baixa_w	:= 2;

		select	max(a.cd_estabelecimento)
		into STRICT	cd_estabelecimento_w
		from	bordero_recebimento a
		where	a.nr_bordero		= nr_bordero_rec_p;
		
		/*Considerar juros e multa dos titulos do bordero para lancar na baixa do CNI*/

		select	coalesce(sum(a.vl_juros),0),
				coalesce(sum(a.vl_multa),0)
		into STRICT	vl_juros_w,
				vl_multa_w
		from	bordero_tit_rec a
		where	a.nr_bordero = nr_bordero_rec_p;
		
		if (vl_baixa_p < 0) then /*Se a baixa for negativa, eh estorno, entao deve deixar os juros dessa baixa negativos */
			vl_juros_w := vl_juros_w * -1;
			vl_multa_w := vl_multa_w * -1;
			ie_estorno_bordero_w := 'S';
		end if;
		
		select	obter_moeda_padrao_empresa(cd_estabelecimento_w,'E')
		into STRICT	cd_moeda_empresa_w
		;
		
		/* Projeto Multimoeda - Busca os dados da baixa relacionada com o bordero quando se tratar de movto em moeda estrangeira. */

		select	max(a.vl_cotacao),
			max(a.cd_moeda)
		into STRICT	vl_cotacao_w,
			cd_moeda_w
		from	bordero_recebimento a
		where	a.nr_bordero = nr_bordero_rec_p;
		/* Projeto Multimoeda - Verifica se a moeda do credito eh a mesma do bordero.*/

		if (coalesce(cd_moeda_cred_w,cd_moeda_empresa_w) <> coalesce(cd_moeda_w,cd_moeda_empresa_w)) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(348725);
		end if;
		/* Verifica se o credito eh em moeda estrangeira, caso positivo calcula o valor da baixa em moeda estrangeira.*/

		if (coalesce(vl_credito_estrang_w,0) <> 0) then
			if (coalesce(vl_cotacao_w,0) <> 0) then
				vl_baixa_estrang_w := coalesce(vl_baixa_p,0) / vl_cotacao_w;
			end if;
		end if;

	elsif (nr_seq_conv_receb_p IS NOT NULL AND nr_seq_conv_receb_p::text <> '') then
		ie_tipo_baixa_w	:= 3;

		select	max(a.cd_estabelecimento)
		into STRICT	cd_estabelecimento_w
		from	convenio_receb a
		where	a.nr_sequencia		= nr_seq_conv_receb_p;
		
		/* Projeto Multimoeda - Busca os dados da baixa relacionada com o convenio recebimento quando se tratar de movto em moeda estrangeira
			para realizar o estorno da baixa. */
		if (coalesce(vl_credito_estrang_w,0) <> 0) then
			select max(b.vl_moeda_original),
				max(b.tx_cambial),
				max(b.cd_moeda)
			into STRICT vl_baixa_estrang_w,
				vl_cotacao_w,
				cd_moeda_w
			from convenio_receb b
			where b.nr_sequencia = nr_seq_conv_receb_p;
		end if;

	elsif (nr_adiantamento_p IS NOT NULL AND nr_adiantamento_p::text <> '') then
		ie_tipo_baixa_w	:= 4;

		select	max(a.cd_estabelecimento)
		into STRICT	cd_estabelecimento_w
		from	adiantamento a
		where	a.nr_adiantamento	= nr_adiantamento_p;
		
		if (coalesce(nr_seq_trans_financ_baixa_w::text, '') = '') then
			select	max(nr_seq_trans_fin_adiant_cni) /*llhalves OS 578011 em 24/04/2013*/
			into STRICT	nr_seq_trans_financ_baixa_w
			from	parametro_contas_receber
			where	cd_estabelecimento	= cd_estabelecimento_w;
		end if;
		
		/* Projeto Multimoeda - Busca os dados da baixa relacionada com o adiantamento quando se tratar de movto em moeda estrangeira
			para realizar o estorno da baixa. */
		if (coalesce(vl_credito_estrang_w,0) <> 0) then
			select max(b.vl_saldo_estrang),
				max(b.vl_cotacao),
				max(b.cd_moeda)
			into STRICT vl_baixa_estrang_w,
				vl_cotacao_w,
				cd_moeda_w
			from adiantamento b
			where b.nr_adiantamento = nr_adiantamento_p;
		end if;

	elsif (nr_seq_cheque_p IS NOT NULL AND nr_seq_cheque_p::text <> '') then
		ie_tipo_baixa_w	:= 5;
		
		if (nr_seq_baixa_p IS NOT NULL AND nr_seq_baixa_p::text <> '') then
			select	max(coalesce(vl_juros,0) * -1),
				max(coalesce(vl_multa,0) * -1)
			into STRICT	vl_juros_w,
				vl_multa_w
			from	movto_banco_pend_baixa
			where	nr_sequencia = nr_seq_baixa_p;
			
			nr_seq_baixa_w	:= null;
		end if;

		select	max(a.cd_estabelecimento)
		into STRICT	cd_estabelecimento_w
		from	cheque_cr a
		where	a.nr_seq_cheque	= nr_seq_cheque_p;
		
		/* Projeto Multimoeda - Busca os dados da baixa relacionada com o cheque quando se tratar de movto em moeda estrangeira. */

		if (coalesce(vl_credito_estrang_w,0) <> 0) then
			select max(b.vl_cheque_estrang),
				max(b.vl_cotacao),
				max(b.cd_moeda)
			into STRICT vl_baixa_estrang_w,
				vl_cotacao_w,
				cd_moeda_w
			from cheque_cr b
			where b.nr_seq_cheque = nr_seq_cheque_p;
		end if;

	elsif (nr_seq_movto_banco_p IS NOT NULL AND nr_seq_movto_banco_p::text <> '') then
		ie_tipo_baixa_w	:= 7;

		select	max(c.cd_estabelecimento)
		into STRICT	cd_estabelecimento_w
		from	banco_estabelecimento c,
			banco_saldo b,
			movto_trans_financ a
		where	b.nr_seq_conta		= c.nr_sequencia
		and	a.nr_seq_saldo_banco	= b.nr_sequencia
		and	a.nr_sequencia		= nr_seq_movto_banco_p;
		
		/* Projeto Multimoeda - Busca os dados da baixa relacionada com a transacao quando se tratar de movto em moeda estrangeira
			para realizar o estorno da baixa. */
		if (coalesce(vl_credito_estrang_w,0) <> 0) then
			select max(b.vl_transacao_estrang),
				max(b.vl_cotacao),
				max(b.cd_moeda)
			into STRICT vl_baixa_estrang_w,
				vl_cotacao_w,
				cd_moeda_w
			from movto_trans_financ b
			where b.nr_sequencia = nr_seq_movto_banco_p;
		end if;

	elsif (nr_seq_movto_caixa_p IS NOT NULL AND nr_seq_movto_caixa_p::text <> '') then
		ie_tipo_baixa_w	:= 8;

		select	max(c.cd_estabelecimento)
		into STRICT	cd_estabelecimento_w
		from	caixa c,
			caixa_saldo_diario b,
			movto_trans_financ a
		where	b.nr_seq_caixa		= c.nr_sequencia
		and	a.nr_seq_saldo_caixa	= b.nr_sequencia
		and	a.nr_sequencia		= nr_seq_movto_caixa_p;

		select	max(NR_SEQ_CONTA_BANCO)
		into STRICT	NR_SEQ_CONTA_BANCO_OD_W
		from	movto_banco_pend
		where	nr_sequencia		= nr_seq_movto_pend_p;

		update	movto_trans_financ
		set	NR_SEQ_BANCO_OD	= NR_SEQ_CONTA_BANCO_OD_W
		where	nr_sequencia		= nr_seq_movto_caixa_p
		and	coalesce(NR_SEQ_BANCO_OD::text, '') = '';
		
		/* Projeto Multimoeda - Busca os dados da baixa relacionada com a transacao quando se tratar de movto em moeda estrangeira. */

		if (coalesce(vl_credito_estrang_w,0) <> 0) then
			select max(b.vl_transacao_estrang),
				max(b.vl_cotacao),
				max(b.cd_moeda)
			into STRICT vl_baixa_estrang_w,
				vl_cotacao_w,
				cd_moeda_w
			from movto_trans_financ b
			where b.nr_sequencia = nr_seq_movto_caixa_p;
		end if;
		
	elsif (nr_seq_movto_cartao_p IS NOT NULL AND nr_seq_movto_cartao_p::text <> '') then
		ie_tipo_baixa_w	:= 7;
		
		select	max(c.cd_estabelecimento)
		into STRICT	cd_estabelecimento_w
		from	movto_cartao_cr c,
			movto_cartao_cr_parcela b,
			movto_cartao_cr_baixa a
		where	a.nr_seq_parcela	= b.nr_sequencia
		and	b.nr_seq_movto		= c.nr_sequencia
		and	a.nr_sequencia		= nr_seq_movto_cartao_p;

	elsif (nr_seq_lote_cartao_p IS NOT NULL AND nr_seq_lote_cartao_p::text <> '') then	
		ie_tipo_baixa_w	:= 7;
		
		select 	max(cd_estabelecimento)
		into STRICT	cd_estabelecimento_w
		from	lote_baixa_cartao_cr
		where	nr_sequencia	= nr_seq_lote_cartao_p;
		
	end if;

	select	max(a.nr_sequencia)
	into STRICT	nr_seq_tipo_baixa_w
	from	tipo_baixa_cni a
	where	a.cd_estabelecimento	= coalesce(cd_estabelecimento_w,a.cd_estabelecimento)
	and	a.ie_tipo_baixa		= ie_tipo_baixa_w
	and	a.ie_situacao		= 'A';
	
	/* Projeto Multimoeda - Verifica se existe baixa em moeda estrangeira, caso negativo limpa as variaveis de moeda estrangeira*/

	if (coalesce(vl_baixa_estrang_w,0) <> 0) then
		if (vl_baixa_p < 0 and vl_baixa_estrang_w > 0) then
			vl_baixa_estrang_w := vl_baixa_estrang_w * -1;
		end if;
		vl_complemento_w	:= vl_baixa_p - vl_baixa_estrang_w;
	else
		vl_baixa_estrang_w	:= null;
		vl_complemento_w	:= null;
		vl_cotacao_w		:= null;
		cd_moeda_w		:= null;
	end if;
	
	insert	into	movto_banco_pend_baixa(nr_sequencia,
		nm_usuario,
		dt_atualizacao,
		nm_usuario_nrec,
		dt_atualizacao_nrec,
		nr_seq_movto_pend,
		dt_baixa,
		vl_baixa,
		nr_titulo,
		nr_seq_baixa,
		nr_bordero_rec,
		nr_seq_conv_receb,
		nr_adiantamento,
		nr_seq_tipo_baixa,
		nr_seq_cheque,
		nr_seq_movto_trans_fin,
		nr_seq_cartao_baixa,
		nr_seq_lote_cartao,
		vl_juros,
		vl_multa,
		nr_seq_trans_financ_baixa,
		nr_seq_baixa_origem,
		vl_baixa_estrang,
		vl_complemento,
		vl_cotacao,
		cd_moeda,
		ie_lib_bordero_rec)
	values (nextval('movto_banco_pend_baixa_seq'),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nr_seq_movto_pend_p,
		coalesce(dt_baixa_p,clock_timestamp()),
		CASE WHEN ie_tipo_baixa_w=2 THEN CASE WHEN ie_estorno_bordero_w='S' THEN vl_baixa_p  ELSE (vl_baixa_p - coalesce(vl_juros_w,0) - coalesce(vl_multa_w,0)) END   ELSE vl_baixa_p END ,
		nr_titulo_p,
		nr_seq_baixa_w,
		nr_bordero_rec_p,
		nr_seq_conv_receb_p,
		nr_adiantamento_p,
		nr_seq_tipo_baixa_w,
		nr_seq_cheque_p,
		coalesce(nr_seq_movto_banco_p,nr_seq_movto_caixa_p),
		nr_seq_movto_cartao_p,
		nr_seq_lote_cartao_p,
		coalesce(vl_juros_w,0),
		coalesce(vl_multa_w,0),
		nr_seq_trans_financ_baixa_w,
		CASE WHEN nr_sequencia_baixa_p=0 THEN null  ELSE nr_sequencia_baixa_p END ,
		vl_baixa_estrang_w,
		vl_complemento_w,
		vl_cotacao_w,
		cd_moeda_w,
		CASE WHEN ie_tipo_baixa_w=2 THEN  CASE WHEN ie_estorno_bordero_w='S' THEN 'S'  ELSE 'N' END   ELSE null END  )
	returning nr_sequencia into movto_banco_pend_baixa_seq_w;   	

    if (nr_seq_perda_baixa_p IS NOT NULL AND nr_seq_perda_baixa_p::text <> '') then
        update perda_contas_receb_baixa 
        set nr_seq_movto_pend_baixa = movto_banco_pend_baixa_seq_w
        where nr_sequencia = nr_seq_perda_baixa_p and nr_seq_perda = nr_seq_perda_p;
    end if;
		
	CALL atualizar_saldo_movto_bco_pend(nr_seq_movto_pend_p,nm_usuario_p,'N');
end if;

if (ie_commit_p = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baixar_movto_banco_pend (nr_seq_movto_pend_p bigint, dt_baixa_p timestamp, vl_baixa_p bigint, nr_titulo_p bigint, nr_seq_baixa_p bigint, nm_usuario_p text, ie_commit_p text, nr_bordero_rec_p bigint, nr_seq_conv_receb_p bigint, nr_adiantamento_p bigint, nr_seq_cheque_p bigint, nr_seq_movto_banco_p bigint, nr_seq_movto_caixa_p bigint, nr_seq_movto_cartao_p bigint, nr_seq_lote_cartao_p bigint, nr_sequencia_baixa_p bigint default null, nr_seq_perda_baixa_p perda_contas_receb_baixa.nr_sequencia%type default null, nr_seq_perda_p perda_contas_receb_baixa.nr_seq_perda%type default null, nr_seq_trans_financ_baixa_p movto_banco_pend_baixa.nr_seq_trans_financ_baixa%type default null) FROM PUBLIC;

