-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_venc_repasse ( nr_repasse_terceiro_p bigint, ie_gerar_tributos_p text, nm_usuario_p text, ie_commit_p text) AS $body$
DECLARE

 
 
dt_base_w			timestamp;
cd_cond_pagto_w			bigint;
vl_repasse_w			double precision;
vl_parcela_w			double precision;
vl_tot_venc_w			double precision;
dt_parcela_w			timestamp;
nr_sequencia_w			bigint;
nr_seq_venc_w			bigint;
cd_estabelecimento_w		integer;
--pr_ir_w			Number(15,4);			-- Edgar 16/03/2006 OS 31477, o IR não é mais calculado aqui 
vl_ir_w				double precision;
pr_imp_munic_w			double precision := 0;
vl_imposto_munic_w		double precision := 0;
qt_venc_w			integer;
ds_venc_w			varchar(2000);
i				integer;
cd_beneficiario_w		varchar(14);
ie_trib_venc_repasse_w		varchar(1);
ie_nota_fiscal_w		integer := 0;
ie_venc_retroativo_w 		varchar(1);
vl_total_proc_repasse_w		double precision;
vl_total_mat_repasse_w		double precision;
vl_total_item_repasse_w		double precision;
vl_parcela_proc_w		double precision;
vl_parcela_mat_w		double precision;
vl_parcela_item_w		double precision;
vl_adiantamento_w		double precision;
vl_parcela_adiant_w		double precision;
vl_tot_adiant_w			double precision;
vl_desp_cartao_mat_w		material_repasse.vl_desp_cartao%type;
vl_desp_cartao_proc_w		procedimento_repasse.vl_desp_cartao%type;

c01 CURSOR FOR 
SELECT	nr_sequencia 
from	repasse_terceiro_venc 
where	nr_repasse_terceiro	= nr_repasse_terceiro_p 
and	ie_trib_venc_repasse_w	= 'S' 
and	ie_gerar_tributos_p	= 'S';


BEGIN 
 
select	coalesce(max(dt_base_vencto), coalesce(max(dt_periodo_final),clock_timestamp())), 
	max(a.cd_condicao_pagamento), 
	obter_valor_repasse(max(a.nr_repasse_terceiro),'L'), 
	max(a.cd_estabelecimento) 
into STRICT	dt_base_w, 
	cd_cond_pagto_w, 
	vl_repasse_w, 
	cd_estabelecimento_w 
from	terceiro b, 
	repasse_terceiro a 
where	a.nr_repasse_terceiro	= nr_repasse_terceiro_p 
and	a.nr_seq_terceiro		= b.nr_sequencia;
 
select	coalesce(sum(vl_liberado),0), 
	coalesce(sum(coalesce(vl_desp_cartao,0)),0) 
into STRICT	vl_total_proc_repasse_w, 
	vl_desp_cartao_proc_w 
from 	procedimento_repasse 
where 	nr_repasse_terceiro	= nr_repasse_terceiro_p;
 
select	coalesce(sum(vl_liberado),0), 
	coalesce(sum(coalesce(vl_desp_cartao,0)),0) 
into STRICT	vl_total_mat_repasse_w, 
	vl_desp_cartao_mat_w 
from	material_repasse 
where	nr_repasse_terceiro	= nr_repasse_terceiro_p;
 
select 	coalesce(sum(CASE WHEN coalesce(nr_adiant_pago,0)=0 THEN vl_repasse  ELSE 0 END ),0) vl_total_item_repasse, 
	coalesce(sum(CASE WHEN coalesce(nr_adiant_pago,0)=0 THEN 0  ELSE vl_repasse END ),0) vl_adiantamento 
into STRICT	vl_total_item_repasse_w, 
	vl_adiantamento_w 
from	repasse_terceiro_item 
where 	nr_repasse_terceiro	= nr_repasse_terceiro_p;
 
vl_repasse_w	:= coalesce(vl_repasse_w,0) - coalesce(vl_adiantamento_w,0);
 
BEGIN 
select	max(cd_beneficiario_ir) 
into STRICT	cd_beneficiario_w 
from	parametros_contas_pagar 
where	cd_estabelecimento		= cd_estabelecimento_w;
exception 
when no_data_found then 
	--r.aise_application_error(-20011, 'Parâmetros do contas a pagar não cadastrados para o estabelecimento ' || cd_estabelecimento_w ||'#@#@'); 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(267371,'cd_estabelecimento_w='||cd_estabelecimento_w);
end;
 
/* if	(cd_beneficiario_w is null) then 
	pr_ir_w			:= 0; 
end if; */
 
 
/*	Jacson OS 42053	 - consistir se já tiver nota fiscal gerada para o repasse	*/
 
/*	Paulo OS 56796 - alterado para consistir somente se a nota estiver "ativa"	*/
 
select	coalesce(max(nr_seq_nota_fiscal),0) 
into STRICT	ie_nota_fiscal_w 
from	repasse_nota_fiscal a, 
	nota_fiscal b 
where	a.nr_seq_nota_fiscal	= b.nr_sequencia 
and	b.ie_situacao		= '1' 
and	a.nr_repasse_terceiro	= nr_repasse_terceiro_p;
 
if (ie_nota_fiscal_w > 0) then 
	--r.aise_application_error(-20011,	'O repasse já possui nota fiscal. Os vencimentos não podem ser gerados!'||'#@#@'); 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(267372);
end if;
 
delete from repasse_terc_venc_trib 
where	ie_pago_prev	<> 'P' -- Edgar 19/09/2007, deletar somente previstos 
and	nr_seq_rep_venc in ( 
	SELECT	nr_sequencia 
	from	repasse_terceiro_venc 
	where	nr_repasse_terceiro	= nr_repasse_terceiro_p);
 
delete from repasse_terceiro_venc 
where	nr_repasse_terceiro	= nr_repasse_terceiro_p;
 
if (coalesce(cd_cond_pagto_w::text, '') = '') then 
	--r.aise_application_error(-20011,'Não foi informada a condição de pagamento'||'#@#@'); 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(267373);
end if;
SELECT * FROM calcular_vencimento(cd_estabelecimento_w, cd_cond_pagto_w, dt_base_w, qt_venc_w, ds_venc_w) INTO STRICT qt_venc_w, ds_venc_w;
 
select	max(a.ie_venc_retroativo) 
into STRICT	ie_venc_retroativo_w 
from	parametro_repasse a 
where	a.cd_estabelecimento	= cd_estabelecimento_w;
 
if (qt_venc_w > 0) then 
	vl_tot_venc_w		:= 0;
	vl_tot_adiant_w		:= 0;
	vl_parcela_w 		:= dividir(vl_repasse_w, qt_venc_w);
	vl_parcela_proc_w	:= dividir(vl_total_proc_repasse_w, qt_venc_w);
	vl_parcela_mat_w	:= dividir(vl_total_mat_repasse_w, qt_venc_w);	
	vl_parcela_item_w	:= dividir(vl_total_item_repasse_w, qt_venc_w);
	vl_parcela_adiant_w	:= dividir(vl_adiantamento_w, qt_venc_w);
	vl_desp_cartao_mat_w	:= dividir(vl_desp_cartao_mat_w, qt_venc_w);
	vl_desp_cartao_proc_w	:= dividir(vl_desp_cartao_proc_w, qt_venc_w);
	FOR i IN 1..qt_venc_w	LOOP 
   		dt_parcela_w	:= to_date(substr(ds_venc_w,1,10),'dd/mm/yyyy');
 
		if (dt_parcela_w < clock_timestamp()) and (ie_venc_retroativo_w = 'N') then 
			--r.aise_application_error(-20011,'Não é possível gerar vencimento com data inferior a data atual. Data: ' || dt_parcela_w ||'#@#@'); 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(267374,'dt_parcela_w='||dt_parcela_w);
		end if;
 
		ds_venc_w	:= substr(ds_venc_w,12,255);
/*		vl_ir_w		:= vl_parcela_w	* pr_ir_w / 100; */
 
 
		vl_ir_w		:= 0;
 
		if (i = qt_venc_w) then 
			vl_parcela_w		:= vl_repasse_w - vl_tot_venc_w;
			vl_parcela_adiant_w	:= vl_adiantamento_w - vl_tot_adiant_w;
		end if;
 
		select	nextval('repasse_terceiro_venc_seq') 
		into STRICT	nr_sequencia_w 
		;
 
		insert	into repasse_terceiro_venc( 
			nr_sequencia, 
			nr_repasse_terceiro, 
			vl_vencimento, 
			dt_vencimento, 
			dt_atualizacao, 
			nm_usuario, 
			nr_titulo, 
			pr_ir, 
			vl_ir, 
			pr_imp_munic, 
			vl_imposto_munic, 
			vl_liquido, 
			vl_repasse_proc, 
			vl_repasse_mat, 
			vl_repasse_item, 
			vl_adiantamento, 
			vl_desp_cartao) 
		values (	nr_sequencia_w, 
			nr_repasse_terceiro_p, 
			vl_parcela_w, 
			dt_parcela_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			null, 
			0, 
			vl_ir_w, 
			pr_imp_munic_w, 
			vl_imposto_munic_w, 
			vl_parcela_w, 
			vl_parcela_proc_w, 
			vl_parcela_mat_w, 
			vl_parcela_item_w, 
			vl_parcela_adiant_w, 
			vl_desp_cartao_mat_w + vl_desp_cartao_proc_w);
		 
		vl_tot_venc_w	:= vl_tot_venc_w + vl_parcela_w;
		vl_tot_adiant_w	:= vl_tot_adiant_w + vl_parcela_adiant_w;
	END LOOP;
end if;
 
select	IE_TRIB_VENC_REPASSE 
into STRICT	ie_trib_venc_repasse_w 
from	parametro_faturamento 
where	cd_estabelecimento		= cd_estabelecimento_w;
 
open c01;
loop 
fetch c01 into 
	nr_seq_venc_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	CALL Gerar_Tributo_Venc_Repasse(nr_seq_venc_w);
end loop;
close c01;
 
if (coalesce(ie_commit_p,'S') <> 'N') then 
	commit;
end if;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_venc_repasse ( nr_repasse_terceiro_p bigint, ie_gerar_tributos_p text, nm_usuario_p text, ie_commit_p text) FROM PUBLIC;

