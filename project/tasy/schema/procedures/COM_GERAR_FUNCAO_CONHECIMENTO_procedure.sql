-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE com_gerar_funcao_conhecimento (nr_seq_conhecimento_p bigint, nr_seq_modulo_p bigint, nm_usuario_p text, ie_tipo_consultor_p text) AS $body$
DECLARE



cd_funcao_w		bigint;
cd_funcao_gestao_con	bigint;
ie_situacao_w		varchar(1);
nr_sequencia_w		bigint;

C01 CURSOR FOR
	SELECT	a.cd_funcao
	from	funcao a
	where	a.ie_situacao = 'A'
	and	a.nr_seq_mod_impl = nr_seq_modulo_p
	and	not exists (	SELECT 	1
				from 	com_cons_gest_con_fun x
				where 	x.cd_funcao = a.cd_funcao
				and   	x.nr_seq_conhecimento = nr_seq_conhecimento_p)
	and	ds_aplicacao <> 'TasyRel';
--	and	((upper(ie_classif_produto) = upper(ie_tipo_consultor_p))
--	or	 (ie_classif_produto = 'A'));
C02 CURSOR FOR
	SELECT	nr_sequencia
	from	funcao f,
		com_cons_gest_con_fun c
	where	c.cd_funcao = f.cd_funcao
	and	c.nr_seq_conhecimento = nr_seq_conhecimento_p
	and	f.ie_situacao = 'I';


BEGIN

open C01;
loop
fetch C01 into
	cd_funcao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	insert into com_cons_gest_con_fun(nr_sequencia		,
		nr_seq_conhecimento	,
		cd_funcao               ,
		dt_atualizacao          ,
		nm_usuario              ,
		dt_atualizacao_nrec     ,
		nm_usuario_nrec         ,
		dt_certificacao         ,
		pr_conhecimento         ,
		ie_implantou            ,
		ie_ead                  ,
		ie_treinamento_interno	,
		ie_situacao)
	values (	nextval('com_cons_gest_con_fun_seq'),
		nr_seq_conhecimento_p,
		cd_funcao_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p, null,
		0, 'N', 'N', 'N', 'A');

	end;
end loop;
close C01;

commit;

open c02;
loop
fetch c02 into
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin

	delete from com_cons_gest_con_fun where nr_sequencia = nr_sequencia_w;
	commit;

	end;
end loop;
close c02;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE com_gerar_funcao_conhecimento (nr_seq_conhecimento_p bigint, nr_seq_modulo_p bigint, nm_usuario_p text, ie_tipo_consultor_p text) FROM PUBLIC;

