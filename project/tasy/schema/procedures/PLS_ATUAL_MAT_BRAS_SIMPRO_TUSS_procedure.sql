-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atual_mat_bras_simpro_tuss ( nr_seq_material_p pls_material.nr_sequencia%type, nr_seq_tuss_mat_item_p tuss_material_item.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, ie_opcao_p text, ie_acao_p text) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
ie_opcao_p 
B = Brasindice 
S = Simpro 
 
ie_acao_p 
0 = Somente selecionados 
 1 = Todos 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 
 
cd_material_tuss_w	tuss_material_item.cd_material_tuss%type;
cd_tiss_w		brasindice_preco.cd_tiss%type;
cd_simpro_w		simpro_preco.cd_simpro%type;
tb_nr_seq_material_w	pls_util_cta_pck.t_number_table;
tb_cd_tiss_w		pls_util_cta_pck.t_varchar2_table_15;
x			integer := 0;

C01 CURSOR FOR 
	SELECT (SELECT	max(x.cd_material_tuss) 
		 from	tuss_material_item x 
		 where	x.nr_sequencia = a.nr_seq_tuss_mat_item) cd_material_tuss, 
		a.nr_sequencia nr_seq_material 
	from	pls_material a 
	where	a.ie_situacao = 'A' 
	and (coalesce(a.dt_exclusao::text, '') = '' or a.dt_exclusao > clock_timestamp()) 
	and	(a.nr_seq_tuss_mat_item IS NOT NULL AND a.nr_seq_tuss_mat_item::text <> '');

BEGIN 
 
if (nr_seq_tuss_mat_item_p IS NOT NULL AND nr_seq_tuss_mat_item_p::text <> '') and (ie_acao_p = 0) then 
	 
	select	max(cd_material_tuss) 
	into STRICT	cd_material_tuss_w 
	from	tuss_material_item 
	where	nr_sequencia = nr_seq_tuss_mat_item_p;
	 
	if (cd_material_tuss_w IS NOT NULL AND cd_material_tuss_w::text <> '') then 
		 
		if (ie_opcao_p = 'B') then 
			select	max(a.cd_tiss) 
			into STRICT	cd_tiss_w 
			from	brasindice_preco a 
			where	a.cd_tuss = cd_material_tuss_w 
			and	a.dt_inicio_vigencia = (	SELECT	max(x.dt_inicio_vigencia) 
								from	brasindice_preco x 
								where	x.cd_tuss = cd_material_tuss_w 
								and	x.dt_inicio_vigencia < clock_timestamp());
								 
			if (cd_tiss_w IS NOT NULL AND cd_tiss_w::text <> '') then 
				update	pls_material 
				set	cd_tiss_brasindice = cd_tiss_w, 
					dt_atualizacao = clock_timestamp(), 
					nm_usuario = nm_usuario_p 
				where	nr_sequencia = nr_seq_material_p;
			end if;
			 
		elsif (ie_opcao_p = 'S') then 
			 
			select	max(a.cd_simpro) 
			into STRICT	cd_simpro_w 
			from	simpro_preco a 
			where	a.cd_tuss = cd_material_tuss_w 
			and	a.dt_vigencia = (	SELECT	max(x.dt_vigencia) 
							from	simpro_preco x 
							where	x.cd_tuss = cd_material_tuss_w 
							and	x.dt_vigencia < clock_timestamp());
							 
			if (cd_simpro_w IS NOT NULL AND cd_simpro_w::text <> '') then 
				update	pls_material 
				set	cd_simpro = cd_simpro_w, 
					dt_atualizacao = clock_timestamp(), 
					nm_usuario = nm_usuario_p 
				where	nr_sequencia = nr_seq_material_p;
			end if;		
		end if;
	end if;
elsif (ie_acao_p = 1) then 
	 
	for r_C01_w in C01 loop 
	 
		if (r_C01_w.cd_material_tuss IS NOT NULL AND r_C01_w.cd_material_tuss::text <> '') then 
			 
			if (ie_opcao_p = 'B') then 
				select	max(a.cd_tiss) 
				into STRICT	cd_tiss_w 
				from	brasindice_preco a 
				where	a.cd_tuss = r_C01_w.cd_material_tuss 
				and	a.dt_inicio_vigencia = (	SELECT	max(x.dt_inicio_vigencia) 
									from	brasindice_preco x 
									where	x.cd_tuss = r_C01_w.cd_material_tuss 
									and	x.dt_inicio_vigencia < clock_timestamp());
									 
				if (cd_tiss_w IS NOT NULL AND cd_tiss_w::text <> '') then 
					tb_nr_seq_material_w(x) := r_C01_w.nr_seq_material;
					tb_cd_tiss_w(x) := cd_tiss_w;
					 
					if (tb_nr_seq_material_w.count >= pls_util_pck.qt_registro_transacao_w) then 
						forall i in tb_nr_seq_material_w.first .. tb_nr_seq_material_w.last 
							update	pls_material 
							set	cd_tiss_brasindice = tb_cd_tiss_w(i), 
								dt_atualizacao = clock_timestamp(), 
								nm_usuario = nm_usuario_p 
							where	nr_sequencia = tb_nr_seq_material_w(i);
						commit;
						 
						tb_nr_seq_material_w.delete;
						tb_cd_tiss_w.delete;
						x := 0;
					else 
						x := x + 1;
					end if;
				end if;
			elsif (ie_opcao_p = 'S') then 
				 
				select	max(a.cd_simpro) 
				into STRICT	cd_simpro_w 
				from	simpro_preco a 
				where	a.cd_tuss = r_C01_w.cd_material_tuss 
				and	a.dt_vigencia = (	SELECT	max(x.dt_vigencia) 
								from	simpro_preco x 
								where	x.cd_tuss = r_C01_w.cd_material_tuss 
								and	x.dt_vigencia < clock_timestamp());
								 
				if (cd_simpro_w IS NOT NULL AND cd_simpro_w::text <> '') then 
					tb_nr_seq_material_w(x) := r_C01_w.nr_seq_material;
					tb_cd_tiss_w(x) := cd_simpro_w;
					 
					if (tb_nr_seq_material_w.count >= pls_util_pck.qt_registro_transacao_w) then 
						forall i in tb_nr_seq_material_w.first .. tb_nr_seq_material_w.last 
							update	pls_material 
							set	cd_simpro = tb_cd_tiss_w(i), 
								dt_atualizacao = clock_timestamp(), 
								nm_usuario = nm_usuario_p 
							where	nr_sequencia = tb_nr_seq_material_w(i);
						commit;
						 
						tb_nr_seq_material_w.delete;
						tb_cd_tiss_w.delete;
						x := 0;
					else 
						x := x + 1;
					end if;
				end if;
			end if;
		end if;
	end loop;
	 
	if (tb_nr_seq_material_w.count > 0) then 
		 
		if (ie_opcao_p = 'B') then 
			forall i in tb_nr_seq_material_w.first .. tb_nr_seq_material_w.last 
				update	pls_material 
				set	cd_tiss_brasindice = tb_cd_tiss_w(i), 
					dt_atualizacao = clock_timestamp(), 
					nm_usuario = nm_usuario_p 
				where	nr_sequencia = tb_nr_seq_material_w(i);
			commit;
		elsif (ie_opcao_p = 'S') then 
			forall i in tb_nr_seq_material_w.first .. tb_nr_seq_material_w.last 
				update	pls_material 
				set	cd_simpro = tb_cd_tiss_w(i), 
					dt_atualizacao = clock_timestamp(), 
					nm_usuario = nm_usuario_p 
				where	nr_sequencia = tb_nr_seq_material_w(i);
			commit;
		end if;
	end if;	
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atual_mat_bras_simpro_tuss ( nr_seq_material_p pls_material.nr_sequencia%type, nr_seq_tuss_mat_item_p tuss_material_item.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, ie_opcao_p text, ie_acao_p text) FROM PUBLIC;

