-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tws_pre_schedule_status_update ( NR_SEQ_PRE_SCHEDULE_P WSUITE_PRE_SCHEDULE.NR_SEQUENCIA%type, IE_STATUS_P WSUITE_PRE_SCHEDULE.IE_STATUS%type, NM_USUARIO_P WSUITE_PRE_SCHEDULE.NM_USUARIO%type, DS_JUSTIFICATIVA_P WSUITE_PRE_SCHEDULE.DS_JUSTIFICATIVA%type ) AS $body$
DECLARE




  OLD_NR_SEQ_PRE_SCHEDULE_W WSUITE_PRE_SCHEDULE.NR_SEQUENCIA%type;

  OLD_IE_STATUS_W WSUITE_PRE_SCHEDULE.IE_STATUS%type;

  OLD_NM_USUARIO_W WSUITE_PRE_SCHEDULE.NM_USUARIO%type;

  OLD_DS_JUSTIFICATIVA_W WSUITE_PRE_SCHEDULE.DS_JUSTIFICATIVA%type;

  NUM_OF_REQ_IN_PROC_FOR_USER bigint;




BEGIN



/*----------------------------------

Procedure to update the status of appointmnet request from web suite.

Used in scheduling function.

-------------------------------------
IE_STATUS_P input values

  R - Requested

  P - Processing

  C - Completed

  X - Cancelled

Refer domain 8778 for all values.

*/
  if (coalesce(IE_STATUS_P::text, '') = '') then

    CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(869281); -- Please specify the Status/Stage to update.
  end if;



	if ( IE_STATUS_P = 'R' or IE_STATUS_P = 'C' or IE_STATUS_P = 'X') then



    if (coalesce(NM_USUARIO_P::text, '') = '' or coalesce(DS_JUSTIFICATIVA_P::text, '') = '') then

      CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(869277); -- Please specify the executing user and reasons.
    else

      -- Select the request which is being executed the specified user.
      select NR_SEQUENCIA,

          IE_STATUS,

          NM_USUARIO,

          DS_JUSTIFICATIVA

      into STRICT OLD_NR_SEQ_PRE_SCHEDULE_W,

          OLD_IE_STATUS_W,

          OLD_NM_USUARIO_W,

          OLD_DS_JUSTIFICATIVA_W

      from WSUITE_PRE_SCHEDULE

      WHERE NM_USUARIO = NM_USUARIO_P

      and IE_STATUS = 'P';



      if OLD_IE_STATUS_W <> 'P' then

        CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(869285); -- Request should be in processing stage, before moving to other stages.
      end if;



      if NM_USUARIO_P <> OLD_NM_USUARIO_W then

        CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(869285); -- Request should be in processing stage, before moving to other stages.
      end if;



    end if;



	end if;



  if ( IE_STATUS_P = 'P') then



    if (coalesce(NR_SEQ_PRE_SCHEDULE_P::text, '') = '' or coalesce(NM_USUARIO_P::text, '') = '') then

      CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(869287); -- Please specify the Sequence of request record and executing user.
    else

      -- Select the request based on NR_SEQUENCIA
      select IE_STATUS,

          NM_USUARIO,

          DS_JUSTIFICATIVA

      into STRICT OLD_IE_STATUS_W,

          OLD_NM_USUARIO_W,

          OLD_DS_JUSTIFICATIVA_W

      from WSUITE_PRE_SCHEDULE

      WHERE NR_SEQUENCIA = NR_SEQ_PRE_SCHEDULE_P;



      OLD_NR_SEQ_PRE_SCHEDULE_W := NR_SEQ_PRE_SCHEDULE_P;



      select count(NR_SEQUENCIA)

      into STRICT NUM_OF_REQ_IN_PROC_FOR_USER

      from WSUITE_PRE_SCHEDULE

      WHERE NM_USUARIO = NM_USUARIO_P

      and IE_STATUS = 'P';



      if NUM_OF_REQ_IN_PROC_FOR_USER > 0 then

        CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(869289); -- You are not allowed to process two requests at a time.
      end if;



    end if;



	end if;



  -- Update the Justification not to loose the
  if (DS_JUSTIFICATIVA_P IS NOT NULL AND DS_JUSTIFICATIVA_P::text <> '' AND OLD_DS_JUSTIFICATIVA_W IS NOT NULL AND OLD_DS_JUSTIFICATIVA_W::text <> '') then

    OLD_DS_JUSTIFICATIVA_W := OLD_DS_JUSTIFICATIVA_W || '; ' || chr(10) || to_char(clock_timestamp(), 'DD MON YYYY') || ': ' || DS_JUSTIFICATIVA_P;



  elsif ((DS_JUSTIFICATIVA_P IS NOT NULL AND DS_JUSTIFICATIVA_P::text <> '') and coalesce(OLD_DS_JUSTIFICATIVA_W::text, '') = '') then

    OLD_DS_JUSTIFICATIVA_W := to_char(clock_timestamp(), 'DD MON YYYY') || ': ' || DS_JUSTIFICATIVA_P;



  end if;



  -- Update the recquest record.
  UPDATE WSUITE_PRE_SCHEDULE

  SET IE_STATUS = IE_STATUS_P,

      DS_JUSTIFICATIVA = OLD_DS_JUSTIFICATIVA_W,

      NM_USUARIO = NM_USUARIO_P

  WHERE NR_SEQUENCIA = OLD_NR_SEQ_PRE_SCHEDULE_W;





END; /* GOLDENGATE_DDL_REPLICATION */
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tws_pre_schedule_status_update ( NR_SEQ_PRE_SCHEDULE_P WSUITE_PRE_SCHEDULE.NR_SEQUENCIA%type, IE_STATUS_P WSUITE_PRE_SCHEDULE.IE_STATUS%type, NM_USUARIO_P WSUITE_PRE_SCHEDULE.NM_USUARIO%type, DS_JUSTIFICATIVA_P WSUITE_PRE_SCHEDULE.DS_JUSTIFICATIVA%type ) FROM PUBLIC;

