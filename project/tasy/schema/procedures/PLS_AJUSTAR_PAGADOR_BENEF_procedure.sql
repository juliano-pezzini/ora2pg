-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_ajustar_pagador_benef () AS $body$
DECLARE


nr_seq_segurado_w		bigint;
nr_seq_mensalidade_seg_w	bigint;
nr_seq_pagador_w		bigint;

nr_seq_segurado_ww		bigint;
nr_seq_contrato_ww		bigint;
nr_seq_pagador_ww		bigint;
qt_pagador_w			bigint;

nr_seq_segurado_www		bigint;
nr_seq_pessoa_proposta_www	bigint;
nr_seq_pagador_www		bigint;
nr_seq_contrato_www		bigint;
cd_pagador_w			varchar(10);
cd_cgc_pagador_w		varchar(14);
nr_seq_pagador_prop_w		bigint;

cd_pessoa_fisica_w		varchar(10);
nr_seq_segurado_wwww		bigint;
nr_seq_contrato_wwww		bigint;
nr_seq_pagador_wwww		bigint;

C01 CURSOR FOR
	SELECT	a.nr_sequencia
	from	pls_segurado a
	where	coalesce(a.nr_seq_pagador::text, '') = ''
	and	a.ie_tipo_segurado = 'B'
	and	exists (SELECT	1
			from	pls_mensalidade_segurado x
			where	a.nr_sequencia	= x.nr_seq_segurado);

C02 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.nr_seq_contrato
	from	pls_segurado a
	where	coalesce(a.nr_seq_pagador::text, '') = ''
	and	a.ie_tipo_segurado = 'B'
	and	not exists (	SELECT	1
				from	pls_mensalidade_segurado x
				where	a.nr_sequencia	= x.nr_seq_segurado);

C03 CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_pessoa_proposta,
		nr_seq_contrato
	from	pls_segurado
	where	ie_tipo_segurado	= 'P'
	and	coalesce(nr_seq_pagador::text, '') = ''
	and	(nr_seq_pessoa_proposta IS NOT NULL AND nr_seq_pessoa_proposta::text <> '')
	
UNION ALL

	SELECT	nr_sequencia,
		nr_seq_pessoa_proposta,
		nr_seq_contrato
	from	pls_segurado
	where	ie_tipo_segurado	= 'B'
	and	coalesce(nr_seq_pagador::text, '') = ''
	and	(nr_seq_pessoa_proposta IS NOT NULL AND nr_seq_pessoa_proposta::text <> '');

C04 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.cd_pessoa_fisica,
		a.nr_seq_contrato
	from	pls_segurado a
	where	coalesce(a.nr_seq_pagador::text, '') = ''
	and	a.ie_tipo_segurado = 'B'
	
UNION ALL

	SELECT	a.nr_sequencia,
		b.cd_pessoa_fisica,
		a.nr_seq_contrato
	from	pls_segurado a,
		pls_segurado b
	where	a.nr_seq_titular	= b.nr_sequencia
	and	coalesce(a.nr_seq_pagador::text, '') = ''
	and	a.ie_tipo_segurado = 'B';


BEGIN

open C01;
loop
fetch C01 into
	nr_seq_segurado_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	select	max(nr_sequencia)
	into STRICT	nr_seq_mensalidade_seg_w
	from	pls_mensalidade_segurado
	where	nr_seq_segurado	= nr_seq_segurado_w;

	if (coalesce(nr_seq_mensalidade_seg_w,0) <> 0) then
		select	max(a.nr_seq_pagador)
		into STRICT	nr_seq_pagador_w
		from	pls_mensalidade a,
			pls_mensalidade_segurado b
		where	a.nr_sequencia	= b.nr_seq_mensalidade
		and	b.nr_sequencia	= nr_seq_mensalidade_seg_w;

		if (coalesce(nr_seq_pagador_w,0) <> 0) then
			update	pls_segurado
			set	nr_seq_pagador	= nr_seq_pagador_w
			where	nr_sequencia	= nr_seq_segurado_w;
		end if;
	end if;
	end;
end loop;
close C01;

open C02;
loop
fetch C02 into
	nr_seq_segurado_ww,
	nr_seq_contrato_ww;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	select	count(*)
	into STRICT	qt_pagador_w
	from	pls_contrato_pagador
	where	nr_seq_contrato	= nr_seq_contrato_ww
	and	coalesce(dt_rescisao::text, '') = '';

	if (coalesce(qt_pagador_w,0) = 1) then
		select	nr_sequencia
		into STRICT	nr_seq_pagador_ww
		from	pls_contrato_pagador
		where	nr_seq_contrato	= nr_seq_contrato_ww
		and	coalesce(dt_rescisao::text, '') = '';

		update	pls_segurado
		set	nr_seq_pagador	= nr_seq_pagador_ww
		where	nr_sequencia	= nr_seq_segurado_ww;
	end if;
	end;
end loop;
close C02;

open C03;
loop
fetch C03 into
	nr_seq_segurado_www,
	nr_seq_pessoa_proposta_www,
	nr_seq_contrato_www;
EXIT WHEN NOT FOUND; /* apply on C03 */
	begin
	select	max(nr_seq_pagador)
	into STRICT	nr_seq_pagador_prop_w
	from	pls_proposta_beneficiario
	where	nr_sequencia = nr_seq_pessoa_proposta_www;

	if (coalesce(nr_seq_pagador_prop_w,0) <> 0) then
		select	cd_pagador,
			cd_cgc_pagador
		into STRICT	cd_pagador_w,
			cd_cgc_pagador_w
		from	pls_proposta_pagador
		where	nr_sequencia	= nr_seq_pagador_prop_w;

		select	max(a.nr_sequencia)
		into STRICT	nr_seq_pagador_www
		from	pls_contrato_pagador a,
			pls_contrato b
		where (a.cd_cgc	= cd_cgc_pagador_w
		or	a.cd_pessoa_fisica	= cd_pagador_w)
		and (b.nr_sequencia	= nr_seq_contrato_www
		or	b.nr_contrato_principal	= nr_seq_contrato_www);

		if (coalesce(nr_seq_pagador_www,0) <> 0) then
			update	pls_segurado
			set	nr_seq_pagador	= nr_seq_pagador_www
			where	nr_sequencia	= nr_seq_segurado_www;
		end if;
	end if;

	end;
end loop;
close C03;

open C04;
loop
fetch C04 into
	nr_seq_segurado_wwww,
	cd_pessoa_fisica_w,
	nr_seq_contrato_wwww;
EXIT WHEN NOT FOUND; /* apply on C04 */
	begin
	select	max(nr_sequencia)
	into STRICT	nr_seq_pagador_wwww
	from	pls_contrato_pagador
	where	nr_seq_contrato	= nr_seq_contrato_wwww
	and	cd_pessoa_fisica	= cd_pessoa_fisica_w;

	if (coalesce(nr_seq_pagador_wwww,0) <> 0) then
		update	pls_segurado
		set	nr_seq_pagador	= nr_seq_pagador_wwww
		where	nr_sequencia	= nr_seq_segurado_wwww;
	end if;
	end;
end loop;
close C04;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ajustar_pagador_benef () FROM PUBLIC;

