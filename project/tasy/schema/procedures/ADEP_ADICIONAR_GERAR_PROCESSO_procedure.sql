-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE adep_adicionar_gerar_processo ( nr_atendimento_p bigint, dt_horario_p timestamp, nm_usuario_p text, ie_somente_gedipa_p text, cd_funcao_origem_p bigint, ie_gedipa_p text, ie_separar_agora_p text) AS $body$
DECLARE

				
ie_adicionar_processo_w	varchar(1);
nr_seq_adicionar_w		bigint;
nr_seq_processo_w		bigint;
nr_seq_processo_nut_w	bigint;
nr_seq_horario_w		bigint;
nr_prescricao_w			bigint;
nr_seq_material_w		integer;
nr_agrupamento_w		double precision;
nr_seq_horario_ww		bigint;
ie_agrupador_w			smallint;
nr_seq_horario_www		bigint;
nr_seq_horario_wwww		bigint;
cd_setor_atend_w		integer;
cd_local_estoque_w		smallint;
qt_frac_w				bigint;
ie_tipo_item_w			varchar(15);
cd_setor_atendimento_w		integer;
ie_setor_processo_gedipa_w	varchar(1);
nr_seq_processo_agora_w		bigint;
ie_existe_adicionar_w		varchar(1);
nr_seq_area_prep_w		prescr_mat_hor.nr_seq_area_prep%type;
ie_grava_log_rastr_w varchar(1);

c00 CURSOR FOR
SELECT	cd_setor_prescr,
		cd_local_estoque,
		nr_seq_area_prep
from	adep_pend_v
where	dt_horario		= dt_horario_p
and		nr_atendimento	= nr_atendimento_p
and		ie_tipo_item	in ('M','MAP')
and		coalesce(nr_seq_processo::text, '') = ''
group by
		cd_setor_prescr,
		cd_local_estoque,
		nr_seq_area_prep
order by 
		cd_local_estoque,
		cd_setor_prescr;

c01 CURSOR FOR
SELECT	z.ie_tipo_item,
		z.nr_seq_horario,
		z.nr_prescricao,
		z.nr_seq_item,
		z.nr_agrupamento		
from	adep_pend_v z
where	z.dt_horario			= dt_horario_p
and		z.nr_atendimento		= nr_atendimento_p
and		z.ie_tipo_item		in ('M','MAP')
and		coalesce(z.nr_seq_processo::text, '') = ''
and		coalesce(z.cd_local_estoque,0)	= coalesce(cd_local_estoque_w,0)
and		coalesce(z.cd_setor_prescr,0) 	= coalesce(cd_setor_atendimento_w,0)
and z.nr_seq_horario not in (SELECT q.nr_sequencia
                           from prescr_material w,
                                prescr_procedimento x,
                                proc_interno y,
                                prescr_mat_hor q
                          where w.nr_prescricao = x.nr_prescricao
                          and w.nr_sequencia_proc = x.nr_sequencia
                          and x.nr_seq_proc_interno = y.nr_sequencia
                          and coalesce(y.ie_ivc, 'N') = 'S'
                          and w.nr_prescricao = z.nr_prescricao
                          and w.nr_sequencia = z.nr_seq_item
                          and (x.nr_seq_proc_interno IS NOT NULL AND x.nr_seq_proc_interno::text <> '')
                          and q.nr_sequencia = z.nr_seq_horario
                          and q.nr_prescricao = x.nr_prescricao
                          and q.nr_seq_material = w.nr_sequencia)
order by
	z.nr_seq_horario;
	
c02 CURSOR FOR
SELECT	nr_sequencia,
		ie_agrupador
from	prescr_mat_hor
where	nr_prescricao	= nr_prescricao_w
and		nr_seq_superior	= nr_seq_material_w
and		dt_horario		= dt_horario_p
and		ie_agrupador	in (3,7,9)
and		coalesce(nr_seq_processo::text, '') = ''
and		coalesce(dt_suspensao::text, '') = ''
and		Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S'
order by
	nr_sequencia;	
	
c03 CURSOR FOR
SELECT	nr_sequencia
from	prescr_mat_hor
where	nr_prescricao	= nr_prescricao_w
and		nr_seq_material > nr_seq_material_w
and		nr_agrupamento	= nr_agrupamento_w
and		dt_horario		= dt_horario_p
and		ie_agrupador	= 1
and		coalesce(nr_seq_processo::text, '') = ''
and		ie_tipo_item_w	= 'M'
and		coalesce(dt_suspensao::text, '') = ''
and		Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S'
order by
	nr_sequencia;	
	
c04 CURSOR FOR
SELECT	a.nr_sequencia
from	prescr_material b,
		prescr_mat_hor a
where	b.nr_sequencia		= a.nr_seq_material
and		b.nr_prescricao		= a.nr_prescricao
and		a.nr_prescricao		= nr_prescricao_w
and		b.nr_seq_kit		= nr_seq_material_w
and		a.dt_horario		= dt_horario_p
and		coalesce(a.nr_seq_processo::text, '') = ''
and		coalesce(a.dt_suspensao::text, '') = ''
and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
order by
	a.nr_sequencia;	
				

BEGIN

ie_grava_log_rastr_w := obter_rastreabilidade_adep(nr_atendimento_p, 'GP');

if (ie_grava_log_rastr_w = 'S') then
    CALL adep_gerar_log_rastr('{'||chr(10)||
        '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
        '"cd_funcao_origem_p" : "'||cd_funcao_origem_p||'",'||chr(10)||
        '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
        '"ie_gedipa_p" : "'||ie_gedipa_p||'",'||chr(10)||
        '"ie_separar_agora_p" : "'||ie_separar_agora_p||'",'||chr(10)||
        '"ie_somente_gedipa_p" : "'||ie_somente_gedipa_p||'",'||chr(10)||
        '"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
        '"nr_atendimento_p" : "'||nr_atendimento_p||'"}', wheb_usuario_pck.get_ie_commit);
end if;

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (dt_horario_p IS NOT NULL AND dt_horario_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin
	open c00;
	loop
	fetch c00 into	cd_setor_atendimento_w,
			cd_local_estoque_w,
			nr_seq_area_prep_w;
	EXIT WHEN NOT FOUND; /* apply on c00 */
		begin
		--if	(cd_local_estoque_w is not null) then

		--	begin
			ie_existe_adicionar_w	:= obter_se_adicionar_processo(nr_atendimento_p, dt_horario_p, cd_local_estoque_w);
            if (ie_grava_log_rastr_w = 'S') then
                CALL adep_gerar_log_rastr('{'||chr(10)||
                    '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                    '"ie_existe_adicionar_w" : "'||ie_existe_adicionar_w||'"}', wheb_usuario_pck.get_ie_commit);
            end if;
			if (ie_existe_adicionar_w = 'S') then
				begin
                if (ie_grava_log_rastr_w = 'S') then
                    CALL adep_gerar_log_rastr('{'||chr(10)||
                        '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                        '"cd_local_estoque_w" : "'||cd_local_estoque_w||'",'||chr(10)||
                        '"cd_setor_atendimento_w" : "'||cd_setor_atendimento_w||'",'||chr(10)||
                        '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                        '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
                        '"nr_seq_adicionar_w" : "'||nr_seq_adicionar_w||'"}', wheb_usuario_pck.get_ie_commit);
                end if;
				ie_setor_processo_gedipa_w	:= obter_se_setor_processo_gedipa(cd_setor_atendimento_w);
				nr_seq_adicionar_w		:= obter_processo_adicionar(nr_atendimento_p, dt_horario_p, cd_local_estoque_w);
				nr_seq_processo_w		:= nr_seq_adicionar_w;
                if (ie_grava_log_rastr_w = 'S') then
                    CALL adep_gerar_log_rastr('{'||chr(10)||
                        '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                        '"ie_setor_processo_gedipa_w" : "'||ie_setor_processo_gedipa_w||'",'||chr(10)||
                        '"nr_seq_adicionar_w" : "'||nr_seq_adicionar_w||'",'||chr(10)||
                        '"nr_seq_processo_w" : "'||nr_seq_processo_w||'"}', wheb_usuario_pck.get_ie_commit);
                end if;
				if	((nr_seq_adicionar_w > 0) and (coalesce(nr_seq_area_prep_w,0) > 0)) then
					begin
                    if (ie_grava_log_rastr_w = 'S') then
                        CALL adep_gerar_log_rastr('{'||chr(10)||
                            '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                            '"cd_local_estoque_w" : "'||cd_local_estoque_w||'",'||chr(10)||
                            '"cd_setor_atendimento_w" : "'||cd_setor_atendimento_w||'",'||chr(10)||
                            '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                            '"nr_atendimento_p" : "'||nr_atendimento_p||'"}', wheb_usuario_pck.get_ie_commit);
                    end if;
					open c01;
					loop
					fetch c01 into	ie_tipo_item_w,
							nr_seq_horario_w,
							nr_prescricao_w,
							nr_seq_material_w,
							nr_agrupamento_w;
					EXIT WHEN NOT FOUND; /* apply on c01 */
						begin
						update	prescr_mat_hor
						set		nr_seq_processo			= nr_seq_processo_w,
								ie_tipo_item_processo	= 'M'
						where	nr_sequencia			= nr_seq_horario_w;
						
                        if (ie_grava_log_rastr_w = 'S') then
                            CALL adep_gerar_log_rastr('{'||chr(10)||
                                '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                                '"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                                '"ie_tipo_item_w" : "'||ie_tipo_item_w||'",'||chr(10)||
                                '"nr_agrupamento_w" : "'||nr_agrupamento_w||'",'||chr(10)||
                                '"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
                                '"nr_seq_material_w" : "'||nr_seq_material_w||'"}', wheb_usuario_pck.get_ie_commit);
                        end if;

						open c02;
						loop
						fetch c02 into	nr_seq_horario_ww,
										ie_agrupador_w;
						EXIT WHEN NOT FOUND; /* apply on c02 */
							begin
							update	prescr_mat_hor
							set		nr_seq_processo			= nr_seq_processo_w,
									ie_tipo_item_processo	= CASE WHEN ie_agrupador_w=3 THEN 'D' WHEN ie_agrupador_w=7 THEN 'RD'  ELSE 'RC' END
							where	nr_sequencia			= nr_seq_horario_ww;
							end;
						end loop;
						close c02;

						open c03;
						loop
						fetch c03 into	nr_seq_horario_www;
						EXIT WHEN NOT FOUND; /* apply on c03 */
							begin					
							update	prescr_mat_hor
							set		nr_seq_processo			= nr_seq_processo_w,
									nr_seq_superior			= nr_seq_material_w,
									ie_tipo_item_processo	= 'C'
							where	nr_sequencia			= nr_seq_horario_www;
							end;
						end loop;
						close c03;
						
						open c04;
						loop
						fetch c04 into	nr_seq_horario_wwww;
						EXIT WHEN NOT FOUND; /* apply on c04 */
							begin					
							update	prescr_mat_hor
							set		nr_seq_processo			= nr_seq_processo_w,
									nr_seq_superior			= nr_seq_material_w,
									ie_tipo_item_processo	= 'K'
							where	nr_sequencia			= nr_seq_horario_wwww;
							end;
						end loop;
						close c04;
						
						end;
					end loop;
					close c01;
					
					if (ie_setor_processo_gedipa_w = 'S') then
						begin
						CALL gerar_fracionamento_processo(nr_seq_processo_w, nm_usuario_p);
						end;
					end if;
					end;
				else
					begin
					SELECT * FROM gerar_processo_adep(nr_atendimento_p, dt_horario_p, nm_usuario_p, nr_seq_processo_w, ie_somente_gedipa_p, cd_funcao_origem_p, 'AAGP', ie_setor_processo_gedipa_w, ie_separar_agora_p, nr_seq_processo_agora_w, cd_local_estoque_w, cd_setor_atendimento_w, 'N', nr_seq_processo_nut_w) INTO STRICT nr_seq_processo_w, nr_seq_processo_agora_w, nr_seq_processo_nut_w;
					if (ie_setor_processo_gedipa_w = 'S') then
						begin
						CALL gerar_fracionamento_processo(nr_seq_processo_w, nm_usuario_p);
						CALL gerar_fracionamento_processo(nr_seq_processo_agora_w, nm_usuario_p);
						if (coalesce(nr_seq_processo_nut_w,0) > 0) then
							CALL gerar_fracionamento_processo(nr_seq_processo_nut_w, nm_usuario_p);
						end if;
						end;
					end if;	
					end;
				end if;	
				end;
			end if;
		--	end;			

		--end if;
		end;
	end loop;
	close c00;
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE adep_adicionar_gerar_processo ( nr_atendimento_p bigint, dt_horario_p timestamp, nm_usuario_p text, ie_somente_gedipa_p text, cd_funcao_origem_p bigint, ie_gedipa_p text, ie_separar_agora_p text) FROM PUBLIC;

