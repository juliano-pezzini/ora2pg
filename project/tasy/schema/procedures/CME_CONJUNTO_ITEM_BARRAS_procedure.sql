-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cme_conjunto_item_barras ( cd_barras_p text, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_conjunto_p INOUT bigint) AS $body$
DECLARE

  nr_seq_conjunto_w    cm_conjunto_cont.nr_seq_conjunto%TYPE;
  qt_registro_w        integer;
  qt_existe_w       bigint;
  cd_estabelecimento_w cm_conjunto_cont.cd_estabelecimento%TYPE;
  nr_sequencia_w    cm_item.nr_sequencia%type;


BEGIN 
    /* SELECT Max(nr_sequencia) 
    INTO   nr_seq_conjunto_p 
    FROM   cm_item 
    WHERE  nr_sequencia = cd_barras_p 
            OR cd_codigo = cd_barras_p; */
    select  max(nr_sequencia)
    into STRICT    nr_sequencia_w
    from    cm_item
    where   cd_codigo = cd_barras_p
    and     IE_SITUACAO = 'A';
    if (coalesce(nr_sequencia_w::text, '') = '') then
        begin
        select  count(*)
        into STRICT    qt_existe_w
        from    cm_item
        where   nr_sequencia = cd_barras_p
        and     IE_SITUACAO = 'A';
        exception
            when others then
            qt_existe_w := 0;
        end;
        if (qt_existe_w > 0) then
            nr_seq_conjunto_p := cd_barras_p;
        else
            nr_seq_conjunto_p := null;
        end if;
    else
        nr_seq_conjunto_p := nr_sequencia_w;
    end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cme_conjunto_item_barras ( cd_barras_p text, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_conjunto_p INOUT bigint) FROM PUBLIC;

