-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_consistir_brindes_doacao (nr_seq_doacao_p bigint, cd_pessoa_fisica_p text, ie_opcao_p text, dt_registro_p timestamp, ds_observacao_p text, ds_brinde_p INOUT text, cd_perfil_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

					 
ds_material_w		varchar(255);
ds_lista_brindes_w	varchar(4000);
nr_seq_brinde_w		bigint;
cd_pessoa_fisica_w	varchar(255);
cd_pessoa_entrega_w	varchar(255);
qt_entrega_brinde_w	bigint;
nr_seq_tipo_w		bigint;

/* 
I - Inserir 
C - Consisitir 
*/
 
					 

BEGIN 
 
if (nr_seq_doacao_p IS NOT NULL AND nr_seq_doacao_p::text <> '') then 
 
	select	count(*) 
	into STRICT	qt_entrega_brinde_w 
	from	san_entrega_brinde a 
	where	a.nr_seq_doacao = nr_seq_doacao_p;
	 
	if (qt_entrega_brinde_w = 0) then 
	 
		select	max(a.nr_seq_tipo) 
		into STRICT	nr_seq_tipo_w 
		from	san_doacao a 
		where	a.nr_sequencia = nr_seq_doacao_p;
	 
		select	max(a.nr_Sequencia) 
		into STRICT	nr_seq_brinde_w			 
		from	san_regra_brinde a 
		where	a.qt_doacao = san_obter_qtd_doacao_brind(cd_pessoa_fisica_p,coalesce(nr_seq_tipo_doacao, nr_seq_tipo_w)) 
		and	nr_seq_tipo_w = coalesce(nr_seq_tipo_doacao, nr_seq_tipo_w) 
		and	a.ie_situacao = 'A';
	 
		select	max(b.ds_material) 
		into STRICT	ds_material_w 
		from	san_regra_brinde a, 
			material b 
		where	a.cd_material = b.cd_material 
		and	a.nr_sequencia = nr_seq_brinde_w;
		 
		if (ie_opcao_p = 'C') then	 
						 
			ds_brinde_p	:= ds_material_w;
			 
		elsif (ie_opcao_p = 'I') then				 
				 
			cd_pessoa_fisica_w	:= cd_pessoa_fisica_p;
			cd_pessoa_entrega_w	:= obter_pessoa_fisica_usuario(nm_usuario_p,'C');
			 
			insert into san_entrega_brinde(	nr_sequencia, 
							nr_seq_doacao, 
							nr_seq_brinde, 
							cd_pessoa_fisica, 
							cd_pessoa_entrega, 
							dt_entrega, 
							ds_observacao, 
							dt_atualizacao, 
							dt_atualizacao_nrec, 
							nm_usuario, 
							nm_usuario_nrec, 
							cd_estabelecimento) 
					values (nextval('san_entrega_brinde_seq'), 
							nr_seq_doacao_p, 
							nr_seq_brinde_w, 
							cd_pessoa_fisica_w, 
							cd_pessoa_entrega_w, 
							dt_registro_p, 
							ds_observacao_p, 
							clock_timestamp(), 
							clock_timestamp(), 
							nm_usuario_p, 
							nm_usuario_p, 
							cd_estabelecimento_p 
							);
		end if;
	end if;
 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_consistir_brindes_doacao (nr_seq_doacao_p bigint, cd_pessoa_fisica_p text, ie_opcao_p text, dt_registro_p timestamp, ds_observacao_p text, ds_brinde_p INOUT text, cd_perfil_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

