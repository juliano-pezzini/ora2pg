-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_estabelecimento_oc ( cd_estab_p bigint, nr_ordem_compra_p bigint, cd_local_estoque_p bigint) AS $body$
DECLARE

 
cd_comprador_w		comprador.cd_pessoa_fisica%type;			
qt_registros_w		bigint;
			

BEGIN 
 
select	cd_comprador 
into STRICT	cd_comprador_w 
from	ordem_compra 
where	nr_ordem_compra = nr_ordem_compra_p;
 
if (cd_comprador_w IS NOT NULL AND cd_comprador_w::text <> '') then 
 
	select	count(*) 
	into STRICT	qt_registros_w 
	from	comprador 
	where	ie_situacao = 'A' 
	and	cd_pessoa_fisica = cd_comprador_w 
	and	cd_estabelecimento = cd_estab_p;
	 
	 
	if (qt_registros_w = 0) then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(350389);
		/*O comprador dessa ordem de compra não tem registro no estabelecimento que está sendo alterado. 
		Diante disso, o sistema não permite a alteração. 
		Favor cadastra-lo no estabelecimento, e em seguida alterar o estabelecimento da ordem de compra.*/
 
	end if;
end if;
 
if (nr_ordem_compra_p IS NOT NULL AND nr_ordem_compra_p::text <> '') and (cd_estab_p IS NOT NULL AND cd_estab_p::text <> '') and (cd_local_estoque_p IS NOT NULL AND cd_local_estoque_p::text <> '') then 
	begin 
	update	ordem_compra 
	set	cd_estabelecimento		= cd_estab_p 
	where	nr_ordem_compra 		= nr_ordem_compra_p;	
	 
	update	ordem_compra_item 
	set	cd_local_estoque 		= cd_local_estoque_p 
	where	nr_ordem_compra 		= nr_ordem_compra_p; 		
	end;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_estabelecimento_oc ( cd_estab_p bigint, nr_ordem_compra_p bigint, cd_local_estoque_p bigint) FROM PUBLIC;

