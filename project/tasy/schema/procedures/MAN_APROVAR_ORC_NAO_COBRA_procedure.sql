-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_aprovar_orc_nao_cobra ( nr_seq_orcamento_p bigint, nr_seq_ordem_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ds_motivo_nao_cobranca_w	man_motivo_ncobr_orc.ds_motivo%type;


BEGIN 
if (nr_seq_orcamento_p > 0) and (nr_seq_ordem_p > 0) then 
	begin 
	update	man_ordem_servico_orc 
	set	dt_aprovacao_nao_cobra	= clock_timestamp() 
	where	nr_sequencia		= nr_seq_orcamento_p;
	 
	select	a.ds_motivo 
	into STRICT	ds_motivo_nao_cobranca_w 
	from	man_motivo_ncobr_orc a, 
		man_ordem_servico_orc b 
	where	a.nr_sequencia 	= b.nr_seq_motivo_nao_cobra 
	and	b.nr_sequencia 	= nr_seq_orcamento_p;
	 
	insert into man_ordem_serv_tecnico( 
			nr_sequencia, 
			nr_seq_ordem_serv, 
			dt_atualizacao, 
			nm_usuario, 
			ds_relat_tecnico, 
			dt_historico, 
			ie_origem, 
			nr_seq_tipo, 
			dt_liberacao, 
			nm_usuario_lib, 
			ie_relevante_teste) 
		values (	nextval('man_ordem_serv_tecnico_seq'), 
			nr_seq_ordem_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			Wheb_mensagem_pck.get_texto(461044) || chr(10) || chr(13) || 
			Wheb_mensagem_pck.get_texto(461045) || ': ' || substr(obter_pf_usuario(nm_usuario_p,'N'),1,40) || chr(10) || chr(13) || 
			Wheb_mensagem_pck.get_texto(461046) || ' ' || ds_motivo_nao_cobranca_w, 
			clock_timestamp(), 
			'I', 
			7, 
			clock_timestamp(), 
			nm_usuario_p, 
			'N');
	end;
 
	commit;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_aprovar_orc_nao_cobra ( nr_seq_orcamento_p bigint, nr_seq_ordem_p bigint, nm_usuario_p text) FROM PUBLIC;

