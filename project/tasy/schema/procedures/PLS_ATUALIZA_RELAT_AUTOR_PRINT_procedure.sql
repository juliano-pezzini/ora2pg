-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualiza_relat_autor_print (cd_funcao_p funcao.cd_funcao%type, nr_seq_guia_p pls_guia_plano.nr_sequencia%type) AS $body$
DECLARE

 
ie_grupo_w	smallint;
cd_versao_w	pls_versao_tiss.cd_versao_tiss%type;
qt_guia_mat_w	integer := 0;
qt_guia_proc_w	integer := 0;
qt_total_w	integer := 0;
					
C01 CURSOR FOR 
	SELECT d.cd_relatorio, 
        d.cd_classif_relat 
    from  pls_regra_relat_grupo  a, 
        pls_grupo_relatorio   b, 
        pls_regra_relatorio   c, 
        relatorio        d  
    where  a.nr_seq_grupo_relat  = b.nr_sequencia 
    and   a.nr_sequencia     = c.nr_seq_grupo 
    and   d.nr_sequencia     = c.nr_seq_relatorio 
    and   b.cd_grupo       = ie_grupo_w;
					
BEGIN 
 
	/* 
		Primeiro seto todos os relatórios da função para não imprimir. 
	*/
				 
	update 	relatorio_funcao 
	set	ie_imprimir = 'N' 
	where 	cd_funcao = cd_funcao_p;
	 
	select	CASE WHEN ie_tipo_guia=1 THEN  5 WHEN ie_tipo_guia=2 THEN  6 WHEN ie_tipo_guia=3 THEN  17 WHEN ie_tipo_guia=8 THEN  7 END  
	into STRICT	ie_grupo_w 
	from	pls_guia_plano 
	where	nr_sequencia = nr_seq_guia_p;
		 
	 
	for r_c01_w in C01 loop 
	 
		update 	relatorio_funcao 
		set	ie_imprimir = 'S' 
		where	cd_funcao = cd_funcao_p 
		and	nr_seq_relatorio in (SELECT r.nr_sequencia   
					from	relatorio r, 
						relatorio_funcao rf 
					where	r.nr_sequencia = rf.nr_seq_relatorio 
					and 	rf.cd_funcao = cd_funcao_p 
					and	r.cd_relatorio = r_c01_w.cd_relatorio 
					);
 
		CALL Atualizar_Classif_Relat_Wheb(r_c01_w.cd_relatorio, cd_funcao_p);
	 
	end loop;
		 
	select 	pls_obter_versao_tiss 
	into STRICT	cd_versao_w 
	;
 
	select	count(1) qt_result 
	into STRICT	qt_guia_mat_w 
	from	pls_guia_plano_mat 
	where	nr_seq_guia = nr_seq_guia_p 
	and	ie_tipo_anexo='OP' 
	and	coalesce(nr_seq_motivo_exc::text, '') = '';
 
	select	count(1) qt_result 
	into STRICT	qt_guia_proc_w 
	from	pls_guia_plano_proc 
	where	nr_seq_guia = nr_seq_guia_p 
	and	ie_tipo_anexo='RA' 
	and	coalesce(nr_seq_motivo_exc::text, '') = '';
 
	select count(1) 
	into STRICT	qt_total_w 
	from ( 
		SELECT	1 
		from	pls_guia_plano_mat 
		where	nr_seq_guia= nr_seq_guia_p 
		and	ie_tipo_anexo='QU' 
		and	coalesce(nr_seq_motivo_exc::text, '') = '' 
		
union all
 
		SELECT	1 
		from	pls_guia_plano_proc 
		where	nr_seq_guia= nr_seq_guia_p 
		and	ie_tipo_anexo='QU' 
		and	coalesce(nr_seq_motivo_exc::text, '') = '') alias3;
 
 
	if (cd_versao_w >= '3.03.00') then 
		 
		if (qt_guia_mat_w > 0) then 
				 
			update 	relatorio_funcao 
			set	ie_imprimir = 'S' 
			where	cd_funcao = cd_funcao_p 
			and	nr_seq_relatorio in (SELECT r.nr_sequencia   
						from	relatorio r, 
							relatorio_funcao rf 
						where	r.nr_sequencia = rf.nr_seq_relatorio 
						and 	rf.cd_funcao = cd_funcao_p 
						and	r.cd_relatorio = '3257' 
						);
			 
			CALL Atualizar_Classif_Relat_Wheb(3257, cd_funcao_p);
		 
		end if;
		 
		if (qt_guia_proc_w > 0) then 
			 
			update 	relatorio_funcao 
			set	ie_imprimir = 'S' 
			where	cd_funcao = cd_funcao_p 
			and	nr_seq_relatorio in (SELECT r.nr_sequencia   
						from	relatorio r, 
							relatorio_funcao rf 
						where	r.nr_sequencia = rf.nr_seq_relatorio 
						and 	rf.cd_funcao = cd_funcao_p 
						and	r.cd_relatorio = '3261' 
						);
			 
			CALL Atualizar_Classif_Relat_Wheb(3261, cd_funcao_p);
				 
		end if;
		 
		if (qt_total_w > 0) then 
			 
			update 	relatorio_funcao 
			set	ie_imprimir = 'S' 
			where	cd_funcao = cd_funcao_p 
			and	nr_seq_relatorio in (SELECT r.nr_sequencia   
						from	relatorio r, 
							relatorio_funcao rf 
						where	r.nr_sequencia = rf.nr_seq_relatorio 
						and 	rf.cd_funcao = cd_funcao_p 
						and	r.cd_relatorio = '3259' 
						);
			 
			CALL Atualizar_Classif_Relat_Wheb(3259, cd_funcao_p);
			 
		end if;
 
	else 
		if (qt_guia_mat_w > 0) then 
			 
			update 	relatorio_funcao 
			set	ie_imprimir = 'S' 
			where	cd_funcao = cd_funcao_p 
			and	nr_seq_relatorio in (SELECT r.nr_sequencia   
						from	relatorio r, 
							relatorio_funcao rf 
						where	r.nr_sequencia = rf.nr_seq_relatorio 
						and 	rf.cd_funcao = cd_funcao_p 
						and	r.cd_relatorio = '2129' 
						);
			 
			CALL Atualizar_Classif_Relat_Wheb(2129, cd_funcao_p);
		end if;
		 
		if (qt_guia_proc_w > 0) then 
			 
			update 	relatorio_funcao 
			set	ie_imprimir = 'S' 
			where	cd_funcao = cd_funcao_p 
			and	nr_seq_relatorio in (SELECT r.nr_sequencia   
						from	relatorio r, 
							relatorio_funcao rf 
						where	r.nr_sequencia = rf.nr_seq_relatorio 
						and 	rf.cd_funcao = cd_funcao_p 
						and	r.cd_relatorio = '2158' 
						);
			 
			CALL Atualizar_Classif_Relat_Wheb(2158, cd_funcao_p);
			 
		end if;
		 
		if (qt_total_w > 0) then 
			 
			update 	relatorio_funcao 
			set	ie_imprimir = 'S' 
			where	cd_funcao = cd_funcao_p 
			and	nr_seq_relatorio in (SELECT r.nr_sequencia   
						from	relatorio r, 
							relatorio_funcao rf 
						where	r.nr_sequencia = rf.nr_seq_relatorio 
						and 	rf.cd_funcao = cd_funcao_p 
						and	r.cd_relatorio = '2141' 
						);
			 
			CALL Atualizar_Classif_Relat_Wheb(2141, cd_funcao_p);
		end if;
 
	end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualiza_relat_autor_print (cd_funcao_p funcao.cd_funcao%type, nr_seq_guia_p pls_guia_plano.nr_sequencia%type) FROM PUBLIC;

