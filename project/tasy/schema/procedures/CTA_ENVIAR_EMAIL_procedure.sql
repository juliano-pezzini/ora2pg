-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cta_enviar_email ( nr_atendimento_p bigint, nr_interno_conta_p bigint, nr_seq_pendencia_p bigint, nr_seq_tipo_p bigint, nr_seq_estagio_p bigint, ie_evento_p text, ds_texto_p text, nm_usuario_p text) AS $body$
DECLARE

				 
ds_texto_email_w		varchar(4000);
ds_assunto_email_w		varchar(255):= '';
ds_email_destino_w		cta_regra_envio_email.ds_email_destino%type := null;
nm_usuario_envio_w		cta_regra_envio_email.nm_usuario_envio%type := null;
nr_sequencia_w			cta_regra_envio_email.nr_sequencia%type;

C01 CURSOR FOR 
	SELECT	ds_email_destino, 
		nm_usuario_envio 
	from	cta_regra_envio_email 
	where	ie_evento = ie_evento_p 
	and	((nr_seq_tipo = nr_seq_tipo_p) or (coalesce(nr_seq_tipo::text, '') = '')) 
	and	((nr_seq_estagio = nr_seq_estagio_p) or (coalesce(nr_seq_estagio::text, '') = '')) 
	and	ie_situacao = 'A';


BEGIN 
 
ds_texto_email_w := Wheb_mensagem_pck.get_texto(413311) /* Paciente */
 || ': ' || obter_pessoa_atendimento(nr_atendimento_p,'N') || chr(10) || chr(13);
ds_texto_email_w := ds_texto_email_w || Wheb_mensagem_pck.get_texto(270613) /* Atendimento */
 || ': ' || nr_atendimento_p || chr(10) || chr(13);
ds_texto_email_w := ds_texto_email_w || Wheb_mensagem_pck.get_texto(270612) /* Conta */
 || ': ' || nr_interno_conta_p || chr(10) || chr(13);
ds_texto_email_w := ds_texto_email_w || Wheb_mensagem_pck.get_texto(455722) /* Seq pendência */
 || ': ' || nr_seq_pendencia_p || chr(10) || chr(13);
ds_texto_email_w := ds_texto_email_w || Wheb_mensagem_pck.get_texto(418867) /* Tipo */
 || ': ' || obter_desc_tipo_pendencia(nr_seq_tipo_p) || chr(10) || chr(13);
ds_texto_email_w := ds_texto_email_w || Wheb_mensagem_pck.get_texto(413313) /* Estágio */
 || ': ' || obter_desc_cta_estagio_pend(nr_seq_estagio_p) || chr(10) || chr(13);
 
if (coalesce(ds_texto_p,'X') <> 'X') then 
	ds_texto_email_w := substr(ds_texto_email_w || Wheb_mensagem_pck.get_texto(455728) /* Complemento*/
 || ': ' || ds_texto_p 	|| chr(10) || chr(13),1,4000);
end if;
 
if (ie_evento_p = 'E') then 
	ds_assunto_email_w := Wheb_mensagem_pck.get_texto(455729) /* Alteração de Estágio da Pendência */
;
elsif (ie_evento_p = 'F') then 
	ds_assunto_email_w := Wheb_mensagem_pck.get_texto(455730) /* Fechamento da Pendência */
;
elsif (ie_evento_p = 'A') then 
	ds_assunto_email_w := Wheb_mensagem_pck.get_texto(455731) /* Abertura de Pendência */
;
end if;
 
open C01;
loop 
fetch 	C01 into	 
	ds_email_destino_w, 
	nm_usuario_envio_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	if (ds_email_destino_w IS NOT NULL AND ds_email_destino_w::text <> '') then 
	CALL enviar_email(	ds_assunto_email_w, 
			ds_texto_email_w, 
			null, 
			ds_email_destino_w, 
			coalesce(nm_usuario_envio_w,nm_usuario_p), 
			null);	
	end if;
	end;
end loop;
close C01;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cta_enviar_email ( nr_atendimento_p bigint, nr_interno_conta_p bigint, nr_seq_pendencia_p bigint, nr_seq_tipo_p bigint, nr_seq_estagio_p bigint, ie_evento_p text, ds_texto_p text, nm_usuario_p text) FROM PUBLIC;

