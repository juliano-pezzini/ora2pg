-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_apropriar_saldo_lancamento (nr_titulo_p titulo_receber.nr_titulo%type, nm_usuario_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


nr_seq_segurado_mens_w		bigint;
vl_saldo_titulo_w		double precision;
nr_seq_classif_itens_w		pls_contrato_pagador.nr_seq_classif_itens%type;		
nr_seq_regra_apro_desc_folha_w	bigint;
cd_moeda_padrao_w		parametro_contas_receber.cd_moeda_padrao%type;
cd_tipo_recebimento_w		pls_regra_aprop_desc_folha.cd_tipo_recebimento%type;
nr_seq_trans_fin_baixa_w	pls_regra_aprop_desc_folha.nr_seq_trans_fin_baixa%type;
nr_titulo_contab_w		bigint;
nr_seq_baixa_w			titulo_receber_liq.nr_sequencia%type;
nr_seq_segurado_mensalidade_w	pls_segurado_mensalidade.nr_sequencia%type;
nr_seq_pagador_w		titulo_receber.nr_seq_pagador%type;
nr_seq_tipo_lanc_w		bigint;
dt_referencia_w			pls_mensalidade.dt_referencia%type;


BEGIN

if (nr_titulo_p IS NOT NULL AND nr_titulo_p::text <> '') then
	select	a.nr_seq_segurado_mens,
		a.vl_saldo_titulo,
		(select	max(x.nr_seq_classif_itens)
		from	pls_contrato_pagador x
		where	x.nr_sequencia = a.nr_seq_pagador),
		a.nr_seq_pagador
	into STRICT	nr_seq_segurado_mens_w,
		vl_saldo_titulo_w,
		nr_seq_classif_itens_w,
		nr_seq_pagador_w
	from	titulo_receber a
	where	a.nr_titulo = nr_titulo_p;

	if	((coalesce(nr_seq_segurado_mens_w::text, '') = '') and (vl_saldo_titulo_w > 0) and (nr_seq_pagador_w IS NOT NULL AND nr_seq_pagador_w::text <> '')) then
		select	max(nr_sequencia)
		into STRICT	nr_seq_regra_apro_desc_folha_w
		from	pls_regra_aprop_desc_folha
		where	cd_estabelecimento = cd_estabelecimento_p
		and	((coalesce(nr_seq_classif_itens::text, '') = '') or (nr_seq_classif_itens = nr_seq_classif_itens_w))
		and	vl_saldo_titulo_w <= vl_apropriacao_max;
		
		if (nr_seq_regra_apro_desc_folha_w IS NOT NULL AND nr_seq_regra_apro_desc_folha_w::text <> '') then
			begin
			select	cd_moeda_padrao
			into STRICT	cd_moeda_padrao_w
			from	parametro_contas_receber
			where	cd_estabelecimento = cd_estabelecimento_p;
			exception
			when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(176708);
			end;
		
			select	cd_tipo_recebimento,
				nr_seq_trans_fin_baixa,
				nr_seq_tipo_lanc
			into STRICT	cd_tipo_recebimento_w,
				nr_seq_trans_fin_baixa_w,
				nr_seq_tipo_lanc_w
			from	pls_regra_aprop_desc_folha
			where	nr_sequencia = nr_seq_regra_apro_desc_folha_w;
		
			select	coalesce(max(nr_sequencia),0) + 1
			into STRICT	nr_seq_baixa_w
			from	titulo_receber_liq
			where	nr_titulo	= nr_titulo_p;
		
			insert into titulo_receber_liq(nr_sequencia, cd_moeda, cd_tipo_recebimento,
				dt_atualizacao, dt_recebimento, ie_acao,
				ie_lib_caixa, nm_usuario, nr_titulo,
				vl_descontos, vl_glosa, vl_juros,
				vl_multa, vl_recebido, vl_rec_maior,
				ds_observacao, nr_seq_trans_fin, dt_real_recebimento,
				vl_adequado, vl_despesa_bancaria, vl_perdas, 
				vl_outros_acrescimos, vl_cambial_ativo, vl_cambial_passivo)
			values (nr_seq_baixa_w, cd_moeda_padrao_w, cd_tipo_recebimento_w,
				clock_timestamp(), clock_timestamp(), 'I',
				'S', nm_usuario_p, nr_titulo_p,
				0, 0, 0,
				0, vl_saldo_titulo_w, 0,
				'Baixa gerada pelo processo OPS - Desconto em folha', nr_seq_trans_fin_baixa_w, clock_timestamp(), 
				0, 0, 0, 
				0, 0, 0);
				
				CALL gerar_titulo_rec_liq_cc(cd_estabelecimento_p, null, nm_usuario_p, nr_titulo_p, nr_seq_baixa_w);
				nr_titulo_contab_w := pls_gerar_tit_rec_liq_mens(nr_titulo_p, nr_seq_baixa_w, nm_usuario_p, nr_titulo_contab_w);
				CALL pls_gerar_amortizacao_regra(nr_titulo_p, nr_seq_baixa_w, nm_usuario_p, 'N');
				CALL atualizar_saldo_tit_rec(nr_titulo_p, nm_usuario_p);

			select	coalesce(add_months(max(a.dt_referencia),1), clock_timestamp())
			into STRICT	dt_referencia_w
			from	pls_mensalidade a
			where	a.nr_seq_pagador = nr_seq_pagador_w
			and	coalesce(a.ie_cancelamento::text, '') = ''
			and	exists (SELECT	1
					from	titulo_receber x
					where	a.nr_sequencia = x.nr_seq_mensalidade);
			
			select	nextval('pls_segurado_mensalidade_seq')
			into STRICT	nr_seq_segurado_mensalidade_w
			;
				
			insert into pls_segurado_mensalidade(nr_sequencia, dt_atualizacao, dt_atualizacao_nrec,
				nm_usuario, nm_usuario_nrec, nr_seq_pagador,
				nr_seq_motivo, ie_situacao, dt_referencia,
				tx_desconto, ie_tipo_item, ie_tipo_lanc,
				vl_item, cd_estabelecimento)
			values (nr_seq_segurado_mensalidade_w, clock_timestamp(), clock_timestamp(),
				nm_usuario_p, nm_usuario_p, nr_seq_pagador_w,
				nr_seq_tipo_lanc_w, 'A', dt_referencia_w,
				0, '20', 'P',
				vl_saldo_titulo_w, cd_estabelecimento_p);
				
			update	titulo_receber
			set	nr_seq_segurado_mens = nr_seq_segurado_mensalidade_w,
				dt_atualizacao = clock_timestamp(),
				nm_usuario = nm_usuario_p
			where	nr_titulo = nr_titulo_p;
		else
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1124050, 'VL_SALDO='||to_char(vl_saldo_titulo_w,'999999999.99')||';NR_TITULO='||nr_titulo_p);
		end if;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_apropriar_saldo_lancamento (nr_titulo_p titulo_receber.nr_titulo%type, nm_usuario_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

