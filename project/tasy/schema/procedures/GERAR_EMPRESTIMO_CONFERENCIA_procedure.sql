-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_emprestimo_conferencia ( nr_ordem_compra_p bigint, nr_nota_fiscal_p text, dt_entrega_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text, nr_emprestimo_p INOUT bigint) AS $body$
DECLARE

 
cd_local_estoque_w	bigint;
cd_fornecedor_w		varchar(14);
nr_item_oci_w		bigint;
						

BEGIN 
 
select	max(b.cd_local_estoque), 
	max(a.cd_cgc_fornecedor) 
into STRICT	cd_local_estoque_w, 
	cd_fornecedor_w 
from	ordem_compra a, 
	ordem_compra_item b, 
	ordem_compra_item_entrega c 
where	a.nr_ordem_compra = b.nr_ordem_compra 
and	b.nr_ordem_compra = c.nr_ordem_compra 
and 	b.nr_item_oci = c.nr_item_oci 
and	a.nr_ordem_compra = nr_ordem_compra_p;
 
select	nextval('emprestimo_seq') 
into STRICT	nr_emprestimo_p
;
 
insert into emprestimo( 
	cd_estabelecimento, 
	cd_local_estoque, 
	cd_pessoa_juridica, 
	ds_observacao, 
	dt_atualizacao, 
	dt_emprestimo, 
	ie_situacao, 
	ie_tipo, 
	nm_usuario, 
	nm_usuario_resp, 
	nr_documento, 
	nr_emprestimo) 
values (	cd_estabelecimento_p, 
	cd_local_estoque_w, 
	cd_fornecedor_w, 
	WHEB_MENSAGEM_PCK.get_texto(301264,'NR_ORDEM_COMPRA_P='||NR_ORDEM_COMPRA_P), 
	clock_timestamp(), 
	clock_timestamp(), 
	'A', 
	'E', 
	nm_usuario_p, 
	nm_usuario_p, 
	nr_nota_fiscal_p, 
	nr_emprestimo_p);
 
nr_item_oci_w := 0;
		 
insert into emprestimo_material( 
	cd_material, 
	dt_atualizacao, 
	nm_usuario, 
	nr_emprestimo, 
	nr_ordem_compra, 
	nr_sequencia, 
	qt_emprestimo, 
	qt_material, 
	ds_lote_fornec, 
	dt_validade_material, 
	ie_indeterminado) 
SELECT	b.cd_material, 
	clock_timestamp(), 
	nm_usuario_p, 
	nr_emprestimo_p, 
	b.nr_ordem_compra, 
	nr_item_oci_w + row_number() OVER () AS rownum, 
	a.qt_conferencia, 
	a.qt_material, 
	c.ds_lote_fornec, 
	c.dt_validade, 
	c.ie_indeterminada 
FROM ordem_compra_item b, ordem_compra_item_conf a
LEFT OUTER JOIN ordem_item_conf_lote c ON (a.nr_sequencia = c.nr_seq_conferencia)
WHERE a.nr_ordem_compra = b.nr_ordem_compra and a.nr_item_oci = b.nr_item_oci and a.nr_ordem_compra = nr_ordem_compra_p  and a.nr_nota_fiscal = nr_nota_fiscal_p and coalesce(a.dt_estorno::text, '') = '' and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') and coalesce(a.qt_conferencia,0) > 0 and a.ie_gera_disponivel = 'S';
 
update	ordem_compra_item_conf 
set	nr_emprestimo = nr_emprestimo_p 
where	nr_ordem_compra = nr_ordem_compra_p 
and	nr_nota_fiscal = nr_nota_fiscal_p 
and	coalesce(dt_estorno::text, '') = '' 
and 	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
and	coalesce(qt_conferencia,0) > 0 
and	ie_gera_disponivel = 'S';
		 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_emprestimo_conferencia ( nr_ordem_compra_p bigint, nr_nota_fiscal_p text, dt_entrega_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text, nr_emprestimo_p INOUT bigint) FROM PUBLIC;

