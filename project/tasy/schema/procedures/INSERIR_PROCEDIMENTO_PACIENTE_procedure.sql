-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_procedimento_paciente ( cd_procedimento_p procedimento_paciente.cd_procedimento%type, qt_procedimento_p procedimento_paciente.qt_procedimento%type, nr_seq_exame_p procedimento_paciente.nr_seq_exame%type, nr_seq_proc_interno_p procedimento_paciente.nr_seq_proc_interno%type, ie_origem_proced_p procedimento_paciente.ie_origem_proced%type, cd_setor_atendimento_p procedimento_paciente.cd_setor_atendimento%type, nr_atendimento_p procedimento_paciente.nr_atendimento%type, cd_estabelecimento_p procedimento_paciente.cd_estabelecimento_custo%type, nm_usuario_p procedimento_paciente.nm_usuario%type, ie_tipo_baixa_p text, ie_valor_informado_p procedimento_paciente.ie_valor_informado%type, cd_medico_p procedimento_paciente.cd_medico%type, nr_seq_atepacu_p procedimento_paciente.nr_seq_atepacu%type, dt_procedimento_p procedimento_paciente.dt_procedimento%type, cd_convenio_p procedimento_paciente.cd_convenio%type, cd_categoria_p procedimento_paciente.cd_categoria%type, nr_sequencia_p INOUT procedimento_paciente.nr_sequencia%type, cd_medico_req_p procedimento_paciente.cd_medico_req%type default null, cd_medico_executor_p procedimento_paciente.cd_medico_executor%type default null, vl_procedimento_p procedimento_paciente.vl_procedimento%type default null, vl_custo_operacional_p procedimento_paciente.vl_custo_operacional%type default null, vl_medico_p procedimento_paciente.vl_medico%type default null, vl_materiais_p procedimento_paciente.vl_materiais%type default null, vl_anestesista_p procedimento_paciente.vl_anestesista%type default null, vl_auxiliares_p procedimento_paciente.vl_auxiliares%type default null, ds_observacao_p procedimento_paciente.ds_observacao%type default null) AS $body$
DECLARE


/** Juliane Menin - Faz a insercao dos procedimentos - (Execucao da Prescricao )*/

nr_sequencia_w			procedimento_paciente.nr_sequencia%type;
dt_entrada_unidade_w	procedimento_paciente.dt_entrada_unidade%type;
nr_seq_interno_w		bigint;
cd_convenio_w			procedimento_paciente.cd_convenio%type := cd_convenio_p;
cd_categoria_w			procedimento_paciente.cd_categoria%type := cd_categoria_p;
nr_doc_convenio_w		procedimento_paciente.nr_doc_convenio%type;
ie_tipo_guia_w			procedimento_paciente.ie_tipo_guia%type;
cd_senha_w				procedimento_paciente.cd_senha%type;
ie_emite_conta_w  		procedimento_paciente.ie_emite_conta%type := null; --no delphi 81(Conta Paciente-Antiga) parametro 18
cd_cgc_prestador_w 		procedimento_paciente.cd_cgc_prestador%type;
ie_origem_proced_w		procedimento_paciente.ie_origem_proced%type;
ie_tipo_atendimento_w  	varchar(2) := null;
ie_medico_executor_w	varchar(2);
cd_cgc_w				varchar(14);
cd_medico_executor_w	procedimento_paciente.cd_medico_executor%type := cd_medico_executor_p;

ie_funcao_medico_w		procedimento_paciente.ie_funcao_medico%type := 0;
dt_procedimento_w		procedimento_paciente.dt_procedimento%type;
cd_pessoa_fisica_w		procedimento_paciente.cd_pessoa_fisica%type;

cd_tipo_procedimento_w	smallint;
ie_classificacao_w		varchar(1);
ie_tipo_lancto_w		varchar(10);
cd_procedimento_w		bigint;
cd_profissional_w		procedimento_paciente.cd_pessoa_fisica%type;
nr_seq_cor_exec_w		procedimento_paciente.nr_seq_cor_exec%type := 96;

ie_clinica_w			atendimento_paciente.ie_clinica%type;


BEGIN

dt_procedimento_w	:= dt_procedimento_p;

nr_seq_interno_w	:= nr_seq_atepacu_p;

if ( nr_seq_atepacu_p = 0) then
	nr_seq_interno_w:= null;
end if;

select	max(a.dt_entrada_unidade)
into STRICT	dt_entrada_unidade_w
from	atend_paciente_unidade a
where	nr_seq_interno	= nr_seq_interno_w;

select	a.cd_cgc
into STRICT	cd_cgc_prestador_w
from 	estabelecimento a,
		atendimento_paciente b
where	a.cd_estabelecimento = b.cd_estabelecimento
and		b.nr_atendimento = nr_atendimento_p;

-- Obter a maxima sequencia da procedimento_paciente
select		nextval('procedimento_paciente_seq')
into STRICT		nr_sequencia_w
;

-- inserir na tabela procedimento_paciente
insert into procedimento_paciente(
			nr_sequencia,
			nr_atendimento,
			dt_entrada_unidade,
			cd_procedimento,
			dt_procedimento,
			cd_convenio,
			cd_categoria,
			nr_doc_convenio,
			ie_tipo_guia,
			cd_senha,
			ie_auditoria,
			ie_emite_conta,
			cd_cgc_prestador,
			ie_origem_proced,
			nr_seq_exame,
			nr_seq_proc_interno,
			qt_procedimento,
			cd_setor_atendimento,
			nr_seq_atepacu,
			nr_seq_cor_exec,
			ie_funcao_medico,
			ie_proc_princ_atend,
			ie_video,
			tx_medico,
			tx_Anestesia,
			tx_procedimento,
			ie_valor_informado,
			ie_guia_informada,
			cd_situacao_glosa,
			nm_usuario_original,
			dt_atualizacao,
			nm_usuario,
			cd_pessoa_fisica,
			cd_medico_executor,
			cd_medico_req,
			vl_procedimento,
			vl_custo_operacional,
			vl_medico,
			vl_materiais,
			vl_anestesista,
			vl_auxiliares,
			ds_observacao)
		values ( nr_sequencia_w,
			nr_atendimento_p,
			dt_entrada_unidade_w,
			cd_procedimento_p,
			dt_procedimento_w,
			cd_convenio_w,
			cd_categoria_w,
			nr_doc_convenio_w,
			ie_tipo_guia_w,
			cd_senha_w,
			'N',
			ie_emite_conta_w,
			cd_cgc_prestador_w,
			ie_origem_proced_p,
			nr_seq_exame_p,
			nr_seq_proc_interno_p,
			qt_procedimento_p,
			cd_setor_atendimento_p,
			nr_seq_interno_w,
			nr_seq_cor_exec_w,
			ie_funcao_medico_w,
			'N',
			'N',
			100,
			100,
			100,
			--'N',
			ie_valor_informado_p,
			'N',
			0,
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_profissional_w,
			cd_medico_executor_w,
			cd_medico_req_p,
			vl_procedimento_p,
			vl_custo_operacional_p,
			vl_medico_p,
			vl_materiais_p,
			vl_anestesista_p,
			vl_auxiliares_p,
			ds_observacao_p);

CALL atualiza_preco_procedimento(nr_sequencia_w, cd_convenio_w, nm_usuario_p);

CALL gerar_autor_regra(nr_atendimento_p, null, nr_sequencia_w, null, null, nr_seq_proc_interno_p,
					'EP',nm_usuario_p,null,null,null,null,null,null,'','','');

if (coalesce((pkg_i18n.get_user_locale), 'pt_BR') = 'es_MX') then

	select	max(ie_clinica)
	into STRICT	ie_clinica_w
	from	atendimento_paciente
	where	nr_atendimento = nr_atendimento_p;

	CALL gerar_codificacao_atendimento(nr_atendimento_p, ie_clinica_w, nm_usuario_p, null, null, null, null, 'N', null);

end if;

nr_sequencia_p	:= nr_sequencia_w;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_procedimento_paciente ( cd_procedimento_p procedimento_paciente.cd_procedimento%type, qt_procedimento_p procedimento_paciente.qt_procedimento%type, nr_seq_exame_p procedimento_paciente.nr_seq_exame%type, nr_seq_proc_interno_p procedimento_paciente.nr_seq_proc_interno%type, ie_origem_proced_p procedimento_paciente.ie_origem_proced%type, cd_setor_atendimento_p procedimento_paciente.cd_setor_atendimento%type, nr_atendimento_p procedimento_paciente.nr_atendimento%type, cd_estabelecimento_p procedimento_paciente.cd_estabelecimento_custo%type, nm_usuario_p procedimento_paciente.nm_usuario%type, ie_tipo_baixa_p text, ie_valor_informado_p procedimento_paciente.ie_valor_informado%type, cd_medico_p procedimento_paciente.cd_medico%type, nr_seq_atepacu_p procedimento_paciente.nr_seq_atepacu%type, dt_procedimento_p procedimento_paciente.dt_procedimento%type, cd_convenio_p procedimento_paciente.cd_convenio%type, cd_categoria_p procedimento_paciente.cd_categoria%type, nr_sequencia_p INOUT procedimento_paciente.nr_sequencia%type, cd_medico_req_p procedimento_paciente.cd_medico_req%type default null, cd_medico_executor_p procedimento_paciente.cd_medico_executor%type default null, vl_procedimento_p procedimento_paciente.vl_procedimento%type default null, vl_custo_operacional_p procedimento_paciente.vl_custo_operacional%type default null, vl_medico_p procedimento_paciente.vl_medico%type default null, vl_materiais_p procedimento_paciente.vl_materiais%type default null, vl_anestesista_p procedimento_paciente.vl_anestesista%type default null, vl_auxiliares_p procedimento_paciente.vl_auxiliares%type default null, ds_observacao_p procedimento_paciente.ds_observacao%type default null) FROM PUBLIC;

