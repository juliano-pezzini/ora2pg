-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_atend_infor_req ( NR_ATENDIMENTO_P bigint, NM_USUARIO_P text, CD_FUNCAO_P bigint, IE_OPCAO_P text default 'X', DS_MENSAGEM_P INOUT text DEFAULT NULL, IE_ACAO_P INOUT text  DEFAULT NULL) AS $body$
DECLARE

 
ds_todas_mensagens_inf_req_w	varchar(4000);
ie_acao_w	 w_pep_regra_informacao.ie_Acao%type;
ie_gerar_alta_atend_rn_w	parametro_atendimento.ie_gerar_alta_atend_rn%type;
			
c01 CURSOR(nr_atendimento_cw bigint) FOR 
	SELECT	ds_mensagem, 
			ie_acao 
	from	w_pep_regra_informacao 
	where	nr_atendimento	= nr_atendimento_cw 
	and		nm_usuario	= nm_usuario_p 
	order by 1;
	
--Atendimento Passado como parÃªmetro + atendimentos RN	 
c02 CURSOR FOR 
	SELECT 	nr_atendimento_p	nr_atendimento 
	 
	
union all
 
	SELECT	nr_atendimento 
	from	atendimento_paciente 
	where	nr_atendimento_mae = nr_atendimento_p 
	and		coalesce(dt_alta::text, '') = '' 
	and		ie_gerar_alta_atend_rn_w in ('S','Q','H','R','M');
	
BEGIN 
select 	max(ie_gerar_alta_atend_rn) 
into STRICT	ie_gerar_alta_atend_rn_w 
from	parametro_atendimento 
where	cd_estabelecimento = OBTER_ESTAB_ATEND(NR_ATENDIMENTO_P);
 
for c02_r in c02 
loop 
	CALL PEP_GERAR_INFORMACAO_REQ(c02_r.nr_atendimento, nm_usuario_p, IE_OPCAO_P);
	for c01_r in c01(c02_r.nr_atendimento) 
	loop 
		ds_todas_mensagens_inf_req_w := substr(ds_todas_mensagens_inf_req_w || chr(13) || chr(10) || c01_r.ds_mensagem, 1, 4000);
		if (coalesce(ie_acao_w::text, '') = '' or ie_acao_w <> 'I') then 
			ie_acao_w :=	c01_r.ie_acao;
		end if;
	end loop;
end loop;
 
DS_MENSAGEM_P := ds_todas_mensagens_inf_req_w;
IE_ACAO_P := ie_acao_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_atend_infor_req ( NR_ATENDIMENTO_P bigint, NM_USUARIO_P text, CD_FUNCAO_P bigint, IE_OPCAO_P text default 'X', DS_MENSAGEM_P INOUT text DEFAULT NULL, IE_ACAO_P INOUT text  DEFAULT NULL) FROM PUBLIC;

