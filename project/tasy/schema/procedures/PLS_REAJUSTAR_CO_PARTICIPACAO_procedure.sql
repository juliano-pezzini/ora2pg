-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_reajustar_co_participacao ( nr_seq_reajuste_p bigint, nr_seq_contrato_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_co_partip_w		bigint;
ie_tipo_atendimento_w		varchar(1);
dt_contrato_de_w		timestamp;
dt_contrato_ate_w		timestamp;
qt_eventos_minimo_w		bigint;
ie_situacao_w			varchar(1);
nr_seq_tipo_coparti_w		bigint;
tx_coparticipacao_w		double precision;
vl_maximo_w			double precision;
vl_coparticipacao_w		double precision;
tx_reajuste_coparti_w		double precision;
tx_reajuste_copartic_max_w	double precision;
vl_fixo_reajustado_w		double precision;
tx_coparticip_reajust_w		double precision;
vl_base_w			double precision;
tx_base_w			double precision;
dt_reajuste_w			timestamp;
vl_copart_max_w			double precision;
qt_ocorrencias_w		bigint;
ie_tipo_ocorrencia_w		varchar(2);
ie_tipo_data_consistencia_w	varchar(2);
ie_contrato_produto_w		varchar(1);
ie_reajuste_w			varchar(1);
nr_seq_prestador_w		pls_regra_coparticipacao.nr_seq_prestador%type;
nr_seq_tipo_prestador_w		pls_regra_coparticipacao.nr_seq_tipo_prestador%type;
vl_base_max_w			pls_regra_coparticipacao.vl_base_max%type;
vl_base_min_w			pls_regra_coparticipacao.vl_base_min%type;
ie_incidencia_psiquiatria_w	pls_regra_coparticipacao.ie_incidencia_psiquiatria%type;

C01 CURSOR FOR
	SELECT	x.nr_sequencia,
		'C'
	from	pls_regra_coparticipacao x
	where	x.nr_seq_contrato	= nr_seq_contrato_p
	and	dt_reajuste_w between coalesce(trunc(x.dt_inicio_vigencia,'dd'),dt_reajuste_w) and fim_dia(coalesce(x.dt_fim_vigencia,dt_reajuste_w))
	
union all

	SELECT	q.nr_sequencia,
		'P'
	from	pls_contrato	   y,
		pls_contrato_plano w,
		pls_plano	   z,
		pls_regra_coparticipacao q
	where	y.nr_sequencia		= nr_seq_contrato_p
	and	w.nr_seq_contrato	= y.nr_sequencia
	and	w.nr_seq_plano		= z.nr_sequencia
	and	q.nr_seq_plano		= z.nr_sequencia
	and	dt_reajuste_w between coalesce(trunc(q.dt_inicio_vigencia,'dd'),dt_reajuste_w) and fim_dia(coalesce(q.dt_fim_vigencia,dt_reajuste_w))
	and	not exists (	select	p.nr_sequencia
				from	pls_regra_coparticipacao p
				where	p.nr_seq_contrato	= nr_seq_contrato_p
				and	dt_reajuste_w between coalesce(trunc(p.dt_inicio_vigencia,'dd'),dt_reajuste_w) and fim_dia(coalesce(p.dt_fim_vigencia,dt_reajuste_w)));


BEGIN

select	coalesce(tx_reajuste_copartic,0),
	coalesce(tx_reajuste_copartic_max,0),
	dt_reajuste
into STRICT	tx_reajuste_coparti_w,
	tx_reajuste_copartic_max_w,
	dt_reajuste_w
from	pls_reajuste
where	nr_sequencia	= nr_seq_reajuste_p;

if (tx_reajuste_copartic_max_w <> 0) then
	open C01;
	loop
	fetch C01 into
		nr_seq_co_partip_w,
		ie_contrato_produto_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		
		vl_base_w		:= 0;
		vl_fixo_reajustado_w	:= 0;
		tx_base_w		:= 0;
		tx_coparticip_reajust_w	:= 0;
		
		select	ie_tipo_atendimento,
			dt_contrato_de,
			dt_contrato_ate,
			qt_eventos_minimo,
			ie_situacao,
			nr_seq_tipo_coparticipacao,
			tx_coparticipacao,
			vl_maximo,
			vl_coparticipacao,
			qt_ocorrencias,
			ie_tipo_ocorrencia,
			ie_tipo_data_consistencia,
			coalesce(ie_reajuste,'S'),
			nr_seq_prestador,
			nr_seq_tipo_prestador,
			vl_base_max,
			vl_base_min,
			ie_incidencia_psiquiatria
		into STRICT	ie_tipo_atendimento_w,
			dt_contrato_de_w,
			dt_contrato_ate_w,
			qt_eventos_minimo_w,
			ie_situacao_w,
			nr_seq_tipo_coparti_w,
			tx_coparticipacao_w,
			vl_maximo_w,
			vl_coparticipacao_w,
			qt_ocorrencias_w,
			ie_tipo_ocorrencia_w,
			ie_tipo_data_consistencia_w,
			ie_reajuste_w,
			nr_seq_prestador_w,
			nr_seq_tipo_prestador_w,
			vl_base_max_w,
			vl_base_min_w,
			ie_incidencia_psiquiatria_w			
		from	pls_regra_coparticipacao
		where	nr_sequencia	= nr_seq_co_partip_w;
		
		vl_base_w		:= dividir_sem_round((vl_coparticipacao_w * tx_reajuste_coparti_w)::numeric,100);
		vl_fixo_reajustado_w	:= vl_coparticipacao_w + vl_base_w;
		
		/*if	(tx_reajuste_coparti_w <> 0) then
			tx_base_w		:= dividir_sem_round(tx_coparticipacao_w * tx_reajuste_coparti_w,100);
			tx_coparticip_reajust_w	:= tx_coparticipacao_w + tx_base_w;
		else*/
			select	coalesce(tx_coparticipacao,0)
			into STRICT	tx_coparticip_reajust_w
			from	pls_regra_coparticipacao
			where	nr_sequencia	= nr_seq_co_partip_w;
		/*end if;*/

		
		vl_copart_max_w		:= vl_maximo_w + dividir_sem_round((vl_maximo_w * tx_reajuste_copartic_max_w)::numeric,100);
		
		if (ie_contrato_produto_w	= 'C') then
			update	pls_regra_coparticipacao
			set	dt_fim_vigencia	= clock_timestamp()
			where	nr_sequencia	= nr_seq_co_partip_w;
		end if;
		
		insert into	pls_regra_coparticipacao(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
				dt_inicio_vigencia,ie_tipo_atendimento,dt_contrato_de,dt_contrato_ate,
				qt_eventos_minimo,ie_situacao,nr_seq_tipo_coparticipacao,tx_coparticipacao,
				vl_maximo,vl_coparticipacao,nr_seq_contrato, nr_seq_reajuste,
				qt_ocorrencias,ie_tipo_ocorrencia,ie_tipo_data_consistencia, nr_seq_regra_origem,
				ie_reajuste,nr_seq_prestador,nr_seq_tipo_prestador,
				vl_base_min, vl_base_max, ie_incidencia_psiquiatria)
		values (	nextval('pls_regra_coparticipacao_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
				clock_timestamp(),ie_tipo_atendimento_w,dt_contrato_de_w,dt_contrato_ate_w,
				qt_eventos_minimo_w,'A',nr_seq_tipo_coparti_w,tx_coparticip_reajust_w,
				vl_copart_max_w,vl_fixo_reajustado_w,nr_seq_contrato_p, nr_seq_reajuste_p,
				qt_ocorrencias_w,ie_tipo_ocorrencia_w,ie_tipo_data_consistencia_w, nr_seq_co_partip_w,
				ie_reajuste_w,nr_seq_prestador_w,nr_seq_tipo_prestador_w,
				vl_base_min_w, vl_base_max_w, ie_incidencia_psiquiatria_w);
		
		end;
	end loop;
	close C01;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_reajustar_co_participacao ( nr_seq_reajuste_p bigint, nr_seq_contrato_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

