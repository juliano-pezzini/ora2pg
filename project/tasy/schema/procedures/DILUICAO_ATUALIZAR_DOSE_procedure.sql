-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE diluicao_atualizar_dose ( cd_material_p bigint, cd_unidade_medida_dose_p INOUT text, nm_usuario_p text, ie_via_aplicacao_p text, nr_prescricao_p bigint, cd_unidade_medida_p INOUT text, qt_conversao_p INOUT bigint, ie_tipo_material_p INOUT text, qt_dose_prescricao_p INOUT bigint, cd_intervalo_p text ) AS $body$
DECLARE

 
 
cd_unidade_medida_w			varchar(30);
qt_conversao_w				double precision;
qt_dose_prescricao_w		double precision;
cd_unidade_medida_prescr_w	varchar(5);
ie_tipo_material_w			varchar(3);
cd_unidade_medida_dose_w	varchar(5);
cd_pessoa_fisica_w			varchar(10);
qt_peso_w					real;	
cd_setor_atendimento_w		integer;
cd_unidade_padrao_w			varchar(5);
nr_atendimento_w			bigint;


BEGIN 
select	max(nr_atendimento) 
into STRICT		nr_atendimento_w 
from		prescr_medica 
where	nr_prescricao = nr_prescricao_p;
 
select	max(cd_unidade_medida) 
into STRICT		cd_unidade_medida_w 
from 	unidade_medida_dose_v 
where 	cd_material = cd_material_p;
 
select	max(qt_conversao) 
into STRICT		qt_conversao_w 
from 	material_conversao_unidade 
where 	cd_material 		= cd_material_p 
and 		cd_unidade_medida 	= cd_unidade_medida_dose_p;
 
select	max(qt_dose_prescricao), 
		max(cd_unidade_medida_prescr), 
		max(ie_tipo_material) 
into STRICT		qt_dose_prescricao_w, 
		cd_unidade_medida_prescr_w, 
		ie_tipo_material_w 
from 	material 
where 	cd_material = cd_material_p;
 
if	((coalesce(qt_dose_prescricao_w::text, '') = '') and (coalesce(cd_unidade_medida_prescr_w::text, '') = '')) then 
	cd_unidade_medida_dose_w := cd_unidade_medida_prescr_w;
else 
	begin 
	select	cd_pessoa_fisica, 
			qt_peso, 
			cd_setor_atendimento 
	into STRICT		cd_pessoa_fisica_w, 
			qt_peso_w, 
			cd_setor_atendimento_w 
	from 	prescr_medica 
	where	nr_prescricao	= nr_prescricao_p;
 
	qt_dose_prescricao_w :=	Obter_Padrao_Param_Prescr(nr_atendimento_w,cd_material_p, ie_via_aplicacao_p,cd_setor_atendimento_w,cd_pessoa_fisica_w,Obter_Idade_PF(cd_pessoa_fisica_w, clock_timestamp(), 'A'),qt_peso_w,'N','D', cd_intervalo_p);
	cd_unidade_padrao_w :=	Obter_Padrao_Param_Prescr(nr_atendimento_w,cd_material_p, ie_via_aplicacao_p,cd_setor_atendimento_w,cd_pessoa_fisica_w,Obter_Idade_PF(cd_pessoa_fisica_w, clock_timestamp(), 'A'),qt_peso_w,'N','U', cd_intervalo_p);
	end;
end if;
 
 
cd_unidade_medida_p	:= cd_unidade_medida_w;
qt_conversao_p		:= qt_conversao_w;
ie_tipo_material_p	:= ie_tipo_material_w;
qt_dose_prescricao_p	:= qt_dose_prescricao_w;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE diluicao_atualizar_dose ( cd_material_p bigint, cd_unidade_medida_dose_p INOUT text, nm_usuario_p text, ie_via_aplicacao_p text, nr_prescricao_p bigint, cd_unidade_medida_p INOUT text, qt_conversao_p INOUT bigint, ie_tipo_material_p INOUT text, qt_dose_prescricao_p INOUT bigint, cd_intervalo_p text ) FROM PUBLIC;

