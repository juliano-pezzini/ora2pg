-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE define_data_parcela (DT_BASE_P timestamp, QT_DIAS_PARCELA_P bigint, CD_ESTABELECIMENTO_P bigint, DT_PARCELA_P INOUT timestamp, IE_ACAO_NAO_UTIL_P text) AS $body$
DECLARE


DT_PARCELA_W     	         timestamp			:= clock_timestamp();
QT_DIAS_PARCELA_W	         NUMERIC(6)		:= 0;
DIA_SEMANA_W		   NUMERIC(1)		:= 0;
DT_FERIADO_W     	         timestamp			:= clock_timestamp();


BEGIN
/*
begin
select	vl_parametro_padrao
into		ie_feriado_w
from		funcao_parametro
where		cd_funcao = 54
and		nr_sequencia = 1;
exception
		when others then
		ie_feriado_w := 'M';
end;

Francisco - OS 29031 - O select n√£o retornava nada pois a funcao acima nao existe.
*/
dt_parcela_w := dt_base_p + qt_dias_parcela_p;
dt_parcela_w := to_date(to_char(dt_parcela_w,'dd/mm/yyyy'),'dd/mm/yyyy');

if	coalesce(IE_ACAO_NAO_UTIL_P,'M') <> 'M' then
	begin
    	FOR i IN 1..3 LOOP
      	begin
            dia_semana_w := pkg_date_utils.get_WeekDay(dt_parcela_w);
            if   dia_semana_w = 1 then
                 if   coalesce(IE_ACAO_NAO_UTIL_P,'M') = 'A' then
                      dt_parcela_w := dt_parcela_w - 2;
                 else
                      dt_parcela_w := dt_parcela_w + 1;
                 end if;
            end if;
            if   dia_semana_w = 7 then
                 if   coalesce(IE_ACAO_NAO_UTIL_P,'M') = 'A' then
                      dt_parcela_w := dt_parcela_w - 1;
                 else
                      dt_parcela_w := dt_parcela_w + 2;
                 end if;
            end if;

            select	dt_feriado
            into STRICT 		dt_feriado_w
            from 		feriado
            where		cd_estabelecimento = cd_estabelecimento_p
            and		dt_feriado         = dt_parcela_w;

            if   coalesce(IE_ACAO_NAO_UTIL_P,'M') = 'A' then
                 dt_parcela_w := dt_parcela_w - 1;
            else
                 dt_parcela_w := dt_parcela_w + 1;
            end if;

            exception
                 when others then
                      exit;
            end;
      END LOOP;
      end;
end if;

if   	dt_parcela_w < dt_base_p then
     	dt_parcela_w := dt_base_p;
end if;

dt_parcela_p := dt_parcela_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE define_data_parcela (DT_BASE_P timestamp, QT_DIAS_PARCELA_P bigint, CD_ESTABELECIMENTO_P bigint, DT_PARCELA_P INOUT timestamp, IE_ACAO_NAO_UTIL_P text) FROM PUBLIC;

