-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_envio_acomp (nm_usuario_p text) AS $body$
DECLARE

 
/*campos regra*/
 
nr_seq_regra_w				bigint;
qt_dias_w					integer;
ie_tipo_alerta_w			varchar(15);
ie_status_ordem_w			smallint;
nr_seq_grupo_planej_w		bigint;
nr_seq_grupo_trab_w			bigint;
nr_seq_estagio_w			bigint;
ie_comunic_interna_w		varchar(1);
ie_email_w					varchar(1);
qt_min_repeticao_w			integer;
dt_proxima_exec_w			timestamp;
ie_dia_espec_w				varchar(15);
ie_tipo_data_w				varchar(15);
ie_solic_vip_w				varchar(15);

/*campos OS*/
 
nr_seq_ordem_w				bigint;
nm_pessoa_solic_w			varchar(60);
ds_status_os_w				varchar(10);
ds_dano_breve_w				varchar(80);
ds_dano_w					varchar(4000);
nm_usuario_grupo_trab_w		varchar(15);
nr_seq_grupo_trab_regra_w	bigint;
nr_seq_os_vinculada_w		bigint;
ds_lista_os_vinculada_w		varchar(2000);
ds_estagio_philips_w		varchar(255);
ds_lista_ordem_servico_w	varchar(4000);
usuario_grupo_trabalho_w	varchar(1);

ds_titulo_w					varchar(255);
ds_comunicacao_w			varchar(32000);
ie_usuario_w				varchar(15);
nm_usuario_w				varchar(2000);
ds_usu_infor_aux_w			varchar(2000);
ds_usu_infor_dest_w			varchar(2000);
nm_usuario_exec_w			varchar(15);
nm_usuario_solic_w			varchar(15);
nm_usu_setor_solic_w		varchar(15);
nr_seq_classif_w			bigint;
ds_format_os_w				varchar(255);
ds_format_solic_w			varchar(255);
ds_format_sts_os_w			varchar(255);
ds_format_desc_os_w			varchar(255);
dt_execucao_w				timestamp := clock_timestamp();
ds_lista_executores_w		varchar(2000);
dt_prevista_philips_w		timestamp;

/*Campos E-mail*/
 
lista_usuario_w				varchar(2000);
tam_lista_w					bigint;
ie_pos_virgula_w			smallint;
ds_email_usuario_w			varchar(255);
ds_lista_email_usuario_w	varchar(2000);
ds_comunicado_original_w	varchar(2000);
ds_email_origem_w			varchar(255);

ds_classificacao_w			varchar(255);
qt_dias_macro_w				bigint;
dt_ordem_servico_w			man_ordem_servico.dt_ordem_servico%type;
ds_estagio_w				varchar(80);
nm_usuario_exec_prev_w		man_ordem_servico_exec.nm_usuario_exec%type;
nm_usuario_inicio_exec_w	man_ordem_servico.nm_usuario_exec%type;

C01 CURSOR FOR 
	SELECT	nr_sequencia, 
		qt_dias, 
		ie_tipo_alerta, 
		ie_status_ordem, 
		nr_seq_grupo_planejamento, 
		nr_seq_grupo_trabalho, 
		nr_seq_estagio, 
		ie_comunic_interna, 
		ie_email, 
		ds_comunicacao, 
		ds_titulo, 
		ds_email_origem, 
		coalesce(ie_apenas_dia_informado,'N'), 
		coalesce(qt_min_repeticao,1440), 
		dt_proxima_exec, 
		coalesce(ie_tipo_data,'O'), 
		CASE WHEN coalesce(ie_solic_vip,'T')='T' THEN null  ELSE ie_solic_vip END  
	from	man_regra_envio_acomp 
	where	coalesce(ie_situacao,'A') = 'A' 
	and (ie_comunic_interna = 'S' or ie_email = 'S') 
	and	coalesce(dt_proxima_exec,dt_execucao_w) <= dt_execucao_w;

/* OS - Executores */
 
C02 CURSOR FOR 
	SELECT	a.nr_sequencia, 
		substr(obter_nome_pf(a.cd_pessoa_solicitante),1,60) nm_pessoa_solic, 
		substr(CASE WHEN a.ie_status_ordem=1 THEN obter_desc_expressao(296477)/*'Aberta'*/
 WHEN a.ie_status_ordem=2 THEN obter_desc_expressao(296477)/*'Processo'*/ WHEN a.ie_status_ordem=3 THEN obter_desc_expressao(713358)/*'Encerrado'*/ END ,1,10) ds_status_ordem, 
		a.ds_dano_breve, 
		a.ds_dano, 
		substr(coalesce(obter_valor_dominio(1149,a.ie_classificacao),obter_desc_expressao(622834)/*'Não informada'*/
),1,255) ds_classificacao, 
		substr(obter_desc_estagio_proc(a.nr_seq_estagio),1,80) ds_estagio, 
		a.nm_usuario_exec 
	from	usuario c, 
		man_ordem_servico_exec b, 
		man_ordem_servico a 
	where	a.nr_sequencia = b.nr_seq_ordem 
	and	c.nm_usuario = b.nm_usuario_exec 
	and	c.nm_usuario = nm_usuario_exec_w 
	and	c.ie_situacao = 'A' 
	and	ie_tipo_alerta_w = 'P' 
	and	coalesce(a.nr_grupo_planej,0) = coalesce(nr_seq_grupo_planej_w, coalesce(a.nr_grupo_planej,0)) 
	and	coalesce(a.nr_grupo_trabalho,0) = coalesce(nr_seq_grupo_trab_w, coalesce(a.nr_grupo_trabalho,0)) 
	and	coalesce(a.nr_seq_estagio,0) = coalesce(nr_seq_estagio_w, coalesce(a.nr_seq_estagio,0)) 
	and	coalesce(a.ie_solic_vip,'N') = coalesce(ie_solic_vip_w, coalesce(a.ie_solic_vip,'N')) 
	and	((ie_dia_espec_w = 'N' and 
		((ie_tipo_data_w = 'O' and obter_dias_entre_datas(a.dt_ordem_servico,clock_timestamp()) >= qt_dias_w) 
		or (ie_tipo_data_w = 'E' and man_obter_qt_dia_estagio_os(a.nr_sequencia) >= qt_dias_w))) or 
		(ie_dia_espec_w = 'S' and 
		((ie_tipo_data_w = 'O' and obter_dias_entre_datas(a.dt_ordem_servico,clock_timestamp()) = qt_dias_w) 
		or (ie_tipo_data_w = 'E' and man_obter_qt_dia_estagio_os(a.nr_sequencia) = qt_dias_w)))) 
	and (a.ie_status_ordem = coalesce(ie_status_ordem_w,a.ie_status_ordem) 
		or (a.ie_status_ordem in ('1','2') and ie_status_ordem_w = 4)) 
	group by a.nr_sequencia, 
		a.cd_pessoa_solicitante, 
		a.ie_status_ordem, 
		a.ds_dano_breve, 
		a.ds_dano, 
		a.ie_classificacao, 
		a.nr_seq_estagio, 
		a.nm_usuario_exec 
	order by 1;

/* OS - Solicitante */
 
C03 CURSOR FOR 
	SELECT	a.nr_sequencia, 
		substr(obter_nome_pf(a.cd_pessoa_solicitante),1,60) nm_pessoa_solic, 
		substr(CASE WHEN a.ie_status_ordem=1 THEN obter_desc_expressao(283054)/*'Aberta'*/
 WHEN a.ie_status_ordem=2 THEN obter_desc_expressao(296477)/*'Processo'*/ WHEN a.ie_status_ordem=3 THEN obter_desc_expressao(713358)/*'Encerrado'*/ END ,1,10) ds_status_ordem, 
		a.ds_dano_breve, 
		a.ds_dano, 
		substr(coalesce(obter_valor_dominio(1149,a.ie_classificacao),obter_desc_expressao(622834)/*'Não informada'*/
),1,255), 
		substr(obter_desc_estagio_proc(a.nr_seq_estagio),1,80) ds_estagio, 
		a.nm_usuario_exec 
	from	usuario b, 
		man_ordem_servico a 
	where	a.cd_pessoa_solicitante = b.cd_pessoa_fisica 
	and	b.nm_usuario = nm_usuario_solic_w 
	and	b.ie_situacao = 'A' 
	and	coalesce(a.nr_grupo_planej,0) = coalesce(nr_seq_grupo_planej_w, coalesce(a.nr_grupo_planej,0)) 
	and	coalesce(a.nr_grupo_trabalho,0) = coalesce(nr_seq_grupo_trab_w, coalesce(a.nr_grupo_trabalho,0)) 
	and	coalesce(a.nr_seq_estagio,0) = coalesce(nr_seq_estagio_w, coalesce(a.nr_seq_estagio,0)) 
	and	coalesce(a.ie_solic_vip,'N') = coalesce(ie_solic_vip_w, coalesce(a.ie_solic_vip,'N')) 
	and	((ie_dia_espec_w = 'N' and 
		((ie_tipo_data_w = 'O' and obter_dias_entre_datas(a.dt_ordem_servico,clock_timestamp()) >= qt_dias_w) 
		or (ie_tipo_data_w = 'E' and man_obter_qt_dia_estagio_os(a.nr_sequencia) >= qt_dias_w))) or 
		(ie_dia_espec_w = 'S' and 
		((ie_tipo_data_w = 'O' and obter_dias_entre_datas(a.dt_ordem_servico,clock_timestamp()) = qt_dias_w) 
		or (ie_tipo_data_w = 'E' and man_obter_qt_dia_estagio_os(a.nr_sequencia) = qt_dias_w)))) 
	and (a.ie_status_ordem = coalesce(ie_status_ordem_w,a.ie_status_ordem) 
		or (a.ie_status_ordem in ('1','2') and ie_status_ordem_w = 4)) 
	and (ie_tipo_alerta_w = 'P' or (ie_tipo_alerta_w = 'E' 
		and not exists (	SELECT	1 
				from	man_ordem_servico_exec x 
				where	x.nr_seq_ordem = a.nr_sequencia))) 
	order by 1;

/* OS - Responsável do setor do solicitante */
 
C04 CURSOR FOR 
	SELECT	a.nr_sequencia, 
		substr(obter_nome_pf(a.cd_pessoa_solicitante),1,60) nm_pessoa_solic, 
		substr(CASE WHEN a.ie_status_ordem=1 THEN obter_desc_expressao(283054)/*'Aberta'*/
 WHEN a.ie_status_ordem=2 THEN obter_desc_expressao(296477)/*'Processo'*/ WHEN a.ie_status_ordem=3 THEN obter_desc_expressao(713358)/*'Encerrado'*/ END ,1,10) ds_status_ordem, 
		a.ds_dano_breve, 
		a.ds_dano, 
		substr(coalesce(obter_valor_dominio(1149,a.ie_classificacao),obter_desc_expressao(622834)/*'Não informada'*/
),1,255), 
		substr(obter_desc_estagio_proc(a.nr_seq_estagio),1,80) ds_estagio, 
		a.nm_usuario_exec 
	from	usuario d, 
		setor_atendimento c, 
		usuario b, 
		man_ordem_servico a 
	where	a.cd_pessoa_solicitante = b.cd_pessoa_fisica 
	and	c.cd_setor_atendimento = b.cd_setor_atendimento 
	and	c.cd_pessoa_resp = d.cd_pessoa_fisica 
	and	d.nm_usuario = nm_usu_setor_solic_w 
	and	b.ie_situacao = 'A' 
	and	d.ie_situacao = 'A' 
	and	coalesce(a.nr_grupo_planej,0) = coalesce(nr_seq_grupo_planej_w, coalesce(a.nr_grupo_planej,0)) 
	and	coalesce(a.nr_grupo_trabalho,0) = coalesce(nr_seq_grupo_trab_w, coalesce(a.nr_grupo_trabalho,0)) 
	and	coalesce(a.nr_seq_estagio,0) = coalesce(nr_seq_estagio_w, coalesce(a.nr_seq_estagio,0)) 
	and	coalesce(a.ie_solic_vip,'N') = coalesce(ie_solic_vip_w, coalesce(a.ie_solic_vip,'N')) 
	and	((ie_dia_espec_w = 'N' and 
		((ie_tipo_data_w = 'O' and obter_dias_entre_datas(a.dt_ordem_servico,clock_timestamp()) >= qt_dias_w) 
		or (ie_tipo_data_w = 'E' and man_obter_qt_dia_estagio_os(a.nr_sequencia) >= qt_dias_w))) or 
		(ie_dia_espec_w = 'S' and 
		((ie_tipo_data_w = 'O' and obter_dias_entre_datas(a.dt_ordem_servico,clock_timestamp()) = qt_dias_w) 
		or (ie_tipo_data_w = 'E' and man_obter_qt_dia_estagio_os(a.nr_sequencia) = qt_dias_w)))) 
	and (a.ie_status_ordem = coalesce(ie_status_ordem_w,a.ie_status_ordem) 
		or (a.ie_status_ordem in ('1','2') and ie_status_ordem_w = 4)) 
	and (ie_tipo_alerta_w = 'P' or (ie_tipo_alerta_w = 'E' 
		and not exists (	SELECT	1 
				from	man_ordem_servico_exec x 
				where	x.nr_seq_ordem = a.nr_sequencia))) 
	group by a.nr_sequencia, 
		a.cd_pessoa_solicitante, 
		a.ie_status_ordem, 
		a.ds_dano_breve, 
		a.ds_dano, 
		a.ie_classificacao, 
		a.nr_seq_estagio, 
		a.nm_usuario_exec 
	order by 1;

/* OS - Usuários informados */
 
C05 CURSOR FOR 
	SELECT	a.nr_sequencia, 
		substr(obter_nome_pf(a.cd_pessoa_solicitante),1,60) nm_pessoa_solic, 
		substr(CASE WHEN a.ie_status_ordem=1 THEN obter_desc_expressao(283054)/*'Aberta'*/
 WHEN a.ie_status_ordem=2 THEN obter_desc_expressao(296477)/*'Processo'*/ WHEN a.ie_status_ordem=3 THEN obter_desc_expressao(713358)/*'Encerrado'*/ END ,1,10) ds_status_ordem, 
		a.ds_dano_breve, 
		a.ds_dano, 
		substr(coalesce(obter_valor_dominio(1149,a.ie_classificacao),obter_desc_expressao(622834)/*'Não informada'*/
),1,255), 
		substr(obter_desc_estagio_proc(a.nr_seq_estagio),1,80) ds_estagio, 
		a.nm_usuario_exec 
	from	man_ordem_servico a 
	where	coalesce(a.nr_grupo_planej,0) = coalesce(nr_seq_grupo_planej_w, coalesce(a.nr_grupo_planej,0)) 
	and	coalesce(a.nr_grupo_trabalho,0) = coalesce(nr_seq_grupo_trab_w, coalesce(a.nr_grupo_trabalho,0)) 
	and	coalesce(a.nr_seq_estagio,0) = coalesce(nr_seq_estagio_w, coalesce(a.nr_seq_estagio,0)) 
	and	coalesce(a.ie_solic_vip,'N') = coalesce(ie_solic_vip_w, coalesce(a.ie_solic_vip,'N')) 
	and	((ie_dia_espec_w = 'N' and 
		((ie_tipo_data_w = 'O' and obter_dias_entre_datas(a.dt_ordem_servico,clock_timestamp()) >= qt_dias_w) 
		or (ie_tipo_data_w = 'E' and man_obter_qt_dia_estagio_os(a.nr_sequencia) >= qt_dias_w))) or 
		(ie_dia_espec_w = 'S' and 
		((ie_tipo_data_w = 'O' and obter_dias_entre_datas(a.dt_ordem_servico,clock_timestamp()) = qt_dias_w) 
		or (ie_tipo_data_w = 'E' and man_obter_qt_dia_estagio_os(a.nr_sequencia) = qt_dias_w))))	 
	and (a.ie_status_ordem = coalesce(ie_status_ordem_w,a.ie_status_ordem) 
		or (a.ie_status_ordem in ('1','2') and ie_status_ordem_w = 4)) 
	and (ie_tipo_alerta_w = 'P' or (ie_tipo_alerta_w = 'E' 
		and not exists (	SELECT	1 
				from	man_ordem_servico_exec x 
				where	x.nr_seq_ordem = a.nr_sequencia))) 
	order by 1;

C06 CURSOR FOR 
	SELECT	ie_usuario, 
		'' nm_usuario_destino 
	from	man_regra_envio_acomp_usu 
	where	nr_seq_regra = nr_seq_regra_w 
	and	ie_usuario <> 'U' 
	group by ie_usuario 
	
union all
 
	SELECT	ie_usuario, 
		nm_usuario_destino 
	from	man_regra_envio_acomp_usu 
	where	nr_seq_regra = nr_seq_regra_w 
	and	ie_usuario = 'U';

/* Executores */
 
C07 CURSOR FOR 
	SELECT	distinct b.nm_usuario_exec 
	from	man_ordem_servico_exec b, 
		man_ordem_servico a 
	where	a.nr_sequencia = b.nr_seq_ordem 
	and	ie_tipo_alerta_w = 'P' 
	and	coalesce(a.nr_grupo_planej,0) = coalesce(nr_seq_grupo_planej_w, coalesce(a.nr_grupo_planej,0)) 
	and	coalesce(a.nr_grupo_trabalho,0) = coalesce(nr_seq_grupo_trab_w, coalesce(a.nr_grupo_trabalho,0)) 
	and	coalesce(a.nr_seq_estagio,0) = coalesce(nr_seq_estagio_w, coalesce(a.nr_seq_estagio,0)) 
	and	coalesce(a.ie_solic_vip,'N') = coalesce(ie_solic_vip_w, coalesce(a.ie_solic_vip,'N')) 
	and	((ie_dia_espec_w = 'N' and 
		((ie_tipo_data_w = 'O' and obter_dias_entre_datas(a.dt_ordem_servico,clock_timestamp()) >= qt_dias_w) 
		or (ie_tipo_data_w = 'E' and man_obter_qt_dia_estagio_os(a.nr_sequencia) >= qt_dias_w))) or 
		(ie_dia_espec_w = 'S' and 
		((ie_tipo_data_w = 'O' and obter_dias_entre_datas(a.dt_ordem_servico,clock_timestamp()) = qt_dias_w) 
		or (ie_tipo_data_w = 'E' and man_obter_qt_dia_estagio_os(a.nr_sequencia) = qt_dias_w)))) 
	and	((a.ie_status_ordem = coalesce(ie_status_ordem_w,a.ie_status_ordem)) 
		or ((a.ie_status_ordem in ('1','2')) and (ie_status_ordem_w = 4)));

/* Solicitante */
 
C08 CURSOR FOR 
	SELECT	distinct b.nm_usuario 
	from	usuario b, 
		man_ordem_servico a 
	where	a.cd_pessoa_solicitante = b.cd_pessoa_fisica 
	and	b.ie_situacao = 'A' 
	and	coalesce(a.nr_grupo_planej,0) = coalesce(nr_seq_grupo_planej_w, coalesce(a.nr_grupo_planej,0)) 
	and	coalesce(a.nr_grupo_trabalho,0) = coalesce(nr_seq_grupo_trab_w, coalesce(a.nr_grupo_trabalho,0)) 
	and	coalesce(a.nr_seq_estagio,0) = coalesce(nr_seq_estagio_w, coalesce(a.nr_seq_estagio,0)) 
	and	coalesce(a.ie_solic_vip,'N') = coalesce(ie_solic_vip_w, coalesce(a.ie_solic_vip,'N')) 
	and	((ie_dia_espec_w = 'N' and 
		((ie_tipo_data_w = 'O' and obter_dias_entre_datas(a.dt_ordem_servico,clock_timestamp()) >= qt_dias_w) 
		or (ie_tipo_data_w = 'E' and man_obter_qt_dia_estagio_os(a.nr_sequencia) >= qt_dias_w))) or 
		(ie_dia_espec_w = 'S' and 
		((ie_tipo_data_w = 'O' and obter_dias_entre_datas(a.dt_ordem_servico,clock_timestamp()) = qt_dias_w) 
		or (ie_tipo_data_w = 'E' and man_obter_qt_dia_estagio_os(a.nr_sequencia) = qt_dias_w)))) 
	and	((a.ie_status_ordem = coalesce(ie_status_ordem_w,a.ie_status_ordem)) 
		or ((a.ie_status_ordem in ('1','2')) and (ie_status_ordem_w = 4)))	 
	and (ie_tipo_alerta_w = 'P' or (ie_tipo_alerta_w = 'E' 
		and not exists (	SELECT	1 
				from	man_ordem_servico_exec x 
				where	x.nr_seq_ordem = a.nr_sequencia)));

/* Responsável do setor do solicitante */
 
C09 CURSOR FOR 
	SELECT	distinct d.nm_usuario 
	from	usuario d, 
		setor_atendimento c, 
		usuario b, 
		man_ordem_servico a 
	where	a.cd_pessoa_solicitante = b.cd_pessoa_fisica 
	and	c.cd_setor_atendimento = b.cd_setor_atendimento 
	and	c.cd_pessoa_resp = d.cd_pessoa_fisica 
	and	b.ie_situacao = 'A' 
	and	d.ie_situacao = 'A' 
	and	coalesce(a.nr_grupo_planej,0) = coalesce(nr_seq_grupo_planej_w, coalesce(a.nr_grupo_planej,0)) 
	and	coalesce(a.nr_grupo_trabalho,0) = coalesce(nr_seq_grupo_trab_w, coalesce(a.nr_grupo_trabalho,0)) 
	and	coalesce(a.nr_seq_estagio,0) = coalesce(nr_seq_estagio_w, coalesce(a.nr_seq_estagio,0)) 
	and	coalesce(a.ie_solic_vip,'N') = coalesce(ie_solic_vip_w, coalesce(a.ie_solic_vip,'N')) 
	and	((ie_dia_espec_w = 'N' and 
		((ie_tipo_data_w = 'O' and obter_dias_entre_datas(a.dt_ordem_servico,clock_timestamp()) >= qt_dias_w) 
		or (ie_tipo_data_w = 'E' and man_obter_qt_dia_estagio_os(a.nr_sequencia) >= qt_dias_w))) or 
		(ie_dia_espec_w = 'S' and 
		((ie_tipo_data_w = 'O' and obter_dias_entre_datas(a.dt_ordem_servico,clock_timestamp()) = qt_dias_w) 
		or (ie_tipo_data_w = 'E' and man_obter_qt_dia_estagio_os(a.nr_sequencia) = qt_dias_w)))) 
	and	((a.ie_status_ordem = coalesce(ie_status_ordem_w,a.ie_status_ordem)) 
		or ((a.ie_status_ordem in ('1','2')) and (ie_status_ordem_w = 4))) 
	and (ie_tipo_alerta_w = 'P' or (ie_tipo_alerta_w = 'E' 
		and not exists (	SELECT	1 
				from	man_ordem_servico_exec x 
				where	x.nr_seq_ordem = a.nr_sequencia)));

C10 CURSOR FOR 
	SELECT	nr_seq_ordem_servico 
	from	man_ordem_serv_vinc 
	where	nr_seq_os_vinculada = nr_seq_ordem_w 
	
union
 
	SELECT	nr_seq_os_vinculada 
	from	man_ordem_serv_vinc 
	where	nr_seq_ordem_servico = nr_seq_ordem_w;
	
C11 CURSOR FOR 
	SELECT	distinct b.nm_usuario_exec 
	from	man_ordem_servico_exec b, 
		man_ordem_servico a 
	where	a.nr_sequencia = b.nr_seq_ordem 
	and	a.nr_sequencia = nr_seq_ordem_w 
	order by 1;

/* Grupo de Trabalho*/
 
C12 CURSOR FOR 
	SELECT	a.nr_sequencia, 
		substr(obter_nome_pf(a.cd_pessoa_solicitante),1,60) nm_pessoa_solic, 
		substr(CASE WHEN a.ie_status_ordem=1 THEN obter_desc_expressao(283054)/*'Aberta'*,2,obter_desc_expressao(296477)/*'Processo'*/
 WHEN a.ie_status_ordem=3 THEN obter_desc_expressao(713358)/*'Encerrado'*/ END ,1,10) ds_status_ordem, 
		a.ds_dano_breve, 
		a.ds_dano, 
		substr(coalesce(obter_valor_dominio(1149,a.ie_classificacao),obter_desc_expressao(622834)),1,255) ds_classificacao, 
		substr(obter_desc_estagio_proc(a.nr_seq_estagio),1,80) ds_estagio, 
		substr(obter_nome_usuario_exec2(a.nr_sequencia,a.nr_seq_estagio,a.nm_usuario_exec ),1,15) nm_usuario_exec, 
		b.nr_sequencia 
	from	man_grupo_trabalho b, 
		man_ordem_servico a 
	where	a.nr_grupo_trabalho = b.nr_sequencia 
	and	exists (SELECT	1 
			from	man_grupo_trab_usuario c 
			where	c.nr_seq_grupo_trab = b.nr_sequencia) 
	and	ie_tipo_alerta_w = 'P' 
	and	coalesce(a.nr_grupo_planej,0) = coalesce(nr_seq_grupo_planej_w, coalesce(a.nr_grupo_planej,0)) 
	and	coalesce(a.nr_grupo_trabalho,0) = coalesce(nr_seq_grupo_trab_w, coalesce(a.nr_grupo_trabalho,0)) 
	and	coalesce(a.nr_seq_estagio,0) = coalesce(nr_seq_estagio_w, coalesce(a.nr_seq_estagio,0)) 
	and	coalesce(a.ie_solic_vip,'N') = coalesce(ie_solic_vip_w, coalesce(a.ie_solic_vip,'N')) 
	and	((ie_dia_espec_w = 'N' and 
		((ie_tipo_data_w = 'O' and obter_dias_entre_datas(a.dt_ordem_servico,clock_timestamp()) >= qt_dias_w) 
		or (ie_tipo_data_w = 'E' and man_obter_qt_dia_estagio_os(a.nr_sequencia) >= qt_dias_w))) or 
		(ie_dia_espec_w = 'S' and 
		((ie_tipo_data_w = 'O' and obter_dias_entre_datas(a.dt_ordem_servico,clock_timestamp()) = qt_dias_w) 
		or (ie_tipo_data_w = 'E' and man_obter_qt_dia_estagio_os(a.nr_sequencia) = qt_dias_w)))) 
	and (a.ie_status_ordem = coalesce(ie_status_ordem_w,a.ie_status_ordem) 
		or (a.ie_status_ordem in ('1','2') and ie_status_ordem_w = 4)) 
	group by a.nr_sequencia, 
		a.cd_pessoa_solicitante, 
		a.ie_status_ordem, 
		a.ds_dano_breve, 
		a.ds_dano, 
		a.ie_classificacao, 
		a.nr_seq_estagio, 
		a.nm_usuario_exec, 
		b.nr_sequencia 
	order by 1;

/* Grupo de Trabalho*/
 
C13 CURSOR FOR 
	SELECT	distinct c.nm_usuario_param 
	from	man_grupo_trab_usuario c, 
		man_grupo_trabalho b, 
		man_ordem_servico a 
	where	a.nr_grupo_trabalho = b.nr_sequencia 
	and	c.nr_seq_grupo_trab = b.nr_sequencia 
	and	ie_tipo_alerta_w = 'P' 
	and	coalesce(a.nr_grupo_planej,0) = coalesce(nr_seq_grupo_planej_w, coalesce(a.nr_grupo_planej,0)) 
	and	coalesce(a.nr_grupo_trabalho,0) = coalesce(nr_seq_grupo_trab_w, coalesce(a.nr_grupo_trabalho,0)) 
	and	coalesce(a.nr_seq_estagio,0) = coalesce(nr_seq_estagio_w, coalesce(a.nr_seq_estagio,0)) 
	and	coalesce(a.ie_solic_vip,'N') = coalesce(ie_solic_vip_w, coalesce(a.ie_solic_vip,'N')) 
	and	((ie_dia_espec_w = 'N' and 
		((ie_tipo_data_w = 'O' and obter_dias_entre_datas(a.dt_ordem_servico,clock_timestamp()) >= qt_dias_w) 
		or (ie_tipo_data_w = 'E' and man_obter_qt_dia_estagio_os(a.nr_sequencia) >= qt_dias_w))) or 
		(ie_dia_espec_w = 'S' and 
		((ie_tipo_data_w = 'O' and obter_dias_entre_datas(a.dt_ordem_servico,clock_timestamp()) = qt_dias_w) 
		or (ie_tipo_data_w = 'E' and man_obter_qt_dia_estagio_os(a.nr_sequencia) = qt_dias_w)))) 
	and (a.ie_status_ordem = coalesce(ie_status_ordem_w,a.ie_status_ordem) 
		or (a.ie_status_ordem in ('1','2') and ie_status_ordem_w = 4));
			
	 

BEGIN 
 
open C01;
loop 
fetch C01 into 
	nr_seq_regra_w, 
	qt_dias_w, 
	ie_tipo_alerta_w, 
	ie_status_ordem_w, 
	nr_seq_grupo_planej_w, 
	nr_seq_grupo_trab_w, 
	nr_seq_estagio_w, 
	ie_comunic_interna_w, 
	ie_email_w, 
	ds_comunicado_original_w, 
	ds_titulo_w, 
	ds_email_origem_w, 
	ie_dia_espec_w, 
	qt_min_repeticao_w, 
	dt_proxima_exec_w, 
	ie_tipo_data_w, 
	ie_solic_vip_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	if (qt_min_repeticao_w = 1440) and (coalesce(dt_proxima_exec_w::text, '') = '') then 
		dt_proxima_exec_w := trunc(dt_execucao_w + 1) + 03/24;
	else 
		dt_proxima_exec_w := trunc(dt_execucao_w,'mi') + qt_min_repeticao_w / 1440;
	end if;
		 
	update	man_regra_envio_acomp 
	set	dt_proxima_exec = dt_proxima_exec_w 
	where	nr_sequencia = nr_seq_regra_w;
	 
	commit;
	 
	if (coalesce(ds_titulo_w,'X') = 'X') then 
		if (ie_tipo_alerta_w = 'P') then 
			ds_titulo_w := substr(obter_desc_expressao(679583)/*'Ordens de serviço pendentes'*/
,1,255);
		elsif (ie_tipo_alerta_w = 'E') then 
			ds_titulo_w := substr('Ordens de serviço sem executor previsto',1,255);
		end if;
	end if;
	 
	select	obter_classif_comunic('F') 
	into STRICT	nr_seq_classif_w 
	;
 
	ds_comunicacao_w		:= null;
	nm_usuario_w			:= null;
	ds_lista_email_usuario_w	:= null;
	ds_usu_infor_dest_w		:= null;
	 
	open C06;
	loop 
	fetch C06 into 
		ie_usuario_w, 
		ds_usu_infor_aux_w;
	EXIT WHEN NOT FOUND; /* apply on C06 */
		begin 
		 
		if (coalesce(ie_usuario_w,'U') = 'E') then /* Executores */
 
			begin 
			open C07;
			loop 
			fetch C07 into 
				nm_usuario_exec_w;
			EXIT WHEN NOT FOUND; /* apply on C07 */
				begin 
				 
				if (coalesce(nm_usuario_exec_w,'X') <> 'X') then 
					begin 
					ds_lista_ordem_servico_w	:= null;
					 
					open C02;
					loop 
					fetch C02 into 
						nr_seq_ordem_w, 
						nm_pessoa_solic_w, 
						ds_status_os_w, 
						ds_dano_breve_w, 
						ds_dano_w, 
						ds_classificacao_w, 
						ds_estagio_w, 
						nm_usuario_inicio_exec_w;
					EXIT WHEN NOT FOUND; /* apply on C02 */
						begin 
						if (ie_tipo_data_w = 'O') then 
							select	max(dt_ordem_servico) 
							into STRICT	dt_ordem_servico_w 
							from	man_ordem_servico 
							where	nr_sequencia	= nr_seq_ordem_w;
							 
							select	obter_dias_entre_datas(dt_ordem_servico_w,clock_timestamp()) 
							into STRICT	qt_dias_macro_w 
							;
							 
						elsif (ie_tipo_data_w = 'E') then 
							select	man_obter_qt_dia_estagio_os(nr_seq_ordem_w) 
							into STRICT	qt_dias_macro_w 
							;
						end if;
						 
						if (coalesce(ds_comunicado_original_w::text, '') = '') then 
							begin 
							ds_format_os_w		:= obter_desc_expressao(342089);--'Ordem: '; 
							ds_format_sts_os_w	:= obter_desc_expressao(326269);--'		Status: '; 
							ds_format_desc_os_w	:= obter_desc_expressao(313423);--'		Descrição: '; 
							
							select	CASE /*'Aberta'*, obter_desc_expressao(329239)/*'			Solicitante: '*/
 WHEN ds_status_os_w=obter_desc_expressao(283054) THEN  obter_desc_expressao(329239)/*'		Solicitante: '*/ END  
							into STRICT	ds_format_solic_w 
							;
							 
							ds_comunicacao_w := substr(ds_comunicacao_w || 
								ds_format_os_w || nr_seq_ordem_w || 
								ds_format_sts_os_w || ds_status_os_w || 
								ds_format_solic_w || nm_pessoa_solic_w || 
								ds_format_desc_os_w || ds_dano_breve_w || chr(13) || chr(10),1,32000);
							end;
						elsif (position('@ds_lista_ordem_servico' in ds_comunicado_original_w) > 0) then 
							begin 
							ds_lista_ordem_servico_w	:= substr(ds_lista_ordem_servico_w || nr_seq_ordem_w || chr(13) || chr(10),1,4000);									
							end;
						else 
							begin 
							ds_comunicacao_w := substr(ds_comunicacao_w || ds_comunicado_original_w || chr(13) || chr(10),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@nr_ordem_servico', nr_seq_ordem_w),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_dano_breve', ds_dano_breve_w),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_dano', ds_dano_w),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_solicitante', nm_pessoa_solic_w),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_status_os', ds_status_os_w),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_classificacao', ds_classificacao_w),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@qt_dias', qt_dias_macro_w),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_estagio_os', ds_estagio_w),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_executor', nm_usuario_inicio_exec_w),1,32000);
							 
							if (position('@ds_estagio_philips' in ds_comunicacao_w) > 0) then 
								begin 
								select	max(ds_estagio) 
								into STRICT	ds_estagio_philips_w 
								from	man_ordem_serv_estag_wheb a 
								where	a.nr_sequencia = (	SELECT	max(x.nr_sequencia) 
												from	man_ordem_serv_estag_wheb x 
												where	(x.ds_estagio IS NOT NULL AND x.ds_estagio::text <> '') 
												and	x.nr_seq_ordem_servico = nr_seq_ordem_w);
								 
								ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w,'@ds_estagio_philips',ds_estagio_philips_w),1,32000);
								end;
							end if;
														 
							if (position('@dt_prevista_philips' in ds_comunicacao_w) > 0) then							 
								select	MAX(dt_prevista) 
								into STRICT	dt_prevista_philips_w 
								from	man_os_ativ_prev_wheb 
								where	nr_seq_ordem_serv = nr_seq_ordem_w;								
								ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w,'@dt_prevista_philips',coalesce(to_char(dt_prevista_philips_w,'dd/mm/yyyy'),obter_desc_expressao(331591)/*'Sem data prevista'*/)),1,32000);														
							end if;
							 
							if (position('@lista_exec_prev' in ds_comunicacao_w) > 0) then 
								begin 
								ds_lista_executores_w := null;	
								 
								open C11;
								loop 
								fetch C11 into	 
									nm_usuario_exec_prev_w;
								EXIT WHEN NOT FOUND; /* apply on C11 */
									begin 
									if (coalesce(ds_lista_executores_w,'X') = 'X') then 
										ds_lista_executores_w := nm_usuario_exec_prev_w;
									else 
										ds_lista_executores_w := substr(ds_lista_executores_w || '; ' || nm_usuario_exec_prev_w,1,2000);
									end if;
									 
									end;
								end loop;
								close C11;
								 
								ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w,'@lista_exec_prev',ds_lista_executores_w),1,32000);							
								end;							
							end if;
							 
							if (position('@ds_lista_os_vinculada' in ds_comunicacao_w) > 0) then 
								begin 
								ds_lista_os_vinculada_w := null;
								 
								open C10;
								loop 
								fetch C10 into	 
									nr_seq_os_vinculada_w;
								EXIT WHEN NOT FOUND; /* apply on C10 */
									begin 
									if (coalesce(ds_lista_os_vinculada_w,'X') = 'X') then 
										ds_lista_os_vinculada_w := nr_seq_os_vinculada_w;
									else 
										ds_lista_os_vinculada_w := substr(ds_lista_os_vinculada_w || '; ' || nr_seq_os_vinculada_w,1,2000);
									end if;
									end;
								end loop;
								close C10;
								 
								ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w,'@ds_lista_os_vinculada',ds_lista_os_vinculada_w),1,32000);
								end;
							end if;
							end;
						end if;
						end;
					end loop;
					close C02;
					 
					if (coalesce(ds_comunicado_original_w,'0') <> '0') and (coalesce(ds_lista_ordem_servico_w,'0') <> '0') then 
						begin 
						ds_comunicacao_w	:= ds_comunicado_original_w;
						ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_lista_ordem_servico', ds_lista_ordem_servico_w),1,32000);
						end;
					end if;
					 
					if (ds_comunicacao_w IS NOT NULL AND ds_comunicacao_w::text <> '') then 
						begin 
						if (ie_comunic_interna_w = 'S') then 
							begin 
							insert into comunic_interna(dt_comunicado, 
									ds_titulo, 
									ds_comunicado, 
									nm_usuario, 
									dt_atualizacao, 
									ie_geral, 
									nm_usuario_destino, 
									nr_sequencia, 
									ie_gerencial, 
									nr_seq_classif, 
									dt_liberacao) 
							values (clock_timestamp(), 
									ds_titulo_w, 
									ds_comunicacao_w, 
									nm_usuario_p, 
									clock_timestamp(), 
									'N', 
									nm_usuario_exec_w, 
									nextval('comunic_interna_seq'), 
									'N', 
									nr_seq_classif_w, 
									clock_timestamp());
							end;
						end if;
						 
						if (ie_email_w = 'S') then 
							begin 
							select	max(ds_email) 
							into STRICT	ds_email_usuario_w 
							from	usuario 
							where	nm_usuario = nm_usuario_exec_w;
							 
							if (ds_email_usuario_w IS NOT NULL AND ds_email_usuario_w::text <> '') then 
								begin 
								CALL enviar_email(	ds_titulo_w, 
										ds_comunicacao_w, 
										ds_email_origem_w, 
										ds_email_usuario_w, 
										nm_usuario_p, 
										'M');
								exception 
								when others then 
									null;
								end;
							end if;
							end;
						end if;
						end;
					end if;
					 
					ds_comunicacao_w	:= null;
					end;
				end if;
				end;
			end loop;
			close C07;
			ds_comunicacao_w 	:= null;
			nm_usuario_exec_w	:= null;
			end;
		end if;
		if (coalesce(ie_usuario_w,'U') = 'S') then /* Solicitante */
 
			begin 
			open C08;
			loop 
			fetch C08 into 
				nm_usuario_solic_w;
			EXIT WHEN NOT FOUND; /* apply on C08 */
				begin 
				if (coalesce(nm_usuario_solic_w,'X') <> 'X') then 
					begin 
					ds_lista_ordem_servico_w	:= null;
					 
					open C03;
					loop 
					fetch C03 into 
						nr_seq_ordem_w, 
						nm_pessoa_solic_w, 
						ds_status_os_w, 
						ds_dano_breve_w, 
						ds_dano_w, 
						ds_classificacao_w, 
						ds_estagio_w, 
						nm_usuario_inicio_exec_w;
					EXIT WHEN NOT FOUND; /* apply on C03 */
						begin 
						if (ie_tipo_data_w = 'O') then 
							select	max(dt_ordem_servico) 
							into STRICT	dt_ordem_servico_w 
							from	man_ordem_servico 
							where	nr_sequencia	= nr_seq_ordem_w;
							 
							select	obter_dias_entre_datas(dt_ordem_servico_w,clock_timestamp()) 
							into STRICT	qt_dias_macro_w 
							;
							 
						elsif (ie_tipo_data_w = 'E') then 
							select	man_obter_qt_dia_estagio_os(nr_seq_ordem_w) 
							into STRICT	qt_dias_macro_w 
							;
						end if;
						 
						if (coalesce(ds_comunicado_original_w::text, '') = '') then 
							begin 
							ds_format_os_w		:= obter_desc_expressao(342089);--'Ordem: '; 
							ds_format_sts_os_w	:= obter_desc_expressao(326269);--'		Status: '; 
							ds_format_desc_os_w	:= obter_desc_expressao(313423);--'		Descrição: '; 
							
							select	CASE /*'Aberta'*, obter_desc_expressao(329239)/*'			Solicitante: '*/
 WHEN ds_status_os_w=obter_desc_expressao(283054) THEN  obter_desc_expressao(329239)/*'		Solicitante: '*/ END  
							into STRICT	ds_format_solic_w 
							;
							 
							ds_comunicacao_w := substr(ds_comunicacao_w || 
								ds_format_os_w || nr_seq_ordem_w || 
								ds_format_sts_os_w || ds_status_os_w || 
								ds_format_solic_w || nm_pessoa_solic_w || 
								ds_format_desc_os_w || ds_dano_breve_w || chr(13) || chr(10),1,32000);
							end;
						elsif (position('@ds_lista_ordem_servico' in ds_comunicado_original_w) > 0) then 
							begin 
							ds_lista_ordem_servico_w	:= substr(ds_lista_ordem_servico_w || nr_seq_ordem_w || chr(13) || chr(10),1,4000);									
							end;
						else 
							begin 
							ds_comunicacao_w := substr(ds_comunicacao_w || ds_comunicado_original_w || chr(13) || chr(10),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@nr_ordem_servico', nr_seq_ordem_w),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_dano_breve', ds_dano_breve_w),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_dano', ds_dano_w),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_solicitante', nm_pessoa_solic_w),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_status_os', ds_status_os_w),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_classificacao', ds_classificacao_w),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@qt_dias', qt_dias_macro_w),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_estagio_os', ds_estagio_w),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_executor', nm_usuario_inicio_exec_w),1,32000);
							 
							if (position('@ds_estagio_philips' in ds_comunicacao_w) > 0) then 
								begin 
								select	max(ds_estagio) 
								into STRICT	ds_estagio_philips_w 
								from	man_ordem_serv_estag_wheb a 
								where	a.nr_sequencia = (	SELECT	max(x.nr_sequencia) 
												from	man_ordem_serv_estag_wheb x 
												where	(x.ds_estagio IS NOT NULL AND x.ds_estagio::text <> '') 
												and	x.nr_seq_ordem_servico = nr_seq_ordem_w);
								 
								ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w,'@ds_estagio_philips',ds_estagio_philips_w),1,32000);
								end;
							end if;
							 
							if (position('@dt_prevista_philips' in ds_comunicacao_w) > 0) then							 
								select	MAX(dt_prevista) 
								into STRICT	dt_prevista_philips_w 
								from	man_os_ativ_prev_wheb 
								where	nr_seq_ordem_serv = nr_seq_ordem_w;								
								ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w,'@dt_prevista_philips',coalesce(to_char(dt_prevista_philips_w,'dd/mm/yyyy'),obter_desc_expressao(331591)/*'Sem data prevista'*/)),1,32000);														
							end if;
							 
							if (position('@lista_exec_prev' in ds_comunicacao_w) > 0) then 
								begin 
								ds_lista_executores_w := null;								
 
								open C11;
								loop 
								fetch C11 into	 
									nm_usuario_exec_prev_w;
								EXIT WHEN NOT FOUND; /* apply on C11 */
									begin 
									if (coalesce(ds_lista_executores_w,'X') = 'X') then 
										ds_lista_executores_w := nm_usuario_exec_prev_w;
									else 
										ds_lista_executores_w := substr(ds_lista_executores_w || '; ' || nm_usuario_exec_prev_w,1,2000);
									end if;
									 
									end;
								end loop;
								close C11;
 
								ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w,'@lista_exec_prev',ds_lista_executores_w),1,32000);							
								end;							
							end if;
							 
							if (position('@ds_lista_os_vinculada' in ds_comunicacao_w) > 0) then 
								begin 
								ds_lista_os_vinculada_w := null;
								 
								open C10;
								loop 
								fetch C10 into	 
									nr_seq_os_vinculada_w;
								EXIT WHEN NOT FOUND; /* apply on C10 */
									begin 
									if (coalesce(ds_lista_os_vinculada_w,'X') = 'X') then 
										ds_lista_os_vinculada_w := nr_seq_os_vinculada_w;
									else 
										ds_lista_os_vinculada_w := substr(ds_lista_os_vinculada_w || '; ' || nr_seq_os_vinculada_w,1,2000);
									end if;
									end;
								end loop;
								close C10;
								 
								ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w,'@ds_lista_os_vinculada',ds_lista_os_vinculada_w),1,32000);
								end;
							end if;
							end;
						end if;
						end;
					end loop;
					close C03;
					 
					if (coalesce(ds_comunicado_original_w,'0') <> '0') and (coalesce(ds_lista_ordem_servico_w,'0') <> '0') then 
						begin 
						ds_comunicacao_w	:= ds_comunicado_original_w;
						ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_lista_ordem_servico', ds_lista_ordem_servico_w),1,32000);
						end;
					end if;
					 
					if (ds_comunicacao_w IS NOT NULL AND ds_comunicacao_w::text <> '') then 
						begin 
						if (ie_comunic_interna_w = 'S') then 
							begin 
							insert into comunic_interna(dt_comunicado, 
									ds_titulo, 
									ds_comunicado, 
									nm_usuario, 
									dt_atualizacao, 
									ie_geral, 
									nm_usuario_destino, 
									nr_sequencia, 
									ie_gerencial, 
									nr_seq_classif, 
									dt_liberacao) 
							values (clock_timestamp(), 
									coalesce(ds_titulo_w,'nulo'), 
									ds_comunicacao_w, 
									nm_usuario_p, 
									clock_timestamp(), 
									'N', 
									nm_usuario_solic_w, 
									nextval('comunic_interna_seq'), 
									'N', 
									nr_seq_classif_w, 
									clock_timestamp());
							end;
						end if;
						 
						if (ie_email_w = 'S') then 
							begin 
							select	max(ds_email) 
							into STRICT	ds_email_usuario_w 
							from	usuario 
							where	nm_usuario = nm_usuario_solic_w;
							 
							if (ds_email_usuario_w IS NOT NULL AND ds_email_usuario_w::text <> '') then 
								begin 
								CALL enviar_email(	ds_titulo_w, 
										ds_comunicacao_w, 
										ds_email_origem_w, 
										ds_email_usuario_w, 
										nm_usuario_p, 
										'M');
								exception 
								when others then 
									null;
								end;
							end if;
							end;
						end if;
						end;
					end if;
					 
					ds_comunicacao_w	:= null;
					end;
				end if;
				end;
			end loop;
			close C08;
			ds_comunicacao_w 	:= null;
			nm_usuario_solic_w	:= null;
			end;
		end if;
 
		if (coalesce(ie_usuario_w,'U') = 'R') then /* Responsável do setor do solicitante */
 
			begin 
			open C09;
			loop 
			fetch C09 into 
				nm_usu_setor_solic_w;
			EXIT WHEN NOT FOUND; /* apply on C09 */
				begin 
				if (coalesce(nm_usu_setor_solic_w,'X') <> 'X') then 
					begin 
					ds_lista_ordem_servico_w	:= null;
					 
					open C04;
					loop 
					fetch C04 into 
						nr_seq_ordem_w, 
						nm_pessoa_solic_w, 
						ds_status_os_w, 
						ds_dano_breve_w, 
						ds_dano_w, 
						ds_classificacao_w, 
						ds_estagio_w, 
						nm_usuario_inicio_exec_w;
					EXIT WHEN NOT FOUND; /* apply on C04 */
						begin 
						if (ie_tipo_data_w = 'O') then 
							select	max(dt_ordem_servico) 
							into STRICT	dt_ordem_servico_w 
							from	man_ordem_servico 
							where	nr_sequencia	= nr_seq_ordem_w;
							 
							select	obter_dias_entre_datas(dt_ordem_servico_w,clock_timestamp()) 
							into STRICT	qt_dias_macro_w 
							;
							 
						elsif (ie_tipo_data_w = 'E') then 
							select	man_obter_qt_dia_estagio_os(nr_seq_ordem_w) 
							into STRICT	qt_dias_macro_w 
							;
						end if;
						 
						if (coalesce(ds_comunicado_original_w::text, '') = '') then 
							begin 
							ds_format_os_w		:= obter_desc_expressao(342089);--'Ordem: '; 
							ds_format_sts_os_w	:= obter_desc_expressao(326269);--'		Status: '; 
							ds_format_desc_os_w	:= obter_desc_expressao(313423);--'		Descrição: '; 
							
							select	CASE /*'Aberta'*, obter_desc_expressao(329239)/*'			Solicitante: '*/
 WHEN ds_status_os_w=obter_desc_expressao(283054) THEN  obter_desc_expressao(329239)/*'		Solicitante: '*/ END  
							into STRICT	ds_format_solic_w 
							;
							 
							ds_comunicacao_w := substr(ds_comunicacao_w || 
								ds_format_os_w || nr_seq_ordem_w || 
								ds_format_sts_os_w || ds_status_os_w || 
								ds_format_solic_w || nm_pessoa_solic_w || 
								ds_format_desc_os_w || ds_dano_breve_w || chr(13) || chr(10),1,32000);
							end;
						elsif (position('@ds_lista_ordem_servico' in ds_comunicado_original_w) > 0) then 
							begin 
							ds_lista_ordem_servico_w	:= substr(ds_lista_ordem_servico_w || nr_seq_ordem_w || chr(13) || chr(10),1,4000);									
							end;
						else 
							begin 
							ds_comunicacao_w := substr(ds_comunicacao_w || ds_comunicado_original_w || chr(13) || chr(10),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@nr_ordem_servico', nr_seq_ordem_w),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_dano_breve', ds_dano_breve_w),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_dano', ds_dano_w),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_solicitante', nm_pessoa_solic_w),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_status_os', ds_status_os_w),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_classificacao', ds_classificacao_w),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@qt_dias', qt_dias_macro_w),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_estagio_os', ds_estagio_w),1,32000);
							ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_executor', nm_usuario_inicio_exec_w),1,32000);
							 
							if (position('@ds_estagio_philips' in ds_comunicacao_w) > 0) then 
								begin 
								select	max(ds_estagio) 
								into STRICT	ds_estagio_philips_w 
								from	man_ordem_serv_estag_wheb a 
								where	a.nr_sequencia = (	SELECT	max(x.nr_sequencia) 
												from	man_ordem_serv_estag_wheb x 
												where	(x.ds_estagio IS NOT NULL AND x.ds_estagio::text <> '') 
												and	x.nr_seq_ordem_servico = nr_seq_ordem_w);
								 
								ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w,'@ds_estagio_philips',ds_estagio_philips_w),1,32000);
								end;
							end if;
							 
							if (position('@dt_prevista_philips' in ds_comunicacao_w) > 0) then							 
								select	MAX(dt_prevista) 
								into STRICT	dt_prevista_philips_w 
								from	man_os_ativ_prev_wheb 
								where	nr_seq_ordem_serv = nr_seq_ordem_w;								
								ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w,'@dt_prevista_philips',coalesce(to_char(dt_prevista_philips_w,'dd/mm/yyyy'),obter_desc_expressao(331591)/*'Sem data prevista'*/)),1,32000);														
							end if;
							 
							if (position('@lista_exec_prev' in ds_comunicacao_w) > 0) then 
								begin								 
								ds_lista_executores_w := null;
								 
								open C11;
								loop 
								fetch C11 into	 
									nm_usuario_exec_prev_w;
								EXIT WHEN NOT FOUND; /* apply on C11 */
									begin 
									if (coalesce(ds_lista_executores_w,'X') = 'X') then 
										ds_lista_executores_w := nm_usuario_exec_prev_w;
									else 
										ds_lista_executores_w := substr(ds_lista_executores_w || '; ' || nm_usuario_exec_prev_w,1,2000);
									end if;
									 
									end;
								end loop;
								close C11;
								 
								ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w,'@lista_exec_prev',ds_lista_executores_w),1,32000);									
								end;														
							end if;							
							 
							if (position('@ds_lista_os_vinculada' in ds_comunicacao_w) > 0) then 
								begin 
								ds_lista_os_vinculada_w := null;
								 
								open C10;
								loop 
								fetch C10 into	 
									nr_seq_os_vinculada_w;
								EXIT WHEN NOT FOUND; /* apply on C10 */
									begin 
									if (coalesce(ds_lista_os_vinculada_w,'X') = 'X') then 
										ds_lista_os_vinculada_w := nr_seq_os_vinculada_w;
									else 
										ds_lista_os_vinculada_w := substr(ds_lista_os_vinculada_w || '; ' || nr_seq_os_vinculada_w,1,2000);
									end if;
									end;
								end loop;
								close C10;
								 
								ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w,'@ds_lista_os_vinculada',ds_lista_os_vinculada_w),1,32000);
								end;
							end if;
							end;
						end if;
						end;
					end loop;
					close C04;
					 
					if (coalesce(ds_comunicado_original_w,'0') <> '0') and (coalesce(ds_lista_ordem_servico_w,'0') <> '0') then 
						begin 
						ds_comunicacao_w	:= ds_comunicado_original_w;
						ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_lista_ordem_servico', ds_lista_ordem_servico_w),1,32000);
						end;
					end if;
					 
					if (ds_comunicacao_w IS NOT NULL AND ds_comunicacao_w::text <> '') then 
						begin 
						if (ie_comunic_interna_w = 'S') then 
							begin 
							insert into comunic_interna(dt_comunicado, 
									ds_titulo, 
									ds_comunicado, 
									nm_usuario, 
									dt_atualizacao, 
									ie_geral, 
									nm_usuario_destino, 
									nr_sequencia, 
									ie_gerencial, 
									nr_seq_classif, 
									dt_liberacao) 
							values (clock_timestamp(), 
									ds_titulo_w, 
									ds_comunicacao_w, 
									nm_usuario_p, 
									clock_timestamp(), 
									'N', 
									nm_usu_setor_solic_w, 
									nextval('comunic_interna_seq'), 
									'N', 
									nr_seq_classif_w, 
									clock_timestamp());
							end;
						end if;
						 
						if (ie_email_w = 'S') then 
							begin 
							select	max(ds_email) 
							into STRICT	ds_email_usuario_w 
							from	usuario 
							where	nm_usuario = nm_usu_setor_solic_w;
							 
							if (ds_email_usuario_w IS NOT NULL AND ds_email_usuario_w::text <> '') then 
								begin 
								CALL enviar_email(	ds_titulo_w, 
										ds_comunicacao_w, 
										ds_email_origem_w, 
										ds_email_usuario_w, 
										nm_usuario_p, 
										'M');
								exception 
								when others then 
									null;
								end;
							end if;
							end;
						end if;
						end;
					end if;
					 
					ds_comunicacao_w	:= null;
					end;
				end if;
				end;
			end loop;
			close C09;
			ds_comunicacao_w 	:= null;
			nm_usu_setor_solic_w	:= null;
			end;
		end if;
 
		if (coalesce(ie_usuario_w,'U') = 'T') then /* Usuários do Grupo de Trabalho*/
 
		 
			begin		 
			open C13;
			loop 
			fetch C13 into	 
				nm_usuario_grupo_trab_w;
			EXIT WHEN NOT FOUND; /* apply on C13 */
				begin 
				if (coalesce(nm_usuario_grupo_trab_w,'X') <> 'X') then 
					begin 
					ds_lista_ordem_servico_w	:= null;
					 
					open C12;
					loop 
					fetch C12 into 
						nr_seq_ordem_w, 
						nm_pessoa_solic_w, 
						ds_status_os_w, 
						ds_dano_breve_w, 
						ds_dano_w, 
						ds_classificacao_w, 
						ds_estagio_w, 
						nm_usuario_inicio_exec_w, 
						nr_seq_grupo_trab_regra_w;
					EXIT WHEN NOT FOUND; /* apply on C12 */
						begin 
						 
						select obter_se_usuario_grupo_trab(nr_seq_grupo_trab_regra_w , nm_usuario_grupo_trab_w) 
						into STRICT	usuario_grupo_trabalho_w	 
						;
						 
						if (coalesce(usuario_grupo_trabalho_w,'N') = 'S') then 
							 
							 
								if (ie_tipo_data_w = 'O') then 
									select	max(dt_ordem_servico) 
									into STRICT	dt_ordem_servico_w 
									from	man_ordem_servico 
									where	nr_sequencia	= nr_seq_ordem_w;
									 
									select	obter_dias_entre_datas(dt_ordem_servico_w,clock_timestamp()) 
									into STRICT	qt_dias_macro_w 
									;
									 
								elsif (ie_tipo_data_w = 'E') then 
									select	man_obter_qt_dia_estagio_os(nr_seq_ordem_w) 
									into STRICT	qt_dias_macro_w 
									;
								end if;
							 
							if (coalesce(ds_comunicado_original_w::text, '') = '') then 
								begin 
								ds_format_os_w		:= obter_desc_expressao(342089);--'Ordem: '; 
								ds_format_sts_os_w	:= obter_desc_expressao(326269);--'		Status: '; 
								ds_format_desc_os_w	:= obter_desc_expressao(313423);--'		Descrição: '; 
								
								select	CASE /*'Aberta'*, obter_desc_expressao(329239)/*'			Solicitante: '*/
 WHEN ds_status_os_w=obter_desc_expressao(283054) THEN  obter_desc_expressao(329239)/*'		Solicitante: '*/ END  
								into STRICT	ds_format_solic_w 
								;
								 
								ds_comunicacao_w := substr(ds_comunicacao_w || 
									ds_format_os_w || nr_seq_ordem_w || 
									ds_format_sts_os_w || ds_status_os_w || 
									ds_format_solic_w || nm_pessoa_solic_w || 
									ds_format_desc_os_w || ds_dano_breve_w || chr(13) || chr(10),1,32000);
								end;
							elsif (position('@ds_lista_ordem_servico' in ds_comunicado_original_w) > 0) then 
								begin 
								ds_lista_ordem_servico_w	:= substr(ds_lista_ordem_servico_w || nr_seq_ordem_w || chr(13) || chr(10),1,4000);									
								end;
							else 
								begin 
									 
									ds_comunicacao_w := substr(ds_comunicacao_w || ds_comunicado_original_w || chr(13) || chr(10),1,32000);
									ds_comunicacao_w := substr(replace_macro_long(ds_comunicacao_w, '@nr_ordem_servico', nr_seq_ordem_w),1,32000);
									ds_comunicacao_w := substr(replace_macro_long(ds_comunicacao_w, '@ds_dano_breve', ds_dano_breve_w),1,32000);
									ds_comunicacao_w := substr(replace_macro_long(ds_comunicacao_w, '@ds_dano', ds_dano_w),1,32000);
									ds_comunicacao_w := substr(replace_macro_long(ds_comunicacao_w, '@ds_solicitante', nm_pessoa_solic_w),1,32000);
									ds_comunicacao_w := substr(replace_macro_long(ds_comunicacao_w, '@ds_status_os', ds_status_os_w),1,32000);
									ds_comunicacao_w := substr(replace_macro_long(ds_comunicacao_w, '@ds_classificacao', ds_classificacao_w),1,32000);
									ds_comunicacao_w := substr(replace_macro_long(ds_comunicacao_w, '@qt_dias', qt_dias_macro_w),1,32000);
									ds_comunicacao_w := substr(replace_macro_long(ds_comunicacao_w, '@ds_estagio_os', ds_estagio_w),1,32000);
									ds_comunicacao_w := substr(replace_macro_long(ds_comunicacao_w, '@ds_executor', nm_usuario_inicio_exec_w),1,32000);
									 
								if (position('@ds_estagio_philips' in ds_comunicacao_w) > 0) then 
									begin 
									select	max(ds_estagio) 
									into STRICT	ds_estagio_philips_w 
									from	man_ordem_serv_estag_wheb a 
									where	a.nr_sequencia = (	SELECT	max(x.nr_sequencia) 
													from	man_ordem_serv_estag_wheb x 
													where	(x.ds_estagio IS NOT NULL AND x.ds_estagio::text <> '') 
													and	x.nr_seq_ordem_servico = nr_seq_ordem_w);
									 
									ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w,'@ds_estagio_philips',ds_estagio_philips_w),1,32000);
									end;
								end if;
															 
								if (position('@dt_prevista_philips' in ds_comunicacao_w) > 0) then							 
									select	MAX(dt_prevista) 
									into STRICT	dt_prevista_philips_w 
									from	man_os_ativ_prev_wheb 
									where	nr_seq_ordem_serv = nr_seq_ordem_w;								
									ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w,'@dt_prevista_philips',coalesce(to_char(dt_prevista_philips_w,'dd/mm/yyyy'),obter_desc_expressao(331591)/*'Sem data prevista'*/)),1,32000);														
								end if;
								 
								if (position('@lista_exec_prev' in ds_comunicacao_w) > 0) then 
									begin 
									ds_lista_executores_w := null;	
									 
									open C11;
									loop 
									fetch C11 into	 
										nm_usuario_exec_prev_w;
									EXIT WHEN NOT FOUND; /* apply on C11 */
										begin 
										if (coalesce(ds_lista_executores_w,'X') = 'X') then 
											ds_lista_executores_w := nm_usuario_exec_prev_w;
										else 
											ds_lista_executores_w := substr(ds_lista_executores_w || '; ' || nm_usuario_exec_prev_w,1,2000);
										end if;
										 
										end;
									end loop;
									close C11;
									 
									ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w,'@lista_exec_prev',ds_lista_executores_w),1,32000);							
									end;							
								end if;
								 
								if (position('@ds_lista_os_vinculada' in ds_comunicacao_w) > 0) then 
									begin 
									ds_lista_os_vinculada_w := null;
									 
									open C10;
									loop 
									fetch C10 into	 
										nr_seq_os_vinculada_w;
									EXIT WHEN NOT FOUND; /* apply on C10 */
										begin 
										if (coalesce(ds_lista_os_vinculada_w,'X') = 'X') then 
											ds_lista_os_vinculada_w := nr_seq_os_vinculada_w;
										else 
											ds_lista_os_vinculada_w := substr(ds_lista_os_vinculada_w || '; ' || nr_seq_os_vinculada_w,1,2000);
										end if;
										end;
									end loop;
									close C10;
									 
									ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w,'@ds_lista_os_vinculada',ds_lista_os_vinculada_w),1,32000);
									end;
								end if;
								end;
							end if;
						end if;
						end;
				 
					end loop;
					close C12;
						 
						if (coalesce(ds_comunicado_original_w,'0') <> '0') and (coalesce(ds_lista_ordem_servico_w,'0') <> '0') then 
							begin 
							ds_comunicacao_w	:= ds_comunicado_original_w;
							ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_lista_ordem_servico', ds_lista_ordem_servico_w),1,32000);
							end;
						end if;
						 
						if (ds_comunicacao_w IS NOT NULL AND ds_comunicacao_w::text <> '') then 
							begin 
							if (ie_comunic_interna_w = 'S') then 
								begin 
								insert into comunic_interna(dt_comunicado, 
										ds_titulo, 
										ds_comunicado, 
										nm_usuario, 
										dt_atualizacao, 
										ie_geral, 
										nm_usuario_destino, 
										nr_sequencia, 
										ie_gerencial, 
										nr_seq_classif, 
										dt_liberacao) 
								values (clock_timestamp(), 
										ds_titulo_w, 
										ds_comunicacao_w, 
										nm_usuario_p, 
										clock_timestamp(), 
										'N', 
										nm_usuario_grupo_trab_w, 
										nextval('comunic_interna_seq'), 
										'N', 
										nr_seq_classif_w, 
										clock_timestamp());
								end;
							end if;
							 
							if (ie_email_w = 'S') then 
								begin 
								select	max(ds_email) 
								into STRICT	ds_email_usuario_w 
								from	usuario 
								where	nm_usuario = nm_usuario_grupo_trab_w;
								 
								if (ds_email_usuario_w IS NOT NULL AND ds_email_usuario_w::text <> '') then 
									begin 
									CALL enviar_email(	ds_titulo_w, 
											ds_comunicacao_w, 
											ds_email_origem_w, 
											ds_email_usuario_w, 
											nm_usuario_p, 
											'M');
									exception 
									when others then 
										null;
									end;
								end if;
								end;
							end if;
							end;
						end if;
						 
						ds_comunicacao_w	:= null;
						end;					
				end if;
				end;
			end loop;
			close C13;
			ds_comunicacao_w 	:= null;
			nm_usuario_grupo_trab_w	:= null;
			end;
		end if;
		 
		if (coalesce(ie_usuario_w,'U') = 'U') and (coalesce(ds_usu_infor_aux_w,'X') <> 'X') then 
			ds_usu_infor_dest_w := substr(ds_usu_infor_aux_w || ', ' || ds_usu_infor_dest_w,1,2000);
		end if;
		 
	end;
	end loop;
	close C06;
 
	if (ds_usu_infor_dest_w IS NOT NULL AND ds_usu_infor_dest_w::text <> '') then 
		begin 
		ds_lista_ordem_servico_w	:= null;
 
		open C05;
		loop 
		fetch C05 into 
			nr_seq_ordem_w, 
			nm_pessoa_solic_w, 
			ds_status_os_w, 
			ds_dano_breve_w, 
			ds_dano_w, 
			ds_classificacao_w, 
			ds_estagio_w, 
			nm_usuario_inicio_exec_w;
		EXIT WHEN NOT FOUND; /* apply on C05 */
			begin					 
			if (ie_tipo_data_w = 'O') then 
				select	max(dt_ordem_servico) 
				into STRICT	dt_ordem_servico_w 
				from	man_ordem_servico 
				where	nr_sequencia	= nr_seq_ordem_w;
				 
				select	obter_dias_entre_datas(dt_ordem_servico_w,clock_timestamp()) 
				into STRICT	qt_dias_macro_w 
				;
				 
			elsif (ie_tipo_data_w = 'E') then 
				select	man_obter_qt_dia_estagio_os(nr_seq_ordem_w) 
				into STRICT	qt_dias_macro_w 
				;
			end if;
						 
			if (coalesce(ds_comunicado_original_w::text, '') = '') then 
				begin 
				ds_format_os_w		:= obter_desc_expressao(342089);--'Ordem: '; 
				ds_format_sts_os_w	:= obter_desc_expressao(326269);--'		Status: '; 
				ds_format_desc_os_w	:= obter_desc_expressao(313423);--'		Descrição: '; 
				
				select	CASE /*'Aberta'*, obter_desc_expressao(329239)/*'			Solicitante: '*/
 WHEN ds_status_os_w=obter_desc_expressao(283054) THEN  obter_desc_expressao(329239)/*'		Solicitante: '*/ END  
				into STRICT	ds_format_solic_w 
				;
				 
				ds_comunicacao_w := substr(ds_comunicacao_w || 
				ds_format_os_w || nr_seq_ordem_w || 
				ds_format_sts_os_w || ds_status_os_w || 
				ds_format_solic_w || nm_pessoa_solic_w || 
				ds_format_desc_os_w || ds_dano_breve_w || chr(13) || chr(10),1,32000);
				end;
			elsif (position('@ds_lista_ordem_servico' in ds_comunicado_original_w) > 0) then 
				begin 
				ds_lista_ordem_servico_w	:= substr(ds_lista_ordem_servico_w || nr_seq_ordem_w || chr(13) || chr(10),1,4000);									
				end;
			else 
				begin 
				ds_comunicacao_w := substr(ds_comunicacao_w || ds_comunicado_original_w || chr(13) || chr(10),1,32000);				
				ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@nr_ordem_servico', nr_seq_ordem_w),1,32000);
				ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_dano_breve', ds_dano_breve_w),1,32000);
				ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_dano', ds_dano_w),1,32000);
				ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_solicitante', nm_pessoa_solic_w),1,32000);
				ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_status_os', ds_status_os_w),1,32000);
				ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_classificacao', ds_classificacao_w),1,32000);
				ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@qt_dias', qt_dias_macro_w),1,32000);
				ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_estagio_os', ds_estagio_w),1,32000);
				ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_executor', nm_usuario_inicio_exec_w),1,32000);
				 
				if (position('@ds_estagio_philips' in ds_comunicacao_w) > 0) then 
					begin 
					select	max(ds_estagio) 
					into STRICT	ds_estagio_philips_w 
					from	man_ordem_serv_estag_wheb a 
					where	a.nr_sequencia = (	SELECT	max(x.nr_sequencia) 
									from	man_ordem_serv_estag_wheb x 
									where	(x.ds_estagio IS NOT NULL AND x.ds_estagio::text <> '') 
									and	x.nr_seq_ordem_servico = nr_seq_ordem_w);
					 
					ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w,'@ds_estagio_philips',ds_estagio_philips_w),1,32000);
					end;
				end if;
				 
				if (position('@dt_prevista_philips' in ds_comunicacao_w) > 0) then							 
					select	MAX(dt_prevista) 
					into STRICT	dt_prevista_philips_w 
					from	man_os_ativ_prev_wheb 
					where	nr_seq_ordem_serv = nr_seq_ordem_w;								
					ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w,'@dt_prevista_philips',coalesce(to_char(dt_prevista_philips_w,'dd/mm/yyyy'),obter_desc_expressao(331591)/*'Sem data prevista'*/)),1,32000);														
				end if;
				 
				if (position('@lista_exec_prev' in ds_comunicacao_w) > 0) then 
					begin 
					ds_lista_executores_w := null;								
					 
					open C11;
					loop 
					fetch C11 into	 
						nm_usuario_exec_prev_w;
					EXIT WHEN NOT FOUND; /* apply on C11 */
						begin 
						if (coalesce(ds_lista_executores_w,'X') = 'X') then 
							ds_lista_executores_w := nm_usuario_exec_prev_w;
						else 
							ds_lista_executores_w := substr(ds_lista_executores_w || '; ' || nm_usuario_exec_prev_w,1,2000);
						end if;
						 
						end;
					end loop;
					close C11;
					 
					ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w,'@lista_exec_prev',ds_lista_executores_w),1,32000);		
					end;							
				end if;
 
				if (position('@ds_lista_os_vinculada' in ds_comunicacao_w) > 0) then 
					begin 
					ds_lista_os_vinculada_w := null;
					 
					open C10;
					loop 
					fetch C10 into	 
						nr_seq_os_vinculada_w;
					EXIT WHEN NOT FOUND; /* apply on C10 */
						begin 
						if (coalesce(ds_lista_os_vinculada_w,'X') = 'X') then 
							ds_lista_os_vinculada_w := nr_seq_os_vinculada_w;
						else 
							ds_lista_os_vinculada_w := substr(ds_lista_os_vinculada_w || '; ' || nr_seq_os_vinculada_w,1,2000);
						end if;
						end;
					end loop;
					close C10;
					 
					ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w,'@ds_lista_os_vinculada',ds_lista_os_vinculada_w),1,32000);
					end;
				end if;
				end;
			end if;
			end;
		end loop;
		close C05;
		 
		if (coalesce(ds_comunicado_original_w,'0') <> '0') and (coalesce(ds_lista_ordem_servico_w,'0') <> '0') then 
			begin 
			ds_comunicacao_w	:= ds_comunicado_original_w;
			ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_lista_ordem_servico', ds_lista_ordem_servico_w),1,32000);
			end;
		end if;
		 
		if (ds_comunicacao_w IS NOT NULL AND ds_comunicacao_w::text <> '') then 
			begin 
			if (ie_comunic_interna_w = 'S') then 
				begin 
				insert into comunic_interna(dt_comunicado, 
						ds_titulo, 
						ds_comunicado, 
						nm_usuario, 
						dt_atualizacao, 
						ie_geral, 
						nm_usuario_destino, 
						nr_sequencia, 
						ie_gerencial, 
						nr_seq_classif, 
						dt_liberacao) 
				values (clock_timestamp(), 
						ds_titulo_w, 
						ds_comunicacao_w, 
						nm_usuario_p, 
						clock_timestamp(), 
						'N', 
						ds_usu_infor_dest_w, 
						nextval('comunic_interna_seq'), 
						'N', 
						nr_seq_classif_w, 
						clock_timestamp());
				end;
			end if;
			 
			if (ie_email_w = 'S') then 
				begin 
				lista_usuario_w := substr(ds_usu_infor_dest_w,1,2000);
				 
				while(lista_usuario_w IS NOT NULL AND lista_usuario_w::text <> '') and (trim(both lista_usuario_w) <> ',') loop 
					tam_lista_w		:= length(lista_usuario_w);
					ie_pos_virgula_w	:= position(',' in lista_usuario_w);
 
					if (ie_pos_virgula_w <> 0) then 
						nm_usuario_w	:= substr(lista_usuario_w,1,(ie_pos_virgula_w - 1));
						lista_usuario_w	:= trim(both substr(lista_usuario_w,(ie_pos_virgula_w + 1), tam_lista_w));
 
						select	max(ds_email) 
						into STRICT	ds_email_usuario_w 
						from	usuario 
						where	nm_usuario = nm_usuario_w;
 
						if (coalesce(ds_email_usuario_w,'X') <> 'X') then 
							begin 
							ds_lista_email_usuario_w := substr(ds_lista_email_usuario_w||ds_email_usuario_w||',',1,2000);
							end;
						end if;
					else 
						lista_usuario_w	:= null;
					end if;
				end loop;
				 
				if (coalesce(ds_lista_email_usuario_w,'X') <> 'X') then 
					begin 
					ds_lista_email_usuario_w := replace(ds_lista_email_usuario_w,',',';');
					CALL enviar_email(	ds_titulo_w, 
							ds_comunicacao_w, 
							ds_email_origem_w, 
							ds_lista_email_usuario_w, 
							nm_usuario_p, 
							'M');
					exception 
					when others then 
						null;
					end;
				end if;
				end;
			end if;
			end;
		end if;
		end;
		ds_comunicacao_w 	:= null;
	end if;
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_envio_acomp (nm_usuario_p text) FROM PUBLIC;

