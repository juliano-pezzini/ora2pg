-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_estorno_automatico () AS $body$
DECLARE

 
/* Campos do cursor 1 */
 
nr_seq_lote_w			pls_lote_comissao.nr_sequencia%type;
nm_usuario_w			pls_lote_comissao.nm_usuario%type;
cd_estabelecimento_w		pls_lote_comissao.cd_estabelecimento%type;

/* Campos do cursor 2 */
 
nr_seq_comissao_w		pls_comissao.nr_sequencia%type;
nr_seq_canal_venda_w		pls_comissao.nr_seq_canal_venda%type;

/* Campos do cursor 3 */
 
nr_seq_comissao_benef_w		pls_comissao_beneficiario.nr_sequencia%type;
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
dt_contratacao_w		pls_segurado.dt_contratacao%type;
dt_inclusao_operadora_w		pls_segurado.dt_inclusao_operadora%type;
dt_rescisao_w			pls_segurado.dt_rescisao%type;
nr_seq_motivo_cancelamento_w	pls_segurado.nr_seq_motivo_cancelamento%type;
vl_comissao_benef_w		pls_comissao_beneficiario.vl_comissao_benef%type;
nr_seq_vendedor_w		pls_segurado.nr_seq_vendedor_canal%type;
nr_parcela_w			pls_mensalidade_segurado.nr_parcela%type;

/* Outros campos */
 
qt_utilizacao_plano_w		integer;
qt_parcelas_pagas_w		integer;
nr_seq_regra_estorno_w		pls_regra_estorno_comissao.nr_sequencia%type;
nr_seq_motivo_cancel_w		pls_regra_estorno_comissao.nr_seq_motivo_cancel%type;	
 
C01 CURSOR FOR 
	SELECT	nr_sequencia, 
		nm_usuario, 
		cd_estabelecimento 
	from	pls_lote_comissao 
	where	(dt_geracao IS NOT NULL AND dt_geracao::text <> '');
	
C02 CURSOR FOR 
	SELECT	nr_sequencia, 
		nr_seq_canal_venda 
	from	pls_comissao 
	where	nr_seq_lote = nr_seq_lote_w;
	
C03 CURSOR FOR 
	SELECT	b.nr_sequencia, 
		a.nr_sequencia, 
		a.dt_contratacao, 
		a.dt_inclusao_operadora, 
		a.dt_rescisao, 
		a.nr_seq_motivo_cancelamento, 
		b.vl_comissao_benef, 
		a.nr_seq_vendedor_canal, 
		substr(pls_obter_dados_mens_seg(b.nr_seq_segurado_mens,'PB'),1,10) nr_parcela 
	from	pls_comissao_beneficiario	b, 
		pls_segurado			a 
	where	a.nr_sequencia = b.nr_seq_segurado 
	and	b.nr_seq_comissao = nr_seq_comissao_w 
	and	b.vl_comissao_benef > 0 
	and	(dt_rescisao IS NOT NULL AND dt_rescisao::text <> '') 
	and	coalesce(b.dt_estorno::text, '') = '' 
	and	coalesce(b.vl_estorno::text, '') = '';
	

BEGIN 
 
open C01;
loop 
fetch C01 into	 
	nr_seq_lote_w, 
	nm_usuario_w, 
	cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	open C02;
	loop 
	fetch C02 into	 
		nr_seq_comissao_w, 
		nr_seq_canal_venda_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		 
		open C03;
		loop 
		fetch C03 into	 
			nr_seq_comissao_benef_w, 
			nr_seq_segurado_w, 
			dt_contratacao_w, 
			dt_inclusao_operadora_w, 
			dt_rescisao_w, 
			nr_seq_motivo_cancelamento_w, 
			vl_comissao_benef_w, 
			nr_seq_vendedor_w, 
			nr_parcela_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin					 
			 
			select	count(1) 
			into STRICT	qt_utilizacao_plano_w 
			from	pls_conta 
			where	nr_seq_segurado = nr_seq_segurado_w 
			and	ie_status = 'F';
			 
			select	count(1) 
			into STRICT	qt_parcelas_pagas_w 
			from	pls_mensalidade_segurado	b, 
				titulo_receber			a 
			where	a.nr_seq_mensalidade = b.nr_seq_mensalidade 
			and	b.nr_seq_segurado = nr_seq_segurado_w 
			and	b.nr_parcela <= nr_parcela_w	 
			and	a.ie_situacao = '2';	
			 
			select	max(a.nr_sequencia), 
				max(a.nr_seq_motivo_cancel) 
			into STRICT	nr_seq_regra_estorno_w, 
				nr_seq_motivo_cancel_w 
			from	pls_regra_estorno_rescisao	b, 
				pls_regra_estorno_comissao	a 
			where	a.nr_sequencia = b.nr_seq_regra 
			and	((a.nr_seq_vendedor = nr_seq_vendedor_w) or (coalesce(a.nr_seq_vendedor::text, '') = '')) 
			and	((a.ie_data_referencia = 'A' and (dt_rescisao_w - dt_contratacao_w) between a.qt_dias_inicial and a.qt_dias_final) 
			or (a.ie_data_referencia = 'I' and (dt_rescisao_w - dt_inclusao_operadora_w) between a.qt_dias_inicial and a.qt_dias_final) 
			or (a.ie_data_referencia = 'N')) 
			and	qt_parcelas_pagas_w between coalesce(nr_parcela_inicial,qt_parcelas_pagas_w) and coalesce(nr_parcela_final,qt_parcelas_pagas_w) 
			and	((a.ie_utilizacao_plano = 'A') 
			or (a.ie_utilizacao_plano = 'S' and qt_utilizacao_plano_w = 0) 
			or (a.ie_utilizacao_plano = 'C' and qt_utilizacao_plano_w > 0)) 
			and	b.nr_seq_motivo_rescisao = nr_seq_motivo_cancelamento_w;
			 
			if (nr_seq_regra_estorno_w IS NOT NULL AND nr_seq_regra_estorno_w::text <> '') then 
				CALL pls_gerar_estorno_comissao(nr_seq_vendedor_w, nr_seq_comissao_benef_w, nr_seq_segurado_w, vl_comissao_benef_w, null, nr_seq_motivo_cancel_w, 'A', nr_seq_regra_estorno_w, nm_usuario_w, cd_estabelecimento_w);
			end if;
			end;
		end loop;
		close C03;
		end;
	end loop;
	close C02;
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_estorno_automatico () FROM PUBLIC;

