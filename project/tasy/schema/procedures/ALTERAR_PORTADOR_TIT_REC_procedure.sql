-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_portador_tit_rec (nr_titulo_p bigint, cd_tipo_portador_p bigint, cd_portador_p bigint, cd_motivo_p bigint, nr_seq_trans_fin_p bigint, vl_despesa_p bigint, ds_observacao_p text, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		integer;
cd_tipo_portador_ant_w	bigint;
cd_portador_ant_w		bigint;
vl_saldo_titulo_w		double precision;


BEGIN

if (nr_titulo_p IS NOT NULL AND nr_titulo_p::text <> '') and (cd_tipo_portador_p IS NOT NULL AND cd_tipo_portador_p::text <> '') and (cd_portador_p IS NOT NULL AND cd_portador_p::text <> '') then

	select	coalesce(max(nr_sequencia),0) + 1
	into STRICT	nr_sequencia_w
	from	alteracao_portador
	where	nr_titulo	= nr_titulo_p;

	select	cd_tipo_portador,
		cd_portador,
		vl_saldo_titulo
	into STRICT	cd_tipo_portador_ant_w,
		cd_portador_ant_w,
		vl_saldo_titulo_w
	from	titulo_receber
	where	nr_titulo	= nr_titulo_p;

	insert	into	alteracao_portador(nr_titulo,
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_alteracao,
			cd_motivo,
			cd_portador_ant,
			cd_tipo_portador_ant,
			cd_portador,
			cd_tipo_portador,
			vl_despesa,
			nr_lote_contabil,
			ds_observacao,
			nr_seq_trans_fin,
			vl_saldo_titulo)
		values (nr_titulo_p,
			nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			trunc(clock_timestamp(),'dd'),
			cd_motivo_p,
			cd_portador_ant_w,
			cd_tipo_portador_ant_w,
			cd_portador_p,
			cd_tipo_portador_p,
			vl_despesa_p,
			0,
			ds_observacao_p,
			nr_seq_trans_fin_p,
			vl_saldo_titulo_w);

	update	titulo_receber
	set	cd_tipo_portador	= cd_tipo_portador_p,
		cd_portador		= cd_portador_p
	where	nr_titulo		= nr_titulo_p;

	update	cobranca
	set	cd_tipo_portador	= cd_tipo_portador_p,
		cd_portador		= cd_portador_p
	where	nr_titulo		= nr_titulo_p;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_portador_tit_rec (nr_titulo_p bigint, cd_tipo_portador_p bigint, cd_portador_p bigint, cd_motivo_p bigint, nr_seq_trans_fin_p bigint, vl_despesa_p bigint, ds_observacao_p text, nm_usuario_p text) FROM PUBLIC;

