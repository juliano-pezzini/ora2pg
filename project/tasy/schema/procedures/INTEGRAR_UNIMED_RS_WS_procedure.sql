-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE integrar_unimed_rs_ws (nr_seq_evento_p bigint, nr_prescricao_p bigint, nr_sequencia_p bigint, nm_usuario_p text, acao_p text) AS $body$
DECLARE


ds_sep_bv_w		varchar(100);
ds_param_integr_w	varchar(4000);
ds_log_w		varchar(2000);
ie_existe_registro_w	smallint;
ds_regra_w		cliente_integracao.ds_regra%type;


BEGIN
	begin
		select 	ds_regra
		into STRICT	ds_regra_w
		from 	cliente_integracao
		where 	nr_seq_inf_integracao = 1404
		and 	ie_situacao = 'A';
	exception
	when others then
		ds_regra_w := null;
	end;

	select 	count(1)
	into STRICT	ie_existe_registro_w
	from 	atend_categoria_convenio a,
			prescr_medica b
	where   a.nr_atendimento = b.nr_atendimento
	and		Obter_Atecaco_Atendimento(b.nr_atendimento) = a.Nr_Seq_Interno
	and 	b.nr_prescricao = nr_prescricao_p
	and (coalesce(ds_regra_w::text, '') = '' or 'S' = obter_se_valor_contido(a.cd_convenio, ds_regra_w));

	if (ie_existe_registro_w > 0) then

		ds_sep_bv_w       := ';';
		ds_param_integr_w	:= '';

		ds_param_integr_w	:= 'ACAO_P=' || acao_p || ds_sep_bv_w || 'NR_PRESCRICAO_P=' || to_char(nr_prescricao_p) || ds_sep_bv_w || 'NR_SEQUENCIA_P=' || to_char(nr_sequencia_p) || ds_sep_bv_w;
		ds_log_w          := 'Tasy -> Unimed RS - ACAO_P:' || acao_p || ' - NR_PRESCRICAO_P:' || to_char(nr_prescricao_p) || ' - NR_SEQUENCIA_P:' || to_char(nr_sequencia_p);

		CALL gravar_log_lab(nr_seq_evento_p, ds_log_w, nm_usuario_p);
		CALL gravar_agend_integracao(nr_seq_evento_p, ds_param_integr_w);

	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE integrar_unimed_rs_ws (nr_seq_evento_p bigint, nr_prescricao_p bigint, nr_sequencia_p bigint, nm_usuario_p text, acao_p text) FROM PUBLIC;

