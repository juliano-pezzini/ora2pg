-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_import_extrato_bolivia ( nr_seq_extrato_p BANCO_EXTRATO.NR_SEQUENCIA%type ) AS $body$
DECLARE


dt_current_s			CONSTANT timestamp				:= clock_timestamp();
nm_usuario_s			BANCO_EXTRATO_LANC.NM_USUARIO%type	:= WHEB_USUARIO_PCK.GET_NM_USUARIO;
nr_seq_conta_w 			BANCO_EXTRATO.NR_SEQ_CONTA%type;

c01 CURSOR(nr_seq_conta_ww BANCO_EXTRATO.NR_SEQ_CONTA%type) FOR
	SELECT * FROM (
		SELECT	REPLACE(SUBSTR(OBTER_VALOR_CAMPO_SEPARADOR(a.DS_CONTEUDO,1,';'),1,10),'"','')								DT_LANCAMENTO,
		        SOMENTE_NUMERO(SUBSTR(OBTER_VALOR_CAMPO_SEPARADOR(a.DS_CONTEUDO,2,';'),1,15)) / 100							VL_LANCAMENTO,
		        REPLACE(SUBSTR(OBTER_VALOR_CAMPO_SEPARADOR(a.DS_CONTEUDO,3,';'),1,255),'"','')								NR_DOCUMENTO,
		        ELIMINA_CARACTERES_ESPECIAIS_D(RTRIM(REPLACE(SUBSTR(OBTER_VALOR_CAMPO_SEPARADOR(a.DS_CONTEUDO,4,';'),1,255),'"','')), '()=!/:,-.')	DS_HISTORICO,
		        SUBSTR(OBTER_VALOR_CAMPO_SEPARADOR(a.DS_CONTEUDO,5,';'),1)																			IE_DEB_CRED
		FROM	W_INTERF_CONCIL a
		WHERE	a.NR_SEQ_CONTA = nr_seq_conta_ww
	) alias17 WHERE NOT REGEXP_LIKE(DT_LANCAMENTO, '^[a-zA-Z]');

BEGIN

SELECT 	MAX(a.NR_SEQ_CONTA)
INTO STRICT 	nr_seq_conta_w
FROM 	BANCO_EXTRATO a
WHERE 	a.NR_SEQUENCIA = nr_seq_extrato_p;

FOR extrato IN c01(nr_seq_conta_w) LOOP
	INSERT INTO BANCO_EXTRATO_LANC(
		DS_HISTORICO,
		DT_ATUALIZACAO,
		DT_ATUALIZACAO_NREC,
		DT_MOVIMENTO,
		IE_CONCILIACAO,
		IE_DEB_CRED,
		NM_USUARIO,
		NM_USUARIO_NREC,
		NR_SEQ_EXTRATO,
		NR_SEQUENCIA,
		VL_LANCAMENTO,
		NR_DOCUMENTO
	) VALUES (
		extrato.DS_HISTORICO,
		dt_current_s,
		dt_current_s,
		TO_DATE(extrato.DT_LANCAMENTO,'DD/MM/YYYY'),
		'N',
		extrato.IE_DEB_CRED,
		nm_usuario_s,
		nm_usuario_s,
		nr_seq_extrato_p,
		nextval('banco_extrato_lanc_seq'),
		extrato.VL_LANCAMENTO,
		extrato.NR_DOCUMENTO
	);
END LOOP;

DELETE	FROM W_INTERF_CONCIL
WHERE   NR_SEQ_CONTA = nr_seq_conta_w
AND 	NM_USUARIO   = nm_usuario_s;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_import_extrato_bolivia ( nr_seq_extrato_p BANCO_EXTRATO.NR_SEQUENCIA%type ) FROM PUBLIC;

