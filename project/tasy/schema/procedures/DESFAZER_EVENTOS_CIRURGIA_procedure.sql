-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_eventos_cirurgia ( nr_seq_evento_p bigint, nr_cirurgia_p bigint, nm_usuario_p text, nr_seq_pepo_p bigint) AS $body$
DECLARE

				

ie_atual_Inicio_cirurgia_w	varchar(1);
ie_atual_fim_cirurgia_w		varchar(1);
ie_inicia_cirurgia_w		varchar(1);
ie_finaliza_cirurgia_w		varchar(1);
cd_estabelecimento_w		smallint;
dt_entrada_unidade_w		timestamp;
nr_atendimento_w		bigint;
nr_cirurgia_w			bigint;
ie_ExcluirItensLancAuto_w	varchar(1);
ie_status_cirurgia_w		smallint;

C01 CURSOR FOR
SELECT	cd_estabelecimento,
	dt_entrada_unidade,
	nr_atendimento,
	nr_cirurgia
from	cirurgia
where	((nr_cirurgia	= nr_cirurgia_p AND nr_cirurgia_p IS NOT NULL AND nr_cirurgia_p::text <> '') or (nr_seq_pepo = nr_seq_pepo_p AND nr_seq_pepo_p IS NOT NULL AND nr_seq_pepo_p::text <> ''));


BEGIN

ie_atual_inicio_cirurgia_w := obter_param_usuario(872, 85, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_atual_inicio_cirurgia_w);
ie_atual_fim_cirurgia_w := obter_param_usuario(872, 86, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_atual_fim_cirurgia_w);
ie_ExcluirItensLancAuto_w := obter_param_usuario(872, 225, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_ExcluirItensLancAuto_w);

select 	max(ie_status_cirurgia)
into STRICT	ie_status_cirurgia_w
from	cirurgia
where	nr_cirurgia	=	nr_cirurgia_w;

if (ie_status_cirurgia_w = 3) then
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(244238);
end if;

Open C01;
Loop
	Fetch C01 into	cd_estabelecimento_w,
			dt_entrada_unidade_w,
			nr_atendimento_w,
			nr_cirurgia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */

	if (ie_atual_Inicio_cirurgia_w = 'S') then

		select	coalesce(max(ie_inicia_cirurgia),'N')
		into STRICT	ie_inicia_cirurgia_w
		from	evento_cirurgia
		where	nr_sequencia = nr_seq_evento_p;
	
		if (ie_inicia_cirurgia_w = 'S') then
		
			update	cirurgia
			set	ie_status_cirurgia	= 1,
				dt_entrada_unidade	 = NULL,
				dt_inicio_real	 = NULL,
				dt_termino	 = NULL,
				cd_tipo_cirurgia	 = NULL,
				ie_anat_patol	 = NULL,
				ie_trauma		 = NULL,
				ie_ortese_protese	 = NULL,
				ie_sangue	 = NULL,
				ie_antibiotico	 = NULL,
            nm_usuario_antibiotico  = NULL,
				ds_antibiotico	 = NULL,
				nr_min_duracao_real	 = NULL
			where	nr_cirurgia	= nr_cirurgia_w;

			if (dt_entrada_unidade_w IS NOT NULL AND dt_entrada_unidade_w::text <> '') and (nr_atendimento_w > 0) then
				delete	FROM atend_paciente_unidade
				where	nr_atendimento	= nr_atendimento_w
				and	dt_entrada_unidade	= dt_entrada_unidade_w;
			end if;
			commit;
			
			if (coalesce(ie_ExcluirItensLancAuto_w,'N') = 'S') then
				CALL excluir_item_conta_rla_cirurg(nr_atendimento_w, nr_cirurgia_p, cd_estabelecimento_w, nm_usuario_p);
			end if;

		end if;
	
	end if;	
		
	if (ie_atual_fim_cirurgia_w = 'S') then

		select	coalesce(max(ie_finaliza_cirurgia),'N')
		into STRICT	ie_finaliza_cirurgia_w
		from	evento_cirurgia
		where	nr_sequencia = nr_seq_evento_p;

		if (ie_finaliza_cirurgia_w = 'S') then
			update	cirurgia
			set	dt_termino	 = NULL,
				cd_tipo_cirurgia	 = NULL,
				ie_anat_patol	 = NULL,
				ie_trauma		 = NULL,
				ie_ortese_protese	 = NULL,
				ie_sangue	 = NULL,
				ie_antibiotico	 = NULL,
            nm_usuario_antibiotico  = NULL,
				ds_antibiotico	 = NULL,
				nr_min_duracao_real	 = NULL
			where	nr_cirurgia	= nr_cirurgia_w;

			if (dt_entrada_unidade_w IS NOT NULL AND dt_entrada_unidade_w::text <> '') and (nr_atendimento_w > 0) then
				update	atend_paciente_unidade
				set	dt_saida_unidade	 = NULL
				where	nr_atendimento	= nr_atendimento_w
				and	dt_entrada_unidade	= dt_entrada_unidade_w;
			end if;
			commit;
		end if;
	end if;

end loop;
Close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_eventos_cirurgia ( nr_seq_evento_p bigint, nr_cirurgia_p bigint, nm_usuario_p text, nr_seq_pepo_p bigint) FROM PUBLIC;

