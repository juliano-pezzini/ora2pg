-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_auditor_atual_analise ( nr_seq_analise_p bigint, nr_Seq_grupo_atual_p bigint, ie_campo_verificacao_p text, nm_usuario_p text, nm_auditor_atual_p INOUT text) AS $body$
DECLARE


/*OS - 476095 - jjung / a  partir desta OS,  novos atributos que serão verificados para permitir ações dos auditores devem ser verificados através deste parâmetro, para que não haja impacto em outras funcionalidades.

ie_campo_verificacao_p - Indique o campo a ser verificado na PLS_MEMBRO_GRUPO_AUD para o retorno do nome.

'EG' - ie_encaminhar_grupo
'AT' - ie_grupo_acesso_total
*/
nm_auditor_atual_w	varchar(100):= '';
nm_auditor_w		varchar(100):= '';


BEGIN
if (coalesce(nr_seq_analise_p,0) > 0) then

	select	max(nm_auditor_atual)
	into STRICT	nm_auditor_atual_w
	from 	pls_auditoria_conta_grupo
	where	nr_seq_analise 	= nr_seq_analise_p
	and	nr_Seq_grupo 	= nr_Seq_grupo_atual_p
	and	nr_seq_ordem	= (	SELECT  min(nr_seq_ordem)
					from 	pls_auditoria_conta_grupo
					where	nr_Seq_analise  = nr_seq_analise_p
					and	nr_Seq_grupo 	= nr_Seq_grupo_atual_p
					and	coalesce(ie_pre_analise,'N') = 'N'
					and	coalesce(dt_liberacao::text, '') = '');

	if (ie_campo_verificacao_p = 'EG') then
		if (coalesce(nm_auditor_atual_w,'0') <> '0') then
			begin
				select	max(nm_usuario_exec)
				into STRICT	nm_auditor_w
				from	pls_membro_grupo_aud
				where	nm_usuario_exec = nm_auditor_atual_w
				and	coalesce(ie_encaminhar_grupo,'S') = 'S'
				and	nr_Seq_grupo 	= nr_Seq_grupo_atual_p;
			exception
			when others then
				nm_auditor_w := '';
			end;
		end if;



	elsif (ie_campo_verificacao_p = 'AT') then
		if (coalesce(nm_auditor_atual_w,'0') <> '0') then
			begin
				select	max(nm_usuario_exec)
				into STRICT	nm_auditor_w
				from	pls_membro_grupo_aud
				where	nm_usuario_exec = nm_auditor_atual_w
				and	coalesce(ie_grupo_acesso_total,'S') = 'S'
				and	nr_Seq_grupo 	= nr_Seq_grupo_atual_p;
			exception
			when others then
				nm_auditor_w := '';
			end;
		else
			nm_auditor_w	:= nm_usuario_p;
		end if;


	end if;
end if;

nm_auditor_atual_p := nm_auditor_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_auditor_atual_analise ( nr_seq_analise_p bigint, nr_Seq_grupo_atual_p bigint, ie_campo_verificacao_p text, nm_usuario_p text, nm_auditor_atual_p INOUT text) FROM PUBLIC;

