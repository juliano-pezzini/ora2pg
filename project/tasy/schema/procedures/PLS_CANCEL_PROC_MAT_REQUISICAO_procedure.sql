-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_cancel_proc_mat_requisicao ( nr_seq_proc_mat_p bigint, ie_tipo_cancel_p text, nr_seq_motivo_cancel_p bigint, ds_observacao_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
cd_procedimento_w		procedimento.cd_procedimento%type;
nr_seq_requisicao_w		pls_requisicao.nr_sequencia%type;
nr_seq_material_w		pls_material.nr_sequencia%type;
nr_seq_auditoria_w		pls_auditoria.nr_sequencia%type;
ds_motivo_cancel_w		varchar(255);
qt_reg_proc_w			bigint	:= 0;
qt_reg_mat_w			bigint	:= 0;
qt_reg_mat_aud_w		bigint	:= 0;
qt_reg_proc_aud_w		bigint	:= 0;
qt_reg_aud_w			bigint	:= 0;
ds_estagio_w			varchar(255);


BEGIN 
 
begin 
select	substr(ds_motivo_cancelamento,1,255) 
into STRICT	ds_motivo_cancel_w 
from	pls_guia_motivo_cancel 
where	ie_situacao 		= 'A' 
and	cd_estabelecimento 	= cd_estabelecimento_p 
and	nr_sequencia		= nr_seq_motivo_cancel_p;
exception 
when others then 
	ds_motivo_cancel_w	:= '';
end;
 
if (ie_tipo_cancel_p	= 'P') then 
	select	cd_procedimento, 
		nr_seq_requisicao 
	into STRICT	cd_procedimento_w, 
		nr_seq_requisicao_w 
	from	pls_requisicao_proc 
	where	nr_sequencia	= nr_seq_proc_mat_p;
	 
	begin 
		select	substr(obter_valor_dominio(3431, ie_estagio),1,255) 
		into STRICT	ds_estagio_w 
		from	pls_requisicao 
		where	nr_sequencia	= nr_seq_requisicao_w;
	exception 
	when others then 
		ds_estagio_w	:= '';
	end;
	 
	update	pls_requisicao_proc 
	set	ie_status	= 'C', 
		ie_estagio	= 'N', 
		dt_atualizacao	= clock_timestamp(), 
		nm_usuario	= nm_usuario_p 
	where	nr_sequencia	= nr_seq_proc_mat_p;
	 
	CALL pls_requisicao_gravar_hist(	nr_seq_requisicao_w, 'L', 
					substr('Procedimento '||cd_procedimento_w||' cancelado em '||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||' pelo usuário '|| 
					nm_usuario_p||'.'||chr(13)||'Motivo: '||ds_motivo_cancel_w||'.'||chr(13)||'Estágio anterior da requisição: '||ds_estagio_w 
					||chr(13)||'Observação: '||ds_observacao_p,1,4000), 
					'',nm_usuario_p);
 
	select	count(1) 
	into STRICT	qt_reg_proc_aud_w 
	from	pls_auditoria		b, 
		pls_auditoria_item	a 
	where	a.nr_seq_proc_origem	= nr_seq_proc_mat_p 
	and	a.nr_seq_auditoria	= b.nr_sequencia 
	and	coalesce(b.dt_liberacao::text, '') = '';
	 
	if (qt_reg_proc_aud_w	> 0) then 
		update	pls_auditoria_item 
		set	ie_status		= 'C', 
			ie_status_solicitacao	= 'C', 
			dt_atualizacao		= clock_timestamp(), 
			nm_usuario		= nm_usuario_p 
		where	nr_seq_proc_origem	= nr_seq_proc_mat_p;
	end if;
elsif (ie_tipo_cancel_p		= 'M') then 
	select	nr_seq_material, 
		nr_seq_requisicao 
	into STRICT	nr_seq_material_w, 
		nr_seq_requisicao_w 
	from	pls_requisicao_mat 
	where	nr_sequencia	= nr_seq_proc_mat_p;
	 
	begin 
		select	substr(obter_valor_dominio(3431, ie_estagio),1,255) 
		into STRICT	ds_estagio_w 
		from	pls_requisicao 
		where	nr_sequencia	= nr_seq_requisicao_w;
	exception 
	when others then 
		ds_estagio_w	:= '';
	end;
	 
	update	pls_requisicao_mat 
	set	ie_status	= 'C', 
		ie_estagio	= 'N', 
		dt_atualizacao	= clock_timestamp(), 
		nm_usuario	= nm_usuario_p 
	where	nr_sequencia	= nr_seq_proc_mat_p;
	 
	CALL pls_requisicao_gravar_hist(	nr_seq_requisicao_w, 'L', 
					substr('Material '||nr_seq_material_w||' cancelado em '||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||' pelo usuário '|| 
					nm_usuario_p||'.'||chr(13)||'Motivo: '||ds_motivo_cancel_w||'.'||chr(13)||'Estágio anterior da requisição: '||ds_estagio_w 
					||chr(13)||'Observação: '||ds_observacao_p,1,4000), 
					'',nm_usuario_p);
 
	select	count(1) 
	into STRICT	qt_reg_mat_aud_w 
	from	pls_auditoria		b, 
		pls_auditoria_item	a 
	where	a.nr_seq_mat_origem	= nr_seq_proc_mat_p 
	and	a.nr_seq_auditoria	= b.nr_sequencia 
	and	coalesce(b.dt_liberacao::text, '') = '';
	 
	if (qt_reg_mat_aud_w	> 0) then 
		update	pls_auditoria_item 
		set	ie_status		= 'C', 
			ie_status_solicitacao	= 'C', 
			dt_atualizacao		= clock_timestamp(), 
			nm_usuario		= nm_usuario_p 
		where	nr_seq_mat_origem	= nr_seq_proc_mat_p;
	end if;
end if;
 
begin 
	select	nr_sequencia 
	into STRICT	nr_seq_auditoria_w 
	from	pls_auditoria 
	where	nr_seq_requisicao	= nr_seq_requisicao_w 
	and	ie_status		not in ('F', 'C');
exception 
when others then 
	nr_seq_auditoria_w	:= null;
end;
 
if (nr_seq_auditoria_w IS NOT NULL AND nr_seq_auditoria_w::text <> '') then	 
	select 	sum(qt_itens) 
	into STRICT	qt_reg_aud_w 
	from (	SELECT	count(1) qt_itens	 
			from	pls_requisicao_proc 
			where	nr_seq_requisicao 	= nr_seq_requisicao_w 
			and	ie_status		= 'A' 
			
union 	all
 
			PERFORM	count(1) qt_itens 
			from	pls_requisicao_mat 
			where	nr_seq_requisicao	= nr_seq_requisicao_w 
			and	ie_status		= 'A') alias4;
 
	if (qt_reg_aud_w	= 0) then 
		update	pls_auditoria_item 
		set	ie_status		= 'C', 
			dt_atualizacao		= clock_timestamp(), 
			nm_usuario		= nm_usuario_p 
		where	nr_seq_auditoria	= nr_seq_auditoria_w;
				 
		update	pls_auditoria 
		set	ie_status		= 'C', 
			dt_liberacao		= clock_timestamp(), 
			nr_seq_proc_interno	 = NULL, 
			dt_atualizacao		= clock_timestamp(), 
			nm_usuario		= nm_usuario_p 
		where	nr_sequencia		= nr_seq_auditoria_w;
		 
		CALL pls_atualiza_estagio_req(nr_seq_requisicao_w, nm_usuario_p);
	end if;
end if;
 
select	count(1) 
into STRICT	qt_reg_proc_w 
from	pls_requisicao_proc 
where	nr_seq_requisicao	= nr_seq_requisicao_w 
and	ie_status		<> 'C';
 
select	count(1) 
into STRICT	qt_reg_mat_w 
from	pls_requisicao_mat 
where	nr_seq_requisicao	= nr_seq_requisicao_w 
and	ie_status		<> 'C';
 
if	((qt_reg_proc_w + qt_reg_mat_w)	= 0) then 
	update	pls_requisicao 
	set	ie_status		= 'C', 
		ie_estagio		= 3, 
		nr_seq_motivo_cancel  = nr_seq_motivo_cancel_p, 
		dt_atualizacao		= clock_timestamp(), 
		nm_usuario		= nm_usuario_p, 
		dt_fim_processo_req	= clock_timestamp() 
	where	nr_sequencia		= nr_seq_requisicao_w;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cancel_proc_mat_requisicao ( nr_seq_proc_mat_p bigint, ie_tipo_cancel_p text, nr_seq_motivo_cancel_p bigint, ds_observacao_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

