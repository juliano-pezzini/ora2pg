-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gedipa_separar_processo ( cd_estabelecimento_p bigint, cd_perfil_p bigint, nr_processo_p bigint, nr_seq_area_p bigint, ie_separar_p text, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w			bigint;
ie_adep_map_w			varchar(15);
nr_seq_map_w			bigint;
nr_seq_area_w			bigint;
ie_higienizacao_w		varchar(1);
ie_preparo_w			varchar(1);
dt_higienizacao_w		timestamp;
nm_usuario_higieniz_w	varchar(15);
dt_preparo_w			timestamp;
nm_usuario_preparo_w	varchar(15);
nm_usuario_leitura_w	varchar(15);
nr_seq_ordem_w			bigint;
cd_setor_atendimento_w	integer;
cd_intervalo_w			varchar(7);
nr_seq_regra_w			bigint;
ie_conferencia_w		varchar(1);
ie_dispensacao_w		varchar(1);
ie_acm_w				varchar(1);
ie_se_necessario_w		varchar(1);
qt_tempo_min_w			bigint;
ie_dose_especial_w		varchar(1);
ie_possui_producao_w	varchar(1);
ie_possui_producao_area_w	varchar(1);
ie_higienizacao_ww		varchar(1);
ie_preparo_ww			varchar(1);
ie_conferencia_ww		varchar(1);
dt_leitura_w			timestamp;
ie_ordens_nao_prep_area_w	varchar(1);
ie_tipo_processo_w		varchar(15);
nr_prescricao_w			bigint;
nr_seq_material_w		integer;
nr_seq_kit_w			integer;
nr_seq_horario_w		bigint;
cd_material_w			integer;
cd_material_ww			integer;
dt_horario_w			timestamp;
nr_atendimento_w		bigint;
cd_setor_paciente_w		integer;
ie_lanca_conta_adep_w	varchar(1);
nr_seq_item_w			bigint;
ie_momento_lancamento_w	varchar(10);
dt_dispensacao_w		timestamp;

c01 CURSOR FOR
	SELECT	a.nr_sequencia
	from	prescr_mat_hor b,
			adep_processo_frac a
	where	b.nr_seq_etiqueta = a.nr_sequencia
	and		b.nr_seq_area_prep = nr_seq_area_w
	and		a.nr_seq_processo = nr_processo_p
	and		obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S';

c02 CURSOR FOR
	SELECT	nr_sequencia
	from	regra_etapa_gedipa
	where	coalesce(cd_setor_atendimento,coalesce(cd_setor_atendimento_w,0)) = coalesce(cd_setor_atendimento_w,0)
	and		coalesce(cd_intervalo,coalesce(cd_intervalo_w,'0'))		= coalesce(cd_intervalo_w,'0')
	and		coalesce(ie_acm,coalesce(ie_acm_w,'N'))				= coalesce(ie_acm_w,'N')
	and		coalesce(ie_se_necessario,coalesce(ie_se_necessario_w,'N'))	= coalesce(ie_se_necessario_w,'N')
	and		coalesce(qt_tempo_min_w,0) between coalesce(qt_tempo_min,-99999) and coalesce(qt_tempo_max,99999)
	and		coalesce(ie_dose_especial,coalesce(ie_dose_especial_w,'N'))	= coalesce(ie_dose_especial_w,'N')
	and		ie_situacao = 'A'
	and		(((coalesce(ie_hemodialise,'S') = 'S') and (ie_tipo_processo_w = 'H')) or
			((coalesce(ie_hemodialise,'N') = 'N') and (ie_tipo_processo_w <> 'H')))
	order by
		coalesce(cd_setor_atendimento,000000),
		coalesce(cd_intervalo,'AAAAAAA'),
		coalesce(ie_acm,'AAAAAAA'),
		coalesce(ie_se_necessario,'AAAAAAA'),
		coalesce(qt_tempo_min,000000);

c03 CURSOR FOR
	SELECT	a.nr_atendimento,
			b.nr_sequencia,
			b.cd_material,
			x.nr_seq_kit,
			x.nr_prescricao
	from	adep_processo_item b,
			adep_processo a,
			prescr_mat_hor c,
			prescr_material x
	where	b.nr_seq_processo	= a.nr_sequencia
	and		b.nr_seq_horario 	= c.nr_sequencia
	and		c.nr_prescricao 	= x.nr_prescricao
	and		c.nr_seq_material 	= x.nr_sequencia
	and		a.nr_sequencia		= nr_processo_p
	and		coalesce(b.ie_lanca_conta_adep::text, '') = ''
	and		ie_momento_lancamento_w = 'CR'
	and		coalesce(b.ie_nao_requisitado,'N') <> 'S'
	and		((coalesce(nr_seq_area_p,0) = 0) or (b.nr_seq_area_prep = nr_seq_area_p))
	order by
		coalesce(b.nr_seq_horario,999999999);


BEGIN

ie_momento_lancamento_w := obter_param_usuario(1113, 97, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_momento_lancamento_w);

ie_adep_map_w	:= obter_regra_lanc_conta_adep(cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, 'SP');

select	coalesce(max('S'),'N')
into STRICT	ie_possui_producao_w
from	lp_individual
where	nr_seq_processo		=	nr_processo_p;

select	coalesce(max('S'),'N')
into STRICT	ie_possui_producao_area_w
from	lp_individual
where	nr_seq_processo		=	nr_processo_p
and	nr_seq_area_prep	=	nr_seq_area_p;

if (obter_rastreabilidade_adep(nr_processo_p, 'CH') = 'S') then
	CALL adep_gerar_log_rastr('{'||chr(10)||
						'"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
						'"cd_estabelecimento_p" : "'||cd_estabelecimento_p||'",'||chr(10)||
						'"cd_perfil_p" : "'||cd_perfil_p||'",'||chr(10)||
						'"ie_separar_p" : "'||ie_separar_p||'",'||chr(10)||
						'"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
						'"nr_processo_p" : "'||nr_processo_p||'",'||chr(10)||
						'"nr_seq_area_p" : "'||nr_seq_area_p||'",'||chr(10)||
						'"ie_momento_lancamento_w" : "'||ie_momento_lancamento_w||'",'||chr(10)||
						'"ie_adep_map_w" : "'||ie_adep_map_w||'",'||chr(10)||
						'"ie_possui_producao_w" : "'||ie_possui_producao_w||'",'||chr(10)||
						'"ie_possui_producao_area_w" : "'||ie_possui_producao_area_w||'"}'
						, wheb_usuario_pck.get_ie_commit);
end if;

if (nr_processo_p IS NOT NULL AND nr_processo_p::text <> '') and (ie_separar_p IS NOT NULL AND ie_separar_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then

	if (nr_seq_area_p IS NOT NULL AND nr_seq_area_p::text <> '') and (nr_seq_area_p > 0) then
		nr_seq_area_w	:= nr_seq_area_p;
	else
		nr_seq_area_w	:= null;
	end if;

	if (ie_separar_p = 'S') then
		if (nr_seq_area_w IS NOT NULL AND nr_seq_area_w::text <> '') then

			select	cd_setor_atendimento,
					cd_intervalo,
					ie_acm,
					ie_se_necessario,
					trunc((dt_horario_processo - dt_processo) * 1440),
					ie_dose_especial,
					coalesce(ie_tipo_processo,'X')
			into STRICT	cd_setor_atendimento_w,
					cd_intervalo_w,
					ie_acm_w,
					ie_se_necessario_w,
					qt_tempo_min_w,
					ie_dose_especial_w,
					ie_tipo_processo_w
			from	adep_processo
			where	nr_sequencia	=	nr_processo_p;

			if (obter_rastreabilidade_adep(nr_processo_p, 'CH') = 'S') then
				CALL adep_gerar_log_rastr('{'||chr(10)||
									'"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
									'"cd_intervalo_w" : "'||cd_intervalo_w||'",'||chr(10)||
									'"cd_setor_atendimento_w" : "'||cd_setor_atendimento_w||'",'||chr(10)||
									'"ie_acm_w" : "'||ie_acm_w||'",'||chr(10)||
									'"ie_dose_especial_w" : "'||ie_dose_especial_w||'",'||chr(10)||
									'"ie_se_necessario_w" : "'||ie_se_necessario_w||'",'||chr(10)||
									'"ie_tipo_processo_w" : "'||ie_tipo_processo_w||'",'||chr(10)||
									'"nr_processo_p" : "'||nr_processo_p||'",'||chr(10)||
									'"qt_tempo_min_w" : "'||qt_tempo_min_w||'"}'
									, wheb_usuario_pck.get_ie_commit);
			end if;

			open c02;
			loop
			fetch c02 into
				nr_seq_regra_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				begin
					nr_seq_regra_w := nr_seq_regra_w;
				end;
			end loop;
			close c02;

			select	nextval('adep_processo_area_seq')
			into STRICT	nr_sequencia_w
			;

			select	coalesce(ie_higienizacao,'S'),
					coalesce(ie_preparo,'S'),
					coalesce(ie_conferencia,'S'),
					coalesce(ie_dispensacao,'S')
			into STRICT	ie_higienizacao_w,
					ie_preparo_w,
					ie_conferencia_w,
					ie_dispensacao_w
			from	adep_area_prep
			where	nr_sequencia	= nr_seq_area_w;

			if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then
				select	coalesce(ie_higienizacao,'S'),
						coalesce(ie_preparo,'S'),
						coalesce(ie_conferencia,'S')
				into STRICT	ie_higienizacao_w,
						ie_preparo_w,
						ie_conferencia_w
				from	regra_etapa_gedipa
				where	nr_sequencia	= nr_seq_regra_w;
			end if;						
			
			select	coalesce(ie_higienizacao,'S'),
					coalesce(ie_preparo,'S'),
					coalesce(ie_conferencia,'S')
			into STRICT	ie_higienizacao_ww,
					ie_preparo_ww,
					ie_conferencia_ww
			from	adep_processo
			where	nr_sequencia	= nr_processo_p;
			
			select 	coalesce(max(ie_higienizacao),ie_higienizacao_ww),
					coalesce(max(ie_preparo),ie_preparo_ww),
					coalesce(max(ie_conferencia),ie_conferencia_ww)
			into STRICT   	ie_higienizacao_ww,
					ie_preparo_ww,
					ie_conferencia_ww
			from   	gedipa_intervencao_preparo
			where  	nr_seq_processo = nr_processo_p
			and    	nr_seq_area_prep = nr_seq_area_p;

			if (obter_rastreabilidade_adep(nr_processo_p, 'CH') = 'S') then
				CALL adep_gerar_log_rastr('{'||chr(10)||
									'"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
									'"nr_processo_p" : "'||nr_processo_p||'",'||chr(10)||
									'"ie_conferencia_w" : "'||ie_conferencia_w||'",'||chr(10)||
									'"ie_conferencia_ww" : "'||ie_conferencia_ww||'",'||chr(10)||
									'"ie_dispensacao_w" : "'||ie_dispensacao_w||'",'||chr(10)||
									'"ie_higienizacao_w" : "'||ie_higienizacao_w||'",'||chr(10)||
									'"ie_higienizacao_ww" : "'||ie_higienizacao_ww||'",'||chr(10)||
									'"ie_preparo_w" : "'||ie_preparo_w||'",'||chr(10)||
									'"ie_preparo_ww" : "'||ie_preparo_ww||'",'||chr(10)||
									'"nr_seq_area_w" : "'||nr_seq_area_w||'",'||chr(10)||
									'"nr_seq_regra_w" : "'||nr_seq_regra_w||'",'||chr(10)||
									'"ie_momento_lancamento_w" : "'||ie_momento_lancamento_w||'",'||chr(10)||
									'"nr_sequencia_w" : "'||nr_sequencia_w||'"}'
									, wheb_usuario_pck.get_ie_commit);
			end if;

			open C03;
			loop
			fetch C03 into	
				nr_atendimento_w,
				nr_seq_item_w,
				cd_material_ww,
				nr_seq_kit_w,
				nr_prescricao_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */		

				if (nr_seq_kit_w > 0) then
					select	max(cd_material)
					into STRICT	cd_material_ww
					from	prescr_mat_hor
					where	nr_prescricao = nr_prescricao_w
					and	nr_seq_material = nr_seq_kit_w
					and	nr_seq_processo = nr_processo_p;
				end if;
			
				select	coalesce(obter_se_mat_regra_adep(nr_atendimento_w,null,cd_material_ww,cd_setor_paciente_w,'CB'),'S')
				into STRICT	ie_lanca_conta_adep_w
				;				
				
				update	adep_processo_item
				set		ie_lanca_conta_adep = ie_lanca_conta_adep_w
				where	nr_sequencia = nr_seq_item_w;				
			end loop;
			close C03;
			
			if (ie_higienizacao_ww = 'N') or (ie_preparo_ww = 'N') or (ie_conferencia_ww = 'N') then
				if (ie_higienizacao_ww = 'N') then
					begin
						dt_higienizacao_w		:= clock_timestamp();
						nm_usuario_higieniz_w	:= nm_usuario_p;
					end;
				else
					begin
						dt_higienizacao_w		:= null;
						nm_usuario_higieniz_w	:= null;
					end;
				end if;

				if (ie_preparo_ww = 'N') and (ie_higienizacao_ww = 'N' or (dt_higienizacao_w IS NOT NULL AND dt_higienizacao_w::text <> '')) then				
					begin
						dt_preparo_w 			:= clock_timestamp();
						nm_usuario_preparo_w	:= nm_usuario_p;
					end;
				else
					begin
						dt_preparo_w			:= null;
						nm_usuario_preparo_w	:= null;
					end;
				end if;
				
				ie_higienizacao_w	:= ie_higienizacao_ww;
				ie_preparo_w		:= ie_preparo_ww;
				ie_conferencia_w	:= ie_conferencia_ww;				
			else
				if (ie_higienizacao_w = 'N') then
					begin
						dt_higienizacao_w 		:= clock_timestamp();
						nm_usuario_higieniz_w 	:= nm_usuario_p;
					end;
				else
					begin
						dt_higienizacao_w 		:= null;
						nm_usuario_higieniz_w	:= null;
					end;
				end if;

				if (ie_preparo_w = 'N') and (ie_higienizacao_w = 'N' or (dt_higienizacao_w IS NOT NULL AND dt_higienizacao_w::text <> '')) then
					begin
						dt_preparo_w 			:= clock_timestamp();
						nm_usuario_preparo_w	:= nm_usuario_p;
					end;
				else
					begin
						dt_preparo_w 			:= null;
						nm_usuario_preparo_w	:= null;
					end;
				end if;
			end if;
			
			insert into adep_processo_area(
				nr_sequencia,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				dt_atualizacao,
				nm_usuario,
				nr_seq_processo,
				nr_seq_area_prep,
				dt_higienizacao,
				nm_usuario_higienizacao,
				dt_dispensacao,
				nm_usuario_dispensacao,
				dt_preparo,
				nm_usuario_preparo)
			values (
				nr_sequencia_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_processo_p,
				nr_seq_area_w,
				dt_higienizacao_w,
				nm_usuario_higieniz_w,
				clock_timestamp(),
				nm_usuario_p,
				dt_preparo_w,
				nm_usuario_preparo_w);

			if (obter_rastreabilidade_adep(nr_processo_p, 'CH') = 'S') then
				CALL adep_gerar_log_rastr('{'||chr(10)||
									'"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
									'"nr_processo_p" : "'||nr_processo_p||'",'||chr(10)||
									'"ie_conferencia_ww" : "'||ie_conferencia_ww||'",'||chr(10)||
									'"ie_higienizacao_ww" : "'||ie_higienizacao_ww||'",'||chr(10)||
									'"ie_preparo_ww" : "'||ie_preparo_ww||'",'||chr(10)||
									'"dt_higienizacao_w" : "'||to_char(dt_higienizacao_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
									'"dt_preparo_w" : "'||to_char(dt_preparo_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
									'"ie_conferencia_w" : "'||ie_conferencia_w||'",'||chr(10)||
									'"ie_higienizacao_w" : "'||ie_higienizacao_w||'",'||chr(10)||
									'"ie_preparo_w" : "'||ie_preparo_w||'",'||chr(10)||
									'"nm_usuario_higieniz_w" : "'||nm_usuario_higieniz_w||'",'||chr(10)||
									'"nm_usuario_preparo_w" : "'||nm_usuario_preparo_w||'",'||chr(10)||
									'"nr_seq_area_w" : "'||nr_seq_area_w||'",'||chr(10)||
									'"nr_sequencia_w" : "'||nr_sequencia_w||'"}'
									, wheb_usuario_pck.get_ie_commit);
			end if;

			if	((ie_preparo_w = 'N' or ie_preparo_ww = 'N') and (ie_higienizacao_ww = 'N' or (dt_higienizacao_w IS NOT NULL AND dt_higienizacao_w::text <> ''))) and (coalesce(ie_possui_producao_area_w,'N') = 'N') then

				if (obter_rastreabilidade_adep(nr_processo_p, 'CH') = 'S') then
					CALL adep_gerar_log_rastr('{'||chr(10)||
										'"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
										'"nr_processo_p" : "'||nr_processo_p||'",'||chr(10)||
										'"nr_seq_area_w" : "'||nr_seq_area_w||'"}'
										, wheb_usuario_pck.get_ie_commit);
				end if;

				open c01;
				loop
				fetch c01 into
					nr_seq_ordem_w;
				EXIT WHEN NOT FOUND; /* apply on c01 */
					begin
						nr_seq_ordem_w := nr_seq_ordem_w;
						CALL pemof_iniciar_finalizar_ordem(nr_seq_ordem_w,nr_seq_area_p,'F',nm_usuario_p);
					end;
				end loop;
				close c01;
			end if;			

			if (ie_possui_producao_w = 'S') and (obter_permite_preparar_proc(nr_processo_p, nr_seq_area_w) = 'S') then
				CALL atualiza_status_processo_adep(nr_processo_p, nr_seq_area_w, 'G', 'P', clock_timestamp(), nm_usuario_p);
			elsif (ie_higienizacao_w = 'N') and (ie_preparo_w = 'N') and
				((ie_dispensacao_w = 'N') or (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '')) and (ie_conferencia_w = 'N') then
				
				ie_ordens_nao_prep_area_w := 'N';
				if (nr_seq_area_w IS NOT NULL AND nr_seq_area_w::text <> '') then
					select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
					into STRICT	ie_ordens_nao_prep_area_w
					from	adep_processo_frac x,
							prescr_mat_hor y
					where	y.nr_seq_etiqueta	= x.nr_sequencia
					and		y.nr_seq_processo	= x.nr_seq_processo
					and		x.nr_seq_processo	= nr_processo_p
					and		y.nr_seq_area_prep	<> nr_seq_area_w
					and		coalesce(x.dt_fim_preparo::text, '') = ''
					and		coalesce(y.dt_suspensao::text, '') = '';				
				end if;

				if (obter_rastreabilidade_adep(nr_processo_p, 'CH') = 'S') then
					CALL adep_gerar_log_rastr('{'||chr(10)||
										'"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
										'"nr_processo_p" : "'||nr_processo_p||'",'||chr(10)||
										'"ie_ordens_nao_prep_area_w" : "'||ie_ordens_nao_prep_area_w||'"}'
										, wheb_usuario_pck.get_ie_commit);
				end if;

				if (ie_ordens_nao_prep_area_w = 'N') then
					CALL atualiza_status_processo_adep(nr_processo_p, nr_seq_area_w, 'G', 'C', clock_timestamp(), nm_usuario_p);
				end if;	
				
				if (ie_dispensacao_w = 'N') then
					CALL atualiza_status_processo_adep(nr_processo_p, nr_seq_area_w, 'G', 'E', clock_timestamp(), nm_usuario_p);				
				end if;
			else
				CALL atualiza_status_processo_adep(nr_processo_p, nr_seq_area_w, 'G', 'S', clock_timestamp(), nm_usuario_p);
			end if;			

			if (ie_adep_map_w = 'S') then
				nr_seq_map_w := gerar_estornar_adep_map(nr_processo_p, NULL, nr_seq_area_w, 'G', clock_timestamp(), nm_usuario_p, nr_seq_map_w, 'SP', null, null);
			end if;

		end if;

	elsif (ie_separar_p = 'N') then

		delete
		from	adep_processo_area
		where	nr_seq_processo = nr_processo_p
		and	((coalesce(nr_seq_area_w::text, '') = '') or (nr_seq_area_prep = nr_seq_area_w));
		
		if (ie_adep_map_w = 'S') then
			nr_seq_map_w := gerar_estornar_adep_map(nr_processo_p, null, nr_seq_area_w, 'E', clock_timestamp(), nm_usuario_p, nr_seq_map_w, 'SP', null, null);
		end if;		

	end if;

	if (obter_rastreabilidade_adep(nr_processo_p, 'CH') = 'S') then
		CALL adep_gerar_log_rastr('{'||chr(10)||
							'"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
							'"nr_processo_p" : "'||nr_processo_p||'",'||chr(10)||
							'"nr_seq_map_w" : "'||nr_seq_map_w||'"}'
							, wheb_usuario_pck.get_ie_commit);
	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gedipa_separar_processo ( cd_estabelecimento_p bigint, cd_perfil_p bigint, nr_processo_p bigint, nr_seq_area_p bigint, ie_separar_p text, nm_usuario_p text) FROM PUBLIC;

