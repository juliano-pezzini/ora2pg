-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_comunic_log_pj ( cd_estabelecimento_p bigint, nm_usuario_p text, ds_historico_p text, cd_cnpj_p text, ie_tipo_envio_p text default 'A') AS $body$
DECLARE


			
			
nr_sequencia_w		bigint;
ds_titulo_w		varchar(255);
ie_tipo_envio_w		varchar(2);
ds_mensagem_w		varchar(32000);
ie_comunicacao_w		varchar(2);
ie_email_w		varchar(2);
nm_usuario_dest_w		varchar(255);
cd_pessoa_fisica_w	varchar(10);
ds_email_destino_w		varchar(2000);
ds_email_origem_w		varchar(255);
nr_seq_classif_w		bigint;
ds_email_adicional_w	varchar(255);
ds_razao_social_w		pessoa_juridica.ds_razao_social%type;
ds_perfil_ativo_w		varchar(40);
ds_tipo_pessoa_w		varchar(40);
nm_usuarios_dest_temp_w comunic_interna.nm_usuario_destino%type;
			
C01 CURSOR FOR
	SELECT	nr_sequencia,
		ie_tipo_envio,
		ds_mensagem,
		ie_comunicacao,
		ie_email
	from	pj_regra_envio
	where	cd_estabelecimento 	= cd_estabelecimento_p
	and	ie_tipo_envio 		= ie_tipo_envio_p;

C02 CURSOR FOR
	SELECT	substr(obter_usuario_pessoa(cd_pessoa_fisica),1,255),
		cd_pessoa_fisica,
		ds_email_adicional
	from	pj_regra_envio_usuario
	where	nr_seq_envio = nr_sequencia_w
	and	ie_email_w = 'S';
	
C03 CURSOR FOR
	SELECT	substr(obter_usuario_pessoa(cd_pessoa_fisica),1,255)
	from	pj_regra_envio_usuario
	where	nr_seq_envio = nr_sequencia_w;
			

BEGIN

ds_perfil_ativo_w := substr(obter_nome_perfil(obter_perfil_ativo),1,40);

SELECT	obter_classif_comunic('F')
INTO STRICT	nr_seq_classif_w
;

begin
select	a.ds_razao_social,
	substr(obter_desc_tipo_pessoa(a.cd_tipo_pessoa),1,40)
into STRICT	ds_razao_social_w,
	ds_tipo_pessoa_w
from	pessoa_juridica a
where	a.cd_cgc = cd_cnpj_p;
exception
when others then
	null;
end;

open C01;
loop
fetch C01 into	
	nr_sequencia_w,
	ie_tipo_envio_w,
	ds_mensagem_w,
	ie_comunicacao_w,
	ie_email_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin	
	
	if (ie_tipo_envio_w = 'C') then
		ds_titulo_w := wheb_mensagem_pck.get_texto(306324); --'Criacao pessoa juridica'
	else
		ds_titulo_w := wheb_mensagem_pck.get_texto(306325); --'Alteracao pessoa juridica'
	end if;
	
	ds_mensagem_w	:= substr(replace_macro(ds_mensagem_w, '@ds_historico',ds_historico_p),1,32000);	
	ds_mensagem_w	:= substr(replace_macro(ds_mensagem_w, '@cnpj',cd_cnpj_p),1,32000);	
	ds_mensagem_w	:= substr(replace_macro(ds_mensagem_w, '@usuario',nm_usuario_p),1,32000);
	ds_mensagem_w	:= substr(replace_macro(ds_mensagem_w, '@razao_social',ds_razao_social_w),1,32000);
	ds_mensagem_w	:= substr(replace_macro(ds_mensagem_w, '@perfil_ativo',ds_perfil_ativo_w),1,32000);
	ds_mensagem_w	:= substr(replace_macro(ds_mensagem_w, '@tipo_pessoa',ds_tipo_pessoa_w),1,32000);
	
	open C02;
	loop
	fetch C02 into	
		nm_usuario_dest_w,
		cd_pessoa_fisica_w,
		ds_email_adicional_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		ds_email_origem_w	:= substr(obter_email_pessoa(cd_estabelecimento_p,obter_pessoa_fisica_usuario(nm_usuario_p,'C'),null,nm_usuario_p),1,255);
		ds_email_destino_w	:= substr(obter_email_pessoa(cd_estabelecimento_p,cd_pessoa_fisica_w,null,nm_usuario_dest_w),1,2000);

		if (coalesce(ds_email_adicional_w,'X') <> 'X') then
			ds_email_destino_w	:= substr(ds_email_adicional_w || ';' || ds_email_destino_w,1,2000);
		end if;

		if (coalesce(ds_email_destino_w,'X') <> 'X') then
			CALL enviar_email(	wheb_mensagem_pck.get_texto(306326,'DS_TITULO_W='||ds_titulo_w), --Aviso de ' || lower(ds_titulo_w)
					ds_mensagem_w,
					null,
					ds_email_destino_w,
					nvl(nm_usuario_p, 'Aviso_Tasy'),
					'A');
		end if;
		end;
	end loop;
	close C02;
	
	open C03;
	loop
	fetch C03 into
	nm_usuario_dest_w;
	exit when C03%notfound;
		begin
		
		if	(nm_usuarios_dest_temp_w is null) then
			begin
			nm_usuarios_dest_temp_w := nm_usuario_dest_w;
			end;
		else
			begin
			nm_usuarios_dest_temp_w := nm_usuarios_dest_temp_w || ',' || nm_usuario_dest_w;
			end;
			
		end if;
		
		end;
	end loop;
	close C03;
	
	if	(ie_comunicacao_w = 'S') then
		insert into comunic_interna(
			dt_comunicado,
			ds_titulo,
			ds_comunicado,
			nm_usuario,
			dt_atualizacao,
			ie_geral,
			nm_usuario_destino,
			nr_sequencia,
			ie_gerencial,
			nr_seq_classif,
			dt_liberacao,
			ds_setor_adicional,
			ds_perfil_adicional)
		values(	sysdate,
			ds_titulo_w,
			ds_mensagem_w,
			nm_usuario_p,
			sysdate,
			'N',
			nm_usuarios_dest_temp_w,
			comunic_interna_seq.nextval,
			'N',
			nr_seq_classif_w,
			clock_timestamp(),
			null,
			null);
	end if;
	
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_comunic_log_pj ( cd_estabelecimento_p bigint, nm_usuario_p text, ds_historico_p text, cd_cnpj_p text, ie_tipo_envio_p text default 'A') FROM PUBLIC;

