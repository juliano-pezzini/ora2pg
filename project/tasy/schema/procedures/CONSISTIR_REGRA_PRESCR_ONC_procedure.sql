-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_regra_prescr_onc (( nr_sequencia_p bigint, nr_seq_material_p bigint, ie_pasta_p text, nr_seq_regra_p bigint) IS /*
Descrição				IE_PASTA_P
Protocolo	 				P
Atendimento do ciclo			A
*/
 cd_perfil_w bigint) RETURNS varchar AS $body$
DECLARE


							ds_msg_perfil_w	varchar(4000);
							ds_msg_wheb_w	varchar(4000);
							ds_retorno_w	varchar(255);


							c01 CURSOR FOR
								SELECT	ds_mensagem_cliente
								FROM	regra_consiste_prescr_par
								WHERE	nr_seq_regra 			= nr_regra_p
								AND		coalesce(cd_perfil,cd_perfil_p)	= cd_perfil_p
								ORDER BY nr_sequencia;


						
BEGIN

							OPEN c01;
							LOOP
							FETCH c01 INTO ds_msg_perfil_w;
							EXIT WHEN NOT FOUND; /* apply on c01 */
								BEGIN
								ds_msg_perfil_w := ds_msg_perfil_w;
								END;
							END LOOP;
							CLOSE c01;


							SELECT	obter_desc_expressao(cd_exp_mensagem,ds_mensagem_usuario)
							INTO STRICT	ds_msg_wheb_w
							FROM	regra_consiste_prescr
							WHERE	nr_sequencia = nr_regra_p;

							ds_retorno_w := SUBSTR(coalesce(ds_msg_perfil_w,ds_msg_wheb_w),1,255);

							RETURN ds_retorno_w;


						END;


BEGIN

	cd_perfil_w				:= obter_perfil_ativo;
	nm_usuario_w			:= wheb_usuario_pck.get_nm_usuario;
	cd_estabelecimento_w 	:= wheb_usuario_pck.get_cd_estabelecimento;
	ie_feriado_w			:= coalesce(obter_se_feriado(cd_estabelecimento_w, clock_timestamp()),0);
	ie_dia_semana_w			:= pkg_date_utils.get_WeekDay(clock_timestamp());

	ie_setor_atendimento_padrao_w := Obter_param_Usuario(3130, 193, obter_perfil_ativo, nm_usuario_w, cd_estabelecimento_w, ie_setor_atendimento_padrao_w);

IF (ie_pasta_p = 'P') THEN

	SELECT 	MAX(a.ie_objetivo),
			MAX(a.ds_justificativa),
			MAX(a.cd_topografia_cih),
			MAX(a.cd_microorganismo_cih),
			MAX(a.cd_amostra_cih),
			MAX(a.ie_origem_infeccao),
			MAX(a.cd_material),
			MAX(a.cd_intervalo)
	INTO STRICT	ie_objetivo_w,
			ds_justificativa_w,
			cd_topografia_cih_w,
			cd_microorganismo_cih_w,
			cd_amostra_cih_w,
			ie_origem_infeccao_w,
			cd_material_w,
			cd_intervalo_w
	FROM 	PACIENTE_PROTOCOLO_MEDIC a
	WHERE	a.nr_seq_paciente = nr_sequencia_p
	AND		a.nr_seq_material = nr_seq_material_p;

ELSIF (ie_pasta_p = 'A') THEN

	SELECT 	MAX(a.ie_objetivo),
			MAX(a.ds_justificativa),
			MAX(a.cd_topografia_cih),
			MAX(a.cd_microorganismo_cih),
			MAX(a.cd_amostra_cih),
			MAX(a.ie_origem_infeccao),
			MAX(a.cd_material),
			MAX(a.cd_intervalo)
	INTO STRICT	ie_objetivo_w,
			ds_justificativa_w,
			cd_topografia_cih_w,
			cd_microorganismo_cih_w,
			cd_amostra_cih_w,
			ie_origem_infeccao_w,
			cd_material_w,
			cd_intervalo_w
	FROM 	paciente_atend_medic	a
	WHERE	a.nr_seq_atendimento 	= nr_sequencia_p
	AND		a.nr_seq_material 		= nr_seq_material_p;

END IF;

IF (coalesce(cd_material_w,0) > 0) THEN

	SELECT	MAX(cd_grupo_material),
			MAX(cd_subgrupo_material),
			MAX(cd_classe_material),
			MAX(nr_seq_familia),
			MAX(cd_material_estoque),
			MAX(nr_seq_ficha_tecnica)
	INTO STRICT	cd_grupo_material_w,
			cd_subgrupo_w,
			cd_classe_material_w,
			nr_seq_familia_w,
			cd_material_estoque_w,
			nr_seq_ficha_tecnica_w
	FROM	estrutura_material_v
	WHERE 	cd_material	= cd_material_w;

	IF (ie_pasta_p = 'A') THEN

		SELECT  MAX(a.cd_setor_atendimento),
				MAX(b.nr_atendimento)
		INTO STRICT	cd_setor_paciente_setor_w,
				nr_atendimento_w
		FROM	paciente_setor a,
				paciente_atendimento b
		WHERE	a.nr_seq_paciente = b.nr_seq_paciente
		AND		b.nr_seq_atendimento = nr_sequencia_p;

		cd_setor_atendimento_w := obter_setor_atendimento(nr_atendimento_w);

		SELECT coalesce(MAX(obter_controle_medic(cd_material,cd_estabelecimento_w,ie_controle_medico,Obter_Tipo_Atendimento(nr_atendimento_w),coalesce(ie_setor_atendimento_padrao_w,cd_setor_paciente_setor_w), obter_clinica_atend(nr_atendimento_w,'C'))),0)
		INTO STRICT	ie_ctrl_medico_antimicrob_w
		FROM	material
		WHERE	cd_material	= cd_material_w;

	ELSE

		SELECT	SUBSTR(obter_controle_medic(cd_material,cd_estabelecimento_w,ie_controle_medico,NULL,NULL,NULL),1,1)
		INTO STRICT	ie_ctrl_medico_antimicrob_w
		FROM	material
		WHERE	cd_material	= cd_material_w;

	END IF;

END IF;

OPEN c01;
LOOP
FETCH c01 INTO
	ie_justificativa_antimicrob_w,
	ie_objetivo_antimicrob_w,
	ie_dia_utilizacao_antimicrob_w,
	ie_topografia_antimicrob_w,
	ie_amostra_antimicrob_w,
	ie_microorganismo_antimicrob_w,
	ie_origem_antimicrob_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	BEGIN
	ie_justificativa_antimicrob_w	:= ie_justificativa_antimicrob_w;
	ie_objetivo_antimicrob_w		:= ie_objetivo_antimicrob_w;
	ie_dia_utilizacao_antimicrob_w	:= ie_dia_utilizacao_antimicrob_w;
	ie_topografia_antimicrob_w		:= ie_topografia_antimicrob_w;
	ie_amostra_antimicrob_w			:= ie_amostra_antimicrob_w;
	ie_microorganismo_antimicrob_w	:= ie_microorganismo_antimicrob_w;
	ie_origem_antimicrob_w			:= ie_origem_antimicrob_w;
	END;
END LOOP;
CLOSE c01;

IF (ie_objetivo_antimicrob_w = 'S') AND (coalesce(ie_objetivo_w::text, '') = '') AND (wheb_assist_pck.Obter_Se_Consiste_REP(8,cd_perfil_w) = 'S')  THEN

	ds_erro_w := obter_frase_regra(8,cd_perfil_w);

	IF (ie_pasta_p = 'P') THEN

		nr_seq_erro_w := gerar_erro_pac_prot(nr_sequencia_p, nr_seq_material_p, nr_seq_regra_p, SUBSTR(ds_erro_w,1,255), cd_perfil_w, nm_usuario_w, nr_seq_erro_w);

	ELSIF (ie_pasta_p = 'A') THEN

		nr_seq_erro_w := gerar_erro_pac_atend(nr_sequencia_p, nr_seq_material_p, nr_seq_regra_p, SUBSTR(ds_erro_w,1,255), cd_perfil_w, nm_usuario_w, nr_seq_erro_w, IE_FORMA_CONSISTENCIA_W);

	END IF;

END IF;



IF (ie_pasta_p = 'A') THEN

	ie_dias_lib_microb_w := 'S';

	SELECT 	MAX(nr_ciclo),
			MAX(nr_seq_paciente)
	INTO STRICT	nr_ciclo_solicitado_w,
			nr_seq_paciente_w
	FROM	paciente_atendimento
	WHERE	nr_seq_atendimento = nr_sequencia_p;


	SELECT  coalesce(MAX(qt_dias_liberado),0)
	INTO STRICT	qt_dias_liberado_w
	FROM	prescr_material a,
			paciente_atendimento b
	WHERE	a.cd_material = cd_material_w
	AND		b.nr_ciclo	= nr_ciclo_solicitado_w
	AND		a.nr_seq_Atendimento = b.nr_seq_atendimento
	AND		b.nr_seq_paciente = nr_seq_paciente_w
	AND		a.nr_seq_atendimento < nr_sequencia_p;

	SELECT 	COUNT(1) + 1
	INTO STRICT	qt_dias_ant_microbianos_w
	FROM	paciente_atendimento a,
			paciente_atend_medic b
	WHERE	a.nr_seq_paciente = nr_seq_paciente_w
	AND		a.nr_seq_atendimento = b.nr_seq_atendimento
	AND		b.cd_material = cd_material_w
	AND		a.nr_ciclo	= nr_ciclo_solicitado_w
	AND		a.nr_seq_atendimento < nr_sequencia_p
	AND		coalesce(b.nr_seq_diluicao::text, '') = ''
	AND		coalesce(b.nr_seq_solucao::text, '') = '';

	IF (qt_dias_liberado_w > 0) AND (qt_dias_ant_microbianos_w > qt_dias_liberado_w ) THEN

		ie_dias_lib_microb_w := 'N';

	END IF;



	IF	((ie_dia_utilizacao_antimicrob_w = 'S') OR
		(ie_dia_utilizacao_antimicrob_w = 'P' AND ie_objetivo_w = 'F') OR
		(ie_dia_utilizacao_antimicrob_w = 'F' AND ie_objetivo_w = 'P') OR
		(ie_dia_utilizacao_antimicrob_w = 'C' AND ie_objetivo_w = 'C') OR
		(ie_dia_utilizacao_antimicrob_w = 'D' AND ie_objetivo_w = 'D') OR
		(ie_dia_utilizacao_antimicrob_w = 'E' AND ie_objetivo_w = 'E') OR
		(ie_dia_utilizacao_antimicrob_w = 'T' AND ie_objetivo_w = 'T')) AND (ie_dias_lib_microb_w = 'N') AND (wheb_assist_pck.Obter_Se_Consiste_REP(10,cd_perfil_w) = 'S') THEN

		ds_erro_w := wheb_mensagem_pck.get_texto(380881, 'QT_PREVISTO=' || TO_CHAR(qt_dias_ant_microbianos_w) || ';QT_LIBERADO=' || TO_CHAR(qt_dias_liberado_w));

		nr_seq_erro_w := gerar_erro_pac_atend(nr_sequencia_p, nr_seq_material_p, nr_seq_regra_p, SUBSTR(ds_erro_w,1,255), cd_perfil_w, nm_usuario_w, nr_seq_erro_w, IE_FORMA_CONSISTENCIA_W);

	END IF;

END IF;

IF	(((ie_topografia_antimicrob_w = 'S') AND (coalesce(cd_topografia_cih_w::text, '') = '')) OR
	((ie_topografia_antimicrob_w = 'P') AND (ie_objetivo_w = 'F') AND (coalesce(cd_topografia_cih_w::text, '') = '')) OR
	((ie_topografia_antimicrob_w = 'F') AND (ie_objetivo_w = 'P') AND (coalesce(cd_topografia_cih_w::text, '') = '')) OR
	((ie_topografia_antimicrob_w = 'C') AND (ie_objetivo_w = 'C') AND (coalesce(cd_topografia_cih_w::text, '') = '')) OR
	((ie_topografia_antimicrob_w = 'D') AND (ie_objetivo_w = 'D') AND (coalesce(cd_topografia_cih_w::text, '') = '')) OR
	((ie_topografia_antimicrob_w = 'E') AND (ie_objetivo_w = 'E') AND (coalesce(cd_topografia_cih_w::text, '') = '')) OR
	((ie_topografia_antimicrob_w = 'T') AND (ie_objetivo_w = 'T') AND (coalesce(cd_topografia_cih_w::text, '') = ''))) AND (wheb_assist_pck.Obter_Se_Consiste_REP(11,cd_perfil_w) = 'S') THEN

	ds_erro_w := obter_frase_regra(11,cd_perfil_w);

	IF (ie_pasta_p = 'P') THEN

		nr_seq_erro_w := gerar_erro_pac_prot(nr_sequencia_p, nr_seq_material_p, nr_seq_regra_p, SUBSTR(ds_erro_w,1,255), cd_perfil_w, nm_usuario_w, nr_seq_erro_w);

	ELSIF (ie_pasta_p = 'A') THEN

		nr_seq_erro_w := gerar_erro_pac_atend(nr_sequencia_p, nr_seq_material_p, nr_seq_regra_p, SUBSTR(ds_erro_w,1,255), cd_perfil_w, nm_usuario_w, nr_seq_erro_w, IE_FORMA_CONSISTENCIA_W);

	END IF;

END IF;

IF	(((ie_amostra_antimicrob_w = 'S') AND (coalesce(cd_amostra_cih_w::text, '') = '')) OR
	((ie_amostra_antimicrob_w = 'P') AND (ie_objetivo_w = 'F') AND (coalesce(cd_amostra_cih_w::text, '') = '')) OR
	((ie_amostra_antimicrob_w = 'F') AND (ie_objetivo_w = 'P') AND (coalesce(cd_amostra_cih_w::text, '') = '')) OR
	((ie_amostra_antimicrob_w = 'C') AND (ie_objetivo_w = 'C') AND (coalesce(cd_amostra_cih_w::text, '') = '')) OR
	((ie_amostra_antimicrob_w = 'D') AND (ie_objetivo_w = 'D') AND (coalesce(cd_amostra_cih_w::text, '') = '')) OR
	((ie_amostra_antimicrob_w = 'E') AND (ie_objetivo_w = 'E') AND (coalesce(cd_amostra_cih_w::text, '') = '')) OR
	((ie_amostra_antimicrob_w = 'T') AND (ie_objetivo_w = 'T') AND (coalesce(cd_amostra_cih_w::text, '') = ''))) AND (wheb_assist_pck.Obter_Se_Consiste_REP(12,cd_perfil_w) = 'S') THEN

	ds_erro_w := obter_frase_regra(12,cd_perfil_w);

	IF (ie_pasta_p = 'P') THEN

		nr_seq_erro_w := gerar_erro_pac_prot(nr_sequencia_p, nr_seq_material_p, nr_seq_regra_p, SUBSTR(ds_erro_w,1,255), cd_perfil_w, nm_usuario_w, nr_seq_erro_w);

	ELSIF (ie_pasta_p = 'A') THEN

		nr_seq_erro_w := gerar_erro_pac_atend(nr_sequencia_p, nr_seq_material_p, nr_seq_regra_p, SUBSTR(ds_erro_w,1,255), cd_perfil_w, nm_usuario_w, nr_seq_erro_w, IE_FORMA_CONSISTENCIA_W);

	END IF;

END IF;

IF	(((ie_microorganismo_antimicrob_w = 'S') AND (coalesce(cd_microorganismo_cih_w::text, '') = '')) OR
	((ie_microorganismo_antimicrob_w = 'P') AND (ie_objetivo_w = 'F') AND (coalesce(cd_microorganismo_cih_w::text, '') = '')) OR
	((ie_microorganismo_antimicrob_w = 'F') AND (ie_objetivo_w = 'P') AND (coalesce(cd_microorganismo_cih_w::text, '') = '')) OR
	((ie_microorganismo_antimicrob_w = 'C') AND (ie_objetivo_w = 'C') AND (coalesce(cd_microorganismo_cih_w::text, '') = '')) OR
	((ie_microorganismo_antimicrob_w = 'D') AND (ie_objetivo_w = 'D') AND (coalesce(cd_microorganismo_cih_w::text, '') = '')) OR
	((ie_microorganismo_antimicrob_w = 'E') AND (ie_objetivo_w = 'E') AND (coalesce(cd_microorganismo_cih_w::text, '') = '')) OR
	((ie_microorganismo_antimicrob_w = 'T') AND (ie_objetivo_w = 'T') AND (coalesce(cd_microorganismo_cih_w::text, '') = ''))) AND (wheb_assist_pck.Obter_Se_Consiste_REP(13,cd_perfil_w) = 'S') THEN

	ds_erro_w := obter_frase_regra(13,cd_perfil_w);

	IF (ie_pasta_p = 'P') THEN

		nr_seq_erro_w := gerar_erro_pac_prot(nr_sequencia_p, nr_seq_material_p, nr_seq_regra_p, SUBSTR(ds_erro_w,1,255), cd_perfil_w, nm_usuario_w, nr_seq_erro_w);

	ELSIF (ie_pasta_p = 'A') THEN

		nr_seq_erro_w := gerar_erro_pac_atend(nr_sequencia_p, nr_seq_material_p, nr_seq_regra_p, SUBSTR(ds_erro_w,1,255), cd_perfil_w, nm_usuario_w, nr_seq_erro_w, IE_FORMA_CONSISTENCIA_W);

	END IF;

END IF;

IF	(((ie_origem_antimicrob_w = 'S') AND (coalesce(ie_origem_infeccao_w::text, '') = '')) OR
	((ie_origem_antimicrob_w = 'P') AND (ie_objetivo_w = 'F') AND (coalesce(ie_origem_infeccao_w::text, '') = '')) OR
	((ie_origem_antimicrob_w = 'F') AND (ie_objetivo_w = 'P') AND (coalesce(ie_origem_infeccao_w::text, '') = '')) OR
	((ie_origem_antimicrob_w = 'C') AND (ie_objetivo_w = 'C') AND (coalesce(ie_origem_infeccao_w::text, '') = '')) OR
	((ie_origem_antimicrob_w = 'D') AND (ie_objetivo_w = 'D') AND (coalesce(ie_origem_infeccao_w::text, '') = '')) OR
	((ie_origem_antimicrob_w = 'E') AND (ie_objetivo_w = 'E') AND (coalesce(ie_origem_infeccao_w::text, '') = '')) OR
	((ie_origem_antimicrob_w = 'T') AND (ie_objetivo_w = 'T') AND (coalesce(ie_origem_infeccao_w::text, '') = ''))) AND (wheb_assist_pck.Obter_Se_Consiste_REP(14,cd_perfil_w) = 'S') THEN

	ds_erro_w := obter_frase_regra(14,cd_perfil_w);

	IF (ie_pasta_p = 'P') THEN

		nr_seq_erro_w := gerar_erro_pac_prot(nr_sequencia_p, nr_seq_material_p, nr_seq_regra_p, SUBSTR(ds_erro_w,1,255), cd_perfil_w, nm_usuario_w, nr_seq_erro_w);

	ELSIF (ie_pasta_p = 'A') THEN

		nr_seq_erro_w := gerar_erro_pac_atend(nr_sequencia_p, nr_seq_material_p, nr_seq_regra_p, SUBSTR(ds_erro_w,1,255), cd_perfil_w, nm_usuario_w, nr_seq_erro_w, IE_FORMA_CONSISTENCIA_W);

	END IF;

END IF;

IF	(((ie_justificativa_antimicrob_w = 'S') AND (coalesce(ds_justificativa_w::text, '') = '')) OR
	((ie_justificativa_antimicrob_w = 'P') AND (ie_objetivo_w = 'F') AND (coalesce(ds_justificativa_w::text, '') = '')) OR
	((ie_justificativa_antimicrob_w = 'F') AND (ie_objetivo_w = 'P') AND (coalesce(ds_justificativa_w::text, '') = '')) OR
	((ie_justificativa_antimicrob_w = 'C') AND (ie_objetivo_w = 'C') AND (coalesce(ds_justificativa_w::text, '') = '')) OR
	((ie_justificativa_antimicrob_w = 'D') AND (ie_objetivo_w = 'D') AND (coalesce(ds_justificativa_w::text, '') = '')) OR
	((ie_justificativa_antimicrob_w = 'E') AND (ie_objetivo_w = 'E') AND (coalesce(ds_justificativa_w::text, '') = '')) OR
	((ie_justificativa_antimicrob_w = 'T') AND (ie_objetivo_w = 'T') AND (coalesce(ds_justificativa_w::text, '') = ''))) AND (wheb_assist_pck.Obter_Se_Consiste_REP(16,cd_perfil_w) = 'S') THEN

	ds_erro_w := obter_frase_regra(16,cd_perfil_w);

	IF (ie_pasta_p = 'P') THEN

		nr_seq_erro_w := gerar_erro_pac_prot(nr_sequencia_p, nr_seq_material_p, nr_seq_regra_p, SUBSTR(ds_erro_w,1,255), cd_perfil_w, nm_usuario_w, nr_seq_erro_w);

	ELSIF (ie_pasta_p = 'A') THEN

		nr_seq_erro_w := gerar_erro_pac_atend(nr_sequencia_p, nr_seq_material_p, nr_seq_regra_p, SUBSTR(ds_erro_w,1,255), cd_perfil_w, nm_usuario_w, nr_seq_erro_w, IE_FORMA_CONSISTENCIA_W);

	END IF;

END IF;

IF (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') THEN COMMIT; END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_regra_prescr_onc (( nr_sequencia_p bigint, nr_seq_material_p bigint, ie_pasta_p text, nr_seq_regra_p bigint) IS  cd_perfil_w bigint) FROM PUBLIC;

