-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_glosar_analise_discussao (nr_sequencia_p bigint, qt_aceita_p bigint, vl_aceito_p bigint, qt_negada_p bigint, vl_negado_p bigint, nr_seq_grupo_p bigint, nr_seq_mot_negada_p bigint, ds_parecer_glosas_p text, nm_usuario_p text, cd_estabelecimento_p text, ds_observacao_p text default null) AS $body$
DECLARE



qt_aceita_w		      double precision;
vl_aceito_w		      double precision;
qt_negada_w		      double precision;
vl_negado_w		      double precision;
qt_recurso_w		    double precision;
vl_recurso_w		    double precision;
ds_observacao_w		  varchar(4000);
nr_seq_conta_w		  bigint;
nr_seq_analise_w	  bigint;
ie_tipo_item_w		  varchar(1);
ds_item_w		        varchar(255);
nr_identeificador_w	bigint;
qt_negada_alt_w		  double precision;
vl_negado_alt_w	  	double precision;
vl_calculo_w		    double precision;
vl_contestado_w		  double precision;
qt_contestada_w		  double precision;
nr_seq_item_w		    bigint;


BEGIN
select	coalesce(qt_aceita,0),
	coalesce(vl_aceito,0),
	coalesce(qt_negada,0),
	coalesce(vl_negado,0),
	coalesce(qt_recurso,0),
	coalesce(vl_recurso,0),
	coalesce(vl_contestado,0),
	coalesce(qt_contestada,0),
	nr_seq_item
into STRICT	qt_aceita_w,
	vl_aceito_w,
	qt_negada_w,
	vl_negado_w,
	qt_recurso_w,
	vl_recurso_w,
	vl_contestado_w,
	qt_contestada_w,
	nr_seq_item_w
from	w_pls_discussao_item
where	nr_sequencia = nr_sequencia_p;

/* Quando alterado apenas a quantidade aceita */

if (qt_aceita_p > 0) then
	vl_calculo_w := (vl_contestado_w * qt_aceita_p);
	vl_aceito_w := dividir_sem_round(vl_calculo_w,qt_contestada_w);
else
/* Quando alterado apenas o valor aceito */

	qt_negada_alt_w := qt_contestada_w - qt_aceita_p;
	vl_negado_alt_w := vl_contestado_w - vl_aceito_p;
	vl_aceito_w := vl_aceito_p;
end if;

if (qt_aceita_p + qt_negada_alt_w > qt_contestada_w) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(114566);
elsif (vl_aceito_p + vl_negado_alt_w > vl_contestado_w) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(114567);
end if;

if (qt_aceita_w <> qt_aceita_p) then
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
				'Quantidade aceita:'||chr(13)||chr(10)||
				chr(9)||'Anterior: '||qt_aceita_w||' - Modificada: '||qt_aceita_p||chr(13)||chr(10);
end if;

if (vl_aceito_w <> vl_aceito_p) then
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
				'Valor aceito:'||chr(13)||chr(10)||
				chr(9)||'Anterior: '||vl_aceito_w||' - Modificada: '||vl_aceito_p||chr(13)||chr(10);
end if;

if (qt_negada_w <> qt_negada_alt_w) then
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
				'Quantidade negada:'||chr(13)||chr(10)||
				chr(9)||'Anterior: '||qt_negada_w||' - Modificada: '||qt_negada_p||chr(13)||chr(10);
end if;

if (vl_negado_w <> vl_negado_alt_w) then
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
				'Valor negado:'||chr(13)||chr(10)||
				chr(9)||'Anterior: '||vl_negado_w||' - Modificada: '||vl_negado_p||chr(13)||chr(10);
end if;

select	max(nr_seq_conta),
	max(nr_seq_analise),
	max(ie_tipo_item),
	max(ds_item),
	max(nr_identificador)
into STRICT	nr_seq_conta_w,
	nr_seq_analise_w,
	ie_tipo_item_w,
	ds_item_w,
	nr_identeificador_w
from	w_pls_discussao_item
where	nr_sequencia = nr_sequencia_p;

         if (ds_observacao_p IS NOT NULL AND ds_observacao_p::text <> '') then

            insert into pls_conta_observacao_a500	/* Observacao*/
                (nr_sequencia,
                dt_atualizacao,
                nm_usuario,
                dt_atualizacao_nrec,
                nm_usuario_nrec,
                ds_observacao,
                nr_seq_conta,
                nr_seq_conta_proc,
                nr_seq_conta_mat)
                
                
            values (nextval('pls_conta_observacao_a500_seq'),
                clock_timestamp(),
                nm_usuario_p,
                clock_timestamp(),
                nm_usuario_p,
                ds_observacao_p,
                nr_seq_conta_w,
                CASE WHEN ie_tipo_item_w='M' THEN  null  ELSE nr_seq_item_w END ,
                CASE WHEN ie_tipo_item_w='M' THEN  nr_seq_item_w  ELSE null END );

            end if;

if (coalesce(ds_observacao_w,'X') <> 'X') then
	CALL pls_inserir_hist_analise(nr_seq_conta_w, nr_seq_analise_w,27,nr_sequencia_p,ie_tipo_item_w, null,null,
				'Modificado pelo auditor '||obter_nome_usuario(nm_usuario_p)||'.'||chr(13)||chr(10)||
				'Item '||nr_identeificador_w||' - '||ds_item_w||'.'||chr(13)||chr(10)||ds_observacao_w,
				nr_seq_grupo_p, nm_usuario_p, cd_estabelecimento_p);
else
	CALL pls_inserir_hist_analise(nr_seq_conta_w, nr_seq_analise_w,27,nr_sequencia_p,ie_tipo_item_w, null,null,
				'Aceito parcialmente.',nr_seq_grupo_p, nm_usuario_p, cd_estabelecimento_p);
end if;

update	w_pls_discussao_item
set	qt_aceita		= coalesce(qt_aceita_p,qt_aceita_w),
	vl_aceito		= coalesce(vl_aceito_w,0),
	qt_negada		= coalesce(qt_negada_alt_w,0),
	vl_negado		= coalesce(vl_negado_alt_w,0),
	ie_situacao		= 'P'
where	nr_sequencia		= nr_sequencia_p;

select	coalesce(vl_aceito,0)
into STRICT	vl_aceito_w
from	w_pls_discussao_item
where	nr_sequencia		= nr_sequencia_p;

update	w_pls_discussao_item
set	ie_situacao		= 'P'
where	nr_seq_item		= nr_seq_item_w
and	(nr_seq_partic_proc IS NOT NULL AND nr_seq_partic_proc::text <> '');

if (vl_aceito_w = 0) then
	update	w_pls_discussao_item
	set	ie_situacao	= 'N'
	where	nr_sequencia	= nr_sequencia_p;

	update	w_pls_discussao_item
	set	ie_situacao	= 'N'
	where	nr_seq_item	= nr_seq_item_w
	and	(nr_seq_partic_proc IS NOT NULL AND nr_seq_partic_proc::text <> '');
end if;

/* Gerar o parecer dos itens glosados */

CALL pls_parecer_glosar_discussao(nr_sequencia_p,nr_seq_mot_negada_p,ds_parecer_glosas_p,nr_seq_grupo_p,nm_usuario_p,cd_estabelecimento_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_glosar_analise_discussao (nr_sequencia_p bigint, qt_aceita_p bigint, vl_aceito_p bigint, qt_negada_p bigint, vl_negado_p bigint, nr_seq_grupo_p bigint, nr_seq_mot_negada_p bigint, ds_parecer_glosas_p text, nm_usuario_p text, cd_estabelecimento_p text, ds_observacao_p text default null) FROM PUBLIC;

