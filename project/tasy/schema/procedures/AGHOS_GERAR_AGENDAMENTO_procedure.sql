-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE aghos_gerar_agendamento (nr_internacao_p bigint, dt_agendamento_p timestamp, ie_tipo_acomodacao_p bigint) AS $body$
DECLARE


cd_cnes_solicitante_w		varchar(1000);
ds_sep_bv_w			varchar(50);
ds_comando_w			varchar(2000);


BEGIN
/*
IDF_GSH_I_INTERN_AGENDA_ENT 	NUMBER 		not null
TIP_STATUS 			VARCHAR2 1 	not null
DES_ERRO 			VARCHAR2 500 	null
DAT_INTEGRACAO 		DATE 		not null
DES_USUARIO 			VARCHAR2 15 	not null
COD_CNES_SOLICITANTE 		NUMBER 7 	not null
IDF_INTERNACAO 		NUMBER 9 	not null
DAT_AGENDAMENTO 		DATE 		not null
IDF_TIPO_ACOMODACAO_LEITO 	NUMBER 2	null
*/
select	max(substr(obter_cnes_estab(a.cd_estabelecimento), 1, 7))
into STRICT	cd_cnes_solicitante_w
from	atendimento_paciente a,
	solicitacao_tasy_aghos b
where	((b.nr_atend_original = a.nr_atendimento) or (b.nr_atendimento = a.nr_atendimento))
and	b.nr_internacao = nr_internacao_p;

ds_sep_bv_w := obter_separador_bv;

ds_comando_w :=	'declare '||
		'	agenda_sai gsh_i_pkg_integra_sai.agenda_sai@tasy_aghos; '||
		'	ds_erro_ww	varchar2(500); '||
		'begin '||
		' '||
		'	gsh_i_prc_intern_agenda_ent@tasy_aghos( 0, '||
		'						''A'', '||
		'						ds_erro_ww, '||
		'						sysdate, '||
		'						''TREINA'', '||
		'						:cd_cnes_solicitante_p, '||
		'						:nr_internacao_p, '||
		'						:dt_agendamento_p, ' ||
		'						decode(:ie_tipo_acomodacao_p, 0, null, :ie_tipo_acomodacao_p)); ' ||
		' '||
		'	gsh_i_pkg_integra_sai.gsh_i_prc_intern_agenda_sai@tasy_aghos(agenda_sai); '||
		' '||
		'	if	(agenda_sai.first is not null) then '||
		'		for i in agenda_sai.first..agenda_sai.last loop '||
		' '||
		'			if	(agenda_sai(i).idf_internacao = :nr_internacao_p) then '||
		' '||
		'				update	solicitacao_tasy_aghos '||
		'				set	ie_situacao = ''AG'' '||
		'					ds_motivo_situacao = ''Agendamento feito no Aghos'' '||
		'				where	nr_internacao = :nr_internacao_p; '||
		' '||
		'				commit; '||
		' '||
		'				ds_erro_ww := null; '||
		'				gsh_i_prc_intern_agenda_s_u@tasy_aghos(	agenda_sai(i).idf_gsh_i_intern_agenda_sai,  '||
		'									''P'', '||
		'									ds_erro_ww); '||
		'			end if; '||
		'		end loop; '||
		'	end if; '||
		'end;';

CALL exec_sql_dinamico_bv('AGHOS', ds_comando_w, 	'nr_internacao_p='		|| nr_internacao_p 		|| ds_sep_bv_w ||
						'cd_cnes_solicitante_p='	|| cd_cnes_solicitante_w 	|| ds_sep_bv_w ||
						'dt_agendamento_p='		|| dt_agendamento_p		|| ds_sep_bv_w ||
						'ie_tipo_acomodacao_p='		|| ie_tipo_acomodacao_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE aghos_gerar_agendamento (nr_internacao_p bigint, dt_agendamento_p timestamp, ie_tipo_acomodacao_p bigint) FROM PUBLIC;

