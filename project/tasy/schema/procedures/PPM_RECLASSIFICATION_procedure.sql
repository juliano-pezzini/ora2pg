-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ppm_reclassification ( nr_seq_metrica_p bigint, nr_seq_objetivo_metrica_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, dt_referencia_p timestamp) AS $body$
DECLARE


dt_ref_inicio_w 	timestamp;
dt_ref_fim_w 		timestamp;
qt_total_w			bigint;
qt_troca_w			bigint;
vl_resultado_w		double precision;
nm_usuario_exec_w	usuario.nm_usuario%type;
dt_referencia_w		timestamp;
nr_seq_diretoria_w	ppm_objetivo.nr_seq_diretoria%type;
nr_seq_gerencia_w	ppm_objetivo.nr_seq_gerencia%type;
nr_seq_grupo_w		ppm_objetivo.nr_seq_grupo%type;
ie_area_gerencia_w	varchar(5);


BEGIN

dt_ref_inicio_w := pkg_date_utils.start_of(dt_referencia_p,'MONTH');
dt_ref_fim_w 	:= pkg_date_utils.end_of(last_day(dt_referencia_p),'DAY');
dt_referencia_w	:= trunc(dt_referencia_p);

select	max(nr_seq_gerencia),
		max(nr_seq_grupo),
		max(nr_seq_diretoria)
into STRICT	nr_seq_gerencia_w,
		nr_seq_grupo_w,
		nr_seq_diretoria_w
from	ppm_objetivo_metrica a,
		ppm_objetivo_meta b,
		ppm_objetivo c
where	a.nr_sequencia		= nr_seq_objetivo_metrica_p
and		a.nr_seq_meta		= b.nr_sequencia
and		b.nr_seq_objetivo	= c.nr_sequencia;

if (nr_seq_gerencia_w IS NOT NULL AND nr_seq_gerencia_w::text <> '') then

	select	y.qt_total_troca,
			(select	count(*)
			FROM	MAN_ORDEM_SERVICO a,
					MAN_ORDEM_LOG_GRUPO_DES x,
					GRUPO_DESENVOLVIMENTO e
			WHERE	a.nr_sequencia = x.nr_seq_ordem_serv
			AND     a.ie_classificacao <> a.ie_classificacao_cliente
			AND     a.ie_classificacao_cliente = 'E'
			and     a.dt_fim_real BETWEEN dt_ref_inicio_w and dt_ref_fim_w
			AND		e.nr_sequencia = x.nr_seq_grupo_des
			and		a.ie_status_ordem = '3'
			AND     e.nr_seq_gerencia = nr_seq_gerencia_w) qt_total
	into STRICT	qt_troca_w,
			qt_total_w		
	from (	SELECT	count(distinct a.nr_sequencia) qt_total_troca
				from	man_ordem_servico a,
						man_ordem_log_grupo_des b,
						grupo_desenvolvimento c,
						gerencia_wheb d
				where	a.nr_sequencia = b.nr_seq_ordem_serv
				and     b.nr_seq_grupo_des = c.nr_sequencia
				and     c.nr_seq_gerencia = d.nr_sequencia
				and     a.ie_classificacao <> a.ie_classificacao_cliente
				AND     a.ie_classificacao_cliente = 'E'
				and     d.ie_area_gerencia  IN ('DES','TEC')
				and     d.nr_sequencia = nr_seq_gerencia_w
				and     a.dt_fim_real BETWEEN dt_ref_inicio_w and dt_ref_fim_w
				and (select  min(x.dt_atualizacao)
						 from    man_ordem_serv_classif x,
								 usuario y
						 where   x.nr_seq_ordem_servico = a.nr_sequencia
						 and     x.nm_usuario = y.nm_usuario
						 and     y.cd_setor_atendimento IN (2,33,16,14,7)) between b.dt_atualizacao and (select  min(y.dt_atualizacao)
												   from    man_ordem_log_grupo_des y
												   where   y.nr_seq_ordem_serv = a.nr_sequencia
												   and     y.nr_sequencia > b.nr_sequencia)) y;			

elsif (nr_seq_diretoria_w IS NOT NULL AND nr_seq_diretoria_w::text <> '') then

	select	y.qt_total_troca,
			(select	count(*)
			FROM	MAN_ORDEM_SERVICO a,
					MAN_ORDEM_LOG_GRUPO_DES x,
					GRUPO_DESENVOLVIMENTO e,
					gerencia_wheb f
			WHERE	a.nr_sequencia 			= x.nr_seq_ordem_serv
			AND     a.ie_classificacao 		<> a.ie_classificacao_cliente
			AND     a.ie_classificacao_cliente 	= 'E'
			and     a.dt_fim_real 			BETWEEN dt_ref_inicio_w and dt_ref_fim_w
			AND		e.nr_sequencia 			= x.nr_seq_grupo_des
			and		a.ie_status_ordem 		= '3'
			AND     e.nr_seq_gerencia 		= f.nr_sequencia
			and		f.nr_seq_diretoria		= nr_seq_diretoria_w) qt_total
	into STRICT	qt_troca_w,
			qt_total_w		
	from (SELECT	count(distinct a.nr_sequencia) qt_total_troca
			from	man_ordem_servico a,
					man_ordem_log_grupo_des b,
					grupo_desenvolvimento c,
					gerencia_wheb d
			where	a.nr_sequencia = b.nr_seq_ordem_serv
			and     b.nr_seq_grupo_des = c.nr_sequencia
			and     c.nr_seq_gerencia = d.nr_sequencia
			and     a.ie_classificacao <> a.ie_classificacao_cliente
			AND     a.ie_classificacao_cliente = 'E'
			and     d.ie_area_gerencia  IN ('DES','TEC')
			and     d.nr_seq_diretoria = nr_seq_diretoria_w
			and     a.dt_fim_real BETWEEN dt_ref_inicio_w and dt_ref_fim_w
			and (select  min(x.dt_atualizacao)
					 from    man_ordem_serv_classif x,
							 usuario y
					 where   x.nr_seq_ordem_servico = a.nr_sequencia
					 and     x.nm_usuario = y.nm_usuario
					 and     y.cd_setor_atendimento IN (2,33,16,14,7)) between b.dt_atualizacao and (select  min(y.dt_atualizacao)
											   from    man_ordem_log_grupo_des y
											   where   y.nr_seq_ordem_serv = a.nr_sequencia
											   and     y.nr_sequencia > b.nr_sequencia)) y;
end if;

if (qt_total_w > 0) then
	vl_Resultado_w	:= dividir(qt_troca_w * 100, qt_total_w);
else
	vl_Resultado_w	:= 0;
end if;

CALL PPM_GRAVAR_RESULTADO(nr_seq_objetivo_metrica_p, dt_referencia_p, vl_Resultado_w, qt_total_w, qt_troca_w, nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ppm_reclassification ( nr_seq_metrica_p bigint, nr_seq_objetivo_metrica_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, dt_referencia_p timestamp) FROM PUBLIC;

