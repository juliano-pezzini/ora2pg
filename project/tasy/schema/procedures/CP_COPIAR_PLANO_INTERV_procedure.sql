-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cp_copiar_plano_interv ( nr_seq_pr_diag_ant_p bigint, nr_seq_pr_diag_new_p bigint, nm_usuario_p text) AS $body$
DECLARE


  nr_seq_interv_plan_ant_w patient_cp_interv_plan.nr_sequencia%type;
  nr_seq_interv_plan_new_w patient_cp_interv_plan.nr_sequencia%type;
  nr_seq_p_cp_int_new_w patient_cp_intervention.nr_sequencia%type;
  NR_SEQ_PRESCR_NEW_W PE_PRESCR_DIAG.NR_SEQUENCIA%TYPE;
  NR_SEQ_PRESCR_ANT_W PE_PRESCR_DIAG.NR_SEQUENCIA%TYPE;
  c_pat_cp_interv_plan_ant CURSOR FOR
    SELECT *
    FROM patient_cp_interv_plan
    WHERE nr_seq_prescr_diag = nr_seq_pr_diag_ant_p;
  c_pat_cp_int_ant CURSOR FOR
    SELECT *
    FROM patient_cp_intervention
    WHERE nr_seq_pat_cp_interv_plan = nr_seq_interv_plan_ant_w;
BEGIN
  FOR r_c_pat_cp_interv_plan_ant IN c_pat_cp_interv_plan_ant
  LOOP
    nr_seq_interv_plan_ant_w := r_c_pat_cp_interv_plan_ant.nr_sequencia;

    SELECT nextval('patient_cp_interv_plan_seq')
    INTO STRICT nr_seq_interv_plan_new_w
;

    INSERT
    INTO patient_cp_interv_plan(
        nr_sequencia,
        dt_atualizacao,
        nm_usuario,
        dt_atualizacao_nrec,
        nm_usuario_nrec,
        nr_seq_interv_plan,
        dt_start,
        dt_end,
        dt_release,
        si_selected,
        nr_seq_prescr_diag,
        nr_seq_int_pla_diag
      )
      VALUES (
        nr_seq_interv_plan_new_w,
        clock_timestamp(),
        nm_usuario_p,
        clock_timestamp(),
        nm_usuario_p,
        r_c_pat_cp_interv_plan_ant.nr_seq_interv_plan,
        r_c_pat_cp_interv_plan_ant.dt_start,
        r_c_pat_cp_interv_plan_ant.dt_end,
        r_c_pat_cp_interv_plan_ant.dt_release,
        r_c_pat_cp_interv_plan_ant.si_selected,
        nr_seq_pr_diag_new_p,
        r_c_pat_cp_interv_plan_ant.nr_seq_int_pla_diag
      );

    --PATIENT_CP_INTERVENTION
    FOR r_c_pat_cp_int IN c_pat_cp_int_ant
    LOOP
      SELECT nextval('patient_cp_intervention_seq')
      INTO STRICT nr_seq_p_cp_int_new_w
;

      INSERT
      INTO patient_cp_intervention(
          nr_sequencia,
          dt_atualizacao,
          nm_usuario,
          dt_atualizacao_nrec,
          nm_usuario_nrec,
          nr_seq_cp_intervention,
          dt_start,
          dt_end,
          dt_release,
          si_selected,
          nr_seq_pat_cp_interv_plan,
          nr_seq_prescr_diag
        )
        VALUES (
          nr_seq_p_cp_int_new_w,
          clock_timestamp(),
          nm_usuario_p,
          clock_timestamp(),
          nm_usuario_p,
          r_c_pat_cp_int.nr_seq_cp_intervention,
          r_c_pat_cp_int.dt_start,
          r_c_pat_cp_int.dt_end,
          r_c_pat_cp_int.dt_release,
          r_c_pat_cp_int.si_selected,
          nr_seq_interv_plan_new_w,
          nr_seq_pr_diag_new_p
        );

        SELECT NR_SEQ_PRESCR INTO STRICT NR_SEQ_PRESCR_NEW_W FROM PE_PRESCR_DIAG WHERE NR_SEQUENCIA = nr_seq_pr_diag_new_p;
        SELECT NR_SEQ_PRESCR INTO STRICT NR_SEQ_PRESCR_ANT_W FROM PE_PRESCR_DIAG WHERE NR_SEQUENCIA = nr_seq_pr_diag_ant_p;

        CALL CP_COPIAR_PRESCR_PROC(NR_SEQ_PRESCR_NEW_W,NR_SEQ_PRESCR_ANT_W,nr_seq_p_cp_int_new_w,r_c_pat_cp_int.NR_SEQUENCIA,null,null,nm_usuario_p);
    END LOOP;
  END LOOP;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cp_copiar_plano_interv ( nr_seq_pr_diag_ant_p bigint, nr_seq_pr_diag_new_p bigint, nm_usuario_p text) FROM PUBLIC;

