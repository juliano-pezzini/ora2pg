-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_liberar_defesa ( nr_seq_defesa_p bigint, ie_impug_nova_p text, nm_usuario_p text) AS $body$
DECLARE


/* Procedure criada em virtude da OS 84645 - Histórico 02/02/2009 15:32:17 */

ie_tipo_defesa_w		varchar(3);
nr_seq_impugnacao_w		bigint;
nr_seq_conta_w			bigint;
ie_status_defesa_w		varchar(3);
ie_status_impugnacao_w		varchar(3);
ie_status_conta_w		varchar(3);
ie_instancia_conta_w		varchar(3);
ie_status_pagamento_w		varchar(3);
vl_proc_ressarcir_w		pls_processo_conta.vl_ressarcir%type	:= 0;
vl_proc_liberado_w		pls_impugnacao_proc.vl_liberado%type	:= 0;
ie_tipo_impugnacao_w		pls_processo_conta.ie_tipo_impugnacao%type;
vl_ressarcir_w			pls_processo_conta.vl_ressarcir%type	:= 0;
vl_pendente_w			pls_processo_conta.vl_pendente%type	:= 0;
vl_procedimentos_w		pls_processo_procedimento.vl_procedimento%type	:= 0;
ie_tipo_peticao_w		pls_formulario.ie_tipo_peticao%type;
vl_pedido_w			pls_formulario.vl_pedido%type;


BEGIN
if (ie_impug_nova_p = 'N') then

	begin
		select	a.ie_tipo_defesa, /* Domínio 2531 */
			b.nr_sequencia,
			c.nr_sequencia,
			coalesce(c.ie_status_pagamento,'S'),
			coalesce(c.ie_tipo_impugnacao,'C')
		into STRICT	ie_tipo_defesa_w,
			nr_seq_impugnacao_w,
			nr_seq_conta_w,
			ie_status_pagamento_w,
			ie_tipo_impugnacao_w
		from	pls_processo_conta	c,
			pls_impugnacao		b,
			pls_impugnacao_defesa	a
		where	a.nr_sequencia		= nr_seq_defesa_p
		and	a.nr_seq_impugnacao	= b.nr_sequencia
		and	b.nr_seq_conta		= c.nr_sequencia;
	exception
	when others then
		ie_tipo_defesa_w 	:= null;
		nr_seq_impugnacao_w	:= null;
		nr_seq_conta_w		:= null;
		ie_status_pagamento_w	:= null;
		ie_tipo_impugnacao_w	:= null;
	end;
else

	begin
	select	a.ie_tipo_defesa, /* Domínio 2531 */
		b.nr_sequencia,
		c.nr_sequencia,
		coalesce(c.ie_status_pagamento,'S'),
		coalesce(c.ie_tipo_impugnacao,'C'),
		b.ie_tipo_peticao,
		vl_pedido
	into STRICT	ie_tipo_defesa_w,
		nr_seq_impugnacao_w,
		nr_seq_conta_w,
		ie_status_pagamento_w,
		ie_tipo_impugnacao_w,
		ie_tipo_peticao_w,
		vl_pedido_w
	from	pls_formulario_defesa a,
		pls_formulario b,
		pls_processo_conta c
	where	a.nr_sequencia		= nr_seq_defesa_p
	and	a.nr_seq_formulario	= b.nr_sequencia
	and	b.nr_seq_conta		= c.nr_sequencia;
	exception
	when others then
		ie_tipo_defesa_w 	:= null;
		nr_seq_impugnacao_w	:= null;
		nr_seq_conta_w		:= null;
		ie_status_pagamento_w	:= null;
		ie_tipo_impugnacao_w	:= null;
		ie_tipo_peticao_w	:= null;
		vl_pedido_w		:= null;
	end;

	if (ie_tipo_peticao_w = '2') then
		update	pls_formulario
		set	ie_status_impugnacao	= 'C'
		where	ie_tipo_peticao 	= '1'
		and	nr_seq_conta		= nr_seq_conta_w;
	end if;
end if;

if (ie_tipo_defesa_w       = 'I') then /* Quando o tipo de defesa for "IMPUGNAÇÃO" */
	ie_status_defesa_w      := 'A'; /* Mudar o status da defesa para Aguardando deferimento */
	ie_status_impugnacao_w  := 'E'; /* Mudar o status da impugnação para " impugnação encaminhada" */
	ie_status_conta_w       := 'A'; /* Mudar o status da conta para "Em tramite administrativo" */
	ie_instancia_conta_w    := 'P'; /* Mudar a instancia da conta para "Primeira (administrativa)" */
elsif (ie_tipo_defesa_w       = 'R') then /* Quando o tipo de defesa for "RECURSO" */
	ie_status_defesa_w      := 'A'; /* Mudar o status da defesa para Aguardando deferimento */
	ie_status_impugnacao_w  := 'C'; /* Mudar o status da impugnação para " Recurso encaminhado" */
	ie_status_conta_w       := 'A'; /* Mudar o status da conta para "Em tramite administrativo" */
	ie_instancia_conta_w    := 'S'; /* Mudar a instancia da conta para "Segunda (administrativa)" */
elsif (ie_tipo_defesa_w       = 'A') then /* Quando o tipo de defesa for "RE-APRESENTAÇÃO" */
	ie_status_defesa_w      := 'A'; /* Mudar o status da defesa para Aguardando deferimento */
	ie_status_impugnacao_w  := 'C'; /* Mudar o status da impugnação para " Recurso encaminhado" */
	ie_status_conta_w       := 'A'; /* Mudar o status da conta para "Em tramite administrativo" */
	ie_instancia_conta_w    := 'T'; /* Mudar a instancia da conta para "Terceira (administrativa)" */
elsif (ie_tipo_defesa_w       = 'J') then /* Quando o tipo de defesa for "AÇÃO JUDICIAL" */
	ie_status_defesa_w      := 'A'; /* Mudar o status da defesa para Aguardando deferimento */
	ie_status_impugnacao_w  := 'D'; /* Mudar o status da impugnação para " Encaminhado ao Jurídico" */
	ie_status_conta_w       := 'J'; /* Mudar o status da conta para "Em tramite Judicial" */
	ie_instancia_conta_w    := 'J'; /* Mudar a instancia da conta para "Instancia Judicial" */
end if;

if (ie_tipo_defesa_w IS NOT NULL AND ie_tipo_defesa_w::text <> '') then

	if (ie_tipo_impugnacao_w = 'P') and (ie_impug_nova_p = 'N')then

		select	coalesce(sum(vl_procedimento),0)
		into STRICT	vl_procedimentos_w
		from	pls_processo_procedimento a
		where	a.nr_seq_conta	= nr_seq_conta_w;

		select	coalesce(sum(b.vl_liberado),0)
		into STRICT	vl_proc_liberado_w
		from	pls_impugnacao_proc b,
			pls_processo_procedimento a
		where	a.nr_sequencia	= b.nr_seq_processo_proc
		and	a.nr_seq_conta	= nr_seq_conta_w;

		select	coalesce(sum(vl_procedimento),0)
		into STRICT	vl_proc_ressarcir_w
		from	pls_processo_procedimento a
		where	a.nr_seq_conta	= nr_seq_conta_w
		and	not exists (SELECT	1
					from	pls_impugnacao_proc x
					where	x.nr_seq_processo_proc	= a.nr_sequencia);

		vl_ressarcir_w	:= vl_proc_ressarcir_w + vl_proc_liberado_w;
		vl_pendente_w	:= vl_procedimentos_w - vl_proc_ressarcir_w - vl_proc_liberado_w;
	else
		vl_pendente_w	:= pls_conta_processo_obter_valor(nr_seq_conta_w);
	end if;

	--	Andre	 16/10/2014, OS 781516,  deixado apenas o campo ie_instancia_conta como solicitado nesta os
	update	pls_processo_conta
	set	ie_instancia_conta	= ie_instancia_conta_w,
		ie_status_conta		= ie_status_conta_w,
		vl_ressarcir		= coalesce(vl_pedido_w,vl_ressarcir)
	where	nr_sequencia		= nr_seq_conta_w;
	--fim alteracao
	if (ie_impug_nova_p = 'N') then
		update	pls_impugnacao
		set	ie_status_impugnacao	= ie_status_impugnacao_w
		where	nr_sequencia		= nr_seq_impugnacao_w;

		update	pls_impugnacao_defesa
		set	ie_status		= ie_status_defesa_w,
			dt_liberacao		= clock_timestamp(),
			nm_usuario_lib		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p
		where	nr_sequencia		= nr_seq_defesa_p;
	else
		update	pls_formulario
		set	ie_status_impugnacao	= ie_status_impugnacao_w
		where	nr_sequencia		= nr_seq_impugnacao_w;

		update	pls_formulario_defesa
		set	ie_status		= ie_status_defesa_w,
			dt_liberacao		= clock_timestamp(),
			nm_usuario_lib		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p
		where	nr_sequencia		= nr_seq_defesa_p;
	end if;

	insert into pls_processo_alteracao(	nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_seq_conta,
						ie_status_impugnacao,
						ie_status_conta,
						ie_instancia_conta,
						ie_status_pagamento,
						vl_deferido,
						vl_pendente,
						vl_ressarcir,
						ds_acao)
					values (	nextval('pls_processo_alteracao_seq'),
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_conta_w,
						ie_status_impugnacao_w,
						ie_status_conta_w,
						ie_instancia_conta_w,
						ie_status_pagamento_w,
						0,
						pls_conta_processo_obter_valor(nr_seq_conta_w),
						0,
						'Liberar defesa');
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_liberar_defesa ( nr_seq_defesa_p bigint, ie_impug_nova_p text, nm_usuario_p text) FROM PUBLIC;

