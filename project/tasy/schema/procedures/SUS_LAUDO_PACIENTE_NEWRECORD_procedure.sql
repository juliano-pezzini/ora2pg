-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_laudo_paciente_newrecord ( nr_atendimento_p bigint, nm_usuario_p text, nr_laudo_sus_entrada_p bigint, nr_laudo_sus_saida_p INOUT bigint, cd_doenca_cid_p INOUT text, cd_topografia_p INOUT text, cd_morfologia_p INOUT text, cd_grau_histo_p INOUT text, cd_estadiamento_p INOUT text, cd_medico_p INOUT text, ie_lifonodos_reg_inval_p INOUT text) AS $body$
DECLARE

 
ds_mensagem_w			varchar(255);
ds_localizacao_metastase_w	varchar(4000);					
dt_diag_histopatologico_w	timestamp;
cd_procedimento_w		bigint;
ie_finalidade_w			varchar(3);
cd_medico_resp_w		varchar(10);


BEGIN 
 
if (nr_atendimento_p = 0) then 
	ds_mensagem_w	:= substr(obter_texto_tasy(15658, null),1,255);
	CALL wheb_mensagem_pck.exibir_mensagem_abort(223158,'MENSAGEM='||ds_mensagem_w);
end if;
 
SELECT * FROM Sus_Obter_Dados_Tumor(nr_atendimento_p, nm_usuario_p, cd_doenca_cid_p, cd_topografia_p, cd_morfologia_p, cd_grau_histo_p, cd_estadiamento_p, cd_medico_p, ie_lifonodos_reg_inval_p, dt_diag_histopatologico_w, ds_localizacao_metastase_w, cd_procedimento_w, ie_finalidade_w, cd_medico_resp_w) INTO STRICT cd_doenca_cid_p, cd_topografia_p, cd_morfologia_p, cd_grau_histo_p, cd_estadiamento_p, cd_medico_p, ie_lifonodos_reg_inval_p, dt_diag_histopatologico_w, ds_localizacao_metastase_w, cd_procedimento_w, ie_finalidade_w, cd_medico_resp_w;
 
if (coalesce(nr_laudo_sus_entrada_p::text, '') = '') then	 
	select	coalesce(max(NR_LAUDO_SUS),0) + 1 
	into STRICT	nr_laudo_sus_saida_p 
	from	sus_laudo_paciente 
	where	nr_Atendimento = nr_atendimento_p;
else 
	nr_laudo_sus_saida_p	:= nr_laudo_sus_entrada_p;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_laudo_paciente_newrecord ( nr_atendimento_p bigint, nm_usuario_p text, nr_laudo_sus_entrada_p bigint, nr_laudo_sus_saida_p INOUT bigint, cd_doenca_cid_p INOUT text, cd_topografia_p INOUT text, cd_morfologia_p INOUT text, cd_grau_histo_p INOUT text, cd_estadiamento_p INOUT text, cd_medico_p INOUT text, ie_lifonodos_reg_inval_p INOUT text) FROM PUBLIC;

