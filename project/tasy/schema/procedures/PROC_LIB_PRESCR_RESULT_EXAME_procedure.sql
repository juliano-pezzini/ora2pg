-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE proc_lib_prescr_result_exame ( nr_atendimento_p bigint, cd_grupo_procedimento_p bigint, cd_especialidade_proced_p bigint, cd_area_procedimento_p bigint, cd_procedimento_p bigint, nr_seq_proc_interno_p bigint, ie_libera_resultado_p INOUT text, ds_mensagem_p INOUT text) AS $body$
DECLARE


qt_resultado_w				exame_lab_result_item.qt_resultado%type;
ds_resultado_w				exame_lab_result_item.ds_resultado%type;
pr_resultado_w				exame_lab_result_item.pr_resultado%type;
nr_seq_exame_w				exame_lab_result_item.nr_seq_exame%type;
ie_resultado_w				varchar(1) := 'S';
ie_retorno_w				varchar(1) := 'S';
ds_mensagem_w				varchar(2000) := '';

c01 CURSOR FOR
	SELECT	distinct b.qt_resultado,
		b.ds_resultado,
		b.pr_resultado,
		b.nr_seq_exame
	from	exame_lab_resultado a,
		exame_lab_result_item b
	where	a.nr_seq_resultado = b.nr_seq_resultado
		and a.nr_atendimento = nr_atendimento_p
		and a.dt_resultado in (
		SELECT	max(c.dt_resultado)
		from exame_lab_resultado c,
			exame_lab_result_item d
		where	c.nr_seq_resultado = d.nr_seq_resultado
			and c.nr_atendimento = a.nr_atendimento
			and d.nr_seq_exame = b.nr_seq_exame
			and c.dt_resultado > clock_timestamp() - interval '7 days');

BEGIN

	open c01;
		loop
		fetch c01 into
      			qt_resultado_w,
			ds_resultado_w,
			pr_resultado_w,
			nr_seq_exame_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */

		begin

			if (qt_resultado_w IS NOT NULL AND qt_resultado_w::text <> '') then
				select	coalesce(CASE WHEN max(coalesce(b.ie_permite_justificar,'N'))='S' THEN 'J'  ELSE max(coalesce(b.ie_permite_justificar,'N')) END ,'S'),
					max(b.ds_mensagem)
				into STRICT	ie_resultado_w,
					ds_mensagem_w
				from	proc_exame_lab_result a,
					reg_proc_exame_result b
				where	a.nr_sequencia = b.nr_seq_proc_result
					and b.nr_seq_exame = nr_seq_exame_w
					and b.ie_formato_resultado = 'V'
					and coalesce(a.cd_grupo_proc,cd_grupo_procedimento_p) = cd_grupo_procedimento_p
					and coalesce(a.cd_especialidade,cd_especialidade_proced_p) = cd_especialidade_proced_p
					and coalesce(a.cd_area_procedimento,cd_area_procedimento_p) = cd_area_procedimento_p
					and coalesce(a.cd_procedimento,cd_procedimento_p) = cd_procedimento_p
					and coalesce(a.nr_seq_proc_interno,nr_seq_proc_interno_p) = nr_seq_proc_interno_p
					and qt_resultado_w not between coalesce(qt_minima,-9999) and coalesce(qt_maxima,9999);

			elsif (pr_resultado_w IS NOT NULL AND pr_resultado_w::text <> '') then
				select	coalesce(CASE WHEN max(coalesce(b.ie_permite_justificar,'N'))='S' THEN 'J'  ELSE max(coalesce(b.ie_permite_justificar,'N')) END ,'S'),
					max(b.ds_mensagem)
				into STRICT	ie_resultado_w,
					ds_mensagem_w
				from	proc_exame_lab_result a,
					reg_proc_exame_result b
				where	a.nr_sequencia = b.nr_seq_proc_result
					and b.nr_seq_exame = nr_seq_exame_w
					and b.ie_formato_resultado = 'P'
					and coalesce(a.cd_grupo_proc,cd_grupo_procedimento_p) = cd_grupo_procedimento_p
					and coalesce(a.cd_especialidade,cd_especialidade_proced_p) = cd_especialidade_proced_p
					and coalesce(a.cd_area_procedimento,cd_area_procedimento_p) = cd_area_procedimento_p
					and coalesce(a.cd_procedimento,cd_procedimento_p) = cd_procedimento_p
					and coalesce(a.nr_seq_proc_interno,nr_seq_proc_interno_p) = nr_seq_proc_interno_p
					and pr_resultado_w not between coalesce(qt_percent_min,-9999) and coalesce(qt_percent_max,9999);

			elsif (ds_resultado_w IS NOT NULL AND ds_resultado_w::text <> '') then
				select	coalesce(CASE WHEN max(coalesce(b.ie_permite_justificar,'N'))='S' THEN 'J'  ELSE max(coalesce(b.ie_permite_justificar,'N')) END ,'S'),
					max(b.ds_mensagem)
				into STRICT 	ie_resultado_w,
					ds_mensagem_w
				from 	proc_exame_lab_result a,
					reg_proc_exame_result b
				where 	a.nr_sequencia = b.nr_seq_proc_result
					and nr_seq_exame = nr_seq_exame_w
					and b.ie_formato_resultado = 'D'
					and coalesce(a.cd_grupo_proc,cd_grupo_procedimento_p) = cd_grupo_procedimento_p
					and coalesce(a.cd_especialidade,cd_especialidade_proced_p) = cd_especialidade_proced_p
					and coalesce(a.cd_area_procedimento,cd_area_procedimento_p) = cd_area_procedimento_p
					and coalesce(a.cd_procedimento,cd_procedimento_p) = cd_procedimento_p
					and coalesce(a.nr_seq_proc_interno,nr_seq_proc_interno_p) = nr_seq_proc_interno_p
					and upper(trim(both ds_resultado)) != upper(trim(both ds_resultado_w));
			end if;

			if (ie_resultado_w = 'J') then
				ie_retorno_w := ie_resultado_w;
				ds_mensagem_p := ds_mensagem_w;
			elsif (ie_resultado_w = 'N') then
				ie_retorno_w := ie_resultado_w;
				ds_mensagem_p := ds_mensagem_w;
				exit;
			end if;

		end;
		end loop;
		close c01;

	ie_libera_resultado_p := coalesce(ie_retorno_w,'S');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proc_lib_prescr_result_exame ( nr_atendimento_p bigint, cd_grupo_procedimento_p bigint, cd_especialidade_proced_p bigint, cd_area_procedimento_p bigint, cd_procedimento_p bigint, nr_seq_proc_interno_p bigint, ie_libera_resultado_p INOUT text, ds_mensagem_p INOUT text) FROM PUBLIC;

