-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_ordem_servico_planej (nr_seq_regra_planej_p bigint default 0) AS $body$
DECLARE


dt_aquisicao_w				timestamp;
dt_programacao_w			timestamp;
dt_emissao_prev_w			timestamp;
dt_prevista_w				timestamp;
dt_ordem_servico_w			timestamp	:= clock_timestamp();
dt_ultima_ordem_w			timestamp;
ie_dt_inicio_geracao_w		varchar(1);
ie_fixo_data_w				varchar(1);
nr_seq_equip_w				bigint;
nr_seq_ult_os_prev_w		bigint;
nr_seq_planej_w				bigint;
nr_sequencia_w				bigint;
qt_dia_freq_w				smallint;
qt_dia_ordem_w				smallint;
ie_dia_ultima_verif_w		varchar(1);
qt_reg_w					bigint;
ie_qt_dia_ant_inicio_w		varchar(255);
ie_consid_prev_manual_w		varchar(255) := 'N';
ie_converter_mes_w			varchar(1);

C01 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.qt_dia_gerar_ordem,
		b.nr_sequencia,
		c.qt_dia,
		b.dt_aquisicao,
		b.dt_prog_preventiva,
		coalesce(a.ie_data_inicio_geracao,'F'),
		coalesce(a.ie_dia_ultima_verif,'E'),
		c.ie_converter_mes
	from	man_localizacao d,
		man_freq_planej c,
		man_equipamento b,
		man_planej_prev a
	where	a.nr_seq_tipo_equip = b.nr_seq_tipo_equip
	and	a.nr_seq_frequencia = c.nr_sequencia
	and	b.nr_seq_local = d.nr_sequencia
	and	coalesce(a.dt_inicial,clock_timestamp()) - CASE WHEN coalesce(ie_qt_dia_ant_inicio_w,'S')='S' THEN a.qt_dia_previsto  ELSE 0 END  <= clock_timestamp()
	and (coalesce(c.ie_fixo_data,'N') = 'N' or man_obter_se_gera_os_fixo(a.nr_sequencia,clock_timestamp(),b.nr_sequencia,null) = 'S')
	and	coalesce(a.ie_situacao,'A') = 'A'
	and	coalesce(b.ie_situacao,'A') = 'A'
	and	coalesce(a.ie_contador,'N') = 'N'
	and (coalesce(a.ie_impacto,'T') = 'T' or a.ie_impacto = coalesce(b.cd_impacto,a.ie_impacto))
	and	coalesce(b.nr_seq_marca,0) = coalesce(a.nr_seq_marca,coalesce(b.nr_seq_marca,0))
	and	coalesce(b.nr_seq_modelo,0) = coalesce(a.nr_seq_modelo,coalesce(b.nr_seq_modelo,0))
	and	coalesce(b.cd_estab_contabil,0) = coalesce(a.cd_estabelecimento, coalesce(b.cd_estab_contabil,0))
	and 	d.cd_setor = coalesce(a.cd_setor_atendimento,d.cd_setor)
	and	b.nr_sequencia = coalesce(a.nr_seq_equip,b.nr_sequencia)
	and (a.nr_sequencia = nr_seq_regra_planej_p or coalesce(nr_seq_regra_planej_p,0) = 0)
	and (coalesce(a.nr_seq_superior::text, '') = '' or coalesce(man_obter_sobrepos_planej(a.nr_sequencia,b.nr_sequencia),'N') = 'N')
	and	not exists (
		SELECT	1
		from	man_planej_prev x
		where	b.nr_sequencia	= x.nr_seq_equip
		and	coalesce(x.ie_situacao,'A') = 'A'
		and	coalesce(a.nr_seq_equip::text, '') = '')
	and	not exists (
		select	1
		from	unidade_atend_prev y
		where	y.nr_seq_planej = a.nr_sequencia)
	and 	not exists (
		select	1
		from	man_planej_prev_equip_excl x
		where	x.nr_seq_equipamento = b.nr_sequencia
		and	x.nr_seq_planej_prev = a.nr_sequencia)
	order by 1, 4;


BEGIN
ie_qt_dia_ant_inicio_w := obter_param_usuario(298, 90, obter_perfil_ativo, coalesce(wheb_usuario_pck.get_nm_usuario,'Job'), wheb_usuario_pck.get_cd_estabelecimento, ie_qt_dia_ant_inicio_w);
ie_consid_prev_manual_w := obter_param_usuario(298, 103, obter_perfil_ativo, coalesce(wheb_usuario_pck.get_nm_usuario,'Job'), wheb_usuario_pck.get_cd_estabelecimento, ie_consid_prev_manual_w);

open C01;
loop
fetch C01 into
	nr_seq_planej_w,
	qt_dia_ordem_w,
	nr_seq_equip_w,
	qt_dia_freq_w,
	dt_aquisicao_w,
	dt_programacao_w,
	ie_dt_inicio_geracao_w,
	ie_dia_ultima_verif_w,
	ie_converter_mes_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_seq_ult_os_prev_w
	from	man_ordem_servico
	where	nr_seq_equipamento = nr_seq_equip_w
	and	coalesce(nr_seq_planej,nr_seq_planej_w) = nr_seq_planej_w
	and	ie_tipo_ordem = 2;

	if (coalesce(ie_dt_inicio_geracao_w,'F') = 'P') and (coalesce(ie_consid_prev_manual_w,'N') = 'N') then
		begin
		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_ult_os_prev_w
		from	man_ordem_servico
		where	nr_seq_equipamento = nr_seq_equip_w
		and	nr_seq_planej = nr_seq_planej_w
		and	ie_tipo_ordem = 2;
		end;
	end if;

	if (nr_seq_ult_os_prev_w = 0) then
		begin
		if (coalesce(ie_dt_inicio_geracao_w,'F') = 'F') then
			begin
			dt_prevista_w		:= clock_timestamp() - interval '1000 days';
			dt_emissao_prev_w	:= clock_timestamp() - interval '1000 days';
			end;
		elsif (ie_dt_inicio_geracao_w = 'A') and (dt_aquisicao_w IS NOT NULL AND dt_aquisicao_w::text <> '') then
			begin
			dt_prevista_w		:= obter_data_prev_futura(dt_aquisicao_w, qt_dia_freq_w, ie_converter_mes_w);
			dt_emissao_prev_w	:= dt_prevista_w - qt_dia_ordem_w;
			end;
		elsif (ie_dt_inicio_geracao_w = 'P') and (dt_programacao_w IS NOT NULL AND dt_programacao_w::text <> '') then
			begin
			dt_prevista_w		:= obter_data_prev_futura(dt_programacao_w, qt_dia_freq_w, ie_converter_mes_w);
			dt_emissao_prev_w	:= dt_prevista_w - qt_dia_ordem_w;
			end;
		end if;
		end;
	else
		begin
		if (coalesce(ie_dia_ultima_verif_w,'E') = 'E') then
			select	coalesce(dt_fim_real,clock_timestamp() + interval '1000 days')
			into STRICT 	dt_ultima_ordem_w
			from 	man_ordem_servico
			where 	nr_sequencia = nr_seq_ult_os_prev_w;
		elsif (ie_dia_ultima_verif_w = 'G') then
			select	coalesce(dt_ordem_servico,clock_timestamp() + interval '1000 days')
			into STRICT 	dt_ultima_ordem_w
			from 	man_ordem_servico
			where 	nr_sequencia = nr_seq_ult_os_prev_w;
		elsif (ie_dia_ultima_verif_w = 'I') then
			select	coalesce(dt_inicio_desejado,clock_timestamp() + interval '1000 days')
			into STRICT 	dt_ultima_ordem_w
			from 	man_ordem_servico
			where 	nr_sequencia = nr_seq_ult_os_prev_w;
		end if;

		dt_prevista_w		:= obter_data_prev_futura(dt_ultima_ordem_w, qt_dia_freq_w, ie_converter_mes_w);
		dt_emissao_prev_w		:= dt_prevista_w - qt_dia_ordem_w;
		end;
	end if;

	select	man_obter_se_gera_os_fixo(nr_seq_planej_w,clock_timestamp(),nr_seq_equip_w,dt_emissao_prev_w)
	into STRICT	ie_fixo_data_w
	;

	if (ie_fixo_data_w = 'N') then
		begin
		nr_sequencia_w	:= 0;

		if (trunc(clock_timestamp()) >= trunc(dt_emissao_prev_w)) then
			nr_sequencia_w := man_gerar_os_planejada(nr_seq_equip_w, nr_seq_planej_w, dt_ordem_servico_w, obter_desc_expressao(329579)/*'Planej'*/
, nr_sequencia_w, 'S');
		end if;

		CALL man_gravar_log_geracao_os_prev(nr_seq_planej_w,nr_seq_equip_w,nr_sequencia_w);
		end;
	else
		begin
		select	count(*)
		into STRICT	qt_reg_w
		from	man_planej_prev_log
		where	trunc(dt_atualizacao_nrec) = trunc(clock_timestamp())
		and	coalesce(nr_seq_ordem_servico,0) > 0
		and	nr_seq_equipamento = nr_seq_equip_w
		and	nr_seq_planej = nr_seq_planej_w;

		if (qt_reg_w = 0) then
			CALL man_gerar_os_planejada_fixo(nr_seq_equip_w,nr_seq_planej_w,'PlanejFixo',dt_emissao_prev_w);
		else
			CALL man_gravar_log_geracao_os_prev(nr_seq_planej_w,nr_seq_equip_w,0);
		end if;
		end;
	end if;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_ordem_servico_planej (nr_seq_regra_planej_p bigint default 0) FROM PUBLIC;

