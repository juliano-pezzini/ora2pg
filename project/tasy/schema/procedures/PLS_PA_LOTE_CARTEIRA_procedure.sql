-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_pa_lote_carteira ( nr_seq_regra_p pls_ap_regra_carteira.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

--Objeto para geração do lote automatizado de emissão de carteira
pls_ap_regra_carteira_w		pls_ap_regra_carteira%rowtype;
nr_seq_lote_w			pls_lote_carteira.nr_sequencia%type;

procedure aprovar_solic_carteiras is
C01 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_solic_carteira_adic
	where	ie_status	= 0;
BEGIN
for r_c01_w in C01 loop
	begin
	CALL pls_aprov_rejeit_solic_cart(r_c01_w.nr_sequencia, 'A', null, null, nm_usuario_p);
	end;
end loop;
end;

begin
select	*
into STRICT	pls_ap_regra_carteira_w
from	pls_ap_regra_carteira
where	nr_sequencia	= nr_seq_regra_p;

if (pls_ap_regra_carteira_w.ie_tipo_solicitacao = 'W') then
	aprovar_solic_carteiras; --Aprovar as solicitações de via adicional realizadas pelo beneficiário no portal web
end if;

insert	into	pls_lote_carteira(	nr_sequencia, cd_estabelecimento, dt_atualizacao,
		nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
		ie_tipo_lote, nr_via_inicial, nr_via_final,
		ie_tipo_data, ie_tipo_pessoa, ie_tipo_pagador,
		ie_tipo_solicitacao, ie_tipo_beneficiario, ie_tipo_contrato,
		ie_situacao, ie_situacao_atend, ie_destino_correspondencia,
		nr_seq_destino_corresp, ds_observacao )
	values (	nextval('pls_lote_carteira_seq'), pls_ap_regra_carteira_w.cd_estabelecimento, clock_timestamp(),
		nm_usuario_p, clock_timestamp(), nm_usuario_p,
		pls_ap_regra_carteira_w.ie_tipo_lote, pls_ap_regra_carteira_w.nr_via_inicial, pls_ap_regra_carteira_w.nr_via_final,
		pls_ap_regra_carteira_w.ie_tipo_data, pls_ap_regra_carteira_w.ie_tipo_pessoa, pls_ap_regra_carteira_w.ie_tipo_pagador,
		pls_ap_regra_carteira_w.ie_tipo_solicitacao, pls_ap_regra_carteira_w.ie_tipo_beneficiario, pls_ap_regra_carteira_w.ie_tipo_contrato,
		'P', 'T', pls_ap_regra_carteira_w.ie_destino_correspondencia,
		pls_ap_regra_carteira_w.nr_seq_destino_corresp, pls_ap_regra_carteira_w.ds_observacao )
	returning nr_sequencia into nr_seq_lote_w;

CALL pls_gerar_lote_carteira(nr_seq_lote_w, 'P', clock_timestamp(), 'S', nm_usuario_p, pls_ap_regra_carteira_w.ie_tipo_data, pls_ap_regra_carteira_w.cd_estabelecimento);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pa_lote_carteira ( nr_seq_regra_p pls_ap_regra_carteira.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

