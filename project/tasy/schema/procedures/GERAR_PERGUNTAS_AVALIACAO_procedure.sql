-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_perguntas_avaliacao ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_tipo_aval_w			bigint;
nr_seq_pergunta_w			bigint;
nr_seq_grupo_pergunta_w		bigint;
nr_seq_apresentacao_w		bigint;
nr_seq_nota_item_w		bigint;
cd_cnpj_w			varchar(14);
ie_gera_nota_padrao_w		varchar(15);
ie_lib_aval_dinamica_w		varchar(1);

c00 CURSOR FOR
SELECT	nr_sequencia
from	avf_grupo_pergunta
where	nr_sequencia in (
	SELECT	distinct
		a.nr_seq_grupo_pergunta
	from	avf_pergunta a
	where	a.nr_seq_tipo_aval = nr_seq_tipo_aval_w
	and	a.ie_situacao = 'A'
	and not exists (
		select	1
		from	avf_resultado_item x,
			avf_resultado y
		where	y.nr_sequencia	= x.nr_seq_resultado
		and	x.nr_seq_pergunta 	= a.nr_sequencia
		and	y.nr_sequencia	= nr_sequencia_p
		and	y.cd_cnpj		= cd_cnpj_w))
order by nr_sequencia;

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.nr_seq_nota_item
from	avf_pergunta a
where	a.nr_seq_tipo_aval = nr_seq_tipo_aval_w
and	a.ie_situacao = 'A'
and	a.nr_seq_grupo_pergunta = nr_seq_grupo_pergunta_w
and not exists (
	SELECT	1
	from	avf_resultado_item x,
		avf_resultado y
	where	y.nr_sequencia	= x.nr_seq_resultado
	and	x.nr_seq_pergunta 	= a.nr_sequencia
	and	y.nr_sequencia	= nr_sequencia_p
	and	y.cd_cnpj		= cd_cnpj_w)
order by a.nr_seq_apresentacao;


BEGIN

delete from avf_resultado_item
where nr_seq_resultado = nr_sequencia_p;

ie_gera_nota_padrao_w := obter_param_usuario(6, 58, obter_perfil_Ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_gera_nota_padrao_w);
ie_lib_aval_dinamica_w := obter_param_usuario(270, 98, obter_perfil_Ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_lib_aval_dinamica_w);

select	nr_seq_tipo_aval,
	cd_cnpj
into STRICT	nr_seq_tipo_aval_w,
	cd_cnpj_w
from	avf_resultado
where	nr_sequencia = nr_sequencia_p;

open C00;
loop
fetch C00 into
	nr_seq_grupo_pergunta_w;
EXIT WHEN NOT FOUND; /* apply on C00 */
	begin

	select	coalesce(max(nr_seq_apresentacao), 0) +1
	into STRICT	nr_seq_apresentacao_w
	from	avf_resultado_item
	where	nr_seq_resultado = nr_sequencia_p;

	insert into avf_resultado_item(
		nr_sequencia,
		nr_seq_apresentacao,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_resultado,
		nr_seq_grupo_pergunta,
		nr_seq_nota_item)
	values (nextval('avf_resultado_item_seq'),
		nr_seq_apresentacao_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_sequencia_p,
		nr_seq_grupo_pergunta_w,
		null);

	open C01;
	loop
	fetch C01 into
		nr_seq_pergunta_w,
		nr_seq_nota_item_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		select	coalesce(max(nr_seq_apresentacao), 0) +1
		into STRICT	nr_seq_apresentacao_w
		from	avf_resultado_item
		where	nr_seq_resultado = nr_sequencia_p;

		insert into avf_resultado_item(
			nr_sequencia,
			nr_seq_apresentacao,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_resultado,
			nr_seq_pergunta,
			nr_seq_nota_item)
		values (nextval('avf_resultado_item_seq'),
			nr_seq_apresentacao_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_sequencia_p,
			nr_seq_pergunta_w,
			CASE WHEN ie_gera_nota_padrao_w='N' THEN null  ELSE nr_seq_nota_item_w END );
		end;
	end loop;
	close C01;
	end;
end loop;
close C00;

if (ie_lib_aval_dinamica_w = 'S') then
	update	avf_resultado
	set	dt_liberacao = clock_timestamp(),
		dt_atualizacao = clock_timestamp(),
		nm_usuario = nm_usuario_p
	where	nr_sequencia = nr_sequencia_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_perguntas_avaliacao ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

