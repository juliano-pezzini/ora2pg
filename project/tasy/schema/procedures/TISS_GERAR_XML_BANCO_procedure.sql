-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_gerar_xml_banco (cd_estabelecimento_p bigint, cd_funcao_ativa_p bigint, nm_usuario_p text, ie_tipo_tiss_p text, nr_seq_outorgante_p bigint, cd_convenio_p bigint, nr_seq_xml_projeto_p INOUT bigint, nr_seq_tiss_log_p INOUT bigint, nm_arquivo_p INOUT text, dt_mesano_referencia_p timestamp default clock_timestamp(), nr_atendimento_p bigint default 0, nr_seq_autorizacao_p bigint default 0, nr_sequencia_autor_p bigint default 0, nr_seq_protocolo_p bigint default 0, nr_seq_med_prot_p bigint default 0, nr_seq_retorno_p bigint default 0, nr_protocolo_receb_p bigint default 0, ie_tipo_demostrativo_p bigint default 0, nr_seq_prot_situacao_p bigint default 0, ie_tiss_tipo_guia_p text default '0', nr_seq_prot_guia_p bigint default 0, nr_seq_eleg_p bigint default 0, nr_seq_lote_anexo_p bigint default 0, nr_seq_comunic_p bigint default 0, nr_seq_lote_reap_p bigint default 0, nr_seq_prot_receb_p bigint default 0, nr_seq_prot_rec_p bigint default 0, nr_seq_lote_hist_p bigint default 0, cd_prestador_p text default null, nr_seq_lote_p bigint default null, ds_tipo_transacao_p text default null, cd_prestador_bh_p text default null, ds_convenio_p text default null, nr_protocolo_p text default null, cd_cgc_convenio_p text default null, nr_nf_protocolo_p text default null, ie_calcula_hash_banco_p text default null, nr_seq_prot_cancel_p bigint default 0, nr_seq_rec_glosa_prot_cancel_p tiss_recurso_glosa_prot.nr_sequencia%type default null, nr_seq_rec_glosa_form_cancel_p tiss_recurso_glosa_guia.nr_sequencia%type default null, NR_SEQ_TISS_DOCUMENTO_P tiss_envio_documento.nr_sequencia%TYPE default null, NR_SEQ_TISS_PROT_ENVIO_RET_P tiss_protocolo_envio_ret.nr_sequencia%TYPE default null) AS $body$
DECLARE

		
/*
	nfcunha on 13/Fev/2020
	I removed every occurence of special characters and/or accentuation due to GitHub PLSQL repository Jenkins checks.
*/
nr_seq_trans_tiss_w	bigint;
nr_seq_tiss_log_w	bigint;
ds_xml_w		text := '';
ds_valor_xml_w		text;
texto_w			varchar(32767);
nr_registro_w              bigint;

ds_sql_w		varchar(255);
ds_hash_w		varchar(255) 	:= '';
ds_parametros_w		varchar(4000) 	:= '';
nm_arquivo_w		varchar(2000);
nm_arquivo_auxiliar_w		varchar(2000);
nr_lote_w		varchar(255);
cd_prestador_w		varchar(30);
nr_seq_envio_convenio_w	bigint;
retorno_w		integer;

ds_conteudo_1_w		varchar(32764);
ds_conteudo_2_w		varchar(32764);
ds_conteudo_3_w		varchar(32764);
ds_conteudo_4_w		varchar(32764);
ds_conteudo_5_w		varchar(32764);
ds_conteudo_6_w		varchar(32764);
ds_versao_xsd_w		varchar(20);

c001			integer;
c002			integer;

ds_namespace_w		tiss_parametros_convenio.ds_namespace%type;
ds_caracteres_xml_w	tiss_parametros_convenio.ds_caracteres_xml%type;
ie_data_trans_xml_w	tiss_parametros_convenio.ie_data_trans_xml%type;

c01 CURSOR FOR
SELECT 	*
from 	tiss_convenio
where 	cd_estabelecimento 		= cd_estabelecimento_p
and 	ie_tipo_tiss 			= ie_tipo_tiss_p
and 	coalesce(cd_convenio,cd_convenio_p) 	= cd_convenio_p
and 	((nr_seq_outorgante = nr_seq_outorgante_p) or (0 = nr_seq_outorgante_p))
and 	coalesce(coalesce(ie_tipo_convenio,OBTER_TIPO_CONVENIO(cd_convenio_p)),0) = coalesce(OBTER_TIPO_CONVENIO(cd_convenio_p),0)
and 	coalesce(dt_inicio_vigencia,clock_timestamp()) =
			(SELECT	coalesce(max(x.dt_inicio_vigencia),clock_timestamp())
			from	tiss_convenio x
			where	x.cd_estabelecimento = cd_estabelecimento_p
			and 	x.ie_tipo_tiss = ie_tipo_tiss_p
			and 	coalesce(x.cd_convenio,cd_convenio_p) = cd_convenio_p
			and	((x.nr_seq_outorgante = nr_seq_outorgante_p) or (0 = nr_seq_outorgante_p))
			and	coalesce(coalesce(x.ie_tipo_convenio,OBTER_TIPO_CONVENIO(cd_convenio_p)),0) = coalesce(OBTER_TIPO_CONVENIO(cd_convenio_p),0)
			and	coalesce(x.dt_inicio_vigencia,coalesce(dt_mesano_referencia_p,clock_timestamp())) <= coalesce(dt_mesano_referencia_p,clock_timestamp()))
order by coalesce(cd_convenio,0),
	dt_inicio_vigencia,
	coalesce(ie_tipo_convenio,0);

c01_w	c01%rowtype;


C02 CURSOR(nr_seq_log	tiss_log_xml.nr_seq_log_tiss%type) FOR
	SELECT	ds_xml
	from	tiss_log_xml
	where	nr_seq_log_tiss = nr_seq_log
	order by nr_sequencia;


C03 CURSOR(nr_seq_log	tiss_log_valor_xml.nr_seq_log_tiss%type) FOR
	SELECT	ds_valor_xml ds_xml
	from	tiss_log_valor_xml
	where	nr_seq_log_tiss = nr_seq_log
	order by nr_sequencia;

BEGIN

open C01;
loop
fetch C01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
end loop;
close C01;

if (c01_w.nr_seq_xml_projeto > 0) then

	select  max(ds_namespace),
		max(ds_caracteres_xml),
		max(ie_data_trans_xml)
	into STRICT	ds_namespace_w,
		ds_caracteres_xml_w,
		ie_data_trans_xml_w
	from    tiss_parametros_convenio
	where   cd_convenio          = cd_convenio_p
	and     cd_estabelecimento   = cd_estabelecimento_p;

	nr_seq_trans_tiss_w  := TISS_OBTER_SEQ_TRANSACAO(cd_estabelecimento_p, cd_convenio_p, nm_usuario_p, nr_seq_trans_tiss_w );

	select	nextval('tiss_log_seq')
	into STRICT	nr_seq_tiss_log_w
	;

	if (coalesce(nr_seq_trans_tiss_w,0) = 0) then
		nr_seq_trans_tiss_w := nr_seq_tiss_log_w;
	end if;

	ds_versao_xsd_w := 'tissV' || replace(to_char(c01_w.ie_versao_tiss), '.', '_') || '.xsd';
	
	CALL TISS_GERAR_LOG(nr_seq_tiss_log_w,cd_estabelecimento_p,cd_convenio_p,nm_usuario_p);

	
	ds_parametros_w	:= 'DT_MESANO_REFERENCIA='||to_char(coalesce(dt_mesano_referencia_p,clock_timestamp()),'dd/mm/yyyy')||';';

	ds_parametros_w	:= ds_parametros_w || 'NR_ATENDIMENTO=' 	|| to_char( nr_atendimento_p ) ||';';
	ds_parametros_w	:= ds_parametros_w || 'NR_SEQ_AUTORIZACAO=' 	|| to_char( nr_seq_autorizacao_p ) ||';';
	ds_parametros_w	:= ds_parametros_w || 'NR_SEQUENCIA_AUTOR=' 	|| to_char( nr_sequencia_autor_p ) ||';';
	ds_parametros_w	:= ds_parametros_w || 'CD_CONVENIO=' 		|| to_char( cd_convenio_p ) ||';';
	ds_parametros_w	:= ds_parametros_w || 'NR_SEQ_PROTOCOLO=' 	|| to_char( nr_seq_protocolo_p ) ||';';
	ds_parametros_w	:= ds_parametros_w || 'NR_SEQ_MED_PROT=' 	|| to_char( nr_seq_med_prot_p ) ||';';
	ds_parametros_w	:= ds_parametros_w || 'NR_SEQ_RETORNO=' 	|| to_char( nr_seq_retorno_p ) ||';';
	ds_parametros_w	:= ds_parametros_w || 'NR_PROTOCOLO_RECEB=' 	|| to_char( nr_protocolo_receb_p ) ||';';
	ds_parametros_w	:= ds_parametros_w || 'NR_SEQ_PROT_RECEB=' 	|| to_char( nr_seq_prot_receb_p ) ||';';
	ds_parametros_w	:= ds_parametros_w || 'NR_SEQ_PROT_REC=' 	|| to_char( nr_seq_prot_rec_p ) ||';';
	ds_parametros_w	:= ds_parametros_w || 'NR_SEQ_LOTE_HIST=' 	|| to_char( nr_seq_lote_hist_p ) ||';';
	ds_parametros_w	:= ds_parametros_w || 'IE_TIPO_DEMOSTRATIVO=' 	|| to_char( ie_tipo_demostrativo_p ) ||';';
	ds_parametros_w	:= ds_parametros_w || 'NR_SEQ_PROT_SITUACAO=' 	|| to_char( nr_seq_prot_situacao_p ) ||';';
	ds_parametros_w	:= ds_parametros_w || 'IE_TISS_TIPO_GUIA=' 	|| to_char( ie_tiss_tipo_guia_p ) ||';';
	ds_parametros_w	:= ds_parametros_w || 'NR_SEQ_PROT_GUIA=' 	|| to_char( nr_seq_prot_guia_p ) ||';';
	ds_parametros_w	:= ds_parametros_w || 'NR_SEQ_ELEG=' 		|| to_char( nr_seq_eleg_p ) ||';';
	ds_parametros_w	:= ds_parametros_w || 'NR_SEQ_LOTE_ANEXO=' 	|| to_char( nr_seq_lote_anexo_p ) ||';';
	ds_parametros_w	:= ds_parametros_w || 'NR_SEQ_COMUNIC=' 	|| to_char( nr_seq_comunic_p ) ||';';
	ds_parametros_w	:= ds_parametros_w || 'NR_SEQ_LOTE_REAP=' 	|| to_char( nr_seq_lote_reap_p ) ||';';
	ds_parametros_w	:= ds_parametros_w || 'NR_SEQ_TRANS_TISS=' 	|| to_char( nr_seq_trans_tiss_w ) ||';';
	ds_parametros_w	:= ds_parametros_w || 'DS_NAMESPACE=' 		|| to_char( ds_namespace_w ) ||';';
	ds_parametros_w	:= ds_parametros_w || 'DS_CARACTERES_XML=' 	|| to_char( ds_caracteres_xml_w ) ||';';

	ds_parametros_w	:= ds_parametros_w || 'CD_PRESTADOR='		||to_char(CD_PRESTADOR_P)||';';
	ds_parametros_w	:= ds_parametros_w || 'NR_SEQ_LOTE='		||to_char(NR_SEQ_LOTE_P)||';';
	ds_parametros_w	:= ds_parametros_w || 'DS_TIPO_TRANSACAO='	||to_char(DS_TIPO_TRANSACAO_P)||';';
	ds_parametros_w	:= ds_parametros_w || 'CD_PRESTADOR_BH='	||to_char(CD_PRESTADOR_BH_P)||';';
	ds_parametros_w	:= ds_parametros_w || 'DS_CONVENIO='		||to_char(DS_CONVENIO_P)||';';
	ds_parametros_w	:= ds_parametros_w || 'NR_PROTOCOLO='		||to_char(NR_PROTOCOLO_P)||';';
	ds_parametros_w	:= ds_parametros_w || 'CD_CGC_CONVENIO='	||to_char(CD_CGC_CONVENIO_P)||';';
	ds_parametros_w	:= ds_parametros_w || 'NR_NF_PROTOCOLO='	||to_char(NR_NF_PROTOCOLO_P)||';';
	ds_parametros_w	:= ds_parametros_w || 'CD_ESTABELECIMENTO='	||to_char(CD_ESTABELECIMENTO_P)||';';
	ds_parametros_w	:= ds_parametros_w || 'NR_SEQ_EVENTO_EXTERNO='	||to_char(c01_w.nr_seq_evento_externo)||';';
	ds_parametros_w	:= ds_parametros_w || 'NR_SEQ_PROT_CANCEL='	||to_char(nr_seq_prot_cancel_p)||';';
	ds_parametros_w := ds_parametros_w || 'DS_VERSAO_TISS='		||to_char(c01_w.ie_versao_tiss)||';';
	ds_parametros_w := ds_parametros_w || 'DS_VERSAO_XSD='		||to_char(ds_versao_xsd_w) ||';';
	ds_parametros_w := ds_parametros_w || 'NR_SEQ_REC_GLOSA_PROT_CANCEL=' || to_char(nr_seq_rec_glosa_prot_cancel_p) || ';';
	ds_parametros_w := ds_parametros_w || 'NR_SEQ_REC_GLOSA_GUIA_CANCEL=' || to_char(nr_seq_rec_glosa_form_cancel_p) || ';';
    ds_parametros_w := ds_parametros_w || 'NR_SEQ_TISS_DOCUMENTO=' || to_char(NR_SEQ_TISS_DOCUMENTO_P) || ';';
    ds_parametros_w := ds_parametros_w || 'NR_SEQ_TISS_PROT_ENVIO_RET=' || to_char(NR_SEQ_TISS_PROT_ENVIO_RET_P) || ';';

	if (ie_tipo_tiss_p = '7') and (nr_seq_protocolo_p > 0)  then
		
		
		update	tiss_protocolo_guia
		set	nr_seq_trans_tiss 	= nr_seq_trans_tiss_w,
			dt_transacao		= (SELECT	CASE WHEN coalesce(ie_data_trans_xml_w,'E')='E' THEN								coalesce(x.dt_envio,clock_timestamp())  ELSE coalesce(x.dt_mesano_referencia,clock_timestamp()) END 
						  from		protocolo_convenio x
						  where		x.nr_seq_protocolo = nr_seq_protocolo_p)
		where	nr_seq_protocolo 	= nr_seq_protocolo_p
		and	ie_tiss_tipo_guia	= ie_tiss_tipo_guia_p;
		
	end if;
	
	
	CALL WHEB_EXPORTAR_XML(c01_w.nr_seq_xml_projeto,nr_seq_tiss_log_w,'TISS',ds_parametros_w);

	
	dbms_lob.createtemporary(ds_xml_w, true, dbms_lob.session);
	dbms_lob.open(ds_xml_w, dbms_lob.lob_readwrite);
	
	for r_c02_w in C02(nr_seq_tiss_log_w) loop
		begin
		texto_w	:= r_c02_w.ds_xml;

		dbms_lob.append(ds_xml_w, texto_w);

		end;
	end loop;

	dbms_lob.createtemporary(ds_valor_xml_w, true, dbms_lob.session);
	dbms_lob.open(ds_valor_xml_w, dbms_lob.lob_readwrite);

	for r_c03_w in C03(nr_seq_tiss_log_w) loop
		begin
		texto_w	:= r_c03_w.ds_xml;

		dbms_lob.append(ds_valor_xml_w, texto_w);

		end;
	end loop;

	if	((octet_length(ds_valor_xml_w) > 0)
		and (octet_length(ds_xml_w) <= 32764))then

		if (coalesce(ie_calcula_hash_banco_p,'S') = 'S') then

			ds_hash_w := upper(RAWTOHEX(dbms_obfuscation_toolkit.md5(input => encode(ds_valor_xml_w::bytea, 'hex')::bytea)));
			dbms_lob.close(ds_valor_xml_w);
			dbms_lob.freetemporary(ds_valor_xml_w);

			ds_xml_w := replace(ds_xml_w, 'GERAR_HASH_MD5', ds_hash_w);
		end if;

		ds_conteudo_1_w := substr(ds_xml_w,32764,1);
		ds_conteudo_2_w := substr(ds_xml_w,32764,32765);
		ds_conteudo_3_w := substr(ds_xml_w,32764,65529);
		ds_conteudo_4_w := substr(ds_xml_w,32764,98293);
		ds_conteudo_5_w := substr(ds_xml_w,32764,131057);
		ds_conteudo_6_w := substr(ds_xml_w,32764,163821);

		ds_sql_w := ' update tiss_log set ds_xml = :ds_xml_w where nr_sequencia ='||nr_seq_tiss_log_w;
		c001 := DBMS_SQL.OPEN_CURSOR;
		DBMS_SQL.PARSE(c001, ds_sql_w, dbms_sql.Native);
		DBMS_SQL.BIND_VARIABLE(c001, 'DS_XML_W', ds_conteudo_1_w||ds_conteudo_2_w||ds_conteudo_3_w||ds_conteudo_4_w||ds_conteudo_5_w ||ds_conteudo_6_w);

		retorno_w := DBMS_SQL.EXECUTE(c001);
		DBMS_SQL.CLOSE_CURSOR(c001);
		ds_sql_w := ' update tiss_log set ds_xml_clob = :ds_xml_w where nr_sequencia ='||nr_seq_tiss_log_w;
		c002 := DBMS_SQL.OPEN_CURSOR;
		DBMS_SQL.PARSE(c002, ds_sql_w, dbms_sql.Native);
		DBMS_SQL.BIND_VARIABLE(c002, 'DS_XML_W', ds_conteudo_1_w||ds_conteudo_2_w||ds_conteudo_3_w||ds_conteudo_4_w||ds_conteudo_5_w ||ds_conteudo_6_w);
		retorno_w := DBMS_SQL.EXECUTE(c002);
		DBMS_SQL.CLOSE_CURSOR(c002);
		dbms_lob.freetemporary(ds_xml_w);
	else
		ds_sql_w := ' update tiss_log set ds_xml_clob = :ds_xml_w where nr_sequencia ='||nr_seq_tiss_log_w;
		c001 := DBMS_SQL.OPEN_CURSOR;
		DBMS_SQL.PARSE(c001, ds_sql_w, dbms_sql.Native);
		DBMS_SQL.BIND_VARIABLE(c001, 'DS_XML_W', ds_xml_w);
		retorno_w := DBMS_SQL.EXECUTE(c001);
		DBMS_SQL.CLOSE_CURSOR(c001);		
		dbms_lob.freetemporary(ds_xml_w);
		ds_hash_w := 'GERAR_HASH_MD5';
	end if;

	CALL TISS_GRAVAR_LOG(nr_seq_tiss_log_w, cd_estabelecimento_p, ie_tipo_tiss_p, c01_w.nr_seq_xml_projeto, nm_usuario_p, cd_convenio_p, '', ds_hash_w,
			'WS', 'E', c01_w.ds_endereco_serv,  c01_w.ds_serv_porta,  'G', null);

	if (ie_tipo_tiss_p in ('1','2','3','18')) then
		update 	tiss_log
		set 	nr_seq_autorizacao 	= nr_sequencia_autor_p
                where 	nr_sequencia 		= nr_seq_tiss_log_w;
	elsif (ie_tipo_tiss_p in ('7','8')) then
		update 	tiss_log
		set 	nr_seq_protocolo 	= nr_seq_protocolo_p
		where 	nr_sequencia 		= nr_seq_tiss_log_w;
	elsif (ie_tipo_tiss_p = '9') then
		update 	tiss_log
		set 	nr_seq_retorno 		= nr_seq_retorno_p
		where 	nr_sequencia 		= nr_seq_tiss_log_w;
	end if;

	if (nr_seq_protocolo_p > 0) then
		select	substr(coalesce(tiss_obter_codigo_prestador(a.cd_convenio, a.cd_estabelecimento, null, b.cd_cgc, null, 'CI', clock_timestamp(), null,null),
			tiss_obter_codigo_prestador(a.cd_convenio, a.cd_estabelecimento, null, b.cd_cgc, null, 'CGC', clock_timestamp(), null,null)),1,50),
			a.nr_seq_envio_convenio
		into STRICT	cd_prestador_w,
			nr_seq_envio_convenio_w
		from	protocolo_convenio a,
			estabelecimento b
		where	a.nr_seq_protocolo 	= nr_seq_protocolo_p
		and	b.cd_estabelecimento 	= cd_estabelecimento_p;

		select	max(to_char(coalesce(coalesce(b.nr_protocolo, a.NR_SEQ_DOC_CONVENIO), a.nr_seq_protocolo)))
		into STRICT	nr_lote_w
		from	protocolo_convenio a,
			tiss_protocolo_guia b
		where	a.nr_seq_protocolo	= b.nr_seq_protocolo
		and	b.ie_tiss_tipo_guia 	= ie_tiss_tipo_guia_p
		and	a.nr_seq_protocolo	= nr_seq_protocolo_p;
	end if;	

	if (coalesce(ie_calcula_hash_banco_p,'S') = 'N') then
		ds_hash_w := 'GERAR_HASH_MD5';
	end if;

	if (c01_w.ie_padrao_nome = 0) then
		nm_arquivo_w 	:= to_char(nr_seq_trans_tiss_w)||'_'||ds_hash_w||'.xml';

	elsif (c01_w.ie_padrao_nome = 1) then
		nm_arquivo_w	:= to_char(lpad(nr_seq_trans_tiss_w,20,'0'))||'_'||ds_hash_w||'.xml';

	elsif (c01_w.ie_padrao_nome = 2) then
            nm_arquivo_w	:= to_char(nr_seq_protocolo_p)||'_'||lpad(cd_prestador_w,14,'0')||'.xml';

	elsif (c01_w.ie_padrao_nome = 3) then
            nm_arquivo_w	:= lpad(cd_prestador_w,14,'0')||'_'||to_char(lpad(nr_seq_protocolo_p,10,'0'))||'.xml';

	elsif (c01_w.ie_padrao_nome = 4) then
		nm_arquivo_w	:= lpad(cd_prestador_w,14,'0')||'_'||lpad(nr_lote_w,10,'0')||'.xml';

	elsif (c01_w.ie_padrao_nome = 5) then
		if (length(cd_prestador_w) > 8) then
			select 	substr(cd_prestador_w, length(cd_prestador_w) - 7, length(cd_prestador_w))
			into STRICT	cd_prestador_w
			;
		end if;
		nm_arquivo_w	:= 'envioLoteGuias_'||cd_prestador_w||to_char(clock_timestamp(),'MMYY')||'.'||lpad(to_char(nr_seq_envio_convenio_w),4,'0')||'.'||nr_lote_w||'.xml';

	elsif (c01_w.ie_padrao_nome = 6) then
		select	to_char(nr_seq_protocolo_p)||CASE WHEN ie_tiss_tipo_guia_p='5' THEN 'A' WHEN ie_tiss_tipo_guia_p='6' THEN 'B' WHEN ie_tiss_tipo_guia_p='4' THEN 'C'  ELSE '' END ||'1.xml'
		into STRICT	nm_arquivo_w
		;

	elsif (c01_w.ie_padrao_nome = 7) then
		nm_arquivo_w 	:= 'Protocolo'||nr_seq_med_prot_p||'.xml';

	elsif (c01_w.ie_padrao_nome = 8) then
		nm_arquivo_w	:= to_char(lpad(nr_seq_protocolo_p,20,'0'))||'_'||ds_hash_w||'.xml';

	elsif (c01_w.ie_padrao_nome = 9) then
	
		select 	max(nr_registro)
		into STRICT 	nr_registro_w
		from 	lote_auditoria
		where 	nr_sequencia in (SELECT nr_seq_lote_audit from lote_audit_hist where nr_sequencia = nr_seq_lote_hist_p);
		
		select (nr_registro_w ||'_'||nr_seq_lote_hist_p ||'_'|| substr(replace(replace(replace(obter_nome_convenio(cd_convenio_p),' ','_'),'.','_'),'/','_'),1,15) ||'.xml')
		into STRICT	nm_arquivo_w
		;		
		
	elsif (c01_w.ie_padrao_nome = 10) then

        nm_arquivo_w := substr(replace(replace(replace(obter_nome_convenio(cd_convenio_p),' ','_'),'.','_'),'/','_'),1,15)||'_';

        if (nr_seq_protocolo_p <> 0) then
            select substr(replace(replace(replace(nr_protocolo,' ','_'),'.','_'),'/','_'),1,15)||'_'||
                to_char(nr_Seq_protocolo_p)||'.xml'
            into STRICT	nm_arquivo_auxiliar_w
            from	protocolo_convenio
            where	nr_seq_protocolo	= nr_seq_protocolo_p;
        end if;

        if (coalesce(nm_arquivo_auxiliar_w::text, '') = '') then
            nm_arquivo_w := nm_arquivo_w || to_char('0.xml');
        else
            nm_arquivo_w := nm_arquivo_w || nm_arquivo_auxiliar_w;
        end if;

	elsif (c01_w.ie_padrao_nome = 11) then

		select 	max(a.cd_cgc)||'_'||ds_hash_w||max(b.nr_nota_fiscal)||'.xml'
		into STRICT	nm_arquivo_w
		from 	convenio a,
			nota_fiscal b
		where 	a.cd_convenio 		= cd_convenio_p
		and	b.nr_seq_protocolo 	= nr_seq_protocolo_p;

	elsif (c01_w.ie_padrao_nome = 12) then
		nm_arquivo_w := to_char(clock_timestamp(),'ddmmyyyy')||'_'||to_char(clock_timestamp(),'hh24:mi:ss')||'faturamentoPrestador.xml';

	elsif (c01_w.ie_padrao_nome = 13) then
		nm_arquivo_w	:= to_char(lpad(nr_seq_protocolo_p,20,'0'))||'_'||ds_hash_w||'.xml';

	elsif (c01_w.ie_padrao_nome = 14) then
		if (length(cd_prestador_w) > 8) then
			select 	substr(cd_prestador_w, length(cd_prestador_w) - 7, length(cd_prestador_w))
			into STRICT	cd_prestador_w
			;
		end if;

		nm_arquivo_w	:= 'envioLoteGuias'||'_'||cd_prestador_w||to_char(clock_timestamp(),'MMYY')||'.'||lpad(to_char(nr_seq_envio_convenio_w),4,'0')||'.0001.xml';

	elsif (c01_w.ie_padrao_nome = 15) then
		if (length(cd_prestador_w) > 8) then
			select 	substr(cd_prestador_w, length(cd_prestador_w) - 7, length(cd_prestador_w))
			into STRICT	cd_prestador_w
			;
		end if;
		nm_arquivo_w	:= 'envioLoteGuias'||'_'||cd_prestador_w||to_char(clock_timestamp(),'MMYY')||'.1.xml';

	elsif (c01_w.ie_padrao_nome = 16) then

        if (cd_convenio_p > 0 and cd_estabelecimento_p > 0) then
            select 	'envioLoteGuias'||'_'||cd_interno||to_char(clock_timestamp(),'MMYY')||'.'||lpad(to_char(nr_seq_envio_convenio_w),4,'0')||'.0001.xml'
            into STRICT	nm_arquivo_w
            from   	convenio_estabelecimento
            where  	cd_convenio          = cd_convenio_p
            and    	cd_estabelecimento   = cd_estabelecimento_p;
        else
            nm_arquivo_w := 'envioLoteGuias'||'_'||0||to_char(clock_timestamp(),'MMYY')||'.'||lpad(to_char(nr_seq_envio_convenio_w),4,'0')||'.0001.xml';
        end if;
		
	elsif (c01_w.ie_padrao_nome = 17) then
	
		select 	max(nr_sequencia)
		into STRICT 	nr_registro_w
		from 	lote_auditoria
		where 	nr_sequencia in (SELECT nr_seq_lote_audit from lote_audit_hist where nr_sequencia = nr_seq_lote_hist_p);
		
		select (nr_registro_w || '_'||nr_seq_lote_hist_p ||'_'||nr_seq_prot_rec_p || '-' || substr(replace(replace(replace(obter_nome_convenio(cd_convenio_p),' ','_'),'.','_'),'/','_'),1,15) ||'.xml')
		into STRICT	nm_arquivo_w
		;		
		
	end if;

	nr_seq_xml_projeto_p	:= c01_w.nr_seq_xml_projeto;
	nr_seq_tiss_log_p		:= nr_seq_tiss_log_w;
	nm_arquivo_p 		:= nm_arquivo_w;

	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_gerar_xml_banco (cd_estabelecimento_p bigint, cd_funcao_ativa_p bigint, nm_usuario_p text, ie_tipo_tiss_p text, nr_seq_outorgante_p bigint, cd_convenio_p bigint, nr_seq_xml_projeto_p INOUT bigint, nr_seq_tiss_log_p INOUT bigint, nm_arquivo_p INOUT text, dt_mesano_referencia_p timestamp default clock_timestamp(), nr_atendimento_p bigint default 0, nr_seq_autorizacao_p bigint default 0, nr_sequencia_autor_p bigint default 0, nr_seq_protocolo_p bigint default 0, nr_seq_med_prot_p bigint default 0, nr_seq_retorno_p bigint default 0, nr_protocolo_receb_p bigint default 0, ie_tipo_demostrativo_p bigint default 0, nr_seq_prot_situacao_p bigint default 0, ie_tiss_tipo_guia_p text default '0', nr_seq_prot_guia_p bigint default 0, nr_seq_eleg_p bigint default 0, nr_seq_lote_anexo_p bigint default 0, nr_seq_comunic_p bigint default 0, nr_seq_lote_reap_p bigint default 0, nr_seq_prot_receb_p bigint default 0, nr_seq_prot_rec_p bigint default 0, nr_seq_lote_hist_p bigint default 0, cd_prestador_p text default null, nr_seq_lote_p bigint default null, ds_tipo_transacao_p text default null, cd_prestador_bh_p text default null, ds_convenio_p text default null, nr_protocolo_p text default null, cd_cgc_convenio_p text default null, nr_nf_protocolo_p text default null, ie_calcula_hash_banco_p text default null, nr_seq_prot_cancel_p bigint default 0, nr_seq_rec_glosa_prot_cancel_p tiss_recurso_glosa_prot.nr_sequencia%type default null, nr_seq_rec_glosa_form_cancel_p tiss_recurso_glosa_guia.nr_sequencia%type default null, NR_SEQ_TISS_DOCUMENTO_P tiss_envio_documento.nr_sequencia%TYPE default null, NR_SEQ_TISS_PROT_ENVIO_RET_P tiss_protocolo_envio_ret.nr_sequencia%TYPE default null) FROM PUBLIC;

