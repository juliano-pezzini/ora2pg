-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE incluir_fornec_solic_compra ( nr_solic_compra_p bigint, cd_fornec_exclusivo_p text, cd_fornec_sugerido_p text, cd_pessoa_fisica_p text, nm_usuario_p text) AS $body$
DECLARE

 
ds_fornec_exclusivo_ant_w		varchar(255);
ds_fornec_sugerido_ant_w		varchar(255);
ds_historico_w			varchar(4000);
				

BEGIN 
						 
select	coalesce(obter_nome_pf_pj(cd_pessoa_fisica, cd_fornec_exclusivo),WHEB_MENSAGEM_PCK.get_texto(297053)), 
	coalesce(obter_nome_pf_pj(cd_pessoa_fisica,cd_fornec_sugerido),WHEB_MENSAGEM_PCK.get_texto(297053)) 
into STRICT	ds_fornec_exclusivo_ant_w, 
	ds_fornec_sugerido_ant_w 
from	solic_compra 
where	nr_solic_compra = nr_solic_compra_p;
 
update	solic_compra 
set	cd_fornec_exclusivo	= CASE WHEN cd_pessoa_fisica_p = NULL THEN CASE WHEN cd_fornec_exclusivo_p = NULL THEN cd_fornec_exclusivo  ELSE cd_fornec_exclusivo_p END   ELSE '' END , 
	cd_fornec_sugerido		= CASE WHEN cd_pessoa_fisica_p = NULL THEN CASE WHEN cd_fornec_sugerido_p = NULL THEN cd_fornec_sugerido  ELSE cd_fornec_sugerido_p END   ELSE '' END , 
	cd_pessoa_fisica		= CASE WHEN cd_fornec_sugerido_p = NULL THEN CASE WHEN cd_pessoa_fisica_p = NULL THEN cd_pessoa_fisica  ELSE cd_pessoa_fisica_p END   ELSE '' END  
where	nr_solic_compra		= nr_solic_compra_p;
 
if (cd_fornec_exclusivo_p IS NOT NULL AND cd_fornec_exclusivo_p::text <> '') then 
 
				 
	ds_historico_w	:=	substr(WHEB_MENSAGEM_PCK.get_texto(302779,'DS_FORNEC_EXCLUSIVO_ANT_W=' || ds_fornec_exclusivo_ant_w || ';' || 'DS_FORNEC_W=' || obter_nome_pf_pj(null,cd_fornec_exclusivo_p)),1,4000);
 
	CALL gerar_historico_solic_compra( 
		nr_solic_compra_p, 
		WHEB_MENSAGEM_PCK.get_texto(302781), 
		ds_historico_w, 
		'FE', 
		nm_usuario_p);
end if;
 
if (cd_fornec_sugerido_p IS NOT NULL AND cd_fornec_sugerido_p::text <> '') then 
 
	ds_historico_w	:=	substr(WHEB_MENSAGEM_PCK.get_texto(302782,'DS_FORNEC_SUGERIDO_ANT_W=' || ds_fornec_sugerido_ant_w || ';' || 
								'DS_FORNEC_W=' || obter_nome_pf_pj(null,cd_fornec_sugerido_p)),1,4000);
 
	CALL gerar_historico_solic_compra( 
		nr_solic_compra_p, 
		WHEB_MENSAGEM_PCK.get_texto(302784), 
		ds_historico_w, 
		'FS', 
		nm_usuario_p);
end if;
 
if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then 
 
	ds_historico_w	:=	substr(WHEB_MENSAGEM_PCK.get_texto(302785,'DS_FORNEC_SUGERIDO_ANT_W=' || ds_fornec_sugerido_ant_w || ';' || 
								'DS_FORNEC_W=' || obter_nome_pf_pj(cd_pessoa_fisica_p,null)),1,4000);
 
	CALL gerar_historico_solic_compra( 
		nr_solic_compra_p, 
		WHEB_MENSAGEM_PCK.get_texto(302786), 
		ds_historico_w, 
		'FS', 
		nm_usuario_p);
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE incluir_fornec_solic_compra ( nr_solic_compra_p bigint, cd_fornec_exclusivo_p text, cd_fornec_sugerido_p text, cd_pessoa_fisica_p text, nm_usuario_p text) FROM PUBLIC;

