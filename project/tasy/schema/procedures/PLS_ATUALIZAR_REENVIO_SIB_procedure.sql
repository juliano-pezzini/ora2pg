-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_reenvio_sib ( nr_seq_retorno_p bigint, ie_tipo_registro_p bigint, nr_seq_motivo_p bigint, ie_opcao_p bigint, nr_seq_segurado_p bigint, ie_carteira_ant_p text, ie_utilizar_dados_tasy_p text, dt_movimento_p timestamp, nr_seq_sib_log_exclusao_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_motivo_w			bigint;
nr_seq_motivo_ww		bigint;
nr_seq_segurado_w		bigint;
ie_tipo_registro_w		bigint;
dt_movimento_w			timestamp;

dt_reativacao_w			pls_segurado.dt_reativacao%type;
dt_rescisao_w			pls_segurado.dt_rescisao%type;
dt_contratacao_w		pls_segurado.dt_contratacao%type;
qt_cart_sistema_ant_w		integer;
ie_situacao_ans_w		varchar(1);
ie_situacao_tasy_w		varchar(1);
ie_reenviar_sib_w		pls_segurado.ie_reenviar_sib%type;


BEGIN

/*Dados do Tasy*/

if (ie_opcao_p	= 1) or (ie_utilizar_dados_tasy_p = 'S') then
	select	max(nr_seq_segurado)
	into STRICT	nr_seq_segurado_w
	from	pls_retorno_sib
	where	nr_sequencia	= nr_seq_retorno_p;

	if (coalesce(nr_seq_segurado_w::text, '') = '') then
		select	max(nr_seq_segurado_encontrado)
		into STRICT	nr_seq_segurado_w
		from	pls_retorno_sib
		where	nr_sequencia	= nr_seq_retorno_p;

		if (coalesce(nr_seq_segurado_w::text, '') = '') then
			select	max(nr_seq_segurado_vinculado)
			into STRICT	nr_seq_segurado_w
			from	pls_retorno_sib
			where	nr_sequencia	= nr_seq_retorno_p;
		end if;
	end if;

	if (nr_seq_segurado_w IS NOT NULL AND nr_seq_segurado_w::text <> '') then
		/*Utilizar os dados do beneficiário do tasy*/

		if (ie_utilizar_dados_tasy_p = 'S') then
			select	dt_reativacao,
				dt_rescisao,
				trunc(dt_contratacao, 'month'),
				CASE WHEN coalesce(dt_rescisao::text, '') = '' THEN CASE WHEN coalesce(dt_reativacao::text, '') = '' THEN 2  ELSE 8 END   ELSE 7 END
			into STRICT	dt_reativacao_w,
				dt_rescisao_w,
				dt_contratacao_w,
				ie_tipo_registro_w
			from	pls_segurado a
			where	nr_sequencia	= nr_seq_segurado_w;

			select	count(1)
			into STRICT	qt_cart_sistema_ant_w
			
			where	exists (SELECT	1
					from	pls_segurado_cart_ant x
					where	x.nr_seq_segurado 	= nr_seq_segurado_w
					and	x.ie_sistema_anterior	= 'S');

			if (dt_contratacao_w = trunc(add_months(dt_movimento_p,-1),'month')) or
				((trunc(dt_contratacao_w,'month') < trunc(dt_movimento_p,'month')) and (trunc(dt_rescisao_w,'dd') >= trunc(dt_movimento_p,'dd') or (coalesce(dt_rescisao_w::text, '') = '')) and (qt_cart_sistema_ant_w > 0)) then
				ie_tipo_registro_w := 1; -- Inclusão
			elsif (dt_reativacao_w > dt_rescisao_w) or
				((coalesce(dt_reativacao_w::text, '') = '') and (coalesce(dt_rescisao_w::text, '') = '')) then
				ie_tipo_registro_w := 2; -- Alteração
			end if;

			select	max(ie_tipo_registro)
			into STRICT	ie_situacao_ans_w
			from	pls_retorno_sib
			where	nr_sequencia = nr_seq_retorno_p;

			select	CASE WHEN coalesce(max(dt_rescisao)::text, '') = '' THEN  '1'  ELSE '3' END
			into STRICT	ie_situacao_tasy_w
			from	pls_segurado
			where	nr_sequencia = nr_seq_segurado_w;

			if (ie_situacao_ans_w = '1') and (ie_situacao_tasy_w = '1') and (ie_tipo_registro_w = '8') then
				ie_tipo_registro_w	:= '2';
			end if;


			/*Buscar os dados do beneficiario caso for inclusão*/

			if (ie_tipo_registro_w = 2) then
				nr_seq_motivo_ww 	:= 51;
				dt_movimento_w		:= dt_movimento_p;
			elsif (ie_tipo_registro_w = 1) then
				select	nr_seq_motivo_inclusao,
					dt_contratacao
				into STRICT	nr_seq_motivo_w,
					dt_movimento_w
				from	pls_segurado
				where	nr_sequencia	= nr_seq_segurado_w;

				select	max(dt_contratacao)
				into STRICT	dt_movimento_w
				from	pls_segurado
				where	nr_sequencia	= nr_seq_segurado_w;

				if (nr_seq_motivo_w IS NOT NULL AND nr_seq_motivo_w::text <> '') then
					select	cd_ans
					into STRICT	nr_seq_motivo_ww
					from	pls_motivo_inclusao_seg
					where	nr_sequencia	= nr_seq_motivo_w;
				end if;
			/*BUscar os dados do beneficiario caso for rescisão*/

			elsif (ie_tipo_registro_w	= 7) then -- Exclusão
				select	nr_seq_motivo_cancelamento,
					dt_rescisao
				into STRICT	nr_seq_motivo_w,
					dt_movimento_w
				from	pls_segurado
				where	nr_sequencia	= nr_seq_segurado_w;

				if (nr_seq_motivo_w IS NOT NULL AND nr_seq_motivo_w::text <> '') then
					select	cd_motivo_cancelamento
					into STRICT	nr_seq_motivo_ww
					from	pls_motivo_cancelamento
					where	nr_sequencia	= nr_seq_motivo_w;
				end if;
			/*BUscar os dados do beneficiario caso for rescisão*/

			elsif (ie_tipo_registro_w	= 8) then -- Reinclusão
				select	dt_reativacao
				into STRICT	dt_movimento_w
				from	pls_segurado
				where	nr_sequencia	= nr_seq_segurado_w;
			end if;
		elsif (ie_utilizar_dados_tasy_p = 'N') then
			/*Incluir os motivos para as variaveis*/

			ie_tipo_registro_w	:= ie_tipo_registro_p;
			dt_movimento_w		:= dt_movimento_p;
			nr_seq_motivo_ww	:= nr_seq_motivo_p;
		end if;

		update	pls_retorno_sib
		set	ie_opcao 		= 1,
			nr_seq_motivo_reenvio	= nr_seq_motivo_ww,
			ie_tipo_reg_reenvio	= ie_tipo_registro_w,
			ie_enviar_sib		= 'T',
			ie_carteira_ant		= 'N',
			dt_exclusao		= CASE WHEN ie_tipo_registro_w=7 THEN to_char(dt_movimento_w,'dd/mm/yyyy')  ELSE dt_exclusao END ,
			dt_inclusao		= CASE WHEN ie_tipo_registro_w=1 THEN to_char(dt_movimento_w,'dd/mm/yyyy')  ELSE dt_inclusao END ,
			dt_reativacao_contrato	= CASE WHEN ie_tipo_registro_w=8 THEN to_char(dt_movimento_w,'dd/mm/yyyy')  ELSE dt_reativacao_contrato END ,
			dt_movimento		= dt_movimento_w
		where	nr_sequencia		= nr_seq_retorno_p;
	end if;
/*Dados do ANS*/

elsif (ie_opcao_p	= 2) then
	/*aaschlote 27/04/2011 OS - 313957*/

	select	max(nr_seq_segurado)
	into STRICT	nr_seq_segurado_w
	from	pls_retorno_sib
	where	nr_sequencia	= nr_seq_retorno_p;

	if (coalesce(nr_seq_segurado_w::text, '') = '') then
		select	max(nr_seq_segurado_encontrado)
		into STRICT	nr_seq_segurado_w
		from	pls_retorno_sib
		where	nr_sequencia	= nr_seq_retorno_p;

		if (coalesce(nr_seq_segurado_w::text, '') = '') then
			select	max(nr_seq_segurado_vinculado)
			into STRICT	nr_seq_segurado_w
			from	pls_retorno_sib
			where	nr_sequencia	= nr_seq_retorno_p;
		end if;
	end if;

	/*Incluir os motivos para as variaveis*/

	ie_tipo_registro_w	:= ie_tipo_registro_p;
	dt_movimento_w		:= dt_movimento_p;
	nr_seq_motivo_ww	:= nr_seq_motivo_p;

	if (coalesce(nr_seq_motivo_ww::text, '') = '') then
		nr_seq_motivo_ww	:= 1;
	end if;

	update	pls_retorno_sib
	set	ie_opcao 		= ie_opcao_p,
		nr_seq_motivo_reenvio	= nr_seq_motivo_ww,
		ie_tipo_reg_reenvio	= ie_tipo_registro_w,
		ie_enviar_sib		= 'A',
		dt_exclusao		= CASE WHEN ie_tipo_registro_w=7 THEN to_char(dt_movimento_w,'dd/mm/yyyy')  ELSE dt_exclusao END ,
		dt_inclusao		= CASE WHEN ie_tipo_registro_w=1 THEN to_char(dt_movimento_w,'dd/mm/yyyy')  ELSE dt_inclusao END ,
		dt_reativacao_contrato	= CASE WHEN ie_tipo_registro_w=8 THEN to_char(dt_movimento_w,'dd/mm/yyyy')  ELSE dt_reativacao_contrato END ,
		ie_carteira_ant		= ie_carteira_ant_p,
		dt_movimento		= dt_movimento_w
	where	nr_sequencia		= nr_seq_retorno_p;
elsif (ie_opcao_p	= 3) then
	update	pls_segurado
	set	ie_opcao_sib 		= ie_opcao_p,
		nr_seq_motivo_reenvio	= nr_seq_motivo_p,
		ie_tipo_reg_reenvio	= ie_tipo_registro_p,
		ie_reenviar_sib		= CASE WHEN ie_reenviar_sib='T' THEN 'N'  ELSE 'T' END ,
		ie_carteira_ant_sib	= ie_carteira_ant_p,
		nr_seq_sib_log_exclusao	= CASE WHEN ie_reenviar_sib='T' THEN null  ELSE nr_seq_sib_log_exclusao_p END
	where	nr_sequencia		= nr_seq_segurado_p;

	if (coalesce(nr_seq_sib_log_exclusao_p,0) <> 0) then
		select	max(ie_reenviar_sib)
		into STRICT	ie_reenviar_sib_w
		from	pls_segurado
		where	nr_sequencia	= nr_seq_segurado_p;

		update	sib_log_exclusao
		set	ie_enviar_sib	= CASE WHEN ie_reenviar_sib_w='T' THEN 'S'  ELSE 'N' END
		where	nr_sequencia	= nr_seq_sib_log_exclusao_p;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_reenvio_sib ( nr_seq_retorno_p bigint, ie_tipo_registro_p bigint, nr_seq_motivo_p bigint, ie_opcao_p bigint, nr_seq_segurado_p bigint, ie_carteira_ant_p text, ie_utilizar_dados_tasy_p text, dt_movimento_p timestamp, nr_seq_sib_log_exclusao_p bigint, nm_usuario_p text) FROM PUBLIC;

