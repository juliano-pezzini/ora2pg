-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_dados_segurado_agenda ( nr_seq_segurado_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, cd_convenio_p INOUT bigint, cd_categoria_p INOUT text, cd_usuario_convenio_p INOUT text, cd_pessoa_fisica_p INOUT text, nm_pessoa_fisica_p INOUT text, ie_situacao_atend_p INOUT text, ds_abort_p INOUT text, dt_validade_carteira_p INOUT timestamp, cd_plano_p INOUT text, ie_tipo_atendimento_p bigint default null) AS $body$
BEGIN

if (coalesce(nr_seq_segurado_p,0) > 0) then
	select	cd_pessoa_fisica,
			ie_situacao_atend
	into STRICT	cd_pessoa_fisica_p,
			ie_situacao_atend_p
	from	pls_segurado
	where	nr_sequencia = nr_seq_segurado_p;

	select	nm_pessoa_fisica
	into STRICT	nm_pessoa_fisica_p
	from	pessoa_fisica
	where	cd_pessoa_fisica = cd_pessoa_fisica_p;

	cd_usuario_convenio_p 	:= obter_dados_seg_entrada_unica(nr_seq_segurado_p, 'CI', ie_tipo_atendimento_p);

  --mesmo select feito na obter_dados_seg_entrada_unica(nr_seq_segurado_p, 'VC', ie_tipo_atendimento_p), alterado pois esse retorna um varchar em vez de data
  select	max(b.dt_validade_carteira)
	into STRICT	dt_validade_carteira_p
	from	pls_segurado_carteira b,
		pls_segurado a
	where	b.nr_seq_segurado	= a.nr_sequencia
	and	a.nr_sequencia		= nr_seq_segurado_p;

	cd_convenio_p			:= obter_dados_seg_entrada_unica(nr_seq_segurado_p, 'CV', ie_tipo_atendimento_p);
	cd_categoria_p			:= obter_dados_seg_entrada_unica(nr_seq_segurado_p, 'CA', ie_tipo_atendimento_p);
	cd_plano_p				:= obter_dados_seg_entrada_unica(nr_seq_segurado_p, 'PLC', ie_tipo_atendimento_p);
end if;

ds_abort_p := obter_texto_tasy(143449, wheb_usuario_pck.get_nr_seq_idioma);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_dados_segurado_agenda ( nr_seq_segurado_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, cd_convenio_p INOUT bigint, cd_categoria_p INOUT text, cd_usuario_convenio_p INOUT text, cd_pessoa_fisica_p INOUT text, nm_pessoa_fisica_p INOUT text, ie_situacao_atend_p INOUT text, ds_abort_p INOUT text, dt_validade_carteira_p INOUT timestamp, cd_plano_p INOUT text, ie_tipo_atendimento_p bigint default null) FROM PUBLIC;

