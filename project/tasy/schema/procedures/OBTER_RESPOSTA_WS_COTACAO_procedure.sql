-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_resposta_ws_cotacao ( cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_cot_compra_w				bigint;
qt_existe_w				bigint;
ds_erro_w				varchar(255);
ie_tipo_integracao_envio_w			varchar(1);

c01 CURSOR FOR
SELECT	nr_cot_compra
from (
	SELECT	a.nr_cot_compra
	from	cot_compra a
	where	(nr_documento_externo IS NOT NULL AND nr_documento_externo::text <> '')
	and	coalesce(a.dt_geracao_ordem_compra::text, '') = ''
	and	a.ie_tipo_integracao_envio(1,2,3)
	and	a.cd_estabelecimento = cd_estabelecimento_p
	and	coalesce(a.nr_seq_motivo_cancel::text, '') = ''
	and	a.dt_retorno_prev <= clock_timestamp()
	and not exists (
		select	1
		from	cot_compra_forn x
		where	x.nr_cot_compra = a.nr_cot_compra)
	order by	coalesce(obter_ultimo_log_integ_cot(a.nr_cot_compra, 'R'), clock_timestamp() - interval '365 days')) alias9 LIMIT 1;


BEGIN

open C01;
loop
fetch C01 into
	nr_cot_compra_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ds_erro_w := '';

	select	count(*)
	into STRICT	qt_existe_w
	from	cliente_integracao
	where	nr_seq_inf_integracao = 143
	and	ie_situacao = 'A';

	if (qt_existe_w > 0) then

		CALL gerar_historico_cotacao_integr(
			nr_cot_compra_w,
			wheb_mensagem_pck.get_texto(299185),
			wheb_mensagem_pck.get_texto(299186),
			'S',
			'Job');
		CALL gravar_agend_integracao(98,'nr_cot_compra=' || nr_cot_compra_w || ';');
	end if;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_resposta_ws_cotacao ( cd_estabelecimento_p bigint) FROM PUBLIC;

