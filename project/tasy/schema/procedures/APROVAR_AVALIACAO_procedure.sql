-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE aprovar_avaliacao ( nr_sequencia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


ds_titulo_w			varchar(2000);
ds_mensagem_w			varchar(4000);
ds_usuario_w			varchar(4000);
ds_perfil_w			varchar(4000);
ie_envia_ci_ao_aprovar_w	varchar(15);
ie_sac_liberar_avaliacao_w	varchar(15);


BEGIN

ie_envia_ci_ao_aprovar_w := Obter_Param_Usuario(909, 8, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_envia_ci_ao_aprovar_w);
ie_sac_liberar_avaliacao_w := Obter_Param_Usuario(909, 10, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_sac_liberar_avaliacao_w);

if (coalesce(nr_sequencia_p,0) > 0) then
	CALL atualizar_med_tipo_avaliacao(nr_sequencia_p,'A');

	if (ie_envia_ci_ao_aprovar_w = 'S') then

		select 	obter_texto_tasy(162378, wheb_usuario_pck.get_nr_seq_idioma) ds_titulo,
			obter_texto_dic_objeto(162379,wheb_usuario_pck.get_nr_seq_idioma, 'DS_MENSAGEM_APROVACAO='||DS_MENSAGEM_APROVACAO||';DT_APROVACAO='||DT_APROVACAO||';DS_TIPO='||DS_TIPO||';NR_SEQUENCIA='||NR_SEQUENCIA||';NM_USUARIO='||nm_usuario_p)ds_mensagem,
			obter_perfil_usua_aval_com_int(nr_sequencia,cd_estabelecimento_p,'U') ds_usuario,
			obter_perfil_usua_aval_com_int(nr_sequencia,cd_estabelecimento_p,'P') ds_perfil
		into STRICT	ds_titulo_w,
			ds_mensagem_w,
			ds_usuario_w,
			ds_perfil_w
		from   	med_tipo_avaliacao
		where  	nr_sequencia = nr_sequencia_p;

		CALL gerar_comunic_padrao(clock_timestamp(),ds_titulo_w,ds_mensagem_w,nm_usuario_p,'N',ds_usuario_w,'N',null,ds_perfil_w,null,null,clock_timestamp(),null,null);
	end if;

	if (ie_sac_liberar_avaliacao_w = 'S') then
		CALL sac_inserir_pesquisa_tipo(nr_sequencia_p,cd_estabelecimento_p,nm_usuario_p);
	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE aprovar_avaliacao ( nr_sequencia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

