-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE grava_item_ordem_compra ( nr_ordem_compra_p bigint, cd_material_p bigint, cd_unidade_p text, vl_unitario_p bigint, qt_material_p bigint, ds_observacao_p text, ds_marca_p text, ds_marca_inf_p text, nm_usuario_p text, ie_situacao_p text, dt_entrega_p timestamp, pr_desconto_p bigint, nr_cot_compra_p bigint, nr_item_cot_compra_p bigint, nr_seq_fornecedor_p bigint, qt_conv_unid_fornec_p bigint, ie_ajusta_unid_fornec_p text, dt_validade_p timestamp, ie_desfaz_agrupamento_p text, vl_desconto_p bigint, nr_contrato_p bigint, cd_centro_custo_p bigint, ds_marca_fornec_p text, cd_paciente_forn_item_p cot_compra_forn_item.cd_paciente_forn_item%type default null) AS $body$
DECLARE

					

nr_item_w				integer 	:= 0;
ds_material_direto_w 			varchar(255);
ds_material_direto_ww 			varchar(255);
cd_tributo_w				integer;
pr_tributo_w				double precision;
vl_tributo_w				double precision;
cd_local_estoque_w			integer;
cd_centro_custo_w			integer;
cd_conta_contabil_w			varchar(20);
nr_solic_compra_w			bigint;
nr_solic_compra_ww			bigint;
nr_item_solic_compra_w			integer;
nr_item_solic_compra_ww			integer;
qt_material_w				double precision;
qt_material_ww				double precision;
ie_aviso_chegada_w			varchar(01);
ie_geracao_w				varchar(01);
nr_seq_proj_rec_w			bigint;
ds_erro_w				varchar(255);
cd_estabelecimento_w			smallint;
ie_tipo_conta_w				integer	:= 2;
nr_seq_ordem_serv_w			bigint;
nr_seq_marca_w				bigint;
qt_data_entrega_item_w			integer;
qt_entrega_w				double precision;
dt_entrega_w				timestamp;
dt_entrega_ww				varchar(200);
nr_seq_agrup_w				bigint;
ie_material_estoque_w			varchar(1);
dt_ordem_compra_w			timestamp;
nr_seq_etapa_gpi_w			bigint;
nr_seq_proj_gpi_w			bigint;
nr_id_integracao_w			varchar(255);
ie_urgente_w				varchar(1);
ie_urgente_param_w			varchar(1);
ie_manual_baixa_item_w			varchar(1);
nr_seq_motivo_urgente_w			bigint;
ds_observacao_w				varchar(255);
nr_seq_orc_item_gpi_w			bigint;
nr_seq_conta_gpi_w			bigint;
ie_desmarca_chegada_material_w		varchar(1);
ds_titulo_w				varchar(255);
ds_detalhe_w				varchar(4000);
nr_seq_lote_fornec_w			bigint;
nr_seq_regra_contrato_w			bigint;
nr_Seq_preco_pj_w			bigint;
ie_tipo_status_w			varchar(1);
ds_material_w				varchar(255);
ds_fornecedor_w				pessoa_juridica.ds_razao_social%type;
dt_baixa_w				timestamp;
ie_atualiza_opme_w			varchar(1);
cd_moeda_w				ordem_compra.cd_moeda%type;
nr_seq_criterio_rateio_w		bigint;
ie_gravar_rateio_solic_w		varchar(1);
nr_seq_rateio_w				bigint;
cd_centro_rat_solic_w			integer;
cd_conta_rat_solic_w			varchar(20);
cd_conta_fin_rat_solic_w		bigint;
vl_rateio_w				double precision;
vl_frete_rat_solic_w			double precision;
vl_desconto_rat_solic_w			double precision;
vl_seguro_rat_solic_w			double precision;
vl_despesa_rat_solic_w			double precision;
ie_situacao_rat_solic_w			varchar(1);
nr_seq_crit_rat_solic_w			double precision;
qt_rateio_w				double precision;
vl_total_item_w				double precision;
ds_marca_w				varchar(255);
ds_marca2_w				varchar(255);
cd_pessoa_solicitante_w			varchar(10);
ie_tipo_ordem_w				ordem_compra.ie_tipo_ordem%type;
nr_seq_conta_bco_w			projeto_recurso.nr_seq_conta_bco%type;
ie_marca_gerar_w			varchar(15);
vl_frete_rateio_w			ordem_compra_item.vl_frete_rateio%type;
ds_justif_escolha_fornec_w	cot_compra_forn_item.ds_justif_escolha_fornec%type;
ie_regra_local_w				varchar(15);
ie_cotacao_pendente_w		parametro_compras.ie_cons_cot_pend%type;
qt_material_sci_w			solic_compra_item.qt_material%type;

ds_arquivo_w		cot_compra_anexo.ds_arquivo%type;
ds_arquivo_banco_w	cot_compra_anexo.ds_arquivo_banco%type;
ie_doc_origem_w		cot_compra_anexo.ie_doc_origem%type;

C01 CURSOR FOR
	SELECT	coalesce(cd_tributo,0),
		pr_tributo,
		vl_tributo
	from	cot_compra_forn_item b,
		cot_compra_forn_item_tr a
	where	a.nr_seq_cot_item_forn	= b.nr_sequencia
	and	a.nr_cot_compra		= nr_cot_compra_p
	and	a.nr_item_cot_compra	= nr_item_cot_compra_p
	and	b.nr_seq_cot_forn 		= nr_seq_fornecedor_p;

C02 CURSOR FOR

	SELECT	nr_solic_compra,
		nr_item_solic_compra,
		qt_material,
		ds_observacao,
		nr_sequencia nr_seq_agrup
	from (SELECT	coalesce(ag.nr_solic_compra, nr_solic_compra_ww) nr_solic_compra,
			coalesce(ag.nr_item_solic_compra, nr_item_solic_compra_ww) nr_item_solic_compra,
			coalesce(ag.qt_material, qt_material_p) qt_material,
			'' ds_observacao,
			ag.nr_sequencia
		from	cot_compra_solic_agrup ag
		where	ag.nr_cot_compra = nr_cot_compra_p
		and	ag.nr_item_cot_compra = nr_item_cot_compra_p
		and	ag.cd_estabelecimento = obter_estab_ordem_compra(nr_ordem_compra_p)
		and not exists (
				select	1
				from	ordem_compra_item x
				where	x.nr_ordem_compra = nr_ordem_compra_p
				and	x.cd_material = cd_material_p
				and	x.nr_solic_compra = coalesce(ag.nr_solic_compra, nr_solic_compra_ww)
				and	nr_item_solic_compra = coalesce(ag.nr_item_solic_compra, nr_item_solic_compra_ww))
		
union all

		select	nr_solic_compra_ww nr_solic_compra,
			nr_item_solic_compra_ww nr_item_solic_compra,
			qt_material_p qt_material,
			ds_observacao_w ds_observacao,
			null
		
		where not exists (
			select	1
			from	cot_compra_solic_agrup x
			where	x.nr_cot_compra = nr_cot_compra_p
			and	x.nr_item_cot_compra = nr_item_cot_compra_p)) alias8
	where	ie_desfaz_agrupamento_p = 'S'
	
union

	select	distinct
		nr_solic_compra,
		nr_item_solic_compra,
		qt_material,
		ds_observacao,
		nr_sequencia nr_seq_agrup
	from (select	coalesce(nr_solic_compra, nr_solic_compra_ww) nr_solic_compra,
			coalesce(nr_item_solic_compra, nr_item_solic_compra_ww) nr_item_solic_compra,
			coalesce(qt_material, qt_material_p) qt_material,
			'' ds_observacao,
			nr_sequencia
		from	cot_compra_solic_agrup
		where	nr_cot_compra = nr_cot_compra_p
		and	nr_item_cot_compra = nr_item_cot_compra_p
		and	obter_dados_solic_compra(nr_solic_compra,7) = cd_centro_custo_p
		
union all

		select	nr_solic_compra_ww nr_solic_compra,
			nr_item_solic_compra_ww nr_item_solic_compra,
			qt_material_p qt_material,
			ds_observacao_w ds_observacao,
			null
		
		where not exists (
			select	1
			from	cot_compra_solic_agrup x
			where	x.nr_cot_compra = nr_cot_compra_p
			and	x.nr_item_cot_compra = nr_item_cot_compra_p)) alias14
	where	ie_desfaz_agrupamento_p = 'C'
	
union

	select	nr_solic_compra_ww,
		nr_item_solic_compra_ww,
		qt_material_p,
		ds_observacao_w ds_observacao,
		null
	
	where	ie_desfaz_agrupamento_p = 'N'
	
union

	select	nr_solic_compra_ww,
		nr_item_solic_compra_ww,
		qt_material_p,
		ds_observacao_w ds_observacao,
		null
	
	where	ie_desfaz_agrupamento_p = 'SC';

c03 CURSOR FOR
SELECT	a.dt_entrega,
	a.qt_entrega
from	cot_compra_forn_item_en a,
	cot_compra_forn_item b
where	b.nr_cot_compra 		= nr_cot_compra_p
and	b.nr_item_cot_compra  	= nr_item_cot_compra_p
and	a.nr_seq_cot_item_forn	= b.nr_sequencia
and	b.nr_item_cot_compra 	= a.nr_item_cot_compra
and	b.nr_cot_compra		= a.nr_cot_compra
and	b.nr_seq_cot_forn 		= nr_seq_fornecedor_p
order by 1 desc;

c04 CURSOR FOR
SELECT	a.ds_arquivo,
	a.ds_arquivo_banco,
	a.ie_doc_origem
from	cot_compra_anexo a
where	a.nr_cot_compra = nr_cot_compra_p
and (coalesce(a.nr_item_cot_compra::text, '') = '' or a.nr_item_cot_compra = nr_item_cot_compra_p)
and	not exists (SELECT	1
	from	ordem_compra_anexo x
	where	x.nr_ordem_compra = nr_ordem_compra_p
	and	x.ds_arquivo = a.ds_arquivo);

c05 CURSOR FOR
SELECT	ds_titulo,
	ds_detalhe
from	cot_compra_item_detalhe
where	nr_cot_compra = nr_cot_compra_p
and	nr_item_cot_compra = nr_item_cot_compra_p;

c06 CURSOR FOR
SELECT	cd_centro_custo,
	cd_conta_contabil,
	cd_conta_financ,
	vl_rateio,
	vl_frete,
	vl_desconto,
	vl_seguro,
	vl_despesa_acessoria,
	ie_situacao,
	nr_seq_criterio_rateio,
	qt_rateio
from	solic_compra_item_rateio
where	nr_solic_compra = nr_solic_compra_w
and	nr_item_solic_compra = nr_item_solic_compra_w
order by nr_sequencia;


BEGIN

ds_marca_w		:= ds_marca_p;
ds_marca2_w		:= coalesce(ds_marca_inf_p,'');

select	cd_estabelecimento,
	obter_nome_pf_pj('',cd_cgc_fornecedor),
	cd_moeda,
	ie_tipo_ordem,
	cd_pessoa_solicitante
into STRICT	cd_estabelecimento_w,
	ds_fornecedor_w,
	cd_moeda_w,
	ie_tipo_ordem_w,
	cd_pessoa_solicitante_w
from	ordem_compra
where	nr_ordem_compra	= nr_ordem_compra_p;

ie_urgente_param_w := Obter_Param_Usuario(915, 75, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_urgente_param_w);
ie_marca_gerar_w := Obter_Param_Usuario(915, 192, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_marca_gerar_w);

/*Ordem Compra*/

ie_manual_baixa_item_w := Obter_Param_Usuario(917, 95, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_manual_baixa_item_w);
ie_desmarca_chegada_material_w := Obter_Param_Usuario(917, 104, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_desmarca_chegada_material_w);
ie_gravar_rateio_solic_w 	:= coalesce((obter_valor_param_usuario(917, 184, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w)), 'N');
ie_regra_local_w := Obter_Param_Usuario(917, 133, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_regra_local_w);

select	max(ds_material_direto),
	max(nr_id_integracao),
	max(nr_seq_regra_contrato),
	max(nr_Seq_preco_pj),
	max(vl_frete_rateio),
	max(ds_justif_escolha_fornec)
into STRICT	ds_material_direto_ww,
	nr_id_integracao_w,
	nr_seq_regra_contrato_w,
	nr_Seq_preco_pj_w,
	vl_frete_rateio_w,
	ds_justif_escolha_fornec_w
from	cot_compra_forn_item
where	nr_cot_compra		= nr_cot_compra_p
and	nr_item_cot_compra	= nr_item_cot_compra_p
and	nr_seq_cot_forn		= nr_seq_fornecedor_p;

select	coalesce(max(nr_solic_compra),0),
	coalesce(max(nr_item_solic_compra),0),
	max(nr_seq_proj_rec)
into STRICT	nr_solic_compra_ww,
	nr_item_solic_compra_ww,
	nr_seq_proj_rec_w
from	cot_compra_item
where	nr_cot_compra		= nr_cot_compra_p
and	nr_item_cot_compra	= nr_item_cot_compra_p;

if (nr_seq_proj_rec_w > 0) then
	select	nr_seq_conta_bco
	into STRICT	nr_seq_conta_bco_w
	from	projeto_recurso
	where	nr_sequencia = nr_seq_proj_rec_w;
end if;

select	max(ds_observacao)
into STRICT	ds_observacao_w
from	cot_compra_item_entrega
where	nr_cot_compra		= nr_cot_compra_p
and	nr_item_cot_compra	= nr_item_cot_compra_p;


if (nr_solic_compra_ww = 0) or (nr_item_solic_compra_ww = 0) then
	begin

	select	coalesce(max(nr_solic_compra),0)
	into STRICT	nr_solic_compra_ww
	from	solic_compra_item a
	where	a.nr_cot_compra		= nr_cot_compra_p
	and	a.nr_item_cot_compra	= nr_item_cot_compra_p;

	select	coalesce(max(nr_item_solic_compra),0)
	into STRICT	nr_item_solic_compra_ww
	from	solic_compra_item a
	where	a.nr_cot_compra		= nr_cot_compra_p
	and	a.nr_item_cot_compra	= nr_item_cot_compra_p
	and	nr_solic_compra		= nr_solic_compra_ww;

	if (nr_solic_compra_ww = 0) or (nr_item_solic_compra_ww = 0) then
		begin
		select	coalesce(max(a.nr_solic_compra),0)
		into STRICT	nr_solic_compra_ww
		from	solic_compra_item_entrega b,
			solic_compra_item a
		where	a.nr_solic_compra		= b.nr_solic_compra
		and	a.nr_item_solic_compra	= b.nr_item_solic_compra
		and	a.nr_cot_compra		= nr_cot_compra_p
		and	to_char(a.cd_material)	= to_char(cd_material_p)
		and	b.dt_entrega_solicitada	= dt_entrega_p;

		select	coalesce(max(a.nr_item_solic_compra),0)
		into STRICT	nr_item_solic_compra_ww
		from	solic_compra_item_entrega b,
			solic_compra_item a
		where	a.nr_solic_compra		= b.nr_solic_compra
		and	a.nr_item_solic_compra	= b.nr_item_solic_compra
		and	a.nr_solic_compra		= nr_solic_compra_ww
		and	to_char(a.cd_material)	= to_char(cd_material_p)
		and	b.dt_entrega_solicitada	= dt_entrega_p;

		select	max(b.ds_observacao)
		into STRICT	ds_observacao_w
		from	solic_compra_item_entrega b,
			solic_compra_item a
		where	a.nr_solic_compra		= b.nr_solic_compra
		and	a.nr_item_solic_compra	= b.nr_item_solic_compra
		and	a.nr_solic_compra		= nr_solic_compra_ww
		and	to_char(a.cd_material)	= to_char(cd_material_p)
		and	b.dt_entrega_solicitada	= dt_entrega_p;

		end;
	end if;
	end;
end if;

open c02;
loop
fetch c02 into
	nr_solic_compra_w,
	nr_item_solic_compra_w,
	qt_material_w,
	ds_observacao_w,
	nr_seq_agrup_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin
	select	coalesce(max(nr_item_oci),0) + 1
	into STRICT	nr_item_w
	from	ordem_compra_item
	where	nr_ordem_compra = nr_ordem_compra_p;

	begin
	select	coalesce(ds_material_direto_ww, a.ds_material_direto),
		b.cd_centro_custo,
		b.cd_conta_contabil,
		--a.nr_solic_compra,

		--a.nr_item_solic_compra,
		b.cd_local_estoque,
		coalesce(b.ie_aviso_chegada,'N'),
		a.ie_geracao,
		--nr_seq_proj_rec,
		nr_seq_lote_fornec,
		cd_estabelecimento,
		b.ie_urgente,
		b.nr_seq_motivo_urgente,
		a.nr_seq_criterio_rateio,
		b.cd_pessoa_solicitante
	into STRICT	ds_material_direto_w,
		cd_centro_custo_w,
		cd_conta_contabil_w,
		--nr_solic_compra_w,

		--nr_item_solic_compra_w,
		cd_local_estoque_w,
		ie_aviso_chegada_w,
		ie_geracao_w,
		--nr_seq_proj_rec_w, Retirado, pois agora ira buscar da cotacao. 18/02/2011 Andre;,
		nr_seq_lote_fornec_w,
		cd_estabelecimento_w,
		ie_urgente_w,
		nr_seq_motivo_urgente_w,
		nr_seq_criterio_rateio_w,
		cd_pessoa_solicitante_w
	from	solic_compra b,
		solic_compra_item a
	where	a.nr_solic_compra		= nr_solic_compra_w
	and	a.nr_item_solic_compra		= nr_item_solic_compra_w
	and	a.nr_solic_compra		= b.nr_solic_compra;
	exception
	when others then
		ds_material_direto_w := ds_material_direto_ww;
	end;

	if (ie_urgente_w = 'S') and (ie_urgente_param_w = 'S') then

		update	ordem_compra
		set	ie_urgente		= 'S',
			nr_seq_motivo_urgente	= nr_seq_motivo_urgente_w
		where	nr_ordem_compra		= nr_ordem_compra_p;

	end if;

	if (coalesce(cd_local_estoque_w::text, '') = '') then
		select	max(a.cd_local_estoque)
		into STRICT	cd_local_estoque_w
		from	solic_compra a
		where	nr_solic_compra = (
			SELECT	max(x.nr_solic_compra)
			from	cot_compra_solic_agrup x
			where	nr_cot_compra = nr_cot_compra_p
			and	nr_item_cot_compra = nr_item_cot_compra_p);
	end if;

	if (coalesce(cd_centro_custo_w::text, '') = '') then
		select	max(a.cd_centro_custo)
		into STRICT	cd_centro_custo_w
		from	solic_compra a
		where	nr_solic_compra = (
			SELECT	max(x.nr_solic_compra)
			from	cot_compra_solic_agrup x
			where	nr_cot_compra = nr_cot_compra_p
			and	nr_item_cot_compra = nr_item_cot_compra_p);
	end if;

	select	coalesce(cd_estabelecimento_w,cd_estabelecimento)
	into STRICT	cd_estabelecimento_w
	from	cot_compra
	where	nr_cot_compra = nr_cot_compra_p;

	if (ie_desfaz_agrupamento_p = 'S') then

		select	coalesce(sum(qt_material),0) qt_material
		into STRICT	qt_material_ww
		from	cot_compra_solic_agrup
		where	nr_cot_compra = nr_cot_compra_p
		and	nr_item_cot_compra = nr_item_cot_compra_p
		and	cd_estabelecimento = obter_estab_ordem_compra(nr_ordem_compra_p)
		and	nr_sequencia = nr_seq_agrup_w
		and	((coalesce(nr_solic_compra_w::text, '') = '') or
			(nr_solic_compra_w IS NOT NULL AND nr_solic_compra_w::text <> '' AND nr_solic_compra = nr_solic_compra_w))
		and	((coalesce(nr_item_solic_compra_w::text, '') = '') or
			(nr_item_solic_compra_w IS NOT NULL AND nr_item_solic_compra_w::text <> '' AND nr_item_solic_compra = nr_item_solic_compra_w));

		if (qt_material_ww > 0) then
			qt_material_w := qt_material_ww;
		end if;

	end if;

	if (ie_ajusta_unid_fornec_p = 'S') and (coalesce(qt_conv_unid_fornec_p,0) > 0) then
		begin
		qt_material_w		:= round((qt_material_p / qt_conv_unid_fornec_p)::numeric,0);
		qt_material_w		:= qt_material_w * qt_conv_unid_fornec_p;
		end;
	end if;

	begin
	if (coalesce(nr_solic_compra_w,0) = 0) or (coalesce(nr_item_solic_compra_w,0) = 0) then
		nr_solic_compra_w		:= null;
		nr_item_solic_compra_w	:= null;
	end if;

	/* 15/07/2004 Fabio - alterei para buscar a conta quando nao tiver informado na solicitacao*/

	if (coalesce(cd_conta_contabil_w::text, '') = '') then
		if (coalesce(cd_centro_custo_w::text, '') = '') then
			ie_tipo_conta_w	:= 2;
		else
			ie_tipo_conta_w	:= 3;
		end if;

		select	dt_ordem_compra
		into STRICT	dt_ordem_compra_w
		from	ordem_compra
		where	nr_ordem_compra = nr_ordem_compra_p;

		SELECT * FROM define_conta_material(	cd_estabelecimento_w, cd_material_p, ie_tipo_conta_w, null, null, null, null, null, null, null, cd_local_estoque_w, null, dt_ordem_compra_w, cd_conta_contabil_w, cd_centro_custo_w, null, null, null, null, null, null, null, null, null, nr_seq_proj_rec_w) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w;
	end if;


	if (nr_solic_compra_w IS NOT NULL AND nr_solic_compra_w::text <> '') and (nr_solic_compra_w > 0) then
		select	max(nr_seq_ordem_serv)
		into STRICT	nr_seq_ordem_serv_w
		from	solic_compra
		where	nr_solic_compra	= nr_solic_compra_w;

		if (nr_seq_ordem_serv_w IS NOT NULL AND nr_seq_ordem_serv_w::text <> '') then
			select	max(nr_seq_proj_gpi),
				max(nr_seq_etapa_gpi)
			into STRICT	nr_seq_proj_gpi_w,
				nr_seq_etapa_gpi_w
			from	man_ordem_servico
			where	nr_sequencia	= nr_seq_ordem_serv_w;
		else
			select	max(nr_seq_proj_gpi),
				max(nr_seq_etapa_gpi)
			into STRICT	nr_seq_proj_gpi_w,
				nr_seq_etapa_gpi_w
			from	solic_compra
			where	nr_solic_compra	= nr_solic_compra_w;
		end if;
	end if;
	
	if (ie_marca_gerar_w = 'MARCAFORNEC') and (ds_marca_w IS NOT NULL AND ds_marca_w::text <> '') then
		
		select	max(a.nr_sequencia)
		into STRICT	nr_seq_marca_w
		from	material_marca a,
			marca b
		where	a.nr_sequencia = b.nr_sequencia
		and	cd_material = cd_material_p
		and	coalesce(a.nr_seq_status_aval,0) <> 2
		and	b.ie_situacao = 'A'
		and	substr(elimina_acentuacao(upper(b.ds_marca)),1,30) like '%' || substr(elimina_acentuacao(upper(ds_marca_w)),1,30) || '%';
		
	end if;
	
	if (coalesce(nr_seq_marca_w,0) = 0) and (ds_marca2_w IS NOT NULL AND ds_marca2_w::text <> '') then
		
		select	max(a.nr_sequencia)
		into STRICT	nr_seq_marca_w
		from	material_marca a,
			marca b
		where	a.nr_sequencia = b.nr_sequencia
		and	cd_material = cd_material_p
		and	coalesce(a.nr_seq_status_aval,0) <> 2
		and	b.ie_situacao = 'A'
		and	substr(elimina_acentuacao(upper(b.ds_marca)),1,30) like '%' || substr(elimina_acentuacao(upper(ds_marca2_w)),1,30) || '%';
				
		if (coalesce(nr_seq_marca_w,0) > 0) then
			ds_marca_w := ds_marca2_w;
		end if;	
	end if;
	
	if	((ie_regra_local_w = 'S') or
		((ie_regra_local_w = 'A') and (coalesce(cd_local_estoque_w::text, '') = ''))) then
	
		select	coalesce(obter_regra_local_material(cd_estabelecimento_w,cd_material_p, 'O',ie_tipo_ordem_w), cd_local_estoque_w),
			coalesce(obter_regra_centro_custo_mat(cd_estabelecimento_w,cd_material_p, 'O',ie_tipo_ordem_w), cd_centro_custo_w)
		into STRICT	cd_local_estoque_w,
			cd_centro_custo_w
		;
	end if;

	if (coalesce(nr_item_solic_compra_w,0) <> 0) then
		select	max(nr_seq_orc_item_gpi)
		into STRICT	nr_seq_orc_item_gpi_w
		from	solic_compra_item
		where	nr_solic_compra		= nr_solic_compra_w
		and	nr_item_solic_compra	= nr_item_solic_compra_w;


		if (nr_seq_orc_item_gpi_w IS NOT NULL AND nr_seq_orc_item_gpi_w::text <> '') and (coalesce(nr_seq_conta_gpi_w::text, '') = '') then

			select	max(nr_seq_plano)
			into STRICT	nr_seq_conta_gpi_w
			from	gpi_orc_item
			where	nr_sequencia	= nr_seq_orc_item_gpi_w;

		end if;
	end if;

	select 	coalesce(obter_tipo_status_aval_marca(obter_dados_marca_material(ds_marca_w, cd_material_p,'C')),'A'),
		substr(obter_desc_material(cd_material_p),1,255)
	into STRICT	ie_tipo_status_w,
		ds_material_w
	;

	if (ie_tipo_status_w <> 'A') then
		begin
		CALL gerar_historico_cotacao(
			nr_cot_compra_p,
			WHEB_MENSAGEM_PCK.get_texto(302539),
			WHEB_MENSAGEM_PCK.get_texto(302540,'NR_ITEM_W=' || nr_item_w || ';' || 'CD_MATERIAL_P=' || cd_material_p || ';' ||
							'DS_MATERIAL_W=' || ds_material_w || ';' || 'DS_MARCA_W=' || ds_marca_w || ';' || 'DS_FORNECEDOR_W=' || ds_fornecedor_w),
			'S',
			nm_usuario_p);
		end;
	end if;
	
	vl_total_item_w := (vl_unitario_p * qt_material_w);

	insert into ordem_compra_item(
		nr_ordem_compra,			nr_item_oci,
		cd_material,			cd_unidade_medida_compra,
		vl_unitario_material,			qt_material,
		dt_atualizacao,			nm_usuario,
		ie_situacao,			cd_pessoa_solicitante,
		qt_material_entregue,		pr_descontos,
		cd_local_estoque,			ds_material_direto,
		ds_observacao,			cd_motivo_alteracao,
		nr_cot_compra,			nr_item_cot_compra,
		ds_marca,			cd_centro_custo,
		cd_conta_contabil,			nr_solic_compra,
		nr_item_solic_compra,		qt_conv_unid_fornec,
		ie_geracao_solic,			nr_seq_proj_rec,
		dt_validade,			nr_seq_ordem_serv,
		nr_seq_marca,			vl_desconto,
		nr_seq_proj_gpi,			nr_seq_etapa_gpi,
		nr_contrato,			nr_id_integracao,
		nr_seq_conta_gpi,		nr_seq_orc_item_gpi,
		nr_seq_lote_fornec,		ds_obs_item_forn,
		nr_seq_regra_contrato,		nr_seq_preco_pj,
		nr_seq_agrup,			nr_seq_criterio_rateio,
		vl_total_item,			qt_original,
		ds_marca_fornec,		nr_seq_conta_bco,
		vl_frete_rateio, 		ds_justif_escolha_fornec,
		cd_paciente_ordem_compra,cd_sequencia_parametro)
	values (nr_ordem_compra_p,			nr_item_w,
		cd_material_p,			cd_unidade_p,
		vl_unitario_p,			qt_material_w,		
		clock_timestamp(),				nm_usuario_p,
		ie_situacao_p,			cd_pessoa_solicitante_w,
		0,				pr_desconto_p,
		cd_local_estoque_w,		ds_material_direto_w,
		ds_observacao_p,			null,
		nr_cot_compra_p,			nr_item_cot_compra_p,
		ds_marca_w,			cd_centro_custo_w,
		cd_conta_contabil_w,		nr_solic_compra_w,
		nr_item_solic_compra_w,		qt_conv_unid_fornec_p,
		ie_geracao_w,			nr_seq_proj_rec_w,
		dt_validade_p,			nr_seq_ordem_serv_w,
		nr_seq_marca_w,			coalesce(vl_desconto_p,0),
		nr_seq_proj_gpi_w,			nr_seq_etapa_gpi_w,
		nr_contrato_p,			nr_id_integracao_w,
		nr_seq_conta_gpi_w,		nr_seq_orc_item_gpi_w,
		nr_seq_lote_fornec_w,		ds_observacao_p,
		nr_seq_regra_contrato_w,	nr_seq_preco_pj_w,
		nr_seq_agrup_w,			nr_seq_criterio_rateio_w,
		vl_total_item_w,		qt_material_w,
		ds_marca_fornec_p,		nr_seq_conta_bco_w,
		vl_frete_rateio_w,		ds_justif_escolha_fornec_w,
		cd_paciente_forn_item_p, philips_contabil_pck.get_parametro_conta_contabil);
	exception
	when others then
		ds_erro_w	:= sqlerrm(SQLSTATE);
	      	/*(-20011,'erro ao gravar ordem_compra_item: ' || chr(10) ||
		'Ordem: ' || NR_ORDEM_COMPRA_P || ' Cotacao: ' || NR_COT_COMPRA_P ||
		' oci: ' || NR_ITEM_COT_COMPRA_P || ' material: ' || CD_MATERIAL_P ||
		' Solic: ' || NR_SOLIC_COMPRA_P || ' Item: ' || NR_ITEM_SOLIC_COMPRA_P || chr(10) ||
		DS_ERRO_P);*/
		CALL wheb_mensagem_pck.Exibir_mensagem_abort(181622,	'NR_ORDEM_COMPRA_P='||NR_ORDEM_COMPRA_P||';'||
								'NR_COT_COMPRA_P='||NR_COT_COMPRA_P||';'||
								'NR_ITEM_COT_COMPRA_P='||NR_ITEM_COT_COMPRA_P||';'||
								'CD_MATERIAL_P='||CD_MATERIAL_P||';'||
								'NR_SOLIC_COMPRA_P='||NR_SOLIC_COMPRA_w||';'||
								'NR_ITEM_SOLIC_COMPRA_P='||NR_ITEM_SOLIC_COMPRA_w||';'||
								'DS_ERRO_P='||DS_ERRO_w);

	end;
	
	if (ie_gravar_rateio_solic_w = 'S') then
		begin
		open c06;
		loop
		fetch c06 into
			cd_centro_rat_solic_w,
			cd_conta_rat_solic_w,
			cd_conta_fin_rat_solic_w,
			vl_rateio_w,
			vl_frete_rat_solic_w,
			vl_desconto_rat_solic_w,
			vl_seguro_rat_solic_w,
			vl_despesa_rat_solic_w,
			ie_situacao_rat_solic_w,
			nr_seq_crit_rat_solic_w,
			qt_rateio_w;
		EXIT WHEN NOT FOUND; /* apply on c06 */
			begin

			select	nextval('ordem_compra_item_rateio_seq')
			into STRICT	nr_seq_rateio_w
			;

			insert into ordem_compra_item_rateio(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_ordem_compra,
				nr_item_oci,
				cd_centro_custo,
				cd_conta_contabil,
				cd_conta_financ,
				vl_rateio,
				vl_frete,
				vl_desconto,
				vl_seguro,
				vl_despesa_acessoria,
				nr_seq_criterio_rateio,
				ie_situacao,
				qt_rateio)
			values (
				nr_seq_rateio_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_ordem_compra_p,
				nr_item_w,
				cd_centro_rat_solic_w,
				cd_conta_rat_solic_w,
				cd_conta_fin_rat_solic_w,
				vl_rateio_w,
				vl_frete_rat_solic_w,
				vl_desconto_rat_solic_w,
				vl_seguro_rat_solic_w,
				vl_despesa_rat_solic_w,
				nr_seq_crit_rat_solic_w,
				ie_situacao_rat_solic_w,
				qt_rateio_w);				

			end;
		end loop;
		close c06;

		end;
	end if;
	
	ie_atualiza_opme_w :=	obter_se_mat_atualiza_tab_opme(cd_estabelecimento_w, cd_material_p);
	
	if (ie_atualiza_opme_w = 'S') then
			
		CALL cotacao_atualiza_tab_opme(
			cd_estabelecimento_w,
			cd_material_p,
			cd_moeda_w,
			clock_timestamp(),
			vl_unitario_p,
			nm_usuario_p);
	end if;
		
	update	ordem_compra
	set	cd_local_entrega	= coalesce(cd_local_estoque_w,cd_local_entrega)
	where	nr_ordem_compra		= nr_ordem_compra_p;

	if (nr_contrato_p > 0) then
		update	ordem_compra
		set	ie_tipo_ordem		= 'C'
		where	nr_ordem_compra		= nr_ordem_compra_p;
	end if;

	if (coalesce(nr_solic_compra_w,0) > 0) and (coalesce(nr_item_solic_compra_w,0) > 0) and (coalesce(ie_manual_baixa_item_w,'N') = 'N')	then
		
		select	coalesce(max(ie_cons_cot_pend),'S')
		into STRICT	ie_cotacao_pendente_w
		from	parametro_compras
		where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;
		
		if (ie_cotacao_pendente_w = 'N') then
			begin
			select	coalesce(qt_material,0)
			into STRICT	qt_material_sci_w
			from	solic_compra_item
			where	nr_solic_compra = nr_solic_compra_w
			and		nr_item_solic_compra = nr_item_solic_compra_w;
			
			if ((qt_material_sci_w - coalesce(obter_qt_sc_comprometido(nr_solic_compra_w, nr_item_solic_compra_w, null, wheb_usuario_pck.get_cd_estabelecimento),0)) <= 0) then
				update solic_compra_item
				set 	dt_baixa = clock_timestamp()
				where	nr_solic_compra = nr_solic_compra_w
				and	nr_item_solic_compra = nr_item_solic_compra_w;
			end if;
			end;				
		else
			update	Solic_compra_item
			set		dt_baixa				= clock_timestamp()
			where	nr_solic_compra			= nr_solic_compra_w
			and		nr_item_solic_compra	= nr_item_solic_compra_w;
		end if;

		CALL gerar_hist_solic_sem_commit(
			nr_solic_compra_w,
			WHEB_MENSAGEM_PCK.get_texto(297804),
			WHEB_MENSAGEM_PCK.get_texto(302542,'NR_ITEM_SOLIC_COMPRA_W=' || nr_item_solic_compra_w || ';' || 'NR_ORDEM_COMPRA_P=' || nr_ordem_compra_p),
			'B',
			nm_usuario_p);

		update	solic_compra a
		set	a.dt_baixa = clock_timestamp()
		where	a.nr_solic_compra = nr_solic_compra_w
		and	coalesce(a.dt_baixa::text, '') = ''
		and not exists (
			SELECT	1
			from	solic_compra_item x
			where	x.nr_solic_compra = a.nr_solic_compra
			and	coalesce(x.dt_baixa::text, '') = '');
		
		select	dt_baixa
		into STRICT	dt_baixa_w
		from	solic_compra
		where	nr_solic_compra	= nr_solic_compra_w;

		if (dt_baixa_w IS NOT NULL AND dt_baixa_w::text <> '') then
			CALL gerar_hist_solic_sem_commit(
					nr_solic_compra_w,
					WHEB_MENSAGEM_PCK.get_texto(297806),
					WHEB_MENSAGEM_PCK.get_texto(297807,'NR_ORDEM_COMPRA_P=' || nr_ordem_compra_p),
					'B',
					nm_usuario_p);	
		end if;
		
			
	end if;

	open C04;
	loop
	fetch C04 into
		ds_arquivo_w,
		ds_arquivo_banco_w,
		ie_doc_origem_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
		begin

		insert into ordem_compra_anexo(
			nr_sequencia,
			nr_ordem_compra,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_arquivo,
			ds_arquivo_banco,
			ie_anexar_email,
			ie_doc_origem)
		values (	nextval('ordem_compra_anexo_seq'),
			nr_ordem_compra_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			ds_arquivo_w,
			ds_arquivo_banco_w,
			'N',
			ie_doc_origem_w);

		end;
	end loop;
	close C04;

	open C05;
	loop
	fetch C05 into
		ds_titulo_w,
		ds_detalhe_w;
	EXIT WHEN NOT FOUND; /* apply on C05 */
		begin
		insert into ordem_compra_item_detalhe(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_ordem_compra,
			nr_item_oci,
			ds_titulo,
			ds_detalhe)
		values (	nextval('ordem_compra_item_detalhe_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_ordem_compra_p,
			nr_item_w,
			ds_titulo_w,
			ds_detalhe_w);
		end;
	end loop;
	close C05;

	CALL grava_entrega_item_oc(	nr_ordem_compra_p, nr_item_w, nr_cot_compra_p, nr_item_cot_compra_p,
				nr_seq_fornecedor_p, nm_usuario_p, qt_material_w, dt_entrega_p,ds_observacao_w);

	open c01;
	loop
	fetch c01 into
		cd_tributo_w,
		pr_tributo_w,
		vl_tributo_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		if (cd_tributo_w <> 0) then
			begin
			insert into ordem_compra_item_trib(
				nr_ordem_compra,
				nr_item_oci,
				cd_tributo,
				pr_tributo,
				vl_tributo,
				dt_atualizacao,
				nm_usuario,
				ds_observacao)
			values (nr_ordem_compra_p,
				nr_item_w,
				cd_tributo_w,
				pr_tributo_w,
				vl_tributo_w,
				clock_timestamp(),
				nm_usuario_p,
				null);
			exception
			when others then
				ds_erro_w	:= sqlerrm(SQLSTATE);
	        		/*(-20011,'erro ao gravar ordem_compra_item_tributo: ' ||
							ds_erro_w);*/
					CALL wheb_mensagem_pck.exibir_mensagem_abort(181624,'DS_ERRO_P='||ds_erro_w);

			end;
		end if;
		end;
	end loop;
	close c01;
	end;
end loop;
close c02;

begin
update	cot_compra_forn_item
set	nr_ordem_compra		= nr_ordem_compra_p
where	nr_cot_compra		= nr_cot_compra_p
and	nr_item_cot_compra	= nr_item_cot_compra_p
and	nr_seq_cot_forn		= nr_seq_fornecedor_p
and	coalesce(nr_ordem_compra::text, '') = '';
exception
when others then
          /*(-20011,'erro ao atualizar cot_compra_forn_item');*/

	  CALL wheb_mensagem_pck.exibir_mensagem_abort(181625);
end;

update	cot_compra_solic_agrup
set	nr_ordem_compra	= nr_ordem_compra_p
where	nr_sequencia in (
	SELECT	nr_sequencia
	from	cot_compra_solic_agrup
	where	nr_cot_compra		= nr_cot_compra_p
	and	nr_item_cot_compra	= nr_item_cot_compra_p
	and	((ie_desfaz_agrupamento_p = 'N') or (ie_desfaz_agrupamento_p = 'S' AND cd_estabelecimento = cd_estabelecimento_w) or ((ie_desfaz_agrupamento_p = 'C') and (obter_dados_solic_compra(nr_solic_compra,7) = cd_centro_custo_p))));


if (ie_aviso_chegada_w = 'S') and (ie_desmarca_chegada_material_w = 'N') then
	update	ordem_compra
	set	ie_aviso_chegada	= 'S'
	where	nr_ordem_compra	= nr_ordem_compra_p
	and	ie_aviso_chegada	= 'N';
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE grava_item_ordem_compra ( nr_ordem_compra_p bigint, cd_material_p bigint, cd_unidade_p text, vl_unitario_p bigint, qt_material_p bigint, ds_observacao_p text, ds_marca_p text, ds_marca_inf_p text, nm_usuario_p text, ie_situacao_p text, dt_entrega_p timestamp, pr_desconto_p bigint, nr_cot_compra_p bigint, nr_item_cot_compra_p bigint, nr_seq_fornecedor_p bigint, qt_conv_unid_fornec_p bigint, ie_ajusta_unid_fornec_p text, dt_validade_p timestamp, ie_desfaz_agrupamento_p text, vl_desconto_p bigint, nr_contrato_p bigint, cd_centro_custo_p bigint, ds_marca_fornec_p text, cd_paciente_forn_item_p cot_compra_forn_item.cd_paciente_forn_item%type default null) FROM PUBLIC;

