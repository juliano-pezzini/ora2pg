-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_tabela_reajuste ( nr_seq_reajuste_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


dt_reajuste_w			pls_reajuste.dt_reajuste%type;
ie_indice_reajuste_w		pls_reajuste.ie_indice_reajuste%type;
ie_indice_reajuste_contrato_w	pls_reajuste.ie_indice_reajuste_contrato%type;
ie_aplicacao_reajuste_w		pls_reajuste.ie_aplicacao_reajuste%type;
ie_reajustar_copartic_w		pls_reajuste.ie_reajustar_copartic%type;
tx_reajuste_copartic_w		pls_reajuste.tx_reajuste_copartic%type;
tx_reajuste_copartic_max_w	pls_reajuste.tx_reajuste_copartic_max%type;
ie_regulamentacao_reaj_w	pls_reajuste.ie_regulamentacao%type;
ie_reajustar_inscricao_w	pls_reajuste.ie_reajustar_inscricao%type;
tx_reajuste_inscricao_w		pls_reajuste.tx_reajuste_inscricao%type;
ie_vinculo_coparticipacao_w	pls_reajuste.ie_vinculo_coparticipacao%type;
ie_tipo_operacao_contrato_w	pls_reajuste.ie_tipo_operacao_contrato%type;
nr_seq_contrato_w		pls_contrato.nr_sequencia%type;
nr_seq_contrato_ww		pls_contrato.nr_sequencia%type;
nr_seq_contrato_reaj_w		pls_contrato.nr_sequencia%type;
dt_contrato_w			pls_contrato.dt_contrato%type;
dt_rescisao_contrato_w		pls_contrato.dt_rescisao_contrato%type;
nr_seq_indice_reajuste_w	pls_contrato.nr_seq_indice_reajuste%type;
nr_seq_regra_w			pls_regra_reajuste.nr_sequencia%type;
ie_regra_correcao_w		pls_regra_reajuste.ie_regra_correcao%type;
nr_seq_plano_w			pls_plano.nr_sequencia%type;
ie_tipo_operacao_plano_w	pls_plano.ie_tipo_operacao%type;
nr_seq_tabela_w			pls_tabela_preco.nr_sequencia%type;
nr_seq_lote_reaj_copart_w	pls_lote_reaj_copartic.nr_sequencia%type;
nr_seq_lote_reaj_inscricao_w	pls_lote_reaj_inscricao.nr_sequencia%type;
nr_seq_reaj_tabela_w		pls_reajuste_tabela.nr_sequencia%type;
ie_reajustar_benef_cancelado_w	pls_parametros.ie_reajustar_benef_cancelado%type;
ie_reaj_tab_contrato_benef_w	pls_parametros.ie_reaj_tab_contrato_benef%type;
ie_indice_ans_w			moeda.ie_indice_ans%type;
qt_registros_w			integer;
qt_regra_copartic_w		integer;
qt_regra_inscricao_w		integer;
qt_reaj_aplicado_w		integer;
qt_lote_reaj_copartic_w		integer;
qt_lote_desf_reaj_copartic_w	integer;
qt_lote_reaj_inscricao_w	integer;
ie_aplicar_definitivo_w		varchar(10);
ds_mes_reajuste_w		varchar(2);
ie_permite_reajuste_w		pls_plano.ie_permite_reajuste%type;
tx_reajuste_lote_w		pls_reajuste.tx_reajuste%type;
tx_reajuste_liminar_w		pls_reajuste.tx_reajuste%type;
nr_seq_processo_w		processo_judicial_liminar.nr_sequencia%type;
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
nr_seq_grupo_produto_w		plS_grupo_produto.nr_sequencia%type;
qt_regra_grupo_prod_w		bigint;
qt_regra_ativa_w		bigint;
ie_permite_reajustar_w		varchar(1);
nr_seq_plano_ww			pls_plano.nr_sequencia%type;
nr_seq_processo_reaj_w		pls_processo_judicial_reaj.nr_sequencia%type;
nr_seq_titular_w		pls_segurado.nr_seq_titular%type;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;

C01 CURSOR FOR
	SELECT	b.nr_sequencia, --Tabela do contrato
		c.nr_sequencia,
		a.dt_contrato,
		a.nr_sequencia,
		a.dt_rescisao_contrato,
		a.nr_seq_indice_reajuste,
		'S' ie_permite_reajuste,
		b.nr_segurado,
		coalesce((pls_obter_dados_segurado(b.nr_segurado, 'NRTI'))::numeric , b.nr_segurado) nr_seq_titular,
		pls_obter_dados_segurado(b.nr_segurado, 'PF') cd_pessoa_fisica
	from	pls_contrato		a,
		pls_contrato_plano	d,
		pls_tabela_preco	b,
		pls_plano		c
	where	a.nr_sequencia		= d.nr_seq_contrato
	and	c.nr_sequencia		= b.nr_seq_plano
	and	c.nr_sequencia		= d.nr_seq_plano
	and	b.nr_sequencia		= d.nr_seq_tabela
	and	c.cd_estabelecimento	= cd_estabelecimento_p
	and	(a.cd_pf_estipulante IS NOT NULL AND a.cd_pf_estipulante::text <> '')
	and	b.ie_tabela_base	= 'N'
	and	c.ie_tipo_contratacao	= 'I'
	and	a.ie_situacao not in ('1','4')
	and	pls_obter_mes_reaj_contrato(a.nr_sequencia,null,'MM') = ds_mes_reajuste_w
	and	a.dt_contrato < dt_reajuste_w
	and	((ie_reaj_tab_contrato_benef_w = 'N' AND a.ie_reajuste = 'C') or (ie_reaj_tab_contrato_benef_w = 'S'))
	and 	add_months(trunc(coalesce(a.dt_reajuste,a.dt_contrato),'mm'),12) <= dt_reajuste_w
	and	((a.ie_tipo_operacao = ie_tipo_operacao_contrato_w) or (coalesce(ie_tipo_operacao_contrato_w::text, '') = ''))
	and	((c.ie_tipo_operacao = ie_tipo_operacao_plano_w) or (coalesce(ie_tipo_operacao_plano_w::text, '') = ''))
	and	((a.nr_seq_indice_reajuste = ie_indice_reajuste_contrato_w) or (coalesce(ie_indice_reajuste_contrato_w::text, '') = ''))
	and	((c.ie_regulamentacao = ie_regulamentacao_reaj_w) or (coalesce(ie_regulamentacao_reaj_w::text, '') = ''))
	and	((a.nr_sequencia = nr_seq_contrato_reaj_w) or (coalesce(nr_seq_contrato_reaj_w::text, '') = ''))
	
union

	SELECT	c.nr_sequencia, --Tabela vinculada ao beneficiario
		d.nr_sequencia,
		b.dt_contrato,
		b.nr_sequencia,
		b.dt_rescisao_contrato,
		b.nr_seq_indice_reajuste,
		'S' ie_permite_reajuste,
		c.nr_segurado,
		coalesce((pls_obter_dados_segurado(c.nr_segurado, 'NRTI'))::numeric , c.nr_segurado) nr_seq_titular,
		pls_obter_dados_segurado(c.nr_segurado, 'PF') cd_pessoa_fisica
	from	pls_segurado		a,
		pls_contrato		b,
		pls_tabela_preco	c,
		pls_plano		d
	where	b.nr_sequencia		= a.nr_seq_contrato
	and	d.nr_sequencia		= c.nr_seq_plano
	and	c.nr_sequencia		= a.nr_seq_tabela
	and	d.cd_estabelecimento	= cd_estabelecimento_p
	and	(b.cd_pf_estipulante IS NOT NULL AND b.cd_pf_estipulante::text <> '')
	and	c.ie_tabela_base	= 'N'
	and	d.ie_tipo_contratacao	= 'I'
	and	b.ie_situacao not in ('1','4')
	and	pls_obter_mes_reaj_segurado(a.nr_sequencia,'MM') = ds_mes_reajuste_w
	and	b.dt_contrato < dt_reajuste_w
	and	((b.ie_reajuste = 'C' and add_months(trunc(b.dt_contrato,'mm'),12) <= dt_reajuste_w) or (b.ie_reajuste = 'A' and add_months(trunc(coalesce(a.dt_reajuste,a.dt_contratacao),'mm'),12) <= dt_reajuste_w))
	and	not exists (	select	1
				from	pls_contrato_plano x
				where	x.nr_seq_contrato	= b.nr_sequencia
				and	x.nr_seq_tabela		= a.nr_seq_tabela)
	and	((b.ie_tipo_operacao = ie_tipo_operacao_contrato_w) or (coalesce(ie_tipo_operacao_contrato_w::text, '') = ''))
	and	((d.ie_tipo_operacao = ie_tipo_operacao_plano_w) or (coalesce(ie_tipo_operacao_plano_w::text, '') = ''))
	and	((b.nr_seq_indice_reajuste = ie_indice_reajuste_contrato_w) or (coalesce(ie_indice_reajuste_contrato_w::text, '') = ''))
	and	((d.ie_regulamentacao = ie_regulamentacao_reaj_w) or (coalesce(ie_regulamentacao_reaj_w::text, '') = ''))
	and	((b.nr_sequencia = nr_seq_contrato_reaj_w) or (coalesce(nr_seq_contrato_reaj_w::text, '') = ''))
	
union

	select	b.nr_sequencia,	--Tabela antiga do contrato
		c.nr_sequencia,
		a.dt_contrato,
		a.nr_sequencia,
		a.dt_rescisao_contrato,
		a.nr_seq_indice_reajuste,
		'S' ie_permite_reajuste,
		null,
		null,
		null
	from	pls_contrato 		a,
		pls_tabela_preco 	b,
		pls_plano		c
	where	a.nr_sequencia 		= b.nr_contrato
	and	c.nr_sequencia		= b.nr_seq_plano
	and	a.cd_estabelecimento 	= cd_estabelecimento_p
	and	(a.cd_pf_estipulante IS NOT NULL AND a.cd_pf_estipulante::text <> '')
	and	b.ie_tabela_base	= 'N'
	and	c.ie_tipo_contratacao	= 'I'
	and	a.ie_situacao not in ('1','4')
	and	coalesce(b.nr_segurado::text, '') = ''
	and	pls_obter_mes_reaj_contrato(a.nr_sequencia,null,'MM') = ds_mes_reajuste_w
	and	a.dt_contrato < dt_reajuste_w
	and	((ie_reaj_tab_contrato_benef_w = 'N' AND a.ie_reajuste = 'C') or (ie_reaj_tab_contrato_benef_w = 'S'))
	and 	add_months(trunc(coalesce(a.dt_reajuste,a.dt_contrato),'mm'),12) <= dt_reajuste_w
	and	((a.ie_tipo_operacao = ie_tipo_operacao_contrato_w) or (coalesce(ie_tipo_operacao_contrato_w::text, '') = ''))
	and	((c.ie_tipo_operacao = 'B') and (('A' <> ie_tipo_operacao_plano_w) or (coalesce(ie_tipo_operacao_plano_w::text, '') = ''))) --Buscar somente as tabelas de preco anteriores quando for reajuste do produto
	and	((a.nr_seq_indice_reajuste = ie_indice_reajuste_contrato_w) or (coalesce(ie_indice_reajuste_contrato_w::text, '') = ''))
	and	((c.ie_regulamentacao = ie_regulamentacao_reaj_w) or (coalesce(ie_regulamentacao_reaj_w::text, '') = ''))
	and	((a.nr_sequencia = nr_seq_contrato_reaj_w) or (coalesce(nr_seq_contrato_reaj_w::text, '') = ''))
	
union

	select	c.nr_sequencia, --Tabela antiga do beneficiario
		d.nr_sequencia,
		b.dt_contrato,
		b.nr_sequencia,
		b.dt_rescisao_contrato,
		b.nr_seq_indice_reajuste,
		'S' ie_permite_reajuste,
		c.nr_segurado,
		coalesce((pls_obter_dados_segurado(c.nr_segurado, 'NRTI'))::numeric , c.nr_segurado) nr_seq_titular,
		pls_obter_dados_segurado(c.nr_segurado, 'PF') cd_pessoa_fisica
	from	pls_segurado		a,
		pls_contrato		b,
		pls_tabela_preco	c,
		pls_plano		d
	where	b.nr_sequencia		= a.nr_seq_contrato
	and	d.nr_sequencia		= c.nr_seq_plano
	and	a.nr_sequencia		= c.nr_segurado
	and	d.cd_estabelecimento	= cd_estabelecimento_p
	and	(b.cd_pf_estipulante IS NOT NULL AND b.cd_pf_estipulante::text <> '')
	and	c.ie_tabela_base	= 'N'
	and	d.ie_tipo_contratacao	= 'I'
	and	b.ie_situacao not in ('1','4')
	and	pls_obter_mes_reaj_segurado(a.nr_sequencia,'MM') = ds_mes_reajuste_w
	and	b.dt_contrato 		< dt_reajuste_w
	and	((b.ie_reajuste = 'C' and add_months(trunc(b.dt_contrato,'mm'),12) <= dt_reajuste_w) or (b.ie_reajuste = 'A' and add_months(trunc(coalesce(a.dt_reajuste,a.dt_contratacao),'mm'),12) <= dt_reajuste_w))
	and	not exists (	select	1
				from	pls_contrato_plano x
				where	x.nr_seq_contrato	= b.nr_sequencia
				and	x.nr_seq_tabela		= c.nr_sequencia)
	and	((b.ie_tipo_operacao = ie_tipo_operacao_contrato_w) or (coalesce(ie_tipo_operacao_contrato_w::text, '') = ''))
	and	((d.ie_tipo_operacao = 'B') and (('A' <> ie_tipo_operacao_plano_w) or (coalesce(ie_tipo_operacao_plano_w::text, '') = ''))) --Buscar somente as tabelas de preco anteriores quando for reajuste do produto
	and	((b.nr_seq_indice_reajuste = ie_indice_reajuste_contrato_w) or (coalesce(ie_indice_reajuste_contrato_w::text, '') = ''))
	and	((d.ie_regulamentacao = ie_regulamentacao_reaj_w) or (coalesce(ie_regulamentacao_reaj_w::text, '') = ''))
	and	((b.nr_sequencia = nr_seq_contrato_reaj_w) or (coalesce(nr_seq_contrato_reaj_w::text, '') = ''))
	
union

	select	b.nr_sequencia, --Tabela padrao do SCA para o contrato
		c.nr_sequencia,
		a.dt_contrato,
		a.nr_sequencia,
		a.dt_rescisao_contrato,
		a.nr_seq_indice_reajuste,
		c.ie_permite_reajuste,
		b.nr_segurado,
		coalesce((pls_obter_dados_segurado(b.nr_segurado, 'NRTI'))::numeric , b.nr_segurado) nr_seq_titular,
		pls_obter_dados_segurado(b.nr_segurado, 'PF') cd_pessoa_fisica
	from	pls_contrato		a,
		pls_tabela_preco	b,
		pls_plano		c,
		pls_sca_regra_contrato	d
	where	c.nr_sequencia		= b.nr_seq_plano
	and	c.nr_sequencia		= d.nr_seq_plano
	and	b.nr_sequencia		= d.nr_seq_tabela
	and	a.nr_sequencia		= d.nr_seq_contrato
	and	b.nr_contrato		= a.nr_sequencia
	and	c.cd_estabelecimento	= cd_estabelecimento_p
	and	(a.cd_pf_estipulante IS NOT NULL AND a.cd_pf_estipulante::text <> '')
	and	b.ie_tabela_base	= 'N'
	and	a.ie_situacao not in ('1','4')
	and	pls_obter_mes_reaj_contrato(a.nr_sequencia,null,'MM') = ds_mes_reajuste_w
	and	a.dt_contrato < dt_reajuste_w
	--and	a.ie_reajuste 	= 'C'
	and	add_months(trunc(coalesce(a.dt_reajuste,a.dt_contrato),'mm'),12) <= dt_reajuste_w
	and	((a.ie_tipo_operacao = ie_tipo_operacao_contrato_w) or (coalesce(ie_tipo_operacao_contrato_w::text, '') = ''))
	and	((c.ie_tipo_operacao = ie_tipo_operacao_plano_w) or (coalesce(ie_tipo_operacao_plano_w::text, '') = ''))
	and	((a.nr_seq_indice_reajuste = ie_indice_reajuste_contrato_w) or (coalesce(ie_indice_reajuste_contrato_w::text, '') = ''))
	and	((c.ie_regulamentacao = ie_regulamentacao_reaj_w) or (coalesce(ie_regulamentacao_reaj_w::text, '') = ''))
	and	((a.nr_sequencia = nr_seq_contrato_reaj_w) or (coalesce(nr_seq_contrato_reaj_w::text, '') = ''))
	
union

	select	d.nr_sequencia, --Tabela para o SCA vinculado ao beneficiario
		c.nr_seq_plano,
		a.dt_contrato,
		a.nr_sequencia,
		a.dt_rescisao_contrato,
		a.nr_seq_indice_reajuste,
		e.ie_permite_reajuste,
		d.nr_segurado,
		coalesce((pls_obter_dados_segurado(d.nr_segurado, 'NRTI'))::numeric , d.nr_segurado) nr_seq_titular,
		pls_obter_dados_segurado(d.nr_segurado, 'PF') cd_pessoa_fisica
	from	pls_segurado		b,
		pls_contrato		a,
		pls_sca_vinculo		c,
		pls_tabela_preco	d,
		pls_plano		e,
		pls_plano		f
	where	a.nr_sequencia		= b.nr_seq_contrato
	and	c.nr_seq_segurado	= b.nr_sequencia
	and	c.nr_seq_tabela		= d.nr_sequencia
	and	c.nr_seq_plano		= e.nr_sequencia
	and	b.nr_seq_plano		= f.nr_sequencia
	and	e.cd_estabelecimento	= cd_estabelecimento_p
	and	(a.cd_pf_estipulante IS NOT NULL AND a.cd_pf_estipulante::text <> '')
	and	d.ie_tabela_base	= 'N'
	and	a.ie_situacao not in ('1','4')
	and	(((c.dt_reajuste IS NOT NULL AND c.dt_reajuste::text <> '') and (to_char(c.dt_reajuste,'mm')	= to_char(dt_reajuste_w,'mm')) and (to_char(dt_reajuste_w,'yyyy') <> to_char(c.dt_reajuste,'yyyy')))
		or	((coalesce(c.dt_reajuste::text, '') = '') and	pls_obter_mes_reaj_segurado(b.nr_sequencia,'MM') = ds_mes_reajuste_w))
	and	a.dt_contrato < dt_reajuste_w
	and	((a.ie_reajuste = 'C' and add_months(trunc(a.dt_contrato,'mm'),12) <= dt_reajuste_w) or (a.ie_reajuste = 'A' and add_months(trunc(coalesce(b.dt_reajuste,b.dt_contratacao),'mm'),12) <= dt_reajuste_w))
	and	not exists (	select	1
				from	pls_sca_regra_contrato x
				where	x.nr_seq_contrato	= a.nr_sequencia
				and	x.nr_seq_tabela		= c.nr_seq_tabela)
	and	trunc(dt_reajuste_w,'month') >= trunc(c.dt_inicio_vigencia,'month')
	and	((a.ie_tipo_operacao = ie_tipo_operacao_contrato_w) or (coalesce(ie_tipo_operacao_contrato_w::text, '') = ''))
	and	((e.ie_tipo_operacao = ie_tipo_operacao_plano_w) or (coalesce(ie_tipo_operacao_plano_w::text, '') = ''))
	and	((a.nr_seq_indice_reajuste = ie_indice_reajuste_contrato_w) or (coalesce(ie_indice_reajuste_contrato_w::text, '') = ''))
	and	((f.ie_regulamentacao = ie_regulamentacao_reaj_w) or (coalesce(ie_regulamentacao_reaj_w::text, '') = ''))
	and	((a.nr_sequencia = nr_seq_contrato_reaj_w) or (coalesce(nr_seq_contrato_reaj_w::text, '') = ''));

C02 CURSOR FOR
	SELECT	a.nr_sequencia nr_seq_contrato,
		a.nr_seq_indice_reajuste,
		c.nr_sequencia nr_seq_plano
	from	pls_contrato		a,
		pls_contrato_plano	d,
		pls_tabela_preco	b,
		pls_plano		c
	where	a.nr_sequencia		= d.nr_seq_contrato
	and	c.nr_sequencia		= b.nr_seq_plano
	and	c.nr_sequencia		= d.nr_seq_plano
	and	b.nr_sequencia		= d.nr_seq_tabela
	and	c.cd_estabelecimento	= cd_estabelecimento_p
	and	b.ie_tabela_base	= 'N'
	and	c.ie_tipo_contratacao	= 'I'
	and	a.ie_tipo_operacao	<> 'A'
	and	a.ie_situacao not in ('1','4')
	and	((coalesce(d.dt_inativacao::text, '') = '') or (d.dt_inativacao > dt_reajuste_w))
	and	pls_obter_mes_reaj_contrato(a.nr_sequencia,null,'MM') = ds_mes_reajuste_w
	and	a.dt_contrato < dt_reajuste_w
	and	add_months(trunc(a.dt_contrato,'mm'),12) <= dt_reajuste_w
	and	((a.ie_tipo_operacao = ie_tipo_operacao_contrato_w) or (coalesce(ie_tipo_operacao_contrato_w::text, '') = ''))
	and	((a.nr_seq_indice_reajuste = ie_indice_reajuste_contrato_w) or (coalesce(ie_indice_reajuste_contrato_w::text, '') = ''))
	and	((c.ie_regulamentacao = ie_regulamentacao_reaj_w) or (coalesce(ie_regulamentacao_reaj_w::text, '') = ''))
	and	((a.nr_sequencia = nr_seq_contrato_reaj_w) or (coalesce(nr_seq_contrato_reaj_w::text, '') = ''))
	group by
		a.nr_sequencia,
		a.nr_seq_indice_reajuste,
		c.nr_Sequencia;

TYPE		fetch_array IS TABLE OF c02%ROWTYPE;
s_array 	fetch_array;
i		integer := 1;
type Vetor is table of fetch_array index by integer;
Vetor_c02_w	Vetor;

BEGIN

select	trunc(dt_reajuste,'month'),
	ie_indice_reajuste,
	ie_indice_reajuste_contrato,
	coalesce(ie_aplicacao_reajuste,'G'),
	coalesce(ie_reajustar_copartic,'N'),
	coalesce(tx_reajuste_copartic, tx_reajuste),
	coalesce(tx_reajuste_copartic_max, tx_reajuste),
	ie_regulamentacao,
	coalesce(ie_reajustar_inscricao,'N'),
	coalesce(tx_reajuste_inscricao, tx_reajuste),
	ie_vinculo_coparticipacao,
	nr_seq_contrato,
	nr_seq_regra,
	ie_tipo_operacao_contrato,
	tx_reajuste,
	nr_seq_grupo_produto
into STRICT	dt_reajuste_w,
	ie_indice_reajuste_w,
	ie_indice_reajuste_contrato_w,
	ie_aplicacao_reajuste_w,
	ie_reajustar_copartic_w,
	tx_reajuste_copartic_w,
	tx_reajuste_copartic_max_w,
	ie_regulamentacao_reaj_w,
	ie_reajustar_inscricao_w,
	tx_reajuste_inscricao_w,
	ie_vinculo_coparticipacao_w,
	nr_seq_contrato_reaj_w,
	nr_seq_regra_w,
	ie_tipo_operacao_contrato_w,
	tx_reajuste_lote_w,
	nr_seq_grupo_produto_w
from	pls_reajuste
where	nr_sequencia	= nr_seq_reajuste_p;

ds_mes_reajuste_w	:= to_char(dt_reajuste_w,'mm');

select	max(ie_regra_correcao)
into STRICT	ie_regra_correcao_w
from	pls_regra_reajuste
where	nr_sequencia	= nr_seq_regra_w;

ie_regra_correcao_w	:= coalesce(ie_regra_correcao_w,'N');

select	max(ie_reajustar_benef_cancelado),
	coalesce(max(ie_reaj_tab_contrato_benef),'S')
into STRICT	ie_reajustar_benef_cancelado_w,
	ie_reaj_tab_contrato_benef_w
from	pls_parametros
where	cd_estabelecimento	= cd_estabelecimento_p;

ie_reajustar_benef_cancelado_w	:= coalesce(ie_reajustar_benef_cancelado_w,'T');

if (ie_aplicacao_reajuste_w = 'G') then --Ambos
	ie_tipo_operacao_plano_w	:= null;
elsif (ie_aplicacao_reajuste_w = 'C') then --Produto
	ie_tipo_operacao_plano_w	:= 'B';
elsif (ie_aplicacao_reajuste_w = 'S') then --SCA
	ie_tipo_operacao_plano_w	:= 'A';
end if;

open C01;
loop
fetch C01 into
	nr_seq_tabela_w,
	nr_seq_plano_w,
	dt_contrato_w,
	nr_seq_contrato_w,
	dt_rescisao_contrato_w,
	nr_seq_indice_reajuste_w,
	ie_permite_reajuste_w,
	nr_seq_segurado_w,
	nr_seq_titular_w,
	cd_pessoa_fisica_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ie_indice_ans_w := 'N';
	
	if (ie_indice_reajuste_w = '1' and coalesce(nr_seq_indice_reajuste_w::text, '') = '') then
		ie_indice_ans_w := 'S';
	elsif (ie_indice_reajuste_w = '1' and (nr_seq_indice_reajuste_w IS NOT NULL AND nr_seq_indice_reajuste_w::text <> '')) then
		select	coalesce(ie_indice_ans,'S')
		into STRICT	ie_indice_ans_w
		from	moeda
		where	cd_moeda = nr_seq_indice_reajuste_w;
	end if;

	if (nr_seq_grupo_produto_w IS NOT NULL AND nr_seq_grupo_produto_w::text <> '') then
		select	count(1)
		into STRICT	qt_regra_ativa_w
		from	pls_grupo_produto
		where	nr_sequencia = nr_seq_grupo_produto_w
		and	ie_situacao = 'A';

		if (qt_regra_ativa_w > 0) then
			select	count(1)
			into STRICT	qt_regra_grupo_prod_w
			from	pls_produto_grupo
			where	nr_seq_grupo = nr_seq_grupo_produto_w
			and	nr_seq_plano = nr_seq_plano_w;

			if (qt_regra_grupo_prod_w = 0) then
				ie_permite_reajuste_w := 'N';
			end if;
		end if;
	end if;
	
	if (ie_permite_reajuste_w = 'S') and (ie_indice_reajuste_w <> '1' or ie_indice_ans_w = 'S') then
		select	count(1)
		into STRICT	qt_reaj_aplicado_w
		from	pls_reajuste_tabela a,
			pls_reajuste y
		where	a.nr_seq_reajuste = y.nr_sequencia
		and	a.nr_seq_tabela	= nr_seq_tabela_w
		and	coalesce(y.ie_tipo_lote,'A') <> 'D'
		and	trunc(y.dt_reajuste,'month') = dt_reajuste_w
		and	not exists (	SELECT	1
					from	pls_reajuste_tabela x,
						pls_reajuste z
					where	x.nr_seq_reajuste = z.nr_sequencia
					and (z.nr_seq_reajuste_desfazer = y.nr_sequencia or z.nr_seq_contrato = a.nr_seq_contrato)
					and	x.nr_seq_tabela	= nr_seq_tabela_w
					and	coalesce(z.ie_tipo_lote,'A') = 'D'
					and	trunc(z.dt_reajuste,'month') = dt_reajuste_w);
		
		if	((qt_reaj_aplicado_w = 0) or (ie_regra_correcao_w = 'S')) and
			(((coalesce(dt_rescisao_contrato_w::text, '') = '') or (dt_rescisao_contrato_w > dt_reajuste_w)) or
			((dt_rescisao_contrato_w IS NOT NULL AND dt_rescisao_contrato_w::text <> '') and (ie_reajustar_benef_cancelado_w in ('T','I')))) then
			select	count(1)
			into STRICT	qt_registros_w
			from	pls_reajuste_tabela	a,
				pls_reajuste		b
			where	a.nr_seq_reajuste	= b.nr_sequencia
			and	a.nr_seq_tabela		= nr_seq_tabela_w
			and	b.nr_sequencia		= nr_seq_reajuste_p;
			
			if (qt_registros_w	= 0) then			
				SELECT * FROM pls_obter_processo_reaj(null, nr_seq_segurado_w, nr_seq_titular_w, cd_pessoa_fisica_w, dt_reajuste_w, nr_seq_processo_w, tx_reajuste_liminar_w) INTO STRICT nr_seq_processo_w, tx_reajuste_liminar_w;

				select	nextval('pls_reajuste_tabela_seq')
				into STRICT	nr_seq_reaj_tabela_w
				;
				
				insert into pls_reajuste_tabela(nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						nr_seq_reajuste,
						nr_seq_tabela,
						nr_seq_plano,
						dt_contrato,
						dt_inicio_vigencia,
						nr_seq_contrato,
						ie_origem_tabela,
						nr_seq_processo,
						tx_reajuste)
					values (nr_seq_reaj_tabela_w,
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_reajuste_p,
						nr_seq_tabela_w,
						nr_seq_plano_w,
						dt_contrato_w,
						dt_reajuste_w,
						nr_seq_contrato_w,
						'B',
						nr_seq_processo_w,
						coalesce(tx_reajuste_liminar_w,tx_reajuste_lote_w));
			end if;
		end if;
	end if;
	end;
end loop;
close C01;

if (ie_reajustar_copartic_w	= 'S') or (ie_reajustar_inscricao_w	= 'S') then
	open c02;
	loop
	fetch C02 bulk collect into s_array limit 1000;
		Vetor_c02_w(i) := s_array;
		i := i + 1;
	EXIT WHEN NOT FOUND; /* apply on C02 */
	end loop;
	close C02;
end if;

if (ie_reajustar_copartic_w = 'S') then
	for i in 1..Vetor_c02_w.count loop
		s_array := Vetor_c02_w(i);
		for z in 1..s_array.count loop
			begin
			nr_seq_contrato_ww	 := s_array[z].nr_seq_contrato;
			nr_seq_indice_reajuste_w := s_array[z].nr_seq_indice_reajuste;
			nr_seq_plano_ww		 := s_array[z].nr_seq_plano;
			ie_indice_ans_w 	 := 'N';
			ie_permite_reajustar_w	 := 'S';

			if (nr_seq_grupo_produto_w IS NOT NULL AND nr_seq_grupo_produto_w::text <> '') then
				select	count(1)
				into STRICT	qt_regra_ativa_w
				from	pls_grupo_produto
				where	nr_sequencia = nr_seq_grupo_produto_w
				and	ie_situacao = 'A';

				if (qt_regra_ativa_w > 0) then
					select	count(1)
					into STRICT	qt_regra_grupo_prod_w
					from	pls_produto_grupo
					where	nr_seq_grupo = nr_seq_grupo_produto_w
					and	nr_seq_plano = nr_seq_plano_ww;

					if (qt_regra_grupo_prod_w = 0) then
						ie_permite_reajustar_w := 'N';
					end if;
				end if;
			end if;
				
			if (ie_indice_reajuste_w = '1' and coalesce(nr_seq_indice_reajuste_w::text, '') = '') then
				ie_indice_ans_w := 'S';
			elsif (ie_indice_reajuste_w = '1' and (nr_seq_indice_reajuste_w IS NOT NULL AND nr_seq_indice_reajuste_w::text <> '')) then
				select	coalesce(ie_indice_ans,'S')
				into STRICT	ie_indice_ans_w
				from	moeda
				where	cd_moeda = nr_seq_indice_reajuste_w;
			end if;
			
			if	((ie_indice_reajuste_w <> '1' or ie_indice_ans_w = 'S') AND ie_permite_reajustar_w = 'S') then
				select	count(1)
				into STRICT	qt_lote_reaj_copartic_w
				from	pls_lote_reaj_copartic
				where	nr_seq_contrato	= nr_seq_contrato_ww
				and	dt_referencia	= dt_reajuste_w
				and	ie_vinculo_coparticipacao = ie_vinculo_coparticipacao_w;
				
				if (qt_lote_reaj_copartic_w > 0) then --Verificar se o reajuste de coparticipacao foi desfeito, se foi e preciso gerar novamente
					select	count(1)
					into STRICT	qt_lote_desf_reaj_copartic_w
					from	pls_lote_reaj_copartic a,
						pls_reajuste b
					where	b.nr_sequencia		= a.nr_seq_reajuste
					and	a.nr_seq_contrato	= nr_seq_contrato_ww
					and	a.dt_referencia		= dt_reajuste_w
					and	a.ie_vinculo_coparticipacao = ie_vinculo_coparticipacao_w
					and	b.ie_tipo_lote = 'D';
					
					if (qt_lote_desf_reaj_copartic_w > 0) then
						select	count(1)
						into STRICT	qt_lote_reaj_copartic_w
						from	pls_lote_reaj_copartic
						where	nr_seq_contrato	= nr_seq_contrato_ww
						and	dt_referencia	= dt_reajuste_w
						and	ie_vinculo_coparticipacao = ie_vinculo_coparticipacao_w
						and	nr_seq_reajuste	= nr_seq_reajuste_p;
					end if;
				end if;
				
				if (qt_lote_reaj_copartic_w	= 0) then
					select	nextval('pls_lote_reaj_copartic_seq')
					into STRICT	nr_seq_lote_reaj_copart_w
					;
					
					insert	into	pls_lote_reaj_copartic(	nr_sequencia, nr_seq_contrato, cd_estabelecimento,
							dt_referencia, dt_atualizacao, nm_usuario,
							dt_atualizacao_nrec, nm_usuario_nrec, tx_reajuste,
							tx_reajuste_vl_maximo, nr_seq_reajuste, ie_vinculo_coparticipacao)
						values (	nr_seq_lote_reaj_copart_w, nr_seq_contrato_ww, cd_estabelecimento_p,
							dt_reajuste_w, clock_timestamp(), nm_usuario_p,
							clock_timestamp(), nm_usuario_p, tx_reajuste_copartic_w,
							tx_reajuste_copartic_max_w, nr_seq_reajuste_p, ie_vinculo_coparticipacao_w);
					
					CALL pls_incluir_copartic_lote_reaj(nr_seq_lote_reaj_copart_w, cd_estabelecimento_p, 'N', nm_usuario_p);
					
					select	count(1)
					into STRICT	qt_regra_copartic_w
					from	pls_reajuste_copartic
					where	nr_seq_lote	= nr_seq_lote_reaj_copart_w;
					
					if (qt_regra_copartic_w = 0) then
						delete	from	pls_lote_reaj_copartic
						where	nr_sequencia	= nr_seq_lote_reaj_copart_w;
					end if;
				end if;
			end if;
			end;
		end loop;
	end loop;
end if;

if (ie_reajustar_inscricao_w = 'S') then
	for i in 1..Vetor_c02_w.count loop
		s_array := Vetor_c02_w(i);
		for z in 1..s_array.count loop
			begin
			nr_seq_contrato_ww	 := s_array[z].nr_seq_contrato;
			nr_seq_indice_reajuste_w := s_array[z].nr_seq_indice_reajuste;
			ie_indice_ans_w := 'N';
			
			if (ie_indice_reajuste_w = '1' and coalesce(nr_seq_indice_reajuste_w::text, '') = '') then
				ie_indice_ans_w := 'S';
			elsif (ie_indice_reajuste_w = '1' and (nr_seq_indice_reajuste_w IS NOT NULL AND nr_seq_indice_reajuste_w::text <> '')) then
				select	coalesce(ie_indice_ans,'S')
				into STRICT	ie_indice_ans_w
				from	moeda
				where	cd_moeda = nr_seq_indice_reajuste_w;
			end if;
			
			if (ie_indice_reajuste_w <> '1' or ie_indice_ans_w = 'S') then
				select	count(1)
				into STRICT	qt_lote_reaj_inscricao_w
				from	pls_lote_reaj_inscricao
				where	nr_seq_contrato		= nr_seq_contrato_ww
				and	dt_referencia		= dt_reajuste_w;
				
				if (qt_lote_reaj_inscricao_w	= 0) then
					select	nextval('pls_lote_reaj_inscricao_seq')
					into STRICT	nr_seq_lote_reaj_inscricao_w
					;
					
					insert	into	pls_lote_reaj_inscricao(	nr_sequencia, nr_seq_contrato, cd_estabelecimento,
							dt_referencia, dt_atualizacao, nm_usuario,
							dt_atualizacao_nrec, nm_usuario_nrec, tx_reajuste,
							nr_seq_reajuste)
						values (	nr_seq_lote_reaj_inscricao_w, nr_seq_contrato_ww, cd_estabelecimento_p,
							dt_reajuste_w, clock_timestamp(), nm_usuario_p,
							clock_timestamp(), nm_usuario_p, tx_reajuste_inscricao_w,
							nr_seq_reajuste_p);
					
					CALL pls_incluir_inscricao_reaj(nr_seq_lote_reaj_inscricao_w, cd_estabelecimento_p, nm_usuario_p);
					
					select	count(1)
					into STRICT	qt_regra_inscricao_w
					from	pls_reajuste_inscricao
					where	nr_seq_lote	= nr_seq_lote_reaj_inscricao_w;
					
					if (qt_regra_inscricao_w = 0) then
						delete	from	pls_lote_reaj_inscricao
						where	nr_sequencia	= nr_seq_lote_reaj_inscricao_w;
					end if;
				end if;
			end if;
			end;
		end loop;
	end loop;
end if;

ie_aplicar_definitivo_w	:= 'N';

select	count(1)
into STRICT	qt_registros_w
from	pls_reajuste_tabela
where	nr_seq_reajuste	= nr_seq_reajuste_p  LIMIT 1;

if (qt_registros_w = 0) then
	select	count(1)
	into STRICT	qt_registros_w
	from	pls_lote_reaj_copartic
	where	nr_seq_reajuste	= nr_seq_reajuste_p  LIMIT 1;
	
	if (qt_registros_w = 0) then
		select	count(1)
		into STRICT	qt_registros_w
		from	pls_lote_reaj_inscricao
		where	nr_seq_reajuste	= nr_seq_reajuste_p  LIMIT 1;
	end if;
	
	if (qt_registros_w > 0) then
		ie_aplicar_definitivo_w	:= 'S';
	end if;
	
	if (ie_aplicar_definitivo_w = 'S') then
		CALL pls_aplicar_reajuste(nr_seq_reajuste_p,'N',null,'N',nm_usuario_p,cd_estabelecimento_p);
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_tabela_reajuste ( nr_seq_reajuste_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

