-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_conta_financ_nf ( cd_estabelecimento_p bigint, nr_sequencia_p bigint, cd_grupo_desconsidera_p bigint, cd_subgrupo_desconsidera_p bigint, cd_classe_desconsidera_p bigint, cd_material_desconsidera_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_erro_w			varchar(500);
nr_seq_conta_financ_ww		bigint;
nr_seq_conta_financ_w		bigint;
cd_cgc_w			varchar(14);
ie_entrada_saida_param_w		varchar(1);
ie_entrada_saida_w			varchar(1);

c01 CURSOR FOR
SELECT	coalesce(c.ie_operacao_fiscal,'E') ie_operacao_fiscal,
	c.cd_operacao_nf,
	b.cd_cgc,
	b.cd_cgc_emitente,
	b.cd_pessoa_fisica,
	a.nr_nota_fiscal,
	a.nr_item_nf,
	a.cd_material,
	a.cd_procedimento,
	a.ie_origem_proced,
	a.nr_seq_proj_rec,
	a.cd_local_estoque,
	a.cd_centro_custo,
	a.nr_seq_conta_financ
from	nota_fiscal_item a,
	nota_fiscal b,
	operacao_nota c,
	estrutura_material_v e
where	a.cd_material = e.cd_material
and	a.nr_sequencia = b.nr_sequencia
and	b.cd_operacao_nf = c.cd_operacao_nf
and	((cd_grupo_desconsidera_p = 0) or
	(cd_grupo_desconsidera_p > 0 AND e.cd_grupo_material <> cd_grupo_desconsidera_p))
and	((cd_subgrupo_desconsidera_p = 0) or
	(cd_subgrupo_desconsidera_p > 0 AND e.cd_subgrupo_material <> cd_subgrupo_desconsidera_p))	
and	((cd_classe_desconsidera_p = 0) or
	(cd_classe_desconsidera_p > 0 AND e.cd_classe_material <> cd_classe_desconsidera_p))
and	((cd_material_desconsidera_p = 0) or
	(cd_material_desconsidera_p > 0 AND e.cd_material <> cd_material_desconsidera_p))
and	a.nr_sequencia	= nr_sequencia_p

union

SELECT	coalesce(c.ie_operacao_fiscal,'E'),
	c.cd_operacao_nf,
	b.cd_cgc,
	b.cd_cgc_emitente,
	b.cd_pessoa_fisica,
	a.nr_nota_fiscal,	
	a.nr_item_nf,
	a.cd_material,
	a.cd_procedimento,
	a.ie_origem_proced,
	a.nr_seq_proj_rec,
	a.cd_local_estoque,
	a.cd_centro_custo,
	a.nr_seq_conta_financ
from	nota_fiscal_item a,
	nota_fiscal b,
	operacao_nota c
where	a.nr_sequencia = b.nr_sequencia
and	b.cd_operacao_nf = c.cd_operacao_nf
and	a.nr_sequencia	= nr_sequencia_p
and	(a.cd_procedimento IS NOT NULL AND a.cd_procedimento::text <> '')
and	coalesce(a.cd_material::text, '') = '';

Vet01	C01%RowType;


BEGIN

open C01;
loop
fetch C01 into
	Vet01;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	nr_seq_conta_financ_ww			:= Vet01.nr_seq_conta_financ;
	nr_seq_conta_financ_w			:= '';
	ie_entrada_saida_param_w		:= 'S';
	ie_entrada_saida_w			:= Vet01.ie_operacao_fiscal;
	cd_cgc_w				:= Vet01.cd_cgc_emitente;

	if (ie_entrada_saida_w = 'S') then
		ie_entrada_saida_param_w	:= 'E';
		cd_cgc_w			:= coalesce(Vet01.cd_cgc, Vet01.cd_cgc_emitente);
	end if;
	
	begin
	nr_seq_conta_financ_w := Obter_Conta_Financeira(	ie_entrada_saida_param_w, cd_estabelecimento_p, Vet01.cd_material, Vet01.cd_procedimento, Vet01.ie_origem_proced, null, null, cd_cgc_w, Vet01.cd_centro_custo, nr_seq_conta_financ_w, null, Vet01.cd_operacao_nf, null, null, null, Vet01.nr_seq_proj_rec, null, Vet01.cd_pessoa_fisica, '', '', null, null, Vet01.cd_local_estoque, '', '', '', null, null, null);
	exception when others then
		ds_erro_w	:= SQLERRM(SQLSTATE);
		CALL wheb_mensagem_pck.exibir_mensagem_abort(190964,	'NR_NOTA_W=' || Vet01.nr_nota_fiscal || ';' ||
								'DS_ERRO_W=' || ds_erro_w);
			
	end;		
	if (coalesce(nr_seq_conta_financ_ww,0) <> coalesce(nr_seq_conta_financ_w,0) and coalesce(nr_seq_conta_financ_w,0) > 0) then
		update	nota_fiscal_item
		set	nr_seq_conta_financ	= nr_seq_conta_financ_w,
			nm_usuario		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp()
		where	nr_sequencia		= nr_sequencia_p
		and	nr_item_nf		= Vet01.nr_item_nf;

		CALL gerar_historico_nota_fiscal(	nr_sequencia_p,
						nm_usuario_p,
						'43',
						wheb_mensagem_pck.get_texto(303568,	'NR_SEQ_CONTA_FINANC=' || nr_seq_conta_financ_w || ';' ||
											'NM_USU_AJU=' || nm_usuario_p));
	end if;
	end;
end loop;
close C01;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_conta_financ_nf ( cd_estabelecimento_p bigint, nr_sequencia_p bigint, cd_grupo_desconsidera_p bigint, cd_subgrupo_desconsidera_p bigint, cd_classe_desconsidera_p bigint, cd_material_desconsidera_p bigint, nm_usuario_p text) FROM PUBLIC;

