-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vincular_protocolo ( nr_seq_protocolo_p bigint, nr_titulo_p bigint, ie_atualiza_dt_cr_prot_p text) AS $body$
DECLARE

nr_titulo_w		bigint;
nr_seq_protocolo_w 	bigint;

BEGIN
if (nr_titulo_p IS NOT NULL AND nr_titulo_p::text <> '') and (nr_seq_protocolo_p IS NOT NULL AND nr_seq_protocolo_p::text <> '')then 
	begin 
	select 	max(a.nr_titulo) 
	into STRICT	nr_titulo_w 
	from  	titulo_receber a 
	where  	a.nr_seq_protocolo = nr_seq_protocolo_p;	
	if (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then 
		begin 
		/*O protocolo #@NR_SEQ_PROTOCOLO_P#@ já está vinculada ao título #@NR_TITULO_W#@.*/
 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(264960, 
						'NR_SEQ_PROTOCOLO_P='||nr_seq_protocolo_p||';'|| 
						'NR_TITULO_W='||nr_titulo_w);
		end;
	end if;
	select 	max(a.nr_seq_protocolo) 
	into STRICT	nr_seq_protocolo_w 
	from  	protocolo_convenio a 
	where  	a.nr_seq_protocolo = nr_seq_protocolo_p 
	and 		a.ie_status_protocolo = 2;
	if (coalesce(nr_seq_protocolo_w::text, '') = '') then 
		begin 
		/* O protocolo #@NR_SEQ_PROTOCOLO_P#@ não foi localizado no sistema ou não está com o status em definitivo!*/
 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(264959, 
						'NR_SEQ_PROTOCOLO_P='||nr_seq_protocolo_p);
		end;
	end if;		
	update 	titulo_receber 
	set   	nr_seq_protocolo = nr_seq_protocolo_p, 
		nr_documento   = nr_seq_protocolo_p 
    	where  	nr_titulo = nr_titulo_p;	
	commit;
	end;
	-- parâmetro 189 
	if (ie_atualiza_dt_cr_prot_p = 'S') then 
		update	protocolo_convenio           
		set   dt_integracao_cr = clock_timestamp() 
		where  nr_seq_protocolo = nr_seq_protocolo_p;
	end if;
	 
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vincular_protocolo ( nr_seq_protocolo_p bigint, nr_titulo_p bigint, ie_atualiza_dt_cr_prot_p text) FROM PUBLIC;

