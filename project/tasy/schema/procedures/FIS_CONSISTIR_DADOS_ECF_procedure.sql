-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_consistir_dados_ecf ( cd_empresa_p bigint, cd_estabelecimento_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text) AS $body$
DECLARE




/*variaveis gerais */

cd_empresa_w				empresa.cd_empresa%type;
cd_estabelecimento_w			estabelecimento.cd_estabelecimento%type;
cd_consistencia_w			w_ctb_sped_consistencia.cd_consistencia%type;
ds_consistencia_w			w_ctb_sped_consistencia.ds_consistencia%type;
i					integer	:= 0;

type registros is table of w_ctb_sped_consistencia%rowtype index by integer;
consistencia_w				registros;


/*variáveis que obtem os dados para consistência */

dt_inicio_apuracao_w			 fis_controle_ecf.dt_inicio_apuracao%type;
dt_fim_apuracao_w			 fis_controle_ecf.dt_fim_apuracao%type;
qt_registro_w				 bigint;
pr_mov_sem_agrup_w			 double precision;
cd_cgc_w                                 pessoa_juridica.cd_cgc%type;
ds_endereco_w                            pessoa_juridica.ds_endereco%type;
nr_endereco_w                            pessoa_juridica.nr_endereco%type;
ds_bairro_w                              pessoa_juridica.ds_bairro%type;
sg_estado_w                              pessoa_juridica.sg_estado%type;
cd_municipio_ibge_w                      pessoa_juridica.cd_municipio_ibge%type;
cd_cep_w                                 pessoa_juridica.cd_cep%type;
nr_seq_cnae_w                            pessoa_juridica.nr_seq_cnae%type;
ds_email_w                               pessoa_juridica_estab.ds_email%type;
dt_alt_w                                 timestamp;
cd_nat_juridica_w                        pessoa_juridica.nr_seq_nat_juridica%type;
cd_conta_contabil_w                      conta_contabil.cd_conta_contabil%type;
qtd_w                                    bigint;
mes_ref_final_w				 timestamp;
dt_ref_inicial_w                         timestamp;
dt_ref_final_w                           timestamp;
cd_encerramento_exercicio_w		 bigint;
qt_mes_aberto_w                          bigint;
qt_lote_encerramento_w		         bigint;





BEGIN

delete	FROM w_ctb_sped_consistencia
where	coalesce(nr_seq_controle_sped::text, '') = ''
and	nm_usuario = nm_usuario_p;
commit;

cd_empresa_w		:= cd_empresa_p;
cd_estabelecimento_w	:= cd_estabelecimento_p;
dt_ref_inicial_w	:= dt_inicial_p;
dt_ref_final_w		:= dt_final_p;
mes_ref_final_w 	:= TRUNC(dt_ref_inicial_w, 'MM');

select cd_cgc
into STRICT   cd_cgc_w
from   estabelecimento
where  cd_estabelecimento = cd_estabelecimento_p;

select count(*)
into STRICT   qtd_w
from   conta_contabil a
where  a.ie_tipo = 'A'
and (coalesce(a.dt_fim_vigencia::text, '') = '' or a.dt_fim_vigencia between dt_inicial_p and dt_final_p)
and (a.cd_conta_contabil in (SELECT b.cd_conta_contabil
			       from   conta_contabil_classif_ecd b
			       where  cd_versao <> '3.1')
			       or not exists (select 1
			       from   conta_contabil_classif_ecd x
			       where  x.cd_conta_contabil = a.cd_conta_contabil));


select  ds_endereco,
	nr_endereco,
	ds_bairro,
	sg_estado,
	cd_municipio_ibge,
	cd_cep,
	nr_seq_cnae,
	nr_seq_nat_juridica
into STRICT	ds_endereco_w,
        nr_endereco_w,
	ds_bairro_w,
	sg_estado_w,
	cd_municipio_ibge_w,
	cd_cep_w,
	nr_seq_cnae_w,
	cd_nat_juridica_w
from  	pessoa_juridica a
where 	a.cd_cgc = cd_cgc_w;


select a.ds_email
into STRICT   ds_email_w
from   pessoa_juridica_estab a,
       pessoa_juridica b
where  a.cd_cgc = b.cd_cgc
and    b.cd_cgc = cd_cgc_w;

select	count(*)
into STRICT	qt_mes_aberto_w
from	ctb_mes_ref
where	dt_referencia between dt_inicial_p and dt_final_p
and	coalesce(dt_fechamento::text, '') = '';



if (coalesce(ds_endereco_w,'X') = 'X') then

   i				     := i + 1;
   consistencia_w[i].cd_consistencia := 1;
   consistencia_w[i].ds_consistencia := 'Falta informar o endereço do estabelecimento.';
   consistencia_w[i].ds_acao         := 'Cadastrar o endereço na função Pessoa Júridica.';
   consistencia_w[i].qt_tempo	     := 1;

end if;

if (coalesce(nr_endereco_w,'X') = 'X') then

    i				      := i + 1;
    consistencia_w[i].cd_consistencia := 2;
    consistencia_w[i].ds_consistencia := 'Falta informar o número do endereço do estabelecimento.';
    consistencia_w[i].ds_acao         := 'Cadastrar o número do endereço na função Pessoa Júridica.';
    consistencia_w[i].qt_tempo	      := 1;



end if;

if (coalesce(ds_bairro_w,'X') = 'X') then
    i				      := i + 1;
    consistencia_w[i].cd_consistencia := 3;
    consistencia_w[i].ds_consistencia := 'Falta informar o bairro da empresa.';
    consistencia_w[i].ds_acao         := 'Cadastrar o bairro da empresa na função Pessoa Jurídica.';
    consistencia_w[i].qt_tempo	      := 1;



end if;

if (coalesce(sg_estado_w,'X') = 'X') then

   i				     := i + 1;
   consistencia_w[i].cd_consistencia := 4;
   consistencia_w[i].ds_consistencia := 'Falta informar a unidade da federação do estabelecimento.';
   consistencia_w[i].ds_acao         := 'Cadastrar o estado da federação na função Pessoa Júridica.';
   consistencia_w[i].qt_tempo	     := 1;



end if;

if (coalesce(cd_municipio_ibge_w,'X') = 'X') then

    i				      := i + 1;
    consistencia_w[i].cd_consistencia := 5;
    consistencia_w[i].ds_consistencia := 'Falta informar o município do estabelecimento.';
    consistencia_w[i].ds_acao         := 'Cadastrar o município na função Pessoa Júridica.';
    consistencia_w[i].qt_tempo	      := 1;


end if;

if (coalesce(cd_cep_w,'X') = 'X') then

   i				      := i + 1;
   consistencia_w[i].cd_consistencia  := 6;
   consistencia_w[i].ds_consistencia  := 'Falta informar o CEP do estabelecimento.';
   consistencia_w[i].ds_acao          := 'Cadastrar o CEP na função Pessoa Júridica.';
   consistencia_w[i].qt_tempo	      := 1;


end if;

if (coalesce(nr_seq_cnae_w,0) = 0) then

   i				      := i + 1;
   consistencia_w[i].cd_consistencia  := 7;
   consistencia_w[i].ds_consistencia  := 'Falta informar o CNAE (Código da atividade econômica) da empresa.';
   consistencia_w[i].ds_acao          := 'Cadastrar o código CNAE da empresa na função Pessoa Jurídica.';
   consistencia_w[i].qt_tempo	      := 5;


end if;


if (coalesce(ds_email_w,'X') = 'X') then

  i	                             := i + 1;
  consistencia_w[i].cd_consistencia  := 8;
  consistencia_w[i].ds_consistencia  := 'Falta o informar o Email da empresa.';
  consistencia_w[i].ds_acao          := 'Cadastrar o email da empresa na função Pessoa Jurídica.';
  consistencia_w[i].qt_tempo	     := 5;

 else
     if not(ds_email_w like '%@%') then

     i	                                := i + 1;
     consistencia_w[i].cd_consistencia  := 8;
     consistencia_w[i].ds_consistencia  := 'O email cadastrado é inválido.';
     consistencia_w[i].ds_acao          := 'Informar um email válido para a empresa na função Pessoa Jurídica.';
     consistencia_w[i].qt_tempo	        := 5;

     end if;

end if;

if (qtd_w  > 0) then

    i	                                   := i + 1;
    consistencia_w[i].cd_consistencia      := 9;
    consistencia_w[i].ds_consistencia      := 'Existem'||' '||qtd_w||' '|| 'contas contábeis analíticas vigentes sem conta contábil referencial 3.1 vinculada';
    consistencia_w[i].ds_acao              := 'Vincular uma conta contábil referencial para as contas na função Empresa/Estabelecimento/Contas/CC, pasta Conta referencial.';
    consistencia_w[i].qt_tempo	           := qtd_w * 1;

end if;

cd_encerramento_exercicio_w := coalesce(obter_valor_param_usuario(923, 6, obter_perfil_ativo,  nm_usuario_p, cd_estabelecimento_w),13);

select count(*)
into STRICT	qt_lote_encerramento_w
from	lote_contabil a,
	estabelecimento b
where	b.cd_estabelecimento		= a.cd_estabelecimento
and	b.cd_empresa			= cd_empresa_w
and	a.cd_estabelecimento		= coalesce(cd_estabelecimento_w, a.cd_estabelecimento)
and	trunc(dt_referencia, 'MM')	= trunc(mes_ref_final_w,'mm')
and	a.cd_tipo_lote_contabil		= cd_encerramento_exercicio_w;

if (qt_lote_encerramento_w = 0)then
	i					:= i + 1;
	consistencia_w[i].cd_consistencia	:= 10;
	consistencia_w[i].ds_consistencia	:= 'Não existe lote de encerramento de exercício.';
	consistencia_w[i].ds_acao		:= 'Na função Contabilidade, no mês de encerramento deve ser executada a funcionalidade Encerramento Exercício.';
	consistencia_w[i].qt_tempo		:= 10;
end if;

if (qt_mes_aberto_w > 0)then
	i					:= i + 1;
	consistencia_w[i].cd_consistencia	:= 11;
	consistencia_w[i].ds_consistencia	:= 'Quantidade de meses abertos na Contabilidade: ' || trim(both TO_CHAR(qt_mes_aberto_w, '999G9999G999'));
	consistencia_w[i].ds_acao		:= 'Fechar o mês na função Contabilidade.';
	consistencia_w[i].qt_tempo		:= 10;
end if;



for i in 1.. consistencia_w.count  loop

insert into w_ctb_sped_consistencia(
	nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	cd_consistencia,
	ds_consistencia,
	nr_seq_controle_sped,
	ie_tipo,
	ds_acao,
	qt_tempo)
values (	nextval('w_ctb_sped_consistencia_seq'),
	clock_timestamp(),
	nm_usuario_p,
	consistencia_w[i].cd_consistencia,
	consistencia_w[i].ds_consistencia,
	null,
	consistencia_w[i].ie_tipo,
	consistencia_w[i].ds_acao,
	consistencia_w[i].qt_tempo);
end loop;

commit;



end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_consistir_dados_ecf ( cd_empresa_p bigint, cd_estabelecimento_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text) FROM PUBLIC;

