-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_valores_tarja_mag ( ds_tarja_magnetica_p text, nm_beneficiario_p INOUT text, cd_usuario_plano_p INOUT text, nr_via_p INOUT text, dt_validade_p INOUT text, cd_operadora_p INOUT text, dt_validade_format_p INOUT timestamp, dt_nascimento_p INOUT timestamp, nm_produto_p INOUT text, nr_seq_produto_p INOUT bigint, ds_abrangencia_p INOUT text, ie_abrangencia_p INOUT text, ie_tipo_contratacao_p INOUT text, cd_plano_tarja_mag_p INOUT text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


ds_tarja_magnetica_w		varchar(255);
qt_fim_trilha_w			integer	:= 0;
cd_produto_w			varchar(3);
qt_caracteres_total_w		bigint;
qt_caracteres_carteira_w	bigint;
ds_primeiro_caractere_w		varchar(1);
ie_restringe_estab_w		varchar(1);
qt_existente_w			bigint;
qt_existe_base_w		bigint; -- Essa variavel ir verificar se o carto do beneficirio existe na base, caso no exista, ir deixar o sistema retornar os valores dentro da tarj mantica do carto
ie_abrangencia_w		varchar(1);
dt_validade_format_w		timestamp;
ie_tipo_contratacao_w		varchar(10);
cd_cartao_user_w		varchar(255);
ds_caracter_aux_w		varchar(255);
cd_campo_w			bigint;
qt_posicao_codigo_cart_w	bigint;
cd_cgc_outorgante_w		varchar(14);
nr_via_aux_w			varchar(10);
nm_beneficiario_w		varchar(255);
ds_caracter_porcentagem_w	varchar(10);
ds_trilha1_w			varchar(255);
ds_trilha2_w			varchar(255);
ie_produto_tarja_w		pls_parametros.ie_produto_tarja%type;
cd_base_cgc_w			empresa.cd_base_cgc%type;
ds_data_w			varchar(255);
nr_pos_final_tarja1_w		bigint;


BEGIN

select	max(cd_cgc_outorgante)
into STRICT	cd_cgc_outorgante_w
from	pls_outorgante
where	cd_estabelecimento	= cd_estabelecimento_p;

begin
select	max(cd_base_cgc)
into STRICT	cd_base_cgc_w
from	empresa
where	cd_empresa = (	SELECT	max(cd_empresa)
						from	estabelecimento
						where	cd_estabelecimento	= cd_estabelecimento_p);
exception
when others then
	cd_base_cgc_w := null;
end;

ie_restringe_estab_w	:= coalesce(obter_valor_param_usuario(1273, 8, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p),'N');

if (cd_cgc_outorgante_w	= '11939445000158') then --Beneficência Portuguesa
	ds_tarja_magnetica_w		:= ds_tarja_magnetica_p;
	ds_caracter_porcentagem_w	:= substr(ds_tarja_magnetica_w,1,2);
	qt_caracteres_total_w		:= length(ds_tarja_magnetica_w);

	/*Caso a tarja venha com 2 %%, então retira 1*/

	if (ds_caracter_porcentagem_w	= '%%') then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,2,qt_caracteres_total_w);
	end if;

	qt_caracteres_carteira_w	:= position('=' in ds_tarja_magnetica_w) - 1;

	/*Monta o cartão do beneficiário començando da direira para a esquerda até encontrar um caracter não-numero*/

	IF (qt_caracteres_carteira_w	> 0) THEN
		FOR i IN REVERSE qt_caracteres_carteira_w..1 LOOP
			ds_caracter_aux_w	:= substr(ds_tarja_magnetica_w,i,1);
			begin
				cd_campo_w	:= (ds_caracter_aux_w)::numeric;
			exception
			when others then
				exit;
			end;

			cd_cartao_user_w	:= ds_caracter_aux_w||cd_cartao_user_w;
		END LOOP;

		qt_posicao_codigo_cart_w	:= position(cd_cartao_user_w in ds_tarja_magnetica_w);

		nr_via_aux_w			:= substr(ds_tarja_magnetica_w,qt_caracteres_carteira_w+2,2);
		nr_via_aux_w			:= Somente_Numero(nr_via_aux_w);

		cd_usuario_plano_p	:= (cd_cartao_user_w)::numeric;
		nm_beneficiario_w	:= upper(substr(ds_tarja_magnetica_w,2,qt_posicao_codigo_cart_w-4));
		nm_beneficiario_p	:= replace(replace(nm_beneficiario_w,'%',''),':','');
		nr_via_p		:= nr_via_aux_w;
		dt_validade_p		:= '';
		cd_operadora_p		:= '';
		dt_validade_format_p	:= NULL;
		cd_produto_w		:= '';
		ie_abrangencia_w	:= '';
		ie_tipo_contratacao_w	:= '';
	end if;
elsif (cd_cgc_outorgante_w = '03637776000105') then -- Filosanitas Saúde LTDA
	ds_tarja_magnetica_w	:= ds_tarja_magnetica_p;
	cd_usuario_plano_p	:= upper(substr(ds_tarja_magnetica_w,2,14));
	nr_via_p		:= '0';
	dt_validade_p		:= '';
	cd_produto_w		:= '';
	cd_operadora_p		:= '';
	dt_validade_format_p	:= '';
	ie_abrangencia_w	:= '';
	ie_tipo_contratacao_w	:= '';

	begin
	select	substr(tws_get_name_person(b.cd_pessoa_fisica, b.cd_estabelecimento),1,100)
	into STRICT	nm_beneficiario_p
	from	pls_segurado_carteira	a,
		pls_segurado		b
	where	a.nr_seq_segurado	= b.nr_sequencia
	and	a.cd_usuario_plano	= cd_usuario_plano_p;
	exception
	when others then
		nm_beneficiario_p	:= '';
	end;
elsif (cd_cgc_outorgante_w = '82624776000147') or -- Unimed Blumenau
	(cd_cgc_outorgante_w = '76767219000182') then --Unimed Maringá
	select	CASE WHEN substr(ds_tarja_magnetica_p,length(ds_tarja_magnetica_p),1)=chr(10) THEN  substr(ds_tarja_magnetica_p,1,length(ds_tarja_magnetica_p)-1)  ELSE ds_tarja_magnetica_p END
	into STRICT	ds_tarja_magnetica_w
	;

	select	somente_letra_espaco_trim(substr(ds_tarja_magnetica_w,2,position(chr(10) in ds_tarja_magnetica_w))) trilha1,
		somente_numero_char(substr(ds_tarja_magnetica_w,position(chr(10) in ds_tarja_magnetica_w),length(ds_tarja_magnetica_w))) trilha2
	into STRICT	ds_trilha1_w,
		ds_trilha2_w
	;

	cd_usuario_plano_p	:= substr(ds_trilha2_w,1,17);
	nr_via_p		:= substr(ds_trilha2_w,18,2);
	begin
	dt_validade_p		:= substr(ds_trilha2_w,22,2) || '/' || substr(ds_trilha2_w,20,2);
	dt_validade_format_p	:= '01/' || substr(ds_trilha2_w,22,2) || '/20' || substr(ds_trilha2_w,20,2);
	exception
	when others then
		dt_validade_p		:= null;
		dt_validade_format_p	:= null;
	end;
	cd_operadora_p		:= substr(ds_trilha2_w,2,3);
	cd_produto_w		:= substr(ds_trilha2_w,28,3);
	ie_abrangencia_w	:= substr(ds_trilha2_w,31,1);
	ie_tipo_contratacao_w	:= substr(ds_trilha2_w,32,1);

	begin
	select	substr(tws_get_name_person(b.cd_pessoa_fisica, b.cd_estabelecimento),1,100)
	into STRICT	nm_beneficiario_p
	from	pls_segurado_carteira	a,
		pls_segurado		b
	where	a.nr_seq_segurado	= b.nr_sequencia
	and	a.cd_usuario_plano	= cd_usuario_plano_p;
	exception
	when others then
		nm_beneficiario_p	:= ds_trilha1_w;
	end;

	begin
	select	max(nr_sequencia),
		nm_fantasia
	into STRICT	nr_seq_produto_p,
		nm_produto_p
	from	pls_plano
	where	cd_tarja_magnetica 		= cd_produto_w
	and	coalesce(ie_tipo_operacao, 'T') 	= 'T'
	and	cd_estabelecimento		= cd_estabelecimento_p
	group by nm_fantasia;
	exception
	when others then
		nm_produto_p	:= '';
	end;

	if (ie_abrangencia_w IS NOT NULL AND ie_abrangencia_w::text <> '') then
		if (ie_abrangencia_w = '1') then
			ds_abrangencia_p	:= 'Nac.';
			ie_abrangencia_p	:= ie_abrangencia_w;
		elsif (ie_abrangencia_w = '2') then
			ds_abrangencia_p	:= 'Reg.A';
			ie_abrangencia_p	:= ie_abrangencia_w;
		elsif (ie_abrangencia_w = '3') then
			ds_abrangencia_p	:= 'Est.';
			ie_abrangencia_p	:= ie_abrangencia_w;
		elsif (ie_abrangencia_w = '4') then
			ds_abrangencia_p	:= 'Reg. B';
			ie_abrangencia_p	:= ie_abrangencia_w;
		elsif (ie_abrangencia_w = '5') then
			ds_abrangencia_p	:= 'Mun.';
			ie_abrangencia_p	:= ie_abrangencia_w;
		end if;
	else
		ie_abrangencia_p	:= '';
		ds_abrangencia_p	:= '';
	end if;

	if (ie_tipo_contratacao_w IS NOT NULL AND ie_tipo_contratacao_w::text <> '') then
		if (ie_tipo_contratacao_w in ('2','5')) then
			ie_tipo_contratacao_p	:= 'I';
		elsif (ie_tipo_contratacao_w = '3') then
			ie_tipo_contratacao_p	:= 'CE';
		elsif (ie_tipo_contratacao_w = '4') then
			ie_tipo_contratacao_p	:= 'CA';
		end if;
	else
		ie_tipo_contratacao_p	:= '';
	end if;

	if (cd_produto_w IS NOT NULL AND cd_produto_w::text <> '') then
		cd_plano_tarja_mag_p	:= cd_produto_w;
	end if;
elsif (cd_cgc_outorgante_w	= '45359213000142') then --Unimed São Carlos
	ds_tarja_magnetica_w		:= ds_tarja_magnetica_p;
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,chr(13),'');
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,chr(10),'');

	if (position('?' in ds_tarja_magnetica_w) > 0) then
		qt_fim_trilha_w		:= position('?' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
	elsif (position(':' in ds_tarja_magnetica_w) > 0) then
		qt_fim_trilha_w		:= position(':' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
	elsif (position('/' in ds_tarja_magnetica_w) > 0) then
		qt_fim_trilha_w		:= position('/' in ds_tarja_magnetica_w);
	end if;

	nm_beneficiario_p	:= pls_somente_letra_espaco(upper(substr(ds_tarja_magnetica_w,2,qt_fim_trilha_w-2)));

	if (position(';' in ds_tarja_magnetica_w) > 0) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,position(';' in ds_tarja_magnetica_w),length(ds_tarja_magnetica_w));
	elsif (position('ç' in ds_tarja_magnetica_w) > 0) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,position('ç' in ds_tarja_magnetica_w),length(ds_tarja_magnetica_w));
	elsif (position('Ç' in ds_tarja_magnetica_w) > 0) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,position('Ç' in ds_tarja_magnetica_w),length(ds_tarja_magnetica_w));
	elsif (position('%' in ds_tarja_magnetica_w) > 0) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,position('%' in ds_tarja_magnetica_w),length(ds_tarja_magnetica_w));
	end if;

	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,';','');
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,'ç','');
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,'Ç','');
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,'%','');
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,'','');

	if (position('?' in ds_tarja_magnetica_w) > 0) then
		qt_fim_trilha_w		:= position('?' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
	elsif (position(':' in ds_tarja_magnetica_w) > 0) then
		qt_fim_trilha_w		:= position(':' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
	end if;

	qt_caracteres_carteira_w	:= position('=' in ds_tarja_magnetica_w) - 1;

	if (qt_caracteres_carteira_w = 16) then
		ds_tarja_magnetica_w	:= '0' || ds_tarja_magnetica_w;
	elsif (qt_caracteres_carteira_w = 15) then
		ds_tarja_magnetica_w	:= '00' || ds_tarja_magnetica_w;
	end if;

	qt_caracteres_carteira_w	:= length(ds_tarja_magnetica_w);

	if (qt_caracteres_carteira_w = 39) then
		cd_usuario_plano_p	:= substr(ds_tarja_magnetica_w,1,17);
		nr_via_p		:= substr(ds_tarja_magnetica_w,19,2);
		cd_operadora_p		:= substr(ds_tarja_magnetica_w,2,3);
	else
		cd_usuario_plano_p	:= substr(ds_tarja_magnetica_w,1,17);
		nr_via_p		:= substr(ds_tarja_magnetica_w,19,2);
		dt_validade_p		:= substr(ds_tarja_magnetica_w,23,2) || '/' || substr(ds_tarja_magnetica_w,21,2);
		cd_operadora_p		:= substr(ds_tarja_magnetica_w,2,3);
		dt_validade_format_p	:= '01/' || substr(ds_tarja_magnetica_w,23,2) || '/20' || substr(ds_tarja_magnetica_w,21,2);
		cd_produto_w		:= substr(ds_tarja_magnetica_w,30,3);
		ie_abrangencia_w	:= substr(ds_tarja_magnetica_w,33,1);
		ie_tipo_contratacao_w	:= substr(ds_tarja_magnetica_w,34,1);
	end if;

	begin
		select	max(nr_sequencia),
			nm_fantasia
		into STRICT	nr_seq_produto_p,
			nm_produto_p
		from	pls_plano
		where	cd_tarja_magnetica 		= cd_produto_w
		and	coalesce(ie_tipo_operacao, 'T') 	= 'T'
		and	cd_estabelecimento		= cd_estabelecimento_p
		group by nm_fantasia;
	exception
	when others then
		nm_produto_p	:= '';
	end;

	if (nm_beneficiario_p ='' or coalesce(nm_beneficiario_p::text, '') = '') then
		begin
		select	substr(tws_get_name_person(b.cd_pessoa_fisica, b.cd_estabelecimento),1,100)
		into STRICT	nm_beneficiario_p
		from	pls_segurado_carteira	a,
			pls_segurado		b
		where	a.nr_seq_segurado	= b.nr_sequencia
		and	a.cd_usuario_plano	= cd_usuario_plano_p;
		exception
		when others then
			nm_beneficiario_p	:= '';
		end;
	end if;

	select	count(1)
	into STRICT	qt_existe_base_w
	from	pls_segurado_carteira
	where	cd_usuario_plano	= cd_usuario_plano_p;

	/* Verificar a carteira do beneficirio de intercmbio */

	if (qt_existe_base_w = 0) then
		select	count(*)
		into STRICT	qt_existe_base_w
		from	pls_segurado_carteira a,
			pls_segurado b
		where	a.nr_seq_segurado	= b.nr_sequencia
		and	a.nr_cartao_intercambio	= cd_usuario_plano_p;

		if (qt_existe_base_w = 0) then
			select	count(*)
			into STRICT	qt_existe_base_w
			from	pls_segurado_cart_ant
			where	cd_usuario_ant = cd_usuario_plano_p;
		end if;
	end if;

	if (ie_restringe_estab_w = 'S') and (qt_existe_base_w	> 0) then
		select	count(*)
		into STRICT	qt_existente_w
		from	pls_segurado_carteira
		where	cd_usuario_plano	= cd_usuario_plano_p
		and	cd_estabelecimento	= cd_estabelecimento_p;

		/* Verificar a carteira do beneficirio de intercmbio */

		if (qt_existente_w = 0) then
			select	count(*)
			into STRICT	qt_existente_w
			from	pls_segurado_carteira a,
				pls_segurado b
			where	a.nr_seq_segurado	= b.nr_sequencia
			and	a.nr_cartao_intercambio	= cd_usuario_plano_p
			and	a.cd_estabelecimento	= cd_estabelecimento_p;
		end if;

		if (qt_existente_w = 0) then
			nm_beneficiario_p	:= '';
			ds_tarja_magnetica_w	:= '';
			nr_via_p		:= '0';
			dt_validade_p		:= '';
			cd_produto_w		:= '';
			nm_produto_p		:= '';
			dt_validade_format_p	:= '';
		end if;
	end if;
	ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,qt_fim_trilha_w+2,length(ds_tarja_magnetica_w));

	if (qt_caracteres_carteira_w > 40) then
		begin
			dt_nascimento_p	:= to_date(substr(somente_numero(ds_tarja_magnetica_w),19,8),'ddmmyyyy');
		exception
		when others then
			dt_nascimento_p	:= null;
		end;
	end if;
	if (ie_abrangencia_w IS NOT NULL AND ie_abrangencia_w::text <> '') then
		if (ie_abrangencia_w = '1') then
			ds_abrangencia_p	:= 'Nac.';
			ie_abrangencia_p	:= ie_abrangencia_w;
		elsif (ie_abrangencia_w = '2') then
			ds_abrangencia_p	:= 'Reg.A';
			ie_abrangencia_p	:= ie_abrangencia_w;
		elsif (ie_abrangencia_w = '3') then
			ds_abrangencia_p	:= 'Est.';
			ie_abrangencia_p	:= ie_abrangencia_w;
		elsif (ie_abrangencia_w = '4') then
			ds_abrangencia_p	:= 'Reg. B';
			ie_abrangencia_p	:= ie_abrangencia_w;
		elsif (ie_abrangencia_w = '5') then
			ds_abrangencia_p	:= 'Mun.';
			ie_abrangencia_p	:= ie_abrangencia_w;
		end if;
	else
		ie_abrangencia_p	:= '';
		ds_abrangencia_p	:= '';
	end if;

	/*aaschlote 03/06/2011 - Obter o tipo de contratao na tarja*/

	if (ie_tipo_contratacao_w IS NOT NULL AND ie_tipo_contratacao_w::text <> '') then
		if (ie_tipo_contratacao_w in ('2','5')) then
			ie_tipo_contratacao_p	:= 'I';
		elsif (ie_tipo_contratacao_w = '3') then
			ie_tipo_contratacao_p	:= 'CE';
		elsif (ie_tipo_contratacao_w = '4') then
			ie_tipo_contratacao_p	:= 'CA';
		end if;
	else
		ie_tipo_contratacao_p	:= '';
	end if;

	if (cd_produto_w IS NOT NULL AND cd_produto_w::text <> '') then
		cd_plano_tarja_mag_p	:= cd_produto_w;
	end if;

--Plano de saúde Ases
elsif (cd_cgc_outorgante_w = '03638220000133') or (cd_base_cgc_w = '29251097') or (cd_base_cgc_w = '30412068') or (cd_base_cgc_w = '39695945') or (cd_base_cgc_w = '03638220') or (cd_base_cgc_w = '04219353') or (cd_base_cgc_w = '07078989') or (cd_base_cgc_w = '02349596') or (cd_base_cgc_w ='05308034') then

	ds_tarja_magnetica_w	:= ds_tarja_magnetica_p;
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,chr(13),'');
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,chr(10),'');

	if (position('?' in ds_tarja_magnetica_w) > 0) then
		qt_fim_trilha_w		:= position('?' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
	elsif (position(':' in ds_tarja_magnetica_w) > 0) then
		qt_fim_trilha_w		:= position(':' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
	elsif (position('/' in ds_tarja_magnetica_w) > 0) then
		qt_fim_trilha_w		:= position('/' in ds_tarja_magnetica_w);
	end if;

	nm_beneficiario_p	:= pls_somente_letra_espaco(upper(substr(ds_tarja_magnetica_w,2,qt_fim_trilha_w-2)));

	if (position(';' in ds_tarja_magnetica_w) > 0) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,position(';' in ds_tarja_magnetica_w),length(ds_tarja_magnetica_w));
	--
	elsif (position('ç' in ds_tarja_magnetica_w) > 0) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,position('ç' in ds_tarja_magnetica_w),length(ds_tarja_magnetica_w));
	elsif (position('Ç' in ds_tarja_magnetica_w) > 0) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,position('Ç' in ds_tarja_magnetica_w),length(ds_tarja_magnetica_w));
	elsif (position('%' in ds_tarja_magnetica_w) > 0) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,position('%' in ds_tarja_magnetica_w),length(ds_tarja_magnetica_w));
	end if;

	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,';','');
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,'ç','');
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,'Ç','');
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,'%','');
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,'','');

	qt_caracteres_carteira_w	:= position('=' in ds_tarja_magnetica_w) - 1;
	nr_pos_final_tarja1_w		:= qt_caracteres_carteira_w;

	ds_data_w	:=	substr(ds_tarja_magnetica_w,qt_caracteres_carteira_w+2,6);

	if (qt_caracteres_carteira_w = 16) then
		ds_tarja_magnetica_w	:= '0' || ds_tarja_magnetica_w;
	elsif (qt_caracteres_carteira_w = 15) then
		ds_tarja_magnetica_w	:= '00' || ds_tarja_magnetica_w;
	end if;

	if (position('?' in ds_tarja_magnetica_w) > 0) then
		qt_fim_trilha_w		:= position('?' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
	elsif (position(':' in ds_tarja_magnetica_w) > 0) then
		qt_fim_trilha_w		:= position(':' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
	end if;
	qt_caracteres_carteira_w	:= length(ds_tarja_magnetica_w);

	if (qt_caracteres_carteira_w = 39) then
		null;
	else
		cd_usuario_plano_p		:= substr(ds_tarja_magnetica_w,1,nr_pos_final_tarja1_w);
		nr_via_p			:= substr(ds_tarja_magnetica_w,14,2);
		cd_operadora_p			:= substr(ds_tarja_magnetica_w,1,3);
		dt_validade_p			:= substr(ds_data_w,5,2) || '/' || substr(ds_data_w,3,2);
		dt_validade_format_p		:= '01/' || substr(ds_data_w,5,2) || '/20' || substr(ds_data_w,3,2);
		cd_produto_w			:= substr(ds_tarja_magnetica_w,24,3);
		ie_abrangencia_w		:= substr(ds_tarja_magnetica_w,27,1);
		ie_tipo_contratacao_w		:= substr(ds_tarja_magnetica_w,28,1);
	end if;

	begin
		select	max(nr_sequencia),
				nm_fantasia
		into STRICT	nr_seq_produto_p,
				nm_produto_p
		from	pls_plano
		where	cd_tarja_magnetica 			= cd_produto_w
		and		coalesce(ie_tipo_operacao, 'T') 	= 'T'
		and		cd_estabelecimento			= cd_estabelecimento_p
		group by nm_fantasia;
	exception
	when others then
		nm_produto_p	:= '';
	end;

	if (nm_beneficiario_p ='' or coalesce(nm_beneficiario_p::text, '') = '') then
		begin
		select	substr(tws_get_name_person(b.cd_pessoa_fisica, b.cd_estabelecimento),1,100)
		into STRICT	nm_beneficiario_p
		from	pls_segurado_carteira	a,
				pls_segurado		b
		where	a.nr_seq_segurado	= b.nr_sequencia
		and		a.cd_usuario_plano	= cd_usuario_plano_p;
		exception
		when others then
			nm_beneficiario_p	:= '';
		end;
	end if;

	select	count(1)
	into STRICT	qt_existe_base_w
	from	pls_segurado_carteira
	where	cd_usuario_plano	= cd_usuario_plano_p;

	/* Verificar a carteira do beneficirio de intercmbio */

	if (qt_existe_base_w = 0) then
		select	count(*)
		into STRICT	qt_existe_base_w
		from	pls_segurado_carteira a,
				pls_segurado b
		where	a.nr_seq_segurado		= b.nr_sequencia
		and		a.nr_cartao_intercambio	= cd_usuario_plano_p;

		if (qt_existe_base_w = 0) then
			select	count(*)
			into STRICT	qt_existe_base_w
			from	pls_segurado_cart_ant
			where	cd_usuario_ant = cd_usuario_plano_p;
		end if;
	end if;

	if (ie_restringe_estab_w = 'S') and (qt_existe_base_w	> 0) then
		select	count(*)
		into STRICT	qt_existente_w
		from	pls_segurado_carteira
		where	cd_usuario_plano	= cd_usuario_plano_p
		and		cd_estabelecimento	= cd_estabelecimento_p;

		/* Verificar a carteira do beneficirio de intercmbio */

		if (qt_existente_w = 0) then
			select	count(*)
			into STRICT	qt_existente_w
			from	pls_segurado_carteira a,
					pls_segurado b
			where	a.nr_seq_segurado		= b.nr_sequencia
			and		a.nr_cartao_intercambio	= cd_usuario_plano_p
			and		a.cd_estabelecimento	= cd_estabelecimento_p;
		end if;

		if (qt_existente_w = 0) then
			nm_beneficiario_p		:= '';
			ds_tarja_magnetica_w	:= '';
			nr_via_p				:= '0';
			dt_validade_p			:= '';
			cd_produto_w			:= '';
			nm_produto_p			:= '';
			dt_validade_format_p	:= '';
		end if;
	end if;
	ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,qt_fim_trilha_w+2,length(ds_tarja_magnetica_w));

	if (qt_caracteres_carteira_w > 40) then
		begin
			dt_nascimento_p	:= to_date(substr(somente_numero(ds_tarja_magnetica_w),19,8),'ddmmyyyy');
		exception
		when others then
			dt_nascimento_p	:= null;
		end;
	end if;
	if (ie_abrangencia_w IS NOT NULL AND ie_abrangencia_w::text <> '') then
		if (ie_abrangencia_w = '1') then
			ds_abrangencia_p	:= 'Nac.';
			ie_abrangencia_p	:= ie_abrangencia_w;
		elsif (ie_abrangencia_w = '2') then
			ds_abrangencia_p	:= 'Reg.A';
			ie_abrangencia_p	:= ie_abrangencia_w;
		elsif (ie_abrangencia_w = '3') then
			ds_abrangencia_p	:= 'Est.';
			ie_abrangencia_p	:= ie_abrangencia_w;
		elsif (ie_abrangencia_w = '4') then
			ds_abrangencia_p	:= 'Reg. B';
			ie_abrangencia_p	:= ie_abrangencia_w;
		elsif (ie_abrangencia_w = '5') then
			ds_abrangencia_p	:= 'Mun.';
			ie_abrangencia_p	:= ie_abrangencia_w;
		end if;
	else
		ie_abrangencia_p	:= '';
		ds_abrangencia_p	:= '';
	end if;

	/*aaschlote 03/06/2011 - Obter o tipo de contratao na tarja*/

	if (ie_tipo_contratacao_w IS NOT NULL AND ie_tipo_contratacao_w::text <> '') then
		if (ie_tipo_contratacao_w in ('2','5')) then
			ie_tipo_contratacao_p	:= 'I';
		elsif (ie_tipo_contratacao_w = '3') then
			ie_tipo_contratacao_p	:= 'CE';
		elsif (ie_tipo_contratacao_w = '4') then
			ie_tipo_contratacao_p	:= 'CA';
		end if;
	else
		ie_tipo_contratacao_p	:= '';
	end if;

	if (cd_produto_w IS NOT NULL AND cd_produto_w::text <> '') then
		cd_plano_tarja_mag_p	:= cd_produto_w;
	end if;
else
	ds_tarja_magnetica_w    	:=    	ds_tarja_magnetica_p;
	ds_tarja_magnetica_w  		:=    	replace(ds_tarja_magnetica_w,'(','%');
	ds_tarja_magnetica_w    	:=    	replace(ds_tarja_magnetica_w,')',' ');
	ds_tarja_magnetica_w    	:=    	replace(ds_tarja_magnetica_w,'[',':');
	ds_tarja_magnetica_w  		:=  	replace(ds_tarja_magnetica_w,']',':');
	ds_primeiro_caractere_w   	:=  	substr(ds_tarja_magnetica_p,1,1);
	ds_primeiro_caractere_w   	:=     	replace(ds_primeiro_caractere_w,'(','%');
	qt_caracteres_total_w	:= 	length(ds_tarja_magnetica_w);

	if	(ds_primeiro_caractere_w = '%' AND qt_caracteres_total_w = 38) or
		(ds_primeiro_caractere_w = '%' AND qt_caracteres_total_w = 26) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,2,37);
	elsif (ds_primeiro_caractere_w = '%') and (qt_caracteres_total_w = 27) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,2,25);
	elsif	(ds_primeiro_caractere_w = '%' AND qt_caracteres_total_w = 28) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,3,25);
	/*Quando houver 40 caractres  da verso nova com o cdigo cooperativista*/

	elsif	(ds_primeiro_caractere_w = '%' AND qt_caracteres_total_w = 40) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,3,37);
	/*Quando houver 39 caractres  da verso antiga sem o cdigo cooperativista*/

	elsif	(((ds_primeiro_caractere_w = '%') or (ds_primeiro_caractere_w = ';')) and (qt_caracteres_total_w = 39)) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,2,37);
	elsif	(((ds_primeiro_caractere_w = 'ç') or (ds_primeiro_caractere_w = ';')) and (qt_caracteres_total_w = 39)) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,2,37);
	end if;

	qt_caracteres_total_w	:= length(ds_tarja_magnetica_w);



	if (qt_caracteres_total_w = 22) then
		ds_tarja_magnetica_w	:= lpad(substr(ds_tarja_magnetica_w,2,20),21,'0');
		cd_usuario_plano_p	:= lpad(substr(ds_tarja_magnetica_w,2,20),21,'0');
	end if;

	/*Leitura do carto quando houver 1 trilha e s informao do carto*/

	if (qt_caracteres_total_w = 25) then
		ds_tarja_magnetica_w	:= lpad(substr(ds_tarja_magnetica_w,2,25),25,'0');
		cd_usuario_plano_p	:= lpad(substr(ds_tarja_magnetica_w,1,17),17,'0');
		nr_via_p		:= substr(ds_tarja_magnetica_w,19,2);
		dt_validade_p		:= substr(ds_tarja_magnetica_w,22,2) || '/' || substr(ds_tarja_magnetica_w,24,2);
		dt_validade_format_p	:= '01/' || substr(ds_tarja_magnetica_w,22,2) || '/20' || substr(ds_tarja_magnetica_w,24,2);
		cd_operadora_p		:= substr(ds_tarja_magnetica_w,2,3);

		begin
		select	substr(tws_get_name_person(b.cd_pessoa_fisica, b.cd_estabelecimento),1,100)
		into STRICT	nm_beneficiario_p
		from	pls_segurado_carteira	a,
			pls_segurado		b
		where	a.nr_seq_segurado	= b.nr_sequencia
		and	a.cd_usuario_plano	= cd_usuario_plano_p;
		exception
		when others then
			nm_beneficiario_p	:= '';
		end;

		select	count(*)
		into STRICT	qt_existe_base_w
		from	pls_segurado_carteira
		where	cd_usuario_plano	= cd_usuario_plano_p;

		/* Verificar a carteira do beneficirio de intercmbio */

		if (qt_existe_base_w = 0) then
			select	count(*)
			into STRICT	qt_existe_base_w
			from	pls_segurado_carteira a,
				pls_segurado b
			where	a.nr_seq_segurado	= b.nr_sequencia
			and	a.nr_cartao_intercambio	= cd_usuario_plano_p;

			if (qt_existe_base_w = 0) then
				select	count(*)
				into STRICT	qt_existe_base_w
				from	pls_segurado_cart_ant
				where	cd_usuario_ant = cd_usuario_plano_p;
			end if;
		end if;

		if (ie_restringe_estab_w = 'S') and (qt_existe_base_w > 0) then
			select	count(*)
			into STRICT	qt_existente_w
			from	pls_segurado_carteira
			where	cd_usuario_plano	= cd_usuario_plano_p
			and	cd_estabelecimento	= cd_estabelecimento_p;

			/* Verificar a carteira do beneficirio de intercmbio */

			if (qt_existente_w = 0) then
				select	count(*)
				into STRICT	qt_existente_w
				from	pls_segurado_carteira a,
					pls_segurado b
				where	a.nr_seq_segurado	= b.nr_sequencia
				and	a.nr_cartao_intercambio	= cd_usuario_plano_p
				and	a.cd_estabelecimento	= cd_estabelecimento_p;
			end if;

			if (qt_existente_w = 0) then
				nm_beneficiario_p	:= '';
				ds_tarja_magnetica_w	:= '';
				nr_via_p		:= '0';
				dt_validade_p		:= '';
				cd_produto_w		:= '';
				nm_produto_p		:= '';
				dt_validade_format_p	:= '';
				ie_abrangencia_w	:= '';
				ie_tipo_contratacao_w	:= '';
			end if;
		end if;
	/*Leitura do carto quando houver 1 trilha e com todas as informaes da 2 trilha do carto*/

	elsif (qt_caracteres_total_w = 37) then

		/* Se veio pelo leitor novo, tem que substituir tambem o ponto e virgula */

		if (substr(ds_tarja_magnetica_w,1,1) = '%') then
			ds_tarja_magnetica_w		:= substr(ds_tarja_magnetica_w,2,37);
		end if;

		qt_caracteres_carteira_w	:= position('=' in ds_tarja_magnetica_w) - 1;

		if (qt_caracteres_carteira_w = 16) then
			ds_tarja_magnetica_w      := lpad(ds_tarja_magnetica_w,37,'0');
		end if;

		qt_caracteres_carteira_w	:= position('=' in ds_tarja_magnetica_w) - 1;
		if (qt_caracteres_carteira_w = 17) then
			cd_usuario_plano_p	:= lpad(substr(ds_tarja_magnetica_w,1,17),17,'0');
			nr_via_p		:= substr(ds_tarja_magnetica_w,19,2);
			dt_validade_p		:= substr(ds_tarja_magnetica_w,23,2) || '/' || substr(ds_tarja_magnetica_w,21,2);
			cd_operadora_p		:= substr(ds_tarja_magnetica_w,2,3);
			begin
			dt_validade_format_p	:= '01/' || substr(ds_tarja_magnetica_w,23,2) || '/20' || substr(ds_tarja_magnetica_w,21,2);
			exception
				when others then
				dt_validade_format_p	:= null;
			end;

			cd_produto_w		:= substr(ds_tarja_magnetica_w,30,3);
			ie_abrangencia_w	:= substr(ds_tarja_magnetica_w,33,1);
			ie_tipo_contratacao_w	:= substr(ds_tarja_magnetica_w,34,1);

			begin
			select	substr(tws_get_name_person(b.cd_pessoa_fisica, b.cd_estabelecimento),1,100)
			into STRICT	nm_beneficiario_p
			from	pls_segurado_carteira	a,
				pls_segurado		b
			where	a.nr_seq_segurado	= b.nr_sequencia
			and	a.cd_usuario_plano	= cd_usuario_plano_p;
			exception
			when others then
				nm_beneficiario_p	:= '';
			end;

			begin
			select	max(nr_sequencia),
				nm_fantasia
			into STRICT	nr_seq_produto_p,
				nm_produto_p
			from	pls_plano
			where	cd_tarja_magnetica 		= cd_produto_w
			and	coalesce(ie_tipo_operacao, 'T') 	= 'T'
			and	cd_estabelecimento		= cd_estabelecimento_p
			group by nm_fantasia;

			exception
			when others then
				nm_produto_p	:= '';
			end;
		elsif (qt_caracteres_carteira_w = 16) then
			cd_usuario_plano_p	:= lpad(substr(ds_tarja_magnetica_w,1,16),17,'0');
			nr_via_p		:= substr(ds_tarja_magnetica_w,18,2);
			cd_operadora_p		:= substr(ds_tarja_magnetica_w,1,3);

			begin
			select	substr(tws_get_name_person(b.cd_pessoa_fisica, b.cd_estabelecimento),1,100)
			into STRICT	nm_beneficiario_p
			from	pls_segurado_carteira	a,
				pls_segurado		b
			where	a.nr_seq_segurado	= b.nr_sequencia
			and	a.cd_usuario_plano	= cd_usuario_plano_p;
			exception
			when others then
				nm_beneficiario_p	:= '';
			end;
		end if;

		select	count(*)
		into STRICT	qt_existe_base_w
		from	pls_segurado_carteira
		where	cd_usuario_plano	= cd_usuario_plano_p;

		/* Verificar a carteira do beneficirio de intercmbio */

		if (qt_existe_base_w = 0) then
			select	count(*)
			into STRICT	qt_existe_base_w
			from	pls_segurado_carteira a,
				pls_segurado b
			where	a.nr_seq_segurado	= b.nr_sequencia
			and	a.nr_cartao_intercambio	= cd_usuario_plano_p;

			if (qt_existe_base_w = 0) then
				select	count(*)
				into STRICT	qt_existe_base_w
				from	pls_segurado_cart_ant
				where	cd_usuario_ant = cd_usuario_plano_p;
			end if;
		end if;

		if (ie_restringe_estab_w = 'S') and (qt_existe_base_w > 0) then

			select	count(*)
			into STRICT	qt_existente_w
			from	pls_segurado_carteira
			where	cd_usuario_plano	= cd_usuario_plano_p
			and	cd_estabelecimento	= cd_estabelecimento_p;

			/* Verificar a carteira do beneficirio de intercmbio */

			if (qt_existente_w = 0) then
				select	count(*)
				into STRICT	qt_existente_w
				from	pls_segurado_carteira a,
					pls_segurado b
				where	a.nr_seq_segurado	= b.nr_sequencia
				and	a.nr_cartao_intercambio	= cd_usuario_plano_p
				and	a.cd_estabelecimento	= cd_estabelecimento_p;
			end if;

			if (qt_existente_w = 0) then
				nm_beneficiario_p	:= '';
				ds_tarja_magnetica_w	:= '';
				nr_via_p		:= '0';
				dt_validade_p		:= '';
				cd_produto_w		:= '';
				ie_abrangencia_w	:= '';
				ie_tipo_contratacao_w	:= '';
				nm_produto_p		:= '';
				dt_validade_format_p	:= '';
			end if;
		end if;
	elsif (qt_caracteres_total_w = 64) then
		ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,chr(10),'');
		ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,chr(13),'');

		if (position('?' in ds_tarja_magnetica_w) > 0) then
			qt_fim_trilha_w		:= position('?' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
		elsif (position(':' in ds_tarja_magnetica_w) > 0) then
			qt_fim_trilha_w		:= position(':' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
		elsif (position('/' in ds_tarja_magnetica_w) > 0) then
			qt_fim_trilha_w		:= position('/' in ds_tarja_magnetica_w);
		end if;

		nm_beneficiario_p	:= pls_somente_letra_espaco(upper(substr(ds_tarja_magnetica_w,2,qt_fim_trilha_w-2)));
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,qt_fim_trilha_w+1,length(ds_tarja_magnetica_w));
		if (position('?' in ds_tarja_magnetica_w) > 0) then
			qt_fim_trilha_w		:= position('?' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
		elsif (position(':' in ds_tarja_magnetica_w) > 0) then
			qt_fim_trilha_w		:= position(':' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
		elsif (position('/' in ds_tarja_magnetica_w) > 0) then
			qt_fim_trilha_w		:= position('/' in ds_tarja_magnetica_w);
		end if;

		/*aaschlote 03/08/2012 Limpar enter, tab e ponto e virgula*/

		ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,';','');
		ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,'ç','');
		ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,'Ç','');
		qt_caracteres_carteira_w	:= position('=' in ds_tarja_magnetica_w) - 1;

		if (qt_caracteres_carteira_w = 16) then
			ds_tarja_magnetica_w	:= '0' || ds_tarja_magnetica_w;
			cd_usuario_plano_p	:= substr(ds_tarja_magnetica_w,1,17);
			nr_via_p		:= substr(ds_tarja_magnetica_w,19,2);
			cd_operadora_p		:= substr(ds_tarja_magnetica_w,2,3);
		elsif (qt_caracteres_carteira_w = 17) then
			cd_usuario_plano_p	:= substr(ds_tarja_magnetica_w,1,17);
			nr_via_p		:= substr(ds_tarja_magnetica_w,19,2);
			dt_validade_p		:= substr(ds_tarja_magnetica_w,23,2) || '/' || substr(ds_tarja_magnetica_w,21,2);
			cd_operadora_p		:= substr(ds_tarja_magnetica_w,2,3);
			dt_validade_format_p	:= '01/' || substr(ds_tarja_magnetica_w,23,2) || '/20' || substr(ds_tarja_magnetica_w,21,2);
			cd_produto_w		:= substr(ds_tarja_magnetica_w,30,3);
			ie_abrangencia_w	:= substr(ds_tarja_magnetica_w,33,1);
			ie_tipo_contratacao_w	:= substr(ds_tarja_magnetica_w,34,1);

			begin
			select	max(nr_sequencia),
				nm_fantasia
			into STRICT	nr_seq_produto_p,
				nm_produto_p
			from	pls_plano
			where	cd_tarja_magnetica 		= cd_produto_w
			and	coalesce(ie_tipo_operacao, 'T') 	= 'T'
			and	cd_estabelecimento		= cd_estabelecimento_p
			group by nm_fantasia;
			exception
			when others then
				nm_produto_p	:= '';
			end;
		end if;

		select	count(*)
		into STRICT	qt_existe_base_w
		from	pls_segurado_carteira
		where	cd_usuario_plano	= cd_usuario_plano_p;

		/* Verificar a carteira do beneficirio de intercmbio */

		if (qt_existe_base_w = 0) then
			select	count(*)
			into STRICT	qt_existe_base_w
			from	pls_segurado_carteira a,
				pls_segurado b
			where	a.nr_seq_segurado	= b.nr_sequencia
			and	a.nr_cartao_intercambio	= cd_usuario_plano_p;

			if (qt_existe_base_w = 0) then
				select	count(*)
				into STRICT	qt_existe_base_w
				from	pls_segurado_cart_ant
				where	cd_usuario_ant = cd_usuario_plano_p;
			end if;
		end if;

		if (ie_restringe_estab_w = 'S') and (qt_existe_base_w	> 0)then
			select	count(*)
			into STRICT	qt_existente_w
			from	pls_segurado_carteira
			where	cd_usuario_plano	= cd_usuario_plano_p
			and	cd_estabelecimento	= cd_estabelecimento_p;

			/* Verificar a carteira do beneficirio de intercmbio */

			if (qt_existente_w = 0) then
				select	count(*)
				into STRICT	qt_existente_w
				from	pls_segurado_carteira a,
					pls_segurado b
				where	a.nr_seq_segurado	= b.nr_sequencia
				and	a.nr_cartao_intercambio	= cd_usuario_plano_p
				and	a.cd_estabelecimento	= cd_estabelecimento_p;
			end if;

			if (qt_existente_w = 0) then
				cd_usuario_plano_p	:= '';
				nm_beneficiario_p	:= '';
				ds_tarja_magnetica_w	:= '';
				nr_via_p		:= '0';
				cd_operadora_p		:= '';
				dt_validade_p		:= '';
				cd_produto_w		:= '';
				ie_abrangencia_w	:= '';
				ie_tipo_contratacao_w	:= '';
				nm_produto_p		:= '';
				dt_validade_format_p	:= '';
			end if;
		end if;
	/*Leitura do carto quando houver 3 trilha e com todas as informaes da 2 trilha do carto*/

	elsif (qt_caracteres_total_w = 66) or (qt_caracteres_total_w = 71) or (qt_caracteres_total_w > 50) then

		ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,chr(13),'');
		ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,chr(10),'');

		if (position('?' in ds_tarja_magnetica_w) > 0) then
			qt_fim_trilha_w		:= position('?' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
		elsif (position(':' in ds_tarja_magnetica_w) > 0) then
			qt_fim_trilha_w		:= position(':' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
		elsif (position('/' in ds_tarja_magnetica_w) > 0) then
			qt_fim_trilha_w		:= position('/' in ds_tarja_magnetica_w);
		end if;

		ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,';','');
		ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,'ç','');
		ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,'Ç','');
		ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,'','');

		nm_beneficiario_p	:= pls_somente_letra_espaco(upper(substr(ds_tarja_magnetica_w,2,qt_fim_trilha_w-2)));

		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,qt_fim_trilha_w + 1,length(ds_tarja_magnetica_w));

		if (position('?' in ds_tarja_magnetica_w) > 0) then
			qt_fim_trilha_w		:= position('?' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
		elsif (position(':' in ds_tarja_magnetica_w) > 0) then
			qt_fim_trilha_w		:= position(':' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
		end if;
		--ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,1,qt_fim_trilha_w-2);
		qt_caracteres_carteira_w	:= position('=' in ds_tarja_magnetica_w) - 1;

		if (qt_caracteres_carteira_w = 16) then
			ds_tarja_magnetica_w	:= '0' || ds_tarja_magnetica_w;
		elsif (qt_caracteres_carteira_w = 15) then
			ds_tarja_magnetica_w	:= '00' || ds_tarja_magnetica_w;
		end if;

		qt_caracteres_carteira_w	:= length(ds_tarja_magnetica_w);

		if (qt_caracteres_carteira_w = 39) then
			cd_usuario_plano_p	:= substr(ds_tarja_magnetica_w,1,17);
			nr_via_p		:= substr(ds_tarja_magnetica_w,19,2);
			cd_operadora_p		:= substr(ds_tarja_magnetica_w,2,3);
		else
			cd_usuario_plano_p	:= substr(ds_tarja_magnetica_w,1,17);
			nr_via_p		:= substr(ds_tarja_magnetica_w,19,2);
			dt_validade_p		:= substr(ds_tarja_magnetica_w,23,2) || '/' || substr(ds_tarja_magnetica_w,21,2);
			cd_operadora_p		:= substr(ds_tarja_magnetica_w,2,3);
			dt_validade_format_p	:= '01/' || substr(ds_tarja_magnetica_w,23,2) || '/20' || substr(ds_tarja_magnetica_w,21,2);
			cd_produto_w		:= substr(ds_tarja_magnetica_w,30,3);
			ie_abrangencia_w	:= substr(ds_tarja_magnetica_w,33,1);
			ie_tipo_contratacao_w	:= substr(ds_tarja_magnetica_w,34,1);
		end if;

		begin
			select	max(nr_sequencia),
				nm_fantasia
			into STRICT	nr_seq_produto_p,
				nm_produto_p
			from	pls_plano
			where	cd_tarja_magnetica 		= cd_produto_w
			and	coalesce(ie_tipo_operacao, 'T') 	= 'T'
			and	cd_estabelecimento		= cd_estabelecimento_p
			group by nm_fantasia;
		exception
		when others then
			nm_produto_p	:= '';
		end;

		select	count(*)
		into STRICT	qt_existe_base_w
		from	pls_segurado_carteira
		where	cd_usuario_plano	= cd_usuario_plano_p;

		/* Verificar a carteira do beneficirio de intercmbio */

		if (qt_existe_base_w = 0) then
			select	count(*)
			into STRICT	qt_existe_base_w
			from	pls_segurado_carteira a,
				pls_segurado b
			where	a.nr_seq_segurado	= b.nr_sequencia
			and	a.nr_cartao_intercambio	= cd_usuario_plano_p;

			if (qt_existe_base_w = 0) then
				select	count(*)
				into STRICT	qt_existe_base_w
				from	pls_segurado_cart_ant
				where	cd_usuario_ant = cd_usuario_plano_p;
			end if;
		end if;

		if (ie_restringe_estab_w = 'S') and (qt_existe_base_w	> 0) then
			select	count(*)
			into STRICT	qt_existente_w
			from	pls_segurado_carteira
			where	cd_usuario_plano	= cd_usuario_plano_p
			and	cd_estabelecimento	= cd_estabelecimento_p;

			/* Verificar a carteira do beneficirio de intercmbio */

			if (qt_existente_w = 0) then
				select	count(*)
				into STRICT	qt_existente_w
				from	pls_segurado_carteira a,
					pls_segurado b
				where	a.nr_seq_segurado	= b.nr_sequencia
				and	a.nr_cartao_intercambio	= cd_usuario_plano_p
				and	a.cd_estabelecimento	= cd_estabelecimento_p;
			end if;

			if (qt_existente_w = 0) then
				nm_beneficiario_p	:= '';
				ds_tarja_magnetica_w	:= '';
				nr_via_p		:= '0';
				dt_validade_p		:= '';
				cd_produto_w		:= '';
				nm_produto_p		:= '';
				dt_validade_format_p	:= '';
			end if;
		end if;

		-- Se o caractere depois do caractere indicador de fim de trilha ('?', '/' etc...) for numérico,
		-- pegar os caracteres a partir de qt_fim_trilha_w+1 senão, qt_fim_trilha_w+2
		if ( pls_obter_se_somente_numero(substr(ds_tarja_magnetica_w, qt_fim_trilha_w+1, 1)) = 'S') then
			ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,qt_fim_trilha_w+1,length(ds_tarja_magnetica_w));
		else
			ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,qt_fim_trilha_w+2,length(ds_tarja_magnetica_w));
		end if;

		if (qt_caracteres_carteira_w > 40) then
			begin
				dt_nascimento_p	:= to_date(substr(somente_numero(ds_tarja_magnetica_w),19,8),'ddmmyyyy');
			exception
			when others then
				dt_nascimento_p	:= null;
			end;
		end if;
	end if;

	if (ie_abrangencia_w IS NOT NULL AND ie_abrangencia_w::text <> '') then
		if (ie_abrangencia_w = '1') then
			ds_abrangencia_p	:= 'Nac.';
			ie_abrangencia_p	:= ie_abrangencia_w;
		elsif (ie_abrangencia_w = '2') then
			ds_abrangencia_p	:= 'Reg.A';
			ie_abrangencia_p	:= ie_abrangencia_w;
		elsif (ie_abrangencia_w = '3') then
			ds_abrangencia_p	:= 'Est.';
			ie_abrangencia_p	:= ie_abrangencia_w;
		elsif (ie_abrangencia_w = '4') then
			ds_abrangencia_p	:= 'Reg. B';
			ie_abrangencia_p	:= ie_abrangencia_w;
		elsif (ie_abrangencia_w = '5') then
			ds_abrangencia_p	:= 'Mun.';
			ie_abrangencia_p	:= ie_abrangencia_w;
		end if;
	else
		ie_abrangencia_p	:= '';
		ds_abrangencia_p	:= '';
	end if;

	/*aaschlote 03/06/2011 - Obter o tipo de contratao na tarja*/

	if (ie_tipo_contratacao_w IS NOT NULL AND ie_tipo_contratacao_w::text <> '') then
		if (ie_tipo_contratacao_w in ('2','5')) then
			ie_tipo_contratacao_p	:= 'I';
		elsif (ie_tipo_contratacao_w = '3') then
			ie_tipo_contratacao_p	:= 'CE';
		elsif (ie_tipo_contratacao_w = '4') then
			ie_tipo_contratacao_p	:= 'CA';
		end if;
	else
		ie_tipo_contratacao_p	:= '';
	end if;

	if (cd_produto_w IS NOT NULL AND cd_produto_w::text <> '') then
		cd_plano_tarja_mag_p	:= cd_produto_w;
	end if;
end if;

--OS 1198425 Se o beneficiário não existir na base, verifica o parâmetro ie_produto_tarja para retornar o código do produto identificado na tarja
ie_produto_tarja_w	:= pls_verif_obtem_produto_tarja(cd_estabelecimento_p);

if (coalesce(ie_produto_tarja_w, 'S')	= 'N') then
	nr_seq_produto_p	:= null;
	nm_produto_p		:= null;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_valores_tarja_mag ( ds_tarja_magnetica_p text, nm_beneficiario_p INOUT text, cd_usuario_plano_p INOUT text, nr_via_p INOUT text, dt_validade_p INOUT text, cd_operadora_p INOUT text, dt_validade_format_p INOUT timestamp, dt_nascimento_p INOUT timestamp, nm_produto_p INOUT text, nr_seq_produto_p INOUT bigint, ds_abrangencia_p INOUT text, ie_abrangencia_p INOUT text, ie_tipo_contratacao_p INOUT text, cd_plano_tarja_mag_p INOUT text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

