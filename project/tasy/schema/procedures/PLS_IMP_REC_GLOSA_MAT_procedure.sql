-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_imp_rec_glosa_mat ( nr_seq_conta_imp_p bigint, nr_seq_conta_p bigint, vl_recursado_p bigint, cd_tipo_tabela_p text, cd_material_p text, ds_material_p text, dt_realizacao_p timestamp, nm_usuario_p text, ds_justificativa_p text, cd_glosa_p text, nr_seq_conta_mat_imp_p INOUT bigint, nr_seq_item_tiss_p pls_rec_glosa_mat_imp.nr_seq_item_tiss%type default null) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Importar os materiais apresentados no Recurso de Glosa conforme padrao TISS
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta:
[  ]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  x] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:Performance.
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_conta_mat_imp_w		bigint;
nr_seq_conta_mat_w		bigint;
nr_seq_conta_w			bigint;
nr_seq_conta_tmp_w		pls_conta.nr_sequencia%type;
dt_realizacao_w			pls_rec_glosa_mat_imp.dt_realizacao%type;
qt_regra_w			integer;
qt_recurso_w			integer := 0;
nr_seq_material_w		pls_material.nr_sequencia%type;
cd_prestador_w			pls_prestador.cd_prestador%type;
nr_seq_prest_prot_w		pls_prestador.nr_sequencia%type;
nr_seq_protocolo_cta_w		pls_rec_glosa_prot_cta_imp.nr_sequencia%type;
nr_seq_conta_ww			pls_conta.nr_sequencia%type;
nr_seq_conta_rec_w		pls_rec_glosa_conta_imp.nr_sequencia%type;
nr_seq_conta_imp_ww		pls_rec_glosa_conta_imp.nr_sequencia%type;
nr_seq_conta_imp_w		pls_rec_glosa_conta_imp.nr_sequencia%type;
cd_guia_w			pls_conta.cd_guia%type;
ds_log_call_w			varchar(1500);
qt_rec_glosa_w			pls_parametros_rec_glosa.qt_recurso_conta%type;
ds_observacao_w			varchar(2000);
ds_lotes_w			varchar(1500);
nr_seq_analise_w		pls_analise_conta.nr_sequencia%type;
nr_seq_conta_original_w		pls_conta.nr_sequencia%type;
ie_cooperado_w				varchar(1) := 'N';
ie_participante_cooperado_w	pls_parametros_rec_glosa.ie_participante_cooperado%type;
cd_versao_tiss_w	pls_versao_tiss.cd_versao_tiss%type;
nr_seq_protocolo_w	pls_rec_glosa_prot_cta_imp.nr_seq_protocolo%type;

C01 CURSOR(nr_seq_conta_mat_pc		pls_conta_mat.nr_sequencia%type) FOR
	SELECT	c.nr_seq_lote,
		'Integrado' ds_situacao
	from	pls_rec_glosa_mat a,
		pls_rec_glosa_conta b,
		pls_rec_glosa_protocolo c
	where	c.nr_sequencia = b.nr_seq_protocolo
	and	b.nr_sequencia = a.nr_seq_conta_rec
	and	a.nr_seq_conta_mat = nr_seq_conta_mat_pc
	
union all

	SELECT	d.nr_seq_lote,
		'Importado' ds_situacao
	from	pls_rec_glosa_mat_imp a,
		pls_rec_glosa_conta_imp b,
		pls_rec_glosa_prot_cta_imp c,
		pls_rec_glosa_protocolo d
	where	d.nr_sequencia = c.nr_seq_protocolo
	and	c.nr_sequencia = b.nr_seq_protocolo_cta
	and	b.nr_sequencia = a.nr_seq_conta_imp
	and	a.nr_seq_material = nr_seq_conta_mat_pc
	and	not exists (	select	1
				from	pls_rec_glosa_mat x
				where	x.nr_seq_conta_mat_imp = a.nr_sequencia);

BEGIN

if (length(ds_justificativa_p) > 150) then

	cd_versao_tiss_w := pls_obter_versao_tiss;
	if (cd_versao_tiss_w >= '4.00.01') then
		if (length(ds_justificativa_p) > 500) then

		select	max(y.nr_seq_protocolo)
		into STRICT	nr_seq_protocolo_w		
		from	pls_rec_glosa_conta_imp x,
				pls_rec_glosa_prot_cta_imp y
		where	x.nr_sequencia	= nr_seq_conta_imp_p
		and x.nr_seq_protocolo_cta = y.nr_sequencia;

			update	pls_rec_glosa_protocolo
			set	ie_situacao	= 'RE'
			where	nr_sequencia	= nr_seq_protocolo_w;
			
			commit;
			CALL wheb_mensagem_pck.exibir_mensagem_abort(357932);
		end if;
	else
		
		update	pls_rec_glosa_protocolo
		set	ie_situacao	= 'RE'
		where	nr_sequencia	= nr_seq_protocolo_w;
			
		commit;
		CALL wheb_mensagem_pck.exibir_mensagem_abort(357932);
		
	end if;

end if;

dt_realizacao_w	:= trunc(dt_realizacao_p,'dd');

select	max(coalesce(qt_recurso_conta, 0))
into STRICT	qt_rec_glosa_w
from	pls_parametros_rec_glosa;

select	max(nr_seq_conta),
	max(nr_seq_protocolo_cta),
	max(cd_guia)
into STRICT	nr_seq_conta_w,
	nr_seq_protocolo_cta_w,
	cd_guia_w
from	pls_rec_glosa_conta_imp
where	nr_sequencia = nr_seq_conta_imp_p;

select	max(nr_seq_prestador)
into STRICT	nr_seq_prest_prot_w
from	pls_rec_glosa_prot_cta_imp
where	nr_sequencia = nr_seq_protocolo_cta_w;

select 	coalesce(max(ie_participante_cooperado),'N')
into STRICT	ie_participante_cooperado_w
from 	pls_parametros_rec_glosa;

if (ie_participante_cooperado_w = 'S') then

		select 	coalesce(max(pls_obter_se_cooperado(cd_pessoa_fisica, cd_cgc)),'N')
		into STRICT	ie_cooperado_w
		from 	pls_prestador
		where 	nr_sequencia = nr_seq_prest_prot_w;

end if;

select	count(1)
into STRICT	qt_regra_w
from	pls_rec_regra_campo_esp
where	clock_timestamp() between dt_inicio_vigencia_ref and dt_fim_vigencia_ref;

select	max(nr_sequencia)
into STRICT	nr_seq_material_w
from	pls_material
where	cd_material_ops = cd_material_p;

if (coalesce(nr_seq_material_w::text, '') = '') then
	select	max(nr_sequencia)
	into STRICT	nr_seq_material_w
	from	pls_material
	where	cd_material = cd_material_p;
end if;

if (qt_regra_w > 0) then
	cd_prestador_w := pls_obter_cod_prestador(nr_seq_prest_prot_w, null);

	nr_seq_conta_ww := pls_gerar_campo_esp_rec(	null, null, null, nr_seq_material_w, ds_material_p, cd_prestador_w, cd_guia_w, vl_recursado_p, dt_realizacao_p, nr_seq_conta_ww);

	if (nr_seq_conta_ww IS NOT NULL AND nr_seq_conta_ww::text <> '') then
		if (nr_seq_conta_ww <> coalesce(nr_seq_conta_w,0)) then
			select	max(nr_sequencia)
			into STRICT	nr_seq_conta_rec_w
			from	pls_rec_glosa_conta_imp
			where	nr_seq_conta = nr_seq_conta_ww
			and	nr_seq_protocolo_cta = nr_seq_protocolo_cta_w;

			if (coalesce(nr_seq_conta_rec_w::text, '') = '') then
				select	nextval('pls_rec_glosa_conta_imp_seq')
				into STRICT	nr_seq_conta_imp_ww
				;

				insert into pls_rec_glosa_conta_imp(	nr_sequencia,dt_atualizacao_nrec, nm_usuario, dt_atualizacao, nm_usuario_nrec,
					nr_seq_protocolo_cta, nr_seq_conta, cd_ans, cd_guia,
					cd_guia_prestador, nm_operadora, ie_recurso_glosa,cd_prestador_executor,
					nm_prestador_executor, nr_lote,nr_protocolo, dt_realizacao,
					dt_fim_internacao,ds_senha, cd_guia_recurso, vl_total_recursado,
					dt_recurso, nm_beneficiario )
				(SELECT	nr_seq_conta_imp_ww , clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p,
					nr_seq_protocolo_cta_w, nr_seq_conta_ww, cd_ans, cd_guia,
					cd_guia_prestador, nm_operadora, ie_recurso_glosa,cd_prestador_executor,
					nm_prestador_executor, nr_lote,nr_protocolo, dt_realizacao,
					dt_fim_internacao,ds_senha, cd_guia_recurso, vl_total_recursado,
					dt_recurso, nm_beneficiario
				from	pls_rec_glosa_conta_imp
				where	nr_sequencia	= nr_seq_conta_imp_p);
			else
				nr_seq_conta_imp_ww := nr_seq_conta_rec_w;
			end if;
		end if;

		nr_seq_conta_w := nr_seq_conta_ww;
	end if;
end if;

if (nr_seq_conta_imp_ww IS NOT NULL AND nr_seq_conta_imp_ww::text <> '') then
	nr_seq_conta_imp_w := nr_seq_conta_imp_ww;
else
	nr_seq_conta_imp_w := nr_seq_conta_imp_p;
end if;


if (nr_seq_conta_w IS NOT NULL AND nr_seq_conta_w::text <> '') then

	--Se tiver parametrizado para prestador cooperado e for um prestador cooperado, 

	--entao necessita verificar se devera exibir esses materiais mesmo, atraves da verificacao do executor da conta
	if ( ie_participante_cooperado_w = 'S' and ie_participante_cooperado_w = 'S') then
		select 	max(nr_sequencia)
		into STRICT	nr_seq_conta_tmp_w
		from	pls_conta a
		where	nr_sequencia = nr_seq_conta_w
		and 	nr_seq_prestador_exec = nr_seq_prest_prot_w;
	else
		nr_seq_conta_tmp_w := nr_seq_conta_w;
	end if;
	
	--Busca pelo codigo do material, pela data e pelo valor recursado
	select	max(a.nr_sequencia)
	into STRICT	nr_seq_conta_mat_w
	from	pls_conta_mat a
	where	a.nr_seq_conta 				= nr_seq_conta_tmp_w
	and	trunc(a.dt_atendimento_referencia,'dd')	= dt_realizacao_w
	and	a.nr_seq_material 			= nr_seq_material_w
	and	a.vl_glosa				= vl_recursado_p
	and	pls_obter_se_mat_recursado(a.nr_sequencia, vl_recursado_p) = 'S';

	if (coalesce(nr_seq_conta_mat_w::text, '') = '') then
		select	max(a.nr_sequencia)
		into STRICT	nr_seq_conta_mat_w
		from	pls_conta_mat a
		where	a.nr_seq_conta 				= nr_seq_conta_tmp_w
		and	trunc(a.dt_atendimento_referencia,'dd')	= dt_realizacao_w
		and	a.nr_seq_material 			= nr_seq_material_w
		and	a.vl_glosa				= vl_recursado_p;
	end if;
	
	-- Se nao achou, busca pelo material, pela data e pelo valor de glosa maior que o valor recursado
	if (coalesce(nr_seq_conta_mat_w::text, '') = '') then
	
		select	max(a.nr_sequencia)
		into STRICT	nr_seq_conta_mat_w
		from	pls_conta_mat a
		where	a.nr_seq_conta 				= nr_seq_conta_tmp_w
		and	trunc(a.dt_atendimento_referencia,'dd')	= dt_realizacao_w
		and	a.nr_seq_material 			= nr_seq_material_w
		and	a.vl_glosa				> vl_recursado_p
		and	pls_obter_se_mat_recursado(a.nr_sequencia, vl_recursado_p) = 'S';

		-- Se nao achou, busca pelo material, pela data e pelo valor de glosa maior que zero
		if (coalesce(nr_seq_conta_mat_w::text, '') = '') then
			select	max(a.nr_sequencia)
			into STRICT	nr_seq_conta_mat_w
			from	pls_conta_mat a
			where	a.nr_seq_conta 				= nr_seq_conta_tmp_w
			and	trunc(a.dt_atendimento_referencia,'dd')	= dt_realizacao_w
			and	a.nr_seq_material 			= nr_seq_material_w
			and	a.vl_glosa				> 0
			and	pls_obter_se_mat_recursado(a.nr_sequencia, vl_recursado_p) = 'S';

			if (coalesce(nr_seq_conta_mat_w::text, '') = '') then
				select	max(a.nr_sequencia)
				into STRICT	nr_seq_conta_mat_w
				from	pls_conta_mat a
				where	a.nr_seq_conta 				= nr_seq_conta_tmp_w
				and	trunc(a.dt_atendimento_referencia,'dd')	= dt_realizacao_w
				and	a.nr_seq_material 			= nr_seq_material_w
				and	a.vl_glosa				> 0;
			end if;

			-- Se nao achou, busca pelo material e data
			if (coalesce(nr_seq_conta_mat_w::text, '') = '') then
				select	max(a.nr_sequencia)
				into STRICT	nr_seq_conta_mat_w
				from	pls_conta_mat a
				where	a.nr_seq_conta 				= nr_seq_conta_tmp_w
				and	trunc(a.dt_atendimento_referencia,'dd')	= dt_realizacao_w
				and	a.nr_seq_material 			= nr_seq_material_w
				and	pls_obter_se_mat_recursado(a.nr_sequencia, vl_recursado_p) = 'S';

				if (coalesce(nr_seq_conta_mat_w::text, '') = '') then
					select	max(a.nr_sequencia)
					into STRICT	nr_seq_conta_mat_w
					from	pls_conta_mat a
					where	a.nr_seq_conta 				= nr_seq_conta_tmp_w
					and	trunc(a.dt_atendimento_referencia,'dd')	= dt_realizacao_w
					and	a.nr_seq_material 			= nr_seq_material_w;
				end if;

				--Se nao achou, busca apenas pelo material
				if (coalesce(nr_seq_conta_mat_w::text, '') = '') then
					select	max(a.nr_sequencia)
					into STRICT	nr_seq_conta_mat_w
					from	pls_conta_mat a
					where	a.nr_seq_conta 		= nr_seq_conta_tmp_w
					and	a.nr_seq_material 	= nr_seq_material_w
					and	pls_obter_se_mat_recursado(a.nr_sequencia, vl_recursado_p) = 'S';
				end if;

				if (coalesce(nr_seq_conta_mat_w::text, '') = '') then
					select	max(a.nr_sequencia)
					into STRICT	nr_seq_conta_mat_w
					from	pls_conta_mat a
					where	a.nr_seq_conta 		= nr_seq_conta_tmp_w
					and	a.nr_seq_material 	= nr_seq_material_w;
				end if;
			end if;
		end if;
	end if;

	-- Se nao achou, faz a mesma verificacao com os campos de importacao
	if (coalesce(nr_seq_conta_mat_w::text, '') = '') then
		select	max(a.nr_sequencia)
		into STRICT	nr_seq_conta_mat_w
		from	pls_conta_mat a
		where	a.nr_seq_conta 				= nr_seq_conta_tmp_w
		and	a.cd_material_imp 			= cd_material_p
		and	trunc(a.dt_atendimento_referencia,'dd')	= dt_realizacao_w
		and	a.vl_glosa				= vl_recursado_p
		and	pls_obter_se_mat_recursado(a.nr_sequencia, vl_recursado_p) = 'S';

		if (coalesce(nr_seq_conta_mat_w::text, '') = '') then
			select	max(a.nr_sequencia)
			into STRICT	nr_seq_conta_mat_w
			from	pls_conta_mat a
			where	a.nr_seq_conta 				= nr_seq_conta_tmp_w
			and	a.cd_material_imp 			= cd_material_p
			and	trunc(a.dt_atendimento_referencia,'dd')	= dt_realizacao_w
			and	a.vl_glosa				= vl_recursado_p;
		end if;

		if (coalesce(nr_seq_conta_mat_w::text, '') = '') then
		
			select	max(a.nr_sequencia)
			into STRICT	nr_seq_conta_mat_w
			from	pls_conta_mat a
			where	a.nr_seq_conta 				= nr_seq_conta_tmp_w
			and	a.cd_material_imp 			= cd_material_p
			and	trunc(a.dt_atendimento_referencia,'dd')	= dt_realizacao_w
			and	a.vl_glosa				> vl_recursado_p
			and	pls_obter_se_mat_recursado(a.nr_sequencia, vl_recursado_p) = 'S';
			
			if (coalesce(nr_seq_conta_mat_w::text, '') = '') then
				select	max(a.nr_sequencia)
				into STRICT	nr_seq_conta_mat_w
				from	pls_conta_mat a
				where	a.nr_seq_conta 				= nr_seq_conta_tmp_w
				and	a.cd_material_imp 			= cd_material_p
				and	trunc(a.dt_atendimento_referencia,'dd')	= dt_realizacao_w
				and	a.vl_glosa				> 0
				and	pls_obter_se_mat_recursado(a.nr_sequencia, vl_recursado_p) = 'S';

				if (coalesce(nr_seq_conta_mat_w::text, '') = '') then
					select	max(a.nr_sequencia)
					into STRICT	nr_seq_conta_mat_w
					from	pls_conta_mat a
					where	a.nr_seq_conta 				= nr_seq_conta_tmp_w
					and	a.cd_material_imp 			= cd_material_p
					and	trunc(a.dt_atendimento_referencia,'dd')	= dt_realizacao_w
					and	a.vl_glosa				> 0;
				end if;

				if (coalesce(nr_seq_conta_mat_w::text, '') = '') then
					select	max(a.nr_sequencia)
					into STRICT	nr_seq_conta_mat_w
					from	pls_conta_mat a
					where	a.nr_seq_conta 				= nr_seq_conta_tmp_w
					and	a.cd_material_imp 			= cd_material_p
					and	trunc(a.dt_atendimento_referencia,'dd')	= dt_realizacao_w
					and	pls_obter_se_mat_recursado(a.nr_sequencia, vl_recursado_p) = 'S';

					if (coalesce(nr_seq_conta_mat_w::text, '') = '') then
						select	max(a.nr_sequencia)
						into STRICT	nr_seq_conta_mat_w
						from	pls_conta_mat a
						where	a.nr_seq_conta 				= nr_seq_conta_tmp_w
						and	a.cd_material_imp 			= cd_material_p
						and	trunc(a.dt_atendimento_referencia,'dd')	= dt_realizacao_w;
					end if;

					if (coalesce(nr_seq_conta_mat_w::text, '') = '') then
						select	max(a.nr_sequencia)
						into STRICT	nr_seq_conta_mat_w
						from	pls_conta_mat a
						where	a.nr_seq_conta 				= nr_seq_conta_tmp_w
						and	a.cd_material_imp 			= cd_material_p
						and	pls_obter_se_mat_recursado(a.nr_sequencia, vl_recursado_p) = 'S';

						if (coalesce(nr_seq_conta_mat_w::text, '') = '') then
							select	max(a.nr_sequencia)
							into STRICT	nr_seq_conta_mat_w
							from	pls_conta_mat a
							where	a.nr_seq_conta 				= nr_seq_conta_tmp_w
							and	a.cd_material_imp 			= cd_material_p;
						end if;
					end if;
				end if;
			end if;
		end if;
	end if;
end if;

select	max(nr_seq_analise)
into STRICT	nr_seq_analise_w
from	pls_conta
where	nr_sequencia = nr_seq_conta_w;

if (nr_seq_analise_w IS NOT NULL AND nr_seq_analise_w::text <> '') and (coalesce(nr_seq_conta_mat_w::text, '') = '') then
	
	nr_seq_conta_original_w := nr_seq_conta_w;
	
	select	max(a.nr_sequencia),
		max(a.nr_seq_conta)
	into STRICT	nr_seq_conta_mat_w,
		nr_seq_conta_w
	from	pls_conta_mat a,
			pls_conta b
	where	b.nr_sequencia = a.nr_seq_conta
	and	b.nr_seq_analise = nr_seq_analise_w
	and	a.nr_seq_material = nr_seq_material_w
	and	a.dt_atendimento_referencia = dt_realizacao_w
	and	b.nr_seq_prestador_exec = nr_seq_prest_prot_w
	and	a.vl_glosa > 0
	and	a.ie_status not in ('D','M');
	
	if (coalesce(nr_seq_conta_mat_w::text, '') = '') then
		
		select	max(a.nr_sequencia),
			max(a.nr_seq_conta)
		into STRICT	nr_seq_conta_mat_w,
			nr_seq_conta_w
		from	pls_conta_mat a,
			pls_conta b
		where	b.nr_sequencia = a.nr_seq_conta
		and	b.nr_seq_analise = nr_seq_analise_w
		and	a.cd_material_imp = cd_material_p
		and	a.dt_atendimento_referencia = dt_realizacao_w
		and	b.nr_seq_prestador_exec = nr_seq_prest_prot_w
		and	a.vl_glosa > 0
		and	a.ie_status not in ('D','M');
		
		if (coalesce(nr_seq_conta_mat_w::text, '') = '') then
			
			select	max(a.nr_sequencia),
				max(a.nr_seq_conta)
			into STRICT	nr_seq_conta_mat_w,
				nr_seq_conta_w
			from	pls_conta_mat a,
				pls_conta b
			where	b.nr_sequencia = a.nr_seq_conta
			and	b.nr_seq_analise = nr_seq_analise_w
			and	a.nr_seq_material = nr_seq_material_w
			and	b.nr_seq_prestador_exec = nr_seq_prest_prot_w
			and	a.vl_glosa > 0
			and	a.ie_status not in ('D','M');
			
			if (coalesce(nr_seq_conta_mat_w::text, '') = '') then
				
				select	max(a.nr_sequencia),
					max(a.nr_seq_conta)
				into STRICT	nr_seq_conta_mat_w,
					nr_seq_conta_w
				from	pls_conta_mat a,
					pls_conta b
				where	b.nr_sequencia = a.nr_seq_conta
				and	b.nr_seq_analise = nr_seq_analise_w
				and	a.cd_material_imp = cd_material_p
				and	b.nr_seq_prestador_exec = nr_seq_prest_prot_w
				and	a.vl_glosa > 0
				and	a.ie_status not in ('D','M');
			end if;
		end if;
	end if;
	
	if (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') and (nr_seq_conta_w IS NOT NULL AND nr_seq_conta_w::text <> '') then
		
		select	max(nr_sequencia)
		into STRICT	nr_seq_conta_imp_w
		from	pls_rec_glosa_conta_imp
		where	nr_seq_protocolo_cta	= nr_seq_protocolo_cta_w
		and	nr_seq_conta		= nr_seq_conta_w;
		
		---Caso n?o for, insere o recurso
		if (coalesce(nr_seq_conta_imp_w::text, '') = '') then
			
			select	nextval('pls_rec_glosa_conta_imp_seq')
			into STRICT	nr_seq_conta_imp_w
			;
			
			insert into pls_rec_glosa_conta_imp(	nr_sequencia,dt_atualizacao_nrec, nm_usuario, dt_atualizacao, nm_usuario_nrec,
				nr_seq_protocolo_cta, nr_seq_conta, cd_ans, cd_guia,
				cd_guia_prestador, nm_operadora, ie_recurso_glosa,cd_prestador_executor, 
				nm_prestador_executor, nr_lote,nr_protocolo, dt_realizacao, 
				dt_fim_internacao,ds_senha, cd_guia_recurso, vl_total_recursado,
				dt_recurso, nm_beneficiario )		
			(SELECT	nr_seq_conta_imp_w, clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p,
				nr_seq_protocolo_cta, nr_seq_conta_w, cd_ans, cd_guia,
				cd_guia_prestador, nm_operadora, ie_recurso_glosa,cd_prestador_executor, 
				nm_prestador_executor, nr_lote,nr_protocolo, dt_realizacao, 
				dt_fim_internacao,ds_senha, cd_guia_recurso, vl_total_recursado,
				dt_recurso, nm_beneficiario
			from	pls_rec_glosa_conta_imp
			where	nr_sequencia	= nr_seq_conta_imp_p);
		end if;
	end if;
end if;

select	nextval('pls_rec_glosa_mat_imp_seq')
into STRICT	nr_seq_conta_mat_imp_w
;

insert into pls_rec_glosa_mat_imp(
	nr_sequencia, nr_seq_conta_imp, dt_atualizacao,
	nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
	nr_seq_conta, nr_seq_material, cd_tipo_tabela,
	cd_material, ds_material, vl_recursado,ds_justificativa_prest,
	dt_realizacao, cd_glosa_recursada, nr_seq_item_tiss)
values (	nr_seq_conta_mat_imp_w, nr_seq_conta_imp_w, clock_timestamp(),
	nm_usuario_p, clock_timestamp(), nm_usuario_p,
	nr_seq_conta_w, nr_seq_conta_mat_w, cd_tipo_tabela_p,
	cd_material_p, ds_material_p, vl_recursado_p,ds_justificativa_p,
	dt_realizacao_p, cd_glosa_p, nr_seq_item_tiss_p);

if (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') then

	for r_C01_w in C01(nr_seq_conta_mat_w) loop
		qt_recurso_w := qt_recurso_w + 1;
		ds_lotes_w := ds_lotes_w || pls_util_pck.enter_w || r_C01_w.nr_seq_lote || ' (' || r_C01_w.ds_situacao || ')';
	end loop;
	
	if (qt_rec_glosa_w > 0) and (qt_recurso_w > qt_rec_glosa_w) then
		ds_observacao_w := 	'Quantidade de recursos enviados ultrapassa a quantidade maxima permitida. ' || pls_util_pck.enter_w ||
					'Qt enviada: ' || qt_recurso_w || '. Qt permitida: ' || qt_rec_glosa_w || pls_util_pck.enter_w || 
					'Lotes:' || pls_util_pck.enter_w ||
					ds_lotes_w;
		CALL pls_gravar_glosa_recurso_glosa('1820', nr_seq_conta_imp_w, null, nr_seq_conta_mat_imp_w, null, ds_observacao_w, nm_usuario_p);
	end if;
end if;

nr_seq_conta_mat_imp_p := nr_seq_conta_mat_imp_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_imp_rec_glosa_mat ( nr_seq_conta_imp_p bigint, nr_seq_conta_p bigint, vl_recursado_p bigint, cd_tipo_tabela_p text, cd_material_p text, ds_material_p text, dt_realizacao_p timestamp, nm_usuario_p text, ds_justificativa_p text, cd_glosa_p text, nr_seq_conta_mat_imp_p INOUT bigint, nr_seq_item_tiss_p pls_rec_glosa_mat_imp.nr_seq_item_tiss%type default null) FROM PUBLIC;

