-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE link_system_req_to_business (nr_seq_superior_p bigint default 0, nm_usuario_p text DEFAULT NULL, nr_sequencia_p bigint DEFAULT NULL, link_flag text DEFAULT NULL, origin_p text default 'BR') AS $body$
DECLARE


nr_seq_req_prs_w        LATAM_REQUISITO.NR_SEQ_REQ_PRS%TYPE;
ie_liberar_desenv_old_w LATAM_REQUISITO.IE_LIBERAR_DESENV%type;
cd_requisito_sys_req_w  LATAM_REQUISITO.CD_REQUISITO%type;

BEGIN

SELECT 'FR.' || LPAD(coalesce(COUNT(1), 0) + 1, 2, '0')
INTO STRICT cd_requisito_sys_req_w
FROM LATAM_REQUISITO A
WHERE coalesce(A.IE_TYPE_REQUIREMENT, 'SR') = 'SR'
AND a.NR_SEQ_SUPERIOR = nr_seq_superior_p;

SELECT  MAX(NR_SEQ_REQ_PRS)
INTO STRICT    nr_seq_req_prs_w
FROM    LATAM_REQUISITO x
WHERE   x.NR_SEQUENCIA = nr_seq_superior_p;

IF (link_flag = 'LINK') THEN
    UPDATE  LATAM_REQUISITO
    SET     NR_SEQ_SUPERIOR     = nr_seq_superior_p,
            NM_USUARIO          = nm_usuario_p,
            DT_ATUALIZACAO      = clock_timestamp(),
            CD_REQUISITO        = cd_requisito_sys_req_w,
            NR_SEQ_REQ_PRS      = nr_seq_req_prs_w
    WHERE   NR_SEQUENCIA        = nr_sequencia_p;

ELSE

    UPDATE  LATAM_REQUISITO
    SET     NR_SEQ_SUPERIOR      = NULL,
            NM_USUARIO          = nm_usuario_p,
            DT_ATUALIZACAO      = clock_timestamp(),
            CD_REQUISITO        = cd_requisito_sys_req_w,
            NR_SEQ_REQ_PRS       = NULL
    WHERE   NR_SEQUENCIA        = nr_sequencia_p;

END IF;

SELECT  IE_LIBERAR_DESENV
INTO STRICT    ie_liberar_desenv_old_w
FROM    LATAM_REQUISITO
WHERE   LATAM_REQUISITO.NR_SEQUENCIA = CASE WHEN origin_p='BR' THEN  nr_seq_superior_p  ELSE nr_sequencia_p END;

IF origin_p = 'BR' THEN
    CALL GENERATE_LATAM_LOG(nr_seq_superior_p, ie_liberar_desenv_old_w, CASE WHEN link_flag = 'LINK' THEN 1061484 ELSE 1061494 END);
ELSE
    GENERATE_LATAM_LOG(nr_sequencia_p, ie_liberar_desenv_old_w, CASE WHEN link_flag = 'LINK' THEN 1031813 ELSE 1032155 END);
END IF;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE link_system_req_to_business (nr_seq_superior_p bigint default 0, nm_usuario_p text DEFAULT NULL, nr_sequencia_p bigint DEFAULT NULL, link_flag text DEFAULT NULL, origin_p text default 'BR') FROM PUBLIC;

