-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE importa_extrato_febraban_conta ( nr_seq_extrato_p bigint) AS $body$
DECLARE


nr_seq_conta_W		bigint;
vl_saldo_inicial_w	double precision;
vl_saldo_final_w	double precision;
dt_saldo_inicial_w	timestamp;
dt_saldo_final_w	timestamp;
ie_deb_cred_saldo_ini_w	varchar(1);
ie_deb_cred_saldo_fin_w	varchar(1);
nr_seq_inicial_w	bigint;
nr_seq_final_w		bigint;

/* Registro detalhe */

nr_documento_w		varchar(39);
dt_lancamento_w		varchar(8);
vl_lancamento_w		varchar(18);
ie_deb_cred_w		varchar(1);
nr_conta_w		varchar(13);
digito_conta_w		varchar(1);
ds_historico_w		varchar(25);
nr_lote_w		varchar(4);
ie_natureza_w		varchar(3);
cd_historico_w		varchar(4);

/* Saldos inicial e final sem lan√ßamentos */

qt_lancamento_w		bigint;
nr_sequencia_w		bigint;

c01 CURSOR FOR
SELECT	substr(ds_conteudo,202,39) nr_documento,
	substr(ds_conteudo,143,8) dt_lancto,
	substr(ds_conteudo,151,18) vl_lancto,
	substr(ds_conteudo,169,1) ie_cred_deb,
	substr(ds_conteudo,59,13) nr_conta,
	substr(ds_conteudo,72,1) digito_conta,
	substr(ds_conteudo,177,25) ds_historico,
	substr(ds_conteudo,4,4) nr_lote,
	substr(ds_conteudo,109,3) ie_natureza,
	substr(ds_conteudo,173,4) cd_historico
from	W_interf_concil
where	substr(ds_conteudo,8,1)	= '3'
and	nr_seq_conta		= nr_seq_conta_W;


BEGIN

Select	max(b.nr_seq_conta)
into STRICT	nr_seq_conta_w
from	banco_estabelecimento a,
	banco_extrato b
where	b.nr_seq_conta	= a.nr_sequencia
and	b.nr_sequencia	= nr_seq_extrato_p;

select	min(a.nr_sequencia)
into STRICT	nr_seq_inicial_w
from	w_interf_concil a
where	substr(ds_conteudo,8,1)		= '1'
and	a.nr_seq_conta			= nr_seq_conta_w;

select	max(a.nr_sequencia)
into STRICT	nr_seq_final_w
from	w_interf_concil a
where	substr(ds_conteudo,8,1)		= '5'
and	a.nr_seq_conta			= nr_seq_conta_w;

select	to_date(substr(a.ds_conteudo,143,8),'dd/mm/yyyy') dt_lancto,
	somente_numero(substr(a.ds_conteudo,151,18)) / 100 vl_lancto,
	substr(a.ds_conteudo,169,1) ie_cred_deb
into STRICT	dt_saldo_inicial_w,
	vl_saldo_inicial_w,
	ie_deb_cred_saldo_ini_w
from	w_interf_concil a
where	a.nr_sequencia	= nr_seq_inicial_w;

select	to_date(substr(a.ds_conteudo,143,8),'dd/mm/yyyy') dt_lancto,
	somente_numero(substr(a.ds_conteudo,151,18)) / 100 vl_lancto,
	substr(a.ds_conteudo,169,1) ie_cred_deb
into STRICT	dt_saldo_final_w,
	vl_saldo_final_w,
	ie_deb_cred_saldo_fin_w
from	w_interf_concil a
where	a.nr_sequencia	= nr_seq_final_w;

if (ie_deb_cred_saldo_ini_w	= 'D') then
	vl_saldo_inicial_w	:= coalesce(vl_saldo_inicial_w,0) * -1;
end if;

if (ie_deb_cred_saldo_fin_w	= 'D') then
	vl_saldo_final_w	:= coalesce(vl_saldo_final_w,0) * -1;
end if;

update	banco_extrato
set	vl_saldo_inicial	= vl_saldo_inicial_w,
	vl_saldo_final		= vl_saldo_final_w,
	dt_inicio		= dt_saldo_inicial_w,
	dt_final		= dt_saldo_final_w,
	dt_atualizacao		= clock_timestamp()
where	nr_sequencia		= nr_seq_extrato_p;

open c01;
loop
fetch c01 into
	nr_documento_w,
	dt_lancamento_w,
	vl_lancamento_w,
	ie_deb_cred_w,
	nr_conta_w,
	digito_conta_w,
	ds_historico_w,
	nr_lote_w,
	ie_natureza_w,
	cd_historico_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	insert	into banco_extrato_lanc(nr_documento,
		dt_movimento,
		vl_lancamento,
		ie_deb_cred,
		nr_seq_extrato,
		nr_sequencia,
		nm_usuario,
		ie_conciliacao,
		dt_atualizacao,
		ds_historico,
		nr_lote,
		ie_natureza,
		cd_historico)
	values (nr_documento_w,
		to_date(dt_lancamento_w,'dd/mm/yyyy'),
		somente_numero(vl_lancamento_w) / 100,
		ie_deb_cred_w,
		nr_seq_extrato_p,
		nextval('banco_extrato_lanc_seq'),
		'Tasy',
		'N',
		clock_timestamp(),
		ds_historico_w,
		nr_lote_w,
		ie_natureza_w,
		cd_historico_w);

end loop;
close c01;

delete 	from w_interf_concil
where	nr_seq_conta	= nr_seq_conta_W;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importa_extrato_febraban_conta ( nr_seq_extrato_p bigint) FROM PUBLIC;

