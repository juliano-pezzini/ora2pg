-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_valor_proc_regra_orc ( nr_seq_regra_p bigint, nr_seq_orcamento_p bigint, nm_usuario_p text, cd_setor_atendimento_p bigint, vl_procedimento_p INOUT bigint) AS $body$
DECLARE

					

vl_Acumulado_w			double precision;
pr_Aplicar_w			double precision;
cd_estabelecimento_w		smallint;
vl_limite_w			regra_preco_proc_crit.vl_limite%type;
cd_convenio_w			regra_preco_proc_crit.cd_convenio%type;
vl_ajuste_w			double precision;
ie_somente_item_setor_w		regra_preco_proc.ie_somente_item_setor%type :='N';
qt_proc_restricao_w             bigint;


c01 CURSOR( nr_seq_orcamento_pc 	bigint,
	     ie_somente_item_setor_pc  	text, 
	     cd_setor_atendimento_pc   	bigint ) FOR

	SELECT 	e.cd_area_procedimento,
		e.cd_especialidade,
		e.cd_grupo_proc,
		a.cd_procedimento,
		a.ie_origem_proced,
		0 cd_grupo_material,
		0 cd_subgrupo_material,
		0 cd_classe_material,
		0 cd_material,
		sum(a.vl_procedimento) 	    vl_item,
		sum(a.vl_medico)	    vl_item_medico,
		sum(a.vl_custo_operacional) vl_item_custo_oper,
		sum(a.vl_filme) 	    vl_item_filme,
		sum(a.qt_procedimento) 	    qt_item,
		a.nr_seq_proc_interno,
		'' ie_consignado
	from 	Estrutura_Procedimento_v 	e, 
		orcamento_paciente_proc 	a
	where 	a.nr_sequencia_orcamento	= nr_seq_orcamento_pc
	and	a.cd_procedimento		= e.cd_procedimento
	and	a.ie_origem_proced		= e.ie_origem_proced
	and	((ie_somente_item_setor_pc ='N') or (a.cd_setor_atendimento = cd_setor_atendimento_pc))
	GROUP BY e.cd_area_procedimento, 
		 e.cd_especialidade, 
		 e.cd_grupo_proc, 
		 a.cd_procedimento, 
		 a.ie_origem_proced, 0, 0, 0, 0, 
		 a.nr_seq_proc_interno,
		 ''
	
union

	SELECT 	0 cd_area_procedimento,
		0 cd_especialidade,
		0 cd_grupo_proc,
		0 cd_procedimento,
		0 ie_origem_proced,
		e.cd_grupo_material,
		e.cd_subgrupo_material,
		e.cd_classe_material,
		a.cd_material,
		sum(a.vl_Material) vl_item,
		0 		   vl_item_medico,
		0 		   vl_item_custo_oper,
		0 		   vl_item_filme,
		sum(a.qt_material) qt_item,
		0 		   nr_seq_proc_interno,
		e.ie_consignado
	from 	Estrutura_material_v	 e,
		orcamento_paciente_mat   a
	where 	a.nr_sequencia_orcamento 	= nr_seq_orcamento_pc
	and	a.cd_material			= e.cd_material
	and	((ie_somente_item_setor_pc ='N') or (a.cd_setor_atendimento = cd_setor_atendimento_pc))
	group by	0,
			0,
			0,
			0,
			0,
			e.cd_grupo_material,
			e.cd_subgrupo_material,
			e.cd_classe_material,
			a.cd_material,
			e.ie_consignado		
			order by 1,2,3,4,5,6,7,8,9;

/* Aplicacao principal\Faturamento\Regra preco taxa */

c09 CURSOR(	nr_seq_regra_pc 	  bigint,
		vl_item_pc		  bigint,
		cd_estabelecimento_pc 	  bigint,
		cd_convenio_pc 		  bigint ) FOR
		
SELECT 	cd_area_procedimento,
	cd_especialidade,
	cd_grupo_proc,
	cd_procedimento,
	ie_origem_proced,
	cd_grupo_material,
	cd_subgrupo_material,
	cd_classe_material,
	cd_material,
	nr_seq_proc_interno,
	(coalesce(cd_area_procedimento,0) +
	coalesce(cd_especialidade,0) +
	coalesce(cd_grupo_proc,0) +
	coalesce(cd_procedimento,0) +
	coalesce(nr_seq_proc_interno,0)) ie_procedimento_crit,
	(coalesce(cd_grupo_material,0) +
	coalesce(cd_subgrupo_material,0) +
	coalesce(cd_classe_material,0) +
	coalesce(cd_material,0)) 	ie_material_crit,
	pr_total,
	coalesce(ie_consignado,'2') 	ie_consignado,
	coalesce(a.vl_limite,0) 	vl_limite,
        a.nr_seq_criterio
from  	regra_preco_proc_crit 	a
where 	nr_seq_regra 		= nr_seq_regra_pc
and 	coalesce(vl_item_pc,0) between coalesce(a.vl_inicial, coalesce(vl_item_pc,0)) and coalesce(a.vl_final, coalesce(vl_item_pc,0))
and	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_pc,0)) = coalesce(cd_estabelecimento_pc,0)
and	coalesce(a.cd_convenio, coalesce(cd_convenio_pc, 0)) = coalesce(cd_convenio_pc, 0)
order by 10, 11, 1,2,3,4,5,6,7,8,9;

BEGIN

select 	max(cd_estabelecimento),
	max(cd_convenio)
into STRICT	cd_estabelecimento_w,
	cd_convenio_w
from 	orcamento_paciente
where 	nr_sequencia_orcamento = nr_seq_orcamento_p;


vl_acumulado_w		:= 0;

select	coalesce(max(ie_somente_item_setor),'N')
into STRICT	ie_somente_item_setor_w
from	regra_preco_proc
where	nr_sequencia = nr_seq_regra_p;

for item_orcamento in C01(nr_seq_orcamento_p, ie_somente_item_setor_w, cd_setor_atendimento_p) loop

	pr_aplicar_w		:= 0;	
	for regra_criterio in C09( nr_seq_regra_p, item_orcamento.vl_item, cd_estabelecimento_w, cd_convenio_w) loop

		vl_limite_w := regra_criterio.vl_limite;
		
		if (coalesce(regra_criterio.nr_seq_criterio,0) > 0) and (nr_seq_regra_p > 0) then
			select  count(1)
			into STRICT    qt_proc_restricao_w
			from    regra_preco_proc_restricao 	a,
				orcamento_paciente_proc      	b,
				Estrutura_Procedimento_v   	c
			where   a.nr_seq_criterio               = regra_criterio.nr_seq_criterio
			and     a.nr_seq_regra                  = nr_seq_regra_p
			and     b.nr_sequencia_orcamento        = nr_seq_orcamento_p
			and     b.cd_procedimento               = c.cd_procedimento
			and     b.ie_origem_proced              = c.ie_origem_proced
			and     ((a.cd_area_procedimento = c.cd_area_procedimento)
				or (a.cd_especialidade = c.cd_especialidade)
				or (a.cd_grupo_proc    = c.cd_grupo_proc)
				or ((a.cd_procedimento  = c.cd_procedimento) and (coalesce(a.ie_origem_proced,c.ie_origem_proced) = c.ie_origem_proced)))
			and     a.ie_situacao = 'A';

		end if;
		
		if (qt_proc_restricao_w = 0) then
			if (item_orcamento.cd_procedimento > 0) then
			
				if (regra_criterio.ie_procedimento_crit > 0) and (regra_criterio.cd_area_procedimento	= item_orcamento.cd_area_procedimento or
					 regra_criterio.cd_especialidade	= item_orcamento.cd_especialidade or
					 regra_criterio.cd_grupo_proc		= item_orcamento.cd_grupo_proc or
					 regra_criterio.cd_procedimento		= item_orcamento.cd_procedimento or
					 regra_criterio.nr_seq_proc_interno	= item_orcamento.nr_seq_proc_interno ) then
					
					pr_aplicar_w	:= regra_criterio.pr_total;
				end if;
				
			else
				if (regra_criterio.ie_material_crit > 0) and (regra_criterio.cd_grupo_material	= item_orcamento.cd_grupo_material or
					 regra_criterio.cd_subgrupo_material	= item_orcamento.cd_subgrupo_material or
					 regra_criterio.cd_classe_material	= item_orcamento.cd_classe_material or
					 regra_criterio.cd_material		= item_orcamento.cd_material) and
					 (((coalesce(regra_criterio.ie_consignado,'2') = '0') and (item_orcamento.ie_consignado = '0')) or
					 ((coalesce(regra_criterio.ie_consignado,'2') = '1') and (item_orcamento.ie_consignado = '1')) or
					 ((coalesce(regra_criterio.ie_consignado,'2') = '3') and (item_orcamento.ie_consignado = '2')) or (coalesce(regra_criterio.ie_consignado,'2') = '2')) then
					
					pr_aplicar_w	:= regra_criterio.pr_total;
				end if;
			end if;
		end if;
		
	end loop;
	
	vl_ajuste_w := (item_orcamento.vl_item * pr_aplicar_w / 100);

	
	if (coalesce(vl_limite_w,0) > 0) and (vl_ajuste_w > vl_limite_w) then
		vl_ajuste_w := vl_limite_w;
	end if;	
				
	Vl_acumulado_w	:= vl_acumulado_w + vl_ajuste_w;
	
end loop;

vl_procedimento_p := vl_acumulado_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_valor_proc_regra_orc ( nr_seq_regra_p bigint, nr_seq_orcamento_p bigint, nm_usuario_p text, cd_setor_atendimento_p bigint, vl_procedimento_p INOUT bigint) FROM PUBLIC;

