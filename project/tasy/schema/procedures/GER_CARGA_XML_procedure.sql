-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ger_carga_xml (nr_seq_carga_p bigint, nr_seq_carga_arq_p bigint, nm_usuario_p text, nm_tabela_p text) AS $body$
DECLARE


ds_node_raiz_w		varchar(255);
ds_xmlns_w		varchar(255);
nr_sequencia_w		bigint;
ds_aux_1_w		varchar(4000);
ds_aux_linha_w		varchar(10) := '';
ds_aux_select_w		varchar(32000);
i integer;

nr_versao_w			impcat.nr_versao%type;
ds_descricao_catalogo_w		impcat.ds_descricao_catalogo%type;
ds_rotulo_exibicao_w		impcat.ds_rotulo_exibicao%type;
cd_categoria_w			impcat.cd_categoria%type;
ds_descricao_categoria_w	impcat.ds_descricao_categoria%type;
cd_categoria_pai_w		impcat.cd_categoria_pai%type;
cd_item_w			impcat.cd_item%type;
ds_item_w			impcat.ds_item%type;
cd_categoria_item_w		impcat.cd_categoria_item%type;

ds_tabColumn_insert_w		varchar(4000);
ds_tabColumn_w			varchar(4000);
ds_sel_col_padrao_w		varchar(4000);
ds_comando_w			varchar(4000);
ds_aux_from_w			varchar(4000);

nr_count_w		bigint := 0;
create_table_w		varchar(4000);

c01 CURSOR(nr_seq_carga_p  bigint) FOR
	SELECT	distinct(d.ds_nodo_xml_pai)
	from	ger_carga_inicial a,
		ger_tipo_carga b,
		ger_tipo_carga_arq c,
		ger_tipo_carga_campo d
	where	a.nr_sequencia = nr_seq_carga_p
	and	a.nr_seq_tipo_carga = b.nr_sequencia
	and	c.nr_seq_tipo_carga = b.nr_sequencia
	and	d.nr_seq_arquivo = c.nr_sequencia;

c01_w		c01%rowtype;

c02 CURSOR(nr_seq_carga_p  bigint, ds_nodo_xml_pai_p  text) FOR
	SELECT	d.nm_campo,
		d.ds_elemento_xml_imp
	from	ger_carga_inicial a,
		ger_tipo_carga b,
		ger_tipo_carga_arq c,
		ger_tipo_carga_campo d
	where	a.nr_sequencia = nr_seq_carga_p
	and	a.nr_seq_tipo_carga = b.nr_sequencia
	and	c.nr_seq_tipo_carga = b.nr_sequencia
	and	d.nr_seq_arquivo = c.nr_sequencia
	and	d.ds_nodo_xml_pai = ds_nodo_xml_pai_p;

c02_w		c02%rowtype;


BEGIN

ds_node_raiz_w := '/CodingSystemImportDS';
ds_xmlns_w     := 'xmlns="http://tempuri.org/CodingSystemImportDS.xsd"';

open c01(nr_seq_carga_p);
loop
fetch c01 into	
	c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	ds_aux_linha_w := '';
	
	ds_aux_1_w := '';
	
	ds_tabColumn_insert_w := '';
	
	open c02(nr_seq_carga_p, c01_w.ds_nodo_xml_pai);
	loop
	fetch c02 into	
		c02_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */

		ds_aux_1_w := ds_aux_1_w || ds_aux_linha_w || '  extractValue (VALUE(TAB), ''' ||
		       c01_w.ds_nodo_xml_pai || '/' || c02_w.ds_elemento_xml_imp ||
		       ''', ''' || ds_xmlns_w || ''') ' || c02_w.nm_campo;

		ds_aux_linha_w := ' , ' || chr(10);

		ds_tabColumn_insert_w := ds_tabColumn_insert_w||chr(10)||c02_w.nm_campo ||',';

	end loop;
	close c02;

	ds_aux_linha_w := chr(10);

	ds_aux_from_w :=
			'     TABle(XMLSequence(extract(xmltype(ds_arquivo), ' || ds_aux_linha_w ||
			'''' || ds_node_raiz_w || '/' || c01_w.ds_nodo_xml_pai || ''', ' || ds_aux_linha_w ||
			'''' || ds_xmlns_w || '''))) TAB,';
			
	ds_aux_select_w := ds_aux_1_w  || ds_aux_linha_w ||
			'from ger_imp_xml, '  || ds_aux_linha_w ||
			substr(ds_aux_from_w,1,(length(ds_aux_from_w) - 1))|| ds_aux_linha_w ||
			'Where nr_seq_carga = ' || nr_seq_carga_p;

	ds_aux_linha_w := ', '||chr(10);

	ds_tabColumn_w	:= 'nr_sequencia'||ds_aux_linha_w||
			'dt_atualizacao'||ds_aux_linha_w||
			'nm_usuario'||ds_aux_linha_w||
			'dt_atualizacao_nrec'||ds_aux_linha_w||
			'nm_usuario_nrec'||ds_aux_linha_w||
			'nr_seq_carga'||ds_aux_linha_w||
			'nr_seq_carga_arq'||ds_aux_linha_w||
			'ie_status'||ds_aux_linha_w||
			substr(ds_tabColumn_insert_w,1,(length(ds_tabColumn_insert_w) - 1));

	ds_sel_col_padrao_w := 'Select '||chr(10)||nm_tabela_p||'_seq.nextval'||ds_aux_linha_w||'sysdate'||ds_aux_linha_w||
					'''' ||nm_usuario_p||''''||ds_aux_linha_w||'sysdate'||ds_aux_linha_w||'''' ||nm_usuario_p||''''||ds_aux_linha_w||
					nr_seq_carga_p||ds_aux_linha_w||nr_seq_carga_arq_p||ds_aux_linha_w||'''I'''||ds_aux_linha_w;

	ds_comando_w := 'insert into '||nm_tabela_p||'('||chr(10)||ds_tabColumn_w||
					')'||chr(10)||
					'('||ds_sel_col_padrao_w || ds_aux_select_w||')';

	nr_count_w := nr_count_w + 1;
	
	CALL exec_sql_dinamico('TASY',ds_comando_w);
	
	commit;
	
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ger_carga_xml (nr_seq_carga_p bigint, nr_seq_carga_arq_p bigint, nm_usuario_p text, nm_tabela_p text) FROM PUBLIC;

