-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE oft_anexar_arquivos ( ds_arquivo_p text, nm_usuario_p text, nr_seq_consulta_p bigint, cd_profissional_p text, ds_imagem_p text DEFAULT ' ', nm_tabela_p text DEFAULT NULL, nr_seq_vinculo_p bigint DEFAULT NULL, nr_seq_item_p bigint DEFAULT NULL, ds_chave_p text DEFAULT NULL) AS $body$
DECLARE

  nr_sequencia_w bigint;
  ie_liberar_w   varchar(1);

BEGIN
  IF (nr_seq_consulta_p IS NOT NULL AND nr_seq_consulta_p::text <> '') AND (ds_arquivo_p IS NOT NULL AND ds_arquivo_p::text <> '') AND (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') THEN
    BEGIN
      IF (upper(nm_tabela_p) = 'OFT_ANEXO') THEN
        SELECT nextval('oft_anexo_seq') INTO STRICT nr_sequencia_w;
        IF (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') THEN
          BEGIN
		
            SELECT coalesce(upper(IE_FORMA_LIBERAR), 'N')
            INTO STRICT ie_liberar_w
            FROM perfil_item_oftalmologia
            WHERE cd_perfil = wheb_usuario_pck.get_cd_perfil
            AND nr_seq_item = 31;
			
            INSERT
            INTO oft_anexo(
                nr_sequencia,
                dt_registro,
                cd_profissional,
                ds_resumo,
                dt_atualizacao,
                nr_seq_consulta,
                nm_usuario_nrec,
                dt_atualizacao_nrec,
                nm_usuario,
                ds_anexo,
                nm_titulo,
                ie_situacao,
                dt_liberacao
              )
              VALUES (
                nr_sequencia_w,
                clock_timestamp(),
                cd_profissional_p,
                NULL,
                clock_timestamp(),
                nr_seq_consulta_p,
                nm_usuario_p,
                clock_timestamp(),
                nm_usuario_p,
                ds_arquivo_p,
                ds_imagem_p,
                'A',
                CASE WHEN ie_liberar_w='L' THEN  clock_timestamp()  ELSE NULL END
              );
            COMMIT;
          END;
        END IF;
      ELSIF (upper(nm_tabela_p) = 'OFT_IMAGEM_EXAME') THEN
        SELECT nextval('oft_imagem_exame_seq') INTO STRICT nr_sequencia_w;
        IF (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') THEN
          BEGIN
            INSERT
            INTO oft_imagem_exame(
                nr_sequencia,
                dt_atualizacao,
                nm_usuario,
                dt_atualizacao_nrec,
                nm_usuario_nrec,
                ds_titulo,
                ds_arquivo,
                ie_situacao,
                cd_profissional
              )
              VALUES (
                nr_sequencia_w,
                clock_timestamp(),
                nm_usuario_p,
                clock_timestamp(),
                nm_usuario_p,
                ds_imagem_p,
                ds_arquivo_p,
                'A',
                cd_profissional_p
              );
            IF (coalesce(nr_seq_item_p, 0) = 923952 OR coalesce(upper(ds_chave_p), ' ') = 'NR_SEQ_OFT_EXAME_EXTERNO') THEN
              UPDATE oft_imagem_exame
              SET NR_SEQ_OFT_EXAME_EXTERNO = nr_seq_vinculo_p
              WHERE nr_sequencia           = nr_sequencia_w;
            elsif (coalesce(nr_seq_item_p, 0)   = 924010 OR coalesce(upper(ds_chave_p), ' ') = 'NR_SEQ_FUNDOSCOPIA') THEN
              UPDATE oft_imagem_exame
              SET NR_SEQ_FUNDOSCOPIA     = nr_seq_vinculo_p
              WHERE nr_sequencia         = nr_sequencia_w;
            elsif (coalesce(nr_seq_item_p, 0) = 923817 OR coalesce(upper(ds_chave_p), ' ') = 'NR_SEQ_BIOMICROSCOPIA') THEN
              UPDATE oft_imagem_exame
              SET NR_SEQ_BIOMICROSCOPIA   = nr_seq_vinculo_p
              WHERE nr_sequencia          = nr_sequencia_w;
            elsif ((coalesce(nr_seq_item_p, 0) = 923749) OR (coalesce(nr_seq_item_p, 0) = 1108026) OR coalesce(upper(ds_chave_p), ' ') = 'NR_SEQ_ANGIO_RETINO') THEN
              UPDATE oft_imagem_exame
              SET NR_SEQ_ANGIO_RETINO    = nr_seq_vinculo_p
              WHERE nr_sequencia         = nr_sequencia_w;
            elsif (coalesce(nr_seq_item_p, 0) = 924209 OR coalesce(upper(ds_chave_p), ' ') = 'NR_SEQ_PAQUIMETRIA') THEN
              UPDATE oft_imagem_exame
              SET NR_SEQ_PAQUIMETRIA     = nr_seq_vinculo_p
              WHERE nr_sequencia         = nr_sequencia_w;
            elsif (coalesce(nr_seq_item_p, 0) = 924284 OR coalesce(upper(ds_chave_p), ' ') = 'NR_SEQ_TOMOGRAFIA') THEN
              UPDATE oft_imagem_exame
              SET NR_SEQ_TOMOGRAFIA      = nr_seq_vinculo_p
              WHERE nr_sequencia         = nr_sequencia_w;
            elsif (coalesce(nr_seq_item_p, 0) = 924149 OR coalesce(upper(ds_chave_p), ' ') = 'NR_SEQ_MAPEAMENTO') THEN
              UPDATE oft_imagem_exame
              SET NR_SEQ_MAPEAMENTO      = nr_seq_vinculo_p
              WHERE nr_sequencia         = nr_sequencia_w;
            elsif (coalesce(nr_seq_item_p, 0) = 924306 OR coalesce(upper(ds_chave_p), ' ') = 'NR_SEQ_ULTRASSONOGRAFIA') THEN
              UPDATE oft_imagem_exame
              SET NR_SEQ_ULTRASSONOGRAFIA = nr_seq_vinculo_p
              WHERE nr_sequencia          = nr_sequencia_w;
            elsif (coalesce(nr_seq_item_p, 0)  = 924154 OR coalesce(upper(ds_chave_p), ' ') = 'NR_SEQ_MICROSCOPIA') THEN
              UPDATE oft_imagem_exame
              SET NR_SEQ_MICROSCOPIA     = nr_seq_vinculo_p
              WHERE nr_sequencia         = nr_sequencia_w;
            elsif (coalesce(nr_seq_item_p, 0) = 923822 OR coalesce(upper(ds_chave_p), ' ') = 'NR_SEQ_CAMPIMETRIA') THEN
              UPDATE oft_imagem_exame
              SET NR_SEQ_CAMPIMETRIA     = nr_seq_vinculo_p
              WHERE nr_sequencia         = nr_sequencia_w;
            elsif (coalesce(nr_seq_item_p, 0) = 923832 OR coalesce(upper(ds_chave_p), ' ') = 'NR_SEQ_CERASTOCOPIA') THEN
              UPDATE oft_imagem_exame
              SET NR_SEQ_CERASTOCOPIA    = nr_seq_vinculo_p
              WHERE nr_sequencia         = nr_sequencia_w;
            elsif (coalesce(nr_seq_item_p, 0) = 923812 OR coalesce(upper(ds_chave_p), ' ') = 'NR_SEQ_BIOMETRIA') THEN
              UPDATE oft_imagem_exame
              SET NR_SEQ_BIOMETRIA       = nr_seq_vinculo_p
              WHERE nr_sequencia         = nr_sequencia_w;
            elsif (coalesce(nr_seq_item_p, 0) = 924279 OR coalesce(upper(ds_chave_p), ' ') = 'NR_SEQ_OCT') THEN
              UPDATE oft_imagem_exame
              SET NR_SEQ_OCT             = nr_seq_vinculo_p
              WHERE nr_sequencia         = nr_sequencia_w;
            elsif (coalesce(nr_seq_item_p, 0) = 1131164 OR coalesce(upper(ds_chave_p), ' ') = 'NR_SEQ_ABERROMETRIA') THEN
              UPDATE oft_imagem_exame
              SET NR_SEQ_ABERROMETRIA    = nr_seq_vinculo_p
              WHERE nr_sequencia         = nr_sequencia_w;
            elsif (coalesce(nr_seq_item_p, 0) = 924301) THEN
              SELECT coalesce(upper(IE_FORMA_LIBERAR), 'N')
              INTO STRICT ie_liberar_w
              FROM perfil_item_oftalmologia
              WHERE cd_perfil = wheb_usuario_pck.get_cd_perfil
              AND nr_seq_item = 168;
			
              UPDATE oft_imagem_exame
              SET ie_ceratoscopia        = 'S',
                dt_liberacao             = CASE WHEN ie_liberar_w='L' THEN  clock_timestamp()  ELSE NULL END 
              WHERE nr_sequencia         = nr_sequencia_w;
            elsif (coalesce(nr_seq_item_p, 0) = 923744) THEN
              SELECT coalesce(upper(IE_FORMA_LIBERAR), 'N')
              INTO STRICT ie_liberar_w
              FROM perfil_item_oftalmologia
              WHERE cd_perfil = wheb_usuario_pck.get_cd_perfil
              AND nr_seq_item = 31;
			
              UPDATE oft_imagem_exame
              SET NR_SEQ_CONSULTA = nr_seq_consulta_p,
                dt_liberacao      = CASE WHEN ie_liberar_w='L' THEN  clock_timestamp()  ELSE NULL END 
              WHERE nr_sequencia  = nr_sequencia_w;
            END IF;
            COMMIT;
          END;
        END IF;
      END IF;
    END;
  END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE oft_anexar_arquivos ( ds_arquivo_p text, nm_usuario_p text, nr_seq_consulta_p bigint, cd_profissional_p text, ds_imagem_p text DEFAULT ' ', nm_tabela_p text DEFAULT NULL, nr_seq_vinculo_p bigint DEFAULT NULL, nr_seq_item_p bigint DEFAULT NULL, ds_chave_p text DEFAULT NULL) FROM PUBLIC;

