-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE same_consistir_solic_duplicada (cd_pessoa_fisica_p text, cd_setor_solicitante_p bigint, ie_status_p text, nr_atendimento_p bigint) AS $body$
DECLARE


    perfil_ativo_w            bigint;
    usuario_ativo_w           varchar(255);
    estabelecimento_ativo_w   bigint;
    permite_solic_duplicada_w varchar(255);
    solicitacoes_w            bigint;


BEGIN
    -- select * from SAME_SOLIC_PRONT    

    -- select * from SAME_PRONTUARIO    where nr_sequencia = 1240864

    -- select * from SAME_SOLIC_PRONT_ENVELOPE       
    perfil_ativo_w := obter_perfil_ativo;
    --perfil_ativo_w := '';
    usuario_ativo_w := obter_usuario_ativo;
    --usuario_ativo_w := 'gmllessa';
    estabelecimento_ativo_w := obter_estabelecimento_ativo;
    --estabelecimento_ativo_w := 1;
    permite_solic_duplicada_w := obter_valor_param_usuario(941,
                                                           250,
                                                           perfil_ativo_w,
                                                           usuario_ativo_w,
                                                           estabelecimento_ativo_w);

    solicitacoes_w := 0;

    IF permite_solic_duplicada_w = 'NA' THEN
        -- NA - Não permite mesmo atendimento
        SELECT COUNT(*) solicitacoes
          INTO STRICT solicitacoes_w
          FROM same_solic_pront
         WHERE cd_pessoa_fisica = cd_pessoa_fisica_p
           AND cd_setor_solicitante = cd_setor_solicitante_p
           AND ie_status = ie_status_p
           AND nr_atendimento = nr_atendimento_p;

        IF solicitacoes_w > 0 THEN
            CALL wheb_mensagem_pck.exibir_mensagem_abort(1095024);
        END IF;
    END IF;

    IF permite_solic_duplicada_w = 'NV' THEN
        -- NA - Não permite mesmo atendimento e volume
        SELECT COUNT(*) solicitacoes
          INTO STRICT solicitacoes_w
          FROM same_solic_pront s
         INNER JOIN same_solic_pront_envelope e
            ON e.nr_seq_solic = s.nr_sequencia
         INNER JOIN same_prontuario p
            ON p.nr_sequencia = e.nr_seq_prontuario
         WHERE s.cd_pessoa_fisica = cd_pessoa_fisica_p
           AND s.cd_setor_solicitante = cd_setor_solicitante_p
           AND s.ie_status = ie_status_p
           AND s.nr_atendimento = nr_atendimento_p
           AND (p.nr_seq_volume IS NOT NULL AND p.nr_seq_volume::text <> '');

        IF solicitacoes_w > 0 THEN
            CALL wheb_mensagem_pck.exibir_mensagem_abort(1095025);
        END IF;
    END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE same_consistir_solic_duplicada (cd_pessoa_fisica_p text, cd_setor_solicitante_p bigint, ie_status_p text, nr_atendimento_p bigint) FROM PUBLIC;

