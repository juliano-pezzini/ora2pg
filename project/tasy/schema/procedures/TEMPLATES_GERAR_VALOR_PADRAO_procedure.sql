-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE templates_gerar_valor_padrao ( nr_seq_documento_p documento.nr_sequencia%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_pessoa_fisica_p atendimento_paciente.cd_pessoa_fisica%type, ie_aparelho_pa_p atendimento_sinal_vital.ie_aparelho_pa%type, ds_result_w INOUT text) AS $body$
DECLARE

										
ds_lista_tabela_w	text;
result_w text;

json_list_data    philips_json_list;
json_data_value    philips_json;

c_attibutes_rules CURSOR FOR
  SELECT ld.nm_table nm_tabela, tal.nm_atributo, ld.nr_sequencia
  from linked_data ld,
    ehr_template_conteudo  etc,
    tabela_atributo_linked tal
  where etc.nr_seq_linked_data = ld.nr_sequencia
  and etc.nr_sequencia = tal.NR_SEQ_ELEMENTO
  and etc.NR_SEQ_TEMPLATE = nr_seq_documento_p
  AND etc.nr_seq_elemento = 1613;

c_elements_ehr CURSOR FOR
  SELECT nr_sequencia from 
  ehr_template_conteudo  etc
  where etc.NR_SEQ_TEMPLATE = nr_seq_documento_p
  and nr_seq_elemento not in (1613, 308);

BEGIN
  
json_list_data := philips_json_list();
json_data_value := philips_json();

ds_lista_tabela_w	:=	Obter_select_concatenado_bv('select ld.nm_table 
  from linked_data ld,
    ehr_template_conteudo  tc
  where tc.nr_seq_linked_data = ld.nr_sequencia
  and tc.NR_SEQ_TEMPLATE = :nr_seq_template_p
  AND tc.nr_seq_elemento = 1613','nr_seq_template_p='||nr_seq_documento_p,',');

if (ds_lista_tabela_w IS NOT NULL AND ds_lista_tabela_w::text <> '') then		
  CALL his_rule_value_default_pck.reset_dados();
  CALL his_rule_value_default_pck.gerar_dados(nr_atendimento_p,cd_pessoa_fisica_p,ds_lista_tabela_w,null,nr_seq_documento_p);

  for atributes_rules in c_attibutes_rules LOOP
    if upper(atributes_rules.nm_tabela) = 'ATENDIMENTO_SINAL_VITAL' then
      result_w := his_rule_value_default_pck.get_valor_default(atributes_rules.nm_tabela,atributes_rules.nm_atributo,ie_aparelho_pa_p,null,null);
    else
      result_w := his_rule_value_default_pck.get_valor_default(atributes_rules.nm_tabela,atributes_rules.nm_atributo,null,null,null);
    end if;

    if (result_w IS NOT NULL AND result_w::text <> '') then
      json_data_value.put('table',atributes_rules.nm_tabela);
      json_data_value.put('linkedData',atributes_rules.nr_sequencia);
      json_data_value.put('attribute',atributes_rules.nm_atributo);
      json_data_value.put('value',result_w);

      json_list_data.append(json_data_value.to_json_value());
    end if;

  END LOOP;
end if;

CALL his_rule_value_default_pck.reset_dados();
CALL his_rule_value_default_pck.gerar_dados(nr_atendimento_p,cd_pessoa_fisica_p,null,nr_seq_documento_p);

for element_ehr in c_elements_ehr LOOP
  result_w := his_rule_value_default_pck.get_valor_default(null,null,null,nr_seq_documento_p,element_ehr.nr_sequencia);
  if (result_w IS NOT NULL AND result_w::text <> '') then
    json_data_value.remove('table');
    json_data_value.remove('linkedData');
    json_data_value.put('attribute',element_ehr.nr_sequencia);
    json_data_value.put('value',result_w);

    json_list_data.append(json_data_value.to_json_value());
  end if;
end loop;

dbms_lob.createtemporary(ds_result_w, TRUE);
json_list_data.(ds_result_w);

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE templates_gerar_valor_padrao ( nr_seq_documento_p documento.nr_sequencia%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_pessoa_fisica_p atendimento_paciente.cd_pessoa_fisica%type, ie_aparelho_pa_p atendimento_sinal_vital.ie_aparelho_pa%type, ds_result_w INOUT text) FROM PUBLIC;

