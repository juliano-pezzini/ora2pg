-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_conpaci_desc_item (nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_interno_conta_w	bigint;
pr_desconto_w		real;
vl_desconto_w		double precision;
vl_liquido_w		double precision;

cd_estrutura_w		integer;
vl_estrutura_w		double precision;
vl_liq_estrut_w		double precision;
cd_setor_atendimento_w	bigint;

nr_sequencia_w		bigint;
vl_total_estrut_w		double precision;
vl_total_desc_w		double precision;
vl_desc_estrut_w		double precision;

ie_tipo_desconto_w	integer;
ie_ok_w			integer;

cd_item_w		bigint;
ie_origem_proced_w	bigint;

ie_calcula_w		varchar(01)	:= 'S';
cd_convenio_w		bigint;
ds_mensagem_w		varchar(2000);
ds_item_w		varchar(500);
ie_proc_mat_w		bigint;
ie_pacote_w		varchar(1);
ie_valor_inf_w		conta_paciente_desconto.ie_valor_inf%type;

C01 CURSOR FOR
	SELECT	ie_emite_conta,
		sum(vl_item),
		0 cd_setor_atendimento,
		0 cd_item,
		0 ie_origem_proced
	from (
	SELECT	ie_emite_conta,
		sum(CASE WHEN coalesce(ie_emite_conta_honor::text, '') = '' THEN  vl_item  ELSE vl_item - vl_medico_conta END ) vl_item,
		0 cd_item,
		0 ie_origem_proced
	from conta_paciente_v
	where nr_interno_conta = nr_interno_conta_w
	  and coalesce(cd_motivo_exc_conta::text, '') = ''
	  and coalesce(nr_seq_proc_pacote, 0) <> nr_sequencia
	  and 	((ie_pacote_w = 'A') or
		((ie_pacote_w = 'F') and (coalesce(nr_seq_proc_pacote, 0) = 0)) or
		((ie_pacote_w = 'P') and (coalesce(nr_seq_proc_pacote, 0) > 0)))
	  and	((ie_valor_inf_w = 'A') or (ie_valor_inf_w = coalesce(ie_valor_informado,'N')))
	  and (ie_emite_conta IS NOT NULL AND ie_emite_conta::text <> '')
	group by ie_emite_conta
	
union all

	select	ie_emite_conta_honor,
		sum(vl_medico_conta),
		0 cd_item,
		0 ie_origem_proced
	from conta_paciente_v
	where nr_interno_conta = nr_interno_conta_w
	  and coalesce(cd_motivo_exc_conta::text, '') = ''
	  and coalesce(nr_seq_proc_pacote, 0) <> nr_sequencia
	 and 	((ie_pacote_w = 'A') or
		((ie_pacote_w = 'F') and (coalesce(nr_seq_proc_pacote, 0) = 0)) or
		((ie_pacote_w = 'P') and (coalesce(nr_seq_proc_pacote, 0) > 0)))
	 and 	((ie_valor_inf_w = 'A') or (ie_valor_inf_w = coalesce(ie_valor_informado,'N')))
	  and (ie_emite_conta_honor IS NOT NULL AND ie_emite_conta_honor::text <> '')
	group by ie_emite_conta_honor) alias38
	where	ie_tipo_desconto_w not in (5,6,8,9,10,11)
	group by ie_emite_conta
	having sum(vl_item) <> 0
	
union

	select	ie_emite_conta,
		sum(vl_item),
		cd_setor_atendimento,
		0 cd_item,
		0 ie_origem_proced
	from (
	select	ie_emite_conta,
		sum(CASE WHEN coalesce(ie_emite_conta_honor::text, '') = '' THEN  vl_item  ELSE vl_item - vl_medico_conta END ) vl_item,
		cd_setor_atendimento,
		0 cd_item,
		0 ie_origem_proced
	from conta_paciente_v
	where nr_interno_conta = nr_interno_conta_w
	  and coalesce(cd_motivo_exc_conta::text, '') = ''
	  and coalesce(nr_seq_proc_pacote, 0) <> nr_sequencia
	  and 	((ie_pacote_w = 'A') or
		((ie_pacote_w = 'F') and (coalesce(nr_seq_proc_pacote, 0) = 0)) or
		((ie_pacote_w = 'P') and (coalesce(nr_seq_proc_pacote, 0) > 0)))
	  and 	((ie_valor_inf_w = 'A') or (ie_valor_inf_w = coalesce(ie_valor_informado,'N')))
	  and (ie_emite_conta IS NOT NULL AND ie_emite_conta::text <> '')
	group by ie_emite_conta, cd_setor_atendimento
	
union all

	select	ie_emite_conta_honor,
		sum(vl_medico_conta),
		cd_setor_atendimento,
		0 cd_item,
		0 ie_origem_proced
	from conta_paciente_v
	where nr_interno_conta = nr_interno_conta_w
	  and coalesce(cd_motivo_exc_conta::text, '') = ''
	  and coalesce(nr_seq_proc_pacote, 0) <> nr_sequencia
	  and 	((ie_pacote_w = 'A') or
		((ie_pacote_w = 'F') and (coalesce(nr_seq_proc_pacote, 0) = 0)) or
		((ie_pacote_w = 'P') and (coalesce(nr_seq_proc_pacote, 0) > 0)))
	  and 	((ie_valor_inf_w = 'A') or (ie_valor_inf_w = coalesce(ie_valor_informado,'N')))
	  and (ie_emite_conta_honor IS NOT NULL AND ie_emite_conta_honor::text <> '')
	group by ie_emite_conta_honor, cd_setor_atendimento) alias79
	where	ie_tipo_desconto_w = 5
	group by ie_emite_conta, cd_setor_atendimento
	having sum(vl_item) <> 0
	
union

	select	ie_emite_conta,
		sum(vl_item),
		cd_setor_atendimento,
		cd_item,
		ie_origem_proced
	from (
	select	ie_emite_conta,
		sum(CASE WHEN coalesce(ie_emite_conta_honor::text, '') = '' THEN  vl_item  ELSE vl_item - vl_medico_conta END ) vl_item,
		0 cd_setor_atendimento,
		cd_item,
		ie_origem_proced
	from conta_paciente_v
	where nr_interno_conta = nr_interno_conta_w
	  and coalesce(cd_motivo_exc_conta::text, '') = ''
	  and coalesce(nr_seq_proc_pacote, 0) <> nr_sequencia
	  and 	((ie_pacote_w = 'A') or
		((ie_pacote_w = 'F') and (coalesce(nr_seq_proc_pacote, 0) = 0)) or
		((ie_pacote_w = 'P') and (coalesce(nr_seq_proc_pacote, 0) > 0)))
	  and 	((ie_valor_inf_w = 'A') or (ie_valor_inf_w = coalesce(ie_valor_informado,'N')))
	  and (ie_emite_conta IS NOT NULL AND ie_emite_conta::text <> '')
	group by ie_emite_conta,
		cd_item, ie_origem_proced
	
union all

	select	ie_emite_conta_honor,
		sum(vl_medico_conta),
		0 cd_setor_atendimento,
		cd_item,
		ie_origem_proced
	from conta_paciente_v
	where nr_interno_conta = nr_interno_conta_w
	  and coalesce(cd_motivo_exc_conta::text, '') = ''
	  and coalesce(nr_seq_proc_pacote, 0) <> nr_sequencia
	  and 	((ie_pacote_w = 'A') or
		((ie_pacote_w = 'F') and (coalesce(nr_seq_proc_pacote, 0) = 0)) or
		((ie_pacote_w = 'P') and (coalesce(nr_seq_proc_pacote, 0) > 0)))
	  and 	((ie_valor_inf_w = 'A') or (ie_valor_inf_w = coalesce(ie_valor_informado,'N')))
	  and (ie_emite_conta_honor IS NOT NULL AND ie_emite_conta_honor::text <> '')
	group by ie_emite_conta_honor,
		cd_item, ie_origem_proced) alias119
	where	ie_tipo_desconto_w = 6
	group by ie_emite_conta, cd_setor_atendimento,
		cd_item, ie_origem_proced
	having sum(vl_item) <> 0
	
union

	select	null,
		sum(vl_item),
		cd_setor_atendimento,
		(null)::numeric ,
		(null)::numeric
	from (
	select	sum(CASE WHEN coalesce(ie_emite_conta_honor::text, '') = '' THEN  vl_item  ELSE vl_item - vl_medico_conta END ) vl_item,
		cd_setor_atendimento,
		cd_item,
		ie_origem_proced
	from conta_paciente_v
	where nr_interno_conta = nr_interno_conta_w
	  and coalesce(cd_motivo_exc_conta::text, '') = ''
	  and coalesce(nr_seq_proc_pacote, 0) <> nr_sequencia
	  and 	((ie_pacote_w = 'A') or
		((ie_pacote_w = 'F') and (coalesce(nr_seq_proc_pacote, 0) = 0)) or
		((ie_pacote_w = 'P') and (coalesce(nr_seq_proc_pacote, 0) > 0)))
	  and 	((ie_valor_inf_w = 'A') or (ie_valor_inf_w = coalesce(ie_valor_informado,'N')))
	  and (ie_emite_conta IS NOT NULL AND ie_emite_conta::text <> '')
	group by cd_setor_atendimento,
		cd_item, ie_origem_proced
	
union all

	select	sum(vl_medico_conta),
		cd_setor_atendimento,
		cd_item,
		ie_origem_proced
	from conta_paciente_v
	where nr_interno_conta = nr_interno_conta_w
	  and coalesce(cd_motivo_exc_conta::text, '') = ''
	  and coalesce(nr_seq_proc_pacote, 0) <> nr_sequencia
	  and 	((ie_pacote_w = 'A') or
		((ie_pacote_w = 'F') and (coalesce(nr_seq_proc_pacote, 0) = 0)) or
		((ie_pacote_w = 'P') and (coalesce(nr_seq_proc_pacote, 0) > 0)))
	  and 	((ie_valor_inf_w = 'A') or (ie_valor_inf_w = coalesce(ie_valor_informado,'N')))
	  and (ie_emite_conta_honor IS NOT NULL AND ie_emite_conta_honor::text <> '')
	group by cd_setor_atendimento,
		cd_item, ie_origem_proced) alias161
	where	ie_tipo_desconto_w = 8
	group by cd_setor_atendimento
	having sum(vl_item) <> 0
	
union

	select	null,
		sum(vl_item),
		cd_setor_atendimento,
		(null)::numeric ,
		(null)::numeric 
	from (
	select	sum(CASE WHEN coalesce(ie_emite_conta_honor::text, '') = '' THEN  vl_item  ELSE vl_item - vl_medico_conta END ) vl_item,
		cd_setor_atendimento,
		cd_item,
		ie_origem_proced
	from conta_paciente_v
	where nr_interno_conta = nr_interno_conta_w
	  and coalesce(cd_motivo_exc_conta::text, '') = ''
	  and coalesce(nr_seq_proc_pacote, 0) <> nr_sequencia
	  and 	((ie_pacote_w = 'A') or
		((ie_pacote_w = 'F') and (coalesce(nr_seq_proc_pacote, 0) = 0)) or
		((ie_pacote_w = 'P') and (coalesce(nr_seq_proc_pacote, 0) > 0)))
	  and 	((ie_valor_inf_w = 'A') or (ie_valor_inf_w = coalesce(ie_valor_informado,'N')))
	  and (ie_emite_conta IS NOT NULL AND ie_emite_conta::text <> '')
	group by cd_setor_atendimento,
		cd_item, ie_origem_proced
	
union all

	select	sum(vl_medico_conta),
		cd_setor_atendimento,
		cd_item,
		ie_origem_proced
	from conta_paciente_v
	where nr_interno_conta = nr_interno_conta_w
	  and coalesce(cd_motivo_exc_conta::text, '') = ''
	  and coalesce(nr_seq_proc_pacote, 0) <> nr_sequencia
	  and 	((ie_pacote_w = 'A') or
		((ie_pacote_w = 'F') and (coalesce(nr_seq_proc_pacote, 0) = 0)) or
		((ie_pacote_w = 'P') and (coalesce(nr_seq_proc_pacote, 0) > 0)))
	  and 	((ie_valor_inf_w = 'A') or (ie_valor_inf_w = coalesce(ie_valor_informado,'N')))
	  and (ie_emite_conta_honor IS NOT NULL AND ie_emite_conta_honor::text <> '')
	group by cd_setor_atendimento,
		cd_item, ie_origem_proced) a
	where	ie_tipo_desconto_w = 9
	and	exists (select 1
		from	usuario_setor_v x
		where	x.cd_setor_atendimento	= a.cd_setor_atendimento
		and	x.nm_usuario		= nm_usuario_p)
	group by cd_setor_atendimento
	having sum(vl_item) <> 0
	
union

	select	null,
		sum(vl_item),
		cd_setor_atendimento,
		(null)::numeric ,
		(null)::numeric 
	from (
	select	sum(CASE WHEN coalesce(ie_emite_conta_honor::text, '') = '' THEN  vl_item  ELSE vl_item - vl_medico_conta END ) vl_item,
		cd_setor_atendimento,
		cd_item,
		ie_origem_proced
	from conta_paciente_v
	where nr_interno_conta = nr_interno_conta_w
	  and coalesce(cd_motivo_exc_conta::text, '') = ''
	  and coalesce(nr_seq_proc_pacote, 0) <> nr_sequencia
	  and 	((ie_pacote_w = 'A') or
		((ie_pacote_w = 'F') and (coalesce(nr_seq_proc_pacote, 0) = 0)) or
		((ie_pacote_w = 'P') and (coalesce(nr_seq_proc_pacote, 0) > 0)))
	  and 	((ie_valor_inf_w = 'A') or (ie_valor_inf_w = coalesce(ie_valor_informado,'N')))
	  and (ie_emite_conta IS NOT NULL AND ie_emite_conta::text <> '')
	group by cd_setor_atendimento,
		cd_item, ie_origem_proced
	
union all

	select	sum(vl_medico_conta),
		cd_setor_atendimento,
		cd_item,
		ie_origem_proced
	from conta_paciente_v
	where nr_interno_conta = nr_interno_conta_w
	  and coalesce(cd_motivo_exc_conta::text, '') = ''
	  and coalesce(nr_seq_proc_pacote, 0) <> nr_sequencia
	  and 	((ie_pacote_w = 'A') or
		((ie_pacote_w = 'F') and (coalesce(nr_seq_proc_pacote, 0) = 0)) or
		((ie_pacote_w = 'P') and (coalesce(nr_seq_proc_pacote, 0) > 0)))
	  and 	((ie_valor_inf_w = 'A') or (ie_valor_inf_w = coalesce(ie_valor_informado,'N')))
	  and (ie_emite_conta_honor IS NOT NULL AND ie_emite_conta_honor::text <> '')
	group by cd_setor_atendimento,
		cd_item, ie_origem_proced) a
	where	ie_tipo_desconto_w = 10
	and	exists (select 1
		from	regra_lib_setor_desconto x
		where	x.cd_setor_atendimento	= a.cd_setor_atendimento
		and	x.nm_usuario_lib		= nm_usuario_p)
	group by cd_setor_atendimento
	having sum(vl_item) <> 0
	
union

	select	ie_emite_conta,
		sum(vl_item),
		cd_setor_atendimento,
		cd_item,
		ie_origem_proced
	from (
	select	ie_emite_conta,
		sum(CASE WHEN coalesce(ie_emite_conta_honor::text, '') = '' THEN  vl_item  ELSE vl_item - vl_medico_conta END ) vl_item,
		coalesce(cd_setor_atendimento,0) cd_setor_atendimento,
		cd_item,
		ie_origem_proced
	from conta_paciente_v
	where nr_interno_conta = nr_interno_conta_w
	  and coalesce(cd_motivo_exc_conta::text, '') = ''
	  and coalesce(nr_seq_proc_pacote, 0) <> nr_sequencia
	  and 	((ie_pacote_w = 'A') or
		((ie_pacote_w = 'F') and (coalesce(nr_seq_proc_pacote, 0) = 0)) or
		((ie_pacote_w = 'P') and (coalesce(nr_seq_proc_pacote, 0) > 0)))
	  and 	((ie_valor_inf_w = 'A') or (ie_valor_inf_w = coalesce(ie_valor_informado,'N')))
	  and (ie_emite_conta IS NOT NULL AND ie_emite_conta::text <> '')
	group by ie_emite_conta, cd_setor_atendimento,
		cd_item, ie_origem_proced
	
union all

	select	ie_emite_conta_honor,
		sum(vl_medico_conta),
		coalesce(cd_setor_atendimento,0) cd_setor_atendimento,
		cd_item,
		ie_origem_proced
	from conta_paciente_v
	where nr_interno_conta = nr_interno_conta_w
	  and coalesce(cd_motivo_exc_conta::text, '') = ''
	  and coalesce(nr_seq_proc_pacote, 0) <> nr_sequencia
	  and 	((ie_pacote_w = 'A') or
		((ie_pacote_w = 'F') and (coalesce(nr_seq_proc_pacote, 0) = 0)) or
		((ie_pacote_w = 'P') and (coalesce(nr_seq_proc_pacote, 0) > 0)))
	  and 	((ie_valor_inf_w = 'A') or (ie_valor_inf_w = coalesce(ie_valor_informado,'N')))
	  and (ie_emite_conta_honor IS NOT NULL AND ie_emite_conta_honor::text <> '')
	group by ie_emite_conta_honor, cd_setor_atendimento,
		cd_item, ie_origem_proced) a
	where	ie_tipo_desconto_w = 11
	and	exists (select 1
		from	regra_lib_setor_desconto x
		where	x.cd_setor_atendimento	= a.cd_setor_atendimento
		and	x.nm_usuario_lib		= nm_usuario_p)
	group by ie_emite_conta, cd_setor_atendimento,
		cd_item, ie_origem_proced
	having sum(vl_item) <> 0;

C02 CURSOR FOR
	SELECT	 a.cd_item  ||' - '|| a.ds_item,
		a.ie_proc_mat
	from 	conta_paciente_v a
	where 	nr_interno_conta = nr_interno_conta_w
	and	coalesce(cd_motivo_exc_conta::text, '') = ''
	and 	somente_numero(coalesce(ie_emite_conta_honor, ie_emite_conta)) = 0
	group by a.ds_item,a.cd_item,a.ie_proc_mat
	order by a.ie_proc_mat,a.ds_item;


BEGIN

select	nr_interno_conta,
	pr_desconto,
	vl_desconto,
	vl_liquido,
	ie_tipo_desconto,
	coalesce(ie_pacote,'A'),
	coalesce(ie_valor_inf,'A')
into STRICT	nr_interno_conta_w,
	pr_desconto_w,
	vl_desconto_w,
	vl_liquido_w,
	ie_tipo_desconto_w,
	ie_pacote_w,
	ie_valor_inf_w
from 	conta_paciente_desconto
where 	nr_sequencia = nr_sequencia_p;

select	max(cd_convenio_parametro)
into STRICT	cd_convenio_w
from	conta_paciente
where 	nr_interno_conta	= nr_interno_conta_w;


select 	count(*)
into STRICT 	ie_ok_w
from 	conta_paciente_v
where 	nr_interno_conta = nr_interno_conta_w
and	coalesce(cd_motivo_exc_conta::text, '') = ''
and 	somente_numero(coalesce(ie_emite_conta_honor, ie_emite_conta)) = 0;

if (ie_ok_w > 0) then
	ds_mensagem_w	:= '';
	open C02;
	loop
	fetch C02 into
		ds_item_w,
		ie_proc_mat_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		ds_mensagem_w	:= ds_mensagem_w ||Chr(13)||ds_item_w;
		end;
	end loop;
	close C02;

	--Existem itens sem estrutura. Geração cancelada !'||ds_mensagem_w
	CALL wheb_mensagem_pck.exibir_mensagem_abort(258045,'DS_MENSAGEM=' || ds_mensagem_w);
end if;

vl_total_estrut_w := 0;
vl_total_desc_w	:= 0;

open C01;
loop
	fetch C01 into	cd_estrutura_w,
			vl_estrutura_w,
			cd_setor_atendimento_w,
			cd_item_w,
			ie_origem_proced_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */

	select nextval('conta_paciente_desc_item_seq')
	into STRICT nr_sequencia_w
	;

	vl_desc_estrut_w  := (vl_estrutura_w / 100) * pr_desconto_w;
	vl_liq_estrut_w   := vl_estrutura_w - vl_desc_estrut_w;

	vl_total_estrut_w := vl_total_estrut_w + vl_liq_estrut_w;
	vl_total_desc_w   := vl_total_desc_w + vl_desc_estrut_w;

	select	coalesce(max(IE_CALCULA_DESCONTO), 'S')
	into STRICT	IE_CALCULA_w
	from	CONVENIO_REGRA_DESC_ESTRUT
	where	cd_convenio		= cd_convenio_w
	and	cd_estrutura		= cd_estrutura_w;

	if (cd_item_w <> 0) then
		insert into conta_paciente_desc_item(nr_sequencia,
			nr_seq_desconto,
			cd_estrutura,
			dt_atualizacao,
			nm_usuario,
			vl_conta,
			ie_calcula,
			pr_desconto,
			vl_desconto,
			vl_liquido,
			cd_setor_atendimento,
			cd_medico,
			ie_desc_material,
			cd_material,
			cd_procedimento,
			ie_origem_proced)
		values (nr_sequencia_w,
			nr_sequencia_p,
			cd_estrutura_w,
			clock_timestamp(),
			nm_usuario_p,
			vl_estrutura_w,
			IE_CALCULA_w,
			pr_desconto_w,
			vl_desc_estrut_w,
			vl_liq_estrut_w,
			CASE WHEN cd_setor_atendimento_w=0 THEN  null  ELSE cd_setor_atendimento_w END , null, 'S',
			CASE WHEN ie_origem_proced_w=0 THEN  cd_item_w  ELSE null END ,
			CASE WHEN ie_origem_proced_w=0 THEN  null  ELSE cd_item_w END ,
			CASE WHEN ie_origem_proced_w=0 THEN  null  ELSE ie_origem_proced_w END );
	else
		insert into conta_paciente_desc_item(nr_sequencia,
			nr_seq_desconto,
			cd_estrutura,
			dt_atualizacao,
			nm_usuario,
			vl_conta,
			ie_calcula,
			pr_desconto,
			vl_desconto,
			vl_liquido,
			cd_setor_atendimento,
			cd_medico,
			ie_desc_material)
		values (nr_sequencia_w,
			nr_sequencia_p,
			cd_estrutura_w,
			clock_timestamp(),
			nm_usuario_p,
			vl_estrutura_w,
			IE_CALCULA_w,
			pr_desconto_w,
			vl_desc_estrut_w,
			vl_liq_estrut_w,
			CASE WHEN cd_setor_atendimento_w=0 THEN  null  ELSE cd_setor_atendimento_w END , null, 'S');
	end if;
end loop;
close C01;

if (vl_total_estrut_w <> vl_liquido_w) or (vl_total_desc_w <> vl_desconto_w) then
	vl_desc_estrut_w := vl_desc_estrut_w + (vl_desconto_w - vl_total_desc_w);
	vl_liq_estrut_w := vl_liq_estrut_w + (vl_liquido_w - vl_total_estrut_w);

	update conta_paciente_desc_item
	set	vl_liquido  = vl_liq_estrut_w,
		vl_desconto = vl_desc_estrut_w
	where nr_sequencia = nr_sequencia_w;
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_conpaci_desc_item (nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

