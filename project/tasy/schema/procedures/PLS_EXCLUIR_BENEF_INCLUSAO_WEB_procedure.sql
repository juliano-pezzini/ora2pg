-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_excluir_benef_inclusao_web ( nm_benef_titular_p text, nr_seq_solicitacao_p bigint) AS $body$
DECLARE


/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:   Excluir a solicitacao de inclusao do beneficiario no lote
----------------------------------------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  ]  Objetos do dicionario [  ] Tasy (Delphi/Java) [ x ] Portal [  ] Relatorios [ ] Outros:
 ----------------------------------------------------------------------------------------------------------------------------------------------------

Pontos de atencao:  
C01 - caso o beneficiario possua dependentes, excluir os dependentes
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/		
		
nr_seq_lote_inclusao_w	pls_inclusao_beneficiario.nr_seq_lote_inclusao%type;
qt_benef_depend_w	bigint;	
nr_seq_solicitacao_w	pls_inclusao_beneficiario.nr_sequencia%type;
nm_benef_titular_w	pls_inclusao_beneficiario.nm_pessoa_fisica%type;
			
C01 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_inclusao_beneficiario
	where	nr_seq_lote_inclusao = nr_seq_lote_inclusao_w
	and	upper(nm_titular_inclusao) = upper(nm_benef_titular_w);
	

BEGIN

select	nr_seq_lote_inclusao
into STRICT	nr_seq_lote_inclusao_w
from	pls_inclusao_beneficiario
where	nr_sequencia = nr_seq_solicitacao_p;

nm_benef_titular_w	:= nm_benef_titular_p;

if (coalesce(nm_benef_titular_w::text, '') = '') then
	select	max(nm_pessoa_fisica)
	into STRICT	nm_benef_titular_w
	from	pls_inclusao_beneficiario
	where	nr_sequencia	= nr_seq_solicitacao_p;
end if;

select	count(1)
into STRICT	qt_benef_depend_w
from	pls_inclusao_beneficiario
where	nr_seq_lote_inclusao = nr_seq_lote_inclusao_w
and	upper(nm_titular_inclusao) = upper(nm_benef_titular_w);

if (qt_benef_depend_w > 0 ) then
	
	open C01;
	loop
	fetch C01 into
		nr_seq_solicitacao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		
		delete from pls_homonimo_pessoa_fisica
		where	nr_seq_inclusao_benef = nr_seq_solicitacao_w;
		
		delete from	pls_inclusao_anexo
		where	nr_seq_inclusao = nr_seq_solicitacao_w;
		
		delete from  pls_inconsist_incl_benef
		where	nr_seq_solic_inclusao = nr_seq_solicitacao_w;
		
		delete from 	pls_inclusao_beneficiario
		where	nr_sequencia = nr_seq_solicitacao_w;		
		
		end;
	end loop;
	close C01;
end if;	

delete from pls_homonimo_pessoa_fisica
where	nr_seq_inclusao_benef = nr_seq_solicitacao_p;
	
delete 	from    pls_inclusao_anexo
where 	nr_seq_inclusao = nr_seq_solicitacao_p;

delete from  pls_inconsist_incl_benef
where	nr_seq_solic_inclusao = nr_seq_solicitacao_p;
	
delete from 	pls_inclusao_beneficiario
where	nr_sequencia = nr_seq_solicitacao_p;		
			
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_excluir_benef_inclusao_web ( nm_benef_titular_p text, nr_seq_solicitacao_p bigint) FROM PUBLIC;

