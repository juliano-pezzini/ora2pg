-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_agenda_proced_kit ( nr_seq_agenda_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE

 
ie_ordem_w		   varchar(1);
cd_procedimento_w	  bigint;
ie_origem_proced_w	bigint;
cd_kit_material_w		integer;
nr_sequencia_w			bigint;
nr_seq_kit_w			bigint;	
ie_gerado_w			  varchar(1) := 'N';
ds_erro_w			  varchar(255);
ds_erro_ww			  varchar(255);
ie_commit_w			  varchar(1) := 'N';
ie_estab_agenda_w	  varchar(1);	
cd_estabelecimento_w	smallint;
qt_idade_w			  varchar(255);
				
C01 CURSOR FOR 
	SELECT 	1 ie_ordem, 
		a.cd_procedimento, 
		a.ie_origem_proced, 
		b.cd_kit_material 
	from  	kit_material k, 
		procedimento b, 
		agenda_paciente a 
	where  	a.cd_procedimento  = b.cd_procedimento 
	and   	a.ie_origem_proced  = b.ie_origem_proced 
	and   	a.nr_sequencia	   = nr_seq_agenda_p 
	and   	b.cd_kit_material  = k.cd_kit_material 
	and   	k.ie_situacao    = 'A' 
	and   	coalesce(a.nr_seq_proc_interno::text, '') = '' 
	
union
 
	SELECT 	2 ie_ordem, 
		a.cd_procedimento, 
		a.ie_origem_proced, 
		b.cd_kit_material 
	from   	kit_material k, 
		procedimento b, 
		agenda_paciente_proc a 
	where  	a.cd_procedimento  = b.cd_procedimento 
	and   	a.ie_origem_proced  = b.ie_origem_proced 
	and   	a.nr_sequencia	   = nr_seq_agenda_p 
	and   	b.cd_kit_material  = k.cd_kit_material 
	and   	k.ie_situacao    = 'A' 
	and   	coalesce(a.nr_seq_proc_interno::text, '') = '' 
	
union
 
	select 	1 ie_ordem, 
		a.cd_procedimento, 
		a.ie_origem_proced, 
		b.cd_kit_material 
	from   	kit_material k, 
		proc_interno b, 
		agenda_paciente a 
	where  	a.nr_seq_proc_interno= b.nr_sequencia 
	and   	a.nr_sequencia	   = nr_seq_agenda_p 
	and   	b.cd_kit_material  = k.cd_kit_material 
	and   	k.ie_situacao    = 'A' 
	
union
 
	select 	2 ie_ordem, 
		a.cd_procedimento, 
		a.ie_origem_proced, 
		b.cd_kit_material 
	from   	kit_material k, 
		proc_interno b, 
		agenda_paciente_proc a 
	where  	a.nr_seq_proc_interno= b.nr_sequencia 
	and   	a.nr_sequencia	   = nr_seq_agenda_p 
	and   	b.cd_kit_material  = k.cd_kit_material 
	and   	k.ie_situacao    = 'A' 
	
union
 
	select 	1 ie_ordem, 
      a.cd_procedimento, 
      a.ie_origem_proced, 
      c.cd_kit_material 
	from   kit_material k, 
      proc_interno b, 
      proc_interno_kit c, 
      agenda_paciente a 
	where  a.nr_seq_proc_interno= b.nr_sequencia 
	and   c.nr_seq_proc_interno= b.nr_sequencia 
	and   a.nr_sequencia	   = nr_seq_agenda_p 
	and   ((c.cd_medico    = a.cd_medico) or (coalesce(c.cd_medico::text, '') = '') or (coalesce(a.cd_medico::text, '') = '')) 
	and   c.cd_kit_material  = k.cd_kit_material 
	and   k.ie_situacao    = 'A' 
	and	 c.cd_estabelecimento = cd_estabelecimento_w 
  and   qt_idade_w between obter_idade_kit_proced(c.nr_sequencia,'MIN') 
             and obter_idade_kit_proced(c.nr_sequencia,'MAX') 
	
union
 
	select 	2 ie_ordem, 
      a.cd_procedimento, 
      a.ie_origem_proced, 
      c.cd_kit_material 
	from   kit_material k, 
      proc_interno b, 
      proc_interno_kit c, 
      agenda_paciente_proc a 
	where  a.nr_seq_proc_interno = b.nr_sequencia 
	and   c.nr_seq_proc_interno = b.nr_sequencia 
	and   ((c.cd_medico     = a.cd_medico) or (coalesce(c.cd_medico::text, '') = '') or (coalesce(a.cd_medico::text, '') = '')) 
	and   a.nr_sequencia	   = nr_seq_agenda_p 
	and   c.cd_kit_material   = k.cd_kit_material 
	and   k.ie_situacao     = 'A' 
	and	 c.cd_estabelecimento = cd_estabelecimento_w 
  and   qt_idade_w      between obter_idade_kit_proced(c.nr_sequencia,'MIN') 
                   and obter_idade_kit_proced(c.nr_sequencia,'MAX') 
	order by 1;

	 

BEGIN 
 
cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
ie_estab_agenda_w := Obter_Param_Usuario(871, 531, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_estab_agenda_w);
 
 
if (ie_estab_agenda_w = 'S') then 
	cd_estabelecimento_w := obter_estab_agenda_paciente(nr_seq_agenda_p);
end if;	
 
begin 
select 	max(coalesce(obter_idade_pf(a.cd_pessoa_fisica, clock_timestamp(), 'DIA'),0)) 
into STRICT   qt_idade_w 
from   agenda_paciente a 
where  a.nr_sequencia = nr_seq_agenda_p;
exception 
  when others then 
  qt_idade_w := 0;
end;
 
open C01;
loop 
fetch C01 into	 
	ie_ordem_w, 
	cd_procedimento_w, 
	ie_origem_proced_w, 
	cd_kit_material_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin	 
	ds_erro_ww := null;
	if (coalesce(cd_kit_material_w,0) > 0) then 
		ds_erro_ww := consistir_pedido_kit(cd_kit_material_w, nm_usuario_p, nr_seq_agenda_p, ds_erro_ww);
	end if;	
	 
	if (coalesce(ds_erro_ww::text, '') = '') and (coalesce(cd_kit_material_w,0) > 0) and (ie_gerado_w = 'N')	then	 
		begin	 
		 
		select	nextval('agenda_pac_pedido_seq') 
		into STRICT	nr_sequencia_w 
		;
 
		insert 	into agenda_pac_pedido( 
					nr_sequencia, 
					dt_atualizacao, 
					nm_usuario, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec, 
					nr_seq_agenda, 
					dt_pedido, 
					dt_liberacao, 
					cd_pessoa_resp) 
			values (	nr_sequencia_w, 
					clock_timestamp(), 
					nm_usuario_p, 
					clock_timestamp(), 
					nm_usuario_p, 
					nr_seq_agenda_p, 
					clock_timestamp(), 
					null, 
					cd_pessoa_fisica_p );
					 
		ie_gerado_w := 'S';
		ie_commit_w := 'S';
		end;
	end if;
	 
	 
		 
	if (coalesce(ds_erro_ww::text, '') = '') then 
	 
		select	nextval('agenda_pac_pedido_kit_seq') 
		into STRICT	nr_seq_kit_w 
		;
	 
		insert 	into agenda_pac_pedido_kit( 
				nr_sequencia, 
				dt_atualizacao, 
				nm_usuario, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				nr_seq_pedido, 
				cd_kit_material, 
				cd_procedimento, 
				ie_origem_proced) 
		values (	nr_seq_kit_w, 
				clock_timestamp(), 
				nm_usuario_p, 
				clock_timestamp(), 
				nm_usuario_p, 
				nr_sequencia_w, 
				cd_kit_material_w, 
				cd_procedimento_w, 
				ie_origem_proced_w);
				 
		ie_commit_w := 'S';
	end if;
	end;
end loop;
close C01;
 
if (coalesce(cd_kit_material_w,0) = 0) then 
	ds_erro_w := wheb_mensagem_pck.get_texto(278634);
end if;
 
ds_erro_p := ds_erro_w;
 
if (ie_commit_w = 'S') then 
	commit;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_agenda_proced_kit ( nr_seq_agenda_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

