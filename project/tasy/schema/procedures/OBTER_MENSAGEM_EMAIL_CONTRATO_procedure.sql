-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_mensagem_email_contrato ( nr_seq_contrato_p bigint, nm_usuario_p text, ds_mensagem_p INOUT text ) AS $body$
DECLARE

									
nr_seq_regra_w          padrao_comunic_contrato.nr_sequencia%type;
nr_sequencia_w          tasy_conversao_rtf.nr_sequencia%type;
ds_mensagem_w           tasy_conversao_rtf.ds_texto%type;


BEGIN

select max(nr_sequencia)
into STRICT   nr_seq_regra_w
from   padrao_comunic_contrato 
where  ie_situacao = 'A';

nr_sequencia_p => nr_sequencia_w  := converte_rtf_html( ds_sql_consulta_p => 'select ds_comunicado from padrao_comunic_contrato where nr_sequencia = :nr_sequencia', ds_parametros_sql_p => nr_seq_regra_w, nm_usuario_p => nm_usuario_p, nr_sequencia_p => nr_sequencia_w );

begin
select ds_texto
into STRICT   ds_mensagem_w
from   tasy_conversao_rtf
where  nr_sequencia = nr_sequencia_w;
exception
when no_data_found or too_many_rows then
	ds_mensagem_w := null;
end;

if (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') then
	
	ds_mensagem_w := replace_macro(ds_mensagem_w,'@contrato',nr_seq_contrato_p);
	ds_mensagem_w := replace_macro(ds_mensagem_w,'@contratado',substr(obter_dados_contrato(nr_seq_contrato_p, 'DS'),1,255));
	ds_mensagem_w := replace_macro(ds_mensagem_w,'@tipo_contrato',substr(obter_dados_contrato(nr_seq_contrato_p, 'DTC'),1,255));
	ds_mensagem_w := replace_macro(ds_mensagem_w,'@objeto_contrato',substr(obter_dados_contrato(nr_seq_contrato_p, 'DO'),1,255));
	
	ds_mensagem_p := ds_mensagem_w;

end if;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_mensagem_email_contrato ( nr_seq_contrato_p bigint, nm_usuario_p text, ds_mensagem_p INOUT text ) FROM PUBLIC;

