-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_regra_horario_plano ( nr_atendimento_p bigint, cd_convenio_p bigint, cd_plano_p text, cd_setor_atendimento_p bigint, ds_erro_p INOUT text, cd_empresa_p bigint) AS $body$
DECLARE

 
ie_tipo_atendimento_w		smallint;
dt_entrada_w			timestamp;
ie_atende_w			varchar(1);
ie_ver_atende_w			varchar(1) := 'S';
cd_setor_atendimento_w		integer;
ie_dia_semana_w			varchar(3);
ie_dia_semana_entrada_w		varchar(3);
cd_medico_resp_w		varchar(10);
dt_entrada_ww			timestamp;

cd_estabelecimento_w		smallint;
ie_feriado_w			varchar(1)		:= 'N';
qt_dia_feriado_w		smallint		:= 0;

C01 CURSOR FOR 
	SELECT	ie_atende 
	from	regra_horario_plano 
	where	cd_convenio	= cd_convenio_p 
	and	cd_plano	= cd_plano_p 
	and	coalesce(ie_tipo_atendimento,ie_tipo_atendimento_w)		= ie_tipo_atendimento_w 
	and	coalesce(cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w 
	and	coalesce(cd_pessoa_fisica, cd_medico_resp_w)			= cd_medico_resp_w 
	and	((coalesce(upper(ie_feriado),'N') = 'N') or (upper(ie_feriado) = ie_feriado_w)) 
	and	((coalesce(ie_dia_semana, ie_dia_semana_entrada_w) 		= ie_dia_semana_entrada_w) or 
		 (ie_dia_semana = '9' AND ie_dia_semana_entrada_w between 2 and 6)) 
	and	dt_entrada_w between 	to_date('01/01/2000 '||to_char(hr_inicio,'hh24:mi')||':00','dd/mm/yyyy hh24:mi:ss') and 
					to_date('01/01/2000 '||to_char(hr_fim,'hh24:mi')||':00','dd/mm/yyyy hh24:mi:ss') 
	and	coalesce(cd_empresa,coalesce(cd_empresa_p,0))			= coalesce(cd_empresa_p,0) 
	and	coalesce(cd_estabelecimento,coalesce(cd_estabelecimento_w,1))	= coalesce(cd_estabelecimento_w,1) 
	order by ie_atende;

 
 

BEGIN 
 
begin 
select	ie_tipo_atendimento, 
	to_date('01/01/2000 '||to_char(dt_entrada,'hh24:mi')||':00','dd/mm/yyyy hh24:mi:ss'), 
	coalesce(cd_setor_atendimento_p,coalesce(obter_setor_atendimento(nr_atendimento),0)), 
	cd_medico_resp, 
	dt_entrada, 
	cd_estabelecimento 
into STRICT	ie_tipo_atendimento_w, 
	dt_entrada_w, 
	cd_setor_atendimento_w, 
	cd_medico_resp_w, 
	dt_entrada_ww, 
	cd_estabelecimento_w 
from	atendimento_paciente 
where	nr_atendimento = nr_atendimento_p;
exception 
when no_data_found then 
	ie_tipo_atendimento_w	:= 0;
	dt_entrada_w		:= clock_timestamp();
	cd_setor_atendimento_w	:= 0;
	cd_estabelecimento_w	:= 1;
end;
 
/* Verifica se Ã© Feriado */
 
select 	count(*) 
into STRICT 	qt_dia_feriado_w 
from 	feriado 
where 	cd_estabelecimento = coalesce(cd_estabelecimento_w, cd_estabelecimento) 
and	to_char(dt_feriado,'dd/mm/yyyy') = to_char(dt_entrada_ww,'dd/mm/yyyy');
 
if (qt_dia_feriado_w > 0) then 
	ie_feriado_w:= 'S';
else 
	ie_feriado_w:= 'N';
end if;
 
select	pkg_date_utils.get_WeekDay(dt_entrada_ww) 
into STRICT	ie_dia_semana_entrada_w
;
 
open C01;
loop 
	fetch C01 into 
		ie_atende_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	ie_ver_atende_w	:= 'N';
	end;
end loop;
close C01;
 
if (ie_ver_atende_w = 'N') then 
	ds_erro_p	:= wheb_mensagem_pck.get_texto(279989);
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_regra_horario_plano ( nr_atendimento_p bigint, cd_convenio_p bigint, cd_plano_p text, cd_setor_atendimento_p bigint, ds_erro_p INOUT text, cd_empresa_p bigint) FROM PUBLIC;

