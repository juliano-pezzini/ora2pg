-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_dados_agend_serv ( nr_atendimento_p bigint, nr_seq_agenda_p bigint, nr_seq_pac_reab_p bigint, ie_tipo_grupo_p text, cd_agenda_chamada_externa_p bigint, cd_pf_chamada_pls text, cd_pessoa_fisica_p text, nr_seq_entrega_p bigint, nr_seq_paciente_pmc_p bigint, dt_agenda_p timestamp, dt_final_p timestamp, cd_procedimento_p bigint, ie_evento_p text, nr_seq_proc_interno_p bigint, nm_usuario_p text, ds_msg_consist_agenda_p INOUT text, ds_msg_p INOUT text) AS $body$
DECLARE

 
ie_tipo_atendimento_w	smallint;


BEGIN 
 
select	obter_tipo_atendimento(nr_atendimento_p) 
into STRICT	ie_tipo_atendimento_w
;
 
if ((ie_tipo_atendimento_w IS NOT NULL AND ie_tipo_atendimento_w::text <> '') and 
	ie_tipo_atendimento_w <> 1) then 
	ds_msg_p := consistir_sessao_agenda(nr_seq_agenda_p, ds_msg_p);
end if;
 
if ((cd_agenda_chamada_externa_p IS NOT NULL AND cd_agenda_chamada_externa_p::text <> '') and 
	cd_agenda_chamada_externa_p <> 0 and 
	cd_pf_chamada_pls = cd_pessoa_fisica_p) then 
	begin 
	if ((nr_seq_pac_reab_p IS NOT NULL AND nr_seq_pac_reab_p::text <> '') and 
		nr_seq_pac_reab_p <> 0 and 
		(ie_tipo_grupo_p IS NOT NULL AND ie_tipo_grupo_p::text <> '')) then 
		begin 
		CALL rp_gravar_agendamento_ga_go( 
			nr_seq_agenda_p, 
			nr_seq_pac_reab_p, 
			ie_tipo_grupo_p, 
			nm_usuario_p);
		end;
	elsif ((nr_seq_entrega_p IS NOT NULL AND nr_seq_entrega_p::text <> '') and 
		nr_seq_entrega_p <> 0) then 
		begin 
		if (dt_agenda_p <= dt_final_p) then 
			CALL fa_gravar_agendamento(nr_seq_agenda_p, nr_seq_entrega_p);
		else 
			ds_msg_p	:= substr(obter_texto_tasy(47133, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		end if;
		end;
	elsif ((nr_seq_paciente_pmc_p IS NOT NULL AND nr_seq_paciente_pmc_p::text <> '') and 
		nr_seq_paciente_pmc_p <> 0) then 
		begin 
		CALL fa_gravar_agendamento_pmc(nr_seq_agenda_p,nr_seq_paciente_pmc_p);
		end;
	end if;
	end;
end if;
 
if (cd_procedimento_p IS NOT NULL AND cd_procedimento_p::text <> '') then 
	begin 
	CALL gerar_autor_regra( 
		null, 
		null, 
		null, 
		null, 
		null, 
		null, 
		ie_evento_p, 
		nm_usuario_p, 
		null, 
		nr_seq_proc_interno_p, 
		null, 
		nr_seq_agenda_p, 
		null, 
		null, 
		'', 
		'', 
		'');
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_dados_agend_serv ( nr_atendimento_p bigint, nr_seq_agenda_p bigint, nr_seq_pac_reab_p bigint, ie_tipo_grupo_p text, cd_agenda_chamada_externa_p bigint, cd_pf_chamada_pls text, cd_pessoa_fisica_p text, nr_seq_entrega_p bigint, nr_seq_paciente_pmc_p bigint, dt_agenda_p timestamp, dt_final_p timestamp, cd_procedimento_p bigint, ie_evento_p text, nr_seq_proc_interno_p bigint, nm_usuario_p text, ds_msg_consist_agenda_p INOUT text, ds_msg_p INOUT text) FROM PUBLIC;

