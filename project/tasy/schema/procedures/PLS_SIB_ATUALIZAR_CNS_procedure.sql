-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_sib_atualizar_cns ( nr_seq_lote_conf_p bigint, ie_benef_filtro_p text, nm_usuario_p text) AS $body$
DECLARE


C01 CURSOR(	nr_seq_lote_conf_pc	pls_sib_conferencia_lote.nr_sequencia%type) FOR
	SELECT	b.cd_pessoa_fisica,
		a.cd_cns,
		c.nr_cartao_nac_sus,
		a.nr_seq_segurado
	from	pls_sib_conferencia a,
		pls_segurado b,
		pessoa_fisica c
	where	b.nr_sequencia	= a.nr_seq_segurado
	and	c.cd_pessoa_fisica = b.cd_pessoa_fisica
	and	a.nr_seq_lote	= nr_seq_lote_conf_pc
	and	(a.cd_cns IS NOT NULL AND a.cd_cns::text <> '')
	and	ie_benef_filtro_p = 'N'
	
union all

	SELECT	b.cd_pessoa_fisica,
		a.cd_cns,
		c.nr_cartao_nac_sus,
		a.nr_seq_segurado
	from	pls_sib_conferencia a,
		pls_segurado b,
		pessoa_fisica c
	where	b.nr_sequencia	= a.nr_seq_segurado
	and	c.cd_pessoa_fisica = b.cd_pessoa_fisica
	and	a.nr_seq_lote	= nr_seq_lote_conf_pc
	and	(a.cd_cns IS NOT NULL AND a.cd_cns::text <> '')
	and	ie_benef_filtro_p = 'S'
	and	(a.nr_ordem IS NOT NULL AND a.nr_ordem::text <> '');

BEGIN
CALL wheb_usuario_pck.set_ie_executar_trigger('N');

CALL gravar_processo_longo('Gravação do cartão SUS dos beneficiários' ,'PLS_SIB_ATUALIZAR_CNS',0);

begin
for r_c01_w in C01(nr_seq_lote_conf_p) loop
	begin
	CALL gravar_processo_longo('Gravação do cartão SUS dos beneficiários','PLS_SIB_ATUALIZAR_CNS',-1);

	if (r_c01_w.cd_cns <> r_c01_w.nr_cartao_nac_sus) or (coalesce(r_c01_w.nr_cartao_nac_sus::text, '') = '') then

		update	pessoa_fisica
		set	nr_cartao_nac_sus	= r_c01_w.cd_cns,
			nm_usuario		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp()
		where	cd_pessoa_fisica	= r_c01_w.cd_pessoa_fisica;

		update	pls_sib_segurado
		set	nr_cns	= r_c01_w.cd_cns
		where	nr_seq_segurado = r_c01_w.nr_seq_segurado;

		CALL pls_gerar_segurado_historico(	r_c01_w.nr_seq_segurado, '64', clock_timestamp(), 'Alteração do cartão SUS do beneficiário de: '|| r_c01_w.nr_cartao_nac_sus ||' para: '||r_c01_w.cd_cns,
				'pls_sib_atualizar_cns', null, null, null,
				null, null, null, null,
				null, null, null, null,
				nm_usuario_p, 'N');
	end if;

	end;
end loop; --C01
exception
when others then
CALL wheb_usuario_pck.set_ie_executar_trigger('S');
CALL wheb_mensagem_pck.exibir_mensagem_abort(215669,'DS_ERRO='||sqlerrm(SQLSTATE));
end;

CALL wheb_usuario_pck.set_ie_executar_trigger('S');

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_sib_atualizar_cns ( nr_seq_lote_conf_p bigint, ie_benef_filtro_p text, nm_usuario_p text) FROM PUBLIC;

