-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_reap_atualizar_desp (nr_seq_conta_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_reap_desp_w		bigint;
nr_seq_material_w		bigint;
cd_convenio_w			bigint;
cd_estabelecimento_w		bigint;
cd_categoria_w			bigint;
ie_tipo_atendimento_w		bigint;
cd_material_w			bigint;
cd_tab_preco_material_w		bigint;
cd_setor_atendimento_w		bigint;
dt_conta_w			timestamp;
cd_grupo_material_w		bigint;
cd_subgrupo_material_w		bigint;
cd_classe_material_w		bigint;
nr_seq_tiss_tabela_w		bigint;
ie_codigo_material_w		varchar(10);
cd_material_brasindice_w	varchar(255);
cd_laboratorio_w		varchar(255);
cd_medicamento_w		varchar(255);
cd_apresentacao_w		varchar(255);
cd_material_tiss_w		varchar(255);
ie_cod_tiss_brasindice_w	varchar(255);
ie_origem_preco_w		varchar(255);
cd_tabela_xml_w			varchar(255);
ie_conversao_externa_w		varchar(255);
cd_material_convenio_w		varchar(255);
vl_unitario_mat_w		double precision := 0;
ie_tipo_material_w		varchar(3);
nr_seq_lote_fornec_w		material_lote_fornec.nr_sequencia%type;
nr_seq_marca_w 			material_lote_fornec.nr_seq_marca%type;


c01 CURSOR FOR
SELECT	nr_sequencia,
	nr_seq_material
from	tiss_reap_desp
where	nr_seq_conta	= nr_seq_conta_p
and	(nr_seq_material IS NOT NULL AND nr_seq_material::text <> '');

c02 CURSOR FOR
SELECT	a.nr_seq_tiss_tabela,
	coalesce(a.ie_cod_material, 'T'),
	coalesce(a.ie_conversao_externa,'S')
from 	tiss_regra_tabela_mat a
where	a.cd_estabelecimento						= cd_estabelecimento_w
and	a.cd_convenio							= cd_convenio_w
and	coalesce(a.cd_categoria, cd_categoria_w)				= cd_categoria_w
and 	coalesce(a.ie_tipo_atendimento,ie_tipo_atendimento_w) 		= ie_tipo_atendimento_w
and	coalesce(a.cd_material, cd_material_w)				= cd_material_w
and	coalesce(a.cd_grupo_material, cd_grupo_material_w)			= cd_grupo_material_w
and	coalesce(a.cd_subgrupo_material, cd_subgrupo_material_w)		= cd_subgrupo_material_w
and	coalesce(a.cd_classe_material, cd_classe_material_w)			= cd_classe_material_w
and	coalesce(dt_conta_w, clock_timestamp()) between trunc(a.dt_inicio_vigencia, 'dd') and trunc(coalesce(a.dt_final_vigencia,coalesce(dt_conta_w, clock_timestamp()) +1)) + 89399/89400
and	coalesce(a.ie_situacao,'A') 						= 'A'
and	((coalesce(cd_tab_preco_material, coalesce(cd_tab_preco_material_w,'00'))	= coalesce(cd_tab_preco_material_w,'00')) or
	 ((cd_tab_preco_material_w = '00') and (coalesce(cd_tab_preco_material::text, '') = '')))
and 	coalesce(a.cd_setor_atendimento, cd_setor_atendimento_w)		= cd_setor_atendimento_w
and	((coalesce(vl_unitario_mat_w,0) >= coalesce(a.vl_inicial,0)) and (coalesce(vl_unitario_mat_w,0) <= coalesce(a.vl_final,999999999)))
and 	coalesce(a.ie_tipo_material, coalesce(ie_tipo_material_w,'0')) = coalesce(ie_tipo_material_w, '0')
order	by ie_prioridade desc,
	coalesce(ie_tipo_atendimento,0),
	coalesce(cd_material, 0),
	coalesce(cd_classe_material, 0),
	coalesce(cd_subgrupo_material, 0),
	coalesce(cd_grupo_material, 0),
	coalesce(a.cd_setor_atendimento, 0),
	a.dt_inicio_vigencia,
	coalesce(a.ie_tipo_material,'0');


BEGIN

select	b.cd_convenio_parametro,
	b.cd_estabelecimento,
	b.cd_categoria_parametro,
	c.ie_tipo_atendimento
into STRICT	cd_convenio_w,
	cd_estabelecimento_w,
	cd_categoria_w,
	ie_tipo_atendimento_w
from	atendimento_paciente c,
	conta_paciente b,
	tiss_reap_conta a
where	a.nr_interno_conta	= b.nr_interno_conta
and	b.nr_atendimento	= c.nr_atendimento
and	a.nr_sequencia		= nr_seq_conta_p;

select	coalesce(max(ie_cod_tiss_brasindice),'N')
into STRICT	ie_cod_tiss_brasindice_w
from	tiss_parametros_convenio
where	cd_convenio		= cd_convenio_w
and	cd_estabelecimento	= cd_estabelecimento_w;

open C01;
loop
fetch C01 into
	nr_seq_reap_desp_w,
	nr_seq_material_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	max(cd_material),
		max(cd_tab_preco_material),
		max(cd_setor_atendimento),
		max(dt_conta),
		max(ie_origem_preco),
		max(cd_material_convenio),
		coalesce(max(vl_unitario),0),
		max(nr_seq_lote_fornec)
	into STRICT	cd_material_w,
		cd_tab_preco_material_w,
		cd_setor_atendimento_w,
		dt_conta_w,
		ie_origem_preco_w,
		cd_material_convenio_w,
		vl_unitario_mat_w,
		nr_seq_lote_fornec_w
	from	material_atend_paciente
	where	nr_sequencia	= nr_seq_material_w;

	select 	max(b.cd_grupo_material),
		max(b.cd_subgrupo_material),
		max(b.cd_classe_material),
		coalesce(max(a.ie_tipo_material),'0')
	into STRICT	cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w,
		ie_tipo_material_w
	from	estrutura_material_v b,
		material a
	where 	a.cd_material		= b.cd_material
	and	a.cd_material		= cd_material_w;

	nr_seq_marca_w := 0;
	if (coalesce(nr_seq_lote_fornec_w,0) > 0) then
		select	max(coalesce(nr_seq_marca,0))
		into STRICT	nr_seq_marca_w
		from	material_lote_fornec
		where	nr_sequencia = nr_seq_lote_fornec_w;
	end if;

	open C02;
	loop
	fetch C02 into
		nr_seq_tiss_tabela_w,
		ie_codigo_material_w,
		ie_conversao_externa_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		nr_seq_tiss_tabela_w 	:= nr_seq_tiss_tabela_w;
		ie_codigo_material_w	:= ie_codigo_material_w;
		ie_conversao_externa_w	:= ie_conversao_externa_w;
	end loop;
	close C02;

	cd_material_tiss_w	:= null;

	if (ie_conversao_externa_w in ('S','C')) then
		if (cd_material_convenio_w <> to_char(cd_material_w)) then
			cd_material_tiss_w := cd_material_convenio_w;
		end if;
	end if;

	if (coalesce(cd_material_tiss_w::text, '') = '') then
		if (coalesce(ie_codigo_material_w, 'O') = 'O') then	-- se não tiver regra deve pegar o código da origem do valor
			if (ie_origem_preco_w	= 1) then
				cd_material_brasindice_w		:= obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_conta_w,cd_convenio_w, nr_seq_marca_w);
				cd_laboratorio_w			:= substr(cd_material_brasindice_w,1,3);
				cd_medicamento_w			:= substr(cd_material_brasindice_w,5,5);
				cd_apresentacao_w			:= substr(cd_material_brasindice_w,11,4);
				if (ie_cod_tiss_brasindice_w = 'N') then
					cd_material_tiss_w		:= tiss_obter_cod_brasindice(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w);
				elsif (ie_cod_tiss_brasindice_w = 'B') then
					cd_material_tiss_w		:= replace(obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_conta_w,cd_convenio_w, nr_seq_marca_w), ';','');
				end if;
				if (coalesce(cd_material_tiss_w,'0') = '0') then
					cd_material_tiss_w		:= replace(cd_medicamento_w,';','');
				end if;
			elsif (ie_origem_preco_w = 4) then
				select	max(TISS_OBTER_CODIGO_SIMPRO(cd_material_w, cd_estabelecimento_w, cd_convenio_w, dt_conta_w))
				into STRICT	cd_material_tiss_w
				;
			end if;
		elsif (ie_codigo_material_w = 'T') then

			select	max(cd_tabela_xml)
			into STRICT	cd_tabela_xml_w
			from	tiss_tipo_tabela
			where	nr_sequencia	= nr_seq_tiss_tabela_w;

			if (cd_tabela_xml_w = '05') then
				cd_material_brasindice_w		:= obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_conta_w,cd_convenio_w, nr_seq_marca_w);
				cd_laboratorio_w			:= substr(cd_material_brasindice_w,1,3);
				cd_medicamento_w			:= substr(cd_material_brasindice_w,5,5);
				cd_apresentacao_w			:= substr(cd_material_brasindice_w,11,4);

				if (ie_cod_tiss_brasindice_w = 'N') then
					cd_material_tiss_w		:= tiss_obter_cod_brasindice(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w);
				elsif (ie_cod_tiss_brasindice_w = 'B') then
					cd_material_tiss_w		:= replace(obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_conta_w,cd_convenio_w, nr_seq_marca_w),';','');
				end if;

				if (coalesce(cd_material_tiss_w, '0') = '0') then
					cd_material_tiss_w		:= replace(cd_medicamento_w, ';','');
				end if;
			elsif (cd_tabela_xml_w = '12') then
				select	max(TISS_OBTER_CODIGO_SIMPRO(cd_material_w, cd_estabelecimento_w, cd_convenio_w, dt_conta_w))
				into STRICT	cd_material_tiss_w
				;
			end if;

		elsif (ie_codigo_material_w = 'E') then /*lhalves OS214336 em 10/05/2010 - Gerar código EAN no brasindice(apenas 10 primeiros dígitos)*/
			select	max(cd_tabela_xml)
			into STRICT	cd_tabela_xml_w
			from	tiss_tipo_tabela
			where	nr_sequencia	= nr_seq_tiss_tabela_w;

			if (cd_tabela_xml_w = '05') then
				cd_material_brasindice_w		:= obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_conta_w,cd_convenio_w, nr_seq_marca_w);
				cd_laboratorio_w			:= substr(cd_material_brasindice_w,1,3);
				cd_medicamento_w			:= substr(cd_material_brasindice_w,5,5);
				cd_apresentacao_w			:= substr(cd_material_brasindice_w,11,4);

				if (ie_cod_tiss_brasindice_w = 'N') then
					cd_material_tiss_w		:= substr(obter_ean_brasindice(cd_apresentacao_w, cd_laboratorio_w, cd_medicamento_w),1,10);
				elsif (ie_cod_tiss_brasindice_w = 'B') then
					cd_material_tiss_w		:= replace(obter_codigo_brasindice(cd_estabelecimento_w, cd_material_w, dt_conta_w,cd_convenio_w, nr_seq_marca_w),';','');
				end if;

				if (coalesce(cd_material_tiss_w, '0') = '0') then
					cd_material_tiss_w		:= replace(cd_medicamento_w, ';','');
				end if;
			elsif (cd_tabela_xml_w = '12') then
				select	max(TISS_OBTER_CODIGO_SIMPRO(cd_material_w, cd_estabelecimento_w, cd_convenio_w, dt_conta_w))
				into STRICT	cd_material_tiss_w
				;
			end if;
		end if;
	end if;

	if (cd_material_tiss_w IS NOT NULL AND cd_material_tiss_w::text <> '') then

		update	tiss_reap_desp
		set	cd_mat_convenio	= cd_material_tiss_w,
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp()
		where	nr_sequencia	= nr_seq_reap_desp_w;
	end if;

	end;
end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_reap_atualizar_desp (nr_seq_conta_p bigint, nm_usuario_p text) FROM PUBLIC;

