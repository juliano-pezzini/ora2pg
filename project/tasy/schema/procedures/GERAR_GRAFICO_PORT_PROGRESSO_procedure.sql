-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_grafico_port_progresso (nr_seq_port_p bigint, nm_usuario_p text) AS $body$
DECLARE


dt_ref_w		timestamp;
pr_prev_w		double precision;
pr_real_w		double precision;
qt_hora_real_w		double precision;
qt_hora_prev_w		double precision;
pr_agregado_w		double precision;
dt_controle_w  		timestamp;
pr_realizacao_w		double precision;
dt_fim_real_w 		timestamp;
dt_inicio_proj_w 	timestamp := Retorna_Data_Inicio_Fim_Port(nr_seq_port_p, 'I');
dt_final_proj_w  	timestamp := Retorna_Data_Inicio_Fim_Port(nr_seq_port_p, 'F');
dt_inicio_proj_futuro_w		timestamp;
qt_horas_total_proj_w		double precision;

C01 CURSOR FOR

	SELECT distinct last_day(trunc(dt_referencia,'MONTH'))
	from    (WITH RECURSIVE cte AS (

	SELECT		TRUNC((pkg_date_utils.start_of(dt_inicio_proj_w, 'MONTH')) + (LEVEL - 1)) AS dt_referencia
	
	((pkg_date_utils.start_of(dt_inicio_proj_w, 'MONTH')) + (LEVEL - 1)) < pkg_date_utils.end_of(dt_inicio_proj_futuro_w, 'MONTH')  UNION ALL

	SELECT		TRUNC((pkg_date_utils.start_of(dt_inicio_proj_w, 'MONTH')) + (LEVEL - 1)) AS dt_referencia
	
	((pkg_date_utils.start_of(dt_inicio_proj_w, 'MONTH')) + (LEVEL - 1)) < pkg_date_utils.end_of(dt_inicio_proj_futuro_w, 'MONTH') JOIN cte c ON ()

) SELECT * FROM cte;
) alias11
	where 	dt_referencia between  dt_inicio_proj_w and dt_controle_w;

C02 CURSOR FOR
	SELECT  obter_pr_prev_etapa_port(nr_seq_port_p ,dt_ref_w) pr_prev,
		obter_pr_agregado_etapa_port(nr_seq_port_p, dt_ref_w) pr_agregado
	;


BEGIN

delete from W_GRAFICO_Port where nr_seq_port = nr_seq_port_p;
commit;


select 	sum(QT_TOTAL_HORAS)
into STRICT	qt_horas_total_proj_w
from 	proj_portifolio pf,
	proj_programa pr,
	proj_projeto p,
	proj_cronograma c
where 	pf.nr_sequencia = pr.nr_seq_portifolio
and	pr.nr_sequencia	= p.nr_seq_programa
and	p.nr_sequencia = c.nr_seq_proj
and	pf.nr_sequencia = nr_seq_port_p
and 	c.ie_situacao = 'A'
and 	(c.dt_aprovacao IS NOT NULL AND c.dt_aprovacao::text <> '');

select  max(p.pr_realizacao),
	max(c.dt_fim_real)
into STRICT 	pr_realizacao_w,
	dt_fim_real_w
from    proj_portifolio pf,
	proj_programa pr,
	proj_projeto p,
	proj_cronograma c,
	proj_cron_etapa e
where	pf.nr_sequencia = pr.nr_seq_portifolio
and	pr.nr_sequencia = p.nr_seq_programa
and	p.nr_sequencia = c.nr_seq_proj
and     c.nr_sequencia = e.nr_seq_cronograma
and     c.ie_situacao  = 'A'
and 	pf.nr_sequencia = nr_seq_port_p
and	p.pr_realizacao >= 100
and  	not exists (SELECT 1 from proj_cron_etapa xx where xx.nr_seq_superior =  e.nr_sequencia);

if (dt_final_proj_w  >= trunc(clock_timestamp()))then
	dt_controle_w := dt_final_proj_w;
elsif (pr_realizacao_w >= 100 and dt_fim_real_w >= dt_final_proj_w)then
	dt_controle_w := dt_fim_real_w;
elsif (pr_realizacao_w >= 100 and dt_fim_real_w < dt_final_proj_w)then /*Se o projeto acabou antes do prazo previsto*/
	dt_controle_w := dt_final_proj_w;
else
	dt_controle_w := trunc(clock_timestamp());
end if;


/*Caso o projeto tenha fim previsto para o "futuro"*/

if (dt_final_proj_w > trunc(clock_timestamp()))then
	dt_inicio_proj_futuro_w := dt_final_proj_w;
else
	dt_inicio_proj_futuro_w := trunc(clock_timestamp());
end if;

open C01;
loop
fetch C01 into
	dt_ref_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	max(pr_prev),
		max(pr_real)
	into STRICT	pr_prev_w,
		pr_real_w
	from	dashboard_pmo_port_graf
	where 	nr_seq_port = nr_seq_port_p
	and	trunc(dt_referencia) = trunc(dt_ref_w);

	if (coalesce(pr_prev_w::text, '') = '') then
		pr_prev_w	:= obter_pr_prev_etapa_port(nr_seq_port_p ,dt_ref_w);
	end if;

	if (dt_ref_w < dt_final_proj_w) and (coalesce(pr_prev_w::text, '') = '') then
		pr_prev_w := 0;
	end if;

	if (trunc(dt_ref_w,'month')	= trunc(clock_timestamp(),'month')) then

		select  max(a.pr_real)
		into STRICT	pr_real_w
		from  dashboard_pmo_port_resumo_v a
		where a.nr_sequencia  = nr_seq_port_p;

	end if;


	insert into W_GRAFICO_Port(nr_sequencia,
					nr_seq_port,
					dt_ref,
					qt_hr_previstas,
					qt_hr_residuais,
					nm_usuario,
					ie_tipo_grafico)
			values (	nextval('w_grafico_port_seq'),
					nr_seq_port_p,
					dt_ref_w,
					coalesce(pr_prev_w, 100),
					pr_real_w,
					nm_usuario_p,
					'P');

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_grafico_port_progresso (nr_seq_port_p bigint, nm_usuario_p text) FROM PUBLIC;

