-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ajustar_proj_rec_cot_compra ( nr_cot_compra_p bigint, nr_seq_projeto_anterior_p bigint, nr_seq_projeto_novo_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_hist_w	bigint;

ds_historico_anterior_w	varchar(2000);
ds_historico_novo_w	varchar(2000);

/* Campos Projeto */

ds_projeto_anterior_w	varchar(80);
ds_projeto_novo_w		varchar(80);


BEGIN

update	cot_compra_item
set	nr_seq_proj_rec = nr_seq_projeto_novo_p
where	(nr_seq_proj_rec IS NOT NULL AND nr_seq_proj_rec::text <> '')
and	nr_cot_compra   = nr_cot_compra_p;

select	ds_projeto
into STRICT	ds_projeto_anterior_w
from	projeto_recurso
where	nr_sequencia = nr_seq_projeto_anterior_p;

select	ds_projeto
into STRICT	ds_projeto_novo_w
from	projeto_recurso
where	nr_sequencia = nr_seq_projeto_novo_p;

if (coalesce(nr_seq_projeto_novo_p,0) <> coalesce(nr_seq_projeto_anterior_p,0)) then
	begin
	/* Cria um histórico no novo projeto */

	ds_historico_novo_w := 	SUBSTR(Wheb_mensagem_pck.get_texto(297060,
						'NR_COT_COMPRA_W='||nr_cot_compra_p||
						';DS_PROJETO_ANTERIOR_W='||ds_projeto_anterior_w||
						';DS_PROJETO_NOVO_W='||ds_projeto_novo_w),1,2000);

	select	nextval('projeto_recurso_hist_seq')
	into STRICT	nr_sequencia_hist_w
	;

	insert into projeto_recurso_hist(	nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_projeto,
					ie_geracao,
					ds_historico,
					dt_liberacao)
		values (nr_sequencia_hist_w,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_projeto_novo_p,
					'S',
					ds_historico_novo_w,
					clock_timestamp());

	/* Cria um histórico  no antigo projeto */

	ds_historico_anterior_w := 	SUBSTR(Wheb_mensagem_pck.get_texto(297060,
						'NR_COT_COMPRA_W='||nr_cot_compra_p||
						';DS_PROJETO_ANTERIOR_W='||ds_projeto_anterior_w||
						';DS_PROJETO_NOVO_W='||ds_projeto_novo_w),1,2000);

	select	nextval('projeto_recurso_hist_seq')
	into STRICT	nr_sequencia_hist_w
	;

	insert into projeto_recurso_hist(	nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					nr_seq_projeto,
					ie_geracao,
					ds_historico,
					dt_liberacao)
		values (nr_sequencia_hist_w,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_projeto_anterior_p,
					'S',
					ds_historico_anterior_w,
					clock_timestamp());
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ajustar_proj_rec_cot_compra ( nr_cot_compra_p bigint, nr_seq_projeto_anterior_p bigint, nr_seq_projeto_novo_p bigint, nm_usuario_p text) FROM PUBLIC;

