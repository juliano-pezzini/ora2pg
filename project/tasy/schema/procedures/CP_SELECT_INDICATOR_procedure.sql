-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cp_select_indicator ( nr_seq_pat_care_plan_p bigint, nr_seq_cp_indicator_p bigint, nr_seq_cp_goal_p bigint, nr_seq_pat_cp_problem_p bigint, nm_usuario_p text, selection_p text, nr_seq_prescr_diag_p bigint default null) AS $body$
DECLARE


nr_seq_patient_cp_goal_out_w	bigint;
updated_w						varchar(1);
nr_seq_pat_cp_indicator_w		patient_cp_indicator.nr_sequencia%type;


c_indicator CURSOR FOR
	SELECT	cpi.nr_sequencia
	from	patient_cp_indicator cpi
	where	cpi.nr_seq_pat_care_plan = nr_seq_pat_care_plan_p
	and		cpi.nr_seq_cp_indicator = nr_seq_cp_indicator_p

union

  SELECT	cpi.nr_sequencia
	from	patient_cp_indicator cpi
	where	coalesce(cpi.nr_seq_pat_care_plan,0) = coalesce(nr_seq_pat_care_plan_p,0)
	and cpi.nr_seq_cp_indicator = nr_seq_cp_indicator_p
  and NR_SEQ_PAT_CP_GOAL in (select nr_sequencia
                            from patient_cp_goal
                            where nr_seq_prescr_diag = nr_seq_prescr_diag_p);

BEGIN
updated_w	:= 'N';

for r_c_indicator in c_indicator loop
	nr_seq_pat_cp_indicator_w := r_c_indicator.nr_sequencia;
	updated_w := 'S';

	update	patient_cp_indicator
	set		si_selected = selection_p,
			nm_usuario	= nm_usuario_p,
			dt_atualizacao = clock_timestamp()
	where	nr_sequencia = r_c_indicator.nr_sequencia;

	if (selection_p = 'N') then
		delete from pe_prescr_indicator where nr_seq_pat_cp_indicator = nr_seq_pat_cp_indicator_w;
	end if;
end loop;

nr_seq_patient_cp_goal_out_w := cp_select_goal(nr_seq_pat_care_plan_p, nr_seq_cp_goal_p, nr_seq_pat_cp_problem_p, nm_usuario_p, nr_seq_prescr_diag_p, nr_seq_patient_cp_goal_out_w);

if (updated_w = 'N') then
	select nextval('patient_cp_indicator_seq') into STRICT nr_seq_pat_cp_indicator_w;

	insert into patient_cp_indicator(
					dt_atualizacao,
					dt_atualizacao_nrec,
					dt_end,
					dt_release,
					dt_start,
					nm_usuario,
					nm_usuario_nrec,
					si_selected,
					nr_seq_cp_indicator,
					nr_seq_pat_care_plan,
					nr_seq_pat_cp_goal,
					nr_sequencia
			  ) values (
					clock_timestamp(),
					clock_timestamp(),
					null,
					null,
					null,
					nm_usuario_p,
					nm_usuario_p,
					SELECTion_p,
					nr_seq_cp_indicator_p,
					nr_seq_pat_care_plan_p,
					nr_seq_patient_cp_goal_out_w,
					nr_seq_pat_cp_indicator_w
			  );
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cp_select_indicator ( nr_seq_pat_care_plan_p bigint, nr_seq_cp_indicator_p bigint, nr_seq_cp_goal_p bigint, nr_seq_pat_cp_problem_p bigint, nm_usuario_p text, selection_p text, nr_seq_prescr_diag_p bigint default null) FROM PUBLIC;

