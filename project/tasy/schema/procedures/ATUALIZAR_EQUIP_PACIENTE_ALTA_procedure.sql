-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_equip_paciente_alta (nm_usuario_p text) AS $body$
DECLARE

 
nr_equipamento_w	bigint;
nr_atendimento_w	bigint;
nr_prescricao_w	    bigint;
cd_pessoa_fisica_w   bigint;
cd_pessoa_atend_w    bigint;
cd_estabelecimento_w	smallint;

C01 CURSOR FOR 
	SELECT	a.nr_atendimento, 
			coalesce(a.cd_estabelecimento,1) 
	from	atendimento_paciente a 
	where	trunc(a.dt_alta) >= trunc(clock_timestamp()) - 7 
	and (exists (SELECT 1 
			from 	rp_paciente_reabilitacao b 
			where	b.cd_pessoa_fisica = a.cd_pessoa_fisica) or (obter_se_possui_atend_opme(a.nr_atendimento) = 'S')) 
	order by 1;
	
C02 CURSOR FOR 
	SELECT	a.nr_sequencia 
	from	man_equipamento a, 
		material_atend_paciente b 
	where	b.nr_atendimento 	= nr_atendimento_w 
	and	b.cd_material		= a.cd_material	   
	and	((b.nr_seq_lote_fornec = a.nr_seq_lote_fornec) or 
	     ((coalesce(b.nr_seq_lote_fornec::text, '') = '') and (b.nr_serie_material = a.nr_serie))) 
	and not exists (	SELECT	1 
			from	rp_equipamento c 
			where	c.nr_seq_equipamento = a.nr_sequencia) 
	
union
 
	select	a.nr_sequencia 
	from	man_equipamento a 
	WHERE	obter_se_possui_atend_opme(nr_atendimento_w) = 'S' 
	and		exists ( select	1 
					from	atendimento_paciente x 
					where	x.nr_atendimento = nr_atendimento_w 
					and		x.cd_pessoa_fisica = a.cd_pessoa_terceiro)	 
	and not exists (	select	1 
			from	rp_equipamento c 
			where	c.nr_seq_equipamento = a.nr_sequencia) 
	order by 1;


BEGIN 
 
open C01;
loop 
fetch C01 into	 
	nr_atendimento_w, 
	cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	open C02;
	loop 
	fetch C02 into 
		nr_equipamento_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin							 
		 select obter_pessoa_atendimento(nr_atendimento_w,'C') 
		 into STRICT cd_pessoa_atend_w 
		; 		 		 								
		 
		 select coalesce(max(d.cd_pessoa_fisica),0) 
		 into STRICT cd_pessoa_fisica_w 
		 from rp_paciente_reabilitacao d 
		 where d.cd_pessoa_fisica = cd_pessoa_atend_w;
		 
		 if ((obter_se_possui_atend_opme(nr_atendimento_w) = 'S') and (cd_pessoa_fisica_w = 0)) then 
		  begin 
	      insert into rp_paciente_reabilitacao( 
		      nr_sequencia, 
		 	  dt_atualizacao, 
	 	      nm_usuario, 
		      cd_pessoa_fisica, 
				  cd_estabelecimento) 
		  values (nextval('rp_paciente_reabilitacao_seq'), 
		      clock_timestamp(), 
		      nm_usuario_p, 
		      cd_pessoa_atend_w, 
					cd_estabelecimento_w);	
		  end;		
		 end if;
		  CALL man_atualiza_equip_alta(nr_atendimento_w, 
		  			 nr_equipamento_w, 
					 nm_usuario_p);
		end;
	end loop;
	close C02;
	 
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_equip_paciente_alta (nm_usuario_p text) FROM PUBLIC;

