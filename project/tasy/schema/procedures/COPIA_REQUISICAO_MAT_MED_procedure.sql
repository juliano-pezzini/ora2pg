-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copia_requisicao_mat_med ( NR_REQUISICAO_P bigint, NM_USUARIO_P text, NR_NOVA_REQUISICAO_P INOUT bigint) AS $body$
DECLARE



nr_requisicao_w		bigint;
cd_pessoa_usuario_w		varchar(10);


BEGIN

select	b.cd_pessoa_fisica
into STRICT	cd_pessoa_usuario_w
from	pessoa_fisica b,
	usuario a
where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
and	a.nm_usuario		= nm_usuario_p;

select	nextval('requisicao_seq')
into STRICT	nr_requisicao_w
;

insert into requisicao_material(
	NR_REQUISICAO,
	CD_ESTABELECIMENTO,
	CD_LOCAL_ESTOQUE,
	DT_SOLICITACAO_REQUISICAO,
	DT_ATUALIZACAO,
	NM_USUARIO,
	CD_OPERACAO_ESTOQUE,
	CD_PESSOA_REQUISITANTE,
	CD_PESSOA_ATENDENTE,
	CD_SETOR_ATENDIMENTO,
	CD_ESTABELECIMENTO_DESTINO,
	CD_LOCAL_ESTOQUE_DESTINO,
	CD_CENTRO_CUSTO,
	DT_BAIXA,
	DT_LIBERACAO,
	DT_APROVACAO,
	DT_EMISSAO_SETOR,
	DT_EMISSAO_LOC_ESTOQUE,
	DS_OBSERVACAO,
	NR_SEQ_ORDEM_SERV,
	IE_URGENTE,
	CD_SETOR_ENTREGA)
SELECT	nr_requisicao_w,
	CD_ESTABELECIMENTO,
	CD_LOCAL_ESTOQUE,
	clock_timestamp(),
	clock_timestamp(),
	NM_USUARIO_P,
	CD_OPERACAO_ESTOQUE,
	cd_pessoa_usuario_w,
	Null,
	wheb_usuario_pck.get_cd_setor_atendimento,
	CD_ESTABELECIMENTO_DESTINO,
	CD_LOCAL_ESTOQUE_DESTINO,
	CD_CENTRO_CUSTO,
	NULL,
	null,
	NULL,
	NULL,
	NULL,
	DS_OBSERVACAO,
	NR_SEQ_ORDEM_SERV,
	IE_URGENTE,
	CD_SETOR_ENTREGA
from	requisicao_material
where	nr_requisicao = nr_requisicao_p;

insert into ITEM_REQUISICAO_MATERIAL(
	NR_REQUISICAO,
	NR_SEQUENCIA,
	CD_ESTABELECIMENTO,
	CD_MATERIAL,
	QT_MATERIAL_REQUISITADA,
	QT_MATERIAL_ATENDIDA,
	VL_MATERIAL,
	DT_ATUALIZACAO,
	NM_USUARIO,
	CD_UNIDADE_MEDIDA,
	DT_ATENDIMENTO,
	CD_PESSOA_RECEBE,
	CD_PESSOA_ATENDE,
	IE_ACAO,
	CD_MOTIVO_BAIXA,
	QT_ESTOQUE,
	CD_UNIDADE_MEDIDA_ESTOQUE,
	CD_CONTA_CONTABIL,
	CD_MATERIAL_REQ,
	CD_CGC_FORNECEDOR,
	DS_OBSERVACAO )
SELECT	nr_requisicao_w,
	NR_SEQUENCIA,
	CD_ESTABELECIMENTO,
	CD_MATERIAL,
	QT_MATERIAL_REQUISITADA,
	0,
	VL_MATERIAL,
	clock_timestamp(),
	NM_USUARIO_P,
	CD_UNIDADE_MEDIDA,
	null,
	null,
	null,
	IE_ACAO,
	0,
	QT_ESTOQUE,
	CD_UNIDADE_MEDIDA_ESTOQUE,
	CD_CONTA_CONTABIL,
	CD_MATERIAL_REQ,
	CD_CGC_FORNECEDOR,
	DS_OBSERVACAO
from	ITEM_REQUISICAO_MATERIAL
where	nr_requisicao = nr_requisicao_p;

CALL gravar_estoque_requisicao_lib(nr_requisicao_w, NM_USUARIO_P);

Commit;

NR_NOVA_REQUISICAO_P := nr_requisicao_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copia_requisicao_mat_med ( NR_REQUISICAO_P bigint, NM_USUARIO_P text, NR_NOVA_REQUISICAO_P INOUT bigint) FROM PUBLIC;

