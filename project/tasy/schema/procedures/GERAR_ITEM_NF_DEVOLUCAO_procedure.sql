-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_item_nf_devolucao ( nr_seq_nf_devolucao_p bigint, nr_seq_nf_entrada_p bigint, nr_item_nf_p bigint, nm_usuario_p text, ie_valida_saldo_menor_zero_p text default 'S') AS $body$
DECLARE


nr_nota_fiscal_w			varchar(255);
qt_item_estoque_w			double precision;
nr_seq_unidade_adic_w		bigint;
qt_conversao_w			double precision;
qt_item_nf_w			double precision;
qt_conv_compra_estoque_w		double precision;
qt_gerar_w			double precision;
vl_unitario_item_nf_w		double precision;
vl_total_item_nf_w			double precision;
vl_descontos_w			double precision;
vl_liquido_w			double precision;
nr_seq_lote_w			bigint;
ds_lote_fornec_w			varchar(20);
qt_lote_w				double precision;
dt_validade_w			timestamp;
ie_indeterminado_w			varchar(1);
nr_seq_marca_w			bigint;
cd_barra_material_w		material_lote_fornec.cd_barra_material%type;
ds_barras_w			varchar(4000);
dt_fabricacao_w			timestamp;
nr_item_nf_w			bigint;
nr_seq_marca_geral_w		bigint;
cd_material_w			integer;
cd_cgc_w			varchar(14);
cd_unidade_medida_compra_w	varchar(30);
cd_estabelecimento_w		integer;
qt_existe_lote_w			bigint;
qt_compra_w			double precision;
qt_conv_compra_est_w		double precision;
cd_natureza_operacao_w		smallint;
ie_somar_ipi_w			varchar(1) := 'N';
ie_param_371_w			varchar(1);
ie_ratear_ipi_nf_devol_w		varchar(1);
vl_ipi_w				double precision;
vl_ipi_total_w			double precision;
ds_historico_w			varchar(2000);
ds_observacao_w			varchar(4000);
ie_lote_fornec_nf_dev_w		varchar(1);
ie_gera_w			varchar(1);
ie_gerar_desdobrado_w		varchar(1);
ie_quantidade_w			varchar(1);
cd_operacao_nf_w			bigint;
ie_atualiza_estoque_w		operacao_estoque.ie_atualiza_estoque%type;
ie_agrupar_lote_w 		regra_nf_lote_fornec.ie_agrupar_lote%type;


c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.ds_lote_fornec,
	a.qt_material,
	a.dt_validade,
	coalesce(a.ie_validade_indeterminada,'N'),
	a.nr_seq_marca,
	a.cd_barra_material,
	a.ds_barras,
	a.dt_fabricacao
from	material_lote_fornec a
where	a.nr_sequencia_nf = nr_seq_nf_entrada_p
and	a.nr_item_nf = nr_item_nf_p

union

SELECT	a.nr_sequencia,
	a.ds_lote_fornec,
	a.qt_material,
	a.dt_validade,
	coalesce(a.ie_validade_indeterminada,'n'),
	a.nr_seq_marca,
	a.cd_barra_material,
	a.ds_barras,
	a.dt_fabricacao
from	material_lote_fornec a,
	material_lote_fornec_nf b
where	a.nr_sequencia = b.nr_seq_lote_fornec
and	b.nr_sequencia_nf = nr_seq_nf_entrada_p
and	b.nr_item_nf = nr_item_nf_p;

c02 CURSOR FOR
SELECT	nr_item_nf,
	cd_material,
	cd_lote_fabricacao,
	dt_validade,
	ie_indeterminado,
	qt_item_nf,
	qt_item_estoque,
	dividir(qt_item_estoque,qt_item_nf),
	nr_seq_marca
from	nota_fiscal_item
where	nr_sequencia = nr_seq_nf_devolucao_p
and	(cd_lote_fabricacao IS NOT NULL AND cd_lote_fabricacao::text <> '');	


BEGIN

select	cd_natureza_operacao,
	cd_operacao_nf
into STRICT	cd_natureza_operacao_w,
	cd_operacao_nf_w
from	nota_fiscal
where	nr_sequencia = nr_seq_nf_devolucao_p;

select	coalesce(max(ie_atualiza_estoque),'N')
into STRICT	ie_atualiza_estoque_w
from	operacao_nota a,
	operacao_estoque b
where	a.cd_operacao_estoque = b.cd_operacao_estoque
and	a.cd_operacao_nf = cd_operacao_nf_w;

select	coalesce(max(ie_ratear_ipi_nf_devol),'S')
into STRICT	ie_ratear_ipi_nf_devol_w
from	operacao_nota
where	cd_operacao_nf = cd_operacao_nf_w;

select	nr_nota_fiscal
into STRICT	nr_nota_fiscal_w
from	nota_fiscal
where	nr_sequencia = nr_seq_nf_entrada_p;

select	obter_saldo_devolver_item_nf(a.nr_sequencia, b.nr_item_nf),
	b.vl_unitario_item_nf,
	coalesce(b.vl_desconto,0),
	obter_qt_convertida_compra_est(b.cd_material, obter_saldo_devolver_item_nf(a.nr_sequencia, b.nr_item_nf), b.cd_unidade_medida_compra, b.nr_seq_marca, a.cd_cgc, a.cd_estabelecimento),
	b.nr_seq_unidade_adic,
	b.cd_material,
	a.cd_cgc,
	b.cd_unidade_medida_compra,
	a.cd_estabelecimento,
	b.nr_seq_marca	
into STRICT	qt_item_nf_w,
	vl_unitario_item_nf_w,
	vl_descontos_w,
	qt_item_estoque_w,
	nr_seq_unidade_adic_w,
	cd_material_w,
	cd_cgc_w,
	cd_unidade_medida_compra_w,
	cd_estabelecimento_w,
	nr_seq_marca_geral_w
from	nota_fiscal a,
	nota_fiscal_item b
where	a.nr_sequencia = b.nr_sequencia
and	a.nr_sequencia = nr_seq_nf_entrada_p
and	b.nr_item_nf = nr_item_nf_p;

ie_param_371_w	:= coalesce((obter_valor_param_usuario(40, 371, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w)), 'N');

if (ie_ratear_ipi_nf_devol_w = 'S') and (ie_param_371_w = 'S') then
	ie_somar_ipi_w := 'S';
end if;

select	ie_lote_fornec_nf_dev
into STRICT	ie_lote_fornec_nf_dev_w
from	parametro_compras
where	cd_estabelecimento = cd_estabelecimento_w;

if (nr_seq_unidade_adic_w > 0) then
	
	select	coalesce(max(qt_conversao),1)
	into STRICT	qt_conversao_w
	from	unidade_medida_adic_compra
	where	nr_sequencia = nr_seq_unidade_adic_w;

	qt_item_estoque_w := qt_item_estoque_w * qt_conversao_w;
end if;	

vl_total_item_nf_w	:= (qt_item_nf_w * vl_unitario_item_nf_w);

if (ie_somar_ipi_w = 'S') then
		
	select  coalesce(sum(vl_tributo),0)
	into STRICT	vl_ipi_w
	from	nota_fiscal_item_trib
	where	nr_sequencia = nr_seq_nf_entrada_p
	and	nr_item_nf = nr_item_nf_p
	and	substr(obter_tipo_tributo(cd_tributo),1,255) = 'IPI';
	
	vl_ipi_total_w		:= vl_ipi_w;
	vl_ipi_w		:= dividir(vl_ipi_w, qt_item_nf_w);
	
	vl_unitario_item_nf_w	:= vl_unitario_item_nf_w + vl_ipi_w;
	vl_total_item_nf_w	:= vl_total_item_nf_w + (qt_item_nf_w * vl_ipi_w);
end if;

vl_liquido_w		:= (vl_total_item_nf_w - vl_descontos_w);

select	coalesce(max(nr_item_nf),0) + 1
into STRICT	nr_item_nf_w
from	nota_fiscal_item
where	nr_sequencia = nr_seq_nf_devolucao_p;

insert into nota_fiscal_item(
	cd_estabelecimento,
	cd_cgc_emitente,
	cd_serie_nf,
	nr_nota_fiscal,
	nr_sequencia_nf,
	nr_item_nf,
	cd_natureza_operacao,
	qt_item_nf,
	vl_unitario_item_nf,
	vl_total_item_nf,
	dt_atualizacao,
	nm_usuario,
	vl_frete,
	vl_desconto,
	vl_despesa_acessoria,
	cd_material,
	cd_procedimento,
	cd_setor_atendimento,
	cd_conta,
	cd_local_estoque,
	ds_observacao,
	qt_peso_bruto,
	qt_peso_liquido,
	cd_unidade_medida_compra,
	qt_item_estoque,
	cd_unidade_medida_estoque,
	cd_lote_fabricacao,
	dt_validade,
	dt_atualizacao_estoque,
	cd_conta_contabil,
	vl_desconto_rateio,
	vl_seguro,
	cd_centro_custo,
	cd_material_estoque,
	ie_origem_proced,
	nr_ordem_compra,
	nr_item_oci,
	nr_sequencia,
	vl_liquido,
	nr_seq_ordem_serv,
	nr_seq_lote_fornec,
	nr_seq_proj_rec,
	dt_inicio_garantia,
	dt_fim_garantia,
	dt_entrega_ordem,
	nr_seq_nf_orig,
	nr_seq_item_nf_orig,
	ds_complemento,
	cd_imobilizado,
	nr_seq_conta_financ)
SELECT	cd_estabelecimento,
	cd_cgc_emitente,
	cd_serie_nf,
	nr_nota_fiscal,
	nr_sequencia_nf,
	nr_item_nf_w,
	cd_natureza_operacao_w,
	qt_item_nf_w,
	vl_unitario_item_nf_w,
	vl_total_item_nf_w,
	clock_timestamp(),
	nm_usuario_p,
	vl_frete,
	vl_descontos_w,
	vl_despesa_acessoria,
	cd_material,
	cd_procedimento,
	cd_setor_atendimento,
	cd_conta,
	cd_local_estoque,
	substr(wheb_mensagem_pck.get_texto(311666,'NR_NOTA_FISCAL_W='|| NR_NOTA_FISCAL_W ||';DS_OBSERVACAO_W='|| DS_OBSERVACAO),1,255), /*Nota Fiscal de origem: #@NR_NOTA_FISCAL_W#@ #@DS_OBSERVACAO_W#@*/
	qt_peso_bruto,
	qt_peso_liquido,
	cd_unidade_medida_compra,
	qt_item_estoque_w,
	cd_unidade_medida_estoque,
	cd_lote_fabricacao,
	dt_validade,
	dt_atualizacao_estoque,
	cd_conta_contabil,
	vl_desconto_rateio,
	vl_seguro,
	cd_centro_custo,
	cd_material_estoque,
	ie_origem_proced,
	nr_ordem_compra,
	nr_item_oci,
	nr_seq_nf_devolucao_p,
	vl_liquido_w,
	nr_seq_ordem_serv,
	nr_seq_lote_fornec,
	nr_seq_proj_rec,
	dt_inicio_garantia,
	dt_fim_garantia,
	dt_entrega_ordem,
	nr_seq_nf_entrada_p,
	nr_item_nf_p,
	ds_complemento,
	cd_imobilizado,
	nr_seq_conta_financ
from	nota_fiscal_item
where	nr_sequencia = nr_seq_nf_entrada_p
and	nr_item_nf = nr_item_nf_p;

ds_historico_w	:= wheb_mensagem_pck.get_texto(311670,'NR_ITEM_NF_P='|| NR_ITEM_NF_P ||';NR_NOTA_FISCAL_W='|| NR_NOTA_FISCAL_W); /*Devolucao do item #@NR_ITEM_NF_P#@ da nota fiscal  - #@NR_NOTA_FISCAL_W#@*/
CALL gerar_historico_nota_fiscal(nr_seq_nf_devolucao_p, nm_usuario_p, '3',ds_historico_w);

ds_historico_w	:= wheb_mensagem_pck.get_texto(311671,'NR_ITEM_NF_P='|| NR_ITEM_NF_P ||';NR_SEQ_NF_DEVOLUCAO_P='|| NR_SEQ_NF_DEVOLUCAO_P); /*Gerado a devolucao do item #@NR_ITEM_NF_P#@ desta nota, gerando uma nova NF. seq.: #@NR_SEQ_NF_DEVOLUCAO_P#@*/
CALL gerar_historico_nota_fiscal(nr_seq_nf_entrada_p, nm_usuario_p, '3', ds_historico_w);

if (ie_somar_ipi_w = 'S') and (vl_ipi_total_w > 0) then

	select	ds_observacao
	into STRICT	ds_observacao_w
	from	nota_fiscal
	where	nr_sequencia 	= nr_seq_nf_devolucao_p;
	
	if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
		ds_observacao_w	:= substr(wheb_mensagem_pck.get_texto(311674,'DS_OBSERVACAO_W='|| DS_OBSERVACAO_W ||';VL_IPI_TOTAL_W='|| campo_mascara_virgula(vl_ipi_total_w)),1,4000); /*#@DS_OBSERVACAO_W#@IPI no valor de #@VL_IPI_TOTAL_W#@*/
	else
		ds_observacao_w	:= substr(wheb_mensagem_pck.get_Texto(311678, 'VL_IPI_TOTAL_W='|| VL_IPI_TOTAL_W),1,4000); /*IPI no valor de #@VL_IPI_TOTAL_W#@*/
	end if;
	
    update 	nota_fiscal
    set		ds_observacao	= ds_observacao_w
    where	nr_sequencia 	= nr_seq_nf_devolucao_p;

end if;

select	count(*)
into STRICT	qt_existe_lote_w
from	material_lote_fornec a
where	a.nr_sequencia_nf = nr_seq_nf_entrada_p
and	a.nr_item_nf = nr_item_nf_p;

if (qt_existe_lote_w = 0) then
	select	count(*)
	into STRICT	qt_existe_lote_w
	from	material_lote_fornec_nf a
	where	a.nr_sequencia_nf = nr_seq_nf_entrada_p
	and	a.nr_item_nf = nr_item_nf_p;
end if;

if (qt_existe_lote_w > 0) then
	begin

	open C01;
	loop
	fetch C01 into	
		nr_seq_lote_w,
		ds_lote_fornec_w,
		qt_lote_w,
		dt_validade_w,
		ie_indeterminado_w,
		nr_seq_marca_w,
		cd_barra_material_w,
		ds_barras_w,
		dt_fabricacao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
	
		if (ie_atualiza_estoque_w = 'S') then
			select	obter_saldo_lote_fornec(nr_seq_lote_w)
			into STRICT	qt_compra_w
			;
			
			if (qt_compra_w < 0 and (coalesce(ie_valida_saldo_menor_zero_p, 'S') = 'S')) then
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(267918, 'DS_LOTE_W='||ds_lote_fornec_w);			
			end if;
		else
		
			/*select	qt_item_nf
			into	qt_compra_w
			from	nota_fiscal_item
			where	nr_sequencia	= nr_seq_nf_devolucao_p
			and	nr_item_nf	= nr_item_nf_w;*/
			
			qt_compra_w := qt_lote_w;
			
		end if;

		select	obter_qt_convertida_compra_est(cd_material_w,qt_compra_w,cd_unidade_medida_compra_w,nr_seq_marca_w,cd_cgc_w,cd_estabelecimento_w)
		into STRICT	qt_lote_w
		;
	
		insert into nota_fiscal_item_lote(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nr_seq_nota,
			nr_item_nf,
			dt_validade,
			qt_material,
			qt_compra,
			cd_lote_fabricacao,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_marca,
			cd_barra_material,
			ds_barras,
			ie_indeterminado,
			dt_fabricacao,
			nr_seq_lote_fornec_orig,
			nr_seq_lote_fornec)
		values (	nextval('nota_fiscal_item_lote_seq'),
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_nf_devolucao_p,
			nr_item_nf_w,
			dt_validade_w,
			qt_lote_w,
			qt_compra_w,
			ds_lote_fornec_w,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_marca_w,
			cd_barra_material_w,
			ds_barras_w,
			ie_indeterminado_w,
			dt_fabricacao_w,
			nr_seq_lote_w,
			nr_seq_lote_w);
		
		end;
	end loop;
	close C01;

	if (ie_atualiza_estoque_w = 'S') then
		select	sum(coalesce(qt_compra,0))
		into STRICT	qt_item_nf_w
		from	nota_fiscal_item_lote
		where	nr_seq_nota = nr_seq_nf_devolucao_p
		and	nr_item_nf = nr_item_nf_w;

		select	obter_qt_convertida_compra_est(cd_material_w,qt_item_nf_w,cd_unidade_medida_compra_w,nr_seq_marca_geral_w,cd_cgc_w,cd_estabelecimento_w)
		into STRICT	qt_item_estoque_w
		;

	
		update	nota_fiscal_item
		set	qt_item_nf	= qt_item_nf_w,
			qt_item_estoque	= qt_item_estoque_w,
			vl_total_item_nf	= (vl_unitario_item_nf * qt_item_nf_w),
			vl_liquido		= ((vl_unitario_item_nf * qt_item_nf_w) - vl_desconto)
		where	nr_sequencia	= nr_seq_nf_devolucao_p
		and	nr_item_nf	= nr_item_nf_w;
	end if;

	end;
end if;

if (nr_seq_nf_devolucao_p > 0) and (ie_lote_fornec_nf_dev_w = 'S') then
	
	open C02;
	loop
	fetch C02 into	
		nr_item_nf_w,
		cd_material_w,
		ds_lote_fornec_w,
		dt_validade_w,
		ie_indeterminado_w,
		qt_item_nf_w,
		qt_item_estoque_w,
		qt_conv_compra_estoque_w,
		nr_seq_marca_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		
		delete from nota_fiscal_item_lote
		where	nr_seq_nota = nr_seq_nf_devolucao_p
		and	nr_item_nf = nr_item_nf_w;
		
		SELECT * FROM obter_regra_nf_lote_fornec(cd_material_w, cd_estabelecimento_w, ie_gera_w, ie_quantidade_w, ie_gerar_desdobrado_w, ie_agrupar_lote_w, nr_seq_marca_w) INTO STRICT ie_gera_w, ie_quantidade_w, ie_gerar_desdobrado_w, ie_agrupar_lote_w;
		
		if (ie_gera_w in ('S','O')) then
							
			if (ie_quantidade_w = 'E') then
				qt_gerar_w	:= qt_item_estoque_w;
			else
				qt_gerar_w	:= dividir(qt_item_estoque_w,qt_conv_compra_estoque_w);
			end if;
		
			update	nota_fiscal_item
			set	cd_lote_fabricacao	= '',
				dt_validade		 = NULL,
				ie_indeterminado	= 'N'
			where	nr_sequencia		= nr_seq_nf_devolucao_p
			and	nr_item_nf		= nr_item_nf_w;
			
			insert into nota_fiscal_item_lote(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nr_seq_nota,
				nr_item_nf,
				dt_validade,
				qt_material,
				cd_lote_fabricacao,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_marca,			
				ie_indeterminado)
			values (	nextval('nota_fiscal_item_lote_seq'),
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_nf_devolucao_p,
				nr_item_nf_w,
				dt_validade_w,
				qt_gerar_w,
				ds_lote_fornec_w,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_marca_w,
				ie_indeterminado_w);
		
		end if;
		end;
	end loop;
	close C02;
	
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_item_nf_devolucao ( nr_seq_nf_devolucao_p bigint, nr_seq_nf_entrada_p bigint, nr_item_nf_p bigint, nm_usuario_p text, ie_valida_saldo_menor_zero_p text default 'S') FROM PUBLIC;

