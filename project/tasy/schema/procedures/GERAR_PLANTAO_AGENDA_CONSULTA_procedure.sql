-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_plantao_agenda_consulta ( cd_agenda_p bigint, nm_usuario_p text, dt_inicial_p timestamp, dt_final_p timestamp) AS $body$
DECLARE

 
cd_estabelecimento_w	bigint;
cd_medico_w		varchar(100);
cont_w			bigint;
qt_duracao_w		bigint;
dt_agenda_w		timestamp;
nr_seq_tipo_plantao_w	bigint;
dt_inicial_w		timestamp;
dt_final_w		timestamp;
ie_classif_agenda_w	varchar(5);
--nr_seq_sala_w		number(10); 
--cd_convenio_w		number(5);	 
c01 CURSOR FOR 
	SELECT	PKG_DATE_UTILS.start_of(a.dt_agenda,'dd',0), 
		b.cd_estabelecimento, 
		b.cd_pessoa_fisica, 
		coalesce(a.ie_classif_agenda,'0') 
		--nvl(a.nr_seq_sala,0) 
		--nvl(a.cd_convenio,0) 
	from	agenda b, 
		agenda_consulta a 
	where	a.cd_agenda		= b.cd_agenda 
	and	a.cd_agenda		= cd_agenda_p 
	and	PKG_DATE_UTILS.start_of(a.dt_agenda,'dd',0) between dt_inicial_p and fim_dia(dt_final_p) 
	and	ie_status_agenda not in ('B','C','II','R') 
	group by	PKG_DATE_UTILS.start_of(a.dt_agenda,'dd',0), 
		b.cd_estabelecimento, 
		b.cd_pessoa_fisica, 
		a.ie_classif_agenda 
	order by 1;
	--a.nr_seq_sala 
	--a.cd_convenio 
C02 CURSOR FOR 
	SELECT	coalesce(sum(Obter_Min_Entre_Datas(a.hr_inicial,a.hr_final,null)),0), 
		to_date(to_char(dt_agenda_w,'dd/mm/yyyy')||' '||to_char(a.hr_inicial,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss'), 
		to_date(to_char(dt_agenda_w,'dd/mm/yyyy')||' '||to_char(a.hr_final,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss') 
	from	agenda_turno a 
	where	((a.ie_dia_semana = PKG_DATE_UTILS.get_WeekDay(dt_agenda_w)) or (a.ie_dia_semana = 9)) 
	and	a.cd_agenda = cd_agenda_p 
	and	coalesce(a.ie_classif_agenda,ie_classif_agenda_w) = ie_classif_agenda_w 
	--and	nvl(a.nr_seq_sala,nr_seq_sala_w) = nr_seq_sala_w 
	and	dt_agenda_w between a.dt_inicio_vigencia and coalesce(a.dt_final_vigencia,dt_agenda_w) 
	and	obter_se_gerar_turno_agecons(a.dt_inicio_vigencia,a.ie_frequencia,dt_agenda_w) = 'S' 
	 and	((Obter_Semana_Dia_Agecons(dt_agenda_w,a.ie_dia_semana) = coalesce(a.ie_semana,0)) or (coalesce(a.ie_semana,0) = 0)) 
	group by	hr_inicial, 
		hr_final;
	
C03 CURSOR FOR 
	SELECT	coalesce(sum(Obter_Min_Entre_Datas(a.hr_inicial,a.hr_final,null)),0), 
		to_date(to_char(dt_agenda_w,'dd/mm/yyyy')||' '||to_char(a.hr_inicial,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss'), 
		to_date(to_char(dt_agenda_w,'dd/mm/yyyy')||' '||to_char(a.hr_final,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss') 
	from	agenda_turno_esp a 
	where	a.cd_agenda = cd_agenda_p 
	and	dt_agenda_w between a.dt_agenda and fim_dia(a.dt_agenda_fim) 
	and	coalesce(a.ie_classif_agenda,ie_classif_agenda_w) = ie_classif_agenda_w 
	group by	hr_inicial, 
		hr_final;	

BEGIN 
 
nr_seq_tipo_plantao_w := (obter_valor_param_usuario(821, 150, obter_perfil_ativo, nm_usuario_p, 0))::numeric;
 
open c01;
loop 
fetch c01 into 
	dt_agenda_w, 
	cd_estabelecimento_w, 
	cd_medico_w, 
	ie_classif_agenda_w;
	--nr_seq_sala_w; 
	--cd_convenio_w; 
EXIT WHEN NOT FOUND; /* apply on c01 */
	 
	select	count(*) 
	into STRICT	cont_w 
	from	medico 
	where	cd_pessoa_fisica	= cd_medico_w;
 
	if (cont_w = 0) then 
		CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(280119);
	end if;
	 
	open C02;
	loop 
	fetch C02 into	 
		qt_duracao_w, 
		dt_inicial_w, 
		dt_final_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		if (coalesce(qt_duracao_w,0) <> 0) then 
			begin 
			insert into medico_plantao( 
				CD_ESTABELECIMENTO, 
				CD_MEDICO, 
				DT_ATUALIZACAO, 
				NM_USUARIO, 
				NR_SEQUENCIA, 
				QT_MINUTO, 
				dt_inicial, 
				dt_final, 
				nr_seq_tipo_plantao) 
			values (	cd_estabelecimento_w, 
				cd_medico_w, 
				clock_timestamp(), 
				nm_usuario_p, 
				nextval('medico_plantao_seq'), 
				qt_duracao_w, 
				dt_inicial_w, 
				dt_final_w, 
				nr_seq_tipo_plantao_w);
			end;
		end if;	
		end;
	end loop;
	close C02;
	 
	open C03;
	loop 
	fetch C03 into	 
		qt_duracao_w, 
		dt_inicial_w, 
		dt_final_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin 
		if (coalesce(qt_duracao_w,0) <> 0) then 
			begin 
			insert into medico_plantao( 
				CD_ESTABELECIMENTO, 
				CD_MEDICO, 
				DT_ATUALIZACAO, 
				NM_USUARIO, 
				NR_SEQUENCIA, 
				QT_MINUTO, 
				dt_inicial, 
				dt_final, 
				nr_seq_tipo_plantao) 
			values (	cd_estabelecimento_w, 
				cd_medico_w, 
				clock_timestamp(), 
				nm_usuario_p, 
				nextval('medico_plantao_seq'), 
				qt_duracao_w, 
				dt_inicial_w, 
				dt_final_w, 
				nr_seq_tipo_plantao_w);
			end;
		end if;	
		end;
	end loop;
	close C03;
	 
end loop;
close c01;
 
 
 
commit;
 
end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_plantao_agenda_consulta ( cd_agenda_p bigint, nm_usuario_p text, dt_inicial_p timestamp, dt_final_p timestamp) FROM PUBLIC;

