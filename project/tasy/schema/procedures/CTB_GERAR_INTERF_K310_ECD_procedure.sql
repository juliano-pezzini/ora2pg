-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_interf_k310_ecd ( nr_seq_controle_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, cd_empresa_p bigint, cd_conta_contabil_p text, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint ) AS $body$
DECLARE


ds_arquivo_w                	varchar(4000);
ds_compl_arquivo_w          	varchar(4000);
ds_linha_w                  	varchar(8000);
nr_linha_w                  	bigint      := qt_linha_p;
nr_seq_registro_w            	bigint      := nr_sequencia_p;
sep_w                        	varchar(1)     := '|';
tp_registro_w                	varchar(15)    := 'K310';
cd_empresa_w                	grupo_emp_estrutura.cd_empresa%type;
vl_eliminacao_w              	ctb_movimento.vl_movimento%type;
ie_debito_credito_elimin_w  	varchar(1);
cd_conta_contabil_w          	conta_contabil.cd_conta_contabil%type;

c01 CURSOR(cd_conta_contabil_prm       text) FOR
  SELECT e.cd_empresa,
       'D'  ie_tipo_conta,
       coalesce(m.cd_conta_debito,m.cd_conta_credito) m2_conta,
       sum(m.vl_movimento) vl_movimento
  from ctb_movimento m,
       estabelecimento e,
       ctb_mes_ref re
 where m.cd_estabelecimento = e.cd_estabelecimento
   and m.nr_seq_mes_ref 	= re.nr_sequencia
   and re.dt_referencia between dt_inicio_p and dt_fim_p
   and e.cd_empresa 		= cd_empresa_p
   and m.cd_conta_debito 	= cd_conta_contabil_prm
   and (m.cd_conta_debito IS NOT NULL AND m.cd_conta_debito::text <> '')
   and m.ie_eliminacao_lancto = 'S'
   group by e.cd_empresa, m.cd_conta_debito,m.cd_conta_credito

union all

  SELECT e.cd_empresa,
       'C'  ie_tipo_conta,
       coalesce(m.cd_conta_credito,m.cd_conta_debito) m2_conta,
       sum(m.vl_movimento) vl_movimento
  from ctb_movimento m,
       estabelecimento e,
       ctb_mes_ref re
 where m.cd_estabelecimento = e.cd_estabelecimento
   and m.nr_seq_mes_ref 	= re.nr_sequencia
   and re.dt_referencia between dt_inicio_p and dt_fim_p
   and e.cd_empresa 		= cd_empresa_p
   and m.cd_conta_credito 	= cd_conta_contabil_prm
   and (m.cd_conta_credito IS NOT NULL AND m.cd_conta_credito::text <> '')
   and m.ie_eliminacao_lancto = 'S'
   group by e.cd_empresa, m.cd_conta_debito,m.cd_conta_credito
order  by 1;


BEGIN

      open c01(cd_conta_contabil_p);
      loop
        fetch c01 into
          cd_empresa_w,
          ie_debito_credito_elimin_w,
          cd_conta_contabil_w,
          vl_eliminacao_w;
        EXIT WHEN NOT FOUND; /* apply on c01 */

          begin
            ds_linha_w   := substr(sep_w    ||
                tp_registro_w      			|| sep_w ||
                cd_empresa_w      			|| sep_w ||
                replace(replace(campo_mascara_virgula(vl_eliminacao_w),'.',''),'-','')  || sep_w ||
                ie_debito_credito_elimin_w  || sep_w,1,8000);

            ds_arquivo_w    	:= substr(ds_linha_w,1,4000);
            ds_compl_arquivo_w  := substr(ds_linha_w,4001,4000);
            nr_seq_registro_w   := nr_seq_registro_w + 1;
            nr_linha_w    		:= nr_linha_w + 1;

            insert into ctb_sped_registro(
                nr_sequencia,
                ds_arquivo,
                dt_atualizacao,
                nm_usuario,
                dt_atualizacao_nrec,
                nm_usuario_nrec,
                nr_seq_controle_sped,
                ds_arquivo_compl,
                cd_registro,
                nr_linha)
              values (
                nr_seq_registro_w,
                ds_arquivo_w,
                clock_timestamp(),
                nm_usuario_p,
                clock_timestamp(),
                nm_usuario_p,
                nr_seq_controle_p,
                ds_compl_arquivo_w,
                tp_registro_w,
                nr_linha_w);

              SELECT * FROM ctb_gerar_interf_k315_ecd(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_p, dt_inicio_p, dt_fim_p, cd_empresa_w, cd_conta_contabil_w, ie_debito_credito_elimin_w, nr_linha_w, nr_seq_registro_w) INTO STRICT nr_linha_w, nr_seq_registro_w;
          end;
        end loop;
        close c01;
commit;
qt_linha_p      := nr_linha_w;
nr_sequencia_p  := nr_seq_registro_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_interf_k310_ecd ( nr_seq_controle_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, cd_empresa_p bigint, cd_conta_contabil_p text, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint ) FROM PUBLIC;

