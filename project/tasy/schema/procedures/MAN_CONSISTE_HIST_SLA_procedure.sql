-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_consiste_hist_sla ( nr_seq_ordem_serv_p man_ordem_servico.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


/*
	++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	Objective: Inconsistency in case the SO is an SLA, has a rule with
	mandatory history, but the service order does not have an history with
	that type
	------------------------------------------------------------------------
	Direct call: 
	[   ] Dictionary objects
	[ X ] Tasy (Delphi/Java/HTML5)
	[   ] Portal
	[   ] Reports
	[   ] Others:
	 -----------------------------------------------------------------------
	Attention points: N/A
	------------------------------------------------------------------------
	References:
		Tables: N/A
		Objects: N/A
	------------------------------------------------------------------------
	Called in:
		Java:	"C:\Java\Projetos\Projetos Swing\Cor_Man\CorMan_OS\src\br\com\CorMan_OS\tipoOrdemServicoDesenv\TipoOrdemServicoDesenvWJP.java"
		HTML5: N/A
		Object: N/A
	++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
*/
ds_tipo_w			varchar(255);
ie_os_sla_w			varchar(1);
qt_hist_obrig_w			bigint;
nr_seq_tipo_hist_obrig_w	man_sla_regra_config.nr_seq_tipo_hist_obrig%type;


BEGIN

	select	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
	into STRICT	ie_os_sla_w
	from	man_ordem_serv_sla
	where	nr_seq_ordem = nr_seq_ordem_serv_p;

	if (ie_os_sla_w = 'S') then
		begin
			select	max(nr_seq_tipo_hist_obrig)
			into STRICT	nr_seq_tipo_hist_obrig_w
			from	man_sla_regra_config
			where	ie_situacao = 'A';
			
			if (coalesce(nr_seq_tipo_hist_obrig_w, 0) <> 0) then
				begin
					select	count(1)
					into STRICT	qt_hist_obrig_w
					from	man_ordem_serv_tecnico
					where	nr_seq_ordem_serv = nr_seq_ordem_serv_p
					and	nr_seq_tipo = nr_seq_tipo_hist_obrig_w;
					
					if (qt_hist_obrig_w = 0) then
						begin
							select	substr(obter_desc_expressao_idioma(cd_exp_tipo, ds_tipo, obter_nr_seq_idioma(nm_usuario_p)), 1, 80)
							into STRICT	ds_tipo_w
							from	man_tipo_hist
							where	nr_sequencia = nr_seq_tipo_hist_obrig_w;
							
							CALL wheb_mensagem_pck.exibir_mensagem_abort(1129054, 'DS_TIPO_HISTORICO='||ds_tipo_w||';');
						end;
					end if;
				end;
			end if;
		end;
	end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_consiste_hist_sla ( nr_seq_ordem_serv_p man_ordem_servico.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

