-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alterar_tabela_segurado ( nr_seq_contrato_p bigint, nr_seq_segurado_p bigint, nr_seq_contrato_plano_p bigint, nr_seq_plano_p bigint, nr_seq_tabela_nova_p bigint, ie_tipo_alteracao_p text, cd_estabelecimento_p bigint, nm_usuario_p text, dt_ocorrencia_sib_p timestamp, ie_permite_tab_dif_p text, ie_consiste_tab_contr_p text, ie_gerar_cartao_p text, nr_seq_tabela_origem_p bigint, ie_duplica_tabela_p text, ie_gerar_novo_cart_p text, nr_seq_tabela_ant_p bigint) AS $body$
DECLARE


/*	ie_tipo_alteracao_p
	B - tabela do beneficiario
	D - tabela do beneficiario e seus dependetes
	T - todos os beneficiarios com o produto selecionado
	P - Todos os dependentes
	O - Para os beneficiarios da tabela de origem
	R - Todos os beneficiarios do produto selecionado
*/
nr_seq_segurado_w		bigint;
nr_seq_tabela_ant_w		bigint;
nm_tabela_ant_w			varchar(255);
ie_tipo_alteracao_w		varchar(1);
ie_tabela_contrato_w		varchar(1);
ie_tabela_base_w		varchar(1);
nr_seq_tabela_gerada_w		bigint;
nr_contrato_w			bigint;
nr_seq_contrato_w		bigint;
ie_tipo_contratacao_w		varchar(3);
ds_erro_w			varchar(4000) := '';
nm_tabela_atual_w		varchar(255);
nr_seq_tabela_w			bigint;
nr_seq_tabela_atual_w		bigint;
dt_fim_vigencia_w		timestamp;
dt_contratacao_w		timestamp;
dt_alteracao_plano_w		timestamp;
dt_liberacao_w			timestamp;
nr_seq_tab_ant_contr_w		bigint;
nr_seq_tabela_nova_w		bigint;
nr_idade_w			bigint;
nr_seq_tabela_origem_w		pls_tabela_preco.nr_sequencia%type;
nr_seq_titular_w		pls_segurado.nr_seq_titular%type;
ie_tab_preco_diferente_w	varchar(10);
nr_seq_tabela_titular_w		pls_segurado.nr_seq_tabela%type;

c01 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_segurado
	where	((nr_sequencia	= nr_seq_segurado_p)
	or (nr_seq_titular	= nr_seq_segurado_p))
	and	nr_seq_plano	= nr_seq_plano_p
	and	((coalesce(dt_rescisao::text, '') = '') or (dt_rescisao > clock_timestamp()))
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	ie_tipo_alteracao_w	= 'D'
	order by	nr_seq_titular desc;

c02 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_segurado
	where	nr_seq_contrato	= nr_seq_contrato_p
	and	nr_seq_plano	= nr_seq_plano_p
	and	((coalesce(dt_rescisao::text, '') = '') or (dt_rescisao > clock_timestamp()))
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	ie_tipo_alteracao_w	= 'T'
	order by	nr_seq_titular desc;

C03 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_segurado
	where	nr_seq_contrato	= nr_seq_contrato_p
	and	((coalesce(dt_rescisao::text, '') = '') or (dt_rescisao > clock_timestamp()))
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	ie_tipo_alteracao_w	= 'P'
	and	(nr_seq_titular IS NOT NULL AND nr_seq_titular::text <> '')
	order by	nr_seq_titular desc;

C04 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_segurado
	where	nr_seq_contrato	= nr_seq_contrato_p
	and	((coalesce(dt_rescisao::text, '') = '') or (dt_rescisao > clock_timestamp()))
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	ie_tipo_alteracao_w	= 'O'
	and	nr_seq_tabela	= nr_seq_tabela_origem_p
	order by	nr_seq_titular desc;

C05 CURSOR FOR
	SELECT	nr_sequencia,
		dt_liberacao
	from	pls_segurado
	where	nr_seq_contrato	= nr_seq_contrato_p
	and	((coalesce(dt_rescisao::text, '') = '') or (dt_rescisao > clock_timestamp()))
	and	ie_tipo_alteracao_w	= 'R'
	and	nr_seq_plano	= nr_seq_plano_p
	order by	nr_seq_titular desc;


BEGIN
ie_tab_preco_diferente_w	:= coalesce(obter_valor_param_usuario(1202, 171, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento), 'S');

ie_tipo_alteracao_w		:= coalesce(ie_tipo_alteracao_p,'X');
nr_seq_tab_ant_contr_w		:= coalesce(nr_seq_tabela_ant_p, 0);

select	ie_tabela_base,
	coalesce(nr_contrato,0)
into STRICT	ie_tabela_base_w,
	nr_contrato_w
from	pls_tabela_preco
where	nr_sequencia	= nr_seq_tabela_nova_p;

if (ie_tabela_base_w = 'S') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(191855); --Contrato aprovado com sucesso!
end if;

select	max(ie_tipo_contratacao)
into STRICT	ie_tipo_contratacao_w
from	pls_plano
where	nr_sequencia	= nr_seq_plano_p;

if (ie_tipo_alteracao_w = 'X') and (coalesce(nr_seq_contrato_plano_p,0) <> 0) then
	select	nr_seq_tabela
	into STRICT	nr_seq_tabela_atual_w
	from	pls_contrato_plano
	where	nr_sequencia	= nr_seq_contrato_plano_p;
	
	ds_erro_w := pls_consiste_contrato_plano(nr_seq_contrato_p, nr_seq_plano_p, nr_seq_tabela_nova_p, nr_seq_contrato_plano_p, ds_erro_w);
	
	if (coalesce(ds_erro_w,'X') <> 'X') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(191805,'DS_ERRO='||ds_erro_w);
	end if;
	
	if      /*(ie_tipo_contratacao_w <> 'I') and*/
		(coalesce(nr_seq_contrato_p,0) <> nr_contrato_w) then
		CALL pls_gerar_tabela_contrato(	nr_seq_contrato_p,
						nr_seq_plano_p,
						nr_seq_tabela_nova_p,
						cd_estabelecimento_p,
						nm_usuario_p);
		
		select	max(nr_seq_tabela)
		into STRICT	nr_seq_tabela_w
		from	pls_contrato_plano
		where	nr_seq_contrato	= nr_seq_contrato_p
		and	nr_seq_plano	= nr_seq_plano_p
		and	nr_seq_tabela_origem = nr_seq_tabela_nova_p
		and	ie_situacao	= 'A';
		
		if (coalesce(nr_seq_tabela_w,0) <> 0) then
			CALL pls_alterar_tabela_segurado(nr_seq_contrato_p, null, null,
						nr_seq_plano_p, nr_seq_tabela_w, 'O',
						cd_estabelecimento_p, nm_usuario_p, dt_ocorrencia_sib_p,
						ie_permite_tab_dif_p, ie_consiste_tab_contr_p, ie_gerar_cartao_p,
						nr_seq_tabela_atual_w,'N',ie_gerar_novo_cart_p, nr_seq_tab_ant_contr_w);
		end if;
	else
		update	pls_contrato_plano
		set	nr_seq_tabela	= nr_seq_tabela_nova_p
		where	nr_sequencia	= nr_seq_contrato_plano_p;
	end if;
elsif (ie_tipo_alteracao_w in ('B','D','T','P','O','R')) then
	nr_seq_tabela_gerada_w	:= nr_seq_tabela_nova_p;
	
	select	max(a.nr_contrato)
	into STRICT	nr_contrato_w
	from	pls_tabela_preco a
	where	a.nr_sequencia	= nr_seq_tabela_gerada_w;
	
	if (ie_tipo_contratacao_w <> 'I') and (nr_contrato_w <> nr_seq_contrato_p) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(191858);
	end if;
	
	select	nm_tabela,
		coalesce(dt_fim_vigencia,clock_timestamp())
	into STRICT	nm_tabela_atual_w,
		dt_fim_vigencia_w
	from	pls_tabela_preco
	where	nr_sequencia	= nr_seq_tabela_gerada_w;
	
	if (dt_fim_vigencia_w < clock_timestamp()) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(191860);
	end if;
	
	if (ie_tipo_alteracao_w = 'B') and (coalesce(nr_seq_segurado_p,0) <> 0) then
		
		select	nr_seq_tabela,
			substr(obter_descricao_padrao('PLS_TABELA_PRECO','NM_TABELA',nr_seq_tabela),1,255),
			nr_seq_contrato,
			dt_contratacao,
			nr_seq_tabela_origem,
			nr_seq_titular
		into STRICT	nr_seq_tabela_ant_w,
			nm_tabela_ant_w,
			nr_seq_contrato_w,
			dt_contratacao_w,
			nr_seq_tabela_origem_w,
			nr_seq_titular_w
		from	pls_segurado
		where	nr_sequencia	= nr_seq_segurado_p;
		
		if (nr_seq_tabela_nova_p = nr_seq_tabela_ant_w) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(380553);
		end if;
		
		if (dt_contratacao_w > dt_ocorrencia_sib_p) then
			dt_alteracao_plano_w	:= dt_contratacao_w;
		else
			dt_alteracao_plano_w	:= dt_ocorrencia_sib_p;
		end if;
		
		if (ie_tab_preco_diferente_w = 'N') and (nr_seq_titular_w IS NOT NULL AND nr_seq_titular_w::text <> '') then
			select	nr_seq_tabela
			into STRICT	nr_seq_tabela_titular_w
			from	pls_segurado
			where	nr_sequencia = nr_seq_titular_w;
			
			if (nr_seq_tabela_gerada_w <> nr_seq_tabela_titular_w) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(1158074);
			end if;
		end if;
		
		update	pls_segurado
		set	nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp(),
			nr_seq_tabela	= nr_seq_tabela_gerada_w,
			nr_seq_tabela_origem = nr_seq_tabela_ant_w
		where	nr_sequencia	= nr_seq_segurado_p;
		
		CALL pls_gerar_tabela_segurado(nr_seq_segurado_p, nm_usuario_p, 'N');
		
		CALL pls_valida_tabela_preco(nr_seq_tabela_nova_p, nr_seq_tabela_origem_w, nr_seq_segurado_p,
					nr_seq_contrato_w, nr_contrato_w, ie_tipo_contratacao_w,
					ie_permite_tab_dif_p, ie_consiste_tab_contr_p);
		
		CALL pls_preco_beneficiario_pck.gravar_preco_benef(	nr_seq_segurado_p, 'A', 'S',
								dt_alteracao_plano_w, 'N', null, 
								nm_usuario_p, cd_estabelecimento_p);
		
		--Gerar historico
		CALL pls_gerar_segurado_historico(
			nr_seq_segurado_p, '3', clock_timestamp(),
			wheb_mensagem_pck.get_texto(1108783,'NR_SEQ_TABELA_ANT=' || nr_seq_tabela_ant_w || ';' ||'NM_TABELA_ANT='||nm_tabela_ant_w || ';' ||
				'NR_SEQ_TABELA_GERADA=' || nr_seq_tabela_gerada_w || ';' || 'NM_TABELA_GERADA=' || nm_tabela_atual_w),
			substr(obter_desc_expressao(963104),1,255),
			null,
			null, null, null,
			dt_ocorrencia_sib_p, null, null,
			null, null, null,
			null, nm_usuario_p, 'S');
		
		if (ie_gerar_novo_cart_p = 'S') then
			CALL pls_alterar_cartao_ident_benef(nr_seq_segurado_p,dt_ocorrencia_sib_p,cd_estabelecimento_p,nm_usuario_p);
		end if;
		
		CALL pls_ajustar_reajustes_segurado(nr_seq_segurado_p, nr_seq_tabela_ant_w);

	elsif (ie_tipo_alteracao_w = 'D') and (coalesce(nr_seq_segurado_p,0) <> 0) then
		open c01;
		loop
		fetch c01 into
			nr_seq_segurado_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin
			select	nr_seq_tabela,
				substr(obter_descricao_padrao('PLS_TABELA_PRECO','NM_TABELA',nr_seq_tabela),1,255),
				nr_seq_contrato,
				dt_contratacao,
				nr_seq_tabela_origem_w,
				nr_seq_titular
			into STRICT	nr_seq_tabela_ant_w,
				nm_tabela_ant_w,
				nr_seq_contrato_w,
				dt_contratacao_w,
				nr_seq_tabela_origem_w,
				nr_seq_titular_w
			from	pls_segurado
			where	nr_sequencia	= nr_seq_segurado_w;
			
			if (nr_seq_tabela_nova_p = nr_seq_tabela_ant_w) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(380553);
			end if;
			
			if (dt_contratacao_w > dt_ocorrencia_sib_p) then
				dt_alteracao_plano_w	:= dt_contratacao_w;
			else
				dt_alteracao_plano_w	:= dt_ocorrencia_sib_p;
			end if;
			
			update	pls_segurado
			set	nm_usuario	= nm_usuario_p,
				dt_atualizacao	= clock_timestamp(),
				nr_seq_tabela	= nr_seq_tabela_gerada_w,
				nr_seq_tabela_origem = nr_seq_tabela_ant_w
			where	nr_sequencia	= nr_seq_segurado_w;
			
			CALL pls_gerar_tabela_segurado(nr_seq_segurado_w, nm_usuario_p, 'N');
			
			CALL pls_valida_tabela_preco(nr_seq_tabela_nova_p, nr_seq_tabela_origem_w, nr_seq_segurado_w,
						nr_seq_contrato_w, nr_contrato_w, ie_tipo_contratacao_w,
						ie_permite_tab_dif_p, ie_consiste_tab_contr_p);
			
			CALL pls_preco_beneficiario_pck.gravar_preco_benef(	nr_seq_segurado_w, 'A', 'S',
									dt_alteracao_plano_w, 'N', null,
									nm_usuario_p, cd_estabelecimento_p);

			--Gerar historico
			CALL pls_gerar_segurado_historico(
				nr_seq_segurado_w, '3', clock_timestamp(),
				wheb_mensagem_pck.get_texto(1108783,'NR_SEQ_TABELA_ANT=' || nr_seq_tabela_ant_w || ';' ||'NM_TABELA_ANT='||nm_tabela_ant_w || ';' ||
					'NR_SEQ_TABELA_GERADA=' || nr_seq_tabela_gerada_w || ';' || 'NM_TABELA_GERADA=' || nm_tabela_atual_w),
				substr(obter_desc_expressao(963108),1,255),
				null,
				null, null, null,
				dt_ocorrencia_sib_p, null, null,
				null, null, null,
				null, nm_usuario_p, 'S');

			if (ie_gerar_novo_cart_p = 'S') then
				CALL pls_alterar_cartao_ident_benef(nr_seq_segurado_w,dt_ocorrencia_sib_p,cd_estabelecimento_p,nm_usuario_p);
			end if;
			CALL pls_ajustar_reajustes_segurado(nr_seq_segurado_w, nr_seq_tabela_ant_w);

			end;
		end loop;
		close c01;
	elsif (ie_tipo_alteracao_w = 'T') and (coalesce(nr_seq_contrato_p,0) <> 0) then
		open c02;
		loop
		fetch c02 into
			nr_seq_segurado_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
			select	nr_seq_tabela,
				substr(obter_descricao_padrao('PLS_TABELA_PRECO','NM_TABELA',nr_seq_tabela),1,255),
				nr_seq_contrato,
				dt_contratacao,
				nr_seq_tabela_origem,
				nr_seq_titular
			into STRICT	nr_seq_tabela_ant_w,
				nm_tabela_ant_w,
				nr_seq_contrato_w,
				dt_contratacao_w,
				nr_seq_tabela_origem_w,
				nr_seq_titular_w
			from	pls_segurado
			where	nr_sequencia	= nr_seq_segurado_w;
			
			if (nr_seq_tabela_nova_p = nr_seq_tabela_ant_w) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(380553);
			end if;
			
			if (dt_contratacao_w > dt_ocorrencia_sib_p) then
				dt_alteracao_plano_w	:= dt_contratacao_w;
			else
				dt_alteracao_plano_w	:= dt_ocorrencia_sib_p;
			end if;
			
			if	((nr_seq_tab_ant_contr_w = 0) or (nr_seq_tab_ant_contr_w > 0 AND nr_seq_tab_ant_contr_w = nr_seq_tabela_ant_w)) then
				update	pls_segurado
				set	nm_usuario	= nm_usuario_p,
					dt_atualizacao	= clock_timestamp(),
					nr_seq_tabela	= nr_seq_tabela_gerada_w,
					nr_seq_tabela_origem = nr_seq_tabela_ant_w
				where	nr_sequencia	= nr_seq_segurado_w;
			end if;
			
			CALL pls_gerar_tabela_segurado(nr_seq_segurado_w, nm_usuario_p, 'N');

			CALL pls_valida_tabela_preco(nr_seq_tabela_nova_p, nr_seq_tabela_origem_w, nr_seq_segurado_w,
						nr_seq_contrato_w, nr_contrato_w, ie_tipo_contratacao_w,
						ie_permite_tab_dif_p, ie_consiste_tab_contr_p);
			
			CALL pls_preco_beneficiario_pck.gravar_preco_benef(	nr_seq_segurado_w, 'A', 'S',
									dt_alteracao_plano_w, 'N', null,
									nm_usuario_p, cd_estabelecimento_p);
			
			--Gerar historico
			CALL pls_gerar_segurado_historico(
				nr_seq_segurado_w, '3', clock_timestamp(),
				wheb_mensagem_pck.get_texto(1108783,'NR_SEQ_TABELA_ANT=' || nr_seq_tabela_ant_w || ';' ||'NM_TABELA_ANT='||nm_tabela_ant_w || ';' ||
					'NR_SEQ_TABELA_GERADA=' || nr_seq_tabela_gerada_w || ';' || 'NM_TABELA_GERADA=' || nm_tabela_atual_w),
				substr(obter_desc_expressao(963110),1,255),
				null,
				null, null, null,
				dt_ocorrencia_sib_p, null, null,
				null, null, null,
				null, nm_usuario_p, 'S');

			if (ie_gerar_novo_cart_p = 'S') then
				CALL pls_alterar_cartao_ident_benef(nr_seq_segurado_w,dt_ocorrencia_sib_p,cd_estabelecimento_p,nm_usuario_p);
			end if;
			CALL pls_ajustar_reajustes_segurado(nr_seq_segurado_w, nr_seq_tabela_ant_w);

			end;
		end loop;
		close c02;
	elsif (ie_tipo_alteracao_w = 'P') and (coalesce(nr_seq_contrato_p,0) <> 0) then
		open c03;
		loop
		fetch c03 into
			nr_seq_segurado_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
			begin
			select	nr_seq_tabela,
				substr(obter_descricao_padrao('PLS_TABELA_PRECO','NM_TABELA',nr_seq_tabela),1,255),
				nr_seq_contrato,
				dt_contratacao,
				nr_seq_tabela_origem,
				nr_seq_titular
			into STRICT	nr_seq_tabela_ant_w,
				nm_tabela_ant_w,
				nr_seq_contrato_w,
				dt_contratacao_w,
				nr_seq_tabela_origem_w,
				nr_seq_titular_w
			from	pls_segurado
			where	nr_sequencia	= nr_seq_segurado_w;
			
			if (nr_seq_tabela_nova_p = nr_seq_tabela_ant_w) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(380553);
			end if;
			
			if (dt_contratacao_w > dt_ocorrencia_sib_p) then
				dt_alteracao_plano_w	:= dt_contratacao_w;
			else
				dt_alteracao_plano_w	:= dt_ocorrencia_sib_p;
			end if;
			
			if (ie_tab_preco_diferente_w = 'N') and (nr_seq_titular_w IS NOT NULL AND nr_seq_titular_w::text <> '') then
				select	nr_seq_tabela
				into STRICT	nr_seq_tabela_titular_w
				from	pls_segurado
				where	nr_sequencia = nr_seq_titular_w;
				
				if (nr_seq_tabela_gerada_w <> nr_seq_tabela_titular_w) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(1158074);
				end if;
			end if;
			
			update	pls_segurado
			set	nm_usuario	= nm_usuario_p,
				dt_atualizacao	= clock_timestamp(),
				nr_seq_tabela	= nr_seq_tabela_gerada_w,
				nr_seq_tabela_origem = nr_seq_tabela_ant_w
			where	nr_sequencia	= nr_seq_segurado_w;
			
			CALL pls_gerar_tabela_segurado(nr_seq_segurado_w, nm_usuario_p, 'N');
			
			CALL pls_valida_tabela_preco(nr_seq_tabela_nova_p, nr_seq_tabela_origem_w, nr_seq_segurado_w,
						nr_seq_contrato_w, nr_contrato_w, ie_tipo_contratacao_w,
						ie_permite_tab_dif_p, ie_consiste_tab_contr_p);
			
			CALL pls_preco_beneficiario_pck.gravar_preco_benef(	nr_seq_segurado_w, 'A', 'S',
									dt_alteracao_plano_w, 'N', null,
									nm_usuario_p, cd_estabelecimento_p);
			
			--Gerar historico
			CALL pls_gerar_segurado_historico(
				nr_seq_segurado_w, '3', clock_timestamp(),
				wheb_mensagem_pck.get_texto(1108783,'NR_SEQ_TABELA_ANT=' || nr_seq_tabela_ant_w || ';' ||'NM_TABELA_ANT='||nm_tabela_ant_w || ';' ||
					'NR_SEQ_TABELA_GERADA=' || nr_seq_tabela_gerada_w || ';' || 'NM_TABELA_GERADA=' || nm_tabela_atual_w),
				substr(obter_desc_expressao(963108),1,255),
				null,
				null, null, null,
				dt_ocorrencia_sib_p, null, null,
				null, null, null,
				null, nm_usuario_p, 'S');

			if (ie_gerar_novo_cart_p = 'S') then
				CALL pls_alterar_cartao_ident_benef(nr_seq_segurado_w,dt_ocorrencia_sib_p,cd_estabelecimento_p,nm_usuario_p);
			end if;
			CALL pls_ajustar_reajustes_segurado(nr_seq_segurado_w, nr_seq_tabela_ant_w);

			end;
		end loop;
		close c03;
	elsif (ie_tipo_alteracao_w = 'O') and (coalesce(nr_seq_contrato_p,0) <> 0) then
		open c04;
		loop
		fetch c04 into
			nr_seq_segurado_w;
		EXIT WHEN NOT FOUND; /* apply on c04 */
			begin
			select	nr_seq_tabela,
				substr(obter_descricao_padrao('PLS_TABELA_PRECO','NM_TABELA',nr_seq_tabela),1,255),
				nr_seq_contrato,
				dt_contratacao,
				nr_seq_tabela_origem,
				nr_seq_titular
			into STRICT	nr_seq_tabela_ant_w,
				nm_tabela_ant_w,
				nr_seq_contrato_w,
				dt_contratacao_w,
				nr_seq_tabela_origem_w,
				nr_seq_titular_w
			from	pls_segurado
			where	nr_sequencia	= nr_seq_segurado_w;
			
			if (nr_seq_tabela_nova_p = nr_seq_tabela_ant_w) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(380553);
			end if;
			
			if (dt_contratacao_w > dt_ocorrencia_sib_p) then
				dt_alteracao_plano_w	:= dt_contratacao_w;
			else
				dt_alteracao_plano_w	:= dt_ocorrencia_sib_p;
			end if;
			
			if (ie_tab_preco_diferente_w = 'N') and (nr_seq_titular_w IS NOT NULL AND nr_seq_titular_w::text <> '') then
				select	nr_seq_tabela
				into STRICT	nr_seq_tabela_titular_w
				from	pls_segurado
				where	nr_sequencia = nr_seq_titular_w;
				
				if (nr_seq_tabela_gerada_w <> nr_seq_tabela_titular_w) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(1158074);
				end if;
			end if;
			
			update	pls_segurado
			set	nm_usuario	= nm_usuario_p,
				dt_atualizacao	= clock_timestamp(),
				nr_seq_tabela	= nr_seq_tabela_gerada_w,
				nr_seq_tabela_origem = nr_seq_tabela_ant_w
			where	nr_sequencia	= nr_seq_segurado_w;
			
			CALL pls_gerar_tabela_segurado(nr_seq_segurado_w, nm_usuario_p, 'N');
			
			CALL pls_valida_tabela_preco(nr_seq_tabela_nova_p, nr_seq_tabela_origem_w, nr_seq_segurado_w,
						nr_seq_contrato_w, nr_contrato_w, ie_tipo_contratacao_w,
						ie_permite_tab_dif_p, ie_consiste_tab_contr_p);
			
			CALL pls_preco_beneficiario_pck.gravar_preco_benef(	nr_seq_segurado_w, 'A', 'S',
									dt_alteracao_plano_w, 'N', null,
									nm_usuario_p, cd_estabelecimento_p);
			
			--Gerar historico
			CALL pls_gerar_segurado_historico(
				nr_seq_segurado_w, '3', clock_timestamp(),
				wheb_mensagem_pck.get_texto(1108783,'NR_SEQ_TABELA_ANT=' || nr_seq_tabela_ant_w || ';' ||'NM_TABELA_ANT='||nm_tabela_ant_w || ';' ||
					'NR_SEQ_TABELA_GERADA=' || nr_seq_tabela_gerada_w || ';' || 'NM_TABELA_GERADA=' || nm_tabela_atual_w),
				substr(obter_desc_expressao(963108),1,255),
				null,
				null, null, null,
				dt_ocorrencia_sib_p, null, null,
				null, null, null,
				null, nm_usuario_p, 'S');

			if (ie_gerar_novo_cart_p = 'S') then
				CALL pls_alterar_cartao_ident_benef(nr_seq_segurado_w,dt_ocorrencia_sib_p,cd_estabelecimento_p,nm_usuario_p);
			end if;
			CALL pls_ajustar_reajustes_segurado(nr_seq_segurado_w, nr_seq_tabela_ant_w);

			end;
		end loop;
		close c04;
	elsif (ie_tipo_alteracao_w = 'R') and (coalesce(nr_seq_contrato_p,0) <> 0) then
		open C05;
		loop
		fetch C05 into
			nr_seq_segurado_w,
			dt_liberacao_w;
		EXIT WHEN NOT FOUND; /* apply on C05 */
			begin
			
			select	Obter_Idade(b.dt_nascimento,dt_contratacao_w,'A')
			into STRICT	nr_idade_w
			from	pessoa_fisica	b,
				pls_segurado	a
			where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
			and	a.nr_sequencia		= nr_seq_segurado_w;
			
			select	max(b.nr_sequencia)
			into STRICT	nr_seq_tabela_nova_w
			from	pls_plano_preco a,
				pls_tabela_preco b
			where	a.nr_seq_tabela	= b.nr_seq_principal
			and	a.nr_sequencia	= b.nr_seq_faixa_etaria_princ
			and	nr_idade_w between a.qt_idade_inicial and a.qt_idade_final
			and	a.nr_seq_tabela = nr_seq_tabela_nova_p;

			select	nr_seq_tabela,
				substr(obter_descricao_padrao('PLS_TABELA_PRECO','NM_TABELA',nr_seq_tabela),1,255),
				nr_seq_contrato,
				dt_contratacao,
				nr_seq_tabela_origem,
				nr_seq_titular
			into STRICT	nr_seq_tabela_ant_w,
				nm_tabela_ant_w,
				nr_seq_contrato_w,
				dt_contratacao_w,
				nr_seq_tabela_origem_w,
				nr_seq_titular_w
			from	pls_segurado
			where	nr_sequencia	= nr_seq_segurado_w;
			
			if (nr_seq_tabela_nova_p = nr_seq_tabela_ant_w) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(380553);
			end if;
			
			if (dt_contratacao_w > dt_ocorrencia_sib_p) then
				dt_alteracao_plano_w	:= dt_contratacao_w;
			else
				dt_alteracao_plano_w	:= dt_ocorrencia_sib_p;
			end if;
			
			update	pls_segurado
			set	nm_usuario	= nm_usuario_p,
				dt_atualizacao	= clock_timestamp(),
				nr_seq_tabela	= coalesce(nr_seq_tabela_nova_w,nr_seq_tabela_gerada_w),
				nr_seq_tabela_origem = nr_seq_tabela_ant_w
			where	nr_sequencia	= nr_seq_segurado_w;
			
			CALL pls_gerar_tabela_segurado(nr_seq_segurado_w, nm_usuario_p, 'N');

			if (dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '') then
				CALL pls_valida_tabela_preco(nr_seq_tabela_nova_p, nr_seq_tabela_origem_w, nr_seq_segurado_w,
							nr_seq_contrato_w, nr_contrato_w, ie_tipo_contratacao_w,
							ie_permite_tab_dif_p, ie_consiste_tab_contr_p);
				
				CALL pls_preco_beneficiario_pck.gravar_preco_benef(	nr_seq_segurado_w, 'A', 'S',
										dt_alteracao_plano_w, 'N', null,
										nm_usuario_p, cd_estabelecimento_p);
			end if;
			
			--Gerar historico
			CALL pls_gerar_segurado_historico(
				nr_seq_segurado_w, '3', clock_timestamp(),
				wheb_mensagem_pck.get_texto(1108783,'NR_SEQ_TABELA_ANT=' || nr_seq_tabela_ant_w || ';' ||'NM_TABELA_ANT='||nm_tabela_ant_w || ';' ||
					'NR_SEQ_TABELA_GERADA=' || nr_seq_tabela_gerada_w || ';' || 'NM_TABELA_GERADA=' || nm_tabela_atual_w),
				substr(obter_desc_expressao(963104),1,255),
				null,
				null, null, null,
				dt_ocorrencia_sib_p, null, null,
				null, null, null,
				null, nm_usuario_p, 'S');

			if (ie_gerar_novo_cart_p = 'S') then
				CALL pls_alterar_cartao_ident_benef(nr_seq_segurado_w,dt_ocorrencia_sib_p,cd_estabelecimento_p,nm_usuario_p);
			end if;
			CALL pls_ajustar_reajustes_segurado(nr_seq_segurado_w, nr_seq_tabela_ant_w);

			end;
		end loop;
		close C05;
	end if;

	CALL pls_preco_beneficiario_pck.atualizar_desconto_benef(nr_seq_contrato_w, clock_timestamp(), null, 'N', nm_usuario_p, cd_estabelecimento_p);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alterar_tabela_segurado ( nr_seq_contrato_p bigint, nr_seq_segurado_p bigint, nr_seq_contrato_plano_p bigint, nr_seq_plano_p bigint, nr_seq_tabela_nova_p bigint, ie_tipo_alteracao_p text, cd_estabelecimento_p bigint, nm_usuario_p text, dt_ocorrencia_sib_p timestamp, ie_permite_tab_dif_p text, ie_consiste_tab_contr_p text, ie_gerar_cartao_p text, nr_seq_tabela_origem_p bigint, ie_duplica_tabela_p text, ie_gerar_novo_cart_p text, nr_seq_tabela_ant_p bigint) FROM PUBLIC;

