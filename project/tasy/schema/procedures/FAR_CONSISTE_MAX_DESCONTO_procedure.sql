-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE far_consiste_max_desconto ( nr_seq_vendedor_p bigint, nr_seq_pedido_p bigint, cd_material_p bigint, qt_material_p bigint, vl_material_p bigint, cd_estabelecimento_p bigint, ie_tipo_desconto_p bigint) AS $body$
DECLARE

 
nr_seq_item_w		bigint;
ie_permite_w		varchar(1);
pr_desc_item_max_w	double precision;
vl_desc_ped_max_w	double precision;
pr_desc_ped_max_w	double precision;
vl_desconto_max_w	double precision;
pr_desconto_max_w	double precision;
vl_mercadoria_w		double precision;
vl_total_item_w		double precision;
vl_desconto_w		double precision;
vl_desconto_final_w	double precision;
cd_material_w		bigint;
cd_grupo_material_w	smallint;
cd_subgrupo_material_w	smallint;
cd_classe_material_w	integer;
nr_seq_promocao_w	bigint;

c01 CURSOR FOR 
SELECT	coalesce(max(ie_permite),'S') 
from	far_regra_limite_desc 
where	ie_tipo_desconto = 'P' 
and	coalesce(nr_seq_vendedor,nr_seq_vendedor_p) = nr_seq_vendedor_p 
order by	coalesce(nr_seq_vendedor,0);

c02 CURSOR FOR 
SELECT	coalesce(max(vl_desconto_max),0), 
	coalesce(max(pr_desconto_max),0) 
from	far_regra_limite_desc 
where	ie_tipo_desconto = 'P' 
and	coalesce(nr_seq_vendedor,nr_seq_vendedor_p) = nr_seq_vendedor_p 
order by	coalesce(nr_seq_vendedor,0);

c03 CURSOR FOR 
SELECT	coalesce(max(ie_permite),'S') 
from	far_regra_limite_desc 
where	ie_tipo_desconto = 'I' 
and	coalesce(nr_seq_vendedor,nr_seq_vendedor_p) = nr_seq_vendedor_p 
and	coalesce(cd_material,cd_material_w) = cd_material_w 
and	coalesce(cd_grupo_material,cd_grupo_material_w) = cd_grupo_material_w 
and	coalesce(cd_subgrupo_material,cd_subgrupo_material_w) = cd_subgrupo_material_w 
and	coalesce(cd_classe_material,cd_classe_material_w) = cd_classe_material_w 
order by	coalesce(nr_seq_vendedor,0), 
	coalesce(cd_material,0), 
	coalesce(cd_classe_material,0), 
	coalesce(cd_subgrupo_material,0), 
	coalesce(cd_grupo_material,0);

c04 CURSOR FOR 
SELECT	coalesce(max(vl_desconto_max),0), 
	coalesce(max(pr_desconto_max),0) 
from	far_regra_limite_desc 
where	ie_tipo_desconto = 'I' 
and	coalesce(nr_seq_vendedor,nr_seq_vendedor_p) = nr_seq_vendedor_p 
and	coalesce(cd_material,cd_material_w) = cd_material_w 
and	coalesce(cd_grupo_material,cd_grupo_material_w) = cd_grupo_material_w 
and	coalesce(cd_subgrupo_material,cd_subgrupo_material_w) = cd_subgrupo_material_w 
and	coalesce(cd_classe_material,cd_classe_material_w) = cd_classe_material_w 
order by	coalesce(nr_seq_vendedor,0), 
	coalesce(cd_material,0), 
	coalesce(cd_classe_material,0), 
	coalesce(cd_subgrupo_material,0), 
	coalesce(cd_grupo_material,0);


BEGIN 
 
cd_material_w	:= coalesce(cd_material_p,0);
 
open c01;
loop 
fetch c01 into 
	ie_permite_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
end loop;
close c01;
 
if (ie_tipo_desconto_p <> 1) then 
	begin 
	 
	open c02;
	loop 
	fetch c02 into 
		vl_desconto_max_w, 
		pr_desconto_max_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
	end loop;
	close c02;
	 
	select	coalesce(max(vl_mercadoria),0) 
	into STRICT	vl_mercadoria_w 
	from	far_pedido 
	where	nr_sequencia = nr_seq_pedido_p;
 
	-- Consiste por favlor Fixo		 
	if ((coalesce(vl_desconto_max_w,0) < vl_material_p) and (coalesce(vl_desconto_max_w,0) <> 0)) then 
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(279678);
	end if;	
 
	-- Consiste pelo percentual	 
	pr_desc_item_max_w:= ((100/vl_mercadoria_w)*vl_material_p);
		 
	if (coalesce(pr_desconto_max_w,0) < pr_desc_item_max_w) and (coalesce(pr_desconto_max_w,0) <> 0) then 
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(279679);
	end if;
 
	end;
end if;
	 
if (ie_tipo_desconto_p = 1) then 
	begin 
	 
	select	cd_grupo_material, 
		cd_subgrupo_material, 
		cd_classe_material 
	into STRICT	cd_grupo_material_w, 
		cd_subgrupo_material_w, 
		cd_classe_material_w 
	from	estrutura_material_v 
	where	cd_material = cd_material_w;
	 
	open c03;
	loop 
	fetch c03 into 
		ie_permite_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
	end loop;
	close c03;
	 
	if (ie_permite_w = 'S') then 
		begin 
		 
		open c04;
		loop 
		fetch c04 into 
			vl_desconto_max_w, 
			pr_desconto_max_w;
		EXIT WHEN NOT FOUND; /* apply on c04 */
		end loop;
		close c04;
		 
		vl_total_item_w:= far_obter_preco_mat2(cd_material_p,cd_estabelecimento_p,0);
		vl_desconto_w:= far_obter_preco_mat2(cd_material_p,cd_estabelecimento_p,1);
		 
		if (coalesce(vl_desconto_w,0) = coalesce(vl_total_item_w,0)) then 
			vl_desconto_w:= 0;
		end if;
		 
		vl_desconto_final_w:= vl_material_p;
		 
		if (vl_desconto_final_w = 0) then 
			vl_desconto_final_w:= vl_desconto_w;
		end if;	
		 
		-- Consiste por favlor Fixo		 
		if ((coalesce(vl_desconto_max_w,0) < vl_desconto_final_w) and (coalesce(vl_desconto_max_w,0) <> 0)) then 
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(279678);
		end if;
 
		-- Consiste pelo percentual 
		if (vl_total_item_w <> coalesce(vl_desconto_w,0)) then 
			pr_desc_item_max_w:= ((100/(vl_total_item_w+vl_desconto_w))*vl_desconto_final_w);
		elsif (vl_total_item_w = coalesce(vl_desconto_w,0)) then 
                        pr_desc_item_max_w:= ((100/(vl_total_item_w))*vl_desconto_final_w);
		end if;
		 
		if (coalesce(pr_desconto_max_w,0) < pr_desc_item_max_w) and (coalesce(pr_desconto_max_w,0) <> 0) then 
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(279679);
		end if;
 
		end;
	end if;
 
	end;
end if;
			 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE far_consiste_max_desconto ( nr_seq_vendedor_p bigint, nr_seq_pedido_p bigint, cd_material_p bigint, qt_material_p bigint, vl_material_p bigint, cd_estabelecimento_p bigint, ie_tipo_desconto_p bigint) FROM PUBLIC;

