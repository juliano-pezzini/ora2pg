-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE executa_procedimento_conta (nr_prescricao_p text, nr_atendimento_p text, ds_msg_aviso_p INOUT text, qt_prescr_procedimento_p INOUT bigint, ds_execucao_p INOUT text, qt_atend_agenda_p INOUT bigint, ds_confirmar_p INOUT text, nr_seq_agenda_pac_p INOUT bigint, nr_seq_agenda_cons_p INOUT bigint, ie_tipo_agenda_p INOUT text, ds_evento_p INOUT text, ds_erro_p INOUT text, ds_setor_p INOUT text, nm_usuario_p text) AS $body$
DECLARE

 
qt_prescr_proc_erro_w		bigint;
ie_perm_exec_prescr_lib_w	varchar(1);
qt_prescr_procedimento_w	bigint;


BEGIN 
 
ie_perm_exec_prescr_lib_w := Obter_param_Usuario(916, 214, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_perm_exec_prescr_lib_w);
 
if (ie_perm_exec_prescr_lib_w <> 'S') then 
	begin 
	select  	count(*) 
	into STRICT		qt_prescr_proc_erro_w 
	from   	prescr_procedimento 
	where  	nr_prescricao 	= nr_prescricao_p 
	and   	ie_erro    	= 125;
 
	if (qt_prescr_proc_erro_w > 0) then 
		ds_msg_aviso_p := wheb_mensagem_pck.get_texto(110615);
	end if;
	end;
end if;
 
select 	count(*) qt_prescr_procedimento 
into STRICT 	qt_prescr_procedimento_w 
from 	prescr_procedimento 
where 	ie_aprovacao_execucao 	= 'N' 
and  	nr_prescricao 		= nr_prescricao_p;
 
if (qt_prescr_procedimento_w > 0) then 
	ds_execucao_p := wheb_mensagem_pck.get_texto(110621);
end if;
 
select 	count(*) 
into STRICT	qt_atend_agenda_p 
from 	agenda_paciente 
where 	obter_tipo_agenda(cd_agenda) = 2 
and 	nr_atendimento = nr_atendimento_p;
 
ds_confirmar_p := wheb_mensagem_pck.get_texto(110628);
 
select 	coalesce(max(nr_seq_agenda),0) nr_seq_agenda_pac, 
		coalesce(max(nr_seq_agecons),0) nr_seq_agenda_cons, 
		coalesce(max(obter_tipo_agenda_seq(nr_seq_agenda,'E')),0) ie_tipo_agenda 
into STRICT	nr_seq_agenda_pac_p, 
		nr_seq_agenda_cons_p, 
		ie_tipo_agenda_p 
from  	prescr_medica 
where 	nr_prescricao = nr_prescricao_p;
 
ds_evento_p := obter_se_existe_evento(12);
 
ds_erro_p := obter_regra_qtde_proc_prescr(nr_prescricao_p, nr_atendimento_p, ds_erro_p, null);
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE executa_procedimento_conta (nr_prescricao_p text, nr_atendimento_p text, ds_msg_aviso_p INOUT text, qt_prescr_procedimento_p INOUT bigint, ds_execucao_p INOUT text, qt_atend_agenda_p INOUT bigint, ds_confirmar_p INOUT text, nr_seq_agenda_pac_p INOUT bigint, nr_seq_agenda_cons_p INOUT bigint, ie_tipo_agenda_p INOUT text, ds_evento_p INOUT text, ds_erro_p INOUT text, ds_setor_p INOUT text, nm_usuario_p text) FROM PUBLIC;

