-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alterar_quant_val_analise (nr_sequencia_p bigint, qt_aceita_p bigint, vl_aceito_p bigint, qt_negada_p bigint, vl_negado_p bigint, nr_seq_grupo_p bigint, nm_usuario_p text, cd_estabelecimento_p text) AS $body$
DECLARE


qt_aceita_w		double precision;
vl_aceito_w		double precision;
qt_negada_w		double precision;
vl_negado_w		double precision;
qt_recurso_w		double precision;
vl_recurso_w		double precision;
ds_observacao_w		varchar(4000);
nr_seq_conta_w		bigint;
nr_seq_analise_w	bigint;
ie_tipo_item_w		varchar(1);
ds_item_w		varchar(255);
nr_identeificador_w	bigint;


BEGIN
select	coalesce(qt_aceita,0),
	coalesce(vl_aceito,0),
	coalesce(qt_negada,0),
	coalesce(vl_negado,0),
	coalesce(qt_recurso,0),
	coalesce(vl_recurso,0)
into STRICT	qt_aceita_w,
	vl_aceito_w,
	qt_negada_w,
	vl_negado_w,
	qt_recurso_w,
	vl_recurso_w
from	w_pls_discussao_item
where	nr_sequencia = nr_sequencia_p;

if (qt_aceita_p + qt_negada_p > qt_recurso_w) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(114566);
elsif (vl_aceito_p + vl_negado_p > vl_recurso_w) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(114567);
end if;

if (qt_aceita_w <> qt_aceita_p) then
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
				'Quantidade aceita:'||chr(13)||chr(10)||
				chr(9)||'Anterior: '||qt_aceita_w||' - Modificada: '||qt_aceita_p||chr(13)||chr(10);
end if;

if (vl_aceito_w <> vl_aceito_p) then
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
				'Valor aceito:'||chr(13)||chr(10)||
				chr(9)||'Anterior: '||vl_aceito_w||' - Modificada: '||vl_aceito_p||chr(13)||chr(10);
end if;

if (qt_negada_w <> qt_negada_p) then
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
				'Quantidade negada:'||chr(13)||chr(10)||
				chr(9)||'Anterior: '||qt_negada_w||' - Modificada: '||qt_negada_p||chr(13)||chr(10);
end if;

if (vl_negado_w <> vl_negado_p) then
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)||
				'Valor negado:'||chr(13)||chr(10)||
				chr(9)||'Anterior: '||vl_negado_w||' - Modificada: '||vl_negado_p||chr(13)||chr(10);
end if;

select	max(nr_seq_conta),
	max(nr_seq_analise),
	max(ie_tipo_item),
	max(ds_item),
	max(nr_identificador)
into STRICT	nr_seq_conta_w,
	nr_seq_analise_w,
	ie_tipo_item_w,
	ds_item_w,
	nr_identeificador_w
from	w_pls_discussao_item
where	nr_sequencia = nr_sequencia_p;

if (coalesce(ds_observacao_w,'X') <> 'X') then
	CALL pls_inserir_hist_analise(nr_seq_conta_w, nr_seq_analise_w,27,nr_sequencia_p,ie_tipo_item_w, null,null,
				'Modificado pelo auditor '||obter_nome_usuario(nm_usuario_p)||'.'||chr(13)||chr(10)||
				'Item '||nr_identeificador_w||' - '||ds_item_w||'.'||chr(13)||chr(10)||ds_observacao_w,
				nr_seq_grupo_p, nm_usuario_p, cd_estabelecimento_p);
else
	CALL pls_inserir_hist_analise(nr_seq_conta_w, nr_seq_analise_w,27,nr_sequencia_p,ie_tipo_item_w, null,null,
				'Aceito parcialmente.',nr_seq_grupo_p, nm_usuario_p, cd_estabelecimento_p);
end if;

update	w_pls_discussao_item
set	qt_aceita			= coalesce(qt_aceita_p,qt_aceita_w),
	vl_aceito			= coalesce(vl_aceito_p,vl_aceito_w),
	qt_negada			= coalesce(qt_negada_p,qt_negada_w),
	vl_negado			= coalesce(vl_negado_p,vl_negado_w),
	ie_situacao			= 'P'
where	nr_sequencia			= nr_sequencia_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alterar_quant_val_analise (nr_sequencia_p bigint, qt_aceita_p bigint, vl_aceito_p bigint, qt_negada_p bigint, vl_negado_p bigint, nr_seq_grupo_p bigint, nm_usuario_p text, cd_estabelecimento_p text) FROM PUBLIC;

