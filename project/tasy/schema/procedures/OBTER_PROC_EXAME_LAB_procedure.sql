-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_proc_exame_lab (cd_exame_p text, nr_atendimento_p bigint, cd_procedimento_p INOUT bigint, ie_origem_proced_p INOUT bigint, nr_seq_exame_p INOUT bigint) AS $body$
DECLARE

 
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
nr_seq_exame_w			bigint;
cd_convenio_w			bigint;
cd_categoria_w			varchar(10);
cd_estabelecimento_w		bigint;
ie_prioridade_edicao_w		varchar(01);	
IE_PRIORIDADE_AJUSTE_PROC_w	varchar(01);
CD_EDICAO_AMB_W			bigint;
VL_CH_HONORARIOS_W		double precision	:= 1;
VL_CH_CUSTO_OPER_W		double precision	:= 1;
VL_M2_FILME_W			double precision	:= 0;
tx_ajuste_geral_w		double precision	:= 1;
dt_inicio_vigencia_w		timestamp;
cd_proc_exame_w			bigint;
ie_tipo_atendimento_w		smallint;
ie_origem_proc_exame_w		bigint;
nr_seq_exame_proc_w		bigint;
nr_seq_cbhpm_edicao_w		bigint;
ie_tipo_convenio_w		integer;
ie_origem_proc_regra_w		bigint;
ie_origem_proc_filtro_w		bigint;
cd_plano_convenio_w		varchar(10);

C01 CURSOR FOR 
	SELECT	coalesce(c.cd_procedimento, a.cd_procedimento), 
		coalesce(c.ie_origem_proced, a.ie_origem_proced), 
		a.nr_seq_exame 
	FROM procedimento b, exame_laboratorio a
LEFT OUTER JOIN exame_lab_convenio c ON (a.nr_seq_exame = c.nr_seq_exame)
WHERE a.cd_procedimento		 = b.cd_procedimento and a.ie_origem_proced	   	 = b.ie_origem_proced  and coalesce(c.cd_convenio, cd_convenio_w) = cd_convenio_w and coalesce(c.cd_edicao_amb, coalesce(cd_edicao_amb_w,0)) = coalesce(cd_edicao_amb_w,0) and a.cd_exame		= cd_exame_p and coalesce(c.ie_tipo_convenio,ie_tipo_convenio_w) = ie_tipo_convenio_w and coalesce(c.ie_situacao,'A') 		= 'A' and coalesce(c.dt_inicio_vigencia,clock_timestamp()) <= clock_timestamp() and coalesce(c.dt_fim_vigencia,clock_timestamp()) 	>= clock_timestamp() and coalesce(c.ie_origem_proced_regra, coalesce(ie_origem_proc_regra_w,0)) = coalesce(ie_origem_proc_regra_w,0) and ((ie_origem_proc_filtro = ie_origem_proc_filtro_w) or (coalesce(ie_origem_proc_filtro::text, '') = '')) and coalesce(c.cd_plano_convenio, coalesce(cd_plano_convenio_w,0)) = coalesce(cd_plano_convenio_w,0) order by	coalesce(c.cd_categoria,0),  
		coalesce(c.cd_convenio, 0), 
		coalesce(c.cd_edicao_amb, 0),  
		coalesce(c.dt_inicio_vigencia,clock_timestamp()), 
		coalesce(c.ie_origem_proced_regra,0);


BEGIN 
 
select	MAX(cd_procedimento), 
	max(ie_origem_proced), 
	max(nr_seq_exame) 
into STRICT	cd_proc_exame_w, 
	ie_origem_proc_exame_w, 
	nr_seq_exame_proc_w 
from	exame_laboratorio 
where	cd_exame	= cd_exame_p;
 
select 	coalesce(max(a.cd_convenio),0), 
	coalesce(max(a.cd_categoria),'0'), 
	coalesce(max(b.cd_estabelecimento),0), 
	coalesce(max(b.ie_tipo_atendimento),0), 
	coalesce(max(a.cd_plano_convenio),0) 
into STRICT 	cd_convenio_w, 
	cd_categoria_w, 
	cd_estabelecimento_w, 
	ie_tipo_atendimento_w, 
	cd_plano_convenio_w 
from 	atendimento_paciente b, 
	Atend_categoria_convenio a 
where	a.nr_atendimento		= nr_atendimento_p 
and	a.nr_atendimento		= b.nr_atendimento 
and 	a.dt_inicio_vigencia		= 
	(SELECT max(dt_inicio_vigencia) 
	from Atend_categoria_convenio b 
	where nr_atendimento		= nr_atendimento_p);
 
 
begin	 
select 	max(ie_tipo_convenio) 
into STRICT	ie_tipo_convenio_w 
from	convenio 
where	cd_convenio = cd_convenio_w;
exception 
	when others then 
	ie_tipo_convenio_w := null;		
end;
	 
	 
 
select	coalesce(max(ie_prioridade_edicao_amb), 'N'), 
	coalesce(max(IE_PRIORIDADE_AJUSTE_PROC), 'N') 
into STRICT	ie_prioridade_edicao_w, 
	IE_PRIORIDADE_AJUSTE_PROC_w 
from	parametro_faturamento 
where	cd_estabelecimento	= cd_estabelecimento_w;
 
if (ie_prioridade_edicao_w = 'N') then	 
	SELECT	coalesce(max(CD_EDICAO_AMB),0) 
	INTO STRICT	CD_EDICAO_AMB_W 
	FROM 	CONVENIO_AMB 
	WHERE (CD_ESTABELECIMENTO   = cd_estabelecimento_w) 
	AND (CD_CONVENIO      = cd_convenio_w) 
	AND (coalesce(IE_SITUACAO,'A')  = 'A') 
	AND 	(DT_INICIO_VIGENCIA   = 
			(SELECT	MAX(DT_INICIO_VIGENCIA) 
			FROM 	CONVENIO_AMB A	 
			WHERE (A.CD_ESTABELECIMENTO 	= cd_estabelecimento_w) 
			AND (A.CD_CONVENIO     	= CD_CONVENIO_w) 
			AND (coalesce(A.IE_SITUACAO,'A')	= 'A') 
			AND (A.DT_INICIO_VIGENCIA 	<= clock_timestamp())));
else 
	SELECT * FROM Obter_Edicao_Proc_Conv(cd_estabelecimento_w, CD_CONVENIO_W, CD_CATEGORIA_W, clock_timestamp(), cd_proc_exame_w, CD_EDICAO_AMB_W, VL_CH_HONORARIOS_W, VL_CH_CUSTO_OPER_W, VL_M2_FILME_W, dt_inicio_vigencia_w, tx_ajuste_geral_w, nr_seq_cbhpm_edicao_w) INTO STRICT CD_EDICAO_AMB_W, VL_CH_HONORARIOS_W, VL_CH_CUSTO_OPER_W, VL_M2_FILME_W, dt_inicio_vigencia_w, tx_ajuste_geral_w, nr_seq_cbhpm_edicao_w;
end if;
 
select	max(ie_origem_proced) 
into STRICT	ie_origem_proc_regra_w 
from	edicao_amb 
where	cd_edicao_amb = cd_edicao_amb_w;
 
ie_origem_proc_filtro_w:= Obter_Origem_Proced_Cat( cd_estabelecimento_w, ie_tipo_atendimento_w, ie_tipo_convenio_w, cd_convenio_w, cd_categoria_w);
 
open C01;
loop 
fetch C01 into	 
	cd_procedimento_w, 
	ie_origem_proced_w, 
	nr_seq_exame_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	cd_procedimento_w	:= cd_procedimento_w;
	ie_origem_proced_w	:= ie_origem_proced_w;
	nr_seq_exame_w		:= nr_seq_exame_w;
	end;
end loop;
close C01;
 
if (coalesce(nr_seq_exame_w,0) = 0) then	 
	cd_procedimento_w	:= cd_proc_exame_w;
	ie_origem_proced_w	:= ie_origem_proc_exame_w;
	nr_seq_exame_w		:= nr_seq_exame_proc_w;
end if;
 
cd_procedimento_p		:= cd_procedimento_w;
ie_origem_proced_p		:= ie_origem_proced_w;
nr_seq_exame_p			:= nr_seq_exame_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_proc_exame_lab (cd_exame_p text, nr_atendimento_p bigint, cd_procedimento_p INOUT bigint, ie_origem_proced_p INOUT bigint, nr_seq_exame_p INOUT bigint) FROM PUBLIC;

