-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasylab_cadastrar_paciente ( nm_pessoa_fisica_p text, dt_nascimento_p timestamp, ie_sexo_p text, nr_ddd_celular_p text, nr_telefone_celular_p text, nr_cpf_p text, nr_identidade_p text, ie_tipo_pessoa_p bigint, nm_contato_mae_p text, nr_seq_externo_p bigint, cd_erro_p INOUT bigint, ds_erro_p INOUT text, cd_pessoa_fisica_p INOUT text) AS $body$
DECLARE


/*
Observação
Os códigos de erros seguem o domínio 6876. O campo DS_ERRO_P deve receber o erro apenas em caso de exception do sistema.
*/
cd_pessoa_fisica_w	varchar(10);
nr_sequencia_w		bigint;


BEGIN
cd_erro_p	:= 0;

CALL tasy_atualizar_dados_sessao(nr_seq_externo_p);

begin

CALL gravar_log_lab(90001, 	nm_pessoa_fisica_p			||' - '||
						to_char(dt_nascimento_p)	||' - '||
						ie_sexo_p					||' - '||
						nr_ddd_celular_p			||' - '||
						nr_telefone_celular_p		||' - '||
						coalesce(nr_cpf_p, '-1')			||' - '||
						coalesce(nr_identidade_p, '-1')	||' - '||
						ie_tipo_pessoa_p			||' - '||
						coalesce(nm_contato_mae_p, '-1'), 'intTasyLab', null, 'TASYLAB');

if (coalesce(nm_pessoa_fisica_p::text, '') = '') then
	cd_erro_p	:= 2;
elsif (coalesce(dt_nascimento_p::text, '') = '') then
	cd_erro_p	:= 3;
end if;

if (cd_erro_p = 0) then

	select	max(a.cd_pessoa_fisica)
	into STRICT	cd_pessoa_fisica_w
	from	pessoa_fisica a
	where	a.dt_nascimento = dt_nascimento_p
	and		lower(replace(a.nm_pessoa_fisica,' ','')) = lower(replace(nm_pessoa_fisica_p, ' ', ''))
	and		(((a.nr_cpf IS NOT NULL AND a.nr_cpf::text <> '') and a.nr_cpf = coalesce(nr_cpf_p,'-1')) or ((a.nr_identidade IS NOT NULL AND a.nr_identidade::text <> '') and a.nr_identidade = coalesce(nr_identidade_p,'-1')) or
			 ((SELECT max(b.nm_contato) from compl_pessoa_fisica b where b.cd_pessoa_fisica = a.cd_pessoa_fisica and b.ie_tipo_complemento = 5) is not null and (select max(b.nm_contato) from compl_pessoa_fisica b where b.cd_pessoa_fisica = a.cd_pessoa_fisica and b.ie_tipo_complemento = 5) = coalesce(nm_contato_mae_p,'-1')));

	if (coalesce(cd_pessoa_fisica_w::text, '') = '') then
		select	nextval('pessoa_fisica_seq')
		into STRICT	cd_pessoa_fisica_w
		;

		insert into pessoa_fisica(	cd_pessoa_fisica,
						nm_pessoa_fisica,
						dt_nascimento,
						ie_sexo,
						nr_ddd_celular,
						nr_telefone_celular,
						ie_revisar,
						nr_cpf,
						nr_identidade,
						ie_tipo_pessoa,
						dt_atualizacao,
						dt_atualizacao_nrec,
						nm_usuario,
						nm_usuario_nrec)
				values (	cd_pessoa_fisica_w,
						nm_pessoa_fisica_p,
						dt_nascimento_p,
						ie_sexo_p,
						nr_ddd_celular_p,
						nr_telefone_celular_p,
						'N',
						nr_cpf_p,
						nr_identidade_p,
						ie_tipo_pessoa_p,
						clock_timestamp(),
						clock_timestamp(),
						'TasyLab-CadPac',
						'TasyLab-CadPac');


		insert into compl_pessoa_fisica(
				cd_pessoa_fisica,
				nr_sequencia,
				ie_tipo_complemento,
				nm_contato,
				nm_usuario,
				nm_usuario_nrec,
				dt_atualizacao,
				dt_atualizacao_nrec)
			values (
				cd_pessoa_fisica_w,
				1,
				5,
				nm_contato_mae_p,
				'TasyLab-CadPac',
				'TasyLab-CadPac',
				clock_timestamp(),
				clock_timestamp());

	end if;
	cd_pessoa_fisica_p	:= cd_pessoa_fisica_w;
end if;
exception
	when others then
		cd_erro_p	:= 1;
		ds_erro_p	:= substr('Não foi inserido o registro do paciente '||sqlerrm,1,2000);
	end;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasylab_cadastrar_paciente ( nm_pessoa_fisica_p text, dt_nascimento_p timestamp, ie_sexo_p text, nr_ddd_celular_p text, nr_telefone_celular_p text, nr_cpf_p text, nr_identidade_p text, ie_tipo_pessoa_p bigint, nm_contato_mae_p text, nr_seq_externo_p bigint, cd_erro_p INOUT bigint, ds_erro_p INOUT text, cd_pessoa_fisica_p INOUT text) FROM PUBLIC;

