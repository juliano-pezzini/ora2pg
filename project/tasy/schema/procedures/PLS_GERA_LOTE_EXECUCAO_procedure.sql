-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gera_lote_execucao ( nr_seq_lote_p pls_cta_lote_processo.nr_sequencia%type, nm_usuario_p text) AS $body$
DECLARE

 
dt_mes_comp_w	pls_cta_lote_processo.dt_mes_competencia%type;
nr_seq_lote_w	pls_cta_lote_processo.nr_sequencia%type;
nr_seq_conta_w	pls_conta.nr_sequencia%type;
nr_index_w	integer := 0;
tb_sequencias_w pls_util_cta_pck.t_number_table;
tb_seq_contas_w	pls_util_cta_pck.t_number_table;

C01 CURSOR FOR 
	SELECT	nr_seq_conta 
	from	pls_cta_lote_proc_pend 
	where	nr_seq_lote_processo = nr_seq_lote_p;
	
procedure inserir_contas( tb_seq_contas_p pls_util_cta_pck.t_number_table, 
			 tb_sequencia_p pls_util_cta_pck.t_number_table) is 
;
BEGIN
 
	if (tb_seq_contas_p.count > 0) then 
		forall i in tb_seq_contas_p.first..tb_seq_contas_p.last 
			insert into pls_cta_lote_proc_conta(nr_sequencia, nr_seq_lote_processo, nr_seq_conta, nm_usuario, dt_atualizacao) 
					   values (tb_sequencia_p(i), nr_seq_lote_w, tb_seq_contas_p(i), nm_usuario_p, clock_timestamp());
		commit;
	end if;
 
end;
					 
begin 
 
	select	dt_mes_competencia 
	into STRICT	dt_mes_comp_w 
	from	pls_cta_lote_processo 
	where	nr_sequencia = nr_seq_lote_p;
 
	insert into pls_cta_lote_processo(nr_sequencia, nm_usuario, nm_lote, 
		   dt_mes_competencia, dt_atualizacao) 
	   values (nextval('pls_cta_lote_processo_seq'), nm_usuario_p, 'Lote gerado à partir do lote '||nr_seq_lote_p, 
		   dt_mes_comp_w, clock_timestamp()) returning nr_sequencia into nr_seq_lote_w;	
		      
	nr_index_w := 0;
	tb_seq_contas_w.delete;
	for r_C01_w in C01 loop 
		nr_index_w := nr_index_w + 1;
		tb_seq_contas_w(nr_index_w) := r_c01_w.nr_seq_conta;
		 
		select	nextval('pls_cta_lote_proc_conta_seq') 
		into STRICT	tb_sequencias_w(nr_index_w) 
		;
		 
		if (nr_index_w > pls_util_pck.qt_registro_transacao_w) then 
			inserir_contas(tb_seq_contas_w, tb_sequencias_w);
			nr_index_w:= 0;
			tb_seq_contas_w.delete;
			tb_sequencias_w.delete;
		end if;		
	end loop;
	inserir_contas(tb_seq_contas_w, tb_sequencias_w);
	 
	--Limpa as contas pendentes para que não sejam gerados mais lotes à partir delas 
	delete from pls_cta_lote_proc_pend where nr_seq_lote_processo = nr_seq_lote_p;
	 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gera_lote_execucao ( nr_seq_lote_p pls_cta_lote_processo.nr_sequencia%type, nm_usuario_p text) FROM PUBLIC;

