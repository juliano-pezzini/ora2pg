-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_geracao_opme ( nm_tabela_p text, nr_prescricao_p bigint, ds_msg_p INOUT text, nm_usuario_p text, ie_tipo_reg_p text default null, cd_procedimento_p bigint default null) AS $body$
DECLARE

 
ie_tipo_w		varchar(15);
qt_dias_limite_w	smallint;
qt_idade_min_w		smallint;
qt_idade_max_w		smallint;
dt_prescricao_w		timestamp;
qt_idade_w		varchar(15);
qt_dias_prescr_w	bigint;
ds_msg_w		varchar(255) := '';
qt_opme_w		bigint := 0;
qt_protese_ms_w		bigint := 0;
qt_protese_mi_w		bigint := 0;
qt_ortese_ms_w		bigint := 0;
qt_ortese_mi_w		bigint := 0;
qt_meio_loc_w		bigint := 0;
qt_ortese_coluna_w	bigint := 0;
cd_procedimento_w	bigint;		
qt_prescr_opm_w		bigint := 0;
ie_opm_modo_compl_w	varchar(1);			
			 
C01 CURSOR FOR 
SELECT	ie_tipo, 
	qt_dias_limite, 
	qt_idade_min, 
	qt_idade_max, 
	cd_procedimento 
from	regra_prescr_opm;			
			 

BEGIN 
 
ie_opm_modo_compl_w := obter_param_usuario(924, 1160, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_opm_modo_compl_w);
 
if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then 
 
	if (nm_tabela_p = 'PRESCR_OPME') then 
		select	count(*) 
		into STRICT	qt_opme_w						 
		from	prescr_opme o, 
			prescr_medica p 
		where	o.nr_prescricao		= p.nr_prescricao 
		and	p.cd_pessoa_fisica	= (	SELECT	m.cd_pessoa_fisica 
							from	prescr_medica m 
							where	m.nr_prescricao = nr_prescricao_p);
			 
			if (qt_opme_w > 0) then 
				select	max(dt_prescricao), 
					obter_dados_pf(max(cd_pessoa_fisica),'I'), 
					round(clock_timestamp() - max(dt_prescricao)) 
				into STRICT	dt_prescricao_w, 
					qt_idade_w, 
					qt_dias_prescr_w 
				from	prescr_opme o, 
					prescr_medica p 
				where	o.nr_prescricao		= p.nr_prescricao 
				and	p.cd_pessoa_fisica	= (	SELECT	m.cd_pessoa_fisica 
									from	prescr_medica m 
									where	m.nr_prescricao = nr_prescricao_p);
			end if;
	end if;
 
	if (nm_tabela_p = 'PRESCR_PROTESE_MS') then 
		select	count(*) 
		into STRICT	qt_protese_ms_w						 
		from	prescr_protese_ms o, 
			prescr_medica p 
		where	o.nr_prescricao		= p.nr_prescricao 
		and	p.cd_pessoa_fisica	= (	SELECT	m.cd_pessoa_fisica 
							from	prescr_medica m 
							where	m.nr_prescricao = nr_prescricao_p);						
				 
			if (qt_protese_ms_w > 0) then 
				select	max(dt_prescricao), 
					obter_dados_pf(max(cd_pessoa_fisica),'I'), 
					round(clock_timestamp() - max(dt_prescricao)) 
				into STRICT	dt_prescricao_w, 
					qt_idade_w, 
					qt_dias_prescr_w 
				from	prescr_protese_ms o, 
					prescr_medica p 
				where	o.nr_prescricao		= p.nr_prescricao 
				and	p.cd_pessoa_fisica	= (	SELECT	m.cd_pessoa_fisica 
									from	prescr_medica m 
									where	m.nr_prescricao = nr_prescricao_p);
			end if;
	end if;
 
	if (nm_tabela_p = 'PRESCR_PROTESE_MI') then	 
		select	count(*) 
		into STRICT	qt_protese_mi_w						 
		from	prescr_protese_mi o, 
			prescr_medica p 
		where	o.nr_prescricao		= p.nr_prescricao 
		and	p.cd_pessoa_fisica	= (	SELECT	m.cd_pessoa_fisica 
							from	prescr_medica m 
							where	m.nr_prescricao = nr_prescricao_p);						
				 
			if (qt_protese_mi_w > 0) then 
				select	max(dt_prescricao), 
					obter_dados_pf(max(cd_pessoa_fisica),'I'), 
					round(clock_timestamp() - max(dt_prescricao)) 
				into STRICT	dt_prescricao_w, 
					qt_idade_w, 
					qt_dias_prescr_w 
				from	prescr_protese_mi o, 
					prescr_medica p 
				where	o.nr_prescricao		= p.nr_prescricao 
				and	p.cd_pessoa_fisica	= (	SELECT	m.cd_pessoa_fisica 
									from	prescr_medica m 
									where	m.nr_prescricao = nr_prescricao_p);
			end if;
	end if;	
 
	if (nm_tabela_p = 'PRESCR_ORTESE_MS') then 
		select	count(*) 
		into STRICT	qt_ortese_ms_w						 
		from	prescr_ortese_ms o, 
			prescr_medica p 
		where	o.nr_prescricao		= p.nr_prescricao 
		and	p.cd_pessoa_fisica	= (	SELECT	m.cd_pessoa_fisica 
							from	prescr_medica m 
							where	m.nr_prescricao = nr_prescricao_p);						
				 
			if (qt_ortese_ms_w > 0) then 
				select	max(dt_prescricao), 
					obter_dados_pf(max(cd_pessoa_fisica),'I'), 
					round(clock_timestamp() - max(dt_prescricao)) 
				into STRICT	dt_prescricao_w, 
					qt_idade_w, 
					qt_dias_prescr_w 
				from	prescr_ortese_ms o, 
					prescr_medica p 
				where	o.nr_prescricao		= p.nr_prescricao 
				and	p.cd_pessoa_fisica	= (	SELECT	m.cd_pessoa_fisica 
									from	prescr_medica m 
									where	m.nr_prescricao = nr_prescricao_p);
			end if;		
	end if;
 
	if (nm_tabela_p = 'PRESCR_ORTESE_MI') then 
		select	count(*) 
		into STRICT	qt_ortese_mi_w						 
		from	prescr_ortese_mi o, 
			prescr_medica p 
		where	o.nr_prescricao		= p.nr_prescricao 
		and	p.cd_pessoa_fisica	= (	SELECT	m.cd_pessoa_fisica 
							from	prescr_medica m 
							where	m.nr_prescricao = nr_prescricao_p);						
				 
			if (qt_ortese_mi_w > 0) then 
				select	max(dt_prescricao), 
					obter_dados_pf(max(cd_pessoa_fisica),'I'), 
					round(clock_timestamp() - max(dt_prescricao)) 
				into STRICT	dt_prescricao_w, 
					qt_idade_w, 
					qt_dias_prescr_w 
				from	prescr_ortese_mi o, 
					prescr_medica p 
				where	o.nr_prescricao		= p.nr_prescricao 
				and	p.cd_pessoa_fisica	= (	SELECT	m.cd_pessoa_fisica 
									from	prescr_medica m 
									where	m.nr_prescricao = nr_prescricao_p);
			end if;	
	end if;
 
	if (nm_tabela_p = 'PRESCR_MEIO_LOCOMOCAO') then	 
		select	count(*) 
		into STRICT	qt_meio_loc_w						 
		from	prescr_meio_locomocao o, 
			prescr_medica p 
		where	o.nr_prescricao		= p.nr_prescricao 
		and	p.cd_pessoa_fisica	= (	SELECT	m.cd_pessoa_fisica 
							from	prescr_medica m 
							where	m.nr_prescricao = nr_prescricao_p);						
				 
			if (qt_meio_loc_w > 0) then 
				select	max(dt_prescricao), 
					obter_dados_pf(max(cd_pessoa_fisica),'I'), 
					round(clock_timestamp() - max(dt_prescricao)) 
				into STRICT	dt_prescricao_w, 
					qt_idade_w, 
					qt_dias_prescr_w 
				from	prescr_meio_locomocao o, 
					prescr_medica p 
				where	o.nr_prescricao		= p.nr_prescricao 
				and	p.cd_pessoa_fisica	= (	SELECT	m.cd_pessoa_fisica 
									from	prescr_medica m 
									where	m.nr_prescricao = nr_prescricao_p);
			end if;	
	end if;	
 
	if (nm_tabela_p = 'PRESCR_ORTESE_COLUNA') then 
		select	count(*) 
		into STRICT	qt_ortese_coluna_w						 
		from	prescr_ortese_coluna o, 
			prescr_medica p 
		where	o.nr_prescricao		= p.nr_prescricao 
		and	p.cd_pessoa_fisica	= (	SELECT	m.cd_pessoa_fisica 
							from	prescr_medica m 
							where	m.nr_prescricao = nr_prescricao_p);						
				 
			if (qt_ortese_coluna_w > 0) then 
				select	max(dt_prescricao), 
					obter_dados_pf(max(cd_pessoa_fisica),'I'), 
					round(clock_timestamp() - max(dt_prescricao)) 
				into STRICT	dt_prescricao_w, 
					qt_idade_w, 
					qt_dias_prescr_w 
				from	prescr_ortese_coluna o, 
					prescr_medica p 
				where	o.nr_prescricao		= p.nr_prescricao 
				and	p.cd_pessoa_fisica	= (	SELECT	m.cd_pessoa_fisica 
									from	prescr_medica m 
									where	m.nr_prescricao = nr_prescricao_p);
			end if;	
	end if;	
	 
	 
	if (nm_tabela_p = 'PRESCR_OPM') then 
		select	count(*) 
		into STRICT	qt_prescr_opm_w						 
		from	prescr_opm o, 
			prescr_medica p 
		where	o.nr_prescricao		= p.nr_prescricao 
		and	p.cd_pessoa_fisica	= (	SELECT	m.cd_pessoa_fisica 
							from	prescr_medica m 
							where	m.nr_prescricao = nr_prescricao_p);						
				 
			if (qt_prescr_opm_w > 0) then 
				select	max(dt_prescricao), 
					obter_dados_pf(max(cd_pessoa_fisica),'I'), 
					round(clock_timestamp() - max(dt_prescricao)) 
				into STRICT	dt_prescricao_w, 
					qt_idade_w, 
					qt_dias_prescr_w 
				from	prescr_opm o, 
					prescr_medica p 
				where	o.nr_prescricao		= p.nr_prescricao 
				and	p.cd_pessoa_fisica	= (	SELECT	m.cd_pessoa_fisica 
									from	prescr_medica m 
									where	m.nr_prescricao = nr_prescricao_p);
									 
									 
				 					 
									 
			end if;	
	end if;	
	 
		 
	open C01;
	loop 
	fetch C01 into 
		ie_tipo_w, 
		qt_dias_limite_w, 
		qt_idade_min_w, 
		qt_idade_max_w, 
		cd_procedimento_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		 
		if (ie_opm_modo_compl_w = 'N') then 
			if ((coalesce(ie_tipo_w,ie_tipo_reg_p) = ie_tipo_reg_p) and (coalesce(cd_procedimento_w,cd_procedimento_p) = cd_procedimento_p) and (qt_prescr_opm_w > 0)) then 
				if	((qt_idade_w >= qt_idade_min_w) and (qt_idade_w <= qt_idade_max_w) and (qt_dias_prescr_w <= qt_dias_limite_w)) then 
					--'Não é possível gerar nova prescrição pois já existe uma prescrição válida conforme a "Regra bloqueio prescrição OPM" '; 
					ds_msg_w := substr(obter_texto_tasy(239279, wheb_usuario_pck.get_nr_seq_idioma),1,255);
				end if;
			end if;
		else 
			if	((ie_tipo_w = 'CAR') and (nm_tabela_p = 'PRESCR_OPME') and (qt_opme_w > 0)) or 
				((ie_tipo_w = 'PMS') and (nm_tabela_p = 'PRESCR_PROTESE_MS') and (qt_protese_ms_w > 0)) or 
				((ie_tipo_w = 'PMI') and (nm_tabela_p = 'PRESCR_PROTESE_MI') and (qt_protese_mi_w > 0)) or 
				((ie_tipo_w = 'OMS') and (nm_tabela_p = 'PRESCR_ORTESE_MS') and (qt_ortese_ms_w > 0)) or 
				((ie_tipo_w = 'OMI') and (nm_tabela_p = 'PRESCR_ORTESE_MI') and (qt_ortese_mi_w > 0)) or 
				((ie_tipo_w = 'MAL') and (nm_tabela_p = 'PRESCR_MEIO_LOCOMOCAO') and (qt_meio_loc_w > 0)) or 
				((ie_tipo_w = 'OCO') and (nm_tabela_p = 'PRESCR_ORTESE_COLUNA') and (qt_ortese_coluna_w > 0)) then 
				if	((qt_idade_w >= qt_idade_min_w) and (qt_idade_w <= qt_idade_max_w) and (qt_dias_prescr_w <= qt_dias_limite_w)) then 
					--'Não é possível gerar nova prescrição pois já existe uma prescrição válida conforme a "Regra bloqueio prescrição OPM" '; 
					ds_msg_w := substr(obter_texto_tasy(239279, wheb_usuario_pck.get_nr_seq_idioma),1,255);
				end if;
			end if;
		end if;
		end;
	end loop;
	close C01;
 
end if;
 
ds_msg_p	:= ds_msg_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_geracao_opme ( nm_tabela_p text, nr_prescricao_p bigint, ds_msg_p INOUT text, nm_usuario_p text, ie_tipo_reg_p text default null, cd_procedimento_p bigint default null) FROM PUBLIC;

