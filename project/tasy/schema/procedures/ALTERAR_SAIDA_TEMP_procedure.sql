-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_saida_temp ( nr_atendimento_p bigint, ie_opcao_p text) AS $body$
DECLARE

/* ie_opcao_p = S - saida / R - retorno */


-- indentation only
ie_gerar_clinical_notes_w varchar(1) := 'N';
cd_evolucao_w    evolucao_paciente.cd_evolucao%type;
nr_seq_interno_w bigint;
			

BEGIN

ie_gerar_clinical_notes_w := obter_param_usuario(281, 1598, Obter_perfil_ativo, obter_usuario_ativo, wheb_usuario_pck.get_cd_estabelecimento, ie_gerar_clinical_notes_w);

if ( ie_gerar_clinical_notes_w = 'S') then
select Max( nr_seq_interno)
into STRICT nr_seq_interno_w
from atend_paciente_unidade
where nr_atendimento = nr_atendimento_p;
end if;

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then

	if (ie_opcao_p = 'S') then
		update	atend_paciente_unidade
		set	dt_saida_temporaria = clock_timestamp(),
			dt_retorno_saida_temporaria  = NULL,
			nm_usuario = coalesce(obter_usuario_ativo,nm_usuario),
			dt_atualizacao = clock_timestamp()
		where	nr_atendimento = nr_atendimento_p;


                if (ie_gerar_clinical_notes_w = 'S' and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_seq_interno_w IS NOT NULL AND nr_seq_interno_w::text <> '')) then
                cd_evolucao_w := clinical_notes_pck.gerar_soap(nr_atendimento_p, nr_seq_interno_w, 'TEMP_LEAVE', null, 'P', 1, cd_evolucao_w, ie_opcao_p);
                update atend_paciente_unidade
                set cd_evolucao = cd_evolucao_w
                where	nr_atendimento = nr_atendimento_p;
                end if;

	elsif (ie_opcao_p = 'R') then
		update	atend_paciente_unidade
		set	dt_retorno_saida_temporaria = clock_timestamp(),
			nm_usuario = coalesce(obter_usuario_ativo,nm_usuario),
			dt_atualizacao = clock_timestamp()
		where	nr_atendimento = nr_atendimento_p;

		update WOCUPACAO_SAIDA_TEMPORARIA
        set dt_final_saida = clock_timestamp()
        where NR_ATENDIMENTO = nr_atendimento_p
        and	(DT_START_DATE IS NOT NULL AND DT_START_DATE::text <> '')
		and coalesce(DT_FINAL_SAIDA::text, '') = '';

		if (ie_gerar_clinical_notes_w = 'S' and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_seq_interno_w IS NOT NULL AND nr_seq_interno_w::text <> '')) then
                        cd_evolucao_w := clinical_notes_pck.gerar_soap(nr_atendimento_p, nr_seq_interno_w, 'TEMP_LEAVE', null, 'P', 1, cd_evolucao_w, ie_opcao_p);
                        update atend_paciente_unidade
                        set cd_evolucao = cd_evolucao_w
                        where	nr_atendimento = nr_atendimento_p;
                end if;
	end if;	
	
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_saida_temp ( nr_atendimento_p bigint, ie_opcao_p text) FROM PUBLIC;

