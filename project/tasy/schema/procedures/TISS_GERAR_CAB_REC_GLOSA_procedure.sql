-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_gerar_cab_rec_glosa (nr_seq_rec_guia_p bigint, nr_seq_lote_hist_p bigint, nm_usuario_p text, nr_seq_guia_nova_p INOUT bigint) AS $body$
DECLARE


cd_convenio_w			bigint;
cd_estabelecimento_w		bigint;
cd_ans_w			varchar(100);

nr_seq_tiss_rec_w		bigint;
nr_seq_rec_prot_w		bigint;
nr_seq_rec_guia_w		bigint;

nr_guia_prest_rec_w		varchar(20);
nm_operadora_w			varchar(255);
cd_interno_w			varchar(30);
nm_prestador_w			varchar(255);
nr_lote_w			varchar(20);
nr_protocolo_w			varchar(20);
nr_guia_prestador_w		varchar(20);
cd_senha_w			varchar(20);
nr_seq_motivo_glosa_w		bigint;
ds_justificativa_w		varchar(255);
cd_motivo_glosa_w		varchar(4);
dt_envio_w			timestamp;
cd_autorizacao_w	tiss_recurso_glosa_guia.cd_autorizacao%type;

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.cd_prestador,
	a.nm_prestador,
	coalesce(Substr(tiss_obter_lote_recurso_glosa(a.nr_sequencia,null,null),1,20),a.nr_lote) nr_lote,
	a.nr_protocolo,
	b.nr_guia_origem,
	b.cd_senha,
	b.nr_seq_motivo_glosa,
	b.ds_justificativa,
	b.cd_autorizacao
from	tiss_recurso_glosa_prot a,
	tiss_recurso_glosa_guia b
where	a.nr_sequencia	= b.nr_seq_rec_prot
and	b.nr_sequencia	= nr_seq_rec_guia_p;


BEGIN

select	max(a.cd_convenio),
	max(a.cd_estabelecimento),
	max(d.cd_ans),
	substr(max(d.ds_razao_social),1,255),
	max(b.dt_envio)
into STRICT	cd_convenio_w,
	cd_estabelecimento_w,
	cd_ans_w,
	nm_operadora_w,
	dt_envio_w
from	lote_auditoria a,
	lote_audit_hist b,
	convenio c,
	pessoa_juridica d
where	a.nr_sequencia	= b.nr_seq_lote_audit
and	a.cd_convenio	= c.cd_convenio
and	c.cd_cgc	= d.cd_cgc
and	b.nr_sequencia	= nr_seq_lote_hist_p;

open C01;
loop
fetch C01 into
	nr_guia_prest_rec_w,
	cd_interno_w,
	nm_prestador_w,
	nr_lote_w,
	nr_protocolo_w,
	nr_guia_prestador_w,
	cd_senha_w,
	nr_seq_motivo_glosa_w,
	ds_justificativa_w,
	cd_autorizacao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	nextval('w_tiss_recurso_seq')
	into STRICT	nr_seq_tiss_rec_w
	;

	insert into w_tiss_recurso(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_lote_audit_hist,
		cd_ans,
		nr_guia_prestador,
		nm_operadora,
		ie_objeto_recurso,
		nr_guia_operadora,
		cd_interno,
		nm_contratado,
		dt_recurso)
	values (nr_seq_tiss_rec_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_lote_hist_p,
		cd_ans_w,
		nr_guia_prest_rec_w,
		nm_operadora_w,
		'2', --Recurso de Guia
		null,
		cd_interno_w,
		nm_prestador_w,
		dt_envio_w);

	select	nextval('w_tiss_recurso_prot_seq')
	into STRICT	nr_seq_rec_prot_w
	;

	insert into w_tiss_recurso_prot(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_recurso,
		nr_seq_recurso_prot,
		nr_lote,
		nr_protocolo,
		cd_motivo_glosa,
		ds_justificativa)
	values (nr_seq_rec_prot_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_tiss_rec_w,
		nr_guia_prest_rec_w,
		nr_lote_w,
		nr_protocolo_w,
		null,
		null);

	select	nextval('w_tiss_recurso_guia_seq')
	into STRICT	nr_seq_rec_guia_w
	;

	select	max(cd_motivo_tiss)
	into STRICT	cd_motivo_glosa_w
	from	tiss_motivo_glosa
	where	nr_sequencia	= nr_seq_motivo_glosa_w;

	insert	into w_tiss_recurso_guia(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_rec_prot,
		nr_guia_prestador,
		cd_senha,
		cd_motivo_glosa,
		ds_justificativa,
		nr_seq_guia_recurso,
		cd_autorizacao)
	values (nr_seq_rec_guia_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_rec_prot_w,
		nr_guia_prestador_w,
		cd_senha_w,
		cd_motivo_glosa_w,
		ds_justificativa_w,
		nr_seq_rec_guia_p,
		cd_autorizacao_w);
	end;
end loop;
close C01;

nr_seq_guia_nova_p	:= nr_seq_rec_guia_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_gerar_cab_rec_glosa (nr_seq_rec_guia_p bigint, nr_seq_lote_hist_p bigint, nm_usuario_p text, nr_seq_guia_nova_p INOUT bigint) FROM PUBLIC;

