-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_regra_sped_reg ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_dominio_w			bigint;
cd_registro_w			varchar(255);
cd_versao_w			ctb_regra_sped.cd_versao%type;
ie_tipo_ecd_w			ctb_regra_sped.ie_tipo_ecd%type;
ie_arquivo_w			varchar(15);
ie_forma_escrituracao_w		varchar(15);
ie_gerar_w			varchar(1);

C01 CURSOR FOR
SELECT	a.vl_dominio
from	valor_dominio_v a
where	a.cd_dominio = cd_dominio_w
and   	a.ie_situacao = 'A'
and	not exists (	SELECT 1
			from	ctb_regra_sped_registro y
			where	y.nr_seq_regra_sped	= nr_sequencia_p
			and	y.cd_registro		= a.vl_dominio)
order by a.nr_seq_apresent;


BEGIN

select	max(ie_forma_escrituracao),
	coalesce(max(ie_arquivo),'ECD'),
	max(cd_versao),
	max(coalesce(ie_tipo_ecd,0))
into STRICT	ie_forma_escrituracao_w,
	ie_arquivo_w,
	cd_versao_w,
	ie_tipo_ecd_w
from	ctb_regra_sped
where	nr_sequencia	= nr_sequencia_p;

if (ie_arquivo_w = 'ECD') then
	cd_dominio_w	:= 3508;
elsif (ie_arquivo_w = 'FCONT') then
	cd_dominio_w	:= 4463;
end if;


open C01;
loop
fetch C01 into
	cd_registro_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	ie_gerar_w	:= 'S';
	if (ie_arquivo_w = 'ECD') then
		begin
	
		if (ie_forma_escrituracao_w = 'B') then
			begin
			if (cd_registro_w in ('0150','0180','I053','I075','I200','I250','I500','I510','I550','I555')) then
				ie_gerar_w	:= 'N';
			end if;
			if (cd_registro_w = '0035') and (ie_tipo_ecd_w in ('0','2')) then
				ie_gerar_w	:= 'N';
			end if;
			end;
		elsif (ie_forma_escrituracao_w = 'G') then
			begin
			if (cd_registro_w in ('I012','I015','I053','I300','I310','I500','I510','I550','I555','I157','J200','J210','J215')) then
				ie_gerar_w	:= 'N';
			end if;
			if (cd_registro_w = '0035') and (ie_tipo_ecd_w in ('0','2')) then
				ie_gerar_w	:= 'N';
			end if;
			if (cd_registro_w = 'I051') and (cd_versao_w = '2') then
				ie_gerar_w	:= 'N';
			end if;			
			end;		
		elsif (ie_forma_escrituracao_w = 'S') then
			begin
			if (cd_registro_w in ('I012','I015','I053','I151','I300','I310','I500','I510','I550','I555')) then
				ie_gerar_w	:= 'N';
			end if;
			if (cd_registro_w = '0035') and (ie_tipo_ecd_w in ('0','2')) then
				ie_gerar_w	:= 'N';
			end if;
			end;			
		elsif (ie_forma_escrituracao_w = 'Z') then
			begin
			if (cd_registro_w in ('I012','I015','I500','I510','I550')) then
				ie_gerar_w	:= 'S';
			end if;
			If (cd_registro_w In ('I020','I052','I053','I151','I157','I200','I250','I300','I310','I350','I355','J005','J100','J150','J200','J210','J215','J800')) then
				ie_gerar_w	:= 'N';
			end If;
			if (cd_registro_w = '0035') and (ie_tipo_ecd_w in ('0','2')) then
				ie_gerar_w	:= 'N';
			end if;
			end;
		elsIf (ie_forma_escrituracao_w = 'A') then
			begIn
			If (cd_registro_w In ('0035','I052','I053','I151','I157','I300','I310','I350','I355','I500','I510','I550','I555','J005','J100','J150','J200','J210','J215','J800','K001','K030','K100','K110','K115','K200','K300','K310','K315','K990')) then
				ie_gerar_w	:= 'N';
			end If;
			if (cd_registro_w in ('I012','I015')) then
				ie_gerar_w	:= 'S';
			end if;
			end;
		elsIf (ie_forma_escrituracao_w = 'R') then
			begin
			If (cd_registro_w In ('I053','I151','I157','I300','I310','I500','I510','I550','I555','J210','J215')) then
				ie_gerar_w	:= 'N';
			end If;
			if (cd_registro_w in ('I012','I015')) then
				ie_gerar_w	:= 'S';
			end if;
			if (cd_registro_w = '0035') and (ie_tipo_ecd_w in ('0','2')) then
				ie_gerar_w	:= 'N';
			end if;
			end;			
		end if;
		end;
	elsif (ie_arquivo_w = 'FCONT') then
		begin
		
		if (cd_registro_w in ('M155','M160')) then
			ie_gerar_w	:= 'N';
		end if;
		end;
	end if;
	
	
	insert into ctb_regra_sped_registro(
		nr_sequencia,
		nr_seq_regra_sped,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_registro,
		ie_gerar)
	values (nextval('ctb_regra_sped_registro_seq'),
		nr_sequencia_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_registro_w,
		ie_gerar_w);
	end;
end loop;
close C01;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_regra_sped_reg ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

