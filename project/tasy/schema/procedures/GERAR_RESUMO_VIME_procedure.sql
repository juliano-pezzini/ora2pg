-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_resumo_vime ( cd_paciente_p text, nr_atendimento_p bigint, nr_prescricao_p bigint, cd_material_p bigint, ie_tipo_item_p text, ie_atend_pac_p text, ie_origem_inf_p text, cd_unidade_medida_p INOUT text, dt_inicio_util_p INOUT text, dt_fim_util_p INOUT text, qt_dose_min_p INOUT bigint, qt_dose_susp_p INOUT bigint, qt_dose_max_p INOUT bigint, qt_dose_med_p INOUT bigint, qt_dose_tot_p INOUT bigint, ds_unid_med_p INOUT text, qt_dia_util_p INOUT bigint, qt_dia_cor_p INOUT bigint, pr_dia_intern_p INOUT bigint, qt_dose_pend_p INOUT bigint, dt_primeira_util_p INOUT text, dt_ultima_util_p INOUT text, qt_dose_total_medic_p INOUT bigint) AS $body$
DECLARE

 
 
cd_unidade_medida_dose_w		varchar(30) := null;
cd_unidade_medida_dose_ww	varchar(30) := null;
cd_unidade_medida_aux_w		varchar(30);
qt_dose_w			double precision;
dt_horario_w			timestamp;
dt_horario_ant_w		timestamp;
nr_dose_w			bigint := 0;
ds_unidade_medida_w		varchar(50);
cd_pessoa_fisica_w		varchar(10);
ds_UM_comum_w			varchar(2000);
ie_atend_pac_w			varchar(10) := ie_atend_pac_p;

C01 CURSOR FOR 
SELECT	count(*), 
	b.cd_unidade_medida_dose 
from	prescr_mat_hor b, 
	prescr_medica a 
where	a.nr_prescricao		= b.nr_prescricao 
and	((nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '' AND a.nr_atendimento = nr_atendimento_p) or 
	 ((ie_atend_pac_w	= 'PAC') and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and (a.cd_pessoa_fisica 	= cd_pessoa_fisica_w))) 
and	b.cd_material		in (SELECT	distinct x.cd_material 
					from	Material x 
					where	ie_origem_inf_p = 'PA' 
					and 	x.nr_seq_ficha_tecnica = cd_material_p 
					
Union All
 
					Select 	cd_material_p 
					 
					where 	ie_origem_inf_p <> 'PA' ) 
and	coalesce(b.dt_suspensao::text, '') = '' 
and	b.dt_horario		< clock_timestamp() 
and	b.qt_dose		> 0 
and	coalesce(b.ie_horario_especial,'N') = 'N' 
and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S' 
group by b.cd_unidade_medida_dose 
order by 1;

C02 CURSOR FOR 
SELECT (Obter_dose_convertida(b.cd_material,b.qt_dose, b.cd_unidade_medida_dose, cd_unidade_medida_dose_w)), 
	b.dt_horario, 
	b.cd_unidade_medida 
from	prescr_mat_hor b, 
	prescr_medica a 
where	a.nr_prescricao		= b.nr_prescricao 
and	((nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '' AND a.nr_atendimento	= nr_atendimento_p) or 
	 ((ie_atend_pac_w	= 'PAC') and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and (a.cd_pessoa_fisica 	= cd_pessoa_fisica_w))) 
and	b.cd_material		in (SELECT	distinct x.cd_material 
					from	Material x 
					where	ie_origem_inf_p = 'PA' 
					and 	x.nr_seq_ficha_tecnica = cd_material_p 
					
Union All
 
					Select 	cd_material_p 
					 
					where 	ie_origem_inf_p <> 'PA' ) 
and	coalesce(b.dt_suspensao::text, '') = '' 
and	b.dt_horario		< clock_timestamp() 
and	b.qt_dose		> 0 
and	coalesce(b.ie_horario_especial,'N') = 'N' 
and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S' 
order by dt_horario;


BEGIN 
qt_dia_util_p		:= 0;
qt_dose_min_p		:= 999999;
qt_dose_max_p		:= 0;
qt_dose_tot_p		:= 0;
dt_horario_ant_w	:= clock_timestamp() + interval '30 days';
 
if (coalesce(nr_atendimento_p::text, '') = '') then 
	ie_atend_pac_w	:= 'PAC';
end if;
	 
select	coalesce(max(cd_pessoa_fisica),'0') 
into STRICT	cd_pessoa_fisica_w 
from	prescr_medica 
where	((nr_prescricao IS NOT NULL AND nr_prescricao::text <> '' AND nr_prescricao = nr_prescricao_p) or 
	((coalesce(nr_prescricao_p::text, '') = '') and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_atendimento = nr_atendimento_p)));
 
if (cd_pessoa_fisica_w	= '0') then 
	cd_pessoa_fisica_w	:= cd_paciente_p;
end if;	
	 
if (coalesce(cd_unidade_medida_p::text, '') = '') then 
	open C01;
	loop 
	fetch C01 into 
		qt_dose_w, 
		cd_unidade_medida_dose_ww;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		cd_unidade_medida_dose_w	:= cd_unidade_medida_dose_ww;
	end loop;
	close C01;
end if;
if (ie_origem_inf_p = 'PA') and (ds_UM_comum_w IS NOT NULL AND ds_UM_comum_w::text <> '') and 
	(((cd_unidade_medida_p IS NOT NULL AND cd_unidade_medida_p::text <> '') and (position(cd_unidade_medida_p||'#0' in ds_UM_comum_w) = 0)) or (coalesce(cd_unidade_medida_p::text, '') = '')) then 
	begin 
	cd_unidade_medida_dose_w := substr(ds_UM_comum_w, 1, position('#0' in ds_UM_comum_w) -1);
	end;
end if;
 
if (coalesce(cd_unidade_medida_dose_w::text, '') = '') then 
	cd_unidade_medida_dose_w := cd_unidade_medida_p;
end if;
 
 
 
open C02;
loop 
fetch C02 into 
	qt_dose_w, 
	dt_horario_w, 
	cd_unidade_medida_aux_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin 
	if (qt_dose_min_p > qt_dose_w) then 
		qt_dose_min_p	:= qt_dose_w;
	end if;
 
	if (qt_dose_max_p < qt_dose_w) then 
		qt_dose_max_p	:= qt_dose_w;
	end if;
 
	qt_dose_tot_p	:= qt_dose_tot_p + qt_dose_w;
 
	nr_dose_w	:= nr_dose_w + 1;
 
	if (coalesce(dt_inicio_util_p::text, '') = '') or (to_date(dt_inicio_util_p, 'dd/mm/yyyy hh24:mi:ss') > dt_horario_w) then 
		dt_inicio_util_p	:= to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss');
	end if;
 
	if (coalesce(dt_fim_util_p::text, '') = '') or (to_date(dt_fim_util_p, 'dd/mm/yyyy hh24:mi:ss') < dt_horario_w) then 
		dt_fim_util_p	:= to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss');
	end if;
 
	if (trunc(dt_horario_ant_w,'dd') <> trunc(dt_horario_w,'dd')) then 
		begin 
		qt_dia_util_p		:= qt_dia_util_p + 1;
		dt_horario_ant_w	:= dt_horario_w;
		end;
	end if;
 
	end;
end loop;
close C02;
 
qt_dose_med_p	:= dividir(qt_dose_tot_p,nr_dose_w);
 
select	coalesce(Obter_Unidade_Medida(cd_unidade_medida_dose_w),cd_unidade_medida_dose_w) 
into STRICT	ds_unid_med_p
;
 
--if	(nvl(cd_unidade_medida_p,'X') = 'X') then 
cd_unidade_medida_p	:= cd_unidade_medida_dose_w;
--else 
--	cd_unidade_medida_p	:= cd_unidade_medida_p; 
--end if; 
 
select	min(b.dt_horario), 
	max(b.dt_horario) 
into STRICT	dt_horario_ant_w, 
	dt_horario_w 
from	prescr_mat_hor b, 
	prescr_medica a 
where	a.nr_prescricao		= b.nr_prescricao 
and	((nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '' AND a.nr_atendimento 	= nr_atendimento_p) or 
	 ((ie_atend_pac_w	= 'PAC') and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and (a.cd_pessoa_fisica 	= cd_pessoa_fisica_w))) 
and	b.cd_material		in (SELECT	distinct x.cd_material 
					from	Material x 
					where	ie_origem_inf_p = 'PA' 
					and 	x.nr_seq_ficha_tecnica = cd_material_p 
					
Union All
 
					SELECT 	cd_material_p 
					 
					where 	ie_origem_inf_p <> 'PA' ) 
and	b.dt_horario		< clock_timestamp() 
and	coalesce(b.dt_suspensao::text, '') = '' 
--and	b.cd_unidade_medida_dose= cd_unidade_medida_dose_w 
and	coalesce(b.ie_horario_especial,'N') = 'N' 
and	b.qt_dose		> 0 
and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S';
If (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then 
	qt_dia_cor_p	:= Obter_Dias_Internacao(nr_atendimento_p);
else 
	qt_dia_cor_p	:= obter_dias_entre_datas(dt_horario_ant_w,dt_horario_w) + 1;
end if;
pr_dia_intern_p	:= 100;
if (qt_dia_cor_p > 0) then 
	pr_dia_intern_p	:= round(((qt_dia_util_p * 100) / qt_dia_cor_p),2);
end if;
 
if (qt_dose_min_p = 999999) then 
	qt_dose_min_p := 0;
end if;
 
dt_primeira_util_p	:= to_char(dt_horario_ant_w, 'dd/mm/yyyy hh24:mi:ss');
 
select	coalesce(sum(Obter_dose_convertida(b.cd_material,b.qt_dose, b.cd_unidade_medida_dose, cd_unidade_medida_dose_w)),0) 
into STRICT	qt_dose_susp_p 
from	prescr_mat_hor b, 
	prescr_medica a 
where	a.nr_prescricao		= b.nr_prescricao 
and	((nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '' AND a.nr_atendimento	= nr_atendimento_p) or 
	 ((ie_atend_pac_w	= 'PAC') and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and (a.cd_pessoa_fisica 	= cd_pessoa_fisica_w))) 
and	b.cd_material		in (SELECT	distinct x.cd_material 
					from	Material x 
					where	ie_origem_inf_p = 'PA' 
					and 	x.nr_seq_ficha_tecnica = cd_material_p 
					
Union All
 
					SELECT 	cd_material_p 
					 
					where 	ie_origem_inf_p <> 'PA' ) 
and	(b.dt_suspensao IS NOT NULL AND b.dt_suspensao::text <> '') 
and	b.qt_dose		> 0 
and	coalesce(b.ie_horario_especial,'N') = 'N' 
and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S';
 
SELECT	MAX(b.DT_FIM_HORARIO) 
into STRICT	dt_horario_w 
FROM	Prescr_mat_hor b 
WHERE	b.nr_prescricao		IN 	(SELECT	a.nr_prescricao 
					FROM	prescr_medica a 
					WHERE	((nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '' AND a.nr_atendimento	= nr_atendimento_p) OR 
						 ((ie_atend_pac_w	= 'PAC') AND (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') AND (a.cd_pessoa_fisica 	= cd_pessoa_fisica_w))) 
					AND	clock_timestamp() BETWEEN a.DT_INICIO_PRESCR AND a.DT_VALIDADE_PRESCR 
					AND	(coalesce(DT_LIBERACAO_MEDICO, DT_LIBERACAO) IS NOT NULL AND (coalesce(DT_LIBERACAO_MEDICO, DT_LIBERACAO))::text <> '')) 
AND	b.cd_material		IN (select	distinct x.cd_material 
					from	Material x 
					where	ie_origem_inf_p = 'PA' 
					and 	x.nr_seq_ficha_tecnica = cd_material_p 
					
Union All
 
					SELECT 	cd_material_p 
					 
					where 	ie_origem_inf_p <> 'PA' ) 
and	b.dt_horario		< clock_timestamp() 
and	coalesce(b.dt_suspensao::text, '') = '' 
and	b.qt_dose		> 0 
and	(b.DT_FIM_HORARIO IS NOT NULL AND b.DT_FIM_HORARIO::text <> '') 
and	coalesce(b.ie_horario_especial,'N') = 'N' 
and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S';
 
dt_ultima_util_p	:= to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss');
 
if (dt_ultima_util_p IS NOT NULL AND dt_ultima_util_p::text <> '') then 
	dt_fim_util_p := null;
end if;
 
Select	count(*) 
into STRICT	qt_dose_pend_p 
from	prescr_mat_hor b, 
	prescr_medica a 
where	a.nr_prescricao		= b.nr_prescricao 
and	((nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '' AND a.nr_atendimento	= nr_atendimento_p) or 
	 ((ie_atend_pac_w	= 'PAC') and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and (a.cd_pessoa_fisica 	= cd_pessoa_fisica_w))) 
and	b.cd_material		in (SELECT	distinct x.cd_material 
					from	Material x 
					where	ie_origem_inf_p = 'PA' 
					and 	x.nr_seq_ficha_tecnica = cd_material_p 
					
Union All
 
					SELECT 	cd_material_p 
					 
					where 	ie_origem_inf_p <> 'PA' ) 
and	coalesce(b.dt_suspensao::text, '') = '' 
and	coalesce(b.dt_fim_horario::text, '') = '' 
and	coalesce(b.ie_horario_especial,'N') = 'N' 
and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S';
 
select 	coalesce(sum(qt_total_dose),0)qt_total 
into STRICT 	qt_dose_total_medic_p 
from (	SELECT	trunc(sum(obter_dose_convertida(a.cd_material, a.qt_dose, coalesce(a.cd_unidade_medida_dose,a.cd_unidade_medida),'mg')),2) qt_total_dose 
		from	prescr_material a, 
			prescr_medica	b 
		where	a.nr_prescricao = b.nr_prescricao 
		and	a.cd_material	= cd_material_p 
		and 	a.ie_agrupador = 1 
		and	b.cd_pessoa_fisica = cd_paciente_p 
		
union all
 
		SELECT 	trunc(sum(obter_dose_convertida(a.cd_material, a.qt_dose_especial, coalesce(a.cd_unidade_medida_dose,a.cd_unidade_medida),'mg')),2) qt_total_dose 
		from	prescr_material a, 
			prescr_medica	b 
		where	a.nr_prescricao = b.nr_prescricao 
		and	a.cd_material	= cd_material_p 
		and 	a.ie_agrupador = 1 
		and	b.cd_pessoa_fisica = cd_paciente_p) alias10;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_resumo_vime ( cd_paciente_p text, nr_atendimento_p bigint, nr_prescricao_p bigint, cd_material_p bigint, ie_tipo_item_p text, ie_atend_pac_p text, ie_origem_inf_p text, cd_unidade_medida_p INOUT text, dt_inicio_util_p INOUT text, dt_fim_util_p INOUT text, qt_dose_min_p INOUT bigint, qt_dose_susp_p INOUT bigint, qt_dose_max_p INOUT bigint, qt_dose_med_p INOUT bigint, qt_dose_tot_p INOUT bigint, ds_unid_med_p INOUT text, qt_dia_util_p INOUT bigint, qt_dia_cor_p INOUT bigint, pr_dia_intern_p INOUT bigint, qt_dose_pend_p INOUT bigint, dt_primeira_util_p INOUT text, dt_ultima_util_p INOUT text, qt_dose_total_medic_p INOUT bigint) FROM PUBLIC;

