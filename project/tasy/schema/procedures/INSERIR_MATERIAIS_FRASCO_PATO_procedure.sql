-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_materiais_frasco_pato ( nr_seq_frasco_pato_loc_p bigint, ie_amostras_p text, nm_usuario_p text) AS $body$
DECLARE

nr_seq_amostra_pato_w 		bigint;
ie_amostras_w			varchar(4000);
qt_passou_w			integer := 0;

BEGIN
ie_amostras_w := ie_amostras_p;

delete
from	frasco_pato_loc_amost
where	nr_seq_frasco_pato_loc = nr_seq_frasco_pato_loc_p;

while(ie_amostras_w IS NOT NULL AND ie_amostras_w::text <> '') loop
	begin

	nr_seq_amostra_pato_w := (substr(ie_amostras_w,1,position(',' in ie_amostras_w)-1))::numeric;
	ie_amostras_w := substr(ie_amostras_w,position(',' in ie_amostras_w)+1,length(ie_amostras_w)+1);

	insert into frasco_pato_loc_amost(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_tipo_amostra_pato,
		nr_seq_frasco_pato_loc)
	values (	nextval('frasco_pato_loc_amost_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_amostra_pato_w,
		nr_seq_frasco_pato_loc_p);

	-- verificar se nÃ£o ficou em loop.
	qt_passou_w := qt_passou_w + 1;
	if (qt_passou_w >= 1000) then
		exit;
	end if;
	end;
end loop;

if (qt_passou_w >= 1000) then
	rollback;
	CALL gravar_log_cdi(74585,'Rollback inserir_materiais_frasco_pato','Tasy');
else
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_materiais_frasco_pato ( nr_seq_frasco_pato_loc_p bigint, ie_amostras_p text, nm_usuario_p text) FROM PUBLIC;

