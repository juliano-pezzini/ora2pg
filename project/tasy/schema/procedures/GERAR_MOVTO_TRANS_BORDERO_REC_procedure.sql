-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_movto_trans_bordero_rec (nr_bordero_p bigint, cd_estabelecimento_p bigint, dt_transacao_p timestamp, nm_usuario_p text) AS $body$
DECLARE


cd_tipo_recebimento_w		integer;
nr_seq_trans_w			bigint;
nr_seq_conta_banco_w		bigint;
vl_saldo_bordero_w		double precision;
nr_seq_movto_w			bigint;
cd_estabelecimento_w		smallint;
ie_bordero_banco_w		varchar(2);
nr_titulo_w			bigint;
nr_seq_trans_fin_baixa_w	bigint;
nr_seq_trans_tit_bordero_w	bigint;
vl_bordero_w			double precision;
vl_despesa_bordero_w		double precision;
nr_seq_trans_fin_desp_w		bigint;
vl_saldo_titulo_w		double precision;
nr_seq_baixa_w			bigint;
ie_acresc_bordero_w		varchar(1);
nr_seq_movto_banco_w		movto_trans_financ.nr_sequencia%type;
/* Projeto Multimoeda - Variáveis */

vl_bordero_estrang_w		double precision;
vl_complemento_w		double precision;
vl_cotacao_w			cotacao_moeda.vl_cotacao%type;
cd_moeda_w			integer;
vl_despesa_bord_estrang_w	double precision;
vl_cotacao_bordero_w		double precision;
cd_moeda_bordero_w		integer;
cd_moeda_empresa_w		integer;

c01 CURSOR FOR
	SELECT	a.nr_titulo,
		b.nr_seq_trans_fin_baixa,
		coalesce(a.vl_abaixar,0) + CASE WHEN ie_acresc_bordero_w='N' THEN 0  ELSE coalesce(a.vl_juros,0) + coalesce(a.vl_multa,0) + coalesce(a.vl_rec_maior,0) END ,
		a.vl_abaixar_estrang,
		a.vl_cotacao,
		a.cd_moeda
	from	titulo_receber b,
		bordero_tit_rec a
	where	a.nr_titulo	= b.nr_titulo
	and	a.nr_bordero	= nr_bordero_p;

C04 CURSOR FOR
SELECT	coalesce(sum(a.vl_abaixar),0) + CASE WHEN ie_acresc_bordero_w='N' THEN 0  ELSE coalesce(sum(a.vl_juros),0) + coalesce(sum(a.vl_multa),0) + coalesce(sum(a.vl_rec_maior),0) END  vl_transacao,
	coalesce(b.nr_seq_trans_fin_baixa,a.nr_seq_trans_financ) nr_seq_trans_fin,
	coalesce(sum(a.vl_abaixar_estrang),0),
	a.vl_cotacao,
	a.cd_moeda
from	titulo_receber b,
	bordero_tit_rec a
where	a.nr_titulo	= b.nr_titulo
and	a.nr_bordero	= nr_bordero_p
group by coalesce(b.nr_seq_trans_fin_baixa,a.nr_seq_trans_financ),
	a.vl_cotacao,
	a.cd_moeda;

c05 CURSOR FOR
SELECT	b.nr_titulo,
	b.cd_estabelecimento,
	coalesce(a.vl_abaixar,0) + CASE WHEN ie_acresc_bordero_w='N' THEN 0  ELSE coalesce(a.vl_juros,0) + coalesce(a.vl_multa,0) + coalesce(a.vl_rec_maior,0) END ,
	coalesce(b.nr_seq_trans_fin_baixa,a.nr_seq_trans_financ)
from	titulo_receber b,
	bordero_tit_rec a
where	a.nr_titulo	= b.nr_titulo
and	a.nr_bordero	= nr_bordero_p;

c06 CURSOR FOR
	SELECT	a.nr_titulo
	from	titulo_receber b,
			bordero_tit_rec a
	where	a.nr_titulo	= b.nr_titulo
	and	a.nr_bordero	= nr_bordero_p;


BEGIN

select	nr_seq_conta_banco,
	nr_seq_trans_fin,
	coalesce(cd_tipo_recebimento, 1),
	cd_estabelecimento,
	vl_despesa_bordero,
	nr_seq_trans_fin_desp,
	vl_cotacao,
	cd_moeda
into STRICT	nr_seq_conta_banco_w,
	nr_seq_trans_w,
	cd_tipo_recebimento_w,
	cd_estabelecimento_w,
	vl_despesa_bordero_w,
	nr_seq_trans_fin_desp_w,
	vl_cotacao_bordero_w,
	cd_moeda_bordero_w
from	bordero_recebimento
where	nr_bordero		= nr_bordero_p;

/* Projeto Multimoeda - Busca a moeda padrão da empresa */

select	obter_moeda_padrao_empresa(cd_estabelecimento_w,'E')
into STRICT	cd_moeda_empresa_w
;

select	coalesce(max(a.ie_bordero_banco),'B'),
	max(a.nr_seq_trans_tit_bordero),
	coalesce(max(a.ie_acresc_bordero),'S')
into STRICT	ie_bordero_banco_w,
	nr_seq_trans_tit_bordero_w,
	ie_acresc_bordero_w
from	parametro_contas_receber a
where	a.cd_estabelecimento	= cd_estabelecimento_w;

select	coalesce(sum(a.vl_abaixar),0) + coalesce(sum(a.vl_juros),0) + coalesce(sum(a.vl_multa), 0) + coalesce(sum(a.vl_rec_maior),0),
	/* - nvl(sum(a.vl_desconto),0) Francisco - OS 55982 - 30/04/07 -
	Retirei pois o desconto já é abatido no valor a baixar */
	coalesce(sum(a.vl_abaixar_estrang),0),
	max(a.vl_cotacao),
	max(a.cd_moeda)
into STRICT	vl_saldo_bordero_w,
	vl_bordero_estrang_w,
	vl_cotacao_w,
	cd_moeda_w
from	titulo_receber b,
	bordero_tit_rec a
where	a.nr_titulo	= b.nr_titulo
and	a.nr_bordero	= nr_bordero_p;

if (coalesce(nr_seq_conta_banco_w, 0) <> 0) then

	if (ie_bordero_banco_w = 'B') then	/* um lancamento por bordero */
		if (coalesce(nr_seq_trans_w,0) = 0) then

			select	coalesce(min(nr_sequencia), 0)
			into STRICT	nr_seq_trans_w
			from	transacao_financeira
			where	ie_acao = 17
			and	coalesce(ie_banco,'N') <> 'N'
			and	ie_situacao = 'A'
			and	cd_estabelecimento = cd_estabelecimento_p;

			if (nr_seq_trans_w = 0) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(184025);
--				'Transação de baixa do borderô de recebimento não cadastrada!'
			end if;
		end if;

		select	nextval('movto_trans_financ_seq')
		into STRICT	nr_seq_movto_w
		;

		/* Projeto Multimoeda - Verifica se o bordero é moeda estrangeira, caso positivo calcula o complemento para gravar no movimento */

		if (coalesce(vl_bordero_estrang_w,0) <> 0 and coalesce(vl_cotacao_w,0) <> 0) then
			-- Verifica se o valor em moeda estrangeira bate com o valor em moeda nacional, caso necessário converte o valor para moeda estrangeira
			if ((vl_bordero_estrang_w * vl_cotacao_w) <> vl_saldo_bordero_w) then
				vl_bordero_estrang_w := vl_saldo_bordero_w / vl_cotacao_w;
			end if;
			vl_bordero_estrang_w := vl_bordero_estrang_w * -1;
			vl_complemento_w := (vl_saldo_bordero_w * -1) - vl_bordero_estrang_w;
		else
			vl_bordero_estrang_w := null;
			vl_complemento_w := null;
			vl_cotacao_w := null;
			cd_moeda_w := null;
		end if;

		insert into movto_trans_financ(nr_sequencia,
			dt_transacao,
			nr_seq_trans_financ,
			vl_transacao,
			dt_atualizacao,
			nm_usuario,
			nr_bordero_rec,
			dt_referencia_saldo,
			nr_seq_banco,
			cd_tipo_recebimento,
			nr_lote_contabil,
			ie_conciliacao,
			vl_transacao_estrang,
			vl_complemento,
			vl_cotacao,
			cd_moeda)
		values (nr_seq_movto_w,
			dt_transacao_p,
			nr_seq_trans_w,
			vl_saldo_bordero_w * - 1,
			clock_timestamp(),
			nm_usuario_p,
			nr_bordero_p,
			clock_timestamp(),
			nr_seq_conta_banco_w,
			cd_tipo_recebimento_w,
			0,
			'N',
			vl_bordero_estrang_w,
			vl_complemento_w,
			vl_cotacao_w,
			cd_moeda_w);
		/*aamfirmo OS 881490 - Gravar na baixa do titulo a sequencia do movimento bancario gerado para o estorno do borderô.*/

		open C06;
		loop
		fetch C06 into
			nr_titulo_w;
		EXIT WHEN NOT FOUND; /* apply on C06 */
			begin

				select 	max(nr_sequencia)
				into STRICT	nr_seq_baixa_w
				from	titulo_receber_liq
				where	nr_titulo	= nr_titulo_w
				and		nr_bordero 	= nr_bordero_p;

				if (nr_seq_baixa_w IS NOT NULL AND nr_seq_baixa_w::text <> '') and (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then
					update	titulo_receber_liq
					set		nr_seq_movto_trans_fin	= nr_seq_movto_w
					where	nr_sequencia			= nr_seq_baixa_w
					and		nr_titulo				= nr_titulo_w;
				end if;

			end;
		end loop;
		close C06;

	/* Francisco - 29/10/2009 - OS 173868 */

	elsif (ie_bordero_banco_w = 'T') then	/* um lancamento por titulo */
		open c01;
		loop
		fetch c01 into
			nr_titulo_w,
			nr_seq_trans_fin_baixa_w,
			vl_bordero_w,
			vl_bordero_estrang_w,
			vl_cotacao_w,
			cd_moeda_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */

			if (coalesce(nr_seq_trans_tit_bordero_w::text, '') = '') then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(184026);
--				'Não foi informada a "Transação título borderô"! Verifique os parâmetros do Contas a Receber.'
			end if;

			select	nextval('movto_trans_financ_seq')
			into STRICT	nr_seq_movto_w
			;

			/* Projeto Multimoeda - Verifica se o bordero é moeda estrangeira, caso positivo calcula o complemento para gravar no movimento */

			if (coalesce(vl_bordero_estrang_w,0) <> 0 and coalesce(vl_cotacao_w,0) <> 0) then
				-- Verifica se o valor em moeda estrangeira bate com o valor em moeda nacional, caso necessário converte o valor para moeda estrangeira
				if ((vl_bordero_estrang_w * vl_cotacao_w) <> vl_bordero_w) then
					vl_bordero_estrang_w := vl_bordero_w / vl_cotacao_w;
				end if;
				vl_bordero_estrang_w := vl_bordero_estrang_w * -1;
				vl_complemento_w := (vl_bordero_w * -1) - vl_bordero_estrang_w;
			else
				vl_bordero_estrang_w := null;
				vl_complemento_w := null;
				vl_cotacao_w := null;
				cd_moeda_w := null;
			end if;

			insert into movto_trans_financ(NR_SEQUENCIA,
				DT_TRANSACAO,
				NR_SEQ_TRANS_FINANC,
				VL_TRANSACAO,
				DT_ATUALIZACAO,
				NM_USUARIO,
				NR_BORDERO_REC,
				dt_referencia_saldo,
				nr_seq_banco,
				cd_tipo_recebimento,
				nr_lote_contabil,
				ie_conciliacao,
				nr_seq_titulo_receber,
				vl_transacao_estrang,
				vl_complemento,
				vl_cotacao,
				cd_moeda)
			values (nr_seq_movto_w,
				dt_transacao_p,
				coalesce(nr_seq_trans_fin_baixa_w,nr_seq_trans_tit_bordero_w),
				vl_bordero_w * -1,
				clock_timestamp(),
				nm_usuario_p,
				nr_bordero_p,
				dt_transacao_p,
				nr_seq_conta_banco_w,
				cd_tipo_recebimento_w,
				0,
				'N',
				nr_titulo_w,
				vl_bordero_estrang_w,
				vl_complemento_w,
				vl_cotacao_w,
				cd_moeda_w);

			/*aamfirmo OS 881490 - Gravar na baixa do titulo a sequencia do movimento bancario gerado para o estorno do borderô.*/

			select 	max(nr_sequencia)
			into STRICT	nr_seq_baixa_w
			from	titulo_receber_liq
			where	nr_titulo	= nr_titulo_w
			and		nr_bordero 	= nr_bordero_p;

			if (nr_seq_baixa_w IS NOT NULL AND nr_seq_baixa_w::text <> '') and (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then
				update	titulo_receber_liq
				set		nr_seq_movto_trans_fin	= nr_seq_movto_w
				where	nr_sequencia			= nr_seq_baixa_w
				and		nr_titulo				= nr_titulo_w;
			end if;

			-- Nao chamar atualizar transacao financeira aqui pois já lançou a baixa neste momento
		end loop;
		close c01;

	elsif (ie_bordero_banco_w = 'R') then	/* Um lançamento para cada transação de baixa dos títulos */
		open	c04;
		loop
		fetch	c04 into
			vl_bordero_w,
			nr_seq_trans_fin_baixa_w,
			vl_bordero_estrang_w,
			vl_cotacao_w,
			cd_moeda_w;
		EXIT WHEN NOT FOUND; /* apply on c04 */

			if (coalesce(nr_seq_trans_tit_bordero_w::text, '') = '') and (coalesce(nr_seq_trans_fin_baixa_w::text, '') = '') then
				/* Não foi informada a "Transação título borderô"! Verifique os parâmetros do Contas a Receber. */

				CALL wheb_mensagem_pck.exibir_mensagem_abort(184026);
			end if;

			select	nextval('movto_trans_financ_seq')
			into STRICT	nr_seq_movto_w
			;

			/* Projeto Multimoeda - Verifica se o bordero é moeda estrangeira, caso positivo calcula o complemento para gravar no movimento */

			if (coalesce(vl_bordero_estrang_w,0) <> 0 and coalesce(vl_cotacao_w,0) <> 0) then
				-- Verifica se o valor em moeda estrangeira bate com o valor em moeda nacional, caso necessário converte o valor para moeda estrangeira
				if ((vl_bordero_estrang_w * vl_cotacao_w) <> vl_bordero_w) then
					vl_bordero_estrang_w := vl_bordero_w / vl_cotacao_w;
				end if;
				vl_bordero_estrang_w := vl_bordero_estrang_w * -1;
				vl_complemento_w := (vl_bordero_w * -1) - vl_bordero_estrang_w;
			else
				vl_bordero_estrang_w := null;
				vl_complemento_w := null;
				vl_cotacao_w := null;
				cd_moeda_w := null;
			end if;

			insert into movto_trans_financ(NR_SEQUENCIA,
				DT_TRANSACAO,
				NR_SEQ_TRANS_FINANC,
				VL_TRANSACAO,
				DT_ATUALIZACAO,
				NM_USUARIO,
				dt_referencia_saldo,
				nr_seq_banco,
				cd_tipo_recebimento,
				nr_lote_contabil,
				ie_conciliacao,
				nr_seq_titulo_receber,
				nr_bordero_rec,
				vl_transacao_estrang,
				vl_complemento,
				vl_cotacao,
				cd_moeda)
			values (nr_seq_movto_w,
				dt_transacao_p,
				coalesce(nr_seq_trans_fin_baixa_w, nr_seq_trans_tit_bordero_w),
				vl_bordero_w * -1,
				clock_timestamp(),
				nm_usuario_p,
				dt_transacao_p,
				nr_seq_conta_banco_w,
				cd_tipo_recebimento_w,
				0,
				'N',
				nr_titulo_w,
				nr_bordero_p,
				vl_bordero_estrang_w,
				vl_complemento_w,
				vl_cotacao_w,
				cd_moeda_w);

			CALL atualizar_transacao_financeira(cd_estabelecimento_w, nr_seq_movto_w, nm_usuario_p, 'I');

			open C05;
			loop
			fetch C05 into
				nr_titulo_w,
				cd_Estabelecimento_w,
				vl_saldo_titulo_w,
				nr_seq_trans_fin_baixa_w;
			EXIT WHEN NOT FOUND; /* apply on C05 */
				begin

				/*aamfirmo OS 881490 - Gravar na baixa do titulo a sequencia do movimento bancario gerado para o estorno do borderô.*/

				select 	max(nr_sequencia)
				into STRICT	nr_seq_baixa_w
				from	titulo_receber_liq
				where	nr_titulo	= nr_titulo_w
				and		nr_bordero 	= nr_bordero_p;

				if (nr_seq_baixa_w IS NOT NULL AND nr_seq_baixa_w::text <> '') and (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then
					/*Buscar o movimento gerado no banco para a transacao*/

					select	max(nr_sequencia)
					into STRICT	nr_seq_movto_banco_w
					from	movto_trans_financ
					where	nr_bordero_rec		= nr_bordero_p
					and		nr_seq_trans_financ	= coalesce(nr_seq_trans_fin_baixa_w,nr_seq_trans_tit_bordero_w);

					if (nr_seq_movto_banco_w IS NOT NULL AND nr_seq_movto_banco_w::text <> '') then
						update	titulo_receber_liq
						set		nr_seq_movto_trans_fin	= nr_seq_movto_banco_w
						where	nr_sequencia			= nr_seq_baixa_w
						and		nr_titulo				= nr_titulo_w;
					end if;

				end if;

				end;
			end loop;
			close C05;

		end	loop;
		close	c04;

	end if;

	if (nr_seq_trans_fin_desp_w IS NOT NULL AND nr_seq_trans_fin_desp_w::text <> '') and (coalesce(vl_despesa_bordero_w,0) <> 0) then

		select	nextval('movto_trans_financ_seq')
		into STRICT	nr_seq_movto_w
		;

		/* Projeto Multimoeda - Verifica se o bodero é moeda estrangeira, caso positivo converte o valor da despesa para gerar o movimento */

		if (coalesce(cd_moeda_bordero_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w and coalesce(vl_cotacao_bordero_w,0) <> 0) then
			vl_despesa_bord_estrang_w := (vl_despesa_bordero_w / vl_cotacao_bordero_w) * -1;
			vl_complemento_w := (vl_despesa_bordero_w * -1) - vl_despesa_bord_estrang_w;
			vl_cotacao_w := vl_cotacao_bordero_w;
			cd_moeda_w := cd_moeda_bordero_w;
		else
			vl_despesa_bord_estrang_w := null;
			vl_complemento_w := null;
			vl_cotacao_w := null;
			cd_moeda_w := null;
		end if;

		insert into movto_trans_financ(NR_SEQUENCIA,
			DT_TRANSACAO,
			NR_SEQ_TRANS_FINANC,
			VL_TRANSACAO,
			DT_ATUALIZACAO,
			NM_USUARIO,
			NR_BORDERO_REC,
			dt_referencia_saldo,
			nr_seq_banco,
			cd_tipo_recebimento,
			nr_lote_contabil,
			ie_conciliacao,
			vl_transacao_estrang,
			vl_complemento,
			vl_cotacao,
			cd_moeda)
		values (nr_seq_movto_w,
			dt_transacao_p,
			nr_seq_trans_fin_desp_w,
			vl_despesa_bordero_w * -1,
			clock_timestamp(),
			nm_usuario_p,
			nr_bordero_p,
			dt_transacao_p,
			nr_seq_conta_banco_w,
			cd_tipo_recebimento_w,
			0,
			'N',
			vl_despesa_bord_estrang_w,
			vl_complemento_w,
			vl_cotacao_w,
			cd_moeda_w);

		CALL atualizar_transacao_financeira(cd_estabelecimento_w, nr_seq_movto_w, nm_usuario_p, 'I');

	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_movto_trans_bordero_rec (nr_bordero_p bigint, cd_estabelecimento_p bigint, dt_transacao_p timestamp, nm_usuario_p text) FROM PUBLIC;

