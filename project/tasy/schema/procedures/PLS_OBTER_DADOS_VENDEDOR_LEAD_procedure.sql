-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_dados_vendedor_lead ( nr_seq_vendedor_lead_p bigint, nr_celular_p INOUT text, ds_mensagem_p INOUT text) AS $body$
DECLARE


/*
nr_celular_p : 	número de celular do canal de vendas ou do vendedor caso o primeiro seja uma pessoa jurídica
ds_mensagem_p : 	mensagem que será enviada ao celular do canal de vendas ou vendedor
*/
nr_seq_vendedor_canal_w		bigint;
nr_seq_vendedor_vinculado_w	bigint;
nr_seq_solicitacao_w		bigint;
cd_pessoa_fisica_w		varchar(10);
nr_celular_w			varchar(40) := '';
nr_ddi_celular_w		varchar(40) := '';
nr_ddd_celular_w		varchar(40) := '';
nm_pessoa_fisica_w		varchar(60);
nr_telefone_lead_w		varchar(40);
nr_celular_lead_w		varchar(40);
dt_solicitacao_w		varchar(40);
ds_fone_w			varchar(30) := '';
nr_fone_w			varchar(40) := '';


BEGIN

select	nr_seq_vendedor_canal,
	nr_seq_vendedor_vinculado,
	nr_seq_solicitacao
into STRICT	nr_seq_vendedor_canal_w,
	nr_seq_vendedor_vinculado_w,
	nr_seq_solicitacao_w
from	pls_solicitacao_vendedor
where	nr_sequencia = nr_seq_vendedor_lead_p;

select	cd_pessoa_fisica
into STRICT	cd_pessoa_fisica_w
from	pls_vendedor
where	nr_sequencia = nr_seq_vendedor_canal_w;

if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
	select	nr_telefone_celular,
		nr_ddi_celular,
		nr_ddd_celular
	into STRICT	nr_celular_w,
		nr_ddi_celular_w,
		nr_ddd_celular_w
	from	pessoa_fisica
	where	cd_pessoa_fisica = cd_pessoa_fisica_w;
else
	if (nr_seq_vendedor_vinculado_w IS NOT NULL AND nr_seq_vendedor_vinculado_w::text <> '') then
		select	a.nr_telefone_celular,
			a.nr_ddi_celular,
			a.nr_ddd_celular
		into STRICT	nr_celular_w,
			nr_ddi_celular_w,
			nr_ddd_celular_w
		from	pls_vendedor_vinculado	b,
			pessoa_fisica		a
		where	a.cd_pessoa_fisica 	= b.cd_pessoa_fisica
		and	b.nr_sequencia		= nr_seq_vendedor_vinculado_w;
	end if;
end if;

select	nm_pessoa_fisica,
	nr_telefone,
	nr_celular,
	to_char(dt_solicitacao,'dd/mm/yyyy')
into STRICT	nm_pessoa_fisica_w,
	nr_telefone_lead_w,
	nr_celular_lead_w,
	dt_solicitacao_w
from	pls_solicitacao_comercial
where	nr_sequencia = nr_seq_solicitacao_w;

if (nr_telefone_lead_w IS NOT NULL AND nr_telefone_lead_w::text <> '') and (pls_obter_se_possui_numero(nr_telefone_lead_w) = 'S') then
	ds_fone_w	:= ' / Fone: ';
	nr_fone_w	:= nr_telefone_lead_w;
elsif (nr_celular_lead_w IS NOT NULL AND nr_celular_lead_w::text <> '') then
	ds_fone_w 	:= ' / Cel: ';
	nr_fone_w	:= nr_celular_lead_w;
end if;

if (coalesce(nr_ddd_celular_w,'0') <> '0')then
	nr_celular_p 	:= nr_ddi_celular_w || nr_ddd_celular_w || nr_celular_w;
else
	nr_celular_p 	:= nr_celular_w;
end if;

ds_mensagem_p	:= 'Lead de ' || nm_pessoa_fisica_w || ds_fone_w || nr_fone_w || ' / Data: ' || dt_solicitacao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_dados_vendedor_lead ( nr_seq_vendedor_lead_p bigint, nr_celular_p INOUT text, ds_mensagem_p INOUT text) FROM PUBLIC;

