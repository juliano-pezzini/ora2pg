-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_valor_retorno_movto (NR_SEQ_RETORNO_P bigint, NM_USUARIO_P text) AS $body$
DECLARE

 
cd_convenio_w		integer;
cd_motivo_glosa_w	integer;

nr_sequencia_w		bigint;
nr_conta_w			bigint;
cd_categoria_w		varchar(10);
nr_doc_w			varchar(20);
vl_guia_w			double precision;

vl_pago_total_w		double precision;
vl_saldo_w			double precision;
vl_pago_w			double precision;
vl_adicional_w 		double precision;
vl_amenor_w			double precision;
vl_glosado_w		double precision;
ie_glosado_w		varchar(1) := 'P';
ie_glosa_w			varchar(1);

nr_items_w			bigint := 0;

C01 CURSOR FOR 
	SELECT a.nr_sequencia, 
		 a.nr_interno_conta, 
		 b.cd_categoria_calculo, 
		 c.cd_autorizacao, 
		 c.vl_guia 
	from	conta_paciente_guia c, 
		conta_paciente b, 
		convenio_retorno_item a 
	where a.nr_interno_conta = b.nr_interno_conta 
	 and b.nr_interno_conta = c.nr_interno_conta 
	 and a.cd_autorizacao = c.cd_autorizacao 
	 and a.nr_seq_retorno = nr_seq_retorno_p;


BEGIN 
 
select cd_convenio 
into STRICT cd_convenio_w 
from convenio_retorno 
where nr_sequencia = nr_seq_retorno_p;
 
update convenio_retorno_item 
set	vl_pago = 0, 
	vl_glosado = 0, 
	vl_adicional = 0, 
	vl_amenor = 0, 
	ie_glosa ='P' 
where nr_seq_retorno = nr_seq_retorno_p 
 and (nr_interno_conta IS NOT NULL AND nr_interno_conta::text <> '');
 
open C01;
loop 
	fetch C01 into	nr_sequencia_w, 
				nr_conta_w, 
				cd_categoria_w, 
				nr_doc_w, 
				vl_guia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
 
	vl_pago_total_w := 0;
	vl_saldo_w := 0;
	vl_pago_w := 0;
	vl_adicional_w := 0;
	vl_amenor_w := 0;
	vl_glosado_w := 0;
	ie_glosado_w := 'P';
	ie_glosa_w := 'N';
	nr_items_w := nr_items_w + 1;
 
	select coalesce(sum(vl_pago + vl_glosado),0) 
	into STRICT vl_pago_total_w 
	from convenio_retorno_item 
	where nr_interno_conta = nr_conta_w 
 	 and cd_autorizacao = nr_doc_w;
 
	vl_saldo_w := vl_guia_w - vl_pago_total_w;
 
	vl_pago_w := gerar_valor_retorno_movto(nr_seq_retorno_p, nr_sequencia_w, cd_categoria_w, vl_pago_w, nm_usuario_p);
 
	if (vl_pago_w > vl_saldo_w) then 
		vl_adicional_w := (vl_pago_w - vl_saldo_w);
		vl_pago_w := vl_pago_w - vl_adicional_w;
		ie_glosado_w := 'N';
	else 
		SELECT * FROM Valida_Glosa_Conta(nr_conta_w, vl_saldo_w, vl_saldo_w - vl_pago_w, null, nm_usuario_p, ie_glosa_w, cd_motivo_glosa_w) INTO STRICT ie_glosa_w, cd_motivo_glosa_w;
		vl_adicional_w := 0;
		vl_glosado_w := 0;
		vl_amenor_w	:= (vl_saldo_w - vl_pago_w);
		if (ie_glosa_w = 'S') then 
			vl_glosado_w := vl_amenor_w;
			vl_amenor_w := 0;
			ie_glosado_w := 'S';
		end if;
 
		if (vl_glosado_w = 0) and (vl_amenor_w = 0) then 
			ie_glosado_w := 'N';
		end if;
	end if;
 
	update convenio_retorno_item 
	set	vl_pago = vl_pago_w, 
		vl_glosado = vl_glosado_w, 
		vl_adicional = vl_adicional_w, 
		vl_amenor = vl_amenor_w, 
		ie_glosa = ie_glosado_w 
	where nr_sequencia = nr_sequencia_w;
 
	if (nr_items_w = 5000) then 
		commit;
		nr_items_w := 0;
	end if;
end loop;
close C01;
 
commit;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_valor_retorno_movto (NR_SEQ_RETORNO_P bigint, NM_USUARIO_P text) FROM PUBLIC;

