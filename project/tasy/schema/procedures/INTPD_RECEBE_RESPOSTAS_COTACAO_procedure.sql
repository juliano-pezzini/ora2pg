-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE intpd_recebe_respostas_cotacao ( nr_sequencia_p bigint, xml_p xml) AS $body$
DECLARE


_ora2pg_r RECORD;
reg_integracao_w			gerar_int_padrao.reg_integracao_conv;
i				integer;
qt_registros_w			bigint;
ie_conversao_w			intpd_eventos_sistema.ie_conversao%type;
nr_seq_sistema_w			intpd_eventos_sistema.nr_seq_sistema%type;
nr_seq_projeto_xml_w		intpd_eventos_sistema.nr_seq_projeto_xml%type;
nr_seq_regra_conv_w		conversao_meio_externo.nr_seq_regra%type;
ie_sistema_externo_w		varchar(15);
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
nr_solic_compra_w			solic_compra_item.nr_solic_compra%type;
nr_item_solic_compra_w		solic_compra_item.nr_item_solic_compra%type;
cot_compra_forn_w			cot_compra_forn%rowtype;
cot_compra_forn_item_w		cot_compra_forn_item%rowtype;
cot_compra_forn_item_tr_w		cot_compra_forn_item_tr%rowtype;
cot_compra_forn_item_bon_w		cot_compra_forn_item_bon%rowtype;
ds_erro_w			varchar(4000);


c01 CURSOR FOR
SELECT	*
from	xmltable('/STRUCTURE/QUOTATION' passing xml_p columns
	nr_cot_compra			varchar(10)	path	'NR_PURCHASE_QUOTATION',
	ie_gerar_ordem_compra		varchar(15)	path	'IE_GENERATE_PURCHASE_ORDER',
	xml_fornecedores			xml 		path	'SUPPLIERS');
c01_w	c01%rowtype;


c02 CURSOR FOR
SELECT	*
from	xmltable('/SUPPLIERS/SUPPLIER' passing c01_w.xml_fornecedores columns
	cd_cgc_fornecedor			varchar(40)	path	'CD_SUPPLIER',
	cd_condicao_pagamento		varchar(40)	path	'CD_PAYMENTTERM',
	cd_moeda			varchar(40)	path	'CD_CURRENCY',
	cd_pessoa_fisica			varchar(40)	path	'CD_NATURAL_PERSON',
	ds_observacao			varchar(2000)	path	'DS_OBSERVATION',
	dt_documento			varchar(40)	path	'DT_QUOTATION',
	ie_exclusivo			varchar(40)	path	'IE_EXCLUSIVE_SUPPLIER',
	ie_forma_pagto			varchar(40)	path	'IE_FORM_PAYMENT',
	ie_frete				varchar(40)	path	'IE_FREIGHT',
	nm_usuario			varchar(40)	path	'NM_USER',
	nr_documento_fornec		varchar(40)	path	'NR_SUPPLIER_DOCUMENT',
	nr_seq_motivo_exclusivo		varchar(40)	path	'NR_REASONS_SUPPLIER_EXCLUSIVE',
	pr_desconto			varchar(40)	path	'PR_DISCOUNT',
	pr_desconto_pgto_antec		varchar(40)	path	'PR_DISCOUNT_ANTICIP_PAYMENT',
	pr_juros_negociado			varchar(40)	path	'PR_INTEREST_NEGOTIATED',
	qt_dias_entrega			varchar(40)	path	'QT_DELIVERY_DAYS',
	qt_dias_validade			varchar(40)	path	'QT_VALIDITY_DAYS',
	vl_cotacao_moeda			varchar(40)	path	'VL_CURRENCY_CONVERSION',
	vl_desconto			varchar(40)	path	'VL_DISCOUNT',
	vl_despesa_acessoria		varchar(40)	path	'VL_ANCILLIARY_EXPENSE',
	vl_despesa_doc			varchar(40)	path	'VL_INVOICE_EXPENSE',
	vl_previsto_frete			varchar(40)	path	'VL_ESTIMATED_FREIGTH',
	xml_itens_fornecedores		xml 		path	'ITEMS');
c02_w	c02%rowtype;


c03 CURSOR FOR
SELECT	*
from	xmltable('/ITEMS/ITEM' passing c02_w.xml_itens_fornecedores columns
	cd_material			varchar(40)	path	'CD_MATERIAL',
	cd_motivo_falta_preco		varchar(40)	path	'NR_REASON_PRICE_ABSENCE',
	ds_justif_escolha_fornec		varchar(255)	path	'DS_JUSTIFY_SUPPLIER_CHOICE',
	ds_marca_fornec			varchar(30)	path	'DS_BRAND_SUPPLIER',
	ds_observacao			varchar(255)	path	'DS_OBSERVATION',
	dt_validade			varchar(40)	path	'DT_EXPIRATION',
	nm_usuario			varchar(40)	path	'NM_USER',
	nr_item_cot_compra		varchar(40)	path	'NR_ITEM',
	pr_desconto			varchar(40)	path	'PR_DISCOUNT',
	qt_conv_unid_fornec		varchar(40)	path	'QT_CONVERSION_UNID_SUPPLIER',
	qt_material			varchar(40)	path	'QT_MATERIAL',
	qt_prioridade			varchar(40)	path	'QT_PRIORITY',
	vl_desconto			varchar(40)	path	'VL_DISCOUNT',
	vl_frete_rateio			varchar(40)	path	'VL_APPORTIONMENT_FREIGHT',
	vl_unid_fornec			varchar(40)	path	'VL_UNID_SUPPLIER',
	vl_unitario_material			varchar(40)	path	'VL_MATERIAL',
	vl_unitario_ref_moeda		varchar(40)	path	'VL_UNITARY_CONV_CURRENCY',
	xml_tax_itens_fornecedores		xml 		path	'TAXES',
	xml_bonus_itens_fornecedores	xml 		path	'BONUS_ITEMS');
c03_w	c03%rowtype;

c04 CURSOR FOR
SELECT	*
from	xmltable('/TAXES/TAX' passing c03_w.xml_tax_itens_fornecedores columns
	cd_tributo				varchar(40)	path	'CD_TAX',
	ds_observacao			varchar(255)	path	'DS_OBSERVATION',
	pr_tributo				varchar(40)	path	'PR_TAX',
	vl_tributo				varchar(40)	path	'VL_TAX');
c04_w	c04%rowtype;

c05 CURSOR FOR
SELECT	*
from	xmltable('/BONUS_ITEMS/BONUS_ITEM' passing c03_w.xml_bonus_itens_fornecedores columns
	cd_material			varchar(40)	path	'CD_MATERIAL',
	qt_material			varchar(40)	path	'QT_MATERIAL',
	cd_unidade_medida_compra		varchar(40)	path	'CD_PURCHASE_UNIT_MEASUREMENT',
	vl_unitario			varchar(40)	path	'VL_MATERIAL');
c05_w	c05%rowtype;


BEGIN

select	coalesce(b.ie_conversao,'I'),
	nr_seq_sistema,
	nr_seq_projeto_xml,
	nr_seq_regra_conv
into STRICT	ie_conversao_w,
	nr_seq_sistema_w,
	nr_seq_projeto_xml_w,
	nr_seq_regra_conv_w
from	intpd_fila_transmissao a,
	intpd_eventos_sistema b
where	a.nr_seq_evento_sistema = b.nr_sequencia
and	a.nr_sequencia = nr_sequencia_p;

ie_sistema_externo_w	:=	nr_seq_sistema_w;

reg_integracao_w.nr_seq_fila_transmissao	:=	nr_sequencia_p;
reg_integracao_w.ie_envio_recebe		:=	'R';
reg_integracao_w.ie_sistema_externo		:=	ie_sistema_externo_w;
reg_integracao_w.ie_conversao		:=	ie_conversao_w;
reg_integracao_w.nr_seq_projeto_xml		:=	nr_seq_projeto_xml_w;
reg_integracao_w.nr_seq_regra_conversao	:=	nr_seq_regra_conv_w;

open C01;
loop
fetch C01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	coalesce(max(nr_cot_compra),0)
	into STRICT	cot_compra_forn_w.nr_cot_compra
	from	cot_compra
	where	nr_cot_compra = c01_w.nr_cot_compra;

	if (cot_compra_forn_w.nr_cot_compra > 0) then

		select	count(*)
		into STRICT	qt_registros_w
		from	cot_compra
		where	nr_cot_compra = cot_compra_forn_w.nr_cot_compra
		and	(dt_geracao_ordem_compra IS NOT NULL AND dt_geracao_ordem_compra::text <> '');

		select	cd_estabelecimento
		into STRICT	cd_estabelecimento_w
		from	cot_compra
		where	nr_cot_compra = cot_compra_forn_w.nr_cot_compra;

		/*Se já foi gerada a ordem da cotação, não pode mais alterar.*/

		if (qt_registros_w > 0) then
			INTPD_GRAVAR_LOG_RECEBIMENTO(nr_sequencia_p, wheb_mensagem_pck.get_Texto(988063) ,'INTPDTASY');
			/*Essa cotação de compras não pode ser alterada, pois já possui ordem de compra.*/

		else

			open C02;
			loop
			fetch C02 into
				c02_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin

				reg_integracao_w.nm_tabela		:=	'COT_COMPRA_FORN';
				reg_integracao_w.nm_elemento	:=	'SUPPLIER';
				reg_integracao_w.nr_seq_visao	:=	15949;

				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CGC_FORNECEDOR', c02_w.cd_cgc_fornecedor, 'S', cot_compra_forn_w.cd_cgc_fornecedor) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_w.cd_cgc_fornecedor := _ora2pg_r.ds_valor_retorno_p;
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CONDICAO_PAGAMENTO', c02_w.cd_condicao_pagamento, 'S', cot_compra_forn_w.cd_condicao_pagamento) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_w.cd_condicao_pagamento := _ora2pg_r.ds_valor_retorno_p;
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_MOEDA', c02_w.cd_moeda, 'S', cot_compra_forn_w.cd_moeda) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_w.cd_moeda := _ora2pg_r.ds_valor_retorno_p;
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_PESSOA_FISICA', c02_w.cd_pessoa_fisica, 'S', cot_compra_forn_w.cd_pessoa_fisica) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_w.cd_pessoa_fisica := _ora2pg_r.ds_valor_retorno_p;
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_FORMA_PAGTO', c02_w.ie_forma_pagto, 'S', cot_compra_forn_w.ie_forma_pagto) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_w.ie_forma_pagto := _ora2pg_r.ds_valor_retorno_p;
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_FRETE', coalesce(c02_w.ie_frete,'C'), 'S', cot_compra_forn_w.ie_frete) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_w.ie_frete := _ora2pg_r.ds_valor_retorno_p;
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_MOTIVO_EXCLUSIVO', c02_w.nr_seq_motivo_exclusivo, 'S', cot_compra_forn_w.nr_seq_motivo_exclusivo) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_w.nr_seq_motivo_exclusivo := _ora2pg_r.ds_valor_retorno_p;
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_OBSERVACAO', c02_w.ds_observacao, 'N', cot_compra_forn_w.ds_observacao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_w.ds_observacao := _ora2pg_r.ds_valor_retorno_p;
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_DOCUMENTO', c02_w.dt_documento, 'N', cot_compra_forn_w.dt_documento) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_w.dt_documento := _ora2pg_r.ds_valor_retorno_p;
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_EXCLUSIVO', coalesce(c02_w.ie_exclusivo,'N'), 'N', cot_compra_forn_w.ie_exclusivo) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_w.ie_exclusivo := _ora2pg_r.ds_valor_retorno_p;
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NM_USUARIO', c02_w.nm_usuario, 'N', cot_compra_forn_w.nm_usuario) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_w.nm_usuario := _ora2pg_r.ds_valor_retorno_p;
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_DOCUMENTO_FORNEC', c02_w.nr_documento_fornec, 'N', cot_compra_forn_w.nr_documento_fornec) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_w.nr_documento_fornec := _ora2pg_r.ds_valor_retorno_p;
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'PR_DESCONTO', c02_w.pr_desconto, 'N', cot_compra_forn_w.pr_desconto) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_w.pr_desconto := _ora2pg_r.ds_valor_retorno_p;
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'PR_DESCONTO_PGTO_ANTEC', c02_w.pr_desconto_pgto_antec, 'N', cot_compra_forn_w.pr_desconto_pgto_antec) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_w.pr_desconto_pgto_antec := _ora2pg_r.ds_valor_retorno_p;
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'PR_JUROS_NEGOCIADO', c02_w.pr_juros_negociado, 'N', cot_compra_forn_w.pr_juros_negociado) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_w.pr_juros_negociado := _ora2pg_r.ds_valor_retorno_p;
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'QT_DIAS_ENTREGA', c02_w.qt_dias_entrega, 'N', cot_compra_forn_w.qt_dias_entrega) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_w.qt_dias_entrega := _ora2pg_r.ds_valor_retorno_p;
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'QT_DIAS_VALIDADE', c02_w.qt_dias_validade, 'N', cot_compra_forn_w.qt_dias_validade) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_w.qt_dias_validade := _ora2pg_r.ds_valor_retorno_p;
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_COTACAO_MOEDA', c02_w.vl_cotacao_moeda, 'N', cot_compra_forn_w.vl_cotacao_moeda) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_w.vl_cotacao_moeda := _ora2pg_r.ds_valor_retorno_p;
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_DESCONTO', coalesce(c02_w.vl_desconto,0), 'N', cot_compra_forn_w.vl_desconto) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_w.vl_desconto := _ora2pg_r.ds_valor_retorno_p;
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_DESPESA_ACESSORIA', c02_w.vl_despesa_acessoria, 'N', cot_compra_forn_w.vl_despesa_acessoria) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_w.vl_despesa_acessoria := _ora2pg_r.ds_valor_retorno_p;
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_DESPESA_DOC', c02_w.vl_despesa_doc, 'N', cot_compra_forn_w.vl_despesa_doc) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_w.vl_despesa_doc := _ora2pg_r.ds_valor_retorno_p;
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_PREVISTO_FRETE', c02_w.vl_previsto_frete, 'N', cot_compra_forn_w.vl_previsto_frete) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_w.vl_previsto_frete := _ora2pg_r.ds_valor_retorno_p;
				cot_compra_forn_w.dt_atualizacao		:= clock_timestamp();
				cot_compra_forn_w.ie_liberada_internet		:= 'N';
				cot_compra_forn_w.ie_status_envio_email_lib	:= 'N';
				cot_compra_forn_w.ie_gerado_bionexo		:= 'N';

				select	coalesce(max(nr_sequencia),0)
				into STRICT	cot_compra_forn_w.nr_sequencia
				from	cot_compra_forn
				where	nr_cot_compra = cot_compra_forn_w.nr_cot_compra
				and	((cot_compra_forn_w.cd_cgc_fornecedor IS NOT NULL AND cot_compra_forn_w.cd_cgc_fornecedor::text <> '' AND cd_cgc_fornecedor = cot_compra_forn_w.cd_cgc_fornecedor) or
					 (cot_compra_forn_w.cd_pessoa_fisica IS NOT NULL AND cot_compra_forn_w.cd_pessoa_fisica::text <> '' AND cd_pessoa_fisica = cot_compra_forn_w.cd_pessoa_fisica));

				if (cot_compra_forn_w.nr_sequencia > 0) then

					update	cot_compra_forn
					set	row = cot_compra_forn_w
					where	nr_sequencia = cot_compra_forn_w.nr_sequencia;

				else
					select	nextval('cot_compra_forn_seq')
					into STRICT	cot_compra_forn_w.nr_sequencia
					;

					insert into cot_compra_forn values (cot_compra_forn_w.*);
				end if;

				open C03;
				loop
				fetch C03 into
					C03_w;
				EXIT WHEN NOT FOUND; /* apply on C03 */
					begin

					reg_integracao_w.nm_tabela	:=	'COT_COMPRA_FORN_ITEM';
					reg_integracao_w.nm_elemento	:=	'ITEM';
					reg_integracao_w.nr_seq_visao	:=	17619;

					SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_MATERIAL', c03_w.cd_material, 'S', cot_compra_forn_item_w.cd_material) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_w.cd_material := _ora2pg_r.ds_valor_retorno_p;
					SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_MOTIVO_FALTA_PRECO', c03_w.cd_motivo_falta_preco, 'S', cot_compra_forn_item_w.cd_motivo_falta_preco) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_w.cd_motivo_falta_preco := _ora2pg_r.ds_valor_retorno_p;
					SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_JUSTIF_ESCOLHA_FORNEC', c03_w.ds_justif_escolha_fornec, 'N', cot_compra_forn_item_w.ds_justif_escolha_fornec) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_w.ds_justif_escolha_fornec := _ora2pg_r.ds_valor_retorno_p;
					SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_MARCA_FORNEC', c03_w.ds_marca_fornec, 'N', cot_compra_forn_item_w.ds_marca_fornec) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_w.ds_marca_fornec := _ora2pg_r.ds_valor_retorno_p;
					SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_OBSERVACAO', c03_w.ds_observacao, 'N', cot_compra_forn_item_w.ds_observacao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_w.ds_observacao := _ora2pg_r.ds_valor_retorno_p;
					SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_VALIDADE', c03_w.dt_validade, 'N', cot_compra_forn_item_w.dt_validade) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_w.dt_validade := _ora2pg_r.ds_valor_retorno_p;
					SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NM_USUARIO', c03_w.nm_usuario, 'N', cot_compra_forn_item_w.nm_usuario) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_w.nm_usuario := _ora2pg_r.ds_valor_retorno_p;
					SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_ITEM_COT_COMPRA', c03_w.nr_item_cot_compra, 'N', cot_compra_forn_item_w.nr_item_cot_compra) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_w.nr_item_cot_compra := _ora2pg_r.ds_valor_retorno_p;
					SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'PR_DESCONTO', c03_w.pr_desconto, 'N', cot_compra_forn_item_w.pr_desconto) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_w.pr_desconto := _ora2pg_r.ds_valor_retorno_p;
					SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'QT_CONV_UNID_FORNEC', c03_w.qt_conv_unid_fornec, 'N', cot_compra_forn_item_w.qt_conv_unid_fornec) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_w.qt_conv_unid_fornec := _ora2pg_r.ds_valor_retorno_p;
					SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'QT_MATERIAL', c03_w.qt_material, 'N', cot_compra_forn_item_w.qt_material) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_w.qt_material := _ora2pg_r.ds_valor_retorno_p;
					SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'QT_PRIORIDADE', c03_w.qt_prioridade, 'N', cot_compra_forn_item_w.qt_prioridade) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_w.qt_prioridade := _ora2pg_r.ds_valor_retorno_p;
					SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_DESCONTO', coalesce(c03_w.vl_desconto,0), 'N', cot_compra_forn_item_w.vl_desconto) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_w.vl_desconto := _ora2pg_r.ds_valor_retorno_p;
					SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_FRETE_RATEIO', c03_w.vl_frete_rateio, 'N', cot_compra_forn_item_w.vl_frete_rateio) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_w.vl_frete_rateio := _ora2pg_r.ds_valor_retorno_p;
					SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_UNID_FORNEC', c03_w.vl_unid_fornec, 'N', cot_compra_forn_item_w.vl_unid_fornec) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_w.vl_unid_fornec := _ora2pg_r.ds_valor_retorno_p;
					SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_UNITARIO_MATERIAL', c03_w.vl_unitario_material, 'N', cot_compra_forn_item_w.vl_unitario_material) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_w.vl_unitario_material := _ora2pg_r.ds_valor_retorno_p;
					SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_UNITARIO_REF_MOEDA', c03_w.vl_unitario_ref_moeda, 'N', cot_compra_forn_item_w.vl_unitario_ref_moeda) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_w.vl_unitario_ref_moeda := _ora2pg_r.ds_valor_retorno_p;
					cot_compra_forn_item_w.cd_cgc_fornecedor	:= cot_compra_forn_w.cd_cgc_fornecedor;
					cot_compra_forn_item_w.nr_seq_cot_forn		:= cot_compra_forn_w.nr_sequencia;
					cot_compra_forn_item_w.nr_cot_compra		:= cot_compra_forn_w.nr_cot_compra;
					cot_compra_forn_item_w.dt_atualizacao		:= clock_timestamp();
					cot_compra_forn_item_w.ie_situacao		:= 'A';
					cot_compra_forn_item_w.ie_considera_media_lic	:= 'S';

					select	count(*)
					into STRICT	qt_registros_w
					from	cot_compra_item a
					where	a.nr_cot_compra = cot_compra_forn_w.nr_cot_compra
					and	a.nr_item_cot_compra = cot_compra_forn_item_w.nr_item_cot_compra;

					if (qt_registros_w > 0) then

						select	substr(obter_marca_material_estab(cd_estabelecimento_w, a.cd_material,'DR'),1,30),
							ds_material_direto_w,
							nr_solic_compra,
							nr_item_solic_compra
						into STRICT	cot_compra_forn_item_w.ds_marca,
							cot_compra_forn_item_w.ds_material_direto,
							nr_solic_compra_w,
							nr_item_solic_compra_w
						from	cot_compra_item a
						where	a.nr_cot_compra = cot_compra_forn_w.nr_cot_compra
						and	a.nr_item_cot_compra = cot_compra_forn_item_w.nr_item_cot_compra;

						if (nr_solic_compra_w > 0) and (nr_item_solic_compra_w > 0) then

							select	substr(obter_desc_material_marca(nr_seq_marca,cd_material),1,30)
							into STRICT	cot_compra_forn_item_w.ds_marca
							from	solic_compra_item
							where	nr_solic_compra = nr_solic_compra_w
							and	nr_item_solic_compra = nr_item_solic_compra_w;
						end if;
					end if;

					select	coalesce(max(nr_sequencia),0)
					into STRICT	cot_compra_forn_item_w.nr_sequencia
					from	cot_compra_forn_item
					where	nr_seq_cot_forn = cot_compra_forn_w.nr_sequencia
					and	nr_item_cot_compra = cot_compra_forn_item_w.nr_item_cot_compra;

					if (cot_compra_forn_item_w.nr_sequencia > 0) then

						update	cot_compra_forn_item
						set	row = cot_compra_forn_item_w
						where	nr_sequencia = cot_compra_forn_item_w.nr_sequencia;

					else
						select	nextval('cot_compra_forn_item_seq')
						into STRICT	cot_compra_forn_item_w.nr_sequencia
						;

						insert into cot_compra_forn_item values (cot_compra_forn_item_w.*);
					end if;


					open C04;
					loop
					fetch C04 into
						c04_w;
					EXIT WHEN NOT FOUND; /* apply on C04 */
						begin


						reg_integracao_w.nm_tabela	:=	'COT_COMPRA_FORN_ITEM_TR';
						reg_integracao_w.nm_elemento	:=	'TAX';
						reg_integracao_w.nr_seq_visao	:=	16032;

						SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_TRIBUTO', c04_w.cd_tributo, 'S', cot_compra_forn_item_tr_w.cd_tributo) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_tr_w.cd_tributo := _ora2pg_r.ds_valor_retorno_p;
						SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_OBSERVACAO', c04_w.ds_observacao, 'N', cot_compra_forn_item_tr_w.ds_observacao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_tr_w.ds_observacao := _ora2pg_r.ds_valor_retorno_p;
						SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'PR_TRIBUTO', c04_w.pr_tributo, 'N', cot_compra_forn_item_tr_w.pr_tributo) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_tr_w.pr_tributo := _ora2pg_r.ds_valor_retorno_p;
						SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_TRIBUTO', c04_w.vl_tributo, 'N', cot_compra_forn_item_tr_w.vl_tributo) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_tr_w.vl_tributo := _ora2pg_r.ds_valor_retorno_p;
						cot_compra_forn_item_tr_w.nr_cot_compra		:= cot_compra_forn_w.nr_cot_compra;
						cot_compra_forn_item_tr_w.nr_item_cot_compra	:= cot_compra_forn_item_w.nr_item_cot_compra;
						cot_compra_forn_item_tr_w.cd_cgc_fornecedor	:= cot_compra_forn_w.cd_cgc_fornecedor;
						cot_compra_forn_item_tr_w.dt_atualizacao	:= clock_timestamp();
						cot_compra_forn_item_tr_w.nm_usuario		:= cot_compra_forn_item_w.nm_usuario;
						cot_compra_forn_item_tr_w.dt_atualizacao_nrec	:= clock_timestamp();
						cot_compra_forn_item_tr_w.nm_usuario_nrec	:= cot_compra_forn_item_w.nm_usuario;
						cot_compra_forn_item_tr_w.nr_seq_cot_item_forn	:= cot_compra_forn_item_w.nr_sequencia;

						select	coalesce(max(nr_sequencia),0)
						into STRICT	cot_compra_forn_item_tr_w.nr_sequencia
						from	cot_compra_forn_item_tr
						where	nr_seq_cot_item_forn = cot_compra_forn_item_w.nr_sequencia
						and	cd_tributo = cot_compra_forn_item_tr_w.cd_tributo;

						if (cot_compra_forn_item_tr_w.nr_sequencia > 0) then

							update	cot_compra_forn_item_tr
							set	row = cot_compra_forn_item_tr_w
							where	nr_sequencia = cot_compra_forn_item_tr_w.nr_sequencia;

						else
							select	nextval('cot_compra_forn_item_tr_seq')
							into STRICT	cot_compra_forn_item_tr_w.nr_sequencia
							;

							insert into cot_compra_forn_item_tr values (cot_compra_forn_item_tr_w.*);
						end if;
						end;
					end loop;
					close C04;

					open C05;
					loop
					fetch C05 into
						c05_w;
					EXIT WHEN NOT FOUND; /* apply on C05 */
						begin


						reg_integracao_w.nm_tabela	:=	'COT_COMPRA_FORN_ITEM_BON';
						reg_integracao_w.nm_elemento	:=	'BONUS_ITEM';
						reg_integracao_w.nr_seq_visao	:=	20034;

						SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_MATERIAL', c05_w.cd_material, 'S', cot_compra_forn_item_bon_w.cd_material) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_bon_w.cd_material := _ora2pg_r.ds_valor_retorno_p;
						SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'QT_MATERIAL', c05_w.qt_material, 'N', cot_compra_forn_item_bon_w.qt_material) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_bon_w.qt_material := _ora2pg_r.ds_valor_retorno_p;
						SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_UNIDADE_MEDIDA_COMPRA', c05_w.cd_unidade_medida_compra, 'S', cot_compra_forn_item_bon_w.cd_unidade_medida_compra) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_bon_w.cd_unidade_medida_compra := _ora2pg_r.ds_valor_retorno_p;
						SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_UNITARIO', c05_w.vl_unitario, 'N', cot_compra_forn_item_bon_w.vl_unitario) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; cot_compra_forn_item_bon_w.vl_unitario := _ora2pg_r.ds_valor_retorno_p;
						cot_compra_forn_item_bon_w.dt_atualizacao	:= clock_timestamp();
						cot_compra_forn_item_bon_w.nm_usuario		:= cot_compra_forn_item_w.nm_usuario;
						cot_compra_forn_item_bon_w.dt_atualizacao_nrec	:= clock_timestamp();
						cot_compra_forn_item_bon_w.nm_usuario_nrec	:= cot_compra_forn_item_w.nm_usuario;
						cot_compra_forn_item_bon_w.nr_seq_cot_item_forn	:= cot_compra_forn_item_w.nr_sequencia;

						select	coalesce(max(nr_sequencia),0)
						into STRICT	cot_compra_forn_item_bon_w.nr_sequencia
						from	cot_compra_forn_item_bon
						where	nr_seq_cot_item_forn = cot_compra_forn_item_w.nr_sequencia
						and	cd_material = cot_compra_forn_item_bon_w.cd_material;

						if (cot_compra_forn_item_bon_w.nr_sequencia > 0) then

							update	cot_compra_forn_item_bon
							set	row = cot_compra_forn_item_bon_w
							where	nr_sequencia = cot_compra_forn_item_bon_w.nr_sequencia;

						else
							select	nextval('cot_compra_forn_item_bon_seq')
							into STRICT	cot_compra_forn_item_bon_w.nr_sequencia
							;

							insert into cot_compra_forn_item_bon values (cot_compra_forn_item_bon_w.*);
						end if;
						end;
					end loop;
					close C05;
					end;
				end loop;
				close C03;

				end;
			end loop;
			close C02;

			if (reg_integracao_w.qt_reg_log = 0) then

				CALL calcular_cot_compra_liquida(cot_compra_forn_w.nr_cot_compra,cot_compra_forn_w.nm_usuario);
				CALL gerar_cot_compra_resumo(cot_compra_forn_w.nr_cot_compra,cot_compra_forn_w.nm_usuario);

				if (c01_w.ie_gerar_ordem_compra = 'S') then
					CALL gerar_ordem_compra(cot_compra_forn_w.nr_cot_compra,null,cot_compra_forn_w.nm_usuario,'S');
					CALL gerar_historico_cotacao(cot_compra_forn_w.nr_cot_compra,wheb_mensagem_pck.get_Texto(149602),wheb_mensagem_pck.get_Texto(988462),'S',cot_compra_forn_w.nm_usuario);
					/*Ordem de compra gerada a partir da integração padrão.
					Evento: 103 - Receber respostas dos fornecedores da cotação.*/
					select	count(*)
					into STRICT	qt_registros_w
					from	ordem_compra_item
					where	nr_cot_compra = cot_compra_forn_w.nr_cot_compra;

					if (qt_registros_w > 0) then
						CALL alt_dt_geracao_ordem_compra(cot_compra_forn_w.nm_usuario,cot_compra_forn_w.nr_cot_compra);

					end if;
				end if;
			end if;
		end if;
	else
		INTPD_GRAVAR_LOG_RECEBIMENTO(nr_sequencia_p, wheb_mensagem_pck.get_Texto(988381) ,'INTPDTASY');
		/*Esse número de cotação não existe.*/

	end if;
	end;
end loop;
close C01;

if	((reg_integracao_w.qt_reg_log > 0) or (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '')) then
	begin

	rollback;

	update intpd_fila_transmissao
	set	ie_status = 'E',
		ie_tipo_erro = 'F'
	where	nr_sequencia = nr_sequencia_p;

	for i in 0..reg_integracao_w.qt_reg_log-1 loop
		INTPD_GRAVAR_LOG_RECEBIMENTO(nr_sequencia_p,reg_integracao_w.intpd_log_receb[i].ds_log,'INTPDTASY');
	end loop;
	end;

else

	update	intpd_fila_transmissao
	set	ie_status = 'S',
		nr_seq_documento = c01_w.nr_cot_compra
	where	nr_sequencia = nr_sequencia_p;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE intpd_recebe_respostas_cotacao ( nr_sequencia_p bigint, xml_p xml) FROM PUBLIC;

