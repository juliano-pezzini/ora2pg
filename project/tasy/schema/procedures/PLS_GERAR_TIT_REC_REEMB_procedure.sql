-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_tit_rec_reemb ( nr_seq_lote_reemb_recup_p pls_lote_reemb_recuperacao.nr_sequencia%type, nm_usuario_p text) AS $body$
DECLARE

 
cd_estabelecimento_w		pls_lote_reemb_recuperacao.cd_estabelecimento%type;
cd_cgc_responsavel_w		pls_lote_reemb_recuperacao.cd_cgc_responsavel%type;
dt_vencimento_w			pls_lote_reemb_recuperacao.dt_vencimento_novo_tit%type;
dt_emissao_w			pls_lote_reemb_recuperacao.dt_lote%type;
vl_titulo_w			pls_lote_reemb_recuperacao.vl_lote%type;
nr_seq_trans_fin_contab_w	pls_lote_reemb_recuperacao.nr_seq_trans_fin_contab%type;
nr_seq_trans_fin_baixa_w	pls_lote_reemb_recuperacao.nr_seq_trans_fin_baixa%type;
nr_titulo_w			pls_lote_reemb_recuperacao.nr_titulo%type;
nr_titulo_ww			pls_lote_reemb_recuperacao.nr_titulo%type;

c01 CURSOR(nr_seq_lote_pc	pls_lote_reemb_recuperacao.nr_sequencia%type) FOR 
	SELECT	cd_conta_financ_rec cd_conta_financ_rec, 
		sum(vl_apropriado) vl_apropriado, 
		cd_conta_deb cd_conta_deb 
	from (SELECT 	e.cd_conta_financ_rec cd_conta_financ_rec, 
				e.vl_apropriado vl_apropriado, 
				d.cd_conta_deb 
		from		pls_lote_reemb_rec_item a, 
				pls_protocolo_conta b, 
				pls_conta c, 
				pls_conta_proc d, 
				pls_conta_proc_aprop e 
		where		b.nr_sequencia		= a.nr_seq_protocolo 
		and		c.nr_seq_protocolo	= b.nr_sequencia 
		and		d.nr_seq_conta		= c.nr_sequencia 
		and		e.nr_seq_conta_proc	= d.nr_sequencia 
		and		e.ie_recuperar		= 'S' 
		and		a.nr_seq_lote 		= nr_seq_lote_pc 
		
union all
 
		select 		e.cd_conta_financ_rec cd_conta_financ_rec, 
				e.vl_apropriado vl_apropriado, 
				d.cd_conta_deb 
		from		pls_lote_reemb_rec_item a, 
				pls_protocolo_conta b, 
				pls_conta c, 
				pls_conta_mat d, 
				pls_conta_mat_aprop e 
		where		b.nr_sequencia		= a.nr_seq_protocolo 
		and		c.nr_seq_protocolo	= b.nr_sequencia 
		and		d.nr_seq_conta		= c.nr_sequencia 
		and		e.nr_seq_conta_mat	= d.nr_sequencia 
		and		e.ie_recuperar		= 'S' 
		and		a.nr_seq_lote 		= nr_seq_lote_pc) alias2 
	group by cd_conta_financ_rec, cd_conta_deb;
	
BEGIN 
select		cd_estabelecimento, 
		cd_cgc_responsavel, 
		dt_vencimento_novo_tit, 
		dt_lote, 
		coalesce(vl_lote,0) vl_lote, 
		nr_seq_trans_fin_contab, 
		nr_seq_trans_fin_baixa, 
		nr_titulo 
into STRICT		cd_estabelecimento_w, 
		cd_cgc_responsavel_w, 
		dt_vencimento_w, 
		dt_emissao_w, 
		vl_titulo_w, 
		nr_seq_trans_fin_contab_w, 
		nr_seq_trans_fin_baixa_w, 
		nr_titulo_w 
from		pls_lote_reemb_recuperacao 
where		nr_sequencia 	= nr_seq_lote_reemb_recup_p;
 
if (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then 
	-- Não foi possível gerar o título para o lote de recuperação de reembolso. Já existe título gerado. 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(308424);
end if;
if (vl_titulo_w > 0) then 
	nr_titulo_ww := gerar_tit_rec_padrao(	cd_estabelecimento_w, null, cd_cgc_responsavel_w, dt_vencimento_w, dt_emissao_w, vl_titulo_w, nr_seq_trans_fin_contab_w, nr_seq_trans_fin_baixa_w, '17',  -- OPS - Recuperação de reembolso 
				nm_usuario_p, nr_titulo_ww);
	/* Abrir cursor com sum, agrupado pela conta financeira, 
	da pls_conta_proc_aprop e pls_conta_mat_aprop (union) */
 
	/* para cada linha do cursor: */
 
	for	r_c01_w in c01(nr_seq_lote_reemb_recup_p) loop 
		CALL inserir_classif_tit_rec(nr_titulo_ww, 
					r_c01_w.cd_conta_financ_rec, 
					r_c01_w.cd_conta_deb, 
					null, 
					null, 
					r_c01_w.vl_apropriado, 
					nm_usuario_p);
	end loop;	
				 
	update 	pls_lote_reemb_recuperacao 
	set	nr_titulo 		= nr_titulo_ww, 
		dt_geracao_titulo	= clock_timestamp(), 
		dt_atualizacao		= clock_timestamp(), 
		nm_usuario		= nm_usuario_p 
	where	nr_sequencia		= nr_seq_lote_reemb_recup_p;
	 
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_tit_rec_reemb ( nr_seq_lote_reemb_recup_p pls_lote_reemb_recuperacao.nr_sequencia%type, nm_usuario_p text) FROM PUBLIC;

