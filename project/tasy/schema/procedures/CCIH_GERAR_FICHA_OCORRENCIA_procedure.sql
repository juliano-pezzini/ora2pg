-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ccih_gerar_ficha_ocorrencia ( nr_atendimento_p bigint, dt_entrada_p timestamp, cd_medico_p text, nm_usuario_p text, ie_libera_ficha_p text default 'N', ie_clinica_p bigint default null) AS $body$
DECLARE

ie_existe_w		varchar(1);
cd_clinica_w		bigint;
cd_clinica_ww		varchar(10);
ie_clinica_w		integer;
cd_estabelecimento_w integer;	


BEGIN

cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;

cd_clinica_ww := Obter_Param_Usuario(936, 37, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, cd_clinica_ww);

select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
into STRICT	ie_existe_w
from cih_ficha_ocorrencia
where nr_atendimento = nr_atendimento_p;

if (ie_existe_w = 'N') then
	
	select	max(cd_clinica)
	into STRICT	cd_clinica_w
	from	cih_clinica
	where	ie_clinica = ie_clinica_p
  and coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w;
	
	if (coalesce(cd_clinica_w::text, '') = '') then	
		if (cd_clinica_ww IS NOT NULL AND cd_clinica_ww::text <> '') then
			cd_clinica_w	:= campo_numerico(cd_clinica_ww);
		else
			select	min(cd_clinica)
			into STRICT	cd_clinica_w
			from	cih_clinica
			where	ie_situacao = 'A'
      and coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w;
		end if;
	end if;	

	insert into cih_ficha_ocorrencia(	NR_FICHA_OCORRENCIA,
						NR_ATENDIMENTO,
						CD_CLINICA,
						CD_CASO_INFECCAO,
						DT_ATUALIZACAO,
						NM_USUARIO,
						NM_USUARIO_NREC,
						DS_DIAGNOSTICO_INT,
						DS_DIAGNOSTICO_ALTA,
						CD_MEDICO,
						IE_RETARDOU_ALTA,
						CD_TIPO_EVOLUCAO,
						QT_NATIMORTO,
						QT_NEONATO,
						DT_FICHA,
						DT_LIBERACAO,
						nm_usuario_lib)
	values (nextval('cih_ficha_ocorrencia_seq'),
		nr_atendimento_p,
		cd_clinica_w,
		null,
		clock_timestamp(),
		'Tasy',
		nm_usuario_p,
		null,
		null,
		cd_medico_p,
		null,
		null,
		null,
		null,
		coalesce(dt_entrada_p,clock_timestamp()),
		CASE WHEN ie_libera_ficha_p='N' THEN null  ELSE clock_timestamp() END ,
		CASE WHEN ie_libera_ficha_p='N' THEN null  ELSE nm_usuario_p END );
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ccih_gerar_ficha_ocorrencia ( nr_atendimento_p bigint, dt_entrada_p timestamp, cd_medico_p text, nm_usuario_p text, ie_libera_ficha_p text default 'N', ie_clinica_p bigint default null) FROM PUBLIC;

