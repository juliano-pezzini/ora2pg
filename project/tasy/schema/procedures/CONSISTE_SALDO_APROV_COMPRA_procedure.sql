-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_saldo_aprov_compra ( nr_seq_aprovacao_p bigint, nr_seq_proc_aprov_p bigint, nm_usuario_p text, ie_consiste_p INOUT text) AS $body$
DECLARE


cd_estabelecimento_w		integer;
ie_teto_aprovacao_w		varchar(1);
vl_maximo_w			double precision	:= 0;
vl_saldo_w			double precision	:= 0;
vl_aprovar_w			double precision	:= 0;
cd_pessoa_fisica_w		varchar(10);
dt_liberacao_w			timestamp;
ie_consiste_w			varchar(1);
nr_seq_proc_aprov_w		bigint;
nr_documento_w            	processo_aprov_compra.nr_documento%type;
qt_nova_estrutura_w        	bigint;


BEGIN

ie_consiste_w	:= 'N';

select	coalesce(max(nr_seq_proc_original),nr_seq_proc_aprov_p),
	max(nr_documento)
into STRICT	nr_seq_proc_aprov_w,
	nr_documento_w
from	processo_aprov_compra
where	nr_sequencia = nr_seq_aprovacao_p
and	nr_seq_proc_aprov = nr_seq_proc_aprov_p;

select obter_estrutura_aprovacao(nr_seq_proc_aprov_p, nr_documento_w)
into STRICT   qt_nova_estrutura_w
;

select	obter_estab_processo_aprov(nr_seq_aprovacao_p)
into STRICT	cd_estabelecimento_w
;

select	coalesce(max(dt_liberacao),clock_timestamp())
into STRICT	dt_liberacao_w
from	processo_aprov_compra
where	nr_sequencia = nr_seq_aprovacao_p;

select	coalesce(ie_teto_aprovacao,'N')
into STRICT	ie_teto_aprovacao_w
from	parametro_compras
where	cd_estabelecimento = cd_estabelecimento_w;

if (qt_nova_estrutura_w > 0) then

	select	coalesce(max(vl_maximo),0)
	into STRICT	vl_maximo_w
	from	processo_aprov_compra
	where	nr_seq_proc_aprov = nr_seq_proc_aprov_w
	and	nr_documento  = nr_documento_w;
else
	select	coalesce(max(vl_maximo),0)
	into STRICT	vl_maximo_w
	from	processo_aprov_resp
	where	nr_sequencia = nr_seq_proc_aprov_w;
end if;
	
select	cd_pessoa_fisica
into STRICT	cd_pessoa_fisica_w
from	usuario
where	nm_usuario = nm_usuario_p;

select	sup_obter_valor_aprovado(nr_seq_aprovacao_p,nr_seq_proc_aprov_w,cd_pessoa_fisica_w)
into STRICT	vl_aprovar_w
;

if (vl_aprovar_w <= vl_maximo_w) and (vl_maximo_w > 0) then
	begin

	select	obter_saldo_resp_aprovacao(nr_seq_aprovacao_p, nr_seq_proc_aprov_w, dt_liberacao_w, 1)
	into STRICT	vl_saldo_w
	;
	
	if (vl_aprovar_w > vl_saldo_w) then
		ie_consiste_w	:= 'S';
	end if;
	
	end;
end if;

ie_consiste_p	:= ie_consiste_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_saldo_aprov_compra ( nr_seq_aprovacao_p bigint, nr_seq_proc_aprov_p bigint, nm_usuario_p text, ie_consiste_p INOUT text) FROM PUBLIC;

