-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_pepo_anestesista_html (nr_cirurgia_p bigint, nr_seq_pepo_p bigint, cd_local_estoque_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
nr_prescricao_w		bigint;
ie_opcao_w		varchar(1);
ie_lanca_autom_w	varchar(1);
cd_perfil_w		integer;
cd_estabelecimento_w	integer;
	
	 

BEGIN 
cd_perfil_w		:= wheb_usuario_pck.get_cd_perfil;
cd_estabelecimento_w	:= wheb_usuario_pck.get_cd_estabelecimento;
 
if (coalesce(nr_seq_pepo_p,0) > 0) then 
	select	CASE WHEN coalesce(max(dt_liberacao_anestesista)::text, '') = '' THEN 'L'  ELSE 'D' END  
	into STRICT	ie_opcao_w 
	from	pepo_cirurgia 
	where	nr_sequencia = nr_seq_pepo_p;
	 
	CALL liberar_pepo_anestesista(null,ie_opcao_w,nm_usuario_p,nr_seq_pepo_p);
else 
	ie_lanca_autom_w := obter_param_usuario(872, 286, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_lanca_autom_w);
	 
	select	CASE WHEN coalesce(max(dt_liberacao_anestesista)::text, '') = '' THEN 'L'  ELSE 'D' END  
	into STRICT	ie_opcao_w 
	from	cirurgia 
	where	nr_cirurgia = nr_cirurgia_p;
	 
	select	max(nr_prescricao) 
	into STRICT	nr_prescricao_w 
	from	cirurgia 
	where	nr_cirurgia = nr_cirurgia_p;
	 
	CALL liberar_pepo_anestesista(nr_cirurgia_p,ie_opcao_w,nm_usuario_p,null);
 
	if (ie_opcao_w = 'L') and (ie_lanca_autom_w = 'S') then 
		CALL gerar_lanc_automatico(nr_cirurgia_p,nr_prescricao_w,cd_local_estoque_p,nm_usuario_p);
	end if;	
end if;	
	 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_pepo_anestesista_html (nr_cirurgia_p bigint, nr_seq_pepo_p bigint, cd_local_estoque_p bigint, nm_usuario_p text) FROM PUBLIC;

