-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_pyxis_hs_gera_arq_alta ( nr_atendimento_p bigint, dt_alta_p timestamp) AS $body$
DECLARE


arq_texto_w		utl_file.file_type;
ds_linha_arquivo_w	varchar(2000);
nm_arquivo_w		varchar(100);
ds_diretorio_w		varchar(255);
qt_itens_w		 integer;

C01 CURSOR FOR
SELECT  'EPD' ||
        '|' ||
        TO_CHAR(dt_alta_p, 'MMDDYYYYHHMMSS') ||
        '|' ||
        nr_atendimento_p ||
        '||||' ||
        TO_CHAR(dt_alta_p, 'MMDDYYYYHHMMSS') ||
        '|' ||
        obter_ds_descricao_setor(obter_setor_atendimento(nr_atendimento_p)) ||
        '|SHS|'

WHERE   (dt_alta_p IS NOT NULL AND dt_alta_p::text <> '')
AND     obter_setor_atendimento(nr_atendimento_p) IN (2, 26, 13, 5, 12, 11,25,47,117,248); -- 117 é o CC, nos casos onde é gerada a alta para quando o paciente está no CC e no setor da pyxis (5° andar por exemplo)
BEGIN
--Parametro 1: diretório a ser gravado o arquivo (diretório válido linux - tem que ser mapeado para conseguir gerar)
--Parametro 2: nome_do_arquivo a ser gerado
select	substr(obter_valor_param_usuario(3111, 74, Obter_perfil_ativo, '', ''),1,255)
into STRICT	ds_diretorio_w
;

if (ds_diretorio_w IS NOT NULL AND ds_diretorio_w::text <> '') then
	nm_arquivo_w	:= to_char(clock_timestamp(),'MMDDYYYYHHMMSS') || '.pyx';

	select	count(*)
	into STRICT	qt_itens_w
	
	WHERE   (dt_alta_p IS NOT NULL AND dt_alta_p::text <> '')
	AND     obter_setor_atendimento(nr_atendimento_p) IN (2, 26, 13, 5, 12, 11,25,47,117,248);

	if (qt_itens_w > 0) then
		arq_texto_w 	:= utl_file.fopen(ds_diretorio_w,nm_arquivo_w,'W');

		open C01;
		loop
		fetch C01 into
			ds_linha_arquivo_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			--gera uma nova linha no arquivo
			utl_file.put_line(arq_texto_w,ds_linha_arquivo_w);
			utl_file.fflush(arq_texto_w);
		end loop;
		close C01;

		--fecha e libera o arquivo
		utl_file.fclose(arq_texto_w);
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_pyxis_hs_gera_arq_alta ( nr_atendimento_p bigint, dt_alta_p timestamp) FROM PUBLIC;

