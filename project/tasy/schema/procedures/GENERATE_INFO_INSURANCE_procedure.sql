-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE generate_info_insurance ( nr_episodio_p episodio_paciente.nr_sequencia%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_pessoa_fisica_p atendimento_paciente.cd_pessoa_fisica%type) AS $body$
DECLARE

			
			
cur_convenios CURSOR FOR
SELECT  cd_convenio,
		cd_categoria,
		cd_plano_convenio,
		dt_inicio_vigencia,
		dt_final_vigencia,
		dt_validade_carteira,
		cd_usuario_convenio,
		ie_tipo_conveniado,
		nm_usuario
from	atend_categoria_convenio
where	nr_atendimento = nr_atendimento_p
and	    cd_convenio <> coalesce(obter_convenio_tipo_pj(nr_atendimento), 0);

rec_convenios	cur_convenios%rowtype;



BEGIN

open cur_convenios;
loop
fetch cur_convenios into
        rec_convenios;
EXIT WHEN NOT FOUND; /* apply on cur_convenios */
	begin
		CALL atualiza_titular_convenio(rec_convenios.nm_usuario,
								  rec_convenios.cd_convenio,
								  rec_convenios.cd_categoria,
								  cd_pessoa_fisica_p,
								  rec_convenios.cd_plano_convenio,
								  rec_convenios.dt_inicio_vigencia,
								  rec_convenios.dt_final_vigencia,
								  rec_convenios.dt_validade_carteira,
								  rec_convenios.cd_usuario_convenio,
								  rec_convenios.ie_tipo_conveniado);
								
	end;
end loop;
close cur_convenios;

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
	CALL replicar_convenios_atendimento(nr_episodio_p, nr_atendimento_p, null);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE generate_info_insurance ( nr_episodio_p episodio_paciente.nr_sequencia%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_pessoa_fisica_p atendimento_paciente.cd_pessoa_fisica%type) FROM PUBLIC;

