-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_reg_c100_efd_piscofins ( nr_seq_controle_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, cd_empresa_p bigint, ds_separador_p text, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) AS $body$
DECLARE

 
cd_modelo_w			varchar(2);
nr_seq_regra_efd_w		bigint;
nr_versao_efd_w			varchar(5);
tp_registro_w			varchar(4);
nr_linha_w			bigint	:= qt_linha_p;
nr_seq_registro_w		bigint	:= nr_sequencia_p;
ds_arquivo_w			varchar(4000);
ds_arquivo_compl_w		varchar(4000);
ds_linha_w			varchar(8000);
sep_w				varchar(1)	:= ds_separador_p;
nr_sequencia_w			bigint;

c_valores CURSOR FOR 
	SELECT	'C100' tp_registro, 
		substr(CASE WHEN Obter_se_nota_entrada_saida(a.nr_sequencia)='E' THEN 0 WHEN Obter_se_nota_entrada_saida(a.nr_sequencia)='S' THEN 1 END ,1,1) ie_operacao, 
		a.ie_emissao_nf ie_emissao_nf, 
		coalesce(cd_pessoa_fisica, cd_cgc_emitente) cd_participante, 
		substr(CASE WHEN coalesce(nr_danfe,'X')='X' THEN  '01'  ELSE '55' END ,1,2) cd_modelo, 
		substr(CASE WHEN a.ie_situacao=1 THEN  '00' WHEN a.ie_situacao=2 THEN  '02' WHEN a.ie_situacao=3 THEN  '02' WHEN a.ie_situacao=9 THEN  '02' END ,1,2) cd_situacao, 
		substr(a.cd_serie_nf, 1, 3) cd_serie_nf, 
		substr(a.nr_nota_fiscal, 1, 9) nr_nota_fiscal, 
		a.nr_danfe nr_danfe, 
		substr(to_char(a.dt_emissao, 'ddmmyyyy'),1,8) dt_emissao, 
		substr(to_char(a.dt_entrada_saida, 'ddmmyyyy'),1,8) dt_entrada_saida, 
		a.vl_total_nota vl_total_nota, 
		substr(CASE WHEN coalesce(a.cd_condicao_pagamento,0)=0 THEN  9  ELSE CASE WHEN obter_dados_nota_fiscal(a.nr_sequencia, '28')=1 THEN  0  ELSE 1 END  END , 1, 1) ie_pagto, 
		a.vl_descontos vl_descontos, 
		0 vl_abatimento, 
		a.vl_mercadoria vl_mercadorias, 
		CASE WHEN a.ie_tipo_frete='C' THEN  1 WHEN a.ie_tipo_frete='F' THEN  2  ELSE 9 END  ie_tipo_frete, 
		a.vl_frete vl_frete, 
		a.vl_seguro vl_seguro, 
		a.vl_despesa_acessoria vl_despesa_acessoria, 
		nfe_obter_valores_totais_num(a.nr_sequencia, 'ICMS', 'BC') vl_base_calc_icms, 
		nfe_obter_valores_totais_num(a.nr_sequencia, 'ICMS', 'VL') vl_icms, 
		nfe_obter_valores_totais_num(a.nr_sequencia, 'ICMSST', 'BC') vl_base_calc_icms_st, 
		nfe_obter_valores_totais_num(a.nr_sequencia, 'ICMSST', 'VL') vl_icms_retido_st, 
		nfe_obter_valores_totais_num(a.nr_sequencia, 'IPI', 'VL') vl_ipi, 
		(SELECT	coalesce(sum(x.vl_tributo),0) 
		from	nota_fiscal_item_trib	x, 
			tributo			w 
		where	w.cd_tributo		= x.cd_tributo 
		and	x.nr_sequencia		= a.nr_sequencia 
		and 	w.ie_tipo_tributo	= 'PIS' 
		and	coalesce(x.ie_rateio,'N')	= 'N') vl_pis, 
		--and	x.ie_tributacao_cst >= 50 
		--and	x.ie_tributacao_cst <= 56) vl_pis, 
		--nfe_obter_valores_totais_num(a.nr_sequencia, 'PIS', 'VL') vl_pis, 
		(select	coalesce(sum(x.vl_tributo),0) 
		from	nota_fiscal_item_trib	x, 
			tributo			w 
		where	w.cd_tributo		= x.cd_tributo 
		and	x.nr_sequencia		= a.nr_sequencia 
		and 	w.ie_tipo_tributo	= 'COFINS' 
		and	coalesce(x.ie_rateio,'N')	= 'N') vl_cofins, 
		--and	x.ie_tributacao_cst >= 50 
		--and	x.ie_tributacao_cst <= 56) vl_cofins, 
		--nfe_obter_valores_totais_num(a.nr_sequencia, 'COFINS', 'VL') vl_cofins, 
		nfe_obter_valores_totais_num(a.nr_sequencia, 'PISST', 'VL') vl_pis_retido_st, 
		nfe_obter_valores_totais_num(a.nr_sequencia, 'COFINSST', 'VL') vl_cofins_retido_st, 
		a.nr_sequencia 
	from	nota_fiscal	a, 
		operacao_nota	b 
	where	a.cd_operacao_nf	= b.cd_operacao_nf 
	and	b.ie_servico		= 'N' 
	and	a.cd_estabelecimento	= cd_estabelecimento_p 
	and	a.dt_emissao between dt_inicio_p and dt_fim_p 
	and	b.cd_operacao_nf in (1,3,25,32) 
	order by 
		2;

vetval	c_valores%RowType;


BEGIN 
open c_valores;
loop 
fetch c_valores into	 
	vetval;
EXIT WHEN NOT FOUND; /* apply on c_valores */
	begin 
	nr_sequencia_w	:= vetval.nr_sequencia;
	cd_modelo_w	:= vetval.cd_modelo;
	 
	ds_linha_w	:= substr(	sep_w || vetval.tp_registro	 						|| 
					sep_w || vetval.ie_operacao							|| 
					sep_w || vetval.ie_emissao_nf							|| 
					sep_w || vetval.cd_participante	 						|| 
					sep_w || vetval.cd_modelo							|| 
					sep_w || vetval.cd_situacao							|| 
					sep_w || vetval.cd_serie_nf 							|| 
					sep_w || vetval.nr_nota_fiscal	 						|| 
					sep_w || vetval.nr_danfe							|| 
					sep_w || vetval.dt_emissao							|| 
					sep_w || vetval.dt_entrada_saida						|| 
					sep_w || substr(sped_obter_campo_valor(vetval.vl_total_nota), 1, 30)		|| 
					sep_w || vetval.ie_pagto		 					|| 
					sep_w || substr(sped_obter_campo_valor(vetval.vl_descontos), 1, 30) 		|| 
					sep_w || substr(sped_obter_campo_valor(vetval.vl_abatimento), 1, 30)		|| 
					sep_w || substr(sped_obter_campo_valor(vetval.vl_mercadorias), 1, 30)		|| 
					sep_w || vetval.ie_tipo_frete							|| 
					sep_w || substr(sped_obter_campo_valor(vetval.vl_frete), 1, 30)	 		|| 
					sep_w || substr(sped_obter_campo_valor(vetval.vl_seguro), 1, 30)		|| 
					sep_w || substr(sped_obter_campo_valor(vetval.vl_despesa_acessoria), 1,30)	|| 
					sep_w || substr(sped_obter_campo_valor(vetval.vl_base_calc_icms), 1, 30)	|| 
					sep_w || substr(sped_obter_campo_valor(vetval.vl_icms), 1, 30)			|| 
					sep_w || substr(sped_obter_campo_valor(vetval.vl_base_calc_icms_st), 1, 30)	|| 
					sep_w || substr(sped_obter_campo_valor(vetval.vl_icms_retido_st), 1, 30)	|| 
					sep_w || substr(sped_obter_campo_valor(vetval.vl_ipi), 1 ,30)			|| 
					sep_w || substr(sped_obter_campo_valor(vetval.vl_pis), 1, 30)			|| 
					sep_w || substr(sped_obter_campo_valor(vetval.vl_cofins), 1, 30)		|| 
					sep_w || substr(sped_obter_campo_valor(vetval.vl_pis_retido_st), 1, 30)		|| 
					sep_w || substr(sped_obter_campo_valor(vetval.vl_cofins_retido_st), 1, 30)	|| sep_w,1,8000);
	 
	ds_arquivo_w		:= substr(ds_linha_w,1,4000);
	ds_arquivo_compl_w	:= substr(ds_linha_w,4001,4000);
	nr_seq_registro_w	:= nr_seq_registro_w + 1;
	nr_linha_w		:= nr_linha_w + 1;
 
	insert into fis_efd_arquivo(nr_sequencia, 
		nm_usuario, 
		dt_atualizacao, 
		nm_usuario_nrec, 
		dt_atualizacao_nrec, 
		nr_seq_controle_efd, 
		nr_linha, 
		cd_registro, 
		ds_arquivo, 
		ds_arquivo_compl) 
	values (nr_seq_registro_w, 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nr_seq_controle_p, 
		nr_linha_w, 
		vetval.tp_registro, 
		ds_arquivo_w, 
		ds_arquivo_compl_w);
		 
	SELECT * FROM fis_gerar_reg_C170_efd(	nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_p, dt_inicio_p, dt_fim_p, cd_empresa_p, ds_separador_p, nr_sequencia_w, nr_linha_w, nr_seq_registro_w) INTO STRICT nr_linha_w, nr_seq_registro_w;
		 
	end;
end loop;
close c_valores;
 
commit;
 
qt_linha_p	:= nr_linha_w;
nr_sequencia_p	:= nr_seq_registro_w;	
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_reg_c100_efd_piscofins ( nr_seq_controle_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, cd_empresa_p bigint, ds_separador_p text, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) FROM PUBLIC;

