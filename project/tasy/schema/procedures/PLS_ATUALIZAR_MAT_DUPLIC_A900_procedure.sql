-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_mat_duplic_a900 ( cd_material_a900_p bigint, nr_seq_mat_unimed_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_material_pls_w		bigint;
ie_mat_med_w			varchar(5);
cd_unidade_medida_w		varchar(10);
ds_material_w                   varchar(500);
dt_inclusao_w			timestamp;
ie_origem_w			varchar(3);
nm_material_w			varchar(255);
dt_vinculo_w			timestamp;
ds_grupo_farmacologico_w	varchar(255);
ds_classe_farmacologico_w	varchar(255);
ds_principio_ativo_w		varchar(255);
nr_registro_anvisa_w		varchar(20);
dt_validade_anvisa_w		timestamp;
cd_cgc_w			varchar(14);
ds_especialidade_w		varchar(255);
ds_classe_w			varchar(255);
ie_unidade_utilizacao_w		varchar(10);
ds_observacao_w			varchar(4000);
ds_mat_sem_acento_w		varchar(255);
ds_nome_comercial_w		varchar(255);
nr_seq_estrutura_w		bigint;
nr_seq_marca_w			bigint;
ie_tipo_despesa_w		varchar(5);
cd_classe_material_w		integer;
ie_inconsistente_w		pls_material_unimed.ie_inconsistente%type;
ie_mat_pls_duplicado_w		pls_material_unimed.ie_mat_pls_duplicado%type;


C01 CURSOR FOR
	SELECT	/*+ USE_CONCAT*/		nr_seq_estrutura,
		ie_tipo,
		cd_classe_material
	from	pls_regra_vinc_mat_unimed
	where (ie_mat_med = ie_mat_med_w or ie_mat_med = 'A')
	and	coalesce(ds_grupo_farmacologico, ds_grupo_farmacologico_w)	= ds_grupo_farmacologico_w
	and	coalesce(ds_classe_farmacologico, ds_classe_farmacologico_w)	= ds_classe_farmacologico_w
	and (coalesce(ds_especialidade, ds_especialidade_w)		= ds_especialidade_w 	or coalesce(ds_especialidade_w::text, '') = '')
	and (coalesce(ds_classe, ds_classe_w)				= ds_classe_w 		or coalesce(ds_classe_w::text, '') = '')
	order 	by ds_grupo_farmacologico,
		ds_classe_farmacologico,
		ds_especialidade,
		ds_classe;


BEGIN
select 	max(nr_sequencia)
into STRICT	nr_seq_material_pls_w
from	pls_material
where	cd_material_ops = cd_material_a900_p;

if (nr_seq_material_pls_w IS NOT NULL AND nr_seq_material_pls_w::text <> '') then
	select	CASE WHEN ie_tipo='902' THEN 'MAT'  ELSE 'MED' END ,
		cd_unidade_medida,
		substr(ds_material,1,255),
		dt_atualizacao_nrec,
		CASE WHEN ie_origem='2' THEN 'I'  ELSE 'N' END ,
		substr(nm_material,1,255),
		dt_vinculo,
		coalesce(substr(ds_grupo_farmacologico,1,255),'X'),
		coalesce(substr(ds_classe_farmacologico,1,255),'X'),
		substr(ds_principio_ativo,1,255),
		nr_registro_anvisa,
		dt_validade_anvisa,
		cd_cnpj,
		substr(ds_especialidade,1,255),
		substr(ds_classe,1,255),
		coalesce(ie_inconsistente,'N'),
		coalesce(ie_mat_pls_duplicado,'N')
	into STRICT	ie_mat_med_w,
		cd_unidade_medida_w,
		ds_material_w,
		dt_inclusao_w,
		ie_origem_w,
		nm_material_w,
		dt_vinculo_w,
		ds_grupo_farmacologico_w,
		ds_classe_farmacologico_w,
		ds_principio_ativo_w,
		nr_registro_anvisa_w,
		dt_validade_anvisa_w,
		cd_cgc_w,
		ds_especialidade_w,
		ds_classe_w,
		ie_inconsistente_w,
		ie_mat_pls_duplicado_w
	from	pls_material_unimed
	where	nr_sequencia		= nr_seq_mat_unimed_p;

	ds_mat_sem_acento_w	:= padronizar_nome(ds_material_w);
	cd_unidade_medida_w	:= upper(cd_unidade_medida_w);

	if (ie_inconsistente_w = 'S') or (ie_mat_pls_duplicado_w = 'N') then
		goto final;
	end if;

	-- Tratamento de unidade de medida
	select	max(cd_unidade_medida)
	into STRICT	ie_unidade_utilizacao_w
	from	unidade_medida
	where	ie_situacao		= 'A'
	and	upper(cd_sistema_ant)	= cd_unidade_medida_w;

	if (coalesce(ie_unidade_utilizacao_w::text, '') = '') then
		select	max(cd_unidade_medida)
		into STRICT	ie_unidade_utilizacao_w
		from	unidade_medida
		where	ie_situacao			= 'A'
		and	upper(cd_unidade_medida)	= cd_unidade_medida_w;

		if (coalesce(ie_unidade_utilizacao_w::text, '') = '') then
			select	max(cd_unidade_medida)
			into STRICT	ie_unidade_utilizacao_w
			from	unidade_medida
			where	ie_situacao		= 'A'
			and	upper(cd_unidade_ptu)	= cd_unidade_medida_w;
		end if;
	end if;

	if (coalesce(ie_unidade_utilizacao_w::text, '') = '') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(216795,'CD_UNIDADE=' || cd_unidade_medida_w);
	end if;

	if (ie_mat_med_w = 'MAT') then
		ds_nome_comercial_w := nm_material_w;
		ds_observacao_w	:= ds_material_w;
		ds_material_w	:= nm_material_w;
		ds_mat_sem_acento_w := padronizar_nome(nm_material_w);
	elsif (ie_mat_med_w = 'MED') then
		ds_nome_comercial_w	:= nm_material_w;
		ds_observacao_w		:= ds_material_w;
		ds_material_w		:= ds_principio_ativo_w;
		ds_mat_sem_acento_w	:= padronizar_nome(ds_material_w);
	end if;

	open C01;
	loop
	fetch C01 into
		nr_seq_estrutura_w,
		ie_tipo_despesa_w,
		cd_classe_material_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		update	pls_material
		set	dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p,
			ie_tipo_despesa 	= ie_tipo_despesa_w,
			cd_estabelecimento 	= cd_estabelecimento_p,
			nr_seq_estrut_mat 	= nr_seq_estrutura_w,
			cd_unidade_medida 	= ie_unidade_utilizacao_w,
			ds_material		= coalesce(ds_material_w,nm_material_w),
			ds_material_sem_acento 	= ds_mat_sem_acento_w,
			ie_situacao 		= 'A',
			cd_material_ops 	= cd_material_a900_p,
			cd_material_a900 	= cd_material_a900_p,
			ie_origem 		= ie_origem_w,
			dt_inclusao 		= coalesce(dt_inclusao_w,trunc(clock_timestamp(),'dd')),
			nr_seq_material_unimed 	= nr_seq_mat_unimed_p,
			ie_revisar 		= 'R',
			ds_nome_comercial 	= ds_nome_comercial_w,
			ds_observacao 		= ds_observacao_w,
			nr_registro_anvisa 	= nr_registro_anvisa_w,
			dt_validade 		= dt_validade_anvisa_w,
			nr_seq_marca 		= nr_seq_marca_w
		where	nr_sequencia 		= nr_seq_material_pls_w;
		end;
	end loop;
	close C01;

	update	pls_material_unimed
	set	ie_mat_pls_duplicado	= 'N',
		dt_atualizacao_dup_mat	= clock_timestamp(),
		nm_usuario_dup_mat 	= nm_usuario_p,
		dt_vinculo		= clock_timestamp()
	where	nr_sequencia 		= nr_seq_mat_unimed_p;
end if;

commit;

<<final>>
nr_seq_material_pls_w	:= nr_seq_material_pls_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_mat_duplic_a900 ( cd_material_a900_p bigint, nr_seq_mat_unimed_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

