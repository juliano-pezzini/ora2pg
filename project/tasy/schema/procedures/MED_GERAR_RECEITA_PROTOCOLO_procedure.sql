-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE med_gerar_receita_protocolo ( nr_seq_cliente_p bigint, cd_pessoa_fisica_p text, nr_seq_prococolo_p bigint, nm_usuario_p text, nr_sequencia_p INOUT bigint) AS $body$
DECLARE



ds_texto_w		text;
ds_texto_banco_w		text;
ds_material_w		varchar(100);
nr_sequencia_w		bigint;
count_w			bigint;

C01 CURSOR FOR
	SELECT 	b.ds_material
	FROM med_medic_protocolo a, med_medic_padrao b
LEFT OUTER JOIN med_via_aplicacao c ON (b.ie_via_aplicacao = c.nr_sequencia)
WHERE a.nr_seq_medic 	= b.nr_sequencia  and a.nr_seq_protocolo 	= nr_seq_prococolo_p order by a.nr_seq_apresent;



BEGIN
	-- Verrificar se jÃ¡ existe
	select	count(*)
	into STRICT	count_w
	from    med_receita
	where   nr_seq_cliente 			= nr_seq_cliente_p
	and     to_date(dt_receita, 'dd/mm/yyyy') 	= to_date(clock_timestamp(), 'dd/mm/yyyy');

	if ( count_w > 0 ) then
		select	nr_sequencia
		into STRICT	nr_sequencia_w
		from    med_receita
		where   nr_seq_cliente 			= nr_seq_cliente_p
		and     to_date(dt_receita, 'dd/mm/yyyy') 	= to_date(clock_timestamp(), 'dd/mm/yyyy');

		select 	ds_receita
		into STRICT	ds_texto_w
		from	med_receita
		where 	nr_sequencia  = nr_sequencia_w;
	else
		ds_texto_w := '{\rtf1\ansi\deff0{\fonttbl{\f0\fnil\fcharset0 MS Sans Serif;}}{\colortbl ;\red0\green0\blue0;}\viewkind4\uc1\pard\cf1\lang1046\f0\fs24 ';
	end if;

	OPEN C01;
	LOOP
	FETCH C01 into
		ds_material_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
			ds_texto_banco_w		:=	ds_texto_banco_w ||'\par'||ds_material_w||'\par';
		end;
	END LOOP;
	CLOSE C01;

	ds_texto_banco_w	:=  substr(ds_texto_w, 0, length(ds_texto_w) - 1) ||'\par'||ds_texto_banco_w || ' }';

	if ( count_w = 0 ) then
		select 	max(nr_sequencia) +1
		into STRICT	nr_sequencia_w
		from	med_receita;

		insert	into	med_receita(
			NR_SEQUENCIA,
			DT_RECEITA,
			DS_RECEITA,
			CD_PESSOA_FISICA,
			NR_SEQ_CLIENTE,
			DT_ATUALIZACAO,
			NM_USUARIO
		)
		values (
			nr_sequencia_w,
			clock_timestamp(),
			ds_texto_banco_w,
			cd_pessoa_fisica_p,
			nr_seq_cliente_p,
			clock_timestamp(),
			nm_usuario_p
		);
	else
		update 	med_receita
		set	ds_receita	 	= 	ds_texto_banco_w,
			dt_atualizacao		=	clock_timestamp(),
			nm_usuario		=	nm_usuario_p
		where	nr_sequencia		=	nr_sequencia_w;
	end if;

commit;
nr_sequencia_p := nr_sequencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE med_gerar_receita_protocolo ( nr_seq_cliente_p bigint, cd_pessoa_fisica_p text, nr_seq_prococolo_p bigint, nm_usuario_p text, nr_sequencia_p INOUT bigint) FROM PUBLIC;

