-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_conpaci_desc_item (nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_interno_conta_w	bigint;

vl_desconto_w		double precision;
vl_liquido_w		double precision;
vl_conta_w			double precision;

vl_total_item_w		double precision;

pr_desconto_w		real;

nr_sequencia_w		bigint;

vl_liq_item_w		double precision;
vl_desc_item_w		double precision;

pr_desc_estrut_w	double precision;

cd_estrutura_w		integer;
cd_convenio_w		integer;
qt_regra_estrut_w	bigint;

ie_ok_w			integer;

ie_pacote_w		varchar(1);/* Incluido por Fabricio em 02/10/2008 OS 99776*/
ie_tipo_desconto_w		smallint;

qt_regra_desc_item_w	bigint;

C01 CURSOR FOR
	SELECT 	nr_sequencia,
		cd_estrutura
	from conta_paciente_desc_item
	where nr_seq_desconto = nr_sequencia_p
	  and ie_calcula = 'S'
	order by vl_conta;


BEGIN

select nr_interno_conta
into STRICT nr_interno_conta_w
from conta_paciente_desconto
where nr_sequencia = nr_sequencia_p;

select	cd_convenio_parametro
into STRICT	cd_convenio_w
from	conta_paciente
where 	nr_interno_conta	= nr_interno_conta_w;

select count(*)
into STRICT  ie_ok_w
from  conta_paciente_v
where nr_interno_conta = nr_interno_conta_w
and   coalesce(cd_motivo_exc_conta::text, '') = ''
and   coalesce(coalesce(ie_emite_conta_honor, ie_emite_conta)::text, '') = '';

if (ie_ok_w > 0) then
	-- Existem itens sem estrutura. Calculo cancelado !
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(243530);
end if;

select 	vl_desconto,
	vl_liquido,
	vl_conta,
	coalesce(ie_pacote,'A'),
	ie_tipo_desconto
into STRICT	vl_desconto_w,
	vl_liquido_w,
	vl_conta_w,
	ie_pacote_w,
	ie_tipo_desconto_w
from conta_paciente_desconto
where nr_sequencia = nr_sequencia_p;

select sum(vl_conta)
into STRICT vl_total_item_w
from conta_paciente_desc_item
where nr_seq_desconto = nr_sequencia_p
  and ie_calcula = 'S';

if (vl_total_item_w < vl_desconto_w) then
	-- Valor desconto maior que valor dos itens. Desconto cancelado !
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(243532);
end if;

pr_desconto_w := (vl_desconto_w * 100) / vl_total_item_w;

update conta_paciente_desc_item
set	pr_desconto = 0,
	vl_desconto = 0,
	vl_liquido  = vl_conta
where nr_seq_desconto = nr_sequencia_p
  and ie_calcula = 'N';

open C01;
loop
	fetch C01 into
		nr_sequencia_w,
		cd_estrutura_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */

	update conta_paciente_desc_item
	set pr_desconto = pr_desconto_w,
	    vl_desconto = (vl_conta /100) * pr_desconto_w,
	    vl_liquido  = vl_conta - ((vl_conta /100) * pr_desconto_w)
	where nr_sequencia = nr_sequencia_w;

	if (pr_desconto_w = 0) then
		select	coalesce(max(PR_DESCONTO), 0)
		into STRICT	pr_desc_estrut_w
		from	CONVENIO_REGRA_DESC_ESTRUT
		where	cd_convenio	= cd_convenio_w
		and	cd_estrutura	= cd_estrutura_w;

	update 	conta_paciente_desc_item
	set 	pr_desconto 	= pr_desc_estrut_w,
		vl_desconto	= (vl_conta /100) * pr_desc_estrut_w,
		vl_liquido 	= vl_conta - ((vl_conta /100) * pr_desc_estrut_w)
	where	nr_sequencia 	= nr_sequencia_w;

	end if;

end loop;
close C01;

select sum(vl_liquido),
	 sum(vl_desconto)
into STRICT	vl_liq_item_w,
	vl_desc_item_w
from conta_paciente_desc_item
where nr_seq_desconto = nr_sequencia_p;

select	count(*)
into STRICT	qt_regra_estrut_w
from	CONVENIO_REGRA_DESC_ESTRUT
where	cd_convenio	= cd_convenio_w
and	cd_estrutura	= cd_estrutura_w
and	(pr_desconto IS NOT NULL AND pr_desconto::text <> '')
and	pr_desconto_w = 0;

if (qt_regra_estrut_w = 0) and (ie_pacote_w = 'A') and (ie_tipo_desconto_w <> 7) and
	((vl_liquido_w  <> vl_liq_item_w) or (vl_desconto_w <> vl_desc_item_w)) then
	update conta_paciente_desc_item
	set	vl_desconto = vl_desconto + (vl_desconto_w - vl_desc_item_w),
		vl_liquido  = vl_liquido  + (vl_liquido_w - vl_liq_item_w)
	where nr_sequencia = nr_sequencia_w;
end if;

select	count(*)
into STRICT	qt_regra_desc_item_w
from	conv_regra_desc a,
	conv_regra_desc_item b
where	a.nr_sequencia = b.nr_seq_regra_desc
and	a.cd_convenio = cd_convenio_w;

if (qt_regra_desc_item_w > 0) then	
	CALL Gerar_Conv_Regra_Desc(nr_sequencia_p,nm_usuario_p);	
end if;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_conpaci_desc_item (nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

