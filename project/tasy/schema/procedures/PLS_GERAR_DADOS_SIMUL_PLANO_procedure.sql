-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_dados_simul_plano ( nr_seq_simul_perfil_p bigint, nr_seq_tabela_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_plano_w			bigint;
qt_idade_inicial_w		bigint;
qt_idade_final_w		bigint;
qt_beneficiario_w		bigint;
qt_total_beneficiarios_w	bigint := 0;
vl_preco_faixa_etaria_w		double precision := 0;
vl_preco_original_w		double precision := 0;
vl_preco_tot_original_w		double precision := 0;
vl_tot_preco_faixa_w		double precision := 0;
tx_indice_perfil_w		double precision;

C01 CURSOR FOR
	SELECT	qt_idade_inicial,
		qt_idade_final,
		qt_beneficiario
	from	pls_simulpreco_coletivo
	where	nr_seq_simul_perfil	= nr_seq_simul_perfil_p;


BEGIN

select	max(nr_seq_plano)
into STRICT	nr_seq_plano_w
from	pls_tabela_preco
where	nr_sequencia	= nr_seq_tabela_p;

select	max(tx_indice)
into STRICT	tx_indice_perfil_w
from	pls_simulacao_perfil
where	nr_sequencia		= nr_seq_simul_perfil_p;

if (coalesce(tx_indice_perfil_w::text, '') = '') or (tx_indice_perfil_w = 0) then
	tx_indice_perfil_w	:= 1;
end if;

open C01;
loop
fetch C01 into
	qt_idade_inicial_w,
	qt_idade_final_w,
	qt_beneficiario_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	begin
	select	max(vl_preco_atual)
	into STRICT	vl_preco_faixa_etaria_w
	from	pls_plano_preco
	where	nr_seq_tabela		= nr_seq_tabela_p
	and	qt_idade_inicial	= qt_idade_inicial_w
	and	qt_idade_final		= qt_idade_final_w;
	exception
	when others then
		vl_preco_faixa_etaria_w	:= 0;
	end;

	if (coalesce(vl_preco_faixa_etaria_w::text, '') = '') then
		vl_preco_faixa_etaria_w	:= 0;
	end if;

	vl_preco_original_w	:= vl_preco_faixa_etaria_w;
	vl_preco_tot_original_w	:= vl_preco_tot_original_w + vl_preco_original_w;

	vl_preco_faixa_etaria_w	:= vl_preco_faixa_etaria_w * tx_indice_perfil_w;

	insert into pls_simulacao_plano(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
			nr_seq_plano,nr_seq_tabela,nr_seq_simul_perfil,qt_idade_inicial,qt_idade_final,
			vl_preco_faixa,qt_vidas,vl_preco_original)
	values (	nextval('pls_simulacao_plano_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
			nr_seq_plano_w,nr_seq_tabela_p,nr_seq_simul_perfil_p,qt_idade_inicial_w,qt_idade_final_w,
			vl_preco_faixa_etaria_w,qt_beneficiario_w,vl_preco_original_w);

	vl_tot_preco_faixa_w		:= vl_tot_preco_faixa_w + vl_preco_faixa_etaria_w * qt_beneficiario_w;
	qt_total_beneficiarios_w	:= qt_total_beneficiarios_w + qt_beneficiario_w;

	end;
end loop;
close C01;

insert into pls_simulacao_plano(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
		nr_seq_plano,nr_seq_tabela,nr_seq_simul_perfil,vl_preco_faixa,qt_vidas,
		qt_idade_final,qt_idade_inicial,vl_preco_original)
values (	nextval('pls_simulacao_plano_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
		nr_seq_plano_w,nr_seq_tabela_p,nr_seq_simul_perfil_p,vl_tot_preco_faixa_w,qt_total_beneficiarios_w,
		0,0,vl_preco_tot_original_w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_dados_simul_plano ( nr_seq_simul_perfil_p bigint, nr_seq_tabela_p bigint, nm_usuario_p text) FROM PUBLIC;

