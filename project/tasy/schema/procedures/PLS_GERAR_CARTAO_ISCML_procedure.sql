-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_cartao_iscml ( nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_razao_social_w	pessoa_juridica.ds_razao_social%type;
ds_plano_w		pls_plano.ds_plano%type;
ie_acomodacao_w		pls_plano.ie_acomodacao%type;
ds_acomodacao_w		varchar(255);
ds_carencia_1_w		varchar(255);
ds_carencia_2_w		varchar(255);
ds_carencia_3_w		varchar(255);
ds_carencia_4_w		varchar(255);
ds_carencia_5_w		varchar(255);
ds_carencia_6_w		varchar(255);
ds_carencia_7_w		varchar(255);
nr_carencia_w		bigint;
nm_titular_w		varchar(255);
ds_segmentacao_w	varchar(255);

C01 CURSOR FOR
	SELECT	b.nr_sequencia nr_seq_segurado,
		pls_obter_dados_segurado(b.nr_sequencia, 'N') nm_segurado,
		a.cd_usuario_plano,
		pls_obter_dados_segurado(b.nr_seq_titular, 'N') nm_titular,
		b.nr_seq_contrato,
		b.nr_seq_plano,
		e.dt_nascimento,
		b.dt_contratacao,
		a.nr_via_solicitacao,
		a.dt_inicio_vigencia,
		e.nr_cartao_nac_sus
	from	pls_segurado_carteira	a,
		pls_segurado		b,
		pls_carteira_emissao	c,
		pls_lote_carteira	d,
		pessoa_fisica		e
	where	b.nr_sequencia		= a.nr_seq_segurado
	and	a.nr_sequencia		= c.nr_seq_seg_carteira
	and	d.nr_sequencia 		= c.nr_seq_lote
	and	e.cd_pessoa_fisica	= b.cd_pessoa_fisica
	and	d.nr_sequencia		= nr_seq_lote_p
	order by
		nm_segurado;

C02 CURSOR(	nr_seq_segurado_pc	pls_segurado.nr_sequencia%type,
		dt_inicio_pc		pls_segurado_carteira.dt_inicio_vigencia%type) FOR
	SELECT	substr(pls_obter_dados_carencia(nr_sequencia, nr_seq_segurado, 'N'),1,255) ds_carencia,
		dt_fim_vigencia
	from	pls_carencia
	where	nr_seq_segurado = nr_seq_segurado_pc
	and	dt_fim_vigencia > dt_inicio_pc
	and	ie_cpt = 'N'
	order by
		dt_fim_vigencia LIMIT 7;
BEGIN

delete	FROM w_pls_interface_carteira
where	nr_seq_lote	= nr_seq_lote_p;

for r_c01_w in c01 loop
	begin
	if (r_c01_w.nm_titular IS NOT NULL AND r_c01_w.nm_titular::text <> '') then
		nm_titular_w	:= r_c01_w.nm_titular;
	else
		nm_titular_w	:= ' ';
	end if;

	select	substr(max(b.ds_razao_social),1,45)
	into STRICT	ds_razao_social_w
	from	pls_contrato a,
		pessoa_juridica b
	where	a.cd_cgc_estipulante = b.cd_cgc
	and	a.nr_sequencia = r_c01_w.nr_seq_contrato;

	if (coalesce(ds_razao_social_w::text, '') = '') then
		ds_razao_social_w := ' ';
	end if;

	select	substr(max(ds_plano),1,40),
		max(ie_acomodacao),
		obter_valor_dominio(1665, max(ie_segmentacao))
	into STRICT	ds_plano_w,
		ie_acomodacao_w,
		ds_segmentacao_w
	from	pls_plano
	where	nr_sequencia = r_c01_w.nr_seq_plano;

	if (ie_acomodacao_w = 'C') then
		ds_acomodacao_w	:= 'ENFERMARIA';
	elsif (ie_acomodacao_w = 'I') then
		ds_acomodacao_w	:= 'APARTAMENTO';
	else
		ds_acomodacao_w := ' ';
	end if;

	nr_carencia_w	:= 0;
	ds_carencia_1_w	:= '';
	ds_carencia_2_w := '';
	ds_carencia_3_w	:= '';
	ds_carencia_4_w	:= '';
	ds_carencia_5_w	:= '';
	ds_carencia_6_w	:= '';
	ds_carencia_7_w	:= '';

	for r_c02_w in c02(r_c01_w.nr_seq_segurado, r_c01_w.dt_inicio_vigencia) loop
		begin
		nr_carencia_w := nr_carencia_w + 1;

		if (nr_carencia_w = 1) then
			ds_carencia_1_w	:= to_char(r_c02_w.dt_fim_vigencia,'dd/mm/yyyy') || r_c02_w.ds_carencia;
		elsif (nr_carencia_w = 2) then
			ds_carencia_2_w	:= to_char(r_c02_w.dt_fim_vigencia,'dd/mm/yyyy') || r_c02_w.ds_carencia;
		elsif (nr_carencia_w = 3) then
			ds_carencia_3_w := to_char(r_c02_w.dt_fim_vigencia,'dd/mm/yyyy') || r_c02_w.ds_carencia;
		elsif (nr_carencia_w = 4) then
			ds_carencia_4_w := to_char(r_c02_w.dt_fim_vigencia,'dd/mm/yyyy') || r_c02_w.ds_carencia;
		elsif (nr_carencia_w = 5) then
			ds_carencia_5_w := to_char(r_c02_w.dt_fim_vigencia,'dd/mm/yyyy') || r_c02_w.ds_carencia;
		elsif (nr_carencia_w = 6) then
			ds_carencia_6_w := to_char(r_c02_w.dt_fim_vigencia,'dd/mm/yyyy') || r_c02_w.ds_carencia;
		elsif (nr_carencia_w = 7) then
			ds_carencia_7_w := to_char(r_c02_w.dt_fim_vigencia,'dd/mm/yyyy') || r_c02_w.ds_carencia;
		end if;

		end;
	end loop;

	insert	into	w_pls_interface_carteira(	nr_sequencia, dt_atualizacao, nm_usuario,
			dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_lote,
			ie_tipo_reg, cd_usuario_plano, nm_beneficiario,
			nm_titular, ds_estipulante, nm_plano,
			dt_nascimento, dt_adesao, ds_acomodacao,
			nr_via_cartao, ds_cns, ds_carencia_1,
			ds_carencia_2, ds_carencia_3, ds_carencia_4,
			ds_carencia_5, ds_carencia_6, ds_carencia_7,
			ds_segmentacao)
	values (	nextval('w_pls_interface_carteira_seq'), clock_timestamp(), nm_usuario_p,
			clock_timestamp(), nm_usuario_p, nr_seq_lote_p,
			2, substr(rpad(r_c01_w.cd_usuario_plano, 10, ' '), 1, 10), substr(rpad(r_c01_w.nm_segurado, 40, ' '), 1, 40),
			substr(rpad(nm_titular_w, 45, ' '), 1, 45), substr(rpad(ds_razao_social_w, 45, ' '), 1, 45), substr(rpad(ds_plano_w, 40, ' '), 1, 40),
			substr(rpad(to_char(r_c01_w.dt_nascimento, 'dd/mm/yyyy'), 15, ' '), 1, 15), substr(rpad(to_char(r_c01_w.dt_contratacao, 'dd/mm/yyyy'), 15, ' '), 1, 15), substr(rpad(ds_acomodacao_w, 40, ' '), 1, 40),
			substr(lpad(r_c01_w.nr_via_solicitacao, 2, '0'), 1, 2), substr(rpad(to_char(r_c01_w.nr_cartao_nac_sus), 20, ' '), 1, 20), substr(rpad(ds_carencia_1_w, 50, ' '), 1, 50),
			substr(rpad(ds_carencia_2_w, 50, ' '), 1, 50), substr(rpad(ds_carencia_3_w, 50, ' '), 1, 50), substr(rpad(ds_carencia_4_w, 50, ' '), 1, 50),
			substr(rpad(ds_carencia_5_w, 50, ' '), 1, 50), substr(rpad(ds_carencia_6_w, 50, ' '), 1, 50), substr(rpad(ds_carencia_7_w, 50, ' '), 1, 50),
			substr(rpad(ds_segmentacao_w, 45, ' '), 1, 45));
	end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_cartao_iscml ( nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

