-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_analise_recalcular_pgto ( nr_seq_analise_p bigint, nr_seq_item_p bigint, ie_tipo_item_p text, nr_seq_grupo_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

			 
/* 
Depreciada. 
Utilizar pls_grava_glosa_analise_conta. 
 
 
 
Diego 24/05/2011 - OS 319477 
Esta rotina tem o propósito de recalcular os valores de pagamento de um determinado item na análise. 
Estes valores serão recalculados na conta médica e após este processo serão atualizados na análise. 
 
 
Parâmetros: 
nr_seq_analise_p	Sequencia númerica da análise 
nr_seq_item_p	Sequencia das tabelas pls_conta_proc ou pls_conta_mat 
ie_tipo_item_p	P (Procedimentos) 	-	M (Material) 
*/
 
 
nr_seq_conta_w		bigint;
ie_tipo_despesa_w	smallint;
ie_tipo_item_w		varchar(2);


BEGIN 
 
ie_tipo_item_w	:= substr(ie_tipo_item_p, 1, 1);
 
if (ie_tipo_item_w = 'P') then 
	select	nr_seq_conta, 
		ie_tipo_despesa 
	into STRICT	nr_seq_conta_w, 
		ie_tipo_despesa_w 
	from	pls_conta_proc 
	where	nr_sequencia = nr_seq_item_p;
	 
	if (ie_tipo_despesa_w = '1') then /* Atualizar o valor do procedimento */
 
		CALL pls_atualiza_valor_proc(nr_seq_item_p, 'S', nm_usuario_p,'S',null,null);
	elsif (ie_tipo_despesa_w in ('2','3')) then /* Atualizar os valores das taxas e diárias */
 
		CALL pls_atualiza_valor_servico(nr_seq_item_p, 'S', nm_usuario_p,'S');
	elsif (ie_tipo_despesa_w = '4') then /* Atualizar os valores dos pacotes */
 
		CALL pls_atualiza_valor_pacote(nr_seq_item_p, 'C', nm_usuario_p, 'S', 'N');
	end if;
 
	CALL pls_atualizar_glosas_pgto(nr_seq_item_p, null, nm_usuario_p, nr_seq_grupo_p, cd_estabelecimento_p, nr_seq_analise_p);	
	 
elsif (ie_tipo_item_w = 'M') then 
 
	select	nr_seq_conta, 
		ie_tipo_despesa 
	into STRICT	nr_seq_conta_w, 
		ie_tipo_despesa_w 
	from	pls_conta_mat 
	where	nr_sequencia = nr_seq_item_p;
 
	CALL pls_atualiza_valor_mat(nr_seq_item_p, 'N', nm_usuario_p,null,null);
	 
	CALL pls_atualizar_glosas_pgto(null, nr_seq_item_p, nm_usuario_p, nr_seq_grupo_p, cd_estabelecimento_p, nr_seq_analise_p);	
end if;
 
CALL pls_atualiza_conta_resumo_item(nr_seq_item_p, ie_tipo_item_w, nm_usuario_p,'N');
 
/*Atualizar os valores da análise*/
 
CALL pls_atualizar_valores_analise(nr_seq_conta_w, nm_usuario_p, cd_estabelecimento_p);
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_analise_recalcular_pgto ( nr_seq_analise_p bigint, nr_seq_item_p bigint, ie_tipo_item_p text, nr_seq_grupo_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

