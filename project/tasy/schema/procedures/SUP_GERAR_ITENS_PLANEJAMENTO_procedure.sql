-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sup_gerar_itens_planejamento ( cd_estabelecimento_p bigint, nr_seq_planejamento_p bigint, nm_usuario_p text) AS $body$
DECLARE


ie_padronizado_w		varchar(1);
ie_gerar_w		varchar(1);
cd_grupo_material_w	smallint;
cd_subgrupo_material_w	smallint;
cd_classe_material_w	integer;
cd_material_w		integer;
nr_seq_fabric_w		bigint;
cd_material_estoque_w	integer;
ie_curva_abc_w		varchar(1);
ie_material_estoque_w	varchar(1);
ie_consignado_w		varchar(1);
nr_seq_marca_w		bigint;

C01 CURSOR FOR
	SELECT	ie_padronizado,
		ie_curva_abc,
		ie_material_estoque,
		ie_consignado,
		ie_gerar,
		cd_grupo_material,
		cd_subgrupo_material,
		cd_classe_material,
		cd_material,
		nr_seq_fabric,
		nr_seq_marca
	from	sup_regra_planej_compras
	where	nr_seq_planejamento = nr_seq_planejamento_p
	order by	nr_sequencia;

C02 CURSOR FOR
	SELECT	distinct
		(Obter_Mat_Comercial(a.cd_material, 'C'))::numeric  cd_material_comercial
	from	estrutura_material_v b,
		material a
	where	a.cd_material = b.cd_material
	and	a.ie_situacao = 'A'
	--and	(obter_tipo_material(a.cd_material,'C') <> '3')
	and	substr(obter_se_mat_ressuprimento(cd_estabelecimento_p, a.cd_material),1,1) = 'S'
	and	coalesce(cd_grupo_material_w,b.cd_grupo_material) = b.cd_grupo_material
	and	coalesce(cd_subgrupo_material_w,b.cd_subgrupo_material) = b.cd_subgrupo_material
	and	coalesce(cd_classe_material_w,b.cd_classe_material) = b.cd_classe_material
	and	coalesce(cd_material_w,a.cd_material) = a.cd_material
	and	((ie_padronizado_w = 'A') or (obter_se_material_padronizado(cd_estabelecimento_p,a.cd_material) = ie_padronizado_w))
	and	((ie_curva_abc_w = 'T') or (substr(Obter_Curva_ABC_Estab(cd_estabelecimento_p,a.cd_material,'N',clock_timestamp()),1,1) = ie_curva_abc_w))
	and	((ie_material_estoque_w = 'A') or (substr(obter_se_material_estoque(cd_estabelecimento_p,null,a.cd_material),1,1) = ie_material_estoque_w))
	and	((coalesce(ie_consignado_w::text, '') = '') or (substr(Obter_se_mat_Consignado(a.cd_material),1,1) = ie_consignado_w))
	and (exists (
			SELECT	y.cd_material
			from	material_marca y
			where	y.cd_material	= a.cd_material
			and	coalesce(y.ie_situacao,'A') = 'A'
			and	y.nr_sequencia	= nr_seq_marca_w) or (coalesce(nr_seq_marca_w::text, '') = ''));

BEGIN
delete	from sup_regra_planej_item
where	nr_seq_planejamento = nr_seq_planejamento_p;
commit;

open C01;
loop
fetch C01 into
	ie_padronizado_w,
	ie_curva_abc_w,
	ie_material_estoque_w,
	ie_consignado_w,
	ie_gerar_w,
	cd_grupo_material_w,
	cd_subgrupo_material_w,
	cd_classe_material_w,
	cd_material_w,
	nr_seq_fabric_w,
	nr_seq_marca_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	open C02;
	loop
	fetch C02 into
		cd_material_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		select	cd_material_estoque
		into STRICT	cd_material_estoque_w
		from	material
		where	cd_material = cd_material_w;

		if (ie_gerar_w = 'S') then
			begin
			insert into sup_regra_planej_item(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_planejamento,
				cd_material,
				qt_consumo_diario,
				qt_tot_compra,
				qt_entrega,
				qt_est_atual,
				qt_cons_prev,
				qt_entrega_prev,
				qt_falta_prim_entrega,
				qt_est_prev_entrega,
				vl_preco_unitario)
			values (nextval('sup_regra_planej_item_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_planejamento_p,
				cd_material_w,
				0,
				0,
				0,
				0,
				0,
				0,
				0,
				0,
				0);
			end;
		end if;
		end;
	end loop;
	close c02;
	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_gerar_itens_planejamento ( cd_estabelecimento_p bigint, nr_seq_planejamento_p bigint, nm_usuario_p text) FROM PUBLIC;

