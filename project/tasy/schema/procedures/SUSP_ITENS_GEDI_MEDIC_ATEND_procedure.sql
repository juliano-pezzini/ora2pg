-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE susp_itens_gedi_medic_atend (nr_atendimento_p bigint, nr_prescricao_p bigint, cd_material_p bigint, nr_seq_horario_p bigint, nr_seq_lote_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint ) AS $body$
DECLARE


dt_status_lote_item_w	timestamp;
ie_status_lote_w		ap_lote.ie_status_lote%type;			
nr_sequencia_w			gedi_medic_atend.nr_sequencia%type;
nr_seq_gerado_w			gedi_medic_atend.nr_sequencia%type;
nr_seq_atual_w			gedi_medic_atend.nr_sequencia%type;
ds_sequencia_w			varchar(4000);
nr_seq_aux_w			varchar(4000);
posicao_w 				varchar(4000);

c01 CURSOR FOR
    SELECT 	nr_sequencia
    from   	gedi_medic_atend
    where  	(nr_sequencia >= nr_sequencia_w
	and		(((nr_seq_gerado_w IS NOT NULL AND nr_seq_gerado_w::text <> '') and nr_sequencia < nr_seq_gerado_w) or ((nr_seq_atual_w IS NOT NULL AND nr_seq_atual_w::text <> '') and nr_sequencia <= nr_seq_atual_w)))
	and		ie_status not in ('S','E')
    and	   	nr_atendimento 	= nr_atendimento_p
    and	   	cd_material 	= cd_material_p;


BEGIN

if (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') then

	select	max(dt_supensao)
	into STRICT	dt_status_lote_item_w
	from	ap_lote_item
	where	nr_seq_lote		= nr_seq_lote_p
	and		nr_seq_mat_hor	= nr_seq_horario_p;
	
	select	max(ie_status_lote)
	into STRICT	ie_status_lote_w
	from	ap_lote
	where	nr_sequencia 	= nr_seq_lote_p;

	if (dt_status_lote_item_w IS NOT NULL AND dt_status_lote_item_w::text <> '') and (ie_status_lote_w <> 'A') and (ie_status_lote_w <> 'D') then
		begin
		
		select	max(nr_sequencia)
		into STRICT 	nr_sequencia_w
	  	from	gedi_medic_atend
		where	nr_seq_horario = nr_seq_horario_p;

		if (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') then

			select 	min(nr_sequencia)
			into STRICT	nr_seq_gerado_w
			from   	gedi_medic_atend
			where  	ie_status 		= 'G'
			and		nr_sequencia 	> nr_sequencia_w
			and		cd_material 	= cd_material_p
			and		nr_atendimento	= nr_atendimento_p;
			
			if (coalesce(nr_seq_gerado_w::text, '') = '') then
			
				select 	max(nr_sequencia)
				into STRICT	nr_seq_atual_w
				from   	gedi_medic_atend
				where  	ie_status 		= 'A'
				and		nr_sequencia 	> nr_sequencia_w
				and		cd_material 	= cd_material_p
				and		nr_atendimento	= nr_atendimento_p;
				
			end if;

			if (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') and
				((nr_seq_gerado_w IS NOT NULL AND nr_seq_gerado_w::text <> '') or (nr_seq_atual_w IS NOT NULL AND nr_seq_atual_w::text <> '')) then	

				open c01;
				loop
				fetch c01 into
				nr_seq_aux_w;
				EXIT WHEN NOT FOUND; /* apply on c01 */
				begin

				if	((coalesce(ds_sequencia_w::text, '') = '') or (position(nr_seq_aux_w in ds_sequencia_w) = 0)) then
					ds_sequencia_w := ds_sequencia_w ||','|| nr_seq_aux_w;
				end if;

				end;
				end loop;
				close c01;

				if (ds_sequencia_w IS NOT NULL AND ds_sequencia_w::text <> '') then
					begin

					select  length(ds_sequencia_w)
					into STRICT 	posicao_w
					;

					ds_sequencia_w := substr(ds_sequencia_w,2,posicao_w);

					update		gedi_medic_atend
					set			ie_status	 =	'S'
					where 		nr_sequencia in (SELECT w.nr_registro from table(lista_pck.obter_lista(ds_sequencia_w)) w);
					
					end;
				end if;
				
			end if;
		
		end if;

		end;
	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE susp_itens_gedi_medic_atend (nr_atendimento_p bigint, nr_prescricao_p bigint, cd_material_p bigint, nr_seq_horario_p bigint, nr_seq_lote_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint ) FROM PUBLIC;

