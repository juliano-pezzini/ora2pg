-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consistir_sca_inclusao ( nr_seq_inclusao_p bigint, nr_seq_plano_sca_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE


qt_idade_sca_w			bigint;
qt_idade_benef_w		bigint;
ds_erro_w			varchar(4000);
qt_retorno_plano_w		bigint;
ds_plano_w			varchar(255);
ie_grau_dependencia_w		varchar(10);
ds_dependencia_w		varchar(255);
ie_titularidade_seg_w		varchar(10);
qt_idade_min_sca_w		bigint;


BEGIN

/*Dados do benefici√°rio*/

select	trunc(months_between(clock_timestamp(), DT_NASCIMENTO) / 12),
	CASE WHEN coalesce(NR_SEQ_TITULAR_CONTRATO::text, '') = '' THEN CASE WHEN coalesce(nm_titular_inclusao::text, '') = '' THEN CASE WHEN coalesce(NR_SEQ_TITULAR_SOLIC::text, '') = '' THEN 'T'  ELSE 'D' END   ELSE 'D' END   ELSE 'D' END
into STRICT	qt_idade_benef_w,
	ie_titularidade_seg_w
from	PLS_INCLUSAO_BENEFICIARIO	a
where	a.nr_sequencia			= nr_seq_inclusao_p;

/*Dados do SCA*/

select	qt_idade_sca,
	coalesce(ie_grau_dependencia,'A'),
	ds_plano,
	qt_idade_min_sca
into STRICT	qt_idade_sca_w,
	ie_grau_dependencia_w,
	ds_plano_w,
	qt_idade_min_sca_w
from	pls_plano
where	nr_sequencia	= nr_seq_plano_sca_p;

select	count(*)
into STRICT	qt_retorno_plano_w
from	pls_plano
where	nr_sequencia 		= nr_seq_plano_sca_p
and	ie_tipo_operacao	<> 'A';

select	CASE WHEN ie_grau_dependencia_w='T' THEN 'titular'  ELSE 'dependente' END
into STRICT	ds_dependencia_w
;

if	(ie_grau_dependencia_w <> 'A' AND ie_grau_dependencia_w <> ie_titularidade_seg_w) then
	ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(280876, 'DS_PLANO_P=' || ds_plano_w || ';DS_DEPENDENCIA_P=' || ds_dependencia_w);
end if;

if (coalesce(qt_retorno_plano_w,0) > 0) then
	ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(280881);
end if;

if	((qt_idade_benef_w > coalesce(qt_idade_sca_w,qt_idade_benef_w)) or (qt_idade_benef_w < coalesce(qt_idade_min_sca_w,qt_idade_benef_w))) then
	ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(280887);
end if;

ds_erro_p	:= ds_erro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consistir_sca_inclusao ( nr_seq_inclusao_p bigint, nr_seq_plano_sca_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

