-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_impr_adic_prescricao ( nr_prescricao_p bigint, ie_regra_lib_p text, nm_usuario_p text) AS $body$
DECLARE



qt_reg_w			bigint;
cd_setor_atendimento_w		bigint;
nr_seq_regra_w			bigint;
nr_sequencia_w			bigint;
ie_lib_farmacia_w		varchar(1);
dt_liberacao_w			timestamp;
ie_dia_semana_w			varchar(01);
cd_estabelecimento_w		smallint;
cd_material_w			integer;
cd_grupo_material_w		smallint;
cd_subgrupo_w			smallint;
cd_classe_material_w		integer;
nr_seq_atend_w			bigint;
nr_seq_familia_w		bigint;
nr_seq_regra_motivo_w		bigint;
qt_existe_w			bigint;
cd_dieta_w			bigint;
dt_lib_enf_w			timestamp;
ds_erro_w			varchar(2000);
cd_medico_w			varchar(10);
ie_adep_w			varchar(10);
ie_lib_enfermagem_w		varchar(10);
ie_motivo_prescricao_w		varchar(10);
ie_interv_farm_w		varchar(10);
cd_prescritor_w			varchar(10);
cd_pessoa_usuario_w		varchar(50);
ie_feriado_w			varchar(1);
qt_npt_w			bigint;

ie_rastre_prescr_libfarm_w		varchar(1);
ds_rastre_prescr_libfarm_w		varchar(4000);
ds_rastre_prescr_lf_item_w		varchar(4000);
nr_seq_material_w					prescr_material.nr_sequencia%type;
nr_seq_dieta_w						prescr_dieta.nr_sequencia%type;

C01 CURSOR FOR
	SELECT	nr_sequencia,
		cd_material
	from	prescr_material
	where	nr_prescricao		= nr_prescricao_p;
	
c03 CURSOR FOR
	SELECT	nr_sequencia,
		cd_dieta
	from	prescr_dieta
	where	nr_prescricao		= nr_prescricao_p;

C02 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.ie_lib_farmacia,
		a.ie_lib_enfermagem
	FROM regra_impr_prescr_setor b
LEFT OUTER JOIN regra_impr_prescricao a ON (b.nr_seq_regra = a.nr_sequencia)
WHERE a.cd_estabelecimento		= cd_estabelecimento_w and a.ie_situacao			= 'A'  and coalesce(b.cd_setor_atendimento, cd_setor_atendimento_w)	= cd_setor_atendimento_w and coalesce(b.cd_grupo_material, cd_grupo_material_w)		= cd_grupo_material_w and coalesce(b.cd_subgrupo_material, cd_subgrupo_w)		= cd_subgrupo_w and coalesce(b.cd_classe_material, cd_classe_material_w)		= cd_classe_material_w and coalesce(b.cd_material, cd_material_w)			= cd_material_w and coalesce(b.ie_adep, ie_adep_w)				= ie_adep_w and ((coalesce(ie_considera_quimio,'S') = 'S') or (coalesce(nr_seq_atend_w::text, '') = '')) and ((coalesce(ie_feriado,'S') = 'S') or (ie_feriado_w = 'N')) and ((coalesce(b.nr_seq_familia, nr_seq_familia_w)		= nr_seq_familia_w) or (coalesce(b.nr_seq_familia::text, '') = '')) and ((coalesce(b.ie_dia_semana::text, '') = '') or
		 (b.ie_dia_semana = ie_dia_semana_w or ((b.ie_dia_semana = 9) and (pkg_date_utils.IS_BUSINESS_DAY(dt_liberacao_w) = 1))))  -- ie_dia_semana_w not in (7,1)
  and (((coalesce(b.dt_hora_inicio::text, '') = '') or (coalesce(b.dt_hora_fim::text, '') = '')) or (PKG_DATE_UTILS.get_DateTime(clock_timestamp(), coalesce(CASE WHEN a.ie_lib_enfermagem='S' THEN dt_lib_enf_w  ELSE dt_liberacao_w END , PKG_DATE_UTILS.GET_TIME('00:00:00')) ) between 
		  PKG_DATE_UTILS.get_DateTime(clock_timestamp(), coalesce(b.dt_hora_inicio, PKG_DATE_UTILS.GET_TIME('00:00:00')) ) and 
		  PKG_DATE_UTILS.get_DateTime(clock_timestamp(), coalesce(b.dt_hora_fim, PKG_DATE_UTILS.GET_TIME('00:00:00')) ))) order by 	coalesce(cd_material,0),
			coalesce(cd_classe_material,0),
			coalesce(cd_subgrupo_material,0),
			coalesce(cd_grupo_material,0),
			coalesce(nr_seq_familia,0),
			coalesce(cd_setor_atendimento,0),
			a.ie_lib_farmacia desc;	

c04 CURSOR FOR
       SELECT	a.nr_sequencia,
		a.ie_lib_farmacia,
		a.ie_lib_enfermagem
       FROM regra_impr_prescr_setor b
LEFT OUTER JOIN regra_impr_prescricao a ON (b.nr_seq_regra = a.nr_sequencia)
WHERE a.cd_estabelecimento		= cd_estabelecimento_w and a.ie_situacao			= 'A'  and coalesce(b.cd_setor_atendimento, cd_setor_atendimento_w)	= cd_setor_atendimento_w and coalesce(b.ie_adep, ie_adep_w)				= ie_adep_w and ((coalesce(ie_considera_quimio,'S') = 'S') or (coalesce(nr_seq_atend_w::text, '') = '')) and ((coalesce(ie_feriado,'S') = 'S') or (ie_feriado_w = 'N')) and ((coalesce(b.ie_dia_semana::text, '') = '') or
		 (b.ie_dia_semana = ie_dia_semana_w or ((b.ie_dia_semana = 9) and (pkg_date_utils.IS_BUSINESS_DAY(dt_liberacao_w) = 1))))  -- ie_dia_semana_w not in (7,1)
  and coalesce(b.ie_considera_npt,'N') = 'S' and (((coalesce(b.dt_hora_inicio::text, '') = '') or (coalesce(b.dt_hora_fim::text, '') = '')) or (PKG_DATE_UTILS.get_DateTime(clock_timestamp(), coalesce(CASE WHEN a.ie_lib_enfermagem='S' THEN dt_lib_enf_w  ELSE dt_liberacao_w END , PKG_DATE_UTILS.GET_TIME('00:00:00')) ) between 
		  PKG_DATE_UTILS.get_DateTime(clock_timestamp(), coalesce(b.dt_hora_inicio, PKG_DATE_UTILS.GET_TIME('00:00:00')) ) and 
		  PKG_DATE_UTILS.get_DateTime(clock_timestamp(), coalesce(b.dt_hora_fim, PKG_DATE_UTILS.GET_TIME('00:00:00')) )));
		
procedure imprimir(	ds_texto_p	text) is
			;
BEGIN
			RAISE NOTICE '%', ds_texto_p;
			end;
		
BEGIN

begin

ie_rastre_prescr_libfarm_w := obter_se_info_rastre_prescr('LF', wheb_usuario_pck.get_nm_usuario, obter_perfil_ativo, wheb_usuario_pck.get_cd_estabelecimento);

--imprimir('In?cio');
select	cd_setor_atendimento,
	coalesce(dt_liberacao_medico,dt_liberacao),
	coalesce(cd_estabelecimento,1),
	cd_medico,
	cd_prescritor,
	ie_motivo_prescricao,
	dt_liberacao,
	nr_seq_atend,
	coalesce(ie_adep,'N')
into STRICT	cd_setor_atendimento_w,
	dt_liberacao_w,
	cd_estabelecimento_w,
	cd_medico_w,
	cd_prescritor_w,
	ie_motivo_prescricao_w,
	dt_lib_enf_w,
	nr_seq_atend_w,
	ie_adep_w
from	prescr_medica
where	nr_prescricao		= nr_prescricao_p;


select	count(*)
into STRICT	qt_reg_w
from	regra_impr_prescricao
where	cd_estabelecimento	= cd_estabelecimento_w;

select	max(cd_pessoa_fisica)
into STRICT	cd_pessoa_usuario_w
from	usuario
where	nm_usuario	= nm_usuario_p;

if (ie_rastre_prescr_libfarm_w = 'S') then
	ds_rastre_prescr_libfarm_w := substr(ds_rastre_prescr_libfarm_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
		|| ' nr_prescricao_p:'			|| nr_prescricao_p
		|| '|ie_regra_lib_p:'			|| ie_regra_lib_p
		|| '|nm_usuario_p:'				|| nm_usuario_p
		|| '|cd_estabelecimento_w:'		|| cd_estabelecimento_w
		|| '|cd_medico_w:'				|| cd_medico_w
		|| '|cd_pessoa_usuario_w:'		|| cd_pessoa_usuario_w
		|| '|cd_prescritor_w:'			|| cd_prescritor_w
		|| '|cd_setor_atendimento_w:'	|| cd_setor_atendimento_w
		|| '|dt_lib_enf_w:'				|| to_char(dt_lib_enf_w, 'dd/mm/yyyy hh24:mi:ss')
		|| '|dt_liberacao_w:'			|| to_char(dt_liberacao_w, 'dd/mm/yyyy hh24:mi:ss')
		|| '|ie_adep_w:'				|| ie_adep_w
		|| '|ie_motivo_prescricao_w:'	|| ie_motivo_prescricao_w
		|| '|nr_seq_atend_w:'			|| nr_seq_atend_w
		|| '|qt_reg_w:'					|| qt_reg_w, 1, 4000);
end if;

if (qt_reg_w > 0) then

	select	pkg_date_utils.get_WeekDay(dt_liberacao_w)
	into STRICT	ie_dia_semana_w
	;
	
	select	CASE WHEN obter_se_feriado(cd_estabelecimento_w, dt_liberacao_w)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_feriado_w
	;	
	
	if (ie_rastre_prescr_libfarm_w = 'S') then
		ds_rastre_prescr_libfarm_w := substr(ds_rastre_prescr_libfarm_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
			|| ' c01 nr_prescricao_p:' || nr_prescricao_p
			|| '|cd_estabelecimento_w:' || cd_estabelecimento_w
			|| '|dt_liberacao_w:' || to_char(dt_liberacao_w, 'dd/mm/yyyy hh24:mi:ss')
			|| '|ie_dia_semana_w:' || ie_dia_semana_w
			|| '|ie_feriado_w:' || ie_feriado_w, 1, 4000);
	end if;
		
	--imprimir('Antes C01');
	open	c01;
	loop
	fetch	c01 into
		nr_sequencia_w,
		cd_material_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		
		nr_seq_material_w := nr_sequencia_w;
		
		select	cd_grupo_material,
			cd_subgrupo_material,
			cd_classe_material,
			nr_seq_familia
		into STRICT	cd_grupo_material_w,
			cd_subgrupo_w,
			cd_classe_material_w,
			nr_seq_familia_w
		from	estrutura_material_v
		where 	cd_material	= cd_material_w;

		nr_seq_regra_w		:= null;
		ie_lib_farmacia_w	:= null;
		--imprimir('Antes C02');
		
		if (ie_rastre_prescr_libfarm_w = 'S') then
			ds_rastre_prescr_lf_item_w := substr(ds_rastre_prescr_lf_item_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
				|| ' c02 nr_seq_regra_w:' || nr_seq_regra_w
				|| '|ie_lib_farmacia_w:' || ie_lib_farmacia_w
				|| '|cd_classe_material_w:' || cd_classe_material_w
				|| '|cd_estabelecimento_w:' || cd_estabelecimento_w
				|| '|cd_grupo_material_w:' || cd_grupo_material_w
				|| '|cd_material_w:' || cd_material_w
				|| '|cd_setor_atendimento_w:' || cd_setor_atendimento_w
				|| '|cd_subgrupo_w:' || cd_subgrupo_w
				|| '|dt_lib_enf_w:' || to_char(dt_lib_enf_w, 'dd/mm/yyyy hh24:mi:ss')
				|| '|dt_liberacao_w:' || to_char(dt_liberacao_w, 'dd/mm/yyyy hh24:mi:ss')
				|| '|ie_adep_w:' || ie_adep_w
				|| '|ie_dia_semana_w:' || ie_dia_semana_w
				|| '|ie_feriado_w:' || ie_feriado_w
				|| '|nr_seq_atend_w:' || nr_seq_atend_w
				|| '|nr_seq_familia_w:' || nr_seq_familia_w, 1, 4000);
		end if;
		
		OPEN C02;
		LOOP
		FETCH C02 into
			nr_seq_regra_w,
			ie_lib_farmacia_w,
			ie_lib_enfermagem_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			if (ie_rastre_prescr_libfarm_w = 'S') then
				ds_rastre_prescr_lf_item_w := substr(ds_rastre_prescr_lf_item_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
					|| ' nr_seq_regra_w:' || nr_seq_regra_w
					|| '|ie_lib_farmacia_w:' || ie_lib_farmacia_w
					|| '|ie_lib_enfermagem_w:' || ie_lib_enfermagem_w, 1, 4000);
			end if;
		END LOOP;
		Close C02;
		
		
		if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '')then
			select	count(*)
			into STRICT	qt_existe_w
			from	prescr_medica_impr
			where	nr_prescricao	= nr_prescricao_p
			and	nr_seq_regra	= nr_seq_regra_w;
			
			if (ie_lib_enfermagem_w = 'S') then
				dt_liberacao_w	:= dt_lib_enf_w;
				
				select	pkg_date_utils.get_WeekDay(dt_liberacao_w)
				into STRICT	ie_dia_semana_w
				;
				
				select	CASE WHEN obter_se_feriado(cd_estabelecimento_w, dt_liberacao_w)=0 THEN 'N'  ELSE 'S' END
				into STRICT	ie_feriado_w
				;	
			end if;
			
			
			if (ie_rastre_prescr_libfarm_w = 'S') then
				ds_rastre_prescr_lf_item_w := substr(ds_rastre_prescr_lf_item_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
					|| ' nr_prescricao_p:'		|| nr_prescricao_p
					|| '|cd_estabelecimento_w:'	|| cd_estabelecimento_w
					|| '|dt_lib_enf_w:'			|| to_char(dt_lib_enf_w, 'dd/mm/yyyy hh24:mi:ss')
					|| '|dt_liberacao_w:'		|| to_char(dt_liberacao_w, 'dd/mm/yyyy hh24:mi:ss')
					|| '|ie_dia_semana_w:'		|| ie_dia_semana_w
					|| '|ie_feriado_w:'			|| ie_feriado_w
					|| '|ie_lib_enfermagem_w:'	|| ie_lib_enfermagem_w
					|| '|nr_seq_regra_w:'		|| nr_seq_regra_w
					|| '|qt_existe_w:'			|| qt_existe_w, 1, 4000);
			end if;

			if (qt_existe_w = 0) then
				begin
				Select	count(*)
				into STRICT	qt_existe_w
				from	regra_impr_prescr_setor b
				where	b.nr_seq_regra						= nr_seq_regra_w
				and	coalesce(b.cd_setor_atendimento, cd_setor_atendimento_w)	= cd_setor_atendimento_w
				and	coalesce(b.cd_grupo_material, cd_grupo_material_w)		= cd_grupo_material_w
				and	coalesce(b.cd_subgrupo_material, cd_subgrupo_w)		= cd_subgrupo_w
				and	coalesce(b.cd_classe_material, cd_classe_material_w)		= cd_classe_material_w
				and	coalesce(b.cd_material, cd_material_w)			= cd_material_w
				and	((coalesce(ie_considera_quimio,'S') = 'S') or (coalesce(nr_seq_atend_w::text, '') = ''))
				and	((coalesce(ie_feriado,'S') = 'S') or (ie_feriado_w = 'N'))
				and	((coalesce(b.nr_seq_familia, nr_seq_familia_w)		= nr_seq_familia_w) or (coalesce(b.nr_seq_familia::text, '') = ''))
				and	((coalesce(b.ie_dia_semana::text, '') = '') or
					 (b.ie_dia_semana = ie_dia_semana_w or ((b.ie_dia_semana = 9) and (pkg_date_utils.IS_BUSINESS_DAY(dt_liberacao_w) = 1)))) -- ie_dia_semana_w not in (7,1)
				and	(((coalesce(b.dt_hora_inicio::text, '') = '') or (coalesce(b.dt_hora_fim::text, '') = '')) or (PKG_DATE_UTILS.get_DateTime(clock_timestamp(), coalesce(dt_liberacao_w, PKG_DATE_UTILS.GET_TIME('00:00:00'))) between 
					  PKG_DATE_UTILS.get_DateTime(clock_timestamp(), coalesce(b.dt_hora_inicio, PKG_DATE_UTILS.GET_TIME('00:00:00'))) and 
					  PKG_DATE_UTILS.get_DateTime(clock_timestamp(), coalesce(b.dt_hora_fim, PKG_DATE_UTILS.GET_TIME('00:00:00')))));
					
				if (ie_rastre_prescr_libfarm_w = 'S') then
					ds_rastre_prescr_lf_item_w := substr(ds_rastre_prescr_lf_item_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
						|| ' cd_classe_material_w:' || cd_classe_material_w
						|| '|cd_grupo_material_w:' || cd_grupo_material_w
						|| '|cd_material_w:' || cd_material_w
						|| '|cd_setor_atendimento_w:' || cd_setor_atendimento_w
						|| '|cd_subgrupo_w:' || cd_subgrupo_w
						|| '|dt_liberacao_w:' || to_char(dt_liberacao_w, 'dd/mm/yyyy hh24:mi:ss')
						|| '|ie_dia_semana_w:' || ie_dia_semana_w
						|| '|ie_feriado_w:' || ie_feriado_w
						|| '|nr_seq_atend_w:' || nr_seq_atend_w
						|| '|nr_seq_familia_w:' || nr_seq_familia_w
						|| '|nr_seq_regra_w:' || nr_seq_regra_w
						|| '|qt_existe_w:' || qt_existe_w, 1, 4000);
				end if;

			/*	imprimir('qt_existe_w = '||qt_existe_w);
				imprimir('nr_seq_regra_w = '||nr_seq_regra_w);
				imprimir('ie_lib_farmacia_w = '||ie_lib_farmacia_w);*/
				if (qt_existe_w > 0) and (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') and (ie_lib_farmacia_w IS NOT NULL AND ie_lib_farmacia_w::text <> '') then
					begin
				--	imprimir('Entrou qt_existe');
					
					if (ie_regra_lib_p = 'T') and (ie_lib_farmacia_w = 'S') then	

						if (ie_rastre_prescr_libfarm_w = 'S') then
							ds_rastre_prescr_lf_item_w := substr(ds_rastre_prescr_lf_item_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
								|| ' ie_lib_farm:S', 1, 4000);
						end if;
						
						update	prescr_medica
						set	ie_lib_farm	= 'S'
						where	nr_prescricao	= nr_prescricao_p;	
						--imprimir(' entrou 1');						
					elsif (ie_regra_lib_p = 'T') and (ie_lib_farmacia_w = 'M') and (cd_medico_w <> cd_prescritor_w) then		

						if (ie_rastre_prescr_libfarm_w = 'S') then
							ds_rastre_prescr_lf_item_w := substr(ds_rastre_prescr_lf_item_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
								|| ' ie_lib_farm:S', 1, 4000);
						end if;
						
						update	prescr_medica
						set	ie_lib_farm	= 'S'
						where	nr_prescricao	= nr_prescricao_p;
					elsif (ie_regra_lib_p = 'D') and (cd_pessoa_usuario_w = cd_prescritor_w) then

						if (ie_rastre_prescr_libfarm_w = 'S') then
							ds_rastre_prescr_lf_item_w := substr(ds_rastre_prescr_lf_item_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
								|| ' ie_lib_farm:N', 1, 4000);
						end if;
						
						update	prescr_medica
						set	ie_lib_farm	= 'N'
						where	nr_prescricao	= nr_prescricao_p;
						--imprimir(' entrou 2');						
					elsif (ie_regra_lib_p = 'T') and (ie_lib_farmacia_w = 'M') and (cd_medico_w = cd_prescritor_w) then

						if (ie_rastre_prescr_libfarm_w = 'S') then
							ds_rastre_prescr_lf_item_w := substr(ds_rastre_prescr_lf_item_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
								|| ' ie_lib_farm:', 1, 4000);
						end if;
						
						update	prescr_medica
						set	ie_lib_farm	 = NULL
						where	nr_prescricao	= nr_prescricao_p
						and	coalesce(ie_lib_farm,'N')	<> 'S';
						--imprimir(' entrou 3');
					elsif (ie_regra_lib_p = 'T') and (ie_lib_farmacia_w = 'N') then

						if (ie_rastre_prescr_libfarm_w = 'S') then
							ds_rastre_prescr_lf_item_w := substr(ds_rastre_prescr_lf_item_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
								|| ' ie_lib_farm:N', 1, 4000);
						end if;
						
						update	prescr_medica
						set	ie_lib_farm	= 'N'
						where	nr_prescricao	= nr_prescricao_p
						and	coalesce(ie_lib_farm,'N')	<> 'S';
						--imprimir(' entrou 4');
					end if;
					
					select	nextval('prescr_medica_impr_seq')
					into STRICT	nr_sequencia_w
					;
					
					insert into prescr_medica_impr(
						nr_sequencia, nr_prescricao, dt_atualizacao,
						nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
						nr_seq_regra)
					values (
						nr_sequencia_w, nr_prescricao_p, clock_timestamp(),
						nm_usuario_p, clock_timestamp(), nm_usuario_p,
						nr_seq_regra_w);
					end;
					
					if (ie_rastre_prescr_libfarm_w = 'S') then
						ds_rastre_prescr_lf_item_w := substr(ds_rastre_prescr_lf_item_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
							|| ' nr_prescricao_p:'		|| nr_prescricao_p
							|| '|ie_regra_lib_p:'		|| ie_regra_lib_p
							|| '|nm_usuario_p:'			|| nm_usuario_p
							|| '|cd_medico_w:'			|| cd_medico_w
							|| '|cd_pessoa_usuario_w:'	|| cd_pessoa_usuario_w
							|| '|cd_prescritor_w:'		|| cd_prescritor_w
							|| '|ie_lib_farmacia_w:'	|| ie_lib_farmacia_w
							|| '|nr_seq_regra_w:'		|| nr_seq_regra_w
							|| '|nr_sequencia_w:'		|| nr_sequencia_w
							|| '|qt_existe_w:'			|| qt_existe_w, 1, 4000);
					end if;
				end if;
				end;
			end if;		
		
		end if;
		
		if (ds_rastre_prescr_lf_item_w IS NOT NULL AND ds_rastre_prescr_lf_item_w::text <> '') then
			CALL gerar_log_prescricao(
				nr_prescricao_p		=> nr_prescricao_p,
				nr_seq_item_p		=> nr_seq_material_w,
				ie_agrupador_p		=> null,
				nr_seq_horario_p	=> null,
				ie_tipo_item_p		=> 'M',
				ds_log_p			=> ds_rastre_prescr_lf_item_w,
				nm_usuario_p		=> wheb_usuario_pck.get_nm_usuario,
				nr_seq_objeto_p		=> 6348,
				ie_commit_p			=> 'N');
				
			ds_rastre_prescr_lf_item_w := null;
		end if;
		
		end;
	END LOOP;
	Close C01;

	if (ie_rastre_prescr_libfarm_w = 'S') then
		ds_rastre_prescr_libfarm_w := substr(ds_rastre_prescr_libfarm_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
			|| ' c03 nr_prescricao_p:' || nr_prescricao_p, 1, 4000);
	end if;	
	
	open c03;
	loop
	fetch c03 into
		nr_sequencia_w,
		cd_dieta_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		begin
		
		nr_seq_dieta_w := nr_sequencia_w;

		nr_seq_regra_w		:= null;
		ie_lib_farmacia_w	:= null;
		
		if (ie_rastre_prescr_libfarm_w = 'S') then
			ds_rastre_prescr_lf_item_w := substr(ds_rastre_prescr_lf_item_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
				|| ' c02 nr_seq_regra_w:' || nr_seq_regra_w
				|| '|ie_lib_farmacia_w:' || ie_lib_farmacia_w
				|| '|cd_classe_material_w:' || cd_classe_material_w
				|| '|cd_estabelecimento_w:' || cd_estabelecimento_w
				|| '|cd_grupo_material_w:' || cd_grupo_material_w
				|| '|cd_material_w:' || cd_material_w
				|| '|cd_setor_atendimento_w:' || cd_setor_atendimento_w
				|| '|cd_subgrupo_w:' || cd_subgrupo_w
				|| '|dt_lib_enf_w:' || to_char(dt_lib_enf_w, 'dd/mm/yyyy hh24:mi:ss')
				|| '|dt_liberacao_w:' || to_char(dt_liberacao_w, 'dd/mm/yyyy hh24:mi:ss')
				|| '|ie_adep_w:' || ie_adep_w
				|| '|ie_dia_semana_w:' || ie_dia_semana_w
				|| '|ie_feriado_w:' || ie_feriado_w
				|| '|nr_seq_atend_w:' || nr_seq_atend_w
				|| '|nr_seq_familia_w:' || nr_seq_familia_w, 1, 4000);
		end if;

		OPEN C02;
		LOOP
		FETCH C02 into
			nr_seq_regra_w,
			ie_lib_farmacia_w,
			ie_lib_enfermagem_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			select	count(*)
			into STRICT	qt_existe_w
			from	prescr_medica_impr
			where	nr_prescricao	= nr_prescricao_p
			and	nr_seq_regra	= nr_seq_regra_w;
			
			if (ie_lib_enfermagem_w = 'S') then
				dt_liberacao_w	:= dt_lib_enf_w;
				
				select	pkg_date_utils.get_WeekDay(dt_liberacao_w)
				into STRICT	ie_dia_semana_w
				;
				
				select	CASE WHEN obter_se_feriado(cd_estabelecimento_w, dt_liberacao_w)=0 THEN 'N'  ELSE 'S' END
				into STRICT	ie_feriado_w
				;	
			end if;
	
			if (qt_existe_w = 0) then
				begin
				Select	count(*)
				into STRICT	qt_existe_w
				from	regra_impr_prescr_setor b
				where	b.nr_seq_regra						= nr_seq_regra_w
				and	coalesce(b.cd_setor_atendimento, cd_setor_atendimento_w)	= cd_setor_atendimento_w
				and	coalesce(b.cd_grupo_material::text, '') = ''
				and	coalesce(b.cd_subgrupo_material::text, '') = ''
				and	coalesce(b.cd_classe_material::text, '') = ''
				and	coalesce(b.cd_material::text, '') = ''
				and	((coalesce(ie_considera_quimio,'S') = 'S') or (coalesce(nr_seq_atend_w::text, '') = ''))
				and	b.cd_dieta	= cd_dieta_w
				and	coalesce(b.nr_seq_familia::text, '') = ''
				and	((coalesce(b.ie_dia_semana::text, '') = '') or
					 (b.ie_dia_semana = ie_dia_semana_w or ((b.ie_dia_semana = 9) and (pkg_date_utils.IS_BUSINESS_DAY(dt_liberacao_w) = 1)))) -- ie_dia_semana_w not in (7,1)
				and	(((coalesce(b.dt_hora_inicio::text, '') = '') or (coalesce(b.dt_hora_fim::text, '') = '')) or (PKG_DATE_UTILS.get_DateTime(clock_timestamp(), coalesce(dt_liberacao_w, PKG_DATE_UTILS.GET_TIME('00:00:00')) ) between 
					  PKG_DATE_UTILS.get_DateTime(clock_timestamp(), coalesce(b.dt_hora_inicio, PKG_DATE_UTILS.GET_TIME('00:00:00')) ) and 
					  PKG_DATE_UTILS.get_DateTime(clock_timestamp(), coalesce(b.dt_hora_fim, PKG_DATE_UTILS.GET_TIME('00:00:00')) )
					));

					if (qt_existe_w > 0) and (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') and (ie_lib_farmacia_w IS NOT NULL AND ie_lib_farmacia_w::text <> '') then
					begin
					if (ie_regra_lib_p = 'T') and (ie_lib_farmacia_w = 'S') then		

						if (ie_rastre_prescr_libfarm_w = 'S') then
							ds_rastre_prescr_lf_item_w := substr(ds_rastre_prescr_lf_item_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
								|| ' ie_lib_farm:S', 1, 4000);
						end if;	
						
						update	prescr_medica
						set	ie_lib_farm	= 'S'
						where	nr_prescricao	= nr_prescricao_p;						
					elsif (ie_regra_lib_p = 'T') and (ie_lib_farmacia_w = 'M') and (cd_medico_w <> cd_prescritor_w) then		

						if (ie_rastre_prescr_libfarm_w = 'S') then
							ds_rastre_prescr_lf_item_w := substr(ds_rastre_prescr_lf_item_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
								|| ' ie_lib_farm:S', 1, 4000);
						end if;	
						
						update	prescr_medica
						set	ie_lib_farm	= 'S'
						where	nr_prescricao	= nr_prescricao_p;
					elsif (ie_regra_lib_p = 'D') and (cd_pessoa_usuario_w = cd_prescritor_w) then

						if (ie_rastre_prescr_libfarm_w = 'S') then
							ds_rastre_prescr_lf_item_w := substr(ds_rastre_prescr_lf_item_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
								|| ' ie_lib_farm:N', 1, 4000);
						end if;	
						
						update	prescr_medica
						set	ie_lib_farm	= 'N'
						where	nr_prescricao	= nr_prescricao_p;

					elsif (ie_regra_lib_p = 'T') and (ie_lib_farmacia_w = 'M') and (cd_medico_w = cd_prescritor_w) then

						if (ie_rastre_prescr_libfarm_w = 'S') then
							ds_rastre_prescr_lf_item_w := substr(ds_rastre_prescr_lf_item_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
								|| ' ie_lib_farm:', 1, 4000);
						end if;	
						
						update	prescr_medica
						set	ie_lib_farm	 = NULL
						where	nr_prescricao	= nr_prescricao_p
						and		coalesce(ie_lib_farm,'N') <> 'S';

					elsif (ie_regra_lib_p = 'T') and (ie_lib_farmacia_w = 'N') then

						if (ie_rastre_prescr_libfarm_w = 'S') then
							ds_rastre_prescr_lf_item_w := substr(ds_rastre_prescr_lf_item_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
								|| ' ie_lib_farm:N', 1, 4000);
						end if;	
						
						update	prescr_medica
						set	ie_lib_farm	= 'N'
						where	nr_prescricao	= nr_prescricao_p
						and		coalesce(ie_lib_farm,'N') <> 'S';

					end if;
					
					select	nextval('prescr_medica_impr_seq')
					into STRICT	nr_sequencia_w
					;
					
					insert into prescr_medica_impr(
						nr_sequencia, nr_prescricao, dt_atualizacao,
						nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
						nr_seq_regra)
					values (
						nr_sequencia_w, nr_prescricao_p, clock_timestamp(),
						nm_usuario_p, clock_timestamp(), nm_usuario_p,
						nr_seq_regra_w);
					end;
					
					if (ie_rastre_prescr_libfarm_w = 'S') then
						ds_rastre_prescr_lf_item_w := substr(ds_rastre_prescr_lf_item_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
							|| ' cd_medico_w:' || cd_medico_w
							|| '|cd_pessoa_usuario_w:' || cd_pessoa_usuario_w
							|| '|cd_prescritor_w:' || cd_prescritor_w
							|| '|ie_lib_farmacia_w:' || ie_lib_farmacia_w
							|| '|nr_seq_regra_w:' || nr_seq_regra_w
							|| '|nr_sequencia_w:' || nr_sequencia_w
							|| '|qt_existe_w:' || qt_existe_w, 1, 4000);
					end if;
				end if;
				end;
			end if;
		END LOOP;
		Close C02;
		
		if (ds_rastre_prescr_lf_item_w IS NOT NULL AND ds_rastre_prescr_lf_item_w::text <> '') then
			CALL gerar_log_prescricao(
				nr_prescricao_p		=> nr_prescricao_p,
				nr_seq_item_p		=> nr_seq_dieta_w,
				ie_agrupador_p		=> null,
				nr_seq_horario_p	=> null,
				ie_tipo_item_p		=> 'D',
				ds_log_p			=> ds_rastre_prescr_lf_item_w,
				nm_usuario_p		=> wheb_usuario_pck.get_nm_usuario,
				nr_seq_objeto_p		=> 6348,
				ie_commit_p			=> 'N');
				
			ds_rastre_prescr_lf_item_w := null;
		end if;
		
		end;
	END LOOP;
	Close C03;
	
select	sum(qt_npt)
into STRICT	qt_npt_w
from (
	SELECT	count(nr_sequencia) qt_npt
	from	nut_pac
	where	nr_prescricao = nr_prescricao_p
	
union all

	SELECT	count(nr_sequencia) qt_npt
	from	nut_paciente
	where	nr_prescricao = nr_prescricao_p) alias3;
	
if (ie_rastre_prescr_libfarm_w = 'S') then
	ds_rastre_prescr_libfarm_w := substr(ds_rastre_prescr_libfarm_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
		|| ' qt_npt_w:' || qt_npt_w, 1, 4000);
end if;

if (qt_npt_w > 0) then

	if (ie_rastre_prescr_libfarm_w = 'S') then
		ds_rastre_prescr_libfarm_w := substr(ds_rastre_prescr_libfarm_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
			|| ' c04 cd_estabelecimento_w:' || cd_estabelecimento_w
			|| '|cd_setor_atendimento_w:' || cd_setor_atendimento_w
			|| '|dt_lib_enf_w:' || to_char(dt_lib_enf_w, 'dd/mm/yyyy hh24:mi:ss')
			|| '|dt_liberacao_w:' || to_char(dt_liberacao_w, 'dd/mm/yyyy hh24:mi:ss')
			|| '|ie_adep_w:' || ie_adep_w
			|| '|ie_dia_semana_w:' || ie_dia_semana_w
			|| '|ie_feriado_w:' || ie_feriado_w
			|| '|nr_seq_atend_w:' || nr_seq_atend_w, 1, 4000);
	end if;

	open c04;
	loop
	fetch c04 into	
		nr_seq_regra_w,
		ie_lib_farmacia_w,
		ie_lib_enfermagem_w;
	EXIT WHEN NOT FOUND; /* apply on c04 */
		begin
		if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '')then
			select	count(*)
			into STRICT	qt_existe_w
			from	prescr_medica_impr
			where	nr_prescricao	= nr_prescricao_p
			and	nr_seq_regra	= nr_seq_regra_w;
			
			if (ie_lib_enfermagem_w = 'S') then
				dt_liberacao_w	:= dt_lib_enf_w;
				
				select	pkg_date_utils.get_WeekDay(dt_liberacao_w)
				into STRICT	ie_dia_semana_w
				;
				
				select	CASE WHEN obter_se_feriado(cd_estabelecimento_w, dt_liberacao_w)=0 THEN 'N'  ELSE 'S' END
				into STRICT	ie_feriado_w
				;	
			end if;

			if (qt_existe_w = 0) then
				begin
				Select	count(*)
				into STRICT	qt_existe_w
				from	regra_impr_prescr_setor b
				where	b.nr_seq_regra						= nr_seq_regra_w
				and	coalesce(b.cd_setor_atendimento, cd_setor_atendimento_w)	= cd_setor_atendimento_w
				and	((coalesce(b.ie_considera_quimio,'S') = 'S') or (coalesce(nr_seq_atend_w::text, '') = ''))
				and	coalesce(b.ie_considera_npt,'N') = 'S'	
				and	((coalesce(b.ie_dia_semana::text, '') = '') or
					 (b.ie_dia_semana = ie_dia_semana_w or ((b.ie_dia_semana = 9) and (pkg_date_utils.IS_BUSINESS_DAY(dt_liberacao_w) = 1)))) --  ie_dia_semana_w not in (7,1)
				and	(((coalesce(b.dt_hora_inicio::text, '') = '') or (coalesce(b.dt_hora_fim::text, '') = '')) or (PKG_DATE_UTILS.get_DateTime(clock_timestamp(), coalesce(dt_liberacao_w, PKG_DATE_UTILS.GET_TIME('00:00:00')) ) between 
					  PKG_DATE_UTILS.get_DateTime(clock_timestamp(), coalesce(b.dt_hora_inicio, PKG_DATE_UTILS.GET_TIME('00:00:00')) ) and 
					  PKG_DATE_UTILS.get_DateTime(clock_timestamp(), coalesce(b.dt_hora_fim, PKG_DATE_UTILS.GET_TIME('00:00:00')) )
					));

				if (qt_existe_w > 0) and (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') and (ie_lib_farmacia_w IS NOT NULL AND ie_lib_farmacia_w::text <> '') then
					begin
					if (ie_regra_lib_p = 'T') and (ie_lib_farmacia_w = 'S') then

						if (ie_rastre_prescr_libfarm_w = 'S') then
							ds_rastre_prescr_lf_item_w := substr(ds_rastre_prescr_lf_item_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
								|| ' ie_lib_farm:S', 1, 4000);
						end if;
						
						update	prescr_medica
						set	ie_lib_farm	= 'S'
						where	nr_prescricao	= nr_prescricao_p;						
					elsif (ie_regra_lib_p = 'T') and (ie_lib_farmacia_w = 'M') and (cd_medico_w <> cd_prescritor_w) then	

						if (ie_rastre_prescr_libfarm_w = 'S') then
							ds_rastre_prescr_lf_item_w := substr(ds_rastre_prescr_lf_item_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
								|| ' ie_lib_farm:S', 1, 4000);
						end if;	
						
						update	prescr_medica
						set	ie_lib_farm	= 'S'
						where	nr_prescricao	= nr_prescricao_p;
					elsif (ie_regra_lib_p = 'D') and (cd_pessoa_usuario_w = cd_prescritor_w) then

						if (ie_rastre_prescr_libfarm_w = 'S') then
							ds_rastre_prescr_lf_item_w := substr(ds_rastre_prescr_lf_item_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
								|| ' ie_lib_farm:N', 1, 4000);
						end if;
						
						update	prescr_medica
						set	ie_lib_farm	= 'N'
						where	nr_prescricao	= nr_prescricao_p;
					elsif (ie_regra_lib_p = 'T') and (ie_lib_farmacia_w = 'M') and (cd_medico_w = cd_prescritor_w) then

						if (ie_rastre_prescr_libfarm_w = 'S') then
							ds_rastre_prescr_lf_item_w := substr(ds_rastre_prescr_lf_item_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
								|| ' ie_lib_farm:', 1, 4000);
						end if;
						
						update	prescr_medica
						set	ie_lib_farm	 = NULL
						where	nr_prescricao	= nr_prescricao_p
						and	coalesce(ie_lib_farm,'N')	<> 'S';						
					elsif (ie_regra_lib_p = 'T') and (ie_lib_farmacia_w = 'N') then

						if (ie_rastre_prescr_libfarm_w = 'S') then
							ds_rastre_prescr_lf_item_w := substr(ds_rastre_prescr_lf_item_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
								|| ' ie_lib_farm:N', 1, 4000);
						end if;
						
						update	prescr_medica
						set	ie_lib_farm	= 'N'
						where	nr_prescricao	= nr_prescricao_p
						and	coalesce(ie_lib_farm,'N')	<> 'S';
					end if;
					
					select	nextval('prescr_medica_impr_seq')
					into STRICT	nr_sequencia_w
					;
					
					insert into prescr_medica_impr(
						nr_sequencia, nr_prescricao, dt_atualizacao,
						nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
						nr_seq_regra)
					values (
						nr_sequencia_w, nr_prescricao_p, clock_timestamp(),
						nm_usuario_p, clock_timestamp(), nm_usuario_p,
						nr_seq_regra_w);
					end;
				end if;
				end;
			end if;
		end if;	
		
		if (ds_rastre_prescr_lf_item_w IS NOT NULL AND ds_rastre_prescr_lf_item_w::text <> '') then
			CALL gerar_log_prescricao(
				nr_prescricao_p  => nr_prescricao_p,
				nr_seq_item_p    => null,
				ie_agrupador_p   => null,
				nr_seq_horario_p => null,
				ie_tipo_item_p   => null,
				ds_log_p         => ds_rastre_prescr_lf_item_w,
				nm_usuario_p     => wheb_usuario_pck.get_nm_usuario,
				nr_seq_objeto_p  => 6348,
				ie_commit_p      => 'N');
				
			ds_rastre_prescr_lf_item_w := null;
		end if;
		
		end;	
	end loop;
	close c04;	
end if;	
	
end if;

if (ie_motivo_prescricao_w IS NOT NULL AND ie_motivo_prescricao_w::text <> '') then
	select	max(ie_interv_farm),
		max(nr_sequencia)
	into STRICT	ie_interv_farm_w,
		nr_seq_regra_motivo_w
	from	regra_motivo_lib_prescr
	where	ie_motivo_prescricao	= ie_motivo_prescricao_w;
	
	if (ie_interv_farm_w IS NOT NULL AND ie_interv_farm_w::text <> '') then	
		if (ie_rastre_prescr_libfarm_w = 'S') then
			ds_rastre_prescr_libfarm_w := substr(ds_rastre_prescr_libfarm_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
				|| ' ie_motivo_prescricao_w:' || ie_motivo_prescricao_w
				|| '|ie_interv_farm_w:'       || ie_interv_farm_w, 1, 4000);
		end if;
	
		update	prescr_medica
		set	ie_lib_farm	= ie_interv_farm_w
		where	nr_prescricao	= nr_prescricao_p;
		
		/*OS 251702 */

		update	prescr_material a
		set	ie_regra_disp	= 'N'
		where	nr_prescricao	= nr_prescricao_p
		and	exists (SELECT	1
				from	regra_motivo_lib_item x
				where	nr_seq_regra	= nr_seq_regra_motivo_w
				and	((coalesce(x.cd_material::text, '') = '') or (x.cd_material = a.cd_material))
				and	((coalesce(x.cd_classe_material::text, '') = '') or (x.cd_classe_material = Obter_estrutura_material(a.cd_material,'C')))
				and	((coalesce(x.cd_subgrupo_material::text, '') = '') or (x.cd_subgrupo_material = Obter_estrutura_material(a.cd_material,'S')))
				and	((coalesce(x.cd_grupo_material::text, '') = '') or (x.cd_grupo_material = Obter_estrutura_material(a.cd_material,'G')))
				and	((coalesce(x.cd_unidade_medida::text, '') = '') or (x.cd_unidade_medida = a.cd_unidade_medida))
				and	((coalesce(x.cd_intervalo::text, '') = '') or (x.cd_intervalo = a.cd_intervalo)));
	end if;
end if;

exception
	when others then
	ds_erro_w	:= SQLERRM(SQLSTATE);
	
	if (ie_rastre_prescr_libfarm_w = 'S') then
		ds_rastre_prescr_libfarm_w := substr(ds_rastre_prescr_libfarm_w || pls_util_pck.enter_w || $$plsql_unit || ':' || $$plsql_line
			|| ds_erro_w || pls_util_pck.enter_w
			|| dbms_utility.format_error_backtrace, 1, 4000);
	end if;
end;

if (ds_rastre_prescr_libfarm_w IS NOT NULL AND ds_rastre_prescr_libfarm_w::text <> '') then
	CALL gerar_log_prescricao(
		nr_prescricao_p  => nr_prescricao_p,
		nr_seq_item_p    => null,
		ie_agrupador_p   => null,
		nr_seq_horario_p => null,
		ie_tipo_item_p   => null,
		ds_log_p         => ds_rastre_prescr_libfarm_w,
		nm_usuario_p     => wheb_usuario_pck.get_nm_usuario,
		nr_seq_objeto_p  => 6348,
		ie_commit_p      => 'N');
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_impr_adic_prescricao ( nr_prescricao_p bigint, ie_regra_lib_p text, nm_usuario_p text) FROM PUBLIC;

