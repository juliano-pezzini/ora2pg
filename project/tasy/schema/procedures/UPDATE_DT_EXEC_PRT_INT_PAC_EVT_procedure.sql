-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE update_dt_exec_prt_int_pac_evt (nr_seq_pend_pac_acao_p gqa_pend_pac_acao.nr_sequencia%type, dt_atualizacao_p protocolo_int_pac_evento.dt_real%type) AS $body$
DECLARE


nr_seq_protocolo_w bigint;
nr_dia_protocolo_w bigint;
dt_inicial_prev_protoc_w timestamp;
nr_dia_real_w protocolo_int_pac_evento.nr_dia_real%TYPE;
nr_dias_atraso_w protocolo_int_pac_evento.nr_dias_atraso%TYPE;

c01 CURSOR FOR
SELECT c.nr_sequencia nr_seq_evento
from gqa_pend_pac_acao a,
gqa_pendencia_pac b,
protocolo_int_pac_evento c
where a.nr_seq_pend_pac = b.nr_sequencia
and c.nr_sequencia = b.nr_seq_protocolo_int_pac_even
and a.nr_sequencia = nr_seq_pend_pac_acao_p
and coalesce(c.dt_real::text, '') = '';

BEGIN

  for c01_w in c01 loop
  begin

    if (c01_w.nr_seq_evento > 0) then

      SELECT
      et.nr_seq_protocolo_int_pac,
      pr.dt_inicial_previsto,
      ev.nr_dia_protocolo
      INTO STRICT
      nr_seq_protocolo_w,
      dt_inicial_prev_protoc_w,
      nr_dia_protocolo_w
      FROM 
      protocolo_int_pac_evento ev,
      protocolo_int_pac_etapa et,
      protocolo_int_paciente pr
      WHERE
      ev.nr_seq_prt_int_pac_etapa = et.nr_sequencia
      AND pr.nr_sequencia = et.nr_seq_protocolo_int_pac
      AND ev.nr_sequencia = c01_w.nr_seq_evento;

      nr_dia_real_w := trunc(dt_atualizacao_p,'dd') - trunc(dt_inicial_prev_protoc_w,'dd') + 1;
      nr_dias_atraso_w := nr_dia_real_w - nr_dia_protocolo_w;

      update	protocolo_int_pac_evento
      set		dt_real = dt_atualizacao_p,
            nr_dia_real = nr_dia_real_w,
            nr_dias_atraso = nr_dias_atraso_w
      where	nr_sequencia = c01_w.nr_seq_evento;

    end if;

  end;
  end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE update_dt_exec_prt_int_pac_evt (nr_seq_pend_pac_acao_p gqa_pend_pac_acao.nr_sequencia%type, dt_atualizacao_p protocolo_int_pac_evento.dt_real%type) FROM PUBLIC;

