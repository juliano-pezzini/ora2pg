-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE nicu_create_or_update_position (nr_seq_positioning_p INOUT nicu_positioning.nr_sequencia%type, nr_seq_atendimento_p nicu_positioning.nr_seq_encounter%type, nm_usuario_p text, mensagem_erro_p INOUT text) AS $body$
DECLARE


  exeption_w           exception;

BEGIN
  if (coalesce(nr_seq_positioning_p::text, '') = '') then
    select nextval('nicu_positioning_seq')
      into STRICT nr_seq_positioning_p
;
  else
    begin
      delete FROM nicu_positioning_score
       where nr_seq_positioning = nr_seq_positioning_p;
    exception
      when others then
        mensagem_erro_p := wheb_mensagem_pck.get_texto(1181973)||' Error: '||sqlerrm;
        raise exeption_w;
    end;
  end if;

  begin
    insert into nicu_positioning(nr_sequencia,
        nr_seq_encounter,
        dt_atualizacao,
        nm_usuario)
    values (nr_seq_positioning_p,
        nr_seq_atendimento_p,
        clock_timestamp(),
        nm_usuario_p);
  exception
    when unique_violation then
      begin
        update nicu_positioning
           set nm_usuario = nm_usuario_p,
               nm_usuario_nrec = nm_usuario_p,
               dt_atualizacao_nrec = clock_timestamp()
         where nr_sequencia = nr_seq_positioning_p;
      exception
        when others then
           mensagem_erro_p := expressao_pck.obter_desc_expressao(776218)||' Error: '||sqlerrm;
           raise exeption_w;
      end;
  when others then
    mensagem_erro_p := expressao_pck.obter_desc_expressao(776218)||' Error: '||sqlerrm;
    raise exeption_w;
  end;

  commit;
exception
  when exeption_w then
    rollback;
  when others then
    mensagem_erro_p := expressao_pck.obter_desc_expressao(776218)||' Error: '||sqlerrm;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nicu_create_or_update_position (nr_seq_positioning_p INOUT nicu_positioning.nr_sequencia%type, nr_seq_atendimento_p nicu_positioning.nr_seq_encounter%type, nm_usuario_p text, mensagem_erro_p INOUT text) FROM PUBLIC;

