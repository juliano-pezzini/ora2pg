-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE conciliar_integracao_retorno (nr_seq_item_p bigint, ie_opcao_p text) AS $body$
DECLARE


nr_sequencia_dem_w numeric(20);
ie_status_w varchar(1) := 'P';


BEGIN

    if (ie_opcao_p = 'V') then  --Se clicado na opcao "Validar", ira buscar o item caso ele esteja com o status Pendente.
        ie_status_w := 'P';
    else if (ie_opcao_p = 'C') then --Se clicado na opcao "Conciliar", ira buscar o item caso ele esteja com o status Validado.
        ie_status_w := 'V';
        end if;
    end if;

	if (nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '') and (nr_seq_item_p > 0) then

		select 	max(d.nr_sequencia)
		into STRICT	nr_sequencia_dem_w
		from	imp_dem_retorno_prot a,
			imp_dem_retorno_guia b,
			imp_dem_ret_item c,
			imp_dem_retorno d
		where	c.nr_sequencia 			= nr_seq_item_p
		and	c.nr_seq_dem_ret_guia 		= b.nr_sequencia
		and b.nr_seq_dem_ret_prot		= a.nr_sequencia
		and	a.nr_seq_imp_dem_retorno 	= d.nr_sequencia
		and	coalesce(a.ie_status, 'P') 		= ie_status_w;

		if (coalesce(nr_sequencia_dem_w,0) > 0) then
			CALL conciliar_integracao_ret_pck.executar(nr_sequencia_dem_w, ie_opcao_p);			
		end if;

	end if;	

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE conciliar_integracao_retorno (nr_seq_item_p bigint, ie_opcao_p text) FROM PUBLIC;

