-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_horario_lote_pend ( ds_lista_horarios_p text, nr_seq_horario_p INOUT bigint) AS $body$
DECLARE


nr_seq_horario_w	bigint;
nr_seq_hor_w		bigint;
nr_seq_hor_valido_w	bigint;
i			integer;
ds_lista_horarios_w	varchar(3000);
ds_caracter_espaco_w	varchar(1) := ',';


BEGIN

ds_lista_horarios_w := ds_lista_horarios_p;

while	(ds_lista_horarios_w IS NOT NULL AND ds_lista_horarios_w::text <> '') loop

	select	position(ds_caracter_espaco_w in ds_lista_horarios_w)
	into STRICT	i
	;

	if (i > 1) and ((substr(ds_lista_horarios_w, 1, i -1) IS NOT NULL AND (substr(ds_lista_horarios_w, 1, i -1))::text <> '')) then
		nr_seq_hor_w	:= substr(ds_lista_horarios_w, 1, i-1);
		nr_seq_hor_w	:= replace(nr_seq_hor_w, ds_caracter_espaco_w,'');
		ds_lista_horarios_w	:= substr(ds_lista_horarios_w, i + 1, 3000);
	end if;

	if (coalesce(nr_seq_hor_valido_w,0) = 0) then
		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_hor_valido_w
		from	prescr_mat_hor
		where	nr_sequencia = nr_seq_hor_w
		and	(nr_seq_lote IS NOT NULL AND nr_seq_lote::text <> '');
	end if;

	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_seq_horario_w
	from	prescr_mat_hor
	where	nr_sequencia = nr_seq_hor_w
	and	coalesce(dt_fim_horario::text, '') = ''
	and	coalesce(dt_suspensao::text, '') = ''
	and	(nr_seq_lote IS NOT NULL AND nr_seq_lote::text <> '');

	exit when(nr_seq_horario_w > 0);
end loop;

nr_seq_horario_p := coalesce(coalesce(nr_seq_horario_w, nr_seq_hor_valido_w),0);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_horario_lote_pend ( ds_lista_horarios_p text, nr_seq_horario_p INOUT bigint) FROM PUBLIC;

