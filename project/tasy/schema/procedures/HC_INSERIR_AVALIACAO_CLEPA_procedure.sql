-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hc_inserir_avaliacao_clepa ( cd_profissional_p text, ds_lista_checklist_p text, nm_usuario_p text, nr_seq_paciente_p bigint, cd_mensagem_p INOUT bigint) AS $body$
DECLARE


lista_checklist_w		dbms_sql.varchar2_table;
ds_checklist_w			varchar(255);
nr_seq_checklist_w		bigint;
nr_seq_checklist_item_w		bigint;
nr_seq_atend_checklist_w	bigint;
nr_seq_avaliacao_w		bigint;
cd_pessoa_fisica_w		varchar(10);
nr_atendimento_origem_w bigint;

C01 CURSOR FOR
	SELECT	nr_seq_avaliacao,
		nr_sequencia
	from	checklist_processo_item
	where	nr_seq_checklist = nr_seq_checklist_w
	order by 1;

BEGIN
cd_mensagem_p	:= 253410; --'Checklist(s) gerados com sucesso no CLEPA!'
if (cd_profissional_p IS NOT NULL AND cd_profissional_p::text <> '') then
	begin
	if (ds_lista_checklist_p IS NOT NULL AND ds_lista_checklist_p::text <> '') and (coalesce(nr_seq_paciente_p,0) > 0) then
		begin
		select	max(cd_pessoa_fisica),
				max(nr_atendimento_origem)
		into STRICT	cd_pessoa_fisica_w,
				nr_atendimento_origem_w
		from	paciente_home_care
		where	nr_sequencia = nr_seq_paciente_p;

		ds_checklist_w		:= ds_lista_checklist_p;
		lista_checklist_w	:= obter_lista_string(ds_checklist_w, ',');


		for	i in lista_checklist_w.first..lista_checklist_w.last loop
			nr_seq_checklist_w	:= lista_checklist_w(i);

			select	nextval('atendimento_checklist_seq')
			into STRICT	nr_seq_atend_checklist_w
			;

			begin
			insert into  atendimento_checklist(
				nr_sequencia,
				nm_usuario,
				nm_usuario_nrec,
				nr_seq_checklist,
				dt_atualizacao,
				dt_atualizacao_nrec,
				cd_profissional,
				cd_pessoa_fisica,
				nr_seq_paciente_hc,
				nr_atendimento,
				dt_registro)
			values (
				nr_seq_atend_checklist_w,
				nm_usuario_p,
				nm_usuario_p,
				nr_seq_checklist_w,
				clock_timestamp(),
				clock_timestamp(),
				cd_profissional_p,
				cd_pessoa_fisica_w,
				nr_seq_paciente_p,
				nr_atendimento_origem_w,
				clock_timestamp());

			exception
			when others then
				cd_mensagem_p	:= 253444; --'Ocorreu um erro ao gerar o(s) checklist(s) atendimento no CLEPA!'
			end;

			open C01;
				loop
				fetch C01 into
					nr_seq_avaliacao_w,
					nr_seq_checklist_item_w;
				EXIT WHEN NOT FOUND; /* apply on C01 */
					begin


					insert into med_avaliacao_paciente(nr_sequencia,
						cd_pessoa_fisica,
						cd_medico,
						dt_avaliacao,
						dt_atualizacao,
						nm_usuario,
						nr_seq_atend_checklist,
						nr_seq_checklist_item,
						nr_seq_tipo_avaliacao,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						ie_atualiza_macro)
					values (
						nextval('med_avaliacao_paciente_seq'),
						cd_pessoa_fisica_w,
						cd_profissional_p,
						clock_timestamp(),
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_atend_checklist_w,
						nr_seq_checklist_item_w,
						nr_seq_avaliacao_w,
						clock_timestamp(),
						nm_usuario_p,
						'S');
					exception
					when others then
						cd_mensagem_p	:= 253446; --'Ocorreu um erro ao gerar o(s) checklist(s) no CLEPA!'
					end;
				end loop;
				close C01;
			end loop;
		end;
		end if;
	end;
	else
		cd_mensagem_p	:= 253447;
	end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hc_inserir_avaliacao_clepa ( cd_profissional_p text, ds_lista_checklist_p text, nm_usuario_p text, nr_seq_paciente_p bigint, cd_mensagem_p INOUT bigint) FROM PUBLIC;

