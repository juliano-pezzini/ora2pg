-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_kit_prescricao_manual ( nr_prescricao_p bigint, nr_sequencia_p bigint, nr_seq_kit_p bigint, qt_material_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
nr_sequencia_w			bigint;
nr_ocorrencia_w			bigint;
nr_agrupamento_w			double precision;
cd_material_w			integer;
qt_material_kit_w			double precision;
qt_material_w			double precision;
cd_unidade_medida_w		varchar(30);
cd_intervalo_w			varchar(7);
hr_prim_horario_w		varchar(5);
ie_permite_alterar_w		varchar(5);
ie_urgencia_w			varchar(1);
ie_suspenso_w			varchar(1)		:= 'N';
ie_se_necessario_w		varchar(1)		:= 'N';
ie_medicacao_paciente_w		varchar(1)		:= 'N';
nr_seq_proc_w			integer;
ie_agrupador_w			smallint;
ds_horarios_w			varchar(2000);
cd_setor_atendimento_w		integer;
ie_tipo_atendimento_w		smallint;
ie_recem_nato_w			varchar(1);
cd_convenio_w			atend_categoria_convenio.cd_convenio%type;
qt_idade_w			varchar(255);
cd_medico_w			prescr_medica.cd_medico%type;
cd_perfil_w			prescr_medica.cd_perfil_ativo%type;

C01 CURSOR FOR 
	SELECT	a.nr_agrupamento, 
		a.ie_urgencia, 
		c.cd_material, 
		substr(obter_dados_material_estab(c.cd_material,cd_estabelecimento_p,'UMS'),1,30) cd_unidade_medida_consumo, 
		a.nr_ocorrencia, 
		a.cd_intervalo, 
		a.ie_se_necessario, 
		0 nr_seq_proc, 
		obter_classif_material_proced(c.cd_material, null, null) ie_agrupador, 
		a.ds_horarios, 
		a.hr_prim_horario, 
		c.ie_permite_alterar 
	from	material d, 
		componente_kit c, 
		kit_material x, 
		material_estab b, 
		prescr_material a 
	where	a.nr_prescricao		= nr_prescricao_p 
	and	c.nr_sequencia		= nr_sequencia_p 
	and	b.cd_estabelecimento	= cd_estabelecimento_p 
	and	((a.ie_utiliza_kit 	= 'S') OR ('N' = 'N')) 
	and	((c.ie_recem_nato = coalesce(ie_recem_nato_w, 'A')) or (coalesce(c.ie_recem_nato, 'A') = 'A')) 
	and	c.cd_kit_material	= nr_seq_kit_p 
	and	x.cd_kit_material  	= c.cd_kit_material 
	and	x.ie_situacao    	= 'A' 
	and	c.ie_situacao    	= 'A' 
	and	a.cd_material   	= b.cd_material 
	and	b.cd_kit_material 	= c.cd_kit_material 
	and	c.cd_material   	= d.cd_material 
	and	((coalesce(c.cd_estab_regra::text, '') = '') or (c.cd_estab_regra = cd_estabelecimento_p)) 
	
union
 
	SELECT	a.nr_agrupamento, 
		a.ie_urgencia, 
		c.cd_material, 
		substr(obter_dados_material_estab(c.cd_material,cd_estabelecimento_p,'UMS'),1,30) cd_unidade_medida_consumo, 
		a.nr_ocorrencia, 
		a.cd_intervalo, 
		a.ie_se_necessario, 
		0 nr_seq_proc, 
		obter_classif_material_proced(c.cd_material, null, null) ie_agrupador, 
		a.ds_horarios, 
		a.hr_prim_horario, 
		c.ie_permite_alterar 
	from	material d, 
		componente_kit c, 
		kit_material x, 
		kit_mat_prescricao b, 
		prescr_material a 
	where	a.nr_prescricao		= nr_prescricao_p 
	and	c.nr_sequencia		= nr_sequencia_p 
	and	b.cd_estabelecimento	= cd_estabelecimento_p 
	and	((a.ie_utiliza_kit = 'S') OR ('N' = 'N')) 
	and	((c.ie_recem_nato = coalesce(ie_recem_nato_w, 'A')) or (coalesce(c.ie_recem_nato, 'A') = 'A')) 
	and	((coalesce(b.cd_setor_atendimento::text, '') = '') or (CASE WHEN cd_setor_atendimento_w=0 THEN  b.cd_setor_atendimento  ELSE cd_setor_atendimento_w END  = b.cd_setor_atendimento)) 
	and	x.cd_kit_material	= nr_seq_kit_p 
	and	x.cd_kit_material  	= c.cd_kit_material 
	and	x.ie_situacao    	= 'A' 
	and	c.ie_situacao    	= 'A' 
	and	a.cd_material   	= b.cd_material 
	and	b.cd_kit 		= c.cd_kit_material 
	and	c.cd_material   	= d.cd_material 
	and	((coalesce(b.ie_tipo_atendimento,0) = coalesce(ie_tipo_atendimento_w, coalesce(b.ie_tipo_atendimento,0))) or (coalesce(b.ie_tipo_atendimento::text, '') = '')) 
	and	((coalesce(c.cd_estab_regra::text, '') = '') or (c.cd_estab_regra = cd_estabelecimento_p)) 
	
union
 
	select	a.nr_agrupamento, 
		a.ie_urgencia, 
		c.cd_material, 
		substr(obter_dados_material_estab(c.cd_material,cd_estabelecimento_p,'UMS'),1,30) cd_unidade_medida_consumo, 
		1 nr_ocorrencia, 
		a.cd_intervalo, 
		'N', 
		0 nr_seq_proc, 
		obter_classif_material_proced(c.cd_material, null, null) ie_agrupador, 
		a.ds_horarios, 
		'', 
		c.ie_permite_alterar 
	from	material d, 
		componente_kit c, 
	   	kit_material x, 
		procedimento b, 
		prescr_procedimento a 
	where	a.nr_prescricao		= nr_prescricao_p 
	and	c.nr_sequencia		= nr_sequencia_p 
	and	x.cd_kit_material	= nr_seq_kit_p 
	and	x.cd_kit_material  	= c.cd_kit_material 
	and	x.ie_situacao    	= 'A' 
	and	c.ie_situacao    	= 'A' 
	and	((c.ie_recem_nato = coalesce(ie_recem_nato_w, 'A')) or (coalesce(c.ie_recem_nato, 'A') = 'A')) 
	and	a.cd_procedimento	= b.cd_procedimento 
	and	a.ie_origem_proced	= b.ie_origem_proced 
	and	b.cd_kit_material 	= c.cd_kit_material 
	and	c.cd_material   	= d.cd_material 
	and	((coalesce(c.cd_estab_regra::text, '') = '') or (c.cd_estab_regra = cd_estabelecimento_p)) 
	
union
 
	select	a.nr_agrupamento, 
		a.ie_urgencia, 
		c.cd_material, 
		substr(obter_dados_material_estab(c.cd_material,cd_estabelecimento_p,'UMS'),1,30) cd_unidade_medida_consumo, 
		1 nr_ocorrencia, 
		a.cd_intervalo, 
		'N' ie_se_necessario, 
		0 nr_seq_proc, 
		obter_classif_material_proced(c.cd_material, null, null) ie_agrupador, 
		a.ds_horarios, 
		'', 
		c.ie_permite_alterar 
	from	proc_interno_kit b, 
			prescr_procedimento a, 
			material d, 
			componente_kit c, 
			kit_material x 
	where	a.nr_seq_proc_interno 	= b.nr_seq_proc_interno 
	and	a.nr_prescricao 	= nr_prescricao_p 
	and	c.nr_sequencia 	= nr_sequencia_p 
	and	x.cd_kit_material	= nr_seq_kit_p 
	and	x.cd_kit_material  = c.cd_kit_material 
	and b.cd_kit_material  = c.cd_kit_material 
	and	x.ie_situacao    = 'A' 
	and	c.ie_situacao    = 'A' 
	and	b.cd_kit_material	= x.cd_kit_material 
	and	c.cd_material   	= d.cd_material 
	and	coalesce(b.cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w 
	and	coalesce(b.cd_estabelecimento,cd_estabelecimento_p)	  = cd_estabelecimento_p 
	and	coalesce(b.cd_medico,cd_medico_w)	          = cd_medico_w 
	and	coalesce(b.cd_convenio,cd_convenio_w)          = cd_convenio_w 
	and	coalesce(b.cd_perfil,cd_perfil_w)            = cd_perfil_w 
	and	qt_idade_w between obter_idade_kit_proced(b.nr_sequencia,'MIN') and obter_idade_kit_proced(b.nr_sequencia,'MAX') 
	and	(b.cd_kit_material IS NOT NULL AND b.cd_kit_material::text <> '');


BEGIN 
 
qt_material_kit_w	:= qt_material_p;
cd_perfil_w	:= coalesce(obter_perfil_ativo,0);
 
select	coalesce(max(cd_setor_atendimento), 0), 
	max(obter_tipo_atendimento(nr_atendimento)), 
	coalesce(max(ie_recem_nato), 'A'), 
	max(obter_convenio_atendimento(nr_atendimento)), 
	max(obter_idade_pf(cd_pessoa_fisica, clock_timestamp(), 'DIA')), 
	max(cd_medico) 
into STRICT	cd_setor_atendimento_w, 
	ie_tipo_atendimento_w, 
	ie_recem_nato_w, 
	cd_convenio_w, 
	qt_idade_w, 
	cd_medico_w 
from	prescr_medica 
where	nr_prescricao	= nr_prescricao_p;
 
OPEN C01;
LOOP 
FETCH C01 into 
	nr_agrupamento_w, 
	ie_urgencia_w, 
	cd_material_w,             
	cd_unidade_medida_w, 
	nr_ocorrencia_w, 
	cd_intervalo_w, 
	ie_se_necessario_w, 
	nr_seq_proc_w, 
	ie_agrupador_w, 
	ds_horarios_w, 
	hr_prim_horario_w, 
	ie_permite_alterar_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	select coalesce(max(nr_sequencia),0) + 1 
	into STRICT	nr_sequencia_w 
	from prescr_material 
	where nr_prescricao = nr_prescricao_p;
        
	qt_material_w := qt_material_kit_w * coalesce(nr_ocorrencia_w,1);
	 
	if (coalesce(qt_material_w,0) = 0) then 
		qt_material_w	:= 1;
	end if;
  
	if (nr_seq_proc_w = 0) then 
		nr_seq_proc_w	:= null;
	end if;
 
	if (ie_agrupador_w <> 1) then 
		ie_agrupador_w := 1;
	else 
		ie_agrupador_w := 2;
	end if;
 
	insert into prescr_material( 
		nr_prescricao, 
		nr_sequencia, 
		ie_origem_inf, 
		cd_material, 
		cd_unidade_medida, 
		qt_dose, 
		qt_unitaria, 
		qt_material, 
		dt_atualizacao, 
		nm_usuario, 
		cd_intervalo, 
		nr_agrupamento, 
		ie_urgencia, 
		nr_ocorrencia, 
		qt_total_dispensar, 
		ie_suspenso, 
		cd_unidade_medida_dose, 
		ie_se_necessario, 
		ie_medicacao_paciente, 
		cd_motivo_baixa, 
		ie_agrupador, 
		ie_bomba_infusao, 
		ie_aplic_bolus, 
		ie_aplic_lenta, 
		ie_acm, 
		ds_horarios, 
		ie_recons_diluente_fixo, 
		cd_kit_material, 
		ie_sem_aprazamento, 
		hr_prim_horario, 
		ie_permite_alterar) 
	Values ( 
		nr_prescricao_p, 
		nr_sequencia_w, 
		'K', 
		cd_material_w, 
		cd_unidade_medida_w, 
		qt_material_kit_w, 
		qt_material_kit_w, 
		qt_material_w, 
		clock_timestamp(), 
		nm_usuario_p,  
		cd_intervalo_w, 
		nr_agrupamento_w, 
		ie_urgencia_w, 
		nr_ocorrencia_w, 
		qt_material_w, 
		'N', 
		cd_unidade_medida_w, 
		ie_se_necessario_w, 
		'N', 
		0, 
		ie_agrupador_w, 
		'N', 
		'N', 
		'N', 
		'N', 
		ds_horarios_w, 
		'N', 
		nr_seq_kit_p, 
		'N', 
		hr_prim_horario_w, 
		ie_permite_alterar_w);
	end;
END LOOP;
CLOSE C01;
if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_kit_prescricao_manual ( nr_prescricao_p bigint, nr_sequencia_p bigint, nr_seq_kit_p bigint, qt_material_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

