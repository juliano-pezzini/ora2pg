-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_ajustar_valores_repasse ( nr_seq_repasse_p pls_repasse_vend.nr_sequencia%type, nm_usuario_p text) AS $body$
DECLARE


/* Finalidade:
	Na função OPS - Gestão de Vendedores e Comissões / Canal de venda / Repasse, quando as comissões são geradas e algum lançamento adicional é gerado na pasta Itens repasse / Lançamentos adicionais , 
	o valor do lançamento será descontado/somado ao valor total do repasse, sendo assim, os valores de repasse de cada beneficiário também precisam ser ajustados de modo que a soma dos repasses de cada 
	beneficiário seja igual ao total do repasse.
*/


-- Campos do cursor 1
nr_seq_repas_benef_w		pls_repasse_mens.nr_sequencia%type;
vl_repas_benef_w		pls_repasse_mens.vl_repasse%type;

-- Campos do cursor 2
nr_titulo_w			pls_repasse_lanc.nr_titulo%type;
vl_desconto_tit_w		pls_repasse_lanc.vl_lancamento%type;
vl_lanc_aplicado_w		pls_repasse_lanc.vl_lanc_aplicado%type;

vl_lancamento_w			pls_repasse_lanc.vl_lancamento%type;
vl_repasse_canal_w		pls_repasse_vend_venc.vl_vencimento%type;
vl_item_comissao_w		pls_repasse_mens.vl_item_comissao%type;
vl_repasse_benef_w		pls_repasse_mens.vl_repasse%type;
vl_repas_benef_ajust_w		pls_repasse_mens.vl_repasse%type;
vl_repas_item_benef_w		pls_repasse_mens_item.vl_repasse%type;
nr_seq_item_w			pls_repasse_mens_item.nr_sequencia%type;
ie_valor_percent_desconto_w	pls_parametros.ie_valor_percent_desconto%type;
vl_total_w			double precision;

C01 CURSOR FOR
	SELECT	nr_sequencia,
		vl_repasse
	from	pls_repasse_mens
	where	nr_seq_repasse = nr_seq_repasse_p;

C02 CURSOR FOR
	SELECT	distinct nr_titulo,
		sum(vl_lancamento),
		sum(vl_lanc_aplicado)
	from	pls_repasse_lanc
	where	nr_seq_repasse = nr_seq_repasse_p
	and	ie_tipo_lancamento = '3'
	group by nr_titulo;


BEGIN

-- Soma o valor de todos os lançamentos adicionais daquele repasse
select	sum(vl_lancamento)
into STRICT	vl_lancamento_w
from	pls_repasse_lanc
where	nr_seq_repasse = nr_seq_repasse_p
and	ie_tipo_lancamento not in ('3','5'); -- 3 - Desconto referente ao desconto concedido ao título a receber / 5 - Acréscimo referente aos juros e multas do título a receber
if (coalesce(vl_lancamento_w,0) <> 0) then

	select	sum(vl_vencimento)
	into STRICT	vl_repasse_canal_w
	from	pls_repasse_vend_venc
	where	nr_seq_repasse = nr_seq_repasse_p;
	
	select	sum(vl_repasse)
	into STRICT	vl_repasse_benef_w
	from	pls_repasse_mens
	where	nr_seq_repasse = nr_seq_repasse_p;
	
	--Se o valor total do repasse não for igual ao total comissionado nos beneficiários...
	if (vl_repasse_canal_w <> vl_repasse_benef_w) and (coalesce(vl_repasse_benef_w,0) > 0) then
		
		update	pls_repasse_mens
		set	vl_repasse = (vl_repasse_canal_w * vl_repasse) / vl_repasse_benef_w
		where	nr_seq_repasse = nr_seq_repasse_p;
		
		select	sum(vl_repasse)
		into STRICT	vl_repas_benef_ajust_w
		from	pls_repasse_mens
		where	nr_seq_repasse = nr_seq_repasse_p;
		
		-- Obs: é necessário verificar novamente se o valor total do repasse é igual ao total comissionado nos beneficiários devido ao arredondamento dos valores, sendo assim ainda pode haver diferença de centavos entre os valores.
		if (vl_repas_benef_ajust_w <> vl_repasse_canal_w) then
			update	pls_repasse_mens
			set	vl_repasse = vl_repasse + (vl_repasse_canal_w - vl_repas_benef_ajust_w)
			where	nr_sequencia = (SELECT	max(nr_sequencia)
						from	pls_repasse_mens
						where	nr_seq_repasse = nr_seq_repasse_p);
		end if;
		
		update	pls_repasse_mens_item
		set	vl_repasse = (vl_repasse_canal_w * vl_repasse) / vl_repasse_benef_w
		where	nr_seq_repasse in (	SELECT	nr_sequencia
						from	pls_repasse_mens
						where	nr_seq_repasse = nr_seq_repasse_p);
		
		open C01;
		loop
		fetch C01 into
			nr_seq_repas_benef_w,
			vl_repas_benef_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			
			select	sum(vl_repasse)
			into STRICT	vl_repas_item_benef_w
			from	pls_repasse_mens_item
			where	nr_seq_repasse = nr_seq_repas_benef_w;
			
			-- Obs: é necessário verificar novamente se o valor total de repasse no beneficiário é igual ao total de repasse dos itens devido ao arredondamento dos valores, sendo assim ainda pode haver diferença de centavos entre os valores.
			if (vl_repas_item_benef_w <> vl_repas_benef_w) then
				select	max(nr_sequencia)
				into STRICT	nr_seq_item_w
				from	pls_repasse_mens_item
				where	nr_seq_repasse = nr_seq_repas_benef_w
				and	ie_tipo_item = 1;
				
				if (coalesce(nr_seq_item_w::text, '') = '') then
					select	max(nr_sequencia)
					into STRICT	nr_seq_item_w
					from	pls_repasse_mens_item
					where	nr_seq_repasse = nr_seq_repas_benef_w;
				end if;
				
				update	pls_repasse_mens_item
				set	vl_repasse = vl_repasse + (vl_repas_benef_w - vl_repas_item_benef_w)
				where	nr_sequencia = nr_seq_item_w;
			end if;
			end;
		end loop;
		close C01;
	end if;
end if;

-- Soma o valor dos lançamentos adicionais de Desconto referente ao desconto concedido ao título a receber
select	coalesce(sum(vl_lanc_aplicado),sum(vl_lancamento))
into STRICT	vl_desconto_tit_w
from	pls_repasse_lanc
where	nr_seq_repasse = nr_seq_repasse_p
and	ie_tipo_lancamento = '3'; -- 3 - Desconto referente ao desconto concedido ao título a receber
if (coalesce(vl_desconto_tit_w,0) <> 0) then
	select	coalesce(ie_valor_percent_desconto,'V')
	into STRICT	ie_valor_percent_desconto_w
	from	pls_parametros
	where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;
	
	open C02;
	loop
	fetch C02 into
		nr_titulo_w,
		vl_desconto_tit_w,
		vl_lanc_aplicado_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		select	sum(vl_item_comissao),
			sum(vl_repasse)
		into STRICT	vl_item_comissao_w,
			vl_repasse_benef_w
		from	pls_repasse_mens
		where	nr_seq_repasse = nr_seq_repasse_p
		and	pls_obter_titulo_mensalidade(null,nr_seq_mens_seg) = nr_titulo_w;
		
		if (coalesce(vl_repasse_benef_w,0) > 0) then
			
			vl_total_w := vl_repasse_benef_w;
			
			update	pls_repasse_mens
			set	vl_repasse = vl_repasse + ((vl_lanc_aplicado_w * vl_repasse) / vl_total_w)
			where	nr_seq_repasse = nr_seq_repasse_p
			and	pls_obter_titulo_mensalidade(null,nr_seq_mens_seg) = nr_titulo_w;
			
			select	sum(vl_repasse)
			into STRICT	vl_repas_benef_ajust_w
			from	pls_repasse_mens
			where	nr_seq_repasse = nr_seq_repasse_p
			and	pls_obter_titulo_mensalidade(null,nr_seq_mens_seg) = nr_titulo_w;
			
			if	((vl_repas_benef_ajust_w - vl_repasse_benef_w) <> vl_lanc_aplicado_w) then
				update	pls_repasse_mens
				set	vl_repasse = vl_repasse + (vl_lanc_aplicado_w - (vl_repas_benef_ajust_w - vl_repasse_benef_w))
				where	nr_sequencia = (SELECT	max(nr_sequencia)
							from	pls_repasse_mens
							where	nr_seq_repasse = nr_seq_repasse_p
							and	pls_obter_titulo_mensalidade(null,nr_seq_mens_seg) = nr_titulo_w);
			end if;
			
			update	pls_repasse_mens_item
			set	vl_repasse = vl_repasse + ((vl_lanc_aplicado_w * vl_repasse) / vl_total_w)
			where	nr_seq_repasse in (	SELECT	nr_sequencia
							from	pls_repasse_mens
							where	nr_seq_repasse = nr_seq_repasse_p
							and	pls_obter_titulo_mensalidade(null,nr_seq_mens_seg) = nr_titulo_w);
		end if;
		end;
	end loop;
	close C02;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ajustar_valores_repasse ( nr_seq_repasse_p pls_repasse_vend.nr_sequencia%type, nm_usuario_p text) FROM PUBLIC;

