-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_gerar_endereco_prestador ( nr_seq_prestador_p bigint, cd_pessoa_fisica_p text, cd_cgc_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Gerar os enderecos dos prestadores do A400
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[ X ]  Objetos do dicionario [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
-------------------------------------------------------------------------------------------------------------------

Referencias:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ds_website_w			varchar(80);
ds_endereco_w			varchar(40);
ds_email_w			varchar(80);
nm_prestador_w			varchar(40);
ds_bairro_w			varchar(30);
ds_complemento_w		ptu_prestador_endereco.ds_complemento%type;
nr_cpf_w			varchar(14);
cd_cgc_w			varchar(14);
cd_pessoa_fisica_w		varchar(10);
ie_tipo_lote_w			varchar(10);
cd_cnes_prest_w			varchar(20);
cd_cnes_w			varchar(20);
cd_cnes_ant_w			varchar(20);
nr_endereco_w			varchar(6);
cd_municipio_ibge_w		varchar(6);
ie_tipo_endereco_w		varchar(4);
nr_seq_prestador_w		bigint;
nr_telefone_w			bigint;
ds_fone_adic_w			bigint;
ds_fax_w			bigint;
nr_seq_compl_pf_tel_adic_w	bigint	:= null;
nr_seq_endereco_w		bigint;
count_w				bigint;
nr_leitos_hosp_dia_w		bigint;
nr_leitos_tot_clinic_w		bigint;
nr_leitos_tot_cirurgico_w	bigint;
nr_leitos_tot_obstr_w		bigint;
nr_leitos_tot_pediat_w		bigint;
nr_leitos_tot_psiqu_w		bigint;
nr_leitos_intermed_w		bigint;
nr_seq_compl_pj_w		bigint;
cd_cep_w			integer;
nr_leitos_contrat_w		integer	:= null;
nr_leitos_psiquiat_w		integer	:= null;
nr_leitos_totais_w		integer	:= null;
nr_uti_adulto_w			integer	:= null;
nr_uti_neonatal_w		integer	:= null;
nr_uti_pediatra_w		integer	:= null;
nr_leitos_intermed_neo_w	integer	:= null;
cd_estabelecimento_w		smallint;
nr_ddd_telefone_w		smallint;
ie_tipo_complemento_w		smallint;
dt_referencia_w			timestamp;
ie_filial_w			varchar(2) := 'N';
nr_seq_tipo_compl_adic_w	pls_prestador.nr_seq_tipo_compl_adic%type;
nr_seq_prest_medico_w		pls_prestador_medico.nr_sequencia%type;
ie_tipo_endereco_ptu_w		pls_prestador.ie_tipo_endereco_ptu%type;
ie_instituicao_acred_ptu_w	varchar(255);
nr_referencia_end_w		pls_prestador.nr_referencia_end%type;
nr_referencia_end_adic_w	pls_prestador_medico.nr_referencia_end%type;
nr_latitude_w			pls_prestador.nr_latitude%type;
nr_longitude_w			pls_prestador.nr_longitude%type;
ie_adic_w			varchar(1);
ie_tipo_prestador_w		ptu_prestador.ie_tipo_prestador%type;
nr_telefone_dois_w		pls_prestador.nr_telefone_dois%type;
ie_divulga_email_w		pls_prestador.ie_divulga_email%type;
ie_divulga_site_w		pls_prestador.ie_divulga_site%type;
nr_seq_compl_pj_prest_w		pessoa_juridica_compl.nr_sequencia%type;
nr_seq_tipo_compl_adic_prest_w	pls_prestador.nr_seq_tipo_compl_adic%type;
nr_seq_compl_pf_tel_ad_prest_w	bigint	:= null;
ds_email_sec_w			varchar(80);
nr_referencia_end_ptu_w		pls_prestador_endereco.nr_referencia_end%type;
ie_prest_acred_w		ptu_prestador_endereco.ie_prest_acred%type;
nr_seq_prest_end_w		pls_prestador_endereco.nr_sequencia%type;

ie_fone_whats_guia_medico_w	pls_prestador.ie_fone_whats_guia_medico%type;
nr_ddd_fone_whatsapp_w		pls_prestador.nr_ddd_fone_whatsapp%type;
nr_fone_whatsapp_w		pls_prestador.nr_fone_whatsapp%type;

ie_tipo_endereco_prest_w	pls_prestador.ie_tipo_endereco%type;
nr_compl_pf_tel_adic_prest_w	pls_prestador.nr_seq_compl_pf_tel_adic%type;
nr_tipo_comp_adic_prest_w	pls_prestador.nr_seq_tipo_compl_adic%type;

C01 CURSOR FOR
	SELECT	/*+ USE_CONCAT */		substr(a.nr_cpf,1,14),
		substr(b.ds_endereco,1,40), 
		substr(b.nr_endereco,1,6),
		substr(elimina_caractere_especial(b.ds_complemento),1,30),
		substr(b.ds_bairro,1,30),
		substr(b.cd_municipio_ibge,1,6),
		to_char(somente_numero(substr(b.cd_cep,1,8))),
		to_char(somente_numero(substr(b.nr_ddd_telefone,1,4))),
		to_char(somente_numero(substr((coalesce(b.nr_telefone,0)),1,12))),
		to_char(somente_numero(substr(coalesce(b.ds_fone_adic, nr_telefone_dois_w ),1,12))),
		to_char(somente_numero(substr(b.ds_fax,1,12))),
		substr(trim(both replace(replace(b.ds_email,chr(13),''),chr(10), '')),1,80),
		substr(b.ds_website,1,80),
		substr(obter_compl_pf(a.cd_pessoa_fisica,b.ie_tipo_complemento,'CNES'),1,20) cd_cnes,
		substr(obter_nome_pf_pj(a.cd_pessoa_fisica, null),1,40) nm_prestador,
		b.nr_sequencia nr_seq_tipo_compl_adic,
		null nr_seq_compl_pf_tel_adic,
		null
	from	compl_pessoa_fisica	b,
		pessoa_fisica		a
	where	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
	and	b.cd_pessoa_fisica	= a.cd_pessoa_fisica
	and	b.ie_tipo_complemento	= 1
	and	ie_tipo_endereco_w	= 'PFR'
	
union all

	SELECT	substr(a.nr_cpf,1,14),
		substr(b.ds_endereco,1,40),
		substr(b.nr_endereco,1,6),
		substr(elimina_caractere_especial(b.ds_complemento),1,30),
		substr(b.ds_bairro,1,30),
		substr(b.cd_municipio_ibge,1,6),
		to_char(somente_numero(substr(b.cd_cep,1,8))),
		to_char(somente_numero(substr(b.nr_ddd_telefone,1,4))),
		to_char(somente_numero(substr((coalesce(b.nr_telefone,0)),1,12))),
		to_char(somente_numero(substr(coalesce(b.ds_fone_adic, nr_telefone_dois_w),1,12))),
		to_char(somente_numero(substr(b.ds_fax,1,12))),
		substr(trim(both replace(replace(b.ds_email,chr(13),''),chr(10), '')),1,80),
		substr(b.ds_website,1,80),
		substr(obter_compl_pf(a.cd_pessoa_fisica,b.ie_tipo_complemento,'CNES'),1,20) cd_cnes,
		substr(obter_nome_pf_pj(a.cd_pessoa_fisica, null),1,40) nm_prestador,
		b.nr_sequencia nr_seq_tipo_compl_adic,
		null nr_seq_compl_pf_tel_adic,
		null
	from	compl_pessoa_fisica	b,
		pessoa_fisica		a
	where	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
	and	b.cd_pessoa_fisica	= a.cd_pessoa_fisica
	and	b.ie_tipo_complemento	= 2
	and	ie_tipo_endereco_w	= 'PFC'
	and	coalesce(nr_seq_compl_pf_tel_adic_w::text, '') = ''
	
union all

	select	substr(a.nr_cpf,1,14),
		substr(b.ds_endereco,1,40),
		substr(b.nr_endereco,1,6),
		substr(elimina_caractere_especial(b.ds_complemento),1,30),
		substr(b.ds_bairro,1,30),
		substr(b.cd_municipio_ibge,1,6),
		to_char(somente_numero(substr(b.cd_cep,1,8))),
		to_char(somente_numero(substr(b.nr_ddd_telefone,1,4))),
		to_char(somente_numero(substr((coalesce(b.nr_telefone,0)),1,12))),
		null,
		null,
		substr(trim(both replace(replace(b.ds_email,chr(13),''),chr(10), '')),1,80),
		null,
		substr(obter_cnes_compl_pf_adic(a.cd_pessoa_fisica,b.nr_sequencia),1,20) cd_cnes,
		substr(obter_nome_pf_pj(a.cd_pessoa_fisica, null),1,40) nm_prestador,
		null nr_seq_tipo_compl_adic,
		b.nr_sequencia nr_seq_compl_pf_tel_adic,
		null
	from	compl_pf_tel_adic b,
		pessoa_fisica a
	where	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
	and	b.cd_pessoa_fisica	= a.cd_pessoa_fisica
	and	ie_tipo_endereco_w	= 'PFC'
	and	(nr_seq_compl_pf_tel_adic_w IS NOT NULL AND nr_seq_compl_pf_tel_adic_w::text <> '')
	and	b.nr_sequencia		= nr_seq_compl_pf_tel_adic_w
	
union all

	select	substr(a.nr_cpf,1,14), 
		substr(b.ds_endereco,1,40), 
		substr(b.nr_endereco,1,6),
		substr(elimina_caractere_especial(b.ds_complemento),1,30),
		substr(b.ds_bairro,1,30),
		substr(b.cd_municipio_ibge,1,6),
		to_char(somente_numero(substr(b.cd_cep,1,8))),
		to_char(somente_numero(substr(b.nr_ddd_telefone,1,4))),
		to_char(somente_numero(substr((coalesce(b.nr_telefone,0)),1,12))),
		to_char(somente_numero(substr(coalesce(b.ds_fone_adic, nr_telefone_dois_w),1,12))),
		to_char(somente_numero(substr(b.ds_fax,1,12))),
		substr(trim(both replace(replace(b.ds_email,chr(13),''),chr(10), '')),1,80),
		substr(b.ds_website,1,80),
		substr(obter_compl_pf(a.cd_pessoa_fisica,b.ie_tipo_complemento,'CNES'),1,20) cd_cnes,
		substr(obter_nome_pf_pj(a.cd_pessoa_fisica, null),1,40) nm_prestador,
		b.nr_sequencia nr_seq_tipo_compl_adic,
		null nr_seq_compl_pf_tel_adic,
		null
	from	compl_pessoa_fisica	b,
		pessoa_fisica		a
	where	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
	and	b.cd_pessoa_fisica	= a.cd_pessoa_fisica
	and	b.nr_seq_tipo_compl_adic = nr_seq_tipo_compl_adic_w
	and	(nr_seq_tipo_compl_adic_w IS NOT NULL AND nr_seq_tipo_compl_adic_w::text <> '')
	and	b.ie_tipo_complemento	= 9
	and	ie_tipo_endereco_w	= 'PFA'
	order by cd_cnes;

C02 CURSOR FOR
	SELECT	/*+ USE_CONCAT */		substr(ds_endereco,1,40),
		substr(nr_endereco,1,6),
		substr(elimina_caractere_especial(ds_complemento),1,30),
		substr(ds_bairro,1,30),
		somente_numero(cd_municipio_ibge),
		somente_numero(substr(cd_cep,1,8)),
		somente_numero(substr(nr_ddd_telefone,1,4)),
		somente_numero(substr((coalesce(nr_telefone,0)),1,12)),
		somente_numero(substr(nr_fax,1,12)),
		somente_numero(substr(nr_telefone_dois_w,1,12)),
		substr(ds_site_internet,1,80),
		substr(cd_cnes,1,20) cd_cnes,
		substr(trim(both replace(replace(coalesce(obter_dados_pf_pj_estab(cd_estabelecimento_p,null,a.cd_cgc,'M'),a.ds_email),chr(13),''),chr(10), '')),1,80),
		null nr_seq_compl_pj,
		null
	from	pessoa_juridica a
	where	cd_cgc	= cd_cgc_w
	and	ie_tipo_endereco_w = 'PJ'
	
union all

	SELECT	substr(b.ds_endereco,1,40),
		substr(b.nr_endereco,1,6),
		substr(elimina_caractere_especial(b.ds_complemento),1,30),
		substr(b.ds_bairro,1,30),
		somente_numero(b.cd_municipio_ibge),
		somente_numero(substr(b.cd_cep,1,8)),
		somente_numero(substr(b.nr_ddd_telefone,1,4)),
		somente_numero(substr((coalesce(b.nr_telefone,0)),1,12)),
		somente_numero(substr(b.nr_fax,1,12)),
		somente_numero(substr(nr_telefone_dois_w,1,12)),
		substr(a.ds_site_internet,1,80),
		substr(a.cd_cnes,1,20) cd_cnes,
		substr(trim(both replace(replace(b.ds_email,chr(13),''),chr(10), '')),1,80),
		b.nr_sequencia nr_seq_compl_pj,
		null
	from	pessoa_juridica_compl b,
		pessoa_juridica a
	where	a.cd_cgc	= b.cd_cgc
	and	a.cd_cgc	= cd_cgc_w
	and	b.ie_tipo_complemento = 1
	and	ie_tipo_endereco_w = 'PJC'
	and	b.nr_sequencia = coalesce(nr_seq_compl_pj_w,b.nr_sequencia)
	
union all

	select	substr(b.ds_endereco,1,40),
		substr(b.nr_endereco,1,6),
		substr(elimina_caractere_especial(b.ds_complemento),1,30),
		substr(b.ds_bairro,1,30),
		somente_numero(b.cd_municipio_ibge),
		somente_numero(substr(b.cd_cep,1,8)),
		somente_numero(substr(b.nr_ddd_telefone,1,4)),
		somente_numero(substr((coalesce(b.nr_telefone,0)),1,12)),
		somente_numero(substr(b.nr_fax,1,12)),
		somente_numero(substr(nr_telefone_dois_w,1,12)),
		substr(a.ds_site_internet,1,80),
		substr(a.cd_cnes,1,20) cd_cnes,
		substr(trim(both replace(replace(b.ds_email,chr(13),''),chr(10), '')),1,80),
		b.nr_sequencia nr_seq_compl_pj,
		null
	from	pessoa_juridica_compl b,
		pessoa_juridica a
	where	a.cd_cgc	= b.cd_cgc
	and	a.cd_cgc	= cd_cgc_w
	and	b.ie_tipo_complemento = 2
	and	ie_tipo_endereco_w = 'PJF'
	and	b.nr_sequencia = coalesce(nr_seq_compl_pj_w,b.nr_sequencia)
	
union all

	select	substr(b.ds_endereco,1,40),
		substr(b.nr_endereco,1,6),
		substr(elimina_caractere_especial(b.ds_complemento),1,30),
		substr(b.ds_bairro,1,30),
		somente_numero(b.cd_municipio_ibge),
		somente_numero(substr(b.cd_cep,1,8)),
		somente_numero(substr(b.nr_ddd_telefone,1,4)),
		somente_numero(substr((coalesce(b.nr_telefone,0)),1,12)),
		somente_numero(substr(b.nr_fax,1,12)),
		somente_numero(substr(nr_telefone_dois_w,1,12)),
		substr(a.ds_site_internet,1,80),
		substr(a.cd_cnes,1,20) cd_cnes,
		substr(trim(both replace(replace(b.ds_email,chr(13),''),chr(10), '')),1,80),
		b.nr_sequencia nr_seq_compl_pj,
		null
	from	pessoa_juridica_compl b,
		pessoa_juridica a
	where	a.cd_cgc	= b.cd_cgc
	and	a.cd_cgc	= cd_cgc_w
	and	b.ie_tipo_complemento = 6
	and	ie_tipo_endereco_w = 'PJA'
	and	b.nr_sequencia = coalesce(nr_seq_compl_pj_w,b.nr_sequencia)
	order by cd_cnes;	
	
C03 CURSOR FOR
	SELECT	/*+ USE_CONCAT */		a.nr_sequencia,
		a.cd_pessoa_fisica,
		a.cd_cgc,
		a.ie_tipo_endereco,
		a.nr_seq_compl_pf_tel_adic,
		coalesce(a.ie_filial,'N'),
		a.nr_seq_tipo_compl_adic,
		null nr_seq_prest_medico,
		null nr_referencia_end,
		'N' ie_adic,
		null nr_referencia_end_ptu,
		null nr_seq_prest_end
	from	pls_prestador a
	where	a.cd_estabelecimento	= cd_estabelecimento_p
	and	((cd_pessoa_fisica	= cd_pessoa_fisica_p) or (cd_cgc		= cd_cgc_p))
	and	((a.ie_ptu_a400	= 'S' and ie_tipo_lote_w = 'PTU') or (a.ie_guia_medico = 'S' and ie_tipo_lote_w = 'GUIA'))
	and	a.ie_tipo_relacao <> 'F'
	and	not exists (SELECT	1
				from	pls_prestador_endereco e
				where	e.nr_seq_prestador	= a.nr_sequencia
				and 	coalesce(e.ie_situacao,'A') 	= 'A')
	
union all

	select	b.nr_sequencia,
		b.cd_pessoa_fisica,
		b.cd_cgc,
		b.ie_tipo_endereco,
		b.nr_seq_compl_pf_tel_adic,
		coalesce(b.ie_filial,'N'),
		b.nr_seq_tipo_compl_adic,
		c.nr_sequencia nr_seq_prest_medico,
		c.nr_referencia_end,
		'S' ie_adic,
		null nr_referencia_end_ptu,
		null nr_seq_prest_end
	from	pls_prestador b,
		pls_prestador_medico c
	where	b.nr_sequencia	= c.nr_seq_prestador
	and	c.ie_situacao	= 'A'
	and	((b.ie_ptu_a400	= 'S' and ie_tipo_lote_w = 'PTU' and (exists (select	1
			from	pls_prestador_med_espec	x
			where	x.cd_pessoa_fisica	= c.cd_medico
			and	x.nr_seq_prestador	= b.nr_sequencia
			and	dt_referencia_w between trunc(coalesce(x.dt_inicio_vigencia, dt_referencia_w), 'dd') and fim_dia(trunc(coalesce(x.dt_fim_vigencia, dt_referencia_w), 'dd'))
			and	x.ie_publicacao		<> 'NP'))) or (b.ie_guia_medico = 'S' and ie_tipo_lote_w = 'GUIA' and (exists (select	1
			from	pls_prestador_med_espec	x
			where	x.cd_pessoa_fisica	= c.cd_medico
			and	x.nr_seq_prestador	= b.nr_sequencia
			and	dt_referencia_w between trunc(coalesce(x.dt_inicio_vigencia, dt_referencia_w), 'dd') and fim_dia(trunc(coalesce(x.dt_fim_vigencia, dt_referencia_w), 'dd'))
			and	x.ie_publicacao_arq_guia <> 'NP'))))
	and	dt_referencia_w between trunc(coalesce(c.dt_inclusao, dt_referencia_w),'dd') and fim_dia(trunc(coalesce(c.dt_exclusao, dt_referencia_w),'dd'))
	and	c.cd_medico		= cd_pessoa_fisica_p
	and	b.cd_estabelecimento	= cd_estabelecimento_p
	and	not exists (select	1
				from	pls_prestador_endereco e
				where	e.nr_seq_prestador	= b.nr_sequencia
				and 	coalesce(e.ie_situacao,'A') 	= 'A')
	
union all

	select	/*+ USE_CONCAT */		a.nr_sequencia,
		a.cd_pessoa_fisica,
		a.cd_cgc,
		e.ie_tipo_endereco,
		e.nr_seq_compl_pf_tel_adic,
		coalesce(a.ie_filial,'N'),
		e.nr_seq_tipo_compl_adic,
		null nr_seq_prest_medico,
		null nr_referencia_end,
		'N' ie_adic,
		e.nr_referencia_end nr_referencia_end_ptu,
		e.nr_sequencia nr_seq_prest_end
	from	pls_prestador a,
		pls_prestador_endereco e
	where	a.nr_sequencia		= e.nr_seq_prestador
	and 	coalesce(e.ie_situacao,'A') 	= 'A'
	and	a.cd_estabelecimento	= cd_estabelecimento_p
	and	((cd_pessoa_fisica	= cd_pessoa_fisica_p) or (cd_cgc		= cd_cgc_p))
	and	((a.ie_ptu_a400	= 'S' and ie_tipo_lote_w = 'PTU') or (a.ie_guia_medico = 'S' and ie_tipo_lote_w = 'GUIA'))
	and	a.ie_tipo_relacao <> 'F'
	
union all

	select	b.nr_sequencia,
		b.cd_pessoa_fisica,
		b.cd_cgc,
		e.ie_tipo_endereco,
		e.nr_seq_compl_pf_tel_adic,
		coalesce(b.ie_filial,'N'),
		e.nr_seq_tipo_compl_adic,
		c.nr_sequencia nr_seq_prest_medico,
		c.nr_referencia_end,
		'S' ie_adic,
		e.nr_referencia_end nr_referencia_end_ptu,
		e.nr_sequencia nr_seq_prest_end
	from	pls_prestador b,
		pls_prestador_endereco e,
		pls_prestador_medico c
	where	b.nr_sequencia	= e.nr_seq_prestador
	and	b.nr_sequencia	= c.nr_seq_prestador
	and	c.ie_situacao	= 'A'
	and 	coalesce(e.ie_situacao,'A') 	= 'A'
	and	((b.ie_ptu_a400	= 'S' and ie_tipo_lote_w = 'PTU' and (exists (select	1
			from	pls_prestador_med_espec	x
			where	x.cd_pessoa_fisica	= c.cd_medico
			and	x.nr_seq_prestador	= b.nr_sequencia
			and	dt_referencia_w between trunc(coalesce(x.dt_inicio_vigencia, dt_referencia_w), 'dd') and fim_dia(trunc(coalesce(x.dt_fim_vigencia, dt_referencia_w), 'dd'))
			and	x.ie_publicacao		<> 'NP'))) or (b.ie_guia_medico = 'S' and ie_tipo_lote_w = 'GUIA' and (exists (select	1
			from	pls_prestador_med_espec	x
			where	x.cd_pessoa_fisica	= c.cd_medico
			and	x.nr_seq_prestador	= b.nr_sequencia
			and	dt_referencia_w between trunc(coalesce(x.dt_inicio_vigencia, dt_referencia_w), 'dd') and fim_dia(trunc(coalesce(x.dt_fim_vigencia, dt_referencia_w), 'dd'))
			and	x.ie_publicacao_arq_guia <> 'NP'))))
	and	dt_referencia_w between trunc(coalesce(c.dt_inclusao, dt_referencia_w),'dd') and fim_dia(trunc(coalesce(c.dt_exclusao, dt_referencia_w),'dd'))
	and	c.cd_medico		= cd_pessoa_fisica_p
	and	b.cd_estabelecimento	= cd_estabelecimento_p;
	

BEGIN

if (nr_seq_prestador_p IS NOT NULL AND nr_seq_prestador_p::text <> '') then

	

	select	max(a.ie_tipo_lote),
		max(a.dt_referencia),
		max(b.ie_tipo_prestador)
	into STRICT	ie_tipo_lote_w,
		dt_referencia_w,
		ie_tipo_prestador_w
	from	ptu_movimento_prestador a,
		ptu_prestador b
	where	a.nr_sequencia	= b.nr_seq_movimento
	and	b.nr_sequencia	= nr_seq_prestador_p;

	open C03;
	loop
	fetch C03 into	
		nr_seq_prestador_w,
		cd_pessoa_fisica_w,
		cd_cgc_w,
		ie_tipo_endereco_w,
		nr_seq_compl_pf_tel_adic_w,
		ie_filial_w,
		nr_seq_tipo_compl_adic_w,
		nr_seq_prest_medico_w,
		nr_referencia_end_adic_w,
		ie_adic_w,
		nr_referencia_end_ptu_w,
		nr_seq_prest_end_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin
		
		select	max(nr_seq_compl_pj),
			max(ie_tipo_endereco_ptu),
			max(ie_instituicao_acred_ptu),
			max(nr_referencia_end),
			max(nr_latitude),
			max(nr_longitude),
			max(nr_telefone_dois),
			coalesce(max(ie_divulga_email),'S'),
			coalesce(max(ie_divulga_site),'S'),
			max(pls_obter_cnes_prestador(nr_sequencia)),
			max(ie_fone_whats_guia_medico),
			max(nr_ddd_fone_whatsapp),
			max(nr_fone_whatsapp)
		into STRICT	nr_seq_compl_pj_w,
			ie_tipo_endereco_ptu_w,
			ie_instituicao_acred_ptu_w,
			nr_referencia_end_w,
			nr_latitude_w,
			nr_longitude_w,
			nr_telefone_dois_w,
			ie_divulga_email_w,
			ie_divulga_site_w,
			cd_cnes_prest_w,
			ie_fone_whats_guia_medico_w,
			nr_ddd_fone_whatsapp_w,
			nr_fone_whatsapp_w
		from	pls_prestador
		where	nr_sequencia	= nr_seq_prestador_w;	
		
		if (ie_adic_w = 'S') then
			nr_referencia_end_w := nr_referencia_end_adic_w;
		end if;	
		
		nr_referencia_end_w	:= coalesce(nr_referencia_end_ptu_w,nr_referencia_end_w);
		
		-- Numero de leitos 
		select	coalesce(max(nr_leitos_contrat),0),
			coalesce(max(nr_leitos_psiquiat),0),      
			coalesce(max(nr_leitos_totais),0),        
			coalesce(max(nr_uti_adulto),0),           
			coalesce(max(nr_uti_neonatal),0),         
			coalesce(max(nr_uti_pediatra),0),
			coalesce(max(nr_leitos_intermed),0),
			coalesce(max(nr_leitos_hosp_dia),0),
			coalesce(max(nr_leitos_tot_clinic),0),
			coalesce(max(nr_leitos_tot_cirurgico),0),
			coalesce(max(nr_leitos_tot_obstr),0),
			coalesce(max(nr_leitos_tot_pediat),0),
			coalesce(max(nr_leitos_tot_psiqu),0),
			coalesce(max(nr_leitos_intermed_neo),0)
		into STRICT	nr_leitos_contrat_w,
			nr_leitos_psiquiat_w,
			nr_leitos_totais_w,
			nr_uti_adulto_w,
			nr_uti_neonatal_w,
			nr_uti_pediatra_w,
			nr_leitos_intermed_w,
			nr_leitos_hosp_dia_w,
			nr_leitos_tot_clinic_w,
			nr_leitos_tot_cirurgico_w,
			nr_leitos_tot_obstr_w,
			nr_leitos_tot_pediat_w,
			nr_leitos_tot_psiqu_w,
			nr_leitos_intermed_neo_w
		from	pls_prestador_inst_fisica
		where	nr_seq_prestador	= nr_seq_prestador_w
		and	ie_tipo_prestador_w	not in ('01');	-- Para TP_PREST = 02 (Hospital), e obrigatorio o envio dos campos de numero de leitos, caso exista o recurso. Para TP_PREST = 10 (Hospital Dia) e obrigatorio o preenchimento do campo NR_LEITOS_HOSP_DIA.  
								-- - Se DT_EXCL_UNI estiver preenchido, este campo passa a ser opcional tambem para TP_PREST = 02 e 10 
		
		if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
			open C01;
			loop
			fetch C01 into
				nr_cpf_w,
				ds_endereco_w,
				nr_endereco_w,
				ds_complemento_w,
				ds_bairro_w,
				cd_municipio_ibge_w,
				cd_cep_w,
				nr_ddd_telefone_w,
				nr_telefone_w,
				ds_fone_adic_w,
				ds_fax_w,
				ds_email_w,
				ds_website_w,
				cd_cnes_w,
				nm_prestador_w,
				nr_seq_tipo_compl_adic_prest_w,
				nr_seq_compl_pf_tel_ad_prest_w,
				ds_email_sec_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
				begin				
				if (coalesce(cd_cnes_w::text, '') = '') then
					cd_cnes_w	:= cd_cnes_prest_w;
					
					if (substr(cd_cnes_ant_w,1,7) = substr(cd_cnes_w,1,7)) then
						cd_cnes_w := null;
					end if;
				end if;

				if (nr_ddd_telefone_w = 0) then
					nr_ddd_telefone_w	:= null;
				end if;

				select	count(1)
				into STRICT	count_w
				from	ptu_prestador_endereco
				where	nr_seq_prestador	= nr_seq_prestador_p
				and	cd_cnes			= substr(cd_cnes_w, 1, 7)
				and	substr(cd_cnes_w, 1, 7) <> '9999999';
				
				if	((coalesce(cd_cnes_ant_w, 0) != cd_cnes_w) or (coalesce(cd_cnes_w, '9999999') = '9999999')) and (count_w = 0) then
					if (length(cd_cnes_w) > 7) then
						CALL ptu_gravar_inconsist_prestador(nr_seq_prestador_p,56,nm_usuario_p);
						cd_cnes_w	:= substr(cd_cnes_w,1,7);
					end if;
					
					if (ie_divulga_email_w = 'N') then
						ds_email_w	:= null;
						ds_email_sec_w	:= null;
					end if;
					
					if (ie_divulga_site_w = 'N') then
						ds_website_w := null;
					end if;
					
					ie_prest_acred_w := 'S';
					if (ie_tipo_prestador_w in (1,5,7)) or (coalesce(ie_instituicao_acred_ptu_w::text, '') = '') then
						ie_prest_acred_w := 'N';
					end if;	
					
					ds_endereco_w := ptu_somente_caracter_permitido(ds_endereco_w,'ANS+'); -- 28/05/2019 gfurlan OS 1901279: Alterado parametro ANS+ para ANS, removendo acentos do endereco
					
					if (ie_fone_whats_guia_medico_w = 'S') and ( coalesce(nr_ddd_fone_whatsapp_w::text, '') = '') and (coalesce(nr_fone_whatsapp_w::text, '') = '') then
						
						select 	ie_tipo_endereco,
							nr_seq_compl_pf_tel_adic,
							nr_seq_tipo_compl_adic
						into STRICT	ie_tipo_endereco_prest_w,
							nr_compl_pf_tel_adic_prest_w,
							nr_tipo_comp_adic_prest_w
						from	pls_prestador
						where 	nr_sequencia = nr_seq_prestador_w;
						
						nr_ddd_fone_whatsapp_w 	:= substr(pls_obter_tel_prest( cd_pessoa_fisica_w, cd_cgc_w, 'DDT', ie_tipo_endereco_prest_w, nr_seq_compl_pj_w, nr_compl_pf_tel_adic_prest_w, nr_tipo_comp_adic_prest_w), 1, 255);
						nr_fone_whatsapp_w 	:= substr(pls_obter_tel_prest( cd_pessoa_fisica_w, cd_cgc_w, 'T', ie_tipo_endereco_prest_w, nr_seq_compl_pj_w, nr_compl_pf_tel_adic_prest_w, nr_tipo_comp_adic_prest_w), 1, 255);
					end if;
										
					insert into ptu_prestador_endereco(nr_sequencia,
						nr_seq_prestador,
						ie_tipo_endereco, 
						ds_endereco,
						cd_municipio_ibge,
						cd_cep, 
						nr_telefone,
						cd_cnes,
						cd_cgc_cpf, 
						dt_atualizacao,
						nm_usuario, 
						dt_atualizacao_nrec, 
						nm_usuario_nrec,
						nr_endereco,
						ds_complemento, 
						ds_bairro,
						nr_ddd, 
						nr_telefone_dois, 
						nr_fax,
						ds_email,
						ds_endereco_web,			
						nr_leitos_totais,
						nr_leitos_contrat,
						nr_leitos_psiquiatria, 
						nr_uti_adulto, 
						nr_uti_neonatal,
						nr_uti_pediatria,
						nr_leitos_hosp_dia,
						nr_leitos_tot_clinic,
						nr_leitos_tot_cirurgico,
						nr_leitos_tot_obstr,
						nr_leitos_intermed,
						nr_leitos_tot_pediat,
						nr_leitos_tot_psiqu,
						nr_leitos_intermed_neo,
						nr_seq_prestador_end,
						nr_seq_prest_medico,
						ie_instituicao_acred_ptu,
						nr_referencia_end,
						nr_latitude,
						nr_longitude,
						ie_tipo_endereco_original,
						nr_seq_compl_pf_tel_adic,
						nr_seq_compl_pj,
						nr_seq_tipo_compl_adic,
						ds_email_sec,
						ie_prest_acred,
						nr_seq_prest_end,
						nr_ddd_fone_whatsapp,
						nr_fone_whatsapp)
					values (nextval('ptu_prestador_endereco_seq'), 
						nr_seq_prestador_p, 
						coalesce(ie_tipo_endereco_ptu_w,1),
						coalesce(ds_endereco_w,' '),
						cd_municipio_ibge_w,
						coalesce(cd_cep_w,1),
						coalesce(nr_telefone_w,1), 
						coalesce(trim(both cd_cnes_w),'9999999'), 
						coalesce(nr_cpf_w,' '), 
						clock_timestamp(),
						nm_usuario_p, 
						clock_timestamp(),
						nm_usuario_p,
						coalesce(nr_endereco_w,'S/N'), 
						ds_complemento_w,
						ds_bairro_w, 
						(nr_ddd_telefone_w)::numeric , 
						(ds_fone_adic_w)::numeric ,
						(ds_fax_w)::numeric ,
						ds_email_w,
						ds_website_w,
						nr_leitos_totais_w,			
						nr_leitos_contrat_w,
						nr_leitos_psiquiat_w,
						nr_uti_adulto_w,
						nr_uti_neonatal_w,
						nr_uti_pediatra_w,
						nr_leitos_hosp_dia_w,
						nr_leitos_tot_clinic_w,
						nr_leitos_tot_cirurgico_w,
						nr_leitos_tot_obstr_w,
						nr_leitos_intermed_w,
						nr_leitos_tot_pediat_w,
						nr_leitos_tot_psiqu_w,
						nr_leitos_intermed_neo_w,
						nr_seq_prestador_w,
						nr_seq_prest_medico_w,
						ie_instituicao_acred_ptu_w,
						nr_referencia_end_w,
						nr_latitude_w,
						nr_longitude_w,
						ie_tipo_endereco_w,
						nr_seq_compl_pf_tel_ad_prest_w,
						null,
						nr_seq_tipo_compl_adic_prest_w,
						ds_email_sec_w,
						ie_prest_acred_w,
						nr_seq_prest_end_w,
						nr_ddd_fone_whatsapp_w,
						nr_fone_whatsapp_w) returning nr_sequencia into nr_seq_endereco_w;
						
					CALL ptu_gerar_prestador_grupo_serv(nr_seq_endereco_w,nm_usuario_p);
				end if;
				
				cd_cnes_ant_w	:= cd_cnes_w;
				end;
			end loop;
			close C01;
		end if;

		if (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') then			
			open C02;
			loop
			fetch C02 into
				ds_endereco_w,
				nr_endereco_w,
				ds_complemento_w,
				ds_bairro_w,
				cd_municipio_ibge_w,
				cd_cep_w,
				nr_ddd_telefone_w,
				nr_telefone_w,
				ds_fax_w,
				ds_fone_adic_w,
				ds_website_w,
				cd_cnes_w,
				ds_email_w,
				nr_seq_compl_pj_prest_w,
				ds_email_sec_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin
				nr_cpf_w := null;				
				if (coalesce(cd_cnes_w::text, '') = '') then
					cd_cnes_w	:= cd_cnes_prest_w;
					
					if (substr(cd_cnes_ant_w,1,7) = substr(cd_cnes_w,1,7)) then
						cd_cnes_w := null;
					end if;
				end if;

				if (nr_ddd_telefone_w = 0) then
					nr_ddd_telefone_w	:= null;
				end if;
				
				if (ie_filial_w = 'N') and (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
					nr_cpf_w := obter_cpf_pessoa_fisica(cd_pessoa_fisica_p);
				end if;
				
				select	count(1)
				into STRICT	count_w
				from	ptu_prestador_endereco
				where	nr_seq_prestador	= nr_seq_prestador_p
				and	cd_cnes			= substr(cd_cnes_w, 1, 7)
				and	substr(cd_cnes_w, 1, 7) <> '9999999';
				
				if	((coalesce(cd_cnes_ant_w, 0) != cd_cnes_w) or (coalesce(cd_cnes_w, '9999999') = '9999999')) and (count_w = 0) then
					if (length(cd_cnes_w) > 7) then
						CALL ptu_gravar_inconsist_prestador(nr_seq_prestador_p,56,nm_usuario_p);
						cd_cnes_w	:= substr(cd_cnes_w,1,7);
					end if;
					
					if (coalesce(ds_email_w::text, '') = '') and (ie_divulga_email_w = 'S') then
						select	substr(max(ds_email),1,80)
						into STRICT	ds_email_w
						from	pessoa_juridica_estab
						where	cd_cgc	= cd_cgc_w
						and	cd_estabelecimento = cd_estabelecimento_w;
					end if;	

					if (ie_divulga_email_w = 'N') then
						ds_email_w	:= null;
						ds_email_sec_w	:= null;
					end if;
					
					if (ie_divulga_site_w = 'N') then
						ds_website_w := null;
					end if;
					
					ie_prest_acred_w := 'S';
					if (ie_tipo_prestador_w in (1,5,7)) or (coalesce(ie_instituicao_acred_ptu_w::text, '') = '') then
						ie_prest_acred_w := 'N';
					end if;
					
					ds_endereco_w := ptu_somente_caracter_permitido(ds_endereco_w,'ANS+'); -- 27/05/2019 gfurlan OS 1901279: Alterado parametro ANS+ para ANS, removendo acentos do endereco
					
					if (ie_fone_whats_guia_medico_w = 'S') and ( coalesce(nr_ddd_fone_whatsapp_w::text, '') = '') and (coalesce(nr_fone_whatsapp_w::text, '') = '') then
						
						select 	ie_tipo_endereco,
							nr_seq_compl_pf_tel_adic,
							nr_seq_tipo_compl_adic
						into STRICT	ie_tipo_endereco_prest_w,
							nr_compl_pf_tel_adic_prest_w,
							nr_tipo_comp_adic_prest_w
						from	pls_prestador
						where 	nr_sequencia = nr_seq_prestador_w;
						
						nr_ddd_fone_whatsapp_w 	:= substr(pls_obter_tel_prest( cd_pessoa_fisica_w, cd_cgc_w, 'DDT', ie_tipo_endereco_prest_w, nr_seq_compl_pj_w, nr_compl_pf_tel_adic_prest_w, nr_tipo_comp_adic_prest_w), 1, 255);
						nr_fone_whatsapp_w 	:= substr(pls_obter_tel_prest( cd_pessoa_fisica_w, cd_cgc_w, 'T', ie_tipo_endereco_prest_w, nr_seq_compl_pj_w, nr_compl_pf_tel_adic_prest_w, nr_tipo_comp_adic_prest_w), 1, 255);
					end if;

					insert into ptu_prestador_endereco(nr_sequencia,
						nr_seq_prestador,
						ie_tipo_endereco, 
						ds_endereco, 
						cd_municipio_ibge, 
						cd_cep,
						nr_ddd,			
						nr_telefone,
						cd_cnes, 
						cd_cgc_cpf, 
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec, 
						nm_usuario_nrec, 
						nr_endereco, 
						ds_complemento, 
						ds_bairro, 
						nr_telefone_dois, 
						nr_fax, 
						ds_email, 
						ds_endereco_web, 
						nr_leitos_totais, 
						nr_leitos_contrat, 
						nr_leitos_psiquiatria, 
						nr_uti_adulto,
						nr_uti_neonatal, 
						nr_uti_pediatria,
						nr_leitos_hosp_dia,
						nr_leitos_tot_clinic,
						nr_leitos_tot_cirurgico,
						nr_leitos_tot_obstr,
						nr_leitos_intermed,
						nr_leitos_tot_pediat,
						nr_leitos_tot_psiqu,
						nr_leitos_intermed_neo,
						nr_seq_prestador_end,
						nr_seq_prest_medico,
						ie_instituicao_acred_ptu,
						nr_referencia_end,
						nr_latitude,
						nr_longitude,
						ie_tipo_endereco_original,
						nr_seq_compl_pf_tel_adic,
						nr_seq_compl_pj,
						nr_seq_tipo_compl_adic,
						ds_email_sec,
						ie_prest_acred,
						nr_seq_prest_end,
						nr_ddd_fone_whatsapp,
						nr_fone_whatsapp
						)
					values (nextval('ptu_prestador_endereco_seq'),
						nr_seq_prestador_p, 
						coalesce(ie_tipo_endereco_ptu_w,1),
						coalesce(ds_endereco_w,' '),
						cd_municipio_ibge_w,
						coalesce(cd_cep_w,1), 
						(nr_ddd_telefone_w)::numeric ,
						coalesce(nr_telefone_w,1), 
						coalesce(trim(both cd_cnes_w),'9999999'), 
						coalesce(coalesce(nr_cpf_w,cd_cgc_w),' '), 
						clock_timestamp(), 
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						coalesce(nr_endereco_w,'S/N'), 
						ds_complemento_w,
						ds_bairro_w,
						(ds_fone_adic_w)::numeric ,
						(ds_fax_w)::numeric ,
						ds_email_w,
						ds_website_w,
						nr_leitos_totais_w,			
						nr_leitos_contrat_w,
						nr_leitos_psiquiat_w,
						nr_uti_adulto_w,
						nr_uti_neonatal_w,
						nr_uti_pediatra_w,
						nr_leitos_hosp_dia_w,
						nr_leitos_tot_clinic_w,
						nr_leitos_tot_cirurgico_w,
						nr_leitos_tot_obstr_w,
						nr_leitos_intermed_w,
						nr_leitos_tot_pediat_w,
						nr_leitos_tot_psiqu_w,
						nr_leitos_intermed_neo_w,
						nr_seq_prestador_w,
						nr_seq_prest_medico_w,
						ie_instituicao_acred_ptu_w,
						nr_referencia_end_w,
						nr_latitude_w,
						nr_longitude_w,
						ie_tipo_endereco_w,
						null,
						nr_seq_compl_pj_prest_w,
						null,
						ds_email_sec_w,
						ie_prest_acred_w,
						nr_seq_prest_end_w,
						nr_ddd_fone_whatsapp_w,
						nr_fone_whatsapp_w) returning nr_sequencia into nr_seq_endereco_w;
						
					CALL ptu_gerar_prestador_grupo_serv(nr_seq_endereco_w,nm_usuario_p);
				end if;
				
				cd_cnes_ant_w	:= cd_cnes_w;
				end;
			end loop;
			close C02;
		end if;
		end;
	end loop;
	close C03;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_gerar_endereco_prestador ( nr_seq_prestador_p bigint, cd_pessoa_fisica_p text, cd_cgc_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

