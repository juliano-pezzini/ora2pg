-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_lote_emissao ( nr_seq_carterinha_p bigint, cd_estabelecimento_p bigint, ie_commit_p text, nm_usuario_p text) AS $body$
DECLARE


ie_situacao_w			varchar(1);
nr_seq_lote_w			bigint;
ie_controle_carteira_w		varchar(1);
qt_cart_provisorias_w		bigint;
ie_tipo_segurado_w		varchar(10);
nr_seq_tipo_lote_w		bigint;
ie_agrupar_lote_w		varchar(10);
nr_seq_segurado_w		bigint;
nr_seq_contrato_w		bigint;
nr_contrato_w			bigint;
ie_usuario_solic_w		varchar(10);
ie_restringir_tipo_benef_w	varchar(10);
ie_tipo_contrato_w		varchar(10);
ie_emissao_cart_repasse_pre_w	varchar(1);
ie_gerar_emissao_w		varchar(1);
ie_tipo_repasse_w		varchar(1);
nr_seq_cart_emis_w		bigint;
nm_usuario_solic_w 		pls_segurado_carteira.nm_usuario_solicitante%type;
dt_solicitacao_w			pls_segurado_carteira.dt_solicitacao%type;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_lote_carteira
	where	ie_situacao	= 'G'
	and	ie_tipo_lote	= 'E'
	and	cd_estabelecimento = cd_estabelecimento_p
	and	((ie_restringir_tipo_benef_w	= 'S')
		and	(((ie_tipo_beneficiario IS NOT NULL AND ie_tipo_beneficiario::text <> '') and ie_tipo_beneficiario = ie_tipo_segurado_w) or
			(((ie_tipo_beneficiario IS NOT NULL AND ie_tipo_beneficiario::text <> '') and ie_tipo_beneficiario = 'R' and ie_tipo_segurado_w = 'R') or (coalesce(ie_tipo_beneficiario::text, '') = '')))
			and	((ie_tipo_contrato <> 'I')
			or (coalesce(ie_tipo_contrato::text, '') = '')) or (ie_restringir_tipo_benef_w	= 'N'))
	and	((ie_agrupar_lote_w = 'N' and nr_seq_tipo_lote = nr_seq_tipo_lote_w and (nr_seq_tipo_lote IS NOT NULL AND nr_seq_tipo_lote::text <> '')
		and (nr_contrato = nr_contrato_w and (nr_contrato_w IS NOT NULL AND nr_contrato_w::text <> '')))
		or (ie_agrupar_lote_w = 'S' and coalesce(nr_seq_tipo_lote::text, '') = ''))
	and	coalesce(nr_seq_lote_vencimento::text, '') = ''
	and	((nm_usuario_solicitante = nm_usuario_p and (nm_usuario_solicitante IS NOT NULL AND nm_usuario_solicitante::text <> '')) or (coalesce(nm_usuario_solicitante::text, '') = ''))
	and	((coalesce(ie_tipo_pessoa,'A') = ie_tipo_contrato_w) or (coalesce(ie_tipo_pessoa,'A') = 'A'))
	order by
		coalesce(ie_tipo_pessoa, 'A'),
		CASE WHEN coalesce(ie_tipo_beneficiario::text, '') = '' THEN -1  ELSE 1 END;


BEGIN

ie_gerar_emissao_w	:= 'S';
begin
nr_seq_tipo_lote_w	:= coalesce(obter_valor_param_usuario(1226, 4, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_p), null);
exception
when others then
	nr_seq_tipo_lote_w	:= null;
end;

ie_usuario_solic_w		:= coalesce(obter_valor_param_usuario(1226, 6, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_p), 'N');
ie_restringir_tipo_benef_w	:= coalesce(obter_valor_param_usuario(1202, 106, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_p), 'S');

select	max(ie_emissao_cart_repasse_pre)
into STRICT	ie_emissao_cart_repasse_pre_w
from	pls_parametros
where	cd_estabelecimento	= cd_estabelecimento_p;
ie_emissao_cart_repasse_pre_w	:= coalesce(ie_emissao_cart_repasse_pre_w,'N');

select	b.ie_tipo_segurado,
	b.nr_sequencia,
	b.nr_seq_contrato
into STRICT	ie_tipo_segurado_w,
	nr_seq_segurado_w,
	nr_seq_contrato_w
from	pls_segurado		b,
	pls_segurado_carteira	a
where	a.nr_seq_segurado	= b.nr_sequencia
and	a.nr_sequencia		= nr_seq_carterinha_p;

if	(ie_emissao_cart_repasse_pre_w = 'S' AND ie_tipo_segurado_w = 'R') then
	select	max(ie_tipo_repasse)
	into STRICT	ie_tipo_repasse_w
	from	pls_segurado_repasse
	where	nr_seq_segurado	= nr_seq_segurado_w
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	coalesce(dt_fim_repasse::text, '') = '';
	
	if (ie_tipo_repasse_w = 'P') then
		ie_gerar_emissao_w	:= 'N';
	end if;
end if;

if (ie_gerar_emissao_w = 'S') then
	select	max(b.nr_sequencia)
	into STRICT	nr_seq_lote_w
	from	pls_lote_carteira	b,
		pls_carteira_emissao	a
	where	b.ie_situacao		in ('P','G')
	and	b.ie_tipo_lote		= 'E'
	and	a.nr_seq_lote		= b.nr_sequencia
	and	a.nr_seq_seg_carteira	= nr_seq_carterinha_p
	and	cd_estabelecimento 	= cd_estabelecimento_p;
	
	if (nr_seq_lote_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(183144,'NR_SEQ_CARTEIRA='||nr_seq_carterinha_p||';'||'NR_SEQ_LOTE='||nr_seq_lote_w);
	end if;
	
	select	count(*)
	into STRICT	qt_cart_provisorias_w
	from	pls_segurado_carteira
	where	ie_situacao		= 'D'
	and	nr_sequencia		= nr_seq_carterinha_p;
	
	if (qt_cart_provisorias_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(183143,'');
	end if;
	
	if (nr_seq_tipo_lote_w IS NOT NULL AND nr_seq_tipo_lote_w::text <> '') then
		select	ie_agrupar_lote
		into STRICT	ie_agrupar_lote_w
		from	pls_tipo_lote_carteira
		where	nr_sequencia	= nr_seq_tipo_lote_w
		and	ie_situacao	= 'A';
	else
		ie_agrupar_lote_w	:= 'S';
	end if;
	
	if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then
		select	nr_contrato,
			CASE WHEN coalesce(cd_cgc_estipulante::text, '') = '' THEN 'PF'  ELSE 'PJ' END
		into STRICT	nr_contrato_w,
			ie_tipo_contrato_w
		from	pls_contrato
		where	nr_sequencia	= nr_seq_contrato_w;
	end if;

	open C01;
	loop
	fetch C01 into	
		nr_seq_lote_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	end loop;
	close C01;
	
	if (coalesce(nr_seq_lote_w::text, '') = '') then
		select	nextval('pls_lote_carteira_seq')
		into STRICT	nr_seq_lote_w
		;
		
		if (coalesce(nr_seq_tipo_lote_w::text, '') = '') then
			nr_contrato_w		:= null;
		end if;
		
		insert	into	pls_lote_carteira(nr_sequencia, cd_estabelecimento, dt_atualizacao,
			nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
			dt_referencia_venc, ie_situacao, ie_tipo_lote,
			nr_seq_lote_vencimento,ie_tipo_contrato,ie_tipo_beneficiario,
			nr_seq_tipo_lote,nr_contrato,
			ie_tipo_data,ie_situacao_atend,ie_tipo_pessoa,nm_usuario_solicitante)
		values (	nr_seq_lote_w, cd_estabelecimento_p, clock_timestamp(),
			nm_usuario_p, clock_timestamp(), nm_usuario_p,
			null, 'G', 'E',
			null,'O',CASE WHEN ie_restringir_tipo_benef_w='S' THEN ie_tipo_segurado_w  ELSE '' END ,
			nr_seq_tipo_lote_w,nr_contrato_w,
			'N','T','A',CASE WHEN ie_usuario_solic_w='N' THEN ''  ELSE nm_usuario_p END );
	end if;
	
	select	coalesce(max(a.ie_controle_carteira), 'A')
	into STRICT	ie_controle_carteira_w
	from	pls_contrato 		a,
		pls_segurado 		b,
		pls_segurado_carteira	c
	where	a.nr_sequencia	= b.nr_seq_contrato
	and	b.nr_sequencia	= c.nr_seq_segurado
	and	c.nr_sequencia	= nr_seq_carterinha_p;
	
	if (ie_controle_carteira_w in ('A','E')) then
		select 	dt_solicitacao,
				 		nm_usuario_solicitante
		into STRICT   	dt_solicitacao_w,
						nm_usuario_solic_w
		from   	pls_segurado_carteira
		where  	nr_sequencia = nr_seq_carterinha_p;

		select	nextval('pls_carteira_emissao_seq')
		into STRICT	nr_seq_cart_emis_w
		;
		
		insert	into	pls_carteira_emissao(nr_sequencia, dt_atualizacao, nm_usuario,
			dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_lote,
			nr_seq_seg_carteira, dt_recebimento, ie_situacao, dt_solicitacao, nm_usuario_solic)
		values (	nr_seq_cart_emis_w, clock_timestamp(), nm_usuario_p,
			clock_timestamp(), nm_usuario_p, nr_seq_lote_w,
			nr_seq_carterinha_p, null, 'P', dt_solicitacao_w, nm_usuario_solic_w);
		
		update 	pls_segurado_carteira
		set	nr_seq_lote_emissao	= nr_seq_lote_w
		where	nr_sequencia		= nr_seq_carterinha_p;
		
		CALL pls_atualizar_campos_cart_emis(nr_seq_cart_emis_w, nr_seq_carterinha_p, nm_usuario_p);
		CALL pls_alterar_estagios_cartao(nr_seq_carterinha_p, clock_timestamp(), '2', cd_estabelecimento_p, nm_usuario_p);
	end if;
end if;

if (ie_commit_p	= 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_lote_emissao ( nr_seq_carterinha_p bigint, cd_estabelecimento_p bigint, ie_commit_p text, nm_usuario_p text) FROM PUBLIC;

