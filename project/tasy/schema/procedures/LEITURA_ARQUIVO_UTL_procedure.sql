-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE leitura_arquivo_utl ( cd_evento_p bigint, nm_arquivo_p pls_linhas_arquivo.nm_arquivo%type, cd_funcao_p pls_linhas_arquivo.cd_funcao%type, nm_usuario_p pls_linhas_arquivo.nm_usuario%type) AS $body$
DECLARE


-- Variaveis
ds_conteudo_w  varchar(4000);
ie_leitura_w  boolean := true;
ds_arquivo_w     text := '';
contador_w          bigint := 0;


BEGIN
-- Abre UTL FiLE pra leitura
CALL pls_utl_file_pck.nova_leitura(cd_evento_p, nm_arquivo_p);

delete from pls_linhas_arquivo where nm_arquivo = nm_arquivo_p and cd_funcao = cd_funcao_p and nm_usuario = nm_usuario_p;

-- Abre UTL FiLE pra leitura
while(ie_leitura_w) loop
 contador_w := contador_w + 1;
 ds_conteudo_w := '';
 -- Ler a linha do arquivo
 SELECT * FROM pls_utl_file_pck.ler(ds_conteudo_w, ie_leitura_w) INTO STRICT ds_conteudo_w, ie_leitura_w;

	 insert into pls_linhas_arquivo(
	   cd_funcao,
	   nm_arquivo,
	   nm_usuario,
	   ds_linha,
	   nr_linha)
	 values (cd_funcao_p, nm_arquivo_p, nm_usuario_p, ds_conteudo_w, contador_w);

end loop;
commit;

-- Fecha o arquivo antes de sair da rotina
CALL pls_utl_file_pck.fechar_arquivo();

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE leitura_arquivo_utl ( cd_evento_p bigint, nm_arquivo_p pls_linhas_arquivo.nm_arquivo%type, cd_funcao_p pls_linhas_arquivo.cd_funcao%type, nm_usuario_p pls_linhas_arquivo.nm_usuario%type) FROM PUBLIC;

