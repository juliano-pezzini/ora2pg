-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicar_exame_padrao (nr_seq_grupo_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_grupo_w			bigint;
nr_seq_exame_w			bigint;
nr_seq_exame_ori_w		bigint;
cd_item_w				varchar(3);
ds_item_w				varchar(50);

C01 CURSOR FOR
	SELECT	*
	from	med_exame_padrao
	where	coalesce(cd_medico::text, '') = ''
	and	nr_seq_grupo = nr_seq_grupo_p
	order by nr_sequencia;

C02 CURSOR FOR
	SELECT	cd_item,
		ds_item
	from	med_item_result_exame
	where	nr_seq_exame = nr_seq_exame_ori_w
	order by cd_item;

Cw01	C01%RowType;


BEGIN

select	nextval('med_grupo_exame_seq')
into STRICT	nr_seq_grupo_w
;

Insert into med_grupo_exame(
	nr_sequencia,
	ds_grupo_exame,
	cd_estabelecimento,
	dt_atualizacao,
	nm_usuario,
	nr_seq_apresent,
	DT_ATUALIZACAO_NREC,
	NM_USUARIO_NREC)
SELECT	nr_seq_grupo_w,
	ds_grupo_exame||obter_desc_expressao(303214)/*' (CÃ³pia)'*/
,
	cd_estabelecimento,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_apresent,
	clock_timestamp(),
	nm_usuario_p
from	med_grupo_exame
where	nr_sequencia	= nr_seq_grupo_p;

open C01;
loop
fetch   C01 into
		Cw01;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	select	nextval('med_exame_padrao_seq')
	into STRICT	nr_seq_exame_w
	;


	Insert into med_exame_padrao(
		nr_sequencia	    ,
		IE_PEDIDO   	    ,
		IE_RESULTADO        ,
		DT_ATUALIZACAO      ,
		NM_USUARIO          ,
		CD_PROCEDIMENTO     ,
		IE_ORIGEM_PROCED    ,
		DS_EXAME            ,
		DS_GRUPO            ,
		CD_ESTABELECIMENTO  ,
		IE_FORMATO_RESULTADO,
		QT_DECIMAIS         ,
		IE_PADRAO           ,
		CD_EXAME_SIST_ORIG  ,
		NR_SEQ_APRESENT     ,
		NR_SEQ_GRUPO        ,
		VL_PADRAO_MINIMO    ,
		VL_PADRAO_MAXIMO    ,
		DS_UNIDADE          ,
		DS_CALCULO          ,
		DS_REST_CALCULO     ,
		DT_ATUALIZACAO_NREC ,
		NM_USUARIO_NREC     ,
		ie_lado   	    ,
		DS_REDUZIDA_EXAME,
		NR_PROC_INTERNO,
		IE_SITUACAO)
	Values (	nr_seq_exame_w,
		Cw01.IE_PEDIDO   	 ,
		Cw01.IE_RESULTADO        ,
		clock_timestamp()			 ,
		NM_USUARIO_p        	 ,
		Cw01.CD_PROCEDIMENTO     ,
		Cw01.IE_ORIGEM_PROCED    ,
		Cw01.DS_EXAME            ,
		Cw01.DS_GRUPO            ,
		Cw01.CD_ESTABELECIMENTO  ,
		Cw01.IE_FORMATO_RESULTADO,
		Cw01.QT_DECIMAIS         ,
		Cw01.IE_PADRAO           ,
		Cw01.CD_EXAME_SIST_ORIG  ,
		Cw01.NR_SEQ_APRESENT     ,
		NR_SEQ_GRUPO_w      	 ,
		Cw01.VL_PADRAO_MINIMO    ,
		Cw01.VL_PADRAO_MAXIMO    ,
		Cw01.DS_UNIDADE          ,
		Cw01.DS_CALCULO          ,
		Cw01.DS_REST_CALCULO     ,
		clock_timestamp() 	      	 ,
		nm_usuario_p	      	 ,
		Cw01.ie_lado		 ,
		Cw01.DS_REDUZIDA_EXAME,
		Cw01.NR_PROC_INTERNO,
		coalesce(Cw01.IE_SITUACAO,'A'));

	commit;

	nr_seq_exame_ori_w	:= Cw01.nr_sequencia;

	open C02;
	loop
	fetch C02 into
		cd_item_w,
		ds_item_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		Insert into med_item_result_exame(
			nr_sequencia,
			nr_seq_exame,
			cd_item,
			ds_item,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec
			)
		Values (nextval('med_item_result_exame_seq'),
			nr_seq_exame_w,
			cd_item_w,
			ds_item_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p);
		end;
	end loop;
	close C02;
	end;
end loop;
close C01;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_exame_padrao (nr_seq_grupo_p bigint, nm_usuario_p text) FROM PUBLIC;

