-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_confirmar_envio ( nr_seq_protocolo_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nm_prestador_w			varchar(255);
ds_hash_w			varchar(255);
nr_protocolo_prestador_w	varchar(20);
ie_tipo_guia_w			varchar(10);
ie_origem_protocolo_w		varchar(10);
ie_fechado_w			varchar(1);
vl_parametro_w			varchar(1)	:= 'N';
vl_apresentado_w		double precision;
nr_seq_conta_w			bigint;
nr_seq_transacao_w		varchar(12);
nr_seq_prestador_imp_w		bigint;
nr_seq_regra_periodo_w		bigint;
nr_seq_periodo_w		bigint;
nr_seq_lote_conta_w		bigint;
cd_perfil_comunic_w		integer;
qt_registro_w			integer	:= 0;
dt_mes_competencia_w		timestamp;
dt_protocolo_w			timestamp;
dt_recebimento_w		timestamp;
dt_aceite_w			timestamp;
cd_cgc_prestador_imp_w		pls_protocolo_conta.cd_cgc_prestador_imp%type;
nr_seq_prestador_imp_aux_w	pls_protocolo_conta.nr_seq_prestador%type;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_conta
	where	nr_seq_protocolo	= nr_seq_protocolo_p;


BEGIN
/* Obter dados do protocolo */

select	pls_obter_prestador_imp(cd_cgc_prestador_imp, nr_cpf_prestador_imp, nr_seq_prestador_imp, '', '', '', 'C', null, dt_protocolo) nr_seq_prestador,
	dt_mes_competencia,
	nr_protocolo_prestador,
	coalesce(pls_obter_valor_protocolo(nr_sequencia,'TC'),0),
	nr_seq_transacao,
	ds_hash,
	ie_tipo_guia,
	ie_origem_protocolo,
	nr_seq_lote_conta,
	dt_protocolo,
	dt_recebimento,
	cd_cgc_prestador_imp
into STRICT	nr_seq_prestador_imp_w,
	dt_mes_competencia_w,
	nr_protocolo_prestador_w,
	vl_apresentado_w,
	nr_seq_transacao_w,
	ds_hash_w,
	ie_tipo_guia_w,
	ie_origem_protocolo_w,
	nr_seq_lote_conta_w,
	dt_protocolo_w,
	dt_recebimento_w,
	cd_cgc_prestador_imp_w
from	pls_protocolo_conta
where	nr_sequencia	= nr_seq_protocolo_p;

if (cd_cgc_prestador_imp_w IS NOT NULL AND cd_cgc_prestador_imp_w::text <> '') then
	nr_seq_prestador_imp_aux_w	:= pls_obter_prestador_cgc(	cd_cgc_prestador_imp_w,null);

	if (nr_seq_prestador_imp_aux_w IS NOT NULL AND nr_seq_prestador_imp_aux_w::text <> '') then
		nr_seq_prestador_imp_w	:= nr_seq_prestador_imp_aux_w;
	end if;
end if;
begin
select	coalesce(max(a.dt_aceite),clock_timestamp())
into STRICT	dt_aceite_w
from	ptu_fatura	a
where	a.nr_seq_protocolo	= nr_seq_protocolo_p;
exception
when others then
	dt_aceite_w	:= clock_timestamp();
end;

nm_prestador_w	:= substr(pls_obter_dados_prestador(nr_seq_prestador_imp_w,'N'),1,255);

/*Leitura do paramêtro [29] - Consistir duplicidade de protocolos importados através do TISS */

vl_parametro_w := Obter_Param_Usuario(1208, 29, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, vl_parametro_w);

if (coalesce(vl_parametro_w,'N')	= 'S') then
	select	count(1)
	into STRICT	qt_registro_w
	from	pls_protocolo_conta
	where	nr_protocolo_prestador	= nr_protocolo_prestador_w
	and	nr_seq_prestador	= nr_seq_prestador_imp_w
	and	ie_tipo_guia		= ie_tipo_guia_w
	and	nr_sequencia		<> nr_seq_protocolo_p
	and	ie_situacao not in ('I', 'A', 'RE');

	if (qt_registro_w	> 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(183003);
		--(-20011,'Já existe um protocolo desse prestador com o mesmo número de lote integrado no sistema! #@#@');
	end if;
end if;
/* Felipe - 10/04/2008 - OS 87447 - Fiz o tratamento conforme solicitação da OS e alterei o UPDATE do campo DT_MES_COMPETENCIA  de sysdate para a variável do tratamento*/

dt_mes_competencia_w	:= pls_obter_dataref_prot_imp(	nr_seq_prestador_imp_w, ie_origem_protocolo_w, dt_mes_competencia_w,
							dt_protocolo_w, dt_recebimento_w, dt_aceite_w,
							ie_tipo_guia_w,nr_seq_protocolo_p, cd_estabelecimento_p);

select	pls_obter_se_mes_fechado(dt_mes_competencia_w,'T',cd_estabelecimento_p)
into STRICT	ie_fechado_w
;

if (ie_fechado_w = 'S') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(183006);
	--(-20011,'Não é possível realizar esta operação pois o mês de competência ou a contabilidade do mês está fechada!');
end if;

SELECT * FROM pls_obter_periodo_pgto(nr_seq_prestador_imp_w, dt_mes_competencia_w, ie_tipo_guia_w, nr_seq_regra_periodo_w, nr_seq_periodo_w) INTO STRICT nr_seq_regra_periodo_w, nr_seq_periodo_w;

update	pls_protocolo_conta
set	ie_situacao		= 'T',
	dt_integracao		= clock_timestamp(),
	nm_usuario_integracao	= nm_usuario_p,
	dt_mes_competencia	= dt_mes_competencia_w,
	nr_seq_prestador	= nr_seq_prestador_imp_w,
	cd_condicao_pagamento	= pls_obter_dados_prestador(nr_seq_prestador_imp_w,'CP'),
	dt_base_venc		= clock_timestamp(),
	nr_seq_periodo_pgto	= nr_seq_periodo_w
where	nr_sequencia		= nr_seq_protocolo_p
and	cd_estabelecimento	= cd_estabelecimento_p;

open C01;
loop
fetch C01 into
	nr_seq_conta_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	CALL pls_consistir_conta(nr_seq_conta_w, cd_estabelecimento_p, nm_usuario_p,'N',null,null,null,'S');

	CALL pls_fechar_conta(nr_seq_conta_w, 'N', 'N', 'S', cd_estabelecimento_p, nm_usuario_p,null,null);
	end;
end loop;
close C01;

update	pls_lote_protocolo_conta
set	dt_geracao_analise	= clock_timestamp()
where	nr_sequencia		= nr_seq_lote_conta_w;

CALL pls_gerar_comunic_conta(1,
	'Protocolo: ' || to_char(nr_seq_protocolo_p) || chr(13) ||
	'Nº do protocolo no prestador: ' || nr_protocolo_prestador_w || chr(13) ||
	'Data integração: ' || to_char(clock_timestamp(),'dd/mm/yyyy hh24:mi:ss') || chr(13) ||
	'Usuário integração: ' || nm_usuario_p || chr(13) ||
	'Prestador: ' || to_char(nr_seq_prestador_imp_w) || ' - ' || nm_prestador_w || chr(13) ||
	'Valor apresentado: ' || to_char(vl_apresentado_w) || chr(13) ||
	'Transação TISS: ' || nr_seq_transacao_w || chr(13) ||
	'Hash: ' || ds_hash_w,
	nm_usuario_p,cd_estabelecimento_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_confirmar_envio ( nr_seq_protocolo_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

