-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cp_generate_summary_nur ( nr_seq_prescr_p bigint, nm_usuario_p text, si_measures_result_p text DEFAULT 'N', si_dates_p text DEFAULT 'N', si_rtf_p text DEFAULT 'Y') AS $body$
DECLARE

  nr_seq_patient_cp_summary_w patient_cp_summary.nr_sequencia%TYPE;
  saida_w patient_cp_summary.ds_summary%TYPE;
  newline_w                  varchar(100) := CHR(13) || CHR(10);
  space_n1_w                 varchar(100) := '      ';
  space_n2_w                 varchar(100) := '            ';
  space_n3_w                 varchar(100) := '                  ';
  space_n4_w                 varchar(100) := '                        ';
  ds_fonte_w                 varchar(100);
  ds_tam_fonte_w             varchar(100);
  nr_tam_fonte_w             integer;
  cd_perfil_ativo_w          bigint;
  cd_estabelecimento_ativo_w smallint;
  ds_cabecalho_w             varchar(32000);
  ds_rodape_w                varchar(255);
  ds_conteudo_w              varchar(32000);
  ds_data_ini_fim_w          varchar(4000);
  si_clinical_note_w         char(1) := 'Y';
  nr_seq_prescr_diag_w pe_prescr_diag.nr_sequencia%TYPE;
  nr_seq_pat_cp_interv_plan_w patient_cp_interv_plan.nr_sequencia%TYPE;
  nr_seq_pat_cp_goal_w patient_cp_goal.nr_sequencia%TYPE;
  si_measures_result_w varchar(1);
  si_dates_w           varchar(1);
  si_rtf_w             varchar(1);
  nr_seq_evid_w pe_prescr_item_result.nr_sequencia%TYPE;
  nr_seq_fator1_w pe_diag_fat_rel.nr_seq_diag%TYPE;
  nr_seq_fator2_w pe_prescr_diag.nr_sequencia%TYPE;
  fator_w char(1) := 'N';
  -- ===== diagnostico =====
  c02 CURSOR FOR
    SELECT A.*,
      ds_diagnostico ds_display_name
    FROM pe_diagnostico b,
      pe_prescr_diag A
    WHERE A.nr_seq_diag = b.nr_sequencia
    AND A.nr_seq_prescr = nr_seq_prescr_p
    ORDER BY ds_diagnostico ASC;
  -- ===== diagnostico/evidencia =====
  c_diag_evid CURSOR FOR
    SELECT *
    FROM pe_prescr_item_result_diag
    WHERE nr_seq_diag = nr_seq_prescr_diag_w;
  -- ===== evidencias =====
  c_evid CURSOR FOR
    SELECT A.nr_seq_item,
      A.nr_seq_result,
      b.ds_item,
      C.ds_resultado
    FROM pe_prescr_item_result A,
      pe_item_examinar b,
      pe_item_resultado C
    WHERE A.nr_sequencia = nr_seq_evid_w
    AND b.nr_sequencia   = A.nr_seq_item
    AND C.nr_sequencia   = A.nr_seq_result
    ORDER BY 3;
  -- ===== fatores relacionados =====
  c_fator_item CURSOR FOR
    SELECT A.nr_seq_fat_rel,
      D.ds_fator_relac ds
    FROM pe_diag_fat_rel A,
      pe_cad_fator_relac D
    WHERE A.nr_seq_diag = nr_seq_fator1_w  -- c_fator.nr_seq_diag
    AND D.nr_sequencia  = A.nr_seq_fat_rel
    AND 1               =
      (SELECT 1
      FROM pe_prescr_diag_fat_rel X
      WHERE X.nr_seq_fat_rel = A.nr_seq_fat_rel
      AND X.nr_seq_diag      = nr_seq_fator2_w
      ) -- c_fator.nr_sequencia
  ORDER BY ds;
  -- ===== fatores de risco =====
  c_fator_r_item CURSOR FOR
    SELECT A.nr_seq_fat_ris,
      D.ds_fator_risco ds
    FROM pe_diag_fat_ris A,
      pe_cad_fator_risco D
    WHERE A.nr_seq_diag = nr_seq_fator1_w  --nr_seq_diag
    AND D.nr_sequencia  = A.nr_seq_fat_ris
    AND 1               =
      (SELECT 1
      FROM pe_prescr_diag_fat_ris X
      WHERE X.nr_seq_fat_ris = A.nr_seq_fat_ris
      AND X.nr_seq_diag      = nr_seq_fator2_w
      ) --nr_sequencia
  ORDER BY ds;
  -- ===== plano intervencao =====
  c03 CURSOR FOR
    SELECT A.*,
      b.ds_display_name ds_display_name
    FROM cp_diag_interv_plan b,
      patient_cp_interv_plan A
    WHERE b.nr_sequencia     = A.nr_seq_int_pla_diag
    AND A.nr_seq_prescr_diag = nr_seq_prescr_diag_w
    AND A.si_selected        = 'Y'
    ORDER BY b.ds_display_name ASC;
  /* ===== intervencoes ===== */

  c04 CURSOR FOR
    SELECT coalesce(b.ds_alternative, b.ds_display_name) ds_display_name
    FROM cp_intervention b,
      patient_cp_intervention A
    WHERE b.nr_sequencia            = A.nr_seq_cp_intervention
    AND A.nr_seq_pat_cp_interv_plan = nr_seq_pat_cp_interv_plan_w
    AND A.si_selected               = 'Y'
    ORDER BY coalesce(b.ds_alternative, b.ds_display_name) ASC;
  /* ===== meta clinica ===== */

  c05 CURSOR FOR
    SELECT A.*,
      coalesce(b.ds_alternative, b.ds_display_name) ds_display_name
    FROM cp_goal b,
      patient_cp_goal A
    WHERE b.nr_sequencia     = A.nr_seq_cp_goal
    AND A.nr_seq_prescr_diag = nr_seq_prescr_diag_w
    AND A.si_selected        = 'Y'
    ORDER BY coalesce(b.ds_alternative, b.ds_display_name) ASC;
  /* ====== indicadores ====== */

  c06 CURSOR FOR
    SELECT A.*,
      coalesce(b.ds_alternative, b.ds_display_name) ds_display_name,
      obter_dados_mensuracao_atual(A.nr_seq_cp_indicator, nr_seq_prescr_p, 'DSM') ds_cp_measure
    FROM cp_indicator b,
      patient_cp_indicator A
    WHERE b.nr_sequencia     = A.nr_seq_cp_indicator
    AND A.nr_seq_pat_cp_goal = nr_seq_pat_cp_goal_w
    AND A.si_selected        = 'Y'
    ORDER BY coalesce(b.ds_alternative, b.ds_display_name) ASC;
BEGIN
  si_measures_result_w       := coalesce(si_measures_result_p,'N');
  si_dates_w                 := coalesce(si_dates_p,'N');
  si_rtf_w                   := coalesce(si_rtf_p,'Y');
  cd_perfil_ativo_w          := obter_perfil_ativo;
  cd_estabelecimento_ativo_w := obter_estabelecimento_ativo;
  ds_fonte_w := obter_param_usuario(281, 5, cd_perfil_ativo_w, nm_usuario_p, cd_perfil_ativo_w, ds_fonte_w);
  ds_tam_fonte_w := obter_param_usuario(281, 6, cd_perfil_ativo_w, nm_usuario_p, cd_perfil_ativo_w, ds_tam_fonte_w);
  nr_tam_fonte_w := somente_numero(ds_tam_fonte_w) * 2;
  FOR diagnostico                                 IN c02
  LOOP
    BEGIN
      nr_seq_prescr_diag_w := diagnostico.nr_sequencia;
      IF ( si_dates_w       = 'Y' ) THEN
        ds_data_ini_fim_w  := NULL;
        SELECT substr(newline_w
          || space_n2_w
          || obter_desc_expressao(291978, NULL)
          || ': '
          ||
          /*Inicio: */

          pkg_date_utils.start_of(diagnostico.dt_start, 'DD', NULL)
          || newline_w
          || space_n2_w
          || obter_desc_expressao(290101, NULL)
          || ': '
          ||
          /*Fim*/

          pkg_date_utils.start_of(diagnostico.dt_end, 'DD'),1,4000)
        INTO STRICT ds_data_ini_fim_w
;
      ELSE
        ds_data_ini_fim_w := '';
      END IF;
      saida_w := saida_w || '\b ' || obter_desc_expressao(287694,NULL) || ': ' || diagnostico.ds_display_name || '\b0 '
      /*Diagnostico: */

      || ds_data_ini_fim_w;
      saida_w := saida_w || newline_w;
      --------evidencias--------------
      FOR r_c_diag_evid IN c_diag_evid
      LOOP
        nr_seq_evid_w := r_c_diag_evid.nr_seq_item;
        FOR r_c_evid IN c_evid
        LOOP
          saida_w := saida_w || space_n2_w || '\u9632    ' || obter_desc_expressao(287582,NULL) || ': ' || r_c_evid.ds_item; --item
          saida_w := saida_w || newline_w;
          saida_w := saida_w || space_n3_w || '\u9632    ' || obter_desc_expressao(297817,NULL) || ': ' || r_c_evid.ds_resultado; --resultado
          saida_w := saida_w || newline_w;
        END LOOP;
      END LOOP;
      --------------------------------
      ------fatores relacionados------
      fator_w         := 'N';
      nr_seq_fator1_w := diagnostico.nr_seq_diag;
      nr_seq_fator2_w := diagnostico.nr_sequencia;
      FOR r_c_fator_item IN c_fator_item
      LOOP
        IF (fator_w = 'N') THEN
          saida_w  := saida_w || space_n2_w || '\u9632    ' || obter_desc_expressao(307595,NULL) || newline_w;
          fator_w  := 'S';
        END IF;
        saida_w := saida_w || space_n3_w || '\u9632    ' || obter_desc_expressao(289996,NULL) || ': ' || r_c_fator_item.ds; --fator item
        saida_w := saida_w || newline_w;
      END LOOP;
      ------fatores de risco------
      fator_w := 'N';
      FOR r_c_fator_r_item IN c_fator_r_item
      LOOP
        IF (fator_w = 'N') THEN
          saida_w  := saida_w || space_n2_w || '\u9632    ' || obter_desc_expressao(290020,NULL) || newline_w;
          fator_w  := 'S';
        END IF;
        saida_w := saida_w || space_n3_w || '\u9632    ' || obter_desc_expressao(289996,NULL) || ': ' || r_c_fator_r_item.ds; --fator item
        saida_w := saida_w || newline_w;
      END LOOP;
      --------------------------------
      FOR meta_clinica IN c05
      LOOP
        BEGIN
          nr_seq_pat_cp_goal_w := meta_clinica.nr_sequencia;
          saida_w              := saida_w || space_n2_w || '\u9632    ' || obter_desc_expressao(948691) || ': ' || meta_clinica.ds_display_name;
          /*Meta de cuidado: */

          saida_w := saida_w || newline_w;
          FOR indicador IN c06
          LOOP
            BEGIN
              IF (si_dates_w = 'Y' ) THEN
                SELECT substr(newline_w
                  || space_n4_w
                  || obter_desc_expressao(291978, NULL)
                  || ': '
                  ||
                  /*Inicio: */

                  pkg_date_utils.start_of(indicador.dt_start, 'DD', NULL)
                  || newline_w
                  || space_n4_w
                  || obter_desc_expressao(290101, NULL)
                  || ': '
                  ||
                  /*Fim*/

                  pkg_date_utils.start_of(indicador.dt_end, 'DD'),1,4000)
                INTO STRICT ds_data_ini_fim_w
;
              ELSE
                ds_data_ini_fim_w := '';
              END IF;
              IF (si_measures_result_w = 'Y' ) THEN
                saida_w               := saida_w || space_n3_w || '\u9632    ' || obter_desc_expressao(291850,NULL) || ': ' || indicador.ds_display_name
                /*Indicador: */

                || newline_w || space_n4_w || obter_desc_expressao(951411, NULL) || ': '
                /*Mensuracao atual: */

                || indicador.ds_cp_measure || ds_data_ini_fim_w;
              ELSE
                saida_w := saida_w || space_n3_w || '\u9632    ' || obter_desc_expressao(291850,NULL) || ': ' || indicador.ds_display_name
                /*Indicador: */

                || ds_data_ini_fim_w;
              END IF;
              saida_w := saida_w || newline_w;
            END;
          END LOOP;
        END;
      END LOOP;
      FOR plano_intervencao IN c03
      LOOP
        BEGIN
          nr_seq_pat_cp_interv_plan_w := plano_intervencao.nr_sequencia;
          saida_w                     := saida_w || space_n2_w || '\u9632    ' || obter_desc_expressao(954939,NULL) || ': ' || plano_intervencao.ds_display_name;
          /*Plano de intervencao: */

          saida_w := saida_w || newline_w;
          FOR intervencao IN c04
          LOOP
            BEGIN
              saida_w := saida_w || space_n3_w || '\u9632    ' || obter_desc_expressao(292220,NULL) || ': ' || intervencao.ds_display_name;
              /*Intervencao: */

              saida_w := saida_w || newline_w;
            END;
          END LOOP;
        END;
      END LOOP;
    END;
  END LOOP;
  IF (si_clinical_note_w = 'Y') AND (si_measures_result_w = 'Y') AND (si_dates_w = 'Y') AND (si_rtf_w = 'N') THEN
    saida_w             := REPLACE(saida_w, CHR(13) || CHR(10), ' \par ');
  ELSE
    ds_cabecalho_w := '{\rtf1\ansi\ansicpg1252\deff0\deflang1046{\fonttbl{\f0\fswiss\fcharset0 ' || ds_fonte_w || ';}}' || '{\*\generator msftedit 5.41.15.1507;}\viewkind4\uc1\pard\f0\fs' || nr_tam_fonte_w || ' ';
    ds_rodape_w    := '}';
    saida_w        := ds_cabecalho_w || REPLACE(saida_w, CHR(13) || CHR(10), ' \par ') || ds_rodape_w;
  END IF;
  SELECT nextval('patient_cp_summary_seq')
  INTO STRICT nr_seq_patient_cp_summary_w
;
  DELETE FROM patient_cp_summary WHERE nr_seq_prescr = nr_seq_prescr_p;
  INSERT
  INTO patient_cp_summary(
      ds_summary,
      dt_atualizacao,
      dt_atualizacao_nrec,
      nm_usuario,
      nm_usuario_nrec,
      nr_seq_prescr,
      nr_sequencia
    )
    VALUES (
      saida_w,
      clock_timestamp(),
      clock_timestamp(),
      nm_usuario_p,
      nm_usuario_p,
      nr_seq_prescr_p,
      nr_seq_patient_cp_summary_w
    );
  COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cp_generate_summary_nur ( nr_seq_prescr_p bigint, nm_usuario_p text, si_measures_result_p text DEFAULT 'N', si_dates_p text DEFAULT 'N', si_rtf_p text DEFAULT 'Y') FROM PUBLIC;

