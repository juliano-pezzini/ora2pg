-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_status_proced_mmed (nr_acesso_dicom_p text, /* V20 */
 ie_status_execucao_p text, /* V3 */
 ds_login_p text) AS $body$
DECLARE

/*objeto chamada no integração da multimed, os novos parâmetros que forem adicionados devem ser definidos como default para não ocorrer problemas na integração*/

ie_status_execucao_w		varchar(3);
nr_prescricao_w			bigint;
nr_sequencia_prescricao_w	integer;
nr_seq_procpaci_w		bigint;
nr_prescricao_ww		bigint;
ie_status_exec_w		varchar(3);
nr_seq_prescr_w			integer;
nr_atendimento_w		bigint;
nr_interno_conta_w		bigint;
ie_imagem_pacs_w		varchar(1);


BEGIN

/*
10 Na Fila		10 Prescrito
20 Atendido	15 Em exame
30 Finalizado	20 Executado
40 Laudo Possui Áudio	25 Laudo ditado
50 Laudo em execução	26 Laudo em digitação
60 Digitado		30 Laudo sem liberação
70 Não Revisado	30 Laudo sem liberação (antigo 35 Aguarda 2ª aprovação) --alterado o 70 para 35 em conexão com Eduardo da Tecso no HMCG
80 Laudo Finalizado	40 Laudo liberado
90 Laudo envelopado	45 Envelopado
100 Laudo entregue	60 Paciente
*/
CALL gravar_log_cdi(55412,	'ASPM01'||nr_acesso_dicom_p||'-'||
			ie_status_execucao_p||'-'||
			ds_login_p,'tasy');


select	CASE WHEN ie_status_execucao_p='10' THEN '10' WHEN ie_status_execucao_p='20' THEN '15' WHEN ie_status_execucao_p='30' THEN '20' WHEN ie_status_execucao_p='40' THEN '25' WHEN ie_status_execucao_p='50' THEN '26' WHEN ie_status_execucao_p='60' THEN '30' WHEN ie_status_execucao_p='70' THEN '30' WHEN ie_status_execucao_p='80' THEN '40' WHEN ie_status_execucao_p='90' THEN '45' WHEN ie_status_execucao_p='100' THEN '60' END
into STRICT	ie_status_execucao_w
;

if (ie_status_execucao_w in ('10','15','25','26','30','35','40','45','60')) then

	if (ie_status_execucao_p = '70') then

		select 	max(nr_sequencia),
				max(nr_prescricao),
				max(ie_status_execucao)
		into STRICT	nr_seq_prescr_w,
				nr_prescricao_ww,
				ie_status_exec_w
		from	prescr_procedimento
		where 	nr_acesso_dicom = nr_acesso_dicom_p;

	end if;

	update	prescr_procedimento
	set	ie_status_execucao = ie_status_execucao_w,
		nm_usuario = substr(ds_login_p,1,15),
		dt_atualizacao = clock_timestamp()
	where	nr_acesso_dicom = nr_acesso_dicom_p;

	--gravar_log_tasy(88,nr_prescricao_ww||'-'||nr_seq_prescr_w||'-'||ie_status_execucao_p,'tasy');
	if (ie_status_execucao_p = '70') then /*para voltar o status do laudo para laudo digitado quando é cancelada a assinatura no multimed - visualização da legenda no PEP*/
		update	laudo_paciente
		set 	dt_cancelamento = clock_timestamp(),
				dt_atualizacao = clock_timestamp(),
				nm_usuario = substr(ds_login_p,1,15)
		where 	nr_prescricao = nr_prescricao_ww
		and		nr_seq_prescricao = nr_seq_prescr_w;

	end if;


elsif (ie_status_execucao_w = '20') then

	select	p.nr_prescricao,
		p.nr_sequencia
	into STRICT	nr_prescricao_w,
		nr_sequencia_prescricao_w
	from	prescr_procedimento p
	where	p.nr_acesso_dicom = nr_acesso_dicom_p;


	select coalesce(max(a.ie_imagem_pacs),'N')
	into STRICT	ie_imagem_pacs_w
	from	mmed_parametro_integracao a;

	nr_seq_procpaci_w := Gerar_Proced_Paciente_mmed( nr_prescricao_w, nr_sequencia_prescricao_w, ds_login_p,  --NM_USUARIO_P,
					null,  --CD_PERFIL_P,
					'942',  --CD_FUNCAO_P  - (942) Gestão de Exames,
					null, null, nr_seq_procpaci_w);

	select	max(nr_sequencia),
		max(nr_atendimento),
		max(nr_interno_conta)
	into STRICT	nr_seq_procpaci_w,
		nr_atendimento_w,
		nr_interno_conta_w
	from	procedimento_paciente
	where	nr_prescricao		= nr_prescricao_w
	and	nr_sequencia_prescricao	= nr_sequencia_prescricao_w;


	if (ie_imagem_pacs_w = 'S') then
		begin
		update	prescr_procedimento
		set	ie_imagem_pacs = 'S'
		where	nr_prescricao		= nr_prescricao_w
		and	nr_sequencia		= nr_sequencia_prescricao_w;
		end;
	end if;

	CALL gerar_lancamento_automatico(nr_atendimento_w,
								null,
								34,
								'Multimed',
								nr_seq_procpaci_w,
								null,
								null,
								null,
								null,
								nr_interno_conta_w);

end if;

--commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_status_proced_mmed (nr_acesso_dicom_p text,  ie_status_execucao_p text,  ds_login_p text) FROM PUBLIC;

