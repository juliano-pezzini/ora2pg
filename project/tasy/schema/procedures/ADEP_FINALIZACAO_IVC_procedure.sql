-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE adep_finalizacao_ivc ( nr_sequencia_p bigint, nm_usuario_p text, nr_seq_etapa_p bigint) AS $body$
DECLARE

			 
qt_volume_infundido_w		bigint;		
qt_volume_drenado_w		bigint;
qt_volume_real_w		bigint;
ie_evento_w			varchar(50);
nr_prescricao_w			bigint;
nr_atendimento_w		bigint;
cd_setor_atendimento_w		bigint;
nr_seq_atend_w			bigint;
ie_perda_ganho_w		varchar(5);
ds_observacao_w			varchar(4000);
cd_profissional_w		varchar(10);
nr_seq_tipo_w			bigint;

C01 CURSOR FOR 
SELECT	nr_seq_tipo 
from	prescr_ivc_perda_ganho 
where	ie_evento		= ie_evento_w;			
			 

BEGIN 
 
select 	sum(coalesce(qt_infusao,0)), 
	sum(coalesce(qt_drenagem,0)) 
into STRICT	qt_volume_infundido_w, 
	qt_volume_drenado_w 
from	adep_irrigacao_etapa a, 
	adep_irrigacao b 
where	a.nr_seq_irrigacao = b.nr_sequencia 
and	b.nr_sequencia = nr_sequencia_p 
and	coalesce(a.ie_evento_valido,'S')	= 'S';
 
qt_volume_real_w := qt_volume_infundido_w - qt_volume_drenado_w;
 
if (qt_volume_real_w	> 0) then 
	ie_evento_w	:= 'EG';
else 
	ie_evento_w	:= 'EP';
end if;
 
select	a.nr_atendimento, 
	a.nr_prescricao 
into STRICT	nr_atendimento_w, 
	nr_prescricao_w 
from	adep_irrigacao 	a 
where	a.nr_sequencia = nr_sequencia_p;
 
select	max(cd_setor_atendimento) 
into STRICT	cd_setor_atendimento_w 
from	prescr_medica 
where	nr_prescricao	= nr_prescricao_w;
 
if (coalesce(cd_setor_atendimento_w::text, '') = '') then 
	begin 
	select	Obter_Setor_Atendimento(nr_atendimento_w) 
	into STRICT	cd_setor_atendimento_w 
	;
	end;
end if;
 
open C01;
loop 
fetch C01 into	 
	nr_seq_tipo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	if (nr_seq_tipo_w IS NOT NULL AND nr_seq_tipo_w::text <> '') then 
	 
		select	nextval('atendimento_perda_ganho_seq') 
		into STRICT	nr_seq_atend_w 
		;
		begin 
		select 	ds_observacao, 
			cd_pessoa_fisica 
		into STRICT	ds_observacao_w, 
			cd_profissional_w 
		from	adep_irrigacao_etapa a 
		where	nr_seq_irrigacao = nr_sequencia_p 
		and	nr_sequencia	= (	SELECT	max(x.nr_sequencia) 
						from	adep_irrigacao_etapa x 
						where	x.nr_seq_irrigacao = nr_sequencia_p);
		exception 
			when others then 
			null;
		end;
		 
		if (qt_volume_real_w < 0) then 
			qt_volume_real_w	:= qt_volume_real_w * -1;
		end if;
		 
		insert into atendimento_perda_ganho(nr_sequencia, 
				nr_atendimento, 
				dt_atualizacao, 
				nm_usuario, 
				nr_seq_tipo, 
				qt_volume, 
				ds_observacao, 
				dt_medida, 
				cd_setor_atendimento, 
				ie_origem, 
				dt_referencia, 
				cd_profissional, 
				ie_situacao, 
				dt_liberacao, 
				dt_apap, 
				qt_ocorrencia, 
				nr_seq_evento_ivc 
				) 
			values ( nr_seq_atend_w, 
				nr_atendimento_w, 
				clock_timestamp(), 
				nm_usuario_p, 
				nr_seq_tipo_w, 
				qt_volume_real_w, 
				ds_observacao_w, 
				clock_timestamp(), 
				cd_setor_atendimento_w, 
				'S', 
				clock_timestamp(), 
				cd_profissional_w, 
				'A', 
				clock_timestamp(), 
				clock_timestamp(), 
				1, 
				nr_seq_etapa_p);
 
	end if;
	end;
end loop;
close C01;
				 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE adep_finalizacao_ivc ( nr_sequencia_p bigint, nm_usuario_p text, nr_seq_etapa_p bigint) FROM PUBLIC;

