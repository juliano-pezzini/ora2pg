-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sup_grava_envio_email ( ie_tipo_documento_p text, ie_tipo_mensagem_p text, nr_documento_p bigint, nr_seq_aprovacao_p bigint, nr_seq_proc_aprov_p bigint, ds_lista_destino_p text, nm_usuario_origem_p text, ds_email_origem_p text, ds_assunto_p text, ds_mensagem_p text, cd_estabelecimento_p bigint, nm_usuario_p text, ie_commit_p text default 'S') AS $body$
DECLARE


nr_sequencia_w		bigint;
nr_seq_agrup_w		bigint;
ds_lista_destino_w		varchar(2000);
ds_email_destino_w		varchar(255);
tam_lista_w		bigint;
ie_pos_separador_w	bigint;
qt_existe_w		bigint;


BEGIN

if (ds_lista_destino_p IS NOT NULL AND ds_lista_destino_p::text <> '') then
	begin

	select	nextval('envio_email_compra_agrup_seq')
	into STRICT	nr_sequencia_w
	;

	insert into envio_email_compra_agrup(
		nr_sequencia,
		nm_usuario,
		dt_atualizacao,
		nm_usuario_nrec,
		dt_atualizacao_nrec,
		cd_estabelecimento,
		nr_documento,
		nr_seq_aprovacao,
		nr_seq_proc_aprov,
		ie_tipo_documento,
		ie_tipo_mensagem,
		ds_email_origem,
		nm_usuario_origem,
		ds_assunto,
		ds_mensagem,
		dt_cancelamento,
		ie_cancelado) values (
			nr_sequencia_w,
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			cd_estabelecimento_p,
			nr_documento_p,
			nr_seq_aprovacao_p,
			nr_seq_proc_aprov_p,
			ie_tipo_documento_p,
			ie_tipo_mensagem_p,
			ds_email_origem_p,
			nm_usuario_origem_p,
			ds_assunto_p,
			ds_mensagem_p,
			null,
			'N');

	/*Colocado estas duas opções pois as vezes entre como nulo e as vezes como string vazia*/

	/*if	(ds_email_origem_p is null) or
		(ds_email_origem_p = '') then
		gravar__log__tasy(17712,'Registro sem e-mail de origem - Seq.: ' || nr_sequencia_w || ' Usuário: ' || nm_usuario_origem_p,nm_usuario_p);
	end if;	*/
	ds_lista_destino_w		:= ds_lista_destino_p;

	if (substr(ds_lista_destino_w,length(ds_lista_destino_w) - 1,length(ds_lista_destino_w)) <> ';') then
		ds_lista_destino_w		:= (ds_lista_destino_w || ';');
	end if;

	if (ds_lista_destino_w IS NOT NULL AND ds_lista_destino_w::text <> '') then
		begin

		while(ds_lista_destino_w IS NOT NULL AND ds_lista_destino_w::text <> '') loop
			begin

			tam_lista_w		:=	length(ds_lista_destino_w);
			ie_pos_separador_w	:=	position(';' in ds_lista_destino_w);

			if (ie_pos_separador_w <> 0) then
				ds_email_destino_w	:= trim(both substr(ds_lista_destino_w,1,(ie_pos_separador_w - 1)));
				ds_lista_destino_w		:= substr(ds_lista_destino_w,(ie_pos_separador_w + 1),tam_lista_w);
			end if;

			select	count(*)
			into STRICT	qt_existe_w
			from	email_compra_agrup_dest
			where	nr_seq_envio = nr_sequencia_w
			and	upper(ds_destino) = upper(ds_email_destino_w);

			if (ds_email_destino_w IS NOT NULL AND ds_email_destino_w::text <> '') and (qt_existe_w = 0) then
				begin

				select	nextval('email_compra_agrup_dest_seq')
				into STRICT	nr_seq_agrup_w
				;

				insert into email_compra_agrup_dest(
					nr_sequencia,
					nm_usuario,
					dt_atualizacao,
					nm_usuario_nrec,
					dt_atualizacao_nrec,
					nr_seq_envio,
					ds_destino,
					dt_envio,
					ie_enviado) values (
						nr_seq_agrup_w,
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nr_sequencia_w,
						ds_email_destino_w,
						null,
						'N');

				end;
			end if;

			end;
		end loop;

		end;
	end if;

	end;
end if;

if (coalesce(ie_commit_p,'S') = 'S') then
	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
end if;

insert into log_envio_email_temp(
	ds_log,
	cd_estabelecimento,
	ie_tipo_mensagem,
	dt_atualizacao,
	nm_usuario)
values (	nr_sequencia_w,
	cd_estabelecimento_p,
	ie_tipo_mensagem_p,
	clock_timestamp(),
	nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_grava_envio_email ( ie_tipo_documento_p text, ie_tipo_mensagem_p text, nr_documento_p bigint, nr_seq_aprovacao_p bigint, nr_seq_proc_aprov_p bigint, ds_lista_destino_p text, nm_usuario_origem_p text, ds_email_origem_p text, ds_assunto_p text, ds_mensagem_p text, cd_estabelecimento_p bigint, nm_usuario_p text, ie_commit_p text default 'S') FROM PUBLIC;

