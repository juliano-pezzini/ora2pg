-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_lote_pos_estab_novo ( nr_seq_lote_p pls_lote_pos_estabelecido.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE

 
dt_referencia_regra_w		timestamp;
dt_atendimento_ref_regra_w	timestamp;
qt_registro_w			integer;
ind_proc_w			integer := 0;
ie_forma_pagamento_w		pls_parametro_pagamento.ie_forma_pagamento%type;
nr_seq_regra_w			pls_regra_lib_pos_estab.nr_sequencia%type;
dt_competencia_w		pls_lote_pos_estabelecido.dt_competencia%type;
ie_periodo_w			pls_regra_pos_estab_item.ie_periodo%type;
ie_tipo_cobranca_w		pls_regra_pos_estab_item.ie_tipo_cobranca%type;
nr_dia_max_w			pls_regra_pos_estab_item.nr_dia_max%type;
tb_nr_seq_conta_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_segurado_w 		pls_util_cta_pck.t_number_table;
tb_nr_seq_conta_pos_estab_w 	pls_util_cta_pck.t_number_table;
tb_nr_seq_conta_co_w		pls_util_cta_pck.t_number_table;
tb_cd_procedimento_w		pls_util_cta_pck.t_number_table;
tb_ie_origem_proced_w 		pls_util_cta_pck.t_number_table;
tb_nr_seq_material_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_analise_w 		pls_util_cta_pck.t_number_table;
tb_nr_seq_prestador_exec_w 	pls_util_cta_pck.t_number_table;
tb_nr_seq_prestador_atend_w	pls_util_cta_pck.t_number_table;
tb_ie_proc_mat_w 		pls_util_cta_pck.t_varchar2_table_1;
tb_nr_seq_regra_pos_estab_w 	pls_util_cta_pck.t_number_table;
tb_nr_seq_pos_estab_interc_w	pls_util_cta_pck.t_number_table;
tb_qt_item_w			pls_util_cta_pck.t_number_table;
tb_vl_beneficiario_w 		pls_util_cta_pck.t_number_table;
tb_vl_liberado_w		pls_util_cta_pck.t_number_table;
tb_ds_item_w 			pls_util_cta_pck.t_varchar2_table_255;
tb_dt_mes_competencia_w		pls_util_cta_pck.t_date_table;
tb_dt_atendimento_referencia_w	pls_util_cta_pck.t_date_table;
tb_nr_contrato_w 		pls_util_cta_pck.t_number_table;
tb_nr_seq_contrato_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_intercambio_w		pls_util_cta_pck.t_number_table;
tb_nr_seq_pagador_w		pls_util_cta_pck.t_number_table;

C01 CURSOR FOR 
	SELECT	'P' 			ie_proc_mat, 
		a.nr_sequencia  	nr_seq_conta_pos_estab, 
		null          nr_seq_conta_co, 
		b.nr_sequencia     nr_seq_conta, 
		b.nr_seq_segurado    nr_seq_segurado, 
		b.nr_seq_analise    nr_seq_analise, 
		null 			nr_seq_regra_pos_estab, 
		null 			nr_seq_pos_estab_interc, 
		b.nr_seq_prestador_exec  nr_seq_prestador_exec, 
		b.nr_seq_prestador    nr_seq_prestador_atend, 
		a.qt_item         qt_item, 
			(coalesce(a.vl_medico, 0) + coalesce(a.vl_materiais, 0) + coalesce(a.vl_custo_operacional, 0) + 
			 coalesce(a.vl_lib_taxa_co, 0) + coalesce(a.vl_lib_taxa_material, 0) + coalesce(a.vl_lib_taxa_servico, 0)) vl_beneficiario, 
		coalesce(c.vl_liberado,0)   vl_liberado, 
		c.cd_procedimento     cd_procedimento, 
		c.ie_origem_proced    ie_origem_proced, 
		null           nr_seq_material, 
		b.dt_atendimento_referencia   dt_atendimento_referencia, 
		d.dt_mes_competencia      dt_mes_competencia, 
		(    SELECT	count(1) 
			from	pls_lib_pos_estabelecido	 
			where	nr_seq_conta_pos_estab	= a.nr_sequencia) qt_registro, 
		substr(obter_descricao_procedimento(c.cd_procedimento, c.ie_origem_proced),1,255) ds_item, 
		e.nr_seq_contrato 		nr_seq_contrato, 
		e.nr_seq_intercambio	nr_seq_intercambio, 
		e.nr_seq_pagador		nr_seq_pagador, 
		(	select	max(nr_contrato) 
			from	pls_contrato 
			where	nr_sequencia = e.nr_seq_contrato) nr_contrato		 
	from	pls_conta_proc			c, 
		pls_conta			b, 
		pls_conta_pos_proc		a, 
		pls_protocolo_conta		d, 
		pls_segurado			e 
	where	c.nr_sequencia	= a.nr_seq_conta_proc 
	and	b.nr_sequencia	= c.nr_seq_conta 
	and	d.nr_sequencia	= b.nr_seq_protocolo 
	and	b.nr_seq_segurado = e.nr_sequencia 
	and	coalesce(a.ie_status_faturamento::text, '') = ''  -- Pendente de liberação 
	and	(((ie_forma_pagamento_w = 'P') and (d.ie_status in ('3','6') )) or 
		(ie_forma_pagamento_w 	= 'C' AND b.ie_status = 'F')) 
	and	coalesce(d.ie_tipo_protocolo,'C') in ('C','I') 
	and	e.ie_tipo_segurado in ('B','A','R') 
	and	d.dt_mes_competencia 	<= dt_referencia_regra_w 
	and	((b.dt_atendimento_referencia <= dt_atendimento_ref_regra_w) or (nr_dia_max_w= 0)) 
	and	ie_tipo_cobranca_w in ('P','A') 
	and	b.cd_estabelecimento	= cd_estabelecimento_p 
	
union all
 
	select	'M' ie_proc_mat, 
		a.nr_sequencia nr_seq_conta_pos_estab, 
		null nr_seq_conta_co, 
		b.nr_sequencia nr_seq_conta, 
		b.nr_seq_segurado, 
		b.nr_seq_analise, 
		a.nr_seq_regra_pos_estab, 
		a.nr_seq_pos_estab_interc, 
		b.nr_seq_prestador_exec, 
		b.nr_seq_prestador, 
		a.qt_item, 
		(coalesce(a.vl_materiais, 0) + coalesce(a.vl_lib_taxa_material, 0)) vl_beneficiario, 
		coalesce(c.vl_liberado,0), 
		null, 
		null, 
		c.nr_seq_material, 
		b.dt_atendimento_referencia, 
		d.dt_mes_competencia, 
		(    select	count(1) 
			from	pls_lib_pos_estabelecido	 
			where	nr_seq_conta_pos_estab	= a.nr_sequencia) qt_registro, 
		substr(pls_obter_desc_material(c.nr_seq_material),1,255) ds_item, 
		e.nr_seq_contrato		nr_seq_contrato, 
		e.nr_seq_intercambio	nr_seq_intercambio, 
		e.nr_seq_pagador		nr_seq_pagador, 
		(	select	max(nr_contrato) 
			from	pls_contrato 
			where	nr_sequencia = e.nr_seq_contrato) nr_contrato		 
	from	pls_conta_mat			c, 
		pls_conta			b, 
		pls_conta_pos_mat	a, 
		pls_protocolo_conta		d, 
		pls_segurado			e 
	where	c.nr_sequencia	= a.nr_seq_conta_mat 
	and	b.nr_sequencia	= c.nr_seq_conta 
	and	d.nr_sequencia	= b.nr_seq_protocolo 
	and	b.nr_seq_segurado = e.nr_sequencia 
	and	coalesce(a.ie_status_faturamento::text, '') = ''  -- Pendente de liberação 
	and	(((ie_forma_pagamento_w = 'P') and (d.ie_status in ('3','6') )) or 
		(ie_forma_pagamento_w 	= 'C' AND b.ie_status = 'F')) 
	and	coalesce(d.ie_tipo_protocolo,'C') in ('C','I') 
	and	e.ie_tipo_segurado in ('B','A','R') 
	and	d.dt_mes_competencia 	<= dt_referencia_regra_w 
	and	(( b.dt_atendimento_referencia <= dt_atendimento_ref_regra_w ) or ( nr_dia_max_w = 0 )) 
	and	ie_tipo_cobranca_w in ('P','A') 
	and	b.cd_estabelecimento	= cd_estabelecimento_p 
	
union all
 
	select	'P' 			ie_proc_mat, 
		a.nr_sequencia  	nr_seq_conta_pos_estab, 
		null          nr_seq_conta_co, 
		b.nr_sequencia     nr_seq_conta, 
		b.nr_seq_segurado    nr_seq_segurado, 
		b.nr_seq_analise    nr_seq_analise, 
		null 			nr_seq_regra_pos_estab, 
		null 			nr_seq_pos_estab_interc, 
		b.nr_seq_prestador_exec  nr_seq_prestador_exec, 
		b.nr_seq_prestador    nr_seq_prestador_atend, 
		a.qt_item         qt_item, 
			(coalesce(a.vl_medico, 0) + coalesce(a.vl_materiais, 0) + coalesce(a.vl_custo_operacional, 0) + 
			 coalesce(a.vl_lib_taxa_co, 0) + coalesce(a.vl_lib_taxa_material, 0) + coalesce(a.vl_lib_taxa_servico, 0)) vl_beneficiario, 
		coalesce(c.vl_liberado,0)   vl_liberado, 
		c.cd_procedimento     cd_procedimento, 
		c.ie_origem_proced    ie_origem_proced, 
		null           nr_seq_material, 
		b.dt_atendimento_referencia   dt_atendimento_referencia, 
		d.dt_mes_competencia      dt_mes_competencia, 
		(    select	count(1) 
			from	pls_lib_pos_estabelecido	 
			where	nr_seq_conta_pos_estab	= a.nr_sequencia) qt_registro, 
		substr(obter_descricao_procedimento(c.cd_procedimento, c.ie_origem_proced),1,255) ds_item, 
		e.nr_seq_contrato 		nr_seq_contrato, 
		e.nr_seq_intercambio	nr_seq_intercambio, 
		e.nr_seq_pagador		nr_seq_pagador, 
		(	select	max(nr_contrato) 
			from	pls_contrato 
			where	nr_sequencia = e.nr_seq_contrato) nr_contrato		 
	from	pls_conta_proc			c, 
		pls_conta			b, 
		pls_conta_pos_proc		a, 
		pls_protocolo_conta		d, 
		pls_segurado			e 
	where	c.nr_sequencia	= a.nr_seq_conta_proc 
	and	b.nr_sequencia	= c.nr_seq_conta 
	and	d.nr_sequencia	= b.nr_seq_protocolo 
	and	b.nr_seq_segurado = e.nr_sequencia 
	and	a.ie_status_faturamento = 'P' -- Pendente de liberação 
	and	(((ie_forma_pagamento_w = 'P') and (d.ie_status in ('3','6') )) or 
		(ie_forma_pagamento_w 	= 'C' AND b.ie_status = 'F')) 
	and	coalesce(d.ie_tipo_protocolo,'C') in ('C','I') 
	and	e.ie_tipo_segurado in ('B','A','R') 
	and	d.dt_mes_competencia 	<= dt_referencia_regra_w 
	and	((b.dt_atendimento_referencia <= dt_atendimento_ref_regra_w) or (nr_dia_max_w= 0)) 
	and	ie_tipo_cobranca_w in ('P','A') 
	and	b.cd_estabelecimento	= cd_estabelecimento_p 
	
union all
 
	select	'M' ie_proc_mat, 
		a.nr_sequencia nr_seq_conta_pos_estab, 
		null nr_seq_conta_co, 
		b.nr_sequencia nr_seq_conta, 
		b.nr_seq_segurado, 
		b.nr_seq_analise, 
		a.nr_seq_regra_pos_estab, 
		a.nr_seq_pos_estab_interc, 
		b.nr_seq_prestador_exec, 
		b.nr_seq_prestador, 
		a.qt_item, 
		(coalesce(a.vl_materiais, 0) + coalesce(a.vl_lib_taxa_material, 0)) vl_beneficiario, 
		coalesce(c.vl_liberado,0), 
		null, 
		null, 
		c.nr_seq_material, 
		b.dt_atendimento_referencia, 
		d.dt_mes_competencia, 
		(    select	count(1) 
			from	pls_lib_pos_estabelecido	 
			where	nr_seq_conta_pos_estab	= a.nr_sequencia) qt_registro, 
		substr(pls_obter_desc_material(c.nr_seq_material),1,255) ds_item, 
		e.nr_seq_contrato		nr_seq_contrato, 
		e.nr_seq_intercambio	nr_seq_intercambio, 
		e.nr_seq_pagador		nr_seq_pagador, 
		(	select	max(nr_contrato) 
			from	pls_contrato 
			where	nr_sequencia = e.nr_seq_contrato) nr_contrato		 
	from	pls_conta_mat			c, 
		pls_conta			b, 
		pls_conta_pos_mat	a, 
		pls_protocolo_conta		d, 
		pls_segurado			e 
	where	c.nr_sequencia	= a.nr_seq_conta_mat 
	and	b.nr_sequencia	= c.nr_seq_conta 
	and	d.nr_sequencia	= b.nr_seq_protocolo 
	and	b.nr_seq_segurado = e.nr_sequencia 
	and	a.ie_status_faturamento = 'P' -- Pendente de liberação 
	and	(((ie_forma_pagamento_w = 'P') and (d.ie_status in ('3','6') )) or 
		(ie_forma_pagamento_w 	= 'C' AND b.ie_status = 'F')) 
	and	coalesce(d.ie_tipo_protocolo,'C') in ('C','I') 
	and	e.ie_tipo_segurado in ('B','A','R') 
	and	d.dt_mes_competencia 	<= dt_referencia_regra_w 
	and	(( b.dt_atendimento_referencia <= dt_atendimento_ref_regra_w ) or ( nr_dia_max_w = 0 )) 
	and	ie_tipo_cobranca_w in ('P','A') 
	and	b.cd_estabelecimento	= cd_estabelecimento_p 
	
union all
 
	select	'P' ie_proc_mat, 
		null nr_seq_conta_pos_estab, 
		a.nr_sequencia nr_seq_conta_co, 
		b.nr_sequencia nr_seq_conta, 
		b.nr_seq_segurado, 
		b.nr_seq_analise, 
		null nr_seq_regra_pos_estab, 
		null nr_seq_pos_estab_interc, 
		b.nr_seq_prestador_exec, 
		b.nr_seq_prestador, 
		c.qt_procedimento qt_item, 
		a.vl_beneficiario, 
		coalesce(c.vl_liberado,0), 
		c.cd_procedimento, 
		c.ie_origem_proced, 
		null, 
		b.dt_atendimento_referencia, 
		d.dt_mes_competencia, 
		0 qt_registro, 
		substr(obter_descricao_procedimento(c.cd_procedimento, c.ie_origem_proced),1,255) ds_item, 
		e.nr_seq_contrato 		nr_seq_contrato, 
		e.nr_seq_intercambio	nr_seq_intercambio, 
		e.nr_seq_pagador		nr_seq_pagador, 
		(	select	max(nr_contrato) 
			from	pls_contrato 
			where	nr_sequencia = e.nr_seq_contrato) nr_contrato		 
	from	pls_conta_proc			c, 
		pls_conta			b, 
		pls_conta_co			a, 
		pls_protocolo_conta		d, 
		pls_segurado			e 
	where	c.nr_sequencia	= a.nr_seq_conta_proc 
	and	b.nr_sequencia	= c.nr_seq_conta 
	and	d.nr_sequencia	= b.nr_seq_protocolo 
	and	b.nr_seq_segurado = e.nr_sequencia 
	and	coalesce(a.nr_seq_mensalidade_seg::text, '') = '' 
	and	coalesce(a.ie_cobrar_mensalidade,'P') = 'P' -- Pendente de liberação 
	and	(((ie_forma_pagamento_w = 'P') and (d.ie_status in ('3','6') )) or 
		(ie_forma_pagamento_w 	= 'C' AND b.ie_status = 'F')) 
	and	coalesce(d.ie_tipo_protocolo,'C') in ('C','I') 
	and	a.ie_tipo_segurado in ('B','A','R') 
	and	d.dt_mes_competencia 	<= dt_referencia_regra_w 
	and	(( b.dt_atendimento_referencia <= dt_atendimento_ref_regra_w) or ( nr_dia_max_w = 0 )) 
	and	ie_tipo_cobranca_w in ('C','A') 
	and	b.cd_estabelecimento	= cd_estabelecimento_p 
	
union all
 
	select	'M' ie_proc_mat, 
		null nr_seq_conta_pos_estab, 
		a.nr_sequencia nr_seq_conta_co, 
		b.nr_sequencia nr_seq_conta, 
		b.nr_seq_segurado, 
		b.nr_seq_analise, 
		null nr_seq_regra_pos_estab, 
		null nr_seq_pos_estab_interc, 
		b.nr_seq_prestador_exec, 
		b.nr_seq_prestador, 
		c.qt_material qt_item, 
		a.vl_beneficiario, 
		coalesce(c.vl_liberado,0), 
		null, 
		null, 
		c.nr_seq_material, 
		b.dt_atendimento_referencia, 
		d.dt_mes_competencia, 
		0 qt_registro, 
		substr(pls_obter_desc_material(c.nr_seq_material),1,255) ds_item, 
		e.nr_seq_contrato		nr_seq_contrato, 
		e.nr_seq_intercambio	nr_seq_intercambio, 
		e.nr_seq_pagador		nr_seq_pagador, 
		(	select	max(nr_contrato) 
			from	pls_contrato 
			where	nr_sequencia = e.nr_seq_contrato) nr_contrato		 
	from	pls_conta_mat			c, 
		pls_conta			b, 
		pls_conta_co			a, 
		pls_protocolo_conta		d, 
		pls_segurado			e 
	where	c.nr_sequencia	= a.nr_seq_conta_mat 
	and	b.nr_sequencia	= c.nr_seq_conta 
	and	d.nr_sequencia	= b.nr_seq_protocolo 
	and	b.nr_seq_segurado = e.nr_sequencia 
	and	coalesce(a.nr_seq_mensalidade_seg::text, '') = '' 
	and	coalesce(a.ie_cobrar_mensalidade,'P') = 'P' -- Pendente de liberação 
	and	(((ie_forma_pagamento_w = 'P') and (d.ie_status in ('3','6') )) or 
		(ie_forma_pagamento_w 	= 'C' AND b.ie_status = 'F')) 
	and	coalesce(d.ie_tipo_protocolo,'C') in ('C','I') 
	and	a.ie_tipo_segurado in ('B','A','R') 
	and	d.dt_mes_competencia 	<= dt_referencia_regra_w 
	and	((b.dt_atendimento_referencia <= dt_atendimento_ref_regra_w) or (nr_dia_max_w = 0)) 
	and	ie_tipo_cobranca_w in ('C','A') 
	and	b.cd_estabelecimento	= cd_estabelecimento_p;
	
--Apenas faz inserções em bloco dos registros de liberação de pós. 	 
procedure inserir_lib_pos( 	tb_nr_seq_conta_p		in out pls_util_cta_pck.t_number_table, 
				tb_nr_seq_segurado_p		in out pls_util_cta_pck.t_number_table, 
				tb_nr_seq_conta_pos_estab_p	in out pls_util_cta_pck.t_number_table, 
				tb_nr_seq_conta_co_p		in out pls_util_cta_pck.t_number_table, 
				tb_cd_procedimento_p		in out pls_util_cta_pck.t_number_table, 
				tb_ie_origem_proced_p		in out pls_util_cta_pck.t_number_table, 
				tb_nr_seq_material_p		in out pls_util_cta_pck.t_number_table, 
				tb_nr_seq_analise_p		in out pls_util_cta_pck.t_number_table, 
				tb_nr_seq_prestador_exec_p	in out pls_util_cta_pck.t_number_table, 
				tb_nr_seq_prestador_atend_p	in out pls_util_cta_pck.t_number_table, 
				tb_ie_proc_mat_p        in out pls_util_cta_pck.t_varchar2_table_1, 
				tb_nr_seq_regra_pos_estab_p	in out pls_util_cta_pck.t_number_table, 
				tb_nr_seq_pos_estab_interc_p	in out pls_util_cta_pck.t_number_table, 
				tb_qt_item_p			in out pls_util_cta_pck.t_number_table, 
				tb_vl_beneficiario_p		in out pls_util_cta_pck.t_number_table, 
				tb_vl_liberado_p		in out pls_util_cta_pck.t_number_table,	 
				tb_ds_item_p	        in out pls_util_cta_pck.t_varchar2_table_255, 
				tb_dt_mes_competencia_p		in out pls_util_cta_pck.t_date_table, 
				tb_dt_atendimento_referencia_p	in out pls_util_cta_pck.t_date_table, 
				tb_nr_contrato_p		in out pls_util_cta_pck.t_number_table, 
				tb_nr_seq_contrato_p		in out pls_util_cta_pck.t_number_table, 
				tb_nr_seq_intercambio_p		in out pls_util_cta_pck.t_number_table, 
				tb_nr_seq_pagador_p		in out pls_util_cta_pck.t_number_table, 
				nm_usuario_p				usuario.nm_usuario%type, 
				nr_seq_lote_p				pls_lote_pos_estabelecido.nr_sequencia%type) is 
;
BEGIN
 
	if ( tb_nr_seq_conta_p.count > 0) then 
	 
		forall i in tb_nr_seq_conta_p.first..tb_nr_seq_conta_p.last 
			insert into pls_lib_pos_estabelecido(	nr_sequencia, nr_seq_lote, nr_seq_conta, 
				nr_seq_segurado, nr_seq_conta_pos_proc, 
				nr_seq_conta_mat_pos, nr_seq_conta_co, dt_atualizacao, 
				nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, 
				cd_procedimento, ie_origem_proced, nr_seq_material, 
				nr_seq_analise, nr_seq_prestador_exec, nr_seq_prestador_atend, 
				ie_proc_mat, nr_seq_regra_pos_estab, nr_seq_pos_estab_interc, 
				qt_item, vl_beneficiario, vl_liberado, 
				ds_item, dt_mes_competencia, dt_atendimento_referencia, 
				nr_contrato, nr_seq_contrato, nr_seq_intercambio, 
				nr_seq_pagador)		 
			values (nextval('pls_lib_pos_estabelecido_seq'), nr_seq_lote_p, tb_nr_seq_conta_p(i), 
				tb_nr_seq_segurado_p(i), CASE WHEN tb_ie_proc_mat_p(i)='P' THEN  tb_nr_seq_conta_pos_estab_p(i)  ELSE null END , 
				CASE WHEN  tb_ie_proc_mat_p(i)='M' THEN  tb_nr_seq_conta_pos_estab_p(i)  ELSE null END , tb_nr_seq_conta_co_p(i), clock_timestamp(), 
				nm_usuario_p, clock_timestamp(), nm_usuario_p, 
				tb_cd_procedimento_p(i), tb_ie_origem_proced_p(i), tb_nr_seq_material_p(i), 
				tb_nr_seq_analise_p(i), tb_nr_seq_prestador_exec_p(i), tb_nr_seq_prestador_atend_p(i), 
				tb_ie_proc_mat_p(i), tb_nr_seq_regra_pos_estab_p(i), tb_nr_seq_pos_estab_interc_p(i), 
				tb_qt_item_p(i), tb_vl_beneficiario_p(i), tb_vl_liberado_p(i), 
				tb_ds_item_p(i), tb_dt_mes_competencia_p(i), tb_dt_atendimento_referencia_p(i), 
				tb_nr_contrato_p(i), tb_nr_seq_contrato_p(i), tb_nr_seq_intercambio_p(i), 
				tb_nr_seq_pagador_p(i) 
			);	
		 
	 
	end if;	
	tb_nr_seq_conta_p.delete;		
	tb_nr_seq_segurado_p.delete;		
    tb_nr_seq_conta_pos_estab_p.delete;	
    tb_nr_seq_conta_co_p.delete;		
    tb_cd_procedimento_p.delete;		
    tb_ie_origem_proced_p.delete;		
    tb_nr_seq_material_p.delete;		
    tb_nr_seq_analise_p.delete;		
    tb_nr_seq_prestador_exec_p.delete;	
    tb_nr_seq_prestador_atend_p.delete;
    tb_ie_proc_mat_p.delete;
    tb_nr_seq_regra_pos_estab_p.delete;	
    tb_nr_seq_pos_estab_interc_p.delete;	
    tb_qt_item_p.delete;			
    tb_vl_beneficiario_p.delete;		
    tb_vl_liberado_p.delete;		
    tb_ds_item_p.delete;	
    tb_dt_mes_competencia_p.delete;		
    tb_dt_atendimento_referencia_p.delete;	
    tb_nr_contrato_p.delete;		
    tb_nr_seq_contrato_p.delete;		
    tb_nr_seq_intercambio_p.delete;		
    tb_nr_seq_pagador_p.delete;		
			 
end;
 
begin 
 
    select	max(ie_forma_pagamento) 
	into STRICT	ie_forma_pagamento_w 
	from	pls_parametro_pagamento 
	where	cd_estabelecimento	= cd_estabelecimento_p;
 
    select	nr_seq_regra, 
		dt_competencia 
	into STRICT	nr_seq_regra_w, 
		dt_competencia_w 
	from	pls_lote_pos_estabelecido 
	where	nr_sequencia	= nr_seq_lote_p;
 
    select	max(ie_periodo), 
		max(ie_tipo_cobranca), 
		coalesce(max(nr_dia_max),0) 
	into STRICT	ie_periodo_w, 
		ie_tipo_cobranca_w, 
		nr_dia_max_w 
	from	pls_regra_pos_estab_item 
	where	nr_seq_regra	= nr_seq_regra_w;
 
	ie_forma_pagamento_w	:= coalesce(ie_forma_pagamento_w,'P');
 
    if ( ie_periodo_w = '1') then /* Considerar protocolos com a competência até o mês de competência do lote */
 
		dt_referencia_regra_w	:= fim_dia(last_day(dt_competencia_w));
	 
	    if ( nr_dia_max_w != 0) then 
			dt_atendimento_ref_regra_w	:= fim_dia(to_date(to_char( nr_dia_max_w ) || '/' || to_char(dt_competencia_w, 'mm/yyyy')));
		end if;
	 
	elsif ( ie_periodo_w = '2') then /* Considerar protocolos com a competência até o mês anterior de competência do lote */
 
		dt_referencia_regra_w	:= fim_dia(last_day(add_months(dt_competencia_w,-1)));
	 
        if ( nr_dia_max_w != 0) then 
			dt_atendimento_ref_regra_w	:= fim_dia(add_months(to_date(to_char(nr_dia_max_w) || '/' || to_char(dt_competencia_w, 'mm/yyyy')),-1));
		end if;
	end if;
	 
    for r_C01_w in C01 loop 
	 
		--Apenas irá gerar registros de liberação de pós, caso não 
		if (r_c01_w.qt_registro = 0) then 
		 
			tb_nr_seq_conta_w(ind_proc_w)		:= r_C01_w.nr_seq_conta;
			tb_nr_seq_segurado_w(ind_proc_w) 	:= r_C01_w.nr_seq_segurado;
			tb_nr_seq_conta_pos_estab_w(ind_proc_w) := r_C01_w.nr_seq_conta_pos_estab;
			tb_nr_seq_conta_co_w(ind_proc_w)	:= r_C01_w.nr_seq_conta_co;
			tb_cd_procedimento_w(ind_proc_w)	:= r_C01_w.cd_procedimento;
			tb_ie_origem_proced_w(ind_proc_w)	:= r_C01_w.ie_origem_proced;
			tb_nr_seq_material_w(ind_proc_w)	:= r_C01_w.nr_seq_material;
			tb_nr_seq_analise_w(ind_proc_w) 	:= r_C01_w.nr_seq_analise;
			tb_nr_seq_prestador_exec_w(ind_proc_w) 	:= r_C01_w.nr_seq_prestador_exec;
			tb_nr_seq_prestador_atend_w(ind_proc_w)	:= r_C01_w.nr_seq_prestador_atend;
			tb_ie_proc_mat_w(ind_proc_w) 		:= r_C01_w.ie_proc_mat;
			tb_nr_seq_regra_pos_estab_w(ind_proc_w) := r_C01_w.nr_seq_regra_pos_estab;
			tb_nr_seq_pos_estab_interc_w(ind_proc_w):= r_C01_w.nr_seq_pos_estab_interc;
			tb_qt_item_w(ind_proc_w)		:= r_C01_w.qt_item;
			tb_vl_beneficiario_w(ind_proc_w) 	:= r_C01_w.vl_beneficiario;
			tb_vl_liberado_w(ind_proc_w)		:= r_C01_w.vl_liberado;
			tb_ds_item_w(ind_proc_w) 		:= r_c01_w.ds_item;
			tb_dt_mes_competencia_w(ind_proc_w)		:= r_C01_w.dt_mes_competencia;
			tb_dt_atendimento_referencia_w(ind_proc_w)	:= r_C01_w.dt_atendimento_referencia;
			tb_nr_contrato_w(ind_proc_w) 			:= r_C01_w.nr_contrato;
			tb_nr_seq_contrato_w(ind_proc_w)		:= r_C01_w.nr_seq_contrato;
			tb_nr_seq_intercambio_w(ind_proc_w)		:= r_C01_w.nr_seq_intercambio;
			tb_nr_seq_pagador_w(ind_proc_w)			:= r_C01_w.nr_seq_pagador;
			 
			--Enquanto não atingir a quantidade pré-determinada, mantém os registros em memória 
			if (ind_proc_w > pls_util_cta_pck.qt_registro_transacao_w) then 
			 
				inserir_lib_pos(tb_nr_seq_conta_w, tb_nr_seq_segurado_w, tb_nr_seq_conta_pos_estab_w, 
				        tb_nr_seq_conta_co_w, tb_cd_procedimento_w, tb_ie_origem_proced_w, 
				        tb_nr_seq_material_w, tb_nr_seq_analise_w, tb_nr_seq_prestador_exec_w, 
				        tb_nr_seq_prestador_atend_w, tb_ie_proc_mat_w, tb_nr_seq_regra_pos_estab_w, 
				        tb_nr_seq_pos_estab_interc_w, tb_qt_item_w, tb_vl_beneficiario_w, 
				        tb_vl_liberado_w, tb_ds_item_w, tb_dt_mes_competencia_w, 
				        tb_dt_atendimento_referencia_w, tb_nr_contrato_w, tb_nr_seq_contrato_w, 
				        tb_nr_seq_intercambio_w, tb_nr_seq_pagador_w, nm_usuario_p, 
						nr_seq_lote_p);
			else 
			 
				ind_proc_w := ind_proc_w + 1;
			 
			end if;
		     
		end if;	
 
	end loop;
	 
	--Se sobrarem registros, envia-os para o banco. 
	inserir_lib_pos(tb_nr_seq_conta_w, tb_nr_seq_segurado_w, tb_nr_seq_conta_pos_estab_w, 
			tb_nr_seq_conta_co_w, tb_cd_procedimento_w, tb_ie_origem_proced_w, 
			tb_nr_seq_material_w, tb_nr_seq_analise_w, tb_nr_seq_prestador_exec_w, 
			tb_nr_seq_prestador_atend_w, tb_ie_proc_mat_w, tb_nr_seq_regra_pos_estab_w, 
			tb_nr_seq_pos_estab_interc_w, tb_qt_item_w, tb_vl_beneficiario_w, 
			tb_vl_liberado_w, tb_ds_item_w, tb_dt_mes_competencia_w, 
			tb_dt_atendimento_referencia_w, tb_nr_contrato_w, tb_nr_seq_contrato_w, 
			tb_nr_seq_intercambio_w, tb_nr_seq_pagador_w, nm_usuario_p, 
			nr_seq_lote_p);
 
    select	count(1) 
	into STRICT	qt_registro_w 
	from	pls_lib_pos_estabelecido 
	where	nr_seq_lote	= nr_seq_lote_p;
 
    if (qt_registro_w > 0) then 
		 
		update	pls_lote_pos_estabelecido 
		set	ie_status	= 'G', 
			dt_geracao	= clock_timestamp(), 
			nm_usuario_geracao = nm_usuario_p 
		where	nr_sequencia	= nr_seq_lote_p;
	 
		CALL pls_gravar_hist_lote_pos_estab(	nr_seq_lote_p, 'Geração do lote', 'N', 
						nm_usuario_p, cd_estabelecimento_p);
	end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_lote_pos_estab_novo ( nr_seq_lote_p pls_lote_pos_estabelecido.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

