-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_proc_wint_autor_conv (nr_atendimento_p procedimento_guia_wint.nr_atendimento%type default null, ie_origem_informacao_p procedimento_guia_wint.ie_origem_informacao%type default null, nr_sequencia_autorizacao_p autorizacao_convenio.nr_sequencia%type default null, nm_usuario_p procedimento_guia_wint.nm_usuario%type default null) AS $body$
DECLARE


cd_procedimento_tuss_w procedimento_autorizado.cd_procedimento_tuss%type;
cd_procedimento_w procedimento_autorizado.cd_procedimento%type;
nr_seq_proc_interno_w procedimento_autorizado.nr_seq_proc_interno%type;
ds_observacao_w procedimento_autorizado.ds_observacao%type;
ie_lado_w procedimento_autorizado.ie_lado%type;
nr_crm_w crm_estado.nr_crm%type;
qt_solicitada_w procedimento_autorizado.qt_solicitada%type;
nr_prescricao_w procedimento_autorizado.nr_prescricao%type;
nr_sequencia_w procedimento_autorizado.nr_sequencia%type;
nr_seq_doc_convenio_w autorizacao_convenio.cd_autorizacao%type;
nr_ano_guia_w procedimento_guia_wint.nr_ano_guia%type;

c_proced_autorizado CURSOR FOR
SELECT  a.cd_procedimento,
        a.nr_seq_proc_interno,
        a.ds_observacao,
        a.ie_lado,
        obter_crm_medico(a.cd_medico_resp) nr_crm,
        a.qt_solicitada,
        a.nr_prescricao,
        a.nr_sequencia,
        a.cd_procedimento_tuss,
        coalesce(b.cd_autorizacao, '0') nr_seq_doc_convenio,
        case coalesce(b.cd_autorizacao, '0') when '0' then '0'
        else coalesce(to_char(b.dt_autorizacao, 'YYYY'), to_char(clock_timestamp(), 'YYYY'))
        end nr_ano_guia
from    procedimento_autorizado a,
        autorizacao_convenio b
where   b.nr_sequencia = a.nr_sequencia_autor
and     a.nr_sequencia_autor = nr_sequencia_autorizacao_p;


BEGIN

delete from procedimento_guia_wint a where a.nr_sequencia_autor = nr_sequencia_autorizacao_p;

open c_proced_autorizado;
loop
        fetch c_proced_autorizado into
                cd_procedimento_w,
                nr_seq_proc_interno_w,
                ds_observacao_w,
                ie_lado_w,
                nr_crm_w,
                qt_solicitada_w,
                nr_prescricao_w,
                nr_sequencia_w,
                cd_procedimento_tuss_w,
                nr_seq_doc_convenio_w,
                nr_ano_guia_w;
        EXIT WHEN NOT FOUND; /* apply on c_proced_autorizado */

        CALL insert_proc_guia_wint(cd_procedimento_w,
                              cd_procedimento_tuss_w,
                              ds_observacao_w,
                              Obter_Desc_Proc_Interno(nr_seq_proc_interno_w),
                              ie_lado_w,
                              nm_usuario_p,
                              nr_atendimento_p,
                              nr_crm_w,
                              nr_seq_proc_interno_w,
                              coalesce(qt_solicitada_w, 1),
                              nr_prescricao_w,
                              ie_origem_informacao_p,
                              nr_seq_doc_convenio_w,
                              nr_ano_guia_w,
                              nr_sequencia_w,
                              nr_sequencia_autorizacao_p);
end loop;

close c_proced_autorizado;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_proc_wint_autor_conv (nr_atendimento_p procedimento_guia_wint.nr_atendimento%type default null, ie_origem_informacao_p procedimento_guia_wint.ie_origem_informacao%type default null, nr_sequencia_autorizacao_p autorizacao_convenio.nr_sequencia%type default null, nm_usuario_p procedimento_guia_wint.nm_usuario%type default null) FROM PUBLIC;

