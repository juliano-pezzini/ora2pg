-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE iniciar_finalizar_infusao_hemo ( nr_seq_producao_p bigint, dt_ini_fim_infusao_p timestamp, ie_opcao_p text, nm_usuario_p text, qt_vol_transf_p bigint default null, nr_seq_reserva_p bigint default null) AS $body$
DECLARE


/*	ie_opcao_p=	I- Inciar infusao
			F- Finalizar infusao
*/
BEGIN
if (nr_seq_producao_p IS NOT NULL AND nr_seq_producao_p::text <> '') and (ie_opcao_p = 'I') then
	update	san_producao
	set	dt_inicio_infusao	= dt_ini_fim_infusao_p,
		nm_usuario_ini_infusao	= nm_usuario_p
	where	nr_sequencia		= nr_seq_producao_p;

     if (nr_seq_reserva_p IS NOT NULL AND nr_seq_reserva_p::text <> '') then
         update	san_reserva_prod
         set	ie_status_adep	= 'I'
         where	nr_seq_reserva	= nr_seq_reserva_p
         and	nr_seq_producao	= nr_seq_producao_p;
    end if;

elsif (nr_seq_producao_p IS NOT NULL AND nr_seq_producao_p::text <> '') and (ie_opcao_p = 'F') then
	update	san_producao
	set	dt_fim_infusao		= dt_ini_fim_infusao_p,
		nm_usuario_fim_infusao	= nm_usuario_p,
		qt_vol_transf		= qt_vol_transf_p	 	
	where	nr_sequencia		= nr_seq_producao_p;

    if (nr_seq_reserva_p IS NOT NULL AND nr_seq_reserva_p::text <> '') then
         update	san_reserva_prod
         set	ie_status_adep	= 'T'
         where	nr_seq_reserva	= nr_seq_reserva_p
         and	nr_seq_producao	= nr_seq_producao_p;
    end if;
	
elsif (nr_seq_producao_p IS NOT NULL AND nr_seq_producao_p::text <> '') and (ie_opcao_p = 'D') then

	update	san_producao
	set	dt_inicio_infusao	 = NULL,
		nm_usuario_ini_infusao	= ''
	where	nr_sequencia		= nr_seq_producao_p;

    if (nr_seq_reserva_p IS NOT NULL AND nr_seq_reserva_p::text <> '') then
        update	san_reserva_prod
        set	ie_status_adep	 = NULL
        where	nr_seq_reserva	= nr_seq_reserva_p
        and	nr_seq_producao	= nr_seq_producao_p;
    end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE iniciar_finalizar_infusao_hemo ( nr_seq_producao_p bigint, dt_ini_fim_infusao_p timestamp, ie_opcao_p text, nm_usuario_p text, qt_vol_transf_p bigint default null, nr_seq_reserva_p bigint default null) FROM PUBLIC;

