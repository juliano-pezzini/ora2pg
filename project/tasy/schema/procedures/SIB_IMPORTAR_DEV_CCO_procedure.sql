-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sib_importar_dev_cco ( nr_seq_lote_sib_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ie_registro_w			smallint;
cd_motivo_w			smallint;
cd_usuario_plano_w		varchar(30);
nm_beneficiario_w		varchar(70);
dt_nascimento_w			timestamp;
cd_usuario_plano_ant_w		varchar(30);
nr_cco_w			bigint;
ie_dig_verificador_w		smallint;
nr_seq_interno_w		integer;
ds_texto_w			varchar(255);
cd_usuario_plano_ww		varchar(1);
nm_beneficiario_ww		varchar(1);
		
C01 CURSOR FOR 
	SELECT	ds_texto 
	from	w_sib_devolucao;
	

BEGIN 
 
delete	from sib_devolucao_cco 
where	nr_seq_lote	= nr_seq_lote_sib_p;
 
delete	FROM sib_devolucao_log 
where	nr_seq_lote_sib_envio	= nr_seq_lote_sib_p 
and	ie_tipo_arquivo		= 'C';
 
delete	FROM sib_devolucao_log 
where	nr_seq_lote_sib_reenvio	= nr_seq_lote_sib_p 
and	ie_tipo_arquivo		= 'C';
 
open C01;
loop 
fetch C01 into	 
	ds_texto_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	select	(coalesce(substr(ds_texto_w,1,7),'0'))::numeric , 
		(coalesce(substr(ds_texto_w,8,1),'0'))::numeric , 
		(coalesce(substr(ds_texto_w,9,2),'0'))::numeric , 
		limpa_espacos_entre(substr(ds_texto_w,11,30)), 
		limpa_espacos_entre(substr(ds_texto_w,41,70)), 
		substr(ds_texto_w,119,30), 
		(coalesce(substr(ds_texto_w,149,10),'0'))::numeric , 
		(coalesce(substr(ds_texto_w,159,2),'0'))::numeric  
	into STRICT	nr_seq_interno_w, 
		ie_registro_w, 
		cd_motivo_w, 
		cd_usuario_plano_w, 
		nm_beneficiario_w, 
		cd_usuario_plano_ant_w, 
		nr_cco_w, 
		ie_dig_verificador_w 
	;
	 
	select	substr(cd_usuario_plano_w,length(cd_usuario_plano_w),1) 
	into STRICT	cd_usuario_plano_ww 
	;
	 
	begin 
	dt_nascimento_w	:=	to_date(substr(ds_texto_w,111,8),'yyyy/mm/dd');
	exception 
	when others then 
		/*aaschlote 11/05/2011 OS - 317669*/
 
		CALL sib_gravar_log_devolucao(nr_seq_lote_sib_p,'C',nr_seq_interno_w,'A data de nascimento está inválida -> '|| substr(ds_texto_w,111,8), 
					cd_estabelecimento_p,nm_usuario_p);
	end;
	 
	 
	if (cd_usuario_plano_ww = ' ') then 
		cd_usuario_plano_w	:= substr(cd_usuario_plano_w,1,length(cd_usuario_plano_w)-1);
	end if;
	 
	select	substr(nm_beneficiario_w,length(nm_beneficiario_w),1) 
	into STRICT	nm_beneficiario_ww 
	;
	 
	if (nm_beneficiario_ww = ' ') then 
		nm_beneficiario_w	:= substr(nm_beneficiario_w,1,length(nm_beneficiario_w)-1);
	end if;
 
	begin 
	insert into sib_devolucao_cco(	nr_sequencia, 
					nr_seq_lote, 
					dt_atualizacao, 
					nm_usuario, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec, 
					nr_seq_interno, 
					ie_registro, 
					cd_motivo, 
					cd_usuario_plano, 
					nm_beneficiario, 
					dt_nascimento, 
					cd_usuario_plano_ant, 
					nr_cco, 
					ie_digito_cco) 
				values (	nextval('sib_devolucao_cco_seq'), 
					nr_seq_lote_sib_p, 
					clock_timestamp(), 
					nm_usuario_p, 
					clock_timestamp(), 
					nm_usuario_p, 
					nr_seq_interno_w, 
					ie_registro_w, 
					cd_motivo_w, 
					cd_usuario_plano_w, 
					nm_beneficiario_w, 
					dt_nascimento_w, 
					cd_usuario_plano_ant_w, 
					nr_cco_w, 
					ie_dig_verificador_w);
	exception 
	when others then 
		/*aaschlote 11/05/2011 OS - 317669*/
 
		CALL sib_gravar_log_devolucao(nr_seq_lote_sib_p,'C',nr_seq_interno_w,'Erro ao importrar o arquivo: ' || sqlerrm(SQLSTATE), 
					cd_estabelecimento_p,nm_usuario_p);
	end;
	commit;
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sib_importar_dev_cco ( nr_seq_lote_sib_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

