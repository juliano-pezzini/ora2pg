-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_reaj_regra_apropriacao ( nr_seq_reajuste_p bigint, nm_usuario_p text, ie_commit_p text) AS $body$
DECLARE


nr_seq_tabela_w			pls_tabela_preco.nr_sequencia%type;
nr_seq_regra_apropriacao_w	pls_regra_apropriacao.nr_sequencia%type;
dt_reajuste_w			pls_reajuste.dt_reajuste%type;
nr_seq_reajuste_w		pls_reajuste.nr_sequencia%type;
nr_seq_regra_aprop_nova_w	pls_regra_apropriacao.nr_sequencia%type;
nr_seq_preco_w			pls_plano_preco.nr_sequencia%type;
vl_apropriacao_w		pls_regra_apropriacao_item.vl_apropriacao%type;
tx_reajuste_w			pls_reajuste.tx_reajuste%type;
vl_preco_atual_w		pls_plano_preco.vl_preco_atual%type;
nr_seq_aprop_item_w		pls_regra_apropriacao_item.nr_sequencia%type;
nr_seq_aprop_ultimo_item_w	pls_regra_apropriacao_item.nr_sequencia%type;
vl_apropriacao_preco_w		pls_regra_apropriacao_item.vl_apropriacao%type;

C01 CURSOR FOR
	SELECT	b.nr_seq_tabela,
		a.dt_reajuste,
		a.nr_sequencia,
		a.tx_reajuste
	from	pls_reajuste		a,
		pls_reajuste_tabela	b
	where	a.nr_sequencia		= nr_seq_reajuste_p
	and	b.nr_seq_reajuste	= a.nr_sequencia;

C02 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_regra_apropriacao
	where	nr_seq_tabela	= nr_seq_tabela_w
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	coalesce(dt_fim_vigencia::text, '') = '';

C03 CURSOR FOR
	SELECT	nr_sequencia,
		vl_preco_atual
	from	pls_plano_preco
	where	nr_seq_tabela	= nr_seq_tabela_w;

C04 CURSOR FOR
	SELECT	nr_seq_centro_apropriacao,
		vl_apropriacao,
		tx_apropriacao,
		ie_permite_reajustar
	from	pls_regra_apropriacao_item
	where	nr_seq_apropriacao	= nr_seq_regra_apropriacao_w
	and	nr_seq_preco		= nr_seq_preco_w;

c04_w	C04%RowType;


BEGIN

open C01;
loop
fetch C01 into
	nr_seq_tabela_w,
	dt_reajuste_w,
	nr_seq_reajuste_w,
	tx_reajuste_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	open C02;
	loop
	fetch C02 into
		nr_seq_regra_apropriacao_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		select	nextval('pls_regra_apropriacao_seq')
		into STRICT	nr_seq_regra_aprop_nova_w
		;

		insert into pls_regra_apropriacao(	nr_sequencia,
					nr_seq_plano,
					nr_seq_tabela,
					nr_seq_classif_dependencia,
					nr_seq_contrato,
					nr_seq_reajuste,
					dt_inicio_vigencia,
					dt_fim_vigencia,
					dt_liberacao,
					nm_usuario_liberacao,
					nm_usuario,
					nm_usuario_nrec,
					dt_atualizacao,
					dt_atualizacao_nrec)
				SELECT	nr_seq_regra_aprop_nova_w,
					nr_seq_plano,
					nr_seq_tabela,
					nr_seq_classif_dependencia,
					nr_seq_contrato,
					nr_seq_reajuste_w,
					dt_reajuste_w,
					null,
					clock_timestamp(),
					nm_usuario_p,
					nm_usuario_p,
					nm_usuario_p,
					clock_timestamp(),
					clock_timestamp()
				from	pls_regra_apropriacao
				where	nr_sequencia	= nr_seq_regra_apropriacao_w;

		update	pls_regra_apropriacao
		set	dt_fim_vigencia	= (dt_reajuste_w - 1),
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp()
		where	nr_sequencia	= nr_seq_regra_apropriacao_w;

		open C03;
		loop
		fetch C03 into
			nr_seq_preco_w,
			vl_preco_atual_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			nr_seq_aprop_ultimo_item_w	:= null;
			vl_apropriacao_preco_w		:= 0;

			open C04;
			loop
			fetch C04 into
				c04_w;
			EXIT WHEN NOT FOUND; /* apply on C04 */
				begin
				select	nextval('pls_regra_apropriacao_item_seq')
				into STRICT	nr_seq_aprop_item_w
				;

				if (c04_w.vl_apropriacao IS NOT NULL AND c04_w.vl_apropriacao::text <> '') and (c04_w.ie_permite_reajustar = 'S') then
					vl_apropriacao_w := c04_w.vl_apropriacao + ((tx_reajuste_w / 100) * c04_w.vl_apropriacao);
					nr_seq_aprop_ultimo_item_w	:= nr_seq_aprop_item_w;
				else
					vl_apropriacao_w := c04_w.vl_apropriacao;
				end if;

				insert into pls_regra_apropriacao_item(	nr_sequencia,
								nr_seq_apropriacao,
								nr_seq_preco,
								nr_seq_centro_apropriacao,
								vl_apropriacao,
								tx_apropriacao,
								ie_permite_reajustar,
								nm_usuario,
								nm_usuario_nrec,
								dt_atualizacao,
								dt_atualizacao_nrec)
				values (	nr_seq_aprop_item_w,
								nr_seq_regra_aprop_nova_w,
								nr_seq_preco_w,
								c04_w.nr_seq_centro_apropriacao,
								vl_apropriacao_w,
								c04_w.tx_apropriacao,
								c04_w.ie_permite_reajustar,
								nm_usuario_p,
								nm_usuario_p,
								clock_timestamp(),
								clock_timestamp());

				vl_apropriacao_preco_w	:= vl_apropriacao_preco_w + coalesce(vl_apropriacao_w,0);
				end;
			end loop;
			close C04;

			if (vl_apropriacao_preco_w <> vl_preco_atual_w) and (vl_apropriacao_preco_w <> 0) then
				update	pls_regra_apropriacao_item
				set	vl_apropriacao	= vl_apropriacao + (vl_preco_atual_w - vl_apropriacao_preco_w)
				where	nr_sequencia	= nr_seq_aprop_ultimo_item_w;
			end if;
			end;
		end loop;
		close C03;
		end;
	end loop;
	close C02;
	end;
end loop;
close C01;

if (coalesce(ie_commit_p,'N') = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_reaj_regra_apropriacao ( nr_seq_reajuste_p bigint, nm_usuario_p text, ie_commit_p text) FROM PUBLIC;

