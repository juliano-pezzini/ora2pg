-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_barras_integracao (nr_seq_doacao_p bigint, cd_pessoa_fisica_p text default null, cd_estabelecimento_p bigint DEFAULT NULL) AS $body$
DECLARE


ie_possui_barras_w		varchar(1);
cd_regional_w			varchar(3);
cd_pessoa_fisica_w		varchar(7);
nr_sequencia_w			varchar(7);
qt_doacao_w			varchar(3) := 0;
cd_barras_intergracao_w		varchar(20);
ds_valor_param_331_w		varchar(255);
ds_valor_param_375_w		varchar(255);
cd_pessoa_doacao_w		varchar(10);
cd_estabelecimento_w		smallint;


BEGIN
ds_valor_param_331_w :=  obter_valor_param_usuario(450, 331, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento);
ds_valor_param_375_w :=  obter_valor_param_usuario(450, 375, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento);

select	CASE WHEN coalesce(cd_barras_integracao, '')='' THEN  'N'  ELSE 'S' END
into STRICT	ie_possui_barras_w
from	san_doacao
where	nr_sequencia	= nr_seq_doacao_p;

if (ie_possui_barras_w = 'N') then
	begin

	cd_estabelecimento_w := cd_estabelecimento_p;
	if (coalesce(cd_estabelecimento_w::text, '') = '') then
		cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
	end if;

	--Código Regional
	select	substr(lpad(max(cd_regional), 3,0), 1,3)
	into STRICT	cd_regional_w
	from	san_parametro
	where	cd_estabelecimento	= cd_estabelecimento_w;

	--Código de Pessoa Física / Seq. Doação
	select	lpad(cd_pessoa_fisica, 7,0),
		lpad(nr_sequencia, 7,0),
		cd_pessoa_fisica
	into STRICT	cd_pessoa_fisica_w,
		nr_sequencia_w,
		cd_pessoa_doacao_w
	from	san_doacao
	where	nr_sequencia	= nr_seq_doacao_p;


	--Quantidade de Doações
	select	lpad(count(*), 3,0)
	into STRICT	qt_doacao_w
	from	san_doacao
	where	cd_pessoa_fisica	= cd_pessoa_doacao_w
	and	nr_sequencia <= nr_seq_doacao_p;


	if (ds_valor_param_375_w = 'S') then
		qt_doacao_w	:= lpad(qt_doacao_w + 1,3,0);
	end if;


	if (ds_valor_param_331_w = 'H') then
		begin
		cd_barras_intergracao_w	:= cd_regional_w || cd_pessoa_fisica_w || nr_sequencia_w || qt_doacao_w;
		end;
	elsif (ds_valor_param_331_w = 'I') then
		begin
		cd_barras_intergracao_w	:= cd_regional_w || nr_sequencia_w || qt_doacao_w;
		end;
	elsif (ds_valor_param_331_w = 'J') then
		begin
		cd_barras_intergracao_w	:= cd_regional_w || cd_pessoa_fisica_w || nr_sequencia_w;
		end;
	elsif (ds_valor_param_331_w = 'B') then
		cd_barras_intergracao_w	:= obter_isbt_doador(nr_seq_doacao_p, null, 'I');
	end if;

	update	san_doacao
	set	cd_barras_integracao	= cd_barras_intergracao_w
	where	nr_sequencia		= nr_seq_doacao_p;
	commit;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_barras_integracao (nr_seq_doacao_p bigint, cd_pessoa_fisica_p text default null, cd_estabelecimento_p bigint DEFAULT NULL) FROM PUBLIC;

