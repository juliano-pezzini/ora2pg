-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_insert_evt_glosa_2904 () AS $body$
DECLARE


 nr_seq_w 		bigint;
 cd_estab_w 		estabelecimento.cd_estabelecimento%type;
 ie_ctrl_estab_w	pls_controle_estab.ie_ocorrencia%type;

C01 CURSOR FOR
	SELECT	cd_estabelecimento
	from	estabelecimento
	where	ie_ctrl_estab_w	= 'S'
	
union all

	SELECT	cd_estabelecimento
	from	estabelecimento
	where	coalesce(ie_ctrl_estab_w,'N')= 'N'
	and	cd_estabelecimento	= (select max(cd_estabelecimento)
					   from	  pls_outorgante);

BEGIN

CALL tasy_posicionar_sequence('PLS_GLOSA_EVENTO','NR_SEQUENCIA','R'); -- Para clientes novos com problema de reposicionamento, OSs 2538941, 2443814, 2391597, 2269233
	select	max(ie_ocorrencia)
	into STRICT	ie_ctrl_estab_w
	from	pls_controle_estab;
					

	select 	max(nr_sequencia)
	into STRICT 	nr_seq_w
	from 	TISS_MOTIVO_GLOSA
	where 	cd_motivo_tiss = '2904';

	for r_c01_w in c01 loop
  
		insert into PLS_GLOSA_EVENTO(	NR_SEQUENCIA, DT_ATUALIZACAO, NM_USUARIO, DT_ATUALIZACAO_NREC, 
						NM_USUARIO_NREC, NR_SEQ_MOTIVO_GLOSA, IE_EVENTO, IE_PLANO, IE_PLANO_VERSAO, 
						IE_VAI_VERSAO, CD_MOTIVO_TISS, CD_ESTABELECIMENTO)
			  values (	nextval('pls_glosa_evento_seq'), clock_timestamp(), 'Tasy', clock_timestamp() , 'tasy', nr_seq_w, 
					'RG', 'S', 'N', 'N', '2904', r_c01_w.cd_estabelecimento);
	
	end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_insert_evt_glosa_2904 () FROM PUBLIC;

