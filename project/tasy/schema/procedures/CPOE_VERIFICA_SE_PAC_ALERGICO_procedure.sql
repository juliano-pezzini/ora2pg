-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_verifica_se_pac_alergico ( cd_pessoa_fisica_p text, cd_material_p bigint, ie_alergico_p INOUT text, ds_mensagem_p INOUT text, ie_severidade_p INOUT paciente_alergia.ie_intensidade%type, nr_seq_reacao_p INOUT paciente_alergia.nr_seq_reacao%type, ie_restringe_classif_p text, nr_seq_ficha_tecnica_p INOUT paciente_alergia.nr_seq_ficha_tecnica%type) AS $body$
DECLARE

						

nr_seq_dcb_w				medic_ficha_tecnica.nr_seq_dcb%type;
nr_seq_ficha_tecnica_w		material.nr_seq_ficha_tecnica%type;		
nr_seq_ficha_deriv_w			bigint;	
nr_seq_ficha_tecnica_ww			bigint;	
nr_seq_superior_w				bigint;		
cd_classe_material_w		material.cd_classe_material%type;
cd_classe_mat_w				material.cd_classe_material%type;
ie_alergico_w				varchar(1);
ie_possui_regra_w			bigint;
qt_ficha_tec_mat_w			bigint;
qt_dcb_w					bigint;
qt_dcb_ficha_w				bigint;
qt_classe_material_w			bigint;
ie_liberar_hist_saude_w		varchar(1);
cd_material_w				integer;
nr_sequencia_dcb_w			bigint;
qt_alergia_w				bigint;
ds_user_locale_w			varchar(15);
nr_seq_ficha_sup_w			medic_ficha_tecnica.nr_sequencia%type;
ds_ficha_tecnica_w			varchar(255);
ds_ficha_derivado_w			varchar(255);
nr_seq_familia_w			material.nr_seq_familia%type;
ds_derivados_ficha_medica_w		varchar(255);
cd_classe_message_w			material.cd_classe_material%type;
nr_seq_paciente_alergia_w	paciente_alergia.nr_sequencia%type;
nr_seq_reacao_w				paciente_alergia.nr_seq_reacao%type;
ie_severidade_w				paciente_alergia.ie_intensidade%type;
ie_restringe_classif_w		paciente_alergia.ie_classificacao%type;
nr_seq_ficha_tec_princ_ativo_w	paciente_alergia.nr_seq_ficha_tecnica%type;

	
C02 CURSOR FOR	
	SELECT	nr_seq_ficha_tecnica,
		nr_seq_dcb,
		cd_material,
		cd_classe_mat,
		ie_intensidade,
		nr_seq_reacao
	from	paciente_alergia
	where	cd_pessoa_fisica = cd_pessoa_fisica_p
	and 	coalesce(ie_nega_alergias,'N') = 'N'
	and	coalesce(dt_fim::text, '') = ''
	and	coalesce(dt_inativacao::text, '') = ''
	and	((ie_liberar_hist_saude_w = 'N') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> ''))
	and	coalesce(ie_classificacao, 'A') = CASE WHEN ie_restringe_classif_w='N' THEN  coalesce(ie_classificacao, 'A')  ELSE ie_restringe_classif_w END;

C03 CURSOR FOR
	SELECT	a.nr_seq_dcb
	from	material_dcb a
	where	a.cd_material in (	SELECT	cd_material_w
								
union

								select	b.cd_material_generico from	material b	where	b.cd_material = cd_material_w
								
union

								select	b.cd_material from	material b	where	b.cd_material_generico = cd_material_w)
	
union

	select	b.nr_seq_dcb
	from	medic_ficha_tecnica b,
		material a,
		table(lista_pck.obter_lista(ds_derivados_ficha_medica_w)) x
	where	a.nr_seq_ficha_tecnica = x.nr_registro
	and (a.nr_seq_ficha_tecnica	= b.nr_sequencia or
			 a.nr_seq_ficha_tecnica = b.nr_seq_superior)
  and coalesce(b.ie_situacao, 'A') = 'A'
	
union

	select	b.nr_seq_dcb
	from	medic_ficha_tecnica b,
			material a
	where (a.cd_material in (	select	cd_material_w 
								
union

								select	b.cd_material_generico from	material b where	b.cd_material = cd_material_w
								
union

								select	b.cd_material from	material b where	b.cd_material_generico = cd_material_w))
	and (a.nr_seq_ficha_tecnica	= b.nr_sequencia or
			 a.nr_seq_ficha_tecnica = b.nr_seq_superior)
  and coalesce(b.ie_situacao, 'A') = 'A';	
			
C04 CURSOR FOR
	SELECT	a.nr_seq_medic_ficha_tecnica,
			b.nr_seq_dcb,
			b.nr_sequencia
	from	material_princ_ativo a,
			medic_ficha_tecnica b
	where	a.nr_seq_medic_ficha_tecnica = b.nr_sequencia
	and		a.cd_material = cd_material_p
  and coalesce(b.ie_situacao, 'A') = 'A';		

c05 CURSOR FOR
	SELECT	nr_seq_derivado
	from	medic_ficha_deriv_ger
	where	nr_seq_ficha_sup = nr_seq_ficha_sup_w;	

procedure obter_se_pac_alergico is;
BEGIN
	if (nr_seq_paciente_alergia_w > 0) then
		select	max(ie_intensidade),
				coalesce(max(nr_seq_reacao), 0),
				coalesce(max(nr_seq_ficha_tecnica), 0)
		into STRICT	ie_severidade_w,
				nr_seq_reacao_w,
				nr_seq_ficha_tec_princ_ativo_w
		from	paciente_alergia
		where	nr_sequencia = nr_seq_paciente_alergia_w;

		ie_alergico_w := 'S';
	else
		ie_alergico_w := 'N';
	end if;
end;

function obter_texto_conforme_classif(cd_texto_p in number, vl_macros_p in varchar2) return;
begin
	if (ie_restringe_classif_w <> 'I') then
		ds_mensagem_w := wheb_mensagem_pck.get_texto(cd_texto_p, vl_macros_p);
	elsif (cd_texto_p = 1125890) then
		ds_mensagem_w := wheb_mensagem_pck.get_texto(1198483, vl_macros_p);
	elsif (cd_texto_p = 1125463) then
		ds_mensagem_w := wheb_mensagem_pck.get_texto(1198487, vl_macros_p);
	elsif (cd_texto_p = 1148482) then
		ds_mensagem_w := wheb_mensagem_pck.get_texto(1198488, vl_macros_p);
	elsif (cd_texto_p = 1138710) then
		ds_mensagem_w := wheb_mensagem_pck.get_texto(1198489, vl_macros_p);
	elsif (cd_texto_p = 1147178) then
		ds_mensagem_w := wheb_mensagem_pck.get_texto(1198490, vl_macros_p);
	elsif (cd_texto_p = 319858) then
		ds_mensagem_w := wheb_mensagem_pck.get_texto(1198257, vl_macros_p);
	else
		ds_mensagem_w := wheb_mensagem_pck.get_texto(cd_texto_p, vl_macros_p);
	end if;

	return;
end;

begin
ds_user_locale_w:= obtain_user_locale(wheb_usuario_pck.get_nm_usuario);
ie_alergico_w 	:= 'N';
ds_mensagem_p	:= null;

ie_restringe_classif_w := coalesce(ie_restringe_classif_p, 'N');

select	coalesce(max(ie_liberar_hist_saude),'N')
into STRICT	ie_liberar_hist_saude_w
from	parametro_medico
where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') and (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then
	select	count(*)
	into STRICT	ie_possui_regra_w
	from	paciente_alergia
	where	cd_pessoa_fisica = cd_pessoa_fisica_p
	and 	coalesce(ie_nega_alergias,'N') = 'N'
	and		coalesce(dt_inativacao::text, '') = ''
	and		((coalesce(dt_fim::text, '') = '') or (clock_timestamp() between coalesce(dt_inicio,clock_timestamp() - interval '1 days') and dt_fim))
	and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and		coalesce(ie_classificacao, 'A') = CASE WHEN ie_restringe_classif_w='N' THEN  coalesce(ie_classificacao, 'A')  ELSE ie_restringe_classif_w END;

	if (ie_possui_regra_w > 0) then
		
		select	coalesce(max(nr_sequencia), 0)
		into STRICT	nr_seq_paciente_alergia_w
		from	paciente_alergia
		where	cd_pessoa_fisica = cd_pessoa_fisica_p
		and		cd_material = cd_material_p
		and 	coalesce(ie_nega_alergias,'N') = 'N'
		and		coalesce(dt_inativacao::text, '') = ''
		and		((coalesce(dt_fim::text, '') = '') or (clock_timestamp() between coalesce(dt_inicio,clock_timestamp() - interval '1 days') and dt_fim))
		and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and		coalesce(ie_classificacao, 'A') = CASE WHEN ie_restringe_classif_w='N' THEN  coalesce(ie_classificacao, 'A')  ELSE ie_restringe_classif_w END;

		obter_se_pac_alergico;
		
		if (ie_alergico_w = 'N') then
			select 	max(c.nr_seq_dcb),
						max(b.nr_seq_ficha_tecnica),
						max(b.cd_classe_material)
			into STRICT		nr_seq_dcb_w,
						nr_seq_ficha_tecnica_w,
						cd_classe_material_w
			from		medic_ficha_tecnica c,
						material b
			where		b.nr_seq_ficha_tecnica = c.nr_sequencia
			and		b.cd_material = cd_material_p
      and coalesce(c.ie_situacao, 'A') = 'A';
			
			if (nr_seq_ficha_tecnica_w IS NOT NULL AND nr_seq_ficha_tecnica_w::text <> '') then
			
					ds_derivados_ficha_medica_w	:=  obter_derivados_ficha_medica(nr_seq_ficha_tecnica_w);
			
					select	coalesce(max(nr_sequencia), 0)
					into STRICT	nr_seq_paciente_alergia_w
					from		paciente_alergia
					where		cd_pessoa_fisica = cd_pessoa_fisica_p
					and 		coalesce(ie_nega_alergias,'N') = 'N'
					and		Obter_Se_Contido(nr_seq_ficha_tecnica,ds_derivados_ficha_medica_w) = 'S'
					and		coalesce(dt_inativacao::text, '') = ''
					and		((coalesce(dt_fim::text, '') = '') or (clock_timestamp() between coalesce(dt_inicio,clock_timestamp() - interval '1 days') and dt_fim))
					and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
					and		coalesce(ie_classificacao, 'A') = CASE WHEN ie_restringe_classif_w='N' THEN  coalesce(ie_classificacao, 'A')  ELSE ie_restringe_classif_w END;

					obter_se_pac_alergico;
			
					if (ie_alergico_w = 'N') then
					
						select	coalesce(max(a.nr_seq_superior),0),
									coalesce(max(a.nr_sequencia),0),
									coalesce(max(a.nr_seq_dcb),0)
						into STRICT		nr_seq_superior_w,
									nr_seq_ficha_deriv_w,
									nr_seq_dcb_w
						from		medic_ficha_tecnica a
						where		a.nr_sequencia	= nr_seq_ficha_tecnica_w
						and		(a.nr_seq_superior IS NOT NULL AND a.nr_seq_superior::text <> '')
            and coalesce(a.ie_situacao, 'A') = 'A';
						
							if (nr_seq_superior_w > 0) then
								select	coalesce(max(nr_sequencia), 0)
								into STRICT	nr_seq_paciente_alergia_w
								from		paciente_alergia
								where		cd_pessoa_fisica = cd_pessoa_fisica_p
								and		nr_seq_ficha_tecnica = nr_seq_superior_w
								and 	coalesce(ie_nega_alergias,'N') = 'N'
								and		coalesce(dt_inativacao::text, '') = ''
								and		((coalesce(dt_fim::text, '') = '') or (clock_timestamp() between coalesce(dt_inicio,clock_timestamp() - interval '1 days') and dt_fim))
								and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
								and		coalesce(ie_classificacao, 'A') = CASE WHEN ie_restringe_classif_w='N' THEN  coalesce(ie_classificacao, 'A')  ELSE ie_restringe_classif_w END;

								obter_se_pac_alergico;
						
									if (nr_seq_ficha_deriv_w > 0) and (ie_alergico_w = 'N') then
										
										select	count(*)
										into STRICT	qt_ficha_tec_mat_w
										from	material a
										where	a.cd_material in (SELECT	cd_material_p
														
														
union

														SELECT	b.cd_material_generico
														from	material b
														where	b.cd_material = cd_material_p
														
union

														select	b.cd_material
														from	material b
														where	b.cd_material_generico = cd_material_p)
										and	a.nr_seq_ficha_tecnica	= nr_seq_ficha_deriv_w;
							
										if (qt_ficha_tec_mat_w > 0) then
											select	coalesce(max(nr_sequencia), 0)
											into STRICT	nr_seq_paciente_alergia_w
											from		paciente_alergia
											where		cd_pessoa_fisica = cd_pessoa_fisica_p
											and		nr_seq_ficha_tecnica = nr_seq_ficha_deriv_w
											and 	coalesce(ie_nega_alergias,'N') = 'N'
											and		coalesce(dt_inativacao::text, '') = ''
											and		((coalesce(dt_fim::text, '') = '') or (clock_timestamp() between coalesce(dt_inicio,clock_timestamp() - interval '1 days') and dt_fim))
											and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
											and		coalesce(ie_classificacao, 'A') = CASE WHEN ie_restringe_classif_w='N' THEN  coalesce(ie_classificacao, 'A')  ELSE ie_restringe_classif_w END;

											obter_se_pac_alergico;
										end if;
									end if;
								
								if (nr_seq_dcb_w > 0) and (ie_alergico_w = 'N') then
									
									select	count(*)
									into STRICT	qt_dcb_w
									from	material_dcb a
									where	a.cd_material in (SELECT	cd_material_p
													
													
union

													SELECT	b.cd_material_generico
													from	material b
													where	b.cd_material = cd_material_p
													
union

													select	b.cd_material
													from	material b
													where	b.cd_material_generico = cd_material_p)
									and	a.nr_seq_dcb	= nr_seq_dcb_w;
						
									select	count(*)
									into STRICT	qt_dcb_ficha_w
									from	medic_ficha_tecnica b,
										material a
									where	a.cd_material in (SELECT	cd_material_p
													
													
union

													SELECT	b.cd_material_generico
													from	material b
													where	b.cd_material = cd_material_p
													
union

													select	b.cd_material
													from	material b
													where	b.cd_material_generico = cd_material_p)
									and	a.nr_seq_ficha_tecnica	= b.nr_sequencia
									and	b.nr_seq_dcb		= nr_seq_dcb_w
                  and coalesce(b.ie_situacao, 'A') = 'A';
						
									if (qt_dcb_w > 0) or (qt_dcb_ficha_w > 0) then
										select	coalesce(max(nr_sequencia), 0)
										into STRICT	nr_seq_paciente_alergia_w
										from	paciente_alergia
										where	cd_pessoa_fisica = cd_pessoa_fisica_p
										and		nr_seq_dcb = nr_seq_dcb_w
										and 	coalesce(ie_nega_alergias,'N') = 'N'
										and		coalesce(dt_inativacao::text, '') = ''
										and		((coalesce(dt_fim::text, '') = '') or (clock_timestamp() between coalesce(dt_inicio,clock_timestamp() - interval '1 days') and dt_fim))
										and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
										and		coalesce(ie_classificacao, 'A') = CASE WHEN ie_restringe_classif_w='N' THEN  coalesce(ie_classificacao, 'A')  ELSE ie_restringe_classif_w END;

										obter_se_pac_alergico;
									end if;

								end if;
								if (cd_classe_material_w > 0) and (ie_alergico_w = 'N') and (pkg_i18n.get_user_locale() = 'en_AU') then

									select	count(*)
									into STRICT	qt_classe_material_w
									from	material a
									where	a.cd_material in (SELECT	cd_material_p
													
													
union

													SELECT	b.cd_material_generico
													from	material b
													where	b.cd_material = cd_material_p
													
union

													select	b.cd_material
													from	material b
													where	b.cd_material_generico = cd_material_p)
									and	a.cd_classe_material		= cd_classe_material_w;

									if (qt_classe_material_w > 0) then
										select	coalesce(max('S'),'N')
										into STRICT	ie_alergico_w
										from	paciente_alergia
										where	cd_pessoa_fisica = cd_pessoa_fisica_p
										and		cd_classe_mat = cd_classe_material_w
										and 	coalesce(ie_nega_alergias,'N') = 'N'
										and		coalesce(dt_inativacao::text, '') = ''
										and		((coalesce(dt_fim::text, '') = '') or (clock_timestamp() between coalesce(dt_inicio,clock_timestamp() - interval '1 days') and dt_fim))
										and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');	
									end if;
								end if;
							else
								for r_c02 in C02 loop								
									begin
										nr_seq_ficha_tecnica_w := r_c02.nr_seq_ficha_tecnica;
										if (coalesce(nr_seq_ficha_tecnica_w,0) = 0) then
											select	max(nr_seq_ficha_tecnica)
											into STRICT	nr_seq_ficha_tecnica_w
											from	material
											where	cd_material = r_c02.cd_material;
										end if;									
										
										select	coalesce(max(a.nr_seq_dcb),0)
										into STRICT	nr_sequencia_dcb_w
										from	medic_ficha_tecnica a
										where	a.nr_sequencia	= nr_seq_ficha_tecnica_w
                    and coalesce(a.ie_situacao, 'A') = 'A';
										
										if (nr_sequencia_dcb_w > 0) then
											select	count(*)
											into STRICT	qt_ficha_tec_mat_w
											from	material_dcb a
											where	a.cd_material in (SELECT	cd_material_p
															
															
union

															SELECT	b.cd_material_generico
															from	material b
															where	b.cd_material = cd_material_p
															
union

															select	b.cd_material
															from	material b
															where	b.cd_material_generico = cd_material_p)
											and	a.nr_seq_dcb	= nr_sequencia_dcb_w;										
											
											
											if (qt_ficha_tec_mat_w > 0) then
												ie_alergico_w	:= 'S';
												ie_severidade_w	:= r_c02.ie_intensidade;
												nr_seq_reacao_w	:= r_c02.nr_seq_reacao;
												exit;
											end if;									
										end if;								
										
										if (ie_alergico_w = 'N') then
											nr_seq_dcb_w := r_c02.nr_seq_dcb;
											if (coalesce(nr_seq_dcb_w,0) = 0) then
												select	coalesce(max(a.nr_seq_dcb),0)
												into STRICT	nr_seq_dcb_w
												from	medic_ficha_tecnica a
												where	a.nr_sequencia	= nr_seq_ficha_tecnica_w
                        and coalesce(a.ie_situacao, 'A') = 'A';
											end if;						

											if (nr_seq_dcb_w > 0) then
												select	count(*)
												into STRICT	qt_dcb_w
												from	material_dcb a
												where	a.cd_material in (SELECT	cd_material_p
																
																
union

																SELECT	b.cd_material_generico
																from	material b
																where	b.cd_material = cd_material_p
																
union

																select	b.cd_material
																from	material b
																where	b.cd_material_generico = cd_material_p)
												and	a.nr_seq_dcb	= nr_seq_dcb_w;

												select	count(*)
												into STRICT	qt_dcb_ficha_w
												FROM material a, medic_ficha_tecnica c
LEFT OUTER JOIN medic_ficha_tecnica b ON (c.nr_seq_superior = b.nr_sequencia)
WHERE a.cd_material in (SELECT	cd_material_p
																
																
union

																SELECT	b.cd_material_generico
																from	material b
																where	b.cd_material = cd_material_p
																
union

																select	b.cd_material
																from	material b
																where	b.cd_material_generico = cd_material_p) and a.nr_seq_ficha_tecnica	= b.nr_sequencia  and (b.nr_seq_dcb		= nr_seq_dcb_w or
													c.nr_seq_dcb		= nr_seq_dcb_w) and coalesce(c.ie_situacao, 'A') = 'A' and coalesce(b.ie_situacao, 'A') = 'A';


												if (qt_dcb_w > 0) or (qt_dcb_ficha_w > 0) then
													ie_alergico_w	:= 'S';
													ie_severidade_w	:= r_c02.ie_intensidade;
													nr_seq_reacao_w	:= r_c02.nr_seq_reacao;
													exit;
												end if;
											end if;											
										
											cd_material_w := r_c02.cd_material;
											ds_derivados_ficha_medica_w := obter_derivados_ficha_medica(nr_seq_ficha_tecnica_w);
											
											for r_c03 in c03 loop
												begin
													select	count(*)
													into STRICT	qt_dcb_w
													from	material_dcb a
													where	a.cd_material in (SELECT	cd_material_p
																	
																	
union

																	SELECT	b.cd_material_generico
																	from	material b
																	where	b.cd_material = cd_material_p
																	
union

																	select	b.cd_material
																	from	material b
																	where	b.cd_material_generico = cd_material_p)
													and		a.nr_seq_dcb	= r_c03.nr_seq_dcb;

													select	count(*)
													into STRICT	qt_dcb_ficha_w
													from	medic_ficha_tecnica b,
															material a
													where	a.cd_material in (SELECT	cd_material_p
																	
																	
union

																	SELECT	b.cd_material_generico
																	from	material b
																	where	b.cd_material = cd_material_p
																	
union

																	select	b.cd_material
																	from	material b
																	where	b.cd_material_generico = cd_material_p)
													and (a.nr_seq_ficha_tecnica	= b.nr_sequencia or
															 a.nr_seq_ficha_tecnica = b.nr_seq_superior)
													and		b.nr_seq_dcb		= r_c03.nr_seq_dcb
                          and coalesce(b.ie_situacao, 'A') = 'A';
										
													if (qt_dcb_w > 0) or (qt_dcb_ficha_w > 0) then
														ie_alergico_w	:= 'S';
														ie_severidade_w	:= r_c02.ie_intensidade;
														nr_seq_reacao_w	:= r_c02.nr_seq_reacao;
														exit;
													end if;
												end;	
											end loop;										
										end if;
										
										if (ie_alergico_w	= 'N') 	and (pkg_i18n.get_user_locale() != 'en_AU')	then
											select	max(nr_seq_ficha_tecnica)
											into STRICT	nr_seq_ficha_tecnica_ww
											from	material a
											where	a.cd_material =	cd_material_p;
											
											 ds_derivados_ficha_medica_w	:= obter_derivados_ficha_medica(nr_seq_ficha_tecnica_ww);
											
											
											if (r_c02.cd_material > 0) then
												select	count(*)
												into STRICT	qt_alergia_w
												from	medic_reacao_cruzada
												where	cd_material	= r_c02.cd_material
												and		Obter_Se_Contido(nr_seq_ficha_tecnica, ds_derivados_ficha_medica_w) = 'S';
											elsif (nr_seq_ficha_tecnica_w > 0) then
												select	count(*)
												into STRICT	qt_alergia_w
												from	material a
												where	exists (SELECT	1
																from	medic_reacao_cruzada c
																where	Obter_Se_Contido(nr_seq_ficha_tecnica, ds_derivados_ficha_medica_w) = 'S'
																and		c.cd_material in (select	cd_material
																						from	material
																						where	nr_seq_ficha_tecnica	= nr_seq_ficha_tecnica_w))
												and	a.nr_seq_ficha_tecnica	= nr_seq_ficha_tecnica_w;
											elsif (r_c02.cd_classe_mat > 0) then

												select	count(1)
												into STRICT	qt_alergia_w
												from	medic_reacao_cruzada m,
													table(lista_pck.obter_lista(ds_derivados_ficha_medica_w)) x
												where	m.nr_seq_ficha_tecnica = x.nr_registro
												and 	m.cd_material in (	SELECT 	a.cd_material
																from	material_classe_adic a
																where 	a.cd_classe_material = r_c02.cd_classe_mat
																
union all

																SELECT a.cd_material
																from material a
																where a.cd_classe_material = r_c02.cd_classe_mat);
											end if;
											
											if (qt_alergia_w > 0) then
												if (r_c02.cd_material > 0) then
													ds_mensagem_p	:= obter_texto_conforme_classif(1125890, 'CD_MATERIAL_W=' || obter_desc_material(r_c02.cd_material) ||
														';FICHA_TECNICA_W=' || substr(obter_descricao_padrao('MEDIC_FICHA_TECNICA', 'DS_SUBSTANCIA',nr_seq_ficha_tecnica_ww),1,35));
												elsif (nr_seq_ficha_tecnica_w > 0) then
													ds_mensagem_p	:= obter_texto_conforme_classif(1125890, 'CD_MATERIAL_W=' || obter_descricao_padrao('MEDIC_FICHA_TECNICA', 'DS_SUBSTANCIA',nr_seq_ficha_tecnica_w) ||
														';FICHA_TECNICA_W=' || substr(obter_descricao_padrao('MEDIC_FICHA_TECNICA', 'DS_SUBSTANCIA',nr_seq_ficha_tecnica_ww),1,35));
												elsif (r_c02.cd_classe_mat > 0) then
													ds_mensagem_p	:= obter_texto_conforme_classif(1125890, 'CD_MATERIAL_W=' || obter_descricao_padrao('CLASSE_MATERIAL', 'DS_CLASSE_MATERIAL',r_c02.cd_classe_mat) ||
														';FICHA_TECNICA_W=' || substr(obter_descricao_padrao('MEDIC_FICHA_TECNICA', 'DS_SUBSTANCIA',nr_seq_ficha_tecnica_ww),1,35));
												end if;
												ie_alergico_w	:= 'S';
												ie_severidade_w	:= r_c02.ie_intensidade;
												nr_seq_reacao_w	:= r_c02.nr_seq_reacao;
											end if;
										end if;
										
										if (ie_alergico_w = 'N') and (pkg_i18n.get_user_locale() = 'en_AU') then

											if (r_c02.cd_material > 0) then
												select	max(cd_classe_material)
												into STRICT	cd_classe_material_w
												from	material
												where	cd_material = r_c02.cd_material;

												select	count(*)
												into STRICT	qt_classe_material_w
												from	material a
												where	a.cd_material in (SELECT	cd_material_p
																
																
union

																SELECT	b.cd_material_generico
																from	material b
																where	b.cd_material = cd_material_p
																
union

																select	b.cd_material
																from	material b
																where	b.cd_material_generico = cd_material_p)
												and	a.cd_classe_material		= cd_classe_material_w;
											
											

												if (qt_classe_material_w = 0) then

													select	count(*)
													into STRICT	qt_classe_material_w
													from	material_classe_adic a
													where	a.cd_material =  cd_material_p
													and 	a.cd_classe_material = cd_classe_material_w;
													
													if (qt_classe_material_w = 0) then
														select	count(*)
														into STRICT	qt_classe_material_w
														from	material_classe_adic a
														where	a.cd_material =  cd_material_p
														and 	a.cd_classe_material in (	SELECT	cd_classe_material
																			from	material_classe_adic
																			where	cd_material = r_c02.cd_material);
													end if;

												end if;
											elsif (nr_seq_ficha_tecnica_w > 0) then
												ds_derivados_ficha_medica_w := obter_derivados_ficha_medica(nr_seq_ficha_tecnica_w);


												
												select	count(*),
													min(cd_classe_material)
												into STRICT	qt_classe_material_w,
													cd_classe_message_w
												from	material_classe_adic a
												where	a.cd_material =  cd_material_p
												and	a.cd_classe_material in (	SELECT	distinct c.cd_classe_material
																	from	medic_ficha_tecnica b,
																		material a,
																		material_classe_adic c,
																		table(lista_pck.obter_lista(ds_derivados_ficha_medica_w)) x
																	where	a.nr_seq_ficha_tecnica = x.nr_registro
																	and 	a.cd_material = c.cd_material
																	and (a.nr_seq_ficha_tecnica	= b.nr_sequencia)
                                  and coalesce(b.ie_situacao, 'A') = 'A'
																	
union

																	SELECT	distinct c.cd_classe_material
																	from	medic_ficha_tecnica b,
																		material a,
																		material_classe_adic c,
																		table(lista_pck.obter_lista(ds_derivados_ficha_medica_w)) x
																	where	a.nr_seq_ficha_tecnica = x.nr_registro
																	and 	a.cd_material = c.cd_material
																	and ( a.nr_seq_ficha_tecnica = b.nr_seq_superior)
                                  and coalesce(b.ie_situacao, 'A') = 'A');
																	
												
												if (qt_classe_material_w = 0) then
													select	count(*),
														min(cd_classe_material)
													into STRICT	qt_classe_material_w,
														cd_classe_message_w
													from	material_classe_adic a
													where	a.cd_material =  cd_material_p
													and	a.cd_classe_material in (	SELECT	distinct a.cd_classe_material
																		from	medic_ficha_tecnica b,
																			material a,
																			table(lista_pck.obter_lista(ds_derivados_ficha_medica_w)) x
																		where	a.nr_seq_ficha_tecnica = x.nr_registro
																		and (a.nr_seq_ficha_tecnica	= b.nr_sequencia)
                                    and coalesce(b.ie_situacao, 'A') = 'A'
																		
union

																		SELECT	distinct a.cd_classe_material
																		from	medic_ficha_tecnica b,
																			material a,
																			table(lista_pck.obter_lista(ds_derivados_ficha_medica_w)) x
																		where	a.nr_seq_ficha_tecnica = x.nr_registro
																		and (a.nr_seq_ficha_tecnica = b.nr_seq_superior)
                                    and coalesce(b.ie_situacao, 'A') = 'A');

												end if;
												
												if (qt_classe_material_w = 0) then

													select	count(*),
														min(cd_classe_material)
													into STRICT	qt_classe_material_w,
														cd_classe_message_w
													from	material a
													where	a.cd_material in ( 	SELECT	cd_material_p
																	
																	
union

																	SELECT	b.cd_material_generico
																	from	material b
																	where	b.cd_material = cd_material_p
																	
union

																	select	b.cd_material
																	from	material b
																	where	b.cd_material_generico = cd_material_p)
													and	a.cd_classe_material in (	select	distinct a.cd_classe_material
																		from	medic_ficha_tecnica b,
																			material a,
																			table(lista_pck.obter_lista(ds_derivados_ficha_medica_w)) x
																		where	a.nr_seq_ficha_tecnica = x.nr_registro
																		and (a.nr_seq_ficha_tecnica	= b.nr_sequencia )
                                    and coalesce(b.ie_situacao, 'A') = 'A'
																		
union

																		select	distinct a.cd_classe_material
																		from	medic_ficha_tecnica b,
																			material a,
																			table(lista_pck.obter_lista(ds_derivados_ficha_medica_w)) x
																		where	a.nr_seq_ficha_tecnica = x.nr_registro
																		and (a.nr_seq_ficha_tecnica = b.nr_seq_superior)
                                    and coalesce(b.ie_situacao, 'A') = 'A');

												end if;
											end if;
											
											

											if (qt_classe_material_w > 0) then
												if (r_c02.cd_material > 0) then
													ds_mensagem_p	:= obter_texto_conforme_classif(1125463, 'CD_MATERIAL_W=' || substr(obter_desc_material(cd_material_p),1,35) ||
														';CD_MATERIAL_ALERGICO_W=' || substr(obter_desc_material(r_c02.cd_material),1,35));
												elsif (cd_classe_message_w IS NOT NULL AND cd_classe_message_w::text <> '') then
												
													if (r_c02.nr_seq_ficha_tecnica IS NOT NULL AND r_c02.nr_seq_ficha_tecnica::text <> '') then
														ds_mensagem_p	:= obter_texto_conforme_classif(1148482, 'DS_MATERIAL=' || obter_desc_material(cd_material_p) ||
																';FICHA_TECNICA_W=' || obter_descricao_padrao('MEDIC_FICHA_TECNICA', 'DS_SUBSTANCIA',r_c02.nr_seq_ficha_tecnica)||
																';DS_CLASSE_MATERIAL_W=' || obter_descricao_padrao('CLASSE_MATERIAL', 'DS_CLASSE_MATERIAL',cd_classe_message_w));
													
													else
														ds_mensagem_p	:= obter_texto_conforme_classif(1147178, 'DS_MATERIAL=' || obter_desc_material(cd_material_p) ||
																';DS_CLASSE_MATERIAL_W=' || obter_descricao_padrao('CLASSE_MATERIAL', 'DS_CLASSE_MATERIAL',cd_classe_message_w));

													end if;					
												else
													ds_mensagem_p	:= obter_texto_conforme_classif(1138710, 'DS_MATERIAL=' || trim(both obter_desc_material(cd_material_p)));
												end if;
												ie_alergico_w	:= 'S';
												exit;
												
											end if;

										end if;
										
									end;
								end loop;
							end if;							
					end if;			
				end if;		
		
		
			if (ie_alergico_w = 'N') then
				select 	max(c.nr_seq_dcb),
						max(b.nr_seq_ficha_tecnica),
						max(b.cd_classe_material),
						max(b.nr_seq_familia)
				into STRICT	nr_seq_dcb_w,
						nr_seq_ficha_tecnica_w,
						cd_classe_material_w,
						nr_seq_familia_w
				FROM material b
LEFT OUTER JOIN medic_ficha_tecnica c ON (b.nr_seq_ficha_tecnica = c.nr_sequencia)
WHERE b.cd_material = cd_material_p and coalesce(c.ie_situacao, 'A') = 'A';
				
				if (nr_seq_dcb_w IS NOT NULL AND nr_seq_dcb_w::text <> '') then
					select	coalesce(max(nr_sequencia), 0)
					into STRICT	nr_seq_paciente_alergia_w
					from	paciente_alergia
					where	cd_pessoa_fisica = cd_pessoa_fisica_p
					and	nr_seq_dcb = nr_seq_dcb_w
					and 	coalesce(ie_nega_alergias,'N') = 'N'
					and		coalesce(dt_inativacao::text, '') = ''
					and		((coalesce(dt_fim::text, '') = '') or (clock_timestamp() between coalesce(dt_inicio,clock_timestamp() - interval '1 days') and dt_fim))
					and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
					and		coalesce(ie_classificacao, 'A') = CASE WHEN ie_restringe_classif_w='N' THEN  coalesce(ie_classificacao, 'A')  ELSE ie_restringe_classif_w END;

					obter_se_pac_alergico;
				end if;
				
				if (ie_alergico_w = 'N') and (pkg_i18n.get_user_locale() = 'en_AU') then
					
					select	max(cd_classe_material)
					into STRICT	cd_classe_material_w
					from	material
					where	cd_material = cd_material_p;
				
					for r_c02 in c02 loop
						begin
						if (r_c02.cd_classe_mat > 0) and (ie_alergico_w = 'N') and (pkg_i18n.get_user_locale() = 'en_AU')then
							
							if (cd_classe_material_w	= r_c02.cd_classe_mat) then
								qt_classe_material_w	:= 1;
							else
							
								select	count(1)
								into STRICT	qt_classe_material_w
								from	material_classe_adic
								where	cd_material = cd_material_p
								and	cd_classe_material = r_c02.cd_classe_mat;
							end if;	
							
							if (qt_classe_material_w	> 0) then
								ie_alergico_w	:= 'S';
								ds_mensagem_p	:= obter_texto_conforme_classif(1147178, 'DS_MATERIAL=' || obter_desc_material(cd_material_p) ||
											';DS_CLASSE_MATERIAL_W=' || obter_descricao_padrao('CLASSE_MATERIAL', 'DS_CLASSE_MATERIAL',r_c02.cd_classe_mat));
								exit;
								
							end if;
						end if;
						end;
					end loop;
				
				end if;
				
				if (ie_alergico_w = 'N') then
					if (cd_classe_material_w IS NOT NULL AND cd_classe_material_w::text <> '') then
						select	coalesce(max(nr_sequencia), 0)
						into STRICT	nr_seq_paciente_alergia_w
						from	paciente_alergia
						where	cd_pessoa_fisica = cd_pessoa_fisica_p
						and	cd_classe_mat = cd_classe_material_w
						and 	coalesce(ie_nega_alergias,'N') = 'N'
						and		coalesce(dt_inativacao::text, '') = ''
						and		((coalesce(dt_fim::text, '') = '') or (clock_timestamp() between coalesce(dt_inicio,clock_timestamp() - interval '1 days') and dt_fim))
						and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
						and		coalesce(ie_classificacao, 'A') = CASE WHEN ie_restringe_classif_w='N' THEN  coalesce(ie_classificacao, 'A')  ELSE ie_restringe_classif_w END;

						obter_se_pac_alergico;
					end if;
					
					if (ie_alergico_w = 'N') then
						if (nr_seq_familia_w IS NOT NULL AND nr_seq_familia_w::text <> '') then
							select	coalesce(max(nr_sequencia), 0)
							into STRICT	nr_seq_paciente_alergia_w
							from	paciente_alergia a
							where	a.cd_pessoa_fisica = cd_pessoa_fisica_p
							and	a.nr_seq_familia = nr_seq_familia_w
							and 	coalesce(ie_nega_alergias,'N') = 'N'
							and		coalesce(a.dt_inativacao::text, '') = ''
							and		((coalesce(a.dt_fim::text, '') = '') or (clock_timestamp() between coalesce(a.dt_inicio,clock_timestamp() - interval '1 days') and a.dt_fim))
							and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
							and		coalesce(ie_classificacao, 'A') = CASE WHEN ie_restringe_classif_w='N' THEN  coalesce(ie_classificacao, 'A')  ELSE ie_restringe_classif_w END;

							obter_se_pac_alergico;
						end if;
					end if;
				end if;
				
			end if;
						
			
			if (ie_alergico_w = 'N') then
				select	coalesce(max(nr_sequencia), 0)
				into STRICT	nr_seq_paciente_alergia_w
				from	paciente_alergia
				where	cd_pessoa_fisica = cd_pessoa_fisica_p
				and 	coalesce(ie_nega_alergias,'N') = 'N'
				and	cd_classe_mat in (	SELECT	coalesce(cd_classe_material,0) from 	material_classe_adic where cd_material = cd_material_p)
				and	coalesce(dt_inativacao::text, '') = ''
				and	((coalesce(dt_fim::text, '') = '') or (clock_timestamp() between coalesce(dt_inicio,clock_timestamp() - interval '1 days') and dt_fim))
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and	coalesce(ie_classificacao, 'A') = CASE WHEN ie_restringe_classif_w='N' THEN  coalesce(ie_classificacao, 'A')  ELSE ie_restringe_classif_w END;

				obter_se_pac_alergico;
			end if;
		
		end if;
	end if;
end if;

if (ie_alergico_w = 'N' and ds_user_locale_w = 'de_DE') then
	for r_c02 in C02 loop
	begin
		for r_c04 in C04 loop
			cd_material_w 			:= r_c02.cd_material;
			nr_seq_ficha_tecnica_w 	:= r_c02.nr_seq_ficha_tecnica;
			nr_seq_ficha_sup_w 		:= r_c04.nr_sequencia;
			begin			
			if (ie_alergico_w	= 'N') then		
				if (r_c02.cd_material > 0) then
				
					select	count(*)
					into STRICT	qt_alergia_w
					from	medic_reacao_cruzada
					where	cd_material	= r_c02.cd_material
					and		nr_seq_ficha_tecnica = r_c04.nr_seq_medic_ficha_tecnica;
					
				elsif (r_c02.nr_seq_ficha_tecnica > 0) then
					select	count(*)
					into STRICT	qt_alergia_w
					from	material a
					where	exists (SELECT	1
									from	medic_reacao_cruzada c
									where	nr_seq_ficha_tecnica = r_c04.nr_seq_medic_ficha_tecnica
									and		c.cd_material in (select	cd_material
															from	material
															where	nr_seq_ficha_tecnica	= r_c02.nr_seq_ficha_tecnica))
					and	a.nr_seq_ficha_tecnica	= r_c02.nr_seq_ficha_tecnica;
					
				end if;			
				if (qt_alergia_w > 0) then
					if (r_c02.cd_material > 0) then
						ds_mensagem_p	:= wheb_mensagem_pck.get_texto(300284, 'CD_MATERIAL_W=' || substr(obter_desc_material(r_c02.cd_material),1,35) ||
							';FICHA_TECNICA_W=' || substr(obter_descricao_padrao('MEDIC_FICHA_TECNICA', 'DS_SUBSTANCIA',r_c02.nr_seq_ficha_tecnica),1,35));
					elsif (r_c02.nr_seq_ficha_tecnica > 0) then
						ds_mensagem_p	:= wheb_mensagem_pck.get_texto(300284, 'CD_MATERIAL_W=' || substr(obter_descricao_padrao('MEDIC_FICHA_TECNICA', 'DS_SUBSTANCIA',r_c02.nr_seq_ficha_tecnica),1,35) ||
							';FICHA_TECNICA_W=' || substr(obter_descricao_padrao('MEDIC_FICHA_TECNICA', 'DS_SUBSTANCIA',r_c04.nr_seq_medic_ficha_tecnica),1,35));
					end if;
					ie_alergico_w	:= 'S';
				end if;
			end if;
			if (ie_alergico_w = 'N' and r_c04.nr_seq_medic_ficha_tecnica = r_c02.nr_seq_ficha_tecnica) then
				ie_alergico_w := 'S';
				exit;
			end if;
			if (ie_alergico_w	= 'N') then
				ds_ficha_tecnica_w  := '';
				ds_ficha_derivado_w := '';
				for r_c05 in c05 loop
					if (r_c05.nr_seq_derivado = r_c02.nr_seq_ficha_tecnica) then
						ds_ficha_tecnica_w  := ds_ficha_tecnica_w || substr(obter_descricao_padrao('MEDIC_FICHA_TECNICA', 'DS_SUBSTANCIA',nr_seq_ficha_sup_w),1,35) || ', ';
						ds_ficha_derivado_w := ds_ficha_derivado_w || substr(obter_descricao_padrao('MEDIC_FICHA_TECNICA', 'DS_SUBSTANCIA',r_c05.nr_seq_derivado),1,35) || ', ';
						ie_alergico_w := 'S';
					end if;
				end loop;
				if (ds_ficha_tecnica_w IS NOT NULL AND ds_ficha_tecnica_w::text <> '') then
					ds_mensagem_p	:= wheb_mensagem_pck.get_texto(1046562, 'DS_MATERIAL=' || substr(obter_desc_material(cd_material_p),1,35) ||
							';DS_FICHA_TECNICA=' || substr(ds_ficha_tecnica_w,1,length(ds_ficha_tecnica_w) -2) ||
							';DS_FICHA_DERIVADO=' || substr(ds_ficha_derivado_w,1,length(ds_ficha_derivado_w) -2));
				end if;
			end if;
			
			if (ie_alergico_w	= 'N') then
				select	max(b.nr_seq_ficha_tecnica)
				into STRICT	nr_seq_ficha_sup_w
				from	medic_ficha_tecnica c,
						material b
				where	b.nr_seq_ficha_tecnica = c.nr_sequencia
				and		b.cd_material = cd_material_p
        and   coalesce(c.ie_situacao, 'A') = 'A';

				ds_ficha_tecnica_w  := '';
				ds_ficha_derivado_w := '';
				for r_c05 in c05 loop
					if (r_c05.nr_seq_derivado = r_c02.nr_seq_ficha_tecnica) then											
						ds_ficha_tecnica_w  := ds_ficha_tecnica_w || substr(obter_descricao_padrao('MEDIC_FICHA_TECNICA', 'DS_SUBSTANCIA',nr_seq_ficha_sup_w),1,35)||', ';
						ds_ficha_derivado_w := ds_ficha_derivado_w || substr(obter_descricao_padrao('MEDIC_FICHA_TECNICA', 'DS_SUBSTANCIA',r_c05.nr_seq_derivado),1,35)||', ';
						
						ie_alergico_w := 'S';
					end if;
				end loop;
					if (ds_ficha_tecnica_w IS NOT NULL AND ds_ficha_tecnica_w::text <> '') then
						ds_mensagem_p	:= wheb_mensagem_pck.get_texto(1046562, 'DS_MATERIAL=' || substr(obter_desc_material(cd_material_p),1,35) ||
							';DS_FICHA_TECNICA=' || substr(ds_ficha_tecnica_w,1,length(ds_ficha_tecnica_w) -2) ||
							';DS_FICHA_DERIVADO=' || substr(ds_ficha_derivado_w,1,length(ds_ficha_derivado_w) -2));
					end if;
			end if;
						
			end;
		end loop;
	end;
	end loop;
end if;

ie_alergico_p := ie_alergico_w;
ie_severidade_p	:= ie_severidade_w;
nr_seq_reacao_p	:= nr_seq_reacao_w;
nr_seq_ficha_tecnica_p := coalesce(nr_seq_ficha_tec_princ_ativo_w, nr_seq_ficha_tecnica_w);

if (ie_alergico_p = 'S') then
	if (coalesce(ds_mensagem_p::text, '') = '') then
		ds_mensagem_p	:= obter_texto_conforme_classif(319858, 'DS_ITEM='||obter_desc_material(cd_material_p));
	end if;
end if;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_verifica_se_pac_alergico ( cd_pessoa_fisica_p text, cd_material_p bigint, ie_alergico_p INOUT text, ds_mensagem_p INOUT text, ie_severidade_p INOUT paciente_alergia.ie_intensidade%type, nr_seq_reacao_p INOUT paciente_alergia.nr_seq_reacao%type, ie_restringe_classif_p text, nr_seq_ficha_tecnica_p INOUT paciente_alergia.nr_seq_ficha_tecnica%type) FROM PUBLIC;

