-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cnes_compl_pf ( cd_pessoa_fisica_p bigint, ie_tipo_estabelecimento_p text, cd_cnes_p text, nr_seq_compl_pf_tel_adic_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


ie_permite_cnes_duplic_w	varchar(1)	:= 'N';
nr_seq_cnes_identific_w		bigint;
nr_seq_ident_cnes_w		bigint;
qt_cnes_adic_w			bigint	:= 0;
qt_cnes_compl_w			bigint	:= 0;
qt_cnes_pj_w			bigint	:= 0;
qt_cnes_pj_ident_w		bigint	:= 0;
qt_cnes_compl_pj_ident_w	bigint	:= 0;


BEGIN
select	coalesce(max(ie_permite_cnes_duplic),'S')
into STRICT	ie_permite_cnes_duplic_w
from	pls_parametros
where	cd_estabelecimento	= cd_estabelecimento_p;

if (nr_seq_compl_pf_tel_adic_p IS NOT NULL AND nr_seq_compl_pf_tel_adic_p::text <> '') then
	select	max(nr_seq_ident_cnes)
	into STRICT	nr_seq_ident_cnes_w
	from	compl_pf_tel_adic
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p
	and	nr_sequencia		= nr_seq_compl_pf_tel_adic_p;
else
	select	max(nr_seq_ident_cnes)
	into STRICT	nr_seq_ident_cnes_w
	from	compl_pessoa_fisica
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p
	and	ie_tipo_complemento	= 2;
end if;

if (ie_permite_cnes_duplic_w = 'N') then
	select	count(*)
	into STRICT	qt_cnes_adic_w
	from	compl_pf_tel_adic	b,
		cnes_identificacao	a
	where	b.nr_seq_ident_cnes	= a.nr_sequencia
	and	a.cd_cnes		= to_char(cd_cnes_p);

	select	count(*)
	into STRICT	qt_cnes_compl_w
	from	compl_pessoa_fisica	b,
		cnes_identificacao	a
	where	b.nr_seq_ident_cnes	= a.nr_sequencia
	and	a.cd_cnes		= to_char(cd_cnes_p);
	
	select	count(*)
	into STRICT	qt_cnes_pj_w
	from	pessoa_juridica
	where	cd_cnes	= to_char(cd_cnes_p);
	
	select	count(*)
	into STRICT	qt_cnes_pj_ident_w
	from	pessoa_juridica		b,
		cnes_identificacao	a
	where	b.cd_cgc	= a.cd_cgc
	and	a.cd_cnes	= to_char(cd_cnes_p);
	
	select	count(*)
	into STRICT	qt_cnes_compl_pj_ident_w
	from	pessoa_juridica_compl	b,
		cnes_identificacao	a
	where	b.nr_seq_ident_cnes	= a.nr_sequencia
	and	a.cd_cnes		= to_char(cd_cnes_p);
	
	if (qt_cnes_adic_w > 0) or (qt_cnes_compl_w > 0) or (qt_cnes_pj_w > 0) or (qt_cnes_pj_ident_w > 0) or (qt_cnes_compl_pj_ident_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(265399,'');
		--Mensagem: Nao pode ser vinculado o mesmo CNES a mais de uma pessoa!
	end if;
end if;

if (nr_seq_ident_cnes_w IS NOT NULL AND nr_seq_ident_cnes_w::text <> '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(265405,'');
	--Mensagem: Ja existe um CNES vinculado a este endereco!
else
	select	nextval('cnes_identificacao_seq')
	into STRICT	nr_seq_cnes_identific_w
	;

	insert into cnes_identificacao(nr_sequencia,
		nm_usuario,
		dt_atualizacao,
		nm_usuario_nrec,
		dt_atualizacao_nrec,
		cd_cnes,
		cd_pessoa_fisica,
		ie_tipo_estabelecimento)
	values (nr_seq_cnes_identific_w,
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		cd_cnes_p,
		cd_pessoa_fisica_p,
		ie_tipo_estabelecimento_p);
		
	if (nr_seq_compl_pf_tel_adic_p IS NOT NULL AND nr_seq_compl_pf_tel_adic_p::text <> '') then
		update	compl_pf_tel_adic
		set	nr_seq_ident_cnes	= nr_seq_cnes_identific_w
		where	cd_pessoa_fisica	= cd_pessoa_fisica_p
		and	nr_sequencia		= nr_seq_compl_pf_tel_adic_p;
	else
		update	compl_pessoa_fisica
		set	nr_seq_ident_cnes	= nr_seq_cnes_identific_w
		where	cd_pessoa_fisica	= cd_pessoa_fisica_p
		and	ie_tipo_complemento	= 2;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cnes_compl_pf ( cd_pessoa_fisica_p bigint, ie_tipo_estabelecimento_p text, cd_cnes_p text, nr_seq_compl_pf_tel_adic_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

