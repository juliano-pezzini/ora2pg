-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE grava_cirurgia_dispensacao ( cd_material_p bigint, cd_unid_med_p text, qt_dispensacao_p bigint, nr_cirurgia_p bigint, nm_usuario_p text, ie_operacao_p text, ie_motivo_p text, ds_motivo_p text, nr_seq_lote_fornec_p bigint, dt_validade_p timestamp, ie_origem_gasto_p bigint, nr_seq_agente_p bigint, ie_sem_disp_p text, cd_local_estoque_p bigint) AS $body$
DECLARE


nr_sequencia_w		      bigint;
nr_sequencia_ww		      bigint;
ds_erro_w		      varchar(2000);
ds_material_w		      varchar(100);
cd_perfil_w	      	       bigint;
nm_usuario_w		      varchar(15);
cd_estabelecimento_w	      bigint;
ie_decrementa_saldo_w	      varchar(1);
ie_salvar_local_estoq_w	     varchar(1);


BEGIN
cd_perfil_w		:= wheb_usuario_pck.get_cd_perfil;
nm_usuario_w		:= wheb_usuario_pck.get_nm_usuario;
cd_estabelecimento_w	:= wheb_usuario_pck.get_cd_estabelecimento;

ie_decrementa_saldo_w := obter_param_usuario(872, 504, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_decrementa_saldo_w);
ie_salvar_local_estoq_w := obter_param_usuario(872, 520, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_salvar_local_estoq_w);

if (ie_operacao_p = 'D') or (ie_operacao_p = 'P') then

	select	nextval('cirurgia_agente_disp_seq')
	into STRICT	nr_sequencia_ww
	;


	insert into cirurgia_agente_disp(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		nr_cirurgia,
		qt_dispensacao,
		cd_material,
		cd_unidade_medida,
		ie_operacao,
		ie_motivo_perda,
		ds_motivo_perda,
		nr_seq_lote_fornec,
		dt_validade,
		ie_origem_gasto,
		nr_seq_agente,
		ie_sem_disp,
      cd_local_estoque)
	values (
		nr_sequencia_ww,
		clock_timestamp(),
		nm_usuario_p,
		nr_cirurgia_p,
		qt_dispensacao_p,
		cd_material_p,
		cd_unid_med_p,
		ie_operacao_p,
		ie_motivo_p,
		ds_motivo_p,
		nr_seq_lote_fornec_p,
		dt_validade_p,
		ie_origem_gasto_p,
		nr_seq_agente_p,
		ie_sem_disp_p,
      CASE WHEN coalesce(ie_salvar_local_estoq_w, 'N')='S' THEN  cd_local_estoque_p  ELSE null END );

	if (ie_operacao_p = 'P') then
		CALL atualiza_disp_perda_cir(nr_sequencia_ww,'P');
	end if;
elsif (ie_operacao_p = 'E') then
	select	coalesce(max(nr_sequencia),0)
	into STRICT	   nr_sequencia_w
	from	   cirurgia_agente_disp
	where	   cd_material			=	cd_material_p
	and	   coalesce(nr_seq_lote_fornec,0)		=	coalesce(nr_seq_lote_fornec_p,0)
	and	   ie_origem_gasto		   	=	ie_origem_gasto_p
	and	   nr_cirurgia			=	nr_cirurgia_p;

	if (nr_sequencia_w = 0) then

		select	substr(obter_desc_material(cd_material_p),1,30)
		into STRICT	   ds_material_w
		;

		CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(180980, 'DS_MATERIAL_W='|| DS_MATERIAL_W ||';NR_SEQ_LOTE_FORNEC_P='||NR_SEQ_LOTE_FORNEC_P||';IE_ORIGEM_GASTO_P='||obter_valor_dominio(1815,ie_origem_gasto_p));

	else
		delete	from cirurgia_agente_disp
		where 	nr_sequencia	=	nr_sequencia_w;
	end if;
end if;

commit;

--atualiza_disp_cirurgia(nr_cirurgia_p);
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE grava_cirurgia_dispensacao ( cd_material_p bigint, cd_unid_med_p text, qt_dispensacao_p bigint, nr_cirurgia_p bigint, nm_usuario_p text, ie_operacao_p text, ie_motivo_p text, ds_motivo_p text, nr_seq_lote_fornec_p bigint, dt_validade_p timestamp, ie_origem_gasto_p bigint, nr_seq_agente_p bigint, ie_sem_disp_p text, cd_local_estoque_p bigint) FROM PUBLIC;

