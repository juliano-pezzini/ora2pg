-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_cart_hr_franca ( nr_seq_lote_p bigint, cd_interface_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
cd_usuario_plano_w		varchar(30);
nm_beneficiario_w		varchar(255);
dt_nascimento_w			varchar(12);
dt_fim_cpt_w			varchar(12);
ds_produto_w			varchar(255);
nm_fantasia_w			varchar(255);
ds_acomodacao_w			varchar(50);
ds_mensagem_cpt_w		varchar(25);
nm_empresa_w			varchar(255);
ds_mensagem_w			varchar(100);
nr_seq_contrato_w		bigint;
nr_seq_intercambio_w		bigint;
nr_seq_plano_w			bigint;
ds_tipo_acomodacao_w		varchar(255);			
ie_regulamentacao_w		pls_plano.ie_regulamentacao%type;
nr_cartao_nac_sus_w		pessoa_fisica.nr_cartao_nac_sus%type;	
nr_seq_categoria_w 		pls_plano_acomodacao.nr_seq_categoria%type;
nr_seq_tipo_acomodacao_w 	pls_plano_acomodacao.nr_seq_tipo_acomodacao%type;

C01 CURSOR(nr_seq_lote_p	pls_lote_carteira.nr_sequencia%type) FOR 
		SELECT	b.nr_sequencia nr_seq_segurado, 
		'C' ie_tipo_contrato 
	from	pls_segurado_carteira	a, 
		pls_segurado		b, 
		pls_carteira_emissao	c, 
		pls_lote_carteira	d, 
		pls_contrato		e 
	where	a.nr_seq_segurado	= b.nr_sequencia 
	and	c.nr_seq_seg_carteira	= a.nr_sequencia 
	and	c.nr_seq_lote		= d.nr_sequencia 
	and	b.nr_seq_contrato	= e.nr_sequencia 
	and	d.nr_sequencia		= nr_seq_lote_p 
	
union all
 
	SELECT	b.nr_sequencia nr_seq_segurado, 
		'I' ie_tipo_contrato 
	from	pls_segurado_carteira	a, 
		pls_segurado		b, 
		pls_carteira_emissao	c, 
		pls_lote_carteira	d, 
		pls_intercambio		e 
	where	a.nr_seq_segurado	= b.nr_sequencia 
	and	c.nr_seq_seg_carteira	= a.nr_sequencia 
	and	c.nr_seq_lote		= d.nr_sequencia 
	and	b.nr_seq_intercambio	= e.nr_sequencia 
	and	d.nr_sequencia		= nr_seq_lote_p;

BEGIN 
 
delete	FROM w_pls_interface_carteira 
where	nr_seq_lote	= nr_seq_lote_p;
 
for c01_w in C01(nr_seq_lote_p) loop	 
	if (c01_w.ie_tipo_contrato = 'C') then	 
		select	pls_obter_mascara_cart_emissor(c.cd_usuario_plano), 
			substr((CASE WHEN (trim(both nm_abreviado) IS NOT NULL AND (trim(both nm_abreviado))::text <> '') THEN upper(nm_abreviado) ELSE pls_gerar_nome_abreviado(a.nm_pessoa_fisica) END), 1, 255), 
			to_char(a.dt_nascimento, 'dd/mm/yyyy'),			 
			case 	when coalesce(b.nr_seq_localizacao_benef::text, '') = '' 
				then substr(CASE WHEN coalesce(f.cd_pf_estipulante::text, '') = '' THEN  pls_obter_dados_pagador(b.nr_seq_pagador,'N')  ELSE obter_nome_pf_pj(f.cd_pf_estipulante, f.cd_cgc_estipulante) END ,1,255) 
			else 
				substr((select 	x.ds_localizacao 
					from 	pls_localizacao_benef x 
					where 	x.nr_sequencia = b.nr_seq_localizacao_benef),0,255) 
			end nm_empresa,			 
			nr_seq_plano, 
			substr(d.ds_plano,1,255), 
			substr(d.nm_fantasia,1,255), 
			d.ie_regulamentacao, 
			a.nr_cartao_nac_sus 
		into STRICT	cd_usuario_plano_w, 
			nm_beneficiario_w, 
			dt_nascimento_w, 
			nm_empresa_w, 
			nr_seq_plano_w, 
			ds_produto_w, 
			nm_fantasia_w, 
			ie_regulamentacao_w, 
			nr_cartao_nac_sus_w 
		from	pls_contrato		f, 
			pls_plano		d, 
			pls_segurado_carteira	c, 
			pls_segurado		b, 
			pessoa_fisica		a 
		where	c.nr_seq_segurado	= b.nr_sequencia 
		and	b.nr_seq_plano		= d.nr_sequencia 
		and	b.cd_pessoa_fisica	= a.cd_pessoa_fisica 
		and	b.nr_seq_contrato	= f.nr_sequencia 
		and	b.nr_sequencia		= c01_w.nr_seq_segurado;	
	elsif (c01_w.ie_tipo_contrato = 'I') then 
	 
		select	pls_obter_mascara_cart_emissor(c.cd_usuario_plano),  
			substr((CASE WHEN (trim(both nm_abreviado) IS NOT NULL AND (trim(both nm_abreviado))::text <> '') THEN upper(nm_abreviado) ELSE pls_gerar_nome_abreviado(a.nm_pessoa_fisica) END), 1, 255), 
			to_char(a.dt_nascimento, 'dd/mm/yyyy'),	 
			case 	when coalesce(b.nr_seq_localizacao_benef::text, '') = '' 
				then substr(CASE WHEN coalesce(f.cd_pessoa_fisica::text, '') = '' THEN  pls_obter_dados_pagador(b.nr_seq_pagador,'N')  ELSE obter_nome_pf_pj(f.cd_pessoa_fisica, f.cd_cgc) END ,1,255) 
			else 
				substr((select 	x.ds_localizacao 
					from 	pls_localizacao_benef x 
					where 	x.nr_sequencia = b.nr_seq_localizacao_benef),0,255) 
			end nm_empresa,			 
			nr_seq_plano, 
			substr(d.ds_plano,1,255), 
			substr(d.nm_fantasia,1,255), 
			d.ie_regulamentacao, 
			a.nr_cartao_nac_sus 
		into STRICT	cd_usuario_plano_w, 
			nm_beneficiario_w, 
			dt_nascimento_w, 
			nm_empresa_w, 
			nr_seq_plano_w, 
			ds_produto_w, 
			nm_fantasia_w, 
			ie_regulamentacao_w, 
			nr_cartao_nac_sus_w			 
		from	pls_segurado_carteira	c, 
			pls_segurado		b, 
			pessoa_fisica		a, 
			pls_intercambio		f, 
			pls_plano		d 
		where	b.cd_pessoa_fisica	= a.cd_pessoa_fisica 
		and	c.nr_seq_segurado	= b.nr_sequencia 
		and	b.nr_seq_intercambio	= f.nr_sequencia 
		and	b.nr_seq_plano		= d.nr_sequencia 
		and	b.nr_sequencia		= c01_w.nr_seq_segurado;
	end if;
	 
	begin 
	select	to_char(max(coalesce(a.dt_inicio_vigencia, c.dt_inclusao_operadora)) + max(a.qt_dias),'dd/mm/yyyy') 
	into STRICT	dt_fim_cpt_w 
	from	pls_carencia		a, 
		pls_tipo_carencia	b, 
		pls_segurado		c 
	where	a.nr_seq_tipo_carencia	= b.nr_sequencia 
	and	a.nr_seq_segurado	= c.nr_sequencia 
	and	c.nr_sequencia		= c01_w.nr_seq_segurado 
	and	b.ie_cpt	= 'S' 
	and	a.qt_dias > 0;
	exception 
	when others then 
		dt_fim_cpt_w := null;
	end;
	 
	if	((coalesce(dt_fim_cpt_w::text, '') = '') or dt_fim_cpt_w < clock_timestamp() )then 
		if (ie_regulamentacao_w <> 'R') then 
			ds_mensagem_cpt_w := 'Sem registro';
		elsif (ie_regulamentacao_w = 'R') then 
			ds_mensagem_cpt_w := 'anterior a lei 9656/98';
		end if;
	else 
		ds_mensagem_cpt_w := dt_fim_cpt_w;			
	end if;
 
	select 	max(nr_seq_categoria), 
		max(nr_seq_tipo_acomodacao) 	 
	into STRICT	nr_seq_categoria_w, 
		nr_seq_tipo_acomodacao_w 
	from 	pls_plano_acomodacao 
	where 	nr_seq_plano = nr_seq_plano_w;
	 
	if (coalesce(nr_seq_categoria_w,0) <> 0 ) then 
		select 	ds_categoria 
		into STRICT	ds_acomodacao_w 
		from  pls_categoria 
		where 	nr_sequencia = 	nr_seq_categoria_w;
	elsif (coalesce(nr_seq_tipo_acomodacao_w,0) <> 0 ) then 
		select 	ds_tipo_acomodacao 
		into STRICT	ds_acomodacao_w 
		from  pls_tipo_acomodacao 
		where 	nr_sequencia = 	nr_seq_tipo_acomodacao_w;
	end if;
 
	insert into w_pls_interface_carteira(	nr_sequencia, dt_atualizacao, nm_usuario, 
			dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_lote, 
			ie_tipo_reg,cd_usuario_plano, dt_nascimento, 
			nm_beneficiario, ds_estipulante,dt_cpt, ds_cns, 
			nm_plano, ds_acomodacao) 
	values (	nextval('w_pls_interface_carteira_seq'), clock_timestamp(), nm_usuario_p, 
			clock_timestamp(), nm_usuario_p, nr_seq_lote_p, 
			1,cd_usuario_plano_w, dt_nascimento_w, 
			nm_beneficiario_w, nm_empresa_w,ds_mensagem_cpt_w,nr_cartao_nac_sus_w, 
			nm_fantasia_w, ds_acomodacao_w);
end loop;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_cart_hr_franca ( nr_seq_lote_p bigint, cd_interface_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

