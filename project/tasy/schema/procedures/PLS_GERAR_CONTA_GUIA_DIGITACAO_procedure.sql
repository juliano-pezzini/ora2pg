-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_conta_guia_digitacao ( nr_seq_guia_p pls_guia_plano.nr_Sequencia%type, nr_seq_prestador_atend_p pls_prestador.nr_sequencia%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, dt_inicio_servico_p timestamp, dt_fim_servico_p timestamp, ie_origem_dados_p text, ie_utiliza_guia_p bigint, --parametro funcao,
 ie_utiliza_digitacao_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_conta_gerada_p INOUT pls_conta.nr_sequencia%type) AS $body$
DECLARE


                                            

cd_medico_exec_w			bigint;
cd_guia_w				      pls_guia_plano.cd_guia%type;
dt_autorizacao_w			pls_guia_plano.dt_autorizacao%type;
cd_senha_w				    pls_guia_plano.cd_senha%type;
dt_validade_senha_w		pls_guia_plano.dt_validade_senha%type;
nr_seq_segurado_w			pls_guia_plano.nr_Seq_segurado%type;
cd_medico_solicitante_w			pls_guia_plano.cd_medico_solicitante%type;
ie_tipo_guia_w				pls_guia_plano.ie_tipo_guia%type;
ie_carater_internacao_w			pls_guia_plano.ie_carater_internacao%type;
nr_seq_prestador_w			pls_guia_plano.nr_seq_prestador%type;
ie_status_w				pls_guia_plano.ie_status%type;
cd_guia_principal_w			pls_guia_plano.cd_guia_principal%type;
nr_crm_exec_w				medico.nr_crm%type;
uf_crm_exec_w				medico.uf_crm%type;
nr_conselho_exec_w			pessoa_fisica.nr_seq_conselho%type;
nr_seq_tipo_atendimento_w		pls_tipo_atendimento.nr_sequencia%type;
nr_seq_clinica_w			pls_guia_plano.nr_seq_clinica%type;
ie_regime_internacao_w			pls_guia_plano.ie_regime_internacao%type;
nr_seq_tipo_acomodacao_w		pls_guia_plano.nr_seq_tipo_acomodacao%type;
ie_tipo_consulta_w			pls_guia_plano.ie_tipo_consulta%type;
cd_cooperativa_w			pls_contrato.cd_cooperativa%type;
ie_recem_nascido_w			pls_guia_plano.ie_recem_nascido%type;
nm_recem_nascido_w			pls_guia_plano.nm_recem_nascido%type;
dt_nasc_recem_nascido_w			timestamp;
ie_tipo_saida_w				pls_guia_plano.ie_tipo_saida%type;
ds_indicacao_clinica_w			pls_guia_plano.ds_indicacao_clinica%type;
cd_especialidade_w			pls_guia_plano.cd_especialidade%type;
ie_tipo_guia_dois_w			pls_guia_plano.ie_tipo_guia%type;
nr_seq_saida_consulta_w			pls_motivo_saida_consulta.nr_sequencia%type;
ie_origem_conta_w			varchar(1);
nr_seq_cbo_saude_w			especialidade_medica.nr_seq_cbo_saude%type;
ie_indicacao_acidente_w			pls_diagnostico.ie_indicacao_acidente%type;
cd_doenca_w				pls_diagnostico.cd_doenca%type;
nr_seq_prestador_atend_dois_w		pls_execucao_requisicao.nr_seq_prestador%type;
dt_emissao_w				pls_guia_plano.dt_emissao%type;
dt_atendimento_w			pls_execucao_requisicao.dt_execucao%type;
nr_seq_prestador_exec_w			pls_execucao_requisicao.nr_seq_prestador%type;
cd_guia_temp_w				pls_guia_plano.cd_guia%type := null;
cd_guia_ref_temp_w			pls_guia_plano.cd_guia_principal%type := null;
cd_senha_externa_w			pls_guia_plano.cd_senha_externa%type := null;
nr_seq_conta_gerada_w			pls_conta.nr_sequencia%type;
dt_servico_w				timestamp := trunc(dt_inicio_servico_p,'DD');
cd_guia_prestador_w			pls_guia_plano.cd_guia_prestador%type;

cd_validacao_benef_tiss_w	pls_conta_tiss.cd_validacao_benef_tiss%type;
cd_ausencia_val_benef_tiss_w	pls_conta_tiss.cd_ausencia_val_benef_tiss%type;
cd_ident_biometria_benef_w	pls_conta_tiss.cd_ident_biometria_benef%type;
cd_template_biomet_benef_w	pls_conta_tiss.cd_template_biomet_benef%type;
ie_tipo_ident_benef_w		pls_conta_tiss.ie_tipo_ident_benef%type;
ie_cobertura_especial_w		pls_guia_plano.ie_cobertura_especial%type;
ie_regime_atendimento_w		pls_guia_plano.ie_regime_atendimento%type;
ie_saude_ocupacional_w  	pls_guia_plano.ie_saude_ocupacional%type;

C01 CURSOR FOR
	SELECT	CASE WHEN a.ie_status='D' THEN 'N' WHEN a.ie_status='K' THEN 'N' WHEN a.ie_status='M' THEN 'N' WHEN a.ie_status='N' THEN 'N'  ELSE 'S' END  ie_inserir,
			a.nr_sequencia nr_seq_item,
			'P' ie_tipo_item,
			substr(obter_desc_expressao(296422),1,255) ds_tipo_item,
			a.cd_procedimento cd_item,
			substr(obter_descricao_procedimento(a.cd_procedimento,a.ie_origem_proced),1,255) ds_item,
			a.qt_autorizada,
			a.dt_liberacao,
			a.nr_seq_guia
	from	pls_guia_plano_proc a
	where	a.nr_seq_guia = nr_seq_guia_p
	and	coalesce(ie_utilizado,'N') in ('P','N')
	
union

	SELECT	CASE WHEN a.ie_status='D' THEN 'N' WHEN a.ie_status='K' THEN 'N' WHEN a.ie_status='M' THEN 'N' WHEN a.ie_status='N' THEN 'N'  ELSE 'S' END  ie_inserir,
			a.nr_sequencia nr_seq_item,
			'M' ie_tipo_item,
			substr(obter_desc_expressao(292952),1,255) ds_tipo_item,
			(pls_obter_seq_codigo_material(a.nr_seq_material,'') )::numeric  cd_item,
			substr(obter_descricao_padrao('PLS_MATERIAL','DS_MATERIAL',a.nr_seq_material),1,255) ds_item,
			a.qt_autorizada,
			a.dt_liberacao,
			a.nr_seq_guia
	from	pls_guia_plano_mat a
	where	a.nr_seq_guia = nr_seq_guia_p
	and	coalesce(ie_utilizado,'N') in ('P','N')
	order by	2;

BEGIN


	SELECT * FROM pls_gerar_conta_guia_prod_out(	nr_seq_guia_p, nr_seq_prestador_atend_p, ie_origem_dados_p, cd_medico_exec_w, cd_guia_w, dt_autorizacao_w, cd_senha_w, dt_validade_senha_w, nr_seq_segurado_w, cd_medico_solicitante_w, ie_tipo_guia_w, ie_carater_internacao_w, nr_seq_prestador_w, ie_status_w, cd_guia_principal_w, nr_crm_exec_w, uf_crm_exec_w, nr_conselho_exec_w, nr_seq_tipo_atendimento_w, nr_seq_clinica_w, ie_regime_internacao_w, nr_seq_tipo_acomodacao_w, ie_tipo_consulta_w, cd_cooperativa_w, ie_recem_nascido_w, nm_recem_nascido_w, dt_nasc_recem_nascido_w, ie_tipo_saida_w, ds_indicacao_clinica_w, cd_especialidade_w, ie_tipo_guia_dois_w, nr_seq_saida_consulta_w, ie_origem_conta_w, nr_seq_cbo_saude_w, ie_indicacao_acidente_w, cd_doenca_w, nr_seq_prestador_atend_dois_w, dt_emissao_w, dt_atendimento_w, nr_seq_prestador_exec_w, cd_guia_prestador_w, ie_cobertura_especial_w, ie_regime_atendimento_w, ie_saude_ocupacional_w) INTO STRICT cd_medico_exec_w, cd_guia_w, dt_autorizacao_w, cd_senha_w, dt_validade_senha_w, nr_seq_segurado_w, cd_medico_solicitante_w, ie_tipo_guia_w, ie_carater_internacao_w, nr_seq_prestador_w, ie_status_w, cd_guia_principal_w, nr_crm_exec_w, uf_crm_exec_w, nr_conselho_exec_w, nr_seq_tipo_atendimento_w, nr_seq_clinica_w, ie_regime_internacao_w, nr_seq_tipo_acomodacao_w, ie_tipo_consulta_w, cd_cooperativa_w, ie_recem_nascido_w, nm_recem_nascido_w, dt_nasc_recem_nascido_w, ie_tipo_saida_w, ds_indicacao_clinica_w, cd_especialidade_w, ie_tipo_guia_dois_w, nr_seq_saida_consulta_w, ie_origem_conta_w, nr_seq_cbo_saude_w, ie_indicacao_acidente_w, cd_doenca_w, nr_seq_prestador_atend_dois_w, dt_emissao_w, dt_atendimento_w, nr_seq_prestador_exec_w, cd_guia_prestador_w, ie_cobertura_especial_w, ie_regime_atendimento_w, ie_saude_ocupacional_w;

	select	max(a.cd_validacao_benef_tiss),
		max(a.cd_ausencia_val_benef_tiss),
		max(a.cd_ident_biometria_benef),
		max(a.cd_template_biomet_benef),
		max(a.ie_tipo_ident_benef)
	into STRICT	cd_validacao_benef_tiss_w,
		cd_ausencia_val_benef_tiss_w,
		cd_ident_biometria_benef_w,
		cd_template_biomet_benef_w,
		ie_tipo_ident_benef_w
	from	pls_guia_plano	a
	where	nr_sequencia	= nr_seq_guia_p;

	cd_guia_temp_w		:= cd_guia_w;
	cd_guia_ref_temp_w	:= cd_guia_principal_w;

	if (ie_utiliza_guia_p = 1) then
		cd_guia_temp_w		:= cd_guia_w;
    end if;
	if (ie_utiliza_guia_p = 2 )then
		cd_guia_ref_temp_w	:= cd_guia_w;
	elsif (ie_utiliza_guia_p = 3 ) then
		cd_guia_temp_w		:= cd_guia_w;
		cd_guia_ref_temp_w	:= cd_guia_w;
	end if;

	select	max(cd_senha_externa)
	into STRICT 	cd_senha_externa_w
	from	pls_guia_plano
	where 	cd_guia = cd_guia_w;

	insert into pls_conta(	nr_sequencia, cd_guia, cd_guia_prestador,
							dt_autorizacao, cd_senha, dt_validade_senha,
							nr_seq_segurado, cd_medico_solicitante, ie_tipo_guia,
							ie_carater_internacao, ie_status, nr_crm_exec,
							uf_crm_exec, nr_seq_conselho_exec, nr_seq_tipo_atendimento,
							nr_seq_clinica, ie_regime_internacao, nr_seq_tipo_acomodacao,
							ie_tipo_consulta, cd_cooperativa, ie_recem_nascido,
							nm_recem_nascido, dt_nascimento, ds_indicacao_clinica,
							nr_seq_saida_consulta, ie_origem_conta, nr_seq_cbo_saude,
							ie_indicacao_acidente, nr_seq_prestador, dt_emissao,
							dt_atendimento, nr_seq_prestador_exec, cd_medico_executor,
							cd_doenca_dig, nr_seq_protocolo, cd_guia_referencia,
							cd_senha_externa, nm_usuario, dt_atualizacao,
							nm_usuario_nrec, dt_atualizacao_nrec, cd_estabelecimento,
							ie_cobertura_especial, ie_regime_atendimento, ie_saude_ocupacional)
					values ( nextval('pls_conta_seq'), cd_guia_w, cd_guia_prestador_w,
							dt_autorizacao_w, cd_senha_w, dt_validade_senha_w,
							nr_seq_segurado_w, cd_medico_solicitante_w, ie_tipo_guia_w,
							ie_carater_internacao_w, ie_status_w, nr_crm_exec_w,
							uf_crm_exec_w, nr_conselho_exec_w, nr_seq_tipo_atendimento_w,
							nr_seq_clinica_w, ie_regime_internacao_w, nr_seq_tipo_acomodacao_w,
							ie_tipo_consulta_w, cd_cooperativa_w, ie_recem_nascido_w,
							nm_recem_nascido_w, dt_nasc_recem_nascido_w, ds_indicacao_clinica_w,
							nr_seq_saida_consulta_w, ie_origem_conta_w,	nr_seq_cbo_saude_w,
							ie_indicacao_acidente_w, nr_seq_prestador_atend_dois_w, dt_emissao_w,
							dt_atendimento_w, nr_seq_prestador_exec_w, cd_medico_exec_w,
							cd_doenca_w, nr_seq_protocolo_p, cd_guia_ref_temp_w,
							cd_senha_externa_w, nm_usuario_p, clock_timestamp(),
							nm_usuario_p, clock_timestamp(), cd_estabelecimento_p,
							ie_cobertura_especial_w, ie_regime_atendimento_w, ie_saude_ocupacional_w) returning nr_sequencia into nr_seq_conta_gerada_w;

	CALL pls_conta_tiss_pck.criar_registro(	nr_seq_conta_gerada_w,		cd_estabelecimento_p,		cd_validacao_benef_tiss_w,
						cd_ausencia_val_benef_tiss_w,	cd_ident_biometria_benef_w,	cd_template_biomet_benef_w,
						ie_tipo_ident_benef_w,		null,	nm_usuario_p);

	for r_c01_w in C01 loop

		if (r_c01_w.ie_inserir = 'S') then

			CALL pls_gerar_mat_proc_producao(nr_seq_conta_gerada_w, r_c01_w.nr_seq_guia, r_c01_w.nr_seq_item,
										r_c01_w.ie_tipo_item, nm_usuario_p, cd_estabelecimento_p,
										dt_servico_w, dt_inicio_servico_p, dt_fim_servico_p,
										ie_utiliza_digitacao_p);

		end if;

	end loop;

commit;

nr_seq_conta_gerada_p := nr_seq_conta_gerada_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_conta_guia_digitacao ( nr_seq_guia_p pls_guia_plano.nr_Sequencia%type, nr_seq_prestador_atend_p pls_prestador.nr_sequencia%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, dt_inicio_servico_p timestamp, dt_fim_servico_p timestamp, ie_origem_dados_p text, ie_utiliza_guia_p bigint, ie_utiliza_digitacao_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_conta_gerada_p INOUT pls_conta.nr_sequencia%type) FROM PUBLIC;

