-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pfcs_average_setup_time ( nr_seq_indicator_p bigint, cd_estabelecimento_p text, nm_usuario_p text) AS $body$
DECLARE


pfcs_panel_detail_seq_w		    pfcs_panel_detail.nr_sequencia%type;
nr_seq_operational_level_w	  pfcs_operational_level.nr_sequencia%type;
nr_seq_panel_w			          pfcs_panel.nr_sequencia%type;
qt_total_w			              bigint := 0;
qt_total_time_sanitization_w	bigint := 0;

c01 CURSOR FOR
SELECT	a.cd_procedimento cd_procedure,
	substr(obter_exame_agenda(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno),1,240) ds_procedure,
	(select	x.ds_sala_painel
	from	sala_cirurgia x
	where	x.nr_sequencia	= b.nr_seq_sala_cir) ds_room,
	c.dt_inicio_prevista dt_expected_start,
	c.dt_inicio_real dt_actual_start,
	c.dt_termino_prevista dt_expected_final,
	c.dt_termino dt_actual_end,
	obter_tempo_higienizacao(c.nr_seq_proc_interno) qt_time_sanitization
from	cirurgia	c,
	agenda_paciente	a,
	agenda		b
where	a.cd_agenda		= b.cd_agenda
and	a.nr_cirurgia		= c.nr_cirurgia
and	b.cd_tipo_agenda	= 1
and	trunc(c.dt_inicio_prevista) = trunc(clock_timestamp())
and	((c.dt_termino IS NOT NULL AND c.dt_termino::text <> '') or (c.dt_interrupcao IS NOT NULL AND c.dt_interrupcao::text <> ''))
and	b.cd_estabelecimento	= cd_estabelecimento_p;

BEGIN

nr_seq_operational_level_w := pfcs_get_structure_level(
		cd_establishment_p => cd_estabelecimento_p,
		ie_level_p => 'O',
		ie_info_p => 'C');

for c01_w in c01 loop
	begin

	qt_total_w			:= qt_total_w + 1;
	qt_total_time_sanitization_w	:= qt_total_time_sanitization_w + c01_w.qt_time_sanitization;

	select	nextval('pfcs_panel_detail_seq')
	into STRICT	pfcs_panel_detail_seq_w
	;

	insert into pfcs_panel_detail(
		nr_sequencia,
		nm_usuario,
		dt_atualizacao,
		nm_usuario_nrec,
		dt_atualizacao_nrec,
		ie_situation,
		nr_seq_indicator,
		nr_seq_operational_level)
	values (
		pfcs_panel_detail_seq_w,
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		'T',
		nr_seq_indicator_p,
		nr_seq_operational_level_w);

	insert into pfcs_detail_schedule(
		nr_sequencia,
		nm_usuario,
		dt_atualizacao,
		nm_usuario_nrec,
		dt_atualizacao_nrec,
		nr_seq_detail,
		cd_procedure,
		ds_procedure,
		ds_room)
	values (
		nextval('pfcs_detail_schedule_seq'),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		pfcs_panel_detail_seq_w,
		c01_w.cd_procedure,
		c01_w.ds_procedure,
		c01_w.ds_room);

	insert into pfcs_detail_surgery(
		nr_sequencia,
		nm_usuario,
		dt_atualizacao,
		nm_usuario_nrec,
		dt_atualizacao_nrec,
		nr_seq_detail,
		cd_procedure,
		ds_procedure,
		dt_expected_start,
		dt_actual_start,
		dt_expected_final,
		dt_actual_end)
	values (
		nextval('pfcs_detail_surgery_seq'),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		pfcs_panel_detail_seq_w,
		c01_w.cd_procedure,
		c01_w.ds_procedure,
		c01_w.dt_expected_start,
		c01_w.dt_actual_start,
		c01_w.dt_expected_final,
		c01_w.dt_actual_end);
	end;
end loop;

commit;

 := pfcs_pck.pfcs_generate_results(
		vl_indicator_p => qt_total_time_sanitization_w, vl_indicator_aux_p => qt_total_w, nr_seq_indicator_p => nr_seq_indicator_p, nr_seq_operational_level_p => nr_seq_operational_level_w, nm_usuario_p => nm_usuario_p, nr_seq_panel_p => nr_seq_panel_w);

CALL pfcs_pck.pfcs_update_detail(
		nr_seq_indicator_p => nr_seq_indicator_p,
		nr_seq_panel_p => nr_seq_panel_w,
		nr_seq_operational_level_p => nr_seq_operational_level_w,
		nm_usuario_p => nm_usuario_p);

CALL pfcs_pck.pfcs_activate_records(
		nr_seq_indicator_p => nr_seq_indicator_p,
		nr_seq_operational_level_p => nr_seq_operational_level_w,
		nm_usuario_p => nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_average_setup_time ( nr_seq_indicator_p bigint, cd_estabelecimento_p text, nm_usuario_p text) FROM PUBLIC;

