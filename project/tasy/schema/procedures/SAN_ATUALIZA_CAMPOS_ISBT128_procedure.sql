-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_atualiza_campos_isbt128 ( nr_seq_doacao_p bigint, nr_seq_hemocomponente_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_producao_w	bigint;
cd_identificacao_isbt_w	varchar(13);
dt_coleta_isbt_w	timestamp;
cd_produto_isbt_w	varchar(8);

c01 CURSOR FOR
	SELECT	nr_sequencia
	from	san_producao
	where	((nr_sequencia = nr_seq_hemocomponente_p)
	or (nr_seq_doacao = nr_seq_doacao_p));


BEGIN
if	((coalesce(nr_seq_doacao_p,0) > 0) or (coalesce(nr_seq_hemocomponente_p,0) > 0)) then
	
	open c01;
	loop
	fetch c01 into	
		nr_seq_producao_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		
		select	substr(obter_isbt_doador( a.nr_sequencia, b.nr_sequencia,'B'),2,13) cd_isbt,
			a.dt_coleta,
			san_obter_cod_bolsa_isbt(b.nr_seq_derivado, b.ie_lavado, b.ie_irradiado, b.ie_filtrado, b.ie_aliquotado, b.qt_volume, b.nr_seq_conservante)
		into STRICT	cd_identificacao_isbt_w,
			dt_coleta_isbt_w,
			cd_produto_isbt_w
		FROM san_tipo_doacao c, san_doacao a
LEFT OUTER JOIN san_producao b ON (a.nr_sequencia = b.nr_seq_doacao)
WHERE a.nr_seq_tipo	= c.nr_sequencia and b.nr_sequencia	= nr_seq_producao_w;
		
		update	san_producao
		set	cd_identificacao_isbt	= cd_identificacao_isbt_w,
			dt_coleta_isbt		= dt_coleta_isbt_w,
			cd_produto_isbt		= cd_produto_isbt_w
		where	nr_sequencia		= nr_seq_producao_w;
		
		end;
	end loop;
	close c01;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_atualiza_campos_isbt128 ( nr_seq_doacao_p bigint, nr_seq_hemocomponente_p bigint, nm_usuario_p text) FROM PUBLIC;

