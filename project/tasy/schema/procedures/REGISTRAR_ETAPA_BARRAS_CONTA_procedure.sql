-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE registrar_etapa_barras_conta ( nr_interno_conta_p bigint, nr_seq_tipo_p bigint, nr_seq_estagio_p bigint, nr_seq_regra_resp_p bigint, cd_setor_atendimento_p bigint, nr_seq_auditoria_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, cd_medico_p text, cd_pessoa_resp_p text) AS $body$
DECLARE
					
					 
nr_sequencia_w		bigint;
nr_atendimento_w	bigint;
nr_seq_regra_resp_w	bigint;
nr_seq_estagio_w	bigint;
dt_inicio_audit_w	timestamp;
dt_final_audit_w	timestamp;


BEGIN 
 
select	nextval('cta_pendencia_seq') 
into STRICT	nr_sequencia_w
;
 
select	nr_atendimento 
into STRICT	nr_atendimento_w 
from	conta_paciente 
where	nr_interno_conta_p = nr_interno_conta;
 
if (nr_seq_regra_resp_p > 0) then 
nr_seq_regra_resp_w:= nr_seq_regra_resp_p;
end if;
 
if (nr_seq_estagio_p > 0) then 
nr_seq_estagio_w:= nr_seq_estagio_p;
end if;
 
insert into cta_pendencia( 	NR_SEQUENCIA           , 
			NR_INTERNO_CONTA    			 , 
			NR_ATENDIMENTO              , 
			DT_ATUALIZACAO              , 
			NM_USUARIO                , 
			DT_ATUALIZACAO_NREC            , 
			NM_USUARIO_NREC              , 
			DT_PENDENCIA               , 
			NR_SEQ_TIPO                , 
			NR_SEQ_ESTAGIO     			 , 
			CD_SETOR_ATENDIMENTO           , 
			NR_SEQ_REGRA_RESP             , 
			CD_MEDICO                 , 
		    CD_PESSOA_RESP)              
values (	nr_sequencia_w, 
	nr_interno_conta_p, 
	nr_atendimento_w, 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	somente_numero(nr_seq_tipo_p), 
	nr_seq_estagio_w, 
	cd_setor_atendimento_p, 
	nr_seq_regra_resp_w, 
	substr(cd_medico_p,1,10), 
	substr(cd_pessoa_resp_p,1,10));
 
CALL cta_enviar_email(nr_atendimento_w,nr_interno_conta_p,nr_sequencia_w,nr_seq_tipo_p,nr_seq_estagio_w,'A',null,nm_usuario_p);
	 
if (coalesce(nr_seq_auditoria_p,0) > 0) then 
	select	max(dt_periodo_inicial), 
		max(dt_periodo_final) 
	into STRICT	dt_inicio_audit_w, 
		dt_final_audit_w 
	from	auditoria_conta_paciente 
	where	nr_sequencia = nr_seq_auditoria_p;
 
	update	cta_pendencia 
	set	nr_seq_auditoria 	= nr_seq_auditoria_p, 
		dt_inicio_auditoria	= dt_inicio_audit_w, 
		dt_final_auditoria	= dt_final_audit_w 
	where	nr_sequencia = nr_sequencia_w;
	 
	CALL gerar_cta_pendencia_audit(nr_sequencia_w, nr_seq_auditoria_p, nm_usuario_p);
end if;
	 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE registrar_etapa_barras_conta ( nr_interno_conta_p bigint, nr_seq_tipo_p bigint, nr_seq_estagio_p bigint, nr_seq_regra_resp_p bigint, cd_setor_atendimento_p bigint, nr_seq_auditoria_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, cd_medico_p text, cd_pessoa_resp_p text) FROM PUBLIC;

