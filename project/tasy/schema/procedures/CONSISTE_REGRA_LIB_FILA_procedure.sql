-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_regra_lib_fila (nr_seq_fila_p bigint, nm_maquina_atual_p text, ds_erro_p INOUT text) AS $body$
DECLARE



cd_estabelecimento_w	bigint;
nr_seq_maquina_w		bigint;
qt_reg_w				bigint;


BEGIN

cd_estabelecimento_w	:= wheb_usuario_pck.get_cd_estabelecimento;

select  max(a.nr_sequencia)
into STRICT	nr_seq_maquina_w
from    maquina_local_senha a,
		computador b
where  a.nr_seq_computador	= b.nr_sequencia
and      a.cd_estabelecimento = cd_estabelecimento_w
and	 nm_computador_pesquisa = padronizar_nome(upper(nm_maquina_atual_p))
and	 coalesce(a.ie_situacao, 'A') = 'A';

select	count(*)
into STRICT	qt_reg_w
from	regra_liberacao_fila a,
	fila_espera_senha b
where	b.nr_sequencia 				= a.nr_seq_fila_espera
and	b.nr_sequencia				= nr_seq_fila_p
and	a.cd_estabelecimento			= cd_estabelecimento_w
and	coalesce(b.ie_permite_chamada, 'S') 		= 'S';

if (qt_reg_w > 0) then

	select	count(*)
	into STRICT	qt_reg_w
	from	regra_liberacao_fila a,
		fila_espera_senha b
	where	b.nr_sequencia 					= a.nr_seq_fila_espera
	and	b.nr_sequencia					= nr_seq_fila_p
	and	coalesce(a.cd_perfil,obter_perfil_ativo)		= obter_perfil_ativo
	and 	coalesce(a.nr_seq_local_senha,nr_seq_maquina_w)	= nr_seq_maquina_w
	and	a.cd_estabelecimento				= cd_estabelecimento_w
	and	coalesce(b.ie_permite_chamada, 'S') 			= 'S';

	if (qt_reg_w = 0) then
		ds_erro_p := wheb_mensagem_pck.get_texto(332782);
	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_regra_lib_fila (nr_seq_fila_p bigint, nm_maquina_atual_p text, ds_erro_p INOUT text) FROM PUBLIC;

