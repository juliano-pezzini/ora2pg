-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_atualizar_setor_tranf ( nr_atendimento_p bigint, cd_setor_atendimento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, cd_setor_anterior_p bigint) AS $body$
DECLARE


nr_seq_cpoe_w				numeric(30);			
ie_tipo_item_w				char(2);
nr_horas_copia_w			bigint;	
ie_susp_prescricoes_alta_w	char(2);	
dt_referencia_w				timestamp;		
ds_log_w					varchar(2000);
cd_setor_atendimento_w		cpoe_material.cd_setor_atendimento%type;
nr_seq_proc_interno_w		cpoe_procedimento.nr_seq_proc_interno%type;
nm_usuario_w 				cpoe_procedimento.nm_usuario%type;
cd_perfil_w					cpoe_procedimento.cd_perfil_ativo%type;
cd_setor_procedimento_w		cpoe_material.cd_setor_atendimento%type;
param_CPOE_493_w            varchar(1) := 'N';
ds_erro_w					varchar(2000);

C01 CURSOR FOR
	SELECT	distinct ie_tipo_item,
		nr_sequencia
	from	(
		SELECT	'M' ie_tipo_item,
				a.nr_sequencia
		from	cpoe_material a
		where	((CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= (a.dt_prox_geracao + (nr_horas_copia_w/24))) or (CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
		and		a.dt_prox_geracao >= dt_referencia_w - 3
		and		a.nr_atendimento = nr_atendimento_p
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		coalesce(a.cd_setor_atendimento,0) <> cd_setor_atendimento_p
		and		coalesce(a.ie_retrogrado,'N') = 'N'
		and		((((coalesce(a.ie_evento_unico,'N') = 'N') and (coalesce(a.nr_seq_adicional::text, '') = '') and (coalesce(a.nr_seq_ataque::text, '') = '')) and (coalesce(a.ie_material,'N') = 'N')) or (not exists (	select	1
								from	prescr_medica y,
										prescr_material z
								where	y.nr_prescricao = z.nr_prescricao
								and		y.nr_atendimento = nr_atendimento_p
								and		z.nr_seq_mat_cpoe = a.nr_sequencia )))
		and 	((ie_susp_prescricoes_alta_w = 'S') or (((coalesce(a.ie_baixado_por_alta, 'N') = 'N') or (coalesce(a.dt_alta_medico, clock_timestamp()) > a.dt_prox_geracao + (nr_horas_copia_w/24)))))
		and		coalesce(a.cd_funcao_origem,2314) = 2314
		
union all

		select	'N' ie_tipo_item,
				a.nr_sequencia
		from	cpoe_dieta a
		where	((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= (a.dt_prox_geracao + (nr_horas_copia_w/24))) or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
				and		a.dt_prox_geracao >= dt_referencia_w - 3
		and		a.nr_atendimento = nr_atendimento_p
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		coalesce(a.ie_retrogrado,'N') = 'N'
		and		coalesce(a.cd_setor_atendimento,0) <> cd_setor_atendimento_p
		and		((coalesce(a.ie_evento_unico,'N') = 'N') or (not exists (	select	1
								from	prescr_medica y
								where	y.nr_atendimento = nr_atendimento_p
								and		exists (	select	1
													from	prescr_material z
													where	z.nr_prescricao = y.nr_prescricao
													and		z.nr_seq_dieta_cpoe = a.nr_sequencia
													
union

													select	1
													from	prescr_dieta z
													where	z.nr_prescricao = y.nr_prescricao
													and		z.nr_seq_dieta_cpoe = a.nr_sequencia
													
union

													select	1
													from	rep_jejum z
													where	z.nr_prescricao = y.nr_prescricao
													and		z.nr_seq_dieta_cpoe = a.nr_sequencia
													
union

													select	1
													from	prescr_leite_deriv z
													where	z.nr_prescricao = y.nr_prescricao
													and		z.nr_seq_dieta_cpoe = a.nr_sequencia
													
union

													select	1
													from	nut_pac z
													where	z.nr_prescricao = y.nr_prescricao
													and		z.nr_seq_npt_cpoe = a.nr_sequencia))))
		and		coalesce(a.ie_dose_unica,'N') = 'N'
		and 	((ie_susp_prescricoes_alta_w = 'S') or (((coalesce(a.ie_baixado_por_alta, 'N') = 'N') or (coalesce(a.dt_alta_medico, clock_timestamp()) > a.dt_prox_geracao + (nr_horas_copia_w/24)))))
		and		coalesce(a.cd_funcao_origem,2314) = 2314
		
union all

		select	'R' ie_tipo_item,
				a.nr_sequencia
		from	cpoe_recomendacao a
		where	((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= (a.dt_prox_geracao + (nr_horas_copia_w/24))) or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
				and		a.dt_prox_geracao >= dt_referencia_w - 3
		and		a.nr_atendimento = nr_atendimento_p
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		coalesce(a.ie_retrogrado,'N') = 'N'
		and		coalesce(a.cd_setor_atendimento,0) <> cd_setor_atendimento_p
		and		((coalesce(a.ie_evento_unico,'N') = 'N') or (not exists (	select	1
								from	prescr_medica y,
										prescr_recomendacao z
								where	y.nr_prescricao = z.nr_prescricao
								and		y.nr_atendimento = nr_atendimento_p
								and		z.nr_seq_rec_cpoe = a.nr_sequencia)))
		and 	((ie_susp_prescricoes_alta_w = 'S') or (((coalesce(a.ie_baixado_por_alta, 'N') = 'N') or (coalesce(a.dt_alta_medico, clock_timestamp()) > a.dt_prox_geracao + (nr_horas_copia_w/24)))))
		and		coalesce(a.cd_funcao_origem,2314) = 2314
		
union all

		select	'G' ie_tipo_item,
				a.nr_sequencia
		from	cpoe_gasoterapia a
		where	((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= (a.dt_prox_geracao + (nr_horas_copia_w/24))) or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
		and		a.dt_prox_geracao >= dt_referencia_w - 3
		and		a.nr_atendimento = nr_atendimento_p
		and		coalesce(a.cd_setor_atendimento,0) <> cd_setor_atendimento_p
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		coalesce(a.ie_retrogrado,'N') = 'N'
		and 	((ie_susp_prescricoes_alta_w = 'S') or (((coalesce(a.ie_baixado_por_alta, 'N') = 'N') or (coalesce(a.dt_alta_medico, clock_timestamp()) > a.dt_prox_geracao + (nr_horas_copia_w/24)))))
		and		coalesce(a.cd_funcao_origem,2314) = 2314
		
union all
		
		select	'P' ie_tipo_item,
				a.nr_sequencia
		from	cpoe_procedimento a
		where	((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= (a.dt_prox_geracao + (nr_horas_copia_w/24))) or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
		and		a.dt_prox_geracao >= dt_referencia_w - 3
		and		a.nr_atendimento = nr_atendimento_p
		and		coalesce(a.cd_setor_atendimento,0) <> cd_setor_atendimento_p
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		coalesce(a.ie_retrogrado,'N') = 'N'
		and		consiste_se_copia_proc_int(a.nr_seq_proc_interno) = 'S'
		and		((coalesce(a.ie_evento_unico,'N') = 'N') or (not exists (	select	1
								from	prescr_medica y,
										prescr_procedimento z
								where	y.nr_prescricao = z.nr_prescricao
								and		y.nr_atendimento = nr_atendimento_p
								and		z.nr_seq_proc_cpoe = a.nr_sequencia)))
		and 	((ie_susp_prescricoes_alta_w = 'S') or (((coalesce(a.ie_baixado_por_alta, 'N') = 'N') or (coalesce(a.dt_alta_medico, clock_timestamp()) > a.dt_prox_geracao + (nr_horas_copia_w/24)))))
		and		coalesce(a.cd_funcao_origem,2314) = 2314
		
union all

		select	'D' ie_tipo_item,
				a.nr_sequencia
		from	cpoe_dialise a
		where	((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= (a.dt_prox_geracao + (nr_horas_copia_w/24))) or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
		and		a.dt_prox_geracao >= dt_referencia_w - 3
		and		a.nr_atendimento = nr_atendimento_p
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		coalesce(a.cd_setor_atendimento,0) <> cd_setor_atendimento_p
		and		coalesce(a.ie_retrogrado,'N') = 'N'
		and		((coalesce(a.ie_evento_unico,'N') = 'N') or (not exists (	select	1
								from	prescr_medica y,
										hd_prescricao z
								where	y.nr_prescricao = z.nr_prescricao
								and		y.nr_atendimento = nr_atendimento_p
								and		z.nr_seq_dialise_cpoe = a.nr_sequencia)))
		and 	((ie_susp_prescricoes_alta_w = 'S') or (((coalesce(a.ie_baixado_por_alta, 'N') = 'N') or (coalesce(a.dt_alta_medico, clock_timestamp()) > a.dt_prox_geracao + (nr_horas_copia_w/24)))))
		and	coalesce(a.cd_funcao_origem,2314) = 2314) alias182
order by 1,2;

	procedure Atualizar_cpoe( nm_tabela_p text ) is
		ds_sql_w	varchar(4000);
	
BEGIN	
	
		begin		
		
			cd_setor_atendimento_w := null;
			if (nm_tabela_p = 'cpoe_procedimento') then
				select	max(nr_seq_proc_interno),
							max(nm_usuario_nrec),
							max(cd_perfil_ativo),
							max(cd_setor_atendimento)
				into STRICT		nr_seq_proc_interno_w,
							nm_usuario_w,
							cd_perfil_w,
							cd_setor_procedimento_w
				from		cpoe_procedimento
				where	nr_sequencia = nr_seq_cpoe_w;
				
				param_CPOE_493_w := Obter_param_Usuario(924, 493, cd_perfil_w, nm_usuario_w, coalesce(WHEB_USUARIO_PCK.get_cd_estabelecimento, obter_estabelecimento_ativo), param_CPOE_493_w);
			
				if (cd_setor_procedimento_w = cd_setor_anterior_p) and (param_CPOE_493_w = 'S') then
					cd_setor_atendimento_w :=  cd_setor_atendimento_p;
				else
					cd_setor_atendimento_w := cd_setor_procedimento_w;
				end if;
			end if;	
				
			if (coalesce(cd_setor_atendimento_w::text, '') = '') then
				cd_setor_atendimento_w := cd_setor_atendimento_p;
			end if;
			
				
			ds_sql_w	:=
				' update	' || nm_tabela_p || ' a ' 						  ||
				' set		a.cd_setor_atendimento = :cd_setor_atendimento, ' ||
				'           a.nm_usuario = :nm_usuario,  '                    ||
				'			a.dt_atualizacao = sysdate' 					  ||
				' where		a.nr_sequencia = :nr_sequencia ' 				  ||
				' and		a.nr_atendimento =  :nr_atendimento ';
			
			EXECUTE
				ds_sql_w
			using
				cd_setor_atendimento_w,
				nm_usuario_p,
				nr_seq_cpoe_w,
				nr_atendimento_p;
		exception when others then
			ds_erro_w := substr(sqlerrm,1,2000);
			ds_log_w := substr(' ATUALIZA SETOR TRANSF 2: ds_erro_w='||ds_erro_w||';nr_atendimento_p='||nr_atendimento_p||';cd_setor_atendimento_p='||cd_setor_atendimento_p||';obter_perfil_ativo='||obter_perfil_ativo||
					';nm_usuario_p='||nm_usuario_p||';cd_estabelecimento_p='||cd_estabelecimento_p||';ie_tipo_item_w='||ie_tipo_item_w||';nr_seq_cpoe_w='||nr_seq_cpoe_w,1,2000);

			CALL gravar_log_tasy(10007, ds_log_w, nm_usuario_p);
			commit;
		end;	
	end;

begin

ie_susp_prescricoes_alta_w := Obter_param_Usuario(3111, 162, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_susp_prescricoes_alta_w);
nr_horas_copia_w := get_qt_hours_after_copy_cpoe(obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p);
dt_referencia_w	 := trunc(clock_timestamp(),'hh24');

begin			
	ds_log_w := substr(' ATUALIZA SETOR TRANSF 1: nr_atendimento_p='||nr_atendimento_p||';cd_setor_atendimento_p='||cd_setor_atendimento_p||';obter_perfil_ativo='||obter_perfil_ativo||
			';nm_usuario_p='||nm_usuario_p||';cd_estabelecimento_p='||cd_estabelecimento_p||';dt_referencia_w='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_referencia_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)||
			';nr_horas_copia_w='||nr_horas_copia_w||';ie_susp_prescricoes_alta_w='||ie_susp_prescricoes_alta_w,1,2000);

	CALL gravar_log_tasy(10007, ds_log_w, nm_usuario_p);
	commit;
exception when others then
null;
end;

begin
if (coalesce(nr_atendimento_p,0) > 0) and (coalesce(cd_setor_atendimento_p,0) > 0)  then

	open C01;
	loop
	fetch C01 into	
		ie_tipo_item_w,
		nr_seq_cpoe_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		
		if (ie_tipo_item_w = 'M') then			
			Atualizar_cpoe('cpoe_material');
			
		elsif (ie_tipo_item_w in ('O', 'N', 'J', 'T')) then
			Atualizar_cpoe('cpoe_dieta');
			
		elsif (ie_tipo_item_w = 'P') then
			Atualizar_cpoe('cpoe_procedimento');
		
		elsif (ie_tipo_item_w = 'A') then
			Atualizar_cpoe('cpoe_anatomia_patologica');			
			
		elsif (ie_tipo_item_w = 'G') then
			Atualizar_cpoe('cpoe_gasoterapia');
			
		elsif (ie_tipo_item_w = 'R') then
			Atualizar_cpoe('cpoe_recomendacao');
		
		 elsif (ie_tipo_item_w = 'H') then
			Atualizar_cpoe('cpoe_hemoterapia');
		
		elsif (ie_tipo_item_w = 'D') then				
			Atualizar_cpoe('cpoe_dialise');
		end if;
		
		end;
	end loop;
	close C01;

	commit;	

end if;
exception when others then

ds_erro_w := substr(sqlerrm,1,2000);
ds_log_w := substr(' ATUALIZA SETOR TRANSF 3: ds_erro_w='||ds_erro_w||';nr_atendimento_p='||nr_atendimento_p||';cd_setor_atendimento_p='||cd_setor_atendimento_p||';obter_perfil_ativo='||obter_perfil_ativo||
		';nm_usuario_p='||nm_usuario_p||';cd_estabelecimento_p='||cd_estabelecimento_p||';ie_tipo_item_w='||ie_tipo_item_w||';nr_seq_cpoe_w='||nr_seq_cpoe_w,1,2000);

CALL gravar_log_tasy(10007, ds_log_w, nm_usuario_p);
commit;

end;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_atualizar_setor_tranf ( nr_atendimento_p bigint, cd_setor_atendimento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, cd_setor_anterior_p bigint) FROM PUBLIC;

