-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_procmat_rep_agrup (nr_seq_terceiro_p bigint, cd_medico_p text, ie_alta_complexidade_p text, nm_usuario_p text, ie_proc_mat_p text) AS $body$
DECLARE

 
nr_sequencia_w	bigint;
vl_repasse_w	bigint;

c01 CURSOR FOR 
SELECT	a.nr_sequencia, 
	a.vl_repasse 
from	procedimento d, 
	procedimento_paciente c, 
	w_repasse_agrup b, 
	procedimento_repasse a 
where	c.ie_origem_proced	= d.ie_origem_proced 
and	c.cd_procedimento	= d.cd_procedimento 
and	a.nr_seq_procedimento	= c.nr_sequencia 
and	a.nr_sequencia		= b.nr_seq_proc_repasse 
and	d.ie_alta_complexidade	= coalesce(ie_alta_complexidade_p, d.ie_alta_complexidade) 
and	b.nm_usuario		= b.nm_usuario 
and	coalesce(a.cd_medico, 'X')	= coalesce(cd_medico_p, coalesce(a.cd_medico, 'X')) 
and	a.nr_seq_terceiro	= nr_seq_terceiro_p;

c02 CURSOR FOR 
SELECT	a.nr_sequencia, 
	a.vl_repasse 
from	w_repasse_agrup b, 
	material_repasse a 
where	a.nr_sequencia		= b.nr_seq_mat_repasse 
and	coalesce(a.cd_medico, 'X')	= coalesce(cd_medico_p, coalesce(a.cd_medico, 'X')) 
and	a.nr_seq_terceiro	= nr_seq_terceiro_p;


BEGIN 
 
if (ie_proc_mat_p = 'P') or (ie_proc_mat_p = 'A') then 
	open c01;
	loop 
	fetch c01 into 
		nr_sequencia_w, 
		vl_repasse_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		CALL Liberar_ProcMat_Repasse(nr_sequencia_w, 
			null, 
			'L',       
			vl_repasse_w, 
			null,    
			clock_timestamp(), 
			null, 
			nm_usuario_p, 
			null);
	end loop;
	close c01;
end if;
 
if (ie_proc_mat_p = 'M') or (ie_proc_mat_p = 'A') then 
	open c02;
	loop 
	fetch c02 into 
		nr_sequencia_w, 
		vl_repasse_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		CALL Liberar_ProcMat_Repasse(null, 
			nr_sequencia_w, 
			'L', 
			vl_repasse_w, 
			null,    
			clock_timestamp(), 
			null, 
			nm_usuario_p, 
			null);
	end loop;
	close c02;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_procmat_rep_agrup (nr_seq_terceiro_p bigint, cd_medico_p text, ie_alta_complexidade_p text, nm_usuario_p text, ie_proc_mat_p text) FROM PUBLIC;

