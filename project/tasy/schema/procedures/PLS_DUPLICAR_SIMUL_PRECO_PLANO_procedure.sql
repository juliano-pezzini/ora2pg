-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_duplicar_simul_preco_plano ( nr_seq_simulacao_p bigint, nr_seq_plano_p bigint, nr_seq_tabela_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
nr_seq_simulacao_nova_w		pls_simulacao_preco.nr_sequencia%type;
nr_seq_simul_benef_w		pls_simulpreco_individual.nr_sequencia%type;

C01 CURSOR FOR 
	SELECT	nr_sequencia 
	from	pls_simulpreco_individual 
	where	nr_seq_simulacao	= nr_seq_simulacao_p;

C02 CURSOR(nr_seq_simul_benef_pc	pls_simulpreco_individual.nr_sequencia%type) FOR 
	SELECT	nr_sequencia, 
		nr_seq_bonificacao, 
		tx_bonificacao, 
		vl_bonificacao 
	from	pls_bonificacao_vinculo 
	where	nr_seq_segurado_simul = nr_seq_simul_benef_pc;

C03 CURSOR(nr_seq_simul_benef_pc	pls_simulpreco_individual.nr_sequencia%type) FOR 
	SELECT	nr_sequencia, 
		nr_seq_plano, 
		nr_seq_tabela, 
		ds_observacao 
	from	pls_sca_vinculo 
	where	nr_seq_segurado_simul = nr_seq_simul_benef_pc;

C04 CURSOR FOR 
	SELECT	nr_sequencia 
	from	pls_simulpreco_individual 
	where	nr_seq_simulacao	= nr_seq_simulacao_nova_w;

BEGIN 
 
select	nextval('pls_simulacao_preco_seq') 
into STRICT	nr_seq_simulacao_nova_w
;
 
insert	into	pls_simulacao_preco(	nr_sequencia, 
		dt_atualizacao, 
		dt_atualizacao_nrec, 
		nm_usuario, 
		nm_usuario_nrec, 
		cd_estabelecimento, 
		dt_simulacao, 
		ie_tipo_contratacao, 
		nm_pessoa, 
		tx_desconto, 
		nr_seq_parametro_com, 
		ds_email, 
		cd_municipio_ibge, 
		sg_estado, 
		nr_ddi, 
		nr_ddd, 
		nr_telefone, 
		nr_contrato, 
		nr_seq_cliente, 
		nr_seq_solicitacao, 
		nr_seq_proposta 
		) 
	(SELECT	nr_seq_simulacao_nova_w, 
		clock_timestamp(), 
		clock_timestamp(), 
		nm_usuario_p, 
		nm_usuario_p, 
		cd_estabelecimento_p, 
		clock_timestamp(), 
		ie_tipo_contratacao, 
		nm_pessoa, 
		0, 
		nr_seq_parametro_com, 
		ds_email, 
		cd_municipio_ibge, 
		sg_estado, 
		nr_ddi, 
		nr_ddd, 
		nr_telefone, 
		nr_contrato, 
		nr_seq_cliente, 
		nr_seq_solicitacao, 
		nr_seq_proposta 
	from	pls_simulacao_preco 
	where	nr_sequencia	= nr_seq_simulacao_p);
 
for r_c01_w in C01 loop 
	begin 
	 
	select	nextval('pls_simulpreco_individual_seq') 
	into STRICT	nr_seq_simul_benef_w 
	;
	 
	insert	into	pls_simulpreco_individual(	nr_sequencia, 
		dt_atualizacao, 
		dt_atualizacao_nrec, 
		nm_usuario, 
		nm_usuario_nrec, 
		nr_seq_simulacao, 
		nr_seq_produto, 
		nr_seq_tabela, 
		qt_idade, 
		nm_beneficiario, 
		dt_nascimento, 
		ie_tipo_benef, 
		nr_seq_parentesco, 
		cd_pessoa_fisica 
		) 
	(SELECT	nr_seq_simul_benef_w, 
		clock_timestamp(), 
		clock_timestamp(), 
		nm_usuario_p, 
		nm_usuario_p, 
		nr_seq_simulacao_nova_w, 
		nr_seq_plano_p, 
		nr_seq_tabela_p, 
		qt_idade, 
		nm_beneficiario, 
		dt_nascimento, 
		ie_tipo_benef, 
		nr_seq_parentesco, 
		cd_pessoa_fisica 
	from	pls_simulpreco_individual 
	where	nr_sequencia	= r_c01_w.nr_sequencia);
	 
	for r_c02_w in C02(r_c01_w.nr_sequencia) loop 
		begin 
		 
		insert	into	pls_bonificacao_vinculo(	nr_sequencia, 
				dt_atualizacao, 
				dt_atualizacao_nrec, 
				nm_usuario, 
				nm_usuario_nrec, 
				nr_seq_segurado_simul, 
				nr_seq_bonificacao, 
				tx_bonificacao, 
				vl_bonificacao) 
			values (	nextval('pls_bonificacao_vinculo_seq'), 
				clock_timestamp(), 
				clock_timestamp(), 
				nm_usuario_p, 
				nm_usuario_p, 
				nr_seq_simul_benef_w, 
				r_c02_w.nr_seq_bonificacao, 
				r_c02_w.tx_bonificacao, 
				r_c02_w.vl_bonificacao);
		end;
	end loop; --C02 
	
	for r_c03_w in C03(r_c01_w.nr_sequencia) loop 
		begin 
		 
		insert	into	pls_sca_vinculo(	nr_sequencia, 
				dt_atualizacao, 
				dt_atualizacao_nrec, 
				nm_usuario, 
				nm_usuario_nrec, 
				nr_seq_segurado_simul, 
				ds_observacao, 
				nr_seq_plano, 
				nr_seq_tabela) 
			values (	nextval('pls_sca_vinculo_seq'), 
				clock_timestamp(), 
				clock_timestamp(), 
				nm_usuario_p, 
				nm_usuario_p, 
				nr_seq_simul_benef_w, 
				r_c03_w.ds_observacao, 
				r_c03_w.nr_seq_plano, 
				r_c03_w.nr_seq_tabela);
		end;
	end loop;
	 
	end;
end loop; --C03 
 
--Calcular valor da simulação 
CALL pls_recalcular_simulacao(nr_seq_simulacao_nova_w,nm_usuario_p);
 
for r_c04_w in C04 loop 
	begin 
	CALL pls_gerar_resumo_simulacao(nr_seq_simulacao_nova_w, r_c04_w.nr_sequencia, 'I', 'BS', 'I', cd_estabelecimento_p, nm_usuario_p);
	end;
end loop;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_duplicar_simul_preco_plano ( nr_seq_simulacao_p bigint, nr_seq_plano_p bigint, nr_seq_tabela_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

