-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE suspender_prot_simul_onc ( cd_pessoa_fisica_p text, nr_seq_paciente_p bigint, cd_protocolo_p bigint, nr_seq_medicacao_p bigint ) AS $body$
DECLARE

					 
nm_usuario_w			varchar(15);
nr_seq_paciente_w			bigint;
nr_prescricao_susp_w		bigint;
nr_seq_atendimento_w		bigint;

 
C01 CURSOR FOR 
	SELECT b.nr_seq_atendimento, 
		b.nr_prescricao 
	from	paciente_setor a, 
		paciente_atendimento b 
	where	a.cd_pessoa_fisica	= cd_pessoa_fisica_p 
	and	a.nr_seq_paciente 	<> nr_seq_paciente_p 
	and	coalesce(b.dt_real,b.dt_prevista) >= clock_timestamp() 
	and	a.nr_seq_paciente = b.nr_seq_paciente 
	and	Obter_se_ciclo_gerado(a.nr_seq_paciente) = 'S' 
	and	a.ie_status = 'A' 
	and	coalesce(b.dt_cancelamento::text, '') = '' 
	and	obter_se_regra_prot_simul_onc(a.cd_protocolo) = 'N' 
	order by a.nr_seq_paciente;	
	 

BEGIN 
 
nm_usuario_w 	:= wheb_usuario_pck.get_nm_usuario;
 
open C01;
loop 
fetch C01 into	 
	nr_seq_atendimento_w, 
	nr_prescricao_susp_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin	 
	 
	CALL suspender_dia_tratamento_onco( nr_prescricao_susp_w, nr_seq_atendimento_w, nm_usuario_w);
	 
	commit;	
	 
	end;
end loop;
close C01;	
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE suspender_prot_simul_onc ( cd_pessoa_fisica_p text, nr_seq_paciente_p bigint, cd_protocolo_p bigint, nr_seq_medicacao_p bigint ) FROM PUBLIC;

