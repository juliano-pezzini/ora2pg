-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_dieta_oral_rotina ( nr_atendimento_p bigint, nr_seq_produto_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_paciente_p cpoe_dieta.cd_pessoa_fisica%type, nr_seq_item_gerado_p INOUT bigint, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, nr_seq_conclusao_apae_p bigint default null, ie_futuro_p text default 'N', nr_seq_perfil_cal_p bigint default null, nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) AS $body$
DECLARE


ds_stack_w				log_cpoe.ds_stack%type;
ds_log_cpoe_w			log_cpoe.ds_log%type;
nr_seq_dieta_w	        cpoe_dieta.nr_sequencia%type;
nr_ocorrencia_w			cpoe_dieta.nr_ocorrencia%type;
cd_intervalo_w			cpoe_dieta.cd_intervalo%type;
ds_horarios_aux_w		cpoe_dieta.ds_horarios%type;
ds_horarios_w			cpoe_dieta.ds_horarios%type;
hr_prim_horario_w		cpoe_dieta.hr_prim_horario%type;
dt_inicio_w				cpoe_dieta.dt_inicio%type;
dt_inicio_base_w		cpoe_dieta.dt_inicio%type;
cd_intervalo_agora_w	cpoe_dieta.cd_intervalo%type;
dt_fim_w				cpoe_dieta.dt_fim%type := null;
ie_duracao_w			cpoe_dieta.ie_duracao%type := 'C';
ie_evento_unico_w		cpoe_dieta.ie_evento_unico%type := 'N';

ie_dose_unica_cpoe_w	intervalo_prescricao.ie_dose_unica_cpoe%type;

ie_urgencia_w			varchar(1):=null;
ie_prescr_alta_agora_w	varchar(1);
ie_param_47_CPOE_w      varchar(1);


BEGIN

ie_prescr_alta_agora_w := obter_param_usuario(924, 409, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_prescr_alta_agora_w);
ie_param_47_cpoe_w := obter_param_usuario(2314, 47, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_param_47_cpoe_w);
dt_inicio_base_w	:= trunc(clock_timestamp(),'mi');

select  max(cd_intervalo)
into STRICT    cd_intervalo_w
from    intervalo_prescricao
where   coalesce(ie_padrao_nut,'N') = 'S'
and     ie_situacao = 'A'
and	Obter_se_intervalo_estab(cd_intervalo, cd_estabelecimento_p) = 'S'
and ((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_p));

if (coalesce(cd_intervalo_w::text, '') = '')then
	select max(cd_intervalo)
	into STRICT    cd_intervalo_w
	from dieta 
	where cd_dieta = nr_seq_produto_p
	and     ie_situacao = 'A';
end if;

hr_prim_horario_w	:= coalesce(substr(cpoe_obter_primeiro_horario( nr_atendimento_p, cd_intervalo_w, null, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, cd_paciente_p ),1,5), hr_prim_horario_w);

if (coalesce(obter_se_marca_agora(cpoe_obter_setor_atend_prescr(nr_atendimento_p, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p)),'N') = 'S') then
	cd_intervalo_agora_w := cpoe_busca_intervalo_agora(nr_atendimento_p,'13',cd_estabelecimento_p,cd_perfil_p, nm_usuario_p);

	if (cd_intervalo_agora_w IS NOT NULL AND cd_intervalo_agora_w::text <> '') then
		cd_intervalo_w := cd_intervalo_agora_w;
		ie_urgencia_w  := '0';
		hr_prim_horario_w :=  to_char(clock_timestamp(),'hh24:mi');
	end if;
	
end if;	

if (ie_param_47_cpoe_w = '0') then
    select  max(cd_intervalo)
    into STRICT    cd_intervalo_w
    from    dieta_oral
    where   cd_dieta = nr_seq_produto_p;
end if;

if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') then
	select	max(ie_dose_unica_cpoe)
	into STRICT	ie_dose_unica_cpoe_w
	from	intervalo_prescricao
	where	cd_intervalo = cd_intervalo_w;

	if (coalesce(ie_dose_unica_cpoe_w, 'N') = 'S') then
		ie_duracao_w := 'P';
		ie_evento_unico_w := 'S';
	end if;
end if;

if (coalesce(ie_prescr_alta_agora_w,'N') = 'S') and (coalesce(ie_item_alta_p,'N') = 'S')	then	
	ie_urgencia_w  := '0';	
	hr_prim_horario_w :=  to_char(clock_timestamp(),'hh24:mi');			
end if;

dt_inicio_w			:= to_date(to_char(dt_inicio_base_w,'dd/mm/yyyy ')  || hr_prim_horario_w, 'dd/mm/yyyy hh24:mi');

if (dt_inicio_w < dt_inicio_base_w) and (coalesce(ie_urgencia_w,'XPTO') <> '0') then
	dt_inicio_w := dt_inicio_w + 1;
end if;

nr_ocorrencia_w		:= 0;
ds_horarios_w		:= '';
ds_horarios_aux_w	:= '';

if (ie_duracao_w = 'P') then
	dt_fim_w := (dt_inicio_w + 1) - 1/1440;
end if;

if (ie_retrogrado_p = 'S' or ie_futuro_p = 'S') then -- retrograde/backward item
	dt_inicio_w := dt_inicio_p;
	dt_fim_w := (dt_inicio_w + 1) - 1/1440;
	ie_duracao_w := 'P';
	ie_urgencia_w  := null;
	hr_prim_horario_w :=  to_char(dt_inicio_w,'hh24:mi');		
end if;

SELECT * FROM cpoe_calcular_horario_prescr(nr_atendimento_p, cd_intervalo_w, null, dt_inicio_w, null, null, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;
ds_horarios_w	:= substr(ds_horarios_w || ds_horarios_aux_w,1,4000);

select	nextval('cpoe_dieta_seq')
into STRICT	nr_seq_dieta_w
;

nr_seq_item_gerado_p := nr_seq_dieta_w;

insert into cpoe_dieta(
        nr_sequencia,
        cd_dieta,
        qt_parametro,
        nr_ocorrencia,
        cd_intervalo,
        ie_administracao,
        dt_inicio,
        hr_prim_horario,
        ie_urgencia,
        ds_horarios,
        nm_usuario,
        nm_usuario_nrec,
        dt_atualizacao,
        dt_atualizacao_nrec,
        nr_atendimento,
        ie_duracao,
        ie_evento_unico,
        dt_fim,
        ds_justificativa,
        ds_observacao,
        ie_tipo_dieta,
        cd_perfil_ativo,
        cd_pessoa_fisica,
        cd_funcao_origem,
        nr_seq_transcricao,
        ie_item_alta,
        ie_prescritor_aux,
        cd_medico,
        ie_retrogrado,
        nr_seq_pepo,
        nr_cirurgia,
        nr_cirurgia_patologia,
        nr_seq_agenda,
        nr_seq_conclusao_apae,
        ie_futuro,
        nr_seq_perfil_cal,
        nr_seq_cpoe_order_unit
    ) values (
        nr_seq_dieta_w,
        nr_seq_produto_p,
        null,
        nr_ocorrencia_w,
        cd_intervalo_w,
        'P',
        dt_inicio_w,
        hr_prim_horario_w,
        ie_urgencia_w,
        ds_horarios_w,
        nm_usuario_p,
        nm_usuario_p,
        clock_timestamp(),
        clock_timestamp(),
        nr_atendimento_p,
        ie_duracao_w,
        ie_evento_unico_w,
        dt_fim_w,
        '',
        '',
        'O',
        cd_perfil_p,
        cd_paciente_p,
        2314,
        nr_seq_transcricao_p,
        ie_item_alta_p,
        ie_prescritor_aux_p,
        cd_medico_p,
        ie_retrogrado_p,
        nr_seq_pepo_p,
        nr_cirurgia_p,
        nr_cirurgia_patologia_p,
        nr_seq_agenda_p,
        nr_seq_conclusao_apae_p,
        ie_futuro_p,
        nr_seq_perfil_cal_p,
        nr_seq_cpoe_order_unit_p
    );

commit;

exception
   when others then
	rollback;

	ds_stack_w	:= substr(dbms_utility.format_call_stack,1,2000);
	ds_log_cpoe_w := substr('CPOE_GERAR_DIETA_ORAL_ROTINA '
		|| chr(13) || ' - nr_atendimento_p: ' || nr_atendimento_p
		|| chr(13) || ' - nr_seq_produto_p: ' || nr_seq_produto_p
		|| chr(13) || ' - cd_estabelecimento_p: ' || cd_estabelecimento_p
		|| chr(13) || ' - cd_perfil_p: ' || cd_perfil_p
		|| chr(13) || ' - nm_usuario_p: ' || nm_usuario_p
		|| chr(13) || ' - cd_paciente_p: ' || cd_paciente_p
		|| chr(13) || ' - nr_seq_item_gerado_p: ' || nr_seq_item_gerado_p
		|| chr(13) || ' - nr_seq_transcricao_p: ' || nr_seq_transcricao_p
		|| chr(13) || ' - ie_item_alta_p: ' || ie_item_alta_p
		|| chr(13) || ' - ie_prescritor_aux_p: ' || ie_prescritor_aux_p
		|| chr(13) || ' - cd_medico_p: ' || cd_medico_p
		|| chr(13) || ' - ie_retrogrado_p: ' || ie_retrogrado_p
		|| chr(13) || ' - ie_futuro_p: ' || ie_futuro_p
		|| chr(13) || ' - dt_inicio_p: ' || to_char(dt_inicio_p, 'dd/mm/yyyy hh24:mi:ss')
		|| chr(13) || ' - nr_seq_pepo_p: ' || nr_seq_pepo_p
		|| chr(13) || ' - nr_cirurgia_p: ' || nr_cirurgia_p
		|| chr(13) || ' - nr_cirurgia_patologia_p: ' || nr_cirurgia_patologia_p
		|| chr(13) || ' - nr_seq_agenda_p: ' || nr_seq_agenda_p
		|| chr(13) || ' - nr_seq_conclusao_apae_p: ' || nr_seq_conclusao_apae_p
		|| chr(13) || ' - ERRO: ' || sqlerrm
		|| chr(13) || ' - FUNCAO('||to_char(obter_funcao_ativa)||'); PERFIL('||to_char(obter_perfil_ativo)||')',1,2000);
		
	insert into log_cpoe(
		nr_sequencia,
		nr_atendimento, 
		dt_atualizacao, 
		nm_usuario, 
		ds_log, 
		ds_stack) 
	values (
		nextval('log_cpoe_seq'), 
		nr_atendimento_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		ds_log_cpoe_w, 
		ds_stack_w);
		
	commit;

	CALL wheb_mensagem_pck.exibir_mensagem_abort(sqlerrm);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_dieta_oral_rotina ( nr_atendimento_p bigint, nr_seq_produto_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_paciente_p cpoe_dieta.cd_pessoa_fisica%type, nr_seq_item_gerado_p INOUT bigint, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, nr_seq_conclusao_apae_p bigint default null, ie_futuro_p text default 'N', nr_seq_perfil_cal_p bigint default null, nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) FROM PUBLIC;

