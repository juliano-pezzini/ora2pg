-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_interf_itau (nr_seq_envio_p bigint, nm_usuario_p text) AS $body$
DECLARE



ie_tipo_registro_w		smallint;
nr_seq_forma_pagto_w		smallint;
ie_tipo_reg_w			smallint;
nr_inscricao_w			varchar(20);
cd_agencia_w			varchar(20);
cd_conta_w			varchar(20);
ds_dac_agencia_w		varchar(2);
nm_empresa_w			varchar(80);
ds_banco_w			varchar(255);
dt_geracao_w			timestamp;
nr_lote_w			smallint := 0;
nr_seq_envio_w			bigint;

ds_endereco_w			varchar(255);
nr_endereco_w			varchar(10);
ds_cidade_w			varchar(40);
cd_cep_w			varchar(10);
sg_estado_w			varchar(15);

nm_fornecedor_w			varchar(80);
nr_documento_w			bigint;
dt_vencimento_w			timestamp;
vl_saldo_titulo_w		double precision;
cd_cgc_fornecedor_w		varchar(14);
cd_banco_w			integer;

cd_barras_w			varchar(255);
vl_titulo_w			double precision;
vl_desconto_w			double precision;
vl_acrescimo_w			double precision;
dt_pagto_w			timestamp;
vl_pagto_w			double precision;

qt_registros_w			bigint;
vl_total_pagto_w		double precision;

qt_lote_arquivo_w		bigint;
qt_reg_tabela_w			bigint;
qt_tot_reg_w			bigint;
nr_registro_w			bigint;
ie_tipo_inscricao_w		smallint;
nr_inscricao_sacado_w		varchar(14);
nr_inscricao_fornec_w		varchar(14);
nr_seq_apres_w			bigint;
nr_seq_apres_atual_w		bigint;
nr_ult_apres_w			bigint;
vl_saldo_juros_w		double precision;
vl_saldo_multa_w		double precision;

ie_registro_w			gps.cd_pagamento%type;
dt_arquivo_w			timestamp;

c01 CURSOR FOR
	SELECT	distinct 			-- 	Header lote Conta Corrente
		1,
		1,
		substr(e.cd_cgc,1,14),
		substr(b.cd_agencia_bancaria,1,8),
		substr(b.cd_conta,1,15),
		substr(b.ie_digito_conta,1,2),
		substr(upper(elimina_acentuacao(j.ds_razao_social)),1,80),
		substr(upper(elimina_acentuacao(j.ds_endereco)),1,10),
		substr(j.nr_endereco,1,10),
		substr(upper(elimina_acentuacao(j.ds_municipio)),1,40),
		substr(j.cd_cep,1,10),
		substr(upper(j.sg_estado),1,2),
		1 nr_seq_apres
	from	pessoa_juridica j,
		estabelecimento e,
		banco_estabelecimento_v b,
		titulo_pagar k,
		titulo_pagar_escrit c,
		banco_escritural a
	where	e.cd_cgc		= j.cd_cgc
	  and	c.nr_titulo		= k.nr_titulo
	  and	a.nr_sequencia		= c.nr_seq_escrit
	  and	a.cd_estabelecimento	= e.cd_estabelecimento
	  and	b.nr_sequencia		= a.nr_seq_conta_banco
	  and	b.ie_tipo_relacao	in ('EP','ECC')
	  and	c.ie_tipo_pagamento	= 'CC'
	  and	a.nr_sequencia		= nr_seq_envio_p
	
union

	SELECT	distinct 			-- 	Header lote DOC
		1,
		3,
		substr(e.cd_cgc,1,14),
		substr(b.cd_agencia_bancaria,1,8),
		substr(b.cd_conta,1,15),
		substr(b.ie_digito_conta,1,2),
		substr(upper(elimina_acentuacao(j.ds_razao_social)),1,80),
		substr(upper(elimina_acentuacao(j.ds_endereco)),1,10),
		substr(j.nr_endereco,1,10),
		substr(upper(elimina_acentuacao(j.ds_municipio)),1,40),
		substr(j.cd_cep,1,10),
		substr(upper(j.sg_estado),1,2),
		10001 nr_seq_apres
	from	pessoa_juridica j,
		estabelecimento e,
		banco_estabelecimento_v b,
		titulo_pagar k,
		titulo_pagar_escrit c,
		banco_escritural a
	where	e.cd_cgc		= j.cd_cgc
	  and	c.nr_titulo		= k.nr_titulo
	  and	a.nr_sequencia		= c.nr_seq_escrit
	  and	a.cd_estabelecimento	= e.cd_estabelecimento
	  and	b.nr_sequencia		= a.nr_seq_conta_banco
	  and	b.ie_tipo_relacao	in ('EP','ECC')
	  and	c.ie_tipo_pagamento	= 'DOC'
	  and	a.nr_sequencia		= nr_seq_envio_p
	
union

	select	distinct 			-- 	Header lote Ordem Pagamento
		1,
		10,
		substr(e.cd_cgc,1,14),
		substr(b.cd_agencia_bancaria,1,8),
		substr(b.cd_conta,1,15),
		substr(b.ie_digito_conta,1,2),
		substr(upper(elimina_acentuacao(j.ds_razao_social)),1,80),
		substr(upper(elimina_acentuacao(j.ds_endereco)),1,10),
		substr(j.nr_endereco,1,10),
		substr(upper(elimina_acentuacao(j.ds_municipio)),1,40),
		substr(j.cd_cep,1,10),
		substr(upper(j.sg_estado),1,2),
		20001 nr_seq_apres
	from	pessoa_juridica j,
		estabelecimento e,
		banco_estabelecimento_v b,
		titulo_pagar k,
		titulo_pagar_escrit c,
		banco_escritural a
	where	e.cd_cgc		= j.cd_cgc
	  and	c.nr_titulo		= k.nr_titulo
	  and	a.nr_sequencia		= c.nr_seq_escrit
	  and	a.cd_estabelecimento	= e.cd_estabelecimento
	  and	b.nr_sequencia		= a.nr_seq_conta_banco
	  and	b.ie_tipo_relacao	in ('EP','ECC')
	  and	c.ie_tipo_pagamento	= 'OP'
	  and	a.nr_sequencia		= nr_seq_envio_p
	
union

	select	distinct 			-- 	Header lote TED
		1,
		41,
		substr(e.cd_cgc,1,14),
		substr(b.cd_agencia_bancaria,1,8),
		substr(b.cd_conta,1,15),
		substr(b.ie_digito_conta,1,2),
		substr(upper(elimina_acentuacao(j.ds_razao_social)),1,80),
		substr(upper(elimina_acentuacao(j.ds_endereco)),1,10),
		substr(j.nr_endereco,1,10),
		substr(upper(elimina_acentuacao(j.ds_municipio)),1,40),
		substr(j.cd_cep,1,10),
		substr(upper(j.sg_estado),1,2),
		30001 nr_seq_apres
	from	pessoa_juridica j,
		estabelecimento e,
		banco_estabelecimento_v b,
		titulo_pagar k,
		titulo_pagar_escrit c,
		banco_escritural a
	where	e.cd_cgc		= j.cd_cgc
	  and	c.nr_titulo		= k.nr_titulo
	  and	a.nr_sequencia		= c.nr_seq_escrit
	  and	a.cd_estabelecimento	= e.cd_estabelecimento
	  and	b.nr_sequencia		= a.nr_seq_conta_banco
	  and	b.ie_tipo_relacao	in ('EP','ECC')
	  and	c.ie_tipo_pagamento	= 'TED'
	  and	a.nr_sequencia		= nr_seq_envio_p
	
union

	select	distinct 			-- 	Header lote bloqueto Itau
		4,
		30,
		substr(e.cd_cgc,1,14),
		substr(b.cd_agencia_bancaria,1,8),
		substr(b.cd_conta,1,15),
		substr(b.ie_digito_conta,1,2),
		substr(upper(elimina_acentuacao(j.ds_razao_social)),1,80),
		substr(upper(elimina_acentuacao(j.ds_endereco)),1,40),
		substr(j.nr_endereco,1,10),
		substr(upper(elimina_acentuacao(j.ds_municipio)),1,40),
		substr(j.cd_cep,1,10),
		substr(upper(j.sg_estado),1,2),
		40001 nr_seq_apres
	from	pessoa_juridica j,
		estabelecimento e,
		banco_estabelecimento_v b,
		titulo_pagar_v2 k,
		titulo_pagar_escrit c,
		banco_escritural a
	where	e.cd_cgc			= j.cd_cgc
	  and	c.nr_titulo			= k.nr_titulo
	  and	a.nr_sequencia			= c.nr_seq_escrit
	  and	a.cd_estabelecimento		= e.cd_estabelecimento
	  and	b.nr_sequencia			= a.nr_seq_conta_banco
	  and	b.ie_tipo_relacao		in ('EP','ECC')
	  and	c.ie_tipo_pagamento		= 'BLQ'
	  and	substr(k.nr_bloqueto,1,3)	= 341
	  and	a.nr_sequencia			= nr_seq_envio_p
	
union

	select	distinct 			-- 	Header lote bloqueto nao Itau
		4,
		31,
		substr(e.cd_cgc,1,14),
		substr(b.cd_agencia_bancaria,1,8),
		substr(b.cd_conta,1,15),
		substr(b.ie_digito_conta,1,2),
		substr(upper(elimina_acentuacao(j.ds_razao_social)),1,80),
		substr(upper(elimina_acentuacao(j.ds_endereco)),1,40),
		substr(j.nr_endereco,1,10),
		substr(upper(elimina_acentuacao(j.ds_municipio)),1,40),
		substr(j.cd_cep,1,10),
		substr(upper(j.sg_estado),1,2),
		50001 nr_seq_apres
	from	pessoa_juridica j,
		estabelecimento e,
		banco_estabelecimento_v b,
		titulo_pagar_v2 k,
		titulo_pagar_escrit c,
		banco_escritural a
	where	e.cd_cgc			= j.cd_cgc
	  and	c.nr_titulo			= k.nr_titulo
	  and	a.nr_sequencia			= c.nr_seq_escrit
	  and	a.cd_estabelecimento		= e.cd_estabelecimento
	  and	b.nr_sequencia			= a.nr_seq_conta_banco
	  and	b.ie_tipo_relacao		in ('EP','ECC')
	  and	c.ie_tipo_pagamento		= 'BLQ'
	  and	substr(k.nr_bloqueto,1,3)	<> 341
	  and	a.nr_sequencia			= nr_seq_envio_p
	
union

	select	distinct 			-- 	Header lote Pagamento Concessionarias
		8,
		13,
		substr(e.cd_cgc,1,14),
		substr(b.cd_agencia_bancaria,1,8),
		substr(b.cd_conta,1,15),
		substr(b.ie_digito_conta,1,2),
		substr(upper(elimina_acentuacao(j.ds_razao_social)),1,80),
		substr(upper(elimina_acentuacao(j.ds_endereco)),1,10),
		substr(j.nr_endereco,1,10),
		substr(upper(elimina_acentuacao(j.ds_municipio)),1,40),
		substr(j.cd_cep,1,10),
		substr(upper(j.sg_estado),1,2),
		60001 nr_seq_apres
	from	pessoa_juridica j,
		estabelecimento e,
		banco_estabelecimento_v b,
		titulo_pagar_v2 k,
		titulo_pagar_escrit c,
		banco_escritural a
	where	e.cd_cgc		= j.cd_cgc
	  and	c.nr_titulo		= k.nr_titulo
	  and	a.nr_sequencia		= c.nr_seq_escrit
	  and	a.cd_estabelecimento	= e.cd_estabelecimento
	  and	b.nr_sequencia		= a.nr_seq_conta_banco
	  and	b.ie_tipo_relacao	in ('EP','ECC')
	  and	c.ie_tipo_pagamento	= 'PC'
	  and  not  exists (select    1
	  from    darf_titulo_pagar x
	  where    x.nr_titulo    = c.nr_titulo)
	  and not exists (select    1
	  from    gps_titulo x
	  where    x.nr_titulo    = c.nr_titulo)
	  and	a.nr_sequencia		= nr_seq_envio_p
	
union

	select	distinct 			-- 	Header lote Pagamento DARF
		15,
		16,
		substr(e.cd_cgc,1,14),
		substr(b.cd_agencia_bancaria,1,8),
		substr(b.cd_conta,1,15),
		substr(b.ie_digito_conta,1,2),
		substr(upper(elimina_acentuacao(j.ds_razao_social)),1,80),
		substr(upper(elimina_acentuacao(j.ds_endereco)),1,10),
		substr(j.nr_endereco,1,10),
		substr(upper(elimina_acentuacao(j.ds_municipio)),1,40),
		substr(j.cd_cep,1,10),
		substr(upper(j.sg_estado),1,2),
		80001 nr_seq_apres
	from	darf g,
		darf_titulo_pagar f,
		pessoa_juridica j,
		estabelecimento e,
		banco_estabelecimento_v b,
		titulo_pagar_v2 k,
		titulo_pagar_escrit c,
		banco_escritural a
	where	e.cd_cgc		= j.cd_cgc
	  and	c.nr_titulo		= k.nr_titulo
	  and	a.nr_sequencia		= c.nr_seq_escrit
	  and	a.cd_estabelecimento	= e.cd_estabelecimento
	  and	b.nr_sequencia		= a.nr_seq_conta_banco
	  and	b.ie_tipo_relacao	in ('EP','ECC')
	  and	c.ie_tipo_pagamento	= 'PC'
	  and	f.nr_seq_darf	= g.nr_sequencia
	  and	f.nr_titulo		= c.nr_titulo
	  and	a.nr_sequencia		= nr_seq_envio_p
	
union
	
  select	distinct 			-- 	Header lote Pagamento GPS
		16,
		17,
		substr(e.cd_cgc,1,14),
		substr(b.cd_agencia_bancaria,1,8),
		substr(b.cd_conta,1,15),
		substr(b.ie_digito_conta,1,2),
		substr(upper(elimina_acentuacao(j.ds_razao_social)),1,80),
		substr(upper(elimina_acentuacao(j.ds_endereco)),1,10),
		substr(j.nr_endereco,1,10),
		substr(upper(elimina_acentuacao(j.ds_municipio)),1,40),
		substr(j.cd_cep,1,10),
		substr(upper(j.sg_estado),1,2),
		90001 nr_seq_apres
	from		gps g,
		gps_titulo f,
		pessoa_juridica j,
		estabelecimento e,
		banco_estabelecimento_v b,
		titulo_pagar_v2 k,
		titulo_pagar_escrit c,
		banco_escritural a
	where	e.cd_cgc		= j.cd_cgc
	  and	c.nr_titulo		= k.nr_titulo
	  and	a.nr_sequencia		= c.nr_seq_escrit
	  and	a.cd_estabelecimento	= e.cd_estabelecimento
	  and	b.nr_sequencia		= a.nr_seq_conta_banco
	  and	b.ie_tipo_relacao	in ('EP','ECC')
	  and	c.ie_tipo_pagamento	= 'PC'
	  and	f.nr_seq_gps	= g.nr_sequencia
	  and	f.nr_titulo		= c.nr_titulo
	  and	a.nr_sequencia		= nr_seq_envio_p
	
union

	select	distinct 			-- 	Header lote DOC poupanca
		1,
		5,
		substr(e.cd_cgc,1,14),
		substr(b.cd_agencia_bancaria,1,8),
		substr(b.cd_conta,1,15),
		substr(b.ie_digito_conta,1,2),
		substr(upper(elimina_acentuacao(j.ds_razao_social)),1,80),
		substr(upper(elimina_acentuacao(j.ds_endereco)),1,10),
		substr(j.nr_endereco,1,10),
		substr(upper(elimina_acentuacao(j.ds_municipio)),1,40),
		substr(j.cd_cep,1,10),
		substr(upper(j.sg_estado),1,2),
		70001 nr_seq_apres
	from	pessoa_juridica j,
		estabelecimento e,
		banco_estabelecimento_v b,
		titulo_pagar k,
		titulo_pagar_escrit c,
		banco_escritural a
	where	e.cd_cgc		= j.cd_cgc
	  and	c.nr_titulo		= k.nr_titulo
	  and	a.nr_sequencia		= c.nr_seq_escrit
	  and	a.cd_estabelecimento	= e.cd_estabelecimento
	  and	b.nr_sequencia		= a.nr_seq_conta_banco
	  and	b.ie_tipo_relacao	in ('EP','ECC')
	  and	c.ie_tipo_pagamento	= 'CCP'
	  and	a.nr_sequencia		= nr_seq_envio_p
	order by 1;

c02 CURSOR FOR
	SELECT	distinct
		2,			-- 	Detalhe Conta Corrente
		1,
		substr(e.cd_cgc,1,14),
		lpad(substr(c.ie_digito_conta,1,2),2,' '),
		substr(c.nr_conta,1,15),
		c.cd_banco,
		substr(c.cd_agencia_bancaria,1,8),
		substr(upper(elimina_acentuacao(d.nm_favorecido)),1,80),
		d.nr_titulo,
		null,
		d.dt_vencimento_atual,
		coalesce(d.vl_saldo_titulo,0),
		d.cd_favorecido,
		null,
		'',
		0,
		0,
		0,
		0,
		d.ie_tipo_favorecido ie_tipo_inscricao,
		d.cd_favorecido nr_inscricao_fornec,
		2,
		coalesce(d.vl_saldo_juros,0),
		coalesce(d.vl_saldo_multa,0)
	from	estabelecimento e,
		banco_estabelecimento_v b,
		titulo_pagar_v2 d,
		titulo_pagar_escrit c,
		banco_escritural a
	where	c.nr_titulo		= d.nr_titulo
	  and	a.nr_sequencia		= c.nr_seq_escrit
	  and	a.cd_estabelecimento	= e.cd_estabelecimento
	  and	b.nr_sequencia		= a.nr_seq_conta_banco
	  and	b.ie_tipo_relacao	in ('EP','ECC')
	  and	c.ie_tipo_pagamento	= 'CC'
	  and	a.nr_sequencia		= nr_seq_envio_p
	
union

	SELECT	distinct
		2,			-- 	Detalhe DOC
		3,
		substr(e.cd_cgc,1,14),
		lpad(substr(c.ie_digito_conta,1,2),2,' '),
		substr(c.nr_conta,1,15),
		c.cd_banco,
		substr(c.cd_agencia_bancaria,1,8),
		substr(upper(elimina_acentuacao(d.nm_favorecido)),1,80),
		d.nr_titulo,
		null,
		d.dt_vencimento_atual,
		coalesce(d.vl_saldo_titulo,0),
		d.cd_favorecido,
		null,
		'',
		0,
		0,
		0,
		0,
		d.ie_tipo_favorecido ie_tipo_inscricao,
		d.cd_favorecido nr_inscricao_fornec,
		10002,
		coalesce(d.vl_saldo_juros,0),
		coalesce(d.vl_saldo_multa,0)
	from	estabelecimento e,
		banco_estabelecimento_v b,
		titulo_pagar_v2 d,
		titulo_pagar_escrit c,
		banco_escritural a
	where	c.nr_titulo		= d.nr_titulo
	  and	a.nr_sequencia		= c.nr_seq_escrit
	  and	a.cd_estabelecimento	= e.cd_estabelecimento
	  and	b.nr_sequencia		= a.nr_seq_conta_banco
	  and	b.ie_tipo_relacao	in ('EP','ECC')
	  and	c.ie_tipo_pagamento	= 'DOC'
	  and	a.nr_sequencia		= nr_seq_envio_p
	
union

	select	distinct
		2,			-- 	Detalhe Ordem Pagamento
		10,
		substr(e.cd_cgc,1,14),
		lpad(substr(c.ie_digito_conta,1,2),2,' '),
		substr(c.nr_conta,1,15),
		c.cd_banco,
		substr(c.cd_agencia_bancaria,1,8),
		substr(upper(elimina_acentuacao(d.nm_favorecido)),1,80),
		d.nr_titulo,
		null,
		d.dt_vencimento_atual,
		coalesce(d.vl_saldo_titulo,0),
		d.cd_favorecido,
		null,
		'',
		0,
		0,
		0,
		0,
		d.ie_tipo_favorecido ie_tipo_inscricao,
		d.cd_favorecido nr_inscricao_fornec,
		20002,
		coalesce(d.vl_saldo_juros,0),
		coalesce(d.vl_saldo_multa,0)
	from	pessoa_fisica f,
		estabelecimento e,
		banco_estabelecimento_v b,
		titulo_pagar_v2 d,
		titulo_pagar_escrit c,
		banco_escritural a
	where	c.nr_titulo		= d.nr_titulo
	  and	a.nr_sequencia		= c.nr_seq_escrit
	  and	a.cd_estabelecimento	= e.cd_estabelecimento
	  and	b.nr_sequencia		= a.nr_seq_conta_banco
	  and	b.ie_tipo_relacao	in ('EP','ECC')
	  and	c.ie_tipo_pagamento	= 'OP'
	  and	a.nr_sequencia		= nr_seq_envio_p
	
union

	select	distinct
		2,			-- 	Detalhe TED
		41,
		substr(e.cd_cgc,1,14),
		lpad(substr(c.ie_digito_conta,1,2),2,' '),
		substr(c.nr_conta,1,15),
		c.cd_banco,
		substr(c.cd_agencia_bancaria,1,8),
		substr(upper(elimina_acentuacao(d.nm_favorecido)),1,80),
		d.nr_titulo,
		null,
		d.dt_vencimento_atual,
		coalesce(d.vl_saldo_titulo,0),
		d.cd_favorecido,
		null,
		'',
		0,
		0,
		0,
		0,
		d.ie_tipo_favorecido ie_tipo_inscricao,
		d.cd_favorecido nr_inscricao_fornec,
		30002,
		coalesce(d.vl_saldo_juros,0),
		coalesce(d.vl_saldo_multa,0)		
	from	estabelecimento e,
		banco_estabelecimento_v b,
		titulo_pagar_v2 d,
		titulo_pagar_escrit c,
		banco_escritural a
	where	c.nr_titulo		= d.nr_titulo
	  and	a.nr_sequencia		= c.nr_seq_escrit
	  and	a.cd_estabelecimento	= e.cd_estabelecimento
	  and	b.nr_sequencia		= a.nr_seq_conta_banco
	  and	b.ie_tipo_relacao	in ('EP','ECC')
	  and	c.ie_tipo_pagamento	= 'TED'
	  and	a.nr_sequencia		= nr_seq_envio_p
	
union

	select	distinct
		5,			-- 	Detalhe lote bloqueto Itau
		30,
		substr(e.cd_cgc,1,14),
		lpad(substr(c.ie_digito_conta,1,2),2,' '),
		substr(c.nr_conta,1,15),
		c.cd_banco,
		substr(c.cd_agencia_bancaria,1,8),
		substr(upper(elimina_acentuacao(d.nm_favorecido)),1,80),
		d.nr_titulo,
		null,
		d.dt_vencimento_atual,
		coalesce(d.vl_saldo_titulo,0),
		d.cd_favorecido,
		null,
		d.nr_bloqueto,
		coalesce(d.vl_titulo,0),
		coalesce(coalesce(obter_desc_antec_tit_pagar(d.nr_titulo, coalesce(d.vl_saldo_titulo,0), a.dt_remessa_retorno),0),0),
		coalesce(c.vl_acrescimo,0) + coalesce(c.vl_juros,0) + coalesce(c.vl_multa,0),
		coalesce(c.vl_escritural,0) - coalesce(obter_desc_antec_tit_pagar(d.nr_titulo, coalesce(d.vl_saldo_titulo,0), a.dt_remessa_retorno),0),
		d.ie_tipo_favorecido ie_tipo_inscricao,
		d.cd_favorecido nr_inscricao_fornec,
		40002,
		coalesce(d.vl_saldo_juros,0),
		coalesce(d.vl_saldo_multa,0)
	from	estabelecimento e,
		banco_estabelecimento_v b,
		titulo_pagar_v2 d,
		titulo_pagar_escrit c,
		banco_escritural a
	where	(e.cd_cgc IS NOT NULL AND e.cd_cgc::text <> '')
	and	c.nr_titulo			= d.nr_titulo
	  and	a.nr_sequencia			= c.nr_seq_escrit
	  and	a.nr_seq_conta_banco		= b.nr_sequencia
	  and	a.cd_estabelecimento		= e.cd_estabelecimento
	  and 	b.ie_tipo_relacao		in ('EP','ECC')
	  and 	c.ie_tipo_pagamento		= 'BLQ'
	  and	substr(d.nr_bloqueto,1,3)	= 341
	  and	a.nr_sequencia			= nr_seq_envio_p
	
union

	select	distinct
		5,			--	Detalhe lote bloqueto nao Itau
		31,
		substr(e.cd_cgc,1,14),
		lpad(substr(c.ie_digito_conta,1,2),2,' '),
		substr(c.nr_conta,1,15),
		c.cd_banco,
		substr(c.cd_agencia_bancaria,1,8),
		substr(upper(elimina_acentuacao(d.nm_favorecido)),1,80),
		d.nr_titulo,
		null,
		d.dt_vencimento_atual,
		coalesce(d.vl_saldo_titulo,0),
		d.cd_favorecido,
		null,
		d.nr_bloqueto,
		coalesce(d.vl_titulo,0),
		coalesce(coalesce(obter_desc_antec_tit_pagar(d.nr_titulo, coalesce(d.vl_saldo_titulo,0), a.dt_remessa_retorno),0),0),
		coalesce(c.vl_acrescimo,0) + coalesce(c.vl_juros,0) + coalesce(c.vl_multa,0),
		coalesce(c.vl_escritural,0) - coalesce(coalesce(obter_desc_antec_tit_pagar(d.nr_titulo, coalesce(d.vl_saldo_titulo,0), a.dt_remessa_retorno),0),0),
		d.ie_tipo_favorecido ie_tipo_inscricao,
		d.cd_favorecido nr_inscricao_fornec,
		50002,
		coalesce(d.vl_saldo_juros,0),
		coalesce(d.vl_saldo_multa,0)
	from	estabelecimento e,
		banco_estabelecimento_v b,
		titulo_pagar_v2 d,
		titulo_pagar_escrit c,
		banco_escritural a
	where	(e.cd_cgc IS NOT NULL AND e.cd_cgc::text <> '')
	and	c.nr_titulo			= d.nr_titulo
	  and	a.nr_sequencia			= c.nr_seq_escrit
	  and	a.nr_seq_conta_banco		= b.nr_sequencia
	  and	a.cd_estabelecimento		= e.cd_estabelecimento
	  and 	b.ie_tipo_relacao		in ('EP','ECC')
	  and 	c.ie_tipo_pagamento		= 'BLQ'
	  and	substr(d.nr_bloqueto,1,3)	<> 341
	  and	a.nr_sequencia			= nr_seq_envio_p
	
union

	select	distinct
		9,			--	Detalhe lote pagto concessionarias
		13,
		substr(e.cd_cgc,1,14),
		lpad(substr(b.ie_digito_conta,1,2),2,' '),
		substr(b.cd_conta,1,15),
		b.cd_banco,
		substr(b.cd_agencia_bancaria,1,8),
		substr(upper(elimina_acentuacao(d.nm_favorecido)),1,80),
		d.nr_titulo,
		null,
		d.dt_vencimento_atual,
		coalesce(d.vl_saldo_titulo,0),
		d.cd_favorecido,
		null,
		d.nr_bloqueto,
		0,
		0,
		0,
		0,
		d.ie_tipo_favorecido ie_tipo_inscricao,
		d.cd_favorecido nr_inscricao_fornec,
		60002,
		coalesce(d.vl_saldo_juros,0),
		coalesce(d.vl_saldo_multa,0)
	from	estabelecimento e,
		banco_estabelecimento_v b,
		titulo_pagar_v2 d,
		titulo_pagar_escrit c,
		banco_escritural a
	where	(e.cd_cgc IS NOT NULL AND e.cd_cgc::text <> '')
	and	c.nr_titulo			= d.nr_titulo
	  and	a.nr_sequencia			= c.nr_seq_escrit
	  and	a.nr_seq_conta_banco		= b.nr_sequencia
	  and	a.cd_estabelecimento		= e.cd_estabelecimento
	  and 	b.ie_tipo_relacao		in ('EP','ECC')
	  and 	c.ie_tipo_pagamento		= 'PC'
	  and  not  exists (select    1
	  from    darf_titulo_pagar x
	  where    x.nr_titulo    = c.nr_titulo)
	  and not exists (select    1
	  from    gps_titulo x
	  where    x.nr_titulo    = c.nr_titulo)
	  and	a.nr_sequencia    = nr_seq_envio_p
	
union

	select	distinct
		13,			--	Detalhe lote pagto DARF
		16,
		null,
		null,
		null,
		null,
		null,
		substr(upper(elimina_acentuacao(d.nm_favorecido)),1,80),
		d.nr_titulo,
		g.dt_apuracao dt_arquivo,
		d.dt_vencimento_atual,
		coalesce(d.vl_saldo_titulo,0) - coalesce(c.vl_desconto,0) + coalesce(c.vl_acrescimo,0) + coalesce(c.vl_despesa,0) + coalesce(c.vl_juros,0) + coalesce(c.vl_multa,0),
		d.cd_favorecido,
		substr(g.cd_darf,1,4) ie_registro,
		substr(g.nr_referencia,1,17) nr_bloqueto,
		0,
		0,
		0,
		coalesce(d.vl_saldo_titulo,0),
		d.ie_tipo_favorecido ie_tipo_inscricao,
		d.cd_favorecido nr_inscricao_fornec,
		80002,
		coalesce(d.vl_saldo_juros,0),
		coalesce(d.vl_saldo_multa,0)
	from	darf g,
		darf_titulo_pagar f,
		estabelecimento e,
		banco_estabelecimento_v b,
		titulo_pagar_v2 d,
		titulo_pagar_escrit c,
		banco_escritural a
	where	(e.cd_cgc IS NOT NULL AND e.cd_cgc::text <> '')
	and	c.nr_titulo			= d.nr_titulo
	  and	a.nr_sequencia			= c.nr_seq_escrit
	  and	a.nr_seq_conta_banco		= b.nr_sequencia
	  and	a.cd_estabelecimento		= e.cd_estabelecimento
	  and 	b.ie_tipo_relacao		in ('EP','ECC')
	  and 	c.ie_tipo_pagamento		= 'PC'
	  and	f.nr_seq_darf	= g.nr_sequencia
	  and	f.nr_titulo		= c.nr_titulo
	  and	a.nr_sequencia			= nr_seq_envio_p
	
union

	select	distinct
		14,			--	Detalhe lote pagto GPS
		17,
		null,
		null,
		null,
		null,
		null,
		substr(upper(elimina_acentuacao(d.nm_favorecido)),1,80),
		d.nr_titulo,
		g.dt_referencia dt_arquivo,
		d.dt_vencimento_atual,
		coalesce(d.vl_saldo_titulo,0),
		d.cd_favorecido,
		substr(g.cd_pagamento,1,4) ie_registro,
		null,
		0,
		0,
		0,
		coalesce(d.vl_saldo_titulo,0) - coalesce(c.vl_desconto,0) + coalesce(c.vl_acrescimo,0) + coalesce(c.vl_despesa,0) + coalesce(c.vl_juros,0) + coalesce(c.vl_multa,0),
		d.ie_tipo_favorecido ie_tipo_inscricao,
		d.cd_favorecido nr_inscricao_fornec,
		90002,
		coalesce(g.vl_outras_entidades,0),
		0
	from	gps g,
		gps_titulo f,
		estabelecimento e,
		banco_estabelecimento_v b,
		titulo_pagar_v2 d,
		titulo_pagar_escrit c,
		banco_escritural a
	where	(e.cd_cgc IS NOT NULL AND e.cd_cgc::text <> '')
	and	c.nr_titulo			= d.nr_titulo
	  and	a.nr_sequencia			= c.nr_seq_escrit
	  and	a.nr_seq_conta_banco		= b.nr_sequencia
	  and	a.cd_estabelecimento		= e.cd_estabelecimento
	  and 	b.ie_tipo_relacao		in ('EP','ECC')
	  and 	c.ie_tipo_pagamento		= 'PC'
	  and	f.nr_seq_gps	= g.nr_sequencia
	  and	f.nr_titulo		= c.nr_titulo
	  and	a.nr_sequencia			= nr_seq_envio_p
	
union

	select	distinct
		2,			-- 	Detalhe DOC Poupanca
		5,
		substr(e.cd_cgc,1,14),
		lpad(substr(c.ie_digito_conta,1,2),2,' '),
		substr(c.nr_conta,1,15),
		c.cd_banco,
		substr(c.cd_agencia_bancaria,1,8),
		substr(upper(elimina_acentuacao(d.nm_favorecido)),1,80),
		d.nr_titulo,
		null,
		d.dt_vencimento_atual,
		coalesce(d.vl_saldo_titulo,0),
		d.cd_favorecido,
		null,
		'',
		0,
		0,
		0,
		0,
		d.ie_tipo_favorecido ie_tipo_inscricao,
		d.cd_favorecido nr_inscricao_fornec,
		70002,
		coalesce(d.vl_saldo_juros,0),
		coalesce(d.vl_saldo_multa,0)
	from	estabelecimento e,
		banco_estabelecimento_v b,
		titulo_pagar_v2 d,
		titulo_pagar_escrit c,
		banco_escritural a
	where	c.nr_titulo		= d.nr_titulo
	  and	a.nr_sequencia		= c.nr_seq_escrit
	  and	a.cd_estabelecimento	= e.cd_estabelecimento
	  and	b.nr_sequencia		= a.nr_seq_conta_banco
	  and	b.ie_tipo_relacao	in ('EP','ECC')
	  and	c.ie_tipo_pagamento	= 'CCP'
	  and	a.nr_sequencia		= nr_seq_envio_p
	order by 1,2;

/* Francisco - 25/03/2008 - OS 83242 - Tirei de todos os selects "-c.vl_desconto + c.vl_acrescimo + nvl(c.vl_juros,0) + nvl(c.vl_multa,0)" */

c03 CURSOR FOR
	SELECT	distinct 		-- 	Trailler Conta Corrente
		3,
		1,
		count(*),
		sum(c.vl_escritural),
		10000 nr_seq_apres
	from	banco_estabelecimento_v b,
		estabelecimento a,
		titulo_pagar k,
		titulo_pagar_escrit c,
		banco_escritural e
	where	e.nr_sequencia		= c.nr_seq_escrit
	  and	e.cd_estabelecimento    = a.cd_estabelecimento
	  and	k.nr_titulo		= c.nr_titulo
	  and	b.nr_sequencia		= e.nr_seq_conta_banco
	  and	b.ie_tipo_relacao      	in ('EP','ECC')
	  and 	c.ie_tipo_pagamento	= 'CC'
	  and	e.nr_sequencia		= nr_seq_envio_p
	
union

	SELECT	distinct 		-- 	Trailler documento
		3,
		3,
		count(*),
		sum(c.vl_escritural),
		20000 nr_seq_apres
	from	banco_estabelecimento_v b,
		estabelecimento a,
		titulo_pagar k,
		titulo_pagar_escrit c,
		banco_escritural e
	where	e.nr_sequencia		= c.nr_seq_escrit
	  and	e.cd_estabelecimento    = a.cd_estabelecimento
	  and	k.nr_titulo		= c.nr_titulo
	  and	b.nr_sequencia		= e.nr_seq_conta_banco
	  and	b.ie_tipo_relacao      	in ('EP','ECC')
	  and 	c.ie_tipo_pagamento	= 'DOC'
	  and	e.nr_sequencia		= nr_seq_envio_p
	
union

	select	distinct 		-- 	Trailler Ordem Pagamento
		3,
		10,
		count(*),
		sum(c.vl_escritural),
		30000 nr_seq_apres
	from	banco_estabelecimento_v b,
		estabelecimento a,
		titulo_pagar k,
		titulo_pagar_escrit c,
		banco_escritural e
	where	e.nr_sequencia		= c.nr_seq_escrit
	  and	e.cd_estabelecimento    = a.cd_estabelecimento
	  and	k.nr_titulo		= c.nr_titulo
	  and	b.nr_sequencia		= e.nr_seq_conta_banco
	  and	b.ie_tipo_relacao      	in ('EP','ECC')
	  and 	c.ie_tipo_pagamento	= 'OP'
	  and	e.nr_sequencia		= nr_seq_envio_p
	
union

	select	distinct 		-- 	Trailler TED
		3,
		41,
		count(*),
		sum(c.vl_escritural),
		40000 nr_seq_apres
	from	banco_estabelecimento_v b,
		estabelecimento a,
		titulo_pagar k,
		titulo_pagar_escrit c,
		banco_escritural e
	where	e.nr_sequencia		= c.nr_seq_escrit
	  and	e.cd_estabelecimento    = a.cd_estabelecimento
	  and	k.nr_titulo		= c.nr_titulo
	  and	b.nr_sequencia		= e.nr_seq_conta_banco
	  and	b.ie_tipo_relacao      	in ('EP','ECC')
	  and 	c.ie_tipo_pagamento	= 'TED'
	  and	e.nr_sequencia		= nr_seq_envio_p
	
union

	select	distinct 		--	Trailler bloqueto Itau
		7,
		30,
		count(*) * 2,
		sum(c.vl_escritural - coalesce(coalesce(obter_desc_antec_tit_pagar(d.nr_titulo, coalesce(d.vl_saldo_titulo,0), e.dt_remessa_retorno),0),0)),
		50000 nr_seq_apres
	from	banco_estabelecimento_v b,
		titulo_pagar_v2 d,
		estabelecimento a,
		titulo_pagar_escrit c,
		banco_escritural e
	where	e.nr_sequencia			= c.nr_seq_escrit
	  and	c.nr_titulo			= d.nr_titulo
	  and	e.cd_estabelecimento    	= a.cd_estabelecimento
	  and	b.nr_sequencia			= e.nr_seq_conta_banco
	  and	b.ie_tipo_relacao       	in ('EP','ECC')
	  and 	c.ie_tipo_pagamento		= 'BLQ'
	  and	substr(d.nr_bloqueto,1,3)	= 341
	  and	e.nr_sequencia			= nr_seq_envio_p
	
union

	select	distinct 		--	Trailler bloqueto nao Itau
		7,
		31,
		count(*) * 2,
		sum(c.vl_escritural - coalesce(coalesce(obter_desc_antec_tit_pagar(d.nr_titulo, coalesce(d.vl_saldo_titulo,0), e.dt_remessa_retorno),0),0)),
		60000 nr_seq_apres
	from	banco_estabelecimento_v b,
		titulo_pagar_v2 d,
		estabelecimento a,
		titulo_pagar_escrit c,
		banco_escritural e
	where	e.nr_sequencia			= c.nr_seq_escrit
	  and	c.nr_titulo			= d.nr_titulo
	  and	e.cd_estabelecimento    	= a.cd_estabelecimento
	  and	b.nr_sequencia			= e.nr_seq_conta_banco
	  and	b.ie_tipo_relacao       	in ('EP','ECC')
	  and 	c.ie_tipo_pagamento		= 'BLQ'
	  and	substr(d.nr_bloqueto,1,3)	<> 341
	  and	e.nr_sequencia			= nr_seq_envio_p
	
union

	select	distinct 		--	Trailler pagto concessionarias
		10,
		13,
		count(*),
		sum(c.vl_escritural),
		70000 nr_seq_apres
	from	banco_estabelecimento_v b,
		titulo_pagar_v2 d,
		estabelecimento a,
		titulo_pagar_escrit c,
		banco_escritural e
	where	e.nr_sequencia			= c.nr_seq_escrit
	  and	c.nr_titulo			= d.nr_titulo
	  and	e.cd_estabelecimento    	= a.cd_estabelecimento
	  and	b.nr_sequencia			= e.nr_seq_conta_banco
	  and	b.ie_tipo_relacao       	in ('EP','ECC')
	  and 	c.ie_tipo_pagamento		= 'PC'
	  and  not  exists (select    1
	  from    darf_titulo_pagar x
	  where    x.nr_titulo    = c.nr_titulo)
	  and not exists (select    1
	  from    gps_titulo x
	  where    x.nr_titulo    = c.nr_titulo)
	  and	e.nr_sequencia    = nr_seq_envio_p
	
union
	
	select	distinct 		--	Trailler pagto DARF
		17,
		16,
		count(*),
		sum(c.vl_escritural),
		90000 nr_seq_apres
	from		darf g,
		darf_titulo_pagar f,
		banco_estabelecimento_v b,
		titulo_pagar_v2 d,
		estabelecimento a,
		titulo_pagar_escrit c,
		banco_escritural e
	where	e.nr_sequencia			= c.nr_seq_escrit
	  and	c.nr_titulo			= d.nr_titulo
	  and	e.cd_estabelecimento    	= a.cd_estabelecimento
	  and	b.nr_sequencia			= e.nr_seq_conta_banco
	  and	b.ie_tipo_relacao       	in ('EP','ECC')
	  and 	c.ie_tipo_pagamento		= 'PC'
	  and f.nr_seq_darf    = g.nr_sequencia
	  and f.nr_titulo    = c.nr_titulo
	  and	e.nr_sequencia			= nr_seq_envio_p
	
union

	select	distinct 		--	Trailler pagto GPS
		18,
		17,
		count(*),
		sum(c.vl_escritural),
		100000 nr_seq_apres
	from		gps g,
		gps_titulo f,
		banco_estabelecimento_v b,
		titulo_pagar_v2 d,
		estabelecimento a,
		titulo_pagar_escrit c,
		banco_escritural e
	where	e.nr_sequencia			= c.nr_seq_escrit
	  and	c.nr_titulo			= d.nr_titulo
	  and	e.cd_estabelecimento    	= a.cd_estabelecimento
	  and	b.nr_sequencia			= e.nr_seq_conta_banco
	  and	b.ie_tipo_relacao       	in ('EP','ECC')
	  and 	c.ie_tipo_pagamento		= 'PC'
	  and f.nr_seq_gps    = g.nr_sequencia
	  and f.nr_titulo    = c.nr_titulo
	  and	e.nr_sequencia			= nr_seq_envio_p
	
union

	select	distinct 		-- 	Trailler DOC poupanca
		3,
		5,
		count(*),
		sum(c.vl_escritural),
		80000 nr_seq_apres
	from	banco_estabelecimento_v b,
		estabelecimento a,
		titulo_pagar k,
		titulo_pagar_escrit c,
		banco_escritural e
	where	e.nr_sequencia		= c.nr_seq_escrit
	  and	e.cd_estabelecimento    = a.cd_estabelecimento
	  and	k.nr_titulo		= c.nr_titulo
	  and	b.nr_sequencia		= e.nr_seq_conta_banco
	  and	b.ie_tipo_relacao      	in ('EP','ECC')
	  and 	c.ie_tipo_pagamento	= 'CCP'
	  and	e.nr_sequencia		= nr_seq_envio_p
	order by 1;


BEGIN

delete	from w_interf_itau;
commit;

ie_tipo_reg_w	:= 0;
nr_registro_w	:= 0;

select	a.cd_cgc,
	somente_numero(g.cd_agencia_bancaria),
	g.cd_conta,
	g.ie_digito_conta,
	substr(upper(p.ds_razao_social),1,80),
	g.ds_banco,
	e.dt_atualizacao,
	e.nr_sequencia
into STRICT	nr_inscricao_sacado_w,
	cd_agencia_w,
	cd_conta_w,
	ds_dac_agencia_w,
	nm_empresa_w,
	ds_banco_w,
	dt_geracao_w,
	nr_seq_envio_w
from	estabelecimento a,
	banco_estabelecimento_v g,
	pessoa_juridica p,
	banco_escritural e
where	e.cd_estabelecimento   	= a.cd_estabelecimento
  and	a.cd_cgc		= p.cd_cgc
  and	g.nr_sequencia		= e.nr_seq_conta_banco
  and	g.ie_tipo_relacao       in ('EP','ECC')
  and	e.nr_sequencia		= nr_seq_envio_p;

if (nr_seq_envio_w > 0) and (nr_seq_envio_w IS NOT NULL AND nr_seq_envio_w::text <> '') then
	/*	Header do Arquivo	*/

	insert into w_interf_itau(nr_sequencia,
		ie_tipo_registro,
		nr_seq_forma_pagto,
		nr_inscricao,
		cd_agencia_bancaria,
		cd_conta,
		ds_dac_agencia,
		nm_empresa,
		ds_banco,
		dt_geracao,
		dt_atualizacao,
		nm_usuario,
		nr_lote,
		nr_seq_apres)
	values (nextval('w_interf_itau_seq'),
		0,
		0,
		nr_inscricao_sacado_w,
		cd_agencia_w,
		cd_conta_w,
		ds_dac_agencia_w,
		nm_empresa_w,
		ds_banco_w,
		dt_geracao_w,
		clock_timestamp(),
		nm_usuario_p,
		0,
		0);

	open c01;
	loop
	fetch c01 into 	ie_tipo_registro_w,
			nr_seq_forma_pagto_w,
			nr_inscricao_w,
			cd_agencia_w,
			cd_conta_w,
			ds_dac_agencia_w,
			nm_empresa_w,
			ds_endereco_w,
			nr_endereco_w,
			ds_cidade_w,
			cd_cep_w,
			sg_estado_w,
			nr_seq_apres_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		insert into w_interf_itau(nr_sequencia,
			ie_tipo_registro,
			nr_seq_forma_pagto,
			nr_lote,
			nr_inscricao,
			cd_agencia_bancaria,
			cd_conta,
			ds_dac_agencia,
			nm_empresa,
			ds_endereco,
			nr_endereco,
			ds_cidade,
			cd_cep,
			sg_estado,
			dt_atualizacao,
			nm_usuario,
			nr_seq_apres)
		values (nextval('w_interf_itau_seq'),
			ie_tipo_registro_w,
			nr_seq_forma_pagto_w,
			nr_lote_w,
			nr_inscricao_w,
			cd_agencia_w,
			cd_conta_w,
			ds_dac_agencia_w,
			nm_empresa_w,
			ds_endereco_w,
			nr_endereco_w,
			ds_cidade_w,
			cd_cep_w,
			substr(sg_estado_w,1,2),
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_apres_w);
		end;
	end loop;
	close c01;

	open c02;
	loop
	fetch c02 into ie_tipo_registro_w,
			nr_seq_forma_pagto_w,
			nr_inscricao_w,
			ds_dac_agencia_w,
			cd_conta_w,
			cd_banco_w,
			cd_agencia_w,
			nm_fornecedor_w,
			nr_documento_w,
			dt_arquivo_w,
			dt_vencimento_w,
			vl_saldo_titulo_w,
			cd_cgc_fornecedor_w,
			ie_registro_w,
			cd_barras_w,
			vl_titulo_w,
			vl_desconto_w,
			vl_acrescimo_w,
			vl_pagto_w,
			ie_tipo_inscricao_w,
			nr_inscricao_fornec_w,
			nr_seq_apres_w,
			vl_saldo_juros_w,
			vl_saldo_multa_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */

		if (coalesce(nr_ult_apres_w::text, '') = '') or (nr_ult_apres_w	<> nr_seq_apres_w) then

			nr_seq_apres_atual_w	:= nr_seq_apres_w;
			nr_ult_apres_w		:= nr_seq_apres_w;

		else

			nr_seq_apres_atual_w	:= coalesce(nr_seq_apres_atual_w,0) + 1;

		end if;

		if (ie_tipo_reg_w	= 0) then
			nr_registro_w	:= nr_registro_w + 1;
			ie_tipo_reg_w	:= nr_seq_forma_pagto_w;
		elsif (ie_tipo_reg_w	= nr_seq_forma_pagto_w) then
			nr_registro_w	:= nr_registro_w + 1;
		else
			nr_registro_w	:= 1;
			ie_tipo_reg_w	:= nr_seq_forma_pagto_w;
		end if;

		insert into w_interf_itau(nr_sequencia,
			ie_tipo_registro,
			nr_seq_forma_pagto,
			nr_lote,
			nr_registro,
			nr_inscricao,
			ds_dac_agencia,
			cd_conta,
			cd_banco_fornec,
			cd_agencia_bancaria,
			nm_fornecedor,
			nr_documento,
			dt_arquivo,
			dt_vencimento,
			vl_saldo_titulo,
			cd_cgc_fornecedor,
			ie_registro,
			cd_barras,
			vl_titulo,
			vl_desconto,
			vl_acrescimo,
			dt_pagto,
			vl_pagto,
			dt_atualizacao,
			nm_usuario,
			nr_seq_apres)
		values (nextval('w_interf_itau_seq'),
			ie_tipo_registro_w,
			nr_seq_forma_pagto_w,
			nr_lote_w,
			nr_registro_w,
			nr_inscricao_w,
			ds_dac_agencia_w,
			cd_conta_w,
			cd_banco_w,
			cd_agencia_w,
			nm_fornecedor_w,
			nr_documento_w,
			dt_arquivo_w,
			dt_vencimento_w,
			vl_saldo_titulo_w,
			cd_cgc_fornecedor_w,
			ie_registro_w,
			cd_barras_w,
			vl_titulo_w,
			vl_desconto_w,
			vl_acrescimo_w,
			dt_vencimento_w,
			vl_pagto_w,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_apres_atual_w);

		if (ie_tipo_registro_w	= 5) then	/* Detalhe bloqueto (Segmento J-52) */
			nr_registro_w		:= coalesce(nr_registro_w,0) + 1;
			nr_seq_apres_atual_w	:= coalesce(nr_seq_apres_atual_w,0) + 1;

			insert into w_interf_itau(nr_sequencia,
				ie_tipo_registro,
				nr_lote,
				nr_registro,
				nr_inscricao_fornec,
				nr_inscricao,
				ie_tipo_inscricao,
				nm_empresa,
				nm_fornecedor,
				nm_usuario,
				nr_seq_forma_pagto,
				dt_atualizacao,
				nr_seq_apres)
			values (nextval('w_interf_itau_seq'),
				6,
				nr_lote_w,
				nr_registro_w,
				nr_inscricao_fornec_w,
				nr_inscricao_w,
				ie_tipo_inscricao_w,
				nm_empresa_w,
				nm_fornecedor_w,
				nm_usuario_p,
				nr_seq_forma_pagto_w,
				clock_timestamp(),
				nr_seq_apres_atual_w);

		end if;

		if (ie_tipo_registro_w	= 2) then	/* Detalhe bloqueto (Segmento C Opcional) */
	
			nr_registro_w		:= coalesce(nr_registro_w,0) + 1;
			nr_seq_apres_atual_w	:= coalesce(nr_seq_apres_atual_w,0) + 1;

			insert into w_interf_itau(nr_sequencia,
				ie_tipo_registro,
				nr_lote,
				nr_registro,
				nr_inscricao_fornec,
				nr_inscricao,
				ie_tipo_inscricao,
				nm_empresa,
				nm_fornecedor,
				nm_usuario,
				nr_seq_forma_pagto,
				dt_atualizacao,
				nr_seq_apres,
				dt_pagto,
				vl_saldo_titulo,
				vl_juros,
				vl_multa,
				nr_documento)
			values (nextval('w_interf_itau_seq'),
				34,
				nr_lote_w,
				nr_registro_w,
				'C',
				nr_inscricao_w,
				ie_tipo_inscricao_w,
				nm_empresa_w,
				nm_fornecedor_w,
				nm_usuario_p,
				nr_seq_forma_pagto_w,
				clock_timestamp(),
				nr_seq_apres_atual_w,
				dt_vencimento_w,
				vl_saldo_titulo_w,
				vl_saldo_juros_w,
				vl_saldo_multa_w,
				rpad(nr_documento_w,20,' '));

		end if;

	end loop;
	close c02;

	open c03;
	loop
	fetch c03 into	ie_tipo_registro_w,
			nr_seq_forma_pagto_w,
			qt_registros_w,
			vl_total_pagto_w,
			nr_seq_apres_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */

		if (qt_registros_w > 0) then

			begin
			insert into w_interf_itau(nr_sequencia,
				ie_tipo_registro,
				nr_seq_forma_pagto,
				nr_lote,
				qt_registros,
				vl_total_pagto,
				dt_atualizacao,
				nm_usuario,
				nr_seq_apres)
			values (nextval('w_interf_itau_seq'),
				ie_tipo_registro_w,
				nr_seq_forma_pagto_w,
				nr_lote_w,
				qt_registros_w + 2,
				vl_total_pagto_w,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_apres_w);
			end;
		end if;
	end loop;
	close c03;
end if;

commit;

select	count(*)
into STRICT	qt_reg_tabela_w
from	w_interf_itau;

if (qt_reg_tabela_w > 0) then

	select	count(*)
	into STRICT	qt_lote_arquivo_w
	from	w_interf_itau
	where	ie_tipo_registro in (1,4,8,15,16);

	select	nextval('w_interf_itau_seq')
	into STRICT	nr_seq_envio_w
	;

	select	count(*)
	into STRICT	qt_tot_reg_w
	from	w_interf_itau;

	insert into w_interf_itau(nr_sequencia,
		ie_tipo_registro,
		qt_lote_arquivo,
		qt_tot_reg,
		dt_atualizacao,
		nm_usuario,
		nr_seq_apres)
	values (nr_seq_envio_w,
		11,
		qt_lote_arquivo_w,
		qt_tot_reg_w,
		clock_timestamp(),
		nm_usuario_p,
		999999);
end if;

select	count(*)
into STRICT	qt_registros_W
from	w_interf_itau
where	ie_tipo_registro 	= 2
and	nr_seq_forma_pagto	= 1;

if (qt_registros_w > 0) then
	nr_lote_w	:= nr_lote_w + 1;

	update	w_interf_itau
	set	nr_lote			= nr_lote_w
	where	ie_tipo_registro	in (1,2,3)
	  and	nr_seq_forma_pagto	= 1;
end if;

select	count(*)
into STRICT	qt_registros_W
from	w_interf_itau
where	ie_tipo_registro = 2
and	nr_seq_forma_pagto	= 3;

if (qt_registros_w > 0) then
	nr_lote_w	:= nr_lote_w + 1;

	update	w_interf_itau
	set	nr_lote			= nr_lote_w
	where	ie_tipo_registro	in (1,2,3,34)
	  and	nr_seq_forma_pagto	= 3;
end if;

select	count(*)
into STRICT	qt_registros_W
from	w_interf_itau
where	ie_tipo_registro = 2
and	nr_seq_forma_pagto	= 10;

if (qt_registros_w > 0) then
	nr_lote_w	:= nr_lote_w + 1;

	update	w_interf_itau
	set	nr_lote			= nr_lote_w
	where	ie_tipo_registro	in (1,2,3,34)
	  and	nr_seq_forma_pagto	= 10;
end if;

select	count(*)
into STRICT	qt_registros_W
from	w_interf_itau
where	ie_tipo_registro = 2
and	nr_seq_forma_pagto	= 41;

if (qt_registros_w > 0) then
	nr_lote_w	:= nr_lote_w + 1;

	update	w_interf_itau
	set	nr_lote			= nr_lote_w
	where	ie_tipo_registro	in (1,2,3,34)
	  and	nr_seq_forma_pagto	= 41;
end if;

select	count(*)
into STRICT	qt_registros_w
from	w_interf_itau
where	ie_tipo_registro	= 5
and	nr_seq_forma_pagto	= 30;

if (qt_registros_w > 0) then
	nr_lote_w	:= nr_lote_w + 1;

	update	w_interf_itau
	set	nr_lote			= nr_lote_w
	where	ie_tipo_registro	in (4,5,6,7)
	  and	nr_seq_forma_pagto	= 30;
end if;

select	count(*)
into STRICT	qt_registros_w
from	w_interf_itau
where	ie_tipo_registro	= 5
and	nr_seq_forma_pagto	= 31;

if (qt_registros_w > 0) then
	nr_lote_w	:= nr_lote_w + 1;

	update	w_interf_itau
	set	nr_lote			= nr_lote_w
	where	ie_tipo_registro	in (4,5,6,7)
	  and	nr_seq_forma_pagto	= 31;
end if;

select	count(*)
into STRICT	qt_registros_w
from	w_interf_itau
where	ie_tipo_registro	= 9
and	nr_seq_forma_pagto	= 13;

if (qt_registros_w > 0) then
	nr_lote_w	:= nr_lote_w + 1;

	update	w_interf_itau
	set	nr_lote			= nr_lote_w
	where	ie_tipo_registro	in (8,9,10)
	  and	nr_seq_forma_pagto	= 13;
end if;

select	count(*)
into STRICT	qt_registros_w
from	w_interf_itau
where	ie_tipo_registro	= 13
and	nr_seq_forma_pagto	= 16;

if (qt_registros_w > 0) then
	nr_lote_w	:= nr_lote_w + 1;

	update	w_interf_itau
	set	nr_lote			= nr_lote_w
	where	ie_tipo_registro	in (13,15,17)
	  and	nr_seq_forma_pagto	= 16;
end if;

select	count(*)
into STRICT	qt_registros_w
from	w_interf_itau
where	ie_tipo_registro	= 14
and	nr_seq_forma_pagto	= 17;

if (qt_registros_w > 0) then
	nr_lote_w	:= nr_lote_w + 1;

	update	w_interf_itau
	set	nr_lote			= nr_lote_w
	where	ie_tipo_registro	in (14,16,18)
	  and	nr_seq_forma_pagto	= 17;
end if;

/* Gerar um novo lote para forma de pagto 5 - Sirio */

select	count(*)
into STRICT	qt_registros_w
from	w_interf_itau
where	ie_tipo_registro	= 2
and	nr_seq_forma_pagto	= 5;

if (qt_registros_w > 0) then
	nr_lote_w	:= nr_lote_w + 1;

	update	w_interf_itau
	set	nr_lote			= nr_lote_w
	where	ie_tipo_registro	in (1,2,3)
	  and	nr_seq_forma_pagto	= 5;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_interf_itau (nr_seq_envio_p bigint, nm_usuario_p text) FROM PUBLIC;

