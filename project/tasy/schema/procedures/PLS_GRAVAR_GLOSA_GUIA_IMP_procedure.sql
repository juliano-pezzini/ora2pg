-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gravar_glosa_guia_imp ( cd_motivo_glosa_p text, ds_observacao_p text, nr_seq_guia_plano_imp_p pls_guia_plano_imp.nr_sequencia%type, nr_seq_guia_plano_proc_imp_p pls_guia_plano_glosa_imp.nr_seq_guia_plano_proc_imp%type, nr_seq_guia_plano_mat_imp_p pls_guia_plano_glosa_imp.nr_seq_guia_plano_mat_imp%type, nm_usuario_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type default null) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Salvar as glosas gerados no arquivo de importação da Solicitação de procedimento
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ x] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_motivo_glosa_w		tiss_motivo_glosa.nr_sequencia%type;
ds_motivo_tiss_w		tiss_motivo_glosa.ds_motivo_tiss%type;
ie_ocorrencia_w			pls_controle_estab.ie_ocorrencia%type := 'N';


BEGIN

ie_ocorrencia_w := pls_obter_se_controle_estab('GO');

begin
	if (ie_ocorrencia_w = 'N') then
		select 	a.nr_sequencia,
			a.ds_motivo_tiss
		into STRICT	nr_seq_motivo_glosa_w,
			ds_motivo_tiss_w
		from	tiss_motivo_glosa 	a,
			pls_glosa_evento 	b
		where	a.nr_sequencia 		= b.nr_seq_motivo_glosa
		and	ie_evento		= 'IG'
		and	a.cd_motivo_tiss 	= cd_motivo_glosa_p
		and	b.ie_plano		= 'S'  LIMIT 1;
	else
		select 	a.nr_sequencia,
			a.ds_motivo_tiss
		into STRICT	nr_seq_motivo_glosa_w,
			ds_motivo_tiss_w
		from	tiss_motivo_glosa 	a,
			pls_glosa_evento 	b
		where	a.nr_sequencia 		= b.nr_seq_motivo_glosa
		and	ie_evento		= 'IG'
		and	a.cd_motivo_tiss 	= cd_motivo_glosa_p
		and	b.ie_plano		= 'S'
		and	b.cd_estabelecimento	= cd_estabelecimento_p  LIMIT 1;
	end if;
exception
when others then
	nr_seq_motivo_glosa_w := null;
end;

--Se existir a glosa e estiver ativa a mesma é gerada para a guia importada
if (nr_seq_motivo_glosa_w IS NOT NULL AND nr_seq_motivo_glosa_w::text <> '') then

	insert into pls_guia_plano_glosa_imp(
			nr_sequencia, dt_atualizacao,  nm_usuario,
			dt_atualizacao_nrec, nm_usuario_nrec, ds_motivo_glosa,
			nr_seq_motivo_glosa, nr_seq_guia_plano_imp, nr_seq_guia_plano_proc_imp,
			nr_seq_guia_plano_mat_imp)
		values ( nextval('pls_guia_plano_glosa_imp_seq'), clock_timestamp(), nm_usuario_p,
			clock_timestamp(), nm_usuario_p, substr(ds_motivo_tiss_w ||' '||ds_observacao_p,0,255),
			nr_seq_motivo_glosa_w, nr_seq_guia_plano_imp_p, nr_seq_guia_plano_proc_imp_p,
			nr_seq_guia_plano_mat_imp_p);

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gravar_glosa_guia_imp ( cd_motivo_glosa_p text, ds_observacao_p text, nr_seq_guia_plano_imp_p pls_guia_plano_imp.nr_sequencia%type, nr_seq_guia_plano_proc_imp_p pls_guia_plano_glosa_imp.nr_seq_guia_plano_proc_imp%type, nr_seq_guia_plano_mat_imp_p pls_guia_plano_glosa_imp.nr_seq_guia_plano_mat_imp%type, nm_usuario_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type default null) FROM PUBLIC;

