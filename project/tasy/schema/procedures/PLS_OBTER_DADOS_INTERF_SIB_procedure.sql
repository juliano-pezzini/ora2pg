-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_dados_interf_sib ( nr_seq_segurado_p bigint, cd_pais_sib_p INOUT text, cd_usuario_ant_p INOUT text, cd_usuario_plano_p INOUT text, cd_usuario_plano_tit_p INOUT text, cd_cgc_estipulante_p INOUT text, nr_cpf_p INOUT text, cd_vinculo_benef_p INOUT text, ie_carencia_temp_p INOUT bigint, ie_resid_brasil_p INOUT bigint) AS $body$
DECLARE


nr_seq_pais_w			bigint;
nr_seq_carteira_w		bigint;
nr_seq_titular_w		bigint;
ie_tipo_contratacao_w		varchar(2);
nr_seq_contrato_w		bigint;
nr_anos_w			integer;
cd_pessoa_fisica_w		varchar(10);
nr_seq_parentesco_w		bigint;
nr_seq_plano_w			bigint;
sg_uf_w				compl_pessoa_fisica.sg_estado%type;
cd_pais_sib_w			varchar(30)	:= null;
cd_usuario_ant_w		varchar(30)	:= null;
cd_usuario_plano_w		varchar(30)	:= null;
cd_usuario_plano_tit_w		varchar(30)	:= null;
cd_cgc_estipulante_w		varchar(14)	:= null;
nr_cpf_w			varchar(11)	:= null;
cd_vinculo_benef_w		varchar(2)	:= null;
ie_carencia_temp_w		smallint	:= 0;
ie_resid_brasil_w		smallint	:= 0;
qt_cpt_w			bigint;
dt_nascimento_w			timestamp;
qt_registros_w			bigint;


BEGIN

select	b.nr_seq_pais,
	a.nr_seq_titular,
	c.ie_tipo_contratacao,
	a.nr_seq_contrato,
	coalesce(b.nr_cpf,'00000000000'),
	b.cd_pessoa_fisica,
	a.nr_seq_parentesco,
	a.nr_seq_plano,
	b.dt_nascimento
into STRICT	nr_seq_pais_w,
	nr_seq_titular_w,
	ie_tipo_contratacao_w,
	nr_seq_contrato_w,
	nr_cpf_w,
	cd_pessoa_fisica_w,
	nr_seq_parentesco_w,
	nr_seq_plano_w,
	dt_nascimento_w
from	pessoa_fisica b,
	pls_segurado a,
	pls_plano c
where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
and	c.nr_sequencia	= a.nr_seq_plano
and	a.nr_sequencia	= nr_seq_segurado_p;

nr_anos_w	:= trunc(months_between(clock_timestamp(), trunc(dt_nascimento_w,'month')) / 12);

begin
select	sg_estado
into STRICT	sg_uf_w
from	compl_pessoa_fisica
where	cd_pessoa_fisica	= cd_pessoa_fisica_w
and	ie_tipo_complemento	= 1;
exception
when others then
	sg_uf_w	:= '';
end;

/* cd_pais_sib_p */

if (nr_seq_pais_w IS NOT NULL AND nr_seq_pais_w::text <> '') then
	select	cd_pais_sib
	into STRICT	cd_pais_sib_w
	from	pais
	where	nr_sequencia	= nr_seq_pais_w;
end if;

/* cd_usuario_ant_p */

select	count(1)
into STRICT	qt_registros_w
from	pls_segurado_cart_ant	b,
	pls_segurado		a
where	b.nr_seq_segurado		= a.nr_sequencia
and	a.nr_sequencia			= nr_seq_segurado_p
and	coalesce(b.ie_sistema_anterior,'N')	= 'S'  LIMIT 1;

if (qt_registros_w > 0) then
	select 	lpad(replace(replace(coalesce(max(cd_usuario_ant),0), '.', ''), '-', ''),17,0)
	into STRICT	cd_usuario_ant_w
	from	pls_segurado_cart_ant
	where	nr_seq_segurado		= nr_seq_segurado_p
	and	coalesce(ie_sistema_anterior,'N')	= 'S';
end if;

/* cd_usuario_plano_p */

begin
select 	b.nr_sequencia,
	coalesce(a.cd_cartao_ident_ans_sist_ant,b.cd_usuario_plano)
into STRICT	nr_seq_carteira_w,
	cd_usuario_plano_w
from	pls_segurado_carteira	b,
	pls_segurado		a
where	b.nr_seq_segurado	= a.nr_sequencia
and	a.nr_sequencia		= nr_seq_segurado_p;
exception
when others then
	nr_seq_carteira_w	:= 0;
	cd_usuario_plano_w	:= '';
end;

/* cd_usuario_plano_tit_w */

if (coalesce(nr_seq_titular_w,0) > 0) then
	begin
	select 	max(nr_sequencia)
	into STRICT	nr_seq_carteira_w
	from	pls_segurado_carteira
	where	nr_seq_segurado		= nr_seq_titular_w
	and	dt_inicio_vigencia	=
			(SELECT	max(dt_inicio_vigencia)
			from	pls_segurado_carteira
			where	nr_seq_segurado	= nr_seq_titular_w);
	exception
	when others then
		nr_seq_carteira_w	:= 0;
	end;

	if (coalesce(nr_seq_carteira_w::text, '') = '') then
		nr_seq_carteira_w	:= 0;
	end if;

	if (nr_seq_carteira_w > 0) then
		select 	coalesce(a.cd_cartao_ident_ans_sist_ant,b.cd_usuario_plano)
		into STRICT	cd_usuario_plano_tit_w
		from	pls_segurado_carteira	b,
			pls_segurado		a
		where	b.nr_seq_segurado	= a.nr_sequencia
		and	b.nr_sequencia		= nr_seq_carteira_w;
	end if;
end if;

/* cd_cgc_estipulante_p */

if (ie_tipo_contratacao_w in ('CA','CE')) then
	select 	cd_cgc_estipulante
	into STRICT	cd_cgc_estipulante_w
	from 	pls_contrato
	where 	nr_sequencia = nr_seq_contrato_w;
end if;

/* cd_vinculo_benef_p */

if (coalesce(nr_seq_titular_w,0) = 0) then
	cd_vinculo_benef_w	:= 01;
elsif (coalesce(nr_seq_parentesco_w,0) > 0) then
	select	cd_sib
	into STRICT	cd_vinculo_benef_w
	from	grau_parentesco
	where	nr_sequencia	= nr_seq_parentesco_w;
end if;

/* ie_carencia_temp_p */

begin
select	count(1)
into STRICT	qt_cpt_w
from	pls_carencia		a
where	a.nr_seq_segurado	= nr_seq_segurado_p
and	a.ie_cpt		= 'S'
and	a.qt_dias		> 0 --Se for isento não é considerado
  LIMIT 1;
exception
when others then
	qt_cpt_w	:= 0;
end;

if (qt_cpt_w > 0) then
	ie_carencia_temp_w	:= 1;
else
	ie_carencia_temp_w	:= 2;
end if;

select	CASE WHEN sg_uf_w='IN' THEN 1  ELSE 0 END
into STRICT	ie_resid_brasil_w
;

cd_pais_sib_p			:= cd_pais_sib_w;
cd_usuario_ant_p		:= cd_usuario_ant_w;
cd_usuario_plano_p		:= cd_usuario_plano_w;
cd_usuario_plano_tit_p		:= cd_usuario_plano_tit_w;
cd_cgc_estipulante_p		:= cd_cgc_estipulante_w;
nr_cpf_p			:= nr_cpf_w;
cd_vinculo_benef_p		:= cd_vinculo_benef_w;
ie_carencia_temp_p		:= ie_carencia_temp_w;
ie_resid_brasil_p		:= ie_resid_brasil_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_dados_interf_sib ( nr_seq_segurado_p bigint, cd_pais_sib_p INOUT text, cd_usuario_ant_p INOUT text, cd_usuario_plano_p INOUT text, cd_usuario_plano_tit_p INOUT text, cd_cgc_estipulante_p INOUT text, nr_cpf_p INOUT text, cd_vinculo_benef_p INOUT text, ie_carencia_temp_p INOUT bigint, ie_resid_brasil_p INOUT bigint) FROM PUBLIC;

