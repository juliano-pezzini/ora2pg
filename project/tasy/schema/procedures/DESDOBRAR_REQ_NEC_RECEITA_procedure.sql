-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desdobrar_req_nec_receita ( nr_requisicao_p bigint, nm_usuario_p text, nr_req_gerada_p INOUT bigint) AS $body$
DECLARE


nr_requisicao_w	bigint;
nr_sequencia_w	integer;
nr_sequencia_ww	integer;

qt_controlados_w	bigint;
qt_nao_controlados_w	bigint;

C01 CURSOR FOR
	SELECT	nr_sequencia
	FROM	item_requisicao_material
	WHERE	nr_requisicao = nr_requisicao_p
	and	SUBSTR(coalesce(obter_se_mat_necessita_receita(cd_material),'N'),1,1) = 'S';

C02 CURSOR FOR
	SELECT	nr_sequencia
	FROM	item_requisicao_material
	WHERE	nr_requisicao = nr_requisicao_p
	order by nr_sequencia asc;


BEGIN
SELECT	count(*)
into STRICT	qt_controlados_w
FROM	item_requisicao_material
WHERE	nr_requisicao = nr_requisicao_p
and	SUBSTR(coalesce(obter_se_mat_necessita_receita(cd_material),'N'),1,1) = 'S';

SELECT	count(*)
into STRICT	qt_nao_controlados_w
FROM	item_requisicao_material
WHERE	nr_requisicao = nr_requisicao_p
and	SUBSTR(coalesce(obter_se_mat_necessita_receita(cd_material),'N'),1,1) = 'N';

if (qt_controlados_w > 0) and (qt_nao_controlados_w > 0) then
	begin
	select	nextval('requisicao_seq')
	into STRICT	nr_requisicao_w
	;

	insert into requisicao_material(
		NR_REQUISICAO,
		CD_ESTABELECIMENTO,
		CD_LOCAL_ESTOQUE,
		DT_SOLICITACAO_REQUISICAO,
		DT_ATUALIZACAO,
		NM_USUARIO,
		CD_OPERACAO_ESTOQUE,
		CD_PESSOA_REQUISITANTE,
		CD_PESSOA_ATENDENTE,
		CD_SETOR_ATENDIMENTO,
		CD_ESTABELECIMENTO_DESTINO,
		CD_LOCAL_ESTOQUE_DESTINO,
		CD_CENTRO_CUSTO,
		DT_BAIXA,
		DT_LIBERACAO,
		DT_EMISSAO_SETOR,
		DT_EMISSAO_LOC_ESTOQUE,
		DS_OBSERVACAO,
		NR_SEQ_ORDEM_SERV,
		IE_URGENTE,
		CD_SETOR_ENTREGA,
		IE_GERACAO,
		NM_USUARIO_LIB,
		NR_SEQ_PROJ_GPI,
		NR_DOCUMENTO_EXTERNO,
		NR_SEQ_INV_ROUPA,
		NM_USUARIO_RECEBEDOR,
		DT_RECEBIMENTO,
		NR_SEQ_PROTOCOLO,
		NR_ADIANTAMENTO,
		CD_PESSOA_SOLICITANTE,
		DT_APROVACAO,
		NM_USUARIO_APROV,
		NR_ATENDIMENTO,
		NR_SEQ_JUSTIFICATIVA,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		IE_ORIGEM_REQUISICAO,
		NR_PRESCRICAO,
		NR_CIRURGIA)
	SELECT	nr_requisicao_w,
		CD_ESTABELECIMENTO,
		CD_LOCAL_ESTOQUE,
		DT_SOLICITACAO_REQUISICAO,
		DT_ATUALIZACAO,
		NM_USUARIO,
		CD_OPERACAO_ESTOQUE,
		CD_PESSOA_REQUISITANTE,
		CD_PESSOA_ATENDENTE,
		CD_SETOR_ATENDIMENTO,
		CD_ESTABELECIMENTO_DESTINO,
		CD_LOCAL_ESTOQUE_DESTINO,
		CD_CENTRO_CUSTO,
		DT_BAIXA,
		DT_LIBERACAO,
		DT_EMISSAO_SETOR,
		DT_EMISSAO_LOC_ESTOQUE,
		DS_OBSERVACAO,
		NR_SEQ_ORDEM_SERV,
		IE_URGENTE,
		CD_SETOR_ENTREGA,
		IE_GERACAO,
		NM_USUARIO_LIB,
		NR_SEQ_PROJ_GPI,
		NR_DOCUMENTO_EXTERNO,
		NR_SEQ_INV_ROUPA,
		NM_USUARIO_RECEBEDOR,
		DT_RECEBIMENTO,
		NR_SEQ_PROTOCOLO,
		NR_ADIANTAMENTO,
		CD_PESSOA_SOLICITANTE,
		DT_APROVACAO,
		NM_USUARIO_APROV,
		NR_ATENDIMENTO,
		NR_SEQ_JUSTIFICATIVA,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		IE_ORIGEM_REQUISICAO,
		NR_PRESCRICAO,
		NR_CIRURGIA
	from	requisicao_material
	where	nr_requisicao = nr_requisicao_p;

	open C01;
	loop
	fetch C01 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		select (coalesce(max(nr_sequencia),0) + 1)
		into STRICT	nr_sequencia_ww
		from	item_requisicao_material
		where	nr_requisicao = nr_requisicao_w;

		insert into item_requisicao_material(
			NR_REQUISICAO,
			NR_SEQUENCIA,
			CD_ESTABELECIMENTO,
			CD_MATERIAL,
			QT_MATERIAL_REQUISITADA,
			QT_MATERIAL_ATENDIDA,
			VL_MATERIAL,
			DT_ATUALIZACAO,
			NM_USUARIO,
			CD_UNIDADE_MEDIDA,
			DT_ATENDIMENTO,
			CD_PESSOA_RECEBE,
			CD_PESSOA_ATENDE,
			IE_ACAO,
			CD_MOTIVO_BAIXA,
			QT_ESTOQUE,
			CD_UNIDADE_MEDIDA_ESTOQUE,
			CD_CONTA_CONTABIL,
			CD_MATERIAL_REQ,
			NR_SEQ_LOTE_FORNEC,
			CD_CGC_FORNECEDOR,
			DS_OBSERVACAO,
			IE_GERACAO,
			NR_SEQ_COR_EXEC,
			VL_PRECO_VENDA,
			NM_USUARIO_RETIRADA,
			CD_MATERIAL_LIDO,
			DS_JUSTIFICATIVA,
			NR_SEQ_ETAPA_GPI,
			NR_DOCUMENTO_EXTERNO,
			NR_ITEM_DOCTO_EXTERNO,
			NR_SEQ_APROVACAO,
			DT_APROVACAO,
			NM_USUARIO_APROV,
			VL_UNIT_PREVISTO,
			DT_REPROVACAO,
			IE_MSG_ESTOQUE_MAX,
			QT_ESTOQUE_SUPEROU,
			CD_KIT_MATERIAL,
			DS_JUSTIFICATIVA_ATEND,
			nr_seq_justificativa)
		SELECT	NR_REQUISICAO_w,
			NR_SEQUENCIA_ww,
			CD_ESTABELECIMENTO,
			CD_MATERIAL,
			QT_MATERIAL_REQUISITADA,
			QT_MATERIAL_ATENDIDA,
			VL_MATERIAL,
			DT_ATUALIZACAO,
			NM_USUARIO,
			CD_UNIDADE_MEDIDA,
			DT_ATENDIMENTO,
			CD_PESSOA_RECEBE,
			CD_PESSOA_ATENDE,
			IE_ACAO,
			CD_MOTIVO_BAIXA,
			QT_ESTOQUE,
			CD_UNIDADE_MEDIDA_ESTOQUE,
			CD_CONTA_CONTABIL,
			CD_MATERIAL_REQ,
			NR_SEQ_LOTE_FORNEC,
			CD_CGC_FORNECEDOR,
			DS_OBSERVACAO,
			IE_GERACAO,
			NR_SEQ_COR_EXEC,
			VL_PRECO_VENDA,
			NM_USUARIO_RETIRADA,
			CD_MATERIAL_LIDO,
			DS_JUSTIFICATIVA,
			NR_SEQ_ETAPA_GPI,
			NR_DOCUMENTO_EXTERNO,
			NR_ITEM_DOCTO_EXTERNO,
			NR_SEQ_APROVACAO,
			DT_APROVACAO,
			NM_USUARIO_APROV,
			VL_UNIT_PREVISTO,
			DT_REPROVACAO,
			IE_MSG_ESTOQUE_MAX,
			QT_ESTOQUE_SUPEROU,
			CD_KIT_MATERIAL,
			DS_JUSTIFICATIVA_ATEND,
			nr_seq_justificativa
		from	item_requisicao_material
		where	nr_requisicao = nr_requisicao_p
		and	nr_sequencia = nr_sequencia_w;

		delete	FROM item_requisicao_material
		where	nr_requisicao = nr_requisicao_p
		and	nr_sequencia = nr_sequencia_w;
		end;
	end loop;
	close C01;

	nr_sequencia_ww := 0;
	open C02;
	loop
	fetch C02 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		nr_sequencia_ww := (nr_sequencia_ww + 1);

		update	item_requisicao_material
		set	nr_sequencia = nr_sequencia_ww
		where	nr_requisicao = nr_requisicao_p
		and	nr_sequencia = nr_sequencia_w;
		end;
	end loop;
	close C02;

	nr_req_gerada_p := nr_requisicao_w;

	commit;
	end;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desdobrar_req_nec_receita ( nr_requisicao_p bigint, nm_usuario_p text, nr_req_gerada_p INOUT bigint) FROM PUBLIC;

