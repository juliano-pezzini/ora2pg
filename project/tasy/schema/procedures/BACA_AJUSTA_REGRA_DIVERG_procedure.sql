-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_ajusta_regra_diverg () AS $body$
DECLARE


nr_sequencia_w			bigint;
cd_estabelecimento_w		smallint;
cd_local_estoque_w		smallint;
pr_dif_valor_w			real;
pr_dif_quantidade_w		real;
cd_grupo_material_w		smallint;
cd_subgrupo_material_w		smallint;
cd_classe_material_w		smallint;
cd_material_w			integer;
ds_comando_w			varchar(2000);
qt_registro_w			bigint;
qt_regra_w			bigint;
nm_usuario_w			varchar(15);

c01 CURSOR FOR
SELECT	nr_Sequencia,
	cd_estabelecimento,
	cd_local_estoque,
	cd_grupo_material,
	cd_subgrupo_material,
	cd_classe_material,
	cd_material
from	regra_diverg_oc_nf
where	coalesce(ie_tipo_regra::text, '') = '';

c02 CURSOR FOR
SELECT	cd_estabelecimento
from	estabelecimento;


BEGIN

open C01;
loop
fetch C01 into
	nr_Sequencia_w,
	cd_estabelecimento_w,
	cd_local_estoque_w,
	cd_grupo_material_w,
	cd_subgrupo_material_w,
	cd_classe_material_w,
	cd_material_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	pr_dif_valor_w := OBTER_VALOR_DINAMICO('SELECT NVL(MAX(PR_DIF_VALOR),0) FROM REGRA_DIVERG_OC_NF WHERE NR_SEQUENCIA = ' || NR_SEQUENCIA_W, pr_dif_valor_w);
	pr_dif_quantidade_w := OBTER_VALOR_DINAMICO('SELECT NVL(MAX(PR_DIF_QUANTIDADE),0) FROM REGRA_DIVERG_OC_NF WHERE NR_SEQUENCIA = ' || NR_SEQUENCIA_W, pr_dif_quantidade_w);

	if (pr_dif_quantidade_w > 0) then
		ds_comando_w := 'insert into regra_diverg_oc_nf( 			' ||
				'	nr_sequencia,			' ||
				'	cd_estabelecimento,		' ||
				'	cd_local_estoque,			' ||
				'	dt_atualizacao,			' ||
				'	nm_usuario,			' ||
				'	pr_dif_valor,			' ||
				'	pr_dif_quantidade,			' ||
				'	cd_grupo_material,			' ||
				'	cd_subgrupo_material,		' ||
				'	cd_classe_material,			' ||
				'	cd_material,			' ||
				'	dt_atualizacao_nrec,		' ||
				'	nm_usuario_nrec,			' ||
				'	pr_diferenca,			' ||
				'	ie_tipo_regra)			' ||
				'select	regra_diverg_oc_nf_seq.nextval,	' ||
				'	cd_estabelecimento,		' ||
				'	cd_local_estoque,			' ||
				'	sysdate,				' ||
				'	nm_usuario,			' ||
				'	0,				' ||
				'	0,				' ||
				'	cd_grupo_material,			' ||
				'	cd_subgrupo_material,		' ||
				'	cd_classe_material,			' ||
				'	cd_material,			' ||
				'	sysdate,				' ||
				'	nm_usuario,			' ||
				'	abs(pr_dif_quantidade),		' ||
				'	2				' ||
				'from	regra_diverg_oc_nf			' ||
				'where	nr_Sequencia = :nr_sequencia	';
		CALL exec_sql_dinamico_bv('Regra divergencia',ds_comando_w,'nr_sequencia='||nr_sequencia_w);
	end if;

	if (pr_dif_quantidade_w < 0) then
		ds_comando_w := 'insert into regra_diverg_oc_nf( 			' ||
				'	nr_sequencia,			' ||
				'	cd_estabelecimento,		' ||
				'	cd_local_estoque,			' ||
				'	dt_atualizacao,			' ||
				'	nm_usuario,			' ||
				'	pr_dif_valor,			' ||
				'	pr_dif_quantidade,			' ||
				'	cd_grupo_material,			' ||
				'	cd_subgrupo_material,		' ||
				'	cd_classe_material,			' ||
				'	cd_material,			' ||
				'	dt_atualizacao_nrec,		' ||
				'	nm_usuario_nrec,			' ||
				'	pr_diferenca,			' ||
				'	ie_tipo_regra)			' ||
				'select	regra_diverg_oc_nf_seq.nextval,	' ||
				'	cd_estabelecimento,		' ||
				'	cd_local_estoque,			' ||
				'	sysdate,				' ||
				'	nm_usuario,			' ||
				'	0,				' ||
				'	0,				' ||
				'	cd_grupo_material,			' ||
				'	cd_subgrupo_material,		' ||
				'	cd_classe_material,			' ||
				'	cd_material,			' ||
				'	sysdate,				' ||
				'	nm_usuario,			' ||
				'	abs(pr_dif_quantidade),		' ||
				'	7				' ||
				'from	regra_diverg_oc_nf			' ||
				'where	nr_Sequencia = :nr_sequencia	';
		CALL exec_sql_dinamico_bv('Regra divergencia',ds_comando_w,'nr_sequencia='||nr_sequencia_w);
	end if;

	if (pr_dif_valor_w > 0) then
		ds_comando_w := 'insert into regra_diverg_oc_nf(		 	' ||
				'	nr_sequencia,			' ||
				'	cd_estabelecimento,		' ||
				'	cd_local_estoque,			' ||
				'	dt_atualizacao,			' ||
				'	nm_usuario,			' ||
				'	pr_dif_valor,			' ||
				'	pr_dif_quantidade,			' ||
				'	cd_grupo_material,			' ||
				'	cd_subgrupo_material,		' ||
				'	cd_classe_material,			' ||
				'	cd_material,			' ||
				'	dt_atualizacao_nrec,		' ||
				'	nm_usuario_nrec,			' ||
				'	pr_diferenca,			' ||
				'	ie_tipo_regra)			' ||
				'select	regra_diverg_oc_nf_seq.nextval,	' ||
				'	cd_estabelecimento,		' ||
				'	cd_local_estoque,			' ||
				'	sysdate,				' ||
				'	nm_usuario,			' ||
				'	0,				' ||
				'	0,				' ||
				'	cd_grupo_material,			' ||
				'	cd_subgrupo_material,		' ||
				'	cd_classe_material,			' ||
				'	cd_material,			' ||
				'	sysdate,				' ||
				'	nm_usuario,			' ||
				'	abs(pr_dif_valor),			' ||
				'	3				' ||
				'from	regra_diverg_oc_nf			' ||
				'where	nr_Sequencia = :nr_sequencia	';
		CALL exec_sql_dinamico_bv('Regra divergencia',ds_comando_w,'nr_sequencia='||nr_sequencia_w);
	end if;

	if (pr_dif_valor_w < 0) then
		ds_comando_w := 'insert into regra_diverg_oc_nf( 			' ||
				'	nr_sequencia,			' ||
				'	cd_estabelecimento,		' ||
				'	cd_local_estoque,			' ||
				'	dt_atualizacao,			' ||
				'	nm_usuario,			' ||
				'	pr_dif_valor,			' ||
				'	pr_dif_quantidade,			' ||
				'	cd_grupo_material,			' ||
				'	cd_subgrupo_material,		' ||
				'	cd_classe_material,			' ||
				'	cd_material,			' ||
				'	dt_atualizacao_nrec,		' ||
				'	nm_usuario_nrec,			' ||
				'	pr_diferenca,			' ||
				'	ie_tipo_regra)			' ||
				'select	regra_diverg_oc_nf_seq.nextval,	' ||
				'	cd_estabelecimento,		' ||
				'	cd_local_estoque,			' ||
				'	sysdate,				' ||
				'	nm_usuario,			' ||
				'	0,				' ||
				'	0,				' ||
				'	cd_grupo_material,			' ||
				'	cd_subgrupo_material,		' ||
				'	cd_classe_material,			' ||
				'	cd_material,			' ||
				'	sysdate,				' ||
				'	nm_usuario,			' ||
				'	abs(pr_dif_valor),			' ||
				'	8				' ||
				'from	regra_diverg_oc_nf			' ||
				'where	nr_Sequencia = :nr_sequencia	';
		CALL exec_sql_dinamico_bv('Regra divergencia',ds_comando_w,'nr_sequencia='||nr_sequencia_w);
	end if;
	commit;
	delete from regra_diverg_oc_nf
	where nr_sequencia = nr_sequencia_w;
	commit;
	end;
end loop;
close C01;

open C02;
loop
fetch C02 into
	cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	select	count(*)
	into STRICT	qt_regra_w
	from	regra_diverg_oc_nf
	where	ie_tipo_regra = 5
	and	cd_estabelecimento = cd_estabelecimento_w;

	select	count(*)
	into STRICT	qt_registro_w
	from	user_tab_columns
	where	table_name     	= 'REGRA_DIVERG_OC_NF'
	and	column_name 	= 'PR_DIF_VALOR';

	if (qt_registro_w > 0) and (qt_regra_w = 0) then

		nm_usuario_w := 'Tasy';
		ds_comando_w := 'insert into regra_diverg_oc_nf( 	' ||
				'	nr_sequencia,			' ||
				'	cd_estabelecimento,		' ||
				'	cd_local_estoque,			' ||
				'	dt_atualizacao,			' ||
				'	nm_usuario,			' ||
				'	pr_dif_valor,			' ||
				'	pr_dif_quantidade,			' ||
				'	cd_grupo_material,			' ||
				'	cd_subgrupo_material,		' ||
				'	cd_classe_material,			' ||
				'	cd_material,			' ||
				'	dt_atualizacao_nrec,		' ||
				'	nm_usuario_nrec,			' ||
				'	pr_diferenca,			' ||
				'	ie_tipo_regra)			' ||
				'select	regra_diverg_oc_nf_seq.nextval,	' ||
					cd_estabelecimento_w	|| ','	  ||
				'	null,				' ||
				'	sysdate,				' ||
				chr(39) || 'Tasy' || chr(39) || ','	  		  ||
				'	0,				' ||
				'	0,				' ||
				'	null,				' ||
				'	null,				' ||
				'	null,				' ||
				'	null,				' ||
				'	sysdate,				' ||
				chr(39) || 'Tasy' || chr(39) || ','	 		  ||
				'	0,				' ||
				'	5				' ||
				'from	regra_diverg_oc_nf			' ||
				'where	rownum <= 1			';
		CALL exec_sql_dinamico_bv('Regra divergencia',ds_comando_w,'');
	end if;
	end;
end loop;
close C02;

select	count(*)
into STRICT	qt_registro_w
from	user_tab_columns
where	table_name     	= 'REGRA_DIVERG_OC_NF'
and	column_name 	= 'PR_DIF_VALOR';
if (qt_registro_w > 0) then
	ds_comando_w :=	'alter table regra_diverg_oc_nf drop column pr_dif_valor';
	CALL exec_sql_dinamico_bv('Regra divergencia',ds_comando_w,'');
end if;

select	count(*)
into STRICT	qt_registro_w
from	user_tab_columns
where	table_name     	= 'REGRA_DIVERG_OC_NF'
and	column_name 	= 'PR_DIF_QUANTIDADE';
if (qt_registro_w > 0) then
	ds_comando_w :=	'alter table regra_diverg_oc_nf drop column PR_DIF_QUANTIDADE';
	CALL exec_sql_dinamico_bv('Regra divergencia',ds_comando_w,'');
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_ajusta_regra_diverg () FROM PUBLIC;

