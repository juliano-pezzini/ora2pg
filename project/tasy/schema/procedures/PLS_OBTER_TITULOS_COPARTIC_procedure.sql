-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_titulos_copartic ( nr_seq_conta_copartic_p bigint, ds_titulo_p INOUT text, dt_pagamento_previsto_p INOUT timestamp, dt_liquidacao_p INOUT timestamp) AS $body$
DECLARE


nr_titulo_w			titulo_receber.nr_titulo%type;
dt_pagamento_previsto_w		titulo_receber.dt_pagamento_previsto%type;
dt_liquidacao_w			titulo_receber.dt_liquidacao%type;
ds_titulo_w			varchar(255) := ' ';

c_titulos CURSOR FOR
SELECT	e.nr_titulo,
	e.dt_pagamento_previsto,
	e.dt_liquidacao
FROM pls_mensalidade_item_conta ic, pls_mensalidade_seg_item i, pls_mensalidade_segurado g, pls_mensalidade m
LEFT OUTER JOIN titulo_receber e ON (m.nr_sequencia = e.nr_seq_mensalidade)
WHERE m.nr_sequencia			= g.nr_seq_mensalidade and i.nr_seq_mensalidade_seg	= g.nr_sequencia and ic.nr_seq_item			= i.nr_sequencia and ic.nr_seq_conta_copartic	= nr_seq_conta_copartic_p order by e.dt_emissao;


BEGIN

open c_titulos;
loop
fetch c_titulos into
	nr_titulo_w,
	dt_pagamento_previsto_w,
	dt_liquidacao_w;
EXIT WHEN NOT FOUND; /* apply on c_titulos */
	begin

	if (length(ds_titulo_w) < 255) and (coalesce(nr_titulo_w,0) != 0) then
		ds_titulo_w := substr(ds_titulo_w || nr_titulo_w ||', ',1,255);
	end if;

	if (dt_pagamento_previsto_w > dt_pagamento_previsto_p) or (coalesce(dt_pagamento_previsto_p,clock_timestamp()) = clock_timestamp()) then
		dt_pagamento_previsto_p := dt_pagamento_previsto_w;
	end if;

	if (dt_liquidacao_w > dt_liquidacao_p) or (coalesce(dt_liquidacao_p,clock_timestamp()) = clock_timestamp()) then
		dt_liquidacao_p := dt_liquidacao_w;
	end if;

	end;
end loop;
close c_titulos;

ds_titulo_p := substr(ds_titulo_w,1,length(ds_titulo_w) - 2);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_titulos_copartic ( nr_seq_conta_copartic_p bigint, ds_titulo_p INOUT text, dt_pagamento_previsto_p INOUT timestamp, dt_liquidacao_p INOUT timestamp) FROM PUBLIC;

