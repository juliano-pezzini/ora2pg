-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_gerar_reap_atend ( nr_seq_conta_reap_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
dt_atendimento_w    	timestamp;
dt_validade_carteira_w 	timestamp;
dt_atualizacao_w    	timestamp;
cd_convenio_w     	integer;
nr_sequencia_w     	bigint;
ds_plano_w       	varchar(100);
nm_usuario_w      	varchar(15);
cd_usuario_convenio_w  	varchar(30);
cd_pessoa_fisica_w	varchar(255);
ie_carater_internacao_w	varchar(255);
cd_cnes_w		varchar(255);
cd_estabelecimento_w	bigint;
nr_interno_conta_w		bigint;
ie_tipo_saida_consulta_w 	varchar(255);
nr_seq_saida_consulta_w	bigint;
nr_atendimento_w		bigint;
ie_tipo_acomodacao_w	varchar(255);
dt_alta_w			timestamp;
ie_regime_internacao_w	varchar(25);
ie_gestacao_w		varchar(30);
ie_aborto_w		varchar(30);
ie_transtorno_w		varchar(30);
ie_complic_puerperio_w	varchar(30);
qt_obito_precoce_w	bigint;
qt_obito_tardio_w		bigint;
qt_nasc_vivo_w		bigint;
qt_nasc_morto_w		bigint;
qt_nasc_prematuro_w	bigint;
nr_dnv_w			varchar(255);
ie_complic_neonatal_w	varchar(30);
ie_baixo_peso_w		varchar(30);
ie_cesareo_w		varchar(30);
ie_normal_w		varchar(30);
ie_atend_rn_w		varchar(30);
ie_tipo_internacao_w	varchar(50);
ds_tipo_fatur_w		varchar(255);
ie_tipo_consulta_w		varchar(255);


BEGIN 
 
select	a.nr_interno_conta, 
	a.dt_atualizacao, 
	a.nm_usuario, 
	a.dt_atendimento, 
	a.cd_convenio, 
	--substr(Obter_Plano_Atendimento(obter_atendimento_conta(a.nr_interno_conta),'D'),1,100), 
	substr(obter_desc_plano(a.cd_convenio,a.cd_plano),1,100), 
	a.dt_validade_carteira, 
	a.cd_usuario_convenio, 
	substr(obter_pessoa_atendimento(obter_atendimento_conta(nr_interno_conta), 'C'),1,255) 
into STRICT	nr_interno_conta_w, 
	dt_atualizacao_w, 
	nm_usuario_w, 
	dt_atendimento_w, 
	cd_convenio_w, 
	ds_plano_w, 
	dt_validade_carteira_w, 
	cd_usuario_convenio_w, 
	cd_pessoa_fisica_w 
from	tiss_reap_conta a 
where	a.nr_sequencia		= nr_seq_conta_reap_p;
 
select	coalesce(max(TISS_OBTER_CARATER_INTERN(b.ie_carater_inter_sus)), max(CASE WHEN b.ie_carater_inter_sus='1' THEN  'E' WHEN b.ie_carater_inter_sus='01' THEN  'E'  ELSE 'U' END )), 
	max(a.cd_estabelecimento), 
	max(a.nr_seq_saida_consulta), 
	max(b.nr_atendimento), 
	coalesce(max(b.dt_alta), max(a.dt_alta_tiss)), 
	max(tiss_obter_regime_atend(b.nr_atendimento, a.cd_convenio_parametro)), 
	max(coalesce(a.ie_tipo_fatur_tiss, CASE WHEN coalesce(b.dt_fim_conta::text, '') = '' THEN  'P'  ELSE 'T' END )), 
	coalesce(coalesce(max(a.ie_tipo_consulta_tiss), max(b.ie_tipo_consulta)), '1') 
into STRICT	ie_carater_internacao_w, 
	cd_estabelecimento_w, 
	nr_seq_saida_consulta_w, 
	nr_atendimento_w, 
	dt_alta_w, 
	ie_regime_internacao_w, 
	ds_tipo_fatur_w, 
	ie_tipo_consulta_w 
from	atendimento_paciente b, 
	conta_paciente a, 
	tiss_reap_conta c 
where	a.nr_interno_conta	= c.nr_interno_conta 
and	a.nr_atendimento		= b.nr_atendimento 
and	c.nr_sequencia		= nr_seq_conta_reap_p;
 
select	coalesce(max(a.cd_cns), max(b.cd_cnes)) cd_cnes 
into STRICT	cd_cnes_w 
from	pessoa_juridica b, 
	estabelecimento a 
where	a.cd_estabelecimento	= cd_estabelecimento_w 
and	a.cd_cgc			= b.cd_cgc;
 
select 	max(cd_tipo_saida) 
into STRICT	ie_tipo_saida_consulta_w 
from	tiss_tipo_saida_consulta 
where	nr_sequencia		= nr_seq_saida_consulta_w;
 
select	max(tiss_obter_tipo_acomod(b.cd_tipo_acomodacao)) 
into STRICT	ie_tipo_acomodacao_w 
from	pessoa_fisica c, 
	atend_categoria_convenio b, 
	atendimento_paciente a 
where	a.nr_atendimento		= b.nr_atendimento 
and	b.nr_seq_interno		= obter_atecaco_atendimento(b.nr_atendimento) 
and	a.cd_pessoa_fisica	= c.cd_pessoa_fisica 
and	a.nr_atendimento		= nr_atendimento_w;
 
select	max(tiss_obter_dados_parto_nasc(a.nr_atendimento, 2500, 'G')) ie_gestacao, 
	max(tiss_obter_dados_parto_nasc(a.nr_atendimento, 2500, 'A')) ie_aborto, 
	max(tiss_obter_dados_parto_nasc(a.nr_atendimento, 2500, 'T')) ie_transtorno, 
	max(tiss_obter_dados_parto_nasc(a.nr_atendimento, 2500, 'P')) ie_complicacao_puerperio, 
	max(tiss_obter_dados_parto_nasc(a.nr_atendimento, 2500, 'N')) ie_complicacao_neonatal, 
	max(tiss_obter_dados_parto_nasc(a.nr_atendimento, 2500, 'B')) ie_baixo_peso, 
	max(CASE WHEN b.ie_parto_cesaria='S' THEN  1  ELSE 0 END ) ie_parto_cesaria, 
	max(CASE WHEN b.ie_parto_normal='S' THEN  1  ELSE 0 END ) ie_parto_normal, 
	max(b.qt_nasc_mortos), 
	max(tiss_obter_dados_parto_nasc(a.nr_atendimento, 2500, 'QTA')) qt_nasc_vivo, 
	max(tiss_obter_dados_parto_nasc(a.nr_atendimento, 2500, 'QT')) qt_nasc_vivos_prematuros, 
	max(tiss_obter_dados_parto_nasc(a.nr_atendimento, 2500, 'S')) ie_atend_rn_sala_parto, 
	max(tiss_obter_dados_parto_nasc(a.nr_atendimento, 2500, 'QTP')) qt_obito_precoce, 
	max(tiss_obter_dados_parto_nasc(a.nr_atendimento, 2500, 'QTT')) qt_obito_tardio, 
	substr(tiss_obter_clinica(max(a.ie_clinica), max(a.nr_seq_classificacao)),1,3) 
into STRICT	ie_gestacao_w, 
	ie_aborto_w, 
	ie_transtorno_w, 
	ie_complic_puerperio_w, 
	ie_complic_neonatal_w, 
	ie_baixo_peso_w, 
	ie_cesareo_w, 
	ie_normal_w, 
	qt_nasc_morto_w, 
	qt_nasc_vivo_w, 
	qt_nasc_prematuro_w, 
	ie_atend_rn_w, 
	qt_obito_precoce_w, 
	qt_obito_tardio_w, 
	ie_tipo_internacao_w 
FROM pessoa_fisica c, atendimento_paciente a
LEFT OUTER JOIN parto b ON (a.nr_atendimento = b.nr_atendimento)
WHERE substr(tiss_obter_clinica(a.ie_clinica, a.nr_seq_classificacao),1,3) 	= 3  and a.cd_pessoa_fisica				= c.cd_pessoa_fisica and a.nr_atendimento				= nr_atendimento_w;
 
 
if (coalesce(qt_obito_precoce_w,0) > 0) then 
	qt_obito_tardio_w	:= null;
elsif (coalesce(qt_obito_tardio_w,0) > 0) then 
	qt_obito_precoce_w	:= null;
elsif (coalesce(qt_obito_tardio_w,0) = 0) and (coalesce(qt_obito_precoce_w,0) = 0) then 
	qt_obito_tardio_w	:= null;
	qt_obito_precoce_w	:= null;
end if;
 
select	nextval('tiss_conta_atend_seq') 
into STRICT	nr_sequencia_w
;
 
insert into tiss_conta_atend( 
	nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	dt_entrada, 
	cd_convenio, 
	ds_plano, 
	dt_validade_carteira, 
	cd_usuario_convenio, 
	nr_seq_reap_conta, 
	cd_pessoa_fisica, 
	ie_carater_internacao, 
	cd_cnes, 
	nr_interno_conta, 
	ie_tipo_saida_consulta, 
	ie_tipo_acomodacao, 
	dt_alta, 
	ie_regime_internacao, 
	ie_gestacao, 
	ie_aborto, 
	ie_transtorno, 
	ie_complic_puerperio, 
	qt_obito_precoce, 
	qt_obito_tardio, 
	qt_nasc_vivo, 
	qt_nasc_morto, 
	qt_nasc_prematuro, 
	nr_dnv, 
	ie_complic_neonatal, 
	ie_baixo_peso, 
	ie_cesareo, 
	ie_normal, 
	ie_atend_rn, 
	ie_tipo_internacao, 
	ds_tipo_fatur, 
	ie_tipo_consulta) 
values (	nr_sequencia_w, 
	dt_atualizacao_w, 
	nm_usuario_w, 
	dt_atendimento_w, 
	cd_convenio_w, 
	ds_plano_w, 
	dt_validade_carteira_w, 
	cd_usuario_convenio_w, 
	nr_seq_conta_reap_p, 
	cd_pessoa_fisica_w, 
	ie_carater_internacao_w, 
	cd_cnes_w, 
	nr_interno_conta_w, 
	ie_tipo_saida_consulta_w, 
	ie_tipo_acomodacao_w, 
	dt_alta_w, 
	ie_regime_internacao_w, 
	ie_gestacao_w, 
	ie_aborto_w, 
	ie_transtorno_w, 
	ie_complic_puerperio_w, 
	qt_obito_precoce_w, 
	qt_obito_tardio_w, 
	qt_nasc_vivo_w, 
	qt_nasc_morto_w, 
	qt_nasc_prematuro_w, 
	nr_dnv_w, 
	ie_complic_neonatal_w, 
	ie_baixo_peso_w, 
	ie_cesareo_w, 
	ie_normal_w, 
	ie_atend_rn_w, 
	ie_tipo_internacao_w, 
	ds_tipo_fatur_w, 
	ie_tipo_consulta_w);
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_gerar_reap_atend ( nr_seq_conta_reap_p bigint, nm_usuario_p text) FROM PUBLIC;

