-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sup_excluir_lote_fornec ( nr_sequencia_p bigint, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE

 
				 
ie_commitar_w	varchar(1) 	:= 'S';
ds_erro_w	varchar(4000) 	:= '';
nr_seq_op_opm_w	bigint;


BEGIN 
ds_erro_w := consistir_excluir_lote_fornec(nr_sequencia_p, ds_erro_w);
 
select  max(b.nr_seq_op_opm) 
into STRICT   nr_seq_op_opm_w 
from   material_lote_fornec a, 
      lote_producao b 
where  a.nr_sequencia = nr_sequencia_p 
and   a.nr_lote_producao = b.nr_lote_producao;
 
if (coalesce(ds_erro_w::text, '') = '') then 
	begin 
	delete	FROM material_lote_fornec 
	where	nr_sequencia = nr_sequencia_p;
	exception 
	when others then 
		begin 
		ie_commitar_w	:= 'N';
		ds_erro_w	:= substr(WHEB_MENSAGEM_PCK.get_texto(278058) || sqlerrm,1,4000);
		end;
	end;
else 
	ie_commitar_w	:= 'N';
end if;
 
if (ie_commitar_w = 'S') then 
	begin 
	CALL gravar_log_exclusao('MATERIAL_LOTE_FORNEC',nm_usuario_p,'NR_SEQUENCIA='||to_char(nr_sequencia_p),'N');
	commit;
 
  if (coalesce(nr_seq_op_opm_w,0) > 0) then 
   CALL gravar_status_op_opm(nr_seq_op_opm_w,'AELF',null,nm_usuario_p,wheb_usuario_pck.get_cd_estabelecimento);
  end if;
	end;
end if;
ds_erro_p := ds_erro_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_excluir_lote_fornec ( nr_sequencia_p bigint, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

