-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_tempo_padrao_ageint (nr_seq_proc_interno_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_medico_p text, cd_agenda_p bigint, cd_pessoa_fisica_p text, qt_minuto_p INOUT bigint, ie_lado_p text, cd_convenio_p bigint, cd_categoria_p text, cd_plano_p text, nr_seq_agenda_p bigint default null, ie_dia_semana_p bigint default null, qt_idade_p bigint default 0, cd_estab_agenda_p bigint default 0) AS $body$
DECLARE


qt_minuto_w		bigint	:= 0;
qt_anos_w		integer 	:= 0;
ie_lado_w		varchar(1);
cd_estab_agenda_w	smallint;
dt_agenda_w		timestamp;
ie_dia_semana_w		smallint;


c01 CURSOR FOR
		SELECT	qt_minuto		
		from	tempo_procedimento
		where	nr_seq_proc_interno 	= nr_seq_proc_interno_p		
		and	((cd_pessoa_fisica	= cd_medico_p) 	or (coalesce(cd_medico_p::text, '') = '' and coalesce(cd_pessoa_fisica::text, '') = '') or coalesce(cd_pessoa_fisica::text, '') = '')
		and	((cd_convenio		= cd_convenio_p) 	or (coalesce(cd_convenio_p::text, '') = '' and coalesce(cd_convenio::text, '') = '') or coalesce(cd_convenio::text, '') = '')
		and	((cd_categoria		= cd_categoria_p) 	or (coalesce(cd_categoria_p::text, '') = '' and coalesce(cd_categoria::text, '') = '') or coalesce(cd_categoria::text, '') = '')
		and	((cd_plano		= cd_plano_p) 		or (coalesce(cd_plano_p::text, '') = '' and coalesce(cd_plano::text, '') = '') or coalesce(cd_plano::text, '') = '')
		and	((ie_lado		= ie_lado_p) 		or (coalesce(ie_lado_p::text, '') = '' and coalesce(ie_lado::text, '') = '') or coalesce(ie_lado::text, '') = '')
		and	((cd_agenda  =  cd_agenda_p) or (coalesce(cd_agenda::text, '') = ''))--(nvl(cd_agenda, cd_agenda_p) = cd_agenda_p or cd_agenda_p is null)
		and	qt_anos_w  between coalesce(qt_idade_minima,0) and coalesce(qt_idade_maxima,999)
		and	((cd_estabelecimento 	= cd_estab_agenda_w) or (coalesce(cd_estabelecimento::text, '') = ''))
		and	((ie_dia_semana = ie_dia_semana_w) or ((ie_dia_semana = 9) and (ie_dia_semana_w not in (1,7))) or (coalesce(ie_dia_semana::text, '') = ''))
		order by coalesce(cd_agenda,0),
			coalesce(cd_estabelecimento,0),
			coalesce(cd_pessoa_fisica,'0'),
			coalesce(ie_lado,' ');


BEGIN

if (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') and (coalesce(ie_dia_semana_p::text, '') = '') then

	select	max(hr_inicio)
	into STRICT	dt_agenda_w
	from	agenda_paciente
	where	nr_sequencia = nr_seq_agenda_p;
	
	if (dt_agenda_w IS NOT NULL AND dt_agenda_w::text <> '') then
		ie_dia_semana_w	:= obter_cod_dia_semana(dt_agenda_w);
	else
		ie_dia_semana_w	:= null;
	end if;
	
else
	ie_dia_semana_w	:= ie_dia_semana_p;
end if;

begin
	if (coalesce(qt_idade_p,0) = 0) then
		select	(obter_idade(dt_nascimento, clock_timestamp(), 'A'))::numeric
		into STRICT	qt_anos_w
		from	pessoa_fisica
		where	cd_pessoa_fisica = cd_pessoa_fisica_p;
	else
		qt_anos_w := coalesce(qt_idade_p,0);
	end if;
exception
when others then
	qt_anos_w := 0;
end;

if (cd_agenda_p IS NOT NULL AND cd_agenda_p::text <> '') then
	if (coalesce(cd_estab_agenda_p,0) = 0) then
		select	max(cd_estabelecimento)
		into STRICT	cd_estab_agenda_w
		from	agenda
		where	cd_agenda = cd_agenda_p;
	else
		cd_estab_agenda_w := coalesce(cd_estab_agenda_p,0);
	end if;
else
	select	max(wheb_usuario_pck.get_cd_estabelecimento)
	into STRICT	cd_estab_agenda_w
	;
end if;	

Open 	c01;
loop
fetch	c01
into 	qt_minuto_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin		
		qt_minuto_w	:= qt_minuto_w;
		end;
end loop;
close c01;

qt_minuto_p	:= qt_minuto_w;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_tempo_padrao_ageint (nr_seq_proc_interno_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_medico_p text, cd_agenda_p bigint, cd_pessoa_fisica_p text, qt_minuto_p INOUT bigint, ie_lado_p text, cd_convenio_p bigint, cd_categoria_p text, cd_plano_p text, nr_seq_agenda_p bigint default null, ie_dia_semana_p bigint default null, qt_idade_p bigint default 0, cd_estab_agenda_p bigint default 0) FROM PUBLIC;

