-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_email_consist_req ( nm_usuario_p text, cd_estabelecimento_p bigint, nr_requisicao_p bigint, nr_sequencia_p bigint, ds_consistencia_p text) AS $body$
DECLARE

 
/*Regra*/
 
qt_existe_regra_w	bigint;
ds_mensagem_w		varchar(4000);
ds_assunto_w		varchar(80);
ds_email_origem_w	varchar(255);
ds_email_destino_w	varchar(255);
ie_prioridade_w		varchar(1);
ie_usuario_w		varchar(1);
nr_seq_regra_w		bigint;
ds_email_adicional_w	varchar(2000);
cd_perfil_disparar_w	integer;
ie_existe_regra_w	varchar(1);
ds_destinatarios_w	varchar(4000);
ds_email_remetente_w	varchar(255);
cd_comprador_w		bigint;
nm_usuario_origem_w	varchar(255);
qt_existe_w		bigint;
ds_email_solic_w	varchar(255);

ie_enviar_w		varchar(1);
/*Filtros da regra*/
cd_local_estoque_w	smallint;
cd_centro_custo_w	smallint;
cd_grupo_material_w	smallint;
cd_subgrupo_material_w	smallint;
cd_classe_material_w	integer;
cd_material_w		bigint;
ie_consignado_w		varchar(1);
ie_envia_email_w	varchar(1);

/*UsuÃ¡rios da regra*/
 
ie_usuario_receb_w	varchar(15);
nm_usuario_receb_w	varchar(15);
ie_aprov_dif_regra_w	varchar(1);

C01 CURSOR FOR 
	SELECT	ds_assunto, 
		ds_mensagem_padrao, 
		ie_usuario, 
		nr_sequencia, 
		coalesce(ds_email_remetente,'X'), 
		ds_email_adicional, 
		cd_perfil_disparar 
	from	regra_envio_email_compra 
	where	cd_estabelecimento = cd_estabelecimento_p 
	and	ie_tipo_mensagem = 91 
	and	ie_situacao = 'A';
	
C02 CURSOR FOR 
	SELECT 	cd_local_estoque, 
		cd_centro_custo, 
		cd_grupo_material, 
		cd_subgrupo_material, 
		cd_classe_material, 
		cd_material, 
		ie_consignado, 
		ie_envia_email 
	from	envio_email_compra_filtro 
	where	nr_seq_regra = nr_seq_regra_w;
		

BEGIN 
 
select	count(*) 
into STRICT	qt_existe_regra_w 
from	regra_envio_email_compra 
where	cd_estabelecimento = cd_estabelecimento_p 
and	ie_tipo_mensagem = 91 
and	ie_situacao = 'A';
 
if (qt_existe_regra_w > 0) then 
	begin 
	 
	open C01;
	loop 
	fetch C01 into	 
		ds_assunto_w, 
		ds_mensagem_w, 
		ie_usuario_w, 
		nr_seq_regra_w, 
		ds_email_remetente_w, 
		ds_email_adicional_w, 
		cd_perfil_disparar_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin	 
		if (coalesce(cd_perfil_disparar_w::text, '') = '') or 
		  (cd_perfil_disparar_w IS NOT NULL AND cd_perfil_disparar_w::text <> '' AND cd_perfil_disparar_w = obter_perfil_ativo)then 
			if (ie_usuario_w = 'U') or 
				((coalesce(cd_comprador_w,'0') <> 0) and (ie_usuario_w = 'O')) then --Usuario 
				begin 
				select	ds_email, 
					nm_usuario 
				into STRICT	ds_email_origem_w, 
					nm_usuario_origem_w 
				from	usuario 
				where	nm_usuario = nm_usuario_p;
				end;
			elsif (ie_usuario_w = 'C') then --Setor compras 
				begin 
				select	ds_email 
				into STRICT	ds_email_origem_w 
				from	parametro_compras 
				where	cd_estabelecimento = cd_estabelecimento_p;
		 
				select	coalesce(ds_fantasia,ds_razao_social) 
				into STRICT	nm_usuario_origem_w 
				from	estabelecimento_v 
				where	cd_estabelecimento = cd_estabelecimento_p;
				end;
			elsif (ie_usuario_w = 'O') then --Comprador 
				begin 
				select	max(ds_email), 
					max(nm_guerra) 
				into STRICT	ds_email_origem_w, 
					nm_usuario_origem_w 
				from	comprador 
				where	cd_pessoa_fisica = cd_comprador_w 
				and	cd_estabelecimento = cd_estabelecimento_p;
				end;
			end if;
 
			if (ds_email_remetente_w <> 'X') then 
				ds_email_origem_w	:= ds_email_remetente_w;
			end if;
			 
			open C02;
			loop 
			fetch C02 into	 
				cd_local_estoque_w, 
				cd_centro_custo_w, 
				cd_grupo_material_w, 
				cd_subgrupo_material_w, 
				cd_classe_material_w, 
				cd_material_w, 
				ie_consignado_w, 
				ie_envia_email_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin 
				if (ie_consignado_w = 'N') then 
					ie_consignado_w := '0';
				elsif (ie_consignado_w = 'S') then 
					ie_consignado_w := '1';
				elsif (ie_consignado_w = 'A') then 
					ie_consignado_w	:= null;
				end if;
				 
				select	count(*) 
				into STRICT	qt_existe_w 
				from	item_requisicao_material a, 
					requisicao_material b, 
					estrutura_material_v e 
				where	a.nr_requisicao = nr_requisicao_p 
				and	a.nr_sequencia = nr_sequencia_p 
				and	a.nr_requisicao = b.nr_requisicao 
				and	((coalesce(cd_local_estoque_w::text, '') = '') or (b.cd_local_estoque = coalesce(cd_local_estoque_w,b.cd_local_estoque))) 
				and	((coalesce(cd_centro_custo_w::text, '') = '') or (b.cd_centro_custo = coalesce(cd_centro_custo_w,b.cd_centro_custo))) 
				and	a.cd_material = e.cd_material 
				and	e.cd_material = coalesce(cd_material_w,e.cd_material) 
				and	e.cd_grupo_material = coalesce(cd_grupo_material_w,e.cd_grupo_material) 
				and	e.cd_subgrupo_material = coalesce(cd_subgrupo_material_w,e.cd_subgrupo_material) 
				and	e.cd_classe_material = coalesce(cd_classe_material_w,e.cd_classe_material) 
				and	e.ie_consignado = coalesce(ie_consignado_w,e.ie_consignado);
				 
				if (qt_existe_w > 0) and (ie_envia_email_w = 'S') then 
					ie_enviar_w := 'S';
				end if;
				end;
			end loop;
			close C02;
			 
			if (ie_enviar_w = 'S') then	 
				begin 
				ds_destinatarios_w := ds_email_adicional_w;
				 
				ds_assunto_w := substr(replace_macro(ds_assunto_w,'@Nr_requisicao',to_char(nr_requisicao_p)),1,80);
				ds_assunto_w := substr(replace_macro(ds_assunto_w,'@Ds_consistencia',to_char(ds_consistencia_p)),1,80);
				 
				ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@Nr_requisicao',to_char(nr_requisicao_p)),1,4000);
				ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@Ds_consistencia',to_char(ds_consistencia_p)),1,4000);
				 
				if ((ds_email_origem_w IS NOT NULL AND ds_email_origem_w::text <> '') and (ds_destinatarios_w IS NOT NULL AND ds_destinatarios_w::text <> '') and (nm_usuario_origem_w IS NOT NULL AND nm_usuario_origem_w::text <> '')) then 
					begin 
					CALL enviar_email(ds_assunto_w,ds_mensagem_w,ds_email_origem_w,ds_destinatarios_w,nm_usuario_origem_w,'M');
					end;
				end if;
				end;
			end if;
		end if;
		exception 
			when others then null;
		end;
	end loop;
	close C01;		
	exception when others then 
		null;
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_email_consist_req ( nm_usuario_p text, cd_estabelecimento_p bigint, nr_requisicao_p bigint, nr_sequencia_p bigint, ds_consistencia_p text) FROM PUBLIC;

