-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_eis_contas_pendentes ( dt_inicial_p timestamp, dt_final_p timestamp, ie_data_p text, ie_pac_alta_p text, ie_titulo_p text, ie_nota_fiscal_p text, ie_setor_atual_p text, ie_contas_canceladas_p text, ie_guias_conta_p text, ie_data_etapa_p text, ie_pac_internado_p text, ie_conta_fechada_p text, ie_maiores_zero_p text, ie_setor_pac_p text, ie_com_aih_p text, ie_com_apac_p text, ie_conta_sem_etapa_p text, ie_conta_etapa_pend_p text, ie_filtrar_estab_conta_p text, ie_retornos_p text, ie_contas_protocolo_p text, vl_inicial_p bigint, vl_final_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, cd_convenios_p text, cd_categorias_p text, ie_tipos_atendimento_p text, ie_tipos_convenio_p text, ie_status_conta_p text, cd_etapas_p text, cd_medicos_p text, cd_setores_p text, ie_lanc_setor_p text, ie_filtrar_estab_atend_p text, cd_setores_etapa_p text, cd_pessoas_etapa_p text, ie_valor_conta_p text, ie_valor_conta_sus_p text, ie_clinicas_p text, cd_procedimento_p text, cd_grupo_proc_p text, cd_area_procedimento_p text, cd_especialidade_p text, cd_planos_p text, ie_complexidade_p text, cd_setores_ult_int_p text, cd_motivos_devol_etapa_p text, cd_tipos_procedimento_p text, ie_status_protocolo_p text, cd_municipio_p text, cd_classif_setor_p text, cd_procedencia_p text, nm_usuario_etapa_p text, cd_setor_valor_p text, cd_estab_conta_p text, ie_conta_sem_proced_p text, cd_responsavel_conta_p text, ie_tipos_atend_conta_p text, ie_tipo_guia_conv_p text, cd_motivo_alta_p text, ie_tipo_protocolo_p text, cd_setor_destino_p text, nr_seq_estagio_aut_p text, nr_seq_estagio_conta_p text, nr_seq_grupo_sus_p text, nr_seq_subgrupo_sus_p text, nr_seq_forma_org_sus_p text, cd_setor_entrega_prescr_p text, cd_tipo_regulacao_p text, cd_tipo_serv_regulacao_p text, qt_dias_etapa_p bigint, cd_tipo_acomodacao_p text, ie_conta_perda_p text, nr_seq_classif_atend_p text, cd_setor_prescr_proced_p text, nr_atendimento_p bigint, dt_ref_protocolo_p timestamp, ie_cod_setores_conta_p text, nm_usuario_recep_atend_p text, nr_seq_tipo_lib_guia_p text, nm_usuario_recebimento_p text, ie_ult_etapa_receb_p text, qt_dias_atraso_p bigint, cd_agrupamento_setor_p text, ie_carater_inter_sus_p text, ie_listar_proced_p text, ie_situacao_titulo_p text, ie_etapa_conta_p text default '0', ie_conta_sem_matmed_p text DEFAULT NULL, ie_laudo_paciente_p text DEFAULT NULL, nr_seq_pessoa_classif_p text DEFAULT NULL, ie_atend_cancel_p text DEFAULT NULL, cd_setor_inicial_p text DEFAULT NULL, ie_protocolo_doc_p text DEFAULT NULL, cd_setor_prontuario_p text DEFAULT NULL, ie_conta_opme_sus_p text DEFAULT NULL, ie_conta_opme_p text DEFAULT NULL, nr_seq_tp_pend_conta_p text DEFAULT NULL, nr_seq_protocolo_p bigint DEFAULT NULL, nr_seq_estag_conta_p text DEFAULT NULL, nm_usu_ult_etapa_p text DEFAULT NULL, ie_visual_empresa_p text DEFAULT NULL) AS $body$
DECLARE


nr_atendimento_w		bigint;
nr_atendimento_ww		bigint := 0;
ie_tipo_atendimento_w		smallint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
cd_pessoa_fisica_w		varchar(10);
nr_interno_conta_w		bigint;
ie_status_conta_w		smallint;
cd_procedencia_w		integer;
nr_seq_protocolo_w		bigint;
ds_etapa_w			varchar(80);
ds_etapa_conta_obs_w		varchar(80);
nm_usuario_w			varchar(15);
cd_estabelecimento_w		smallint;
cd_convenio_w			integer;
ie_tipo_convenio_w		smallint;
cd_categoria_convenio_w		varchar(10);
cd_setor_atendimento_w		integer;
cd_guia_w			varchar(20);
dt_ultima_etapa_w		timestamp;
cd_medico_exec_w		varchar(10);
cd_setor_destino_w		integer;
cd_unidade_pac_w		varchar(21);
vl_conta_w			double precision;
vl_conta_sus_w			double precision;
ie_insere_w			varchar(1) := 'S';
cd_setor_etapa_w		integer;
dt_conta_protocolo_w		timestamp;
dt_prev_protocolo_w		timestamp;
cd_pessoa_etapa_w		varchar(10);
cd_grupo_proc_w			bigint;
cd_area_procedimento_w		bigint;
cd_especialidade_w		bigint;
qt_unidade_atendimento_w	bigint;
cd_plano_w			varchar(10);
cd_setor_ult_int_w		varchar(80);
cd_motivo_devol_etapa_w		varchar(80);
vl_conta_ww			double precision;
nr_seq_etapa_w			bigint;
ie_etapa_muda_status_w		varchar(10);
sql_err_w			varchar(1800);
nr_sequencia_proc_w		bigint;
nm_ultimo_usuario_w		varchar(15);
nm_ultimo_usu_receb_w		varchar(15);
ds_ultimo_usuario_w		varchar(255);
ds_usuario_receb_etapa_w	varchar(255);
ie_tipo_atend_conta_w		smallint;
cd_motivo_alta_w		varchar(3);
ie_tipo_protocolo_w		varchar(3);
dt_inicial_w			timestamp;
dt_final_w			timestamp;
cd_responsavel_w		varchar(10);
nr_atend_original_w		bigint;
ie_clinica_w			integer;
nr_seq_estagio_conta_w		bigint;
nr_seq_grupo_sus_w		bigint;
nr_seq_subgrupo_sus_w		bigint;
nr_seq_forma_org_sus_w		bigint;
qt_existe_w			bigint;
ds_setor_etapa_filtro_w		varchar(255);

ie_tipo_regulacao_w		varchar(01);
nr_seq_tipo_serv_regulacao_w	bigint;
nr_seq_classif_atend_w		bigint;
qt_existe_proc_w		bigint := 0;
ds_status_atend_w		varchar(255);
ie_probabilidade_alta_w		varchar(03);
ie_status_atend_w		varchar(03);
dt_alta_w			timestamp;
dt_alta_medico_w		timestamp;
dt_previsto_alta_w		timestamp;
dt_status_atend_w		timestamp;
dt_mesano_ref_prot_w		timestamp;
ds_cod_setores_conta_w		varchar(255);
nm_usuario_recep_atend_w	varchar(15);
ds_municipio_w			varchar(40);
ie_todas_pf_etapa_w		varchar(1);
ie_etapa_recebida_w		varchar(15);
cd_procedimento_aux_w		bigint;
ie_origem_proced_aux_w		bigint;
ie_setor_atend_conta_w		varchar(1);
ie_carater_inter_sus_w		varchar(2);
ds_proc_aux_w			varchar(20);
ie_tipo_atend_tiss_w		varchar(03);
ds_tipo_atend_tiss_w		varchar(255);
nr_seq_etapa_conta_w		bigint;
dt_etapa_conta_w		timestamp;
cd_setor_etapa_conta_w		integer;
ie_etapa_conta_w		varchar(15);
qt_existe_matmed_w		bigint;
ie_sem_etapa_w			varchar(1);
qt_existe_laudo_w		bigint;
nr_seq_atepacu_w		bigint;
cd_setor_inicial_w		integer;
dt_entrada_w			timestamp;
nr_seq_classif_w		bigint;
ie_usuario_atend_w		varchar(15) := 'N';
ie_somente_proc_conta_w		varchar(15) := 'N';
atend_paciente_unidade_w	varchar(15);
qt_prot_doc_w			bigint;
nr_seq_motivo_devol_etapa_w	bigint;

nm_pessoa_fisica_w		varchar(60);
ds_convenio_w			varchar(255);
ds_setor_atendimento_w		varchar(100);
ds_setor_etapa_w		varchar(100);
nm_medico_exec_w		varchar(60);
ds_tipo_atendimento_w		varchar(150);
ds_procedimento_w		varchar(255);
cd_pessoa_etapa_ww		varchar(10);
nm_pessoa_etapa_w		varchar(60);
ds_motivo_devol_w		varchar(80);
ds_status_conta_w		varchar(80);
ds_proced_atend_w		varchar(40);
ds_obs_conta_w			varchar(255);
qt_dias_atraso_atend_w		bigint;
nm_estabelecimento_w		varchar(255);
dt_periodo_ini_conta_w		timestamp;
dt_periodo_fim_conta_w		timestamp;
qt_dif_datas_alta_prot_w	bigint;
ds_tipo_guia_cta_w		varchar(80);
ie_tipo_guia_w			varchar(2);
ds_categ_conv_w			varchar(100);
cd_setor_atual_w		bigint;
ds_setor_atual_w		varchar(255);
nr_seq_agrup_atual_w		bigint;
ds_agrup_setor_atual_w		varchar(80);
ds_agrup_setor_w		varchar(80);
nr_seq_agrupamento_w		bigint;
ds_setor_destino_w		varchar(255);
cd_usuario_convenio_w		varchar(40);
cd_senha_w			varchar(20);
ie_tipo_guia_atend_w		varchar(10);
ds_tipo_guia_atend_w		varchar(80);
ds_setor_inicial_w		varchar(255);
ds_grupo_opme_param_w		varchar(80);
nr_seq_estagio_w		cta_pendencia.nr_seq_estagio%type;
qt_tipo_pend_cta_w		bigint;
qt_estag_pend_cta_w		bigint;
nr_seq_classif_etapa_w		fatur_etapa.nr_seq_classif%type;
ds_classif_etapa_w		classif_etapa.ds_classificacao%type;
cd_empresa_w			atend_categoria_convenio.cd_empresa%type;
ds_empresa_referencia_w		w_eis_conta_pendente.ds_empresa_referencia%type := '';

c01 CURSOR FOR
SELECT	a.nr_atendimento,
	a.nr_interno_conta,
	a.cd_estabelecimento,
	a.cd_convenio_parametro,
	a.cd_categoria_parametro,
	b.cd_pessoa_fisica,
	a.nm_usuario,
	b.cd_medico_resp,
	b.ie_tipo_atendimento,
	a.ie_status_acerto,
	a.nr_seq_protocolo,
	a.dt_conta_protocolo,
	a.dt_prev_protocolo,
	b.cd_procedencia,
	a.ie_tipo_atend_conta,
	b.cd_motivo_alta,
	a.cd_responsavel,
	b.nr_atend_original,
	b.ie_clinica,
	a.nr_seq_estagio_conta,
	b.ie_probabilidade_alta,
	b.dt_alta,
	b.dt_alta_medico,
	b.dt_previsto_alta,
	b.nm_usuario_atend,
	b.ie_carater_inter_sus,
	b.ie_tipo_atend_tiss,
	b.dt_entrada,
	a.ds_observacao,
	a.dt_periodo_inicial,
	a.dt_periodo_final,
	a.ie_tipo_guia
from	atendimento_paciente b,
	conta_paciente a
where	a.nr_atendimento = b.nr_atendimento
and	((ie_filtrar_estab_atend_p = 'N') or (ie_filtrar_estab_atend_p = 'S' AND b.cd_estabelecimento = cd_estabelecimento_p))
and	((((a.cd_estabelecimento)::numeric  = cd_estabelecimento_p) and (ie_filtrar_estab_conta_p = 'S'))
	or (ie_filtrar_estab_conta_p = 'N'))
and	((ie_contas_protocolo_p = 'A')
	or	((coalesce(a.nr_seq_protocolo::text, '') = '') and (ie_contas_protocolo_p = 'S'))
	or	(a.nr_seq_protocolo IS NOT NULL AND a.nr_seq_protocolo::text <> '' AND ie_contas_protocolo_p = 'C'))
and	((ie_data_p = 'E' AND b.dt_entrada >= dt_inicial_p and b.dt_entrada <= dt_final_p)
	or	(ie_data_p = 'A' AND b.dt_alta >= dt_inicial_p and b.dt_alta <= dt_final_p)
	or	(ie_data_p = 'R' AND a.dt_mesano_referencia between dt_inicial_w and dt_final_w)
	or	((ie_data_p = 'P') and (obter_se_eis_etapa(a.nr_interno_conta,dt_inicial_p,dt_final_p,cd_etapas_p,ie_etapa_conta_w) = 'S'))
	or	(ie_data_p = 'G' AND a.dt_entrada_tiss >= dt_inicial_p and a.dt_entrada_tiss <= dt_final_p)
	or	(ie_data_p = 'F' AND a.dt_periodo_final >= dt_inicial_p and a.dt_periodo_final <= dt_final_p)
	or	(ie_data_p = 'I' AND a.dt_periodo_inicial >= dt_inicial_p and dt_periodo_inicial <= dt_final_p)
	or	((ie_data_p = 'X') and exists (
					SELECT	1
					from	procedimento_paciente p
					where	p.nr_interno_conta = a.nr_interno_conta
					and	coalesce(p.cd_motivo_exc_conta::text, '') = ''
					and	p.dt_procedimento >= dt_inicial_p and p.dt_procedimento <= dt_final_p
					
union

					select	1
					from	material_atend_paciente m
					where	m.nr_interno_conta = a.nr_interno_conta
					and	coalesce(m.cd_motivo_exc_conta::text, '') = ''
					and	m.dt_atendimento >= dt_inicial_p and m.dt_atendimento <= dt_final_p))
	or	((coalesce(dt_inicial_p::text, '') = '') or (coalesce(dt_final_p::text, '') = '')))
and	((coalesce(cd_convenios_p::text, '') = '') or ((cd_convenios_p IS NOT NULL AND cd_convenios_p::text <> '') and (obter_se_contido(a.cd_convenio_parametro,substr(cd_convenios_p,2,length(cd_convenios_p))) = substr(cd_convenios_p,1,1))))
/* Recolocada esta linha acima por um problema de performance OS212150 Geliard*/

and	((ie_pac_alta_p = 'C' AND b.dt_alta IS NOT NULL AND b.dt_alta::text <> '')
	or	((ie_pac_alta_p = 'S') and (coalesce(b.dt_alta::text, '') = ''))
	or (ie_pac_alta_p = 'A'))
and	(((ie_contas_canceladas_p = 'S') and (coalesce(a.ie_cancelamento::text, '') = ''))
	or	(ie_contas_canceladas_p = 'C' AND a.ie_cancelamento IS NOT NULL AND a.ie_cancelamento::text <> '')
	or (ie_contas_canceladas_p = 'A'))
and	((coalesce(cd_setor_valor_p::text, '') = '') or
	((cd_setor_valor_p IS NOT NULL AND cd_setor_valor_p::text <> '') and
	exists (select	1
		from	conta_paciente_mat_proc_v s
		where	s.nr_interno_conta 	= a.nr_interno_conta
		and	obter_se_contido(s.cd_setor_atendimento,substr(cd_setor_valor_p,2,length(cd_setor_valor_p))) = substr(cd_setor_valor_p,1,1))))
and (a.nr_atendimento = coalesce(nr_atendimento_p,a.nr_atendimento))
and	((coalesce(nr_seq_protocolo_p::text, '') = '') or (a.nr_seq_protocolo = nr_seq_protocolo_p))
order by	b.cd_pessoa_fisica;

type 		fetch_array is table of c01%rowtype;
s_array 	fetch_array;
i		integer := 1;
type vetor is table of fetch_array index by integer;
vetor_c01_w			vetor;

BEGIN

CALL exec_sql_dinamico('Tasy','Truncate table w_eis_conta_pendente');

/*delete from w_eis_conta_pendente a where a.nm_usuario = nm_usuario_p;
commit;*/
dt_inicial_w		:= trunc(dt_inicial_p,'month');
dt_final_w		:= last_day(fim_dia(dt_final_p));
ie_todas_pf_etapa_w	:= coalesce(obter_valor_param_usuario(1121, 31, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p),'U');
ie_setor_atend_conta_w	:= coalesce(obter_valor_param_usuario(1121, 33, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p),'N');
ie_usuario_atend_w		:= coalesce(obter_valor_param_usuario(1121, 39, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p),'N');
ie_somente_proc_conta_w		:= coalesce(obter_valor_param_usuario(1121, 40, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p),'N');

if (coalesce(ie_etapa_conta_p,'0') = '0') then
	ie_etapa_conta_w := coalesce(obter_valor_param_usuario(1121, 3, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p),'U');
else
	ie_etapa_conta_w := ie_etapa_conta_p;
end if;

open c01;
loop
fetch c01 bulk collect into s_array limit 1000;
	vetor_c01_w(i) := s_array;
	i := i + 1;
EXIT WHEN NOT FOUND; /* apply on c01 */
end loop;
close c01;

for i in 1..vetor_c01_w.count loop
	s_array := vetor_c01_w(i);
	for z in 1..s_array.count loop
	begin

	nr_atendimento_w		:= s_array[z].nr_atendimento;

	begin
	select	/*+ index (a atecaco_i3) */		cd_usuario_convenio,
		cd_senha,
		ie_tipo_guia,
		cd_empresa
	into STRICT	cd_usuario_convenio_w,
		cd_senha_w,
		ie_tipo_guia_atend_w,
		cd_empresa_w
	from	atend_categoria_convenio
	where	nr_seq_interno	= obter_atecaco_atendimento(nr_atendimento_w);
	exception
		when others then
			cd_usuario_convenio_w	:= null;
			cd_senha_w		:= null;
			ie_tipo_guia_atend_w	:= null;
			cd_empresa_w		:= null;
	end;

	cd_setor_atual_w		:= Obter_Unidade_Atendimento(nr_atendimento_w,'IA','CS');

	select 	max(ds_setor_atendimento),
		coalesce(max(nr_seq_agrupamento),0)
	into STRICT	ds_setor_atual_w,
		nr_seq_agrup_atual_w
	from 	setor_atendimento
	where 	cd_setor_atendimento = cd_setor_atual_w;

	ds_agrup_setor_atual_w:= '';
	if (nr_seq_agrup_atual_w > 0) then
		select	max(ds_agrupamento)
		into STRICT	ds_agrup_setor_atual_w
		from	agrupamento_setor
		where	nr_sequencia = nr_seq_agrup_atual_w;
	end if;


	nr_interno_conta_w		:= s_array[z].nr_interno_conta;
	cd_estabelecimento_w		:= s_array[z].cd_estabelecimento;
	nm_estabelecimento_w		:= obter_nome_estabelecimento(cd_estabelecimento_w);

	cd_convenio_w			:= s_array[z].cd_convenio_parametro;

	select 	max(ds_convenio)
	into STRICT	ds_convenio_w
	from 	convenio
	where 	cd_convenio = cd_convenio_w;

	cd_categoria_convenio_w		:= s_array[z].cd_categoria_parametro;
	ds_categ_conv_w			:= null;


	if (cd_convenio_w IS NOT NULL AND cd_convenio_w::text <> '') and (cd_categoria_convenio_w IS NOT NULL AND cd_categoria_convenio_w::text <> '') then

		select	max(ds_categoria)
		into STRICT	ds_categ_conv_w
		from	categoria_convenio
		where	cd_convenio	= cd_convenio_w
		and	cd_categoria	= cd_categoria_convenio_w;

	end if;

	cd_pessoa_fisica_w		:= s_array[z].cd_pessoa_fisica;

	select 	max(nm_pessoa_fisica)
	into STRICT	nm_pessoa_fisica_w
	from 	pessoa_fisica
	where 	cd_pessoa_fisica = cd_pessoa_fisica_w;

	if (coalesce(ie_usuario_atend_w,'N') = 'S') and (upper(s_array[z].nm_usuario) = 'TASY') then
		nm_usuario_w		:= s_array[z].nm_usuario_atend;
	else
		nm_usuario_w		:= s_array[z].nm_usuario;
	end if;

	cd_medico_exec_w		:= s_array[z].cd_medico_resp;

	select 	max(nm_pessoa_fisica)
	into STRICT	nm_medico_exec_w
	from 	pessoa_fisica
	where 	cd_pessoa_fisica = cd_medico_exec_w;

	ie_tipo_atendimento_w		:= s_array[z].ie_tipo_atendimento;

	ds_tipo_atendimento_w:= 'Internado';
	if (ie_tipo_atendimento_w = 1) then
		ds_tipo_atendimento_w:= 'Internado';
	elsif (ie_tipo_atendimento_w = 3) then
		ds_tipo_atendimento_w:= 'Pronto Socorro';
	elsif (ie_tipo_atendimento_w = 7) then
		ds_tipo_atendimento_w:= 'Externo';
	elsif (ie_tipo_atendimento_w = 8) then
		ds_tipo_atendimento_w:= 'Ambulatorial';
	end if;

	ie_status_conta_w		:= s_array[z].ie_status_acerto;

	ds_status_conta_w:= 'Provisório';
	if (ie_status_conta_w = 2) then
		ds_status_conta_w:= 'Definitivo';
	end if;

	nr_seq_protocolo_w		:= s_array[z].nr_seq_protocolo;
	dt_conta_protocolo_w		:= s_array[z].dt_conta_protocolo;
	dt_prev_protocolo_w		:= s_array[z].dt_prev_protocolo;
	cd_procedencia_w		:= s_array[z].cd_procedencia;

	select	max(ds_procedencia)
	into STRICT	ds_proced_atend_w
	from	procedencia
	where	cd_procedencia	= cd_procedencia_w;

	ie_tipo_atend_conta_w		:= s_array[z].ie_tipo_atend_conta;
	cd_motivo_alta_w		:= s_array[z].cd_motivo_alta;

	ie_tipo_protocolo_w		:= null;
	if (coalesce(nr_seq_protocolo_w,0) > 0) then
		select 	max(ie_tipo_protocolo)
		into STRICT	ie_tipo_protocolo_w
		from 	protocolo_convenio
		where 	nr_seq_protocolo = nr_seq_protocolo_w;
	end if;

	cd_responsavel_w		:= s_array[z].cd_responsavel;
	nr_atend_original_w		:= s_array[z].nr_atend_original;
	ie_clinica_w			:= s_array[z].ie_clinica;
	nr_seq_estagio_conta_w		:= s_array[z].nr_seq_estagio_conta;
	ie_probabilidade_alta_w		:= s_array[z].ie_probabilidade_alta;
	dt_alta_w			:= s_array[z].dt_alta;

	qt_dias_atraso_atend_w		:= Obter_Dias_Entre_Datas(dt_alta_w,clock_timestamp());
	qt_dif_datas_alta_prot_w	:= Obter_Dias_Entre_Datas(dt_conta_protocolo_w, dt_alta_w);

	dt_alta_medico_w		:= s_array[z].dt_alta_medico;
	dt_previsto_alta_w		:= s_array[z].dt_previsto_alta;
	nm_usuario_recep_atend_w	:= s_array[z].nm_usuario_atend;
	ie_carater_inter_sus_w		:= s_array[z].ie_carater_inter_sus;
	ie_tipo_atend_tiss_w		:= s_array[z].ie_tipo_atend_tiss;
	dt_entrada_w			:= s_array[z].dt_entrada;
	ds_obs_conta_w			:= s_array[z].ds_observacao;
	dt_periodo_ini_conta_w		:= s_array[z].dt_periodo_inicial;
	dt_periodo_fim_conta_w		:= s_array[z].dt_periodo_final;
	ie_tipo_guia_w			:= s_array[z].ie_tipo_guia;

	ds_tipo_guia_cta_w		:= null;
	if (ie_tipo_guia_w IS NOT NULL AND ie_tipo_guia_w::text <> '') then
		ds_tipo_guia_cta_w	:= obter_valor_dominio(1031,ie_tipo_guia_w);
	end if;

	ds_tipo_guia_atend_w		:= null;
	if (ie_tipo_guia_atend_w IS NOT NULL AND ie_tipo_guia_atend_w::text <> '') then
		ds_tipo_guia_atend_w	:= obter_valor_dominio(1031,ie_tipo_guia_atend_w);
	end if;

	ie_insere_w		:= 'S';

	/* verificação se tem ou não título */

	if (ie_titulo_p = 'C') then
		begin
		if (ie_situacao_titulo_p IS NOT NULL AND ie_situacao_titulo_p::text <> '') then
			begin
			select	'S'
			into STRICT	ie_insere_w
			
			where	exists (SELECT	1
					from	titulo_receber y
					where	y.nr_interno_conta 	= nr_interno_conta_w
					and (obter_se_contido_char(y.ie_situacao,substr(ie_situacao_titulo_p,2,length(ie_situacao_titulo_p))) = substr(ie_situacao_titulo_p,1,1))
					
union

					SELECT	1
					from	titulo_receber y
					where	y.nr_seq_protocolo	= nr_seq_protocolo_w
					and (obter_se_contido_char(y.ie_situacao,substr(ie_situacao_titulo_p,2,length(ie_situacao_titulo_p))) = substr(ie_situacao_titulo_p,1,1)));
			exception
				when others then
				ie_insere_w	:= 'N';
				goto final;
			end;
		else
			begin
			select	'S'
			into STRICT	ie_insere_w
			
			where	exists (SELECT	1
					from	titulo_receber y
					where	y.nr_interno_conta 	= nr_interno_conta_w
					
union

					SELECT	1
					from	titulo_receber y
					where	y.nr_seq_protocolo	= nr_seq_protocolo_w );
			exception
				when others then
				ie_insere_w	:= 'N';
				goto final;
			end;
		end if;
		end;
	elsif (ie_titulo_p = 'S') then
		begin
		select	'S'
		into STRICT	ie_insere_w
		
		where	not exists (	SELECT	1
					from	titulo_receber y
					where	y.nr_interno_conta = nr_interno_conta_w
					
union

					SELECT	1
					from	titulo_receber y
					where	y.nr_seq_protocolo	= nr_seq_protocolo_w );
		exception
			when others then
			ie_insere_w	:= 'N';
			goto final;
		end;
	elsif (ie_titulo_p = 'A') and (ie_situacao_titulo_p IS NOT NULL AND ie_situacao_titulo_p::text <> '') then
		begin
		select	'S'
		into STRICT	ie_insere_w
		
		where	((exists (	SELECT	1
					from	titulo_receber y
					where	y.nr_interno_conta 	= nr_interno_conta_w
					and (obter_se_contido_char(y.ie_situacao,substr(ie_situacao_titulo_p,2,length(ie_situacao_titulo_p))) = substr(ie_situacao_titulo_p,1,1))
					
union

					SELECT	1
					from	titulo_receber y
					where	y.nr_seq_protocolo	= nr_seq_protocolo_w
					and (obter_se_contido_char(y.ie_situacao,substr(ie_situacao_titulo_p,2,length(ie_situacao_titulo_p))) = substr(ie_situacao_titulo_p,1,1))))
			or (not exists (select	1
					from	titulo_receber y
					where	y.nr_interno_conta = nr_interno_conta_w
					
union

					select	1
					from	titulo_receber y
					where	y.nr_seq_protocolo	= nr_seq_protocolo_w)));
		exception
			when others then
			ie_insere_w	:= 'N';
			goto final;
		end;
	end if;

	/* verificação se tem ou não nota fiscal */

	if (ie_nota_fiscal_p = 'C') then
		begin
		select	'S'
		into STRICT	ie_insere_w
		
		where	exists (SELECT	1
				from	nota_fiscal nf
				where	nf.nr_interno_conta = nr_interno_conta_w
				
union

				SELECT	1
				from	nota_fiscal nf
				where	nf.nr_seq_protocolo	= nr_seq_protocolo_w
				
union

				select	1
				from	nota_fiscal nf,
					lote_protocolo lp,
					protocolo_convenio pc
				where	nf.nr_seq_lote_prot 	= lp.nr_sequencia
				and	lp.nr_sequencia 	= pc.nr_seq_lote_protocolo
				and	pc.nr_seq_protocolo	= nr_seq_protocolo_w);
		exception
			when others then
			ie_insere_w	:= 'N';
			goto final;
		end;
	elsif (ie_nota_fiscal_p = 'S') then
		begin
		select	'S'
		into STRICT	ie_insere_w
		
		where	not exists (	SELECT	1
					from	nota_fiscal nf
					where	nf.nr_interno_conta = nr_interno_conta_w
					
union

					SELECT	1
					from	nota_fiscal nf
					where	nf.nr_seq_protocolo	= nr_seq_protocolo_w
					
union

					select	1
					from	nota_fiscal nf,
						lote_protocolo lp,
						protocolo_convenio pc
					where	nf.nr_seq_lote_prot 	= lp.nr_sequencia
					and	lp.nr_sequencia 	= pc.nr_seq_lote_protocolo
					and	pc.nr_seq_protocolo	= nr_seq_protocolo_w);
		exception
			when others then
			ie_insere_w	:= 'N';
			goto final;
		end;
	end if;

	/* verifica se o paciente está internado ou não */

	if (ie_pac_internado_p = 'S') then
		begin
		select	count(1)
		into STRICT	qt_unidade_atendimento_w
		from	unidade_atendimento u
		where	u.nr_atendimento = nr_atendimento_w  LIMIT 1;

		select	'S'
		into STRICT	ie_insere_w
		
		where	qt_unidade_atendimento_w = 0;
		exception
			when others then
			ie_insere_w	:= 'N';
			goto final;
		end;
	end if;

	/* verifica se tem ou não aih */

	if (ie_com_aih_p = 'C') then
		begin
		select	'S'
		into STRICT	ie_insere_w
		
		where	exists (SELECT	1
				 from	sus_aih s
				 where	s.nr_atendimento	= nr_atendimento_w
				 and	s.nr_interno_conta	= nr_interno_conta_w
				
union

				 SELECT	1
				 from	sus_aih_unif u
				 where	u.nr_atendimento	= nr_atendimento_w
				 and	u.nr_interno_conta	= nr_interno_conta_w);
		exception
			when others then
			ie_insere_w	:= 'N';
			goto final;
		end;
	elsif (ie_com_aih_p = 'S') then
		begin
		select	'S'
		into STRICT	ie_insere_w
		
		where	not exists (SELECT	1
				 	 from	sus_aih s
				 	 where	s.nr_atendimento	= nr_atendimento_w
				 	 and	s.nr_interno_conta	= nr_interno_conta_w
					
union

				 	 SELECT	1
					 from	sus_aih_unif u
					 where	u.nr_atendimento	= nr_atendimento_w
					 and	u.nr_interno_conta	= nr_interno_conta_w);
		exception
			when others then
			ie_insere_w	:= 'N';
			goto final;
		end;
	end if;

	/* verifica se tem ou não aih */

	if (ie_com_apac_p = 'C') then
		begin
		select	'S'
		into STRICT	ie_insere_w
		
		where	exists (SELECT	1
				 from	sus_apac_movto s
				 where	s.nr_atendimento	= nr_atendimento_w
				 and	s.nr_interno_conta	= nr_interno_conta_w
				
union

				 SELECT	1
				 from	sus_apac_unif u
				 where	u.nr_atendimento	= nr_atendimento_w
				 and	u.nr_interno_conta	= nr_interno_conta_w);
		exception
			when others then
			ie_insere_w	:= 'N';
			goto final;
		end;
	elsif (ie_com_apac_p = 'S') then
		begin
		select	'S'
		into STRICT	ie_insere_w
		
		where	not exists (SELECT	1
				 	 from	sus_apac_movto s
				 	 where	s.nr_atendimento	= nr_atendimento_w
				 	 and	s.nr_interno_conta	= nr_interno_conta_w
					
union

				 	 SELECT	1
					 from	sus_apac_unif u
					 where	u.nr_atendimento	= nr_atendimento_w
					 and	u.nr_interno_conta	= nr_interno_conta_w);
		exception
			when others then
			ie_insere_w	:= 'N';
			goto final;
		end;
	end if;

	/* busca somente contas sem etapa informada */

	if (ie_conta_sem_etapa_p = 'S') then
		begin
		select	'S'
		into STRICT	ie_insere_w
		
		where	not exists (	SELECT	1
					from	conta_paciente_etapa cp
					where	cp.nr_interno_conta = nr_interno_conta_w);
		exception
			when others then
			ie_insere_w	:= 'N';
			goto final;
		end;
	end if;

	/* busca somente contas com etapa em aberto */

	if (ie_conta_etapa_pend_p = 'S') then
		begin
		select	'S'
		into STRICT	ie_insere_w
		
		where	exists (	SELECT	1
					from	conta_paciente_etapa cp
					where	cp.nr_interno_conta = nr_interno_conta_w
					and	coalesce(cp.dt_fim_etapa::text, '') = '');
		exception
			when others then
			ie_insere_w	:= 'N';
			goto final;
		end;
	end if;

	/* obter setor atual */

	if	((ie_setor_atual_p = 'S') or (ie_lanc_setor_p = 'S')) then
		select	max(coalesce(a.cd_setor_atendimento,0)),
			max(a.ds_setor_atendimento),
			max(a.nr_seq_agrupamento)
		into STRICT	cd_setor_atendimento_w,
			ds_setor_atendimento_w,
			nr_seq_agrupamento_w
		from	atend_paciente_unidade b,
			setor_atendimento a
		where	a.cd_setor_atendimento = b.cd_setor_atendimento
		and	obter_atepacu_paciente(nr_atendimento_w,'A') = b.nr_seq_interno
		and	b.nr_atendimento	= nr_atendimento_w;

		ds_agrup_setor_w:= '';
		if (nr_seq_agrupamento_w > 0) then
			select	max(ds_agrupamento)
			into STRICT	ds_agrup_setor_w
			from	agrupamento_setor
			where	nr_sequencia = nr_seq_agrupamento_w;
		end if;
	end if;

	/* obter guia conta */

	if (ie_guias_conta_p = 'S') then
		select	max(coalesce(cd_autorizacao,0))
		into STRICT	cd_guia_w
		from	conta_paciente_guia
		where	nr_interno_conta = nr_interno_conta_w;
	end if;

	/* informações das etapas */

	SELECT * FROM obter_dados_eis_etapa_conta(	nr_interno_conta_w, nr_seq_etapa_w, ds_etapa_conta_obs_w, ie_etapa_muda_status_w, cd_setor_etapa_w, cd_pessoa_etapa_w, ds_etapa_w, cd_motivo_devol_etapa_w, dt_ultima_etapa_w, nm_ultimo_usuario_w, nm_ultimo_usu_receb_w, nr_seq_classif_etapa_w) INTO STRICT nr_seq_etapa_w, ds_etapa_conta_obs_w, ie_etapa_muda_status_w, cd_setor_etapa_w, cd_pessoa_etapa_w, ds_etapa_w, cd_motivo_devol_etapa_w, dt_ultima_etapa_w, nm_ultimo_usuario_w, nm_ultimo_usu_receb_w, nr_seq_classif_etapa_w;

	cd_pessoa_etapa_ww:= cd_pessoa_etapa_w;
	nm_pessoa_etapa_w := null;

	if (cd_pessoa_etapa_ww IS NOT NULL AND cd_pessoa_etapa_ww::text <> '') then
		select 	max(nm_pessoa_fisica)
		into STRICT	nm_pessoa_etapa_w
		from 	pessoa_fisica
		where 	cd_pessoa_fisica = cd_pessoa_etapa_ww;
	end if;

	select 	max(ds_setor_atendimento)
	into STRICT	ds_setor_etapa_w
	from 	setor_atendimento
	where 	cd_setor_atendimento = cd_setor_etapa_w;

	select	max(ds_classificacao) ds
	into STRICT	ds_classif_etapa_w
	from	classif_etapa
	where	nr_sequencia = nr_seq_classif_etapa_w;

	ds_motivo_devol_w:= null;

	if (cd_motivo_devol_etapa_w IS NOT NULL AND cd_motivo_devol_etapa_w::text <> '') then

		nr_seq_motivo_devol_etapa_w:= (cd_motivo_devol_etapa_w)::numeric;
		select 	max(ds_motivo_devolucao)
		into STRICT	ds_motivo_devol_w
		from 	fatur_motivo_devol
		where 	nr_sequencia = cd_motivo_devol_etapa_w;
	end if;

	begin
	ds_usuario_receb_etapa_w:= '';
	if (coalesce(nm_ultimo_usuario_w,'X') <> 'X') then
		select	ds_usuario
		into STRICT	ds_ultimo_usuario_w
		from	usuario
		where	nm_usuario = nm_ultimo_usuario_w;
	end if;
	exception
	when others then
		ds_ultimo_usuario_w := nm_ultimo_usuario_w;
	end;

	ie_etapa_recebida_w := 'N';
	if (coalesce(nm_ultimo_usu_receb_w,'X') <> 'X') then
		ie_etapa_recebida_w := 'S';
	end if;

	begin
	if (coalesce(nm_ultimo_usu_receb_w,'X') <> 'X') then
		select	ds_usuario
		into STRICT	ds_usuario_receb_etapa_w
		from	usuario
		where	nm_usuario = nm_ultimo_usu_receb_w;
	end if;
	exception
	when others then
		ds_usuario_receb_etapa_w := nm_ultimo_usu_receb_w;
	end;

	if (coalesce(ie_ult_etapa_receb_p,'A') <> 'A') and (coalesce(ie_ult_etapa_receb_p,'A') <> ie_etapa_recebida_w) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	/* OS 521818 */

	cd_setor_inicial_w:= 0;
	nr_seq_atepacu_w:=  obter_atepacu_paciente(nr_atendimento_w, 'P');
	ds_setor_inicial_w:= null;
	if (coalesce(nr_seq_atepacu_w,0) > 0) then
		select 	coalesce(max(cd_setor_atendimento),0)
		into STRICT	cd_setor_inicial_w
		from 	atend_paciente_unidade
		where 	nr_atendimento = nr_atendimento_w
		and 	nr_seq_interno = nr_seq_atepacu_w;

		select 	max(ds_setor_atendimento)
		into STRICT	ds_setor_inicial_w
		from 	setor_atendimento
		where 	cd_setor_atendimento = cd_setor_inicial_w;
	end if;

	/* obter o setor inicial da entrada unica */

	if (cd_setor_inicial_p IS NOT NULL AND cd_setor_inicial_p::text <> '') and (obter_se_contido(cd_setor_inicial_w, substr(cd_setor_inicial_p,2,length(cd_setor_inicial_p))) <> substr(cd_setor_inicial_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	/* setor paciente */

	if (ie_setor_pac_p = 'S') then

		if (nr_atendimento_w <> nr_atendimento_ww) then
			begin
			cd_setor_destino_w	:= obter_setor_destino_prot_doc(nr_atendimento_w);
			nr_atendimento_ww	:= nr_atendimento_w;
			end;
		end if;

		select	substr(max(a.cd_unidade_basica) || ' ' || max(a.cd_unidade_compl),1,20)
		into STRICT	cd_unidade_pac_w
		from	atend_paciente_unidade a,
			setor_atendimento b
		where	a.nr_atendimento = nr_atendimento_w
		and	a.cd_setor_atendimento = b.cd_setor_atendimento
		and	obter_atepacu_paciente(nr_atendimento_w,'A')	= a.nr_seq_interno;

		if (cd_setor_destino_w = 0) then /* caso não tenha setor o valor retornado pela funciton é 0, e isto causa uma violação de integridade com a setor atendimento, por este motivo a variável rece null quando for igual a zero */
			cd_setor_destino_w := null;
		end if;

		select 	max(ds_setor_atendimento)
		into STRICT	ds_setor_destino_w
		from 	setor_atendimento
		where 	cd_setor_atendimento = cd_setor_destino_w;

	end if;

	if (nm_usuario_etapa_p IS NOT NULL AND nm_usuario_etapa_p::text <> '') and (obter_se_contido(cd_pessoa_etapa_w, substr(nm_usuario_etapa_p,2,length(nm_usuario_etapa_p))) <> substr(nm_usuario_etapa_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	if (nm_usuario_recebimento_p IS NOT NULL AND nm_usuario_recebimento_p::text <> '') and (obter_se_contido_char(nm_ultimo_usu_receb_w,substr(nm_usuario_recebimento_p,2,length(nm_usuario_recebimento_p))) <> substr(nm_usuario_recebimento_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	if (cd_categorias_p IS NOT NULL AND cd_categorias_p::text <> '') and (obter_se_contido_char(replace(cd_convenio_w||cd_categoria_convenio_w,' ',''),replace(substr(cd_categorias_p,2,length(cd_categorias_p)),' ','')) <> substr(cd_categorias_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	if (ie_tipos_atendimento_p IS NOT NULL AND ie_tipos_atendimento_p::text <> '') and (obter_se_contido(ie_tipo_atendimento_w, substr(ie_tipos_atendimento_p,2,length(ie_tipos_atendimento_p))) <> substr(ie_tipos_atendimento_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	if (ie_tipos_convenio_p IS NOT NULL AND ie_tipos_convenio_p::text <> '') and (obter_se_contido(obter_tipo_convenio(cd_convenio_w), substr(ie_tipos_convenio_p,2,length(ie_tipos_convenio_p))) <> substr(ie_tipos_convenio_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	if (ie_status_conta_p IS NOT NULL AND ie_status_conta_p::text <> '') and (obter_se_contido(ie_status_conta_w, substr(ie_status_conta_p,2,length(ie_status_conta_p))) <> substr(ie_status_conta_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	if (ie_status_protocolo_p IS NOT NULL AND ie_status_protocolo_p::text <> '') and (nr_seq_protocolo_w IS NOT NULL AND nr_seq_protocolo_w::text <> '') and (obter_se_contido(obter_status_protocolo(nr_seq_protocolo_w), substr(ie_status_protocolo_p,2,length(ie_status_protocolo_p))) <> substr(ie_status_protocolo_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	if (cd_municipio_p IS NOT NULL AND cd_municipio_p::text <> '') and (obter_se_contido(obter_municipio_atend_conv(nr_atendimento_w, cd_convenio_w, cd_categoria_convenio_w, 'C'), substr(cd_municipio_p,2,length(cd_municipio_p))) <> substr(cd_municipio_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	if (cd_classif_setor_p IS NOT NULL AND cd_classif_setor_p::text <> '') and (cd_setor_atendimento_w IS NOT NULL AND cd_setor_atendimento_w::text <> '') and (obter_se_contido(obter_classif_setor(cd_setor_atendimento_w), substr(cd_classif_setor_p,2,length(cd_classif_setor_p))) <> substr(cd_classif_setor_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	if (cd_motivo_alta_p IS NOT NULL AND cd_motivo_alta_p::text <> '') and (obter_se_contido(cd_motivo_alta_w, substr(cd_motivo_alta_p,2,length(cd_motivo_alta_p))) <> substr(cd_motivo_alta_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	if (ie_tipo_protocolo_p IS NOT NULL AND ie_tipo_protocolo_p::text <> '') and (obter_se_contido(ie_tipo_protocolo_w, substr(ie_tipo_protocolo_p,2,length(ie_tipo_protocolo_p))) <> substr(ie_tipo_protocolo_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	if (cd_responsavel_conta_p IS NOT NULL AND cd_responsavel_conta_p::text <> '') and (obter_se_contido(cd_responsavel_w,substr(cd_responsavel_conta_p,2,length(cd_responsavel_conta_p))) <> substr(cd_responsavel_conta_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	if (cd_estab_conta_p IS NOT NULL AND cd_estab_conta_p::text <> '') and (obter_se_contido(cd_estabelecimento_w,substr(cd_estab_conta_p,2,length(cd_estab_conta_p))) <> substr(cd_estab_conta_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	if (ie_clinicas_p IS NOT NULL AND ie_clinicas_p::text <> '') and (obter_se_contido(ie_clinica_w,substr(ie_clinicas_p,2,length(ie_clinicas_p))) <> substr(ie_clinicas_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	if (cd_procedencia_p IS NOT NULL AND cd_procedencia_p::text <> '') and (obter_se_contido(cd_procedencia_w,substr(cd_procedencia_p,2,length(cd_procedencia_p))) <> substr(cd_procedencia_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	if	(((ie_retornos_p = 'C') and (coalesce(nr_atend_original_w::text, '') = '')) or
		(ie_retornos_p = 'S' AND nr_atend_original_w IS NOT NULL AND nr_atend_original_w::text <> '')) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	if (cd_etapas_p IS NOT NULL AND cd_etapas_p::text <> '') then
		ie_sem_etapa_w := obter_se_contido_char('00', substr(cd_etapas_p,2,length(cd_etapas_p)));
		if (ie_sem_etapa_w = 'S') then
			begin
			select	'S'
			into STRICT	ie_insere_w
			
			where	not exists (	SELECT	1
						from	conta_paciente_etapa cp
						where	cp.nr_interno_conta = nr_interno_conta_w);
			exception
				when others then
				ie_insere_w	:= 'N';
			end;
		end if;

		if	((ie_insere_w = 'N' AND ie_sem_etapa_w = 'S') or (ie_sem_etapa_w = 'N')) then
			begin

			if (ie_etapa_conta_w = 'U') then
				begin
				select	'S'
				into STRICT	ie_insere_w
				
				where	obter_se_contido(obter_eis_etapa_conta(nr_interno_conta_w,'C'), substr(cd_etapas_p,2,length(cd_etapas_p))) = substr(cd_etapas_p,1,1);
				exception
					when others then
					ie_insere_w	:= 'N';
					goto final;
				end;
			elsif (ie_etapa_conta_w = 'T') then
				begin

				select	coalesce(max('S'),'N')
				into STRICT	ie_insere_w
				from	fatur_etapa b,
					conta_paciente_etapa a
				where	a.nr_seq_etapa		= b.nr_sequencia
				and	a.nr_interno_conta	= nr_interno_conta_w
				and	coalesce(b.ie_situacao,'A')	= 'A'
				and	((ie_conta_etapa_pend_p = 'S' and coalesce(a.dt_fim_etapa::text, '') = '') or (ie_conta_etapa_pend_p = 'N'))
				and	((coalesce(cd_setores_etapa_p::text, '') = '') or (obter_se_contido(a.cd_setor_atendimento, substr(cd_setores_etapa_p,2,length(cd_setores_etapa_p))) = substr(cd_setores_etapa_p,1,1)))
				and	((coalesce(cd_pessoas_etapa_p::text, '') = '') or (obter_se_contido(a.cd_pessoa_fisica, substr(cd_pessoas_etapa_p,2,length(cd_pessoas_etapa_p))) = substr(cd_pessoas_etapa_p,1,1)))
				and	((ie_data_p <> 'P') or (a.dt_etapa between coalesce(dt_inicial_p,a.dt_etapa) and coalesce(dt_final_p,a.dt_etapa)))
				and	obter_se_contido(a.nr_seq_etapa, substr(cd_etapas_p,2,length(cd_etapas_p))) = substr(cd_etapas_p,1,1);

				if (ie_insere_w = 'N') then
					goto final;
				end if;

				exception
					when others then
					ie_insere_w	:= 'N';
					goto final;
				end;
			elsif (ie_etapa_conta_w = 'P') then
				begin
				select	min(a.nr_seq_etapa)
				into STRICT	nr_seq_etapa_conta_w
				from	fatur_etapa b,
					conta_paciente_etapa a
				where	b.nr_sequencia		= a.nr_seq_etapa
				and	coalesce(b.ie_situacao,'A')	= 'A'
				and	a.nr_interno_conta	= nr_interno_conta_w
				and	a.dt_etapa		= (	SELECT	min(x.dt_etapa)
									from	conta_paciente_etapa x
									where	x.nr_interno_conta = a.nr_interno_conta);

				if (obter_se_contido(nr_seq_etapa_conta_w, substr(cd_etapas_p,2,length(cd_etapas_p))) <> substr(cd_etapas_p,1,1)) then
					ie_insere_w	:= 'N';
					goto final;
				end if;
				end;
			elsif (ie_etapa_conta_w = 'O') then
				begin
				select	'S'
				into STRICT	ie_insere_w
				from	fatur_etapa b,
					conta_paciente_etapa a
				where	b.nr_sequencia		= a.nr_seq_etapa
				and	coalesce(b.ie_situacao,'A')	= 'A'
				and	a.nr_interno_conta	= nr_interno_conta_w
				and	obter_se_contido(a.nr_seq_etapa, substr(cd_etapas_p,2,length(cd_etapas_p))) = substr(cd_etapas_p,1,1)  LIMIT 1;
				exception
				when others then
					ie_insere_w	:= 'N';
					goto final;
				end;
			elsif (ie_etapa_conta_w = 'M') then
				begin

				select	max(x.nr_sequencia)
				into STRICT	nr_seq_etapa_conta_w
				from	fatur_etapa x,
						conta_paciente_etapa a
				where	x.nr_sequencia  = a.nr_seq_etapa
				and		coalesce(x.ie_situacao,'A') = 'A'
				and		a.nr_interno_conta = nr_interno_conta_w
				and		x.nr_seq_etapa = (	SELECT	max(obter_seq_etapa(a.nr_seq_etapa))
    										from	fatur_etapa b,
													conta_paciente_etapa a
    										where	b.nr_sequencia  = a.nr_seq_etapa
    										and		coalesce(b.ie_situacao,'A') = 'A'
    										and		a.nr_interno_conta = nr_interno_conta_w);

				if (obter_se_contido(nr_seq_etapa_conta_w, substr(cd_etapas_p,2,length(cd_etapas_p))) <> substr(cd_etapas_p,1,1)) then
					ie_insere_w	:= 'N';
					goto final;
				end if;
				end;
			end if;
			end;
		end if;
	end if;


	if (cd_medicos_p IS NOT NULL AND cd_medicos_p::text <> '') and (obter_se_contido(cd_medico_exec_w, substr(cd_medicos_p,2,length(cd_medicos_p))) <> substr(cd_medicos_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	if (cd_setores_p IS NOT NULL AND cd_setores_p::text <> '') and (obter_se_contido(cd_setor_atendimento_w, substr(cd_setores_p,2,length(cd_setores_p))) <> substr(cd_setores_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	if (ie_lanc_setor_p = 'S') and (cd_setores_p IS NOT NULL AND cd_setores_p::text <> '') then
		if (ie_setor_atend_conta_w = 'S') then
			begin
			select	a.ie_contem
			into STRICT	ie_insere_w
			from (SELECT	'S' ie_contem
				 from	procedimento_paciente
				 where	nr_interno_conta = nr_interno_conta_w
				 and	obter_se_contido(cd_setor_atendimento, substr(cd_setores_p,2,length(cd_setores_p))) = substr(cd_setores_p,1,1)
				 and	coalesce(cd_motivo_exc_conta::text, '') = ''
				 group by cd_setor_atendimento
				
union

				 SELECT	'S' ie_contem
				 from	material_atend_paciente
				 where	nr_interno_conta = nr_interno_conta_w
				 and	obter_se_contido(cd_setor_atendimento, substr(cd_setores_p,2,length(cd_setores_p))) = substr(cd_setores_p,1,1)
				 and	coalesce(cd_motivo_exc_conta::text, '') = ''
				 group by cd_setor_atendimento) a
			group by a.ie_contem;
			exception
			when others then
				ie_insere_w	:= 'N';
				goto final;
			end;
		else
			begin
			select	a.ie_contem
			into STRICT	ie_insere_w
			from (SELECT	'S' ie_contem
				 from	procedimento_paciente
				 where	nr_atendimento = nr_atendimento_w
				 and	obter_se_contido(cd_setor_atendimento, substr(cd_setores_p,2,length(cd_setores_p))) = substr(cd_setores_p,1,1)
				 and	coalesce(cd_motivo_exc_conta::text, '') = ''
				 group by cd_setor_atendimento
				
union

				 SELECT	'S' ie_contem
				 from	material_atend_paciente
				 where	nr_atendimento = nr_atendimento_w
				 and	obter_se_contido(cd_setor_atendimento, substr(cd_setores_p,2,length(cd_setores_p))) = substr(cd_setores_p,1,1)
				 and	coalesce(cd_motivo_exc_conta::text, '') = ''
				 group by cd_setor_atendimento) a
			group by a.ie_contem;
			exception
			when others then
				ie_insere_w	:= 'N';
				goto final;
			end;
		end if;
	end if;

	/* setores das etapas */

	if (cd_setores_etapa_p IS NOT NULL AND cd_setores_etapa_p::text <> '') then
		begin
		ds_setor_etapa_filtro_w := '';

		if (ie_etapa_conta_w = 'U') then
			select	'S'
			into STRICT	ie_insere_w
			
			where	obter_se_contido(cd_setor_etapa_w, substr(cd_setores_etapa_p,2,length(cd_setores_etapa_p))) = substr(cd_setores_etapa_p,1,1)
			and	((ie_data_p <> 'P') or (dt_ultima_etapa_w between dt_inicial_p and dt_final_p));

			select	substr(obter_nome_setor(cd_setor_etapa_w),1,255)
			into STRICT	ds_setor_etapa_filtro_w
			;
		elsif (ie_etapa_conta_w = 'T') then
			select	coalesce(max('S'),'N')
			into STRICT	ie_insere_w
			from	fatur_etapa b,
				conta_paciente_etapa a
			where	a.nr_seq_etapa		= b.nr_sequencia
			and	a.nr_interno_conta	= nr_interno_conta_w
			and	coalesce(b.ie_situacao,'A')	= 'A'
			and	((coalesce(cd_setores_etapa_p::text, '') = '') or (obter_se_contido(a.cd_setor_atendimento, substr(cd_setores_etapa_p,2,length(cd_setores_etapa_p))) = substr(cd_setores_etapa_p,1,1)))
			and	((ie_data_p <> 'P') or (a.dt_etapa between coalesce(dt_inicial_p,a.dt_etapa) and coalesce(dt_final_p,a.dt_etapa)));

			if (ie_insere_w = 'S') then
				select	substr(obter_select_concatenado_bv(	'select	substr(obter_nome_setor(a.cd_setor_atendimento),1,255)
									from	fatur_etapa b,
										conta_paciente_etapa a
									where	a.nr_seq_etapa		= b.nr_sequencia
									and	a.nr_interno_conta	= :nr_interno_conta
									and	nvl(b.ie_situacao,' || chr(39) || 'A' || chr(39) || ') = ' || chr(39) || 'A' || chr(39) || '
									and	((:cd_setores_etapa_p is null) or (obter_se_contido(a.cd_setor_atendimento, substr(:cd_setores_etapa_p,2,length(:cd_setores_etapa_p))) = substr(:cd_setores_etapa_p,1,1)))
									and	((:ie_data_p <> ' || chr(39) || 'P' || chr(39) || ') or ((a.dt_etapa between nvl(:dt_inicial_p,a.dt_etapa) and nvl(:dt_final_p,a.dt_etapa))))',
									'nr_interno_conta=' || nr_interno_conta_w || '#@#@' ||
									'cd_setores_etapa_p='|| cd_setores_etapa_p|| '#@#@' ||
									'ie_data_p=' || ie_data_p || '#@#@' ||
									'dt_inicial_p=' || dt_inicial_p || '#@#@' ||
									'dt_final_p=' || dt_final_p, ','),1,255)
				into STRICT	ds_setor_etapa_filtro_w
				;
			end if;
		elsif (ie_etapa_conta_w = 'P') then
			begin
			select	x.cd_setor_atendimento,
				x.dt_etapa
			into STRICT	cd_setor_etapa_conta_w,
				dt_etapa_conta_w
			from	conta_paciente_etapa x
			where	x.nr_sequencia =	(SELECT	min(a.nr_seq_etapa)
							from	fatur_etapa b,
								conta_paciente_etapa a
							where	b.nr_sequencia		= a.nr_seq_etapa
							and	coalesce(b.ie_situacao,'A')	= 'A'
							and	a.nr_interno_conta	= nr_interno_conta_w
							and	a.dt_etapa		= (	select	min(x.dt_etapa)
												from	conta_paciente_etapa x
												where	x.nr_interno_conta = a.nr_interno_conta));

			select	'S'
			into STRICT	ie_insere_w
			
			where	obter_se_contido(cd_setor_etapa_conta_w, substr(cd_setores_etapa_p,2,length(cd_setores_etapa_p))) = substr(cd_setores_etapa_p,1,1)
			and	((ie_data_p <> 'P') or (dt_etapa_conta_w between dt_inicial_p and dt_final_p));

			select	substr(obter_nome_setor(cd_setor_etapa_conta_w),1,255)
			into STRICT	ds_setor_etapa_filtro_w
			;
			end;
		elsif (ie_etapa_conta_w = 'O') then
			begin
			select	x.cd_setor_atendimento,
				x.dt_etapa
			into STRICT	cd_setor_etapa_conta_w,
				dt_etapa_conta_w
			from	conta_paciente_etapa x
			where	x.nr_sequencia =	(SELECT	min(a.nr_seq_etapa)
							from	fatur_etapa b,
								conta_paciente_etapa a
							where	b.nr_sequencia		= a.nr_seq_etapa
							and	coalesce(b.ie_situacao,'A')	= 'A'
							and	a.nr_interno_conta	= nr_interno_conta_w
							and	obter_se_contido(a.nr_seq_etapa, substr(cd_etapas_p,2,length(cd_etapas_p))) = substr(cd_etapas_p,1,1)
							and	a.dt_etapa		= (	select	min(x.dt_etapa)
												from	conta_paciente_etapa x
												where	x.nr_interno_conta = a.nr_interno_conta
												and	obter_se_contido(x.nr_seq_etapa, substr(cd_etapas_p,2,length(cd_etapas_p))) = substr(cd_etapas_p,1,1)));

			select	'S'
			into STRICT	ie_insere_w
			
			where	obter_se_contido(cd_setor_etapa_conta_w, substr(cd_setores_etapa_p,2,length(cd_setores_etapa_p))) = substr(cd_setores_etapa_p,1,1)
			and	((ie_data_p <> 'P') or (dt_etapa_conta_w between dt_inicial_p and dt_final_p));

			select	substr(obter_nome_setor(cd_setor_etapa_conta_w),1,255)
			into STRICT	ds_setor_etapa_filtro_w
			;
			end;
		end if;
		exception
			when others then
			ie_insere_w	:= 'N';
			goto final;
		end;
	end if;

	if (cd_pessoas_etapa_p IS NOT NULL AND cd_pessoas_etapa_p::text <> '') then
		begin
		if (ie_todas_pf_etapa_w = 'T') then
			begin

			select	max(a.cd_pessoa_fisica)
			into STRICT	cd_pessoa_etapa_w
			from	fatur_etapa b,
				conta_paciente_etapa a
			where	a.nr_seq_etapa		= b.nr_sequencia
			and	a.nr_interno_conta	= nr_interno_conta_w
			and	coalesce(b.ie_situacao,'A')	= 'A'
			and	((ie_conta_etapa_pend_p	= 'N') or (ie_conta_etapa_pend_p = 'S' and coalesce(a.dt_fim_etapa::text, '') = ''))
			and	((coalesce(cd_setores_etapa_p::text, '') = '') or (obter_se_contido(a.cd_setor_atendimento, substr(cd_setores_etapa_p,2,length(cd_setores_etapa_p))) = 'S'))
			and	((ie_data_p <> 'P') or (a.dt_etapa between coalesce(dt_inicial_p,a.dt_etapa) and coalesce(dt_final_p,a.dt_etapa)))
			and	((coalesce(cd_etapas_p::text, '') = '') or (obter_se_contido(a.nr_seq_etapa, substr(cd_etapas_p,2,length(cd_etapas_p))) = 'S'))
			and	obter_se_contido(a.cd_pessoa_fisica, substr(cd_pessoas_etapa_p,2,length(cd_pessoas_etapa_p))) = 'S';

			end;
		elsif (ie_todas_pf_etapa_w = 'M') then
			begin

			select	max(a.cd_pessoa_fisica)
			into STRICT	cd_pessoa_etapa_w
			from	fatur_etapa x,
				conta_paciente_etapa a
			where	x.nr_sequencia  = a.nr_seq_etapa
			and	coalesce(x.ie_situacao,'A') = 'A'
			and	a.nr_interno_conta = nr_interno_conta_w
			and	x.nr_seq_etapa = (	SELECT	max(obter_seq_etapa(a.nr_seq_etapa))
							from	fatur_etapa b,
								conta_paciente_etapa a
							where	b.nr_sequencia  = a.nr_seq_etapa
							and	coalesce(b.ie_situacao,'A') = 'A'
							and	a.nr_interno_conta = nr_interno_conta_w);

			end;
		end if;

		if (obter_se_contido(cd_pessoa_etapa_w, substr(cd_pessoas_etapa_p,2,length(cd_pessoas_etapa_p))) <> substr(cd_pessoas_etapa_p,1,1)) then
			ie_insere_w	:= 'N';
			goto final;
		end if;
		end;
	end if;

	if (cd_planos_p IS NOT NULL AND cd_planos_p::text <> '') then
		cd_plano_w	:= cd_convenio_w || substr(obter_plano_convenio_atend(nr_atendimento_w,'C'),1,10);
		if (obter_se_contido(cd_plano_w, substr(cd_planos_p,2,length(cd_planos_p))) <> substr(cd_planos_p,1,1)) then
			ie_insere_w	:= 'N';
			goto final;
		end if;
	end if;

	if (cd_setor_destino_p IS NOT NULL AND cd_setor_destino_p::text <> '')and (substr(cd_setor_destino_p,1,1) = 'N')then
		begin

		begin
		select	'N'
		into STRICT	ie_insere_w
		
		where	exists (	SELECT 	1
				from	protocolo_documento a,
					protocolo_doc_item b
				where	b.nr_documento	= nr_atendimento_w
				and	a.ie_tipo_protocolo = 2
				and	a.nr_sequencia = b.nr_sequencia
				and	(a.cd_setor_destino IS NOT NULL AND a.cd_setor_destino::text <> '')
				and	obter_se_contido(a.cd_setor_destino, substr(cd_setor_destino_p,2,length(cd_setor_destino_p))) <> substr(cd_setor_destino_p,1,1)
				group by a.cd_setor_destino);
		exception
			when others then
			ie_insere_w := 'S';
			end;
		end;
	end if;

	if (cd_setor_destino_p IS NOT NULL AND cd_setor_destino_p::text <> '')and (substr(cd_setor_destino_p,1,1) = 'S')then
		begin

		begin
		select	'S'
		into STRICT	ie_insere_w
		
		where	exists (	SELECT 	1
				from	protocolo_documento a,
					protocolo_doc_item b
				where	b.nr_documento	= nr_atendimento_w
				and	a.ie_tipo_protocolo = 2
				and	a.nr_sequencia = b.nr_sequencia
				and	(a.cd_setor_destino IS NOT NULL AND a.cd_setor_destino::text <> '')
				and	obter_se_contido(a.cd_setor_destino, substr(cd_setor_destino_p,2,length(cd_setor_destino_p))) = substr(cd_setor_destino_p,1,1)
				group by a.cd_setor_destino);
		exception
			when others then
			ie_insere_w := 'N';
			end;
		end;
	end if;

	if (nr_seq_estagio_aut_p IS NOT NULL AND nr_seq_estagio_aut_p::text <> '') then
		begin

		begin
		select 	'S'
		into STRICT	ie_insere_w
		from	autorizacao_convenio
		where	nr_atendimento	= nr_atendimento_w
		and	obter_se_contido(nr_seq_estagio, substr(nr_seq_estagio_aut_p,2,length(nr_seq_estagio_aut_p))) = substr(nr_seq_estagio_aut_p,1,1)
		group by nr_seq_estagio;
		exception
			when others then
			ie_insere_w := 'N';
			end;
		end;
	end if;

	if (nr_seq_estagio_conta_p IS NOT NULL AND nr_seq_estagio_conta_p::text <> '') and (obter_se_contido(nr_seq_estagio_conta_w, substr(nr_seq_estagio_conta_p,2,length(nr_seq_estagio_conta_p))) <> substr(nr_seq_estagio_conta_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	/*Alteração para otimizar a busca dos procedimentos apenas se for utilizado algum filtro por procedimento ou opção de listar estiver marcada*/

	if (cd_procedimento_p IS NOT NULL AND cd_procedimento_p::text <> '') or (cd_tipos_procedimento_p IS NOT NULL AND cd_tipos_procedimento_p::text <> '') or (ie_conta_sem_proced_p <> 'A') or (cd_grupo_proc_p IS NOT NULL AND cd_grupo_proc_p::text <> '') or (cd_area_procedimento_p IS NOT NULL AND cd_area_procedimento_p::text <> '') or (cd_especialidade_p IS NOT NULL AND cd_especialidade_p::text <> '') or (nr_seq_grupo_sus_p IS NOT NULL AND nr_seq_grupo_sus_p::text <> '') or (nr_seq_subgrupo_sus_p IS NOT NULL AND nr_seq_subgrupo_sus_p::text <> '') or (nr_seq_forma_org_sus_p IS NOT NULL AND nr_seq_forma_org_sus_p::text <> '') or (ie_listar_proced_p = 'S') then
		begin
		/*Verifica se existe algum procedimento gravado na tabela para este atendimento*/

		begin
		select	nr_sequencia
		into STRICT	nr_sequencia_proc_w
		from	w_eis_conta_pendente
		where	nr_atendimento 	= nr_atendimento_w
		and	nm_usuario	= nm_usuario_p
		and	cd_procedimento <> 0
		and	ie_origem_proced <> 0  LIMIT 1;
		exception
		when others then
			nr_sequencia_proc_w := 0;
		end;

		/*Se achou, busca o procedimento e origem proced*/

		if (nr_sequencia_proc_w > 0) then
			begin
			select	cd_procedimento,
				ie_origem_proced
			into STRICT	cd_procedimento_w,
				ie_origem_proced_w
			from	w_eis_conta_pendente
			where	nr_sequencia = nr_sequencia_proc_w;
			exception
			when others then
				cd_procedimento_w	:= null;
				ie_origem_proced_w	:= null;
			end;
		/*Se ainda não tem, busca o proc principal do atendimento e verifica se este está lançado no EIS para o atendimento*/

		elsif (nr_sequencia_proc_w = 0) then
			ds_proc_aux_w		:= substr(obter_proc_principal(nr_atendimento_w,cd_convenio_w,null,nr_interno_conta_w,'EIS'),1,20);

			cd_procedimento_aux_w	:= substr(ds_proc_aux_w,2,15);
			ie_origem_proced_aux_w	:= substr(ds_proc_aux_w,1,1);

			cd_procedimento_w	:= cd_procedimento_aux_w;
			ie_origem_proced_w	:= ie_origem_proced_aux_w;

			/*Verifica se tem o proc principal do atendimento na tabela*/

			if (nr_sequencia_proc_w = 0) and (coalesce(cd_procedimento_w,0) <> 0) and (coalesce(ie_origem_proced_w,0) <> 0) then
				begin
				select	nr_sequencia
				into STRICT	nr_sequencia_proc_w
				from	w_eis_conta_pendente
				where	nr_atendimento 	= nr_atendimento_w
				and	nm_usuario	= nm_usuario_p
				and	cd_procedimento	= cd_procedimento_w
				and	ie_origem_proced= ie_origem_proced_w  LIMIT 1;
				exception
				when others then
					nr_sequencia_proc_w := 0;
				end;
			end if;

			/*Se ainda não encontrou nenhum, busca por qualquer procedimento da conta*/

			if (coalesce(cd_procedimento_w,0) = 0) then
				begin
				select	nr_sequencia,
					cd_procedimento,
					ie_origem_proced
				into STRICT	nr_sequencia_proc_w,
					cd_procedimento_w,
					ie_origem_proced_w
				from	procedimento_paciente
				where	nr_interno_conta = nr_interno_conta_w
				and	coalesce(cd_motivo_exc_conta::text, '') = ''  LIMIT 1;
				exception
				when others then
					nr_sequencia_proc_w := 0;
				end;
			end if;
		end if;

		if (coalesce(cd_procedimento_w,0) <> 0) and (coalesce(ie_origem_proced_w,0) = 0) then
			select	max(ie_origem_proced)
			into STRICT	ie_origem_proced_w
			from	procedimento
			where	cd_procedimento = cd_procedimento_w;
		end if;
		end;

		ds_procedimento_w:= null;
		if (coalesce(cd_procedimento_w,0) <> 0) and (coalesce(ie_origem_proced_w,0) <> 0) then

		   select  max(ds_procedimento)
		   into STRICT	   ds_procedimento_w
		   from	   procedimento
		   where   cd_procedimento = cd_procedimento_w
		   and 	   ie_origem_proced = ie_origem_proced_w;

		end if;
	end if;

	if (cd_procedimento_p IS NOT NULL AND cd_procedimento_p::text <> '') then
		begin
		if (coalesce(ie_somente_proc_conta_w,'N') = 'N') and (obter_se_contido(cd_procedimento_w,substr(cd_procedimento_p,2,length(cd_procedimento_p))) <> substr(cd_procedimento_p,1,1))then
			ie_insere_w	:= 'N';
			goto final;
		else
			begin

			begin
			select	coalesce(max('S'),'N')
			into STRICT	ie_insere_w
			from	procedimento_paciente
			where	nr_interno_conta = nr_interno_conta_w
			and	nr_atendimento = nr_atendimento_w
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and	obter_se_contido(cd_procedimento,substr(cd_procedimento_p,2,length(cd_procedimento_p))) = substr(cd_procedimento_p,1,1)  LIMIT 1;
			exception
			when others then
				ie_insere_w := 'N';
			end;

			if (ie_insere_w = 'N') then
				goto final;
			end if;
			end;
		end if;
		end;
	end if;

	if	(cd_tipos_procedimento_p IS NOT NULL AND cd_tipos_procedimento_p::text <> '' AND cd_tipos_procedimento_p <> '0') then

		if (coalesce(ie_somente_proc_conta_w,'N') = 'S') then

			begin
			select	coalesce(max('S'),'N')
			into STRICT	ie_insere_w
			from	procedimento_paciente a,
				procedimento	b
			where	a.cd_procedimento	= b.cd_procedimento
			and	a.ie_origem_proced	= b.ie_origem_proced
			and	a.nr_interno_conta 	= nr_interno_conta_w
			and	a.nr_atendimento 	= nr_atendimento_w
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
			and (obter_se_contido(b.cd_tipo_procedimento,
							substr(cd_tipos_procedimento_p,2,length(cd_tipos_procedimento_p))) =
							substr(cd_tipos_procedimento_p,1,1))  LIMIT 1;
			exception
			when others then
				ie_insere_w := 'N';
			end;
		elsif (coalesce(cd_procedimento_w,0) <> 0) and (coalesce(ie_origem_proced_w,0) <> 0) and (obter_se_contido(obter_tipo_procedimento(cd_procedimento_w,ie_origem_proced_w,'C'),substr(cd_tipos_procedimento_p,2,length(cd_tipos_procedimento_p))) <> substr(cd_tipos_procedimento_p,1,1))then
			ie_insere_w	:= 'N';
		end if;

		if (ie_insere_w = 'N') then
			goto final;
		end if;

	end if;

	if (coalesce(cd_procedimento_w,0) = 0) and (coalesce(ie_conta_sem_proced_p,'C') = 'C') then
		begin
		ie_insere_w	:= 'N';
		goto final;
		end;
	elsif (coalesce(cd_procedimento_w,0) > 0) and (coalesce(ie_conta_sem_proced_p,'C') = 'S') then
		begin
		ie_insere_w	:= 'N';
		goto final;
		end;
	end if;

	if (cd_grupo_proc_p IS NOT NULL AND cd_grupo_proc_p::text <> '') then
		begin
		cd_grupo_proc_w	:= obter_grupo_procedimento(cd_procedimento_w, ie_origem_proced_w, 'C');
		exception
			when others then
			ie_insere_w	:= 'N';
			goto final;
			end;

		if (obter_se_contido(cd_grupo_proc_w,substr(cd_grupo_proc_p,2,length(cd_grupo_proc_p))) <> substr(cd_grupo_proc_p,1,1)) then
			ie_insere_w	:= 'N';
			goto final;
		end if;
	end if;

	if (cd_area_procedimento_p IS NOT NULL AND cd_area_procedimento_p::text <> '') then
		begin
		cd_area_procedimento_w	:= obter_area_procedimento(cd_procedimento_w,ie_origem_proced_w);
		exception
			when others then
			ie_insere_w	:= 'N';
			goto final;
			end;

		if (obter_se_contido(cd_area_procedimento_w,substr(cd_area_procedimento_p,2,length(cd_area_procedimento_p))) <> substr(cd_area_procedimento_p,1,1)) then
			ie_insere_w	:= 'N';
			goto final;
		end if;

	end if;

	if (cd_especialidade_p IS NOT NULL AND cd_especialidade_p::text <> '') then
		begin
		cd_especialidade_w	:= obter_especialidade_proced(cd_procedimento_w,ie_origem_proced_w);
		exception
			when others then
			ie_insere_w	:= 'N';
			goto final;
			end;

		if (obter_se_contido(cd_especialidade_w,substr(cd_especialidade_p,2,length(cd_especialidade_p))) <> substr(cd_especialidade_p,1,1)) then
			ie_insere_w	:= 'N';
			goto final;
		end if;
	end if;

	if (nr_seq_grupo_sus_p IS NOT NULL AND nr_seq_grupo_sus_p::text <> '') then
		begin
		nr_seq_grupo_sus_w	:= sus_obter_estrut_proc(cd_procedimento_w, ie_origem_proced_w, 'S', 'G');
		exception
			when others then
			ie_insere_w	:= 'N';
			goto final;
			end;

		if (obter_se_contido(nr_seq_grupo_sus_w,substr(nr_seq_grupo_sus_p,2,length(nr_seq_grupo_sus_p))) <> substr(nr_seq_grupo_sus_p,1,1)) then
			ie_insere_w	:= 'N';
			goto final;
		end if;
	end if;

	if (nr_seq_subgrupo_sus_p IS NOT NULL AND nr_seq_subgrupo_sus_p::text <> '') then
		begin
		nr_seq_subgrupo_sus_w	:= sus_obter_estrut_proc(cd_procedimento_w, ie_origem_proced_w, 'S', 'S');
		exception
			when others then
			ie_insere_w	:= 'N';
			goto final;
			end;

		if (obter_se_contido(nr_seq_subgrupo_sus_w,substr(nr_seq_subgrupo_sus_p,2,length(nr_seq_subgrupo_sus_p))) <> substr(nr_seq_subgrupo_sus_p,1,1)) then
			ie_insere_w	:= 'N';
			goto final;
		end if;
	end if;

	if (nr_seq_forma_org_sus_p IS NOT NULL AND nr_seq_forma_org_sus_p::text <> '') then
		begin
		nr_seq_forma_org_sus_w	:= sus_obter_estrut_proc(cd_procedimento_w, ie_origem_proced_w, 'S', 'F');
		exception
			when others then
			ie_insere_w	:= 'N';
			goto final;
			end;

		if (obter_se_contido(nr_seq_forma_org_sus_w,substr(nr_seq_forma_org_sus_p,2,length(nr_seq_forma_org_sus_p))) <> substr(nr_seq_forma_org_sus_p,1,1)) then
			ie_insere_w	:= 'N';
			goto final;
		end if;
	end if;

	if (ie_complexidade_p IS NOT NULL AND ie_complexidade_p::text <> '') then
		begin
		select	coalesce(max('S'),'N')
		into STRICT	ie_insere_w
		from	procedimento_paciente
		where	nr_interno_conta = nr_interno_conta_w
		and	sus_obter_tiporeg_proc(cd_procedimento, ie_origem_proced, 'C', 13) = '3'
		and	obter_se_contido_char(sus_obter_complexidade_proced(cd_procedimento,ie_origem_proced, 'C'), substr(ie_complexidade_p,2,length(ie_complexidade_p))) = substr(ie_complexidade_p,1,1);

		if (ie_insere_w = 'N') then
			goto final;
		end if;

		exception
			when others then
			ie_insere_w	:= 'N';
			goto final;
		end;
	end if;

	if (ie_tipo_guia_conv_p IS NOT NULL AND ie_tipo_guia_conv_p::text <> '') then
		begin
		select	coalesce(max('S'),'N')
		into STRICT	ie_insere_w
		
		where (obter_se_contido_char(substr(obter_tipo_guia_convenio(nr_atendimento_w),1,1),substr(ie_tipo_guia_conv_p,2,length(ie_tipo_guia_conv_p))) = substr(ie_tipo_guia_conv_p,1,1));
		end;
	end if;

	if (cd_setores_ult_int_p IS NOT NULL AND cd_setores_ult_int_p::text <> '') then
		cd_setor_ult_int_w := obter_unidade_atendimento(nr_atendimento_w,'IA','CS');

		if (obter_se_contido(cd_setor_ult_int_w,substr(cd_setores_ult_int_p,2,length(cd_setores_ult_int_p))) <> substr(cd_setores_ult_int_p,1,1)) then
			ie_insere_w	:= 'N';
			goto final;
		end if;
	end if;

	if (cd_setor_entrega_prescr_p IS NOT NULL AND cd_setor_entrega_prescr_p::text <> '') then
		begin
		if (substr(cd_setor_entrega_prescr_p,1,1) = 'S') then
			select	count(1)
			into STRICT	qt_existe_w
			from	prescr_medica
			where	nr_atendimento = nr_atendimento_w
			and (obter_se_contido(cd_setor_entrega,substr(cd_setor_entrega_prescr_p,2,length(cd_setor_entrega_prescr_p))) = substr(cd_setor_entrega_prescr_p,1,1))  LIMIT 1;

			if (qt_existe_w = 0) then
				ie_insere_w	:= 'N';
				goto final;
			end if;
		elsif (substr(cd_setor_entrega_prescr_p,1,1) = 'N') then
			select	count(1)
			into STRICT	qt_existe_w
			from	prescr_medica
			where	nr_atendimento = nr_atendimento_w
			and (obter_se_contido(cd_setor_entrega,substr(cd_setor_entrega_prescr_p,2,length(cd_setor_entrega_prescr_p))) <> substr(cd_setor_entrega_prescr_p,1,1))  LIMIT 1;

			if (qt_existe_w > 0) then
				ie_insere_w	:= 'N';
				goto final;
			end if;
		end if;
		end;
	end if;

	if (cd_motivos_devol_etapa_p IS NOT NULL AND cd_motivos_devol_etapa_p::text <> '') then
		begin

		select	'S'
		into STRICT	ie_insere_w
		
		where	obter_se_contido(cd_motivo_devol_etapa_w, substr(cd_motivos_devol_etapa_p,2,length(cd_motivos_devol_etapa_p))) = substr(cd_motivos_devol_etapa_p,1,1);
		exception
			when others then
			ie_insere_w	:= 'N';
			goto final;
		end;
	end if;
	if (cd_motivos_devol_etapa_p IS NOT NULL AND cd_motivos_devol_etapa_p::text <> '') and (obter_se_contido(cd_motivo_devol_etapa_w, substr(cd_motivos_devol_etapa_p,2,length(cd_motivos_devol_etapa_p))) <> substr(cd_motivos_devol_etapa_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	if (ie_tipos_atend_conta_p IS NOT NULL AND ie_tipos_atend_conta_p::text <> '') and (obter_se_contido(ie_tipo_atend_conta_w, substr(ie_tipos_atend_conta_p,2,length(ie_tipos_atend_conta_p))) <> substr(ie_tipos_atend_conta_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	if (cd_tipo_regulacao_p IS NOT NULL AND cd_tipo_regulacao_p::text <> '') then
		select	substr(obter_eme_dados_regul_atend(nr_atendimento_w,'TP'),1,1)
		into STRICT	ie_tipo_regulacao_w
		;

		select	coalesce(max('S'),'N')
		into STRICT	ie_insere_w
		
		where (obter_se_contido_char(substr(obter_eme_dados_regul_atend(nr_atendimento_w,'TP'),1,1),substr(cd_tipo_regulacao_p,2,length(cd_tipo_regulacao_p))) = substr(cd_tipo_regulacao_p,1,1));

		if (ie_insere_w = 'N') then
			goto final;
		end if;
	end if;

	if (cd_tipo_serv_regulacao_p IS NOT NULL AND cd_tipo_serv_regulacao_p::text <> '') then
		select	coalesce(substr(obter_eme_dados_regul_atend(nr_atendimento_w,'TS'),1,10),0)
		into STRICT	nr_seq_tipo_serv_regulacao_w
		;

		if (obter_se_contido(nr_seq_tipo_serv_regulacao_w, substr(cd_tipo_serv_regulacao_p,2,length(cd_tipo_serv_regulacao_p))) <> substr(cd_tipo_serv_regulacao_p,1,1)) then
			ie_insere_w	:= 'N';
			goto final;
		end if;
	end if;

	if (cd_procedimento_w = 0) then
		cd_procedimento_w	:= null;
		ie_origem_proced_w	:= null;
	end if;

	if (qt_dias_etapa_p IS NOT NULL AND qt_dias_etapa_p::text <> '') then
		begin

		begin
		select	coalesce(max('S'),'N')
		into STRICT	ie_insere_w
		from	fatur_etapa b,
			conta_paciente_etapa a
		where	a.nr_seq_etapa		= b.nr_sequencia
		and	coalesce(b.ie_situacao,'A')	= 'A'
		and	a.nr_interno_conta		= nr_interno_conta_w
		and	a.nr_seq_etapa		= obter_eis_etapa_conta(nr_interno_conta_w,'C')
		and	coalesce(a.dt_fim_etapa::text, '') = ''
		and	((trunc(clock_timestamp(),'dd') - trunc(a.dt_etapa,'dd')) > qt_dias_etapa_p);

		if (ie_insere_w = 'N') then
			goto final;
		end if;

		exception
			when others then
			ie_insere_w	:= 'N';
			goto final;
		end;
		end;
	end if;

	if (coalesce(qt_dias_atraso_p,0) > 0) then
		begin
		begin
		select	coalesce(max('S'),'N')
		into STRICT	ie_insere_w
		from	atendimento_paciente a,
				conta_paciente b
		where	a.nr_atendimento = b.nr_atendimento
		and		b.nr_interno_conta = nr_interno_conta_w
		and		((trunc(clock_timestamp(),'dd') - trunc(a.dt_alta,'dd')) > qt_dias_atraso_p);

		if (ie_insere_w = 'N') then
			goto final;
		end if;

		exception
			when others then
			ie_insere_w	:= 'N';
			goto final;
		end;
		end;
	end if;

	if (ie_laudo_paciente_p <> 'A') then
		begin

		select	count(1)
		into STRICT	qt_existe_laudo_w
		from	laudo_paciente
		where	nr_atendimento = nr_atendimento_w  LIMIT 1;

		if (qt_existe_laudo_w = 0) and (coalesce(ie_laudo_paciente_p,'C') = 'C') then
			begin
			ie_insere_w	:= 'N';
			goto final;
			end;
		elsif (qt_existe_laudo_w > 0) and (coalesce(ie_laudo_paciente_p,'C') = 'S') then
			begin
			ie_insere_w	:= 'N';
			goto final;
			end;
		end if;

		end;
	end if;

	if (cd_tipo_acomodacao_p IS NOT NULL AND cd_tipo_acomodacao_p::text <> '') then
		begin

		begin
		select 	'S'
		into STRICT	ie_insere_w
		from	atend_categoria_convenio a
		where	a.nr_atendimento 	= nr_atendimento_w
		and	a.dt_inicio_vigencia = (	SELECT	max(dt_inicio_vigencia)
					 	from	atend_categoria_convenio b
					 	where	b.nr_atendimento = nr_atendimento_w)
		and	obter_se_contido(a.cd_tipo_acomodacao, substr(cd_tipo_acomodacao_p,2,length(cd_tipo_acomodacao_p))) = substr(cd_tipo_acomodacao_p,1,1)
		group by a.cd_tipo_acomodacao;
		exception
			when others then
			ie_insere_w := 'N';
			end;
		end;
	end if;

	if (coalesce(ie_conta_perda_p,'S') = 'N') and (coalesce(obter_perda_conta_pac_baixa(nr_interno_conta_w),0) <> 0) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	if (nr_seq_classif_atend_p IS NOT NULL AND nr_seq_classif_atend_p::text <> '') then
		nr_seq_classif_atend_w := obter_classificacao_atend(nr_atendimento_w,'C');

		if (obter_se_contido(nr_seq_classif_atend_w,substr(nr_seq_classif_atend_p,2,length(nr_seq_classif_atend_p))) <> substr(nr_seq_classif_atend_p,1,1)) then
			ie_insere_w	:= 'N';
			goto final;
		end if;
	end if;

	if (coalesce(cd_procedimento_w,0) = 0) or (coalesce(ie_origem_proced_w,0) = 0) then
		cd_procedimento_w	:= null;
		ie_origem_proced_w	:= null;
		nr_sequencia_proc_w	:= null;
	else
		select	count(1)
		into STRICT	qt_existe_proc_w
		from	procedimento
		where	cd_procedimento = cd_procedimento_w
		and	ie_origem_proced = ie_origem_proced_w  LIMIT 1;

		if (qt_existe_proc_w = 0) then
			cd_procedimento_w	:= null;
			ie_origem_proced_w	:= null;
			nr_sequencia_proc_w	:= null;
		end if;
	end if;

	if (cd_setor_prescr_proced_p IS NOT NULL AND cd_setor_prescr_proced_p::text <> '') then
		begin
		select	count(1)
		into STRICT	qt_existe_w
		from	prescr_medica b,
			prescr_procedimento a
		where	b.nr_prescricao = a.nr_prescricao
		and	b.nr_atendimento = nr_atendimento_w
		and (obter_se_contido(a.cd_setor_atendimento,substr(cd_setor_prescr_proced_p,2,length(cd_setor_prescr_proced_p))) = 'S')  LIMIT 1;

		if (substr(cd_setor_prescr_proced_p,1,1) = 'S') then
			if (qt_existe_w = 0) then
				ie_insere_w	:= 'N';
				goto final;
			end if;
		elsif (substr(cd_setor_prescr_proced_p,1,1) = 'N') then
			if (qt_existe_w > 0) then
				ie_insere_w	:= 'N';
				goto final;
			end if;
		end if;
		end;
	end if;

	begin
	ie_status_atend_w	:= ie_probabilidade_alta_w;
	ds_status_atend_w	:= substr(obter_valor_dominio(1267, ie_probabilidade_alta_w),1,255);

	if (dt_alta_w IS NOT NULL AND dt_alta_w::text <> '') then
		ie_status_atend_w	:= 'X';
		ds_status_atend_w	:= 'Alta hospitalar';
	end if;

	if (dt_alta_w IS NOT NULL AND dt_alta_w::text <> '') then
		dt_status_atend_w	:= dt_alta_w;
	elsif (dt_alta_medico_w IS NOT NULL AND dt_alta_medico_w::text <> '') then
		dt_status_atend_w	:= dt_alta_medico_w;
	elsif (dt_previsto_alta_w IS NOT NULL AND dt_previsto_alta_w::text <> '') then
		dt_status_atend_w	:= dt_previsto_alta_w;
	else
		dt_status_atend_w	:= '';
	end if;

	exception
	when others then
		ds_status_atend_w := '';
	end;

	if (coalesce(ie_tipo_atend_tiss_w,'X') <> 'X') then
		ds_tipo_atend_tiss_w := substr(obter_valor_dominio(1761,ie_tipo_atend_tiss_w),1,255);
	end if;

	if (dt_ref_protocolo_p IS NOT NULL AND dt_ref_protocolo_p::text <> '') then
		begin
		if (coalesce(nr_seq_protocolo_w,0) > 0) then
			select	dt_mesano_referencia
			into STRICT	dt_mesano_ref_prot_w
			from	protocolo_convenio
			where	nr_seq_protocolo = nr_seq_protocolo_w;

			if (trunc(dt_mesano_ref_prot_w,'dd') <> trunc(dt_ref_protocolo_p,'dd')) then
				begin
				ie_insere_w	:= 'N';
				goto final;
				end;
			end if;
		else
			ie_insere_w	:= 'N';
			goto final;
		end if;
		end;
	end if;

	if (ie_cod_setores_conta_p = 'S') then
		begin
		select obter_select_concatenado_bv('select	a.cd_setor_atendimento
						from	valores_atend_paciente_v a
						where	a.nr_interno_conta = :nr_interno_conta
						and	(a.quantidade <> 0 or a.valor <> 0)
						and	a.cd_motivo_exc_conta is null
						and	(nvl(a.nr_seq_proc_pacote,0)  <> a.nr_sequencia)
						group by a.cd_setor_atendimento',
						'nr_interno_conta= ' || nr_interno_conta_w,',')
		into STRICT	ds_cod_setores_conta_w
		;
		end;
	end if;

	if (nm_usuario_recep_atend_p IS NOT NULL AND nm_usuario_recep_atend_p::text <> '') and (obter_se_contido_char(nm_usuario_recep_atend_w,substr(nm_usuario_recep_atend_p,2,length(nm_usuario_recep_atend_p))) <> substr(nm_usuario_recep_atend_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	if (nr_seq_tipo_lib_guia_p IS NOT NULL AND nr_seq_tipo_lib_guia_p::text <> '') and (obter_se_contido_char(nm_usuario_recep_atend_w,substr(nm_usuario_recep_atend_p,2,length(nm_usuario_recep_atend_p))) <> substr(nm_usuario_recep_atend_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	ds_municipio_w := '';
	if (coalesce(cd_pessoa_fisica_w,'X') <> 'X') then
		select	substr(obter_compl_pf(cd_pessoa_fisica_w,1,'DSM'),1,40)
		into STRICT	ds_municipio_w
		;
	end if;

	if (cd_agrupamento_setor_p IS NOT NULL AND cd_agrupamento_setor_p::text <> '') and (cd_setor_atendimento_w IS NOT NULL AND cd_setor_atendimento_w::text <> '') and (obter_se_contido(obter_agrupamento_setor(cd_setor_atendimento_w), substr(cd_agrupamento_setor_p,2,length(cd_agrupamento_setor_p))) <> substr(cd_agrupamento_setor_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	if (ie_carater_inter_sus_p IS NOT NULL AND ie_carater_inter_sus_p::text <> '') and (obter_se_contido_char(ie_carater_inter_sus_w,substr(ie_carater_inter_sus_p,2,length(ie_carater_inter_sus_p))) <> substr(ie_carater_inter_sus_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	/* valor da conta */

	if (ie_valor_conta_p = 'S') or (ie_maiores_zero_p = 'S') or
		(vl_inicial_p IS NOT NULL AND vl_inicial_p::text <> '' AND vl_final_p IS NOT NULL AND vl_final_p::text <> '') then
		begin
		vl_conta_w	:= obter_valor_conta(nr_interno_conta_w,0);
		exception
			when others then
			ie_insere_w	:= 'N';
			goto final;
		end;
	end if;

	begin
	/* verificando se o valor da conta é maior que zero */

	if (ie_maiores_zero_p = 'S') and (coalesce(vl_conta_w,0) <= 0) then
		begin
		ie_insere_w	:= 'N';
		goto final;
		end;
	end if;
	exception
		when others then
		sql_err_w := substr(sqlerrm, 1, 1800);
	end;
	/*valor da conta SUS*/

	begin
	if (ie_valor_conta_sus_p = 'S') then
		vl_conta_sus_w	:= sus_obter_valor_unif(nr_interno_conta_w,0);
	end if;
	exception
		when others then
		sql_err_w := substr(sqlerrm, 1, 1800);
	end;

	/* contas com restrição de valor */

	if (vl_inicial_p IS NOT NULL AND vl_inicial_p::text <> '') and (vl_final_p IS NOT NULL AND vl_final_p::text <> '') then
		begin
		if (vl_conta_w IS NOT NULL AND vl_conta_w::text <> '') then
			vl_conta_ww	:= vl_conta_w;
		else
		vl_conta_ww	:= vl_conta_w;
		end if;
		if (vl_conta_ww	>=vl_inicial_p) and (vl_conta_ww	<=vl_final_p) then
			ie_insere_w	:= 'S';
		else
			ie_insere_w	:= 'N';
			goto final;
		end if;
		end;
	end if;

	/*Verifica se tem mat/med na conta*/

	if (ie_conta_sem_matmed_p <> 'A') then
		begin

		select	count(1)
		into STRICT	qt_existe_matmed_w
		from	material_atend_paciente
		where	nr_interno_conta = nr_interno_conta_w
		and	coalesce(cd_motivo_exc_conta::text, '') = ''  LIMIT 1;

		if (qt_existe_matmed_w = 0) and (coalesce(ie_conta_sem_matmed_p,'C') = 'C') then
			begin
			ie_insere_w	:= 'N';
			goto final;
			end;
		elsif (qt_existe_matmed_w > 0) and (coalesce(ie_conta_sem_matmed_p,'C') = 'S') then
			begin
			ie_insere_w	:= 'N';
			goto final;
			end;
		end if;

		end;
	end if;
	/*Verifica a classificação da pessoa física*/

	if (nr_seq_pessoa_classif_p IS NOT NULL AND nr_seq_pessoa_classif_p::text <> '') then
		begin

		begin
		select	max(nr_seq_classif)
		into STRICT	nr_seq_classif_w
		from	pessoa_classif
		where	cd_pessoa_fisica = cd_pessoa_fisica_w
		and	dt_inicio_vigencia < dt_entrada_w;
		exception
		when others then
			nr_seq_classif_w := 0;
		end;

		if (obter_se_contido(nr_seq_classif_w, substr(nr_seq_pessoa_classif_p,2,length(nr_seq_pessoa_classif_p))) <> substr(nr_seq_pessoa_classif_p,1,1)) then
			ie_insere_w	:= 'N';
			goto final;
		end if;

		end;
	end if;
	/*Verifica a se o atendimento é cancelado ou não*/

	if (ie_atend_cancel_p <> 'A') then
		begin
		begin
		select	coalesce(max(ie_insere),'N')
		into STRICT	ie_insere_w
		from (SELECT	'S' ie_insere
			from	atendimento_paciente
			where	nr_atendimento = nr_atendimento_w
			and	coalesce(dt_cancelamento::text, '') = ''
			and	ie_atend_cancel_p = 'S'
			
union

			SELECT	'S' ie_insere
			from	atendimento_paciente
			where	nr_atendimento = nr_atendimento_w
			and	(dt_cancelamento IS NOT NULL AND dt_cancelamento::text <> '')
			and	ie_atend_cancel_p = 'C'  LIMIT 1) alias5;
		end;

		if (ie_insere_w = 'N') then
			goto final;
		end if;
		exception
		when others then
		ie_insere_w	:= 'N';
		goto final;
		end;
	end if;

	/* Verifica numero do protocolo documento do atendimento*/

	if (coalesce(ie_protocolo_doc_p,'A') <> 'A') then
		begin

		select	count(1)
		into STRICT	qt_prot_doc_w
		
		where	coalesce(Obter_dados_protocolo_doc(nr_atendimento_w,'SE'),'0') <> '0'  LIMIT 1;

		if (qt_prot_doc_w = 0) and (coalesce(ie_protocolo_doc_p,'A') = 'C') then
			begin
			ie_insere_w	:= 'N';
			goto final;
			end;
		elsif ( qt_prot_doc_w > 0) and (coalesce(ie_protocolo_doc_p,'A') = 'S') then
			begin
			ie_insere_w	:= 'N';
			goto final;
			end;
		end if;
		end;
	end if;

	/*Identificar os prontuários que não foram enviados para faturamento*/

	if (cd_setor_prontuario_p IS NOT NULL AND cd_setor_prontuario_p::text <> '') and (substr(cd_setor_prontuario_p,1,1) = 'N') then
		begin

		begin
		select 	'N'
		into STRICT	ie_insere_w
		
		where	exists (SELECT	1
				from	transf_prontuario a
				where	a.nr_atendimento 	= nr_atendimento_w
				and	obter_se_contido(a.cd_setor_destino, substr(cd_setor_prontuario_p,2,length(cd_setor_prontuario_p))) <> substr(cd_setor_prontuario_p,1,1));
		exception
		when others then
			ie_insere_w := 'S';
			goto final;
		end;

		end;
	end if;

	if (cd_setor_prontuario_p IS NOT NULL AND cd_setor_prontuario_p::text <> '') and (substr(cd_setor_prontuario_p,1,1) = 'S') then
		begin

		begin
		select 	'S'
		into STRICT	ie_insere_w
		
		where	exists (SELECT	1
				from	transf_prontuario a
				where	a.nr_atendimento 	= nr_atendimento_w
				and	obter_se_contido(a.cd_setor_destino, substr(cd_setor_prontuario_p,2,length(cd_setor_prontuario_p))) = substr(cd_setor_prontuario_p,1,1));
		exception
		when others then
			ie_insere_w := 'N';
			goto final;
		end;

		end;
	end if;

	if (ie_conta_opme_sus_p <> 'A') then

		select	count(nr_sequencia)
		into STRICT	qt_existe_w
		from	procedimento_paciente
		where	nr_interno_conta = nr_interno_conta_w
		and	coalesce(cd_motivo_exc_conta::text, '') = ''
		and	ie_origem_proced = 7
		and	Sus_Obter_Estrut_Proc(cd_procedimento, ie_origem_proced, 'C', 'G') = '7'  LIMIT 1;

		if (ie_conta_opme_sus_p = 'S') and (qt_existe_w = 0) then
			ie_insere_w := 'N';
			goto final;
		elsif (ie_conta_opme_sus_p = 'N') and (qt_existe_w > 0) then
			ie_insere_w := 'N';
			goto final;
		end if;

	end if;

	if (ie_conta_opme_p <> 'A') then

		ds_grupo_opme_param_w := obter_valor_param_usuario(1121, 45, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p);

		if (ds_grupo_opme_param_w IS NOT NULL AND ds_grupo_opme_param_w::text <> '') then

			select	count(a.nr_sequencia)
			into STRICT	qt_existe_w
			from	material_atend_paciente a
			where	a.nr_interno_conta = nr_interno_conta_w
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
			and	obter_classif_material_proced(a.cd_material, null, null) in (1,5,7,10)
			and	obter_se_contido_char(obter_estrutura_material(a.cd_material,'G'), ds_grupo_opme_param_w) = 'S'  LIMIT 1;

			if (ie_conta_opme_p = 'S') and (qt_existe_w = 0) then
				ie_insere_w := 'N';
				goto final;
			elsif (ie_conta_opme_p = 'N') and (qt_existe_w > 0) then
				ie_insere_w := 'N';
				goto final;
			end if;
		end if;


	end if;

	if (nr_seq_tp_pend_conta_p IS NOT NULL AND nr_seq_tp_pend_conta_p::text <> '') then
		begin

		begin
		nr_seq_estagio_w := (coalesce(obter_valor_param_usuario(1121,46,obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p),'0'))::numeric;
		exception
		when others then
			nr_seq_estagio_w := 0;
		end;

		if (nr_seq_estagio_w > 0) then
			begin

			begin
			select	count(a.nr_sequencia)
			into STRICT	qt_tipo_pend_cta_w
			from	cta_pendencia a
			where	a.nr_atendimento = nr_atendimento_w
			and	a.nr_interno_conta = nr_interno_conta_w
			and	obter_se_contido(a.nr_seq_tipo, substr(nr_seq_tp_pend_conta_p,2,length(nr_seq_tp_pend_conta_p))) = substr(nr_seq_tp_pend_conta_p,1,1)
			and	a.nr_seq_estagio = nr_seq_estagio_w  LIMIT 1;
			exception
			when others then
				ie_insere_w	:= 'N';
				goto final;
			end;

			if (qt_tipo_pend_cta_w = 0) then
				ie_insere_w	:= 'N';
				goto final;
			end if;

			end;
		else
			begin

			begin
			select	count(a.nr_sequencia)
			into STRICT	qt_tipo_pend_cta_w
			from	cta_pendencia a
			where	a.nr_atendimento = nr_atendimento_w
			and	a.nr_interno_conta = nr_interno_conta_w
			and	obter_se_contido(a.nr_seq_tipo, substr(nr_seq_tp_pend_conta_p,2,length(nr_seq_tp_pend_conta_p))) = substr(nr_seq_tp_pend_conta_p,1,1)  LIMIT 1;
			exception
			when others then
				ie_insere_w	:= 'N';
				goto final;
			end;

			if (qt_tipo_pend_cta_w = 0) then
				ie_insere_w	:= 'N';
				goto final;
			end if;

			end;
		end if;
		end;
	end if;

	if (nr_seq_estag_conta_p IS NOT NULL AND nr_seq_estag_conta_p::text <> '') then
		begin

		begin
		select	count(a.nr_sequencia)
		into STRICT	qt_estag_pend_cta_w
		from	cta_pendencia a
		where	a.nr_atendimento = nr_atendimento_w
		and	a.nr_interno_conta = nr_interno_conta_w
		and	obter_se_contido(a.nr_seq_estagio, substr(nr_seq_estag_conta_p,2,length(nr_seq_estag_conta_p))) = substr(nr_seq_estag_conta_p,1,1)  LIMIT 1;
		exception
		when others then
			ie_insere_w	:= 'N';
			goto final;
		end;

		if (qt_estag_pend_cta_w = 0) then
			ie_insere_w	:= 'N';
			goto final;
		end if;

		end;
	end if;


	if (nm_usu_ult_etapa_p IS NOT NULL AND nm_usu_ult_etapa_p::text <> '') and (obter_se_contido_char(nm_ultimo_usuario_w,substr(nm_usu_ult_etapa_p,2,length(nm_usu_ult_etapa_p))) <> substr(nm_usu_ult_etapa_p,1,1)) then
		ie_insere_w	:= 'N';
		goto final;
	end if;

	if (coalesce(ie_visual_empresa_p,'N') = 'S') and (cd_empresa_w IS NOT NULL AND cd_empresa_w::text <> '') then
		begin

		select	substr(nm_empresa,1,255)
		into STRICT	ds_empresa_referencia_w
		from	empresa_referencia
		where	cd_empresa = cd_empresa_w  LIMIT 1;

		end;
	end if;

<<final>>
	if (ie_insere_w = 'S') and (nr_interno_conta_w IS NOT NULL AND nr_interno_conta_w::text <> '') and (nr_interno_conta_w <> 0) then
		begin
		insert into w_eis_conta_pendente(	nr_sequencia,
						cd_estabelecimento,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						cd_pessoa_fisica,
						nr_interno_conta,
						ds_etapa,
						ds_etapa_conta_obs,
						nm_usuario_conta,
						cd_guia,
						ds_ultima_etapa,
						dt_ultima_etapa,
						cd_medico_exec,
						cd_setor_destino,
						cd_unidade_pac,
						cd_setor_atendimento,
						cd_convenio,
						cd_categoria,
						vl_conta,
						vl_conta_sus,
						nr_atendimento,
						cd_procedimento,
						ie_origem_proced,
						nr_seq_protocolo,
						cd_setor_etapa,
						dt_conta_protocolo,
						dt_prev_protocolo,
						ie_status_acerto,
						cd_procedencia,
						nm_ult_usuario_etapa,
						ds_setor_etapa_filtro,
						nr_seq_proc,
						ds_status_atend,
						ds_cod_setores_conta,
						ds_municipio,
						ds_ult_usuario_etapa,
						ie_ult_etapa_receb,
						nm_usuario_receb_etapa,
						ds_usuario_receb_etapa,
						ie_tipo_atend_tiss,
						ds_tipo_atend_tiss,
						cd_setor_inicial,
						nm_paciente,
						ds_conv,
						ds_setor_atend,
						ds_setor_etapa_conta,
						nm_medico_resp,
						ds_tipo_atend,
						dt_entrada_pac,
						dt_alta_pac,
						ds_proced,
						cd_pessoa_etapa,
						nm_pessoa_etapa_conta,
						ds_motivo_devol,
						nm_usuario_recep_atend,
						ds_status_conta,
						ds_proced_atend,
						ds_obs_conta,
						qt_dias_atraso_atend,
						nm_estabelecimento,
						dt_periodo_ini_conta,
						dt_periodo_fim_conta,
						qt_dif_datas_alta_prot,
						ds_tipo_guia_cta,
						ds_categ_conv,
						cd_setor_atual,
						ds_agrup_setor_atual,
						ds_setor_atual,
						ds_agrup_setor,
						ds_setor_dest,
						cd_senha_atend,
						cd_usuario_conv,
						ds_setor_ini,
						nr_seq_classif_etapa,
						ds_classif_etapa,
						ds_empresa_referencia)
					values (nextval('w_eis_conta_pendente_seq'),
						cd_estabelecimento_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						cd_pessoa_fisica_w,
						nr_interno_conta_w,
						coalesce(ds_etapa_w,'Não Informado'),
						ds_etapa_conta_obs_w,
						nm_usuario_w,
						cd_guia_w,
						coalesce(ds_etapa_w,'Não Informado'),
						dt_ultima_etapa_w,
						cd_medico_exec_w,
						cd_setor_destino_w,
						cd_unidade_pac_w,
						cd_setor_atendimento_w,
						cd_convenio_w,
						cd_categoria_convenio_w,
						CASE WHEN ie_valor_conta_p='S' THEN vl_conta_w  ELSE 0 END ,
						CASE WHEN ie_valor_conta_sus_p='S' THEN vl_conta_sus_w  ELSE 0 END ,
						nr_atendimento_w,
						cd_procedimento_w,
						ie_origem_proced_w,
						nr_seq_protocolo_w,
						cd_setor_etapa_w,
						dt_conta_protocolo_w,
						dt_prev_protocolo_w,
						ie_status_conta_w,
						cd_procedencia_w,
						nm_ultimo_usuario_w,
						ds_setor_etapa_filtro_w,
						nr_sequencia_proc_w,
						ds_status_atend_w,
						ds_cod_setores_conta_w,
						ds_municipio_w,
						ds_ultimo_usuario_w,
						ie_etapa_recebida_w,
						nm_ultimo_usu_receb_w,
						ds_usuario_receb_etapa_w,
						ie_tipo_atend_tiss_w,
						ds_tipo_atend_tiss_w,
						CASE WHEN cd_setor_inicial_w=0 THEN null  ELSE cd_setor_inicial_w END ,
						nm_pessoa_fisica_w,
						ds_convenio_w,
						ds_setor_atendimento_w,
						ds_setor_etapa_w,
						nm_medico_exec_w,
						ds_tipo_atendimento_w,
						dt_entrada_w,
						dt_alta_w,
						ds_procedimento_w,
						cd_pessoa_etapa_ww,
						nm_pessoa_etapa_w,
						ds_motivo_devol_w,
						nm_usuario_recep_atend_w,
						ds_status_conta_w,
						ds_proced_atend_w,
						ds_obs_conta_w,
						qt_dias_atraso_atend_w,
						nm_estabelecimento_w,
						dt_periodo_ini_conta_w,
						dt_periodo_fim_conta_w,
						qt_dif_datas_alta_prot_w,
						ds_tipo_guia_cta_w,
						ds_categ_conv_w,
						cd_setor_atual_w,
						ds_agrup_setor_atual_w,
						ds_setor_atual_w,
						ds_agrup_setor_w,
						ds_setor_destino_w,
						cd_senha_w,
						cd_usuario_convenio_w,
						ds_setor_inicial_w,
						nr_seq_classif_etapa_w,
						ds_classif_etapa_w,
						ds_empresa_referencia_w);
		end;
	end if;
	end;
	end loop;
	commit;
end loop;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_eis_contas_pendentes ( dt_inicial_p timestamp, dt_final_p timestamp, ie_data_p text, ie_pac_alta_p text, ie_titulo_p text, ie_nota_fiscal_p text, ie_setor_atual_p text, ie_contas_canceladas_p text, ie_guias_conta_p text, ie_data_etapa_p text, ie_pac_internado_p text, ie_conta_fechada_p text, ie_maiores_zero_p text, ie_setor_pac_p text, ie_com_aih_p text, ie_com_apac_p text, ie_conta_sem_etapa_p text, ie_conta_etapa_pend_p text, ie_filtrar_estab_conta_p text, ie_retornos_p text, ie_contas_protocolo_p text, vl_inicial_p bigint, vl_final_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, cd_convenios_p text, cd_categorias_p text, ie_tipos_atendimento_p text, ie_tipos_convenio_p text, ie_status_conta_p text, cd_etapas_p text, cd_medicos_p text, cd_setores_p text, ie_lanc_setor_p text, ie_filtrar_estab_atend_p text, cd_setores_etapa_p text, cd_pessoas_etapa_p text, ie_valor_conta_p text, ie_valor_conta_sus_p text, ie_clinicas_p text, cd_procedimento_p text, cd_grupo_proc_p text, cd_area_procedimento_p text, cd_especialidade_p text, cd_planos_p text, ie_complexidade_p text, cd_setores_ult_int_p text, cd_motivos_devol_etapa_p text, cd_tipos_procedimento_p text, ie_status_protocolo_p text, cd_municipio_p text, cd_classif_setor_p text, cd_procedencia_p text, nm_usuario_etapa_p text, cd_setor_valor_p text, cd_estab_conta_p text, ie_conta_sem_proced_p text, cd_responsavel_conta_p text, ie_tipos_atend_conta_p text, ie_tipo_guia_conv_p text, cd_motivo_alta_p text, ie_tipo_protocolo_p text, cd_setor_destino_p text, nr_seq_estagio_aut_p text, nr_seq_estagio_conta_p text, nr_seq_grupo_sus_p text, nr_seq_subgrupo_sus_p text, nr_seq_forma_org_sus_p text, cd_setor_entrega_prescr_p text, cd_tipo_regulacao_p text, cd_tipo_serv_regulacao_p text, qt_dias_etapa_p bigint, cd_tipo_acomodacao_p text, ie_conta_perda_p text, nr_seq_classif_atend_p text, cd_setor_prescr_proced_p text, nr_atendimento_p bigint, dt_ref_protocolo_p timestamp, ie_cod_setores_conta_p text, nm_usuario_recep_atend_p text, nr_seq_tipo_lib_guia_p text, nm_usuario_recebimento_p text, ie_ult_etapa_receb_p text, qt_dias_atraso_p bigint, cd_agrupamento_setor_p text, ie_carater_inter_sus_p text, ie_listar_proced_p text, ie_situacao_titulo_p text, ie_etapa_conta_p text default '0', ie_conta_sem_matmed_p text DEFAULT NULL, ie_laudo_paciente_p text DEFAULT NULL, nr_seq_pessoa_classif_p text DEFAULT NULL, ie_atend_cancel_p text DEFAULT NULL, cd_setor_inicial_p text DEFAULT NULL, ie_protocolo_doc_p text DEFAULT NULL, cd_setor_prontuario_p text DEFAULT NULL, ie_conta_opme_sus_p text DEFAULT NULL, ie_conta_opme_p text DEFAULT NULL, nr_seq_tp_pend_conta_p text DEFAULT NULL, nr_seq_protocolo_p bigint DEFAULT NULL, nr_seq_estag_conta_p text DEFAULT NULL, nm_usu_ult_etapa_p text DEFAULT NULL, ie_visual_empresa_p text DEFAULT NULL) FROM PUBLIC;

