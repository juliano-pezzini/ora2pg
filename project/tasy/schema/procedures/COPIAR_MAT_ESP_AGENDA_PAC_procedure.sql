-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_mat_esp_agenda_pac (nr_seq_autorizacao_p bigint, nr_seq_agenda_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_material_w		bigint;
qt_solicitada_w		double precision;
qt_autorizada_w		double precision;
ds_observacao_w		varchar(4000);
nr_seq_marca_w		bigint;
cd_cgc_fornec_w		varchar(14);
qt_material_w		double precision;
ie_estagio_autor_w	varchar(1);
ie_autorizado_w		varchar(3);
ds_parametro_76_w	varchar(1);

c01 CURSOR FOR
SELECT	a.cd_material,
	a.qt_solicitada,
	a.qt_material,
	a.ds_observacao,
	a.nr_seq_marca,
	a.cd_cgc_fornec
from	material_autor_cirurgia a
where	a.nr_seq_autorizacao	= nr_seq_autorizacao_p
AND 	(((coalesce(ds_parametro_76_w, 'T') = 'A') AND (coalesce(a.ie_aprovacao,'N') = 'S')) OR (coalesce(ds_parametro_76_w, 'T') = 'T'))
and	not exists (select	1
	from	agenda_pac_opme x
	where	x.nr_seq_agenda	= nr_seq_agenda_p
	and	x.cd_material	= a.cd_material);


BEGIN

ds_parametro_76_w := Obter_Param_Usuario(3006, 76, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ds_parametro_76_w);

select	max(ie_estagio_autor)
into STRICT	ie_estagio_autor_w
from	autorizacao_cirurgia
where	nr_sequencia	= nr_seq_autorizacao_p;

open C01;
loop
fetch C01 into
	cd_material_w,
	qt_solicitada_w,
	qt_autorizada_w,
	ds_observacao_w,
	nr_seq_marca_w,
	cd_cgc_fornec_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (ie_estagio_autor_w in ('3','8','7')) then --Autorizado
		qt_material_w	:= coalesce(qt_autorizada_w,qt_solicitada_w);
		ie_autorizado_w	:= 'A';
	else
		qt_material_w	:= qt_solicitada_w;
		ie_autorizado_w	:= 'P';
	end if;
	insert into agenda_pac_opme(nr_sequencia,
		dt_atualizacao,
		dt_atualizacao_nrec,
		nm_usuario,
		nm_usuario_nrec,
		cd_cgc,
		cd_material,
		ds_observacao,
		ie_autorizado,
		ie_gerar_autor,
		ie_origem_inf,
		ie_padrao,
		nr_seq_agenda,
		nr_seq_apres,
		nr_seq_marca,
		qt_material)
	values (nextval('agenda_pac_opme_seq'),
		clock_timestamp(),
		clock_timestamp(),
		nm_usuario_p,
		nm_usuario_p,
		cd_cgc_fornec_w,
		cd_material_w,
		ds_observacao_w,
		ie_autorizado_w,
		'N',
		'I',
		'S',
		nr_seq_agenda_p,
		500,
		nr_seq_marca_w,
		qt_material_w);
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_mat_esp_agenda_pac (nr_seq_autorizacao_p bigint, nr_seq_agenda_p bigint, nm_usuario_p text) FROM PUBLIC;

