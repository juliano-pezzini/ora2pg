-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_item_auditado (nr_devolucao_p bigint, cd_tipo_baixa_p bigint, nm_usuario_p text, nr_sequencia_p bigint, ds_retorno_p INOUT text) AS $body$
DECLARE

 
dt_atendimento_w		timestamp;
ie_conta_paciente_w		varchar(1);
nr_atendimento_w		bigint;
nm_usuario_auditor_w		varchar(15);
qt_auditoria_w			integer	:= 0;
qt_item_w			integer;
nr_interno_conta_w		bigint;
ie_auditoria_w			varchar(1);
cd_estabelecimento_w		smallint;
ie_forma_consiste_w		varchar(2);
ds_erro_item_w			varchar(255);


BEGIN 
-- Este item está dentro do período auditado. 
ds_erro_item_w := wheb_mensagem_pck.get_texto(298999);
 
ds_retorno_p	:= '';
 
/*Obter se o tipo de baixa atualiza conta */
 
select	coalesce(max(ie_conta_paciente),'N') 
into STRICT	ie_conta_paciente_w 
from	tipo_baixa_prescricao 
where	cd_tipo_baixa		= cd_tipo_baixa_p 
and	ie_prescricao_devolucao	= 'D';
 
/* Obter o atendimento da devolução */
 
select	nr_atendimento 
into STRICT	nr_atendimento_w 
from	devolucao_material_pac 
where	nr_devolucao = nr_devolucao_p;
 
select	count(*) 
into STRICT	qt_item_w 
from	material_atend_paciente b, 
	item_devolucao_material_pac a 
where	a.nr_seq_atendimento	= b.nr_sequencia 
and	a.nr_devolucao		= nr_devolucao_p;
 
cd_estabelecimento_w := obter_estab_atend(nr_atendimento_w);	
ie_forma_consiste_w := obter_param_usuario(42, 104, Obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, ie_forma_consiste_w);
 
if (nr_sequencia_p = 0) then 
	begin 
	 
	if (qt_item_w > 0) and (ie_forma_consiste_w <> 'N') then 
		 
		select	count(*) 
		into STRICT	qt_item_w 
		from	material_atend_paciente b, 
			item_devolucao_material_pac a 
		where	((ie_auditoria = ie_forma_consiste_w) or (ie_forma_consiste_w = 'AS' and (ie_auditoria = 'A' or ie_auditoria = 'S'))) 
		and	a.nr_seq_atendimento = b.nr_sequencia 
		and	a.nr_devolucao = nr_devolucao_p;
		 
		if (qt_item_w > 0) and (ie_conta_paciente_w = 'S') then 
			ds_retorno_p := wheb_mensagem_pck.get_texto(298996);
		end if;
		 
	end if;
	 
	/*open c01; 
	loop 
	fetch c01 into 
		dt_atendimento_w, 
		nr_interno_conta_w; 
	exit when c01%notfound; 
 
 
		select	count(*) 
		into	qt_auditoria_w 
		from	auditoria_conta_paciente 
		where	nr_atendimento = nr_atendimento_w 
		and	nr_interno_conta = nr_interno_conta_w 
		and	dt_atendimento_w between dt_periodo_inicial and dt_periodo_final; /* 
		 
		/* thlima - 21/01/2010 - para deixar igual a trigger material_paciente_insert e as consistencias da conta paciente */
 
		/*and		dt_liberacao is not null 
		and		dt_atendimento_w between dt_auditoria and nvl(dt_liberacao,sysdate); /*À pedido do Ricardo e Daniel, incluído nvl sysdate - OS136931*/
 
 
		/*select	nvl(max(nm_usuario),nm_usuario_p) 
		into	nm_usuario_auditor_w 
		from	auditoria_conta_paciente 
		where	nr_atendimento	= nr_atendimento_w 
		and 	dt_liberacao is null 
		and	dt_atendimento_w between dt_periodo_inicial and dt_periodo_final; 
 
		if (qt_item_w = 1) then 
 
			if	(qt_auditoria_w > 0) and (ie_conta_paciente_w = 'S') then 
				ds_retorno_p	:= 'Este item está dentro do período auditado.'; 
			elsif (nm_usuario_auditor_w <> nm_usuario_p) and (ie_conta_paciente_w = 'S') then 
				ds_retorno_p	:= 'Este item está dentro do período auditado.'; 
			end if; 
		else	 
			if	(qt_auditoria_w > 0) and (ie_conta_paciente_w = 'S') then 
 
				ds_retorno_p	:= 'Existem itens desta devolução que estão dentro do período auditado,' || chr(13) || 
						  'para baixar a devolução, você deve selecionar um motivo de baixa que não atualize a conta do paciente.'; 
			elsif (nm_usuario_auditor_w <> nm_usuario_p) and (ie_conta_paciente_w = 'S') then 
				ds_retorno_p	:= 'Existem itens desta devolução que estão dentro do período auditado,' || chr(13) || 
						  'para baixar a devolução, você deve selecionar um motivo de baixa que não atualize a conta do paciente.'; 
			end if; 
		end if;	 
	end loop; 
	close c01;*/
 
	end;
else 
	begin 
	 
	select	coalesce(max(ie_auditoria),'N') 
	into STRICT	ie_auditoria_w 
	from	material_atend_paciente 
	where	nr_sequencia = nr_sequencia_p;
	 
	if (ie_forma_consiste_w = 'A') and (ie_auditoria_w = 'A') and (ie_conta_paciente_w = 'S') then 
		ds_retorno_p := ds_erro_item_w;
	elsif (ie_forma_consiste_w = 'S') and (ie_auditoria_w = 'S') and (ie_conta_paciente_w = 'S') then 
		ds_retorno_p := ds_erro_item_w;
	elsif (ie_forma_consiste_w = 'AS') and ((ie_auditoria_w = 'A') or (ie_auditoria_w = 'S')) and (ie_conta_paciente_w = 'S') then 
		ds_retorno_p := ds_erro_item_w;
	end if;
	 
	/*open c02; 
	loop 
	fetch c02 into 
		dt_atendimento_w, 
		nr_interno_conta_w; 
	exit when c02%notfound; 
	 
		select	count(*) 
		into	qt_auditoria_w 
		from	auditoria_conta_paciente 
		where	nr_atendimento = nr_atendimento_w 
		and	nr_interno_conta = nr_interno_conta_w 
		and	dt_atendimento_w between dt_periodo_inicial and dt_periodo_final; 
		 
		select	nvl(max(nm_usuario),nm_usuario_p) 
		into	nm_usuario_auditor_w 
		from	auditoria_conta_paciente 
		where	nr_atendimento	= nr_atendimento_w 
		and 	dt_liberacao is null 
		and	dt_atendimento_w between dt_periodo_inicial and dt_periodo_final; 
 
		if	(qt_auditoria_w > 0) and (ie_conta_paciente_w = 'S') then 
			ds_retorno_p	:= 'Este item está dentro do período auditado.'; 
		elsif	(qt_auditoria_w > 0) and (nm_usuario_auditor_w <> nm_usuario_p) and (ie_conta_paciente_w = 'S') then 
			ds_retorno_p	:= 'Este item está dentro do período auditado.'; 
		end if; 
		 
	end loop; 
	close c02;*/
 
	end;
end if;
	 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_item_auditado (nr_devolucao_p bigint, cd_tipo_baixa_p bigint, nm_usuario_p text, nr_sequencia_p bigint, ds_retorno_p INOUT text) FROM PUBLIC;

