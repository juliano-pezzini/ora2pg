-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_atualizar_ativ_estagio ( nr_sequencia_p bigint, ie_opcao_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_minuto_ant_w		double precision := 0;
qt_existe_w		bigint;

nr_seq_estagio_w		bigint;
qt_minuto_w		bigint := 0;
nr_sequencia_w		bigint;
nr_seq_ordem_serv_w	bigint;
ie_situacao_os_w		bigint;
ie_status_ordem_w		bigint;


/* IE_OPCAO
1 - Quando Insert
3 - Quando Delete
2 - Quando Edit
*/
BEGIN

if (ie_opcao_p in (1,2)) then
	begin
	select	qt_minuto,
		nr_seq_estagio,
		nr_seq_ordem_serv
	into STRICT	qt_minuto_w,
		nr_seq_estagio_w,
		nr_seq_ordem_serv_w
	from	man_ordem_serv_ativ
	where	nr_sequencia = nr_sequencia_p;

	select	ie_status_ordem
	into STRICT	ie_status_ordem_w
	from	man_ordem_servico
	where	nr_sequencia = nr_seq_ordem_serv_w;

	select	max(ie_situacao_os)
	into STRICT	ie_situacao_os_w
	from	man_estagio_processo
	where	nr_sequencia    = nr_seq_estagio_w;

	if (coalesce(ie_situacao_os_w,3) = 3) then
		ie_situacao_os_w := ie_status_ordem_w;
	end if;

	select	max(nr_sequencia)
	into STRICT	nr_sequencia_w
	from	man_os_estagio_ativ
	where	nr_seq_os_ativ = nr_sequencia_p;

	if (coalesce(nr_sequencia_w,0) = 0) and (coalesce(nr_seq_estagio_w,0) > 0) then
		insert into man_os_estagio_ativ(nr_sequencia,
						nr_seq_ordem_servico,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						qt_minuto,
						nr_seq_estagio,
						nr_seq_os_ativ)
					values (	nextval('man_os_estagio_ativ_seq'),
						nr_seq_ordem_serv_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						qt_minuto_w,
						nr_seq_estagio_w,
						nr_sequencia_p);
	elsif (coalesce(nr_sequencia_w,0) > 0) and (coalesce(nr_seq_estagio_w,0) > 0) then
		update 	man_os_estagio_ativ
		set	qt_minuto 		= qt_minuto_w,
			nr_seq_estagio		= nr_seq_estagio_w
		where	nr_seq_os_ativ		= nr_sequencia_p;

	end if;

	update	man_ordem_servico
	set	nr_seq_estagio 	= coalesce(nr_seq_estagio_w,nr_seq_estagio),
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp(),
		ie_status_ordem	= ie_situacao_os_w
	where	nr_sequencia	= nr_seq_ordem_serv_w;

	end;
elsif (ie_opcao_p = 3) then
	begin
	delete	from man_os_estagio_ativ
	where	nr_seq_os_ativ	= nr_sequencia_p;
	end;
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_atualizar_ativ_estagio ( nr_sequencia_p bigint, ie_opcao_p bigint, nm_usuario_p text) FROM PUBLIC;

