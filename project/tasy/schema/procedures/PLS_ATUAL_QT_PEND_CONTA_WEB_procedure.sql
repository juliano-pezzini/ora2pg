-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atual_qt_pend_conta_web (nr_seq_conta_p bigint, nr_seq_guia_p bigint) AS $body$
DECLARE


qt_saldo_saldo_w	double precision;
nr_seq_autor_mat_w	bigint;
nr_seq_autor_proc_w	bigint;

C01 CURSOR FOR
	SELECT	coalesce(sum(a.qt_proc_relacionado),0),
		nr_seq_autor_mat,
		nr_seq_autor_proc
	from	pls_conta_autor a,
		pls_conta b
	where	a.nr_seq_conta = b.nr_sequencia
	and	a.nr_seq_autor = nr_seq_guia_p
	and	a.nr_seq_conta <> nr_seq_conta_p
	and	b.ie_estagio_complemento <> '1'
	group by nr_seq_autor_mat, nr_seq_autor_proc;


BEGIN

open C01;
loop
fetch C01 into
	qt_saldo_saldo_w,
	nr_seq_autor_mat_w,
	nr_seq_autor_proc_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
		if (coalesce(nr_seq_autor_proc_w,0) > 0) then
			-- Procedimento
			update	pls_conta_proc
			set	qt_procedimento_imp = (qt_procedimento_imp-qt_saldo_saldo_w),
				qt_procedimento = (qt_procedimento-qt_saldo_saldo_w),
				qt_autorizado = (qt_autorizado-qt_saldo_saldo_w)
			where	nr_sequencia = (SELECT	coalesce(max(nr_seq_conta_proc),0)
						from	pls_conta_autor
						where	nr_seq_conta = nr_seq_conta_p
						and	nr_seq_autor_proc = nr_seq_autor_proc_w);
		else
			--Material
			update	pls_conta_mat
			set	qt_material_imp = (qt_material_imp-qt_saldo_saldo_w),
				qt_material = (qt_material-qt_saldo_saldo_w),
				qt_autorizado = (qt_autorizado-qt_saldo_saldo_w)
			where	nr_sequencia = (SELECT	coalesce(max(nr_seq_conta_proc),0)
						from	pls_conta_autor
						where	nr_seq_conta = nr_seq_conta_p
						and	nr_seq_autor_mat = nr_seq_autor_mat_w);
		end if;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atual_qt_pend_conta_web (nr_seq_conta_p bigint, nr_seq_guia_p bigint) FROM PUBLIC;

