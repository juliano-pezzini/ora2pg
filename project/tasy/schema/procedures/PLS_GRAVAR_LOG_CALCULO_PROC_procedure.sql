-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gravar_log_calculo_proc ( ie_gravar_log_p text, nr_seq_procedimento_p bigint, cd_estabelecimento_p bigint, ds_log_calculo_p text, ds_observacao_p text, ds_procedure_p text, vl_procedimento_p bigint, vl_filme_p bigint, vl_custo_operacional_p bigint, vl_medico_p bigint, vl_auxiliares_p bigint, vl_anestesista_p bigint, nr_seq_apresentacao_p bigint, nr_seq_regra_preco_p bigint, cd_porte_anestesico_p bigint, nr_auxiliares_p bigint, ie_tipo_tabela_p text, nm_tabela_p text, nm_usuario_p text) AS $body$
DECLARE


ds_log_calculo_w		varchar(255);
ie_tipo_despesa_w		varchar(1);
ie_calculo_pacote_w		varchar(1);
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
cd_edicao_amb_w			bigint;
cd_moeda_ch_medico_w		smallint;
cd_moeda_ch_co_w		smallint;
cd_moeda_filme_w		smallint;
cd_moeda_anestesista_w		smallint;
ie_tipo_log_w			pls_log_calculo_mat.ie_tipo_log%type := 'C';


BEGIN
if (ie_gravar_log_p = 'S') then
	begin
	select	cd_procedimento,
		ie_origem_proced,
		ie_tipo_despesa
	into STRICT	cd_procedimento_w,
		ie_origem_proced_w,
		ie_tipo_despesa_w
	from	pls_conta_proc
	where	nr_sequencia	= nr_seq_procedimento_p;
	exception
	when others then
		cd_procedimento_w	:= null;
		ie_origem_proced_w	:= null;
	end;

	if (pls_util_pck.ie_processo_pos_w = 'S') then
		ie_tipo_log_w := 'P';
	end if;

	if (coalesce(nr_seq_regra_preco_p,0) <> 0) then
		select	max(ie_calculo_pacote)
		into STRICT	ie_calculo_pacote_w
		from	pls_parametros
		where	cd_estabelecimento	= cd_estabelecimento_p;

		if (ie_tipo_despesa_w <> '4') or (coalesce(ie_calculo_pacote_w,'P') = 'R') then
			begin
			select	cd_moeda_ch_medico,
				cd_moeda_ch_co,
				cd_moeda_filme,
				cd_moeda_anestesista,
				cd_edicao_amb
			into STRICT	cd_moeda_ch_medico_w,
				cd_moeda_ch_co_w,
				cd_moeda_filme_w,
				cd_moeda_anestesista_w,
				cd_edicao_amb_w
			from	pls_regra_preco_proc
			where	nr_sequencia	= nr_seq_regra_preco_p;
			exception
			when others then
				null;
			end;
		end if;

	end if;

	ds_log_calculo_w	:= '[' || nr_seq_apresentacao_p || '] - ' || ds_log_calculo_p;

	insert into pls_log_calculo_proc(nr_sequencia, nr_seq_procedimento, cd_estabelecimento,
		ds_log_calculo, ds_procedure, dt_atualizacao,
		nm_usuario, vl_procedimento, vl_filme,
		vl_custo_operacional, vl_medico, vl_auxiliares,
		vl_anestesista, cd_procedimento, ie_origem_proced,
		ds_observacao, nr_seq_apresentacao, cd_moeda_ch_medico,
		cd_moeda_ch_co, cd_moeda_filme, cd_moeda_anestesista,
		cd_edicao_amb, nr_seq_regra_preco, cd_porte_anestesico,
		nr_auxiliares, ie_tipo_tabela, nm_tabela, ie_tipo_log)
	values (nextval('pls_log_calculo_proc_seq'), nr_seq_procedimento_p, cd_estabelecimento_p,
		ds_log_calculo_w, ds_procedure_p, clock_timestamp(),
		nm_usuario_p, vl_procedimento_p, vl_filme_p,
		vl_custo_operacional_p, vl_medico_p, vl_auxiliares_p,
		vl_anestesista_p, cd_procedimento_w, ie_origem_proced_w,
		ds_observacao_p, nr_seq_apresentacao_p, cd_moeda_ch_medico_w,
		cd_moeda_ch_co_w, cd_moeda_filme_w, cd_moeda_anestesista_w,
		cd_edicao_amb_w, nr_seq_regra_preco_p, cd_porte_anestesico_p,
		nr_auxiliares_p, ie_tipo_tabela_p, nm_tabela_p, ie_tipo_log_w);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gravar_log_calculo_proc ( ie_gravar_log_p text, nr_seq_procedimento_p bigint, cd_estabelecimento_p bigint, ds_log_calculo_p text, ds_observacao_p text, ds_procedure_p text, vl_procedimento_p bigint, vl_filme_p bigint, vl_custo_operacional_p bigint, vl_medico_p bigint, vl_auxiliares_p bigint, vl_anestesista_p bigint, nr_seq_apresentacao_p bigint, nr_seq_regra_preco_p bigint, cd_porte_anestesico_p bigint, nr_auxiliares_p bigint, ie_tipo_tabela_p text, nm_tabela_p text, nm_usuario_p text) FROM PUBLIC;

