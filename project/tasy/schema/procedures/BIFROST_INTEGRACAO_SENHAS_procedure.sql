-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE bifrost_integracao_senhas (nr_seq_senha_p bigint, nr_seq_integracao_p bigint DEFAULT 1681) AS $body$
DECLARE

    js_dados_w      philips_json;
    js_list_monitor philips_json_list;

    ds_guiche_w          varchar(2000);
    cd_senha_w           varchar(2000);
    ds_maquina_chamada_w varchar(2000);
    nm_computador_w      varchar(2000);

    ds_event_w            varchar(100);
    ds_message_response_w text;
    c_dados_1681 CURSOR FOR
        SELECT substr(obter_guiche_maquina_curto(psf.nr_sequencia), 1, 100) ds_guiche,
               substr(obter_letra_verifacao_senha(coalesce(nr_seq_fila_senha_origem, nr_seq_fila_senha)), 1, 10) ||
               cd_senha_gerada cd_senha,
               ds_maquina_chamada,
               nr_seq_comp_monitor,
               ds_local,
               nm_computador
          FROM paciente_senha_fila psf
LEFT OUTER JOIN (SELECT f.nr_sequencia,
                       f.nr_seq_comp_monitor,
                       f.ds_local,
                       (SELECT cp.nm_computador FROM computador cp WHERE cp.nr_sequencia = f.nr_seq_comp_monitor) AS nm_computador
                  FROM maquina_local_senha f
                 WHERE f.ie_situacao = 'A'

UNION ALL

                SELECT h.nr_sequencia,
                       g.nr_seq_comp_monitor,
                       h.ds_local,
                       (SELECT cp.nm_computador FROM computador cp WHERE cp.nr_sequencia = g.nr_seq_comp_monitor) AS nm_computador
                  FROM maquina_local_senha       h,
                       maquina_monitor_adicional g
                 WHERE g.nr_seq_local = h.nr_sequencia
                   AND h.ie_situacao = 'A') mls ON (psf.nr_seq_local_senha = mls.nr_sequencia)
WHERE psf.nr_sequencia = nr_seq_senha_p;

BEGIN
    SELECT MAX(ds_action)
      INTO STRICT ds_event_w
      FROM cliente_integracao c
     WHERE c.nr_seq_inf_integracao = nr_seq_integracao_p
       AND c.ie_situacao IN ('A', 'P');

    IF (ds_event_w IS NOT NULL AND ds_event_w::text <> '') THEN
        js_dados_w      := philips_json();
        js_list_monitor := philips_json_list();

        IF nr_seq_integracao_p = 1681 THEN
            FOR i IN c_dados_1681 LOOP
                js_list_monitor.append(i.ds_local);
                ds_guiche_w          := i.ds_guiche;
                cd_senha_w           := i.cd_senha;
                ds_maquina_chamada_w := i.ds_maquina_chamada;
                nm_computador_w:= i.nm_computador;

            END LOOP;
            js_dados_w.put('guiche', ds_guiche_w);
            js_dados_w.put('senha', cd_senha_w);
            js_dados_w.put('maquina', ds_maquina_chamada_w);
            js_dados_w.put('computador', nm_computador_w );
            js_dados_w.put('local', js_list_monitor);

        END IF;

        dbms_lob.createtemporary(ds_message_response_w, TRUE);
        js_dados_w.(ds_message_response_w);
        ds_message_response_w := bifrost.send_integration_content(ds_event_w,
                                                                  ds_message_response_w,
                                                                  obter_usuario_ativo);

    END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE bifrost_integracao_senhas (nr_seq_senha_p bigint, nr_seq_integracao_p bigint DEFAULT 1681) FROM PUBLIC;

