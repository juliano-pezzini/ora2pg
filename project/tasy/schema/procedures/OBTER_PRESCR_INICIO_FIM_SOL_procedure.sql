-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_prescr_inicio_fim_sol (nr_atendimento_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, dt_plano_p text, dt_referencia_p timestamp, nm_usuario_p text, ie_sol_vigentes_p text, ie_sol_continuas_p text, ie_plano_por_setor_p text, ie_prescr_usuario_p text, ie_estendidos_p text, ie_exibir_hor_suspensos_p text, ie_edicao_p text, nr_prescricao_inicial_p INOUT bigint, nr_prescricao_final_p INOUT bigint) AS $body$
DECLARE

 
nr_prescr_inicial_sol_w	bigint;
nr_prescr_final_sol_w	bigint;

BEGIN
select	coalesce(min(a.nr_prescricao),0), 
	coalesce(max(a.nr_prescricao),0) 
into STRICT	nr_prescr_inicial_sol_w, 
	nr_prescr_final_sol_w	 
from	prescr_solucao x, 
	prescr_medica a 
where	x.nr_prescricao = a.nr_prescricao 
and	a.nr_atendimento = nr_atendimento_p 
and	coalesce(x.nr_seq_dialise::text, '') = '' 
and	coalesce(a.ie_recem_nato,'N')	= 'N' 
and	coalesce(x.ie_hemodialise, 'N') = 'N' 
and	coalesce(a.ie_adep,'S') = 'S' 
and	((ie_sol_vigentes_p	= 'N') or (obter_se_prescr_vig_adep(a.dt_inicio_prescr,a.dt_validade_prescr,dt_inicial_p,dt_final_p) = 'S') or 
	 ((x.ie_urgencia = 'S') and (exists (	SELECT	1 
			from	prescr_mat_hor b 
			where	b.nr_prescricao = x.nr_prescricao 
			and	b.nr_seq_solucao = x.nr_seq_solucao 
			and	b.dt_horario between dt_inicial_p and dt_final_p)))) 
and	((ie_sol_continuas_p = 'S') or (obter_se_sol_continua(a.nr_prescricao,x.nr_seq_solucao,x.ds_solucao) = 'N'))	 
and	plt_obter_se_item_periodo(	null,				null,			ie_plano_por_setor_p,		dt_plano_p,		null, 
					dt_inicial_p,			dt_final_p,		ie_prescr_usuario_p,		nm_usuario_p,		ie_estendidos_p, 
					dt_referencia_p,		ie_edicao_p,		ie_exibir_hor_suspensos_p,	x.dt_suspensao,		'SOL', 
					x.nr_seq_solucao,		a.nr_prescricao,	'O') = 'S';		
 
nr_prescricao_inicial_p := nr_prescr_inicial_sol_w;
nr_prescricao_final_p	:= nr_prescr_final_sol_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_prescr_inicio_fim_sol (nr_atendimento_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, dt_plano_p text, dt_referencia_p timestamp, nm_usuario_p text, ie_sol_vigentes_p text, ie_sol_continuas_p text, ie_plano_por_setor_p text, ie_prescr_usuario_p text, ie_estendidos_p text, ie_exibir_hor_suspensos_p text, ie_edicao_p text, nr_prescricao_inicial_p INOUT bigint, nr_prescricao_final_p INOUT bigint) FROM PUBLIC;

