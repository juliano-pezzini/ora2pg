-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_senha_atendimento_case ( ds_senha_p text, ie_tipo_atendimento_p bigint, nr_seq_regra_funcao_p text, cd_pessoa_fisica_p text, nr_atendimento_p bigint, ds_retorno_senha_p INOUT text) AS $body$
DECLARE


	ds_retorno_senha_w	atendimento_paciente.ds_senha%type;
	ds_senha_antiga_w       atendimento_paciente.ds_senha%type;
	nr_seq_episodio_w       atendimento_paciente.nr_seq_episodio%type;
	ie_tipo_senha_w         regra_senha_atend.ie_tipo_senha%type;
	cd_estabelecimento_w    bigint;


BEGIN
	if (coalesce(ds_senha_p::text, '') = '') then
	begin
		ds_retorno_senha_w := gerar_senha_atendimento(ie_tipo_atendimento_p, nr_seq_regra_funcao_p, cd_pessoa_fisica_p, null, nr_atendimento_p);

		if (ds_retorno_senha_w IS NOT NULL AND ds_retorno_senha_w::text <> '') then
		begin
			nr_seq_episodio_w := obter_episodio_atendimento(nr_atendimento_p);

			if (nr_seq_episodio_w != 0) then
			begin
				update	atendimento_paciente
				set	ds_senha = ds_retorno_senha_w
				where 	nr_seq_episodio = nr_seq_episodio_w;
			end;
			else
			begin
				update	atendimento_paciente
				set	ds_senha = ds_retorno_senha_w
				where 	nr_atendimento = nr_atendimento_p;
			end;
			end if;
		end;
		end if;

		ds_retorno_senha_p := ds_retorno_senha_w;
	end;
	end if;

	commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_senha_atendimento_case ( ds_senha_p text, ie_tipo_atendimento_p bigint, nr_seq_regra_funcao_p text, cd_pessoa_fisica_p text, nr_atendimento_p bigint, ds_retorno_senha_p INOUT text) FROM PUBLIC;

