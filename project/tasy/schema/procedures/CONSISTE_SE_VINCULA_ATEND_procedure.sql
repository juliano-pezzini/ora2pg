-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_se_vincula_atend ( nr_seq_agenda_p bigint, nr_atendimento_p bigint) AS $body$
DECLARE

															 
ie_tipo_atendimento_w	smallint;
nr_atend_alta_w			bigint;
cd_estabelecimento_w		integer;
cd_perfil_w					integer;
nm_usuario_w				varchar(15);
ie_vinc_atend_alta_w		varchar(15);
ie_so_atend_desfecho_w	varchar(15);	
cd_agenda_w					bigint;
ie_consiste_w				varchar(15);
ie_possui_alta_w			varchar(15);
			
 

BEGIN 
 
cd_estabelecimento_w	:= wheb_usuario_pck.get_cd_estabelecimento;
cd_perfil_w				:= wheb_usuario_pck.get_cd_perfil;
nm_usuario_w			:= wheb_usuario_pck.get_nm_usuario;
 
ie_vinc_atend_alta_w := Obter_Param_Usuario(871, 37, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_vinc_atend_alta_w);
ie_so_atend_desfecho_w := Obter_Param_Usuario(871, 179, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, ie_so_atend_desfecho_w);
 
 
select  max(ie_tipo_atendimento), 
			coalesce(max(nr_atend_alta),0) 
into STRICT		ie_tipo_atendimento_w, 
			nr_atend_alta_w 
from   atendimento_paciente 
where  nr_atendimento = nr_atendimento_p;
 
select	max(cd_agenda) 
into STRICT		cd_agenda_w 
from		agenda_paciente 
where		nr_sequencia = nr_seq_agenda_p;
	 
if (ie_so_atend_desfecho_w = 'S') and (ie_tipo_atendimento_w = 3) and (nr_atend_alta_w = 0) then 
	CALL exibir_erro_abortar(Wheb_mensagem_pck.get_texto(83357),null);
end if;
 
select	max(obter_se_tipo_aten_agenda(ie_tipo_atendimento_w,cd_agenda_w)) 
into STRICT		ie_consiste_w
;
 
if (ie_consiste_w = 'S') then 
	CALL exibir_erro_abortar(Wheb_mensagem_pck.get_texto(83360),null);
end if;	
 
if (ie_vinc_atend_alta_w = 'N') then 
	select	max(substr(obter_se_atendimento_alta(nr_atendimento_p),1,1)) 
	into STRICT		ie_possui_alta_w 
	;
	 
	if (ie_possui_alta_w = 'S') then 
		CALL exibir_erro_abortar(Wheb_mensagem_pck.get_texto(84706),null);
	end if;
end if;	
	 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_se_vincula_atend ( nr_seq_agenda_p bigint, nr_atendimento_p bigint) FROM PUBLIC;

