-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_horario_agenda_exame (cd_agenda_p bigint, dt_horario_p timestamp, qt_duracao_p bigint, ie_horario_p text, ds_consistencia_p INOUT text) AS $body$
DECLARE


qt_horario_w		bigint;
ie_bloqueio_w		varchar(1);
ds_consistencia_w	varchar(255);
qt_amount_w         agenda_horario.nr_amount%type;
ie_sobreposicao_encaixe_w  parametro_agenda.ie_sobreposicao_encaixe%type;
ie_sobreposicao_param_w  parametro_agenda.ie_consiste_duracao%type;
ie_sobrep_encaixe_par_ageint_w varchar(1);
qt_duracao_w  agenda_paciente.nr_minuto_duracao%TYPE;


BEGIN

select  coalesce(max(ie_sobreposicao_encaixe),'S'),
        coalesce(max(ie_consiste_duracao), 'I')
into STRICT    ie_sobreposicao_encaixe_w,
        ie_sobreposicao_param_w
from  	parametro_agenda
where  cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

ie_sobrep_encaixe_par_ageint_w := obter_param_usuario(869, 162, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_sobrep_encaixe_par_ageint_w);

SELECT  CASE WHEN qt_duracao_p=0 THEN 1  ELSE qt_duracao_p END
INTO STRICT    qt_duracao_w 
;

if (cd_agenda_p IS NOT NULL AND cd_agenda_p::text <> '') and (dt_horario_p IS NOT NULL AND dt_horario_p::text <> '') and (qt_duracao_p IS NOT NULL AND qt_duracao_p::text <> '') and (ie_horario_p IS NOT NULL AND ie_horario_p::text <> '') then
	/* encaixe */

	if (ie_horario_p = 'E') then
		/* consistir sobreposicao */

		select	count(*)
		into STRICT	qt_horario_w
		from	agenda_paciente
		where	cd_agenda = cd_agenda_p
		and	PKG_DATE_UTILS.start_of(dt_agenda,'dd',0) = PKG_DATE_UTILS.start_of(dt_horario_p,'dd',0)
		and	hr_inicio > dt_horario_p
		and	ie_Status_agenda	not in ('C','L')
		and	hr_inicio < dt_horario_p + qt_duracao_p / 1440;

		if (qt_horario_w > 0) then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(306559, null); -- The time entered overlaps the next time on the agenda
		end if;

		/* consistir bloqueio */

		ie_bloqueio_w := consistir_bloqueio_agenda(cd_agenda_p, dt_horario_p, obter_cod_dia_semana(dt_horario_p), ie_bloqueio_w);
		
		if (ie_bloqueio_w = 'S') then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(306560, null); -- The informed time is blocked for appointments at the moment
		end if;

	elsif (ie_horario_p = 'S') then
		select	count(*)
		into STRICT	qt_horario_w
		from	agenda_paciente
		where	cd_agenda = cd_agenda_p
		and	PKG_DATE_UTILS.start_of(dt_agenda,'dd',0) = PKG_DATE_UTILS.start_of(dt_horario_p,'dd',0)
		and	hr_inicio = dt_horario_p
		and	ie_status_agenda not in ('C','L');

		qt_amount_w := get_cons_shift_amount(cd_agenda_p,trunc(dt_horario_p, 'MI'), 2);

		if (qt_horario_w >= qt_amount_w) then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(306562, null); --The cancellation status of this schedule cannot be reversed as it is already occupied at the moment
		end if;
	end if;
end if;

ds_consistencia_p := ds_consistencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_horario_agenda_exame (cd_agenda_p bigint, dt_horario_p timestamp, qt_duracao_p bigint, ie_horario_p text, ds_consistencia_p INOUT text) FROM PUBLIC;

