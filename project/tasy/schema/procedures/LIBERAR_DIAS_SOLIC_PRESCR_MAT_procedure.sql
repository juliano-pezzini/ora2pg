-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_dias_solic_prescr_mat ( nr_seq_prescr_mat_p bigint, nr_prescricao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_prescr_mat_w	bigint;
nr_prescricao_w		bigint;			
cd_pessoa_fisica_w	varchar(10);
nr_atendimento_w	bigint;
cd_material_w		bigint;
						
C01 CURSOR FOR 
	SELECT	a.nr_prescricao, 
		a.nr_sequencia 
	from	material c, 
		pessoa_fisica p, 
		pessoa_fisica m, 
		prescr_medica b, 
		atendimento_paciente d, 
		prescr_material a 
	where	a.cd_material		= c.cd_material 
	and	d.nr_atendimento	= b.nr_atendimento 
	and	a.nr_prescricao   	= b.nr_prescricao 
	and	b.cd_medico     	= m.cd_pessoa_fisica 
	and	b.cd_pessoa_fisica  	= p.cd_pessoa_fisica 
	and	b.cd_estabelecimento 	= cd_estabelecimento_p 
	and	b.cd_pessoa_fisica  	= cd_pessoa_fisica_w 
	and	a.cd_material    	= cd_material_w 
	and	b.nr_atendimento   	= nr_atendimento_w 
	and	coalesce(d.dt_alta::text, '') = '' 
	and	(a.ds_justificativa IS NOT NULL AND a.ds_justificativa::text <> '') 
	and	coalesce(a.qt_dias_liberado::text, '') = '' 
	and	(c.cd_medicamento IS NOT NULL AND c.cd_medicamento::text <> '');

BEGIN
 
select	c.cd_pessoa_fisica, 
	c.nr_atendimento, 
	b.cd_material 
into STRICT	cd_pessoa_fisica_w, 
	nr_atendimento_w, 
	cd_material_w 
from  material b, 
    prescr_medica c, 
    prescr_material a 
where a.cd_material    = b.cd_material 
 and c.nr_prescricao   = a.nr_prescricao 
 and a.nr_prescricao   = nr_prescricao_p 
 and a.nr_sequencia    = nr_seq_prescr_mat_p;
 
open C01;
loop 
fetch C01 into	 
	nr_seq_prescr_mat_w, 
	nr_prescricao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	update	prescr_material a 
	set	a.qt_dias_liberado	= coalesce(a.qt_dias_solicitado,0), 
		a.dt_atualizacao	= clock_timestamp(), 
		nm_usuario		= nm_usuario_p 
	where	a.nr_sequencia		= nr_seq_prescr_mat_w 
	and	a.nr_prescricao		= nr_prescricao_w;
	 
	CALL liberar_dias_solic_dias_fut( 
		nr_prescricao_w, 
		nr_seq_prescr_mat_w, 
		wheb_usuario_pck.get_cd_perfil, 
		nm_usuario_p);	
	end;
end loop;
close C01;
 
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_dias_solic_prescr_mat ( nr_seq_prescr_mat_p bigint, nr_prescricao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

