-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pcs_aprov_reprov_emprestimo ( nr_emprestimo_p bigint, nr_emprestimo_ref_p bigint, nr_seq_motivo_p bigint default null, ie_opcao_p text DEFAULT NULL, nm_usuario_p text DEFAULT NULL) AS $body$
DECLARE


/*
ie_opcao
A - Aprovar
R - Reprovar
*/
nr_seq_classif_w		bigint;
nr_seq_comunic_w		comunic_interna.nr_sequencia%type;
ie_ci_lida_w			regra_envio_comunic_evento.ie_ci_lida%type;
ds_titulo_w				regra_envio_comunic_evento.ds_titulo%type;
ds_comunicado_w			regra_envio_comunic_evento.ds_comunicacao%type;
cd_perfil_w				integer;
nm_usuario_destino_w	regra_envio_comunic_evento.nm_usuarios_adic%type;
ds_material_w			material.ds_material%type;
cd_material_w			material.cd_material%type;
nr_seq_regra_w			regra_envio_comunic_evento.nr_sequencia%type;
ds_lista_materiais_w	varchar(4000);
ds_setor_adicional_w	comunic_interna.ds_setor_adicional%type;

c01 CURSOR FOR
	SELECT	cd_material,
			substr(obter_desc_material(cd_material),1,255)
	from	emprestimo_material
	where	nr_emprestimo = nr_emprestimo_p;


BEGIN

if (ie_opcao_p = 'A') then

	update	emprestimo
	set		nm_usuario_aprov = nm_usuario_p,
			dt_aprovacao = clock_timestamp()
	where	nr_emprestimo_ref = nr_emprestimo_ref_p;

elsif (ie_opcao_p = 'R') then
	begin

	update	emprestimo
	set		nm_usuario_reprov = nm_usuario_p,
			dt_reprovacao = clock_timestamp(),
			nr_seq_motivo = nr_seq_motivo_p
	where	nr_emprestimo_ref = nr_emprestimo_ref_p;

	open C01;
	loop
	fetch C01 into
		cd_material_w,
		ds_material_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ds_lista_materiais_w := substr(ds_lista_materiais_w || cd_material_w || ' - ' || ds_material_w || chr(13) || chr(10),1,4000);
		end;
	end loop;
	close C01;

	select	coalesce(max(b.nr_sequencia), 0)
	into STRICT	nr_seq_regra_w
	from	regra_envio_comunic_compra a,
			regra_envio_comunic_evento b
	where	a.nr_sequencia = b.nr_seq_regra
	and		a.cd_funcao = 982
	and		b.cd_evento = 83
	and		b.ie_situacao = 'A'
	and		substr(obter_se_envia_ci_regra_compra(b.nr_sequencia,0,'X',obter_perfil_ativo,nm_usuario_p,null),1,1) = 'S';

	if (nr_seq_regra_w > 0) then
		begin

			select	max(substr(ds_titulo,1,80)),
					max(ds_comunicacao) ds_comunicacao,
					coalesce(max(cd_perfil),0),
					nm_usuarios_adic,
					coalesce(ie_ci_lida,'N')
			into STRICT	ds_titulo_w,
					ds_comunicado_w,
					cd_perfil_w,
					nm_usuario_destino_w,
					ie_ci_lida_w
			from	regra_envio_comunic_evento
			where	nr_sequencia = nr_seq_regra_w
			group by nm_usuarios_adic,ie_ci_lida;

			ds_comunicado_w := substr(replace_macro(ds_comunicado_w, '@nr_emprestimo',nr_emprestimo_p), 1, 2000);
			ds_comunicado_w := substr(replace_macro(ds_comunicado_w, '@materiais',ds_lista_materiais_w), 1, 2000);

			select	max(nm_usuario)   --usu√°rio do solicitante
			into STRICT	nm_usuario_destino_w
			from 	emprestimo
			where	nr_emprestimo = nr_emprestimo_ref_p;

			if (nm_usuario_destino_w IS NOT NULL AND nm_usuario_destino_w::text <> '') then
				begin
				select	obter_classif_comunic('F')
				into STRICT	nr_seq_classif_w
				;

				select	nextval('comunic_interna_seq')
				into STRICT	nr_seq_comunic_w
				;

				insert into comunic_interna(
					dt_comunicado,
					ds_titulo,
					ds_comunicado,
					nm_usuario,
					dt_atualizacao,
					ie_geral,
					nm_usuario_destino,
					nr_sequencia,
					ie_gerencial,
					nr_seq_classif,
					dt_liberacao,
					ds_perfil_adicional,
					ds_setor_adicional)
				values (	clock_timestamp(),
					ds_titulo_w,
					ds_comunicado_w,
					nm_usuario_p,
					clock_timestamp(),
					'N',
					nm_usuario_destino_w,
					nr_seq_comunic_w,
					'N',
					nr_seq_classif_w,
					clock_timestamp(),
					cd_perfil_w,
					ds_setor_adicional_w);

				if (ie_ci_lida_w = 'S') then
					insert into comunic_interna_lida(nr_sequencia,nm_usuario,dt_atualizacao)values (nr_seq_comunic_w,nm_usuario_p,clock_timestamp());
				end if;
				end;
			end if;
		end;
	end if;
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pcs_aprov_reprov_emprestimo ( nr_emprestimo_p bigint, nr_emprestimo_ref_p bigint, nr_seq_motivo_p bigint default null, ie_opcao_p text DEFAULT NULL, nm_usuario_p text DEFAULT NULL) FROM PUBLIC;

