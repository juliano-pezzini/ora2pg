-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE criar_lote_audit_hist (nr_seq_lote_audit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_analise_p INOUT bigint, nr_seq_retorno_p bigint default null) AS $body$
DECLARE

				
nr_seq_lote_hist_w		lote_audit_hist.nr_sequencia%type;
nr_analise_w			lote_audit_hist.nr_analise%type;
dt_envio_w			timestamp;
ie_data_retorno_w		varchar(1);
dt_retorno_w			lote_audit_hist.dt_lote%type;
nr_seq_lote_audit_w bigint;
nr_seq_retorno_w bigint;

BEGIN

select	nextval('lote_audit_hist_seq')
into STRICT	nr_seq_lote_hist_w
;

select	coalesce(max(a.nr_analise),0),
	max(a.dt_envio)
into STRICT	nr_analise_w,
	dt_envio_w
from	lote_audit_hist a
where	a.nr_seq_lote_audit	= nr_seq_lote_audit_p;

if (nr_analise_w > 0) and (coalesce(dt_envio_w::text, '') = '') then
	/* A última análise do lote nr_seq_lote_audit_w ainda não foi enviada! */

	CALL wheb_mensagem_pck.exibir_mensagem_abort(199213,'NR_SEQ_LOTE_AUDIT_W=' || nr_seq_lote_audit_p);
end if;

ie_data_retorno_w := obter_param_usuario(27, 220, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_data_retorno_w);

if (coalesce(ie_data_retorno_w,'N')	= 'N') then
	dt_retorno_w	:= clock_timestamp();
  else
  select max(dt_retorno)
  into STRICT dt_retorno_w  
  from convenio_retorno
  where nr_sequencia = nr_seq_retorno_p;
end if;

insert	into lote_audit_hist(dt_atualizacao,
	dt_lote,
	ie_status,
	nm_usuario,
	nm_usuario_resp,
	nr_analise,
	nr_seq_lote_audit,
	nr_sequencia,
	vl_glosa,
	vl_pago,
	vl_recurso)
values (clock_timestamp(),
	dt_retorno_w,
	'A',
	nm_usuario_p,
	nm_usuario_p,
	nr_analise_w + 1,
	nr_seq_lote_audit_p,
	nr_seq_lote_hist_w,
	0,
	0,
	0);

nr_seq_analise_p := nr_seq_lote_hist_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE criar_lote_audit_hist (nr_seq_lote_audit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_analise_p INOUT bigint, nr_seq_retorno_p bigint default null) FROM PUBLIC;

