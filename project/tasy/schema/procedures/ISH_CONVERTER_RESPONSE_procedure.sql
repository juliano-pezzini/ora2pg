-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--
-- dblink wrapper to call function ish_converter_response as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE PROCEDURE ish_converter_response ( nr_seq_fila_p bigint, ds_xml_p text, ie_status_p INOUT text, ie_tipo_erro_p INOUT text, xml_p INOUT xml) AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

BEGIN
	v_query := 'SELECT * FROM ish_converter_response_atx ( ' || quote_nullable(nr_seq_fila_p) || ',' || quote_nullable(ds_xml_p) || ',' || quote_nullable(ie_status_p) || ',' || quote_nullable(ie_tipo_erro_p) || ',' || quote_nullable(xml_p) || ' )';
	SELECT * FROM dblink(v_conn_str, v_query) AS p (v_ret0 text, v_ret1 text, v_ret2 xml) INTO ie_status_p, ie_tipo_erro_p, xml_p;

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE PROCEDURE ish_converter_response_atx ( nr_seq_fila_p bigint, ds_xml_p text, ie_status_p INOUT text, ie_tipo_erro_p INOUT text, xml_p INOUT xml) AS $body$
DECLARE

	
itemdata_w		xml;
WorstReturnedMsgty_w	varchar(255);	

ie_erro_tecnico_w	varchar(1);
ds_erro_w		varchar(2000);
ds_xml_w		varchar(32000);
ds_action_w		varchar(2000);
qt_registros_w		bigint;
ie_status_w		varchar(1) := 'X';
ie_tipo_erro_w		intpd_fila_transmissao.ie_tipo_erro%type;
ie_tipo_erro_conv_w	varchar(40);
ie_tipo_reproc_w	varchar(40);
ds_separador_w		varchar(15)	:=	ish_param_pck.get_separador;
institution_w		varchar(10);
reg_integracao_w	gerar_int_padrao.reg_integracao;
nr_seq_documento_w	intpd_fila_transmissao.nr_seq_documento%type;
nr_seq_documento_ww intpd_fila_transmissao.nr_seq_documento%type;
nm_usuario_w		intpd_fila_transmissao.nm_usuario%type;
nr_seq_episodio_w	episodio_paciente.nr_sequencia%type;

C00 CURSOR FOR
SELECT  a.faultcode, a.faultstring
from	xmltable(
		xmlnamespaces(		
		'http://schemas.xmlsoap.org/soap/envelope/' as "soap-env"),
		'soap-env:Envelope/soap-env:Body/soap-env:Fault' passing xml_p columns
		faultcode varchar(4000) path 'faultcode',
		faultstring varchar(4000) path 'faultstring') a;
		
c00_w	c00%rowtype;

c02 CURSOR FOR
SELECT	identificador,
	tipo,
	numero,
	campo
from	xmltable('Return/item' passing itemdata_w columns
		identificador	varchar(20)	path	'Id',
		tipo		varchar(1)	path	'Type',
		numero		varchar(3)	path	'Number',
		campo		varchar(32)	path	'Field')
where (length(numero) > 0 or length(tipo) > 0)

union all

select	identificador,
	tipo,
	numero,
	campo	
from	xmltable('Return/item' passing itemdata_w columns
		identificador	varchar(20)	path	'ID',
		tipo		varchar(1)	path	'TYPE',
		numero		varchar(3)	path	'NUMBER',
		campo		varchar(32)	path	'FIELD')
where (length(numero) > 0 or length(tipo) > 0)		

union all

select	identificador,
	tipo,
	numero,
	campo
from	xmltable('ReturnTab/item' passing itemdata_w columns
		identificador	varchar(20)	path	'Id',
		tipo		varchar(1)	path	'Type',
		numero		varchar(3)	path	'Number',
		campo		varchar(32)	path	'Field')
where (length(numero) > 0 or length(tipo) > 0)		

union all

select	identificador,
	tipo,
	numero,
	campo
from	xmltable('ReturnTab/item' passing itemdata_w columns
		identificador	varchar(20)	path	'ID',
		tipo		varchar(1)	path	'TYPE',
		numero		varchar(3)	path	'NUMBER',
		campo		varchar(32)	path	'FIELD')
where (length(numero) > 0 or length(tipo) > 0)

union all

select	identificador,
	tipo,
	numero,
	campo
from	xmltable('ET_RETURN/item' passing itemdata_w columns
		identificador	varchar(20)	path	'ID',
		tipo		varchar(1)	path	'TYPE',
		numero		varchar(3)	path	'NUMBER',
		campo		varchar(32)	path	'FIELD')
where (length(numero) > 0 or length(tipo) > 0)
order by numero desc;

c02_w	c02%rowtype;

procedure gravar_intpd_reg_alter(nr_seq_fila_p	in	bigint,
		ds_campo_p		in	text) is

intpd_reg_alter_fila_w		intpd_reg_alter_fila%rowtype;
intpd_reg_alteracao_w		intpd_reg_alteracao%rowtype;
intpd_reg_alter_campo_w 	intpd_reg_alter_campo%rowtype;
BEGIN
intpd_reg_alteracao_w.dt_atualizacao	:= clock_timestamp();
intpd_reg_alteracao_w.nm_tabela		:= 'INTPD_FILA_TRANSMISSAO';
intpd_reg_alteracao_w.ds_chave		:= 'IE_TIPO_ERRO';

select	nextval('intpd_reg_alteracao_seq')
into STRICT	intpd_reg_alteracao_w.nr_sequencia
;

intpd_reg_alter_campo_w.nr_sequencia		:= intpd_reg_alteracao_w.nr_sequencia;
intpd_reg_alter_campo_w.nm_atributo		:= upper(replace(ds_campo_p,'_',''));
intpd_reg_alter_campo_w.ie_classificacao	:= 'D';

intpd_reg_alter_fila_w.nr_seq_fila	:= nr_seq_fila_p;
intpd_reg_alter_fila_w.nr_seq_reg_alter	:= intpd_reg_alter_campo_w.nr_sequencia;

select	nextval('intpd_reg_alter_fila_seq')
into STRICT	intpd_reg_alter_fila_w.nr_sequencia
;

insert	into intpd_reg_alteracao	values	(intpd_reg_alteracao_w.*);
insert	into intpd_reg_alter_campo	values	(intpd_reg_alter_campo_w.*);
insert	into intpd_reg_alter_fila	values	(intpd_reg_alter_fila_w.*);
commit;

end;

procedure set_estab(
		nr_seq_fila_p	number,
		institution_p	varchar2) is

nr_seq_regra_conv_w	intpd_eventos_sistema.nr_seq_regra_conv%type;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
begin
begin
select	b.nr_seq_regra_conv
into STRICT	nr_seq_regra_conv_w
from	intpd_fila_transmissao a,
	intpd_eventos_sistema b
where	a.nr_Seq_evento_sistema = b.nr_sequencia
and	a.nr_sequencia = nr_seq_fila_p;
exception
when others then
	nr_seq_regra_conv_w	:=	null;
end;

begin
cd_estabelecimento_w	:=	bkf_obter_conv_interna(null, 'ESTABELECIMENTO', 'CD_ESTABELECIMENTO', institution_p, null, nr_seq_regra_conv_w);

select	cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	estabelecimento
where	cd_estabelecimento = cd_estabelecimento_w;
exception
when others then
	cd_estabelecimento_w	:=	null;
end;

cd_estabelecimento_w	:=	coalesce(cd_estabelecimento_w, obter_estabelecimento_ativo);

CALL ish_param_pck.set_cd_estab_ant(obter_estabelecimento_ativo);
CALL wheb_usuario_pck.set_cd_estabelecimento(cd_estabelecimento_w);
end;

begin

begin
ds_xml_w	:=	substr(ds_xml_p, 4000, 1);
ds_action_w	:=	substr(ds_xml_w, position('Body>' in ds_xml_w), 255);

begin
xml_p		:=	xmlparse(DOCUMENT, convert_from(, 'utf-8'));
exception
when others then
	begin
	ie_status_p	:=	'E';
	ie_tipo_erro_p	:=	'T';
	
	if (lower(ds_xml_w) like '%<title>application server error</title>%') then	
		intpd_gravar_log_recebimento(nr_seq_fila_p, 'Application Server Error', 'INTPDTASY');		
	end if;
	end;
end;

--Buscar os codigos de erro tecnico
ie_erro_tecnico_w	:= null;

if (ds_action_w like '%Fault%') then
	open C00;
	loop
	fetch C00 into	
		c00_w;
	EXIT WHEN NOT FOUND; /* apply on C00 */
		begin	
		ie_status_p	:=	'E';
		intpd_gravar_log_recebimento(nr_seq_fila_p, c00_w.faultstring, 'INTPDTASY');	
		end;
	end loop;
	close C00;
end if;

if (ds_action_w like '%insuranceGetResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:_-rzvish_-insuranceGetResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
			
	select  max(Institution)
	into STRICT	Institution_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:_-rzvish_-insuranceGetResponse/InsurTab/item' passing xml_p columns
			Institution varchar2(10) path 'Institution') a;
elsif (ds_action_w like '%insuranceCreateResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:_-rzvish_-insuranceCreateResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%assignmentGetResponse%') then		
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:_-rzvish_-assignmentGetResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
			
	select  max(Institution)
	into STRICT	Institution_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:_-rzvish_-assignmentGetResponse/ONffz/item' passing xml_p columns
			Institution varchar2(10) path 'Institution') a;
elsif (ds_action_w like '%assignmentResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:_-rzvish_-assignmentResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%insuranceChangeResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:_-rzvish_-insuranceChangeResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%insuranceCancelResponse%') then		
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:_-rzvish_-insuranceCancelResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%PatcaseAddoutpatvisitResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseAddoutpatvisitResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%PatcaseChangeoutpatvisitResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseChangeoutpatvisitResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%PatcaseCanceloutpatvisitResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseCanceloutpatvisitResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%PatcaseCanceloutpatvisitcasResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseCanceloutpatvisitcasResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%PatcaseGetinpatadmissResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseGetinpatadmissResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
			
	select  max(Institution)
	into STRICT	Institution_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseGetinpatadmissResponse/InpatAdmissData' passing xml_p columns
			Institution varchar2(10) path 'Institution') a;
elsif (ds_action_w like '%PatcaseGetoutpatvisitResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseGetoutpatvisitResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
			
	select  max(Institution)
	into STRICT	Institution_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseGetoutpatvisitResponse/OutpatVisitData' passing xml_p columns
			Institution varchar2(10) path 'Institution') a;
elsif (ds_action_w like '%PatcaseAddinpatadmissResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseAddinpatadmissResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%PatcaseChangeinpatadmissResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseChangeinpatadmissResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%PatcaseCancelinpatadmissResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseCancelinpatadmissResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%PatcaseGetmovementlistResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseGetmovementlistResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
			
	select  max(Institution)
	into STRICT	Institution_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseGetmovementlistResponse/Movementlist/item' passing xml_p columns
			Institution varchar2(10) path 'Institution') a;
elsif (ds_action_w like '%PatcaseGettransferResponse%') then		
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseGettransferResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
			
	select  max(Institution)
	into STRICT	Institution_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseGettransferResponse/InpatTransferData' passing xml_p columns
			Institution varchar2(10) path 'Institution') a;
elsif (ds_action_w like '%PatcaseAdddischargeResponse%') then		
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseAdddischargeResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%PatcaseChangedischargeResponse%') then		
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseChangedischargeResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%PatcaseCanceldischargeResponse%') then		
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseCanceldischargeResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%PatcaseAddtransferResponse%') then		
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseAddtransferResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%PatcaseChangetransferResponse%') then		
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseChangetransferResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%PatcaseCanceltransferResponse%') then		
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseCanceltransferResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%PatcaseGetdischargeResponse%') then		
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseGetdischargeResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
			
	select  max(Institution)
	into STRICT	Institution_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseGetdischargeResponse/InpatDischargeData' passing xml_p columns
			Institution varchar2(10) path 'Institution') a;
elsif (ds_action_w like '%PatientGetdetailResponse%') then		
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatientGetdetailResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
			
	select  max(Institution)
	into STRICT	Institution_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatientGetdetailResponse/PatientData' passing xml_p columns
			Institution varchar2(10) path 'Institution') a;
elsif (ds_action_w like '%tableModifyResponse%') then		
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:_-rzvish_-tableModifyResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%PatientCreateResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatientCreateResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%PatientChangeResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatientChangeResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%PatientCancelResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatientCancelResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%PatientEnqueueResponse%') then		
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatientEnqueueResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%PatientDequeueResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatientDequeueResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%CasediagnosisGetlistResponse%') then		
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:CasediagnosisGetlistResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
			
	select  max(Institution)
	into STRICT	Institution_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:CasediagnosisGetlistResponse/CaseDiagnosis/item' passing xml_p columns
			Institution varchar2(10) path 'Institution') a;
elsif (ds_action_w like '%CasediagnosisCreatemultResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:CasediagnosisCreatemultResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%CasediagnosisChangemultResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:CasediagnosisChangemultResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%CasediagnosisDeletemultResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:CasediagnosisDeletemultResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%CaseserviceGetlistResponse%') then		
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:CaseserviceGetlistResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
			
	select  max(Institution)
	into STRICT	Institution_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:CaseserviceGetlistResponse/CaseserviceData/item' passing xml_p columns
			Institution varchar2(10) path 'Institution') a;
elsif (ds_action_w like '%CaseserviceCreatemultResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:CaseserviceCreatemultResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%CaseserviceChangemultResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:CaseserviceChangemultResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%CaseserviceCancelmultResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:CaseserviceCancelmultResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%CaseprocedureGetlistResponse%') then	
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:CaseprocedureGetlistResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
			
	select  max(Institution)
	into STRICT	Institution_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:CaseprocedureGetlistResponse/CaseprocedureData/item' passing xml_p columns
			Institution varchar2(10) path 'Institution') a;
elsif (ds_action_w like '%CaseprocedureCreatemultResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:CaseprocedureCreatemultResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%CaseprocedureChangemultResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:CaseprocedureChangemultResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%CaseprocedureCancelmultResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:CaseprocedureCancelmultResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%egkGetResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:_-rzvish_-egkGetResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%egkCreateResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:_-rzvish_-egkCreateResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%_-rzvish_-setMdCaseStatusResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:_-rzvish_-setMdCaseStatusResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%_-rzvish_-caseModifyBirthResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:_-rzvish_-caseModifyBirthResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%PatcaseAddabsenceResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseAddabsenceResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%PatcaseChangeabsenceResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseChangeabsenceResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%PatcaseCancelabsenceResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseCancelabsenceResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%_-rzvish_-certificTreatmCreateResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:_-rzvish_-certificTreatmCreateResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%_-rzvish_-certificTreatmChangeResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:_-rzvish_-certificTreatmChangeResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%_-rzvish_-certificTreatmCancelResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:_-rzvish_-certificTreatmCancelResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%_-rzvish_-casechangetypeCreateResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:_-rzvish_-casechangetypeCreateResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%_-rzvish_-pprLevelCreateResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:_-rzvish_-pprLevelCreateResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;			
elsif (ds_action_w like '%_-rzvish_-pprLevelCancelResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:_-rzvish_-pprLevelCancelResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%PatcaseAddoutpatvisitcasResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:PatcaseAddoutpatvisitcasResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%recordCheckDeleteResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:_-rzvish_-recordCheckDeleteResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
elsif (ds_action_w like '%Z_MERGE_PATResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:Z_MERGE_PATResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'ET_RETURN') a;
elsif (ds_action_w like '%insuranceSwapInsprovResponse%') then
	select  a.itemdata,
		a.WorstReturnedMsgty 
	into STRICT	itemdata_w, 
		WorstReturnedMsgty_w
	from	xmltable(
			xmlnamespaces(
			'urn:sap-com:document:sap:soap:functions:mc-style' as "urn",
			'http://schemas.xmlsoap.org/soap/envelope/' as "soapenv"),
			'soapenv:Envelope/soapenv:Body/urn:_-rzvish_-insuranceSwapInsprovResponse' passing xml_p columns
			WorstReturnedMsgty varchar2(255) path 'WorstReturnedMsgty',
			itemdata xmltype path 'Return') a;
end if;

set_estab(nr_seq_fila_p, institution_w);

ie_status_p := ish_return_processing(nr_seq_fila_p, itemdata_w, ie_status_p);

ie_tipo_erro_w	:=	ie_tipo_erro_p;

open C02;
loop
fetch C02 into
	c02_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin	
	/*if	((c02_w.numero in ('226','016')) and (c02_w.identificador = 'N1')) then --Das angeforderte Objekt ist momentan gesperrt durch User XXXXXXX
		ie_tipo_erro_p	:=	'T';
	elsif	((c02_w.numero in ('601')) and (c02_w.identificador = 'N2')) then --Das angeforderte Objekt ist momentan gesperrt durch User XXXXXXX
		ie_tipo_erro_p	:=	'T';
	elsif	((c02_w.numero in ('133')) and (c02_w.identificador = 'N5')) then
		ie_tipo_erro_p	:=	'K';
	elsif	((c02_w.numero in ('035')) and (c02_w.identificador = 'N1')) then --Kein Aufnahmesatz fur Fall 5293209  vorhanden	
		ie_tipo_erro_p	:=	'K';
	elsif	((c02_w.numero in ('400')) and (c02_w.identificador = 'N1')) then --Entlassung des Falles 1962539 ist nicht vorhanden (Bitte anlegen)	
		ie_tipo_erro_p	:=	'K';
	*/
	
	ie_tipo_erro_conv_w	:=	bkf_obter_conv_interna(null, 'INTPD_FILA_TRANSMISSAO', 'IE_TIPO_ERRO', c02_w.numero || ds_separador_w || c02_w.identificador, null, null);
	ie_tipo_reproc_w	:=	bkf_obter_conv_interna(null, 'INTPD_FILA_TRANSMISSAO', 'IE_TIPO_ERRO',
						c02_w.tipo || ds_separador_w  ||
						c02_w.identificador || ds_separador_w  || 
						c02_w.numero || ds_separador_w || 
						c02_w.campo, null, null);
	
	if (ie_tipo_erro_conv_w in ('T','K')) then
		ie_tipo_erro_p	:=	ie_tipo_erro_conv_w;
	elsif (ie_tipo_reproc_w	= 'V') then
		begin
		select	count(*)
		into STRICT	qt_registros_w
		from	intpd_reg_alter_fila a,
			intpd_reg_alter_campo b
		where	a.nr_seq_fila		= nr_seq_fila_p
		and	a.nr_seq_reg_alter	= b.nr_sequencia
		and	upper(b.nm_atributo)		= upper(replace(c02_w.campo,'_',''))
		and	b.ie_classificacao	= 'D';
		
		if (qt_registros_w = 0) then
			gravar_intpd_reg_alter(nr_seq_fila_p, c02_w.campo);
		end if;
		ie_tipo_erro_p	:=	'T';
		ie_tipo_erro_w	:=	'T';
		end;
	elsif	((c02_w.numero||ds_separador_w||c02_w.identificador = '135'||ds_separador_w||'NK') or (c02_w.numero||ds_separador_w||c02_w.identificador = '136'||ds_separador_w||'NK')) and (ds_action_w like '%PatcaseCanceloutpatvisitResponse%' or ds_action_w like '%PatcaseCancelinpatadmissResponse%')then
		begin
		begin
		select	a.nr_seq_documento,
			a.nr_seq_agrupador,
			a.nm_usuario
		into STRICT	nr_seq_documento_w,
			reg_integracao_w.nr_seq_agrupador,
			nm_usuario_w
		from	intpd_fila_transmissao a
		where	a.nr_sequencia	= nr_seq_fila_p;
		exception
		when others then
			nr_seq_documento_w			:= null;
			reg_integracao_w.nr_seq_agrupador	:= null;
		end;

		if (ds_action_w like '%PatcaseCanceloutpatvisitResponse%') then
			begin
				select	a.nr_seq_episodio
				into STRICT	nr_seq_documento_ww
				from	atendimento_paciente a
				where	a.nr_atendimento = nr_seq_documento_w;

				nr_seq_documento_w := nr_seq_documento_ww;
			exception
			when no_data_found then
				nr_seq_documento_w := null;
			end;
		end if;

		if (nr_seq_documento_w IS NOT NULL AND nr_seq_documento_w::text <> '') then
			reg_integracao_w.ie_operacao	:= 'I';
			reg_integracao_w := gerar_int_padrao.gravar_integracao('375', nr_seq_documento_w, nm_usuario_w, reg_integracao_w);
		end if;
		ie_tipo_erro_conv_w	:= 'F';
		exit;
		end;
	else
		begin
		ie_tipo_erro_p	:=	ie_tipo_erro_w;	
		if (c02_w.tipo = 'E') then
			exit;
		end if;
		end;
	end if;
	end;
end loop;
close C02;

if (WorstReturnedMsgty_w = 'E') then
	ie_status_p	:=	'E';
end if;

if (lower(ds_xml_w) like '%<ns:systemfault%') then	
	ie_erro_tecnico_w	:= 'S';
	intpd_gravar_log_recebimento(nr_seq_fila_p, 'SystemFault', 'INTPDTASY');
end if;

--Se algum erro era do tipo tecnico
if (ie_erro_tecnico_w = 'S') then
	ie_status_p	:=	'E';
	ie_tipo_erro_p	:=	'T';
end if;

if (ie_tipo_erro_conv_w = 'S') then
	ie_tipo_erro_p	:= null;
	ie_status_p		:= 'S';
end if;

exception
when others then
	begin
	ds_erro_w	:=	substr(dbms_utility.format_error_backtrace || chr(13) || chr(10) || sqlerrm,1,2000);
	ie_status_p	:=	'E';
	
	intpd_gravar_log_recebimento(nr_seq_fila_p, ds_erro_w, 'INTPDTASY');
	end;
end;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ish_converter_response ( nr_seq_fila_p bigint, ds_xml_p text, ie_status_p INOUT text, ie_tipo_erro_p INOUT text, xml_p INOUT xml) FROM PUBLIC; -- REVOKE ALL ON PROCEDURE ish_converter_response_atx ( nr_seq_fila_p bigint, ds_xml_p text, ie_status_p INOUT text, ie_tipo_erro_p INOUT text, xml_p INOUT xml) FROM PUBLIC;

