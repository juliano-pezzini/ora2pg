-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE campos AS (ds		varchar(32760));


CREATE OR REPLACE PROCEDURE tasy_criar_trigger_pf_alt () AS $body$
DECLARE

type Vetor is table of  campos index by integer;
ds_script_vetor			Vetor;

ds_script_trigger_w		text;
ds_script_trigger_ww		text;
ds_script_trigger_www		text;
ds_script_trigger_wwww		text;
nm_atributo_w			varchar(50);
nm_atributo_old_w		varchar(70);
nm_atributo_new_w		varchar(70);
ds_chave_simples_proc_w		varchar(100);
ds_chave_composta_proc_w	varchar(1000);
ds_enter_w			varchar(10) := chr(10);
c001				integer;
c002				integer;
------------------------------------------------------------------------------------------
v_text				dbms_sql.varchar2s;
cursor1				integer;
ret_val				integer;
j				integer:=0;
ds_aspa_w			varchar(1) :=chr(39);
retorno_w			integer;
qt_linhas_w			bigint;
qt_registro_w			bigint;
qt_caracteres_w			integer;
qt_loops_w			bigint;
ub				integer := 0;
ds_linha_w			varchar(256);
ie_tipo_segurado_w		pls_segurado.ie_tipo_segurado%type;

ds_comando_c001_w	varchar(4000) := '' ||
		'	select	column_name ' ||
		'	from	user_tab_columns ' ||
		'	where	upper(table_name) = ''PESSOA_FISICA''' ||
		'	and	obter_se_atrib_constraint(table_name,column_name,''PK'') = ''N'''||
		'	and	upper(column_name)	not in (''DT_ATUALIZACAO'',''NM_USUARIO'',''DS_OBSERVACAO'',''DS_ORIENTACAO_COBRANCA'',''DS_HISTORICO'')';


BEGIN

ds_script_vetor[1].ds := '';
ds_script_vetor[2].ds := '';
ds_script_vetor[3].ds := '';
ds_script_vetor[4].ds := '';
ds_script_vetor[5].ds := '';

ds_chave_composta_proc_w := null;
ds_chave_simples_proc_w := null;

ds_script_trigger_w :=  ' create or replace trigger pessoa_fisica_update ' || ds_enter_w||
			' before update on pessoa_fisica ' || ds_enter_w||
			' FOR EACH ROW '|| ds_enter_w||
			' DECLARE'|| ds_enter_w||
			' nm_coluna_w		varchar2(50);'|| ds_enter_w||
			' ie_alterar_w		varchar2(10);'|| ds_enter_w||
			' ds_w			varchar2(50);'|| ds_enter_w||
			' vl_parametro_w	varchar2(20);'|| ds_enter_w||
			' qt_registros_w	number(10);'|| ds_enter_w||
			' ie_tipo_segurado_w	varchar2(10);'|| ds_enter_w||
			' ie_estipulante_w	varchar2(10);'|| ds_enter_w||
			' ie_pagador_w		varchar2(10);'|| ds_enter_w||
			' Cursor C01 is ' || ds_enter_w ||
			'	select	ie_tipo_segurado	' || ds_enter_w ||
			'	from	pls_segurado		' || ds_enter_w ||
			'	where	cd_pessoa_fisica	= :new.cd_pessoa_fisica '|| ds_enter_w ||
			'	and	((dt_rescisao is null)  or (dt_rescisao > sysdate))' || ds_enter_w ||
			'	union ' || ds_enter_w ||
			'	select	null ie_tipo_segurado ' || ds_enter_w ||
			'	from	dual ' || ds_enter_w ||
			'	where	not exists (	select	ie_tipo_segurado ' || ds_enter_w ||
			'				from	pls_segurado ' || ds_enter_w ||
			'				where	cd_pessoa_fisica	= :new.cd_pessoa_fisica' || ds_enter_w ||
			'				and	(dt_rescisao is null  or dt_rescisao > sysdate)); ' || ds_enter_w ||
			ds_enter_w ||
			' begin' || ds_enter_w ||
			'if	(wheb_usuario_pck.get_cd_funcao = 281) and (:new.dt_nascimento > sysdate) then ' || ds_enter_w ||
			'	wheb_mensagem_pck.exibir_mensagem_abort(194547);'|| ds_enter_w ||
			'end if;' || ds_enter_w ||
			' if	(wheb_usuario_pck.get_ie_executar_trigger	= ''S'') and '|| ds_enter_w||
			'	(pls_usuario_pck.get_ie_exec_trigger_solic_pf	= ''S'') then '|| ds_enter_w||
			'	pls_usuario_pck.set_ie_lancar_mensagem_alt(''N''); '||ds_enter_w||
			'	pls_usuario_pck.set_ie_commit(''S'');'			||ds_enter_w||
			' 	if	(wheb_usuario_pck.get_cd_funcao = 5) then ' || ds_enter_w||
			'		Obter_Param_Usuario(5, 177, obter_perfil_ativo, :new.nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, vl_parametro_w);' || ds_enter_w ||
			'	elsif	(wheb_usuario_pck.get_cd_funcao = 32) then ' || ds_enter_w||
			'		Obter_Param_Usuario(32, 46, obter_perfil_ativo, :new.nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, vl_parametro_w);' || ds_enter_w ||
			'	elsif	(wheb_usuario_pck.get_cd_funcao = 1220) then ' || ds_enter_w||
			'		Obter_Param_Usuario(1220, 26, obter_perfil_ativo, :new.nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, vl_parametro_w);' || ds_enter_w ||
			'	else ' || ds_enter_w ||
			'		vl_parametro_w := ''N'';' || ds_enter_w ||
			'	end if;' || ds_enter_w ||
			'	if	(vl_parametro_w = ''S'') then	' || ds_enter_w ||
			'		null;' || ds_enter_w;

c001 := DBMS_SQL.OPEN_CURSOR;
DBMS_SQL.PARSE(C001, ds_comando_c001_w, dbms_sql.Native);
DBMS_SQL.DEFINE_COLUMN(C001, 1, nm_atributo_w,50);
retorno_w := DBMS_SQL.execute(c001);

while( DBMS_SQL.FETCH_ROWS(C001) > 0 ) loop
	begin
	DBMS_SQL.COLUMN_VALUE(C001, 1, nm_atributo_w);
	if (substr(nm_atributo_w,1,3) = 'DT_') then
		nm_atributo_old_w	:= 'to_char(:old.'||nm_atributo_w||',''dd/mm/yyyy'')';
		nm_atributo_new_w	:= 'to_char(:new.'||nm_atributo_w||',''dd/mm/yyyy'')';
	else
		nm_atributo_old_w	:= ':old.'||nm_atributo_w;
		nm_atributo_new_w	:= ':new.'||nm_atributo_w;
	end if;
	
	ds_script_trigger_ww	:= ds_script_trigger_ww||'      		gerar_solicitacao_alteracao('||nm_atributo_old_w||','||nm_atributo_new_w||','||ds_aspa_w||
								nm_atributo_w||ds_aspa_w||','||':new.cd_pessoa_fisica'||',:new.cd_estabelecimento, :new.nm_usuario);'||ds_enter_w;
	end;
end loop;
DBMS_SQL.CLOSE_CURSOR(C001);

ds_script_trigger_www	:=	ds_script_trigger_www||	'	elsif	(vl_parametro_w = ''D'') then	' || ds_enter_w;
ds_script_trigger_www	:=	ds_script_trigger_www||	'		select	decode(count(1),0,''N'',''S'')	' || ds_enter_w||
							'		into	ie_estipulante_w	' || ds_enter_w||
							'		from	pls_contrato		' || ds_enter_w||
							'		where	cd_pf_estipulante	= :new.cd_pessoa_fisica'||ds_enter_w||
							'		and	((dt_rescisao_contrato is null)  or (dt_rescisao_contrato > sysdate));'||ds_enter_w||
							ds_enter_w||
							'		select	decode(count(1),0,''N'',''S'')	' || ds_enter_w||
							'		into	ie_pagador_w	' 		|| ds_enter_w||
							'		from	pls_contrato_pagador		' || ds_enter_w||
							'		where	cd_pessoa_fisica	= :new.cd_pessoa_fisica'||ds_enter_w||
							'		and	((dt_rescisao is null)  or (dt_rescisao > sysdate));'||ds_enter_w||
							ds_enter_w ||
							'		for r_c01_w in C01 loop ' || ds_enter_w;

c001 := DBMS_SQL.OPEN_CURSOR;
DBMS_SQL.PARSE(C001, ds_comando_c001_w, dbms_sql.Native);
DBMS_SQL.DEFINE_COLUMN(C001, 1, nm_atributo_w,50);
retorno_w := DBMS_SQL.execute(c001);

while( DBMS_SQL.FETCH_ROWS(C001) > 0 ) loop
	begin
	DBMS_SQL.COLUMN_VALUE(C001, 1, nm_atributo_w);
	if (substr(nm_atributo_w,1,3) = 'DT_') then
		nm_atributo_old_w	:= 'to_char(:old.'||nm_atributo_w||',''dd/mm/yyyy'')';
		nm_atributo_new_w	:= 'to_char(:new.'||nm_atributo_w||',''dd/mm/yyyy'')';
	else
		nm_atributo_old_w	:= ':old.'||nm_atributo_w;
		nm_atributo_new_w	:= ':new.'||nm_atributo_w;
	end if;
	
	ds_script_trigger_www	:= ds_script_trigger_www||'     	 	gerar_solicitacao_alt_regra('||nm_atributo_old_w||','||nm_atributo_new_w||','||ds_aspa_w||
								nm_atributo_w||ds_aspa_w||','||':new.cd_pessoa_fisica,''PESSOA_FISICA'',wheb_usuario_pck.get_cd_funcao,null, r_c01_w.ie_tipo_segurado,
								ie_estipulante_w,ie_pagador_w,:new.cd_estabelecimento, :new.nm_usuario,ie_alterar_w);'||ds_enter_w;
								
	ds_script_trigger_www	:= ds_script_trigger_www||	'		if	(ie_alterar_w	= ''S'') then'||ds_enter_w||
								'			:new.'||nm_atributo_w	||' := :old.'||nm_atributo_w||';'||ds_enter_w||
								'		end if;' || ds_enter_w;
	end;
end loop;
DBMS_SQL.CLOSE_CURSOR(C001);

ds_script_trigger_wwww	:= ds_enter_w||
			'		end loop;' || ds_enter_w ||
			'	end if;'||ds_enter_w||
			'if	(vl_parametro_w <> ''N'') then	'|| ds_enter_w ||
			'	select	count(1)		'||ds_enter_w||
			'	into	qt_registros_w		'||ds_enter_w||
			'	from	pessoa_fisica_solic_alt	'||ds_enter_w||
			'	where	cd_pessoa_fisica	= :new.cd_pessoa_fisica;'||ds_enter_w||
			'	if	(qt_registros_w > 0) then ' ||ds_enter_w||
			'		tasy_gerar_solicitacao(:new.cd_pessoa_fisica);'||ds_enter_w||
			'		if	(vl_parametro_w = ''S'') then	'|| ds_enter_w ||
			'			wheb_mensagem_pck.exibir_mensagem_abort(231273);' ||ds_enter_w||
			'		end if;' || ds_enter_w ||
			'		pls_usuario_pck.set_ie_lancar_mensagem_alt(''S''); '||ds_enter_w||
			'	end if;'||ds_enter_w||
			'end if;'||ds_enter_w;

ds_script_trigger_w := ds_script_trigger_w|| ds_script_trigger_ww||ds_script_trigger_www ||ds_script_trigger_wwww||ds_enter_w||'end if;'||ds_enter_w|| 'end;';

ds_script_vetor[1].ds := substr(ds_script_trigger_w,1,32000);
ds_script_vetor[2].ds := substr(ds_script_trigger_w,32001,32000);
ds_script_vetor[3].ds := substr(ds_script_trigger_w,64001,32000);
ds_script_vetor[4].ds := substr(ds_script_trigger_w,96001,32000);
ds_script_vetor[5].ds := substr(ds_script_trigger_w,128001,32000);

qt_caracteres_w := coalesce(length(ds_script_vetor[1].ds),0) + coalesce(length(ds_script_vetor[2].ds),0) + coalesce(length(ds_script_vetor[3].ds),0) + coalesce(length(ds_script_vetor[4].ds),0) + coalesce(length(ds_script_vetor[5].ds),0);

qt_loops_w	:= round(qt_caracteres_w / 256) + 1;

for j in 1..qt_loops_w loop
	begin
	ds_linha_w := substr(ds_script_trigger_w,256,((j*256)-255));
	
	if (length(trim(both ds_linha_w)) > 0) then
		ub := ub+1;
		v_text(ub) := ds_linha_w;
	end if;
	end;
end loop;
cursor1 := dbms_sql.open_cursor;
dbms_sql.parse(cursor1, v_text, 1, ub, null, dbms_sql.native);
ret_val := dbms_sql.execute(cursor1);
dbms_sql.close_cursor(cursor1);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_criar_trigger_pf_alt () FROM PUBLIC;

