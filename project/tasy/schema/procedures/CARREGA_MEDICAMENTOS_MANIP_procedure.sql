-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE carrega_medicamentos_manip ( nr_seq_ordem_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


cd_material_w				bigint;
cd_material_prescrito_w		bigint;
nr_sequencia_w		bigint;
nr_sequencia_ww		bigint;
qt_estoque_w	 	bigint;
qt_estoque_ww	 	bigint;
ds_lote_fornec_w	varchar(20);
cd_unidade_medida_consumo_w varchar(30);
cd_unid_med_prescr_w	varchar(30);
nr_seq_cabine_w		bigint;
nr_sequencia_www	bigint;
qt_dose_w		bigint;
qt_dose_ml_w		bigint;
qt_dose_ml_saldo_w	bigint;
qt_dose_ml_prescr_w	bigint;
qt_estoque_ml_w		bigint;
qt_dose_mg_ww		bigint;
nr_seq_lote_fornec_w	bigint;
nr_seq_ordem_w		bigint;
nr_seq_ordem_item_w	bigint;
qt_dose_real_w		bigint;
qt_total_cabine_ml_w	bigint;
qt_dose_util_cons_w	bigint;
can_ordem_item_prescr_w	bigint;
qt_dose_apres_ml_w	bigint;
cd_unid_med_concetracao_w	varchar(30);
cd_unid_med_base_conc_w		varchar(30);
ie_unidade_equivalentes_w	varchar(1);
qt_conversao_mg_w	bigint;
Ie_sobras_overfill_w	varchar(2);
Ie_sobras_overfill_ww	varchar(1);
ie_tela_deferenciada_w	varchar(1);
qt_dias_util_w		smallint;
ie_considera_overfill_w	varchar(1);
ie_via_aplicacao_w		varchar(30);
ie_conv_ml_w		varchar(30);
qt_diluicao_w		bigint := 0;
ie_agrupador_w		smallint;
ds_erro			varchar(2000);
dt_estabilidade_w		timestamp;
nr_seq_sobra_overfill_w bigint;
nr_seq_medic_dil_w		bigint;
qt_dose_prescr_dil_w	bigint;
qt_ficha_tecnica_w	bigint;
qt_ficha_tec_sobra_w	bigint;
nr_seq_ficha_tec_w	bigint;
ie_exist_patient_medic_w	varchar(1);
cd_pf_vinculo_w	far_estoque_cabine.cd_pessoa_fisica%type;
cd_material_patient_w	material.cd_material%type;

C01 CURSOR FOR
	SELECT  f.nr_sequencia nr_seq_item_prescr,
		a.nr_sequencia,
		f.cd_material cd_material_prescrito,
		a.cd_material,
		sum(a.qt_estoque) qt_estoque,
		--sum(Obter_dose_convertida_quimio(f.cd_material,f.qt_dose,f.cd_unidade_medida,c.cd_unidade_medida_consumo)),
		c.cd_unidade_medida_consumo,
		b.ds_lote_fornec,
		f.qt_dose,
		f.cd_unidade_medida,
		a.nr_seq_lote_fornec,
		Obter_dose_convertida_quimio(f.cd_material,f.qt_dose,f.cd_unidade_medida,obter_unid_med_usua('ml')),
		'N',
		e.ie_via_aplicacao,
		null,
		null
	FROM can_ordem_item_prescr f, can_ordem_prod e, far_etapa_producao d, material c, far_estoque_cabine a
LEFT OUTER JOIN material_lote_fornec b ON (a.nr_seq_lote_fornec = b.nr_sequencia)
WHERE f.nr_seq_ordem = e.nr_sequencia and e.nr_sequencia = nr_seq_ordem_p and d.nr_sequencia = e.nr_seq_etapa_prod and d.nr_seq_cabine = a.nr_seq_cabine  and a.cd_material	     = c.cd_material and ((a.cd_material = f.cd_material)  or
			(c.nr_seq_ficha_tecnica = (	SELECT  max(x.nr_seq_ficha_tecnica)
										from    material x
										where	x.cd_material = f.cd_material))or (f.cd_material = c.cd_material_generico)) and qt_estoque	> 0 and (ie_exist_patient_medic_w = 'N'
           or (ie_exist_patient_medic_w = 'S' and c.nr_seq_ficha_tecnica = nr_seq_ficha_tec_w and a.cd_pessoa_fisica = cd_pf_vinculo_w or (c.nr_seq_ficha_tecnica <> nr_seq_ficha_tec_w and a.cd_pessoa_fisica <> cd_pf_vinculo_w))) group by f.nr_sequencia,
		a.nr_sequencia,
		f.cd_material,
		a.cd_material,
		substr(obter_desc_material(a.cd_material),1,60),
		c.cd_unidade_medida_consumo,
		b.ds_lote_fornec,
		f.qt_dose,
		f.cd_unidade_medida,
		a.nr_seq_lote_fornec,
		Obter_dose_convertida_quimio(f.cd_material,f.qt_dose,f.cd_unidade_medida,obter_unid_med_usua('ml')),
		'N',
		e.ie_via_aplicacao
	
union

	select  f.nr_sequencia nr_seq_item_prescr,
				null,--nr_seq_far_estoque_cab nr_sequencia,
		f.cd_material cd_material_prescrito,
		a.cd_material,
		sum(Obter_dose_convertida_quimio(a.cd_material,a.qt_saldo,a.cd_unidade_medida,c.cd_unidade_medida_consumo)),
		--sum(a.qt_saldo) qt_estoque,
		c.cd_unidade_medida_consumo,
		b.ds_lote_fornec,
		f.qt_dose,
		f.cd_unidade_medida,
		a.nr_seq_lote_fornec,
		Obter_dose_convertida_quimio(f.cd_material,f.qt_dose,f.cd_unidade_medida,obter_unid_med_usua('ml')),
		CASE WHEN ie_tipo='OD' THEN 'X'  ELSE CASE WHEN ie_tipo='SD' THEN 'Y'  ELSE ie_tipo END  END  ie_tipo,
		e.ie_via_aplicacao,
		a.dt_estabilidade,
		a.nr_sequencia
	FROM can_ordem_item_prescr f, can_ordem_prod e, far_etapa_producao d, material c, quimio_sobra_overfill a
LEFT OUTER JOIN material_lote_fornec b ON (a.nr_seq_lote_fornec = b.nr_sequencia)
WHERE f.nr_seq_ordem = e.nr_sequencia and e.nr_sequencia = nr_seq_ordem_p and d.nr_sequencia = e.nr_seq_etapa_prod and d.nr_seq_cabine = a.nr_seq_cabine  and a.cd_material	     = c.cd_material and ((a.cd_material = f.cd_material)  or
			(c.nr_seq_ficha_tecnica = (	select  max(x.nr_seq_ficha_tecnica)
										from    material x
										where	x.cd_material = f.cd_material))or (f.cd_material = c.cd_material_generico)) and a.qt_saldo	> 0 and Ie_sobras_overfill_ww = 'S' and ((a.ie_tipo = 'O' AND ie_considera_overfill_w = 'S') or (a.ie_tipo = 'S') or ((ie_tela_deferenciada_w = 'S') and ((a.ie_tipo = 'SD') or (a.ie_tipo = 'OD'))))  -- Adicionar os diluidos quando param 218 = T
  and coalesce(dt_estabilidade,clock_timestamp() + interval '1 days') > clock_timestamp() AND (((round((Obter_conversao_ml(a.cd_material, a.qt_saldo,a.cd_unidade_medida))::numeric,2) <= round((Obter_conversao_ml(a.cd_material, f.qt_dose,f.cd_unidade_medida))::numeric,2)) AND (a.ie_tipo = 'SD' OR a.ie_tipo = 'OD')) OR (a.ie_tipo <> 'SD' AND a.ie_tipo <> 'OD'))  --restringir medicamentos diluidos com dose superior a prescrita
  AND coalesce((SELECT round((MAX(obter_conversao_ml(x.cd_material, x.qt_saldo, x.cd_unidade_medida)))::numeric, 2)
		   FROM    quimio_sobra_overfill x 
		   WHERE   cd_estabelecimento = cd_estabelecimento_p
		   AND	   x.nr_seq_superior = a.nr_sequencia
		   AND	   x.ie_tipo = 'DI'),0) <= qt_dose_prescr_dil_w--OBTER_DOSE_CONV_QUIMIO_ORDEM(cd_dil_w, qt_dose_dil_w, ds_unid_med_dil_w, 'ML', f.nr_seq_ordem)  --restringir medicamentos diluidos com dose do diluente superior a prescrita
  and (ie_exist_patient_medic_w = 'N' or (qt_ficha_tec_sobra_w = 0 or (qt_ficha_tec_sobra_w > 0 and e.cd_pessoa_fisica not like cd_pf_vinculo_w))) group by f.nr_sequencia,
		f.cd_material,
		a.cd_material,
		substr(obter_desc_material(a.cd_material),1,60),
		c.cd_unidade_medida_consumo,
		b.ds_lote_fornec,
		f.qt_dose,
		f.cd_unidade_medida,
		a.nr_seq_lote_fornec,
		Obter_dose_convertida_quimio(f.cd_material,f.qt_dose,f.cd_unidade_medida,obter_unid_med_usua('ml')),
		ie_tipo,
		e.ie_via_aplicacao,
		a.dt_estabilidade,
		a.nr_sequencia
	order by 2;

C02 CURSOR FOR
	SELECT 	a.nr_seq_ordem,
		a.nr_sequencia,
		a.cd_material,
		a.qt_dose qt_dose_mg,
		a.cd_unidade_medida cd_unidade,
		Obter_dose_convertida_quimio(a.cd_material,a.qt_dose,a.cd_unidade_medida,obter_unid_med_usua('ml')) QT_DOSE_ML,
		b.qt_dias_util,
		b.ie_via_aplicacao,
		coalesce(a.ie_agrupador,1)
	from   	can_ordem_prod b,
		can_ordem_item_prescr a
	where  	b.nr_sequencia = a.nr_seq_ordem
	and	nr_seq_ordem = nr_seq_ordem_p
	order by 2;


BEGIN

Ie_sobras_overfill_ww := obter_param_usuario(3130, 366, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, Ie_sobras_overfill_ww);
ie_considera_overfill_w := obter_param_usuario(3130, 400, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_considera_overfill_w);
ie_conv_ml_w := obter_param_usuario(3130, 404, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_conv_ml_w);
ie_tela_deferenciada_w := obter_param_usuario(3130, 218, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_tela_deferenciada_w);

delete from w_preparo_quimio_prescr
where 	nm_usuario = nm_usuario_p;
commit;

delete from w_preparo_quimio
where 	nm_usuario = nm_usuario_p;
commit;


open C02;
loop
fetch C02 into
	nr_seq_ordem_w,
	nr_seq_ordem_item_w,
	cd_material_w,
	qt_dose_w,
	cd_unid_med_prescr_w,
	qt_dose_ml_w,
	qt_dias_util_w,
	ie_via_aplicacao_w,
	ie_agrupador_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	
	qt_dose_ml_saldo_w := 0;
	select	 round((sum(CASE WHEN cd_unidade_medida_real=obter_unid_med_usua('ml') THEN qt_dose_real  ELSE Obter_dose_convertida_quimio(cd_material,qt_dose_real,cd_unidade_medida_real,cd_unid_med_prescr_w) END ))::numeric,3)
	into STRICT 	 qt_dose_real_w
	from	 can_ordem_prod_mat
	where 	 nr_seq_ordem = nr_seq_ordem_w
	and 	 nr_seq_item_prescr = nr_seq_ordem_item_w
	and 	 coalesce(nr_seq_kit::text, '') = '';

	if (coalesce(qt_dose_real_w,0) = 0) then
		qt_dose_ml_saldo_w := qt_dose_w;
	else
		qt_dose_ml_saldo_w := qt_dose_w - qt_dose_real_w;
	end if;
	
	if (ie_conv_ml_w = 'S') and (Obter_dose_convertida_quimio(cd_material_w,qt_dose_w,cd_unid_med_prescr_w,obter_unid_med_usua('ml')) = 0) and (ie_agrupador_w = 1) then
		
		select 	max(Obter_dose_convertida_quimio(a.cd_material,a.qt_dose,a.cd_unidade_medida,obter_unid_med_usua('ml')))
		into STRICT	qt_diluicao_w
		from   	can_ordem_prod b,
				can_ordem_item_prescr a
		where  	b.nr_sequencia = a.nr_seq_ordem
		and		nr_seq_ordem = nr_seq_ordem_p
		and		ie_agrupador = 9;
		
		qt_dose_ml_w := obter_conversao_unid_med_cons(cd_material_w, cd_unid_med_prescr_w, qt_dose_w) * qt_diluicao_w;
	end if;
	if (qt_dose_ml_saldo_w > 0) then
		insert into w_preparo_quimio_prescr(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_ordem_item,
			nr_seq_ordem,
			cd_material,
			qt_dose,
			cd_unidade_medida,
			qt_dose_ml,
			qt_dose_saldo,
			cd_unidade_medida_prescr,
			qt_dias_util,
			ie_agrupador)
		SELECT 	nextval('w_preparo_quimio_prescr_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_ordem_item_w,
			nr_seq_ordem_w,
			cd_material_w,
			qt_dose_w,
			cd_unid_med_prescr_w,
			qt_dose_ml_w,
			qt_dose_ml_saldo_w,
			cd_unid_med_prescr_w,
			qt_dias_util_w,
			ie_agrupador_w
		;
		commit;
	end if;
	end;
end loop;
close C02;

--Pegar dados do diluente da ordem. (mesmo tratemnto da procedure Obter_Diluente_ordem_prod)
select	min(nr_sequencia)
into STRICT	nr_seq_medic_dil_w
from	can_ordem_item_prescr
where	nr_seq_ordem	= nr_seq_ordem_p
and	coalesce(nr_sequencia_diluente::text, '') = '';

Select	coalesce(max(OBTER_DOSE_CONV_QUIMIO_ORDEM(cd_material, qt_dose, cd_unidade_medida, upper(obter_unid_med_usua('ML')), nr_seq_ordem_p)),0)
into STRICT	qt_dose_prescr_dil_w
from	can_ordem_item_prescr
where	nr_seq_ordem		= nr_seq_ordem_p
and	nr_sequencia_diluente	= nr_seq_medic_dil_w
and	nr_sequencia	= substr((	SELECT	min(nr_sequencia)
				from	can_ordem_item_prescr
				where	nr_seq_ordem	= nr_seq_ordem_p
				and	(nr_sequencia_diluente IS NOT NULL AND nr_sequencia_diluente::text <> '')
				and	((coalesce(ie_agrupador::text, '') = '') or (ie_agrupador = 3))),1,10);

select coalesce(max('S'),'N'),
		max(item.cd_material)
into STRICT ie_exist_patient_medic_w,
	cd_material_patient_w
from w_preparo_quimio_prescr w
left outer join can_ordem_item_prescr item
on w.cd_material = item.cd_material
join    can_ordem_prod ord_prod on item.nr_seq_ordem = ord_prod.nr_sequencia
join    far_etapa_producao etapa on etapa.nr_sequencia = ord_prod.nr_seq_etapa_prod
join    far_estoque_cabine cabin on etapa.nr_seq_cabine = cabin.nr_seq_cabine
left outer join    material_lote_fornec lote on cabin.nr_seq_lote_fornec = lote.nr_sequencia
join    material medic on cabin.cd_material = medic.cd_material
where ((cabin.cd_material = item.cd_material)  or
		(medic.nr_seq_ficha_tecnica = (	SELECT  max(x.nr_seq_ficha_tecnica)
										from    material x
										where	x.cd_material = item.cd_material)) or (item.cd_material = medic.cd_material_generico))
and		cabin.qt_estoque	> 0
and (cabin.cd_pessoa_fisica IS NOT NULL AND cabin.cd_pessoa_fisica::text <> '')
and item.nr_seq_ordem = nr_seq_ordem_p
and w.nm_usuario = nm_usuario_p;

/* control patient medicines to avoid duplicates */

if (ie_exist_patient_medic_w = 'S') then
begin
	select count(c.nr_seq_ficha_tecnica),
			c.nr_seq_ficha_tecnica,
			max(a.cd_pessoa_fisica)
	into STRICT qt_ficha_tecnica_w,
		nr_seq_ficha_tec_w,
		cd_pf_vinculo_w
	FROM can_ordem_item_prescr f, can_ordem_prod e, far_etapa_producao d, material c, far_estoque_cabine a
LEFT OUTER JOIN material_lote_fornec b ON (a.nr_seq_lote_fornec = b.nr_sequencia)
WHERE f.nr_seq_ordem = e.nr_sequencia and d.nr_sequencia = e.nr_seq_etapa_prod and d.nr_seq_cabine = a.nr_seq_cabine  and a.cd_material	     = c.cd_material and ((a.cd_material = f.cd_material)  or
			(c.nr_seq_ficha_tecnica = (	SELECT  max(x.nr_seq_ficha_tecnica)
										from    material x
										where	x.cd_material = f.cd_material))or (f.cd_material = c.cd_material_generico)) and e.nr_sequencia = nr_seq_ordem_p and f.cd_material = cd_material_patient_w and a.qt_estoque	> 0 group by c.nr_seq_ficha_tecnica;

	/* seek leftover and/or overfill that has the same active principle of the medicine from the cabin, correlated to the prescribed medicine, to compare to the medicine owned by the patient */
	if (qt_ficha_tecnica_w > 0) then
	begin
		select coalesce(max(count(medicine.nr_seq_ficha_tecnica)),0)
		into STRICT	qt_ficha_tec_sobra_w
		from    can_ordem_item_prescr item_prescr_ord_prod
		join    can_ordem_prod ord_prod on item_prescr_ord_prod.nr_seq_ordem = ord_prod.nr_sequencia
		join    far_etapa_producao etapa on etapa.nr_sequencia = ord_prod.nr_seq_etapa_prod
		join    quimio_sobra_overfill sobraoverfill on etapa.nr_seq_cabine = sobraoverfill.nr_seq_cabine
		left outer join    material_lote_fornec lote on sobraoverfill.nr_seq_lote_fornec = lote.nr_sequencia
		join    material medicine on sobraoverfill.cd_material = medicine.cd_material		
		where ((sobraoverfill.cd_material = item_prescr_ord_prod.cd_material)  or
				(medicine.nr_seq_ficha_tecnica = (	SELECT  max(x.nr_seq_ficha_tecnica)
												from    material x
												where	x.cd_material = item_prescr_ord_prod.cd_material)) or (item_prescr_ord_prod.cd_material = medicine.cd_material_generico))
		and		qt_saldo	> 0
		and		ord_prod.nr_sequencia = nr_seq_ordem_p 
		and     item_prescr_ord_prod.cd_material = cd_material_patient_w
		and 	Ie_sobras_overfill_ww = 'S'
		and   	((sobraoverfill.ie_tipo = 'O' AND ie_considera_overfill_w = 'S') or (sobraoverfill.ie_tipo = 'S') or ((ie_tela_deferenciada_w = 'S') and ((sobraoverfill.ie_tipo = 'SD') or (sobraoverfill.ie_tipo = 'OD'))))
		and		coalesce(dt_estabilidade,clock_timestamp() + interval '1 days') > clock_timestamp()
		and		(((round((Obter_conversao_ml(sobraoverfill.cd_material, sobraoverfill.qt_saldo,sobraoverfill.cd_unidade_medida))::numeric,2) <= round((Obter_conversao_ml(sobraoverfill.cd_material, item_prescr_ord_prod.qt_dose,item_prescr_ord_prod.cd_unidade_medida))::numeric,2)) and (sobraoverfill.ie_tipo = 'SD' or sobraoverfill.ie_tipo = 'OD')) or (sobraoverfill.ie_tipo <> 'SD' and sobraoverfill.ie_tipo <> 'OD'))
		and coalesce((select round((max(obter_conversao_ml(x.cd_material, x.qt_saldo, x.cd_unidade_medida)))::numeric, 2) 
				from    quimio_sobra_overfill x 
				where   cd_estabelecimento = cd_estabelecimento_p
				and	   x.nr_seq_superior = sobraoverfill.nr_sequencia
				and	   x.ie_tipo = 'DI'),0) <= qt_dose_prescr_dil_w
		Group by item_prescr_ord_prod.cd_material;
	end;
	end if;
end;
end if;

open C01;
loop
fetch C01 into
	can_ordem_item_prescr_w,
	nr_seq_cabine_w,
	cd_material_prescrito_w,
	cd_material_w,
	qt_estoque_w,
	cd_unidade_medida_consumo_w,
	ds_lote_fornec_w,
	qt_dose_w,
	cd_unid_med_prescr_w,
	nr_seq_lote_fornec_w,
	qt_dose_apres_ml_w,
	Ie_sobras_overfill_w,
	ie_via_aplicacao_w,
	dt_estabilidade_w,
	nr_seq_sobra_overfill_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	select	max(cd_unid_med_concetracao),
		max(cd_unid_med_base_conc)
	into STRICT	cd_unid_med_concetracao_w,
		cd_unid_med_base_conc_w
	from 	material
	where 	cd_material = cd_material_prescrito_w;

	qt_dose_util_cons_w := qt_dose_w;

	if (cd_material_prescrito_w IS NOT NULL AND cd_material_prescrito_w::text <> '') and (cd_unid_med_concetracao_w IS NOT NULL AND cd_unid_med_concetracao_w::text <> '') and (lower(cd_unid_med_concetracao_w) <> lower(obter_unid_med_usua('ml')))  and (lower(cd_unid_med_base_conc_w) = lower(obter_unid_med_usua('ml'))) then
		select 	Obter_dose_convertida_quimio(cd_material_prescrito_w,qt_dose_w,cd_unid_med_prescr_w,cd_unid_med_concetracao_w)
		into STRICT	qt_dose_w
		;

		select	coalesce(max('S'),'N')
		into STRICT	ie_unidade_equivalentes_w
		from 	material
		where 	cd_material = cd_material_w
		and 	cd_unid_med_concetracao = cd_unid_med_concetracao_w
		and 	cd_unid_med_base_conc = cd_unid_med_base_conc_w;

		if (ie_unidade_equivalentes_w = 'S') then
			select	max(cd_unid_med_concetracao),
				max(cd_unid_med_base_conc),
				max(qt_conversao_mg)
			into STRICT	cd_unid_med_concetracao_w,
				cd_unid_med_base_conc_w,
				qt_conversao_mg_w
			from 	material
			where 	cd_material = cd_material_w;

		qt_dose_ml_w := dividir_sem_round(qt_dose_w,qt_conversao_mg_w);
		end if;
	else
		if (coalesce(qt_dose_apres_ml_w,0) = 0) then
			select 	Obter_dose_convertida_quimio(cd_material_w,qt_dose_w,cd_unid_med_prescr_w,obter_unid_med_usua('ml'))
			into STRICT	qt_dose_ml_w
			;
			
			if (ie_conv_ml_w = 'S') then
			
				select 	max(Obter_dose_convertida_quimio(a.cd_material,a.qt_dose,a.cd_unidade_medida,obter_unid_med_usua('ml')))
				into STRICT	qt_diluicao_w
				from   	can_ordem_prod b,
						can_ordem_item_prescr a
				where  	b.nr_sequencia = a.nr_seq_ordem
				and		nr_seq_ordem = nr_seq_ordem_p
				and		ie_agrupador = 9;
				
				qt_dose_ml_w := obter_conversao_unid_med_cons(cd_material_w, cd_unid_med_prescr_w, qt_dose_w) * qt_diluicao_w;
			end if;
		else
			qt_dose_ml_w := qt_dose_apres_ml_w;
		end if;

		select 	Obter_dose_convertida_quimio(cd_material_w,qt_estoque_w,cd_unidade_medida_consumo_w,obter_unid_med_usua('ml'))
		into STRICT	qt_estoque_ml_w
		;
				
		if (qt_estoque_ml_w > qt_dose_ml_w) then
			qt_estoque_ww := qt_dose_ml_w;
			qt_dose_mg_ww := qt_dose_w;
		else
			qt_estoque_ww := qt_estoque_ml_w;
			qt_dose_mg_ww := qt_estoque_w;
		end if;
	end if;

	select 	Obter_dose_convertida_quimio(cd_material_w,qt_estoque_w,cd_unidade_medida_consumo_w,obter_unid_med_usua('ml'))
	into STRICT	qt_total_cabine_ml_w
	;
	
	if (ie_conv_ml_w = 'S') and (coalesce(qt_total_cabine_ml_w,0) = 0) then

		select 	max(Obter_dose_convertida_quimio(a.cd_material,a.qt_dose,a.cd_unidade_medida,obter_unid_med_usua('ml')))
		into STRICT	qt_diluicao_w
		from   	can_ordem_prod b,
				can_ordem_item_prescr a
		where  	b.nr_sequencia = a.nr_seq_ordem
		and		nr_seq_ordem = nr_seq_ordem_p
		and		ie_agrupador = 9;
		
		qt_total_cabine_ml_w := (obter_conversao_unid_med_cons(cd_material_w, cd_unid_med_prescr_w, qt_dose_w) * qt_diluicao_w) * qt_estoque_w;
	end if;

	begin
	insert into w_preparo_quimio(
		nr_sequencia, --Sequencial
		dt_atualizacao, --Data de atualizacao
		nm_usuario, --Usuario
		dt_atualizacao_nrec, -- Data de atualizacao
		nm_usuario_nrec, --Usuario Atualizacao
		nr_seq_cabine, --Numero da cabine
		ie_selecionado, --Se selecionado
		cd_material, --Material
		qt_material, -- Quantidade de medicamento na cabin
		cd_unidade_medida,
		qt_dose_ml,
		qt_dose_util_ml,
		nr_seq_lote_fornec,
		nr_seq_can_ordem_item,
		qt_total_cabine_ml,
		qt_dose_util_cons,
		ie_sobra_overfill,
		dt_estabilidade,
		nr_seq_quimio_over) -- nr_sequencia da tabela QUIMIO_SOBRA_OVERFILL
	SELECT 	nextval('w_preparo_quimio_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_cabine_w,
		'N',
		cd_material_w,
		qt_estoque_w,
		cd_unidade_medida_consumo_w,
		coalesce(qt_dose_ml_w,0),
		0,
		nr_seq_lote_fornec_w,
		can_ordem_item_prescr_w,
		qt_total_cabine_ml_w,
		0,
		Ie_sobras_overfill_w,
		dt_estabilidade_w,
		nr_seq_sobra_overfill_w
	;
	exception
	when others then
	   null;
	end;

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE carrega_medicamentos_manip ( nr_seq_ordem_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

