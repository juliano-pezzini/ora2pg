-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_data_exam_pend (CD_LABORATORIO_P bigint, IE_SOMENTE_PENDENTE_P text, DT_LIBERACAO_P timestamp) AS $body$
DECLARE


C01 CURSOR FOR
	SELECT	a.nr_seq_interno
	from	prescr_procedimento a,
			prescr_medica b,
			exame_laboratorio c

	where 	b.nr_prescricao = a.nr_prescricao
	and c.nr_seq_exame = a.nr_seq_exame
	and c.cd_cgc_externo = CD_LABORATORIO_P
	and trunc(b.dt_liberacao) = trunc(to_date(DT_LIBERACAO_P))
    and ((IE_SOMENTE_PENDENTE_P = 'N' and (a.dt_integracao IS NOT NULL AND a.dt_integracao::text <> '')) or coalesce(a.dt_integracao::text, '') = '');

qt_atualizado_w		bigint;
c01_w				c01%rowtype;


BEGIN
	qt_atualizado_w	:= 0;
	open C01;
	loop
		fetch C01 into c01_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */

		begin
			update	prescr_procedimento
			set		dt_integracao = clock_timestamp()
			where	nr_seq_interno = c01_w.nr_seq_interno;

			qt_atualizado_w := qt_atualizado_w + 1;

			if (qt_atualizado_w = 100) then
				commit;
				qt_atualizado_w	:= 0;
			end if;
		end;
	end loop;

close C01;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_data_exam_pend (CD_LABORATORIO_P bigint, IE_SOMENTE_PENDENTE_P text, DT_LIBERACAO_P timestamp) FROM PUBLIC;

