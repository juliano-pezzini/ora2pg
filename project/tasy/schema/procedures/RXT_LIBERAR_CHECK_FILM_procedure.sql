-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rxt_liberar_check_film ( nr_sequencia_p bigint, ie_opcao_p text, nr_seq_agenda_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_atendimento_w    bigint;
nr_seq_tratamento_w bigint;
ie_gera_conta_w         varchar(1);
dt_lib_medico_w         timestamp;
dt_lib_tecnico_w        timestamp;
nr_seq_trat_checkfilm_w rxt_trat_check_film.nr_seq_tratamento%TYPE;


BEGIN
    ie_gera_conta_w := 'N';

    SELECT  MAX(nr_atendimento),
        MAX(nr_seq_tratamento)
    INTO STRICT    nr_atendimento_w,
        nr_seq_tratamento_w
    FROM    rxt_agenda
    WHERE   nr_sequencia = nr_seq_agenda_p;

    
    SELECT  MAX(dt_lib_medico),
        MAX(dt_lib_tecnico)
    INTO STRICT    dt_lib_medico_w,
        dt_lib_tecnico_w
    FROM    rxt_trat_check_film
    WHERE   nr_sequencia    = nr_sequencia_p;

IF (ie_opcao_p = 'T') THEN

    UPDATE  rxt_trat_check_film
    SET dt_lib_tecnico  = clock_timestamp(),
        nm_usuario  = nm_usuario_p,
        dt_atualizacao  = clock_timestamp(),
        nm_usuario_lib_tec = nm_usuario_p
    WHERE   nr_sequencia    = nr_sequencia_p;

    IF coalesce(dt_lib_medico_w::text, '') = '' THEN
        ie_gera_conta_w := 'S';
    END IF;

ELSIF (ie_opcao_p = 'M') THEN

    UPDATE  rxt_trat_check_film
    SET dt_lib_medico   = clock_timestamp(),
        nm_usuario  = nm_usuario_p,
        dt_atualizacao  = clock_timestamp(),
        nm_usuario_lib_medico = nm_usuario_p
    WHERE   nr_sequencia    = nr_sequencia_p;

    IF coalesce(dt_lib_tecnico_w::text, '') = '' THEN
        ie_gera_conta_w := 'S';
    END IF;

    <<update_ie_checkfilm>>
    BEGIN
        SELECT MAX(nr_seq_tratamento)
        INTO STRICT nr_seq_trat_checkfilm_w
        FROM rxt_trat_check_film
        WHERE nr_sequencia = nr_sequencia_p;

        IF (coalesce(nr_seq_trat_checkfilm_w::text, '') = '') THEN
            SELECT MAX(tratamento.nr_sequencia)
            INTO STRICT nr_seq_trat_checkfilm_w
            FROM 
                rxt_trat_check_film checkfilm,
                rxt_tumor tumor,
                rxt_tratamento tratamento
            WHERE checkfilm.nr_sequencia = nr_sequencia_p
            AND checkfilm.cd_paciente = tumor.cd_pessoa_fisica
            AND tratamento.nr_seq_tumor = tumor.nr_sequencia
            AND coalesce(tratamento.dt_suspensao::text, '') = ''
            AND coalesce(tratamento.dt_cancelamento::text, '') = '';
        END IF;

        IF (nr_seq_trat_checkfilm_w IS NOT NULL AND nr_seq_trat_checkfilm_w::text <> '') THEN
            CALL rxt_register_checkfilm_image(
                nr_seq_rxt_tratamento_p => nr_seq_trat_checkfilm_w
            );
        END IF;
    END;

END IF;

IF ie_gera_conta_w = 'S' THEN
    CALL rxt_inserir_proced_conta(
        nr_seq_tratamento_p => nr_seq_tratamento_w,
        nm_usuario_p => nm_usuario_p,
        nr_atendimento_p => nr_atendimento_w,
        cd_setor_atendimento_p => 2,
        cd_estabelecimento_p => 1,
        nr_seq_agenda_rxt_p => nr_seq_agenda_p,
        ie_opcao_p => 'CF'
    );
END IF;

CALL Rxt_Gerar_Proced_Fat(
    nr_seq_agenda_p => nr_seq_agenda_p,
    nr_seq_campo_p => NULL,
    ie_tipo_lancamento_p => 'C',
    nm_usuario_p => nm_usuario_p
);

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rxt_liberar_check_film ( nr_sequencia_p bigint, ie_opcao_p text, nr_seq_agenda_p bigint, nm_usuario_p text) FROM PUBLIC;

