-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_lab_impressao (nr_prescricao_p bigint, nr_seq_prescr_p bigint, ie_mapa_laudo_p text, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_prescr_w		bigint;
nr_seq_exame_w		bigint;
nr_seq_material_w		bigint;
nr_seq_formato_w		bigint;
ie_formato_pai_w		varchar(3);
qt_dec_exame_w		smallint;

nr_exame_formato_w	bigint;
ds_texto_w			varchar(2000);
nr_linha_w			smallint;
nr_coluna_w			smallint;
nm_exame_w			varchar(60);
ie_formato_w		varchar(3);
ds_unid_formato_w		varchar(40);
qt_dec_formato_w		smallint;

ds_antibiotico_w		varchar(50);
nr_antib_w			smallint;
nr_item_w			smallint;

i				smallint := 0;
i_aux				smallint := 0;
x				smallint := 0;
qt_tamanho_w		smallint := 0;
qt_espaco_w			smallint := 0;
ds_traco_w			varchar(300) := '____________________________________________________________________________________________________';
qt_dec_mat_w		smallint;
nr_exames_w			smallint;
nr_linha_aux_w		smallint := 0;
nr_coluna_aux_w		smallint := 0;
nr_linha_extra_w		smallint := 0;
ds_metodo_w			varchar(255);
ie_ok_w			varchar(1) := 'S';

pr_resultado_w		double precision;
qt_resultado_w		double precision;
ds_resultado_w		varchar(4000);
pr_minimo_w			double precision;
pr_maximo_w			double precision;
qt_minima_w			double precision;
qt_maxima_w			double precision;
ds_referencia_w		varchar(4000);
ds_observacao_w		varchar(4000);
ds_unid_result_w		varchar(40);
nr_seq_resultado_w	bigint;
nr_seq_result_item_w	bigint;

ds_micro_w			varchar(255) := '';
qt_micro_w			varchar(40) := '';
ie_result_w			varchar(1) := '';
ie_result_aux_w		varchar(1) := ' ';
ds_micro_aux_w		varchar(50) := ' ';

C01 CURSOR FOR 
	SELECT a.nr_sequencia, 
		 a.nr_seq_exame, 
		 b.nr_sequencia 
	from	exame_laboratorio c, 
		material_exame_lab b, 
		prescr_procedimento a 
	where a.cd_material_exame = b.cd_material_exame 
	 and a.nr_seq_exame = c.nr_seq_exame 
	 and a.nr_prescricao = nr_prescricao_p 
	 and ((a.nr_sequencia = nr_seq_prescr_p) or (nr_seq_prescr_p = 0)) 
	 and c.nr_seq_grupo < 3000;

C02 CURSOR FOR 
	SELECT a.nr_seq_exame, 
		 a.ds_texto, 
		 a.nr_linha, 
		 a.nr_coluna, 
		 b.nm_exame, 
		 b.ie_formato_resultado, 
		 b.ds_unidade_medida, 
		 coalesce(b.qt_decimais,qt_dec_exame_w) 
	FROM exame_lab_format_item a
LEFT OUTER JOIN exame_laboratorio b ON (a.nr_seq_exame = b.nr_seq_exame)
WHERE a.nr_seq_formato = nr_seq_formato_w  order by a.nr_linha, a.nr_coluna;

C03 CURSOR FOR 
	SELECT ds_medicamento 
	from cih_medicamento 
	where ie_situacao = 'A' 
	order by 1;

c04 CURSOR FOR 
	SELECT /*+ index (a exalari_exalare_fk_i) */ 
		 coalesce(a.pr_resultado,0), 
		 coalesce(a.qt_resultado,0), 
		 a.ds_resultado, 
		 a.pr_minimo, 
		 a.pr_maximo, 
		 a.qt_minima, 
		 a.qt_maxima, 
		 a.ds_referencia, 
		 a.ds_observacao, 
		 a.ds_unidade_medida, 
		 a.nr_seq_resultado, 
		 a.nr_sequencia 
	from	exame_lab_result_item a, 
		exame_lab_resultado b 
	where a.nr_seq_resultado = b.nr_seq_resultado 
	 and ((ie_formato_w <> 'SM') or (coalesce(a.nr_seq_material::text, '') = '')) 
	 and b.nr_prescricao = nr_prescricao_p 
	 and a.nr_seq_prescr = nr_seq_prescr_w 
	 and a.nr_seq_exame = nr_exame_formato_w;

C05 CURSOR FOR 
	SELECT /*+ index (a exalame_pk) index (b metexla_pk) */ 
		 b.ds_metodo 
	from	metodo_exame_lab b, 
		exame_lab_metodo a 
	where a.nr_seq_metodo = b.nr_sequencia 
	 and a.nr_seq_exame = nr_exame_formato_w 
	order by 1;

C06 CURSOR FOR 
	SELECT c.ds_microorganismo, 
		 b.qt_microorganismo, 
		 b.ie_resultado, 
		 a.ds_medicamento 
	FROM cih_microorganismo c, exame_lab_result_antib b
LEFT OUTER JOIN cih_medicamento a ON (b.cd_medicamento = a.cd_medicamento)
WHERE b.cd_microorganismo = c.cd_microorganismo and (coalesce(b.ie_resultado::text, '') = '' or (b.ie_resultado <> 'N')) and b.nr_seq_resultado = nr_seq_resultado_w and b.nr_seq_result_item = nr_seq_result_item_w order by 1,3 desc, 4;


BEGIN 
 
delete FROM w_lab_impressao 
where nm_usuario = nm_usuario_p 
 and nr_prescricao = nr_prescricao_p;
 
open C01;
loop 
fetch C01 into nr_seq_prescr_w, 
		  nr_seq_exame_w, 
		  nr_seq_material_w;
 
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	select a.nr_seq_formato, 
		 c.ie_formato_resultado, 
		 coalesce(b.qt_decimais, c.qt_decimais) 
	into STRICT	 nr_seq_formato_w, 
		 ie_formato_pai_w, 
		 qt_dec_exame_w 
	from	exame_laboratorio c, 
		exame_lab_material b, 
		exame_lab_format a 
	where a.nr_seq_exame = b.nr_seq_exame 
	 and a.nr_seq_material = b.nr_seq_material 
	 and a.nr_seq_exame  = c.nr_seq_exame 
	 and a.nr_seq_formato	= obter_formato_exame(nr_seq_exame_w, nr_seq_material_w, '', ie_mapa_laudo_p);
	exception 
		when no_data_found then 
			select nm_exame 
			into STRICT nm_exame_w 
			from exame_laboratorio 
			where nr_seq_exame = nr_seq_exame_w;
			--' Não foi encontrado formato para o exame : "'|| nm_exame_w ||'" !',null 
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(264075,'NM_EXAME='||nm_exame_w);
	end;
 
	select count(*) 
	into STRICT nr_exames_w 
	from exame_lab_format_item a 
	where ((coalesce(ds_texto::text, '') = '') or (ds_texto not like '@%')) 
	 and nr_seq_formato = nr_seq_formato_w;
 
	insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, -1, -1, to_char(nr_exames_w), 
							0, 'D', '', 0, nm_usuario_p);
	x := 0;
	i := 0;
	i_aux := 0;
	nr_linha_aux_w := 0;
	nr_linha_extra_w := 0;
	nr_coluna_aux_w := 0;
	open C02;
	loop 
	fetch C02 into nr_exame_formato_w, 
		 	  ds_texto_w, 
		 	  nr_linha_w, 
			  nr_coluna_w, 
			  nm_exame_w, 
			  ie_formato_w, 
			  ds_unid_formato_w, 
			  qt_dec_formato_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		select coalesce(qt_decimais, qt_dec_formato_w), 
			 coalesce(ds_unidade_medida, ds_unid_formato_w) 
		into STRICT	qt_dec_mat_w, 
			ds_unid_formato_w 
		from exame_lab_material 
		where nr_seq_exame = nr_exame_formato_w 
		 and nr_seq_material = nr_seq_material_w;
		exception 
			when others then 
				qt_dec_mat_w := qt_dec_formato_w;
		end;
 
		if (ie_mapa_laudo_p = 'M') then 
			if (coalesce(nr_exame_formato_w::text, '') = '') then 
				if (Upper(ds_texto_w) = '@ANTIBIÓTICOS') then 
					select count(*) 
					into STRICT nr_antib_w 
					from cih_medicamento 
					where ie_situacao = 'A';
					if (mod(nr_antib_w,3) = 0) then 
						nr_antib_w := Trunc(nr_antib_w/3);
					else 
						nr_antib_w := Trunc(nr_antib_w/3) + 1;
					end if;
					nr_item_w := 0;
					nr_linha_extra_w := nr_antib_w;
 
					open C03;
					loop 
					fetch C03 into ds_antibiotico_w;
					EXIT WHEN NOT FOUND; /* apply on C03 */
						nr_item_w := nr_item_w + 1;
						if (nr_item_w = 1) then 
							for i in 0..2 loop 
								insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
								(nr_coluna_w * 12) + (i * 235), obter_desc_expressao(283530), 0, 'E', '', 0, nm_usuario_p);
 
								insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
								(nr_coluna_w * 12) + (i * 235) + 130, 'S|R|I S|R|I S|R|I', 0, 'E', '', 0, nm_usuario_p);
							end loop;
						end if;
						if (nr_item_w > nr_antib_w) then 
							nr_item_w := 1;
							x := x + 1;
						end if;
 
						insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w + nr_item_w + 1, 
						(nr_coluna_w * 12) + (x * 235), substr(ds_antibiotico_w,1,23), 0, 'E', '', 0, nm_usuario_p);
						insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w + nr_item_w + 1, 
						(nr_coluna_w * 12) + (x * 235) + 130, '_|_|_ _|_|_ _|_|_', 0, 'E', '', 0, nm_usuario_p);
					end loop;
					close C03;
				elsif (Upper(substr(ds_texto_w,1,15)) = '@MICROORGANISMO') then 
					ds_texto_w := obter_desc_expressao(779484)||substr(ds_texto_w,16,length(ds_texto_w)-15)||' - '||obter_desc_expressao(779482);
					insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
					(nr_coluna_w * 12) - 10, ds_texto_w, 0, 'D', '', 0, nm_usuario_p);
					insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
					(nr_coluna_w * 12), ds_traco_w, 200, 'E', '', 0, nm_usuario_p);
 
					insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
					(nr_coluna_w * 12) + 210, obter_desc_expressao(779490), 65, 'E', '', 0, nm_usuario_p);
					insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
					(nr_coluna_w * 12) + 285, ds_traco_w, 150, 'E', '', 0, nm_usuario_p);
 
					insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
					(nr_coluna_w * 12) + 445, obter_desc_expressao(779494), 0, 'E', '', 0, nm_usuario_p);
				else 
					insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
					(nr_coluna_w * 12), ds_texto_w, 0, 'E', '', 0, nm_usuario_p);
				end if;
			else 
				insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
				(nr_coluna_w * 12) - 10, nm_exame_w, 0, 'D', '', 0, nm_usuario_p);
				qt_tamanho_w := 90;
				if (ie_formato_w <> 'VP') then 
					if (ie_formato_w = 'D') or (ie_formato_w = 'S') then 
						qt_tamanho_w := 300;
					end if;
					insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
					(nr_coluna_w * 12), ds_traco_w, qt_tamanho_w, 'E', '', 0, nm_usuario_p);
					if (ds_unid_formato_w <> '') or (ds_unid_formato_w IS NOT NULL AND ds_unid_formato_w::text <> '') then 
						insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
						(nr_coluna_w * 12) + qt_tamanho_w + 10, ds_unid_formato_w, 0, 'E', '', 0, nm_usuario_p);
					end if;
				elsif (ie_formato_w = 'VP') then 
					insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
					(nr_coluna_w * 12), ds_traco_w, qt_tamanho_w, 'E', '', 0, nm_usuario_p);
					insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
					(nr_coluna_w * 12) + 100, ds_traco_w, qt_tamanho_w, 'E', '', 0, nm_usuario_p);
					if (ds_unid_formato_w <> '') or (ds_unid_formato_w IS NOT NULL AND ds_unid_formato_w::text <> '') then 
						insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
						(nr_coluna_w * 12) + 190, ds_unid_formato_w, 0, 'E', '', 0, nm_usuario_p);
					end if;
				end if;
			end if;
		else 
			if (nr_linha_aux_w = 0) then 
				nr_linha_aux_w := nr_linha_w;
			end if;
			if (substr(ds_texto_w,1,1) = '@') then 
				exit;
			end if;
 
			nr_linha_w := nr_linha_w + nr_linha_extra_w;
			x := 0;
 
			if (coalesce(nr_exame_formato_w::text, '') = '') then 
				insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
				(nr_coluna_w * 12), ds_texto_w, 0, 'E', '', 0, nm_usuario_p);
			else 
				open C04;
				loop 
				fetch C04 into	pr_resultado_w, 
							qt_resultado_w, 
							ds_resultado_w, 
							pr_minimo_w, 
							pr_maximo_w, 
							qt_minima_w, 
							qt_maxima_w, 
							ds_referencia_w, 
							ds_observacao_w, 
							ds_unid_result_w, 
							nr_seq_resultado_w, 
							nr_seq_result_item_w;
				EXIT WHEN NOT FOUND; /* apply on C04 */
 
				ie_ok_w := 'S';
			   if ((ie_formato_pai_w = 'SM') and 
				  ((position(ie_formato_w in 'DSMS') > 0) and (coalesce(ds_resultado_w::text, '') = '')) or 
				  ((ie_formato_w = 'P') and (coalesce(pr_resultado_w::text, '') = '')) or 
				  ((ie_formato_w = 'V') and (coalesce(qt_resultado_w::text, '') = ''))) then 
					if (coalesce(ds_observacao_w::text, '') = '') then 
						exit;
					else 
						ie_ok_w := 'N';
					end if;
				end if;
 
				if (ie_formato_w <> 'SM') and (ie_ok_w = 'S') then 
					insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
					(nr_coluna_w * 12) - 10, nm_exame_w, 0, 'D', '', 0, nm_usuario_p);
				end if;
				if (ie_formato_w = 'SM') then 
					ds_micro_aux_w := ' ';
					ie_result_aux_w := ' ';
					nr_coluna_aux_w := 12;
					nr_coluna_w	:= 1;
					if (substr(Upper(ds_resultado_w),1,7) = 'POSITIV') then 
						open C06;
						loop 
						fetch C06 into	ds_micro_w, 
									qt_micro_w, 
									ie_result_w, 
									ds_antibiotico_w;
						EXIT WHEN NOT FOUND; /* apply on C06 */
							if (ds_micro_aux_w <> ds_micro_w) then 
								ie_result_aux_w := ' ';
								nr_coluna_aux_w := 12;
								if (i_aux <> 0) then 
									nr_linha_w := nr_linha_w + x + i_aux + 2;
								end if;
								x := 0;
								i_aux := 0;
								insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w + 1, 
 
								nr_coluna_aux_w, obter_desc_expressao(286420)||' : ' || ds_micro_w, 0, 'E', 'N', 0, nm_usuario_p);
								x := x + 1;
								if (qt_micro_w IS NOT NULL AND qt_micro_w::text <> '') then 
									insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w + 2, 
									nr_coluna_aux_w, obter_desc_expressao(286421)||' : ' || qt_micro_w || '  '||obter_desc_expressao(779494), 0, 'E', '', 0, nm_usuario_p);
									x := x + 1;
								end if;
								ds_micro_aux_w := ds_micro_w;
								nr_coluna_aux_w := nr_coluna_aux_w + 34;
							end if;
							if (ie_result_aux_w <> ie_result_w) then 
								if (nr_coluna_aux_w <> 46) then 
									nr_coluna_aux_w := nr_coluna_aux_w + 230;
								end if;
								insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, 
								nr_linha_w + x + 1, nr_coluna_aux_w, 
								CASE WHEN ie_result_w='S' THEN obter_desc_expressao(306274) WHEN ie_result_w='R' THEN obter_desc_expressao(306164)  ELSE obter_desc_expressao(304784) END , 0, 'E', '', 0, nm_usuario_p);
								ie_result_aux_w := ie_result_w;
								nr_coluna_aux_w := nr_coluna_aux_w + 24;
								i := 0;
							end if;
							i := i + 1;
							insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, 
							nr_linha_w + x + i + 1, 
							nr_coluna_aux_w, ds_antibiotico_w, 0, 'E', '', 0, nm_usuario_p);
							if (i > i_aux) then 
								i_aux := i;
							end if;
						end loop;
						close C06;
						x := x + i_aux + 1;
					elsif (ds_resultado_w IS NOT NULL AND ds_resultado_w::text <> '') then 
						insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w + 1, 
						250, 'NÃO HOUVE CRESCIMENTO BACTERIANO !', 0, 'E', '', 0, nm_usuario_p);
						nr_linha_w := nr_linha_w + 2;
					end if;
				elsif (ie_formato_w <> 'VP') then 
					if (ie_formato_w <> 'P') and (ie_formato_w <> 'V') then 
						insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
						(nr_coluna_w * 12), ds_resultado_w || '  ' || ds_unid_result_w, 0, 'E', '', 0, nm_usuario_p);
					else 
						insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
						(nr_coluna_w * 12) + 80,to_char(pr_resultado_w + qt_resultado_w), 0, 'D', '', 
						qt_dec_mat_w, nm_usuario_p);
						if (ds_unid_result_w <> '') or (ds_unid_result_w IS NOT NULL AND ds_unid_result_w::text <> '') then 
							insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
							(nr_coluna_w * 12) + 90, ds_unid_result_w, 0, 'E', '', 0, nm_usuario_p);
						end if;
					end if;
				elsif (ie_formato_w = 'VP') then 
					insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
					(nr_coluna_w * 12) + 80, to_char(pr_resultado_w), 80, 'D', '', qt_dec_mat_w, nm_usuario_p);
					insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
					(nr_coluna_w * 12) + 170, to_char(qt_resultado_w), 80, 'D', '', qt_dec_mat_w, nm_usuario_p);
 
					if (ds_unid_result_w <> '') or (ds_unid_result_w IS NOT NULL AND ds_unid_result_w::text <> '') then 
						insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
						(nr_coluna_w * 12) + 180, ds_unid_result_w, 0, 'E', '', 0, nm_usuario_p);
					end if;
				end if;
				if ((pr_minimo_w > 0) or (pr_maximo_w > 0)) or 
				  ((qt_minima_w > 0) or (qt_maxima_w > 0)) then 
					nr_coluna_aux_w := 485;
					begin 
					if (nr_exames_w = 1) then 
						insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
						365, obter_desc_expressao(301492)||':', 0, 'E', '', 0, nm_usuario_p);
					else 
						insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_aux_w, 
						530, obter_desc_expressao(316636), 0, 'E', '', 0, nm_usuario_p);
					end if;
					exception 
						when others then 
							nr_coluna_aux_w := 485;
					end;
 
					if (pr_minimo_w > 0) or (pr_maximo_w > 0) then 
						insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
						485, to_char(pr_minimo_w), 60, 'D', '', qt_dec_mat_w, nm_usuario_p);
						insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
						490, 'a', 0, 'E', '', 0, nm_usuario_p);
						insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
						555, to_char(pr_maximo_w), 60, 'D', '', qt_dec_mat_w, nm_usuario_p);
					end if;
					if ((pr_minimo_w > 0) or (pr_maximo_w > 0)) and 
					  ((qt_minima_w > 0) or (qt_maxima_w > 0)) then 
						nr_coluna_aux_w := 625;
					end if;
					if ((qt_minima_w > 0) or (qt_maxima_w > 0)) then 
						insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
						nr_coluna_aux_w, to_char(qt_minima_w), 60, 'D', '', qt_dec_mat_w, nm_usuario_p);
						insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
						nr_coluna_aux_w + 5, 'a', 0, 'E', '', 0, nm_usuario_p);
						insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
						nr_coluna_aux_w + 65, to_char(qt_maxima_w), 60, 'D', '', qt_dec_mat_w, nm_usuario_p);
					end if;
					if (ds_unid_result_w <> '') or (ds_unid_result_w IS NOT NULL AND ds_unid_result_w::text <> '') then 
						insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w, 
						nr_coluna_aux_w + 75, ds_unid_result_w, 0, 'E', '', 0, nm_usuario_p);
					end if;
				end if;
				if (ds_referencia_w IS NOT NULL AND ds_referencia_w::text <> '') then 
					insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w + 1, 
					(nr_coluna_w * 12), obter_desc_expressao(301492)||': ', 0, 'E', '', 0, nm_usuario_p);
					insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w + 1, 
					(nr_coluna_w * 12) + 60, ds_referencia_w, 0, 'E', '', 0, nm_usuario_p);
					x := x + 1;
				end if;
 
				if (nr_exames_w = 1) then 
					open C05;
					loop 
					fetch C05 into ds_metodo_w;
					EXIT WHEN NOT FOUND; /* apply on C05 */
						insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w + x + 1, 
						(nr_coluna_w * 12), obter_desc_expressao(293273)||' : '||ds_metodo_w, 0, 'E', '', 0, nm_usuario_p);
						x := x + 1;
					end loop;
					close C05;
				end if;
 
				if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then 
					x := x + 1;
					insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w + x, 
					(nr_coluna_w * 12), 'Obs.: ', 0, 'E', '', 0, nm_usuario_p);
					insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, nr_linha_w + x, 
					(nr_coluna_w * 12) + 30, ds_observacao_w, 0, 'E', '', 0, nm_usuario_p);
				end if;
				nr_linha_extra_w := nr_linha_extra_w + x;
				end loop;
				close C04;
			end if;
		end if;
	end loop;
	close C02;
	insert into w_lab_impressao values (nr_prescricao_p, nr_seq_prescr_w, 0, 0, to_char(nr_exames_w + nr_linha_extra_w), 
							0, 'D', '', 0, nm_usuario_p);
end loop;
close C01;
commit;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_lab_impressao (nr_prescricao_p bigint, nr_seq_prescr_p bigint, ie_mapa_laudo_p text, nm_usuario_p text) FROM PUBLIC;

