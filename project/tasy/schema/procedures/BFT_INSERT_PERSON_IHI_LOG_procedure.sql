-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE bft_insert_person_ihi_log ( cd_pessoa_fisica_p person_ihi_log.cd_pessoa_fisica%type, nr_ihi_error_p person_ihi_log.nr_ihi_error%type, cd_error_p person_ihi_log.cd_error%type, ds_log_p person_ihi_log.ds_log%type, nr_message_error_p person_ihi_log.nr_message_error%type, ie_data_type_p person_ihi.ie_data_type%type, nm_usuario_p person_ihi_log.nm_usuario%type) AS $body$
DECLARE


nr_seq_person_ihi_w	person_ihi_log.nr_seq_person_ihi%type;

/* 	Requisitos anexados na OS 1982678

	ie_data_type_p 
	I for individuals
	P for professionals


*/
BEGIN

if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
-- 005873 - Creation of error log for all errors
	select	coalesce(max(nr_sequencia), 0)
	into STRICT 	nr_seq_person_ihi_w
	from 	person_ihi
	where 	cd_pessoa_fisica 	= cd_pessoa_fisica_p
	and	ie_data_type 	= ie_data_type_p
	and 	ie_situacao 	= 'A';
	
	if (nr_seq_person_ihi_w = 0) then
		nr_seq_person_ihi_w := bft_insert_person_IHI(cd_pessoa_fisica_p, null, null, 'E', null, ie_data_type_p, nm_usuario_p, nr_seq_person_ihi_w);
	end if;
-- END
	insert into person_ihi_log(
		nr_sequencia,
		nm_usuario,
		nm_usuario_nrec,
		dt_atualizacao,
		dt_atualizacao_nrec,
		cd_pessoa_fisica,
		nr_seq_person_ihi,
		nr_ihi_error,
		cd_error,
		ds_log,
		nr_message_error)
	values (	
		nextval('person_ihi_log_seq'),
		nm_usuario_p,
		nm_usuario_p,
		clock_timestamp(),
		clock_timestamp(),
		cd_pessoa_fisica_p,
		nr_seq_person_ihi_w,
		nr_ihi_error_p,
		cd_error_p,
		ds_log_p,
		nr_message_error_p);
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE bft_insert_person_ihi_log ( cd_pessoa_fisica_p person_ihi_log.cd_pessoa_fisica%type, nr_ihi_error_p person_ihi_log.nr_ihi_error%type, cd_error_p person_ihi_log.cd_error%type, ds_log_p person_ihi_log.ds_log%type, nr_message_error_p person_ihi_log.nr_message_error%type, ie_data_type_p person_ihi.ie_data_type%type, nm_usuario_p person_ihi_log.nm_usuario%type) FROM PUBLIC;

