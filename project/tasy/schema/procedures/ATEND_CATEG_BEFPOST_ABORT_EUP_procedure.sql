-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atend_categ_befpost_abort_eup ( ie_resp_nao_medico_p text, dt_validade_carteira_p timestamp, ie_perm_cart_venc_p text, ie_tipo_convenio_p bigint, ie_exige_guia_tipo_convenio_p text, cd_medico_resp_p text, ie_cons_permi_regra_atend_p text, nr_seq_cobertura_p bigint, ie_visao_cobertura_p text, ie_convenios_nao_liberados_p text, ie_convenios_liberados_p text, ie_clinica_p bigint, cd_pessoa_fisica_p text, ie_consiste_cart_convenio_w text, dt_entrada_p timestamp, cd_empresa_p bigint, cd_categoria_p text, ie_tipo_guia_p text, cd_senha_p text, ie_consiste_guia_senha_p text, ie_atualiza_guia_tipo_guia_p text, ie_alterou_guia_p text, ie_edicao_registro_p text, ie_tipo_atendimento_p bigint, nr_doc_convenio_old_p text, nr_doc_convenio_p text, nr_atendimento_p bigint, qt_convenio_atend_p bigint, ie_novo_registro_p text, cd_usuario_convenio_p text, cd_estabelecimento_p bigint, ie_exige_conv_estab_p text, cd_convenio_p bigint, cd_tipo_acomodacao_p bigint, cd_plano_convenio_p text, nr_seq_visao_p bigint, nm_usuario_p text, ds_msg_abort_p INOUT text, ds_msg_abort_cons_cart_p INOUT text, nr_doc_conv_retorno_p INOUT text, ie_focar_no_convenio_p INOUT text) AS $body$
DECLARE


ie_lib_acomod_plano_w			varchar(1);
ie_convenio_estab_w			varchar(1) := 'N';
ie_conv_exige_letra_cart_w		varchar(1) := 'N';
ie_letra_carteira_w			varchar(1);
qt_conv_atend_w				bigint;
nr_doc_convenio_w			varchar(20);
nr_atend_guia_iguais_w			bigint;
ie_obriga_empresa_w			varchar(1);
ie_lib_categ_tipo_atend_w		varchar(1) := 'S';
qt_plano_convenio_p			bigint;
ie_convenio_contido_w			varchar(1) := 'N';
ie_consiste_cod_conv_duplic_w		varchar(1);
ds_consist_cd_con_dupl_w		varchar(1);
ie_exige_cobertura_w			varchar(1);
qt_medico_w				bigint;
ie_resp_atend_w				varchar(1);
cd_usuario_convenio_w			varchar(50);



BEGIN

/*
PROCEDURE CRIADA PARA REALIZAR TODAS AS VERIFICAÇÕES DO EVENTO BEFOREPOST QUE RETORNAM MSG COM ABORT
*/
ie_focar_no_convenio_p := 'N';
-- Tratamento para visão especifica
if (nr_seq_visao_p = 18311) and (coalesce(cd_tipo_acomodacao_p,0) > 0) and (cd_plano_convenio_p IS NOT NULL AND cd_plano_convenio_p::text <> '') then

	ie_lib_acomod_plano_w := Obter_Se_Lib_Acomod_Plano(cd_convenio_p, cd_plano_convenio_p, cd_tipo_acomodacao_p);
	if (ie_lib_acomod_plano_w = 'N') then
		ds_msg_abort_p := substr(obter_texto_dic_objeto(285145, wheb_usuario_pck.get_nr_seq_idioma, 'DS_ACOMODACAO='||OBTER_DESC_TIPO_ACOMOD(cd_tipo_acomodacao_p) ||
		';DS_PLANO='|| Obter_Desc_Plano(cd_convenio_p,cd_plano_convenio_p)),1,255);
		if (ds_msg_abort_p IS NOT NULL AND ds_msg_abort_p::text <> '') then
			goto final;
		end if;
	end if;
end if;

if (ie_visao_cobertura_p = 'S') then
	select	coalesce(max(ie_exige_cobertura),'N')
	into STRICT	ie_exige_cobertura_w
        from	convenio_estabelecimento
        where	cd_convenio = cd_convenio_p
        and 	cd_estabelecimento = cd_estabelecimento_p;

	if (ie_exige_cobertura_w = 'S') and (coalesce(nr_seq_cobertura_p,0) = 0) then
		ds_msg_abort_p := substr(obter_texto_tasy(90730, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		if (ds_msg_abort_p IS NOT NULL AND ds_msg_abort_p::text <> '') then
			goto final;
		end if;
	end if;

end if;

nr_doc_convenio_w := nr_doc_convenio_p;

if (ie_exige_conv_estab_p = 'C') then
	ie_convenio_estab_w := Obter_Valor_Conv_Estab(cd_convenio_p, cd_estabelecimento_p, 'IE_EXIGE_CARTEIRA_ATEND');
end if;
if	((ie_exige_conv_estab_p = 'S') or (ie_convenio_estab_w = 'S')) and (coalesce(cd_usuario_convenio_p::text, '') = '') then
	ds_msg_abort_cons_cart_p := substr(obter_texto_tasy(90085, wheb_usuario_pck.get_nr_seq_idioma),1,255);
	if (ds_msg_abort_cons_cart_p IS NOT NULL AND ds_msg_abort_cons_cart_p::text <> '') then
		goto final;
	end if;
end if;

select	Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_p, 'IE_EXIGE_LETRA_CARTEIRA')
into STRICT	ie_conv_exige_letra_cart_w
from   	convenio
where 	cd_convenio = cd_convenio_p;

if (ie_conv_exige_letra_cart_w = 'S') then
	ie_letra_carteira_w := obter_se_letra_carteirinha(cd_usuario_convenio_p);
	if (ie_letra_carteira_w = 'N') then
		ds_msg_abort_p := substr(obter_texto_tasy(296459, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		if (ds_msg_abort_p IS NOT NULL AND ds_msg_abort_p::text <> '') then
			goto final;
		end if;
	end if;
end if;

if (ie_novo_registro_p = 'S') then
	if (coalesce(qt_convenio_atend_p,0) > 0) then
		select	coalesce(count(*),0)
		into STRICT	qt_conv_atend_w
		from	atend_categoria_convenio
		where	nr_atendimento = nr_atendimento_p;
		if (qt_conv_atend_w = qt_convenio_atend_p) then
			ds_msg_abort_p :=  substr(obter_texto_dic_objeto(90200, wheb_usuario_pck.get_nr_seq_idioma, 'ITEM='||qt_convenio_atend_p),1,255);
			if (ds_msg_abort_p IS NOT NULL AND ds_msg_abort_p::text <> '') then
				goto final;
			end if;
		end if;
	end if;
end if;

if (coalesce(nr_doc_convenio_p::text, '') = '') then
	nr_doc_conv_retorno_p := obter_guia_conv_atend(nr_atendimento_p, cd_convenio_p, cd_categoria_p, ie_tipo_atendimento_p, cd_estabelecimento_p, ie_tipo_guia_p, nr_doc_conv_retorno_p, null, null);
	nr_doc_convenio_w := nr_doc_conv_retorno_p;
end if;

if (ie_atualiza_guia_tipo_guia_p = 'S') and (ie_alterou_guia_p = 'S') and (ie_edicao_registro_p = 'S') then
	nr_doc_conv_retorno_p := obter_guia_conv_atend(nr_atendimento_p, cd_convenio_p, cd_categoria_p, ie_tipo_atendimento_p, cd_estabelecimento_p, ie_tipo_guia_p, nr_doc_conv_retorno_p, null, null);
	nr_doc_convenio_w := nr_doc_conv_retorno_p;
end if;

if (ie_consiste_guia_senha_p <> 'N') and (nr_doc_convenio_w IS NOT NULL AND nr_doc_convenio_w::text <> '') then
	nr_atend_guia_iguais_w := Consiste_Atend_Guia_Senha(nr_atendimento_p, cd_convenio_p, nr_doc_convenio_w, cd_senha_p, ie_consiste_guia_senha_p, nr_atend_guia_iguais_w);
	if (coalesce(nr_atend_guia_iguais_w,0) > 0) then
		ds_msg_abort_p :=  substr(obter_texto_dic_objeto(90285, wheb_usuario_pck.get_nr_seq_idioma, 'ITEM='||nr_atend_guia_iguais_w),1,255);
		if (ds_msg_abort_p IS NOT NULL AND ds_msg_abort_p::text <> '') then
			goto final;
		end if;
	end if;
end if;

ie_obriga_empresa_w := Verifica_exige_empresa_conv(cd_estabelecimento_p, cd_convenio_p, cd_categoria_p, cd_plano_convenio_p, ie_tipo_atendimento_p, cd_empresa_p, obter_perfil_ativo, ie_obriga_empresa_w);
if (ie_obriga_empresa_w = 'S') then
	ds_msg_abort_p := substr(obter_texto_tasy(90298, wheb_usuario_pck.get_nr_seq_idioma),1,255);
	if (ds_msg_abort_p IS NOT NULL AND ds_msg_abort_p::text <> '') then
		goto final;
	end if;
end if;

ie_lib_categ_tipo_atend_w := Obter_Tipo_Atend_Lib_Categoria(cd_convenio_p, cd_categoria_p, ie_tipo_atendimento_p, cd_estabelecimento_p, dt_entrada_p);
if (ie_lib_categ_tipo_atend_w = 'N') then
	ds_msg_abort_p := substr(obter_texto_tasy(90368, wheb_usuario_pck.get_nr_seq_idioma),1,255);
	if (ds_msg_abort_p IS NOT NULL AND ds_msg_abort_p::text <> '') then
		goto final;
	end if;
end if;

ds_msg_abort_p := consistir_acomodacao_categoria(cd_convenio_p, cd_categoria_p, cd_tipo_acomodacao_p, ds_msg_abort_p);
if (ds_msg_abort_p IS NOT NULL AND ds_msg_abort_p::text <> '') then
	goto final;
end if;


/* ESTA ROTINA ESTA AGUARDANDO DEFINIÇÃO DA OS 741875 , PARA EXECUTAR TODA CONSISTÊNCIA DO PARAM 93 NA PROCEDURE MESMO */

if (ie_consiste_cart_convenio_w = 'S') and (cd_usuario_convenio_p IS NOT NULL AND cd_usuario_convenio_p::text <> '') then
	cd_usuario_convenio_w := replace(replace(replace(cd_usuario_convenio_p, '.',''),'-', ''),'/','');
	ds_msg_abort_p := consistir_cart_conve_eup_js(ie_clinica_p, ie_tipo_atendimento_p, dt_entrada_p, cd_pessoa_fisica_p, cd_convenio_p, cd_categoria_p, cd_usuario_convenio_w, nm_usuario_p, ds_msg_abort_p);
	if (ds_msg_abort_p IS NOT NULL AND ds_msg_abort_p::text <> '') then
		goto final;
	end if;
end if;

if (cd_plano_convenio_p IS NOT NULL AND cd_plano_convenio_p::text <> '') then
	select	count(*)
	into STRICT	qt_plano_convenio_p
	from	convenio_plano
	where	cd_convenio = cd_convenio_p
        and	ie_situacao   = 'A'
        and	Obter_Plano_Lib_Categoria(cd_convenio_p, cd_categoria_p, cd_plano, cd_estabelecimento_p, dt_entrada_p) = 'S'
        and	cd_plano = cd_plano_convenio_p;
	if (coalesce(qt_plano_convenio_p,0) = 0) then
		ds_msg_abort_p := substr(obter_texto_tasy(90545, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		if (ds_msg_abort_p IS NOT NULL AND ds_msg_abort_p::text <> '') then
			goto final;
		end if;
	end if;
end if;

if (ie_convenios_liberados_p IS NOT NULL AND ie_convenios_liberados_p::text <> '') then
	ie_convenio_contido_w := obter_se_contido(cd_convenio_p,ie_convenios_liberados_p);
	if (ie_convenio_contido_w = 'N') then
		ds_msg_abort_p := substr(obter_texto_tasy(90615, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		ie_focar_no_convenio_p := 'S';
		if (ds_msg_abort_p IS NOT NULL AND ds_msg_abort_p::text <> '') then
			goto final;
		end if;
	end if;
end if;
if (ie_convenios_nao_liberados_p IS NOT NULL AND ie_convenios_nao_liberados_p::text <> '') then
	ie_convenio_contido_w := obter_se_contido(cd_convenio_p,ie_convenios_nao_liberados_p);
	if (ie_convenio_contido_w = 'S') then
		ds_msg_abort_p := substr(obter_texto_tasy(90617, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		ie_focar_no_convenio_p := 'S';
		if (ds_msg_abort_p IS NOT NULL AND ds_msg_abort_p::text <> '') then
			goto final;
		end if;
	end if;
end if;

begin
	select	coalesce(ie_permite_cod_convenio_duplic,'N')
	into STRICT	ie_consiste_cod_conv_duplic_w
	from	convenio_estabelecimento
	where 	cd_convenio = cd_convenio_p
	and   	cd_estabelecimento = cd_estabelecimento_p;
exception
when others then
	ie_consiste_cod_conv_duplic_w := 'N';
end;

if (ie_consiste_cod_conv_duplic_w = 'S') then
	ds_consist_cd_con_dupl_w := Consistir_Guia_duplic_paciente(cd_convenio_p, nr_doc_convenio_p, nr_atendimento_p, ds_consist_cd_con_dupl_w);
	if (ds_consist_cd_con_dupl_w = 'N') then
		ds_msg_abort_p := substr(obter_texto_tasy(88526, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		if (ds_msg_abort_p IS NOT NULL AND ds_msg_abort_p::text <> '') then
			goto final;
		end if;
	end if;
end if;

if (ie_cons_permi_regra_atend_p = 'S') then

	if (coalesce(cd_medico_resp_p::text, '') = '') or (coalesce(cd_convenio_p,0) = 0) then
		ds_msg_abort_p := substr(obter_texto_tasy(90734, wheb_usuario_pck.get_nr_seq_idioma),1,255);
	end if;
	if (ds_msg_abort_p IS NOT NULL AND ds_msg_abort_p::text <> '') then
		goto final;
	end if;
	CALL obter_se_med_lib_conv_setor(cd_medico_resp_p, cd_convenio_p, null, cd_pessoa_fisica_p);

end if;

if (ie_exige_guia_tipo_convenio_p = 'S') and (ie_tipo_convenio_p = 2) and (coalesce(coalesce(nr_doc_conv_retorno_p,nr_doc_convenio_p)::text, '') = '') then
	ds_msg_abort_p := substr(obter_texto_tasy(90735, wheb_usuario_pck.get_nr_seq_idioma),1,255);
	if (ds_msg_abort_p IS NOT NULL AND ds_msg_abort_p::text <> '') then
		goto final;
	end if;
end if;

if (ie_perm_cart_venc_p = 'P') and (dt_validade_carteira_p IS NOT NULL AND dt_validade_carteira_p::text <> '') and (trunc(dt_validade_carteira_p) < trunc(dt_entrada_p)) then
	ds_msg_abort_p := substr(obter_texto_tasy(88278, wheb_usuario_pck.get_nr_seq_idioma),1,255);
	if (ds_msg_abort_p IS NOT NULL AND ds_msg_abort_p::text <> '') then
		goto final;
	end if;
end if;

Select	count(*)
into STRICT	qt_medico_w
from	medico
where	cd_pessoa_fisica = cd_medico_resp_p;

ie_resp_atend_w:= obter_se_responsavel_atend(obter_perfil_ativo, cd_medico_resp_p, cd_convenio_p, ie_tipo_atendimento_p);

if (ie_resp_nao_medico_p = 'S') then
	if (coalesce(qt_medico_w,0) = 0) and (ie_resp_atend_w = 'N') then
		ds_msg_abort_p := substr(obter_texto_tasy(97922, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		if (ds_msg_abort_p IS NOT NULL AND ds_msg_abort_p::text <> '') then
			goto final;
		end if;
	end if;
end if;

if	((ie_resp_nao_medico_p = 'N') or
	 ((qt_medico_w > 0) and (ie_resp_nao_medico_p = 'S') and (ie_resp_atend_w = 'N'))) and (qt_medico_w = 0) then

	ds_msg_abort_p := substr(obter_texto_tasy(93530, wheb_usuario_pck.get_nr_seq_idioma),1,255);
	if (ds_msg_abort_p IS NOT NULL AND ds_msg_abort_p::text <> '') then
		goto final;
	end if;
end if;


<<final>>

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atend_categ_befpost_abort_eup ( ie_resp_nao_medico_p text, dt_validade_carteira_p timestamp, ie_perm_cart_venc_p text, ie_tipo_convenio_p bigint, ie_exige_guia_tipo_convenio_p text, cd_medico_resp_p text, ie_cons_permi_regra_atend_p text, nr_seq_cobertura_p bigint, ie_visao_cobertura_p text, ie_convenios_nao_liberados_p text, ie_convenios_liberados_p text, ie_clinica_p bigint, cd_pessoa_fisica_p text, ie_consiste_cart_convenio_w text, dt_entrada_p timestamp, cd_empresa_p bigint, cd_categoria_p text, ie_tipo_guia_p text, cd_senha_p text, ie_consiste_guia_senha_p text, ie_atualiza_guia_tipo_guia_p text, ie_alterou_guia_p text, ie_edicao_registro_p text, ie_tipo_atendimento_p bigint, nr_doc_convenio_old_p text, nr_doc_convenio_p text, nr_atendimento_p bigint, qt_convenio_atend_p bigint, ie_novo_registro_p text, cd_usuario_convenio_p text, cd_estabelecimento_p bigint, ie_exige_conv_estab_p text, cd_convenio_p bigint, cd_tipo_acomodacao_p bigint, cd_plano_convenio_p text, nr_seq_visao_p bigint, nm_usuario_p text, ds_msg_abort_p INOUT text, ds_msg_abort_cons_cart_p INOUT text, nr_doc_conv_retorno_p INOUT text, ie_focar_no_convenio_p INOUT text) FROM PUBLIC;

