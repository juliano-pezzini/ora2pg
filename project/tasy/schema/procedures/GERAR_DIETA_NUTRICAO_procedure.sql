-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_dieta_nutricao ( nr_seq_dieta_p bigint, ds_dietas_p text, nm_usuario_p text) AS $body$
DECLARE


ds_dietas_w			varchar(4000);
ds_codigo_temp_w		varchar(4000);
ds_codigo_aux_w			varchar(2);

cd_pessoa_fisica_w		varchar(10);
dt_dieta_w			timestamp;
cd_refeicao_w			varchar(3);
ie_destino_dieta_w		varchar(2);
cd_setor_atendimento_w		integer;
cd_unidade_basica_w		varchar(10);
ie_exclui_dietas_anteriores_w	varchar(2);
nr_atendimento_w		bigint;

k				smallint;
i				smallint;


BEGIN

if (nr_seq_dieta_p IS NOT NULL AND nr_seq_dieta_p::text <> '') then

	select	cd_pessoa_fisica,
		dt_dieta,
		cd_refeicao,
		ie_destino_dieta,
		cd_setor_atendimento,
		cd_unidade_basica,
		nr_atendimento
	into STRICT	cd_pessoa_fisica_w,
		dt_dieta_w,
		cd_refeicao_w,
		ie_destino_dieta_w,
		cd_setor_atendimento_w,
		cd_unidade_basica_w,
		nr_atendimento_w
	from	mapa_dieta
	where	nr_Sequencia = nr_seq_dieta_p;

	ie_exclui_dietas_anteriores_w := Obter_Param_Usuario(1000, 91, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_exclui_dietas_anteriores_w);

	if (ie_exclui_dietas_anteriores_w = 'S') then
		delete from mapa_dieta
		where	nr_seq_superior = nr_seq_dieta_p;
	elsif (ie_exclui_dietas_anteriores_w = 'SN') then
		delete from mapa_dieta
		where	nr_seq_superior = nr_seq_dieta_p
		and	ie_tipo_dieta = 'N';
	end if;

	ds_dietas_w := ds_dietas_p;
	k := 1;
	for i in k..length(ds_dietas_w) loop
		begin

		ds_codigo_aux_w	:= substr(ds_dietas_w,i,1);

		if (ds_codigo_aux_w = ',') then
			insert into mapa_dieta(
					nr_sequencia,
					cd_dieta,
					cd_pessoa_fisica,
					dt_dieta,
					cd_refeicao,
					ie_destino_dieta,
					cd_setor_atendimento,
					cd_unidade_basica,
					dt_atualizacao,
					nm_usuario,
					ie_tipo_dieta,
					nr_Seq_superior,
					nr_atendimento,
					ie_recem_nato)
			values (nextval('mapa_dieta_seq'),
					obter_somente_numero(ds_codigo_temp_w),
					cd_pessoa_fisica_w,
					dt_dieta_w,
					cd_refeicao_w,
					ie_destino_dieta_w,
					cd_setor_atendimento_w,
					cd_unidade_basica_w,
					clock_timestamp(),
					nm_usuario_p,
					'N',
					nr_seq_dieta_p,
					nr_atendimento_w,
					'N');



			ds_codigo_temp_w := '';
		else
			ds_codigo_temp_w := ds_codigo_temp_w||ds_codigo_aux_w;
		end if;
		end;
	end loop;

	commit;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_dieta_nutricao ( nr_seq_dieta_p bigint, ds_dietas_p text, nm_usuario_p text) FROM PUBLIC;

