-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_conta_financ_regra ( ie_tipo_operacao_p text, nr_seq_mensalidade_p bigint, cd_estabelecimento_p bigint, ie_tipo_item_p text, nr_seq_tipo_lanc_p bigint, nr_seq_camara_p bigint, nr_seq_tipo_escrit_quota_p text, nr_seq_prestador_p bigint, nr_seq_mens_item_p bigint, nr_seq_prot_conta_p bigint, nr_seq_repasse_vend_p bigint, nr_seq_evento_p bigint, nr_seq_periodo_pagto_p bigint, nr_seq_comissao_p bigint, ie_tipo_intercambio_p pls_conta_financ_regra.ie_tipo_intercambio%type, nr_seq_grupo_item_mens_p bigint, ds_parametro_cinco_p bigint, cd_conta_financ_p INOUT bigint) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Obter a conta financeira para o item
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[ X ]  Objetos do dicionário [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
-------------------------------------------------------------------------------------------------------------------
Referências:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ie_tipo_operacao_plano_w	varchar(3)	:= null;
ie_tipo_contratacao_w		varchar(2)	:= null;
ie_tipo_contrato_w		varchar(2);
ie_tipo_produto_w		varchar(2)	:= null;
ie_tipo_vendedor_w		varchar(2)	:= null;
ie_tipo_lote_w			varchar(2);
ie_preco_w			varchar(2)	:= null;
ie_primeira_mensalidade_w	varchar(2)	:= null;
cd_conta_financ_w		bigint	:= null;
nr_seq_vinculo_sca_w		bigint;
nr_seq_plano_adic_w		bigint	:= null;
nr_seq_plano_w			bigint	:= null;
nr_seq_mot_reembolso_w		bigint	:= null;
nr_seq_vendedor_w		bigint	:= null;
nr_seq_intercambio_w		bigint;
nr_seq_congenere_w		bigint;
nr_seq_tipo_prestador_w		bigint;
ie_regulamentacao_w		pls_plano.ie_regulamentacao%type	:= null;

C01 CURSOR FOR
	SELECT	/*+USE_CONCAT*/		a.cd_conta_financ
	from	pls_conta_financ_regra a
	where	a.ie_tipo_operacao = ie_tipo_operacao_p
	/* Mensalidades */

	and	((coalesce(a.ie_tipo_contratacao,coalesce(ie_tipo_contratacao_w,'0')) = coalesce(ie_tipo_contratacao_w,'0'))
	or (a.ie_tipo_contratacao = 'C' and ie_tipo_contratacao_w in ('CA','CE'))
	or (a.ie_tipo_contratacao = 'T'))
	and	((a.ie_tipo_item_mens = ie_tipo_item_p) or (coalesce(a.ie_tipo_item_mens::text, '') = ''))
	and	((a.nr_seq_tipo_lanc_adic = nr_seq_tipo_lanc_p) or (coalesce(a.nr_seq_tipo_lanc_adic::text, '') = ''))
	and	((a.nr_seq_plano_sca = nr_seq_plano_adic_w) or (coalesce(a.nr_seq_plano_sca::text, '') = ''))
	and	((a.ie_tipo_produto = ie_tipo_produto_w) or (coalesce(a.ie_tipo_produto::text, '') = ''))
	and	((a.ie_tipo_operacao_plano = ie_tipo_operacao_plano_w) or (coalesce(a.ie_tipo_operacao_plano::text, '') = ''))
	and	((a.ie_preco = ie_preco_w) or (coalesce(a.ie_preco::text, '') = ''))
	and	((a.ie_regulamentacao = ie_regulamentacao_w) or (coalesce(a.ie_regulamentacao::text, '') = ''))
	and	((a.ie_tipo_lote = ie_tipo_lote_w) or (coalesce(a.ie_tipo_lote::text, '') = ''))
	and	((a.nr_seq_grupo_item_mens = nr_seq_grupo_item_mens_p) or (coalesce(a.nr_seq_grupo_item_mens::text, '') = ''))
	/* Intercâmbio */

	and 	((a.nr_seq_camara = nr_seq_camara_p) or (coalesce(a.nr_seq_camara::text, '') = ''))
	/* Escrituração de quotas coop */

	and	((a.nr_seq_tipo_escrit_quota = nr_seq_tipo_escrit_quota_p) or (coalesce(a.nr_seq_tipo_escrit_quota::text, '') = ''))
	/* Pagamento de prestadores */

	and	((a.nr_seq_prestador = nr_seq_prestador_p) or (coalesce(a.nr_seq_prestador::text, '') = ''))
	and	((a.nr_seq_evento = nr_seq_evento_p) or (coalesce(a.nr_seq_evento::text, '') = ''))
	and	((a.nr_seq_periodo_pagto = nr_seq_periodo_pagto_p) or (coalesce(a.nr_seq_periodo_pagto::text, '') = ''))
	/* Reembolso */

	and	((a.nr_seq_motivo_reembolso = nr_seq_mot_reembolso_w) or (coalesce(a.nr_seq_motivo_reembolso::text, '') = ''))
	/* Comissão a vendedores */

	and	((a.nr_seq_vendedor = nr_seq_vendedor_w) or (coalesce(a.nr_seq_vendedor::text, '') = ''))
	and	((a.ie_tipo_vendedor = ie_tipo_vendedor_w) or (coalesce(a.ie_tipo_vendedor::text, '') = ''))
	and	coalesce(a.ie_primeira_mensalidade, coalesce(ie_primeira_mensalidade_w,'N')) = coalesce(ie_primeira_mensalidade_w,'N')
	and	coalesce(a.nr_seq_tipo_prestador, coalesce(nr_seq_tipo_prestador_w,0)) = coalesce(nr_seq_tipo_prestador_w,0)
	and	((coalesce(a.ie_tipo_intercambio,'T') = 'T') or (a.ie_tipo_intercambio = ie_tipo_intercambio_p))
	order by
		coalesce(a.nr_seq_evento, 0),
		coalesce(a.nr_seq_periodo_pagto, 0),
		coalesce(a.nr_seq_prestador, 0),
		coalesce(a.nr_seq_motivo_reembolso, 0),
		coalesce(a.nr_seq_tipo_lanc_adic, 0),
		coalesce(a.nr_seq_plano_sca, 0),
		coalesce(a.ie_tipo_item_mens, 0),
		coalesce(a.nr_seq_grupo_item_mens, 0),
		coalesce(a.nr_seq_vendedor, 0),
		coalesce(a.ie_tipo_contratacao, '0'),
		coalesce(a.ie_tipo_produto, '0'),
		coalesce(a.ie_preco, '0'),
		coalesce(a.ie_tipo_operacao_plano, '0'),
		coalesce(ie_tipo_vendedor, '0'),
		coalesce(a.nr_seq_camara, 0),
		coalesce(a.ie_primeira_mensalidade, 'N'),
		coalesce(a.nr_seq_tipo_prestador, 0),
		CASE WHEN coalesce(a.ie_tipo_intercambio, 'T')='T' THEN 'A'  ELSE a.ie_tipo_intercambio END;


BEGIN
if (nr_seq_mensalidade_p IS NOT NULL AND nr_seq_mensalidade_p::text <> '') then
	select	CASE WHEN coalesce(b.nr_seq_contrato::text, '') = '' THEN 'I'  ELSE 'C' END
	into STRICT	ie_tipo_contrato_w
	from	pls_contrato_pagador	b,
		pls_mensalidade		a
	where	b.nr_sequencia	= a.nr_seq_pagador
	and	a.nr_sequencia	= nr_seq_mensalidade_p;

	begin
	select	b.ie_tipo_lote,
		b.ie_tipo_contratacao,
		b.ie_primeira_mensalidade
	into STRICT	ie_tipo_lote_w,
		ie_tipo_contratacao_w,
		ie_primeira_mensalidade_w
	from	pls_lote_mensalidade	b,
		pls_mensalidade		a
	where	b.nr_sequencia	= a.nr_seq_lote
	and	a.nr_sequencia	= nr_seq_mensalidade_p;
	exception
	when others then
		ie_tipo_lote_w			:= 'CO';
		ie_primeira_mensalidade_w 	:= null;
	end;

	if (ie_tipo_contrato_w = 'C') then
		select	CASE WHEN coalesce(c.cd_cgc_estipulante::text, '') = '' THEN  'I'  ELSE 'C' END
		into STRICT	ie_tipo_contratacao_w
		from	pls_contrato		c,
			pls_contrato_pagador	b,
			pls_mensalidade		a
		where	b.nr_sequencia	= a.nr_seq_pagador
		and	c.nr_sequencia	= b.nr_seq_contrato
		and	a.nr_sequencia	= nr_seq_mensalidade_p;
	elsif (ie_tipo_contrato_w = 'I') then
		select	nr_seq_pagador_intercambio,
			nr_seq_congenere
		into STRICT	nr_seq_intercambio_w,
			nr_seq_congenere_w
		from	pls_contrato_pagador	b,
			pls_mensalidade		a
		where	b.nr_sequencia	= a.nr_seq_pagador
		and	a.nr_sequencia	= nr_seq_mensalidade_p;

		if (nr_seq_intercambio_w IS NOT NULL AND nr_seq_intercambio_w::text <> '') then
			select	CASE WHEN coalesce(a.cd_cgc::text, '') = '' THEN  'I'  ELSE 'C' END
			into STRICT	ie_tipo_contratacao_w
			from	pls_intercambio	a
			where	a.nr_sequencia	= nr_seq_intercambio_w;
		elsif (nr_seq_congenere_w IS NOT NULL AND nr_seq_congenere_w::text <> '') then
			ie_tipo_contratacao_w	:= 'C';
		end if;
	end if;

	/*aaschlote 05/07/2012 OS - 467428*/

	select	max(c.ie_tipo_contratacao),
		max(c.ie_tipo_operacao),
		max(c.ie_preco),
		max(c.ie_regulamentacao)
	into STRICT	ie_tipo_produto_w,
		ie_tipo_operacao_plano_w,
		ie_preco_w,
		ie_regulamentacao_w
	from	pls_mensalidade_segurado	a,
		pls_plano			c,
		pls_mensalidade			b
	where	b.nr_sequencia	= a.nr_seq_mensalidade
	and	c.nr_sequencia	= a.nr_seq_plano
	and	b.nr_sequencia	= nr_seq_mensalidade_p;

	-- Verificar se: Coletivo por adesão - Coletivo empresarial
	if (ie_tipo_produto_w IS NOT NULL AND ie_tipo_produto_w::text <> '') and (ie_tipo_contratacao_w = 'C') then
		select	CASE WHEN ie_tipo_produto_w='I' THEN  ie_tipo_contratacao_w  ELSE ie_tipo_produto_w END
		into STRICT	ie_tipo_contratacao_w
		;
	end if;
end if;

if (nr_seq_mens_item_p IS NOT NULL AND nr_seq_mens_item_p::text <> '') then
	if (ie_tipo_item_p = '15') then
		select	max(nr_seq_vinculo_sca)
		into STRICT	nr_seq_vinculo_sca_w
		from	pls_mensalidade_seg_item
		where	nr_sequencia	= nr_seq_mens_item_p;

		if (nr_seq_vinculo_sca_w IS NOT NULL AND nr_seq_vinculo_sca_w::text <> '') then
			select	nr_seq_plano
			into STRICT	nr_seq_plano_adic_w
			from	pls_sca_vinculo
			where	nr_sequencia	= nr_seq_vinculo_sca_w;
		end if;
	end if;

	select	max(b.nr_seq_plano)
	into STRICT	nr_seq_plano_w
	from	pls_mensalidade_seg_item	a,
		pls_mensalidade_segurado	b
	where	b.nr_sequencia	= a.nr_seq_mensalidade_seg
	and	a.nr_sequencia	= nr_seq_mens_item_p;

	if (nr_seq_plano_w IS NOT NULL AND nr_seq_plano_w::text <> '') then
		select	max(a.ie_tipo_contratacao),
			max(a.ie_tipo_operacao),
			max(a.ie_preco),
			max(a.ie_regulamentacao)
		into STRICT	ie_tipo_produto_w,
			ie_tipo_operacao_plano_w,
			ie_preco_w,
			ie_regulamentacao_w
		from	pls_plano	a
		where	a.nr_sequencia	= nr_seq_plano_w;
	end if;
end if;

if (nr_seq_prot_conta_p IS NOT NULL AND nr_seq_prot_conta_p::text <> '') then
	select	max(nr_seq_mot_reembolso)
	into STRICT	nr_seq_mot_reembolso_w
	from	pls_protocolo_conta
	where	nr_sequencia	= nr_seq_prot_conta_p;
end if;

if (nr_seq_repasse_vend_p IS NOT NULL AND nr_seq_repasse_vend_p::text <> '') then
	select	max(a.nr_sequencia),
		max(a.ie_tipo_vendedor)
	into STRICT	nr_seq_vendedor_w,
		ie_tipo_vendedor_w
	from	pls_repasse_vend	b,
		pls_vendedor		a
	where	a.nr_sequencia	= b.nr_seq_vendedor
	and	b.nr_sequencia	= nr_seq_repasse_vend_p;
end if;

if (nr_seq_comissao_p IS NOT NULL AND nr_seq_comissao_p::text <> '') then
	select	max(b.nr_sequencia),
		max(b.ie_tipo_vendedor)
	into STRICT	nr_seq_vendedor_w,
		ie_tipo_vendedor_w
	from	pls_comissao		a,
		pls_vendedor		b
	where	b.nr_sequencia	= a.nr_seq_canal_venda
	and	a.nr_sequencia	= nr_seq_comissao_p;
end if;

if (nr_seq_prestador_p IS NOT NULL AND nr_seq_prestador_p::text <> '') then
	select	max(nr_seq_tipo_prestador)
	into STRICT	nr_seq_tipo_prestador_w
	from	pls_prestador
	where	nr_sequencia	= nr_seq_prestador_p;
end if;

open C01;
loop
fetch C01 into
	cd_conta_financ_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	null;
	end;
end loop;
close C01;

cd_conta_financ_p	:= cd_conta_financ_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_conta_financ_regra ( ie_tipo_operacao_p text, nr_seq_mensalidade_p bigint, cd_estabelecimento_p bigint, ie_tipo_item_p text, nr_seq_tipo_lanc_p bigint, nr_seq_camara_p bigint, nr_seq_tipo_escrit_quota_p text, nr_seq_prestador_p bigint, nr_seq_mens_item_p bigint, nr_seq_prot_conta_p bigint, nr_seq_repasse_vend_p bigint, nr_seq_evento_p bigint, nr_seq_periodo_pagto_p bigint, nr_seq_comissao_p bigint, ie_tipo_intercambio_p pls_conta_financ_regra.ie_tipo_intercambio%type, nr_seq_grupo_item_mens_p bigint, ds_parametro_cinco_p bigint, cd_conta_financ_p INOUT bigint) FROM PUBLIC;

