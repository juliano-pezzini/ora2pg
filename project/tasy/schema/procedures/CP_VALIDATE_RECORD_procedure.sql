-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cp_validate_record ( nm_tabela_p text, nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE

				
qt_rec_pending_w	bigint;
				

BEGIN

/*Estas tabelas não precisa consistir porque elas não tem registros filhos
CP_MEASURE
CP_INTERVENTION_ITEM_ASSOC
CP_INTERVENTION_ITEM
CP_INTERVENTION_CLIN_TERM
CP_INDICATOR_MEASURE_GUID
CP_GUIDANCE
CP_GOAL_INDICATOR
CP_GOAL_CLIN_TERM
CP_PROBLEM
CP_CLINICAL_TERM*/



/*-------- CADASTROS: Consistir registros filhos que não estão revisados. Só pode revisar se não tiver nenhum registro filho pendente de revisão.*/

if (nm_tabela_p = 'CP_INTERVENTION') then
	
	select	count(*)
	into STRICT	qt_rec_pending_w
	from	cp_intervention_item_assoc a
	where	a.nr_seq_intervention = nr_sequencia_p
	and	a.si_import_status in ('SP','UP');
	
	if (qt_rec_pending_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1099418,'DS_ABA_W=' || obter_desc_expressao(283903)); /*Atividades*/

		/*Não é possível revisar esta intervenção porque existe algum registro na aba #@DS_ABA_W#@ que está pendente de revisão.*/

	end if;
	
	
	select	count(*)
	into STRICT	qt_rec_pending_w
	from	cp_intervention_clin_term a
	where	a.nr_seq_intervention = nr_sequencia_p
	and	a.si_import_status in ('SP','UP');
	
	if (qt_rec_pending_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1099418,'DS_ABA_W=' || obter_desc_expressao(947156)); /*Termos clínicos*/

		/*Não é possível revisar esta intervenção porque existe algum registro na aba #@DS_ABA_W#@ que está pendente de revisão.*/

	end if;
	
	
elsif (nm_tabela_p = 'CP_INDICATOR_MEASURE') then
	
	select	count(*)
	into STRICT	qt_rec_pending_w
	from	cp_indicator_measure_guid a
	where	a.nr_seq_indic_measure = nr_sequencia_p
	and	a.si_import_status in ('SP','UP');
	
	if (qt_rec_pending_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1099421,'DS_ABA_W=' || obter_desc_expressao(767009)); /*Orientação*/

		/*Não é possível revisar esta mensuração porque existe algum registro na aba #@DS_ABA_W#@ que está pendente de revisão.*/

	end if;	
	
elsif (nm_tabela_p = 'CP_INDICATOR') then
	
	select	count(*)
	into STRICT	qt_rec_pending_w
	from	cp_indicator_measure a
	where	a.nr_seq_indicator = nr_sequencia_p
	and	a.si_import_status in ('SP','UP');
	
	if (qt_rec_pending_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1099422,'DS_ABA_W=' || obter_desc_expressao(950263)); /*Mensuração*/

		/*Não é possível revisar este indicador porque existe algum registro na aba #@DS_ABA_W#@ que está pendente de revisão.*/

	end if;	
	

elsif (nm_tabela_p = 'CP_GOAL') then
	
	select	count(*)
	into STRICT	qt_rec_pending_w
	from	cp_goal_indicator a
	where	a.nr_seq_goal = nr_sequencia_p
	and	a.si_import_status in ('SP','UP');
	
	if (qt_rec_pending_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1099425,'DS_ABA_W=' || obter_desc_expressao(947074)); /*Indicadores da meta*/

		/*Não é possível revisar esta meta porque existe algum registro na aba #@DS_ABA_W#@ que está pendente de revisão.*/

	end if;	
	
	select	count(*)
	into STRICT	qt_rec_pending_w
	from	cp_goal_clin_term a
	where	a.nr_seq_goal = nr_sequencia_p
	and	a.si_import_status in ('SP','UP');
	
	if (qt_rec_pending_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1099425,'DS_ABA_W=' || obter_desc_expressao(947112)); /*Termos clínicos*/

		/*Não é possível revisar esta meta porque existe algum registro na aba #@DS_ABA_W#@ que está pendente de revisão.*/

	end if;	
end if;


/*-------- PLANO DE CUIDADO: Consistir se algum cadastro vinculado com o plano de cuidado está pendente de revisão.*/

if (nm_tabela_p = 'CARE_PLAN') then
	
	/*Plano de cuidado >> Problemas*/

	select	count(*)
	into STRICT	qt_rec_pending_w
	from	cp_possible_prob a,
		cp_problem b
	where	b.nr_sequencia = a.nr_seq_problem
	and	a.nr_seq_care_plan = nr_sequencia_p
	and	b.si_import_status in ('SP','UP');
	
	if (qt_rec_pending_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1099635);
		/*Não é possível revisar este plano de cuidado porque um dos problemas vinculado está pendente de revisão.
		Primeiramente deve ser feito a revisão do cadastro do problema na aba Cadastros >> Problema.*/
		
	end if;	
	
	
	
	/*Plano de cuidado >> Problemas >> Metas de cuidado*/
	
	select	count(*)
	into STRICT	qt_rec_pending_w
	from	cp_possible_prob a,
		cp_problem_goal b,
		cp_goal c
	where	a.nr_sequencia = b.nr_seq_possible_prob
	and	c.nr_sequencia = b.nr_seq_goal
	and	a.nr_seq_care_plan = nr_sequencia_p
	and	c.si_import_status in ('SP','UP');
	
	if (qt_rec_pending_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1099634);
		/*Não é possível revisar este plano de cuidado porque uma das metas de cuidado vinculada está pendente de revisão.		
		Primeiramente deve ser feita a revisão da meta na aba Cadastros >> Metas.*/
	end if;	
	
	
	
	/*Plano de cuidado >> Problemas >> Plano de intervenções >> Intervenção*/
	
	select	count(*)
	into STRICT	qt_rec_pending_w
	from	cp_possible_prob a,
		cp_interv_plan b,
		cp_interv_plan_assoc c,
		cp_intervention d
	where	a.nr_sequencia = b.nr_seq_possible_prob
	and	b.nr_sequencia = c.nr_seq_interv_plan
	and	d.nr_sequencia = c.nr_seq_intervention
	and	a.nr_seq_care_plan = nr_sequencia_p
	and	d.si_import_status in ('SP','UP');
	
	if (qt_rec_pending_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1099633);
		/*Não é possível revisar este plano de cuidado porque uma das intervenções vinculada está pendente de revisão.		
		Primeiramente deve ser feita a revisão da intervenção na aba Cadastros >> Intervenções.*/
	end if;
	
	
	/*Plano de cuidado >> Problemas >> Plano de intervenções >> Orientação*/
	
	select	count(*)
	into STRICT	qt_rec_pending_w
	from	cp_possible_prob a,
		cp_interv_plan b,
		cp_interv_plan_guid c,
		cp_guidance d
	where	a.nr_sequencia = b.nr_seq_possible_prob
	and	b.nr_sequencia = c.nr_seq_interv_plan
	and	d.nr_sequencia = c.nr_seq_guidance
	and	a.nr_seq_care_plan = nr_sequencia_p
	and	d.si_import_status in ('SP','UP');
	
	if (qt_rec_pending_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1099632);
		/*Não é possível revisar este plano de cuidado porque uma das orientações vinculada ao plano de intervenção está pendente de revisão.		
		Primeiramente deve ser feita a revisão da orientação na aba Cadastros >> Orientação.*/
	end if;	
	
	
	/*Plano de cuidado >> Termos clínicos*/
	
	select	count(*)
	into STRICT	qt_rec_pending_w
	from	cp_clinical_term_assoc a,
		cp_clinical_term b
	where	b.nr_sequencia = a.nr_seq_clin_term
	and	a.nr_seq_care_plan = nr_sequencia_p
	and	b.si_import_status in ('SP','UP');
	
	if (qt_rec_pending_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1099631);
		/*Não é possível revisar este plano de cuidado porque um dos termos clínicos vinculado está pendente de revisão.		
		Primeiramente deve ser feita a revisão do termo clínico na aba Cadastros >> Termos clínicos.*/
	end if;	
	
	
	/*Plano de cuidado >> Meta educacional*/
	
	select	count(*)
	into STRICT	qt_rec_pending_w
	from	cp_education a,
		cp_goal b
	where	b.nr_sequencia = a.nr_seq_goal
	and	a.nr_seq_care_plan = nr_sequencia_p
	and	b.si_import_status in ('SP','UP');
	
	if (qt_rec_pending_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1099630);
		/*Não é possível revisar este plano de cuidado porque uma das metas educacionais vinculada está pendente de revisão.
		Primeiramente deve ser feita a revisão da meta na aba Cadastros >> Metas.*/
	end if;	
	
end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cp_validate_record ( nm_tabela_p text, nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

