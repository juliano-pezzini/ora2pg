-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_incluir_mat_analise_pos ( nr_seq_analise_p bigint, nr_seq_conta_mat_p bigint, nr_seq_grupo_atual_p bigint, nr_seq_conta_p bigint, ie_tipo_guia_p text, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_item_criado_p INOUT bigint) AS $body$
DECLARE

				
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Gerenciar a inclusão de materiais em análises de Pós-estabelecido
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  ]  Objetos do dicionário [ X ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ds_observacao_w			varchar(500);
nr_nota_fiscal_w		varchar(255);
cd_material_w			varchar(20);
ie_tipo_segurado_w		varchar(10);
ie_valor_informado_w		varchar(1)	:= 'N';
ie_geracao_pos_estab_w		varchar(1);
vl_uni_apres_w			double precision;
vl_total_apres_w		double precision;
qt_material_w			double precision;
nr_seq_mat_w			bigint;
nr_seq_conta_w			bigint;
nr_seq_item_criado_w		bigint;
ie_origem_analise_w		bigint;
nr_seq_fornecedor_w		bigint;
nr_seq_material_w		bigint;
dt_material_w			timestamp;
dt_inicio_atend_w		timestamp;
nr_seq_segurado_w		pls_conta.nr_seq_segurado%type;
nr_registro_anvisa_w		w_pls_conta_mat.nr_registro_anvisa%type;
det_reg_anvisa_w		w_pls_conta_mat.det_reg_anvisa%type;
ie_novo_pos_w			pls_visible_false.ie_novo_pos_estab%type;
ie_medico_solic_coope_w		varchar(2);
ie_medico_exec_coope_w		varchar(2);
nr_seq_prestador_exec_w		pls_conta.nr_seq_prestador_exec%type;
nr_seq_prestador_solic_w	pls_conta.nr_seq_prestador%type;
cd_medico_solicitante_w		pls_conta.cd_medico_solicitante%type;
nr_seq_prestador_atend_w	pls_protocolo_conta.nr_seq_prestador%type;
cd_medico_executor_w		pls_conta.cd_medico_executor%type;
ie_tipo_protocolo_w		pls_protocolo_conta.ie_tipo_protocolo%type;
ie_tipo_guia_w			pls_protocolo_conta.ie_tipo_guia%type;
nr_seq_regra_cooperado_w	pls_conta_mat.nr_seq_regra_cooperado%type;
ie_ato_cooperado_w		pls_conta_mat.ie_ato_cooperado%type;
ie_tipo_despesa_w		pls_conta_mat.ie_tipo_despesa%type;


BEGIN

	select 	coalesce(max(ie_novo_pos_estab),'N')
	into STRICT	ie_novo_pos_w
	from	pls_visible_false;

	if (nr_seq_conta_p IS NOT NULL AND nr_seq_conta_p::text <> '') then
		/*Obtem a conta principal do tipo de guia passada*/
	
		nr_seq_conta_w	:= nr_seq_conta_p;
	else
		select	min(nr_sequencia)
		into STRICT	nr_seq_conta_w
		from	pls_conta
		where	nr_seq_analise	= nr_seq_analise_p
		and	ie_tipo_guia	= ie_tipo_guia_p;	
	end if;

	select	to_date(to_char(coalesce(dt_atendimento, clock_timestamp()),'dd/mm/yyyy') || ' ' || to_char(dt_inicio_atend,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss'),
		--dt_atendimento,
		coalesce(vl_material_imp,0),
		coalesce(vl_unitario_imp,0),
		nr_nota_fiscal,
		nr_seq_prest_fornec,
		nr_seq_material,
		qt_material_imp,
		dt_inicio_atend,
		nr_registro_anvisa,
		det_reg_anvisa
	into STRICT	dt_material_w,
		vl_total_apres_w,
		vl_uni_apres_w,
		nr_nota_fiscal_w,
		nr_seq_fornecedor_w,
		nr_seq_material_w,
		qt_material_w,
		dt_inicio_atend_w,
		nr_registro_anvisa_w,
		det_reg_anvisa_w
	from	w_pls_conta_mat
	where	nr_sequencia	= nr_seq_conta_mat_p;

	select	c.nr_seq_prestador_exec,
		coalesce(dt_material_w, c.dt_atendimento_referencia),
		c.ie_tipo_segurado,
		c.nr_seq_segurado,
		c.nr_seq_prestador_solic_ref,
		c.cd_medico_solicitante,
		p.nr_seq_prestador,
		c.cd_medico_executor,
		p.ie_tipo_protocolo,
		c.ie_tipo_guia
	into STRICT	nr_seq_prestador_exec_w,
		dt_material_w,
		ie_tipo_segurado_w,
		nr_seq_segurado_w,
		nr_seq_prestador_solic_w,
		cd_medico_solicitante_w,
		nr_seq_prestador_atend_w,
		cd_medico_executor_w,
		ie_tipo_protocolo_w,
		ie_tipo_guia_w
	from	pls_conta		c,
		pls_protocolo_conta 	p
	where	c.nr_sequencia		= nr_seq_conta_w
	and	c.nr_seq_protocolo 	= p.nr_sequencia;
	
	ie_medico_solic_coope_w	:= pls_obter_se_cooperado_ativo(cd_medico_solicitante_w,dt_material_w,null);
	
	if (ie_medico_solic_coope_w = 'S') then
		ie_medico_solic_coope_w := 'C'; -- Caso ele não for cooperador a function já retorna N
	end if;
	
	ie_medico_exec_coope_w	:= pls_obter_se_cooperado_ativo(cd_medico_executor_w,dt_material_w,null);
	
	if (ie_medico_exec_coope_w = 'S') then
		ie_medico_exec_coope_w := 'C'; -- Caso ele não for cooperador a function já retorna N
	end if;
	
	select	nextval('pls_conta_mat_seq')
	into STRICT	nr_seq_mat_w
	;

	insert into pls_conta_mat(nr_sequencia, nr_seq_material, qt_material,
		qt_material_imp, vl_unitario_imp, vl_material_imp,
		dt_atendimento, nr_seq_conta, nm_usuario, 
		nm_usuario_nrec, dt_atualizacao, dt_atualizacao_nrec, 
		ie_situacao, ie_status, nr_nota_fiscal,
		nr_seq_prest_fornec, vl_unitario, vl_liberado,	 
		ie_valor_informado, ie_vl_apresentado_sistema, dt_inicio_atend,
		IE_LANC_MANUAL_POS, ie_status_pagamento, nr_registro_anvisa,
		det_reg_anvisa)
	values (nr_seq_mat_w, nr_seq_material_w, 0,
		qt_material_w, vl_uni_apres_w, vl_total_apres_w,
		dt_material_w, nr_seq_conta_w, nm_usuario_p, 
		nm_usuario_p, clock_timestamp(), clock_timestamp(), 
		'D', 'M', nr_nota_fiscal_w,
		nr_seq_fornecedor_w, 0, 0,
		ie_valor_informado_w, 'N', dt_inicio_atend_w,
		'S','G', nr_registro_anvisa_w,
		det_reg_anvisa_w);
	
	CALL pls_cta_proc_mat_regra_pck.cria_registro_regra_mat(nr_seq_mat_w, nm_usuario_p);
	CALL pls_cta_proc_mat_regra_pck.gera_seq_tiss_mat(nr_seq_mat_w, null, null, nr_seq_conta_w, nm_usuario_p);
	
		
	
	--Se não estiver setado para utilização do novo pós-estabelecido, mantém a utilização das rotinas antigas.
	if (ie_novo_pos_w = 'N') then

		CALL pls_gerar_valor_pos_estab(nr_seq_conta_w, nm_usuario_p, ie_geracao_pos_estab_w,null,nr_seq_mat_w,'C');

		CALL pls_gerar_ocorrencia_pos_estab(nr_seq_analise_p, nr_seq_conta_w,null,cd_estabelecimento_p,nm_usuario_p);
			
		CALL pls_gerar_ocor_conta_princ(nr_seq_conta_w,nr_seq_segurado_w,nr_seq_analise_p,cd_estabelecimento_p, nm_usuario_p );
			
		CALL pls_atualizar_status_fat_pos(nr_seq_conta_w, null, null, nr_seq_analise_p, cd_estabelecimento_p, nm_usuario_p);

		CALL pls_gerar_fluxo_audit_item_pos(nr_seq_analise_p,null,nm_usuario_p);	
	else
	
		CALL pls_pos_estabelecido_pck.gerencia_pos_estabelecido(	null, null, null,
									null, null, null,
									nr_seq_mat_w, null, null,
									nm_usuario_p, cd_estabelecimento_p);
									
		CALL pls_atual_status_fat_pos_estab(nr_seq_conta_w, null, null, nr_seq_analise_p, cd_estabelecimento_p, nm_usuario_p);
		
		CALL pls_gera_fluxo_audit_novo_pos(nr_seq_analise_p, null, nm_usuario_p, cd_estabelecimento_p);	
	
	end if;

	ds_observacao_w :=	'Material inserido: '||coalesce(cd_material_w,nr_seq_material_w) || '-' || pls_obter_desc_material(nr_seq_material_w) || chr(13) || chr(10) ||
				'Quantidade inserida: ' || qt_material_w;
	/*Inserindo histórico*/

	CALL pls_inserir_hist_analise(nr_seq_conta_w,  nr_seq_analise_p, 20, nr_seq_mat_w, 'M', null, null,ds_observacao_w, nr_seq_grupo_atual_p, nm_usuario_p,cd_estabelecimento_p);

	nr_seq_item_criado_p	:= nr_seq_mat_w;

	select 	max(ie_tipo_despesa)
	into STRICT	ie_tipo_despesa_w
	from	pls_conta_mat
	where	nr_sequencia = nr_seq_mat_w;
	
	SELECT * FROM pls_obter_tipo_ato_cooperado(	null, null, nr_seq_mat_w, 'M', nr_seq_prestador_exec_w, nr_seq_prestador_solic_w, nr_seq_prestador_atend_w, null, ie_medico_solic_coope_w, ie_medico_exec_coope_w, nr_seq_material_w, ie_tipo_protocolo_w, ie_tipo_guia_w, null, ie_tipo_despesa_w, nr_seq_regra_cooperado_w, ie_ato_cooperado_w) INTO STRICT nr_seq_regra_cooperado_w, ie_ato_cooperado_w;
	
	update 	pls_conta_mat
	set	nr_seq_regra_cooperado	= nr_seq_regra_cooperado_w,
		ie_ato_cooperado	= ie_ato_cooperado_w
	where	nr_sequencia 		= nr_seq_mat_w;

	delete	from w_pls_conta_mat
	where	nm_usuario	= nm_usuario_p;

	commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_incluir_mat_analise_pos ( nr_seq_analise_p bigint, nr_seq_conta_mat_p bigint, nr_seq_grupo_atual_p bigint, nr_seq_conta_p bigint, ie_tipo_guia_p text, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_item_criado_p INOUT bigint) FROM PUBLIC;

