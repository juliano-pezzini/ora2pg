-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE os_encerrada_rel_t ( dt_inicio_p timestamp, dt_final_p timestamp, cd_cnpj_p text, nm_usuario_p text) AS $body$
DECLARE


nr_linha_w			bigint;
qt_dias_inicio_w		bigint;
qt_dias_final_w			bigint;
dt_inicio_w			timestamp;
dt_final_w			timestamp;
qt_nr_ordem_w			bigint;
qt_os_encerrada_w		bigint;
qt_os_volta_w			bigint;
qt_os_volta_media_w		double precision;
pr_media_os_encerrada_w		double precision;
qt_controle_w			smallint;
pr_soma_media_w			double precision;
nr_seq_localizacao_w		bigint;
ds_classif_w			varchar(255);
nr_sequencia_w			bigint;
nr_sequencia_atual_w		bigint;
qt_total_quebra_w		bigint;
qt_count_w			bigint;
qt_contador_w			bigint;
qt_max_volta_os_w		bigint;


BEGIN

qt_total_quebra_w := 0;
qt_contador_w		:= 10;

while(qt_contador_w <= 230) loop
	begin
	qt_total_quebra_w := qt_total_quebra_w + 1;
	qt_contador_w := qt_contador_w + 10;
	end;
end loop;

select	coalesce(max(nr_sequencia),0)
into STRICT	nr_seq_localizacao_w
from	man_localizacao
where	CD_CNPJ = cd_cnpj_p;

delete from rel_os_encerrada_w
where	nm_usuario = nm_usuario_p;

select	max(nr_sequencia) + 1
into STRICT	nr_sequencia_w
from	rel_os_encerrada_w;

insert into rel_os_encerrada_w(
	ie_tipo,
	ds_resultado_1,
	ds_resultado_2,
	ds_resultado_3,
	ds_resultado_4,
	ds_resultado_5,
	ds_resultado_6,
	nr_sequencia,
	nm_usuario)
values (	'T',
	'Faixa Dias',
	'Ordens Encerradas',
	'Média Voltas',
	'Máxima Voltas',
	'%',
	'% AC',
	coalesce(nr_sequencia_w,1),
	nm_usuario_p);

qt_dias_inicio_w 	:= 0;
dt_inicio_w 		:= dt_inicio_p;
dt_final_w		:= dt_inicio_p;
qt_controle_w   	:= 0;
pr_soma_media_w 	:= 0;
qt_dias_final_w		:= 10;
qt_count_w		:= 0;


while(qt_dias_final_w <= 230) loop
	begin
	qt_controle_w := qt_controle_w + 1;
	qt_count_w    := qt_count_w + 1;
	dt_inicio_w   := dt_inicio_w + qt_dias_inicio_w;
	dt_final_w    := dt_final_w + qt_dias_final_w;

	select	max(nr_sequencia) + 1
	into STRICT	nr_sequencia_w
	from	rel_os_encerrada_w;

	if (dt_final_w > dt_final_p) then
		dt_final_w := dt_final_p;
	end if;


	select	count(distinct nr_sequencia)
	into STRICT	qt_nr_ordem_w
	from	man_ordem_servico
	where	dt_ordem_servico between inicio_dia(dt_inicio_p) and fim_dia(dt_final_p)
	and	((nr_seq_localizacao = nr_seq_localizacao_w) or (nr_seq_localizacao_w = 0))
	and	ie_classificacao in ('S','E');


	if (qt_dias_final_w = 230) then
		select	count(*),
			sum(obter_qt_volta_os(nr_sequencia))
		into STRICT	qt_os_encerrada_w,
			qt_os_volta_w
		from	man_ordem_servico
		where	dt_ordem_servico between inicio_dia(dt_inicio_p) and fim_dia(dt_final_p)
		and	ceil(dt_fim_real - dt_ordem_servico) >= 221
		and	((nr_seq_localizacao = nr_seq_localizacao_w) or (nr_seq_localizacao_w = 0))
		and	ie_classificacao in ('S','E')
		and	nr_seq_estagio = 9
		and	(dt_fim_real IS NOT NULL AND dt_fim_real::text <> '');


		select	max(obter_qt_volta_os(nr_sequencia))
		into STRICT	qt_max_volta_os_w
		from	man_ordem_servico
		where	dt_ordem_servico between inicio_dia(dt_inicio_p) and fim_dia(dt_final_p)
		and	ceil(dt_fim_real - dt_ordem_servico) >= 221
		and	((nr_seq_localizacao = nr_seq_localizacao_w) or (nr_seq_localizacao_w = 0))
		and	ie_classificacao in ('S','E')
		and	nr_seq_estagio = 9
		and	(dt_fim_real IS NOT NULL AND dt_fim_real::text <> '');
	else
		select	count(*),
			sum(obter_qt_volta_os(nr_sequencia))
		into STRICT	qt_os_encerrada_w,
			qt_os_volta_w
		from	man_ordem_servico
		where	dt_ordem_servico between inicio_dia(dt_inicio_p) and fim_dia(dt_final_p)
		and	ceil(dt_fim_real - dt_ordem_servico) between CASE WHEN qt_dias_inicio_w=0 THEN 0  ELSE qt_dias_inicio_w+1 END  and qt_dias_final_w
		and	((nr_seq_localizacao = nr_seq_localizacao_w) or (nr_seq_localizacao_w = 0))
		and	ie_classificacao in ('S','E')
		and	nr_seq_estagio = 9
		and	(dt_fim_real IS NOT NULL AND dt_fim_real::text <> '');


		select	max(obter_qt_volta_os(nr_sequencia))
		into STRICT	qt_max_volta_os_w
		from	man_ordem_servico
		where	dt_ordem_servico between inicio_dia(dt_inicio_p) and fim_dia(dt_final_p)
		and	ceil(dt_fim_real - dt_ordem_servico) between CASE WHEN qt_dias_inicio_w=0 THEN 0  ELSE qt_dias_inicio_w+1 END  and qt_dias_final_w
		and	((nr_seq_localizacao = nr_seq_localizacao_w) or (nr_seq_localizacao_w = 0))
		and	ie_classificacao in ('S','E')
		and	nr_seq_estagio = 9
		and	(dt_fim_real IS NOT NULL AND dt_fim_real::text <> '');
	end if;

	select	qt_os_volta_w / CASE WHEN qt_os_encerrada_w=0 THEN 1  ELSE qt_os_encerrada_w END
	into STRICT	qt_os_volta_media_w
	;

	select	round((qt_os_encerrada_w * 100) / CASE WHEN qt_nr_ordem_w=0 THEN 1  ELSE qt_nr_ordem_w END ,1)
	into STRICT 	pr_media_os_encerrada_w
	;

	pr_soma_media_w := round((pr_soma_media_w + pr_media_os_encerrada_w)::numeric,1);

	if (qt_dias_final_w = 230) then
		insert into rel_os_encerrada_w(
			ie_tipo,
			ds_resultado_1,
			ds_resultado_2,
			ds_resultado_3,
			ds_resultado_4,
			ds_resultado_5,
			ds_resultado_6,
			nr_sequencia,
			nm_usuario)
		values (	'V',
			221,
			' 230+',
			coalesce(qt_os_encerrada_w,0),
			Campo_Mascara_virgula_casas(coalesce(qt_os_volta_media_w,0),2),
			coalesce(qt_max_volta_os_w,0),
			Campo_Mascara_virgula_casas(coalesce(pr_media_os_encerrada_w,0),2),
			nr_sequencia_w,
			nm_usuario_p);
	else
		insert into rel_os_encerrada_w(
			ie_tipo,
			ds_resultado_1,
			ds_resultado_2,
			ds_resultado_3,
			ds_resultado_4,
			ds_resultado_5,
			ds_resultado_6,
			nr_sequencia,
			nm_usuario)
		values (	'V',
			CASE WHEN qt_dias_inicio_w=0 THEN qt_dias_inicio_w  ELSE qt_dias_inicio_w+1 END ,
			qt_dias_final_w,
			coalesce(qt_os_encerrada_w,0),
			Campo_Mascara_virgula_casas(coalesce(qt_os_volta_media_w,0),2),
			coalesce(qt_max_volta_os_w,0),
			Campo_Mascara_virgula_casas(coalesce(pr_media_os_encerrada_w,0),2),
			nr_sequencia_w,
			nm_usuario_p);
	end if;



	if (qt_controle_w = 1) then
		nr_sequencia_atual_w := nr_sequencia_w;

		if (qt_count_w = qt_total_quebra_w) then

			pr_soma_media_w := 0;

			if (qt_dias_final_w = 230) then
				pr_soma_media_w := round((pr_soma_media_w + pr_media_os_encerrada_w)::numeric,1) / 2;
			else
				pr_soma_media_w := round((pr_soma_media_w + pr_media_os_encerrada_w)::numeric,1) / 3;
			end if;


			update	rel_os_encerrada_w
			set	ds_resultado_7 = Campo_Mascara_virgula_casas(coalesce(pr_soma_media_w,0),1)
			where	nr_sequencia = nr_sequencia_atual_w;
		end if;

	elsif (qt_controle_w = 3) then
		qt_controle_w := 0;

		if (qt_dias_final_w = 230) then
			pr_soma_media_w := pr_soma_media_w / 2;
		else
			pr_soma_media_w := pr_soma_media_w / 3;
		end if;

		update	rel_os_encerrada_w
		set	ds_resultado_7 = Campo_Mascara_virgula_casas(coalesce(pr_soma_media_w,0),1)
		where	nr_sequencia = nr_sequencia_atual_w;
		pr_soma_media_w := 0;

	elsif (qt_count_w = qt_total_quebra_w) then

		if (qt_dias_final_w = 230) then
			pr_soma_media_w := pr_soma_media_w / 2;
		else
			pr_soma_media_w := pr_soma_media_w / 3;
		end if;

		update	rel_os_encerrada_w
		set	ds_resultado_7 = Campo_Mascara_virgula_casas(coalesce(pr_soma_media_w,0),1)
		where	nr_sequencia = nr_sequencia_atual_w;
	end if;


	qt_dias_inicio_w := qt_dias_inicio_w + 10;
	qt_dias_final_w  := qt_dias_final_w + 10;

	end;
end loop;



commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE os_encerrada_rel_t ( dt_inicio_p timestamp, dt_final_p timestamp, cd_cnpj_p text, nm_usuario_p text) FROM PUBLIC;

