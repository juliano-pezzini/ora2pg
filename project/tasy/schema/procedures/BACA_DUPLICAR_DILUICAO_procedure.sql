-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_duplicar_diluicao (cd_estabelecimento_p bigint, cd_material_p bigint) AS $body$
DECLARE



cd_unidade_medida_conv_w	varchar(30);
cd_unidade_medida_dil_w		varchar(30);

cd_estabelecimento_w		smallint;
qt_dose_min_w			double precision;
qt_dose_max_w			double precision;
ie_via_aplicacao_w		varchar(5);
cd_perfil_w			integer;
cd_setor_atendimento_w		integer;
cd_setor_excluir_w		integer;
nr_seq_restricao_w		bigint;
qt_idade_min_w			double precision;
qt_idade_min_mes_w		double precision;
qt_idade_min_dia_w		double precision;
qt_idade_max_w			double precision;
qt_idade_max_mes_w		double precision;
qt_idade_max_dia_w		double precision;
qt_fixa_diluicao_w		double precision;
qt_peso_min_w			real;
qt_peso_max_w			real;
cd_diluente_w			integer;
nr_seq_int_propaga_w		bigint;
cd_unid_med_diluente_w		varchar(30);
ie_gerar_rediluente_w		varchar(30);
ie_diluir_inteiro_w		varchar(30);
qt_diluicao_w			double precision;
qt_volume_adic_w		double precision;
qt_volume_w			double precision;
qt_minuto_aplicacao_w		smallint;
qt_concentracao_w		double precision;
cd_unid_med_concentracao_w	varchar(30);
cd_unid_med_base_concent_w	varchar(30);
nr_seq_prioridade_w		smallint;
ie_cobra_paciente_w		varchar(1);
cd_motivo_baixa_w		smallint;
cd_unid_med_reconst_w		varchar(30);
ds_referencia_w			varchar(255);
ie_atualizar_tempo_w		varchar(1);
ie_priorizar_min_w		varchar(1);
ie_reconstituicao_w		varchar(1);
ie_subtrair_volume_medic_w	varchar(1);
qt_referencia_w			double precision;
qt_minima_diluicao_w		double precision;
nr_seq_via_acesso_w		bigint;
ie_proporcao_w			varchar(15);
count_w				bigint;
qt_dose_min_orig_w		double precision;
qt_dose_max_orig_w		double precision;
nr_seq_diluicao_w		bigint;
cd_material_w			bigint;
cd_intervalo_w			varchar(50);

c00 CURSOR FOR
SELECT	cd_material
from	material
where	ie_situacao	= 'A'
and	((cd_material	= cd_material_p) or (coalesce(cd_material_p,0)	= 0))
order by 1;

c01 CURSOR FOR
SELECT	cd_unidade_medida
from	material_conversao_unidade
where	cd_material = cd_material_w;

c02 CURSOR FOR
SELECT	nr_sequencia,
	cd_estabelecimento,
	cd_unidade_medida,
	qt_dose_min,
	qt_dose_max,
	ie_via_aplicacao,
	cd_perfil,
	cd_setor_atendimento,
	cd_setor_excluir,
	nr_seq_restricao,
	qt_idade_min,
	qt_idade_min_mes,
	qt_idade_min_dia,
	qt_idade_max,
	qt_idade_max_mes,
	qt_idade_max_dia,
	qt_peso_min,
	qt_peso_max,
	cd_diluente,
	cd_unid_med_diluente,
	qt_diluicao,
	qt_volume_adic,
	qt_minuto_aplicacao,
	qt_concentracao,
	cd_unid_med_concentracao,
	cd_unid_med_base_concent,
	nr_seq_prioridade,
	ie_cobra_paciente,
	cd_motivo_baixa,
	cd_unid_med_reconst,
	ds_referencia,
	ie_atualizar_tempo,
	ie_priorizar_min,
	ie_reconstituicao,
	ie_subtrair_volume_medic,
	qt_referencia,
	ie_proporcao,
	qt_minima_diluicao,
	qt_fixa_diluicao,
	cd_intervalo,
	nr_seq_via_acesso,
	qt_volume,
	ie_gerar_rediluente,
	nr_seq_int_propaga,
	ie_diluir_inteiro
from	material_diluicao
where	cd_material	= cd_material_w
and	cd_estabelecimento = cd_estabelecimento_p
and	(cd_unidade_medida IS NOT NULL AND cd_unidade_medida::text <> '')
and	((qt_dose_min IS NOT NULL AND qt_dose_min::text <> '') or (qt_dose_max IS NOT NULL AND qt_dose_max::text <> ''));


BEGIN

open C00;
loop
fetch C00 into
	cd_material_w;
EXIT WHEN NOT FOUND; /* apply on C00 */

	open C02;
	loop
	fetch C02 into
		nr_seq_diluicao_w,
		cd_estabelecimento_w,
		cd_unidade_medida_dil_w,
		qt_dose_min_w,
		qt_dose_max_w,
		ie_via_aplicacao_w,
		cd_perfil_w,
		cd_setor_atendimento_w,
		cd_setor_excluir_w,
		nr_seq_restricao_w,
		qt_idade_min_w,
		qt_idade_min_mes_w,
		qt_idade_min_dia_w,
		qt_idade_max_w,
		qt_idade_max_mes_w,
		qt_idade_max_dia_w,
		qt_peso_min_w,
		qt_peso_max_w,
		cd_diluente_w,
		cd_unid_med_diluente_w,
		qt_diluicao_w,
		qt_volume_adic_w,
		qt_minuto_aplicacao_w,
		qt_concentracao_w,
		cd_unid_med_concentracao_w,
		cd_unid_med_base_concent_w,
		nr_seq_prioridade_w,
		ie_cobra_paciente_w,
		cd_motivo_baixa_w,
		cd_unid_med_reconst_w,
		ds_referencia_w,
		ie_atualizar_tempo_w,
		ie_priorizar_min_w,
		ie_reconstituicao_w,
		ie_subtrair_volume_medic_w,
		qt_referencia_w,
		ie_proporcao_w,
		qt_minima_diluicao_w,
		qt_fixa_diluicao_w,
		cd_intervalo_w,
		nr_seq_via_acesso_w,
		qt_volume_w,
		ie_gerar_rediluente_w,
		nr_seq_int_propaga_w,
		ie_diluir_inteiro_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */

		qt_dose_min_orig_w	:= qt_dose_min_w;
		qt_dose_max_orig_w	:= qt_dose_max_w;

		open C01;
		loop
		fetch C01 into
			cd_unidade_medida_conv_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin

			if (cd_unidade_medida_conv_w <> cd_unidade_medida_dil_w) then

				qt_dose_min_w	:= Obter_dose_convertida(cd_material_w, qt_dose_min_orig_w, cd_unidade_medida_dil_w, cd_unidade_medida_conv_w);
				qt_dose_max_w	:= Obter_dose_convertida(cd_material_w, qt_dose_max_orig_w, cd_unidade_medida_dil_w, cd_unidade_medida_conv_w);

				if (ie_reconstituicao_w = 'S') then
					insert into material_diluicao(
						nr_sequencia,
						nr_seq_interno,
						cd_estabelecimento,
						cd_unidade_medida,
						qt_dose_min,
						qt_dose_max,
						ie_via_aplicacao,
						cd_perfil,
						cd_setor_atendimento,
						cd_setor_excluir,
						nr_seq_restricao,
						qt_idade_min,
						qt_idade_min_mes,
						qt_idade_min_dia,
						qt_idade_max,
						qt_idade_max_mes,
						qt_idade_max_dia,
						qt_peso_min,
						qt_peso_max,
						cd_diluente,
						cd_unid_med_diluente,
						qt_diluicao,
						qt_volume_adic,
						qt_minuto_aplicacao,
						qt_concentracao,
						cd_unid_med_concentracao,
						cd_unid_med_base_concent,
						nr_seq_prioridade,
						ie_cobra_paciente,
						cd_motivo_baixa,
						cd_unid_med_reconst,
						ds_referencia,
						ie_atualizar_tempo,
						ie_priorizar_min,
						cd_material,
						dt_atualizacao,
						ie_reconstituicao,
						nm_usuario,
						qt_minima_diluicao,
						qt_fixa_diluicao,
						cd_intervalo,
						qt_volume,
						ie_gerar_rediluente,
						nr_seq_int_propaga,
						ie_diluir_inteiro,
						ie_subtrair_volume_medic)
					values (
						(SELECT Max(nr_Sequencia)+1 from material_diluicao where cd_material =  cd_material_w),
						nextval('material_diluicao_seq'),
						cd_estabelecimento_w,
						cd_unidade_medida_conv_w,
						qt_dose_min_w,
						qt_dose_max_w,
						ie_via_aplicacao_w,
						cd_perfil_w,
						cd_setor_atendimento_w,
						cd_setor_excluir_w,
						nr_seq_restricao_w,
						qt_idade_min_w,
						qt_idade_min_mes_w,
						qt_idade_min_dia_w,
						qt_idade_max_w,
						qt_idade_max_mes_w,
						qt_idade_max_dia_w,
						qt_peso_min_w,
						qt_peso_max_w,
						cd_diluente_w,
						cd_unid_med_diluente_w,
						qt_diluicao_w,
						qt_volume_adic_w,
						qt_minuto_aplicacao_w,
						qt_concentracao_w,
						cd_unid_med_concentracao_w,
						cd_unid_med_base_concent_w,
						nr_seq_prioridade_w,
						ie_cobra_paciente_w,
						cd_motivo_baixa_w,
						cd_unid_med_reconst_w,
						ds_referencia_w,
						ie_atualizar_tempo_w,
						ie_priorizar_min_w,
						cd_material_w,
						clock_timestamp(),
						ie_reconstituicao_w,
						'OS254415',
						qt_minima_diluicao_w,
						qt_fixa_diluicao_w,
						cd_intervalo_w,
						qt_volume_w,
						ie_gerar_rediluente_w,
						nr_seq_int_propaga_w,
						ie_diluir_inteiro_w,
						ie_subtrair_volume_medic_w);

					commit;
				elsif (ie_reconstituicao_w = 'N') then

					qt_dose_min_w	:= Obter_dose_convertida(cd_material_w, qt_dose_min_orig_w, cd_unidade_medida_dil_w, cd_unidade_medida_conv_w);
					qt_dose_max_w	:= Obter_dose_convertida(cd_material_w, qt_dose_max_orig_w, cd_unidade_medida_dil_w, cd_unidade_medida_conv_w);

					insert into material_diluicao(
						nr_sequencia,
						nr_seq_interno,
						cd_estabelecimento,
						cd_unidade_medida,
						qt_dose_min,
						qt_dose_max,
						ie_via_aplicacao,
						cd_perfil,
						cd_setor_atendimento,
						cd_setor_excluir,
						nr_seq_restricao,
						qt_idade_min,
						qt_idade_min_mes,
						qt_idade_min_dia,
						qt_idade_max,
						qt_idade_max_mes,
						qt_idade_max_dia,
						qt_peso_min,
						qt_peso_max,
						cd_diluente,
						cd_unid_med_diluente,
						qt_diluicao,
						qt_minuto_aplicacao,
						qt_referencia,
						ie_subtrair_volume_medic,
						nr_seq_prioridade,
						cd_motivo_baixa,
						ds_referencia,
						ie_atualizar_tempo,
						nr_seq_via_acesso,
						ie_proporcao,
						cd_material,
						dt_atualizacao,
						ie_reconstituicao,
						nm_usuario,
						qt_minima_diluicao,
						qt_fixa_diluicao,
						cd_intervalo,
						qt_volume,
						ie_gerar_rediluente,
						nr_seq_int_propaga,
						ie_diluir_inteiro)
					values (
						(SELECT Max(nr_Sequencia)+1 from material_diluicao where cd_material =  cd_material_w),
						nextval('material_diluicao_seq'),
						cd_estabelecimento_w,
						cd_unidade_medida_conv_w,
						qt_dose_min_w,
						qt_dose_max_w,
						ie_via_aplicacao_w,
						cd_perfil_w,
						cd_setor_atendimento_w,
						cd_setor_excluir_w,
						nr_seq_restricao_w,
						qt_idade_min_w,
						qt_idade_min_mes_w,
						qt_idade_min_dia_w,
						qt_idade_max_w,
						qt_idade_max_mes_w,
						qt_idade_max_dia_w,
						qt_peso_min_w,
						qt_peso_max_w,
						cd_diluente_w,
						cd_unid_med_diluente_w,
						qt_diluicao_w,
						qt_minuto_aplicacao_w,
						qt_referencia_w,
						ie_subtrair_volume_medic_w,
						nr_seq_prioridade_w,
						cd_motivo_baixa_w,
						ds_referencia_w,
						ie_atualizar_tempo_w,
						nr_seq_via_acesso_w,
						ie_proporcao_w,
						cd_material_W,
						clock_timestamp(),
						ie_reconstituicao_w,
						'OS254415',
						qt_minima_diluicao_w,
						qt_fixa_diluicao_w,
						cd_intervalo_w,
						qt_volume_w,
						ie_gerar_rediluente_w,
						nr_seq_int_propaga_w,
						ie_diluir_inteiro_w);
					commit;
				end if;

				qt_dose_min_w	:= qt_dose_min_orig_w;
				qt_dose_max_w	:= qt_dose_max_orig_w;

			end if;

			end;
		end loop;
		close C01;

	end loop;
	close C02;

	commit;

end loop;
close C00;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_duplicar_diluicao (cd_estabelecimento_p bigint, cd_material_p bigint) FROM PUBLIC;

