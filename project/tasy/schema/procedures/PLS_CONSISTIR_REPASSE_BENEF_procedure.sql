-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consistir_repasse_benef ( nr_seq_segurado_p bigint, nr_seq_congenere_cobr_p bigint, nr_seq_congenere_aten_p bigint, ie_tipo_repasse_p text, dt_repasse_p timestamp, ds_erro_p INOUT text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_seq_contrato_w	bigint;
nr_seq_intercambio_w	bigint;
qt_registros_w		bigint;
ds_erro_w		varchar(255);


BEGIN

select	nr_seq_contrato,
	nr_seq_intercambio
into STRICT	nr_seq_contrato_w,
	nr_seq_intercambio_w
from	pls_segurado
where	nr_sequencia	= nr_seq_segurado_p;

if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then
	select	count(*)
	into STRICT	qt_registros_w
	from	pls_contrato_regra_repasse
	where	nr_seq_contrato	= nr_seq_contrato_w
	and	ie_tipo_repasse	= ie_tipo_repasse_p;

	if (qt_registros_w	> 0) then
		select	count(*)
		into STRICT	qt_registros_w
		from	pls_contrato_regra_repasse
		where	nr_seq_contrato	= nr_seq_contrato_w
		and	ie_tipo_repasse	= ie_tipo_repasse_p
		and	((nr_seq_congenere_cobr	= nr_seq_congenere_cobr_p and (nr_seq_congenere_cobr IS NOT NULL AND nr_seq_congenere_cobr::text <> ''))
			or (coalesce(nr_seq_congenere_cobr::text, '') = ''))
		and	((nr_seq_congenere	= nr_seq_congenere_aten_p and (nr_seq_congenere IS NOT NULL AND nr_seq_congenere::text <> '') and (nr_seq_congenere_aten_p IS NOT NULL AND nr_seq_congenere_aten_p::text <> ''))
			or (coalesce(nr_seq_congenere::text, '') = '') or (coalesce(nr_seq_congenere_aten_p::text, '') = ''))
		and	pls_obter_se_depend_repasse(nr_sequencia,nr_seq_segurado_p) = 'S'
		and	pls_restring_loc_atend_repasee(nr_sequencia,nr_seq_congenere_aten_p,cd_estabelecimento_p) = 'S'
		and 	coalesce(ie_situacao,'A') = 'A';

		if (qt_registros_w	= 0) then
			ds_erro_w := wheb_mensagem_pck.get_texto(280721);
		end if;
	end if;
elsif (nr_seq_intercambio_w IS NOT NULL AND nr_seq_intercambio_w::text <> '') then
	select	count(*)
	into STRICT	qt_registros_w
	from	pls_contrato_regra_repasse
	where	nr_seq_intercambio	= nr_seq_intercambio_w
	and	ie_tipo_repasse	= ie_tipo_repasse_p;

	if (qt_registros_w	> 0) then
		select	count(*)
		into STRICT	qt_registros_w
		from	pls_contrato_regra_repasse
		where	nr_seq_intercambio	= nr_seq_intercambio_w
		and	ie_tipo_repasse	= ie_tipo_repasse_p
		and	((nr_seq_congenere_cobr	= nr_seq_congenere_cobr_p and (nr_seq_congenere_cobr IS NOT NULL AND nr_seq_congenere_cobr::text <> ''))
			or (coalesce(nr_seq_congenere_cobr::text, '') = ''))
		and	((nr_seq_congenere	= nr_seq_congenere_aten_p and (nr_seq_congenere IS NOT NULL AND nr_seq_congenere::text <> '') and (nr_seq_congenere_aten_p IS NOT NULL AND nr_seq_congenere_aten_p::text <> ''))
			or (coalesce(nr_seq_congenere::text, '') = '') or (coalesce(nr_seq_congenere_aten_p::text, '') = ''))
		and	pls_obter_se_depend_repasse(nr_sequencia,nr_seq_segurado_p) = 'S'
		and 	coalesce(ie_situacao,'A') = 'A';

		if (qt_registros_w	= 0) then
			ds_erro_w := wheb_mensagem_pck.get_texto(280721);
		end if;
	end if;
end if;

/*aaschlote - 03/01/2013 - OS - 531475*/

if (coalesce(ds_erro_w::text, '') = '') and (nr_seq_congenere_aten_p IS NOT NULL AND nr_seq_congenere_aten_p::text <> '') then

	select	count(1)
	into STRICT	qt_registros_w
	from	pls_regra_bloqueio_repasse
	where	nr_seq_congenere	= nr_seq_congenere_aten_p
	and	trunc(dt_repasse_p,'dd') between trunc(DT_INICIO_BLOQUEIO,'dd') and trunc(coalesce(DT_FIM_BLOQUEIO,dt_repasse_p),'dd')
	and	(DT_LIBERACAO IS NOT NULL AND DT_LIBERACAO::text <> '');

	if (qt_registros_w	> 0) then
		ds_erro_w := wheb_mensagem_pck.get_texto(223159);
	end if;
end if;

ds_erro_p	:= ds_erro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consistir_repasse_benef ( nr_seq_segurado_p bigint, nr_seq_congenere_cobr_p bigint, nr_seq_congenere_aten_p bigint, ie_tipo_repasse_p text, dt_repasse_p timestamp, ds_erro_p INOUT text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

