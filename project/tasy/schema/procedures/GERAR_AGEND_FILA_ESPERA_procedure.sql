-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_agend_fila_espera ( nr_sequencia_p bigint, nr_seq_agenda_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


cd_pessoa_fisica_w	varchar(10);
cd_convenio_w		integer;
cd_medico_w		varchar(10);
nr_seq_proc_interno_w 	bigint;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
ie_status_agenda_w	varchar(3);
ie_autorizacao_w 	varchar(3);
cd_cid_doenca_w		varchar(10);
dt_prevista_internacao_w timestamp;


BEGIN

ie_status_agenda_w := Obter_Param_Usuario(895, 8, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_status_agenda_w);
ie_autorizacao_w := Obter_Param_Usuario(895, 9, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_autorizacao_w);


IF (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') and (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') then
	select	cd_pessoa_fisica,
		cd_convenio,
		cd_medico,
		cd_procedimento,
		ie_origem_proced,
		nr_seq_proc_interno,
		dt_prevista_internacao,
		cd_cid_doenca
	into STRICT	cd_pessoa_fisica_w,
		cd_convenio_w,
		cd_medico_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		nr_seq_proc_interno_w,
		dt_prevista_internacao_w,
		cd_cid_doenca_w
	from	paciente_espera
	where	nr_sequencia = nr_sequencia_p;

	update	agenda_paciente
	set	cd_pessoa_fisica	= cd_pessoa_fisica_w,
		cd_convenio		= cd_convenio_w,
		cd_medico		= cd_medico_w,
		cd_procedimento		= cd_procedimento_w,
		ie_origem_proced	= ie_origem_proced_w,
		nr_seq_proc_interno     = nr_seq_proc_interno_w,
		nm_usuario		= nm_usuario_p,
		nm_usuario_orig		= nm_usuario_p,
		dt_agendamento		= clock_timestamp(),
		ie_status_agenda    	= ie_status_agenda_w,
		ie_autorizacao 		= ie_autorizacao_w,
		dt_chegada_prev		= dt_prevista_internacao_w,
		cd_doenca_cid		= cd_cid_doenca_w
	where	nr_sequencia		= nr_seq_agenda_p;

	update 	paciente_espera
	set	nr_seq_agenda 		= nr_seq_agenda_p
	where	nr_sequencia		= nr_sequencia_p;

	COMMIT;
END IF;


END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_agend_fila_espera ( nr_sequencia_p bigint, nr_seq_agenda_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

