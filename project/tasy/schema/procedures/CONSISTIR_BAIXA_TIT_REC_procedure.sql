-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_baixa_tit_rec ( nr_titulo_p bigint, vl_recebido_p bigint, vl_desconto_p bigint, vl_glosa_p bigint, vl_perdas_p bigint, vl_nota_credito_p bigint, vl_cambial_passivo_p bigint) AS $body$
DECLARE

 
vl_recebido_w		double precision;
vl_desconto_w		double precision;
vl_glosa_w		double precision;
vl_perdas_w		double precision;
vl_nota_credito_w	double precision;
vl_cambial_passivo_w	double precision;
vl_titulo_original_w	double precision;
vl_saldo_w		double precision;
vl_alteracao_w		double precision;
vl_tributo_w		double precision;
vl_titulo_w		double precision;
vl_baixa_w		double precision;
ie_tipo_titulo_w	varchar(2);
ie_passivo_saldo_tit_w	varchar(1);
cd_estabelecimento_w	smallint;


BEGIN 
select	coalesce(sum(vl_recebido),0), 
	coalesce(sum(vl_descontos),0), 
	coalesce(sum(vl_glosa),0), 
	coalesce(sum(vl_perdas),0), 
	coalesce(sum(vl_nota_credito),0), 
	coalesce(sum(vl_cambial_passivo),0) 
into STRICT 	vl_recebido_w, 
	vl_desconto_w, 
	vl_glosa_w, 
	vl_perdas_w, 
	vl_nota_credito_w, 
	vl_cambial_passivo_w 
from	titulo_receber_liq 
where	nr_titulo = nr_titulo_p 
and	coalesce(ie_lib_caixa, 'S') = 'S';
 
 
vl_recebido_w		:= coalesce(vl_recebido_w,0) + coalesce(vl_recebido_p,0);
vl_desconto_w		:= coalesce(vl_desconto_w,0) + coalesce(vl_desconto_p,0);
vl_glosa_w		:= coalesce(vl_glosa_w,0) + coalesce(vl_glosa_p,0);
vl_perdas_w		:= coalesce(vl_perdas_w,0) + coalesce(vl_perdas_p,0);
vl_nota_credito_w	:= coalesce(vl_nota_credito_w,0) + coalesce(vl_nota_credito_p,0);
vl_cambial_passivo_w	:= coalesce(vl_cambial_passivo_w,0) + coalesce(vl_cambial_passivo_p,0);
 
select	coalesce(max(vl_titulo),0), 
	coalesce(max(vl_saldo_titulo),0), 
	max(ie_tipo_titulo), 
	max(cd_estabelecimento) 
into STRICT	vl_titulo_original_w, 
	vl_saldo_w, 
	ie_tipo_titulo_w, 
	cd_estabelecimento_w 
from	titulo_receber 
where	nr_titulo	= nr_titulo_p;
 
select	coalesce(sum(CASE WHEN ie_aumenta_diminui='A' THEN  vl_alteracao WHEN ie_aumenta_diminui='D' THEN  vl_alteracao * -1 END ), 0) 
into STRICT	vl_alteracao_w 
from	alteracao_valor 
where	nr_titulo	= nr_titulo_p;
 
select	coalesce(sum(VL_TRIBUTO),0) 
into STRICT	vl_tributo_w 
from	titulo_receber_trib 
where	nr_titulo	= nr_titulo_p 
and	coalesce(ie_origem_tributo, 'C') in ('D','CD');
 
select	coalesce(a.ie_passivo_saldo_tit,'S') 
into STRICT	ie_passivo_saldo_tit_w 
from	parametro_contas_receber a 
where	a.cd_estabelecimento	= cd_estabelecimento_w;
 
if (ie_passivo_saldo_tit_w = 'N') then 
	vl_cambial_passivo_w	:= 0;
end if;
 
vl_titulo_w 	:=	coalesce(vl_titulo_original_w,0) + 
			coalesce(vl_alteracao_w,0) - 
			(coalesce(vl_recebido_w,0) + coalesce(vl_glosa_w,0) + coalesce(vl_desconto_w,0) + coalesce(vl_perdas_w,0) + coalesce(vl_nota_credito_w,0)) - 
			coalesce(vl_tributo_w,0) - 
			coalesce(vl_cambial_passivo_w,0);
 
if 	(vl_titulo_w < 0 AND ie_tipo_titulo_w <> '9') then /* Título de desconto em folha pode ser feito a baixa mesmo com valor diferente */
 
	vl_baixa_w	:= coalesce(vl_titulo_original_w,0) + coalesce(vl_alteracao_w,0) - coalesce(vl_titulo_w,0);	
 
	/* Valor das baixas supera o valor do título! 
	Título: nr_titulo_p 
	Saldo: vl_saldo_w 
	Baixa: vl_baixa_w */
 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(186552,	'NR_TITULO_P=' || nr_titulo_p || 
							';VL_SALDO_W=' || Campo_Mascara_virgula(coalesce(vl_titulo_original_w,0)) || 
							';VL_BAIXA_W=' || Campo_Mascara_virgula(vl_baixa_w) || 
							';VL_ALTERACAO_W=' || Campo_Mascara_virgula(coalesce(vl_alteracao_w,0)));
end if;
 
/* Francisco - OS 63607 - 24/07/07 - Não deixar realizar estorno superior ao valor do título */
 
if (vl_titulo_w > vl_titulo_original_w + vl_alteracao_w) then 
	vl_baixa_w	:= (vl_recebido_w + vl_glosa_w + vl_desconto_w + coalesce(vl_cambial_passivo_w,0));
	/* Valor dos estornos supera o valor do título! 
	Título: nr_titulo_p 
	Saldo: vl_saldo_w 
	Baixa: vl_baixa_w */
 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(186554,	'NR_TITULO_P=' || nr_titulo_p || 
							';VL_SALDO_W=' || vl_saldo_w || 
							';VL_BAIXA_W=' || vl_baixa_w);
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_baixa_tit_rec ( nr_titulo_p bigint, vl_recebido_p bigint, vl_desconto_p bigint, vl_glosa_p bigint, vl_perdas_p bigint, vl_nota_credito_p bigint, vl_cambial_passivo_p bigint) FROM PUBLIC;

