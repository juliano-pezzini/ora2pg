-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_devolucao_mens ( nr_seq_segurado_p bigint, nr_seq_pagador_p bigint, ie_tipo_rescisao_p text, nr_seq_motivo_cancelamento_p bigint, ie_commmit_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


/*	ie_acao_devolucao_w
	1	Gerar lancamento programado para o beneficiario
	2	Gerar titulo a pagar para o pagador
*/
nr_seq_regra_devolucao_w	pls_regra_devolucao_mens.nr_sequencia%type		:= null;
ie_acao_devolucao_w		pls_regra_devolucao_mens.ie_acao_devolucao%type		:= null;
nr_seq_motivo_w			pls_regra_devolucao_mens.nr_seq_motivo%type		:= null;
nr_seq_trans_fin_baixa_w	pls_regra_devolucao_mens.nr_seq_trans_fin_baixa%type	:= null;
nr_seq_trans_fin_contab_w	pls_regra_devolucao_mens.nr_seq_trans_fin_contab%type	:= null;
ie_titulo_liquidado_w		pls_regra_devolucao_mens.ie_titulo_liquidado%type;
ie_tipo_estipulante_w		varchar(2);
nr_contrato_w			pls_contrato.nr_contrato%type	:= null;
nr_seq_contrato_w		pls_contrato.nr_sequencia%type;
nr_seq_intercambio_w		pls_segurado.nr_seq_intercambio%type;
nr_seq_pagador_w		pls_segurado.nr_seq_pagador%type	:= null;
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
dt_rescisao_w			pls_segurado.dt_rescisao%type;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
nr_seq_mensalidade_seg_w	pls_mensalidade_segurado.nr_sequencia%type;
dt_inicio_cobertura_w		pls_mensalidade_segurado.dt_inicio_cobertura%type;
dt_fim_cobertura_w		pls_mensalidade_segurado.dt_fim_cobertura%type;
dt_mesano_referencia_w		pls_mensalidade_segurado.dt_mesano_referencia%type;
qt_dias_cobertura_w		bigint;
qt_dias_devolucao_w		bigint;
vl_total_devolucao_w		double precision;
vl_devolucao_mens_w		double precision;
vl_devolucao_item_w		double precision;
nr_seq_item_w			pls_mensalidade_seg_item.nr_sequencia%type;
vl_item_w			pls_mensalidade_seg_item.vl_item%type;
vl_ato_cooperado_w		pls_mensalidade_seg_item.vl_ato_cooperado%type;
vl_ato_auxiliar_w		pls_mensalidade_seg_item.vl_ato_auxiliar%type;
vl_ato_nao_cooperado_w		pls_mensalidade_seg_item.vl_ato_nao_cooperado%type;
cd_centro_custo_w		pls_mensalidade_seg_item.cd_centro_custo%type;
cd_conta_rec_w			pls_mensalidade_seg_item.cd_conta_rec%type;
cd_conta_ato_cooperado_w	pls_mensalidade_seg_item.cd_conta_ato_cooperado%type;
cd_conta_ato_auxiliar_w		pls_mensalidade_seg_item.cd_conta_ato_auxiliar%type;
cd_conta_ato_nao_coop_w		pls_mensalidade_seg_item.cd_conta_ato_nao_coop%type;
ie_tipo_item_w			pls_mensalidade_seg_item.ie_tipo_item%type;
nr_seq_tipo_lanc_w		pls_mensalidade_seg_item.nr_seq_tipo_lanc%type;
ds_tipo_item_w			varchar(255);
dt_lancamento_w			pls_mensalidade.dt_referencia%type;
ds_sigla_moeda_w		varchar(255);
ie_tipo_pagador_w		varchar(2);

ds_observacao_w			varchar(2000)	:= null;
ds_mensagem_mens_w		varchar(2000)	:= null;
ds_mensagem_itens_w		varchar(2000)	:= null;

nr_titulo_w			titulo_pagar.nr_titulo%type;
cd_pf_pagador_w			pessoa_fisica.cd_pessoa_fisica%type;
cd_cgc_pagador_w		pessoa_juridica.cd_cgc%type;

cd_moeda_w			parametros_contas_pagar.cd_moeda_padrao%type;
cd_tipo_taxa_juro_w		parametros_contas_pagar.cd_tipo_taxa_juro%type;
cd_tipo_taxa_multa_w		parametros_contas_pagar.cd_tipo_taxa_multa%type;
pr_juro_padrao_w		parametros_contas_pagar.pr_juro_padrao%type;
pr_multa_padrao_w		parametros_contas_pagar.pr_multa_padrao%type;

type t_number_table is table of bigint index by integer;
type t_varchar2_table is table of varchar(255) index by integer;
nr_sequencia_classif_w		t_number_table;
nr_seq_item_classif_w		t_number_table;
cd_centro_custo_classif_w	t_varchar2_table;
cd_conta_contabil_classif_w	t_varchar2_table;
vl_item_classif_w		t_number_table;
i_classif_item_w		integer;

nr_seq_lancamento_mens_w	pls_lancamento_mensalidade.nr_sequencia%type;
nr_seq_centro_apropriacao_w	pls_mens_seg_item_aprop.nr_seq_centro_apropriacao%type;
vl_apropriacao_w		pls_mens_seg_item_aprop.vl_apropriacao%type;
vl_devolucao_aprop_w		double precision;
vl_apropriado_w			double precision;
i_aprop_w	bigint;

nr_seq_centro_aprop_v		t_number_table;
vl_apropriacao_v		t_number_table;
nr_seq_lanc_aprop_w		pls_lancamento_mens_aprop.nr_sequencia%type;

nr_seq_tipo_lanc_table_w	t_number_table;
nr_seq_segurado_tb_w		t_number_table;
ie_tipo_item_tb_w		t_varchar2_table;
vl_devolucao_tb_w		t_number_table;
i_classif_tit_pag_w		bigint;
ie_lancamento_titular_w		pls_regra_devolucao_mens.ie_lancamento_titular%type;
nr_seq_titular_w		pls_segurado.nr_seq_titular%type;
nr_seq_titular_mens_w		pls_segurado.nr_seq_titular%type;
nr_seq_mensalidade_w		pls_mensalidade.nr_sequencia%type;
qt_registro_w			integer;
ie_gerar_devolucao_w		varchar(1);
ie_data_base_proporcional_w	pls_parametros.ie_data_base_proporcional%type;
dt_rescisao_pagador_w		pls_contrato_pagador.dt_rescisao%type;

C01 CURSOR FOR
	SELECT	nr_sequencia nr_seq_regra_devolucao,
		ie_acao_devolucao,
		nr_seq_motivo,
		nr_seq_trans_fin_baixa,
		nr_seq_trans_fin_contab,
		coalesce(ie_titulo_liquidado,'N'),
		coalesce(ie_lancamento_titular,'N')
	from	pls_regra_devolucao_mens a
	where	ie_situacao = 'A'
	and	((a.ie_tipo_rescisao = ie_tipo_rescisao_p) or (coalesce(a.ie_tipo_rescisao::text, '') = ''))
	and	((a.nr_seq_motivo_cancelamento = nr_seq_motivo_cancelamento_p) or (coalesce(a.nr_seq_motivo_cancelamento::text, '') = ''))
	and	((a.ie_tipo_estipulante = ie_tipo_estipulante_w) or (a.ie_tipo_estipulante = 'A'))
	and	((a.ie_tipo_pagador = ie_tipo_pagador_w) or (a.ie_tipo_pagador = 'A'))
	and	((a.nr_contrato = nr_contrato_w) or (coalesce(a.nr_contrato::text, '') = ''))
	order by coalesce(a.nr_contrato,0),
		coalesce(a.ie_tipo_pagador,'A'),
		a.ie_tipo_estipulante,
		coalesce(a.ie_tipo_rescisao,' ');

C02 CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_pagador,
		dt_rescisao,
		cd_pessoa_fisica,
		nr_seq_titular
	from	pls_segurado
	where	((nr_sequencia = nr_seq_segurado_p) or (coalesce(nr_seq_segurado_p::text, '') = ''))
	and	((nr_seq_pagador = nr_seq_pagador_p) or (coalesce(nr_seq_pagador_p::text, '') = ''))
	and	((nr_seq_segurado_p IS NOT NULL AND nr_seq_segurado_p::text <> '') or (nr_seq_pagador_p IS NOT NULL AND nr_seq_pagador_p::text <> ''));

C03 CURSOR FOR
	SELECT	a.nr_sequencia,
		b.nr_sequencia,
		a.dt_inicio_cobertura,
		a.dt_fim_cobertura,
		a.dt_mesano_referencia,
		a.nr_seq_titular
	from	pls_mensalidade_segurado a,
		pls_mensalidade b,
		pls_lote_mensalidade c
	where	a.nr_seq_mensalidade = b.nr_sequencia
	and	b.nr_seq_lote = c.nr_sequencia
	and	a.nr_seq_segurado = nr_seq_segurado_w  --Buscar as mensalidades do beneficiario
	and	((dt_rescisao_w between a.dt_inicio_cobertura and a.dt_fim_cobertura) or (a.dt_inicio_cobertura > dt_rescisao_w)) --Somente mensalidades em que o beneficiario pagou por uma cobertura superior a rescisao
	and	(c.dt_geracao_titulos IS NOT NULL AND c.dt_geracao_titulos::text <> '')  --Somente mensalidade com titulo gerado
	and	coalesce(b.ie_cancelamento::text, '') = ''
	and 	((ie_titulo_liquidado_w = 'N') or (ie_titulo_liquidado_w = 'S' and exists (	SELECT 	1
												from 	titulo_receber x
												where 	x.nr_seq_mensalidade = b.nr_sequencia
												and	x.ie_situacao = '2')))
	order by a.dt_mesano_referencia;

C04 CURSOR FOR
	SELECT	a.nr_sequencia,
		obter_valor_dominio(1930,a.ie_tipo_item) || CASE WHEN coalesce(a.nr_seq_tipo_lanc::text, '') = '' THEN ''  ELSE ' ('||pls_obter_desc_lanc_manual(a.nr_seq_tipo_lanc)||')' END  ds_tipo_item,
		a.vl_item,
		coalesce(a.vl_ato_cooperado,0),
		coalesce(a.vl_ato_auxiliar,0),
		coalesce(a.vl_ato_nao_cooperado,0),
		a.cd_centro_custo,
		a.cd_conta_rec,
		a.cd_conta_ato_cooperado,
		a.cd_conta_ato_auxiliar,
		a.cd_conta_ato_nao_coop,
		a.ie_tipo_item,
		a.nr_seq_tipo_lanc
	from	pls_mensalidade_seg_item a
	where	a.nr_seq_mensalidade_seg	= nr_seq_mensalidade_seg_w
	and	exists (SELECT	1
			from	pls_regra_dev_mens_item x
			where	x.nr_seq_regra	= nr_seq_regra_devolucao_w
			and	x.ie_tipo_item	= a.ie_tipo_item
			and (x.nr_seq_tipo_lanc = a.nr_seq_tipo_lanc or coalesce(x.nr_seq_tipo_lanc::text, '') = ''));

C05 CURSOR FOR
	SELECT	a.nr_seq_centro_apropriacao,
		sum(a.vl_apropriacao)
	from	pls_mens_seg_item_aprop a,
		pls_mensalidade_seg_item b
	where	b.nr_sequencia			= a.nr_seq_item
	and	b.nr_seq_mensalidade_seg	= nr_seq_mensalidade_seg_w
	and	exists (SELECT	1
			from	pls_regra_dev_mens_item x
			where	x.nr_seq_regra	= nr_seq_regra_devolucao_w
			and	x.ie_tipo_item	= b.ie_tipo_item
			and (x.nr_seq_tipo_lanc = b.nr_seq_tipo_lanc or coalesce(x.nr_seq_tipo_lanc::text, '') = ''))
	group by a.nr_seq_centro_apropriacao;

BEGIN

if (nr_seq_segurado_p IS NOT NULL AND nr_seq_segurado_p::text <> '') then
	select	nr_seq_contrato,
		nr_seq_intercambio,
		nr_seq_pagador
	into STRICT	nr_seq_contrato_w,
		nr_seq_intercambio_w,
		nr_seq_pagador_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
elsif (nr_seq_pagador_p IS NOT NULL AND nr_seq_pagador_p::text <> '') then
	select	nr_seq_contrato,
		nr_seq_pagador_intercambio,
		dt_rescisao
	into STRICT	nr_seq_contrato_w,
		nr_seq_intercambio_w,
		dt_rescisao_pagador_w
	from	pls_contrato_pagador
	where	nr_sequencia	= nr_seq_pagador_p;
	
	nr_seq_pagador_w	:= nr_seq_pagador_p;
end if;

select	CASE WHEN coalesce(max(cd_pessoa_fisica)::text, '') = '' THEN 'PJ'  ELSE 'PF' END
into STRICT	ie_tipo_pagador_w
from	pls_contrato_pagador
where	nr_sequencia	= nr_seq_pagador_w;

if (coalesce(nr_seq_contrato_w,0) <> 0) then
	select	CASE WHEN coalesce(cd_pf_estipulante::text, '') = '' THEN 'PJ'  ELSE 'PF' END ,
		nr_contrato
	into STRICT	ie_tipo_estipulante_w,
		nr_contrato_w
	from	pls_contrato
	where	nr_sequencia	= nr_seq_contrato_w;
elsif (coalesce(nr_seq_intercambio_w,0) <> 0) then
	select	CASE WHEN coalesce(cd_pessoa_fisica::text, '') = '' THEN 'PJ'  ELSE 'PF' END
	into STRICT	ie_tipo_estipulante_w
	from	pls_intercambio
	where	nr_sequencia	= nr_seq_intercambio_w;
else
	ie_tipo_estipulante_w	:= '';
end if;

select	max(ie_data_base_proporcional)
into STRICT	ie_data_base_proporcional_w
from	pls_parametros
where	cd_estabelecimento = cd_estabelecimento_p;

open C01;
loop
fetch C01 into
	nr_seq_regra_devolucao_w,
	ie_acao_devolucao_w,
	nr_seq_motivo_w,
	nr_seq_trans_fin_baixa_w,
	nr_seq_trans_fin_contab_w,
	ie_titulo_liquidado_w,
	ie_lancamento_titular_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
end loop;
close C01;

if (ie_acao_devolucao_w IS NOT NULL AND ie_acao_devolucao_w::text <> '') then
	i_classif_item_w	:= 0;
	ds_mensagem_mens_w	:= '';
	vl_total_devolucao_w	:= 0;
	ds_sigla_moeda_w	:= obter_desc_sigla_moeda(obter_moeda_padrao(cd_estabelecimento_p,'P'));
	i_aprop_w := 0;
	
	i_classif_tit_pag_w	:= 0;

	open C02;
	loop
	fetch C02 into
		nr_seq_segurado_w,
		nr_seq_pagador_w,
		dt_rescisao_w,
		cd_pessoa_fisica_w,
		nr_seq_titular_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		
		if (coalesce(nr_seq_titular_w::text, '') = '') then
			select	max(nr_sequencia)
			into STRICT	nr_seq_titular_w
			from	pls_segurado
			where	nr_seq_contrato = nr_seq_contrato_w
			and	nr_sequencia <> nr_seq_segurado_w
			and	coalesce(nr_seq_titular::text, '') = ''
			and	((coalesce(dt_rescisao::text, '') = '') or (dt_rescisao > clock_timestamp()));
		end if;
		
		if (ie_lancamento_titular_w = 'S') and (nr_seq_titular_w IS NOT NULL AND nr_seq_titular_w::text <> '') then
			select	nr_seq_pagador
			into STRICT	nr_seq_pagador_w
			from	pls_segurado
			where	nr_sequencia	= nr_seq_titular_w;
		end if;

		open C03;
		loop
		fetch C03 into
			nr_seq_mensalidade_seg_w,
			nr_seq_mensalidade_w,
			dt_inicio_cobertura_w,
			dt_fim_cobertura_w,
			dt_mesano_referencia_w,
			nr_seq_titular_mens_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			
			if (ie_data_base_proporcional_w = 'T') then
				qt_dias_cobertura_w 	:= 30;
			else
				qt_dias_cobertura_w	:= (trunc(dt_fim_cobertura_w,'dd') - dt_inicio_cobertura_w) + 1;
			end if;
			
			qt_dias_devolucao_w	:= 0;
			vl_devolucao_mens_w	:= 0;
			ie_gerar_devolucao_w	:= 'S';
			
			--Tratamento para nao gerar devolucao quando e gerado preco por familia e os dependentes continuam ativos
			select	count(1)
			into STRICT	qt_registro_w
			from	pls_mensalidade_seg_item	a,
				pls_mensalidade_segurado	b,
				pls_segurado			c
			where	b.nr_sequencia		= a.nr_seq_mensalidade_seg
			and	c.nr_sequencia		= b.nr_seq_segurado
			and	b.nr_seq_mensalidade	= nr_seq_mensalidade_w
			and	b.nr_seq_titular	= nr_seq_segurado_w
			and	a.ie_tipo_item		= '1'
			and	a.vl_item		= 0
			and	coalesce(c.dt_rescisao::text, '') = '';
			
			if (qt_registro_w > 0) then
				ie_gerar_devolucao_w	:= 'N';
			end if;
			
			if (ie_tipo_rescisao_p in ('P','C')) and (trunc(dt_rescisao_pagador_w,'dd') <> trunc(dt_rescisao_w,'dd')) and (ie_gerar_devolucao_w = 'S') then
				ie_gerar_devolucao_w	:= 'N';
			end if;

			if (dt_rescisao_w between dt_inicio_cobertura_w and dt_fim_cobertura_w) then
				qt_dias_devolucao_w	:= (trunc(dt_fim_cobertura_w,'dd') - trunc(dt_rescisao_w,'dd'));
			elsif (dt_inicio_cobertura_w > dt_rescisao_w) then
				qt_dias_devolucao_w	:= qt_dias_cobertura_w;
			end if;
			
			if (qt_dias_devolucao_w > 0) and (ie_gerar_devolucao_w = 'S') then
				ds_mensagem_itens_w	:= '';
				open C04;
				loop
				fetch C04 into
					nr_seq_item_w,
					ds_tipo_item_w,
					vl_item_w,
					vl_ato_cooperado_w,
					vl_ato_auxiliar_w,
					vl_ato_nao_cooperado_w,
					cd_centro_custo_w,
					cd_conta_rec_w,
					cd_conta_ato_cooperado_w,
					cd_conta_ato_auxiliar_w,
					cd_conta_ato_nao_coop_w,
					ie_tipo_item_w,
					nr_seq_tipo_lanc_w;
				EXIT WHEN NOT FOUND; /* apply on C04 */
					begin
					
					vl_devolucao_item_w	:= (vl_item_w / qt_dias_cobertura_w) * qt_dias_devolucao_w;
					vl_ato_cooperado_w	:= (vl_ato_cooperado_w / qt_dias_cobertura_w) * qt_dias_devolucao_w;
					vl_ato_auxiliar_w	:= (vl_ato_auxiliar_w / qt_dias_cobertura_w) * qt_dias_devolucao_w;
					vl_ato_nao_cooperado_w	:= (vl_ato_nao_cooperado_w / qt_dias_cobertura_w) * qt_dias_devolucao_w;
					
					i_classif_tit_pag_w	:= i_classif_tit_pag_w + 1;
					nr_seq_segurado_tb_w(i_classif_tit_pag_w)		:= nr_seq_segurado_w;
					ie_tipo_item_tb_w(i_classif_tit_pag_w)			:= ie_tipo_item_w;
					vl_devolucao_tb_w(i_classif_tit_pag_w)			:= vl_devolucao_item_w;
					nr_seq_tipo_lanc_table_w(i_classif_tit_pag_w)		:= nr_seq_tipo_lanc_w;
					
					vl_devolucao_mens_w	:= vl_devolucao_mens_w + coalesce(vl_devolucao_item_w,0);
					ds_mensagem_itens_w	:= ds_mensagem_itens_w || ds_tipo_item_w || ': ' || ds_sigla_moeda_w || campo_mascara_virgula(vl_devolucao_item_w) || chr(13);
					
					if	((vl_ato_cooperado_w > 0) or (vl_ato_auxiliar_w > 0) or (vl_ato_nao_cooperado_w > 0)) then
						if	((vl_ato_cooperado_w + vl_ato_auxiliar_w + vl_ato_nao_cooperado_w) <> vl_devolucao_item_w) then
							vl_ato_cooperado_w	:= vl_devolucao_item_w - vl_ato_auxiliar_w - vl_ato_nao_cooperado_w;
						end if;
						
						if (vl_ato_cooperado_w > 0) then
							i_classif_item_w				:= i_classif_item_w + 1;
							nr_sequencia_classif_w(i_classif_item_w)	:= i_classif_item_w;
							nr_seq_item_classif_w(i_classif_item_w)		:= nr_seq_item_w;
							cd_centro_custo_classif_w(i_classif_item_w)	:= cd_centro_custo_w;
							cd_conta_contabil_classif_w(i_classif_item_w)	:= cd_conta_ato_cooperado_w;
							vl_item_classif_w(i_classif_item_w)		:= vl_ato_cooperado_w;
						end if;
						if (vl_ato_auxiliar_w > 0) then
							i_classif_item_w				:= i_classif_item_w + 1;
							nr_sequencia_classif_w(i_classif_item_w)	:= i_classif_item_w;
							nr_seq_item_classif_w(i_classif_item_w)		:= nr_seq_item_w;
							cd_centro_custo_classif_w(i_classif_item_w)	:= cd_centro_custo_w;
							cd_conta_contabil_classif_w(i_classif_item_w)	:= cd_conta_ato_auxiliar_w;
							vl_item_classif_w(i_classif_item_w)		:= vl_ato_auxiliar_w;
						end if;
						if (vl_ato_nao_cooperado_w > 0) then
							i_classif_item_w				:= i_classif_item_w + 1;
							nr_sequencia_classif_w(i_classif_item_w)	:= i_classif_item_w;
							nr_seq_item_classif_w(i_classif_item_w)		:= nr_seq_item_w;
							cd_centro_custo_classif_w(i_classif_item_w)	:= cd_centro_custo_w;
							cd_conta_contabil_classif_w(i_classif_item_w)	:= cd_conta_ato_nao_coop_w;
							vl_item_classif_w(i_classif_item_w)		:= vl_ato_nao_cooperado_w;
						end if;	
					else
						i_classif_item_w				:= i_classif_item_w + 1;
						nr_sequencia_classif_w(i_classif_item_w)	:= i_classif_item_w;
						nr_seq_item_classif_w(i_classif_item_w)		:= nr_seq_item_w;
						cd_centro_custo_classif_w(i_classif_item_w)	:= cd_centro_custo_w;
						cd_conta_contabil_classif_w(i_classif_item_w)	:= cd_conta_rec_w;
						vl_item_classif_w(i_classif_item_w)		:= vl_devolucao_item_w;
					end if;
					end;
				end loop;
				close C04;
				
				ds_mensagem_mens_w	:= substr(ds_mensagem_mens_w || wheb_mensagem_pck.get_texto(318524) || ' ' || to_char(dt_mesano_referencia_w,'mm/yyyy') || ' (' || ds_sigla_moeda_w ||campo_mascara_virgula(vl_devolucao_mens_w) || '):' || chr(13),1,2000);
				ds_mensagem_mens_w	:= substr(ds_mensagem_mens_w || ds_mensagem_itens_w || chr(13),1,2000);
				vl_total_devolucao_w	:= vl_total_devolucao_w + vl_devolucao_mens_w;
			end if;
			
			open C05;
			loop
			fetch C05 into
				nr_seq_centro_apropriacao_w,
				vl_apropriacao_w;
			EXIT WHEN NOT FOUND; /* apply on C05 */
				begin
				vl_devolucao_aprop_w	:= (vl_apropriacao_w / qt_dias_cobertura_w) * qt_dias_devolucao_w;
				
				nr_seq_centro_aprop_v(i_aprop_w)	:= nr_seq_centro_apropriacao_w;
				vl_apropriacao_v(i_aprop_w)		:= vl_devolucao_aprop_w;
				i_aprop_w	:= i_aprop_w + 1;
				end;
			end loop;
			close C05;
			
			end;
		end loop;
		close C03;
		
		if (vl_total_devolucao_w > 0) then
			--Devolucao de mensalidade gerada com a rescisao do beneficiario #@NM_BENEFICIARIO#@
			ds_observacao_w	:= wheb_mensagem_pck.get_texto(318521,'NM_BENEFICIARIO='||nr_seq_segurado_w||' - '||obter_nome_pf(cd_pessoa_fisica_w)) || chr(13);
			ds_observacao_w	:= substr(ds_observacao_w || ds_mensagem_mens_w,1,2000);
			
			if (ie_acao_devolucao_w = '1') then
				if (coalesce(nr_seq_motivo_w::text, '') = '') then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(368691); --Nao foi informado o motivo do lancamento programado na regra de devolucao de mensalidade
				end if;
				
				select	max(dt_referencia)
				into STRICT	dt_lancamento_w
				from	pls_mensalidade
				where	nr_seq_pagador	= nr_seq_pagador_w
				and	coalesce(ie_cancelamento::text, '') = '';
				
				if (coalesce(dt_lancamento_w::text, '') = '') then
					select	max(b.dt_referencia)
					into STRICT	dt_lancamento_w
					from	pls_mensalidade_segurado	a,
						pls_mensalidade			b
					where	a.nr_seq_segurado 	= nr_seq_segurado_w
					and	b.nr_sequencia		= a.nr_seq_mensalidade
					and	coalesce(b.ie_cancelamento::text, '') = '';
				end if;
				
				dt_lancamento_w	:= add_months(trunc(dt_lancamento_w, 'month'),1);
				
				select	nextval('pls_lancamento_mensalidade_seq')
				into STRICT	nr_seq_lancamento_mens_w
				;
				
				insert	into	pls_lancamento_mensalidade(	nr_sequencia, cd_estabelecimento, dt_mes_competencia, ie_situacao,
						ie_tipo_item, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
						vl_lancamento, nr_seq_segurado, nr_seq_pagador, nr_seq_motivo,
						nr_seq_seg_rescisao, dt_ocorrencia, ds_observacao,
						dt_inicio_cobertura, dt_fim_cobertura, dt_liberacao, nm_usuario_liberacao)
					values (	nr_seq_lancamento_mens_w, cd_estabelecimento_p, dt_lancamento_w, 'A',
						'20', clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p,
						vl_total_devolucao_w, CASE WHEN ie_lancamento_titular_w='S' THEN coalesce(nr_seq_titular_w,nr_seq_segurado_w)  ELSE nr_seq_segurado_w END , nr_seq_pagador_w, nr_seq_motivo_w,
						nr_seq_segurado_w, dt_rescisao_w, ds_observacao_w,
						dt_rescisao_w, dt_fim_cobertura_w, clock_timestamp(), nm_usuario_p);
				
				if (nr_seq_centro_aprop_v.count > 0) then
					for i in nr_seq_centro_aprop_v.first..nr_seq_centro_aprop_v.last loop
					
					select	max(nr_sequencia)
					into STRICT	nr_seq_lanc_aprop_w
					from	pls_lancamento_mens_aprop
					where	nr_seq_lancamento	= nr_seq_lancamento_mens_w
					and	nr_seq_centro_apropriacao = nr_seq_centro_aprop_v(i);
					
					if (nr_seq_lanc_aprop_w IS NOT NULL AND nr_seq_lanc_aprop_w::text <> '') then
						update	pls_lancamento_mens_aprop
						set	vl_apropriacao	= vl_apropriacao + vl_apropriacao_v(i)
						where	nr_sequencia	= nr_seq_lanc_aprop_w;
					else
						select	nextval('pls_lancamento_mens_aprop_seq')
						into STRICT	nr_seq_lanc_aprop_w
						;
						
						insert	into	pls_lancamento_mens_aprop(	nr_sequencia, nr_seq_lancamento, nr_seq_centro_apropriacao,
							dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
							vl_apropriacao)
						values (	nr_seq_lanc_aprop_w, nr_seq_lancamento_mens_w, nr_seq_centro_aprop_v(i),
							clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p,
							vl_apropriacao_v(i));
					end if;
					
					end loop;
				end if;
				
				select	sum(vl_apropriacao)
				into STRICT	vl_apropriado_w
				from	pls_lancamento_mens_aprop
				where	nr_seq_lancamento	= nr_seq_lancamento_mens_w;
				
				if (vl_total_devolucao_w <> vl_apropriado_w) then
					update	pls_lancamento_mens_aprop
					set	vl_apropriacao = vl_apropriacao + (vl_total_devolucao_w - vl_apropriado_w)
					where	nr_sequencia = (SELECT	max(nr_sequencia)
								from	pls_lancamento_mens_aprop
								where	nr_seq_lancamento = nr_seq_lancamento_mens_w);
				end if;
			end if;
		end if;
		end;
	end loop;
	close C02;

	if (ie_acao_devolucao_w = '2') and (nr_seq_pagador_w IS NOT NULL AND nr_seq_pagador_w::text <> '') and (vl_total_devolucao_w > 0) then
		select	cd_pessoa_fisica,
			cd_cgc
		into STRICT	cd_pf_pagador_w,
			cd_cgc_pagador_w
		from	pls_contrato_pagador
		where	nr_sequencia	= nr_seq_pagador_w;
		
		if (nr_seq_pagador_p IS NOT NULL AND nr_seq_pagador_p::text <> '') then
			ds_observacao_w	:= wheb_mensagem_pck.get_texto(324425,'NM_PAGADOR='||nr_seq_pagador_w||' - '||obter_nome_pf_pj(cd_pf_pagador_w,cd_cgc_pagador_w)) || chr(13);
		end if;
		
		select	cd_moeda_padrao,
			cd_tipo_taxa_juro,
			cd_tipo_taxa_multa,
			pr_juro_padrao,
			pr_multa_padrao
		into STRICT	cd_moeda_w,
			cd_tipo_taxa_juro_w,
			cd_tipo_taxa_multa_w,
			pr_juro_padrao_w,
			pr_multa_padrao_w
		from	parametros_contas_pagar
		where	cd_estabelecimento	= cd_estabelecimento_p;
		
		select	nextval('titulo_pagar_seq')
		into STRICT	nr_titulo_w
		;
		
		insert	into	titulo_pagar(	nr_titulo,
				cd_estabelecimento,
				dt_atualizacao,
				nm_usuario,
				cd_pessoa_fisica,
				cd_cgc,
				dt_emissao,
				dt_vencimento_original,
				dt_vencimento_atual,
				vl_titulo,
				vl_saldo_titulo,
				cd_moeda,
				vl_saldo_juros,
				vl_saldo_multa,
				cd_tipo_taxa_juro,
				cd_tipo_taxa_multa,
				tx_juros,
				tx_multa,
				ie_situacao,
				ie_origem_titulo,
				ie_tipo_titulo,
				nr_seq_seg_rescisao,
				ds_observacao_titulo,
				nr_seq_trans_fin_baixa,
				nr_seq_trans_fin_contab,
				dt_contabil,
				nr_seq_pagador
			)
			values (	nr_titulo_w, --nr_titulo
				cd_estabelecimento_p, --cd_estabelecimento
				clock_timestamp(), --dt_atualizacao
				nm_usuario_p, --nm_usuario
				cd_pf_pagador_w, --cd_pessoa_fisica
				cd_cgc_pagador_w, --cd_cgc
				clock_timestamp(), --dt_emissao
				clock_timestamp() + interval '30 days', --dt_vencimento_original
				clock_timestamp() + interval '30 days', --dt_vencimento_atual
				vl_total_devolucao_w, --vl_titulo
				vl_total_devolucao_w, --vl_saldo_titulo
				cd_moeda_w, --cd_moeda
				0, --vl_saldo_juros
				0, --vl_saldo_multa
				cd_tipo_taxa_juro_w, --cd_tipo_taxa_juro
				cd_tipo_taxa_multa_w, --cd_tipo_taxa_multa
				pr_juro_padrao_w, --tx_juros
				pr_multa_padrao_w, --tx_multa
				'A', --ie_situacao
				'23', --ie_origem_titulo
				'1', --ie_tipo_titulo
				nr_seq_segurado_w, --nr_seq_seg_rescisao
				ds_observacao_w, --ds_observacao_titulo
				nr_seq_trans_fin_baixa_w, --nr_seq_trans_fin_baixa
				nr_seq_trans_fin_contab_w, --nr_seq_trans_fin_contab
				clock_timestamp(), --dt_contabil
				nr_seq_pagador_w
			);
		
		if (nr_seq_item_classif_w.count > 0) then
			forall i in nr_seq_item_classif_w.first..nr_seq_item_classif_w.last
				insert into titulo_pagar_classif(
					nr_sequencia, nr_titulo, nr_seq_item_mensalidade,
					cd_centro_custo, cd_conta_contabil,
					vl_titulo, nm_usuario, dt_atualizacao
				) values (
					nr_sequencia_classif_w(i), nr_titulo_w, nr_seq_item_classif_w(i),
					cd_centro_custo_classif_w(i), cd_conta_contabil_classif_w(i),
					vl_item_classif_w(i), nm_usuario_p, clock_timestamp());
			commit;
			
			nr_sequencia_classif_w.delete;
			nr_seq_item_classif_w.delete;
			cd_centro_custo_classif_w.delete;
			cd_conta_contabil_classif_w.delete;
			vl_item_classif_w.delete;
		end if;
		
		if (nr_seq_segurado_tb_w.count > 0) then
			for i in nr_seq_segurado_tb_w.first..nr_seq_segurado_tb_w.last loop
				begin	
					insert into titulo_pagar_classif_ops(
							nr_sequencia, vl_classificacao, dt_atualizacao,
							nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
							nr_seq_segurado, ie_tipo_item, nr_seq_tipo_lanc,
							nr_titulo
					) values (
							nextval('titulo_pagar_classif_ops_seq'), vl_devolucao_tb_w(i), clock_timestamp(),
							nm_usuario_p, clock_timestamp(), nm_usuario_p,
							nr_seq_segurado_tb_w(i), ie_tipo_item_tb_w(i), nr_seq_tipo_lanc_table_w(i),
							nr_titulo_w);
				end;
			end loop;
		end if;
	end if;
end if;

if (ie_commmit_p = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_devolucao_mens ( nr_seq_segurado_p bigint, nr_seq_pagador_p bigint, ie_tipo_rescisao_p text, nr_seq_motivo_cancelamento_p bigint, ie_commmit_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

