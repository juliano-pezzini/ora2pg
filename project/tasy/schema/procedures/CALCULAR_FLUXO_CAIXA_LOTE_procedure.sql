-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_fluxo_caixa_lote ( nr_seq_lote_fluxo_p bigint, cd_estabelecimento_p bigint, vl_saldo_anterior_p bigint, dt_inicio_p timestamp, dt_final_p timestamp, ie_classif_p text, nm_usuario_p text, cd_empresa_p bigint, ie_restringe_estab_p text, ie_passado_real_p text) AS $body$
DECLARE


/*--------------------------------------------------------------- ATENÇÃO ----------------------------------------------------------------*/


/* Cuidado ao realizar alterações no fluxo de caixa em lote. Toda e qualquer alteração realizada em qualquer uma */


/* das procedures do fluxo de caixa em lote deve ser cuidadosamente verificada e realizada no fluxo de caixa      */


/* convencional. Devemos garantir que os dois fluxos de caixa tragam os mesmos valores no resultado, evitando     */


/* assim que existam diferenças entre os fluxos de caixa.                                                                                                */


/*--------------- AO ALTERAR O FLUXO DE CAIXA EM LOTE ALTERAR TAMBÉM O FLUXO DE CAIXA ---------------*/

vl_fluxo_w			fluxo_caixa_item.vl_fluxo%type;
vl_saldo_w			fluxo_caixa_item.vl_fluxo%type;
nr_seq_saldo_w			bigint;
nr_seq_caixa_w			bigint;
vl_saldo_anterior_w		fluxo_caixa_item.vl_fluxo%type;
vl_saldo_caixa_w		fluxo_caixa_item.vl_fluxo%type;
vl_saldo_banco_w		fluxo_caixa_item.vl_fluxo%type;
cd_conta_financ_w		bigint;
cd_conta_saldo_ant_w		bigint;
cd_conta_saldo_w		bigint;
cd_conta_diaria_w		bigint;
dt_referencia_w			timestamp;
cd_conta_superior_w		bigint;
ie_origem_w			varchar(01)	:= 'C';
vl_saldo_fluxo_w		fluxo_caixa_item.vl_fluxo%type	:= 0;
dt_saldo_atual_w		timestamp;
dt_saldo_anterior_w		timestamp;
dt_inicio_calculo_w		timestamp;
dt_saldo_w			timestamp;
dt_atual_w			timestamp;
ie_saldo_anterior_w		varchar(100);
ie_saldo_passado_w		varchar(100);
ie_passado_real_param_w		varchar(100);
vl_saldo_avista_w		fluxo_caixa_item.vl_fluxo%type;
vl_saldo_fechamento_w		fluxo_caixa_item.vl_fluxo%type;
vl_saldo_ant_w			fluxo_caixa_item.vl_fluxo%type;
dt_inicio_w			timestamp;
dt_final_w	       		timestamp;
ie_saldo_realizar_zerado_w	varchar(1)	:= 'N';
ie_fluxo_diario_w		varchar(255);
vl_inicio_projeto_w		fluxo_caixa_item.vl_fluxo%type;
vl_cheque_w			fluxo_caixa_item.vl_fluxo%type;
ie_fechamento_diario_w		varchar(10);
ds_erro_w			varchar(255);
qt_reg_lote_w			bigint;
vl_lote_fluxo_w			fluxo_caixa_item.vl_fluxo%type;
qt_reg_w			bigint;
vl_regra_saldo_banco_w		fluxo_caixa_item.vl_fluxo%type;
cd_conta_financ_acum_w		conta_financeira.cd_conta_financ%type;
cd_conta_financ_ant_w		conta_financeira.cd_conta_financ%type;
vl_saldo_fluxo_acum_w		fluxo_caixa.vl_fluxo%type	:= 0;

dt_inicio_dia_w			timestamp;
dt_inicio_fim_dia_w		timestamp;
dt_inicio_fim_mes_w		timestamp;
dt_inicio_fim_dia_ant_w		timestamp;
dt_fechamento_w			timestamp;
dt_fechamento_mes_w		timestamp;
dt_saldo_dia_w			timestamp;
dt_inicio_mes_w			timestamp;
dt_final_mes_w			timestamp;
dt_referencia_ini_w		timestamp;
dt_referencia_fim_w		timestamp;

ie_identificacao_w		varchar(15);
ie_integracao_w			fluxo_caixa.ie_integracao%type;
cd_conta_financ_cre_w		bigint;
ie_adiant_receb_w		varchar(255);
ie_tit_rec_canc_w		varchar(255);
ie_movto_bco_pend_w		varchar(2);
ie_data_tit_adiant_rec_w	varchar(1);
ie_titulo_caixa_w		parametro_fluxo_caixa.ie_titulo_caixa%type;
ie_tit_pagar_transf_w		varchar(255);
ie_trans_fin_conta_w		varchar(1);
vl_rec_baixado_w		fluxo_caixa.vl_fluxo%type;
/* Projeto Multimoeda - Variáveis */

cd_moeda_empresa_w		integer;
cd_moeda_estrang_w		integer;
vl_saldo_banco_estrang_w	double precision;
vl_cheque_estrang_w		double precision;
vl_saldo_caixa_estrang_w	double precision;
vl_saldo_vista_estrang_w	double precision;
vl_saldo_ant_estrang_w		double precision;
vl_regra_saldo_estrang_w	double precision;
vl_fluxo_item_lote_w		double precision;


c01 CURSOR FOR
SELECT	max(b.nr_sequencia)
from	estabelecimento c,
	banco_saldo b,
	banco_estabelecimento a
where (a.cd_estabelecimento	= cd_estabelecimento_p or ie_restringe_estab_p = 'N')
and	c.cd_empresa		= cd_empresa_p
and	a.cd_estabelecimento	= c.cd_estabelecimento
and	b.nr_seq_conta		= a.nr_sequencia
and	coalesce(b.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
and	a.ie_tipo_relacao	in ('C', 'ECC')
and	a.ie_fluxo_caixa	= 'S'
and	a.ie_situacao 		= 'A'
group by	b.nr_seq_conta;

c03 CURSOR FOR
SELECT	max(a.dt_saldo),
	a.nr_seq_caixa
from	estabelecimento c,
	caixa b,
	caixa_saldo_diario a
where (b.CD_ESTABELECIMENTO	= cd_estabelecimento_p or ie_restringe_estab_p = 'N')
and	c.cd_empresa		= cd_empresa_p
and	b.cd_estabelecimento	= c.cd_estabelecimento
and	a.dt_saldo		<= dt_inicio_fim_dia_w
and	b.nr_sequencia		= a.nr_seq_caixa
and	cd_moeda_empresa_w	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros em moeda nacional
and	b.ie_situacao		= 'A'
group by	a.nr_seq_caixa;

c020 CURSOR FOR
SELECT	b.dt_referencia,
	sum(coalesce(b.vl_fluxo,0))
from	fluxo_caixa_lote a,
	fluxo_caixa_item b,
	conta_financeira c
where	a.nr_sequencia		= b.nr_seq_lote_fluxo
and	b.cd_conta_financ	= c.cd_conta_financ
and	a.ie_classif_fluxo	= ie_classif_p
and	a.cd_empresa		= cd_empresa_p
and	c.cd_empresa		= cd_empresa_p        -- Não pode entrar conta financeira de outra empresa
and	c.cd_conta_financ	<> cd_conta_saldo_ant_w
and	coalesce(c.cd_conta_superior::text, '') = ''
and	c.ie_oper_fluxo		<> 'I'
and	coalesce(b.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
and	b.dt_referencia		between dt_inicio_calculo_w and dt_final_w
and (c.cd_estabelecimento	= cd_estabelecimento_p or ie_restringe_estab_p = 'N')
and 	((a.ie_situacao_fluxo_data = 'T') or (a.ie_situacao_fluxo_data = c.ie_situacao))
group by b.dt_referencia
order by b.dt_referencia;

c030 CURSOR FOR
SELECT 	distinct
	c.cd_conta_financ,
	b.ie_integracao,
	b.ie_identificacao
from	fluxo_caixa_lote a,
	fluxo_caixa_item b,
	conta_financeira c
where	a.nr_sequencia		= b.nr_seq_lote_fluxo
and	b.cd_conta_financ		= c.cd_conta_financ
and	a.ie_classif_fluxo		= ie_classif_p
and	a.cd_empresa		= cd_empresa_p
and	c.cd_empresa		= cd_empresa_p        -- Não pode entrar conta financeira de outra empresa
and 	coalesce(c.ie_acumular,'N')	= 'S'
and	coalesce(b.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
and	b.dt_referencia		between dt_inicio_calculo_w and dt_final_w
and (c.cd_estabelecimento	= cd_estabelecimento_p or ie_restringe_estab_p = 'N')
and 	((a.ie_situacao_fluxo_data = 'T') or (a.ie_situacao_fluxo_data = c.ie_situacao))
order by	c.cd_conta_financ;


BEGIN

dt_inicio_w		:= dt_inicio_p;
dt_final_w	       	:= dt_final_p;

dt_inicio_dia_w		:= PKG_DATE_UTILS.start_of(dt_inicio_w,'dd',0);
dt_inicio_fim_dia_w		:= fim_dia(dt_inicio_w);
dt_inicio_fim_mes_w	:= fim_dia(fim_mes(dt_inicio_w));
dt_inicio_mes_w		:= PKG_DATE_UTILS.start_of(dt_inicio_p,'month',0);
dt_final_mes_w		:= PKG_DATE_UTILS.start_of(dt_final_p,'month',0);

ie_fechamento_diario_w := Obter_Param_Usuario(830, 22, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_fechamento_diario_w);

select	max(cd_moeda)
into STRICT	cd_moeda_estrang_w
from 	fluxo_caixa_lote
where	nr_sequencia = nr_seq_lote_fluxo_p;
/* Projeto Multimoeda - Busca a moeda padrão da empresa e verifica a moeda cadastrada no fluxo em lote. Ele será a base da busca dos dados
		em moeda estrangeira. Caso a moeda do fluxo seja nula, deverá ser considerada a moeda padrão da empresa nas consultas,
		caso contrário irá buscar somente os dados na moeda selecionada.*/
select obter_moeda_padrao_empresa(cd_estabelecimento_p,'E')
into STRICT cd_moeda_empresa_w
;
if (coalesce(cd_moeda_estrang_w::text, '') = '') then
	cd_moeda_estrang_w := cd_moeda_empresa_w;
end if;

/* Obter a conta de Saldo */

begin
	select	cd_conta_financ_saldo,
		cd_conta_financ_sant,
		ie_saldo_anterior,
		ie_saldo_passado,
		ie_passado_real,
		coalesce(ie_saldo_realizar_zerado,'N'),
		coalesce(ie_fluxo_diario,'S'),
		coalesce(cd_conta_financ_cre,1),
		coalesce(ie_adiant_receb,'A'),
		coalesce(ie_tit_rec_canc, 'N'),
		coalesce(ie_movto_bco_pend,'N'),
		coalesce(ie_data_tit_adiant_rec,'N'),
		coalesce(ie_titulo_caixa,'S'),
		coalesce(ie_tit_pagar_transf,'S'),
		coalesce(ie_trans_fin_conta,'M')
	into STRICT 	cd_conta_saldo_w,
		cd_conta_saldo_ant_w,
		ie_saldo_anterior_w,
		ie_saldo_passado_w,
		ie_passado_real_param_w,
		ie_saldo_realizar_zerado_w,
		ie_fluxo_diario_w,
		cd_conta_financ_cre_w,
		ie_adiant_receb_w,
		ie_tit_rec_canc_w,
		ie_movto_bco_pend_w,
		ie_data_tit_adiant_rec_w,
		ie_titulo_caixa_w,
		ie_tit_pagar_transf_w,
		ie_trans_fin_conta_w
	from 	Parametro_Fluxo_caixa
	where	cd_estabelecimento	= cd_estabelecimento_p;
exception when no_data_found then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(190200);
end;

if (coalesce(cd_conta_saldo_w::text, '') = '') or (coalesce(cd_conta_saldo_ant_w::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(176725,null); /* Não existem contas de saldo nos parametros do Fluxo */
end if;

begin
select	max(b.dt_referencia)
into STRICT	dt_saldo_atual_w
from	fluxo_caixa_lote a,
	fluxo_caixa_item b
where	a.nr_sequencia		= b.nr_seq_lote_fluxo
and	a.cd_empresa		= cd_empresa_p
and	a.ie_classif_fluxo		= ie_classif_p
and	b.dt_referencia		< dt_inicio_dia_w
and	coalesce(b.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
and	b.cd_conta_financ		= cd_conta_saldo_w;
exception
when	others then
	dt_saldo_atual_w		:= dt_inicio_w;
end;

begin
select	max(b.dt_referencia)
into STRICT	dt_saldo_anterior_w
from	fluxo_caixa_lote a,
	fluxo_caixa_item b
where	a.nr_sequencia		= b.nr_seq_lote_fluxo
and	a.ie_classif_fluxo		= ie_classif_p
and	a.cd_empresa		= cd_empresa_p
and	b.dt_referencia		<= dt_inicio_fim_dia_w
and	coalesce(b.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
and	b.cd_conta_financ		= cd_conta_saldo_ant_w;
exception
when	others then
	dt_saldo_Anterior_w	:= dt_inicio_w;
end;

/* Obter o saldo anterior do fluxo */

vl_saldo_w		:= 0;

if (coalesce(ie_passado_real_p,'N') = 'S') and (coalesce(ie_passado_real_param_w,'N') = 'S') then
	begin
	
	select	max(b.dt_referencia)
	into STRICT	dt_saldo_w
	from	fluxo_caixa_lote a,
		fluxo_caixa_item b
	where	a.nr_sequencia		= b.nr_seq_lote_fluxo
	and	a.cd_empresa		= cd_empresa_p
	and	a.ie_classif_fluxo		= 'P'
	and	b.dt_referencia		= dt_inicio_fim_dia_w
	and	coalesce(b.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
	and	b.cd_conta_financ		= cd_conta_saldo_w;
	
	dt_saldo_dia_w	:= PKG_DATE_UTILS.start_of(dt_saldo_w,'dd',0);

	/* se a data selecionada for no início do dia */

	if (dt_saldo_w	= dt_saldo_dia_w) then
		
		select	b.vl_fluxo
		into STRICT	vl_saldo_ant_w
		from	fluxo_caixa_lote a,
			fluxo_caixa_item b
		where	a.nr_sequencia		= b.nr_seq_lote_fluxo
		and	a.cd_empresa		= cd_empresa_p
		and	a.ie_classif_fluxo		= 'P'
		and	b.dt_referencia		= dt_saldo_w
		and	coalesce(b.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
		and	b.cd_conta_financ		= cd_conta_saldo_w;

	end if;

	exception
	when	others then
		dt_saldo_atual_w	:= dt_inicio_w;
	end;

	vl_saldo_anterior_w		:= coalesce(vl_saldo_ant_w,0);

elsif (ie_saldo_anterior_w <> 'VI') then

	vl_saldo_banco_w	:= 0;
	dt_inicio_fim_dia_ant_w	:= fim_dia(dt_inicio_w - 1);

	select	coalesce(sum(vl_saldo_banco),0),
		coalesce(sum(vl_saldo_banco_estrang),0)
	into STRICT	vl_saldo_banco_w,
		vl_saldo_banco_estrang_w
	from	(SELECT	coalesce(obter_saldo_banco_diario(b.nr_sequencia, dt_inicio_fim_dia_ant_w),0) vl_saldo_banco,
			coalesce(obter_saldo_banco_diario_estr(b.nr_sequencia, dt_inicio_fim_dia_ant_w),0) vl_saldo_banco_estrang
		from	estabelecimento c,
			banco_saldo b,
			banco_estabelecimento a
		where	substr(obter_se_filtro_fluxo(a.nr_sequencia,null,null,nm_usuario_p,null),1,255) = 'S'
		and (a.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
		and	c.cd_empresa		= cd_empresa_p
		and	a.cd_estabelecimento	= c.cd_estabelecimento
		and	b.nr_seq_conta		= a.nr_sequencia
		and	coalesce(b.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
		and	a.ie_tipo_relacao		in ('C', 'ECC')
		and	a.ie_fluxo_caixa		= 'S'
		and	a.ie_situacao		= 'A'
		and	b.dt_referencia		=
			(select	max(dt_referencia)
			from	banco_saldo x
			where	x.nr_seq_conta	= b.nr_seq_conta
			and	x.dt_referencia	<= dt_inicio_fim_dia_w)) alias16
	where (coalesce(ie_saldo_anterior_w,'X') <> 'CBC' or vl_saldo_banco > 0);
	
	select	count(*)
	into STRICT	qt_reg_w
	from	transacao_financeira a,
		movto_trans_financ b
	where	a.nr_sequencia		= b.nr_seq_trans_financ
	and	(b.nr_seq_saldo_banco IS NOT NULL AND b.nr_seq_saldo_banco::text <> '')
	and	a.ie_saldo_fluxo	= 'S';	
	
	vl_saldo_caixa_w	:= 0;

	select	coalesce(sum(vl_saldo_inicial),0),
		coalesce(sum(vl_saldo_avista),0),
		coalesce(sum(vl_saldo_inicial_estr),0),
		coalesce(sum(vl_saldo_vista_estr),0)
	into STRICT	vl_saldo_caixa_w,
		vl_saldo_avista_w,
		vl_saldo_caixa_estrang_w,
		vl_saldo_vista_estrang_w
	from	(SELECT	a.vl_saldo_inicial vl_saldo_inicial,
			coalesce(a.vl_saldo_avista,a.vl_saldo) vl_saldo_avista,
			0 vl_saldo_inicial_estr,
			0 vl_saldo_vista_estr
		from	estabelecimento c,
			caixa b,
			caixa_saldo_diario a
		where	substr(obter_se_filtro_fluxo(null,null,null,nm_usuario_p,b.nr_sequencia),1,255) = 'S'
		and (b.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
		and	c.cd_empresa		= cd_empresa_p
		and	b.cd_estabelecimento	= c.cd_estabelecimento
		and	a.nr_seq_caixa		= b.nr_sequencia
		and	cd_moeda_empresa_w	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros em moeda nacional
		and	b.ie_situacao		= 'A'
		and	b.ie_fluxo 		= 'S'
		and	a.dt_saldo		=
			(select	max(dt_saldo)
			from	caixa_saldo_diario x
			where	x.nr_seq_caixa	= a.nr_seq_caixa
			and	x.dt_saldo	<= dt_inicio_fim_dia_w)
		and	a.dt_saldo		between dt_inicio_dia_w and dt_inicio_fim_dia_w
		
union all

		SELECT	a.vl_saldo vl_saldo_inicial,
			coalesce(a.vl_saldo_avista,a.vl_saldo) vl_saldo_avista,
			0 vl_saldo_inicial_estr,
			0 vl_saldo_vista_estr
		from	estabelecimento c,
			caixa b,
			caixa_saldo_diario a
		where	substr(obter_se_filtro_fluxo(null,null,null,nm_usuario_p,b.nr_sequencia),1,255) = 'S'
		and (b.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
		and	c.cd_empresa		= cd_empresa_p
		and	b.cd_estabelecimento	= c.cd_estabelecimento
		and	a.nr_seq_caixa		= b.nr_sequencia
		and	cd_moeda_empresa_w	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros em moeda nacional
		and	b.ie_situacao		= 'A'
		and	b.ie_fluxo 		= 'S'
		and	a.dt_saldo		=
			(select	max(dt_saldo)
			from	caixa_saldo_diario x
			where	x.nr_seq_caixa	= a.nr_seq_caixa
			and	x.dt_saldo	<= dt_inicio_fim_dia_w)
		and (a.dt_saldo < dt_inicio_dia_w or a.dt_saldo > dt_inicio_fim_dia_w)
		
union all

		select	0 vl_saldo_inicial,
			0 vl_saldo_avista,
			e.vl_saldo_inicial vl_saldo_inicial_estr,
			coalesce(e.vl_saldo_avista,e.vl_saldo) vl_saldo_vista_estr
		from	estabelecimento c,
			caixa b,
			caixa_saldo_diario a,
			caixa_saldo_estrang e
		where	substr(obter_se_filtro_fluxo(null,null,null,nm_usuario_p,b.nr_sequencia),1,255) = 'S'
		and (b.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
		and	c.cd_empresa		= cd_empresa_p
		and	b.cd_estabelecimento	= c.cd_estabelecimento
		and	a.nr_seq_caixa		= b.nr_sequencia
		and	e.nr_seq_caixa_saldo	= a.nr_sequencia
		and	coalesce(e.cd_moeda,cd_moeda_empresa_w)	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
		and	b.ie_situacao		= 'A'
		and	b.ie_fluxo 		= 'S'
		and	a.dt_saldo		=
			(select	max(dt_saldo)
			from	caixa_saldo_diario x
			where	x.nr_seq_caixa	= a.nr_seq_caixa
			and	x.dt_saldo	<= dt_inicio_fim_dia_w)
		and	a.dt_saldo		between dt_inicio_dia_w and dt_inicio_fim_dia_w
		
union all

		select	0 vl_saldo_inicial,
			0 vl_saldo_avista,
			e.vl_saldo_inicial vl_saldo_inicial_estr,
			coalesce(e.vl_saldo_avista,e.vl_saldo) vl_saldo_vista_estr
		from	estabelecimento c,
			caixa b,
			caixa_saldo_diario a,
			caixa_saldo_estrang e
		where	substr(obter_se_filtro_fluxo(null,null,null,nm_usuario_p,b.nr_sequencia),1,255) = 'S'
		and (b.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
		and	c.cd_empresa		= cd_empresa_p
		and	b.cd_estabelecimento	= c.cd_estabelecimento
		and	a.nr_seq_caixa		= b.nr_sequencia
		and	e.nr_seq_caixa_saldo	= a.nr_sequencia
		and	coalesce(e.cd_moeda,cd_moeda_empresa_w)	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
		and	b.ie_situacao		= 'A'
		and	b.ie_fluxo 		= 'S'
		and	a.dt_saldo		=
			(select	max(dt_saldo)
			from	caixa_saldo_diario x
			where	x.nr_seq_caixa	= a.nr_seq_caixa
			and	x.dt_saldo	<= dt_inicio_fim_dia_w)
		and (a.dt_saldo < dt_inicio_dia_w or a.dt_saldo > dt_inicio_fim_dia_w)) alias40
	where (coalesce(ie_saldo_anterior_w,'X') <> 'CBC' or vl_saldo_inicial > 0 or vl_saldo_inicial_estr > 0);
	
	select	count(*)
	into STRICT	qt_reg_lote_w
	from	fluxo_caixa_lote
	where	dt_mesano_referencia		< dt_inicio_mes_w;
	
	if (qt_reg_lote_w > 0) then
		select	sum(b.vl_fluxo)
		into STRICT	vl_lote_fluxo_w
		from	fluxo_caixa_lote a,
			fluxo_caixa_item b
		where	a.nr_sequencia		= b.nr_seq_lote_fluxo
		and	a.cd_empresa		= cd_empresa_p
		and	a.ie_classif_fluxo		= ie_classif_p
		and	coalesce(b.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
		and	PKG_DATE_UTILS.start_of(b.dt_referencia, 'dd', 0)= fim_mes(PKG_DATE_UTILS.ADD_MONTH(dt_inicio_mes_w,-1,0))
		and	b.cd_conta_financ		= cd_conta_saldo_w;
	end if;

	select	sum(coalesce(a.vl_saldo,0))
	into STRICT	vl_inicio_projeto_w
	from	projeto_recurso_saldo a
	where	a.nr_seq_projeto in (SELECT	b.nr_seq_proj_rec
		from	w_filtro_fluxo b
		where	b.nm_usuario	= nm_usuario_p)
	and	cd_moeda_empresa_w	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros em moeda nacional
	and	a.dt_mesano_referencia	between dt_inicio_mes_w and dt_final_mes_w;
	
	if (ie_saldo_anterior_w = 'TC') then
		vl_saldo_anterior_w	:= vl_saldo_caixa_w + vl_saldo_banco_w;
		if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
			vl_saldo_ant_estrang_w	:= coalesce(vl_saldo_caixa_estrang_w,0) + vl_saldo_banco_estrang_w;
		end if;
	elsif (ie_saldo_anterior_w = 'T') then
		vl_saldo_anterior_w		:= vl_saldo_caixa_w;
		if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
			vl_saldo_ant_estrang_w	:= coalesce(vl_saldo_caixa_estrang_w,0);
		end if;
	elsif (ie_saldo_anterior_w = 'C') then
		vl_saldo_anterior_w		:= vl_saldo_banco_w;
		if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
			vl_saldo_ant_estrang_w	:= vl_saldo_banco_estrang_w;
		end if;
	elsif (ie_saldo_anterior_w = 'VC') then
		vl_saldo_anterior_w		:= vl_saldo_avista_w + vl_saldo_banco_w;
		if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
			vl_saldo_ant_estrang_w	:= coalesce(vl_saldo_vista_estrang_w,0) + vl_saldo_banco_estrang_w;
		end if;
	elsif (ie_saldo_anterior_w = 'V') then
		vl_saldo_anterior_w		:= vl_saldo_avista_w;
		if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
			vl_saldo_ant_estrang_w	:= coalesce(vl_saldo_vista_estrang_w,0);
		end if;
	elsif (ie_saldo_anterior_w = 'PR') then
		vl_saldo_anterior_w 	:= vl_inicio_projeto_w;
		if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
			vl_saldo_ant_estrang_w	:= 0;
		end if;
	elsif (ie_saldo_anterior_w = 'TCC') then

		select	sum(a.vl_cheque),
			sum(a.vl_cheque_estrang)
		into STRICT	vl_cheque_w,
			vl_cheque_estrang_w
		from	cheque a
		where	coalesce(a.dt_cancelamento::text, '') = ''
		and (coalesce(a.dt_compensacao::text, '') = '' or a.dt_compensacao >= dt_inicio_dia_w)
		and	a.dt_emissao		< dt_inicio_dia_w
		and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
		and (coalesce(a.cd_estabelecimento,cd_estabelecimento_p)	= cd_estabelecimento_p or ie_restringe_estab_p = 'N')
		and	substr(obter_empresa_estab(a.cd_estabelecimento),1,15) = cd_empresa_p;

		vl_saldo_anterior_w		:= coalesce(vl_saldo_caixa_w,0) + coalesce(vl_saldo_banco_w,0) - coalesce(vl_cheque_w,0);
		if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
			vl_saldo_ant_estrang_w	:= coalesce(vl_saldo_caixa_estrang_w,0) + coalesce(vl_saldo_banco_estrang_w,0) - coalesce(vl_cheque_estrang_w,0);
		end if;
	elsif (ie_saldo_anterior_w = 'L') then
		vl_saldo_anterior_w		:= vl_lote_fluxo_w;
		if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
			vl_saldo_ant_estrang_w	:= vl_lote_fluxo_w;
		end if;
	end if;
else
	vl_saldo_anterior_w		:= coalesce(vl_saldo_anterior_p,0);
	if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
		vl_saldo_ant_estrang_w	:= coalesce(vl_saldo_anterior_p,0);
	end if;
end if;

if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) = cd_moeda_empresa_w) then
	vl_saldo_fluxo_w	:= vl_saldo_anterior_w;
else
	vl_saldo_fluxo_w	:= vl_saldo_ant_estrang_w;
end if;

if (ie_saldo_realizar_zerado_w = 'S') and (ie_classif_p = 'R') and (dt_inicio_w < PKG_DATE_UTILS.start_of(clock_timestamp(),'dd',0)) then

	dt_inicio_calculo_w	:= dt_inicio_w;
	vl_saldo_fluxo_w	:= 0;

elsif (ie_classif_p = 'R') or (coalesce(vl_saldo_anterior_w,0) <> 0) then

	dt_inicio_calculo_w	:= dt_inicio_w;
	vl_saldo_fluxo_w	:= coalesce(vl_saldo_anterior_w,0);
	if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
		vl_saldo_fluxo_w := coalesce(vl_saldo_ant_estrang_w,0);
	end if;

elsif (dt_saldo_atual_w <> dt_inicio_w) and (ie_saldo_anterior_w <> 'VI') and (ie_saldo_anterior_w <> 'SF') and (ie_saldo_anterior_w <> 'PR') and (ie_saldo_anterior_w <> 'C') then
	begin

	dt_inicio_calculo_w	:= dt_saldo_atual_w + 1;
	
	select	sum(b.vl_fluxo)
	into STRICT	vl_saldo_fluxo_w
	from	fluxo_caixa_lote a,
		fluxo_caixa_item b
	where	a.nr_sequencia		= b.nr_seq_lote_fluxo
	and	a.cd_empresa		= cd_empresa_p
	and	a.ie_classif_fluxo		= ie_classif_p
	and	b.cd_conta_financ		= cd_conta_saldo_w
	and	coalesce(b.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
	and	b.dt_referencia		= dt_saldo_atual_w;

	end;
elsif (dt_saldo_anterior_w <> dt_inicio_w) and (ie_saldo_anterior_w <> 'VI') and (ie_saldo_anterior_w <> 'SF') and (ie_saldo_anterior_w <> 'PR') and (ie_saldo_anterior_w <> 'C') then
	begin

	dt_inicio_calculo_w	:= dt_saldo_anterior_w;
	
	select	coalesce(max(b.vl_fluxo),0)
	into STRICT	vl_saldo_fluxo_w
	from	fluxo_caixa_lote a,
		fluxo_caixa_item b
	where	a.nr_sequencia		= b.nr_seq_lote_fluxo
	and	a.cd_empresa		= cd_empresa_p
	and	a.ie_classif_fluxo		= ie_classif_p
	and	b.cd_conta_financ		= cd_conta_saldo_ant_w
	and	coalesce(b.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
	and	b.dt_referencia		= dt_saldo_anterior_w;
	
	end;
else
	dt_inicio_calculo_w	:= dt_inicio_w;
end if;
			
CALL ACUMULA_FLUXO_CAIXA_LOTE_NIVEL(	nr_seq_lote_fluxo_p,
				cd_estabelecimento_p,
				dt_inicio_w,
				dt_final_w,
				nm_usuario_p,
				cd_empresa_p);

if (ie_saldo_passado_w = 'S') or (ie_classif_p <> 'P') then

	if (ie_fluxo_diario_w	= 'S') then
		
		select	max(b.cd_conta_financ)
		into STRICT	cd_conta_diaria_w
		from	fluxo_caixa_lote a,
			fluxo_caixa_item b,
			conta_financeira c
		where	a.nr_sequencia		= b.nr_seq_lote_fluxo
		and	b.cd_conta_financ		= c.cd_conta_financ
		and	a.cd_empresa		= cd_empresa_p
		and	a.ie_classif_fluxo		= ie_classif_p
		and	c.cd_empresa		= cd_empresa_p       -- Não pode entrar conta financeira de outra empresa
		and	c.ie_oper_fluxo		<> 'I'
		and	coalesce(c.cd_conta_superior::text, '') = ''
		and	coalesce(b.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
		and	c.cd_conta_financ		<> cd_conta_saldo_ant_w
		and	b.dt_referencia		between dt_inicio_calculo_w and dt_final_w;

		dt_atual_w			:= dt_inicio_w;
		while(dt_atual_w <= dt_final_w) and (coalesce(cd_conta_diaria_w,0) > 0) loop
			
			select	max(b.cd_conta_financ)
			into STRICT	cd_conta_financ_w
			from	fluxo_caixa_lote a,
				fluxo_caixa_item b,
				conta_financeira c
			where	a.nr_sequencia		= b.nr_seq_lote_fluxo
			and	b.cd_conta_financ		= c.cd_conta_financ
			and	a.cd_empresa		= cd_empresa_p
			and	a.ie_classif_fluxo		= ie_classif_p
			and	c.cd_empresa		= cd_empresa_p       -- Não pode entrar conta financeira de outra empresa
			and	c.ie_oper_fluxo		<> 'I'
			and	coalesce(c.cd_conta_superior::text, '') = ''
			and	coalesce(b.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
			and	c.cd_conta_financ		<> cd_conta_saldo_ant_w
			and	b.dt_referencia		= dt_atual_w;		

			if (coalesce(cd_conta_financ_w, 0) 	= 0) then
			
				CALL gerar_fluxo_caixa_lote(	dt_atual_w,
							cd_conta_diaria_w,
							'',
							'24-1',
							'SI',
							nm_usuario_p,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							nr_seq_lote_fluxo_p,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							0);
			end if;	
			dt_atual_w	:= dt_atual_w + 1;
		end loop;
	end if;

	open	c020;
	loop
	fetch	c020 into
		dt_referencia_w,
		vl_fluxo_w;
	EXIT WHEN NOT FOUND; /* apply on c020 */
       	begin
		
		dt_referencia_ini_w	:= PKG_DATE_UTILS.start_of(dt_referencia_w,'dd',0);		
		
		if (qt_reg_w > 0) then

			select	coalesce(sum(CASE WHEN coalesce(e.ie_emprestimo,'N')='D' THEN coalesce(d.vl_transacao,0) * -1  ELSE coalesce(d.vl_transacao,0) END ),0),
				coalesce(sum(CASE WHEN coalesce(e.ie_emprestimo,'N')='D' THEN coalesce(d.vl_transacao_estrang,0) * -1  ELSE coalesce(d.vl_transacao_estrang,0) END ),0)
			into STRICT	vl_regra_saldo_banco_w,
				vl_regra_saldo_estrang_w
			from	transacao_financeira e,
				movto_trans_financ d,
				estabelecimento c,
				banco_saldo b,
				banco_estabelecimento a
			where	substr(obter_se_filtro_fluxo(a.nr_sequencia,null,null,nm_usuario_p,null),1,255) = 'S'
			and (a.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_p = 'N')
			and	c.cd_empresa		= cd_empresa_p
			and	a.cd_estabelecimento	= c.cd_estabelecimento
			and	b.nr_seq_conta		= a.nr_sequencia
			and	d.nr_seq_saldo_banco	= b.nr_sequencia
			and	d.nr_seq_trans_financ	= e.nr_sequencia
			and	coalesce(d.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
			and	a.ie_tipo_relacao		in ('C', 'ECC')
			and	a.ie_fluxo_caixa		= 'S'
			and	a.ie_situacao		= 'A'
			and	e.ie_saldo_fluxo		= 'S'
			and	d.dt_transacao		<= dt_referencia_ini_w;

		end if;		
		
		vl_fluxo_item_lote_w	:= coalesce(vl_saldo_fluxo_w, 0) + coalesce(vl_regra_saldo_banco_w,0);
		if (coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w) then
			vl_fluxo_item_lote_w := coalesce(vl_saldo_fluxo_w, 0) + coalesce(vl_regra_saldo_estrang_w,0);
		end if;
		
		/* Saldo Anterior */
		
		CALL gerar_fluxo_caixa_lote(	dt_referencia_w,
					cd_conta_saldo_ant_w,
					'',
					'24-2',
					'SI',
					nm_usuario_p,
					null,
					null,
					null,
					null,
					null,
					null,
					null,
					null,
					nr_seq_lote_fluxo_p,
					null,
					null,
					null,
					null,
					null,
					null,
					null,
					vl_fluxo_item_lote_w);
		
		vl_saldo_fluxo_w := vl_saldo_fluxo_w + vl_fluxo_w;

		/* Saldo Atual */
		
		CALL gerar_fluxo_caixa_lote(	dt_referencia_w,
					cd_conta_saldo_w,
					'',
					'24-3',
					'SI',
					nm_usuario_p,
					null,
					null,
					null,
					null,
					null,
					null,
					null,
					null,
					nr_seq_lote_fluxo_p,
					null,
					null,
					null,
					null,
					null,
					null,
					null,
					coalesce(vl_saldo_fluxo_w, 0));
	end;
	end loop;
	close c020;
	
	open	c030;
	loop
	fetch	c030 into
		cd_conta_financ_acum_w,
		ie_integracao_w,
		ie_identificacao_w;
	EXIT WHEN NOT FOUND; /* apply on C030 */
		Begin
		vl_saldo_fluxo_acum_w	:= 0;
		dt_referencia_w		:= dt_inicio_w;
		
		while(dt_referencia_w	<= dt_final_w) loop

			begin

			dt_referencia_ini_w	:= PKG_DATE_UTILS.start_of(dt_referencia_w,'dd',0);
			dt_referencia_fim_w	:= fim_dia(dt_referencia_w);

			select 	sum(coalesce(b.vl_fluxo,0))
			into STRICT	vl_fluxo_w
			from	fluxo_caixa_lote a,
				fluxo_caixa_item b,
				conta_financeira c
			where	a.nr_sequencia			= b.nr_seq_lote_fluxo
			and	b.cd_conta_financ			= c.cd_conta_financ
			and	a.ie_classif_fluxo			= ie_classif_p
			and	a.cd_empresa			= cd_empresa_p
			and	c.cd_empresa		= cd_empresa_p       -- Não pode entrar conta financeira de outra empresa
			and 	coalesce(c.ie_acumular,'N')		= 'S'
			and	coalesce(b.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
			and	b.dt_referencia			between dt_referencia_ini_w and dt_referencia_fim_w
			and	b.cd_conta_financ			= cd_conta_financ_acum_w
			and (c.cd_estabelecimento		= cd_estabelecimento_p or ie_restringe_estab_p = 'N')
			and 	((a.ie_situacao_fluxo_data = 'T') or (a.ie_situacao_fluxo_data = c.ie_situacao))
			order by c.cd_conta_financ;

			if (cd_conta_financ_acum_w <> cd_conta_financ_ant_w) then
				vl_saldo_fluxo_acum_w	:= 0;
			end if;
			
			if (ie_integracao_w = 'CR') then
				select	obter_vl_recurso_baixado(nm_usuario_p,cd_estabelecimento_p,cd_empresa_p,ie_restringe_estab_p,cd_conta_financ_cre_w,ie_tit_rec_canc_w,
						ie_data_tit_adiant_rec_w,dt_referencia_w,ie_movto_bco_pend_w,ie_adiant_receb_w,ie_titulo_caixa_w,ie_trans_fin_conta_w,ie_tit_pagar_transf_w,
						cd_conta_financ_acum_w)
				into STRICT	vl_rec_baixado_w
				
				where	cd_moeda_empresa_w	= coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w);  --Projeto Multimoeda - Busca apenas os registros em moeda nacional
			end if;
			
			vl_saldo_fluxo_acum_w	:= vl_saldo_fluxo_acum_w + coalesce(vl_fluxo_w,0) - coalesce(vl_rec_baixado_w,0);		

			CALL GERAR_FLUXO_CAIXA_LOTE(	dt_referencia_w,
				cd_conta_financ_acum_w,
				'',
				ie_identificacao_w,
				ie_integracao_w,
				nm_usuario_p,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				nr_seq_lote_fluxo_p,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				coalesce(vl_saldo_fluxo_acum_w, 0));
				
			cd_conta_financ_ant_w	:= cd_conta_financ_acum_w;
			end;

		dt_referencia_w	:= dt_referencia_w + 1;
		end loop;
		end;
	end loop;
	close c030;
	
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_fluxo_caixa_lote ( nr_seq_lote_fluxo_p bigint, cd_estabelecimento_p bigint, vl_saldo_anterior_p bigint, dt_inicio_p timestamp, dt_final_p timestamp, ie_classif_p text, nm_usuario_p text, cd_empresa_p bigint, ie_restringe_estab_p text, ie_passado_real_p text) FROM PUBLIC;

