-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE integra_grupo_mat_protheus ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_cadastro_w		varchar(20);
ds_cadastro_w		varchar(80);
qt_existe_w		bigint;
cd_grupo_material_w	smallint;
cd_subgrupo_material_w	smallint;
nr_conta_w		varchar(20);
cd_conta_contabil_w	varchar(20);
ie_operacao_w		varchar(15);
cd_classe_material_w	bigint;
cd_classe_material_ww	bigint;
ie_erro_w		varchar(1) := 'N';


BEGIN

select	cd_cadastro,
	ds_cadastro,
	nr_conta,
	ie_operacao
into STRICT	cd_cadastro_w,
	ds_cadastro_w,
	nr_conta_w,
	ie_operacao_w
from	w_protheus_cadastro
where	nr_sequencia = nr_sequencia_p
and	tp_cadastro = 'GR';

if (coalesce(cd_cadastro_w::text, '') = '') then
	CALL gravar_log_protheus('ERRO', 'GR', WHEB_MENSAGEM_PCK.get_texto(309916) , nm_usuario_p); --O código do grupo de material recebida do Protheus está vazio.
	ie_erro_w := 'S';
end if;

if (coalesce(ds_cadastro_w::text, '') = '') then
	CALL gravar_log_protheus('ERRO', 'GR', WHEB_MENSAGEM_PCK.get_texto(309917) , nm_usuario_p); --A descrição do grupo de material recebida do Protheus está vazia.
	ie_erro_w := 'S';
end if;

select	coalesce(max(cd_classe_material),0)
into STRICT	cd_classe_material_ww
from	classe_material
where	cd_sistema_ant = cd_cadastro_w;


if (ie_erro_w = 'N') and (ie_operacao_w in ('I','A')) and (cd_cadastro_w IS NOT NULL AND cd_cadastro_w::text <> '') and (ds_cadastro_w IS NOT NULL AND ds_cadastro_w::text <> '') then

	select	coalesce(max(cd_conta_contabil),'')
	into STRICT	cd_conta_contabil_w
	from	conta_contabil
	where	cd_conta_contabil = nr_conta_w;


	if (cd_classe_material_ww = 0) and (ie_operacao_w = 'I') then

		select	coalesce(max(cd_grupo_material),0) + 1
		into STRICT	cd_grupo_material_w
		from	grupo_material;

		insert into grupo_material(
			cd_grupo_material,
			ds_grupo_material,
			ie_situacao,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_conta_contabil)
		values (
			cd_grupo_material_w,
			substr(ds_cadastro_w,1,255),
			'A',
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_conta_contabil_w);

		select	coalesce(max(cd_subgrupo_material),0) + 1
		into STRICT	cd_subgrupo_material_w
		from	subgrupo_material;

		insert into subgrupo_material(
			cd_subgrupo_material,
			ds_subgrupo_material,
			ie_situacao,
			dt_atualizacao,
			nm_usuario,
			cd_grupo_material,
			cd_conta_contabil)
		values (
			cd_subgrupo_material_w,
			substr(ds_cadastro_w,1,255),
			'A',
			clock_timestamp(),
			nm_usuario_p,
			cd_grupo_material_w,
			cd_conta_contabil_w);

		select	coalesce(max(cd_classe_material),0) + 1
		into STRICT	cd_classe_material_w
		from	classe_material;

		insert into classe_material(
			cd_classe_material,
			ds_classe_material,
			cd_subgrupo_material,
			ie_situacao,
			dt_atualizacao,
			nm_usuario,
			cd_conta_contabil,
			cd_sistema_ant)
		values (
			cd_classe_material_w,
			substr(cd_cadastro_w || ' - ' || ds_cadastro_w,1,255),
			cd_subgrupo_material_w,
			'A',
			clock_timestamp(),
			nm_usuario_p,
			cd_conta_contabil_w,
			cd_cadastro_w);
	end if;

	if (cd_classe_material_ww > 0) and (ie_operacao_w = 'A') then

		update	classe_material
		set	ie_situacao 		= 'A',
			ds_classe_material	= substr(cd_cadastro_w || ' - ' || ds_cadastro_w,1,255),
			cd_conta_contabil	= cd_conta_contabil_w,
			dt_atualizacao = clock_timestamp(),
			nm_usuario = nm_usuario_p
		where	cd_classe_material	= cd_classe_material_ww;

		update	subgrupo_material
		set	ie_situacao		= 'A',
			ds_subgrupo_material	= substr(ds_cadastro_w,1,255),
			cd_conta_contabil	= cd_conta_contabil_w,
			dt_atualizacao = clock_timestamp(),
			nm_usuario = nm_usuario_p
		where	cd_subgrupo_material in (
			SELECT	cd_subgrupo_material
			from	classe_material
			where	cd_classe_material	= cd_classe_material_ww);

		update	grupo_material
		set	ie_situacao 		= 'A',
			ds_grupo_material	= substr(ds_cadastro_w,1,255),
			cd_conta_contabil	= cd_conta_contabil_w,
			dt_atualizacao = clock_timestamp(),
			nm_usuario = nm_usuario_p
		where	cd_grupo_material in (
			SELECT	cd_grupo_material
			from	subgrupo_material
			where	cd_subgrupo_material in (
				SELECT	cd_subgrupo_material
				from	classe_material
				where	cd_classe_material	= cd_classe_material_ww));

	end if;

elsif (ie_erro_w = 'N') and (ie_operacao_w = 'E') then

	update	classe_material
	set	ie_situacao = 'I',
		dt_atualizacao = clock_timestamp(),
		nm_usuario = nm_usuario_p
	where	cd_sistema_ant = cd_cadastro_w;

	update	subgrupo_material
	set	ie_situacao = 'I',
		dt_atualizacao = clock_timestamp(),
		nm_usuario = nm_usuario_p
	where	cd_subgrupo_material in (
		SELECT	cd_subgrupo_material
		from	classe_material
		where	cd_sistema_ant = cd_cadastro_w);

	update	grupo_material
	set	ie_situacao = 'I',
		dt_atualizacao = clock_timestamp(),
		nm_usuario = nm_usuario_p
	where	cd_grupo_material in (
		SELECT	cd_grupo_material
		from	subgrupo_material
		where	cd_subgrupo_material in (
			SELECT	cd_subgrupo_material
			from	classe_material
			where	cd_sistema_ant = cd_cadastro_w));


end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE integra_grupo_mat_protheus ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

