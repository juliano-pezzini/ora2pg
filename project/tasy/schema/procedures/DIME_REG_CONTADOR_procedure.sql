-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dime_reg_contador ( nr_seq_controle_p bigint, cd_estabelecimento_p text, nm_usuario_p text, dt_referencia_p timestamp, ds_separador_p text, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) AS $body$
DECLARE

 
cd_empresa_w		smallint;
ds_arquivo_w		varchar(4000);
ds_linha_w		varchar(4000);
ds_quadro_w		varchar(2);
nm_contador_w		varchar(50);
nr_cpf_contador_w		varchar(11);
nr_linha_w		bigint 	:= qt_linha_p;
nr_seq_registro_w		bigint 	:= nr_sequencia_p;
separador_w		varchar(1) 	:= ds_separador_p;
tp_registro_w		varchar(2);
dt_geracao_w		varchar(20);

BEGIN
 
select	cd_empresa 
into STRICT	cd_empresa_w 
from	estabelecimento 
where	cd_estabelecimento = cd_estabelecimento_p;
 
select	'20' tp_registro, 
	' ' ds_quadro, 
	substr(obter_dados_pf(cd_contabilista,'CPF'),1,11) nr_cpf_contador, 
	rpad(obter_nome_pf(cd_contabilista),50,' ') nm_contador, 
	to_char(clock_timestamp(),'yyyymmddhh24miss') dt_geracao 
into STRICT	tp_registro_w, 
	ds_quadro_w, 
	nr_cpf_contador_w, 
	nm_contador_w, 
	dt_geracao_w 
from 	empresa 
where	cd_empresa = cd_empresa_w;
 
ds_linha_w	:= 	tp_registro_w 	|| separador_w || -- campo 01 - tp_registro 
			ds_quadro_w			|| separador_w || -- campo 02 - ds_quadro 
			nr_cpf_contador_w	|| separador_w || -- campo 03 - nr_cpf_contador 
			nm_contador_w		|| separador_w || 
			dt_geracao_w		|| separador_w;  -- campo 04 - nm_contador 
ds_arquivo_w 		:= substr(ds_linha_w,1,4000);
nr_seq_registro_w 		:= nr_seq_registro_w + 1;
nr_linha_w 		:= nr_linha_w + 1;
 
-- insert na tabela do DIME 
insert into w_dime_arquivo(	nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			nr_seq_controle_dime, 
			nr_linha, 
			cd_registro, 
			ds_arquivo) 
	values (	nextval('w_dime_arquivo_seq'), 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			nr_seq_controle_p, 
			nr_linha_w, 
			tp_registro_w, 
			ds_arquivo_w);
 
commit;
 
qt_linha_p 		:= nr_linha_w;
nr_sequencia_p 	:= nr_seq_registro_w;
 
SELECT * FROM dime_reg_dados_iniciais(nr_seq_controle_p, cd_estabelecimento_p, nm_usuario_p, dt_referencia_p, separador_w, qt_linha_p, nr_sequencia_p) INTO STRICT qt_linha_p, nr_sequencia_p;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dime_reg_contador ( nr_seq_controle_p bigint, cd_estabelecimento_p text, nm_usuario_p text, dt_referencia_p timestamp, ds_separador_p text, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) FROM PUBLIC;

