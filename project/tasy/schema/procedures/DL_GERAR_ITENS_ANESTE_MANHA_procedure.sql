-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dl_gerar_itens_aneste_manha ( nr_seq_distribuicao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, vl_distribuicao_p bigint) AS $body$
DECLARE

 
nr_seq_socio_w			bigint;
nr_seq_lote_w			bigint;	
nr_seq_tipo_distrib_w		bigint;
nr_seq_distrib_item_w		bigint;	
dia_w				bigint;
dia_anterior_w			bigint;
qt_rotinas_manha_w		bigint;		
qt_max_minutos_w		bigint;
qt_dias_trab_mes_w		bigint;
qt_dias_trab_mes_socio_w	bigint;	
qt_min_cirurgia_w		double precision;
vl_distribuicao_w		double precision;
vl_unitario_anestesia_w		double precision;
vl_pagar_socio_w		double precision;
vl_caixa_anestesias_manha_w	double precision;
vl_dia_manha_w			double precision;
tx_criterio_w			double precision;
cd_pessoa_fisica_w		varchar(10);
cd_pessoa_fisica_socio_w	varchar(10);
-- ie_plantao_w			varchar2(1); 
dt_mesano_lote_w		timestamp;
dt_inicial_lote_w		timestamp;
dt_final_lote_w			timestamp;
dt_entrada_w			timestamp;
dt_saida_w			timestamp;
dt_hora_inicial_w		timestamp;
dt_hora_final_w			timestamp;
dt_inicio_mat_w			timestamp;
dt_termino_mat_w		timestamp;
dt_calc_inicio_w		timestamp;
dt_calc_termino_w		timestamp;
ds_msg_tp_distrib_w		varchar(255);
			
C01 CURSOR FOR 
	SELECT	a.dt_entrada, 
		a.dt_saida, 
		a.cd_pessoa_fisica, 
		(to_char(a.dt_entrada,'dd'))::numeric  
	from	dl_socio b, 
		funcao_medico d, 
		cirurgia c,	 
		cirurgia_participante a 
	where	a.cd_pessoa_fisica		= b.cd_pessoa_fisica 
	-- and	trunc(a.dt_entrada, 'month')	= trunc(dt_mesano_lote_w, 'month') 	 
	and	((trunc(a.dt_entrada,'dd') >= trunc(dt_inicial_lote_w,'dd')) and (trunc(a.dt_saida,'dd') <= trunc(dt_final_lote_w,'dd'))) -- afstringari 232919 30/07/2010		 
	and	dl_obter_dados_socio(b.nr_sequencia,'T') = 'A' 
	and	c.nr_cirurgia			= a.nr_cirurgia 
	and	a.ie_funcao			= d.cd_funcao 
	and	d.ie_anestesista			= 'S' 
	and	c.cd_estabelecimento		= cd_estabelecimento_p 
	order by 
		to_char(a.dt_entrada,'dd');
			

BEGIN 
 
select	a.nr_seq_socio, 
	a.nr_seq_lote 
into STRICT	nr_seq_socio_w, 
	nr_seq_lote_w 
from 	dl_distribuicao a 
where	a.nr_sequencia	= nr_seq_distribuicao_p;
 
if (dl_obter_dados_socio(nr_seq_socio_w,'T') = 'A') then 
 
	dia_w				:= 0;
	dia_anterior_w			:= 0;
	qt_rotinas_manha_w		:= 0;
	qt_max_minutos_w		:= 0;
	qt_dias_trab_mes_w		:= 0;
	qt_dias_trab_mes_socio_w	:= 0;
	qt_min_cirurgia_w		:= 0;
	vl_distribuicao_w		:= 0;
	vl_unitario_anestesia_w		:= 0;
	vl_pagar_socio_w		:= 0;
	vl_caixa_anestesias_manha_w	:= 0;
	vl_dia_manha_w			:= 0;
	tx_criterio_w			:= 0;
 
	select	substr(dl_obter_dados_socio(nr_seq_socio_w, 'PF'),1,255) 
	into STRICT	cd_pessoa_fisica_socio_w 
	;
 
	select	coalesce(coalesce(vl_distribuicao_p,a.vl_distribuicao),0), 
		a.dt_mesano_ref, 
		a.dt_inicial, 
		a.dt_final		 
	into STRICT	vl_distribuicao_w, 
		dt_mesano_lote_w, 
		dt_inicial_lote_w, 
		dt_final_lote_w 
	from	dl_lote_distribuicao a 
	where	a.nr_sequencia	= nr_seq_lote_w;
 
	/* dominio DL - Tipo de item para calculo da distribuicao / Anestesias da manha */
 
	select	max(a.nr_sequencia), 
		max(coalesce(a.tx_item,0)), 
		max(coalesce(a.qt_max_minutos,0)), 
		max(a.dt_hora_inicial), 
		max(a.dt_hora_final) 
	into STRICT	nr_seq_tipo_distrib_w, 
		tx_criterio_w, 
		qt_max_minutos_w, 
		dt_hora_inicial_w, 
		dt_hora_final_w 
	from	dl_tipo_item a 
	where	a.ie_tipo_item		= 6 
	and	a.nr_seq_socio		= nr_seq_socio_w 
	and	a.cd_estabelecimento	= cd_estabelecimento_p;
		 
	if (coalesce(nr_seq_tipo_distrib_w::text, '') = '') then 
		select	max(a.nr_sequencia), 
			max(coalesce(a.tx_item,0)), 
			max(coalesce(a.qt_max_minutos,0)), 
			max(a.dt_hora_inicial), 
			max(a.dt_hora_final) 
		into STRICT	nr_seq_tipo_distrib_w, 
			tx_criterio_w, 
			qt_max_minutos_w, 
			dt_hora_inicial_w, 
			dt_hora_final_w 
		from	dl_tipo_item a 
		where	a.ie_tipo_item		= 6 
		and	coalesce(a.nr_seq_socio::text, '') = '' 
		and	a.cd_estabelecimento	= cd_estabelecimento_p;
	end if;
 
	if (coalesce(nr_seq_tipo_distrib_w::text, '') = '') then -- afstringari 236244 28/07/2010 
 
		ds_msg_tp_distrib_w	:= substr(dl_obter_msg_tp_distrib(1,6),1,255);
 
		/* ds_msg_tp_distrib_w */
 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(262112,'DS_MSG_TP_DISTRIB_W='||ds_msg_tp_distrib_w);
 
	end if;	
	 
	vl_unitario_anestesia_w	:= tx_criterio_w * vl_distribuicao_w;
 
	open C01;
	loop 
	fetch C01 into	 
		dt_entrada_w, 
		dt_saida_w, 
		cd_pessoa_fisica_w, 
		dia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		 
		if (dia_w	<> dia_anterior_w) then 
			qt_dias_trab_mes_w	:= qt_dias_trab_mes_w + 1;	
					 
			if (cd_pessoa_fisica_w = cd_pessoa_fisica_socio_w) then 
				qt_dias_trab_mes_socio_w	:= qt_dias_trab_mes_socio_w + 1;
			end if;
		end if;
		dia_anterior_w	:= dia_w;	
		 
		/* fim calculo totais */
	 
		-- obter a qtd de rotinas da manha 
		dt_inicio_mat_w 	:= to_date((to_char(trunc(dt_entrada_w),'dd/mm/yyyy') || ' ' || to_char(dt_hora_inicial_w, 'hh24:mi:ss')), 'dd/mm/yyyy hh24:mi:ss');
		dt_termino_mat_w 	:= to_date((to_char(trunc(dt_saida_w),'dd/mm/yyyy') || ' ' || to_char(dt_hora_final_w, 'hh24:mi:ss')), 'dd/mm/yyyy hh24:mi:ss');	
				 
		dt_calc_inicio_w	:= dt_entrada_w;
		dt_calc_termino_w	:= dt_saida_w;
		 
		if (dt_entrada_w < dt_inicio_mat_w) then 
			dt_calc_inicio_w := dt_inicio_mat_w;
		end if;
			 
		if (dt_saida_w > dt_termino_mat_w) then 
			dt_calc_termino_w := dt_termino_mat_w;
		end if;
		qt_min_cirurgia_w	:= ((dt_calc_termino_w - dt_calc_inicio_w) * 1440);
		qt_rotinas_manha_w	:= (qt_rotinas_manha_w + ceil(qt_min_cirurgia_w / qt_max_minutos_w));
		 
		end;
	end loop;
	close C01;
 
	vl_caixa_anestesias_manha_w	:= vl_unitario_anestesia_w * qt_rotinas_manha_w;
	vl_dia_manha_w			:= dividir_sem_round(vl_caixa_anestesias_manha_w,qt_dias_trab_mes_w);
	vl_pagar_socio_w		:= vl_dia_manha_w * qt_dias_trab_mes_socio_w;
		 
	select	max(coalesce(b.nr_sequencia,0)) 
	into STRICT	nr_seq_distrib_item_w 
	from	dl_distribuicao a, 
		dl_distribuicao_item b		 
	where	a.nr_sequencia	= b.nr_seq_distribuicao 
	and	a.nr_seq_lote	= nr_seq_lote_w 
	and	a.nr_sequencia	= nr_seq_distribuicao_p 
	and	b.nr_seq_item	= nr_seq_tipo_distrib_w;
 
	if (coalesce(nr_seq_distrib_item_w::text, '') = '') and (coalesce(vl_distribuicao_p::text, '') = '') then 
		insert into dl_distribuicao_item( 
			nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			nr_seq_distribuicao, 
			nr_seq_item, 
			tx_item, 
			vl_item, 
			qt_item, 
			vl_calculado) 
		values ( nextval('dl_distribuicao_item_seq'), 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			nr_seq_distribuicao_p, 
			nr_seq_tipo_distrib_w, 
			tx_criterio_w, 
			0, 
			qt_dias_trab_mes_socio_w, 
			vl_pagar_socio_w);	
	else 
		update 	dl_distribuicao_item 
		set	dt_atualizacao		= clock_timestamp(), 
			nm_usuario		= nm_usuario_p, 
			vl_item			= vl_pagar_socio_w 
		where	nr_sequencia		= nr_seq_distrib_item_w 
		and	nr_seq_distribuicao	= nr_seq_distribuicao_p;
	end if;		
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dl_gerar_itens_aneste_manha ( nr_seq_distribuicao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, vl_distribuicao_p bigint) FROM PUBLIC;

