-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE campos AS (ds	varchar(32760));


CREATE OR REPLACE PROCEDURE intpd_criar_trigger_log_atrib ( nr_seq_evento_sistema_p intpd_eventos_sistema.nr_sequencia%type, nm_tabela_p tabela_sistema.nm_tabela%type default null) AS $body$
DECLARE


type vetor is table of  campos index by integer;

ds_script_vetor		vetor;

ie_tipo_atributo_w		tabela_atributo.ie_tipo_atributo%type;
nm_objeto_w 		varchar(50);
ie_gerar_log_w		varchar(1);
ds_script_trigger_w		text;
ds_chave_composta_proc_w	varchar(1000);
ds_aspa_w		varchar(1) := chr(39);
ds_pipe_w		varchar(2) := chr(124)||chr(124);
ds_quebra_w		varchar(3) := chr(13) || chr(10);
ds_valor_w		varchar(100);
ds_valor_old_w		varchar(100);
ds_valor_new_w		varchar(100);
ds_follows_w		varchar(1000);

ds_erro_w		varchar(4000);

c01 CURSOR FOR
	SELECT	upper(c.nm_tabela) nm_tabela,
		c.ds_shortname
	from	intpd_eventos_sistema a,
		intpd_config_evento_tab b,
		tabela_sistema c		
	where	a.nr_seq_projeto_xml = b.nr_seq_proj_xml
	and	b.nm_tabela = c.nm_tabela
	and	a.ie_situacao = 'A'
	and	a.nr_sequencia = coalesce(nr_seq_evento_sistema_p, a.nr_sequencia)
	and (coalesce(nm_tabela_p,'NULL') = 'NULL' or c.nm_tabela = nm_tabela_p)
	group by	c.nm_tabela,
		c.ds_shortname;
	
c01_w	c01%rowtype;

c02 CURSOR FOR
	SELECT	a.nm_atributo
	from	indice_atributo a,
		indice b
	where	a.nm_indice = b.nm_indice
	and	a.nm_tabela = b.nm_tabela
	and	a.nm_tabela = c01_w.nm_tabela
	and	b.ie_tipo = 'PK'
	order	by a.nr_sequencia;
	
c02_w	c02%rowtype;
	
c03 CURSOR FOR
	SELECT	a.nm_atributo,
		a.ie_tipo_atributo	
	from	tabela_atributo a
	where	a.nm_tabela = c01_w.nm_tabela
	and	a.ie_tipo_atributo in ('DATE','NUMBER','VARCHAR2')
	order by a.nm_atributo;
	
c03_w	c03%rowtype;
	
c04 CURSOR FOR
	SELECT	a.trigger_name
	from	user_triggers a,
		user_dependencies b
	where	a.trigger_name = b.name
	and	b.referenced_name like 'GERAR_INT_PADRAO'
	and	a.trigger_type like 'AFTER%'
	and	a.triggering_event like '%UPDATE%'
	and	a.status = 'ENABLED'
	and	a.table_name like c01_w.nm_tabela;
	
c04_w	c04%rowtype;

C05 CURSOR FOR
SELECT	y.trigger_name
from	tabela_sistema x,
	user_triggers y
where	x.nm_tabela = y.table_name
and	y.trigger_name like 'INTPD_' || substr(x.ds_shortname,1,26) ||'_LOG'
and	not exists (
		SELECT	1
		from	intpd_eventos_sistema a,
			intpd_config_evento_tab b
		where	a.nr_seq_projeto_xml = b.nr_seq_proj_xml
		and	b.nm_tabela = x.nm_tabela
		and	a.ie_situacao = 'A');

c05_w	c05%rowtype;


BEGIN
open c01;
loop
fetch c01 into	
	c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin	
	if (obter_versao_oracle > 10) then
		begin
		ds_follows_w	:=	'X';
		
		open c04;
		loop
		fetch c04 into	
			c04_w;
		EXIT WHEN NOT FOUND; /* apply on c04 */
			begin
			if (ds_follows_w = 'X') then
				ds_follows_w := c04_w.trigger_name;
			else
				ds_follows_w := ds_follows_w || ',' || c04_w.trigger_name;
			end if;		
			end;
		end loop;
		close c04;
		
		if (ds_follows_w = 'X') then
			ds_follows_w := null;
		else
			ds_follows_w := ' follows ' || ds_follows_w;
		end if;
		end;
	end if;
	
	ds_script_vetor[1].ds := '';
	ds_script_vetor[2].ds := '';
	ds_script_vetor[3].ds := '';
	ds_script_vetor[4].ds := '';
	ds_script_vetor[5].ds := '';
	ds_chave_composta_proc_w	:=	'X';	
	nm_objeto_w		:=	'INTPD_' || substr(c01_w.ds_shortname,1,26) ||'_LOG';	
	ds_script_trigger_w		:=  	' create or replace trigger ' || nm_objeto_w || ds_quebra_w ||
					' after insert or update or delete on ' || c01_w.nm_tabela || ds_quebra_w ||				
					' for each row ' || ds_quebra_w ||
					ds_follows_w  || ds_quebra_w ||
					' declare' || ds_quebra_w ||
					' nr_seq_w number(10);' || ds_quebra_w ||					
					' ds_chave_w varchar2(500);'|| ds_quebra_w ||
					' ds_w varchar2(500);'|| ds_quebra_w ||
					' ie_log_w varchar2(1);'|| ds_quebra_w ||
					' begin' || ds_quebra_w ||
					' begin' || ds_quebra_w ||
					' if	(wheb_usuario_pck.get_ie_executar_trigger	= '||chr(39)|| 'S' || chr(39)||')  then ' || ds_quebra_w ||
					'  if	(inserting or updating) then ' || ds_quebra_w;
					

	open c02;
	loop
	fetch c02 into	
		c02_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		select	ie_tipo_atributo
		into STRICT	ie_tipo_atributo_w
		from	tabela_atributo
		where	nm_tabela = c01_w.nm_tabela
		and	nm_atributo = c02_w.nm_atributo;
				
		if (ie_tipo_atributo_w = 'DATE') then
			ds_valor_w	:=	'to_char(:new.'||c02_w.nm_atributo||',' || ds_aspa_w || 'yyyy/mm/dd hh24:mi:ss' || ds_aspa_w || ')';
		else
			ds_valor_w	:=	'to_char(:new.'||c02_w.nm_atributo||')';
		end if;
		
				
		if (ds_chave_composta_proc_w = 'X') then
			ds_chave_composta_proc_w := '   ds_chave_w := ' || ds_aspa_w || c02_w.nm_atributo || '=' || ds_aspa_w || ds_pipe_w || ds_valor_w || ds_pipe_w || ds_aspa_w || ';' || ds_aspa_w;
		else
			ds_chave_composta_proc_w := ds_chave_composta_proc_w || ds_pipe_w || ds_aspa_w || c02_w.nm_atributo || '=' || ds_aspa_w || ds_pipe_w || ds_valor_w || ds_pipe_w || ds_aspa_w || ';' || ds_aspa_w;
		end if;
		end;
	end loop;
	close c02;
	
	ds_chave_composta_proc_w	:= ds_chave_composta_proc_w || ';' || ds_quebra_w ||
					'  else ' || ds_quebra_w ||
					replace(ds_chave_composta_proc_w, ':new', ':old') || ';' || ds_quebra_w ||
					'  end if; ' || ds_quebra_w;
	
	ds_script_trigger_w := ds_script_trigger_w || ds_chave_composta_proc_w;
	
	open c03;
	loop
	fetch c03 into	
		c03_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		begin
		
			
		if (c03_w.ie_tipo_atributo = 'DATE') then
			ds_valor_old_w:='to_char(:old.'||c03_w.nm_atributo||','||ds_aspa_w||'yyyy/mm/dd hh24:mi:ss'||ds_aspa_w||')';
			ds_valor_new_w:='to_char(:new.'||c03_w.nm_atributo||','||ds_aspa_w||'yyyy/mm/dd hh24:mi:ss'||ds_aspa_w||')';
		else
			ds_valor_old_w:='substr(:old.'||c03_w.nm_atributo||',1,2000)';
			ds_valor_new_w:='substr(:new.'||c03_w.nm_atributo||',1,2000)';
		end if;
		
		
				
		ds_script_trigger_w := ds_script_trigger_w ||		
				'intpd_gravar_log_alteracao(' ||
				ds_aspa_w || c01_w.nm_tabela || ds_aspa_w || ',' || 
				ds_aspa_w || c03_w.nm_atributo || ds_aspa_w || ',' || 
				ds_valor_old_w || ',' || 
				ds_valor_new_w || ',' || 
				'ds_chave_w,' || 
				'nr_seq_w);' ||  ds_quebra_w;
		end;
	end loop;
	close c03;
	
	ds_script_trigger_w := ds_script_trigger_w || 	' end if; ' ||  ds_quebra_w ||
							' exception ' ||  ds_quebra_w || 
							' when others then ' ||  ds_quebra_w || 
							' ds_w := ' || ds_aspa_w || '1' || ds_aspa_w||'; '  ||  ds_quebra_w || 
							' end; '  ||  ds_quebra_w ||
							' end ' || nm_objeto_w ||';';
							
	ds_script_vetor[1].ds := substr(ds_script_trigger_w,1,32000);
	ds_script_vetor[2].ds := substr(ds_script_trigger_w,32001,32000);
	ds_script_vetor[3].ds := substr(ds_script_trigger_w,64001,32000);
	ds_script_vetor[4].ds := substr(ds_script_trigger_w,96001,32000);
	ds_script_vetor[5].ds := substr(ds_script_trigger_w,128001,32000);	
	
	begin
	EXECUTE ds_script_vetor[1].ds || ds_script_vetor[2].ds || ds_script_vetor[3].ds || ds_script_vetor[4].ds || ds_script_vetor[5].ds;	
	exception
	when others then
		ds_erro_w	:=	ds_erro_w || 'Falha na compilacao do objeto: ' || nm_objeto_w || ds_quebra_w;
	end;
	end;
end loop;
close c01;

open C05;
loop
fetch C05 into	
	c05_w;
EXIT WHEN NOT FOUND; /* apply on C05 */	
	begin
	EXECUTE ' drop trigger ' || c05_w.trigger_name;
	exception
	when others then
		ds_erro_w	:=	ds_erro_w || 'Falha na exclusao do objeto: ' || c05_w.trigger_name || ds_quebra_w;
	end;
end loop;
close C05;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE intpd_criar_trigger_log_atrib ( nr_seq_evento_sistema_p intpd_eventos_sistema.nr_sequencia%type, nm_tabela_p tabela_sistema.nm_tabela%type default null) FROM PUBLIC;

