-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_prot_adic_medic_item (nr_seq_pac_p bigint, CD_PROTOCOLO_p bigint, nr_seq_medicao_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
lista_informacao_w		varchar(1000);
ie_contador_w			bigint	:= 0;
tam_lista_w			bigint;
ie_pos_virgula_w		smallint;
ie_pos_traco_w			bigint;
lista_inf_w			varchar(100);
CD_PROTOCOLO_w			bigint;
nr_seq_material_w		integer;
nr_seq_material_ww		integer;
nr_agrupamento_w		integer;
ie_gerar_pend_quimio_w		varchar(1);

 

BEGIN 
 
ie_gerar_pend_quimio_w := obter_param_usuario(865, 255, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_gerar_pend_quimio_w);
 
if (nr_seq_pac_p > 0) and (CD_PROTOCOLO_p IS NOT NULL AND CD_PROTOCOLO_p::text <> '') and (nr_seq_medicao_p IS NOT NULL AND nr_seq_medicao_p::text <> '') then 
 
	select 	coalesce(max(nr_seq_material),0), 
		coalesce(max(nr_agrupamento),0) 
	into STRICT	nr_seq_material_ww, 
		nr_agrupamento_w 
	from 	paciente_protocolo_medic 
	where 	nr_seq_paciente = nr_seq_pac_p;
 
	insert into paciente_protocolo_medic( 
		nr_seq_paciente, 
		nr_seq_material, 
		cd_material, 
		qt_dose, 
		cd_unidade_medida, 
		ds_dias_aplicacao, 
		dt_atualizacao, 
		nm_usuario, 
		nr_agrupamento, 
		ds_recomendacao, 
		ie_via_aplicacao, 
		nr_seq_diluicao, 
		qt_min_aplicacao, 
		ie_bomba_infusao, 
		cd_intervalo, 
		qt_hora_aplicacao, 
		qt_dias_util, 
		nr_seq_interno, 
		ie_se_necessario, 
		ie_aplic_lenta, 
		ie_urgencia, 
		ie_aplic_bolus, 
		cd_protocolo, 
		nr_seq_medicacao, 
		ie_gerar_solucao, 
		ie_local_adm) 
	SELECT 	nr_seq_pac_p, 
		nr_seq_material + nr_seq_material_ww, 
		cd_material, 
		qt_dose, 
		cd_unidade_medida, 
		ds_dias_aplicacao, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_agrupamento + nr_agrupamento_w, 
		ds_recomendacao, 
		ie_via_aplicacao, 
		nr_seq_diluicao, 
		qt_minuto_aplicacao, 
		ie_bomba_infusao, 
		cd_intervalo, 
		qt_hora_aplicacao, 
		qt_dias_util, 
		nextval('paciente_protocolo_medic_seq'), 
		ie_se_necessario, 
		ie_aplic_lenta, 
		ie_urgencia, 
		ie_aplic_bolus, 
		CD_PROTOCOLO_p, 
		nr_seq_medicao_p, 
		coalesce(IE_GERAR_SOLUCAO,'N'), 
		CASE WHEN ie_gerar_pend_quimio_w='S' THEN  coalesce(IE_LOCAL_ADM,'H')  ELSE coalesce(IE_LOCAL_ADM,'') END  
	from 	protocolo_medic_material 
	where	cd_protocolo = CD_PROTOCOLO_p 
	 and	nr_sequencia = nr_seq_medicao_p 
	 and	coalesce(nr_seq_diluicao::text, '') = '' 
	 and	ie_agrupador = 1;
 
	select 	coalesce(max(nr_seq_material),0), 
		coalesce(max(nr_agrupamento),0) 
	into STRICT	nr_seq_material_w, 
		nr_agrupamento_w 
	from 	paciente_protocolo_medic 
	where 	nr_seq_paciente = nr_seq_pac_p;
 
	insert into paciente_protocolo_medic( 
		nr_seq_paciente, 
		nr_seq_material, 
		cd_material, 
		qt_dose, 
		cd_unidade_medida, 
		ds_dias_aplicacao, 
		dt_atualizacao, 
		nm_usuario, 
		nr_agrupamento, 
		ds_recomendacao, 
		ie_via_aplicacao, 
		nr_seq_diluicao, 
		qt_min_aplicacao, 
		ie_bomba_infusao, 
		cd_intervalo, 
		qt_hora_aplicacao, 
		qt_dias_util, 
		nr_seq_interno, 
		ie_se_necessario, 
		ie_aplic_lenta, 
		ie_urgencia, 
		ie_aplic_bolus, 
		cd_protocolo, 
		nr_seq_medicacao, 
		ie_gerar_solucao, 
		ie_local_adm) 
	SELECT 	nr_seq_pac_p, 
		b.nr_seq_material + nr_seq_material_w, 
		b.cd_material, 
		b.qt_dose, 
		b.cd_unidade_medida, 
		coalesce(b.ds_dias_aplicacao, a.ds_dias_aplicacao), 
		clock_timestamp(), 
		nm_usuario_p, 
		b.nr_agrupamento + nr_agrupamento_w, 
		b.ds_recomendacao, 
		b.ie_via_aplicacao, 
		b.nr_seq_diluicao + nr_seq_material_ww, 
		b.qt_minuto_aplicacao, 
		b.ie_bomba_infusao, 
		b.cd_intervalo, 
		b.qt_hora_aplicacao, 
		b.qt_dias_util, 
		nextval('paciente_protocolo_medic_seq'), 
		b.ie_se_necessario, 
		b.ie_aplic_lenta, 
		b.ie_urgencia, 
		b.ie_aplic_bolus, 
		CD_PROTOCOLO_p, 
		nr_seq_medicao_p, 
		coalesce(a.IE_GERAR_SOLUCAO,'N'), 
		CASE WHEN ie_gerar_pend_quimio_w='S' THEN  coalesce(b.IE_LOCAL_ADM,'H')  ELSE coalesce(b.IE_LOCAL_ADM,'') END  
	from 	protocolo_medic_material b, 
		protocolo_medic_material a 
	where 	a.cd_protocolo = CD_PROTOCOLO_p 
	 and	a.nr_sequencia = nr_seq_medicao_p 
	 and 	a.cd_protocolo = b.cd_protocolo 
	 and 	a.nr_sequencia = b.nr_sequencia 
	 and 	b.nr_seq_diluicao = a.nr_seq_material 
	 and	b.ie_agrupador in (3,7);
end if;
CALL atualizar_dose_onc_protocolo(nr_seq_pac_p);
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_prot_adic_medic_item (nr_seq_pac_p bigint, CD_PROTOCOLO_p bigint, nr_seq_medicao_p bigint, nm_usuario_p text) FROM PUBLIC;

