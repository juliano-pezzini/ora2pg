-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_resumo_gerencia ( nm_usuario_p text) AS $body$
DECLARE

 
c01 CURSOR FOR 
SELECT	x.nr_sequencia, 
	x.ds_gerencia, 
	y.nr_sequencia, 
	y.ds_grupo 
from	gerencia_wheb x, 
	grupo_desenvolvimento y 
where	x.nr_sequencia = y.nr_seq_gerencia 
order by 2,4;

nr_seq_gerencia_w			bigint;
ds_gerencia_w			varchar(80);
nr_seq_grupo_des_w		bigint;
ds_grupo_des_w			varchar(80);
qt_total_os_pend_w		bigint;
qt_total_os_proj_w			bigint;
qt_total_os_nproj_w			bigint;
qt_total_proj_w			bigint;
qt_total_os_rec_dia_w		bigint;
qt_total_os_rec_mes_w		bigint;
qt_total_os_rec_ano_w		bigint;
qt_total_os_rec_mesant_w		bigint;
qt_total_erro_wheb_w		bigint;
qt_total_erro_cliente_w		bigint;
dt_meta_w			timestamp;
qt_meta_w			bigint;
qt_total_os_encer_mes_w		bigint;
qt_total_os_cli_mes_w		bigint;
qt_total_sla_pend_w		bigint;
qt_total_os_atraso_w		bigint;
cd_perfil_ativo_w			integer := obter_perfil_ativo;


BEGIN 
 
delete from w_resumo_os_gerencia 
where	nm_usuario = nm_usuario_p;
 
open c01;
loop 
fetch c01 into 
	nr_seq_gerencia_w, 
	ds_gerencia_w, 
	nr_seq_grupo_des_w, 
	ds_grupo_des_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
 
	select	sum(CASE WHEN substr(obter_se_ordem_vinc_projeto(x.nr_sequencia,'2'),1,1)='N' THEN  1  ELSE 0 END ) qt_ordem, 
		sum(CASE WHEN substr(obter_se_ordem_vinc_projeto(x.nr_sequencia,'1'),1,1)='S' THEN  1  ELSE 0 END ) qt_os_proj, 
		max(obter_qt_proj_grupo(0, nr_seq_grupo_des_w)) qt_projeto 
	into STRICT	qt_total_os_pend_w, 
		qt_total_os_proj_w, 
		qt_total_proj_w 
	from	man_ordem_servico_v x 
	where	coalesce(x.nr_seq_meta_pe::text, '') = '' 
	and	coalesce(x.nr_seq_obj_bsc::text, '') = '' 
	and	x.nr_seq_gerencia_des 	= nr_seq_gerencia_w 
	and	x.nr_seq_grupo_des	= nr_seq_grupo_des_w 
	and (x.nr_seq_trab in (   SELECT  a.nr_sequencia 
                from   man_grupo_trabalho a, 
                    man_grupo_trab_usuario b 
                where  a.nr_sequencia = b.nr_seq_grupo_trab 
                and   b.nm_usuario_param = nm_usuario_p)) 
	and	x.ie_status_ordem in ('1','2') 
	and	x.nr_seq_estagio in (	SELECT	nr_seq_estagio 
					from	man_estagio_usuario 
					where	nm_usuario_acao = nm_usuario_p 
					and	CASE WHEN coalesce(cd_perfil,0)=0 THEN coalesce(cd_perfil_ativo_w,0)  ELSE cd_perfil END  = 
						CASE WHEN coalesce(cd_perfil_ativo_w,0)=0 THEN CASE WHEN coalesce(cd_perfil,0)=0 THEN coalesce(cd_perfil_ativo_w,0)  ELSE cd_perfil END   ELSE cd_perfil_ativo_w END );
 
	begin 
	select	a.qt_meta_prev, 
		a.dt_meta 
	into STRICT	qt_meta_w, 
		dt_meta_w 
	from	grupo_desenvolvimento b, 
		desenvolvimento_meta_os a 
	where	a.nr_seq_grupo_des	= nr_seq_grupo_des_w 
	and	a.nr_seq_grupo_des	= b.nr_sequencia 
	and	b.nr_seq_gerencia		= nr_seq_gerencia_w 
	and	a.dt_meta			= obter_meta_semana_desen(clock_timestamp(), nr_seq_gerencia_w);
	exception when others then 
		qt_meta_w := 0;
		dt_meta_w := clock_timestamp();
	end;
 
	select	sum(CASE WHEN m.ie_origem_erro='W' THEN  1  ELSE 0 END ) qt_ordem_wheb, 
		sum(CASE WHEN m.ie_origem_erro='C' THEN  1  ELSE 0 END ) qt_ordem_cli 
	into STRICT	qt_total_erro_wheb_w, 
		qt_total_erro_cliente_w 
	from	grupo_desenvolvimento c, 
		man_ordem_servico_v a, 
		man_doc_erro m 
	where	m.nr_seq_ordem		= a.nr_sequencia 
	and	m.nr_seq_grupo_des	= c.nr_sequencia 
	and	a.ie_classificacao		= 'E' 
	and	c.nr_seq_gerencia		= nr_seq_gerencia_w 
	and	m.nr_seq_grupo_des	= nr_seq_grupo_des_w 
	and	pkg_date_utils.start_of(obter_data_estagio_os(a.nr_sequencia,'d'), 'MONTH',0) >= pkg_date_utils.start_of(clock_timestamp(),'MONTH',0) 
	and	pkg_date_utils.start_of(a.dt_ordem_servico, 'MONTH',0) >= pkg_date_utils.start_of(clock_timestamp(),'MONTH',0);
 
	select	sum(qt_ordem_cliente), 
		sum(qt_ordem_encerrada), 
		sum(qt_ordem_dia), 
		sum(CASE WHEN pkg_date_utils.start_of(dt_ordem_servico, 'MONTH',0)=pkg_date_utils.start_of(clock_timestamp(), 'MONTH',0) THEN  1  ELSE 0 END ) qt_total_mes 
	into STRICT	qt_total_os_cli_mes_w, 
		qt_total_os_encer_mes_w, 
		qt_total_os_rec_dia_w, 
		qt_total_os_rec_mes_w 
	from	man_resumo_os_dia a 
	where	a.dt_ordem_servico between pkg_date_utils.start_of(clock_timestamp(), 'MONTH',0) and fim_mes(pkg_date_utils.start_of(clock_timestamp(), 'MONTH',0)) 
	and	a.nr_seq_gerencia		= nr_seq_gerencia_w 
	and	a.nr_seq_grupo_des 	= nr_seq_grupo_des_w;
 
	select	count(*) 
	into STRICT	qt_total_os_rec_ano_w 
	from	man_resumo_os_dia a 
	where	a.dt_ordem_servico between pkg_date_utils.start_of(clock_timestamp(), 'YEAR',0) and fim_mes(pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(), 'YEAR',0),11,0)) 
	and	a.nr_seq_gerencia		= nr_seq_gerencia_w 
	and	a.nr_seq_grupo_des 	= nr_seq_grupo_des_w;
 
 
	select	count(*) 
	into STRICT	qt_total_os_rec_mesant_w 
	from	man_resumo_os_dia a 
	where	a.dt_ordem_servico between pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(), 'MONTH',0),-1,0) and fim_mes(pkg_date_utils.add_month(pkg_date_utils.start_of(clock_timestamp(), 'MONTH',0),-1,0)) 
	and	a.nr_seq_gerencia		= nr_seq_gerencia_w 
	and	a.nr_seq_grupo_des 	= nr_seq_grupo_des_w;
 
	select	count(*) 
	into STRICT	qt_total_sla_pend_w 
	from	man_ordem_servico_v a, 
		man_ordem_serv_sla b 
	where	a.nr_sequencia = b.nr_seq_ordem 
	and	b.nr_seq_status <> 412 
	and	a.nr_seq_gerencia_des	= nr_seq_gerencia_w 
	and	a.nr_seq_grupo_des	= nr_seq_grupo_des_w 
	and (obter_se_os_pend_cliente(b.nr_seq_ordem) = 'N') 
	and (obter_se_os_desenv(b.nr_seq_ordem) = 'S') 
	and	ie_status_ordem <> 3;
 
	select	count(*) 
	into STRICT	qt_total_os_atraso_w 
	from	grupo_desenvolvimento b, 
		man_ordem_servico_v a 
	where (obter_se_os_pend_cliente(a.nr_sequencia) = 'N') 
	and (Obter_Se_OS_Desenv(a.nr_sequencia) = 'S') 
	and	a.nr_seq_gerencia_des 	= nr_seq_gerencia_w 
	and	a.nr_seq_grupo_des  	= nr_seq_grupo_des_w 
	and (ie_status_ordem <> 3) 
	and  	a.nr_seq_grupo_des  = b.nr_sequencia 
	and  	a.dt_ordem_servico < (clock_timestamp() - coalesce(b.qt_dia_prev_os,60)) 
	and  	substr(obter_se_ordem_vinc_projeto(a.nr_sequencia,'2'),1,1) = 'N';
 
	insert into w_resumo_os_gerencia( 
			nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			nr_seq_gerencia, 
			nr_seq_grupo_des, 
			qt_total_os_pend, 
			qt_total_os_proj, 
			qt_total_os_nproj, 
			qt_total_proj, 
			qt_total_os_rec_dia, 
			qt_total_os_rec_mes, 
			qt_total_os_rec_ano, 
			qt_total_os_rec_mesant, 
			qt_total_erro_wheb, 
			qt_total_erro_cliente, 
			dt_meta, 
			qt_meta, 
			qt_total_os_encer_mes, 
			qt_total_os_cli_mes, 
			qt_total_sla_pend, 
			qt_total_os_atraso) 
		values (	nextval('w_resumo_os_gerencia_seq'), 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			nr_seq_gerencia_w, 
			nr_seq_grupo_des_w, 
			qt_total_os_pend_w, 
			qt_total_os_proj_w, 
			qt_total_os_nproj_w, 
			qt_total_proj_w, 
			qt_total_os_rec_dia_w, 
			qt_total_os_rec_mes_w, 
			qt_total_os_rec_ano_w, 
			qt_total_os_rec_mesant_w, 
			qt_total_erro_wheb_w, 
			qt_total_erro_cliente_w, 
			dt_meta_w, 
			qt_meta_w, 
			qt_total_os_encer_mes_w, 
			qt_total_os_cli_mes_w, 
			qt_total_sla_pend_w, 
			qt_total_os_atraso_w);
	end;
end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_resumo_gerencia ( nm_usuario_p text) FROM PUBLIC;

