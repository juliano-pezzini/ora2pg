-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inserir_aprop_lanc_prog ( nr_seq_lanc_auto_p pls_segurado_mensalidade.nr_sequencia%type, nr_seq_lanc_mens_p w_pls_lanc_mens_aprop.nr_sequencia%type, vl_item_p text, nr_seq_centro_aprop_p pls_centro_apropriacao.nr_sequencia%type, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE


/*
I	Insere os registros de apropriação na tabela temporaria para consulta
A	Atualiza na tabela quente as informações da tabela temporaria
E	Exclui o lançamento
N	Adiciona a apropriação na tabela temporaria
*/
	

vl_item_w		pls_segurado_mensalidade.vl_item%type;
vl_item_tabela_temp_w	w_pls_lanc_mens_aprop.vl_item%type;
	
C01 CURSOR(	nr_seq_lanc_auto_pc	pls_lancamento_mens_aprop.nr_sequencia%type) FOR
	SELECT	nr_seq_centro_apropriacao,
		vl_apropriacao
	from	pls_lancamento_mens_aprop
	where	nr_seq_lanc_auto = nr_seq_lanc_auto_pc;

C02 CURSOR(	nr_seq_lanc_auto_pc	pls_lancamento_mens_aprop.nr_sequencia%type) FOR
	SELECT	nr_seq_centro_apropriacao,
		vl_item
	from	w_pls_lanc_mens_aprop
	where	nr_seq_lancamento = nr_seq_lanc_auto_pc;
	
procedure insere_apropriacao(	nr_seq_centro_apropriacao_p	pls_centro_apropriacao.nr_sequencia%type,
				vl_item_apropriacao_p		w_pls_lanc_mens_aprop.vl_item%type) is
;
BEGIN

insert	into	w_pls_lanc_mens_aprop(nr_sequencia, dt_atualizacao, dt_atualizacao_nrec,
	nm_usuario, nm_usuario_nrec, nr_seq_centro_apropriacao,
	vl_item, nr_seq_lancamento)
values (nextval('w_pls_lanc_mens_aprop_seq'), clock_timestamp(), clock_timestamp(),
	nm_usuario_p, nm_usuario_p, nr_seq_centro_apropriacao_p,
	vl_item_apropriacao_p, nr_seq_lanc_auto_p);

end;
	
begin

if (ie_opcao_p = 'I') then
	delete from w_pls_lanc_mens_aprop
	where nr_seq_lancamento = nr_seq_lanc_auto_p;
	
	for r_c01_w in c01(nr_seq_lanc_auto_p) loop
		begin
		insere_apropriacao(r_c01_w.nr_seq_centro_apropriacao, r_c01_w.vl_apropriacao);
		end;
	end loop;
elsif (ie_opcao_p = 'N') then
	insere_apropriacao(nr_seq_centro_aprop_p, vl_item_p);
elsif (ie_opcao_p = 'E') then
	delete from w_pls_lanc_mens_aprop
	where	nr_sequencia = nr_seq_lanc_mens_p;
elsif (ie_opcao_p = 'A') then
	select	coalesce(vl_item, 0)
	into STRICT	vl_item_w
	from	pls_segurado_mensalidade
	where	nr_sequencia = nr_seq_lanc_auto_p;
	
	select	sum(coalesce(vl_item, 0))
	into STRICT	vl_item_tabela_temp_w
	from	w_pls_lanc_mens_aprop
	where	nr_seq_lancamento = nr_seq_lanc_auto_p;
	
	if (vl_item_w <> vl_item_tabela_temp_w) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1097863);
	end if;
	
	delete from pls_lancamento_mens_aprop
	where nr_seq_lanc_auto = nr_seq_lanc_auto_p;
	
	for r_c02_w in c02(nr_seq_lanc_auto_p) loop
		begin
		insert into pls_lancamento_mens_aprop(nr_sequencia, nm_usuario, nm_usuario_nrec,
			dt_atualizacao, dt_atualizacao_nrec, nr_seq_centro_apropriacao,
			vl_apropriacao, nr_seq_lanc_auto)
		values (nextval('pls_lancamento_mens_aprop_seq'), nm_usuario_p, nm_usuario_p,
			clock_timestamp(), clock_timestamp(), r_c02_w.nr_seq_centro_apropriacao,
			r_c02_w.vl_item, nr_seq_lanc_auto_p);
		end;
	end loop;
end if;	

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inserir_aprop_lanc_prog ( nr_seq_lanc_auto_p pls_segurado_mensalidade.nr_sequencia%type, nr_seq_lanc_mens_p w_pls_lanc_mens_aprop.nr_sequencia%type, vl_item_p text, nr_seq_centro_aprop_p pls_centro_apropriacao.nr_sequencia%type, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

