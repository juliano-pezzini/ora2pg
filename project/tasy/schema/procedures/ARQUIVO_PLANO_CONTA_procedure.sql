-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE arquivo_plano_conta (cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, nm_usuario_p text, cd_empresa_p bigint) AS $body$
DECLARE


dt_atualizacao_w		varchar(8);
cd_conta_contabil_w		varchar(28);
ie_tipo_w			varchar(1);
cd_conta_sup_w			varchar(28);
ds_conta_contabil_w		varchar(45);
cd_estabelecimento_w		varchar(10);
contador_w			bigint;
ds_arquivo_ww			varchar(4000);


c01 CURSOR FOR
SELECT	lpad(coalesce(to_char(dt_atualizacao,'ddmmyyyy'),' '),8,' ')           dt_atualizacao,
	lpad(coalesce(to_char(a.cd_conta_contabil),' '),28,' ')		cd_conta_contabil,
	lpad(coalesce(CASE WHEN a.ie_tipo='T' THEN 'S'  ELSE 'A' END ,' '),1,' ')		ie_tipo,
	lpad(coalesce(to_char(substr(ctb_obter_codigo_classif_vig(cd_empresa,ctb_obter_classif_conta_sup(a.cd_classificacao, trunc(dt_inicio_p,'year'), cd_empresa_p),dt_inicio_p),1,28)),' '),28,' ') cd_conta_sup,
	rpad(coalesce(a.ds_conta_contabil,' '),45,' ')		ds_conta_contabil
from	conta_contabil a
where	a.cd_empresa = cd_empresa_p
and	substr(obter_se_conta_vigente2(cd_conta_contabil, dt_inicio_vigencia, dt_fim_vigencia, dt_inicio_p),1,1) = 'S';


BEGIN

open c01;
loop
fetch c01 into

dt_atualizacao_w,
cd_conta_contabil_w,
ie_tipo_w,
cd_conta_sup_w,
ds_conta_contabil_w;

EXIT WHEN NOT FOUND; /* apply on c01 */

	begin

	contador_w := contador_w + 1;

	ds_arquivo_ww	:=	dt_atualizacao_w	||
				cd_conta_contabil_w	||
				ie_tipo_w		||
				cd_conta_sup_w		||
				ds_conta_contabil_w;

insert into w_inss_direp_arquivo( nr_sequencia,
				cd_estabelecimento,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_arquivo_w)
		values (nextval('w_inss_direp_arquivo_seq'),
				cd_estabelecimento_p,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				ds_arquivo_ww);

	if (mod(contador_w,100) = 0) then
		commit;
	end if;

	end;

end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE arquivo_plano_conta (cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, nm_usuario_p text, cd_empresa_p bigint) FROM PUBLIC;

