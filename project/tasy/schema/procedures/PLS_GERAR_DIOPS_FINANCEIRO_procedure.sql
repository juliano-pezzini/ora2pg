-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_diops_financeiro ( nr_seq_operadora_p bigint, nr_seq_periodo_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_identificador_p bigint default 0) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Gerar as informacoes financeiras do DIOPS
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta: 
[ X ]  Objetos do dicionario [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atencao:
-------------------------------------------------------------------------------------------------------------------
Referencias:
	PLS_GERAR_DIOPS
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
/*
00 - Todos os quadros
19 - Fluxo de Caixa
20 - Idade de Saldos
21  - Lucros ou Prejuizos
22 - Solvencia
23 - Balancete Ativo
24 - Balancete Passivo
25 - Balancete Receita
26 - Balancete Despesa
28 - Intercambio
29 - Corresponsabilidade
30 - Eventos Sinistros/Liquidar
31 - Cobertura Assistencial
32 - Intercambio Eventual
34 - Eventos Indenizaveis
36 - Agrupamento Contratos
37 - Eventos corresponsabilidade
*/
ie_fluxo_caixa_w		varchar(255);
ie_idade_saldo_w		varchar(255);
ie_lucro_prejuizo_w		varchar(255);
ie_solvencia_w			varchar(255) := '';
ie_balancete_ativo_w		varchar(255);
ie_balancete_passivo_w		varchar(255);
ie_balancete_receita_w		varchar(255);
ie_balancete_despesa_w		varchar(255);
ie_tipo_periodo_diops_w		varchar(255);
ie_corresponsabilidade_w	varchar(255);
ie_evento_sinistro_w		varchar(255);
ie_parametro_w			varchar(255);
ie_pasta_intercambio_w		varchar(255);
ie_pasta_corresp_w		varchar(255);
ie_contrap_pecun_w		varchar(255);
ie_corresp_cedida_w		varchar(255);
ie_movto_pel_w			varchar(255);
ie_agrup_contratos_w		pls_parametros.ie_agrup_contratos%type;
ie_corresp_diops_w		pls_parametros.ie_corresp_diops%type;
qt_lanc_ativo_w			bigint	:= 0;
qt_lanc_passivo_w		bigint	:= 0;
qt_lanc_receita_w		bigint	:= 0;
qt_lanc_despesa_w		bigint	:= 0;
qt_tap_w			bigint	:= 0;
qt_mod_padrao_capital_w		bigint	:= 0;
qt_evento_corresp_2018_w	bigint	:= 0;
qt_apur_capital_det_w		bigint	:= 0;
qt_cred_deb_apur_capit_w	bigint	:= 0;
nr_seq_transacao_w		bigint;
cd_estabelecimento_w		bigint;
dt_vigencia_w			timestamp;
dt_periodo_inicial_w		timestamp;
dt_periodo_final_w		timestamp;


BEGIN
select	coalesce(max(cd_estabelecimento),1)
into STRICT	cd_estabelecimento_w
from	pls_outorgante
where	nr_sequencia	= nr_seq_operadora_p;

pls_obter_pls_parametros(cd_estabelecimento_w,'ie_fluxo_caixa','G',ie_fluxo_caixa_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_idade_saldo','G',ie_idade_saldo_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_lucro_prejuizo','G',ie_lucro_prejuizo_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_balancete_ativo','G',ie_balancete_ativo_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_balancete_passivo','G',ie_balancete_passivo_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_balancete_receita','G',ie_balancete_receita_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_balancete_despesa','G',ie_balancete_despesa_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_corresponsabilidade','G',ie_corresponsabilidade_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_eventos_sinistros','G',ie_evento_sinistro_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_agrup_contratos','GI',ie_agrup_contratos_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_corresp_diops','G',ie_corresp_diops_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_contrap_pecun','G',ie_contrap_pecun_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_corresp_cedida','G',ie_corresp_cedida_w);
pls_obter_pls_parametros(cd_estabelecimento_p,'ie_movto_pel','G',ie_movto_pel_w);


/* 
  Edgar 14/08/2013, Criado os parametros 7 e 8 na funcao do DIOPS para indicar se estas pastas 
  deverao estar disponiveis e se deverao ser geradas informacoes nestas pastas. (O DIOPS 2013 NAO ACEITA MAIS ESTAS INFORMACOES)
  Nao tratamos as pastas atraves dos parametros ie_intercambio_w e ie_corresponsabilidade_w porque estes parametros sao so para indicar a geracao ou nao destas informacoes
 */
ie_pasta_intercambio_w	:= obter_valor_param_usuario(1227, 7, Obter_Perfil_Ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);
ie_pasta_corresp_w	:= obter_valor_param_usuario(1227, 8, Obter_Perfil_Ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);

/* Limpar tabelas transitorias */

delete	from w_diops_fin_balancete
where	nr_seq_operadora 	= nr_seq_operadora_p
and	nr_seq_periodo		= nr_seq_periodo_p;

/* Obter o periodo trimestral do DIOPS */

begin	
select	coalesce(dt_periodo_inicial,''),
	coalesce(dt_periodo_final, ''),
	coalesce(ie_tipo_periodo_diops,'T')
into STRICT	dt_periodo_inicial_w,
	dt_periodo_final_w,
	ie_tipo_periodo_diops_w
from	diops_periodo
where	nr_sequencia	= nr_seq_periodo_p;
exception
when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(183308, 'NR_SEQ_OPERADORA=' || nr_seq_operadora_p || ';' || 'NR_SEQ_PERIODO=' || nr_seq_periodo_p);
end;
if (dt_periodo_final_w <  to_date( '01/01/2016','dd/mm/yyyy')) then
	ie_solvencia_w := 'GI';
end if;

select	coalesce(max(nr_sequencia),0)
into STRICT	nr_seq_transacao_w
from	diops_transacao
where	ie_tipo_transacao	= 'F'
and	cd_estabelecimento	= cd_estabelecimento_p
and	dt_vigencia	=	(SELECT	max(dt_vigencia)
				from	diops_transacao
				where	ie_tipo_transacao = 'F'
				and	cd_estabelecimento	= cd_estabelecimento_p
				and	dt_vigencia <= dt_periodo_inicial_w);

CALL pls_consistir_diops_pck.pls_carregar_info_diops(nr_seq_periodo_p,cd_estabelecimento_p);
				
/* ct_fluxoCaixa */

if	((ie_fluxo_caixa_w in ('G','GI')) and (nr_seq_identificador_p in (0,19))) then
	delete	from w_diops_fin_fluxo_caixa
	where	nr_seq_operadora 	= nr_seq_operadora_p
	and	nr_seq_periodo		= nr_seq_periodo_p;
	delete	from diops_fin_fluxo_caixa
	where	nr_seq_periodo		= nr_seq_periodo_p
	and	cd_estabelecimento	= cd_estabelecimento_w;
	
	CALL diops_fin_gerar_fluxo_caixa(nr_seq_operadora_p, nr_seq_transacao_w, nr_seq_periodo_p, nm_usuario_p);
	CALL pls_consistir_diops_pck.pls_consist_fluxo_caixa(nr_seq_periodo_p,cd_estabelecimento_p);
end if;

if (ie_tipo_periodo_diops_w in ('T','F')) then
	/* ct_idadeSaldo */

	if	((ie_idade_saldo_w in ('G','GI')) and (nr_seq_identificador_p in (0,20))) then
		delete	FROM diops_idadesaldo_contab
		where	nr_seq_operadora 	= nr_seq_operadora_p
		and	nr_seq_periodo	= nr_seq_periodo_p;
		
		delete	from w_diops_fin_idadesaldo_pas
		where	nr_seq_operadora 	= nr_seq_operadora_p
		and	nr_seq_periodo		= nr_seq_periodo_p;
		
		delete	from diops_fin_idadesaldo_pas
		where	nr_seq_periodo		= nr_seq_periodo_p
		and	cd_estabelecimento	= cd_estabelecimento_w;
			
		delete	from w_diops_fin_idadesaldo_ati
		where	nr_seq_operadora 	= nr_seq_operadora_p
		and	nr_seq_periodo		= nr_seq_periodo_p;
		
		delete	from diops_fin_idadesaldo_ati
		where	nr_seq_periodo		= nr_seq_periodo_p
		and	cd_estabelecimento	= cd_estabelecimento_w;
		
		delete	from diops_idadesaldo_contab
		where	nr_seq_periodo		= nr_seq_periodo_p
		and	cd_estabelecimento	= cd_estabelecimento_w;
		
		CALL diops_fin_gerar_idade_saldo(nr_seq_operadora_p, nr_seq_transacao_w, nr_seq_periodo_p, nm_usuario_p);
		CALL pls_consistir_diops_pck.pls_diops_consist_idade_saldos(nr_seq_periodo_p,cd_estabelecimento_p);
	end if;
	
	/* ct_lucroPrejuizo */

	if	((ie_lucro_prejuizo_w in ('G','GI')) and (nr_seq_identificador_p in (0,21))) then
		delete	from w_diops_fin_lucro_prej
		where	nr_seq_operadora 	= nr_seq_operadora_p
		and	nr_seq_periodo		= nr_seq_periodo_p;
		
		delete	from diops_fin_lucro_prej
		where	nr_seq_periodo		= nr_seq_periodo_p
		and	cd_estabelecimento	= cd_estabelecimento_w;
		
		CALL diops_fin_gerar_lucro_prej(nr_seq_operadora_p, nr_seq_transacao_w, nr_seq_periodo_p, nm_usuario_p);
	end if;
	
	/* ct_solvencia */

	if	((ie_solvencia_w in ('G','GI')) and (nr_seq_identificador_p in (0,22))) then
		
		delete	from w_diops_fin_solvencia
		where	nr_seq_operadora 	= nr_seq_operadora_p
		and	nr_seq_periodo		= nr_seq_periodo_p;
		
		delete	from diops_fin_solvencia
		where	nr_seq_periodo		= nr_seq_periodo_p
		and	cd_estabelecimento	= cd_estabelecimento_w;
		
		CALL diops_fin_gerar_solvencia(nr_seq_operadora_p, nr_seq_transacao_w, nr_seq_periodo_p, nm_usuario_p);
	end if;
	
	if	((dt_periodo_final_w < to_date('01/01/2016','dd/mm/yyyy')) and (nr_seq_identificador_p in (0,28))) then
		/* ct_intercambio */

		delete	from w_diops_fin_intercambio
		where	nr_seq_operadora 	= nr_seq_operadora_p
		and	nr_seq_periodo		= nr_seq_periodo_p;
		
		delete	from diops_fin_intercambio
		where	nr_seq_periodo		= nr_seq_periodo_p
		and	cd_estabelecimento	= cd_estabelecimento_w;
	
		CALL diops_fin_gerar_intercambio(nr_seq_operadora_p, nr_seq_transacao_w, nr_seq_periodo_p, nm_usuario_p);
	end if;
	
	/* ct_corresponsabilidade */

	if	((ie_corresponsabilidade_w in ('G','GI')) and (ie_pasta_corresp_w = 'S') and (nr_seq_identificador_p in (0,29))) then
		delete	from w_diops_fin_corresp
		where	nr_seq_operadora 	= nr_seq_operadora_p
		and	nr_seq_periodo		= nr_seq_periodo_p;
		
		delete	from diops_fin_corresp
		where	nr_seq_periodo		= nr_seq_periodo_p
		and	cd_estabelecimento	= cd_estabelecimento_w;
		
		CALL diops_fin_gerar_corresponsab(nr_seq_operadora_p, nr_seq_transacao_w, nr_seq_periodo_p, nm_usuario_p);
	end if;
	
	/* ct_segProvEventosSinistrosLiq */

	if	((ie_evento_sinistro_w in ('G','GI')) and (nr_seq_identificador_p in (0,30))) then
		delete	from w_diops_fin_sinistro
		where	nr_seq_operadora 	= nr_seq_operadora_p
		and	nr_seq_periodo		= nr_seq_periodo_p;
		
		delete	from diops_fin_sinistro
		where	nr_seq_periodo		= nr_seq_periodo_p
		and	cd_estabelecimento	= cd_estabelecimento_w;
		
		delete	from diops_fin_event_liq
	        where	nr_seq_periodo		= nr_seq_periodo_p;
		
		CALL diops_fin_gerar_sinistro(nr_seq_operadora_p, nr_seq_transacao_w, nr_seq_periodo_p, nm_usuario_p);
		CALL pls_consistir_diops_pck.pls_consist_fin_sinistro(nr_seq_periodo_p,cd_estabelecimento_p);
	end if;
	
	if (ie_balancete_ativo_w in ('G','GI')) or (ie_balancete_passivo_w in ('G','GI')) or (ie_balancete_receita_w in ('G','GI')) or (ie_balancete_despesa_w in ('G','GI')) then
		
		ie_parametro_w := Obter_Param_Usuario(1227, 5, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_parametro_w);
	end if;
	
	/* ct_lancamentoAtivo */

	if (ie_balancete_ativo_w in ('G','GI')  and (nr_seq_identificador_p in (0,23))) then
		delete	from w_diops_fin_mov_ativo
		where	nr_seq_operadora 	= nr_seq_operadora_p
		and	nr_seq_periodo		= nr_seq_periodo_p;
		
		delete	from diops_fin_mov_ativo
		where	nr_seq_periodo		= nr_seq_periodo_p
		and	cd_estabelecimento	= cd_estabelecimento_w;
		
		CALL diops_fin_gerar_mov_ativo(nr_seq_operadora_p, nr_seq_transacao_w, nr_seq_periodo_p, ie_parametro_w, nm_usuario_p);
	end if;
	
	/* ct_lancamentoPassivo */

	if (ie_balancete_passivo_w in ('G','GI') and (nr_seq_identificador_p in (0,24))) then
		delete	from w_diops_fin_mov_passivo
		where	nr_seq_operadora 	= nr_seq_operadora_p
		and	nr_seq_periodo		= nr_seq_periodo_p;
		
		delete	from diops_fin_mov_passivo
		where	nr_seq_periodo		= nr_seq_periodo_p
		and	cd_estabelecimento	= cd_estabelecimento_w;
		
		CALL diops_fin_gerar_mov_passivo(nr_seq_operadora_p, nr_seq_transacao_w, nr_seq_periodo_p, ie_parametro_w, nm_usuario_p);
	end if;
	
	/* ct_lancamentoReceita */

	if (ie_balancete_receita_w in ('G','GI') and (nr_seq_identificador_p in (0,25))) then
		delete	from w_diops_fin_mov_receita
		where	nr_seq_operadora 	= nr_seq_operadora_p
		and	nr_seq_periodo		= nr_seq_periodo_p;
		
		delete	from diops_fin_mov_receita
		where	nr_seq_periodo		= nr_seq_periodo_p
		and	cd_estabelecimento	= cd_estabelecimento_w;
		
		CALL diops_fin_gerar_mov_receita(nr_seq_operadora_p, nr_seq_transacao_w, nr_seq_periodo_p, ie_parametro_w, nm_usuario_p);
	end if;
	
	/* ct_lancamentoDespesa */

	if (ie_balancete_despesa_w in ('G','GI') and (nr_seq_identificador_p in (0,26))) then
		delete	from w_diops_fin_mov_despesa
		where	nr_seq_operadora 	= nr_seq_operadora_p
		and	nr_seq_periodo		= nr_seq_periodo_p;
		
		delete	from diops_fin_mov_despesa
		where	nr_seq_periodo		= nr_seq_periodo_p
		and	cd_estabelecimento	= cd_estabelecimento_w;
		
		CALL diops_fin_gerar_mov_despesa(nr_seq_operadora_p, nr_seq_transacao_w, nr_seq_periodo_p, ie_parametro_w, nm_usuario_p);
	end if;
	
	if	((ie_balancete_ativo_w in ('G','GI')) or (ie_balancete_passivo_w in ('G','GI')) or (ie_balancete_receita_w in ('G','GI')) or (ie_balancete_despesa_w in ('G','GI'))) and (nr_seq_identificador_p in (0,23,24,25,26)) then
		
		CALL pls_consistir_diops_pck.pls_diops_consist_balancete(nr_seq_periodo_p,cd_estabelecimento_p);
	end if;
	
	/* ct_eventual */

	if (dt_periodo_final_w < pkg_date_utils.get_dateTime(2018, 01, 01)) and (nr_seq_identificador_p in (0,32)) then
		delete	from diops_fin_interc_eventual
		where	nr_seq_periodo		= nr_seq_periodo_p;
		
		diops_fin_gerar_interc_event(nr_seq_operadora_p, nr_seq_transacao_w, nr_seq_periodo_p, nm_usuario_p);
		CALL pls_consistir_diops_pck.pls_consist_interc_event(nr_seq_periodo_p,cd_estabelecimento_p);
	end if;
	
	/*Gerar quadro movimentos PEL*/

	if (nr_seq_identificador_p in (0,34)) then
		delete	FROM diops_movto_pel
		where	nr_seq_periodo	= nr_seq_periodo_p;
		
		CALL diops_gerar_movimentos_pel( nm_usuario_p, cd_estabelecimento_p,nr_seq_periodo_p, nr_seq_identificador_p);
		
		if (ie_movto_pel_w in ('G', 'GI')) then
			CALL pls_consistir_diops_pck.pls_diops_consist_pel(nr_seq_periodo_p,cd_estabelecimento_p);
		end if;
	end if;
	
	/*Gerar quadro movimentos de contraprestacoes a receber*/

	/*delete	from diops_movto_rec
	where	nr_seq_periodo		= nr_seq_periodo_p;

	diops_gerar_movimentos_rec(nm_usuario_p,nr_seq_periodo_p);*/
	
	
	if (ie_agrup_contratos_w in ('G','GI') and (nr_seq_identificador_p in (0,36))) then
		CALL diops_agrupamento_contrato(nm_usuario_p, nr_seq_periodo_p);
		CALL pls_consistir_diops_pck.pls_diops_consist_contratos(nr_seq_periodo_p,cd_estabelecimento_p);
	end if;
	
	/* ct_ativoInvest */

	if (nr_seq_identificador_p in (0,18)) then
		delete	FROM w_diops_fin_ativo_imob
		where	nr_seq_periodo	= nr_seq_periodo_p;
		
		delete	FROM w_diops_endereco_ativo
		where	nr_seq_periodo	= nr_seq_periodo_p;
		
		delete	FROM w_diops_fin_ativo_invest
		where	nr_seq_periodo	= nr_seq_periodo_p;

		CALL diops_fin_gerar_ativo_vinc(nr_seq_operadora_p, nr_seq_transacao_w, nr_seq_periodo_p, nm_usuario_p);
		CALL pls_consistir_diops_pck.pls_diops_consist_ativo_vinc(nr_seq_periodo_p,cd_estabelecimento_p);
	end if;
	
	/* Gerar quadro auxliar com os custos assistenciais */

	if (nr_seq_identificador_p in (0,31)) then
		CALL diops_fin_gerar_assist_pck.diops_fin_gerar_assistencial(nr_seq_periodo_p, nm_usuario_p, cd_estabelecimento_p);
		CALL pls_consistir_diops_pck.pls_consist_cob_assist(nr_seq_periodo_p,cd_estabelecimento_p);
	end if;
	
	if (nr_seq_identificador_p in (0,23)) then
		/* Obter o numLancamentos do Balancete Ativo */

		select	count(distinct ds_conta)
		into STRICT	qt_lanc_ativo_w
		from	w_diops_fin_mov_ativo
		where	nr_seq_operadora	= nr_seq_operadora_p
		and	nr_seq_periodo		= nr_seq_periodo_p;
	end if;
	
	if (nr_seq_identificador_p in (0,24)) then
		/* Obter o numLancamentos do Balancete Passivo */

		select	count(distinct ds_conta)
		into STRICT	qt_lanc_passivo_w
		from	w_diops_fin_mov_passivo
		where	nr_seq_operadora	= nr_seq_operadora_p
		and	nr_seq_periodo		= nr_seq_periodo_p;
	end if;
	
	if (nr_seq_identificador_p in (0,25)) then
		/* Obter o numLancamentos do Balancete Receita */

		select	count(distinct ds_conta)
		into STRICT	qt_lanc_receita_w
		from	w_diops_fin_mov_receita
		where	nr_seq_operadora	= nr_seq_operadora_p
		and	nr_seq_periodo		= nr_seq_periodo_p;
	end if;
	
	if (nr_seq_identificador_p in (0,26)) then
		/* Obter o numLancamentos do Balancete Despesa */

		select	count(distinct ds_conta)
		into STRICT	qt_lanc_despesa_w
		from	w_diops_fin_mov_despesa
		where	nr_seq_operadora	= nr_seq_operadora_p
		and	nr_seq_periodo		= nr_seq_periodo_p;
	end if;	
		
	if (nr_seq_identificador_p in (0,23,24,25,26)) then	
		insert into w_diops_fin_balancete(nr_sequencia,
			dt_vigencia,
			qt_lancamento_ativo,
			dt_atualizacao,
			nm_usuario,
			nr_seq_operadora,
			qt_lancamento_passivo,
			qt_lancamento_receita,
			qt_lancamento_despesa,
			nr_seq_periodo)
		values (nextval('w_diops_fin_balancete_seq'),
			dt_periodo_inicial_w,
			qt_lanc_ativo_w,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_operadora_p,
			qt_lanc_passivo_w,
			qt_lanc_receita_w,
			qt_lanc_despesa_w,
			nr_seq_periodo_p);
	end if;
	
	/* Eventos corresponsabilidade */

	if (ie_corresp_diops_w in ('G','GI') and (nr_seq_identificador_p in (0,37))) then		
		
		delete	from diops_fin_mov_corresp
		where	nr_seq_periodo	= nr_seq_periodo_p;
		
		insert into diops_fin_mov_corresp(nr_sequencia,
			dt_atualizacao,
			dt_atualizacao_nrec,
			nm_usuario,
			nm_usuario_nrec,
			ie_tipo_movto,
			vl_despesas,
			vl_glosas,
			nr_seq_periodo)
		values (nextval('diops_fin_mov_corresp_seq'),
			clock_timestamp(),
			clock_timestamp(),
			nm_usuario_p,
			nm_usuario_p,
			'BO',
			0,
			0,
			nr_seq_periodo_p);
			
		insert into diops_fin_mov_corresp(nr_sequencia,
			dt_atualizacao,
			dt_atualizacao_nrec,
			nm_usuario,
			nm_usuario_nrec,
			ie_tipo_movto,
			vl_despesas,
			vl_glosas,
			nr_seq_periodo)
		values (nextval('diops_fin_mov_corresp_seq'),
			clock_timestamp(),
			clock_timestamp(),
			nm_usuario_p,
			nm_usuario_p,
			'BC',
			0,
			0,
			nr_seq_periodo_p);
	end if;

	/* Contraprestacoes Pecuniaria */

	if (dt_periodo_inicial_w >= pkg_date_utils.get_dateTime(2019, 01, 01) and ie_contrap_pecun_w in ('G', 'GI') and nr_seq_identificador_p in (0,39)) then
		delete from diops_contrap_pecuniarias
		where nr_seq_periodo = nr_seq_periodo_p;

		delete from w_diops_contrap_pecun
		where nr_seq_periodo = nr_seq_periodo_p;

		CALL gerar_contrap_pecuniaria(nm_usuario_p, nr_seq_periodo_p);
		CALL pls_consistir_diops_pck.pls_diops_consist_contrap_pecu(nr_seq_periodo_p, cd_estabelecimento_w);
	end if;
	
	/* Contraprestacao de Corresponsabilidade Cedida */

	if (dt_periodo_inicial_w >= pkg_date_utils.get_dateTime(2019, 01, 01) and ie_corresp_cedida_w in ('G', 'GI') and nr_seq_identificador_p in (0,40)) then
		delete from diops_movto_corresp_cedida
		where nr_seq_periodo = nr_seq_periodo_p;

		CALL diops_gerar_movimentos_pel(nm_usuario_p, cd_estabelecimento_w, nr_seq_periodo_p, nr_seq_identificador_p);
		CALL pls_consistir_diops_pck.pls_diops_consist_corresp_cedi(nr_seq_periodo_p, cd_estabelecimento_w);
	end if;

	/* Teste de adequacao do passivo */

	 if (dt_periodo_inicial_w >= pkg_date_utils.get_dateTime(2019, 01, 01) and nr_seq_identificador_p in (0,41)) then
		if (nr_seq_identificador_p = 41) then
			delete from diops_teste_tap
			where nr_seq_periodo = nr_seq_periodo_p;
		end if;
		
		select 	count(*)
		into STRICT 	qt_tap_w
		from 	diops_teste_tap
		where 	nr_seq_periodo = nr_seq_periodo_p;

		if (qt_tap_w  = 0) then
			diops_gerar_teste_adeq_passiv(nm_usuario_p,  nr_seq_periodo_p);
		end if;
	end if;

	/* Modelo padrao de capital */

	 if (dt_periodo_inicial_w >= pkg_date_utils.get_dateTime(2019, 01, 01) and nr_seq_identificador_p in (0,42)) then
		if (nr_seq_identificador_p = 42) then
			delete from diops_mod_padrao_capital
			where nr_seq_periodo = nr_seq_periodo_p;
		end if;
		
		select 	count(*)
		into STRICT 	qt_mod_padrao_capital_w
		from 	diops_mod_padrao_capital
		where 	nr_seq_periodo = nr_seq_periodo_p;

		if (qt_mod_padrao_capital_w  = 0) then
			diops_gerar_mod_padrao_capital(nm_usuario_p,  nr_seq_periodo_p);
		end if;
	end if;

	/* Eventos em corresponsabilidade 2018 */

	if (dt_periodo_inicial_w >= pkg_date_utils.get_dateTime(2019, 10, 01) and dt_periodo_final_w <= pkg_date_utils.get_dateTime(2019, 12, 31) and nr_seq_identificador_p = 0) then
		select 	count(*)
		into STRICT	qt_evento_corresp_2018_w
		from	diops_contrap_ev_corresp
		where	nr_seq_periodo = nr_seq_periodo_p;

		if (qt_evento_corresp_2018_w = 0) then
			CALL diops_evento_corresp_2018(nm_usuario_p, nr_seq_periodo_p, cd_estabelecimento_p);
		end if;
	end if;
end if;

update	diops_periodo
set	ie_fluxo_caixa		= ie_fluxo_caixa_w,
	ie_idade_saldo		= ie_idade_saldo_w,
	ie_lucro_prejuizo	= ie_lucro_prejuizo_w,
	ie_solvencia		= ie_solvencia_w,
	ie_balancete_ativo	= ie_balancete_ativo_w,
	ie_balancete_passivo	= ie_balancete_passivo_w,
	ie_balancete_receita	= ie_balancete_receita_w,
	ie_balancete_despesa	= ie_balancete_despesa_w
where	nr_sequencia		= nr_seq_periodo_p;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_diops_financeiro ( nr_seq_operadora_p bigint, nr_seq_periodo_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_identificador_p bigint default 0) FROM PUBLIC;

