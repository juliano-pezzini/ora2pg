-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_arredondamento ( nr_interno_conta_p bigint, nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_material_w			bigint;
nr_sequencia_w			bigint;
qt_total_mat_w			double precision:= 0;
qt_material_w			double precision;
vl_unitario_w			double precision;
vl_total_material_w		double precision:= 0;
vl_material_w			double precision;
vl_arred_correto_w		double precision;
vl_diferenca_w			double precision;
nr_seq_antigo_w			bigint;
cd_setor_atendimento_w	integer;
cd_convenio_w			integer;
ie_arred_multiplicado_w	varchar(1):= 'S';
cd_estabelecimento_w 	bigint;
dt_conta_w				timestamp;

C01 CURSOR FOR
	SELECT	nr_sequencia,
		CASE WHEN vl_material=0 THEN 0  ELSE qt_material END ,
		vl_unitario,
		vl_material
	from	material_atend_paciente
	where	cd_material = cd_material_w
	and 	nr_interno_conta = nr_interno_conta_p
	and 	cd_setor_atendimento = cd_setor_atendimento_w
	and	((ie_arred_multiplicado_w = 'S') or (ie_arred_multiplicado_w = 'D' and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_conta_w) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_conta)))
	and 	coalesce(nr_seq_proc_pacote::text, '') = ''
	and 	coalesce(cd_motivo_exc_conta::text, '') = ''
	order by nr_sequencia;
				

BEGIN

/*Exemplo:

Item	Qt Material		vl Unitario		vl Material
66	1		0,2070		0,21
66	1		0,2070		0,21
66	1		0,2070		0,21
66	1		0,2070		0,21
66	1		0,2070		0,21

	5 x 0,2070 = 1,0350  (Arredondando fica 1,04 = vl_arred_correto_w)
	Na conta ficaria a soma da coluna vl Material (0,21 + 0,21 + 0,21 + 0,21 + 0,21 + 0,21 = 1,05)

	OS de Origem 202736 HSC
	Retirar a diferenca e colocar no ultimo lancamento do item
*/
select	coalesce(max(cd_convenio_parametro),0),
		coalesce(max(cd_estabelecimento),0)
into STRICT	cd_convenio_w,
		cd_estabelecimento_w
from	conta_paciente
where	nr_interno_conta = nr_interno_conta_p;

select	coalesce(max(ie_arred_multiplicado),'S')
into STRICT	ie_arred_multiplicado_w
from	convenio_estabelecimento
where	cd_convenio			  = cd_convenio_w
and		cd_estabelecimento 	  = cd_estabelecimento_w;

select 	coalesce(max(cd_material),0),
		coalesce(max(cd_setor_atendimento),0),
		coalesce(max(dt_conta),clock_timestamp())
into STRICT	cd_material_w,
		cd_setor_atendimento_w,
		dt_conta_w
from 	material_atend_paciente
where 	nr_sequencia = nr_sequencia_p;

select	max(nr_sequencia)
into STRICT	nr_seq_antigo_w
from	material_atend_paciente
where	cd_material = cd_material_w
and 	nr_interno_conta = nr_interno_conta_p
and 	coalesce(nr_seq_proc_pacote::text, '') = ''
and 	coalesce(cd_motivo_exc_conta::text, '') = ''
and 	cd_setor_atendimento = cd_setor_atendimento_w
and	((ie_arred_multiplicado_w = 'S') or (ie_arred_multiplicado_w = 'D' and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_conta_w) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_conta)))
and 	nr_sequencia <> nr_sequencia_p
and	coalesce(vl_tabela_original,0) <> vl_material;


if (coalesce(nr_seq_antigo_w,0) > 0) then
	update	material_atend_paciente
	set 	vl_material = coalesce(vl_tabela_original,vl_material),
		vl_tabela_original  = NULL
	where 	nr_sequencia = nr_seq_antigo_w;	
	
	--if (nvl(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;  (retirado OS 885394)
end if;

qt_total_mat_w		:= 0;
vl_total_material_w	:= 0;
vl_arred_correto_w	:= 0;
vl_diferenca_w		:= 0;

open C01;
loop
fetch C01 into	
	nr_sequencia_w,
	qt_material_w,
	vl_unitario_w,
	vl_material_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	nr_sequencia_w		:= nr_sequencia_w;
	vl_unitario_w		:= vl_unitario_w;
	qt_total_mat_w		:= qt_total_mat_w + qt_material_w;
	vl_total_material_w	:= vl_total_material_w + vl_material_w;
	end;
end loop;
close C01;


vl_arred_correto_w	:= qt_total_mat_w * vl_unitario_w;
vl_diferenca_w		:= (vl_total_material_w - vl_arred_correto_w);


if (vl_diferenca_w <> 0) then
	update	material_atend_paciente
	set 	vl_material = vl_material - vl_diferenca_w,
		vl_tabela_original = vl_material
	where 	nr_sequencia = nr_sequencia_w;
end if;

--if (nvl(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;  (retirado OS 885394)
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_arredondamento ( nr_interno_conta_p bigint, nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

