-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_aprovacao_documento (nm_tabela_p text, nm_chave_p text, qt_chave_p bigint, nm_usuario_p text, nr_seq_item_pront_p bigint default NULL) AS $body$
DECLARE

				
nr_seq_item_w bigint;
nr_seq_doc_w 	  bigint;
ds_sql		  varchar(1000);
nr_cirurgia_w bigint;
nr_atendimento_w bigint;
ie_equipe_cirurgica_w varchar(1);
cd_funcao_w bigint;
qt_approvers bigint;

  cline RECORD;

BEGIN

cd_funcao_w := wheb_usuario_pck.get_cd_funcao;
    begin
        select
            nr_sequencia 
        into STRICT 
            nr_seq_item_w
        from (
            SELECT 
                mi.nr_sequencia
            from 
                mult_aprov_funcao mf
            inner join mult_aprov_item mi on mi.nr_seq_funcao = mf.nr_sequencia
            inner join objeto_schematic os  on os.nr_sequencia = mi.nr_seq_doc
            where 
                mf.cd_funcao = cd_funcao_w
            and 
                os.nm_tabela = nm_tabela_p
            and 
                mf.ie_situacao = 'A'
            order by mi.nr_sequencia desc) alias0 LIMIT 1;
    exception when no_data_found then
        nr_seq_item_w:= null;
        ie_equipe_cirurgica_w := null;
    end;
        select
        count(*)
    into STRICT 
        qt_approvers
    from (SELECT 
                mp.cd_pessoa_fisica cd_pessoa_fisica, 
                mp.nr_seq_funcao_pf cd_funcao
            from
                mult_aprov_prof mp
            where 
                mp.nr_seq_item = nr_seq_item_w
            and
                mp.ie_equipe_cirurgica = 'N'
            
union

            SELECT 
                cp.cd_pessoa_fisica cd_pessoa_fisica, 
                null cd_funcao
            from
                cirurgia_participante cp,
                mult_aprov_prof mp
            where
                mp.nr_seq_item = nr_seq_item_w
            and
                cp.nr_cirurgia = nr_cirurgia_w
            and 
                coalesce(mp.ie_equipe_cirurgica, 'N') = 'S'
            and
                cp.ie_situacao = 'A') alias2;

    if ((nr_seq_item_w IS NOT NULL AND nr_seq_item_w::text <> '') and qt_approvers > 0) then

        if (cd_funcao_w = 872) then
            if (nm_chave_p <> 'NR_CIRURGIA') then
                ds_sql := 'select max(nr_cirurgia) from '||nm_tabela_p|| ' where ' || nm_chave_p || ' = ' || qt_chave_p;
                EXECUTE ds_sql into STRICT nr_cirurgia_w;
            else
                nr_cirurgia_w := qt_chave_p;
            end if;
        else
            if (nm_chave_p <> 'NR_ATENDIMENTO') then
                if (upper(nm_tabela_p) = 'MED_RECEITA') then
                    ds_sql := 'select max(nr_atendimento_hosp) from '||nm_tabela_p|| ' where '|| nm_chave_p || ' = ' || qt_chave_p;
                else
                    ds_sql := 'select max(nr_atendimento) from '||nm_tabela_p|| ' where '|| nm_chave_p || ' = ' || qt_chave_p;
                end if;
                EXECUTE ds_sql into STRICT nr_atendimento_w;
            else 
                nr_atendimento_w := qt_chave_p;
            end if;
        end if;

        IF ((nm_tabela_p = 'EHR_REGISTRO' and nr_seq_item_pront_p > 0) OR nm_tabela_p != 'EHR_REGISTRO') then
            insert into documento_aprovacao(
                nr_sequencia,
                nm_usuario,
                dt_atualizacao,
                nm_usuario_nrec,
                dt_atualizacao_nrec,
                nm_tabela_origem,
                nr_seq_origem,
                ie_status,
                nr_cirurgia,
                nr_atendimento,
                nr_seq_funcao,
                nr_seq_item_pront,
                ie_situacao
            )
            VALUES (
                nextval('documento_aprovacao_seq'),
                nm_usuario_p,
                clock_timestamp(),
                nm_usuario_p,
                clock_timestamp(),
                nm_tabela_p,
                qt_chave_p,
                'N',
                nr_cirurgia_w,
                nr_atendimento_w,
                cd_funcao_w,
                nr_seq_item_pront_p,
                'N'
            ) returning nr_sequencia into nr_seq_doc_w;

            for cline in (select 
                        mp.cd_pessoa_fisica cd_pessoa_fisica, 
                        mp.nr_seq_funcao_pf cd_funcao
                    from
                        mult_aprov_prof mp
                    where 
                        mp.nr_seq_item = nr_seq_item_w
                    and
                        mp.ie_equipe_cirurgica = 'N'
                    
union

                    select 
                        cp.cd_pessoa_fisica cd_pessoa_fisica, 
                        null cd_funcao
                    from
                        cirurgia_participante cp,
                        mult_aprov_prof mp
                    where
                        mp.nr_seq_item = nr_seq_item_w
                    and
                        cp.nr_cirurgia = nr_cirurgia_w
                    and 
                        coalesce(mp.ie_equipe_cirurgica, 'N') = 'S'
                    and
                        cp.ie_situacao = 'A')
            loop
                insert into documento_aprov_prof(
                    nr_sequencia,
                    dt_atualizacao,
                    nm_usuario,
                    dt_atualizacao_nrec,
                    nm_usuario_nrec,
                    cd_pessoa_fisica,
                    nr_seq_doc,
                    nr_seq_funcao_pf,
                    dt_aprovacao,
                    dt_ret_aprovacao,
                    ie_status,
                    ds_just_ret_aprov
                ) values (
                    nextval('documento_aprov_prof_seq'),
                    clock_timestamp(),
                    nm_usuario_p,
                    clock_timestamp(), 
                    nm_usuario_p,
                    cline.cd_pessoa_fisica,
                    nr_seq_doc_w, 
                    cline.cd_funcao,
                    null, 
                    null, 
                    'N',
                    null 
                );
            end loop;
            commit;
        end if;
    end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_aprovacao_documento (nm_tabela_p text, nm_chave_p text, qt_chave_p bigint, nm_usuario_p text, nr_seq_item_pront_p bigint default NULL) FROM PUBLIC;

