-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_aprazamento (cd_estabelecimento_p bigint, nr_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_item_p bigint, cd_item_p text, cd_intervalo_p text, qt_item_p bigint, ie_tipo_item_p text, ie_acm_sn_p text, nr_prescricoes_p text, dt_horario_p timestamp, qt_hora_prescricao_p bigint, ds_consistencia_p INOUT text, nm_usuario_p text, cd_unidade_medida_p text default null, ie_via_aplicacao_p text DEFAULT NULL, nr_seq_cpoe_p bigint default null) AS $body$
DECLARE


qt_hor_inv_w			bigint;
qt_hor_dupl_w			bigint;
nr_horas_val_w			bigint;
qt_interv_w				bigint;
qt_hor_int_w			bigint;
dt_validade_w			timestamp;
dt_validade_prescr_w	timestamp;
dt_suspensao_cpoe_w		timestamp;
dt_fim_cpoe_w			timestamp;
dt_inicio_prescr_w		timestamp;
qt_min_intervalo_w		bigint;
qt_horas_apraz_w		bigint;
cd_setor_pac_w			integer;
ie_consistir_acm_w		varchar(1);
varie_permite_apraz_w	varchar(5);
ie_permite_aprazar_w	varchar(1);
ie_dieta_intervalo_w	varchar(1);
ie_acm_intervalo_w		varchar(1);
ie_sn_intervalo_w		varchar(1);
ds_consistencia_w		varchar(255) := null;
qt_hor_aprazamento_w	bigint;
ie_controla_intervalo_w	varchar(1);
ie_qt_operacao_nulo_w	varchar(1);
ie_apraz_regra_w		varchar(1);
nr_etapa_apraz_hemo_w	bigint;
qt_procedimento_hemo_w	bigint;
ie_grava_log_rastr_w	varchar(1);


BEGIN

CALL Wheb_assist_pck.set_informacoes_usuario(cd_estabelecimento_p, obter_perfil_ativo, nm_usuario_p);
ie_dieta_intervalo_w	:= Wheb_assist_pck.obterParametroFuncao(924,710);

ie_permite_aprazar_w	:= Wheb_assist_pck.obterParametroFuncao(1113,271);
qt_horas_apraz_w		:= Wheb_assist_pck.obterParametroFuncao(1113,388);
varie_permite_apraz_w	:= Wheb_assist_pck.obterParametroFuncao(1113,489);
ie_consistir_acm_w		:= Wheb_assist_pck.obterParametroFuncao(1113,194);

ie_grava_log_rastr_w := obter_rastreabilidade_adep(nr_prescricao_p, 'APR');

if (ie_grava_log_rastr_w = 'S') then
	CALL adep_gerar_log_rastr(substr('CONSISTIR_APRAZAMENTO / PARAMETERS IN' || chr(10) ||
		'"cd_estabelecimento_p" : "'||cd_estabelecimento_p||'",'||chr(10)||
		'"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
		'"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
		'"cd_unidade_medida_p" : "'||cd_unidade_medida_p||'",'||chr(10)||
		'"ds_consistencia_p" : "'||ds_consistencia_p||'",'||chr(10)||
		'"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
		'"ie_acm_sn_p" : "'||ie_acm_sn_p||'",'||chr(10)||
		'"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
		'"ie_via_aplicacao_p" : "'||ie_via_aplicacao_p||'",'||chr(10)||
		'"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
		'"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
		'"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
		'"nr_prescricoes_p" : "'||nr_prescricoes_p||'",'||chr(10)||
		'"nr_seq_cpoe_p" : "'||nr_seq_cpoe_p||'",'||chr(10)||
		'"nr_seq_item_p" : "'||nr_seq_item_p||'",'||chr(10)||
		'"qt_hora_prescricao_p" : "'||qt_hora_prescricao_p||'",'||chr(10)||
		'"ie_consistir_acm_w" : "'||ie_consistir_acm_w||'",'||chr(10)||
		'"ie_dieta_intervalo_w" : "'||ie_dieta_intervalo_w||'",'||chr(10)||
		'"ie_permite_aprazar_w" : "'||ie_permite_aprazar_w||'",'||chr(10)||
		'"qt_horas_apraz_w" : "'||qt_horas_apraz_w||'",'||chr(10)||
		'"varie_permite_apraz_w" : "'||varie_permite_apraz_w||'",'||chr(10)||
		'"qt_item_p" : "'||qt_item_p||'"}',1,1500));
end if;


if (qt_horas_apraz_w = 0) then
	dt_validade_w		:= clock_timestamp() - qt_hora_prescricao_p / 24;
else
	dt_validade_w		:= clock_timestamp() - qt_horas_apraz_w / 24;
end if;

ie_apraz_regra_w := obter_apraz_reapraz_regra(	ie_tipo_item_p => ie_tipo_item_p,
							nr_atendimento_p => nr_atendimento_p,
							ie_acao_p => 'A',
							nm_usuario_p => nm_usuario_p);
if (ie_apraz_regra_w <> 'S') then
	-- Voce nao tem permissao para efetuar essa acao. Cadastros gerais / ADEP - Regra permissao de aprazamento/reaprazamento
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1134375);
end if;

cd_setor_pac_w		:= Obter_Unidade_Atendimento(nr_atendimento_p, 'IA', 'CS');
/*tasy_gerar_dump;*/
 /* Rafael em 11/04/2008 OS89274 */

select	coalesce(max(ie_acm),'N'),
		coalesce(max(ie_se_necessario),'N')
into STRICT	ie_acm_intervalo_w,
		ie_sn_intervalo_w
from	intervalo_prescricao where	cd_intervalo = cd_intervalo_p LIMIT 1;

if (ie_tipo_item_p = 'D') then

	/* verificar validade prescricoes */

	select	count(*)
	into STRICT	qt_hor_inv_w
	from	prescr_medica where	dt_horario_p between dt_inicio_prescr and dt_validade_prescr
	and		obter_se_valor_contido(nr_prescricao,coalesce(nr_prescricoes_p,nr_prescricao)) = 'S'
	and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,cd_setor_atendimento,coalesce(ie_adep,'S')) = 'S'
	and		dt_validade_prescr > dt_validade_w
	and		nr_atendimento = nr_atendimento_p LIMIT 1;
	
	
	if (qt_hor_inv_w = 0) then
	
		select	max(dt_validade_prescr),
				min(dt_inicio_prescr)
		into STRICT	dt_validade_prescr_w,
				dt_inicio_prescr_w
		from	prescr_medica where	obter_se_valor_contido(nr_prescricao,coalesce(nr_prescricoes_p,nr_prescricao)) = 'S'
		and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,cd_setor_atendimento,coalesce(ie_adep,'S')) = 'S'
		and		dt_validade_prescr > dt_validade_w
		and		nr_atendimento = nr_atendimento_p LIMIT 1;
		
		if (dt_validade_prescr_w IS NOT NULL AND dt_validade_prescr_w::text <> '' AND dt_inicio_prescr_w IS NOT NULL AND dt_inicio_prescr_w::text <> '') then	
			ds_consistencia_w := wheb_mensagem_pck.get_texto(294663, 'VALMINIMA='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_inicio_prescr_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)||';VALMAX='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_validade_prescr_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone));
		else
			ds_consistencia_w := wheb_mensagem_pck.get_texto(294671);	
		end if;
			
	end if;	
	
	select	count(*)
	into STRICT	qt_hor_inv_w
	from	prescr_medica 	a,
			prescr_dieta	b,
			cpoe_dieta 		c
	where	a.nr_prescricao = b.nr_prescricao
	and		b.nr_seq_dieta_cpoe = c.nr_sequencia
	and		dt_horario_p > coalesce(cpoe_obter_termino_item(c.nr_sequencia, 'N'),a.dt_validade_prescr)
	and		obter_se_valor_contido(a.nr_prescricao,coalesce(nr_prescricoes_p,a.nr_prescricao)) = 'S'
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		to_char(b.cd_dieta) = cd_item_p
	and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
	and		a.dt_validade_prescr > dt_validade_w
	and		a.nr_atendimento = nr_atendimento_p
	and 	((coalesce(c.nr_sequencia, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
	
	
	if (qt_hor_inv_w > 0) then
	
		select	max(c.dt_suspensao),
				max(c.dt_fim)
		into STRICT	dt_suspensao_cpoe_w,
				dt_fim_cpoe_w
		from	prescr_medica 	a,
				prescr_dieta	b,
				cpoe_dieta 		c
		where	a.nr_prescricao = b.nr_prescricao
		and		b.nr_seq_dieta_cpoe = c.nr_sequencia
		and		dt_horario_p > cpoe_obter_termino_item(c.nr_sequencia, 'N')
		and		obter_se_valor_contido(a.nr_prescricao,coalesce(nr_prescricoes_p,a.nr_prescricao)) = 'S'
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		to_char(b.cd_dieta) = cd_item_p
		and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
		and		a.dt_validade_prescr > dt_validade_w
		and		a.nr_atendimento = nr_atendimento_p
		and 	((coalesce(c.nr_sequencia, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = ''))
		and             c.cd_funcao_origem = 2314 LIMIT 1;		
		
		if (dt_suspensao_cpoe_w IS NOT NULL AND dt_suspensao_cpoe_w::text <> '') then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(820331,null) || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_suspensao_cpoe_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone);
		elsif (dt_fim_cpoe_w IS NOT NULL AND dt_fim_cpoe_w::text <> '') then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(820333,null) || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_fim_cpoe_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone);			
		end if;
			
	end if;
	
	/* verificar horarios duplicados */

	if (ie_dieta_intervalo_w = 'N') then
		select	count(*)
		into STRICT	qt_hor_dupl_w
		from	prescr_dieta_hor a where	a.cd_refeicao			= cd_item_p
		and	a.dt_horario			= dt_horario_p
		and	coalesce(a.ie_situacao,'A')		= 'A'
		and	obter_se_valor_contido(a.nr_prescricao,nr_prescricoes_p) = 'S'
		and	Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S' LIMIT 1;
	else
		select	count(*)
		into STRICT	qt_hor_dupl_w
		from	prescr_dieta b,
			prescr_dieta_hor a where	a.nr_prescricao	= b.nr_prescricao
		and	a.nr_seq_dieta	= b.nr_sequencia
		and	coalesce(a.cd_refeicao::text, '') = ''
		and	to_char(b.cd_dieta) = cd_item_p
		and	a.dt_horario			= dt_horario_p
		and	coalesce(a.ie_situacao,'A')		= 'A'
		and	obter_se_valor_contido(a.nr_prescricao,nr_prescricoes_p) = 'S'
		and	Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S' LIMIT 1;	
	end if;
	
	if (qt_hor_dupl_w > 0) then		
		--ds_consistencia_w := 'O horario informado ja esta previsto para este item, favor verificar.';
		ds_consistencia_w := wheb_mensagem_pck.get_texto(294664, null);
	end if;	
	
elsif (ie_tipo_item_p = 'S') then

	/* verificar validade prescricoes */

	/*
	select	count(*)
	into	qt_hor_inv_w
	from	prescr_medica
	where	rownum = 1 and	dt_horario_p between dt_inicio_prescr and dt_validade_prescr
	and	obter_se_valor_contido(nr_prescricao,nvl(nr_prescricoes_p,nr_prescricao)) = 'S';
	*/
	
	select	count(*)
	into STRICT	qt_hor_inv_w
	from	prescr_medica where	((dt_horario_p between dt_inicio_prescr and dt_validade_prescr) or (dt_horario_p between dt_prescricao and dt_validade_prescr) and (coalesce(ie_acm_sn_p,'N') = 'S'))
	and	obter_se_valor_contido(nr_prescricao,coalesce(nr_prescricoes_p,nr_prescricao)) = 'S'
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,cd_setor_atendimento,coalesce(ie_adep,'S')) = 'S'
	and	dt_validade_prescr > dt_validade_w
	and	nr_atendimento = nr_atendimento_p LIMIT 1;

	if (qt_hor_inv_w = 0) then
	
		select	max(dt_validade_prescr),
			min(dt_inicio_prescr)
		into STRICT	dt_validade_prescr_w,
			dt_inicio_prescr_w
		from	prescr_medica where	obter_se_valor_contido(nr_prescricao,coalesce(nr_prescricoes_p,nr_prescricao)) = 'S'
		and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,cd_setor_atendimento,coalesce(ie_adep,'S')) = 'S'
		and	dt_validade_prescr > dt_validade_w
		and	nr_atendimento = nr_atendimento_p LIMIT 1;

		if (dt_validade_prescr_w IS NOT NULL AND dt_validade_prescr_w::text <> '' AND dt_inicio_prescr_w IS NOT NULL AND dt_inicio_prescr_w::text <> '') then	
			ds_consistencia_w := wheb_mensagem_pck.get_texto(294663, 'VALMINIMA='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_inicio_prescr_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)||';VALMAX='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_validade_prescr_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone));
		else
			ds_consistencia_w := wheb_mensagem_pck.get_texto(294671);	
		end if;
		
	end if;	
	
	select	count(*)
	into STRICT	qt_hor_inv_w
	from	prescr_medica 	a,
			prescr_material	b,
			cpoe_dieta 		c
	where	a.nr_prescricao = b.nr_prescricao
	and		b.nr_seq_dieta_cpoe = c.nr_sequencia
	and		dt_horario_p > coalesce(cpoe_obter_termino_item(c.nr_sequencia, 'N'),a.dt_validade_prescr)
	and		obter_se_valor_contido(a.nr_prescricao,coalesce(nr_prescricoes_p,a.nr_prescricao)) = 'S'
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		b.cd_material = cd_item_p
	and		b.ie_agrupador = 12
	and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
	and		a.dt_validade_prescr > dt_validade_w
	and		a.nr_atendimento = nr_atendimento_p
	and 	((coalesce(c.nr_sequencia, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;	
	
	if (qt_hor_inv_w > 0) then
	
		select	max(c.dt_suspensao),
				max(c.dt_fim)
		into STRICT	dt_suspensao_cpoe_w,
				dt_fim_cpoe_w
		from	prescr_medica 	a,
				prescr_material	b,
				cpoe_dieta 		c
		where	a.nr_prescricao = b.nr_prescricao
		and		b.nr_seq_dieta_cpoe = c.nr_sequencia
		and		dt_horario_p > cpoe_obter_termino_item(c.nr_sequencia, 'N')
		and		obter_se_valor_contido(a.nr_prescricao,coalesce(nr_prescricoes_p,a.nr_prescricao)) = 'S'
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		b.ie_agrupador = 12
		and		b.cd_material				= cd_item_p
		and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
		and		a.dt_validade_prescr > dt_validade_w
		and		a.nr_atendimento = nr_atendimento_p
		and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')		
		and 	((coalesce(c.nr_sequencia, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = ''))
		and             c.cd_funcao_origem = 2314 LIMIT 1;
		
		if (dt_suspensao_cpoe_w IS NOT NULL AND dt_suspensao_cpoe_w::text <> '') then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(820331,null) || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_suspensao_cpoe_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone);
		elsif (dt_fim_cpoe_w IS NOT NULL AND dt_fim_cpoe_w::text <> '') then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(820333,null) || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_fim_cpoe_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone);			
		end if;
			
	end if;

	/* verificar horarios duplicados */

	select	count(*)
	into STRICT	qt_hor_dupl_w
	from	prescr_material b,
			prescr_mat_hor a,
			prescr_medica c where	b.nr_prescricao			= a.nr_prescricao
	and		b.nr_sequencia			= a.nr_seq_material
	and		coalesce(cd_unidade_medida_p,'XPTO')	in ('XPTO', a.cd_unidade_medida_dose)
	and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')
	--and		nvl(b.qt_dose,1)		= nvl(qt_item_p,1)
	and		coalesce(b.qt_dose,1)		= coalesce(qt_item_p,coalesce(b.qt_dose,1))
	and		a.ie_agrupador			= 12
	and		a.cd_material				= cd_item_p
	and		a.dt_horario				= dt_horario_p
	and		coalesce(a.ie_horario_especial,'N')	= 'N'
	and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_material,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
	and		c.nr_prescricao = b.nr_prescricao
	and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
	and		coalesce(c.ie_adep,'S') = 'S'
	and		coalesce(a.ie_situacao,'A') = 'A'
	and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
	and		c.dt_validade_prescr > dt_validade_w
	and		c.nr_atendimento = nr_atendimento_p
	and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
	and 	((coalesce(b.nr_seq_dieta_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
	
	if (qt_hor_dupl_w > 0) then
		--'O horario informado ja esta previsto para este item, favor verificar.#@#@');
		ds_consistencia_w := wheb_mensagem_pck.get_texto(294664, null);
	end if;
	
	/* verificar intervalo */

	if (cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') then
	
		/* obter horas validade prescricao */

		if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then
			select	max(nr_horas_validade)
			into STRICT	nr_horas_val_w
			from	prescr_medica where	nr_prescricao = nr_prescricao_p LIMIT 1;
		elsif (nr_prescricoes_p IS NOT NULL AND nr_prescricoes_p::text <> '') then
			nr_horas_val_w := OBTER_VALOR_DINAMICO_IN_BV(''||
				' select 	max(nr_horas_validade) '||
				' from 		prescr_medica '||
				' where	rownum = 1 and 	nr_prescricao in :nr_prescricoes', '', ':nr_prescricoes', nr_prescricoes_p, ',', nr_horas_val_w);
		end if;

		/* obter ocorrencia intervalo */

		qt_interv_w := obter_ocorrencia_intervalo(cd_intervalo_p,nr_horas_val_w,'H');
		
		/* verificar horarios anteriores x intervalo */

		select	count(1)
		into STRICT	qt_hor_int_w
		from	prescr_material b,
				prescr_mat_hor a,
				prescr_medica c,
				cpoe_dieta d where		b.nr_prescricao			= a.nr_prescricao
		and		b.nr_sequencia			= a.nr_seq_material
		and		b.nr_seq_dieta_cpoe 	= d.nr_sequencia
		and		coalesce(cd_unidade_medida_p,'XPTO')	in ('XPTO', a.cd_unidade_medida_dose)
		and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')
		--and		nvl(b.qt_dose,1)		= nvl(qt_item_p,1)
		and		coalesce(b.qt_dose,1)		= coalesce(qt_item_p,coalesce(b.qt_dose,1))
		and		a.ie_agrupador			= 12
		and		a.cd_material				= cd_item_p
		and		a.dt_horario				< dt_horario_p
		and		a.dt_horario				> dt_horario_p - qt_interv_w / 24
		and		coalesce(a.ie_horario_especial,'N')	= 'N'
		and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_material,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
		and		c.nr_prescricao = b.nr_prescricao
		and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
		and		coalesce(c.ie_adep,'S') = 'S'
		and		coalesce(a.ie_dose_especial,'N') = 'N'
		and		coalesce(a.ie_situacao,'A') = 'A'
		and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
		and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
		and		c.dt_validade_prescr > dt_validade_w
		and		c.nr_atendimento = nr_atendimento_p
		and 	((coalesce(d.nr_sequencia, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
		
		if (qt_hor_int_w > 0) and (varie_permite_apraz_w <> 'S') then			
			--ds_consistencia_w := 'O horario informado nao esta de acordo com o intervalo previsto para este item, favor verificar.';
			ds_consistencia_w := wheb_mensagem_pck.get_texto(1112863, null);			
		end if;
		
		/* verificar horarios posteriores x intervalo */

		select	count(1)
		into STRICT	qt_hor_int_w
		from	prescr_material b,
				prescr_mat_hor a,
				prescr_medica c,
				cpoe_dieta d where		b.nr_prescricao			= a.nr_prescricao
		and		b.nr_sequencia			= a.nr_seq_material
		and		b.nr_seq_dieta_cpoe 	= d.nr_sequencia
		and		coalesce(cd_unidade_medida_p,'XPTO')	in ('XPTO', a.cd_unidade_medida_dose)
		and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')
		--and		nvl(b.qt_dose,1)		= nvl(qt_item_p,1)
		and		coalesce(b.qt_dose,1)		= coalesce(qt_item_p,coalesce(b.qt_dose,1))
		and		a.ie_agrupador			= 12
		and		a.cd_material				= cd_item_p
		and		a.dt_horario				> dt_horario_p
		and		a.dt_horario				< dt_horario_p + qt_interv_w / 24
		and		coalesce(a.ie_horario_especial,'N')	= 'N'
		and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_material,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
		and		c.nr_prescricao = b.nr_prescricao
		and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
		and		coalesce(a.ie_adep,'S') = 'S'
		and		coalesce(a.ie_dose_especial,'N') = 'N'
		and		coalesce(a.ie_situacao,'A') = 'A'
		and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
		and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
		and		c.dt_validade_prescr > dt_validade_w
		and		c.nr_atendimento = nr_atendimento_p
		and 	((coalesce(d.nr_sequencia, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
		
		if (qt_hor_int_w > 0) and (varie_permite_apraz_w <> 'S') then
			--'O horario informado nao esta de acordo com o intervalo previsto para este item, favor verificar.#@#@');
			ds_consistencia_w := wheb_mensagem_pck.get_texto(1112863, null);			
		end if;		
		
	end if;	
	
elsif (ie_tipo_item_p in ('M', 'IAH')) then

	if (ie_grava_log_rastr_w = 'S') then
		CALL adep_gerar_log_rastr(substr(' CONSISTIR_APRAZAMENTO (M, IAH) PARAMETERS AND VARIABLES' || chr(10) ||
			'"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
			'"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
			'"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
			'"cd_unidade_medida_p" : "'||cd_unidade_medida_p||'",'||chr(10)||
			'"ds_consistencia_w" : "'||ds_consistencia_w||'",'||chr(10)||
			'"dt_fim_cpoe_w" : "'||to_char(dt_fim_cpoe_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
			'"dt_horario_p" : "'||to_char(dt_horario_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
			'"dt_inicio_prescr_w" : "'||to_char(dt_inicio_prescr_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
			'"dt_suspensao_cpoe_w" : "'||to_char(dt_suspensao_cpoe_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
			'"dt_validade_prescr_w" : "'||to_char(dt_validade_prescr_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
			'"dt_validade_w" : "'||to_char(dt_validade_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
			'"ie_acm_intervalo_w" : "'||ie_acm_intervalo_w||'",'||chr(10)||
			'"ie_acm_sn_p" : "'||ie_acm_sn_p||'",'||chr(10)||
			'"ie_consistir_acm_w" : "'||ie_consistir_acm_w||'",'||chr(10)||
			'"ie_controla_intervalo_w" : "'||ie_controla_intervalo_w||'",'||chr(10)||
			'"ie_permite_aprazar_w" : "'||ie_permite_aprazar_w||'",'||chr(10)||
			'"ie_qt_operacao_nulo_w" : "'||ie_qt_operacao_nulo_w||'",'||chr(10)||
			'"ie_sn_intervalo_w" : "'||ie_sn_intervalo_w||'",'||chr(10)||
			'"ie_via_aplicacao_p" : "'||ie_via_aplicacao_p||'",'||chr(10)||
			'"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
			'"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
			'"nr_horas_val_w" : "'||nr_horas_val_w||'",'||chr(10)||
			'"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
			'"nr_prescricoes_p" : "'||nr_prescricoes_p||'",'||chr(10)||
			'"nr_seq_cpoe_p" : "'||nr_seq_cpoe_p||'",'||chr(10)||
			'"nr_seq_item_p" : "'||nr_seq_item_p||'",'||chr(10)||
			'"qt_hor_aprazamento_w" : "'||qt_hor_aprazamento_w||'",'||chr(10)||
			'"qt_hor_dupl_w" : "'||qt_hor_dupl_w||'",'||chr(10)||
			'"qt_hor_int_w" : "'||qt_hor_int_w||'",'||chr(10)||
			'"qt_hor_inv_w" : "'||qt_hor_inv_w||'",'||chr(10)||
			'"qt_interv_w" : "'||qt_interv_w||'",'||chr(10)||
			'"qt_item_p" : "'||qt_item_p||'",'||chr(10)||
			'"qt_min_intervalo_w" : "'||qt_min_intervalo_w||'",'||chr(10)||
			'"varie_permite_apraz_w" : "'||varie_permite_apraz_w||'"}',1,1500));
	end if;

	/* verificar validade prescricoes */

		
	select	count(*)
	into STRICT	qt_hor_inv_w
	from	prescr_medica a where	dt_horario_p between a.dt_inicio_prescr and a.dt_validade_prescr	
	and		obter_se_valor_contido(a.nr_prescricao,coalesce(nr_prescricoes_p,a.nr_prescricao)) = 'S'
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
	and		a.dt_validade_prescr > dt_validade_w
	and		a.nr_atendimento = nr_atendimento_p LIMIT 1;
	
	if (qt_hor_inv_w = 0) then
	
		select	max(dt_validade_prescr),
				min(dt_inicio_prescr)
		into STRICT	dt_validade_prescr_w,
				dt_inicio_prescr_w
		from	prescr_medica where	obter_se_valor_contido(nr_prescricao,coalesce(nr_prescricoes_p,nr_prescricao)) = 'S'
		and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,cd_setor_atendimento,coalesce(ie_adep,'S')) = 'S'
		and		dt_validade_prescr > dt_validade_w
		and		nr_atendimento = nr_atendimento_p LIMIT 1;
		
		if	((ie_acm_sn_p = 'S' AND ie_permite_aprazar_w = 'T') or (ie_permite_aprazar_w = 'S')) and (dt_horario_p < dt_inicio_prescr_w) then
			ds_consistencia_w := null;
		else
		
			if (dt_validade_prescr_w IS NOT NULL AND dt_validade_prescr_w::text <> '' AND dt_inicio_prescr_w IS NOT NULL AND dt_inicio_prescr_w::text <> '') then	
				ds_consistencia_w := wheb_mensagem_pck.get_texto(294663, 'VALMINIMA='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_inicio_prescr_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)||';VALMAX='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_validade_prescr_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone));
			else
				ds_consistencia_w := wheb_mensagem_pck.get_texto(294671);	
			end if;

		end if;
	end if;	
	
	select	count(*)
	into STRICT	qt_hor_inv_w
	from	prescr_medica 	a,
			prescr_material	b,
			cpoe_material c
	where	a.nr_prescricao = b.nr_prescricao
	and		b.nr_seq_mat_cpoe = c.nr_sequencia
	and		dt_horario_p > coalesce(cpoe_obter_termino_item(c.nr_sequencia, 'M'), a.dt_validade_prescr)
	and		obter_se_valor_contido(a.nr_prescricao,coalesce(nr_prescricoes_p,a.nr_prescricao)) = 'S'
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		c.cd_material = cd_item_p
	and		b.ie_agrupador = 1
	and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
	and		a.dt_validade_prescr > dt_validade_w
	and		a.nr_atendimento = nr_atendimento_p
	and 	((coalesce(c.nr_sequencia, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
		
	if (qt_hor_inv_w > 0) then
	
		select	max(c.dt_suspensao),
				max(c.dt_fim)
		into STRICT	dt_suspensao_cpoe_w,
				dt_fim_cpoe_w
		from	prescr_medica a,
				prescr_material	b,
				cpoe_material c
		where	a.nr_prescricao = b.nr_prescricao
		and		b.nr_seq_mat_cpoe = c.nr_sequencia
		and		dt_horario_p > cpoe_obter_termino_item(c.nr_sequencia, 'M')
		and		obter_se_valor_contido(a.nr_prescricao,coalesce(nr_prescricoes_p,a.nr_prescricao)) = 'S'
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		c.cd_material = cd_item_p
		and		b.ie_agrupador = 1
		and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
		and		a.dt_validade_prescr > dt_validade_w
		and		a.nr_atendimento = nr_atendimento_p
		and		coalesce(cd_unidade_medida_p,'XPTO')	in ('XPTO', b.cd_unidade_medida_dose)
		and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')
		and		((coalesce(ie_via_aplicacao_p::text, '') = '') or (coalesce(b.ie_via_aplicacao, coalesce(ie_via_aplicacao_p, 'XPTO')) = ie_via_aplicacao_p))
		and 	((coalesce(c.nr_sequencia, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = ''))
		and             c.cd_funcao_origem = 2314 LIMIT 1;
		
		if (dt_suspensao_cpoe_w IS NOT NULL AND dt_suspensao_cpoe_w::text <> '') then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(820331,null) || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_suspensao_cpoe_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone);
		elsif (dt_fim_cpoe_w IS NOT NULL AND dt_fim_cpoe_w::text <> '') then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(820333,null) || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_fim_cpoe_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone);			
		end if;
	end if;

	/* verificar horarios duplicados */

	select	count(*)
	into STRICT	qt_hor_dupl_w
	from	prescr_material b,
			prescr_mat_hor a,
			prescr_medica c where	b.nr_prescricao			= a.nr_prescricao
	and		b.nr_sequencia			= a.nr_seq_material
	and		coalesce(cd_unidade_medida_p,'XPTO')	in ('XPTO', a.cd_unidade_medida_dose)
	and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')
	--and		nvl(b.qt_dose,1)		= nvl(qt_item_p,1)
	and		coalesce(b.qt_dose,1)		= coalesce(qt_item_p,coalesce(b.qt_dose,1))
	and		a.ie_agrupador			= 1
	and		a.cd_material				= cd_item_p
	and		pkg_date_utils.start_of(a.dt_horario, 'mi') = pkg_date_utils.start_of(dt_horario_p, 'mi')
	and		coalesce(a.ie_horario_especial,'N')	= 'N'
	and		coalesce(a.ie_adep,'S')		= 'S'
	and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_material, nr_prescricao_p ,  nr_seq_item_p,nr_prescricoes_p) = 'S'
	and		c.nr_prescricao = b.nr_prescricao
	and		coalesce(a.ie_adep,'S') = 'S'
	and		coalesce(c.ie_adep,'S') = 'S'
	and		coalesce(a.ie_situacao,'A') = 'A'
	and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
	and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
	and		c.dt_validade_prescr > dt_validade_w
	and		c.nr_atendimento = nr_atendimento_p
	and		((coalesce(ie_via_aplicacao_p::text, '') = '') or (coalesce(b.ie_via_aplicacao, coalesce(ie_via_aplicacao_p, 'XPTO')) = ie_via_aplicacao_p))
	and 	((coalesce(b.nr_seq_mat_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
			
	if (qt_hor_dupl_w > 0) then
		--ds_consistencia_w := 'O horario informado ja esta previsto para este item, favor verificar.';
		ds_consistencia_w := wheb_mensagem_pck.get_texto(294664,null);
	end if;
	
	/* verificar intervalo */

	if (cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') then
	
		/* obter horas validade prescricao */

		if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then
			select	max(nr_horas_validade)
			into STRICT	nr_horas_val_w
			from	prescr_medica where	nr_prescricao = nr_prescricao_p LIMIT 1;
		elsif (nr_prescricoes_p IS NOT NULL AND nr_prescricoes_p::text <> '') then
			nr_horas_val_w := obter_valor_dinamico_in_bv(''||
				' SELECT 	max(nr_horas_validade) '||
				' from 		prescr_medica '||
				' where	rownum = 1 and 	NR_PRESCRICAO IN :NR_PRESCRICOES', '', ':NR_PRESCRICOES', nr_prescricoes_p, ',', nr_horas_val_w);
		end if;
					
		select 	coalesce(max(ie_controla_intervalo), 'S')
		into STRICT	ie_controla_intervalo_w
		from	intervalo_prescricao
		where	cd_intervalo = cd_intervalo_p;
		
		select 	coalesce(qt_min_intervalo,0)
		into STRICT	qt_min_intervalo_w
		from	intervalo_prescricao where		cd_intervalo = cd_intervalo_p LIMIT 1;
		
		if (ie_controla_intervalo_w = 'N') then
		
			ie_qt_operacao_nulo_w := 'N';

			if (coalesce(ie_acm_sn_p,'N') = 'S') then
				
				select	coalesce(max('S'),'N')
				into STRICT	ie_qt_operacao_nulo_w
				from	intervalo_prescricao
				where	cd_intervalo = cd_intervalo_p
				and 	coalesce(coalesce(ie_se_necessario,ie_acm),'N') = 'S'
				and		coalesce(qt_operacao::text, '') = '';
				
				if (ie_qt_operacao_nulo_w = 'S') then
					qt_interv_w := 999;
				end if;
				
			end if;
				
			if (ie_qt_operacao_nulo_w = 'N') then
				qt_interv_w := obter_ocorrencia_intervalo(cd_intervalo_p,24,'O');
			end if;
		
            select  count(*)
            into STRICT    qt_hor_int_w
            from    prescr_material b,
                    prescr_mat_hor a,
                    prescr_medica c
            where   b.nr_prescricao	= a.nr_prescricao
            and	    b.nr_sequencia = a.nr_seq_material
            and	    c.nr_prescricao = b.nr_prescricao
            and	    coalesce(cd_unidade_medida_p,'XPTO')	in ('XPTO', a.cd_unidade_medida_dose)
            and	    coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')			
            and	    coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))
            and	    a.ie_agrupador = 1
            and	    a.cd_material = cd_item_p
            and	    coalesce(a.ie_horario_especial,'N') = 'N'
            and	    coalesce(a.ie_adep,'S') = 'S'		
            and	    coalesce(a.ie_adep,'S') = 'S'
            and	    coalesce(a.dt_suspensao::text, '') = ''
            and	    coalesce(b.dt_suspensao::text, '') = ''
            and	    coalesce(a.dt_recusa::text, '') = ''
            and	    coalesce(c.ie_adep,'S') = 'S'
            and	    coalesce(a.ie_dose_especial,'N') = 'N'
            and	    coalesce(a.ie_situacao,'A') = 'A'
            and	    obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p			
            and	    Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
            and	    (c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
            and		((nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '' AND c.nr_prescricao = nr_prescricao_p) or (c.nr_prescricao in (SELECT x.cd_registro from table(lista_pck.obter_lista_char(nr_prescricoes_p)) x) and
                        dt_horario_p between c.dt_inicio_prescr and c.dt_validade_prescr))
            and	    c.dt_validade_prescr > dt_validade_w
            and	    c.nr_atendimento = nr_atendimento_p
            and     ((coalesce(b.nr_seq_mat_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = ''));
			

			
			if (qt_hor_int_w >= qt_interv_w) and (varie_permite_apraz_w <> 'S') and (dose_range_max_valid(nr_seq_cpoe_p, nr_prescricao_p, 0, null, dt_horario_p, nm_usuario_p) = 'N')	then			
				--ds_consistencia_w := 'O horario informado nao esta de acordo com o intervalo previsto para este item, favor verificar.';
				ds_consistencia_w := wheb_mensagem_pck.get_texto(1112863,null);
			end if;	
			
		else	
				
			/* obter ocorrencia intervalo */

			ie_qt_operacao_nulo_w := 'N';
			
			if (coalesce(ie_acm_sn_p,'N') = 'S') then
				
				select	coalesce(max('S'),'N')
				into STRICT	ie_qt_operacao_nulo_w
				from	intervalo_prescricao
				where	cd_intervalo = cd_intervalo_p
				and 	coalesce(coalesce(ie_se_necessario,ie_acm),'N') = 'S'
				and		coalesce(qt_operacao::text, '') = '';
				
				if (ie_qt_operacao_nulo_w = 'S') then
					qt_interv_w := 0;
				end if;
				
			end if;
				
			if (ie_qt_operacao_nulo_w = 'N') then
				qt_interv_w := obter_ocorrencia_intervalo(cd_intervalo_p,24,'H');
			end if;
				
			if (qt_min_intervalo_w = 0) then
				begin
				/* verificar horarios anteriores x intervalo */

				select	count(*)
				into STRICT	qt_hor_int_w
				from	prescr_material b,
						prescr_mat_hor a,
						prescr_medica c where	b.nr_prescricao			= a.nr_prescricao
				and		b.nr_sequencia			= a.nr_seq_material
				and		coalesce(cd_unidade_medida_p,'XPTO')	in ('XPTO', a.cd_unidade_medida_dose)
				and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')
				--and		nvl(b.qt_dose,1)		= nvl(qt_item_p,1)
				and		coalesce(b.qt_dose,1)		= coalesce(qt_item_p,coalesce(b.qt_dose,1))
				and		a.ie_agrupador			= 1
				and		a.cd_material				= cd_item_p
				and (a.dt_horario				< dt_horario_p and
						a.dt_horario				> dt_horario_p - qt_interv_w / 24)
				and		coalesce(a.ie_horario_especial,'N')	= 'N'
				and		coalesce(a.ie_adep,'S')		= 'S'
				and		((obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_material,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S') or (c.cd_funcao_origem = 2314 and
						coalesce(b.nr_seq_mat_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0) and
						b.nr_prescricao in (SELECT 	x.nr_registro
											from 	table(lista_pck.obter_lista(nr_prescricoes_p)) x)))
				and		c.nr_prescricao = b.nr_prescricao
				and		coalesce(a.ie_adep,'S') = 'S'
				and		coalesce(c.ie_adep,'S') = 'S'
				and		coalesce(a.dt_suspensao::text, '') = ''
				and		coalesce(b.dt_suspensao::text, '') = ''
				and		coalesce(a.dt_recusa::text, '') = ''
				and		coalesce(a.ie_dose_especial,'N') = 'N'
				and		coalesce(a.ie_situacao,'A') = 'A'
				and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p	
				and		(((ie_consistir_acm_w = 'S') and 
						  ((coalesce(b.ie_acm, 'N')		= 'S') or (coalesce(b.ie_se_necessario, 'N') = 'S'))) or
						 ((coalesce(b.ie_acm, 'N') = 'N') and (coalesce(b.ie_se_necessario, 'N') = 'N')))
				and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
				and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
				and		c.dt_validade_prescr > dt_validade_w
				and		c.nr_atendimento = nr_atendimento_p
				and 	((coalesce(b.nr_seq_mat_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
			
				end;
			else
				begin
				/* verificar horarios anteriores x intervalo */

				select	count(*)
				into STRICT	qt_hor_int_w
				from	prescr_material b,
						prescr_mat_hor a,
						prescr_medica c where	b.nr_prescricao			= a.nr_prescricao
				and		b.nr_sequencia			= a.nr_seq_material
				and		coalesce(cd_unidade_medida_p,'XPTO')	in ('XPTO', a.cd_unidade_medida_dose)
				and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')
				--and		nvl(b.qt_dose,1)		= nvl(qt_item_p,1)
				and		coalesce(b.qt_dose,1)		= coalesce(qt_item_p,coalesce(b.qt_dose,1))
				and		a.ie_agrupador			= 1
				and		a.cd_material				= cd_item_p
				and (a.dt_horario				< dt_horario_p and
						a.dt_horario				> dt_horario_p - qt_min_intervalo_w / 1440)
				and		coalesce(a.ie_horario_especial,'N')	= 'N'
				and		coalesce(a.ie_adep,'S')		= 'S'
				and		((obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_material,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S') or (c.cd_funcao_origem = 2314 and
						coalesce(b.nr_seq_mat_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0) and
						b.nr_prescricao in (SELECT 	x.nr_registro
											from 	table(lista_pck.obter_lista(nr_prescricoes_p)) x)))
				and		c.nr_prescricao = b.nr_prescricao
				and		coalesce(a.ie_adep,'S') = 'S'
				and		coalesce(a.dt_suspensao::text, '') = ''
				and		coalesce(b.dt_suspensao::text, '') = ''
				and		coalesce(a.dt_recusa::text, '') = ''
				and		coalesce(c.ie_adep,'S') = 'S'
				and		coalesce(a.ie_dose_especial,'N') = 'N'
				and		coalesce(a.ie_situacao,'A') = 'A'
				and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p	
				and		(((ie_consistir_acm_w = 'S') and 
						  ((coalesce(b.ie_acm, 'N')		= 'S') or (coalesce(b.ie_se_necessario, 'N') = 'S'))) or
						 ((coalesce(b.ie_acm, 'N') = 'N') and (coalesce(b.ie_se_necessario, 'N') = 'N')))
				and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
				and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
				and		c.dt_validade_prescr > dt_validade_w
				and		c.nr_atendimento = nr_atendimento_p
				and 	((coalesce(b.nr_seq_mat_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
				end;
			end if;		
			
			
			if (qt_hor_int_w > 0) and (varie_permite_apraz_w <> 'S') and (dose_range_max_valid(nr_seq_cpoe_p, nr_prescricao_p, 0, null, dt_horario_p, nm_usuario_p) = 'N') then			
				--ds_consistencia_w := 'O horario informado nao esta de acordo com o intervalo previsto para este item, favor verificar.';
				ds_consistencia_w := wheb_mensagem_pck.get_texto(1112863,null);
			end if;
			
		    if (qt_min_intervalo_w = 0) then
				begin
				/* verificar horarios posteriores x intervalo */

			    select	count(*)
				into STRICT	qt_hor_int_w
				from	prescr_material b,
						prescr_mat_hor a,
						prescr_medica c where	b.nr_prescricao			= a.nr_prescricao
				and		b.nr_sequencia			= a.nr_seq_material
				and		coalesce(cd_unidade_medida_p,'XPTO')	in ('XPTO', a.cd_unidade_medida_dose)
				and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')
				--and		nvl(b.qt_dose,1)		= nvl(qt_item_p,1)
				and		coalesce(b.qt_dose,1)		= coalesce(qt_item_p,coalesce(b.qt_dose,1))
				and		a.ie_agrupador			= 1
				and		a.cd_material				= cd_item_p
				and (a.dt_horario				> dt_horario_p and
						a.dt_horario				< dt_horario_p + qt_interv_w / 24)
				and		coalesce(a.ie_horario_especial,'N')	= 'N'
				and		coalesce(a.ie_adep,'S')		= 'S'
				and		((obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_material,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S') or (c.cd_funcao_origem = 2314 and
						coalesce(b.nr_seq_mat_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0) and
						b.nr_prescricao in (SELECT 	x.nr_registro
											from 	table(lista_pck.obter_lista(nr_prescricoes_p)) x)))
				and		c.nr_prescricao = b.nr_prescricao
				and		coalesce(a.ie_adep,'S') = 'S'
				and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
				and		coalesce(a.ie_dose_especial,'N') = 'N'
				and		coalesce(a.ie_situacao,'A') = 'A'
				and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p
				and		coalesce(a.dt_suspensao::text, '') = ''
				and		coalesce(b.dt_suspensao::text, '') = ''
				and		coalesce(a.dt_recusa::text, '') = ''
				and		(((ie_consistir_acm_w = 'S') and 
						  (((coalesce(b.ie_acm, 'N')		= 'S') and (ie_acm_intervalo_w		= 'S')) or
						  ((coalesce(b.ie_se_necessario, 'N') = 'S') and (ie_sn_intervalo_w		  = 'S')))) or
						 ((coalesce(b.ie_acm, 'N') = 'N') and (coalesce(b.ie_se_necessario, 'N') = 'N')))
				and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
				and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
				and		c.dt_validade_prescr > dt_validade_w
				and		c.nr_atendimento = nr_atendimento_p
				and 	((coalesce(b.nr_seq_mat_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
				
				end;
			else	
				begin
				/* verificar horarios posteriores x intervalo */

		     	select	count(*)
				into STRICT	qt_hor_int_w
				from	prescr_material b,
						prescr_mat_hor a,
						prescr_medica c where	b.nr_prescricao			= a.nr_prescricao
				and		b.nr_sequencia			= a.nr_seq_material
				and		coalesce(cd_unidade_medida_p,'XPTO')	in ('XPTO', a.cd_unidade_medida_dose)
				and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')
				and		coalesce(b.qt_dose,1)		= coalesce(qt_item_p,coalesce(b.qt_dose,1))
				and		a.ie_agrupador			= 1
				and		a.cd_material				= cd_item_p
				and (a.dt_horario				> dt_horario_p and
						a.dt_horario				< dt_horario_p + qt_min_intervalo_w / 1440)
				and		coalesce(a.ie_horario_especial,'N')	= 'N'
				and		coalesce(a.ie_adep,'S')		= 'S'
				and		((obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_material,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S') or (c.cd_funcao_origem = 2314 and
						coalesce(b.nr_seq_mat_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0) and
						b.nr_prescricao in (SELECT 	x.nr_registro
											from 	table(lista_pck.obter_lista(nr_prescricoes_p)) x)))
				and		c.nr_prescricao = b.nr_prescricao
				and		coalesce(a.ie_adep,'S') = 'S'
				and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
				and		coalesce(a.ie_dose_especial,'N') = 'N'
				and		coalesce(a.ie_situacao,'A') = 'A'
				and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p
				and		coalesce(a.dt_suspensao::text, '') = ''
				and		coalesce(b.dt_suspensao::text, '') = ''
				and		coalesce(a.dt_recusa::text, '') = ''
				and		(((ie_consistir_acm_w = 'S') and 
						  (((coalesce(b.ie_acm, 'N')		= 'S') and (ie_acm_intervalo_w		= 'S')) or
						   ((coalesce(b.ie_se_necessario, 'N') = 'S') and (ie_sn_intervalo_w		  = 'S')))) or
						 ((coalesce(b.ie_acm, 'N') = 'N') and (coalesce(b.ie_se_necessario, 'N') = 'N')))
				and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
				and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')			
				and		c.dt_validade_prescr > dt_validade_w
				and		c.nr_atendimento = nr_atendimento_p
				and 	((coalesce(b.nr_seq_mat_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
				
				end;
			end if;	
			
			
		    if (qt_hor_int_w > 0) and (varie_permite_apraz_w <> 'S') and (dose_range_max_valid(nr_seq_cpoe_p, nr_prescricao_p, 0, null, dt_horario_p, nm_usuario_p) = 'N') then
				--ds_consistencia_w := 'O horario informado nao esta de acordo com o intervalo previsto para este item, favor verificar.';
				ds_consistencia_w := wheb_mensagem_pck.get_texto(1112863,null);
			end if;			
						
		end if;
		
	end if;
	
	/* Verificar horas aprazamento */

	if (ie_acm_sn_p = 'S') then
		qt_hor_aprazamento_w	:= Wheb_assist_pck.obterParametroFuncao(1113,692);
		
		if (qt_hor_aprazamento_w > 0) and (dt_horario_p > (clock_timestamp() + (qt_hor_aprazamento_w/24))) then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(718513,null);
		end if;
	end if;	
	/*  FIM */

	
elsif (ie_tipo_item_p = 'MAT') then

	/* verificar validade prescricoes */

	/*
	select	count(*)
	into	qt_hor_inv_w
	from	prescr_medica
	where	rownum = 1 and	dt_horario_p between dt_inicio_prescr and dt_validade_prescr
	and	obter_se_valor_contido(nr_prescricao,nvl(nr_prescricoes_p,nr_prescricao)) = 'S';
	*/
	
	select	count(*)
	into STRICT	qt_hor_inv_w
	from	prescr_medica where	dt_horario_p between dt_inicio_prescr and dt_validade_prescr
	and	obter_se_valor_contido(nr_prescricao,coalesce(nr_prescricoes_p,nr_prescricao)) = 'S'
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,cd_setor_atendimento,coalesce(ie_adep,'S')) = 'S'
	and	dt_validade_prescr > dt_validade_w
	and	nr_atendimento = nr_atendimento_p LIMIT 1;
	
	if (qt_hor_inv_w = 0) then
		--ds_consistencia_w := 'O horario informado esta fora do periodo de validade das prescricoes vigentes deste item, favor verificar.';
		ds_consistencia_w := wheb_mensagem_pck.get_texto(294671, null);
	end if;	

	select	count(*)
	into STRICT	qt_hor_inv_w
	from	prescr_medica 	a,
			prescr_material	b,
			cpoe_material 		c
	where	a.nr_prescricao = b.nr_prescricao
	and		b.nr_seq_mat_cpoe = c.nr_sequencia
	and		dt_horario_p > coalesce(cpoe_obter_termino_item(c.nr_sequencia, 'M'),a.dt_validade_prescr)
	and		obter_se_valor_contido(a.nr_prescricao,coalesce(nr_prescricoes_p,a.nr_prescricao)) = 'S'
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		c.cd_material = cd_item_p
	and		b.ie_agrupador = 2
	and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
	and		a.dt_validade_prescr > dt_validade_w
	and		a.nr_atendimento = nr_atendimento_p
	and 	((coalesce(c.nr_sequencia, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;	
	
	if (qt_hor_inv_w > 0) then
	
		select	max(c.dt_suspensao),
				max(c.dt_fim)
		into STRICT	dt_suspensao_cpoe_w,
				dt_fim_cpoe_w
		from	prescr_medica 	a,
				prescr_material	b,
				cpoe_material 		c
		where	a.nr_prescricao = b.nr_prescricao
		and		b.nr_seq_mat_cpoe = c.nr_sequencia
		and		dt_horario_p > cpoe_obter_termino_item(c.nr_sequencia, 'M')
		and		obter_se_valor_contido(a.nr_prescricao,coalesce(nr_prescricoes_p,a.nr_prescricao)) = 'S'
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		c.cd_material = cd_item_p
		and		b.ie_agrupador = 2
		and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
		and		a.dt_validade_prescr > dt_validade_w
		and		a.nr_atendimento = nr_atendimento_p
		and 	((coalesce(c.nr_sequencia, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = ''))
		and             c.cd_funcao_origem = 2314 LIMIT 1;
	
		if (dt_suspensao_cpoe_w IS NOT NULL AND dt_suspensao_cpoe_w::text <> '') then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(820331,null) || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_suspensao_cpoe_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone);
		elsif (dt_fim_cpoe_w IS NOT NULL AND dt_fim_cpoe_w::text <> '') then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(820333,null) || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_fim_cpoe_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone);			
		end if;
			
	end if;
	
	/* verificar horarios duplicados */

	select	count(*)
	into STRICT	qt_hor_dupl_w
	from	prescr_material b,
			prescr_mat_hor a,
			prescr_medica c where	b.nr_prescricao			= a.nr_prescricao
	and		b.nr_sequencia			= a.nr_seq_material
	and		coalesce(cd_unidade_medida_p,'XPTO')	in ('XPTO', a.cd_unidade_medida_dose)
	and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')
	--and		nvl(b.qt_dose,1)		= nvl(qt_item_p,1)
	and		coalesce(b.qt_dose,1)		= coalesce(qt_item_p,coalesce(b.qt_dose,1))
	and		a.ie_agrupador			= 2
	and		a.cd_material				= cd_item_p
	and		a.dt_horario				= dt_horario_p
	and		coalesce(a.ie_horario_especial,'N')	= 'N'
	and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_material,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
	and		c.nr_prescricao = b.nr_prescricao
	and		coalesce(a.ie_adep,'S') = 'S'
	and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
	and		coalesce(a.ie_situacao,'A') = 'A'
	and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
	and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
	and		c.dt_validade_prescr > dt_validade_w
	and		c.nr_atendimento = nr_atendimento_p
	and 	((coalesce(b.nr_seq_mat_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
	
	if (qt_hor_dupl_w > 0) then
		--ds_consistencia_w := 'O horario informado ja esta previsto para este item, favor verificar.';
		ds_consistencia_w := wheb_mensagem_pck.get_texto(294664,null);
	end if;
	
	/* verificar intervalo */

	if (cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') then
	
		/* obter horas validade prescricao */

		if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then
			select	max(nr_horas_validade)
			into STRICT	nr_horas_val_w
			from	prescr_medica where	nr_prescricao = nr_prescricao_p LIMIT 1;
		elsif (nr_prescricoes_p IS NOT NULL AND nr_prescricoes_p::text <> '') then
			nr_horas_val_w := OBTER_VALOR_DINAMICO_IN_BV(''||
				' SELECT 	max(nr_horas_validade) '||
				' from 		prescr_medica '||
				' where	rownum = 1 and 	NR_PRESCRICAO IN :NR_PRESCRICOES', '', ':NR_PRESCRICOES', nr_prescricoes_p, ',', nr_horas_val_w);
		end if;

		/* obter ocorrencia intervalo */

		qt_interv_w := obter_ocorrencia_intervalo(cd_intervalo_p,nr_horas_val_w,'H');
		
		/* verificar horarios anteriores x intervalo */

		select	count(*)
		into STRICT	qt_hor_int_w
		from	prescr_material b,
				prescr_mat_hor a,
				prescr_medica c where	b.nr_prescricao			= a.nr_prescricao
		and		b.nr_sequencia			= a.nr_seq_material
		and		coalesce(cd_unidade_medida_p,'XPTO')	in ('XPTO', a.cd_unidade_medida_dose)
		and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')
		--and		nvl(b.qt_dose,1)		= nvl(qt_item_p,1)
		and		coalesce(b.qt_dose,1)		= coalesce(qt_item_p,coalesce(b.qt_dose,1))
		and		a.ie_agrupador			= 2
		and		a.cd_material				= cd_item_p
		and		a.dt_horario				< dt_horario_p
		and		a.dt_horario				> dt_horario_p - qt_interv_w / 24
		and		coalesce(a.ie_horario_especial,'N')	= 'N'
		and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_material,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
		and		c.nr_prescricao = b.nr_prescricao
		and		coalesce(a.ie_adep,'S') = 'S'
		and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
		and		coalesce(a.ie_dose_especial,'N') = 'N'
		and		coalesce(a.ie_situacao,'A') = 'A'
		and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
		and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
		and		c.dt_validade_prescr > dt_validade_w
		and		c.nr_atendimento = nr_atendimento_p
		and 	((coalesce(b.nr_seq_mat_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
		
		if (qt_hor_int_w > 0) and (varie_permite_apraz_w <> 'S') then
			--ds_consistencia_w := 'O horario informado nao esta de acordo com o intervalo previsto para este item, favor verificar.';
			ds_consistencia_w := wheb_mensagem_pck.get_texto(1112863,null);
		end if;
		
		/* verificar horarios posteriores x intervalo */

		select	count(*)
		into STRICT	qt_hor_int_w
		from	prescr_material b,
				prescr_mat_hor a,
				prescr_medica c where	b.nr_prescricao			= a.nr_prescricao
		and		b.nr_sequencia			= a.nr_seq_material
		and		coalesce(cd_unidade_medida_p,'XPTO')	in ('XPTO', a.cd_unidade_medida_dose)
		and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')
		--and		nvl(b.qt_dose,1)		= nvl(qt_item_p,1)
		and		coalesce(b.qt_dose,1)		= coalesce(qt_item_p,coalesce(b.qt_dose,1))
		and		a.ie_agrupador			= 2
		and		a.cd_material				= cd_item_p
		and		a.dt_horario				> dt_horario_p
		and		a.dt_horario				< dt_horario_p + qt_interv_w / 24
		and		coalesce(a.ie_horario_especial,'N')	= 'N'
		and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_material,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
		and		c.nr_prescricao = b.nr_prescricao
		and		coalesce(a.ie_adep,'S') = 'S'
		and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
		and		coalesce(a.ie_dose_especial,'N') = 'N'
		and		coalesce(a.ie_situacao,'A') = 'A'
		and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
		and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
		and		c.dt_validade_prescr > dt_validade_w
		and		c.nr_atendimento = nr_atendimento_p
		and 	((coalesce(b.nr_seq_mat_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
		
		if (qt_hor_int_w > 0) and (varie_permite_apraz_w <> 'S') then
			--ds_consistencia_w := 'O horario informado nao esta de acordo com o intervalo previsto para este item, favor verificar.';
			ds_consistencia_w := wheb_mensagem_pck.get_texto(1112863,null);
		end if;		
		
	end if;	
	
elsif (ie_tipo_item_p in ('P','I')) then

	/* verificar validade prescricoes */

		
	select	count(*)
	into STRICT	qt_hor_inv_w
	from	prescr_medica a where	dt_horario_p between a.dt_inicio_prescr and a.dt_validade_prescr
	and		((obter_se_valor_contido(a.nr_prescricao,coalesce(nr_prescricoes_p,a.nr_prescricao)) = 'S') or (exists (	SELECT 	1
						from	prescr_medica b where	b.nr_atendimento = a.nr_atendimento			
						and		coalesce(b.dt_suspensao::text, '') = ''
						and		(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') LIMIT 1)))
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
	and		a.dt_validade_prescr > dt_validade_w
	and		a.nr_atendimento = nr_atendimento_p LIMIT 1;	
	
	
	if (qt_hor_inv_w = 0) then
	
		select	max(dt_validade_prescr),
				max(dt_inicio_prescr)
		into STRICT	dt_validade_prescr_w,
				dt_inicio_prescr_w
		from	prescr_medica where	obter_se_valor_contido(nr_prescricao,coalesce(nr_prescricoes_p,nr_prescricao)) = 'S'
		and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,cd_setor_atendimento,coalesce(ie_adep,'S')) = 'S'
		and		dt_validade_prescr > dt_validade_w
		and		nr_atendimento = nr_atendimento_p LIMIT 1;
	
		if (dt_validade_prescr_w IS NOT NULL AND dt_validade_prescr_w::text <> '' AND dt_inicio_prescr_w IS NOT NULL AND dt_inicio_prescr_w::text <> '') then	
			ds_consistencia_w := wheb_mensagem_pck.get_texto(294663, 'VALMINIMA='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_inicio_prescr_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)||';VALMAX='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_validade_prescr_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone));
		else
			ds_consistencia_w := wheb_mensagem_pck.get_texto(294671);	
		end if;
					
	end if;	
	
	select	count(*)
	into STRICT	qt_hor_inv_w
	from	prescr_medica 	a,
			prescr_procedimento	b,
			cpoe_procedimento 		c
	where	a.nr_prescricao = b.nr_prescricao
	and		b.nr_seq_proc_cpoe = c.nr_sequencia  	
	and		dt_horario_p > coalesce(cpoe_obter_termino_item(c.nr_sequencia, 'P'), a.dt_validade_prescr)						
	and		obter_se_valor_contido(a.nr_prescricao,coalesce(nr_prescricoes_p,a.nr_prescricao)) = 'S'
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		b.cd_procedimento = cd_item_p
	and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')
	and		coalesce(b.qt_procedimento,1)		= coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
	and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
	and		a.dt_validade_prescr > dt_validade_w
	and		a.nr_atendimento = nr_atendimento_p
	and 	((coalesce(c.nr_sequencia, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = ''))
	and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p LIMIT 1;
	
	if (qt_hor_inv_w > 0) then
	
		select	max(c.dt_suspensao),
				max(c.dt_fim)
		into STRICT	dt_suspensao_cpoe_w,
				dt_fim_cpoe_w
		from	prescr_medica 	a,
				prescr_procedimento	b,
				cpoe_procedimento 		c
		where	a.nr_prescricao = b.nr_prescricao
		and		b.nr_seq_proc_cpoe = c.nr_sequencia
		and		dt_horario_p > coalesce(cpoe_obter_termino_item(c.nr_sequencia, 'P'), a.dt_validade_prescr)
		and		obter_se_valor_contido(a.nr_prescricao,coalesce(nr_prescricoes_p,a.nr_prescricao)) = 'S'
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		b.cd_procedimento = cd_item_p
		and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')
		and		coalesce(b.qt_procedimento,1)		= coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
		and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
		and		a.dt_validade_prescr > dt_validade_w
		and		a.nr_atendimento = nr_atendimento_p
		and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p	
		and 	((coalesce(c.nr_sequencia, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = ''))
		and             c.cd_funcao_origem = 2314 LIMIT 1;
		
		if (dt_suspensao_cpoe_w IS NOT NULL AND dt_suspensao_cpoe_w::text <> '') then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(820331,null) || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_suspensao_cpoe_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone);
		elsif (dt_fim_cpoe_w IS NOT NULL AND dt_fim_cpoe_w::text <> '') then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(820333,null) ||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_fim_cpoe_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone);			
		end if;
			
	end if;

	/* verificar horarios duplicados */

	select	count(*)
	into STRICT	qt_hor_dupl_w
	from	prescr_procedimento b,			
			prescr_proc_hor a,
			prescr_medica c where		b.nr_prescricao			= a.nr_prescricao
	and		b.nr_sequencia			= a.nr_seq_procedimento	
	and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')
	and		coalesce(b.qt_procedimento,1)		= coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
	and		a.cd_procedimento			= cd_item_p
	and		a.dt_horario				= dt_horario_p
	and		coalesce(a.ie_horario_especial,'N')	= 'N'
	and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_procedimento,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
	and		c.nr_prescricao = b.nr_prescricao
	and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
	and		coalesce(a.ie_situacao,'A') = 'A'
	and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
	and		c.dt_validade_prescr > dt_validade_w
	and		c.nr_atendimento = nr_atendimento_p
	and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
	and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p	
	and 	((coalesce(b.nr_seq_proc_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
		
	if (qt_hor_dupl_w > 0) then
		--ds_consistencia_w := 'O horario informado ja esta previsto para este item, favor verificar.';
		ds_consistencia_w := wheb_mensagem_pck.get_texto(294664,null);
	end if;
	
	/* verificar intervalo */

	if	((cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') and (coalesce(ds_consistencia_w::text, '') = '')) then
	
		/* obter horas validade prescricao */

		if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then
			select	max(nr_horas_validade)
			into STRICT	nr_horas_val_w
			from	prescr_medica where	nr_prescricao = nr_prescricao_p LIMIT 1;
		elsif (nr_prescricoes_p IS NOT NULL AND nr_prescricoes_p::text <> '') then
			nr_horas_val_w := obter_valor_dinamico_in_bv(''||
				' SELECT 	max(nr_horas_validade) '||
				' from 		prescr_medica '||
				' where	rownum = 1 and 	NR_PRESCRICAO IN :NR_PRESCRICOES', '', ':NR_PRESCRICOES', nr_prescricoes_p, ',', nr_horas_val_w);
		end if;
								
		select 	coalesce(qt_min_intervalo,0)
		into STRICT	qt_min_intervalo_w
		from	intervalo_prescricao where		cd_intervalo = cd_intervalo_p LIMIT 1;
		
		select 	coalesce(max(ie_controla_intervalo), 'S')
		into STRICT	ie_controla_intervalo_w
		from	intervalo_prescricao
		where	cd_intervalo = cd_intervalo_p;
		
			
		if (ie_controla_intervalo_w = 'N') then
		
			ie_qt_operacao_nulo_w := 'N';

			if (coalesce(ie_acm_sn_p,'N') = 'S') then
				
				select	coalesce(max('S'),'N')
				into STRICT	ie_qt_operacao_nulo_w
				from	intervalo_prescricao
				where	cd_intervalo = cd_intervalo_p
				and 	coalesce(coalesce(ie_se_necessario,ie_acm),'N') = 'S'
				and		coalesce(qt_operacao::text, '') = '';
				
				if (ie_qt_operacao_nulo_w = 'S') then
					qt_interv_w := 999;
				end if;
				
			end if;
				
			if (ie_qt_operacao_nulo_w = 'N') then
				qt_interv_w := obter_ocorrencia_intervalo(cd_intervalo_p,24,'O');
			end if;
		
		    select	count(c.nr_prescricao)
			into STRICT	qt_hor_int_w
			from	prescr_procedimento b,
					prescr_proc_hor a,
					prescr_medica c
			where	b.nr_prescricao			= a.nr_prescricao
			and		b.nr_sequencia			= a.nr_seq_procedimento
			and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')		
			and		coalesce(b.qt_procedimento,1)		= coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
			and		a.cd_procedimento			= cd_item_p					
			and		coalesce(a.ie_horario_especial,'N')	= 'N'
			and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_procedimento,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
			and		c.nr_prescricao = b.nr_prescricao
			and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
			and		coalesce(a.ie_situacao,'A') = 'A'
			and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
			and		coalesce(a.dt_suspensao::text, '') = ''
			and		coalesce(b.dt_suspensao::text, '') = ''			
			and		c.dt_validade_prescr > dt_validade_w
			and		c.nr_atendimento = nr_atendimento_p
			and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p	
			and		((nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '' AND c.nr_prescricao = nr_prescricao_p) or (c.nr_prescricao = obter_max_nrprescricao(nr_prescricoes_p)))
			and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
			and		((coalesce(cpoe_obter_termino_item(b.nr_seq_proc_cpoe, 'P')::text, '') = '') or (cpoe_obter_termino_item(b.nr_seq_proc_cpoe, 'P') >= clock_timestamp()))
			and 	((coalesce(b.nr_seq_proc_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = ''));					
						
			if (qt_hor_int_w >= qt_interv_w) and (varie_permite_apraz_w <> 'S') then			
				--ds_consistencia_w := 'O horario informado nao esta de acordo com o intervalo previsto para este item, favor verificar.';
				ds_consistencia_w := wheb_mensagem_pck.get_texto(1112863,null);
			end if;	
			
		else	
		
			/* obter ocorrencia intervalo */

			ie_qt_operacao_nulo_w := 'N';
			
			if (coalesce(ie_acm_sn_p,'N') = 'S') then
				
				select	coalesce(max('S'),'N')
				into STRICT	ie_qt_operacao_nulo_w
				from	intervalo_prescricao
				where	cd_intervalo = cd_intervalo_p
				and 	coalesce(coalesce(ie_se_necessario,ie_acm),'N') = 'S'
				and		coalesce(qt_operacao::text, '') = '';
				
				if (ie_qt_operacao_nulo_w = 'S') then
					qt_interv_w := 0;
				end if;
				
			end if;
				
			if (ie_qt_operacao_nulo_w = 'N') then
				qt_interv_w := obter_ocorrencia_intervalo(cd_intervalo_p,24,'H');
			end if;
						
			/* verificar horarios anteriores x intervalo */

     		if (qt_min_intervalo_w = 0) then
				select	count(c.nr_prescricao)
				into STRICT	qt_hor_int_w
				from	prescr_procedimento b,
						prescr_proc_hor a,
						prescr_medica c where		b.nr_prescricao			= a.nr_prescricao
				and		b.nr_sequencia			= a.nr_seq_procedimento
				and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')		
				and		coalesce(b.qt_procedimento,1)		= coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
				and		a.cd_procedimento			= cd_item_p
				and		a.dt_horario				< dt_horario_p
				and		a.dt_horario				> dt_horario_p - qt_interv_w / 24			
				and		coalesce(a.ie_horario_especial,'N')	= 'N'
				and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_procedimento,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
				and		c.nr_prescricao = b.nr_prescricao
				and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
				and		coalesce(a.ie_situacao,'A') = 'A'
				and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
				and		c.dt_validade_prescr > dt_validade_w
				and		c.nr_atendimento = nr_atendimento_p
				and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p	
				and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
				and		((coalesce(cpoe_obter_termino_item(b.nr_seq_proc_cpoe, 'P')::text, '') = '') or (cpoe_obter_termino_item(b.nr_seq_proc_cpoe, 'P') >= clock_timestamp()))
				and 	((coalesce(b.nr_seq_proc_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;							
			else
				select	count(c.nr_prescricao)
				into STRICT	qt_hor_int_w
				from	prescr_procedimento b,
						prescr_proc_hor a,
						prescr_medica c where		b.nr_prescricao			= a.nr_prescricao
				and		b.nr_sequencia			= a.nr_seq_procedimento
				and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')		
				and		coalesce(b.qt_procedimento,1)		= coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
				and		a.cd_procedimento			= cd_item_p
				and		a.dt_horario				< dt_horario_p
				and		a.dt_horario				> dt_horario_p - qt_min_intervalo_w / 1440
				and		coalesce(a.ie_horario_especial,'N')	= 'N'
				and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_procedimento,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
				and		c.nr_prescricao = b.nr_prescricao
				and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
				and		coalesce(a.ie_situacao,'A') = 'A'
				and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
				and		c.dt_validade_prescr > dt_validade_w
				and		c.nr_atendimento = nr_atendimento_p
				and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p	
				and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
				and		((coalesce(cpoe_obter_termino_item(b.nr_seq_proc_cpoe, 'P')::text, '') = '') or (cpoe_obter_termino_item(b.nr_seq_proc_cpoe, 'P') >= clock_timestamp()))
				and 	((coalesce(b.nr_seq_proc_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
				
			end if;	
		
			if (qt_hor_int_w > 0) and (varie_permite_apraz_w <> 'S') then
				--ds_consistencia_w := 'O horario informado nao esta de acordo com o intervalo previsto para este item, favor verificar.';
				ds_consistencia_w := wheb_mensagem_pck.get_texto(1112863,null);
			end if;
						
			/* verificar horarios posteriores x intervalo */

	    	if (qt_min_intervalo_w = 0) then
				select	count(c.nr_prescricao)
				into STRICT	qt_hor_int_w
				from	prescr_procedimento b,
						prescr_proc_hor a,
						prescr_medica c where		b.nr_prescricao			= a.nr_prescricao
				and		b.nr_sequencia			= a.nr_seq_procedimento
				and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')		
				and		coalesce(b.qt_procedimento,1)		= coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
				and		a.cd_procedimento			= cd_item_p
				and		a.dt_horario				> dt_horario_p
				and		a.dt_horario				< dt_horario_p + qt_interv_w / 24
				and		coalesce(a.ie_horario_especial,'N')	= 'N'
				and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_procedimento,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
				and		c.nr_prescricao = b.nr_prescricao
				and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
				and		coalesce(a.ie_situacao,'A') = 'A'
				and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
				and		c.dt_validade_prescr > dt_validade_w
				and		c.nr_atendimento = nr_atendimento_p
				and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
				and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p	
				and		((coalesce(cpoe_obter_termino_item(b.nr_seq_proc_cpoe, 'P')::text, '') = '') or (cpoe_obter_termino_item(b.nr_seq_proc_cpoe, 'P') >= clock_timestamp()))
				and 	((coalesce(b.nr_seq_proc_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
			else
		    	select	count(c.nr_prescricao)
				into STRICT	qt_hor_int_w
				from	prescr_procedimento b,
						prescr_proc_hor a,
						prescr_medica c where		b.nr_prescricao			= a.nr_prescricao
				and		b.nr_sequencia			= a.nr_seq_procedimento
				and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')		
				and		coalesce(b.qt_procedimento,1)		= coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
				and		a.cd_procedimento			= cd_item_p
				and		a.dt_horario				> dt_horario_p
				and		a.dt_horario				< dt_horario_p + qt_min_intervalo_w / 1440
				and		coalesce(a.ie_horario_especial,'N')	= 'N'
				and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_procedimento,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
				and		c.nr_prescricao = b.nr_prescricao
				and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
				and		coalesce(a.ie_situacao,'A') = 'A'
				and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
				and		c.dt_validade_prescr > dt_validade_w
				and		c.nr_atendimento = nr_atendimento_p
				and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
				and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p	
				and		((coalesce(cpoe_obter_termino_item(b.nr_seq_proc_cpoe, 'P')::text, '') = '') or (cpoe_obter_termino_item(b.nr_seq_proc_cpoe, 'P') >= clock_timestamp()))
				and 	((coalesce(b.nr_seq_proc_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
			end if;
			
			if (qt_hor_int_w > 0) and (varie_permite_apraz_w <> 'S') then
				--ds_consistencia_w := 'O horario informado nao esta de acordo com o intervalo previsto para este item, favor verificar.';
				ds_consistencia_w := wheb_mensagem_pck.get_texto(1112863,null);
			end if;	
			
		end if;
		
	end if;	
	
elsif (ie_tipo_item_p = 'R') then

	/* verificar validade prescricoes */
	
	select	count(*)
	into STRICT	qt_hor_inv_w
	from	prescr_medica where	dt_horario_p between dt_inicio_prescr and dt_validade_prescr
	and		obter_se_valor_contido(nr_prescricao,coalesce(nr_prescricoes_p,nr_prescricao)) = 'S'
	and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,cd_setor_atendimento,coalesce(ie_adep,'S')) = 'S'
	and		dt_validade_prescr > dt_validade_w
	and		nr_atendimento = nr_atendimento_p LIMIT 1;	
	
	if (qt_hor_inv_w = 0) then
		select	max(dt_validade_prescr),
				min(dt_inicio_prescr)
		into STRICT	dt_validade_prescr_w,
				dt_inicio_prescr_w
		from	prescr_medica where	obter_se_valor_contido(nr_prescricao,coalesce(nr_prescricoes_p,nr_prescricao)) = 'S'
		and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,cd_setor_atendimento,coalesce(ie_adep,'S')) = 'S'
		and		dt_validade_prescr > dt_validade_w
		and		nr_atendimento = nr_atendimento_p LIMIT 1;
		
		if (dt_validade_prescr_w IS NOT NULL AND dt_validade_prescr_w::text <> '' AND dt_inicio_prescr_w IS NOT NULL AND dt_inicio_prescr_w::text <> '') then	
			ds_consistencia_w := wheb_mensagem_pck.get_texto(294663, 'VALMINIMA='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_inicio_prescr_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)||';VALMAX='|| PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_validade_prescr_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone));
		else
			ds_consistencia_w := wheb_mensagem_pck.get_texto(294671);	
		end if;
		
	end if;	

	select	count(*)
	into STRICT	qt_hor_inv_w
	from	prescr_medica 	a,
			prescr_recomendacao	b,
			cpoe_recomendacao c
	where	a.nr_prescricao = b.nr_prescricao
	and		b.nr_seq_rec_cpoe = c.nr_sequencia
	and		dt_horario_p > coalesce(cpoe_obter_termino_item(c.nr_sequencia, 'R'),a.dt_validade_prescr)
	and		obter_se_valor_contido(a.nr_prescricao,coalesce(nr_prescricoes_p,a.nr_prescricao)) = 'S'
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		b.cd_recomendacao = cd_item_p
	and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
	and		a.dt_validade_prescr > dt_validade_w
	and		a.nr_atendimento = nr_atendimento_p
	and 	((coalesce(c.nr_sequencia, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
	
	if (qt_hor_inv_w > 0) then
	
		select	max(c.dt_suspensao),
				max(c.dt_fim)
		into STRICT	dt_suspensao_cpoe_w,
				dt_fim_cpoe_w
		from	prescr_medica 	a,
				prescr_recomendacao	b,
				cpoe_recomendacao	c
		where	a.nr_prescricao = b.nr_prescricao
		and		b.nr_seq_rec_cpoe = c.nr_sequencia
		and		dt_horario_p > cpoe_obter_termino_item(c.nr_sequencia, 'R')
		and		obter_se_valor_contido(a.nr_prescricao,coalesce(nr_prescricoes_p,a.nr_prescricao)) = 'S'
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		b.cd_recomendacao = cd_item_p
		and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
		and		a.dt_validade_prescr > dt_validade_w
		and		a.nr_atendimento = nr_atendimento_p
		and 	((coalesce(c.nr_sequencia, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = ''))
		and             c.cd_funcao_origem = 2314 LIMIT 1;
		
		if (dt_suspensao_cpoe_w IS NOT NULL AND dt_suspensao_cpoe_w::text <> '') then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(820331,null) || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_suspensao_cpoe_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone);
		elsif (dt_fim_cpoe_w IS NOT NULL AND dt_fim_cpoe_w::text <> '') then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(820333,null) || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_fim_cpoe_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone);			
		end if;
	end if;
	
	/* verificar horarios duplicados */

	select	count(*)
	into STRICT	qt_hor_dupl_w
	from	prescr_recomendacao b,
			prescr_rec_hor a,
			prescr_medica c where	b.nr_prescricao	= a.nr_prescricao
	and		b.nr_sequencia = a.nr_seq_recomendacao
	and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
	and		coalesce(b.qt_recomendacao,1) = coalesce(qt_item_p,coalesce(b.qt_recomendacao,1))
	and		a.cd_recomendacao = cd_item_p
	and		a.dt_horario = dt_horario_p
	and		coalesce(a.ie_horario_especial,'N')	= 'N'
	and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_recomendacao,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
	and		c.nr_prescricao = b.nr_prescricao
	and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
	and		coalesce(a.ie_situacao,'A') = 'A'
	and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
	and		c.dt_validade_prescr > dt_validade_w
	and		c.nr_atendimento = nr_atendimento_p
	and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
	and 	((coalesce(b.nr_seq_rec_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
	
	if (qt_hor_dupl_w > 0) then
		--ds_consistencia_w := 'O horario informado ja esta previsto para este item, favor verificar.';
		ds_consistencia_w := wheb_mensagem_pck.get_texto(294664,null);
	end if;
	
	/* verificar intervalo */

	if (cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') then
	
		/* obter horas validade prescricao */

		if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then
			select	max(nr_horas_validade)
			into STRICT	nr_horas_val_w
			from	prescr_medica where	nr_prescricao = nr_prescricao_p LIMIT 1;
		elsif (nr_prescricoes_p IS NOT NULL AND nr_prescricoes_p::text <> '') then
			nr_horas_val_w := obter_valor_dinamico_in_bv(''||
				' SELECT 	max(nr_horas_validade) '||
				' from 		prescr_medica '||
				' where	rownum = 1 and 	NR_PRESCRICAO IN :NR_PRESCRICOES', '', ':NR_PRESCRICOES', nr_prescricoes_p, ',', nr_horas_val_w);
		end if;
		
		select 	coalesce(max(ie_controla_intervalo), 'S')
		into STRICT	ie_controla_intervalo_w
		from	intervalo_prescricao
		where	cd_intervalo = cd_intervalo_p;
		
		if (ie_controla_intervalo_w = 'N') then
		
			/* obter ocorrencia intervalo */

			ie_qt_operacao_nulo_w := 'N';

			if (coalesce(ie_acm_sn_p,'N') = 'S') then
				
				select	coalesce(max('S'),'N')
				into STRICT	ie_qt_operacao_nulo_w
				from	intervalo_prescricao
				where	cd_intervalo = cd_intervalo_p
				and 	coalesce(coalesce(ie_se_necessario,ie_acm),'N') = 'S'
				and		coalesce(qt_operacao::text, '') = '';
				
				if (ie_qt_operacao_nulo_w = 'S') then
					qt_interv_w := 999;
				end if;
				
			end if;
				
			if (ie_qt_operacao_nulo_w = 'N') then
				qt_interv_w := obter_ocorrencia_intervalo(cd_intervalo_p,24,'O');
			end if;
			
			select	count(*)
			into STRICT	qt_hor_int_w
			from	prescr_recomendacao b,
					prescr_rec_hor a,
					prescr_medica c
			where	b.nr_prescricao			= a.nr_prescricao
			and		b.nr_sequencia = a.nr_seq_recomendacao
			and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
			and		coalesce(b.qt_recomendacao,1) = coalesce(qt_item_p,coalesce(b.qt_recomendacao,1))
			and		a.cd_recomendacao = cd_item_p
			and		coalesce(a.ie_horario_especial,'N')	= 'N'
			and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_recomendacao,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
			and		c.nr_prescricao = b.nr_prescricao
			and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
			and		coalesce(a.ie_situacao,'A') = 'A'
			and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
			and		c.dt_validade_prescr > dt_validade_w
			and		c.nr_atendimento = nr_atendimento_p
			and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
			and		(((ie_consistir_acm_w = 'S') and
						  ((coalesce(b.ie_acm, 'N')		= 'S') or (coalesce(b.ie_se_necessario, 'N') = 'S'))) or
						 ((coalesce(b.ie_acm, 'N') = 'N') and (coalesce(b.ie_se_necessario, 'N') = 'N')))
			and 	((coalesce(b.nr_seq_rec_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = ''));
			
			if (qt_hor_int_w >= qt_interv_w) and (varie_permite_apraz_w <> 'S') then
				--ds_consistencia_w := 'O horario informado nao esta de acordo com o intervalo previsto para este item, favor verificar.';
				ds_consistencia_w := wheb_mensagem_pck.get_texto(1112863,null);
			end if;
		
		else
		
			/* obter ocorrencia intervalo */

			ie_qt_operacao_nulo_w := 'N';
			
			if (coalesce(ie_acm_sn_p,'N') = 'S') then
				
				select	coalesce(max('S'),'N')
				into STRICT	ie_qt_operacao_nulo_w
				from	intervalo_prescricao
				where	cd_intervalo = cd_intervalo_p
				and 	coalesce(coalesce(ie_se_necessario,ie_acm),'N') = 'S'
				and		coalesce(qt_operacao::text, '') = '';
				
				if (ie_qt_operacao_nulo_w = 'S') then
					qt_interv_w := 0;
				end if;
				
			end if;
			
			if (ie_qt_operacao_nulo_w = 'N') then
				qt_interv_w := obter_ocorrencia_intervalo(cd_intervalo_p,24,'H');
			end if;
			
			select 	coalesce(qt_min_intervalo,0)
			into STRICT	qt_min_intervalo_w
			from	intervalo_prescricao where		cd_intervalo = cd_intervalo_p LIMIT 1;
			
			if (qt_min_intervalo_w = 0) then
				/* verificar horarios anteriores x intervalo */

				select	count(*)
				into STRICT	qt_hor_int_w
				from	prescr_recomendacao b,
						prescr_rec_hor a,
						prescr_medica c where	b.nr_prescricao			= a.nr_prescricao
				and		b.nr_sequencia = a.nr_seq_recomendacao
				and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
				and		coalesce(b.qt_recomendacao,1) = coalesce(qt_item_p,coalesce(b.qt_recomendacao,1))
				and		a.cd_recomendacao = cd_item_p
				and		a.dt_horario < dt_horario_p
				and		a.dt_horario > dt_horario_p - qt_interv_w / 24
				and		coalesce(a.ie_horario_especial,'N')	= 'N'
				and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_recomendacao,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
				and		c.nr_prescricao = b.nr_prescricao
				and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
				and		coalesce(a.ie_situacao,'A') = 'A'
				and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
				and		c.dt_validade_prescr > dt_validade_w
				and		c.nr_atendimento = nr_atendimento_p
				and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
				and		(((ie_consistir_acm_w = 'S') and
							  ((coalesce(b.ie_acm, 'N')		= 'S') or (coalesce(b.ie_se_necessario, 'N') = 'S'))) or
							 ((coalesce(b.ie_acm, 'N') = 'N') and (coalesce(b.ie_se_necessario, 'N') = 'N')))
				and 	((coalesce(b.nr_seq_rec_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
			else
				/* verificar horarios anteriores x intervalo */

				select	count(*)
				into STRICT	qt_hor_int_w
				from	prescr_recomendacao b,
						prescr_rec_hor a,
						prescr_medica c where	b.nr_prescricao			= a.nr_prescricao
				and		b.nr_sequencia = a.nr_seq_recomendacao
				and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
				and		coalesce(b.qt_recomendacao,1) = coalesce(qt_item_p,coalesce(b.qt_recomendacao,1))
				and		a.cd_recomendacao = cd_item_p
				and		a.dt_horario < dt_horario_p
				and		a.dt_horario > dt_horario_p - qt_min_intervalo_w / 1440
				and		coalesce(a.ie_horario_especial,'N')	= 'N'
				and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_recomendacao,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
				and		c.nr_prescricao = b.nr_prescricao
				and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
				and		coalesce(a.ie_situacao,'A') = 'A'
				and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
				and		c.dt_validade_prescr > dt_validade_w
				and		c.nr_atendimento = nr_atendimento_p
				and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
				and		(((ie_consistir_acm_w = 'S') and
							  ((coalesce(b.ie_acm, 'N')		= 'S') or (coalesce(b.ie_se_necessario, 'N') = 'S'))) or
							 ((coalesce(b.ie_acm, 'N') = 'N') and (coalesce(b.ie_se_necessario, 'N') = 'N')))
				and 	((coalesce(b.nr_seq_rec_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
			end if;
			
			if (qt_hor_int_w > 0) and (varie_permite_apraz_w <> 'S') then
				---ds_consistencia_w := 'O horario informado nao esta de acordo com o intervalo previsto para este item, favor verificar.';
				ds_consistencia_w := wheb_mensagem_pck.get_texto(1112863,null);
			end if;
			
			if (qt_min_intervalo_w = 0) then
				/* verificar horarios posteriores x intervalo */

				select	count(*)
				into STRICT	qt_hor_int_w
				from	prescr_recomendacao b,
						prescr_rec_hor a,
						prescr_medica c where	b.nr_prescricao			= a.nr_prescricao
				and		b.nr_sequencia			= a.nr_seq_recomendacao
				and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')
				and		coalesce(b.qt_recomendacao,1)		= coalesce(qt_item_p,coalesce(b.qt_recomendacao,1))
				and		a.cd_recomendacao			= cd_item_p
				and		a.dt_horario				> dt_horario_p
				and		a.dt_horario				< dt_horario_p + qt_interv_w / 24
				and		coalesce(a.ie_horario_especial,'N')	= 'N'
				and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_recomendacao,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
				and		c.nr_prescricao = b.nr_prescricao
				and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
				and		coalesce(a.ie_situacao,'A') = 'A'
				and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
				and		c.dt_validade_prescr > dt_validade_w
				and		c.nr_atendimento = nr_atendimento_p
				and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
				and		(((ie_consistir_acm_w = 'S') and
							  ((coalesce(b.ie_acm, 'N')		= 'S') or (coalesce(b.ie_se_necessario, 'N') = 'S'))) or
							 ((coalesce(b.ie_acm, 'N') = 'N') and (coalesce(b.ie_se_necessario, 'N') = 'N')))
				and 	((coalesce(b.nr_seq_rec_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
			else
				/* verificar horarios posteriores x intervalo */

				select	count(*)
				into STRICT	qt_hor_int_w
				from	prescr_recomendacao b,
						prescr_rec_hor a,
						prescr_medica c where	b.nr_prescricao			= a.nr_prescricao
				and		b.nr_sequencia			= a.nr_seq_recomendacao
				and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')
				and		coalesce(b.qt_recomendacao,1)		= coalesce(qt_item_p,coalesce(b.qt_recomendacao,1))
				and		a.cd_recomendacao			= cd_item_p
				and		a.dt_horario				> dt_horario_p
				and		a.dt_horario				< dt_horario_p + qt_min_intervalo_w / 1440
				and		coalesce(a.ie_horario_especial,'N')	= 'N'
				and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_recomendacao,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
				and		c.nr_prescricao = b.nr_prescricao
				and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
				and		coalesce(a.ie_situacao,'A') = 'A'
				and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
				and		c.dt_validade_prescr > dt_validade_w
				and		c.nr_atendimento = nr_atendimento_p
				and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
				and		(((ie_consistir_acm_w = 'S') and
							  ((coalesce(b.ie_acm, 'N')		= 'S') or (coalesce(b.ie_se_necessario, 'N') = 'S'))) or
							 ((coalesce(b.ie_acm, 'N') = 'N') and (coalesce(b.ie_se_necessario, 'N') = 'N')))
				and 	((coalesce(b.nr_seq_rec_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
			end if;
			
			if (qt_hor_int_w > 0) and (varie_permite_apraz_w <> 'S') then
				--ds_consistencia_w := 'O horario informado nao esta de acordo com o intervalo previsto para este item, favor verificar.';
				ds_consistencia_w := wheb_mensagem_pck.get_texto(1112863,null);
			end if;		
			
		end if;
		
	end if;		
	
elsif (ie_tipo_item_p = 'E') then

	/* verificar validade prescricoes */

	select	count(*)
	into STRICT	qt_hor_inv_w
	from	pe_prescricao a where	dt_horario_p between a.dt_inicio_prescr and a.dt_validade_prescr
	and		((obter_se_valor_contido(a.nr_sequencia,coalesce(nr_prescricoes_p,to_char(a.nr_sequencia))) = 'S') or (exists (	SELECT 	1
						from	prescr_medica b where		b.nr_prescricao = a.nr_prescricao
						and		coalesce(b.dt_suspensao::text, '') = ''
						and		(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') LIMIT 1)))
	and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and		dt_validade_prescr > dt_validade_w
	and		nr_atendimento = nr_atendimento_p LIMIT 1;
	
	if (qt_hor_inv_w = 0) then		
		--ds_consistencia_w := 'O horario informado esta fora do periodo de validade das prescricoes vigentes deste item, favor verificar.';
		ds_consistencia_w := wheb_mensagem_pck.get_texto(294671,null);
	end if;	

	/* verificar horarios duplicados */

	select	count(*)
	into STRICT	qt_hor_dupl_w
	from	pe_prescr_proc b,
			pe_prescr_proc_hor a,
			pe_prescricao c where	b.nr_seq_prescr			= a.nr_seq_pe_prescr
	and		b.nr_sequencia			= a.nr_seq_pe_proc
	and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')
	and		a.nr_seq_proc				= cd_item_p
	and		a.dt_horario				= dt_horario_p
	and		coalesce(a.ie_horario_especial,'N')	= 'N'
	and		coalesce(a.ie_situacao,'A') = 'A'
	and		obter_se_prescr_adep(a.nr_seq_pe_prescr,a.nr_seq_pe_proc,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
	and		c.nr_sequencia = b.nr_seq_prescr
	and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
	and		c.dt_validade_prescr > dt_validade_w
	and		c.nr_atendimento = nr_atendimento_p LIMIT 1;	
	
	if (qt_hor_dupl_w > 0) then
		--ds_consistencia_w := 'O horario informado ja esta previsto para este item, favor verificar.';
		ds_consistencia_w := wheb_mensagem_pck.get_texto(294664,null);
	end if;
	
	/* verificar intervalo */

	if (cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') then
	
		nr_horas_val_w := 24;
		
		/* obter ocorrencia intervalo */

		qt_interv_w := obter_ocorrencia_intervalo(cd_intervalo_p,nr_horas_val_w,'H');
		
		/* verificar horarios anteriores x intervalo */

		select	count(*)
		into STRICT	qt_hor_int_w
		from	pe_prescr_proc b,
				pe_prescr_proc_hor a,
				pe_prescricao c where	b.nr_seq_prescr			= a.nr_seq_pe_prescr
		and		b.nr_sequencia			= a.nr_seq_pe_proc
		and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')
		and		a.nr_seq_proc				= cd_item_p
		and		a.dt_horario				< dt_horario_p
		and		a.dt_horario				> dt_horario_p - qt_interv_w / 24
		and		coalesce(a.ie_horario_especial,'N')	= 'N'
		and		coalesce(a.ie_situacao,'A') = 'A'
		and		obter_se_prescr_adep(a.nr_seq_pe_prescr,a.nr_seq_pe_proc,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
		and		c.nr_sequencia = b.nr_seq_prescr
		and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
		and		c.dt_validade_prescr > dt_validade_w
		and		c.nr_atendimento = nr_atendimento_p LIMIT 1;		
		
		if (qt_hor_int_w > 0) and (varie_permite_apraz_w <> 'S') then
			--ds_consistencia_w := 'O horario informado nao esta de acordo com o intervalo previsto para este item, favor verificar.';
			ds_consistencia_w := wheb_mensagem_pck.get_texto(1112863,null);
		end if;
		
		/* verificar horarios posteriores x intervalo */

		select	count(*)
		into STRICT	qt_hor_int_w
		from	pe_prescr_proc b,
				pe_prescr_proc_hor a,
				pe_prescricao c where	b.nr_seq_prescr			= a.nr_seq_pe_prescr
		and		b.nr_sequencia			= a.nr_seq_pe_proc
		and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')
		and		a.nr_seq_proc				= cd_item_p
		and		a.dt_horario				> dt_horario_p
		and		a.dt_horario				< dt_horario_p + qt_interv_w / 24
		and		coalesce(a.ie_horario_especial,'N')	= 'N'
		and		coalesce(a.ie_situacao,'A') = 'A'
		and		obter_se_prescr_adep(a.nr_seq_pe_prescr,a.nr_seq_pe_proc,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
		and		c.nr_sequencia = b.nr_seq_prescr
		and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
		and		c.dt_validade_prescr > dt_validade_w
		and		c.nr_atendimento = nr_atendimento_p LIMIT 1;
		
		if (qt_hor_int_w > 0) and (varie_permite_apraz_w <> 'S') then
			--ds_consistencia_w := 'O horario informado nao esta de acordo com o intervalo previsto para este item, favor verificar.';
			ds_consistencia_w := wheb_mensagem_pck.get_texto(1112863,null);
		end if;		
		
	end if;	

elsif (ie_tipo_item_p = 'SNE') then

	select	count(*)
	into STRICT	qt_hor_inv_w
	from	prescr_medica a where	dt_horario_p between a.dt_inicio_prescr and a.dt_validade_prescr	
	and		((obter_se_valor_contido(a.nr_prescricao,coalesce(nr_prescricoes_p,a.nr_prescricao)) = 'S') or (exists (SELECT 	1
					 from	prescr_medica b where	b.nr_atendimento = a.nr_atendimento			
					 and	coalesce(b.dt_suspensao::text, '') = ''
					 and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') LIMIT 1)))
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
	and		a.dt_validade_prescr > dt_validade_w
	and		a.nr_atendimento = nr_atendimento_p LIMIT 1;
	
	if (qt_hor_inv_w = 0) then
	
		select	max(dt_validade_prescr),
				min(dt_inicio_prescr)
		into STRICT	dt_validade_prescr_w,
				dt_inicio_prescr_w
		from	prescr_medica where	obter_se_valor_contido(nr_prescricao,coalesce(nr_prescricoes_p,nr_prescricao)) = 'S'
		and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,cd_setor_atendimento,coalesce(ie_adep,'S')) = 'S'
		and		dt_validade_prescr > dt_validade_w
		and		nr_atendimento = nr_atendimento_p LIMIT 1;
		
		if	((ie_acm_sn_p = 'S' AND ie_permite_aprazar_w = 'T') or (ie_permite_aprazar_w = 'S')) and (dt_horario_p < dt_inicio_prescr_w) then
			ds_consistencia_w := null;
		else
			
			if (dt_validade_prescr_w IS NOT NULL AND dt_validade_prescr_w::text <> '' AND dt_inicio_prescr_w IS NOT NULL AND dt_inicio_prescr_w::text <> '') then	
				ds_consistencia_w := wheb_mensagem_pck.get_texto(294663, 'VALMINIMA='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_inicio_prescr_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)||';VALMAX='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_validade_prescr_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone));
			else
				ds_consistencia_w := wheb_mensagem_pck.get_texto(294671);	
			end if;
		
		end if;
	end if;	
	
	select	count(*)
	into STRICT	qt_hor_inv_w
	from	prescr_medica 	a,
			prescr_material	b,
			cpoe_dieta 		c
	where	a.nr_prescricao = b.nr_prescricao
	and		b.nr_seq_dieta_cpoe = c.nr_sequencia
	and		dt_horario_p > coalesce(cpoe_obter_termino_item(c.nr_sequencia, 'N'),a.dt_validade_prescr)
	and		obter_se_valor_contido(a.nr_prescricao,coalesce(nr_prescricoes_p,a.nr_prescricao)) = 'S'
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		b.cd_material = cd_item_p
	and		b.ie_agrupador = 8
	and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
	and		a.dt_validade_prescr > dt_validade_w
	and		a.nr_atendimento = nr_atendimento_p
	and 	((coalesce(c.nr_sequencia, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
	
	if (qt_hor_inv_w > 0) then
	
		select	max(c.dt_suspensao),
				max(c.dt_fim)
		into STRICT	dt_suspensao_cpoe_w,
				dt_fim_cpoe_w
		from	prescr_medica 	a,
				prescr_material	b,
				cpoe_dieta 		c
		where	a.nr_prescricao = b.nr_prescricao
		and		b.nr_seq_dieta_cpoe = c.nr_sequencia
		and		dt_horario_p > cpoe_obter_termino_item(c.nr_sequencia, 'N')
		and		obter_se_valor_contido(a.nr_prescricao,coalesce(nr_prescricoes_p,a.nr_prescricao)) = 'S'
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		b.ie_agrupador = 8
		and		b.cd_material = cd_item_p
		and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
		and		a.dt_validade_prescr > dt_validade_w
		and		a.nr_atendimento = nr_atendimento_p
		and 	((coalesce(c.nr_sequencia, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = ''))
		and             c.cd_funcao_origem = 2314 LIMIT 1;
		
		if (dt_suspensao_cpoe_w IS NOT NULL AND dt_suspensao_cpoe_w::text <> '') then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(820331,null) || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_suspensao_cpoe_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone);
		elsif (dt_fim_cpoe_w IS NOT NULL AND dt_fim_cpoe_w::text <> '') then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(820333,null) || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_fim_cpoe_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone);			
		end if;
			
	end if;
	
	if (cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') then
		/* obter horas validade prescricao */

		if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then
			select	max(nr_horas_validade)
			into STRICT	nr_horas_val_w
			from	prescr_medica where	nr_prescricao = nr_prescricao_p LIMIT 1;

		elsif (nr_prescricoes_p IS NOT NULL AND nr_prescricoes_p::text <> '') then
			nr_horas_val_w := obter_valor_dinamico_in_bv(' SELECT 	max(nr_horas_validade) '||
				' from 		prescr_medica '||
				' where	rownum = 1 and 	NR_PRESCRICAO IN :NR_PRESCRICOES', '', ':NR_PRESCRICOES', nr_prescricoes_p, ',', nr_horas_val_w);

		end if;
		select 	coalesce(max(ie_controla_intervalo), 'S')
		into STRICT	ie_controla_intervalo_w
		from	intervalo_prescricao
		where	cd_intervalo = cd_intervalo_p;

		select 	coalesce(qt_min_intervalo,0)
		into STRICT	qt_min_intervalo_w
		from	intervalo_prescricao where		cd_intervalo = cd_intervalo_p LIMIT 1;
		if (ie_controla_intervalo_w = 'N') then
			
			ie_qt_operacao_nulo_w := 'N';

			if (coalesce(ie_acm_sn_p,'N') = 'S') then

				select	coalesce(max('S'),'N')
				into STRICT	ie_qt_operacao_nulo_w
				from	intervalo_prescricao
				where	cd_intervalo = cd_intervalo_p
				and 	coalesce(coalesce(ie_se_necessario,ie_acm),'N') = 'S'
				and		coalesce(qt_operacao::text, '') = '';
				
				if (ie_qt_operacao_nulo_w = 'S') then
					qt_interv_w := 999;
				end if;
				
			end if;
				
			if (ie_qt_operacao_nulo_w = 'N') then
				qt_interv_w := obter_ocorrencia_intervalo(cd_intervalo_p,24,'O');
			end if;

            select  count(*)
            into STRICT    qt_hor_int_w
            from    prescr_material b,
                    prescr_mat_hor a,
                    prescr_medica c
            where   b.nr_prescricao	= a.nr_prescricao
            and	    b.nr_sequencia = a.nr_seq_material
            and	    c.nr_prescricao = b.nr_prescricao
            and	    coalesce(cd_unidade_medida_p,'XPTO')	in ('XPTO', a.cd_unidade_medida_dose)
            and	    coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')			
            and	    coalesce(b.qt_dose,1) = coalesce(qt_item_p,b.qt_dose,1)
            and	    a.ie_agrupador = 8
            and	    a.cd_material = cd_item_p
            and	    coalesce(a.ie_horario_especial,'N') = 'N'
            and	    coalesce(a.ie_adep,'S') = 'S'
            and	    coalesce(a.dt_suspensao::text, '') = ''
            and	    coalesce(b.dt_suspensao::text, '') = ''
            and	    coalesce(a.dt_recusa::text, '') = ''
            and	    coalesce(c.ie_adep,'S') = 'S'
            and	    coalesce(a.ie_dose_especial,'N') = 'N'
            and	    coalesce(a.ie_situacao,'A') = 'A'
            and	    obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p			
            and	    Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
            and	    (c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
            and		((nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '' AND c.nr_prescricao = nr_prescricao_p) or (c.nr_prescricao in (SELECT x.cd_registro from table(lista_pck.obter_lista_char(nr_prescricoes_p)) x) and
                        dt_horario_p between c.dt_inicio_prescr and c.dt_validade_prescr))
            and	    c.dt_validade_prescr > dt_validade_w
            and	    c.nr_atendimento = nr_atendimento_p
            and     ((coalesce(b.nr_seq_dieta_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = ''));

			if (qt_hor_int_w >= qt_interv_w) and (varie_permite_apraz_w <> 'S') and (dose_range_max_valid(nr_seq_cpoe_p, nr_prescricao_p, 0, null, dt_horario_p, nm_usuario_p) = 'N') then
				--ds_consistencia_w := 'O horario informado nao esta de acordo com o intervalo previsto para este item, favor verificar.';
				ds_consistencia_w := wheb_mensagem_pck.get_texto(1112863,null);
			end if;

		else
			/* obter ocorrencia intervalo */

			ie_qt_operacao_nulo_w := 'N';
			if (coalesce(ie_acm_sn_p,'N') = 'S') then
				select	coalesce(max('S'),'N')
				into STRICT	ie_qt_operacao_nulo_w
				from	intervalo_prescricao
				where	cd_intervalo = cd_intervalo_p
				and 	coalesce(coalesce(ie_se_necessario,ie_acm),'N') = 'S'
				and		coalesce(qt_operacao::text, '') = '';
				if (ie_qt_operacao_nulo_w = 'S') then
					qt_interv_w := 0;
				end if;
			end if;
			if (ie_qt_operacao_nulo_w = 'N') then
				qt_interv_w := obter_ocorrencia_intervalo(cd_intervalo_p,24,'H');
			end if;
			if (qt_min_intervalo_w = 0) then
				begin
					/* verificar horarios anteriores x intervalo */

					select	count(*)
					into STRICT	qt_hor_int_w
					from	prescr_material b,
							prescr_mat_hor a,
							prescr_medica c where		b.nr_prescricao = a.nr_prescricao
					and		b.nr_sequencia = a.nr_seq_material
					and		coalesce(cd_unidade_medida_p,'XPTO')	in ('XPTO', a.cd_unidade_medida_dose)
					and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
					and		coalesce(b.qt_dose,1) = coalesce(qt_item_p,b.qt_dose,1)
					and		a.ie_agrupador = 8
					and		a.cd_material = cd_item_p
					and (a.dt_horario < dt_horario_p and
							a.dt_horario > dt_horario_p - qt_interv_w / 24)
					and		coalesce(a.ie_horario_especial,'N')	= 'N'
					and		coalesce(a.ie_adep,'S') = 'S'
					and		((obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_material,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S') or (c.cd_funcao_origem = 2314 and
							coalesce(b.nr_seq_dieta_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0) and
							b.nr_prescricao in (SELECT 	x.nr_registro
												from 	table(lista_pck.obter_lista(nr_prescricoes_p)) x)))
					and		c.nr_prescricao = b.nr_prescricao
					and		coalesce(c.ie_adep,'S') = 'S'
					and		coalesce(a.dt_suspensao::text, '') = ''
					and		coalesce(b.dt_suspensao::text, '') = ''
					and		coalesce(a.dt_recusa::text, '') = ''
					and		coalesce(a.ie_dose_especial,'N') = 'N'
					and		coalesce(a.ie_situacao,'A') = 'A'
					and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p	
					and		(((ie_consistir_acm_w = 'S') and 
							((coalesce(b.ie_acm, 'N') = 'S') or (coalesce(b.ie_se_necessario, 'N') = 'S'))) or
							((coalesce(b.ie_acm, 'N') = 'N') and (coalesce(b.ie_se_necessario, 'N') = 'N')))
					and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
					and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
					and		c.dt_validade_prescr > dt_validade_w
					and		c.nr_atendimento = nr_atendimento_p
					and 	((coalesce(b.nr_seq_dieta_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
				end;
			else
				begin
					/* verificar horarios anteriores x intervalo */

					select	count(*)
					into STRICT	qt_hor_int_w
					from	prescr_material b,
							prescr_mat_hor a,
							prescr_medica c where		b.nr_prescricao = a.nr_prescricao
					and		b.nr_sequencia	= a.nr_seq_material
					and		coalesce(cd_unidade_medida_p,'XPTO')	in ('XPTO', a.cd_unidade_medida_dose)
					and		coalesce(b.cd_intervalo,'XPTO')	= coalesce(cd_intervalo_p,'XPTO')
					and		coalesce(b.qt_dose,1)		= coalesce(qt_item_p,b.qt_dose,1)
					and		a.ie_agrupador = 8
					and		a.cd_material = cd_item_p
					and (a.dt_horario < dt_horario_p and
							a.dt_horario > dt_horario_p - qt_min_intervalo_w / 1440)
					and		coalesce(a.ie_horario_especial,'N')	= 'N'
					and		coalesce(a.ie_adep,'S') = 'S'
					and		((obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_material,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S') or (c.cd_funcao_origem = 2314 and
							coalesce(b.nr_seq_dieta_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0) and
							b.nr_prescricao in (SELECT 	x.nr_registro
												from 	table(lista_pck.obter_lista(nr_prescricoes_p)) x)))
					and		c.nr_prescricao = b.nr_prescricao
					and		coalesce(a.ie_adep,'S') = 'S'
					and		coalesce(a.dt_suspensao::text, '') = ''
					and		coalesce(b.dt_suspensao::text, '') = ''
					and		coalesce(a.dt_recusa::text, '') = ''
					and		coalesce(c.ie_adep,'S') = 'S'
					and		coalesce(a.ie_dose_especial,'N') = 'N'
					and		coalesce(a.ie_situacao,'A') = 'A'
					and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p	
					and		(((ie_consistir_acm_w = 'S') and 
							((coalesce(b.ie_acm, 'N') = 'S') or (coalesce(b.ie_se_necessario, 'N') = 'S'))) or
							((coalesce(b.ie_acm, 'N') = 'N') and (coalesce(b.ie_se_necessario, 'N') = 'N')))
					and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
					and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
					and		c.dt_validade_prescr > dt_validade_w
					and		c.nr_atendimento = nr_atendimento_p
					and 	((coalesce(b.nr_seq_dieta_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
				end;
			end if;
			if (qt_hor_int_w > 0) and (varie_permite_apraz_w <> 'S') and (dose_range_max_valid(nr_seq_cpoe_p, nr_prescricao_p, 0, null, dt_horario_p, nm_usuario_p) = 'N') then
				ds_consistencia_w := wheb_mensagem_pck.get_texto(1112863,null);
			end if;
		    if (qt_min_intervalo_w = 0) then
				begin
					/* verificar horarios posteriores x intervalo */

					select	count(*)
					into STRICT	qt_hor_int_w
					from	prescr_material b,
							prescr_mat_hor a,
							prescr_medica c where		b.nr_prescricao = a.nr_prescricao
					and		b.nr_sequencia	= a.nr_seq_material
					and		coalesce(cd_unidade_medida_p,'XPTO')	in ('XPTO', a.cd_unidade_medida_dose)
					and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
					and		coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))
					and		a.ie_agrupador = 8
					and		a.cd_material = cd_item_p
					and (a.dt_horario > dt_horario_p and
							a.dt_horario < dt_horario_p + qt_interv_w / 24)
					and		coalesce(a.ie_horario_especial,'N')	= 'N'
					and		coalesce(a.ie_adep,'S') = 'S'
					and		((obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_material,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S') or (c.cd_funcao_origem = 2314 and
							coalesce(b.nr_seq_dieta_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0) and
							b.nr_prescricao in (SELECT 	x.nr_registro
												from 	table(lista_pck.obter_lista(nr_prescricoes_p)) x)))
					and		c.nr_prescricao = b.nr_prescricao
					and		coalesce(a.ie_adep,'S') = 'S'
					and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
					and		coalesce(a.ie_dose_especial,'N') = 'N'
					and		coalesce(a.ie_situacao,'A') = 'A'
					and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p
					and		coalesce(a.dt_suspensao::text, '') = ''
					and		coalesce(b.dt_suspensao::text, '') = ''
					and		coalesce(a.dt_recusa::text, '') = ''
					and		(((ie_consistir_acm_w = 'S') and 
							((coalesce(b.ie_acm, 'N') = 'S') or (coalesce(b.ie_se_necessario, 'N') = 'S'))) or
							((coalesce(b.ie_acm, 'N') = 'N') and (coalesce(b.ie_se_necessario, 'N') = 'N')))
					and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
					and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
					and		c.dt_validade_prescr > dt_validade_w
					and		c.nr_atendimento = nr_atendimento_p
					and 	((coalesce(b.nr_seq_dieta_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
				end;
			else
				begin
				/* verificar horarios posteriores x intervalo */

		     	select	count(*)
				into STRICT	qt_hor_int_w
				from	prescr_material b,
						prescr_mat_hor a,
						prescr_medica c where		b.nr_prescricao = a.nr_prescricao
				and		b.nr_sequencia = a.nr_seq_material
				and		coalesce(cd_unidade_medida_p,'XPTO')	in ('XPTO', a.cd_unidade_medida_dose)
				and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
				and		coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))
				and		a.ie_agrupador = 8
				and		a.cd_material = cd_item_p
				and (a.dt_horario > dt_horario_p and
						a.dt_horario < dt_horario_p + qt_min_intervalo_w / 1440)
				and		coalesce(a.ie_horario_especial,'N')	= 'N'
				and		coalesce(a.ie_adep,'S') = 'S'
				and		((obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_material,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S') or (c.cd_funcao_origem = 2314 and
						coalesce(b.nr_seq_dieta_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0) and
						b.nr_prescricao in (SELECT 	x.nr_registro
											from 	table(lista_pck.obter_lista(nr_prescricoes_p)) x)))
				and		c.nr_prescricao = b.nr_prescricao
				and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
				and		coalesce(a.ie_dose_especial,'N') = 'N'
				and		coalesce(a.ie_situacao,'A') = 'A'
				and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p
				and		coalesce(a.dt_suspensao::text, '') = ''
				and		coalesce(b.dt_suspensao::text, '') = ''
				and		coalesce(a.dt_recusa::text, '') = ''
				and		(((ie_consistir_acm_w = 'S') and 
						  ((coalesce(b.ie_acm, 'N') = 'S') or (coalesce(b.ie_se_necessario, 'N') = 'S'))) or
						 ((coalesce(b.ie_acm, 'N') = 'N') and (coalesce(b.ie_se_necessario, 'N') = 'N')))
				and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
				and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')			
				and		c.dt_validade_prescr > dt_validade_w
				and		c.nr_atendimento = nr_atendimento_p
				and 	((coalesce(b.nr_seq_dieta_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;

				end;
			end if;
		    if (qt_hor_int_w > 0) and (varie_permite_apraz_w <> 'S') and (dose_range_max_valid(nr_seq_cpoe_p, nr_prescricao_p, 0, null, dt_horario_p, nm_usuario_p) = 'N') then
				--ds_consistencia_w := 'O horario informado nao esta de acordo com o intervalo previsto para este item, favor verificar.';
				ds_consistencia_w := wheb_mensagem_pck.get_texto(1112863,null);
			end if;
		end if;
	end if;
	/* Verificar horas aprazamento */

	if (ie_acm_sn_p = 'S') then
		qt_hor_aprazamento_w	:= Wheb_assist_pck.obterParametroFuncao(1113,692);
		if (qt_hor_aprazamento_w > 0) and (dt_horario_p > (clock_timestamp() + (qt_hor_aprazamento_w/24))) then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(718513,null);
		end if;
	end if;

elsif (ie_tipo_item_p in ('C','G')) then

	/* verificar validade prescricoes */

	
	select	count(*)
	into STRICT	qt_hor_inv_w
	from	prescr_medica where	dt_horario_p between dt_inicio_prescr and dt_validade_prescr
	and		obter_se_valor_contido(nr_prescricao,coalesce(nr_prescricoes_p,nr_prescricao)) = 'S'
	and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,cd_setor_atendimento,coalesce(ie_adep,'S')) = 'S'
	and		dt_validade_prescr > dt_validade_w
	and		nr_atendimento = nr_atendimento_p LIMIT 1;
	
	if (qt_hor_inv_w = 0) then
	
		select	max(dt_validade_prescr),
				min(dt_inicio_prescr)
		into STRICT	dt_validade_prescr_w,
				dt_inicio_prescr_w
		from	prescr_medica where	obter_se_valor_contido(nr_prescricao,coalesce(nr_prescricoes_p,nr_prescricao)) = 'S'
		and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,cd_setor_atendimento,coalesce(ie_adep,'S')) = 'S'
		and		dt_validade_prescr > dt_validade_w
		and		nr_atendimento = nr_atendimento_p LIMIT 1;
		
		if (dt_validade_prescr_w IS NOT NULL AND dt_validade_prescr_w::text <> '' AND dt_inicio_prescr_w IS NOT NULL AND dt_inicio_prescr_w::text <> '') then	
			ds_consistencia_w := wheb_mensagem_pck.get_texto(294663, 'VALMINIMA='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_inicio_prescr_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)||';VALMAX='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_validade_prescr_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone));
		else
			ds_consistencia_w := wheb_mensagem_pck.get_texto(294671);	
		end if;
		
	end if;

	select	count(*)
	into STRICT	qt_hor_inv_w
	from	prescr_medica 	a,
			prescr_procedimento	b,
			cpoe_procedimento 		c
	where	a.nr_prescricao = b.nr_prescricao
	and		b.nr_seq_proc_cpoe = c.nr_sequencia
	and		dt_horario_p > coalesce(cpoe_obter_termino_item(c.nr_sequencia, 'P'),a.dt_validade_prescr)
	and		obter_se_valor_contido(a.nr_prescricao,coalesce(nr_prescricoes_p,a.nr_prescricao)) = 'S'
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		b.cd_procedimento = cd_item_p
	and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
	and		a.dt_validade_prescr > dt_validade_w
	and		a.nr_atendimento = nr_atendimento_p
	and 	((coalesce(c.nr_sequencia, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
	
	
	if (qt_hor_inv_w > 0) then
	
		select	max(c.dt_suspensao),
				max(c.dt_fim)
		into STRICT	dt_suspensao_cpoe_w,
				dt_fim_cpoe_w
		from	prescr_medica 	a,
				prescr_procedimento	b,
				cpoe_procedimento 		c
		where	a.nr_prescricao = b.nr_prescricao
		and		b.nr_seq_proc_cpoe = c.nr_sequencia
		and		dt_horario_p > cpoe_obter_termino_item(c.nr_sequencia, 'P')
		and		obter_se_valor_contido(a.nr_prescricao,coalesce(nr_prescricoes_p,a.nr_prescricao)) = 'S'
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		b.cd_procedimento = cd_item_p
		and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
		and		a.dt_validade_prescr > dt_validade_w
		and		a.nr_atendimento = nr_atendimento_p
		and 	((coalesce(c.nr_sequencia, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = ''))
		and             c.cd_funcao_origem = 2314 LIMIT 1;
		
		if (dt_suspensao_cpoe_w IS NOT NULL AND dt_suspensao_cpoe_w::text <> '') then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(820331,null) || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_suspensao_cpoe_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone);
		elsif (dt_fim_cpoe_w IS NOT NULL AND dt_fim_cpoe_w::text <> '') then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(820333,null) || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_fim_cpoe_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone);			
		end if;
			
	end if; 	

	/* verificar horarios duplicados */

	select	count(*)
	into STRICT	qt_hor_dupl_w
	from	prescr_procedimento b,
			prescr_proc_hor a,
			prescr_medica c where	b.nr_prescricao			= a.nr_prescricao
	and		b.nr_sequencia			= a.nr_seq_procedimento
	and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')
	and		coalesce(b.qt_procedimento,1)		= coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
	and		a.cd_procedimento			= cd_item_p
	and		a.dt_horario				= dt_horario_p
	and		coalesce(a.ie_horario_especial,'N')	= 'N'
	and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_procedimento,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
	and		c.nr_prescricao = b.nr_prescricao
	and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
	and		coalesce(a.ie_situacao,'A') = 'A'
	and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
	and		coalesce(c.dt_suspensao::text, '') = ''
	and		c.dt_validade_prescr > dt_validade_w
	and		c.nr_atendimento = nr_atendimento_p
	and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
	and 	((coalesce(b.nr_seq_proc_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
	
	if (qt_hor_dupl_w > 0) then
		--,'O horario informado ja esta previsto para este item, favor verificar.#@#@');
		--ds_consistencia_w := 'O horario informado ja esta previsto para este item, favor verificar.';
		ds_consistencia_w := wheb_mensagem_pck.get_texto(294664,null);
	end if;
	
	--verificar intervalo
	if	((cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') and (coalesce(ds_consistencia_w::text, '') = '')) then
		--obter horas validade prescricao 
		if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then
			select	max(a.nr_horas_validade)
			into STRICT	nr_horas_val_w
			from	prescr_medica	a
			where	a.nr_prescricao = nr_prescricao_p  LIMIT 1;
		elsif (nr_prescricoes_p IS NOT NULL AND nr_prescricoes_p::text <> '') then
			select 	max(nr_horas_validade)
			into STRICT	nr_horas_val_w
			from 	prescr_medica
			where	nr_prescricao in (	SELECT	x.cd_registro
										from 	table(lista_pck.obter_lista_char(nr_prescricoes_p)) x)  LIMIT 1;
		end if;

		select 	coalesce(max(a.qt_min_intervalo),0),
				coalesce(max(ie_controla_intervalo),'S')
		into STRICT	qt_min_intervalo_w,
				ie_controla_intervalo_w
		from	intervalo_prescricao		a
		where	a.cd_intervalo = cd_intervalo_p  LIMIT 1;

		if (ie_controla_intervalo_w = 'N') then
			ie_qt_operacao_nulo_w := 'N';

			if (coalesce(ie_acm_sn_p,'N') = 'S') then
				select	coalesce(max('S'),'N')
				into STRICT	ie_qt_operacao_nulo_w
				from	intervalo_prescricao	a
				where	a.cd_intervalo = cd_intervalo_p
				and 	(CASE WHEN (a.ie_se_necessario IS NOT NULL AND a.ie_se_necessario::text <> '') THEN a.ie_acm ELSE 'N' END) = 'S'
				and		coalesce(a.qt_operacao::text, '') = '';
				
				if (ie_qt_operacao_nulo_w = 'S') then
					qt_interv_w := 999;
				end if;
				
			end if;
				
			if (ie_qt_operacao_nulo_w = 'N') then
				qt_interv_w := obter_ocorrencia_intervalo(cd_intervalo_p,24,'O');
			end if;
		
		    select	count(1)
			into STRICT	qt_hor_int_w
			from	prescr_procedimento 	b,
					prescr_proc_hor 		a,
					prescr_medica 			c
			where	b.nr_prescricao			= a.nr_prescricao
			and		b.nr_sequencia			= a.nr_seq_procedimento
			and		c.nr_atendimento		= nr_atendimento_p
			and		coalesce(b.cd_intervalo,'XPTO')	= coalesce(cd_intervalo_p,'XPTO')		
			and		coalesce(b.qt_procedimento,1)	= coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
			and		a.cd_procedimento			= cd_item_p					
			and		coalesce(a.ie_horario_especial,'N')	= 'N'
			and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_procedimento,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
			and		c.nr_prescricao = b.nr_prescricao
			and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
			and		coalesce(a.ie_situacao,'A') = 'A'
			and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
			and		coalesce(a.dt_suspensao::text, '') = ''
			and		coalesce(b.dt_suspensao::text, '') = ''			
			and		c.dt_validade_prescr > dt_validade_w
			and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p	
			and		((nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '' AND c.nr_prescricao = nr_prescricao_p) or (c.nr_prescricao = obter_max_nrprescricao(nr_prescricoes_p)))
			and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
			and		((coalesce(cpoe_obter_termino_item(b.nr_seq_proc_cpoe, 'P')::text, '') = '') or (cpoe_obter_termino_item(b.nr_seq_proc_cpoe, 'P') >= clock_timestamp()))
			and 	((coalesce(b.nr_seq_proc_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = ''));					
						
			if (qt_hor_int_w >= qt_interv_w) and (varie_permite_apraz_w <> 'S') then			
				--ds_consistencia_w := 'O horario informado nao esta de acordo com o intervalo previsto para este item, favor verificar.'
				ds_consistencia_w := wheb_mensagem_pck.get_texto(1112863);
			end if;
		else
			/* obter ocorrencia intervalo */

			ie_qt_operacao_nulo_w := 'N';
			
			if (coalesce(ie_acm_sn_p,'N') = 'S') then
				select	coalesce(max('S'),'N')
				into STRICT	ie_qt_operacao_nulo_w
				from	intervalo_prescricao	a
				where	a.cd_intervalo = cd_intervalo_p
				and 	(CASE WHEN (a.ie_se_necessario IS NOT NULL AND a.ie_se_necessario::text <> '') THEN a.ie_acm ELSE 'N' END) = 'S'
				and		coalesce(a.qt_operacao::text, '') = '';
				
				if (ie_qt_operacao_nulo_w = 'S') then
					qt_interv_w := 0;
				end if;
			end if;
				
			if (ie_qt_operacao_nulo_w = 'N') then
				qt_interv_w := obter_ocorrencia_intervalo(cd_intervalo_p,24,'H');
			end if;

			/* verificar horarios anteriores x intervalo */

     		if (qt_min_intervalo_w = 0) then
				select	count(1)
				into STRICT	qt_hor_int_w
				from	prescr_procedimento b,
						prescr_proc_hor a,
						prescr_medica c where		b.nr_prescricao			= a.nr_prescricao
				and		b.nr_sequencia			= a.nr_seq_procedimento
				and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')		
				and		coalesce(b.qt_procedimento,1)		= coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
				and		a.cd_procedimento			= cd_item_p
				and		a.dt_horario				< dt_horario_p
				and		a.dt_horario				> dt_horario_p - qt_interv_w / 24
				and		coalesce(a.ie_horario_especial,'N')	= 'N'
				and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_procedimento,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
				and		c.nr_prescricao = b.nr_prescricao
				and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
				and		coalesce(a.ie_situacao,'A') = 'A'
				and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
				and		c.dt_validade_prescr > dt_validade_w
				and		c.nr_atendimento = nr_atendimento_p
				and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p	
				and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
				and		((coalesce(cpoe_obter_termino_item(b.nr_seq_proc_cpoe, 'P')::text, '') = '') or (cpoe_obter_termino_item(b.nr_seq_proc_cpoe, 'P') >= clock_timestamp()))
				and 	((coalesce(b.nr_seq_proc_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;							
			else
				select	count(1)
				into STRICT	qt_hor_int_w
				from	prescr_procedimento b,
						prescr_proc_hor a,
						prescr_medica c where		b.nr_prescricao			= a.nr_prescricao
				and		b.nr_sequencia			= a.nr_seq_procedimento
				and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')		
				and		coalesce(b.qt_procedimento,1)		= coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
				and		a.cd_procedimento			= cd_item_p
				and		a.dt_horario				< dt_horario_p
				and		a.dt_horario				> dt_horario_p - qt_min_intervalo_w / 1440
				and		coalesce(a.ie_horario_especial,'N')	= 'N'
				and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_procedimento,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
				and		c.nr_prescricao = b.nr_prescricao
				and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
				and		coalesce(a.ie_situacao,'A') = 'A'
				and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
				and		c.dt_validade_prescr > dt_validade_w
				and		c.nr_atendimento = nr_atendimento_p
				and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p	
				and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
				and		((coalesce(cpoe_obter_termino_item(b.nr_seq_proc_cpoe, 'P')::text, '') = '') or (cpoe_obter_termino_item(b.nr_seq_proc_cpoe, 'P') >= clock_timestamp()))
				and 	((coalesce(b.nr_seq_proc_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
			end if;

			if (qt_hor_int_w > 0) and (varie_permite_apraz_w <> 'S') then
				--ds_consistencia_w := 'O horario informado nao esta de acordo com o intervalo previsto para este item, favor verificar.';
				ds_consistencia_w := wheb_mensagem_pck.get_texto(1112863);
			end if;
						
			/* verificar horarios posteriores x intervalo */

	    	if (qt_min_intervalo_w = 0) then
				select	count(1)
				into STRICT	qt_hor_int_w
				from	prescr_procedimento b,
						prescr_proc_hor a,
						prescr_medica c where		b.nr_prescricao			= a.nr_prescricao
				and		b.nr_sequencia			= a.nr_seq_procedimento
				and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')		
				and		coalesce(b.qt_procedimento,1)		= coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
				and		a.cd_procedimento			= cd_item_p
				and		a.dt_horario				> dt_horario_p
				and		a.dt_horario				< dt_horario_p + qt_interv_w / 24
				and		coalesce(a.ie_horario_especial,'N')	= 'N'
				and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_procedimento,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
				and		c.nr_prescricao = b.nr_prescricao
				and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
				and		coalesce(a.ie_situacao,'A') = 'A'
				and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
				and		c.dt_validade_prescr > dt_validade_w
				and		c.nr_atendimento = nr_atendimento_p
				and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
				and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p	
				and		((coalesce(cpoe_obter_termino_item(b.nr_seq_proc_cpoe, 'P')::text, '') = '') or (cpoe_obter_termino_item(b.nr_seq_proc_cpoe, 'P') >= clock_timestamp()))
				and 	((coalesce(b.nr_seq_proc_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
			else
		    	select	count(1)
				into STRICT	qt_hor_int_w
				from	prescr_procedimento b,
						prescr_proc_hor a,
						prescr_medica c where		b.nr_prescricao			= a.nr_prescricao
				and		b.nr_sequencia			= a.nr_seq_procedimento
				and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')		
				and		coalesce(b.qt_procedimento,1)		= coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
				and		a.cd_procedimento			= cd_item_p
				and		a.dt_horario				> dt_horario_p
				and		a.dt_horario				< dt_horario_p + qt_min_intervalo_w / 1440
				and		coalesce(a.ie_horario_especial,'N')	= 'N'
				and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_procedimento,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
				and		c.nr_prescricao = b.nr_prescricao
				and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
				and		coalesce(a.ie_situacao,'A') = 'A'
				and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
				and		c.dt_validade_prescr > dt_validade_w
				and		c.nr_atendimento = nr_atendimento_p
				and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
				and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p	
				and		((coalesce(cpoe_obter_termino_item(b.nr_seq_proc_cpoe, 'P')::text, '') = '') or (cpoe_obter_termino_item(b.nr_seq_proc_cpoe, 'P') >= clock_timestamp()))
				and 	((coalesce(b.nr_seq_proc_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
			end if;
			
			if (qt_hor_int_w > 0) and (varie_permite_apraz_w <> 'S') then
				--ds_consistencia_w := 'O horario informado nao esta de acordo com o intervalo previsto para este item, favor verificar.';
				ds_consistencia_w := wheb_mensagem_pck.get_texto(1112863,null);
			end if;	
			
		end if;
	end if;	
	
elsif (ie_tipo_item_p in ('O')) then
	select	count(*)
	into STRICT	qt_hor_inv_w
	from	prescr_medica 	a,
			prescr_gasoterapia	b,
			cpoe_gasoterapia c
	where	a.nr_prescricao = b.nr_prescricao
	and		b.nr_seq_gas_cpoe = c.nr_sequencia
	and		dt_horario_p > coalesce(cpoe_obter_termino_item(c.nr_sequencia, 'G'),a.dt_validade_prescr)
	and		obter_se_valor_contido(a.nr_prescricao,coalesce(nr_prescricoes_p,a.nr_prescricao)) = 'S'
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		c.nr_seq_gas = cd_item_p
	and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
	and		a.dt_validade_prescr > dt_validade_w
	and		a.nr_atendimento = nr_atendimento_p
	and 	((coalesce(c.nr_sequencia, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
		
	if (qt_hor_inv_w > 0) then
	
		select	max(c.dt_suspensao),
				max(c.dt_fim)
		into STRICT	dt_suspensao_cpoe_w,
				dt_fim_cpoe_w
		from	prescr_medica 	a,
			prescr_gasoterapia	b,
			cpoe_gasoterapia c
		where	a.nr_prescricao = b.nr_prescricao
		and		b.nr_seq_gas_cpoe = c.nr_sequencia
		and		dt_horario_p > cpoe_obter_termino_item(c.nr_sequencia, 'G')
		and		obter_se_valor_contido(a.nr_prescricao,coalesce(nr_prescricoes_p,a.nr_prescricao)) = 'S'
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		c.nr_seq_gas = cd_item_p--nr_seq_item_p
		and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
		and		a.dt_validade_prescr > dt_validade_w
		and		a.nr_atendimento = nr_atendimento_p
		and 	((coalesce(c.nr_sequencia, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = ''))
		and             c.cd_funcao_origem = 2314 LIMIT 1;
		
		if (dt_suspensao_cpoe_w IS NOT NULL AND dt_suspensao_cpoe_w::text <> '') then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(820331,null) ||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_suspensao_cpoe_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone);
		elsif (dt_fim_cpoe_w IS NOT NULL AND dt_fim_cpoe_w::text <> '') then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(820333,null) || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_fim_cpoe_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone);			
		end if;
	end if;
	
elsif (ie_tipo_item_p in ('LD')) then
	select	count(*)
	into STRICT	qt_hor_inv_w
	from	prescr_medica 	a,
			prescr_material	b,
			cpoe_dieta 		c
	where	a.nr_prescricao = b.nr_prescricao
	and		b.nr_seq_dieta_cpoe = c.nr_sequencia
	and		dt_horario_p > coalesce(cpoe_obter_termino_item(c.nr_sequencia, 'N'),a.dt_validade_prescr)
	and		obter_se_valor_contido(a.nr_prescricao,coalesce(nr_prescricoes_p,a.nr_prescricao)) = 'S'
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		c.cd_mat_prod1 = cd_item_p
	and		b.ie_agrupador = 16
	and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
	and		a.dt_validade_prescr > dt_validade_w
	and		a.nr_atendimento = nr_atendimento_p
	and 	((coalesce(c.nr_sequencia, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
		
	if (qt_hor_inv_w > 0) then
	
		select	max(c.dt_suspensao),
				max(c.dt_fim)
		into STRICT	dt_suspensao_cpoe_w,
				dt_fim_cpoe_w
		from	prescr_medica 	a,
				prescr_material	b,
				cpoe_dieta 		c
		where	a.nr_prescricao = b.nr_prescricao
		and		b.nr_seq_dieta_cpoe = c.nr_sequencia
		and		dt_horario_p > cpoe_obter_termino_item(c.nr_sequencia, 'N')
		and		obter_se_valor_contido(a.nr_prescricao,coalesce(nr_prescricoes_p,a.nr_prescricao)) = 'S'
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		c.cd_mat_prod1 = cd_item_p
		and		b.ie_agrupador = 16
		and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
		and		a.dt_validade_prescr > dt_validade_w
		and		a.nr_atendimento = nr_atendimento_p
		and 	((coalesce(c.nr_sequencia, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = ''))
		and             c.cd_funcao_origem = 2314 LIMIT 1;
		
		if (dt_suspensao_cpoe_w IS NOT NULL AND dt_suspensao_cpoe_w::text <> '') then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(820331,null) || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_suspensao_cpoe_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone);
		elsif (dt_fim_cpoe_w IS NOT NULL AND dt_fim_cpoe_w::text <> '') then
			ds_consistencia_w := wheb_mensagem_pck.get_texto(820333,null) || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_fim_cpoe_w, 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone);			
		end if;
			
	end if;
		
	/* verificar horarios duplicados */

	select	count(*)
	into STRICT	qt_hor_dupl_w
	from	prescr_material b,
			prescr_mat_hor a,
			prescr_medica c where	b.nr_prescricao			= a.nr_prescricao
	and		b.nr_sequencia			= a.nr_seq_material
	and		coalesce(cd_unidade_medida_p,'XPTO')	in ('XPTO', a.cd_unidade_medida_dose)
	and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')	
	and		coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))
	and		a.ie_agrupador	 = 16
	and		a.cd_material	 = cd_item_p
	and		a.dt_horario	 = dt_horario_p
	and		coalesce(a.ie_horario_especial,'N')	= 'N'
	and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_material,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
	and		c.nr_prescricao = b.nr_prescricao
	and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
	and		coalesce(c.ie_adep,'S') = 'S'
	and		coalesce(a.ie_situacao,'A') = 'A'
	and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
	and		c.dt_validade_prescr > dt_validade_w
	and		c.nr_atendimento = nr_atendimento_p
	and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
	and 	((coalesce(b.nr_seq_dieta_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
	
	if (qt_hor_dupl_w > 0) then
		--'O horario informado ja esta previsto para este item, favor verificar.#@#@');
		ds_consistencia_w := wheb_mensagem_pck.get_texto(294664, null);
	end if;
	
	/* verificar intervalo */

	if (cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') then
	
		/* obter horas validade prescricao */

		if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then
			select	max(nr_horas_validade)
			into STRICT	nr_horas_val_w
			from	prescr_medica where	nr_prescricao = nr_prescricao_p LIMIT 1;
		elsif (nr_prescricoes_p IS NOT NULL AND nr_prescricoes_p::text <> '') then
			nr_horas_val_w := OBTER_VALOR_DINAMICO_IN_BV(''||
				' select 	max(nr_horas_validade) '||
				' from 		prescr_medica '||
				' where	rownum = 1 and 	nr_prescricao in :nr_prescricoes', '', ':nr_prescricoes', nr_prescricoes_p, ',', nr_horas_val_w);
		end if;

		/* obter ocorrencia intervalo */

		qt_interv_w := obter_ocorrencia_intervalo(cd_intervalo_p,nr_horas_val_w,'H');
		
		/* verificar horarios anteriores x intervalo */

		select	count(*)
		into STRICT	qt_hor_int_w
		from	prescr_material b,
				prescr_mat_hor a,
				prescr_medica c where	b.nr_prescricao			= a.nr_prescricao
		and		b.nr_sequencia			= a.nr_seq_material
		and		coalesce(cd_unidade_medida_p,'XPTO')	in ('XPTO', a.cd_unidade_medida_dose)
		and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')		
		and		coalesce(b.qt_dose,1)		= coalesce(qt_item_p,coalesce(b.qt_dose,1))
		and		a.ie_agrupador			= 16
		and		a.cd_material				= cd_item_p
		and		a.dt_horario				< dt_horario_p
		and		a.dt_horario				> dt_horario_p - qt_interv_w / 24
		and		coalesce(a.ie_horario_especial,'N')	= 'N'
		and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_material,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
		and		c.nr_prescricao = b.nr_prescricao
		and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
		and		coalesce(c.ie_adep,'S') = 'S'
		and		coalesce(a.ie_dose_especial,'N') = 'N'
		and		coalesce(a.ie_situacao,'A') = 'A'
		and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
		and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
		and		c.dt_validade_prescr > dt_validade_w
		and		c.nr_atendimento = nr_atendimento_p
		and 	((coalesce(b.nr_seq_dieta_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
		
		if (qt_hor_int_w > 0) and (varie_permite_apraz_w <> 'S') then			
			--ds_consistencia_w := 'O horario informado nao esta de acordo com o intervalo previsto para este item, favor verificar.';
			ds_consistencia_w := wheb_mensagem_pck.get_texto(1112863, null);			
		end if;
		
		/* verificar horarios posteriores x intervalo */

		select	count(*)
		into STRICT	qt_hor_int_w
		from	prescr_material b,
				prescr_mat_hor a,
				prescr_medica c where	b.nr_prescricao			= a.nr_prescricao
		and		b.nr_sequencia			= a.nr_seq_material
		and		coalesce(cd_unidade_medida_p,'XPTO')	in ('XPTO', a.cd_unidade_medida_dose)
		and		coalesce(b.cd_intervalo,'XPTO')		= coalesce(cd_intervalo_p,'XPTO')		
		and		coalesce(b.qt_dose,1)		= coalesce(qt_item_p,coalesce(b.qt_dose,1))
		and		a.ie_agrupador			= 16
		and		a.cd_material				= cd_item_p
		and		a.dt_horario				> dt_horario_p
		and		a.dt_horario				< dt_horario_p + qt_interv_w / 24
		and		coalesce(a.ie_horario_especial,'N')	= 'N'
		and		obter_se_prescr_adep(a.nr_prescricao,a.nr_seq_material,nr_prescricao_p,nr_seq_item_p,nr_prescricoes_p) = 'S'
		and		c.nr_prescricao = b.nr_prescricao
		and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,c.cd_setor_atendimento,coalesce(c.ie_adep,'S')) = 'S'
		and		coalesce(a.ie_adep,'S') = 'S'
		and		coalesce(a.ie_dose_especial,'N') = 'N'
		and		coalesce(a.ie_situacao,'A') = 'A'
		and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
		and		(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
		and		c.dt_validade_prescr > dt_validade_w
		and		c.nr_atendimento = nr_atendimento_p
		and 	((coalesce(b.nr_seq_dieta_cpoe, 0) = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(nr_seq_cpoe_p::text, '') = '')) LIMIT 1;
		
		if (qt_hor_int_w > 0) and (varie_permite_apraz_w <> 'S') then
			--'O horario informado nao esta de acordo com o intervalo previsto para este item, favor verificar.#@#@');
			ds_consistencia_w := wheb_mensagem_pck.get_texto(1112863, null);			
		end if;		
	end if;
elsif (ie_tipo_item_p in ('HM')) then
	if (pkg_i18n.get_user_locale() = 'en_AU') then
		select (obter_etapa_atual_proc(a.nr_prescricao, a.nr_sequencia) + 1),
			b.qt_procedimento
		into STRICT	nr_etapa_apraz_hemo_w,
			qt_procedimento_hemo_w
		from 	prescr_procedimento a,
			cpoe_hemoterapia b
		where 	a.nr_seq_proc_cpoe = b.nr_sequencia
		and 	a.nr_sequencia 	= nr_seq_item_p
		and 	a.nr_prescricao = nr_prescricao_p;
		
		if (nr_etapa_apraz_hemo_w > qt_procedimento_hemo_w) then
			ds_consistencia_w := obter_desc_expressao(971587);
		end if;
	end if;	
end if;

ds_consistencia_p := ds_consistencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_aprazamento (cd_estabelecimento_p bigint, nr_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_item_p bigint, cd_item_p text, cd_intervalo_p text, qt_item_p bigint, ie_tipo_item_p text, ie_acm_sn_p text, nr_prescricoes_p text, dt_horario_p timestamp, qt_hora_prescricao_p bigint, ds_consistencia_p INOUT text, nm_usuario_p text, cd_unidade_medida_p text default null, ie_via_aplicacao_p text DEFAULT NULL, nr_seq_cpoe_p bigint default null) FROM PUBLIC;

