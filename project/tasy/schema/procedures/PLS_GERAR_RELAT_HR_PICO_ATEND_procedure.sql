-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_relat_hr_pico_atend ( dt_inicio_pesquisa_p timestamp, dt_fim_pesquisa_p timestamp, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


qt_horas_w			smallint	:= 0;
qt_horas_ww			varchar(3);
qt_atendimento_w		bigint;
ie_tipo_atend_w			varchar(2)	:= 'R';
ie_gestao_call_center_w		varchar(1);


BEGIN

delete	from w_call_center_relatorio
where	nm_usuario = nm_usuario_p;


select	coalesce(max(ie_gestao_call_center),'N')
into STRICT	ie_gestao_call_center_w
from	pls_controle_estab;

while(qt_horas_w	<= 23) loop
	begin

	if (length(qt_horas_w)	= 1) then
		qt_horas_ww	:= adiciona_zeros_esquerda(qt_horas_w,1);
	else
		qt_horas_ww	:= to_char(qt_horas_w);
	end if;

	if (ie_gestao_call_center_w = 'S') then
		select	count(1)
		into STRICT	qt_atendimento_w
		from	pls_atendimento
		where	ie_tipo_atendimento		= ie_tipo_atend_w
		and	trunc(dt_inicio)		between(dt_inicio_pesquisa_p) and (dt_fim_pesquisa_p)
		and	to_char(dt_inicio,'hh24')	= qt_horas_ww
		and	cd_estabelecimento = cd_estabelecimento_p;
	else
		select	count(1)
		into STRICT	qt_atendimento_w
		from	pls_atendimento
		where	ie_tipo_atendimento		= ie_tipo_atend_w
		and	trunc(dt_inicio)		between(dt_inicio_pesquisa_p) and (dt_fim_pesquisa_p)
		and	to_char(dt_inicio,'hh24')	= qt_horas_ww;
	end if;


	insert	into w_call_center_relatorio(nr_sequencia, qt_ocorrencia, hr_ocorrencia,
		 ie_tipo_atendimento, nm_usuario, dt_atualizacao)
	values (nextval('w_call_center_relatorio_seq'), qt_atendimento_w, qt_horas_w,
		 ie_tipo_atend_w, nm_usuario_p, clock_timestamp());

	qt_horas_w	:= qt_horas_w + 1;

	if (qt_horas_w	= 24) and (ie_tipo_atend_w	= 'R') then
		ie_tipo_atend_w	:= 'A';
		qt_horas_w	:= 0;
	end if;
	end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_relat_hr_pico_atend ( dt_inicio_pesquisa_p timestamp, dt_fim_pesquisa_p timestamp, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

