-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE same_desmembrar_prontuario ( nr_sequencia_p bigint, dt_inicio_pront_p timestamp, dt_fim_pront_p timestamp, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
cd_setor_same_w		integer;
cd_pessoa_fisica_w	varchar(10);
nr_seq_volume_w		integer;
ds_parametro_w		varchar(10) := obter_valor_param_usuario(941,103,obter_perfil_ativo,nm_usuario_p,cd_estabelecimento_p);


BEGIN 
 
if (nr_sequencia_p > 0) then 
 
	select 	max(cd_pessoa_fisica) 
	into STRICT	cd_pessoa_fisica_w 
	from	same_prontuario 
	where	nr_sequencia = nr_sequencia_p;
 
	select	coalesce(max(nr_seq_volume),0) + 1 
	into STRICT	nr_seq_volume_w 
	from	same_prontuario 
	where	cd_pessoa_fisica = cd_pessoa_fisica_w 
	and	((ds_parametro_w = 'N') or (cd_estabelecimento = cd_estabelecimento_p));
	 
	insert into same_prontuario(	nr_sequencia, 
					cd_estabelecimento, 
					ie_tipo, 
					dt_atualizacao, 
					nm_usuario, 
					ie_status, 
					cd_pessoa_fisica, 
					nr_atendimento, 
					nr_seq_agrup, 
					nr_seq_caixa, 
					nr_seq_local, 
					ds_observacao, 
					ie_digitalizado, 
					ie_microfilmado, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec, 
					cd_filme, 
					cd_fotograma, 
					cd_setor_atendimento, 
					dt_periodo_inicial, 
					dt_periodo_final, 
					nr_seq_volume, 
					ie_forma_geracao_pront, 
					cd_funcao) 
				SELECT	nextval('same_prontuario_seq'), 
					cd_estabelecimento, 
					ie_tipo, 
					clock_timestamp(), 
					nm_usuario_p, 
					ie_status, 
					cd_pessoa_fisica, 
					nr_atendimento, 
					nr_seq_agrup, 
					nr_seq_caixa, 
					nr_seq_local, 
					ds_observacao, 
					ie_digitalizado, 
					ie_microfilmado, 
					clock_timestamp(), 
					nm_usuario_p, 
					cd_filme, 
					cd_fotograma, 
					coalesce(Obter_Setor_AtePacu(Obter_Atepacu_paciente(nr_atendimento,'IA'),0),cd_setor_atendimento), 
					null, 
					null, 
					nr_seq_volume_w, 
					'A', 
					obter_funcao_ativa 
				from	same_prontuario 
				where	nr_sequencia = nr_sequencia_p;
				 
	SELECT 	MAX(cd_setor_atendimento) 
	INTO STRICT	cd_setor_same_w 
	FROM	setor_atendimento 
	WHERE	CD_CLASSIF_SETOR = '6';
 
	update 	same_prontuario 
	set	dt_periodo_inicial 	= coalesce(dt_inicio_pront_p,dt_periodo_inicial), 
		dt_periodo_final 	= dt_fim_pront_p, 
		cd_setor_atendimento	 = coalesce(cd_setor_same_w,cd_setor_atendimento) 
	where	nr_sequencia = nr_sequencia_p;
 
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE same_desmembrar_prontuario ( nr_sequencia_p bigint, dt_inicio_pront_p timestamp, dt_fim_pront_p timestamp, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

