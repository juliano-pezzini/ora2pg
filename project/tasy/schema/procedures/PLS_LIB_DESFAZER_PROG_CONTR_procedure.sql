-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_lib_desfazer_prog_contr ( nr_seq_prog_reajuste_p bigint, ie_opcao_p text, nm_usuario_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


/*
ie_opcao_p
L - Liberar
D - Desfazer
*/
nr_seq_tipo_reajuste_w		bigint;
dt_reajuste_w			timestamp;
dt_reajuste_atual_w		timestamp;

ie_negociacao_w			pls_tipo_reajuste.ie_negociacao%type	:= 'N';
ie_sem_reajuste_w		pls_tipo_reajuste.ie_sem_reajuste%type	:= 'N';
tx_reajuste_programado_w	pls_prog_reaj_coletivo.tx_reajuste_programado%type;

nr_seq_contrato_w		pls_contrato.nr_sequencia%type;
qt_aporte_w			bigint;

C01 CURSOR(	nr_seq_prog_reajuste_pc bigint) FOR
	SELECT	nr_titulo
	from	titulo_receber a,
		pls_prog_reaj_aporte_venc b,
		pls_prog_reaj_aporte c
	where	ie_situacao = '1'
	and	b.nr_sequencia = a.nr_seq_aporte_venc
	and	c.nr_sequencia = b.nr_seq_aporte
	and	c.nr_seq_programacao = nr_seq_prog_reajuste_pc;

BEGIN

if (ie_opcao_p	= 'L') then
	select	max(a.nr_seq_tipo_reajuste),
		max(b.dt_mes_reajuste),
		max(a.dt_reajuste),
		max(a.tx_reajuste_programado),
		max(a.nr_seq_contrato)
	into STRICT	nr_seq_tipo_reajuste_w,
		dt_reajuste_w,
		dt_reajuste_atual_w,
		tx_reajuste_programado_w,
		nr_seq_contrato_w
	from	pls_prog_reaj_coletivo a,
		pls_prog_reaj_colet_lote b
	where	a.nr_seq_lote	= b.nr_sequencia
	and	a.nr_sequencia	= nr_seq_prog_reajuste_p;

	if (coalesce(nr_seq_tipo_reajuste_w,0) <> 0) then
		select	max(ie_negociacao),
			max(ie_sem_reajuste)
		into STRICT	ie_negociacao_w,
			ie_sem_reajuste_w
		from	pls_tipo_reajuste
		where	nr_sequencia	= nr_seq_tipo_reajuste_w;
	end if;

	if (coalesce(ie_negociacao_w,'N') = 'N') and
		((coalesce(ie_sem_reajuste_w,'N') = 'S') or (coalesce(tx_reajuste_programado_w,0) <> 0)) then

		dt_reajuste_w	:= trunc(dt_reajuste_w,'month');

		if	((coalesce(dt_reajuste_atual_w::text, '') = '') and (dt_reajuste_w < trunc(clock_timestamp(),'month'))) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort( 195489, null);
			/* Deve ser informada a data do reajuste! */

		end if;

		CALL pls_programacao_reajuste_pck.gerar_aporte(nr_seq_prog_reajuste_p, dt_reajuste_w, nr_seq_contrato_w, nm_usuario_p, cd_estabelecimento_p);

		update	pls_prog_reaj_coletivo
		set	dt_liberacao		= clock_timestamp(),
			nm_usuario_liberacao	= nm_usuario_p,
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p,
			ie_status		= 'L',
			dt_reajuste		= coalesce(dt_reajuste_atual_w,dt_reajuste_w)
		where	nr_sequencia		= nr_seq_prog_reajuste_p;
	end if;
elsif (ie_opcao_p	= 'D') then
	select	count(1)
	into STRICT	qt_aporte_w
	from	pls_prog_reaj_aporte
	where	nr_seq_programacao = nr_seq_prog_reajuste_p;

	if (qt_aporte_w > 0) then
		delete from pls_segurado_mensalidade
		where	nr_seq_aporte in (	SELECT	nr_sequencia
						from	pls_prog_reaj_aporte
						where	nr_seq_programacao = nr_seq_prog_reajuste_p);

		for r_c01_w in c01(nr_seq_prog_reajuste_p) loop
			begin
			CALL cancelar_titulo_receber(r_c01_w.nr_titulo, nm_usuario_p, 'N', clock_timestamp());
			end;
		end loop;
	end if;

	update	pls_prog_reaj_coletivo
	set	dt_liberacao		 = NULL,
		nm_usuario_liberacao	 = NULL,
		dt_atualizacao		= clock_timestamp(),
		nm_usuario		= nm_usuario_p,
		ie_status		= 'N'
	where	nr_sequencia		= nr_seq_prog_reajuste_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_lib_desfazer_prog_contr ( nr_seq_prog_reajuste_p bigint, ie_opcao_p text, nm_usuario_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

