-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_aprovar_des_requisito ( nr_seq_requisito_p bigint, nm_usuario_p text ) AS $body$
DECLARE


qt_existe_w			integer;
nr_seq_classif_w 		bigint;
cd_gerente_cliente_w		varchar(10);
nm_gerente_cliente_w		varchar(60);
nm_usuario_gerente_w		varchar(15);
ie_permite_alterar_w		varchar(1) := 'S';
nr_seq_ordem_serv_proj_w	bigint;
qt_w				integer;
ie_val_documentacao_w		varchar(1);
ie_ccb_aprov_w			varchar(1);

c01 CURSOR FOR
SELECT	a.nr_seq_pr
from	des_requisito_item a
where	a.nr_seq_requisito = nr_seq_requisito_p;

BEGIN

select	max(ie_val_documentacao)
into STRICT	ie_val_documentacao_w
from	proj_classif
where	nr_sequencia = (	SELECT	nr_seq_classif
				from	proj_projeto a,
					des_requisito b
				where	a.nr_sequencia = b.nr_seq_projeto
				and	b.nr_sequencia = nr_seq_requisito_p
			);

if (ie_val_documentacao_w = 'S') then

	select	max(a.nr_seq_ordem_serv)
	into STRICT	nr_seq_ordem_serv_proj_w
	from	proj_projeto a,
		des_requisito b
	where	a.nr_sequencia = b.nr_seq_projeto
	and	b.nr_sequencia = nr_seq_requisito_p;

	if (coalesce(nr_seq_ordem_serv_proj_w::text, '') = '') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1022973, 'NR_SEQ_ORDEM_SERV=' || obter_desc_expressao(327119));
	end if;

	select	count(1)
	into STRICT	qt_w
	from	des_requisito a,
		des_requisito_item b
	where	a.nr_sequencia  = b.nr_seq_requisito
	and	a.nr_sequencia = nr_seq_requisito_p
	and	not exists (	SELECT	1
				from	man_ordem_serv_impacto c,
					man_ordem_serv_imp_pr d
				where	c.nr_seq_ordem_serv = nr_seq_ordem_serv_proj_w
				and	d.nr_seq_impacto = c.nr_sequencia
				and	b.nr_seq_pr = d.nr_product_requirement
				and	(c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> '')
			);

	if (qt_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1022973, 'NR_SEQ_ORDEM_SERV=' || nr_seq_ordem_serv_proj_w);
	end if;

	for r_c01 in c01 loop

		select	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
		into STRICT	ie_ccb_aprov_w
		from	man_ordem_serv_impacto c,
			man_ordem_serv_imp_pr d
		where	c.nr_sequencia = d.nr_seq_impacto
		and	d.nr_product_requirement = r_c01.nr_seq_pr
		and	c.nr_seq_ordem_serv = nr_seq_ordem_serv_proj_w
		and	(c.dt_aprovacao IS NOT NULL AND c.dt_aprovacao::text <> '');

		if (ie_ccb_aprov_w = 'N') then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1022973, 'NR_SEQ_ORDEM_SERV=' || nr_seq_ordem_serv_proj_w);
		end if;
	end loop;
end if;

select	count(*)
into STRICT	qt_existe_w
from	des_requisito
where	nr_sequencia = nr_seq_requisito_p
and	coalesce(dt_aprovacao::text, '') = '';

select	coalesce(p.nr_seq_classif,0),
	p.cd_gerente_cliente,
	substr(obter_nome_pessoa_fisica(p.cd_gerente_cliente, null), 1, 60) nm_gerente_cliente
into STRICT	nr_seq_classif_w,
	cd_gerente_cliente_w,
	nm_gerente_cliente_w
from	proj_projeto p
where 	p.nr_sequencia = (	SELECT 	max(a.nr_seq_projeto)
				from	des_requisito a
				where	a.nr_sequencia	= nr_seq_requisito_p
			);

if (nr_seq_classif_w = 45) then

	select	max(nm_usuario)
	into STRICT	nm_usuario_gerente_w
	from 	usuario
	where	cd_pessoa_fisica = cd_gerente_cliente_w;

	if (nm_usuario_gerente_w <> nm_usuario_p) then
		ie_permite_alterar_w := 'N';
		CALL wheb_mensagem_pck.exibir_mensagem_abort(452334, 'NM_GERENTE=' || nm_gerente_cliente_w);
	end if;
end if;

if (ie_permite_alterar_w = 'S') then

	if (qt_existe_w > 0) then
		update	des_requisito
		set	dt_aprovacao	= clock_timestamp(),
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p
		where	nr_sequencia	= nr_seq_requisito_p;
	else
		update	des_requisito
		set	dt_aprovacao	 = NULL,
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p
		where	nr_sequencia	= nr_seq_requisito_p;
	end if;

	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_aprovar_des_requisito ( nr_seq_requisito_p bigint, nm_usuario_p text ) FROM PUBLIC;

