-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE colunas AS (nm_coluna_w varchar(255));


CREATE OR REPLACE PROCEDURE gerar_w_painel_pa (cd_setor_atendimento_p bigint) AS $body$
DECLARE

 
/* vetor */
type vetor is table of colunas index by integer;

/* globais */
 
vetor_w					vetor;
nr_seq_grupo_pa_w			bigint;
i					integer;
nr_seq_apres_w				bigint;
cd_estabelecimento_w			bigint;

c01 CURSOR FOR 
	SELECT nr_sequencia 
	from	pa_grupo_local 
	where	ie_situacao = 'A' 
	and	cd_estabelecimento = cd_estabelecimento_w 
	order by 1;

c02 CURSOR FOR 
	SELECT 'SEQ=' || b.nr_sequencia || ';' || 
		'DESC=' || ds_abrev || ';' || 
 		'HINT=' || a.nr_atendimento || '-' || substr(obter_nome_pf(cd_pessoa_fisica),1,59) ||' - '||wheb_mensagem_pck.get_texto(802307)||': ' || to_char(obter_dt_entrada_setor(a.nr_atendimento),'dd/mm/yyyy hh24:mi:ss')||' - '||wheb_mensagem_pck.get_texto(796926)||': '||substr(obter_desc_status_pa(obter_status_pa_atendimento(a.nr_atendimento)),1,80)|| ';' || 
 		'STATUS=' || coalesce(b.ie_status,substr(obter_status_painel_pa(b.nr_sequencia, a.nr_atendimento),1,5))|| ';' || 
 		'INICOR=' || SUBSTR(Obter_Dados_Classif_Espec(a.NR_SEQ_CLASSIF_ESP,'C'),1,10)	||';'|| 
		'ATEND=' || a.nr_atendimento || ';' || 
		'INI=' || substr(obter_iniciais_nome(a.cd_pessoa_fisica,null),1,3) 
			nm_inicial, 
 
		coalesce(b.nr_seq_apres,999) nr_seq_apres 
	from	atendimento_paciente a, 
		pa_local b 
	where	coalesce(dt_alta::text, '') = '' 
	and	a.nr_seq_local_pa = b.nr_sequencia 
	and 	b.nr_seq_grupo_pa = nr_seq_grupo_pa_w 
	and	((cd_setor_atendimento_p = b.cd_setor_atendimento) or (cd_setor_atendimento_p = 0) or (coalesce(b.cd_setor_atendimento::text, '') = '')) 
	
union all
 
	SELECT 'SEQ=' || b.nr_sequencia || ';' || 
		'DESC=' || ds_abrev || ';' || 
 		'HINT=' || ds_abrev || ';' || 
 		'STATUS=' || coalesce(b.ie_status,substr(obter_status_painel_pa(b.nr_sequencia, null),1,5)) || ';' || 
 		'INICOR='|| null||';'|| 
		'ATEND=' || null || ';' || 
		'INI=' || null, 
 
		coalesce(b.nr_seq_apres,999) nr_seq_apres 
	from	pa_local b 
	where 	b.nr_seq_grupo_pa = nr_seq_grupo_pa_w 
	and	((cd_setor_atendimento_p = b.cd_setor_atendimento) or (cd_setor_atendimento_p = 0) or (coalesce(b.cd_setor_atendimento::text, '') = '')) 
	and not exists (select 1 
			from atendimento_paciente x 
			where x.nr_seq_local_pa = b.nr_sequencia 
			and coalesce(dt_alta::text, '') = '') 
	order by nr_seq_apres;


BEGIN 
 
 
cd_estabelecimento_w	:= wheb_usuario_pck.get_cd_estabelecimento;
 
CALL exec_sql_dinamico('','truncate table w_painel');
 
OPEN c01;
LOOP 
FETCH c01 INTO 
	nr_seq_grupo_pa_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
 
	for i in 1..40 loop 
		begin 
			vetor_w[i].nm_coluna_w := null;
		end;
	end loop;
 
	i := 1;
	OPEN c02;
	LOOP 
	FETCH c02 INTO 
		vetor_w[i].nm_coluna_w, 
		nr_seq_apres_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		i := i + 1;
	END LOOP;
	CLOSE c02;
 
	insert into w_painel( 
		CD_ITEM, 
		DS_ITEM1, 
		DS_ITEM2, 
		DS_ITEM3, 
		DS_ITEM4, 
		DS_ITEM5, 
		DS_ITEM6, 
		DS_ITEM7, 
		DS_ITEM8, 
		DS_ITEM9, 
		DS_ITEM10, 
		DS_ITEM11, 
		DS_ITEM12, 
		DS_ITEM13, 
		DS_ITEM14, 
		DS_ITEM15, 
		DS_ITEM16, 
		DS_ITEM17, 
		DS_ITEM18, 
		DS_ITEM19, 
		DS_ITEM20, 
		DS_ITEM21, 
		DS_ITEM22, 
		DS_ITEM23, 
		DS_ITEM24, 
		DS_ITEM25, 
		DS_ITEM26, 
		DS_ITEM27, 
		DS_ITEM28, 
		DS_ITEM29, 
		DS_ITEM30, 
		DS_ITEM31, 
		DS_ITEM32, 
		DS_ITEM33, 
		DS_ITEM34, 
		DS_ITEM35, 
		DS_ITEM36, 
		DS_ITEM37, 
		DS_ITEM38, 
		DS_ITEM39, 
		DS_ITEM40 
	) values ( 
		nr_seq_grupo_pa_w, 
		vetor_w[1].nm_coluna_w, 
		vetor_w[2].nm_coluna_w, 
		vetor_w[3].nm_coluna_w, 
		vetor_w[4].nm_coluna_w, 
		vetor_w[5].nm_coluna_w, 
		vetor_w[6].nm_coluna_w, 
		vetor_w[7].nm_coluna_w, 
		vetor_w[8].nm_coluna_w, 
		vetor_w[9].nm_coluna_w, 
		vetor_w[10].nm_coluna_w, 
		vetor_w[11].nm_coluna_w, 
		vetor_w[12].nm_coluna_w, 
		vetor_w[13].nm_coluna_w, 
		vetor_w[14].nm_coluna_w, 
		vetor_w[15].nm_coluna_w, 
		vetor_w[16].nm_coluna_w, 
		vetor_w[17].nm_coluna_w, 
		vetor_w[18].nm_coluna_w, 
		vetor_w[19].nm_coluna_w, 
		vetor_w[20].nm_coluna_w, 
		vetor_w[21].nm_coluna_w, 
		vetor_w[22].nm_coluna_w, 
		vetor_w[23].nm_coluna_w, 
		vetor_w[24].nm_coluna_w, 
		vetor_w[25].nm_coluna_w, 
		vetor_w[26].nm_coluna_w, 
		vetor_w[27].nm_coluna_w, 
		vetor_w[28].nm_coluna_w, 
		vetor_w[29].nm_coluna_w, 
		vetor_w[30].nm_coluna_w, 
		vetor_w[31].nm_coluna_w, 
		vetor_w[32].nm_coluna_w, 
		vetor_w[33].nm_coluna_w, 
		vetor_w[34].nm_coluna_w, 
		vetor_w[35].nm_coluna_w, 
		vetor_w[36].nm_coluna_w, 
		vetor_w[37].nm_coluna_w, 
		vetor_w[38].nm_coluna_w, 
		vetor_w[39].nm_coluna_w, 
		vetor_w[40].nm_coluna_w 
		);
 
 
 
END LOOP;
CLOSE c01;
 
delete	from w_painel 
where coalesce(DS_ITEM1::text, '') = '' 
and coalesce(DS_ITEM2::text, '') = '' 
and coalesce(DS_ITEM3::text, '') = '' 
and coalesce(DS_ITEM4::text, '') = '' 
and coalesce(DS_ITEM5::text, '') = '' 
and coalesce(DS_ITEM6::text, '') = '' 
and coalesce(DS_ITEM7::text, '') = '' 
and coalesce(DS_ITEM8::text, '') = '' 
and coalesce(DS_ITEM9::text, '') = '' 
and coalesce(DS_ITEM10::text, '') = '' 
and coalesce(DS_ITEM11::text, '') = '' 
and coalesce(DS_ITEM12::text, '') = '' 
and coalesce(DS_ITEM13::text, '') = '' 
and coalesce(DS_ITEM14::text, '') = '' 
and coalesce(DS_ITEM15::text, '') = '' 
and coalesce(DS_ITEM16::text, '') = '' 
and coalesce(DS_ITEM17::text, '') = '' 
and coalesce(DS_ITEM18::text, '') = '' 
and coalesce(DS_ITEM19::text, '') = '' 
and coalesce(DS_ITEM20::text, '') = '' 
and coalesce(DS_ITEM21::text, '') = '' 
and coalesce(DS_ITEM22::text, '') = '' 
and coalesce(DS_ITEM23::text, '') = '' 
and coalesce(DS_ITEM24::text, '') = '' 
and coalesce(DS_ITEM25::text, '') = '' 
and coalesce(DS_ITEM26::text, '') = '' 
and coalesce(DS_ITEM27::text, '') = '' 
and coalesce(DS_ITEM28::text, '') = '' 
and coalesce(DS_ITEM29::text, '') = '' 
and coalesce(DS_ITEM30::text, '') = '' 
and coalesce(DS_ITEM31::text, '') = '' 
and coalesce(DS_ITEM32::text, '') = '' 
and coalesce(DS_ITEM33::text, '') = '' 
and coalesce(DS_ITEM34::text, '') = '' 
and coalesce(DS_ITEM35::text, '') = '' 
and coalesce(DS_ITEM36::text, '') = '' 
and coalesce(DS_ITEM37::text, '') = '' 
and coalesce(DS_ITEM38::text, '') = '' 
and coalesce(DS_ITEM39::text, '') = '' 
and coalesce(DS_ITEM40::text, '') = '';
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_painel_pa (cd_setor_atendimento_p bigint) FROM PUBLIC;

