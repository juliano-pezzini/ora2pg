-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_nfse_tubarao ( dt_inicio_p timestamp, dt_fim_p timestamp, nr_nota_fiscal_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_nfse_w			varchar(15);
ie_status_nfse_w		varchar(1);
dt_emissao_nfse_w		varchar(19);
dt_prestacao_servico_w		varchar(6);
nr_nfse_substituta_w		varchar(15);
cd_tributacao_rps_w		varchar(2);
nr_rps_w			varchar(15);
nr_serie_rps_w			varchar(5);
ie_tipo_rps_w			varchar(1);
dt_emissao_rps_w		varchar(10);
ie_situacao_rps_w		smallint;
nr_rps_substituido_w		varchar(15);
nr_serie_rps_substituido_w	varchar(5);
vl_servico_rps_w		varchar(16);
nr_cnae_w			varchar(7);
cd_atividade_w			varchar(15);
vl_base_calculo_w		varchar(16);
vl_aliquota_iss_w		varchar(16);
vl_iss_w			varchar(16);
ie_retem_iss_w			smallint;
ds_servico_w			varchar(2000);
cd_municipio_w			varchar(15);
qt_servicos_w			varchar(15);
vl_unitario_servico_w		varchar(16);
cd_cmc_w			varchar(15);
nm_razao_social_w		varchar(115);
nm_fantasia_w			varchar(60);
cd_cgc_emitente_w		varchar(14);
ds_logra_ende_prest_w		varchar(125);
nr_ende_prest_w			varchar(10);
ds_complemento_prest_w		varchar(60);
ds_bairro_prest_w		varchar(60);
cd_municipio_prest_w		varchar(15);
sg_uf_prest_w			varchar(2);
nr_cep_prest_w			varchar(8);
ds_email_prest_w		varchar(80);
ds_telefone_prest_w		varchar(11);
cd_cpf_cgc_tomador_w		varchar(14);
ie_tipo_tomador_w		varchar(2);
nm_tomador_w			varchar(115);
ds_logra_ende_toma_w		varchar(125);
nr_endereco_tomador_w		varchar(10);
ds_complemento_tomador_w	varchar(60);
ds_bairro_tomador_w		varchar(60);
cd_municipio_tomador_w		varchar(15);
ds_uf_tomador_w			varchar(2);
nr_cep_tomador_w		varchar(8);
ds_email_tomador_w		varchar(80);
ds_telefone_toma_w		varchar(11);
dt_cancelamento_nfe_w		varchar(10);
ie_status_sincronizacao_w	varchar(1);
vl_deducoes_w			varchar(16);
vl_pis_w			varchar(16);
vl_cofins_w			varchar(16);
vl_inss_w			varchar(16);
vl_ir_w				varchar(16);
vl_csll_w			varchar(16);
cd_estabelecimento_w		smallint;
ds_arquivo_ww			varchar(4000);
qt_notas_w			bigint;
ie_somente_nota_calculada_w	varchar(1);
c01 CURSOR FOR
SELECT	lpad('0',15,'0'),
	CASE WHEN n.ie_situacao=1 THEN 1  ELSE 2 END ,
	lpad(' ',19,' '),
	lpad(to_char(n.dt_emissao,'yyyymm'),6,' ')															dt_prestacao_servico,
	lpad('0',15,'0'),
	lpad(coalesce(substr(nfse_obter_regra('TP',n.cd_estabelecimento),1,2),'0'),2,'0'),
	lpad(n.nr_nota_fiscal,15,'0'),
	lpad(n.cd_serie_nf,5,'0'),
	'1',
	lpad(to_char(n.dt_emissao,'dd/mm/yyyy'),10,' '),
	CASE WHEN n.ie_situacao=1 THEN 1  ELSE 2 END ,
	lpad('0',15,'0'),
	lpad('0',5,'0'),
	lpad(replace(replace(replace(to_char(n.vl_mercadoria - n.vl_descontos, '999,999,999,990.99'), ',', ''),'.', ','),' ',''),16,'0'),
	rpad(coalesce(pls_obter_cd_cnae(obter_dados_pf_pj(null, n.cd_cgc_emitente,'CNAE')),' '),7,' '),
	lpad(coalesce(obter_dados_pf_pj_estab(n.cd_estabelecimento, null, cd_cgc_emitente, 'ATIV'),'0'),15,'0'),
	lpad(replace(replace(replace(to_char(n.vl_mercadoria - n.vl_descontos, '999,999,999,990.99'), ',', ''),'.', ','),' ',''),16,'0'),
	lpad(replace(replace(replace(to_char(CASE WHEN obter_valor_tipo_tributo_nota(nr_sequencia, 'X', 'ISS')=0 THEN  3  ELSE obter_valor_tipo_tributo_nota(nr_sequencia, 'X', 'ISS') END , '999,999,999,990.99'), ',', ''),'.', ','),' ',''),16,'0'),
	lpad(replace(replace(replace(to_char(coalesce(obter_valor_tipo_tributo_nota(nr_sequencia, 'V', 'ISS'), 0), '999,999,999,990.99'), ',', ''),'.', ','),' ',''),16,'0'),
	lpad(CASE WHEN obter_se_nf_retem_iss(n.nr_sequencia)='S' THEN 1  ELSE 2 END ,1,'0'),
	rpad(replace(replace(coalesce(substr(obter_desc_nfse_tubarao(n.nr_sequencia),1,2000),'Servicos'),chr(13),' '),chr(10),' '), 2000 ,' '),
	lpad(coalesce(obter_tom_municipio_ibge(obter_dados_pf_pj(null,n.cd_cgc_emitente,'CDM')),'0'),15,'0'),
	lpad(coalesce((SELECT lpad(count(*),15,0) from nota_fiscal_item i where i.nr_sequencia = n.nr_sequencia),'0'),15,'0'),
	lpad(coalesce((select lpad(replace(replace(replace(to_char(coalesce(sum(i.vl_unitario_item_nf),0), '999,999,999,990.99'), ',', ''),'.', ','),' ',''),16,0) from nota_fiscal_item i where i.nr_sequencia = n.nr_sequencia),'0'),16,'0'),
	lpad(coalesce(obter_dados_pf_pj(null,n.cd_cgc_emitente,'IM'),'51535'),15,'0'),	
	rpad(coalesce(obter_dados_pf_pj(null,n.cd_cgc_emitente,'N'),' '),115,' '),
	rpad(coalesce(obter_dados_pf_pj(null,n.cd_cgc_emitente,'F'),' '),60,' '),
	lpad(coalesce(n.cd_cgc_emitente,'0'),14,'0'),
	rpad(coalesce(obter_dados_pf_pj(null,n.cd_cgc_emitente,'LO')||obter_dados_pf_pj(null,cd_cgc_emitente,'R'),' '),125,' '),
	rpad(coalesce(obter_dados_pf_pj(null,n.cd_cgc_emitente,'NR'),' '),10,' '),
	rpad(coalesce(obter_dados_pf_pj(null,n.cd_cgc_emitente,'CO'),' '),60,' '),
	rpad(coalesce(obter_dados_pf_pj(null,n.cd_cgc_emitente,'B'),' '),60,' '),
	lpad(coalesce(obter_tom_municipio_ibge(obter_dados_pf_pj(null,n.cd_cgc_emitente,'CDM')),'0'),15,'0'),
	rpad(coalesce(obter_dados_pf_pj(null,n.cd_cgc_emitente,'UF'),' '),2,' '),
	lpad(coalesce(elimina_caracteres_especiais(obter_dados_pf_pj(null,n.cd_cgc_emitente,'CEP')),'0'),8,'0'),
	rpad(coalesce(obter_dados_pf_pj_estab(n.cd_estabelecimento,null,n.cd_cgc_emitente,'M'),' '),80,' '),
	lpad(coalesce((rpad(obter_dados_pf_pj(null,n.cd_cgc_emitente,'DDT'),2,' ')||rpad(elimina_caracteres_especiais(obter_dados_pf_pj(null,n.cd_cgc_emitente,'T')),8,' ')),' '),11,' '),
	lpad(coalesce((CASE WHEN coalesce(n.cd_cgc::text, '') = '' THEN obter_cpf_pessoa_fisica(n.cd_pessoa_fisica)  ELSE n.cd_cgc END ),0),14,'0'),
	lpad(coalesce(CASE WHEN coalesce(n.cd_cgc::text, '') = '' THEN (CASE WHEN coalesce(obter_cpf_pessoa_fisica(n.cd_pessoa_fisica)::text, '') = '' THEN 3  ELSE 1 END )  ELSE 2 END ,'0'),2,'0'),
	rpad(coalesce(substr(initcap(CASE WHEN coalesce(n.cd_cgc::text, '') = '' THEN obter_nome_pessoa_fisica(n.cd_pessoa_fisica,null)  ELSE obter_dados_pf_pj(null,n.cd_cgc,'N') END ),1,115),' '),115,' '),
	rpad(coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'LO')||obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'R'),' '),125,' '),
	rpad(coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'NR'),' '),10,' '),
	rpad(coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'CO'),' '),60,' '),
	rpad(coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'B'),' '),60,' '),
	lpad(coalesce(obter_tom_municipio_ibge(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'CDM')),'0'),15,'0'),
	rpad(coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'UF'),' '),2,' '),
	lpad(coalesce(elimina_caracteres_especiais(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'CEP')),'0'),8,'0'),
	rpad(coalesce(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc,'M'),' '),80,' '),
	lpad(coalesce((rpad(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc_emitente,'DDT'),2,' ')||rpad(elimina_caracteres_especiais(obter_dados_pf_pj(n.cd_pessoa_fisica,n.cd_cgc_emitente,'T')),8,' ')),' '),11,' '),
	lpad(coalesce(to_char(n.dt_cancelamento_nfe,'dd/mm/yyyy'),' '),10,' '),
	1,
	lpad(replace(replace(replace(to_char('0', '999,999,999,990.99'), ',', ''),'.', ','),' ',''),16,'0'),
	lpad(replace(replace(replace(to_char(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'PIS'), '999,999,999,990.99'), ',', ''),'.', ','),' ',''),16,0),
	lpad(replace(replace(replace(to_char(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'COFINS'), '999,999,999,990.99'), ',', ''),'.', ','),' ',''),16,0),
	lpad(replace(replace(replace(to_char(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'INSS'), '999,999,999,990.99'), ',', ''),'.', ','),' ',''),16,0),
	lpad(replace(replace(replace(to_char(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'IR'), '999,999,999,990.99'), ',', ''),'.', ','),' ',''),16,0),
	lpad(replace(replace(replace(to_char(obter_valor_tipo_tributo_nota(n.nr_sequencia, 'V', 'CSLL'), '999,999,999,990.99'), ',', ''),'.', ','),' ',''),16,0),
	n.cd_estabelecimento
from	nota_fiscal n,
	operacao_nota o
where	o.cd_operacao_nf = n.cd_operacao_nf
and	o.ie_servico = 'S'
and	Obter_Se_Nota_Entrada_Saida(n.nr_sequencia) = 'S'
and 	n.ie_situacao in (1,8)
and	n.cd_estabelecimento = cd_estabelecimento_p
and	n.dt_emissao between dt_inicio_p and fim_dia(dt_fim_p)
and	((n.nr_nota_fiscal = nr_nota_fiscal_p) or (nr_nota_fiscal_p = '0'))
and	((ie_somente_nota_calculada_w = 'N') or (ie_somente_nota_calculada_w = 'S' and (n.dt_atualizacao_estoque IS NOT NULL AND n.dt_atualizacao_estoque::text <> '')))
and	coalesce(n.nr_nfe_imp::text, '') = '';


BEGIN

select	count(*)
into STRICT	qt_notas_w
from	nota_fiscal n,
	operacao_nota o
where	o.cd_operacao_nf = n.cd_operacao_nf
and	o.ie_servico = 'S'
and	Obter_Se_Nota_Entrada_Saida(n.nr_sequencia) = 'S'
and 	n.ie_situacao in (1,8)
and	n.cd_estabelecimento = cd_estabelecimento_p
and	n.dt_emissao between dt_inicio_p and fim_dia(dt_fim_p)
and	((n.nr_nota_fiscal = nr_nota_fiscal_p) or (nr_nota_fiscal_p = '0'))
and	coalesce(n.nr_nfe_imp::text, '') = '';

if (qt_notas_w = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(192018);
end if;

delete from w_inss_direp_arquivo;
commit;
ie_somente_nota_calculada_w := substr(coalesce(obter_valor_param_usuario(40, 124, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p),'N'),1,1);

open c01;
loop
fetch c01 into
	nr_nfse_w,
	ie_status_nfse_w,
	dt_emissao_nfse_w,
	dt_prestacao_servico_w,
	nr_nfse_substituta_w,
	cd_tributacao_rps_w,
	nr_rps_w,
	nr_serie_rps_w,
	ie_tipo_rps_w,
	dt_emissao_rps_w,
	ie_situacao_rps_w,
	nr_rps_substituido_w,
	nr_serie_rps_substituido_w,
	vl_servico_rps_w,
	nr_cnae_w,
	cd_atividade_w,
	vl_base_calculo_w,
	vl_aliquota_iss_w,
	vl_iss_w,
	ie_retem_iss_w,
	ds_servico_w,
	cd_municipio_w,
	qt_servicos_w,
	vl_unitario_servico_w,
	cd_cmc_w,
	nm_razao_social_w,
	nm_fantasia_w,
	cd_cgc_emitente_w,
	ds_logra_ende_prest_w,
	nr_ende_prest_w,
	ds_complemento_prest_w,
	ds_bairro_prest_w,
	cd_municipio_prest_w,
	sg_uf_prest_w,
	nr_cep_prest_w,
	ds_email_prest_w,
	ds_telefone_prest_w,
	cd_cpf_cgc_tomador_w,
	ie_tipo_tomador_w,
	nm_tomador_w,
	ds_logra_ende_toma_w,
	nr_endereco_tomador_w,
	ds_complemento_tomador_w,
	ds_bairro_tomador_w,
	cd_municipio_tomador_w,
	ds_uf_tomador_w,
	nr_cep_tomador_w,
	ds_email_tomador_w,
	ds_telefone_toma_w,
	dt_cancelamento_nfe_w,
	ie_status_sincronizacao_w,
	vl_deducoes_w,
	vl_pis_w,
	vl_cofins_w,
	vl_inss_w,
	vl_ir_w,
	vl_csll_w,
	cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

		begin

		ds_arquivo_ww	:=	nr_nfse_w			||ie_status_nfse_w		||
					dt_emissao_nfse_w		||dt_prestacao_servico_w	||
					nr_nfse_substituta_w		||cd_tributacao_rps_w		||
					nr_rps_w			||nr_serie_rps_w		||
					ie_tipo_rps_w			||dt_emissao_rps_w		||
					ie_situacao_rps_w		||nr_rps_substituido_w		||
					nr_serie_rps_substituido_w	||vl_servico_rps_w		||
					nr_cnae_w			||cd_atividade_w		||
					vl_base_calculo_w		||vl_aliquota_iss_w		||
					vl_iss_w			||ie_retem_iss_w		||
					ds_servico_w			||cd_municipio_w		||
					qt_servicos_w			||vl_unitario_servico_w		||
					cd_cmc_w			||nm_razao_social_w		||
					nm_fantasia_w			||cd_cgc_emitente_w		||
					ds_logra_ende_prest_w		||nr_ende_prest_w		||
					ds_complemento_prest_w		||ds_bairro_prest_w		||
					cd_municipio_prest_w		||sg_uf_prest_w			||
					nr_cep_prest_w			||ds_email_prest_w		||
					ds_telefone_prest_w		||cd_cpf_cgc_tomador_w		||
					ie_tipo_tomador_w		||nm_tomador_w			||
					ds_logra_ende_toma_w		||nr_endereco_tomador_w		||
					ds_complemento_tomador_w	||ds_bairro_tomador_w		||
					cd_municipio_tomador_w		||ds_uf_tomador_w		||
					nr_cep_tomador_w		||ds_email_tomador_w		||
					ds_telefone_toma_w		||dt_cancelamento_nfe_w		||
					ie_status_sincronizacao_w	||vl_deducoes_w			||
					vl_pis_w			||vl_cofins_w			||
					vl_inss_w			||vl_ir_w			||
					vl_csll_w;

insert into w_inss_direp_arquivo(nr_sequencia,
				 cd_estabelecimento,
				 dt_atualizacao,
				 nm_usuario,
				 dt_atualizacao_nrec,
				 nm_usuario_nrec,
				 ds_arquivo_w)
			values (nextval('w_inss_direp_arquivo_seq'),
				 cd_estabelecimento_w,
				 clock_timestamp(),
				 nm_usuario_p,
				 clock_timestamp(),
				 nm_usuario_p,
				 ds_arquivo_ww );

	end;

end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_nfse_tubarao ( dt_inicio_p timestamp, dt_fim_p timestamp, nr_nota_fiscal_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

