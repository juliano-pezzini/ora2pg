-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE importacao_nf_simpliss ( cd_estabelecimento_p bigint, ds_conteudo_p text) AS $body$
DECLARE


				
nr_nota_fiscal_w	nota_fiscal.nr_nota_fiscal%type;
cd_serie_nf_w		nota_fiscal.cd_serie_nf%type;
cd_cgc_emitente_w	nota_fiscal.cd_cgc_emitente%type;
dt_emissao_w		varchar(255);
nr_nfe_imp_w		nota_fiscal.nr_nfe_imp%type;

ds_tipo_reg_w		varchar(255);
dt_emissao_string_w	varchar(10);


BEGIN


select	obter_valor_separador(ds_conteudo_p,1,'|')
into STRICT	ds_tipo_reg_w
;

if (coalesce(ds_tipo_reg_w,'0') = '1') then
	begin
	
	begin
		select	OBTER_VALOR_SEPARADOR(ds_conteudo_p,76,'|')
		into STRICT	nr_nota_fiscal_w
		;
	exception
	when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort('Erro campo Numero da nota fiscal');
	end;
	
	begin
		select	OBTER_VALOR_SEPARADOR(ds_conteudo_p,3,'|')
		into STRICT	cd_serie_nf_w
		;
	exception
	when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort('Erro campo Série da nota fiscal');
	end;
	
	begin
		select	OBTER_VALOR_SEPARADOR(ds_conteudo_p,4,'|')
		into STRICT	cd_cgc_emitente_w
		;
	exception
	when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort('Erro campo Cfg do emitente da nota fiscal');
	end;
	
	begin
		select	OBTER_VALOR_SEPARADOR(ds_conteudo_p,16,'|')
		into STRICT	dt_emissao_string_w
		;
		
		select	to_char(to_date(dt_emissao_string_w,'yyyy-mm-dd'), 'dd/mm/yyyy')
		into STRICT	dt_emissao_w
		;
		
		
	exception
	when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort('Erro campo data de emissão da nota fiscal');
	end;
	
	begin
		select	OBTER_VALOR_SEPARADOR(ds_conteudo_p,2,'|')
		into STRICT	nr_nfe_imp_w
		;
	exception
	when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort('Erro campo numero de importação da nota fiscal');
	end;

	end;
end if;





CALL recebe_nota_rps_nfe_trat(	cd_estabelecimento_p,
				nr_nota_fiscal_w,
				null,
				cd_cgc_emitente_w,
				dt_emissao_w,
				nr_nfe_imp_w,
				'',
				'',
				'',
				3054);	

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importacao_nf_simpliss ( cd_estabelecimento_p bigint, ds_conteudo_p text) FROM PUBLIC;

