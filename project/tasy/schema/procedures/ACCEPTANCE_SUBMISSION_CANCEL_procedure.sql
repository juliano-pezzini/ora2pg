-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE acceptance_submission_cancel ( nr_seq_lote_p bigint, dt_review_accepted_p timestamp, dt_review_cancelled_p timestamp, ie_status_review_p text, nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE

  nr_seq_lote_rev_w       bigint;
  nr_seq_ap_lote_review_w ap_lote_review.nr_sequencia%TYPE;

BEGIN
    SELECT nextval('ap_lote_review_seq')
    INTO STRICT   nr_seq_ap_lote_review_w
;

    SELECT Max(nr_seq_lote)
    INTO STRICT   nr_seq_lote_rev_w
    FROM   ap_lote_review
    WHERE  nr_seq_lote = nr_seq_lote_p;

    IF ( coalesce(nr_seq_lote_rev_w::text, '') = '' )THEN
      INSERT INTO ap_lote_review(nr_sequencia,
                   nr_seq_lote,
                   dt_atualizacao,
                   nm_usuario,
                   dt_atualizacao_nrec,
                   nm_usuario_nrec,
                   nr_prescricao,
                   ie_status_review,
                   dt_review_accepted,
                   dt_review_cancelled)
      VALUES ( nr_seq_ap_lote_review_w,
                   nr_seq_lote_p,
                   clock_timestamp(),
                   nm_usuario_p,
                   clock_timestamp(),
                   nm_usuario_p,
                   nr_prescricao_p,
                   ie_status_review_p,
                   dt_review_accepted_p,
                   dt_review_cancelled_p );
    ELSIF (nr_seq_lote_rev_w IS NOT NULL AND nr_seq_lote_rev_w::text <> '' AND dt_review_accepted_p IS NOT NULL AND dt_review_accepted_p::text <> '') THEN
            UPDATE ap_lote_review
            SET    dt_review_accepted = dt_review_accepted_p,
                   ie_status_review = ie_status_review_p
            WHERE  nr_seq_lote = nr_seq_lote_p;
    ELSIF (nr_seq_lote_rev_w IS NOT NULL AND nr_seq_lote_rev_w::text <> '' AND dt_review_cancelled_p IS NOT NULL AND dt_review_cancelled_p::text <> '') THEN
          UPDATE ap_lote_review
          SET    dt_review_cancelled = dt_review_cancelled_p,
                 ie_status_review = ie_status_review_p
          WHERE  nr_seq_lote = nr_seq_lote_p;
    END IF;
    COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE acceptance_submission_cancel ( nr_seq_lote_p bigint, dt_review_accepted_p timestamp, dt_review_cancelled_p timestamp, ie_status_review_p text, nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

