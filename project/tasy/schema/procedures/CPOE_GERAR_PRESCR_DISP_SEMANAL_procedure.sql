-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_prescr_disp_semanal ( cd_setor_atendimento_p cpoe_week_dispens_rule.cd_setor_atendimento%type, ie_via_aplicacao_p cpoe_week_dispens_rule.ie_via_aplicacao%type, dt_reference_p timestamp, nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type, itens_liberar_p text, ie_inconsistencia_out_p INOUT text, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type default null, ie_copia_diaria_p char default 'N', ie_interv_farmacia_p text default 'N', ie_motivo_prescr_p text default null, ie_liberacao_ang_p text default 'N', nr_prescricao_out_p INOUT bigint DEFAULT NULL, nr_prescricao_lib_p bigint default null, nr_seq_consulta_oft_p bigint default null, nr_seq_pend_pac_acao_p bigint default null, ie_copia_sem_lib_enf_farm_p text default 'N', ie_adep_p text default 'S', nm_usuario_validacao_p text default null, ds_prescricoes_geradas_out_p INOUT text DEFAULT NULL, nm_usuario_lib_enf_p cpoe_material.nm_usuario_lib_enf%type default null, cd_farmac_lib_p cpoe_material.cd_farmac_lib%type default null) AS $body$
DECLARE

	
nr_seq_rule_w		cpoe_week_dispens_rule.nr_sequencia%type;
hr_disp_time_w		cpoe_week_dispens_rule.hr_dispensation_time%type;
si_disp_day_w		cpoe_week_dispens_rule.si_dispensation_day%type;
dt_dispensation_w	timestamp;
qt_dias_w			integer;
dt_prescr_w			timestamp;


BEGIN

	SELECT * FROM cpoe_regra_disp_semanal(cd_setor_atendimento_p, ie_via_aplicacao_p, nr_seq_rule_w, hr_disp_time_w, si_disp_day_w) INTO STRICT nr_seq_rule_w, hr_disp_time_w, si_disp_day_w;
	dt_dispensation_w := cpoe_prox_dt_disp_semanal(dt_reference_p, si_disp_day_w, hr_disp_time_w);
	
	if (dt_dispensation_w IS NOT NULL AND dt_dispensation_w::text <> '') then
	
		qt_dias_w := pkg_date_utils.get_DiffDate(dt_reference_p, dt_dispensation_w,'DAY');
		
		dt_prescr_w := dt_dispensation_w - qt_dias_w;		
		
		while(dt_prescr_w < dt_dispensation_w)
		loop

		SELECT * FROM CPOE_GERAR_PRESCRICAO(nr_atendimento_p, dt_reference_p, cd_estabelecimento_p, cd_perfil_p, cd_setor_atendimento_p, nm_usuario_p, itens_liberar_p, cd_pessoa_fisica_p, ie_copia_diaria_p, ie_interv_farmacia_P, ie_motivo_prescr_p, ie_liberacao_ang_p, nr_prescricao_lib_p, nr_seq_consulta_oft_p, nr_seq_pend_pac_acao_p, 'N', ie_adep_p, nm_usuario_validacao_p, nm_usuario_lib_enf_p, cd_farmac_lib_p) INTO STRICT ie_inconsistencia_out_p, nr_prescricao_out_p, ds_prescricoes_geradas_out_p;		
		
		dt_prescr_w := dt_prescr_w +1;
	
		end loop;
	
	end if;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_prescr_disp_semanal ( cd_setor_atendimento_p cpoe_week_dispens_rule.cd_setor_atendimento%type, ie_via_aplicacao_p cpoe_week_dispens_rule.ie_via_aplicacao%type, dt_reference_p timestamp, nr_atendimento_p atendimento_paciente.nr_atendimento%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type, itens_liberar_p text, ie_inconsistencia_out_p INOUT text, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type default null, ie_copia_diaria_p char default 'N', ie_interv_farmacia_p text default 'N', ie_motivo_prescr_p text default null, ie_liberacao_ang_p text default 'N', nr_prescricao_out_p INOUT bigint DEFAULT NULL, nr_prescricao_lib_p bigint default null, nr_seq_consulta_oft_p bigint default null, nr_seq_pend_pac_acao_p bigint default null, ie_copia_sem_lib_enf_farm_p text default 'N', ie_adep_p text default 'S', nm_usuario_validacao_p text default null, ds_prescricoes_geradas_out_p INOUT text DEFAULT NULL, nm_usuario_lib_enf_p cpoe_material.nm_usuario_lib_enf%type default null, cd_farmac_lib_p cpoe_material.cd_farmac_lib%type default null) FROM PUBLIC;

