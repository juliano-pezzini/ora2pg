-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_imagem_captura ( nm_usuario_p text, nr_prescricao_p bigint, nr_sequencia_prescricao_p text, ds_caminho_p text, nr_sequencia_p bigint, nr_sequencia_out INOUT bigint) AS $body$
DECLARE



ds_lista_w                varchar(2000);
qt_existe_virgula_w       bigint;
tam_lista_w               bigint;
ie_pos_virgula_w		  smallint;
nr_sequencia_prescricao_w bigint;
nr_next_sequencia         bigint;

nr_seq_log_atual_w bigint;
ie_log_w           varchar(10);


BEGIN
  IF (coalesce(nr_sequencia_p::text, '') = '') THEN
    SELECT nextval('captura_imagem_seq')
    INTO STRICT   nr_sequencia_out
;
  ELSE
    nr_sequencia_out := nr_sequencia_p;
  END IF;

  SELECT * FROM gravar_log_alteracao(NULL, nr_sequencia_out, nm_usuario_p, nr_seq_log_atual_w, 'NR_SEQUENCIA', ie_log_w, NULL, 'CAPTURA_IMAGEM', nr_sequencia_out, NULL) INTO STRICT nr_seq_log_atual_w, ie_log_w;
  SELECT * FROM gravar_log_alteracao(NULL, nm_usuario_p, nm_usuario_p, nr_seq_log_atual_w, 'NM_USUARIO', ie_log_w, NULL, 'CAPTURA_IMAGEM', nr_sequencia_out, NULL) INTO STRICT nr_seq_log_atual_w, ie_log_w;
  SELECT * FROM gravar_log_alteracao(NULL, ds_caminho_p, nm_usuario_p, nr_seq_log_atual_w, 'DS_CAMINHO', ie_log_w, NULL, 'CAPTURA_IMAGEM', nr_sequencia_out, NULL) INTO STRICT nr_seq_log_atual_w, ie_log_w;
  ie_log_w := NULL;

  INSERT INTO captura_imagem(nr_sequencia, dt_atualizacao, nm_usuario, ds_caminho)
  VALUES (nr_sequencia_out, clock_timestamp(), nm_usuario_p, ds_caminho_p);

  ds_lista_w := nr_sequencia_prescricao_p;

  SELECT position(',' in ds_lista_w)
  INTO STRICT   qt_existe_virgula_w
;

  IF (qt_existe_virgula_w = 0) THEN
    ds_lista_w := ds_lista_w || ',';
  END IF;

  IF (ds_lista_w IS NOT NULL AND ds_lista_w::text <> '') THEN
  BEGIN
    WHILE(ds_lista_w IS NOT NULL AND ds_lista_w::text <> '') LOOP
    BEGIN
      tam_lista_w := LENGTH(ds_lista_w);
      ie_pos_virgula_w := position(',' in ds_lista_w);

      IF (ie_pos_virgula_w <> 0) THEN
        nr_sequencia_prescricao_w := (SUBSTR(ds_lista_w, 1, (ie_pos_virgula_w - 1)))::numeric;
        ds_lista_w := SUBSTR(ds_lista_w, (ie_pos_virgula_w + 1), tam_lista_w);
      END IF;

      select nextval('prescr_proc_captura_img_seq') into STRICT nr_next_sequencia;

      SELECT * FROM gravar_log_alteracao(NULL, nr_next_sequencia, nm_usuario_p, nr_seq_log_atual_w, 'NR_SEQUENCIA', ie_log_w, NULL, 'PRESCR_PROC_CAPTURA_IMG', nr_next_sequencia, NULL) INTO STRICT nr_seq_log_atual_w, ie_log_w;
      SELECT * FROM gravar_log_alteracao(NULL, nr_prescricao_p, nm_usuario_p, nr_seq_log_atual_w, 'NR_PRESCRICAO', ie_log_w, NULL, 'PRESCR_PROC_CAPTURA_IMG', nr_next_sequencia, NULL) INTO STRICT nr_seq_log_atual_w, ie_log_w;
      SELECT * FROM gravar_log_alteracao(NULL, nr_sequencia_prescricao_w, nm_usuario_p, nr_seq_log_atual_w, 'NR_SEQUENCIA_PRESCRICAO', ie_log_w, NULL, 'PRESCR_PROC_CAPTURA_IMG', nr_next_sequencia, null) INTO STRICT nr_seq_log_atual_w, ie_log_w;
      SELECT * FROM gravar_log_alteracao(NULL, nr_sequencia_out, nm_usuario_p, nr_seq_log_atual_w, 'NR_SEQ_CAPTURA', ie_log_w, NULL, 'PRESCR_PROC_CAPTURA_IMG', nr_next_sequencia, NULL) INTO STRICT nr_seq_log_atual_w, ie_log_w;

      INSERT INTO prescr_proc_captura_img(nr_sequencia, dt_atualizacao, nm_usuario, nr_prescricao, nr_sequencia_prescricao, nr_seq_captura)
      VALUES (nr_next_sequencia, clock_timestamp(), nm_usuario_p, nr_prescricao_p, nr_sequencia_prescricao_w, nr_sequencia_out);

    END;
    END LOOP;
  END;
  END IF;

  COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_imagem_captura ( nm_usuario_p text, nr_prescricao_p bigint, nr_sequencia_prescricao_p text, ds_caminho_p text, nr_sequencia_p bigint, nr_sequencia_out INOUT bigint) FROM PUBLIC;

