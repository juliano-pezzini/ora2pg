-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mp_publicar_processo (nr_seq_processo_p bigint, nm_usuario_p text, nr_versao_p INOUT bigint) AS $body$
DECLARE


dt_publicacao_w		timestamp;
nr_seq_origem_w		bigint;
nr_versao_w		bigint;


BEGIN

if (nr_seq_processo_p IS NOT NULL AND nr_seq_processo_p::text <> '') then

	select	dt_publicacao,
		nr_seq_origem
	into STRICT	dt_publicacao_w,
		nr_seq_origem_w
	from	mp_processo
	where	nr_sequencia	= nr_seq_processo_p;

	if (dt_publicacao_w IS NOT NULL AND dt_publicacao_w::text <> '') then
		-- Este processo já foi publicado!
		CALL wheb_mensagem_pck.exibir_mensagem_abort(267104);
	end if;

	/* Mudar os processos para anteriores */

	if (nr_seq_origem_w IS NOT NULL AND nr_seq_origem_w::text <> '') then
		update	mp_processo
		set	ie_status_versao	= 'A'
		where	nr_sequencia		= nr_seq_origem_w;
	end if;

	select	coalesce(max(nr_versao),0) + 1
	into STRICT	nr_versao_w
	from	mp_processo
	where	mp_obter_se_processo_relac(nr_sequencia,nr_seq_processo_p,'F') = 'S';

	/* Atualizar versão do processo */

	update	mp_processo
	set	dt_publicacao		= clock_timestamp(),
		nm_usuario_public	= nm_usuario_p,
		nr_versao		= nr_versao_w,
		ie_status_versao	= 'P'
	where	nr_sequencia	= nr_seq_processo_p;

	/* Mudar a referencia dos processos filhos */

	update	mp_processo
	set	nr_seq_superior	= nr_seq_processo_p
	where	nr_seq_superior	= nr_seq_origem_w;

end if;

nr_versao_p	:= nr_versao_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mp_publicar_processo (nr_seq_processo_p bigint, nm_usuario_p text, nr_versao_p INOUT bigint) FROM PUBLIC;

