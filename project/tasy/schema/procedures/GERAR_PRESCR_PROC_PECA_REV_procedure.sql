-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_prescr_proc_peca_rev ( nr_seq_peca_p bigint, qt_rev_p bigint, nm_usuario_p text) AS $body$
DECLARE



qt_peca_saldo_w 	bigint;
qt_peca_rev_w		bigint;

qt_indice_w		bigint;

nr_sequencia_w		bigint;


BEGIN

select	count(*)
into STRICT	qt_peca_rev_w
from	prescr_proc_peca_rev
where	nr_seq_peca = nr_seq_peca_p;


qt_peca_saldo_w :=  (qt_rev_p - qt_peca_rev_w);

if (qt_peca_saldo_w > 0) then

	for qt_indice_w in 1..qt_peca_saldo_w loop
		begin

		insert	into prescr_proc_peca_rev(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_peca
			)
		values (
			nextval('prescr_proc_peca_rev_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_peca_p
			);

		end;
	end loop;


elsif (qt_peca_saldo_w < 0) then

	qt_peca_saldo_w := abs(qt_peca_saldo_w);

	for qt_indice_w in 1..qt_peca_saldo_w loop
		begin


		select	max(nr_sequencia)
		into STRICT	nr_sequencia_w
		from	prescr_proc_peca_rev
		where	nr_seq_peca = nr_seq_peca_p;


		delete
		from	prescr_proc_peca_rev
		where	nr_sequencia	= nr_sequencia_w;


		end;
	end loop;

end if;


-- SEM COMMIT, UTILIZADO EM TRIGGER
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_prescr_proc_peca_rev ( nr_seq_peca_p bigint, qt_rev_p bigint, nm_usuario_p text) FROM PUBLIC;

