-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reg_update_rev_approval_item ( nr_seq_revision_p bigint, ie_aceito_p text, nm_usuario_p text, ds_comentario_revisor_p text default null, ds_comentario_autor_p text default null, ie_destino_revisao_p text default null) AS $body$
DECLARE


ie_status_revisao_w			reg_version_revision.ie_status_revisao%type;
nr_seq_documento_w			reg_version_revision.nr_seq_documento%type;
nr_seq_rev_control_w			reg_revision_control.nr_sequencia%type;
nr_seq_version_approval_w		reg_version_approvers.nr_sequencia%type;
ie_destino_revisao_w			varchar(10);


BEGIN

select	ie_status_revisao,
	nr_seq_documento
into STRICT	ie_status_revisao_w,
	nr_seq_documento_w
from	reg_version_revision
where	nr_sequencia = nr_seq_revision_p;

select	max(nr_sequencia)
into STRICT	nr_seq_rev_control_w
from	reg_revision_control
where	nr_seq_revisao = nr_seq_revision_p;

select	max(rva.nr_sequencia)
into STRICT	nr_seq_version_approval_w
from	reg_version_approvers rva
where	rva.nr_seq_revision = nr_seq_revision_p
and	rva.nr_seq_rev_control = nr_seq_rev_control_w
and (rva.nm_approver = nm_usuario_p or reg_doc_has_user_delegation(nr_seq_documento_w, rva.ie_approver_type, rva.nm_approver, nm_usuario_p) = 'S')
and (ie_status_revisao_w <> 'R' or coalesce(rva.ie_aceito::text, '') = '')
and	(
		(ie_status_revisao_w in ('R', 'S') and rva.ie_approver_type = 'R') or (ie_status_revisao_w = 'P' and rva.ie_approver_type = 'A' and coalesce(rva.dt_approved::text, '') = '') or (ie_status_revisao_w = 'A' and rva.ie_approver_type in ('R', 'A'))
	);

if (nr_seq_version_approval_w IS NOT NULL AND nr_seq_version_approval_w::text <> '') then

	if (ie_status_revisao_w in ('S', 'P')) then
		
		update	reg_version_approvers
		set	dt_revisao = clock_timestamp(),
			ie_aceito = ie_aceito_p,
			dt_atualizacao = clock_timestamp(),
			nm_usuario = nm_usuario_p,
			ds_comentario_revisor = coalesce(ds_comentario_revisor_p, ds_comentario_revisor),
			dt_approved = CASE WHEN ie_aceito_p='S' THEN  clock_timestamp()  ELSE null END ,
			nm_usuario_delegacao = CASE WHEN nm_usuario_p=nm_approver THEN  null  ELSE nm_usuario_p END
		where	nr_sequencia = nr_seq_version_approval_w;

	elsif (ie_status_revisao_w = 'R') then
		
		update	reg_version_approvers
		set	dt_revisao = clock_timestamp(),
			ie_aceito = ie_aceito_p,
			dt_atualizacao = clock_timestamp(),
			nm_usuario = nm_usuario_p,
			ds_comentario_revisor = coalesce(ds_comentario_revisor_p, ds_comentario_revisor),
			nm_usuario_delegacao = CASE WHEN nm_usuario_p=nm_approver THEN  null  ELSE nm_usuario_p END
		where	nr_sequencia = nr_seq_version_approval_w;

	elsif (ie_status_revisao_w = 'A') then

		update	reg_version_approvers
		set	ds_comentario_autor = ds_comentario_autor_p,
			dt_comentario_autor = clock_timestamp(),
			nm_usuario = nm_usuario_p,
			dt_atualizacao = clock_timestamp(),
			nm_usuario_delegacao = CASE WHEN nm_usuario_p=nm_approver THEN  null  ELSE nm_usuario_p END
		where	nr_sequencia = nr_seq_version_approval_w;

	end if;
end if;

if (coalesce(ie_destino_revisao_p::text, '') = '') then
	ie_destino_revisao_w := 'T';
else
	ie_destino_revisao_w := ie_destino_revisao_p;
end if;

CALL reg_update_revision_status(nr_seq_revision_p, ie_destino_revisao_w, nm_usuario_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reg_update_rev_approval_item ( nr_seq_revision_p bigint, ie_aceito_p text, nm_usuario_p text, ds_comentario_revisor_p text default null, ds_comentario_autor_p text default null, ie_destino_revisao_p text default null) FROM PUBLIC;

