-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_comunic_doc_venc_pf ( nm_usuario_p text) AS $body$
DECLARE


/*Fields rule*/

nr_seq_regra_w			bigint;
ie_data_w			varchar(15);
nr_seq_tipo_doc_w		bigint;
qt_dias_aviso_w			varchar(15);
ie_vinculo_medico_w		varchar(15);
ie_comunicacao_interna_w	varchar(01);
ie_email_w			varchar(01);
ds_email_origem_w		varchar(255);
ds_lista_email_destino_w	varchar(2000);
ds_titulo_w			varchar(255);
ds_comunicado_w			varchar(32000);
ds_lista_w			varchar(32000);
ds_documento_w			varchar(255);
nr_crm_w			varchar(20);
nm_pessoa_fisica_w		varchar(60);
ie_gerar_doc_individual_w	varchar(15);

/*Fields target user*/

ds_usuario_destino_w		varchar(2000);
nr_seq_grupo_usuario_w		bigint;
cd_perfil_destino_w		integer;
ds_grupo_w			varchar(255);
ds_usuarios_w			varchar(4000);
ds_perfil_destino_w		varchar(4000);

/*Fields documentation and person*/

cd_pessoa_fisica_w		varchar(10);
dt_entrega_w			timestamp;
dt_validade_w			timestamp;
nr_seq_doc_w			bigint;
cd_pes_fisica_w			varchar(10);

/*Fields email*/

lista_usuario_w			varchar(2000);
tam_lista_w			bigint;
ie_pos_virgula_w		smallint;
ds_email_usuario_w		varchar(255);
ds_lista_email_usuario_w	varchar(2000);
nm_usuario_w			varchar(15);

/*Rules*/

c01 CURSOR FOR
SELECT	nr_sequencia,
	ie_data,
	nr_seq_tipo_documento,
	qt_dias_aviso,
	ie_vinculo_medico,
	ie_comunic_interna,
	ie_email,
	ds_email_origem,
	ds_lista_email_destino,
	ds_titulo,
	ds_comunicacao,
	ie_gerar_doc_individual
from	regra_comunic_venc_doc_pf
where	ie_situacao = 'A';

/*Documents meeting the rule*/

c02 CURSOR FOR
SELECT	a.cd_pessoa_fisica,
	a.nr_seq_documento,
	a.dt_entrega,
	a.dt_validade,
	m.nr_crm,
	substr(obter_desc_tipo_documentacao(a.nr_seq_documento),1,255) ds_documento,
	substr(obter_nome_pf(b.cd_pessoa_fisica),0,60),
	substr(obter_usuario_pf(b.cd_pessoa_fisica),1,15)
FROM pessoa_documentacao a, pessoa_fisica b
LEFT OUTER JOIN medico m ON (b.cd_pessoa_fisica = m.cd_pessoa_fisica)
WHERE a.cd_pessoa_fisica = b.cd_pessoa_fisica and ie_data_w = 'E'  and (a.dt_entrega IS NOT NULL AND a.dt_entrega::text <> '') and coalesce(a.ie_situacao, 'A') = 'A' and substr(obter_se_contido(obter_dias_entre_datas(trunc(clock_timestamp()), a.dt_entrega),qt_dias_aviso_w),1,1) = 'S' and ((coalesce(nr_seq_tipo_doc_w,0) = 0) or (a.nr_seq_documento = nr_seq_tipo_doc_w))

union all

SELECT	a.cd_pessoa_fisica,
	a.nr_seq_documento,
	a.dt_entrega,
	a.dt_validade,
	m.nr_crm,
	substr(obter_desc_tipo_documentacao(a.nr_seq_documento),1,255) ds_documento,
	substr(obter_nome_pf(b.cd_pessoa_fisica),0,60),
	substr(obter_usuario_pf(b.cd_pessoa_fisica),1,15) nm_usuario
FROM pessoa_documentacao a, pessoa_fisica b
LEFT OUTER JOIN medico m ON (b.cd_pessoa_fisica = m.cd_pessoa_fisica)
WHERE a.cd_pessoa_fisica = b.cd_pessoa_fisica and ie_data_w = 'V'  and (a.dt_validade IS NOT NULL AND a.dt_validade::text <> '') and coalesce(a.ie_situacao, 'A') = 'A' and substr(obter_se_contido(obter_dias_entre_datas(trunc(clock_timestamp()), a.dt_validade),qt_dias_aviso_w),1,1) = 'S' and ((coalesce(nr_seq_tipo_doc_w,0) = 0) or (a.nr_seq_documento = nr_seq_tipo_doc_w));

/*Rule users*/

c03 CURSOR FOR
SELECT	ds_usuario_destino,
	nr_seq_grupo_usuario,
	cd_perfil_destino
from	regra_comun_ven_doc_pf_usu
where	nr_seq_regra = nr_seq_regra_w;


BEGIN

open C01;
loop
fetch C01 into	
	nr_seq_regra_w,
	ie_data_w,
	nr_seq_tipo_doc_w,
	qt_dias_aviso_w,
	ie_vinculo_medico_w,
	ie_comunicacao_interna_w,
	ie_email_w,
	ds_email_origem_w,
	ds_lista_email_destino_w,
	ds_titulo_w,
	ds_comunicado_w,
	ie_gerar_doc_individual_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ds_lista_w := '';
	ds_usuario_destino_w 	:= '';
	nr_seq_grupo_usuario_w	:= '';
	ds_grupo_w		:= '';
	ds_usuarios_w		:= '';
	ds_perfil_destino_w	:= '';

	open C02;
	loop
	fetch C02 into	
		cd_pessoa_fisica_w,
		nr_seq_doc_w,
		dt_entrega_w,
		dt_validade_w,
		nr_crm_w,
		ds_documento_w,
		nm_pessoa_fisica_w,
		nm_usuario_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		
		/*ds_lista_w := substr(ds_lista_w || 'Name: ' || nm_pessoa_fisica_w || ' ' || nr_crm_w || ' ' || 
					' Document: ' || ds_documento_w || ' Expiration: ' || dt_validade_w || 
					' Delivery date: ' || dt_entrega_w || chr(13) || chr(10),1,32000);
		*/
			
		
		ds_lista_w := substr(ds_lista_w || wheb_mensagem_pck.get_texto(306306,'NM_PESSOA_FISICA_W='||nm_pessoa_fisica_w),1,32000); --'Name: ' || nm_pessoa_fisica_w
		if (coalesce(nr_crm_w,'X') <> 'X') then
			ds_lista_w := substr(ds_lista_w || wheb_mensagem_pck.get_texto(306307,'NR_CRM_W='||nr_crm_w),1,32000); --' - Professional council: ' || nr_crm_w
		end if;
		ds_lista_w := substr(ds_lista_w || wheb_mensagem_pck.get_texto(306308,'DS_DOCUMENTO_W='||ds_documento_w) ,1,32000); --' - Document: ' || ds_documento_w
		
		if (dt_validade_w IS NOT NULL AND dt_validade_w::text <> '') then
			ds_lista_w := substr(ds_lista_w || wheb_mensagem_pck.get_texto(306321,'DT_VALIDADE_W='||dt_validade_w),1,32000); --' - Expiration: ' || dt_validade_w
		end if;
		
		if (dt_entrega_w IS NOT NULL AND dt_entrega_w::text <> '') then
			ds_lista_w := substr(ds_lista_w || wheb_mensagem_pck.get_texto(306322,'DT_ENTREGA_W='||dt_entrega_w) ,1,32000); --' - Delivery date: ' || dt_entrega_w
		end if;
		
		ds_lista_w := substr(ds_lista_w || chr(13) || chr(10),1,32000);
		
		if (coalesce( ie_gerar_doc_individual_w ,'N') = 'S') then
			
			if (nm_usuario_w IS NOT NULL AND nm_usuario_w::text <> '') then
			
				if (coalesce(ds_usuarios_w::text, '') = '') then
					
					ds_usuarios_w	:=  nm_usuario_w;
				else
					ds_usuarios_w	:=  nm_usuario_w || ',';
					
				end if;
			
			end if;
			
		end if;
		
		end;
	end loop;
	close C02;
	end;
						
	ds_comunicado_w := substr(ds_comunicado_w || chr(13) || chr(10) || ds_lista_w ,1,32000);
	
	open C03;
	loop
	fetch C03 into	
		ds_usuario_destino_w,
		nr_seq_grupo_usuario_w,
		cd_perfil_destino_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin
		
		if (ds_usuario_destino_w IS NOT NULL AND ds_usuario_destino_w::text <> '') and (ds_usuarios_w IS NOT NULL AND ds_usuarios_w::text <> '') then
			ds_usuarios_w	:= ds_usuarios_w || ',';
		end if;
		
		if (coalesce(nr_seq_grupo_usuario_w,0) > 0) then
			ds_grupo_w	:= substr(ds_grupo_w || nr_seq_grupo_usuario_w || ',',1,255);
		end if;
		if (coalesce(trim(both ds_usuario_destino_w),',') <> ',') then
			ds_usuarios_w	:= substr(ds_usuarios_w  || ds_usuario_destino_w || ',',1,4000);
		end if;	
		if (coalesce(cd_perfil_destino_w,0) > 0) then
			ds_perfil_destino_w	:= substr(ds_perfil_destino_w || cd_perfil_destino_w || ',',1,4000);
		end if;
		end;
	end loop;
	close C03;
	
	if (ie_comunicacao_interna_w = 'S') and
		((coalesce(ds_grupo_w,'X') <> 'X') or (coalesce(ds_usuarios_w,'X') <> 'X') or (coalesce(ds_perfil_destino_w,'X') <> 'X')) and (coalesce(nm_pessoa_fisica_w,'X') <> 'X') then  /*just to check if found any records in c02*/
		begin
		
		CALL gerar_comunic_padrao(	clock_timestamp(),
					coalesce(ds_titulo_w, wheb_mensagem_pck.get_texto(306323)), --'Document expiration alert (PF)'
					ds_comunicado_w,
					nm_usuario_p,
					'N',
					ds_usuarios_w,
					'N',
					null,
					ds_perfil_destino_w,
					null,
					'',
					clock_timestamp(),
					ds_grupo_w,
					'');
		end;
	end if;
	
	if (ie_email_w = 'S') and (coalesce(nm_pessoa_fisica_w,'X') <> 'X') then  /*just to check if found any records in c02*/
		begin
		lista_usuario_w := substr(ds_usuarios_w,1,2000);

		while(lista_usuario_w IS NOT NULL AND lista_usuario_w::text <> '') and (trim(both lista_usuario_w) <> ',') loop
			tam_lista_w	:= length(lista_usuario_w);
			ie_pos_virgula_w	:= position(',' in lista_usuario_w);

			if (ie_pos_virgula_w <> 0) then
				ds_usuarios_w	:= substr(lista_usuario_w,1,(ie_pos_virgula_w - 1));
				lista_usuario_w	:= trim(both substr(lista_usuario_w,(ie_pos_virgula_w + 1), tam_lista_w));

				select	max(ds_email)
				into STRICT	ds_email_usuario_w
				from	usuario
				where	nm_usuario = ds_usuarios_w;

				if (coalesce(ds_email_usuario_w,'X') <> 'X') then
					begin
					ds_lista_email_usuario_w	:= substr(ds_lista_email_usuario_w||ds_email_usuario_w||',',1,2000);
					end;
				end if;
			else
				lista_usuario_w	:= null;
			end if;
		end loop;

		if (coalesce(ds_lista_email_destino_w,'X') <> 'X') then
			ds_lista_email_usuario_w := substr(ds_lista_email_usuario_w || ds_lista_email_destino_w,1,2000);
		end if;
		
		if (coalesce(ds_lista_email_usuario_w,'X') <> 'X') then
			ds_lista_email_usuario_w := replace(ds_lista_email_usuario_w,',',';');
			CALL enviar_email(	coalesce(ds_titulo_w,wheb_mensagem_pck.get_texto(306323)),
					ds_comunicado_w,
					ds_email_origem_w, -- Email registered in the rule.
					ds_lista_email_usuario_w,
					nm_usuario_p,
					'M');
		end if;
		end;
	end if;	
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_comunic_doc_venc_pf ( nm_usuario_p text) FROM PUBLIC;

