-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_replicar_regra_grupo ( nr_seq_grupo_p pls_grupo_contrato.nr_sequencia%type, nr_seq_regra_copartic_aprop_p pls_regra_copartic.nr_sequencia%type, nr_seq_contrato_destino_p pls_contrato.nr_sequencia%type, dt_inicio_vigencia_p timestamp, ie_finalizar_regra_vigente_p text, ie_commit_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_seq_regra_copartic_nova_w	pls_regra_copartic.nr_sequencia%type;

C01 CURSOR FOR
	SELECT	nr_seq_contrato
	from	pls_contrato_grupo
	where	nr_seq_grupo	= nr_seq_grupo_p
	and	nr_seq_contrato <> coalesce(nr_seq_contrato_destino_p, 0)
	and	(nr_seq_contrato IS NOT NULL AND nr_seq_contrato::text <> '');

C02 CURSOR(	nr_seq_contrato_pc	pls_contrato.nr_sequencia%type) FOR
	SELECT	nr_sequencia
	from	pls_regra_copartic
	where	nr_seq_contrato = nr_seq_contrato_pc
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	coalesce(dt_fim_vigencia::text, '') = ''
	and	dt_atualizacao_nrec < (clock_timestamp() - (5/1440)); --Desconsiderar regras criadas nos ultimos 5 minutos, para nao encerrar a vigencia das regras que estao sendo criadas
BEGIN
for r_c01_w in c01 loop
	begin
	if (ie_finalizar_regra_vigente_p = 'S') then
		for r_c02_w in c02(r_c01_w.nr_seq_contrato) loop
			begin
			update	pls_regra_copartic
			set	dt_fim_vigencia	= fim_dia(clock_timestamp() - interval '1 days')
			where	nr_sequencia = r_c02_w.nr_sequencia;
			end;
		end loop;
	end if;
	
	select	nextval('pls_regra_copartic_seq')
	into STRICT	nr_seq_regra_copartic_nova_w
	;
	
	insert	into	pls_regra_copartic(	nr_sequencia, nr_seq_tipo_coparticipacao, dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
		nm_usuario_nrec, nr_seq_contrato, nr_seq_plano, dt_inicio_vigencia,
		ie_tipo_atendimento, vl_maximo_copartic, ie_beneficiario, ie_prestador, ie_conta_medica, ie_utilizacao,
		ie_guia, ie_forma_cobr_internacao, ie_internacao, nr_ordem_prioridade, dt_liberacao, nr_seq_mot_reembolso)
	(SELECT	nr_seq_regra_copartic_nova_w, nr_seq_tipo_coparticipacao, clock_timestamp(), nm_usuario_p, clock_timestamp(),
		nm_usuario_p, r_c01_w.nr_seq_contrato, nr_seq_plano, coalesce(dt_inicio_vigencia_p, clock_timestamp()),
		ie_tipo_atendimento, vl_maximo_copartic, ie_beneficiario, ie_prestador, ie_conta_medica, ie_utilizacao,
		ie_guia, coalesce(ie_forma_cobr_internacao,'I'), ie_internacao, nr_ordem_prioridade, clock_timestamp(), nr_seq_mot_reembolso
	from	pls_regra_copartic
	where	nr_sequencia	= nr_seq_regra_copartic_aprop_p );
	
	insert	into	pls_regra_copartic_aprop(	nr_sequencia, nr_seq_regra, nr_seq_centro_apropriacao,
		ie_tipo_apropriacao, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
		vl_apropriacao, tx_apropriacao)
	(SELECT	nextval('pls_regra_copartic_aprop_seq'), nr_seq_regra_copartic_nova_w, nr_seq_centro_apropriacao,
		ie_tipo_apropriacao, clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p,
		vl_apropriacao, tx_apropriacao
	from	pls_regra_copartic_aprop
	where	nr_seq_regra	= nr_seq_regra_copartic_aprop_p );

	insert	into	pls_regra_copartic_benef(	nr_sequencia, nr_seq_regra, dt_atualizacao, nm_usuario,
		dt_atualizacao_nrec, nm_usuario_nrec, ie_titularidade, nr_seq_plano, qt_idade_min,
		qt_idade_max, ie_tipo_parentesco, dt_contrato_de, dt_contrato_ate, nr_faixa_salarial_inicial,
		nr_faixa_salarial_final, ie_situacao_benef)
	(SELECT	nextval('pls_regra_copartic_benef_seq'), nr_seq_regra_copartic_nova_w, clock_timestamp(), nm_usuario_p,
		clock_timestamp(), nm_usuario_p, ie_titularidade, nr_seq_plano, qt_idade_min,
		qt_idade_max, ie_tipo_parentesco, dt_contrato_de, dt_contrato_ate, nr_faixa_salarial_inicial,
		nr_faixa_salarial_final, ie_situacao_benef
	from	pls_regra_copartic_benef
	where	nr_seq_regra	= nr_seq_regra_copartic_aprop_p );

	insert	into	pls_regra_copartic_conta(	nr_sequencia, nr_seq_regra, dt_atualizacao, nm_usuario,
		dt_atualizacao_nrec, nm_usuario_nrec, ie_tipo_atendimento, ie_forma_cobr_internacao,
		vl_item_minimo, vl_item_maximo, nr_seq_tipo_conta, ie_cobranca_prevista)
	(SELECT	nextval('pls_regra_copartic_conta_seq'), nr_seq_regra_copartic_nova_w, clock_timestamp(), nm_usuario_p,
		clock_timestamp(), nm_usuario_p, ie_tipo_atendimento, ie_forma_cobr_internacao,
		vl_item_minimo, vl_item_maximo, nr_seq_tipo_conta, ie_cobranca_prevista
	from	pls_regra_copartic_conta
	where	nr_seq_regra	= nr_seq_regra_copartic_aprop_p );

	insert	into	pls_regra_copartic_util(	nr_sequencia, nr_seq_regra, dt_atualizacao, nm_usuario,
		dt_atualizacao_nrec, nm_usuario_nrec, qt_evento_minimo, qt_evento_maximo, ie_tipo_data_consistencia,
		qt_periodo_ocorrencia, ie_tipo_periodo_ocor, nr_seq_grupo_serv, ie_eventos_incidencia)
	(SELECT	nextval('pls_regra_copartic_util_seq'), nr_seq_regra_copartic_nova_w, clock_timestamp(), nm_usuario_p,
		clock_timestamp(), nm_usuario_p, qt_evento_minimo, qt_evento_maximo, ie_tipo_data_consistencia,
		qt_periodo_ocorrencia, ie_tipo_periodo_ocor, nr_seq_grupo_serv, ie_eventos_incidencia
	from	pls_regra_copartic_util
	where	nr_seq_regra	= nr_seq_regra_copartic_aprop_p );

	insert	into	pls_regra_copartic_prest(	nr_sequencia, nr_seq_regra, dt_atualizacao, nm_usuario,
		dt_atualizacao_nrec, nm_usuario_nrec, ie_prestador_cooperado, nr_seq_prestador_atend,
		nr_seq_tipo_prestador_atend)
	(SELECT	nextval('pls_regra_copartic_prest_seq'), nr_seq_regra_copartic_nova_w, clock_timestamp(), nm_usuario_p,
		clock_timestamp(), nm_usuario_p, ie_prestador_cooperado, nr_seq_prestador_atend,
		nr_seq_tipo_prestador_atend
	from	pls_regra_copartic_prest
	where	nr_seq_regra	= nr_seq_regra_copartic_aprop_p );

	insert	into	pls_regra_copartic_guia(	nr_sequencia, nr_seq_regra, dt_atualizacao, nm_usuario,
		dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_controle_interno, ie_tipo_atend_tiss)
	(SELECT	nextval('pls_regra_copartic_guia_seq'), nr_seq_regra_copartic_nova_w, clock_timestamp(), nm_usuario_p,
		clock_timestamp(), nm_usuario_p, nr_seq_controle_interno, ie_tipo_atend_tiss
	from	pls_regra_copartic_guia
	where	nr_seq_regra	= nr_seq_regra_copartic_aprop_p );

	insert	into	pls_regra_copartic_interna(	nr_sequencia, nr_seq_regra, dt_atualizacao, nm_usuario,
		dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_clinica, qt_diaria_inicial, qt_diaria_final)
	(SELECT	nextval('pls_regra_copartic_interna_seq'), nr_seq_regra_copartic_nova_w, clock_timestamp(), nm_usuario_p,
		clock_timestamp(), nm_usuario_p, nr_seq_clinica, qt_diaria_inicial, qt_diaria_final
	from	pls_regra_copartic_interna
	where	nr_seq_regra	= nr_seq_regra_copartic_aprop_p);
	
	end;
end loop;

if (coalesce(ie_commit_p, 'S') = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_replicar_regra_grupo ( nr_seq_grupo_p pls_grupo_contrato.nr_sequencia%type, nr_seq_regra_copartic_aprop_p pls_regra_copartic.nr_sequencia%type, nr_seq_contrato_destino_p pls_contrato.nr_sequencia%type, dt_inicio_vigencia_p timestamp, ie_finalizar_regra_vigente_p text, ie_commit_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

