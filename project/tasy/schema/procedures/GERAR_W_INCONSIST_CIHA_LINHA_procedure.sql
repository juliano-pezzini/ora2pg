-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_inconsist_ciha_linha ( nr_seq_lote_p bigint, nr_prontuario_p bigint, ds_inconsistencia_p text, ie_exclui_anteriores_p text) AS $body$
DECLARE


arq_texto_w			utl_file.file_type;
qt_tentativas_w			bigint := 0;
ie_aberto_w			varchar(1);
ie_eof_w			varchar(1);
ds_linha_pront_w		varchar(20);
ds_line_w			varchar(1000);
ds_prontuario_w			varchar(10);
/*Atributos da tabela  */

ds_inconsistencia_w		varchar(100);
nr_atendimento_w		bigint;
cd_motivo_alta_w		bigint;
ds_procedimento_w		varchar(40);
nm_paciente_w			varchar(60);
dt_entrada_w			timestamp;
dt_alta_w			timestamp;
ie_existe_tabela_w		varchar(1);
nm_arquivo_w			varchar(255);

C01 CURSOR FOR
	SELECT  nr_atendimento,
		cd_motivo_alta,
		ds_procedimento,
		nm_paciente,
		dt_entrada,
		dt_alta
	from    lote_cih_item
	where   nr_prontuario 	= nr_prontuario_p
	and	nr_seq_lote 	= nr_seq_lote_p;


BEGIN

select	coalesce(max('S'),'N')
into STRICT	ie_existe_tabela_w
from	user_tables
where	table_name = 'W_INCONSISTENCIAS_CIHA';

If (ie_existe_tabela_w = 'N') then
	CALL Exec_Sql_Dinamico('TASY','create table w_inconsistencias_ciha(nr_atendimento	number(10),'||
				'		nm_paciente	varchar2(60), ' ||
				'		dt_entrada	date, '||
				'		dt_alta		date, '||
				'		ds_procedimento	varchar2(40), '||
				'		cd_motivo_alta	number(10), '||
				'		ds_inconsistencia	varchar(255))');
End if;

if (ie_exclui_anteriores_p = 'S') then
	delete	from w_inconsistencias_ciha;
end if;

open C01;
loop
fetch C01 into
	nr_atendimento_w,
	cd_motivo_alta_w,
	ds_procedimento_w,
	nm_paciente_w,
	dt_entrada_w,
	dt_alta_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

	insert into w_inconsistencias_ciha(
			nr_atendimento,
			nm_paciente,
			dt_entrada,
			dt_alta,
			ds_procedimento,
			cd_motivo_alta,
			ds_inconsistencia)
	values (
			nr_atendimento_w,
			nm_paciente_w,
			dt_entrada_w,
			dt_alta_w,
			ds_procedimento_w,
			cd_motivo_alta_w,
			ds_inconsistencia_p);
	commit;

end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_inconsist_ciha_linha ( nr_seq_lote_p bigint, nr_prontuario_p bigint, ds_inconsistencia_p text, ie_exclui_anteriores_p text) FROM PUBLIC;

