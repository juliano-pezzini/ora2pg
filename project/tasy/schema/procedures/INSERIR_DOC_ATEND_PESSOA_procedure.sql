-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_doc_atend_pessoa ( nr_sequencia_p bigint) AS $body$
DECLARE


ds_arquivo_w		atendimento_paciente_anexo.ds_arquivo%type;
dt_validade_w		atendimento_paciente_anexo.dt_validade%type;
nr_seq_documento_w	atendimento_paciente_anexo.nr_seq_documento%type;
cd_pessoa_fisica_w	pessoa_fisica.cd_pessoa_fisica%type;
ie_gera_arquivo_w	varchar(1) := 'S';
nm_usuario_w		usuario.nm_usuario%type;

c01 CURSOR FOR
	SELECT	ds_arquivo,
		dt_validade,
		nr_seq_documento
	from	pessoa_documentacao
	where	cd_pessoa_fisica = cd_pessoa_fisica_w;
BEGIN

if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then

	select	a.ds_arquivo,
		a.dt_validade,
		a.nr_seq_documento,
		b.cd_pessoa_fisica
	into STRICT	ds_arquivo_w,
		dt_validade_w,
		nr_seq_documento_w,
		cd_pessoa_fisica_w
	from	atendimento_paciente_anexo a,
		atendimento_paciente b
	where	a.nr_atendimento = b.nr_atendimento
	and	a.nr_sequencia = nr_sequencia_p;

	for r_c01 in c01 loop
		if (r_c01.dt_validade = dt_validade_w) and (r_c01.nr_seq_documento = nr_seq_documento_w) then
			ie_gera_arquivo_w := 'N';
		end if;

	end loop;

	if (ie_gera_arquivo_w = 'S') then
		select	obter_usuario_ativo
		into STRICT	nm_usuario_w
		;

		insert into pessoa_documentacao(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_pessoa_fisica,
			nr_seq_documento,
			ie_entregue,
			ds_arquivo,
			dt_validade)
		values (nextval('pessoa_documentacao_seq'),
			clock_timestamp(),
			nm_usuario_w,
			clock_timestamp(),
			nm_usuario_w,
			cd_pessoa_fisica_w,
			nr_seq_documento_w,
			'S',
			ds_arquivo_w,
			dt_validade_w);

		commit;
	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_doc_atend_pessoa ( nr_sequencia_p bigint) FROM PUBLIC;

