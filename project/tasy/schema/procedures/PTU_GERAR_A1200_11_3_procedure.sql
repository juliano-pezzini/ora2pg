-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_gerar_a1200_11_3 ( nr_seq_pacote_p ptu_pacote.nr_sequencia%type, cd_interface_p interface.cd_interface%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

				
ds_conteudo_w		varchar(4000);
nr_seq_linha_w		bigint := 0;
qt_tot_202_w		bigint := 0;
qt_tot_203_w		bigint := 0;
qt_tot_204_w		bigint := 0;
qt_tot_205_w		bigint := 0;
ds_arquivo_w		text;
ds_hash_w		ptu_pacote.ds_hash%type;

-- R201 ? HEADER (OBRIGAT?RIO)
c01 CURSOR(nr_seq_pacote_pc	ptu_pacote.nr_sequencia%type) FOR
	SELECT	nr_sequencia,
		lpad(coalesce(cd_unimed_origem,'0'),'4','0') cd_unimed_origem,
		lpad(coalesce(to_char(dt_geracao,'yyyymmdd'),' '),8,' ') dt_geracao,
		coalesce(ie_tipo_carga,1) ie_tipo_carga,
		coalesce(ie_tipo_informacao,1) ie_tipo_informacao,
		coalesce(nr_versao_transacao,'06') nr_versao_transacao
	from	ptu_pacote
	where	nr_sequencia	= nr_seq_pacote_pc;
	
-- R202 ? PACOTE (OBRIGAT?RIO)
c02 CURSOR(nr_seq_pacote_pc	ptu_pacote.nr_sequencia%type) FOR
	SELECT	nr_sequencia,		
		lpad(coalesce(to_char(cd_pacote),'0'),8,'0') cd_pacote,
		rpad(' ',60,' ') nm_pacote,
		lpad(' ',4,' ') cd_unimed_prestador,
		lpad(' ',8,' ') cd_prestador,
		rpad(' ',40,' ') nm_prestador,
		lpad(coalesce(to_char(dt_negociacao,'yyyymmdd'),' '),8,' ') dt_negociacao,
		lpad(coalesce(to_char(dt_publicacao,'yyyymmdd'),' '),8,' ') dt_publicacao,
		rpad(coalesce(ie_tipo_acomodacao,' '),2,' ') ie_tipo_acomodacao,
		lpad(coalesce(to_char(ie_tipo_pacote),'0'),2,'0') ie_tipo_pacote,
		lpad(coalesce(to_char(cd_especialidade),'0'),2,'0') cd_especialidade,
		lpad(coalesce(to_char(dt_inicio_vigencia,'yyyymmdd'),' '),8,' ') dt_inicio_vigencia,
		lpad(coalesce(to_char(dt_fim_vigencia,'yyyymmdd'),' '),8,' ') dt_fim_vigencia,
		coalesce(ie_tipo_internacao,'0') ie_tipo_internacao,
		lpad(coalesce(replace(replace(campo_mascara(get_tot_serv_item(ptu_pacote_reg.nr_sequencia, 1),2),',',''),'.',''),'0'),14,'0') vl_tot_taxas,
		lpad(coalesce(replace(replace(campo_mascara(get_tot_serv_item(ptu_pacote_reg.nr_sequencia, 2),2),',',''),'.',''),'0'),14,'0') vl_tot_diarias,
		lpad(coalesce(null,'0'),14,'0') vl_tot_gases,        
		lpad(coalesce(replace(replace(campo_mascara(get_tot_serv_item(ptu_pacote_reg.nr_sequencia, 4),2),',',''),'.',''),'0'),14,'0') vl_tot_mat,
		lpad(coalesce(replace(replace(campo_mascara(get_tot_serv_item(ptu_pacote_reg.nr_sequencia, 5),2),',',''),'.',''),'0'),14,'0') vl_tot_med,
		lpad(coalesce(replace(replace(campo_mascara(get_tot_serv_item(ptu_pacote_reg.nr_sequencia, 6),2),',',''),'.',''),'0'),14,'0') vl_tot_proc,
		lpad(coalesce(replace(replace(campo_mascara(get_tot_serv_item(ptu_pacote_reg.nr_sequencia, 7),2),',',''),'.',''),'0'),14,'0') vl_tot_opme,
		lpad(coalesce(replace(replace(campo_mascara(get_tot_serv_item(ptu_pacote_reg.nr_sequencia),2),',',''),'.',''),'0'),14,'0') vl_tot_pacote,				
		coalesce(ie_honorario,'N') ie_honorario,
		substr(ds_observacao,1,999) ds_observacao,
		'0' tipo_rede_min,
		'000' versao_pacote,
		coalesce(ie_anestesista,'N') ie_anestesista,
		coalesce(ie_opme,'N') ie_opme,
		coalesce(ie_auxiliar,'N') ie_auxiliar,
		CASE WHEN trunc(clock_timestamp(), 'MONTH')=trunc(dt_reajuste, 'MONTH') THEN  'S'  ELSE 'N' END  id_reajuste
	from	ptu_pacote_reg
	where	nr_seq_pacote		= nr_seq_pacote_pc
	and	ie_tipo_informacao	= 1;
	
-- R204 ? SERVI?O - PACOTE (OBRIGAT?RIO)
c03 CURSOR(nr_seq_pacote_reg_pc	ptu_pacote_reg.nr_sequencia%type) FOR
	SELECT	nr_sequencia,
		coalesce(ie_tipo_item,'0') ie_tipo_item,
		coalesce(ie_tipo_tabela,'0') ie_tipo_tabela,
		lpad(coalesce(cd_servico,'0'),8,'0') cd_servico,
		coalesce(ie_principal,'1') ie_principal,
		coalesce(ie_honorario,'N') ie_honorario,
		coalesce(ie_tipo_participacao,'0') ie_tipo_participacao,
		lpad(coalesce(qt_servico*10000,'0'),8,'0') qt_servico,
		lpad(coalesce(replace(replace(campo_mascara(case when coalesce(qt_servico,0) > 1 then round((vl_servico / qt_servico)::numeric, 2) else vl_servico end,2),',',''),'.',''),'0'),14,'0') vl_servico,
		lpad(coalesce(replace(replace(campo_mascara((vl_servico),2),',',''),'.',''),'0'),14,'0') vl_serv_total,
		rpad(substr(coalesce(ds_servico,' '),1,80),80,' ') ds_servico,
		lpad(coalesce(cd_unidade_medida,'0'),3,'0') cd_unidade_medida
	from	ptu_pacote_servico
	where	nr_seq_pacote_reg	= nr_seq_pacote_reg_pc;
	
-- R205 ? PRESTADOR (OBRIGAT?RIO)
c205 CURSOR(nr_seq_pacote_reg_pc	ptu_pacote_reg.nr_sequencia%type) FOR
	SELECT	lpad(coalesce(cd_unimed_prestador,'0'),4,'0') cd_unimed_prestador,
		lpad(coalesce(to_char(cd_prestador),'0'),8,'0') cd_prestador,
		rpad(substr(coalesce(nm_prestador,' '),1,70),70,' ') nm_prestador,
		lpad(coalesce(cd_cgc_cpf,'0'),15,'0') cd_cgc_cpf,
		rpad(coalesce(cd_cnes_prest,' '),7,' ') cd_cnes_prest,
		coalesce(id_reajuste, 'N') id_reajuste,
		rpad(coalesce(substr(ds_anexo_ptu, 1, 29),' '), 29, ' ') id_anexo_reajuste
	from	ptu_pacote_prest
	where	nr_seq_pacote_reg	= nr_seq_pacote_reg_pc;
BEGIN
delete	FROM w_ptu_envio_arq
where	nm_usuario = nm_usuario_p;

-- R201 ? HEADER (OBRIGAT?RIO)
for r_C01_w in C01(nr_seq_pacote_p) loop
	nr_seq_linha_w	:=	nr_seq_linha_w + 1;
	ds_conteudo_w 	:=	lpad(nr_seq_linha_w,8,'0') ||
				'201' || 
				r_C01_w.cd_unimed_origem || 
				r_C01_w.dt_geracao || 
				r_C01_w.ie_tipo_carga || 
				r_C01_w.ie_tipo_informacao || 
				r_C01_w.nr_versao_transacao;
	ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;
	
	insert	into w_ptu_envio_arq(ds_conteudo,
		dt_atualizacao, 
		nm_usuario,
		nr_seq_apres, 
		nr_sequencia)
	values (ds_conteudo_w, 
		clock_timestamp(), 
		nm_usuario_p,
		nr_seq_linha_w, 
		nextval('w_ptu_envio_arq_seq'));
		
	-- R202 ? PACOTE (OBRIGAT?RIO)
	for r_C02_w in C02(r_C01_w.nr_sequencia) loop
		qt_tot_202_w	:=	qt_tot_202_w + 1;
		nr_seq_linha_w	:=	nr_seq_linha_w + 1;
		ds_conteudo_w 	:=	lpad(nr_seq_linha_w,8,'0') ||
					'202' || 
					r_C02_w.cd_pacote || 
					r_C02_w.nm_pacote || 
					r_C02_w.cd_unimed_prestador || 
					r_C02_w.cd_prestador || 
					r_C02_w.nm_prestador || 
					r_C02_w.dt_negociacao || 
					r_C02_w.dt_publicacao ||
					r_C02_w.ie_tipo_acomodacao ||
					r_C02_w.ie_tipo_pacote ||
					r_C02_w.cd_especialidade ||
					r_C02_w.dt_inicio_vigencia ||
					r_C02_w.dt_fim_vigencia ||
					r_C02_w.ie_tipo_internacao ||
					r_C02_w.vl_tot_taxas ||
					r_C02_w.vl_tot_diarias ||
					r_C02_w.vl_tot_gases ||
					r_C02_w.vl_tot_mat ||
					r_C02_w.vl_tot_med ||
					r_C02_w.vl_tot_proc ||
					r_C02_w.vl_tot_opme ||
					r_C02_w.vl_tot_pacote ||
					r_C02_w.ie_honorario ||
					r_C02_w.tipo_rede_min ||
					r_C02_w.versao_pacote||
					r_c02_w.ie_opme||
					r_c02_w.ie_anestesista||
					r_c02_w.ie_auxiliar;
		ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;
		
		insert	into w_ptu_envio_arq(ds_conteudo,
			dt_atualizacao, 
			nm_usuario,
			nr_seq_apres, 
			nr_sequencia)
		values (ds_conteudo_w, 
			clock_timestamp(), 
			nm_usuario_p,
			nr_seq_linha_w, 
			nextval('w_ptu_envio_arq_seq'));
			
		-- R203 ? OBSERVA??O (OPCIONAL)
		if ((trim(both r_C02_w.ds_observacao) IS NOT NULL AND (trim(both r_C02_w.ds_observacao))::text <> '')) then
			qt_tot_203_w	:=	qt_tot_203_w + 1;
			nr_seq_linha_w	:=	nr_seq_linha_w + 1;
			ds_conteudo_w 	:=	lpad(nr_seq_linha_w,8,'0') ||
						'203' || 
						r_C02_w.cd_pacote || 
						r_C02_w.ds_observacao;
			ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;
						
			
			insert	into w_ptu_envio_arq(ds_conteudo,
				dt_atualizacao, 
				nm_usuario,
				nr_seq_apres, 
				nr_sequencia)
			values (ds_conteudo_w, 
				clock_timestamp(), 
				nm_usuario_p,
				nr_seq_linha_w, 
				nextval('w_ptu_envio_arq_seq'));
		end if;
			
		-- R204 ? SERVI?O - PACOTE (OBRIGAT?RIO)
		for r_C03_w in C03(r_C02_w.nr_sequencia) loop
			qt_tot_204_w	:=	qt_tot_204_w + 1;
			nr_seq_linha_w	:=	nr_seq_linha_w + 1;
			ds_conteudo_w 	:=	lpad(nr_seq_linha_w,8,'0') ||
						'204' || 
						r_C03_w.ie_tipo_item || 
						r_C03_w.ie_tipo_tabela || 
						r_C03_w.cd_servico || 
						r_C03_w.ie_principal || 
						'  ' ||
						r_C03_w.qt_servico || 
						r_C03_w.vl_servico ||
						r_C03_w.ds_servico ||
						r_C03_w.vl_serv_total ||
						r_C03_w.cd_unidade_medida;
			ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;
						
			insert	into w_ptu_envio_arq(ds_conteudo,
				dt_atualizacao, 
				nm_usuario,
				nr_seq_apres, 
				nr_sequencia)
			values (ds_conteudo_w, 
				clock_timestamp(), 
				nm_usuario_p,
				nr_seq_linha_w, 
				nextval('w_ptu_envio_arq_seq'));
		end loop;
		
		-- R205 ? PRESTADOR (OBRIGAT?RIO)
		for r_C205_w in C205(r_C02_w.nr_sequencia) loop
			qt_tot_205_w	:=	qt_tot_205_w + 1;
			nr_seq_linha_w	:=	nr_seq_linha_w + 1;
			ds_conteudo_w 	:=	lpad(nr_seq_linha_w,8,'0') ||
						'205' || 
						r_C205_w.cd_unimed_prestador || 
						r_C205_w.cd_prestador || 
						r_C205_w.nm_prestador || 
						r_C205_w.cd_cgc_cpf || 
						r_C205_w.cd_cnes_prest ||
						r_C205_w.id_reajuste||
						r_C205_w.id_anexo_reajuste;
						
			ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;
						
			insert	into w_ptu_envio_arq(ds_conteudo,
				dt_atualizacao, 
				nm_usuario,
				nr_seq_apres, 
				nr_sequencia)
			values (ds_conteudo_w, 
				clock_timestamp(), 
				nm_usuario_p,
				nr_seq_linha_w, 
				nextval('w_ptu_envio_arq_seq'));
		end loop;
	
	end loop;	
	
end loop;

-- R215 ? TRAILER (OBRIGAT?RIO)
nr_seq_linha_w	:=	nr_seq_linha_w + 1;
ds_conteudo_w 	:=	lpad(nr_seq_linha_w,8,'0') ||
			'215' || 
			lpad(to_char(qt_tot_202_w),5,'0') || 
			lpad(to_char(qt_tot_203_w),5,'0') || 
			lpad(to_char(qt_tot_204_w),5,'0') || 
			lpad(' ',5,' ') || -- QT_TOT_R210 
			lpad(' ',5,' ') || -- QT_TOT_R211
			lpad(to_char(qt_tot_205_w),5,'0');
ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;
			
insert	into w_ptu_envio_arq(ds_conteudo,
	dt_atualizacao, 
	nm_usuario,
	nr_seq_apres, 
	nr_sequencia)
values (ds_conteudo_w, 
	clock_timestamp(), 
	nm_usuario_p,
	nr_seq_linha_w, 
	nextval('w_ptu_envio_arq_seq'));
	
-- HASH (OBRIGAT?RIO)
nr_seq_linha_w	:=	nr_seq_linha_w + 1;
ds_arquivo_w := pls_hash_ptu_pck.obter_hash_txt(ds_arquivo_w); -- Gerar HASH
ds_conteudo_w 	:= 	lpad(nr_seq_linha_w,8,'0') ||
			'998' ||
			ds_hash_w;
			
insert	into w_ptu_envio_arq(ds_conteudo,
	dt_atualizacao, 
	nm_usuario,
	nr_seq_apres, 
	nr_sequencia)
values (ds_conteudo_w, 
	clock_timestamp(), 
	nm_usuario_p,
	nr_seq_linha_w, 
	nextval('w_ptu_envio_arq_seq'));
	
update	ptu_pacote
set	ds_hash		= ds_hash_w
where	nr_sequencia	= nr_seq_pacote_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_gerar_a1200_11_3 ( nr_seq_pacote_p ptu_pacote.nr_sequencia%type, cd_interface_p interface.cd_interface%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

