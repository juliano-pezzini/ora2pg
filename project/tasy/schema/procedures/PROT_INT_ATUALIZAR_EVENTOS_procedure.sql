-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE prot_int_atualizar_eventos ( nr_seq_protocolo_int_pac_p protocolo_int_paciente.nr_sequencia%TYPE ) AS $body$
DECLARE


dt_inicial_previsto_etapa_w protocolo_int_pac_etapa.dt_inicial_previsto%TYPE;
nr_dia_real_w protocolo_int_pac_evento.nr_dia_real%TYPE;
nr_dias_atraso_w protocolo_int_pac_evento.nr_dias_atraso%TYPE;
dt_prevista_evento_w protocolo_int_pac_evento.dt_prevista%type;

C01 CURSOR FOR
SELECT
evento.nr_sequencia,
evento.nr_dia_previsto,
evento.dt_real AS dt_real_evento,
evento.nr_dia_protocolo,
evento.dt_prevista,
etapa.dt_inicial_previsto AS dt_inicial_etapa,
protocolo.dt_inicial_previsto AS dt_inicial_prev_protoc
FROM 
protocolo_int_pac_evento evento,
protocolo_int_pac_etapa etapa,
protocolo_int_paciente protocolo
WHERE
evento.nr_seq_prt_int_pac_etapa = etapa.nr_sequencia
AND protocolo.nr_sequencia = etapa.nr_seq_protocolo_int_pac
AND etapa.nr_seq_protocolo_int_pac = nr_seq_protocolo_int_pac_p;

BEGIN

IF (nr_seq_protocolo_int_pac_p IS NOT NULL AND nr_seq_protocolo_int_pac_p::text <> '') THEN

FOR evento IN C01 LOOP BEGIN
    nr_dia_real_w := null;
    nr_dias_atraso_w := null;

    if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'ja_JP') then

      IF (evento.dt_real_evento IS NOT NULL AND evento.dt_real_evento::text <> '') THEN
        nr_dia_real_w := trunc(evento.dt_real_evento,'dd') - trunc(evento.dt_inicial_prev_protoc,'dd') + 1;
        nr_dias_atraso_w := nr_dia_real_w - evento.nr_dia_protocolo;
      END IF;

      dt_prevista_evento_w := ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(evento.dt_inicial_prev_protoc + coalesce(evento.nr_dia_protocolo,1) - 1) + 12/24;

    else

      IF (evento.dt_real_evento IS NOT NULL AND evento.dt_real_evento::text <> '') THEN
        nr_dia_real_w := evento.dt_real_evento - evento.dt_inicial_etapa + 1;
        nr_dias_atraso_w := nr_dia_real_w - evento.nr_dia_previsto;
      END IF;

      dt_prevista_evento_w := ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(evento.dt_inicial_etapa + coalesce(evento.nr_dia_previsto,1) - 1) + 12/24;

    end if;

    UPDATE protocolo_int_pac_evento
    SET
        dt_prevista = dt_prevista_evento_w,
        nr_dia_real = nr_dia_real_w,
        nr_dias_atraso = nr_dias_atraso_w
    WHERE nr_sequencia = evento.nr_sequencia;
END; END LOOP;

END IF;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE prot_int_atualizar_eventos ( nr_seq_protocolo_int_pac_p protocolo_int_paciente.nr_sequencia%TYPE ) FROM PUBLIC;

