-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gravar_log_acesso_portal ( nr_seq_segurado_p bigint, nr_seq_usu_estipulante_p bigint, nr_seq_usu_prestador_p bigint, nr_seq_subestipulante_p bigint, nr_seq_grupo_contrato_p bigint, cd_pessoa_fisica_p text, nm_usuario_proposta_adesao_p text, nm_usuario_rede_propria_p text, ie_tipo_historico_p text, ds_observacao_p text, ds_acao_p text, ie_login_p text) AS $body$
DECLARE


nm_usuario_w            	varchar(15);
ie_tipo_acesso_w        	varchar(2);
nm_usuario_rede_propria_w	varchar(255);
nr_seq_perfil_web_w		bigint;


BEGIN

nm_usuario_rede_propria_w := nm_usuario_rede_propria_p;

if (nm_usuario_rede_propria_p = 'GUIA_MEDICO') then
	nm_usuario_w := nm_usuario_rede_propria_p;
	nm_usuario_rede_propria_w := null;
	ie_tipo_acesso_w := 'GM';
elsif (nm_usuario_rede_propria_p = 'SIMULADOR_PRECO') then
	nm_usuario_w := nm_usuario_rede_propria_p;
	nm_usuario_rede_propria_w := null;
	ie_tipo_acesso_w := 'SP';
elsif (nr_seq_segurado_p IS NOT NULL AND nr_seq_segurado_p::text <> '') then
        nm_usuario_w := to_char(nr_seq_segurado_p);
        ie_tipo_acesso_w := 'B';
elsif (nr_seq_usu_estipulante_p IS NOT NULL AND nr_seq_usu_estipulante_p::text <> '') then
        nm_usuario_w := to_char(nr_seq_usu_estipulante_p);
        ie_tipo_acesso_w := 'E';
elsif (nr_seq_usu_prestador_p IS NOT NULL AND nr_seq_usu_prestador_p::text <> '') then
        nm_usuario_w := to_char(nr_seq_usu_prestador_p);
        ie_tipo_acesso_w := 'P';

	select	max(nr_seq_perfil_web)
	into STRICT	nr_seq_perfil_web_w
	from	pls_usuario_web
	where	nr_sequencia = nr_seq_usu_prestador_p;
elsif (nm_usuario_rede_propria_p IS NOT NULL AND nm_usuario_rede_propria_p::text <> '') then
        nm_usuario_w := to_char(nm_usuario_rede_propria_p);
        ie_tipo_acesso_w := 'R';
elsif (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
        nm_usuario_w := cd_pessoa_fisica_p;
        ie_tipo_acesso_w := 'D';
elsif (nm_usuario_proposta_adesao_p IS NOT NULL AND nm_usuario_proposta_adesao_p::text <> '') then
        nm_usuario_w := nm_usuario_proposta_adesao_p;
        ie_tipo_acesso_w := 'PA';
elsif (nr_seq_grupo_contrato_p IS NOT NULL AND nr_seq_grupo_contrato_p::text <> '') then
	nm_usuario_w := to_char(nr_seq_grupo_contrato_p);
        ie_tipo_acesso_w := 'GC';

	select	max(nr_seq_perfil_web)
	into STRICT	nr_seq_perfil_web_w
	from	pls_grupo_contrato_web
	where	nr_sequencia = nr_seq_grupo_contrato_p;
end if;

insert into pls_acesso_portal_log(
        nr_sequencia,
        nr_seq_segurado,
        nr_seq_usu_estipulante,
        nr_seq_usu_prestador,
        nm_usuario_rede_propria,
        ds_acao,
        ie_login,
        dt_atualizacao,
        nm_usuario,
        ie_tipo_acesso,
        nr_seq_subestipulante,
        cd_pessoa_fisica,
        nm_usuario_proposta_adesao,
        ie_tipo_historico,
        ds_observacao,
	nr_seq_grupo_contrato,
	nr_seq_perfil_web
) values (
        nextval('pls_acesso_portal_log_seq'),
        nr_seq_segurado_p,
        nr_seq_usu_estipulante_p,
        nr_seq_usu_prestador_p,
        nm_usuario_rede_propria_w,
        ds_acao_p,
        ie_login_p,
        clock_timestamp(),
        nm_usuario_w,
        ie_tipo_acesso_w,
        nr_seq_subestipulante_p,
        cd_pessoa_fisica_p,
        nm_usuario_proposta_adesao_p,
        ie_tipo_historico_p,
        ds_observacao_p,
	nr_seq_grupo_contrato_p,
	nr_seq_perfil_web_w );

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gravar_log_acesso_portal ( nr_seq_segurado_p bigint, nr_seq_usu_estipulante_p bigint, nr_seq_usu_prestador_p bigint, nr_seq_subestipulante_p bigint, nr_seq_grupo_contrato_p bigint, cd_pessoa_fisica_p text, nm_usuario_proposta_adesao_p text, nm_usuario_rede_propria_p text, ie_tipo_historico_p text, ds_observacao_p text, ds_acao_p text, ie_login_p text) FROM PUBLIC;

