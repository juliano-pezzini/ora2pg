-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_consiste_util_medic ( nr_atendimento_p bigint, cd_material_p bigint, dt_inicio_cpoe_p timestamp, qt_dias_util_medic_p INOUT bigint, qt_dias_liberado_p INOUT bigint, qt_dias_lib_atend_p INOUT bigint) AS $body$
DECLARE

 
cd_material_generico_w		integer;
ie_dias_util_medic_w		varchar(1);
ie_data_antimicrobiano_w 	varchar(1);
ie_conta_liberados_w		varchar(1);
ie_dias_validade_w			varchar(1);
ie_controle_medico_w		smallint;
qt_dias_util_medic_w		bigint := -1;
nr_dia_util_w				bigint;
qt_dias_Liberado_w			integer;
qt_dia_liberado_w			bigint := 0;
qt_dia_liberado_ww			bigint;
qt_Notificacao_w			integer;
dt_anterior_w				timestamp;
dt_dia_parametro_w			timestamp;
dt_validade_fim_w			timestamp;
dt_validade_ini_w			timestamp;
qt_dias_sem_antibiotico_w	smallint;
cd_estabelecimento_w		smallint;
qt_dias_lib_atend_w			bigint;
nr_seq_ficha_tecnica_w		bigint;
ie_consiste_medic_ficha_w  varchar(10);
cd_pessoa_fisica_w			varchar(50);
ie_atb_pessoa_w				varchar(10);
ie_considera_rep_hoje_w		varchar(1);
ie_somar_dias_atb_w			varchar(1);
qt_dia_max_util_w			smallint;
qt_dia_interv_profilaxia_w	bigint;
ie_objetivo_w				varchar(1);
qt_material_w				bigint;
dt_liberacao_prescr_w 		timestamp;


BEGIN 
 
qt_dias_util_Medic_w	:= 0;
qt_dias_Liberado_w		:= 0;
qt_dias_lib_atend_w		:= 0;
 
select	coalesce(max(qt_total_dias_lib),0), 
		max(ie_objetivo) 
into STRICT	qt_dia_liberado_w, 
		ie_objetivo_w 
from	cpoe_material 
where	nr_atendimento = nr_atendimento_p 
and		cd_material = cd_material_p 
and		coalesce(dt_liberacao::text, '') = '';
 
select	max(cd_estabelecimento), 
		max(cd_pessoa_fisica) 
into STRICT	cd_estabelecimento_w, 
		cd_pessoa_fisica_w 
from	atendimento_paciente 
where	nr_atendimento	= nr_atendimento_p;
 
select	coalesce(max(qt_dias_antibiotico),1), 
		coalesce(max(ie_consiste_medic_ficha),'N'), 
		coalesce(max(ie_data_antimicrobiano),'M'), 
		coalesce(max(ie_atb_pessoa),'N'), 
		coalesce(max(ie_considera_rep_hoje),'N'), 
		coalesce(max(ie_somar_dias_atb),'N'), 
		coalesce(max(ie_conta_liberados),'S'), 
		coalesce(max(ie_dias_validade),'S')	 
into STRICT	qt_dias_sem_antibiotico_w, 
		ie_consiste_medic_ficha_w, 
		ie_data_antimicrobiano_w, 
		ie_atb_pessoa_w, 
		ie_considera_rep_hoje_w, 
		ie_somar_dias_atb_w, 
		ie_conta_liberados_w, 
		ie_dias_validade_w 
from	parametro_medico 
where	cd_estabelecimento	= cd_estabelecimento_w;
 
select	coalesce(max(cd_material_generico), max(cd_material)), 
		coalesce(max(ie_dias_util_medic),'N'), 
		coalesce(max(obter_controle_medic(cd_material,wheb_usuario_pck.get_cd_estabelecimento,ie_controle_medico,null,null,null)),0), 
		coalesce(max(nr_seq_ficha_tecnica),0), 
		coalesce(max(qt_max_dia_aplic),100), 
		coalesce(max(qt_dia_interv_profilaxia),0) 
into STRICT	cd_material_generico_w, 
		ie_dias_util_medic_w, 
		ie_controle_medico_w, 
		nr_seq_ficha_tecnica_w, 
		qt_dia_max_util_w, 
		qt_dia_interv_profilaxia_w 
from	material 
where	cd_material	= cd_material_P;
 
dt_validade_ini_w	:= trunc(dt_inicio_cpoe_p,'dd') - qt_dia_max_util_w;
dt_validade_fim_w	:= dt_inicio_cpoe_p + 36/24;
 
if (ie_consiste_medic_ficha_w	= 'N') then 
	nr_seq_ficha_tecnica_w	:= 0;
end if;
 
/*  Indica que o sistema var retornar o numero de dias da utilização do med */
 
if (ie_dias_util_medic_w = 'S') or (ie_dias_util_medic_w = 'O') or (ie_controle_medico_w = 2) then 
	begin 
	if (ie_considera_rep_hoje_w = 'N') then 
		dt_anterior_w			:= (trunc(dt_inicio_cpoe_p,'dd') - 1) + 86399/86400;
	else 
		dt_anterior_w			:= (trunc(dt_inicio_cpoe_p,'dd')) + 86399/86400;
	end if;
 
	if (ie_conta_liberados_w = 'S') then 
		qt_dia_liberado_ww := (qt_dia_liberado_w + coalesce(qt_dias_sem_antibiotico_w,0));
	else 
		qt_dia_liberado_ww := coalesce(qt_dias_sem_antibiotico_w,0);
	end if;
 
	if (ie_objetivo_w	in ('F','P','C')) and (coalesce(qt_dia_interv_profilaxia_w,0)	> 0) then 
		qt_dia_liberado_ww := qt_dia_interv_profilaxia_w;	
	end if;	
 
	dt_dia_parametro_w		:= trunc(dt_inicio_cpoe_p,'dd') - qt_dia_liberado_ww;
 
	if (ie_atb_pessoa_w = 'N') then 
		begin 
		select	max(a.nr_dia_util), 
				coalesce(max(a.qt_total_dias_lib),0) 
		into STRICT	qt_dias_util_Medic_w, 
				qt_dias_lib_atend_w 
		from 	prescr_material a, 
				prescr_medica b 
		where 	a.nr_prescricao	= b.nr_prescricao 
		and		a.ie_suspenso	<> 'S' 
		and		a.cd_material in (	SELECT	cd_material_generico_w 
									 
									
union
 
									SELECT	cd_material_p 
									 
									
union
 
									select	cd_material 
									from 	material 
									where 	cd_material_generico	= cd_material_generico_w 
									
union
 
									select	cd_material 
									from	material 
									where	nr_seq_ficha_tecnica	= nr_seq_ficha_tecnica_w) 
		and		((b.dt_validade_prescr <> dt_validade_fim_w) or (coalesce(ie_dias_validade_w,'S') = 'S')) 
		and		((b.dt_inicio_prescr between dt_dia_parametro_w and dt_anterior_w) or (b.dt_prescricao between dt_dia_parametro_w and dt_anterior_w)) 
		and		(((ie_data_antimicrobiano_w = 'M') and ((coalesce(b.dt_liberacao_medico, b.dt_liberacao) IS NOT NULL AND (coalesce(b.dt_liberacao_medico, b.dt_liberacao))::text <> ''))) or 
				 (ie_data_antimicrobiano_w = 'E' AND b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')) 
		and   coalesce(ie_ciclo_reprov,'N') = 'N'		 
		and		b.nr_atendimento	= nr_atendimento_p;
		 
		if (ie_somar_dias_atb_w = 'S') then 
			select	coalesce(sum(a.qt_dias_liberado),qt_dias_lib_atend_w) 
			into STRICT	qt_dias_lib_atend_w 
			from 	prescr_material a, 
					prescr_medica b 
			where 	a.nr_prescricao	= b.nr_prescricao 
			and		a.ie_suspenso	<> 'S' 
			and		(a.qt_dias_liberado IS NOT NULL AND a.qt_dias_liberado::text <> '') 
			and		(((ie_data_antimicrobiano_w = 'M') and ((coalesce(b.dt_liberacao_medico, b.dt_liberacao) IS NOT NULL AND (coalesce(b.dt_liberacao_medico, b.dt_liberacao))::text <> ''))) or 
					 (ie_data_antimicrobiano_w = 'E' AND b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')) 
			and		a.cd_material in (	SELECT	cd_material_generico_w 
										 
										
union
 
										SELECT	cd_material_p 
										 
										
union
 
										select	cd_material 
										from 	material 
										where 	cd_material_generico	= cd_material_generico_w 
										
union
 
										select	cd_material 
										from	material 
										where	nr_seq_ficha_tecnica	= nr_seq_ficha_tecnica_w) 
			and		((b.dt_inicio_prescr between dt_dia_parametro_w and dt_anterior_w) or (b.dt_prescricao between dt_dia_parametro_w and dt_anterior_w)) 
			and   coalesce(ie_ciclo_reprov,'N') = 'N'	 
			and		b.nr_atendimento	= nr_atendimento_p;
		 
		end if;
 
		exception 
			when others then 
				qt_dias_util_Medic_w	:= 0;
		end;
	else 
		begin 
		select	max(a.nr_dia_util), 
				coalesce(max(a.qt_total_dias_lib),0) 
		into STRICT	qt_dias_util_Medic_w, 
				qt_dias_lib_atend_w 
		from 	prescr_material a, 
				prescr_medica b 
		where a.nr_prescricao	= b.nr_prescricao 
		 and b.cd_pessoa_fisica	= cd_pessoa_fisica_w 
		 and a.ie_suspenso	<> 'S' 
		 and   coalesce(ie_ciclo_reprov,'N') = 'N'	 
		 and	((b.dt_validade_prescr <> dt_validade_fim_w) or (coalesce(ie_dias_validade_w,'S') = 'S')) 
		 and 	((b.dt_inicio_prescr between dt_dia_parametro_w and dt_anterior_w) or (b.dt_prescricao between dt_dia_parametro_w and dt_anterior_w)) 
		 and	(((ie_data_antimicrobiano_w = 'M') and ((coalesce(b.dt_liberacao_medico, b.dt_liberacao) IS NOT NULL AND (coalesce(b.dt_liberacao_medico, b.dt_liberacao))::text <> ''))) or 
				 (ie_data_antimicrobiano_w = 'E' AND b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')) 
		 and a.cd_material	in (	SELECT	cd_material_generico_w 
						 
						
union
 
						SELECT	cd_material_p 
						 
						
union
 
						select	cd_material 
						from 	material 
						where 	cd_material_generico	= cd_material_generico_w 
						
union
 
						select	cd_material 
						from	material 
						where	nr_seq_ficha_tecnica	= nr_seq_ficha_tecnica_w);
						 
		if (ie_somar_dias_atb_w = 'S') then 
			select	coalesce(max(a.qt_dias_liberado),qt_dias_lib_atend_w) 
			into STRICT	qt_dias_lib_atend_w 
			from 	prescr_material a, 
					prescr_medica b 
			where a.nr_prescricao	= b.nr_prescricao 
			 and b.cd_pessoa_fisica	= cd_pessoa_fisica_w 
			 and a.ie_suspenso	<> 'S' 
			 and coalesce(ie_ciclo_reprov,'N') = 'N'	 
			 and	(a.qt_dias_liberado IS NOT NULL AND a.qt_dias_liberado::text <> '') 
			 and 	((b.dt_inicio_prescr between dt_dia_parametro_w and dt_anterior_w) or (b.dt_prescricao between dt_dia_parametro_w and dt_anterior_w)) 
			 and	(((ie_data_antimicrobiano_w = 'M') and ((coalesce(b.dt_liberacao_medico, b.dt_liberacao) IS NOT NULL AND (coalesce(b.dt_liberacao_medico, b.dt_liberacao))::text <> ''))) or 
					 (ie_data_antimicrobiano_w = 'E' AND b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')) 
			 and a.cd_material	in (	SELECT	cd_material_generico_w 
							 
							
union
 
							SELECT	cd_material_p 
							 
							
union
 
							select	cd_material 
							from 	material 
							where 	cd_material_generico	= cd_material_generico_w 
							
union
 
							select	cd_material 
							from	material 
							where	nr_seq_ficha_tecnica	= nr_seq_ficha_tecnica_w);
		end if;
		 
		exception 
			when others then 
				qt_dias_util_Medic_w	:= 0;
		end;
	end if;
	 
	if (coalesce(qt_dias_util_Medic_w::text, '') = '') and (ie_dias_util_medic_w = 'O')then 
		qt_dias_util_medic_w	:= 0;
	elsif (coalesce(qt_dias_util_Medic_w::text, '') = '') and (ie_dias_util_medic_w = 'S')then 
		qt_dias_util_medic_w	:= 1;
	else	 
		select coalesce(max(b.nr_dia_util),0) 
		into STRICT  nr_dia_util_w 
		from  prescr_medica a, 
			 prescr_material b 
		where a.nr_atendimento = nr_atendimento_p 
		and	 b.nr_prescricao = a.nr_prescricao 
		and  b.cd_material in ( SELECT cd_material_generico_w 
										 
										
union
 
										SELECT	cd_material_p 
										 
										
union
 
										select	cd_material 
										from 	material 
										where 	cd_material_generico	= cd_material_generico_w 
										
union
 
										select	cd_material 
										from	material 
										where	nr_seq_ficha_tecnica	= nr_seq_ficha_tecnica_w) 
		and coalesce(b.ie_ciclo_reprov,'N') = 'N'	 
		and	 coalesce(b.ie_suspenso,'N') <> 'S' 
		and dt_validade_prescr = dt_validade_fim_w;
 
		if (nr_dia_util_w <> 0) then 
			qt_dias_util_medic_w 	:= nr_dia_util_w;
		else 
			if (coalesce(dt_liberacao_prescr_w::text, '') = '') then 
				qt_dias_util_medic_w	:= qt_dias_util_medic_w + 1;
			end if;
		end if;	
	end if;
	end;
end if;
	 
/*  Indica que o médico deve Justificar a utilização do Mesmo DOOONEEE */
 
if (ie_controle_medico_w = 1) then 
	begin 
	if (ie_atb_pessoa_w = 'N') then 
		begin 
		select count(*) 
		into STRICT	qt_Notificacao_w 
		from 	prescr_material a, 
				prescr_medica b 
		where a.nr_prescricao	= b.nr_prescricao 
		 and b.nr_atendimento	= nr_atendimento_p 
		 and a.ie_suspenso	<> 'S'	 
		 and coalesce(ie_ciclo_reprov,'N') = 'N'	 
		 and 	((b.dt_inicio_prescr between dt_dia_parametro_w and dt_anterior_w) or (b.dt_prescricao between dt_dia_parametro_w and dt_anterior_w)) 
		/*	 and a.ds_justificativa is not null */
 
		 and a.cd_material	in (	SELECT	cd_material_generico_w 
						 
						
union
 
						SELECT	cd_material_p 
						 
						
union
 
						select	cd_material 
						from 	material 
						where 	cd_material_generico	= cd_material_generico_w 
						
union
 
						select	cd_material 
						from	material 
						where	nr_seq_ficha_tecnica	= nr_seq_ficha_tecnica_w);
		exception 
			when others then 
				qt_Notificacao_w		:= 0;
		end;
	else 
		begin 
		select count(*) 
		into STRICT	qt_Notificacao_w 
		from 	prescr_material a, 
			prescr_medica b 
		where a.nr_prescricao	= b.nr_prescricao 
		 and b.cd_pessoa_fisica	= cd_pessoa_fisica_w 
		 and   coalesce(ie_ciclo_reprov,'N') = 'N'	 
		 and a.ie_suspenso	<> 'S' 
		  and 	((b.dt_inicio_prescr between dt_dia_parametro_w and dt_anterior_w) or (b.dt_prescricao between dt_dia_parametro_w and dt_anterior_w)) 
		/*	 and a.ds_justificativa is not null */
 
		 and a.cd_material	in (	SELECT	cd_material_generico_w 
						 
						
union
 
						SELECT	cd_material_p 
						 
						
union
 
						select	cd_material 
						from 	material 
						where 	cd_material_generico	= cd_material_generico_w 
						
union
 
						select	cd_material 
						from	material 
						where	nr_seq_ficha_tecnica	= nr_seq_ficha_tecnica_w);
		exception 
			when others then 
				qt_Notificacao_w		:= 0;
		end;
	end if;
	 
	if (qt_Notificacao_w	> 0) then 
		ie_controle_medico_w		:= 0;
	end if;
	end;
end if;
 
/*  Indica que o médico deve Justificar a utilização do Mesmo DOOONEEE*/
 
if (ie_atb_pessoa_w = 'N') then 
	begin 
	select	coalesce(sum(qt_dias_liberado),0) 
	into STRICT	qt_dias_liberado_w 
	from 	prescr_material a, 
			prescr_medica b 
	where 	a.nr_prescricao	= b.nr_prescricao 
	and   coalesce(ie_ciclo_reprov,'N') = 'N'	 
	and		a.ie_suspenso	<> 'S' 
	and		((ie_data_antimicrobiano_w = 'M' AND b.dt_liberacao_medico IS NOT NULL AND b.dt_liberacao_medico::text <> '') or 
			 (ie_data_antimicrobiano_w = 'E' AND b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')) 
	and		a.cd_material in (	SELECT	cd_material_generico_w 
								 
								
union
 
								SELECT	cd_material_p 
								 
								
union
 
								select	cd_material 
								from 	material 
								where 	cd_material_generico	= cd_material_generico_w 
								
union
 
								select	cd_material 
								from	material 
								where	nr_seq_ficha_tecnica	= nr_seq_ficha_tecnica_w) 
	and		b.dt_inicio_prescr between dt_validade_ini_w and dt_validade_fim_w 
	and		b.nr_atendimento	= nr_atendimento_p;
	exception 
		when others then 
			qt_dias_liberado_w	:= 0;
	end;
else 
	begin 
	select	coalesce(sum(qt_dias_liberado),0) 
	into STRICT	qt_dias_liberado_w 
	from 	prescr_material a, 
			prescr_medica b 
	where	a.nr_prescricao		= b.nr_prescricao 
	and   coalesce(ie_ciclo_reprov,'N') = 'N'	 
	and		a.ie_suspenso	<> 'S' 
	and		((ie_data_antimicrobiano_w = 'M' AND b.dt_liberacao_medico IS NOT NULL AND b.dt_liberacao_medico::text <> '') or 
			 (ie_data_antimicrobiano_w = 'E' AND b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')) 
	and		a.cd_material in (	SELECT	cd_material_generico_w 
								 
								
union
 
								SELECT	cd_material_p 
								 
								
union
 
								select	cd_material 
								from 	material 
								where 	cd_material_generico	= cd_material_generico_w 
								
union
 
								select	cd_material 
								from	material 
								where	nr_seq_ficha_tecnica	= nr_seq_ficha_tecnica_w) 
	and		b.dt_inicio_prescr between dt_validade_ini_w and dt_validade_fim_w 
	and		b.cd_pessoa_fisica	= cd_pessoa_fisica_w;
	exception 
		when others then 
			qt_dias_liberado_w	:= 0;
	end;
end if;
 
if (ie_dias_util_medic_w = 'O') and (qt_dias_liberado_w > 0) then 
	qt_dias_liberado_w	:= qt_dias_liberado_w - 1;
end if;
 
/*  O numero de dias de utilização ultrapassou o liberado */
 
if (ie_controle_medico_w <> 0) and (qt_dias_lib_atend_w > 0) and 
	((ie_dias_util_medic_w = 'O' AND qt_dias_util_medic_w = qt_dias_lib_atend_w) or 
	 ((ie_dias_util_medic_w = 'S') and (qt_dias_util_medic_w > qt_dias_lib_atend_w) and ((qt_dias_util_medic_w - qt_dias_lib_atend_w) < 2))) then 
	ie_controle_medico_w		:= 9;
	if (ie_dias_util_medic_w = 'O') then 
		qt_dias_liberado_w	:= qt_dias_lib_atend_w - 1;
	end if;
end if;
 
/*  O Medicamento está liberado */
 
if (ie_controle_medico_w <> 9) and (qt_dias_util_medic_w	<= qt_dias_liberado_w) and (qt_dias_liberado_w 	> 0) then 
	ie_controle_medico_w		:= 0;
end if;
 
/* Indica se medicamento exige uma avaliação */
 
 
if (ie_controle_medico_w = 3) then 
	ie_controle_medico_w := 3;
end if;
 
--ie_controle_medico_p		:= ie_controle_medico_w; 
qt_dias_util_medic_p		:= qt_dias_util_medic_w;
qt_dias_liberado_p			:= qt_dias_liberado_w;
qt_dias_lib_atend_p			:= qt_dias_lib_atend_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_consiste_util_medic ( nr_atendimento_p bigint, cd_material_p bigint, dt_inicio_cpoe_p timestamp, qt_dias_util_medic_p INOUT bigint, qt_dias_liberado_p INOUT bigint, qt_dias_lib_atend_p INOUT bigint) FROM PUBLIC;

