-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE phi_gerar_analise_eficacia ( nm_usuario_p qms_treinamento.nm_usuario%type, cd_gerente_p qms_treinamento.cd_gerente_pessoa%type, cd_pessoa_eficacia_p qms_treinamento.cd_pessoa_fisica%type, cd_cargo_p qms_treinamento_cargo.nr_seq_cargo%type) AS $body$
DECLARE

	
	ds_macro_w		varchar(255);
	nm_pessoa_fisica_w	varchar(255);
	
	cd_gerente_w		qms_treinamento.cd_gerente_pessoa%type;
	cd_pessoa_eficacia_w	qms_treinamento.cd_pessoa_fisica%type;
	ds_analise_eficacia_w	qms_treinamento.ds_motivo%type;
	
	nr_seq_documento_w	qms_treinamento_cargo.nr_seq_documento%type;
	ds_treinamento_w	qms_treinamento_cargo.ds_treinamento%type;
	nr_seq_classificacao_w	qms_treinamento_cargo.nr_seq_classificacao%type;
	nr_seq_plataforma_w	qms_treinamento_cargo.nr_seq_plataforma%type;


BEGIN
	
	select	max(pf.cd_pessoa_fisica)
	into STRICT	cd_gerente_w
	from	pessoa_fisica pf
	where	pf.cd_pessoa_fisica = cd_gerente_p;
	
	select	max(pf.cd_pessoa_fisica)
	into STRICT	cd_pessoa_eficacia_w
	from	pessoa_fisica pf
	where	pf.cd_pessoa_fisica = cd_pessoa_eficacia_p;
	
	if (cd_gerente_w IS NOT NULL AND cd_gerente_w::text <> '' AND cd_pessoa_eficacia_w IS NOT NULL AND cd_pessoa_eficacia_w::text <> '') then
		begin
			begin
				select	a.nr_seq_documento,
					a.ds_treinamento,
					a.nr_seq_classificacao,
					a.nr_seq_plataforma
				into STRICT	nr_seq_documento_w,
					ds_treinamento_w,
					nr_seq_classificacao_w,
					nr_seq_plataforma_w
				from	qms_treinamento_cargo a
				where	a.nr_sequencia =	(
									SELECT	min(qtr.nr_sequencia)
									from	qms_treinamento_cargo qtr
									where	qtr.nr_seq_cargo = cd_cargo_p
									and	lower(coalesce(qtr.ds_treinamento, substr(qua_obter_nome_doc(qtr.nr_seq_documento),1,255))) like '%effectiveness%'
								);
			exception when others then
				nr_seq_documento_w	:= null;
				ds_treinamento_w	:= null;
				nr_seq_classificacao_w	:= null;
				nr_seq_plataforma_w	:= null;
			end;

			select	substr(upper(obter_nome_pf(cd_pessoa_eficacia_w)),1,255)
			into STRICT	nm_pessoa_fisica_w
			;
		
			ds_macro_w	:= 'NM_PESSOA_FISICA=' || nm_pessoa_fisica_w;
		
			select	obter_desc_exp_idioma(958649, 1, ds_macro_w)
			into STRICT	ds_analise_eficacia_w
			;
		
			/* CD_GERENTE_P passado 3 vezes, pois deve ser gerada a analise 
			de eficacia para o gerente, e nao para o usuario que confirmou o
			treinamento */
			insert
			into qms_treinamento(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					cd_pessoa_fisica,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_documento,
					nr_seq_classificacao,
					ie_necessario,
					cd_responsavel,
					ie_neces_eficacia,
					dt_liberacao,
					cd_gerente_pessoa,
					ds_motivo,
					ie_analise_eficacia,
					nr_seq_plataforma,
					ds_treinamento
				)
				values (
					nextval('qms_treinamento_seq'),
					clock_timestamp(),
					nm_usuario_p,
					cd_gerente_w,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_documento_w,
					nr_seq_classificacao_w,
					'S',
					cd_gerente_w,
					'S',
					clock_timestamp(),
					cd_gerente_w,
					ds_analise_eficacia_w,
					'S',
					nr_seq_plataforma_w,
					ds_treinamento_w
				);
			commit;
		end;
	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE phi_gerar_analise_eficacia ( nm_usuario_p qms_treinamento.nm_usuario%type, cd_gerente_p qms_treinamento.cd_gerente_pessoa%type, cd_pessoa_eficacia_p qms_treinamento.cd_pessoa_fisica%type, cd_cargo_p qms_treinamento_cargo.nr_seq_cargo%type) FROM PUBLIC;

