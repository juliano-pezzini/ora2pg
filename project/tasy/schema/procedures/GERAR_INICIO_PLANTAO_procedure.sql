-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_inicio_plantao (cd_medico_p text, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_plantao_p INOUT bigint) AS $body$
DECLARE


obter_se_medico		bigint;
cd_especialidade_w	bigint;
nr_seq_regra_w		regra_esp_repasse.nr_sequencia%type;
nr_seq_tipo_plantao_w	regra_esp_repasse.nr_seq_tipo_plantao%type;


BEGIN

	SELECT  COUNT(*)
	into STRICT	obter_se_medico
	FROM    medico
	WHERE   cd_pessoa_fisica = cd_medico_p;

if (obter_se_medico > 0) then
	begin

	select	coalesce(max(a.cd_especialidade),0)
	into STRICT 	cd_especialidade_w
	from	especialidade_medica b,
		medico_especialidade a
	where	a.cd_especialidade	= b.cd_especialidade
	and	a.cd_pessoa_fisica	= cd_medico_p
	and	a.nr_seq_prioridade =  (SELECT max(m.nr_seq_prioridade) from especialidade_medica n,
				      medico_especialidade m where n.cd_especialidade = m.cd_especialidade
				   and m.cd_pessoa_fisica = cd_medico_p)
	order	by a.dt_atualizacao LIMIT 1;

	select	max(a.nr_sequencia)
	into STRICT	nr_seq_regra_w
	from	regra_esp_repasse a
	where	a.cd_estabelecimento					= cd_estabelecimento_p
	and	ie_situacao = 'A'
	and	exists (	SELECT		1
			from		regra_esp_repasse_terc f,
					terceiro b
			where		b.nr_sequencia 		= f.nr_seq_terceiro
			and		b.cd_pessoa_fisica	= cd_medico_p
			and		f.nr_seq_regra_esp	= a.nr_sequencia
			
union

			SELECT		1
			from		regra_esp_repasse_terc c,
					terceiro d,
					terceiro_pessoa_fisica e
			where		e.nr_seq_terceiro	= d.nr_sequencia
			and		d.nr_sequencia		= c.nr_seq_terceiro
			and		e.cd_pessoa_fisica	= cd_medico_p
			and		c.nr_seq_regra_esp	= a.nr_sequencia);

	if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then
		begin
		select	a.nr_seq_tipo_plantao
		into STRICT	nr_seq_tipo_plantao_w
		from	regra_esp_repasse a
		where	a.nr_sequencia = nr_seq_regra_w;
		exception
		when others then
			nr_seq_tipo_plantao_w	:= null;
		end;
	end if;
	end;
end if;

if (coalesce(cd_medico_p,'0') <> '0') and (obter_se_medico > '0') then
	begin

	select 	nextval('medico_plantao_seq')
	into STRICT	nr_seq_plantao_p
	;


	insert	into	medico_plantao(
		nr_sequencia,
		cd_medico,
		dt_atualizacao,
		dt_atualizacao_nrec,
		nm_usuario,
		nm_usuario_nrec,
		cd_estabelecimento,
		dt_chamado,
		dt_inicial,
		qt_minuto,
		cd_especialidade,
		nr_seq_regra_esp,
		nr_seq_tipo_plantao)
	values (
		nr_seq_plantao_p,
		cd_medico_p,
		clock_timestamp(),
		clock_timestamp(),
		nm_usuario_p,
		nm_usuario_p,
		cd_estabelecimento_p,
		clock_timestamp(),
		clock_timestamp(),
		0,
		cd_especialidade_w,
		nr_seq_regra_w,
		nr_seq_tipo_plantao_w);
	end;
end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_inicio_plantao (cd_medico_p text, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_plantao_p INOUT bigint) FROM PUBLIC;

