-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_pagto_banrisul_cnab_240 ( nr_seq_envio_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
/* padrão cnab 240 versão 060 de 08/2009 */
 
 
ds_conteudo_w		varchar(240);
cd_estabelecimento_w	smallint;
nr_seq_apres_w		bigint	:= 0;
qt_titulo_w		bigint;
qt_folha_pagto_w		bigint;
ie_folha_pagto_w		varchar(1);

/* header de arquivo */
 
cd_agencia_estab_w	varchar(5);
cd_cgc_estab_w		varchar(14);
cd_convenio_banco_w	varchar(5);
dt_geracao_w		varchar(15);
nm_empresa_w		varchar(30);
nr_conta_estab_w		varchar(10);
nr_remessa_w		bigint;
ds_endereco_estab_w	varchar(30);
nr_endereco_estab_w	varchar(5);
ds_complemento_estab_w	varchar(15);
ds_municipio_estab_w	varchar(20);
cd_cep_estab_w		varchar(8);
sg_estado_estab_w		varchar(15);

/* header de lote - doc */
 
nr_lote_servico_w		smallint;
ie_forma_lanc_w		varchar(2);
ie_tipo_pagamento_w	varchar(3);
ie_finalidade_w		varchar(2);
ds_endereco_w		varchar(30);
nr_endereco_w		varchar(5);
ds_complemento_w		varchar(15);
ds_municipio_w		varchar(20);
cd_cep_w		varchar(8);
sg_estado_w		varchar(15);
ds_bairro_w		varchar(15);
ie_tipo_identifi_w		varchar(1);
cd_banco_bloqueto_w	varchar(3);

c01 CURSOR FOR 
SELECT	distinct 
	CASE WHEN b.ie_tipo_pagamento='CC' THEN '01' WHEN b.ie_tipo_pagamento='DOC' THEN '03' WHEN b.ie_tipo_pagamento='TED' THEN '03' WHEN b.ie_tipo_pagamento='CCP' THEN '05' WHEN b.ie_tipo_pagamento='P' THEN '10' END , 
	CASE WHEN coalesce(ie_folha_pagto_w,'N')='S' THEN '06'  ELSE CASE WHEN b.ie_tipo_pagamento='CC' THEN '01'  ELSE '99' END  END  
from	titulo_pagar_escrit b, 
	banco_escritural a 
where	not exists (SELECT	1 
	from	darf_titulo_pagar x 
	where	x.nr_titulo	= b.nr_titulo) 
and	not exists (select	1 
	from	gps_titulo x 
	where	x.nr_titulo	= b.nr_titulo) 
and	b.ie_tipo_pagamento	in ('DOC','CC','CCP','OP','TED') 
and	a.nr_sequencia		= b.nr_seq_escrit 
and	a.nr_sequencia		= nr_seq_envio_p;

/* detalhe - doc */
 
nr_sequencia_w		integer;
cd_camara_compensacao_w	varchar(3);
cd_banco_w		smallint;
cd_agencia_bancaria_w	varchar(5);
nr_conta_w		varchar(13);
nm_pessoa_w		varchar(30);
nr_titulo_w		bigint;
dt_remessa_retorno_w	timestamp;
vl_escritural_w		double precision;
vl_acrescimo_w		double precision;
vl_desconto_w		double precision;
vl_despesa_w		double precision;
ie_tipo_inscricao_w	varchar(1);
nr_inscricao_w		varchar(14);
dt_vencimento_w		timestamp;
vl_juros_w		double precision;
vl_multa_w		double precision;
cd_banco_externo_w	varchar(3);
ie_digito_agencia_w	varchar(1);
cd_historico_w		varchar(4);
nr_inscr_w		varchar(14);

c02 CURSOR FOR 
SELECT	lpad(coalesce(b.cd_camara_compensacao,CASE WHEN b.ie_tipo_pagamento='TED' THEN '018' WHEN b.ie_tipo_pagamento='DOC' THEN '700'  ELSE '000' END ),3,'0'), 
	b.cd_banco, 
	lpad(substr(b.cd_agencia_bancaria,1,5),5,'0'), 
	lpad(substr(b.nr_conta,1,12) || substr(b.ie_digito_conta,1,1),13,'0'), 
	rpad(substr(obter_nome_pf_pj(c.cd_pessoa_fisica,c.cd_cgc),1,30),30,' '), 
	c.nr_titulo, 
	b.vl_escritural, 
	b.vl_acrescimo, 
	b.vl_desconto, 
	b.vl_despesa, 
	CASE WHEN coalesce(c.cd_pessoa_fisica::text, '') = '' THEN '2'  ELSE '1' END , 
	lpad(coalesce(d.nr_cpf,c.cd_cgc),14,'0'), 
	c.dt_vencimento_atual, 
	b.vl_juros, 
	b.vl_multa, 
	rpad(coalesce(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'SNR'),1,255),' '),30,' ') ds_endereco, 
	lpad(coalesce(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'NR'),1,255),'0'),5,'0') nr_endereco, 
	rpad(coalesce(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'CO'),1,255),' '),15,' ') ds_complemento, 
	rpad(coalesce(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'B'),1,255),' '),15,' ') ds_bairro, 
	rpad(coalesce(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'CI'),1,255),' '),20,' ') ds_municipio, 
	lpad(coalesce(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'CEP'),1,255),'0'),8,'0') cd_cep, 
	rpad(coalesce(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'UF'),1,255),' '),2,' ') sg_estado, 
	substr(e.cd_banco_externo,1,3), 
	coalesce(substr(b.ie_digito_agencia,1,1),'0') ie_digito_agencia, 
	CASE WHEN coalesce(c.cd_cgc::text, '') = '' THEN '1'  ELSE '2' END  ie_tipo_identificacao, 
	lpad(coalesce(c.cd_cgc,d.nr_cpf),14,'0') nr_inscricao 
FROM banco_escritural a, titulo_pagar c
LEFT OUTER JOIN pessoa_fisica d ON (c.cd_pessoa_fisica = d.cd_pessoa_fisica)
, titulo_pagar_escrit b
LEFT OUTER JOIN banco e ON (b.cd_banco = e.cd_banco)
WHERE not exists (SELECT	1 
	from	darf_titulo_pagar x 
	where	x.nr_titulo	= c.nr_titulo) and not exists (select	1 
	from	gps_titulo x 
	where	x.nr_titulo	= c.nr_titulo)  and b.nr_titulo		= c.nr_titulo and b.ie_tipo_pagamento	in ('DOC','CC','CCP','OP','TED') and CASE WHEN b.ie_tipo_pagamento='CC' THEN '01' WHEN b.ie_tipo_pagamento='DOC' THEN '03' WHEN b.ie_tipo_pagamento='TED' THEN '03' WHEN b.ie_tipo_pagamento='CCP' THEN '05' WHEN b.ie_tipo_pagamento='OP' THEN '10' END 	= ie_forma_lanc_w and a.nr_sequencia		= b.nr_seq_escrit and a.nr_sequencia		= nr_seq_envio_p;

/* trailer lote - doc */
 
vl_total_w		double precision;

/* header de lote - blq */
 
nr_versao_w		varchar(3);
ie_tipo_servico_w	varchar(2);

c03 CURSOR FOR 
SELECT	distinct 
	CASE WHEN(SELECT	count(*) 		from	gps_titulo x 		where	x.nr_titulo	= b.nr_titulo)=0 THEN  		CASE WHEN(select	count(*) 			from	darf_titulo_pagar x 			where	x.nr_titulo	= b.nr_titulo)=0 THEN  			CASE WHEN 	b.ie_tipo_pagamento='PC' THEN '11'  ELSE CASE WHEN 	CASE WHEN coalesce(d.cd_banco_externo::text, '') = '' THEN b.cd_banco  ELSE somente_numero(d.cd_banco_externo) END =33 THEN '30'  ELSE CASE WHEN(select	count(*) 						from	banco x 						where	CASE WHEN coalesce(x.cd_banco_externo::text, '') = '' THEN x.cd_banco  ELSE somente_numero(x.cd_banco_externo) END 	= somente_numero(substr(c.nr_bloqueto,1,3)))=0 THEN '11'  ELSE '31' END  END  END   ELSE CASE WHEN 	coalesce(c.nr_bloqueto::text, '') = '' THEN '16'  ELSE '11' END  END   ELSE CASE WHEN coalesce(c.nr_bloqueto::text, '') = '' THEN '32'  ELSE '11' END  END  ie_forma_lanc 
FROM titulo_pagar c, banco_escritural a, titulo_pagar_escrit b
LEFT OUTER JOIN banco d ON (b.cd_banco = d.cd_banco)
WHERE b.nr_titulo		= c.nr_titulo and (b.ie_tipo_pagamento in ('BLQ','PC') or 
	exists (select	1 
	from	darf_titulo_pagar x 
	where	x.nr_titulo	= b.nr_titulo) or 
	exists (select	1 
	from	gps_titulo x 
	where	x.nr_titulo	= b.nr_titulo)) and a.nr_sequencia		= b.nr_seq_escrit and a.nr_sequencia		= nr_seq_envio_p order by	1;

/* detalhe - blq */
 
nr_bloqueto_w		varchar(44);
ie_tipo_identificacao_w	varchar(2);
dt_apuracao_w		timestamp;
cd_darf_w		varchar(6);
nr_referencia_w		varchar(17);
cd_pagamento_w		varchar(6);
dt_referencia_w		varchar(6);
vl_inss_w		double precision;
vl_outras_entidades_w	double precision;
cd_receita_w		varchar(6);
qt_banco_w		bigint;

c04 CURSOR FOR 
SELECT	rpad(substr(obter_nome_pf_pj(c.cd_pessoa_fisica,c.cd_cgc),1,30),30,' '), 
	c.nr_titulo, 
	b.vl_escritural, 
	b.vl_acrescimo, 
	b.vl_desconto, 
	b.vl_despesa, 
	c.dt_vencimento_atual, 
	b.vl_juros, 
	b.vl_multa, 
	rpad(substr(c.nr_bloqueto,1,44),44,' '), 
	CASE WHEN coalesce(c.cd_cgc::text, '') = '' THEN '01'  ELSE '02' END  ie_tipo_identificacao, 
	lpad(coalesce(c.cd_cgc,d.nr_cpf),14,'0') nr_inscricao 
FROM banco_escritural a, titulo_pagar c
LEFT OUTER JOIN pessoa_fisica d ON (c.cd_pessoa_fisica = d.cd_pessoa_fisica)
, titulo_pagar_escrit b
LEFT OUTER JOIN banco e ON (b.cd_banco = e.cd_banco)
WHERE b.nr_titulo		= c.nr_titulo and CASE WHEN(SELECT	count(*) 		from	gps_titulo x 		where	x.nr_titulo	= b.nr_titulo)=0 THEN  		CASE WHEN(select	count(*) 			from	darf_titulo_pagar x 			where	x.nr_titulo	= b.nr_titulo)=0 THEN  			CASE WHEN 	b.ie_tipo_pagamento='PC' THEN '11'  ELSE CASE WHEN 	CASE WHEN coalesce(e.cd_banco_externo::text, '') = '' THEN b.cd_banco  ELSE somente_numero(e.cd_banco_externo) END =33 THEN '30'  ELSE CASE WHEN(select	count(*) 						from	banco x 						where	CASE WHEN coalesce(x.cd_banco_externo::text, '') = '' THEN x.cd_banco  ELSE somente_numero(x.cd_banco_externo) END 	= somente_numero(substr(c.nr_bloqueto,1,3)))=0 THEN '11'  ELSE '31' END  END  END   ELSE CASE WHEN 	coalesce(c.nr_bloqueto::text, '') = '' THEN '16'  ELSE '11' END  END   ELSE CASE WHEN coalesce(c.nr_bloqueto::text, '') = '' THEN '32'  ELSE '11' END  END 	= ie_forma_lanc_w  and (b.ie_tipo_pagamento in ('BLQ','PC') or 
	exists (select	1 
	from	darf_titulo_pagar x 
	where	x.nr_titulo	= b.nr_titulo) or 
	exists (select	1 
	from	gps_titulo x 
	where	x.nr_titulo	= b.nr_titulo)) and a.nr_sequencia		= b.nr_seq_escrit and a.nr_sequencia		= nr_seq_envio_p;

/* trailer do arquivo */
 
qt_registro_w		bigint;


BEGIN 
 
delete	from w_envio_banco 
where	nm_usuario	= nm_usuario_p;
 
select	count(*) 
into STRICT	qt_titulo_w 
from	titulo_pagar_escrit a 
where	a.nr_seq_escrit	= nr_seq_envio_p;
 
select	count(*) 
into STRICT	qt_folha_pagto_w 
from	titulo_pagar b, 
	titulo_pagar_escrit a 
where	b.ie_tipo_titulo	= '6' 
and	a.nr_titulo		= b.nr_titulo 
and	a.nr_seq_escrit		= nr_seq_envio_p;
 
/* se todos os títulos forem de folha de pagamento, então será gerado o arquivo para folha de pagamento */
 
if (coalesce(qt_titulo_w,0) = coalesce(qt_folha_pagto_w,0)) then 
 
	ie_folha_pagto_w	:= 'S';
 
else 
 
	ie_folha_pagto_w	:= 'N';
 
end if;
 
/* header de arquivo */
 
nr_seq_apres_w		:= coalesce(nr_seq_apres_w,0) + 1;
 
select	lpad(b.cd_cgc,14,'0'), 
	rpad(coalesce(substr(c.cd_convenio_banco,1,5),' '),5,' '), 
	lpad(coalesce(substr(c.cd_agencia_bancaria,1,5),'0'),5,'0'), 
	lpad(substr(c.cd_conta,1,10) || coalesce(c.ie_digito_conta,' '),10,'0'), 
	rpad(substr(obter_nome_estabelecimento(b.cd_estabelecimento),1,30),30,' '), 
	to_char(clock_timestamp(),'ddmmyyyyhh24miss'), 
	coalesce(a.nr_remessa,a.nr_sequencia), 
	b.cd_estabelecimento, 
	a.dt_remessa_retorno, 
	rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'SNR'),1,255),' '),30,' ') ds_endereco, 
	lpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'NR'),1,255),'0'),5,'0') nr_endereco, 
	rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'CO'),1,255),' '),15,' ') ds_complemento, 
	rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'CI'),1,255),' '),20,' ') ds_municipio, 
	lpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'CEP'),1,255),'0'),8,'0') cd_cep, 
	rpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'UF'),1,255),' '),2,' ') sg_estado 
into STRICT	cd_cgc_estab_w, 
	cd_convenio_banco_w, 
	cd_agencia_estab_w, 
	nr_conta_estab_w, 
	nm_empresa_w, 
	dt_geracao_w, 
	nr_remessa_w, 
	cd_estabelecimento_w, 
	dt_remessa_retorno_w, 
	ds_endereco_estab_w, 
	nr_endereco_estab_w, 
	ds_complemento_estab_w, 
	ds_municipio_estab_w, 
	cd_cep_estab_w, 
	sg_estado_estab_w 
from	banco_estabelecimento c, 
	estabelecimento b, 
	banco_escritural a 
where	a.nr_seq_conta_banco	= c.nr_sequencia 
and	a.cd_estabelecimento	= b.cd_estabelecimento 
and	a.nr_sequencia		= nr_seq_envio_p;
 
 
 
ds_conteudo_w	:=	'041' || 
			'0000' || 
			'0' || 
			rpad(' ',9,' ') || 
			'2' || 
			cd_cgc_estab_w || 
			cd_convenio_banco_w || 
			rpad(' ', 15, ' ') || 
			cd_agencia_estab_w || 
			'0' || 
			'000' || 
			nr_conta_estab_w || 
			'0' || 
			nm_empresa_w || 
			rpad('BANCO BANRISUL',30,' ') || 
			rpad(' ',10,' ') || 
			'1' || 
			dt_geracao_w || 
			lpad(nr_remessa_w,6,'0') || 
			'020' || 
			'0000' || 
			rpad(' ',69,' ');
 
insert	into w_envio_banco(cd_estabelecimento, 
	ds_conteudo, 
	dt_atualizacao, 
	nm_usuario, 
	nr_seq_apres, 
	nr_seq_apres_2, 
	nr_sequencia) 
values (cd_estabelecimento_w, 
	ds_conteudo_w, 
	clock_timestamp(), 
	nm_usuario_p, 
	nr_seq_apres_w, 
	nr_seq_apres_w, 
	nextval('w_envio_banco_seq'));
 
if (coalesce(ie_folha_pagto_w,'N') = 'S') then 
 
	ie_tipo_servico_w	:= '30';
	cd_historico_w		:= '2007';
 
else 
 
	ie_tipo_servico_w	:= '20';
	cd_historico_w		:= '0000';
 
end if;
 
open	c01;
loop 
fetch	c01 into 
	ie_forma_lanc_w, 
	ie_finalidade_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	/* header de lote */
 
	nr_lote_servico_w	:= coalesce(nr_lote_servico_w,0) + 1;
	nr_seq_apres_w		:= coalesce(nr_seq_apres_w,0) + 1;
	nr_sequencia_w		:= 0;
	vl_total_w		:= 0;
 
	ds_conteudo_w	:=	'041' || 
				lpad(nr_lote_servico_w,4,'0') || 
				'1' || 
				'C' || 
				ie_tipo_servico_w || 
				ie_forma_lanc_w || 
				'020' || 
				' ' || 
				'2' || 
				cd_cgc_estab_w || 
				cd_convenio_banco_w || 
				rpad(' ',15,' ') || 
				cd_agencia_estab_w || 
				'0000' || 
				nr_conta_estab_w || 
				' ' || 
				nm_empresa_w || 
				rpad(' ',40,' ') || 
				ds_endereco_estab_w || 
				nr_endereco_estab_w || 
				ds_complemento_estab_w || 
				ds_municipio_estab_w || 
				cd_cep_estab_w || 
				substr(sg_estado_estab_w,1,2) || 
				rpad(' ',18,' ');
 
	insert	into w_envio_banco(cd_estabelecimento, 
		ds_conteudo, 
		dt_atualizacao, 
		nm_usuario, 
		nr_seq_apres, 
		nr_seq_apres_2, 
		nr_sequencia) 
	values (cd_estabelecimento_w, 
		ds_conteudo_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_seq_apres_w, 
		nr_seq_apres_w, 
		nextval('w_envio_banco_seq'));
 
	open	c02;
	loop 
	fetch	c02 into 
		cd_camara_compensacao_w, 
		cd_banco_w, 
		cd_agencia_bancaria_w, 
		nr_conta_w, 
		nm_pessoa_w, 
		nr_titulo_w, 
		vl_escritural_w, 
		vl_acrescimo_w, 
		vl_desconto_w, 
		vl_despesa_w, 
		ie_tipo_inscricao_w, 
		nr_inscricao_w, 
		dt_vencimento_w, 
		vl_juros_w, 
		vl_multa_w, 
		ds_endereco_w, 
		nr_endereco_w, 
		ds_complemento_w, 
		ds_bairro_w, 
		ds_municipio_w, 
		cd_cep_w, 
		sg_estado_w, 
		cd_banco_externo_w, 
		ie_digito_agencia_w, 
		ie_tipo_identifi_w, 
		nr_inscr_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
 
		if (cd_banco_externo_w IS NOT NULL AND cd_banco_externo_w::text <> '') then 
 
			cd_banco_w	:= somente_numero(cd_banco_externo_w);
 
		end if;
 
		/* segmento a */
 
		nr_sequencia_w	:= coalesce(nr_sequencia_w,0) + 1;
		nr_seq_apres_w	:= coalesce(nr_seq_apres_w,0) + 1;
		qt_registro_w	:= coalesce(qt_registro_w,0) + 1;
		vl_total_w	:= coalesce(vl_total_w,0) + (coalesce(vl_escritural_w,0) - coalesce(vl_desconto_w,0) + coalesce(vl_acrescimo_w,0) + coalesce(vl_despesa_w,0) + coalesce(vl_juros_w,0) + coalesce(vl_multa_w,0));
 
		ds_conteudo_w	:=	'041' || 
					lpad(nr_lote_servico_w,4,'0') || 
					'3' || 
					lpad(nr_sequencia_w,5,'0') || 
					'A' || 
					'0' || 
					'00' || 
					cd_camara_compensacao_w || 
					lpad(coalesce(cd_banco_w,'0'),3,'0') || 
					lpad(coalesce(cd_agencia_bancaria_w,'0'),5,'0') || 
					' ' || 
					lpad(coalesce(nr_conta_w,'0'),13,'0') || 
					' ' || 
					rpad(nm_pessoa_w,30,' ') || 
					rpad(nr_titulo_w,15,' ') || 
					rpad(' ',5,' ') || 
					to_char(dt_remessa_retorno_w,'ddmmyyyy') || 
					'BRL' || 
					'000000000000000' || 
					lpad(somente_numero(to_char(coalesce(vl_escritural_w,0) - coalesce(vl_desconto_w,0) + coalesce(vl_acrescimo_w,0) + coalesce(vl_despesa_w,0) + coalesce(vl_juros_w,0) + coalesce(vl_multa_w,0),'9999999999990.00')),15,'0') || 
					rpad(' ',20,' ') || 
					'00000000' || 
					'000000000000000' || 
					rpad(' ',25,' ') || 
					ie_tipo_identifi_w || 
					lpad(coalesce(nr_inscr_w,'0'),14,'0') || 
					rpad(' ',12,' ') || 
					'0' || 
					rpad(' ',10,' ');
 
		insert	into w_envio_banco(cd_estabelecimento, 
			ds_conteudo, 
			dt_atualizacao, 
			nm_usuario, 
			nr_seq_apres, 
			nr_seq_apres_2, 
			nr_sequencia) 
		values (cd_estabelecimento_w, 
			ds_conteudo_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			nr_seq_apres_w, 
			nr_seq_apres_w, 
			nextval('w_envio_banco_seq'));
 
		/* segmento b */
 
		nr_sequencia_w	:= coalesce(nr_sequencia_w,0) + 1;
		nr_seq_apres_w	:= coalesce(nr_seq_apres_w,0) + 1;
		qt_registro_w	:= coalesce(qt_registro_w,0) + 1;
 
		ds_conteudo_w	:=	'041' || 
					lpad(nr_lote_servico_w,4,'0') || 
					'3' || 
					lpad(nr_sequencia_w,5,'0') || 
					'B' || 
					rpad(' ',3,' ') || 
					ie_tipo_inscricao_w || 
					lpad(coalesce(nr_inscricao_w,'0'),14,'0') || 
					rpad(coalesce(ds_endereco_w,''),30,' ') || 
					lpad(coalesce(nr_endereco_w,'0'),5,'0') || 
					rpad(coalesce(ds_complemento_w,''),15,' ') || 
					rpad(coalesce(ds_bairro_w,''),15,' ') || 
					rpad(coalesce(ds_municipio_w,''),20,' ') || 
					lpad(coalesce(cd_cep_w,'0'),5,'0') || 
					rpad(' ',3,' ') || 
					rpad(substr(sg_estado_w,1,2),2) || 
					to_char(dt_vencimento_w,'ddmmyyyy') || 
					lpad(somente_numero(to_char(coalesce(vl_escritural_w,0),'9999999999990.00')),15,'0') || 
					'000000000000000' || 
					lpad(somente_numero(to_char(coalesce(vl_desconto_w,0),'9999999999990.00')),15,'0') || 
					lpad(somente_numero(to_char(coalesce(vl_juros_w,0),'9999999999990.00')),15,'0') || 
					lpad(somente_numero(to_char(coalesce(vl_multa_w,0),'9999999999990.00')),15,'0') || 
					rpad(' ',15,' ') || 
					rpad(' ',1,' ') || 
					rpad(' ',14,' ');
 
		insert	into w_envio_banco(cd_estabelecimento, 
			ds_conteudo, 
			dt_atualizacao, 
			nm_usuario, 
			nr_seq_apres, 
			nr_seq_apres_2, 
			nr_sequencia) 
		values (cd_estabelecimento_w, 
			ds_conteudo_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			nr_seq_apres_w, 
			nr_seq_apres_w, 
			nextval('w_envio_banco_seq'));
 
	end	loop;
	close	c02;
 
	/* trailer de lote */
 
	nr_seq_apres_w	:= coalesce(nr_seq_apres_w,0) + 1;
 
	ds_conteudo_w	:=	'041' || 
				lpad(nr_lote_servico_w,4,'0') || 
				'5' || 
				rpad(' ',9,' ') || 
				lpad(nr_sequencia_w + 2,6,'0') || 
				lpad(somente_numero(to_char(coalesce(vl_total_w,0),'9999999999999990.00')),18,'0') || 
				'000000000000000000' || 
				rpad(' ',181,' ');
 
	insert	into w_envio_banco(cd_estabelecimento, 
		ds_conteudo, 
		dt_atualizacao, 
		nm_usuario, 
		nr_seq_apres, 
		nr_seq_apres_2, 
		nr_sequencia) 
	values (cd_estabelecimento_w, 
		ds_conteudo_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_seq_apres_w, 
		nr_seq_apres_w, 
		nextval('w_envio_banco_seq'));
 
end	loop;
close	c01;
 
open	c03;
loop 
fetch	c03 into 
	ie_forma_lanc_w;
EXIT WHEN NOT FOUND; /* apply on c03 */
 
	/* header de lote - blq */
 
	nr_lote_servico_w	:= coalesce(nr_lote_servico_w,0) + 1;
	nr_seq_apres_w		:= coalesce(nr_seq_apres_w,0) + 1;
	nr_sequencia_w		:= 0;
	vl_total_w		:= 0;
 
	if (ie_forma_lanc_w	= '16') then 
	 
		ie_tipo_servico_w	:= '22';
	 
	elsif (ie_forma_lanc_w	= '32') then 
 
		ie_tipo_servico_w	:= '90';
 
	elsif (ie_forma_lanc_w	= '11') then 
 
		ie_tipo_servico_w	:= '20';
 
	else 
 
		ie_tipo_servico_w	:= '20';
 
	end if;
 
 
	ds_conteudo_w	:=	'041' || 
				lpad(nr_lote_servico_w,4,'0') || 
				'1' || 
				'C' || 
				ie_tipo_servico_w || 
				ie_forma_lanc_w || 
				'020' || 
				' ' || 
				'2' || 
				cd_cgc_estab_w || 
				cd_convenio_banco_w || 
				rpad(' ',15,' ') || 
				cd_agencia_estab_w || 
				'0000' || 
				nr_conta_estab_w || 
				' ' || 
				nm_empresa_w || 
				rpad(' ',40,' ') || 
				ds_endereco_estab_w || 
				nr_endereco_estab_w || 
				ds_complemento_estab_w || 
				ds_municipio_estab_w || 
				cd_cep_estab_w || 
				substr(sg_estado_estab_w,1,2) || 
				rpad(' ',18,' ');
 
	 
	insert	into w_envio_banco(cd_estabelecimento, 
		ds_conteudo, 
		dt_atualizacao, 
		nm_usuario, 
		nr_seq_apres, 
		nr_seq_apres_2, 
		nr_sequencia) 
	values (cd_estabelecimento_w, 
		ds_conteudo_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_seq_apres_w, 
		nr_seq_apres_w, 
		nextval('w_envio_banco_seq'));
 
	open	c04;
	loop 
	fetch	c04 into 
		nm_pessoa_w, 
		nr_titulo_w, 
		vl_escritural_w, 
		vl_acrescimo_w, 
		vl_desconto_w, 
		vl_despesa_w, 
		dt_vencimento_w, 
		vl_juros_w, 
		vl_multa_w, 
		nr_bloqueto_w, 
		ie_tipo_identificacao_w, 
		nr_inscricao_w;
	EXIT WHEN NOT FOUND; /* apply on c04 */
 
		nr_sequencia_w	:= coalesce(nr_sequencia_w,0) + 1;
		nr_seq_apres_w	:= coalesce(nr_seq_apres_w,0) + 1;
		qt_registro_w	:= coalesce(qt_registro_w,0) + 1;
		vl_total_w	:= coalesce(vl_total_w,0) + (coalesce(vl_escritural_w,0) - coalesce(vl_desconto_w,0) + coalesce(vl_acrescimo_w,0) + coalesce(vl_despesa_w,0) + coalesce(vl_juros_w,0) + coalesce(vl_multa_w,0));
 
		select	count(*) 
		into STRICT	qt_banco_w 
		from	banco a 
		where	CASE WHEN coalesce(a.cd_banco_externo::text, '') = '' THEN a.cd_banco  ELSE somente_numero(a.cd_banco_externo) END 	= somente_numero(substr(nr_bloqueto_w,1,3));
		 
		/* segmento n - darf normal */
 
		if (ie_forma_lanc_w	= '16') then 
 
			select	max(b.dt_apuracao) dt_apuracao, 
				lpad(substr(coalesce(max(b.cd_darf),'0'),1,6),6,'0') cd_darf, 
				lpad(substr(coalesce(max(b.nr_referencia),'0'),1,17),17,'0') nr_referencia 
			into STRICT	dt_apuracao_w, 
				cd_darf_w, 
				nr_referencia_w 
			from	darf b, 
				darf_titulo_pagar a 
			where	a.nr_seq_darf	= b.nr_sequencia 
			and	a.nr_titulo	= nr_titulo_w;
 
			ds_conteudo_w	:=	'041' || 
						lpad(nr_lote_servico_w,4,'0') || 
						'3' || 
						lpad(nr_sequencia_w,5,'0') || 
						'N' || 
						'0' || 
						'00' || 
						rpad(nr_titulo_w,20,' ') || 
						rpad(' ',20,' ') || 
						nm_empresa_w || 
						to_char(dt_remessa_retorno_w,'ddmmyyyy') || 
						lpad(somente_numero(to_char(coalesce(vl_escritural_w,0) - coalesce(vl_desconto_w,0) + coalesce(vl_acrescimo_w,0) + coalesce(vl_despesa_w,0) + coalesce(vl_juros_w,0) + coalesce(vl_multa_w,0),'9999999999990.00')),15,'0') || 
						cd_darf_w || 
						ie_tipo_identificacao_w || 
						cd_cgc_estab_w || 
						'16' || 
						to_char(dt_apuracao_w,'ddmmyyyy') || 
						nr_referencia_w || 
						lpad(somente_numero(to_char(coalesce(vl_escritural_w,0),'9999999999990.00')),15,'0') || 
						lpad(somente_numero(to_char(coalesce(vl_multa_w,0),'9999999999990.00')),15,'0') || 
						lpad(somente_numero(to_char(coalesce(vl_juros_w,0),'9999999999990.00')),15,'0') || 
						to_char(dt_vencimento_w,'ddmmyyyy') || 
						rpad(' ',18,' ') || 
						rpad(' ',10,' ');
 
		/* segmento i - gps */
 
		elsif (ie_forma_lanc_w	= '32') then 
 
			select	to_char(max(b.dt_referencia),'mmyyyy') dt_referencia, 
				lpad(substr(coalesce(max(b.cd_pagamento),'0'),1,4),4,'0') cd_pagamento, 
				max(b.vl_inss) vl_inss, 
				max(b.vl_outras_entidades) vl_outras_entidades 
			into STRICT	dt_referencia_w, 
				cd_pagamento_w, 
				vl_inss_w, 
				vl_outras_entidades_w 
			from	gps b, 
				gps_titulo a 
			where	a.nr_seq_gps	= b.nr_sequencia 
			and	a.nr_titulo	= nr_titulo_w;
 
			ds_conteudo_w	:=	'041' || 
						lpad(nr_lote_servico_w,4,'0') || 
						'3' || 
						lpad(nr_sequencia_w,5,'0') || 
						'I' || 
						'0' || 
						'00' || 
						cd_pagamento_w || 
						rpad(ie_tipo_identificacao_w,14,'0') || 
						dt_referencia_w || 
						to_char(dt_remessa_retorno_w,'ddmmyyyy') || 
						lpad(somente_numero(to_char(coalesce(vl_inss_w,0),'9999999999990.00')),15,'0') || 
						lpad('0',15,'0') || 
						lpad('0',15,'0') || 
						lpad(somente_numero(to_char(coalesce(vl_outras_entidades_w,0),'9999999999990.00')),15,'0') || 
						lpad(somente_numero(to_char(coalesce(vl_multa_w,0) + coalesce(vl_juros_w,0),'9999999999990.00')),15,'0') || 
						lpad(somente_numero(to_char(coalesce(vl_escritural_w,0) - coalesce(vl_desconto_w,0) + coalesce(vl_acrescimo_w,0) + coalesce(vl_despesa_w,0) + coalesce(vl_juros_w,0) + coalesce(vl_multa_w,0),'9999999999990.00')),15,'0') || 
						' ' || 
						'0000' || 
						'0000' || 
						rpad(' ',3,' ') || 
						'00000' || 
						substr(nm_pessoa_w,1,30) || 
						'000000' || 
						rpad(' ',17,' ') || 
						rpad(' ',16,' ') || 
						rpad(' ',5,' ') || 
						rpad(' ',10,' ');
 
		/* segmento o */
 
		/*elsif	(ie_forma_lanc_w	= '11') or 
			(qt_banco_w		= 0) then 
 
			ds_conteudo_w	:=	'033' || 
						lpad(nr_lote_servico_w,4,'0') || 
						'3' || 
						lpad(nr_sequencia_w,5,'0') || 
						'o' || 
						'0' || 
						'00' || 
						rpad(substr(nvl(nr_bloqueto_w,' '),1,44),44,' ') || 
						nm_pessoa_w || 
						to_char(dt_vencimento_w,'ddmmyyyy') || 
						to_char(dt_remessa_retorno_w,'ddmmyyyy') || 
						lpad(somente_numero(to_char(nvl(vl_escritural_w,0) - nvl(vl_desconto_w,0) + nvl(vl_acrescimo_w,0) + nvl(vl_despesa_w,0) + nvl(vl_juros_w,0) + nvl(vl_multa_w,0),'9999999999990.00')),15,'0') || 
						rpad(nr_titulo_w,20,' ') || 
						rpad(' ',20,' ') || 
						rpad(' ',78,' ');*/
 
 
		/* segmento j */
 
		else 
 
			ds_conteudo_w	:=	'041' || 
						lpad(nr_lote_servico_w,4,'0') || 
						'3' || 
						lpad(nr_sequencia_w,5,'0') || 
						'J' || 
						'0' || 
						'00' || 
						rpad(substr(coalesce(nr_bloqueto_w,'0'),1,3),3,'0') 	|| 
						rpad(substr(coalesce(nr_bloqueto_w,'0'),4,1),1,'0') 	|| 
						rpad(substr(coalesce(nr_bloqueto_w,'0'),5,1),1,'0')		|| 
						rpad(substr(coalesce(nr_bloqueto_w,'0'),6,4),4,'0')		|| 
						rpad(substr(coalesce(nr_bloqueto_w,'0'),10,10),10,'0')	|| 
						rpad(substr(coalesce(nr_bloqueto_w,'0'),20,25),25,'0')	|| 
						lpad(substr(coalesce(nm_pessoa_w,' '),1,30),30,' ') 	 || 
						to_char(dt_vencimento_w,'ddmmyyyy') || 
						lpad(somente_numero(to_char(coalesce(vl_escritural_w,0),'9999999999990.00')),15,'0') || 
						lpad(somente_numero(to_char(coalesce(vl_desconto_w,0),'9999999999990.00')),15,'0') || 
						rpad('0',15,'0') || 
						to_char(dt_vencimento_w,'ddmmyyyy') || 
						lpad(somente_numero(to_char(coalesce(vl_escritural_w,0) - coalesce(vl_desconto_w,0) + coalesce(vl_acrescimo_w,0) + coalesce(vl_despesa_w,0) + coalesce(vl_juros_w,0) + coalesce(vl_multa_w,0),'9999999999990.00')),15,'0') || 
						rpad('0',15,'0') || 
						rpad(' ',5,' ') || 
						rpad('0',30,'0') || 
						rpad(' ',23,' ');
		end if;
 
		insert	into w_envio_banco(cd_estabelecimento, 
			ds_conteudo, 
			dt_atualizacao, 
			nm_usuario, 
			nr_seq_apres, 
			nr_seq_apres_2, 
			nr_sequencia) 
		values (cd_estabelecimento_w, 
			ds_conteudo_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			nr_seq_apres_w, 
			nr_seq_apres_w, 
			nextval('w_envio_banco_seq'));
 
		/* segmento j-52 */
 
		/*if	(ie_forma_lanc_w	<> '16') and 
			(ie_forma_lanc_w	<> '17') and 
			(ie_forma_lanc_w	<> '11') and 
			(qt_banco_w		<> 0) then 
 
			nr_sequencia_w	:= nvl(nr_sequencia_w,0) + 1; 
			nr_seq_apres_w	:= nvl(nr_seq_apres_w,0) + 1; 
			qt_registro_w	:= nvl(qt_registro_w,0) + 1; 
 
			ds_conteudo_w	:=	'033' || 
						lpad(nr_lote_servico_w,4,'0') || 
						'3' || 
						lpad(nr_sequencia_w,5,'0') || 
						'j' || 
						' ' || 
						'00' || 
						'52' || 
						'2' || 
						lpad(cd_cgc_estab_w,15,'0') || 
						rpad(nm_empresa_w,40,' ') || 
						substr(ie_tipo_identificacao_w,2,1) || 
						lpad(nr_inscricao_w,15,'0') || 
						rpad(nm_pessoa_w,40,' ') || 
						'2' || 
						lpad(cd_cgc_estab_w,15,'0') || 
						rpad(nm_empresa_w,40,' ') || 
						rpad(' ',52,' '); 
 
			insert	into w_envio_banco 
				(cd_estabelecimento, 
				ds_conteudo, 
				dt_atualizacao, 
				nm_usuario, 
				nr_seq_apres, 
				nr_seq_apres_2, 
				nr_sequencia) 
			values	(cd_estabelecimento_w, 
				ds_conteudo_w, 
				sysdate, 
				nm_usuario_p, 
				nr_seq_apres_w, 
				nr_seq_apres_w, 
				w_envio_banco_seq.nextval); 
 
		end if;*/
 
 
	end	loop;
	close	c04;
 
	/* trailer de lote */
 
	nr_seq_apres_w	:= coalesce(nr_seq_apres_w,0) + 1;
 
	ds_conteudo_w	:=	'041' || 
				lpad(nr_lote_servico_w,4,'0') || 
				'5' || 
				rpad(' ',9,' ') || 
				lpad(nr_sequencia_w + 2,6,'0') || 
				lpad(somente_numero(to_char(coalesce(vl_total_w,0),'9999999999999990.00')),18,'0') || 
				'000000000000000000' || 
				rpad(' ',171,' ') || 
				'0000000000';
 
	insert	into w_envio_banco(cd_estabelecimento, 
		ds_conteudo, 
		dt_atualizacao, 
		nm_usuario, 
		nr_seq_apres, 
		nr_seq_apres_2, 
		nr_sequencia) 
	values (cd_estabelecimento_w, 
		ds_conteudo_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_seq_apres_w, 
		nr_seq_apres_w, 
		nextval('w_envio_banco_seq'));
 
end	loop;
close	c03;
 
/* trailer de arquivo */
 
nr_seq_apres_w	:= coalesce(nr_seq_apres_w,0) + 1;
 
ds_conteudo_w	:=	'041' || 
			'9999' || 
			'9' || 
			rpad(' ',9,' ') || 
			lpad(nr_lote_servico_w,6,'0') || 
			lpad(coalesce(qt_registro_w,0) + (coalesce(nr_lote_servico_w,0) * 2) + 2,6,'0') ||	/* registros detalhe + header e trailer dos lotes + header e trailer do arquivo */
 
			'000000' || 
			rpad(' ',205,' ');
 
insert	into w_envio_banco(cd_estabelecimento, 
	ds_conteudo, 
	dt_atualizacao, 
	nm_usuario, 
	nr_seq_apres, 
	nr_seq_apres_2, 
	nr_sequencia) 
values (cd_estabelecimento_w, 
	ds_conteudo_w, 
	clock_timestamp(), 
	nm_usuario_p, 
	nr_seq_apres_w, 
	nr_seq_apres_w, 
	nextval('w_envio_banco_seq'));
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_pagto_banrisul_cnab_240 ( nr_seq_envio_p bigint, nm_usuario_p text) FROM PUBLIC;

