-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qt_vincular_atendimento ( nr_atendimento_p bigint, nr_seq_agenda_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
ie_status_agenda_w		varchar(1);	
ie_status_quimioterapia_w	varchar(1);	
ie_vincular_atend_w		varchar(1);	
ie_vincular_atend_prescr_w	varchar(1);
nr_prescricao_w			bigint;
			
nr_seq_atendimento_w	bigint;			
			 

BEGIN 
 
ie_status_agenda_w := obter_param_usuario(865, 42, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_status_agenda_w);
ie_status_quimioterapia_w := obter_param_usuario(865, 43, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_status_quimioterapia_w);
ie_vincular_atend_w := obter_param_usuario(865, 52, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_vincular_atend_w);
ie_vincular_atend_prescr_w := obter_param_usuario(865, 246, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_vincular_atend_prescr_w);
 
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_atendimento_p > 0) and (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') then 
	update	agenda_quimio 
	set	nr_atendimento	= nr_atendimento_p, 
		dt_atualizacao	= clock_timestamp(), 
		nm_usuario	= nm_usuario_p 
	where	nr_sequencia	= nr_seq_agenda_p;
	 
	if (ie_status_agenda_w IS NOT NULL AND ie_status_agenda_w::text <> '') then 
		CALL qt_alterar_status_agenda(nr_seq_agenda_p, ie_status_agenda_w, nm_usuario_p, 'N', null, null, cd_estabelecimento_p,'');
	end if;
	 
	select	max(nr_seq_atendimento) 
	into STRICT	nr_seq_atendimento_w 
	from	agenda_quimio 
	where	nr_sequencia = nr_seq_agenda_p;
	 
	select	max(nr_prescricao) 
	into STRICT	nr_prescricao_w 
	from	paciente_atendimento 
	where	nr_seq_atendimento = nr_seq_atendimento_w;
	 
	if (ie_vincular_atend_prescr_w = 'S') and (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then 
		update	prescr_medica 
		set	nr_atendimento	= nr_atendimento_p, 
			dt_atualizacao	= clock_timestamp(), 
			nm_usuario 	= nm_usuario_p 
		where	nr_prescricao	= nr_prescricao_w;
	end if;
	 
	if (ie_status_quimioterapia_w = 'S') and (nr_seq_atendimento_w IS NOT NULL AND nr_seq_atendimento_w::text <> '') then 
		update 	paciente_atendimento 
		set	dt_chegada	= clock_timestamp(), 
			nm_usuario 	= nm_usuario_p 
		where	nr_seq_atendimento = nr_seq_atendimento_w;		
	end if;
	 
	if (ie_vincular_atend_w = 'S') and (nr_seq_atendimento_w IS NOT NULL AND nr_seq_atendimento_w::text <> '') then 
		update 	paciente_atendimento 
		set	nr_atendimento	= nr_atendimento_p 
		where	nr_seq_atendimento = nr_seq_atendimento_w;
	end if;
	 
end if;
	 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qt_vincular_atendimento ( nr_atendimento_p bigint, nr_seq_agenda_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

