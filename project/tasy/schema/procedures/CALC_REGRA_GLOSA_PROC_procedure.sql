-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calc_regra_glosa_proc ( nr_lote_p bigint, vl_glosa_p bigint, nm_usuario_p text, cd_motivo_glosa_p convenio_retorno_glosa.cd_motivo_glosa%type ) AS $body$
DECLARE


cd_convenio_w			convenio_retorno.cd_convenio%type;
nr_seq_retorno_w		convenio_retorno_item.nr_sequencia%type;
nr_seq_item_maior_vl_w 		convenio_retorno_glosa.nr_sequencia%type;
nr_seq_guia_item_maior_vl_w 	convenio_retorno_item.nr_sequencia%type;
vl_item_maior_valor_w 		convenio_retorno_glosa.vl_cobrado%type := 0;
nr_interno_conta_w		convenio_retorno_item.nr_interno_conta%type;
vl_sum_itens_vl_cobrado_w	convenio_retorno_item.vl_guia%type := 0;
vl_guia_cheio_w			convenio_retorno_item.vl_guia%type;
vl_cobrado_w			convenio_retorno_glosa.vl_cobrado%type;
cd_autorizacao_w		convenio_retorno_item.cd_autorizacao%type;

vl_glosa_final_w		double precision;
vl_sum_items_tot_w 		double precision := 0;
vl_sum_items_calc_glosa_w	double precision;
vl_sum_items_acao_glosados_w    double precision;
vl_sum_items_acao_amenor_w      double precision;
qt_itens_glosados_w		integer := 0;
ie_acao_glosa_w       		convenio_retorno_glosa.ie_acao_glosa%type;
qt_itens_guia_w       		integer;

cContas CURSOR FOR
SELECT 	nr_sequencia,
	nr_interno_conta,
	cd_autorizacao,
	obter_valor_conpaci_guia(nr_interno_conta, cd_autorizacao,1) vl_guia
from	convenio_retorno_item
where 	nr_seq_retorno = nr_lote_p
order by case when nr_sequencia = coalesce(nr_seq_guia_item_maior_vl_w,0) then 1 else 0 end;

cProcItensToInsert CURSOR FOR
SELECT	a.cd_procedimento,
	a.ie_origem_proced,
	a.cd_procedimento_convenio,
	a.cd_setor_atendimento,
	a.nr_sequencia,
	a.ie_emite_conta,
	a.vl_procedimento,
	a.qt_procedimento
from	procedimento_paciente a,
	estrutura_procedimento_v b
where	a.cd_procedimento = b.cd_procedimento
and	a.ie_origem_proced = b.ie_origem_proced
and	a.nr_interno_conta = nr_interno_conta_w
and	a.nr_doc_convenio = cd_autorizacao_w;

cMatItensToInsert CURSOR FOR
SELECT	b.cd_material,
	b.cd_material_convenio,
	b.cd_setor_atendimento,
	b.nr_sequencia,
	b.ie_emite_conta,
	b.vl_material,
	b.qt_material
from	estrutura_material_v a,
	material_atend_paciente b
where	b.cd_material	= a.cd_material
and 	b.nr_interno_conta 	= nr_interno_conta_w
and	b.nr_doc_convenio	= cd_autorizacao_w;

cItensGlosadosWRules CURSOR FOR
SELECT  distinct a.nr_sequencia, a.vl_cobrado
from	convenio_retorno_glosa a
join regra_rateio_glosa d on d.cd_convenio = cd_convenio_w
where	  a.nr_seq_ret_item = nr_seq_retorno_w
and     d.ie_situacao = 'A'
and 	  clock_timestamp() > PKG_DATE_UTILS.get_Time(d.dt_inicio_vigencia, 0)
and 	  ((coalesce(d.dt_final_vigencia::text, '') = '') or (PKG_DATE_UTILS.get_Time(coalesce(d.dt_final_vigencia,clock_timestamp()) ,0) + 86399/86400 > clock_timestamp()))
and     (
	(coalesce(d.nr_seq_proc_interno::text, '') = '' and coalesce(d.cd_procedimento::text, '') = '' and coalesce(d.cd_grupo_proc::text, '') = '' and coalesce(d.cd_especialidade::text, '') = '' and coalesce(d.cd_area_procedimento::text, '') = '' and coalesce(d.cd_material::text, '') = '' and coalesce(d.nr_seq_familia::text, '') = '' and coalesce(d.cd_classe_material::text, '') = '' and coalesce(d.cd_subgrupo_material::text, '') = '' and coalesce(d.cd_grupo_material::text, '') = '')
	OR (
		coalesce(d.cd_material::text, '') = '' and coalesce(d.nr_seq_familia::text, '') = '' and coalesce(d.cd_classe_material::text, '') = '' and coalesce(d.cd_subgrupo_material::text, '') = '' and coalesce(d.cd_grupo_material::text, '') = ''
    AND a.cd_procedimento IN (
      SELECT p.cd_procedimento
      FROM procedimento_paciente p
      where p.nr_interno_conta = nr_interno_conta_w
      and ((coalesce(d.cd_procedimento::text, '') = '') or (d.cd_procedimento = a.cd_procedimento))
      and   ((coalesce(d.nr_seq_proc_interno::text, '') = '') or (d.nr_seq_proc_interno = p.nr_seq_proc_interno))
		  and 	((coalesce(d.cd_grupo_proc::text, '') = '') or (d.cd_grupo_proc in (select e.cd_grupo_proc from estrutura_procedimento_v e where e.cd_procedimento = a.cd_procedimento and e.ie_origem_proced = a.ie_origem_proced)))
		  and 	((coalesce(d.cd_especialidade::text, '') = '') or (d.cd_especialidade in (select e.cd_especialidade from estrutura_procedimento_v e where e.cd_procedimento = a.cd_procedimento and e.ie_origem_proced = a.ie_origem_proced)))
		  and 	((coalesce(d.cd_area_procedimento::text, '') = '') or (d.cd_area_procedimento in (select e.cd_area_procedimento from estrutura_procedimento_v e where e.cd_procedimento = a.cd_procedimento and e.ie_origem_proced = a.ie_origem_proced)))
    )
	)
	OR (
		coalesce(d.nr_seq_proc_interno::text, '') = '' and coalesce(d.cd_procedimento::text, '') = '' and coalesce(d.cd_grupo_proc::text, '') = '' and coalesce(d.cd_especialidade::text, '') = '' and coalesce(d.cd_area_procedimento::text, '') = ''
    AND a.cd_material IN (
      SELECT p.cd_material
      FROM material_atend_paciente p 
      where p.nr_interno_conta = nr_interno_conta_w
    and   ((coalesce(d.cd_material::text, '') = '') or (d.cd_material = a.cd_material))
		and 	((coalesce(d.nr_seq_familia::text, '') = '') or (d.nr_seq_familia in (select m.nr_seq_familia from estrutura_material_v m where m.cd_material = a.cd_material)))
		and 	((coalesce(d.cd_classe_material::text, '') = '') or (d.cd_classe_material in (select m.cd_classe_material from estrutura_material_v m where m.cd_material = a.cd_material)))
		and 	((coalesce(d.cd_subgrupo_material::text, '') = '') or (d.cd_subgrupo_material in (select m.cd_subgrupo_material from estrutura_material_v m where m.cd_material = a.cd_material)))
		and 	((coalesce(d.cd_grupo_material::text, '') = '') or (d.cd_grupo_material in (select m.cd_grupo_material from estrutura_material_v m where m.cd_material = a.cd_material)))
    )
	)
	OR (
		(((d.nr_seq_proc_interno IS NOT NULL AND d.nr_seq_proc_interno::text <> '') OR (d.cd_procedimento IS NOT NULL AND d.cd_procedimento::text <> '') OR (d.cd_grupo_proc IS NOT NULL AND d.cd_grupo_proc::text <> '') OR (d.cd_especialidade IS NOT NULL AND d.cd_especialidade::text <> '') OR (d.cd_area_procedimento IS NOT NULL AND d.cd_area_procedimento::text <> '')) AND ((d.cd_material IS NOT NULL AND d.cd_material::text <> '') OR (d.nr_seq_familia IS NOT NULL AND d.nr_seq_familia::text <> '') OR (d.cd_classe_material IS NOT NULL AND d.cd_classe_material::text <> '') OR (d.cd_subgrupo_material IS NOT NULL AND d.cd_subgrupo_material::text <> '') OR (d.cd_grupo_material IS NOT NULL AND d.cd_grupo_material::text <> '')))
    AND (a.cd_procedimento IN (
      SELECT p.cd_procedimento
      FROM procedimento_paciente p 
      where p.nr_interno_conta = nr_interno_conta_w
      and ((coalesce(d.cd_procedimento::text, '') = '') or (d.cd_procedimento = a.cd_procedimento))
      and   ((coalesce(d.nr_seq_proc_interno::text, '') = '') or (d.nr_seq_proc_interno = p.nr_seq_proc_interno))
		  and 	((coalesce(d.cd_grupo_proc::text, '') = '') or (d.cd_grupo_proc in (select e.cd_grupo_proc from estrutura_procedimento_v e where e.cd_procedimento = a.cd_procedimento and e.ie_origem_proced = a.ie_origem_proced)))
		  and 	((coalesce(d.cd_especialidade::text, '') = '') or (d.cd_especialidade in (select e.cd_especialidade from estrutura_procedimento_v e where e.cd_procedimento = a.cd_procedimento and e.ie_origem_proced = a.ie_origem_proced)))
		  and 	((coalesce(d.cd_area_procedimento::text, '') = '') or (d.cd_area_procedimento in (select e.cd_area_procedimento from estrutura_procedimento_v e where e.cd_procedimento = a.cd_procedimento and e.ie_origem_proced = a.ie_origem_proced)))
    ) 
    OR
    a.cd_material IN (
      SELECT p.cd_material
      FROM material_atend_paciente p 
      where p.nr_interno_conta = nr_interno_conta_w
    and   ((coalesce(d.cd_material::text, '') = '') or (d.cd_material = a.cd_material))
		and 	((coalesce(d.nr_seq_familia::text, '') = '') or (d.nr_seq_familia in (select m.nr_seq_familia from estrutura_material_v m where m.cd_material = a.cd_material)))
		and 	((coalesce(d.cd_classe_material::text, '') = '') or (d.cd_classe_material in (select m.cd_classe_material from estrutura_material_v m where m.cd_material = a.cd_material)))
		and 	((coalesce(d.cd_subgrupo_material::text, '') = '') or (d.cd_subgrupo_material in (select m.cd_subgrupo_material from estrutura_material_v m where m.cd_material = a.cd_material)))
		and 	((coalesce(d.cd_grupo_material::text, '') = '') or (d.cd_grupo_material in (select m.cd_grupo_material from estrutura_material_v m where m.cd_material = a.cd_material)))
    ))
	)
)
order by a.vl_cobrado, a.nr_sequencia;
BEGIN

select	max(cd_convenio)
into STRICT	cd_convenio_w
from	convenio_retorno
where	nr_sequencia = nr_lote_p;

select	max(ie_acao_glosa)
into STRICT	ie_acao_glosa_w
from	motivo_glosa
where	cd_motivo_glosa	= cd_motivo_glosa_p;

for cConta in cContas loop
	begin

		nr_seq_retorno_w := cConta.nr_sequencia;
		nr_interno_conta_w := cConta.nr_interno_conta;
		cd_autorizacao_w := cConta.cd_autorizacao;

		select count(*)
		into STRICT qt_itens_guia_w
		from CONVENIO_RETORNO_GLOSA
		where nr_seq_ret_item = nr_seq_retorno_w;

		if (qt_itens_guia_w > 0) then
			delete from convenio_retorno_glosa
			where nr_seq_ret_item = nr_seq_retorno_w;
		end if;

		for cMatItem in cMatItensToInsert loop
			begin
				insert into convenio_retorno_glosa(
				nr_sequencia,
				nr_seq_ret_item,
				vl_glosa,
				dt_atualizacao,
				nm_usuario,
				cd_material, 
				ie_atualizacao,
				cd_item_convenio, 
				qt_glosa, 
				cd_setor_atendimento, 
				nr_seq_matpaci, 
				ie_emite_conta, 
				vl_cobrado,
				qt_cobrada,
				cd_motivo_glosa) 
				values (
				nextval('convenio_retorno_glosa_seq'),
				nr_seq_retorno_w,
				0, 
				clock_timestamp(),
				nm_usuario_p,
				cMatItem.cd_material,
				'N',
				cMatItem.cd_material_convenio, 
				cMatItem.qt_material,
				cMatItem.cd_setor_atendimento, 
				cMatItem.nr_sequencia, 
				cMatItem.ie_emite_conta, 
				cMatItem.vl_material,
				cMatItem.qt_material,
				cd_motivo_glosa_p);
			end;
		end loop;

		for cProcItem in cProcItensToInsert loop
			begin
				insert into convenio_retorno_glosa(
				nr_sequencia,
				nr_seq_ret_item,
				vl_glosa,
				dt_atualizacao,
				nm_usuario,
				cd_procedimento, 
				ie_origem_proced, 
				ie_atualizacao,
				cd_item_convenio, 
				qt_glosa, 
				cd_setor_atendimento, 
				nr_seq_propaci, 
				ie_emite_conta, 
				vl_cobrado,
				qt_cobrada,
				cd_motivo_glosa) 
				values (
				nextval('convenio_retorno_glosa_seq'),
				nr_seq_retorno_w,
				0,
				clock_timestamp(),
				nm_usuario_p,
				cProcItem.cd_procedimento,
				cProcItem.ie_origem_proced,
				'N',
				cProcItem.cd_procedimento_convenio, 
				cProcItem.qt_procedimento,
				cProcItem.cd_setor_atendimento, 
				cProcItem.nr_sequencia, 
				cProcItem.ie_emite_conta, 
				cProcItem.vl_procedimento,
				cProcItem.qt_procedimento,
				cd_motivo_glosa_p);
			end;
		end loop;

		for cItemGlosadoWRules in cItensGlosadosWRules loop
      begin
        vl_sum_itens_vl_cobrado_w := vl_sum_itens_vl_cobrado_w + cItemGlosadoWRules.vl_cobrado;
        qt_itens_glosados_w := qt_itens_glosados_w + 1;
        if (cItemGlosadoWRules.vl_cobrado >= vl_item_maior_valor_w) then
          vl_item_maior_valor_w := cItemGlosadoWRules.vl_cobrado;
          nr_seq_item_maior_vl_w := cItemGlosadoWRules.nr_sequencia;
          nr_seq_guia_item_maior_vl_w := cConta.nr_sequencia;
        end if;
      end;
    end loop;
  end;

end loop;

if (qt_itens_glosados_w = 0) then
  CALL wheb_mensagem_pck.exibir_mensagem_abort(1167437);
end if;

if (vl_sum_itens_vl_cobrado_w < vl_glosa_p) then
  CALL wheb_mensagem_pck.exibir_mensagem_abort(1167449, 'VL_RATEIO='||vl_glosa_p);
end if;

for cConta in cContas loop
	begin
	
		nr_seq_retorno_w := cConta.nr_sequencia;
		nr_interno_conta_w := cConta.nr_interno_conta;
		cd_autorizacao_w := cConta.cd_autorizacao;
		vl_guia_cheio_w := cConta.vl_guia;
		vl_glosa_final_w := 0;
		vl_sum_items_acao_glosados_w := 0;
		vl_sum_items_acao_amenor_w := 0;
		vl_sum_items_calc_glosa_w := 0;

		for cItemGlosadoWRules in cItensGlosadosWRules loop
		begin

			vl_cobrado_w := cItemGlosadoWRules.vl_cobrado;

			--Se for o ultimo item (de maior valor), leva a soma dos itens anteriores
			if (cItemGlosadoWRules.nr_sequencia = nr_seq_item_maior_vl_w) then
				vl_glosa_final_w := vl_glosa_p - vl_sum_items_tot_w;
				vl_sum_items_calc_glosa_w := vl_sum_items_calc_glosa_w + vl_glosa_final_w;
			else
				if (vl_sum_itens_vl_cobrado_w > 0) then
					vl_glosa_final_w := round(vl_cobrado_w * (vl_glosa_p / vl_sum_itens_vl_cobrado_w),2);
					vl_sum_items_calc_glosa_w := vl_sum_items_calc_glosa_w + vl_glosa_final_w;
					vl_sum_items_tot_w := vl_sum_items_tot_w + vl_glosa_final_w;
				end if;
			end if;

			if (ie_acao_glosa_w = 'A') then
				vl_sum_items_acao_glosados_w := vl_sum_items_acao_glosados_w + vl_glosa_final_w;
			else
				vl_sum_items_acao_amenor_w := vl_sum_items_acao_amenor_w + vl_glosa_final_w;
			end if;

			update	convenio_retorno_glosa
			set 	vl_glosa = vl_glosa_final_w,
				dt_atualizacao = clock_timestamp(),
				dt_atualizacao_nrec = clock_timestamp(),
				cd_motivo_glosa = cd_motivo_glosa_p,
				ie_acao_glosa = ie_acao_glosa_w
			where	nr_sequencia = cItemGlosadoWRules.nr_sequencia;
		end;
		end loop;

		delete from convenio_retorno_glosa
		where	 nr_seq_ret_item = nr_seq_retorno_w
		and vl_glosa = 0;

		update	convenio_retorno_item
		set 	vl_glosado = 0,
			vl_amenor = 0,
			vl_pago = (vl_guia_cheio_w - vl_sum_items_calc_glosa_w)
		where	nr_sequencia = nr_seq_retorno_w;

		if (vl_sum_items_acao_glosados_w > 0) then
			update	convenio_retorno_item
			set 	vl_glosado = vl_sum_items_acao_glosados_w
			where	nr_sequencia = nr_seq_retorno_w;
		end if;

		if (vl_sum_items_acao_amenor_w > 0) then
			update	convenio_retorno_item
			set 	vl_amenor = vl_sum_items_acao_amenor_w
			where	nr_sequencia = nr_seq_retorno_w;
		end if;
	end;
end loop;

update	convenio_retorno
set 	vl_rateio_glosa = 0
where	nr_sequencia = nr_lote_p;

if (vl_sum_items_acao_glosados_w > 0) then
	update	convenio_retorno
	set	vl_rateio_glosa = vl_sum_items_acao_glosados_w
	where	nr_sequencia = nr_lote_p;
end if;

commit;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calc_regra_glosa_proc ( nr_lote_p bigint, vl_glosa_p bigint, nm_usuario_p text, cd_motivo_glosa_p convenio_retorno_glosa.cd_motivo_glosa%type ) FROM PUBLIC;

