-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_hematocritos_hemot ( pr_hematocrito_p bigint, cd_pessoa_fisica_p text, cd_estabelecimento_p bigint, nm_usuario_p text, ds_atributo_focus_p INOUT text, ds_mens_hemat_p INOUT text, ds_erro_p INOUT text, qt_dias_inaptidao_p INOUT bigint, vl_questionario_p text default 'N') AS $body$
DECLARE


ie_bloquear_pr_hematocrito_w	varchar(1);
ie_sexo_w			varchar(1);
pr_hemat_min_fem_w		double precision;
pr_hemat_max_fem_w		double precision;
pr_hemat_min_mas_w		double precision;
pr_hemat_max_mas_w		double precision;
qt_dias_inapto_hemat_f_w	san_parametro.qt_dias_inapto_hemat_f%type;
qt_dias_inapto_hemat_m_w	san_parametro.qt_dias_inapto_hemat_m%type;


BEGIN

if (pr_hematocrito_p IS NOT NULL AND pr_hematocrito_p::text <> '') then
	begin
	select	ie_sexo
	into STRICT	ie_sexo_w
	from	pessoa_fisica
	where	cd_pessoa_fisica = cd_pessoa_fisica_p;

	select	max(pr_hemat_min_fem),
		max(pr_hemat_max_fem),
		max(pr_hemat_min_mas),
		max(pr_hemat_max_mas),
		max(qt_dias_inapto_hemat_f),
		max(qt_dias_inapto_hemat_m)
	into STRICT	pr_hemat_min_fem_w,
		pr_hemat_max_fem_w,
		pr_hemat_min_mas_w,
		pr_hemat_max_mas_w,
		qt_dias_inapto_hemat_f_w,
		qt_dias_inapto_hemat_m_w
	from	san_parametro
	where	cd_estabelecimento = cd_estabelecimento_p;

	/* Hemoterapia - Parametro [211] - Bloquear doador fora da faixa do percentual de hematacritos */

	ie_bloquear_pr_hematocrito_w := obter_param_usuario(450, 211, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_bloquear_pr_hematocrito_w);

	if (ie_sexo_w = 'M') then
		begin
		if (pr_hemat_min_mas_w IS NOT NULL AND pr_hemat_min_mas_w::text <> '') and (pr_hematocrito_p < pr_hemat_min_mas_w) then
			begin		
			qt_dias_inaptidao_p 	:= qt_dias_inapto_hemat_m_w;
			if (VL_QUESTIONARIO_P = 'S' or  ie_bloquear_pr_hematocrito_w = 'S') then
				begin				
				ds_atributo_focus_p	:= 'PR_HEMATOCRITO';
				ds_erro_p		:= obter_texto_dic_objeto(75494, wheb_usuario_pck.get_nr_seq_idioma, 'PR_HEMAT_MIN_MAS=' || pr_hemat_min_mas_w);
				end;
			else
				ds_mens_hemat_p	:= obter_texto_dic_objeto(75494, wheb_usuario_pck.get_nr_seq_idioma, 'PR_HEMAT_MIN_MAS=' || pr_hemat_min_mas_w);
			end if;
			end;

		elsif (pr_hemat_max_mas_w IS NOT NULL AND pr_hemat_max_mas_w::text <> '') and (pr_hematocrito_p > pr_hemat_max_mas_w) then
			begin
			qt_dias_inaptidao_p 	:= qt_dias_inapto_hemat_m_w;
			if (VL_QUESTIONARIO_P = 'S' or  ie_bloquear_pr_hematocrito_w = 'S') then
				begin				
				ds_atributo_focus_p	:= 'PR_HEMATOCRITO';
				ds_erro_p		:= obter_texto_dic_objeto(75496, wheb_usuario_pck.get_nr_seq_idioma, 'PR_HEMAT_MAX_MAS=' || pr_hemat_max_mas_w);
				end;
			else
				ds_mens_hemat_p	:= obter_texto_dic_objeto(75496, wheb_usuario_pck.get_nr_seq_idioma, 'PR_HEMAT_MAX_MAS=' || pr_hemat_max_mas_w);
			end if;
			end;
		end if;
		end;

	elsif (ie_sexo_w = 'F') then
		begin
		if (pr_hemat_min_fem_w IS NOT NULL AND pr_hemat_min_fem_w::text <> '') and (pr_hematocrito_p < pr_hemat_min_fem_w) then
			begin
			qt_dias_inaptidao_p 	:= qt_dias_inapto_hemat_f_w;
			if (VL_QUESTIONARIO_P = 'S' or  ie_bloquear_pr_hematocrito_w = 'S') then
				begin
				ds_atributo_focus_p	:= 'PR_HEMATOCRITO';
				ds_erro_p		:= obter_texto_dic_objeto(75497, wheb_usuario_pck.get_nr_seq_idioma, 'PR_HEMAT_MIN_FEM=' || pr_hemat_min_fem_w);
				end;
			else
				ds_mens_hemat_p	:= obter_texto_dic_objeto(75497, wheb_usuario_pck.get_nr_seq_idioma, 'PR_HEMAT_MIN_FEM=' || pr_hemat_min_fem_w);
			end if;
			end;

		elsif (pr_hemat_max_fem_w IS NOT NULL AND pr_hemat_max_fem_w::text <> '') and (pr_hematocrito_p > pr_hemat_max_fem_w) then
			begin
			qt_dias_inaptidao_p 	:= qt_dias_inapto_hemat_f_w;
			if (VL_QUESTIONARIO_P = 'S' or  ie_bloquear_pr_hematocrito_w = 'S') then
				begin
				ds_atributo_focus_p	:= 'PR_HEMATOCRITO';
				ds_erro_p		:= obter_texto_dic_objeto(75498, wheb_usuario_pck.get_nr_seq_idioma, 'PR_HEMAT_MAX_FEM=' || pr_hemat_max_fem_w);
				end;
			else
				ds_mens_hemat_p	:= obter_texto_dic_objeto(75498, wheb_usuario_pck.get_nr_seq_idioma, 'PR_HEMAT_MAX_FEM=' || pr_hemat_max_fem_w);
			end if;
			end;
		end if;
		end;
	end if;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_hematocritos_hemot ( pr_hematocrito_p bigint, cd_pessoa_fisica_p text, cd_estabelecimento_p bigint, nm_usuario_p text, ds_atributo_focus_p INOUT text, ds_mens_hemat_p INOUT text, ds_erro_p INOUT text, qt_dias_inaptidao_p INOUT bigint, vl_questionario_p text default 'N') FROM PUBLIC;

