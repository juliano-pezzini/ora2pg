-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_versao_criar_integridade ( nm_tabela_p text, nm_integridade_p text, ie_enterprise_p text, nr_ordem_p text, ie_paralelism_p boolean default false) AS $body$
DECLARE


nm_atributo_w          		varchar(50)      := '';
nm_tabela_referencia_w		varchar(50)	:= '';
ie_regra_delecao_w		varchar(15)	:= '';
ds_virgula_w			varchar(01)	:= '';
ds_comando_w			varchar(2000);
vl_retorno_w			varchar(255);
nm_atributo_ref_w		varchar(50);
ds_ref_w			varchar(2000);
qt_indice_w			bigint;
C010				integer;
C020				integer;
retorno_w			integer;
ds_comando_bv_w		varchar(4000);
nm_fase_w       cloud_upgrade_log.nm_fase_atualizacao%type := 'TASY_VERSAO_CRIAR_INTEGRIDADE';
nm_paralelism_w     varchar(1000);


BEGIN
select	count(*)
into STRICT	qt_indice_w
from	user_indexes
where	upper(index_name) = upper(nm_integridade_p)||'_I';

if (qt_indice_w = 0) then
    ds_comando_bv_w := 'select count(1)
    from TASY_VERSAO.integridade_atributo a,
    TASY_VERSAO.indice_atributo b
    where a.nm_atributo = b.nm_atributo
    and a.nm_tabela = b.nm_tabela
    and B.Nr_Sequencia = A.Ie_Sequencia_Criacao
    and a.nm_integridade_referencial = :nm_integridade_p';
    EXECUTE  ds_comando_bv_w into STRICT qt_indice_w using nm_integridade_p;
end if;

if (qt_indice_w > 0) then

	ds_comando_bv_w:= ' select	nm_tabela_referencia, ' ||
							' ie_regra_delecao ' 		||
					' from	tasy_versao.integridade_referencial  '  ||
					' where	nm_tabela = :nm_tabela_p ' ||
					' and	nm_integridade_referencial = :nm_integridade_p ';
	EXECUTE ds_comando_bv_w
	INTO STRICT	nm_tabela_referencia_w, ie_regra_delecao_w using nm_tabela_p, nm_integridade_p;	

	ds_comando_w	:= 'Alter Table ' || nm_tabela_p || ' add (constraint ';
	ds_comando_w	:= ds_comando_w  || nm_integridade_p || ' foreign key ( ';
	ds_virgula_w	:= '';
	ds_ref_w	:= '';	

	ds_comando_bv_w:=  ' SELECT nm_atributo, '||
							' nm_atributo_ref '||
					' FROM 	tasy_versao.integridade_atributo '||
					' where nm_tabela = :nm_tabela_p '||
					' and	nm_integridade_referencial	= :nm_integridade_p '||
					' order by ie_sequencia_criacao ';

	C010 := dbms_sql.open_cursor;
	dbms_sql.parse(C010, ds_comando_bv_w, dbms_sql.native);
	dbms_sql.define_column(C010, 1, nm_atributo_w, 50);	
	dbms_sql.define_column(C010, 2, nm_atributo_ref_w, 50);	
	dbms_sql.bind_variable(C010, 'NM_TABELA_P', nm_tabela_p,255);
	dbms_sql.bind_variable(C010, 'NM_INTEGRIDADE_P', nm_integridade_p,255);
	retorno_w := dbms_sql.execute(C010);

	while( dbms_sql.fetch_rows(C010) > 0 ) loop		
		dbms_sql.column_value(C010, 1, nm_atributo_w);
		dbms_sql.column_value(C010, 2, nm_atributo_ref_w);
		ds_comando_w	:= ds_comando_w  || ds_virgula_w || nm_atributo_w;
		if (nm_atributo_ref_w IS NOT NULL AND nm_atributo_ref_w::text <> '') then
			ds_ref_w	:= ds_ref_w || ds_virgula_w || nm_atributo_ref_w;
		end if;
		ds_virgula_w	:= ',';

	end loop;
	dbms_sql.close_cursor(C010);		

	ds_comando_w	:= ds_comando_w  || ')';
	ds_comando_w	:= ds_comando_w  || ' references ' || nm_tabela_referencia_w || '(';
	ds_virgula_w	:= '';

	ds_comando_bv_w:=  ' SELECT nm_atributo '||
					' FROM 	tasy_versao.Indice_Atributo b, '||
					' 		tasy_versao.indice a '||					
					' where a.nm_tabela = :nm_tabela_ref_p '||
					' and a.nm_indice	= b.nm_indice '||
					' and a.nm_tabela	= b.nm_tabela '||
					' and a.ie_tipo		=  :ie_tipo_p ' ||
					' and '||chr(39)||ds_ref_w||chr(39)|| ' is null ' ||
					' order by nr_sequencia ';

	C020 := dbms_sql.open_cursor;
	dbms_sql.parse(C020, ds_comando_bv_w, dbms_sql.native);
	dbms_sql.define_column(C020, 1, nm_atributo_w, 50);	
	dbms_sql.bind_variable(C020, 'NM_TABELA_REF_P', nm_tabela_referencia_w,255);
	dbms_sql.bind_variable(C020, 'IE_TIPO_P', 'PK',10);
	retorno_w := dbms_sql.execute(C020);

	while( dbms_sql.fetch_rows(C020) > 0 ) loop
		dbms_sql.column_value(C020, 1, nm_atributo_w);
		ds_comando_w	:= ds_comando_w  || ds_virgula_w || nm_atributo_w;
		ds_virgula_w	:= ',';				
	end loop;
	dbms_sql.close_cursor(C020);							

	if (ds_ref_w IS NOT NULL AND ds_ref_w::text <> '') then
		ds_comando_w	:= ds_comando_w  || ds_ref_w;
	end if;
	ds_comando_w	:= ds_comando_w  || ')';
	if (ie_regra_delecao_w = 'CASCADE') then
		ds_comando_w	:= ds_comando_w  || ' ON DELETE CASCADE';
	end if;

	ds_comando_w	:= ds_comando_w  || ' novalidate) ';

	if (ie_enterprise_p = 'S') then
        if (ie_paralelism_p) then
            nm_paralelism_w := ' PARALLEL ';
        end if;
		ds_comando_w	:= ds_comando_w  || nm_paralelism_w;
	end if;

	insert into TABELA_VERSAO_OFFLINE_W(nr_sequencia, nr_ordem, ds_comando, ds_log) values (nextval('tabela_versao_offline_w_seq'),nr_ordem_p,ds_comando_w,'D');			
	commit;
    CALL insert_log_cloud(null,null, 'atualizacao', nm_fase_w||'_LOG', null, nm_fase_w);

end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_versao_criar_integridade ( nm_tabela_p text, nm_integridade_p text, ie_enterprise_p text, nr_ordem_p text, ie_paralelism_p boolean default false) FROM PUBLIC;

