-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_ag_int_apr_item_prescr (nr_prescricao_p bigint) AS $body$
DECLARE


cd_material_w				bigint;
nr_atendimento_w			bigint;
nr_seq_lote_w				ap_lote.nr_sequencia%type;
ds_param_integ_hl7_w		varchar(4000) := '';
ie_existe_w					varchar(1) := 'N';
nr_seq_empresa_w			empresa_integracao.nr_sequencia%type;
cd_setor_atendimento_w		bigint;
nr_seq_material_hl7_w       prescr_material.nr_sequencia%type;

c01 CURSOR FOR
	SELECT	distinct
			c.cd_material,
			a.nr_atendimento,
			a.nr_seq_lote,
			c.nr_sequencia
	from    prescr_mat_hor a,
		prescr_medica b,
		prescr_material c,
		estrutura_material_v s,
		material e
	where	(a.nr_seq_lote IS NOT NULL AND a.nr_seq_lote::text <> '')
	and		a.cd_material = s.cd_material
	and		a.nr_prescricao = b.nr_prescricao
	and		c.nr_prescricao = b.nr_prescricao
	and		a.nr_seq_material = c.nr_sequencia
	and		a.nr_prescricao = nr_prescricao_p
	and		a.cd_material = e.cd_material
	and		c.ie_suspenso <> 'S'
	and		coalesce(a.dt_suspensao::text, '') = ''
	and		exists (	SELECT	1
					from	ap_lote x,
							classif_lote_disp_far y
					where	x.nr_sequencia = a.nr_seq_lote
					and 	coalesce(x.ie_integracao, 'N') <> 'P'
					and		y.nr_sequencia = x.nr_seq_classif
					and		y.ie_classif_urgente = 'A'
					and		coalesce(x.dt_atend_farmacia::text, '') = '')
	and	exists(	select  1
				from 	regra_local_dispensacao x
				where 	x.cd_estabelecimento  = b.cd_estabelecimento
				and	x.cd_setor_atendimento  = b.cd_setor_atendimento
				and	x.nr_sequencia 	= coalesce(a.nr_regra_local_disp, c.nr_seq_regra_local)
				and 	coalesce(x.nr_seq_classif,a.nr_seq_classif) = a.nr_seq_classif
				and 	((x.cd_material   = s.cd_material) or (x.cd_grupo_material  = s.cd_grupo_material) or (x.cd_subgrupo_material = s.cd_subgrupo_material) or (x.cd_classe_material  = s.cd_classe_material) or ((x.nr_seq_estrut_int IS NOT NULL AND x.nr_seq_estrut_int::text <> '') and consistir_se_mat_contr_estrut(x.nr_seq_estrut_int, s.cd_material) = 'S')));


BEGIN

select	max(cd_setor_atendimento)
into STRICT	cd_setor_atendimento_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;
			
begin
select	'S'
into STRICT	ie_existe_w
from	far_setores_integracao
where	nr_seq_empresa_int = 82
and	cd_setor_atendimento = cd_setor_atendimento_w;
exception
when others then
	nr_seq_empresa_w := 0;
	ie_existe_w := 'N';
end;
		
if (ie_existe_w = 'S') then

	open c01;
	loop
	fetch c01 into
		cd_material_w,
		nr_atendimento_w,
		nr_seq_lote_w,
		nr_seq_material_hl7_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		ds_param_integ_hl7_w := 'nr_atendimento=' || nr_atendimento_w || obter_separador_bv ||
					'nr_prescricao=' || nr_prescricao_p || obter_separador_bv ||
					'nr_seq_lote=' || nr_seq_lote_w || obter_separador_bv ||
					'cd_material_presc=' || cd_material_w || obter_separador_bv ||
					'ie_aprazado=' || 'GPMH' || obter_separador_bv ||
					'ie_origem=' || 'GLAP' || obter_separador_bv||
          			'nr_seq_material=' || nr_seq_material_hl7_w || obter_separador_bv;				
		CALL gravar_agend_integracao(434,ds_param_integ_hl7_w, cd_setor_atendimento_w);
		end;
	end loop;
	close c01;
	open C01;
	loop
	fetch C01 into	
		cd_material_w,
		nr_atendimento_w,
		nr_seq_lote_w,
		nr_seq_material_hl7_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		update ap_lote
		set	ie_integracao = 'P'
		where	nr_sequencia = nr_seq_lote_w;
		end;
	end loop;
	close C01;

end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_ag_int_apr_item_prescr (nr_prescricao_p bigint) FROM PUBLIC;

