-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_importar_w_cad_unimed ( nm_usuario_p text, cd_estabelecimento_p bigint, nr_sequencia_p bigint) AS $body$
DECLARE


ds_linha_w			varchar(4000);
ds_endereco_w			varchar(4000);
ds_area_acao_w			varchar(4000);
ds_conteudo_w			varchar(4000);
ds_valor_w			varchar(2000);
ds_valor_ww			varchar(2000);
ds_grupo_w			varchar(255);
ds_razao_social_w		varchar(255);
nm_fantasia_w			varchar(255);
ds_hierarquia_1_w		varchar(255);
ds_hierarquia_2_w		varchar(255);
ds_hierarquia_3_w		varchar(255);
ds_hierarquia_4_w		varchar(255);
ds_hierarquia_5_w		varchar(255);
ds_bairro_w			varchar(255);
ds_cidade_w			varchar(255);
cd_ans_w			varchar(255);
ds_email_w			varchar(255);
ds_site_w			varchar(255);
ds_dirigente_w			varchar(255);
ds_cargo_dirigente_w		varchar(255);
ds_tipo_prestador_w		varchar(255);
ie_tipo_fone_1_w		varchar(100);
ie_tipo_fone_w			varchar(100);
nr_telefone_1_w			varchar(40);
nr_telefone_2_w			varchar(40);
nr_inscr_estadual_w		varchar(30);
nr_inscr_municipal_w		varchar(30);
cd_cep_w			varchar(15);
cd_cgc_w			varchar(14);
cd_complexo_w			varchar(10);
ds_codigo_w			varchar(3);
ie_existente_w			varchar(1);
qt_cooperados_w			bigint;
qt_usuarios_w			bigint;
qt_funcionarios_w		bigint;
nr_seq_conteudo			bigint;
contador_w  			integer	:= 0;
contador_coop_w			integer	:= 0;
ie_layout_w			smallint	:= null;
dt_fundacao_w			timestamp;
dt_inicio_mandato_w		timestamp;
dt_fim_mandato_w		timestamp;

C01 CURSOR FOR
	SELECT	a.ds_conteudo
	from	w_pls_carga_cad_unimed a
	where	a.nm_usuario	= nm_usuario_p
	and	substr(a.ds_conteudo,1,32) <> 'GRUPO;COD_COMPLEXO;RAZAO_SOCIAL;'
	and	substr(a.ds_conteudo,1,30) <> 'CÓDIGO DA UNIMED;RAZÃO SOCIAL;' -- Funciona no Delphi
	and	substr(a.ds_conteudo,1,30) <> 'C¿DIGO DA UNIMED;RAZ¿O SOCIAL;' -- Por causa de encode de HTML5
	and	position('Cadastro de Unimeds' in ds_conteudo) = 0
	order 	by nr_sequencia;


BEGIN
delete	from pls_cad_unimed_inconsist
where	nr_seq_cad_unimed in (	SELECT	nr_sequencia
				from	pls_w_import_cad_unimed
				where	nr_seq_lote = nr_sequencia_p);

delete	from pls_w_import_cad_unimed
where	nr_seq_lote = nr_sequencia_p;

commit;

open C01;
loop
fetch C01 into
	ds_conteudo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ds_linha_w	:= ds_conteudo_w;
	contador_w	:= 0;
	
	begin
	select	(substr(ds_conteudo_w,1,1))::numeric
	into STRICT	ds_codigo_w
	;
	exception
	when others then
		ie_layout_w	:= 1;
	end;
	
	if (coalesce(ie_layout_w::text, '') = '') then
		ie_layout_w	:= 2;
	end if;
	
	if (ie_layout_w = 1) then
		-- GRUPO;COD_COMPLEXO;RAZAO_SOCIAL;NOME_FANTASIA;TIPO_OPERADORA;IERARQUIA1;IERARQUIA2;IERARQUIA3;IERARQUIA4;IERARQUIA5;ENDERECO;BAIRRO;CIDADE;ESTADO;CEP;CNPJ;INSCRICAO_ESTADUAL;INSCRICAO_MUNICIPAL;REGISTRO_ANS;DATA_FUNDACAO;

		-- TELEFONE1;TIPO_TELEFONE1;TELEFONE2;TIPO_TELEFONE2;EMAIL;WEB_SITE;PRESIDENTE;CARGO_PRESIDENTE;DATA_INICIO_MANDATO;DATA_FIM_MANDATO;AREA_ACAO;QUANT_COOPERADOS;QUANT_USUARIOS;QUANT_FUNCIONARIOS;
		CALL pls_gerar_w_cad_unimed_v1(ds_linha_w, nr_sequencia_p, nm_usuario_p);
	else
		-- CÓDIGO DA UNIMED;RAZÃO SOCIAL;NOME FANTASIA;TIPO DE COOPERATIVA;TIPO DE ATUAÇÃO;GRAU DA COOPERATIVA;HIERARQUIA 1;HIERARQUIA 2;HIERARQUIA 3;ENDEREÇO;BAIRRO;CIDADE;CEP;ESTADO;REGIÃO;LOCALIDADE;CNPJ;INSCRIÇÃO ESTADUAL;INSCRIÇÃO MUNICIPAL;

		--REGISTRO ANS;DATA DA FUNDAÇÃO;RAMAL;TELEFONE;FAX;EMAIL;WEB SITE;PRESIDENTE; DATA DE INÍCIO DO MANDATO; DATA DE FIM DO MANDATO; ÁREA DE AÇÃO;QUANTIDADE DE FUNCIONÁRIOS;COOPERADOS TOTAL;QUANTIDADE DE BENEFICIÁRIOS;PORTE;STATUS;DATA DE INATIVAÇÃO;

		--OBSERVAÇÃO
		CALL pls_gerar_w_cad_unimed_v2(ds_linha_w, nr_sequencia_p, nm_usuario_p);
	end if;
	end;
end loop;
close C01;

delete from w_pls_carga_cad_unimed;

update	pls_lote_importacao_unimed
set	dt_processamento	= clock_timestamp(),
	nm_usuario		= nm_usuario_p,
	dt_atualizacao		= clock_timestamp()
where	nr_sequencia		= nr_sequencia_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_importar_w_cad_unimed ( nm_usuario_p text, cd_estabelecimento_p bigint, nr_sequencia_p bigint) FROM PUBLIC;

