-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gravar_campo_solic_alter ( nm_tabela_p text, nm_campo_p text, ds_valor_p text, cd_pessoa_p text, ie_tipo_compl_p text, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_prestador_p pls_prestador.nr_sequencia%type) AS $body$
DECLARE

				 
ds_update_w			varchar(4000) := null;
nr_seq_complemento_w		bigint;
nr_seq_tipo_compl_adic_w	bigint;
nr_seq_compl_pf_tel_adic_w	pls_prestador.nr_seq_compl_pf_tel_adic%type;
nr_seq_compl_w			compl_pf_tel_adic.nr_seq_compl%type;
nr_seq_conta_w			bigint;


BEGIN 
if (upper(nm_tabela_p) = upper('PESSOA_JURIDICA')) then 
	ds_update_w	:= 	' update pessoa_juridica ' || 
				' set ' || nm_campo_p || ' = ' || chr(39) || ds_valor_p || chr(39) || ',' || 
				' 	nm_usuario = ' || chr(39) || nm_usuario_p || chr(39) || ',' || 
				' 	dt_atualizacao = sysdate ' || 
				' where	cd_cgc = ' || chr(39) || cd_pessoa_p || chr(39);
elsif (upper(nm_tabela_p) = upper('PESSOA_JURIDICA_CONTA')) then 
	select	max(nr_sequencia) 
	into STRICT	nr_seq_conta_w 
	from	pessoa_juridica_conta 
	where	ie_situacao	= 'A' 
	and	cd_cgc	 	= cd_pessoa_p;
 
	ds_update_w	:= 	' update pessoa_juridica_conta ' || 
				' set 	' || nm_campo_p || ' = ' || chr(39) || ds_valor_p || chr(39) || ',' || 
				' 	nm_usuario = ' || chr(39) || nm_usuario_p || chr(39) || ',' || 
				' 	dt_atualizacao = sysdate ' || 
				' where cd_cgc = ' || chr(39) || cd_pessoa_p || chr(39) || 
				' and	nr_sequencia = ' || nr_seq_conta_w;
elsif (upper(nm_tabela_p) = upper('PESSOA_JURIDICA_ESTAB')) then 
	ds_update_w	:= 	' update 	pessoa_juridica_estab ' || 
				' set	' || nm_campo_p || ' = ' || chr(39) || ds_valor_p || chr(39) || ',' || 
				' 	nm_usuario = ' || chr(39) || nm_usuario_p || chr(39) || ',' || 
				' 	dt_atualizacao = sysdate ' || 
				' where	cd_cgc = ' || chr(39) || cd_pessoa_p || chr(39);
elsif (upper(nm_tabela_p) = upper('PESSOA_JURIDICA_COMPL')) then 
	--Atendimento 
	if (ie_tipo_compl_p = 6) then 
	 
		if (nr_seq_prestador_p IS NOT NULL AND nr_seq_prestador_p::text <> '') then 
		 
			select	max(nr_seq_compl_pj) 
			into STRICT	nr_seq_complemento_w 
			from 	pls_prestador 
			where 	nr_sequencia	 = nr_seq_prestador_p;
		end if;
		 
		-- se não foi informado o sequencial, ou se não foi encontrado, mantem a pesquisa "padrão" 
		if (coalesce(nr_seq_prestador_p::text, '') = '') or (coalesce(nr_seq_complemento_w::text, '') = '') then 
		 
			select	max(nr_seq_compl_pj) 
			into STRICT	nr_seq_complemento_w 
			from 	pls_prestador 
			where 	cd_cgc	 = cd_pessoa_p;
		end if;
	--Correspondência ou financeiro 
	elsif (ie_tipo_compl_p = 1 or ie_tipo_compl_p = 2) then 
		select 	max(nr_sequencia) 
		into STRICT	nr_seq_complemento_w 
		from	pessoa_juridica_compl a 
		where	a.cd_cgc		= cd_pessoa_p 
		and	a.ie_tipo_complemento 	= ie_tipo_compl_p;	
	end if;
 
	ds_update_w	:= 	' update 	pessoa_juridica_compl ' || 
				' set	' || nm_campo_p || ' = ' || chr(39) || ds_valor_p || chr(39) || ',' || 
				'	nm_usuario = ' || chr(39) || nm_usuario_p || chr(39) || ',' || 
				'	dt_atualizacao = sysdate ' || 
				' where	cd_cgc = ' || chr(39) || cd_pessoa_p || chr(39) || 
				' and	ie_tipo_complemento = ' || chr(39) || ie_tipo_compl_p || chr(39) || 
				' and	nr_sequencia = ' || chr(39) || nr_seq_complemento_w || chr(39);	
elsif (upper(nm_tabela_p) = upper('COMPL_PF_TEL_ADIC')) then	 
	select	max(a.nr_seq_compl_pf_tel_adic) 
	into STRICT	nr_seq_compl_pf_tel_adic_w 
	from	pls_prestador a 
	where	a.cd_pessoa_fisica	= cd_pessoa_p;
		 
	ds_update_w	:= 	' update 	compl_pf_tel_adic ' || 
				' set	' || nm_campo_p || ' = ' || chr(39) || ds_valor_p || chr(39) || ',' || 
				'	nm_usuario = ' || chr(39) || nm_usuario_p || chr(39) || ',' || 
				'	dt_atualizacao = sysdate ' || 
				' where	cd_pessoa_fisica = ' || chr(39) || cd_pessoa_p || chr(39) || 		 
				' and 	nr_sequencia = ' || chr(39) || nr_seq_compl_pf_tel_adic_w || chr(39);	
			 
elsif (upper(nm_tabela_p) = upper('PESSOA_FISICA')) then 
	ds_update_w	:= 	' update	pessoa_fisica ' || 
				' set	' || nm_campo_p || ' = ' || chr(39) || ds_valor_p || chr(39) || ',' || 
				'	nm_usuario = ' || chr(39) || nm_usuario_p || chr(39) || ',' || 
				'	dt_atualizacao = sysdate ' || 
				' where	cd_pessoa_fisica = ' || chr(39) || cd_pessoa_p || chr(39);
elsif (upper(nm_tabela_p) = upper('PESSOA_FISICA_CONTA')) then 
	select	max(nr_sequencia) 
	into STRICT	nr_seq_conta_w 
	from	pessoa_fisica_conta 
	where	ie_situacao		= 'A' 
	and	cd_pessoa_fisica 	= cd_pessoa_p;
 
	ds_update_w	:= 	' update	pessoa_fisica_conta ' || 
				' set	' || nm_campo_p || ' = ' || chr(39) || ds_valor_p || chr(39) || ',' || 
				'	nm_usuario = ' || chr(39) || nm_usuario_p || chr(39) || ',' || 
				'	dt_atualizacao = sysdate ' || 
				' where	cd_pessoa_fisica = ' || chr(39) || cd_pessoa_p || chr(39) || 
				' and	nr_sequencia = ' || nr_seq_conta_w;
elsif (upper(nm_tabela_p) = upper('COMPL_PESSOA_FISICA')) then 
	ds_update_w	:= 	' update	compl_pessoa_fisica ' || 
				' set	' || nm_campo_p || ' = ' || chr(39) || ds_valor_p || chr(39) || ',' || 
				'	nm_usuario = ' || chr(39) || nm_usuario_p || chr(39) || ',' || 
				'	dt_atualizacao = sysdate ' || 
				' where	cd_pessoa_fisica = ' || chr(39) || cd_pessoa_p || chr(39) || 
				' and	ie_tipo_complemento = ' || chr(39) || ie_tipo_compl_p || chr(39);
	--Adicional 
	if (ie_tipo_compl_p = 9) then 
		select 	max(nr_seq_tipo_compl_adic) 
		into STRICT	nr_seq_tipo_compl_adic_w 
		from 	pls_prestador 
		where 	cd_pessoa_fisica = cd_pessoa_p;
					 
	ds_update_w	:= ds_update_w || ' and nr_seq_tipo_compl_adic = ' || chr(39) || nr_seq_tipo_compl_adic_w || chr(39);
	end if;			
elsif (upper(nm_tabela_p) = upper('MEDICO')) then 
	ds_update_w	:= 	' update	medico ' || 
				' set	' || nm_campo_p || ' = ' || chr(39) || ds_valor_p || chr(39) || ',' || 
				'	nm_usuario = ' || chr(39) || nm_usuario_p || chr(39) || ',' || 
				'	dt_atualizacao = sysdate ' || 
				' where	cd_pessoa_fisica = ' || chr(39) || cd_pessoa_p || chr(39);			
end if;
 
if (ds_update_w IS NOT NULL AND ds_update_w::text <> '') then 
	CALL exec_sql_dinamico(nm_usuario_p, ds_update_w);
	 
	commit;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gravar_campo_solic_alter ( nm_tabela_p text, nm_campo_p text, ds_valor_p text, cd_pessoa_p text, ie_tipo_compl_p text, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_prestador_p pls_prestador.nr_sequencia%type) FROM PUBLIC;

