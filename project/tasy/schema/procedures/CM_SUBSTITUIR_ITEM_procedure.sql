-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cm_substituir_item ( nr_seq_item_subst_p bigint, nr_seq_conj_subst_p bigint, nr_seq_conjunto_p bigint, nr_seq_item_p bigint, nr_seq_item_cont_p bigint, ie_opcao_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_sequencia_w			bigint;
ie_indispensavel_w		varchar(1);
nr_seq_interno_w		bigint;
qt_item_w			double precision;
cd_codigo_item_w		varchar(255);
ie_forma_gerar_cod_w		varchar(15);
nr_seq_conjunto_cont_w		bigint;
nr_seq_cont_w			bigint;
nr_seq_conj_subst_w		bigint;
nr_seq_item_w			bigint;
ie_status_w			varchar(15);


BEGIN

if (ie_opcao_p = 'S') then
	begin

	select	nextval('cm_conjunto_item_sub_seq')
	into STRICT	nr_sequencia_w
	;

	insert into cm_conjunto_item_sub(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_conjunto,
		nr_seq_item,
		nr_seq_conjunto_sub,
		nr_seq_item_sub,
		dt_inicio_vigencia)
	values (nr_sequencia_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_conjunto_p,
		nr_seq_item_p,
		nr_seq_conj_subst_p,
		nr_seq_item_subst_p,
		clock_timestamp());

	update	cm_conjunto_item
	set	ie_status_item = '2'
	where	nr_seq_conjunto = nr_seq_conjunto_p
	and	nr_seq_item = nr_seq_item_p;

	update	cm_conjunto_item
	set	ie_status_item = '5'
	where	nr_seq_conjunto = nr_seq_conj_subst_p
	and	nr_seq_item = nr_seq_item_subst_p;

	if (coalesce(nr_seq_item_cont_p,0) <> 0) then
		begin

		select	nr_seq_conjunto,
			ie_status
		into STRICT	nr_seq_conjunto_cont_w,
			ie_status_w
		from	cm_item_cont
		where	nr_sequencia = nr_seq_item_cont_p;

		select	qt_item
		into STRICT	qt_item_w
		from	cm_conjunto_item
		where	nr_seq_item = nr_seq_item_subst_p
		and	nr_seq_conjunto = nr_seq_conj_subst_p;

		select	nextval('cm_item_cont_seq')
		into STRICT	nr_seq_cont_w
		;

		insert into cm_item_cont(
			nr_sequencia,
			nr_seq_conjunto,
			nr_seq_item,
			dt_atualizacao,
			nm_usuario,
			qt_item,
			ie_status)
		values (nr_seq_cont_w,
			nr_seq_conjunto_cont_w,
			nr_seq_item_subst_p,
			clock_timestamp(),
			nm_usuario_p,
			qt_item_w,
			ie_status_w);

		delete
		from	cm_item_cont
		where	nr_sequencia = nr_seq_item_cont_p;

		end;
	end if;

	end;

elsif (ie_opcao_p = 'R') then
	begin

	if (coalesce(nr_seq_item_cont_p,0) <> 0) then
		begin

		select	nr_seq_conjunto_sub,
			nr_seq_item
		into STRICT	nr_seq_conj_subst_w,
			nr_seq_item_w
		from	cm_conjunto_item_sub
		where	nr_seq_conjunto = nr_seq_conjunto_p
		and	nr_seq_item_sub = nr_seq_item_subst_p
		and	coalesce(dt_final_vigencia::text, '') = '';

		select	nr_seq_conjunto,
			ie_status
		into STRICT	nr_seq_conjunto_cont_w,
			ie_status_w
		from	cm_item_cont
		where	nr_sequencia = nr_seq_item_cont_p;

		select	qt_item
		into STRICT	qt_item_w
		from	cm_conjunto_item
		where	nr_seq_item = nr_seq_item_w
		and	nr_seq_conjunto = nr_seq_conjunto_p;

		select	nextval('cm_item_cont_seq')
		into STRICT	nr_seq_cont_w
		;

		insert into cm_item_cont(
			nr_sequencia,
			nr_seq_conjunto,
			nr_seq_item,
			dt_atualizacao,
			nm_usuario,
			qt_item,
			ie_status)
		values (nr_seq_cont_w,
			nr_seq_conjunto_cont_w,
			nr_seq_item_w,
			clock_timestamp(),
			nm_usuario_p,
			qt_item_w,
			ie_status_w);

		delete
		from	cm_item_cont
		where	nr_sequencia = nr_seq_item_cont_p;

		end;

	elsif (coalesce(nr_seq_item_cont_p,0) = 0) then
		begin

		nr_seq_conj_subst_w	:= nr_seq_conj_subst_p;
		nr_seq_item_w		:= nr_seq_item_p;

		end;
	end if;

	update	cm_conjunto_item_sub
	set	dt_final_vigencia = clock_timestamp()
	where	nr_seq_conjunto = nr_seq_conjunto_p
	and	nr_seq_item = nr_seq_item_w
	and	coalesce(dt_final_vigencia::text, '') = '';

	update	cm_conjunto_item
	set	ie_status_item = '1'
	where	nr_seq_conjunto = nr_seq_conjunto_p
	and	nr_seq_item = nr_seq_item_w;

	update	cm_conjunto_item
	set	ie_status_item = '4'
	where	nr_seq_conjunto = nr_seq_conj_subst_w
	and	nr_seq_item = nr_seq_item_subst_p;

	end;

elsif (ie_opcao_p = 'A') then
	begin

	if (coalesce(nr_seq_item_cont_p,0) <> 0) then
		begin

		select	nr_seq_conjunto_sub,
			nr_seq_item
		into STRICT	nr_seq_conj_subst_w,
			nr_seq_item_w
		from	cm_conjunto_item_sub
		where	nr_seq_conjunto = nr_seq_conjunto_p
		and	nr_seq_item_sub = nr_seq_item_subst_p
		and	coalesce(dt_final_vigencia::text, '') = '';

		end;

	elsif (coalesce(nr_seq_item_cont_p,0) = 0) then
		begin

		nr_seq_conj_subst_w	:= nr_seq_conj_subst_p;
		nr_seq_item_w		:= nr_seq_item_p;

		end;
	end if;

	select	coalesce(obter_valor_param_usuario(406, 61, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p),'1')
	into STRICT	ie_forma_gerar_cod_w
	;

	select	qt_item,
		ie_indispensavel
	into STRICT	qt_item_w,
		ie_indispensavel_w
	from	cm_conjunto_item
	where	nr_seq_conjunto = nr_seq_conj_subst_w
	and	nr_seq_item = nr_seq_item_subst_p;

	select	coalesce(max(nr_seq_interno),0) + 1
	into STRICT	nr_seq_interno_w
	from	cm_conjunto_item
	where	nr_seq_conjunto = nr_seq_conjunto_p;

	select	coalesce(max(ie_status),1)
	into STRICT	ie_status_w
	from	cm_item_cont
	where	nr_sequencia = nr_seq_item_cont_p;

	cd_codigo_item_w := cm_gerar_codigo_item_conj(nr_seq_conjunto_p, cd_estabelecimento_p, nr_seq_interno_w, ie_forma_gerar_cod_w, nm_usuario_p, cd_codigo_item_w);

	insert into cm_conjunto_item(
		nr_seq_conjunto,
		nr_seq_item,
		qt_item,
		dt_atualizacao,
		nm_usuario,
		cd_codigo,
		ie_indispensavel,
		nr_seq_interno,
		ie_status_item)
	values (nr_seq_conjunto_p,
		nr_seq_item_subst_p,
		qt_item_w,
		clock_timestamp(),
		nm_usuario_p,
		cd_codigo_item_w,
		ie_indispensavel_w,
		nr_seq_interno_w,
		ie_status_w);

    update	cm_conjunto_item_sub
	set	dt_final_vigencia = clock_timestamp()
	where	nr_seq_conjunto = nr_seq_conjunto_p
	and	nr_seq_item = nr_seq_item_w
	and	coalesce(dt_final_vigencia::text, '') = '';

	update	cm_conjunto_item
	set	ie_status_item = '3'
	where	nr_seq_conjunto = nr_seq_conjunto_p
	and	nr_seq_item = nr_seq_item_w;

	commit;

	update	cm_item
	set	ie_situacao = 'I'
	where	nr_sequencia = nr_seq_item_w;

	update	cm_conjunto_item
	set	ie_status_item = '5',
		nr_seq_conj_fixo = nr_seq_conjunto_p,
		nr_seq_item_fixo = nr_seq_item_w,
		dt_subst_fixo = clock_timestamp(),
		nm_usuario_fixo = nm_usuario_p
	where	nr_seq_conjunto = nr_seq_conj_subst_w
	and	nr_seq_item = nr_seq_item_subst_p;

	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cm_substituir_item ( nr_seq_item_subst_p bigint, nr_seq_conj_subst_p bigint, nr_seq_conjunto_p bigint, nr_seq_item_p bigint, nr_seq_item_cont_p bigint, ie_opcao_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

