-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_log_impressao_carta ( nr_seq_carta_mae_p bigint, nr_seq_versao_carta_p bigint, nm_usuario_p text, nr_seq_carta_p bigint, NR_SEQ_DESTINATARIO_P bigint default null) AS $body$
DECLARE


nr_seq_carta_impressao_w	carta_impressao.nr_sequencia%type;
ds_destinatarios_carta_w	varchar(4000);


c01 CURSOR FOR
SELECT 	ds_chave,
		ds_valor
from	dest_carta_medica_macro
where 	nr_seq_destinatario = nr_seq_destinatario_p;

c02 CURSOR FOR
SELECT 	c.ds_forma_tratamento || ' ' || a.nm_destinatario || '<br>' ds_destinatarios_carta
FROM destinatario_carta_medica a
LEFT OUTER JOIN pessoa_fisica b ON (a.cd_pessoa_fisica = b.cd_pessoa_fisica)
LEFT OUTER JOIN pf_forma_tratamento c ON (b.nr_seq_forma_trat = c.nr_sequencia)
WHERE a.nr_seq_carta_mae = nr_seq_carta_mae_p;

c03 CURSOR FOR
SELECT 	distinct OBTER_DESC_EXPRESSAO_IDIOMA(892663, '', cd_pais) ds_expressao
from 	TASY_PAIS;
BEGIN

select 	nextval('destinatario_carta_hist_seq')
into STRICT	nr_seq_carta_impressao_w
;

insert into carta_impressao(
		NR_SEQUENCIA,
		NM_USUARIO,
		NR_SEQ_CARTA_MAE,
		NR_VERSAO,
		QT_IMPRESSAO,
		DT_ATUALIZACAO,
		DT_ATUALIZACAO_NREC,
		nr_seq_carta,
		nr_seq_destinatario)
values (	nr_seq_carta_impressao_w,
		nm_usuario_p,
		nr_seq_carta_mae_p,
		nr_seq_versao_carta_p,
		1,
		clock_timestamp(),
		clock_timestamp(),
		nr_seq_carta_p,
		nr_seq_destinatario_p);



commit;

for r_C01_w in C01 loop
	begin
		insert into destinatario_carta_hist(
				NR_SEQUENCIA,
				NR_SEQ_CARTA_IMPRESSAO,
				DT_ATUALIZACAO_NREC,
				NM_USUARIO_NREC,
				DT_ATUALIZACAO,
				NM_USUARIO,
				DS_CHAVE,
				DS_VALOR)
		values ( nextval('destinatario_carta_hist_seq'),
				nr_seq_carta_impressao_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				r_C01_w.ds_chave,
				r_C01_w.ds_valor);
	end;
end loop;

for r_C02_w in C02 loop
	begin
		ds_destinatarios_carta_w := substr(concat(ds_destinatarios_carta_w, r_C02_w.ds_destinatarios_carta), 0, 4000);
	end;
end loop;

for r_C03_w in C03 loop
	begin
		insert into destinatario_carta_hist(
				NR_SEQUENCIA,
				NR_SEQ_CARTA_IMPRESSAO,
				DT_ATUALIZACAO_NREC,
				NM_USUARIO_NREC,
				DT_ATUALIZACAO,
				NM_USUARIO,
				DS_CHAVE,
				DS_VALOR)
		values ( nextval('destinatario_carta_hist_seq'),
				nr_seq_carta_impressao_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				r_C03_w.ds_expressao,
				ds_destinatarios_carta_w);
	end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_log_impressao_carta ( nr_seq_carta_mae_p bigint, nr_seq_versao_carta_p bigint, nm_usuario_p text, nr_seq_carta_p bigint, NR_SEQ_DESTINATARIO_P bigint default null) FROM PUBLIC;

