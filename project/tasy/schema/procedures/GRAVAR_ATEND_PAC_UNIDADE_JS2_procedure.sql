-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_atend_pac_unidade_js2 ( cd_estab_p bigint, cd_convenio_p bigint, cd_categoria_p text, nr_atendimento_p bigint, cd_setor_atendimento_p bigint, nr_seq_classificacao_p bigint, cd_plano_p text, cd_empresa_cat_p bigint, cd_procedencia_p bigint, nr_seq_cobertura_p bigint, nr_seq_tipo_acidente_p bigint, cd_tipo_acomodacao_p bigint, cd_medico_atend_p bigint, nr_seq_queixa_p bigint, ie_clinica_p bigint, ie_tipo_atendimento_p bigint, dt_passagem_p timestamp, cd_medico_p text, ie_bloq_atendimento_p INOUT text, ds_mensagem_p INOUT text, cd_pessoa_fisica_p text, ie_gerar_passagem_p text, nm_usuario_p text) AS $body$
DECLARE


qt_atend_w		bigint;
nr_seq_interno_w	atend_paciente_unidade.nr_seq_interno%type;
ie_tipo_convenio_ant_w	atendimento_paciente.ie_tipo_convenio%type;
nr_seq_queixa_ant_w	atendimento_paciente.nr_seq_queixa%type;
nr_atendimento_w	atendimento_paciente.nr_atendimento%type;
qt_idade_w		smallint;
ds_mensagem_w		varchar(4000) := '';
ie_consiste_regra_conv_w	varchar(1);

BEGIN

select	count(1)
into STRICT	qt_atend_w
from	atend_paciente_unidade
where	nr_atendimento = nr_atendimento_p  LIMIT 1;

if (coalesce(nr_atendimento_p, 0) > 0 and
	ie_gerar_passagem_p = 'S' and
	qt_atend_w = 0) then
	begin

	ie_consiste_regra_conv_w := Obter_Param_Usuario(916, 788, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_consiste_regra_conv_w);

	if (ie_consiste_regra_conv_w in ('P', 'T')) then
		begin
		select	max(b.nr_atendimento)
		into STRICT	nr_atendimento_w
		from	atendimento_paciente b
		where	nr_atendimento < nr_atendimento_p;

		select	max(a.ie_tipo_convenio),
			max(a.nr_seq_queixa)
		into STRICT	ie_tipo_convenio_ant_w,
			nr_seq_queixa_ant_w
		from	atendimento_paciente a
		where	a.nr_atendimento = nr_atendimento_w;

		qt_idade_w	:= substr(obter_idade_pf(cd_pessoa_fisica_p, clock_timestamp(), 'A'), 1, 3);

		SELECT * FROM Obter_Se_Lib_Setor_Conv(
				cd_estab_p, cd_convenio_p, cd_categoria_p, ie_tipo_atendimento_p, cd_setor_atendimento_p, cd_plano_p, nr_seq_classificacao_p, ds_mensagem_w, ie_bloq_atendimento_p, ie_clinica_p, cd_empresa_cat_p, cd_procedencia_p, nr_seq_cobertura_p, nr_seq_tipo_acidente_p, cd_tipo_acomodacao_p, cd_medico_p, qt_idade_w, ie_tipo_convenio_ant_w, nr_seq_queixa_p, nr_seq_queixa_ant_w, clock_timestamp(), cd_pessoa_fisica_p) INTO STRICT ds_mensagem_w, ie_bloq_atendimento_p;

		if (ie_bloq_atendimento_p = 'B') then
			begin
			if (coalesce(ds_mensagem_w::text, '') = '') then
				begin
				CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(150769);
				end;
			else
				CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(186140, 'MENSAGEM='||ds_mensagem_w);
			end if;
			end;
		end if;
		end;
	end if;

	CALL gerar_passagem_setor_atend(nr_atendimento_p, cd_setor_atendimento_p, dt_passagem_p, 'S', nm_usuario_p);

	select 	coalesce(max(nr_seq_interno),0)
	into STRICT	nr_seq_interno_w
	from 	atend_paciente_unidade
	where 	nr_atendimento = nr_atendimento_p;

	if (nr_seq_interno_w > 0) then
		begin
		CALL atend_paciente_unid_afterpost(nr_seq_interno_w, 'I', nm_usuario_p);
		end;
	end if;
	
	end;
end if;
commit;
ds_mensagem_p	:= ds_mensagem_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_atend_pac_unidade_js2 ( cd_estab_p bigint, cd_convenio_p bigint, cd_categoria_p text, nr_atendimento_p bigint, cd_setor_atendimento_p bigint, nr_seq_classificacao_p bigint, cd_plano_p text, cd_empresa_cat_p bigint, cd_procedencia_p bigint, nr_seq_cobertura_p bigint, nr_seq_tipo_acidente_p bigint, cd_tipo_acomodacao_p bigint, cd_medico_atend_p bigint, nr_seq_queixa_p bigint, ie_clinica_p bigint, ie_tipo_atendimento_p bigint, dt_passagem_p timestamp, cd_medico_p text, ie_bloq_atendimento_p INOUT text, ds_mensagem_p INOUT text, cd_pessoa_fisica_p text, ie_gerar_passagem_p text, nm_usuario_p text) FROM PUBLIC;

