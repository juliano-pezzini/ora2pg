-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cp_select_goals_interv_plan (nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE



nr_seq_care_plan_w			care_plan.nr_sequencia%type;
nr_seq_pat_cp_problem_w		patient_cp_problem.nr_sequencia%type;
nr_seq_cp_problem_w			cp_problem.nr_sequencia%type;
nr_seq_pat_care_plan_w		patient_care_plan.nr_sequencia%type;
nr_seq_cp_goal_w			cp_goal.nr_sequencia%type;
nr_seq_cp_interv_plan_w		cp_interv_plan.nr_sequencia%type;

c_f_goals CURSOR FOR
	--First level
	SELECT	pcp.nr_sequencia  nr_seq_pat_care_plan,
		pcpp.nr_sequencia nr_seq_pat_cp_problem,
		substr(obter_desc_expressao(296350)||': '|| cpp.ds_display_name, 0, 255) ds,
		substr(cpp.ds_display_name, 0, 255) ds_problem,
		pcp.nr_seq_care_plan nr_seq_care_plan,
		pcpp.nr_seq_cp_problem
	from  patient_cp_problem pcpp,
		patient_care_plan pcp,
		cp_problem cpp
	where  pcp.nr_seq_prescr = nr_prescricao_p
	and    pcpp.nr_seq_pat_care_plan = pcp.nr_sequencia
	and    cpp.nr_sequencia = pcpp.nr_seq_cp_problem
	and    cpp.ie_situacao = 'A'
	and    pcpp.si_selected = 'Y'
	and    exists (
			  SELECT  1
			  from  cp_problem_goal z,
				  cp_goal_indicator y,
				  cp_indicator x,
				  cp_possible_prob pp
			  where  x.nr_sequencia = y.nr_seq_indicator
			  and    y.nr_seq_goal = z.nr_seq_goal
			  and    z.nr_seq_possible_prob = pp.nr_sequencia
			  and    pp.nr_seq_problem = cpp.nr_sequencia
			  and    pp.nr_seq_care_plan = pcp.nr_seq_care_plan
			)
	order by ds asc;
	
c_s_goals CURSOR FOR
	-- Second level
	SELECT	'section_' || g.nr_sequencia seq_section, /* Necessary to concat, to have different option.code of items */
			g.nr_sequencia nr_seq_cp_goal,
			substr(obter_desc_expressao(947268)||': '|| g.ds_display_name, 0, 255) ds,
			nr_seq_pat_care_plan_w nr_seq_pat_care_plan,
			nr_seq_pat_cp_problem_w nr_seq_pat_cp_problem
	from	cp_goal g,
			cp_problem_goal z,
			cp_goal_indicator y,
			cp_indicator x,
			cp_possible_prob pp
	where	x.nr_sequencia = y.nr_seq_indicator
	and		y.nr_seq_goal = z.nr_seq_goal
	and		z.nr_seq_possible_prob = pp.nr_sequencia
	and		g.nr_sequencia = z.nr_seq_goal
	and		pp.nr_seq_problem = nr_seq_cp_problem_w
	and		pp.nr_seq_care_plan = nr_seq_care_plan_w
	group by	g.nr_sequencia,
				g.ds_display_name
	order by	ds;
	
c_t_goals CURSOR FOR
	-- Third level
	SELECT	a.nr_sequencia							nr_seq_cp_indicator,
			substr(obter_desc_expressao(291850)||': '|| coalesce(a.ds_alternative,a.ds_display_name), 0, 255) || cp_get_days_active(c.dt_start,c.dt_end)	ds,
			a.ie_origin								ie_origin,
			b.nr_seq_goal							nr_seq_cp_goal_indicator,
			nr_seq_pat_care_plan_w					nr_seq_pat_care_plan,
			nr_seq_cp_goal_w						nr_seq_cp_goal,
			nr_seq_pat_cp_problem_w					nr_seq_pat_cp_problem,
			c.dt_start								dt_start,
			coalesce(c.si_selected,'Y')					si_selected,
			(
				SELECT	count(cpig.nr_seq_indicator)
				from	cp_indicator_guid cpig
				where	cpig.NR_SEQ_INDICATOR = a.nr_sequencia
			) qtd_guidance
	FROM cp_goal_indicator b, cp_indicator a
LEFT OUTER JOIN (
				select	x.si_selected,
						x.nr_seq_cp_indicator,
						y.dt_start,
						y.dt_end
				from	patient_cp_goal y,
						patient_cp_indicator x
				where	x.nr_seq_pat_care_plan = nr_seq_pat_care_plan_w
				and		x.nr_seq_pat_cp_goal = y.nr_sequencia
				and		y.nr_seq_cp_goal = nr_seq_cp_goal_w
			) c ON (a.nr_sequencia = c.nr_seq_cp_indicator)
WHERE b.nr_seq_indicator = a.nr_sequencia and b.nr_seq_goal = nr_seq_cp_goal_w  order by ds;

c_f_ed_goals CURSOR FOR	
-- Plano educacional (primeiro nível)	
SELECT	a.nr_sequencia seq,
		obter_desc_expressao(784741) || ': ' || a.ds_display_name ds,
		nr_prescricao_p NR_PRESCRICAO,
		b.nr_sequencia nr_seq_pat_care_plan
from	care_plan a,
		patient_care_plan b
where	a.nr_sequencia = b.nr_seq_care_plan
and		b.nr_seq_prescr = nr_prescricao_p
and		a.ie_situacao = 'A'
and		b.si_selected = 'Y'
order by ds;

c_s_ed_goals CURSOR FOR
-- Plano educacional (segundo nível)
SELECT	cpg.nr_sequencia							cd,
		cpe.nr_sequencia							cd_education,
        coalesce(cpg.ds_alternative,cpg.ds_display_name) || cp_get_days_active(pcpg.dt_start,pcpg.dt_end)	ds,
        nr_seq_pat_care_plan_w						nr_seq_pat_care_plan,
        coalesce(pcpg.si_selected, 'Y')					si_selected,
        pcpg.nr_sequencia							nr_seq_patient_cp_goal,
		pcpg.dt_start								dt_start
FROM cp_education cpe, cp_goal cpg
LEFT OUTER JOIN (
			SELECT	x.nr_sequencia,
					x.si_selected,
					x.nr_seq_cp_goal,
					x.dt_start,
					x.dt_end
			from	patient_cp_goal x
			where	x.nr_seq_pat_care_plan = nr_seq_pat_care_plan_w
and		x.si_selected = 'Y'
			
		) pcpg ON (cpg.NR_SEQUENCIA = pcpg.NR_SEQ_CP_GOAL)
WHERE cpg.NR_SEQUENCIA = cpe.NR_SEQ_GOAL  and cpe.NR_SEQ_CARE_PLAN = nr_seq_care_plan_w and cpe.IE_SITUACAO = 'A' and cpg.IE_TYPE_GOAL = 'E' and cpg.IE_SITUACAO = 'A' order by	ds;

-- Intervention plan first level
c_f_interventions CURSOR FOR
SELECT	cpp.nr_sequencia nr_seq_cp_problem,
		obter_desc_expressao(296350)||': '|| cpp.ds_display_name ds,
		pcp.nr_seq_care_plan nr_seq_care_plan,
		pcpp.nr_seq_pat_care_plan nr_seq_pat_care_plan,
		pcpp.nr_sequencia nr_seq_pat_cp_problem,
		CASE(
                    SELECT  COUNT(*)
                    FROM    CP_INTERV_PLAN_GUID cpipg,
                            cp_interv_plan cpip
                    WHERE   cpipg.NR_SEQ_INTERV_PLAN = cpip.nr_sequencia
                )
        WHEN 0
            THEN 'N'
            ELSE 'Y'
        END SI_GUIDANCE
from	cp_problem cpp,
		patient_cp_problem pcpp,
		patient_care_plan pcp
where	cpp.nr_sequencia = pcpp.nr_seq_cp_problem
and		pcp.nr_sequencia = pcpp.nr_seq_pat_care_plan
and		pcp.nr_seq_prescr = nr_prescricao_p
and		cpp.ie_situacao = 'A'
and   pcpp.si_selected = 'Y'
and		exists (select	1
				from	cp_interv_plan_assoc z,
						cp_interv_plan y,
						cp_intervention x,
						cp_possible_prob pp
				where	y.nr_seq_possible_prob = pp.nr_sequencia
				and		x.nr_sequencia = z.nr_seq_intervention
        and    y.nr_sequencia = z.nr_seq_interv_plan
        and    pp.nr_seq_problem = pcpp.nr_seq_cp_problem
        and    pp.nr_seq_care_plan = pcp.nr_seq_care_plan
        and    y.ie_situacao = 'A'
        and    x.ie_situacao = 'A')
order by ds;

-- Intervention plan second level
c_s_interventions CURSOR FOR
SELECT 'section_' || cpip.nr_sequencia seq, /* Necessary to concat, to have different option.code of items */
        cpip.nr_sequencia nr_seq_cp_interv_plan,
        cpip.ds_display_name ds,
        nr_seq_cp_problem_w nr_seq_cp_problem,
        nr_seq_care_plan_w nr_seq_care_plan,
		nr_seq_pat_care_plan_w nr_seq_pat_care_plan,
		nr_seq_pat_cp_problem_w nr_seq_pat_cp_problem,
		(
			SELECT	count(cpipg.nr_seq_interv_plan)
			FROM	CP_INTERV_PLAN_GUID cpipg
			WHERE	cpipg.NR_SEQ_INTERV_PLAN = cpip.NR_SEQUENCIA
		) qtd_guidance		
from    cp_interv_plan cpip,
        cp_possible_prob cppp
where   cppp.nr_sequencia = cpip.nr_seq_possible_prob
and     cppp.nr_seq_problem = nr_seq_cp_problem_w
and     cppp.nr_seq_care_plan = nr_seq_care_plan_w
order by ds;

-- Intervention plan third level
c_t_interventions CURSOR FOR
SELECT	                cpi.nr_sequencia nr_seq_cp_intervention,
		coalesce(cpi.ds_alternative,cpi.ds_display_name) ds,
		nr_seq_cp_problem_w nr_seq_cp_problem,
		nr_seq_care_plan_w nr_seq_care_plan,
		nr_seq_cp_interv_plan_w nr_seq_cp_interv_plan,
		nr_seq_pat_care_plan_w nr_seq_pat_care_plan,
		nr_seq_pat_cp_problem_w nr_seq_pat_cp_problem,
		pcpi.nr_sequencia nr_seq_pat_cp_intervention,
		coalesce(pcpi.si_selected, 'Y') si_selected
FROM cp_interv_plan_assoc cpipa, cp_intervention cpi
LEFT OUTER JOIN (SELECT	x.nr_sequencia,
				x.si_selected,
				x.nr_seq_cp_intervention
		from	patient_cp_intervention x,
				patient_cp_interv_plan y
		where	x.nr_seq_pat_cp_interv_plan = y.nr_sequencia
		and		y.nr_seq_interv_plan = nr_seq_cp_interv_plan_w
		and		y.nr_seq_pat_cp_problem = nr_seq_pat_cp_problem_w
		) pcpi ON (cpi.nr_sequencia = pcpi.NR_SEQ_CP_INTERVENTION)
WHERE cpipa.nr_seq_intervention = cpi.nr_sequencia  and cpipa.nr_seq_interv_plan = nr_seq_cp_interv_plan_w order by ds;


BEGIN

	-- Metas clínicas
	for r_c_f_goals in c_f_goals loop
		nr_seq_pat_care_plan_w 	:= 	r_c_f_goals.nr_seq_pat_care_plan;
		nr_seq_pat_cp_problem_w :=	r_c_f_goals.nr_seq_pat_cp_problem;
		nr_seq_care_plan_w		:=	r_c_f_goals.nr_seq_care_plan;
		nr_seq_cp_problem_w		:= 	r_c_f_goals.nr_seq_cp_problem;
		
		for r_c_s_goals in c_s_goals loop
			nr_seq_cp_goal_w 		:=	r_c_s_goals.nr_seq_cp_goal;
			nr_seq_pat_care_plan_w	:=	r_c_s_goals.nr_seq_pat_care_plan;
			nr_seq_pat_cp_problem_w	:=	r_c_s_goals.nr_seq_pat_cp_problem;
			
			for r_c_s_goals in c_t_goals loop
				
				CALL cp_select_indicator(
					r_c_s_goals.nr_seq_pat_care_plan,
					r_c_s_goals.nr_seq_cp_indicator,
					r_c_s_goals.nr_seq_cp_goal,
					r_c_s_goals.nr_seq_pat_cp_problem,
					nm_usuario_p,
					r_c_s_goals.si_selected
				);
			end loop;
		end loop;
	end loop;
	
	-- Education plan
	
	for r_c_f_ed_goals in c_f_ed_goals loop
		nr_seq_care_plan_w 		:= r_c_f_ed_goals.seq;
		nr_seq_pat_care_plan_w 	:= r_c_f_ed_goals.nr_seq_pat_care_plan;
		
		for r_c_s_ed_goals in c_s_ed_goals loop
			CALL cp_select_education(
				r_c_s_ed_goals.nr_seq_pat_care_plan,
				r_c_s_ed_goals.cd,
				r_c_s_ed_goals.nr_seq_patient_cp_goal,
				nm_usuario_p,
				r_c_s_ed_goals.si_selected				
			);
		end loop;
	end loop;
	
	-- Intervention plan
	
	for r_c_f_interventions in c_f_interventions loop
		nr_seq_care_plan_w 			:= r_c_f_interventions.nr_seq_care_plan;
		nr_seq_pat_cp_problem_w		:= r_c_f_interventions.nr_seq_pat_cp_problem;
		nr_seq_cp_problem_w			:= r_c_f_interventions.nr_seq_cp_problem;
		nr_seq_pat_care_plan_w		:= r_c_f_interventions.nr_seq_pat_care_plan;
		
		for r_c_s_interventions in c_s_interventions loop
			nr_seq_care_plan_w			:= r_c_s_interventions.nr_seq_care_plan;
			nr_seq_pat_cp_problem_w		:= r_c_s_interventions.nr_seq_pat_cp_problem;
			nr_seq_cp_problem_w			:= r_c_s_interventions.nr_seq_cp_problem;
			nr_seq_cp_interv_plan_w		:= r_c_s_interventions.nr_seq_cp_interv_plan;
			nr_seq_pat_care_plan_w		:= r_c_s_interventions.nr_seq_pat_care_plan;
			
				for r_c_t_interventions in c_t_interventions loop
					CALL cp_select_intervention(
						r_c_t_interventions.nr_seq_cp_intervention,
						r_c_t_interventions.nr_seq_pat_care_plan,
						r_c_t_interventions.nr_seq_cp_interv_plan,
						r_c_t_interventions.nr_seq_pat_cp_problem,
						nm_usuario_p,
						r_c_t_interventions.si_selected
					);
				end loop;
			
		end loop;
	end loop;

	commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cp_select_goals_interv_plan (nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

