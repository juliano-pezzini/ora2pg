-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consistir_seg_intercambio ( cd_pessoa_fisica_p text, nr_seq_segurado_p bigint, nr_seq_pagador_p bigint, nr_seq_plano_p bigint, cd_matricula_familia_p bigint, nr_seq_intercambio_p bigint, nr_seq_titular_p bigint, cd_cartao_intercambio_p text, ie_bonific_cooperado_p text, dt_contratacao_p timestamp, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE


qt_registro_w			bigint;
qt_segurado_familia_w		bigint;
qt_segurado_cartao_w		bigint;
qt_dependente_w			bigint;
nr_seq_dependente_w		bigint;
nm_pessoa_dependente_w		varchar(255);
nr_seq_grupo_intercambio_w		bigint;
ie_grupo_pagador_w		varchar(10);
ie_pagador_grupo_w		varchar(10);
dt_nascimento_w			timestamp;
ds_erro_w			varchar(2000);
nr_seq_congenere_w		bigint;
dt_rescisao_w			timestamp;


BEGIN

ie_pagador_grupo_w	:= 'N';


if (coalesce(nr_seq_intercambio_p,0) <> 0) then

	select	dt_nascimento
	into STRICT	dt_nascimento_w
	from	pessoa_fisica
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p;

	select	max(dt_exclusao)
	into STRICT	dt_rescisao_w
	from	pls_intercambio
	where	nr_sequencia	= nr_seq_intercambio_p;
	if (dt_rescisao_w IS NOT NULL AND dt_rescisao_w::text <> '') then
		ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(279734);
	end if;

	if (coalesce(nr_seq_pagador_p,0) = 0) then
		ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(279735);
	else

		select	max(NR_SEQ_GRUPO_INTERCAMBIO)
		into STRICT	nr_seq_grupo_intercambio_w
		from	pls_intercambio
		where	nr_sequencia	= nr_seq_intercambio_p;

		if (nr_seq_grupo_intercambio_w IS NOT NULL AND nr_seq_grupo_intercambio_w::text <> '') then
			select	coalesce(ie_grupo_pagador,'N')
			into STRICT	ie_grupo_pagador_w
			from	pls_regra_grupo_inter
			where	nr_sequencia	= nr_seq_grupo_intercambio_w;

			select	count(1)
			into STRICT	qt_registro_w
			from	pls_intercambio		b,
				pls_contrato_pagador	a
			where	a.nr_seq_pagador_intercambio	= b.nr_sequencia
			and	b.NR_SEQ_GRUPO_INTERCAMBIO	= nr_seq_grupo_intercambio_w
			and	a.nr_sequencia			= nr_seq_pagador_p
			and	a.IE_PAG_REF_GRUPO_INTERCAMBIO	= 'S';

			if (qt_registro_w > 0) then
				ie_pagador_grupo_w	:= 'S';
			end if;
		end if;

		if (ie_pagador_grupo_w = 'N') then
			select	count(1)
			into STRICT	qt_registro_w
			from	pls_contrato_pagador
			where	nr_sequencia	= nr_seq_pagador_p
			and	nr_seq_pagador_intercambio	= nr_seq_intercambio_p;

			if (qt_registro_w = 0) then
				select	max(nr_seq_congenere)
				into STRICT	nr_seq_congenere_w
				from	pls_intercambio
				where	nr_sequencia	= nr_seq_intercambio_p;

				select	count(1)
				into STRICT	qt_registro_w
				from	pls_contrato_pagador
				where	nr_seq_congenere	= nr_seq_congenere_w;

				if (qt_registro_w = 0) then
					ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(279736);
				end if;
			end if;
		end if;
	end if;

	if (coalesce(nr_seq_plano_p,0) <> 0) then
		select	count(*)
		into STRICT	qt_registro_w
		from	pls_intercambio_plano
		where	nr_seq_intercambio	= nr_seq_intercambio_p
		and	nr_seq_plano		= nr_seq_plano_p;

		if (qt_registro_w = 0) then
			ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(279738);
		end if;
	end if;

	select	count(*)
	into STRICT	qt_segurado_familia_w
	from	pls_segurado
	where	nr_sequencia		<> nr_seq_segurado_p
	and	nr_seq_intercambio	= nr_seq_intercambio_p
	and	cd_matricula_familia	= cd_matricula_familia_p
	and	coalesce(nr_seq_titular::text, '') = '';

	if	((qt_segurado_familia_w > 0) and (coalesce(nr_seq_titular_p,0) = 0)) then
		ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(279741);
	end if;

	/* Beneficiário já cadastrado no contrato de intercâmbio. Verifique! */

	select	count(*)
	into STRICT	qt_registro_w
	from	pls_segurado
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p
	and	nr_seq_intercambio	= nr_seq_intercambio_p
	and	nr_sequencia		<> nr_seq_segurado_p
	and	coalesce(dt_rescisao::text, '') = '';
	if (qt_registro_w	> 0) then
		ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(279744);
	end if;

	select	count(*)
	into STRICT	qt_segurado_cartao_w
	from	pls_segurado
	where	nr_sequencia		<> nr_seq_segurado_p
	and	cd_cartao_intercambio	= cd_cartao_intercambio_p;

	if (qt_segurado_cartao_w > 0) then
		ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(279747);
	end if;

	if (ie_bonific_cooperado_p = 'S') then
		if (coalesce(nr_seq_titular_p,0) = 0) then
			ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(279750);
		end if;

		select	count(*)
		into STRICT	qt_dependente_w
		from	pls_segurado
		where	nr_seq_titular	= nr_seq_titular_p
		and	nr_sequencia	<> nr_seq_segurado_p
		and	ie_bonific_cooperado	= 'S';

		if (qt_dependente_w <> 0) then
			select	max(a.nr_sequencia),
				max(b.nm_pessoa_fisica)
			into STRICT	nr_seq_dependente_w,
				nm_pessoa_dependente_w
			from	pls_segurado	a,
				pessoa_fisica	b
			where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
			and	a.nr_seq_titular	= nr_seq_titular_p
			and	a.nr_sequencia		<> nr_seq_segurado_p
			and	ie_bonific_cooperado	= 'S';

			ds_erro_w := ds_erro_w || wheb_mensagem_pck.get_texto(279756, 'NR_SEQ_DEPENDENTE_P=' || nr_seq_dependente_w ||
											';NM_PESSOA_DEPENDENTE_P=' || nm_pessoa_dependente_w);
		end if;
	end if;

	/*aaschlote OS 472407 31/07/2011*/

	if (dt_nascimento_w IS NOT NULL AND dt_nascimento_w::text <> '') and (trunc(dt_nascimento_w,'dd') > trunc(dt_contratacao_p,'dd')) then
		ds_erro_w	:= ds_erro_w || wheb_mensagem_pck.get_texto(279764);
	end if;
end if;

ds_erro_p := ds_erro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consistir_seg_intercambio ( cd_pessoa_fisica_p text, nr_seq_segurado_p bigint, nr_seq_pagador_p bigint, nr_seq_plano_p bigint, cd_matricula_familia_p bigint, nr_seq_intercambio_p bigint, nr_seq_titular_p bigint, cd_cartao_intercambio_p text, ie_bonific_cooperado_p text, dt_contratacao_p timestamp, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

