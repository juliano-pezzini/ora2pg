-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE intpd_ret_mov_estoque_muguerza ( nr_sequencia_p bigint, ds_xml_p text) AS $body$
DECLARE

ie_status_w			varchar(3);
ie_status_atual_w	varchar(3);
ds_err_msg_w		varchar(100);

c01 CURSOR FOR
	SELECT *
	from   xmltable(
		xmlnamespaces('http://www.w3.org/2003/05/soap-envelope' AS "soap",
			'http://www.christusmuguerza.com.mx/EnterpriseObjects/GCM/Common' AS "com",
			'http://www.christusmuguerza.com.mx/EnterpriseObjects/InventoryTransaction' AS "ns0"
			),
		'/soap:Envelope/soap:Body/ns0:CreateInventoryTransactionResponseAcknowledgeEBM/ns0:Acknowledge'
		passing xml.Createxml(ds_xml_p) COLUMNS	code varchar(10) path 'com:Code',
			message varchar(1000) path 'com:Message',
			detail varchar(4000) path 'com:Detail',
			instanceId varchar(100) path 'com:InstanceId');
c01_w c01%ROWTYPE;


BEGIN

open c01;
fetch c01 into c01_w;
close c01;

update	intpd_fila_transmissao
set		ds_xml_retorno = ds_xml_p,
		ds_log = coalesce(c01_w.detail, ds_log),
		ie_response_procedure = 'S'
where	nr_sequencia = nr_sequencia_p;

begin

select	case
		when ies.ie_tipo_utilizacao = 'S' and (c01_w.code)::numeric  = 0 then 'S'
		when ies.ie_tipo_utilizacao = 'S' and (c01_w.code)::numeric  <> 0 then 'E'
		when ies.ie_tipo_utilizacao = 'A' and (c01_w.code)::numeric  = 0 then 'AEX'
		when ies.ie_tipo_utilizacao = 'A' and (c01_w.code)::numeric  <> 0 then 'E'
	else 'E'
	end
into STRICT	ie_status_w
from	intpd_eventos_sistema ies,
		intpd_fila_transmissao ift
where	ift.nr_sequencia = nr_sequencia_p
and		ies.nr_sequencia = ift.nr_seq_evento_sistema;
exception
	when others then
		ie_status_w := 'E';
end;

select 	ie_status
into STRICT	ie_status_atual_w
from	intpd_fila_transmissao
where	nr_sequencia = nr_sequencia_p;

if (ie_status_w <> 'AEX') or (ie_status_atual_w <> 'E' and (ie_status_atual_w <> 'P')) then
	begin
	update	intpd_fila_transmissao
	set		ie_status = ie_status_w,
			dt_status = clock_timestamp()
	where  	nr_sequencia = nr_sequencia_p;
	end;
end if;

exception
when others then
	rollback;
	begin
	ds_err_msg_w := sqlerrm;

	update	intpd_fila_transmissao
	set	ie_status = 'E',
		ds_log = ds_err_msg_w,
		dt_status = clock_timestamp()
	where  nr_sequencia = nr_sequencia_p;
end;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE intpd_ret_mov_estoque_muguerza ( nr_sequencia_p bigint, ds_xml_p text) FROM PUBLIC;

