-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insere_equip_agenda_cirurgica ( nr_seq_agenda_p bigint, cd_equipamento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
cd_setor_exclusivo_w  integer;	
cd_setor_atendimento_w  integer;					
 

BEGIN 
 
select 		coalesce(MAX(a.cd_setor_exclusivo),0) 
into STRICT		cd_setor_exclusivo_w 
from		agenda a, 
		agenda_paciente b 
where		a.cd_agenda 	= 	b.cd_agenda 
and		b.nr_sequencia	= 	nr_seq_agenda_p;
 
select 		coalesce(MAX(cd_setor_atendimento),0) 
into STRICT		cd_setor_atendimento_w 
from		equipamento 
where		cd_equipamento = cd_equipamento_p;
 
 
if (coalesce(nr_seq_agenda_p,0) > 0) and (coalesce(cd_equipamento_p,0) > 0) and (coalesce(cd_setor_atendimento_w,cd_setor_exclusivo_w) = cd_setor_exclusivo_w)	then 
	insert	into agenda_pac_equip(nr_sequencia, 
					nr_seq_agenda, 
					dt_atualizacao, 
					nm_usuario, 
					cd_equipamento, 
					dt_confirmacao, 
					ie_obrigatorio, 
					ie_origem_inf, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec) 
					(SELECT	nextval('agenda_pac_equip_seq'), 
						nr_seq_agenda_p, 
						clock_timestamp(), 
						nm_usuario_p, 
						cd_equipamento_p, 
						clock_timestamp(), 
						'S', 
						'I', 
						clock_timestamp(), 
						nm_usuario_p 
					);
	commit;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insere_equip_agenda_cirurgica ( nr_seq_agenda_p bigint, cd_equipamento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

