-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_rescisao_programada ( nr_seq_intercambio_p bigint, nr_seq_contrato_p bigint, nr_seq_segurado_p bigint, nr_seq_motivo_rescisao_p bigint, qt_anos_p bigint, dt_inicial_rescisao_p timestamp, ie_rescisao_tipo_p text, ie_devolucao_carteira_p text, ds_observacao_p text, nm_usuario_p text, dt_obito_p timestamp, nr_certidao_obito_p text, qt_meses_contribuicao_p bigint, dt_concessao_p timestamp, ie_liberacao_rescisao_p text, nr_seq_resc_prog_gerada_p INOUT bigint, nr_seq_causa_rescisao_p bigint default null) AS $body$
DECLARE


/* 
ie_rescisao_tipo_p
PF - Pessoa Fisica
PJ - Pessoa Juridica
W - Rescisao gerada pelo portal
*/


/*  Procedure utilizada no portal do plano de saude */

qt_rescisao_programada_w	bigint;
qt_meses_rescisao_w		bigint;
dt_rescisao_w			timestamp;
nr_seq_resc_prog_gerada_w	bigint;
dt_liberacao_w			timestamp := null;
ie_exige_lib_web_w		varchar(1);
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
ie_data_alterada_regra_w	pls_rescisao_contrato.ie_data_alterada_regra%type := 'N';
dt_rescisao_alt_w		timestamp;
nr_seq_contrato_w		pls_contrato.nr_sequencia%type;


BEGIN

if (coalesce(nr_seq_motivo_rescisao_p::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1183216);
end if;

qt_meses_rescisao_w	:= qt_anos_p * 12;
dt_rescisao_w		:= add_months(dt_inicial_rescisao_p,qt_meses_rescisao_w);

if (ie_rescisao_tipo_p	= 'PF') then
	if (nr_seq_intercambio_p IS NOT NULL AND nr_seq_intercambio_p::text <> '') then
		select	count(*)
		into STRICT	qt_rescisao_programada_w
		from	pls_rescisao_contrato
		where	nr_seq_intercambio	= nr_seq_intercambio_p;
		
		if (qt_rescisao_programada_w = 0) then
			select  nextval('pls_rescisao_contrato_seq')
			into STRICT	nr_seq_resc_prog_gerada_w
			;
		
			insert into pls_rescisao_contrato(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
					nr_seq_intercambio,ie_situacao,dt_solicitacao,dt_rescisao,nr_seq_motivo_rescisao,nm_usuario_solicitacao,
					ds_observacao, ie_processo, ie_tipo_solicitante, dt_rescisao_orig)
			values (	nr_seq_resc_prog_gerada_w,clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
					nr_seq_intercambio_p,'A',clock_timestamp(),dt_rescisao_w,nr_seq_motivo_rescisao_p,nm_usuario_p,
					ds_observacao_p, 'W', 'T', dt_inicial_rescisao_p);
		end if;
	elsif (nr_seq_contrato_p IS NOT NULL AND nr_seq_contrato_p::text <> '') then
		select	count(*)
		into STRICT	qt_rescisao_programada_w
		from	pls_rescisao_contrato
		where	nr_seq_contrato	= nr_seq_contrato_p;
		
		if (qt_rescisao_programada_w = 0) then
			select  nextval('pls_rescisao_contrato_seq')
			into STRICT	nr_seq_resc_prog_gerada_w
			;
			
			insert into pls_rescisao_contrato(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
					nr_seq_contrato,ie_situacao,dt_solicitacao,dt_rescisao,nr_seq_motivo_rescisao,nm_usuario_solicitacao,
					ds_observacao, ie_processo, ie_tipo_solicitante, dt_rescisao_orig)
			values (	nr_seq_resc_prog_gerada_w,clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
					nr_seq_contrato_p,'A',clock_timestamp(),dt_rescisao_w,nr_seq_motivo_rescisao_p,nm_usuario_p,
					ds_observacao_p, 'W', 'T', dt_inicial_rescisao_p);
		end if;
	end if;	
elsif (ie_rescisao_tipo_p	= 'PJ') and (nr_seq_segurado_p IS NOT NULL AND nr_seq_segurado_p::text <> '') then
	select	count(*)
	into STRICT	qt_rescisao_programada_w
	from	pls_rescisao_contrato
	where	nr_seq_segurado	= nr_seq_segurado_p;
	
	if (qt_rescisao_programada_w = 0) then
		select  nextval('pls_rescisao_contrato_seq')
		into STRICT	nr_seq_resc_prog_gerada_w
		;

		insert into pls_rescisao_contrato(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
				nr_seq_segurado,ie_situacao,dt_solicitacao,dt_rescisao,nr_seq_motivo_rescisao,nm_usuario_solicitacao,
				ds_observacao, ie_processo, ie_tipo_solicitante, dt_rescisao_orig)
		values (	nr_seq_resc_prog_gerada_w,clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
				nr_seq_segurado_p,'A',clock_timestamp(),dt_rescisao_w,nr_seq_motivo_rescisao_p,nm_usuario_p,
				ds_observacao_p, 'W', 'T',dt_inicial_rescisao_p);
	end if;
/* Tratamento realizado quando a rescisao e feita pelo portal do Plano de Saude*/

elsif (ie_rescisao_tipo_p	= 'W') then
	select  nextval('pls_rescisao_contrato_seq')
	into STRICT	nr_seq_resc_prog_gerada_w
	;
	
	select 	cd_estabelecimento,
		nr_seq_contrato
	into STRICT	cd_estabelecimento_w,
		nr_seq_contrato_w
	from	pls_segurado
	where	nr_sequencia 	= nr_seq_segurado_p;
	
	select	coalesce(max(ie_exige_liberacao_resc),'N')  ie_exige_liberacao_resc
	into STRICT	ie_exige_lib_web_w
	from	pls_web_param_geral
	where	cd_estabelecimento	= cd_estabelecimento_w;
	
	if (ie_liberacao_rescisao_p = 'S') then
		dt_liberacao_w := clock_timestamp();
	end if;

	if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then
		dt_rescisao_alt_w := pls_obter_dias_res_regra_contr(nr_seq_segurado_p, nr_seq_motivo_rescisao_p, dt_inicial_rescisao_p, cd_estabelecimento_w, nm_usuario_p, dt_rescisao_alt_w);
		
		if (dt_inicial_rescisao_p <> dt_rescisao_alt_w) then
			ie_data_alterada_regra_w := 'S';
		end if;
	end if;
	
	insert into pls_rescisao_contrato(	nr_sequencia,dt_atualizacao,nm_usuario,
			dt_atualizacao_nrec,nm_usuario_nrec,nr_seq_segurado,
			ie_situacao,dt_solicitacao,dt_rescisao,
			nr_seq_motivo_rescisao,nr_seq_causa_rescisao,nm_usuario_solicitacao,ds_observacao,
			ie_processo, ie_tipo_solicitante, ie_devolucao_carteira,
			dt_obito, nr_certidao_obito, qt_meses_contribuicao,
			dt_concessao,dt_liberacao,ie_exige_liberacao_web,
			ie_data_alterada_regra,dt_rescisao_orig)
	values (	nr_seq_resc_prog_gerada_w,clock_timestamp(),nm_usuario_p,
			clock_timestamp(),nm_usuario_p,nr_seq_segurado_p,
			'A',clock_timestamp(),coalesce(dt_rescisao_alt_w, dt_inicial_rescisao_p),
			nr_seq_motivo_rescisao_p,nr_seq_causa_rescisao_p,nm_usuario_p,ds_observacao_p,
			'W', 'W', ie_devolucao_carteira_p,
			dt_obito_p, nr_certidao_obito_p, qt_meses_contribuicao_p,
			dt_concessao_p,dt_liberacao_w,ie_exige_lib_web_w,
			ie_data_alterada_regra_w, dt_inicial_rescisao_p);
			
	CALL pls_gerar_ci_solic_portal_web(	3, null, null,
					nr_seq_segurado_p, null, null,
					nm_usuario_p);
end if;

nr_seq_resc_prog_gerada_p := nr_seq_resc_prog_gerada_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_rescisao_programada ( nr_seq_intercambio_p bigint, nr_seq_contrato_p bigint, nr_seq_segurado_p bigint, nr_seq_motivo_rescisao_p bigint, qt_anos_p bigint, dt_inicial_rescisao_p timestamp, ie_rescisao_tipo_p text, ie_devolucao_carteira_p text, ds_observacao_p text, nm_usuario_p text, dt_obito_p timestamp, nr_certidao_obito_p text, qt_meses_contribuicao_p bigint, dt_concessao_p timestamp, ie_liberacao_rescisao_p text, nr_seq_resc_prog_gerada_p INOUT bigint, nr_seq_causa_rescisao_p bigint default null) FROM PUBLIC;

